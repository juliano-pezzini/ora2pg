-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_lote_encontro_contas ( nr_seq_lote_p bigint, ie_gera_titulos_p text, nm_usuario_p text, ie_acao_p text) AS $body$
DECLARE


nr_seq_pessoa_w		bigint;
dt_inicial_cr_w		timestamp;
dt_final_cr_w		timestamp;
dt_inicial_cp_w		timestamp;
dt_final_cp_w		timestamp;
ie_tipo_data_cr_w		varchar(3);
ie_tipo_data_cp_w		varchar(3);
cd_pessoa_fisica_lote_w	varchar(10);
cd_cgc_lote_w		varchar(14);
nr_titulo_receber_w		bigint;
nr_titulo_pagar_w		bigint;
cd_pessoa_fisica_w	varchar(10);
cd_cgc_w		varchar(14);
nr_seq_pessoa_ant_w	bigint	:= null;
qt_tit_rec_w		bigint;
qt_tit_pagar_w		bigint;
ie_ordem_w		smallint;
vl_saldo_receber_w		double precision	:= 0;
vl_saldo_pagar_w		double precision	:= 0;
vl_saldo_titulo_w		double precision;
vl_saldo_credor_w		double precision	:= 0;
vl_saldo_devedor_w	double precision	:= 0;
vl_saldo_calc_w		double precision	:= 0;
vl_saldo_lote_w		double precision;
ie_cooperativas_w		varchar(3);
ie_cooperado_w		varchar(3);
ie_tipo_pessoa_w		varchar(1);
qt_titulos_w		integer;
nr_seq_resp_pgto_w	bigint	:= null;
cd_estabelecimento_w	smallint;
ie_juros_w		varchar(1);
ie_multa_w		varchar(1);
vl_saldo_juros_w		double precision 	:= 0;
vl_saldo_multa_w		double precision 	:= 0;
qt_regra_w		bigint;
ie_tipo_pessoa_regra_w	varchar(2);
ie_despesa_desconto_w	varchar(1);
vl_desconto_w		double precision	:= 0;
vl_despesa_w		double precision	:= 0;
vl_saldo_juros_pag_w	double precision 	:= 0;
vl_saldo_multa_pag_w	double precision 	:= 0;
vl_desconto_pag_w	double precision	:= 0;
vl_despesa_pag_w		double precision	:= 0;
ie_titulo_escritural_w	varchar(1);
ie_titulo_bordero_w		varchar(1);
nr_tipo_titulo_cr_w		lote_encontro_contas.nr_tipo_titulo_cr%type;
nr_tipo_titulo_cp_w		lote_encontro_contas.nr_tipo_titulo_cp%type;
ie_possui_tit_aberto_w		varchar(1) := 'N';

c01 CURSOR FOR
	SELECT	1 ie_ordem,
		a.nr_titulo nr_titulo_receber,
		null nr_titulo_pagar,
		a.cd_pessoa_fisica cd_pessoa_fisica,
		a.cd_cgc cd_cgc,
		a.vl_saldo_titulo,
		(obter_juros_multa_titulo(a.nr_titulo, clock_timestamp(),'R','J'))::numeric  vl_saldo_juros,
		(obter_juros_multa_titulo(a.nr_titulo, clock_timestamp(),'R','M'))::numeric  vl_saldo_multa,
		coalesce(obter_valores_tit_rec(a.nr_titulo,'D'),0) vl_desconto,
		0 vl_despesa
	from	titulo_receber a
	where (coalesce(ie_titulo_bordero_w,'S') = 'S' or
		not exists (SELECT	1
		from	bordero_tit_rec x
		where	x.nr_titulo	= a.nr_titulo))
	and (coalesce(ie_titulo_escritural_w,'S') = 'S' or
		not exists (select	1
		from	titulo_receber_cobr x
		where	x.nr_titulo	= a.nr_titulo))
	and	coalesce(a.dt_liquidacao::text, '') = ''
	and	a.vl_saldo_titulo > 0
	and	a.ie_situacao = '1'
	and (a.cd_estabelecimento	= cd_estabelecimento_w
	or	coalesce(cd_estabelecimento_w::text, '') = '')
	and	a.dt_emissao between coalesce(dt_inicial_cr_w,a.dt_emissao) and fim_dia(coalesce(dt_final_cr_w,a.dt_emissao))
	and (a.ie_tipo_titulo 	= nr_tipo_titulo_cr_w
	or	coalesce(nr_tipo_titulo_cr_w::text, '') = '')
	and	((a.cd_pessoa_fisica = cd_pessoa_fisica_lote_w) or (a.cd_cgc = cd_cgc_lote_w) or (exists (select 1
			from	pls_congenere x
			where	a.cd_cgc = x.cd_cgc
			and	pls_obter_coop_pag_resp_fin(x.nr_sequencia,clock_timestamp()) = cd_cgc_lote_w)) or (coalesce(cd_pessoa_fisica_lote_w::text, '') = '' and coalesce(cd_cgc_lote_w::text, '') = ''))
	and	(ie_cooperado_w = 'N' or	(exists	(select	1
							from	pls_cooperado x
							where	((x.cd_cgc = a.cd_cgc) or (x.cd_pessoa_fisica = a.cd_pessoa_fisica))
							and	coalesce(x.dt_exclusao::text, '') = ''
							)
						)
		)
	and	((ie_cooperativas_w = 'N') or (ie_cooperativas_w = 'SC' and (not exists (select	1
								from	pls_congenere_camara z,
									pls_congenere w
								where	z.nr_seq_congenere	= w.nr_sequencia
								and	w.cd_cgc		= a.cd_cgc
								and	coalesce(dt_final_cr_w,a.dt_emissao) between z.dt_inicio_vigencia_ref and z.dt_fim_vigencia_ref
								))
						and (exists (select	1
								from	pls_congenere x
								where	x.cd_cgc	= a.cd_cgc
								and	coalesce(x.dt_exclusao::text, '') = '')
								)) or (ie_cooperativas_w = 'S' and exists (select	1
								from	pls_congenere x
								where	x.cd_cgc	= a.cd_cgc
								and	coalesce(x.dt_exclusao::text, '') = '')
								)

		)
	and	((ie_tipo_pessoa_w = 'A') or (ie_tipo_pessoa_w = 'F' and (a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '')) or (ie_tipo_pessoa_w = 'J' and (a.cd_cgc IS NOT NULL AND a.cd_cgc::text <> '')))
	and	ie_tipo_data_cr_w = 'E'
	and	not exists (	select	1
				from	titulo_receber_resp_pgto r
				where	r.nr_titulo	= a.nr_titulo
				and	a.dt_emissao between r.dt_inicio_vigencia and coalesce(r.dt_fim_vigencia,a.dt_emissao))
	
union all

	select	2 ie_ordem,
		a.nr_titulo nr_titulo_receber,
		null nr_titulo_pagar,
		a.cd_pessoa_fisica cd_pessoa_fisica,
		a.cd_cgc cd_cgc,
		a.vl_saldo_titulo,
		(obter_juros_multa_titulo(a.nr_titulo, clock_timestamp(),'R','J'))::numeric  vl_saldo_juros,
		(obter_juros_multa_titulo(a.nr_titulo, clock_timestamp(),'R','M'))::numeric  vl_saldo_multa,
		coalesce(obter_valores_tit_rec(a.nr_titulo,'D'),0) vl_desconto,
		0 vl_despesa
	from	titulo_receber a
	where (coalesce(ie_titulo_bordero_w,'S') = 'S' or
		not exists (select	1
		from	bordero_tit_rec x
		where	x.nr_titulo	= a.nr_titulo))
	and (coalesce(ie_titulo_escritural_w,'S') = 'S' or
		not exists (select	1
		from	titulo_receber_cobr x
		where	x.nr_titulo	= a.nr_titulo))
	and	coalesce(a.dt_liquidacao::text, '') = ''
	and	a.vl_saldo_titulo > 0
	and	a.ie_situacao = '1'
	and (a.cd_estabelecimento	= cd_estabelecimento_w
	or	coalesce(cd_estabelecimento_w::text, '') = '')
	and	a.dt_pagamento_previsto between coalesce(dt_inicial_cr_w,a.dt_pagamento_previsto) and fim_dia(coalesce(dt_final_cr_w,a.dt_pagamento_previsto))
	and (a.ie_tipo_titulo 	= nr_tipo_titulo_cr_w
	or	coalesce(nr_tipo_titulo_cr_w::text, '') = '')
	and	((a.cd_pessoa_fisica = cd_pessoa_fisica_lote_w) or (a.cd_cgc = cd_cgc_lote_w) or (exists (select 1
			from	pls_congenere x
			where	a.cd_cgc = x.cd_cgc
			and	pls_obter_coop_pag_resp_fin(x.nr_sequencia,clock_timestamp()) = cd_cgc_lote_w)) or (coalesce(cd_pessoa_fisica_lote_w::text, '') = '' and coalesce(cd_cgc_lote_w::text, '') = ''))
	and	(ie_cooperado_w = 'N' or	(exists	(select	1
							from	pls_cooperado x
							where	((x.cd_cgc = a.cd_cgc) or (x.cd_pessoa_fisica = a.cd_pessoa_fisica))
							and	coalesce(x.dt_exclusao::text, '') = ''
							)
						)
		)
	and	((ie_cooperativas_w = 'N') or (ie_cooperativas_w = 'SC' and (not exists (select	1
								from	pls_congenere_camara z,
									pls_congenere w
								where	z.nr_seq_congenere	= w.nr_sequencia
								and	w.cd_cgc		= a.cd_cgc
								and	coalesce(dt_final_cr_w,a.dt_emissao) between z.dt_inicio_vigencia_ref and z.dt_fim_vigencia_ref
								))
						and (exists (select	1
								from	pls_congenere x
								where	x.cd_cgc	= a.cd_cgc
								and	coalesce(x.dt_exclusao::text, '') = '')
								)) or (ie_cooperativas_w = 'S' and exists (select	1
								from	pls_congenere x
								where	x.cd_cgc	= a.cd_cgc
								and	coalesce(x.dt_exclusao::text, '') = '')
								)

		)
	and	((ie_tipo_pessoa_w = 'A') or (ie_tipo_pessoa_w = 'F' and (a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '')) or (ie_tipo_pessoa_w = 'J' and (a.cd_cgc IS NOT NULL AND a.cd_cgc::text <> '')))
	and	ie_tipo_data_cr_w = 'V'
	and	not exists (	select	1
				from	titulo_receber_resp_pgto r
				where	r.nr_titulo	= a.nr_titulo
				and	a.dt_pagamento_previsto between r.dt_inicio_vigencia and coalesce(r.dt_fim_vigencia,a.dt_pagamento_previsto))
	
union all

	select	3 ie_ordem,
		a.nr_titulo nr_titulo_receber,
		null nr_titulo_pagar,
		b.cd_pessoa_fisica cd_pessoa_fisica,
		b.cd_cgc cd_cgc,
		a.vl_saldo_titulo,
		(obter_juros_multa_titulo(a.nr_titulo, clock_timestamp(),'R','J'))::numeric  vl_saldo_juros,
		(obter_juros_multa_titulo(a.nr_titulo, clock_timestamp(),'R','M'))::numeric  vl_saldo_multa,
		coalesce(obter_valores_tit_rec(a.nr_titulo,'D'),0) vl_desconto,
		0 vl_despesa
	from	titulo_receber_resp_pgto b,
		titulo_receber a
	where (coalesce(ie_titulo_bordero_w,'S') = 'S' or
		not exists (select	1
		from	bordero_tit_rec x
		where	x.nr_titulo	= a.nr_titulo))
	and (coalesce(ie_titulo_escritural_w,'S') = 'S' or
		not exists (select	1
		from	titulo_receber_cobr x
		where	x.nr_titulo	= a.nr_titulo))
	and	b.nr_titulo	= a.nr_titulo
	and	a.dt_emissao between coalesce(b.dt_inicio_vigencia,a.dt_emissao) and fim_dia(coalesce(b.dt_fim_vigencia,a.dt_emissao))
	and	coalesce(a.dt_liquidacao::text, '') = ''
	and	a.vl_saldo_titulo > 0
	and	a.ie_situacao = '1'
	and (a.cd_estabelecimento	= cd_estabelecimento_w
	or	coalesce(cd_estabelecimento_w::text, '') = '')
	and	a.dt_emissao between coalesce(dt_inicial_cr_w,a.dt_emissao) and coalesce(dt_final_cr_w,a.dt_emissao)
	and (a.ie_tipo_titulo 	= nr_tipo_titulo_cr_w
	or	coalesce(nr_tipo_titulo_cr_w::text, '') = '')
	and	a.dt_emissao between b.dt_inicio_vigencia and coalesce(b.dt_fim_vigencia,a.dt_emissao)
	and	((b.cd_pessoa_fisica = cd_pessoa_fisica_lote_w) or (b.cd_cgc = cd_cgc_lote_w) or (exists (select 1
			from	pls_congenere x
			where	a.cd_cgc = x.cd_cgc
			and	pls_obter_coop_pag_resp_fin(x.nr_sequencia,clock_timestamp()) = cd_cgc_lote_w)) or (coalesce(cd_pessoa_fisica_lote_w::text, '') = '' and coalesce(cd_cgc_lote_w::text, '') = ''))
	and	(ie_cooperado_w = 'N' or	(exists	(select	1
							from	pls_cooperado x
							where	((x.cd_cgc = b.cd_cgc) or (x.cd_pessoa_fisica = b.cd_pessoa_fisica))
							and	coalesce(x.dt_exclusao::text, '') = ''
							)
						)
		)
	and	((ie_cooperativas_w = 'N') or (ie_cooperativas_w = 'SC' and (not exists (select	1
								from	pls_congenere_camara z,
									pls_congenere w
								where	z.nr_seq_congenere	= w.nr_sequencia
								and	w.cd_cgc		= b.cd_cgc
								and	coalesce(dt_final_cr_w,a.dt_emissao) between z.dt_inicio_vigencia_ref and z.dt_fim_vigencia_ref
								))
						and (exists (select	1
								from	pls_congenere x
								where	x.cd_cgc	= b.cd_cgc
								and	coalesce(x.dt_exclusao::text, '') = '')
								)) or (ie_cooperativas_w = 'S' and exists (select	1
								from	pls_congenere x
								where	x.cd_cgc	= b.cd_cgc
								and	coalesce(x.dt_exclusao::text, '') = '')
								)
		)
	and	((ie_tipo_pessoa_w = 'A') or (ie_tipo_pessoa_w = 'F' and (b.cd_pessoa_fisica IS NOT NULL AND b.cd_pessoa_fisica::text <> '')) or (ie_tipo_pessoa_w = 'J' and (b.cd_cgc IS NOT NULL AND b.cd_cgc::text <> '')))
	and	ie_tipo_data_cr_w = 'E'
	
union all

	select	4 ie_ordem,
		a.nr_titulo nr_titulo_receber,
		null nr_titulo_pagar,
		b.cd_pessoa_fisica cd_pessoa_fisica,
		b.cd_cgc cd_cgc,
		a.vl_saldo_titulo,
		(obter_juros_multa_titulo(a.nr_titulo, clock_timestamp(),'R','J'))::numeric  vl_saldo_juros,
		(obter_juros_multa_titulo(a.nr_titulo, clock_timestamp(),'R','M'))::numeric  vl_saldo_multa,
		coalesce(obter_valores_tit_rec(a.nr_titulo,'D'),0) vl_desconto,
		0 vl_despesa
	from	titulo_receber_resp_pgto b,
		titulo_receber a
	where (coalesce(ie_titulo_bordero_w,'S') = 'S' or
		not exists (select	1
		from	bordero_tit_rec x
		where	x.nr_titulo	= a.nr_titulo))
	and (coalesce(ie_titulo_escritural_w,'S') = 'S' or
		not exists (select	1
		from	titulo_receber_cobr x
		where	x.nr_titulo	= a.nr_titulo))
	and	a.nr_titulo	= b.nr_titulo
	and	a.dt_pagamento_previsto between b.dt_inicio_vigencia and fim_dia(coalesce(b.dt_fim_vigencia,a.dt_pagamento_previsto))
	and	coalesce(a.dt_liquidacao::text, '') = ''
	and	a.vl_saldo_titulo > 0
	and	a.ie_situacao = '1'
	and (a.cd_estabelecimento	= cd_estabelecimento_w
	or	coalesce(cd_estabelecimento_w::text, '') = '')
	and	a.dt_pagamento_previsto between coalesce(dt_inicial_cr_w,a.dt_pagamento_previsto) and coalesce(dt_final_cr_w,a.dt_pagamento_previsto)
	and (a.ie_tipo_titulo 	= nr_tipo_titulo_cr_w
	or	coalesce(nr_tipo_titulo_cr_w::text, '') = '')
	and	a.dt_pagamento_previsto between b.dt_inicio_vigencia and coalesce(b.dt_fim_vigencia,a.dt_pagamento_previsto)
	and	((b.cd_pessoa_fisica = cd_pessoa_fisica_lote_w) or (b.cd_cgc = cd_cgc_lote_w) or (exists (select 1
			from	pls_congenere x
			where	a.cd_cgc = x.cd_cgc
			and	pls_obter_coop_pag_resp_fin(x.nr_sequencia,clock_timestamp()) = cd_cgc_lote_w)) or (coalesce(cd_pessoa_fisica_lote_w::text, '') = '' and coalesce(cd_cgc_lote_w::text, '') = ''))
	and	(ie_cooperado_w = 'N' or	(exists	(select	1
							from	pls_cooperado x
							where	((x.cd_cgc = b.cd_cgc) or (x.cd_pessoa_fisica = b.cd_pessoa_fisica))
							and	coalesce(x.dt_exclusao::text, '') = ''
							)
						)
		)
	and	((ie_cooperativas_w = 'N') or (ie_cooperativas_w = 'SC' and (not exists (select	1
								from	pls_congenere_camara z,
									pls_congenere w
								where	z.nr_seq_congenere	= w.nr_sequencia
								and	w.cd_cgc		= b.cd_cgc
								and	coalesce(dt_final_cr_w,a.dt_emissao) between z.dt_inicio_vigencia_ref and z.dt_fim_vigencia_ref
								))
						and (exists (select	1
								from	pls_congenere x
								where	x.cd_cgc	= b.cd_cgc
								and	coalesce(x.dt_exclusao::text, '') = '')
								)) or (ie_cooperativas_w = 'S' and exists (select	1
								from	pls_congenere x
								where	x.cd_cgc	= b.cd_cgc
								and	coalesce(x.dt_exclusao::text, '') = '')
								)

		)
	and	((ie_tipo_pessoa_w = 'A') or (ie_tipo_pessoa_w = 'F' and (b.cd_pessoa_fisica IS NOT NULL AND b.cd_pessoa_fisica::text <> '')) or (ie_tipo_pessoa_w = 'J' and (b.cd_cgc IS NOT NULL AND b.cd_cgc::text <> '')))
	and	ie_tipo_data_cr_w = 'V'
	
union all

	select	5 ie_ordem,
		null nr_titulo_receber,
		a.nr_titulo nr_titulo_pagar,
		a.cd_pessoa_fisica cd_pessoa_fisica,
		a.cd_cgc cd_cgc,
		a.vl_saldo_titulo,
		(obter_juros_multa_titulo(a.nr_titulo, clock_timestamp(),'P','J'))::numeric  vl_saldo_juros,
		(obter_juros_multa_titulo(a.nr_titulo, clock_timestamp(),'P','M'))::numeric  vl_saldo_multa,
		coalesce(obter_valores_tit_pagar(a.nr_titulo,clock_timestamp(),'D'), coalesce(a.vl_dia_antecipacao,0)) vl_desconto,
		coalesce(a.vl_outras_despesas,0) vl_despesa
	from	titulo_pagar a
	where (coalesce(ie_titulo_bordero_w,'S') = 'S' or
		not exists (select	1
		from	titulo_pagar_bordero_v x
		where	x.nr_titulo	= a.nr_titulo))
	and (coalesce(ie_titulo_escritural_w,'S') = 'S' or
		not exists (select	1
		from	titulo_pagar_escrit x
		where	x.nr_titulo	= a.nr_titulo))
	and	coalesce(a.dt_liquidacao::text, '') = ''
	and	a.vl_saldo_titulo > 0
	and	a.ie_situacao = 'A'
	and (a.cd_estabelecimento	= cd_estabelecimento_w
	or	coalesce(cd_estabelecimento_w::text, '') = '')
	and	a.dt_emissao between coalesce(dt_inicial_cp_w,a.dt_emissao) and fim_dia(coalesce(dt_final_cp_w,a.dt_emissao))
	and (a.ie_tipo_titulo 	= nr_tipo_titulo_cp_w
	or	coalesce(nr_tipo_titulo_cp_w::text, '') = '')
	and	((a.cd_pessoa_fisica = cd_pessoa_fisica_lote_w) or (a.cd_cgc = cd_cgc_lote_w) or (exists (select 1
			from	pls_congenere x
			where	a.cd_cgc = x.cd_cgc
			and	pls_obter_coop_pag_resp_fin(x.nr_sequencia,clock_timestamp()) = cd_cgc_lote_w)) or (coalesce(cd_pessoa_fisica_lote_w::text, '') = '' and coalesce(cd_cgc_lote_w::text, '') = ''))
	and	(ie_cooperado_w = 'N' or	(exists	(select	1
							from	pls_cooperado x
							where	((x.cd_cgc = a.cd_cgc) or (x.cd_pessoa_fisica = a.cd_pessoa_fisica))
							and	coalesce(x.dt_exclusao::text, '') = ''
							)
						)
		)
	and	((ie_cooperativas_w = 'N') or (ie_cooperativas_w = 'SC' and (not exists (select	1
								from	pls_congenere_camara z,
									pls_congenere w
								where	z.nr_seq_congenere	= w.nr_sequencia
								and	w.cd_cgc		= a.cd_cgc
								and	coalesce(dt_final_cp_w,a.dt_emissao) between z.dt_inicio_vigencia_ref and z.dt_fim_vigencia_ref
								)
								)
						and (exists (select	1
								from	pls_congenere x
								where	x.cd_cgc	= a.cd_cgc
								and	coalesce(x.dt_exclusao::text, '') = '')
								)) or (ie_cooperativas_w = 'S' and exists (select	1
								from	pls_congenere x
								where	x.cd_cgc	= a.cd_cgc
								and	coalesce(x.dt_exclusao::text, '') = '')
								)

		)
	and	((ie_tipo_pessoa_w = 'A') or (ie_tipo_pessoa_w = 'F' and (a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '')) or (ie_tipo_pessoa_w = 'J' and (a.cd_cgc IS NOT NULL AND a.cd_cgc::text <> '')))
	and	ie_tipo_data_cp_w = 'E'
	
union all

	select	6 ie_ordem,
		null nr_titulo_receber,
		a.nr_titulo nr_titulo_pagar,
		a.cd_pessoa_fisica cd_pessoa_fisica,
		a.cd_cgc cd_cgc,
		a.vl_saldo_titulo,
		(obter_juros_multa_titulo(a.nr_titulo, clock_timestamp(),'P','J'))::numeric  vl_saldo_juros,
		(obter_juros_multa_titulo(a.nr_titulo, clock_timestamp(),'P','M'))::numeric  vl_saldo_multa,
		coalesce(obter_valores_tit_pagar(a.nr_titulo,clock_timestamp(),'D'), coalesce(a.vl_dia_antecipacao,0)) vl_desconto,
		coalesce(a.vl_outras_despesas,0) vl_despesa
	from	titulo_pagar a
	where (coalesce(ie_titulo_bordero_w,'S') = 'S' or
		not exists (select	1
		from	titulo_pagar_bordero_v x
		where	x.nr_titulo	= a.nr_titulo))
	and (coalesce(ie_titulo_escritural_w,'S') = 'S' or
		not exists (select	1
		from	titulo_pagar_escrit x
		where	x.nr_titulo	= a.nr_titulo))
	and	coalesce(a.dt_liquidacao::text, '') = ''
	and	a.vl_saldo_titulo > 0
	and	a.ie_situacao = 'A'
	and (a.cd_estabelecimento	= cd_estabelecimento_w
	or	coalesce(cd_estabelecimento_w::text, '') = '')
	and	a.dt_vencimento_atual between coalesce(dt_inicial_cp_w,a.dt_vencimento_atual) and fim_dia(coalesce(dt_final_cp_w,a.dt_vencimento_atual))
	and (a.ie_tipo_titulo 	= nr_tipo_titulo_cp_w
	or	coalesce(nr_tipo_titulo_cp_w::text, '') = '')
	and	((a.cd_pessoa_fisica = cd_pessoa_fisica_lote_w) or (a.cd_cgc = cd_cgc_lote_w) or (exists (select 1
			from	pls_congenere x
			where	a.cd_cgc = x.cd_cgc
			and	pls_obter_coop_pag_resp_fin(x.nr_sequencia,clock_timestamp()) = cd_cgc_lote_w)) or (coalesce(cd_pessoa_fisica_lote_w::text, '') = '' and coalesce(cd_cgc_lote_w::text, '') = ''))
	and	(ie_cooperado_w = 'N' or	(exists	(select	1
							from	pls_cooperado x
							where	((x.cd_cgc = a.cd_cgc) or (x.cd_pessoa_fisica = a.cd_pessoa_fisica))
							and	coalesce(x.dt_exclusao::text, '') = ''
							)
						)
		)
	and	((ie_cooperativas_w = 'N') or (ie_cooperativas_w = 'SC' and (not exists (select	1
								from	pls_congenere_camara z,
									pls_congenere w
								where	z.nr_seq_congenere	= w.nr_sequencia
								and	w.cd_cgc		= a.cd_cgc
								and	coalesce(dt_final_cp_w,a.dt_emissao) between z.dt_inicio_vigencia_ref and z.dt_fim_vigencia_ref
								)
								)
						and (exists (select	1
								from	pls_congenere x
								where	x.cd_cgc	= a.cd_cgc
								and	coalesce(x.dt_exclusao::text, '') = '')
								)) or (ie_cooperativas_w = 'S' and exists (select	1
								from	pls_congenere x
								where	x.cd_cgc	= a.cd_cgc
								and	coalesce(x.dt_exclusao::text, '') = '')
								)

		)
	and	((ie_tipo_pessoa_w = 'A') or (ie_tipo_pessoa_w = 'F' and (a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '')) or (ie_tipo_pessoa_w = 'J' and (a.cd_cgc IS NOT NULL AND a.cd_cgc::text <> '')))
	and	ie_tipo_data_cp_w = 'V'
	order by
		cd_pessoa_fisica,
		cd_cgc,
		ie_ordem;

/* Limpar pessoas que possuem somente um dos 2 tipos */

c02 CURSOR FOR
	SELECT	a.nr_sequencia
	from	pessoa_encontro_contas a
	where	a.nr_seq_lote	= nr_seq_lote_p
	and	((not exists (SELECT	1
				from	encontro_contas_item x
				where	x.nr_seq_pessoa = a.nr_sequencia
				and	(x.nr_titulo_receber IS NOT NULL AND x.nr_titulo_receber::text <> ''))) or (not exists (select	1
				from	encontro_contas_item x
				where	x.nr_seq_pessoa = a.nr_sequencia
				and	(x.nr_titulo_pagar IS NOT NULL AND x.nr_titulo_pagar::text <> ''))))
	and	coalesce(ie_gera_titulos_p::text, '') = '';

C03 CURSOR FOR
	SELECT	a.nr_sequencia
	from	titulo_receber			b,
		titulo_receber_resp_pgto	a
	where	b.nr_titulo	= nr_titulo_receber_w
	and	a.nr_titulo	= b.nr_titulo
	and	b.dt_pagamento_previsto between a.dt_inicio_vigencia and fim_dia(coalesce(a.dt_fim_vigencia,b.dt_pagamento_previsto))
	and	ie_tipo_data_cr_w	= 'V'
	
union all

	SELECT	a.nr_sequencia
	from	titulo_receber			b,
		titulo_receber_resp_pgto	a
	where	b.nr_titulo	= nr_titulo_receber_w
	and	a.nr_titulo	= b.nr_titulo
	and	b.dt_emissao between a.dt_inicio_vigencia and fim_dia(coalesce(a.dt_fim_vigencia,b.dt_emissao))
	and	ie_tipo_data_cr_w	= 'E';

C04 CURSOR FOR
	SELECT	coalesce(a.ie_juros,'N'),
		coalesce(a.ie_multa,'N'),
		coalesce(ie_despesa_desconto, 'N')
	from	regra_receb_enc_contas	a
	where	a.ie_tipo_pessoa	= ie_tipo_pessoa_regra_w
	order by
		a.nr_sequencia desc;

C13 CURSOR FOR
	SELECT	a.nr_sequencia
	from	pessoa_encontro_contas	a
	where	a.nr_seq_lote = nr_seq_lote_p;



BEGIN

if (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') then
	select	a.dt_inicial_cr,
		a.dt_final_cr,
		a.dt_inicial_cp,
		a.dt_final_cp,
		a.ie_tipo_data_cr,
		a.ie_tipo_data_cp,
		a.cd_pessoa_fisica,
		a.cd_cgc,
		a.ie_cooperativas,
		a.ie_cooperados,
		a.ie_tipo_pessoa,
		a.cd_estabelecimento,
		a.nr_tipo_titulo_cr,
		a.nr_tipo_titulo_cp
	into STRICT	dt_inicial_cr_w,
		dt_final_cr_w,
		dt_inicial_cp_w,
		dt_final_cp_w,
		ie_tipo_data_cr_w,
		ie_tipo_data_cp_w,
		cd_pessoa_fisica_lote_w,
		cd_cgc_lote_w,
		ie_cooperativas_w,
		ie_cooperado_w,
		ie_tipo_pessoa_w,
		cd_estabelecimento_w,
		nr_tipo_titulo_cr_w,
		nr_tipo_titulo_cp_w
	from	lote_encontro_contas a
	where	a.nr_sequencia	= nr_seq_lote_p;

	ie_titulo_escritural_w := obter_param_usuario(9056, 8, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_titulo_escritural_w);
	ie_titulo_bordero_w := obter_param_usuario(9056, 7, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_titulo_bordero_w);

	if (cd_cgc_lote_w IS NOT NULL AND cd_cgc_lote_w::text <> '') then /* Obter o tipo da pessoa*/
		select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'CO' END
		into STRICT	ie_tipo_pessoa_regra_w
		from	pls_congenere
		where	cd_cgc	= cd_cgc_lote_w
		and	coalesce(dt_exclusao::text, '') = '';

		if (ie_tipo_pessoa_regra_w = 'N') then
			select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'C' END
			into STRICT	ie_tipo_pessoa_regra_w
			from	pls_cooperado
			where	cd_cgc	= cd_cgc_lote_w
			and	coalesce(dt_exclusao::text, '') = '';

			if (ie_tipo_pessoa_regra_w = 'N') then
				ie_tipo_pessoa_regra_w	:= 'CL';
			end if;
		end if;
	else
		select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'C' END
		into STRICT	ie_tipo_pessoa_regra_w
		from	pls_cooperado
		where	cd_pessoa_fisica	= cd_pessoa_fisica_lote_w
		and	coalesce(dt_exclusao::text, '') = '';

		if (ie_tipo_pessoa_regra_w = 'N') then
			ie_tipo_pessoa_regra_w	:= 'CL';
		end if;
	end if;

	select	count(1) /* Obter se existe regra*/
	into STRICT	qt_regra_w
	from	regra_receb_enc_contas
	where	ie_tipo_pessoa	= ie_tipo_pessoa_regra_w  LIMIT 1;

	if (qt_regra_w <> 0) then
		open C04;
		loop
		fetch C04 into
			ie_juros_w,
			ie_multa_w,
			ie_despesa_desconto_w;
		EXIT WHEN NOT FOUND; /* apply on C04 */
		end loop;
		close C04;
	end if;

	if (coalesce(ie_juros_w::text, '') = '') then
		ie_juros_w := 'N';
	end if;

	if (coalesce(ie_multa_w::text, '') = '') then
		ie_multa_w := 'N';
	end if;

	if (coalesce(ie_despesa_desconto_w::text, '') = '') then
		ie_despesa_desconto_w := 'N';
	end if;

	select	count(1)
	into STRICT	qt_titulos_w
	from	encontro_contas_item a where (a.nr_titulo_pagar	= nr_titulo_pagar_w
	or	a.nr_titulo_receber	= nr_titulo_receber_w)
	and	exists (SELECT	1
			from	pessoa_encontro_contas 	y,
				lote_encontro_contas 	x
			where	x.nr_sequencia 	= y.nr_seq_lote
			and	y.nr_sequencia	= a.nr_seq_pessoa
			and	coalesce(x.dt_cancelamento::text, '') = '') LIMIT 1;

	if (ie_acao_p = 'G') then
		open c01;
		loop
		fetch c01 into
			ie_ordem_w,
			nr_titulo_receber_w,
			nr_titulo_pagar_w,
			cd_pessoa_fisica_w,
			cd_cgc_w,
			vl_saldo_titulo_w,
			vl_saldo_juros_w,
			vl_saldo_multa_w,
			vl_desconto_w,
			vl_despesa_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin
			ie_possui_tit_aberto_w  := 'S';
			vl_saldo_juros_pag_w	:= vl_saldo_juros_w;
			vl_saldo_multa_pag_w	:= vl_saldo_multa_w;
			vl_desconto_pag_w	:= vl_desconto_w;
			vl_despesa_pag_w	:= vl_despesa_w;

			if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
				select	max(a.nr_sequencia)
				into STRICT	nr_seq_pessoa_w
				from	pessoa_encontro_contas a
				where	a.nr_seq_lote		= nr_seq_lote_p
				and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w;
			elsif (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') then
				select	max(a.nr_sequencia)
				into STRICT	nr_seq_pessoa_w
				from	pessoa_encontro_contas a
				where	a.nr_seq_lote		= nr_seq_lote_p
				and	a.cd_cgc		= cd_cgc_w;
			end if;

			if (coalesce(nr_seq_pessoa_w::text, '') = '') then
				select	nextval('pessoa_encontro_contas_seq')
				into STRICT	nr_seq_pessoa_w
				;

				insert into pessoa_encontro_contas(nr_sequencia,
					nm_usuario,
					dt_atualizacao,
					nm_usuario_nrec,
					dt_atualizacao_nrec,
					nr_seq_lote,
					cd_pessoa_fisica,
					cd_cgc)
				values (nr_seq_pessoa_w,
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nr_seq_lote_p,
					cd_pessoa_fisica_w,
					cd_cgc_w);

				vl_saldo_receber_w	:= 0;
				vl_saldo_pagar_w	:= 0;
			end if;

			/* Christian, OS 271572 - Não permitir que os títulos sejam adicionados em duplicidade, seja no mesmo lote ou em lotes diferentes. */

			if (qt_titulos_w = 0) and (ie_gera_titulos_p = 'S') then
				insert into encontro_contas_item(nr_sequencia,
					nm_usuario,
					dt_atualizacao,
					nm_usuario_nrec,
					dt_atualizacao_nrec,
					nr_seq_pessoa,
					nr_titulo_receber,
					nr_titulo_pagar)
				values (nextval('encontro_contas_item_seq'),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nr_seq_pessoa_w,
					nr_titulo_receber_w,
					nr_titulo_pagar_w);

				-- A RECEBER
				if (ie_juros_w = 'N') or (ie_juros_w = 'P') then
					vl_saldo_juros_w	:= 0;
				end if;

				if (ie_multa_w = 'N') or (ie_multa_w = 'P') then
					vl_saldo_multa_w	:= 0;
				end if;

				if (ie_despesa_desconto_w = 'N') or (ie_despesa_desconto_w = 'P') then
					vl_desconto_w	:= 0;
					vl_despesa_w	:= 0;
				end if;

				-- A PAGAR
				if (ie_juros_w = 'N') or (ie_juros_w = 'R') then
					vl_saldo_juros_pag_w	:= 0;
				end if;

				if (ie_multa_w = 'N') or (ie_multa_w = 'R') then
					vl_saldo_multa_pag_w	:= 0;
				end if;

				if (ie_despesa_desconto_w = 'N') or (ie_despesa_desconto_w = 'R') then
					vl_desconto_pag_w	:= 0;
					vl_despesa_pag_w	:= 0;
				end if;

				if (nr_titulo_receber_w IS NOT NULL AND nr_titulo_receber_w::text <> '') then
					vl_saldo_receber_w	:= vl_saldo_receber_w + vl_saldo_titulo_w + vl_saldo_juros_w + vl_saldo_multa_w +
									vl_despesa_w - vl_desconto_w;

				elsif (nr_titulo_pagar_w IS NOT NULL AND nr_titulo_pagar_w::text <> '') then
					vl_saldo_pagar_w	:= vl_saldo_pagar_w + vl_saldo_titulo_w + vl_saldo_juros_pag_w + vl_saldo_multa_pag_w +
									vl_despesa_pag_w - vl_desconto_pag_w;

				end if;

				vl_saldo_calc_w	:= vl_saldo_receber_w - vl_saldo_pagar_w;

				if (vl_saldo_calc_w > 0) then
					vl_saldo_credor_w	:= vl_saldo_calc_w;
					vl_saldo_devedor_w	:= null;
				elsif (vl_saldo_calc_w < 0) then
					vl_saldo_credor_w	:= null;
					vl_saldo_devedor_w	:= abs(vl_saldo_calc_w);
				end if;

				update	pessoa_encontro_contas
				set	vl_saldo_credor		= vl_saldo_credor_w,
					vl_saldo_devedor	= vl_saldo_devedor_w
				where	nr_sequencia		= nr_seq_pessoa_w;
			end if;

			--dbms_output.put_line('receber= ' || vl_saldo_receber_w || ' pagar= ' || vl_saldo_pagar_w);
			end;
		end loop;
		close c01;

		if (ie_possui_tit_aberto_w = 'N')then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(339415);
		end if;

		open c02;
		loop
		fetch c02 into
			nr_seq_pessoa_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
			select	count(1)
			into STRICT	qt_tit_rec_w
			from	encontro_contas_item a
			where	a.nr_seq_pessoa	= nr_seq_pessoa_w
			and	(a.nr_titulo_receber IS NOT NULL AND a.nr_titulo_receber::text <> '')  LIMIT 1;

			select	count(1)
			into STRICT	qt_tit_pagar_w
			from	encontro_contas_item a
			where	a.nr_seq_pessoa	= nr_seq_pessoa_w
			and	(a.nr_titulo_pagar IS NOT NULL AND a.nr_titulo_pagar::text <> '')  LIMIT 1;

			if (qt_tit_rec_w > 0) and (qt_tit_pagar_w > 0) then
				null;
			else
				delete from encontro_contas_item
				where	nr_seq_pessoa	= nr_seq_pessoa_w;

				delete from pessoa_encontro_contas
				where	nr_sequencia	= nr_seq_pessoa_w;
			end if;
			end;
		end loop;
		close c02;

		select	coalesce(sum(a.vl_saldo_credor),0) - coalesce(sum(a.vl_saldo_devedor),0)
		into STRICT	vl_saldo_lote_w
		from	pessoa_encontro_contas a
		where	a.nr_seq_lote	= nr_seq_lote_p;

		update	lote_encontro_contas
		set	dt_geracao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp(),
			vl_saldo	= vl_saldo_lote_w
		where	nr_sequencia	= nr_seq_lote_p;

		open c13;
		loop
		fetch c13 into
			nr_seq_pessoa_w;
		EXIT WHEN NOT FOUND; /* apply on c13 */
			begin
			if (nr_seq_pessoa_w IS NOT NULL AND nr_seq_pessoa_w::text <> '') then
				CALL atualizar_vl_encontro_contas(nr_seq_pessoa_w,nr_seq_lote_p,nm_usuario_p);
			end if;
			end;
		end loop;
		close c13;
	else
		delete from encontro_contas_item a
		where	exists (SELECT	1
				from	pessoa_encontro_contas x
				where	x.nr_sequencia	= a.nr_seq_pessoa
				and	x.nr_seq_lote	= nr_seq_lote_p);

		delete from pessoa_encontro_contas a
		where	nr_seq_lote	= nr_seq_lote_p;

		update	lote_encontro_contas
		set	dt_geracao	 = NULL,
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp(),
			vl_saldo	= 0
		where	nr_sequencia	= nr_seq_lote_p;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_lote_encontro_contas ( nr_seq_lote_p bigint, ie_gera_titulos_p text, nm_usuario_p text, ie_acao_p text) FROM PUBLIC;

