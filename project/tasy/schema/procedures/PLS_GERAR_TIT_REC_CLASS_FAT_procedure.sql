-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_tit_rec_class_fat ( nr_titulo_p titulo_receber.nr_titulo%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, ie_commit_p text ) AS $body$
DECLARE


nr_seq_lote_fat_w		pls_lote_faturamento.nr_sequencia%type;
nr_seq_pls_fatura_w		pls_fatura.nr_sequencia%type;
cd_conta_debito_w		pls_conta_pos_estab_contab.cd_conta_deb_provisao%type;
nr_seq_classif_w		titulo_receber_classif.nr_sequencia%type;
vl_classificacao_w		titulo_receber_classif.vl_classificacao%type;
vl_faturado_classif_w		titulo_receber_classif.vl_classificacao%type;
vl_faturado_w			pls_fatura.vl_fatura%type;
cd_conta_financ_w		titulo_receber_classif.cd_conta_financ%type;
nr_seq_camara_w			pls_camara_compensacao.nr_sequencia%type;
ie_tipo_intercambio_w		pls_conta_financ_regra.ie_tipo_intercambio%type := 'T';
nr_seq_congenere_w		pls_congenere.nr_sequencia%type;
dt_emissao_w			pls_fatura.dt_emissao%type;
ie_tipo_congenere_w		pls_congenere.ie_tipo_congenere%type;
ie_gerar_fat_contab_w		pls_parametro_faturamento.ie_gerar_fat_contab%type;

c01 CURSOR FOR
	SELECT	cd_conta_deb,
		sum(coalesce(vl_faturado,0)) vl_faturado
	from (
		-- PROCEDIMENTO - SERVIÇO
		SELECT	x.cd_conta_deb_ndc cd_conta_deb,
			sum(coalesce((x.vl_custo_operacional - x.vl_administracao),0)) vl_faturado
		FROM pls_conta_pos_estabelecido w, pls_fatura_evento c, pls_fatura_conta b, pls_conta_pos_estab_contab x
LEFT OUTER JOIN pls_fatura_proc a ON (x.nr_sequencia = a.nr_seq_conta_pos_contab)
WHERE c.nr_sequencia		= b.nr_seq_fatura_evento and b.nr_sequencia		= a.nr_seq_fatura_conta and w.nr_sequencia		= a.nr_seq_conta_pos_estab and w.nr_sequencia		= x.nr_seq_conta_pos  and x.nr_seq_lote_fat	= nr_seq_lote_fat_w and c.nr_seq_fatura		= nr_seq_pls_fatura_w and ie_gerar_fat_contab_w	= 'S' and a.ie_tipo_cobranca in ('1','2') and (x.cd_conta_deb_ndc IS NOT NULL AND x.cd_conta_deb_ndc::text <> '') group by x.cd_conta_deb_ndc
		
union	all

		-- MATERIAL - SERVIÇO
		select	x.cd_conta_deb_ndc cd_conta_deb,
			sum(coalesce((x.vl_custo_operacional - x.vl_administracao),0)) vl_faturado
		FROM pls_conta_pos_estabelecido w, pls_fatura_evento c, pls_fatura_conta b, pls_conta_pos_estab_contab x
LEFT OUTER JOIN pls_fatura_mat a ON (x.nr_sequencia = a.nr_seq_conta_pos_contab)
WHERE c.nr_sequencia		= b.nr_seq_fatura_evento and b.nr_sequencia		= a.nr_seq_fatura_conta and w.nr_sequencia		= a.nr_seq_conta_pos_estab and w.nr_sequencia		= x.nr_seq_conta_pos  and x.nr_seq_lote_fat	= nr_seq_lote_fat_w and c.nr_seq_fatura		= nr_seq_pls_fatura_w and ie_gerar_fat_contab_w	= 'S' and a.ie_tipo_cobranca in ('1','2') and (x.cd_conta_deb_ndc IS NOT NULL AND x.cd_conta_deb_ndc::text <> '') group by x.cd_conta_deb_ndc
		
union all

		-- PROCEDIMENTO - TAXA DO SERVIÇO
		select	coalesce(x.cd_conta_deb_taxa,x.cd_conta_deb_provisao) cd_conta_deb,
			sum(coalesce(x.vl_administracao,0)) vl_faturado
		FROM pls_conta_pos_estabelecido w, pls_fatura_evento c, pls_fatura_conta b, pls_conta_pos_estab_contab x
LEFT OUTER JOIN pls_fatura_proc a ON (x.nr_sequencia = a.nr_seq_conta_pos_contab)
WHERE c.nr_sequencia		= b.nr_seq_fatura_evento and b.nr_sequencia		= a.nr_seq_fatura_conta and w.nr_sequencia		= a.nr_seq_conta_pos_estab and w.nr_sequencia		= x.nr_seq_conta_pos  and x.nr_seq_lote_fat	= nr_seq_lote_fat_w and c.nr_seq_fatura		= nr_seq_pls_fatura_w and ie_gerar_fat_contab_w	= 'S' and a.ie_tipo_cobranca in ('1','2') and ((x.cd_conta_deb_taxa IS NOT NULL AND x.cd_conta_deb_taxa::text <> '') or (x.cd_conta_deb_provisao IS NOT NULL AND x.cd_conta_deb_provisao::text <> '')) group by x.cd_conta_deb_taxa,
			x.cd_conta_deb_provisao
		
union	all

		-- MATERIAL - TAXA DO SERVIÇO
		select	coalesce(x.cd_conta_deb_taxa,x.cd_conta_deb_provisao) cd_conta_deb,
			sum(coalesce(x.vl_administracao,0)) vl_faturado
		FROM pls_conta_pos_estabelecido w, pls_fatura_evento c, pls_fatura_conta b, pls_conta_pos_estab_contab x
LEFT OUTER JOIN pls_fatura_mat a ON (x.nr_sequencia = a.nr_seq_conta_pos_contab)
WHERE c.nr_sequencia		= b.nr_seq_fatura_evento and b.nr_sequencia		= a.nr_seq_fatura_conta and w.nr_sequencia		= a.nr_seq_conta_pos_estab and w.nr_sequencia		= x.nr_seq_conta_pos  and x.nr_seq_lote_fat	= nr_seq_lote_fat_w and c.nr_seq_fatura		= nr_seq_pls_fatura_w and ie_gerar_fat_contab_w	= 'S' and a.ie_tipo_cobranca in ('1','2') and ((x.cd_conta_deb_taxa IS NOT NULL AND x.cd_conta_deb_taxa::text <> '') or (x.cd_conta_deb_provisao IS NOT NULL AND x.cd_conta_deb_provisao::text <> '')) group by x.cd_conta_deb_taxa,
			x.cd_conta_deb_provisao
		
union all

		-- PROCEDIMENTO - TAXA
		select	d.cd_conta_deb cd_conta_deb,
			sum(coalesce(d.vl_taxa,0)) vl_faturado
		from	pls_conta_pos_taxa_contab	d,
			pls_conta_pos_estab_taxa	t,
			pls_conta_pos_estabelecido	w,
			pls_fatura_proc 		a,
			pls_fatura_conta 		b,
			pls_fatura_evento 		c
		where	c.nr_sequencia		= b.nr_seq_fatura_evento
		and	b.nr_sequencia		= a.nr_seq_fatura_conta
		and	w.nr_sequencia		= a.nr_seq_conta_pos_estab
		and	w.nr_sequencia		= t.nr_seq_conta_pos_estab
		and	t.nr_sequencia		= d.nr_seq_pos_estab_taxa
		and	w.nr_seq_lote_fat	= nr_seq_lote_fat_w
		and	c.nr_seq_fatura		= nr_seq_pls_fatura_w
		and	a.ie_tipo_cobranca in ('3','4')
		and	(d.cd_conta_deb IS NOT NULL AND d.cd_conta_deb::text <> '')
		group by d.cd_conta_deb
		
union	all

		-- MATERIAL - TAXA
		select	d.cd_conta_deb cd_conta_deb,
			sum(coalesce(d.vl_taxa,0)) vl_faturado
		from	pls_conta_pos_taxa_contab	d,
			pls_conta_pos_estab_taxa	t,
			pls_conta_pos_estabelecido	w,
			pls_fatura_mat 			a,
			pls_fatura_conta 		b,
			pls_fatura_evento 		c
		where	c.nr_sequencia		= b.nr_seq_fatura_evento
		and	b.nr_sequencia		= a.nr_seq_fatura_conta
		and	w.nr_sequencia		= a.nr_seq_conta_pos_estab
		and	w.nr_sequencia		= t.nr_seq_conta_pos_estab
		and	t.nr_sequencia		= d.nr_seq_pos_estab_taxa
		and	w.nr_seq_lote_fat	= nr_seq_lote_fat_w
		and	c.nr_seq_fatura		= nr_seq_pls_fatura_w
		and	a.ie_tipo_cobranca in ('3','4')
		and	(d.cd_conta_deb IS NOT NULL AND d.cd_conta_deb::text <> '')
		group by d.cd_conta_deb
		
union all

		-- PROCEDIMENTO - SERVIÇO
		select	x.cd_conta_deb_ndc cd_conta_deb,
			sum(coalesce((x.vl_custo_operacional - x.vl_administracao),0)) vl_faturado
		from	pls_conta_pos_estab_contab	x,
			pls_conta_pos_estabelecido	w,
			pls_fatura_proc 		a,
			pls_fatura_conta 		b,
			pls_fatura_evento 		c
		where	c.nr_sequencia		= b.nr_seq_fatura_evento
		and	b.nr_sequencia		= a.nr_seq_fatura_conta
		and	w.nr_sequencia		= a.nr_seq_conta_pos_estab
		and	w.nr_sequencia		= x.nr_seq_conta_pos
		and	x.nr_seq_conta_pos	= a.nr_seq_conta_pos_estab
		and	x.nr_seq_lote_fat	= nr_seq_lote_fat_w
		and	c.nr_seq_fatura		= nr_seq_pls_fatura_w
		and	ie_gerar_fat_contab_w	= 'N'
		and	a.ie_tipo_cobranca in ('1','2')
		and	(x.cd_conta_deb_ndc IS NOT NULL AND x.cd_conta_deb_ndc::text <> '')
		group by x.cd_conta_deb_ndc
		
union	all

		-- MATERIAL - SERVIÇO
		select	x.cd_conta_deb_ndc cd_conta_deb,
			sum(coalesce((x.vl_custo_operacional - x.vl_administracao),0)) vl_faturado
		from	pls_conta_pos_estab_contab	x,
			pls_conta_pos_estabelecido	w,
			pls_fatura_mat 			a,
			pls_fatura_conta 		b,
			pls_fatura_evento 		c
		where	c.nr_sequencia		= b.nr_seq_fatura_evento
		and	b.nr_sequencia		= a.nr_seq_fatura_conta
		and	w.nr_sequencia		= a.nr_seq_conta_pos_estab
		and	w.nr_sequencia		= x.nr_seq_conta_pos
		and	x.nr_seq_conta_pos	= a.nr_seq_conta_pos_estab
		and	x.nr_seq_lote_fat	= nr_seq_lote_fat_w
		and	c.nr_seq_fatura		= nr_seq_pls_fatura_w
		and	ie_gerar_fat_contab_w	= 'N'
		and	a.ie_tipo_cobranca in ('1','2')
		and	(x.cd_conta_deb_ndc IS NOT NULL AND x.cd_conta_deb_ndc::text <> '')
		group by x.cd_conta_deb_ndc
		
union all

		-- PROCEDIMENTO - TAXA DO SERVIÇO
		select	coalesce(x.cd_conta_deb_taxa,x.cd_conta_deb_provisao) cd_conta_deb,
			sum(coalesce(x.vl_administracao,0)) vl_faturado
		from	pls_conta_pos_estab_contab	x,
			pls_conta_pos_estabelecido	w,
			pls_fatura_proc 		a,
			pls_fatura_conta 		b,
			pls_fatura_evento 		c
		where	c.nr_sequencia		= b.nr_seq_fatura_evento
		and	b.nr_sequencia		= a.nr_seq_fatura_conta
		and	w.nr_sequencia		= a.nr_seq_conta_pos_estab
		and	w.nr_sequencia		= x.nr_seq_conta_pos
		and	x.nr_seq_conta_pos	= a.nr_seq_conta_pos_estab
		and	x.nr_seq_lote_fat	= nr_seq_lote_fat_w
		and	c.nr_seq_fatura		= nr_seq_pls_fatura_w
		and	ie_gerar_fat_contab_w	= 'N'
		and	a.ie_tipo_cobranca in ('1','2')
		and ((x.cd_conta_deb_taxa IS NOT NULL AND x.cd_conta_deb_taxa::text <> '') or (x.cd_conta_deb_provisao IS NOT NULL AND x.cd_conta_deb_provisao::text <> ''))
		group by x.cd_conta_deb_taxa,
			x.cd_conta_deb_provisao
		
union	all

		-- MATERIAL - TAXA DO SERVIÇO
		select	coalesce(x.cd_conta_deb_taxa,x.cd_conta_deb_provisao) cd_conta_deb,
			sum(coalesce(x.vl_administracao,0)) vl_faturado
		from	pls_conta_pos_estab_contab	x,
			pls_conta_pos_estabelecido	w,
			pls_fatura_mat 			a,
			pls_fatura_conta 		b,
			pls_fatura_evento 		c
		where	c.nr_sequencia		= b.nr_seq_fatura_evento
		and	b.nr_sequencia		= a.nr_seq_fatura_conta
		and	w.nr_sequencia		= a.nr_seq_conta_pos_estab
		and	w.nr_sequencia		= x.nr_seq_conta_pos
		and	x.nr_seq_conta_pos	= a.nr_seq_conta_pos_estab
		and	x.nr_seq_lote_fat	= nr_seq_lote_fat_w
		and	c.nr_seq_fatura		= nr_seq_pls_fatura_w
		and	ie_gerar_fat_contab_w	= 'N'
		and	a.ie_tipo_cobranca in ('1','2')
		and ((x.cd_conta_deb_taxa IS NOT NULL AND x.cd_conta_deb_taxa::text <> '') or (x.cd_conta_deb_provisao IS NOT NULL AND x.cd_conta_deb_provisao::text <> ''))
		group by x.cd_conta_deb_taxa,
			x.cd_conta_deb_provisao) alias58
	group by cd_conta_deb;


BEGIN
if (nr_titulo_p IS NOT NULL AND nr_titulo_p::text <> '') then
	-- Obter dados da fatura
	select	max(f.nr_sequencia),
		sum(coalesce(f.vl_fatura,0) + coalesce(f.vl_total_ndc,0)),
		coalesce(coalesce(max(f.dt_emissao),max(l.dt_emissao)),clock_timestamp()),
		max(f.nr_seq_lote),
		max(f.nr_seq_congenere)
	into STRICT	nr_seq_pls_fatura_w,
		vl_faturado_w,
		dt_emissao_w,
		nr_seq_lote_fat_w,
		nr_seq_congenere_w
	from	pls_lote_faturamento	l,
		pls_fatura		f
	where	l.nr_sequencia	= f.nr_seq_lote
	and	f.nr_titulo	= nr_titulo_p;

	if (coalesce(nr_seq_pls_fatura_w::text, '') = '') then
		-- Obter dados da fatura NDR
		select	max(f.nr_sequencia),
			sum(coalesce(f.vl_fatura,0) + coalesce(f.vl_total_ndc,0)),
			coalesce(coalesce(max(f.dt_emissao),max(l.dt_emissao)),clock_timestamp()),
			max(f.nr_seq_lote),
			max(f.nr_seq_congenere)
		into STRICT	nr_seq_pls_fatura_w,
			vl_faturado_w,
			dt_emissao_w,
			nr_seq_lote_fat_w,
			nr_seq_congenere_w
		from	pls_lote_faturamento	l,
			pls_fatura		f
		where	l.nr_sequencia	= f.nr_seq_lote
		and	f.nr_titulo_ndc	= nr_titulo_p;
	end if;

	if (nr_seq_pls_fatura_w IS NOT NULL AND nr_seq_pls_fatura_w::text <> '') then
		nr_seq_camara_w		:= null;
		vl_faturado_classif_w	:= 0;

		if (nr_seq_congenere_w IS NOT NULL AND nr_seq_congenere_w::text <> '') then
			-- Obter câmara da congenere
			select	max(a.nr_seq_camara)
			into STRICT	nr_seq_camara_w
			from	pls_congenere_camara a
			where	a.nr_seq_congenere = nr_seq_congenere_w
			and	dt_emissao_w between a.dt_inicio_vigencia_ref and a.dt_fim_vigencia_ref;

			-- Obter tipo da congenere
			select	max(ie_tipo_congenere)
			into STRICT	ie_tipo_congenere_w
			from	pls_congenere
			where	nr_sequencia = nr_seq_congenere_w;

			-- Obtém se o tipo do congenere é operadora (fundação)
			if (ie_tipo_congenere_w = 'OP') then
				ie_tipo_intercambio_w := 'F'; -- Fundação
			else
				ie_tipo_intercambio_w := pls_obter_tipo_intercambio( nr_seq_congenere_w, cd_estabelecimento_p); -- Nacional ou Estadual
			end if;
		end if;

		-- Obter conta financeira
		cd_conta_financ_w := pls_obter_conta_financ_regra(	'ICR', null, cd_estabelecimento_p, null, null, nr_seq_camara_w, null, null, null, null, null, null, null, null, ie_tipo_intercambio_w, null, null, cd_conta_financ_w);

		select	coalesce(ie_gerar_fat_contab, 'S')
		into STRICT	ie_gerar_fat_contab_w
		from	pls_parametro_faturamento
		where	cd_estabelecimento = cd_estabelecimento_p;

		-- Gerar Classificação do Pós-estabelecido
		open C01;
		loop
		fetch C01 into
			cd_conta_debito_w,
			vl_classificacao_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			select	coalesce(max(nr_sequencia), 0) + 1
			into STRICT	nr_seq_classif_w
			from	titulo_receber_classif
			where	nr_titulo	= nr_titulo_p;

			insert into titulo_receber_classif(nr_titulo,
				nr_sequencia,
				nm_usuario,
				dt_atualizacao,
				cd_conta_contabil,
				vl_original,
				vl_classificacao,
				vl_desconto,
				cd_conta_financ)
			values (nr_titulo_p,
				nr_seq_classif_w,
				nm_usuario_p,
				clock_timestamp(),
				cd_conta_debito_w,
				0,
				vl_classificacao_w,
				0,
				cd_conta_financ_w);

			vl_faturado_classif_w := vl_faturado_classif_w + vl_classificacao_w;
			end;
		end loop;
		close C01;

		vl_faturado_classif_w := vl_faturado_w - vl_faturado_classif_w;

		-- Gerar Classificação da conta financeira
		if (cd_conta_financ_w IS NOT NULL AND cd_conta_financ_w::text <> '') and (vl_faturado_classif_w > 0) then
			select	coalesce(max(nr_sequencia), 0) + 1
			into STRICT	nr_seq_classif_w
			from	titulo_receber_classif
			where	nr_titulo	= nr_titulo_p;

			insert into titulo_receber_classif(nr_titulo,
				nr_sequencia,
				nm_usuario,
				dt_atualizacao,
				cd_conta_financ,
				vl_original,
				vl_classificacao,
				vl_desconto)
			values (nr_titulo_p,
				nr_seq_classif_w,
				nm_usuario_p,
				clock_timestamp(),
				cd_conta_financ_w,
				vl_faturado_classif_w,
				vl_faturado_classif_w,
				0);
		end if;

	end if;

	if (coalesce(ie_commit_p,'N') = 'S') then
		commit;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_tit_rec_class_fat ( nr_titulo_p titulo_receber.nr_titulo%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, ie_commit_p text ) FROM PUBLIC;

