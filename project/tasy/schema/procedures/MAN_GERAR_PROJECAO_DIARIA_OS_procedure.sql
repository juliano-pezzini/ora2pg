-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE OSDia AS (	qt_media_os double precision);


CREATE OR REPLACE PROCEDURE man_gerar_projecao_diaria_os () AS $body$
DECLARE



nr_seq_grupo_des_w		bigint;
nr_seq_gerencia_w		bigint;
nr_sequencia_w			bigint;
nr_seq_posicao_w		bigint;
qt_60_dia_w			bigint;
qt_45_dia_w			bigint;
qt_30_dia_w			bigint;
qt_15_dia_w			bigint;
qt_07_dia_w			bigint;
qt_semana_w			bigint;
qt_os_projeto_w			bigint;
qt_total_w			bigint;
qt_os_antiga_w			bigint;
pr_os_antiga_w			double precision;
nr_seq_localizacao_w		bigint;
ie_controle_diario_w		varchar(1);
ie_tipo_registro_w		smallint;
qt_dia_w			bigint := 0;
dt_projecao_w			timestamp;
qt_media_os_dia_w		bigint;
qt_controle_w			bigint;
cd_dia_w			varchar(20);
qt_dias_w			bigint;
qt_acumulo_semana_w		bigint;
type VetorOS is table of OSDia index by integer;
vt_os_dia_w	vetorOS;

c01 CURSOR FOR
SELECT	a.nr_seq_grupo_des,
	c.nr_sequencia,
	count(*),
	coalesce(sum(CASE WHEN obter_se_ordem_orig_projeto(a.nr_sequencia)='S' THEN 1  ELSE 0 END ),0) qt_projeto,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(clock_timestamp() - interval '60 days','dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_60_dias,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '59 days','dd'), trunc(clock_timestamp() - interval '45 days','dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_45_dias,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '44 days','dd'), trunc(clock_timestamp() - interval '30 days','dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_30_dias,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '29 days','dd'), trunc(clock_timestamp() - interval '15 days','dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_15_dias,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(clock_timestamp() - interval '30 days','dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_tot_os_antiga,
	(dividir(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(clock_timestamp() - interval '30 days','dd'))='S' THEN  1  ELSE 0 END  END ), count(*)) *100) pr_antiga,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '14 days','dd'), trunc(clock_timestamp() - interval '7 days','dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_07_dias,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '6 days','dd'), trunc(clock_timestamp(),'dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_da_semana
from	gerencia_wheb c,
	grupo_desenvolvimento b,
	man_ordem_servico  a
where	b.nr_seq_gerencia	= c.nr_sequencia
and	a.nr_seq_grupo_des	= b.nr_sequencia
and (substr(obter_se_os_pend_cliente(a.nr_sequencia),1,1) = 'N')
and (substr(Obter_Se_OS_Desenv(a.nr_sequencia),1,1) = 'S')
and	a.ie_status_ordem		<> 3
group by c.nr_sequencia,
	a.nr_seq_grupo_des;


c03 CURSOR FOR
SELECT	a.nr_seq_grupo_des,
	c.nr_sequencia,
	count(*),
	coalesce(sum(CASE WHEN obter_se_ordem_orig_projeto(a.nr_sequencia)='S' THEN 1  ELSE 0 END ),0) qt_projeto,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(dt_projecao_w -60,'dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_60_dias,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(dt_projecao_w - 59,'dd'), trunc(dt_projecao_w -45,'dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_45_dias,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(dt_projecao_w - 44,'dd'), trunc(dt_projecao_w -30,'dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_30_dias,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(dt_projecao_w - 29,'dd'), trunc(dt_projecao_w -15,'dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_15_dias,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(dt_projecao_w -30,'dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_tot_os_antiga,
	(dividir(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(dt_projecao_w -30,'dd'))='S' THEN  1  ELSE 0 END  END ), count(*)) *100) pr_antiga,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(dt_projecao_w - 14,'dd'), trunc(dt_projecao_w -7,'dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_07_dias,
	coalesce(sum(CASE WHEN obter_se_ordem_vinc_projeto2(a.nr_sequencia)='S' THEN 0  ELSE CASE WHEN obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(dt_projecao_w - 6,'dd'), trunc(dt_projecao_w,'dd'))='S' THEN  1  ELSE 0 END  END ),0) qt_da_semana
from	gerencia_wheb c,
	grupo_desenvolvimento b,
	man_ordem_servico  a
where	b.nr_seq_gerencia	= c.nr_sequencia
and	a.nr_seq_grupo_des	= b.nr_sequencia
and (substr(obter_se_os_pend_cliente(a.nr_sequencia),1,1) = 'N')
and (substr(Obter_Se_OS_Desenv(a.nr_sequencia),1,1) = 'S')
and	a.ie_status_ordem		<> 3
and	exists (	select	1
		from	man_ordem_ativ_prev x
		where	a.nr_sequencia	= x.nr_seq_ordem_serv
		and	x.dt_prevista	>= trunc(dt_projecao_w))
group by c.nr_sequencia,
	a.nr_seq_grupo_des;


C04 CURSOR FOR
SELECT	nr_sequencia
from	grupo_desenvolvimento
where	ie_situacao = 'A';


/*
select	a.nr_seq_grupo_des,
	count(*),
	nvl(sum(decode(obter_se_ordem_orig_projeto(a.nr_sequencia), 'S',1,0)),0) qt_projeto,
	nvl(sum(decode(obter_se_ordem_vinc_projeto2(a.nr_sequencia),'S',0,decode(obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(sysdate -60,'dd')), 'S', 1, 0))),0) qt_60_dias,
	nvl(sum(decode(obter_se_ordem_vinc_projeto2(a.nr_sequencia),'S',0,decode(obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(sysdate - 59,'dd'), trunc(sysdate -45,'dd')), 'S', 1, 0))),0) qt_45_dias,
	nvl(sum(decode(obter_se_ordem_vinc_projeto2(a.nr_sequencia),'S',0,decode(obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(sysdate - 44,'dd'), trunc(sysdate -30,'dd')), 'S', 1, 0))),0) qt_30_dias,
	nvl(sum(decode(obter_se_ordem_vinc_projeto2(a.nr_sequencia),'S',0,decode(obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(sysdate - 29,'dd'), trunc(sysdate -15,'dd')), 'S', 1, 0))),0) qt_15_dias,
	nvl(sum(decode(obter_se_ordem_vinc_projeto2(a.nr_sequencia),'S',0,decode(obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(sysdate -15,'dd')), 'S', 1, 0))),0) qt_tot_os_antiga,
	(dividir(sum(decode(obter_se_ordem_vinc_projeto2(a.nr_sequencia),'S',0,decode(obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(sysdate -15,'dd')), 'S', 1, 0))), count(*)) *100) pr_antiga,
	nvl(sum(decode(obter_se_ordem_vinc_projeto2(a.nr_sequencia),'S',0,decode(obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(sysdate - 14,'dd'), trunc(sysdate -7,'dd')), 'S', 1, 0))),0) qt_07_dias,
	nvl(sum(decode(obter_se_ordem_vinc_projeto2(a.nr_sequencia),'S',0,decode(obter_se_data_periodo(trunc(a.dt_ordem_servico, 'dd'), trunc(sysdate - 6,'dd'), trunc(sysdate,'dd')), 'S', 1, 0))),0) qt_da_semana
from	w_previsao_futura_os
where	b.nr_seq_gerencia	= c.nr_sequencia
and	a.nr_seq_grupo_des	= b.nr_sequencia
and	(substr(obter_se_os_pend_cliente(a.nr_sequencia),1,1) = 'N')
and	(substr(Obter_Se_OS_Desenv(a.nr_sequencia),1,1) = 'S')
and	a.ie_status_ordem		<> 3
group by c.nr_sequencia,
	a.nr_seq_grupo_des;
*/
BEGIN

/*Gravar posição geral de todas as OS para Wheb*/

BEGIN
/*Deletar os registros de projeção para dias futuros.*/

delete	FROM man_posicao_diaria
where	trunc(dt_atualizacao) = trunc(clock_timestamp())
and	ie_tipo_registro = 4;

EXCEPTION
	WHEN OTHERS THEN
	nr_seq_posicao_w	:= null;
END;
/*
delete w_previsao_futura_os;
*/
commit;

while qt_dia_w < 15 loop
	begin
	qt_dia_w	:= qt_dia_w + 1;
	dt_projecao_w	:= trunc(clock_timestamp() + qt_dia_w);


	select	nextval('man_posicao_diaria_seq')
	into STRICT	nr_seq_posicao_w
	;

	insert into man_posicao_diaria(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_localizacao,
		dt_posicao,
		ie_tipo_registro)
	values (nr_seq_posicao_w,
		clock_timestamp(),
		'Tasy',
		clock_timestamp(),
		'Tasy',
		null,
		dt_projecao_w,
		4);

	cd_dia_w	:= obter_cod_dia_semana(dt_projecao_w);

	if (qt_dia_w = 1) then
		open C01;
		loop
		fetch C01 into
			nr_seq_grupo_des_w,
			nr_seq_gerencia_w,
			qt_total_w,
			qt_os_projeto_w,
			qt_60_dia_w,
			qt_45_dia_w,
			qt_30_dia_w,
			qt_15_dia_w,
			qt_os_antiga_w,
			pr_os_antiga_w,
			qt_07_dia_w,
			qt_semana_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin

			select	nextval('man_posicao_diaria_resumo_seq')
			into STRICT	nr_sequencia_w
			;

			insert into man_posicao_diaria_resumo(
				nr_sequencia,
				nr_seq_posicao,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_gerencia,
				nr_seq_grupo_des,
				qt_60_dia,
				qt_45_dia,
				qt_30_dia,
				qt_15_dia,
				qt_07_dia,
				qt_semana,
				qt_os_projeto,
				qt_total,
				qt_os_antiga,
				pr_os_antiga)
			values (	nr_sequencia_w,
				nr_seq_posicao_w,
				clock_timestamp(),
				'Tasy',
				clock_timestamp(),
				'Tasy',
				nr_seq_gerencia_w,
				nr_seq_grupo_des_w,
				qt_60_dia_w,
				qt_45_dia_w,
				qt_30_dia_w,
				qt_15_dia_w,
				qt_07_dia_w,
				qt_semana_w,
				qt_os_projeto_w,
				qt_total_w,
				qt_os_antiga_w,
				pr_os_antiga_w);
			end;
		end loop;
		close C01;
	else
		open C03;
		loop
		fetch C03 into
			nr_seq_grupo_des_w,
			nr_seq_gerencia_w,
			qt_total_w,
			qt_os_projeto_w,
			qt_60_dia_w,
			qt_45_dia_w,
			qt_30_dia_w,
			qt_15_dia_w,
			qt_os_antiga_w,
			pr_os_antiga_w,
			qt_07_dia_w,
			qt_semana_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin

			select	nextval('man_posicao_diaria_resumo_seq')
			into STRICT	nr_sequencia_w
			;

			insert into man_posicao_diaria_resumo(
				nr_sequencia,
				nr_seq_posicao,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_gerencia,
				nr_seq_grupo_des,
				qt_60_dia,
				qt_45_dia,
				qt_30_dia,
				qt_15_dia,
				qt_07_dia,
				qt_semana,
				qt_os_projeto,
				qt_total,
				qt_os_antiga,
				pr_os_antiga)
			values (	nr_sequencia_w,
				nr_seq_posicao_w,
				clock_timestamp(),
				'Tasy',
				clock_timestamp(),
				'Tasy',
				nr_seq_gerencia_w,
				nr_seq_grupo_des_w,
				qt_60_dia_w,
				qt_45_dia_w,
				qt_30_dia_w,
				qt_15_dia_w,
				qt_07_dia_w,
				qt_semana_w,
				qt_os_projeto_w,
				qt_total_w,
				qt_os_antiga_w,
				pr_os_antiga_w);
			end;
		end loop;
		close C03;
	end if;

	end;
end loop;

open C04;
loop
fetch C04 into
	nr_seq_grupo_des_w;
EXIT WHEN NOT FOUND; /* apply on C04 */
	begin

	qt_dia_w	:= 0;
	while qt_dia_w < 7 loop
		begin
		qt_dia_w	:= qt_dia_w + 1;
		cd_dia_w	:= to_char(qt_dia_w);

		select	count(*)
		into STRICT	qt_media_os_dia_w
		from	man_ordem_servico a
		where	a.dt_ordem_servico between clock_timestamp() - interval '60 days' and clock_timestamp()
		and	obter_cod_dia_semana(dt_ordem_servico) = cd_dia_w
		and	a.nr_seq_grupo_des	= nr_seq_grupo_des_w
		and	exists (	SELECT	1
					from	man_ordem_serv_estagio z,
						man_estagio_processo k
					where	z.nr_seq_ordem		= a.nr_sequencia
					and	z.nr_seq_estagio	= k.nr_sequencia
					and	((k.ie_desenv		= 'S') or (k.ie_tecnologia = 'S')));

		select	count(distinct trunc(dt_ordem_servico))
		into STRICT	qt_dias_w
		from	man_ordem_servico a
		where	a.dt_ordem_servico between clock_timestamp() - interval '60 days' and clock_timestamp()
		and	obter_cod_dia_semana(dt_ordem_servico) = cd_dia_w
		and	a.nr_seq_grupo_des	= nr_seq_grupo_des_w
		and	exists (	SELECT	1
					from	man_ordem_serv_estagio z,
						man_estagio_processo k
					where	z.nr_seq_ordem		= a.nr_sequencia
					and	z.nr_seq_estagio	= k.nr_sequencia
					and	((k.ie_desenv		= 'S') or (k.ie_tecnologia = 'S')));



		vt_os_dia_w[qt_dia_w].qt_media_os	:= round(dividir(qt_media_os_dia_w,qt_dias_w));
		end;
	end loop;


	qt_dia_w	:= 0;
	while qt_dia_w < 15 loop
		begin
		qt_dia_w	:= qt_dia_w + 1;
		dt_projecao_w	:= trunc(clock_timestamp() + qt_dia_w);
		cd_dia_w	:= obter_cod_dia_semana(dt_projecao_w);
	/*
		insert into w_previsao_futura_os(
			nr_seq_grupo_des,
			dt_previsao,
			qt_previsao,
			dt_atualizacao)
		values(	nr_seq_grupo_des_w,
			dt_projecao_w,
			vt_os_dia_w(cd_dia_w).qt_media_os,
			sysdate);
			*/
		end;
	end loop;

	commit;
	end;
end loop;
close C04;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_projecao_diaria_os () FROM PUBLIC;

