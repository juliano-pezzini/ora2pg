-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cp_release_care_plan (nr_seq_prescr_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_atendimento_w	patient_care_plan.nr_atendimento%type;
ie_tipo_w		pe_prescricao.ie_tipo%type;

c_care_plan CURSOR FOR
SELECT	a.nr_sequencia
from	patient_care_plan a
where	a.nr_seq_prescr = nr_seq_prescr_p;
						
BEGIN

if (nr_seq_prescr_p IS NOT NULL AND nr_seq_prescr_p::text <> '') then
	begin
	select	ie_tipo
	into STRICT	ie_tipo_w
	from	pe_prescricao a
	where	a.nr_sequencia = nr_seq_prescr_p;
	exception
		when no_data_found then
		ie_tipo_w	:= null;
	end;
	
	if (ie_tipo_w = 'CP') then
		/* update all ie_situacao where ie_situacao = 'A' */

			
		for r_c_care_plan in c_care_plan loop
			/* update all ie_situacao of current prescription to 'A'  */

			UPDATE	patient_care_plan
			SET 	ie_situacao = 'A'
			WHERE	nr_sequencia = r_c_care_plan.nr_sequencia;

			/* update dt_start if this field is null */
			UPDATE	patient_care_plan
			SET 	dt_start = clock_timestamp()
			WHERE	coalesce(dt_start::text, '') = ''
			and		si_selected = 'Y'
			and		nr_sequencia = r_c_care_plan.nr_sequencia;

			UPDATE	patient_cp_problem
			SET 	dt_start = clock_timestamp()
			WHERE	coalesce(dt_start::text, '') = ''
			and		si_selected = 'Y'
			and		nr_seq_pat_care_plan = r_c_care_plan.nr_sequencia;	

			UPDATE	patient_cp_goal
			SET		dt_start = clock_timestamp()
			WHERE	coalesce(dt_start::text, '') = ''
			and		si_selected = 'Y'
			and		nr_seq_pat_care_plan = r_c_care_plan.nr_sequencia;
		end loop;
		
		UPDATE 	patient_care_plan
		SET 	ie_situacao = 'I'
		WHERE 	ie_situacao = 'A'
		and		nr_atendimento = nr_atendimento_w
		and		nr_seq_prescr  <> nr_seq_prescr_p;
		
		/* update dt_liberacao_plano */

		UPDATE	pe_prescricao
		SET 	dt_liberacao_plano = clock_timestamp()
		WHERE	nr_sequencia = nr_seq_prescr_p;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cp_release_care_plan (nr_seq_prescr_p bigint, nm_usuario_p text) FROM PUBLIC;

