-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_tit_rec_contestacao (nr_seq_lote_contest_p bigint, dt_vencimento_p timestamp, nm_usuario_p text) AS $body$
DECLARE


nr_titulo_w		bigint;
vl_contestado_w		double precision;
vl_procedimento_w	double precision;
vl_material_w		double precision;
nr_seq_ptu_fatura_w	bigint;
cd_unimed_destino_w	varchar(4);
cd_cgc_w		varchar(14);
cd_estabelecimento_w	smallint;
cd_moeda_w		integer;
cd_portador_w		bigint;
cd_tipo_portador_w	integer;
cd_tipo_taxa_juro_w	bigint;
cd_tipo_taxa_multa_w	bigint;
pr_juro_padrao_w	double precision;
pr_multa_padrao_w	double precision;
ie_gerar_titulo_w	varchar(2);
dt_vencimento_w		timestamp;


BEGIN
select	max(nr_seq_ptu_fatura)
into STRICT	nr_seq_ptu_fatura_w
from	pls_lote_contestacao
where	nr_sequencia = nr_seq_lote_contest_p;

if (nr_seq_ptu_fatura_w IS NOT NULL AND nr_seq_ptu_fatura_w::text <> '') then
	select	max(cd_unimed_destino)
	into STRICT	cd_unimed_destino_w
	from	ptu_fatura
	where	nr_sequencia = nr_seq_ptu_fatura_w;

	select	max(b.cd_cgc)
	into STRICT	cd_cgc_w
	from	pessoa_juridica	b,
		pls_congenere	a
	where	a.cd_cgc	 = b.cd_cgc
	and	(a.cd_cooperativa)::numeric  = (cd_unimed_destino_w)::numeric;

	dt_vencimento_w	:= trunc(dt_vencimento_p,'dd');

	select	coalesce(sum(a.vl_contestado),0) /*Valor total dos procedimentos */
	into STRICT	vl_procedimento_w
	from	pls_lote_contestacao 	c,
		pls_contestacao 	b,
		pls_contestacao_proc	a
	where	c.nr_sequencia		= nr_seq_lote_contest_p
	and	b.nr_seq_lote		= c.nr_sequencia
	and	a.nr_seq_contestacao	= b.nr_sequencia;

	select	coalesce(sum(a.vl_contestado),0) /* Valor total dos materiais */
	into STRICT	vl_material_w
	from	pls_lote_contestacao 	c,
		pls_contestacao 	b,
		pls_contestacao_mat	a
	where	c.nr_sequencia		= nr_seq_lote_contest_p
	and	b.nr_seq_lote		= c.nr_sequencia
	and	a.nr_seq_contestacao	= b.nr_sequencia;

	vl_contestado_w := coalesce(vl_procedimento_w,0) + coalesce(vl_material_w,0);

	/*select	pls_consistir_gerar_tit_rec(nr_seq_ptu_fatura_w)
	into	ie_gerar_titulo_w
	from 	dual;*/
	/* Só gerar se teve valor contestado e o título a pagar já está liquidado (tratamento na function pls_consistir_gerar_tit_rec */

	if (vl_contestado_w > 0) then

		select	max(d.cd_estabelecimento),
			max(c.cd_moeda_padrao),
			max(c.cd_portador),
			max(c.cd_tipo_portador),
			max(c.cd_tipo_taxa_juro),
			max(c.cd_tipo_taxa_multa),
			max(c.pr_juro_padrao),
			max(c.pr_multa_padrao)
		into STRICT	cd_estabelecimento_w,
			cd_moeda_w,
			cd_portador_w,
			cd_tipo_portador_w,
			cd_tipo_taxa_juro_w,
			cd_tipo_taxa_multa_w,
			pr_juro_padrao_w,
			pr_multa_padrao_w
		from	estabelecimento 		d,
			parametro_contas_receber 	c,
			pls_lote_contestacao 		b,
			pls_contestacao 		a
		where	b.nr_sequencia		= nr_seq_lote_contest_p
		and	a.nr_seq_lote		= b.nr_sequencia
		and	b.cd_estabelecimento	= c.cd_estabelecimento
		and	c.cd_estabelecimento	= d.cd_estabelecimento;

		select	nextval('titulo_seq')
		into STRICT	nr_titulo_w
		;

		insert	into titulo_receber(cd_cgc,
			cd_estabelecimento,
			cd_moeda,
			cd_portador,
			cd_tipo_portador,
			cd_tipo_taxa_juro,
			cd_tipo_taxa_multa,
			dt_atualizacao,
			dt_emissao,
			dt_pagamento_previsto,
			dt_vencimento,
			ie_origem_titulo,
			ie_situacao,
			ie_tipo_emissao_titulo,
			ie_tipo_inclusao,
			ie_tipo_titulo,
			nm_usuario,
			nr_titulo,
			tx_desc_antecipacao,
			tx_juros,
			tx_multa,
			vl_saldo_juros,
			vl_saldo_multa,
			vl_saldo_titulo,
			vl_titulo,
			nr_seq_pls_lote_contest,
			ds_observacao_titulo,
			nr_documento,
			nr_lote_contabil,
			nm_usuario_orig,
			dt_inclusao,
			nr_seq_ptu_fatura)
		values (cd_cgc_w,
			cd_estabelecimento_w,
			cd_moeda_w,
			cd_portador_w,
			cd_tipo_portador_w,
			cd_tipo_taxa_juro_w,
			cd_tipo_taxa_multa_w,
			clock_timestamp(),
			trunc(clock_timestamp(),'dd'),
			dt_vencimento_w,
			dt_vencimento_w,
			'11', --Contestação
			'1',
			1,
			'2',
			'13',
			nm_usuario_p,
			nr_titulo_w,
			0,
			pr_juro_padrao_w,
			pr_multa_padrao_w,
			0,
			0,
			vl_contestado_w,
			vl_contestado_w,
			nr_seq_lote_contest_p,
			'Título gerado pela função OPS - Controle de Contestações e Recursos de Glosa',
			nr_titulo_w,
			0,
			nm_usuario_p,
			clock_timestamp(),
			nr_seq_ptu_fatura_w);
	end if;
else
	CALL wheb_mensagem_pck.exibir_mensagem_abort(189145);
end if;

--commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_tit_rec_contestacao (nr_seq_lote_contest_p bigint, dt_vencimento_p timestamp, nm_usuario_p text) FROM PUBLIC;

