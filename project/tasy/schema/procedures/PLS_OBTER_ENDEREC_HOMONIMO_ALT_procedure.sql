-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_enderec_homonimo_alt ( cd_cep_p text, ds_endereco_p text, ds_bairro_p text, cd_municipio_ibge_p text, ds_municipio_p text, sg_estado_p text, ds_endereco_out_p INOUT text, ds_bairro_out_p INOUT text, cd_municipio_ibge_out_p INOUT text, ds_municipio_out_p INOUT text, sg_estado_out_p INOUT text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_registros_w		bigint;
ie_origem_cep_w		varchar(10);
cd_cep_w		varchar(255);
ds_endereco_w		varchar(255);
ds_bairro_w		varchar(255);
cd_municipio_ibge_w	varchar(255);
ds_municipio_w		varchar(255);
sg_estado_w		cep_logradouro.cd_unidade_federacao%type;


BEGIN

if ((trim(both cd_cep_p) IS NOT NULL AND (trim(both cd_cep_p))::text <> '')) then
	ie_origem_cep_w	:= coalesce(obter_valor_param_usuario(0, 25, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_p), 'N');

	if (ie_origem_cep_w = 'S') then
		select	count(1)
		into STRICT	qt_registros_w
		from	cep_logradouro
		where	cd_logradouro	= cd_cep_p  LIMIT 1;

		if (qt_registros_w = 0) then
			ds_endereco_out_p	:= ds_endereco_p;
			ds_bairro_out_p		:= ds_bairro_p;
			cd_municipio_ibge_out_p	:= cd_municipio_ibge_p;
			ds_municipio_out_p	:= ds_municipio_p;
			sg_estado_out_p		:= sg_estado_p;

			goto final;
		end if;

		select	nm_logradouro,
			nm_localidade,
			nm_bairro,
			cd_unidade_federacao
		into STRICT	ds_endereco_w,
			ds_municipio_w,
			ds_bairro_w,
			sg_estado_w
		from	cep_logradouro
		where	cd_logradouro	= cd_cep_p  LIMIT 1;

	elsif (ie_origem_cep_w = 'N') then

		select	count(1)
		into STRICT	qt_registros_w
		from	cep_loc b,
			cep_bairro c,
			cep_log a
		where	b.nr_sequencia      = c.nr_seq_loc
		and	a.cd_bairro_inicial = c.nr_sequencia
		and	b.nr_sequencia      = a.nr_seq_loc
		and	a.cd_cep            = cd_cep_p  LIMIT 1;

		if (qt_registros_w = 0) then
			ds_endereco_out_p	:= ds_endereco_p;
			ds_bairro_out_p		:= ds_bairro_p;
			cd_municipio_ibge_out_p	:= cd_municipio_ibge_p;
			ds_municipio_out_p	:= ds_municipio_p;
			sg_estado_out_p		:= sg_estado_p;
			goto final;
		end if;

		select	a.nm_logradouro,
			b.nm_localidade,
			c.ds_bairro,
			a.ds_uf
		into STRICT	ds_endereco_w,
			ds_municipio_w,
			ds_bairro_w,
			sg_estado_w
		from	cep_loc b,
			cep_bairro c,
			cep_log a
		where	b.nr_sequencia      = c.nr_seq_loc
		and	a.cd_bairro_inicial = c.nr_sequencia
		and	b.nr_sequencia      = a.nr_seq_loc
		and	a.cd_cep            = cd_cep_p  LIMIT 1;

	end if;

	select	max(cd_municipio_ibge)
	into STRICT	cd_municipio_ibge_w
	from (SELECT	cd_municipio_ibge
		from	cep_municipio
		where	cd_cep = cd_cep_p
		
union

		SELECT	cd_municipio_ibge
		from	sus_cep
		where	cd_cep = cd_cep_p) alias1;

	ds_endereco_out_p	:= ds_endereco_w;
	ds_bairro_out_p		:= ds_bairro_w;
	cd_municipio_ibge_out_p	:= cd_municipio_ibge_w;
	ds_municipio_out_p	:= ds_municipio_w;
	sg_estado_out_p		:= sg_estado_w;
end if;

<<final>>
ds_endereco_w	:= 'X';

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_enderec_homonimo_alt ( cd_cep_p text, ds_endereco_p text, ds_bairro_p text, cd_municipio_ibge_p text, ds_municipio_p text, sg_estado_p text, ds_endereco_out_p INOUT text, ds_bairro_out_p INOUT text, cd_municipio_ibge_out_p INOUT text, ds_municipio_out_p INOUT text, sg_estado_out_p INOUT text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

