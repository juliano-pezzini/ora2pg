-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pfcs_gerar_result_posit_covid (cd_estabelecimento_p bigint) AS $body$
DECLARE


C01 CURSOR FOR
   SELECT   distinct  
	     e.ds_resultado,    
		 a.nr_atendimento,
        'C' ie_result_compl
   FROM  atendimento_paciente a,
		 exame_lab_resultado d,
		 exame_lab_result_item e
   WHERE a.nr_atendimento = d.nr_atendimento
      AND d.nr_seq_resultado = e.nr_seq_resultado
      AND ((e.dt_aprovacao IS NOT NULL AND e.dt_aprovacao::text <> '') or (e.dt_liberacao IS NOT NULL AND e.dt_liberacao::text <> ''))
	  and PFCS_LAB_OBTER_SE_EXAME_COVID(e.nr_seq_exame) = 'S'
	  and a.cd_estabelecimento = cd_estabelecimento_p
	  and (e.ds_resultado IS NOT NULL AND e.ds_resultado::text <> '')
	  and not exists (SELECT 1 from atend_paciente_adic t where t.nr_atendimento = a.nr_atendimento and (t.ie_atend_covid_posit IS NOT NULL AND t.ie_atend_covid_posit::text <> ''))

union
	
  SELECT  distinct  
	     a.ds_resultado,    
		 b.nr_atendimento,
         'R' ie_result_compl
  FROM
	 paciente_exame a,
	 atendimento_paciente b
  WHERE
	 a.ie_exame_pac = 'COVID-19' 
	 AND (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
	 AND coalesce(a.dt_inativacao::text, '') = ''
	 AND (a.ds_resultado IS NOT NULL AND a.ds_resultado::text <> '')
	 AND a.cd_pessoa_fisica = b.cd_pessoa_fisica
	 and a.nr_sequencia = (select max(t.nr_sequencia) from paciente_exame t where a.cd_pessoa_fisica = t.cd_pessoa_fisica  and  t.ie_exame_pac = 'COVID-19' )
	 and b.cd_estabelecimento = cd_estabelecimento_p
	 and not exists (select 1 from atend_paciente_adic t where t.nr_atendimento = b.nr_atendimento and (t.ie_atend_covid_posit IS NOT NULL AND t.ie_atend_covid_posit::text <> ''));
	 	

BEGIN

for c01_w in c01 loop
	begin
		
		if ((substr(upper(c01_w.ds_resultado),1,7)) like(substr(upper(OBTER_DESC_EXPRESSAO(296109)),1,7))) then 
		--	Raise_application_error(-20011,'#@#@'||upper(:new.ds_resultado)||' - '||upper(OBTER_DESC_EXPRESSAO(296109))||' - '||nr_seq_atend_inf_w);
			insert into ATEND_PACIENTE_ADIC(	nr_sequencia,
													dt_atualizacao,
													nm_usuario,
													nr_atendimento,
													ie_atend_covid_posit)
			values (nextval('atend_paciente_adic_seq'),clock_timestamp(),'CovidUpdate'||c01_w.ie_result_compl,c01_w.nr_atendimento,'S');
		else
		--	Raise_application_error(-20011,'#@#@'||upper(:new.ds_resultado)||' - '||upper(OBTER_DESC_EXPRESSAO(296109))||' - '||nr_seq_atend_inf_w);
			insert into ATEND_PACIENTE_ADIC(	nr_sequencia,
													dt_atualizacao,
													nm_usuario,
													nr_atendimento,
													ie_atend_covid_posit)
			values (nextval('atend_paciente_adic_seq'),clock_timestamp(),'CovidUpdate'||c01_w.ie_result_compl,c01_w.nr_atendimento,'N');
		
		end if;
	commit;
	end;
end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_gerar_result_posit_covid (cd_estabelecimento_p bigint) FROM PUBLIC;

