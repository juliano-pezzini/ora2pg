-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_analise_recalcular_fat ( nr_seq_analise_p bigint, nr_seq_item_p bigint, ie_tipo_item_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
/* 
Diego 24/05/2011 - OS 319477 
Esta rotina tem o propósito de recalcular os valores de pagamento de um determinado item na análise. 
Estes valores serão recalculados na conta médica e após este processo serão atualizados na análise. 
 
 
Parâmetros: 
nr_seq_analise_p	Sequencia númerica da análise 
nr_seq_item_p	Sequencia das tabelas pls_conta_proc ou pls_conta_mat 
ie_tipo_item_p	P (Procedimentos) 	-	M (Material) 
*/
 
 
nr_seq_conta_w			bigint;
ie_tipo_item_w			varchar(2);
ie_tipo_despesa_w		varchar(10);
ie_pos_estab_faturamento_w	pls_parametros.ie_pos_estab_faturamento%type;
ie_geracao_pos_estabelecido_w	pls_parametros.ie_geracao_pos_estabelecido%type;
dados_regra_preco_proc_w	pls_cta_valorizacao_pck.dados_regra_preco_proc;
dados_regra_preco_material_w	pls_cta_valorizacao_pck.dados_regra_preco_material;

BEGIN
 
begin 
	select coalesce(max(ie_pos_estab_faturamento),'N'), 
		coalesce(max(ie_geracao_pos_estabelecido),'F') 
	into STRICT	ie_pos_estab_faturamento_w, 
		ie_geracao_pos_estabelecido_w 
	from	pls_parametros 
	where	cd_estabelecimento	= cd_estabelecimento_p;
exception 
when others then 
	ie_pos_estab_faturamento_w	:= 'N';
	ie_geracao_pos_estabelecido_w	:= 'F';
end;
 
ie_tipo_item_w	:= substr(ie_tipo_item_p, 1, 1);
 
if (ie_tipo_item_w = 'P') then 
	select	nr_seq_conta, 
		ie_tipo_despesa 
	into STRICT	nr_seq_conta_w, 
		ie_tipo_despesa_w 
	from	pls_conta_proc 
	where	nr_sequencia = nr_seq_item_p;
 
	dados_regra_preco_proc_w := pls_atualiza_valor_proc_co(nr_seq_item_p, ie_tipo_despesa_w, 'S', ie_pos_estab_faturamento_w, ie_geracao_pos_estabelecido_w, nm_usuario_p, dados_regra_preco_proc_w);
elsif (ie_tipo_item_w = 'M') then 
	select	max(nr_seq_conta) 
	into STRICT	nr_seq_conta_w 
	from	pls_conta_mat 
	where	nr_sequencia = nr_seq_item_p;
 
	dados_regra_preco_material_w := pls_atualiza_valor_mat_co(nr_seq_item_p, 'S', ie_pos_estab_faturamento_w, ie_geracao_pos_estabelecido_w, nm_usuario_p, dados_regra_preco_material_w);
end if;
 
/*Atualizar os valores da análise*/
 
CALL pls_atualizar_valores_analise(nr_seq_conta_w, nm_usuario_p, cd_estabelecimento_p);
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_analise_recalcular_fat ( nr_seq_analise_p bigint, nr_seq_item_p bigint, ie_tipo_item_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

