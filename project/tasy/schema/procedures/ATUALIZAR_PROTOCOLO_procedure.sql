-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_protocolo ( CD_PROTOCOLO_P bigint, NR_SEQUENCIA_P bigint, NR_SEQ_PAC_P bigint, nm_usuario_p text) AS $body$
DECLARE

				
cd_convenio_w			bigint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
nr_seq_proc_w			bigint;
nr_seq_proc_ww			bigint;				
qt_procedimento_w		bigint;
qt_material_proc_w		bigint;
nr_seq_material_w		bigint;
nr_seq_soluc_w			bigint;
nr_seq_solucao_ww		bigint;
ds_dias_aplicacao_w		varchar(4000);
nr_seq_mat_w			bigint;
qt_medic_w			bigint;
cd_estabelecimento_w		smallint;
cd_pessoa_fisica_w		numeric(20);
qt_material_proc_ww		bigint;
nr_seq_material_ww		bigint;
nr_agrupamento_w		bigint;
nr_seq_material_dilu_w  	bigint;
				
C01 CURSOR FOR
	SELECT	*
	from	PROTOCOLO_MEDIC_PROC
	where	CD_PROTOCOLO = CD_PROTOCOLO_P
	AND	NR_SEQUENCIA = NR_SEQUENCIA_P
	and	(DS_DIAS_APLICACAO IS NOT NULL AND DS_DIAS_APLICACAO::text <> '');
	
c01_w c01%rowtype;

C02 CURSOR FOR
	SELECT	*
	from	protocolo_medic_material
	where	cd_protocolo = cd_protocolo_p
	and	nr_sequencia = nr_sequencia_p
	and	coalesce(nr_seq_diluicao::text, '') = ''
	and	ie_agrupador = 5
	and	nr_seq_proc = nr_seq_proc_w;

c02_w c02%rowtype;		

C03 CURSOR FOR
	SELECT 	*
	from	protocolo_medic_solucao
	where	cd_protocolo = cd_protocolo_p
	and	nr_sequencia = nr_sequencia_p
	and	(ds_dias_aplicacao IS NOT NULL AND ds_dias_aplicacao::text <> '')
	order by NR_SEQ_SOLUCAO;
	
c03_w c03%rowtype;	

C04 CURSOR FOR
	SELECT 	NR_SEQ_PAC_P,
		B.NR_SEQ_MATERIAL, 
		B.CD_MATERIAL,
		B.QT_DOSE,
		B.CD_UNIDADE_MEDIDA,
		coalesce(B.DS_DIAS_APLICACAO, A.DS_DIAS_APLICACAO) ds_dias_aplicacao,
		NM_USUARIO_P,
		B.NR_AGRUPAMENTO,
		B.DS_RECOMENDACAO,
		B.IE_VIA_APLICACAO,
		B.NR_SEQ_SOLUCAO,
		B.QT_MINUTO_APLICACAO,
		B.IE_BOMBA_INFUSAO,
		B.CD_INTERVALO,
		B.QT_HORA_APLICACAO,
		B.QT_DIAS_UTIL,
		B.IE_SE_NECESSARIO,
		B.IE_APLIC_LENTA,         
		B.IE_URGENCIA,            
		B.IE_APLIC_BOLUS,
		b.ie_pre_medicacao,
		coalesce(IE_APLICA_REDUCAO,'S') IE_APLICA_REDUCAO
	FROM 	PROTOCOLO_MEDIC_MATERIAL B,
		PROTOCOLO_MEDIC_SOLUCAO A
	WHERE 	A.CD_PROTOCOLO = CD_PROTOCOLO_P
	  AND	A.NR_SEQUENCIA = NR_SEQUENCIA_P
	  AND 	A.CD_PROTOCOLO = B.CD_PROTOCOLO
	  AND 	A.NR_SEQUENCIA = B.NR_SEQUENCIA
	  AND 	B.NR_SEQ_SOLUCAO = A.NR_SEQ_SOLUCAO
	  and	(a.DS_DIAS_APLICACAO IS NOT NULL AND a.DS_DIAS_APLICACAO::text <> '')
	  and	b.nr_seq_solucao = nr_seq_solucao_ww
	  AND	B.IE_AGRUPADOR IN (4)
	  AND	'S' = OBTER_PERMICAO_CONV_MEDIC(cd_convenio_w,b.nr_sequencia,b.cd_protocolo,b.nr_seq_material);

c04_w c04%rowtype;

C05 CURSOR FOR
	SELECT	*
	from	protocolo_medic_material
	where	cd_protocolo = cd_protocolo_p
	and	nr_sequencia = nr_sequencia_p
	and	coalesce(nr_seq_diluicao::text, '') = ''
	and	(ds_dias_aplicacao IS NOT NULL AND ds_dias_aplicacao::text <> '')
	and       	(qt_dose IS NOT NULL AND qt_dose::text <> '')
	and	ie_agrupador = 1;

c05_w c05%rowtype;	

C06 CURSOR FOR
	SELECT	*
	from	protocolo_medic_material
	where	cd_protocolo = cd_protocolo_p
	and	nr_sequencia = nr_sequencia_p
	and	nr_seq_diluicao = nr_seq_material_ww
	and	(ds_dias_aplicacao IS NOT NULL AND ds_dias_aplicacao::text <> '')
	and 	(qt_dose IS NOT NULL AND qt_dose::text <> '')
	and	ie_agrupador = 3;

c06_w c06%rowtype;		
			

BEGIN

select	coalesce(max(cd_estabelecimento),0),
		max(cd_pessoa_fisica)
into STRICT	cd_estabelecimento_w,
	cd_pessoa_fisica_w
from	paciente_setor
where	nr_seq_paciente = nr_seq_pac_p;

select 	max(a.cd_convenio)
into STRICT	cd_convenio_w
from	paciente_setor_convenio a,
	paciente_setor b
where 	b.cd_protocolo		= cd_protocolo_p
and   	b.cd_pessoa_fisica      = cd_pessoa_fisica_w
and   	a.nr_seq_paciente 	= b.nr_seq_paciente;

open C01;
loop
fetch C01 into	
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	nr_seq_proc_ww	:= null;
	cd_procedimento_w	:= c01_w.cd_procedimento;
	ie_origem_proced_w	:= c01_w.ie_origem_proced;
	
	if (c01_w.nr_seq_proc_interno IS NOT NULL AND c01_w.nr_seq_proc_interno::text <> '') then
		SELECT * FROM obter_proc_tab_interno(	c01_w.nr_seq_proc_interno, null, null, null, cd_procedimento_w, ie_origem_proced_w, null, null) INTO STRICT cd_procedimento_w, ie_origem_proced_w;
					
		
	end if;
	
	select	count(*)
	into STRICT	qt_procedimento_w
	from	paciente_protocolo_proc
	where	cd_procedimento = cd_procedimento_w
	and	ie_origem_proced = ie_origem_proced_w
	and	nr_seq_paciente = nr_seq_pac_p;
	
	
	if (qt_procedimento_w = 0) then
		select	coalesce(max(nr_seq_procedimento),0) +1
		into STRICT	nr_seq_proc_ww
		from	PACIENTE_PROTOCOLO_PROC
		where	nr_seq_paciente	= NR_SEQ_PAC_P;
		
		insert into PACIENTE_PROTOCOLO_PROC(
			NR_SEQ_PACIENTE,
			NR_SEQ_PROCEDIMENTO,
			CD_PROCEDIMENTO,
			IE_ORIGEM_PROCED,
			QT_PROCEDIMENTO,      
			DS_DIAS_APLICACAO,
			DT_ATUALIZACAO,     
			NM_USUARIO,        
			DT_ATUALIZACAO_NREC,
			CD_INTERVALO,   
			NM_USUARIO_NREC,
			NR_AGRUPAMENTO,
			IE_SE_NECESSARIO,
			IE_ACM,      
			NR_SEQ_PROC_INTERNO,
			IE_LADO,
			cd_protocolo_adic,
			NR_SEQ_MEDICACAO_ADIC)
		values (NR_SEQ_PAC_P,
			nr_seq_proc_ww,
			cd_procedimento_w,
			ie_origem_proced_w,
			c01_w.qt_procedimento,
			c01_w.DS_DIAS_APLICACAO,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			c01_w.cd_intervalo,
			nm_usuario_p,
			c01_w.nr_seq_proc,
			c01_w.ie_se_necessario,
			c01_w.ie_acm,
			c01_w.nr_seq_proc_interno,
			c01_w.ie_lado,
			CD_PROTOCOLO_P,
			NR_SEQUENCIA_P);
		
	
	end if;	
	
	nr_seq_proc_w	:= c01_w.nr_seq_proc;
	
	
	open C02;
	loop
	fetch C02 into	
		c02_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		
		
		if (coalesce(nr_seq_proc_ww::text, '') = '') then
			select	max(nr_seq_procedimento)
			into STRICT	nr_seq_proc_ww
			from	paciente_protocolo_proc
			where	cd_procedimento = cd_procedimento_w
			and	ie_origem_proced = ie_origem_proced_w
			and	nr_seq_paciente = nr_seq_pac_p;
		end if;
		
		select	count(*)
		into STRICT	qt_material_proc_w
		from	paciente_protocolo_medic
		where	cd_material = c02_w.cd_material
		and	nr_Seq_paciente = nr_seq_pac_p
		and	nr_seq_procedimento	= nr_seq_proc_ww;
		
		

		
		if (qt_material_proc_w = 0) then
		
			select	coalesce(max(nr_seq_material),0) + 1
			into STRICT	nr_seq_material_w
			from	paciente_protocolo_medic
			where	nr_seq_paciente = nr_seq_pac_p;
			
			insert into paciente_protocolo_medic(
				nr_seq_paciente, 
				nr_seq_material, 
				nr_seq_medicacao,
				cd_material, 
				qt_dose,
				cd_unidade_medida, 
				ds_dias_aplicacao, 
				dt_atualizacao, 
				nm_usuario, 
				nr_agrupamento, 
				ie_bomba_infusao, 
				nr_seq_interno,
				ie_via_aplicacao,
				cd_intervalo,
				ds_recomendacao,
				nr_seq_procedimento,
				ie_agrupador,
				qt_dias_receita)
			values (nr_seq_pac_p,
				nr_seq_material_w,
				nr_sequencia_p,
				c02_w.cd_material,
				c02_w.qt_dose,
				c02_w.cd_unidade_medida,
				c01_w.ds_dias_aplicacao,
				clock_timestamp(),
				nm_usuario_p,
				c02_w.nr_agrupamento, 
				c02_w.ie_bomba_infusao, 
				nextval('paciente_protocolo_medic_seq'),
				c02_w.ie_via_aplicacao,
				c02_w.cd_intervalo,
				substr(c02_w.ds_recomendacao,1,2000),
				nr_seq_proc_ww,
				c02_w.ie_agrupador,
				c02_w.qt_dias_receita);
		end if;	
		end;
	end loop;
	close C02;

	end;
end loop;
close C01;

open C03;
loop
fetch C03 into	
	c03_w;
EXIT WHEN NOT FOUND; /* apply on C03 */
	begin
		
	delete
	from paciente_protocolo_soluc
	where nr_seq_paciente     = nr_seq_pac_p
	and cd_protocolo_adic     = cd_protocolo_p
	and ds_solucao		  = coalesce(c03_w.ds_solucao,c03_w.ds_rotina)
	and nr_seq_medicacao_adic = nr_sequencia_p;
	
	select	coalesce(max(nr_seq_solucao),0) + 1
	into STRICT	nr_seq_soluc_w
	from	paciente_protocolo_soluc
	where	nr_seq_paciente = nr_seq_pac_p;
	
	INSERT INTO PACIENTE_PROTOCOLO_SOLUC(
			NR_SEQ_PACIENTE, 
			NR_SEQ_SOLUCAO, 
			NR_AGRUPAMENTO, 
			DS_DIAS_APLICACAO, 
			DT_ATUALIZACAO, 
			NM_USUARIO, 
			DT_ATUALIZACAO_NREC, 
			NM_USUARIO_NREC, 
			IE_TIPO_DOSAGEM, 
			QT_DOSAGEM, 
			QT_SOLUCAO_TOTAL, 
			QT_TEMPO_APLICACAO, 
			NR_ETAPAS, 
			IE_BOMBA_INFUSAO, 
			IE_ESQUEMA_ALTERNADO, 
			IE_CALC_AUT, 
			IE_ACM, 
			QT_HORA_FASE, 
			DS_SOLUCAO, 
			DS_ORIENTACAO, 
			IE_SE_NECESSARIO, 
			IE_SOLUCAO_PCA, 
			IE_TIPO_ANALGESIA, 
			IE_PCA_MODO_PROG, 
			QT_DOSE_INICIAL_PCA, 
			QT_VOL_INFUSAO_PCA, 
			QT_BOLUS_PCA, 
			QT_INTERVALO_BLOQUEIO, 
			QT_LIMITE_QUATRO_HORA, 
			QT_DOSE_ATAQUE, 
			IE_TIPO_SOL,
			DS_CICLOS_APLICACAO,
			cd_protocolo_adic,
			nr_seq_medicacao_adic,
			ie_pre_medicacao,
			cd_intervalo) 
		values (NR_SEQ_PAC_P,
			nr_seq_soluc_w, 
			c03_w.NR_AGRUPAMENTO, 
			c03_w.DS_DIAS_APLICACAO, 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			c03_w.IE_TIPO_DOSAGEM, 
			c03_w.QT_DOSAGEM, 
			c03_w.QT_SOLUCAO_TOTAL, 
			c03_w.QT_TEMPO_APLICACAO, 
			c03_w.NR_ETAPAS, 
			c03_w.IE_BOMBA_INFUSAO, 
			c03_w.IE_ESQUEMA_ALTERNADO, 
			c03_w.IE_CALC_AUT, 
			c03_w.IE_ACM, 
			c03_w.QT_HORA_FASE, 
			c03_w.DS_SOLUCAO, 
			c03_w.DS_ORIENTACAO, 
			c03_w.IE_SE_NECESSARIO, 
			c03_w.IE_SOLUCAO_PCA, 
			c03_w.IE_TIPO_ANALGESIA, 
			c03_w.IE_PCA_MODO_PROG, 
			c03_w.QT_DOSE_INICIAL_PCA, 
			c03_w.QT_VOL_INFUSAO_PCA, 
			c03_w.QT_BOLUS_PCA, 
			c03_w.QT_INTERVALO_BLOQUEIO, 
			c03_w.QT_LIMITE_QUATRO_HORA, 
			c03_w.QT_DOSE_ATAQUE, 
			c03_w.IE_TIPO_SOL,
			c03_w.DS_CICLOS_APLICACAO,
			CD_PROTOCOLO_P,
			NR_SEQUENCIA_P,
			c03_w.ie_pre_medicacao,
			c03_w.cd_intervalo);
			
			nr_seq_solucao_ww	:=	c03_w.nr_seq_solucao;
			

			
			open C04;
			loop
			fetch C04 into	
				c04_w;
			EXIT WHEN NOT FOUND; /* apply on C04 */
				begin
				
				select	count(*)
				into STRICT	qt_medic_w
				from	PACIENTE_PROTOCOLO_MEDIC
				where	cd_material = c04_w.cd_material
				and	nr_seq_material = c04_w.NR_SEQ_MATERIAL
				and	nr_seq_paciente = nr_seq_pac_p;


				if (qt_medic_w = 0) then
				
					select	coalesce(max(NR_SEQ_MATERIAL),0) + 1
					into STRICT	nr_seq_mat_w
					from	PACIENTE_PROTOCOLO_MEDIC
					where	nr_seq_paciente = nr_seq_pac_p;
					
						INSERT INTO PACIENTE_PROTOCOLO_MEDIC(
							NR_SEQ_PACIENTE,
							NR_SEQ_MATERIAL,
							CD_MATERIAL,
							qt_dose,
							CD_UNIDADE_MEDIDA,
							DS_DIAS_APLICACAO,
							DT_ATUALIZACAO,
							NM_USUARIO,
							NR_AGRUPAMENTO,
							DS_RECOMENDACAO,
							IE_VIA_APLICACAO,
							NR_SEQ_SOLUCAO,
							QT_MIN_APLICACAO,
							IE_BOMBA_INFUSAO,
							CD_INTERVALO,
							QT_HORA_APLICACAO,
							QT_DIAS_UTIL,
							NR_SEQ_INTERNO,
							IE_SE_NECESSARIO,
							IE_APLIC_LENTA,
							IE_URGENCIA,            
							IE_APLIC_BOLUS,
							ie_pre_medicacao,
							IE_APLICA_REDUCAO)
						values (NR_SEQ_PAC_P, 
							nr_seq_mat_w, 
							c04_w.CD_MATERIAL,
							c04_w.QT_DOSE,
							c04_w.CD_UNIDADE_MEDIDA,
							c04_w.DS_DIAS_APLICACAO,--NVL(B.DS_DIAS_APLICACAO, A.DS_DIAS_APLICACAO),
							clock_timestamp(),
							NM_USUARIO_P,
							c04_w.NR_AGRUPAMENTO,
							substr(c04_w.DS_RECOMENDACAO,1,2000),
							c04_w.IE_VIA_APLICACAO,
							nr_seq_soluc_w,
							c04_w.QT_MINUTO_APLICACAO,
							c04_w.IE_BOMBA_INFUSAO,
							c04_w.CD_INTERVALO,
							c04_w.QT_HORA_APLICACAO,
							c04_w.QT_DIAS_UTIL,
							nextval('paciente_protocolo_medic_seq'),
							c04_w.IE_SE_NECESSARIO,
							c04_w.IE_APLIC_LENTA,         
							c04_w.IE_URGENCIA,            
							c04_w.IE_APLIC_BOLUS,
							c04_w.ie_pre_medicacao,
							coalesce(c04_w.IE_APLICA_REDUCAO,'S'));
				end if;
				end;
			end loop;
			close C04;			

	end;
end loop;
close C03;


open C05;
loop
fetch C05 into	
	c05_w;
EXIT WHEN NOT FOUND; /* apply on C05 */
	begin
	
	select	count(*)
	into STRICT	qt_material_proc_ww
	from	paciente_protocolo_medic
	where	cd_material = c05_w.cd_material
	and	nr_seq_paciente = nr_seq_pac_p;
	
	if (qt_material_proc_ww = 0) then
	
		select	coalesce(max(nr_seq_material),0) + 1
		into STRICT	nr_seq_material_w
		from	paciente_protocolo_medic
		where	nr_seq_paciente = nr_seq_pac_p;
						

		insert into paciente_protocolo_medic(
			nr_seq_paciente, 
			nr_seq_material, 
			nr_seq_medicacao,
			cd_material, 
			qt_dose,
			cd_unidade_medida, 
			ds_dias_aplicacao, 
			dt_atualizacao, 
			nm_usuario, 
			nr_agrupamento, 
			ie_bomba_infusao, 
			nr_seq_interno,
			ie_via_aplicacao,
			cd_intervalo,
			ds_recomendacao,		
			ie_agrupador)
		values (nr_seq_pac_p,
			nr_seq_material_w,
			nr_sequencia_p,
			c05_w.cd_material,
			c05_w.qt_dose,
			c05_w.cd_unidade_medida,
			c05_w.ds_dias_aplicacao,
			clock_timestamp(),
			nm_usuario_p,
			c05_w.nr_agrupamento, 
			c05_w.ie_bomba_infusao, 
			nextval('paciente_protocolo_medic_seq'),
			c05_w.ie_via_aplicacao,
			c05_w.cd_intervalo,
			substr(c05_w.ds_recomendacao,1,2000),
			c05_w.ie_agrupador);
			
			nr_seq_material_ww := c05_w.nr_seq_Material;
			
			open C06;
			loop
			fetch C06 into	
				c06_w;
			EXIT WHEN NOT FOUND; /* apply on C06 */
				begin
			
			
			select (max(nr_agrupamento) + 1)
			into STRICT	nr_agrupamento_w
			from	paciente_protocolo_medic
			where	nr_seq_paciente = NR_SEQ_PAC_P;
			
			select (max(nr_Seq_material) + 1)
			into STRICT	nr_seq_material_dilu_w
			from	paciente_protocolo_medic
			where	nr_seq_paciente = NR_SEQ_PAC_P;
					
			insert into paciente_protocolo_medic(	nr_seq_paciente,
								nr_seq_diluicao,
								nr_seq_interno,
								cd_material,
								cd_unidade_medida,
								qt_dose,
								ds_dias_aplicacao,
								nr_seq_material,
								nr_agrupamento,
								nm_usuario,
								dt_atualizacao,
								ie_bomba_infusao
								)
							values (	NR_SEQ_PAC_P,
								nr_seq_material_w,
								nextval('paciente_protocolo_medic_seq'),
								c06_w.cd_material,
								c06_w.cd_unidade_medida,
								c06_w.qt_dose,
								c06_w.ds_dias_aplicacao,
								nr_seq_material_dilu_w,
								nr_agrupamento_w,
								nm_usuario_p,
								clock_timestamp(),
								'N'
								);				
				
				end;
			end loop;
			close C06;
	end if;	
	

	
	end;
end loop;
close C05;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_protocolo ( CD_PROTOCOLO_P bigint, NR_SEQUENCIA_P bigint, NR_SEQ_PAC_P bigint, nm_usuario_p text) FROM PUBLIC;

