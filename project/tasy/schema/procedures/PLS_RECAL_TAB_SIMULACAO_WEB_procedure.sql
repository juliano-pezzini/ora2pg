-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_recal_tab_simulacao_web ( nr_seq_proposta_p pls_proposta_online.nr_sequencia%type, nr_seq_simulacao_p pls_simulacao_preco.nr_sequencia%type, nr_seq_plano_online_p pls_plano_online.nr_sequencia%type, nm_usuario_p text) AS $body$
DECLARE


qt_vidas_w			bigint;
nr_seq_simul_preco_plano_w	pls_simulacao_preco_plano.nr_sequencia%type;

c_01 CURSOR FOR
	SELECT	b.nr_seq_plano,
		a.nr_seq_tabela,
		b.nr_seq_grupo_plano
	from	pls_plano_tabela_online a, 
		pls_plano_online b
	where	a.nr_seq_plano_online	= b.nr_sequencia
	and	a.nr_seq_plano_online	= nr_seq_plano_online_p
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and (coalesce(a.dt_inicio_vigencia::text, '') = '' or 
		 a.dt_inicio_vigencia <= clock_timestamp())
	and (coalesce(a.dt_fim_vigencia::text, '') = '' or 
		 a.dt_fim_vigencia	>= clock_timestamp())
	and (b.ie_tabela_qt_vidas  = 'N' or (a.qt_vidas_inicial <= qt_vidas_w and a.qt_vidas_final >= qt_vidas_w));

r_01 c_01%rowtype;


BEGIN

if (nr_seq_proposta_p IS NOT NULL AND nr_seq_proposta_p::text <> '') then --PROPOSTA
	select	count(1)
	into STRICT	qt_vidas_w
	from	pls_proposta_benef_online
	where	nr_seq_prop_online	= nr_seq_proposta_p
	and	ie_tipo_benef <> 'R';
	
	--Abre cursor C_01 - PROPOSTA
	open c_01;
	fetch c_01
	into r_01;
	close c_01;
	
	-- Se encontrou tabela de preco para a proposta
	if (r_01.nr_seq_tabela IS NOT NULL AND r_01.nr_seq_tabela::text <> '') then
		update	pls_proposta_online
		set	nr_seq_tabela	= r_01.nr_seq_tabela,
			nr_seq_plano	= r_01.nr_seq_plano,
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p
		where	nr_sequencia	= nr_seq_proposta_p;
		
		update	pls_simulacao_preco
		set	nr_seq_grupo_plano	= r_01.nr_seq_grupo_plano,
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p
		where	nr_sequencia =
			(	SELECT	nr_seq_simulacao
				from	pls_proposta_online
				where	nr_sequencia = nr_seq_proposta_p);
	end if;
	
elsif (nr_seq_simulacao_p IS NOT NULL AND nr_seq_simulacao_p::text <> '') then --SIMULACAO
	select	count(1)
	into STRICT	qt_vidas_w
	from	pls_simulpreco_individual
	where	nr_seq_simulacao	= nr_seq_simulacao_p
	and	ie_tipo_benef <> 'R';
	
	--Abre cursor C_01 - SIMULACAO
	open c_01;
	fetch c_01
	into r_01;
	close c_01;
	
	update	pls_simulpreco_individual
	set	nr_seq_produto		= r_01.nr_seq_plano,
		nr_seq_tabela		= r_01.nr_seq_tabela,
		dt_atualizacao		= clock_timestamp(),
		nm_usuario		= nm_usuario_p
	where	nr_seq_simulacao	= nr_seq_simulacao_p;
	
	update	pls_simulacao_preco
	set	nr_seq_produto		= r_01.nr_seq_plano,
		nr_seq_tabela		= r_01.nr_seq_tabela,
		nr_seq_grupo_plano	= r_01.nr_seq_grupo_plano,
		dt_atualizacao		= clock_timestamp(),
		nm_usuario		= nm_usuario_p
	where	nr_sequencia		= nr_seq_simulacao_p;
	
	select	max(nr_sequencia)
	into STRICT	nr_seq_simul_preco_plano_w
	from	pls_simulacao_preco_plano
	where	nr_seq_simulacao	= nr_seq_simulacao_p;
	
	if (nr_seq_simul_preco_plano_w IS NOT NULL AND nr_seq_simul_preco_plano_w::text <> '') then
		update	pls_simulacao_preco_plano
		set	nr_seq_plano	= r_01.nr_seq_plano,
			nr_seq_tabela	= r_01.nr_seq_tabela,
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p
		where	nr_sequencia	= nr_seq_simul_preco_plano_w;
	else
		insert	into	pls_simulacao_preco_plano(	nr_sequencia, nr_seq_simulacao, dt_atualizacao,
				nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
				nr_seq_plano, nr_seq_tabela, ie_status)
			values (	nextval('pls_simulacao_preco_plano_seq'), nr_seq_simulacao_p, clock_timestamp(),
				nm_usuario_p, clock_timestamp(), nm_usuario_p,
				r_01.nr_seq_plano, r_01.nr_seq_tabela, 'S');
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_recal_tab_simulacao_web ( nr_seq_proposta_p pls_proposta_online.nr_sequencia%type, nr_seq_simulacao_p pls_simulacao_preco.nr_sequencia%type, nr_seq_plano_online_p pls_plano_online.nr_sequencia%type, nm_usuario_p text) FROM PUBLIC;

