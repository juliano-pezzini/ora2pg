-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_proced_adicional ( nr_prescricao_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_proc_interno_p bigint, cd_setor_atendimento_p bigint, nm_usuario_p text, ie_lado_p text, qt_procedimento_p bigint, ds_dado_clinico_p text, ds_resumo_clinico_p text, ds_exame_fis_p text, nr_seq_prescr_p INOUT bigint) AS $body$
DECLARE


nr_sequencia_w		bigint;
cd_intervalo_w		varchar(7);
cd_setor_entrega_w		integer;
dt_prev_execucao_w		timestamp;
nr_seq_exame_w		bigint;
ie_setor_proced_w	varchar(01);
cd_setor_proced_w	bigint;


BEGIN

select coalesce(max(nr_seq_exame_lab),null)
into STRICT	nr_seq_exame_w
from	proc_interno
where	nr_sequencia	= nr_seq_proc_interno_p;

select	coalesce(max(nr_sequencia),0) + 1
into STRICT	nr_sequencia_w
from	prescr_procedimento
where 	nr_prescricao = nr_prescricao_p;

select	coalesce(max(b.dt_prev_execucao),max(a.dt_prescricao))
into STRICT	dt_prev_execucao_w
from	prescr_procedimento b,
	prescr_medica a
where	a.nr_prescricao		= nr_prescricao_p
and	a.nr_prescricao		= b.nr_prescricao
and	b.cd_procedimento	= cd_procedimento_p
and	b.ie_suspenso		<> 'S'
and	b.ie_origem_proced	= ie_origem_proced_p;

cd_intervalo_w := Obter_Param_Usuario(924, 35, obter_perfil_ativo, obter_usuario_ativo, obter_estabelecimento_ativo, cd_intervalo_w);
ie_setor_proced_w := Obter_Param_Usuario(942, 84, obter_perfil_ativo, obter_usuario_ativo, obter_estabelecimento_ativo, ie_setor_proced_w);

if (coalesce(cd_intervalo_w::text, '') = '') then
    cd_intervalo_w := Obter_Param_Usuario(924, 35, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, cd_intervalo_w);
end if;

select	max(cd_setor_exclusivo)
into STRICT	cd_setor_proced_w
from	procedimento
where	cd_procedimento		= cd_procedimento_p
and	ie_origem_proced	= ie_origem_proced_p;

select	Obter_data_prev_exec(dt_prescricao,dt_prev_execucao_w,cd_setor_atendimento_p, nr_prescricao_p, 'A')
into STRICT	dt_prev_execucao_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

insert into prescr_procedimento(
	nr_prescricao, nr_sequencia, cd_procedimento, qt_procedimento, dt_atualizacao,
	nm_usuario, cd_motivo_baixa, ie_origem_proced, cd_intervalo,
	ie_urgencia, ie_suspenso, cd_setor_atendimento, dt_prev_execucao,
	ie_status_atend, ie_origem_inf, ie_amostra, ie_executar_leito, ie_se_necessario,
	ie_acm, nr_ocorrencia, ds_observacao, nr_seq_interno, nr_seq_proc_interno,
	ie_avisar_result, nr_seq_exame, ie_lado, ds_dado_clinico, ds_resumo_clinico, ds_exame_fis_achado_cirur)
values (
	nr_prescricao_p, nr_sequencia_w, cd_procedimento_p, coalesce(qt_procedimento_p,1), clock_timestamp(),
	nm_usuario_p, 0, ie_origem_proced_p, cd_intervalo_w, 
	'N', 'N', CASE WHEN ie_setor_proced_w='S' THEN  coalesce(cd_setor_proced_w, cd_setor_atendimento_p)  ELSE cd_setor_atendimento_p END , coalesce(dt_prev_execucao_w,clock_timestamp()) ,5, '1', 'N','N','N','N',1,
	substr(wheb_mensagem_pck.get_texto(805145,'NM_USUARIO='||nm_usuario_p||';DT_ATUAL='||to_char(clock_timestamp(),'dd/mm/yyyy hh24:mi:ss')),1,2000),
	nextval('prescr_procedimento_seq'), nr_seq_proc_interno_p, 'N', nr_seq_exame_w, ie_lado_p, ds_dado_clinico_p, ds_resumo_clinico_p,	ds_exame_fis_p);

nr_seq_prescr_p	:= nr_sequencia_w;

--Gerar_med_mat_assoc(nr_prescricao_p,nr_sequencia_w);

--Gerar_prescr_proc_assoc(nr_prescricao_p,nr_sequencia_w);
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_proced_adicional ( nr_prescricao_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_proc_interno_p bigint, cd_setor_atendimento_p bigint, nm_usuario_p text, ie_lado_p text, qt_procedimento_p bigint, ds_dado_clinico_p text, ds_resumo_clinico_p text, ds_exame_fis_p text, nr_seq_prescr_p INOUT bigint) FROM PUBLIC;

