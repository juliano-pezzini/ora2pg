-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_leito_interditado ( cd_setor_atendimento_p bigint, cd_unidade_basica_p text, cd_unidade_compl_p text, nr_seq_interno_p bigint, cd_estab_ocupacao_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, ie_motivo_interdicao_p text default 'S') AS $body$
DECLARE

 
ie_saida_interd_w		varchar(255);
ie_status_ant_int_w		varchar(255);
ie_obs_int_w			varchar(255);
ie_coloca_leito_aguard_w	varchar(255);
ie_coloca_leito_reservado_w	varchar(1);
ie_reservado_w			varchar(1);
ie_aguard_agrup_w		varchar(1);
nr_agrupamento_w		bigint;


BEGIN 
 
if (cd_setor_atendimento_p IS NOT NULL AND cd_setor_atendimento_p::text <> '') and (cd_unidade_basica_p IS NOT NULL AND cd_unidade_basica_p::text <> '') and (cd_unidade_compl_p IS NOT NULL AND cd_unidade_compl_p::text <> '') and (nr_seq_interno_p IS NOT NULL AND nr_seq_interno_p::text <> '') then 
	begin 
	ie_saida_interd_w := Obter_Param_Usuario(44, 71, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_saida_interd_w);
	ie_status_ant_int_w := Obter_Param_Usuario(44, 51, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_status_ant_int_w);
	ie_obs_int_w := Obter_Param_Usuario(44, 45, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_obs_int_w);
	ie_coloca_leito_aguard_w := Obter_Param_Usuario(44, 165, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_coloca_leito_aguard_w);
	ie_coloca_leito_reservado_w := Obter_Param_Usuario(44, 255, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_coloca_leito_reservado_w);
	ie_aguard_agrup_w := Obter_Param_Usuario(44, 296, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_aguard_agrup_w);
 
	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  
	into STRICT	ie_reservado_w 
	from	unidade_atendimento 
	where	nr_seq_interno = nr_seq_interno_p 
	and ((cd_paciente_reserva IS NOT NULL AND cd_paciente_reserva::text <> '') or (nm_pac_reserva IS NOT NULL AND nm_pac_reserva::text <> ''));
	 
	if (ie_coloca_leito_reservado_w = 'S') and (ie_reservado_w = 'S') then		 
				 
		update 	unidade_atendimento 
		set  	ie_status_unidade	= 'R', 
			nm_usuario 		= nm_usuario_p, 
			dt_atualizacao		= clock_timestamp(), 
			cd_motivo_interdicao 	= CASE WHEN ie_motivo_interdicao_p='S' THEN  null  ELSE cd_motivo_interdicao END  
		where 	cd_unidade_basica  	= cd_unidade_basica_p 
		and  	cd_unidade_compl   	= cd_unidade_compl_p 
		and  	cd_setor_atendimento 	= cd_setor_atendimento_p;		
		 
	else 
		if (ie_saida_interd_w = 'S') then 
			update	unidade_atendimento 
			set	ie_status_unidade	= 'S', 
				nm_usuario		= nm_usuario_p, 
				dt_atualizacao		= clock_timestamp(), 
				ds_observacao		 = NULL, 
				cd_motivo_interdicao 	= CASE WHEN ie_motivo_interdicao_p='S' THEN  null  ELSE cd_motivo_interdicao END  
			where	cd_unidade_basica	= cd_unidade_basica_p 
			and	cd_unidade_compl	= cd_unidade_compl_p 
			and	cd_setor_atendimento	= cd_setor_atendimento_p;
		elsif (ie_status_ant_int_w = 'S') then 
		 
			update	unidade_atendimento 
			set	ie_status_unidade	= coalesce(ie_status_ant_unidade,'L'), 
				nm_usuario		= nm_usuario_p, 
				dt_atualizacao		= clock_timestamp(), 
				ds_observacao		 = NULL, 
				cd_motivo_interdicao 	= CASE WHEN ie_motivo_interdicao_p='S' THEN  null  ELSE cd_motivo_interdicao END  
			where	cd_unidade_basica	= cd_unidade_basica_p 
			and	cd_unidade_compl	= cd_unidade_compl_p 
			and	cd_setor_atendimento	= cd_setor_atendimento_p;
		elsif (ie_coloca_leito_aguard_w = 'S')then 
			 
			select	max(NR_AGRUPAMENTO) 
			into STRICT	nr_agrupamento_w 
			from	unidade_atendimento 
			where 	cd_unidade_basica  = cd_unidade_basica_p 
			and  	cd_unidade_compl   = cd_unidade_compl_p 
			and  	cd_setor_atendimento = cd_setor_atendimento_p;
			 
			if (nr_agrupamento_w IS NOT NULL AND nr_agrupamento_w::text <> '') and (ie_aguard_agrup_w = 'S') then 
 
				update 	unidade_atendimento 
				set  	ie_status_unidade  	= 'G', 
					nm_usuario 		= nm_usuario_p, 
					dt_atualizacao 		= clock_timestamp(), 
					ds_observacao		 = NULL, 
					cd_motivo_interdicao 	= CASE WHEN ie_motivo_interdicao_p='S' THEN  null  ELSE cd_motivo_interdicao END  
				where	cd_setor_atendimento = cd_setor_atendimento_p 
				and	nr_agrupamento = nr_agrupamento_w 
				and 	ie_status_unidade <> 'P';
			 
			else 
				update 	unidade_atendimento 
				set  	ie_status_unidade  = 'G', 
					nm_usuario = nm_usuario_p, 
					dt_atualizacao = clock_timestamp(), 
					ds_observacao		 = NULL, 
					cd_motivo_interdicao 	= CASE WHEN ie_motivo_interdicao_p='S' THEN  null  ELSE cd_motivo_interdicao END  
				where 	cd_unidade_basica  = cd_unidade_basica_p 
				and  	cd_unidade_compl   = cd_unidade_compl_p 
				and  	cd_setor_atendimento = cd_setor_atendimento_p;
			end if;			
		else 
			update	unidade_atendimento 
			set	ie_status_unidade	= 'L', 
				nm_usuario		= nm_usuario_p, 
				dt_atualizacao		= clock_timestamp(), 
				ds_observacao		 = NULL, 
				cd_motivo_interdicao 	= CASE WHEN ie_motivo_interdicao_p='S' THEN  null  ELSE cd_motivo_interdicao END  
			where	cd_unidade_basica	= cd_unidade_basica_p 
			and	cd_unidade_compl	= cd_unidade_compl_p 
			and	cd_setor_atendimento	= cd_setor_atendimento_p;
		end if;
	end if;
	 
	CALL gerar_higienizacao_leito_unid(clock_timestamp(), nm_usuario_p, cd_estabelecimento_p, 'LL', nr_seq_interno_p, null);
	CALL gerar_evento_liber_leito(nr_seq_interno_p, cd_estab_ocupacao_p, nm_usuario_p);
 
	if (ie_obs_int_w = 'S') then 
		CALL gerar_obs_leito_interditado(cd_setor_atendimento_p, cd_unidade_basica_p, cd_unidade_compl_p, '', null, 'L', null, nm_usuario_p);
	end if;
	end;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_leito_interditado ( cd_setor_atendimento_p bigint, cd_unidade_basica_p text, cd_unidade_compl_p text, nr_seq_interno_p bigint, cd_estab_ocupacao_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, ie_motivo_interdicao_p text default 'S') FROM PUBLIC;

