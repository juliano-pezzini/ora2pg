-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_retorno_spc_padrao ( ie_tipo_p text, nr_seq_lote_p text, nm_usuario_p text) AS $body$
DECLARE

qt_w                bigint;
ie_tipo_lote_w      lote_orgao_cobranca.ie_tipo_lote%type;
nr_seq_orgao_cobr_w bigint;
nr_seq_corbanca_w   bigint;
ds_mensagem_w       varchar(255);
tipo_lote_arq_w     varchar(30);
cd_detalhe_w         varchar(30);

C01 CURSOR FOR
    SELECT  somente_numero(substr(ds_conteudo,32,13)) nr_sequencia,
            somente_numero(substr(ds_conteudo,52,10)) dt_vencimento,
            substr(ds_conteudo,19,1) ie_tipo_operacao,
            substr(ds_conteudo,0,2) cd_detalhe
    from    w_retorno_orgao_cobr
    where   nm_usuario  = nm_usuario_p
    and     nr_seq_lote = nr_seq_lote_p;

vet01   C01%RowType;

BEGIN

select  max(ie_tipo_lote)
into STRICT    ie_tipo_lote_w
from    lote_orgao_cobranca
where   nr_sequencia = nr_seq_lote_p;

open C01;
loop
fetch C01 into
    vet01;
EXIT WHEN NOT FOUND; /* apply on C01 */
begin
    select CASE WHEN vet01.ie_tipo_operacao='I' THEN 'inclusao'  ELSE 'exclusao' END
    into STRICT tipo_lote_arq_w
;

    if ((ie_tipo_lote_w <> vet01.ie_tipo_operacao) and vet01.cd_detalhe = '02') then
        ds_mensagem_w := wheb_mensagem_pck.get_texto(338796, 'ie_tipo_operacao=' ||vet01.ie_tipo_operacao);
        CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_mensagem_w);
    end if;
    if (ie_tipo_p = 'C') then --cheque
        if (ie_tipo_lote_w = 'E') then
            select	count(*),
                    max(nr_seq_cobranca),
                    max(nr_seq_orgao_cobr)
            into STRICT    qt_w,
                    nr_seq_corbanca_w,
                    nr_seq_orgao_cobr_w
            from    cheque_cr_orgao_cobr
            where   nr_seq_cheque   = vet01.nr_sequencia
            and     nr_seq_lote_exc = nr_seq_lote_p;
            if (qt_w > 0) then
                update  cheque_cr_orgao_cobr
                set     dt_exclusao         = to_date(vet01.dt_vencimento,'dd/MM/yyyy')
                where	nr_seq_cheque       = vet01.nr_sequencia
                and 	nr_seq_orgao_cobr   =  nr_seq_orgao_cobr_w;

                update  cobranca_orgao
                set	    dt_retirada     = clock_timestamp()
                where   nr_seq_cobranca = nr_seq_corbanca_w
                and     nr_seq_orgao    = nr_seq_orgao_cobr_w;

            end if;
        elsif (ie_tipo_lote_w = 'I') then
            select	count(*),
                max(nr_seq_cobranca),
                max(nr_seq_orgao_cobr)
            into STRICT	qt_w,
                nr_seq_corbanca_w,
                nr_seq_orgao_cobr_w
            from	cheque_cr_orgao_cobr
            where	nr_seq_cheque = vet01.nr_sequencia
            and 	nr_seq_lote = nr_seq_lote_p;
            if (qt_w > 0) then
                update	cheque_cr_orgao_cobr
                set	dt_envio 	= to_date(vet01.dt_vencimento,'dd/MM/yyyy')
                where	nr_seq_cheque 	= vet01.nr_sequencia
                and 	nr_seq_orgao_cobr =  nr_seq_orgao_cobr_w;

                update	cobranca_orgao
                set	dt_inclusao = clock_timestamp()
                where	nr_seq_cobranca = nr_seq_corbanca_w
                and 	nr_seq_orgao = nr_seq_orgao_cobr_w;
            end if;
        end if;

    elsif (ie_tipo_p = 'T'  ) then --titulo
        if (ie_tipo_lote_w = 'E') then
            select  count(*),
                    max(nr_seq_cobranca),
                    max(nr_seq_orgao_cobr)
            into STRICT    qt_w,
                    nr_seq_corbanca_w,
                    nr_seq_orgao_cobr_w
            from    titulo_receber_orgao_cobr
            where   nr_titulo = vet01.nr_sequencia
            and     nr_seq_lote_exc = nr_seq_lote_p;


            if (qt_w > 0) then
                update  titulo_receber_orgao_cobr
                set	    dt_exclusao         = to_date(vet01.dt_vencimento,'dd/MM/yyyy')
                where   nr_titulo           = vet01.nr_sequencia
                and     nr_seq_orgao_cobr   =  nr_seq_orgao_cobr_w;

                update  cobranca_orgao
                set     dt_retirada     = clock_timestamp()
                where   nr_seq_cobranca = nr_seq_corbanca_w
                and     nr_seq_orgao    = nr_seq_orgao_cobr_w;
            end if;
        elsif (ie_tipo_lote_w = 'I') then
			
            select	count(*),
                max(nr_seq_cobranca),
                max(nr_seq_orgao_cobr)
            into STRICT	qt_w,
                nr_seq_corbanca_w,
                nr_seq_orgao_cobr_w
            from	titulo_receber_orgao_cobr
            where	nr_titulo = vet01.nr_sequencia
            and 	nr_seq_lote = nr_seq_lote_p;
			
            if (qt_w > 0) then

                update	titulo_receber_orgao_cobr
                set	dt_envio 	= to_date(vet01.dt_vencimento,'dd/MM/yyyy')
                where	nr_titulo 	= vet01.nr_sequencia
                and 	nr_seq_orgao_cobr =  nr_seq_orgao_cobr_w;

                update	cobranca_orgao
                set	dt_inclusao = clock_timestamp()
                where	nr_seq_cobranca = nr_seq_corbanca_w
                and 	nr_seq_orgao = nr_seq_orgao_cobr_w;

            end if;
        end if;

    elsif (ie_tipo_p = 'O') then --outros
        if (ie_tipo_lote_w = 'E') then

            select	count(*),
                max(nr_seq_cobranca),
                max(nr_seq_orgao_cobr)
            into STRICT	qt_w,
                nr_seq_corbanca_w,
                nr_seq_orgao_cobr_w
            from	outros_orgao_cobr
            where	nr_sequencia = vet01.nr_sequencia
            and 	nr_seq_lote_exc = nr_seq_lote_p;

            if (qt_w > 0) then

                update	outros_orgao_cobr
                set	dt_exclusao 	= to_date(vet01.dt_vencimento,'dd/MM/yyyy')
                where	nr_sequencia 	= vet01.nr_sequencia
                and 	nr_seq_orgao_cobr =  nr_seq_orgao_cobr_w;

                update	cobranca_orgao
                set	dt_retirada = clock_timestamp()
                where	nr_seq_cobranca = nr_seq_corbanca_w
                and 	nr_seq_orgao = nr_seq_orgao_cobr_w;

            end if;

        elsif (ie_tipo_lote_w = 'I') then

            select	count(*),
                max(nr_seq_cobranca),
                max(nr_seq_orgao_cobr)
            into STRICT	qt_w,
                nr_seq_corbanca_w,
                nr_seq_orgao_cobr_w
            from	outros_orgao_cobr
            where	nr_sequencia = vet01.nr_sequencia
            and 	nr_seq_lote = nr_seq_lote_p;

            if (qt_w > 0) then

                update	outros_orgao_cobr
                set	dt_envio 	= to_date(vet01.dt_vencimento,'dd/MM/yyyy')
                where	nr_sequencia 	= vet01.nr_sequencia
                and 	nr_seq_orgao_cobr =  nr_seq_orgao_cobr_w;

                update	cobranca_orgao
                set	dt_inclusao = clock_timestamp()
                where	nr_seq_cobranca = nr_seq_corbanca_w
                and 	nr_seq_orgao = nr_seq_orgao_cobr_w;

            end if;
        end if;
    end if;

    end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_retorno_spc_padrao ( ie_tipo_p text, nr_seq_lote_p text, nm_usuario_p text) FROM PUBLIC;

