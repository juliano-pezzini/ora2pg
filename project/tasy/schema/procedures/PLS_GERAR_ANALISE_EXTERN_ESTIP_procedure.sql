-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_analise_extern_estip ( nr_seq_ocorrencia_p bigint, nr_seq_requisicao_p bigint, nr_contrato_p bigint, nr_seq_intercambio_p bigint, nr_seq_grupo_contrato_p bigint, nm_usuario_p text, ie_analise_estip_ext_p INOUT text) AS $body$
DECLARE

 
cd_area_w			bigint;
cd_especialidade_w		bigint;
cd_grupo_w			bigint;
cd_procedimento_w		bigint;

ie_origem_proced_w		bigint;
ie_origem_proc_w		bigint;
ie_tipo_auditoria_w		smallint;
ie_retorno_w			varchar(2);
ie_tipo_guia_w			varchar(2);
ie_tipo_contrato_w		varchar(1);
ie_valida_w			varchar(1) := 'N';
ie_grupo_w			varchar(1) := 'N';
ie_analise_estip_ext_w		varchar(1) := 'N';

nr_seq_tipo_pos_estab_w		bigint;
nr_seq_contrato_w		bigint;
nr_seq_grupo_w			bigint;
nr_seq_regra_w			bigint	:= 0;
nr_seq_contr_interca_w		bigint;
nr_seq_grupo_servico_w		bigint;
nr_seq_material_w		bigint;
nr_seq_grupo_material_w		bigint;

qt_existe_grupo_w		bigint;

vl_procedimento_w		double precision;
vl_material_w			double precision;

C01 CURSOR FOR 
	SELECT	nr_seq_grupo 
	from	pls_ocorrencia		a, 
		pls_ocorrencia_grupo	b 
	where	a.nr_sequencia	= nr_seq_ocorrencia_p 
	and	a.nr_sequencia	= b.nr_seq_ocorrencia;
	
C02 CURSOR FOR 
	SELECT	ie_tipo_auditoria 
	from	pls_grupo_auditor 
	where	nr_sequencia	= nr_seq_grupo_w;
	
C03 CURSOR FOR 
	SELECT	b.nr_sequencia, 
		'N' ie_tipo_contrato 
	from	pls_membro_grupo_aud	a, 
		pls_contrato		b 
	where	nr_seq_grupo		= nr_seq_grupo_w 
	and	a.nr_seq_contrato	= b.nr_sequencia 
	
union
 
	SELECT	b.nr_sequencia, 
		'I' ie_tipo_contrato 
	from	pls_membro_grupo_aud	a, 
		pls_intercambio		b 
	where	nr_seq_grupo		= nr_seq_grupo_w 
	and	a.nr_seq_intercambio	= b.nr_sequencia;

C04 CURSOR FOR 
	SELECT	a.cd_procedimento, 
		a.ie_origem_proced, 
		coalesce(a.vl_procedimento,0), 
		b.ie_tipo_guia 
	from	pls_requisicao_proc	a, 
		pls_requisicao		b 
	where	a.nr_seq_requisicao	= nr_seq_requisicao_p 
	and	a.nr_seq_requisicao	= b.nr_sequencia;

C05 CURSOR FOR 
	SELECT	nr_seq_tipo_pos_est 
	from	pls_regra_auditoria_estip 
	where	coalesce(ie_tipo_guia,ie_tipo_guia_w)	= ie_tipo_guia_w 
	and	ie_situacao	= 'A' 
	and	((nr_seq_tipo_pos_est	in (	SELECT	nr_seq_tipo_pos_estab 
						from	pls_pos_estab_aut_previa 
						where	nr_seq_contrato		= nr_seq_contrato_w 
						and	ie_situacao		= 'A')) 
	or (nr_seq_tipo_pos_est	in (	select	nr_seq_tipo_pos_estab 
						from	pls_pos_estab_aut_previa 
						where	nr_seq_intercambio	= nr_seq_contrato_w 
						and	ie_situacao		= 'A')));
	
C06 CURSOR FOR 
	SELECT	nr_sequencia, 
		nr_seq_grupo_servico 
	from	( 	SELECT	b.nr_sequencia nr_sequencia, 
				a.nr_seq_grupo_servico nr_seq_grupo_servico 
			from	pls_tipo_pos_estab_proc		a, 
				pls_tipo_pos_estabelecido	b 
			where	a.nr_seq_tipo_pos_estab				= b.nr_sequencia 
			and	b.nr_sequencia					= nr_seq_tipo_pos_estab_w 
			and	coalesce(a.cd_procedimento,cd_procedimento_w)	= cd_procedimento_w 
			and	coalesce(a.ie_origem_proced,ie_origem_proc_w) 	= ie_origem_proc_w 
			and	coalesce(a.cd_grupo_proc,cd_grupo_w)			= cd_grupo_w 
			and	coalesce(a.cd_especialidade, cd_especialidade_w)	= cd_especialidade_w 
			and	coalesce(a.cd_area_procedimento, cd_area_w) 		= cd_area_w 
			and	((coalesce(a.vl_liberado,0)				< vl_procedimento_w) 
			or	((coalesce(a.vl_liberado,0)	= 0) and (vl_procedimento_w	= 0)))	 
			and	a.ie_liberado					= 'N' 
			and	b.ie_situacao					= 'A' 
			and	coalesce(a.nr_seq_grupo_material::text, '') = '' 
			and (coalesce(b.cd_estabelecimento, wheb_usuario_pck.get_cd_estabelecimento) = wheb_usuario_pck.get_cd_estabelecimento and pls_obter_se_controle_estab('RE') = 'S') 
			
union all
 
			select	b.nr_sequencia, 
				a.nr_seq_grupo_servico 
			from	pls_tipo_pos_estab_proc		a, 
				pls_tipo_pos_estabelecido	b 
			where	a.nr_seq_tipo_pos_estab				= b.nr_sequencia 
			and	b.nr_sequencia					= nr_seq_tipo_pos_estab_w 
			and	coalesce(a.cd_procedimento,cd_procedimento_w)	= cd_procedimento_w 
			and	coalesce(a.ie_origem_proced,ie_origem_proc_w) 	= ie_origem_proc_w 
			and	coalesce(a.cd_grupo_proc,cd_grupo_w)			= cd_grupo_w 
			and	coalesce(a.cd_especialidade, cd_especialidade_w)	= cd_especialidade_w 
			and	coalesce(a.cd_area_procedimento, cd_area_w) 		= cd_area_w 
			and	((coalesce(a.vl_liberado,0)				< vl_procedimento_w) 
			or	((coalesce(a.vl_liberado,0)	= 0) and (vl_procedimento_w	= 0)))	 
			and	a.ie_liberado					= 'N' 
			and	b.ie_situacao					= 'A' 
			and	coalesce(a.nr_seq_grupo_material::text, '') = '' 
			and (pls_obter_se_controle_estab('RE') = 'N')) alias31 
	order by	cd_area_w, 
			cd_especialidade_w, 
			cd_grupo_w, 
			cd_procedimento_w;

			 
C07 CURSOR FOR 
	SELECT	a.nr_seq_material, 
		coalesce(a.vl_material,0), 
		b.ie_tipo_guia 
	from	pls_requisicao_mat	a, 
		pls_requisicao		b 
	where	a.nr_seq_requisicao	= nr_seq_requisicao_p 
	and	a.nr_seq_requisicao	= b.nr_sequencia;
	
C08 CURSOR FOR 
	SELECT	b.nr_sequencia, 
		a.nr_seq_grupo_material 
	from	pls_tipo_pos_estab_proc		a, 
		pls_tipo_pos_estabelecido	b 
	where	a.nr_seq_tipo_pos_estab				= b.nr_sequencia 
	and	b.nr_sequencia					= nr_seq_tipo_pos_estab_w	 
	and	((coalesce(a.vl_liberado,0)				< vl_material_w) 
	or	((coalesce(a.vl_liberado,0)	= 0) and (vl_material_w	= 0)))	 
	and	a.ie_liberado					= 'N' 
	and	b.ie_situacao					= 'A' 
	and	coalesce(a.cd_procedimento::text, '') = '' 
	and   coalesce(a.cd_grupo_proc::text, '') = '' 
    and   coalesce(a.cd_especialidade::text, '') = '' 
    and   coalesce(a.cd_area_procedimento::text, '') = '' 
	and	coalesce(a.nr_seq_grupo_servico::text, '') = '' 
	and (coalesce(b.cd_estabelecimento, wheb_usuario_pck.get_cd_estabelecimento) = wheb_usuario_pck.get_cd_estabelecimento and pls_obter_se_controle_estab('RE') = 'S') 
	
union all
 
	SELECT	b.nr_sequencia, 
		a.nr_seq_grupo_material 
	from	pls_tipo_pos_estab_proc		a, 
		pls_tipo_pos_estabelecido	b 
	where	a.nr_seq_tipo_pos_estab				= b.nr_sequencia 
	and	b.nr_sequencia					= nr_seq_tipo_pos_estab_w	 
	and	((coalesce(a.vl_liberado,0)				< vl_material_w) 
	or	((coalesce(a.vl_liberado,0)	= 0) and (vl_material_w	= 0)))	 
	and	a.ie_liberado					= 'N' 
	and	b.ie_situacao					= 'A' 
	and	coalesce(a.cd_procedimento::text, '') = '' 
	and   coalesce(a.cd_grupo_proc::text, '') = '' 
    and   coalesce(a.cd_especialidade::text, '') = '' 
    and   coalesce(a.cd_area_procedimento::text, '') = '' 
	and	coalesce(a.nr_seq_grupo_servico::text, '') = '' 
	and 	pls_obter_se_controle_estab('RE') = 'N';


BEGIN 
 
open C01;
loop 
fetch C01 into	 
	nr_seq_grupo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin	 
	open C02;
	loop 
	fetch C02 into	 
		ie_tipo_auditoria_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin		 
		if (ie_tipo_auditoria_w	= 3) then 
			open C03;
			loop 
			fetch C03 into	 
				nr_seq_contr_interca_w, 
				ie_tipo_contrato_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin 
				ie_valida_w := 'N';
				 
				if (ie_tipo_contrato_w = 'N') then 
					if (coalesce(nr_contrato_p,0)	= pls_obter_dados_contrato(nr_seq_contr_interca_w,'N')) then 
						ie_valida_w := 'S';
					elsif (coalesce(nr_seq_grupo_contrato_p,0)	<> 0) then 
						select	count(1) 
						into STRICT	qt_existe_grupo_w 
						from	pls_preco_contrato	a 
						where	a.nr_seq_grupo		= nr_seq_grupo_contrato_p 
						and	nr_seq_contrato		= nr_seq_contr_interca_w;
						 
						if (qt_existe_grupo_w	> 0) then 
							ie_valida_w	:= 'S';
						end if;
					end if;
				elsif (ie_tipo_contrato_w = 'I') then 
					if (coalesce(nr_seq_intercambio_p,0) = nr_seq_contr_interca_w) then 
						ie_valida_w := 'S';
					elsif (coalesce(nr_seq_grupo_contrato_p,0)	<> 0) then 
						select	count(1) 
						into STRICT	qt_existe_grupo_w 
						from	pls_preco_contrato	a 
						where	a.nr_seq_grupo		= nr_seq_grupo_contrato_p 
						and	nr_seq_intercambio	= nr_seq_contr_interca_w;
						 
						if (qt_existe_grupo_w	> 0) then 
							ie_valida_w	:= 'S';
						end if;
					end if;
				end if;
				 
				if (ie_valida_w = 'S') then 
					if (coalesce(nr_contrato_p,0)	<> 0) then 
						nr_seq_contrato_w	:= pls_obter_seq_contrato(nr_contrato_p);
					elsif (coalesce(nr_seq_intercambio_p,0)	<> 0) then 
						nr_seq_contrato_w	:= nr_seq_intercambio_p;
					else 
						nr_seq_contrato_w	:= nr_seq_contr_interca_w;
					end if;
					 
					open C04;
					loop 
					fetch C04 into	 
						cd_procedimento_w, 
						ie_origem_proced_w, 
						vl_procedimento_w, 
						ie_tipo_guia_w;
					EXIT WHEN NOT FOUND; /* apply on C04 */
						begin 
						SELECT * FROM pls_obter_estrut_proc(cd_procedimento_w, ie_origem_proced_w, cd_area_w, cd_especialidade_w, cd_grupo_w, ie_origem_proc_w) INTO STRICT cd_area_w, cd_especialidade_w, cd_grupo_w, ie_origem_proc_w;
						open C05;
						loop 
						fetch C05 into	 
							nr_seq_tipo_pos_estab_w;
						EXIT WHEN NOT FOUND; /* apply on C05 */
							begin 
							open C06;
							loop 
							fetch C06 into	 
								nr_seq_regra_w, 
								nr_seq_grupo_servico_w;
							EXIT WHEN NOT FOUND; /* apply on C06 */
								begin 
								ie_grupo_w	:= 'S';
								if (coalesce(nr_seq_grupo_servico_w,0) > 0) then 
									ie_grupo_w	:= pls_se_grupo_preco_servico(nr_seq_grupo_servico_w, cd_procedimento_w, ie_origem_proced_w);
								end if;			
						 
								if (coalesce(ie_grupo_w,'S') = 'S') then 
									ie_analise_estip_ext_w	:= 'S';
									goto final;
								end if;
								end;
							end loop;
							close C06;
							end;
						end loop;
						close C05;
						end;
					end loop;
					close C04;
					 
					open C07;
					loop 
					fetch C07 into	 
						nr_seq_material_w, 
						vl_material_w, 
						ie_tipo_guia_w;
					EXIT WHEN NOT FOUND; /* apply on C07 */
						begin 
						open C05;
						loop 
						fetch C05 into	 
							nr_seq_tipo_pos_estab_w;
						EXIT WHEN NOT FOUND; /* apply on C05 */
							begin 
							open C08;
							loop 
							fetch C08 into	 
								nr_seq_regra_w, 
								nr_seq_grupo_material_w;
							EXIT WHEN NOT FOUND; /* apply on C08 */
								begin 
								ie_grupo_w	:= 'S';
								if (coalesce(nr_seq_grupo_material_w,0) > 0) then 
									ie_grupo_w	:= pls_se_grupo_preco_material(nr_seq_grupo_material_w, nr_seq_material_w);
								end if;			
						 
								if (coalesce(ie_grupo_w,'S') = 'S') then 
									ie_analise_estip_ext_w	:= 'S';
									goto final;
								end if;
								end;
							end loop;
							close C08;
							end;
						end loop;
						close C05;						
						end;
					end loop;
					close C07;
				end if;
				end;
			end loop;
			close C03;
		end if;
		end;
	end loop;
	close C02;
	end;
end loop;
close C01;
 
<<final>> 
if (ie_analise_estip_ext_w	= 'N') then 
	ie_analise_estip_ext_p	:= 'N';
else 
	update	pls_requisicao 
	set	ie_auditoria_estipulante	= 'S', 
		nr_seq_regra_pos_estip		= nr_seq_regra_w 
	where	nr_sequencia			= nr_seq_requisicao_p;
	ie_analise_estip_ext_p := 'S';
end if;
 
--commit; 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_analise_extern_estip ( nr_seq_ocorrencia_p bigint, nr_seq_requisicao_p bigint, nr_contrato_p bigint, nr_seq_intercambio_p bigint, nr_seq_grupo_contrato_p bigint, nm_usuario_p text, ie_analise_estip_ext_p INOUT text) FROM PUBLIC;

