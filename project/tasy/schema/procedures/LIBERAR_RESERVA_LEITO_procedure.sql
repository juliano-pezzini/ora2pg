-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_reserva_leito ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_setor_desejado_w integer;
cd_unidade_basica_w varchar(10);
cd_unidade_compl_w  varchar(10);
cd_pessoa_fisica_w  varchar(10);
ie_status_unidade_w varchar(3);
cd_paciente_reserva_w   varchar(10);
nm_pac_reserva_w    varchar(255);
cd_convenio_reserva_w integer;


BEGIN

begin
select  coalesce(max(ie_status_unidade),'L'),
    max(cd_paciente_reserva),
    max(nm_pac_reserva),
    max(cd_convenio_reserva)
into STRICT    ie_status_unidade_w,
    cd_paciente_reserva_w,
    nm_pac_reserva_w,
    cd_convenio_reserva_w
from    unidade_atendimento
where   nr_seq_interno = nr_sequencia_p;
end;

if (cd_paciente_reserva_w IS NOT NULL AND cd_paciente_reserva_w::text <> '') or (nm_pac_reserva_w IS NOT NULL AND nm_pac_reserva_w::text <> '') or (cd_convenio_reserva_w IS NOT NULL AND cd_convenio_reserva_w::text <> '') then
    begin
        if (ie_status_unidade_w = 'R') then
            begin
                update  unidade_atendimento
                set cd_paciente_reserva  = NULL,
                    CD_CONVENIO_RESERVA  = NULL,
                    nm_usuario_reserva  = nm_usuario_p,
                    dt_atualizacao      = clock_timestamp(),
                    NR_SEQ_MOTIVO_RESERVA    = NULL,
                    IE_NECESSITA_ISOL_RESERVA  = NULL,
                    ie_status_unidade   = 'L',
                    ie_tipo_reserva      = NULL,
                    nm_pac_reserva       = NULL,
                    DT_START_RESERVATION  = NULL,
                    DT_END_RESERVATION  = NULL
                where   nr_seq_interno = nr_sequencia_p;
        end;
        else
            begin
                update  unidade_atendimento
                set cd_paciente_reserva  = NULL,
                    CD_CONVENIO_RESERVA  = NULL,
                    nm_usuario_reserva  = nm_usuario_p,
                    dt_atualizacao      = clock_timestamp(),
                    NR_SEQ_MOTIVO_RESERVA    = NULL,
                    IE_NECESSITA_ISOL_RESERVA  = NULL,
                    ie_tipo_reserva      = NULL,
                    nm_pac_reserva       = NULL,
                    DT_START_RESERVATION  = NULL,
                    DT_END_RESERVATION  = NULL
                where   nr_seq_interno = nr_sequencia_p;
            end;
        end if;
    end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_reserva_leito ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

