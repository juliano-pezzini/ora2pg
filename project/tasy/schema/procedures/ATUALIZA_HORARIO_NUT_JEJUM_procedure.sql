-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_horario_nut_jejum ( nr_prescricao_p bigint, ie_acao_p text, nm_usuario_p text, cd_perfil_p bigint) AS $body$
DECLARE


hr_dose_especial_w		varchar(5);
cd_intervalo_w			varchar(7);
hr_prim_horario_w		varchar(5);
hr_prim_hor_jejum_w		varchar(5);
nr_atendimento_w		bigint;
nr_sequencia_w			integer;
ds_horarios_w			varchar(2000);
ds_horarios2_w			varchar(2000);
ie_agrupador_w			smallint;
dt_primeiro_horario_w		timestamp;
nr_horas_validade_w		integer;
dt_inicio_w			timestamp;
cd_material_w			integer;
qt_hora_intervalo_w		smallint;
qt_min_intervalo_w		integer;
nr_ocorrencia_w			double precision;
ds_dose_diferenciada_w		varchar(50);
ie_operacao_w			varchar(1);
qt_operacao_w			intervalo_prescricao.qt_operacao%type;
ie_atualiza_hor_agora_w		varchar(1);
cd_estabelecimento_w		smallint;
ie_urgencia_w			varchar(1);

c01 CURSOR FOR
SELECT	coalesce(hr_dose_especial,'  :  '),
	cd_intervalo,
	coalesce(hr_prim_horario,'  :  '),
	nr_sequencia,
	ie_agrupador,
	cd_material,
	qt_hora_intervalo,
	qt_min_intervalo,
	nr_ocorrencia,
	ds_dose_diferenciada,
	coalesce(ie_urgencia, 'N')
from	prescr_material
where	nr_prescricao	= nr_prescricao_p
and	ie_agrupador in (8,12,16,17);

c02 CURSOR FOR
SELECT	coalesce(hr_dose_especial,'  :  '),
	nr_sequencia
from	prescr_dieta
where	nr_prescricao	= nr_prescricao_p;


BEGIN

select	max(nr_atendimento),
	max(cd_estabelecimento),
	coalesce(max(nr_horas_validade),24)
into STRICT	nr_atendimento_w,
	cd_estabelecimento_w,
	nr_horas_validade_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

ie_atualiza_hor_agora_w := Obter_Param_Usuario(950, 71, cd_perfil_p, nm_usuario_p, cd_estabelecimento_w, ie_atualiza_hor_agora_w);

if (ie_acao_p	= 'A') then

	select	max(to_char(a.dt_fim + 1/1440,'hh24:mi'))
	into STRICT	hr_prim_hor_jejum_w
	from	rep_jejum a,
		prescr_medica b
	where	a.nr_prescricao 	= b.nr_prescricao
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	coalesce(a.ie_suspenso,'N')	<> 'S'
	and	dt_fim			> clock_timestamp()
	and	b.nr_atendimento	= nr_atendimento_w;

	open C01;
	loop
	fetch C01 into
		hr_dose_especial_w,
		cd_intervalo_w,
		hr_prim_horario_w,
		nr_sequencia_w,
		ie_agrupador_w,
		cd_material_w,
		qt_hora_intervalo_w,
		qt_min_intervalo_w,
		nr_ocorrencia_w,
		ds_dose_diferenciada_w,
		ie_urgencia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		if (hr_dose_especial_w		<> '  :  ') and (to_date(to_char(clock_timestamp(),'dd/mm/yyyy')||' '||hr_dose_especial_w,'dd/mm/yyyy hh24:mi:ss') > to_date(to_char(clock_timestamp(),'dd/mm/yyyy')||' '||hr_prim_hor_jejum_w,'dd/mm/yyyy hh24:mi:ss')) then

			update	prescr_material
			set	hr_dose_especial	= hr_prim_hor_jejum_w
			where	nr_prescricao		= nr_prescricao_p
			and	nr_sequencia		= nr_sequencia_w;

		end if;

		select	max(qt_operacao),
			max(ie_operacao)
		into STRICT	qt_operacao_w,
			ie_operacao_w
		from	intervalo_prescricao
		where	cd_intervalo	= cd_intervalo_w;

		if (hr_prim_horario_w	<> '  :  ') and
			(((ie_agrupador_w		= 8) and (qt_operacao_w		= 1) and (ie_operacao_w		= 'X') and (to_date(to_char(clock_timestamp(),'dd/mm/yyyy')||' '||hr_prim_horario_w,'dd/mm/yyyy hh24:mi:ss')	>
			   to_date(to_char(clock_timestamp(),'dd/mm/yyyy')||' '||hr_prim_hor_jejum_w,'dd/mm/yyyy hh24:mi:ss'))) or (ie_urgencia_w	= 'S')) then

			dt_primeiro_horario_w	:= to_date(to_char(clock_timestamp(),'dd/mm/yyyy')||' '||hr_prim_hor_jejum_w,'dd/mm/yyyy hh24:mi:ss');

			select	max(to_date(to_char(dt_inicio_prescr,'dd/mm/yyyy')||' '||hr_prim_hor_jejum_w,'dd/mm/yyyy hh24:mi:ss'))
			into STRICT	dt_inicio_w
			from	prescr_medica
			where	nr_prescricao	= nr_prescricao_p;

			SELECT * FROM Calcular_Horario_Prescricao(	nr_prescricao_p, cd_intervalo_w, dt_primeiro_horario_w, dt_inicio_w, nr_horas_validade_w, cd_material_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w, 'N', ds_dose_diferenciada_w) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w;

			ds_horarios_w	:= ds_horarios_w || ds_horarios2_w;

			update	prescr_material
			set	hr_prim_horario		= hr_prim_hor_jejum_w,
				ds_horarios		= ds_horarios_w
			where	nr_prescricao		= nr_prescricao_p
			and	nr_sequencia		= nr_sequencia_w;

		end if;

		end;
	end loop;
	close C01;

	open C02;
	loop
	fetch C02 into
		hr_dose_especial_w,
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		if (hr_dose_especial_w		<> '  :  ') and (to_date(to_char(clock_timestamp(),'dd/mm/yyyy')||' '||hr_dose_especial_w,'dd/mm/yyyy hh24:mi:ss') > to_date(to_char(clock_timestamp(),'dd/mm/yyyy')||' '||hr_prim_hor_jejum_w,'dd/mm/yyyy hh24:mi:ss')) then

			update	prescr_dieta
			set	hr_dose_especial	= hr_prim_hor_jejum_w
			where	nr_prescricao		= nr_prescricao_p
			and	nr_sequencia		= nr_sequencia_w;

		end if;

		end;
	end loop;
	close C02;

elsif (ie_atualiza_hor_agora_w	= 'S') then

	open C01;
	loop
	fetch C01 into
		hr_dose_especial_w,
		cd_intervalo_w,
		hr_prim_horario_w,
		nr_sequencia_w,
		ie_agrupador_w,
		cd_material_w,
		qt_hora_intervalo_w,
		qt_min_intervalo_w,
		nr_ocorrencia_w,
		ds_dose_diferenciada_w,
		ie_urgencia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		if (hr_dose_especial_w		<> '  :  ') then

			update	prescr_material
			set	hr_dose_especial	= to_char(clock_timestamp(),'hh24:mi')
			where	nr_prescricao		= nr_prescricao_p
			and	nr_sequencia		= nr_sequencia_w;

		end if;

		if (hr_prim_horario_w	<> '  :  ') and
			(((ie_agrupador_w		= 8) and (qt_operacao_w		= 1) and (ie_operacao_w		= 'X')) or (ie_urgencia_w	= 'S')) then

			SELECT * FROM Calcular_Horario_Prescricao(	nr_prescricao_p, cd_intervalo_w, clock_timestamp(), clock_timestamp(), nr_horas_validade_w, cd_material_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w, 'N', ds_dose_diferenciada_w) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w;

			ds_horarios_w	:= ds_horarios_w || ds_horarios2_w;

			update	prescr_material
			set	hr_prim_horario		= to_char(clock_timestamp(),'hh24:mi'),
				ds_horarios		= ds_horarios_w
			where	nr_prescricao		= nr_prescricao_p
			and	nr_sequencia		= nr_sequencia_w;

		end if;

		end;
	end loop;
	close C01;

	open C02;
	loop
	fetch C02 into
		hr_dose_especial_w,
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		if (hr_dose_especial_w		<> '  :  ') then

			update	prescr_dieta
			set	hr_dose_especial	= to_char(clock_timestamp(),'hh24:mi')
			where	nr_prescricao		= nr_prescricao_p
			and	nr_sequencia		= nr_sequencia_w;

		end if;

		end;
	end loop;
	close C02;

end if;

CALL gerar_horarios_sem_lib(nr_prescricao_p, nm_usuario_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_horario_nut_jejum ( nr_prescricao_p bigint, ie_acao_p text, nm_usuario_p text, cd_perfil_p bigint) FROM PUBLIC;

