-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_arquivo_ipasgo ( dt_mesano_referencia_p timestamp, cd_convenio_p bigint, nm_usuario_p text, ie_tipo_protocolo_p protocolo_convenio.ie_tipo_protocolo%type, ie_tipo_atendimento_p atendimento_paciente.ie_tipo_atendimento%type) AS $body$
DECLARE



dt_mesano_referencia_w		timestamp 		:= trunc(dt_mesano_referencia_p,'mm');
cd_estabelecimento_w		smallint	:= 0;
cd_estab_atual_w		smallint 	:= Wheb_usuario_pck.get_cd_estabelecimento;
qt_guia_w			bigint;
qt_linha_arq_w			bigint := 0;
qt_linha_atend_w		bigint := 0;
ie_so_estab_atual_w		varchar(01)	:= 'N';
cd_cgc_w			estabelecimento.cd_cgc%type;
ie_regra_ipasgo_w		parametro_faturamento.ie_regra_ipasgo%type;
cd_prestador_convenio_w		convenio_prestador.cd_prestador_convenio%type;
vl_atendimento_w		w_ipasgo_dados_gerais_at.vl_atendimento%type;
vl_apresentado_w		w_ipasgo_dados_gerais_fat.vl_apresentado%type;
ds_list_estab_w			varchar(255);
nr_seq_prot_vig_w		protocolo_convenio.nr_seq_protocolo%type;

c00 CURSOR(     cd_estabelecimento_pp	bigint,
                ds_list_estab_pp        text) FOR
	SELECT	min(nr_sequencia) nr_seq_tipo_fatura,
		cd_tipo_fatura,
		cd_estabelecimento
	from	fatur_tipo_fatura
	where	ie_situacao = 'A'
	and	((cd_estabelecimento = cd_estabelecimento_pp) or (coalesce(ds_list_estab_pp,'X') <> 'X' and obter_se_contido(coalesce(cd_estabelecimento,ds_list_estab_pp), ds_list_estab_pp) = 'S') or (cd_estabelecimento_pp = 0 AND coalesce(ds_list_estab_pp,'X') = 'X'))
	group by	cd_tipo_fatura,
			cd_estabelecimento
	order by	2;

c01 CURSOR(	dt_mesano_referencia_pp	timestamp,
			cd_convenio_pp			bigint,
			nr_seq_tipo_fatura_pp	bigint,
			cd_estabelecimento_pp	bigint,
			ie_tipo_protocolo_pp	protocolo_convenio.ie_tipo_protocolo%type,
			ie_tipo_atendimento_pp	atendimento_paciente.ie_tipo_atendimento%type,
			cd_tipo_fatura_pp		bigint,
			ds_list_estab_pp		text) FOR
SELECT	a.nr_seq_protocolo,
	b.nr_interno_conta
from	atendimento_paciente c,
	conta_paciente b,
	protocolo_convenio a
where	a.dt_mesano_referencia 	between dt_mesano_referencia_pp and fim_mes(dt_mesano_referencia_pp)
and	a.cd_convenio		= cd_convenio_pp
and	c.nr_atendimento		= b.nr_atendimento
and	a.ie_status_protocolo	= 2
and	b.nr_seq_protocolo		= a.nr_seq_protocolo
and	b.nr_seq_tipo_fatura	= nr_seq_tipo_fatura_pp
and	a.cd_estabelecimento	= cd_estabelecimento_pp
and	cd_estabelecimento_pp	<> 0
and	((a.ie_tipo_protocolo = coalesce(ie_tipo_protocolo_pp,0)) or (coalesce(ie_tipo_protocolo_pp,0) = 0))
and	((c.ie_tipo_atendimento = coalesce(ie_tipo_atendimento_pp,0)) or (coalesce(ie_tipo_atendimento_pp,0) = 0))
and	coalesce(ds_list_estab_pp::text, '') = ''

union all

SELECT	a.nr_seq_protocolo,
	b.nr_interno_conta
from	fatur_tipo_fatura f,
	atendimento_paciente c,
	conta_paciente b,
	protocolo_convenio a
where	a.dt_mesano_referencia 	between dt_mesano_referencia_pp and fim_mes(dt_mesano_referencia_pp)
and	a.cd_convenio		= cd_convenio_pp
and	c.nr_atendimento		= b.nr_atendimento
and	a.ie_status_protocolo	= 2
and	b.nr_seq_protocolo		= a.nr_seq_protocolo
and	b.nr_seq_tipo_fatura	= f.nr_sequencia
and	f.cd_tipo_fatura		= cd_tipo_fatura_pp
and	cd_estabelecimento_pp 	= 0
and	((a.ie_tipo_protocolo = coalesce(ie_tipo_protocolo_pp,0)) or (coalesce(ie_tipo_protocolo_pp,0) = 0))
and	((c.ie_tipo_atendimento = coalesce(ie_tipo_atendimento_pp,0)) or (coalesce(ie_tipo_atendimento_pp,0) = 0))
and	coalesce(ds_list_estab_pp::text, '') = ''

union all

select	a.nr_seq_protocolo,
	b.nr_interno_conta
from	fatur_tipo_fatura f,
	atendimento_paciente c,
	conta_paciente b,
	protocolo_convenio a
where	a.dt_mesano_referencia 	between dt_mesano_referencia_pp and fim_mes(dt_mesano_referencia_pp)
and	a.cd_convenio		= cd_convenio_pp
and	c.nr_atendimento		= b.nr_atendimento
and	a.ie_status_protocolo	= 2
and	b.nr_seq_protocolo		= a.nr_seq_protocolo
and	b.nr_seq_tipo_fatura	= f.nr_sequencia
and     f.nr_sequencia		= nr_seq_tipo_fatura_pp
and obter_se_contido(coalesce(a.cd_estabelecimento,ds_list_estab_pp), ds_list_estab_pp) = 'S'
and	((a.ie_tipo_protocolo = coalesce(ie_tipo_protocolo_pp,0)) or (coalesce(ie_tipo_protocolo_pp,0) = 0))
and	((c.ie_tipo_atendimento = coalesce(ie_tipo_atendimento_pp,0)) or (coalesce(ie_tipo_atendimento_pp,0) = 0))
order by 1, 2;

c00_w      c00%rowtype;
c01_w      c01%rowtype;


BEGIN

ie_so_estab_atual_w := obter_param_usuario(999, 62, obter_perfil_Ativo, nm_usuario_p, cd_estab_atual_w, ie_so_estab_atual_w);
ds_list_estab_w := obter_param_usuario(999, 103, obter_perfil_Ativo, nm_usuario_p, cd_estab_atual_w, ds_list_estab_w);

delete from w_ipasgo_dados_gerais_pr 	where nm_usuario = nm_usuario_p and dt_mesano_referencia = dt_mesano_referencia_w;
delete from w_ipasgo_dados_gerais_fat 	where nm_usuario = nm_usuario_p and dt_mesano_referencia = dt_mesano_referencia_w;
delete from w_ipasgo_dados_gerais_at 	where nm_usuario = nm_usuario_p and dt_mesano_referencia = dt_mesano_referencia_w;
delete from w_ipasgo_dados_guia_sec 	where nm_usuario = nm_usuario_p and dt_mesano_referencia = dt_mesano_referencia_w;
delete from w_ipasgo_dados_trat 	where nm_usuario = nm_usuario_p and dt_mesano_referencia = dt_mesano_referencia_w;
delete from w_ipasgo_dados_ato_trat 	where nm_usuario = nm_usuario_p and dt_mesano_referencia = dt_mesano_referencia_w;
delete from w_ipasgo_dados_proc_trat 	where nm_usuario = nm_usuario_p and dt_mesano_referencia = dt_mesano_referencia_w;
delete from w_ipasgo_dados_prof_trat 	where nm_usuario = nm_usuario_p and dt_mesano_referencia = dt_mesano_referencia_w;
delete from w_ipasgo_dados_desp_trat 	where nm_usuario = nm_usuario_p and dt_mesano_referencia = dt_mesano_referencia_w;
delete from w_ipasgo_dados_matmed_trat where nm_usuario = nm_usuario_p and dt_mesano_referencia = dt_mesano_referencia_w;
delete from w_ipasgo_dados_exame_trat where nm_usuario = nm_usuario_p and dt_mesano_referencia = dt_mesano_referencia_w;

if (coalesce(ie_so_estab_atual_w,'S') = 'S') then
	cd_estabelecimento_w := cd_estab_atual_w;
end if;

select	obter_cgc_estabelecimento(cd_estab_atual_w)
into STRICT	cd_cgc_w
;

select	coalesce(max(cd_prestador_convenio),'00000000')
into STRICT	cd_prestador_convenio_w
from	convenio_prestador
where	cd_convenio = cd_convenio_p
and	cd_cgc = cd_cgc_w;

select	coalesce(max(ie_regra_ipasgo),'N')
into STRICT	ie_regra_ipasgo_w
from	parametro_faturamento
where	cd_estabelecimento = cd_estab_atual_w; 	

qt_linha_arq_w := gerar_w_ipasgo_dad_gerais_pr(dt_mesano_referencia_w, cd_convenio_p, nm_usuario_p, cd_estab_atual_w, 0, qt_linha_arq_w);	--Registro 0
for  	c00_w in c00(   cd_estabelecimento_w,
                        ds_list_estab_w) loop
	begin
	select	count(*)
	into STRICT	qt_guia_w
	from	fatur_tipo_fatura f,
		atendimento_paciente c,
		conta_paciente b,
		protocolo_convenio a
	where	a.dt_mesano_referencia 	between dt_mesano_referencia_w and fim_mes(dt_mesano_referencia_w)
	and	a.cd_convenio		= cd_convenio_p
	and	c.nr_atendimento		= b.nr_atendimento
	and	a.ie_status_protocolo	= 2
	and	b.nr_seq_protocolo		= a.nr_seq_protocolo
	and	b.nr_seq_tipo_fatura	= f.nr_sequencia
	and	f.cd_tipo_fatura		= c00_w.cd_tipo_fatura
	and (a.cd_estabelecimento	= c00_w.cd_estabelecimento or c00_w.cd_estabelecimento = 0)
	and	((a.ie_tipo_protocolo = coalesce(ie_tipo_protocolo_p,0)) or (coalesce(ie_tipo_protocolo_p,0) = 0))
	and	((c.ie_tipo_atendimento = coalesce(ie_tipo_atendimento_p,0)) or (coalesce(ie_tipo_atendimento_p,0) = 0));
	
	if (qt_guia_w > 0) then
		begin
		qt_linha_arq_w := gerar_w_ipasgo_dad_gerais_fat(dt_mesano_referencia_w, cd_convenio_p, c00_w.nr_seq_tipo_fatura, c00_w.cd_estabelecimento, nm_usuario_p, qt_linha_arq_w);	--Registro 1
		for  	c01_w in c01(	dt_mesano_referencia_w,
								cd_convenio_p,
								c00_w.nr_seq_tipo_fatura,
								c00_w.cd_estabelecimento,
								ie_tipo_protocolo_p,
								ie_tipo_atendimento_p,
								c00_w.cd_tipo_fatura,
								ds_list_estab_w) loop
			begin
			
	/*Registro 2*/
	SELECT * FROM gerar_w_ipasgo_dados_gerais_at(c01_w.nr_interno_conta, dt_mesano_referencia_w, nm_usuario_p, c00_w.nr_seq_tipo_fatura, qt_linha_arq_w, qt_linha_atend_w) INTO STRICT qt_linha_arq_w, qt_linha_atend_w;

			if (c00_w.cd_tipo_fatura in (4,17)) then
	/*Registro 3*/
		SELECT * FROM gerar_w_ipasgo_dados_guia_sec(c01_w.nr_interno_conta, dt_mesano_referencia_w, nm_usuario_p, c00_w.nr_seq_tipo_fatura, qt_linha_arq_w, qt_linha_atend_w) INTO STRICT qt_linha_arq_w, qt_linha_atend_w;
			end if;
			if (c00_w.cd_tipo_fatura in (3,4,5,6,8,9,17)) then
	/*Registro 4*/
		SELECT * FROM gerar_w_ipasgo_dados_trat(c01_w.nr_interno_conta, dt_mesano_referencia_w, nm_usuario_p, c00_w.nr_seq_tipo_fatura, qt_linha_arq_w, qt_linha_atend_w) INTO STRICT qt_linha_arq_w, qt_linha_atend_w;
			end if;
			if (c00_w.cd_tipo_fatura in (3,4,5,6,8,9,17)) then
	/*Registro 5*/
		SELECT * FROM gerar_w_ipasgo_dados_ato_tr(c01_w.nr_interno_conta, dt_mesano_referencia_w, nm_usuario_p, c00_w.nr_seq_tipo_fatura, qt_linha_arq_w, qt_linha_atend_w) INTO STRICT qt_linha_arq_w, qt_linha_atend_w;
			end if;
			if (c00_w.cd_tipo_fatura in (3,4,5,6,8,17)) then
				if (ie_regra_ipasgo_w = 'S') then
	/*Registro 6*/
			SELECT * FROM gerar_ipasgo_dados_proc_trat_w(c01_w.nr_interno_conta, dt_mesano_referencia_w, nm_usuario_p, c00_w.nr_seq_tipo_fatura, qt_linha_arq_w, qt_linha_atend_w) INTO STRICT qt_linha_arq_w, qt_linha_atend_w;
				else
	/*Registro 6*/
			SELECT * FROM gerar_w_ipasgo_dados_proc_trat(c01_w.nr_interno_conta, dt_mesano_referencia_w, nm_usuario_p, c00_w.nr_seq_tipo_fatura, qt_linha_arq_w, qt_linha_atend_w) INTO STRICT qt_linha_arq_w, qt_linha_atend_w;
				end if;
			end if;
			if (c00_w.cd_tipo_fatura in (3,4,5,6,17)) then
				if (ie_regra_ipasgo_w = 'S') then
	/*Registro 7*/
			SELECT * FROM gerar_ipasgo_dados_prof_trat_w(c01_w.nr_interno_conta, dt_mesano_referencia_w, nm_usuario_p, c00_w.nr_seq_tipo_fatura, qt_linha_arq_w, qt_linha_atend_w) INTO STRICT qt_linha_arq_w, qt_linha_atend_w;
				else
	/*Registro 7*/
			SELECT * FROM gerar_w_ipasgo_dados_prof_trat(c01_w.nr_interno_conta, dt_mesano_referencia_w, nm_usuario_p, c00_w.nr_seq_tipo_fatura, qt_linha_arq_w, qt_linha_atend_w) INTO STRICT qt_linha_arq_w, qt_linha_atend_w;
				end if;
			end if;
			if (c00_w.cd_tipo_fatura in (3,4,6,8,9,17)) then
				if (ie_regra_ipasgo_w = 'S') then
	/*Registro 8*/
			SELECT * FROM gerar_ipasgo_dados_desp_trat_w(c01_w.nr_interno_conta, dt_mesano_referencia_w, nm_usuario_p, c00_w.nr_seq_tipo_fatura, qt_linha_arq_w, qt_linha_atend_w) INTO STRICT qt_linha_arq_w, qt_linha_atend_w;
				else
	/*Registro 8*/
			SELECT * FROM gerar_w_ipasgo_dados_desp_trat(c01_w.nr_interno_conta, dt_mesano_referencia_w, nm_usuario_p, c00_w.nr_seq_tipo_fatura, qt_linha_arq_w, qt_linha_atend_w) INTO STRICT qt_linha_arq_w, qt_linha_atend_w;
				end if;
			end if;
			if (c00_w.cd_tipo_fatura in (3,4,6,8,9,17)) then
	/*Registro 9*/
		SELECT * FROM gerar_w_ipasgo_dados_matmed_tr(c01_w.nr_interno_conta, dt_mesano_referencia_w, nm_usuario_p, c00_w.nr_seq_tipo_fatura, qt_linha_arq_w, qt_linha_atend_w) INTO STRICT qt_linha_arq_w, qt_linha_atend_w; -- Este tambem vai no pacote de objetos
			end if;
			if (c00_w.cd_tipo_fatura in (4,9,17)) then
	/*Registro 10*/
		SELECT * FROM gerar_w_ipasgo_dados_exame_tr(c01_w.nr_interno_conta, dt_mesano_referencia_w, nm_usuario_p, c00_w.nr_seq_tipo_fatura, qt_linha_arq_w, qt_linha_atend_w) INTO STRICT qt_linha_arq_w, qt_linha_atend_w;
			end if;
			
			if (c00_w.cd_tipo_fatura <> 2) then
				begin
			
				select  sum(x.vl_item)
				into STRICT	vl_atendimento_w
				from (	SELECT  sum(a.vl_servico) vl_item
					from    w_ipasgo_dados_desp_trat a
					where	a.nr_interno_conta = c01_w.nr_interno_conta
					and	a.nr_matricula_prestador = cd_prestador_convenio_w
					and	a.nm_usuario = nm_usuario_p
					and	a.dt_mesano_referencia = dt_mesano_referencia_w
					
union

					SELECT  sum(b.vl_honorario)
					from    w_ipasgo_dados_prof_trat b
					where	b.nr_interno_conta = c01_w.nr_interno_conta
					and	b.nr_matricula_prestador = cd_prestador_convenio_w
					and	b.nm_usuario = nm_usuario_p
					and	b.dt_mesano_referencia = dt_mesano_referencia_w
					
union
 
					select  sum(c.vl_matmed)
					from    w_ipasgo_dados_matmed_trat c
					where	c.nr_interno_conta = c01_w.nr_interno_conta
					and	c.nr_matricula_prestador = cd_prestador_convenio_w 
					and	c.nm_usuario = nm_usuario_p
					and	c.dt_mesano_referencia = dt_mesano_referencia_w
					
union
 
					select  sum(d.vl_exame)
					from	w_ipasgo_dados_exame_trat d
					where	d.nr_interno_conta = c01_w.nr_interno_conta
					and	d.nr_matricula_prestador = cd_prestador_convenio_w
					and	d.nm_usuario = nm_usuario_p
					and	d.dt_mesano_referencia = dt_mesano_referencia_w) x;
					
				update	w_ipasgo_dados_gerais_at
				set	vl_atendimento 	= vl_atendimento_w,
					vl_atendimento_gravado = replace(replace(Campo_Mascara_virgula_casas(vl_atendimento_w,4),'.',''),',','.'),
					ds_linha = 	nr_linha || '|' ||
							'2' || '|' ||
							nr_linha_atend || '|' ||	
							cd_tipo_fatura || '|' || 
							nr_guia || '|' || 
							to_char(dt_atendimento,'YYYY-MM-DD') || '|' ||
							replace(replace(Campo_Mascara_virgula_casas(vl_atendimento_w,4),'.',''),',','.') || '|' ||
							cd_cid_principal || '|' || 
							cd_cid_2 || '|' ||
							'||||'
				where	nr_interno_conta = c01_w.nr_interno_conta
				and	nm_usuario = nm_usuario_p 
				and	dt_mesano_referencia = dt_mesano_referencia_w;
				
				if (nr_seq_prot_vig_w	<>	c01_w.nr_seq_protocolo) then
					update	protocolo_convenio	
					set	dt_envio = clock_timestamp(),
						nm_usuario_envio = nm_usuario_p,
						dt_atualizacao = clock_timestamp(),
						nm_usuario = nm_usuario_p
					where	nr_seq_protocolo = c01_w.nr_seq_protocolo;
					
					nr_seq_prot_vig_w	:=	c01_w.nr_seq_protocolo;
				end if;
				
				end;
			end if;
			
			end;
		end loop;
		
                if (coalesce(ds_list_estab_w,'X') = 'X') then
                        select	sum(vl_atendimento)
                        into STRICT	vl_apresentado_w
                        from	w_ipasgo_dados_gerais_at
                        where	nm_usuario = nm_usuario_p
                        and	dt_mesano_referencia = dt_mesano_referencia_w
                        and	nr_seq_tipo_fatura = c00_w.nr_seq_tipo_fatura;

                        update	w_ipasgo_dados_gerais_fat 
                        set	vl_apresentado	= vl_apresentado_w,
                                ds_linha =	nr_linha || '|' ||
                                                '1' || '|' ||
                                                tp_fatura || '|' || 
                                                qt_guia || '|' || 
                                                replace(replace(Campo_Mascara_virgula_casas(vl_apresentado_w,4),'.',''),',','.') || '|||||||||'
                        where	nm_usuario = nm_usuario_p 
                        and	dt_mesano_referencia = dt_mesano_referencia_w
                        and	nr_seq_tipo_fatura = c00_w.nr_seq_tipo_fatura;
                else
                        select	sum(vl_atendimento)
                        into STRICT	vl_apresentado_w
                        from	w_ipasgo_dados_gerais_at
                        where	nm_usuario = nm_usuario_p
                        and	dt_mesano_referencia = dt_mesano_referencia_w
                        and	cd_tipo_fatura = c00_w.cd_tipo_fatura;

                        update	w_ipasgo_dados_gerais_fat 
                        set	vl_apresentado	= vl_apresentado_w,
                                ds_linha =	nr_linha || '|' ||
                                                '1' || '|' ||
                                                tp_fatura || '|' || 
                                                qt_guia || '|' || 
                                                replace(replace(Campo_Mascara_virgula_casas(vl_apresentado_w,4),'.',''),',','.') || '|||||||||'
                        where	nm_usuario = nm_usuario_p 
                        and	dt_mesano_referencia = dt_mesano_referencia_w
                        and	nr_seq_tipo_fatura in ( SELECT   nr_sequencia
                                                        from    fatur_tipo_fatura
                                                        where   cd_tipo_fatura = c00_w.cd_tipo_fatura
                                                        and     ie_situacao = 'A'
                                                        and     obter_se_contido(coalesce(cd_estabelecimento,ds_list_estab_w), ds_list_estab_w) = 'S');
                end if;
		end;
	end if;
	end;
end loop;

  -- OS 645845 - RF 03 - Adicionar a chamada para a rotina de consist?ncia
  CALL consistir_arquivo_ipasgo(     dt_mesano_referencia_p,
                                cd_convenio_p,
                                ie_tipo_protocolo_p,
                                ie_tipo_atendimento_p,
                                cd_estab_atual_w,
                                nm_usuario_p );

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_arquivo_ipasgo ( dt_mesano_referencia_p timestamp, cd_convenio_p bigint, nm_usuario_p text, ie_tipo_protocolo_p protocolo_convenio.ie_tipo_protocolo%type, ie_tipo_atendimento_p atendimento_paciente.ie_tipo_atendimento%type) FROM PUBLIC;

