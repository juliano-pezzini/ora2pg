-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atend_categ_atrchange_eup_js ( ie_convenio_insert_p text, cd_categoria_p text, cd_plano_p text, cd_carater_int_p text, ie_clinica_p bigint, nr_seq_classificacao_p bigint, cd_procedencia_p bigint, ie_convenio_edit_p text, cd_convenio_old_p bigint, cd_convenio_p bigint, nr_atendimento_p bigint, ie_tipo_atendimento_p bigint, cd_estabelecimento_p bigint, ie_tipo_guia_p text, nm_usuario_p text, cd_pessoa_fisica_p pessoa_titular_convenio.cd_pessoa_fisica%TYPE default null, nr_doc_convenio_p INOUT text DEFAULT NULL, ie_bloqueia_guia_p INOUT text DEFAULT NULL, ie_bloqueia_senha_p INOUT text DEFAULT NULL, ie_bloqueia_plano_p INOUT text DEFAULT NULL, ie_bloqueia_carteira_p INOUT text DEFAULT NULL, ie_bloqueia_validade_p INOUT text DEFAULT NULL, ie_bloqueia_usuario_p INOUT text DEFAULT NULL, cd_tipo_acomod_p INOUT text DEFAULT NULL, cd_categ_retorno_p INOUT text DEFAULT NULL, ds_mascara_compl_p INOUT text DEFAULT NULL) AS $body$
DECLARE


cd_estabelecimento_w 		smallint;
ie_atualizar_guia_w		varchar(1);
ie_bloqueia_guia_w	varchar(3);
ie_bloqueia_senha_w	varchar(3);
ie_bloqueia_plano_w	varchar(3);
ie_bloqueia_carteira_w	varchar(3);
ie_bloqueia_validade_w	varchar(3);
ie_bloqueia_usuario_w	varchar(3);
ie_sugere_tipo_acomod_w	varchar(3);
qt_regra_acomodacao_w	bigint;
cd_tipo_acomodacao_w	smallint;
cd_conv_bloqueio_w	varchar(10);
is_conveniio_w varchar(1) := 'N';

BEGIN

select CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
into STRICT is_conveniio_w
from convenio
where CD_CONVENIO = cd_convenio_p;

if (is_conveniio_w = 'S') then

  cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;

  ie_sugere_tipo_acomod_w := Obter_param_Usuario(916, 112, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_sugere_tipo_acomod_w);
  ie_atualizar_guia_w := Obter_param_Usuario(916, 375, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_atualizar_guia_w);

  if (ie_convenio_edit_p = 'S') and (ie_atualizar_guia_w = 'S') and (coalesce(cd_convenio_p,0) <> coalesce(cd_convenio_old_p,0)) then
    nr_doc_convenio_p := obter_guia_conv_atend(nr_atendimento_p, cd_convenio_p, cd_categoria_p, ie_tipo_atendimento_p, cd_estabelecimento_p, ie_tipo_guia_p, nr_doc_convenio_p, null, null);

  end if;

  if	((ie_sugere_tipo_acomod_w = 'N') or (ie_sugere_tipo_acomod_w = 'SC')) and (ie_sugere_tipo_acomod_w <> 'NA') then
    cd_tipo_acomod_p	:= 0;
  end if;

  if	((ie_convenio_edit_p = 'S') or (ie_convenio_insert_p = 'S')) and
    ((ie_sugere_tipo_acomod_w <> 'N') or (ie_sugere_tipo_acomod_w <> 'SC')) and (ie_sugere_tipo_acomod_w <> 'NA') then
  
    select	count(*)
    into STRICT	qt_regra_acomodacao_w
    from	regra_convenio_tipo_acomod
    where	cd_convenio = cd_convenio_p;
    if (coalesce(qt_regra_acomodacao_w,0) > 0) then
      cd_tipo_acomodacao_w := obter_regra_convenio_acomod(cd_convenio_p);

      if (coalesce(cd_tipo_acomodacao_w,0) > 0) then
        cd_tipo_acomod_p := cd_tipo_acomodacao_w;
      end if;
    end if;
  end if;

  if (ie_sugere_tipo_acomod_w = 'SC') or (ie_sugere_tipo_acomod_w = 'S') then
    cd_categ_retorno_p := obter_regra_categoria_convenio(cd_convenio_p);
  end if;

  select	ds_mascara_compl
  into STRICT	ds_mascara_compl_p
  from	convenio
  where	cd_convenio = cd_convenio_p;

  if (cd_categ_retorno_p <> 0) and (cd_categ_retorno_p IS NOT NULL AND cd_categ_retorno_p::text <> '') then
    cd_conv_bloqueio_w := cd_categ_retorno_p;
  else
    cd_conv_bloqueio_w := cd_convenio_p;
  end if;

  SELECT * FROM eup_verif_bloqueio_inf_conv_js(cd_estabelecimento_w, cd_convenio_p, cd_conv_bloqueio_w, ie_tipo_atendimento_p, cd_plano_p, cd_carater_int_p, ie_clinica_p, nr_seq_classificacao_p, cd_procedencia_p, ie_bloqueia_guia_w, ie_bloqueia_senha_w, ie_bloqueia_plano_w, ie_bloqueia_carteira_w, ie_bloqueia_validade_w, ie_bloqueia_usuario_w) INTO STRICT ie_bloqueia_guia_w, ie_bloqueia_senha_w, ie_bloqueia_plano_w, ie_bloqueia_carteira_w, ie_bloqueia_validade_w, ie_bloqueia_usuario_w;

  ie_bloqueia_guia_p := ie_bloqueia_guia_w;
  ie_bloqueia_senha_p := ie_bloqueia_senha_w;
  ie_bloqueia_plano_p := ie_bloqueia_plano_w;
  ie_bloqueia_carteira_p := ie_bloqueia_carteira_w;
  ie_bloqueia_validade_p := ie_bloqueia_validade_w;
  ie_bloqueia_usuario_p := ie_bloqueia_usuario_w;

  commit;

end if;

end;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atend_categ_atrchange_eup_js ( ie_convenio_insert_p text, cd_categoria_p text, cd_plano_p text, cd_carater_int_p text, ie_clinica_p bigint, nr_seq_classificacao_p bigint, cd_procedencia_p bigint, ie_convenio_edit_p text, cd_convenio_old_p bigint, cd_convenio_p bigint, nr_atendimento_p bigint, ie_tipo_atendimento_p bigint, cd_estabelecimento_p bigint, ie_tipo_guia_p text, nm_usuario_p text, cd_pessoa_fisica_p pessoa_titular_convenio.cd_pessoa_fisica%TYPE default null, nr_doc_convenio_p INOUT text DEFAULT NULL, ie_bloqueia_guia_p INOUT text DEFAULT NULL, ie_bloqueia_senha_p INOUT text DEFAULT NULL, ie_bloqueia_plano_p INOUT text DEFAULT NULL, ie_bloqueia_carteira_p INOUT text DEFAULT NULL, ie_bloqueia_validade_p INOUT text DEFAULT NULL, ie_bloqueia_usuario_p INOUT text DEFAULT NULL, cd_tipo_acomod_p INOUT text DEFAULT NULL, cd_categ_retorno_p INOUT text DEFAULT NULL, ds_mascara_compl_p INOUT text DEFAULT NULL) FROM PUBLIC;

