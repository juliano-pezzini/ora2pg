-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE delete_material_lote_fornec ( nr_sequencia_p bigint) AS $body$
DECLARE


nr_seq_op_opm_w	bigint;
ie_estoque_lote_w		material_estab.ie_estoque_lote%type;
ie_consignado_w			smallint;
cd_material_w			material.cd_material%type;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
qt_existe_w		integer;


BEGIN
select   max(b.nr_seq_op_opm)
into STRICT      nr_seq_op_opm_w
from     material_lote_fornec a,
            lote_producao b 
where   a.nr_sequencia = nr_sequencia_p
and      a.nr_lote_producao = b.nr_lote_producao;

select	cd_material,
        cd_estabelecimento
into STRICT	cd_material_w,
        cd_estabelecimento_w
from	material_lote_fornec
where	nr_sequencia = nr_sequencia_p;

select ie_consignado
into STRICT ie_consignado_w
from material
where cd_material = cd_material_w;

ie_estoque_lote_w := obter_se_material_estoque_lote(cd_estabelecimento_w,cd_material_w);

if (ie_estoque_lote_w = 'S') and (ie_consignado_w = '0') then
        select	count(*)
        into STRICT	qt_existe_w
        from	lote_fornec_utilizado_v
        where	nr_seq_lote_fornec = nr_sequencia_p;

        if (qt_existe_w = 0) then
                    
            delete FROM saldo_estoque_lote
            where nr_seq_lote = nr_sequencia_p;

            update movimento_estoque
            set NR_SEQ_LOTE_FORNEC  = NULL
            where NR_SEQ_LOTE_FORNEC = nr_sequencia_p;

        end if;
end if;


delete from 	material_lote_fornec 
where 		nr_sequencia = nr_sequencia_p;

commit;

 if (coalesce(nr_seq_op_opm_w,0) > 0) then
      CALL gravar_status_op_opm(nr_seq_op_opm_w,'AELF',null,wheb_usuario_pck.get_nm_usuario,wheb_usuario_pck.get_cd_estabelecimento);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE delete_material_lote_fornec ( nr_sequencia_p bigint) FROM PUBLIC;

