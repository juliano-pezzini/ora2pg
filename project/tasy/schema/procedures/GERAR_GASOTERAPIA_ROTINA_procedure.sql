-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_gasoterapia_rotina ( nr_seq_item_protocolo_p bigint, nr_prescricao_p bigint, nm_usuario_p text, qt_gasoterapia_p bigint default null, ie_unidade_medida_p text default null, cd_intervalo_p text default null, cd_intervalo_gas_p text default null) AS $body$
DECLARE


nr_seq_gasoterapia_w	bigint;
cd_protocolo_w			bigint;
nr_seq_prot_w			integer;
qt_peso_w				real;
nr_dia_util_w			integer;
nr_seq_gas_w			bigint;
qt_min_intervalo_w		integer;
dt_prescricao_w			timestamp;
nr_atendimento_w		bigint;
qt_gasoterapia_w		double precision;
ie_unidade_medida_w		varchar(15);
cd_intervalo_w			varchar(15);
nr_intervalo_w			bigint;
ds_horarios_w			varchar(255);
ds_horarios_ww			varchar(255);
dt_prim_horario_w		timestamp;
dt_inicio_prescr_w		timestamp;
nr_horas_validade_w		bigint;
ie_limpa_prim_hor_w		intervalo_prescricao.ie_limpa_prim_hor%type;
ie_inicio_w				varchar(15);


BEGIN

select	nextval('prescr_gasoterapia_seq')
into STRICT	nr_seq_gasoterapia_w
;

select	max(nr_atendimento),
		max(dt_prescricao),
		max(dt_primeiro_horario),
		max(dt_inicio_prescr),
		max(nr_horas_validade)
into STRICT	nr_atendimento_w,
		dt_prescricao_w,
		dt_prim_horario_w,
		dt_inicio_prescr_w,
		nr_horas_validade_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

select	max(nr_seq_gas),
		max(qt_gasoterapia),
		max(ie_unidade_medida),
		max(cd_intervalo),
		max(ie_inicio)
into STRICT	nr_seq_gas_w,
		qt_gasoterapia_w,
		ie_unidade_medida_w,
		cd_intervalo_w,
		ie_inicio_w
from	protocolo_medic_gas
where	nr_sequencia	= nr_seq_item_protocolo_p;


if (qt_gasoterapia_p IS NOT NULL AND qt_gasoterapia_p::text <> '') then
	qt_gasoterapia_w	:= qt_gasoterapia_p;
end if;

if (ie_unidade_medida_p IS NOT NULL AND ie_unidade_medida_p::text <> '') then
	ie_unidade_medida_w	:= ie_unidade_medida_p;
end if;

select  coalesce(max(a.nr_dia_util),0) + 1
into STRICT	nr_dia_util_w
from    prescr_gasoterapia a,
		prescr_medica b
where   a.nr_prescricao          = b.nr_prescricao
and     trunc(b.dt_prescricao)   = trunc(dt_prescricao_w - 1)
and     b.nr_atendimento	 = nr_atendimento_w
and     a.nr_seq_gas		 = nr_seq_gas_w
and     b.nr_prescricao          <> nr_prescricao_p
and     coalesce(b.dt_suspensao::text, '') = ''
and     coalesce(a.dt_suspensao::text, '') = '';

select	coalesce(max(qt_min_intervalo),0),
		coalesce(max(ie_limpa_prim_hor),'N')
into STRICT	qt_min_intervalo_w,
		ie_limpa_prim_hor_w
from	intervalo_prescricao
where	cd_intervalo	= coalesce(cd_intervalo_gas_p,cd_intervalo_w);

if ((coalesce(cd_intervalo_gas_p,cd_intervalo_w) IS NOT NULL AND (coalesce(cd_intervalo_gas_p,cd_intervalo_w))::text <> '')) then
	SELECT * FROM Calcular_Horario_Prescricao(	nr_prescricao_p, coalesce(cd_intervalo_gas_p,cd_intervalo_w), dt_prim_horario_w, dt_inicio_prescr_w, nr_horas_validade_w, 0, 0, qt_min_intervalo_w, nr_intervalo_w, ds_horarios_w, ds_horarios_ww, 'N', null) INTO STRICT nr_intervalo_w, ds_horarios_w, ds_horarios_ww;
end if;

if (coalesce(ie_inicio_w::text, '') = '') then
	select	max(CASE WHEN ie_acm='S' THEN 'ACM'  ELSE CASE WHEN ie_se_necessario='S' THEN 'D'  ELSE '' END  END )
	into STRICT 	ie_inicio_w
	from    intervalo_prescricao
	where	coalesce(ie_gasoterapia,'N') = 'S'
	and     cd_intervalo = coalesce(cd_intervalo_gas_p,cd_intervalo_w);
end if;

if (ie_inicio_w = 'ACM') or (ie_inicio_w = 'D') then
	dt_inicio_prescr_w := null;
end if;

insert into prescr_gasoterapia(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ie_respiracao,
		ie_disp_resp_esp,
		cd_modalidade_vent,
		nr_seq_gas,
		ie_modo_adm,
		ie_inicio,
		ie_unidade_medida,
		qt_gasoterapia,
		qt_freq_vent,
		ds_observacao,
		nr_prescricao,
		ie_suspenso,
		nr_seq_item_rotina,
		nr_dia_util,
		cd_intervalo,
		ds_horarios,
		dt_prev_execucao)
SELECT	nr_seq_gasoterapia_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		ie_respiracao,
		ie_disp_resp_esp,
		cd_modalidade_vent,
		nr_seq_gas,
		ie_modo_adm,
		ie_inicio_w,
		ie_unidade_medida_w,
		qt_gasoterapia_w,
		qt_freq_vent,
		ds_observacao,
		nr_prescricao_p,
		'N',
		nr_seq_item_protocolo_p,
		nr_dia_util_w,
		coalesce(cd_intervalo_gas_p,cd_intervalo_w),
		CASE WHEN ie_limpa_prim_hor_w='N' THEN ds_horarios_w  ELSE '' END ,
		dt_inicio_prescr_w
from	protocolo_medic_gas
where	nr_sequencia	= nr_seq_item_protocolo_p;

Select	cd_protocolo,
		nr_seq_protocolo
into STRICT	cd_protocolo_w,
		nr_seq_prot_w
from	protocolo_medic_gas
where	nr_sequencia	= nr_seq_item_protocolo_p;

Select	coalesce(qt_peso, 0)
into STRICT	qt_peso_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

CALL Inserir_mat_med_assoc_gas_prot(cd_protocolo_w, nr_seq_prot_w, nr_seq_item_protocolo_p, nr_prescricao_p,qt_peso_w, nr_seq_gasoterapia_w, nm_usuario_p, coalesce(cd_intervalo_p, cd_intervalo_w));

commit;

CALL Gerar_Med_Mat_Assoc_gas(nr_prescricao_p, nr_seq_gasoterapia_w, nm_usuario_p, 'N',cd_intervalo_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_gasoterapia_rotina ( nr_seq_item_protocolo_p bigint, nr_prescricao_p bigint, nm_usuario_p text, qt_gasoterapia_p bigint default null, ie_unidade_medida_p text default null, cd_intervalo_p text default null, cd_intervalo_gas_p text default null) FROM PUBLIC;

