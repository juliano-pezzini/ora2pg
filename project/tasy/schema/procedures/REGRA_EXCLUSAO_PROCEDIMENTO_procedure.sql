-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE regra_exclusao_procedimento ( nr_seq_proc_p bigint, nr_interno_conta_p bigint, nm_usuario_p text, ds_erro_p INOUT text, vl_procedimento_p bigint) AS $body$
DECLARE

 
					 
		 
qt_regra_w					bigint;
ds_erro_w					varchar(255) := '';
qt_existe_regra_w			varchar(1);
cd_grupo_proc_w				bigint;
cd_especialidade_proc_w		bigint;
cd_area_proc_w				bigint;
ie_tipo_atendimento_w		smallint;
cd_convenio_w				integer;
ie_origem_proced_w			bigint;
cd_procedimento_w			bigint;
		

BEGIN 
 
select	coalesce(max('S'),'N') 
into STRICT	qt_existe_regra_w 
from	regra_exclusao_audit_proc;
 
if (qt_existe_regra_w = 'S') then 
 
	select	coalesce(max(cd_procedimento),0), 
			coalesce(max(ie_origem_proced),0) 
	into STRICT	cd_procedimento_w, 
			ie_origem_proced_w 
	from	procedimento_paciente 
	where	nr_sequencia = nr_seq_proc_p;	
 
	select	coalesce(max(cd_grupo_proc),0), 
			coalesce(max(cd_especialidade),0), 
			coalesce(max(cd_area_procedimento),0) 
	into STRICT	cd_grupo_proc_w, 
			cd_especialidade_proc_w, 
			cd_area_proc_w 
	from	estrutura_procedimento_v 
	where	cd_procedimento 	= cd_procedimento_w 
	and		ie_origem_proced	= ie_origem_proced_w;
	 
	select	coalesce(max(substr(obter_tipo_atendimento(nr_atendimento),1,5)),0), 
			coalesce(max(cd_convenio_parametro),0) 
	into STRICT	ie_tipo_atendimento_w, 
			cd_convenio_w 
	from	conta_paciente 
	where	nr_interno_conta = nr_interno_conta_p;
  
	select	count(*) 
	into STRICT	qt_regra_w 
	from	regra_exclusao_audit_proc 
	where	ie_situacao = 'A' 
	and		coalesce(cd_convenio, coalesce(cd_convenio_w,0)) = coalesce(cd_convenio_w,0) 
	and		((coalesce(cd_grupo_proc::text, '') = '') or (coalesce(cd_grupo_proc,0) = coalesce(cd_grupo_proc_w,0))) 
	and		((coalesce(ie_tipo_atendimento::text, '') = '') or (coalesce(ie_tipo_atendimento,ie_tipo_atendimento_w) = coalesce(ie_tipo_atendimento_w,0))) 
	and		((coalesce(cd_especialidade::text, '') = '') or (coalesce(cd_especialidade,0) = coalesce(cd_especialidade_proc_w,0))) 
	and		((coalesce(cd_area_procedimento::text, '') = '') or (coalesce(cd_area_procedimento,0) = coalesce(cd_area_proc_w,0))) 
	and		((coalesce(cd_procedimento::text, '') = '') or (coalesce(cd_procedimento,0) = coalesce(cd_procedimento_w,0))) 
	and		((vl_procedimento_p = - 1) or (coalesce(vl_procedimento_p,0) between coalesce(vl_minimo,coalesce(vl_procedimento_p,0)) and coalesce(vl_maximo,coalesce(vl_procedimento_p,0))));
	 
	if (qt_regra_w = 0) then 
		ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(281484);
  end if;
end if;	
 
ds_erro_p := ds_erro_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE regra_exclusao_procedimento ( nr_seq_proc_p bigint, nr_interno_conta_p bigint, nm_usuario_p text, ds_erro_p INOUT text, vl_procedimento_p bigint) FROM PUBLIC;

