-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_importa_tab_preco_mat_tuss ( nr_seq_tabela_preco_p INOUT pls_material_preco.nr_sequencia%type, ie_tipo_importacao_p text, cd_material_p text, vl_material_p bigint, vl_percentual_p bigint, dt_inicio_vigencia_p timestamp, cd_moeda_p moeda.cd_moeda%type, qt_convercao_p pls_material_valor_item.qt_convercao%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_item_criado_atual_p INOUT text, ds_retorno_p INOUT text) AS $body$
DECLARE


qt_registro_w		smallint;
dt_inicio_vigencia_w	timestamp;
vl_material_w		double precision;
vl_material_calc_w	double precision;
ie_importado_w		varchar(2);
localizou_w			varchar(1);

ie_situacao_w		pls_material_preco.ie_situacao%type;
ds_tabela_w		pls_material_preco.ds_tabela%type;
cd_tiss_brasindice_w	pls_material.cd_tiss_brasindice%type;
nr_seq_tabela_preco_w	pls_material_preco.nr_sequencia%Type;

C01 CURSOR(	cd_tuss_pc		pls_material_preco_imp_log.cd_tuss%type,
		dt_inicio_vig_pc	pls_material_valor_item.dt_inicio_vigencia%type)FOR
	SELECT	a.nr_sequencia nr_seq_material,
		a.cd_material_ops cd_material
	from	pls_material a
	where	exists (SELECT	1
					from	tuss_material_item b
					where	b.nr_sequencia = a.nr_seq_tuss_mat_item
					and	b.cd_material_tuss = cd_tuss_pc)
	and		a.ie_situacao = 'A'
	and		dt_inicio_vig_pc between a.dt_inclusao_ref and a.dt_fim_vigencia_ref;
		
C02 CURSOR(	cd_material_ops_pc		pls_material.cd_material_ops%type,
				cd_material_ops_sem_zeros_pc		pls_material.cd_material_ops%type,
				dt_inicio_vig_pc	pls_material_valor_item.dt_inicio_vigencia%type)FOR
	SELECT	'1' origem,
			a.nr_sequencia nr_seq_material,
			(	SELECT	max(b.cd_material_tuss)
				from	tuss_material_item b
				where	b.nr_sequencia = a.nr_seq_tuss_mat_item) cd_tuss
	from	pls_material a
	where	a.cd_material_ops 	= cd_material_ops_pc
	and		a.ie_situacao 		= 'A'
	and		dt_inicio_vig_pc between a.dt_inclusao_ref and a.dt_fim_vigencia_ref
	
union all

	select	'2' origem,
			a.nr_sequencia nr_seq_material,
			(	select	max(b.cd_material_tuss)
				from	tuss_material_item b
				where	b.nr_sequencia = a.nr_seq_tuss_mat_item) cd_tuss
	from	pls_material a
	where	a.cd_material_ops 	= cd_material_ops_sem_zeros_pc
	and		a.ie_situacao 		= 'A'
	and		dt_inicio_vig_pc between a.dt_inclusao_ref and a.dt_fim_vigencia_ref;
	
BEGIN
ie_importado_w := 'N';
--Verificar se existe a tabela de preco, se não existir criar uma nova
select	max(ie_situacao),
	max(nr_sequencia)
into STRICT	ie_situacao_w,
	nr_seq_tabela_preco_w
from	pls_material_preco
where	nr_sequencia = nr_seq_tabela_preco_p;	

ds_retorno_p := null;
if (ie_situacao_w <> 'A' and (ie_situacao_w IS NOT NULL AND ie_situacao_w::text <> '')) then
	qt_registro_w := -1;
	ds_retorno_p := 'A tabela selecionada não está ativa.';
else
	if (nr_seq_tabela_preco_w IS NOT NULL AND nr_seq_tabela_preco_w::text <> '') then
		qt_registro_w := 1;
	else
		qt_registro_w := 0;
	end if;
	
end if;

if (qt_registro_w <> -1) then
	if (qt_registro_w = 0) then

		select	nextval('pls_material_preco_seq')
		into STRICT	nr_seq_tabela_preco_w
		;
		
		ds_tabela_w := 'Tabela '||nr_seq_tabela_preco_w||' - Importação de arquivo de preço ('
						||clock_timestamp()||')'||' - '||nm_usuario_p;
		
		insert into pls_material_preco(nr_sequencia, cd_estabelecimento, dt_atualizacao, nm_usuario, ds_tabela, ie_situacao)
		values (nr_seq_tabela_preco_w, cd_estabelecimento_p,clock_timestamp(),nm_usuario_p,ds_tabela_w,'A');
		
		-- a partir do primeiro registro que encontrar, todos os demais farão parte da mesma tabela
		nr_seq_tabela_preco_p := nr_seq_tabela_preco_w;
	end if;

	if (nr_seq_tabela_preco_w IS NOT NULL AND nr_seq_tabela_preco_w::text <> '') then
	
		vl_material_w := 0;
		begin
			if (vl_material_p IS NOT NULL AND vl_material_p::text <> '') then
				vl_material_w := vl_material_p;--Atributo vl_material registro 101 interface 2393
			end if;
		exception
		when data_exception then
			null;
		end;

		vl_material_calc_w := 0;
		begin
			vl_material_calc_w := ((vl_material_w * vl_percentual_p) / 100) + vl_material_w;
		exception
		when data_exception then
			null;
		end;

		dt_inicio_vigencia_w := clock_timestamp();
		begin	
			dt_inicio_vigencia_w := trunc(dt_inicio_vigencia_p);	
		exception
		when data_exception then
			null;
		end;
		
		if (ie_tipo_importacao_p = '0') then
		
			--O to_number é para evitar mandar zeros a esquerda, já que não localizaria materiais com codificação tuss dessa forma
			for r_C01_w in C01(to_char((cd_material_p)::numeric ), dt_inicio_vigencia_p) loop
				-- jjung OS 523315 -	Inserir os valores para cada item que estiver cadastrado na tabela para o material selecionado.
				ie_item_criado_atual_p := pls_inserir_valor_tab_mat(
								nr_seq_tabela_preco_w, r_C01_w.nr_seq_material, vl_material_calc_w, dt_inicio_vigencia_w, 'S', cd_moeda_p, ie_item_criado_atual_p, nm_usuario_p, null, qt_convercao_p);
				ie_importado_w := 'S';
				
				commit;
				
				CALL pls_gera_log_imp_tab_mat(
								cd_moeda_p,null,dt_inicio_vigencia_w,
								ie_item_criado_atual_p,null,r_C01_w.nr_seq_material,       
								nr_seq_tabela_preco_w,qt_convercao_p,vl_material_calc_w,           
								cd_material_p,nm_usuario_p);
			end loop;
			
			if (ie_importado_w = 'N') then
				CALL pls_gera_log_imp_tab_mat(
								cd_moeda_p,cd_tiss_brasindice_w,dt_inicio_vigencia_w,
								'N',null,null,       
								nr_seq_tabela_preco_w,qt_convercao_p,vl_material_calc_w,           
								cd_material_p,nm_usuario_p);
			end if;
		
		else
			localizou_w := 'N';
			for r_C02_w in C02(cd_material_p, to_char((cd_material_p)::numeric ), dt_inicio_vigencia_p) loop
			
				if (r_C02_w.origem = '1') then
					localizou_w := 'S';
				end if;
				
				--Para somente inserir se locizou com os zeros a esquerda ou caso não localizar, adiciona caso localize sem zeros a esquerda
				if ( (r_C02_w.origem = '1') or (r_C02_w.origem = '2' and localizou_w = 'N')) then
			
					-- jjung OS 523315 -	Inserir os valores para cada item que estiver cadastrado na tabela para o material selecionado.
					ie_item_criado_atual_p := pls_inserir_valor_tab_mat(	nr_seq_tabela_preco_w, r_C02_w.nr_seq_material, vl_material_calc_w, dt_inicio_vigencia_w, 'S', cd_moeda_p, ie_item_criado_atual_p, nm_usuario_p, null, qt_convercao_p);
					ie_importado_w := 'S';
					
					commit;
					
					CALL pls_gera_log_imp_tab_mat(	cd_moeda_p,null,dt_inicio_vigencia_w,
									ie_item_criado_atual_p,null,r_C02_w.nr_seq_material,       
									nr_seq_tabela_preco_w,qt_convercao_p,vl_material_calc_w,           
									r_C02_w.cd_tuss,nm_usuario_p);
								
				end if;
			end loop;
			
			if (ie_importado_w = 'N') then
				CALL pls_gera_log_imp_tab_mat(	cd_moeda_p,cd_tiss_brasindice_w,dt_inicio_vigencia_w,
								'N',null,null,       
								nr_seq_tabela_preco_w,qt_convercao_p,vl_material_calc_w,           
								null,nm_usuario_p);
			end if;
		end if;						
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_importa_tab_preco_mat_tuss ( nr_seq_tabela_preco_p INOUT pls_material_preco.nr_sequencia%type, ie_tipo_importacao_p text, cd_material_p text, vl_material_p bigint, vl_percentual_p bigint, dt_inicio_vigencia_p timestamp, cd_moeda_p moeda.cd_moeda%type, qt_convercao_p pls_material_valor_item.qt_convercao%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_item_criado_atual_p INOUT text, ds_retorno_p INOUT text) FROM PUBLIC;

