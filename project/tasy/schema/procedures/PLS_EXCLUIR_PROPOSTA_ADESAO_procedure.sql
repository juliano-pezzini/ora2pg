-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_excluir_proposta_adesao ( nr_seq_proposta_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_proposta_incon_w		bigint;
nr_seq_beneficiario_w		bigint;
ie_existe_w			smallint;
ie_excluir_prop_prospect_w	varchar(1);
nr_seq_cliente_w		bigint;
nr_seq_mtvo_cancel_cliente_w	bigint;

--Selecionar as inconsistencias das proposta
C01 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_proposta_validacao
	where	nr_seq_proposta		= nr_seq_proposta_p;

--Selecionar os beneficiários da proposta
C02 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_proposta_beneficiario
	where	nr_seq_proposta		= nr_seq_proposta_p;


BEGIN
ie_excluir_prop_prospect_w	:= coalesce(obter_valor_param_usuario(1232, 102, Obter_Perfil_Ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento),'S');

select	max(1)
into STRICT	ie_existe_w

where	exists (SELECT	1
		 from	pls_inclusao_beneficiario
		 where	nr_seq_proposta	= nr_seq_proposta_p);

if (ie_existe_w = 1) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort( 251931, null );
	/* Não é possível realizar a exclusão de propostas criadas a partir do Portal. */

end if;

/* Tratamento do parâmetro 102 */

select	max(nr_seq_cliente)
into STRICT	nr_seq_cliente_w
from	pls_proposta_adesao
where	nr_sequencia	= nr_seq_proposta_p;

if (nr_seq_cliente_w IS NOT NULL AND nr_seq_cliente_w::text <> '') then
	if (ie_excluir_prop_prospect_w = 'S') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_mtvo_cancel_cliente_w
		from	pls_motivo_cancel_prospect
		where	coalesce(ie_exclusao_proposta_adesao,'N') = 'S';
		
		CALL pls_cancelar_prospeccao(nr_seq_cliente_w, nr_seq_mtvo_cancel_cliente_w, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);
	else
		CALL wheb_mensagem_pck.exibir_mensagem_abort( 251935, null );
		/* Não é possível excluir uma proposta de adesão gerada à partir de uma prospecção. Verifique o parâmetro [102]. */

	end if;
end if;

if (nr_seq_proposta_p IS NOT NULL AND nr_seq_proposta_p::text <> '') then
	update	pls_simulacao_preco
	set	nr_seq_proposta  = NULL
	where	nr_seq_proposta = nr_seq_proposta_p;
end if;

--Excluir aceso ao portal
delete	from pls_proposta_adesao_web
where	nr_seq_proposta_adesao	= nr_seq_proposta_p;

--Excluir check list da validação de inconsistencias
open C01;
loop
fetch C01 into
	nr_seq_proposta_incon_w;
EXIT WHEN NOT FOUND; /* apply on C01 */	
	begin
		delete
		from	pls_proposta_check_list
		where	nr_seq_validacao	= nr_seq_proposta_incon_w;
	end;
end loop;
close C01;

--Excluir inconsistencias
delete	from	pls_proposta_validacao
where	nr_seq_proposta		= nr_seq_proposta_p;

--Exluir Histórico
delete
from	pls_proposta_historico
where	nr_seq_proposta		= nr_seq_proposta_p;

open C02;
loop
fetch C02 into
	nr_seq_beneficiario_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	
	--Excluir agravos dos beneficiarios
	delete	from	pls_proposta_benef_agravo
	where	nr_seq_proposta_benef	= nr_seq_beneficiario_w;
	
	--Exluir carencia do beneficiario
	delete	from	pls_carencia
	where	nr_seq_pessoa_proposta	= nr_seq_beneficiario_w;
	
	--Excluir SCA do beneficiario
	delete	from	pls_sca_vinculo
	where	nr_seq_benef_proposta	= nr_seq_beneficiario_w;
	
	--Excluir bonificações do beneficiario
	delete	from	pls_bonificacao_vinculo
	where	nr_seq_segurado_prop	= nr_seq_beneficiario_w;
	
	delete	FROM pls_proposta_benef_hist
	where	nr_seq_benef_proposta	= nr_seq_beneficiario_w;
	
	delete	FROM pls_benef_prop_canal_compl
	where	nr_seq_benef_proposta	= nr_seq_beneficiario_w;
	end;
end loop;
close C02;

--Exluir Inscrição da proposta
delete	from	pls_regra_inscricao
where	nr_seq_proposta		= nr_seq_proposta_p;

--Excluir bonificações da proposta
delete	from	pls_bonificacao_vinculo
where	nr_seq_proposta		= nr_seq_proposta_p;

--Excluir beneficiarios
delete	from	pls_proposta_beneficiario
where	nr_seq_proposta		= nr_seq_proposta_p;

--Exluir pagadores
delete	from	pls_proposta_pagador
where	nr_seq_proposta		= nr_seq_proposta_p;

--Exluir planos da proposta
delete	from	pls_proposta_plano
where	nr_seq_proposta		= nr_seq_proposta_p;

--Exluir planos da proposta
delete	from	pls_proposta_resumo
where	nr_seq_proposta		= nr_seq_proposta_p;

delete	FROM pls_benef_prop_canal_compl
where	nr_seq_proposta		= nr_seq_proposta_p;

delete	from	pls_indicacao_venda
where	nr_seq_proposta		= nr_seq_proposta_p;

--Exluir regra de desconto
delete	from	pls_regra_desconto
where	nr_seq_proposta		= nr_seq_proposta_p;

--Exluir a proposta
delete	from	pls_proposta_adesao
where	nr_sequencia		= nr_seq_proposta_p;
	
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_excluir_proposta_adesao ( nr_seq_proposta_p bigint, nm_usuario_p text) FROM PUBLIC;

