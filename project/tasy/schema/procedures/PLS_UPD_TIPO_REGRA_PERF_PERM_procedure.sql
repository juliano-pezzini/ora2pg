-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_upd_tipo_regra_perf_perm ( cd_perfil_p perfil.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


ie_situacao_w		pls_cta_classif_acesso.ie_situacao%type;
qt_regras_w		integer;
qt_regra_acesso_w	integer;

C00 CURSOR FOR
	SELECT	vl_dominio nr_seq_tipo_regra
	from 	valor_dominio_v
	where 	cd_dominio = 3606;

BEGIN

CALL exec_sql_dinamico(nm_usuario_p,'delete from pls_tpr_perfil_perm_val where cd_perfil = '||cd_perfil_p);

select 	count(1)
into STRICT	qt_regra_acesso_w
from	pls_cta_classif a;

for r_c00_w in C00 loop

	if (qt_regra_acesso_w > 0) then
		select	count(a.nr_sequencia)
		into STRICT	qt_regras_w
		from	pls_cta_classif_acesso a,
			pls_cta_classif b
		where	a.nr_seq_classif = b.nr_sequencia
		and	a.cd_perfil = cd_perfil_p
		and	a.ie_situacao = 'A'
		and 	b.ie_tipo_regra = r_c00_w.nr_seq_tipo_regra;

		if (qt_regras_w > 0) then
			ie_situacao_w := 'A';
		else
			ie_situacao_w := 'I';
		end if;
	else
		ie_situacao_w := 'A';
	end if;

	if (ie_situacao_w = 'A') then
		insert into pls_tpr_perfil_perm_val(nr_sequencia, dt_atualizacao, nm_usuario, cd_perfil, nr_seq_tipo_regra, ie_situacao)
				values (nextval('pls_tpr_perfil_perm_val_seq'), clock_timestamp(), nm_usuario_p, cd_perfil_p, r_c00_w.nr_seq_tipo_regra, ie_situacao_w);
	end if;
end loop;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_upd_tipo_regra_perf_perm ( cd_perfil_p perfil.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

