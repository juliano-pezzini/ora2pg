-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dar_create_filter_panorama (nr_seq_dar_app_p bigint, nr_seq_dar_dashboard_p bigint, nr_atendimento_p text, cd_pessoa_fisica_p bigint, cd_setor_atendimento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint ) AS $body$
DECLARE


cFiltros CURSOR FOR
SELECT a.nr_seq_app, c.nr_sequencia cd_field , c.ds_campo
  from dar_app_datamodels a,
       dar_tables_control b,
       dar_tab_control_fields c
 where coalesce(a.nr_seq_ligacao,a.nr_seq_table_control) = b.nr_sequencia
   and a.nr_seq_table_control = c.nr_seq_table_control
   and a.nr_seq_app = nr_seq_dar_app_p;			

BEGIN
	delete from dar_dashboard_filter where nr_seq_dashboard = nr_seq_dar_dashboard_p;
	for r1 in cFiltros loop
		if (upper(r1.ds_campo) = 'NR_ATENDIMENTO' and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '')) then
			insert into dar_dashboard_filter(
					nr_sequencia,
					cd_estabelecimento,   
					dt_atualizacao,       
					nm_usuario,           
					dt_atualizacao_nrec,  
					nm_usuario_nrec,      
					cd_exp_campo,         
					nm_campo,             
					ie_operacao,          
					ds_resultado,         
					nr_seq_dashboard) 
			values (nextval('dar_dashboard_filter_seq'),
					cd_estabelecimento_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					null,
					r1.cd_field,
					7,
					nr_atendimento_p,
					nr_seq_dar_dashboard_p);
		
		elsif (upper(r1.ds_campo) = 'CD_PESSOA_FISICA' and (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '')) then
			insert into dar_dashboard_filter(
					nr_sequencia,         
					cd_estabelecimento,   
					dt_atualizacao,       
					nm_usuario,           
					dt_atualizacao_nrec,  
					nm_usuario_nrec,      
					cd_exp_campo,         
					nm_campo,             
					ie_operacao,          
					ds_resultado,         
					nr_seq_dashboard) 
			values (nextval('dar_dashboard_filter_seq'),
					cd_estabelecimento_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					null,
					r1.cd_field,
					7,
					cd_pessoa_fisica_p,
					nr_seq_dar_dashboard_p);
		
		elsif (upper(r1.ds_campo) = 'CD_SETOR_ATENDIMENTO' and (cd_setor_atendimento_p IS NOT NULL AND cd_setor_atendimento_p::text <> '')) then
						insert into dar_dashboard_filter(
					nr_sequencia,         
					cd_estabelecimento,   
					dt_atualizacao,       
					nm_usuario,           
					dt_atualizacao_nrec,  
					nm_usuario_nrec,      
					cd_exp_campo,         
					nm_campo,             
					ie_operacao,          
					ds_resultado,         
					nr_seq_dashboard) 
			values (nextval('dar_dashboard_filter_seq'),
					cd_estabelecimento_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					null,
					r1.cd_field,
					7,
					cd_setor_atendimento_p,
					nr_seq_dar_dashboard_p);
		end if;
	end loop;
commit;
end;	
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dar_create_filter_panorama (nr_seq_dar_app_p bigint, nr_seq_dar_dashboard_p bigint, nr_atendimento_p text, cd_pessoa_fisica_p bigint, cd_setor_atendimento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint ) FROM PUBLIC;

