-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consistir_prest_nota_pgto ( nr_seq_prestador_p bigint, nr_seq_nota_fiscal_p bigint, nr_seq_pgto_nota_p bigint, vl_vinculado_p bigint) AS $body$
DECLARE


cd_cgc_prest_w			varchar(14);
cd_cgc_nota_w			varchar(14);
cd_pessoa_fisica_prest_w	varchar(10);
cd_pessoa_fisica_nota_w		varchar(10);
vl_total_nota_w			double precision	:= 0;
vl_vinculado_w			double precision	:= 0;


BEGIN
select	max(cd_pessoa_fisica),
	max(cd_cgc)
into STRICT	cd_pessoa_fisica_prest_w,
	cd_cgc_prest_w
from	pls_prestador
where	nr_sequencia	= nr_seq_prestador_p;

select	max(cd_pessoa_fisica),
	max(cd_cgc),
	max(vl_total_nota)
into STRICT	cd_pessoa_fisica_nota_w,
	cd_cgc_nota_w,
	vl_total_nota_w
from	nota_fiscal
where	nr_sequencia	= nr_seq_nota_fiscal_p;

if (coalesce(cd_pessoa_fisica_prest_w,'0') <> coalesce(cd_pessoa_fisica_nota_w,'0')) and (coalesce(cd_cgc_prest_w,'0') <> coalesce(cd_cgc_nota_w,'0')) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(114017);
else
	select	coalesce(sum(vl_vinculado),0)
	into STRICT	vl_vinculado_w
	from	pls_pagamento_nota
	where	nr_seq_nota_fiscal	= nr_seq_nota_fiscal_p
	and	nr_sequencia		<> nr_seq_pgto_nota_p;

	if	(vl_total_nota_w < (vl_vinculado_p + vl_vinculado_w)) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(114035,'VL_VINC=' || (vl_vinculado_p + vl_vinculado_w) || ';' || 'VL_NOTA=' || vl_total_nota_w);
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consistir_prest_nota_pgto ( nr_seq_prestador_p bigint, nr_seq_nota_fiscal_p bigint, nr_seq_pgto_nota_p bigint, vl_vinculado_p bigint) FROM PUBLIC;

