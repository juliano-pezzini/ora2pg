-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_gerar_evento_reacao ( nr_seq_reacao_p bigint, nr_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_evento_w		bigint;			
cd_setor_atendimento_w	bigint;
ds_evento_w		varchar(4000);
cd_pf_realizou_w	varchar(10);
nr_seq_classif_evento_w bigint;
nr_seq_reacao_w		bigint;
dt_reacao_w		timestamp;
ie_classificacao_w	varchar(10);


BEGIN
select	max(nr_seq_reacao),
	max(wheb_mensagem_pck.get_texto(798574) || ': ' || substr(san_obter_desc_reacao(nr_seq_reacao),1,255) || chr(10) ||
	wheb_mensagem_pck.get_texto(798587) || ': ' || ds_sintoma || chr(10) ||
	wheb_mensagem_pck.get_texto(798589) || ': ' || substr(ds_conduta,1,3200)),
	max(cd_pf_realizou),
	max(dt_reacao)
into STRICT	nr_seq_reacao_w,
	ds_evento_w,
	cd_pf_realizou_w,
	dt_reacao_w	
from	san_trans_reacao
where	nr_sequencia = nr_seq_reacao_p;

select	max(nr_seq_evento),
	max(nr_seq_classif_evento),
	max(obter_classif_evento(nr_seq_evento))
into STRICT	nr_seq_evento_w,
	nr_seq_classif_evento_w,
	ie_classificacao_w
from	san_tipo_reacao
where	nr_sequencia = nr_seq_reacao_w;

select 	max(obter_unidade_atendimento(nr_atendimento_p,'A','CS'))
into STRICT	cd_setor_atendimento_w
;

if (nr_seq_evento_w IS NOT NULL AND nr_seq_evento_w::text <> '') and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
	insert into qua_evento_paciente(	
		nr_sequencia,
		ie_situacao,
		dt_cadastro,
		cd_setor_atendimento,
		ie_status,
		nr_seq_evento,
		dt_evento,
		ds_evento,
		cd_estabelecimento,
		dt_atualizacao,
		nm_usuario,
		nm_usuario_reg,
		nr_atendimento,
		ie_tipo_evento,
		cd_profissional,
		ie_origem,
		dt_liberacao,
		nm_usuario_origem,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_pessoa_fisica,
		nr_seq_classif_evento,
		ie_classificacao,
		cd_funcao_ativa)
	values (	nextval('qua_evento_paciente_seq'),
		'A',
		clock_timestamp(),
		cd_setor_atendimento_w,
		'1',
		nr_seq_evento_w,
		coalesce(dt_reacao_w,clock_timestamp()),
		ds_evento_w,
		wheb_usuario_pck.get_cd_estabelecimento,
		clock_timestamp(),
		nm_usuario_p,
		nm_usuario_p,
		nr_atendimento_p,
		'E',
		cd_pf_realizou_w,
		'S',
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		obter_pessoa_atendimento(nr_atendimento_p,'C'),
		nr_seq_classif_evento_w,
		ie_classificacao_w,
		obter_funcao_ativa);

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_gerar_evento_reacao ( nr_seq_reacao_p bigint, nr_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

