-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicar_preco_procaih ( dt_comp_origem_p timestamp, ie_versao_origem_p text, dt_comp_destino_p timestamp, ie_versao_destino_p text, nm_usuario_p text) AS $body$
DECLARE


dt_competencia_w		timestamp;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
dt_competencia_inicial_w	timestamp;
dt_competencia_final_w		timestamp;
qt_idade_minima_w		smallint;
qt_idade_maxima_w		smallint;
ie_sexo_sus_w			varchar(1);
ie_inreal_w			varchar(1);
ie_inatom_w			varchar(1);
qt_permanencia_w		smallint;
qt_ato_medico_w			smallint;
qt_ato_anestesista_w		smallint;
vl_matmed_w			double precision;
vl_diaria_w			double precision;
vl_taxas_w			double precision;
vl_medico_w			double precision;
vl_sadt_w			double precision;
ie_versao_w			varchar(20);

qt_registros_w			integer	:= 0;

C01 CURSOR FOR
	SELECT	dt_comp_destino_p,
		cd_procedimento,
		ie_origem_proced,
		dt_competencia_inicial,
		dt_competencia_final,
		qt_idade_minima,
		qt_idade_maxima,
		ie_sexo_sus,
		ie_inreal,
		ie_inatom,
		qt_permanencia,
		qt_ato_medico,
		qt_ato_anestesista,
		vl_matmed,
		vl_diaria,
		vl_taxas,
		vl_medico,
		vl_sadt,
		ie_versao_destino_p
	from	sus_preco_procAIh
	where	coalesce(dt_comp_origem_p, dt_competencia)	= dt_competencia
	and	coalesce(ie_versao_origem_p, ie_versao)	= ie_versao;


BEGIN

select	count(*)
into STRICT	qt_registros_w
from	sus_preco_procaih
where	dt_competencia	= dt_comp_destino_p;
if (qt_registros_w	> 0) then
	--r.aise_application_error(-20011,'Já existe uma tabela com a data de competencia: '|| DT_COMP_DESTINO_P);
	CALL wheb_mensagem_pck.exibir_mensagem_abort(263303,'DT_COMP_DESTINO_P='||DT_COMP_DESTINO_P);
end if;

select	count(*)
into STRICT	qt_registros_w
from	sus_preco_procaih
where	ie_versao	= ie_versao_destino_p;
if (qt_registros_w	> 0) then
	--r.aise_application_error(-20011,'Já existe uma tabela com a versão: '|| IE_VERSAO_DESTINO_P);
	CALL wheb_mensagem_pck.exibir_mensagem_abort(263304,'IE_VERSAO_DESTINO_P='||IE_VERSAO_DESTINO_P);
end if;

OPEN C01;
LOOP
FETCH C01 into
	dt_competencia_w,
	cd_procedimento_w,
	ie_origem_proced_w,
	dt_competencia_inicial_w,
	dt_competencia_final_w,
	qt_idade_minima_w,
	qt_idade_maxima_w,
	ie_sexo_sus_w,
	ie_inreal_w,
	ie_inatom_w,
	qt_permanencia_w,
	qt_ato_medico_w,
	qt_ato_anestesista_w,
	vl_matmed_w,
	vl_diaria_w,
	vl_taxas_w,
	vl_medico_w,
	vl_sadt_w,
	ie_versao_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	insert into sus_preco_procAIH(DT_COMPETENCIA,
		CD_PROCEDIMENTO,
		IE_ORIGEM_PROCED,
		DT_COMPETENCIA_INICIAL,
		DT_COMPETENCIA_FINAL,
		QT_IDADE_MINIMA,
		QT_IDADE_MAXIMA,
		IE_SEXO_SUS,
		IE_INREAL,
		IE_INATOM,
		QT_PERMANENCIA,
		QT_ATO_MEDICO,
		QT_ATO_ANESTESISTA,
		VL_MATMED,
		VL_DIARIA,
		VL_TAXAS,
		VL_MEDICO,
		VL_SADT,
		DT_ATUALIZACAO,
		NM_USUARIO,
		IE_VERSAO)
	values (dt_competencia_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		dt_competencia_inicial_w,
		dt_competencia_final_w,
		qt_idade_minima_w,
		qt_idade_maxima_w,
		ie_sexo_sus_w,
		ie_inreal_w,
		ie_inatom_w,
		qt_permanencia_w,
		qt_ato_medico_w,
		qt_ato_anestesista_w,
		vl_matmed_w,
		vl_diaria_w,
		vl_taxas_w,
		vl_medico_w,
		vl_sadt_w,
		clock_timestamp(),
		nm_usuario_p,
		ie_versao_w);
	end;
END LOOP;
CLOSE C01;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_preco_procaih ( dt_comp_origem_p timestamp, ie_versao_origem_p text, dt_comp_destino_p timestamp, ie_versao_destino_p text, nm_usuario_p text) FROM PUBLIC;

