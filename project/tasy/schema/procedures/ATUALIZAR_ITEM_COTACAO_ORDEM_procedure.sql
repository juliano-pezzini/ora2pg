-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_item_cotacao_ordem ( nr_ordem_compra_p bigint, nr_item_oci_p bigint, nr_ordem_transf_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_cot_compra_w         ordem_compra_item.nr_cot_compra%type;
nr_item_cot_compra_w    ordem_compra_item.nr_item_cot_compra%type;
cd_material_w           ordem_compra_item.cd_material%type;
ds_material_w           material.ds_material%type;
ds_erro_w               varchar(2000) := '';


BEGIN

select nr_cot_compra,
       nr_item_cot_compra,
       cd_material
into STRICT   nr_cot_compra_w,
       nr_item_cot_compra_w,
       cd_material_w
from   ordem_compra_item
where  nr_ordem_compra = nr_ordem_compra_p
and    nr_item_oci = nr_item_oci_p;

ds_material_w := substr(obter_desc_material(cd_material_w),1,255);

begin

update cot_compra_forn_item
set    nr_ordem_compra = nr_ordem_transf_p
where  nr_cot_compra = nr_cot_compra_w
and    nr_item_cot_compra = nr_item_cot_compra_w
and    nr_ordem_compra = nr_ordem_compra_p;

insert into cot_compra_hist(
        nr_sequencia,
        nr_cot_compra,
        dt_atualizacao,
        nm_usuario,
        dt_historico,
        ds_titulo,
        ds_historico,
        dt_atualizacao_nrec,
        nm_usuario_nrec,
        ie_origem,
        dt_liberacao )
values ( nextval('cot_compra_hist_seq'),
        nr_cot_compra_w,
        clock_timestamp(),
        nm_usuario_p,
        clock_timestamp(),
        substr(WHEB_MENSAGEM_PCK.get_texto(1155362),1,80),
        substr(WHEB_MENSAGEM_PCK.get_texto(1155365,'NR_ITEM_COT_COMPRA_W='||nr_item_cot_compra_w||
                                ';CD_MATERIAL_W='||cd_material_w||';DS_MATERIAL_W='||ds_material_w||
                                ';NR_ORDEM_COMPRA_P='||nr_ordem_compra_p||';NR_ORDEM_TRANSF_P='||nr_ordem_transf_p),1,4000),
        clock_timestamp(),
        nm_usuario_p,
        'S',
        clock_timestamp() );

exception when others then

ds_erro_w := substr(sqlerrm,1,3000);

CALL inserir_historico_ordem_compra( nr_ordem_transf_p,
                                'S',
                                WHEB_MENSAGEM_PCK.get_texto(1155366),
                                substr(WHEB_MENSAGEM_PCK.get_texto(1155368,'DS_ERRO_W='||ds_erro_w||
                                                ';NR_ITEM_COT_COMPRA_W='||nr_item_cot_compra_w||
                                                ';NR__COT_COMPRA_W='||nr_cot_compra_w),1,4000),
                                nm_usuario_p );

end;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_item_cotacao_ordem ( nr_ordem_compra_p bigint, nr_item_oci_p bigint, nr_ordem_transf_p bigint, nm_usuario_p text) FROM PUBLIC;

