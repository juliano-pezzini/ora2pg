-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_orient_alta_avaliacao ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE

										
										
										
nr_seq_item_w		      bigint;
ds_item_w		         varchar(32000);
ds_resultado_w		      varchar(32000);			
ds_conteudo_w		      varchar(32000);		
ie_resultado_w		      varchar(10);
ie_gerar_orientacao_alta_w  varchar(2);		
nr_atendimento_w		   bigint;
cd_pessoa_fisica_w	   varchar(10);
cd_medico_w		         varchar(10);
dt_avaliacao_w		      timestamp;
cd_evolucao_w		      bigint;
ds_orientacao_w		   varchar(32000);
ie_tipo_evolucao_w		varchar(10);
ds_fonte_w		         varchar(100);
ds_tam_fonte_w		      varchar(10);
nr_tam_fonte_w		      integer;
ds_cabecalho_w		      varchar(32000);
ds_rodape_w		         varchar(32000);
ie_sem_resposta_w		   varchar(1);
ie_tipo_orientacao_w    varchar(10);
										
C01 CURSOR FOR
SELECT      c.nr_sequencia,
            coalesce(ds_label_relat,c.ds_item) ds_item,
            c.IE_RESULTADO,
            coalesce((SELECT d.ds_resultado from med_item_avaliar_res d where d.nr_seq_item = c.nr_sequencia and obter_somente_numero(Aval(a.nr_sequencia,c.nr_sequencia)) = d.nr_Seq_res and coalesce(c.cd_dominio::text, '') = ''),substr(Aval(a.nr_sequencia,c.nr_sequencia),1,4000)) ds_resultado
from	      med_Avaliacao_paciente a,
            med_tipo_avaliacao b,
            med_item_avaliar c
where	      b.nr_sequencia = c.nr_seq_tipo
and	      a.nr_seq_tipo_avaliacao = b.nr_sequencia
and		((ie_sem_resposta_w = 'N') or
		((c.ie_resultado in ('T','H')) and ( exists (select  1
													 from    med_item_avaliar f
													 where   f.nr_seq_superior = c.nr_sequencia
													 and	    substr(Aval(a.nr_sequencia,f.nr_sequencia),1,4000) is not null))) or
		(coalesce((select d.ds_resultado from med_item_avaliar_res d where d.nr_seq_item = c.nr_sequencia and obter_somente_numero(replace(upper(Aval(a.nr_sequencia,c.nr_sequencia)),'E','')) = d.nr_Seq_res and coalesce(c.cd_dominio::text, '') = ''),substr(Aval(a.nr_sequencia,c.nr_sequencia),1,4000)) is not null))
and		((ie_sem_resposta_w = 'N') or 
		((c.ie_resultado in ('T','H')) and ( exists (	select  1
													from    med_item_avaliar f
													where   f.nr_seq_superior = c.nr_sequencia
													and	    substr(Aval(a.nr_sequencia,f.nr_sequencia),1,4000) <> 'N'))) or
		(coalesce((select d.ds_resultado from med_item_avaliar_res d where d.nr_seq_item = c.nr_sequencia and obter_somente_numero(replace(upper(Aval(a.nr_sequencia,c.nr_sequencia)),'E','')) = d.nr_Seq_res and coalesce(c.cd_dominio::text, '') = ''),substr(Aval(a.nr_sequencia,c.nr_sequencia),1,4000)) <> 'N'))
and	      a.nr_sequencia = nr_sequencia_p
order       by c.nr_seq_apresent;									


BEGIN
select	max(ie_gerar_orient_alta),
         max(cd_pessoa_fisica),
         max(nr_atendimento),
         max(cd_medico),
         max(dt_avaliacao)
into STRICT	   ie_gerar_orientacao_alta_w,
         cd_pessoa_fisica_w,
         nr_atendimento_w,
         cd_medico_w,
         dt_avaliacao_w
from	   med_avaliacao_paciente a,
         med_tipo_avaliacao b
where	   b.nr_sequencia = a.nr_seq_tipo_avaliacao
and	   a.nr_sequencia = nr_sequencia_p;

if (ie_gerar_orientacao_alta_w	= 'S') and (coalesce(nr_atendimento_w,0) > 0) then
	ds_fonte_w := Obter_Param_Usuario(281, 5, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ds_fonte_w);
	ds_tam_fonte_w := Obter_Param_Usuario(281, 6, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ds_tam_fonte_w);
   ie_tipo_orientacao_w := obter_param_usuario(281, 18, Obter_perfil_Ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_tipo_orientacao_w);
	nr_tam_fonte_w	:= somente_numero(ds_tam_fonte_w)*2;

	select	coalesce(max(ie_campos_preench_evol_aval),'N')
	into STRICT	ie_sem_resposta_w
	from	parametro_medico
	where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;
	
	open C01;
	loop
	fetch C01 into	
		nr_seq_item_w,
		ds_item_w,
		ie_resultado_w,
		ds_resultado_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		ds_resultado_w := replace(ds_resultado_w,chr(13),'\par');
		if (ie_resultado_w in ('X','T')) then
	
			ds_conteudo_w	:= ds_conteudo_w||' \par'||wheb_rtf_pck.get_negrito(true)||wheb_rtf_pck.get_sublinhado(true) ||ds_item_w||wheb_rtf_pck.get_negrito(false)||wheb_rtf_pck.get_sublinhado(false) ||' \par \par';

		elsif (ie_resultado_w = 'B') then
			if (ds_resultado_w	= 'S') or (ds_resultado_w	= '1') then
				ds_resultado_w	:= WHEB_MENSAGEM_PCK.get_texto(298977,null); --'Sim';
			else
				ds_resultado_w:= WHEB_MENSAGEM_PCK.get_texto(298976,null); --'NÃ£o';
			end if;
				
			ds_conteudo_w := ds_conteudo_w ||' '||wheb_rtf_pck.get_negrito(true)||ds_item_w||' : '||wheb_rtf_pck.get_negrito(false)||ds_resultado_w||' \par';
		else
			ds_conteudo_w := ds_conteudo_w ||' '||wheb_rtf_pck.get_negrito(true)||ds_item_w||' : '||wheb_rtf_pck.get_negrito(false)||ds_resultado_w||' \par';
		end if;
		end;
	end loop;
	close C01;
	


	ds_cabecalho_w	:= '{\rtf1\ansi\ansicpg1252\deff0\deflang1046{\fonttbl{\f0\fswiss\fcharset0 '||ds_fonte_w||';}}'||
			   '{\*\generator Msftedit 5.41.15.1507;}\viewkind4\uc1\pard\f0\fs'||nr_tam_fonte_w||' ';
			
	ds_rodape_w	:= '}';
	
	ds_orientacao_w	:= ds_cabecalho_w||ds_conteudo_w||ds_rodape_w;
	
	select	coalesce(max(ie_tipo_evolucao),'1')
	into STRICT	ie_tipo_evolucao_w
	from	usuario
	where	nm_usuario = nm_usuario_p;
	
	
	 insert into atendimento_alta(	nr_sequencia,
                              dt_registro,
                              ie_tipo_evolucao,
                              dt_atualizacao,
                              nm_usuario,
                              nr_atendimento,
                              ds_orientacao,
                              dt_liberacao,
                              ie_tipo_orientacao,
                              ie_medico_ciente,
                              ie_situacao,
							  cd_profissional)
                  values (	nextval('atendimento_alta_seq'),
                              clock_timestamp(),
                              ie_tipo_evolucao_w,
                              clock_timestamp(),
                              nm_usuario_p,
                              nr_atendimento_w,
                              ds_orientacao_w,
                              clock_timestamp(),
                              ie_tipo_orientacao_w,
                              'N',
                              'A',
							  cd_medico_w);
	
end if;



if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_orient_alta_avaliacao ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

