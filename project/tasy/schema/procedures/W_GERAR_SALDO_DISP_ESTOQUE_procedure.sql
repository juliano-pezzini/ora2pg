-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE w_gerar_saldo_disp_estoque ( cd_estabelecimento_p bigint, cd_material_p bigint, cd_local_estoque_p bigint, dt_mesano_referencia_p timestamp, nm_usuario_p text) AS $body$
DECLARE


qt_saldo_w			double precision;

cd_material_w			integer;
ie_tipo_local_w			varchar(5);

cd_local_estoque_w		integer;
dt_mesano_referencia_w		timestamp;
ie_disp_quimioterapia_w		varchar(1);
ie_disp_req_trans_w		varchar(1);
ie_disp_prescr_eme_w		varchar(1);
ie_disp_ag_cirur_w			varchar(1);
ie_baixa_disp_w			varchar(1);
ie_disp_comp_kit_estoque_w		varchar(1);
ie_disp_reg_kit_estoque_w		varchar(1);
ie_disp_emprestimo_lib_w		varchar(1);
ie_disp_nf_emprestimo_w		varchar(1);
ie_disp_esp_cirurgia_w		varchar(1);
ie_disp_cirurgia_w			varchar(1);
ie_disp_req_trans_estab_w	varchar(1);
qt_conv_estoque_w			material.qt_conv_estoque_consumo%type;
ie_disp_sep_gedipa_w 		parametro_estoque.ie_disp_sep_gedipa%type;
ie_disp_ap_lote_w			parametro_estoque.ie_disp_ap_lote%type;
ie_disp_lote_prod_w			parametro_estoque.ie_disp_lote_prod%type;

ie_tipo_w		bigint;
cd_material_estoque_w	integer;
nr_documento_w		bigint;
cd_local_estoque_ww	integer;
qt_material_w		double precision;
ie_entrada_saida_w	varchar(1);

c01 CURSOR FOR
	SELECT	/*+ index (s salesto_i2) */		distinct cd_local_estoque
	from	saldo_estoque
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	cd_material		= coalesce(cd_material_w,cd_material)
	and	dt_mesano_referencia	>= dt_mesano_referencia_w
	and	cd_local_estoque	= cd_local_estoque_p	
	and	coalesce(cd_local_estoque_p,0) > 0
	
union

	SELECT	/*+ index (s salesto_i2) */		distinct cd_local_estoque
	from	saldo_estoque
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	cd_material		= coalesce(cd_material_w,cd_material)
	and	dt_mesano_referencia	>= dt_mesano_referencia_w
	and	coalesce(cd_local_estoque_p,0) = 0;
	
C02 CURSOR FOR
SELECT	1 ie_tipo,
	x.cd_material_estoque,
	b.nr_cirurgia,
	c.cd_local_estoque,
	coalesce(sum(qt_total_dispensar),0) qt_dispensar
from	setor_atendimento c,
	cirurgia b,
	material x,
	prescr_material a
where	a.cd_motivo_baixa		= 0
and	a.cd_material		= x.cd_material
and	x.cd_material_estoque	= coalesce(cd_material_w,x.cd_material_estoque)
and	a.nr_prescricao		= b.nr_prescricao
and	b.cd_setor_atendimento	= c.cd_setor_atendimento
and	c.cd_local_estoque	= cd_local_estoque_w
and coalesce(a.qt_total_dispensar,0) > 0
and	a.ie_status_cirurgia	in ('CB','AD')
and	coalesce(a.ie_baixa_estoque_cir::text, '') = ''
and	((ie_tipo_local_w = 2) or (ie_baixa_disp_w = 'S'))
and	ie_disp_cirurgia_w = 'S'
group by 	x.cd_material_estoque,
	b.nr_cirurgia,
	c.cd_local_estoque

union all

SELECT	1 ie_tipo,
	x.cd_material_estoque,
	b.nr_cirurgia,
	coalesce(a.cd_local_estoque, c.cd_local_estoque),
	coalesce(sum(qt_total_dispensar),0) qt_dispensar
from	setor_atendimento c,
	cirurgia b,
	material x,
	prescr_material a
where	a.cd_motivo_baixa		= 0
and	a.cd_material		= x.cd_material
and	x.cd_material_estoque	= coalesce(cd_material_w,x.cd_material_estoque)
and	a.nr_prescricao		= b.nr_prescricao
and	b.cd_setor_atendimento	= c.cd_setor_atendimento
and	coalesce(a.cd_local_estoque, c.cd_local_estoque) = cd_local_estoque_w
 and coalesce(a.qt_total_dispensar,0) > 0
and	a.ie_status_cirurgia	in ('CB','AD')
and	coalesce(a.ie_baixa_estoque_cir::text, '') = ''
and	((ie_tipo_local_w = 2) or (ie_baixa_disp_w = 'S'))
and	ie_disp_cirurgia_w = 'C'
group by	x.cd_material_estoque,
	b.nr_cirurgia,
	coalesce(a.cd_local_estoque, c.cd_local_estoque)

union all

select	/*+ index (d presmat_i3)*/	2 ie_tipo,
	e.cd_material_estoque,
	b.nr_cirurgia,
	a.cd_local_estoque,
	coalesce(sum(obter_quantidade_convertida(d.cd_material, d.qt_total_dispensar, d.cd_unidade_medida, 'UME')),0) qt_dispensar
from	setor_atendimento a,
	cirurgia b,
	prescr_medica c,
	prescr_material d,
	material e
where	b.nr_cirurgia		= c.nr_cirurgia
and	c.nr_prescricao		= d.nr_prescricao 
and	a.cd_setor_atendimento	= b.cd_setor_atendimento
and	d.cd_material		= e.cd_material		
and	a.cd_local_estoque	= cd_local_estoque_w
and	e.cd_material_estoque	= coalesce(cd_material_w,e.cd_material_estoque)
and	d.cd_motivo_baixa	= 0
and	d.ie_status_cirurgia	in ('CB','AD')
and	coalesce(d.ie_baixa_estoque_cir::text, '') = ''
and	((ie_tipo_local_w = 2) or (ie_baixa_disp_w = 'S'))
and	ie_disp_esp_cirurgia_w = 'S'
and coalesce(d.qt_total_dispensar,0) > 0
GROUP BY	e.cd_material_estoque,
	b.nr_cirurgia,
	a.cd_local_estoque
 HAVING	coalesce(sum(obter_quantidade_convertida(d.cd_material, d.qt_total_dispensar, d.cd_unidade_medida, 'UME')),0) <> 0

union all

select	/*+ index (d presmat_i3)*/	2 ie_tipo,
	e.cd_material_estoque,
	b.nr_cirurgia,
	coalesce(d.cd_local_estoque, a.cd_local_estoque),
	coalesce(sum(obter_quantidade_convertida(d.cd_material, d.qt_total_dispensar, d.cd_unidade_medida, 'UME')),0) qt_dispensar
from	setor_atendimento a,
	cirurgia b,
	prescr_medica c,
	prescr_material d,
	material e
where	b.nr_cirurgia		= c.nr_cirurgia
and	c.nr_prescricao		= d.nr_prescricao 
and	a.cd_setor_atendimento	= b.cd_setor_atendimento
and	d.cd_material		= e.cd_material		
and	coalesce(d.cd_local_estoque, a.cd_local_estoque) = cd_local_estoque_w
and	e.cd_material_estoque	= coalesce(cd_material_w,e.cd_material_estoque)
and	d.cd_motivo_baixa	= 0
and	d.ie_status_cirurgia	in ('CB','AD')
and	coalesce(d.ie_baixa_estoque_cir::text, '') = ''
and	((ie_tipo_local_w = 2) or (ie_baixa_disp_w = 'S'))
and	ie_disp_esp_cirurgia_w = 'C'
GROUP BY	e.cd_material_estoque,
	b.nr_cirurgia,
	coalesce(d.cd_local_estoque, a.cd_local_estoque HAVING	coalesce(sum(obter_quantidade_convertida(d.cd_material, d.qt_total_dispensar, d.cd_unidade_medida, 'UME')),0) <> 0
)

union all

select	/*+ index (a presmat_i3)*/	3 ie_tipo,
	x.cd_material_estoque,
	b.nr_prescricao,
	c.cd_local_estoque,
	coalesce(sum(qt_total_dispensar),0) qt_dispensar
from	setor_atendimento c,
	material x,
	prescr_medica b,
	prescr_material a
where	a.nr_prescricao		= b.nr_prescricao
and	a.cd_material           = x.cd_material
and	b.cd_setor_atendimento  = c.cd_setor_atendimento
and	b.ie_emergencia		= 'S'			
and	x.cd_material_estoque   = coalesce(cd_material_w,x.cd_material_estoque)			
and	c.cd_local_estoque     	= cd_local_estoque_w
and	a.cd_motivo_baixa	= 0
and	a.ie_status_cirurgia	= 'PE'
and	((ie_tipo_local_w = 2) or (ie_baixa_disp_w = 'S'))
and	ie_disp_prescr_eme_w = 'S'
and coalesce(a.qt_total_dispensar,0) > 0
GROUP BY	x.cd_material_estoque,
	b.nr_prescricao,
	c.cd_local_estoque
 HAVING	coalesce(sum(obter_quantidade_convertida(a.cd_material, a.qt_total_dispensar, a.cd_unidade_medida, 'UME')),0) <> 0

union all

select	4 ie_tipo,
	x.cd_material_estoque,
	b.nr_prescricao,
	c.cd_local_estoque,
	coalesce(sum(qt_total_dispensar),0) qt_dispensar
from	setor_atendimento c,
	material x,
	prescr_medica b,
	prescr_material a
where	a.nr_prescricao		= b.nr_prescricao
and	b.cd_setor_atendimento	= c.cd_setor_atendimento
and	a.cd_material		= x.cd_material
and	c.cd_local_estoque	= cd_local_estoque_w
and	x.cd_material_estoque	= coalesce(cd_material_w,x.cd_material_estoque)
and	a.cd_motivo_baixa	= 0
and	a.ie_status_cirurgia	= 'CB'
and	(b.nr_seq_agenda IS NOT NULL AND b.nr_seq_agenda::text <> '')
and	coalesce(b.nr_cirurgia::text, '') = ''
and coalesce(a.qt_total_dispensar,0) > 0
and 	not exists (	select	1
		from	cirurgia c
		where	c.nr_prescricao = a.nr_prescricao)
and	((ie_tipo_local_w = 2) or (ie_baixa_disp_w = 'S'))
and	ie_disp_ag_cirur_w = 'S'
GROUP BY	x.cd_material_estoque,
	b.nr_prescricao,
	c.cd_local_estoque
 HAVING	coalesce(sum(obter_quantidade_convertida(a.cd_material, a.qt_total_dispensar, a.cd_unidade_medida, 'UME')),0) <> 0

union all

select	/*+ index(b empmate_i1) index (c emprest_pk) */ 
	5 ie_tipo,
	x.cd_material_estoque,
	c.nr_emprestimo,
	c.cd_local_estoque,
	coalesce(sum(CASE WHEN c.ie_tipo='S' THEN  qt_material * -1  ELSE qt_material END ),0)
from	emprestimo c,
	emprestimo_material b,
	material x			
where	b.nr_emprestimo	= c.nr_emprestimo
and	b.cd_material 	= x.cd_material
and	c.cd_local_estoque	= cd_local_estoque_w
and	x.cd_material_estoque = coalesce(cd_material_w,x.cd_material_estoque)
and	b.qt_material	> 0
and	coalesce(b.ie_atualiza_estoque,'X') <> 'S'
and	c.ie_situacao	<> 'I'
and (coalesce(ie_disp_emprestimo_lib_w,'N') <> 'S' or (c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> ''))
and	ie_disp_nf_emprestimo_w = 'N'
and ((coalesce(c.ie_origem,'D') <> 'P') or ((c.dt_aprovacao IS NOT NULL AND c.dt_aprovacao::text <> '') and coalesce(c.dt_reprovacao::text, '') = '' and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')))
GROUP BY	x.cd_material_estoque,
	c.nr_emprestimo,
	c.cd_local_estoque
 HAVING	coalesce(sum(CASE WHEN c.ie_tipo='S' THEN  qt_material * -1  ELSE qt_material END ),0) <> 0

union all

select	/*+ index(b empmate_i1) index (c emprest_pk) */ 
	5 ie_tipo,
	x.cd_material_estoque,
	c.nr_emprestimo,
	c.cd_local_estoque,
	coalesce(sum(CASE WHEN c.ie_tipo='S' THEN (qt_material - coalesce(b.qt_nota_fiscal,0)) * -1  ELSE (qt_material - coalesce(b.qt_nota_fiscal,0)) END ),0)
from	emprestimo c,
	emprestimo_material b,
	material x			
where	b.nr_emprestimo	= c.nr_emprestimo
and	b.cd_material 	= x.cd_material
and	c.cd_local_estoque	= cd_local_estoque_w
and	x.cd_material_estoque = coalesce(cd_material_w,x.cd_material_estoque)
and	b.qt_material	> 0
and	coalesce(b.ie_atualiza_estoque,'X') <> 'S'
and	c.ie_situacao	<> 'I'
and (coalesce(ie_disp_emprestimo_lib_w,'N') <> 'S' or (c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> ''))
and	coalesce(ie_disp_nf_emprestimo_w,'X') <> 'N'
and ((coalesce(c.ie_origem,'D') <> 'P') or ((c.dt_aprovacao IS NOT NULL AND c.dt_aprovacao::text <> '') and coalesce(c.dt_reprovacao::text, '') = '' and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')))
GROUP BY	x.cd_material_estoque,
	c.nr_emprestimo,
	c.cd_local_estoque
 HAVING	coalesce(sum(CASE WHEN c.ie_tipo='S' THEN (qt_material - coalesce(b.qt_nota_fiscal,0)) * -1  ELSE (qt_material - coalesce(b.qt_nota_fiscal,0)) END ),0) <> 0

union all

select	6 ie_tipo,
	x.cd_material_estoque,
	b.nr_sequencia,
	d.cd_local_estoque,
	coalesce(sum(a.qt_dose_real),0)
from	far_etapa_producao c,
	can_ordem_prod b,
	can_ordem_prod_mat a,
	far_cabine_seg_biol d,
	material x
where	a.cd_material = x.cd_material
and	c.nr_seq_cabine = d.nr_sequencia
and	c.nr_sequencia = b.nr_seq_etapa_prod
and	b.nr_sequencia = a.nr_seq_ordem
and	x.cd_material_estoque = coalesce(cd_material_w,x.cd_material_estoque)
and	d.cd_local_estoque = cd_local_estoque_w
and	coalesce(b.dt_fim_preparo::text, '') = ''
and	coalesce(b.dt_entrega_setor::text, '') = ''
and	coalesce(b.dt_devolucao::text, '') = ''
and	b.ie_cancelada <> 'S'
and	ie_disp_quimioterapia_w = 'S'
GROUP BY	x.cd_material_estoque,
	b.nr_sequencia,
	d.cd_local_estoque
 HAVING	coalesce(sum(obter_quantidade_convertida(a.cd_material, a.qt_dose_real, a.cd_unidade_medida, 'UME')),0) <> 0

union all

select	7 ie_tipo,
	x.cd_material_estoque,
	b.nr_requisicao,
	b.cd_local_estoque,
	sum(coalesce(a.qt_estoque, 0)) - sum(coalesce(a.qt_material_atendida, 0))
from	operacao_estoque o,
	requisicao_material b,
	item_requisicao_material a,
	material x
where	a.nr_requisicao		= b.nr_requisicao
and	b.cd_operacao_estoque	= o.cd_operacao_estoque
and	a.cd_material 		= x.cd_material
and	x.cd_material_estoque 	= coalesce(cd_material_w,x.cd_material_estoque)
and	b.cd_estabelecimento	= cd_estabelecimento_p
and	b.cd_local_estoque		= cd_local_estoque_w
and	o.ie_tipo_requisicao		in ('2','21')
and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
and	ie_disp_req_trans_w = 'S'
and	exists ( Select d.cd_motivo_baixa
					from sup_motivo_baixa_req d
					where a.cd_motivo_baixa = d.nr_sequencia 
					and d.cd_motivo_baixa = 0  LIMIT 1) 
GROUP BY	x.cd_material_estoque,
	b.nr_requisicao,
	b.cd_local_estoque
 HAVING	coalesce(sum(obter_quantidade_convertida(a.cd_material, (coalesce(a.qt_material_requisitada, 0) - coalesce(a.qt_material_atendida, 0)), a.cd_unidade_medida, 'UME')),0) <> 0

union all

select	8 ie_tipo,
	x.cd_material_estoque,
	b.nr_ordem_compra,
	b.cd_local_estoque,
	obter_quantidade_convertida(b.cd_material, SUM(c.qt_prevista_entrega) - max(obter_qt_oci_trans_nota(a.nr_ordem_compra, b.nr_item_oci,'S')), b.cd_unidade_medida_compra, 'UME')
from	ordem_compra a,
	ordem_compra_item b,
	ordem_compra_item_entrega c,
	material x
where	a.nr_ordem_compra = b.nr_ordem_compra
and	a.nr_ordem_compra = c.nr_ordem_compra
and	b.nr_item_oci = c.nr_item_oci
and	b.cd_material = x.cd_material
and	coalesce(c.dt_cancelamento::text, '') = ''
and	coalesce(b.dt_reprovacao::text, '') = ''
and	(b.dt_aprovacao IS NOT NULL AND b.dt_aprovacao::text <> '')
and	coalesce(a.dt_baixa::text, '') = ''
and	coalesce(a.nr_seq_motivo_cancel::text, '') = ''
and	a.ie_tipo_ordem = 'T'
and (coalesce(c.qt_prevista_entrega,0) - coalesce(c.qt_real_entrega,0)) > 0
and	x.cd_material_estoque = coalesce(cd_material_w,x.cd_material_estoque)
and	a.cd_local_transf = cd_local_estoque_w
and	ie_disp_req_trans_estab_w = 'S'
GROUP BY x.cd_material_estoque,
        b.nr_ordem_compra,
        b.cd_local_estoque,
        a.nr_ordem_compra, 
        b.nr_item_oci, 
        b.cd_material, 
        b.cd_unidade_medida_compra
 HAVING	coalesce(sum(obter_quantidade_convertida(b.cd_material, coalesce(c.qt_prevista_entrega,0) - coalesce(c.qt_real_entrega,0), b.cd_unidade_medida_compra,'UME')),0) <> 0

union all

select	9 ie_tipo,
	x.cd_material_estoque,
	b.nr_sequencia,
	b.cd_local_estoque,
	coalesce(sum(a.qt_material), 0)
from	kit_estoque b,
	kit_estoque_comp a,
	material x
where	a.nr_seq_kit_estoque = b.nr_sequencia
and	a.cd_material = x.cd_material
and	b.cd_local_estoque = cd_local_estoque_w
and	x.cd_material_estoque = coalesce(cd_material_w, x.cd_material_estoque)
and	b.cd_estabelecimento	= cd_estabelecimento_p
and	coalesce(b.dt_utilizacao::text, '') = ''
and	coalesce(b.nr_seq_reg_kit::text, '') = ''
and	((coalesce(b.nr_seq_solic_kit::text, '') = '') or (a.ie_gerado_barras = 'S'))
and	coalesce(b.cd_setor_destino::text, '') = ''
and	ie_disp_comp_kit_estoque_w = 'S'
GROUP BY	x.cd_material_estoque,
	b.nr_sequencia,
	b.cd_local_estoque
 HAVING	coalesce(sum(obter_quantidade_convertida(a.cd_material, a.qt_material, x.cd_unidade_medida_consumo,'UME')),0) <> 0

union all

select	9 ie_tipo,
	x.cd_material_estoque,
	b.nr_sequencia,
	b.cd_local_estoque,
	coalesce(sum(a.qt_material), 0)
from	kit_estoque b,
	kit_estoque_comp a,
	material x
where	a.nr_seq_kit_estoque = b.nr_sequencia
and	a.cd_material = x.cd_material
and	b.cd_local_estoque = cd_local_estoque_w
and	x.cd_material_estoque = coalesce(cd_material_w, x.cd_material_estoque)
and	coalesce(b.dt_utilizacao::text, '') = ''
and	coalesce(b.nr_seq_reg_kit::text, '') = ''
and	a.ie_gerado_barras = 'S'
and	b.cd_estabelecimento	= cd_estabelecimento_p
and	coalesce(b.cd_setor_destino::text, '') = ''
and	ie_disp_comp_kit_estoque_w = 'C'
GROUP BY	x.cd_material_estoque,
	b.nr_sequencia,
	b.cd_local_estoque
 HAVING	coalesce(sum(obter_quantidade_convertida(a.cd_material, a.qt_material, x.cd_unidade_medida_consumo,'UME')),0) <> 0

union all

select	10 ie_tipo,
	x.cd_material_estoque,
	c.nr_sequencia,
	b.cd_local_estoque,
	coalesce(sum(a.qt_material),0)
from	kit_estoque_reg c,
	kit_estoque b,
	kit_estoque_comp a,
	material x
where	c.nr_sequencia		= b.nr_seq_reg_kit
and	a.nr_seq_kit_estoque	= b.nr_sequencia
and	a.cd_material 		= x.cd_material
and	b.cd_local_estoque		= cd_local_estoque_w
and	x.cd_material_estoque	= coalesce(cd_material_w, x.cd_material_estoque)
and	a.ie_gerado_barras	= 'S'
and	c.ie_situacao		= 'A'
and	coalesce(a.nr_seq_motivo_exclusao::text, '') = ''
and	coalesce(b.dt_utilizacao::text, '') = ''
and	coalesce(c.dt_utilizacao::text, '') = ''
and	ie_disp_reg_kit_estoque_w = 'S'
GROUP BY	x.cd_material_estoque,
	c.nr_sequencia,
	b.cd_local_estoque
 HAVING	coalesce(sum(obter_quantidade_convertida(a.cd_material, a.qt_material, x.cd_unidade_medida_consumo,'UME')),0) <> 0

union all

select	10 ie_tipo,
	x.cd_material_estoque,
	b.nr_sequencia,
	a.cd_local_estoque,
	coalesce(sum(a.qt_material),0)
from	kit_estoque_reg b,
	kit_estoque_comp_avulso a,
	material x
where	b.nr_sequencia		= a.nr_seq_reg_kit
and	a.cd_material 		= x.cd_material
and	x.cd_material_estoque	= coalesce(cd_material_w, x.cd_material_estoque)
and	a.cd_local_estoque		= cd_local_estoque_w
and	b.ie_situacao		= 'A'
and	a.ie_gerado_barras		= 'S'
and	coalesce(b.dt_utilizacao::text, '') = ''
and	ie_disp_reg_kit_estoque_w = 'S'
GROUP BY	x.cd_material_estoque,
	b.nr_sequencia,
	a.cd_local_estoque
 HAVING	coalesce(sum(obter_quantidade_convertida(a.cd_material, a.qt_material, x.cd_unidade_medida_consumo,'UME')),0) <> 0

union all

select	11 ie_tipo,
        a.cd_material,
        a.nr_seq_processo,
        d.cd_local_estoque,
        sum(qt_material) 
from	adep_processo_item a,
		adep_processo d
where	a.nr_seq_processo = d.nr_sequencia
and	coalesce(a.ie_nao_requisitado,'N') <> 'S'
and	a.ie_lanca_conta_adep = 'S'
and	a.cd_material = cd_material_w
and	coalesce(d.dt_cancelamento::text, '') = ''
and	d.cd_local_estoque = cd_local_estoque_w
and	d.ie_status_processo <> 'A'
and	coalesce(d.dt_leitura::text, '') = ''
and	d.dt_processo > clock_timestamp() - interval '2 days'
and	ie_disp_sep_gedipa_w = 'S'
group by	a.cd_material ,
            a.nr_seq_processo,
            d.cd_local_estoque

union all

select	12 ie_tipo,
		b.cd_material cd_material,
		a.nr_sequencia nr_sequencia,
		b.cd_local_estoque cd_local_estoque,
		coalesce(sum(b.qt_material),0)
from	ap_lote_item_consistido b,
        ap_lote a,
        prescr_medica c
where	b.cd_material = cd_material_w
and	b.cd_local_estoque = cd_local_estoque_w
and	c.cd_estabelecimento = cd_estabelecimento_p
and	a.ie_status_lote = 'CO'
and	a.nr_sequencia = b.nr_lote_ap
and	c.nr_prescricao = a.nr_prescricao
and	ie_disp_ap_lote_w = 'S'
group by b.cd_material,
		a.nr_sequencia,
		b.cd_local_estoque

union all

select	13 ie_tipo,
        a.cd_material,
        a.nr_lote_producao,
        a.cd_local_estoque,
        coalesce(sum(a.qt_prevista),0)
from	lote_producao_comp a,
		lote_producao b
where a.nr_lote_producao = b.nr_lote_producao
and a.cd_material = cd_material_w
and	a.cd_local_estoque = cd_local_estoque_w
and	b.cd_estabelecimento = cd_estabelecimento_p
and	coalesce(b.dt_confirmacao::text, '') = ''
and ie_disp_lote_prod_w = 'S'
group by a.cd_material,
        a.nr_lote_producao,
		a.cd_local_estoque;	
	
C03 CURSOR FOR
SELECT	cd_material,
	cd_local_estoque
FROM	w_razao_estoque
WHERE	nm_usuario = nm_usuario_p
GROUP BY cd_material,
	cd_local_estoque;


BEGIN

delete	FROM w_razao_estoque
where	nm_usuario = nm_usuario_p;

select	max(dt_mesano_vigente),
	coalesce(max(ie_disp_quimioterapia),'N'),
	coalesce(max(ie_disp_req_trans), 'N'),
	coalesce(max(ie_disp_prescr_eme), 'S'),
	coalesce(max(ie_disp_ag_cirur), 'N'),
	coalesce(max(ie_disp_comp_kit_estoque), 'N'),
	coalesce(max(ie_disp_reg_kit_estoque), 'N'),
	coalesce(max(ie_disp_emprestimo_lib), 'N'),
	coalesce(max(ie_disp_nf_emprestimo),'N'),
	coalesce(max(ie_disp_esp_cirurgia),'N'),
	coalesce(max(ie_disp_cirurgia),'S'),
	coalesce(max(ie_disp_req_trans_estab),'N'),
	coalesce(max(ie_disp_sep_gedipa),'N'),
	coalesce(max(ie_disp_ap_lote),'N'),
	coalesce(max(ie_disp_lote_prod),'N')
into STRICT	dt_mesano_referencia_w,
	ie_disp_quimioterapia_w,
	ie_disp_req_trans_w,
	ie_disp_prescr_eme_w,
	ie_disp_ag_cirur_w,
	ie_disp_comp_kit_estoque_w,
	ie_disp_reg_kit_estoque_w,
	ie_disp_emprestimo_lib_w,
	ie_disp_nf_emprestimo_w,
	ie_disp_esp_cirurgia_w,
	ie_disp_cirurgia_w,
	ie_disp_req_trans_estab_w,
	ie_disp_sep_gedipa_w,
	ie_disp_ap_lote_w,
	ie_disp_lote_prod_w
from	parametro_estoque
where	cd_estabelecimento	= cd_estabelecimento_p;

select	max(cd_material_estoque)
into STRICT	cd_material_w
from	material
where	cd_material = cd_material_p;

select	coalesce(max(qt_conv_estoque_consumo),1)
into STRICT	qt_conv_estoque_w
from	material
where	cd_material	= cd_material_w;


open  c01;
loop
fetch c01 into
	cd_local_estoque_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin	
	select	ie_tipo_local,
		coalesce(ie_baixa_disp, 'N')
	into STRICT	ie_tipo_local_w,
		ie_baixa_disp_w
	from 	local_estoque
	where	cd_local_estoque	= cd_local_estoque_w;

	open C02;
	loop
	fetch C02 into	
		ie_tipo_w,
		cd_material_estoque_w,
		nr_documento_w,
		cd_local_estoque_ww,
		qt_material_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		if (ie_tipo_w = 1 or ie_tipo_w = 3 or ie_tipo_w = 4 or ie_tipo_w = 6 or
				ie_tipo_w = 9 or ie_tipo_w = 10 or ie_tipo_w = 11 or ie_tipo_w = 12 or ie_tipo_w = 13) then
				qt_material_w := dividir(coalesce(qt_material_w,0),coalesce(qt_conv_estoque_w,1));
		end if;
		
		if (ie_tipo_w = 5) then
			ie_entrada_saida_w := 'E';
		else
			ie_entrada_saida_w := 'S';
		end if;
		
		insert	into w_razao_estoque(
			nr_sequencia,
			cd_Estabelecimento,
			cd_material,
			dt_atualizacao,
			dt_mesano_referencia,
			ie_tipo_informacao,
			nm_usuario,
			cd_local_estoque,
			ie_entrada_saida,
			qt_estoque,
			nr_documento)
		values (nextval('w_razao_estoque_seq'),
			cd_Estabelecimento_p,
			cd_material_estoque_w,
			clock_timestamp(),
			dt_mesano_referencia_p,
			ie_tipo_w,
			nm_usuario_p,
			cd_local_estoque_ww,
			ie_entrada_saida_w,
			qt_material_w,
			nr_documento_w);
		end;
	end loop;
	close C02;
	end;
end loop;
close c01;

open C03;
loop
fetch C03 into	
	cd_material_estoque_w,
	cd_local_estoque_ww;
EXIT WHEN NOT FOUND; /* apply on C03 */
	begin
	qt_saldo_w := obter_saldo_estoque(cd_estabelecimento_p, cd_material_estoque_w, cd_local_estoque_ww, trunc(dt_mesano_referencia_p,'mm'), qt_saldo_w);
	
	insert	into w_razao_estoque(
		nr_sequencia,
		cd_Estabelecimento,
		cd_material,
		dt_atualizacao,
		dt_mesano_referencia,
		ie_tipo_informacao,
		nm_usuario,
		cd_local_estoque,
		ie_entrada_saida,
		qt_estoque,
		nr_documento)
	values (nextval('w_razao_estoque_seq'),
		cd_Estabelecimento_p,
		cd_material_estoque_w,
		clock_timestamp(),
		dt_mesano_referencia_p,
		0,
		nm_usuario_p,
		cd_local_estoque_ww,
		'E',
		qt_saldo_w,
		null);
	end;
end loop;
close C03;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE w_gerar_saldo_disp_estoque ( cd_estabelecimento_p bigint, cd_material_p bigint, cd_local_estoque_p bigint, dt_mesano_referencia_p timestamp, nm_usuario_p text) FROM PUBLIC;

