-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_update_peso_atual_dialise ( nr_atendimento_p bigint, dt_referencia_p timestamp, qt_peso_atual_p bigint) AS $body$
DECLARE

								
nr_seq_dialise_w			cpoe_dialise.nr_sequencia%type;
ie_ultrafiltracao_w			cpoe_dialise.ie_ultrafiltracao%type;
qt_peso_ideal_w				cpoe_dialise.qt_peso_ideal%type;
qt_ultrafiltracao_w			cpoe_dialise.qt_ultrafiltracao%type;

c01 CURSOR FOR
SELECT	nr_sequencia,
		ie_ultrafiltracao,
		qt_peso_ideal,
		qt_ultrafiltracao
from	cpoe_dialise
where	nr_atendimento = nr_atendimento_p
and		ie_tipo_dialise = 'DI'
and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_referencia_p) between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio) and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(coalesce(dt_fim,clock_timestamp()));



BEGIN

/*open c01;
loop
fetch c01 into	nr_seq_dialise_w,
				ie_ultrafiltracao_w,
				qt_peso_ideal_w,
				qt_ultrafiltracao_w;
exit when c01%notfound;
begin
qt_ultrafiltracao_w := qt_ultrafiltracao_w;
/*if (ie_ultrafiltracao_w = 'UT') then	TRATAMENTO RETIRADO SERA REVISTO FUTURAMENTE
	qt_ultrafiltracao_w := ((qt_peso_atual_p - qt_peso_ideal_w) * 1000);
end if;
	
update	cpoe_dialise
set		qt_peso_atual 		= qt_peso_atual_p,
		qt_ultrafiltracao 	= qt_ultrafiltracao_w,
		dt_atualizacao_peso = sysdate
where	nr_sequencia 		= nr_seq_dialise_w;

update	hd_prescricao
set		qt_peso_atual 				= qt_peso_atual_p,
		qt_ultrafiltracao 			= qt_ultrafiltracao_w
where	nr_seq_dialise_cpoe 		= nr_seq_dialise_w
and 	trunc(dt_referencia_p) between trunc(dt_inicio_dialise) and  trunc(nvl(dt_fim_dialise,sysdate));

end;
end loop;
close c01;*/
null;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_update_peso_atual_dialise ( nr_atendimento_p bigint, dt_referencia_p timestamp, qt_peso_atual_p bigint) FROM PUBLIC;

