-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_carga_contrato ( dt_contrato_p timestamp, cd_cod_anterior_p text, cd_cgc_estipulante_p text, cd_pf_estipulante_p text, ie_reajuste_p text, ie_geracao_valores_p text, cd_cgc_congenere_p text, cd_cgc_emissor_p text, ie_tipo_operacao_p text, qt_dias_valid_cart_p bigint, dt_rescisao_contrato_p timestamp, dt_cancelamento_p timestamp, qt_anos_limite_reaj_p bigint, qt_idade_limite_reaj_p bigint, qt_intervalo_p bigint, nr_contrato_principal_p bigint, ie_renovacao_automatica_p text, ie_permite_prod_dif_p text, ie_itens_nao_cobertos_p text, ie_preco_co_operadora_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_seq_congenere_w		bigint;
nr_seq_emissor_w		bigint;
nr_contrato_principal_w		bigint;


BEGIN

/* Obter a sequência do congênere */

select	max(nr_sequencia)
into STRICT	nr_seq_congenere_w
from	pls_congenere
where	cd_cgc	= cd_cgc_congenere_p;

/* Verificar se a sequência correta do emissor já foi passada como parâmetro */

select	coalesce(max(nr_sequencia),0)
into STRICT	nr_seq_emissor_w
from	pls_emissor_carteira
where	nr_sequencia	= cd_cgc_emissor_p;

if (nr_seq_emissor_w	= 0) then
	select	max(a.nr_sequencia)
	into STRICT	nr_seq_emissor_w
	from	pls_emissor_carteira	a
	where	cd_cgc_emissor_p = (SELECT b.cd_cgc from pls_congenere b where b.nr_sequencia = a.nr_seq_congenere) or
		cd_cgc_emissor_p = (select b.cd_cgc_outorgante from pls_outorgante b where b.nr_sequencia = a.nr_seq_outorgante);
end if;

begin
select	max(nr_sequencia)
into STRICT	nr_contrato_principal_w
from	pls_contrato
where	cd_cod_anterior	= to_char(nr_contrato_principal_p);
exception
when others then
	nr_contrato_principal_w	:= null;
end;

insert into w_pls_carga_contrato(nr_sequencia, dt_contrato, dt_atualizacao,
	nm_usuario, cd_cod_anterior, cd_cgc_estipulante,
	cd_pf_estipulante, ie_reajuste, ie_geracao_valores,
	cd_cgc_congenere, nr_seq_congenere, cd_cgc_emissor,
	nr_seq_emissor, ie_tipo_operacao, qt_dias_valid_cart,
	dt_rescisao_contrato, dt_cancelamento, qt_anos_limite_reaj,
	qt_idade_limite_reaj, qt_intervalo, nr_contrato_principal,
	ie_renovacao_automatica, ie_permite_prod_dif, ie_itens_nao_cobertos,
	ie_preco_co_operadora, ie_situacao)
values (	nextval('w_pls_carga_contrato_seq'), dt_contrato_p, clock_timestamp(),
	nm_usuario_p, cd_cod_anterior_p, cd_cgc_estipulante_p,
	cd_pf_estipulante_p, ie_reajuste_p, ie_geracao_valores_p,
	cd_cgc_congenere_p, nr_seq_congenere_w, cd_cgc_emissor_p,
	nr_seq_emissor_w, ie_tipo_operacao_p, qt_dias_valid_cart_p,
	dt_rescisao_contrato_p, dt_cancelamento_p, qt_anos_limite_reaj_p,
	qt_idade_limite_reaj_p, qt_intervalo_p, nr_contrato_principal_w,
	ie_renovacao_automatica_p, ie_permite_prod_dif_p, ie_itens_nao_cobertos_p,
	ie_preco_co_operadora_p, '1');

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_carga_contrato ( dt_contrato_p timestamp, cd_cod_anterior_p text, cd_cgc_estipulante_p text, cd_pf_estipulante_p text, ie_reajuste_p text, ie_geracao_valores_p text, cd_cgc_congenere_p text, cd_cgc_emissor_p text, ie_tipo_operacao_p text, qt_dias_valid_cart_p bigint, dt_rescisao_contrato_p timestamp, dt_cancelamento_p timestamp, qt_anos_limite_reaj_p bigint, qt_idade_limite_reaj_p bigint, qt_intervalo_p bigint, nr_contrato_principal_p bigint, ie_renovacao_automatica_p text, ie_permite_prod_dif_p text, ie_itens_nao_cobertos_p text, ie_preco_co_operadora_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

