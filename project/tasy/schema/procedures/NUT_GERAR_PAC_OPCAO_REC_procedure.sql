-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE nut_gerar_pac_opcao_rec (nr_seq_opcao_p bigint, nr_seq_composicao_p bigint, nr_seq_receita_p bigint, nr_seq_servico_dia_p bigint, ie_acompanhante_p text, cd_acompanhante_p text, nr_seq_acompanhante_p bigint, nr_seq_cardapio_dia_p bigint, nr_seq_cardapio_p bigint, qt_refeicao_p bigint, nm_usuario_p text, nr_seq_card_refeicao_p bigint default null) AS $body$
DECLARE

 
nr_seq_opcao_rec_w		bigint;
nr_seq_servico_dia_w		bigint;
nr_seq_acompanhante_w		bigint;
cd_acompanhante_w		varchar(10);
nr_seq_cardapio_dia_w		bigint;
ie_tipo_cardapio_w		varchar(2);
nr_seq_opcao_w			bigint;
qt_pessoa_atend_w		bigint;
nr_seq_refeicao_w		bigint := null;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
nr_seq_receita_subst_w		nut_receita.nr_sequencia%type;
nr_seq_composicao_w		nut_composicao.nr_sequencia%type;
ir_receita_especial_w		varchar(1);
nr_seq_receita_w		nut_receita.nr_sequencia%type;
nr_seq_cardapio_w		nut_cardapio.nr_sequencia%type;
nr_seq_servico_w		nut_servico.nr_sequencia%type;
nr_atendimento_w		atendimento_paciente.nr_atendimento%type;


BEGIN 
 
nr_seq_composicao_w := nr_seq_composicao_p;
nr_seq_receita_w := nr_seq_receita_p;
ir_receita_especial_w := 'N';
nr_seq_cardapio_w := nr_seq_cardapio_p;
 
if (nr_seq_composicao_p <> 0) or (nr_seq_card_refeicao_p IS NOT NULL AND nr_seq_card_refeicao_p::text <> '') then 
 
	if (nr_seq_card_refeicao_p IS NOT NULL AND nr_seq_card_refeicao_p::text <> '') then 
		select	max(nr_seq_refeicao) 
		into STRICT	nr_seq_refeicao_w 
		from	nut_cardapio_refeicao 
		where	nr_sequencia = nr_seq_card_refeicao_p;
	end if;
 
	if (nr_seq_acompanhante_p = 0) then 
		nr_seq_acompanhante_w := null;
	else 
		nr_seq_acompanhante_w := nr_seq_acompanhante_p;
	end if;
	 
	if (cd_acompanhante_p = '0') then 
		cd_acompanhante_w := null;
	else 
		cd_acompanhante_w := cd_acompanhante_p;
	end if;
	 
	if (nr_Seq_opcao_p = 0) then 
		nr_Seq_opcao_w := null;
	else 
		nr_Seq_opcao_w := nr_Seq_opcao_p;
	end if;	
	 
	if (nr_seq_cardapio_dia_p = 0) then 
		nr_seq_cardapio_dia_w := null;
	else 
		nr_seq_cardapio_dia_w := nr_seq_cardapio_dia_p;
		 
		select 	ie_tipo_cardapio, 
			coalesce(qt_pessoa_atend,0) 
		into STRICT	ie_tipo_cardapio_w, 
			qt_pessoa_atend_w 
		from	nut_cardapio_dia 
		where	nr_sequencia = nr_seq_cardapio_dia_w;
	end if;
	 
	if (qt_refeicao_p IS NOT NULL AND qt_refeicao_p::text <> '') then 
		qt_pessoa_atend_w := qt_refeicao_p;
	end if;
	 
	if (nr_seq_servico_dia_p = 0) then 
		nr_seq_servico_dia_w:= null;
	else 
		nr_seq_servico_dia_w := nr_seq_servico_dia_p;
	end if;
	 
	if (ie_acompanhante_p = 'N') and (nr_seq_servico_dia_w IS NOT NULL AND nr_seq_servico_dia_w::text <> '') then 
		 
		select	max(a.cd_pessoa_fisica), 
			max(b.nr_seq_servico), 
			max(a.nr_atendimento)			 
		into STRICT	cd_pessoa_fisica_w, 
			nr_seq_servico_w, 
			nr_atendimento_w 
		from	atendimento_paciente a, 
			nut_atend_serv_dia b 
		where	a.nr_atendimento = b.nr_atendimento 
		and	b.nr_sequencia = nr_seq_servico_dia_w;
		 
		nr_seq_receita_subst_w := nut_obter_receita_subst(cd_pessoa_fisica_w, nr_seq_servico_w, nr_seq_receita_w);
			 
		if (nr_seq_receita_subst_w IS NOT NULL AND nr_seq_receita_subst_w::text <> '') then 
			 
			select	max(nr_seq_composicao) 
			into STRICT	nr_seq_composicao_w 
			from	nut_receita a 
			where	a.nr_sequencia = nr_seq_receita_subst_w;
			 
			nr_seq_opcao_w := null;
			ir_receita_especial_w := 'S';
			nr_seq_cardapio_dia_w := null;
			nr_seq_receita_w := nr_seq_receita_subst_w;
			nr_seq_cardapio_w := null;
						 
			CALL gravar_log_tasy(1194, 
					obter_texto_dic_objeto(732151, philips_param_pck.get_nr_seq_idioma, 'NR_ATENDIMENTO='||nr_atendimento_w|| 
					';NM_PESSOA_FISICA='||obter_nome_pf(cd_pessoa_fisica_w)||';NR_SEQ_RECEITA_OLD='||nr_seq_receita_p|| 
					';NR_SEQ_RECEITA_NEW='||nr_seq_receita_subst_w), 
					nm_usuario_p);
			 
		end if;
		 
	end if;
	 
	select	nextval('nut_pac_opcao_rec_seq') 
	into STRICT	nr_seq_opcao_rec_w 
	;
	 
	insert	into nut_pac_opcao_rec(nr_sequencia,      
		nr_seq_composicao,    
		nr_seq_receita, 
		nr_seq_opcao_sel, 
		nr_seq_servico_dia, 
		ie_receita_especial, 
		nr_seq_acompanhante, 
		cd_acompanhante, 
		nr_seq_cardapio_dia, 
		ie_tipo_cardapio, 
		dt_atualizacao,     
		nm_usuario,       
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_seq_cardapio, 
		qt_refeicao, 
		nr_seq_refeicao) 
	values (nr_seq_opcao_rec_w, 
		nr_seq_composicao_w, 
		nr_seq_receita_w, 
		nr_seq_opcao_w, 
		nr_seq_servico_dia_w, 
		ir_receita_especial_w, 
		nr_seq_acompanhante_w, 
		cd_acompanhante_w, 
		nr_seq_cardapio_dia_w, 
		ie_tipo_cardapio_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_seq_cardapio_w, 
		qt_pessoa_atend_w, 
		nr_seq_refeicao_w);
 
	commit;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nut_gerar_pac_opcao_rec (nr_seq_opcao_p bigint, nr_seq_composicao_p bigint, nr_seq_receita_p bigint, nr_seq_servico_dia_p bigint, ie_acompanhante_p text, cd_acompanhante_p text, nr_seq_acompanhante_p bigint, nr_seq_cardapio_dia_p bigint, nr_seq_cardapio_p bigint, qt_refeicao_p bigint, nm_usuario_p text, nr_seq_card_refeicao_p bigint default null) FROM PUBLIC;

