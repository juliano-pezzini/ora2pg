-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_generate_calc_therap ( ie_change_prioridade_p text, ie_volume_fixo_p text, cd_material_p bigint, qt_dose_p INOUT bigint, cd_unidade_medida_p INOUT text, cd_mat_dil_p bigint, qt_dose_dil_p INOUT bigint, cd_unidade_medida_dil_p INOUT text, qt_periodo_hora_p bigint, qt_dose_total_fixo_p INOUT bigint, qt_dose_terap_p INOUT bigint, cd_unid_med_dose_terapeutica_p bigint, qt_vel_infusao_p INOUT bigint, ie_unidade_vel_p INOUT text, qt_altura_p bigint, qt_peso_p bigint, qt_sc_p bigint, qt_imc_p bigint, qt_concent_final_out_p INOUT cpoe_material.qt_dose%type, cd_unidade_med_concent_out_p INOUT cpoe_material.cd_unidade_medida%type, ie_problema_um_p INOUT text) AS $body$
DECLARE


qt_vel_infusao_w	bigint;
cd_unidade_medida_ml_w	cpoe_material.cd_unidade_medida%type;
qt_dose_convert_concent_w	cpoe_material.qt_dose%type;
qt_dose_dil_ml_w	cpoe_material.qt_dose%type;
qt_dose_dil_convert_w	cpoe_material.qt_dose%type;
qt_dose_fake_out_w	bigint;


qt_velocidade_w				bigint;
qt_dose_direta_w			bigint;
qt_vel_infusao_mlh_w		bigint;
ie_unidade_w				regra_dose_terap.ie_unidade%type;
ie_tempo_w					varchar(15);
ie_peso_w					varchar(15);
qt_peso_w					bigint;
qt_dose_terap_w				bigint;
qt_dose_terap_ml_w			bigint;
qt_dose_terap_ml2_w			bigint;
qt_concentracao_w			bigint;
qt_dose_ml_w				bigint;
qt_dose_total_fixo_w		bigint;
cd_unidade_medida_concent_w	unidade_medida.cd_unidade_medida%type;
cd_unidade_med_dose_terap_w unidade_medida.cd_unidade_medida%type;

/*Medical Device*/

sql_w varchar(700);
qt_convert_vel_infusao_w bigint;
qt_dose_convert_terap_w  bigint := 0;
ie_param_controle_w      bigint;


BEGIN

cd_unidade_medida_ml_w := obter_unid_med_usua('ml');

select	min(a.cd_unidade_medida)
into STRICT	cd_unidade_med_concent_out_p
from	material_conversao_unidade a,
	unidade_medida b
where	a.cd_material = cd_material_p
and	a.cd_unidade_medida = cd_unidade_medida_p
and	a.cd_unidade_medida = b.cd_unidade_medida
and	b.ie_unidade_med_inter in ('mg', 'MCG', 'UI')
order by a.ie_prioridade;

if (coalesce(cd_unidade_med_concent_out_p::text, '') = '') then
	begin
      select min(tbl.unid_med)
      into STRICT cd_unidade_med_concent_OUT_p
      from (
        SELECT b.cd_unidade_medida unid_med
        from unidade_medida b, material_conversao_unidade a
        where upper(b.ie_unidade_med_INter) IN ('MG', 'MCG', 'UI')
          and b.ie_situacao = 'A'
          and upper(a.cd_unidade_medida) = upper(b.cd_unidade_medida)
          and cd_material = cd_material_p
        order by CASE WHEN upper(b.cd_unidade_medida)='MG' THEN  1 WHEN upper(b.cd_unidade_medida)='MCG' THEN  2 WHEN upper(b.cd_unidade_medida)='UI' THEN  3  ELSE 4 END  asc
      ) tbl LIMIT 1;
    exception
      when others then
         cd_unidade_med_concent_OUT_p := NULL;
    end;
end if;

if (cd_unidade_med_concent_out_p IS NOT NULL AND cd_unidade_med_concent_out_p::text <> '') then
	ie_problema_um_p := 'N';

	select	max(ie_tempo),
			max(ie_peso),
			max(ie_unidade)
	into STRICT	ie_tempo_w,
			ie_peso_w,
			ie_unidade_w
	from	regra_dose_terap
	where	nr_sequencia	= cd_unid_med_dose_terapeutica_p;
	
	select 	max(a.cd_unidade_medida)
	into STRICT	cd_unidade_medida_concent_w
	from 	material_conversao_unidade a, unidade_medida b
	where	a.cd_material = cd_material_p
	and a.cd_unidade_medida = b.cd_unidade_medida
	and upper(b.ie_unidade_med_inter) = upper(cd_unidade_med_concent_out_p);
	
	select 	max(a.cd_unidade_medida)
	into STRICT	cd_unidade_med_dose_terap_w
	from 	material_conversao_unidade a, unidade_medida b
	where	a.cd_material = cd_material_p
	and a.cd_unidade_medida = b.cd_unidade_medida
	and upper(b.ie_unidade_med_inter) = upper(ie_unidade_w);
	
	-- Medical device - qt_peso
    BEGIN
        sql_w := 'CALL calcular_qt_peso_md(:1, :2) into :qt_peso_w';
        EXECUTE sql_w USING IN qt_peso_p, IN ie_peso_w, OUT qt_peso_w;
        EXCEPTION WHEN others THEN qt_peso_w := 1;
    END;
    -- End of Medical device - qt_peso
	
	qt_dose_ml_w := obter_dose_convertida(cd_material_p, qt_dose_p, cd_unidade_medida_p, cd_unidade_medida_ml_w);
	qt_dose_dil_ml_w := obter_dose_convertida(cd_mat_dil_p, qt_dose_dil_p, cd_unidade_medida_dil_p, cd_unidade_medida_ml_w);
	qt_dose_terap_ml_w  := obter_dose_convertida(cd_material_p, qt_dose_terap_p, cd_unidade_med_dose_terap_w, cd_unidade_medida_ml_w);

	if (ie_volume_fixo_p = 'N') then

		-- Medical device - change priority
        BEGIN
            sql_w := 'BEGIN obter_change_prioridade_md(:1, :2, :3); END;';
            EXECUTE sql_w USING IN ie_change_prioridade_p, IN OUT qt_vel_infusao_p, IN OUT qt_dose_terap_p;
            EXCEPTION WHEN others THEN
                qt_vel_infusao_p := null;
                qt_dose_terap_p := null;
        END;
        -- End of Medical device - change priority
		qt_dose_convert_concent_w	:= obter_dose_convertida(cd_material_p, qt_dose_p, cd_unidade_medida_p, cd_unidade_med_concent_out_p);
		
		if (coalesce(qt_dose_convert_concent_w, 0) > 0 and coalesce(qt_dose_ml_w, 0) > 0 and coalesce(qt_dose_dil_ml_w, 0 ) > 0) then
			-- Medical device - qt_concent_final_out
            BEGIN
                sql_w := 'CALL calcular_concent_final_md(:1, :2, :3, :4, :5) INTO :qt_concent_final_out_p';
                EXECUTE sql_w USING   IN qt_dose_convert_concent_w,
                                                IN qt_dose_ml_w,
                                                IN qt_dose_dil_ml_w,
                                                IN qt_dose_total_fixo_p,
                                                IN 0,
                                                OUT qt_concent_final_out_p;
                EXCEPTION WHEN others THEN qt_concent_final_out_p := null;
            END;
            -- End of Medical device - qt_concent_final_out
		end if;

		qt_concentracao_w := obter_dose_convertida(cd_material_p, qt_concent_final_out_p, cd_unidade_medida_concent_w, cd_unidade_med_dose_terap_w);

		if (qt_dose_terap_p > 0) then
            -- Medical device - qt_vel_infusao
            BEGIN
                sql_w := 'CALL calcular_velocidade_infusao_md(:1, :2, :3, :4, :5, :6) INTO :qt_vel_infusao_p';
                EXECUTE sql_w USING   IN qt_dose_terap_p,
                                                IN ie_peso_w,
                                                IN qt_peso_w,
                                                IN qt_concentracao_w,
                                                IN ie_tempo_w,
                                                IN ie_unidade_vel_p,
                                                OUT qt_vel_infusao_p;
                EXCEPTION WHEN others THEN qt_vel_infusao_p := null;
            END;
            -- End of Medical device - qt_vel_infusao
		else
			-- Medical device - qt_dose_terap
            BEGIN
                sql_w := 'CALL calcular_dose_terap_md(:1, :2, :3, :4, :5, :6, :7, :8, :9) INTO :qt_dose_terap_p';
                EXECUTE sql_w USING   IN ie_unidade_vel_p,
                                                IN qt_vel_infusao_p,
                                                IN qt_concentracao_w,
                                                IN ie_peso_w,
                                                IN qt_peso_p,
                                                IN ie_tempo_w,
                                                IN 0,
                                                IN qt_dose_p,
                                                IN qt_dose_total_fixo_p,
                                                OUT qt_dose_terap_p;
                EXCEPTION WHEN others THEN qt_dose_terap_p := null;
            END;
            -- End of Medical device - qt_dose_terap
		end if;

	elsif (ie_volume_fixo_p = 'S') then

		if (coalesce(qt_dose_total_fixo_p, 0) = 0 OR ie_change_prioridade_p = 'L') then
          qt_dose_total_fixo_p := qt_dose_ml_w + qt_dose_dil_ml_w;
        end if;

		if (ie_change_prioridade_p = 'C') then
			qt_concentracao_w := obter_dose_convertida(cd_material_p, qt_concent_final_out_p, cd_unidade_medida_concent_w, cd_unidade_medida_ml_w);
			-- Medical device - qt_dose_ml
            BEGIN
                sql_w := 'CALL calcular_dose_therap_md(:1, :2, :3, :4, :5) INTO :qt_dose_ml_w';
                EXECUTE sql_w USING   IN qt_concentracao_w,
                                                IN qt_dose_total_fixo_p,
                                                IN qt_convert_vel_infusao_w,
                                                IN qt_dose_convert_terap_w,
                                                IN 0,
                                                OUT qt_dose_ml_w;
                EXCEPTION WHEN others THEN qt_dose_ml_w := null;
            END;
            -- End of Medical device - qt_dose_ml
		end if;

		if (ie_change_prioridade_p = 'D') then
			if (coalesce(qt_dose_terap_ml_w, 0) > 0 and coalesce(qt_vel_infusao_p, 0) > 0) then
				-- Medical device - qt_convert_vel_infusao
                BEGIN
                    sql_w := 'CALL converte_velocidade_infusao_md(:1, :2, :3) INTO :qt_convert_vel_infusao_w';
                    EXECUTE sql_w USING   IN ie_unidade_vel_p,
                                                    IN 'mlh',
                                                    IN qt_vel_infusao_p,
                                                    OUT qt_convert_vel_infusao_w;
                    EXCEPTION WHEN others THEN qt_convert_vel_infusao_w := null;
                END;
                -- End of Medical device - qt_convert_vel_infusao
                
                -- Medical device - qt_dose_ml
                BEGIN
                    sql_w := 'CALL calcular_dose_therap_md(:1, :2, :3, :4, :5) INTO :qt_dose_ml_w';
                    EXECUTE sql_w USING   IN qt_concent_final_out_p,
                                                    IN qt_dose_total_fixo_p,
                                                    IN qt_convert_vel_infusao_w,
                                                    IN qt_dose_terap_ml_w,
                                                    IN 1,
                                                    OUT qt_dose_ml_w;
                    EXCEPTION WHEN others THEN qt_dose_ml_w := null;
                END;
                -- End of Medical device - qt_dose_ml
			end if;
		end if;

		if (ie_change_prioridade_p <> 'D') then
			if (coalesce(qt_dose_terap_ml_w::text, '') = '' or (qt_dose_terap_ml_w IS NOT NULL AND qt_dose_terap_ml_w::text <> '' AND qt_vel_infusao_p IS NOT NULL AND qt_vel_infusao_p::text <> '')) then
                -- Medical device - qt_dose_terap
                BEGIN
                    sql_w := 'CALL calcular_dose_terap_md(:1, :2, :3, :4, :5, :6, :7, :8, :9) INTO :qt_dose_terap_ml_w';
                    EXECUTE sql_w USING   IN ie_unidade_vel_p,
                                                    IN qt_vel_infusao_p,
                                                    IN qt_concent_final_out_p,
                                                    IN ie_peso_w,
                                                    IN qt_peso_p,
                                                    IN ie_tempo_w,
                                                    IN 1,
                                                    IN qt_dose_ml_w,
                                                    IN qt_dose_total_fixo_p,
                                                    OUT qt_dose_terap_ml_w;
                    EXCEPTION WHEN others THEN qt_dose_terap_ml_w := null;
                END;
                -- End of Medical device - qt_dose_terap
			end if;
		end if;

		if (ie_change_prioridade_p <> 'C') then
			qt_dose_convert_concent_w	:= obter_dose_convertida(cd_material_p, qt_dose_ml_w, cd_unidade_medida_ml_w, cd_unidade_med_concent_out_p);

			if (coalesce(qt_dose_convert_concent_w, 0) > 0 and coalesce(qt_dose_total_fixo_p, 0) > 0) then
				-- Medical device - qt_concent_final_out
                BEGIN
                    sql_w := 'CALL calcular_concent_final_md(:1, :2, :3, :4, :5) INTO :qt_concent_final_out_p';
                    EXECUTE sql_w USING   IN qt_dose_convert_concent_w,
                                                    IN qt_dose_ml_w,
                                                    IN qt_dose_dil_ml_w,
                                                    IN qt_dose_total_fixo_p,
                                                    IN 1,
                                                    OUT qt_concent_final_out_p;
                    exception when others then qt_concent_final_out_p := null;
                END;
                -- End of Medical device - qt_concent_final_out
			end if;
		end if;
		
        qt_dose_dil_ml_w := qt_dose_total_fixo_p - qt_dose_ml_w;
		qt_dose_p := obter_dose_convertida(cd_material_p, qt_dose_ml_w, cd_unidade_medida_ml_w, cd_unidade_medida_p);
		qt_dose_dil_p := obter_dose_convertida(cd_mat_dil_p, qt_dose_dil_ml_w, cd_unidade_medida_ml_w, cd_unidade_medida_dil_p);
        qt_dose_terap_p := obter_dose_convertida(cd_material_p, qt_dose_terap_ml_w, cd_unidade_medida_ml_w, cd_unidade_med_dose_terap_w);
	end if;
else

  qt_dose_p := 0.0;
  cd_unidade_medida_p := 0.0;
  qt_dose_dil_p := 0.0;
  cd_unidade_medida_dil_p := 0.0;
  qt_dose_total_fixo_p := 0.0;
  qt_dose_terap_p := 0.0;
  qt_vel_infusao_p := 0.0;
  ie_unidade_vel_p := 0.0;
  qt_concent_final_out_p := 0.0;
  cd_unidade_med_concent_out_p := 0.0;
  ie_problema_um_p := 'S';

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_generate_calc_therap ( ie_change_prioridade_p text, ie_volume_fixo_p text, cd_material_p bigint, qt_dose_p INOUT bigint, cd_unidade_medida_p INOUT text, cd_mat_dil_p bigint, qt_dose_dil_p INOUT bigint, cd_unidade_medida_dil_p INOUT text, qt_periodo_hora_p bigint, qt_dose_total_fixo_p INOUT bigint, qt_dose_terap_p INOUT bigint, cd_unid_med_dose_terapeutica_p bigint, qt_vel_infusao_p INOUT bigint, ie_unidade_vel_p INOUT text, qt_altura_p bigint, qt_peso_p bigint, qt_sc_p bigint, qt_imc_p bigint, qt_concent_final_out_p INOUT cpoe_material.qt_dose%type, cd_unidade_med_concent_out_p INOUT cpoe_material.cd_unidade_medida%type, ie_problema_um_p INOUT text) FROM PUBLIC;

