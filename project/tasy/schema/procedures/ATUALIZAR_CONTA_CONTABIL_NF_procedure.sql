-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_conta_contabil_nf ( cd_estabelecimento_p bigint, nr_sequencia_p bigint, cd_grupo_desconsidera_p bigint, cd_subgrupo_desconsidera_p bigint, cd_classe_desconsidera_p bigint, cd_material_desconsidera_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_centro_custo_w		bigint;
cd_conta_contabil_w		varchar(20);
ds_erro_w			varchar(500);
dt_entrada_saida_w		timestamp;
cd_operacao_nf_w		nota_fiscal.cd_operacao_nf%type;
vl_regra_w			double precision;
cd_natureza_operacao_w		nota_fiscal.cd_natureza_operacao%type;
cd_sequencia_parametro_w 	parametros_conta_contabil.cd_sequencia_parametro%type;

c01 CURSOR FOR
SELECT	a.nr_nota_fiscal,
	a.nr_item_nf,
	a.cd_material,
	a.cd_procedimento,
	a.ie_origem_proced,
	a.cd_local_estoque,
	a.cd_centro_custo,
	a.cd_conta_contabil,
	a.nr_seq_proj_rec
from	nota_fiscal_item a,
	estrutura_material_v e
where	a.cd_material = e.cd_material
and	((cd_grupo_desconsidera_p = 0) or
	(cd_grupo_desconsidera_p > 0 AND e.cd_grupo_material <> cd_grupo_desconsidera_p))
and	((cd_subgrupo_desconsidera_p = 0) or
	(cd_subgrupo_desconsidera_p > 0 AND e.cd_subgrupo_material <> cd_subgrupo_desconsidera_p))
and	((cd_classe_desconsidera_p = 0) or
	(cd_classe_desconsidera_p > 0 AND e.cd_classe_material <> cd_classe_desconsidera_p))
and	((cd_material_desconsidera_p = 0) or
	(cd_material_desconsidera_p > 0 AND e.cd_material <> cd_material_desconsidera_p))
and	a.nr_sequencia	= nr_sequencia_p

union

SELECT	a.nr_nota_fiscal,
	a.nr_item_nf,
	a.cd_material,
	a.cd_procedimento,
	a.ie_origem_proced,
	a.cd_local_estoque,
	a.cd_centro_custo,
	a.cd_conta_contabil,
	a.nr_seq_proj_rec
from	nota_fiscal_item a
where	a.nr_sequencia	= nr_sequencia_p
and	(a.cd_procedimento IS NOT NULL AND a.cd_procedimento::text <> '')
and	coalesce(a.cd_material::text, '') = '';


Vet01	C01%RowType;


BEGIN
/* Dados da nota fiscal */

select	a.dt_entrada_saida,
	a.cd_operacao_nf,
	a.cd_natureza_operacao
into STRICT	dt_entrada_saida_w,
	cd_operacao_nf_w,
	cd_natureza_operacao_w
from	nota_fiscal a
where	a.nr_sequencia = nr_sequencia_p;

open C01;
loop
fetch C01 into
	Vet01;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	cd_centro_custo_w	     := Vet01.cd_centro_custo;
	cd_sequencia_parametro_w := null;

	begin
	vl_regra_w := obter_valor_item_regra(nr_sequencia_p, Vet01.nr_item_nf);
	SELECT * FROM SELECT * FROM define_conta_contabil(	2, cd_estabelecimento_p, '', '', null, null, Vet01.cd_material, Vet01.cd_procedimento, Vet01.ie_origem_proced, Vet01.cd_local_estoque, cd_conta_contabil_w, cd_centro_custo_w, '', dt_entrada_saida_w, null, null, cd_operacao_nf_w, cd_natureza_operacao_w, null, Vet01.nr_seq_proj_rec) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w INTO cd_conta_contabil_w, cd_centro_custo_w;
	cd_sequencia_parametro_w :=	philips_contabil_pck.get_parametro_conta_contabil();

	exception when others then
			ds_erro_w	:= SQLERRM(SQLSTATE);
			CALL wheb_mensagem_pck.exibir_mensagem_abort(265567,'NR_NOTA_FISCAL=' || Vet01.nr_nota_fiscal || ';DS_ERRO=' || ds_erro_w);
			--'Erro ao obter a conta contabil da nota fiscal: ' || Vet01.nr_nota_fiscal || chr(13) || ds_erro_w || '#@#@');
	end;
	if (cd_conta_contabil_w <> coalesce(Vet01.cd_conta_contabil,'0')) or (cd_centro_custo_w <> coalesce(Vet01.cd_centro_custo,0)) then

		update	nota_fiscal_item
		set	cd_conta_contabil	= cd_conta_contabil_w,
			cd_centro_custo	= cd_centro_custo_w,
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp(),
			cd_sequencia_parametro = cd_sequencia_parametro_w
		where	nr_sequencia	= nr_sequencia_p
		and	nr_item_nf	= Vet01.nr_item_nf;

		CALL gerar_historico_nota_fiscal(
			nr_sequencia_p,
			nm_usuario_p,
			'30',
			wheb_mensagem_pck.get_texto(310981,'CD_CONTA_CONTABIL_W=' || cd_conta_contabil_w || ';NM_USUARIO_W=' || nm_usuario_p));

	end if;
	end;
end loop;
close C01;
commit;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_conta_contabil_nf ( cd_estabelecimento_p bigint, nr_sequencia_p bigint, cd_grupo_desconsidera_p bigint, cd_subgrupo_desconsidera_p bigint, cd_classe_desconsidera_p bigint, cd_material_desconsidera_p bigint, nm_usuario_p text) FROM PUBLIC;

