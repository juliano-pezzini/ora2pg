-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cus_importar_ind_resultado ( cd_estabelecimento_p bigint, dt_mes_referencia_p timestamp, cd_centro_controle_p bigint, nr_seq_indicador_p bigint, qt_indicador_p bigint, vl_indicador_p bigint, ie_orcado_real_p text, nm_usuario_p text) AS $body$
DECLARE


cd_tabela_custo_w		tabela_custo.cd_tabela_custo%type;
ie_ocado_real_w			tabela_custo.ie_orcado_real%type;
nr_seq_tabela_w			tabela_custo.nr_sequencia%type;
cd_empresa_w			empresa.cd_empresa%type;
qt_registro_w			smallint;


BEGIN

/* ************************************************************************* */

cd_empresa_w	:= obter_empresa_estab(cd_estabelecimento_p);

begin
	select	cd_tabela_custo,
		nr_sequencia
	into STRICT	cd_tabela_custo_w,
		nr_seq_tabela_w
	from	tabela_custo
	where	cd_tipo_tabela_custo	= 11 /* Resultado Centro Controle */
	and	coalesce(cd_estabelecimento,cd_estabelecimento_p)	= cd_estabelecimento_p
	and	cd_empresa		= cd_empresa_w
	and	ie_orcado_real		= ie_orcado_real_p
	and	dt_mes_referencia	= dt_mes_referencia_p  LIMIT 1;
exception
when others then
	/*Não existe tabela de resultado cadastrada para este mês de referência!#@#@');*/

	CALL wheb_mensagem_pck.exibir_mensagem_abort(266456);
end;
/* ************************************************************************* */

/* ************************************************************************* */

/* O centro de controle: CD_CENTRO_CONTROLE_P, não está cadastrado no custo! */

begin
	select	1
	into STRICT	qt_registro_w
	from	centro_controle
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	cd_centro_controle	= cd_centro_controle_p  LIMIT 1;
exception
when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(266457,'CD_CENTRO_CONTROLE_P=' || cd_centro_controle_p);
end;
/* ************************************************************************* */

/* ************************************************************************* */

/* Não existe o cadastro do indicador de resultado: IND */

begin
	select	1
	into STRICT	qt_registro_w
	from	resultado_indicador a
	where	a.nr_sequencia		= nr_seq_indicador_p
	and (a.ie_forma_obtencao = 'C' or ie_orcado_real_p = 'O')  LIMIT 1;
exception
when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(266458,'IND=' || nr_seq_indicador_p);
end;
/* ************************************************************************* */

/* ************************************************************************* */

/*  Este indicador: IND, não está vinculado ao centro: CENTRO */

begin
	select	1
	into STRICT	qt_registro_w
	from	centro_controle_indicador
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	cd_centro_controle	= cd_centro_controle_p
	and	nr_seq_indicador	= nr_seq_indicador_p  LIMIT 1;
exception
when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(266459,'IND=' || nr_seq_indicador_p || ';CENTRO=' || cd_centro_controle_p);
end;
/* ************************************************************************* */

/* ************************************************************************* */

/* Gerar ou atualizar o indicador */

begin
select	1
into STRICT	qt_registro_w
from	resultado_ind_cen_cont
where	cd_estabelecimento	= cd_estabelecimento_p
and	cd_centro_controle	= cd_centro_controle_p
and	nr_seq_indicador	= nr_seq_indicador_p
and	nr_seq_tabela		= nr_seq_tabela_w  LIMIT 1;
exception
when others then
	qt_registro_w := 0;
end;

if (qt_registro_w = 0) then
	begin
	insert into resultado_ind_cen_cont(
		cd_estabelecimento,
		cd_tabela_custo,
		nr_seq_tabela,
		cd_centro_controle,
		nr_seq_indicador,
		nm_usuario,
		dt_atualizacao,
		qt_indicador,
		vl_indicador,
		dt_atualizacao_nrec,
		nm_usuario_nrec)
	values (	cd_estabelecimento_p,
		cd_tabela_custo_w,
		nr_seq_tabela_w,
		cd_centro_controle_p,
		nr_seq_indicador_p,
		nm_usuario_p,
		clock_timestamp(),
		qt_indicador_p,
		vl_indicador_p,
		clock_timestamp(),
		nm_usuario_p);
	end;
else
	begin
	update	resultado_ind_cen_cont
	set	qt_indicador		= qt_indicador_p,
		vl_indicador		= vl_indicador_p
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	cd_centro_controle	= cd_centro_controle_p
	and	nr_seq_indicador	= nr_seq_indicador_p
	and	nr_seq_tabela		= nr_seq_tabela_w;
	end;
end if;
/* ************************************************************************* */

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cus_importar_ind_resultado ( cd_estabelecimento_p bigint, dt_mes_referencia_p timestamp, cd_centro_controle_p bigint, nr_seq_indicador_p bigint, qt_indicador_p bigint, vl_indicador_p bigint, ie_orcado_real_p text, nm_usuario_p text) FROM PUBLIC;

