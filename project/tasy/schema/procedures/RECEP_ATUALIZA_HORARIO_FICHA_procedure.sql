-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE recep_atualiza_horario_ficha ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


dt_hora_inicio_w	timestamp;
dt_primeiro_horario_w timestamp;

BEGIN

if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then
	begin

	select  dt_primeiro_horario
	into STRICT	dt_primeiro_horario_w
	from 	recep_ficha_pre
	where	nr_sequencia = nr_sequencia_p;

	if (coalesce(dt_primeiro_horario_w::text, '') = '') then
		begin

		select 	min(b.hr_inicio)
		into STRICT	dt_hora_inicio_w
		from 	agenda_paciente b,
				recep_ficha_pre_agenda a
		where 	a.nr_seq_agenda = b.nr_sequencia
		and 	a.nr_seq_ficha = nr_sequencia_p;

		update 	recep_ficha_pre
		set		dt_primeiro_horario = dt_hora_inicio_w
		where 	nr_sequencia = nr_sequencia_p;

		end;
	end if;
	end;
end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE recep_atualiza_horario_ficha ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

