-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_fluxo_caixa_html (nm_usuario_p text) AS $body$
DECLARE


ie_classificacao_w	 		FLUXO_CAIXA_FILTRO.ie_classificacao%type;
ie_operacao_w	 			FLUXO_CAIXA_FILTRO.ie_operacao%type;
ie_periodo_w 				FLUXO_CAIXA_FILTRO.ie_periodo%type;
ie_restringir_estab_w 		FLUXO_CAIXA_FILTRO.ie_restringir_estab%type;
ie_todas_contas_w 			FLUXO_CAIXA_FILTRO.ie_todas_contas%type;
ie_dias_uteis_w 			FLUXO_CAIXA_FILTRO.ie_dias_uteis%type;
ie_somente_ativo_result_w 	FLUXO_CAIXA_FILTRO.ie_somente_ativo_result%type;
vl_saldo_anterior_w 		FLUXO_CAIXA_FILTRO.vl_saldo_anterior%type;
nr_nivel_w 					FLUXO_CAIXA_FILTRO.nr_nivel%type;
dt_inicial_w 				FLUXO_CAIXA_FILTRO.dt_inicial%type;
dt_final_w 					FLUXO_CAIXA_FILTRO.dt_final%type;
cd_conta_financ_w 			FLUXO_CAIXA_FILTRO.CD_CONTA_FINANC_AVANCADO%type;
nm_usuario_w				FLUXO_CAIXA_FILTRO.nm_usuario%type;
cd_estabelecimento_w		FLUXO_CAIXA_FILTRO.cd_estabelecimento%type;
cd_moeda_w					FLUXO_CAIXA_FILTRO.cd_moeda%type;
NR_SEQ_REGRA_COMPOSICAO_W   FLUXO_CAIXA_FILTRO.NR_SEQ_REGRA_COMPOSICAO%type;
ie_vencido_resultado_w 		FLUXO_CAIXA_FILTRO.ie_vencido_resultado%type;
IE_REGRA_MEDIA_ATRASO_W     FLUXO_CAIXA_FILTRO.IE_REGRA_MEDIA_ATRASO%type;
IE_STATUS_AGEND_W			FLUXO_CAIXA_FILTRO.IE_STATUS_AGEND%type;
cd_empresa_w				FLUXO_CAIXA_FILTRO.cd_empresa%type;
IE_TIT_PAGAR_W				FLUXO_CAIXA_FILTRO.IE_TIT_PAGAR%type;
IE_TIT_REC_W				FLUXO_CAIXA_FILTRO.IE_TIT_REC%type;
IE_CHEQUE_W					FLUXO_CAIXA_FILTRO.IE_CHEQUE%type;
IE_CARTAO_W					FLUXO_CAIXA_FILTRO.IE_CARTAO%type;
IE_CONV_RECEB_W				FLUXO_CAIXA_FILTRO.IE_CONV_RECEB%type;
IE_PROTOCOLO_W				FLUXO_CAIXA_FILTRO.IE_PROTOCOLO%type;
IE_ORDEM_COMPRA_W			FLUXO_CAIXA_FILTRO.IE_ORDEM_COMPRA%type;
IE_CONTRATO_W				FLUXO_CAIXA_FILTRO.IE_CONTRATO%type;
IE_FLUXO_ESPECIAL_W			FLUXO_CAIXA_FILTRO.IE_FLUXO_ESPECIAL%type;
IE_AGENDA_W					FLUXO_CAIXA_FILTRO.IE_AGENDA%type;
IE_BORDERO_PAGAR_W			FLUXO_CAIXA_FILTRO.IE_BORDERO_PAGAR%type;
IE_PAGTO_ESCRIT_W			FLUXO_CAIXA_FILTRO.IE_PAGTO_ESCRIT%type;
DS_LOG_W					FLUXO_CAIXA_FILTRO.DS_LOG%type;


BEGIN
begin

	select	a.ie_classificacao,
		a.ie_operacao,
		a.ie_periodo,
		a.ie_restringir_estab,
		a.ie_todas_contas,
		a.ie_dias_uteis,
		a.ie_somente_ativo_result,
		a.vl_saldo_anterior,
		a.nr_nivel,
		a.dt_inicial,
		a.dt_final,
		a.CD_CONTA_FINANC_AVANCADO,
		a.nm_usuario,
		a.cd_estabelecimento,
		a.cd_empresa,
		a.cd_moeda,
		a.NR_SEQ_REGRA_COMPOSICAO,
		a.ie_vencido_resultado,
		IE_REGRA_MEDIA_ATRASO,
		IE_STATUS_AGEND,
		IE_TIT_PAGAR,	
		IE_TIT_REC,		
		IE_CHEQUE,			
		IE_CARTAO,			
		IE_CONV_RECEB,		
		IE_PROTOCOLO,		
		IE_ORDEM_COMPRA,	
		IE_CONTRATO,	
		IE_FLUXO_ESPECIAL,	
		IE_AGENDA,
		IE_BORDERO_PAGAR,	
		IE_PAGTO_ESCRIT			
	into STRICT	ie_classificacao_w,
			ie_operacao_w,
			ie_periodo_w,
			ie_restringir_estab_w,
			ie_todas_contas_w,
			ie_dias_uteis_w,
			ie_somente_ativo_result_w,
			vl_saldo_anterior_w,
			nr_nivel_w,
			dt_inicial_w,
			dt_final_w,
			cd_conta_financ_w,
			nm_usuario_w,
			cd_estabelecimento_w,
			cd_empresa_w,
			cd_moeda_w,
			NR_SEQ_REGRA_COMPOSICAO_W,
			ie_vencido_resultado_w,
			IE_REGRA_MEDIA_ATRASO_W,
			IE_STATUS_AGEND_W,
			IE_TIT_PAGAR_W,		
			IE_TIT_REC_W,	
			IE_CHEQUE_W,			
			IE_CARTAO_W,			
			IE_CONV_RECEB_W,		
			IE_PROTOCOLO_W,		
			IE_ORDEM_COMPRA_W,	
			IE_CONTRATO_W,		
			IE_FLUXO_ESPECIAL_W,	
			IE_AGENDA_W,			
			IE_BORDERO_PAGAR_W,	
			IE_PAGTO_ESCRIT_W	
	from	FLUXO_CAIXA_FILTRO a
	where	a.nm_usuario =  nm_usuario_p;
	
	if (IE_STATUS_AGEND_W = 'P') then
	
				update	FLUXO_CAIXA_FILTRO
					set	ie_status_agend = 'A',
						dt_atualizacao = clock_timestamp()
				where	nm_usuario = nm_usuario_p;
				
				
	if (ie_classificacao_w = 'R') then
			
		if (ie_periodo_w = 'M') then
			dt_inicial_w := last_day(add_months(dt_inicial_w,-1))+1;
			dt_final_w := last_day(dt_final_w);
		end if;
		
			CALL gerar_fluxo_caixa_passado(	cd_estabelecimento_w,
					dt_inicial_w,
					dt_final_w,
					nm_usuario_w,
					cd_empresa_w,
					ie_restringir_estab_w,
					vl_saldo_anterior_w,
					ie_periodo_w,
					ie_dias_uteis_w,
					ie_todas_contas_w,
					ie_operacao_w,
					ie_somente_ativo_result_w,
					NR_SEQ_REGRA_COMPOSICAO_W,
					cd_moeda_w);
					
		if (ie_vencido_resultado_w = 'S') then
			CALL gerar_fluxo_caixa_vencido(cd_estabelecimento_w,
						to_date('01/01/1990','dd/mm/yyyy'),
						nm_usuario_w,
						cd_empresa_w,
						ie_restringir_estab_w,
						dt_final_w,
						ie_somente_ativo_result_w);
		end if;
	end if;	



	if (ie_classificacao_w = 'A') then
	
		if (ie_periodo_w = 'M') then
			dt_inicial_w := last_day(add_months(dt_inicial_w,-1))+1;
			dt_final_w := last_day(dt_final_w);
		end if;
		
			CALL gerar_fluxo_caixa_real(	cd_estabelecimento_w,
					vl_saldo_anterior_w,
					dt_inicial_w,
					dt_final_w,
					nm_usuario_w,
					cd_empresa_w,
					ie_restringir_estab_w,
					ie_periodo_w,
					ie_todas_contas_w,
					'',--ie_passado_real_p,
					IE_TIT_REC_W,
					IE_TIT_PAGAR_W,
					IE_CHEQUE_W,
					IE_CARTAO_W,
					IE_CONV_RECEB_W,
					IE_PROTOCOLO_W,
					IE_ORDEM_COMPRA_W,
					IE_CONTRATO_W,
					IE_FLUXO_ESPECIAL_W,
					IE_AGENDA_W,
					IE_REGRA_MEDIA_ATRASO_W,
					ie_operacao_w,
					IE_BORDERO_PAGAR_W,
					IE_PAGTO_ESCRIT_W,
					ie_somente_ativo_result_w,
					'R',
					NR_SEQ_REGRA_COMPOSICAO_W);
					
		if (ie_vencido_resultado_w = 'S') then
			CALL gerar_fluxo_caixa_vencido(cd_estabelecimento_w,
						to_date('01/01/1990','dd/mm/yyyy'),
						nm_usuario_w,
						cd_empresa_w,
						ie_restringir_estab_w,
						dt_final_w,
						ie_somente_ativo_result_w);
		end if;
	end if;			
				
				
	if (ie_classificacao_w = 'RR') then
	
		if (ie_periodo_w = 'M') then
			dt_inicial_w := last_day(add_months(dt_inicial_w,-1))+1;
			dt_final_w := last_day(dt_final_w);
		end if;
		
			CALL GERAR_FLUXO_CAIXA_PASSADO_REAL(	cd_estabelecimento_w,
					dt_inicial_w,
					dt_final_w,
					'',
					nm_usuario_w,
					cd_empresa_w,
					ie_restringir_estab_w,
					'R',
					ie_todas_contas_w,
					ie_periodo_w,
					vl_saldo_anterior_w,
					ie_operacao_w,
					IE_REGRA_MEDIA_ATRASO_W,
					ie_somente_ativo_result_w,
					NR_SEQ_REGRA_COMPOSICAO_W);
					
		if (ie_vencido_resultado_w = 'S') then
			CALL gerar_fluxo_caixa_vencido(cd_estabelecimento_w,
						to_date('01/01/1990','dd/mm/yyyy'),
						nm_usuario_w,
						cd_empresa_w,
						ie_restringir_estab_w,
						dt_final_w,
						ie_somente_ativo_result_w);
		end if;
	end if;



	if (ie_classificacao_w = 'O') then 	
			
			CALL gerar_fluxo_caixa_orcado(cd_estabelecimento_w,
					vl_saldo_anterior_w,
					dt_inicial_w,
					dt_final_w,
					ie_periodo_w,
					'O',
					nm_usuario_w,
					cd_empresa_w,
					ie_restringir_estab_w,
					'',	--ie_passado_real_p,
					ie_todas_contas_w,
					ie_somente_ativo_result_w);
					
	end if;	
	
	
	if (ie_classificacao_w = 'PO') then
			
		if (ie_periodo_w = 'M') then
			dt_inicial_w := last_day(add_months(dt_inicial_w,-1))+1;
			dt_final_w := last_day(dt_final_w);
		end if;
		
			CALL gerar_fluxo_caixa_passado(	cd_estabelecimento_w,
					dt_inicial_w,
					dt_final_w,
					nm_usuario_w,
					cd_empresa_w,
					ie_restringir_estab_w,
					vl_saldo_anterior_w,
					ie_periodo_w,
					'N',
					ie_todas_contas_w,
					ie_operacao_w,
					ie_somente_ativo_result_w,
					NR_SEQ_REGRA_COMPOSICAO_W,
					cd_moeda_w);
					
	end if;	
	
	
	
	if (ie_classificacao_w = 'P') then
			
		if (ie_periodo_w = 'M') then
			dt_inicial_w := last_day(add_months(dt_inicial_w,-1))+1;
			dt_final_w := last_day(dt_final_w);
		end if;
		
			CALL gerar_fluxo_caixa_real(	cd_estabelecimento_w,
					vl_saldo_anterior_w,
					dt_inicial_w,
					dt_final_w,
					nm_usuario_w,
					cd_empresa_w,
					ie_restringir_estab_w,
					ie_periodo_w,
					ie_todas_contas_w,
					'',--ie_passado_real_p,
					IE_TIT_REC_W,
					IE_TIT_PAGAR_W,
					IE_CHEQUE_W,
					IE_CARTAO_W,
					IE_CONV_RECEB_W,
					IE_PROTOCOLO_W,
					IE_ORDEM_COMPRA_W,
					IE_CONTRATO_W,
					IE_FLUXO_ESPECIAL_W,
					IE_AGENDA_W,
					IE_REGRA_MEDIA_ATRASO_W,
					ie_operacao_w,
					IE_BORDERO_PAGAR_W,
					IE_PAGTO_ESCRIT_W,
					ie_somente_ativo_result_w,
					'V',
					NR_SEQ_REGRA_COMPOSICAO_W);
					
		if (ie_vencido_resultado_w = 'S') then
			CALL gerar_fluxo_caixa_vencido(cd_estabelecimento_w,
						to_date('01/01/1990','dd/mm/yyyy'),
						nm_usuario_w,
						cd_empresa_w,
						ie_restringir_estab_w,
						dt_final_w,
						ie_somente_ativo_result_w);
		end if;			
					
	end if;
	
	
	
	if (ie_classificacao_w = 'V') then
			
			CALL gerar_fluxo_caixa_vencido(cd_estabelecimento_w,
						dt_inicial_w,
						nm_usuario_w,
						cd_empresa_w,
						ie_restringir_estab_w,
						dt_final_w,
						ie_somente_ativo_result_w);		
					
	end if;

				
				update	FLUXO_CAIXA_FILTRO
					set	ie_status_agend = 'R',
						dt_atualizacao = clock_timestamp()
				where	nm_usuario = nm_usuario_p;
					
	end if;	
		exception when others then
			DS_LOG_W := substr(DS_LOG_W || ' ' || sqlerrm, 0, 4000);
			begin
				update	FLUXO_CAIXA_FILTRO
					set	ie_status_agend = 'E',
						ds_log = DS_LOG_W,
						dt_atualizacao = clock_timestamp()
				where	nm_usuario = nm_usuario_p;
				commit;
			end;
		end;	
	
	commit;	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_fluxo_caixa_html (nm_usuario_p text) FROM PUBLIC;

