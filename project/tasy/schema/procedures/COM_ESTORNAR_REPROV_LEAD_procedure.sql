-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE com_estornar_reprov_lead ( nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_cnpj_w			varchar(14);
ds_razao_social_w		varchar(80);
nr_seq_canal_w			bigint;
ds_assunto_w			varchar(100);
ds_mensagem_w			varchar(2000);
dt_solicitacao_w		timestamp;
ds_email_w			varchar(255);
ds_motivo_reprov_w		varchar(2000);
cd_empresa_w			smallint;
ie_status_lead_w		varchar(03);
nm_pessoa_fisica_w		varchar(100);
ds_email_contato_w		varchar(255);


BEGIN 
 
select	nr_seq_canal, 
	dt_solicitacao, 
	cd_cnpj, 
	ds_razao_social, 
	ds_motivo_reprov, 
	ie_status_lead 
into STRICT	nr_seq_canal_w, 
	dt_solicitacao_w, 
	cd_cnpj_w, 
	ds_razao_social_w, 
	ds_motivo_reprov_w, 
	ie_status_lead_w 
from	com_solic_lead 
where	nr_sequencia = nr_sequencia_p;
 
if (coalesce(nr_seq_canal_w,0) <> 0) then 
	begin 
	select	ds_email_contato, 
			substr(obter_dados_pf_pj_estab(cd_estabelecimento_p, cd_pessoa_fisica, cd_cnpj,'M'),1,255) 
	into STRICT	ds_email_contato_w, 
			ds_email_w 
	from	com_canal 
	where	nr_sequencia = nr_seq_canal_w;
	end;
end if;
 
if (ds_email_contato_w IS NOT NULL AND ds_email_contato_w::text <> '') then 
	ds_email_w	:= ds_email_contato_w;
end if;
	 
if (coalesce(ds_email_w::text, '') = '') then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(184011);
end if;	
	 
nm_pessoa_fisica_w	:= substr(Obter_Pessoa_Fisica_Usuario(nm_usuario_p,'N'),1,100);
cd_empresa_w		:= obter_empresa_estab(cd_estabelecimento_p);
 
ds_assunto_w	:= substr('Solicitação Lead',1,70);	
ds_mensagem_w	:= substr('CNPJ: ' || cd_cnpj_w || chr(13) || chr(10) || 
			'Razão Social: ' || ds_razao_social_w || chr(13) || chr(10) || 
			'Dt. solicitação: ' || dt_solicitacao_w || chr(13) || chr(10) || 
			'Estornada a reprovação em ' || clock_timestamp() || ' por ' || nm_pessoa_fisica_w,1,2000);
CALL enviar_email(ds_assunto_w, ds_mensagem_w, 'comercial@wheb.com.br', 'comercial@wheb.com.br;' || ds_email_w, 'Tasy', 'M');	
 
update	com_solic_lead 
set	dt_aprov_reprov  = NULL, 
	nm_usuario	= nm_usuario_p, 
	ie_status_lead	= 'P', 
	dt_atualizacao	= clock_timestamp(), 
	ds_motivo_reprov  = NULL 
where	nr_sequencia	= nr_sequencia_p;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE com_estornar_reprov_lead ( nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

