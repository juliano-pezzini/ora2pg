-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cad_complem_bef_post_eup ( nm_usuario_p text, cd_cep_p text, nm_contato_p text, ie_obriga_email_p text, ds_email_p text, cd_pessoa_fisica_p text, nr_ddd_fone_p text, nr_ddd_fax_p text, ds_municipio_p text, sg_estado_p text, cd_municipio_ibge_p text, ds_bairro_p text, ds_endereco_p text, ie_nao_possui_email_p text default null, nm_pessoa_p INOUT text DEFAULT NULL, ds_texto_confirma_p INOUT text DEFAULT NULL, ds_texto_aborta_p INOUT text DEFAULT NULL, ds_texto_alerta_p INOUT text DEFAULT NULL) AS $body$
DECLARE


ie_continuar_execucao_w	varchar(1) := 'S';
ie_consiste_cep_w	varchar(1);
ie_nome_maisc_w		varchar(1);
cd_estabelecimento_w	bigint;
ie_valida_email_w	varchar(1);
ie_email_valido_w	varchar(1);
ie_consiste_plano_w		varchar(1);
ie_plano_w			varchar(1);
ie_consiste_ddd_w		varchar(1);
ie_somente_numero_fone_ddd_w	varchar(1) := 'S';
ie_somente_numero_fax_ddd_w	varchar(1) := 'S';
ie_valida_cep_end_w		varchar(3);
ds_municipio_w			varchar(60);
sg_estado_w			valor_dominio.vl_dominio%type;
cd_municipio_ibge_w		varchar(6);
nm_log_w			varchar(80);
nm_bairro_w			varchar(80);
ds_endereco_w			varchar(4000) := '';
ds_msg_endereco_w		varchar(4000) := '';
ie_consistir_cep_w		varchar(1);
ds_texto_aborta_w		varchar(4000);
ds_texto_confirma_w		varchar(4000);
ds_texto_alerta_w		varchar(4000);
cd_mun_ibge_w			varchar(6);
cd_tipo_logradouro_w		varchar(3);


BEGIN

cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;

ie_nome_maisc_w := Obter_param_Usuario(5, 10, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_nome_maisc_w);
ie_valida_cep_end_w := Obter_param_Usuario(5, 51, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_valida_cep_end_w);
ie_valida_email_w := Obter_param_Usuario(5, 68, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_valida_email_w);
ie_consistir_cep_w := Obter_param_Usuario(916, 96, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_consistir_cep_w);
ie_consiste_plano_w := Obter_param_Usuario(916, 936, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_consiste_plano_w);
ie_consiste_ddd_w := Obter_param_Usuario(916, 889, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_consiste_ddd_w);

if (cd_cep_p IS NOT NULL AND cd_cep_p::text <> '') then

	if (ie_consistir_cep_w = 'S') then
		ie_consiste_cep_w := consiste_cep(cd_cep_p);
		if (ie_consiste_cep_w = 'N') then

			ie_continuar_execucao_w := 'N';
			ds_texto_aborta_w := substr(obter_texto_tasy(69518, 1),1,4000);
		end if;
	end if;

	if (ie_continuar_execucao_w = 'S') and
		((ie_valida_cep_end_w = 'A') or (ie_valida_cep_end_w = 'AN')) and (length(cd_cep_p) > 7) then

		SELECT * FROM obter_dados_comp_eup_js(nm_usuario_p, cd_cep_p, ds_municipio_w, sg_estado_w, cd_municipio_ibge_w, nm_log_w, nm_bairro_w, ds_endereco_w, cd_mun_ibge_w, cd_tipo_logradouro_w) INTO STRICT ds_municipio_w, sg_estado_w, cd_municipio_ibge_w, nm_log_w, nm_bairro_w, ds_endereco_w, cd_mun_ibge_w, cd_tipo_logradouro_w;

		if (ds_municipio_w IS NOT NULL AND ds_municipio_w::text <> '') and (ds_municipio_w <> ds_municipio_p) then

			ds_msg_endereco_w := substr(obter_texto_dic_objeto(69626, wheb_usuario_pck.get_nr_seq_idioma, 'DS_MUNICIPIO='||ds_municipio_p||';NM_LOG='||ds_municipio_w),1,4000) ||chr(10);
		end if;

		if (sg_estado_w IS NOT NULL AND sg_estado_w::text <> '') and (sg_estado_w <> sg_estado_p) then

			ds_msg_endereco_w := substr(ds_msg_endereco_w || obter_texto_dic_objeto(69627, wheb_usuario_pck.get_nr_seq_idioma, 'SG_ESTADO='||sg_estado_p||';CD_UF='||sg_estado_w),1,4000) || chr(10);
		end if;

		if (cd_municipio_ibge_w IS NOT NULL AND cd_municipio_ibge_w::text <> '') and (cd_municipio_ibge_w <> cd_municipio_ibge_p) then

			ds_msg_endereco_w := substr(ds_msg_endereco_w || obter_texto_dic_objeto(69629, wheb_usuario_pck.get_nr_seq_idioma, 'CD_MUNICIPIO_IBGE='||cd_municipio_ibge_p||';CD_MUN_IBGE_P='||cd_municipio_ibge_w),1,4000) || chr(10);
		end if;

		if (nm_bairro_w IS NOT NULL AND nm_bairro_w::text <> '') and (nm_bairro_w <> ds_bairro_p) then
			ds_msg_endereco_w := substr(ds_msg_endereco_w || obter_texto_dic_objeto(69661, wheb_usuario_pck.get_nr_seq_idioma, 'DS_BAIRRO='||ds_bairro_p||';NM_BAIRRO='||nm_bairro_w),1,4000) || chr(10);
		end if;

		if (ds_endereco_w <> '') and (ds_endereco_w <> ds_endereco_p) then
			ds_msg_endereco_w := substr(ds_msg_endereco_w || obter_texto_dic_objeto(69662, wheb_usuario_pck.get_nr_seq_idioma, 'DS_ENDERECO='||ds_endereco_p||';DS_END='||ds_endereco_w),1,4000);
		end if;

		if (ie_valida_cep_end_w = 'A') and (ds_msg_endereco_w IS NOT NULL AND ds_msg_endereco_w::text <> '') then

			ds_texto_alerta_w := substr(ds_msg_endereco_w,1,4000);

		end if;

		if (ie_valida_cep_end_w = 'AN') and (ds_msg_endereco_w IS NOT NULL AND ds_msg_endereco_w::text <> '') then
			ie_continuar_execucao_w := 'S';
			ds_texto_aborta_w := substr(ds_msg_endereco_w,1,4000);

		end if;
	end if;
end if;

if (ie_nome_maisc_w = 'S') and (ie_continuar_execucao_w = 'S') and (nm_contato_p IS NOT NULL AND nm_contato_p::text <> '') then

	nm_pessoa_p := Obter_InitCap(nm_contato_p);
	ie_continuar_execucao_w	:= 'S';
end if;

if (ie_continuar_execucao_w = 'S') and (coalesce(ie_obriga_email_p,'N') = 'S') and (coalesce(ie_nao_possui_email_p,'N') = 'N') and (coalesce(ds_email_p::text, '') = '') then
	ds_texto_aborta_w :=  substr(obter_texto_tasy(69755, wheb_usuario_pck.get_nr_seq_idioma),1,4000);
	ie_continuar_execucao_w	:= 'N';
end if;

if (ie_continuar_execucao_w = 'S') and (ds_email_p IS NOT NULL AND ds_email_p::text <> '') and (ie_valida_email_w = 'S') then

	ie_email_valido_w := obter_se_email_valido(ds_email_p);
	if (ie_email_valido_w = 'N') then

		ds_texto_aborta_w := substr(obter_texto_tasy(261890, wheb_usuario_pck.get_nr_seq_idioma),1,4000);
		ie_continuar_execucao_w	:= 'N';
	end if;

end if;

if (ie_continuar_execucao_w = 'S') and (ie_consiste_ddd_w = 'S')  then

	if (nr_ddd_fone_p IS NOT NULL AND nr_ddd_fone_p::text <> '') then

		ie_somente_numero_fone_ddd_w := obter_se_somente_numero(nr_ddd_fone_p);

	end if;

	if (nr_ddd_fax_p IS NOT NULL AND nr_ddd_fax_p::text <> '') then
		ie_somente_numero_fax_ddd_w := obter_se_somente_numero(nr_ddd_fax_p);
	end if;
	if (ie_somente_numero_fone_ddd_w = 'N') or (ie_somente_numero_fax_ddd_w = 'N') then

		ds_texto_aborta_w := substr(obter_texto_tasy(177072, wheb_usuario_pck.get_nr_seq_idioma),1,4000);
		ie_continuar_execucao_w	:= 'N';
	end if;
end if;

-- Deixar esta consistencia para final,
if (ie_continuar_execucao_w = 'S') and (ie_consiste_plano_w <> 'N') and (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then

	ie_plano_w := coalesce(pls_obter_se_pessoa_plano(cd_pessoa_fisica_p),'N');

	if (ie_plano_w = 'S') then
		if (ie_consiste_plano_w = 'S') then
			ds_texto_confirma_w := substr(obter_texto_tasy(262718, wheb_usuario_pck.get_nr_seq_idioma),1,4000);

		elsif (ie_consiste_plano_w = 'A') or (ie_consiste_plano_w = 'C') then

			ie_continuar_execucao_w	:= 'N';
			ds_texto_aborta_w := substr(obter_texto_tasy(262722, wheb_usuario_pck.get_nr_seq_idioma),1,4000);
		end if;
	end if;
end if;

ds_texto_aborta_p := ds_texto_aborta_w;
ds_texto_confirma_p := ds_texto_confirma_w;
ds_texto_alerta_p   := ds_texto_alerta_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cad_complem_bef_post_eup ( nm_usuario_p text, cd_cep_p text, nm_contato_p text, ie_obriga_email_p text, ds_email_p text, cd_pessoa_fisica_p text, nr_ddd_fone_p text, nr_ddd_fax_p text, ds_municipio_p text, sg_estado_p text, cd_municipio_ibge_p text, ds_bairro_p text, ds_endereco_p text, ie_nao_possui_email_p text default null, nm_pessoa_p INOUT text DEFAULT NULL, ds_texto_confirma_p INOUT text DEFAULT NULL, ds_texto_aborta_p INOUT text DEFAULT NULL, ds_texto_alerta_p INOUT text DEFAULT NULL) FROM PUBLIC;

