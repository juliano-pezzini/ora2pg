-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_comunic_trans_financ (nr_seq_movto_p bigint, nm_usuario_p text, nr_titulo_receber_p bigint, nr_titulo_pagar_p bigint, nr_seq_baixa_p bigint) AS $body$
DECLARE


nm_usuario_comunic_w	varchar(15);
cd_perfil_w		integer;
ds_comunicacao_w	varchar(4000);
nm_atributo_w		varchar(30);
ds_lista_atributos_w	varchar(4000)	:= null;
ds_atributo_w		varchar(255);
ds_valor_atributo_w	varchar(255);
ds_comando_w		varchar(4000);
cd_estabelecimento_w	smallint;
nr_seq_trans_financ_w	bigint;
ds_sep_bv_w		varchar(10);
cd_temp_w		bigint;
ds_pessoa_w		varchar(80);
nr_seq_titulo_receber_w	bigint;
vl_recebido_w		double precision;
nr_seq_titulo_pagar_w	bigint;
vl_pago_w		double precision;
cd_motivo_dev_w		bigint;
ds_motivo_dev_w		varchar(255);
ds_beneficiario_w	varchar(80);
ds_conta_banco_w	varchar(255);
nr_cheque_w		varchar(15);
nm_pessoa_adiant_w	varchar(255);
ds_obs_adiant_w		adiantamento_pago.ds_observacao%type;
nr_seq_classif_w	trans_financ_comunic.nr_seq_classif%type;

/* Cursor dos campos da transação */

c01 CURSOR FOR
SELECT	nm_atributo
from	trans_financ_campo
where	nr_seq_trans_financ	= nr_seq_trans_financ_w

union

select	'VL_TRANSACAO'


union

select	'DT_TRANSACAO'
;

/* Cursor da regra */

c02 CURSOR FOR
SELECT	nm_usuario_comunic,
	cd_perfil,
	ds_comunicacao,
	nr_seq_classif
from	trans_financ_comunic
where	nr_seq_trans_financ	= nr_seq_trans_financ_w;


BEGIN

--Teste documentacao
if (nr_seq_movto_p IS NOT NULL AND nr_seq_movto_p::text <> '') then

	select	coalesce(max(a.nr_seq_trans_financ),0),
		max(obter_estab_movto_trans_financ(a.nr_seq_caixa,a.nr_seq_banco)),
		max(a.nr_seq_titulo_receber)
	into STRICT	nr_seq_trans_financ_w,
		cd_estabelecimento_w,
		nr_seq_titulo_receber_w
	from	movto_trans_financ a
	where	a.nr_sequencia	= nr_seq_movto_p;

	if (nr_seq_titulo_receber_w IS NOT NULL AND nr_seq_titulo_receber_w::text <> '') then
		select	substr(obter_nome_pf_pj(a.cd_pessoa_fisica,a.cd_cgc),1,80)
		into STRICT	ds_pessoa_w
		from	titulo_receber a
		where	nr_titulo	= nr_seq_titulo_receber_w;
	end if;

	if (ds_pessoa_w IS NOT NULL AND ds_pessoa_w::text <> '') then
    --729054 = Pessoa:
		ds_lista_atributos_w	:= obter_desc_expressao(729054) || ds_pessoa_w;
	end if;

	open c01;
	loop
	fetch c01 into
		nm_atributo_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		ds_comando_w := 'select ds_label from tabela_atributo where nm_tabela = ' || chr(39) || 'MOVTO_TRANS_FINANC' || chr(39) || ' and upper(nm_atributo) = upper(:nm_atributo)';

		ds_atributo_w	:= obter_select_concatenado_bv(ds_comando_w,'nm_atributo=' || nm_atributo_w,';');

		ds_comando_w	:= ' select	to_char(' || nm_atributo_w || ') ' ||
				   ' from	movto_trans_financ ' ||
				   ' where	nr_sequencia = :nr_sequencia';

		ds_valor_atributo_w	:= substr(obter_select_concatenado_bv(ds_comando_w,'nr_sequencia=' || nr_seq_movto_p,';'),1,255);

		if (nm_atributo_w = 'CD_TIPO_RECEBIMENTO') and (ds_valor_atributo_w IS NOT NULL AND ds_valor_atributo_w::text <> '') then
			cd_temp_w	:= (ds_valor_atributo_w)::numeric;

			select	ds_tipo_recebimento
			into STRICT	ds_valor_atributo_w
			from	tipo_recebimento
			where	cd_tipo_recebimento	= cd_temp_w;
		elsif (nm_atributo_w = 'VL_TRANSACAO') then
			ds_valor_atributo_w	:= 'R$' || campo_mascara_virgula(ds_valor_atributo_w);
		elsif (upper(nm_atributo_w) = 'NR_SEQ_CHEQUE_CP') and (ds_valor_atributo_w IS NOT NULL AND ds_valor_atributo_w::text <> '') then

			select	nr_cheque,
				substr(obter_dados_banco_estab(nr_seq_conta_banco),1,255),
				coalesce(substr(obter_nome_pf_pj(cd_pessoa_destinatario,cd_cgc_destinatario),1,80),ds_destinatario)
			into STRICT	nr_cheque_w,
				ds_conta_banco_w,
				ds_beneficiario_w
			from	cheque
			where	nr_sequencia = somente_numero(ds_valor_atributo_w);
			--729030 = Nº Cheque:
			ds_lista_atributos_w	:= ds_lista_atributos_w || chr(13) || chr(10) || obter_desc_expressao(729030) || nr_cheque_w;
      --343878 = Conta:
			ds_lista_atributos_w	:= ds_lista_atributos_w || chr(13) || chr(10) || obter_desc_expressao(343878) || ds_conta_banco_w;
      --729032 = Destinatário Cheque:
			ds_lista_atributos_w	:= ds_lista_atributos_w || chr(13) || chr(10) || obter_desc_expressao(729032) || ds_beneficiario_w;

		elsif (upper(nm_atributo_w) = 'NR_ADIANT_PAGO') and (ds_valor_atributo_w IS NOT NULL AND ds_valor_atributo_w::text <> '') then

			select	substr(obter_nome_pf_pj(max(a.cd_pessoa_fisica),max(a.cd_cgc)),1,255),
				substr(max(a.ds_observacao),1,255)
			into STRICT	nm_pessoa_adiant_w,
				ds_obs_adiant_w
			from	adiantamento_pago a
			where	a.nr_adiantamento	= somente_numero(ds_valor_atributo_w);
      --729034 = Pessoa adiantamento:
			ds_lista_atributos_w	:= ds_lista_atributos_w || chr(13) || chr(10) || obter_desc_expressao(729034) || nm_pessoa_adiant_w;
      --729036 = Observação adiantamento:
			ds_lista_atributos_w	:= ds_lista_atributos_w || chr(13) || chr(10) || obter_desc_expressao(729036) || ds_obs_adiant_w;

		end if;

		ds_lista_atributos_w	:= ds_lista_atributos_w || chr(13) || chr(10) || ds_atributo_w || ': ' || ds_valor_atributo_w;

		if (upper(nm_atributo_w)	= 'NR_SEQ_MOTIVO_DEV') then
			select	max(a.ds_motivo),
				max(a.cd_motivo)
			into STRICT	ds_motivo_dev_w,
				cd_motivo_dev_w
			from	motivo_dev_cheque a
			where	a.nr_sequencia	= (ds_valor_atributo_w)::numeric;
      --Código: 327262
			ds_lista_atributos_w	:= ds_lista_atributos_w || ' - '|| obter_desc_expressao(327262) || ' ' || cd_motivo_dev_w || ' - ' || ds_motivo_dev_w;
		end if;

	end loop;
	close c01;

elsif (nr_titulo_receber_p IS NOT NULL AND nr_titulo_receber_p::text <> '') and (nr_seq_baixa_p IS NOT NULL AND nr_seq_baixa_p::text <> '') then

	select	b.nr_titulo,
		b.cd_estabelecimento,
		vl_recebido + vl_descontos,
		substr(obter_nome_pf_pj(b.cd_pessoa_fisica,b.cd_cgc),1,80),
		a.nr_seq_trans_fin
	into STRICT	nr_seq_titulo_receber_w,
		cd_estabelecimento_w,
		vl_recebido_w,
		ds_pessoa_w,
		nr_seq_trans_financ_w
	from	titulo_receber b,
		titulo_receber_liq a
	where	a.nr_titulo	= b.nr_titulo
	and	a.nr_titulo	= nr_titulo_receber_p
	and	a.nr_sequencia	= nr_seq_baixa_p;

  --729046 = Título a receber:
	ds_lista_atributos_w	:= ds_lista_atributos_w || chr(13) || chr(10) || obter_desc_expressao(729046) || nr_seq_titulo_receber_w;
  --729054 = Pessoa:
	ds_lista_atributos_w	:= ds_lista_atributos_w || chr(13) || chr(10) || obter_desc_expressao(729054) || ds_pessoa_w;
  --729048 = Valor recebido:
	ds_lista_atributos_w	:= ds_lista_atributos_w || chr(13) || chr(10) || obter_desc_expressao(729048) || campo_mascara_virgula(vl_recebido_w);
elsif (nr_titulo_pagar_p IS NOT NULL AND nr_titulo_pagar_p::text <> '') and (nr_seq_baixa_p IS NOT NULL AND nr_seq_baixa_p::text <> '') then

	select	b.nr_titulo,
		b.cd_estabelecimento,
		vl_baixa,
		substr(obter_nome_pf_pj(b.cd_pessoa_fisica,b.cd_cgc),1,80),
		a.nr_seq_trans_fin
	into STRICT	nr_seq_titulo_receber_w,
		cd_estabelecimento_w,
		vl_pago_w,
		ds_pessoa_w,
		nr_seq_trans_financ_w
	from	titulo_pagar b,
		titulo_pagar_baixa a
	where	a.nr_titulo	= b.nr_titulo
	and	a.nr_titulo	= nr_titulo_pagar_p
	and	a.nr_sequencia	= nr_seq_baixa_p;
  --729050 = Título a pagar:
	ds_lista_atributos_w	:= ds_lista_atributos_w || chr(13) || chr(10) || obter_desc_expressao(729050) || nr_seq_titulo_receber_w;
  --729054 = Pessoa:
	ds_lista_atributos_w	:= ds_lista_atributos_w || chr(13) || chr(10) || obter_desc_expressao(729054) || ds_pessoa_w;
  --729052 = Valor pago:
	ds_lista_atributos_w	:= ds_lista_atributos_w || chr(13) || chr(10) || obter_desc_expressao(729052) || campo_mascara_virgula(vl_pago_w);
end if;

if (nr_seq_trans_financ_w IS NOT NULL AND nr_seq_trans_financ_w::text <> '') then

	open c02;
	loop
	fetch c02 into
		nm_usuario_comunic_w,
		cd_perfil_w,
		ds_comunicacao_w,
		nr_seq_classif_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */

		CALL gerar_comunic_padrao(clock_timestamp(),
        --729056 = Comunicado de lançamento de transação financeira
				obter_desc_expressao(729056),
				ds_comunicacao_w || chr(13) || chr(10) || ds_lista_atributos_w,
				nm_usuario_p,
				'N',
				nm_usuario_comunic_w,
				'N',
				nr_seq_classif_w,
				cd_perfil_w,
				cd_estabelecimento_w,
				null,
				clock_timestamp(),
				null,
				null);
	end loop;
	close c02;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_comunic_trans_financ (nr_seq_movto_p bigint, nm_usuario_p text, nr_titulo_receber_p bigint, nr_titulo_pagar_p bigint, nr_seq_baixa_p bigint) FROM PUBLIC;

