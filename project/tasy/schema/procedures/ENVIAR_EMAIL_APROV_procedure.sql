-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_email_aprov ( nr_solic_compra_p bigint, ds_assunto_padrao_p text, ds_mensagem_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
 
cd_centro_custo_w	integer;
cd_pessoa_resp_w	varchar(10);
nm_usuario_origem_w	varchar(255);
ds_email_origem_w	varchar(255);
ds_email_w		varchar(255);
ds_email_remetente_w	varchar(255);
ie_tipo_mensagem_w	integer;
ie_momento_envio_w	varchar(1);
ds_centro_custo_w	varchar(100);
vl_rateio_w		varchar(60);
ds_mensagem_padrao_w	varchar(4000);
ds_assunto_w		varchar(255);
nr_sequencia_w		bigint;
ds_fornecedor_w		varchar(255);
ds_lista_macro_w    varchar(4000);

C01 CURSOR FOR 
	SELECT	distinct coalesce(c.cd_pessoa_resp,0) 
	from	solic_compra a, 
		solic_compra_item_rateio b, 
		centro_custo_resp c 
	where	a.nr_solic_compra = b.nr_solic_compra 
	and	b.cd_centro_custo = c.cd_centro_custo 
	and	(b.vl_rateio IS NOT NULL AND b.vl_rateio::text <> '') 
	and	(b.cd_centro_custo IS NOT NULL AND b.cd_centro_custo::text <> '') 
	and	a.nr_solic_compra = nr_solic_compra_p 
	and 	ie_tipo_servico in ('SP','SR') 
	and	(a.dt_autorizacao IS NOT NULL AND a.dt_autorizacao::text <> '');

C02 CURSOR FOR 
	SELECT	distinct coalesce(b.cd_centro_custo,0) cd_centro_custo, 
		substr(obter_desc_centro_custo(b.cd_centro_custo),1,100) ds_centro_custo, 
		campo_mascara_virgula_casas(coalesce(b.vl_rateio,0),2) vl_rateio, 
		substr(obter_nome_pf_pj(null,a.cd_fornec_sugerido),1,100) ds_fornecedor 
	from	solic_compra a, 
		solic_compra_item_rateio b, 
		centro_custo_resp c 
	where	a.nr_solic_compra = b.nr_solic_compra 
	and	b.cd_centro_custo = c.cd_centro_custo 
	and	(b.vl_rateio IS NOT NULL AND b.vl_rateio::text <> '') 
	and	(b.cd_centro_custo IS NOT NULL AND b.cd_centro_custo::text <> '') 
	and	a.nr_solic_compra = nr_solic_compra_p 
	and	c.cd_pessoa_resp = cd_pessoa_resp_w 
	and 	ie_tipo_servico in ('SP','SR') 
	and	(a.dt_autorizacao IS NOT NULL AND a.dt_autorizacao::text <> '');


BEGIN 
 
select	coalesce(ie_momento_envio,'I'), 
	ie_tipo_mensagem, 
	ds_email_remetente, 
	nr_sequencia 
into STRICT	ie_momento_envio_w, 
	ie_tipo_mensagem_w, 
	ds_email_remetente_w, 
	nr_sequencia_w 
from	regra_envio_email_compra 
where	ie_tipo_mensagem in (75) 
and 	ie_situacao = 'A' 
and	cd_estabelecimento = cd_estabelecimento_p;
 
 
if (nr_sequencia_w > 0) then 
begin	 
	select	max(ds_email), 
		nm_usuario 
	into STRICT	ds_email_origem_w, 
		nm_usuario_origem_w 
	from	usuario 
	where	nm_usuario = nm_usuario_p 
	group by nm_usuario;
	 
	select	substr(replace_macro(ds_assunto,'@solicitacao',nr_solic_compra_p),1,255) 
	into STRICT	ds_assunto_w 
	from	regra_envio_email_compra 
	where	nr_sequencia = nr_sequencia_w;
	 
	if (coalesce(nr_solic_compra_p,0) <> 0) then 
	 
	open C01;
	loop 
	fetch C01 into 
		cd_pessoa_resp_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		select	max(ds_email) 
		into STRICT	ds_email_w 
		from	usuario 
		where	cd_pessoa_fisica = cd_pessoa_resp_w 
		and	(ds_email IS NOT NULL AND ds_email::text <> '');
	 
		cd_centro_custo_w := null;
		ds_centro_custo_w := null;
		vl_rateio_w := null;
		ds_mensagem_padrao_w:= null;
		ds_lista_macro_w := null;
		 
		 
		open C02;
		loop 
		fetch C02 into			 
			cd_centro_custo_w, 
			ds_centro_custo_w, 
			vl_rateio_w, 
			ds_fornecedor_w;			
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin								 
			ds_lista_macro_w := WHEB_MENSAGEM_PCK.get_texto(300298,'DS_LISTA_MACRO_W='|| DS_LISTA_MACRO_W ||';CD_CENTRO_CUSTO_W='|| CD_CENTRO_CUSTO_W ||';DS_CENTRO_CUSTO_W='|| DS_CENTRO_CUSTO_W ||';VL_RATEIO_W='|| VL_RATEIO_W ||';DS_FORNECEDOR_W='|| DS_FORNECEDOR_W);
					/*#@DS_LISTA_MACRO_W#@ Centro de custo: #@CD_CENTRO_CUSTO_W#@ - #@DS_CENTRO_CUSTO_W#@ 
					Rateio: #@VL_RATEIO_W#@ 
					Fornecedor: #@DS_FORNECEDOR_W#@*/
						 
			end;
		end loop;
		close C02;
 
			select	substr( 
				replace_macro( 
				ds_mensagem_padrao, 
				'@lista_aprovacao_rateio',ds_lista_macro_w),1,4000) 
			into STRICT	ds_mensagem_padrao_w 
			from	regra_envio_email_compra 
			where	nr_sequencia = nr_sequencia_w;			
 
		if (coalesce(ds_email_remetente_w::text, '') = '') then 
			ds_email_remetente_w := ds_email_origem_w;
		end if;
	 
		if (ie_momento_envio_w = 'A') and (ds_email_w IS NOT NULL AND ds_email_w::text <> '') then 
			begin 
			--insert into mhbarth values(ds_email_w || ds_mensagem_padrao_w); 
			CALL sup_grava_envio_email( 
				'AP', 
				ie_tipo_mensagem_w, 
				nr_solic_compra_p, 
				null, 
				null, 
				ds_email_w, 
				nm_usuario_p, 
				ds_email_remetente_w, 
				ds_assunto_w, 
				ds_mensagem_padrao_w, 
				cd_estabelecimento_p, 
				nm_usuario_p);
			end;
		elsif (ds_email_w IS NOT NULL AND ds_email_w::text <> '') then 
			begin 
			--insert into mhbarth values(ds_email_w || ds_mensagem_padrao_w); 
			CALL enviar_email(ds_assunto_w,ds_mensagem_padrao_w,ds_email_remetente_w,ds_email_w,nm_usuario_origem_w,'M');
			end;
		end if;
		end;
	end loop;
	close C01;	
		 
	end if;
end;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_email_aprov ( nr_solic_compra_p bigint, ds_assunto_padrao_p text, ds_mensagem_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

