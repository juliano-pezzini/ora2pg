-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_requisicao_autorizacao ( nr_seq_autorizacao_p bigint, cd_local_estoque_p bigint, nm_usuario_p text, cd_pessoa_fisica_p bigint, cd_operacao_estoque_p bigint, ds_erro_p INOUT text, nr_requisicao_p INOUT bigint) AS $body$
DECLARE

 
nr_atendimento_w		bigint;
cd_estabelecimento_w		smallint;
nr_requisicao_w			bigint;
nr_seq_item_w			bigint;
ie_consiste_mat_cc_w		varchar(1);
ie_somente_transf_farm_w	varchar(1);
ie_obriga_mat_padrao_w		varchar(1);
ie_consiste_mat_local_w		varchar(1);
ie_consiste_estoque_disp_w	varchar(1);
ie_consiste_dev_consumo_w	varchar(1);
ie_permite_estoque_max_w	varchar(1);
cd_local_destino_w		smallint;
cd_unidade_medida_consumo_w	varchar(30);
cd_cgc_fornec_w			varchar(14);

cd_material_w			integer;
qt_solicitada_w			double precision;
qt_estoque_w			double precision;

c01 CURSOR FOR 
	SELECT	cd_material, 
		qt_material, 
		cd_cgc_fornec 
	from	material_autor_cirurgia 
	where	nr_seq_autorizacao = nr_seq_autorizacao_p;
			

BEGIN 
 
select	cd_estabelecimento, 
	nr_atendimento 
into STRICT	cd_estabelecimento_w, 
	nr_atendimento_w 
from	autorizacao_cirurgia 
where	nr_sequencia = nr_seq_autorizacao_p;
 
select	cd_local_estoque 
into STRICT	cd_local_destino_w 
from	setor_atendimento 
where	cd_setor_atendimento = wheb_usuario_pck.get_cd_setor_atendimento;
 
ie_consiste_mat_cc_w := Obter_Param_Usuario(143, 4, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, cd_estabelecimento_w, ie_consiste_mat_cc_w);
ie_somente_transf_farm_w := Obter_Param_Usuario(143, 18, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, cd_estabelecimento_w, ie_somente_transf_farm_w);
ie_obriga_mat_padrao_w := Obter_Param_Usuario(143, 8, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, cd_estabelecimento_w, ie_obriga_mat_padrao_w);
ie_consiste_mat_local_w := Obter_Param_Usuario(143, 5, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, cd_estabelecimento_w, ie_consiste_mat_local_w);
ie_consiste_estoque_disp_w := Obter_Param_Usuario(143, 16, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, cd_estabelecimento_w, ie_consiste_estoque_disp_w);
ie_consiste_dev_consumo_w := Obter_Param_Usuario(143, 28, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, cd_estabelecimento_w, ie_consiste_dev_consumo_w);
ie_permite_estoque_max_w := Obter_Param_Usuario(143, 28, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, cd_estabelecimento_w, ie_permite_estoque_max_w);
 
if (ie_consiste_dev_consumo_w = 'S') then 
	ie_consiste_dev_consumo_w := 'N';
elsif (ie_consiste_dev_consumo_w = 'N') then 
	ie_consiste_dev_consumo_w := 'S';
end if;
 
select	nextval('requisicao_seq') 
into STRICT	nr_requisicao_w
;
 
insert into requisicao_material( 
	nr_requisicao, 
	cd_estabelecimento, 
	cd_local_estoque, 
	dt_solicitacao_requisicao, 
	dt_atualizacao, 
	nm_usuario, 
	cd_operacao_estoque, 
	cd_pessoa_requisitante, 
	cd_setor_atendimento, 
	cd_local_estoque_destino, 
	ds_observacao, 
	nm_usuario_lib, 
	nr_atendimento, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	ie_urgente) 
values (	nr_requisicao_w, 
	cd_estabelecimento_w, 
	cd_local_estoque_p, 
	clock_timestamp(), 
	clock_timestamp(), 
	nm_usuario_p, 
	cd_operacao_estoque_p, 
	cd_pessoa_fisica_p, 
	wheb_usuario_pck.get_cd_setor_atendimento, 
	cd_local_destino_w,	 
	WHEB_MENSAGEM_PCK.get_texto(277138) || nr_seq_autorizacao_p, 
	nm_usuario_p, 
	nr_atendimento_w, 
	clock_timestamp(), 
	nm_usuario_p, 
	'N');
	 
open C01;
loop 
fetch C01 into	 
	cd_material_w, 
	qt_solicitada_w, 
	cd_cgc_fornec_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	select	coalesce(max(nr_sequencia),0) +1 
	into STRICT	nr_seq_item_w 
	from	item_requisicao_material 
	where	nr_requisicao = nr_requisicao_w;
	 
	select	cd_unidade_medida_consumo 
	into STRICT	cd_unidade_medida_consumo_w 
	from	material 
	where	cd_material = cd_material_w;
	 
	qt_estoque_w := dividir(qt_solicitada_w,obter_conversao_material(cd_material_w,'EC'));
	 
	insert into item_requisicao_material( 
		nr_requisicao, 
		nr_sequencia, 
		cd_estabelecimento, 
		cd_material, 
		qt_material_requisitada, 
		vl_material, 
		dt_atualizacao, 
		nm_usuario, 
		cd_unidade_medida, 
		qt_estoque, 
		cd_material_req, 
		cd_cgc_fornecedor, 
		ie_geracao) 
	values (	nr_requisicao_w, 
		nr_seq_item_w, 
		cd_estabelecimento_w, 
		cd_material_w, 
		qt_solicitada_w, 
		0, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_unidade_medida_consumo_w, 
		qt_estoque_w, 
		cd_material_w, 
		cd_cgc_fornec_w, 
		'S');
	end;
end loop;
close C01;
	 
commit;
 
ds_erro_p := consistir_requisicao(	nr_requisicao_w, nm_usuario_p, cd_local_destino_w, null, ie_consiste_mat_cc_w, ie_somente_transf_farm_w, ie_obriga_mat_padrao_w, ie_consiste_mat_local_w, ie_consiste_estoque_disp_w, ie_consiste_dev_consumo_w, ie_permite_estoque_max_w, cd_operacao_estoque_p, ds_erro_p);
			 
nr_requisicao_p := nr_requisicao_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_requisicao_autorizacao ( nr_seq_autorizacao_p bigint, cd_local_estoque_p bigint, nm_usuario_p text, cd_pessoa_fisica_p bigint, cd_operacao_estoque_p bigint, ds_erro_p INOUT text, nr_requisicao_p INOUT bigint) FROM PUBLIC;

