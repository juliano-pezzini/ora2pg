-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_evento_paciente_gv (nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_evento_w			bigint;
qt_idade_w				smallint;
nr_classif_pf_w			bigint;
cd_medico_w				varchar(10);
cd_setor_desejado_w		integer;
cd_cid_principal_w 	varchar(10);
cd_pessoa_fisica_w		varchar(10);
cd_convenio_w			integer;
cd_estabelecimento_w	integer;

C01 CURSOR FOR 
	SELECT	a.nr_seq_evento 
	FROM regra_envio_sms a
LEFT OUTER JOIN regra_envio_sms_atend b ON (a.nr_sequencia = b.nr_seq_regra)
WHERE a.cd_estabelecimento												= cd_estabelecimento_w AND a.ie_evento_disp													= 'ACNRGV' and coalesce(cd_pessoa_fisica,coalesce(cd_pessoa_fisica_w,0))						= coalesce(cd_pessoa_fisica_w,0) and coalesce(cd_setor_destino,coalesce(cd_setor_desejado_w,0))					= coalesce(cd_setor_desejado_w,0) and coalesce(cd_medico,coalesce(cd_medico_w,0))									= coalesce(cd_medico_w,0) and coalesce(cd_doenca,coalesce(cd_cid_principal_w,0))							= coalesce(cd_cid_principal_w,0) and coalesce(nr_seq_classif,coalesce(nr_classif_pf_w,0))							= coalesce(nr_classif_pf_w,0) and qt_idade_w between coalesce(qt_idade_min,0) and coalesce(qt_idade_max,9999) and obter_se_convenio_rec_alerta(cd_convenio_w, a.nr_sequencia)		= 'S' and coalesce(a.ie_situacao,'A') = 'A';


BEGIN 
 
select	max(cd_pessoa_fisica), 
		max(cd_setor_desejado), 
		max(cd_medico), 
		max(cd_cid_principal), 
		max(cd_convenio), 
		max(cd_estabelecimento) 
into STRICT	cd_pessoa_fisica_w, 
		cd_setor_desejado_w, 
		cd_medico_w, 
		cd_cid_principal_w, 
		cd_convenio_w, 
		cd_estabelecimento_w 
from	gestao_vaga 
where	nr_sequencia = nr_sequencia_p;
 
qt_idade_w			:= coalesce(obter_idade_pf(cd_pessoa_fisica_w, clock_timestamp(), 'A'),0);
nr_classif_pf_w		:= coalesce(obter_classif_pf(cd_pessoa_fisica_w, cd_estabelecimento_w),0);
 
if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and (nr_classif_pf_w <> 0)	then	 
	open C01;
	loop 
	fetch C01 into	 
		nr_seq_evento_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
			CALL gerar_evento_paciente(nr_seq_evento_w,null, cd_pessoa_fisica_w ,null, nm_usuario_p,null,null,null,null, cd_medico_w, null, nr_sequencia_p);	
		end;
	end loop;
	close C01;
end if;
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_evento_paciente_gv (nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

