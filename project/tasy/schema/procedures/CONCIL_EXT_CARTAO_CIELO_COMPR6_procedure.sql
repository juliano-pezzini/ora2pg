-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE concil_ext_cartao_cielo_compr6 (nr_seq_extrato_arq_p extrato_cartao_cr_res.nr_seq_extrato_arq%type, ds_lista_extrato_movto_fin_p text, ds_lista_extrato_movto_cred_p text, ie_opcao_p text, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


/*	ie_opcao_p

C	Conciliar
D	Desconciliar

Objeto similar CONCILIAR_EXT_CARTAO_CIELO, porem sem verificar nr_cartao, e com tratativas diferentes para verificar nr_autorizacao e comprovante
para clientes que utilizam a Solucao Certa
*/
nr_seq_parcela_w	movto_cartao_cr_parcela.nr_sequencia%type;
qt_nao_concil_w		movto_cartao_cr_parcela.nr_sequencia%type;
vl_parcela_w		movto_cartao_cr_parcela.vl_parcela%type;

ds_comprovante_w	extrato_cartao_cr_movto.ds_comprovante%type;
nr_autorizacao_w	extrato_cartao_cr_movto.nr_autorizacao%type;
nr_cartao_w		extrato_cartao_cr_movto.nr_cartao%type;
nr_parcela_w		extrato_cartao_cr_movto.nr_parcela%type;
nr_resumo_w		extrato_cartao_cr_res.nr_resumo%type;
nr_seq_bandeira_w	extrato_cartao_cr_res.nr_seq_bandeira%type;
nr_seq_movto_w		extrato_cartao_cr_movto.nr_sequencia%type;
nr_seq_parcela_concil_w	extrato_cartao_cr_movto.nr_seq_parcela%type;
nr_documento_w		extrato_cartao_cr_movto.nr_documento%type;
cd_bandeira_w		bandeira_cartao_cr.cd_bandeira%type;
vl_saldo_concil_fin_w	extrato_cartao_cr_movto.vl_saldo_concil_fin%type;
nr_seq_grupo_w		extrato_cartao_cr.nr_seq_grupo%type;
vl_min_indevido_w	bandeira_cartao_cr_regra.vl_min_indevido%type;
vl_max_indevido_w	bandeira_cartao_cr_regra.vl_max_indevido%type;
cd_estabelecimento_w	extrato_cartao_cr.cd_estabelecimento%type;

vl_tot_extrato_movto_w	extrato_cartao_cr_movto.vl_liquido%type;
vl_tot_parcela_w	movto_cartao_cr_parcela.vl_liquido%type;
nr_seq_extrato_w	extrato_cartao_cr.nr_sequencia%type;
nr_seq_extrato_parcela_w	extrato_cartao_cr_parcela.nr_sequencia%type;
nr_seq_extrato_parc_w	extrato_cartao_cr_movto.nr_seq_extrato_parcela%type;
subtype varchar1 	is varchar(1);
ie_parcela_superior_w	varchar1;
vl_ajuste_w		extrato_cartao_cr_movto.vl_liquido%type;
vl_liquido_w		extrato_cartao_cr_movto.vl_liquido%type;
vl_volta_saldo_w	extrato_cartao_cr_movto.vl_liquido%type;

c01 CURSOR FOR
SELECT	b.ds_comprovante,
	b.nr_autorizacao,
	somente_numero(b.nr_cartao),
	b.nr_parcela,
	a.nr_resumo,
	a.nr_seq_bandeira,
	b.nr_seq_parcela,
	b.nr_sequencia,
	b.nr_documento,
	c.cd_bandeira,
	b.vl_saldo_concil_fin,
	b.nr_seq_extrato_parcela,
	b.vl_liquido
FROM extrato_cartao_cr_movto b, extrato_cartao_cr_res a
LEFT OUTER JOIN bandeira_cartao_cr c ON (a.nr_seq_bandeira = c.nr_sequencia)
WHERE (coalesce(ds_lista_extrato_movto_fin_p::text, '') = '' or ' ' || ds_lista_extrato_movto_fin_p || ' ' like '% ' || b.nr_sequencia || ' %') and coalesce(b.ie_pagto_indevido,'N')	= 'N' and a.nr_sequencia		= b.nr_seq_extrato_res and a.nr_seq_extrato_arq	= nr_seq_extrato_arq_p;

c02 CURSOR FOR
SELECT	b.nr_sequencia,
	b.vl_parcela
from	bandeira_cartao_cr c,
	movto_cartao_cr_parcela b,
	movto_cartao_cr a
where	coalesce(b.vl_saldo_liquido,0)	<> 0
and	coalesce(c.cd_bandeira,'0')		= coalesce(cd_bandeira_w,c.cd_bandeira,'0')
and	a.nr_seq_bandeira	= c.nr_sequencia
and (coalesce(ds_lista_extrato_movto_cred_p::text, '') = '' or ' ' || ds_lista_extrato_movto_cred_p || ' ' like '% ' || b.nr_sequencia || ' %')
and	not exists (select	1
	from	extrato_cartao_cr_movto x
	where	x.nr_seq_parcela	= b.nr_sequencia)
and (coalesce(nr_parcela_w,0) = 0 or obter_numero_parcela_cartao(a.nr_sequencia,b.nr_sequencia) = nr_parcela_w)
and (coalesce(b.nr_resumo::text, '') = '' or b.nr_resumo = coalesce(nr_resumo_w,b.nr_resumo))
and	a.nr_sequencia		= b.nr_seq_movto
and	coalesce(a.dt_cancelamento::text, '') = ''
and	lpad(substr(a.nr_autorizacao,1,6),6,'0')	= lpad(substr(coalesce(nr_autorizacao_w,a.nr_autorizacao),1,6),6,'0')
and	((coalesce(ds_comprovante_w::text, '') = '' and coalesce(nr_documento_w::text, '') = '') or (substr(coalesce(lpad(a.ds_comprovante,100,'0'),'X'),95,6) = substr(lpad(ds_comprovante_w,100,'0'),95,6)) or (substr(coalesce(lpad(a.ds_comprovante,100,'0'),'X'),95,6) = substr(lpad(nr_documento_w,100,'0'),95,6)));
	


BEGIN

select	max(a.nr_seq_grupo),
	max(a.cd_estabelecimento),
	max(a.nr_sequencia)
into STRICT	nr_seq_grupo_w,
	cd_estabelecimento_w,
	nr_seq_extrato_w
from	extrato_cartao_cr a,
	extrato_cartao_cr_arq b
where	b.nr_seq_extrato	= a.nr_sequencia
and	b.nr_sequencia		= nr_seq_extrato_arq_p;



select	max(a.vl_min_indevido),
	max(a.vl_max_indevido)
into STRICT	vl_min_indevido_w,
	vl_max_indevido_w
from	bandeira_cartao_cr_regra a
where	a.nr_seq_grupo		= nr_seq_grupo_w
and	clock_timestamp()			between coalesce(a.dt_inicio_vigencia,clock_timestamp()) and coalesce(a.dt_fim_vigencia,clock_timestamp())
and	coalesce(a.cd_estabelecimento,cd_estabelecimento_w,0)	= coalesce(cd_estabelecimento_w,0);

ie_parcela_superior_w := obter_param_usuario(3020, 40, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_parcela_superior_w);

if (coalesce(ds_lista_extrato_movto_cred_p::text, '') = '') then

	open	c01;
	loop
	fetch	c01 into
		ds_comprovante_w,
		nr_autorizacao_w,
		nr_cartao_w,
		nr_parcela_w,
		nr_resumo_w,
		nr_seq_bandeira_w,
		nr_seq_parcela_concil_w,
		nr_seq_movto_w,
		nr_documento_w,
		cd_bandeira_w,
		vl_saldo_concil_fin_w,
		nr_seq_extrato_parc_w,
		vl_liquido_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		if (ie_opcao_p = 'C') and (coalesce(nr_seq_parcela_concil_w::text, '') = '') then
			
			select	nextval('extrato_cartao_cr_parcela_seq')
			into STRICT	nr_seq_extrato_parcela_w
			;

			insert	into	extrato_cartao_cr_parcela(nr_sequencia,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				dt_atualizacao,
				nm_usuario,
				nr_seq_extrato_arq,
				nr_seq_extrato)
			values (nr_seq_extrato_parcela_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_extrato_arq_p,
				nr_seq_extrato_w);
			
			open	c02;
			loop
			fetch	c02 into
				nr_seq_parcela_w,
				vl_parcela_w;
			exit when(c02%notfound or coalesce(vl_saldo_concil_fin_w,0) <= 0);
				if (nr_seq_parcela_w IS NOT NULL AND nr_seq_parcela_w::text <> '') then

					select	max(a.vl_saldo_liquido)
					into STRICT	vl_parcela_w
					from	movto_cartao_cr_parcela a
					where	a.nr_sequencia	= nr_seq_parcela_w;
					
					vl_ajuste_w	:= 0;

					if	((coalesce(vl_saldo_concil_fin_w,0) - coalesce(vl_parcela_w,0))	>= coalesce(vl_min_indevido_w,0)) and
						((coalesce(vl_saldo_concil_fin_w,0) - coalesce(vl_parcela_w,0))	<= coalesce(vl_max_indevido_w,0)) then

						vl_ajuste_w	:= coalesce(vl_saldo_concil_fin_w,0) - coalesce(vl_parcela_w,0);
						vl_parcela_w	:= vl_saldo_concil_fin_w;

					end if;

					if (vl_parcela_w	> 0) and
						((vl_parcela_w	<= vl_saldo_concil_fin_w) or (coalesce(ie_parcela_superior_w,'N') = 'S')) then
					
						update	extrato_cartao_cr_movto
						set	nr_seq_extrato_parcela	= nr_seq_extrato_parcela_w,
							vl_saldo_concil_fin 	= coalesce(vl_saldo_concil_fin,0) - coalesce(vl_parcela_w,0),
							dt_atualizacao		= clock_timestamp(),
							nm_usuario		= nm_usuario_p,
							vl_ajuste		= vl_ajuste_w,
							ie_pagto_indevido	= 'N'
						where	nr_sequencia		= nr_seq_movto_w;
					
						update	movto_cartao_cr_parcela
						set	nr_seq_extrato_parcela	= nr_seq_extrato_parcela_w
						where	nr_sequencia		= nr_seq_parcela_w;
						
						vl_saldo_concil_fin_w	:= coalesce(vl_saldo_concil_fin_w,0) - coalesce(vl_parcela_w,0);
						
					end if;

				end if;
			end loop;
			close	c02;			

		elsif (ie_opcao_p = 'D') and
			((nr_seq_parcela_concil_w IS NOT NULL AND nr_seq_parcela_concil_w::text <> '') or (nr_seq_extrato_parc_w IS NOT NULL AND nr_seq_extrato_parc_w::text <> '')) then

			select	max(a.vl_saldo_liquido)
			into STRICT	vl_parcela_w
			from	movto_cartao_cr_parcela a
			where	a.nr_sequencia	= nr_seq_parcela_concil_w;

			if (coalesce(vl_parcela_w,0) < coalesce(vl_liquido_w,0)) then
				vl_volta_saldo_w	:= vl_parcela_w;
			else
				vl_volta_saldo_w	:= vl_liquido_w;
			end if;

			update	extrato_cartao_cr_movto
			set	nr_seq_parcela		 = NULL,
				vl_saldo_concil_fin	= coalesce(vl_saldo_concil_fin,0) + coalesce(vl_volta_saldo_w,0),
				dt_atualizacao		= clock_timestamp(),
				nm_usuario		= nm_usuario_p,
				vl_ajuste		= 0
			where	nr_sequencia		= nr_seq_movto_w;
			
			select	coalesce(sum(a.vl_saldo_liquido),0)
			into STRICT	vl_parcela_w
			from	movto_cartao_cr_parcela a
			where	a.nr_seq_extrato_parcela	= nr_seq_extrato_parc_w;
			
			if (coalesce(vl_parcela_w,0) < coalesce(vl_liquido_w,0)) then
				vl_volta_saldo_w	:= vl_parcela_w;
			else
				vl_volta_saldo_w	:= vl_liquido_w;
			end if;
			
			update	extrato_cartao_cr_movto
			set	vl_saldo_concil_fin	= coalesce(vl_saldo_concil_fin,0) + coalesce(vl_volta_saldo_w,0),
				dt_atualizacao		= clock_timestamp(),
				nm_usuario		= nm_usuario_p,
				nr_seq_extrato_parcela	 = NULL,
				vl_ajuste		= 0
			where	nr_seq_extrato_parcela	= nr_seq_extrato_parc_w;
			
			update	movto_cartao_cr_parcela
			set	dt_atualizacao		= clock_timestamp(),
				nm_usuario		= nm_usuario_p,
				nr_seq_extrato_parcela	 = NULL
			where	nr_seq_extrato_parcela	= nr_seq_extrato_parc_w;
			
			delete	from extrato_cartao_cr_parcela
			where	nr_sequencia	= nr_seq_extrato_parc_w;

		end if;

	end	loop;
	close	c01;

elsif (ds_lista_extrato_movto_fin_p IS NOT NULL AND ds_lista_extrato_movto_fin_p::text <> '') then

	if (ie_opcao_p	= 'C') then

		select	coalesce(sum(coalesce(a.vl_liquido,a.vl_parcela)),0)
		into STRICT	vl_tot_extrato_movto_w
		from	extrato_cartao_cr_movto a
		where	' ' || ds_lista_extrato_movto_fin_p || ' ' like '% ' || a.nr_sequencia || ' %';

		select	coalesce(sum(a.vl_liquido),0)
		into STRICT	vl_tot_parcela_w
		from	movto_cartao_cr b,
			movto_cartao_cr_parcela a
		where	coalesce(b.dt_cancelamento::text, '') = ''
		and	' ' || ds_lista_extrato_movto_cred_p || ' ' like '% ' || a.nr_sequencia || ' %'
		and	a.nr_seq_movto		= b.nr_sequencia
		and	b.ie_tipo_cartao	= 'C';

		if (vl_tot_extrato_movto_w	= vl_tot_parcela_w) then

			select	nextval('extrato_cartao_cr_parcela_seq')
			into STRICT	nr_seq_extrato_parcela_w
			;

			insert	into extrato_cartao_cr_parcela(nr_sequencia,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				dt_atualizacao,
				nm_usuario,
				nr_seq_extrato_arq,
				nr_seq_extrato)
			values (nr_seq_extrato_parcela_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_extrato_arq_p,
				nr_seq_extrato_w);

			update	extrato_cartao_cr_movto
			set	nr_seq_extrato_parcela	= nr_seq_extrato_parcela_w,
				vl_saldo_concil_fin	= coalesce(vl_saldo_concil_fin,0) - coalesce(vl_tot_parcela_w,0)
			where	' ' || ds_lista_extrato_movto_fin_p || ' ' like '% ' || nr_sequencia || ' %';

			update	movto_cartao_cr_parcela a
			set	a.nr_seq_extrato_parcela	= nr_seq_extrato_parcela_w
			where	' ' || ds_lista_extrato_movto_cred_p || ' ' like '% ' || a.nr_sequencia || ' %'
			and	exists (SELECT	1
				from	movto_cartao_cr x
				where	coalesce(x.dt_cancelamento::text, '') = ''
				and	x.nr_sequencia		= a.nr_seq_movto
				and	x.ie_tipo_cartao	= 'C');

		end if;

	elsif (ie_opcao_p	= 'D') then

		select	coalesce(sum(a.vl_liquido),0)
		into STRICT	vl_tot_parcela_w
		from	movto_cartao_cr b,
			movto_cartao_cr_parcela a
		where	b.ie_tipo_cartao	= 'C'
		and	a.nr_seq_movto		= b.nr_Sequencia
		and	a.nr_seq_extrato_parcela in (SELECT	distinct
				x.nr_seq_extrato_parcela
			from	extrato_cartao_cr_movto x
			where	' ' || ds_lista_extrato_movto_fin_p || ' ' like '% ' || x.nr_sequencia || ' %');

		update	movto_cartao_cr_parcela a
		set	a.nr_seq_extrato_parcela	 = NULL
		where	(a.nr_seq_extrato_parcela IS NOT NULL AND a.nr_seq_extrato_parcela::text <> '')
		and	a.nr_seq_extrato_parcela in (SELECT	distinct
				x.nr_seq_extrato_parcela
			from	extrato_cartao_cr_movto x
			where	' ' || ds_lista_extrato_movto_fin_p || ' ' like '% ' || x.nr_sequencia || ' %')
		and	exists (select	1
			from	movto_cartao_cr x
			where	x.nr_sequencia		= a.nr_seq_movto
			and	x.ie_tipo_cartao	= 'C');

		update	extrato_cartao_cr_movto e
		set	e.nr_seq_extrato_parcela	 = NULL,
			e.vl_saldo_concil_fin	= coalesce(vl_saldo_concil_fin,0) + coalesce(vl_tot_parcela_w,0)
		where	(e.nr_seq_extrato_parcela IS NOT NULL AND e.nr_seq_extrato_parcela::text <> '')
		and	e.nr_seq_extrato_parcela	in (SELECT	distinct
				x.nr_seq_extrato_parcela
			from	extrato_cartao_cr_movto x
			where	' ' || ds_lista_extrato_movto_fin_p || ' ' like '% ' || x.nr_sequencia || ' %');

		delete	from extrato_cartao_cr_parcela a
		where	a.nr_sequencia in (SELECT	distinct
				x.nr_seq_extrato_parcela
			from	extrato_cartao_cr_movto x
			where	' ' || ds_lista_extrato_movto_fin_p || ' ' like '% ' || x.nr_sequencia || ' %');

	end if;

end if;

select	count(*)
into STRICT	qt_nao_concil_w
from	extrato_cartao_cr_movto b,
	extrato_cartao_cr_res a
where	coalesce(b.vl_saldo_concil_fin,0) <> 0
and	a.nr_sequencia		= b.nr_seq_extrato_res
and	a.nr_seq_extrato_arq	= nr_seq_extrato_arq_p;

update	extrato_cartao_cr_arq
set	dt_conciliacao		= CASE WHEN qt_nao_concil_w=0 THEN clock_timestamp()  ELSE null END ,
	dt_atualizacao		= clock_timestamp(),
	nm_usuario		= nm_usuario_p
where	nr_sequencia		= nr_seq_extrato_arq_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE concil_ext_cartao_cielo_compr6 (nr_seq_extrato_arq_p extrato_cartao_cr_res.nr_seq_extrato_arq%type, ds_lista_extrato_movto_fin_p text, ds_lista_extrato_movto_cred_p text, ie_opcao_p text, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

