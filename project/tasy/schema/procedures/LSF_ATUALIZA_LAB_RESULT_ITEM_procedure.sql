-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lsf_atualiza_lab_result_item (nr_prescricao_p text, nr_seq_exame_p text, cd_analito_p text, ds_resultado_p text, ds_unidade_medida_p text, ds_linha_resultado_p bigint, ie_normalidade_p text, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE

 
nr_seq_prescricao_w 	bigint;				
ds_resultado_w		varchar(4000);
qt_resultado_w		double precision;
qt_resultado_ww		varchar(4000);
ds_referencia_w 		varchar(4000);
ds_resultado_ww		varchar(4000);
cd_analito_w		varchar(20);
				

BEGIN 
 
-- Busca a sequência da prescrição 
select 	MAX(nr_sequencia) 
into STRICT 	nr_seq_prescricao_w 
from 	prescr_procedimento 
where 	nr_prescricao = nr_prescricao_p 
and  	nr_seq_exame = nr_seq_exame_p;
 
if (coalesce(nr_seq_prescricao_w::text, '') = '') then 
	ds_erro_p := wheb_mensagem_pck.get_texto(279845,'NR_SEQ_EXAME='|| nr_seq_exame_p||';NR_PRESCRICAO='|| nr_prescricao_p);
end if;
 
-- Busca pelo código do analito 
select	max(coalesce(e.cd_exame_integracao, e.cd_exame)) 
into STRICT	cd_analito_w 
from	exame_laboratorio e 
where	e.nr_seq_exame = (SELECT nr_seq_exame 
			 from equipamento_lab b, 
				lab_exame_equip a 
			 WHERE	a.cd_equipamento = b.cd_equipamento 
			 AND	a.cd_exame_equip = cd_analito_p 
			 AND	upper(b.ds_sigla) = 'LSFRANCO' 
			 AND	a.nr_seq_exame = nr_seq_exame_p);WITH RECURSIVE cte AS (

 
 
if (coalesce(cd_analito_w::text, '') = '') then 
 
	select	max(coalesce(e.cd_exame_integracao, e.cd_exame)) 
	into STRICT	cd_analito_w 
	from	exame_laboratorio e WHERE nr_seq_superior = nr_seq_exame_p
  UNION ALL
 
 
 
if (coalesce(cd_analito_w::text, '') = '') then 
 
	select	max(coalesce(e.cd_exame_integracao, e.cd_exame)) 
	into STRICT	cd_analito_w 
	from	exame_laboratorio e JOIN cte c ON (c.prior nr_seq_exame = e.nr_seq_superior)

) SELECT * FROM cte WHERE nr_seq_exame = (SELECT nr_seq_exame 
				from equipamento_lab b, 
				   lab_exame_equip a 
				WHERE	a.cd_equipamento = b.cd_equipamento 
				AND	a.cd_exame_equip = cd_analito_p 
				AND	upper(b.ds_sigla) = 'LSFRANCO' 
				AND	a.nr_seq_exame = e.nr_seq_exame);
;
 
 
end if;
 
-- Tratamento para inserir o resultado nos campos corretos dependento do formato do resultado 
qt_resultado_ww 	:= trim(both replace(ds_resultado_p, '.', ','));
ds_resultado_w		:= null;
 
begin 
select 	(coalesce(qt_resultado_ww,0))::numeric  
into STRICT 	qt_resultado_w
;
 
exception 
	when others then 
	begin 
	 
	select (coalesce(replace(qt_resultado_ww, ',', '.'),0))::numeric  
	into STRICT qt_resultado_w 
	;
	 
	exception 
	when others then	 
		ds_resultado_w := ds_resultado_p;
	end;
end;
 
if (nr_seq_prescricao_w IS NOT NULL AND nr_seq_prescricao_w::text <> '') then 
	begin 
	-- Concatena o resultado com resultado já existente quando a quantidade de linhas do resultado for maior que 1 
	if (ds_linha_resultado_p > 1) then 
		select MAX(a.ds_resultado) 
		into STRICT	ds_resultado_ww 
		from 	exame_lab_result_item a, 
			exame_lab_resultado b 
		where 	a.nr_seq_resultado = b.nr_seq_resultado 
		and	a.nr_seq_prescr  = nr_seq_prescricao_w 
		and	b.nr_prescricao	  = nr_prescricao_p;
		 
		ds_resultado_w := ds_resultado_ww || ds_resultado_w;
	end if;
 
		ds_erro_p := Atualizar_Lab_Result_Item(	nr_prescricao_p, nr_seq_prescricao_w, cd_analito_w, qt_resultado_w, null, ds_resultado_w, ' ', null, null, nm_usuario_p, null, ' ', ds_unidade_medida_p, null, null, ds_erro_p);
	end;
end if;
					 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lsf_atualiza_lab_result_item (nr_prescricao_p text, nr_seq_exame_p text, cd_analito_p text, ds_resultado_p text, ds_unidade_medida_p text, ds_linha_resultado_p bigint, ie_normalidade_p text, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

