-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_titulo_pagar_solic_comp (nr_solic_compra_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_estabelecimento_w		smallint;
dt_vencimento_w			timestamp;
cd_cgc_w			varchar(14);
cd_pessoa_fisica_w		varchar(10);
nr_seq_trans_baixa_tit_pagar_w	bigint;
nr_seq_trans_financ_w		bigint;
nr_titulo_w			bigint;
cd_moeda_w			smallint;
tx_juros_w			double precision;
tx_multa_w			double precision;
cd_tipo_taxa_juro_w		bigint;
cd_tipo_taxa_multa_w		bigint;
vl_titulo_w			double precision;
cd_centro_custo_w		integer;
nr_sequencia_w			bigint;
ds_observacao_w			varchar(4000);
cd_conta_contabil_w		varchar(20);
cd_centro_custo_rateio_w	integer;
vl_material_w			double precision;
nr_seq_trans_fin_classif_w	varchar(10);
qt_itens_aprov_w		bigint;
cd_estab_financeiro_w		smallint;
ie_tipo_titulo_w		titulo_pagar.ie_tipo_titulo%type;
nr_seq_conta_financ_w		solic_compra_item.nr_seq_conta_financ%type;
nr_contrato_w			solic_compra_item.nr_contrato%type;			
 
C01 CURSOR FOR 
SELECT	b.cd_conta_contabil, 
	coalesce(c.cd_centro_custo,a.cd_centro_custo) cd_centro_custo, 
	coalesce(c.vl_rateio,coalesce(b.vl_unit_previsto,0) * b.qt_material) vl_rateio, 
	b.nr_seq_conta_financ 
FROM solic_compra a, solic_compra_item b
LEFT OUTER JOIN solic_compra_item_rateio c ON (b.nr_solic_compra = c.nr_solic_compra AND b.nr_item_solic_compra = c.nr_item_solic_compra)
WHERE a.nr_solic_compra	= b.nr_solic_compra   and coalesce(b.dt_reprovacao::text, '') = '' AND b.nr_solic_compra	= nr_solic_compra_p;


BEGIN 
 
select	count(*), 
	max(nr_contrato) 
into STRICT	qt_itens_aprov_w, 
	nr_contrato_w 
from	solic_compra_item a 
WHERE	coalesce(a.dt_reprovacao::text, '') = '' 
AND	a.nr_solic_compra	= nr_solic_compra_p;
 
if (qt_itens_aprov_w = 0) then 
	--Não é permitido gerar o título a pagar porque todos os itens dessa solicitação estão reprovados. 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(250889);
end if;
 
nr_seq_trans_fin_classif_w := obter_param_usuario(913, 252, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, nr_seq_trans_fin_classif_w);
ie_tipo_titulo_w := obter_param_usuario(913, 265, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_tipo_titulo_w);
 
select	cd_estabelecimento, 
	dt_vencimento, 
	cd_fornec_sugerido, 
	cd_pessoa_fisica, 
	cd_centro_custo, 
	ds_observacao 
into STRICT	cd_estabelecimento_w, 
	dt_vencimento_w, 
	cd_cgc_w, 
	cd_pessoa_fisica_w, 
	cd_centro_custo_w, 
	ds_observacao_w 
from	solic_compra 
where	nr_solic_compra	= nr_solic_compra_p;
 
select	sum(coalesce(vl_unit_previsto,0) * qt_material) 
into STRICT	vl_titulo_w 
from	solic_compra_item 
where	nr_solic_compra	= nr_solic_compra_p;
 
nr_seq_trans_baixa_tit_pagar_w	:= null;
nr_seq_trans_financ_w		:= null;
 
begin 
 
select	cd_moeda_padrao, 
	cd_tipo_taxa_juro, 
	cd_tipo_taxa_multa, 
	pr_juro_padrao, 
	pr_multa_padrao, 
	nr_trans_fin_baixa_solic, 
	nr_trans_fin_contab_solic 
into STRICT	cd_moeda_w, 
	cd_tipo_taxa_juro_w, 
	cd_tipo_taxa_multa_w, 
	tx_juros_w, 
	tx_multa_w, 
	nr_seq_trans_baixa_tit_pagar_w, 
	nr_seq_trans_financ_w 
from	parametros_contas_pagar a 
where	a.cd_estabelecimento	= cd_estabelecimento_w;
exception 
	when others then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(204431);
end;
 
if (coalesce(dt_vencimento_w::text, '') = '') then 
	dt_vencimento_w	:= trunc(clock_timestamp(),'dd') + 30;
end if;
 
select	cd_estab_financeiro 
into STRICT	cd_estab_financeiro_w 
from	estabelecimento 
where	cd_estabelecimento = cd_estabelecimento_w;
 
select	nextval('titulo_pagar_seq') 
into STRICT	nr_titulo_w
;
 
insert	into titulo_pagar(nr_titulo, 
	nm_usuario, 
	dt_atualizacao, 
	cd_estabelecimento, 
	dt_emissao, 
	dt_vencimento_original, 
	dt_vencimento_atual, 
	vl_titulo, 
	vl_saldo_titulo, 
	vl_saldo_juros, 
	vl_saldo_multa, 
	cd_moeda, 
	tx_juros, 
	tx_multa, 
	cd_tipo_taxa_juro, 
	cd_tipo_taxa_multa, 
	ie_situacao, 
	ie_origem_titulo, 
	ie_tipo_titulo,	 
	nr_seq_trans_fin_contab, 
	cd_pessoa_fisica, 
	cd_cgc, 
	nr_solic_compra, 
	nr_seq_trans_fin_baixa, 
	ds_observacao_titulo, 
	cd_estab_financeiro, 
	dt_contabil, 
	nr_seq_contrato) 
values (nr_titulo_w, 
	nm_usuario_p, 
	clock_timestamp(), 
	cd_estabelecimento_w, 
	trunc(clock_timestamp(),'dd'), 
	dt_vencimento_w, 
	dt_vencimento_w, 
	vl_titulo_w, 
	vl_titulo_w, 
	0, 
	0, 
	cd_moeda_w, 
	tx_juros_w, 
	tx_multa_w, 
	cd_tipo_taxa_juro_w, 
	cd_tipo_taxa_multa_w, 
	'A', 
	2, 
	coalesce(ie_tipo_titulo_w,1),	 
	nr_seq_trans_financ_w, 
	cd_pessoa_fisica_w, 
	cd_cgc_w, 
	nr_solic_compra_p, 
	nr_seq_trans_baixa_tit_pagar_w, 
	WHEB_MENSAGEM_PCK.get_texto(302643,'DS_OBSERVACAO_W='|| DS_OBSERVACAO_W ||';NR_SOLIC_COMPRA_P='|| NR_SOLIC_COMPRA_P), /*ds_observacao_w || chr(13) || chr(10) || 'Titulo gerado pelo solicitação '||nr_solic_compra_p,*/ 
	cd_estab_financeiro_w, 
	trunc(clock_timestamp(),'dd'), 
	nr_contrato_w);
 
 
open C01;
loop 
fetch C01 into	 
	cd_conta_contabil_w, 
	cd_centro_custo_rateio_w, 
	vl_material_w, 
	nr_seq_conta_financ_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	select	coalesce(max(nr_sequencia_w),0) + 1 
	into STRICT	nr_sequencia_w 
	from	titulo_pagar_classif 
	where	nr_titulo = nr_titulo_w;
 
	insert into titulo_pagar_classif( 
		nr_titulo, 
		nr_sequencia, 
		vl_titulo, 
		dt_atualizacao, 
		nm_usuario, 
		cd_centro_custo, 
		cd_conta_contabil, 
		nr_seq_trans_fin, 
		nr_seq_conta_financ) 
	values (nr_titulo_w, 
		nr_sequencia_w, 
		vl_material_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_centro_custo_rateio_w, 
		cd_conta_contabil_w, 
		(nr_seq_trans_fin_classif_w)::numeric , 
		nr_seq_conta_financ_w);
	end;
 
end loop;
close C01;
 
CALL Ajustar_raterio_tit_pagar(nr_titulo_w);
 
CALL atualizar_inclusao_tit_pagar(nr_titulo_w, nm_usuario_p);
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_titulo_pagar_solic_comp (nr_solic_compra_p bigint, nm_usuario_p text) FROM PUBLIC;

