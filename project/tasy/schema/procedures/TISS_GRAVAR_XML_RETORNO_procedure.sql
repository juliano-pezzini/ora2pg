-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_gravar_xml_retorno (cd_estabelecimento_p bigint, ie_tipo_tiss_p text, nr_seq_xml_projeto_p bigint, nm_usuario_p text, cd_convenio_p bigint, ds_xml_p text, ie_envio_retorno_p text, ds_endereco_serv_p text, ds_serv_porta_p text, ie_status_p text, nr_seq_log_origem_p bigint, nr_seq_log_retorno_p INOUT bigint) AS $body$
DECLARE


nr_sequencia_w	bigint;
ie_tipo_tiss_w tiss_log.ie_tipo_tiss%TYPE;
IE_ENVIO_RET_C CONSTANT varchar(1) := 'R';
--dominio 1554
GUIA_SOLICITACAO_C CONSTANT smallint := 3;
AUT_SERVICO_C      CONSTANT smallint := 10;
SOLIC_STATUS_AUT_C CONSTANT smallint := 18;
RESP_STATUS_AUT_C  CONSTANT smallint := 24;


BEGIN

if (ie_envio_retorno_p = IE_ENVIO_RET_C) then
    if (ie_tipo_tiss_p = GUIA_SOLICITACAO_C) then
        ie_tipo_tiss_w := AUT_SERVICO_C;
    end if;

    if (ie_tipo_tiss_p = SOLIC_STATUS_AUT_C) then
        ie_tipo_tiss_w := RESP_STATUS_AUT_C;
    end if;

    if (coalesce(ie_tipo_tiss_w::text, '') = '') then
        ie_tipo_tiss_w := ie_tipo_tiss_p;
    end if;
else
    ie_tipo_tiss_w := ie_tipo_tiss_p;
end if;

if (ie_status_p <> 'EE') then

	select	nextval('tiss_log_seq')
	into STRICT	nr_sequencia_w
	;

	insert	into	tiss_log(
			nr_sequencia,
			cd_estabelecimento,
			ie_tipo_tiss,
			nr_seq_xml_projeto,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_convenio,
			dt_evento,
			nr_seq_protocolo,
			nr_seq_autorizacao,
			nr_seq_retorno,
			ds_xml,
			ds_xml_clob,
			ds_hash,
			ie_comunicacao,
			ie_status,
			ie_envio_retorno,
			nr_seq_log_origem,
			ds_endereco_serv,
			ds_serv_porta,
			ie_hosp_pls)
		values (nr_sequencia_w,
			cd_estabelecimento_p,
			ie_tipo_tiss_w,
			nr_seq_xml_projeto_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_convenio_p,
			clock_timestamp(),
			null,
			null,
			null,
			ds_xml_p,
			null,
			null,
			'WS',
			ie_status_p,
			'R',
			nr_seq_log_origem_p,
			ds_endereco_serv_p,
			ds_serv_porta_p,
			'H');

	update	tiss_log
	set	ie_status = 'E'
	where	nr_sequencia = nr_seq_log_origem_p;

else
	update	tiss_log
	set	ie_status = ie_status_p
	where	nr_sequencia = nr_seq_log_origem_p;

	select	nextval('tiss_log_hist_seq')
	into STRICT	nr_sequencia_w
	;

	insert into tiss_log_hist(nr_sequencia,
		nr_seq_log,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ds_historico)
	values (nr_sequencia_w,
		nr_seq_log_origem_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		' ');

end if;

commit;

nr_seq_log_retorno_p	:= nr_sequencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_gravar_xml_retorno (cd_estabelecimento_p bigint, ie_tipo_tiss_p text, nr_seq_xml_projeto_p bigint, nm_usuario_p text, cd_convenio_p bigint, ds_xml_p text, ie_envio_retorno_p text, ds_endereco_serv_p text, ds_serv_porta_p text, ie_status_p text, nr_seq_log_origem_p bigint, nr_seq_log_retorno_p INOUT bigint) FROM PUBLIC;

