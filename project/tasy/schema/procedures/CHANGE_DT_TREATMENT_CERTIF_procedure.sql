-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE change_dt_treatment_certif ( nr_atendimento_p atendimento_paciente.nr_atendimento%type) AS $body$
DECLARE


nr_atendimento_w    		atendimento_paciente.nr_atendimento%type;
nr_seq_tipo_admissao_fat_w  atendimento_paciente.nr_seq_tipo_admissao_fat%type;
nr_seq_tipo_episodio_w    	episodio_paciente.nr_seq_tipo_episodio%type;
is_kv_w						varchar(1);


BEGIN

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then

	nr_atendimento_w := null;
	nr_seq_tipo_admissao_fat_w := null;
	nr_seq_tipo_episodio_w := null;

	select 	max(ap.nr_atendimento),
			max(ap.nr_seq_tipo_admissao_fat),
			max(ep.nr_seq_tipo_episodio)
	into STRICT	nr_atendimento_w,
			nr_seq_tipo_admissao_fat_w,
			nr_seq_tipo_episodio_w
	from	atendimento_paciente ap,
			episodio_paciente ep
	where	ap.nr_seq_episodio = ep.nr_sequencia
	and 	ap.nr_atendimento = nr_atendimento_p;
									
    if ((nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') and (nr_seq_tipo_admissao_fat_w IS NOT NULL AND nr_seq_tipo_admissao_fat_w::text <> '') and (nr_seq_tipo_episodio_w IS NOT NULL AND nr_seq_tipo_episodio_w::text <> '')) then

		select  coalesce(max('S'), 'N')
		into STRICT	is_kv_w
		from    tipo_admissao_fat taf
		where   taf.nr_sequencia in ( SELECT  max(se.nr_seq_tipo_admissao)
						  from    subtipo_episodio se
						  where   se.nr_seq_tipo_admissao = nr_seq_tipo_admissao_fat_w
						  and     se.nr_seq_tipo_episodio = nr_seq_tipo_episodio_w)
		and     taf.ie_tipo_kv = 'S'
		and     taf.ie_situacao = 'A';
		
		if (is_kv_w = 'S') then
			update	atendimento_paciente_inf
			set		dt_inicio_validade  = NULL,
					dt_validade  = NULL,
					dt_atualizacao = clock_timestamp(),
					nm_usuario = wheb_usuario_pck.get_nm_usuario
			where 	nr_atendimento = nr_atendimento_w;

			commit;
		end if;
	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE change_dt_treatment_certif ( nr_atendimento_p atendimento_paciente.nr_atendimento%type) FROM PUBLIC;

