-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cheque_cr_perda ( nr_seq_caixa_rec_p bigint, ds_lista_cheque_p text, ie_tipo_perda_p text, nm_usuario_p text, nr_seq_motivo_perda_p bigint) AS $body$
DECLARE


vl_cheque_w		double precision;
vl_saldo_negociado_w	double precision;
vl_juros_w		double precision;
vl_multa_w		double precision;
nr_seq_cheque_w		bigint;
nr_seq_trans_financ_w	bigint;
nr_sequencia_w		integer;
cd_estabelecimento_w	smallint;
dt_negociacao_w		timestamp;

c01 CURSOR FOR
	SELECT	nr_seq_cheque,
		vl_cheque,
		vl_saldo_negociado
	from	cheque_cr
	where	' ' || ds_lista_cheque_p || ' ' like '% ' || nr_seq_cheque || ' %'
	and	(ds_lista_cheque_p IS NOT NULL AND ds_lista_cheque_p::text <> '');


BEGIN
if (coalesce(ds_lista_cheque_p::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(216474);
end if;

select	dt_recebimento,
	nr_seq_trans_financ
into STRICT	dt_negociacao_w,
	nr_seq_trans_financ_w
from	caixa_receb
where	nr_sequencia	= nr_seq_caixa_rec_p;

open c01;
loop
fetch c01 into
	nr_seq_cheque_w,
	vl_cheque_w,
	vl_saldo_negociado_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	insert into cheque_cr_perda(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_caixa_rec,
		nr_seq_cheque,
		ie_tipo_perda,
		vl_perda,
		nr_seq_motivo_perda)
	values (	nextval('cheque_cr_perda_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_caixa_rec_p,
		nr_seq_cheque_w,
		ie_tipo_perda_p,
		coalesce(vl_saldo_negociado_w, vl_cheque_w),
		nr_seq_motivo_perda_p);
	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cheque_cr_perda ( nr_seq_caixa_rec_p bigint, ds_lista_cheque_p text, ie_tipo_perda_p text, nm_usuario_p text, nr_seq_motivo_perda_p bigint) FROM PUBLIC;

