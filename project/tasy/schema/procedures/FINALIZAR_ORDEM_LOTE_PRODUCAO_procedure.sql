-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE finalizar_ordem_lote_producao ( nr_seq_horario_p bigint, nr_seq_area_prep_p bigint, nr_seq_lp_individual_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_ordem_w			bigint;
nr_seq_processo_w		bigint;
dt_inicio_preparo_w		timestamp;
dt_preparo_w			timestamp;
nm_usuario_manipulador_w	varchar(15);
nm_usuario_farmaceutico_w	varchar(15);



BEGIN


select	max(nr_seq_etiqueta)
into STRICT	nr_seq_ordem_w
from	prescr_mat_hor
where	nr_sequencia	=	nr_seq_horario_p
and		coalesce(nr_seq_superior::text, '') = ''
and		Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

if (coalesce(nr_seq_ordem_w::text, '') = '') then
	select	max(nr_seq_etiqueta)
	into STRICT	nr_seq_ordem_w
	from	prescr_mat_hor
	where	nr_sequencia	=	nr_seq_horario_p
	and		Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
end if;

select	max(dt_preparo),
	max(dt_inicio_preparo),
	max(obter_usuario_pf(cd_farmaceutico)),
	max(obter_usuario_pf(cd_manipulador))
into STRICT	dt_preparo_w,
	dt_inicio_preparo_w,
	nm_usuario_farmaceutico_w,
	nm_usuario_manipulador_w
from	lp_individual
where	nr_sequencia	=	nr_seq_lp_individual_p;

if (nr_seq_ordem_w > 0) then
	update	adep_processo_frac
	set	dt_preparo		= dt_inicio_preparo_w,
		nm_usuario_preparo	= nm_usuario_manipulador_w,
		dt_fim_preparo		= dt_preparo_w,
		nm_usuario_fim_preparo	= nm_usuario_farmaceutico_w,
		dt_atualizacao		= clock_timestamp(),
		nm_usuario		= nm_usuario_p
	where	nr_sequencia		= nr_seq_ordem_w;

	if (coalesce(nr_seq_area_prep_p,0) > 0) then
		select	coalesce(max(nr_seq_processo),0)
		into STRICT	nr_seq_processo_w
		from	adep_processo_frac
		where	nr_sequencia = nr_seq_ordem_w;

		update	adep_processo_area a
		set	a.dt_preparo 		= clock_timestamp(),
			a.nm_usuario_preparo	= nm_usuario_p
		where	a.nr_seq_processo	= nr_seq_processo_w
		and	a.nr_seq_area_prep	= nr_seq_area_prep_p
		and	not exists (
				SELECT	1
				from	adep_processo_frac x,
					prescr_mat_hor y
				where	y.nr_seq_etiqueta	= x.nr_sequencia
				and	y.nr_seq_processo	= x.nr_seq_processo
				and	x.nr_seq_processo	= nr_seq_processo_w
				and	y.nr_seq_area_prep	= nr_seq_area_prep_p
				and	coalesce(x.dt_fim_preparo::text, '') = ''
				and	coalesce(y.dt_suspensao::text, '') = ''
				and	x.nr_sequencia		<> nr_seq_ordem_w);
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE finalizar_ordem_lote_producao ( nr_seq_horario_p bigint, nr_seq_area_prep_p bigint, nr_seq_lp_individual_p bigint, nm_usuario_p text) FROM PUBLIC;

