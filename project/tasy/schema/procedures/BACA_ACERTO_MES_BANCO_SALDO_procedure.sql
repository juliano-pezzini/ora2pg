-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_acerto_mes_banco_saldo (nr_seq_conta_p bigint, dt_inicial_p timestamp) AS $body$
DECLARE


dt_ref_antiga_w				timestamp;
dt_ref_nova_w				timestamp;
nr_seq_saldo_banco_antigo_w		bigint;
nr_seq_saldo_banco_novo_w		bigint;
dt_referencia_w				timestamp;
cont_w					smallint;
qt_registros_w				bigint;
nr_seq_conta_w				bigint;


c01 CURSOR FOR
SELECT	a.nr_seq_conta,
	trunc(a.DT_REFERENCIA, 'month'),
	count(*)
from	banco_saldo a
where	a.nr_seq_conta			= nr_seq_conta_p
and	trunc(dt_referencia, 'month')	>= trunc(dt_inicial_p, 'month')
group	by trunc(a.DT_REFERENCIA, 'month'),
	a.nr_seq_conta
having	count(*) > 1;



BEGIN

qt_registros_w		:= 0;

open c01;
loop
fetch c01 into
	nr_seq_conta_w,
	dt_referencia_w,
	cont_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	-- Pegar dados antigos
	select	max(dt_referencia)
	into STRICT	dt_ref_antiga_w
	from	banco_saldo
	where	nr_seq_conta			= nr_seq_conta_p
	and	trunc(dt_referencia, 'month')	= dt_referencia_w;

	select	max(nr_sequencia)
	into STRICT	nr_seq_saldo_banco_antigo_w
	from	banco_saldo
	where	nr_seq_conta	= nr_seq_conta_p
	and	dt_referencia	= dt_ref_antiga_w;

	-- Pegar dados novos
	select	min(dt_referencia)
	into STRICT	dt_ref_nova_w
	from	banco_saldo
	where	nr_seq_conta	= nr_seq_conta_p
	and	trunc(dt_referencia, 'month')	= dt_referencia_w;

	select	min(nr_sequencia)
	into STRICT	nr_seq_saldo_banco_novo_w
	from	banco_saldo
	where	nr_seq_conta	= nr_seq_conta_p
	and	dt_referencia	= dt_ref_nova_w;


	update	movto_trans_financ
	set	nr_seq_saldo_banco	= nr_seq_saldo_banco_novo_w,
		dt_referencia_saldo	= dt_ref_nova_w
	where	nr_seq_saldo_banco	= nr_seq_saldo_banco_antigo_w
	and	trunc(dt_referencia_saldo, 'dd')	= trunc(dt_ref_antiga_w, 'dd')
	and	nr_seq_banco		= nr_seq_conta_p;

	qt_registros_w		:= qt_registros_w + 1;

	RAISE NOTICE 'qt_registros_w = %', qt_registros_w;

end loop;
close c01;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_acerto_mes_banco_saldo (nr_seq_conta_p bigint, dt_inicial_p timestamp) FROM PUBLIC;

