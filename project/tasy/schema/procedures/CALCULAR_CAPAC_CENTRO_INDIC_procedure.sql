-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_capac_centro_indic ( cd_estabelecimento_p bigint, cd_tabela_custo_p bigint, nm_usuario_p text, nr_seq_tabela_p bigint default null, cd_centro_controle_p bigint default null) AS $body$
DECLARE



dt_atualizacao_w		timestamp		:= clock_timestamp();
dt_mes_referencia_w		timestamp;
cd_centro_controle_w		integer	:= 0;
nr_seq_indicador_w		bigint;
nr_sequencia_nivel_w		bigint	:= 0;
qt_disponibilidade_w		double precision	:= 0;
cd_nivel_capacidade_w		smallint;
ie_calculo_capac_w		varchar(10);
cd_estabelecimento_w		bigint;
cd_centro_controle_selec_w	bigint	:= cd_centro_controle_p;

c01 CURSOR FOR
SELECT	a.nr_sequencia_nivel,
	c.cd_centro_controle,
	a.cd_nivel_capacidade,
	c.cd_estabelecimento
from	centro_controle c,
	capac_centro_controle a
where	a.cd_estabelecimento	= c.cd_estabelecimento
and	a.cd_centro_controle	= c.cd_centro_controle
and	a.nr_seq_tabela		= nr_seq_tabela_p
and	a.cd_nivel_capacidade	in (1,4)
and	c.cd_centro_controle	= coalesce(cd_centro_controle_selec_w, c.cd_centro_controle)
and	exists(	SELECT 1
		from	centro_controle_indicador y
		where	c.cd_estabelecimento	= y.cd_estabelecimento
		and	c.cd_centro_controle	= y.cd_centro_controle
		and 	((a.cd_nivel_capacidade	= 1 and ie_calculo_capac in ('T','W')) or (cd_nivel_capacidade = 4 and ie_calculo_capac = 'S'))
		and	dt_mes_referencia_w between coalesce(y.dt_inicio_vigencia, dt_mes_referencia_w) and coalesce(y.dt_fim_vigencia, dt_mes_referencia_w)
		and	y.ie_calculo_capac in ('S','T','W'))
order by c.cd_centro_controle,
	 a.cd_nivel_capacidade;


BEGIN

if (cd_centro_controle_p = 0) then
	cd_centro_controle_selec_w	:= null;
end if;

select	max(dt_mes_referencia)
into STRICT	dt_mes_referencia_w
from	tabela_custo
where	nr_sequencia		= nr_seq_tabela_p;

open c01;
loop
fetch c01 into
	nr_sequencia_nivel_w,
	cd_centro_controle_w,
	cd_nivel_capacidade_w,
	cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	qt_disponibilidade_w		:= 0;

	if ( cd_nivel_capacidade_w = 1) then
		begin

		select	coalesce(max(nr_seq_indicador),0),
			coalesce(max(ie_calculo_capac),wheb_mensagem_pck.get_texto(798468))
		into STRICT	nr_seq_indicador_w,
			ie_calculo_capac_w
		from (
			SELECT	nr_seq_indicador,
				ie_calculo_capac
			from	centro_controle_indicador
			where	cd_estabelecimento	= cd_estabelecimento_w
			and	cd_centro_controle	= cd_centro_controle_w
			and	ie_calculo_capac in ('T','W')
			order by ie_calculo_capac desc
			) alias7 LIMIT 1;

		end;
	elsif (cd_nivel_capacidade_w = 4) then
		begin

		select	coalesce(max(nr_seq_indicador),0)
		into STRICT	nr_seq_indicador_w
		from	centro_controle_indicador
		where	cd_estabelecimento	= cd_estabelecimento_w
		and	cd_centro_controle	= cd_centro_controle_w
		and	ie_calculo_capac = 'S';

		end;
	end if;

	if ( nr_seq_indicador_w > 0) then

		qt_disponibilidade_w := cus_calcular_result_ind_sql(	nr_seq_indicador_w, cd_tabela_custo_p, cd_estabelecimento_w, cd_centro_controle_w, dt_mes_referencia_w, qt_disponibilidade_w, nr_seq_tabela_p);

		if (cd_nivel_capacidade_w = 1) then
			begin

			if (ie_calculo_capac_w = 'W') then
				begin

				update	capac_centro_controle
				set	qt_disponibilidade	= qt_disponibilidade_w,
					nm_usuario		= nm_usuario_p,
					dt_atualizacao		= dt_atualizacao_w
				where	nr_seq_tabela		= nr_seq_tabela_p
				and	cd_estabelecimento	= cd_estabelecimento_w
				and	cd_centro_controle	= cd_centro_controle_w;
				commit;

				end;
			elsif (ie_calculo_capac_w = 'T') then
				begin

				update	capac_centro_controle
				set	qt_disponibilidade	= qt_disponibilidade_w,
					nm_usuario		= nm_usuario_p,
					dt_atualizacao		= dt_atualizacao_w
				where	nr_seq_tabela		= nr_seq_tabela_p
				and	cd_centro_controle	= cd_centro_controle_w
				and	cd_estabelecimento	= cd_estabelecimento_w
				and	cd_nivel_capacidade 	in (1,2,3);
				commit;
				end;
			end if;

			end;
		elsif (cd_nivel_capacidade_w = 4) then
			begin

			update	capac_centro_controle
			set	qt_disponibilidade	= qt_disponibilidade_w,
				nm_usuario		= nm_usuario_p,
				dt_atualizacao		= dt_atualizacao_w
			where	nr_seq_tabela		= nr_seq_tabela_p
			and	cd_centro_controle	= cd_centro_controle_w
			and	cd_estabelecimento	= cd_estabelecimento_w
			and	nr_sequencia_nivel	= nr_sequencia_nivel_w;
			commit;

			end;
		end if;
	end if;

	end;
end loop;
close c01;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_capac_centro_indic ( cd_estabelecimento_p bigint, cd_tabela_custo_p bigint, nm_usuario_p text, nr_seq_tabela_p bigint default null, cd_centro_controle_p bigint default null) FROM PUBLIC;

