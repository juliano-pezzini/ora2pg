-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_evol_cur (nr_atendimento_p bigint, nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
C01 CURSOR FOR 
  SELECT  a.dt_evolucao, 
    b.cd_pessoa_fisica, 
    a.dt_atualizacao, 
    a.nm_usuario, 
    nr_atendimento_p, 
    a.ds_evolucao, 
    obter_dados_usuario_opcao(a.nm_usuario,'C') cd_medico, 
    a.dt_liberacao, 
    a.ie_evolucao_clinica, 
    a.ie_situacao, 
    obter_especialidade_medico(cd_medico,'') cd_especialidade 
  FROM  CUR_EVOLUCAO a, 
    cur_ferida b 
  WHERE  a.NR_SEQ_FERIDA = b.nr_sequencia 
  and  a.nr_sequencia = nr_sequencia_p;

Vet01 C01%RowType;
ie_tipo_evolucao_w  varchar(3);


BEGIN 
open C01;
  loop 
  fetch C01 into 
    Vet01;
  EXIT WHEN NOT FOUND; /* apply on C01 */
  begin 
   
  select  coalesce(max(ie_tipo_evolucao),1) 
  into STRICT  ie_tipo_evolucao_w 
  from  usuario 
  where  nm_usuario = Vet01.nm_usuario;
   
  insert into evolucao_paciente( 
      cd_evolucao, 
      dt_evolucao, 
      cd_pessoa_fisica, 
      dt_atualizacao, 
      nm_usuario, 
      nr_atendimento, 
      ds_evolucao, 
      cd_medico, 
      dt_liberacao, 
      ie_evolucao_clinica, 
      ie_situacao, 
      ie_tipo_evolucao, 
			IE_RECEM_NATO, 
      IE_EVOLUCAO_DOR, 
      IE_AVALIADOR_AUX) 
  values (nextval('evolucao_paciente_seq'), 
      Vet01.dt_evolucao, 
      Vet01.cd_pessoa_fisica, 
      Vet01.dt_atualizacao, 
      Vet01.nm_usuario, 
      nr_atendimento_p, 
      Vet01.ds_evolucao, 
      Vet01.cd_medico, 
      Vet01.dt_liberacao, 
      Vet01.ie_evolucao_clinica, 
      Vet01.ie_situacao, 
      ie_tipo_evolucao_w, 
			'N', 
      'N', 
      'N');
  end;
  end loop;
  close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_evol_cur (nr_atendimento_p bigint, nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

