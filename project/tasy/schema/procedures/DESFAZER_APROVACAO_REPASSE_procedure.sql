-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_aprovacao_repasse (nr_repasse_terceiro_p bigint, nm_usuario_p text, ie_commit_p text) AS $body$
DECLARE


qt_titulos_w	integer;
ie_aprova_repasse_w	varchar(1);
count_w			bigint;
ie_nota_w		bigint;


BEGIN

ie_aprova_repasse_w := Obter_Param_Usuario(89, 160, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_aprova_repasse_w);

select count(*)
into STRICT	qt_titulos_w
from titulo_pagar
where nr_repasse_terceiro = nr_repasse_terceiro_p;

select	count(*)
into STRICT	ie_nota_w
from	REPASSE_NOTA_FISCAL
where	nr_repasse_terceiro = nr_repasse_terceiro_p;

if (ie_nota_w > 0) then
	--'A aprovação não pode ser desfeita. Existe nota fiscal gerada para este repasse!'
	CALL wheb_mensagem_pck.exibir_mensagem_abort(339911);
end if;


if (coalesce(ie_aprova_repasse_w,'N') = 'S') then

	select	count(*)
	into STRICT	count_w
	from	repasse_terceiro_aprovacao
	where   nr_repasse_terceiro = nr_repasse_terceiro_p
	and     (dt_aprovacao IS NOT NULL AND dt_aprovacao::text <> '');

	if (count_w > 0) then

		update	repasse_terceiro_aprovacao
		set	dt_aprovacao  = NULL
		where   nr_repasse_terceiro = nr_repasse_terceiro_p;

	end if;

end if;

if (qt_titulos_w > 0) then
	/* Operação cancelada. Existem títulos para este repasse! */

	CALL wheb_mensagem_pck.exibir_mensagem_abort(261374);
end if;

update	repasse_terceiro
set	dt_aprovacao_terceiro    = NULL,
	nm_usuario_aprov	 = NULL,
	nm_usuario		= nm_usuario_p,
	dt_atualizacao		= clock_timestamp()
where	nr_repasse_terceiro	= nr_repasse_terceiro_p;

if (ie_commit_p	<> 'N') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_aprovacao_repasse (nr_repasse_terceiro_p bigint, nm_usuario_p text, ie_commit_p text) FROM PUBLIC;

