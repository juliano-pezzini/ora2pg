-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE w_agecons_montar_agendas_lib ( ds_lista_Agenda_p text, nm_usuario_p text) AS $body$
DECLARE


ds_lista_Agenda_w	varchar(32000);											
tam_lista_w			bigint;
ie_pos_virgula_w	bigint;
cd_agenda_w			varchar(10);
ds_erro_w			varchar(1);
cd_tipo_agenda_w 	agenda.cd_tipo_agenda%type;
											

BEGIN

if (ds_lista_Agenda_p IS NOT NULL AND ds_lista_Agenda_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '')then	
	ds_lista_Agenda_w	:= ds_lista_Agenda_p;
	
	IF (substr(ds_lista_Agenda_w,length(ds_lista_Agenda_w),1) <> ',') THEN
		ds_lista_Agenda_w := ds_lista_Agenda_w || ',';
	END IF;
	
	while(ds_lista_Agenda_w IS NOT NULL AND ds_lista_Agenda_w::text <> '') loop
		begin
		
		tam_lista_w			:= 	length(ds_lista_Agenda_w);
		ie_pos_virgula_w	:= 	position(',' in ds_lista_Agenda_w);
		
		if (ie_pos_virgula_w <> 0) then
			cd_agenda_w				:= coalesce((substr(ds_lista_Agenda_w,1,(ie_pos_virgula_w - 1)))::numeric ,0);
			ds_lista_Agenda_w		:= substr(ds_lista_Agenda_w,(ie_pos_virgula_w + 1),tam_lista_w);			
			
			if (cd_agenda_w > 0)then
			
				select max(cd_tipo_agenda)
				into STRICT cd_tipo_agenda_w
				from agenda
				where cd_agenda = cd_agenda_w;
			
				insert into W_AGENDAS_LIBERADAS(
					cd_agenda,
					nm_usuario,
					cd_tipo_agenda
				) values (
					cd_agenda_w,
					nm_usuario_p,
					cd_tipo_agenda_w
				);				
				
				
				commit;			
			end if;
		else
				goto final;
		end if;			
		end;
	end loop;	

<<final>>
	ds_erro_w	:= '';

end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE w_agecons_montar_agendas_lib ( ds_lista_Agenda_p text, nm_usuario_p text) FROM PUBLIC;

