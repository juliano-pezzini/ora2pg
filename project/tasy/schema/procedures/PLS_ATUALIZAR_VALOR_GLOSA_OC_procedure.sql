-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_valor_glosa_oc ( nr_seq_item_analise_p bigint,		--Sequencia da tabela pls_analise_conta_item 
 vl_glosa_p bigint, qt_glosa_p bigint, nr_seq_grupo_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_analise_w		bigint;
nr_seq_ocorrencia_w		bigint;
ds_observacao_w			varchar(255) := '';
cd_codigo_w			varchar(10);
ds_glosa_ocorrencia_w		varchar(255);
ie_tipo_w			varchar(255);
vl_total_apres_w		double precision;
vl_total_w			double precision;
qt_apresentado_w		double precision;
qt_liberado_w			double precision;
nr_seq_conta_proc_w		bigint;
nr_seq_conta_mat_w		bigint;	
ie_tipo_item_w			varchar(2);
nr_seq_item_w			bigint;
nr_seq_conta_w			bigint;
qt_glosa_w			double precision;
vl_glosa_w			double precision;
ie_status_w			varchar(5);
vl_glosa_ww			double precision;
qt_glosa_ww			bigint;
				

BEGIN 
 
select	nr_seq_analise, 
	nr_seq_ocorrencia, 
	cd_codigo, 
	substr(pls_obter_desc_glosa_oc(cd_codigo, ie_tipo), 1, 255) ds_glosa_ocorrencia, 
	CASE WHEN ie_tipo='G' THEN 'Glosa' WHEN ie_tipo='O' THEN 'Ocorrência' END ,	 
	nr_seq_conta_proc, 
	nr_seq_conta_mat, 
	nr_seq_conta, 
	ie_status 
into STRICT	nr_seq_analise_w, 
	nr_seq_ocorrencia_w, 
	cd_codigo_w, 
	ds_glosa_ocorrencia_w, 
	ie_tipo_w, 
	nr_seq_conta_proc_w, 
	nr_seq_conta_mat_w, 
	nr_seq_conta_w, 
	ie_status_w 
from	pls_analise_conta_item 
where	nr_sequencia = nr_seq_item_analise_p;
 
begin 
select	vl_glosa, 
	qt_glosa 
into STRICT	vl_glosa_ww, 
	qt_glosa_ww 
from	pls_analise_conta_item 
where	nr_sequencia = nr_seq_item_analise_p;
exception 
when others then	 
	vl_glosa_ww := null;
	qt_glosa_ww := null;
end;
 
select	qt_apresentado,	 
	vl_total_apres 
into STRICT	qt_apresentado_w,	 
	vl_total_apres_w 
from	w_pls_resumo_conta	 
where	nr_seq_conta = nr_seq_conta_w 
and 	((nr_seq_item = nr_seq_conta_proc_w AND ie_tipo_item = 'P') 
or 	 (nr_seq_item = nr_seq_conta_mat_w AND ie_tipo_item = 'M'));
 
if (coalesce(qt_apresentado_w,0) < coalesce(qt_glosa_p,0)) then 
	qt_glosa_w := qt_apresentado_w;
else 
	qt_glosa_w := qt_glosa_p;
end if;
 
if (coalesce(vl_total_apres_w,0) < coalesce(vl_glosa_p,0)) then 
	vl_glosa_w := vl_total_apres_w;
else 
	vl_glosa_w := vl_glosa_p;
end if;
 
if (coalesce(nr_seq_conta_proc_w,0) > 0) then 
	nr_seq_item_w	:= nr_seq_conta_proc_w;
	ie_tipo_item_w	:= 'P';
elsif (coalesce(nr_seq_conta_mat_w,0) > 0) then 
	nr_seq_item_w	:= nr_seq_conta_mat_w;
	ie_tipo_item_w	:= 'M';
end if;
 
update	pls_analise_conta_item 
set	vl_glosa = coalesce(vl_glosa_w,coalesce(vl_glosa,0)), 
	qt_glosa = coalesce(qt_glosa_w,coalesce(qt_glosa,0)) 
where	nr_sequencia = nr_seq_item_analise_p;
 
ds_observacao_w := '('||ie_tipo_w||') '||cd_codigo_w||' - '||ds_glosa_ocorrencia_w||chr(13)||chr(10);
 
if (coalesce(vl_glosa_w,0) <> coalesce(vl_glosa_ww,0)) then 
	 
	ds_observacao_w := ds_observacao_w || 'Valor glosado: '||Campo_Mascara_virgula_casas(vl_glosa_w,2)||chr(13)||chr(10);	
	 
end if;
 
if (coalesce(qt_glosa_w,0) <> coalesce(qt_glosa_ww,0)) then 
 
	ds_observacao_w := ds_observacao_w || 'Quantia glosada: '||qt_glosa_w||chr(13)||chr(10);
		 
end if;
 
select	vl_glosa,	 
	qt_glosa 
into STRICT	vl_glosa_w, 
	qt_glosa_w 
from	pls_analise_conta_item 
where	nr_sequencia = nr_seq_item_analise_p;
 
/*Diego OS 347298 - Caso o status do item esteja como negado ao realizar a liberação do item será criado o status "Liberado parcialmente"*/
 
if (ie_status_w in ('N','L')) then 
	 
	/*Se os valores apresentado forem maior que os glosados e haver valor glosado o sistema deixa a glosa ou ocorrência como liberação parcial*/
 
	if (coalesce(qt_apresentado_w,0) > coalesce(qt_glosa_w,0) and coalesce(qt_glosa_w,0) > 0) and (coalesce(vl_total_apres_w,0) > coalesce(vl_glosa_w,0) and coalesce(vl_glosa_w,0) > 0) then		 
		update	pls_analise_conta_item 
		set	ie_status 	= 'L', 
			ie_situacao	= 'I' 
		where	nr_sequencia = nr_seq_item_analise_p 
		and	ie_status	<> 'I';
	elsif (coalesce(qt_apresentado_w,0) = coalesce(qt_glosa_w,0)) or (coalesce(vl_total_apres_w,0) = coalesce(vl_glosa_w,0)) then 
		update	pls_analise_conta_item 
		set	ie_status	= 'N', 
			ie_situacao	= 'A' 
		where	nr_sequencia = nr_seq_item_analise_p 
		and	ie_status	<> 'I';
	end if;
end if;
 
CALL pls_analise_status_pgto(nr_seq_conta_w, nr_seq_conta_mat_w, nr_seq_conta_proc_w, 
			nr_seq_analise_w, cd_estabelecimento_p, nm_usuario_p, 
			null, null, null, 
			null);
 
if (position('Valor glosado:' in ds_observacao_w) > 0) or (position('Quantia glosada:' in ds_observacao_w) > 0) then 
	 
	CALL pls_inserir_hist_analise(null, nr_seq_analise_w, 18, 
				 nr_seq_item_w, ie_tipo_item_w, nr_seq_ocorrencia_w, 
				 null, ds_observacao_w, nr_seq_grupo_p, 
				 nm_usuario_p, cd_estabelecimento_p);
				 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_valor_glosa_oc ( nr_seq_item_analise_p bigint, vl_glosa_p bigint, qt_glosa_p bigint, nr_seq_grupo_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

