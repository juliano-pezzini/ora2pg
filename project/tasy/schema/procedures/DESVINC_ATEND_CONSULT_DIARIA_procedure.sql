-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desvinc_atend_consult_diaria ( nr_sequencia_p bigint, nr_atendimento_p bigint, ie_tipo_agenda_p text, nm_usuario_p text) AS $body$
DECLARE


						
						
						
						
nr_sequencia_w		bigint;
nr_seq_item_princ_w	bigint;					
nr_seq_agenda_cons_w	bigint;
nr_seq_agenda_cons_ww	agenda_consulta.nr_sequencia%type;
ie_agend_selec_w		varchar(1);

C02 CURSOR FOR
		SELECT	nr_seq_agenda_cons
		from	agenda_integrada_item
		where	nr_sequencia = nr_sequencia_w
		
union

		SELECT	nr_seq_agenda_cons
		from	agenda_integrada_item
		where	nr_seq_item_princ = nr_sequencia_w
		
union

		select	nr_seq_agenda_cons
		from	agenda_integrada_item
		where	nr_seq_item_princ = nr_seq_item_princ_w
		and	nr_sequencia <> nr_sequencia_w
		
union

		select	nr_seq_agenda_cons
		from	agenda_integrada_item
		where	nr_sequencia = nr_seq_item_princ_w;
	

BEGIN

ie_agend_selec_w:= Obter_Valor_Param_Usuario(869, 425, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo);

if (coalesce(nr_sequencia_p,0) > 0) and (coalesce(nr_atendimento_p,0) > 0)  then

	if ((ie_tipo_agenda_p = 'C') or (ie_tipo_agenda_p = 'S')) then
	
	update	agenda_consulta
	set	nr_atendimento   = NULL,
		dt_atualizacao  = clock_timestamp(), 
		nm_usuario	= coalesce(nm_usuario_p,obter_usuario_ativo)
	where	nr_sequencia    = nr_sequencia_p
	and	nr_atendimento  = nr_atendimento_p;
		
	else
	
	update	agenda_paciente
	set	nr_atendimento   = NULL,
		dt_atualizacao  = clock_timestamp(),
		nm_usuario	= coalesce(nm_usuario_p,obter_usuario_ativo)
	where	nr_sequencia    = nr_sequencia_p
	and	nr_atendimento  = nr_atendimento_p;
		
	end if;
	
	if (ie_tipo_agenda_p = 'C' and (coalesce(ie_agend_selec_w,'S') = 'S')) then
	
		select	coalesce(max(nr_sequencia),0),
			coalesce(max(nr_seq_item_princ),0)
		into STRICT	nr_sequencia_w,
			nr_seq_item_princ_w
		from   	agenda_integrada_item
		where  	nr_seq_Agenda_cons = nr_sequencia_p;
	
	
		open C02;
		loop
		fetch C02 into	
			nr_seq_agenda_cons_ww;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			
			if (coalesce(nr_seq_agenda_cons_ww,0) > 0) then
				update	agenda_consulta
				set	nr_atendimento   = NULL,
					dt_atualizacao  = clock_timestamp(),
					nm_usuario	= coalesce(nm_usuario_p,obter_usuario_ativo)
				where	nr_sequencia 	= nr_seq_agenda_cons_ww
				and	nr_atendimento  = nr_atendimento_p;
			end if;
			
			end;
		end loop;
		close C02;
	
	end if;
end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desvinc_atend_consult_diaria ( nr_sequencia_p bigint, nr_atendimento_p bigint, ie_tipo_agenda_p text, nm_usuario_p text) FROM PUBLIC;

