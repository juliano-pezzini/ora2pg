-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_inconsistencia_neg_cr (nr_sequencia_p bigint, ie_acao_p text, nm_usuario_p text, nm_usuario_lib_p text, qt_lib_incon_p bigint) AS $body$
DECLARE


nr_sequencia_w		bigint;
qt_usuario_incon_w	bigint;
nm_usuario_w		varchar(15);


BEGIN
nm_usuario_w := '';
if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then
	if (ie_acao_p = 'L') then
		select	max(a.nm_usuario_lib)
		into STRICT	nm_usuario_w
		from	negociacao_cr_incon_lib a
		where 	a.nm_usuario_lib 	= nm_usuario_lib_p
		and	a.nr_seq_inconsistencia	= nr_sequencia_p;

		if (nm_usuario_w IS NOT NULL AND nm_usuario_w::text <> '') then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(265429,'NM_USUARIO=' ||nm_usuario_w);
			--Mensagem: Esta inconsistência já foi liberada pelo usuário || nm_usuario_w .
		else
			insert into negociacao_cr_incon_lib(dt_atualizacao,
				nm_usuario,
				nm_usuario_lib,
				nr_seq_inconsistencia,
				nr_sequencia)
			values (clock_timestamp(),
				nm_usuario_p,
				nm_usuario_lib_p,
				nr_sequencia_p,
				nextval('negociacao_cr_incon_lib_seq'));
		end if;

		select	count(*)
		into STRICT	qt_usuario_incon_w
		from	negociacao_cr_incon_lib
		where	nr_seq_inconsistencia = nr_sequencia_p;

		if (qt_usuario_incon_w >= qt_lib_incon_p) then
			update	negociacao_cr_inconsist
			set	dt_liberacao	= clock_timestamp(),
				nm_usuario_lib	= nm_usuario_lib_p,
				dt_atualizacao	= clock_timestamp(),
				nm_usuario	= nm_usuario_p
			where	nr_sequencia	= nr_sequencia_p;
		end if;
	elsif (ie_acao_p = 'D') then
		delete from negociacao_cr_incon_lib a
		where 	a.nr_seq_inconsistencia	= nr_sequencia_p;

		update	negociacao_cr_inconsist
		set	dt_liberacao	 = NULL,
			nm_usuario_lib	 = NULL,
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p
		where	nr_sequencia	= nr_sequencia_p;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_inconsistencia_neg_cr (nr_sequencia_p bigint, ie_acao_p text, nm_usuario_p text, nm_usuario_lib_p text, qt_lib_incon_p bigint) FROM PUBLIC;

