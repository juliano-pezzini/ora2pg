-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gen_diff_interv_proc (nr_seq_order_unit_p bigint, nm_usuario_p text) AS $body$
DECLARE

									
qt_interv_diff_w			bigint;
qt_dias_diff_w				bigint;
nr_seq_proc_interno_w		proc_interno.nr_sequencia%type;
nr_seq_cpoe_procedimento_w	cpoe_procedimento.nr_sequencia%type;
ie_segunda_w				cpoe_weekday_proc.ie_segunda%type;
ie_terca_w					cpoe_weekday_proc.ie_segunda%type;
ie_quarta_w					cpoe_weekday_proc.ie_segunda%type;
ie_quinta_w					cpoe_weekday_proc.ie_segunda%type;
ie_sexta_w					cpoe_weekday_proc.ie_segunda%type;
ie_sabado_w					cpoe_weekday_proc.ie_segunda%type;
ie_domingo_w				cpoe_weekday_proc.ie_segunda%type;
ie_interv_diff_w			varchar(1) := 'N';
dt_procedimento_w			cpoe_dias_proc_order_unit.dt_procedimento%type;

c01 CURSOR FOR
SELECT	distinct
		a.nr_seq_proc_interno
from	cpoe_weekday_proc_item a,
		cpoe_weekday_proc b
where	a.nr_seq_cpoe_weekday_proc = b.nr_sequencia
and		b.nr_seq_cpoe_order_unit = nr_seq_order_unit_p;

c02 CURSOR FOR
SELECT	max(a.ie_segunda),
		max(a.ie_terca),
		max(a.ie_quarta),
		max(a.ie_quinta),
		max(a.ie_sexta),
		max(a.ie_sabado),
		max(a.ie_domingo)
from 	cpoe_weekday_proc a,
		cpoe_weekday_proc_item b
where 	b.nr_seq_cpoe_weekday_proc	= a.nr_sequencia
and		b.nr_seq_proc_interno		= nr_seq_proc_interno_w
and		a.nr_seq_cpoe_order_unit 	= nr_seq_order_unit_p
and		b.ie_selected 				= 'S';

c03 CURSOR FOR
SELECT	distinct
		a.nr_seq_proc_interno
from	cpoe_proc_diff_order_unit a,
		cpoe_dias_proc_order_unit b
where 	a.nr_seq_cpoe_dias_proc 	= b.nr_sequencia
and		b.nr_seq_cpoe_order_unit 	= nr_seq_order_unit_p
and		a.ie_selected 				= 'S';

c04 CURSOR FOR
SELECT	a.dt_procedimento
from	cpoe_dias_proc_order_unit a,
		cpoe_proc_diff_order_unit b
where	b.nr_seq_cpoe_dias_proc 	= a.nr_sequencia
and		b.nr_seq_proc_interno 		= nr_seq_proc_interno_w
and		a.nr_seq_cpoe_order_unit 	= nr_seq_order_unit_p
and		b.ie_selected 				= 'S';


BEGIN

select	count(*)
into STRICT	qt_interv_diff_w
from 	cpoe_weekday_proc a,
		cpoe_weekday_proc_item b
where 	b.nr_seq_cpoe_weekday_proc	= a.nr_sequencia
and		a.nr_seq_cpoe_order_unit	= nr_seq_order_unit_p
and		b.ie_selected				= 'N';

if (qt_interv_diff_w > 0) then

	ie_interv_diff_w := 'S';

	open c01;
	loop
	fetch c01 into
		nr_seq_proc_interno_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	
		update	cpoe_procedimento
		set 	ie_segunda = 'N',
				ie_terca = 'N',
				ie_quarta = 'N',
				ie_quinta = 'N',
				ie_sexta = 'N',
				ie_sabado = 'N',
				ie_domingo = 'N'
		where	nr_seq_proc_interno = nr_seq_proc_interno_w
		and		nr_seq_cpoe_order_unit = nr_seq_order_unit_p;
	
		open c02;
		loop
		fetch c02 into
			ie_segunda_w,
			ie_terca_w,
			ie_quarta_w,
			ie_quinta_w,
			ie_sexta_w,
			ie_sabado_w,
			ie_domingo_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
		
			update	cpoe_procedimento
			set 	ie_segunda = coalesce(ie_segunda_w, 'N'),
					ie_terca = coalesce(ie_terca_w, 'N'),
					ie_quarta = coalesce(ie_quarta_w, 'N'),
					ie_quinta = coalesce(ie_quinta_w, 'N'),
					ie_sexta = coalesce(ie_sexta_w, 'N'),
					ie_sabado = coalesce(ie_sabado_w, 'N'),
					ie_domingo = coalesce(ie_domingo_w, 'N')
			where	nr_seq_proc_interno = nr_seq_proc_interno_w
			and		nr_seq_cpoe_order_unit = nr_seq_order_unit_p;
	
		end loop;
		close c02;
	
	end loop;
	close c01;

end if;

if (ie_interv_diff_w = 'N') then

	select	count(*)
	into STRICT	qt_dias_diff_w
	from	cpoe_dias_proc_order_unit a
	where	a.nr_seq_cpoe_order_unit = nr_seq_order_unit_p;
	
	if (qt_dias_diff_w > 0) then
	
		open c03;
		loop
		fetch c03 into
			nr_seq_proc_interno_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
		
			select	max(nr_sequencia)
			into STRICT	nr_seq_cpoe_procedimento_w
			from	cpoe_procedimento
			where	nr_seq_proc_interno = nr_seq_proc_interno_w
			and		nr_seq_cpoe_order_unit = nr_seq_order_unit_p;
		
			delete from cpoe_dias_procedimento
			where nr_seq_proc_cpoe = nr_seq_cpoe_procedimento_w;
			
			open c04;
			loop
			fetch c04 into
				dt_procedimento_w;
			EXIT WHEN NOT FOUND; /* apply on c04 */
			
				insert into cpoe_dias_procedimento(
					nr_sequencia,
					dt_atualizacao,
					dt_atualizacao_nrec,
					nm_usuario,
					nm_usuario_nrec,
					dt_procedimento,
					nr_seq_proc_cpoe)
				values (
					nextval('cpoe_dias_procedimento_seq'),
					clock_timestamp(),
					clock_timestamp(),
					nm_usuario_p,
					nm_usuario_p,
					dt_procedimento_w,
					nr_seq_cpoe_procedimento_w
				);
			
			end loop;
			close c04;
		
		end loop;
		close c03;
	
	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gen_diff_interv_proc (nr_seq_order_unit_p bigint, nm_usuario_p text) FROM PUBLIC;

