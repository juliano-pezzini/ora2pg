-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tof_atingimento_meta_finalizar ( cd_estabelecimento_p text, nm_usuario_p text, dt_evento_p timestamp, nr_atendimento_p bigint) AS $body$
DECLARE



contador_w			bigint;
contador_ww			bigint;
contador_www			bigint;
contador_wwww			bigint;
contador_wwwww			bigint;


BEGIN


select	count(*)
into STRICT	contador_w
from	tof_meta_atend a,
	tof_meta m
where	m.nr_sequencia = a.nr_seq_meta
and	nr_atendimento = nr_atendimento_p
and	ie_regra = 'E'
and	coalesce(m.ie_situacao,'A') = 'A'
and	coalesce(a.dt_finalizacao::text, '') = ''
and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and coalesce(a.dt_inativacao::text, '') = '';

select	count(*)
into STRICT	contador_ww
from	tof_meta_atend a,
	tof_meta m
where	m.nr_sequencia = a.nr_seq_meta
and	nr_atendimento = nr_atendimento_p
and	ie_regra = 'TEV'
and	coalesce(m.ie_situacao,'A') = 'A'
and	coalesce(a.dt_finalizacao::text, '') = ''
and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and coalesce(a.dt_inativacao::text, '') = '';

select	count(*)
into STRICT	contador_www
from	tof_meta_atend a,
	tof_meta m
where	m.nr_sequencia = a.nr_seq_meta
and	nr_atendimento = nr_atendimento_p
and	ie_regra = 'I'
and	coalesce(m.ie_situacao,'A') = 'A'
and	coalesce(a.dt_finalizacao::text, '') = ''
and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and coalesce(a.dt_inativacao::text, '') = '';

select	count(*)
into STRICT	contador_wwww
from	tof_meta_atend a,
	tof_meta m
where	m.nr_sequencia = a.nr_seq_meta
and	nr_atendimento = nr_atendimento_p
and	ie_regra = 'ESC'
and	coalesce(m.ie_situacao,'A') = 'A'
and	coalesce(a.dt_finalizacao::text, '') = ''
and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and coalesce(a.dt_inativacao::text, '') = '';

select	count(*)
into STRICT	contador_wwwww
from	tof_meta_atend a,
	tof_meta m
where	m.nr_sequencia = a.nr_seq_meta
and	nr_atendimento = nr_atendimento_p
and	ie_regra = 'P'
and	coalesce(m.ie_situacao,'A') = 'A'
and	coalesce(a.dt_finalizacao::text, '') = ''
and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and coalesce(a.dt_inativacao::text, '') = '';


if (contador_w > 0) then
	begin
		CALL tof_verificar_meta_eventos(nr_atendimento_p, nm_usuario_p, cd_estabelecimento_p, dt_evento_p, 'S');
	end;
end if;

if (contador_ww > 0) then
	begin
		CALL tof_verificar_meta_tev(nr_atendimento_p, nm_usuario_p, dt_evento_p, 'S');
	end;
end if;


if (contador_www > 0) then
	begin
		CALL tof_verificar_meta_job_interv(nr_atendimento_p, nm_usuario_p, cd_estabelecimento_p, dt_evento_p, 'S');
	end;
end if;

if (contador_wwww > 0) then
	begin
		CALL tof_verificar_meta_escalas(nr_atendimento_p, nm_usuario_p, cd_estabelecimento_p, dt_evento_p, 'S');
	end;
end if;

if (contador_wwwww > 0) then
	begin
		CALL tof_verificar_meta_alta(nr_atendimento_p, nm_usuario_p, cd_estabelecimento_p, dt_evento_p, 'S');
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tof_atingimento_meta_finalizar ( cd_estabelecimento_p text, nm_usuario_p text, dt_evento_p timestamp, nr_atendimento_p bigint) FROM PUBLIC;

