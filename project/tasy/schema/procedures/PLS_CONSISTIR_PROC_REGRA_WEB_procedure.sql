-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consistir_proc_regra_web ( nr_seq_guia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_procedimento_w 	bigint;
ie_origem_proced_w	bigint;
qt_registros_w		bigint;
qt_proc_regra_w		bigint := 0;

c010 CURSOR FOR 
	SELECT	cd_procedimento, 
		ie_origem_proced 
	from	pls_guia_plano_proc 
	where	nr_seq_guia = nr_seq_guia_p;


BEGIN 
	select	coalesce(count(*),0) 
	into STRICT	qt_registros_w 
	from	pls_guia_plano_proc 
	where	nr_seq_guia = nr_seq_guia_p 
	and	ie_status not in ('S', 'N');
 
	if ( qt_registros_w = 0 ) then 
 
		open	c010;
		loop 
		fetch 	c010 into	cd_procedimento_w, 
					ie_origem_proced_w;
		EXIT WHEN NOT FOUND; /* apply on c010 */
 
		/* Procura pelo procedimento */
 
		select	coalesce(count(*), 0) 
		into STRICT	qt_registros_w 
		from	pls_regra_liberacao 
		where	cd_procedimento = cd_procedimento_w 
		and	cd_estabelecimento	= cd_estabelecimento_p 
		and	ie_origem_proced = ie_origem_proced_w 
		and	ie_status = 'S';
 
		/* Se não encontrou pelo procedimento, procura pelo grupo */
 
		if ( qt_registros_w = 0) then 
 
			select	coalesce(count(*), 0) 
			into STRICT	qt_registros_w 
			from	pls_regra_liberacao 
			where	cd_grupo_proc = obter_grupo_procedimento(cd_procedimento_w, ie_origem_proced_w, 'C') 
			and	cd_estabelecimento	= cd_estabelecimento_p 
			and	ie_status = 'S';
 
			/* Se não encontrou pelo grupo, procura pela especialidade */
 
			if ( qt_registros_w = 0 ) then 
 
				select	coalesce(count(*), 0) 
				into STRICT	qt_registros_w 
				from	pls_regra_liberacao 
				where	cd_especialidade = obter_especialidade_proced(cd_procedimento_w, ie_origem_proced_w) 
				and	cd_estabelecimento	= cd_estabelecimento_p 
				and	ie_status = 'S';
 
				/* Se não encontrou pela especialidade, procura pela área */
 
				if ( qt_registros_w = 0 ) then 
 
					select	coalesce(count(*), 0) 
					into STRICT	qt_registros_w 
					from	pls_regra_liberacao 
					where	cd_area_procedimento = obter_area_procedimento(cd_procedimento_w, ie_origem_proced_w) 
					and	cd_estabelecimento	= cd_estabelecimento_p 
					and	ie_status = 'S';
					 
					/* Se não encontrou pela área, informa que não deve liberar esta guia */
 
					if ( qt_registros_w = 0) then 
						qt_proc_regra_w := qt_proc_regra_w + 1;
					end if;
 
				end if;
 
			end if;
 
		end if;
 
 
		end loop;
		close	c010;
	else 
		qt_proc_regra_w := 1;
	end if;
	 
	if (qt_proc_regra_w = 0) then 
		CALL pls_liberar_guia(nr_seq_guia_p, 0, 0, 'S', cd_estabelecimento_p, nm_usuario_p,null,null);
	end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consistir_proc_regra_web ( nr_seq_guia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

