-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dirf_registro_scp ( nr_seq_lote_p bigint, nm_usuario_p text) AS $body$
DECLARE

								
separador_w	varchar(1) := '|';
ds_arquivo_w	varchar(2000);
nr_seq_apres_w	w_dirf_arquivo.nr_seq_apresentacao%type := 999000;

c_reg_scp CURSOR FOR
	SELECT 	'SCP' ds_registro,
		e.cd_cgc cd_cgc,
		obter_nome_estabelecimento(e.cd_estabelecimento) nm_fantasia_estab
	from 	dirf_lote d,
		estabelecimento e
	where 	e.ie_scp = 'S'
	and 	e.cd_estab_socio_ost_scp = d.cd_estabelecimento
	and	d.ie_indicador_socio = '1'
	and	d.nr_sequencia = nr_seq_lote_p;

vetRegScp	c_reg_scp%RowType;


BEGIN
open c_reg_scp;
loop
fetch c_reg_scp into	
	vetRegScp;
EXIT WHEN NOT FOUND; /* apply on c_reg_scp */
	begin	
		
		ds_arquivo_w := substr(	vetRegScp.ds_registro || separador_w ||
					vetRegScp.cd_cgc || separador_w ||
					vetRegScp.nm_fantasia_estab || separador_w, 1, 2000);
								
		insert into	w_dirf_arquivo(nr_sequencia,
					 nm_usuario,
					 nm_usuario_nrec,
					 dt_atualizacao,
					 dt_atualizacao_nrec,
					 ds_arquivo,
					 nr_seq_apresentacao,
					 nr_seq_registro)
				values (nextval('w_dirf_arquivo_seq'),
					 nm_usuario_p,
					 nm_usuario_p,
					 clock_timestamp(),
					 clock_timestamp(),
					 ds_arquivo_w,
					 nr_seq_apres_w,
					 0);
		
		nr_seq_apres_w := nr_seq_apres_w + 1;
		
	end;
end loop;
close c_reg_scp;

commit;
								
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dirf_registro_scp ( nr_seq_lote_p bigint, nm_usuario_p text) FROM PUBLIC;

