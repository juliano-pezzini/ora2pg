-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inserir_mala_direta ( cd_pessoa_fisica_p text, nr_seq_contrato_p bigint, ds_tipo_pessoa_benef_p text, ds_tipo_destinatario_p text, nr_seq_segurado_p bigint, nr_seq_lote_carteira_p bigint, cd_cgc_p text, nr_seq_pagador_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_nascimento_p timestamp, nr_seq_lote_p bigint, nr_seq_lote_revisao_p bigint, ie_parametro_p text, nr_seq_lote_notif_p bigint, nr_seq_contato_p bigint, ie_considera_ender_prest_p text, nr_seq_intercambio_p bigint, nr_seq_tipo_compl_adic_p bigint) AS $body$
DECLARE


ds_endereco_w			varchar(255);
nr_telefone_w			varchar(15);
ie_end_correspond_w		smallint;
ie_end_correspond_ww		smallint;
ie_tipo_endereco_w		varchar(4);
qt_registro_w			integer	:= 0;
nr_seq_contrato_w		bigint;
nr_seq_pagador_w		bigint;
nr_telefone_celular_w		varchar(15);
cd_usuario_plano_w		varchar(20);
ie_parametro_w			varchar(1);
ds_compl_endereco_w		varchar(255);
nr_endereco_w			varchar(30);
ds_bairro_w			varchar(255);
cd_cep_w			varchar(15);
ds_municipio_w			varchar(255);
uf_estado_w			varchar(3);
qt_regras_corresp_w		bigint;
ie_insere_end_regra_benef_w	varchar(10)	:= 'N';
ds_email_w			varchar(255);
ds_email_contato_w		varchar(255);
nr_telefone_contato_w		varchar(15);
nr_seq_prestador_w		bigint;
qt_medico_w			bigint;
cd_pessoa_fisica_w		pls_prestador.cd_pessoa_fisica%type;
cd_cgc_w			pls_prestador.cd_cgc%type;
nr_seq_compl_adic_w		pls_prestador.nr_seq_compl_pf_tel_adic%type;
nr_seq_tipo_compl_adic_w	pls_prestador.nr_seq_tipo_compl_adic%type;
cd_municipio_ibge_w		pessoa_fisica.cd_municipio_ibge%type;
ds_irrelevante_w		varchar(4000);
ie_situacao_atend_w		pls_segurado.ie_situacao_atend%type;

BEGIN

if (coalesce(nr_seq_segurado_p,0) > 0) then
	select	coalesce(nr_seq_contrato_p, nr_seq_contrato),
		coalesce(nr_seq_pagador_p, nr_seq_pagador),
		ie_situacao_atend
	into STRICT	nr_seq_contrato_w,
		nr_seq_pagador_w,
		ie_situacao_atend_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;
end if;

if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
	select	count(*)
	into STRICT	qt_registro_w
	from	pls_mala_direta
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p
	and	nm_usuario		= nm_usuario_p
	and	nr_seq_lote_pag		= nr_seq_lote_p;
	
	/*aaschlote 16/01/2012 - OS 403194*/

	if (coalesce(nr_seq_segurado_p,0) > 0) and
		((ds_tipo_destinatario_p = wheb_mensagem_pck.get_texto(250337)) or (ds_tipo_destinatario_p = 'Titular') or (ds_tipo_destinatario_p = 'Dependentes')) then
		select	count(*)
		into STRICT	qt_regras_corresp_w
		from	pls_segurado_end_corresp
		where	nr_seq_segurado	= nr_seq_segurado_p;
		
		if (qt_regras_corresp_w > 0) then
			ie_insere_end_regra_benef_w	:= 'S';
		else
			if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then
				select	count(*)
				into STRICT	qt_regras_corresp_w
				from	pls_segurado_end_corresp
				where	nr_seq_contrato	= nr_seq_contrato_w;
			
				if (qt_regras_corresp_w > 0) then
					ie_insere_end_regra_benef_w	:= 'S';
				end if;
			end if;
		end if;
	end if;

	select	max(nr_sequencia)
	into STRICT	nr_seq_prestador_w
	from	pls_prestador
	where	cd_pessoa_fisica = cd_pessoa_fisica_p;
	
	if (nr_seq_prestador_w IS NOT NULL AND nr_seq_prestador_w::text <> '') and (ie_considera_ender_prest_p = 'S') then
		ds_endereco_w		:= substr(pls_obter_dados_prest_end(nr_seq_prestador_w, '', null,'R'),1,255);
		ds_compl_endereco_w	:= substr(pls_obter_dados_prest_end(nr_seq_prestador_w, '', null,'COMP'),1,255);
		nr_endereco_w		:= substr(pls_obter_dados_prest_end(nr_seq_prestador_w, '', null,'NE'),1,255);
		ds_bairro_w		:= substr(pls_obter_dados_prest_end(nr_seq_prestador_w, '', null,'B'),1,255);
		cd_cep_w		:= substr(pls_obter_dados_prest_end(nr_seq_prestador_w, '', null,'CEP'),1,255);
		ds_municipio_w		:= substr(pls_obter_dados_prest_end(nr_seq_prestador_w, '', null,'DMI'),1,255);
		uf_estado_w		:= substr(pls_obter_dados_prest_end(nr_seq_prestador_w, '', null,'ES'),1,3);
		nr_telefone_w		:= substr(pls_obter_dados_prest_end(nr_seq_prestador_w, '', null,'T'),1,255);
		nr_telefone_celular_w	:= '';
		ds_email_w		:= substr(pls_obter_dados_prest_end(nr_seq_prestador_w, '', null,'EM'),1,255);
	elsif (nr_seq_tipo_compl_adic_p IS NOT NULL AND nr_seq_tipo_compl_adic_p::text <> '') and (ie_considera_ender_prest_p = 'N') then
		SELECT * FROM pls_obter_dados_end_prestador(cd_pessoa_fisica_p, null, 'PFA', 'S', null, nr_seq_tipo_compl_adic_p, ds_endereco_w, nr_endereco_w, ds_compl_endereco_w, ds_bairro_w, cd_cep_w, nr_telefone_w, ds_email_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, cd_municipio_ibge_w, uf_estado_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w) INTO STRICT ds_endereco_w, nr_endereco_w, ds_compl_endereco_w, ds_bairro_w, cd_cep_w, nr_telefone_w, ds_email_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, cd_municipio_ibge_w, uf_estado_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w;
		
		if (cd_municipio_ibge_w IS NOT NULL AND cd_municipio_ibge_w::text <> '') then
			ds_municipio_w := obter_desc_municipio_ibge(cd_municipio_ibge_w);
		else
			ds_municipio_w := null;
		end if;		
	else
		select	coalesce(max(ie_endereco_correspondencia),1)
		into STRICT	ie_end_correspond_w
		from	pessoa_fisica
		where	cd_pessoa_fisica	= cd_pessoa_fisica_p;
			
		if (ie_parametro_p = 'S') and (ds_tipo_destinatario_p = 'Pagador') then
			ds_endereco_w		:= substr(pls_obter_end_pagador(nr_seq_pagador_p,'EN'),1,255);
			ds_compl_endereco_w	:= substr(pls_obter_end_pagador(nr_seq_pagador_p,'CO'),1,255);
			nr_endereco_w		:= substr(pls_obter_end_pagador(nr_seq_pagador_p,'NR'),1,255);
			ds_bairro_w		:= substr(pls_obter_end_pagador(nr_seq_pagador_p,'B'),1,255);
			cd_cep_w		:= substr(pls_obter_end_pagador(nr_seq_pagador_p,'CEP'),1,255);
			ds_municipio_w		:= substr(pls_obter_end_pagador(nr_seq_pagador_p,'DM'),1,255);
			uf_estado_w		:= substr(pls_obter_end_pagador(nr_seq_pagador_p,'UF'),1,3);
			nr_telefone_w		:= substr(pls_obter_end_pagador(nr_seq_pagador_p,'T'),1,15);
			nr_telefone_celular_w 	:= substr(pls_obter_end_pagador(nr_seq_pagador_p,'CEL'),1,15);
			ds_email_w		:= substr(pls_obter_end_pagador(nr_seq_pagador_p,'M'),1,255);
		elsif (ie_insere_end_regra_benef_w = 'S') then
			ds_endereco_w		:= substr(pls_obter_regra_endereco_benef(nr_seq_segurado_p,'EN'),1,255);
			ds_compl_endereco_w	:= substr(pls_obter_regra_endereco_benef(nr_seq_segurado_p,'CO'),1,255);
			nr_endereco_w		:= substr(pls_obter_regra_endereco_benef(nr_seq_segurado_p,'NR'),1,255);
			ds_bairro_w		:= substr(pls_obter_regra_endereco_benef(nr_seq_segurado_p,'B'),1,255);
			cd_cep_w		:= substr(pls_obter_regra_endereco_benef(nr_seq_segurado_p,'CEP'),1,255);
			ds_municipio_w		:= substr(pls_obter_regra_endereco_benef(nr_seq_segurado_p,'DM'),1,255);
			uf_estado_w		:= substr(pls_obter_regra_endereco_benef(nr_seq_segurado_p,'UF'),1,3);
			nr_telefone_w		:= substr(pls_obter_regra_endereco_benef(nr_seq_segurado_p,'T'),1,15);
			nr_telefone_celular_w 	:= substr(pls_obter_regra_endereco_benef(nr_seq_segurado_p,'CEL'),1,15);
			ds_email_w		:= substr(pls_obter_regra_endereco_benef(nr_seq_segurado_p,'M'),1,255);
		else
	
			ds_endereco_w		:= substr(obter_compl_pf(cd_pessoa_fisica_p, ie_end_correspond_w, 'EN'),1,255);
			ds_compl_endereco_w	:= substr(obter_compl_pf(cd_pessoa_fisica_p, ie_end_correspond_w,'CO'),1,255);
			nr_endereco_w		:= substr(obter_compl_pf(cd_pessoa_fisica_p, ie_end_correspond_w,'NR'),1,255);
			ds_bairro_w		:= substr(obter_compl_pf(cd_pessoa_fisica_p, ie_end_correspond_w,'B'),1,255);
			cd_cep_w		:= substr(obter_compl_pf(cd_pessoa_fisica_p, ie_end_correspond_w,'CEP'),1,255);
			ds_municipio_w		:= substr(obter_compl_pf(cd_pessoa_fisica_p, ie_end_correspond_w,'DM'),1,255);
			uf_estado_w		:= substr(obter_compl_pf(cd_pessoa_fisica_p, ie_end_correspond_w,'UF'),1,3);
			nr_telefone_w		:= substr(obter_compl_pf(cd_pessoa_fisica_p, ie_end_correspond_w, 'T'),1,15);
			nr_telefone_celular_w 	:= substr(obter_dados_pf(cd_pessoa_fisica_p, 'TC'),1,15);
			ds_email_w		:= substr(obter_compl_pf(cd_pessoa_fisica_p, ie_end_correspond_w, 'M'),1,255);
		end if;	
	end if;
	
	if (nr_seq_contato_p IS NOT NULL AND nr_seq_contato_p::text <> '') then
		nr_seq_contrato_w	:= nr_seq_contrato_p;
		
		begin
		select	ds_email,
			nr_telefone
		into STRICT	ds_email_contato_w,
			nr_telefone_contato_w
		from	pls_contrato_contato
		where	nr_sequencia = nr_seq_contato_p;
		exception
		when others then
			ds_email_contato_w	:= null;
			nr_telefone_contato_w	:= null;
		end;
		
		ds_email_w	:= coalesce(ds_email_contato_w, ds_email_w);
		nr_telefone_w	:= coalesce(nr_telefone_contato_w, nr_telefone_w);
	end if;	
elsif (cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '') then
	select	count(*)
	into STRICT	qt_registro_w
	from	pls_mala_direta
	where	cd_cgc		= cd_cgc_p
	and	nm_usuario	= nm_usuario_p
	and	nr_seq_lote_pag		= nr_seq_lote_p;
	
	select	max(nr_sequencia)
	into STRICT	nr_seq_prestador_w
	from	pls_prestador
	where	cd_cgc	= cd_cgc_p;
	
	if (nr_seq_prestador_w IS NOT NULL AND nr_seq_prestador_w::text <> '') and (ie_considera_ender_prest_p = 'S') then
		ds_endereco_w		:= substr(pls_obter_dados_prest_end(nr_seq_prestador_w, '', null,'R'),1,255);
		ds_compl_endereco_w	:= substr(pls_obter_dados_prest_end(nr_seq_prestador_w, '', null,'COMP'),1,255);
		nr_endereco_w		:= substr(pls_obter_dados_prest_end(nr_seq_prestador_w, '', null,'NE'),1,255);
		ds_bairro_w		:= substr(pls_obter_dados_prest_end(nr_seq_prestador_w, '', null,'B'),1,255);
		cd_cep_w		:= substr(pls_obter_dados_prest_end(nr_seq_prestador_w, '', null,'CEP'),1,255);
		ds_municipio_w		:= substr(pls_obter_dados_prest_end(nr_seq_prestador_w, '', null,'DMI'),1,255);
		uf_estado_w		:= substr(pls_obter_dados_prest_end(nr_seq_prestador_w, '', null,'ES'),1,3);
		nr_telefone_w		:= substr(pls_obter_dados_prest_end(nr_seq_prestador_w, '', null,'T'),1,255);
		nr_telefone_celular_w	:= '';
		ds_email_w		:= substr(pls_obter_dados_prest_end(nr_seq_prestador_w, '', null,'EM'),1,255);
		
		if (cd_municipio_ibge_w IS NOT NULL AND cd_municipio_ibge_w::text <> '') then
			ds_municipio_w := obter_desc_municipio_ibge(cd_municipio_ibge_w);
		else
			ds_municipio_w := null;
		end if;
	elsif (nr_seq_tipo_compl_adic_p IS NOT NULL AND nr_seq_tipo_compl_adic_p::text <> '') and (ie_considera_ender_prest_p = 'N') then	
		SELECT * FROM pls_obter_dados_end_prestador(null, cd_cgc_p, ie_tipo_endereco_w, 'S', nr_seq_compl_adic_w, nr_seq_tipo_compl_adic_p, ds_endereco_w, nr_endereco_w, ds_compl_endereco_w, ds_bairro_w, cd_cep_w, nr_telefone_w, ds_email_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, cd_municipio_ibge_w, uf_estado_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w) INTO STRICT ds_endereco_w, nr_endereco_w, ds_compl_endereco_w, ds_bairro_w, cd_cep_w, nr_telefone_w, ds_email_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, cd_municipio_ibge_w, uf_estado_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w, ds_irrelevante_w;
	
	else
		select	coalesce(max(ie_endereco_correspondencia),0)
		into STRICT	ie_end_correspond_w
		from	pessoa_juridica_estab
		where	cd_cgc			= cd_cgc_p
		and	cd_estabelecimento	= cd_estabelecimento_p;
		
		if (ie_parametro_p = 'S') and (ds_tipo_destinatario_p = 'Pagador') then
			ds_endereco_w		:= substr(pls_obter_end_pagador(nr_seq_pagador_p,'EN'),1,255);
			ds_compl_endereco_w	:= substr(pls_obter_end_pagador(nr_seq_pagador_p,'CO'),1,255);
			nr_endereco_w		:= substr(replace(pls_obter_end_pagador(nr_seq_pagador_p,'NR'),'N/D',''),1,255);
			ds_bairro_w		:= substr(pls_obter_end_pagador(nr_seq_pagador_p,'B'),1,255);
			cd_cep_w		:= substr(pls_obter_end_pagador(nr_seq_pagador_p,'CEP'),1,255);
			ds_municipio_w		:= substr(pls_obter_end_pagador(nr_seq_pagador_p,'CI'),1,255);
			uf_estado_w		:= substr(pls_obter_end_pagador(nr_seq_pagador_p,'UF'),1,3);
			nr_telefone_w		:= substr(pls_obter_end_pagador(nr_seq_pagador_p,'T'),1,15);
			nr_telefone_celular_w 	:= substr(pls_obter_end_pagador(nr_seq_pagador_p,'CEL'),1,15);
			ds_email_w		:= substr(pls_obter_end_pagador(nr_seq_pagador_p,'M'),1,255);
		elsif (ie_end_correspond_w	= 0) then		
			ds_endereco_w		:= substr(obter_dados_pf_pj(null, cd_cgc_p, 'EN'),1,255);
			ds_compl_endereco_w	:= substr(obter_dados_pf_pj(null,cd_cgc_p,'CO'),1,255);
			begin
			nr_endereco_w		:= substr(replace(obter_dados_pf_pj(null,cd_cgc_p,'NR'),'N/D',''),1,255);
			exception
			when others then
				nr_endereco_w	:= '';
			end;
			ds_bairro_w		:= substr(obter_dados_pf_pj(null,cd_cgc_p,'B'),1,255);
			cd_cep_w		:= substr(obter_dados_pf_pj(null,cd_cgc_p,'CEP'),1,255);
			ds_municipio_w		:= substr(obter_dados_pf_pj(null,cd_cgc_p,'CI'),1,255);
			uf_estado_w		:= substr(obter_dados_pf_pj(null,cd_cgc_p,'UF'),1,3);
			nr_telefone_w		:= substr(obter_dados_pf_pj(null, cd_cgc_p, 'T'),1,15);
			nr_telefone_celular_w	:= substr(obter_dados_pf_pj(null, cd_cgc_p, 'CEL'),1,15);
			ds_email_w		:= substr(obter_dados_pf_pj_estab(cd_estabelecimento_p,null, cd_cgc_p, 'M'),1,255);
		else
			ds_endereco_w		:= substr(obter_compl_pj(cd_cgc_p, ie_end_correspond_w, 'E'),1,255);
			ds_compl_endereco_w	:= substr(obter_compl_pj(cd_cgc_p, ie_end_correspond_w,'CO'),1,255);
			nr_endereco_w		:= substr(replace(obter_compl_pj(cd_cgc_p, ie_end_correspond_w,'NR'),'N/D',''),1,255);
			ds_bairro_w		:= substr(obter_compl_pj(cd_cgc_p, ie_end_correspond_w,'B'),1,255);
			cd_cep_w		:= substr(obter_compl_pj(cd_cgc_p, ie_end_correspond_w,'CEP'),1,255);
			ds_municipio_w		:= substr(obter_compl_pj(cd_cgc_p, ie_end_correspond_w,'CI'),1,255);
			uf_estado_w		:= substr(obter_compl_pj(cd_cgc_p, ie_end_correspond_w,'UF'),1,3);
			nr_telefone_w		:= substr(obter_compl_pj(cd_cgc_p, ie_end_correspond_w, 'T'),1,15);
			nr_telefone_celular_w	:= substr(obter_compl_pj(cd_cgc_p, ie_end_correspond_w, 'CEL'),1,15);
			ds_email_w		:= substr(obter_compl_pj(cd_cgc_p, ie_end_correspond_w, 'M'),1,255);
		end if;
	end if;
end if;

uf_estado_w	:= replace(uf_estado_w,'N/D','');

if (qt_registro_w	= 0) then
	begin
	
	begin
	select	cd_usuario_plano
	into STRICT	cd_usuario_plano_w
	from  	pls_segurado_carteira
	where	nr_seq_segurado		= nr_seq_segurado_p;
	exception
	when others then
		cd_usuario_plano_w	:= null;
	end;
	
	insert into pls_mala_direta(nr_sequencia, cd_pessoa_fisica, dt_atualizacao,
		nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
		nr_seq_contrato, ds_tipo_pessoa_benef, ds_tipo_destinatario,
		nr_seq_segurado, nr_seq_lote_carteira, cd_cgc,
		nr_seq_pagador, ds_endereco, nr_telefone,
		nr_telefone_celular,dt_nascimento,nr_seq_lote_pag, nr_seq_lote_revisao,
		cd_usuario_plano,nr_endereco,ds_complemento_endereco,ds_bairro,
		cd_cep,ds_municipio,uf_estado, nr_seq_lote_notif, ds_email, nr_seq_intercambio,
		ie_situacao_atend)
	values (nextval('pls_mala_direta_seq'), cd_pessoa_fisica_p, clock_timestamp(),
		nm_usuario_p, clock_timestamp(), nm_usuario_p,
		nr_seq_contrato_w, ds_tipo_pessoa_benef_p, ds_tipo_destinatario_p,
		nr_seq_segurado_p, nr_seq_lote_carteira_p, cd_cgc_p,
		nr_seq_pagador_w, ds_endereco_w, nr_telefone_w,
		nr_telefone_celular_w,dt_nascimento_p, nr_seq_lote_p, nr_seq_lote_revisao_p,
		cd_usuario_plano_w,nr_endereco_w,ds_compl_endereco_w,ds_bairro_w,
		cd_cep_w,ds_municipio_w,uf_estado_w,
		nr_seq_lote_notif_p, ds_email_w, nr_seq_intercambio_p,
		ie_situacao_atend_w);
	exception
		when others then
		null;
		/*insert into log_tasy(dt_atualizacao, nm_usuario, cd_log, ds_log)
		values(sysdate, nm_usuario_p, 6000, nm_usuario_p || ' - ' || cd_pessoa_fisica_p || ' - ' || nr_seq_contrato_p || ' - ' || 
		ds_tipo_pessoa_benef_p || ' - ' || ds_tipo_destinatario_p || ' - ' || nr_seq_lote_carteira_p || ' - ' || nr_seq_segurado_p || ' - ' ||
		cd_cgc_p);*/
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inserir_mala_direta ( cd_pessoa_fisica_p text, nr_seq_contrato_p bigint, ds_tipo_pessoa_benef_p text, ds_tipo_destinatario_p text, nr_seq_segurado_p bigint, nr_seq_lote_carteira_p bigint, cd_cgc_p text, nr_seq_pagador_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_nascimento_p timestamp, nr_seq_lote_p bigint, nr_seq_lote_revisao_p bigint, ie_parametro_p text, nr_seq_lote_notif_p bigint, nr_seq_contato_p bigint, ie_considera_ender_prest_p text, nr_seq_intercambio_p bigint, nr_seq_tipo_compl_adic_p bigint) FROM PUBLIC;

