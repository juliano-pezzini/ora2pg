-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_rateio_sh_aux_valor ( nr_interno_conta_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
nr_sequencia_w		bigint;
nr_interno_conta_w	bigint;
cd_item_w		bigint;
ie_origem_proced_w	bigint;
vl_preco_w		double precision;
vl_receita_w		double precision;
qt_item_w		double precision;
nr_seq_propaci_w	bigint;
nr_seq_matpaci_w	bigint;

cd_estabelecimento_w	smallint;
cd_setor_atendimento_w	integer;
cd_setor_atend_ant_w	integer;
cd_item_ant_w		bigint;
dt_item_w		timestamp;

vl_fixo_w		double precision;
cd_convenio_w		integer;
cd_categoria_w		integer;

 
C01 CURSOR FOR 
	SELECT	a.nr_sequencia, 
		a.cd_item, 
		a.qt_item, 
		a.nr_seq_matpaci, 
		a.dt_item, 
		a.cd_setor_atendimento 
	from	w_conta_sus_sh a 
	where	a.nr_interno_conta	= nr_interno_conta_p 
	and	(a.nr_seq_matpaci IS NOT NULL AND a.nr_seq_matpaci::text <> '') 
	order by 
		a.cd_item, 
		a.cd_setor_atendimento;

 
C02 CURSOR FOR 
	SELECT	a.nr_sequencia, 
		a.cd_item, 
		a.qt_item, 
		a.nr_seq_propaci, 
		a.dt_item, 
		a.cd_setor_atendimento, 
		a.ie_origem_proced 
	from	w_conta_sus_sh a 
	where	a.nr_interno_conta	= nr_interno_conta_p 
	and	(a.nr_seq_propaci IS NOT NULL AND a.nr_seq_propaci::text <> '') 
	order by 
		a.cd_item, 
		a.cd_setor_atendimento;

 
 
 

BEGIN 
 
/* Obter estabelecimento da conta paciente */
 
select	cd_estabelecimento 
into STRICT	cd_estabelecimento_w 
from	conta_paciente 
where	nr_interno_conta	= nr_interno_conta_p;
 
/* Atualizar dados matmed */
 
cd_setor_atend_ant_w	:= 0;
cd_item_ant_w		:= 0;
 
OPEN C01;
LOOP 
FETCH 	C01 into 
	nr_sequencia_w, 
	cd_item_w, 
	qt_item_w, 
	nr_seq_matpaci_w, 
	dt_item_w, 
	cd_setor_atendimento_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	BEGIN 
 
	if (cd_setor_atendimento_w <> cd_setor_atend_ant_w) or (cd_item_w		<> cd_item_ant_w)	then 
		begin 
		cd_setor_atend_ant_w	:= cd_setor_atendimento_w;
		cd_item_ant_w		:= cd_item_w;
		SELECT * FROM SUS_OBTER_REGRA_RATEIO_SH(cd_estabelecimento_w, cd_item_w, null, null, cd_setor_atendimento_w, cd_convenio_w, cd_categoria_w, vl_fixo_w) INTO STRICT cd_convenio_w, cd_categoria_w, vl_fixo_w;
		if (coalesce(vl_fixo_w::text, '') = '') or (vl_fixo_w	= '') then 
			select	Obter_Preco_Material(cd_estabelecimento_w,cd_convenio_w,cd_categoria_w,dt_item_w, 
					cd_item_w,0,0,cd_setor_atendimento_w,null,0,0) 
			into STRICT	vl_fixo_w 
			;
		end if;
		end;
	end if;
 
	if (vl_fixo_w	> 0) then 
		begin 
		update 	w_conta_sus_sh 
		set	vl_preco = (vl_fixo_w * qt_item_w) 
		where	nr_sequencia	= nr_sequencia_w;
		end;
	end if;
	END;
END LOOP;
CLOSE C01;
 
 
/* Atualizar dados propaci */
 
cd_setor_atend_ant_w	:= 0;
cd_item_ant_w		:= 0;
 
OPEN C02;
LOOP 
FETCH 	C02 into 
	nr_sequencia_w, 
	cd_item_w, 
	qt_item_w, 
	nr_seq_propaci_w, 
	dt_item_w, 
	cd_setor_atendimento_w, 
	ie_origem_proced_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
	BEGIN 
 
	if (cd_setor_atendimento_w <> cd_setor_atend_ant_w) or (cd_item_w		<> cd_item_ant_w)	then 
		begin 
		cd_setor_atend_ant_w	:= cd_setor_atendimento_w;
		cd_item_ant_w		:= cd_item_w;
		SELECT * FROM SUS_OBTER_REGRA_RATEIO_SH(cd_estabelecimento_w, null, cd_item_w, ie_origem_proced_w, cd_setor_atendimento_w, cd_convenio_w, cd_categoria_w, vl_fixo_w) INTO STRICT cd_convenio_w, cd_categoria_w, vl_fixo_w;
		if (coalesce(vl_fixo_w::text, '') = '') or (vl_fixo_w	= '') then 
			select	obter_preco_procedimento(cd_estabelecimento_w,cd_convenio_w,cd_categoria_w,dt_item_w, 
				cd_item_w,ie_origem_proced_w,0,0,0,0,0,NULL,NULL,NULL,NULL,'P') 
			into STRICT	vl_fixo_w 
			;
		end if;
		end;
	end if;
 
	if (vl_fixo_w	> 0) then 
		begin 
		update 	w_conta_sus_sh 
		set	vl_preco = (vl_fixo_w * qt_item_w) 
		where	nr_sequencia	= nr_sequencia_w;
		end;
	end if;
	END;
END LOOP;
CLOSE C02;
 
 
commit;
 
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_rateio_sh_aux_valor ( nr_interno_conta_p bigint, nm_usuario_p text) FROM PUBLIC;

