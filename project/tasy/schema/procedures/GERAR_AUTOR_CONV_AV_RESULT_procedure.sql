-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_autor_conv_av_result (nr_seq_avaliacao_p bigint) AS $body$
DECLARE


ie_gerar_autor_aval_w varchar(2);
nr_sequencia_w autorizacao_convenio_aval.nr_sequencia%type;

  REG RECORD;

BEGIN
ie_gerar_autor_aval_w := obter_param_usuario(281, 1605, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_gerar_autor_aval_w);

	if (coalesce(ie_gerar_autor_aval_w,'N') = 'S') and (Obter_Funcao_Ativa = 281) Then
		begin
		
		select max(nr_sequencia) into STRICT nr_sequencia_w
		from autorizacao_convenio_aval 
		where nr_seq_med_aval_pac = nr_seq_avaliacao_p;

		delete from autorizacao_conv_av_result where nr_seq_autor_conv_aval = nr_sequencia_w;
		
		for REG IN (SELECT * FROM med_avaliacao_result WHERE nr_seq_avaliacao= nr_seq_avaliacao_p) loop
		 if (REG.nr_seq_item IS NOT NULL AND REG.nr_seq_item::text <> '') then
			begin
							
				insert into autorizacao_conv_av_result(nr_seq_item, dt_atualizacao, nm_usuario,
				qt_resultado, ds_resultado, nr_seq_autor_conv_aval, nm_usuario_nrec, dt_atualizacao_nrec) 
				values (REG.nr_seq_item, clock_timestamp(), wheb_usuario_pck.get_nm_usuario, REG.qt_resultado, REG.ds_resultado, 
				nr_sequencia_w, wheb_usuario_pck.get_nm_usuario, clock_timestamp());
			end;
		 end if;
		end loop;
		end;
	end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_autor_conv_av_result (nr_seq_avaliacao_p bigint) FROM PUBLIC;

