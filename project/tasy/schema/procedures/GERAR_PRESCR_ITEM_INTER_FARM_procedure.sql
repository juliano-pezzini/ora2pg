-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_prescr_item_inter_farm (nr_prescricao_p bigint, nr_seq_item_p bigint, ie_opcao_p text, ie_tipo_p text, cd_motivo_p bigint, ds_motivo_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint , nm_usuario_p text , nr_nova_prescricao_p INOUT bigint, nr_seq_novo_item_p INOUT bigint ) AS $body$
DECLARE


nr_prescricao_velha_w		bigint;
nr_seq_item_velha_w		integer;
nr_seq_item_w			integer;
nr_prescricao_nova_w		bigint;
nr_seq_item_nova_ww		integer:=0;
nr_seq_item_nova_w		integer:=0;
cd_prescritor_w			varchar(50);
varcalculavalidade_w		varchar(5);
varestenderprescricao_w		varchar(5);
nr_horas_validade_w		bigint;
ie_nova_prescricao_w		varchar(1):='S';
nr_atendimento_w		bigint;
nr_agrupamento_w		bigint;
nm_tabela_w			varchar(100);
varieexame_w			varchar(15);

nr_sequencia_w			bigint;
nr_sequencia_ww			bigint;
nr_seq_elemento_w		bigint;
cd_unidade_medida_w		varchar(30);
qt_elem_kg_dia_w		bigint;
qt_diaria_w			bigint;
pr_total_w			integer;
qt_kcal_w			integer;
ie_prim_fase_w			varchar(1);
ie_seg_fase_w			varchar(1);
ie_terc_fase_w			varchar(1);
ie_quar_fase_w			varchar(1);
ie_npt_w			varchar(1);
qt_osmolaridade_w		bigint;
qt_protocolo_w			bigint;
ie_unid_med_w			varchar(15);
VarAjustaPrimHorPrescr_w	varchar(1);
ie_sem_aprazamento_w		varchar(2);
dt_primeiro_horario_w		timestamp;
ie_gera_evento_w		varchar(1);
ie_tipo_item_w			varchar(10);
cd_item_w			varchar(255);
nr_seq_alteracao_w		bigint;
cd_setor_atendimento_w		integer;
dt_prescricao_w			timestamp;
dt_prescricao_ww		timestamp;
nr_horas_valid_w		bigint;
ie_estendida_liberacao_w 	varchar(1);
ie_gerar_kit_nova_prescricao_w	varchar(1);
ieMotivoPrescricao_w		varchar(15);
qt_hora_intervalo_w			double precision;
dt_horario_w				timestamp;
DT_PROXIMA_DOSE_ORIG_W		timestamp;
nr_seq_anterior_w			integer;
ie_altera_dt_proxima_dose_w	varchar(2);
hr_prim_horario_w			varchar(5);
nr_prescricao_original_w	prescr_medica.nr_prescricao%type;
dt_proxima_dose_w			timestamp;
dt_inicio_prescr_w			timestamp;
cd_material_w				prescr_material.cd_material%type;
dt_validade_prescr_w		timestamp;
cd_intervalo_w				prescr_material.cd_intervalo%type;
qt_dia_prim_hor_w			bigint;
IE_VIA_APLICACAO_W			prescr_material.IE_VIA_APLICACAO%type;
ie_regra_disp_w				varchar(1);
qt_unitaria_w				double precision;
qt_material_w				double precision;
nr_ocorrencia_w				double precision;
qt_total_dispensar_w		double precision;
ie_origem_inf_w				varchar(1);
cd_unidade_medida_dose_w	varchar(30);
ie_se_necessario_w			varchar(30);
ds_erro_w					varchar(2000);
ie_acm_w					varchar(1);

c01 CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_elemento,
		cd_unidade_medida,
		qt_elem_kg_dia,
		qt_diaria,
		pr_total,
		qt_kcal,
		ie_prim_fase,
		ie_seg_fase,
		ie_terc_fase,
		ie_quar_fase,
		ie_npt,
		qt_osmolaridade,
		qt_protocolo,
		ie_unid_med
	from	nut_pac_elemento
	where	nr_seq_nut_pac = nr_seq_item_velha_w;

c02 CURSOR FOR
SELECT	b.nr_sequencia,
		obter_ocorrencia_intervalo(b.cd_intervalo,coalesce(a.nr_horas_validade,24),'H'),
		b.dt_proxima_dose,
		b.nr_sequencia_anterior,
		coalesce(b.nr_prescricao_anterior,b.nr_prescricao_original),
		b.cd_material,
		b.cd_intervalo,
		b.hr_prim_horario
from	prescr_material b,
		prescr_medica a
where	obter_se_interv_superior_24h(b.cd_intervalo,null) = 'S'
and		b.ie_agrupador = 1
and		a.nr_prescricao	= b.nr_prescricao
and		a.nr_prescricao	= nr_prescricao_p
and		b.nr_sequencia = nr_seq_item_nova_w;


BEGIN
/*
ie_opcao_p - M - Modificar
	 A - Acrescentar
*/
dt_prescricao_w := clock_timestamp();

VarIEExame_w := Obter_Param_Usuario(924, 91, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, VarIEExame_w);
VarCalculaValidade_w := Obter_Param_Usuario(924, 98, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, VarCalculaValidade_w);
ie_sem_aprazamento_w := Obter_Param_Usuario(924, 141, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_sem_aprazamento_w);
VarEstenderPrescricao_w := Obter_Param_Usuario(924, 249, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, VarEstenderPrescricao_w);
VarAjustaPrimHorPrescr_w := Obter_Param_Usuario(7010, 79, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, VarAjustaPrimHorPrescr_w);
ie_gerar_kit_nova_prescricao_w := Obter_Param_Usuario(7010, 146, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_gerar_kit_nova_prescricao_w);

if (ie_opcao_p = 'M') then
	ieMotivoPrescricao_w := Obter_Param_Usuario(7010, 166, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ieMotivoPrescricao_w);
elsif (ie_opcao_p = 'A') then
	ieMotivoPrescricao_w := Obter_Param_Usuario(7010, 167, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ieMotivoPrescricao_w);
end if;	



nr_prescricao_velha_w 	:= nr_prescricao_p;
nr_seq_item_velha_w	:= nr_seq_item_p;

if (ie_sem_aprazamento_w = 'N') then
	ie_sem_aprazamento_w	:= 'S';
else
	ie_sem_aprazamento_w	:= 'N';
end if;


if (nr_prescricao_velha_w > 0) then

	if (ie_opcao_p = 'M') and (nr_seq_item_velha_w > 0) then
		CALL Suspender_item_Prescricao_GF(nr_prescricao_velha_w,nr_seq_item_velha_w,ie_tipo_p,cd_motivo_p,ds_motivo_p,cd_perfil_p,nm_usuario_p,cd_estabelecimento_p);
	end if;

	select	max(nr_atendimento),
		max(dt_inicio_prescr),
		max(dt_prescricao)
	into STRICT	nr_atendimento_w,
		dt_prescricao_ww,
			dt_prescricao_w
	from 	Prescr_medica
	where	nr_prescricao = nr_prescricao_velha_w;

	select	max(nr_prescricao)
	into STRICT  	nr_prescricao_nova_w
	from	Prescr_medica
	where	nr_prescr_interf_farm = nr_prescricao_velha_w
	and	coalesce(dt_liberacao_medico::text, '') = ''
	and	coalesce(dt_liberacao_farmacia::text, '') = ''
	and 	coalesce(dt_liberacao::text, '') = '';

	if (coalesce(nr_prescricao_nova_w::text, '') = '') then
		select 	nextval('prescr_medica_seq')
		into STRICT   	nr_prescricao_nova_w
		;
	else
		ie_nova_prescricao_w := 'N';
	end if;

	select	max(cd_pessoa_fisica)
	into STRICT	cd_prescritor_w
	from	usuario
	where	nm_usuario	= nm_usuario_p;

	select	CASE WHEN VarAjustaPrimHorPrescr_w='S' THEN Obter_Prim_Horario_Prescricao(nr_atendimento_w,cd_setor_atendimento,clock_timestamp(),nm_usuario_p,'R')  ELSE dt_primeiro_horario END
	into STRICT	dt_primeiro_horario_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_velha_w;

	--dt_prescricao_w := dt_prescricao_ww;
	if (ie_nova_prescricao_w = 'S') then
		insert into prescr_medica(
			nr_prescricao,
			cd_pessoa_fisica,
			nr_atendimento,
			cd_medico,
			dt_prescricao,
			dt_atualizacao,
			nm_usuario,
			nm_usuario_original,
			ds_observacao,
			nr_horas_validade,
			cd_motivo_baixa,
			dt_baixa,
			dt_primeiro_horario,
			dt_liberacao,
			dt_emissao_setor,
			dt_emissao_farmacia,
			cd_setor_atendimento,
			dt_entrada_unidade,
			ie_recem_nato,
			ie_origem_inf,
			nr_prescricao_anterior,
			nr_prescricao_mae,
			cd_protocolo,
			nr_seq_protocolo,
			nr_cirurgia,
			nr_seq_agenda,
			cd_estabelecimento,
			ds_medicacao_uso,
			cd_prescritor,
			qt_altura_cm,
			qt_peso,
			ie_adep,
			ie_prescr_emergencia,
			ie_prescricao_alta,
			ie_hemodialise,
			ie_motivo_prescricao,
			nr_prescricoes,
			nr_seq_transcricao,
			ie_prescr_farm,
			nr_prescr_interf_farm)
		SELECT	nr_prescricao_nova_w,
			cd_pessoa_fisica,
			CASE WHEN nr_atendimento_w=0 THEN null  ELSE nr_atendimento_w END ,
			cd_medico,
			dt_prescricao_w,
			clock_timestamp(),
			nm_usuario_p,
			nm_usuario_p,
			ds_observacao,
			coalesce(nr_horas_validade_w, nr_horas_validade),
			null,
			null,
			dt_primeiro_horario_w,
			null,
			null,
			null,
			cd_setor_atendimento,
			null,
			'N',
			ie_origem_inf,
			nr_prescricao_velha_w,
			nr_prescricao_mae,
			cd_protocolo,
			nr_seq_protocolo,
			nr_cirurgia,
			null,
			cd_estabelecimento,
			ds_medicacao_uso,
			coalesce(cd_prescritor_w, cd_prescritor),
			qt_altura_cm,
			qt_peso,
			ie_adep,
			'N',
			'N',
			ie_hemodialise,
			coalesce(ieMotivoPrescricao_w,ie_motivo_prescricao),
			nr_prescricoes,
			nr_seq_transcricao,
			'S',
			nr_prescricao_velha_w
		from	prescr_medica
		where	nr_prescricao = nr_prescricao_velha_w;

		if (VarCalculaValidade_w	= 'R') then
			select	max(cd_setor_atendimento)
			into STRICT	cd_setor_atendimento_w
			from	prescr_medica
			where	nr_prescricao	= nr_prescricao_velha_w;

			VarCalculaValidade_w	:= obter_se_calcula_validade(cd_setor_atendimento_w);
		end if;

		if (VarCalculaValidade_w	<> 'N') then
			select	max(obter_horas_validade_prescr(dt_primeiro_horario,nr_atendimento_w,VarEstenderPrescricao_w,'A',clock_timestamp(),nr_prescricao))
			into STRICT	nr_horas_validade_w
			from	prescr_medica
			where	nr_prescricao = nr_prescricao_nova_w;

			if (nr_horas_validade_w IS NOT NULL AND nr_horas_validade_w::text <> '') then
				update	prescr_medica
				set	nr_horas_validade 	= nr_horas_validade_w
				where	nr_prescricao 		= nr_prescricao_nova_w;
			end if;	
		end if;


		select 	max(ie_estendida_liberacao)
		into STRICT	ie_estendida_liberacao_w
		from	prescr_medica
		where	nr_prescricao	=	nr_prescricao_velha_w;

		select 	max(nr_horas_validade)
		into STRICT	nr_horas_valid_w
		from	prescr_medica
		where	nr_prescricao = nr_prescricao_nova_w;	

		if (ie_estendida_liberacao_w = 'S') and (nr_horas_valid_w < 24) then
			update	prescr_medica
			set	nr_horas_validade 	= nr_horas_valid_w + 24
			where	nr_prescricao 		= nr_prescricao_nova_w;
		end if;

		commit;
	end if;
	if (ie_opcao_p = 'M') then-- Modificar
		if (ie_tipo_p = 'M') then
			--Medicamento
			select	coalesce(max(nr_sequencia),0)+1
			into STRICT	nr_seq_item_nova_w
			from	prescr_material
			where	nr_prescricao 	= nr_prescricao_nova_w;

			nr_seq_item_nova_ww := nr_seq_item_nova_w;

			insert  into 	Prescr_Material(nr_prescricao,
							nr_sequencia,
							ie_origem_inf,
							cd_material,
							cd_unidade_medida,
							qt_dose,
							qt_unitaria,
							qt_material,
							dt_atualizacao,
							nm_usuario,
							cd_intervalo,
							ds_horarios,
							ds_observacao,
							ds_observacao_enf,
							ie_via_aplicacao,
							nr_agrupamento,
							ie_cobra_paciente,
							cd_motivo_baixa,
							dt_baixa,
							ie_utiliza_kit,
							cd_unidade_medida_dose,
							qt_conversao_dose,
							ie_urgencia,
							nr_ocorrencia,
							qt_total_dispensar,
							cd_fornec_consignado,
							nr_sequencia_solucao,
							nr_sequencia_proc,
							qt_solucao,
							hr_dose_especial,
							qt_dose_especial,
							ds_dose_diferenciada,
							ie_medicacao_paciente,
							nr_sequencia_diluicao,
							hr_prim_horario,
							nr_sequencia_dieta,
							ie_agrupador,
							nr_dia_util,
							ie_se_necessario,
							qt_min_aplicacao,
							ie_bomba_infusao,
							ie_aplic_bolus,
							ie_aplic_lenta,
							ie_acm,
							ie_objetivo,
							cd_topografia_cih,
							ie_origem_infeccao,
							cd_amostra_cih,
							cd_microorganismo_cih,
							ie_uso_antimicrobiano,
							cd_protocolo,
							nr_seq_protocolo,
							nr_seq_mat_protocolo,
							qt_hora_aplicacao,
							ie_recons_diluente_fixo,
							qt_vel_infusao,
							ds_justificativa,
							ie_sem_aprazamento,
							ie_indicacao,
							dt_proxima_dose,
							qt_total_dias_lib,
							nr_seq_substituto,
							ie_lado,
							dt_inicio_medic,
							qt_dia_prim_hor,
							ie_regra_disp,
							qt_vol_adic_reconst,
							qt_hora_intervalo,
							qt_min_intervalo,
							ie_permite_substituir,
							ie_dose_espec_agora,
							nr_seq_interf_farm,
							ie_suspenso,
							qt_dias_solicitado,
							nr_sequencia_anterior
							)
					SELECT  	nr_prescricao_nova_w,
							nr_seq_item_nova_w,
							a.ie_origem_inf,
							a.cd_material,
							a.cd_unidade_medida,
							a.qt_dose,
							a.qt_unitaria,
							a.qt_material,
							clock_timestamp(),
							nm_usuario_p,
							a.cd_intervalo,
							CASE WHEN ie_sem_aprazamento_w='S' THEN ''  ELSE a.ds_horarios END ,
							a.ds_observacao,
							a.ds_observacao_enf,
							a.ie_via_aplicacao,
							a.nr_agrupamento,
							coalesce(a.ie_cobra_paciente,'S'),
							CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.cd_motivo_baixa  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  0  ELSE a.cd_motivo_baixa END  END ,
							CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  clock_timestamp()  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  null  ELSE clock_timestamp() END  END ,
							a.ie_utiliza_kit,
							a.cd_unidade_medida_dose,
							a.qt_conversao_dose,
							coalesce(a.ie_urgencia,'N'),
							a.nr_ocorrencia,
							a.qt_total_dispensar,
							a.cd_fornec_consignado,
							null,
							null,
							a.qt_solucao,
							a.hr_dose_especial,
							a.qt_dose_especial,
							a.ds_dose_diferenciada,
							a.ie_medicacao_paciente,
							a.nr_sequencia_diluicao,
							CASE WHEN ie_sem_aprazamento_w='S' THEN ''  ELSE a.hr_prim_horario END ,
							null,
							a.ie_agrupador,
							a.nr_dia_util,
							a.ie_se_necessario,
							a.qt_min_aplicacao,
							a.ie_bomba_infusao,
							coalesce(a.ie_aplic_bolus,'N'),
							coalesce(a.ie_aplic_lenta,'N'),
							coalesce(a.ie_acm,'N'),
							a.ie_objetivo,
							a.cd_topografia_cih,
							a.ie_origem_infeccao,
							a.cd_amostra_cih,
							a.cd_microorganismo_cih,
							coalesce(a.ie_uso_antimicrobiano,'N'),
							a.cd_protocolo,
							a.nr_seq_protocolo,
							a.nr_seq_mat_protocolo,
							a.qt_hora_aplicacao,
							'N',
							a.qt_vel_infusao,
							a.ds_justificativa,
							ie_sem_aprazamento_w,
							a.ie_indicacao,
							a.dt_proxima_dose,
							a.qt_total_dias_lib,
							a.nr_seq_substituto,
							a.ie_lado,
							a.dt_inicio_medic,
							a.qt_dia_prim_hor,
							CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.ie_regra_disp  ELSE null END ,
							a.qt_vol_adic_reconst,
							a.qt_hora_intervalo,
							a.qt_min_intervalo,
							ie_permite_substituir,
							a.ie_dose_espec_agora,
							nr_seq_item_velha_w,
							'N',
							qt_dias_solicitado,
							a.nr_sequencia
					from	Material b,
						Prescr_Material a
					where	a.cd_material 	= b.cd_material
					and	a.nr_prescricao = nr_prescricao_velha_w
					and	a.nr_sequencia	= nr_seq_item_velha_w;

					CALL PLT_atualizar_ie_modificar(nr_prescricao_velha_w, nr_seq_item_velha_w, 'PRESCR_MATERIAL', 'S');


			select	max(nr_agrupamento)
			into STRICT	nr_agrupamento_w
			from	prescr_material a
			where	a.nr_prescricao = nr_prescricao_velha_w
			and	a.nr_sequencia	= nr_seq_item_velha_w;

			insert  into 	Prescr_Material(nr_prescricao,
							nr_sequencia,
							ie_origem_inf,
							cd_material,
							cd_unidade_medida,
							qt_dose,
							qt_unitaria,
							qt_material,
							dt_atualizacao,
							nm_usuario,
							cd_intervalo,
							ds_horarios,
							ds_observacao,
							ds_observacao_enf,
							ie_via_aplicacao,
							nr_agrupamento,
							ie_cobra_paciente,
							cd_motivo_baixa,
							dt_baixa,
							ie_utiliza_kit,
							cd_unidade_medida_dose,
							qt_conversao_dose,
							ie_urgencia,
							nr_ocorrencia,
							qt_total_dispensar,
							cd_fornec_consignado,
							nr_sequencia_solucao,
							nr_sequencia_proc,
							qt_solucao,
							hr_dose_especial,
							qt_dose_especial,
							ds_dose_diferenciada,
							ie_medicacao_paciente,
							nr_sequencia_diluicao,
							hr_prim_horario,
							nr_sequencia_dieta,
							ie_agrupador,
							nr_dia_util,
							ie_se_necessario,
							qt_min_aplicacao,
							ie_bomba_infusao,
							ie_aplic_bolus,
							ie_aplic_lenta,
							ie_acm,
							ie_objetivo,
							cd_topografia_cih,
							ie_origem_infeccao,
							cd_amostra_cih,
							cd_microorganismo_cih,
							ie_uso_antimicrobiano,
							cd_protocolo,
							nr_seq_protocolo,
							nr_seq_mat_protocolo,
							qt_hora_aplicacao,
							ie_recons_diluente_fixo,
							qt_vel_infusao,
							ds_justificativa,
							ie_sem_aprazamento,
							ie_indicacao,
							dt_proxima_dose,
							qt_total_dias_lib,
							nr_seq_substituto,
							ie_lado,
							dt_inicio_medic,
							qt_dia_prim_hor,
							ie_regra_disp,
							qt_vol_adic_reconst,
							qt_hora_intervalo,
							qt_min_intervalo,
							ie_permite_substituir,
							ie_dose_espec_agora,
							nr_seq_interf_farm,
							ie_suspenso)
					SELECT  	nr_prescricao_nova_w,
							nr_seq_item_nova_w+rownum,
							a.ie_origem_inf,
							a.cd_material,
							a.cd_unidade_medida,
							a.qt_dose,
							a.qt_unitaria,
							a.qt_material,
							clock_timestamp(),
							nm_usuario_p,
							cd_intervalo,
							CASE WHEN ie_sem_aprazamento_w='S' THEN ''  ELSE ds_horarios END ,
							a.ds_observacao,
							a.ds_observacao_enf,
							a.ie_via_aplicacao,
							a.nr_agrupamento,
							coalesce(a.ie_cobra_paciente,'S'),
							CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.cd_motivo_baixa  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  0  ELSE a.cd_motivo_baixa END  END ,
							CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  clock_timestamp()  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  null  ELSE clock_timestamp() END  END ,
							a.ie_utiliza_kit,
							cd_unidade_medida_dose,
							a.qt_conversao_dose,
							coalesce(ie_urgencia,'N'),
							a.nr_ocorrencia,
							a.qt_total_dispensar,
							a.cd_fornec_consignado,
							null,
							null,
							a.qt_solucao,
							hr_dose_especial,
							a.qt_dose_especial,
							ds_dose_diferenciada,
							a.ie_medicacao_paciente,
							a.nr_sequencia_diluicao,
							CASE WHEN ie_sem_aprazamento_w='S' THEN ''  ELSE a.hr_prim_horario END ,
							null,
							a.ie_agrupador,
							a.nr_dia_util,
							a.ie_se_necessario,
							a.qt_min_aplicacao,
							a.ie_bomba_infusao,
							coalesce(a.ie_aplic_bolus,'N'),
							coalesce(a.ie_aplic_lenta,'N'),
							coalesce(a.ie_acm,'N'),
							a.ie_objetivo,
							a.cd_topografia_cih,
							a.ie_origem_infeccao,
							a.cd_amostra_cih,
							a.cd_microorganismo_cih,
							coalesce(a.ie_uso_antimicrobiano,'N'),
							a.cd_protocolo,
							a.nr_seq_protocolo,
							a.nr_seq_mat_protocolo,
							a.qt_hora_aplicacao,
							'N',
							a.qt_vel_infusao,
							a.ds_justificativa,
							ie_sem_aprazamento_w,
							a.ie_indicacao,
							a.dt_proxima_dose,
							a.qt_total_dias_lib,
							a.nr_seq_substituto,
							a.ie_lado,
							a.dt_inicio_medic,
							a.qt_dia_prim_hor,
							CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.ie_regra_disp  ELSE null END ,
							a.qt_vol_adic_reconst,
							a.qt_hora_intervalo,
							a.qt_min_intervalo,
							ie_permite_substituir,
							ie_dose_espec_agora,
							a.nr_sequencia,
							'N'
					from		Material b,
							Prescr_Material a
					where		a.cd_material 	 = b.cd_material
					and		a.nr_prescricao  = nr_prescricao_velha_w
					and		a.nr_agrupamento = nr_agrupamento_w
					and		a.ie_agrupador	 = 1
					and		a.nr_sequencia	 <> nr_seq_item_velha_w;

			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_seq_item_nova_w
			from	prescr_material
			where	nr_prescricao 	= nr_prescricao_nova_w;

			insert  into 	Prescr_Material(nr_prescricao,
							nr_sequencia,
							ie_origem_inf,
							cd_material,
							cd_unidade_medida,
							qt_dose,
							qt_unitaria,
							qt_material,
							dt_atualizacao,
							nm_usuario,
							cd_intervalo,
							ds_horarios,
							ds_observacao,
							ds_observacao_enf,
							ie_via_aplicacao,
							nr_agrupamento,
							ie_cobra_paciente,
							cd_motivo_baixa,
							dt_baixa,
							ie_utiliza_kit,
							cd_unidade_medida_dose,
							qt_conversao_dose,
							ie_urgencia,
							nr_ocorrencia,
							qt_total_dispensar,
							cd_fornec_consignado,
							nr_sequencia_solucao,
							nr_sequencia_proc,
							qt_solucao,
							hr_dose_especial,
							qt_dose_especial,
							ds_dose_diferenciada,
							ie_medicacao_paciente,
							nr_sequencia_diluicao,
							hr_prim_horario,
							nr_sequencia_dieta,
							ie_agrupador,
							nr_dia_util,
							ie_se_necessario,
							qt_min_aplicacao,
							ie_bomba_infusao,
							ie_aplic_bolus,
							ie_aplic_lenta,
							ie_acm,
							ie_objetivo,
							cd_topografia_cih,
							ie_origem_infeccao,
							cd_amostra_cih,
							cd_microorganismo_cih,
							ie_uso_antimicrobiano,
							cd_protocolo,
							nr_seq_protocolo,
							nr_seq_mat_protocolo,
							qt_hora_aplicacao,
							ie_recons_diluente_fixo,
							qt_vel_infusao,
							ds_justificativa,
							ie_sem_aprazamento,
							ie_indicacao,
							dt_proxima_dose,
							qt_total_dias_lib,
							nr_seq_substituto,
							ie_lado,
							dt_inicio_medic,
							qt_dia_prim_hor,
							ie_regra_disp,
							qt_vol_adic_reconst,
							qt_hora_intervalo,
							qt_min_intervalo,
							ie_permite_substituir,
							ie_dose_espec_agora,
							nr_seq_interf_farm,
							ie_suspenso,
							nr_seq_mat_diluicao)
						SELECT  nr_prescricao_nova_w,
							nr_seq_item_nova_w + row_number() OVER () AS rownum,
							a.ie_origem_inf,
							a.cd_material,
							a.cd_unidade_medida,
							a.qt_dose,
							a.qt_unitaria,
							a.qt_material,
							clock_timestamp(),
							nm_usuario_p,
							cd_intervalo,
							CASE WHEN ie_sem_aprazamento_w='S' THEN ''  ELSE ds_horarios END ,
							a.ds_observacao,
							a.ds_observacao_enf,
							a.ie_via_aplicacao,
							a.nr_agrupamento,
							coalesce(a.ie_cobra_paciente,'S'),
							CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.cd_motivo_baixa  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  0  ELSE a.cd_motivo_baixa END  END ,
							CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  clock_timestamp()  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  null  ELSE clock_timestamp() END  END ,
							a.ie_utiliza_kit,
							cd_unidade_medida_dose,
							a.qt_conversao_dose,
							coalesce(ie_urgencia,'N'),
							a.nr_ocorrencia,
							a.qt_total_dispensar,
							a.cd_fornec_consignado,
							null,
							null,
							a.qt_solucao,
							hr_dose_especial,
							a.qt_dose_especial,
							ds_dose_diferenciada,
							a.ie_medicacao_paciente,
							nr_seq_item_nova_w,
							CASE WHEN ie_sem_aprazamento_w='S' THEN ''  ELSE a.hr_prim_horario END ,
							null,
							a.ie_agrupador,
							a.nr_dia_util,
							a.ie_se_necessario,
							a.qt_min_aplicacao,
							a.ie_bomba_infusao,
							coalesce(a.ie_aplic_bolus,'N'),
							coalesce(a.ie_aplic_lenta,'N'),
							coalesce(a.ie_acm,'N'),
							a.ie_objetivo,
							a.cd_topografia_cih,
							a.ie_origem_infeccao,
							a.cd_amostra_cih,
							a.cd_microorganismo_cih,
							coalesce(a.ie_uso_antimicrobiano,'N'),
							a.cd_protocolo,
							a.nr_seq_protocolo,
							a.nr_seq_mat_protocolo,
							a.qt_hora_aplicacao,
							'N',
							a.qt_vel_infusao,
							ds_justificativa,
							ie_sem_aprazamento_w,
							a.ie_indicacao,
							a.dt_proxima_dose,
							a.qt_total_dias_lib,
							a.nr_seq_substituto,
							a.ie_lado,
							a.dt_inicio_medic,
							a.qt_dia_prim_hor,
							CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.ie_regra_disp  ELSE null END ,
							a.qt_vol_adic_reconst,
							a.qt_hora_intervalo,
							a.qt_min_intervalo,
							ie_permite_substituir,
							ie_dose_espec_agora,
							nr_seq_item_velha_w,
							'N',
							nr_seq_mat_diluicao
						from	Material b,
							Prescr_Material a
						where	a.cd_material 	= b.cd_material
						and	a.nr_prescricao = nr_prescricao_velha_w
						and	a.ie_agrupador	in (3,7,9)
						and	a.nr_sequencia_diluicao	= nr_seq_item_velha_w;
		nm_tabela_w	:= 'PRESCR_MATERIAL';
		nr_seq_novo_item_p	:=	nr_seq_item_nova_ww;

		if (coalesce(ie_gerar_kit_nova_prescricao_w,'N') = 'S') then
			CALL Gerar_kit_Prescricao(cd_estabelecimento_p,nr_prescricao_nova_w,NULL,nm_usuario_p);	
		end if;

		end if;
		if (ie_tipo_p = 'R') then
			-- Recomendacao
			select	coalesce(max(nr_sequencia),0)+1
			into STRICT	nr_seq_item_nova_w
			from	prescr_recomendacao
			where	nr_prescricao = nr_prescricao_nova_w;

			insert	into	prescr_recomendacao(
					nr_prescricao,
					nr_sequencia,
					ie_destino_rec,
					dt_atualizacao,
					nm_usuario,
					qt_recomendacao,
					cd_intervalo,
					ds_horarios,
					cd_recomendacao,
					nr_seq_classif,
					hr_prim_horario,
					ds_observacao,
					ds_recomendacao,
					cd_perfil_ativo,
					cd_kit,
					nr_seq_interno,
					nr_seq_apres,
					nr_seq_interf_farm,
					ie_suspenso)
					SELECT	nr_prescricao_nova_w,
						nr_seq_item_nova_w,
						ie_destino_rec,
						clock_timestamp(),
						nm_usuario_p,
						qt_recomendacao,
						cd_intervalo,
						ds_horarios,
						cd_recomendacao,
						nr_seq_classif,
						hr_prim_horario,
						ds_observacao,
						ds_recomendacao,
						cd_perfil_p,
						cd_kit,
						nextval('prescr_recomendacao_seq'),
						nr_seq_apres,
						nr_seq_item_velha_w,
						'N'
					from	prescr_recomendacao
					where	nr_prescricao 	= nr_prescricao_velha_w
					and	nr_sequencia	= nr_seq_item_velha_w;
		nm_tabela_w	:= 'PRESCR_RECOMENDACAO';
		nr_seq_novo_item_p	:=	nr_seq_item_nova_w;
		end if;
		if (ie_tipo_p = 'G') then
			-- Gasoterapia
			select	nextval('prescr_gasoterapia_seq')
			into STRICT	nr_seq_item_nova_w
			;

			insert	into	prescr_gasoterapia(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					dt_prev_execucao,
					ie_inicio,
					ie_respiracao,
					cd_modalidade_vent,
					ie_disp_resp_esp,
					nr_seq_gas,
					cd_unidade_medida,
					qt_gasoterapia,
					cd_intervalo,
					ie_fluxo_acm,
					qt_limite_gas_min,
					qt_limite_gas_max,
					ds_observacao,
					nr_prescricao,
					qt_freq_vent,
					ie_modo_adm,
					ie_unidade_medida,
					cd_protocolo,
					nr_seq_protocolo,
					nr_seq_item_rotina,
					cd_perfil_ativo,
					qt_referencia,
					nr_seq_interf_farm,
					ie_suspenso)
					SELECT	nr_seq_item_nova_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						dt_prev_execucao,
						ie_inicio,
						ie_respiracao,
						cd_modalidade_vent,
						ie_disp_resp_esp,
						nr_seq_gas,
						cd_unidade_medida,
						qt_gasoterapia,
						cd_intervalo,
						ie_fluxo_acm,
						qt_limite_gas_min,
						qt_limite_gas_max,
						ds_observacao,
						nr_prescricao_nova_w,
						qt_freq_vent,
						ie_modo_adm,
						ie_unidade_medida,
						cd_protocolo,
						nr_seq_protocolo,
						nr_seq_item_rotina,
						cd_perfil_p,
						qt_referencia,
						nr_seq_item_velha_w,
						'N'
					from	prescr_gasoterapia
					where	nr_prescricao 	= nr_prescricao_velha_w
					and	nr_sequencia	= nr_seq_item_velha_w;
		nm_tabela_w	:= 'PRESCR_GASOTERAPIA';
		nr_seq_novo_item_p	:=	nr_seq_item_nova_w;
		end if;
		if (ie_tipo_p = 'P') then
			select	coalesce(max(nr_sequencia),0)+1
			into STRICT	nr_seq_item_nova_w
			from	prescr_procedimento
			where	nr_prescricao = nr_prescricao_nova_w;

			insert	into	prescr_procedimento(
					nr_prescricao,
					nr_sequencia,
					cd_procedimento,
					qt_procedimento,
					dt_atualizacao,
					nm_usuario,
					ds_horarios,
					ds_observacao,
					cd_motivo_baixa,
					dt_baixa,
					cd_procedimento_aih,
					ie_origem_proced,
					cd_intervalo,
					ie_urgencia,
					cd_setor_atendimento,
					dt_emissao_setor_atend,
					ds_dado_clinico,
					dt_prev_execucao,
					cd_material_exame,
					nr_seq_exame,
					ds_material_especial,
					ie_amostra,
					ie_status_atend,
					ie_origem_inf ,
					cd_setor_coleta ,
					cd_setor_entrega,
					ie_emite_mapa,
					dt_integracao,
					dt_resultado,
					ds_integracao ,
					ie_executar_leito,
					cd_medico_exec,
					nr_agrupamento,
					ie_se_necessario,
					ie_acm ,
					nr_ocorrencia,
					ie_externo,
					nr_seq_lote_externo,
					ds_rotina,
					ie_autorizacao,
					ie_status_execucao,
					nr_seq_interno,
					dt_lib_imagem,
					nr_seq_lab,
					nm_usuario_baixa_esp,
					nr_controle,
					dt_coleta,
					nr_seq_proc_interno,
					nr_seq_derivado,
					nr_seq_exame_sangue,
					nr_seq_solic_sangue,
					cd_unid_med_sangue,
					qt_peca_ap,
					ds_qualidade_peca_ap,
					ds_diag_provavel_ap,
					ds_exame_anterior_ap,
					cd_pessoa_coleta,
					ie_lado,
					ie_erro,
					nr_acesso_dicom,
					ie_avisar_result,
					cd_atividade_prof_bpa,
					ie_grupo_atend_bpa,
					ie_tipo_atend_bpa,
					nr_seq_contraste,
					cd_protocolo,
					nr_seq_protocolo,
					nr_seq_proc_protocolo,
					ds_resumo_clinico,
					ds_exame_fis_achado_cirur,
					dt_result_integracao,
					nr_seq_pq_proc ,
					dt_inicio_exame,
					nr_seq_recoleta ,
					nr_doc_convenio,
					cd_senha ,
					dt_antecipa_result ,
					cd_convenio ,
					cd_categoria ,
					qt_vol_hemocomp,
					qt_veloc_inf_hemo,
					qt_volume_adep,
					ie_status,
					dt_status,
					ie_cobra_paciente,
					nr_seq_topografia,
					ie_forma_infusao,
					nr_seq_prot_glic ,
					ie_porte,
					cd_tipo_cirurgia ,
					cd_setor_exec_inic,
					cd_setor_exec_fim,
					qt_volume_suspenso,
					nr_etapas_suspensa,
					ie_objetivo_onco,
					ie_respiracao,
					cd_mod_vent ,
					ie_disp_resp_esp,
					qt_fluxo_oxigenio,
					nr_seq_origem ,
					ds_observacao_enf,
					qt_hora_intervalo,
					qt_min_intervalo,
					ie_util_hemocomponente,
					dt_emissao_resultado,
					ds_cor_erro,
					nr_seq_motivo_antecipacao,
					nm_usuario_antecipacao,
					ds_observacao_antecipacao,
					ds_obs_recoleta ,
					nr_seq_lab_ext,
					nr_controle_exame,
					ie_exame_bloqueado,
					qt_min_oxigenio,
					cd_medico_solicitante,
					qt_fio2 ,
					qt_freq_vent,
					ie_unid_med_hemo,
					ie_funcao_medico,
					qt_etapa,
					dt_status_previsto,
					nr_seq_superior,
					cd_motivo_baixa_exame ,
					ds_observacao_coleta,
					cd_profissional,
					ds_observacao_canc_exame ,
					nr_seq_repeticao ,
					ie_aliquotado,
					ie_filtrado,
					ie_irradiado,
					ie_lavado,
					ie_via_acesso ,
					ie_tipo_proced ,
					cd_perfil_ativo ,
					dt_chamada_exame,
					nr_seq_regra_plano,
					nr_seq_proc_princ ,
					cd_cgc_laboratorio,
					nr_seq_frasco,
					dt_baixa_job,
					ds_localizacao_lesao,
					ds_tempo_doenca,
					ie_controle_envelope,
					nr_seq_status_pato,
					ie_prioridade,
					nr_seq_prioridade,
					ie_proced_bloqueado ,
					ds_observacao_bloqueio,
					ds_cor_selecao ,
					nr_seq_cor_erro,
					ie_exige_liberacao,
					cd_tipo_recomendacao,
					ie_imagem_pacs,
					dt_ult_dose_medic,
					dt_reprovacao ,
					ds_justificativa_reprov,
					ie_lavado_justificativa ,
					ie_via_aplicacao ,
					qt_frasco_env,
					qt_frasco_rec,
					nr_seq_proced,
					nr_seq_exame_anterior,
					ds_motivo_revisao,
					nr_seq_condicao,
					ie_laudo_pato_cancer,
					nr_seq_interf_farm,
					ie_suspenso)
			SELECT		nr_prescricao_nova_w,
					nr_seq_item_nova_w,
					cd_procedimento,
					qt_procedimento,
					clock_timestamp(),
					nm_usuario_p,
					ds_horarios,
					ds_observacao,
					cd_motivo_baixa,
					dt_baixa,
					cd_procedimento_aih,
					ie_origem_proced,
					cd_intervalo,
					ie_urgencia,
					cd_setor_atendimento,
					dt_emissao_setor_atend,
					ds_dado_clinico,
					dt_prev_execucao,
					cd_material_exame,
					nr_seq_exame,
					ds_material_especial,
					ie_amostra,
					ie_status_atend,
					ie_origem_inf ,
					cd_setor_coleta ,
					cd_setor_entrega,
					ie_emite_mapa,
					dt_integracao,
					dt_resultado,
					ds_integracao ,
					ie_executar_leito,
					cd_medico_exec,
					nr_agrupamento,
					ie_se_necessario,
					ie_acm ,
					nr_ocorrencia,
					ie_externo,
					nr_seq_lote_externo,
					ds_rotina,
					ie_autorizacao,
					ie_status_execucao,
					nextval('prescr_procedimento_seq'),
					dt_lib_imagem,
					nr_seq_lab,
					nm_usuario_baixa_esp,
					nr_controle,
					dt_coleta,
					nr_seq_proc_interno,
					nr_seq_derivado,
					nr_seq_exame_sangue,
					nr_seq_solic_sangue,
					cd_unid_med_sangue,
					qt_peca_ap,
					ds_qualidade_peca_ap,
					ds_diag_provavel_ap,
					ds_exame_anterior_ap,
					cd_pessoa_coleta,
					ie_lado,
					ie_erro,
					nr_acesso_dicom,
					ie_avisar_result,
					cd_atividade_prof_bpa,
					ie_grupo_atend_bpa,
					ie_tipo_atend_bpa,
					nr_seq_contraste,
					cd_protocolo,
					nr_seq_protocolo,
					nr_seq_proc_protocolo,
					ds_resumo_clinico,
					ds_exame_fis_achado_cirur,
					dt_result_integracao,
					nr_seq_pq_proc ,
					dt_inicio_exame,
					nr_seq_recoleta ,
					nr_doc_convenio,
					cd_senha ,
					dt_antecipa_result ,
					cd_convenio ,
					cd_categoria ,
					qt_vol_hemocomp,
					qt_veloc_inf_hemo,
					qt_volume_adep,
					ie_status,
					dt_status,
					ie_cobra_paciente,
					nr_seq_topografia,
					ie_forma_infusao,
					nr_seq_prot_glic ,
					ie_porte,
					cd_tipo_cirurgia ,
					cd_setor_exec_inic,
					cd_setor_exec_fim,
					qt_volume_suspenso,
					nr_etapas_suspensa,
					ie_objetivo_onco,
					ie_respiracao,
					cd_mod_vent ,
					ie_disp_resp_esp,
					qt_fluxo_oxigenio,
					nr_seq_origem ,
					ds_observacao_enf,
					qt_hora_intervalo,
					qt_min_intervalo,
					ie_util_hemocomponente,
					dt_emissao_resultado,
					ds_cor_erro,
					nr_seq_motivo_antecipacao,
					nm_usuario_antecipacao,
					ds_observacao_antecipacao,
					ds_obs_recoleta ,
					nr_seq_lab_ext,
					nr_controle_exame,
					ie_exame_bloqueado,
					qt_min_oxigenio,
					cd_medico_solicitante,
					qt_fio2 ,
					qt_freq_vent,
					ie_unid_med_hemo,
					ie_funcao_medico,
					qt_etapa,
					dt_status_previsto,
					nr_seq_superior,
					cd_motivo_baixa_exame ,
					ds_observacao_coleta,
					cd_profissional,
					ds_observacao_canc_exame ,
					nr_seq_repeticao ,
					ie_aliquotado,
					ie_filtrado,
					ie_irradiado,
					ie_lavado,
					ie_via_acesso ,
					ie_tipo_proced ,
					cd_perfil_p,
					dt_chamada_exame,
					nr_seq_regra_plano,
					nr_seq_proc_princ ,
					cd_cgc_laboratorio,
					nr_seq_frasco,
					dt_baixa_job,
					ds_localizacao_lesao,
					ds_tempo_doenca,
					ie_controle_envelope,
					nr_seq_status_pato,
					ie_prioridade,
					nr_seq_prioridade,
					ie_proced_bloqueado ,
					ds_observacao_bloqueio,
					ds_cor_selecao ,
					nr_seq_cor_erro,
					ie_exige_liberacao,
					cd_tipo_recomendacao,
					ie_imagem_pacs,
					dt_ult_dose_medic,
					dt_reprovacao ,
					ds_justificativa_reprov,
					ie_lavado_justificativa ,
					ie_via_aplicacao ,
					qt_frasco_env,
					qt_frasco_rec,
					nr_seq_proced,
					nr_seq_exame_anterior,
					ds_motivo_revisao,
					nr_seq_condicao,
					ie_laudo_pato_cancer,
					nr_seq_item_velha_w,
					'N'
			from		prescr_procedimento
			where		nr_prescricao	= nr_prescricao_velha_w
			and		nr_sequencia  	= nr_seq_item_velha_w;


			insert  into 	Prescr_Material(nr_prescricao,
							nr_sequencia,
							ie_origem_inf,
							cd_material,
							cd_unidade_medida,
							qt_dose,
							qt_unitaria,
							qt_material,
							dt_atualizacao,
							nm_usuario,
							cd_intervalo,
							ds_horarios,
							ds_observacao,
							ds_observacao_enf,
							ie_via_aplicacao,
							nr_agrupamento,
							ie_cobra_paciente,
							cd_motivo_baixa,
							dt_baixa,
							ie_utiliza_kit,
							cd_unidade_medida_dose,
							qt_conversao_dose,
							ie_urgencia,
							nr_ocorrencia,
							qt_total_dispensar,
							cd_fornec_consignado,
							nr_sequencia_solucao,
							nr_sequencia_proc,
							qt_solucao,
							hr_dose_especial,
							qt_dose_especial,
							ds_dose_diferenciada,
							ie_medicacao_paciente,
							nr_sequencia_diluicao,
							hr_prim_horario,
							nr_sequencia_dieta,
							ie_agrupador,
							nr_dia_util,
							ie_se_necessario,
							qt_min_aplicacao,
							ie_bomba_infusao,
							ie_aplic_bolus,
							ie_aplic_lenta,
							ie_acm,
							ie_objetivo,
							cd_topografia_cih,
							ie_origem_infeccao,
							cd_amostra_cih,
							cd_microorganismo_cih,
							ie_uso_antimicrobiano,
							cd_protocolo,
							nr_seq_protocolo,
							nr_seq_mat_protocolo,
							qt_hora_aplicacao,
							ie_recons_diluente_fixo,
							qt_vel_infusao,
							ds_justificativa,
							ie_sem_aprazamento,
							ie_indicacao,
							dt_proxima_dose,
							qt_total_dias_lib,
							nr_seq_substituto,
							ie_lado,
							dt_inicio_medic,
							qt_dia_prim_hor,
							ie_regra_disp,
							qt_vol_adic_reconst,
							qt_hora_intervalo,
							qt_min_intervalo,
							ie_permite_substituir,
							ie_dose_espec_agora,
							nr_seq_interf_farm,
							ie_suspenso
							)
						SELECT  nr_prescricao_nova_w,
							nr_seq_item_nova_w + row_number() OVER () AS rownum,
							a.ie_origem_inf,
							a.cd_material,
							a.cd_unidade_medida,
							a.qt_dose,
							a.qt_unitaria,
							a.qt_material,
							clock_timestamp(),
							nm_usuario_p,
							cd_intervalo,
							CASE WHEN ie_sem_aprazamento_w='S' THEN ''  ELSE ds_horarios END ,
							a.ds_observacao,
							a.ds_observacao_enf,
							a.ie_via_aplicacao,
							a.nr_agrupamento,
							coalesce(a.ie_cobra_paciente,'S'),
							CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.cd_motivo_baixa  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  0  ELSE a.cd_motivo_baixa END  END ,
							CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  clock_timestamp()  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  null  ELSE clock_timestamp() END  END ,
							a.ie_utiliza_kit,
							cd_unidade_medida_dose,
							a.qt_conversao_dose,
							coalesce(ie_urgencia,'N'),
							a.nr_ocorrencia,
							a.qt_total_dispensar,
							a.cd_fornec_consignado,
							null,
							nr_seq_item_nova_w,
							a.qt_solucao,
							hr_dose_especial,
							a.qt_dose_especial,
							ds_dose_diferenciada,
							a.ie_medicacao_paciente,
							null,
							CASE WHEN ie_sem_aprazamento_w='S' THEN ''  ELSE a.hr_prim_horario END ,
							null,
							a.ie_agrupador,
							a.nr_dia_util,
							a.ie_se_necessario,
							a.qt_min_aplicacao,
							a.ie_bomba_infusao,
							coalesce(a.ie_aplic_bolus,'N'),
							coalesce(a.ie_aplic_lenta,'N'),
							coalesce(a.ie_acm,'N'),
							a.ie_objetivo,
							a.cd_topografia_cih,
							a.ie_origem_infeccao,
							a.cd_amostra_cih,
							a.cd_microorganismo_cih,
							coalesce(a.ie_uso_antimicrobiano,'N'),
							a.cd_protocolo,
							a.nr_seq_protocolo,
							a.nr_seq_mat_protocolo,
							a.qt_hora_aplicacao,
							'N',
							a.qt_vel_infusao,
							ds_justificativa,
							ie_sem_aprazamento_w,
							a.ie_indicacao,
							a.dt_proxima_dose,
							a.qt_total_dias_lib,
							a.nr_seq_substituto,
							a.ie_lado,
							a.dt_inicio_medic,
							a.qt_dia_prim_hor,
							CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.ie_regra_disp  ELSE null END ,
							a.qt_vol_adic_reconst,
							a.qt_hora_intervalo,
							a.qt_min_intervalo,
							ie_permite_substituir,
							ie_dose_espec_agora,
							nr_seq_item_velha_w,
							'N'							
						from	Material b,
							Prescr_Material a
						where	a.cd_material 	= b.cd_material
						and	a.nr_prescricao = nr_prescricao_velha_w
						and	a.ie_agrupador	in (5)
						and	a.nr_sequencia_proc	= nr_seq_item_velha_w;


			nm_tabela_w	:= 'PRESCR_PROCEDIMENTO';
			nr_seq_novo_item_p	:=	nr_seq_item_nova_w;
		end if;
		if (ie_tipo_p = '1') then
			select	coalesce(max(nr_seq_solucao),0)+1
			into STRICT	nr_seq_item_nova_w
			from	prescr_solucao
			where	nr_prescricao = nr_prescricao_nova_w;

			insert	into	prescr_solucao(
					nr_prescricao,
					nr_seq_solucao,
					ie_via_aplicacao,
					cd_intervalo,
					dt_atualizacao,
					nm_usuario,
					cd_unidade_medida,
					ie_tipo_dosagem,
					qt_dosagem,
					qt_solucao_total,
					qt_tempo_aplicacao,
					ds_solucao,
					qt_volume,
					nr_etapas,
					ds_horarios,
					ie_bomba_infusao,
					nr_agrupamento,
					ie_esquema_alternado,
					hr_prim_horario,
					ie_calc_aut,
					qt_hora_fase,
					ie_acm,
					ie_urgencia,
					dt_status,
					ie_status,
					qt_concentracao,
					cd_unid_med_conc,
					ie_solucao_especial,
					qt_dose_terapeutica,
					nr_unid_terapeutica,
					qt_volume_adep,
					ie_forma_infusao,
					ds_orientacao,
					ie_tipo_solucao,
					qt_temp_solucao,
					ie_momento,
					nr_seq_protocolo,
					ie_hemodialise,
					qt_volume_suspenso,
					ie_unid_vel_inf,
					ie_pos_dialisador,
					cd_setor_exec_inic,
					cd_setor_exec_fim,
					nr_seq_dispositivo,
					qt_horas_estabilidade,
					nr_seq_dialise,
					ie_ultima_bolsa,
					qt_tempo_drenagem,
					qt_tempo_infusao,
					qt_tempo_permanencia,
					ie_apap,
					ie_se_necessario,
					qt_dose_ataque,
					ie_erro,
					ds_cor_erro,
					ie_tipo_analgesia,
					ie_pca_modo_prog,
					qt_dose_inicial_pca,
					qt_vol_infusao_pca,
					qt_bolus_pca,
					qt_intervalo_bloqueio,
					qt_limite_quatro_hora,
					dt_prev_prox_etapa,
					nr_seq_evento,
					ie_solucao_pca,
					cd_perfil_ativo,
					ie_classif_agora,
					ie_etapa_especial,
					pr_concentracao,
					hr_inicio_capd,
					hr_fim_capd,
					dt_lib_material,
					dt_lib_farmacia,
					dt_lib_enfermagem,
					ie_um_dose_inicio_pca,
					ie_um_fluxo_pca,
					ie_um_bolus_pca,
					ie_um_limite_pca,
					ie_tipo_sol,
					nr_seq_interno,
					ie_aberto,
					ie_estender_etapa,
					qt_minuto_fase,
					qt_limite_uma_hora,
					ie_um_limite_hora_pca,
					qt_volume_final,
					qt_hora_infusao,
					nr_seq_interf_farm,
					ie_suspenso,
					cd_protocolo,
					nr_seq_prot_rotina)
			SELECT		nr_prescricao_nova_w,
					nr_seq_item_nova_w,
					ie_via_aplicacao,
					cd_intervalo,
					clock_timestamp(),
					nm_usuario_p,
					cd_unidade_medida,
					ie_tipo_dosagem,
					qt_dosagem,
					qt_solucao_total,
					qt_tempo_aplicacao,
					ds_solucao,
					qt_volume,
					nr_etapas,
					ds_horarios,
					ie_bomba_infusao,
					nr_agrupamento,
					ie_esquema_alternado,
					hr_prim_horario,
					ie_calc_aut,
					qt_hora_fase,
					ie_acm,
					ie_urgencia,
					dt_status,
					'N',
					qt_concentracao,
					cd_unid_med_conc,
					ie_solucao_especial,
					qt_dose_terapeutica,
					nr_unid_terapeutica,
					qt_volume_adep,
					ie_forma_infusao,
					ds_orientacao,
					ie_tipo_solucao,
					qt_temp_solucao,
					ie_momento,
					nr_seq_protocolo,
					ie_hemodialise,
					qt_volume_suspenso,
					ie_unid_vel_inf,
					ie_pos_dialisador,
					cd_setor_exec_inic,
					cd_setor_exec_fim,
					nr_seq_dispositivo,
					qt_horas_estabilidade,
					nr_seq_dialise,
					ie_ultima_bolsa,
					qt_tempo_drenagem,
					qt_tempo_infusao,
					qt_tempo_permanencia,
					ie_apap,
					ie_se_necessario,
					qt_dose_ataque,
					ie_erro,
					ds_cor_erro,
					ie_tipo_analgesia,
					ie_pca_modo_prog,
					qt_dose_inicial_pca,
					qt_vol_infusao_pca,
					qt_bolus_pca,
					qt_intervalo_bloqueio,
					qt_limite_quatro_hora,
					dt_prev_prox_etapa,
					nr_seq_evento,
					ie_solucao_pca,
					cd_perfil_p,
					ie_classif_agora,
					ie_etapa_especial,
					pr_concentracao,
					hr_inicio_capd,
					hr_fim_capd,
					dt_lib_material,
					dt_lib_farmacia,
					dt_lib_enfermagem,
					ie_um_dose_inicio_pca,
					ie_um_fluxo_pca,
					ie_um_bolus_pca,
					ie_um_limite_pca,
					ie_tipo_sol,
					nextval('prescr_solucao_seq'),
					ie_aberto,
					ie_estender_etapa,
					qt_minuto_fase,
					qt_limite_uma_hora,
					ie_um_limite_hora_pca,
					qt_volume_final,
					qt_hora_infusao,
					nr_seq_solucao,
					'N',
					cd_protocolo,
					nr_seq_prot_rotina
			from		prescr_solucao
			where		nr_prescricao 	= nr_prescricao_velha_w
			and		nr_seq_solucao	= nr_seq_item_velha_w;

			select	coalesce(max(nr_sequencia),0)+1
			into STRICT	nr_seq_item_w
			from	prescr_material
			where	nr_prescricao = nr_prescricao_nova_w;

			insert	into	prescr_material(
					nr_prescricao,
					nr_sequencia,
					ie_origem_inf,
					cd_material,
					cd_unidade_medida,
					qt_dose,
					qt_unitaria,
					qt_material,
					dt_atualizacao,
					nm_usuario,
					cd_intervalo,
					ds_horarios,
					ds_observacao,
					ie_via_aplicacao,
					nr_agrupamento,
					cd_motivo_baixa,
					dt_baixa,
					ie_utiliza_kit,
					cd_unidade_medida_dose,
					qt_conversao_dose,
					ie_urgencia,
					nr_ocorrencia,
					qt_total_dispensar,
					cd_fornec_consignado,
					nr_sequencia_solucao,
					nr_sequencia_proc,
					qt_solucao,
					hr_dose_especial,
					qt_dose_especial ,
					ds_dose_diferenciada,
					ie_medicacao_paciente,
					nr_sequencia_diluicao ,
					hr_prim_horario,
					nr_dia_util,
					nr_sequencia_dieta,
					ie_agrupador,
					dt_emissao_setor_atend ,
					ds_justificativa,
					qt_dias_solicitado,
					qt_dias_liberado,
					ie_se_necessario,
					qt_min_aplicacao,
					nr_seq_lote_fornec,
					ie_status_cirurgia,
					ie_bomba_infusao,
					ie_aplic_bolus,
					ie_aplic_lenta,
					ie_acm,
					cd_material_baixa,
					nr_seq_avaliacao,
					nr_seq_ordem_prod,
					qt_baixa_especial,
					ie_objetivo,
					qt_hora_aplicacao,
					ie_erro,
					cd_topografia_cih,
					ie_origem_infeccao,
					cd_amostra_cih,
					cd_microorganismo_cih,
					ie_cultura_cih,
					ie_antibiograma,
					ie_uso_antimicrobiano,
					cd_kit_material,
					cd_local_estoque,
					nr_seq_kit,
					qt_vel_infusao,
					cd_protocolo,
					nr_seq_protocolo,
					nr_seq_mat_protocolo,
					dt_alteracao_local,
					nm_usuario_alt_local,
					ie_recons_diluente_fixo,
					qt_dias_util,
					dt_fim_item,
					nr_seq_atend_medic,
					nr_seq_kit_estoque,
					cd_convenio,
					cd_categoria ,
					ie_sem_aprazamento,
					ie_novo_ciclo_ccih ,
					nr_receita,
					dt_status,
					ie_status,
					qt_volume_adep,
					ie_supera_limite_uso,
					ie_cobra_paciente,
					ie_forma_infusao,
					ie_indicacao,
					ie_dose_espec_agora,
					ie_tipo_medic_hd,
					cd_setor_exec_inic,
					cd_setor_exec_fim,
					nr_seq_pe_proc,
					ie_intervalo_dif,
					ds_reprov_ccih,
					qt_horas_estabilidade,
					dt_proxima_dose,
					ie_administrar,
					qt_total_dias_lib,
					ie_regra_disp,
					ds_observacao_enf,
					ds_observacao_ccih,
					ie_lado,
					ds_diluicao_edit,
					qt_hora_intervalo,
					qt_min_intervalo,
					dt_inicio_medic,
					ds_observacao_far,
					ds_cor_erro,
					ie_amanha,
					qt_dia_prim_hor,
					qt_min_aplic_dose_esp,
					nr_doc_interno,
					qt_vol_adic_reconst,
					qt_ref_diluente,
					nr_seq_atendimento,
					nr_seq_material,
					cd_mat_sem_apresent,
					ie_gerar_diluicao,
					nr_seq_via_acesso,
					ie_item_superior,
					ie_gerar_horario,
					nr_seq_origem_medic,
					dt_lib_enfermagem,
					dt_lib_farmacia ,
					dt_lib_material,
					nr_seq_gasoterapia,
					ie_checar_adep,
					nr_seq_mat_diluicao,
					cd_unidade_medida_sol,
					nr_seq_recomendacao,
					ie_glicemia,
					ie_permite_substituir,
					cd_perfil_ativo,
					nr_seq_sol_prot,
					ds_observacao_nut,
					ie_baixa_estoque_cir,
					ie_adic_manual,
					qt_baixa_nconta,
					ie_pre_medicacao,
					ds_horarios_medico,
					nr_seq_interno,
					ie_necessita_disp_kit,
					nr_seq_justificativa,
					ie_permite_alterar,
					nr_seq_inconsistencia,
					ie_alto_risco,
					nr_seq_interf_farm,
					ie_suspenso)
				SELECT	nr_prescricao_nova_w,
					nr_seq_item_w+rownum,
					ie_origem_inf,
					cd_material,
					cd_unidade_medida,
					qt_dose,
					qt_unitaria,
					qt_material,
					clock_timestamp(),
					nm_usuario_p,
					cd_intervalo,
					ds_horarios,
					ds_observacao,
					ie_via_aplicacao,
					nr_agrupamento,
					cd_motivo_baixa,
					dt_baixa,
					ie_utiliza_kit,
					cd_unidade_medida_dose,
					qt_conversao_dose,
					ie_urgencia,
					nr_ocorrencia,
					qt_total_dispensar,
					cd_fornec_consignado,
					nr_seq_item_nova_w,
					nr_sequencia_proc,
					qt_solucao,
					hr_dose_especial,
					qt_dose_especial ,
					ds_dose_diferenciada,
					ie_medicacao_paciente,
					nr_sequencia_diluicao ,
					hr_prim_horario,
					nr_dia_util,
					nr_sequencia_dieta,
					ie_agrupador,
					dt_emissao_setor_atend ,
					ds_justificativa,
					qt_dias_solicitado,
					qt_dias_liberado,
					ie_se_necessario,
					qt_min_aplicacao,
					nr_seq_lote_fornec,
					ie_status_cirurgia,
					ie_bomba_infusao,
					ie_aplic_bolus,
					ie_aplic_lenta,
					ie_acm,
					cd_material_baixa,
					nr_seq_avaliacao,
					nr_seq_ordem_prod,
					qt_baixa_especial,
					ie_objetivo,
					qt_hora_aplicacao,
					ie_erro,
					cd_topografia_cih,
					ie_origem_infeccao,
					cd_amostra_cih,
					cd_microorganismo_cih,
					ie_cultura_cih,
					ie_antibiograma,
					ie_uso_antimicrobiano,
					cd_kit_material,
					cd_local_estoque,
					nr_seq_kit,
					qt_vel_infusao,
					cd_protocolo,
					nr_seq_protocolo,
					nr_seq_mat_protocolo,
					dt_alteracao_local,
					nm_usuario_alt_local,
					ie_recons_diluente_fixo,
					qt_dias_util,
					dt_fim_item,
					nr_seq_atend_medic,
					nr_seq_kit_estoque,
					cd_convenio,
					cd_categoria ,
					ie_sem_aprazamento,
					ie_novo_ciclo_ccih ,
					nr_receita,
					dt_status,
					ie_status,
					qt_volume_adep,
					ie_supera_limite_uso,
					ie_cobra_paciente,
					ie_forma_infusao,
					ie_indicacao,
					ie_dose_espec_agora,
					ie_tipo_medic_hd,
					cd_setor_exec_inic,
					cd_setor_exec_fim,
					nr_seq_pe_proc,
					ie_intervalo_dif,
					ds_reprov_ccih,
					qt_horas_estabilidade,
					dt_proxima_dose,
					ie_administrar,
					qt_total_dias_lib,
					ie_regra_disp,
					ds_observacao_enf,
					ds_observacao_ccih,
					ie_lado,
					ds_diluicao_edit,
					qt_hora_intervalo,
					qt_min_intervalo,
					dt_inicio_medic,
					ds_observacao_far,
					ds_cor_erro,
					ie_amanha,
					qt_dia_prim_hor,
					qt_min_aplic_dose_esp,
					nr_doc_interno,
					qt_vol_adic_reconst,
					qt_ref_diluente,
					nr_seq_atendimento,
					nr_seq_material,
					cd_mat_sem_apresent,
					ie_gerar_diluicao,
					nr_seq_via_acesso,
					ie_item_superior,
					ie_gerar_horario,
					nr_seq_origem_medic,
					dt_lib_enfermagem,
					dt_lib_farmacia ,
					dt_lib_material,
					nr_seq_gasoterapia,
					ie_checar_adep,
					nr_seq_mat_diluicao,
					cd_unidade_medida_sol,
					nr_seq_recomendacao,
					ie_glicemia,
					ie_permite_substituir,
					cd_perfil_ativo,
					nr_seq_sol_prot,
					ds_observacao_nut,
					ie_baixa_estoque_cir,
					ie_adic_manual,
					qt_baixa_nconta,
					ie_pre_medicacao,
					ds_horarios_medico,
					nextval('prescr_material_seq'),
					ie_necessita_disp_kit,
					nr_seq_justificativa,
					ie_permite_alterar,
					nr_seq_inconsistencia,
					ie_alto_risco,
					nr_sequencia_solucao,
					'N'
				from	prescr_material
				where	nr_prescricao 		= nr_prescricao_velha_w
				and	nr_sequencia_solucao	= nr_seq_item_velha_w
				and	ie_agrupador		= 4;

		nm_tabela_w	:= 'PRESCR_SOLUCAO';
		nr_seq_novo_item_p	:=	nr_seq_item_nova_w;
		end if;
		if (ie_tipo_p = '4') then

			select	nextval('nut_paciente_seq')
			into STRICT	nr_seq_item_nova_w
			;

			insert	into	nut_paciente(
					nr_sequencia,
					nr_atendimento,
					dt_atualizacao,
					nm_usuario,
					qt_peso,
					qt_idade_ano,
					qt_altura_cm,
					nr_seq_fator_ativ,
					nr_seq_fator_stress,
					pr_proteina,
					pr_lipidio,
					pr_carboidrato,
					qt_kcal_total,
					qt_kcal_prot,
					qt_kcal_lipidio,
					qt_kcal_carboidrato,
					qt_kcal_kg,
					qt_grama_prot_kg_dia,
					pr_npt,
					qt_fase_npt,
					qt_gotejamento_npt,
					nr_prescricao,
					qt_dia_npt,
					qt_idade_mes,
					qt_idade_dia,
					qt_nec_hidrica_diaria,
					qt_aporte_hidrico_diario,
					qt_g_lip_kg_dia,
					qt_g_ch_kg_dia,
					qt_vel_inf_glicose,
					qt_nec_kcal_kg_dia,
					pr_conc_glic_solucao,
					qt_rel_cal_nit,
					ie_bomba_infusao,
					ie_calc_automatico,
					dt_status,
					ie_status,
					qt_volume_adep,
					ie_forma_infusao,
					cd_setor_exec_inic,
					cd_setor_exec_fim,
					ie_npt_adulta,
					cd_perfil_ativo,
					ie_permite_alteracao,
					nr_seq_interf_farm,
					ie_suspenso)
				SELECT	nr_seq_item_nova_w,
					nr_atendimento,
					clock_timestamp(),
					nm_usuario_p,
					qt_peso,
					qt_idade_ano,
					qt_altura_cm,
					nr_seq_fator_ativ,
					nr_seq_fator_stress,
					pr_proteina,
					pr_lipidio,
					pr_carboidrato,
					qt_kcal_total,
					qt_kcal_prot,
					qt_kcal_lipidio,
					qt_kcal_carboidrato,
					qt_kcal_kg,
					qt_grama_prot_kg_dia,
					pr_npt,
					qt_fase_npt,
					qt_gotejamento_npt,
					nr_prescricao_nova_w,
					qt_dia_npt,
					qt_idade_mes,
					qt_idade_dia,
					qt_nec_hidrica_diaria,
					qt_aporte_hidrico_diario,
					qt_g_lip_kg_dia,
					qt_g_ch_kg_dia,
					qt_vel_inf_glicose,
					qt_nec_kcal_kg_dia,
					pr_conc_glic_solucao,
					qt_rel_cal_nit,
					ie_bomba_infusao,
					ie_calc_automatico,
					dt_status,
					ie_status,
					qt_volume_adep,
					ie_forma_infusao,
					cd_setor_exec_inic,
					cd_setor_exec_fim,
					ie_npt_adulta,
					cd_perfil_p,
					ie_permite_alteracao,
					nr_seq_item_velha_w,
					'N'
				from	nut_paciente
				where	nr_sequencia = nr_seq_item_velha_w;

			insert	into	nut_paciente_elemento(
					nr_sequencia,
					nr_seq_nut_pac,
					nr_seq_elemento,
					dt_atualizacao,
					nm_usuario,
					qt_kcal,
					qt_elemento,
					nr_seq_elem_unid_med,
					nr_seq_elem_mat,
					qt_volume,
					cd_unid_med_prescr,
					qt_prescricao,
					qt_dispensar,
					qt_vol_1_fase,
					qt_vol_2_fase,
					qt_vol_3_fase,
					cd_perfil_ativo)
				SELECT	nextval('nut_paciente_elemento_seq'),
					nr_seq_item_nova_w,
					nr_seq_elemento,
					clock_timestamp(),
					nm_usuario_p,
					qt_kcal,
					qt_elemento,
					nr_seq_elem_unid_med,
					nr_seq_elem_mat,
					qt_volume,
					cd_unid_med_prescr,
					qt_prescricao,
					qt_dispensar,
					qt_vol_1_fase,
					qt_vol_2_fase,
					qt_vol_3_fase,
					cd_perfil_p
				from	nut_paciente_elemento
				where	nr_seq_nut_pac = nr_seq_item_velha_w;
		nr_seq_novo_item_p	:=	nr_seq_item_nova_w;
		end if;

		if (ie_tipo_p = '5') then

			select	nextval('nut_pac_seq')
			into STRICT	nr_seq_item_nova_w
			;

			insert	into	nut_pac(
					nr_sequencia,
					nr_prescricao,
					dt_atualizacao,
					nm_usuario,
					qt_peso,
					qt_idade_dia,
					qt_idade_mes,
					qt_idade_ano,
					qt_altura_cm,
					qt_dia_npt,
					qt_kcal_total,
					qt_kcal_kg,
					qt_fase_npt,
					qt_nec_hidrica_diaria,
					qt_aporte_hidrico_diario,
					qt_vel_inf_glicose,
					qt_nec_kcal_kg_dia,
					nr_seq_fator_ativ,
					nr_seq_fator_stress,
					pr_conc_glic_solucao,
					qt_rel_cal_nit,
					qt_equipo,
					ie_calculo_auto,
					qt_nec_kcal_dia,
					ie_correcao,
					hr_prim_horario,
					ie_ajustar_potassio,
					qt_gotejo_npt,
					ie_emissao,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					dt_status,
					ie_status,
					qt_volume_adep,
					ie_forma_infusao,
					pr_carboidrato,
					pr_lipidio,
					pr_npt,
					pr_proteina,
					ie_bomba_infusao,
					qt_grama_nitrogenio,
					ie_npt_adulta,
					ie_gera_produto,
					nr_seq_protocolo,
					ie_forma,
					qt_kcal_proteina,
					qt_kcal_lipidio,
					qt_kcal_carboidrato,
					qt_kcal_proteico,
					qt_kcal_nao_proteico,
					pr_conc_lipidio_solucao,
					pr_conc_proteina_solucao,
					qt_osmolaridade_total,
					ie_via_administracao,
					qt_volume_diario,
					cd_setor_exec_inic,
					cd_setor_exec_fim,
					qt_multiplicador,
					qt_peso_ideal,
					qt_peso_ajustado,
					qt_tmb,
					qt_grama_proteina_kg_dia,
					qt_hora_inf,
					qt_min_inf,
					cd_perfil_ativo,
					qt_peso_calorico,
					qt_nec_hidrica_diaria_ped,
					qt_kcal_kg_ped,
					ie_permite_alteracao,
					ie_suplementacao,
					nr_seq_interf_farm,
					ie_suspenso)
				SELECT	nr_seq_item_nova_w,
					nr_prescricao_nova_w,
					clock_timestamp(),
					nm_usuario_p,
					qt_peso,
					qt_idade_dia,
					qt_idade_mes,
					qt_idade_ano,
					qt_altura_cm,
					qt_dia_npt,
					qt_kcal_total,
					qt_kcal_kg,
					qt_fase_npt,
					qt_nec_hidrica_diaria,
					qt_aporte_hidrico_diario,
					qt_vel_inf_glicose,
					qt_nec_kcal_kg_dia,
					nr_seq_fator_ativ,
					nr_seq_fator_stress,
					pr_conc_glic_solucao,
					qt_rel_cal_nit,
					qt_equipo,
					ie_calculo_auto,
					qt_nec_kcal_dia,
					ie_correcao,
					hr_prim_horario,
					ie_ajustar_potassio,
					qt_gotejo_npt,
					ie_emissao,
					clock_timestamp(),
					nm_usuario_p,
					dt_status,
					ie_status,
					qt_volume_adep,
					ie_forma_infusao,
					pr_carboidrato,
					pr_lipidio,
					pr_npt,
					pr_proteina,
					ie_bomba_infusao,
					qt_grama_nitrogenio,
					ie_npt_adulta,
					ie_gera_produto,
					nr_seq_protocolo,
					ie_forma,
					qt_kcal_proteina,
					qt_kcal_lipidio,
					qt_kcal_carboidrato,
					qt_kcal_proteico,
					qt_kcal_nao_proteico,
					pr_conc_lipidio_solucao,
					pr_conc_proteina_solucao,
					qt_osmolaridade_total,
					ie_via_administracao,
					qt_volume_diario,
					cd_setor_exec_inic,
					cd_setor_exec_fim,
					qt_multiplicador,
					qt_peso_ideal,
					qt_peso_ajustado,
					qt_tmb,
					qt_grama_proteina_kg_dia,
					qt_hora_inf,
					qt_min_inf,
					cd_perfil_p,
					qt_peso_calorico,
					qt_nec_hidrica_diaria_ped,
					qt_kcal_kg_ped,
					ie_permite_alteracao,
					ie_suplementacao,
					nr_seq_item_velha_w,
					'N'
				from	nut_pac
				where	nr_sequencia = nr_seq_item_velha_w;

			open c01;
			loop
			fetch c01 into
				nr_sequencia_w,
				nr_seq_elemento_w,
				cd_unidade_medida_w,
				qt_elem_kg_dia_w,
				qt_diaria_w,
				pr_total_w,
				qt_kcal_w,
				ie_prim_fase_w,
				ie_seg_fase_w,
				ie_terc_fase_w,
				ie_quar_fase_w,
				ie_npt_w,
				qt_osmolaridade_w,
				qt_protocolo_w,
				ie_unid_med_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */

				select	nextval('nut_pac_elemento_seq')
				into STRICT	nr_sequencia_ww
				;

				insert	into	nut_pac_elemento(
						nr_sequencia,
						nr_seq_nut_pac,
						nr_seq_elemento,
						dt_atualizacao,
						nm_usuario,
						cd_unidade_medida,
						qt_elem_kg_dia,
						qt_diaria,
						pr_total,
						qt_kcal,
						ie_prim_fase,
						ie_seg_fase,
						ie_terc_fase,
						ie_quar_fase,
						ie_npt,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						qt_osmolaridade,
						qt_protocolo,
						cd_perfil_ativo,
						ie_unid_med,
						nr_seq_interf_farm)
					values (nr_sequencia_ww,
						nr_seq_item_velha_w,
						nr_seq_elemento_w,
						clock_timestamp(),
						nm_usuario_p,
						cd_unidade_medida_w,
						qt_elem_kg_dia_w,
						qt_diaria_w,
						pr_total_w,
						qt_kcal_w,
						ie_prim_fase_w,
						ie_seg_fase_w,
						ie_terc_fase_w,
						ie_quar_fase_w,
						ie_npt_w,
						clock_timestamp(),
						nm_usuario_p,
						qt_osmolaridade_w,
						qt_protocolo_w,
						cd_perfil_p,
						ie_unid_med_w,
						nr_sequencia_w);

				insert	into	nut_pac_elem_mat(
						nr_sequencia,
						nr_seq_pac_elem,
						dt_atualizacao,
						nm_usuario,
						nr_seq_elem_mat,
						qt_volume,
						qt_vol_1_fase,
						qt_vol_2_fase,
						qt_vol_3_fase,
						qt_vol_4_fase,						
						qt_vol_cor,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_seq_nut_pac,
						cd_material,
						qt_protocolo,
						cd_perfil_ativo)
					SELECT	nextval('nut_pac_elem_mat_seq'),
						nr_sequencia_ww,
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_elem_mat,
						qt_volume,
						qt_vol_1_fase,
						qt_vol_2_fase,
						qt_vol_3_fase,
						qt_vol_4_fase,
						qt_vol_cor,
						clock_timestamp(),
						nm_usuario_p,
						CASE WHEN coalesce(nr_seq_nut_pac::text, '') = '' THEN null  ELSE nr_seq_item_nova_w END ,
						cd_material,
						qt_protocolo,
						cd_perfil_p
					from	nut_pac_elem_mat
					where	nr_seq_pac_elem = nr_sequencia_w;
			end loop;
			close c01;
		nm_tabela_w	:= 'NUT_PAC';
		nr_seq_novo_item_p	:=	nr_seq_item_nova_w;
		end if;

		if (ie_tipo_p = 'D') then
			select	coalesce(max(nr_sequencia),0)+1
			into STRICT	nr_seq_item_nova_w
			from	prescr_dieta
			where	nr_prescricao = nr_prescricao_nova_w;

			insert	into	prescr_dieta(
					nr_prescricao,
					nr_sequencia,
					cd_dieta,
					dt_atualizacao,
					nm_usuario,
					qt_parametro,
					ds_horarios,
					ds_observacao,
					cd_motivo_baixa,
					dt_baixa,
					ie_destino_dieta,
					ie_refeicao,
					dt_emissao_dieta,
					qt_horas_jejum,
					cd_perfil_ativo,
					cd_intervalo,
					nr_seq_interno,
					nr_seq_interf_farm,
					ie_suspenso)
			SELECT		nr_prescricao_nova_w,
					nr_seq_item_nova_w,
					cd_dieta,
					clock_timestamp(),
					nm_usuario_p,
					qt_parametro,
					ds_horarios,
					ds_observacao,
					cd_motivo_baixa,
					dt_baixa,
					ie_destino_dieta,
					ie_refeicao,
					dt_emissao_dieta,
					qt_horas_jejum,
					cd_perfil_p,
					cd_intervalo,
					nextval('prescr_dieta_seq'),
					nr_seq_item_velha_w,
					'N'
			from		prescr_dieta
			where		nr_prescricao 	= nr_prescricao_velha_w
			and		nr_sequencia	= nr_seq_item_velha_w;

			select	coalesce(max(nr_sequencia),0)+1
			into STRICT	nr_seq_item_w
			from	prescr_material
			where	nr_prescricao 	= nr_prescricao_nova_w;


			insert	into	prescr_material(
					nr_prescricao,
					nr_sequencia,
					ie_origem_inf,
					cd_material,
					cd_unidade_medida,
					qt_dose,
					qt_unitaria,
					qt_material,
					dt_atualizacao,
					nm_usuario,
					cd_intervalo,
					ds_horarios,
					ds_observacao,
					ie_via_aplicacao,
					nr_agrupamento,
					cd_motivo_baixa,
					dt_baixa,
					ie_utiliza_kit,
					cd_unidade_medida_dose,
					qt_conversao_dose,
					ie_urgencia,
					nr_ocorrencia,
					qt_total_dispensar,
					cd_fornec_consignado,
					nr_sequencia_solucao,
					nr_sequencia_proc,
					qt_solucao,
					hr_dose_especial,
					qt_dose_especial ,
					ds_dose_diferenciada,
					ie_medicacao_paciente,
					nr_sequencia_diluicao ,
					hr_prim_horario,
					nr_dia_util,
					nr_sequencia_dieta,
					ie_agrupador,
					dt_emissao_setor_atend ,
					ds_justificativa,
					qt_dias_solicitado,
					qt_dias_liberado,
					ie_se_necessario,
					qt_min_aplicacao,
					nr_seq_lote_fornec,
					ie_status_cirurgia,
					ie_bomba_infusao,
					ie_aplic_bolus,
					ie_aplic_lenta,
					ie_acm,
					cd_material_baixa,
					nr_seq_avaliacao,
					nr_seq_ordem_prod,
					qt_baixa_especial,
					ie_objetivo,
					qt_hora_aplicacao,
					ie_erro,
					cd_topografia_cih,
					ie_origem_infeccao,
					cd_amostra_cih,
					cd_microorganismo_cih,
					ie_cultura_cih,
					ie_antibiograma,
					ie_uso_antimicrobiano,
					cd_kit_material,
					cd_local_estoque,
					nr_seq_kit,
					qt_vel_infusao,
					cd_protocolo,
					nr_seq_protocolo,
					nr_seq_mat_protocolo,
					dt_alteracao_local,
					nm_usuario_alt_local,
					ie_recons_diluente_fixo,
					qt_dias_util,
					dt_fim_item,
					nr_seq_atend_medic,
					nr_seq_kit_estoque,
					cd_convenio,
					cd_categoria ,
					ie_sem_aprazamento,
					ie_novo_ciclo_ccih ,
					nr_receita,
					dt_status,
					ie_status,
					qt_volume_adep,
					ie_supera_limite_uso,
					ie_cobra_paciente,
					ie_forma_infusao,
					ie_indicacao,
					ie_dose_espec_agora,
					ie_tipo_medic_hd,
					cd_setor_exec_inic,
					cd_setor_exec_fim,
					nr_seq_pe_proc,
					ie_intervalo_dif,
					ds_reprov_ccih,
					qt_horas_estabilidade,
					dt_proxima_dose,
					ie_administrar,
					qt_total_dias_lib,
					ie_regra_disp,
					ds_observacao_enf,
					ds_observacao_ccih,
					ie_lado,
					ds_diluicao_edit,
					qt_hora_intervalo,
					qt_min_intervalo,
					dt_inicio_medic,
					ds_observacao_far,
					ds_cor_erro,
					ie_amanha,
					qt_dia_prim_hor,
					qt_min_aplic_dose_esp,
					nr_doc_interno,
					qt_vol_adic_reconst,
					qt_ref_diluente,
					nr_seq_atendimento,
					nr_seq_material,
					cd_mat_sem_apresent,
					ie_gerar_diluicao,
					nr_seq_via_acesso,
					ie_item_superior,
					ie_gerar_horario,
					nr_seq_origem_medic,
					dt_lib_enfermagem,
					dt_lib_farmacia ,
					dt_lib_material,
					nr_seq_gasoterapia,
					ie_checar_adep,
					nr_seq_mat_diluicao,
					cd_unidade_medida_sol,
					nr_seq_recomendacao,
					ie_glicemia,
					ie_permite_substituir,
					cd_perfil_ativo,
					nr_seq_sol_prot,
					ds_observacao_nut,
					ie_baixa_estoque_cir,
					ie_adic_manual,
					qt_baixa_nconta,
					ie_pre_medicacao,
					ds_horarios_medico,
					nr_seq_interno,
					ie_necessita_disp_kit,
					nr_seq_justificativa,
					ie_permite_alterar,
					nr_seq_inconsistencia,
					ie_alto_risco,
					nr_seq_interf_farm,
					ie_suspenso)
				SELECT	nr_prescricao_nova_w,
					nr_seq_item_w,
					ie_origem_inf,
					cd_material,
					cd_unidade_medida,
					qt_dose,
					qt_unitaria,
					qt_material,
					clock_timestamp(),
					nm_usuario_p,
					cd_intervalo,
					ds_horarios,
					ds_observacao,
					ie_via_aplicacao,
					nr_agrupamento,
					cd_motivo_baixa,
					dt_baixa,
					ie_utiliza_kit,
					cd_unidade_medida_dose,
					qt_conversao_dose,
					ie_urgencia,
					nr_ocorrencia,
					qt_total_dispensar,
					cd_fornec_consignado,
					nr_sequencia_solucao,
					nr_sequencia_proc,
					qt_solucao,
					hr_dose_especial,
					qt_dose_especial ,
					ds_dose_diferenciada,
					ie_medicacao_paciente,
					nr_sequencia_diluicao ,
					hr_prim_horario,
					nr_dia_util,
					nr_seq_item_nova_w,
					ie_agrupador,
					dt_emissao_setor_atend ,
					ds_justificativa,
					qt_dias_solicitado,
					qt_dias_liberado,
					ie_se_necessario,
					qt_min_aplicacao,
					nr_seq_lote_fornec,
					ie_status_cirurgia,
					ie_bomba_infusao,
					ie_aplic_bolus,
					ie_aplic_lenta,
					ie_acm,
					cd_material_baixa,
					nr_seq_avaliacao,
					nr_seq_ordem_prod,
					qt_baixa_especial,
					ie_objetivo,
					qt_hora_aplicacao,
					ie_erro,
					cd_topografia_cih,
					ie_origem_infeccao,
					cd_amostra_cih,
					cd_microorganismo_cih,
					ie_cultura_cih,
					ie_antibiograma,
					ie_uso_antimicrobiano,
					cd_kit_material,
					cd_local_estoque,
					nr_seq_kit,
					qt_vel_infusao,
					cd_protocolo,
					nr_seq_protocolo,
					nr_seq_mat_protocolo,
					dt_alteracao_local,
					nm_usuario_alt_local,
					ie_recons_diluente_fixo,
					qt_dias_util,
					dt_fim_item,
					nr_seq_atend_medic,
					nr_seq_kit_estoque,
					cd_convenio,
					cd_categoria ,
					ie_sem_aprazamento,
					ie_novo_ciclo_ccih ,
					nr_receita,
					dt_status,
					ie_status,
					qt_volume_adep,
					ie_supera_limite_uso,
					ie_cobra_paciente,
					ie_forma_infusao,
					ie_indicacao,
					ie_dose_espec_agora,
					ie_tipo_medic_hd,
					cd_setor_exec_inic,
					cd_setor_exec_fim,
					nr_seq_pe_proc,
					ie_intervalo_dif,
					ds_reprov_ccih,
					qt_horas_estabilidade,
					dt_proxima_dose,
					ie_administrar,
					qt_total_dias_lib,
					ie_regra_disp,
					ds_observacao_enf,
					ds_observacao_ccih,
					ie_lado,
					ds_diluicao_edit,
					qt_hora_intervalo,
					qt_min_intervalo,
					dt_inicio_medic,
					ds_observacao_far,
					ds_cor_erro,
					ie_amanha,
					qt_dia_prim_hor,
					qt_min_aplic_dose_esp,
					nr_doc_interno,
					qt_vol_adic_reconst,
					qt_ref_diluente,
					nr_seq_atendimento,
					nr_seq_material,
					cd_mat_sem_apresent,
					ie_gerar_diluicao,
					nr_seq_via_acesso,
					ie_item_superior,
					ie_gerar_horario,
					nr_seq_origem_medic,
					dt_lib_enfermagem,
					dt_lib_farmacia ,
					dt_lib_material,
					nr_seq_gasoterapia,
					ie_checar_adep,
					nr_seq_mat_diluicao,
					cd_unidade_medida_sol,
					nr_seq_recomendacao,
					ie_glicemia,
					ie_permite_substituir,
					cd_perfil_ativo,
					nr_seq_sol_prot,
					ds_observacao_nut,
					ie_baixa_estoque_cir,
					ie_adic_manual,
					qt_baixa_nconta,
					ie_pre_medicacao,
					ds_horarios_medico,
					nextval('prescr_material_seq'),
					ie_necessita_disp_kit,
					nr_seq_justificativa,
					ie_permite_alterar,
					nr_seq_inconsistencia,
					ie_alto_risco,
					nr_seq_item_velha_w,
					'N'
				from	prescr_material
				where	nr_prescricao 		= nr_prescricao_velha_w
				and	nr_sequencia_dieta	= nr_seq_item_velha_w;

		nm_tabela_w	:= 'PRESCR_DIETA';
		nr_seq_novo_item_p	:=	nr_seq_item_nova_w;
		end if;
		if (ie_tipo_p = 'S') or (ie_tipo_p = '2') then
			select	coalesce(max(nr_sequencia),0)+1
			into STRICT	nr_seq_item_nova_w
			from	prescr_material
			where	nr_prescricao = nr_prescricao_nova_w;

			insert	into	prescr_material(
					nr_prescricao,
					nr_sequencia,
					ie_origem_inf,
					cd_material,
					cd_unidade_medida,
					qt_dose,
					qt_unitaria,
					qt_material,
					dt_atualizacao,
					nm_usuario,
					cd_intervalo,
					ds_horarios,
					ds_observacao,
					ie_via_aplicacao,
					nr_agrupamento,
					cd_motivo_baixa,
					dt_baixa,
					ie_utiliza_kit,
					cd_unidade_medida_dose,
					qt_conversao_dose,
					ie_urgencia,
					nr_ocorrencia,
					qt_total_dispensar,
					cd_fornec_consignado,
					nr_sequencia_solucao,
					nr_sequencia_proc,
					qt_solucao,
					hr_dose_especial,
					qt_dose_especial ,
					ds_dose_diferenciada,
					ie_medicacao_paciente,
					nr_sequencia_diluicao ,
					hr_prim_horario,
					nr_dia_util,
					nr_sequencia_dieta,
					ie_agrupador,
					dt_emissao_setor_atend ,
					ds_justificativa,
					qt_dias_solicitado,
					qt_dias_liberado,
					ie_se_necessario,
					qt_min_aplicacao,
					nr_seq_lote_fornec,
					ie_status_cirurgia,
					ie_bomba_infusao,
					ie_aplic_bolus,
					ie_aplic_lenta,
					ie_acm,
					cd_material_baixa,
					nr_seq_avaliacao,
					nr_seq_ordem_prod,
					qt_baixa_especial,
					ie_objetivo,
					qt_hora_aplicacao,
					ie_erro,
					cd_topografia_cih,
					ie_origem_infeccao,
					cd_amostra_cih,
					cd_microorganismo_cih,
					ie_cultura_cih,
					ie_antibiograma,
					ie_uso_antimicrobiano,
					cd_kit_material,
					cd_local_estoque,
					nr_seq_kit,
					qt_vel_infusao,
					cd_protocolo,
					nr_seq_protocolo,
					nr_seq_mat_protocolo,
					dt_alteracao_local,
					nm_usuario_alt_local,
					ie_recons_diluente_fixo,
					qt_dias_util,
					dt_fim_item,
					nr_seq_atend_medic,
					nr_seq_kit_estoque,
					cd_convenio,
					cd_categoria ,
					ie_sem_aprazamento,
					ie_novo_ciclo_ccih ,
					nr_receita,
					dt_status,
					ie_status,
					qt_volume_adep,
					ie_supera_limite_uso,
					ie_cobra_paciente,
					ie_forma_infusao,
					ie_indicacao,
					ie_dose_espec_agora,
					ie_tipo_medic_hd,
					cd_setor_exec_inic,
					cd_setor_exec_fim,
					nr_seq_pe_proc,
					ie_intervalo_dif,
					ds_reprov_ccih,
					qt_horas_estabilidade,
					dt_proxima_dose,
					ie_administrar,
					qt_total_dias_lib,
					ie_regra_disp,
					ds_observacao_enf,
					ds_observacao_ccih,
					ie_lado,
					ds_diluicao_edit,
					qt_hora_intervalo,
					qt_min_intervalo,
					dt_inicio_medic,
					ds_observacao_far,
					ds_cor_erro,
					ie_amanha,
					qt_dia_prim_hor,
					qt_min_aplic_dose_esp,
					nr_doc_interno,
					qt_vol_adic_reconst,
					qt_ref_diluente,
					nr_seq_atendimento,
					nr_seq_material,
					cd_mat_sem_apresent,
					ie_gerar_diluicao,
					nr_seq_via_acesso,
					ie_item_superior,
					ie_gerar_horario,
					nr_seq_origem_medic,
					dt_lib_enfermagem,
					dt_lib_farmacia ,
					dt_lib_material,
					nr_seq_gasoterapia,
					ie_checar_adep,
					nr_seq_mat_diluicao,
					cd_unidade_medida_sol,
					nr_seq_recomendacao,
					ie_glicemia,
					ie_permite_substituir,
					cd_perfil_ativo,
					nr_seq_sol_prot,
					ds_observacao_nut,
					ie_baixa_estoque_cir,
					ie_adic_manual,
					qt_baixa_nconta,
					ie_pre_medicacao,
					ds_horarios_medico,
					nr_seq_interno,
					ie_necessita_disp_kit,
					nr_seq_justificativa,
					ie_permite_alterar,
					nr_seq_inconsistencia,
					ie_alto_risco,
					nr_seq_interf_farm,
					ie_suspenso)
				SELECT	nr_prescricao_nova_w,
					nr_seq_item_nova_w,
					ie_origem_inf,
					cd_material,
					cd_unidade_medida,
					qt_dose,
					qt_unitaria,
					qt_material,
					clock_timestamp(),
					nm_usuario_p,
					cd_intervalo,
					ds_horarios,
					ds_observacao,
					ie_via_aplicacao,
					nr_agrupamento,
					cd_motivo_baixa,
					dt_baixa,
					ie_utiliza_kit,
					cd_unidade_medida_dose,
					qt_conversao_dose,
					ie_urgencia,
					nr_ocorrencia,
					qt_total_dispensar,
					cd_fornec_consignado,
					nr_sequencia_solucao,
					nr_sequencia_proc,
					qt_solucao,
					hr_dose_especial,
					qt_dose_especial ,
					ds_dose_diferenciada,
					ie_medicacao_paciente,
					nr_sequencia_diluicao ,
					hr_prim_horario,
					nr_dia_util,
					nr_sequencia_dieta,
					ie_agrupador,
					dt_emissao_setor_atend ,
					ds_justificativa,
					qt_dias_solicitado,
					qt_dias_liberado,
					ie_se_necessario,
					qt_min_aplicacao,
					nr_seq_lote_fornec,
					ie_status_cirurgia,
					ie_bomba_infusao,
					ie_aplic_bolus,
					ie_aplic_lenta,
					ie_acm,
					cd_material_baixa,
					nr_seq_avaliacao,
					nr_seq_ordem_prod,
					qt_baixa_especial,
					ie_objetivo,
					qt_hora_aplicacao,
					ie_erro,
					cd_topografia_cih,
					ie_origem_infeccao,
					cd_amostra_cih,
					cd_microorganismo_cih,
					ie_cultura_cih,
					ie_antibiograma,
					ie_uso_antimicrobiano,
					cd_kit_material,
					cd_local_estoque,
					nr_seq_kit,
					qt_vel_infusao,
					cd_protocolo,
					nr_seq_protocolo,
					nr_seq_mat_protocolo,
					dt_alteracao_local,
					nm_usuario_alt_local,
					ie_recons_diluente_fixo,
					qt_dias_util,
					dt_fim_item,
					nr_seq_atend_medic,
					nr_seq_kit_estoque,
					cd_convenio,
					cd_categoria ,
					ie_sem_aprazamento,
					ie_novo_ciclo_ccih ,
					nr_receita,
					dt_status,
					ie_status,
					qt_volume_adep,
					ie_supera_limite_uso,
					ie_cobra_paciente,
					ie_forma_infusao,
					ie_indicacao,
					ie_dose_espec_agora,
					ie_tipo_medic_hd,
					cd_setor_exec_inic,
					cd_setor_exec_fim,
					nr_seq_pe_proc,
					ie_intervalo_dif,
					ds_reprov_ccih,
					qt_horas_estabilidade,
					dt_proxima_dose,
					ie_administrar,
					qt_total_dias_lib,
					ie_regra_disp,
					ds_observacao_enf,
					ds_observacao_ccih,
					ie_lado,
					ds_diluicao_edit,
					qt_hora_intervalo,
					qt_min_intervalo,
					dt_inicio_medic,
					ds_observacao_far,
					ds_cor_erro,
					ie_amanha,
					qt_dia_prim_hor,
					qt_min_aplic_dose_esp,
					nr_doc_interno,
					qt_vol_adic_reconst,
					qt_ref_diluente,
					nr_seq_atendimento,
					nr_seq_material,
					cd_mat_sem_apresent,
					ie_gerar_diluicao,
					nr_seq_via_acesso,
					ie_item_superior,
					ie_gerar_horario,
					nr_seq_origem_medic,
					dt_lib_enfermagem,
					dt_lib_farmacia ,
					dt_lib_material,
					nr_seq_gasoterapia,
					ie_checar_adep,
					nr_seq_mat_diluicao,
					cd_unidade_medida_sol,
					nr_seq_recomendacao,
					ie_glicemia,
					ie_permite_substituir,
					cd_perfil_ativo,
					nr_seq_sol_prot,
					ds_observacao_nut,
					ie_baixa_estoque_cir,
					ie_adic_manual,
					qt_baixa_nconta,
					ie_pre_medicacao,
					ds_horarios_medico,
					nextval('prescr_material_seq'),
					ie_necessita_disp_kit,
					nr_seq_justificativa,
					ie_permite_alterar,
					nr_seq_inconsistencia,
					ie_alto_risco,
					nr_seq_item_velha_w,
					'N'
				from	prescr_material
				where	nr_prescricao 	= nr_prescricao_velha_w
				and	nr_sequencia	= nr_seq_item_velha_w;
		nm_tabela_w	:= 'PRESCR_MATERIAL';
		nr_seq_novo_item_p	:=	nr_seq_item_nova_w;
		end if;
	end if;
	nr_nova_prescricao_p	:=	nr_prescricao_nova_w;
	if (nr_nova_prescricao_p IS NOT NULL AND nr_nova_prescricao_p::text <> '') and (nr_seq_novo_item_p IS NOT NULL AND nr_seq_novo_item_p::text <> '') and (ie_opcao_p = 'M') then

		if (ie_tipo_p	= '2') then
			ie_tipo_item_w	:= 'SNE';
		elsif (ie_tipo_p	= '5') then
			ie_tipo_item_w	:= 'NPN';			
		elsif (ie_tipo_p	= '1') then
			ie_tipo_item_w	:= 'SOL';
		elsif (ie_tipo_p = 'G') then
			ie_tipo_item_w  := 'O';
		else	
			ie_tipo_item_w	:= ie_tipo_p;
		end if;
		if (nm_tabela_w	= 'PRESCR_MATERIAL') then
			select	max(cd_material)
			into STRICT	cd_item_w
			from	prescr_material
			where	nr_prescricao	= nr_nova_prescricao_p
			and	nr_sequencia	= nr_seq_novo_item_p;
		elsif (nm_tabela_w	= 'PRESCR_PROCEDIMENTO') then
			select	max(cd_procedimento)
			into STRICT	cd_item_w
			from	prescr_procedimento
			where	nr_prescricao	= nr_nova_prescricao_p
			and	nr_sequencia	= nr_seq_novo_item_p;		
		elsif (nm_tabela_w	= 'PRESCR_SOLUCAO') then
			select	CASE WHEN count(nr_seq_solucao)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ie_gera_evento_w
			from	prescr_solucao
			where	nr_prescricao	= nr_nova_prescricao_p
			and	nr_seq_solucao	= nr_seq_novo_item_p;		
		elsif (nm_tabela_w	= 'PRESCR_RECOMENDACAO') then
			select	coalesce(max(cd_recomendacao),substr(max(ds_recomendacao),1,255))
			into STRICT	cd_item_w
			from	prescr_recomendacao
			where	nr_prescricao	= nr_nova_prescricao_p
			and	nr_sequencia	= nr_seq_novo_item_p;		
		elsif (nm_tabela_w	= 'PRESCR_GASOTERAPIA') then
			select	max(nr_seq_gas)
			into STRICT	cd_item_w
			from	prescr_gasoterapia
			where	nr_prescricao	= nr_nova_prescricao_p
			and	nr_sequencia	= nr_seq_novo_item_p;
		elsif (nm_tabela_w	= 'NUT_PAC') then
			select	max(nr_sequencia)
			into STRICT	cd_item_w
			from	nut_pac
			where	nr_prescricao	= nr_nova_prescricao_p
			and	nr_sequencia	= nr_seq_novo_item_p;					
		end if;

		if (cd_item_w IS NOT NULL AND cd_item_w::text <> '') and (coalesce(ie_gera_evento_w::text, '') = '') then
			ie_gera_evento_w	:= 'S';
		end if;

		if (ie_tipo_item_w		<> '4') and (ie_gera_evento_w	= 'S') then
			nr_seq_alteracao_w := PLT_atualizar_gerar_evento(ie_tipo_item_w, nr_nova_prescricao_p, nr_seq_novo_item_p, cd_item_w, 'IS', obter_desc_expressao(781865)/*'Inclusao do item por substituicao em intervencao farmaceutica.'*/, nr_seq_alteracao_w, nm_usuario_p);
		end if;

	end if;

	open C02;
	loop
	fetch C02 into	
		nr_sequencia_w,
		qt_hora_intervalo_w,
		dt_proxima_dose_w,
		nr_seq_anterior_w,
		nr_prescricao_original_w,
		cd_material_w,
		cd_intervalo_w,
		hr_prim_horario_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		if (qt_hora_intervalo_w > 24) then

			dt_proxima_dose_orig_w	:= dt_proxima_dose_w;
			dt_horario_w			:= null;

		    if (nr_seq_anterior_w IS NOT NULL AND nr_seq_anterior_w::text <> '') then

			    select	max(dt_proxima_dose),
						coalesce(max(hr_prim_horario), hr_prim_horario_w)
				into STRICT	dt_proxima_dose_w,
						hr_prim_horario_w
				from	prescr_material
				where	/*nvl(hr_prim_horario, hr_prim_horario_w) = hr_prim_horario_w
				and		*/
cd_intervalo = cd_intervalo_w
				and		cd_material = cd_material_w
				and		nr_sequencia = nr_seq_anterior_w
				and		nr_prescricao = nr_prescricao_original_w
				and		coalesce(ie_modificado,'N') = 'N';

				hr_prim_horario_w	:= coalesce(hr_prim_horario_w, to_char(dt_inicio_prescr_w, 'hh24:mi'));

			    if (coalesce(dt_proxima_dose_w::text, '') = '') then
					dt_proxima_dose_w	:= dt_proxima_dose_orig_w;

				    select	max(dt_horario)
					into STRICT	dt_horario_w
					from	prescr_mat_hor
					where	nr_seq_material	= nr_sequencia_w
					and	nr_prescricao	= nr_prescricao_p;
				else

					update	prescr_material
					set	dt_proxima_dose	= dt_proxima_dose_w,
						dt_administrar 	= dt_proxima_dose_w
					where	nr_sequencia	= nr_sequencia_w
					and	nr_prescricao	= nr_prescricao_p;
				end if;
			else

			    select	max(dt_horario)
		  		into STRICT	dt_horario_w
				from	prescr_mat_hor
				where	nr_seq_material	= nr_sequencia_w
				and	nr_prescricao	= nr_prescricao_p;

				dt_proxima_dose_w	:= dt_horario_w;
			end if;

		    if	((coalesce(dt_proxima_dose_w::text, '') = '') or (dt_proxima_dose_w between dt_inicio_prescr_w and dt_validade_prescr_w)) then
				begin

			    if (dt_proxima_dose_w IS NOT NULL AND dt_proxima_dose_w::text <> '') then
				    if (dt_inicio_prescr_w > dt_proxima_dose_w) then
						qt_dia_prim_hor_w := PKG_DATE_UTILS.start_of(dt_inicio_prescr_w, 'dd', 0) - PKG_DATE_UTILS.start_of(dt_proxima_dose_w, 'dd', 0);
					else
						qt_dia_prim_hor_w := PKG_DATE_UTILS.start_of(dt_proxima_dose_w, 'dd', 0) - PKG_DATE_UTILS.start_of(dt_inicio_prescr_w, 'dd', 0);
					end if;
				else
			        if (hr_prim_horario_w < to_char(dt_inicio_prescr_w,'hh24:mi')) then
						qt_dia_prim_hor_w	:= 1;
					else
						qt_dia_prim_hor_w	:= 0;
					end if;
				end if;

			    if (qt_dia_prim_hor_w not between 0 and 1) then
					qt_dia_prim_hor_w	:= 0;
				end if;

			    if (mod(qt_hora_intervalo_w,24) > 0) and (dt_proxima_dose_w IS NOT NULL AND dt_proxima_dose_w::text <> '') then

					update	prescr_material
					set		hr_prim_horario	= to_char(dt_proxima_dose_w,'hh24:mi'),
							ds_horarios		= to_char(dt_proxima_dose_w,'hh24:mi '),
							dt_administrar 	= dt_proxima_dose_w
					where	nr_sequencia	= nr_sequencia_w
					and		nr_prescricao	= nr_prescricao_p;
				end if;	

				dt_proxima_dose_w	:= coalesce(dt_horario_w, dt_proxima_dose_w) + qt_hora_intervalo_w/24;

			    if (mod(qt_hora_intervalo_w,24) > 0) then

					update	prescr_material
					set		dt_proxima_dose	= dt_proxima_dose_w,
							ie_administrar	 = NULL,
							qt_dia_prim_hor	= qt_dia_prim_hor_w
					where	nr_sequencia	= nr_sequencia_w
					and		nr_prescricao	= nr_prescricao_p;
				else

					update	prescr_material
					set		hr_prim_horario	= to_char(dt_proxima_dose_w,'hh24:mi'),
							ds_horarios	= to_char(dt_proxima_dose_w,'hh24:mi '),
							dt_proxima_dose	= dt_proxima_dose_w,			
							ie_administrar	 = NULL,
							qt_dia_prim_hor	= qt_dia_prim_hor_w
					where	nr_sequencia	= nr_sequencia_w
					and		nr_prescricao	= nr_prescricao_p;
				end if;

				end;

		    end if;		

		end if;

		end;
	end loop;
	close C02;

end if;

commit;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_prescr_item_inter_farm (nr_prescricao_p bigint, nr_seq_item_p bigint, ie_opcao_p text, ie_tipo_p text, cd_motivo_p bigint, ds_motivo_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint , nm_usuario_p text , nr_nova_prescricao_p INOUT bigint, nr_seq_novo_item_p INOUT bigint ) FROM PUBLIC;

