-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_equip_agenda_cirurgica ( nr_cirurgia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
nr_seq_classif_equip_w	bigint;
cd_equipamento_w		bigint;
nr_sequencia_w		bigint;
										
C01 CURSOR FOR 
	SELECT	nr_seq_classif_equip, 
		cd_equipamento 
	from	agenda_pac_equip 
	where	nr_seq_agenda = obter_dados_agenda_cirur(nr_cirurgia_p,'N') 
	order by	1;
	
C02 CURSOR FOR 
	SELECT	b.cd_equipamento 
	from	equipamento b 
	where	b.cd_classificacao = nr_seq_classif_equip_w 
	and	b.ie_situacao = 'A' 
	and	(nr_seq_pepo IS NOT NULL AND nr_seq_pepo::text <> '') 
	and not exists (	SELECT	1 
			from	equipamento_cirurgia x 
			where	x.cd_equipamento = b.cd_equipamento 
			and	x.nr_cirurgia = nr_cirurgia_p 
			and	coalesce(x.ie_situacao,'A') = 'A') 
	order by 1;
	

BEGIN 
 
open C01;
loop 
fetch C01 into	 
	nr_seq_classif_equip_w, 
	cd_equipamento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
		if (nr_seq_classif_equip_w IS NOT NULL AND nr_seq_classif_equip_w::text <> '')	then 
		 
			open C02;
			loop 
			fetch C02 into	 
				cd_equipamento_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin 
				nr_sequencia_w := gerar_equipamentos_cirurgia(cd_equipamento_w, nr_cirurgia_p, obter_pessoa_fisica_usuario(nm_usuario_p,'C'), nm_usuario_p, nr_sequencia_w, null, null, null, null, null);
				CALL gerar_taxa_equipamento(cd_estabelecimento_p, nr_sequencia_w, nm_usuario_p);
				CALL gerar_material_equipamento(cd_estabelecimento_p, nr_sequencia_w, nm_usuario_p);
				end;
			end loop;
			close C02;
		else 
			select	max(cd_equipamento) 
			into STRICT 
				cd_equipamento_w 
			from	equipamento 
			where	cd_equipamento = cd_equipamento_w 
			and	ie_situacao = 'A' 
			and	(nr_seq_pepo IS NOT NULL AND nr_seq_pepo::text <> '') 
			and not exists (	SELECT	1 
					from	equipamento_cirurgia x 
					where	x.cd_equipamento = cd_equipamento_w 
					and	x.nr_cirurgia = nr_cirurgia_p 
					and	coalesce(x.ie_situacao,'A') = 'A');
			if (cd_equipamento_w IS NOT NULL AND cd_equipamento_w::text <> '') then 
				nr_sequencia_w := gerar_equipamentos_cirurgia(cd_equipamento_w, nr_cirurgia_p, obter_pessoa_fisica_usuario(nm_usuario_p,'C'), nm_usuario_p, nr_sequencia_w, null, null, null, null, null);
				CALL gerar_taxa_equipamento(cd_estabelecimento_p, nr_sequencia_w, nm_usuario_p);
				CALL gerar_material_equipamento(cd_estabelecimento_p, nr_sequencia_w, nm_usuario_p);
			end if;
		end if;
	end;
end loop;
close C01;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_equip_agenda_cirurgica ( nr_cirurgia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

