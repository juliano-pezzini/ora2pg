-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_nom_rc_procedimento (nr_seq_cabecalho_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_atendimento_w 		nom_rc_cabecalho.nr_atendimento%type;
nr_seq_episodio_w		nom_rc_cabecalho.nr_seq_episodio%type;
cd_estabelecimento_w	nom_rc_cabecalho.cd_estabelecimento%type;
nm_completo_w			nom_rc_procedimento.nm_primeiro_nome%type;
dt_procedimento_utc_w 	varchar(255);
ds_cirurgia_char_w		varchar(32000);
nr_sequencia_descricao_w			cirurgia_descricao.nr_sequencia%type;
/*atributos da tabela*/

cd_procedimento_w		nom_rc_procedimento.cd_procedimento%type;/*id_312*/
ds_procedimento_w		nom_rc_procedimento.ds_procedimento%type;/*id_313/*/
ds_observacao_w 		varchar(4000);/*id_314 */
dt_procedimento_w 		nom_rc_procedimento.dt_procedimento%type;/*id_315*/
nr_crm_w				nom_rc_procedimento.nr_crm%type;		  /*id_316*/
nm_primeiro_nome_w		nom_rc_procedimento.nm_primeiro_nome%type;/*id_317*/
nm_sobrenome_pai_w		nom_rc_procedimento.nm_sobrenome_pai%type;/*id_318*/
nm_sobrenome_mae_w      nom_rc_procedimento.nm_sobrenome_mae%type;/*id_319*/
ie_servico_w			nom_rc_procedimento.ie_servico%type;	  /*id_320*/
ds_servico_w 			nom_rc_procedimento.ds_servico%type;	  /*id_321*/
qt_registro_w		bigint  := 0;
ds_html_w		varchar(32000)  := null;

c01 CURSOR FOR
/* Not surgical */

SELECT 	o.cd_sistema_ant cd_procedimento, 	/*id_312*/
		o.ds_procedimento ds_procedimento, 	/*id_313*/
		null nr_cirurgia,
		trim(both pp.ds_justificativa || ' ' || pp.ds_observacao) ds_complemento, 	/*id_314*/
        coalesce(pp.dt_prev_execucao,pp.dt_baixa) dt_entrada,			/*id_315*/
		substr(obter_crm_medico(m.cd_pessoa_fisica), 1, 255) nr_crm,					/*id_316*/
	
		z.ds_given_name nm_primeiro_nome,	/*id_317*/
		z.ds_family_name nm_sobrenome_pai,  /*id_318*/
		z.ds_component_name_1 nm_sobrenome_mae, 
        obter_nome_pf_html5(null,p.nr_seq_person_name,null,null) nm_completo,
		CASE WHEN setor.cd_classif_setor='1' THEN '1108-0' WHEN setor.cd_classif_setor='2' THEN '1096-7' WHEN setor.cd_classif_setor='3' THEN '1060-3' WHEN setor.cd_classif_setor='4' THEN '1024-9' WHEN setor.cd_classif_setor='5' THEN '1166-8' WHEN setor.cd_classif_setor='8' THEN '1192-4' WHEN setor.cd_classif_setor='9' THEN '1059-5' WHEN setor.cd_classif_setor='14' THEN '1174-2' WHEN setor.cd_classif_setor='15' THEN '1171-8' WHEN setor.cd_classif_setor='16' THEN '1204-7' END  ie_servico /*id_320*/
, 
        CASE WHEN setor.cd_classif_setor='1' THEN 'Urgencias' WHEN setor.cd_classif_setor='2' THEN 'Quir'|| chr(243) ||'fano' WHEN setor.cd_classif_setor='3' THEN 'Pabell'|| chr(243) ||'n de hospitalizaci'|| chr(243) ||'n' WHEN setor.cd_classif_setor='4' THEN 'Unidad de cuidados intensivos' WHEN setor.cd_classif_setor='5' THEN 'Centro de cirug'|| chr(237) ||'a ambulatoria' WHEN setor.cd_classif_setor='8' THEN 'Cuidados en casa' WHEN setor.cd_classif_setor='9' THEN 'Sala de trabajo, parto, recuperaci'|| chr(243) ||'n y postparto' WHEN setor.cd_classif_setor='14' THEN 'Servicios m'|| chr(243) ||'viles de urgencia' WHEN setor.cd_classif_setor='15' THEN 'Hospitalizaci'|| chr(243) ||'n en penal' WHEN setor.cd_classif_setor='16' THEN 'Ubicaci'|| chr(243) ||'n fuera del establecimiento de salud' END  ds_servico, /*id_321*/
		obter_data_utc(coalesce(pp.dt_prev_execucao,pp.dt_baixa),'NOM_TABLE') dt_procedimento_utc
FROM setor_atendimento setor, prescr_procedimento pp, prescr_medica pm, procedimento o, medico m, pessoa_fisica p
LEFT OUTER JOIN person_name z ON (p.nr_seq_person_name = z.nr_sequencia AND 'main' = z.ds_type)
WHERE m.cd_pessoa_fisica = pm.cd_medico AND m.cd_pessoa_fisica = p.cd_pessoa_fisica AND o.cd_procedimento = pp.cd_procedimento and setor.cd_setor_atendimento = pp.cd_setor_atendimento AND o.ie_origem_proced = 4   and (o.cd_sistema_ant IS NOT NULL AND o.cd_sistema_ant::text <> '') and pm.nr_prescricao = pp.nr_prescricao and not exists (SELECT 1 from cirurgia z where z.nr_prescricao = pm.nr_prescricao) and (pp.dt_baixa IS NOT NULL AND pp.dt_baixa::text <> '') and pm.nr_atendimento in (select	x.nr_atendimento
								from	nom_rc_cabecalho x
								where	x.nr_sequencia = nr_seq_cabecalho_p
								and		(x.nr_atendimento IS NOT NULL AND x.nr_atendimento::text <> '')
								
union

								select	y.nr_atendimento
								from	atendimento_paciente y,
									nom_rc_cabecalho x
								where	x.nr_seq_episodio = y.nr_seq_episodio
								and		x.nr_sequencia = nr_seq_cabecalho_p)
 
union all

/* Surgical - Other procedures */

SELECT 	o.cd_sistema_ant cd_procedimento, 	/*id_312*/
		o.ds_procedimento ds_procedimento, 	/*id_313*/
		c.nr_cirurgia nr_cirurgia,
		trim(both pp.ds_justificativa || ' ' || pp.ds_observacao) ds_complemento,
        pp.dt_prev_execucao,	/*id_315*/
		substr(obter_crm_medico(m.cd_pessoa_fisica), 1, 255) nr_crm,	/*id_316*/
		z.ds_given_name nm_primeiro_nome,	/*id_317*/
		z.ds_family_name nm_sobrenome_pai,  /*id_318*/
		z.ds_component_name_1 nm_sobrenome_mae, /*id_319*/
        obter_nome_pf_html5(null,p.nr_seq_person_name,null,null) nm_completo,
		CASE WHEN setor.cd_classif_setor='1' THEN '1108-0' WHEN setor.cd_classif_setor='2' THEN '1096-7' WHEN setor.cd_classif_setor='3' THEN '1060-3' WHEN setor.cd_classif_setor='4' THEN '1024-9' WHEN setor.cd_classif_setor='5' THEN '1166-8' WHEN setor.cd_classif_setor='8' THEN '1192-4' WHEN setor.cd_classif_setor='9' THEN '1059-5' WHEN setor.cd_classif_setor='14' THEN '1174-2' WHEN setor.cd_classif_setor='15' THEN '1171-8' WHEN setor.cd_classif_setor='16' THEN '1204-7' END  ie_servico, /*id_320*/
        obter_valor_dominio(9094,CASE WHEN setor.cd_classif_setor='1' THEN '1108-0' WHEN setor.cd_classif_setor='2' THEN '1096-7' WHEN setor.cd_classif_setor='3' THEN '1060-3' WHEN setor.cd_classif_setor='4' THEN '1024-9' WHEN setor.cd_classif_setor='5' THEN '1166-8' WHEN setor.cd_classif_setor='8' THEN '1192-4' WHEN setor.cd_classif_setor='9' THEN '1059-5' WHEN setor.cd_classif_setor='14' THEN '1174-2' WHEN setor.cd_classif_setor='15' THEN '1171-8' WHEN setor.cd_classif_setor='16' THEN '1204-7' END ) ds_servico, /*id_321*/
		obter_data_utc(coalesce(pp.dt_prev_execucao,c.dt_inicio_real),'NOM_TABLE') dt_procedimento_utc
FROM setor_atendimento setor, prescr_procedimento pp, procedimento o, medico m, cirurgia c, pessoa_fisica p
LEFT OUTER JOIN person_name z ON (p.nr_seq_person_name = z.nr_sequencia AND 'main' = z.ds_type)
WHERE c.ie_status_cirurgia <> '3' and (c.dt_inicio_real IS NOT NULL AND c.dt_inicio_real::text <> '') and setor.cd_setor_atendimento = obter_setor_cirurgia(c.nr_atendimento,c.dt_entrada_unidade) and c.nr_prescricao 	= pp.nr_prescricao AND pp.ie_origem_proced = 4 and m.cd_pessoa_fisica 	= c.cd_medico_cirurgiao AND m.cd_pessoa_fisica 	= p.cd_pessoa_fisica AND o.cd_procedimento	= pp.cd_procedimento and o.ie_origem_proced = pp.ie_origem_proced   and (o.cd_sistema_ant IS NOT NULL AND o.cd_sistema_ant::text <> '') and pp.cd_procedimento <> c.cd_procedimento_princ and c.nr_atendimento in (select	x.nr_atendimento
								from	nom_rc_cabecalho x
								where	x.nr_sequencia = nr_seq_cabecalho_p
								and		(x.nr_atendimento IS NOT NULL AND x.nr_atendimento::text <> '')
								
union

								select	y.nr_atendimento
								from	atendimento_paciente y,
									nom_rc_cabecalho x
								where	x.nr_seq_episodio = y.nr_seq_episodio
								and		x.nr_sequencia = nr_seq_cabecalho_p)
 
union all

select	o.cd_sistema_ant cd_procedimento, 	/*id_312*/
		o.ds_procedimento ds_procedimento, 	/*id_313*/
		c.nr_cirurgia,
		null ds_complemento,
        coalesce(c.dt_inicio_prevista,c.dt_inicio_real),	/*id_315*/
		substr(obter_crm_medico(m.cd_pessoa_fisica), 1, 255) nr_crm,	/*id_316*/
		z.ds_given_name nm_primeiro_nome,	/*id_317*/
		z.ds_family_name nm_sobrenome_pai,  /*id_318*/
		z.ds_component_name_1 nm_sobrenome_mae, /*id_319*/
        obter_nome_pf_html5(null,p.nr_seq_person_name,null,null) nm_completo,
		CASE WHEN setor.cd_classif_setor='1' THEN '1108-0' WHEN setor.cd_classif_setor='2' THEN '1096-7' WHEN setor.cd_classif_setor='3' THEN '1060-3' WHEN setor.cd_classif_setor='4' THEN '1024-9' WHEN setor.cd_classif_setor='5' THEN '1166-8' WHEN setor.cd_classif_setor='8' THEN '1192-4' WHEN setor.cd_classif_setor='9' THEN '1059-5' WHEN setor.cd_classif_setor='14' THEN '1174-2' WHEN setor.cd_classif_setor='15' THEN '1171-8' WHEN setor.cd_classif_setor='16' THEN '1204-7' END  ie_servico /*id_320*/
, 
        obter_valor_dominio(9094,CASE WHEN setor.cd_classif_setor='1' THEN '1108-0' WHEN setor.cd_classif_setor='2' THEN '1096-7' WHEN setor.cd_classif_setor='3' THEN '1060-3' WHEN setor.cd_classif_setor='4' THEN '1024-9' WHEN setor.cd_classif_setor='5' THEN '1166-8' WHEN setor.cd_classif_setor='8' THEN '1192-4' WHEN setor.cd_classif_setor='9' THEN '1059-5' WHEN setor.cd_classif_setor='14' THEN '1174-2' WHEN setor.cd_classif_setor='15' THEN '1171-8' WHEN setor.cd_classif_setor='16' THEN '1204-7' END ) ds_servico, /*id_321*/
		obter_data_utc(coalesce(c.dt_inicio_prevista,c.dt_inicio_real),'NOM_TABLE') dt_procedimento_utc
FROM setor_atendimento setor, procedimento o, medico m, cirurgia c, atendimento_paciente b, pessoa_fisica p
LEFT OUTER JOIN person_name z ON (p.nr_seq_person_name = z.nr_sequencia AND 'main' = z.ds_type)
WHERE c.ie_status_cirurgia <> '3' and (c.dt_inicio_real IS NOT NULL AND c.dt_inicio_real::text <> '') and setor.cd_setor_atendimento = obter_setor_cirurgia(c.nr_atendimento,c.dt_entrada_unidade) and c.nr_atendimento = b.nr_atendimento and m.cd_pessoa_fisica = c.cd_medico_cirurgiao AND m.cd_pessoa_fisica = p.cd_pessoa_fisica AND o.cd_procedimento = c.cd_procedimento_princ AND o.ie_origem_proced = 4   AND (o.cd_sistema_ant IS NOT NULL AND o.cd_sistema_ant::text <> '') and c.nr_atendimento in (select	x.nr_atendimento
								from	nom_rc_cabecalho x
								where	x.nr_sequencia = nr_seq_cabecalho_p
								and		(x.nr_atendimento IS NOT NULL AND x.nr_atendimento::text <> '')
								
union

								select	y.nr_atendimento
								from	atendimento_paciente y,
										nom_rc_cabecalho x
								where	x.nr_seq_episodio = y.nr_seq_episodio
								and		x.nr_sequencia = nr_seq_cabecalho_p);	

BEGIN

delete from nom_rc_procedimento
where nr_seq_cabecalho = nr_seq_cabecalho_p;

select	a.nr_atendimento,
		a.nr_seq_episodio,
		a.cd_estabelecimento
into STRICT	nr_atendimento_w,
		nr_seq_episodio_w,	
		cd_estabelecimento_w	
from	nom_rc_cabecalho a
where	a.nr_sequencia	= nr_seq_cabecalho_p;


if	((coalesce(nr_atendimento_w::text, '') = '') and (nr_seq_episodio_w IS NOT NULL AND nr_seq_episodio_w::text <> '')) then
	select	min(nr_atendimento)
	into STRICT	nr_atendimento_w
	from	atendimento_paciente a
	where	a.nr_seq_episodio = nr_seq_episodio_w;
end if;

if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then		

	ds_html_w	:= '<table class="wrichedit-table" width="100%" xmlns="urn:hl7-org:v3">';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || '<thead>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '<tr>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Fecha</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>CIE9-MC</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Procedimiento</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>M'|| chr(233) ||'dico</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Servicio</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Observaciones</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '</tr>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) ||  '</thead>';

	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || '<tbody>';
	for	r_c_procedimentos in c01 loop

		qt_registro_w	:= qt_registro_w + 1;

		ds_observacao_w 		:=  r_c_procedimentos.ds_complemento;

		if (r_c_procedimentos.nr_cirurgia IS NOT NULL AND r_c_procedimentos.nr_cirurgia::text <> '') and (coalesce(ds_observacao_w::text, '') = '') then
			select  max(nr_sequencia)
			into STRICT	nr_sequencia_descricao_w
			from    cirurgia_descricao x
			where	x.nr_cirurgia = r_c_procedimentos.nr_cirurgia
			and		(ds_cirurgia IS NOT NULL AND ds_cirurgia::text <> '')
			and		(x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '')
			and		coalesce(x.dt_inativacao::text, '') = '';

			if (nr_sequencia_descricao_w IS NOT NULL AND nr_sequencia_descricao_w::text <> '') then
				select 	convert_long_to_varchar2('ds_cirurgia', 'cirurgia_descricao', 'nr_sequencia = ' || nr_sequencia_descricao_w)
				into STRICT 	ds_cirurgia_char_w
				;

				select 	remove_html_from_text(ds_cirurgia_char_w)
				into STRICT 	ds_observacao_w
				;
			end if;
		end if;

		cd_procedimento_w		:= 	r_c_procedimentos.cd_procedimento;
		ds_procedimento_w		:=	r_c_procedimentos.ds_procedimento;
		dt_procedimento_w 		:= 	r_c_procedimentos.dt_entrada;
		nr_crm_w			    :=  r_c_procedimentos.nr_crm;
		nm_primeiro_nome_w		:= 	r_c_procedimentos.nm_primeiro_nome;
		nm_sobrenome_pai_w		:= 	r_c_procedimentos.nm_sobrenome_pai;
		nm_sobrenome_mae_w  	:= 	r_c_procedimentos.nm_sobrenome_mae;
		dt_procedimento_utc_w 	:= 	r_c_procedimentos.dt_procedimento_utc;
		nm_completo_w			:= 	r_c_procedimentos.nm_completo;
		ie_servico_w			:= r_c_procedimentos.ie_servico;
		ds_servico_w			:= r_c_procedimentos.ds_servico;


		insert into nom_rc_procedimento(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_cabecalho,
			cd_procedimento,
			ds_procedimento,
			ds_observacao,
			dt_procedimento,
			nr_crm,
			nm_primeiro_nome,
			nm_sobrenome_pai,
			nm_sobrenome_mae,
			ie_servico,
			ds_servico)

		values (
			nextval('nom_rc_procedimento_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_cabecalho_p,
			cd_procedimento_w,
			ds_procedimento_w,
			ds_observacao_w,
			dt_procedimento_w,
			nr_crm_w,
			nm_primeiro_nome_w,
			nm_sobrenome_pai_w,
			nm_sobrenome_mae_w,
			ie_servico_w,
			ds_servico_w);
		if (length(ds_html_w) < 31000) then

			ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '<tr>';

			ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || dt_procedimento_utc_w || '</td>';
			ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || cd_procedimento_w || '</td>';
			ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || ds_procedimento_w || '</td>';
			ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || nm_completo_w || ' - ' || nr_crm_w || '</td>';
			ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || ds_servico_w || '</td>';
			ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || ds_observacao_w || '</td>';	

			ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '</tr>';

    		end if;

	end loop;

	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || '</tbody>';

	ds_html_w	:= ds_html_w || chr(13) || chr(10) || '</table>';

	if (qt_registro_w > 0) then

		insert into nom_rc_procedimento(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_procedimentos,
			nr_seq_cabecalho)
		values (nextval('nom_rc_procedimento_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			ds_html_w,
			nr_seq_cabecalho_p);
	end if;

end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_nom_rc_procedimento (nr_seq_cabecalho_p bigint, nm_usuario_p text) FROM PUBLIC;

