-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_update_special_diet ( ds_lista_dieta_p text, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint ) AS $body$
DECLARE




    nr_sequencia_w        bigint;
    nr_atendimento_w      bigint;
    ds_lista_w            varchar(1000) := '';
    tam_lista_w           bigint;
    ie_pos_virgula_w      smallint;
    qtd_enteral_w         bigint;
    qtd_total_enteral_w   bigint := 0;
    qt_maximo_enteral_w   bigint := 0;
    sql_update            varchar(1000) := '';
    update_list           varchar(1000) := '';
    update_sequences      varchar(1000) := '';

BEGIN
    SELECT
        coalesce(obter_valor_param_usuario(2314, 59, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p), 99)
    INTO STRICT qt_maximo_enteral_w
;



    ds_lista_w := ds_lista_dieta_p;
    IF ( substr(ds_lista_w, length(ds_lista_w) - 1, length(ds_lista_w)) <> ',' ) THEN
        ds_lista_w := ds_lista_w || ',';
    END IF;



    WHILE(ds_lista_w IS NOT NULL AND ds_lista_w::text <> '') LOOP BEGIN
        tam_lista_w := length(ds_lista_w);
        ie_pos_virgula_w := position(',' in ds_lista_w);
        IF ( ie_pos_virgula_w <> 0 ) THEN
            nr_sequencia_w := (substr(ds_lista_w, 1,(ie_pos_virgula_w - 1)))::numeric;



            ds_lista_w := substr(ds_lista_w,(ie_pos_virgula_w + 1), tam_lista_w);
        END IF;



        SELECT
            COUNT(*)
        INTO STRICT qtd_enteral_w
        FROM
            cpoe_dieta cd
        WHERE
            cd.ie_tipo_dieta = 'E'
            AND cd.nr_sequencia IN (
                nr_sequencia_w
            );



        IF ( qtd_enteral_w > 0 ) THEN
            qtd_total_enteral_w := qtd_total_enteral_w + 1;
            update_list := update_list
                           || to_char(nr_sequencia_w)
                           || ',';
        END IF;



    END;
    END LOOP;



    update_sequences := substr(update_list, 1, length(update_list) - 1);
    IF ( qtd_total_enteral_w > qt_maximo_enteral_w ) THEN
        sql_update := 'UPDATE cpoe_dieta SET ie_dieta_especial = :1 ';
        sql_update := sql_update
                      || ' WHERE ie_tipo_dieta = :2 AND nr_sequencia IN ('
                      || update_sequences
                      || ')';
        EXECUTE sql_update
            USING 'N', 'E';
        COMMIT;
        CALL wheb_mensagem_pck.exibir_mensagem_abort(1159942);
    END IF;



END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_update_special_diet ( ds_lista_dieta_p text, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint ) FROM PUBLIC;

