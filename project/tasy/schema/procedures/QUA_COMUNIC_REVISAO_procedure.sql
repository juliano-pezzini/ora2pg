-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qua_comunic_revisao ( nr_sequencia_p bigint, ds_observacao_p text, cd_setor_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ds_titulo_w			varchar(255);
cd_documento_w		varchar(20);
cd_pessoa_revisao_w		varchar(10);
nm_usuario_w			varchar(15);
nr_sequencia_w		bigint;
nr_seq_classif_w		bigint;
nm_pessoa_w			varchar(100);
ds_arquivo_w			varchar(255);
ds_aviso_w			varchar(255);
nm_documento_w		varchar(255);

C01 CURSOR FOR 
	SELECT	cd_pessoa_revisao 
	from	qua_doc_revisao 
	where	nr_seq_doc = nr_sequencia_p 
	
union
 
	SELECT	coalesce(max(cd_pessoa_elaboracao),'') 
	from	qua_documento 
	where	nr_sequencia = nr_sequencia_p 
	
union
 
	select	coalesce(max(cd_pessoa_validacao),'') 
	from	qua_documento 
	where	nr_sequencia = nr_sequencia_p 
	
union
 
	select	coalesce(max(cd_pessoa_aprov),'') 
	from	qua_documento 
	where	nr_sequencia = nr_sequencia_p 
	
union
 
	select	cd_pessoa_fisica 
	from	usuario 
	where	cd_setor_atendimento = cd_setor_atendimento_p;


BEGIN 
 
select	cd_documento, 
	ds_arquivo, 
	nm_documento 
into STRICT	cd_documento_w, 
	ds_arquivo_w, 
	nm_documento_w 
from	qua_documento 
where	nr_sequencia		= nr_sequencia_p;
 
ds_titulo_w	:= Wheb_mensagem_pck.get_texto(799461) || ' ' || cd_documento_w || ' - ' || nm_documento_w;
 
select	obter_classif_comunic('F') 
into STRICT	nr_seq_classif_w
;
 
OPEN C01;
LOOP 
FETCH C01 into 
	cd_pessoa_revisao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	select	min(nm_usuario) 
	into STRICT	nm_usuario_w 
	from	usuario b 
	where	cd_pessoa_fisica	= cd_pessoa_revisao_w;
 
	if (nm_usuario_w IS NOT NULL AND nm_usuario_w::text <> '') then 
		begin 
		ds_aviso_w	:= Wheb_mensagem_pck.get_texto(799460) || chr(13) || chr(10) || 
				Wheb_mensagem_pck.get_texto(799461);
 
		if (ds_arquivo_w IS NOT NULL AND ds_arquivo_w::text <> '') then 
			ds_aviso_w	:= ds_aviso_w || chr(13) || chr(10) || 
					  Wheb_mensagem_pck.get_texto(799462) || ' ' || ds_arquivo_w;
		end if;
 
		select	nextval('comunic_interna_seq') 
		into STRICT	nr_sequencia_w 
		;
		select	substr(obter_nome_pessoa_fisica(cd_pessoa_revisao_w, null),1,100) 
		into STRICT	nm_pessoa_w 
		;
		insert into comunic_interna( 
			dt_comunicado, ds_titulo, ds_comunicado, nm_usuario, 
			dt_atualizacao, ie_geral, nm_usuario_destino, nr_sequencia, 
			ie_gerencial, nr_seq_classif, dt_liberacao) 
		values ( 
			clock_timestamp(), ds_titulo_w, ds_aviso_w || chr(13) || chr(10) || ds_observacao_p, nm_usuario_p, 
			clock_timestamp(), 'N', nm_usuario_w, nr_sequencia_w, 'N', 
			nr_seq_classif_w, clock_timestamp());
		end;
 
	Insert into qua_doc_envio( 
		nr_sequencia, nr_seq_doc, dt_atualizacao, nm_usuario, 
		dt_envio, ie_tipo_envio, ds_destino, ds_observacao) 
	values (nextval('qua_doc_envio_seq'), nr_sequencia_p, clock_timestamp(), nm_usuario_p, 
		clock_timestamp(), 'D', nm_pessoa_w, ds_aviso_w);
	end if;
	end;
END LOOP;
CLOSE C01;
 
commit;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qua_comunic_revisao ( nr_sequencia_p bigint, ds_observacao_p text, cd_setor_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

