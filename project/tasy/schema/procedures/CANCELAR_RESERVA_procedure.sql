-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cancelar_reserva (nr_seq_reserva_p bigint, vl_cancelamento_p bigint, vl_multa_p bigint, ds_motivo_cancelamento_p text, ie_tipo_reserva_p text, nm_usuario_p text) AS $body$
DECLARE


vl_total_hotel_w	bigint;


BEGIN

vl_total_hotel_w:= coalesce(Obter_valor_total_hotel(nr_seq_reserva_p),0);

update	via_reserva
set	ie_cancelamento = 'C',
	ds_motivo_cancelamento = ds_motivo_cancelamento_p,
	vl_cancelamento = coalesce(vl_cancelamento_p,0),
	vl_multa = vl_multa_p,
	nm_usuario = nm_usuario_p,
	vl_saldo_reserva = coalesce(CASE WHEN ie_tipo_reserva_p='H' THEN  vl_total_hotel_w - coalesce(vl_multa_p,0)  ELSE coalesce(vl_reserva,0) - coalesce(vl_multa_p,0) END ,0),
	dt_atualizacao = clock_timestamp()
where 	nr_sequencia = nr_seq_reserva_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cancelar_reserva (nr_seq_reserva_p bigint, vl_cancelamento_p bigint, vl_multa_p bigint, ds_motivo_cancelamento_p text, ie_tipo_reserva_p text, nm_usuario_p text) FROM PUBLIC;

