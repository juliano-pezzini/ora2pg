-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_status_agenda_dia_cons ( nr_sequencia_p bigint, ie_status_agenda_p text, nm_usuario_p text) AS $body$
DECLARE


qt_hor_cancel_w		bigint;
dt_agenda_w		timestamp;
cd_agenda_w		bigint;
qt_reg_w		smallint;
nr_seq_hora_w		agenda_consulta.nr_seq_hora%type;

BEGIN

if (coalesce(nr_sequencia_p,0) > 0) and (ie_status_agenda_p IS NOT NULL AND ie_status_agenda_p::text <> '')then

	SELECT	MAX(dt_agenda),
		max(cd_agenda)
	INTO STRICT	dt_agenda_w,
		cd_agenda_w
	FROM	agenda_consulta
	WHERE	nr_sequencia = nr_sequencia_p;

	select	coalesce(max((to_char(dt_agenda,'ss'))::numeric ),0)+1
	into STRICT	qt_hor_cancel_w
	from	agenda_consulta
	where	cd_agenda = cd_agenda_w
	and	to_date(to_char(dt_agenda,'dd/mm/yyyy hh24:mi') || ':00', 'dd/mm/yyyy hh24:mi:ss') = to_date(to_char(dt_agenda_w,'dd/mm/yyyy hh24:mi') || ':00', 'dd/mm/yyyy hh24:mi:ss')
	and	ie_status_agenda = 'C';

	select 	coalesce(max(1), 0)
	into STRICT	qt_reg_w
	from 	agenda_consulta
	where	cd_agenda = cd_agenda_w
	and 	dt_agenda = dt_agenda_w + qt_hor_cancel_w / 86400;

	if (qt_reg_w > 0) then
		select 	coalesce(max(nr_seq_hora), 0) + 1
		into STRICT	nr_seq_hora_w
		from 	agenda_consulta
		where 	cd_agenda = cd_agenda_w
		and 	dt_agenda = dt_agenda_w + qt_hor_cancel_w / 86400;

		update	agenda_consulta
		set	ie_status_agenda 		= ie_status_agenda_p,
			nm_usuario_cancelamento		= nm_usuario_p,
			dt_cancelamento			= clock_timestamp(),
			dt_Agenda			= dt_agenda + qt_hor_cancel_w / 86400,
			nr_seq_hora			= nr_seq_hora_w
		where	nr_sequencia			= nr_sequencia_p;
	else
		update	agenda_consulta
		set	ie_status_agenda 		= ie_status_agenda_p,
			nm_usuario_cancelamento		= nm_usuario_p,
			dt_cancelamento			= clock_timestamp(),
			dt_Agenda			= dt_agenda + qt_hor_cancel_w / 86400
		where	nr_sequencia			= nr_sequencia_p;
	end if;

	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_status_agenda_dia_cons ( nr_sequencia_p bigint, ie_status_agenda_p text, nm_usuario_p text) FROM PUBLIC;

