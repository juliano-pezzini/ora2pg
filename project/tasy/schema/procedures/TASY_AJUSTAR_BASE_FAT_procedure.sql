-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_ajustar_base_fat ( nm_usuario_p text) AS $body$
DECLARE


dt_versao_atual_cliente_w 	timestamp;
qt_registro_w			bigint;
qt_reg_ind_erro_W		bigint;
qt_indice_w			bigint;
qt_duplicidade_w		bigint;
qt_reg_inconsistentes_w		bigint;


BEGIN

CALL abortar_se_base_wheb();

dt_versao_atual_cliente_w := coalesce(to_date(to_char(obter_data_geracao_versao-1,'dd/mm/yyyy') ||' 23:59:59','dd/mm/yyyy hh24:mi:ss'),clock_timestamp() - interval '90 days');

if (dt_versao_atual_cliente_w < to_date('06/12/2010','dd/mm/yyyy')) then
	select 	count(*)
	into STRICT	qt_registro_w
	from 	user_indexes
	where 	index_name = 'TFLOLIG_I1';

	if (qt_registro_w > 0) then
		CALL Exec_Sql_Dinamico('Fabricio','drop index TFLOLIG_I1');
	end if;
end if;

if (dt_versao_atual_cliente_w < to_date('25/05/2011','dd/mm/yyyy')) then
	CALL BACA_CONVENIO_BLOQUEIO_PK();
end if;

if (dt_versao_atual_cliente_w < to_date('21/06/2011','dd/mm/yyyy')) then
	CALL Exec_Sql_Dinamico('alheckmann','delete	valor_dominio ' ||
					' where 	cd_dominio = 121 ' ||
					' and    	vl_dominio = 3 ' ||
					' and    	lower(ds_valor_dominio) like ''%heckmann%'' ' ||
					' and	not exists (	select	1 from	orcamento_paciente where cd_motivo_cancelamento = 3)');
end if;

/* Heckmann em 02/08/2011 */

if (dt_versao_atual_cliente_w	< to_date('02/08/2011','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	interface
	where	cd_interface = 2111;
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('alheckmann', 'insert into interface (select * from tasy_versao.interface where cd_interface = 2111)');
		CALL Exec_Sql_Dinamico('alheckmann', 'insert into interface_reg (select * from tasy_versao.interface_reg where cd_interface = 2111)');
		CALL Exec_Sql_Dinamico('alheckmann', 'insert into interface_atributo (select * from tasy_versao.interface_atributo where cd_interface = 2111)');
	end if;
end if;

/* Heckmann em 17/08/2011 */

if (dt_versao_atual_cliente_w	< to_date('17/08/2011','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	interface
	where	cd_interface = 2117;
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('alheckmann', 'insert into interface (select * from tasy_versao.interface where cd_interface = 2117)');
		CALL Exec_Sql_Dinamico('alheckmann', 'insert into interface_reg (select * from tasy_versao.interface_reg where cd_interface = 2117)');
		CALL Exec_Sql_Dinamico('alheckmann', 'insert into interface_atributo (select * from tasy_versao.interface_atributo where cd_interface = 2117)');
	end if;
end if;

/* Heckmann em 29/08/2011 */

if (dt_versao_atual_cliente_w	< to_date('29/08/2011','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	interface
	where	cd_interface = 2125;
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('alheckmann', 'insert into interface (select * from tasy_versao.interface where cd_interface = 2125)');
		CALL Exec_Sql_Dinamico('alheckmann', 'insert into interface_reg (select * from tasy_versao.interface_reg where cd_interface = 2125)');
		CALL Exec_Sql_Dinamico('alheckmann', 'insert into interface_atributo (select * from tasy_versao.interface_atributo where cd_interface = 2125)');
	end if;
end if;


/* Heckmann em 08/09/2011 */

if (dt_versao_atual_cliente_w	< to_date('08/09/2011','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	interface
	where	cd_interface = 2081;
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('alheckmann', 'insert into interface (select * from tasy_versao.interface where cd_interface = 2081)');
		CALL Exec_Sql_Dinamico('alheckmann', 'insert into interface_reg (select * from tasy_versao.interface_reg where cd_interface = 2081)');
		CALL Exec_Sql_Dinamico('alheckmann', 'insert into interface_atributo (select * from tasy_versao.interface_atributo where cd_interface = 2081)');
	end if;
end if;

/* Heckmann em 04/10/2011 */

if (dt_versao_atual_cliente_w	< to_date('04/10/2011','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	interface
	where	cd_interface = 2164;
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('alheckmann', 'insert into interface (select * from tasy_versao.interface where cd_interface = 2164)');
		CALL Exec_Sql_Dinamico('alheckmann', 'insert into interface_reg (select * from tasy_versao.interface_reg where cd_interface = 2164)');
		CALL Exec_Sql_Dinamico('alheckmann', 'insert into interface_atributo (select * from tasy_versao.interface_atributo where cd_interface = 2164)');
	end if;
end if;

/* Heckmann em 16/12/2011 */

if (dt_versao_atual_cliente_w	< to_date('16/12/2011','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	interface
	where	cd_interface = 2202;
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('alheckmann', 'insert into interface (select * from tasy_versao.interface where cd_interface = 2202)');
		CALL Exec_Sql_Dinamico('alheckmann', 'insert into interface_reg (select * from tasy_versao.interface_reg where cd_interface = 2202)');
		CALL Exec_Sql_Dinamico('alheckmann', 'insert into interface_atributo (select * from tasy_versao.interface_atributo where cd_interface = 2202)');
	end if;
end if;

/* Heckmann em 28/03/2012 */

if (dt_versao_atual_cliente_w	< to_date('28/03/2012','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	interface
	where	cd_interface = 2239;
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('alheckmann', 'insert into interface (select * from tasy_versao.interface where cd_interface = 2239)');
		CALL Exec_Sql_Dinamico('alheckmann', 'insert into interface_reg (select * from tasy_versao.interface_reg where cd_interface = 2239)');
		CALL Exec_Sql_Dinamico('alheckmann', 'insert into interface_atributo (select * from tasy_versao.interface_atributo where cd_interface = 2239)');
	end if;
end if;

/* Kristofher 25/07/2016*/

if (dt_versao_atual_cliente_w	< to_date('25/07/2016','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	interface
	where	cd_interface = 2771;
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('kaschneider', 'insert into interface (select * from tasy_versao.interface where cd_interface = 2771)');
		CALL Exec_Sql_Dinamico('kaschneider', 'insert into interface_reg (select * from tasy_versao.interface_reg where cd_interface = 2771)');
		CALL Exec_Sql_Dinamico('kaschneider', 'insert into interface_atributo (select * from tasy_versao.interface_atributo where cd_interface = 2771)');
	end if;
end if;
/* Kristofher 25/10/2016*/

if (dt_versao_atual_cliente_w	< to_date('25/10/2016','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	interface
	where	cd_interface = 2808;
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('kaschneider', 'insert into interface (select * from tasy_versao.interface where cd_interface = 2808)');
		CALL Exec_Sql_Dinamico('kaschneider', 'insert into interface_reg (select * from tasy_versao.interface_reg where cd_interface = 2808)');
		CALL Exec_Sql_Dinamico('kaschneider', 'insert into interface_atributo (select * from tasy_versao.interface_atributo where cd_interface = 2808)');
	end if;
end if;
/* Kristofher 25/10/2016*/

if (dt_versao_atual_cliente_w	< to_date('25/10/2016','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	interface
	where	cd_interface = 2809;
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('kaschneider', 'insert into interface (select * from tasy_versao.interface where cd_interface = 2809)');
		CALL Exec_Sql_Dinamico('kaschneider', 'insert into interface_reg (select * from tasy_versao.interface_reg where cd_interface = 2809)');
		CALL Exec_Sql_Dinamico('kaschneider', 'insert into interface_atributo (select * from tasy_versao.interface_atributo where cd_interface = 2809)');
	end if;
end if;
/* Matheus em 28/03/2012 */

if (dt_versao_atual_cliente_w	< to_date('19/02/2016','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	interface
	where	cd_interface = 2687;
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('mpsoares', 'insert into interface (select * from tasy_versao.interface where cd_interface = 2687)');
		CALL Exec_Sql_Dinamico('mpsoares', 'insert into interface_reg (select * from tasy_versao.interface_reg where cd_interface = 2687)');
		CALL Exec_Sql_Dinamico('mpsoares', 'insert into interface_atributo (select * from tasy_versao.interface_atributo where cd_interface = 2687)');
	end if;
end if;

/* Matheus em 28/03/2012 */

if (dt_versao_atual_cliente_w	< to_date('19/02/2016','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	interface
	where	cd_interface = 2730;
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('mpsoares', 'insert into interface (select * from tasy_versao.interface where cd_interface = 2730)');
		CALL Exec_Sql_Dinamico('mpsoares', 'insert into interface_reg (select * from tasy_versao.interface_reg where cd_interface = 2730)');
		CALL Exec_Sql_Dinamico('mpsoares', 'insert into interface_atributo (select * from tasy_versao.interface_atributo where cd_interface = 2730)');
	end if;
end if;

/* Matheus em 28/03/2012 */

if (dt_versao_atual_cliente_w	< to_date('19/02/2016','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	interface
	where	cd_interface = 2733;
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('mpsoares', 'insert into interface (select * from tasy_versao.interface where cd_interface = 2733)');
		CALL Exec_Sql_Dinamico('mpsoares', 'insert into interface_reg (select * from tasy_versao.interface_reg where cd_interface = 2733)');
		CALL Exec_Sql_Dinamico('mpsoares', 'insert into interface_atributo (select * from tasy_versao.interface_atributo where cd_interface = 2733)');
	end if;
end if;

if (dt_versao_atual_cliente_w < to_date('05/08/2011','dd/mm/yyyy')) then
	CALL BACA_CONVENIO_SERVICO_PK();
end if;

if (dt_versao_atual_cliente_w < to_date('28/10/2011','dd/mm/yyyy')) then

	select 	count(*)
	into STRICT	qt_reg_ind_erro_W
	from 	user_constraints
	where 	constraint_name = 'EMPREFE_UK'
	and 	index_name = 'EMPREFE_PESJURI_FK_I';

	if (qt_reg_ind_erro_W > 0) then
		CALL Exec_Sql_Dinamico('Fabricio','alter table empresa_referencia drop constraint EMPREFE_UK');
	end if;

	select 	count(*)
	into STRICT	qt_reg_ind_erro_W
	from 	user_constraints
	where 	constraint_name = 'EMPREFE_UK'
	and 	index_name = 'EMPREFE_PESJURI_FK_I';

	if (qt_reg_ind_erro_W = 0) then --Se conseguiu dropar
		select 	count(*)
		into STRICT	qt_indice_w
		from 	user_indexes
		where 	index_name = 'EMPREFE_PESJURI_FK_I';

		if (qt_indice_w > 0) then
			CALL Exec_Sql_Dinamico('Fabricio','drop index EMPREFE_PESJURI_FK_I');
		end if;

		select 	count(*)
		into STRICT	qt_indice_w
		from 	user_indexes
		where 	index_name = 'EMPREFE_PESJURI_FK_I';

		if (qt_indice_w = 0) then --Se conseguiu dropar
			select 	count(distinct cd_cgc)
			into STRICT	qt_duplicidade_w
			from (SELECT count(*),
					cd_cgc
				from 	empresa_referencia
				where 	1 = 1
				and 	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
				group by cd_cgc
				having count(*) > 1) alias5;

			select 	count(*)
			into STRICT	qt_registro_w
			from 	user_constraints
			where 	constraint_name = 'EMPREFE_UK';

			if (qt_duplicidade_w = 0) and (qt_registro_w = 0) then
				CALL Exec_Sql_Dinamico('Fabricio','Alter Table EMPRESA_REFERENCIA add (Constraint EMPREFE_UK Unique (CD_CGC))');
			end if;
		end if;
	end if;
end if;


if (dt_versao_atual_cliente_w < to_date('29/03/2012','dd/mm/yyyy')) then

	select 	count(*)
	into STRICT	qt_reg_ind_erro_W
	from 	user_constraints
	where 	constraint_name = 'PREMATE_NOTFIIT_FK'
	and 	status = 'DISABLED';

	if (qt_reg_ind_erro_W > 0) then -- Tem a integridade e está desabilitada
		 select count(*)
		 into STRICT	qt_reg_inconsistentes_w
		 from 	PRECO_MATERIAL a
		 where 	not exists ( 	SELECT 	1
					from 	NOTA_FISCAL_ITEM b
					where 	1 = 1
					and 	a.NR_SEQUENCIA_NF = b.NR_SEQUENCIA
					and 	a.NR_ITEM_NF = b.NR_ITEM_NF
				   )
		 and 	(a.NR_SEQUENCIA_NF IS NOT NULL AND a.NR_SEQUENCIA_NF::text <> '')
		 and 	(a.NR_ITEM_NF IS NOT NULL AND a.NR_ITEM_NF::text <> '');

		if (qt_reg_inconsistentes_w > 0) then

			update PRECO_MATERIAL a
			set    a.NR_SEQUENCIA_NF  = NULL,
			       a.NR_ITEM_NF  = NULL
			where  not exists ( 	SELECT 	1
						from 	NOTA_FISCAL_ITEM b
						where 	1 = 1
						and 	a.NR_SEQUENCIA_NF = b.NR_SEQUENCIA
						and 	a.NR_ITEM_NF = b.NR_ITEM_NF
					   )
			and 	(a.NR_SEQUENCIA_NF IS NOT NULL AND a.NR_SEQUENCIA_NF::text <> '')
			and 	(a.NR_ITEM_NF IS NOT NULL AND a.NR_ITEM_NF::text <> '');

			commit;

		end if;

		CALL Exec_Sql_Dinamico('Fabricio','alter table preco_material enable constraint PREMATE_NOTFIIT_FK');

	end if;
end if;


if (dt_versao_atual_cliente_w < to_date('02/05/2012','dd/mm/yyyy')) then

	select	count(*)
	into STRICT	qt_registro_w
	FROM	USER_CONSTRAINTS
	WHERE	CONSTRAINT_NAME = 'PESDOCU_UK';
	begin
	if (qt_registro_w	> 0) then
		CALL Exec_sql_Dinamico('Fabrício','Alter Table PESSOA_DOCUMENTACAO Drop Constraint PESDOCU_UK');
	end if;
	exception
	when others then
		qt_registro_w	:= qt_registro_w;
	end;

	select	count(*)
	into STRICT	qt_registro_w
	FROM	USER_INDEXES
	WHERE	INDEX_NAME = 'PESDOCU_UK';
	begin
	if (qt_registro_w	> 0) then
		CALL Exec_sql_Dinamico('Fabrício','DROP INDEX PESDOCU_UK');
	end if;
	exception
	when others then
		qt_registro_w	:= qt_registro_w;
	end;

end if;


if (dt_versao_atual_cliente_w < to_date('04/07/2012','dd/mm/yyyy')) then

	select 	count(*)
	into STRICT	qt_registro_w
	from 	brasindice_preco
	where 	coalesce(nr_sequencia::text, '') = '';

	if (qt_registro_w = 0) then
		CALL BACA_BRASINDICE_PRECO_PK3();
	end if;
end if;

if (dt_versao_atual_cliente_w < to_date('04/07/2012','dd/mm/yyyy')) then
	CALL BACA_MEDICO_CONVENIO_UK();
end if;

/* Fabrício em 12/07/2012 */

if (dt_versao_atual_cliente_w	< to_date('12/07/2012','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	interface
	where	cd_interface = 1557;
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface (select * from tasy_versao.interface where cd_interface =1557)');
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface_reg (select * from tasy_versao.interface_reg where cd_interface = 1557)');
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface_atributo (select * from tasy_versao.interface_atributo where cd_interface = 1557)');
	end if;
end if;

/* Fabrício em 12/07/2012 */

if (dt_versao_atual_cliente_w	< to_date('12/07/2012','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	interface
	where	cd_interface = 1314;
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface (select * from tasy_versao.interface where cd_interface =1314)');
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface_reg (select * from tasy_versao.interface_reg where cd_interface = 1314)');
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface_atributo (select * from tasy_versao.interface_atributo where cd_interface = 1314)');
	end if;
end if;


if (dt_versao_atual_cliente_w	< to_date('15/09/2012','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	interface
	where	cd_interface = 2354;
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface (select * from tasy_versao.interface where cd_interface =2354)');
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface_reg (select * from tasy_versao.interface_reg where cd_interface = 2354)');
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface_atributo (select * from tasy_versao.interface_atributo where cd_interface = 2354)');
	end if;
end if;


if (dt_versao_atual_cliente_w	< to_date('02/10/2012','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	interface
	where	cd_interface = 2370;
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface (select * from tasy_versao.interface where cd_interface =2370)');
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface_reg (select * from tasy_versao.interface_reg where cd_interface = 2370)');
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface_atributo (select * from tasy_versao.interface_atributo where cd_interface = 2370)');
	end if;
end if;

if (dt_versao_atual_cliente_w	< to_date('17/10/2012','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	interface
	where	cd_interface = 2373;
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface (select * from tasy_versao.interface where cd_interface =2373)');
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface_reg (select * from tasy_versao.interface_reg where cd_interface = 2373)');
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface_atributo (select * from tasy_versao.interface_atributo where cd_interface = 2373)');
	end if;
end if;

if (dt_versao_atual_cliente_w	< to_date('26/10/2012','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	interface
	where	cd_interface = 2380;
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface (select * from tasy_versao.interface where cd_interface =2380)');
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface_reg (select * from tasy_versao.interface_reg where cd_interface = 2380)');
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface_atributo (select * from tasy_versao.interface_atributo where cd_interface = 2380)');
	end if;
end if;

if (dt_versao_atual_cliente_w < to_date('25/04/2013','dd/mm/yyyy')) then

	select	count(*)
	into STRICT	qt_registro_w
	FROM	USER_CONSTRAINTS
	WHERE	CONSTRAINT_NAME = 'MATBRAS_UK';
	begin
	if (qt_registro_w	> 0) then
		CALL Exec_sql_Dinamico('Tasy','Alter Table MATERIAL_BRASINDICE Drop Constraint MATBRAS_UK');
	end if;
	exception
	when others then
		qt_registro_w	:= qt_registro_w;
	end;

	select	count(*)
	into STRICT	qt_registro_w
	FROM	USER_INDEXES
	WHERE	INDEX_NAME = 'MATBRAS_UK';
	begin
	if (qt_registro_w	> 0) then
		CALL Exec_sql_Dinamico('Tasy','DROP INDEX MATBRAS_UK');
	end if;
	exception
	when others then
		qt_registro_w	:= qt_registro_w;
	end;

end if;

if (dt_versao_atual_cliente_w	< to_date('04/07/2013','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	interface
	where	cd_interface in (2463, 2464, 2465, 2466, 2467, 2468, 2469, 2470, 2471);
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface (select * from tasy_versao.interface where cd_interface in (2463, 2464, 2465, 2466, 2467, 2468, 2469, 2470, 2471))');
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface_reg (select * from tasy_versao.interface_reg where cd_interface in (2463, 2464, 2465, 2466, 2467, 2468, 2469, 2470, 2471))');
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface_atributo (select * from tasy_versao.interface_atributo where cd_interface in (2463, 2464, 2465, 2466, 2467, 2468, 2469, 2470, 2471))');
	end if;
end if;

if (dt_versao_atual_cliente_w	< to_date('30/07/2013','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	interface
	where	cd_interface = 2515;
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface (select * from tasy_versao.interface where cd_interface = 2515)');
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface_reg (select * from tasy_versao.interface_reg where cd_interface = 2515)');
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface_atributo (select * from tasy_versao.interface_atributo where cd_interface = 2515)');
	end if;
end if;

if (dt_versao_atual_cliente_w	< to_date('15/11/2013','dd/mm/yyyy')) then

	update	interface_atributo
	set 	QT_TAMANHO = 80
	where	cd_interface in (2463, 2464, 2465, 2466, 2467, 2468, 2469, 2470, 2471)
	and 	QT_TAMANHO = 40
	and 	NM_ATRIBUTO = 'DS_MEDICAMENTO';

end if;

if (dt_versao_atual_cliente_w	< to_date('14/12/2013','dd/mm/yyyy')) then

	select	count(*)
	into STRICT	qt_registro_w
	from	interface
	where	cd_interface = 2555;

	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface (select * from tasy_versao.interface where cd_interface = 2555)');
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface_reg (select * from tasy_versao.interface_reg where cd_interface = 2555)');
		CALL Exec_Sql_Dinamico('Tasy', 'insert into interface_atributo (select * from tasy_versao.interface_atributo where cd_interface = 2555)');
	end if;
end if;

if (dt_versao_atual_cliente_w < to_date('18/06/2014','dd/mm/yyyy')) then

	select 	count(*)
	into STRICT	qt_registro_w
	from 	conta_paciente_observacao a
	where 	not exists (	SELECT 	1
				from 	conta_paciente b
				where 	b.nr_interno_conta = a.nr_interno_conta);

	if (qt_registro_w > 0) then

		CALL Exec_sql_Dinamico('Tasy','DROP INDEX COPAOBS_CONPACI_FK_I');
		CALL Exec_Sql_Dinamico('Tasy','DELETE FROM CONTA_PACIENTE_OBSERVACAO A WHERE NOT EXISTS(SELECT 1 FROM CONTA_PACIENTE B WHERE B.NR_INTERNO_CONTA = A.NR_INTERNO_CONTA)');
		CALL Exec_Sql_Dinamico('Tasy','Alter Table CONTA_PACIENTE_OBSERVACAO add (' ||
					 '   Constraint COPAOBS_CONPACI_FK Foreign Key (NR_INTERNO_CONTA) References CONTA_PACIENTE (NR_INTERNO_CONTA) ' ||
					 ' 	on delete cascade)');
	end if;

end if;


if (dt_versao_atual_cliente_w < to_date('25/07/2014','dd/mm/yyyy')) then
	CALL Exec_sql_Dinamico('Tasy','update tabela_atributo set VL_DEFAULT = ''S'' where  nm_tabela = ''AUDITORIA_MOTIVO'' and nm_atributo = ''IE_ALTERACAO_DATA''');
end if;

if (dt_versao_atual_cliente_w < to_date('13/08/2014','dd/mm/yyyy')) then
	CALL Exec_sql_Dinamico('Tasy','UPDATE inconsistencia x ' ||
				 'set    x.cd_exp_inconsistencia =     (select 	a.cd_exp_inconsistencia 		' 	||
				 '					from 	tasy_versao.inconsistencia a 		' 	||
                                 '					where   a.nr_sequencia = x.nr_sequencia),	'	||
				 '	 x.cd_exp_acao_usuario 	 =     (select  a.cd_exp_acao_usuario 			'	||
				 '  					from    tasy_versao.inconsistencia a		'	||
                                 '					where   a.nr_sequencia = x.nr_sequencia)	'	);
end if;

if (dt_versao_atual_cliente_w < to_date('01/11/2014','dd/mm/yyyy')) then
	CALL Exec_sql_Dinamico('Tasy','DROP INDEX PACAPRO_REAPAU_FK_I');
	CALL Exec_sql_Dinamico('Tasy','Alter Table PACOTE_APROVACAO Drop Constraint PACAPRO_REAPAU_FK');
end if;

if (dt_versao_atual_cliente_w < to_date('26/11/2014','dd/mm/yyyy')) then
	CALL baca_seq_tipo_acomod_mat();
end if;

/* BAKESTRING em 04/11/2015 */

if (dt_versao_atual_cliente_w < to_date('04/11/2015','dd/mm/yyyy')) then

	select	count(*)
	into STRICT	qt_registro_w
	FROM	USER_CONSTRAINTS
	WHERE	CONSTRAINT_NAME = 'REGLAAU_UK';
	begin
	if (qt_registro_w	> 0) then
		CALL Exec_sql_Dinamico('Fabrício','ALTER TABLE REGRA_LANC_AUTOMATICO DROP CONSTRAINT REGLAAU_UK');
	end if;
	exception
	when others then
		qt_registro_w	:= qt_registro_w;
	end;

	select	count(*)
	into STRICT	qt_registro_w
	FROM	USER_INDEXES
	WHERE	INDEX_NAME = 'REGLAAU_UK';
	begin
	if (qt_registro_w	> 0) then
		CALL Exec_sql_Dinamico('Fabrício','DROP INDEX REGLAAU_UK');
	end if;
	exception
	when others then
		qt_registro_w	:= qt_registro_w;
	end;

end if;

/* Heckmann em 13/11/2015 */

if (dt_versao_atual_cliente_w < to_date('13/11/2015','dd/mm/yyyy')) then

	select	count(*)
	into STRICT	qt_registro_w
	FROM	INTEGRIDADE_REFERENCIAL
	WHERE	NM_INTEGRIDADE_REFERENCIAl = 'RLAITEM_REGLAAU_FK';
	begin
	if (qt_registro_w	> 0) then
		CALL Exec_sql_Dinamico('alheckmann','delete INTEGRIDADE_REFERENCIAL where NM_INTEGRIDADE_REFERENCIAl = ''RLAITEM_REGLAAU_FK''');
	end if;
	exception
	when others then
		qt_registro_w	:= qt_registro_w;
	end;

	select	count(*)
	into STRICT	qt_registro_w
	FROM	INDICE
	WHERE	NM_INDICE = 'RLAITEM_REGLAAU_FK_I';
	begin
	if (qt_registro_w	> 0) then
		CALL Exec_sql_Dinamico('alheckmann','delete INDICE where NM_INDICE = ''RLAITEM_REGLAAU_FK_I''');
	end if;
	exception
	when others then
		qt_registro_w	:= qt_registro_w;
	end;

end if;

/*gazimmermann em 18/11/2015*/

if (dt_versao_atual_cliente_w	< to_date('25/11/2015','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	interface
	where	cd_interface = 2714;
	if (qt_registro_w = 0) then
		CALL Exec_Sql_Dinamico('gazimmermann', 'insert into interface (select * from tasy_versao.interface where cd_interface = 2714)');
		CALL Exec_Sql_Dinamico('gazimmermann', 'insert into interface_reg (select * from tasy_versao.interface_reg where cd_interface = 2714)');
		CALL Exec_Sql_Dinamico('gazimmermann', 'insert into interface_atributo (select * from tasy_versao.interface_atributo where cd_interface = 2714)');
	end if;
end if;

/*Heckmann em 16/12/2015*/

if (dt_versao_atual_cliente_w	< to_date('16/12/2015','dd/mm/yyyy')) then

	select	count(*)
	into STRICT	qt_registro_w
	from	indicador_gestao_atrib
	where 	nm_atributo = 'DT_HORA_EXAME'
	and		nr_seq_ind_gestao = (
								SELECT	max(nr_sequencia)
								from	indicador_gestao
								where	nr_seq_wheb = 21);
	if (qt_registro_w > 0) then

		CALL Exec_Sql_Dinamico('alheckmann', 'update	indicador_gestao_atrib ' ||
										'set	nm_atributo = ''DS_HORA_EXAME'', nm_atributo_drill = ''DS_HORA_EXAME''' ||
										'where 	nm_atributo = ''DT_HORA_EXAME''' ||
										'and		nr_seq_ind_gestao = (' ||
																	'select	max(nr_sequencia)' ||
																	'from	indicador_gestao' ||
																	'where	nr_seq_wheb = 21)');
	end if;

end if;

if (dt_versao_atual_cliente_w	>= to_date('18/12/2015','dd/mm/yyyy')) then

	select  count(*)
	into STRICT    qt_registro_w
	from    user_tab_columns
	where   table_name = 'AUDITORIA_CONTA_PACIENTE'
	and     column_name = 'NR_RAT'
	and     data_type = 'NUMBER';

	if (qt_registro_w > 0) then

		CALL Exec_sql_Dinamico('tdpaula', 'alter table auditoria_conta_paciente modify nr_rat varchar2(10)');
		CALL Exec_sql_Dinamico('tdpaula', 'alter table auditoria_rat modify nr_rat_anterior varchar2(10)');
		CALL Exec_sql_Dinamico('tdpaula', 'alter table auditoria_rat modify nr_rat_atual varchar2(10)');


	end if;

end if;

if (dt_versao_atual_cliente_w	>= to_date('18/12/2015','dd/mm/yyyy')) then

	select  count(*)
	into STRICT    qt_registro_w
	from    user_tab_columns
	where   table_name = 'AUDITORIA_CONTA_PACIENTE'
	and     column_name = 'NR_RAT'
	and     data_type = 'NUMBER';

	if (qt_registro_w > 0) then

		CALL Exec_sql_Dinamico('tdpaula', 'alter table auditoria_conta_paciente modify nr_rat varchar2(10)');
		CALL Exec_sql_Dinamico('tdpaula', 'alter table auditoria_rat modify nr_rat_anterior varchar2(10)');
		CALL Exec_sql_Dinamico('tdpaula', 'alter table auditoria_rat modify nr_rat_atual varchar2(10)');


	end if;

end if;

if (dt_versao_atual_cliente_w	>= to_date('07/07/2017','dd/mm/yyyy')) then
	select  count(*)
	into STRICT    qt_registro_w
	from    user_tab_columns
	where   table_name = 'INT_DISP_MAT_HOR'
	and     column_name = 'DS_ERRO'
	and     data_length <> 2000;

	if (qt_registro_w > 0) then
		CALL Exec_sql_Dinamico('dsilva', 'alter table int_disp_mat_hor modify ds_erro varchar2(2000)');
	end if;

	select  count(*)
	into STRICT    qt_registro_w
	from    user_tab_columns
	where   table_name = 'INT_DISP_MOVT_PAC'
	and     column_name = 'DS_ERRO'
	and     data_length <> 2000;

	if (qt_registro_w > 0) then
		CALL Exec_sql_Dinamico('dsilva', 'alter table int_disp_movt_pac modify ds_erro varchar2(2000)');
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_ajustar_base_fat ( nm_usuario_p text) FROM PUBLIC;

