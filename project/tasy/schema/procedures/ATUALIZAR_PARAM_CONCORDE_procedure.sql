-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_param_concorde ( CD_FUNCAO_P bigint, CD_PERFIL_P bigint) AS $body$
DECLARE


NR_SEQ_PARAM_W			bigint;
VLR_PARAM_W				varchar(255);
IE_EXISTE_PERFIL		varchar(1);

C01 CURSOR FOR
	SELECT  NR_SEQUENCIA,
			VL_PARAM_ATUAL
	FROM 	CONCORDE_COMPARATIVO;


BEGIN

IF (CD_FUNCAO_P IS NOT NULL AND CD_FUNCAO_P::text <> '' AND CD_PERFIL_P IS NOT NULL AND CD_PERFIL_P::text <> '') THEN

OPEN C01;
LOOP
FETCH C01 INTO
	NR_SEQ_PARAM_W,
	VLR_PARAM_W;
EXIT WHEN NOT FOUND; /* apply on C01 */
	BEGIN

	SELECT	CASE WHEN COUNT(*)=0 THEN 'N'  ELSE 'S' END
	INTO STRICT	IE_EXISTE_PERFIL
	FROM  	FUNCAO_PARAM_PERFIL
	WHERE 	CD_FUNCAO = CD_FUNCAO_P
	AND   	CD_PERFIL = CD_PERFIL_P
	AND		NR_SEQUENCIA = NR_SEQ_PARAM_W;

	IF (IE_EXISTE_PERFIL = 'S') THEN

		UPDATE	FUNCAO_PARAM_PERFIL
		SET		VL_PARAMETRO = VLR_PARAM_W
		WHERE 	CD_FUNCAO = CD_FUNCAO_P
		AND   	CD_PERFIL = CD_PERFIL_P
		AND		NR_SEQUENCIA = NR_SEQ_PARAM_W;

	ELSE

		INSERT	INTO	FUNCAO_PARAM_PERFIL(NR_SEQ_INTERNO,
						CD_FUNCAO,
						CD_PERFIL,
						NR_SEQUENCIA,
						VL_PARAMETRO,
						DT_ATUALIZACAO,
						NM_USUARIO,
						DS_OBSERVACAO)
				VALUES (nextval('funcao_param_perfil_seq'),
						CD_FUNCAO_P,
						CD_PERFIL_P,
						NR_SEQ_PARAM_W,
						VLR_PARAM_W,
						clock_timestamp(),
						WHEB_USUARIO_PCK.GET_NM_USUARIO,
						'CONCORDE_COMPARATIVO');

	END IF;
	END;
END LOOP;
CLOSE C01;

END IF;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_param_concorde ( CD_FUNCAO_P bigint, CD_PERFIL_P bigint) FROM PUBLIC;

