-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE colunas AS (cd_material_w		integer,
			cd_unidade_medida_w 	varchar(30),
			qt_dose_w		double precision,
			nr_seq_fabric_w		bigint,
			qt_frasco_disp_w		double precision,
			qt_perda_fornec_w		double precision);


CREATE OR REPLACE PROCEDURE gerar_dispensacao_quimio ( nr_seq_atendimento_p bigint, cd_estabelecimento_p bigint, nr_atendimento_p bigint, nr_seq_ordem_p bigint, nm_usuario_p text) AS $body$
DECLARE

/* vetor */

TYPE vetor IS TABLE OF colunas INDEX BY integer;


cd_unid_medida_disp_w		varchar(30);
qt_dose_prescricao_ww		double precision;
qt_sobra_w			double precision;
cont_mat_menor_disper_w		bigint;
cd_mat_menor_disp_w		bigint;
qt_frasco_w			bigint;
qt_frasco_tot_w			bigint := 0;
cont_ww				bigint;
vetor_ww			vetor;
vetor_w			vetor;
vetor_aux_w		vetor;
cd_convenio_w		bigint;
vetor_fornecedor_w		vetor;
dt_atualizacao_w    	   	timestamp := clock_timestamp();
dt_referencia_w		timestamp;
nr_prescricao_w		bigint;
nr_prescricao_ww		bigint;
nr_prescricao_www	bigint;
cd_material_w              	integer;
cd_material_exec_w              	integer;
cd_material_regra_w	integer;
ie_gerar_solucao_w		varchar(3);
cd_unid_med_prescr_w       	varchar(30);
qt_dose_prescricao_w       	double precision;
qt_unitaria_w   		double precision;
qt_total_dispensar_w	double precision;
qt_conversao_dose_w	double precision;
ie_via_aplicacao_w         	varchar(5);
ie_gerar_diluicao_w		varchar(5);
ie_define_disp_w		varchar(5);
nr_seq_material_w		bigint;
nr_seq_diluicao_w		bigint;
nr_seq_material_rec_w	bigint;
nr_seq_fabric_w		bigint;
nr_agrupamento_ant_w	double precision := -1;
cd_unid_med_consumo_w	varchar(30);
cd_intervalo_w             	varchar(7);
qt_minimo_multiplo_solic_w	double precision;
ie_origem_inf_w		varchar(1);
nr_ocorrencia_w		double precision;
nr_ocorrencia_ww	double precision;
ie_gerar_horarios   varchar(1);
ds_horarios_w		varchar(2000);
ds_horarios2_w		varchar(2000);
cd_protocolo_w		bigint;
nr_seq_medicacao_w	integer;
nr_seq_dieta_w		integer;
nr_seq_dieta_novo_w	integer;
nr_seq_dieta_prot_w	integer;
cd_dieta_w		bigint;
ie_destino_dieta_w		varchar(2);
ie_refeicao_w		varchar(3);
ds_horarios_dieta_w	varchar(2000);
dt_primeiro_horario_w	timestamp;
dt_prescricao_w		timestamp;
dt_inicio_prescr_w	timestamp;
dt_prescricao_ww		timestamp;
dt_entrada_w		timestamp;
cd_pessoa_fisica_ww	varchar(10);
cd_pessoa_usuario_w	varchar(10);
nr_sequencia_w		integer;
qt_material_w		double precision;
ds_dose_diferenciada_w	varchar(50);
cd_unidade_medida_dose_w	varchar(30);
ds_erro_w		varchar(255);
ie_regra_disp_w		varchar(1);
cd_fornec_consignado_w	varchar(14);
ie_consignado_w		varchar(1);
cd_fornecedor_w		varchar(14);
qt_estoque_consig_w	varchar(14);
ie_tipo_material_w		varchar(14);
nr_seq_ficha_tecnica_w	bigint;
qt_dose_prescr_aux_w	double precision;
qt_dose_total_prescr_w	double precision;
qt_dose_regra_w		double precision;
qt_dose_total_aux_w	double precision;
qt_dose_total_aux_ww	double precision;
qt_dose_total_aux_www	double precision;
cont_w			bigint;
qt_registros_vetor_w	bigint;
qt_controle_w		bigint := 0;
qt_controle_ww		bigint := 0;
qt_controle_www		bigint := 0;
qt_controle_wwww		bigint := 0;
qt_perda_w		double precision;
qt_perda_2w		double precision;
qt_desconto_w		double precision;
qt_a_lancar_w		double precision;
qt_perda_final_w		double precision;
qt_perda_final_2w		double precision;
pr_desconto_w		double precision;
qt_mat_vetor_w		double precision;
x			bigint := 0;
i			bigint := 0;
k			bigint := 0;
y			bigint := 0;
r			bigint := 0;
cd_mat_vetor_w		bigint;
ie_reg_w			bigint;
nr_seq_medic_w		bigint;
nr_seq_proc_w		bigint;
cd_unidade_medida_consumo_w	varchar(30);
ds_prim_horario_w		varchar(5);
ie_fabricante_w		varchar(5);
nr_seq_fabric_melhor_w	bigint;
qt_fornec_w		bigint;
qt_menor_perda_w		double precision;
qt_menor_frasco_w		double precision;
qt_frasco_perda_zero_w		double precision;
qt_frasco_disp_w		bigint;
cd_subgrupo_param_w	bigint;
qt_medic_w		bigint;
nr_seq_solucao_w	bigint;
ie_agrupamento_w	bigint;
ie_regra_prescr_onc_w		varchar(3);
ie_agrupador_oncologia_w	smallint;
ie_regra_w		varchar(15);
cd_medicamento_w	integer;
nr_atendimento_www	bigint;
nr_seq_atendimento_w	bigint;
nr_seq_acesso_w		bigint;
ie_agrupador_w		bigint;
qt_conversao_w		double precision;
qt_dose_w		double precision;
cd_grupo_material_w	smallint;
cd_subgrupo_material_w	smallint;
nr_sequencia_regra_w	bigint;
nr_seq_prescricao_w	integer;
cd_classe_material_w	integer;
nr_seq_item_prescr_w   bigint;
nr_seq_ordem_w          bigint;
c00 CURSOR FOR
SELECT	ie_regra,
	nr_sequencia
from	regra_apresentacao_quimio
where	coalesce(cd_material,cd_material_w)				= cd_material_w
and	coalesce(cd_grupo_material, cd_grupo_material_w)		= cd_grupo_material_w
and	coalesce(cd_subgrupo_material, cd_subgrupo_material_w)	= cd_subgrupo_material_w
and	coalesce(cd_convenio,cd_convenio_w)				= cd_convenio_w

and	coalesce(ie_tipo_material,ie_tipo_material_w)		= ie_tipo_material_w
and	coalesce(cd_classe_material,cd_classe_material_w)		= cd_classe_material_w
and 	((coalesce(ie_regra_aplicacao,'D') = 'D') or (coalesce(ie_regra_aplicacao,'D') = 'A'))
and ie_situacao = 'A'
and (coalesce(dt_inicio_vigencia::text, '') = '' or clock_timestamp() >= dt_inicio_vigencia)
and (coalesce(dt_fim_vigencia::text, '') = '' or clock_timestamp() <= dt_fim_vigencia)
and ((obtain_user_locale(nm_usuario_p) <> 'es_CO')
or (coalesce(ie_nopbs, 'N') = obter_se_nao_pbs_material(cd_material_w, nr_atendimento_p)))
order by
	coalesce(cd_material,0),	
	coalesce(cd_subgrupo_material,0),
	coalesce(cd_grupo_material,0),
	coalesce(cd_convenio,0),
	coalesce(ie_tipo_material,0);

c01 CURSOR FOR
	SELECT	a.cd_material,
		a.cd_unidade_medida,
		a.qt_dose,
		d.ie_via_aplicacao,
		substr(obter_dados_material_estab(a.cd_material,cd_estabelecimento_p,'UMS'),1,30) cd_unidade_medida_consumo,
		b.qt_minimo_multiplo_solic,
		a.nr_sequencia_diluente,
		b.ie_tipo_material,
		a.qt_dose,
		b.nr_seq_ficha_tecnica,
		a.ie_agrupador,
		a.nr_prescricao,
		a.nr_seq_prescricao,
        a.nr_sequencia,
        a.nr_seq_ordem
	FROM   	material b,
		can_ordem_prod d, 	   
		can_ordem_item_prescr a
	WHERE  	a.cd_material 		  = b.cd_material
	AND    	a.nr_seq_ordem 		  = d.nr_sequencia
	AND    	a.nr_seq_ordem 		  = nr_seq_ordem_p;

c02 CURSOR FOR
SELECT	b.cd_material,
	obter_conversao_unid_med_onc(b.cd_material, cd_unid_med_prescr_w) qt_dose,
	substr(obter_dados_material_estab(b.cd_material,cd_estabelecimento_p,'UMS'),1,30) cd_unidade_medida_consumo
FROM	material_estab c,
	material b,
	medic_ficha_tecnica a
WHERE	b.nr_seq_ficha_tecnica	= a.nr_sequencia
AND	c.cd_material		= b.cd_material
AND	c.cd_estabelecimento	= cd_estabelecimento_p
AND	a.nr_sequencia		= nr_seq_ficha_tecnica_w
AND	Obter_se_via_adm(b.cd_material, ie_via_aplicacao_w) = 'S'
and	obter_se_regra_mat_quimio(b.cd_material, cd_convenio_w, 'X') = 'S'
AND	((b.cd_material		<> cd_material_w) OR (ie_define_disp_w	= 'S'))
AND	((coalesce(ie_fabricante_w,'N')	= 'S') OR (b.nr_seq_fabric		= nr_seq_fabric_w))
AND	coalesce(obter_conversao_unid_med_onc(b.cd_material, cd_unid_med_prescr_w),0) > 0
AND	b.ie_situacao		= 'A'
AND	c.ie_prescricao		= 'S'
and 	b.ie_tipo_material 	<> '6'
ORDER BY qt_dose DESC;

c03 CURSOR FOR
SELECT	DISTINCT
	b.nr_seq_fabric
FROM	material_estab c,
	material b,
	medic_ficha_tecnica a
WHERE	b.nr_seq_ficha_tecnica	= a.nr_sequencia
AND	c.cd_material		= b.cd_material
AND	c.cd_estabelecimento	= cd_estabelecimento_p
AND	a.nr_sequencia		= nr_seq_ficha_tecnica_w
AND	Obter_se_via_adm(b.cd_material, ie_via_aplicacao_w) = 'S'
AND	coalesce(obter_conversao_unid_med_onc(b.cd_material, cd_unid_med_prescr_w),0) > 0
AND	(b.nr_seq_fabric IS NOT NULL AND b.nr_seq_fabric::text <> '')
AND	((b.cd_material		<> cd_material_w) OR (ie_define_disp_w	= 'S'))
AND	b.ie_situacao		= 'A'
AND	c.ie_prescricao		= 'S'
ORDER BY b.nr_seq_fabric;


BEGIN

CALL valida_atendimento_dispensacao(nr_seq_ordem_p);

delete from dispensacao_quimioterapia where nr_seq_ordem = nr_seq_ordem_p;

cd_subgrupo_param_w := obter_param_usuario(3130, 69, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, cd_subgrupo_param_w);
ie_define_disp_w := obter_param_usuario(3130, 133, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_define_disp_w);

OPEN c01;
LOOP
FETCH c01 INTO
	cd_material_w,
	cd_unid_med_prescr_w,
	qt_dose_prescricao_w,
	ie_via_aplicacao_w,
	cd_unid_med_consumo_w,
	qt_minimo_multiplo_solic_w,
	nr_seq_diluicao_w,
	ie_tipo_material_w,
	qt_dose_total_prescr_w,
	nr_seq_ficha_tecnica_w,
	ie_agrupador_oncologia_w,
	nr_prescricao_www,
	nr_seq_prescricao_w,
    nr_seq_item_prescr_w,
    nr_seq_ordem_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	BEGIN
	ie_agrupamento_w	:= 1;

    --robson
    select  max(cd_material)
    into STRICT    cd_material_exec_w
    from    can_ordem_prod_mat
    where   nr_seq_item_prescr = nr_seq_item_prescr_w
    and     nr_seq_ordem = nr_seq_ordem_w;


	select	max(cd_grupo_material),
		max(cd_subgrupo_material),
		max(cd_classe_material)
	into STRICT	cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w
	from	estrutura_material_v	
	where	cd_material = cd_material_w;

	SELECT	max(b.cd_pessoa_fisica)
	INTO STRICT	cd_pessoa_fisica_ww
	FROM	paciente_setor b,
		paciente_atendimento a
	WHERE	a.nr_seq_atendimento = nr_seq_atendimento_p
	AND	a.nr_seq_paciente = b.nr_seq_paciente;
	
	select 	max(nr_Atendimento)
	into STRICT	nr_atendimento_www
	from 	atendimento_paciente 
	where 	cd_pessoa_fisica = cd_pessoa_fisica_ww
	and 	coalesce(dt_alta::text, '') = '';
	
	select 	obter_convenio_atendimento(nr_atendimento_p)
	into STRICT 	cd_convenio_w
	;
	
	ie_regra_w := null;
	
	open C00;
	loop
	fetch C00 into	
		ie_regra_w,
		nr_sequencia_regra_w;
	EXIT WHEN NOT FOUND; /* apply on C00 */
		begin
		ie_regra_w := ie_regra_w;
		end;
	end loop;
	close C00;
	
	if (nr_seq_diluicao_w IS NOT NULL AND nr_seq_diluicao_w::text <> '') then
		ie_agrupamento_w	:= 3;
	elsif (ie_gerar_solucao_w	= 'S') then
		ie_agrupamento_w	:= 4;
	end if;
	
	if (ie_agrupador_oncologia_w = 9) then
		ie_agrupamento_w	:= 9;
	end if;
	
	if (ie_tipo_material_w = '6') Then
		ie_agrupamento_w	:= 1;
	end if;
	
	SELECT	coalesce(COUNT(*),0)
	INTO STRICT	cont_w
	FROM	material b
	WHERE	b.nr_seq_ficha_tecnica	= nr_seq_ficha_tecnica_w;

	IF	(cont_w		> 0 AND ie_tipo_material_w	= '6') and (coalesce(ie_regra_w,'MA')	= 'MA') THEN

		select	max(ie_fabricante_dist)
		into STRICT	ie_fabricante_w
		from	material
		WHERE	cd_material	= cd_material_w;

		SELECT	coalesce(MAX(pr_desconto),0),
			coalesce(coalesce(ie_fabricante_w, MAX(ie_fabricante)),'N')
		INTO STRICT	pr_desconto_w,
			ie_fabricante_w
		FROM	material_sem_apresentacao
		WHERE	cd_material	= cd_material_w;

		IF (ie_fabricante_w = 'N') THEN
			qt_fornec_w	:= 0;
			ie_reg_w	:= 0;
			OPEN c03;
			LOOP
			FETCH c03 INTO
				nr_seq_fabric_w;
			EXIT WHEN NOT FOUND; /* apply on c03 */
				cont_w	:= 0;
				vetor_w.DELETE;
				OPEN c02;
				LOOP
				FETCH c02 INTO
					cd_material_regra_w,
					qt_dose_regra_w,
					cd_unidade_medida_consumo_w;
				EXIT WHEN NOT FOUND; /* apply on c02 */
					vetor_w[cont_w].cd_material_w	:= cd_material_regra_w;
					vetor_w[cont_w].qt_dose_w	:= qt_dose_regra_w;
					vetor_w[cont_w].cd_unidade_medida_w := cd_unidade_medida_consumo_w;
					cont_w := cont_w + 1;
				END LOOP;
				CLOSE c02;

				qt_dose_total_aux_w	:= qt_dose_total_prescr_w;
				qt_desconto_w		:= ((pr_desconto_w * qt_dose_total_aux_w) / 100);
				qt_controle_w		:= 0;

				WHILE(qt_dose_total_aux_w	> 0) AND (qt_controle_w		< 1000) LOOP

					qt_registros_vetor_w	:= vetor_w.COUNT - 1;
					qt_controle_ww		:= 0;
					x			:= -1;
					WHILE(x < qt_registros_vetor_w) AND (qt_dose_total_aux_w > 0) AND (qt_controle_ww < 1000) LOOP

						x := x + 1;
						qt_controle_ww	:= qt_controle_ww + 1;

						IF	((qt_dose_total_aux_w - vetor_w[x].qt_dose_w) >= 0) THEN
							qt_dose_total_aux_www := qt_dose_total_aux_w;
							qt_dose_total_aux_w	:= (qt_dose_total_aux_w - vetor_w[x].qt_dose_w);
							vetor_aux_w[ie_reg_w].cd_material_w	:= vetor_w[x].cd_material_w;
							vetor_aux_w[ie_reg_w].qt_dose_w		:= vetor_w[x].qt_dose_w;
							vetor_aux_w[ie_reg_w].cd_unidade_medida_w := vetor_w[x].cd_unidade_medida_w;
							vetor_aux_w[ie_reg_w].nr_seq_fabric_w	:= nr_seq_fabric_w;
							r := x + 1;
							
							x := -1;
							ie_reg_w	:= ie_reg_w + 1;
						ELSIF (qt_dose_total_aux_w <= qt_desconto_w) THEN
							qt_dose_total_aux_w	:= 0;
						ELSIF (qt_registros_vetor_w = x) THEN
							qt_dose_total_aux_w	:= (qt_dose_total_aux_w - vetor_w[x].qt_dose_w);
							vetor_aux_w[ie_reg_w].cd_material_w	:= vetor_w[x].cd_material_w;
							vetor_aux_w[ie_reg_w].qt_dose_w		:= vetor_w[x].qt_dose_w;
							vetor_aux_w[ie_reg_w].cd_unidade_medida_w := vetor_w[x].cd_unidade_medida_w;
							vetor_aux_w[ie_reg_w].nr_seq_fabric_w	:= nr_seq_fabric_w;
							ie_reg_w	:= ie_reg_w + 1;
						ELSIF	((qt_dose_total_aux_w - vetor_w[x].qt_dose_w) < 0) THEN

							qt_perda_w		:= (qt_dose_total_aux_w - vetor_w[x].qt_dose_w);
							qt_dose_total_aux_ww	:= qt_dose_total_aux_w;
							qt_perda_final_w	:= 0;
							qt_controle_wwww	:= 0;
							WHILE(qt_dose_total_aux_ww	> 0) AND (qt_controle_wwww	< 1000) LOOP

								qt_controle_www := 0;
								i 		:= -1;
								WHILE(i < qt_registros_vetor_w) AND (qt_dose_total_aux_ww	> 0) AND (qt_controle_www	< 1000) LOOP

									i	:= i + 1;
									qt_controle_www	:= qt_controle_www + 1;
									IF	((qt_dose_total_aux_ww - vetor_w[i].qt_dose_w) >= 0) THEN
										qt_perda_final_w	:= (qt_dose_total_aux_ww - vetor_w[i].qt_dose_w);
										qt_dose_total_aux_ww	:= (qt_dose_total_aux_ww - vetor_w[i].qt_dose_w);
										i := -1;
									ELSIF (qt_registros_vetor_w = i) THEN
										qt_perda_final_w	:= (qt_dose_total_aux_ww - vetor_w[i].qt_dose_w);
										qt_dose_total_aux_ww	:= (qt_dose_total_aux_ww - vetor_w[i].qt_dose_w);
									END IF;
								END LOOP;

								qt_controle_wwww := qt_controle_wwww + 1;

							END LOOP;

							qt_perda_2w		:= (qt_dose_total_aux_w - vetor_w[x].qt_dose_w);
							qt_dose_total_aux_ww	:= qt_dose_total_aux_w;
							qt_perda_final_2w	:= 0;
							qt_controle_wwww	:= 0;
							WHILE(qt_dose_total_aux_ww	> 0) AND (qt_controle_wwww	< 1000) LOOP

								qt_controle_www := 0;
								i 		:= -1;
								WHILE(i < qt_registros_vetor_w) AND (qt_dose_total_aux_ww	> 0) AND (qt_controle_www	< 1000) LOOP

									i	:= i + 1;
									qt_controle_www	:= qt_controle_www + 1;
									IF	((qt_dose_total_aux_ww - vetor_w[i].qt_dose_w) >= 0) THEN
										qt_perda_final_2w	:= (qt_dose_total_aux_ww - vetor_w[i].qt_dose_w);
										qt_dose_total_aux_ww	:= (qt_dose_total_aux_ww - vetor_w[i].qt_dose_w);
										i := -1;
									END IF;
								END LOOP;
								qt_controle_wwww := qt_controle_wwww + 1;
							END LOOP;

							IF (qt_dose_total_aux_ww < qt_desconto_w) THEN
								NULL;
							ELSIF (qt_perda_w >= qt_perda_final_w) THEN
								vetor_aux_w[ie_reg_w].cd_material_w	:= vetor_w[x].cd_material_w;
								vetor_aux_w[ie_reg_w].qt_dose_w		:= vetor_w[x].qt_dose_w;
								vetor_aux_w[ie_reg_w].cd_unidade_medida_w := vetor_w[x].cd_unidade_medida_w;
								vetor_aux_w[ie_reg_w].nr_seq_fabric_w	:= nr_seq_fabric_w;
								ie_reg_w		:= ie_reg_w + 1;
								qt_dose_total_aux_w	:= 0;
							END IF;

						END IF;
					END LOOP;
					qt_controle_w	:= qt_controle_w + 1;
				END LOOP;

				-- inserir os itens totais no vetor de fornecedores.
				k		:= -1;
				qt_mat_vetor_w	:= 0;
				qt_frasco_disp_w := 0;

				WHILE(k < vetor_aux_w.COUNT - 1) LOOP
					k	:= k + 1;
					IF (vetor_aux_w[k].nr_seq_fabric_w	= nr_seq_fabric_w) THEN
						qt_mat_vetor_w		:= qt_mat_vetor_w + vetor_aux_w[k].qt_dose_w;
						qt_frasco_disp_w	:= qt_frasco_disp_w + 1;
					END IF;
				END LOOP;
				vetor_fornecedor_w[qt_fornec_w].nr_seq_fabric_w	 := nr_seq_fabric_w;
				vetor_fornecedor_w[qt_fornec_w].qt_frasco_disp_w := qt_frasco_disp_w;
				vetor_fornecedor_w[qt_fornec_w].qt_perda_fornec_w := (qt_dose_total_prescr_w - qt_mat_vetor_w);
				qt_fornec_w	:= qt_fornec_w + 1;

			END LOOP;
			CLOSE c03;

			-- descobrir qual fornecedor tem a menor perda e a menor quantidade de frasco dispensados.
			k			:= -1;
			qt_menor_frasco_w	:= 99999;
			qt_menor_perda_w	:= -99999;
			qt_frasco_perda_zero_w	:= 99999;
			WHILE(k < vetor_fornecedor_w.COUNT - 1) LOOP
				k	:= k + 1;
				IF	(vetor_fornecedor_w[k].qt_perda_fornec_w >= qt_menor_perda_w AND vetor_fornecedor_w[k].qt_frasco_disp_w <= qt_menor_frasco_w) OR
					(vetor_fornecedor_w[k].qt_perda_fornec_w <> 0 AND vetor_fornecedor_w[k].qt_perda_fornec_w > qt_menor_perda_w) OR
					(vetor_fornecedor_w[k].qt_perda_fornec_w = 0 AND vetor_fornecedor_w[k].qt_frasco_disp_w <= qt_frasco_perda_zero_w) THEN
					nr_seq_fabric_melhor_w	:= vetor_fornecedor_w[k].nr_seq_fabric_w;
					qt_menor_perda_w	:= vetor_fornecedor_w[k].qt_perda_fornec_w;
					qt_menor_frasco_w	:= vetor_fornecedor_w[k].qt_frasco_disp_w;
					IF (vetor_fornecedor_w[k].qt_perda_fornec_w = 0) THEN
						qt_frasco_perda_zero_w	:= vetor_fornecedor_w[k].qt_frasco_disp_w;
					END IF;
				END IF;
			END LOOP;

			vetor_fornecedor_w.DELETE;

			k		:= -1;
			y		:= -1;
			cd_mat_vetor_w	:= 0;
			qt_mat_vetor_w	:= 0;
			qt_a_lancar_w	:= qt_dose_total_prescr_w;
			ie_gerar_diluicao_w 	:= 'S';
			--ie_posicao_ultimo_w	:= 0;
			WHILE(k < vetor_aux_w.COUNT - 1) LOOP
				k	:= k + 1;
				--inserir somente os itens do melhor fabricante.
				IF (vetor_aux_w[k].nr_seq_fabric_w = nr_seq_fabric_melhor_w) THEN
					IF	((cd_mat_vetor_w = vetor_aux_w[k].cd_material_w) OR (cd_mat_vetor_w = 0)) AND (vetor_aux_w.COUNT > 1) THEN
						--(k <> (vetor_aux_w.count -1)) then
						qt_mat_vetor_w			:= qt_mat_vetor_w + vetor_aux_w[k].qt_dose_w;
						qt_unitaria_w			:= vetor_aux_w[k].qt_dose_w;
						cd_mat_vetor_w			:= vetor_aux_w[k].cd_material_w;
						qt_conversao_dose_w		:= vetor_aux_w[k].qt_dose_w;
						cd_unidade_medida_consumo_w 	:= vetor_aux_w[k].cd_unidade_medida_w;
					ELSE

						qt_a_lancar_w	:= (qt_a_lancar_w - qt_mat_vetor_w);

						IF (qt_a_lancar_w >= 0) THEN
							qt_total_dispensar_w := qt_a_lancar_w;
						ELSE
							qt_mat_vetor_w := (qt_mat_vetor_w - ABS(qt_a_lancar_w));
						END IF;

						qt_unitaria_w	:= dividir(qt_mat_vetor_w, qt_unitaria_w);

						SELECT	coalesce(MAX(nr_sequencia),0) +1
						INTO STRICT	nr_seq_medic_w
						FROM	prescr_material
						WHERE	nr_prescricao	= nr_prescricao_w;

						SELECT	coalesce(MAX(ie_consignado), 'X')
						INTO STRICT	ie_consignado_w
						FROM  	material
						WHERE  	cd_material = cd_mat_vetor_w;

						IF (ie_consignado_w = '1') THEN
							SELECT  coalesce(MAX(a.cd_fornecedor),'X')
							INTO STRICT	cd_fornecedor_w
							FROM  	fornecedor_mat_consignado a,
								material m
							WHERE 	a.cd_material	= m.cd_material_estoque
							AND   	m.cd_material   = cd_mat_vetor_w
							AND   	m.ie_situacao 	= 'A'
							AND	a.dt_mesano_referencia = TRUNC(dt_prescricao_w,'mm')
							AND qt_estoque = (	SELECT MAX(obter_saldo_estoque_consig(cd_estabelecimento_p, a.cd_fornecedor, a.cd_material, a.cd_local_estoque))
										FROM  	fornecedor_mat_consignado a,
											material m
										WHERE 	a.cd_material	= m.cd_material_estoque
										AND   	m.cd_material   = cd_mat_vetor_w
										AND   	m.ie_situacao 	= 'A'
										AND		a.dt_mesano_referencia = TRUNC(dt_prescricao_w,'mm'));

							IF (cd_fornecedor_w = 'X') THEN
								cd_fornecedor_w	:= NULL;
							END IF;
						END IF;

						IF (coalesce(cd_mat_vetor_w,0) = '0') THEN
							cd_mat_vetor_w	:= vetor_aux_w[k].cd_material_w;
						END IF;

						IF (coalesce(qt_mat_vetor_w,0) > 0) THEN

						Insert 	into dispensacao_quimioterapia(
							nr_sequencia,
							cd_material,
							cd_unidade_medida_dose,
							dt_atualizacao,
							dt_atualizacao_nrec,
							nm_usuario,
							nm_usuario_nrec,
							qt_dose,
							cd_unidade_conta,
							qt_material_conta,
							nr_seq_ordem,
							nr_prescricao,
							nr_seq_prescricao,
							cd_material_exec,
							ie_via_aplicacao)
						SELECT 	nextval('dispensacao_quimioterapia_seq'),
							cd_mat_vetor_w,
							cd_unid_med_prescr_w,
							clock_timestamp(),
							clock_timestamp(),
							nm_usuario_p,
							nm_usuario_p,
							qt_mat_vetor_w,
							substr(Obter_Dados_Material(cd_mat_vetor_w,'UMC'),1,30),
							obter_dose_convertida(cd_mat_vetor_w,qt_mat_vetor_w,cd_unid_med_prescr_w,substr(Obter_Dados_Material(cd_mat_vetor_w,'UMC'),1,30)),
							nr_seq_ordem_p,
							nr_prescricao_www,
							nr_seq_prescricao_w,
							coalesce(cd_material_exec_w, cd_material_w),
							ie_via_aplicacao_w
						;
						commit;	
						

						END IF;
						ie_gerar_diluicao_w		:= 'N';
						cd_mat_vetor_w			:= vetor_aux_w[k].cd_material_w;
						qt_mat_vetor_w			:= vetor_aux_w[k].qt_dose_w;
						qt_unitaria_w			:= vetor_aux_w[k].qt_dose_w;
						qt_conversao_dose_w		:= vetor_aux_w[k].qt_dose_w;
						cd_unidade_medida_consumo_w 	:= vetor_aux_w[k].cd_unidade_medida_w;
						COMMIT;
					END IF;
				END IF;
			END LOOP;

			qt_a_lancar_w	:= (qt_a_lancar_w - qt_mat_vetor_w);

			IF (qt_a_lancar_w >= 0) THEN
				qt_total_dispensar_w := qt_a_lancar_w;
				IF (qt_mat_vetor_w = 0) THEN
					qt_mat_vetor_w	:= qt_a_lancar_w;
				END IF;
			ELSE
				qt_mat_vetor_w := (qt_mat_vetor_w - ABS(qt_a_lancar_w));
			END IF;

			qt_unitaria_w	:= dividir(qt_mat_vetor_w, qt_unitaria_w);

			SELECT	coalesce(MAX(nr_sequencia),0) +1
			INTO STRICT	nr_seq_medic_w
			FROM	prescr_material
			WHERE	nr_prescricao	= nr_prescricao_w;

			SELECT	coalesce(MAX(ie_consignado), 'X')
			INTO STRICT	ie_consignado_w
			FROM  	material
			WHERE  	cd_material = cd_mat_vetor_w;

			IF (ie_consignado_w = '1') THEN
				SELECT  coalesce(MAX(a.cd_fornecedor),'X')
				INTO STRICT	cd_fornecedor_w
				FROM  	fornecedor_mat_consignado a,
					material m
				WHERE 	a.cd_material	= m.cd_material_estoque
				AND   	m.cd_material   = cd_mat_vetor_w
				AND   	m.ie_situacao 	= 'A'
				AND	a.dt_mesano_referencia = TRUNC(dt_prescricao_w,'mm')
				AND qt_estoque = (	SELECT MAX(obter_saldo_estoque_consig(cd_estabelecimento_p, a.cd_fornecedor, a.cd_material, a.cd_local_estoque))
							FROM  	fornecedor_mat_consignado a,
								material m
							WHERE 	a.cd_material	= m.cd_material_estoque
							AND   	m.cd_material   = cd_mat_vetor_w
							AND   	m.ie_situacao 	= 'A'
							AND		a.dt_mesano_referencia = TRUNC(dt_prescricao_w,'mm'));

				IF (cd_fornecedor_w = 'X') THEN
					cd_fornecedor_w	:= NULL;
				END IF;
			END IF;

			IF (coalesce(cd_mat_vetor_w,0) = 0) AND (vetor_aux_w.COUNT > 0) THEN
				cd_mat_vetor_w	:= vetor_aux_w[k].cd_material_w;
			END IF;

			--ie_gerar_diluicao_w		:= 'N';

			--IF	(ie_item_superior_w	= 'S') THEN

			--	ie_gerar_diluicao_w	:= 'S';

			--END IF;
			IF (cd_mat_vetor_w <> 0) THEN
				Insert 	into dispensacao_quimioterapia(
					nr_sequencia,
					cd_material,
					cd_unidade_medida_dose,
					dt_atualizacao,
					dt_atualizacao_nrec,
					nm_usuario,
					nm_usuario_nrec,
					qt_dose,
					cd_unidade_conta,
					qt_material_conta,
					nr_seq_ordem,
					nr_prescricao,
					nr_seq_prescricao,
					cd_material_exec,
					ie_via_aplicacao)
				SELECT 	nextval('dispensacao_quimioterapia_seq'),
					cd_mat_vetor_w,
					cd_unid_med_prescr_w,
					clock_timestamp(),
					clock_timestamp(),
					nm_usuario_p,
					nm_usuario_p,
					qt_mat_vetor_w,
					substr(Obter_Dados_Material(cd_mat_vetor_w,'UMC'),1,30),
					obter_dose_convertida(cd_mat_vetor_w,qt_mat_vetor_w,cd_unid_med_prescr_w,substr(Obter_Dados_Material(cd_mat_vetor_w,'UMC'),1,30)),
					nr_seq_ordem_p,
					nr_prescricao_www,
					nr_seq_prescricao_w,
					coalesce(cd_material_exec_w, cd_material_w),
					ie_via_aplicacao_w
				;
				commit;
			END IF;

			vetor_aux_w.DELETE;

		ELSE

			cont_w	:= 0;
			vetor_w.DELETE;
			OPEN c02;
			LOOP
			FETCH c02 INTO
				cd_material_regra_w,
				qt_dose_regra_w,
				cd_unidade_medida_consumo_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				vetor_w[cont_w].cd_material_w	:= cd_material_regra_w;
				vetor_w[cont_w].qt_dose_w	:= qt_dose_regra_w;
				vetor_w[cont_w].cd_unidade_medida_w := cd_unidade_medida_consumo_w;
				cont_w := cont_w + 1;
			END LOOP;
			CLOSE c02;

			qt_dose_total_aux_w	:= qt_dose_total_prescr_w;
			qt_desconto_w		:= ((pr_desconto_w * qt_dose_total_aux_w) / 100);
			ie_reg_w		:= 0;

			WHILE(qt_dose_total_aux_w	> 0) AND (qt_controle_w		< 1000) LOOP

				qt_registros_vetor_w	:= vetor_w.COUNT - 1;
				qt_controle_ww		:= 0;
				x			:= -1;

				WHILE(x < qt_registros_vetor_w) AND (qt_dose_total_aux_w	> 0) AND (qt_controle_ww		< 1000) LOOP

					x := x + 1;
					qt_controle_ww	:= qt_controle_ww + 1;

					IF	((qt_dose_total_aux_w - vetor_w[x].qt_dose_w) >= 0) THEN

						qt_dose_total_aux_w	:= (qt_dose_total_aux_w - vetor_w[x].qt_dose_w);
						vetor_aux_w[ie_reg_w].cd_material_w	:= vetor_w[x].cd_material_w;
						vetor_aux_w[ie_reg_w].qt_dose_w		:= vetor_w[x].qt_dose_w;
						vetor_aux_w[ie_reg_w].cd_unidade_medida_w := vetor_w[x].cd_unidade_medida_w;
						ie_reg_w	:= ie_reg_w + 1;
						x := -1;

					ELSIF (qt_dose_total_aux_w <= qt_desconto_w) THEN
						qt_dose_total_aux_w	:= 0;
					ELSIF (qt_registros_vetor_w = x) THEN

						qt_dose_total_aux_w	:= (qt_dose_total_aux_w - vetor_w[x].qt_dose_w);
						vetor_aux_w[ie_reg_w].cd_material_w	:= vetor_w[x].cd_material_w;
						vetor_aux_w[ie_reg_w].qt_dose_w	:= vetor_w[x].qt_dose_w;
						vetor_aux_w[ie_reg_w].cd_unidade_medida_w := vetor_w[x].cd_unidade_medida_w;
						ie_reg_w	:= ie_reg_w + 1;

					ELSIF	((qt_dose_total_aux_w - vetor_w[x].qt_dose_w) < 0) THEN
						qt_perda_w		:= (qt_dose_total_aux_w - vetor_w[x].qt_dose_w);
						qt_dose_total_aux_ww	:= qt_dose_total_aux_w;
						qt_perda_final_w	:= 0;
						qt_controle_wwww	:= 0;
						WHILE(qt_dose_total_aux_ww	> 0) AND (qt_controle_wwww	< 1000) LOOP

							qt_controle_www := 0;
							i 		:= -1;
							WHILE(i < qt_registros_vetor_w) AND (qt_dose_total_aux_ww	> 0) AND (qt_controle_www	< 1000) LOOP

								i	:= i + 1;
								qt_controle_www	:= qt_controle_www + 1;
								IF	((qt_dose_total_aux_ww - vetor_w[i].qt_dose_w) >= 0) THEN
									qt_perda_final_w	:= (qt_dose_total_aux_ww - vetor_w[i].qt_dose_w);
									qt_dose_total_aux_ww	:= (qt_dose_total_aux_ww - vetor_w[i].qt_dose_w);
									i := -1;
								ELSIF (qt_registros_vetor_w = i) THEN
									qt_perda_final_w	:= (qt_dose_total_aux_ww - vetor_w[i].qt_dose_w);
									qt_dose_total_aux_ww	:= (qt_dose_total_aux_ww - vetor_w[i].qt_dose_w);
								END IF;
							END LOOP;

							qt_controle_wwww := qt_controle_wwww + 1;

						END LOOP;

						qt_perda_2w		:= (qt_dose_total_aux_w - vetor_w[x].qt_dose_w);
						qt_dose_total_aux_ww	:= qt_dose_total_aux_w;
						qt_perda_final_2w	:= 0;
						qt_controle_wwww	:= 0;
						WHILE(qt_dose_total_aux_ww	> 0) AND (qt_controle_wwww	< 1000) LOOP

							qt_controle_www := 0;
							i 		:= -1;
							WHILE(i < qt_registros_vetor_w) AND (qt_dose_total_aux_ww	> 0) AND (qt_controle_www	< 1000) LOOP

								i	:= i + 1;
								qt_controle_www	:= qt_controle_www + 1;
								IF	((qt_dose_total_aux_ww - vetor_w[i].qt_dose_w) >= 0) THEN
									qt_perda_final_2w	:= (qt_dose_total_aux_ww - vetor_w[i].qt_dose_w);
									qt_dose_total_aux_ww	:= (qt_dose_total_aux_ww - vetor_w[i].qt_dose_w);
									i := -1;
								END IF;
							END LOOP;
							qt_controle_wwww := qt_controle_wwww + 1;
						END LOOP;

						IF (qt_dose_total_aux_ww < qt_desconto_w) THEN
							NULL;
						ELSIF (qt_perda_w >= qt_perda_final_w) THEN
							vetor_aux_w[ie_reg_w].cd_material_w	:= vetor_w[x].cd_material_w;
							vetor_aux_w[ie_reg_w].qt_dose_w		:= vetor_w[x].qt_dose_w;
							vetor_aux_w[ie_reg_w].cd_unidade_medida_w := vetor_w[x].cd_unidade_medida_w;
							ie_reg_w		:= ie_reg_w + 1;
							qt_dose_total_aux_w	:= 0;
						END IF;
					END IF;
				END LOOP;

				qt_controle_w	:= qt_controle_w + 1;
			END LOOP;

			k		:= -1;
			cd_mat_vetor_w	:= 0;
			qt_mat_vetor_w	:= 0;
			qt_a_lancar_w	:= qt_dose_total_prescr_w;
			ie_gerar_diluicao_w := 'S';

			WHILE(k < vetor_aux_w.COUNT - 1) LOOP
				k	:= k + 1;

				IF	((cd_mat_vetor_w = vetor_aux_w[k].cd_material_w) OR (cd_mat_vetor_w = 0)) AND (vetor_aux_w.COUNT > 1) THEN
					qt_mat_vetor_w			:= qt_mat_vetor_w + vetor_aux_w[k].qt_dose_w;
					qt_unitaria_w			:= vetor_aux_w[k].qt_dose_w;
					cd_mat_vetor_w			:= vetor_aux_w[k].cd_material_w;
					qt_conversao_dose_w		:= vetor_aux_w[k].qt_dose_w;
					cd_unidade_medida_consumo_w 	:= vetor_aux_w[k].cd_unidade_medida_w;
				ELSE
					qt_a_lancar_w	:= (qt_a_lancar_w - qt_mat_vetor_w);

					IF (qt_a_lancar_w >= 0) THEN
						qt_total_dispensar_w := qt_a_lancar_w;
					ELSE
						qt_mat_vetor_w := (qt_mat_vetor_w - ABS(qt_a_lancar_w));
					END IF;

					qt_unitaria_w	:= dividir(qt_mat_vetor_w, qt_unitaria_w);

					SELECT	coalesce(MAX(nr_sequencia),0) +1
					INTO STRICT	nr_seq_medic_w
					FROM	prescr_material
					WHERE	nr_prescricao	= nr_prescricao_w;

					SELECT	coalesce(MAX(ie_consignado), 'X')
					INTO STRICT	ie_consignado_w
					FROM  	material
					WHERE  	cd_material = cd_mat_vetor_w;

					IF (ie_consignado_w = '1') THEN
						SELECT  coalesce(MAX(a.cd_fornecedor),'X')
						INTO STRICT	cd_fornecedor_w
						FROM  	fornecedor_mat_consignado a,
							material m
						WHERE 	a.cd_material	= m.cd_material_estoque
						AND   	m.cd_material   = cd_mat_vetor_w
						AND   	m.ie_situacao 	= 'A'
						AND	a.dt_mesano_referencia = TRUNC(dt_prescricao_w,'mm')
						AND qt_estoque = (	SELECT MAX(obter_saldo_estoque_consig(cd_estabelecimento_p, a.cd_fornecedor, a.cd_material, a.cd_local_estoque))
									FROM  	fornecedor_mat_consignado a,
										material m
									WHERE 	a.cd_material	= m.cd_material_estoque
									AND   	m.cd_material   = cd_mat_vetor_w
									AND   	m.ie_situacao 	= 'A'
									AND		a.dt_mesano_referencia = TRUNC(dt_prescricao_w,'mm'));

						IF (cd_fornecedor_w = 'X') THEN
							cd_fornecedor_w	:= NULL;
						END IF;
					END IF;

					IF (coalesce(cd_mat_vetor_w,0) = '0') THEN
						cd_mat_vetor_w	:= vetor_aux_w[k].cd_material_w;
					END IF;

					IF (qt_mat_vetor_w > 0) THEN
					Insert 	into dispensacao_quimioterapia(
						nr_sequencia,
						cd_material,
						cd_unidade_medida_dose,
						dt_atualizacao,
						dt_atualizacao_nrec,
						nm_usuario,
						nm_usuario_nrec,
						qt_dose,
						cd_unidade_conta,
						qt_material_conta,
						nr_seq_ordem,
						nr_prescricao,
						nr_seq_prescricao,
						cd_material_exec,
						ie_via_aplicacao)
					SELECT 	nextval('dispensacao_quimioterapia_seq'),
						cd_mat_vetor_w,
						cd_unid_med_prescr_w,
						clock_timestamp(),
						clock_timestamp(),
						nm_usuario_p,
						nm_usuario_p,
						qt_mat_vetor_w,
						substr(Obter_Dados_Material(cd_mat_vetor_w,'UMC'),1,30),
						obter_dose_convertida(cd_mat_vetor_w,qt_mat_vetor_w,cd_unid_med_prescr_w,substr(Obter_Dados_Material(cd_mat_vetor_w,'UMC'),1,30)),
						nr_seq_ordem_p,
						nr_prescricao_www,
						nr_seq_prescricao_w,
						coalesce(cd_material_exec_w, cd_material_w),
						ie_via_aplicacao_w
					;
					
					commit;
					END IF;

					ie_gerar_diluicao_w		:= 'N';
					cd_mat_vetor_w			:= vetor_aux_w[k].cd_material_w;
					qt_mat_vetor_w			:= vetor_aux_w[k].qt_dose_w;
					qt_unitaria_w			:= vetor_aux_w[k].qt_dose_w;
					qt_conversao_dose_w		:= vetor_aux_w[k].qt_dose_w;
					cd_unidade_medida_consumo_w 	:= vetor_aux_w[k].cd_unidade_medida_w;
					COMMIT;
				END IF;
			END LOOP;

			vetor_aux_w.DELETE;

			IF (coalesce(cd_mat_vetor_w,0) <> '0') THEN

				qt_a_lancar_w	:= (qt_a_lancar_w - qt_mat_vetor_w);
				IF (qt_a_lancar_w >= 0) THEN
					qt_total_dispensar_w := qt_a_lancar_w;
				ELSE
					qt_mat_vetor_w := (qt_mat_vetor_w - ABS(qt_a_lancar_w));
				END IF;

				qt_unitaria_w	:= dividir(qt_mat_vetor_w, qt_unitaria_w);

				SELECT	coalesce(MAX(nr_sequencia),0) +1
				INTO STRICT	nr_seq_medic_w
				FROM	prescr_material
				WHERE	nr_prescricao	= nr_prescricao_w;

				SELECT	coalesce(MAX(ie_consignado), 'X'),
					MAX(substr(obter_dados_material_estab(cd_material,cd_estabelecimento_p,'UMS'),1,30))
				INTO STRICT	ie_consignado_w,
					cd_unidade_medida_consumo_w
				FROM  	material
				WHERE  	cd_material = cd_mat_vetor_w;

				IF (ie_consignado_w = '1') THEN
					SELECT  coalesce(MAX(a.cd_fornecedor),'X')
					INTO STRICT	cd_fornecedor_w
					FROM  	fornecedor_mat_consignado a,
						material m
					WHERE 	a.cd_material	= m.cd_material_estoque
					AND   	m.cd_material   = cd_mat_vetor_w
					AND   	m.ie_situacao 	= 'A'
					AND	a.dt_mesano_referencia = TRUNC(dt_prescricao_w,'mm')
					AND	qt_estoque = (	SELECT MAX(obter_saldo_estoque_consig(cd_estabelecimento_p, a.cd_fornecedor, a.cd_material, a.cd_local_estoque))
								FROM  	fornecedor_mat_consignado a,
									material m
								WHERE 	a.cd_material	= m.cd_material_estoque
								AND   	m.cd_material   = cd_mat_vetor_w
								AND   	m.ie_situacao 	= 'A'
								AND		a.dt_mesano_referencia = TRUNC(dt_prescricao_w,'mm'));

					IF (cd_fornecedor_w = 'X') THEN
						cd_fornecedor_w	:= NULL;
					END IF;
				END IF;

					Insert 	into dispensacao_quimioterapia(
						nr_sequencia,
						cd_material,
						cd_unidade_medida_dose,
						dt_atualizacao,
						dt_atualizacao_nrec,
						nm_usuario,
						nm_usuario_nrec,
						qt_dose,
						cd_unidade_conta,
						qt_material_conta,
						nr_seq_ordem,
						nr_prescricao,
						nr_seq_prescricao,
						cd_material_exec,
						ie_via_aplicacao)
					SELECT 	nextval('dispensacao_quimioterapia_seq'),
						cd_mat_vetor_w,
						cd_unid_med_prescr_w,
						clock_timestamp(),
						clock_timestamp(),
						nm_usuario_p,
						nm_usuario_p,
						qt_mat_vetor_w,
						substr(Obter_Dados_Material(cd_mat_vetor_w,'UMC'),1,30),
						obter_dose_convertida(cd_mat_vetor_w,qt_mat_vetor_w,cd_unid_med_prescr_w,substr(Obter_Dados_Material(cd_mat_vetor_w,'UMC'),1,30)),
						nr_seq_ordem_p,
						nr_prescricao_www,
						nr_seq_prescricao_w,
						coalesce(cd_material_exec_w, cd_material_w),
						ie_via_aplicacao_w
					;
					
					commit;

			END IF;
		END IF;
		cont_ww := 0;
		open c02;
		loop
		fetch c02 into
			cd_material_regra_w,
			qt_dose_regra_w,
			cd_unidade_medida_consumo_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			vetor_ww[cont_ww].cd_material_w	:= cd_material_regra_w;
			vetor_ww[cont_ww].qt_dose_w	:= qt_dose_regra_w;
			vetor_ww[cont_ww].cd_unidade_medida_w := cd_unidade_medida_consumo_w;
			cont_ww := cont_ww + 1;
		end loop;
		close c02;
		qt_sobra_w := -9999999999;
		cont_ww := cont_ww - 1;
		while(cont_ww > 0) loop
			qt_dose_prescricao_ww := qt_dose_prescricao_w;
			qt_frasco_w := 0;
			while(qt_dose_prescricao_ww > 0) loop
				qt_dose_prescricao_ww := qt_dose_prescricao_ww - vetor_ww[cont_ww].qt_dose_w;
				qt_frasco_w := qt_frasco_w + 1;
			end loop;
		if (qt_dose_prescricao_ww > qt_sobra_w) then
			qt_sobra_w := qt_dose_prescricao_ww;
			cont_mat_menor_disper_w := cont_ww;
			qt_frasco_tot_w :=  qt_frasco_w;
			cd_mat_menor_disp_w := vetor_ww[cont_ww].cd_material_w;
			cd_unid_medida_disp_w := vetor_ww[cont_ww].cd_unidade_medida_w;
		end if;
		cont_ww := cont_ww - 1;
		end loop;	
		
		if (qt_sobra_w > qt_perda_final_w) or
			(qt_sobra_w = qt_perda_final_w AND qt_frasco_tot_w < vetor_w.COUNT) then
			
			delete from dispensacao_quimioterapia
			where 	nr_seq_ordem = nr_seq_ordem_p 
			and 	nr_seq_prescricao = nr_seq_prescricao_w;
			
			Insert 	into dispensacao_quimioterapia(
				nr_sequencia,
				cd_material,
				cd_unidade_medida_dose,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nm_usuario,
				nm_usuario_nrec,
				qt_dose,
				cd_unidade_conta,
				qt_material_conta,
				nr_seq_ordem,
				nr_prescricao,
				nr_seq_prescricao,
				cd_material_exec,
				ie_via_aplicacao)
			SELECT 	nextval('dispensacao_quimioterapia_seq'),
				cd_mat_menor_disp_w,
				cd_unid_med_prescr_w,
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_p,
				nm_usuario_p,
				qt_dose_prescricao_w,
				substr(Obter_Dados_Material(cd_mat_menor_disp_w,'UMC'),1,30),
				obter_dose_convertida(cd_mat_menor_disp_w,qt_frasco_tot_w,cd_unid_medida_disp_w,substr(Obter_Dados_Material(cd_mat_menor_disp_w,'UMC'),1,30)),
				nr_seq_ordem_p,
				nr_prescricao_www,
				nr_seq_prescricao_w,
				cd_mat_menor_disp_w,
				ie_via_aplicacao_w
			;
			commit;
		end if;
	ELSIF (ie_regra_w = 'MF') or (ie_regra_w = 'MG') THEN
			
		if (ie_regra_w = 'MF') then 
			select 	coalesce(max(cd_material),0)
			into STRICT 	cd_medicamento_w
			from 	material
			where 	ie_tipo_material = 8
			and 	nr_seq_ficha_tecnica = nr_seq_ficha_tecnica_w;
			
			if (cd_medicamento_w = 0) then
				CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(196339, 'DS_FICHA_TECNICA_W='||nr_seq_ficha_tecnica_w);
			end if;
		else
			select 	coalesce(max(cd_material),0)
			into STRICT 	cd_medicamento_w
			from 	material
			where 	ie_tipo_material = 3
			and 	nr_seq_ficha_tecnica = nr_seq_ficha_tecnica_w;
			
			if (cd_medicamento_w = 0) then
				CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(388788, 'DS_FICHA_TECNICA_W='||nr_seq_ficha_tecnica_w);
			end if;
		end if;
	
		IF (cd_unid_med_consumo_w = cd_unid_med_prescr_w) THEN
			qt_conversao_dose_w	:= 1;
		ELSE
			BEGIN
			SELECT	qt_conversao
			INTO STRICT	qt_conversao_dose_w
			FROM	material_conversao_unidade
			WHERE	cd_material 	= cd_medicamento_w
			AND	cd_unidade_medida = cd_unid_med_prescr_w;
			EXCEPTION
				WHEN OTHERS THEN
					qt_conversao_dose_w	:= 1;
			END;
		END IF;

		qt_unitaria_w		:= dividir(qt_dose_prescricao_w , qt_conversao_dose_w);
		qt_total_dispensar_w	:= dividir(qt_unitaria_w , qt_minimo_multiplo_solic_w) * qt_minimo_multiplo_solic_w;

		IF (qt_total_dispensar_w < qt_unitaria_w) THEN
			qt_total_dispensar_w := qt_total_dispensar_w + qt_minimo_multiplo_solic_w;
		END IF;

		SELECT	coalesce(MAX(ie_consignado), 'X')
		INTO STRICT	ie_consignado_w
		FROM  	material
		WHERE  	cd_material = cd_medicamento_w;

		IF (ie_consignado_w = '1') THEN

			SELECT  coalesce(MAX(a.cd_fornecedor),'X')
			INTO STRICT	cd_fornecedor_w
			FROM  	fornecedor_mat_consignado a,
				material m
			WHERE 	a.cd_material	= m.cd_material_estoque
			AND   	m.cd_material   = cd_medicamento_w
			AND   	m.ie_situacao 	= 'A'
			AND	a.dt_mesano_referencia = TRUNC(dt_prescricao_w,'mm')
			AND qt_estoque = (	SELECT MAX(obter_saldo_estoque_consig(cd_estabelecimento_p, a.cd_fornecedor, a.cd_material, a.cd_local_estoque))
						FROM  	fornecedor_mat_consignado a,
								material m
						WHERE 	a.cd_material	= m.cd_material_estoque
						AND   	m.cd_material   = cd_medicamento_w
						AND   	m.ie_situacao 	= 'A'
						AND		a.dt_mesano_referencia = TRUNC(dt_prescricao_w,'mm'));

			IF (cd_fornecedor_w = 'X') THEN
				cd_fornecedor_w	:= NULL;
			END IF;

		END IF;

		IF (nr_seq_diluicao_w IS NOT NULL AND nr_seq_diluicao_w::text <> '') THEN
			SELECT 	MAX(nr_sequencia)
			INTO STRICT	nr_seq_diluicao_w
			FROM	prescr_material
			WHERE	nr_prescricao 	= nr_prescricao_w
			AND	nr_seq_material = nr_seq_diluicao_w;
		END IF;

		SELECT	coalesce(MAX(nr_sequencia),0) +1
		INTO STRICT	nr_seq_medic_w
		FROM	prescr_material
		WHERE	nr_prescricao	= nr_prescricao_w;

		Insert 	into dispensacao_quimioterapia(
			nr_sequencia,
			cd_material,
			cd_unidade_medida_dose,
			dt_atualizacao,
			dt_atualizacao_nrec,
			nm_usuario,
			nm_usuario_nrec,
			qt_dose,
			cd_unidade_conta,
			qt_material_conta,
			nr_seq_ordem,
			nr_prescricao,
			nr_seq_prescricao,
			cd_material_exec,
			ie_via_aplicacao)
		SELECT 	nextval('dispensacao_quimioterapia_seq'),
			cd_medicamento_w,
			cd_unid_med_prescr_w,
			clock_timestamp(),
			clock_timestamp(),
			nm_usuario_p,
			nm_usuario_p,
			qt_dose_prescricao_w,
			substr(Obter_Dados_Material(cd_medicamento_w,'UMC'),1,30),
			obter_dose_convertida(cd_medicamento_w,qt_dose_prescricao_w,cd_unid_med_prescr_w,substr(Obter_Dados_Material(cd_medicamento_w,'UMC'),1,30)),
			nr_seq_ordem_p,	
			nr_prescricao_www,
			nr_seq_prescricao_w,
			coalesce(cd_material_exec_w, cd_material_w),
			ie_via_aplicacao_w
		;
		
	ELSIF (IE_REGRA_W = 'ME') THEN
		select 	coalesce(max(cd_material_especifico),0)
		into STRICT	cd_medicamento_w
		from	regra_apresentacao_quimio
		where 	nr_sequencia = nr_sequencia_regra_w;

		if (cd_medicamento_w = 0) then
			 CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(196338);
		end if;
		
		IF (cd_unid_med_consumo_w = cd_unid_med_prescr_w) THEN
			qt_conversao_dose_w	:= 1;
		ELSE
			BEGIN
			SELECT	qt_conversao
			INTO STRICT	qt_conversao_dose_w
			FROM	material_conversao_unidade
			WHERE	cd_material 	= cd_medicamento_w
			AND	cd_unidade_medida = cd_unid_med_prescr_w;
			EXCEPTION
				WHEN OTHERS THEN
					qt_conversao_dose_w	:= 1;
			END;
		END IF;

		qt_unitaria_w		:= dividir(qt_dose_prescricao_w , qt_conversao_dose_w);
		qt_total_dispensar_w	:= dividir(qt_unitaria_w , qt_minimo_multiplo_solic_w) * qt_minimo_multiplo_solic_w;

		IF (qt_total_dispensar_w < qt_unitaria_w) THEN
			qt_total_dispensar_w := qt_total_dispensar_w + qt_minimo_multiplo_solic_w;
		END IF;

		SELECT	coalesce(MAX(ie_consignado), 'X')
		INTO STRICT	ie_consignado_w
		FROM  	material
		WHERE  	cd_material = cd_medicamento_w;

		IF (ie_consignado_w = '1') THEN

			SELECT  coalesce(MAX(a.cd_fornecedor),'X')
			INTO STRICT	cd_fornecedor_w
			FROM  	fornecedor_mat_consignado a,
				material m
			WHERE 	a.cd_material	= m.cd_material_estoque
			AND   	m.cd_material   = cd_medicamento_w
			AND   	m.ie_situacao 	= 'A'
			AND	a.dt_mesano_referencia = TRUNC(dt_prescricao_w,'mm')
			AND qt_estoque = (	SELECT MAX(obter_saldo_estoque_consig(cd_estabelecimento_p, a.cd_fornecedor, a.cd_material, a.cd_local_estoque))
						FROM  	fornecedor_mat_consignado a,
								material m
						WHERE 	a.cd_material	= m.cd_material_estoque
						AND   	m.cd_material   = cd_medicamento_w
						AND   	m.ie_situacao 	= 'A'
						AND		a.dt_mesano_referencia = TRUNC(dt_prescricao_w,'mm'));

			IF (cd_fornecedor_w = 'X') THEN
				cd_fornecedor_w	:= NULL;
			END IF;

		END IF;

		IF (nr_seq_diluicao_w IS NOT NULL AND nr_seq_diluicao_w::text <> '') THEN
			SELECT 	MAX(nr_sequencia)
			INTO STRICT	nr_seq_diluicao_w
			FROM	prescr_material
			WHERE	nr_prescricao 	= nr_prescricao_w
			AND	nr_seq_material = nr_seq_diluicao_w;
		END IF;

		SELECT	coalesce(MAX(nr_sequencia),0) +1
		INTO STRICT	nr_seq_medic_w
		FROM	prescr_material
		WHERE	nr_prescricao	= nr_prescricao_w;

		Insert 	into dispensacao_quimioterapia(
			nr_sequencia,
			cd_material,
			cd_unidade_medida_dose,
			dt_atualizacao,
			dt_atualizacao_nrec,
			nm_usuario,
			nm_usuario_nrec,
			qt_dose,
			cd_unidade_conta,
			qt_material_conta,
			nr_seq_ordem,
			nr_prescricao,
			nr_seq_prescricao,
			cd_material_exec,
			ie_via_aplicacao)
		SELECT 	nextval('dispensacao_quimioterapia_seq'),
			cd_medicamento_w,
			cd_unid_med_prescr_w,
			clock_timestamp(),
			clock_timestamp(),
			nm_usuario_p,
			nm_usuario_p,
			qt_dose_prescricao_w,
			substr(Obter_Dados_Material(cd_medicamento_w,'UMC'),1,30),
			obter_dose_convertida(cd_medicamento_w,qt_dose_prescricao_w,cd_unid_med_prescr_w,substr(Obter_Dados_Material(cd_medicamento_w,'UMC'),1,30)),
			nr_seq_ordem_p,
			nr_prescricao_www,
			nr_seq_prescricao_w,
			coalesce(cd_material_exec_w, cd_material_w),
			ie_via_aplicacao_w
		;
		
		commit;
	ELSE
		IF (cd_unid_med_consumo_w = cd_unid_med_prescr_w) THEN
			qt_conversao_dose_w	:= 1;
		ELSE
			BEGIN
			SELECT	qt_conversao
			INTO STRICT	qt_conversao_dose_w
			FROM	material_conversao_unidade
			WHERE	cd_material 	= cd_material_w
			AND	cd_unidade_medida = cd_unid_med_prescr_w;
			EXCEPTION
				WHEN OTHERS THEN
					qt_conversao_dose_w	:= 1;
			END;
		END IF;

		qt_unitaria_w		:= dividir(qt_dose_prescricao_w , qt_conversao_dose_w);
		qt_total_dispensar_w	:= dividir(qt_unitaria_w , qt_minimo_multiplo_solic_w) * qt_minimo_multiplo_solic_w;

		IF (qt_total_dispensar_w < qt_unitaria_w) THEN
			qt_total_dispensar_w := qt_total_dispensar_w + qt_minimo_multiplo_solic_w;
		END IF;

		SELECT	coalesce(MAX(ie_consignado), 'X')
		INTO STRICT	ie_consignado_w
		FROM  	material
		WHERE  	cd_material = cd_material_w;

		IF (ie_consignado_w = '1') THEN

			SELECT  coalesce(MAX(a.cd_fornecedor),'X')
			INTO STRICT	cd_fornecedor_w
			FROM  	fornecedor_mat_consignado a,
				material m
			WHERE 	a.cd_material	= m.cd_material_estoque
			AND   	m.cd_material   = cd_material_w
			AND   	m.ie_situacao 	= 'A'
			AND	a.dt_mesano_referencia = TRUNC(dt_prescricao_w,'mm')
			AND qt_estoque = (	SELECT MAX(obter_saldo_estoque_consig(cd_estabelecimento_p, a.cd_fornecedor, a.cd_material, a.cd_local_estoque))
						FROM  	fornecedor_mat_consignado a,
								material m
						WHERE 	a.cd_material	= m.cd_material_estoque
						AND   	m.cd_material   = cd_material_w
						AND   	m.ie_situacao 	= 'A'
						AND		a.dt_mesano_referencia = TRUNC(dt_prescricao_w,'mm'));

			IF (cd_fornecedor_w = 'X') THEN
				cd_fornecedor_w	:= NULL;
			END IF;

		END IF;

		IF (nr_seq_diluicao_w IS NOT NULL AND nr_seq_diluicao_w::text <> '') THEN
			SELECT 	MAX(nr_sequencia)
			INTO STRICT	nr_seq_diluicao_w
			FROM	prescr_material
			WHERE	nr_prescricao 	= nr_prescricao_w
			AND	nr_seq_material = nr_seq_diluicao_w;
		END IF;

		SELECT	coalesce(MAX(nr_sequencia),0) +1
		INTO STRICT	nr_seq_medic_w
		FROM	prescr_material
		WHERE	nr_prescricao	= nr_prescricao_w;

			Insert 	into dispensacao_quimioterapia(
				nr_sequencia,
				cd_material,
				cd_unidade_medida_dose,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nm_usuario,
				nm_usuario_nrec,
				qt_dose,
				cd_unidade_conta,
				qt_material_conta,
				nr_seq_ordem,
				nr_prescricao,
				nr_seq_prescricao,
				cd_material_exec,
				ie_via_aplicacao)
			SELECT 	nextval('dispensacao_quimioterapia_seq'),
				cd_material_w,
				cd_unid_med_prescr_w,
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_p,
				nm_usuario_p,
				qt_dose_prescricao_w,
				substr(Obter_Dados_Material(cd_material_w,'UMC'),1,30),
				obter_dose_convertida(cd_material_w,qt_dose_prescricao_w,cd_unid_med_prescr_w,substr(Obter_Dados_Material(cd_material_w,'UMC'),1,30)),
				nr_seq_ordem_p,
				nr_prescricao_www,
				nr_seq_prescricao_w,
				coalesce(cd_material_exec_w, cd_material_w),
				ie_via_aplicacao_w
			;
			
			commit;
		END IF;
	END;
END LOOP;
CLOSE c01;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_dispensacao_quimio ( nr_seq_atendimento_p bigint, cd_estabelecimento_p bigint, nr_atendimento_p bigint, nr_seq_ordem_p bigint, nm_usuario_p text) FROM PUBLIC;

