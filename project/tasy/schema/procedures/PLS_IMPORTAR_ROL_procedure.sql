-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_importar_rol ( ds_linha_p text, nr_seq_rol_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_posicao_w				integer;
ds_linha_w					varchar(4000);
nr_sequencia_w				bigint;
DS_GRUPO_PROC_w				varchar(4000);
DS_CAPITULO_w				varchar(4000);
DS_GRUPO_w					varchar(4000);
DS_SUBGRUPO_w				varchar(4000);
nr_seq_capitulo_w			bigint;
nr_seq_grupo_w				bigint;
nr_seq_subgrupo_w			bigint;
nr_seq_grupo_proc_w			bigint;
nr_seq_cap_atual_w			bigint;
nr_seq_grupo_atual_w		bigint;
nr_seq_subgrupo_atual_w		bigint;
nr_seq_grupo_proc_atual_w	bigint;


BEGIN

	ds_linha_w := ds_linha_p;

	/*1*/

	select	position('#' in ds_linha_w)
	into STRICT	nr_posicao_w
	;

	select	trim(both substr(ds_linha_w,1,nr_posicao_w -1))
	into STRICT	DS_GRUPO_PROC_w
	;

	select	substr(ds_linha_w,nr_posicao_w + 1,length(ds_linha_w))
	into STRICT	ds_linha_w
	;

	/*2*/

	select	position('#' in ds_linha_w)
	into STRICT	nr_posicao_w
	;

	select	trim(both substr(ds_linha_w,1,nr_posicao_w -1))
	into STRICT	DS_SUBGRUPO_w
	;

	select	substr(ds_linha_w,nr_posicao_w + 1,length(ds_linha_w))
	into STRICT	ds_linha_w
	;

	/*3*/

	select	position('#' in ds_linha_w)
	into STRICT	nr_posicao_w
	;

	select	trim(both substr(ds_linha_w,1,nr_posicao_w -1))
	into STRICT	DS_GRUPO_w
	;

	select	substr(ds_linha_w,nr_posicao_w + 1,length(ds_linha_w))
	into STRICT	ds_linha_w
	;

	/*4*/

	select	position('#' in ds_linha_w)
	into STRICT	nr_posicao_w
	;

	select	trim(both substr(ds_linha_w,1,nr_posicao_w -1))
	into STRICT	DS_CAPITULO_w
	;

	select	substr(ds_linha_w,nr_posicao_w + 1,length(ds_linha_w))
	into STRICT	ds_linha_w
	;

	/* **************************************************************************************************************************************** */

	/* Capitulo */

	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_seq_cap_atual_w
	from	pls_rol_capitulo
	where	upper(ds_capitulo) = upper(ds_capitulo_w)
	and		nr_seq_rol = nr_seq_rol_p;

	if (nr_seq_cap_atual_w = 0) then
		select	coalesce(max(nr_sequencia),0) + 1
		into STRICT	nr_seq_capitulo_w
		from	pls_rol_capitulo;

		insert	into pls_rol_capitulo(	NR_SEQUENCIA,
										DT_ATUALIZACAO,
										NM_USUARIO,
										DT_ATUALIZACAO_NREC,
										NM_USUARIO_NREC,
										NR_SEQ_ROL,
										DS_CAPITULO)
								values ( nr_seq_capitulo_w,
										clock_timestamp(),
										nm_usuario_p,
										clock_timestamp(),
										nm_usuario_p,
										nr_seq_rol_p,
										ds_capitulo_w);
	else
		nr_seq_capitulo_w := nr_seq_cap_atual_w;
	end if;

	/* Grupo */

	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_seq_grupo_atual_w
	from	pls_rol_grupo
	where	upper(ds_grupo) = upper(ds_grupo_w)
	and		nr_seq_rol = nr_seq_rol_p;

	if (nr_seq_grupo_atual_w = 0) then

		select	coalesce(max(nr_sequencia),0) + 1
		into STRICT	nr_seq_grupo_w
		from	pls_rol_grupo;

		insert into pls_rol_grupo(	NR_SEQUENCIA,
									DT_ATUALIZACAO,
									NM_USUARIO,
									DT_ATUALIZACAO_NREC,
									NM_USUARIO_NREC,
									DS_GRUPO,
									NR_SEQ_ROL,
									NR_SEQ_CAPITULO)
							values (	nr_seq_grupo_w,
									clock_timestamp(),
									nm_usuario_p,
									clock_timestamp(),
									nm_usuario_p,
									ds_grupo_w,
									nr_seq_rol_p,
									nr_seq_capitulo_w);
	else
		nr_seq_grupo_w := nr_seq_grupo_atual_w;
	end if;

	/* Subgrupo */

	select	coalesce(max(a.nr_sequencia),0)
	into STRICT	nr_seq_subgrupo_atual_w
	from	pls_rol_subgrupo a,
			pls_rol_grupo b
	where	upper(a.ds_subgrupo) 	= upper(ds_subgrupo_w)
	and		upper(ds_grupo_w)		= upper(ds_grupo)
	and		a.nr_seq_grupo 			= b.nr_sequencia
	and		b.nr_seq_rol 			= nr_seq_rol_p;

	if (nr_seq_subgrupo_atual_w = 0) then
		select	coalesce(max(nr_sequencia),0) + 1
		into STRICT	nr_seq_subgrupo_w
		from	pls_rol_subgrupo;

		insert into pls_rol_subgrupo(	NR_SEQUENCIA,
										DT_ATUALIZACAO,
										NM_USUARIO,
										DT_ATUALIZACAO_NREC,
										NM_USUARIO_NREC,
										DS_SUBGRUPO,
										NR_SEQ_GRUPO)
								values (	nr_seq_subgrupo_w,
										clock_timestamp(),
										nm_usuario_p,
										clock_timestamp(),
										nm_usuario_p,
										ds_subgrupo_w,
										nr_seq_grupo_w);

	else
		nr_seq_subgrupo_w := nr_seq_subgrupo_atual_w;
	end if;

	/*	Grupo Proc	*/

	select	coalesce(max(a.nr_sequencia),0)
	into STRICT	nr_seq_grupo_proc_atual_w
	from	pls_rol_grupo_proc a,
			pls_rol_subgrupo b,
			pls_rol_grupo c
	where	a.nr_seq_subgrupo	= b.nr_sequencia
	and		b.nr_seq_grupo		= c.nr_sequencia
	and		upper(a.ds_rol_grupo)	= upper(ds_grupo_proc_w)
	and		upper(b.ds_subgrupo)	= upper(ds_subgrupo_w)
	and		c.nr_seq_rol		= nr_seq_rol_p;

	if (nr_seq_grupo_proc_atual_w = 0) then

		select	coalesce(max(nr_sequencia),0) + 1
		into STRICT	nr_seq_grupo_proc_w
		from	pls_rol_grupo_proc;

		insert into pls_rol_grupo_proc(	NR_SEQUENCIA,
										DT_ATUALIZACAO,
										NM_USUARIO,
										DT_ATUALIZACAO_NREC,
										NM_USUARIO_NREC,
										DS_ROL_GRUPO,
										NR_SEQ_GRUPO,
										NR_SEQ_SUBGRUPO)
								values (	nr_seq_grupo_proc_w,
										clock_timestamp(),
										nm_usuario_p,
										clock_timestamp(),
										nm_usuario_p,
										ds_grupo_proc_w,
										nr_seq_grupo_w,
										nr_seq_subgrupo_w);
	end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_importar_rol ( ds_linha_p text, nr_seq_rol_p bigint, nm_usuario_p text) FROM PUBLIC;

