-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_marca_cot_compra_forn (nr_sequencia_p bigint, ds_marca_fornec_p text, nm_usuario_p text) AS $body$
DECLARE


cd_material_w		integer;
ds_marca_anterior_w 	varchar(30);
nr_item_cot_compra_w	integer;
nr_cot_compra_w		bigint;
cd_cgc_fornecedor_w	varchar(14);
ds_razao_social_w		varchar(80);
historico_w		varchar(4000);
ds_material_w		varchar(255);


BEGIN
select	a.cd_material,
	m.ds_material,
	a.ds_marca_fornec,
	coalesce(b.cd_cgc_fornecedor, b.cd_pessoa_fisica),
	substr(obter_nome_pf_pj(b.cd_pessoa_fisica, b.cd_cgc_fornecedor),1,80),
	a.nr_cot_compra, 
	a.nr_item_cot_compra
into STRICT	cd_material_w,
	ds_material_w,
	ds_marca_anterior_w,
	cd_cgc_fornecedor_w,
	ds_razao_social_w,
	nr_cot_compra_w,
	nr_item_cot_compra_w	
from 	cot_compra_forn_item a, 
	cot_compra_forn b,
	material m
where	a.nr_sequencia = nr_sequencia_p
and	a.nr_seq_cot_forn = b.nr_sequencia
and	a.cd_material = m.cd_material;
update 	cot_compra_forn_item
set 	ds_marca_fornec	= substr(ds_marca_fornec_p,1,30),
	nm_usuario	= nm_usuario_p,
	dt_atualizacao	= clock_timestamp()
where 	nr_sequencia 	= nr_sequencia_p;
		
historico_w := (WHEB_MENSAGEM_PCK.get_texto(297036,'NR_ITEM_COT_COMPRA_W=' || nr_item_cot_compra_w || ';' || 'CD_MATERIAL_W=' || cd_material_w || ';' ||
						   'DS_MATERIAL=' || ds_material_w || ';' || 'DS_RAZAO_SOCIAL_W=' || ds_razao_social_w || ';' ||
						   'DS_MARCA_ANTERIOR_W=' || DS_MARCA_ANTERIOR_W || ';' || 'DS_MARCA_FORNEC_P=' || DS_MARCA_FORNEC_P));
	
insert into cot_compra_hist(nr_sequencia,
	nr_cot_compra,
	dt_atualizacao,
	nm_usuario,
	dt_historico,
	ds_titulo,
	ds_historico,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	ie_origem,
	ie_tipo)
values (nextval('cot_compra_hist_seq'),
	nr_cot_compra_w,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	WHEB_MENSAGEM_PCK.get_texto(297049),
	historico_w,
	clock_timestamp(),
	nm_usuario_p,
	'S','H');
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_marca_cot_compra_forn (nr_sequencia_p bigint, ds_marca_fornec_p text, nm_usuario_p text) FROM PUBLIC;

