-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE devolucao_adiantamento_cheque ( nr_adiantamento_p bigint, nr_seq_cheque_p bigint, dt_transacao_p timestamp, nm_usuario_p text) AS $body$
DECLARE


vl_cheque_w			double precision 	:= 0;
vl_saldo_adiant_w		double precision	:= 0;
nr_adiantamento_w		bigint	:= 0;
nr_sequencia_w			integer	:= 0;
cd_moeda_w			integer	:= 0;
-- Projeto Multimoeda
vl_cheque_estrang_w		double precision;
vl_cotacao_w			cotacao_moeda.vl_cotacao%type;
vl_complemento_w		double precision;


BEGIN

select	vl_cheque,
	coalesce(nr_adiantamento,0),
	cd_moeda,
	vl_cheque_estrang,
	vl_cotacao
into STRICT	vl_cheque_w,
	nr_adiantamento_w,
	cd_moeda_w,
	vl_cheque_estrang_w,
	vl_cotacao_w
from 	cheque_cr
where	nr_seq_cheque	= nr_seq_cheque_p;

/* Francisco - OS 51932 - Incluí o  tratamento abaixo e modifiquei a frase da consitência */

if (nr_adiantamento_w = 0) then
	select	coalesce(max(nr_adiantamento),0)
	into STRICT	nr_adiantamento_w
	from	adiantamento_cheque_cr
	where	nr_seq_cheque	= nr_seq_cheque_p;
end if;

select	coalesce(max(vl_saldo),0)
into STRICT	vl_saldo_adiant_w
from	adiantamento
where	nr_adiantamento	= nr_adiantamento_p;

/* Busca moeda padrão somente se a moeda do cheque não estiver preenchida - projeto multimoeda*/

if (cd_moeda_w IS NOT NULL AND cd_moeda_w::text <> '') then
	select	coalesce(max(cd_moeda_padrao),1)
	into STRICT	cd_moeda_w
	from	parametro_contas_receber;
end if;

if (nr_adiantamento_w <> nr_adiantamento_p) then
	--r.aise_application_error(-20011,'O adiantamento do cheque é diferente do adiantamento selecionado !!!');
	CALL wheb_mensagem_pck.exibir_mensagem_abort(266483);
end if;


if (vl_cheque_w > 0) and (vl_cheque_w <= vl_saldo_adiant_w) then
	begin

	select	coalesce(max(nr_sequencia),0) + 1
	into STRICT	nr_sequencia_w
	from	adiantamento_dev
	where	nr_adiantamento	= nr_adiantamento_p;

	/* Projeto Multimoeda - verifica se possui valor estrangeiro gravado, se não grava null nos campos*/

	if (coalesce(vl_cheque_estrang_w,0) = 0) then
		vl_cheque_estrang_w := null;
		vl_cotacao_w := null;
		vl_complemento_w := null;
	else
		vl_complemento_w := vl_cheque_w - vl_cheque_estrang_w;
	end if;

	insert into adiantamento_dev(
		nr_adiantamento,
		nr_sequencia,
		dt_devolucao,
		vl_devolucao,
		vl_devolucao_estrang,
		cd_moeda,
		vl_cotacao,
		vl_complemento,
		dt_atualizacao,
		nm_usuario,
		ds_motivo_dev,
		nr_lote_contabil,
		nr_seq_trans_fin)
	values (nr_adiantamento_p,
		nr_sequencia_w,
		coalesce(trunc(dt_transacao_p), clock_timestamp()),
		vl_cheque_w,
		vl_cheque_estrang_w,
		cd_moeda_w,
		vl_cotacao_w,
		vl_complemento_w,
		clock_timestamp(),
		nm_usuario_p,
		null,null,null);


	update 	cheque_cr
	set	dt_devolucao	= clock_timestamp(),
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_seq_cheque	= nr_seq_cheque_p;


	if (vl_saldo_adiant_w = vl_cheque_w) then
		update	adiantamento
		set	vl_saldo	= 0,
			dt_baixa	= clock_timestamp(),
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p
		where	nr_adiantamento	= nr_adiantamento_p;
	else
		update	adiantamento
		set	vl_saldo	= vl_saldo - vl_cheque_w,
			dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p
		where	nr_adiantamento	= nr_adiantamento_p;
	end if;
	end;
else
     --r.aise_application_error(-20011,'Este cheque é maior que o valor do adiantamento !!!');
     CALL wheb_mensagem_pck.exibir_mensagem_abort(266484);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE devolucao_adiantamento_cheque ( nr_adiantamento_p bigint, nr_seq_cheque_p bigint, dt_transacao_p timestamp, nm_usuario_p text) FROM PUBLIC;

