-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_agentes_medicamentos ( cd_estabelecimento_p bigint, nr_seq_agente_p bigint, nr_cirurgia_p bigint, cd_material_p bigint, cd_profissional_p text, nm_usuario_p text, nr_sequencia_p INOUT bigint, ie_via_aplicacao_p text, cd_unidade_medida_p text, ie_tipo_dosagem_p text, nr_seq_pepo_p bigint, ie_modo_adm_p text default null, ds_justificativa_p text default null, ds_just_alergico_p text default null, ie_integracao_p text default 'N', cd_lista_comp_sol_p text default null) AS $body$
DECLARE


cd_material_w				integer;
ie_modo_adm_w				varchar(5);
ie_via_aplicacao_w			varchar(5);
ie_tipo_dosagem_w			varchar(15);
ie_disp_infusao_w			varchar(1);
nr_sequencia_w				bigint;
cd_unid_med_apres_w			varchar(30);
qt_dose_padrao_w			double precision;
cd_unid_med_inter_w			varchar(30);
ie_tipo_w				smallint;
ie_cadastrado_w				varchar(1);
ie_libera_agente_pepo_w			varchar(1);
ie_libera_terapia_pepo_w		varchar(1);
ie_libera_medic_pepo_w			varchar(1);
ie_libera_material_pepo_w		varchar(1);
ie_libera_w				varchar(1) := 'S';
ie_unid_cadastro_mat_w			varchar(1);



BEGIN


ie_unid_cadastro_mat_w := obter_param_usuario(872, 417, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_unid_cadastro_mat_w);

select	--nvl(max(ie_libera_agente_pepo),'N'),
	coalesce(max('N'),'N'),
	--nvl(max(ie_libera_medic_pepo),'N'),
	coalesce(max('N'),'N'),
	coalesce(CASE WHEN pkg_i18n.get_user_locale ='en_AU' THEN max(ie_libera_material_pepo)  ELSE max('N') END ,'N'),
	--nvl(max(ie_libera_material_pepo),'N'),
	coalesce(max('N'),'N')
	--nvl(max(ie_libera_terapia_pepo),'N')
into	ie_libera_agente_pepo_w,
	ie_libera_medic_pepo_w,
	ie_libera_material_pepo_w,
	ie_libera_terapia_pepo_w
from	parametro_medico
where	cd_estabelecimento = cd_estabelecimento_p;

if (coalesce(cd_material_p,0) = 0) then
	begin
	select	max(cd_material),
		coalesce(max(qt_dose),1)
	into STRICT	cd_material_w,
		qt_dose_padrao_w
	from	agente_anest_material
	where	nr_seq_agente	= nr_seq_agente_p;
	end;
else
	cd_material_w	:= cd_material_p;
end if;

select	coalesce(max('S'),'N')
into STRICT	ie_cadastrado_w
from	agente_anest_material
where	cd_material	= cd_material_w
and	nr_seq_agente	= nr_seq_agente_p;

if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (ie_cadastrado_w = 'S') and (coalesce(ie_via_aplicacao_p::text, '') = '') then
	select	max(ie_via_aplicacao),
		coalesce(max(qt_dose),1)
	into STRICT	ie_via_aplicacao_w,
		qt_dose_padrao_w
	from	agente_anest_material
	where	cd_material		= cd_material_w
	and		nr_seq_agente	= nr_seq_agente_p;
elsif (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (ie_cadastrado_w = 'N') and (coalesce(ie_via_aplicacao_p::text, '') = '') then
	select	max(ie_via_aplicacao),
		max(1)
	into STRICT	ie_via_aplicacao_w,
		qt_dose_padrao_w
	from	material
	where	cd_material	=	cd_material_w;
elsif (ie_via_aplicacao_p IS NOT NULL AND ie_via_aplicacao_p::text <> '') then
	ie_via_aplicacao_w := ie_via_aplicacao_p;
	select	coalesce(max(qt_dose),1)
	into STRICT	qt_dose_padrao_w
	from	agente_anest_material
	where	cd_material		= cd_material_w
	and	nr_seq_agente	= nr_seq_agente_p;
end if;

select	coalesce(ie_modo_adm_p,ie_modo_adm),
	CASE WHEN coalesce(ie_modo_adm_p,ie_modo_adm)='CO' THEN  ie_tipo_dosagem  ELSE null END ,
	ie_disp_infusao,
	cd_unid_med_apres,
	CASE WHEN coalesce(ie_modo_adm_p,ie_modo_adm)='IN' THEN  cd_unidade_medida  ELSE null END ,
	ie_tipo
into STRICT	ie_modo_adm_w,
	ie_tipo_dosagem_w,
	ie_disp_infusao_w,
	cd_unid_med_apres_w,
	cd_unid_med_inter_w,
	ie_tipo_w
from 	agente_anestesico
where	nr_sequencia	=	nr_seq_agente_p;

if	(ie_tipo_w = 1 AND ie_libera_agente_pepo_w = 'N') or
	(ie_tipo_w = 2 AND ie_libera_terapia_pepo_w = 'N') or
	(ie_tipo_w = 3 AND ie_libera_medic_pepo_w = 'N') or
	(ie_tipo_w = 4 AND ie_libera_material_pepo_w = 'N') then
	ie_libera_w := 'N';
end if;


if (coalesce(cd_unid_med_inter_w::text, '') = '') then
	cd_unid_med_inter_w:= cd_unidade_medida_p;
end if;

if (coalesce(ie_tipo_dosagem_w::text, '') = '') then
	ie_tipo_dosagem_w := ie_tipo_dosagem_p;
end if;

if (ie_modo_adm_w = 'CO') then
	cd_unid_med_inter_w	:= null;
else
	ie_tipo_dosagem_w	:= null;
end if;

select	nextval('cirurgia_agente_anestesico_seq')
into STRICT	nr_sequencia_w
;

nr_sequencia_p	:= nr_sequencia_w;

if (ie_unid_cadastro_mat_w = 'S') and (coalesce(cd_unid_med_apres_w::text, '') = '') then
	select	max(cd_unidade_medida_consumo)
	into STRICT	cd_unid_med_apres_w
	from	material
	where	cd_material = cd_material_w;
end if;

insert into cirurgia_agente_anestesico(
	nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	nr_cirurgia,
	nr_seq_agente,
	cd_material,
	cd_profissional,
	ie_modo_adm,
	ie_tipo_dosagem,
	ie_via_aplicacao,
	ie_disp_infusao,
	cd_unidade_medida,
	qt_dose,
	cd_unid_medida_adm,
	ie_tipo,
	nm_usuario_nrec,
	dt_atualizacao_nrec,
	nr_seq_pepo,
	ie_situacao,
	dt_liberacao,
	ds_justificativa,
   ds_just_alergico,
   ie_integracao)
values (
	nr_sequencia_w,
	clock_timestamp(),
	nm_usuario_p,
	nr_cirurgia_p,
	nr_seq_agente_p,
	cd_material_w,
	cd_profissional_p,
	ie_modo_adm_w,
	ie_tipo_dosagem_w,
	ie_via_aplicacao_w,
	ie_disp_infusao_w,
	cd_unid_med_apres_w,
	qt_dose_padrao_w,
	cd_unid_med_inter_w,
	ie_tipo_w,
	nm_usuario_p,
	clock_timestamp(),
	nr_seq_pepo_p,
	'A',
	CASE WHEN ie_libera_w='S' THEN clock_timestamp()  ELSE null END ,
	SUBSTR(ds_justificativa_p,1,255),
   SUBSTR(ds_just_alergico_p,1,255),
   ie_integracao_p);

commit;

if (cd_lista_comp_sol_p IS NOT NULL AND cd_lista_comp_sol_p::text <> '') then
	CALL gerar_componentes_agente(nr_sequencia_w, cd_lista_comp_sol_p, nm_usuario_p, nr_seq_agente_p);
elsif (cd_material_w IS NOT NULL AND cd_material_w::text <> '') then
	CALL gerar_reconst_diluicao_agente(cd_estabelecimento_p,nr_sequencia_w,'A', nm_usuario_p);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_agentes_medicamentos ( cd_estabelecimento_p bigint, nr_seq_agente_p bigint, nr_cirurgia_p bigint, cd_material_p bigint, cd_profissional_p text, nm_usuario_p text, nr_sequencia_p INOUT bigint, ie_via_aplicacao_p text, cd_unidade_medida_p text, ie_tipo_dosagem_p text, nr_seq_pepo_p bigint, ie_modo_adm_p text default null, ds_justificativa_p text default null, ds_just_alergico_p text default null, ie_integracao_p text default 'N', cd_lista_comp_sol_p text default null) FROM PUBLIC;

