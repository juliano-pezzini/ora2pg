-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE med_alterar_status_agecons ( cd_agenda_p bigint, nr_seq_agenda_p bigint, ie_status_p text, cd_motivo_p text, ds_motivo_p text, ie_agenda_dia_p text, nm_usuario_p text) AS $body$
DECLARE


dt_agenda_w	timestamp;
nr_minuto_w	bigint;
ie_status_w	varchar(3);
cd_pf_w		varchar(10);
ds_erro_w	varchar(255);
qt_hor_cancel_w	bigint;


BEGIN
if (cd_agenda_p IS NOT NULL AND cd_agenda_p::text <> '') and (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') and (ie_status_p IS NOT NULL AND ie_status_p::text <> '') then
	begin
	if (ie_status_p = 'B') then
		begin
		select	max(dt_agenda),
			max(nr_minuto_duracao),
			coalesce(max(ie_status_agenda),ie_status_p),
			max(cd_pessoa_fisica)
		into STRICT	dt_agenda_w,
			nr_minuto_w,
			ie_status_w,
			cd_pf_w
		from	agenda_consulta
		where	nr_sequencia = nr_seq_agenda_p;

		if (ie_status_w = 'B') then
			begin
			update	agenda_consulta
			set	ie_status_agenda	= 'L',
				dt_status		 = NULL,
				nm_usuario_status	 = NULL,
				ds_motivo_status	 = NULL,
				nr_seq_motivo_transf	 = NULL,
				nm_usuario		= nm_usuario_p,
				dt_atualizacao = clock_timestamp()
			where	nr_sequencia		= nr_seq_agenda_p;
			end;
		else
			begin
			update	agenda_consulta
			set	ie_status_agenda	= 'B',
				dt_status		= clock_timestamp(),
				nm_usuario_status	= nm_usuario_p,
				ds_motivo_status	= ds_motivo_p,
				nr_seq_motivo_transf	= cd_motivo_p,
				nm_usuario		= nm_usuario_p,
				dt_atualizacao = clock_timestamp()
			where	nr_sequencia		= nr_seq_agenda_p;
			end;
		end if;
		end;
	elsif (ie_status_p = 'C') then
		begin
		select	max(dt_agenda),
			max(nr_minuto_duracao),
			coalesce(max(ie_status_agenda),ie_status_p),
			max(cd_pessoa_fisica)
		into STRICT	dt_agenda_w,
			nr_minuto_w,
			ie_status_w,
			cd_pf_w
		from	agenda_consulta
		where	nr_sequencia = nr_seq_agenda_p;

		if (ie_status_w = 'C') then
			begin
			ds_erro_w := consistir_horario_agecons(cd_agenda_p, dt_agenda_w, nr_minuto_w, 'S', ds_erro_w);

			if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
				begin
				CALL Wheb_mensagem_pck.exibir_mensagem_abort( 262328 , 'DS_MENSAGEM='||ds_erro_w);
				end;
			else
				begin
				update	agenda_consulta
				set	dt_agenda		= to_date(to_char(dt_agenda_w,'dd/mm/yyyy hh24:mi') || ':00','dd/mm/yyyy hh24:mi:ss'),
					ie_status_agenda	= 'N',
					nm_usuario_status	 = NULL,
					dt_status		 = NULL,
					ds_motivo_status	 = NULL,
					cd_motivo_cancelamento	 = NULL,
					nm_usuario		= nm_usuario_p,
					dt_atualizacao = clock_timestamp()
				where	nr_sequencia		= nr_seq_agenda_p;
				end;
			end if;
			end;
		else
			begin
			select	coalesce(max((to_char(dt_agenda,'ss'))::numeric ),0)+1
			into STRICT	qt_hor_cancel_w
			from	agenda_consulta
			where	cd_agenda = cd_agenda_p
			and	to_date(to_char(dt_agenda,'dd/mm/yyyy hh24:mi') || ':00', 'dd/mm/yyyy hh24:mi:ss') = to_date(to_char(dt_agenda_w,'dd/mm/yyyy hh24:mi') || ':00', 'dd/mm/yyyy hh24:mi:ss')
			and	ie_status_agenda = 'C';

			update	agenda_consulta
			set	dt_agenda		= dt_agenda + qt_hor_cancel_w / 86400,
				ie_status_agenda	= 'C',
				nm_usuario_status	= nm_usuario_p,
				dt_status		= clock_timestamp(),
				ds_motivo_status	= ds_motivo_p,
				cd_motivo_cancelamento	= cd_motivo_p,
				nm_usuario		= nm_usuario_p,
				dt_atualizacao = clock_timestamp()
			where	nr_sequencia		= nr_seq_agenda_p;
			end;
		end if;
		end;
	elsif (ie_status_p in ('F','I')) then
		begin
		update	agenda_consulta
		set	ie_status_agenda	= ie_status_p,
			dt_status		= clock_timestamp(),
			ds_motivo_status	= ds_motivo_p,
			nm_usuario_status	= nm_usuario_p,
			nm_usuario		= nm_usuario_p,
			dt_atualizacao = clock_timestamp()
		where	nr_sequencia		= nr_seq_agenda_p;
		end;
	elsif (ie_status_p = 'RF') then
		begin
		update	agenda_consulta
		set	ie_status_agenda	= 'N',
			dt_status		 = NULL,
			ds_motivo_status	 = NULL,
			nm_usuario_status	 = NULL,
			nm_usuario		= nm_usuario_p,
			dt_atualizacao = clock_timestamp()
		where	nr_sequencia		= nr_seq_agenda_p;
		end;
	elsif (ie_status_p = 'AC') then
		begin
		update	agenda_consulta
		set	dt_confirmacao		= clock_timestamp(),
			nm_usuario_confirm	= nm_usuario_p,
			nm_usuario		= nm_usuario_p
		where	nr_sequencia		= nr_seq_agenda_p;
		end;
	elsif (ie_status_p = 'RC') then
		begin
		update	agenda_consulta
		set	dt_confirmacao		 = NULL,
			nm_usuario_confirm	 = NULL,
			nm_usuario		= nm_usuario_p
		where	nr_sequencia		= nr_seq_agenda_p;
		end;
	elsif (ie_status_p = 'A') then
		begin
		update	agenda_consulta
		set	ie_status_agenda	= 'A',
			dt_aguardando		= clock_timestamp(),
			nm_usuario_aguardando	= nm_usuario_p,
			nm_usuario		= nm_usuario_p
		where	nr_sequencia		= nr_seq_agenda_p;
		end;
	elsif (ie_status_p = 'RA') then
		begin
		update	agenda_consulta
		set	ie_status_agenda	= 'N',
			dt_aguardando		 = NULL,
			nm_usuario_aguardando	 = NULL,
			nm_usuario		= nm_usuario_p
		where	nr_sequencia		= nr_seq_agenda_p;
		end;
	elsif (ie_status_p = 'O') then
		begin
		update	agenda_consulta
		set	ie_status_agenda	= 'O',
			dt_consulta		= clock_timestamp(),
			nm_usuario_consulta	= nm_usuario_p,
			nm_usuario		= nm_usuario_p
		where	nr_sequencia		= nr_seq_agenda_p;
		end;
	elsif (ie_status_p = 'RO') then
		begin
		update	agenda_consulta
		set	ie_status_agenda	= 'A',
			dt_consulta		 = NULL,
			nm_usuario_consulta	 = NULL,
			nm_usuario		= nm_usuario_p
		where	nr_sequencia		= nr_seq_agenda_p;
		end;
	elsif (ie_status_p = 'E') then
		begin
		update	agenda_consulta
		set	ie_status_agenda	= 'E',
			dt_atendido		= clock_timestamp(),
			nm_usuario_atendido	= nm_usuario_p,
			nm_usuario		= nm_usuario_p
		where	nr_sequencia		= nr_seq_agenda_p;
		end;
	elsif (ie_status_p = 'RE') then
		begin
		update	agenda_consulta
		set	ie_status_agenda	= 'O',
			dt_atendido		 = NULL,
			nm_usuario_atendido	 = NULL,
			nm_usuario		= nm_usuario_p
		where	nr_sequencia		= nr_seq_agenda_p;
		end;
	end if;

	/*
	if	(nvl(ie_agenda_dia_p,'N') = 'S') and
		(ie_status_p in ('A','O','AC')) then
		begin
		select	max(dt_agenda),
			max(cd_pessoa_fisica)
		into	dt_agenda_w,
			cd_pf_w
		from	agenda_consulta
		where	nr_sequencia = nr_seq_agenda_p;

		alterar_status_agecons_dia(nr_seq_agenda_p, dt_agenda_w, ie_status_p, cd_pf_w, nm_usuario_p);
		end;
	end if;
	*/
	end;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE med_alterar_status_agecons ( cd_agenda_p bigint, nr_seq_agenda_p bigint, ie_status_p text, cd_motivo_p text, ds_motivo_p text, ie_agenda_dia_p text, nm_usuario_p text) FROM PUBLIC;

