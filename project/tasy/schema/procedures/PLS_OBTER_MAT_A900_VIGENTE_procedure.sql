-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_mat_a900_vigente ( nr_seq_material_p INOUT bigint, dt_referencia_p timestamp, cd_material_a900_p INOUT text, nr_versao_tiss_p pls_material.ds_versao_tiss%type) AS $body$
DECLARE


/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Aplicar apenas os materiais A900 vigentes

ROTINA UTILIZADA NAS TRANSAÇÕES PTU VIA SCS HOMOLOGADAS COM A UNIMED BRASIL.
QUANDO FOR ALTERAR, FAVOR VERIFICAR COM O ANÁLISTA RESPONSÁVEL PARA A REALIZAÇÃO DE TESTES.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[ X]  Objetos do dicionário [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/dt_referencia_w		timestamp;
cd_material_a900_w	varchar(30) := null;
nr_seq_material_w	bigint := null;

C01 CURSOR FOR
	SELECT	a.cd_material_a900
	from	pls_material_a900 a,
		pls_material m
	where	m.nr_sequencia	= a.nr_seq_material
	and	a.nr_seq_material = nr_seq_material_p
	and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_p) and coalesce(a.dt_fim_vigencia,dt_referencia_p)
	and	coalesce(m.ie_sistema_ant,'N') = 'N'
	order by a.dt_inicio_vigencia;

C02 CURSOR FOR
	SELECT	a.nr_seq_material
	from	pls_material_a900 a,
		pls_material m
	where	m.nr_sequencia	= a.nr_seq_material
	and	a.cd_material_a900 = cd_material_a900_p
	and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_p) and coalesce(a.dt_fim_vigencia,dt_referencia_p)
	and	coalesce(m.ie_sistema_ant,'N') = 'N'
	order by a.dt_inicio_vigencia;


BEGIN
dt_referencia_w := trunc(coalesce(dt_referencia_p,clock_timestamp()),'dd');

if (coalesce(cd_material_a900_p::text, '') = '') and (nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') then
	open C01;
	loop
	fetch C01 into
		cd_material_a900_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	end loop;
	close C01;

	if (coalesce(cd_material_a900_w::text, '') = '') then
		select	max(cd_material_a900)
		into STRICT	cd_material_a900_w
		from	pls_material
		where	nr_sequencia = nr_seq_material_p
		and	coalesce(ie_sistema_ant,'N') = 'N'
		and	dt_referencia_w between coalesce(dt_inclusao,dt_referencia_w) and coalesce(dt_exclusao,dt_referencia_w);
	end if;

	cd_material_a900_p := cd_material_a900_w;

elsif (coalesce(nr_seq_material_p::text, '') = '') and (cd_material_a900_p IS NOT NULL AND cd_material_a900_p::text <> '') then
	open c02;
	loop
	fetch c02 into
		nr_seq_material_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
	end loop;
	close c02;

	if (coalesce(nr_seq_material_w::text, '') = '') then
		 nr_seq_material_w := pls_obter_mat_tiss_vigente( nr_seq_material_w, dt_referencia_w, cd_material_a900_p, 'AC', 'S', nr_versao_tiss_p);
	end if;

	nr_seq_material_p := nr_seq_material_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_mat_a900_vigente ( nr_seq_material_p INOUT bigint, dt_referencia_p timestamp, cd_material_a900_p INOUT text, nr_versao_tiss_p pls_material.ds_versao_tiss%type) FROM PUBLIC;

