-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_integracao_conexa (nr_seq_agenda_p bigint, cd_paciente_p text, cd_tipo_agenda_p bigint, cd_unidade_p INOUT bigint, ds_unidade_p INOUT text, cd_codigo_pac_p INOUT text, dt_recepcao_p INOUT text) AS $body$
DECLARE


cd_estabelecimento_w	smallint;
cd_unidade_conexa_w	bigint;
nm_fantasia_estab_w	varchar(50);
cd_pessoa_fisica_externo_w	varchar(20);
dt_recepcao_w		varchar(50);
cd_estabelecimento_usuario_w estabelecimento.cd_estabelecimento%type;
				

BEGIN

select wheb_usuario_pck.get_cd_estabelecimento
into STRICT cd_estabelecimento_usuario_w
;

if (cd_tipo_agenda_p = 3) then
	select	max(a.cd_estabelecimento)
	into STRICT	cd_estabelecimento_w
	from	agenda a,
		agenda_consulta b
	where	a.cd_agenda = b.cd_agenda
	and	b.nr_sequencia = nr_seq_agenda_p;
else
	select	max(a.cd_estabelecimento)
	into STRICT	cd_estabelecimento_w
	from	agenda a,
		agenda_paciente b
	where	a.cd_agenda = b.cd_agenda
	and	b.nr_sequencia = nr_seq_agenda_p;
end if;

if (cd_estabelecimento_w IS NOT NULL AND cd_estabelecimento_w::text <> '') then

	select	max(cd_unidade_conexa),
		max(nm_fantasia_estab)
	into STRICT	cd_unidade_conexa_w,
		nm_fantasia_estab_w
	from	estabelecimento
	where	cd_estabelecimento = cd_estabelecimento_w;
	
end if;

select	max(cd_pessoa_fisica_externo)
into STRICT	cd_pessoa_fisica_externo_w
from	pessoa_fisica a,
	pf_codigo_externo b
where	b.cd_pessoa_fisica 		= a.cd_pessoa_fisica
and	b.ie_tipo_codigo_externo	= 'CO'
and (coalesce(b.cd_estabelecimento,cd_estabelecimento_usuario_w) = cd_estabelecimento_usuario_w)
and	a.cd_pessoa_fisica		= cd_paciente_p;

select 	to_char(clock_timestamp(),'yyyy-mm-dd hh24:mi:ss')
into STRICT	dt_recepcao_w
;

cd_unidade_p		:= cd_unidade_conexa_w;	
ds_unidade_p		:= nm_fantasia_estab_w;
cd_codigo_pac_p		:= cd_pessoa_fisica_externo_w;
dt_recepcao_p		:= dt_recepcao_w;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_integracao_conexa (nr_seq_agenda_p bigint, cd_paciente_p text, cd_tipo_agenda_p bigint, cd_unidade_p INOUT bigint, ds_unidade_p INOUT text, cd_codigo_pac_p INOUT text, dt_recepcao_p INOUT text) FROM PUBLIC;

