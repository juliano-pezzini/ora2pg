-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_cot_compra_item_entrega () AS $body$
DECLARE


nr_cot_compra_w		bigint;
nr_item_cot_compra_w		integer;
dt_limite_entrega_w		timestamp;
qt_material_w			double precision;

/*  Maicon - Substituido o select, porque estava dando problemas quando a qtdade de itens da tabela cot_compra_item <> cot_compra_forn_item
select	distinct
	a.dt_limite_entrega,
	a.qt_material,
	a.nr_cot_compra,
	a.nr_item_cot_compra
from	cot_compra_forn_item c,
	cot_compra b,
	cot_compra_item a
where	b.nr_cot_compra = a.nr_cot_compra
and	c.nr_cot_compra = a.nr_cot_compra
and	c.nr_item_cot_compra = a.nr_item_cot_compra
and	c.nr_ordem_compra is null
and	not exists(select	1
		from	cot_compra_item_entrega x
		where	x.nr_cot_compra = a.nr_cot_compra
		and	x.nr_item_cot_compra = a.nr_item_cot_compra); */
c01 CURSOR FOR
SELECT	distinct
	a.dt_limite_entrega,
	a.qt_material,
	a.nr_cot_compra,
	a.nr_item_cot_compra
from	cot_compra b,
	cot_compra_item a
where	b.nr_cot_compra = a.nr_cot_compra
and	not exists (select	1
		from	cot_compra_item_entrega x
		where	x.nr_cot_compra = a.nr_cot_compra
		and	x.nr_item_cot_compra = a.nr_item_cot_compra);

BEGIN

OPEN C01;
LOOP
FETCH C01 INTO
	dt_limite_entrega_w,
	qt_material_w,
	nr_cot_compra_w,
	nr_item_cot_compra_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	insert into cot_compra_item_entrega(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_cot_compra,
			nr_item_cot_compra,
			dt_entrega,
			qt_entrega,
			ds_observacao)
		values (nextval('cot_compra_item_entrega_seq'),
			clock_timestamp(),
			'Tasy',
			clock_timestamp(),
			'Tasy',
			nr_cot_compra_w,
			nr_item_cot_compra_w,
			dt_limite_entrega_w,
			qt_material_w,
			null);
	end;
commit;

END LOOP;
CLOSE C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_cot_compra_item_entrega () FROM PUBLIC;

