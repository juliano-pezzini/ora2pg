-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE schematic4test_checktestlog (NR_SEQ_SCHEDULE_P bigint, NR_SEQ_SUITE_P bigint) AS $body$
DECLARE

NR_SEQ_SCRIPT_W bigint;
NM_SCRIPT_W varchar(255);
QTD_W bigint;

C01 CURSOR FOR  --Loop scripts
  SELECT teste.NR_SEQ_SCRIPT NR_SEQ_SCRIPT, script.NM_SCRIPT NM_SCRIPT
      INTO STRICT NR_SEQ_SCRIPT_W, NM_SCRIPT_W
	FROM  SCHEM_TEST_TEST teste, SCHEM_TEST_SCRIPT script
	WHERE script.NR_SEQUENCIA = teste.NR_SEQ_SCRIPT
			AND teste.NR_SEQ_SUITE = NR_SEQ_SUITE_P 
			AND teste.IE_SWITCH = '1' 
			AND teste.NR_SEQ_SCRIPT NOT IN (SELECT NR_SEQ_SCRIPT FROM SCHEM_TEST_LOG WHERE NR_SEQ_SCHEDULE = NR_SEQ_SCHEDULE_P AND IE_STATUS('4','2'));

BEGIN
      --procedure that insert in script that was validate MAINTENANCE 
      OPEN C01;
      LOOP
        FETCH C01 INTO	
          NR_SEQ_SCRIPT_W,
          NM_SCRIPT_W;
      EXIT WHEN NOT FOUND; /* apply on C01 */
      BEGIN				
		SELECT COUNT(main1.IE_STATUS) QTD
            INTO STRICT QTD_W
        FROM SCHEM_TEST_MAINTENANCE main1
        WHERE main1.NR_SEQ_SCRIPT = NR_SEQ_SCRIPT_W
				AND main1.IE_STATUS = '1';
        				
				IF (QTD_W = 0) THEN
            INSERT INTO SCHEM_TEST_MAINTENANCE(NR_SEQUENCIA, DT_ATUALIZACAO, DT_ATUALIZACAO_NREC, NM_USUARIO, NM_USUARIO_NREC, NR_SEQ_SCRIPT, IE_STATUS, IE_PRIORITY, DS_OWNER, DS_SCHEDULE, DS_INFO)
                VALUES (nextval('schem_test_maintenance_seq'), clock_timestamp(), clock_timestamp(), 'Robot', 'Robot', NR_SEQ_SCRIPT_W, '1', '1', 'Robot', NR_SEQ_SCHEDULE_P, '000');
		        COMMIT;
        END IF;
      END;
      END LOOP;
      CLOSE C01;
      EXCEPTION
      WHEN no_data_found THEN
        RAISE NOTICE 'Erro: Data not found';
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE schematic4test_checktestlog (NR_SEQ_SCHEDULE_P bigint, NR_SEQ_SUITE_P bigint) FROM PUBLIC;

