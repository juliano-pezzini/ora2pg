-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE estornar_movto_juros_multa_bco (cd_estabelecimento_p text, nm_usuario_p text, dt_transacao_p timestamp, nr_seq_movto_trans_p bigint) AS $body$
DECLARE



nr_seq_movto_orig_w		bigint;
nr_titulo_pagar_w		bigint;
nr_titulo_receber_w		bigint;
vl_multa_w			double precision;
vl_juros_w			double precision;
nr_seq_tit_pagar_baixa_w	bigint;
nr_seq_tit_rec_baixa_w		bigint;

/*Buscar as movimentoações de juros e multa gerada pela transação origem*/

c01 CURSOR FOR
SELECT	nr_sequencia
from	movto_trans_financ
where	nr_seq_movto_orig_acres	= nr_seq_movto_orig_w;


BEGIN

/*Buscar a transação que gerou o estorno*/

select	max(nr_seq_movto_orig),
	max(nr_seq_titulo_pagar),
	max(nr_seq_titulo_receber)
into STRICT	nr_seq_movto_orig_w,
	nr_titulo_pagar_w,
	nr_titulo_receber_w
from	movto_trans_financ
where	nr_sequencia	= nr_seq_movto_trans_p;

if (nr_titulo_pagar_w IS NOT NULL AND nr_titulo_pagar_w::text <> '') then

	/*Buscar valores de juros e multa da baixa gerada no título a pagar*/

	select	coalesce(sum(vl_multa),0) * -1,
		coalesce(sum(vl_juros),0) * -1
	into STRICT	vl_multa_w,
		vl_juros_w
	from	titulo_pagar_baixa
	where	nr_titulo		= nr_titulo_pagar_w
	and	nr_seq_movto_trans_fin	= nr_seq_movto_orig_w;

	/*Buscar baixa de externo gerada no título a pagar.
	Esta baixa que terá o valor de juros e multa atualizado */
	select	max(nr_sequencia)
	into STRICT	nr_seq_tit_pagar_baixa_w
	from	titulo_pagar_baixa
	where	nr_titulo		= nr_titulo_pagar_w
	and	nr_seq_movto_trans_fin	= nr_seq_movto_trans_p;

elsif (nr_titulo_receber_w IS NOT NULL AND nr_titulo_receber_w::text <> '') then

	/*Buscar valores de juros e multa da baixa gerada no título a receber*/

	select	coalesce(sum(vl_multa),0) * -1,
		coalesce(sum(vl_juros),0) * -1
	into STRICT	vl_multa_w,
		vl_juros_w
	from	titulo_receber_liq
	where	nr_titulo		= nr_titulo_receber_w
	and	nr_seq_movto_trans_fin	= nr_seq_movto_orig_w;

	/*Buscar baixa de externo gerada no título a receber.
	Esta baixa que terá o valor de juros e multa atualizado */
	select	max(nr_sequencia)
	into STRICT	nr_seq_tit_rec_baixa_w
	from	titulo_receber_liq
	where	nr_titulo		= nr_titulo_receber_w
	and	nr_seq_movto_trans_fin	= nr_seq_movto_trans_p;

end if;

open C01;
loop
fetch C01 into
	nr_seq_movto_orig_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	/*Estornar o lançamento do juros ou multa*/

	insert into movto_trans_financ(nr_sequencia,
		dt_transacao,
		nr_seq_trans_financ,
		vl_transacao,
		dt_atualizacao,
		nm_usuario,
		vl_recebido,
		nr_seq_banco,
		cd_pessoa_fisica,
		cd_cgc,
		nr_seq_titulo_pagar,
		nr_seq_titulo_receber,
		nr_bordero,
		nr_adiantamento,
		nr_seq_banco_od,
		nr_seq_caixa_od,
		cd_conta_contabil,
		cd_centro_custo,
		nr_seq_nota_fiscal,
		nr_interno_conta,
		nr_documento,
		ds_historico,
		dt_referencia_saldo,
		dt_fechamento_lote,
		cd_tipo_recebimento,
		cd_tipo_baixa_cpa,
		nr_seq_cheque,
		nr_seq_conv_receb,
		nr_seq_deposito,
		nr_seq_saldo_banco,
		nr_seq_banco_escrit,
		dt_autenticacao,
		nr_lote_contabil,
		nr_seq_concil,
		nr_adiant_pago,
		ie_conciliacao,
		nr_seq_cheque_cp,
		ie_origem_lancamento,
		cd_historico,
		nr_bordero_rec,
		nr_seq_movto_cartao,
		nr_seq_motivo_dev,
		ie_estorno,
		nr_seq_movto_orig,
		cd_conta_financ,
		nr_Seq_perda)
	SELECT	nextval('movto_trans_financ_seq'),
		dt_transacao_p,
		nr_seq_trans_financ,
		vl_transacao * -1,
		clock_timestamp(),
		nm_usuario_p,
		vl_recebido,
		nr_seq_banco,
		cd_pessoa_fisica,
		cd_cgc,
		nr_seq_titulo_pagar,
		nr_seq_titulo_receber,
		nr_bordero,
		nr_adiantamento,
		nr_seq_banco_od,
		nr_seq_caixa_od,
		cd_conta_contabil,
		cd_centro_custo,
		nr_seq_nota_fiscal,
		nr_interno_conta,
		nr_documento,
		ds_historico,
		dt_referencia_saldo,
		dt_fechamento_lote,
		cd_tipo_recebimento,
		cd_tipo_baixa_cpa,
		nr_seq_cheque,
		nr_seq_conv_receb,
		nr_seq_deposito,
		nr_seq_saldo_banco,
		nr_seq_banco_escrit,
		dt_autenticacao,
		0,
		nr_seq_concil,
		nr_adiant_pago,
		'N',
		nr_seq_cheque_cp,
		ie_origem_lancamento,
		cd_historico,
		nr_bordero_rec,
		nr_seq_movto_cartao,
		nr_seq_motivo_dev,
		'E',
		nr_seq_movto_orig_w,
		cd_conta_financ,
		nr_Seq_perda
	from	movto_trans_financ
	where	nr_sequencia	= nr_seq_movto_orig_w;

	/*Atualizar a baixa com o valor de juros e multa*/

	if (nr_seq_tit_pagar_baixa_w IS NOT NULL AND nr_seq_tit_pagar_baixa_w::text <> '') and
		((vl_multa_w <> 0) or (vl_juros_w <> 0)) then

		update	titulo_pagar_baixa
		set	vl_multa	= vl_multa_w,
			vl_juros	= vl_juros_w,
			vl_pago		= vl_baixa + vl_multa_w + vl_juros_w
		where	nr_titulo	= nr_titulo_pagar_w
		and	nr_sequencia	= nr_seq_tit_pagar_baixa_w;

	elsif (nr_seq_tit_rec_baixa_w IS NOT NULL AND nr_seq_tit_rec_baixa_w::text <> '') and
		((vl_multa_w <> 0) or (vl_juros_w <> 0)) then

		update	titulo_receber_liq
		set	vl_multa	= vl_multa_w,
			vl_juros	= vl_juros_w
		where	nr_titulo	= nr_titulo_receber_w
		and	nr_sequencia	= nr_seq_tit_rec_baixa_w;

	end if;

	end;
end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE estornar_movto_juros_multa_bco (cd_estabelecimento_p text, nm_usuario_p text, dt_transacao_p timestamp, nr_seq_movto_trans_p bigint) FROM PUBLIC;

