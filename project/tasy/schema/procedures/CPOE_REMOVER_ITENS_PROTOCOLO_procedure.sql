-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_remover_itens_protocolo ( itens_remover_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_reg_item_w		cpoe_material.nr_sequencia%type;
ie_opcao_prescr_ww		varchar(4000);
ie_opcao_prescr_w		varchar(4000);
item_w					varchar(4000);
nr_seq_cpoe_order_unit_w  cpoe_material.nr_seq_cpoe_order_unit%type;
nr_seq_prev_order_unit_w  cpoe_order_unit.nr_seq_prev_order_unit%type;

BEGIN

ie_opcao_prescr_ww := itens_remover_p;
if (ie_opcao_prescr_ww IS NOT NULL AND ie_opcao_prescr_ww::text <> '') then

	for i in 1..length(ie_opcao_prescr_ww) loop

		if (length(ie_opcao_prescr_ww) > 1) then
			-- R,12;M,12345;D,1233;M,2312;
			item_w := substr(ie_opcao_prescr_ww, 1, position(';' in ie_opcao_prescr_ww) - 1);
      ie_opcao_prescr_w := substr(item_w, 1, position(',' in item_w) - 1);
      nr_seq_reg_item_w := (substr(item_w, position(',' in item_w) + 1, length(item_w)))::numeric;
			ie_opcao_prescr_ww := substr(ie_opcao_prescr_ww, position(';' in ie_opcao_prescr_ww) + 1, length(ie_opcao_prescr_ww));
			
			if (ie_opcao_prescr_w IS NOT NULL AND ie_opcao_prescr_w::text <> '') then
				case ie_opcao_prescr_w				
					when 'M' then --Medicamento
						delete from cpoe_plan_protocol
						where nr_seq_mat_cpoe = nr_seq_reg_item_w
						and exists (SELECT 1
						              from cpoe_material x
									 where x.nr_sequencia = nr_seq_reg_item_w
									   and coalesce(x.dt_liberacao::text, '') = '');

              begin
                select a.nr_seq_cpoe_order_unit
                into STRICT nr_seq_cpoe_order_unit_w
                from cpoe_material a
                where a.nr_sequencia =nr_seq_reg_item_w;
              exception
                when no_data_found then
                  nr_seq_cpoe_order_unit_w := null;
                when OTHERS then
                  nr_seq_cpoe_order_unit_w := null;
              end;

            delete from cpoe_material
            where nr_sequencia = nr_seq_reg_item_w
						and	coalesce(dt_liberacao::text, '') = '';
					
            if (nr_seq_cpoe_order_unit_w IS NOT NULL AND nr_seq_cpoe_order_unit_w::text <> '') then
                select max(nr_seq_prev_order_unit)
                into STRICT nr_seq_prev_order_unit_w
                from cpoe_order_unit a
                where a.nr_sequencia = nr_seq_cpoe_order_unit_w
                and (a.nr_seq_prev_order_unit IS NOT NULL AND a.nr_seq_prev_order_unit::text <> '')
                and not exists (SELECT 1
                from cpoe_material x
                where x.nr_seq_cpoe_order_unit = a.nr_sequencia);

                if (nr_seq_prev_order_unit_w IS NOT NULL AND nr_seq_prev_order_unit_w::text <> '') then
                  delete from cpoe_order_unit
                  where nr_sequencia = nr_seq_cpoe_order_unit_w;

                  
                  update cpoe_order_unit
                  set ie_situacao = 'A',
                        dt_atualizacao = clock_timestamp(),
                        nm_usuario = nm_usuario_p
                  where nr_sequencia = nr_seq_prev_order_unit_w;
                end if;
           end if;
                    	
					 when 'S' then --Solucaoo
						delete from cpoe_plan_protocol
						where nr_seq_mat_cpoe = nr_seq_reg_item_w
						and exists (SELECT 1
						              from cpoe_material x
									 where x.nr_sequencia = nr_seq_reg_item_w
									   and coalesce(x.dt_liberacao::text, '') = '');
									
  					    delete from cpoe_material
						where nr_sequencia = nr_seq_reg_item_w
						and	coalesce(dt_liberacao::text, '') = '';
					when 'N' then --Nutricao
						delete from cpoe_plan_protocol
						where nr_seq_diet_cpoe = nr_seq_reg_item_w
						and exists (SELECT 1
						              from cpoe_dieta x
									 where x.nr_sequencia = nr_seq_reg_item_w
									   and coalesce(x.dt_liberacao::text, '') = '');
					
						delete from cpoe_dieta
						where nr_sequencia = nr_seq_reg_item_w
						and	coalesce(dt_liberacao::text, '') = '';
					when 'P' then --Procedimentos				
						delete from cpoe_plan_protocol
						where nr_seq_exam_cpoe = nr_seq_reg_item_w
						and exists (SELECT 1
						              from cpoe_procedimento x
									 where x.nr_sequencia = nr_seq_reg_item_w
									   and coalesce(x.dt_liberacao::text, '') = '');

						delete from cpoe_procedimento
						where 	nr_seq_proc_princ = nr_seq_reg_item_w
						and	coalesce(dt_liberacao::text, '') = '';			

						delete from cpoe_procedimento
						where nr_sequencia = nr_seq_reg_item_w
						and	coalesce(dt_liberacao::text, '') = '';						
						
						delete FROM prescr_procedimento
						where nr_seq_proc_cpoe =  nr_seq_reg_item_w;

						delete FROM cpoe_material
						where nr_seq_procedimento = nr_seq_reg_item_w
						and	coalesce(dt_liberacao::text, '') = '';
						
					when 'G' then --Gasoterapia
						delete from cpoe_plan_protocol
						where nr_seq_gaso_cpoe = nr_seq_reg_item_w
						and exists (SELECT 1
						              from cpoe_gasoterapia x
									 where x.nr_sequencia = nr_seq_reg_item_w
									   and coalesce(x.dt_liberacao::text, '') = '');
					
						delete from cpoe_gasoterapia
						where nr_sequencia = nr_seq_reg_item_w
						and	coalesce(dt_liberacao::text, '') = '';
					when 'R' then --Recomendacao
						delete from cpoe_plan_protocol
						where nr_seq_rec_cpoe = nr_seq_reg_item_w
						and exists (SELECT 1
						              from cpoe_recomendacao x
									 where x.nr_sequencia = nr_seq_reg_item_w
									   and coalesce(x.dt_liberacao::text, '') = '');
									
						delete FROM w_kit_modificado a
						where exists (	SELECT	1 
										from	cpoe_recomendacao x
										where	x.nr_atendimento = a.nr_atendimento
										and	x.cd_recomendacao = a.cd_recomendacao
										and	x.cd_pessoa_fisica = a.cd_pessoa_fisica);
									
						delete from cpoe_recomendacao
						where nr_sequencia = nr_seq_reg_item_w
						and	coalesce(dt_liberacao::text, '') = '';
					when 'DI' then --Dialise
						delete from cpoe_plan_protocol
						where nr_seq_dial_cpoe = nr_seq_reg_item_w
						and exists (SELECT 1
						              from cpoe_dialise x
									 where x.nr_sequencia = nr_seq_reg_item_w
									   and coalesce(x.dt_liberacao::text, '') = '');
									
						delete from cpoe_dialise
						where nr_sequencia = nr_seq_reg_item_w
						and	coalesce(dt_liberacao::text, '') = '';
					when 'MA' then --Material
						delete from cpoe_plan_protocol
						where nr_seq_mat_cpoe = nr_seq_reg_item_w
						and exists (SELECT 1
						              from cpoe_material x
									 where x.nr_sequencia = nr_seq_reg_item_w
									   and coalesce(x.dt_liberacao::text, '') = '');

						delete from cpoe_material
						where nr_sequencia = nr_seq_reg_item_w
						and	coalesce(dt_liberacao::text, '') = '';
					when 'H' then --Hemoterapia
						delete from cpoe_plan_protocol
						where nr_seq_hemo_cpoe = nr_seq_reg_item_w
						and exists (SELECT 1
						              from cpoe_hemoterapia x
									 where x.nr_sequencia = nr_seq_reg_item_w
									   and coalesce(x.dt_liberacao::text, '') = '');

						delete from cpoe_hemoterapia
						where nr_sequencia = nr_seq_reg_item_w
						and	coalesce(dt_liberacao::text, '') = '';
					when 'AP' then --anatomia patologica
						delete from cpoe_plan_protocol
						where nr_seq_anat_cpoe = nr_seq_reg_item_w
						and exists (SELECT 1
						              from cpoe_anatomia_patologica x
									 where x.nr_sequencia = nr_seq_reg_item_w
									   and coalesce(x.dt_liberacao::text, '') = '');

						delete from cpoe_anatomia_patologica
						where nr_sequencia = nr_seq_reg_item_w
						and	coalesce(dt_liberacao::text, '') = '';
						
						delete from CPOE_PRESCR_PROC_PECA
						where nr_seq_cpoe_proc = nr_seq_reg_item_w;
						
						delete from CPOE_PRESCR_HISTOPATOL
						where nr_seq_proc_anatomia = nr_seq_reg_item_w;
						
						delete from CPOE_PRESCR_CITOPATOLOGICO
						where nr_seq_proc_anatomia = nr_seq_reg_item_w;
						
						delete from W_CPOE_PRESCR_PROC_PECA
						where nr_seq_cpoe_proc = nr_seq_reg_item_w;
						
						delete from W_CPOE_PRESCR_HISTOPATOL
						where nr_seq_proc_anatomia = nr_seq_reg_item_w;
						
						delete from W_CPOE_PRESCR_CITOP
						where nr_seq_proc_anatomia = nr_seq_reg_item_w;
				end case;
			end if;
		end if;
	end loop;

	commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_remover_itens_protocolo ( itens_remover_p text, nm_usuario_p text) FROM PUBLIC;

