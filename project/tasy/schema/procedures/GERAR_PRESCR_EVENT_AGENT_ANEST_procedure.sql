-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_prescr_event_agent_anest (nr_seq_agente_ocor_p bigint, ie_operacao_p bigint, ie_gerar_horario_p text default 'N') AS $body$
DECLARE

											
nr_prescricao_w				prescr_medica.nr_prescricao%type;
nr_seq_prescr_material_w	prescr_material.nr_sequencia%type;
cd_material_w				material.cd_material%type;
nr_cirurgia_w				cirurgia_agente_anestesico.nr_cirurgia%type;
nr_seq_pepo_w				cirurgia_agente_anestesico.nr_seq_pepo%type;
cd_unidade_medida_w			prescr_material.cd_unidade_medida%type;
nr_seq_mat_cpoe_w			prescr_material.nr_seq_mat_cpoe%type;
nr_atendimento_w			prescr_medica.nr_atendimento%type;
nr_seq_solucao_w            prescr_solucao.nr_seq_solucao%type;
nr_etapa_sol_w				prescr_mat_hor.nr_etapa_sol%type;
nr_seq_horario_w			prescr_mat_hor.nr_sequencia%type;
dt_horario_w				prescr_mat_hor.dt_horario%type;
cd_intervalo_w				intervalo_prescricao.cd_intervalo%type;
qt_total_solucao_w			prescr_material.qt_solucao%type;
ds_inconsistentes_w			varchar(2000);
ds_retorno_w				varchar(255);
ie_inconsistencia_w			varchar(10);
ie_meidcamento_w			varchar(1);
ie_gerar_evento_w			varchar(1);
cd_evolucao_w				bigint;
ie_alteracao_w				smallint;
ie_terapias_atual_w			varchar(1);
ie_terapia_atual_w          cirurgia_agente_anestesico.ie_terapia_atual%type;
cd_unid_med_angent_anest_w	prescr_material.cd_unidade_medida%type;
qt_dose_conversao_w         prescr_mat_hor.qt_dose%type;
dt_horario_upd_w            prescr_mat_hor.dt_horario%type;
nm_usuario_w                prescr_mat_alteracao.nm_usuario%type;
cd_funcao_w                 prescr_mat_alteracao.cd_funcao%type;
cd_pessoa_fisica_w          prescr_mat_alteracao.cd_pessoa_fisica%type;
qt_dose_upd_w               prescr_mat_alteracao.qt_dose_adm%type;
c02_w                       prescr_mat_hor%ROWTYPE;
ie_tipo_dosagem_w           cirurgia_agente_anestesico.ie_tipo_dosagem%type;

qt_dose_prescr_mat_w        prescr_material.qt_dose%type;
ie_tipo_item_w		prescr_mat_alteracao.ie_tipo_item%type;

c01 CURSOR FOR
	SELECT	*
	from 	cirurgia_agente_anest_ocor
	where	nr_sequencia = nr_seq_agente_ocor_p
	order by nr_sequencia;

c02 CURSOR FOR
    SELECT  a.qt_dose, a.nr_sequencia, a.nr_prescricao, a.nr_seq_material, a.cd_material, a.cd_unidade_medida_dose
            , b.nr_seq_mat_cpoe
    FROM prescr_mat_hor a, prescr_material b
    WHERE  a.nr_prescricao = nr_prescricao_w
    AND    b.nr_prescricao = a.nr_prescricao
    AND    b.nr_sequencia = a.nr_seq_material
    AND    a.dt_horario = dt_horario_upd_w
    AND    a.nr_seq_material IN (
                            SELECT b.nr_sequencia
                            FROM   prescr_material b
                            WHERE  b.nr_prescricao = a.nr_prescricao
                              AND (b.nr_sequencia = nr_seq_prescr_material_w OR coalesce(b.nr_sequencia_diluicao, b.nr_seq_kit) = nr_seq_prescr_material_w)
                          );
BEGIN

for c01_w in c01
loop

	select max(cd_material),
	max(nr_cirurgia),
	max(nr_seq_pepo)
	into STRICT cd_material_w,
	nr_cirurgia_w,
	nr_seq_pepo_w
	from cirurgia_agente_anestesico
	where nr_sequencia =  c01_w.nr_seq_cirur_agente;

	select  max(b.nr_prescricao),
		max(b.nr_sequencia), 
		max(b.cd_unidade_medida_dose),
        max(a.cd_unid_medida_adm),
		max(b.nr_sequencia_solucao),
		CASE WHEN max(a.ie_modo_adm)='CO' THEN  'N'  ELSE 'S' END ,
		max(b.nr_seq_mat_cpoe),
		max(b.cd_intervalo),
		max(a.ie_terapia_atual),
        max(a.ie_tipo_dosagem)
        , max(b.qt_dose) qt_dose_prescr_mat
	into STRICT nr_prescricao_w,
		nr_seq_prescr_material_w,
		cd_unidade_medida_w,
		cd_unid_med_angent_anest_w,
		nr_seq_solucao_w,
		ie_meidcamento_w,
		nr_seq_mat_cpoe_w,
		cd_intervalo_w,
		ie_terapia_atual_w,
        ie_tipo_dosagem_w
        , qt_dose_prescr_mat_w
	from cirurgia_agente_anestesico a,
		prescr_material b,
		prescr_material_compl c
	where 	b.nr_prescricao = c.nr_prescricao
	and  	b.nr_sequencia = c.nr_sequencia
	and   	a.nr_sequencia = c.nr_seq_agente_anestesico
    and		b.cd_material = cd_material_w
    and 	c.nr_seq_agente_anestesico = c01_w.nr_seq_cirur_agente;

	select max(nr_atendimento)
	into STRICT nr_atendimento_w
	from prescr_medica
	where nr_prescricao = nr_prescricao_w;

	if (ie_meidcamento_w = 'S') then
		--horario menor que sysdate que ainda nao foi administrado
        begin
            select nr_sequencia, dt_horario
            into STRICT nr_seq_horario_w, dt_horario_upd_w
            from prescr_mat_hor
            where nr_prescricao = nr_prescricao_w
            and nr_seq_material = nr_seq_prescr_material_w
            and coalesce(dt_fim_horario::text, '') = ''
            and dt_horario < c01_w.dt_inicio_adm + 1/24
            order by dt_horario asc LIMIT 1;
        exception
        when no_data_found then
            nr_seq_horario_w := null;
            dt_horario_upd_w := null;
        end;

        nm_usuario_w := wheb_usuario_pck.get_nm_usuario;
        cd_funcao_w := wheb_usuario_pck.get_cd_funcao;
        cd_pessoa_fisica_w := obter_pessoa_fisica_usuario(nm_usuario_w, 'C');
        qt_dose_conversao_w := obter_dose_convertida(cd_material_w, c01_w.qt_dose, cd_unid_med_angent_anest_w, cd_unidade_medida_w);
		
        if (coalesce(nr_seq_horario_w::text, '') = '') then

			SELECT * FROM aprazar_item_prescr('N', wheb_usuario_pck.get_cd_estabelecimento, nr_atendimento_w, 'M', 24, cd_material_w, cd_intervalo_w, null,  -- qt_dose
				c01_w.dt_inicio_adm, nr_prescricao_w, nr_prescricao_w, nr_seq_prescr_material_w, 'N', null, null, wheb_usuario_pck.get_nm_usuario, ie_inconsistencia_w, ds_inconsistentes_w, null, 0, 'N', null, null, 'N', null, null, null, null, null, null, null, nr_seq_mat_cpoe_w) INTO STRICT ie_inconsistencia_w, ds_inconsistentes_w;
			
            -- arrumar select max para rownum = 1  
            begin
                select  nr_sequencia, dt_horario
                into STRICT nr_seq_horario_w, dt_horario_upd_w
                from prescr_mat_hor
                where nr_prescricao = nr_prescricao_w
                and nr_seq_material = nr_seq_prescr_material_w
                and	trunc(dt_horario, 'mi') = trunc(c01_w.dt_inicio_adm, 'mi')
                order by dt_horario asc LIMIT 1;
            exception
            when no_data_found then
                nr_seq_horario_w := null;
                dt_horario_upd_w := null;
            end;


        else
            for c02_w in c02
            loop
                        -- REAPRAZAMENTO: alterando horarios do medicamento/diluente/reconstituinte
                        update	prescr_mat_hor
                        set	dt_horario      = c01_w.dt_inicio_adm,
                            nm_usuario		= wheb_usuario_pck.get_nm_usuario,
                            dt_atualizacao	= clock_timestamp()
                        where	nr_sequencia = c02_w.nr_sequencia
                        and		coalesce(dt_fim_horario::text, '') = ''
                        and		coalesce(dt_suspensao::text, '') = '';
                        ie_tipo_item_w := cpoe_obter_tipo_item('CPOE_MATERIAL',c02_w.nr_seq_mat_cpoe, null, null, null);
                        insert into prescr_mat_alteracao(   nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,
                                nm_usuario_nrec,nr_prescricao,nr_seq_prescricao,dt_alteracao,
                                cd_pessoa_fisica,ie_alteracao,nr_seq_horario,ie_tipo_item,
                                nr_atendimento,cd_item,qt_dose_adm,cd_um_dose_adm,nr_seq_motivo,
                                qt_dose_original,ie_acm_sn,cd_funcao,dt_horario_acao,dt_horario)
                        values (   nextval('prescr_mat_alteracao_seq'),clock_timestamp(),nm_usuario_w,clock_timestamp(),
                                nm_usuario_w,c02_w.nr_prescricao,c02_w.nr_seq_material,clock_timestamp(),
                                cd_pessoa_fisica_w,10,c02_w.nr_sequencia,ie_tipo_item_w,
                                nr_atendimento_w,c02_w.cd_material,qt_dose_upd_w,c02_w.cd_unidade_medida_dose,
                                18,c02_w.qt_dose,'N',cd_funcao_w,c01_w.dt_inicio_adm,c01_w.dt_inicio_adm);
            end loop;
		end if;
        dt_horario_upd_w := trunc(c01_w.dt_inicio_adm, 'mi');
        for c02_w in c02
        loop
                -- ADMINISTRACAO: alterando horarios do medicamento/diluente/reconstituinte
                update	prescr_mat_hor
                set	    qt_dose             = CASE WHEN ie_terapia_atual_w='S' THEN  qt_dose_conversao_w  ELSE c01_w.qt_dose END ,
                        cd_unidade_medida   = cd_unid_med_angent_anest_w,
                        dt_horario          = c01_w.dt_inicio_adm,
                        nm_usuario	        = wheb_usuario_pck.get_nm_usuario,
                        nm_usuario_adm	    = wheb_usuario_pck.get_nm_usuario,
                        dt_fim_horario      = clock_timestamp(),
                        dt_atualizacao	    = clock_timestamp()
                where	nr_sequencia = c02_w.nr_sequencia
                and		coalesce(dt_fim_horario::text, '') = ''
                and		coalesce(dt_suspensao::text, '') = '';
                qt_dose_upd_w := c01_w.qt_dose;
                if (ie_terapia_atual_w = 'S') then
                    qt_dose_upd_w := qt_dose_conversao_w;
                end if;
		ie_tipo_item_w := cpoe_obter_tipo_item('CPOE_MATERIAL',c02_w.nr_seq_mat_cpoe, null, null, null);
                insert into prescr_mat_alteracao(   nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,
                        nm_usuario_nrec,nr_prescricao,nr_seq_prescricao,dt_alteracao,
                        cd_pessoa_fisica,ie_alteracao,nr_seq_horario,ie_tipo_item,
                        nr_atendimento,cd_item,qt_dose_adm,cd_um_dose_adm,nr_seq_motivo,
                        qt_dose_original,ie_acm_sn,cd_funcao,dt_horario_acao,dt_horario)
                values (   nextval('prescr_mat_alteracao_seq'),clock_timestamp(),nm_usuario_w,clock_timestamp(),
                        nm_usuario_w,c02_w.nr_prescricao,c02_w.nr_seq_material,clock_timestamp(),
                        cd_pessoa_fisica_w,3,c02_w.nr_sequencia,ie_tipo_item_w,
                        nr_atendimento_w,c02_w.cd_material,qt_dose_upd_w,c02_w.cd_unidade_medida_dose,
                        13,c02_w.qt_dose,'N',cd_funcao_w,c01_w.dt_inicio_adm,c01_w.dt_inicio_adm);
        end loop;
	else
		if (ie_gerar_horario_p = 'S' and ie_operacao_p = 0) then
			
			select  min(nr_sequencia)
			into STRICT nr_seq_horario_w
			from prescr_mat_hor
			where nr_prescricao = nr_prescricao_w
			and nr_seq_solucao = nr_seq_solucao_w
			and coalesce(dt_fim_horario::text, '') = ''
			and coalesce(dt_inicio_horario::text, '') = ''
			and dt_horario < c01_w.dt_inicio_adm + 1/24;

			if (coalesce(nr_seq_horario_w::text, '') = '') then
			
				select 	max(nr_sequencia)
				into STRICT	nr_seq_horario_w
				from	prescr_mat_hor
				where	nr_prescricao = nr_prescricao_w
				and		nr_seq_solucao = nr_seq_solucao_w
				and 	dt_horario > c01_w.dt_inicio_adm + 1/24;
			

				if (coalesce(nr_seq_horario_w, 0) > 0) then
					update prescr_mat_hor
					set nr_etapa_sol = nr_etapa_sol + 1
					where	nr_prescricao = nr_prescricao_w
					and		nr_seq_solucao = nr_seq_solucao_w
					and 	dt_horario > c01_w.dt_inicio_adm + 1/24;
					
					select	coalesce(min(nr_etapa_sol),0) - 1
					into STRICT	nr_etapa_sol_w
					from	prescr_mat_hor a
					where	a.nr_prescricao = nr_prescricao_w
					and		a.nr_seq_solucao = nr_seq_solucao_w
					and 	dt_horario > c01_w.dt_inicio_adm + 1/24;
				else
					select	coalesce(min(nr_etapa_sol),0) + 1
					into STRICT	nr_etapa_sol_w
					from	prescr_mat_hor a
					where	a.nr_prescricao = nr_prescricao_w
					and		a.nr_seq_solucao = nr_seq_solucao_w;
				end if;

				CALL aprazar_etapa_sol(nr_atendimento_w,1,nr_prescricao_w,nr_seq_solucao_w,c01_w.dt_inicio_adm,null,null,
						wheb_usuario_pck.get_nm_usuario,nr_etapa_sol_w, 'N');
						

			else
				
				ds_retorno_w := gerar_alteracao_sol_prescr(wheb_usuario_pck.get_cd_estabelecimento, nr_atendimento_w, 1, nr_prescricao_w, nr_seq_solucao_w, 5, c01_w.dt_inicio_adm, 'V', null, ie_tipo_dosagem_w, null, c01_w.qt_velocidade_inf, null, null, null, null, null, wheb_usuario_pck.get_nm_usuario, nr_etapa_sol_w, null, 'N', 'N', ds_retorno_w, 0, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null);
				
			end if;
							
		end if;

		select CASE WHEN ie_operacao_p=1 THEN  5 WHEN ie_operacao_p=2 THEN  4 WHEN ie_operacao_p=0 THEN  1 END ,
		CASE WHEN c01_w.qt_dose=0 THEN  null  ELSE ie_tipo_dosagem_w END ,
		CASE WHEN c01_w.qt_dose=0 THEN  null  ELSE c01_w.qt_dose END
		into STRICT ie_alteracao_w,
			ie_tipo_dosagem_w,
			c01_w.qt_dose
		;
		
		ds_retorno_w := gerar_alteracao_sol_prescr(wheb_usuario_pck.get_cd_estabelecimento, nr_atendimento_w, 1, nr_prescricao_w, nr_seq_solucao_w, ie_alteracao_w, c01_w.dt_inicio_adm, 'V', null, ie_tipo_dosagem_w, null, c01_w.qt_velocidade_inf, null, null, null, null, null, wheb_usuario_pck.get_nm_usuario, nr_etapa_sol_w, null, 'N', 'N', ds_retorno_w, 0, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null);
		
		
		if (ie_operacao_p = 2) then
			CALL gerar_resumo_agente(nr_cirurgia_w, wheb_usuario_pck.get_nm_usuario,
			 wheb_usuario_pck.get_cd_estabelecimento, nr_seq_pepo_w);
		
			select	sum(Obter_conversao_ml(cd_material, qt_dose, cd_unidade_medida))
			into STRICT	qt_total_solucao_w
			from	w_agente_adm
			where	((nr_cirurgia    = nr_cirurgia_w and coalesce(nr_seq_pepo_w, 0) = 0)
				or (coalesce(nr_cirurgia, 0) = 0 and nr_seq_pepo = nr_seq_pepo_w and coalesce(nr_seq_pepo_w,0) > 0))
			and nr_seq_cir_agente_anest = c01_w.nr_seq_cirur_agente;
			
			update 	prescr_solucao
			set		qt_solucao_total = coalesce(qt_total_solucao_w, 0),
				qt_volume = coalesce(qt_total_solucao_w, 0)
			where 	nr_seq_solucao = nr_seq_solucao_w
			and		nr_prescricao = nr_prescricao_w;

			update    prescr_material
			set    qt_dose = Obter_dose_convertida(cd_material, qt_total_solucao_w, 'ml', cd_unidade_medida_dose)
			where nr_prescricao = nr_prescricao_w
			and    nr_sequencia_solucao = nr_seq_solucao_w;
	
			select coalesce(max('S'), 'N')
			into STRICT ie_terapias_atual_w
			from	cpoe_material
			where nr_sequencia = nr_seq_mat_cpoe_w
			and	cd_funcao_origem = 2314;
			
			if (ie_terapias_atual_w = 'N') then
				CALL gerar_prescr_solu_esquema(c01_w.nr_seq_cirur_agente, nr_prescricao_w, nr_seq_solucao_w);
			end if;
		
		end if;
			
	end if;
end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_prescr_event_agent_anest (nr_seq_agente_ocor_p bigint, ie_operacao_p bigint, ie_gerar_horario_p text default 'N') FROM PUBLIC;

