-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE unificar_titulos_pagar (ds_lista_titulo_p text, nm_usuario_p text, cd_pessoa_fisica_p text, cd_cgc_p text, nr_titulo_dest_p INOUT bigint, dt_emissao_p timestamp, dt_vencto_atual_p timestamp, dt_vencto_orig_p timestamp, dt_contabil_p timestamp, nr_seq_classe_p bigint default null, ie_acao_p text DEFAULT NULL) AS $body$
DECLARE


/*	ie_acao_p
U	Unificar
D	Desfazer unificacao
*/
vl_saldo_titulo_w		double precision	:= 0;
cd_estabelecimento_w	smallint;
cd_estab_financeiro_w	smallint;
nr_titulo_w				bigint;
nr_titulo_dest_w		bigint;
vl_total_w				double precision	:= 0;
vl_total_juros_w		double precision	:= 0;
vl_total_multa_w		double precision	:= 0;
vl_total_desconto_w		double precision	:= 0;
cd_moeda_padrao_w		integer;
nr_seq_trans_fin_baixa_w	bigint;
nr_seq_trans_fin_contab_w	bigint;
ds_lista_titulos_w		varchar(4000);
ds_observacao_titulo_w	varchar(4000);
nr_seq_baixa_w			bigint;
dt_baixa_w				timestamp;
cd_tipo_baixa_w			integer;
nr_titulo_unificado_w	bigint;
nr_seq_trans_fin_transf_w	bigint;
qt_classe_titulo_w		bigint;
nr_seq_classe_w			bigint;
ie_consiste_classe_w	varchar(1);
ie_origem_tit_pagar_w	varchar(10);
vl_saldo_titulo_ww		double precision;
ie_considerar_saldo_w	varchar(1);
ie_utilizar_estab_ativo_w	varchar(1);
ds_observacao_w			varchar(255);
nr_titulo_unific_w		titulo_pagar.nr_titulo%type;
cd_tributo_w			titulo_pagar.cd_tributo%type;
qt_tributo_titulo_w		bigint;
ie_cancelar_tit_unificacao_w	varchar(1);
ie_tipo_titulo_w		titulo_pagar.ie_tipo_titulo%type;
ie_tipo_data_baixa_w	varchar(5);
dt_baixa_tit_unif_w		timestamp;

c01 CURSOR FOR
SELECT	nr_titulo,
		cd_estabelecimento,
		cd_estab_financeiro,
		vl_saldo_titulo
from	titulo_pagar
where	' ' || ds_lista_titulos_w || ' ' like '% ' || nr_titulo || ' %'
and		(ds_lista_titulo_p IS NOT NULL AND ds_lista_titulo_p::text <> '');

c02 CURSOR FOR
SELECT	a.nr_titulo
from	titulo_pagar a
where	' ' || ds_lista_titulos_w || ' ' like '% ' || a.nr_titulo_dest || ' %'
and		(a.nr_titulo_dest IS NOT NULL AND a.nr_titulo_dest::text <> '')
and		(ds_lista_titulo_p IS NOT NULL AND ds_lista_titulo_p::text <> '');

/*AAMFIRMO 09/05/16 OS 1042396 -  Aqui e necessario pegar os titulos que estao sendo unificados e atribuir a ele o titulo gerado antes do tempo, pois isso ocorre na abertura do cursor 01. Isso pois na geracao do tributo que ocorre na 
ATUALIZAR_INCLUSAO_TIT_PAGAR, e efetuado um select dos titulos unifificados para utilizar o valor dos mesmos como base do tributo a ser gerado aqui. Como nao existe  o vinculo do NR_TITULO_DEST ainda, foi necessario esse update.*/
c03 CURSOR FOR
SELECT	nr_titulo
from	titulo_pagar
where	' ' || ds_lista_titulos_w || ' ' like '% ' || nr_titulo || ' %'
and		(ds_lista_titulo_p IS NOT NULL AND ds_lista_titulo_p::text <> '');


BEGIN

/*OS 1675173. Nao aumentei o tamanho da variavel pois estoura erro ORA-01460: conversao nao-implementada ou nao resolvivel solicitada no select abaixo onde essa essa variavel no where.*/

if ( length(' ' || replace(ds_lista_titulo_p, ',', ' ') || ' ') > 4000 ) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1027381);
end if;

ds_lista_titulos_w	:= ' ' || replace(ds_lista_titulo_p, ',', ' ') || ' ';

ie_consiste_classe_w := obter_valor_param_usuario(851, 179, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w);
ie_cancelar_tit_unificacao_w := obter_valor_param_usuario(851, 200, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w);

ie_utilizar_estab_ativo_w := obter_param_usuario(851, 225, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_utilizar_estab_ativo_w);

if (ie_consiste_classe_w = 'S') then
	select	max(nr_seq_classe),
			count(distinct coalesce(nr_seq_classe,0))
	into STRICT	nr_seq_classe_w,
			qt_classe_titulo_w
	from	titulo_pagar
	where	' ' || ds_lista_titulos_w || ' ' like '% ' || nr_titulo || ' %';

	if (qt_classe_titulo_w > 1) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(209914);
	end if;
end if;

ie_tipo_data_baixa_w := obter_param_usuario(851, 263, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_tipo_data_baixa_w);
if (ie_tipo_data_baixa_w = 'DA') then
	dt_baixa_tit_unif_w := clock_timestamp();
elsif (ie_tipo_data_baixa_w = 'DE')  then
	dt_baixa_tit_unif_w := dt_emissao_p;
elsif (ie_tipo_data_baixa_w = 'DC')  then
	dt_baixa_tit_unif_w := dt_contabil_p;
elsif (ie_tipo_data_baixa_w = 'DVO')  then
	dt_baixa_tit_unif_w := dt_vencto_orig_p;
elsif (ie_tipo_data_baixa_w = 'DVA')  then
	dt_baixa_tit_unif_w := dt_vencto_atual_p;
end if;

if (coalesce(ie_acao_p, 'U') = 'U') then

	ds_observacao_titulo_w	:= substr(wheb_mensagem_pck.get_texto(302919),1,255) || ' ';

	/* obter o valor total dos titulos que serao unificados */

	select	sum(vl_titulo),
			max(cd_estabelecimento),
			max(cd_estab_financeiro),
			sum(vl_saldo_juros),
			sum(vl_saldo_multa),
			sum(vl_dia_antecipacao),
			sum(vl_saldo_titulo),
			max(cd_tributo),
			max(ie_tipo_titulo)
	into STRICT	vl_total_w,
			cd_estabelecimento_w,
			cd_estab_financeiro_w,
			vl_total_juros_w,
			vl_total_multa_w,
			vl_total_desconto_w,
			vl_saldo_titulo_ww,
			cd_tributo_w,
			ie_tipo_titulo_w
	from	titulo_pagar
	where	' ' || ds_lista_titulos_w || ' ' like '% ' || nr_titulo || ' %'
	and		(ds_lista_titulo_p IS NOT NULL AND ds_lista_titulo_p::text <> '');

	if (coalesce(ie_utilizar_estab_ativo_w,'N') = 'S' ) then
		cd_estabelecimento_w := obter_estabelecimento_ativo;
	end if;
	
	nr_seq_trans_fin_baixa_w := obter_valor_param_usuario(851, 108, obter_perfil_ativo, nm_usuario_p,cd_estabelecimento_w);
	nr_seq_trans_fin_contab_w := null;
	
	if (coalesce(nr_seq_trans_fin_baixa_w::text, '') = '') then
		begin
		nr_seq_trans_fin_baixa_w := obter_trans_fin_regra('DTP', cd_estabelecimento_w, cd_pessoa_fisica_p, cd_cgc_p, null, null, ie_tipo_titulo_w, null, null, nr_seq_classe_p, nr_seq_trans_fin_baixa_w);
		end;
	end if;
	
	if (coalesce(nr_seq_trans_fin_baixa_w::text, '') = '') then
		begin
		select	max(nr_seq_trans_fin_baixa)
		into STRICT nr_seq_trans_fin_baixa_w
		from	classe_titulo_pagar
		where	nr_sequencia = nr_seq_classe_p;
		end;
	end if;
	
	if (coalesce(nr_seq_trans_fin_contab_w::text, '') = '') then
		begin
		select	max(nr_seq_trans_fin_contab)
		into STRICT nr_seq_trans_fin_contab_w
		from	classe_titulo_pagar
		where	nr_sequencia = nr_seq_classe_p;
		end;
	end if;
	
	select	max(cd_moeda_padrao),
			max(nr_seq_trans_fin_transf)
	into STRICT	cd_moeda_padrao_w,
			nr_seq_trans_fin_transf_w
	from	parametros_contas_pagar
	where	cd_estabelecimento	= cd_estabelecimento_w;
	
	ie_considerar_saldo_w := obter_valor_param_usuario(851, 211, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w);
		
	if (coalesce(ie_considerar_saldo_w,'N') = 'S') then
		vl_total_w := vl_saldo_titulo_ww;
	end if;

	if (vl_total_w > 0) then	/* gerar o titulo da unificacao */
		ie_origem_tit_pagar_w := obter_valor_param_usuario(851, 183, obter_perfil_ativo, nm_usuario_p,cd_estabelecimento_w);
		
		select count(*)
		into STRICT qt_tributo_titulo_w
		from (
			SELECT 	distinct cd_tributo
			from 	titulo_pagar
			where	' ' || ds_lista_titulos_w || ' ' like '% ' || nr_titulo || ' %'
			and		(ds_lista_titulo_p IS NOT NULL AND ds_lista_titulo_p::text <> '')
			) alias2;

		-- Se haver tributos diferentes nos titulos unificados nao leva pro novo titulo
		if (qt_tributo_titulo_w > 1) and (cd_tributo_w IS NOT NULL AND cd_tributo_w::text <> '') then
			cd_tributo_w := null;
		end if;
		
		select	nextval('titulo_pagar_seq')
		into STRICT	nr_titulo_dest_w
		;
		
		insert	into titulo_pagar(
			nr_titulo,
			nm_usuario,
			dt_atualizacao,
			ie_situacao,
			ie_origem_titulo,
			ie_tipo_titulo,
			cd_estabelecimento,
			cd_tipo_taxa_multa,
			cd_tipo_taxa_juro,
			cd_tipo_taxa_antecipacao,
			tx_multa,
			tx_juros,
			cd_moeda,
			vl_titulo,
			vl_saldo_titulo,
			dt_emissao,
			dt_contabil,
			dt_vencimento_original,
			dt_vencimento_atual,
			cd_pessoa_fisica,
			cd_cgc,
			nr_bloqueto,
			vl_saldo_juros,
			vl_saldo_multa,
			vl_dia_antecipacao,
			cd_estab_financeiro,
			nr_seq_trans_fin_baixa,
			nr_seq_trans_fin_contab,
			ie_status,
			nr_seq_classe,
			cd_tributo)
		values (nr_titulo_dest_w,
			nm_usuario_p,
			clock_timestamp(),
			'A',
			ie_origem_tit_pagar_w,
			1,
			cd_estabelecimento_w,
			1,
			1,
			1,
			0,
			0,
			cd_moeda_padrao_w,
			vl_total_w,
			vl_total_w,
			coalesce(dt_emissao_p,clock_timestamp()),
			trunc(coalesce(dt_contabil_p,clock_timestamp())),
			coalesce(dt_vencto_orig_p,clock_timestamp()),
			coalesce(dt_vencto_atual_p,clock_timestamp()),
			cd_pessoa_fisica_p,
			cd_cgc_p,
			null,
			vl_total_juros_w,
			vl_total_multa_w,
			vl_total_desconto_w,
			cd_estab_financeiro_w,
			nr_seq_trans_fin_baixa_w,
			nr_seq_trans_fin_contab_w,
			'D',
			coalesce(nr_seq_classe_p,nr_seq_classe_w),
			cd_tributo_w);
		
		/*AAMFIRMO 09/05/16 OS 1042396 -  Aqui e necessario pegar os titulos que estao sendo unificados e atribuir a ele o titulo gerado antes do tempo, pois isso ocorre na abertura do cursor 01. Isso pois na geracao do tributo que ocorre na 
		ATUALIZAR_INCLUSAO_TIT_PAGAR, e efetuado um select dos titulos unifificados para utilizar o valor dos mesmos como base do tributo a ser gerado aqui. Como nao existe  o vinculo do NR_TITULO_DEST ainda, foi necessario esse update.*/
		if (coalesce(philips_param_pck.get_cd_pais,1) = 2) then --IVA, somente mexico
			open C03;
			loop
			fetch C03 into	
				nr_titulo_unific_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin
				
				update	titulo_pagar
				set		nr_titulo_dest	= nr_titulo_dest_w
				where	nr_titulo		= nr_titulo_unific_w;
		
				end;
			end loop;
			close C03;
		end if;
		
		CALL ATUALIZAR_INCLUSAO_TIT_PAGAR(nr_titulo_dest_w, nm_usuario_p, 'N');
		
		/*AAMFIRMO 09/05/16 OS 1042396 -  Aqui e necessario pegar os titulos que estao sendo unificados e atribuir a ele o titulo gerado antes do tempo, pois isso ocorre na abertura do cursor 01. Isso pois na geracao do tributo que ocorre na 
		ATUALIZAR_INCLUSAO_TIT_PAGAR, e efetuado um select dos titulos unifificados para utilizar o valor dos mesmos como base do tributo a ser gerado aqui. Como nao existe  o vinculo do NR_TITULO_DEST ainda, foi necessario esse update.*/
		if (coalesce(philips_param_pck.get_cd_pais,1) = 2) then --IVA, somente mexico
			
			open C03;
			loop
			fetch C03 into	
				nr_titulo_unific_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin
				
				update	titulo_pagar
				set		nr_titulo_dest	 = NULL
				where	nr_titulo		= nr_titulo_unific_w;
		
				end;
			end loop;
			close C03;
			
		end if;

		CALL gerar_titulo_pagar_classif(ds_lista_titulo_p,nr_titulo_dest_w,nm_usuario_p);
		nr_titulo_dest_p	:= nr_titulo_dest_w;

	end if;

	cd_tipo_baixa_w	:= obter_valor_param_usuario(851, 101, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w);

	if (coalesce(cd_tipo_baixa_w,0) = 0) then
		cd_tipo_baixa_w	:= 4;
	end if;

	/* baixar os titulos a pagar unificados */

	open c01;
	loop
	fetch c01 into
		nr_titulo_w,
		cd_estabelecimento_w,
		cd_estab_financeiro_w,
		vl_saldo_titulo_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		
		CALL baixa_titulo_pagar(cd_estabelecimento_w,
				cd_tipo_baixa_w,
				nr_titulo_w,
				vl_saldo_titulo_w,
				nm_usuario_p,
				coalesce(nr_seq_trans_fin_transf_w,nr_seq_trans_fin_baixa_w),
				null,
				null,
				dt_baixa_tit_unif_w,
				null);

		CALL atualizar_saldo_tit_pagar(nr_titulo_w,nm_usuario_p);
		CALL Gerar_W_Tit_Pag_imposto(nr_titulo_w, nm_usuario_p);

		ds_observacao_titulo_w	:= substr(ds_observacao_titulo_w || nr_titulo_w || ', ', 1, 3939);

		update	titulo_pagar
		set		nr_titulo_dest	= nr_titulo_dest_w
		where	nr_titulo		= nr_titulo_w;
	
	end loop;
	close c01;

	update	titulo_pagar
	set		ds_observacao_titulo	= ds_observacao_titulo_w
	where	nr_titulo			= nr_titulo_dest_w;

elsif (ie_acao_p = 'D') then

	select	max(a.cd_estabelecimento),
			max(a.vl_saldo_titulo),
			max(a.nr_titulo)
	into STRICT	cd_estabelecimento_w,
			vl_saldo_titulo_w,
			nr_titulo_unificado_w
	from	titulo_pagar a
	where	' ' || ds_lista_titulos_w || ' ' like '% ' || a.nr_titulo || ' %'
	and	(ds_lista_titulo_p IS NOT NULL AND ds_lista_titulo_p::text <> '');

	/* estornar a baixa dos titulos que compoe a unificacao */

	open	c02;
	loop
	fetch	c02 into
		nr_titulo_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */

		select	max(a.nr_sequencia),
				max(a.dt_baixa)
		into STRICT	nr_seq_baixa_w,
				dt_baixa_w
		from	titulo_pagar_baixa a
		where	a.nr_titulo	= nr_titulo_w;

		CALL Estornar_tit_pagar_baixa(	nr_titulo_w,
					nr_seq_baixa_w,
					dt_baixa_w,
					nm_usuario_p,
					'S');

		select	max(a.nr_sequencia)
		into STRICT	nr_seq_baixa_w
		from	titulo_pagar_baixa a
		where	a.nr_titulo	= nr_titulo_w;
		
		ds_observacao_w := wheb_mensagem_pck.get_texto(302928, 'nr_titulo_unificado_w=' || nr_titulo_unificado_w);
		
		update	titulo_pagar_baixa
		set		ds_observacao = ds_observacao_w
		where	nr_sequencia = nr_seq_baixa_w
		and		nr_titulo = nr_titulo_w;
		
		if (coalesce(ie_cancelar_tit_unificacao_w,'N') = 'S') then /*aamfirmo OS 556905 em 07/03/2013  limpar observacao dos titulos que foram unificados no processo que desfaz a unificacao*/
			update	titulo_pagar
			set		DS_OBSERVACAO_TITULO = ''
			where   nr_titulo = nr_titulo_w;
		end if;

		/* desfazer o vinculo com o titulo gerado pela unificacao */

		update	titulo_pagar
		set		nr_titulo_dest	 = NULL,
				nr_titulo_transf  = NULL
		where	nr_titulo = nr_titulo_w;
		
		CALL Atualizar_Saldo_Tit_Pagar(nr_titulo_w, nm_usuario_p);
	end	loop;
	close	c02;

	cd_tipo_baixa_w	:= obter_valor_param_usuario(851, 131, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w);

	if (coalesce(cd_tipo_baixa_w,0) = 0) then

		select	max(a.cd_tipo_baixa_padrao)
		into STRICT	cd_tipo_baixa_w
		from	parametros_contas_pagar a
		where	a.cd_estabelecimento	= cd_estabelecimento_w;

	end if;

	nr_seq_trans_fin_baixa_w	:= obter_valor_param_usuario(851, 132, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w);
	
	if (coalesce(ie_cancelar_tit_unificacao_w,'N') = 'S') then /*cancelar titulo gerado pela unificacao - aamfirmo OS556905 07/03/2013 */
		CALL cancelar_titulo_pagar( nr_titulo_unificado_w,
				       nm_usuario_p,
				       clock_timestamp());
		
	elsif (coalesce(ie_cancelar_tit_unificacao_w,'N') = 'N') then
		CALL baixa_titulo_pagar(	cd_estabelecimento_w,
				cd_tipo_baixa_w,
				nr_titulo_unificado_w,
				vl_saldo_titulo_w,
				nm_usuario_p,
				nr_seq_trans_fin_baixa_w,
				null,
				null,
				clock_timestamp(),
				null);
	end if;		
	
	CALL atualizar_saldo_tit_pagar(nr_titulo_unificado_w, nm_usuario_p);
	CALL Gerar_W_Tit_Pag_imposto(nr_titulo_unificado_w, nm_usuario_p);

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE unificar_titulos_pagar (ds_lista_titulo_p text, nm_usuario_p text, cd_pessoa_fisica_p text, cd_cgc_p text, nr_titulo_dest_p INOUT bigint, dt_emissao_p timestamp, dt_vencto_atual_p timestamp, dt_vencto_orig_p timestamp, dt_contabil_p timestamp, nr_seq_classe_p bigint default null, ie_acao_p text DEFAULT NULL) FROM PUBLIC;

