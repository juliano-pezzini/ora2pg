-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_glosa_conta ( nr_interno_conta_p bigint) AS $body$
DECLARE


cd_convenio_w			integer;
dt_alta_w			timestamp;
vl_glosa_w			double precision;
pr_glosa_w			double precision;
ie_tipo_atendimento_w	smallint;
qt_reg_regra_w		integer;


BEGIN

select	count(*)
into STRICT	qt_reg_regra_w
from	convenio_regra_glosa;

if (qt_reg_regra_w > 0) then
	begin
	select	coalesce(max(a.cd_convenio_parametro),0),
		max(b.ie_tipo_atendimento),
		max(coalesce(dt_alta,clock_timestamp()))
	into STRICT	cd_convenio_w,
		ie_tipo_atendimento_w,
		dt_alta_w
	from 	atendimento_paciente b,
		conta_paciente a
	where	a.nr_atendimento 	= b.nr_atendimento
	  and	a.nr_interno_conta 	= nr_interno_conta_p;

	if (cd_convenio_w > 0) then
		begin

		select	Obter_perc_glosa_convenio(cd_convenio_w, ie_tipo_atendimento_w, dt_alta_w)
		into STRICT	pr_glosa_w
		;

		if (pr_glosa_w	<> 0) then
			update conta_paciente_resumo
			set	vl_glosa	= (coalesce(vl_material,0) + coalesce(vl_procedimento,0)) * pr_glosa_w / 100
			where	nr_interno_conta	= nr_interno_conta_p;
		end if;

		end;
	end if;
	end;
end if;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_glosa_conta ( nr_interno_conta_p bigint) FROM PUBLIC;

