-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_os_especif_anexar_arquivo ( nr_sequencia_p bigint, ie_tipo_anexo_p text, ds_arquivo_p text, nm_usuario_p text ) AS $body$
DECLARE


nr_anexo_w		man_os_especif_anexo.nr_anexo%type;
ie_tipo_anexo_w		man_os_teste_evidencia.ie_tipo%type;


BEGIN

	if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then

		if (ie_tipo_anexo_p = 'A') then

			select	coalesce(max(nr_anexo), 0) + 1
			into STRICT	nr_anexo_w
			from	man_os_especif_anexo
			where	nr_seq_especificacao = nr_sequencia_p;

			insert into man_os_especif_anexo(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_especificacao,
				nr_seq_detalhe,
				nr_seq_to_do,
				nr_anexo,
				ie_tipo,
				ds_nome,
				ds_arquivo )
			values (nextval('man_os_especif_anexo_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_sequencia_p,
				null,
				null,
				nr_anexo_w,
				'OA',
				'',
				ds_arquivo_p );

		elsif (ie_tipo_anexo_p = 'R') then

			select	coalesce(max(nr_anexo), 0) + 1
			into STRICT	nr_anexo_w
			from	man_os_especif_anexo
			where	nr_seq_detalhe = nr_sequencia_p;

			insert into man_os_especif_anexo(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_especificacao,
				nr_seq_detalhe,
				nr_seq_to_do,
				nr_anexo,
				ie_tipo,
				ds_nome,
				ds_arquivo )
			values (nextval('man_os_especif_anexo_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				null,
				nr_sequencia_p,
				null,
				nr_anexo_w,
				'OA',
				'',
				ds_arquivo_p );

		elsif (ie_tipo_anexo_p = 'I') then

			select	coalesce(max(nr_anexo), 0) + 1
			into STRICT	nr_anexo_w
			from	man_os_especif_anexo
			where	nr_seq_to_do = nr_sequencia_p;

			insert into man_os_especif_anexo(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_especificacao,
				nr_seq_detalhe,
				nr_seq_to_do,
				nr_anexo,
				ie_tipo,
				ds_nome,
				ds_arquivo )
			values (nextval('man_os_especif_anexo_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				null,
				null,
				nr_sequencia_p,
				nr_anexo_w,
				'OA',
				'',
				ds_arquivo_p );

		elsif (ie_tipo_anexo_p = 'T') then

			select	coalesce(max(nr_anexo), 0) + 1
			into STRICT	nr_anexo_w
			from	man_os_especif_anexo
			where	nr_seq_especificacao = nr_sequencia_p;

			insert into man_os_especif_anexo(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_especificacao,
				nr_seq_detalhe,
				nr_seq_to_do,
				nr_anexo,
				ie_tipo,
				ds_nome,
				ds_arquivo )
			values (nextval('man_os_especif_anexo_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_sequencia_p,
				null,
				null,
				nr_anexo_w,
				'OA',
				'',
				ds_arquivo_p );

		end if;

	end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_os_especif_anexar_arquivo ( nr_sequencia_p bigint, ie_tipo_anexo_p text, ds_arquivo_p text, nm_usuario_p text ) FROM PUBLIC;

