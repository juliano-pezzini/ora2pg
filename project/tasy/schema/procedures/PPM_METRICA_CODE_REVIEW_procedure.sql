-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ppm_metrica_code_review ( nr_seq_metrica_p bigint, nr_seq_objetivo_metrica_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, dt_referencia_p timestamp) AS $body$
DECLARE


/*Todas as OSs em encerradas do usuário com atividade de programação
devem ter um histórico de code review*/
dt_ref_inicio_w 	timestamp;
dt_ref_fim_w 		timestamp;
qt_os_encerradas_w	bigint;
qt_code_review_w	bigint;
vl_Resultado_w		double precision;
nm_usuario_exec_w	usuario.nm_usuario%type;
dt_referencia_w		timestamp;
nr_seq_diretoria_w	ppm_objetivo.nr_seq_diretoria%type;
nr_seq_gerencia_w	ppm_objetivo.nr_seq_gerencia%type;
nr_seq_grupo_w		ppm_objetivo.nr_seq_grupo%type;
ie_area_gerencia_w	varchar(5);
qt_programacao_w	bigint;


BEGIN

dt_ref_inicio_w := pkg_date_utils.start_of(dt_referencia_p,'MONTH');
dt_ref_fim_w 	:= pkg_date_utils.end_of(last_day(dt_referencia_p),'DAY');
dt_referencia_w	:= trunc(dt_referencia_p);

select	max(nr_seq_gerencia),
	max(nr_seq_grupo),
	max(nr_seq_diretoria)
into STRICT	nr_seq_gerencia_w,
	nr_seq_grupo_w,
	nr_seq_diretoria_w
from	ppm_objetivo_metrica a,
	ppm_objetivo_meta b,
	ppm_objetivo c
where	a.nr_sequencia		= nr_seq_objetivo_metrica_p
and	a.nr_seq_meta		= b.nr_sequencia
and	b.nr_seq_objetivo	= c.nr_sequencia;

select	coalesce(max(ie_area_gerencia),'X')
into STRICT	ie_area_gerencia_w
from	gerencia_wheb
where	nr_sequencia	= nr_seq_gerencia_w;

select	max(nm_usuario)
into STRICT	nm_usuario_exec_w
from	usuario x
where	x.cd_pessoa_fisica = cd_pessoa_fisica_p
and	x.ie_situacao	= 'A';

if (nr_seq_grupo_w IS NOT NULL AND nr_seq_grupo_w::text <> '') then

	-- total de os com atividade de programação
	select	sum(1)
	into STRICT	qt_programacao_w
	from (
		SELECT a.nr_seq_ordem_serv
		from	man_ordem_serv_ativ a,
			grupo_desenvolvimento b,
			gerencia_wheb c,
			man_ordem_servico o,
			man_estagio_processo ep
		where	a.nr_seq_grupo_des = b.nr_sequencia
		and	b.nr_seq_gerencia = c.nr_sequencia
		and	o.nr_sequencia = a.nr_seq_ordem_serv
		and	o.nr_seq_estagio = ep.nr_sequencia
		and	o.ie_classificacao in ('E','S')
		and	c.ie_area_gerencia = ie_area_gerencia_w
		and (coalesce(ep.ie_desenv,'X') <> 'S' AND coalesce(Ep.Ie_Tecnologia,'X') <>'S')
		and	a.nr_seq_funcao in (11,551, 1288)
		and	trunc(a.dt_atividade) between to_date(dt_ref_inicio_w) and to_date(dt_ref_fim_w)
		and	((coalesce(nr_seq_grupo_w,0) = 0) or (o.nr_seq_grupo_des = nr_seq_grupo_w))
		and	exists -- colocadas em cliente teste após atividade de programação
			(SELECT 1
			from	man_estagio_processo c1,
				man_ordem_serv_estagio d
			where	c1.nr_sequencia = d.nr_seq_estagio
			and	d.nr_seq_ordem   = a.nr_seq_ordem_serv
			and	d.nr_seq_estagio  in (2, 9) -- 2 cliente teste , 9 ok cliente encerrado
			and	d.dt_atualizacao between to_date(dt_ref_inicio_w) and to_date(dt_ref_fim_w))) alias18;

	-- total de os com atividade de programação
        select	sum(1)
	into STRICT	qt_code_review_w
	from	(
		SELECT	a.nr_seq_ordem_serv
                from	man_ordem_serv_ativ a,
			grupo_desenvolvimento b,
			gerencia_wheb c,
			man_ordem_servico o,
			man_estagio_processo ep
		where	a.nr_seq_grupo_des = b.nr_sequencia
                and	b.nr_seq_gerencia = c.nr_sequencia
		and 	o.nr_sequencia = a.nr_seq_ordem_serv
		and	o.nr_seq_estagio = ep.nr_sequencia
		and	o.ie_classificacao in ('E','S')
                and 	c.ie_area_gerencia = ie_area_gerencia_w
                and (coalesce(ep.ie_desenv,'X') <> 'S' AND coalesce(Ep.Ie_Tecnologia,'X') <>'S')
                and 	a.nr_seq_funcao in (11,551, 1288)
		and 	trunc(a.dt_atividade) between to_date(dt_ref_inicio_w) and to_date(dt_ref_fim_w)
                and	((coalesce(nr_seq_grupo_w,0) = 0) or (o.nr_seq_grupo_des = nr_seq_grupo_w))
                and 	exists -- colocadas em cliente teste após atividade de programação
			(SELECT	1
			from	man_estagio_processo c1,
				man_ordem_serv_estagio d
			where	c1.nr_sequencia = d.nr_seq_estagio
                        and	d.nr_seq_ordem   = a.nr_seq_ordem_serv
                        and	d.nr_seq_estagio  in (2, 9) -- 2 cliente teste , 9 ok cliente encerrado
                        and	d.dt_atualizacao between to_date(dt_ref_inicio_w) and to_date(dt_ref_fim_w))
		and exists --com histórico do tipo aprovação de code review
			(select	1
                        from	man_ordem_serv_tecnico x
			where	x.nr_seq_ordem_serv = a.nr_seq_ordem_serv
			--31 teste do analista ou  163 aprovação de code review
			and	x.nr_seq_tipo         = 163)) alias18;

elsif (nr_seq_gerencia_w IS NOT NULL AND nr_seq_gerencia_w::text <> '') then

	-- total de os com atividade de programação
	select	sum(1)
	into STRICT	qt_programacao_w
	from (
		SELECT a.nr_seq_ordem_serv
		from	man_ordem_serv_ativ a,
			grupo_desenvolvimento b,
			gerencia_wheb c,
			man_ordem_servico o,
			man_estagio_processo ep
		where	a.nr_seq_grupo_des = b.nr_sequencia
		and	b.nr_seq_gerencia = c.nr_sequencia
		and	o.nr_sequencia = a.nr_seq_ordem_serv
		and	o.nr_seq_estagio = ep.nr_sequencia
		and	o.ie_classificacao in ('E','S')
		and	c.ie_area_gerencia = ie_area_gerencia_w
		and (coalesce(ep.ie_desenv,'X') <> 'S' AND coalesce(Ep.Ie_Tecnologia,'X') <>'S')
		and	a.nr_seq_funcao in (11,551, 1288)
		and	trunc(a.dt_atividade) between to_date(dt_ref_inicio_w) and to_date(dt_ref_fim_w)
		and	((coalesce(nr_seq_gerencia_w,0) = 0) or (b.nr_seq_gerencia = nr_seq_gerencia_w))
		and	exists -- colocadas em cliente teste após atividade de programação
			(SELECT 1
			from	man_estagio_processo c1,
				man_ordem_serv_estagio d
			where	c1.nr_sequencia = d.nr_seq_estagio
			and	d.nr_seq_ordem   = a.nr_seq_ordem_serv
			and	d.nr_seq_estagio  in (2, 9) -- 2 cliente teste , 9 ok cliente encerrado
			and	d.dt_atualizacao between to_date(dt_ref_inicio_w) and to_date(dt_ref_fim_w))) alias18;

	-- total de os com atividade de programação
        select	sum(1)
	into STRICT	qt_code_review_w
	from	(
		SELECT	a.nr_seq_ordem_serv
                from	man_ordem_serv_ativ a,
			grupo_desenvolvimento b,
			gerencia_wheb c,
			man_ordem_servico o,
			man_estagio_processo ep
		where	a.nr_seq_grupo_des = b.nr_sequencia
                and	b.nr_seq_gerencia = c.nr_sequencia
		and 	o.nr_sequencia = a.nr_seq_ordem_serv
		and	o.nr_seq_estagio = ep.nr_sequencia
		and	o.ie_classificacao in ('E','S')
                and 	c.ie_area_gerencia = ie_area_gerencia_w
                and (coalesce(ep.ie_desenv,'X') <> 'S' AND coalesce(Ep.Ie_Tecnologia,'X') <>'S')
                and 	a.nr_seq_funcao in (11,551, 1288)
		and 	trunc(a.dt_atividade) between to_date(dt_ref_inicio_w) and to_date(dt_ref_fim_w)
                and 	((coalesce(nr_seq_gerencia_w,0) = 0) or (b.nr_seq_gerencia = nr_seq_gerencia_w))
                and 	exists -- colocadas em cliente teste após atividade de programação
			(SELECT	1
			from	man_estagio_processo c1,
				man_ordem_serv_estagio d
			where	c1.nr_sequencia = d.nr_seq_estagio
                        and	d.nr_seq_ordem   = a.nr_seq_ordem_serv
                        and	d.nr_seq_estagio  in (2, 9) -- 2 cliente teste , 9 ok cliente encerrado
                        and	d.dt_atualizacao between to_date(dt_ref_inicio_w) and to_date(dt_ref_fim_w))
		and exists --com histórico do tipo aprovação de code review
			(select	1
                        from	man_ordem_serv_tecnico x
			where	x.nr_seq_ordem_serv = a.nr_seq_ordem_serv
			--31 teste do analista ou  163 aprovação de code review
			and	x.nr_seq_tipo         = 163)) alias18;

elsif (nr_seq_diretoria_w IS NOT NULL AND nr_seq_diretoria_w::text <> '') then

	-- total de os com atividade de programação
	select	sum(1)
	into STRICT	qt_programacao_w
	from (
		SELECT a.nr_seq_ordem_serv
		from	man_ordem_serv_ativ a,
			grupo_desenvolvimento b,
			gerencia_wheb c,
			man_ordem_servico o,
			man_estagio_processo ep
		where	a.nr_seq_grupo_des = b.nr_sequencia
		and	b.nr_seq_gerencia = c.nr_sequencia
		and	o.nr_sequencia = a.nr_seq_ordem_serv
		and	o.nr_seq_estagio = ep.nr_sequencia
		and	o.ie_classificacao in ('E','S')
		and	c.ie_area_gerencia = ie_area_gerencia_w
		and (coalesce(ep.ie_desenv,'X') <> 'S' AND coalesce(Ep.Ie_Tecnologia,'X') <>'S')
		and	a.nr_seq_funcao in (11,551, 1288)
		and	trunc(a.dt_atividade) between to_date(dt_ref_inicio_w) and to_date(dt_ref_fim_w)
		and	((coalesce(nr_seq_diretoria_w,0) = 0) or (c.nr_seq_diretoria = nr_seq_diretoria_w))
		and	exists -- colocadas em cliente teste após atividade de programação
			(SELECT 1
			from	man_estagio_processo c1,
				man_ordem_serv_estagio d
			where	c1.nr_sequencia = d.nr_seq_estagio
			and	d.nr_seq_ordem   = a.nr_seq_ordem_serv
			and	d.nr_seq_estagio  in (2, 9) -- 2 cliente teste , 9 ok cliente encerrado
			and	d.dt_atualizacao between to_date(dt_ref_inicio_w) and to_date(dt_ref_fim_w))) alias18;

	-- total de os com atividade de programação
        select	sum(1)
	into STRICT	qt_code_review_w
	from	(
		SELECT	a.nr_seq_ordem_serv
                from	man_ordem_serv_ativ a,
			grupo_desenvolvimento b,
			gerencia_wheb c,
			man_ordem_servico o,
			man_estagio_processo ep
		where	a.nr_seq_grupo_des = b.nr_sequencia
                and	b.nr_seq_gerencia = c.nr_sequencia
		and 	o.nr_sequencia = a.nr_seq_ordem_serv
		and	o.nr_seq_estagio = ep.nr_sequencia
		and	o.ie_classificacao in ('E','S')
                and 	c.ie_area_gerencia = ie_area_gerencia_w
                and (coalesce(ep.ie_desenv,'X') <> 'S' AND coalesce(Ep.Ie_Tecnologia,'X') <>'S')
                and 	a.nr_seq_funcao in (11,551, 1288)
		and 	trunc(a.dt_atividade) between to_date(dt_ref_inicio_w) and to_date(dt_ref_fim_w)
                and	((coalesce(nr_seq_diretoria_w,0) = 0) or (c.nr_seq_diretoria = nr_seq_diretoria_w))
                and 	exists -- colocadas em cliente teste após atividade de programação
			(SELECT	1
			from	man_estagio_processo c1,
				man_ordem_serv_estagio d
			where	c1.nr_sequencia = d.nr_seq_estagio
                        and	d.nr_seq_ordem   = a.nr_seq_ordem_serv
                        and	d.nr_seq_estagio  in (2, 9) -- 2 cliente teste , 9 ok cliente encerrado
                        and	d.dt_atualizacao between to_date(dt_ref_inicio_w) and to_date(dt_ref_fim_w))
		and exists --com histórico do tipo aprovação de code review
			(select	1
                        from	man_ordem_serv_tecnico x
			where	x.nr_seq_ordem_serv = a.nr_seq_ordem_serv
			--31 teste do analista ou  163 aprovação de code review
			and	x.nr_seq_tipo         = 163)) alias18;

elsif (nm_usuario_exec_w IS NOT NULL AND nm_usuario_exec_w::text <> '') then

	-- total de os com atividade de programação
	select	sum(1)
	into STRICT	qt_programacao_w
	from (
		SELECT a.nr_seq_ordem_serv
		from	man_ordem_serv_ativ a,
			grupo_desenvolvimento b,
			gerencia_wheb c,
			man_ordem_servico o,
			man_estagio_processo ep,
			man_ordem_servico_exec e
		where	a.nr_seq_grupo_des = b.nr_sequencia
		and	b.nr_seq_gerencia = c.nr_sequencia
		and	o.nr_sequencia = a.nr_seq_ordem_serv
		and	o.nr_sequencia = e.nr_seq_ordem
		and	o.nr_seq_estagio = ep.nr_sequencia
		and	o.ie_classificacao in ('E','S')
		and	c.ie_area_gerencia = ie_area_gerencia_w
		and (coalesce(ep.ie_desenv,'X') <> 'S' AND coalesce(Ep.Ie_Tecnologia,'X') <>'S')
		and	a.nr_seq_funcao in (11,551, 1288)
		and	trunc(a.dt_atividade) between to_date(dt_ref_inicio_w) and to_date(dt_ref_fim_w)
		and	((coalesce(nm_usuario_exec_w,0) = 0) or (e.nm_usuario_exec = nm_usuario_exec_w))
		and	exists -- colocadas em cliente teste após atividade de programação
			(SELECT 1
			from	man_estagio_processo c1,
				man_ordem_serv_estagio d
			where	c1.nr_sequencia = d.nr_seq_estagio
			and	d.nr_seq_ordem   = a.nr_seq_ordem_serv
			and	d.nr_seq_estagio  in (2, 9) -- 2 cliente teste , 9 ok cliente encerrado
			and	d.dt_atualizacao between to_date(dt_ref_inicio_w) and to_date(dt_ref_fim_w))) alias18;

	-- total de os com atividade de programação
        select	sum(1)
	into STRICT	qt_code_review_w
	from	(
		SELECT	a.nr_seq_ordem_serv
                from	man_ordem_serv_ativ a,
			grupo_desenvolvimento b,
			gerencia_wheb c,
			man_ordem_servico o,
			man_estagio_processo ep,
			man_ordem_servico_exec e
		where	a.nr_seq_grupo_des = b.nr_sequencia
                and	b.nr_seq_gerencia = c.nr_sequencia
		and 	o.nr_sequencia = a.nr_seq_ordem_serv
		and	o.nr_sequencia = e.nr_seq_ordem
		and	o.nr_seq_estagio = ep.nr_sequencia
		and	o.ie_classificacao in ('E','S')
                and 	c.ie_area_gerencia = ie_area_gerencia_w
                and (coalesce(ep.ie_desenv,'X') <> 'S' AND coalesce(Ep.Ie_Tecnologia,'X') <>'S')
                and 	a.nr_seq_funcao in (11,551, 1288)
		and 	trunc(a.dt_atividade) between to_date(dt_ref_inicio_w) and to_date(dt_ref_fim_w)
                and	((coalesce(nm_usuario_exec_w,0) = 0) or (e.nm_usuario_exec = nm_usuario_exec_w))
                and 	exists -- colocadas em cliente teste após atividade de programação
			(SELECT	1
			from	man_estagio_processo c1,
				man_ordem_serv_estagio d
			where	c1.nr_sequencia = d.nr_seq_estagio
                        and	d.nr_seq_ordem   = a.nr_seq_ordem_serv
                        and	d.nr_seq_estagio  in (2, 9) -- 2 cliente teste , 9 ok cliente encerrado
                        and	d.dt_atualizacao between to_date(dt_ref_inicio_w) and to_date(dt_ref_fim_w))
		and exists --com histórico do tipo aprovação de code review
			(select	1
                        from	man_ordem_serv_tecnico x
			where	x.nr_seq_ordem_serv = a.nr_seq_ordem_serv
			--31 teste do analista ou  163 aprovação de code review
			and	x.nr_seq_tipo         = 163)) alias18;

end if;

if (qt_programacao_w > 0) then
	vl_Resultado_w	:= dividir(qt_code_review_w * 100, qt_programacao_w);
else
	vl_Resultado_w	:= 100; --Se não teve nenhuma OS como programação, code review fica como 100%.
end if;

CALL PPM_GRAVAR_RESULTADO(nr_seq_objetivo_metrica_p,dt_referencia_p, vl_Resultado_w, qt_programacao_w, qt_code_review_w, nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ppm_metrica_code_review ( nr_seq_metrica_p bigint, nr_seq_objetivo_metrica_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, dt_referencia_p timestamp) FROM PUBLIC;

