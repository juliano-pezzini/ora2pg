-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_pessoa_jur_integracao ( cd_cgc_p text, cd_estab_p bigint, nm_usuario_p text, ds_razao_social_p text, nm_fantasia_p text, ds_nome_abrev_p text, cd_municipio_ibge_p text, cd_cep_p text, ds_endereco_p text, nr_endereco_p text, ds_complemento_p text, ds_bairro_p text, ds_municipio_p text, sg_estado_p text, nr_telefone_p text, nr_fax_p text, nr_inscricao_estadual_p text, nr_inscricao_municipal_p text, cd_internacional_p text, ds_site_internet_p text, cd_pf_resp_tecnico_p text, ds_orgao_reg_resp_tecnico_p text, nr_autor_func_p text, nr_alvara_sanitario_p text, nr_alvara_sanitario_munic_p text, nr_certificado_boas_prat_p text, cd_ans_p text, dt_validade_autor_func_p timestamp, dt_validade_alvara_sanit_p timestamp, dt_validade_cert_boas_prat_p timestamp, cd_cnes_p text, cd_referencia_fornec_p text, cd_sistema_ant_p text, ds_email_p text, dt_validade_resp_tecnico_p timestamp, nm_pessoa_contato_p text, nr_ramal_contato_p text, nr_registro_resp_tecnico_p text, qt_dia_prazo_entrega_p bigint, vl_minimo_nf_p bigint, dt_validade_alvara_munic_p timestamp, ds_resp_tecnico_p text, ie_situacao_p text, ie_status_apenado_p text) AS $body$
DECLARE


cd_tipo_pessoa_w        smallint;
cd_estabelecimento_w      smallint;
qt_existe_w       bigint;
cd_regra_w        smallint;

c01 CURSOR FOR
SELECT  cd_estabelecimento
from  estabelecimento
where ie_situacao = 'A';


BEGIN

select  coalesce(max(cd_tipo_pessoa),0)
into STRICT  cd_tipo_pessoa_w
from  tipo_pessoa_juridica
where ie_situacao = 'A';

select  count(*)
into STRICT  qt_existe_w
from  pessoa_juridica
where cd_cgc = cd_cgc_p;

-- Verifica se há regra de pré cadastro para o tipo de pessoa juridica
select coalesce(max(cd_tipo_pessoa),0)
  into STRICT cd_regra_w
  from ( SELECT cd_tipo_pessoa
           from regra_pre_cad_pj
          where cd_tipo_pessoa = cd_tipo_pessoa_w
            and ie_exige_aprov_cadastro = 'S'

union

         SELECT cd_tipo_pessoa
           from regra_pre_cad_pj
          where coalesce(cd_tipo_pessoa::text, '') = ''
            and ie_exige_aprov_cadastro = 'S' ) alias3;

if (cd_tipo_pessoa_w > 0) then

  if (qt_existe_w = 0) then

    -- Se houver, insere na tabela PRE_PESSOA_JURIDICA
    if cd_regra_w <> 0 then
      insert into pre_pessoa_juridica(
        cd_cgc,
        ds_razao_social,
        nm_fantasia,
        cd_cep,
        ds_endereco,
        ds_bairro,
        ds_municipio,
        sg_estado,
        dt_atualizacao,
        nm_usuario,
        ds_complemento,
        nr_telefone,
        nr_endereco,
        nr_fax,
        nm_pessoa_contato,
        nr_ramal_contato,
        nr_inscricao_estadual,
        cd_tipo_pessoa,
        ie_prod_fabric,
        ds_site_internet,
        qt_dia_prazo_entrega,
        ds_nome_abrev,
        ie_situacao,
        vl_minimo_nf,
        cd_pf_resp_tecnico,
        nr_alvara_sanitario,
        nr_autor_func,
        nr_inscricao_municipal,
        cd_ans,
        cd_referencia_fornec,
        dt_validade_alvara_sanit,
        dt_validade_autor_func,
        dt_atualizacao_nrec,
        nm_usuario_nrec,
        ie_alterar_senha,
        cd_internacional,
        cd_cnes,
        cd_municipio_ibge,
        nr_certificado_boas_prat,
        nr_alvara_sanitario_munic,
        dt_validade_alvara_munic,
        dt_validade_cert_boas_prat,
        dt_validade_resp_tecnico,
        ds_orgao_reg_resp_tecnico,
        nr_registro_resp_tecnico,
        ds_resp_tecnico,
        cd_sistema_ant,
        nm_usuario_lib,
        dt_liberacao,
        nr_sequencia)
      values ( cd_cgc_p,
        ds_razao_social_p,
        nm_fantasia_p,
        cd_cep_p,
        ds_endereco_p,
        ds_bairro_p,
        ds_municipio_p,
        sg_estado_p,
        clock_timestamp(),
        nm_usuario_p,
        ds_complemento_p,
        nr_telefone_p,
        nr_endereco_p,
        nr_fax_p,
        nm_pessoa_contato_p,
        nr_ramal_contato_p,
        nr_inscricao_estadual_p,
        cd_tipo_pessoa_w,
        'N',
        ds_site_internet_p,
        qt_dia_prazo_entrega_p,
        ds_nome_abrev_p,
        'A',
        vl_minimo_nf_p,
        cd_pf_resp_tecnico_p,
        nr_alvara_sanitario_p,
        nr_autor_func_p,
        nr_inscricao_municipal_p,
        cd_ans_p,
        cd_referencia_fornec_p,
        dt_validade_alvara_sanit_p,
        dt_validade_autor_func_p,
        clock_timestamp(),
        nm_usuario_p,
        'N',
        cd_internacional_p,
        cd_cnes_p,
        cd_municipio_ibge_p,
        nr_certificado_boas_prat_p,
        nr_alvara_sanitario_munic_p,
        dt_validade_alvara_munic_p,
        dt_validade_cert_boas_prat_p,
        dt_validade_resp_tecnico_p,
        ds_orgao_reg_resp_tecnico_p,
        nr_registro_resp_tecnico_p,
        ds_resp_tecnico_p,
        cd_sistema_ant_p,
        nm_usuario_p,
        clock_timestamp(),
        nextval('pre_pessoa_juridica_seq'));

      open C01;
      loop
      fetch C01 into
        cd_estabelecimento_w;
      EXIT WHEN NOT FOUND; /* apply on C01 */
        begin
        insert into pre_pessoa_juridica_estab(
          nr_sequencia,
          cd_cgc,
          cd_estabelecimento,
          dt_atualizacao,
          nm_usuario,
          nm_pessoa_contato,
          nr_ramal_contato,
          ds_email,
          qt_dia_prazo_entrega,
          vl_minimo_nf,
          dt_atualizacao_nrec,
          nm_usuario_nrec,
          ie_conta_dif_nf,
          ie_status_apenado,
          nr_seq_pre_pj)
        values (nextval('pre_pessoa_juridica_estab_seq'),
          cd_cgc_p,
          cd_estabelecimento_w,
          clock_timestamp(),
          nm_usuario_p,
          nm_pessoa_contato_p,
          nr_ramal_contato_p,
          ds_email_p,
          qt_dia_prazo_entrega_p,
          vl_minimo_nf_p,
          clock_timestamp(),
          nm_usuario_p,
          'N',
          ie_status_apenado_p,
          currval('pre_pessoa_juridica_seq'));
        end;
      end loop;
      close C01;
    else
      insert into pessoa_juridica(
        cd_cgc,
        ds_razao_social,
        nm_fantasia,
        cd_cep,
        ds_endereco,
        ds_bairro,
        ds_municipio,
        sg_estado,
        dt_atualizacao,
        nm_usuario,
        ds_complemento,
        nr_telefone,
        nr_endereco,
        nr_fax,
        nm_pessoa_contato,
        nr_ramal_contato,
        nr_inscricao_estadual,
        cd_tipo_pessoa,
        ie_prod_fabric,
        ds_site_internet,
        qt_dia_prazo_entrega,
        ds_nome_abrev,
        ie_situacao,
        vl_minimo_nf,
        cd_pf_resp_tecnico,
        nr_alvara_sanitario,
        nr_autor_func,
        nr_inscricao_municipal,
        cd_ans,
        cd_referencia_fornec,
        dt_validade_alvara_sanit,
        dt_validade_autor_func,
        dt_atualizacao_nrec,
        nm_usuario_nrec,
        ie_alterar_senha,
        cd_internacional,
        cd_cnes,
        cd_municipio_ibge,
        nr_certificado_boas_prat,
        nr_alvara_sanitario_munic,
        dt_validade_alvara_munic,
        dt_validade_cert_boas_prat,
        dt_validade_resp_tecnico,
        ds_orgao_reg_resp_tecnico,
        nr_registro_resp_tecnico,
        ds_resp_tecnico,
        cd_sistema_ant)
      values ( cd_cgc_p,
        ds_razao_social_p,
        nm_fantasia_p,
        cd_cep_p,
        ds_endereco_p,
        ds_bairro_p,
        ds_municipio_p,
        sg_estado_p,
        clock_timestamp(),
        nm_usuario_p,
        ds_complemento_p,
        nr_telefone_p,
        nr_endereco_p,
        nr_fax_p,
        nm_pessoa_contato_p,
        nr_ramal_contato_p,
        nr_inscricao_estadual_p,
        cd_tipo_pessoa_w,
        'N',
        ds_site_internet_p,
        qt_dia_prazo_entrega_p,
        ds_nome_abrev_p,
        'A',
        vl_minimo_nf_p,
        cd_pf_resp_tecnico_p,
        nr_alvara_sanitario_p,
        nr_autor_func_p,
        nr_inscricao_municipal_p,
        cd_ans_p,
        cd_referencia_fornec_p,
        dt_validade_alvara_sanit_p,
        dt_validade_autor_func_p,
        clock_timestamp(),
        nm_usuario_p,
        'N',
        cd_internacional_p,
        cd_cnes_p,
        cd_municipio_ibge_p,
        nr_certificado_boas_prat_p,
        nr_alvara_sanitario_munic_p,
        dt_validade_alvara_munic_p,
        dt_validade_cert_boas_prat_p,
        dt_validade_resp_tecnico_p,
        ds_orgao_reg_resp_tecnico_p,
        nr_registro_resp_tecnico_p,
        ds_resp_tecnico_p,
        cd_sistema_ant_p);

      open C01;
      loop
      fetch C01 into
        cd_estabelecimento_w;
      EXIT WHEN NOT FOUND; /* apply on C01 */
        begin
        insert into pessoa_juridica_estab(
          nr_sequencia,
          cd_cgc,
          cd_estabelecimento,
          dt_atualizacao,
          nm_usuario,
          nm_pessoa_contato,
          nr_ramal_contato,
          ds_email,
          qt_dia_prazo_entrega,
          vl_minimo_nf,
          dt_atualizacao_nrec,
          nm_usuario_nrec,
          ie_conta_dif_nf,
          ie_status_apenado)
        values ( nextval('pessoa_juridica_estab_seq'),
          cd_cgc_p,
          cd_estabelecimento_w,
          clock_timestamp(),
          nm_usuario_p,
          nm_pessoa_contato_p,
          nr_ramal_contato_p,
          ds_email_p,
          qt_dia_prazo_entrega_p,
          vl_minimo_nf_p,
          clock_timestamp(),
          nm_usuario_p,
          'N',
          ie_status_apenado_p);
        end;
      end loop;
      close C01;
    end if;
  else
    update  pessoa_juridica
    set ds_razao_social   = ds_razao_social_p,
      nm_fantasia   = nm_fantasia_p,
      cd_cep      = cd_cep_p,
      ds_endereco   = ds_endereco_p,
      ds_bairro     = ds_bairro_p,
      ds_municipio    = ds_municipio_p,
      sg_estado   = sg_estado_p,
      dt_atualizacao    = clock_timestamp(),
      nm_usuario    = nm_usuario_p,
      ds_complemento    = ds_complemento_p,
      nr_telefone   = nr_telefone_p,
      nr_endereco   = nr_endereco_p,
      nr_fax      = nr_fax_p,
      ds_email      = ds_email_p,
      nm_pessoa_contato = nm_pessoa_contato_p,
      nr_ramal_contato    = nr_ramal_contato_p,
      nr_inscricao_estadual = nr_inscricao_estadual_p,
      ds_site_internet    = ds_site_internet_p,
      qt_dia_prazo_entrega  = qt_dia_prazo_entrega_p,
      ds_nome_abrev   = ds_nome_abrev_p,
      vl_minimo_nf    = vl_minimo_nf_p,
      cd_pf_resp_tecnico    = cd_pf_resp_tecnico_p,
      nr_alvara_sanitario   = nr_alvara_sanitario_p,
      nr_autor_func   = nr_autor_func_p,
      nr_inscricao_municipal  = nr_inscricao_municipal_p,
      cd_ans      = cd_ans_p,
      cd_referencia_fornec  = cd_referencia_fornec_p,
      dt_validade_alvara_sanit  = dt_validade_alvara_sanit_p,
      dt_validade_autor_func  = dt_validade_autor_func_p,
      cd_internacional    = cd_internacional_p,
      cd_cnes     = cd_cnes_p,
      cd_municipio_ibge   = cd_municipio_ibge_p,
      nr_certificado_boas_prat  = nr_certificado_boas_prat_p,
      nr_alvara_sanitario_munic = nr_alvara_sanitario_munic_p,
      dt_validade_alvara_munic  = dt_validade_alvara_munic_p,
      dt_validade_cert_boas_prat  = dt_validade_cert_boas_prat_p,
      dt_validade_resp_tecnico  = dt_validade_resp_tecnico_p,
      ds_orgao_reg_resp_tecnico = ds_orgao_reg_resp_tecnico_p,
      nr_registro_resp_tecnico  = nr_registro_resp_tecnico_p,
      ds_resp_tecnico   = ds_resp_tecnico_p,
      ie_situacao   = ie_situacao_p
    where cd_cgc      = cd_cgc_p;

    update  pessoa_juridica_estab
    set nm_pessoa_contato = nm_pessoa_contato_p,
      nr_ramal_contato    = nr_ramal_contato_p,
      ds_email      = ds_email_p,
      qt_dia_prazo_entrega  = qt_dia_prazo_entrega_p,
      vl_minimo_nf    = vl_minimo_nf_p,
      ie_status_apenado = ie_status_apenado_p
    where cd_cgc      = cd_cgc_p;

  end if;
end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_pessoa_jur_integracao ( cd_cgc_p text, cd_estab_p bigint, nm_usuario_p text, ds_razao_social_p text, nm_fantasia_p text, ds_nome_abrev_p text, cd_municipio_ibge_p text, cd_cep_p text, ds_endereco_p text, nr_endereco_p text, ds_complemento_p text, ds_bairro_p text, ds_municipio_p text, sg_estado_p text, nr_telefone_p text, nr_fax_p text, nr_inscricao_estadual_p text, nr_inscricao_municipal_p text, cd_internacional_p text, ds_site_internet_p text, cd_pf_resp_tecnico_p text, ds_orgao_reg_resp_tecnico_p text, nr_autor_func_p text, nr_alvara_sanitario_p text, nr_alvara_sanitario_munic_p text, nr_certificado_boas_prat_p text, cd_ans_p text, dt_validade_autor_func_p timestamp, dt_validade_alvara_sanit_p timestamp, dt_validade_cert_boas_prat_p timestamp, cd_cnes_p text, cd_referencia_fornec_p text, cd_sistema_ant_p text, ds_email_p text, dt_validade_resp_tecnico_p timestamp, nm_pessoa_contato_p text, nr_ramal_contato_p text, nr_registro_resp_tecnico_p text, qt_dia_prazo_entrega_p bigint, vl_minimo_nf_p bigint, dt_validade_alvara_munic_p timestamp, ds_resp_tecnico_p text, ie_situacao_p text, ie_status_apenado_p text) FROM PUBLIC;

