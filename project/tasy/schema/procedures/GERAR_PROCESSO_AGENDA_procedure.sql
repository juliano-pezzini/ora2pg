-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_processo_agenda (nr_seq_agenda_p bigint, cd_processo_p bigint, cd_setor_exclusivo_p bigint, nm_usuario_p text) AS $body$
DECLARE



nr_etapas_w				integer;
nr_seq_etapa_w				bigint;
ie_responsavel_w			varchar(3);
nr_minutos_prev_w			double precision;
cd_setor_resp_w				integer;
cd_pessoa_fisica_resp_w			varchar(10);
cd_cgc_resp_w				varchar(14);
nm_usuario_resp_w			varchar(15);
dt_fim_prev_w				timestamp;
nr_seq_processo_w			bigint;

C000 CURSOR FOR
	SELECT 	nr_sequencia,
		ie_responsavel,
		nr_minutos_prev,
		cd_setor_resp,
		cd_pessoa_fisica_resp,
		cd_cgc_resp,
		nm_usuario_resp
	from 	Processo_etapa
	where 	cd_processo 	= cd_processo_p;


BEGIN

begin
	select 	count(*)
	into STRICT 	nr_etapas_w
	from 	agenda_pac_processo
	where 	nr_seq_agenda	= nr_seq_agenda_p
	  and 	cd_processo	= cd_processo_p;
	exception
		when others then
			nr_etapas_w := 0;
end;

if (nr_etapas_w 	= 0) then
	begin
	OPEN C000;
	LOOP
	FETCH C000 INTO
		 	nr_seq_etapa_w,
			ie_responsavel_w,
			nr_minutos_prev_w,
			cd_setor_resp_w,
			cd_pessoa_fisica_resp_w,
			cd_cgc_resp_w,
			nm_usuario_resp_w;
	EXIT WHEN NOT FOUND; /* apply on c000 */
		begin
---------------------	Usuário
		if (ie_responsavel_w = '2') then
			nm_usuario_resp_w	:= nm_usuario_p;
		end if;
---------------------	Médico
		if (ie_responsavel_w = '3') then
			select	cd_medico
			into STRICT	cd_pessoa_fisica_resp_w
			from	agenda_paciente
			where	nr_sequencia = nr_seq_agenda_p;
		end if;
---------------------	Paciente
		if (ie_responsavel_w = '4') then
			select	cd_pessoa_fisica
			into STRICT 	cd_pessoa_fisica_resp_w
			from	agenda_paciente
			where	nr_sequencia = nr_seq_agenda_p;
		end if;
---------------------	Setor de Atendimento
		if (ie_responsavel_w = '5') then
			cd_setor_resp_w := cd_setor_exclusivo_p;
		end if;

		dt_fim_prev_w := clock_timestamp() + (nr_minutos_prev_w	/ 1440);

		select	nextval('agenda_pac_processo_seq')
		into STRICT	nr_seq_processo_w
		;

		insert into agenda_pac_processo(nr_sequencia,
			nr_seq_agenda,
			cd_processo,
			nr_seq_etapa,
			dt_atualizacao,
			nm_usuario,
			ie_status,
			nr_min_prev,
			dt_fim_prev,
			nm_usuario_resp,
			cd_pessoa_fisica_resp,
			cd_setor_resp)
		Values (nr_seq_processo_w,
			nr_seq_agenda_p,
			cd_processo_p,
			nr_seq_etapa_w,
			clock_timestamp(),
			nm_usuario_p,
			'P',
			nr_minutos_prev_w,
			dt_fim_prev_w,
			nm_usuario_resp_w,
			cd_pessoa_fisica_resp_w,
			cd_setor_resp_w);
		end;
	END LOOP;
	CLOSE C000;

	end;
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_processo_agenda (nr_seq_agenda_p bigint, cd_processo_p bigint, cd_setor_exclusivo_p bigint, nm_usuario_p text) FROM PUBLIC;

