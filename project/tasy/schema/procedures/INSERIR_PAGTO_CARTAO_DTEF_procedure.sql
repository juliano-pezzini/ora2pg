-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_pagto_cartao_dtef ( nr_seq_caixa_rec_p bigint, nr_seq_movto_cartao_p bigint, nr_seq_bandeira_p text, ie_tipo_cartao_p text, vl_transacao_p bigint, vl_desconto_operadora_p bigint, qt_parcela_p bigint, nr_autorizacao_p text, ds_nsu_dtef_p text, ds_nsu_bergs_p text, ds_compr_p text, dt_integracao_tef_p timestamp, cd_estabelecimento_p bigint, ds_arq_recibo_tef_p text, nm_usuario_p text, ie_tipo_operacao_p text) AS $body$
DECLARE


nr_seq_movto_w		bigint;
qt_bandeira_w		bigint;
nr_seq_bandeira_w	bigint;
nr_seq_trans_caixa_w	bigint;
nr_seq_forma_pagto_w	bigint;
qt_parcela_w		smallint;
ie_comprovante_tef_w	varchar(15);
ie_autorizacao_tef_w	varchar(15);
ds_comprovante_w	varchar(100);
nr_autorizacao_w	varchar(40);


BEGIN

select	count(*)
into STRICT	qt_bandeira_w
from	bandeira_cartao_cr
where	cd_dtef = nr_seq_bandeira_p;

if (qt_bandeira_w > 0) then
	
	select	max(nr_sequencia),
		coalesce(max(ie_comprovante_tef),'D'),
		coalesce(max(ie_autorizacao_tef),'A')
	into STRICT	nr_seq_bandeira_w,
		ie_comprovante_tef_w,
		ie_autorizacao_tef_w
	from	bandeira_cartao_cr
	where	cd_dtef	= nr_seq_bandeira_p;

	if (ie_comprovante_tef_w	= 'D') then
		ds_comprovante_w	:= ds_nsu_dtef_p;
	elsif (ie_comprovante_tef_w	= 'B') then
		ds_comprovante_w	:= ds_nsu_bergs_p;
	elsif (ie_comprovante_tef_w	= 'C') then
		ds_comprovante_w	:= ds_compr_p;
	end if;

	if (ie_autorizacao_tef_w	= 'A') then
		nr_autorizacao_w	:= nr_autorizacao_p;
	elsif (ie_autorizacao_tef_w	= 'D') then
		nr_autorizacao_w	:= ds_nsu_dtef_p;
	elsif (ie_autorizacao_tef_w	= 'B') then
		nr_autorizacao_w	:= ds_nsu_bergs_p;
	elsif (ie_autorizacao_tef_w	= 'C') then
		nr_autorizacao_w	:= ds_compr_p;
	end if;
	
	if (ie_tipo_cartao_p = 'C') then	
		select	max(nr_seq_trans_tef_credito)
		into STRICT	nr_seq_trans_caixa_w
		from	bandeira_cartao_estab
		where	nr_seq_bandeira = nr_seq_bandeira_w
		and 	cd_estabelecimento = cd_estabelecimento_p;
	else
		select	max(nr_seq_trans_tef_debito)
		into STRICT	nr_seq_trans_caixa_w
		from	bandeira_cartao_estab
		where	nr_seq_bandeira = nr_seq_bandeira_w
		and 	cd_estabelecimento = cd_estabelecimento_p;
	end if;
	if (coalesce(nr_seq_trans_caixa_w::text, '') = '') then
	
	if (ie_tipo_cartao_p = 'C') then
		select	max(nr_seq_trans_tef_credito)
		into STRICT	nr_seq_trans_caixa_w
		from	bandeira_cartao_cr
		where	nr_sequencia = nr_seq_bandeira_w;
	else
		select	max(nr_seq_trans_tef_debito)
		into STRICT	nr_seq_trans_caixa_w
		from	bandeira_cartao_cr
		where	nr_sequencia = nr_seq_bandeira_w;
    end if;
    end if;

	qt_parcela_w	:= coalesce(qt_parcela_p,0);

	if (qt_parcela_w	= 0) then

		qt_parcela_w	:= 1;

	end if;
	
	select	max(nr_seq_forma_pagto)
	into STRICT	nr_seq_forma_pagto_w
	from	forma_pagto_tef
	where	coalesce(ie_tipo_operacao,coalesce(ie_tipo_operacao_p,'0'))	= coalesce(ie_tipo_operacao_p,coalesce(ie_tipo_operacao,'0'))
	and	qt_parcela_w	between nr_parcela_inicio and nr_parcela_fim
	and	nr_seq_bandeira	= nr_seq_bandeira_w
	and	((ie_tipo_cartao	= ie_tipo_cartao_p) or (ie_tipo_cartao 	= 'A'));
	
	insert into movto_cartao_cr(
		nr_sequencia,
		nm_usuario,
		dt_atualizacao,
		nm_usuario_nrec,
		dt_atualizacao_nrec,
		cd_estabelecimento,
		dt_transacao,
		nr_seq_caixa_rec,
		nr_seq_bandeira,
		ie_tipo_cartao,
		vl_transacao,
		qt_parcela,
		nr_autorizacao,
		ds_comprovante,
		nr_seq_trans_caixa,
		nr_seq_forma_pagto,
		dt_integracao_tef,
		dt_confirmacao_tef,
		ie_situacao,
		ie_lib_caixa,
		dt_liberacao,
		ds_arq_recibo_tef,
		vl_desconto_operadora)
	values (nr_seq_movto_cartao_p,
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		cd_estabelecimento_p,
		clock_timestamp(),
		nr_seq_caixa_rec_p,
		nr_seq_bandeira_w,
		ie_tipo_cartao_p,
		vl_transacao_p,
		qt_parcela_w,
		nr_autorizacao_w,
		ds_comprovante_w,
		CASE WHEN nr_seq_trans_caixa_w=0 THEN null  ELSE nr_seq_trans_caixa_w END ,
		CASE WHEN nr_seq_forma_pagto_w=0 THEN  null  ELSE nr_seq_forma_pagto_w END ,
		clock_timestamp(),
		clock_timestamp(),
		'A',
		'N',
		clock_timestamp(),
		ds_arq_recibo_tef_p,
		coalesce(vl_desconto_operadora_p,0));

	CALL gerar_cartao_cr_parcela(nr_seq_movto_cartao_p,nm_usuario_p,null);

end if;

commit;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_pagto_cartao_dtef ( nr_seq_caixa_rec_p bigint, nr_seq_movto_cartao_p bigint, nr_seq_bandeira_p text, ie_tipo_cartao_p text, vl_transacao_p bigint, vl_desconto_operadora_p bigint, qt_parcela_p bigint, nr_autorizacao_p text, ds_nsu_dtef_p text, ds_nsu_bergs_p text, ds_compr_p text, dt_integracao_tef_p timestamp, cd_estabelecimento_p bigint, ds_arq_recibo_tef_p text, nm_usuario_p text, ie_tipo_operacao_p text) FROM PUBLIC;

