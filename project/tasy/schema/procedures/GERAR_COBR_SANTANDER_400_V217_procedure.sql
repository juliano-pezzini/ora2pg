-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cobr_santander_400_v217 (nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p text, nm_usuario_p text) AS $body$
DECLARE

/*Versão 2.17 do Manual Santander - Outubro/2017*/

ds_conteudo_w			varchar(400);
ds_zeros_16_w			varchar(16);
ds_mensagem_275_w		varchar(275);
nr_seq_reg_arq_w		integer := 0;
nm_empresa_w			varchar(30);
nm_banco_w			varchar(15);
dt_geracao_w			varchar(6);
cd_banco_san_w			varchar(3);
cd_transmissao_w		varchar(20);
ds_zeros_374_w			varchar(374);
ds_brancos_6_w			varchar(6);
ds_brancos_4_w			varchar(4);
cd_cgc_w			varchar(14);
cd_agencia_ced_w		varchar(4);
cd_conta_movto_w		varchar(8);
cd_conta_cobr_w			varchar(8);
nr_controle_w			varchar(25);
nr_nosso_numero_w		varchar(8);
dt_seg_desconto_w		varchar(6);
ie_multa_w			varchar(1);
pr_multa_w			varchar(4);
vl_moeda_w			varchar(2);
vl_tit_unidade_w		varchar(13);
dt_cobr_multa_w			varchar(6);
cd_carteira_w			varchar(1);
cd_ocorrencia_w			varchar(2);
nr_seu_numero_w			varchar(10);
dt_vencimento_w			varchar(6);
ds_vl_titulo_w			varchar(13);
vl_titulo_w			double precision;
cd_banco_w			varchar(3);
cd_agencia_w			varchar(5);
ie_documento_w			varchar(2);
ie_aceite_w			varchar(1);
dt_emissao_w			varchar(6);
ie_primeira_instr_w		varchar(2);
ie_segunda_intr_w		varchar(2);
vl_juros_diario_w		varchar(13);
dt_desconto_w			varchar(6);
vl_desconto_dia_w		varchar(13);
vl_iof_w			varchar(13);
vl_abatimento_w			varchar(13);
ie_tipo_inscricao_w		varchar(2);
nr_inscricao_w			varchar(14);
nm_sacado_w			varchar(40);
ds_endereco_sacado_w		varchar(40);
ds_bairro_sacado_w		varchar(12);
cd_cep_sacado_w			varchar(8);
ds_municipio_sacado_w		varchar(15);
ds_estado_sacado_w		varchar(2);
nm_sacador_w			varchar(30);
ie_complemento_w		varchar(1);
ds_complemento_w		varchar(2);
nr_dias_baixa_w			varchar(2);
vl_total_w			double precision := 0;
nr_sequencia_w			bigint;
qt_registro_w			integer :=0;

ds_mensagem_w			varchar(50);
nr_titulo_w			titulo_receber.nr_titulo%type;
cd_banco_titulo_w		banco_estabelecimento.cd_banco%type;
cd_agencia_cobradora_w		banco_estabelecimento.cd_agencia_bancaria%type;

C01 CURSOR FOR
SELECT	lpad(coalesce(to_char(c.cd_agencia_bancaria),'0'),4,'0') cd_agencia,
	lpad(substr(coalesce(d.cd_conta,coalesce(pls_obter_dados_pagador_fin(d.nr_seq_pagador,'C'),'0')),1,8),8,'0') cd_conta_movto,
	lpad(substr(coalesce(x.cd_conta,'0'),1,8),8,'0') cd_conta_cobr,
	lpad('0',25,'0')  nr_controle,
	lpad(coalesce(substr(obter_nosso_numero_interf(x.cd_banco,b.nr_titulo),1,8),'0'),8,'0') nr_nosso_numero,
	'000000' dt_seg_desconto,
	'0' ie_multa,
	'0000' pr_multa,
	'00' vl_moeda,
	replace(to_char(0, 'fm00000000000.00'),'.','') vl_tit_unidade,
	'000000' dt_cobr_multa,
	'1' cd_carteira,
	'01' cd_ocorrencia,
	rpad(coalesce(substr(b.nr_titulo,1,10),'0'),10,'0') nr_seu_numero, -- nr_titulo
	to_char(coalesce(b.dt_pagamento_previsto, b.dt_vencimento),'ddmmyy') dt_vencimento,
	coalesce(b.vl_titulo,0) vl_titulo,
	lpad(coalesce(substr(x.cd_banco,1,3),'0'),3,'0') cd_banco,
	lpad(coalesce(to_char(c.cd_agencia_bancaria),'0'),5,'0') cd_agencia,
	'01' ie_documento,
	'N' ie_aceite,
	lpad(coalesce(to_char(b.dt_emissao,'ddmmyy'),' '),6,' ') dt_emissao,
	'00' ie_primeira_instr,
	'00' ie_segunda_intr,
	lpad(replace(to_char(coalesce(obter_vl_juros_diario_tit(null,b.nr_titulo),0),'fm00000000000.00'),'.',''),13,'0') vl_juros_diario,
	to_char(clock_timestamp(),'ddmmyy') dt_desconto,
	lpad('0',13,'0') vl_desconto_dia,
	lpad('0',13,'0') vl_iof,
	lpad('0',13,'0') vl_abatimento,
	CASE WHEN coalesce(b.cd_cgc::text, '') = '' THEN '01'  ELSE '02' END  ie_tipo_inscricao,
	lpad(coalesce(b.cd_cgc_cpf,'0'),14,'0') nr_inscricao,
	rpad(upper(elimina_acentuacao(substr(coalesce(b.nm_pessoa,' '),1,40))),40,' ') nm_sacado,
	rpad(coalesce(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN 		obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'E')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'E') END ,1,40),
		substr(coalesce(obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'E'),' '),1,40)),40,' ') ds_endereco_sacado,
	rpad(coalesce(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN 		obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'B')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'B') END ,1,12),
		substr(coalesce(obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'B'),' '),1,12)),12,' ') ds_bairro_sacado,
	lpad(coalesce(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN 		obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CEP')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'CEP') END ,1,8),
		substr(coalesce(obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CEP'),'0'),1,8)),8,'0') cd_cep_sacado,
	rpad(coalesce(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN 		obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CI')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'CI') END ,1,15),
		substr(obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CI'),1,15)),15,' ') ds_municipio_sacado,
	rpad(coalesce(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN 		obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'UF')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'UF') END ,1,2),
		substr(coalesce(obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'UF'),' '),1,2)),2,' ') ds_estado_sacado,
	lpad(' ',30,' ') nm_sacador,
	'I' ie_complemento,
	'38' ds_complemento,
	'00' nr_dias_baixa,
	b.nr_titulo,
	x.cd_banco
FROM banco_estabelecimento x, titulo_receber_cobr c, cobranca_escritural a, titulo_receber_v b
LEFT OUTER JOIN pls_mensalidade d ON (b.nr_seq_mensalidade = d.nr_sequencia)
LEFT OUTER JOIN banco_carteira e ON (b.nr_seq_carteira_cobr = e.nr_sequencia)
LEFT OUTER JOIN pls_contrato_pagador f ON (d.nr_seq_pagador = f.nr_sequencia)
WHERE a.nr_sequencia		= c.nr_seq_cobranca and c.nr_titulo		= b.nr_titulo and a.nr_seq_conta_banco	= x.nr_sequencia    and a.nr_sequencia		= nr_seq_cobr_escrit_p;

c02 CURSOR FOR
SELECT	substr(obter_instrucao_boleto_pos(nr_titulo_w,cd_banco_titulo_w,a.nr_linha,'F',null,null),1,50) ds_mensagem
from	banco_instrucao_boleto a
where 	coalesce(a.ie_aplicacao_mensagem,'T')	= 'T'
and	a.cd_banco				= cd_banco_titulo_w
order by	a.nr_linha;


BEGIN
delete from w_envio_banco where nm_usuario = nm_usuario_p;

select	rpad('0',16,'0'),
	rpad(' ',275,' '),
	rpad('0',374,'0'),
	rpad(' ',6,' '),
	rpad(' ',4,' ')
into STRICT	ds_zeros_16_w,
	ds_mensagem_275_w,
	ds_zeros_374_w,
	ds_brancos_6_w,
	ds_brancos_4_w
;

/* Header */

select	rpad(substr(obter_nome_pf_pj(null,b.cd_cgc),1,30),30,' ') nm_empresa,
	rpad(substr(obter_nome_banco(c.cd_banco),1,15),15,' ') nm_banco,
	to_char(clock_timestamp(), 'ddmmyy') dt_geracao,
	lpad(substr(c.cd_banco,1,3),3,'0') cd_banco,
	rpad(coalesce(substr(c.cd_transmissao,1,20),' '),20,' ') cd_transmissao,
	lpad(substr(b.cd_cgc,1,14),14,'0') cd_cgc,
	c.cd_agencia_bancaria
into STRICT	nm_empresa_w,
	nm_banco_w,
	dt_geracao_w,
	cd_banco_san_w,
	cd_transmissao_w,
	cd_cgc_w,
	cd_agencia_cobradora_w
FROM banco_estabelecimento c, estabelecimento b, cobranca_escritural a
LEFT OUTER JOIN banco_carteira d ON (a.nr_seq_carteira_cobr = d.nr_sequencia)
WHERE a.cd_estabelecimento	= b.cd_estabelecimento and a.nr_seq_conta_banco	= c.nr_sequencia  and a.nr_sequencia		= nr_seq_cobr_escrit_p;

nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;

ds_conteudo_w	:=	'01REMESSA01COBRANÇA       '	||
			cd_transmissao_w		||
			nm_empresa_w 			||
			cd_banco_san_w 			||
			nm_banco_w			||
			dt_geracao_w			||
			ds_zeros_16_w			||
			ds_mensagem_275_w		||
			'000'				||
			lpad(nr_seq_reg_arq_w,6,'0');

select	nextval('w_envio_banco_seq')
into STRICT	nr_sequencia_w
;

insert into w_envio_banco(	nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_estabelecimento,
		ds_conteudo,
		nr_seq_apres)
values (	nr_sequencia_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_p,
		ds_conteudo_w,
		1);

/* Fim Header  */

/* Registro */

open C01;
loop
fetch C01 into
	cd_agencia_ced_w,
	cd_conta_movto_w,
	cd_conta_cobr_w,
	nr_controle_w,
	nr_nosso_numero_w,
	dt_seg_desconto_w,
	ie_multa_w,
	pr_multa_w,
	vl_moeda_w,
	vl_tit_unidade_w,
	dt_cobr_multa_w,
	cd_carteira_w,
	cd_ocorrencia_w,
	nr_seu_numero_w,
	dt_vencimento_w,
	vl_titulo_w,
	cd_banco_w,
	cd_agencia_w,
	ie_documento_w,
	ie_aceite_w,
	dt_emissao_w,
	ie_primeira_instr_w,
	ie_segunda_intr_w,
	vl_juros_diario_w,
	dt_desconto_w,
	vl_desconto_dia_w,
	vl_iof_w,
	vl_abatimento_w,
	ie_tipo_inscricao_w,
	nr_inscricao_w,
	nm_sacado_w,
	ds_endereco_sacado_w,
	ds_bairro_sacado_w,
	cd_cep_sacado_w,
	ds_municipio_sacado_w,
	ds_estado_sacado_w,
	nm_sacador_w,
	ie_complemento_w,
	ds_complemento_w,
	nr_dias_baixa_w,
	nr_titulo_w,
	cd_banco_titulo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;

	ds_vl_titulo_w	:= lpad(replace(to_char(vl_titulo_w,'fm00000000000.00'),'.',''),13,'0');

	ds_conteudo_w	:=	'102' 			||
				cd_cgc_w		||
				cd_agencia_ced_w 	|| --18 21
				cd_conta_movto_w 	|| --22 29
				cd_conta_cobr_w 	|| --30 37
				nr_controle_w		||
				nr_nosso_numero_w	||
				dt_seg_desconto_w	||
				' '			||
				ie_multa_w		||
				pr_multa_w		||
				vl_moeda_w		||
				vl_tit_unidade_w	||
				ds_brancos_4_w		|| --98
				dt_cobr_multa_w		|| --102
				cd_carteira_w		||
				cd_ocorrencia_w		||
				nr_seu_numero_w		||
				dt_vencimento_w		||
				ds_vl_titulo_w		||
				cd_banco_w		||
				cd_agencia_cobradora_w	||
				ie_documento_w		||
				ie_aceite_w		||
				dt_emissao_w		||
				ie_primeira_instr_w	||
				ie_segunda_intr_w	||
				vl_juros_diario_w	||
				dt_desconto_w		||
				vl_desconto_dia_w	||
				vl_iof_w		||
				vl_abatimento_w		||
				ie_tipo_inscricao_w	||
				nr_inscricao_w		||
				nm_sacado_w		||
				ds_endereco_sacado_w	||
				ds_bairro_sacado_w	||
				cd_cep_sacado_w		||
				ds_municipio_sacado_w	||
				ds_estado_sacado_w	||
				nm_sacador_w		||
				' '			||
				ie_complemento_w	||
				ds_complemento_w	||
				ds_brancos_6_w		||
				nr_dias_baixa_w		||
				' '			||
				lpad(nr_seq_reg_arq_w,6,'0');

	select	nextval('w_envio_banco_seq')
	into STRICT	nr_sequencia_w
	;

	insert into w_envio_banco(	nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_estabelecimento,
			ds_conteudo,
			nr_seq_apres)
	values (	nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_estabelecimento_p,
			ds_conteudo_w,
			2);
	end;

	vl_total_w := coalesce(vl_total_w,0) + coalesce(vl_titulo_w,0);
	qt_registro_w := qt_registro_w + 1;

	/*inicio no cursor c02  - mensagens*/

	open	c02;
	loop
	fetch 	C02 into
		ds_mensagem_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */

		nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;

		ds_conteudo_w	:= 	'2' ||
					rpad(' ',16,' ') ||
					lpad(cd_transmissao_w, 20,'0') ||
					rpad(' ',10,' ') ||
					'01' ||
					rpad(ds_mensagem_w, 50, ' ') ||
					rpad(' ', 283, ' ') ||
					rpad(' ', 1, ' ') ||
					lpad('0', 2, '0') ||
					rpad(' ', 9, ' ') ||
					lpad(nr_seq_reg_arq_w, 6, '0');

		insert	into w_envio_banco(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			cd_estabelecimento,
			ds_conteudo,
			nr_seq_apres)
		VALUES (nextval('w_envio_banco_seq'),
			clock_timestamp(),
			nm_usuario_p,
			cd_estabelecimento_p,
			ds_conteudo_w,
			nr_seq_reg_arq_w);
	end loop;
	close c02;
	/*Fim do cusor c02*/

end loop;
close C01;
/* Fim Registro */

/* Trailler */

begin
nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;

ds_conteudo_w	:=	'9' 				||
			lpad(coalesce(qt_registro_w,0) + 2,6,'0')	||
			lpad(replace(to_char(vl_total_w,'fm000000000.99'),'.',''),13,'0')		||
			ds_zeros_374_w			||
			lpad(nr_seq_reg_arq_w,6,'0');

select	nextval('w_envio_banco_seq')
into STRICT	nr_sequencia_w
;

insert into w_envio_banco(	nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_estabelecimento,
		ds_conteudo,
		nr_seq_apres)
values (	nr_sequencia_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_p,
		ds_conteudo_w,
		3);

end;
/* Fim Trailler */

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cobr_santander_400_v217 (nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p text, nm_usuario_p text) FROM PUBLIC;

