-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_result_compra ( cd_estabelecimento_p bigint, dt_mesano_referencia_p timestamp, cd_grupo_material_p bigint, nm_usuario_p text, ie_tipo_material_p bigint, ie_curva_abc_p text, cd_fornecedor_p text) AS $body$
DECLARE

 
cd_categoria_w		bigint;
cd_convenio_w			integer;
cd_material_w			integer;
ds_comando_w			varchar(4000);
ie_regra_custo_mat_w		smallint;
pr_aumento_ident_w		double precision;
pr_result_compra_w		double precision;
qt_consumo_mensal_w		double precision;
vl_acum_periodo_w		double precision;
vl_custo_medio_w		double precision;
vl_custo_medio_total_w	double precision;
vl_custo_padrao_w		double precision;
vl_regra_custo_mat_w		double precision;
vl_resultado_compra_w	double precision;
vl_ultima_compra_w		double precision;

 
 
C01 CURSOR FOR 
SELECT	e.cd_material, 
	coalesce(obter_consumo_mensal_material('Q',cd_estabelecimento_p, a.cd_material_estoque,dt_mesano_referencia_p),0), 
	coalesce(obter_custo_medio_material(cd_estabelecimento_p,dt_mesano_referencia_p,a.cd_material_estoque),0), 
	coalesce(obter_valor_ultima_compra(cd_estabelecimento_p,90,a.cd_material,null,'N'),0) 
from	material a, 
	estrutura_material_v e 
where	a.cd_material = e.cd_material 
and (ie_tipo_material_p = 0 or a.ie_tipo_material = ie_tipo_material_p) 
and (ie_curva_abc_p = 'T' or substr(obter_curva_abc_estab(cd_estabelecimento_p, a.cd_material,'S', dt_mesano_referencia_p),1,1) = ie_curva_abc_p) 
and	e.cd_grupo_material = cd_grupo_material_p 
and	(((exists (SELECT	1 
		from	fornecedor_mat_consignado x 
		where	x.cd_material = a.cd_material_estoque 
		and	x.dt_mesano_referencia = dt_mesano_referencia_p 
		and	x.cd_fornecedor = cd_fornecedor_p)) and (cd_fornecedor_p IS NOT NULL AND cd_fornecedor_p::text <> '')) or (coalesce(cd_fornecedor_p::text, '') = '')) 
and	exists ( 
		select	1 
		from	nota_fiscal n, 
			nota_fiscal_item i 
		where	n.nr_sequencia = i.nr_sequencia 
		and	(n.dt_atualizacao_estoque IS NOT NULL AND n.dt_atualizacao_estoque::text <> '') 
		and	n.ie_situacao = 1 
		and	i.cd_material = a.cd_material 
		and	trunc(n.dt_entrada_saida,'mm') = dt_mesano_referencia_p);


BEGIN 
 
CALL Exec_sql_Dinamico('Tasy', 'drop table sup_w_result_compra');
CALL Exec_sql_Dinamico('Tasy','create table sup_w_result_compra(cd_material			number(6))');
CALL Exec_sql_Dinamico('Tasy','alter table sup_w_result_compra add cd_estabelecimento		number(4)');
CALL Exec_sql_Dinamico('Tasy','alter table sup_w_result_compra add qt_consumo_mensal		number(15,4)');
CALL Exec_sql_Dinamico('Tasy','alter table sup_w_result_compra add vl_custo_medio		number(15,4)');
CALL Exec_sql_Dinamico('Tasy','alter table sup_w_result_compra add vl_ultima_compra		number(15,4)');
CALL Exec_sql_Dinamico('Tasy','alter table sup_w_result_compra add vl_custo_medio_total		number(15,4)');
CALL Exec_sql_Dinamico('Tasy','alter table sup_w_result_compra add vl_custo_padrao		number(22,4)');
CALL Exec_sql_Dinamico('Tasy','alter table sup_w_result_compra add pr_result_compra		number(13,4)');
CALL Exec_sql_Dinamico('Tasy','alter table sup_w_result_compra add vl_result_compra		number(15,4)');
CALL Exec_sql_Dinamico('Tasy','alter table sup_w_result_compra add pr_aumento_ident		number(13,4)');
CALL Exec_sql_Dinamico('Tasy','alter table sup_w_result_compra add vl_acum_periodo		number(15,4)');
CALL Exec_sql_Dinamico('Tasy','alter table sup_w_result_compra add nm_usuario			varchar2(15)');
CALL Exec_sql_Dinamico('Tasy','alter table sup_w_result_compra add dt_atualizacao		date');
 
open C01;
loop 
	fetch C01 into 
		cd_material_w, 
		qt_consumo_mensal_w, 
		vl_custo_medio_w, 
		vl_ultima_compra_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	vl_custo_medio_total_w := (qt_consumo_mensal_w * vl_custo_medio_w);
	SELECT * FROM obter_convenio_particular(cd_estabelecimento_p, cd_convenio_w, cd_categoria_w) INTO STRICT cd_convenio_w, cd_categoria_w;
 
	select	obter_regra_custo_padrao_mat(cd_material_w, cd_estabelecimento_p, 'R'), 
		obter_regra_custo_padrao_mat(cd_material_w, cd_estabelecimento_p, 'V') 
	into STRICT	ie_regra_custo_mat_w, 
		vl_regra_custo_mat_w 
	;
	vl_custo_padrao_w	:= 0;
 
	if (ie_regra_custo_mat_w = 0) then 
		select	obter_brasindice_preco( 
				cd_estabelecimento_p, 
				cd_convenio_w, 
				cd_categoria_w, 
				cd_material_w, 
				dt_mesano_referencia_p, 
				0) 
	into STRICT	vl_custo_padrao_w 
	;
	elsif (ie_regra_custo_mat_w = 1) then 
		vl_custo_padrao_w	:= 0;
	elsif (ie_regra_custo_mat_w = 2) then 
		select	obter_valor_ultima_compra( 
				cd_estabelecimento_p, 
				null, 
				cd_material_w, 
				null, 
				'E') 
		into STRICT	vl_custo_padrao_w 
		;
	elsif (ie_regra_custo_mat_w = 3) then 
		select	obter_custo_medio_material( 
				cd_estabelecimento_p, 
				trunc(dt_mesano_referencia_p,'month'), 
				cd_material_w) 
		into STRICT	vl_custo_padrao_w 
		;
	elsif (ie_regra_custo_mat_w = 4) then 
		vl_custo_padrao_w	:= vl_regra_custo_mat_w;
	end if;
 
	pr_result_compra_w		:= round((obter_variacao_entre_valor(vl_ultima_compra_w,vl_custo_padrao_w))::numeric,1);
	vl_resultado_compra_w	:= ((vl_custo_padrao_w - vl_ultima_compra_w) * qt_consumo_mensal_w);
	pr_aumento_ident_w		:= round((obter_variacao_entre_valor(vl_custo_medio_w,vl_ultima_compra_w))::numeric,1);
	vl_acum_periodo_w		:= ((vl_ultima_compra_w - vl_custo_medio_w) * qt_consumo_mensal_w);
 
	ds_comando_w := 'insert into sup_w_result_compra( 
				cd_material, 
				cd_estabelecimento, 
				qt_consumo_mensal, 
				vl_custo_medio, 
				vl_ultima_compra, 
				vl_custo_medio_total, 
				vl_custo_padrao, 
				pr_result_compra, 
				vl_result_compra, 
				pr_aumento_ident, 
				vl_acum_periodo, 
				nm_usuario, 
				dt_atualizacao) 
			values	(' || cd_material_w				|| ',' || 
		 		cd_estabelecimento_p				|| ',' || 
		 		replace(coalesce(qt_consumo_mensal_w,0),',','.') 	|| ',' || 
		 		replace(coalesce(vl_custo_medio_w,0),',','.')		|| ',' || 
		 		replace(coalesce(vl_ultima_compra_w,0),',','.') 	|| ',' || 
		 		replace(coalesce(vl_custo_medio_total_w,0),',','.')	|| ',' || 
		 		replace(coalesce(vl_custo_padrao_w,0),',','.')		|| ',' || 
		 		replace(coalesce(pr_result_compra_w,0),',','.')	|| ',' || 
				replace(coalesce(vl_resultado_compra_w,0),',','.')	|| ',' || 
				replace(coalesce(pr_aumento_ident_w,0),',','.')	|| ',' || 
				replace(coalesce(vl_acum_periodo_w,0),',','.')		|| ',' || 
				chr(39) || nm_usuario_p || chr(39)		|| ',' || 
				'sysdate)';
	CALL Exec_sql_Dinamico('Tasy',ds_comando_w);	
end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_result_compra ( cd_estabelecimento_p bigint, dt_mesano_referencia_p timestamp, cd_grupo_material_p bigint, nm_usuario_p text, ie_tipo_material_p bigint, ie_curva_abc_p text, cd_fornecedor_p text) FROM PUBLIC;

