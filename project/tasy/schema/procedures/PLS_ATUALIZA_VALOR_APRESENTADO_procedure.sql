-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualiza_valor_apresentado ( nr_seq_lote_conta_p pls_lote_protocolo_conta.nr_sequencia%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_processo_p pls_cta_lote_processo.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type default null) AS $body$
DECLARE


tb_vl_unitario_imp_w    	dbms_sql.number_table;
tb_vl_procedimento_w    	dbms_sql.number_table;
tb_seq_procedimento_w   	dbms_sql.number_table;
tb_vl_material_w      		dbms_sql.number_table;
tb_seq_material_w      		dbms_sql.number_table;
nr_indexador_w        		integer;
ie_atualiza_val_apres_w   	pls_regra_val_apres.ie_atualiza_val_apres%type;
ie_atualizar_valor_apresent_w  	pls_parametros.ie_atualizar_valor_apresent%type;
ie_regra_valida_w      		varchar(1);
ie_val_apres_conta_princ_w  	pls_regra_val_apres.ie_val_apres_conta_princ%type;
pr_proporcao_w        		double precision;
ie_manter_vl_apresentado_w  	pls_parametros.ie_manter_vl_apresentado%type;
ie_atual_vl_apres_e_mantem_w	pls_parametros.ie_atualiza_vl_apres_e_mantem%type;

C01 CURSOR(  	nr_seq_lote_pc    	pls_lote_protocolo_conta.nr_sequencia%type,
		nr_seq_protocolo_pc  	pls_protocolo_conta.nr_sequencia%type,
		nr_seq_lote_processo_pc pls_cta_lote_processo.nr_sequencia%type,
		nr_seq_conta_pc    	pls_conta.nr_sequencia%type,
		nr_seq_conta_proc_pc  	pls_conta_proc.nr_sequencia%type,
		cd_estabelecimento_pc  	estabelecimento.cd_estabelecimento%type) FOR

	SELECT  a.nr_sequencia,
		a.vl_procedimento,
		a.qt_procedimento_imp,
		(SELECT max(ie_atualiza_val_apres)
		from  pls_regra_val_apres b
		where  b.ie_origem_protocolo = a.ie_origem_protocolo
		and  ie_situacao = 'A'
		and  cd_estabelecimento = cd_estabelecimento_pc) ie_atualiza_val_apres,
		(  select   coalesce(min(ie_gerada_cta_hon),'A')
		from  pls_regra_val_apres b
		where  b.ie_origem_protocolo = a.ie_origem_protocolo
		and    ie_situacao = 'A'
		and    coalesce(ie_gerada_cta_hon,'A') in ('A','S')
		and    cd_estabelecimento = cd_estabelecimento_pc) ie_gerada_cta_hon,
		(  select   max(vl_procedimento)
		from   pls_conta_proc b
		where   b.nr_sequencia = a.nr_seq_proc_ref) vl_calc_proc_princ,
		(  select  max(vl_participante)
		from  pls_proc_participante
		where  nr_sequencia = nr_seq_participante_hi) vl_participante,
		nr_seq_regra_conta_auto,
		(   select   max(coalesce(nr_lote_contabil_prov,0))
		from  pls_conta_medica_resumo x
		where   nr_seq_conta = a.nr_seq_conta
		and    nr_seq_conta_proc = a.nr_sequencia) nr_lote_contabil,
		nr_lote_contabil_prov,
		a.ie_origem_conta,
		a.vl_procedimento_imp,
		(	select	coalesce(max(x.ie_a520), 'N')
			from	pls_conta_proc_regra	x
			where	x.nr_sequencia		= a.nr_sequencia) ie_a520,
		a.dt_fim_consistencia
	from  	pls_conta_proc_v a
	where   a.nr_sequencia = nr_seq_conta_proc_pc
	and     ((a.vl_procedimento_imp    = 0) or (ie_vl_apresentado_sistema = 'S') or
		 (a.ie_vl_apres_sist_regra = 'S' AND  ie_atual_vl_apres_e_mantem_w = 'S'))
	and	a.vl_procedimento 	> 0
	
union all

	select  a.nr_sequencia,
		a.vl_procedimento,
		a.qt_procedimento_imp,
		(  select max(ie_atualiza_val_apres)
		from  pls_regra_val_apres b
		where  b.ie_origem_protocolo = a.ie_origem_protocolo
		and    ie_situacao = 'A'
		and    cd_estabelecimento = cd_estabelecimento_pc) ie_atualiza_val_apres,
		(  select   coalesce(min(ie_gerada_cta_hon),'A')
		from  pls_regra_val_apres b
		where  b.ie_origem_protocolo = a.ie_origem_protocolo
		and    ie_situacao = 'A'
		and    coalesce(ie_gerada_cta_hon,'A') in ('A','S')
		and    cd_estabelecimento = cd_estabelecimento_pc) ie_gerada_cta_hon,
		(  select   vl_procedimento
		from  pls_conta_proc b
		where  b.nr_sequencia = a.nr_seq_proc_ref) vl_calc_proc_princ,
		(  select  max(vl_participante)
		from  pls_proc_participante
		where  nr_sequencia = nr_seq_participante_hi) vl_participante,
		nr_seq_regra_conta_auto,
		(   select   max(coalesce(nr_lote_contabil_prov,0))
		from  pls_conta_medica_resumo x
		where   nr_seq_conta = a.nr_seq_conta
		and    nr_seq_conta_proc = a.nr_sequencia) nr_lote_contabil,
		nr_lote_contabil_prov,
		a.ie_origem_conta,
		a.vl_procedimento_imp,
		(	select	coalesce(max(x.ie_a520), 'N')
			from	pls_conta_proc_regra	x
			where	x.nr_sequencia		= a.nr_sequencia) ie_a520,
		a.dt_fim_consistencia
	from  	pls_conta_proc_v a
	where  	a.nr_seq_conta = nr_seq_conta_pc
	and    	coalesce(nr_seq_conta_proc_pc::text, '') = ''
	and     ((a.vl_procedimento_imp    = 0) or (ie_vl_apresentado_sistema = 'S') or
		(a.ie_vl_apres_sist_regra = 'S' AND  ie_atual_vl_apres_e_mantem_w = 'S'))
	and	a.vl_procedimento 	> 0
	
union all

	select  a.nr_sequencia,
		a.vl_procedimento,
		a.qt_procedimento_imp,
		(  select   max(ie_atualiza_val_apres)
		from  pls_regra_val_apres b
		where  b.ie_origem_protocolo = a.ie_origem_protocolo
		and    ie_situacao = 'A'
		and    cd_estabelecimento = cd_estabelecimento_pc) ie_atualiza_val_apres,
		(  select   coalesce(min(ie_gerada_cta_hon),'A')
		from  pls_regra_val_apres b
		where  b.ie_origem_protocolo = a.ie_origem_protocolo
		and    ie_situacao = 'A'
		and    coalesce(ie_gerada_cta_hon,'A') in ('A','S')
		and    cd_estabelecimento = cd_estabelecimento_pc) ie_gerada_cta_hon,
		(  select   vl_procedimento
		from  pls_conta_proc b
		where  b.nr_sequencia = a.nr_seq_proc_ref) vl_calc_proc_princ,
		(  select  max(vl_participante)
		from  pls_proc_participante
		where  nr_sequencia = nr_seq_participante_hi) vl_participante,
		nr_seq_regra_conta_auto,
		(   select   max(coalesce(nr_lote_contabil_prov,0))
		from  pls_conta_medica_resumo x
		where   nr_seq_conta = a.nr_seq_conta
		and    nr_seq_conta_proc = a.nr_sequencia) nr_lote_contabil,
		nr_lote_contabil_prov,
		a.ie_origem_conta,
		a.vl_procedimento_imp,
		(	select	coalesce(max(x.ie_a520), 'N')
			from	pls_conta_proc_regra	x
			where	x.nr_sequencia		= a.nr_sequencia) ie_a520,
		a.dt_fim_consistencia
	from  	pls_conta_proc_v a
	where  	a.nr_seq_protocolo = nr_seq_protocolo_pc
	and    	coalesce(nr_seq_conta_pc::text, '') = ''
	and    	coalesce(nr_seq_conta_proc_pc::text, '') = ''
	and     ((a.vl_procedimento_imp    = 0) or (ie_vl_apresentado_sistema = 'S') or
		(a.ie_vl_apres_sist_regra = 'S' AND  ie_atual_vl_apres_e_mantem_w = 'S'))
	and	a.vl_procedimento 	> 0
	
union all

	select  a.nr_sequencia,
		a.vl_procedimento,
		a.qt_procedimento_imp,
		(  select   max(ie_atualiza_val_apres)
		from  pls_regra_val_apres b
		where  b.ie_origem_protocolo = a.ie_origem_protocolo
		and    ie_situacao = 'A'
		and    cd_estabelecimento = cd_estabelecimento_pc) ie_atualiza_val_apres,
		(  select   coalesce(min(ie_gerada_cta_hon),'A')
		from  pls_regra_val_apres b
		where  b.ie_origem_protocolo = a.ie_origem_protocolo
		and    ie_situacao = 'A'
		and    coalesce(ie_gerada_cta_hon,'A') in ('A','S')
		and    cd_estabelecimento = cd_estabelecimento_pc) ie_gerada_cta_hon,
		(  select   vl_procedimento
		from  pls_conta_proc b
		where  b.nr_sequencia = a.nr_seq_proc_ref) vl_calc_proc_princ,
		(  select  max(vl_participante)
		from  pls_proc_participante
		where  nr_sequencia = nr_seq_participante_hi) vl_participante,
		nr_seq_regra_conta_auto,
		(   select   max(coalesce(nr_lote_contabil_prov,0))
		from  pls_conta_medica_resumo x
		where   nr_seq_conta = a.nr_seq_conta
		and    nr_seq_conta_proc = a.nr_sequencia) nr_lote_contabil,
		nr_lote_contabil_prov,
		a.ie_origem_conta,
		a.vl_procedimento_imp,
		(	select	coalesce(max(x.ie_a520), 'N')
			from	pls_conta_proc_regra	x
			where	x.nr_sequencia		= a.nr_sequencia) ie_a520,
		a.dt_fim_consistencia
	from  	pls_conta_proc_v a
	where  	a.nr_seq_lote_conta = nr_seq_lote_pc
	and    	coalesce(nr_seq_conta_proc_pc::text, '') = ''
	and    	coalesce(nr_seq_conta_pc::text, '') = ''
	and    	coalesce(nr_seq_protocolo_pc::text, '') = ''
	and    	((a.vl_procedimento_imp    = 0) or (ie_vl_apresentado_sistema = 'S') or
		(a.ie_vl_apres_sist_regra = 'S' AND  ie_atual_vl_apres_e_mantem_w = 'S'))
	and	a.vl_procedimento 	> 0
	
union all

	select  a.nr_sequencia,
		a.vl_procedimento,
		a.qt_procedimento_imp,
		(  select   max(ie_atualiza_val_apres)
		from  pls_regra_val_apres b
		where  b.ie_origem_protocolo = a.ie_origem_protocolo
		and    ie_situacao = 'A'
		and    cd_estabelecimento = cd_estabelecimento_pc) ie_atualiza_val_apres,
		(  select   coalesce(min(ie_gerada_cta_hon),'A')
		from  pls_regra_val_apres b
		where  b.ie_origem_protocolo = a.ie_origem_protocolo
		and    ie_situacao = 'A'
		and    coalesce(ie_gerada_cta_hon,'A') in ('A','S')
		and    cd_estabelecimento = cd_estabelecimento_pc) ie_gerada_cta_hon,
		(  select   vl_procedimento
		from   pls_conta_proc b
		where   b.nr_sequencia = a.nr_seq_proc_ref) vl_calc_proc_princ,
		(  select    max(vl_participante)
		from    pls_proc_participante
		where    nr_sequencia = nr_seq_participante_hi) vl_participante,
		nr_seq_regra_conta_auto,
		(   select   max(coalesce(nr_lote_contabil_prov,0))
		from  pls_conta_medica_resumo x
		where   nr_seq_conta = a.nr_seq_conta
		and    nr_seq_conta_proc = a.nr_sequencia) nr_lote_contabil,
		nr_lote_contabil_prov,
		a.ie_origem_conta,
		a.vl_procedimento_imp,
		(	select	coalesce(max(x.ie_a520), 'N')
			from	pls_conta_proc_regra	x
			where	x.nr_sequencia		= a.nr_sequencia) ie_a520,
		a.dt_fim_consistencia
	from  	pls_conta_proc_v a
	where  	coalesce(nr_seq_conta_pc::text, '') = ''
	and  	coalesce(nr_seq_conta_proc_pc::text, '') = ''
	and  	coalesce(nr_seq_protocolo_pc::text, '') = ''
	and  	coalesce(nr_seq_lote_pc::text, '') = ''
	and     ((a.vl_procedimento_imp    = 0) or (ie_vl_apresentado_sistema = 'S') or
		(a.ie_vl_apres_sist_regra = 'S' AND  ie_atual_vl_apres_e_mantem_w = 'S'))
	and	a.vl_procedimento 	> 0
	and  	exists (  select  1
			from  pls_cta_lote_proc_conta p
			where  p.nr_seq_lote_processo = nr_seq_lote_processo_pc
			and    p.nr_seq_conta = a.nr_seq_conta);

C02 CURSOR(  nr_seq_lote_pc    	pls_lote_protocolo_conta.nr_sequencia%type,
	nr_seq_protocolo_pc  	pls_protocolo_conta.nr_sequencia%type,
	nr_seq_lote_processo_pc pls_cta_lote_processo.nr_sequencia%type,
	nr_seq_conta_pc    	pls_conta.nr_sequencia%type,
	nr_seq_conta_mat_pc  	pls_conta_mat.nr_sequencia%type,
	cd_estabelecimento_pc  	estabelecimento.cd_estabelecimento%type) FOR

	SELECT  a.nr_sequencia,
		a.vl_material,
		a.qt_material_imp,
		(  SELECT   max(ie_atualiza_val_apres)
		from  pls_regra_val_apres b
		where  b.ie_origem_protocolo = a.ie_origem_protocolo
		and    ie_situacao = 'A'
		and    cd_estabelecimento = cd_estabelecimento_pc) ie_atualiza_val_apres,
		(  select  coalesce(min(ie_gerada_cta_hon),'A')
		from  pls_regra_val_apres b
		where  b.ie_origem_protocolo = a.ie_origem_protocolo
		and    ie_situacao = 'A'
		and    coalesce(ie_gerada_cta_hon,'A') in ('A','S')
		and    cd_estabelecimento = cd_estabelecimento_pc) ie_gerada_cta_hon,
		nr_seq_regra_conta_auto,
		(   select   max(coalesce(nr_lote_contabil_prov,0))
		from  pls_conta_medica_resumo x
		where   nr_seq_conta = a.nr_seq_conta
		and    nr_seq_conta_mat = a.nr_sequencia) nr_lote_contabil,
		nr_lote_contabil_prov,
		a.ie_origem_conta,
		a.vl_material_imp,
		(	select	coalesce(max(x.ie_a520), 'N')
			from	pls_conta_mat_regra	x
			where	x.nr_sequencia		= a.nr_sequencia) ie_a520,
		a.dt_fim_consistencia
	from   	pls_conta_mat_v a
	where   a.nr_sequencia = nr_seq_conta_mat_pc
	and     ((a.vl_material_imp    = 0) or (ie_vl_apresentado_sistema = 'S') or
		(a.ie_vl_apres_sist_regra = 'S' AND  ie_atual_vl_apres_e_mantem_w = 'S'))
	and	a.vl_material > 0
	
union all

	select  a.nr_sequencia,
		a.vl_material,
		a.qt_material_imp,
		(  select   max(ie_atualiza_val_apres)
		from  pls_regra_val_apres b
		where  b.ie_origem_protocolo = a.ie_origem_protocolo
		and    ie_situacao = 'A'
		and    cd_estabelecimento = cd_estabelecimento_pc) ie_atualiza_val_apres,
		(  select   coalesce(min(ie_gerada_cta_hon),'A')
		from  pls_regra_val_apres b
		where  b.ie_origem_protocolo = a.ie_origem_protocolo
		and    ie_situacao = 'A'
		and    coalesce(ie_gerada_cta_hon,'A') in ('A','S')
		and    cd_estabelecimento = cd_estabelecimento_pc) ie_gerada_cta_hon,
		nr_seq_regra_conta_auto,
		(   select   max(coalesce(nr_lote_contabil_prov,0))
		from  pls_conta_medica_resumo x
		where   nr_seq_conta = a.nr_seq_conta
		and    nr_seq_conta_mat = a.nr_sequencia) nr_lote_contabil,
		nr_lote_contabil_prov,
		a.ie_origem_conta,
		a.vl_material_imp,
		(	select	coalesce(max(x.ie_a520), 'N')
			from	pls_conta_mat_regra	x
			where	x.nr_sequencia		= a.nr_sequencia) ie_a520,
		a.dt_fim_consistencia
	from  	pls_conta_mat_v a
	where  	a.nr_seq_conta = nr_seq_conta_pc
	and    	coalesce(nr_seq_conta_mat_pc::text, '') = ''
	and     ((a.vl_material_imp    = 0) or (ie_vl_apresentado_sistema = 'S') or
		(a.ie_vl_apres_sist_regra = 'S' AND  ie_atual_vl_apres_e_mantem_w = 'S'))
	and	a.vl_material > 0
	
union all

	select  a.nr_sequencia,
		a.vl_material,
		a.qt_material_imp,
		(  select max(ie_atualiza_val_apres)
		from  pls_regra_val_apres b
		where  b.ie_origem_protocolo = a.ie_origem_protocolo
		and  ie_situacao = 'A'
		and  cd_estabelecimento = cd_estabelecimento_pc) ie_atualiza_val_apres,
		(  select coalesce(min(ie_gerada_cta_hon),'A')
		from  pls_regra_val_apres b
		where  b.ie_origem_protocolo = a.ie_origem_protocolo
		and    ie_situacao = 'A'
		and  coalesce(ie_gerada_cta_hon,'A') in ('A','S')
		and    cd_estabelecimento = cd_estabelecimento_pc) ie_gerada_cta_hon,
		nr_seq_regra_conta_auto,
		(   select   max(coalesce(nr_lote_contabil_prov,0))
		from  pls_conta_medica_resumo x
		where   nr_seq_conta = a.nr_seq_conta
		and    nr_seq_conta_mat = a.nr_sequencia) nr_lote_contabil,
		nr_lote_contabil_prov,
		a.ie_origem_conta,
		a.vl_material_imp,
		(	select	coalesce(max(x.ie_a520), 'N')
			from	pls_conta_mat_regra	x
			where	x.nr_sequencia		= a.nr_sequencia) ie_a520,
		a.dt_fim_consistencia
	from  	pls_conta_mat_v a
	where  	a.nr_seq_protocolo = nr_seq_protocolo_pc
	and    	coalesce(nr_seq_conta_pc::text, '') = ''
	and    	coalesce(nr_seq_conta_mat_pc::text, '') = ''
	and    	((a.vl_material_imp    = 0) or (ie_vl_apresentado_sistema = 'S') or
		(a.ie_vl_apres_sist_regra = 'S' AND  ie_atual_vl_apres_e_mantem_w = 'S'))
	and	a.vl_material > 0
	
union all

	select  a.nr_sequencia,
		a.vl_material,
		a.qt_material_imp,
		(  select max(ie_atualiza_val_apres)
		from  pls_regra_val_apres b
		where  b.ie_origem_protocolo = a.ie_origem_protocolo
		and    ie_situacao = 'A'
		and    cd_estabelecimento = cd_estabelecimento_pc) ie_atualiza_val_apres,
		(  select   coalesce(min(ie_gerada_cta_hon),'A')
		from  pls_regra_val_apres b
		where  b.ie_origem_protocolo = a.ie_origem_protocolo
		and    ie_situacao = 'A'
		and    coalesce(ie_gerada_cta_hon,'A') in ('A','S')
		and    cd_estabelecimento = cd_estabelecimento_pc) ie_gerada_cta_hon,
		nr_seq_regra_conta_auto,
		(   select   max(coalesce(nr_lote_contabil_prov,0))
		from  pls_conta_medica_resumo x
		where   nr_seq_conta = a.nr_seq_conta
		and    nr_seq_conta_mat = a.nr_sequencia) nr_lote_contabil,
		nr_lote_contabil_prov,
		a.ie_origem_conta,
		a.vl_material_imp,
		(	select	coalesce(max(x.ie_a520), 'N')
			from	pls_conta_mat_regra	x
			where	x.nr_sequencia		= a.nr_sequencia) ie_a520,
		a.dt_fim_consistencia
	from  	pls_conta_mat_v a
	where  	a.nr_seq_lote_conta = nr_seq_lote_pc
	and    	coalesce(nr_seq_conta_mat_pc::text, '') = ''
	and    	coalesce(nr_seq_conta_pc::text, '') = ''
	and    	coalesce(nr_seq_protocolo_pc::text, '') = ''
	and     ((a.vl_material_imp    = 0) or (ie_vl_apresentado_sistema = 'S') or
		(a.ie_vl_apres_sist_regra = 'S' AND  ie_atual_vl_apres_e_mantem_w = 'S'))
	and	a.vl_material > 0
	
union all

	select  a.nr_sequencia,
		a.vl_material,
		a.qt_material_imp,
		(  select max(ie_atualiza_val_apres)
		from  pls_regra_val_apres b
		where  b.ie_origem_protocolo = a.ie_origem_protocolo
		and    ie_situacao = 'A'
		and    cd_estabelecimento = cd_estabelecimento_pc) ie_atualiza_val_apres,
		(  select   coalesce(min(ie_gerada_cta_hon),'A')
		from  pls_regra_val_apres b
		where  b.ie_origem_protocolo = a.ie_origem_protocolo
		and    ie_situacao = 'A'
		and    coalesce(ie_gerada_cta_hon,'A') in ('A','S')
		and    cd_estabelecimento = cd_estabelecimento_pc) ie_gerada_cta_hon,
		nr_seq_regra_conta_auto,
		(   select   max(coalesce(nr_lote_contabil_prov,0))
		from  pls_conta_medica_resumo x
		where   nr_seq_conta = a.nr_seq_conta
		and    nr_seq_conta_mat = a.nr_sequencia) nr_lote_contabil,
		nr_lote_contabil_prov,
		a.ie_origem_conta,
		a.vl_material_imp,
		(	select	coalesce(max(x.ie_a520), 'N')
			from	pls_conta_mat_regra	x
			where	x.nr_sequencia		= a.nr_sequencia) ie_a520,
		a.dt_fim_consistencia
	from  	pls_conta_mat_v a
	where  	coalesce(nr_seq_conta_pc::text, '') = ''
	and    	coalesce(nr_seq_conta_mat_pc::text, '') = ''
	and    	coalesce(nr_seq_protocolo_pc::text, '') = ''
	and    	coalesce(nr_seq_lote_pc::text, '') = ''
	and	a.vl_material > 0
	and     ((a.vl_material_imp    = 0) or (ie_vl_apresentado_sistema = 'S') or
		(a.ie_vl_apres_sist_regra = 'S' AND  ie_atual_vl_apres_e_mantem_w = 'S'))
	and  	exists (  select  1
			from  pls_cta_lote_proc_conta p
			where  p.nr_seq_lote_processo = nr_seq_lote_processo_pc
			and    p.nr_seq_conta = a.nr_seq_conta);


procedure atualiza_valores_procedimentos(  	tb_nr_seq_p      dbms_sql.number_table,
						tb_vl_proc_p     dbms_sql.number_table,
						tb_vl_unit_p     dbms_sql.number_table
          ) is;
BEGIN

	if (tb_nr_seq_p.count > 0) then
		forall i in tb_nr_seq_p.first..tb_nr_seq_p.last
			update  pls_conta_proc
			set    	vl_procedimento_imp             = tb_vl_proc_p(i),
				ie_vl_apresentado_sistema       = 'S',
				vl_unitario_imp                 = tb_vl_unit_p(i)
			where  	nr_sequencia  = tb_nr_seq_p(i);

		commit;
	end if;
	
	if (tb_nr_seq_p.count > 0) then
		forall i in tb_nr_seq_p.first..tb_nr_seq_p.last
			update  pls_conta_proc_regra
			set    	ie_vl_apresentado_sistema       = 'S'
			where  	nr_sequencia  = tb_nr_seq_p(i);

		commit;
	end if;
	
end;

procedure atualiza_valores_materiais(  	tb_nr_seq_p  dbms_sql.number_table,
					tb_vl_mat_p  dbms_sql.number_table,
					tb_vl_unit_p dbms_sql.number_table
         ) is
begin
	if (tb_nr_seq_p.count > 0) then
		forall i in tb_nr_seq_p.first..tb_nr_seq_p.last
			update 	pls_conta_mat
			set    	vl_material_imp               = tb_vl_mat_p(i),
				ie_vl_apresentado_sistema     = 'S',
				vl_unitario_imp               = tb_vl_unit_p(i)
	    where  		nr_sequencia  		      = tb_nr_seq_p(i);

	  commit;
	end if;
	
	if (tb_nr_seq_p.count > 0) then
		forall i in tb_nr_seq_p.first..tb_nr_seq_p.last
			update 	pls_conta_mat_regra
			set    	ie_vl_apresentado_sistema     = 'S'
	    where  		nr_sequencia  		      = tb_nr_seq_p(i);

	  commit;
	end if;
	
end;

begin

select  coalesce(ie_atualizar_valor_apresent,'N'),
	coalesce(ie_manter_vl_apresentado, 'N'),
	coalesce(ie_atualiza_vl_apres_e_mantem, 'N')
into STRICT  	ie_atualizar_valor_apresent_w,
	ie_manter_vl_apresentado_w,
	ie_atual_vl_apres_e_mantem_w
from  	table(pls_parametros_pck.f_retorna_param(cd_estabelecimento_p));

if (coalesce(nr_seq_conta_mat_p::text, '') = '') then

	nr_indexador_w := 0;
	tb_vl_unitario_imp_w.delete;
	tb_vl_procedimento_w.delete;
	tb_seq_procedimento_w.delete;

	for r_C01_w in  C01(nr_seq_lote_conta_p, nr_seq_protocolo_p, nr_seq_lote_processo_p, nr_seq_conta_p, nr_seq_conta_proc_p, cd_estabelecimento_p) loop

		ie_regra_valida_w := 'N';
		ie_val_apres_conta_princ_w := 'N';
		pr_proporcao_w := 1;

		if (coalesce(r_C01_w.ie_gerada_cta_hon,'A') = 'A') then
			ie_regra_valida_w := 'S';
		elsif  (r_C01_w.ie_gerada_cta_hon = 'S' AND r_C01_w.nr_seq_regra_conta_auto IS NOT NULL AND r_C01_w.nr_seq_regra_conta_auto::text <> '') then
			ie_regra_valida_w := 'S';
		else
			if (coalesce(r_C01_w.nr_seq_regra_conta_auto::text, '') = '') then
				ie_regra_valida_w := 'S';
			end if;

		end if;
	
		if ((ie_manter_vl_apresentado_w = 'N') or ((ie_manter_vl_apresentado_w = 'S') and (coalesce(r_C01_w.nr_lote_contabil,0) = 0) and (coalesce(r_c01_w.nr_lote_contabil_prov,0) = 0))) then

			if (ie_regra_valida_w = 'S') then
			
				if (ie_atualizar_valor_apresent_w = 'S' or (ie_atualizar_valor_apresent_w = 'R' and r_C01_w.ie_atualiza_val_apres = 'S')) then

					if (r_C01_w.nr_seq_regra_conta_auto IS NOT NULL AND r_C01_w.nr_seq_regra_conta_auto::text <> '') then
						select   max(ie_val_apres_conta_princ)
						into STRICT  	ie_val_apres_conta_princ_w
						from  	pls_regra_val_apres
						where  	ie_situacao = 'A'
						and  	coalesce(ie_gerada_cta_hon,'A') = r_C01_w.ie_gerada_cta_hon
						and  	cd_estabelecimento = cd_estabelecimento_p;

						if (ie_val_apres_conta_princ_w = 'S') then
							pr_proporcao_w := dividir(r_C01_w.vl_participante, r_C01_w.vl_calc_proc_princ);
						end if;

					end if;

					if (pls_obter_se_a504_glosado(r_C01_w.ie_a520, r_C01_w.ie_origem_conta, r_C01_w.vl_procedimento_imp) = 'N') then
					
						if  not(ie_atual_vl_apres_e_mantem_w = 'S' and (r_C01_w.dt_fim_consistencia IS NOT NULL AND r_C01_w.dt_fim_consistencia::text <> '')) then
					
							tb_vl_unitario_imp_w(nr_indexador_w)    := dividir((r_C01_w.vl_procedimento * pr_proporcao_w), r_C01_w.qt_procedimento_imp);
							tb_vl_procedimento_w(nr_indexador_w)  := r_C01_w.vl_procedimento * pr_proporcao_w;
							tb_seq_procedimento_w(nr_indexador_w)   := r_C01_w.nr_sequencia;
							
						else
							tb_vl_unitario_imp_w(nr_indexador_w)    := dividir((r_C01_w.vl_procedimento_imp * pr_proporcao_w), r_C01_w.qt_procedimento_imp);
							tb_vl_procedimento_w(nr_indexador_w)  := r_C01_w.vl_procedimento_imp * pr_proporcao_w;
							tb_seq_procedimento_w(nr_indexador_w)   := r_C01_w.nr_sequencia;
						end if;

						if (nr_indexador_w >= pls_util_cta_pck.qt_registro_transacao_w) then

							atualiza_valores_procedimentos(tb_seq_procedimento_w, tb_vl_procedimento_w, tb_vl_unitario_imp_w);

							nr_indexador_w := 0;
							tb_vl_unitario_imp_w.delete;
							tb_vl_procedimento_w.delete;
							tb_seq_procedimento_w.delete;
						else
							nr_indexador_w := nr_indexador_w + 1;
						end if;
					end if;
					
				end if;
			end if;
		end if;

	end loop;

	atualiza_valores_procedimentos(tb_seq_procedimento_w, tb_vl_procedimento_w, tb_vl_unitario_imp_w);
end if;

if (coalesce(nr_seq_conta_proc_p::text, '') = '') then

	nr_indexador_w := 0;
	tb_vl_unitario_imp_w.delete;
	tb_vl_material_w.delete;
	tb_seq_material_w.delete;

	for r_C02_w in  C02(nr_seq_lote_conta_p, nr_seq_protocolo_p, nr_seq_lote_processo_p, nr_seq_conta_p, nr_seq_conta_mat_p, cd_estabelecimento_p) loop

		ie_regra_valida_w := 'N';
		ie_val_apres_conta_princ_w := 'N';

		if (coalesce(r_C02_w.ie_gerada_cta_hon,'A') = 'A') then
			ie_regra_valida_w := 'S';
		elsif  (r_C02_w.ie_gerada_cta_hon = 'S' AND r_C02_w.nr_seq_regra_conta_auto IS NOT NULL AND r_C02_w.nr_seq_regra_conta_auto::text <> '') then
			ie_regra_valida_w := 'S';
		else
			if (coalesce(r_C02_w.nr_seq_regra_conta_auto::text, '') = '') then
			ie_regra_valida_w := 'S';
			end if;
		end if;

		if 	((ie_manter_vl_apresentado_w = 'N') or (ie_manter_vl_apresentado_w = 'S') and (coalesce(r_C02_w.nr_lote_contabil,0) = 0) and (coalesce(r_c02_w.nr_lote_contabil_prov,0) = 0)) then
			if (ie_regra_valida_w = 'S') then

				if (ie_atualizar_valor_apresent_w = 'S' or (ie_atualizar_valor_apresent_w = 'R' and r_C02_w.ie_atualiza_val_apres = 'S')) then
				

					if (pls_obter_se_a504_glosado(r_C02_w.ie_a520, r_C02_w.ie_origem_conta, r_C02_w.vl_material_imp) = 'N') then
					
						if  not(ie_atual_vl_apres_e_mantem_w = 'S' and (r_C02_w.dt_fim_consistencia IS NOT NULL AND r_C02_w.dt_fim_consistencia::text <> '')) then
						
							tb_vl_unitario_imp_w(nr_indexador_w)    := dividir(r_C02_w.vl_material, r_C02_w.qt_material_imp);
							tb_vl_material_w(nr_indexador_w)  := r_C02_w.vl_material;
							tb_seq_material_w(nr_indexador_w)   := r_C02_w.nr_sequencia;
							
						else
							tb_vl_unitario_imp_w(nr_indexador_w)    := dividir(r_C02_w.vl_material_imp, r_C02_w.qt_material_imp);
							tb_vl_material_w(nr_indexador_w)  := r_C02_w.vl_material_imp;
							tb_seq_material_w(nr_indexador_w)   := r_C02_w.nr_sequencia;
							
						end if;

						if (nr_indexador_w >= pls_util_cta_pck.qt_registro_transacao_w) then
							atualiza_valores_materiais(tb_seq_material_w, tb_vl_material_w, tb_vl_unitario_imp_w);

							nr_indexador_w := 0;
							tb_vl_unitario_imp_w.delete;
							tb_vl_material_w.delete;
							tb_seq_material_w.delete;
						else
							nr_indexador_w := nr_indexador_w + 1;
						end if;
					end if;
					
				end if;
			end if;
		end if;

	end loop;

	atualiza_valores_materiais(tb_seq_material_w, tb_vl_material_w, tb_vl_unitario_imp_w);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualiza_valor_apresentado ( nr_seq_lote_conta_p pls_lote_protocolo_conta.nr_sequencia%type, nr_seq_protocolo_p pls_protocolo_conta.nr_sequencia%type, nr_seq_lote_processo_p pls_cta_lote_processo.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type default null) FROM PUBLIC;

