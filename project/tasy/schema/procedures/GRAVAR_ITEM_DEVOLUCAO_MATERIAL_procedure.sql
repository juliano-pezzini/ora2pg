-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_item_devolucao_material ( nr_devolucao_p bigint, cd_material_p bigint, cd_motivo_devolucao_p bigint, cd_local_estoque_p bigint, cd_cgc_fornec_p text, nr_seq_lote_fornec_p bigint, nr_seq_atendimento_p bigint, qt_material_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_cgc_fornecedor_w			varchar(14);
cd_unidade_medida_w			varchar(30);
ds_material_w				varchar(255);
dt_atendimento_w				timestamp;
dt_entrada_unidade_w			timestamp;
ie_consignado_w				varchar(1);
nr_prescricao_w				bigint;
nr_seq_lote_fornec_w			bigint;
nr_sequencia_prescricao_w			bigint;
nr_sequencia_w				bigint;


BEGIN 
 
select	ds_material, 
	coalesce(ie_consignado,'0') 
into STRICT	ds_material_w, 
	ie_consignado_w 
from	material 
where	cd_material	= cd_material_p;
	 
if (coalesce(nr_seq_atendimento_p,0) = 0) then 
	-- O Material: #@CD_MATERIAL#@ - #@DS_MATERIAL#@	não possui sequência de atendimento! 
	CALL Wheb_mensagem_pck.exibir_mensagem_abort( 261366 , 'CD_MATERIAL='||cd_material_p||';DS_MATERIAL=0'||ds_material_w);
end if;
 
/*Buscar os dados do material atendido */
 
select	max(a.dt_entrada_unidade), 
	max(a.dt_atendimento), 
	max(a.nr_prescricao), 
	max(a.nr_sequencia_prescricao), 
	max(a.cd_unidade_medida) 
into STRICT	dt_entrada_unidade_w, 
	dt_atendimento_w, 
	nr_prescricao_w, 
	nr_sequencia_prescricao_w, 
	cd_unidade_medida_w 
from	material_em_devolucao_v a 
where	a.nr_sequencia	= nr_seq_atendimento_p;
 
select	coalesce(max(nr_seq_lote_fornec),0), 
	coalesce(max(cd_cgc_fornecedor),'0') 
into STRICT	nr_seq_lote_fornec_w, 
	cd_cgc_fornecedor_w 
from	material_atend_paciente 
where	nr_sequencia = nr_seq_atendimento_p;
 
if	(coalesce(nr_seq_lote_fornec_p,0) <> (nr_seq_lote_fornec_w)) then 
	-- O Lote fornecedor lido é diferente do lote do material #@DS_MATERIAL#@ 
	CALL Wheb_mensagem_pck.exibir_mensagem_abort( 261367 , 'DS_MATERIAL='||ds_material_w);
end if;
 
if (ie_consignado_w = '0') then 
	cd_cgc_fornecedor_w	:= '';
else	 
	if (cd_cgc_fornecedor_w = '0') then 
		-- Não existe fornecedor consignado no lançamento do item: 	#@CD_MATERIAL#@ - #@DS_MATERIAL#@ 
		CALL Wheb_mensagem_pck.exibir_mensagem_abort( 261368 , 'PARAM_1=0;PARAM_2=0');
	end if;
end if;
 
select	coalesce(max(a.nr_sequencia),0) 
into STRICT	nr_sequencia_w 
from	item_devolucao_material_pac a 
where	a.nr_devolucao		= nr_devolucao_p 
and	a.cd_material			= cd_material_p 
and	a.nr_seq_atendimento		= nr_seq_atendimento_p 
and	coalesce(a.dt_recebimento::text, '') = '';
 
if (nr_sequencia_w > 0) then 
	update	item_devolucao_material_pac 
	set	qt_material		= qt_material + qt_material_p, 
		nm_usuario		= nm_usuario_p, 
		dt_atualizacao	= clock_timestamp(), 
		ie_geracao		= 'B' 
	where	nr_devolucao		= nr_devolucao_p 
	and	nr_sequencia		= nr_sequencia_w;
else 
	/*Sequencia do item NOVO*/
	 
	select	coalesce(max(nr_sequencia),0) + 1 
	into STRICT	nr_sequencia_w 
	from	item_devolucao_material_pac 
	where	nr_devolucao = nr_devolucao_p;
 
	insert into item_devolucao_material_pac( 
		nr_devolucao, 
		nr_sequencia, 
		cd_material, 
		dt_atendimento, 
		cd_local_estoque, 
		cd_unidade_medida, 
		cd_motivo_devolucao, 
		nm_usuario_devol, 
		qt_material, 
		nr_prescricao, 
		nr_sequencia_prescricao, 
		dt_entrada_unidade, 
		nr_seq_atendimento, 
		nr_seq_lote_fornec, 
		cd_cgc_fornec, 
		cd_setor_atendimento, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		ie_geracao) 
	values (nr_devolucao_p, 
		nr_sequencia_w, 
		cd_material_p, 
		dt_atendimento_w, 
		cd_local_estoque_p, 
		cd_unidade_medida_w, 
		cd_motivo_devolucao_p, 
		nm_usuario_p, 
		qt_material_p, 
		nr_prescricao_w, 
		nr_sequencia_prescricao_w, 
		dt_entrada_unidade_w, 
		nr_seq_atendimento_p, 
		CASE WHEN nr_seq_lote_fornec_w=0 THEN null  ELSE nr_seq_lote_fornec_w END , 
		cd_cgc_fornecedor_w, 
		null, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		'B');
end if;
 
commit;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_item_devolucao_material ( nr_devolucao_p bigint, cd_material_p bigint, cd_motivo_devolucao_p bigint, cd_local_estoque_p bigint, cd_cgc_fornec_p text, nr_seq_lote_fornec_p bigint, nr_seq_atendimento_p bigint, qt_material_p bigint, nm_usuario_p text) FROM PUBLIC;

