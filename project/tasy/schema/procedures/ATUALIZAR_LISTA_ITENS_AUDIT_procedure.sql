-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_lista_itens_audit (nr_interno_conta_p bigint, nr_seq_item_p bigint, ie_tipo_item_p bigint, qt_item_p bigint, nm_usuario_p text, nr_seq_motivo_p bigint, nr_seq_auditoria_p bigint, ie_agrupado_p text) AS $body$
DECLARE


nr_seq_auditoria_w	bigint;
nr_seq_item_w		bigint;
nr_interno_conta_w	bigint;
nr_seq_auditoria_ww	bigint;

ie_tipo_auditoria_w	varchar(1);
ie_agrupamento_w	varchar(3);
cd_setor_atendimento_w	integer;
cd_item_w		bigint;
ie_origem_proced_w	bigint;
qt_registro_w		bigint;
qt_item_w		double precision;
nr_seq_audit_ext_w	bigint;
qt_auditoria_item_w	bigint:=0;
ie_tipo_audit_item_w	varchar(1);
ie_item_exec_agrup_w	varchar(1);
vl_material_w		double precision;
vl_procedimento_w	double precision;
dt_item_w		timestamp;



BEGIN

ie_item_exec_agrup_w := coalesce(obter_valor_param_usuario(1116, 140, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento),'N');

if (coalesce(ie_item_exec_agrup_w,'N') = 'S') and (coalesce(ie_agrupado_p,'N') = 'S') then
	ie_tipo_audit_item_w	:= 'G';
elsif (coalesce(ie_item_exec_agrup_w,'N') = 'D') and (coalesce(ie_agrupado_p,'N') = 'S') then
	ie_tipo_audit_item_w	:= 'D';
else
	ie_tipo_audit_item_w	:= 'E';
end if;

if (ie_tipo_item_p 	= 1) then

	select	coalesce(max(nr_interno_conta),0),
		coalesce(max(vl_material),0),
		coalesce(max(dt_atendimento),clock_timestamp())
	into STRICT	nr_interno_conta_w,
		vl_material_w,
		dt_item_w
	from	material_atend_paciente
	where	nr_sequencia	= nr_seq_item_p
	and	ie_auditoria	= 'S';

	select	count(*)
	into STRICT	qt_auditoria_item_w
	from	auditoria_matpaci
	where	nr_seq_matpaci = nr_seq_item_p
	and	nr_seq_auditoria = nr_seq_auditoria_p;

else

	select	coalesce(max(nr_interno_conta),0),
		coalesce(max(vl_procedimento),0),
		coalesce(max(dt_procedimento),clock_timestamp())
	into STRICT	nr_interno_conta_w,
		vl_procedimento_w,
		dt_item_w
	from	procedimento_paciente
	where	nr_sequencia	= nr_seq_item_p
	and	ie_auditoria	= 'S';

	select	count(*)
	into STRICT	qt_auditoria_item_w
	from	auditoria_propaci
	where	nr_seq_propaci = nr_seq_item_p
	and	nr_seq_auditoria = nr_seq_auditoria_p;

end if;

if (nr_interno_conta_w	<> 0) and (qt_auditoria_item_w = 0) then
	begin
	nr_seq_auditoria_ww	:= 0;

	if (coalesce(nr_seq_auditoria_p,0)	>0) then

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_auditoria_ww
		from	auditoria_conta_paciente
		where	nr_sequencia	= nr_seq_auditoria_p
		and	coalesce(dt_liberacao::text, '') = ''
		and 	dt_item_w between dt_periodo_inicial and dt_periodo_final;

	end if;

	if (nr_seq_auditoria_ww	= 0) then

		select	coalesce(max(NR_SEQUENCIA),0)
		into STRICT	nr_seq_auditoria_w
		from	auditoria_conta_paciente
		where	nr_interno_conta	= nr_interno_conta_w
		and	coalesce(dt_liberacao::text, '') = ''
		and 	dt_item_w between dt_periodo_inicial and dt_periodo_final;

	else
		nr_seq_auditoria_w	:= nr_seq_auditoria_ww;

	end if;

	if (nr_seq_auditoria_w 	> 0) then
		begin

		/* Rotina para inclus√£o de itens em auditorias externas*/

		select 	coalesce(max(ie_tipo_auditoria),'I'),
			max(ie_agrupamento)
		into STRICT	ie_tipo_auditoria_w,
			ie_agrupamento_w
		from 	auditoria_conta_paciente
		where 	nr_sequencia = nr_seq_auditoria_w
		and 	coalesce(dt_liberacao::text, '') = '';

		if	(ie_tipo_auditoria_w = 'E' AND ie_agrupamento_w IS NOT NULL AND ie_agrupamento_w::text <> '') then

			if (ie_agrupamento_w in ('AS','ASV')) then
				if (ie_tipo_item_p 	= 1) then -- Material
					select	max(cd_setor_atendimento),
						max(cd_material),
						max(qt_material)
					into STRICT	cd_setor_atendimento_w,
						cd_item_w,
						qt_item_w
					from 	material_atend_paciente
					where 	nr_sequencia = nr_seq_item_p;

					select 	count(*)
					into STRICT	qt_registro_w
					from 	auditoria_externa
					where 	nr_seq_auditoria = nr_seq_auditoria_w
					and 	cd_setor_atendimento = cd_setor_atendimento_w
					and 	cd_item	= cd_item_w;

					if (qt_registro_w = 0) then

						select 	nextval('auditoria_externa_seq')
						into STRICT	nr_seq_audit_ext_w
						;

						insert into Auditoria_externa(nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								ie_tipo_item,
								cd_item,
								ie_origem_proced,
								ie_agrupamento,
								dt_item,
								qt_original,
								qt_ajuste,
								nr_seq_motivo,
								nr_seq_auditoria,
								cd_setor_atendimento)
							values (nr_seq_audit_ext_w,
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								'M',
								cd_item_w,
								null,
								ie_agrupamento_w,
								null,
								qt_item_w,
								null,
								null,
								nr_seq_auditoria_w,
								cd_setor_atendimento_w);

						insert into Auditoria_externa_item(nr_sequencia,
								nr_seq_audit_ext,
								nr_seq_item,
								ie_tipo_item,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec)
							values (nextval('auditoria_externa_item_seq'),
								nr_seq_audit_ext_w,
								nr_seq_item_p,
								'M',
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p);
					else

						select 	coalesce(max(nr_sequencia),0)
						into STRICT	nr_seq_audit_ext_w
						from 	auditoria_externa
						where 	nr_seq_auditoria = nr_seq_auditoria_w
						and 	cd_setor_atendimento = cd_setor_atendimento_w
						and 	cd_item	= cd_item_w;

						if (nr_seq_audit_ext_w > 0) then

							update	auditoria_externa
							set 	qt_original = qt_original + qt_item_w
							where 	nr_sequencia = nr_seq_audit_ext_w;

							insert into Auditoria_externa_item(nr_sequencia,
								nr_seq_audit_ext,
								nr_seq_item,
								ie_tipo_item,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec)
							values (nextval('auditoria_externa_item_seq'),
								nr_seq_audit_ext_w,
								nr_seq_item_p,
								'M',
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p);

						end if;

					end if;

				else					-- Procedimento
					select	max(cd_setor_atendimento),
						max(cd_procedimento),
						max(ie_origem_proced),
						max(qt_procedimento)
					into STRICT	cd_setor_atendimento_w,
						cd_item_w,
						ie_origem_proced_w,
						qt_item_w
					from 	procedimento_paciente
					where 	nr_sequencia = nr_seq_item_p;

					select 	count(*)
					into STRICT	qt_registro_w
					from 	auditoria_externa
					where 	nr_seq_auditoria = nr_seq_auditoria_w
					and 	cd_setor_atendimento = cd_setor_atendimento_w
					and 	cd_item	= cd_item_w
					and 	ie_origem_proced = ie_origem_proced_w;

					if (qt_registro_w = 0) then

						select 	nextval('auditoria_externa_seq')
						into STRICT	nr_seq_audit_ext_w
						;

						insert into Auditoria_externa(nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								ie_tipo_item,
								cd_item,
								ie_origem_proced,
								ie_agrupamento,
								dt_item,
								qt_original,
								qt_ajuste,
								nr_seq_motivo,
								nr_seq_auditoria,
								cd_setor_atendimento)
							values (nr_seq_audit_ext_w,
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								'P',
								cd_item_w,
								ie_origem_proced_w,
								ie_agrupamento_w,
								null,
								qt_item_w,
								null,
								null,
								nr_seq_auditoria_w,
								cd_setor_atendimento_w);

						insert into Auditoria_externa_item(nr_sequencia,
								nr_seq_audit_ext,
								nr_seq_item,
								ie_tipo_item,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec)
							values (nextval('auditoria_externa_item_seq'),
								nr_seq_audit_ext_w,
								nr_seq_item_p,
								'P',
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p);
					else

						select 	coalesce(max(nr_sequencia),0)
						into STRICT	nr_seq_audit_ext_w
						from 	auditoria_externa
						where 	nr_seq_auditoria = nr_seq_auditoria_w
						and 	cd_setor_atendimento = cd_setor_atendimento_w
						and 	cd_item	= cd_item_w
						and 	ie_origem_proced = ie_origem_proced_w;

						if (nr_seq_audit_ext_w > 0) then

							update	auditoria_externa
							set 	qt_original = qt_original + qt_item_w
							where 	nr_sequencia = nr_seq_audit_ext_w;

							insert into Auditoria_externa_item(nr_sequencia,
								nr_seq_audit_ext,
								nr_seq_item,
								ie_tipo_item,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec)
							values (nextval('auditoria_externa_item_seq'),
								nr_seq_audit_ext_w,
								nr_seq_item_p,
								'P',
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p);

						end if;

					end if;

				end if;
			end if;

		else

			if (ie_tipo_item_p 	= 1) then
				begin

				select	nextval('auditoria_matpaci_seq')
				into STRICT	nr_seq_item_w
				;

				insert	into auditoria_matpaci(nr_sequencia,
					nr_seq_auditoria,
					nr_seq_matpaci,
					dt_atualizacao,
					nm_usuario,
					qt_original,
					ie_tipo_auditoria,
					nr_seq_motivo,
					ie_perda,
					vl_material)
				values (nr_seq_item_w,
					nr_seq_auditoria_w,
					nr_seq_item_p,
					clock_timestamp(),
					nm_usuario_p,
					qt_item_p,
					ie_tipo_audit_item_w,
					CASE WHEN nr_seq_motivo_p=0 THEN Null  ELSE nr_seq_motivo_p END ,
					'N',
					vl_material_w);


				end;
			else
				begin

				select	nextval('auditoria_propaci_seq')
				into STRICT	nr_seq_item_w
				;

				insert	into auditoria_propaci(nr_sequencia,
					nr_seq_auditoria,
					nr_seq_propaci,
					dt_atualizacao,
					nm_usuario,
					qt_original,
					TX_PROC_ORIGINAL,
					ie_tipo_auditoria,
					nr_seq_motivo,
					ie_perda,
					vl_procedimento)
				values (nr_seq_item_w,
					nr_seq_auditoria_w,
					nr_seq_item_p,
					clock_timestamp(),
					nm_usuario_p,
					qt_item_p,
					0, ie_tipo_audit_item_w,
					CASE WHEN nr_seq_motivo_p=0 THEN Null  ELSE nr_seq_motivo_p END ,
					'N',
					vl_procedimento_w);


				end;
			end if;

		end if;

		end;

	else

		-- Se ele n√£o entrou em nenhuma auditoria, ent√£o o item n√£o est√° auditado e nem em auditoria
		if (ie_tipo_item_p 	= 1) then

			update	material_atend_paciente
			set	ie_auditoria = 'N'
			where 	nr_sequencia	= nr_seq_item_p;

		else

			update	procedimento_paciente
			set	ie_auditoria = 'N'
			where 	nr_sequencia	= nr_seq_item_p;

		end if;

	end if;
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_lista_itens_audit (nr_interno_conta_p bigint, nr_seq_item_p bigint, ie_tipo_item_p bigint, qt_item_p bigint, nm_usuario_p text, nr_seq_motivo_p bigint, nr_seq_auditoria_p bigint, ie_agrupado_p text) FROM PUBLIC;

