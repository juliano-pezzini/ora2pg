-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_material_diluicao () AS $body$
DECLARE


cd_estabelecimento_w			smallint;
cd_estab_min_w			smallint;
cd_material_w				integer;
cd_diluente_w				integer;
cd_setor_atendimento_w		integer;
cd_intervalo_w			varchar(7);
cd_unidade_medida_w			varchar(30);
cd_unid_med_diluente_w		varchar(30);
cd_unid_med_concentracao_w		varchar(30);
cd_unid_med_base_concent_w		varchar(30);
nr_seq_prioridade_w			smallint;
nr_sequencia_w			integer;
qt_existe_w				bigint;
qt_concentracao_w			double precision;
qt_diluicao_w				double precision;
qt_minima_diluicao_w			double precision;
qt_fixa_diluicao_w			double precision;
qt_minuto_aplicacao_w		smallint;
ie_reconstituicao_w			varchar(1);
ie_via_aplicacao_w			varchar(5);

c01 CURSOR FOR
SELECT	a.cd_estabelecimento
from	estabelecimento a
where	a.cd_estabelecimento not in (cd_estab_min_w)
and	not exists (	select	1
			from	material_diluicao b
			where	b.cd_estabelecimento = a.cd_estabelecimento);

c02 CURSOR FOR
SELECT	cd_material,
	cd_unidade_medida,
	cd_diluente,
	cd_unid_med_diluente,
	qt_diluicao,
	qt_minima_diluicao,
	qt_fixa_diluicao,
	qt_minuto_aplicacao,
	ie_reconstituicao,
	ie_via_aplicacao,
	qt_concentracao,
	cd_unid_med_concentracao,
	cd_unid_med_base_concent,
	nr_seq_prioridade,
	cd_intervalo,
	cd_setor_atendimento
from	material_diluicao
where	cd_estabelecimento = cd_estab_min_w;


BEGIN

select	min(cd_estabelecimento)
into STRICT	cd_estab_min_w
from	estabelecimento;

select	count(*)
into STRICT	qt_existe_w
from	material_diluicao
where	(cd_estabelecimento IS NOT NULL AND cd_estabelecimento::text <> '');

if (qt_existe_w = 0) then
	update	material_diluicao
	set	cd_estabelecimento = cd_estab_min_w;
end if;

	open c01;
	loop
	fetch C01 into
			cd_estabelecimento_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
			begin
			open c02;
			loop
			fetch C02 into
					cd_material_w,
					cd_unidade_medida_w,
					cd_diluente_w,
					cd_unid_med_diluente_w,
					qt_diluicao_w,
					qt_minima_diluicao_w,
					qt_fixa_diluicao_w,
					qt_minuto_aplicacao_w,
					ie_reconstituicao_w,
					ie_via_aplicacao_w,
					qt_concentracao_w,
					cd_unid_med_concentracao_w,
					cd_unid_med_base_concent_w,
					nr_seq_prioridade_w,
					cd_intervalo_w,
					cd_setor_atendimento_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				begin
				select	coalesce(max(nr_sequencia),0) + 1
				into STRICT	nr_sequencia_w
				from 	material_diluicao;

				insert into material_diluicao(
					cd_estabelecimento,
					cd_material,
					nr_sequencia,
					cd_unidade_medida,
					cd_diluente,
					cd_unid_med_diluente,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					qt_diluicao,
					qt_minima_diluicao,
					qt_fixa_diluicao,
					qt_minuto_aplicacao,
					ie_reconstituicao,
					ie_via_aplicacao,
					qt_concentracao,
					cd_unid_med_concentracao,
					cd_unid_med_base_concent,
					nr_seq_prioridade,
					cd_intervalo,
					cd_setor_atendimento)
				values (	cd_estabelecimento_w,
					cd_material_w,
					nr_sequencia_w,
					cd_unidade_medida_w,
					cd_diluente_w,
					cd_unid_med_diluente_w,
					clock_timestamp(),
					'Baca_Diluicao',
					clock_timestamp(),
					'Baca_Diluicao',
					qt_diluicao_w,
					qt_minima_diluicao_w,
					qt_fixa_diluicao_w,
					qt_minuto_aplicacao_w,
					ie_reconstituicao_w,
					ie_via_aplicacao_w,
					qt_concentracao_w,
					cd_unid_med_concentracao_w,
					cd_unid_med_base_concent_w,
					nr_seq_prioridade_w,
					cd_intervalo_w,
					cd_setor_atendimento_w);
			end;
			end loop;
			close c02;
end;
end loop;
close c01;
commit;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_material_diluicao () FROM PUBLIC;

