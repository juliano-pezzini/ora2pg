-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE elsevier_import_red_dil_recons ( cd_protocolo_p protocolo_medicacao.cd_protocolo%type, nr_seq_protocolo_p protocolo_medicacao.nr_sequencia%type, nr_seq_mat_p protocolo_medic_material.nr_seq_material%type, ie_agrupador_p protocolo_medic_material.ie_agrupador%type, nm_usuario_p intpd_fila_transmissao.nm_usuario%type, cd_material_p protocolo_medic_material.cd_material%type, cd_unidade_medida_p protocolo_medic_material.cd_unidade_medida%type, qt_dose_p protocolo_medic_material.qt_dose%type) is ds_sql_w varchar(4000) RETURNS varchar AS $body$
DECLARE

ds_caracter_w varchar(1);

  record_vision RECORD;

BEGIN
    ds_caracter_w := chr(39);
    return ds_caracter_w || vl || ds_caracter_w;
end;

begin

    select	obter_seq_mat_prot_medic_mat(cd_protocolo_p, nr_seq_protocolo_p),
            obter_agrup_prot_medic_mat(cd_protocolo_p, nr_seq_protocolo_p, 0)
    into STRICT	nr_seq_material_w,
        nr_agrupamento_w
;

    ds_fields_default := '';
    ds_values_fields_defaults := '';

    case 
        when ie_agrupador_p = 3 then
                nr_seq_visao_w := 30119;
        when ie_agrupador_p = 7 then
                nr_seq_visao_w := 30117;
        when ie_agrupador_p = 9 then
                nr_seq_visao_w := 30032;
    else
          nr_seq_visao_w := 0;
    end case;

    if (nr_seq_visao_w <> 0)then

        for record_vision in (
                SELECT  nm_atributo,
                    vl_padrao,
                    substr(obter_tipo_atributo(nr_sequencia,nm_atributo),1,15) ie_tipo
                from    tabela_visao_atributo
                where (vl_padrao IS NOT NULL AND vl_padrao::text <> '')
                and   nr_sequencia = nr_seq_visao_w
        )
        loop
            if (lower(record_vision.ie_tipo) = 'varchar2') then
                ds_field_w := add_string(record_vision.vl_padrao);
            else
                ds_field_w := record_vision.vl_padrao;
            end if;

            ds_fields_default := ds_fields_default || record_vision.nm_atributo || ',';
            ds_values_fields_defaults := ds_values_fields_defaults || ds_field_w || ',';
        end loop;

       select	nextval('protocolo_medic_material_seq')
       into STRICT	nr_seq_iterno_w
;

       ds_sql_w := 'insert into protocolo_medic_material (' ||
                   ' cd_protocolo,
                    nr_sequencia,
                    nr_seq_diluicao,
                    nr_seq_interno,
                    nr_seq_material,
                    nr_agrupamento,
                    nm_usuario,
                    dt_atualizacao,
                    cd_material,
                    cd_unidade_medida,
                    qt_dose,
                    '  ||
                     substr(ds_fields_default, 0, length(ds_fields_default) - 1) ||
                    ')
                     values'                ||
                    ' ('                    || 
                        cd_protocolo_p      || ',' ||
                        nr_seq_protocolo_p  || ',' ||
                        nr_seq_protocolo_p  || ',' ||
                        nr_seq_iterno_w     || ',' ||
                        nr_seq_material_w   || ',' ||
                        nr_agrupamento_w    || ',' ||
                        add_string(nm_usuario_p) || ',' ||
                        'sysdate'             || ',' ||
                        cd_material_p       || ',' ||
                        add_string(cd_unidade_medida_p) || ',' ||
                        qt_dose_p           || ',' ||
                        substr(ds_values_fields_defaults, 0, length(ds_values_fields_defaults) - 1)
                        ||  ')';

        begin  
            c001 := DBMS_SQL.OPEN_CURSOR;
            DBMS_SQL.PARSE(c001, ds_sql_w, dbms_sql.native);
            retorno_w := DBMS_SQL.execute(c001);
            DBMS_SQL.CLOSE_CURSOR(c001);
        exception
        when others then
            DBMS_SQL.CLOSE_CURSOR(c001);
            RAISE EXCEPTION '%', 'ERROR in elsevier_import_red_dil_recons : ' || SQLERRM(SQLSTATE) USING ERRCODE = '45011';
        end;

    end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE elsevier_import_red_dil_recons ( cd_protocolo_p protocolo_medicacao.cd_protocolo%type, nr_seq_protocolo_p protocolo_medicacao.nr_sequencia%type, nr_seq_mat_p protocolo_medic_material.nr_seq_material%type, ie_agrupador_p protocolo_medic_material.ie_agrupador%type, nm_usuario_p intpd_fila_transmissao.nm_usuario%type, cd_material_p protocolo_medic_material.cd_material%type, cd_unidade_medida_p protocolo_medic_material.cd_unidade_medida%type, qt_dose_p protocolo_medic_material.qt_dose%type) is ds_sql_w varchar(4000) FROM PUBLIC;

