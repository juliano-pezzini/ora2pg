-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE intpd_receber_area_proced ( nr_sequencia_p bigint, xml_p xml) AS $body$
DECLARE


_ora2pg_r RECORD;
ie_conversao_w			intpd_eventos_sistema.ie_conversao%type;
nr_seq_projeto_xml_w		intpd_eventos_sistema.nr_seq_projeto_xml%type;
nr_seq_sistema_w			intpd_eventos_sistema.nr_seq_sistema%type;
ie_sistema_externo_w		varchar(15);
reg_integracao_w			gerar_int_padrao.reg_integracao_conv;
nr_seq_regra_w			conversao_meio_externo.nr_seq_regra%type;
ds_erro_w			varchar(4000);
ie_erro_w				varchar(1) := 'N';
ie_exception_w			varchar(1) := 'N';
i				integer;
qt_area_proc_w			bigint;
area_procedimento_w		area_procedimento%rowtype;

c01 CURSOR FOR
SELECT	*
from	xmltable('/STRUCTURE/PROCEDURE_AREA' passing xml_p columns
	ie_action				varchar(40)		path		'IE_ACTION',
	cd_area_procedimento		bigint		path		'CD_PROCEDURE_AREA',
	ds_area_procedimento		varchar(40)		path		'DS_PROCEDURE_AREA',
	dt_atualizacao			varchar(14)		path		'DT_UPDATE',
	nm_usuario			varchar(15)		path		'NM_USER',
	ie_origem_proced			bigint		path		'IE_SOURCE_PROCEDURE',
	cd_sistema_ant			varchar(80)		path		'NR_EXTERNAL_DOCUMENT');

c01_w	c01%rowtype;


BEGIN

/*Atualiza o status da fila para Em processamento*/

update	intpd_fila_transmissao
set	ie_status = 'R'
where	nr_sequencia = nr_sequencia_p;

commit;

begin

select	coalesce(b.ie_conversao,'I'),
	nr_seq_sistema,
	nr_seq_projeto_xml,
	nr_seq_regra_conv
into STRICT	ie_conversao_w,
	nr_seq_sistema_w,
	nr_seq_projeto_xml_w,
	nr_seq_regra_w
from	intpd_fila_transmissao a,
	intpd_eventos_sistema b
where	a.nr_seq_evento_sistema = b.nr_sequencia
and	a.nr_sequencia = nr_sequencia_p;

ie_sistema_externo_w			:=	nr_seq_sistema_w;
reg_integracao_w.nr_seq_fila_transmissao	:=	nr_sequencia_p;
reg_integracao_w.ie_envio_recebe		:=	'R';
reg_integracao_w.ie_sistema_externo		:=	ie_sistema_externo_w;
reg_integracao_w.ie_conversao		:=	ie_conversao_w;
reg_integracao_w.nr_seq_projeto_xml		:=	nr_seq_projeto_xml_w;
reg_integracao_w.nr_seq_regra_conversao	:=	nr_seq_regra_w;
reg_integracao_w.intpd_log_receb.delete;
reg_integracao_w.qt_reg_log			:=	0;

open c01;
loop
fetch c01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	begin
	ie_erro_w				:= 	'N';
	reg_integracao_w.nm_tabela		:=	'AREA_PROCEDIMENTO';
	reg_integracao_w.nm_elemento	:=	'PROCEDURE_AREA';
	reg_integracao_w.nr_seq_visao	:=	27756; /*HTML5 - Swing - CorAte_F7 - Procedimentos*/
	if (coalesce(upper(c01_w.ie_action),'INSERT') <> 'DELETE') THEN /*INSERT ou UPDATE*/
		if (coalesce(upper(c01_w.ie_action),'INSERT') = 'UPDATE') then

			select 	count(*)
			into STRICT	qt_area_proc_w
			from 	area_procedimento
			where 	cd_area_procedimento = c01_w.cd_area_procedimento;

			if (qt_area_proc_w = 0) then
				/*Código da área do procedimento inválido ou inexistente no Tasy para alteração ou exclusão do registro.*/

				intpd_gravar_log_recebimento(nr_sequencia_p,wheb_mensagem_pck.get_texto(1018653),'INTPDTASY','0004');
				ie_erro_w := 'S';
			end if;
		end if;

		if (ie_erro_w = 'N') then

			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_AREA_PROCEDIMENTO', c01_w.ds_area_procedimento, 'N', area_procedimento_w.ds_area_procedimento) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; area_procedimento_w.ds_area_procedimento := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_ATUALIZACAO', c01_w.dt_atualizacao, 'N', area_procedimento_w.dt_atualizacao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; area_procedimento_w.dt_atualizacao := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NM_USUARIO', c01_w.nm_usuario, 'N', area_procedimento_w.nm_usuario) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; area_procedimento_w.nm_usuario := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_ORIGEM_PROCED', c01_w.ie_origem_proced, 'N', area_procedimento_w.ie_origem_proced) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; area_procedimento_w.ie_origem_proced := _ora2pg_r.ds_valor_retorno_p;
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_SISTEMA_ANT', c01_w.cd_sistema_ant, 'N', area_procedimento_w.cd_sistema_ant) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; area_procedimento_w.cd_sistema_ant := _ora2pg_r.ds_valor_retorno_p;

			area_procedimento_w.nm_usuario_nrec	:= area_procedimento_w.nm_usuario;
			area_procedimento_w.dt_atualizacao_nrec	:= clock_timestamp();

			if (reg_integracao_w.qt_reg_log = 0) then

				select	max(cd_area_procedimento)
				into STRICT	area_procedimento_w.cd_area_procedimento
				from	area_procedimento
				where 	cd_area_procedimento = c01_w.cd_area_procedimento;

				if (coalesce(area_procedimento_w.cd_area_procedimento,0) > 0) then

					area_procedimento_w.cd_original := area_procedimento_w.cd_area_procedimento;

					update	area_procedimento
					set	row = area_procedimento_w
					where	cd_area_procedimento = area_procedimento_w.cd_area_procedimento;
				else
					select 	max(cd_area_procedimento) + 1
					into STRICT	area_procedimento_w.cd_area_procedimento
					from 	area_procedimento;

					area_procedimento_w.cd_original := area_procedimento_w.cd_area_procedimento;

					insert into area_procedimento values (area_procedimento_w.*);

					if (nr_seq_regra_w > 0) then
						CALL gerar_conv_meio_externo(null, 'AREA_PROCEDIMENTO', 'CD_AREA_PROCEDIMENTO', area_procedimento_w.cd_area_procedimento, c01_w.cd_sistema_ant, null, nr_seq_regra_w, 'A', area_procedimento_w.nm_usuario);
					end if;
				end if;
			end if;
		end if;

	else /*DELETE*/
		select 	count(*)
		into STRICT	qt_area_proc_w
		from 	area_procedimento
		where 	cd_area_procedimento = c01_w.cd_area_procedimento;

		if (qt_area_proc_w > 0) then

			delete	FROM area_procedimento
			where	cd_area_procedimento = c01_w.cd_area_procedimento;
		else
			/*Código da área do procedimento inválido ou inexistente no Tasy para alteração ou exclusão do registro.*/

			intpd_gravar_log_recebimento(nr_sequencia_p,wheb_mensagem_pck.get_texto(1018653),'INTPDTASY','0004');
			ie_erro_w := 'S';
		end if;

	end if;
	end;
end loop;
close c01;

exception
when others then
	begin
	ds_erro_w := substr(dbms_utility.format_error_backtrace || chr(13) || chr(10) || sqlerrm,1,4000);
	rollback;

	update	intpd_fila_transmissao
	set	ie_status 	 	= 'E',
		cd_default_message 	= CASE WHEN ds_erro_w = NULL THEN null  ELSE '0005' END ,
		ds_log 		= ds_erro_w,
		nr_doc_externo	= c01_w.cd_sistema_ant
	where	nr_sequencia 	= nr_sequencia_p;

	ie_exception_w := 'S';

	end;
end;

if (ie_exception_w = 'N') then

	if	((reg_integracao_w.qt_reg_log > 0) or (coalesce(ie_erro_w,'N') = 'S')) then
		begin
		rollback;

		update	intpd_fila_transmissao
		set	ie_status		= 'E',
			cd_default_message 	= CASE WHEN ds_erro_w = NULL THEN null  ELSE '0005' END ,
			ds_log 		= ds_erro_w,
			nr_doc_externo	= c01_w.cd_sistema_ant
		where	nr_sequencia 	= nr_sequencia_p;

		for i in 0..reg_integracao_w.qt_reg_log-1 loop
			intpd_gravar_log_recebimento(nr_sequencia_p,reg_integracao_w.intpd_log_receb[i].ds_log,'INTPDTASY',reg_integracao_w.intpd_log_receb[i].cd_default_message);
		end loop;
		end;
	else
		update	intpd_fila_transmissao
		set	ie_status		= 'S',
			cd_default_message 	= '0000',
			nr_seq_documento	= coalesce(area_procedimento_w.cd_area_procedimento, c01_w.cd_area_procedimento),
			nr_doc_externo	= c01_w.cd_sistema_ant
		where	nr_sequencia	= nr_sequencia_p;
	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE intpd_receber_area_proced ( nr_sequencia_p bigint, xml_p xml) FROM PUBLIC;

