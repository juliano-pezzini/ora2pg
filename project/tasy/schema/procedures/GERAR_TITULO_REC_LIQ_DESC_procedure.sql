-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_titulo_rec_liq_desc ( nr_titulo_p bigint, tx_desc_antecipacao_p bigint, dt_limite_desc_p timestamp, nr_seq_motivo_desc_p bigint, cd_centro_custo_p bigint, cd_pessoa_fisica_p text, cd_cgc_p text, nm_usuario_p text) AS $body$
DECLARE


vl_titulo_w		titulo_receber.vl_titulo%type;
vl_desc_prev_w		titulo_receber.vl_desc_previsto%type;
qt_tit_rec_liq_desc_w 	bigint;


BEGIN

select count(*)
into STRICT qt_tit_rec_liq_desc_w
from titulo_receber_liq_desc
where nr_titulo	= nr_titulo_p;

if coalesce(qt_tit_rec_liq_desc_w, 0) = 0 then
	insert into titulo_receber_liq_desc(
					cd_centro_custo,
					cd_cgc,
					cd_pessoa_fisica,
					dt_atualizacao,
					nm_usuario,
					nr_seq_motivo_desc,
					nr_sequencia,
					nr_titulo)
				values (cd_centro_custo_p,
					cd_cgc_p,
					cd_pessoa_fisica_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_motivo_desc_p,
					nextval('titulo_receber_liq_desc_seq'),
					nr_titulo_p);
else
	update titulo_receber_liq_desc
	set cd_centro_custo 	 = cd_centro_custo_p,
		cd_cgc 		 = cd_cgc_p,
		cd_pessoa_fisica 	 = cd_pessoa_fisica_p,
		dt_atualizacao 	 = clock_timestamp(),
		nm_usuario 	 = nm_usuario_p,
		nr_seq_motivo_desc = nr_seq_motivo_desc_p
  	where 	nr_titulo 		 = nr_titulo_p;
end if;

if (coalesce(tx_desc_antecipacao_p,0) <> 0) then

	select	a.vl_titulo
	into STRICT	vl_titulo_w
	from	titulo_receber a
	where	a.nr_titulo	= nr_titulo_p;

	vl_desc_prev_w	:=	(tx_desc_antecipacao_p/100) * vl_titulo_w;

	update	titulo_receber
	set	tx_desc_antecipacao	= tx_desc_antecipacao_p,
		vl_desc_previsto		= vl_desc_prev_w,
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp()
	where	nr_titulo			= nr_titulo_p;

end if;

if (dt_limite_desc_p IS NOT NULL AND dt_limite_desc_p::text <> '') then

	update	titulo_receber
	set	dt_limite_desconto	= dt_limite_desc_p,
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_titulo		= nr_titulo_p;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_titulo_rec_liq_desc ( nr_titulo_p bigint, tx_desc_antecipacao_p bigint, dt_limite_desc_p timestamp, nr_seq_motivo_desc_p bigint, cd_centro_custo_p bigint, cd_pessoa_fisica_p text, cd_cgc_p text, nm_usuario_p text) FROM PUBLIC;

