-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_itens_avaliacao (nr_seq_avaliacao_p bigint, nr_seq_avaliacao_dest_p bigint, nr_seq_superior_p bigint, ds_lista_p text, nm_usuario_p text) AS $body$
DECLARE



nr_sequencia_w			bigint;
nr_seq_filho_w			bigint;
nr_seq_res_w			integer;

nr_seq_item_new_w		bigint;
nr_seq_filho_item_new_w		bigint;
nr_seq_apresent_w		integer;

c01 CURSOR FOR
SELECT	nr_sequencia
from	med_item_avaliar a
where	' ' || ds_lista_p || ' ' like '% ' || a.nr_sequencia || ' %'
and	(ds_lista_p IS NOT NULL AND ds_lista_p::text <> '')
and	a.nr_seq_tipo	= nr_seq_avaliacao_p;

c02 CURSOR FOR
SELECT	nr_sequencia
from	med_item_avaliar a
where	a.nr_seq_tipo		= nr_seq_avaliacao_p
and	a.nr_seq_superior	= nr_sequencia_w;


c03 CURSOR FOR
SELECT	r.nr_seq_res
from	med_item_avaliar_res r
where	r.nr_seq_item		= nr_sequencia_w
order by
	nr_seq_res;

c04 CURSOR FOR
SELECT	r.nr_seq_res
from	med_item_avaliar_res r
where	r.nr_seq_item		= nr_seq_filho_w
order by
	nr_seq_res;



BEGIN

if (coalesce(ds_lista_p,'X') = 'X') then
	CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(189965);
end if;

if (ds_lista_p IS NOT NULL AND ds_lista_p::text <> '') then
	open c01;
	loop
	fetch c01 into
		 nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		select  coalesce(max(nr_seq_apresent),0) + 1
		into STRICT	nr_seq_apresent_w
		from	med_item_avaliar
		where	nr_seq_tipo = nr_seq_avaliacao_dest_p;

		select 	nextval('med_item_avaliar_seq')
		into STRICT 	nr_seq_item_new_w
		;


		insert into med_item_avaliar(
					NR_SEQUENCIA,
					DS_ITEM,
					NR_SEQ_TIPO,
					NR_SEQ_APRESENT,
					IE_RESULTADO,
					DT_ATUALIZACAO,
					NM_USUARIO,
					QT_DECIMAIS,
					DS_UNID_MED,
					QT_MINIMO,
					QT_MAXIMO,
					NR_SEQ_SUPERIOR,
					IE_OBRIGATORIO,
					QT_TAMANHO,
					QT_DESLOC_DIREITA,
					QT_POS_ESQUERDA,
					CD_DOMINIO,
					DS_FORMULA,
					IE_GRAFICO_AVALIACAO,
					qt_max_caracter,
					IE_READONLY,
					QT_ALTURA,
					NR_SEQ_ITEM_REF,
					IE_TIPO_CAMPO,
					DS_ARQUIVO,
					DS_MASCARA,
					DS_COMPLEMENTO,
					DS_REGRA,
					DS_COR_GRAFICO,
					DS_COR_FUNDO,
					DS_COR_FONTE,
					DS_ESTILO_FONTE,
					QT_TAM_FONTE,
					DS_ALIAS,
					VL_PADRAO,
					DS_MSG_AVISO,
					CD_LOCALIZADOR,
					DS_COR_REGRA,
					DS_COR_REGRA_MAX,
					QT_TAB_ORDER,
					IE_SITUACAO)
		SELECT	nr_seq_item_new_w,
			DS_ITEM,
			nr_seq_avaliacao_dest_p,
			nr_seq_apresent_w,
			IE_RESULTADO,
			DT_ATUALIZACAO,
			NM_USUARIO,
			QT_DECIMAIS,
			DS_UNID_MED,
			QT_MINIMO,
			QT_MAXIMO,
			nr_seq_superior_p,
			IE_OBRIGATORIO,
			QT_TAMANHO,
			QT_DESLOC_DIREITA,
			QT_POS_ESQUERDA,
			CD_DOMINIO,
			DS_FORMULA,
			IE_GRAFICO_AVALIACAO,
			qt_max_caracter,
			IE_READONLY,
			QT_ALTURA,
			NR_SEQ_ITEM_REF,
			IE_TIPO_CAMPO,
			DS_ARQUIVO,
			DS_MASCARA,
			DS_COMPLEMENTO,
			DS_REGRA,
			DS_COR_GRAFICO,
			DS_COR_FUNDO,
			DS_COR_FONTE,
			DS_ESTILO_FONTE,
			QT_TAM_FONTE,
			DS_ALIAS,
			VL_PADRAO,
			DS_MSG_AVISO,
			CD_LOCALIZADOR,
			DS_COR_REGRA,
			DS_COR_REGRA_MAX,
			QT_TAB_ORDER,
			IE_SITUACAO
		from	med_item_avaliar
		where	nr_sequencia	= nr_sequencia_w;


		open c03;
		loop
		fetch c03 into
			nr_seq_res_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
			begin

			insert into med_item_avaliar_res(
						NR_SEQ_ITEM,
						NR_SEQ_RES,
						DT_ATUALIZACAO,
						NM_USUARIO,
						DS_RESULTADO,
						QT_RESULTADO,
						NR_SEQ_ITEM_REF,
						DS_RESULT_REF)
				SELECT	nr_seq_item_new_w,
					nr_seq_res_w,
					dt_atualizacao,
					nm_usuario,
					ds_resultado,
					qt_resultado,
					nr_seq_item_ref,
					ds_result_ref
				from	med_item_avaliar_res
				where	nr_seq_item	= nr_sequencia_w
				and	nr_seq_res	= nr_seq_res_w;
			end;
		end loop;
		close c03;

		open c02;
		loop
		fetch c02 into
			nr_seq_filho_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			select  coalesce(max(nr_seq_apresent),0) + 1
			into STRICT	nr_seq_apresent_w
			from	med_item_avaliar
			where	nr_seq_tipo = nr_seq_avaliacao_dest_p;

			select 	nextval('med_item_avaliar_seq')
			into STRICT 	nr_seq_filho_item_new_w
			;


			insert into med_item_avaliar(
					NR_SEQUENCIA,
					DS_ITEM,
					NR_SEQ_TIPO,
					NR_SEQ_APRESENT,
					IE_RESULTADO,
					DT_ATUALIZACAO,
					NM_USUARIO,
					QT_DECIMAIS,
					DS_UNID_MED,
					QT_MINIMO,
					QT_MAXIMO,
					NR_SEQ_SUPERIOR,
					IE_OBRIGATORIO,
					QT_TAMANHO,
					QT_DESLOC_DIREITA,
					QT_POS_ESQUERDA,
					CD_DOMINIO,
					DS_FORMULA,
					IE_GRAFICO_AVALIACAO,
					qt_max_caracter,
					IE_READONLY,
					QT_ALTURA,
					NR_SEQ_ITEM_REF,
					IE_TIPO_CAMPO,
					DS_ARQUIVO,
					DS_MASCARA,
					DS_COMPLEMENTO,
					DS_REGRA,
					DS_COR_GRAFICO,
					DS_COR_FUNDO,
					DS_COR_FONTE,
					DS_ESTILO_FONTE,
					QT_TAM_FONTE,
					DS_ALIAS,
					VL_PADRAO,
					DS_MSG_AVISO,
					CD_LOCALIZADOR,
					DS_COR_REGRA,
					DS_COR_REGRA_MAX,
					QT_TAB_ORDER,
					IE_SITUACAO)
			SELECT	nr_seq_filho_item_new_w,
				DS_ITEM,
				nr_seq_avaliacao_dest_p,
				nr_seq_apresent_w,
				IE_RESULTADO,
				DT_ATUALIZACAO,
				NM_USUARIO,
				QT_DECIMAIS,
				DS_UNID_MED,
				QT_MINIMO,
				QT_MAXIMO,
				nr_seq_item_new_w,
				IE_OBRIGATORIO,
				QT_TAMANHO,
				QT_DESLOC_DIREITA,
				QT_POS_ESQUERDA,
				CD_DOMINIO,
				DS_FORMULA,
				IE_GRAFICO_AVALIACAO,
				qt_max_caracter,
				IE_READONLY,
				QT_ALTURA,
				NR_SEQ_ITEM_REF,
				IE_TIPO_CAMPO,
				DS_ARQUIVO,
				DS_MASCARA,
				DS_COMPLEMENTO,
				DS_REGRA,
				DS_COR_GRAFICO,
				DS_COR_FUNDO,
				DS_COR_FONTE,
				DS_ESTILO_FONTE,
				QT_TAM_FONTE,
				DS_ALIAS,
				VL_PADRAO,
				DS_MSG_AVISO,
				CD_LOCALIZADOR,
				DS_COR_REGRA,
				DS_COR_REGRA_MAX,
				QT_TAB_ORDER,
				IE_SITUACAO
			from	med_item_avaliar
			where	nr_sequencia	= nr_seq_filho_w;

			open c04;
			loop
			fetch c04 into
				nr_seq_res_w;
			EXIT WHEN NOT FOUND; /* apply on c04 */
			begin

				insert into med_item_avaliar_res(
							NR_SEQ_ITEM,
							NR_SEQ_RES,
							DT_ATUALIZACAO,
							NM_USUARIO,
							DS_RESULTADO,
							QT_RESULTADO,
							NR_SEQ_ITEM_REF,
							DS_RESULT_REF)
				SELECT	nr_seq_filho_item_new_w,
					nr_seq_res_w,
					dt_atualizacao,
					nm_usuario,
					ds_resultado,
					qt_resultado,
					nr_seq_item_ref,
					ds_result_ref
				from	med_item_avaliar_res
				where	nr_seq_item	= nr_seq_filho_w
				and	nr_seq_res	= nr_seq_res_w;
			end;
			end loop;
			close c04;


		end loop;
		close c02;

		end;
	end loop;
	close c01;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_itens_avaliacao (nr_seq_avaliacao_p bigint, nr_seq_avaliacao_dest_p bigint, nr_seq_superior_p bigint, ds_lista_p text, nm_usuario_p text) FROM PUBLIC;

