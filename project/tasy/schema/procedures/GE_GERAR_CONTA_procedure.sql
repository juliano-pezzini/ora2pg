-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ge_gerar_conta (nr_seq_interno_p text) AS $body$
DECLARE

 
 nr_prescricao_w prescr_medica.nr_prescricao%type;
 nr_seq_prescricao_w  prescr_procedimento.nr_sequencia%type;
 nr_seq_proc_interno_w prescr_procedimento.nr_seq_proc_interno%type;
 cd_procedimento_w   prescr_procedimento.cd_procedimento%type;
 ie_origem_proced_w   prescr_procedimento.ie_origem_proced%type;
 qt_procedimento_w   prescr_procedimento.qt_procedimento%type;
 cd_setor_atendimento_w prescr_procedimento.cd_setor_atendimento%type;
 ie_lado_w     prescr_procedimento.ie_lado%type;
 dt_prev_execucao_w prescr_procedimento.dt_prev_execucao%type;
 nr_seq_propaci_w  procedimento_paciente.nr_sequencia%type;
 nr_seq_agenda_w  agenda_paciente.nr_sequencia%type;


BEGIN 
 
 begin 
  select a.nr_prescricao, 
      a.nr_sequencia, 
      a.nr_seq_proc_interno, 
      a.cd_procedimento, 
      a.ie_origem_proced, 
      a.qt_procedimento, 
      a.cd_setor_atendimento,      
      coalesce(a.ie_lado, 'A'), 
      a.dt_prev_execucao, 
      coalesce(b.nr_seq_agenda, coalesce(a.nr_seq_agenda, 0)) 
  into STRICT  nr_prescricao_w, 
      nr_seq_prescricao_w, 
      nr_seq_proc_interno_w, 
      cd_procedimento_w, 
      ie_origem_proced_w, 
      qt_procedimento_w, 
      cd_setor_atendimento_w, 
      ie_lado_w, 
      dt_prev_execucao_w, 
      nr_seq_agenda_w 
  from  prescr_procedimento a, 
      prescr_medica    b 
  where a.nr_seq_interno = nr_seq_interno_p 
  and  a.nr_prescricao = b.nr_prescricao 
  and  a.dt_atualizacao_nrec > (clock_timestamp() - interval '60 days');
 
 exception 
  when no_data_found then 
   begin 
 
    select a.nr_prescricao, 
        a.nr_sequencia, 
        a.nr_seq_proc_interno, 
        a.cd_procedimento, 
        a.ie_origem_proced, 
        a.qt_procedimento, 
        a.cd_setor_atendimento,        
        coalesce(a.ie_lado, 'A'), 
        a.dt_prev_execucao, 
        coalesce(b.nr_seq_agenda, coalesce(a.nr_seq_agenda, 0)) 
    into STRICT  nr_prescricao_w, 
        nr_seq_prescricao_w, 
        nr_seq_proc_interno_w, 
        cd_procedimento_w, 
        ie_origem_proced_w, 
        qt_procedimento_w, 
        cd_setor_atendimento_w,        
        ie_lado_w, 
        dt_prev_execucao_w, 
        nr_seq_agenda_w 
    from  prescr_procedimento a, 
        prescr_medica    b 
    where a.nr_seq_interno = nr_seq_interno_p 
    and  a.nr_prescricao = b.nr_prescricao;
 
   exception 
    when no_data_found then 
     CALL Wheb_mensagem_pck.exibir_mensagem_abort(994594, 'NR_SEQ_INTERNO_P=' || nr_seq_interno_p);
   end;
 end;
 
 if (coalesce(nr_prescricao_w, 0) > 0) and (coalesce(nr_seq_prescricao_w, 0) > 0) then 
   
  select coalesce(max(nr_sequencia), 0) 
  into STRICT  nr_seq_propaci_w 
  from  procedimento_paciente 
  where nr_prescricao = nr_prescricao_w 
  and  nr_sequencia_prescricao = nr_seq_prescricao_w;
 
  if (nr_seq_propaci_w = 0) then 
   begin 
    CALL Gerar_Proc_Pac_item_Prescr(nr_prescricao_w, 
                  nr_seq_prescricao_w, 
                  null, 
                  null, 
                  nr_seq_proc_interno_w, 
                  cd_procedimento_w, 
                  ie_origem_proced_w, 
                  qt_procedimento_w, 
                  cd_setor_atendimento_w, 
                  9, 
                  dt_prev_execucao_w, 
                  'GE_Centricity', 
                  null, 
                  null, 
                  ie_lado_w, 
                  null);
   end;
  end if;
   
  update prescr_procedimento 
  set  ie_status_execucao = 20, 
      cd_motivo_baixa  = 1, 
      dt_baixa      = clock_timestamp() 
  where nr_prescricao = nr_prescricao_w 
  and  nr_sequencia = nr_seq_prescricao_w 
  and  coalesce(ie_status_execucao, 0) < 20;
		 
	commit;
 end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ge_gerar_conta (nr_seq_interno_p text) FROM PUBLIC;

