-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ageweb_gerar_horarios_medicos ( cd_agenda_p bigint, cd_profissional_p text, cd_tipo_agenda_p bigint, dt_agenda_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

	 
ie_feriado_w				varchar(1);
ie_gerar_sobra_horario_w	varchar(1);
ds_retorno_w				varchar(255);
	

BEGIN 
 
if (cd_agenda_p IS NOT NULL AND cd_agenda_p::text <> '') then 
	if (cd_tipo_agenda_p = 3) then 
		delete	FROM ageweb_consulta_medico 
		where	cd_profissional = cd_profissional_p;
		 
		select	coalesce(max(ie_feriado),'N'), 
			coalesce(max(ie_gerar_sobra_horario),'N') 
		into STRICT	ie_feriado_w, 
			ie_gerar_sobra_horario_w 
		from	agenda 
		where	cd_agenda = cd_agenda_p;
		 
		ds_retorno_w := Horario_Livre_Consulta( 
					cd_estabelecimento_p, cd_agenda_p, ie_feriado_w, dt_agenda_p, nm_usuario_p, 'S', ie_gerar_sobra_horario_w, 'N', 0, ds_retorno_w);
					 
		insert	into ageweb_consulta_medico( 
						cd_agenda,        
						cd_profissional, 
						dt_agenda,        
						dt_atualizacao,      
						dt_atualizacao_nrec, 
						ie_status_agenda,     
						nm_paciente,       
						nm_usuario,        
						nm_usuario_nrec, 
						nr_prontuario, 
						ie_classif_agenda, 
						ds_convenio, 
						nr_telefone)     
					SELECT	cd_agenda, 
						cd_profissional_p, 
						dt_agenda, 
						clock_timestamp(), 
						clock_timestamp(), 
						ie_status_agenda, 
						substr(nm_paciente,1,60), 
						nm_usuario_p, 
						nm_usuario_p, 
						obter_prontuario_pf(cd_estabelecimento_p, cd_pessoa_fisica), 
						ie_classif_agenda, 
						obter_desc_convenio(cd_convenio), 
						substr(nr_telefone,1, length(nr_telefone)) 
					from	agenda_consulta 
					where	cd_agenda = cd_agenda_p 
					and	dt_agenda between trunc(dt_agenda_p) and trunc(dt_agenda_p) + 86399/86400;	
	elsif (cd_tipo_agenda_p = 2) then 
		 
		delete	FROM ageweb_consulta_medico 
		where	cd_profissional = cd_profissional_p;
		 
		CALL gerar_horario_agenda_exame( 
					cd_estabelecimento_p, 
					cd_agenda_p, 
					dt_agenda_p, 
					nm_usuario_p);
		 
		insert	into ageweb_consulta_medico( 
						cd_agenda,        
						cd_profissional, 
						dt_agenda,        
						dt_atualizacao,      
						dt_atualizacao_nrec, 
						ie_status_agenda,     
						nm_paciente,       
						nm_usuario,        
						nm_usuario_nrec, 
						ds_procedimento, 
						nr_prontuario, 
						ds_convenio, 
						nr_telefone)     
					SELECT	cd_agenda, 
						cd_profissional_p, 
						hr_inicio, 
						clock_timestamp(), 
						clock_timestamp(), 
						ie_status_agenda, 
						substr(nm_paciente,1,60), 
						nm_usuario_p, 
						nm_usuario_p, 
						substr(obter_exame_agenda(cd_procedimento, ie_origem_proced, nr_seq_proc_interno),1,240), 
						obter_prontuario_pf(cd_estabelecimento_p, cd_pessoa_fisica), 
						obter_desc_convenio(cd_convenio), 
						substr(nr_telefone,1, length(nr_telefone)) 
					from	agenda_paciente 
					where	cd_agenda = cd_agenda_p 
					and	hr_inicio between trunc(dt_agenda_p) and trunc(dt_agenda_p) + 86399/86400 
					and	((cd_medico_exec = cd_profissional_p) or (coalesce(cd_medico_exec::text, '') = ''));
	elsif (cd_tipo_agenda_p = 5) then 
		 
		delete	FROM ageweb_consulta_medico 
		where	cd_profissional = cd_profissional_p;
		 
		CALL gerar_horario_agenda_servico( 
					cd_estabelecimento_p, 
					cd_agenda_p, 
					dt_agenda_p, 
					nm_usuario_p);
		 
		insert	into ageweb_consulta_medico( 
						cd_agenda,        
						cd_profissional, 
						dt_agenda,        
						dt_atualizacao,      
						dt_atualizacao_nrec, 
						ie_status_agenda,     
						nm_paciente,       
						nm_usuario,        
						nm_usuario_nrec, 
						ds_procedimento, 
						nr_prontuario, 
						ds_convenio, 
						nr_telefone)     
					SELECT	cd_agenda, 
						cd_profissional_p, 
						dt_agenda, 
						clock_timestamp(), 
						clock_timestamp(), 
						ie_status_agenda, 
						substr(nm_paciente,1,60), 
						nm_usuario_p, 
						nm_usuario_p, 
						substr(coalesce(obter_desc_proc_interno(nr_seq_proc_interno), obter_descricao_procedimento(cd_procedimento, ie_origem_proced)),1,240), 
						obter_prontuario_pf(cd_estabelecimento_p, cd_pessoa_fisica), 
						obter_desc_convenio(cd_convenio), 
						substr(nr_telefone,1, length(nr_telefone)) 
					from	agenda_consulta 
					where	cd_agenda = cd_agenda_p 
					and	dt_agenda between trunc(dt_agenda_p) and trunc(dt_agenda_p) + 86399/86400;
	end if;
	 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageweb_gerar_horarios_medicos ( cd_agenda_p bigint, cd_profissional_p text, cd_tipo_agenda_p bigint, dt_agenda_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

