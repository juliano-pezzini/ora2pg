-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alterar_tabela_preco_sca ( nr_seq_vinculo_sca_p bigint, nr_seq_tabela_p bigint, dt_alteracao_sca_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

			 
nr_seq_segurado_w	bigint;
nr_seq_plano_sca_w	bigint;
nr_seq_tabela_ant_w	bigint;
nr_seq_contrato_w	bigint;
nm_tabela_ant_w		varchar(255);
nm_tabela_nova_w	varchar(255);
ds_plano_w		varchar(255);
ds_historico_w		varchar(4000);
ds_erro_w		varchar(4000);


BEGIN 
 
select	nr_seq_segurado, 
	nr_seq_plano, 
	nr_seq_tabela 
into STRICT	nr_seq_segurado_w, 
	nr_seq_plano_sca_w, 
	nr_seq_tabela_ant_w 
from	pls_sca_vinculo 
where	nr_sequencia	= nr_seq_vinculo_sca_p;
 
select	nm_tabela 
into STRICT	nm_tabela_ant_w 
from	pls_tabela_preco 
where	nr_sequencia	= nr_seq_tabela_ant_w;
 
select	nm_tabela 
into STRICT	nm_tabela_nova_w 
from	pls_tabela_preco 
where	nr_sequencia	= nr_seq_tabela_p;
 
select	max(nr_seq_contrato) 
into STRICT	nr_seq_contrato_w 
from	pls_segurado 
where	nr_sequencia	= nr_seq_segurado_w;
 
select	substr(ds_plano,1,255) 
into STRICT	ds_plano_w 
from	pls_plano	 
where	nr_sequencia	= nr_seq_plano_sca_w;
 
ds_historico_w	:= 'Alterada a tabela de preço do SCA -> ' || ds_plano_w || ' de ' || nr_seq_tabela_ant_w || ' - ' || nm_tabela_ant_w || 
			' para ' || nr_seq_tabela_p || ' - ' ||nm_tabela_nova_w;
			 
/*Consisitir a nova tabela de preço do beneficiário*/
 
ds_erro_w := pls_consistir_plano_sca(nr_seq_segurado_w, nr_seq_plano_sca_w, nr_seq_tabela_p, null, cd_estabelecimento_p, ds_erro_w);
 
if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(191805,'DS_ERRO='||ds_erro_w);
end if;	
 
update	pls_sca_vinculo 
set	nr_seq_tabela	= nr_seq_tabela_p, 
	dt_atualizacao	= clock_timestamp(), 
	nm_usuario	= nm_usuario_p 
where	nr_sequencia	= nr_seq_vinculo_sca_p;
 
/*Duplicar a tabela de preço*/
 
CALL pls_duplicar_tabela_preco_sca(nr_seq_contrato_w,nr_seq_vinculo_sca_p,nr_seq_tabela_p,'N',nm_usuario_p);
 
/*Gerar o valor da tabela de preço*/
 
CALL pls_gerar_valor_tabela_sca(nr_seq_segurado_w,nr_seq_vinculo_sca_p,'A',dt_alteracao_sca_p,nm_usuario_p,cd_estabelecimento_p);
 
/*Gerar o histórico de alteração*/
 
CALL pls_gerar_segurado_historico(	nr_seq_segurado_w, '36', clock_timestamp(), ds_historico_w, 
				'pls_alterar_tabela_preco_sca', null, null, null, 
				null, null, null, null, 
				null, null, null, null, 
				nm_usuario_p, 'N');		
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alterar_tabela_preco_sca ( nr_seq_vinculo_sca_p bigint, nr_seq_tabela_p bigint, dt_alteracao_sca_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

