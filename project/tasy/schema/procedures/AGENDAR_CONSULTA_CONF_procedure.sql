-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE agendar_consulta_conf ( nr_seq_atendimento_p bigint, nr_seq_agenda_p bigint) AS $body$
DECLARE



cd_pessoa_fisica_w		varchar(10);
cd_classif_agenda_w		varchar(5);
cd_convenio_w			integer;
cd_categoria_w			varchar(10);
cd_usuario_convenio_w	varchar(30);
dt_validade_carteira_w	timestamp;
nr_doc_convenio_w		varchar(20);
cd_tipo_acomodacao_w	smallint;
cd_plano_w				varchar(10);
ds_obs_w				varchar(255);
ie_forma_convenio_w		varchar(5);
ie_status_agenda_w		varchar(1);


BEGIN

ie_forma_convenio_w	:= Obter_Valor_Param_Usuario(821, 6, obter_perfil_ativo, obter_usuario_ativo, obter_estabelecimento_ativo);

if (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') and (nr_seq_atendimento_p IS NOT NULL AND nr_seq_atendimento_p::text <> '') then

		select 	cd_pessoa_fisica
		into STRICT 	cd_pessoa_fisica_w
		from 	atendimento_paciente
		where 	nr_atendimento = nr_seq_atendimento_p;

		select ie_status_agenda
		into STRICT ie_status_agenda_w
		from agenda_consulta
		where nr_sequencia = nr_seq_agenda_p;

	if (ie_status_agenda_w = 'L') then

		if (ie_forma_convenio_w IS NOT NULL AND ie_forma_convenio_w::text <> '') and (ie_forma_convenio_w <> 'N') then
			SELECT * FROM Gerar_Convenio_Agendamento(	cd_pessoa_fisica_w, 3, nr_seq_agenda_p, ie_forma_convenio_w, cd_convenio_w, cd_categoria_w, cd_usuario_convenio_w, dt_validade_carteira_w, nr_doc_convenio_w, cd_tipo_acomodacao_w, cd_plano_w, obter_usuario_ativo, ds_obs_w) INTO STRICT cd_convenio_w, cd_categoria_w, cd_usuario_convenio_w, dt_validade_carteira_w, nr_doc_convenio_w, cd_tipo_acomodacao_w, cd_plano_w, ds_obs_w;
		end if;

		update	agenda_consulta
		set		cd_pessoa_fisica		= cd_pessoa_fisica_w,
				nm_paciente				= substr(obter_nome_pf(cd_pessoa_fisica_w),1,40),
				ie_status_agenda		= 'CN',
				ie_classif_agenda 		= CASE WHEN cd_classif_agenda_w = NULL THEN ie_classif_agenda  ELSE cd_classif_agenda_w END ,
				nr_telefone				= obter_fone_pac_agenda(cd_pessoa_fisica_w),
				cd_convenio				= coalesce(cd_convenio_w,cd_convenio),
				cd_categoria			= coalesce(cd_categoria_w,cd_categoria),
				cd_plano				= coalesce(cd_plano_w,cd_plano),
				cd_usuario_convenio		= coalesce(cd_usuario_convenio_w,cd_usuario_convenio),
				dt_validade_carteira	= coalesce(dt_validade_carteira_w,dt_validade_carteira),
				nr_doc_convenio			= coalesce(nr_doc_convenio_w,nr_doc_convenio),
				cd_tipo_acomodacao		= coalesce(cd_tipo_acomodacao_w,cd_tipo_acomodacao),
				nm_usuario				= obter_usuario_ativo,
				nm_usuario_origem		= obter_usuario_ativo,
				dt_atualizacao			= clock_timestamp(),
				nr_atendimento			= nr_seq_atendimento_p
		where	nr_sequencia			= nr_seq_agenda_p;
	end if;

commit;

end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE agendar_consulta_conf ( nr_seq_atendimento_p bigint, nr_seq_agenda_p bigint) FROM PUBLIC;

