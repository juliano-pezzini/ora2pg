-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atend_unid_befpost_abort_js ( nr_seq_agrupamento_p bigint, cd_tipo_acomod_conv_p bigint, ie_tipo_acomod_convenio_p text, cd_estabelecimento_p bigint, cd_categoria_p text, ie_acomod_lib_categ_p text, cd_tipo_acomodacao_p bigint, ie_tipo_atendimento_p bigint, ie_setor_acomod_p text, ie_insert_p text, cd_pessoa_fisica_p text, cd_unidade_compl_p text, cd_unidade_basica_p text, nr_atendimento_p bigint, cd_convenio_p bigint, cd_plano_p text, cd_setor_atendimento_p bigint, ie_edicao_p text, dt_saida_p timestamp, dt_saida_old_p timestamp, nm_usuario_p text, ds_msg_abort_p INOUT text) AS $body$
DECLARE

 
ie_cont_faixa_etaria_w	varchar(1);
ie_permite_unidade_w	varchar(1);
ie_acomod_lib_w		varchar(1);
qt_setor_agrup_w	bigint;
ds_agrupamento_w	varchar(255);
ds_setor_atendimento_w	varchar(100);
					

BEGIN 
 
if (ie_edicao_p = 'S') then 
 
	if (dt_saida_p <> dt_saida_old_p) then 
	 
		ds_msg_abort_p := substr(wheb_mensagem_pck.get_texto(96387, null),1,255);
		goto final;
	end if;
 
end if;
 
ds_msg_abort_p := consiste_regra_horario_plano(nr_atendimento_p, cd_convenio_p, cd_plano_p, cd_setor_atendimento_p, ds_msg_abort_p, null);
if (ds_msg_abort_p IS NOT NULL AND ds_msg_abort_p::text <> '') then 
	goto final;
end if;
 
select	max(ie_controle_faixa_etaria) 
into STRICT 	ie_cont_faixa_etaria_w 
from	unidade_atendimento 
where	cd_setor_atendimento = cd_setor_atendimento_p 
and	cd_unidade_basica = cd_unidade_basica_p 
and	cd_unidade_compl = cd_unidade_compl_p;
 
if (ie_cont_faixa_etaria_w = 'S') then 
	ie_permite_unidade_w := consiste_se_faixa_etaria_pac(cd_pessoa_fisica_p, cd_setor_atendimento_p, ie_permite_unidade_w);
	if (coalesce(ie_permite_unidade_w,'S') = 'N') then 
		ds_msg_abort_p := substr(wheb_mensagem_pck.get_texto(230835, null),1,255);
		goto final;
	end if;
end if;
 
 
if	((ie_insert_p = 'S') or (ie_edicao_p = 'S')) and (ie_setor_acomod_p <> 'S') and (ie_tipo_atendimento_p = 1) and (coalesce(cd_tipo_acomodacao_p,0) = 0) then 
	ds_msg_abort_p := substr(wheb_mensagem_pck.get_texto(96521, null),1,255);
	goto final;
end if;
 
if (ie_acomod_lib_categ_p = 'A') then 
	ie_acomod_lib_w:= obter_se_acomod_lib_estab(cd_convenio_p,cd_categoria_p,cd_tipo_acomodacao_p,cd_estabelecimento_p);
	 
	if (ie_acomod_lib_w = 'N') then 
		ds_msg_abort_p := substr(wheb_mensagem_pck.get_texto(96534, null),1,255);
		goto final;
	end if;
end if;
 
if (ie_tipo_acomod_convenio_p = 'S') and (cd_tipo_acomod_conv_p <> cd_tipo_acomodacao_p) then 
	ds_msg_abort_p := substr(wheb_mensagem_pck.get_texto(96535, null),1,255);
	goto final;
end if;
 
if (coalesce(nr_seq_agrupamento_p,0) > 0) then 
	 
	select 	count(*) 
	into STRICT	qt_setor_agrup_w 
	from	setor_atendimento 
	where	nr_seq_agrupamento = nr_seq_agrupamento_p 
	and	cd_setor_atendimento = cd_setor_atendimento_p;
	if (qt_setor_agrup_w = 0) then 
		select 	substr(obter_desc_agrup_setor(nr_seq_agrupamento_p),1,255), 
            substr(obter_nome_setor(cd_setor_atendimento_p),1,100) 
		into STRICT	ds_agrupamento_w, 
			ds_setor_atendimento_w 
;
		if (ds_agrupamento_w IS NOT NULL AND ds_agrupamento_w::text <> '') and (ds_setor_atendimento_w IS NOT NULL AND ds_setor_atendimento_w::text <> '') then 
			ds_msg_abort_p := substr(wheb_mensagem_pck.get_texto(307869, 'DS_SETOR='||ds_setor_atendimento_w ||';DS_AGRUPAMENTO=' ||ds_agrupamento_w),1,255);
			goto final;
		end if;
	end if;
end if;
 
if (ie_insert_p = 'S') then 
	ds_msg_abort_p := regra_alterar_local_status(nr_atendimento_p, 'GA', nm_usuario_p, ds_msg_abort_p, null);
	if (ds_msg_abort_p IS NOT NULL AND ds_msg_abort_p::text <> '') then 
		goto final;
	end if;
end if;
 
<<final>> 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atend_unid_befpost_abort_js ( nr_seq_agrupamento_p bigint, cd_tipo_acomod_conv_p bigint, ie_tipo_acomod_convenio_p text, cd_estabelecimento_p bigint, cd_categoria_p text, ie_acomod_lib_categ_p text, cd_tipo_acomodacao_p bigint, ie_tipo_atendimento_p bigint, ie_setor_acomod_p text, ie_insert_p text, cd_pessoa_fisica_p text, cd_unidade_compl_p text, cd_unidade_basica_p text, nr_atendimento_p bigint, cd_convenio_p bigint, cd_plano_p text, cd_setor_atendimento_p bigint, ie_edicao_p text, dt_saida_p timestamp, dt_saida_old_p timestamp, nm_usuario_p text, ds_msg_abort_p INOUT text) FROM PUBLIC;

