-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE avisar_aprovacoes_pendentes () AS $body$
DECLARE

 
nr_ordem_compra_w		bigint;
ds_comunicado_w			varchar(4000);
ds_titulo_w			varchar(255);
nm_usuario_destino_w		varchar(255);
nm_usuario_comprador_w		varchar(15);
nr_sequencia_w			bigint;
nr_seq_classif_w			bigint;
ds_cargo_w			varchar(100);
ds_aprovador_w			varchar(2000);

c01 CURSOR FOR 
SELECT	distinct 
	c.nr_ordem_compra 
from	ordem_compra a, 
	processo_aprov_compra b, 
	ordem_compra_item c 
where	trunc(a.dt_liberacao,'dd') < trunc(clock_timestamp(),'dd') 
and	coalesce(a.dt_aprovacao::text, '') = '' 
and	coalesce(a.dt_baixa::text, '') = '' 
and	coalesce(a.nr_seq_motivo_cancel::text, '') = '' 
and	a.nr_ordem_compra = c.nr_ordem_compra 
and	b.nr_sequencia = c.nr_seq_aprovacao 
and	b.ie_aprov_reprov = 'P' 
order by c.nr_ordem_compra;

c02 CURSOR FOR 
SELECT	distinct 
	substr(obter_desc_cargo(b.cd_cargo),1,100) ds_cargo 
from	ordem_compra_item c, 
	processo_aprov_compra b, 
	ordem_compra a 
where	trunc(a.dt_liberacao,'dd') < trunc(clock_timestamp(),'dd') 
and	coalesce(a.dt_aprovacao::text, '') = '' 
and	coalesce(a.dt_baixa::text, '') = '' 
and	a.nr_ordem_compra = c.nr_ordem_compra 
and	b.nr_sequencia = c.nr_seq_aprovacao 
and	b.ie_aprov_reprov = 'P' 
and	a.nr_ordem_compra = nr_ordem_compra_w 
order by ds_cargo;

BEGIN
 
nm_usuario_destino_w	:= null;
nm_usuario_comprador_w	:= null;
ds_titulo_w		:= wheb_mensagem_pck.get_texto(297613)/*Aviso de Aprovação Pendente*/
;
 
select	obter_classif_comunic('F') 
into STRICT	nr_seq_classif_w
;
 
open	c01;	
loop 
fetch	C01 into 
	nr_ordem_compra_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	ds_aprovador_w := null;
 
	open	c02;
	loop	 
	fetch	c02 into 
		ds_cargo_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */	
		ds_aprovador_w := ds_aprovador_w || ds_cargo_w || chr(10) || chr(13);
	end loop;
	close	c02;
	 
	select	coalesce(max(a.nm_usuario),'X') 
	into STRICT 	nm_usuario_comprador_w 
	from	usuario a, 
		ordem_compra b 
	where	a.cd_pessoa_fisica = b.cd_comprador 
	and	b.nr_ordem_compra = nr_ordem_compra_w;
 
	if	nm_usuario_comprador_w <> ('X') then 
 
		nm_usuario_destino_w	:= nm_usuario_comprador_w || ', ';
		 
		/*A seguinte ordem de compra encontra-se pendente para aprovação: #@NR_ORDEM_COMPRA#@. Pelo(s) cargo(s) abaixo: 
		#@DS_APROVADORES#@*/
 
		ds_comunicado_w		:= wheb_mensagem_pck.get_texto(297614, 
						'NR_ORDEM_COMPRA=' || nr_ordem_compra_w || ';DS_APROVADORES=' || ds_aprovador_w);	
 
		select	nextval('comunic_interna_seq') 
		into STRICT	nr_sequencia_w 
		;
 
		insert into comunic_interna( 
			dt_comunicado, ds_titulo, ds_comunicado, nm_usuario, 
			dt_atualizacao, ie_geral, nm_usuario_destino, nr_sequencia, 
			ie_gerencial, nr_seq_classif, dt_liberacao) 
		values ( 
			clock_timestamp(), ds_titulo_w, ds_comunicado_w, substr(elimina_acentuacao(wheb_mensagem_pck.get_texto(297615)),1,15) /*Aprovacoes*/
, 
			clock_timestamp(), 'N', nm_usuario_destino_w, nr_sequencia_w, 'N', 
			nr_seq_classif_w, clock_timestamp());
	end if;
	end;
end loop;
close	c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE avisar_aprovacoes_pendentes () FROM PUBLIC;

