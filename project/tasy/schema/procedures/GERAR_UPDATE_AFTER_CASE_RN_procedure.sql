-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_update_after_case_rn ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, nm_pessoa_fisica_p text, ds_sobrenome_pf_p text, nr_seq_tipo_admissao_fat_p atendimento_paciente.nr_seq_tipo_admissao_fat%type, nr_seq_classificacao_p atendimento_paciente.nr_seq_classificacao%type, nr_seq_queixa_p atendimento_paciente.nr_seq_queixa%type, nr_seq_classif_esp_p atendimento_paciente.nr_seq_classif_esp%type, ie_tipo_atendimento_p text, cd_procedencia_p atendimento_paciente.cd_procedencia%type, cd_departamento_p atend_paciente_unidade.cd_departamento%type, nr_sequencia_nasc_p nascimento.nr_sequencia%type) AS $body$
DECLARE



is_name_feature_w	varchar(1);
cd_pessoa_fisica_w	pessoa_fisica.cd_pessoa_fisica%type;
cd_pessoa_fisica_mae_w	pessoa_fisica.cd_pessoa_fisica%type;
nr_seq_person_name_w	person_name.nr_sequencia%type;
dt_nascimento_rn_w	timestamp;
ie_sexo_rn_w		nascimento.ie_sexo%type;
nr_atendimento_mae_w	atendimento_paciente.nr_atendimento_mae%type;
ds_name_rn_w		varchar(255);
ds_surname_rn_w		varchar(255);
qt_nasc_vivos_w		integer;
qt_atendimentos_mae_ww	integer;
ie_numeracao_rn_w	varchar(1);


BEGIN

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
	
	   is_name_feature_w := coalesce(substr(obter_valor_param_usuario(0, 213, null, null, null),1,1),'N');
	
	   select  max(cd_pessoa_fisica),
		   max(nr_atendimento_mae)
	   into STRICT	   cd_pessoa_fisica_w,
		   nr_atendimento_mae_w
	   from    atendimento_paciente
	   where   nr_atendimento = nr_atendimento_p;
	
	   if (nr_sequencia_nasc_p IS NOT NULL AND nr_sequencia_nasc_p::text <> '') then
		select	max(dt_nascimento),
			max(ie_sexo)
		into STRICT	dt_nascimento_rn_w,
			ie_sexo_rn_w
		from	nascimento
		where	nr_atendimento	= nr_atendimento_mae_w
		and	nr_sequencia	= nr_sequencia_nasc_p;	
		
		update pessoa_fisica
		set    ie_sexo = coalesce(ie_sexo_rn_w, ie_sexo),
		       dt_nascimento = coalesce(dt_nascimento_rn_w, dt_nascimento)
		where  cd_pessoa_fisica = cd_pessoa_fisica_w;
	   end if;
	
	   if (is_name_feature_w <> 'N') then
		select max(nr_seq_person_name)
		into STRICT   nr_seq_person_name_w
		from   pessoa_fisica
		where  cd_pessoa_fisica = cd_pessoa_fisica_w;
		
		if (nm_pessoa_fisica_p IS NOT NULL AND nm_pessoa_fisica_p::text <> '') and (ds_sobrenome_pf_p IS NOT NULL AND ds_sobrenome_pf_p::text <> '') then		
		    update person_name
		    set	ds_given_name  = nm_pessoa_fisica_p,
		        ds_family_name = ds_sobrenome_pf_p
		    where nr_sequencia = nr_seq_person_name_w;
		    			
		    update pessoa_fisica
		    set    nm_pessoa_fisica = nm_pessoa_fisica_p ||' '||ds_sobrenome_pf_p
		    where  nr_seq_person_name = nr_seq_person_name_w
		    and    cd_pessoa_fisica = cd_pessoa_fisica_w;
		else
			select	coalesce(max(qt_nasc_vivos),0)
			into STRICT	qt_nasc_vivos_w
			from	parto
			where	nr_atendimento = nr_atendimento_mae_w;
			
			select	count(*)
			into STRICT	qt_atendimentos_mae_ww
			from	nascimento
			where	nr_atendimento	= nr_atendimento_mae_w;
			
			select 	coalesce(max(ie_numeracao_rn),'R')
			into STRICT	ie_numeracao_rn_w
			from	parametro_medico
			where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;
			
			ds_name_rn_w := Wheb_mensagem_pck.get_texto(308831)|| ' '; --'RN de ';
			
			if (qt_nasc_vivos_w > 1) or (qt_atendimentos_mae_ww > 1)then
				if (ie_numeracao_rn_w = 'R') then
					ds_name_rn_w :=  wheb_mensagem_pck.get_texto(308832) || ' ' /*'RN '*/ || converte_numero_romano(nr_sequencia_nasc_p) || ' ' || wheb_mensagem_pck.get_texto(308483) || ' '; --' de ';
				else
					ds_name_rn_w :=  wheb_mensagem_pck.get_texto(308832) || ' ' /*'RN '*/ || nr_sequencia_nasc_p || ' ' || wheb_mensagem_pck.get_texto(308483) || ' '; --' de ';
				end if;
			end if;

			select 	max(cd_pessoa_fisica)
			into STRICT	cd_pessoa_fisica_mae_w
			from	atendimento_paciente
			where   nr_atendimento = nr_atendimento_mae_w;
			
			select max(nm_pessoa_fisica)
			into STRICT   ds_surname_rn_w
			from   pessoa_fisica
			where  cd_pessoa_fisica = cd_pessoa_fisica_mae_w;

			update person_name
			set	ds_given_name  = ds_name_rn_w,
				ds_family_name = ds_surname_rn_w
			where nr_sequencia = nr_seq_person_name_w;
		end if;
	   end if;

	if (cd_departamento_p IS NOT NULL AND cd_departamento_p::text <> '') then
	    update atend_paciente_unidade a
	    set    a.cd_departamento = cd_departamento_p
	    where  a.nr_atendimento  = nr_atendimento_p
	    and	   a.nr_sequencia = (SELECT max(b.nr_sequencia)
				     from   atend_paciente_unidade b
				     where  b.nr_atendimento  = nr_atendimento_p
				     and    coalesce(b.dt_saida_unidade::text, '') = '');
	end if;
	
	update atendimento_paciente
	set nr_seq_tipo_admissao_fat = coalesce(nr_seq_tipo_admissao_fat_p, nr_seq_tipo_admissao_fat),
	    nr_seq_classificacao     = coalesce(nr_seq_classificacao_p, nr_seq_classificacao),
	    nr_seq_queixa 	     = coalesce(nr_seq_queixa_p, nr_seq_queixa),
	    nr_seq_classif_esp       = coalesce(nr_seq_classif_esp_p, nr_seq_classif_esp),
	    ie_tipo_atendimento      = coalesce(ie_tipo_atendimento_p, ie_tipo_atendimento),
	    cd_procedencia           = coalesce(cd_procedencia_p, cd_procedencia)
	where nr_atendimento = nr_atendimento_p;


	commit;
end if;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_update_after_case_rn ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, nm_pessoa_fisica_p text, ds_sobrenome_pf_p text, nr_seq_tipo_admissao_fat_p atendimento_paciente.nr_seq_tipo_admissao_fat%type, nr_seq_classificacao_p atendimento_paciente.nr_seq_classificacao%type, nr_seq_queixa_p atendimento_paciente.nr_seq_queixa%type, nr_seq_classif_esp_p atendimento_paciente.nr_seq_classif_esp%type, ie_tipo_atendimento_p text, cd_procedencia_p atendimento_paciente.cd_procedencia%type, cd_departamento_p atend_paciente_unidade.cd_departamento%type, nr_sequencia_nasc_p nascimento.nr_sequencia%type) FROM PUBLIC;

