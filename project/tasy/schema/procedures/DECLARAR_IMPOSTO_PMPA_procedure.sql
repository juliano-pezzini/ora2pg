-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE declarar_imposto_pmpa (dt_mesano_ref_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_conteudo_w	varchar(212);
dt_mesano_ref_w	timestamp;

c01 CURSOR FOR
SELECT	lpad(0,8,0)||--definir
	lpad(0,6,0)||--definir
	12||
	lpad(0,9,0)||
	'N'||
	lpad(to_char(dt_emissao,'yyyymmdd'),8,0)||
	lpad(0,8,0)||
	1||
	lpad(substr(a.cd_serie_nf,1,5),5,0)||
	lpad(substr(a.nr_nota_fiscal,1,6),6,0)||
	0||
	lpad(somente_numero(to_char(coalesce(a.vl_total_nota,0),'999999999990.00')),14,'0')||
	lpad(somente_numero(to_char(coalesce(b.vl_base_calculo,0),'999999999990.00')),14,'0')||
	lpad(0,3,0)|| --Verificar aliquota do tributo
	lpad(0,14,0)||
	lpad(0,12,0)|| -- Verificar quem é o fornecedor
	lpad(0,14,0)||
	'CC'||
	lpad(0,8,0)||
	lpad(0,3,0)||
	lpad(0,14,0)||
	lpad(0,14,0)||
	lpad(0,14,0)||
	lpad(0,14,0)||
	lpad(0,3,0)
from	tributo c,
	nota_fiscal_trib b,
	nota_fiscal a
where	c.ie_tipo_tributo	= 'ISS'
and	b.cd_tributo		= c.cd_tributo
and	a.nr_sequencia		= b.nr_sequencia
and	trunc(a.dt_entrada_saida,'month')	= dt_mesano_ref_w;
/*union all
select	lpad(0,8,0)||--definir
	lpad(0,6,0)||--definir
	12||
	lpad(0,9,0)||
	'N'||
	lpad(0,8,0)||
	1||
	lpad(0,5,0)||
	lpad(0,6,0)||
	0||
	lpad(0,14,0)||
	lpad(0,14,0)||
	lpad(0,3,0)|| --Verificar aliquota do tributo
	lpad(0,14,0)||
	lpad(0,12,0)|| -- Verificar quem é o fornecedor
	lpad(0,14,0)||
	'CC'||
	lpad(0,12,0)||
	lpad(0,8,0)||
	lpad(0,3,0)||
	lpad(0,14,0)||
	lpad(0,14,0)||
	lpad(0,14,0)||
	lpad(0,14,0)||
	lpad(0,3,0)
from	tributo d,
	repasse_terc_venc_trib c,
	repasse_terceiro_venc b,
	repasse_terceiro a
where	d.ie_tipo_tributo	= 'ISS'
and	c.cd_tributo		= d.cd_tributo
and	b.nr_sequencia		= c.nr_seq_rep_venc
and	a.nr_repasse_terceiro	= b.nr_repasse_terceiro
and	trunc(a.dt_mesano_referencia,'month')	= dt_mesano_ref_w;*/
BEGIN

delete	from w_envio_banco
where	nm_usuario	= nm_usuario_p;

dt_mesano_ref_w	:= trunc(dt_mesano_ref_p,'month');

open	c01;
loop
fetch	c01 into
	ds_conteudo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	insert	into w_envio_banco(cd_estabelecimento,
		ds_conteudo,
		dt_atualizacao,
		dt_atualizacao_nrec,
		nm_usuario,
		nm_usuario_nrec,
		nr_sequencia)
	values (cd_estabelecimento_p,
		ds_conteudo_w,
		clock_timestamp(),
		clock_timestamp(),
		nm_usuario_p,
		nm_usuariO_p,
		nextval('w_envio_banco_seq'));

end	loop;
close	c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE declarar_imposto_pmpa (dt_mesano_ref_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

