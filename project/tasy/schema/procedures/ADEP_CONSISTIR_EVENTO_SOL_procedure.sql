-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE adep_consistir_evento_sol ( ie_tipo_solucao_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint, ie_evento_p bigint, nr_seq_motivo_p bigint, ie_palm_p text default null) AS $body$
DECLARE


ie_status_w		varchar(15);
nr_seq_evento_w		bigint;
ie_alteracao_w		smallint;
ie_troca_frasco_w	varchar(1);
ie_troca_frasco_ww	varchar(1);
cont_w			integer;
nm_usuario_w		varchar(255);
cd_estabelecimento_w	bigint;
VarConsiste_inicio_sne_w varchar(255);
nr_seq_cpoe_w		cpoe_material.nr_sequencia%type;
cd_funcao_origem_w	prescr_medica.cd_funcao_origem%type;
nr_seq_evento_hem_w	prescr_solucao_evento.nr_sequencia%type;
ie_ult_status_w		prescr_solucao_evento.ie_alteracao%type;
ie_sol_separadas_w	varchar(1);


BEGIN
if (ie_tipo_solucao_p IS NOT NULL AND ie_tipo_solucao_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_solucao_p IS NOT NULL AND nr_seq_solucao_p::text <> '') and (ie_evento_p IS NOT NULL AND ie_evento_p::text <> '') then
	begin
	if (ie_tipo_solucao_p = 1) then
		begin
		
		ie_sol_separadas_w := Obter_Param_Usuario(1113, 718, obter_perfil_ativo, nm_usuario_w, cd_estabelecimento_w, ie_sol_separadas_w);
		
		select	max(x.ie_status),
				max(obter_nr_seq_cpoe_sol(nr_prescricao_p, nr_seq_solucao_p)),
				max(a.cd_funcao_origem)
		into STRICT	ie_status_w,
				nr_seq_cpoe_w,
				cd_funcao_origem_w
		from	prescr_solucao x,
				prescr_medica a
		where	a.nr_prescricao = x.nr_prescricao
		and		x.nr_prescricao	= nr_prescricao_p
		and		x.nr_seq_solucao	= nr_seq_solucao_p;
		
		if (ie_sol_separadas_w = 'N') and (cd_funcao_origem_w = 2314) and (coalesce(nr_seq_cpoe_w, 0) > 0) then
			ie_status_w := obter_status_solucao_cpoe(nr_seq_cpoe_w);		
		end if;
		
		end;
	elsif (ie_tipo_solucao_p = 2) then
		begin
		select	max(ie_status)
		into STRICT	ie_status_w
		from	prescr_material
		where	nr_prescricao	= nr_prescricao_p
		and	nr_sequencia	= nr_seq_solucao_p
		and	ie_agrupador	= 8;
		end;
	elsif (ie_tipo_solucao_p = 3) then
		begin
		select	max(ie_status)
		into STRICT	ie_status_w
		from	prescr_procedimento
		where	nr_prescricao		= nr_prescricao_p
		and	nr_sequencia		= nr_seq_solucao_p
		and	(nr_seq_solic_sangue IS NOT NULL AND nr_seq_solic_sangue::text <> '')
		and	(nr_seq_derivado IS NOT NULL AND nr_seq_derivado::text <> '');
		
		if (coalesce(ie_palm_p, 'N') = 'S') then
			select	coalesce(max(a.nr_sequencia),0)
			into STRICT	nr_seq_evento_hem_w
			from	prescr_solucao_evento a
			where	a.ie_tipo_solucao = ie_tipo_solucao_p
			and		a.nr_prescricao = nr_prescricao_p
			and		a.nr_seq_procedimento = nr_seq_solucao_p
			and		a.ie_alteracao in (1,2,3,4)
			and		coalesce(a.ie_evento_valido, 'S') = 'S';
			
			if (nr_seq_evento_hem_w > 0) then
				select 	max(a.ie_alteracao)
				into STRICT	ie_ult_status_w
				from	prescr_solucao_evento a
				where	a.nr_sequencia = nr_seq_evento_hem_w;
				
				if (ie_ult_status_w = 4) then
					--A etapa selecionada ja foi interrompida/encerrada.
					CALL wheb_mensagem_pck.exibir_mensagem_abort(1210530);
				end if;
				
			end if;
		end if;
		
		end;
	elsif (ie_tipo_solucao_p = 4) then
		begin
		select	max(ie_status)
		into STRICT	ie_status_w
		from	nut_paciente
		where	nr_prescricao	= nr_prescricao_p
		and	nr_sequencia	= nr_seq_solucao_p;
		end;
	elsif (ie_tipo_solucao_p = 5) then
		begin
		select	max(ie_status)
		into STRICT	ie_status_w
		from	nut_pac
		where	nr_prescricao	= nr_prescricao_p
		and	nr_sequencia	= nr_seq_solucao_p;	
		end;
	end if;
	
	select	max(cd_estabelecimento),
		max(nm_usuario)
	into STRICT	cd_estabelecimento_w,
		nm_usuario_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;
	
	VarConsiste_inicio_sne_w := Obter_Param_Usuario(1113, 544, obter_perfil_ativo, nm_usuario_w, cd_estabelecimento_w, VarConsiste_inicio_sne_w);
	
	if (ie_evento_p = 1) and (ie_tipo_solucao_p = 2) and (VarConsiste_inicio_sne_w = 'S') then
		select	count(*)
		into STRICT	cont_w
		from	prescr_mat_hor
		where	nr_prescricao = nr_prescricao_p
		and	nr_seq_material = nr_seq_solucao_p
		and	coalesce(dt_suspensao::text, '') = '';
		
		if (cont_w = 0) then
			--Todas as etapas desta solucao estao suspensas!
			CALL wheb_mensagem_pck.exibir_mensagem_abort(225688);
		end if;
	end if;

	if (ie_evento_p = 1) and (ie_status_w = 'I') then
		begin
		--Esta solucao ja foi iniciada, favor verificar!
		CALL wheb_mensagem_pck.exibir_mensagem_abort(225691);
		end;
	elsif (ie_evento_p = 2) and (ie_status_w = 'INT') then
		begin
		if (ie_tipo_solucao_p = 1) then
			begin
			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_seq_evento_w
			from	prescr_solucao_evento
			where	ie_tipo_solucao		= ie_tipo_solucao_p
			and	nr_prescricao		= nr_prescricao_p
			and	nr_seq_solucao		= nr_seq_solucao_p
			and	ie_evento_valido	= 'S';
			
			if (coalesce(nr_seq_evento_w,0) > 0) then
				begin
				select	ie_alteracao,
					substr(obter_se_motivo_troca_frasco(nr_seq_motivo),1,1),
					substr(obter_se_motivo_troca_frasco(nr_seq_motivo_p),1,1)
				into STRICT	ie_alteracao_w,
					ie_troca_frasco_w,
					ie_troca_frasco_ww
				from	prescr_solucao_evento
				where	nr_sequencia = nr_seq_evento_w;
				
				if (ie_alteracao_w = 2) and (ie_troca_frasco_w = ie_troca_frasco_ww) then
					begin
					--Esta solucao ja esta interrompida, favor verificar
					CALL wheb_mensagem_pck.exibir_mensagem_abort(225692);
					end;
				end if;
				end;
			else
				begin
				--Esta solucao ja esta interrompida, favor verificar!
				CALL wheb_mensagem_pck.exibir_mensagem_abort(225693);
				end;
			end if;
			end;
		else
			begin			
			--Esta solucao ja esta interrompida, favor verificar!
			CALL wheb_mensagem_pck.exibir_mensagem_abort(225694);
			end;
		end if;
		end;
	elsif (ie_evento_p = 3) and (ie_status_w = 'I') and (coalesce(ie_palm_p,'N') = 'N') then
		begin
		--Esta solucao ja foi reiniciada, favor verificar!
		CALL wheb_mensagem_pck.exibir_mensagem_abort(225695);
		end;
	elsif (ie_evento_p = 4) and (ie_status_w = 'T') then
		begin		
		--Esta solucao ja foi encerrada, favor verificar!
		CALL wheb_mensagem_pck.exibir_mensagem_abort(225696);
		end;
	end if;
	end;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE adep_consistir_evento_sol ( ie_tipo_solucao_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint, ie_evento_p bigint, nr_seq_motivo_p bigint, ie_palm_p text default null) FROM PUBLIC;

