-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE administrar_processo_adep ( cd_estabelecimento_p bigint, nr_seq_processo_p bigint, ie_administrar_p text, nm_usuario_p text, ds_justificativa_p text default null, nr_seq_assinatura_p text default null, ie_tipo_item_p text default null, ie_palm_p text default 'N', nr_seq_topo_lat_p topografia_lat_adm.nr_sequencia%type default null) AS $body$
DECLARE

				
nr_atend_processo_w	    bigint;
nr_seq_solucao_w	    integer;
ie_agrupador_w		    prescr_material.ie_agrupador%type;
ie_tipo_item_w		    varchar(1);
nr_seq_material_w	    prescr_material.nr_sequencia%type;
nr_prescricao_w		    prescr_medica.nr_prescricao%type;
--qtd_w             	number(5);
nr_etapa_w			    adep_processo.nr_etapa%type;
nr_seq_atendimento_w    bigint;
nr_seq_horario_w	    bigint;
ie_adm_medic_termino_w	varchar(1);
sql_errm_w	varchar(4000);
qt_agrupador_dif_w	    integer;
nr_agrupamento_w        prescr_mat_hor.nr_agrupamento%TYPE;
ie_rastreabilidade_adep_w    varchar(1);

C01 CURSOR FOR
  SELECT    c.nr_seq_mat_hor,
            e.nr_seq_atendimento,
            e.nr_prescricao,
            b.nr_agrupamento
  from      adep_processo a,
            prescr_mat_hor b,
            can_ordem_item_prescr c,
            can_ordem_prod d,
            paciente_atendimento e
  where     a.nr_sequencia    = nr_seq_processo_p
  and       a.nr_sequencia    = b.nr_seq_processo
  and       b.nr_sequencia    = c.nr_seq_mat_hor
  and       d.nr_sequencia    = c.nr_seq_ordem
  and       d.nr_prescricao   = e.nr_prescricao
  and       d.nr_prescricao   > 0;


BEGIN

ie_rastreabilidade_adep_w := obter_rastreabilidade_adep(nr_seq_processo_p, 'AP');

if (ie_rastreabilidade_adep_w = 'S') then
    CALL adep_gerar_log_rastr('{'||chr(10)||
    '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
    '"cd_estabelecimento_p" : "'||cd_estabelecimento_p||'",'||chr(10)||
    '"ds_justificativa_p" : "'||ds_justificativa_p||'",'||chr(10)||
    '"ie_administrar_p" : "'||ie_administrar_p||'",'||chr(10)||
    '"ie_palm_p" : "'||ie_palm_p||'",'||chr(10)||
    '"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
    '"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
    '"nr_seq_assinatura_p" : "'||nr_seq_assinatura_p||'",'||chr(10)||
    '"nr_seq_processo_p" : "'||nr_seq_processo_p||'",'||chr(10)||
    '"nr_seq_topo_lat_p" : "'||nr_seq_topo_lat_p||'"}', wheb_usuario_pck.get_ie_commit);
end if;

if (nr_seq_processo_p IS NOT NULL AND nr_seq_processo_p::text <> '') and (ie_administrar_p IS NOT NULL AND ie_administrar_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then

	select	coalesce(max(nr_seq_solucao),0),
			coalesce(max(nr_seq_material),0),
			coalesce(max(nr_prescricao),0),
			coalesce(max(nr_etapa),0),
			coalesce(max(nr_atendimento),0)		
	into STRICT	nr_seq_solucao_w,
			nr_seq_material_w,
			nr_prescricao_w,
			nr_etapa_w,
			nr_atend_processo_w
	from	adep_processo
	where	nr_sequencia = nr_seq_processo_p;
	ie_adm_medic_termino_w := obter_param_usuario(3130, 132, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_adm_medic_termino_w);
	if	((nr_seq_solucao_w > 0) or (nr_etapa_w > 0)) then
		CALL instalar_processo_adep(nr_seq_processo_p, ie_administrar_p, nm_usuario_p, nr_seq_assinatura_p); --SNE SOL NPT
	elsif (ie_administrar_p = 'S') then		
		CALL wheb_usuario_pck.set_ie_commit('N');	
		CALL atualiza_status_processo_adep(nr_seq_processo_p, null, 'A', 'A', clock_timestamp(), nm_usuario_p);

    if (ie_rastreabilidade_adep_w = 'S') then
        CALL adep_gerar_log_rastr('{'||chr(10)||
        '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
        '"nr_seq_processo_p" : "'||nr_seq_processo_p||'"}', wheb_usuario_pck.get_ie_commit);
    end if;
			open C01;
			loop
			fetch C01 into
				nr_seq_horario_w,
                nr_seq_atendimento_w,
				nr_prescricao_w,
                nr_agrupamento_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				begin	

					if (ie_adm_medic_termino_w = 'S') then
						CALL administrar_medic_quimio_onc(nr_seq_atendimento_w, nm_usuario_p, cd_estabelecimento_p, nr_seq_horario_w, nr_agrupamento_w);
					end if;
					CALL gerar_data_admin_dose(clock_timestamp(),clock_timestamp(),nr_prescricao_w,nm_usuario_p,nr_seq_horario_w);
				end;
			end loop;
			close C01;

		CALL wheb_usuario_pck.set_ie_commit('S');
		select	obter_tipo_processo_adep(nr_seq_processo_p)
		into STRICT	ie_tipo_item_w
		;

		if (ie_tipo_item_w = 'M') then
			ie_agrupador_w	:= 1;		
		elsif (ie_tipo_item_w = 'N')	then --NPT
			ie_agrupador_w	:= 11;	
		elsif (ie_tipo_item_w = 'E')	then
			ie_agrupador_w	:= 8;				
		else
			ie_agrupador_w	:= 5;			--- Itens de proc
		end if;		

        if (ie_rastreabilidade_adep_w = 'S') then
            CALL adep_gerar_log_rastr('{'||chr(10)||
            '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
            '"cd_estabelecimento_p" : "'||cd_estabelecimento_p||'",'||chr(10)||
            '"ds_justificativa_p" : "'||ds_justificativa_p||'",'||chr(10)||
            '"ie_administrar_p" : "'||ie_administrar_p||'",'||chr(10)||
            '"ie_agrupador_w" : "'||ie_agrupador_w||'",'||chr(10)||
            '"ie_palm_p" : "'||ie_palm_p||'",'||chr(10)||
            '"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
            '"nr_atend_processo_w" : "'||nr_atend_processo_w||'",'||chr(10)||
            '"nr_seq_assinatura_p" : "'||nr_seq_assinatura_p||'",'||chr(10)||
            '"nr_seq_processo_p" : "'||nr_seq_processo_p||'",'||chr(10)||
            '"nr_seq_topo_lat_p" : "'||nr_seq_topo_lat_p||'",'||chr(10)||
            '"qt_agrupador_dif_w" : "'||qt_agrupador_dif_w||'",'||chr(10)||
            '"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}', wheb_usuario_pck.get_ie_commit);
        end if;

		if (ie_agrupador_w <> 11) then

		    select	max(nr_atendimento)
			into STRICT	nr_atend_processo_w
			from	adep_processo
			where	nr_sequencia	= nr_seq_processo_p;

			if (ie_palm_p = 'S') then
				select	count(distinct ie_agrupador)
				into STRICT	qt_agrupador_dif_w
				from	prescr_mat_hor
				where	nr_seq_processo = nr_seq_processo_p;
			else
				qt_agrupador_dif_w := 1;
			end if;

        if (ie_rastreabilidade_adep_w = 'S') then
            CALL adep_gerar_log_rastr('{'||chr(10)||
            '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
            '"cd_estabelecimento_p" : "'||cd_estabelecimento_p||'",'||chr(10)||
            '"ds_justificativa_p" : "'||ds_justificativa_p||'",'||chr(10)||
            '"ie_administrar_p" : "'||ie_administrar_p||'",'||chr(10)||
            '"ie_agrupador_w" : "'||ie_agrupador_w||'",'||chr(10)||
            '"ie_palm_p" : "'||ie_palm_p||'",'||chr(10)||
            '"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
            '"nr_atend_processo_w" : "'||nr_atend_processo_w||'",'||chr(10)||
            '"nr_seq_assinatura_p" : "'||nr_seq_assinatura_p||'",'||chr(10)||
            '"nr_seq_processo_p" : "'||nr_seq_processo_p||'",'||chr(10)||
            '"nr_seq_topo_lat_p" : "'||nr_seq_topo_lat_p||'",'||chr(10)||
            '"qt_agrupador_dif_w" : "'||qt_agrupador_dif_w||'",'||chr(10)||
            '"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}', wheb_usuario_pck.get_ie_commit);
        end if;

			if (obter_funcao_ativa = -1113 or qt_agrupador_dif_w > 1) then
				CALL gerar_alt_hor_prescr_processo(cd_estabelecimento_p, nr_atend_processo_w, nr_seq_processo_p, ie_administrar_p, nm_usuario_p, ds_justificativa_p,nr_seq_assinatura_p,null, nr_seq_topo_lat_p);
			else
				if (ie_palm_p = 'S') then
					select	coalesce(max(ie_agrupador),ie_agrupador_w)
					into STRICT	ie_agrupador_w
					from	prescr_mat_hor
					where	nr_seq_processo = nr_seq_processo_p
					and		ie_agrupador = 5;
				end if;
				CALL gerar_alt_hor_prescr_processo(cd_estabelecimento_p, nr_atend_processo_w, nr_seq_processo_p, ie_administrar_p, nm_usuario_p, ds_justificativa_p,nr_seq_assinatura_p,ie_agrupador_w, nr_seq_topo_lat_p);			
			end if;

		else	
			CALL instalar_processo_adep(nr_seq_processo_p, ie_administrar_p, nm_usuario_p, nr_seq_assinatura_p); --SNE SOL NPT
		end if;

	elsif (ie_administrar_p = 'N') then		

		CALL atualiza_status_processo_adep(nr_seq_processo_p, null, 'A', 'RA', clock_timestamp(), nm_usuario_p);

            if (ie_rastreabilidade_adep_w = 'S') then
                CALL adep_gerar_log_rastr('{'||chr(10)||
                '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                '"nr_seq_processo_p" : "'||nr_seq_processo_p||'"}', wheb_usuario_pck.get_ie_commit);
            end if;

		open C01;
		loop
		fetch C01 into
            nr_seq_horario_w,
            nr_seq_atendimento_w,
            nr_prescricao_w,
            nr_agrupamento_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */	
			begin

				CALL reverter_medic_quimio_onc(nr_seq_atendimento_w, nm_usuario_p, cd_estabelecimento_p,nr_seq_horario_w,nr_agrupamento_w );	

				CALL Reverter_data_admin_dose(clock_timestamp(),clock_timestamp(),nr_prescricao_w,nm_usuario_p,nr_seq_horario_w);
			end;
		end loop;
		close C01;

		select	nr_atendimento
		into STRICT	nr_atend_processo_w
		from	adep_processo
		where	nr_sequencia	= nr_seq_processo_p;		

		CALL gerar_alt_hor_prescr_processo(cd_estabelecimento_p, nr_atend_processo_w, nr_seq_processo_p, ie_administrar_p, nm_usuario_p, ds_justificativa_p,nr_seq_assinatura_p, null, nr_seq_topo_lat_p);

	end if;	

	update	adep_processo
	set		dt_primeira_checagem  = NULL
	where	nr_sequencia = nr_seq_processo_p
	and		(dt_paciente IS NOT NULL AND dt_paciente::text <> '')
	and		(dt_primeira_checagem IS NOT NULL AND dt_primeira_checagem::text <> '');

end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

begin
CALL gqa_atualiza_etapas_mentor(nr_atend_processo_w);
exception
	when others then
	sql_errm_w := sqlerrm;
end;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE administrar_processo_adep ( cd_estabelecimento_p bigint, nr_seq_processo_p bigint, ie_administrar_p text, nm_usuario_p text, ds_justificativa_p text default null, nr_seq_assinatura_p text default null, ie_tipo_item_p text default null, ie_palm_p text default 'N', nr_seq_topo_lat_p topografia_lat_adm.nr_sequencia%type default null) FROM PUBLIC;

