-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_repasse_est_recebido ( nr_seq_protocolo_p bigint, nr_interno_conta_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_proc_repasse_w	bigint;
nr_seq_mat_repasse_w	bigint;
cd_medico_w		varchar(10);
nr_seq_partic_w		bigint;
nr_seq_terceiro_w	bigint;
vl_repasse_w		double precision;
cd_regra_w		integer;
nr_seq_criterio_w	bigint;

c01 CURSOR FOR
SELECT 	a.nr_seq_procedimento,
	sum(a.vl_repasse),
	a.cd_medico,
	a.nr_seq_partic,
	a.nr_seq_terceiro,
	a.cd_regra,
	a.nr_seq_criterio
from	procedimento_repasse a,
	procedimento_paciente b
where 	a.nr_seq_procedimento	= b.nr_sequencia
and	a.ie_status in ('E')
and	b.nr_interno_conta  	= nr_interno_conta_p
/*and 	not exists (	select 1 from  procedimento_repasse c
			where 	c.nr_seq_procedimento =  a.nr_seq_procedimento
                           and 	c.ie_status = 'A')*/
group by	a.nr_seq_procedimento,
		a.cd_medico,
		a.nr_seq_partic,
		a.nr_seq_terceiro,
		a.cd_regra,
		a.nr_seq_criterio;

c02 CURSOR FOR
SELECT	a.nr_seq_material,
	sum(a.vl_repasse),
	a.cd_medico,
	a.nr_seq_terceiro,
	a.cd_regra,
	a.nr_seq_criterio
from	material_repasse a,
	material_atend_paciente b
where 	a.nr_seq_material = b.nr_sequencia
and	a.ie_status in ('E')
and	b.nr_interno_conta  = nr_interno_conta_p
/*and 	not exists (	select 1 from  material_repasse c
			where 	c.nr_seq_material =  a.nr_seq_material
                           and 	c.ie_status = 'A')*/
group by	a.nr_seq_material,
		a.cd_medico,
		a.nr_seq_terceiro,
		a.cd_regra,
		a.nr_seq_criterio;


BEGIN
open c01;
loop
fetch c01 into
	nr_seq_proc_repasse_w,
	vl_repasse_w,
	cd_medico_w,
	nr_seq_partic_w,
	nr_seq_terceiro_w,
	cd_regra_w,
	nr_seq_criterio_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	if (coalesce(nr_seq_proc_repasse_w, 0) > 0) then
		insert into procedimento_repasse(
			nr_sequencia,
			nr_seq_procedimento,
			vl_repasse,
			dt_atualizacao,
			nm_usuario,
			nr_seq_terceiro,
			nr_lote_contabil,
			nr_repasse_terceiro,
			cd_conta_contabil,
			nr_seq_trans_fin,
			vl_liberado,
			nr_seq_item_retorno,
			ie_status,
			nr_seq_origem,
			cd_regra,
			DT_CONTABIL_TITULO,
			DT_CONTABIL,
			cd_medico,
			nr_seq_partic,
			nr_seq_criterio,
			NR_SEQ_TRANS_FIN_REP_MAIOR,
			dt_liberacao,
			nr_seq_motivo_des,
			ds_observacao)
		values (	nextval('procedimento_repasse_seq'),
			nr_seq_proc_repasse_w,
			vl_repasse_w * -1,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_terceiro_w,
			0,
			null,
			null,
			null,
			0,
			null,
			'A',
			null,
			cd_regra_w,
			to_date('01/01/2999','dd/mm/yyyy'),
			to_date('01/01/2999','dd/mm/yyyy'),
			cd_medico_w,
			nr_seq_partic_w,
			nr_seq_criterio_w,
			null,
			null,
			null,
			wheb_mensagem_pck.get_texto(802241));
	end if;
end loop;
close c01;

open c02;
loop
fetch c02 into
	nr_seq_mat_repasse_w,
	vl_repasse_w,
	cd_medico_w,
	nr_seq_terceiro_w,
	cd_regra_w,
	nr_seq_criterio_w;
EXIT WHEN NOT FOUND; /* apply on c02 */

	if (coalesce(nr_seq_mat_repasse_w, 0) > 0) then
		insert into Material_repasse(
			nr_sequencia,
			nr_seq_Material,
			vl_repasse,
			dt_atualizacao,
			nm_usuario,
			nr_seq_terceiro,
			nr_lote_contabil,
			nr_repasse_terceiro,
			cd_conta_contabil,
			nr_seq_trans_fin,
			vl_liberado,
			nr_seq_item_retorno,
			ie_status,
			nr_seq_origem,
			cd_regra,
			cd_medico,
			NR_SEQ_TRANS_FIN_REP_MAIOR,
			dt_liberacao,
			nr_seq_motivo_des,
			ds_observacao,
			nr_seq_criterio)
		values (	nextval('material_repasse_seq'),
			nr_seq_mat_repasse_w,
			vl_repasse_w * -1,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_terceiro_w,
			0,
			null,
			null,
			null,
			0,
			null,
			'A',
			null,
			cd_regra_w,
			cd_medico_w,
			null,
			null,
			null,
			wheb_mensagem_pck.get_texto(802242),
			nr_seq_criterio_w);
	end if;
end loop;
close c02;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_repasse_est_recebido ( nr_seq_protocolo_p bigint, nr_interno_conta_p bigint, nm_usuario_p text) FROM PUBLIC;

