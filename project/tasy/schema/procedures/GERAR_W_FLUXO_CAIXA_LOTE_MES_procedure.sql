-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_fluxo_caixa_lote_mes ( cd_estabelecimento_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, ie_nivel_p bigint, ie_origem_p text, ie_classif_fluxo_p text, ie_situacao_p text, ie_operacao_p text, ds_lista_conta_financ_p text, ie_conta_sem_valor_p text, nm_usuario_p text) AS $body$
DECLARE


ds_comando1_w		varchar(32000);
ds_comando2_w		varchar(32000);
ds_create_w		varchar(10000);
ds_values_w		varchar(10000);
ds_values_selec_w varchar(10000);
ds_from_values_w	varchar(10000);
ds_insert_w		varchar(10000);
ds_sem_valor_w		varchar(10000);
ds_filtro_conta_w	varchar(2000);
ds_group_by_w		varchar(2000);
ds_alias_w		varchar(10);
ds_alias_ant_w		varchar(10);
dt_inicial_w		timestamp;
dt_final_w		timestamp;
nm_usuario_w		usuario.nm_usuario%type;
dt_referencia_w		fluxo_caixa_data.dt_referencia%type;
cd_conta_financ_w	fluxo_caixa_data.cd_conta_financ%type;
vl_fluxo_w		fluxo_caixa_data.vl_fluxo%type;
cd_conta_financ_saldo_w	parametro_fluxo_caixa.cd_conta_financ_saldo%type;
cd_conta_financ_sant_w	parametro_fluxo_caixa.cd_conta_financ_sant%type;
cd_empresa_w		empresa.cd_empresa%type;

C01 CURSOR FOR
SELECT	distinct
	a.dt_referencia
from	conta_financeira c,
	fluxo_caixa_lote b,
	fluxo_caixa_data a
where (coalesce(ds_lista_conta_financ_p::text, '') = '' or ',' || ds_lista_conta_financ_p || ',' like '%, ' || c.cd_conta_financ || ',%')
and	c.ie_oper_fluxo		= coalesce(ie_operacao_p,c.ie_oper_fluxo)
and	coalesce(c.ie_situacao,'A')	= coalesce(ie_situacao_p,coalesce(c.ie_situacao,'A'))
and	a.cd_conta_financ	= c.cd_conta_financ
and	b.ie_classif_fluxo	= ie_classif_fluxo_p
and	a.nr_seq_lote_fluxo	= b.nr_sequencia
and	coalesce(a.ie_origem,'X')	= coalesce(ie_origem_p,coalesce(a.ie_origem,'X'))
and	coalesce(a.ie_nivel,1)	<= coalesce(ie_nivel_p,1)
and	a.dt_referencia		between dt_inicial_w and dt_final_w
order by dt_referencia;


BEGIN

select	a.cd_conta_financ_saldo,
	a.cd_conta_financ_sant
into STRICT	cd_conta_financ_saldo_w,
	cd_conta_financ_sant_w
from	parametro_fluxo_caixa a
where	a.cd_estabelecimento = cd_estabelecimento_p;

begin
select	obter_empresa_estab(cd_estabelecimento_p)
into STRICT	cd_empresa_w
;
exception when others then
	cd_empresa_w := null;
end;

nm_usuario_w	:= upper(nm_usuario_p);

/*OS 1661460 Se o nome do usuario tiver ponto virgula ou espaco, vai substituir por*/

nm_usuario_w := replace(replace(replace(nm_usuario_p,'.','_'),',','_'),' ','_');

CALL exec_sql_dinamico('Tasy','drop table W_FLUXO_CX_LOT_' || nm_usuario_w);

ds_comando1_w	:=	'create table W_FLUXO_CX_LOT_' || nm_usuario_w || ' (' ||
			'cd_conta_financ number(10), ' ||
			'cd_conta_apres varchar2(20), ' ||
			'ds_conta_estrut varchar2(60), ' ||
			'ds_moeda varchar2(30) ';

dt_inicial_w	:= trunc(dt_inicial_p,'dd');
dt_final_w	:= fim_dia(dt_final_p);

ds_insert_w	:= 'insert into W_FLUXO_CX_LOT_' || nm_usuario_w || ' (cd_conta_financ, cd_conta_apres, ds_conta_estrut, ds_moeda ';
ds_values_selec_w	:= '(select c.cd_conta_financ, c.cd_conta_apres, c.ds_conta_estrut, obter_ds_moeda_estrangeira(b.cd_moeda) ds_moeda ';

if (coalesce(ie_conta_sem_valor_p,'N')	= 'S') and (coalesce(ds_lista_conta_financ_p::text, '') = '') then
	ds_sem_valor_w	:= ' union all select x.cd_conta_financ, x.cd_conta_apres, x.ds_conta_estrut, ' || chr(39) || chr(39) || ' ds_moeda, 0 vl_total ';
end if;

open C01;
loop
fetch C01 into	
	dt_referencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ds_alias_w	:= 'F' || to_char(fim_mes(dt_referencia_w),'ddmmyyyy');
	if (ds_alias_w <> ds_alias_ant_w) or (coalesce(ds_alias_ant_w::text, '') = '') then
		ds_create_w	:= ds_create_w || ' , ' || ds_alias_w || ' number(15,2) ';
		ds_insert_w	:= ds_insert_w || ' , ' || ds_alias_w;
		ds_values_w	:= substr(ds_values_w || ds_alias_ant_w ||' sum(decode(a.dt_referencia, to_date(' || chr(39) || to_char(dt_referencia_w,'dd/mm/yyyy') ||  chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || '), a.vl_fluxo, 0)) ',1,10000);
	else
		ds_values_w	:= substr(ds_values_w || ' + sum(decode(a.dt_referencia, to_date(' || chr(39) || to_char(dt_referencia_w,'dd/mm/yyyy') ||  chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || '), a.vl_fluxo, 0)) ',1,10000);
	end if;
	
	--ds_values_w	:= ds_values_w || ' , sum(decode(a.dt_referencia, to_date(' || chr(39) || to_char(dt_referencia_w,'dd/mm/yyyy') ||  chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || '), a.vl_fluxo, 0)) ' || ds_alias_w;
	
	if (coalesce(ie_conta_sem_valor_p,'N')	= 'S') and (coalesce(ds_lista_conta_financ_p::text, '') = '') and
		((ds_alias_w <> ds_alias_ant_w) or --OS 1659334, so gerar sem valor para 1 dia por mes,pq eh mensal e n diario essa proc, Se nao incluia todos os dias no union all e na hora de fazer o insert na tabela criada dava erro.
		(coalesce(ds_alias_ant_w::text, '') = ''))	then
		ds_sem_valor_w	:= ds_sem_valor_w || ' , 0 ' || ds_alias_w;
	end if;
	ds_alias_ant_w	:= ds_alias_w;
	end;
end loop;
close C01;

ds_create_w	:= ds_create_w || ', vl_total number(15,2))';
ds_comando1_w	:= ds_comando1_w || ds_create_w;

CALL Exec_sql_Dinamico('Tasy', ds_comando1_w);

ds_values_w	:=  ds_values_selec_w ||
		substr(', decode(obter_se_totaliza_cf(	c.cd_conta_financ), ' || chr(39) || 'S' || chr(39) || ', decode(c.cd_conta_financ, ' ||
						cd_conta_financ_saldo_w || ', ' ||
						'obter_valor_fluxo_saldo_lote(	' || cd_estabelecimento_p || ', ' ||
										chr(39) || ie_classif_fluxo_p || chr(39) || ', ' || 
										'to_date(' || chr(39) || to_char(dt_inicial_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
										'to_date(' || chr(39) || to_char(Dt_final_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
										'2), ' ||
						cd_conta_financ_sant_w || ', ' ||
						'obter_valor_fluxo_saldo_lote(	' || cd_estabelecimento_p || ', ' ||
										chr(39) || ie_classif_fluxo_p || chr(39) || ', ' ||
										'to_date(' || chr(39) || to_char(dt_inicial_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
										'to_date(' || chr(39) || to_char(Dt_final_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
										'1),' ||
						ds_values_w||'),  0)',1,10000);

ds_values_w	:=  substr(ds_values_w || ', ' ||
		' decode(obter_se_totaliza_cf(	c.cd_conta_financ), ' || chr(39) || 'S' || chr(39) || ', decode(c.cd_conta_financ, ' ||
						cd_conta_financ_saldo_w || ', ' ||
						'obter_valor_fluxo_saldo_lote(	' || cd_estabelecimento_p || ', ' ||
										chr(39) || ie_classif_fluxo_p || chr(39) || ', ' || 
										'to_date(' || chr(39) || to_char(dt_inicial_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
										'to_date(' || chr(39) || to_char(Dt_final_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
										'2), ' ||
						cd_conta_financ_sant_w || ', ' ||
						'obter_valor_fluxo_saldo_lote(	' || cd_estabelecimento_p || ', ' ||
										chr(39) || ie_classif_fluxo_p || chr(39) || ', ' ||
										'to_date(' || chr(39) || to_char(dt_inicial_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
										'to_date(' || chr(39) || to_char(Dt_final_p,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ' || ', ' ||
										'1), ' ||
						'sum(vl_fluxo)),  0) vl_total ',1,10000);

ds_insert_w	:= ds_insert_w || ', vl_total)';

ds_from_values_w	:= 	' from	conta_financeira_v c, ' ||
				'	fluxo_caixa_lote b, ' ||
				'	fluxo_caixa_data a ' ||
				' where	1 = 1 ';
					
if (coalesce(ie_conta_sem_valor_p,'N')	= 'S') and (coalesce(ds_lista_conta_financ_p::text, '') = '') then
	ds_sem_valor_w	:= ds_sem_valor_w || ' from conta_financeira_v x where not exists (select 1 ';
end if;
									
if (ds_lista_conta_financ_p IS NOT NULL AND ds_lista_conta_financ_p::text <> '') then
	ds_filtro_conta_w	:= ' and ' || chr(39) || ',' || chr(39) || ' || ' || chr(39) || ds_lista_conta_financ_p || chr(39) || ' || ' || chr(39) || ',' || chr(39) || ' like ' || chr(39) || '%, ' || chr(39) || ' ||  c.cd_conta_financ  || ' || chr(39) || ',%' || chr(39);
end if;

ds_from_values_w	:= ds_from_values_w || ds_filtro_conta_w;

if (coalesce(ie_conta_sem_valor_p,'N')	= 'N') and (coalesce(ds_lista_conta_financ_p::text, '') = '') then
	ds_from_values_w	:= ds_from_values_w ||	' and	a.vl_fluxo	<> 0 ';
end if;

ds_from_values_w	:= ds_from_values_w ||	'and	c.ie_oper_fluxo = nvl(' || chr(39) || ie_operacao_p || chr(39) || ',c.ie_oper_fluxo) ' ||
						'and	nvl(c.ie_situacao,' || chr(39) || 'A' || chr(39) || ') = nvl(' || chr(39) ||ie_situacao_p || chr(39) || ',nvl(c.ie_situacao,' || chr(39) || 'A' || chr(39) || ')) ' ||
						'and	a.cd_conta_financ = c.cd_conta_financ ' ||
						'and	b.ie_classif_fluxo = ' || chr(39) || ie_classif_fluxo_p || chr(39) || ' ' ||
						'and	a.nr_seq_lote_fluxo = b.nr_sequencia ' ||
						'and	nvl(a.ie_origem,' || chr(39) ||'X' || chr(39) ||') = nvl(' || chr(39) || ie_origem_p || chr(39) || ',nvl(a.ie_origem,' || chr(39) || 'X' || chr(39) || ')) ' ||
						'and	nvl(a.ie_nivel,1) <= nvl(' || chr(39) || ie_nivel_p || chr(39) || ',1) ' ||
						'and    b.cd_empresa = ' || cd_empresa_w || ' ' ||
						'and    nvl(b.cd_estabelecimento, '||cd_estabelecimento_p||') = '|| cd_estabelecimento_p || ' ' || --Esse ajuste ja deveria ter sido feito aqui antes, tava so na rotina de diario.
						'and	a.dt_referencia between to_date(' || chr(39) || to_char(dt_inicial_w,'dd/mm/yyyy') ||chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ')' ||
									' and to_date(' || chr(39) || to_char(dt_final_w,'dd/mm/yyyy') || chr(39) || ',' || chr(39) || 'dd/mm/yyyy' || chr(39) || ') ';
						
ds_group_by_w	:= ' group by c.cd_conta_financ, c.cd_conta_apres, c.ds_conta_estrut, obter_ds_moeda_estrangeira(b.cd_moeda)';

if (coalesce(ie_conta_sem_valor_p,'N')	= 'S') and (coalesce(ds_lista_conta_financ_p::text, '') = '') then						
	ds_sem_valor_w	:= ds_sem_valor_w || ds_from_values_w || 'and c.cd_conta_financ = x.cd_conta_financ) ' ||
			'and	x.ie_oper_fluxo = nvl(' || chr(39) || ie_operacao_p || chr(39) || ',x.ie_oper_fluxo) ' ||
			'and	nvl(x.ie_situacao,' || chr(39) || 'A' || chr(39) || ') = nvl(' || chr(39) ||ie_situacao_p || chr(39) || ',nvl(x.ie_situacao,' || chr(39) || 'A' || chr(39) || ')) ' ||
			'and	nvl(obter_nivel_conta_financ(x.cd_conta_financ),1) <= nvl(' || chr(39) || ie_nivel_p || chr(39) || ',1) ';
end if;

ds_comando2_w	:= ds_insert_w || ds_values_w || ds_from_values_w || ds_group_by_w || ds_sem_valor_w || ')';

CALL Exec_sql_Dinamico('Tasy', ds_comando2_w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_fluxo_caixa_lote_mes ( cd_estabelecimento_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, ie_nivel_p bigint, ie_origem_p text, ie_classif_fluxo_p text, ie_situacao_p text, ie_operacao_p text, ds_lista_conta_financ_p text, ie_conta_sem_valor_p text, nm_usuario_p text) FROM PUBLIC;

