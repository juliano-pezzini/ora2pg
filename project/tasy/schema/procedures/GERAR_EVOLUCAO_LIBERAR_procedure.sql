-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_evolucao_liberar ( nr_parecer_p bigint, ie_tipo_evolucao_p text, nm_usuario_p text) AS $body$
DECLARE


cd_evolucao_w		bigint;
ie_relev_resumo_alta_w	varchar(1);

BEGIN

select	nextval('evolucao_paciente_seq')
into STRICT	cd_evolucao_w
;

select	coalesce(max(ie_relev_resumo_alta),'N')
into STRICT	ie_relev_resumo_alta_w
from	tipo_evolucao
where	cd_tipo_evolucao = 'P';

Insert into evolucao_paciente(
	cd_evolucao,
	dt_evolucao,
	ie_tipo_evolucao,
	cd_pessoa_fisica,
	dt_atualizacao,
	nm_usuario,
	nr_atendimento,
	ds_evolucao,
	cd_medico,
	dt_liberacao,
	ie_evolucao_clinica,
	cd_setor_atendimento,
	cd_especialidade,
	cd_especialidade_medico,
	cd_medico_parecer,
	ie_recem_nato,
	ie_situacao,
	ie_relev_resumo_alta)
SELECT cd_evolucao_w,
       clock_timestamp(),
       ie_tipo_evolucao_p,
       b.cd_pessoa_fisica,
       clock_timestamp(),
       nm_usuario_p,
       b.nr_atendimento,
       ' ',
       b.cd_medico,
       null,
       'P',
       obter_setor_atendimento(b.nr_atendimento),
       b.CD_ESPECIALIDADE_DEST,
	   CASE WHEN obter_se_especialidade_medico(b.cd_medico,b.cd_especialidade_dest)='S' THEN b.cd_especialidade_dest  ELSE null END ,
       b.CD_PESSOA_PARECER,
       'N',
       'A',
	   ie_relev_resumo_alta_w
from   PARECER_MEDICO_REQ b
where  b.nr_parecer = nr_parecer_p;

commit;

CALL copia_campo_long_de_para(	'PARECER_MEDICO_REQ',
				'DS_MOTIVO_CONSULTA',
				' where nr_parecer = :nr_parecer_seq ',
				'nr_parecer_seq='||nr_parecer_p,
				'EVOLUCAO_PACIENTE',
				'DS_EVOLUCAO',
				' where cd_evolucao = :cd_evolucao',
				'cd_evolucao='||cd_evolucao_w);

CALL liberar_evolucao(cd_evolucao_w,nm_usuario_p);

CALL gerar_evolucao_vinculo(nr_parecer_p,cd_evolucao_w,'RP');

commit;


END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_evolucao_liberar ( nr_parecer_p bigint, ie_tipo_evolucao_p text, nm_usuario_p text) FROM PUBLIC;

