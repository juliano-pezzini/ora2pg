-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE valida_prescr_interf_laudo ( nr_prescricao_p bigint, cd_interface_p bigint, ds_mensagem_p INOUT text, nm_paciente_p INOUT text) AS $body$
DECLARE

qt_items_w	bigint := 0;					
ds_mensagem_w	varchar(255);

BEGIN
 
 
if (cd_interface_p = 2018) then 
	select count(*) 
	into STRICT	qt_items_w 
	from	prescr_medica 
	where	nr_prescricao = nr_prescricao_p;
	 
	if (qt_items_w = 0) then			 
		ds_mensagem_w := substr(obter_texto_tasy(186035, wheb_usuario_pck.get_nr_seq_idioma),1,255);
	else 
		select count(*) 
		into STRICT	qt_items_w		 
		from 	prescr_medica b, 
			prescr_procedimento a, 
			laudo_paciente l, 
			procedimento_paciente e 
		where  a.nr_prescricao = b.nr_prescricao 
		and   a.nr_prescricao = e.nr_prescricao 
		and   a.nr_sequencia = e.nr_sequencia_prescricao 
		and   l.nr_seq_proc  = e.nr_sequencia 
		and   (l.dt_liberacao IS NOT NULL AND l.dt_liberacao::text <> '') 
		and	b.nr_prescricao = nr_prescricao_p;
		 
		if (qt_items_w = 0) then 
			ds_mensagem_w := substr(obter_texto_tasy(186036, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		else 
			select count(*) 
			into STRICT	qt_items_w		 
			from 	prescr_medica b, 
				prescr_procedimento a, 
				laudo_paciente l, 
				procedimento_paciente e 
			where  a.nr_prescricao = b.nr_prescricao 
			and   a.nr_prescricao = e.nr_prescricao 
			and   a.nr_sequencia = e.nr_sequencia_prescricao 
			and   l.nr_seq_proc  = e.nr_sequencia 
			and   (l.dt_liberacao IS NOT NULL AND l.dt_liberacao::text <> '') 
			and	coalesce(l.dt_integracao_interf::text, '') = '' 
			and	b.nr_prescricao = nr_prescricao_p;
			 
			if (qt_items_w = 0) then 
				ds_mensagem_w := substr(obter_texto_tasy(186037, wheb_usuario_pck.get_nr_seq_idioma),1,255);
			else 
				select count(*) 
				into STRICT	qt_items_w 
				from  	hmj_laboratorio_v 
				where 	nr_prescricao =nr_prescricao_p;		
				 
				if (qt_items_w = 0) then 
					ds_mensagem_w := substr(obter_texto_tasy(186132, wheb_usuario_pck.get_nr_seq_idioma),1,255);
				end if;
				 
			end if;
			 
		end if;
		 
	end if;	
	 
	select max(substr(coalesce(obter_nome_pf(a.cd_pessoa_fisica),''),1,255)) 
	into STRICT	nm_paciente_p 
	from	pessoa_fisica a, 
		prescr_medica b 
	where	a.cd_pessoa_fisica = b.cd_pessoa_fisica 
	and	b.nr_prescricao = nr_prescricao_p;
	 
end if;
 
if (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') then 
	ds_mensagem_p := substr(ds_mensagem_w,1,255);
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE valida_prescr_interf_laudo ( nr_prescricao_p bigint, cd_interface_p bigint, ds_mensagem_p INOUT text, nm_paciente_p INOUT text) FROM PUBLIC;

