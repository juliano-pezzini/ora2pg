-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE codificacao_ajustar_item ( nr_sequencia_p bigint, cd_doenca_cid_p text, nr_seq_proc_p bigint, nm_usuario_p text, nr_seq_codificacao_p bigint, ds_justificativa_p text) AS $body$
DECLARE


nr_sequencia_w			codificacao_atend_item.nr_sequencia%type;
ie_tipo_item_w			codificacao_atend_item.ie_tipo_item%type;
nr_seq_proc_interno_w	codificacao_atend_item.nr_seq_proc_interno%type;
nr_seq_diag_pac_w		codificacao_atend_item.nr_seq_diag_pac%type;
ie_classificacao_w		codificacao_atend_item.ie_classificacao%type;
cd_doenca_cid_w			codificacao_atend_item.cd_doenca_cid%type;
nr_seq_proc_pac_w		codificacao_atend_item.nr_seq_proc_pac%type;
ie_origem_proced_w		codificacao_atend_item.ie_origem_proced%type;
cd_proc_vinculado_w		procedimento.cd_procedimento%type;
ds_complemento_w		varchar(255);


BEGIN

select 	max(nr_sequencia) + 1
into STRICT	nr_sequencia_w
from	codificacao_atend_item
where	nr_seq_codificacao = nr_seq_codificacao_p;

select	ie_tipo_item,
		cd_doenca_cid,
		nr_seq_proc_interno,
		nr_seq_diag_pac,
		ie_classificacao,
		nr_seq_proc_pac,
		CASE WHEN ie_tipo_item='P' THEN  CASE WHEN ie_classificacao='P' THEN  PERFORM obter_desc_expressao(911017) WHEN ie_classificacao='S' THEN  PERFORM obter_desc_expressao(911019)  ELSE '' END  WHEN ie_tipo_item='D' THEN  CASE WHEN ie_classificacao='P' THEN  PERFORM obter_desc_expressao(287711) WHEN ie_classificacao='S' THEN  PERFORM obter_desc_expressao(287716)  ELSE '' END  END
into STRICT	ie_tipo_item_w,
		cd_doenca_cid_w,
		nr_seq_proc_interno_w,
		nr_seq_diag_pac_w,
		ie_classificacao_w,
		nr_seq_proc_pac_w,
		ds_complemento_w
from 	codificacao_atend_item
where	nr_seq_codificacao = nr_seq_codificacao_p
and		nr_sequencia = nr_sequencia_p;

if (ie_tipo_item_w = 'P') then

	select	max(cd_procedimento)
	into STRICT	cd_proc_vinculado_w
	from	procedimento
	where	cd_procimento_mx = (	SELECT	max(nr_sequencia)
									from	cat_procedimento
									where	cd_procedimento = cd_doenca_cid_p);

end if;


if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then

	insert into codificacao_atend_item(
			nr_sequencia,
			nr_seq_codificacao,
			ie_tipo_item,
			cd_doenca_cid,
			ie_status,
			nm_usuario,
			dt_atualizacao,
			nr_seq_proc_pac,
			nr_seq_proc_interno,
			nr_seq_diag_pac,
			dt_inativacao,
			ie_classificacao,
			ie_origem_proced,
			nm_usuario_nrec,
			dt_atualizacao_nrec)
		values (
			nr_sequencia_w,
			nr_seq_codificacao_p,
			ie_tipo_item_w,
			coalesce(cd_doenca_cid_p, cd_doenca_cid_w),
			'A',
			nm_usuario_p,
			clock_timestamp(),
			nr_seq_proc_pac_w,
			coalesce(cd_proc_vinculado_w, nr_seq_proc_interno_w),
			nr_seq_diag_pac_w,
			null,
			ie_classificacao_w,
			ie_origem_proced_w,
			nm_usuario_p,
			clock_timestamp());

	select	max(ie_classificacao)
	into STRICT	ie_classificacao_w
	from	codificacao_atend_item
	where	nr_sequencia = nr_sequencia_p;

	if (ie_tipo_item_w = 'P') then
		if (nr_seq_proc_p IS NOT NULL AND nr_seq_proc_p::text <> '') then
			CALL gerar_codificacao_atend_log(nr_seq_codificacao_p, obter_desc_expressao(892099) || '. ' || ds_complemento_w || ': ' ||
				substr(obter_descricao_procedimento(nr_seq_proc_p, null), 1, 255) || '. ' || obter_desc_expressao(325773) || ' ' || ds_justificativa_p, nm_usuario_p);
		else

			select	max(ds_procedimento)
			into STRICT	ds_complemento_w
			from	cat_procedimento
			where	cd_procedimento = cd_doenca_cid_p;

			CALL gerar_codificacao_atend_log(nr_seq_codificacao_p, obter_desc_expressao(892099) || ' : ' || ds_complemento_w, nm_usuario_p);
		end if;
	else
		CALL gerar_codificacao_atend_log(nr_seq_codificacao_p, obter_desc_expressao(892099) || '. ' || ds_complemento_w || ': ' ||
			substr(obter_desc_cid(cd_doenca_cid_p),1,255) || '. ' || obter_desc_expressao(325773) || ' ' || ds_justificativa_p, nm_usuario_p);
	end if;

	update	codificacao_atend_item
	set		ie_status		= 'I',
			dt_inativacao	= clock_timestamp()
	where	nr_sequencia	= nr_sequencia_p
	and		nr_seq_codificacao = nr_seq_codificacao_p;

	commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE codificacao_ajustar_item ( nr_sequencia_p bigint, cd_doenca_cid_p text, nr_seq_proc_p bigint, nm_usuario_p text, nr_seq_codificacao_p bigint, ds_justificativa_p text) FROM PUBLIC;

