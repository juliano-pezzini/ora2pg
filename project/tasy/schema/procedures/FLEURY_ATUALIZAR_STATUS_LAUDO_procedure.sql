-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fleury_atualizar_status_laudo ( nr_sequencia_p bigint, ds_tipo_resultado text default 'F') AS $body$
DECLARE



nr_prescricao_w		bigint;
nr_seq_prescricao_w	bigint;
ie_status_execucao_w	varchar(3);


BEGIN

select	max(a.nr_prescricao),
	max(a.nr_seq_prescricao)
into STRICT	nr_prescricao_w,
	nr_seq_prescricao_w
from	laudo_paciente a
where	a.nr_sequencia = nr_sequencia_p;

if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') and (nr_seq_prescricao_w IS NOT NULL AND nr_seq_prescricao_w::text <> '') then

	if (ds_tipo_resultado = 'F') then
		update	laudo_paciente
		set	dt_liberacao = clock_timestamp(),
			nm_usuario_liberacao = 'TasyFleuryWS',
			dt_aprovacao = clock_timestamp(),
			nm_usuario_aprovacao = 'TasyFleuryWS',
			nm_usuario_seg_aprov = 'TasyFleuryWS',
			dt_seg_aprovacao = clock_timestamp(),
			nm_usuario = 'TasyFleuryWS'
		where	nr_sequencia = nr_sequencia_p;

		/* *****  Atualiza status execução na prescrição ***** */

		update	prescr_procedimento a
		set	a.ie_status_execucao 	= '40', --Liberado
			a.nm_usuario 	= 'TasyFleuryWS'
		where	a.nr_prescricao = nr_prescricao_w
		and	a.nr_sequencia  in (	SELECT	b.nr_sequencia_prescricao
						from	procedimento_paciente b
						where	b.nr_prescricao 	= a.nr_prescricao
						and	b.nr_sequencia_prescricao = a.nr_sequencia
						and	b.nr_laudo 		= nr_seq_prescricao_w);

		select 	max(ie_status_execucao)
		into STRICT	ie_status_execucao_w
		from	prescr_procedimento a
		where	a.nr_prescricao = nr_prescricao_w
		and	a.nr_sequencia  = nr_seq_prescricao_w;

		if (ie_status_execucao_w <> '40') then

			update	prescr_procedimento a
			set	a.ie_status_execucao = '40',
				a.nm_usuario 	= 'TasyFleuryWS'
			where	a.nr_prescricao = nr_prescricao_w
			and	a.nr_sequencia  in (	SELECT	b.nr_sequencia_prescricao
							from	procedimento_paciente b
							where	b.nr_prescricao = a.nr_prescricao
							and 	b.nr_prescricao = nr_prescricao_w
							and	b.nr_sequencia_prescricao = a.nr_sequencia
							and	b.nr_sequencia_prescricao = nr_seq_prescricao_w);
		end if;

	elsif (ds_tipo_resultado = 'P') then

		update	laudo_paciente
		set	dt_aprovacao = clock_timestamp(),
			nm_usuario_aprovacao = 'TasyFleuryWS',
			dt_liberacao  = NULL
		where	nr_sequencia = nr_sequencia_p;

		/* *****  Atualiza status execução na prescrição ***** */

		update	prescr_procedimento a
		set	a.ie_status_execucao 	= '35', --Aguardando segunda aprovação
			a.nm_usuario 	= 'TasyFleuryWS'
		where	a.nr_prescricao = nr_prescricao_w
		and	a.nr_sequencia  in (	SELECT	b.nr_sequencia_prescricao
						from	procedimento_paciente b
						where	b.nr_prescricao 	= a.nr_prescricao
						and	b.nr_sequencia_prescricao = a.nr_sequencia
						and	b.nr_laudo 		= nr_seq_prescricao_w);

		select 	max(ie_status_execucao)
		into STRICT	ie_status_execucao_w
		from	prescr_procedimento a
		where	a.nr_prescricao = nr_prescricao_w
		and	a.nr_sequencia  = nr_seq_prescricao_w;

		if (ie_status_execucao_w <> '35') then

			update	prescr_procedimento a
			set	a.ie_status_execucao = '35', --Aguardando segunda aprovação
				a.nm_usuario 	= 'TasyFleuryWS'
			where	a.nr_prescricao = nr_prescricao_w
			and	a.nr_sequencia  in (	SELECT	b.nr_sequencia_prescricao
							from	procedimento_paciente b
							where	b.nr_prescricao = a.nr_prescricao
							and 	b.nr_prescricao = nr_prescricao_w
							and	b.nr_sequencia_prescricao = a.nr_sequencia
							and	b.nr_sequencia_prescricao = nr_seq_prescricao_w);
		end if;
	end if;

	commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fleury_atualizar_status_laudo ( nr_sequencia_p bigint, ds_tipo_resultado text default 'F') FROM PUBLIC;

