-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE replicar_alerta_api ( nr_seq_cpoe_anterior_p alerta_api.nr_sequencia%type, nr_seq_cpoe_p alerta_api.nr_sequencia%type ) AS $body$
BEGIN
	/* 
		Verificar a possibilidade de incluir um tratamento de exception 
		Talvez devemos apagar os alertas do item original - segundo o Armin nao pode gerar alerta para o item original da modificacao
	*/
	
	if (nr_seq_cpoe_anterior_p IS NOT NULL AND nr_seq_cpoe_anterior_p::text <> '' AND nr_seq_cpoe_p IS NOT NULL AND nr_seq_cpoe_p::text <> '') then

		/* Replicar os alertas - Verificar se existem mais campos */

		insert into alerta_api(
			nr_sequencia,
			nr_seq_material,
			nr_prescricao,
			cd_api,
			ie_status,
			ds_resultado_curto,
			--ds_resultado, Esse campo tem o tipo Long, portanto o insert select nao funciona
			nr_gravidade,
			cd_material,
			nr_seq_cpoe,
			ie_status_requisicao,
			ie_justificado,
			nr_seq_controle,
			ds_sub_tipo_api,
			dt_validade,
			nr_seq_id_medispan,
			ds_tipo_dado,
			nr_agrupamento )
		(SELECT nextval('alerta_api_seq'),
				a.nr_seq_material,
				a.nr_prescricao,
				a.cd_api,
				a.ie_status,
				a.ds_resultado_curto,
				--a.ds_resultado,
				a.nr_gravidade,
				a.cd_material,
				nr_seq_cpoe_p,
				a.ie_status_requisicao,
				a.ie_justificado,
				a.nr_seq_controle,
				a.ds_sub_tipo_api,
				a.dt_validade,
				a.nr_seq_id_medispan,
				a.ds_tipo_dado,
				a.nr_agrupamento
		   from alerta_api a
		  where a.nr_seq_cpoe = nr_seq_cpoe_anterior_p);
	
		/* Replicar as justificativas - Verificar se existem mais campos */

		insert into cpoe_justif_interacao(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_mat_cpoe,
			ie_severidade_just,
			ds_justificativa,
			cd_material_interacao,
			nr_seq_cpoe_princ,
			nr_gravidade,
			ds_sub_tipo_api,
			ds_resultado_curto,
			cd_api,
			ie_integracao )
		(SELECT nextval('cpoe_justif_interacao_seq'),
				clock_timestamp(),
				wheb_usuario_pck.get_nm_usuario,
				clock_timestamp(),
				wheb_usuario_pck.get_nm_usuario,
				a.nr_seq_mat_cpoe,
				a.ie_severidade_just,
				a.ds_justificativa,
				a.cd_material_interacao,
				a.nr_seq_cpoe_princ,
				a.nr_gravidade,
				a.ds_sub_tipo_api,
				a.ds_resultado_curto,
				a.cd_api,
				a.ie_integracao
		  from	cpoe_justif_interacao a
		 where	a.nr_seq_mat_cpoe = nr_seq_cpoe_anterior_p);
		
		commit;
		
	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE replicar_alerta_api ( nr_seq_cpoe_anterior_p alerta_api.nr_sequencia%type, nr_seq_cpoe_p alerta_api.nr_sequencia%type ) FROM PUBLIC;

