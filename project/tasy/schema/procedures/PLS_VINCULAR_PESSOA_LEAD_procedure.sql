-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_vincular_pessoa_lead ( nr_seq_solicitacao_p bigint, cd_pf_vinculada_p text, cd_pj_vinculada_p text, nm_usuario_p text, nr_seq_equipe_p INOUT bigint) AS $body$
DECLARE

 
nm_pessoa_w			pls_solicitacao_comercial.nm_pessoa_fisica%type;
ie_beneficiario_w		varchar(1) := 'N';
qt_existente_w			bigint;
dt_rescisao_w			timestamp;
qt_dias_ocioso_w		integer;
nr_seq_equipe_w			bigint	:= null;
qt_dias_max_w			integer;
qt_dias_min_w			integer;


BEGIN 
 
select	substr(obter_nome_pf_pj(cd_pf_vinculada_p,cd_pj_vinculada_p),1,80) 
into STRICT	nm_pessoa_w
;
 
if (cd_pf_vinculada_p IS NOT NULL AND cd_pf_vinculada_p::text <> '') then --Diether OS 250677 - Verificar em qual regra de repasse a pessoa que vai ser vinculada pertnence 
	select	count(*) 
	into STRICT	qt_existente_w 
	from	pls_segurado 
	where	cd_pessoa_fisica	= cd_pf_vinculada_p 
	and	(dt_rescisao IS NOT NULL AND dt_rescisao::text <> '');
	 
	if (qt_existente_w <> 0) then 
		 
		select	max(dt_rescisao) 
		into STRICT	dt_rescisao_w 
		from	pls_segurado 
		where	cd_pessoa_fisica	= cd_pf_vinculada_p 
		and	(dt_rescisao IS NOT NULL AND dt_rescisao::text <> '');
		 
		begin 
		select	round(clock_timestamp() - dt_rescisao_w) 
		into STRICT	qt_dias_ocioso_w 
		;
		exception 
		when others then 
			qt_dias_ocioso_w	:= 0;
		end;
		 
		select	max(qt_dias) 
		into STRICT	qt_dias_min_w 
		from	pls_solic_regra_repasse 
		where	qt_dias	< qt_dias_ocioso_w;
		 
		qt_dias_min_w	:= coalesce(qt_dias_min_w,0);
		 
		select	min(qt_dias) 
		into STRICT	qt_dias_max_w 
		from	pls_solic_regra_repasse 
		where	qt_dias > qt_dias_min_w;
		 
		begin 
		select	nr_seq_equipe 
		into STRICT	nr_seq_equipe_w 
		from	pls_solic_regra_repasse 
		where	qt_dias	= qt_dias_max_w;
		exception 
		when others then 
			nr_seq_equipe_w	:= null;
		end;
		 
		nr_seq_equipe_p	:= nr_seq_equipe_w;
	end if;
end if;
 
update	pls_solicitacao_comercial 
set	cd_pf_vinculado		= cd_pf_vinculada_p, 
	cd_cnpj_vinculado	= cd_pj_vinculada_p, 
	nm_pessoa_fisica	= coalesce(nm_pessoa_w,nm_pessoa_fisica), 
	nm_usuario		= nm_usuario_p, 
	dt_atualizacao		= clock_timestamp() 
where	nr_sequencia		= nr_seq_solicitacao_p;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_vincular_pessoa_lead ( nr_seq_solicitacao_p bigint, cd_pf_vinculada_p text, cd_pj_vinculada_p text, nm_usuario_p text, nr_seq_equipe_p INOUT bigint) FROM PUBLIC;

