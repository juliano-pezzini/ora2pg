-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_imp_prest_ressarcimento ( cd_cnes_p text, cd_cep_p text, nm_prestador_p text, sg_uf_p text, nm_usuario_p usuario.nm_usuario%type, ie_opcao_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ds_natureza_ups_p text, nr_seq_prestador_p INOUT text) AS $body$
DECLARE


nm_localidade_w		cep_loc.nm_localidade%type;
cd_municipio_w		cep_municipio.cd_municipio_ibge%type;
sg_uf_w			pls_processo_prestador.sg_estado%type := substr(sg_uf_p,1,2);
nr_seq_prestador_w	pls_processo_prestador.nr_sequencia%type;


BEGIN
begin
select	coalesce(nm_localidade,'X')
into STRICT	nm_localidade_w
from 	cep_loc
where 	cd_cep = cd_cep_p;
exception
when others then
	nm_localidade_w := 'X';
end;

begin
select 	cd_municipio_ibge
into STRICT	cd_municipio_w
from 	sus_cep
where 	cd_cep = cd_cep_p;
exception
when others then
	cd_municipio_w := null;
end;

-- INSERIR PRESTADOR RESSARCIMENTO
if (ie_opcao_p = 'I') then
	insert into pls_processo_prestador(	nr_sequencia, cd_estabelecimento, nm_prestador,
						ds_endereco, cd_cep , sg_estado,
						dt_atualizacao , nm_usuario, ie_natureza,
						cd_cnes, cd_municipio_ibge, ds_natureza_ups)
				values (		nextval('pls_processo_prestador_seq'), cd_estabelecimento_p, nm_prestador_p,
						nm_localidade_w,cd_cep_p, sg_uf_w,
						clock_timestamp(), nm_usuario_p, 1,
						cd_cnes_p, cd_municipio_w, ds_natureza_ups_p) returning nr_sequencia into nr_seq_prestador_p;

-- AUTILIZAR PRESTADOR RESSARCIMENTO
elsif (ie_opcao_p = 'U') then
	select max(nr_sequencia)
	into STRICT   nr_seq_prestador_w
	from   pls_processo_prestador
	where  cd_cnes = cd_cnes_p;

	if (nr_seq_prestador_w IS NOT NULL AND nr_seq_prestador_w::text <> '') then
		update 	pls_processo_prestador
		set	nm_prestador		= nm_prestador_p,
			ds_endereco		= CASE WHEN coalesce(nm_localidade_w,'X')='X' THEN nm_localidade_w  ELSE ds_endereco END ,
			cd_cep			= coalesce(cd_cep,cd_cep_p),
			sg_estado		= (case when(length(sg_estado) < 2) then sg_uf_w else sg_estado end),
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p,
			ie_natureza		= 1,
			cd_cnes			= cd_cnes_p,
			cd_municipio_ibge	= coalesce(cd_municipio_ibge,cd_municipio_w),
			ds_natureza_ups		= coalesce(ds_natureza_ups,ds_natureza_ups_p)
		where	nr_sequencia		= nr_seq_prestador_w;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_imp_prest_ressarcimento ( cd_cnes_p text, cd_cep_p text, nm_prestador_p text, sg_uf_p text, nm_usuario_p usuario.nm_usuario%type, ie_opcao_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ds_natureza_ups_p text, nr_seq_prestador_p INOUT text) FROM PUBLIC;

