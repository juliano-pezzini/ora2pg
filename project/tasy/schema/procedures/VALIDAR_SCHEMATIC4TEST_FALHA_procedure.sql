-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE validar_schematic4test_falha (NR_SEQ_SCHEDULE_P bigint, NR_SEQ_SCRIPT_P bigint, NM_USUARIO_P text) AS $body$
DECLARE


NR_SEQUENCIAW bigint;
IE_MANUALW varchar(2);
NR_SEQ_PACKAGEW bigint;
QTD_W bigint;
QTD_OSW bigint;


BEGIN
  --procedure that set invalid on script  
  INSERT INTO SCHEM_TEST_BEHOLDER(nr_sequencia, nm_usuario, dt_atualizacao, nm_usuario_nrec, dt_atualizacao_nrec, ds_interaction, ds_param_a, ds_param_b)
	VALUES (nextval('schem_test_beholder_seq'), NM_USUARIO_P, clock_timestamp(), 'Robot', clock_timestamp(), 'VALIDAR_SCHEMATIC4TEST_FALHA', 
	'NR_SEQ_SCHEDULE_P as '||NR_SEQ_SCHEDULE_P, 
	'NR_SEQ_SCRIPT_P as '||NR_SEQ_SCRIPT_P);

   SELECT NR_SEQ_PACKAGE
        INTO STRICT NR_SEQ_PACKAGEW 
      FROM SCHEM_TEST_SCHEDULE WHERE NR_SEQUENCIA = NR_SEQ_SCHEDULE_P;

   SELECT COUNT(NR_SEQUENCIA) QTD_OS
        INTO STRICT QTD_OSW
   FROM SCHEM_TEST_OS 
   WHERE NR_SEQ_PACK_SCHED = NR_SEQ_PACKAGEW 
   AND NR_SEQ_SCRIPT = NR_SEQ_SCRIPT_P
   AND IE_SITUACAO LIKE 'A';

  
  IF (QTD_OSW = 0) THEN  
    SELECT IE_MANUAL 
        INTO STRICT IE_MANUALW
    FROM SCHEM_TEST_LOG 
    WHERE NR_SEQ_SCHEDULE = NR_SEQ_SCHEDULE_P 
    AND NR_SEQ_SCRIPT = NR_SEQ_SCRIPT_P 
    AND IE_STATUS = '2' 
    AND coalesce(IE_MANUAL::text, '') = '';

    IF (coalesce(IE_MANUALW::text, '') = '') THEN
        UPDATE SCHEM_TEST_LOG SET NM_USUARIO = NM_USUARIO_P, IE_MANUAL = '1', DT_ATUALIZACAO = clock_timestamp(), IE_STATUS = '4' WHERE NR_SEQ_SCHEDULE = NR_SEQ_SCHEDULE_P AND NR_SEQ_SCRIPT = NR_SEQ_SCRIPT_P AND IE_STATUS = '2';
        commit;
    END IF;

    SELECT COUNT(NR_SEQUENCIA)
        INTO STRICT NR_SEQUENCIAW 
    FROM SCHEM_TEST_LOG WHERE NR_SEQ_SCHEDULE = NR_SEQ_SCHEDULE_P AND IE_STATUS = '2';

    IF (NR_SEQUENCIAW = 0) THEN
       UPDATE SCHEM_TEST_SCHEDULE SET IE_STATUS = '4' WHERE NR_SEQUENCIA = NR_SEQ_SCHEDULE_P;
       commit;
    END IF;

  END IF;

  CALL SCHEMATIC4TEST_SETSCHEDSTATUS(NR_SEQ_SCHEDULE_P);

	SELECT COUNT(TEST2.IE_STATUS) QTD
		INTO STRICT QTD_W
	FROM SCHEM_TEST_MAINTENANCE TEST2
	WHERE TEST2.NR_SEQ_SCRIPT = NR_SEQ_SCRIPT_P
	AND TEST2.IE_STATUS <> '0'
    AND NM_USUARIO NOT LIKE 'Robot';

    IF (QTD_W = 0) THEN
      INSERT INTO SCHEM_TEST_MAINTENANCE(NR_SEQUENCIA, DT_ATUALIZACAO, DT_ATUALIZACAO_NREC, NM_USUARIO, NM_USUARIO_NREC, NR_SEQ_SCRIPT, IE_STATUS, IE_PRIORITY, DS_OWNER, DS_SCHEDULE)
			VALUES (nextval('schem_test_maintenance_seq'), clock_timestamp(), clock_timestamp(), NM_USUARIO_P, NM_USUARIO_P, NR_SEQ_SCRIPT_P, '1', '1', NM_USUARIO_P, NR_SEQ_SCHEDULE_P);
    END IF;

  EXCEPTION
  WHEN no_data_found THEN
    RAISE NOTICE 'Erro: Data not found';
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE validar_schematic4test_falha (NR_SEQ_SCHEDULE_P bigint, NR_SEQ_SCRIPT_P bigint, NM_USUARIO_P text) FROM PUBLIC;

