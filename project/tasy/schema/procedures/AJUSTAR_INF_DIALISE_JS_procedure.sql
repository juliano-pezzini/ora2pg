-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ajustar_inf_dialise_js ( nr_prescricao_p bigint, nr_seq_solucao_p bigint, nr_ocorrencia_p bigint, dt_inicio_prescr_p timestamp, qt_hora_sessao_p bigint, --qt_material_p		Number,
 nm_usuario_p text) AS $body$
DECLARE


nr_etapas_inter_w			double precision;
ds_horarios_w				varchar(2000);
ds_horarios2_w				varchar(2000);
ds_erro_w					varchar(2000);
cd_material_w				prescr_material.cd_material%type;
nr_sequencia_w				prescr_material.nr_sequencia%type;
ie_via_aplicacao_w			prescr_material.ie_via_aplicacao%type;
qt_unitaria_w				prescr_material.qt_unitaria%type;
qt_material_w				prescr_material.qt_material%type;
qt_material_ww				prescr_material.qt_material%type;
ie_origem_inf_w				prescr_material.ie_origem_inf%type;
cd_unidade_medida_dose_w	prescr_material.cd_unidade_medida_dose%type;
qt_total_dispensar_w		prescr_material.qt_total_dispensar%type;
ie_regra_disp_w				prescr_material.ie_regra_disp%type;
cd_estabelecimento_w		prescr_medica.cd_estabelecimento%type;
ie_agrupador_w				prescr_material.ie_agrupador%type;
ds_horarios_ww				prescr_solucao.ds_horarios%type;
hr_prim_horario_w			prescr_solucao.hr_prim_horario%type;

c01 CURSOR FOR
SELECT	b.cd_material,
		b.nr_sequencia,
		b.ie_via_aplicacao,
		b.qt_unitaria,
		b.qt_material,
		b.ie_origem_inf,
		b.cd_unidade_medida_dose,
		a.cd_estabelecimento,
		b.ie_agrupador
from	prescr_material b,
		prescr_medica a
where	a.nr_prescricao = b.nr_prescricao
and		b.nr_prescricao = nr_prescricao_p
and		b.nr_sequencia_solucao = nr_seq_solucao_p
and		b.ie_agrupador = 13;


BEGIN


nr_etapas_inter_w	:= ceil(qt_hora_sessao_p/nr_ocorrencia_p);

SELECT * FROM calcula_horarios_etapas(dt_inicio_prescr_p, nr_ocorrencia_p, nr_etapas_inter_w, nm_usuario_p, '', qt_hora_sessao_p, ds_horarios_w, ds_horarios2_w, 'N', 'S') INTO STRICT ds_horarios_w, ds_horarios2_w;

ds_horarios_ww := ds_horarios_w || ds_horarios2_w;

if (ds_horarios_ww IS NOT NULL AND ds_horarios_ww::text <> '') then
	hr_prim_horario_w := obter_prim_dshorarios(ds_horarios_ww);
end if;

update	prescr_solucao
set		nr_etapas = nr_ocorrencia_p,
		ds_horarios = ds_horarios_ww,
		hr_prim_horario = coalesce(hr_prim_horario_w,hr_prim_horario)
where	nr_prescricao = nr_prescricao_p
and		nr_seq_solucao = nr_seq_solucao_p;

open C01;
loop
fetch C01 into
	cd_material_w,
	nr_sequencia_w,
	ie_via_aplicacao_w,
	qt_unitaria_w,
	qt_material_w,
	ie_origem_inf_w,
	cd_unidade_medida_dose_w,
	cd_estabelecimento_w,
	ie_agrupador_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	begin

		qt_material_ww	:= qt_material_w;

		SELECT * FROM obter_quant_dispensar(cd_estabelecimento_w, cd_material_w, nr_prescricao_p, nr_sequencia_w, null, ie_via_aplicacao_w, qt_unitaria_w, null, nr_ocorrencia_p, null, ie_origem_inf_w, cd_unidade_medida_dose_w, null, qt_material_ww, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w, 'N', 'N') INTO STRICT qt_material_ww, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w;


		update	prescr_material
		set		nr_ocorrencia = nr_ocorrencia_p,
				qt_material = qt_material_ww,
				qt_total_dispensar = qt_total_dispensar_w,
				ie_regra_disp = ie_regra_disp_w,
				nr_agrupamento = 0
		where	nr_prescricao = nr_prescricao_p
		and		nr_sequencia_solucao = nr_seq_solucao_p
		and		ie_agrupador = 13
		and		nr_sequencia = nr_sequencia_w;

	exception when others then
		null;
	end;


	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ajustar_inf_dialise_js ( nr_prescricao_p bigint, nr_seq_solucao_p bigint, nr_ocorrencia_p bigint, dt_inicio_prescr_p timestamp, qt_hora_sessao_p bigint,  nm_usuario_p text) FROM PUBLIC;

