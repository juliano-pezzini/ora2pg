-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_benef_pls_acert_dupl (cd_pessoa_fisica_p text, ie_consistencia_p INOUT text) AS $body$
DECLARE


ie_beneficiario_w	varchar(1);
ie_revisar_w		varchar(1);
ie_consistencia_w	varchar(1) := 'N';
ie_benef_inativo_w	varchar(10);


BEGIN
if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then

	ie_benef_inativo_w	:= coalesce(obter_valor_param_usuario(5, 227, Obter_Perfil_Ativo, wheb_usuario_pck.GET_NM_USUARIO, wheb_usuario_pck.GET_cd_estabelecimento), 'N');

	/* obter se beneficiario pls */

	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_beneficiario_w
        from    pls_segurado_carteira y,
        	pls_segurado x
	where	y.nr_seq_segurado = x.nr_sequencia
	and	y.dt_inicio_vigencia <= clock_timestamp()
	and	coalesce(y.dt_validade_carteira,clock_timestamp()) >= clock_timestamp()
	and	(x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '')
	and	((ie_benef_inativo_w = 'N' and coalesce(x.dt_rescisao::text, '') = '') or (ie_benef_inativo_w = 'S'))
        and     x.cd_pessoa_fisica = cd_pessoa_fisica_p;

	if (ie_beneficiario_w = 'S') then
		ie_consistencia_w := 'B';
	else
		/* obter se cadastro revisado */

		select	coalesce(max(ie_revisar),'N')
		into STRICT	ie_revisar_w
		from	pessoa_fisica
		where	cd_pessoa_fisica = cd_pessoa_fisica_p;

		if (ie_revisar_w = 'S') then
			ie_consistencia_w := 'R';
		end if;
	end if;
end if;

ie_consistencia_p := ie_consistencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_benef_pls_acert_dupl (cd_pessoa_fisica_p text, ie_consistencia_p INOUT text) FROM PUBLIC;

