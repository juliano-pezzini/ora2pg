-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_analise_ort_correcao ( nr_seq_analise_origem_p bigint, nm_usuario_p text, ds_conteudo_campo_p text, ie_gerar_relacao_p text, nr_seq_lote_p INOUT bigint, nr_seq_analise_p INOUT bigint) AS $body$
DECLARE


ie_diferenca_w			varchar(1);
nr_seq_lote_origem_w		bigint;
nr_seq_lote_w			bigint;
nr_sequencia_w			bigint;
ds_diferenca_w			varchar(255);
ie_function_w			varchar(1);
ie_origem_w			varchar(15);

cd_dominio_w			integer;
cd_funcao_w			integer;
dt_origem_w			timestamp;
nm_atributo_w			varchar(50);
nm_tabela_w			varchar(50);
nm_tabela_origem_w		varchar(50);
nm_usuario_origem_w		varchar(15);
nr_seq_cor_w			bigint;
nr_seq_objeto_w			bigint;
nr_seq_obj_filtro_w		bigint;
nr_seq_analise_w		bigint;
nr_seq_parametro_w		integer;
nr_seq_visao_w			bigint;
vl_dominio_w			varchar(15);
nr_seq_relatorio_w		bigint;
nr_seq_campo_relat_w		bigint;
nr_seq_param_relat_w		bigint;
ds_campo_w			varchar(255);
ds_campo_pai_w			varchar(255);
ds_metodo_w			varchar(255);
ds_classe_objeto_w		varchar(255);
ds_nome_objeto_w		varchar(255);
ds_form_w			varchar(10);
nr_parametro_w			bigint;
nr_ocorrencia_w			bigint;
nr_seq_analise_corr_w		bigint;
ds_conteudo_corr_w		varchar(4000);
nr_seq_ind_gestao_w		analise_ortografica.nr_seq_ind_gestao%type;
nr_seq_ind_gestao_atrib_w	analise_ortografica.nr_seq_ind_gestao_atrib%type;
nr_seq_subind_gestao_w		analise_ortografica.nr_seq_subind_gestao%type;
nr_seq_subind_gestao_atrib_w	analise_ortografica.nr_seq_subind_gestao_atrib%type;
cd_interface_w			interface.cd_interface%type;
nr_seq_referencia_w		bigint;
cd_tipo_lote_contabil_w		analise_ortografica.cd_tipo_lote_contabil%type;
cd_expressao_w			dic_expressao.cd_expressao%type;


BEGIN

if (nr_seq_analise_origem_p IS NOT NULL AND nr_seq_analise_origem_p::text <> '') then

	select	max(a.nr_sequencia),
		max(a.ds_conteudo_campo),
		max(a.nr_seq_lote)
	into STRICT	nr_seq_analise_corr_w,
		ds_conteudo_corr_w,
		nr_seq_lote_w
	from	analise_ortografica_lote b,
		analise_ortografica a
	where	coalesce(b.dt_confirmacao::text, '') = ''
	and	a.nr_seq_lote		= b.nr_sequencia
	and	a.nr_seq_origem		= nr_seq_analise_origem_p;

	/* se ainda não houver um registro de correção, gera um novo registro */

	if (coalesce(nr_seq_analise_corr_w::text, '') = '') then

		select	a.cd_dominio,
			a.cd_funcao,
			a.dt_origem,
			a.nm_atributo,
			a.nm_tabela,
			a.nm_tabela_origem,
			a.nm_usuario_origem,
			a.nr_seq_cor,
			a.nr_seq_objeto,
			a.nr_seq_obj_filtro,
			a.nr_seq_parametro,
			a.nr_seq_visao,
			a.vl_dominio,
			a.nr_seq_lote,
			a.nr_sequencia,
			a.nr_seq_relatorio,
			a.nr_seq_campo_relat,
			a.nr_seq_param_relat,
			a.ds_campo,
			a.ds_campo_pai,
			a.ds_metodo,
			a.ds_classe_objeto,
			a.ds_nome_objeto,
			a.ds_form,
			a.nr_parametro,
			a.nr_ocorrencia,
			a.nr_seq_ind_gestao,
			a.nr_seq_ind_gestao_atrib,
			a.nr_seq_subind_gestao,
			a.nr_seq_subind_gestao_atrib,
			a.cd_interface,
			a.nr_seq_referencia,
			a.cd_tipo_lote_contabil,
			a.cd_expressao
		into STRICT	cd_dominio_w,
			cd_funcao_w,
			dt_origem_w,
			nm_atributo_w,
			nm_tabela_w,
			nm_tabela_origem_w,
			nm_usuario_origem_w,
			nr_seq_cor_w,
			nr_seq_objeto_w,
			nr_seq_obj_filtro_w,
			nr_seq_parametro_w,
			nr_seq_visao_w,
			vl_dominio_w,
			nr_seq_lote_origem_w,
			nr_seq_analise_w,
			nr_seq_relatorio_w,
			nr_seq_campo_relat_w,
			nr_seq_param_relat_w,
			ds_campo_w,
			ds_campo_pai_w,
			ds_metodo_w,
			ds_classe_objeto_w,
			ds_nome_objeto_w,
			ds_form_w,
			nr_parametro_w,
			nr_ocorrencia_w,
			nr_seq_ind_gestao_w,
			nr_seq_ind_gestao_atrib_w,
			nr_seq_subind_gestao_w,
			nr_seq_subind_gestao_atrib_w,
			cd_interface_w,
			nr_seq_referencia_w,
			cd_tipo_lote_contabil_w,
			cd_expressao_w
		from	analise_ortografica a
		where	a.nr_sequencia		= nr_seq_analise_origem_p;

		select	max(a.nr_sequencia),
			max(a.ie_function),
			max(a.ie_origem)
		into STRICT	nr_seq_lote_w,
			ie_function_w,
			ie_origem_w
		from	analise_ortografica_lote a
		where	coalesce(a.dt_confirmacao::text, '') = ''
		and	a.nr_seq_lote_origem	= nr_seq_lote_origem_w;

		/* se ainda não tiver o lote de correção, gera-o */

		if (coalesce(nr_seq_lote_w::text, '') = '') then

			select	max(a.ie_origem),
				max(a.ie_function)
			into STRICT	ie_origem_w,
				ie_function_w
			from	analise_ortografica_lote a
			where	a.nr_sequencia	= nr_seq_lote_origem_w;

			nr_seq_lote_w := gerar_analise_ortografica_lote(nr_seq_lote_origem_w, nm_usuario_p, null, null, clock_timestamp(), ie_function_w, 'N', ie_origem_w, nr_seq_lote_w);

		end if;

		/* excluir para não gerar registros duplicados */

		delete	from analise_ortografica a
		where	coalesce(nm_atributo,'-1')			= coalesce(nm_atributo_w,'-1')
		and	coalesce(nm_tabela,'-1')			= coalesce(nm_tabela_w,'-1')
		and	coalesce(nr_seq_visao,0)			= coalesce(nr_seq_visao_w,0)
		and	coalesce(nr_seq_objeto,0)			= coalesce(nr_seq_objeto_w,0)
		and	coalesce(nr_seq_obj_filtro,0)		= coalesce(nr_seq_obj_filtro_w,0)
		and	coalesce(nr_seq_cor,0)			= coalesce(nr_seq_cor_w,0)
		and	coalesce(vl_dominio,'-1')			= coalesce(vl_dominio_w,'-1')
		and	coalesce(cd_dominio,0)			= coalesce(cd_dominio_w,0)
		and	coalesce(cd_funcao,0)			= coalesce(cd_funcao_w,0)
		and	coalesce(nr_seq_parametro,0)			= coalesce(nr_seq_parametro_w,0)
		and	coalesce(nr_seq_relatorio,0)			= coalesce(nr_seq_relatorio_w,0)
		and	coalesce(nr_seq_campo_relat,0)		= coalesce(nr_seq_campo_relat_w,0)
		and	coalesce(nr_seq_param_relat,0)		= coalesce(nr_seq_param_relat_w,0)
		and	coalesce(ds_nome_objeto,'-1')		= coalesce(ds_nome_objeto_w,'-1')
		and	coalesce(ds_classe_objeto,'-1')		= coalesce(ds_classe_objeto_w,'-1')
		and	coalesce(ds_form,'-1')			= coalesce(ds_form_w,'-1')
		and	coalesce(ds_metodo,'-1')			= coalesce(ds_metodo_w,'-1')
		and	coalesce(nr_parametro,0)			= coalesce(nr_parametro_w,0)
		and	coalesce(ds_campo,'-1')			= coalesce(ds_campo_w,'-1')
		and	coalesce(nr_ocorrencia,0)			= coalesce(nr_ocorrencia_w,0)
		and	coalesce(nm_tabela_origem,'-1')		= coalesce(nm_tabela_origem_w,'-1')
		and	coalesce(ds_campo_pai,'-1')			= coalesce(ds_campo_pai_w,'-1')
		and	coalesce(nr_seq_ind_gestao,0)		= coalesce(nr_seq_ind_gestao_w,0)
		and	coalesce(nr_seq_ind_gestao_atrib,0)		= coalesce(nr_seq_ind_gestao_atrib_w,0)
		and	coalesce(nr_seq_subind_gestao,0)		= coalesce(nr_seq_subind_gestao_w,0)
		and	coalesce(nr_seq_subind_gestao_atrib,0)	= coalesce(nr_seq_subind_gestao_atrib_w,0)
		and	coalesce(cd_interface,0)			= coalesce(cd_interface_w,0)
		and	coalesce(nr_seq_referencia,0)		= coalesce(nr_seq_referencia_w,0)
		and	coalesce(cd_tipo_lote_contabil,0)		= coalesce(cd_tipo_lote_contabil_w,0)
		and	coalesce(cd_expressao,0)			= coalesce(cd_expressao_w,0)
		and	exists (SELECT	1
			from	analise_ortografica_lote x
			where	(x.dt_importacao IS NOT NULL AND x.dt_importacao::text <> '')
			and	coalesce(x.dt_confirmacao::text, '') = ''
			and	x.nr_sequencia		= a.nr_seq_lote)
		and	not exists (select	1
			from	analise_ortografica_lote y,
				analise_ortografica x
			where	(y.dt_confirmacao IS NOT NULL AND y.dt_confirmacao::text <> '')
			and	x.nr_seq_lote		= y.nr_sequencia
			and	x.nr_seq_origem		= a.nr_sequencia)
		and	a.nr_seq_lote			not in (nr_seq_lote_p,nr_seq_lote_w);

		select	coalesce(max(a.nr_sequencia),0) + 1
		into STRICT	nr_sequencia_w
		from	analise_ortografica a;

		insert	into analise_ortografica(cd_dominio,
			cd_funcao,
			cd_interface,
			cd_tipo_lote_contabil,
			dt_atualizacao,
			dt_atualizacao_nrec,
			dt_origem,
			nm_atributo,
			nm_tabela,
			nm_tabela_origem,
			nm_usuario,
			nm_usuario_nrec,
			nm_usuario_origem,
			nr_seq_cor,
			nr_seq_lote,
			nr_seq_objeto,
			nr_seq_obj_filtro,
			nr_seq_origem,
			nr_seq_parametro,
			nr_sequencia,
			nr_seq_visao,
			vl_dominio,
			nr_seq_relatorio,
			nr_seq_campo_relat,
			nr_seq_param_relat,
			ie_diferenca,
			ds_conteudo_campo,
			ds_campo,
			ds_campo_pai,
			ds_metodo,
			ds_classe_objeto,
			ds_nome_objeto,
			ds_form,
			nr_parametro,
			nr_ocorrencia,
			nr_seq_ind_gestao,
			nr_seq_ind_gestao_atrib,
			nr_seq_subind_gestao,
			nr_seq_subind_gestao_atrib,
			nr_seq_referencia,
			cd_expressao)
		values (cd_dominio_w,
			cd_funcao_w,
			cd_interface_w,
			cd_tipo_lote_contabil_w,
			clock_timestamp(),
			clock_timestamp(),
			dt_origem_w,
			nm_atributo_w,
			nm_tabela_w,
			nm_tabela_origem_w,
			nm_usuario_p,
			nm_usuario_p,
			nm_usuario_origem_w,
			nr_seq_cor_w,
			nr_seq_lote_w,
			nr_seq_objeto_w,
			nr_seq_obj_filtro_w,
			nr_seq_analise_w,
			nr_seq_parametro_w,
			nr_sequencia_w,
			nr_seq_visao_w,
			vl_dominio_w,
			nr_seq_relatorio_w,
			nr_seq_campo_relat_w,
			nr_seq_param_relat_w,
			'S',
			ds_conteudo_campo_p,
			ds_campo_w,
			ds_campo_pai_w,
			ds_metodo_w,
			ds_classe_objeto_w,
			ds_nome_objeto_w,
			ds_form_w,
			nr_parametro_w,
			nr_ocorrencia_w,
			nr_seq_ind_gestao_w,
			nr_seq_ind_gestao_atrib_w,
			nr_seq_subind_gestao_w,
			nr_seq_subind_gestao_atrib_w,
			nr_seq_referencia_w,
			cd_expressao_w);

		/* corrigir os registros das outras visões da mesma tabela e, também, da própria tabela */

		if (coalesce(ie_gerar_relacao_p,'S')	= 'S') and
			((nm_tabela_origem_w = 'TABELA_VISAO_ATRIBUTO') or (nm_tabela_origem_w = 'TABELA_ATRIBUTO')) and (nr_seq_analise_w IS NOT NULL AND nr_seq_analise_w::text <> '') then

			CALL gerar_relacao_ortografica(nr_sequencia_w,nm_usuario_p);

		end if;

	else

		update	analise_ortografica
		set	ds_conteudo_campo	= ds_conteudo_campo_p,
			ie_diferenca		= CASE WHEN coalesce(ds_conteudo_campo_p,'-1')=coalesce(ds_conteudo_corr_w,'-1') THEN 'N'  ELSE 'S' END
		where	nr_sequencia		= nr_seq_analise_corr_w;

	end if;

end if;

nr_seq_analise_p	:= coalesce(nr_sequencia_w,nr_seq_analise_corr_w);
nr_seq_lote_p		:= nr_seq_lote_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_analise_ort_correcao ( nr_seq_analise_origem_p bigint, nm_usuario_p text, ds_conteudo_campo_p text, ie_gerar_relacao_p text, nr_seq_lote_p INOUT bigint, nr_seq_analise_p INOUT bigint) FROM PUBLIC;

