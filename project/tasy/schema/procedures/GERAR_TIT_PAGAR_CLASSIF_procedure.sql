-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_tit_pagar_classif ( nr_titulo_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_pessoa_fisica_w		varchar(255);
cd_cgc_w			varchar(14);
ie_origem_titulo_w		varchar(10);
vl_titulo_w			double precision;
nr_seq_conta_financ_w		bigint;
nr_seq_proj_rec_w		bigint;
nr_seq_trans_fin_baixa_w	bigint;
nr_seq_classe_tit_pag_w		bigint;
nr_sequencia_w			integer;
cd_estabelecimento_w		smallint;
nr_seq_trans_fin_w		bigint;
ie_considera_tf_titulo_w	varchar(1);
ie_tipo_titulo_pag_w		titulo_pagar.ie_tipo_titulo%type;
cd_moeda_w			titulo_pagar.cd_moeda%type;
count_w				bigint;


BEGIN

ie_considera_tf_titulo_w := obter_param_usuario(851, 197, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_considera_tf_titulo_w);

if (nr_titulo_p IS NOT NULL AND nr_titulo_p::text <> '') then

	/*esse count se torna necessario pois essa rotina chama no afterpost do delphi.
	Porém, se houver consistencia na trigger titulo_pagar_insert, não haver esse titulo no banco, mas no afterpost vai chamar essa rotina passando o nr_titulo_p, resultando em no data found */
	select	count(*)
	into STRICT	count_w
	from	titulo_pagar
	where	nr_titulo = nr_titulo_p;

	if (count_w > 0) then

		select	a.cd_estabelecimento,
			a.cd_cgc,
			a.nr_seq_proj_rec,
			a.nr_seq_trans_fin_baixa,
			a.vl_titulo,
			a.cd_pessoa_fisica,
			a.nr_seq_classe,
			a.ie_origem_titulo,
			a.nr_seq_trans_fin_contab,
			a.ie_tipo_titulo,
			a.cd_moeda
		into STRICT	cd_estabelecimento_w,
			cd_cgc_w,
			nr_seq_proj_rec_w,
			nr_seq_trans_fin_baixa_w,
			vl_titulo_w,
			cd_pessoa_fisica_w,
			nr_seq_classe_tit_pag_w,
			ie_origem_titulo_w,
			nr_seq_trans_fin_w,
			ie_tipo_titulo_pag_w,
			cd_moeda_w
		from	titulo_pagar a
		where	a.nr_titulo		= nr_titulo_p;

		nr_seq_conta_financ_w := obter_conta_financeira(	'S', cd_estabelecimento_w, null, null, null, null, null, cd_cgc_w, null, nr_seq_conta_financ_w, null, null, null, null, null, nr_seq_proj_rec_w, null, cd_pessoa_fisica_w, null, ie_origem_titulo_w, null, nr_seq_classe_tit_pag_w, null, nr_seq_trans_fin_w, null, null, ie_tipo_titulo_pag_w, null, cd_moeda_w);

		select	coalesce(max(nr_sequencia),0) + 1
		into STRICT	nr_sequencia_w
		from	titulo_pagar_classif
		where   nr_titulo = nr_titulo_p;
		/*AAMFIRMO OS 552777 em 22/02/2013  Não considerar a transação financeira do título campo NR_SEQ_TRANS_FIN_BAIXA no campo referente a transacao financeira  do titulo_pagar_classif*/

		if ( coalesce(ie_considera_tf_titulo_w,'S') = 'N') then
				nr_seq_trans_fin_baixa_w := null;
		end if;

		if (coalesce(nr_seq_conta_financ_w, 0) > 0) then
			insert	into	titulo_pagar_classif(cd_centro_custo,
				cd_conta_contabil,
				dt_atualizacao,
				nm_usuario,
				nr_contrato,
				nr_seq_conta_financ,
				nr_seq_trans_fin,
				nr_sequencia,
				nr_titulo,
				vl_acrescimo,
				vl_desconto,
				vl_original,
				vl_titulo)
			values (null,
				null,
				clock_timestamp(),
				nm_usuario_p,
				null,
				nr_seq_conta_financ_w,
				nr_seq_trans_fin_baixa_w,
				nr_sequencia_w,
				nr_titulo_p,
				0,
				0,
				0,
				vl_titulo_w);

			commit;
		end if;
	end if;
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_tit_pagar_classif ( nr_titulo_p bigint, nm_usuario_p text) FROM PUBLIC;

