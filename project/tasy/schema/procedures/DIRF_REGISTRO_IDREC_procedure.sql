-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dirf_registro_idrec ( nr_seq_lote_dirf_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_dirf_w	varchar(4);	
ds_arquivo_w	varchar(100);
separador_w	varchar(1) := '|';
posicao_w	bigint := 4;
nr_sequencia_w	bigint;
qt_registros_w	bigint;
				
C01 CURSOR FOR 
	SELECT to_char(a.cd_dirf) 
	from (SELECT 1708 cd_dirf  
	
union
 
	select 8045 cd_dirf  
	
union
 
	select 3280 cd_dirf  
	
union
 
	select 5952 cd_dirf  
	
union
 
	select 5960 cd_dirf  
	
union
 
	select 5979 cd_dirf  
	
union
 
	select 5987 cd_dirf  
	
union
 
	select 0588 cd_dirf  
	
union
 
	select 3208 cd_dirf  
	
union
 
	select 5987 cd_dirf ) a 
	order by cd_dirf;

BEGIN
 
posicao_w := 4;
 
OPEN C01;
LOOP 
FETCH C01 INTO 
	cd_dirf_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	ds_arquivo_w := 'IDREC' || separador_w || lpad(cd_dirf_w,4,'0') || separador_w;
	 
	select	nextval('w_dirf_arquivo_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	insert 	into w_dirf_arquivo(nr_sequencia, 
				   nm_usuario, 
				   nm_usuario_nrec, 
				   dt_atualizacao, 
				   dt_atualizacao_nrec, 
				   ds_arquivo, 
				   nr_seq_apresentacao, 
				   nr_seq_registro) 
	values (nr_sequencia_w, 
				   nm_usuario_p, 
				   nm_usuario_p, 
				   clock_timestamp(), 
				   clock_timestamp(), 
				   ds_arquivo_w, 
				   to_char(posicao_w), 
				   0);
	-- inserir os dados da pessoa fisica referente ao codigo dirf selecionado 
	posicao_w := DIRF_REGISTRO_BPFDEC(nr_seq_lote_dirf_p, lpad(cd_dirf_w,4,'0'), nm_usuario_p, posicao_w, posicao_w);				
	--inserir dados das pessoas jur√≠dicas 
	posicao_w := DIRF_REGISTRO_BPJDEC(nr_seq_lote_dirf_p, posicao_w, lpad(cd_dirf_w,4,'0'), nm_usuario_p, posicao_w);
	 
	select 	count(*) 
	into STRICT	qt_registros_w 
	from w_dirf_arquivo 
	where cd_darf = lpad(cd_dirf_w,4,'0') 
	and  nm_usuario = nm_usuario_p;
	 
	if qt_registros_w = 0 then 
		delete 
		from w_dirf_arquivo 
		where nr_sequencia = nr_sequencia_w;
	end if;
	 
	 
		 
	posicao_w := posicao_w + 1;
END LOOP;
CLOSE C01;
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dirf_registro_idrec ( nr_seq_lote_dirf_p bigint, nm_usuario_p text) FROM PUBLIC;

