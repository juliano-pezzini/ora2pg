-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_item_controle ( nr_cirurgia_p bigint, cd_material_p bigint, nr_seq_lote_fornec_p bigint, dt_validade_p timestamp, nm_usuario_p text, nr_seq_pepo_p bigint, qt_material_p bigint, nr_sequencia_p INOUT bigint) AS $body$
DECLARE


nr_sequencia_w		bigint;
qt_material_w		double precision;
qt_peso_unitario_w	double precision;
cd_estabelecimento_w bigint;


BEGIN

select MAX(coalesce(cd_estabelecimento,0))
into STRICT cd_estabelecimento_w
from cirurgia
where nr_cirurgia = nr_cirurgia_p;

BEGIN
SELECT	max(a.nr_sequencia),
	max(CASE WHEN qt_material_p=0 THEN b.qt_material  ELSE qt_material_p END ),
	max(coalesce(a.qt_peso_unitario,0))
INTO STRICT	nr_sequencia_w,
	qt_material_w,
	qt_peso_unitario_w
FROM	pepo_item_controle a,
	material_item_controle b
WHERE	b.nr_seq_item = a.nr_sequencia
AND	b.cd_material = cd_material_p
and ((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_w));
EXCEPTION
WHEN OTHERS THEN
	nr_sequencia_w		:= NULL;
	qt_material_w		:= NULL;
	qt_peso_unitario_w	:= NULL;
END;

SELECT	nextval('cirurgia_item_controle_seq')
INTO STRICT	nr_sequencia_p
;

IF (nr_sequencia_w > 0) THEN

	/* Deltetar o registro gerado pelo Tasy */

	DELETE	FROM cirurgia_item_controle
	WHERE	nr_seq_item_controle	= nr_sequencia_w
	AND	nm_usuario		= 'Tasy'
	AND	qt_item			= 0
	AND	nr_cirurgia		= nr_cirurgia_p;


	INSERT INTO cirurgia_item_controle(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_cirurgia,
		nr_seq_item_controle,
		ie_acao,
		qt_item,
		qt_peso,
		cd_material,
		nr_seq_lote_fornec,
		dt_validade,
		nr_seq_pepo,
		ie_situacao)
	VALUES (	nr_sequencia_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_cirurgia_p,
		nr_sequencia_w,
		1,
		qt_material_w,
		qt_material_w * qt_peso_unitario_w,
		cd_material_p,
		nr_seq_lote_fornec_p,
		dt_validade_p,
		nr_seq_pepo_p,
		'A');
	COMMIT;
END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_item_controle ( nr_cirurgia_p bigint, cd_material_p bigint, nr_seq_lote_fornec_p bigint, dt_validade_p timestamp, nm_usuario_p text, nr_seq_pepo_p bigint, qt_material_p bigint, nr_sequencia_p INOUT bigint) FROM PUBLIC;

