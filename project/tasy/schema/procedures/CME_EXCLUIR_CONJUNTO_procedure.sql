-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cme_excluir_conjunto ( ds_conjunto_p text, ds_lista_p INOUT text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_conjunto_w	    cm_conjunto.nr_sequencia%type;
nr_seq_conj_cont_w      cm_conjunto_cont.nr_sequencia%type;
nr_seq_requisicao_w     cm_requisicao.nr_sequencia%type;
nr_seq_receb_externo_w  cm_receb_externo.nr_sequencia%type;
nr_seq_envio_externo_w  cm_envio_externo.nr_sequencia%type;
nr_seq_expurgo_w        cm_expurgo_saldo.nr_sequencia%type;
nm_conjunto_w		    cm_conjunto.nm_conjunto%type;
ds_agenda_w			    varchar(255);
ds_conjunto_w		    varchar(255);
ds_lista_cme_w		    varchar(255);
ds_conj_cme_w		    varchar(255);
ds_lista_req_w		    varchar(255);
ds_lista_agenda_w	    varchar(255);
ds_receb_externo_w      varchar(255);
ds_envio_externo_w      varchar(255);
ds_expurgo_w            varchar(255);

C01 CURSOR FOR
	SELECT	a.nr_sequencia
	from	cm_conjunto a
	where	((obter_Se_Contido(a.nr_agrupador, '(' || ds_conjunto_p || ')') = 'S') or (obter_Se_Contido(a.nr_sequencia, '(' || ds_conjunto_p || ')') = 'S'))
	
union

	SELECT	a.nr_sequencia
	from	cm_conjunto a
	where	a.nr_agrupador in (	select	  b.nr_agrupador
			  	from	  cm_conjunto b
				where (obter_Se_Contido(b.nr_agrupador, '(' || ds_conjunto_p || ')') = 'N')
				and (obter_Se_Contido(b.nr_sequencia, '(' || ds_conjunto_p || ')') = 'S'))
	order by	nr_sequencia;

C02 CURSOR FOR
	SELECT	    nr_sequencia
	from	    cm_conjunto_cont
	where	    nr_seq_conjunto	= nr_seq_conjunto_w
	and	        coalesce(ie_situacao,'A') = 'A'
	order by    nr_sequencia;

C03 CURSOR FOR
	SELECT (substr( WHEB_MENSAGEM_PCK.get_texto(1188324) ||
                ' ' || nr_sequencia || ' - ' ||  WHEB_MENSAGEM_PCK.get_texto(1188323) ||
                ' ' || nr_seq_controle,1,200))
	from	    cm_conjunto_cont
	where	    ' ' || ds_lista_cme_w || ' ' like '% ' || nr_sequencia || ' %'
	and	        coalesce(ie_situacao,'A') = 'A'
	order by	nr_sequencia;

C04 CURSOR FOR
	SELECT	    nr_seq_requisicao
	from	    cm_requisicao_item
	where	    nr_seq_conjunto = nr_seq_conjunto_w
	group by	nr_seq_requisicao;

C05 CURSOR FOR
	SELECT	b.cd_agenda || ' - ' || c.ds_agenda || ' - ' || to_char(b.hr_inicio,'dd/mm/yyyy hh24:mi:ss')
	from	agenda c,
            agenda_paciente b,
            agenda_pac_cme a
	where	a.nr_seq_agenda	= b.nr_sequencia
	and	    b.cd_agenda		= c.cd_agenda
	and	    a.nr_seq_conjunto	= nr_seq_conjunto_w
	order by	ds_agenda,
                hr_inicio;

C06 CURSOR FOR
    SELECT	    nr_seq_receb_externo
    from	    cm_receb_externo_conj
    where	    nr_seq_conjunto = nr_seq_conjunto_w
    group by	nr_seq_receb_externo;

C07 CURSOR FOR
    SELECT	    nr_seq_envio
    from	    cm_envio_externo_item
    where	    nr_seq_conjunto = nr_seq_conjunto_w
    group by	nr_seq_envio;

C08 CURSOR FOR
    SELECT	    nr_sequencia
    from	    cm_expurgo_saldo
    where	    nr_seq_conjunto = nr_seq_conjunto_w
    group by	nr_sequencia;


BEGIN

open C01;
loop
fetch C01 into
	nr_seq_conjunto_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	open C02;
	loop
	fetch C02 into
		nr_seq_conj_cont_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		if (nr_seq_conj_cont_w IS NOT NULL AND nr_seq_conj_cont_w::text <> '') then
			begin
			ds_lista_cme_w	:= substr(nr_seq_conj_cont_w || ' ' || ds_lista_cme_w,1,255);
			end;
		end if;
		end;
	end loop;
	close C02;

	open C04;
	loop
	fetch C04 into
		nr_seq_requisicao_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
		begin
		if (nr_seq_requisicao_w IS NOT NULL AND nr_seq_requisicao_w::text <> '') then
			begin
			ds_lista_req_w	:= substr(nr_seq_requisicao_w || ', ' || ds_lista_req_w,1,255);
			end;
		end if;
		end;
	end loop;
	close C04;

	open C05;
	loop
	fetch C05 into
		ds_agenda_w;
	EXIT WHEN NOT FOUND; /* apply on C05 */
		begin
		if (ds_agenda_w IS NOT NULL AND ds_agenda_w::text <> '') then
			begin
			ds_lista_agenda_w	:= substr(ds_agenda_w || ', ' || ds_lista_agenda_w,1,255);
			end;
		end if;
		end;
	end loop;
	close C05;

    open C06;
    loop
    fetch C06 into
        nr_seq_receb_externo_w;
	EXIT WHEN NOT FOUND; /* apply on C06 */
        begin
        if (nr_seq_receb_externo_w IS NOT NULL AND nr_seq_receb_externo_w::text <> '') then
            begin
            ds_receb_externo_w	:= substr(nr_seq_receb_externo_w || ', ' || ds_receb_externo_w,1,255);
            end;
        end if;
        end;
    end loop;
    close C06;

    open C07;
    loop
    fetch C07 into
        nr_seq_envio_externo_w;
	EXIT WHEN NOT FOUND; /* apply on C07 */
        begin
        if (nr_seq_envio_externo_w IS NOT NULL AND nr_seq_envio_externo_w::text <> '') then
            begin
            ds_envio_externo_w	:= substr(nr_seq_envio_externo_w || ', ' || ds_envio_externo_w,1,255);
            end;
        end if;
        end;
    end loop;
    close C07;

    open C08;
    loop
    fetch C08 into
        nr_seq_expurgo_w;
	EXIT WHEN NOT FOUND; /* apply on C08 */
        begin
        if (nr_seq_expurgo_w IS NOT NULL AND nr_seq_expurgo_w::text <> '') then
            begin
            ds_expurgo_w	:= substr(nr_seq_expurgo_w || ', ' || ds_expurgo_w,1,255);
            end;
        end if;
        end;
    end loop;
    close C08;

	select	nm_conjunto
	into STRICT	nm_conjunto_w
	from	cm_conjunto
	where	nr_sequencia = nr_seq_conjunto_w;

	if (coalesce(ds_lista_cme_w::text, '') = '') and (coalesce(ds_lista_req_w::text, '') = '') and (coalesce(ds_lista_agenda_w::text, '') = '') and (coalesce(ds_receb_externo_w::text, '') = '') and (coalesce(ds_envio_externo_w::text, '') = '') and (coalesce(ds_expurgo_w::text, '') = '') then
		begin

            CALL cme_excluir_vinculo_conjunto(nr_sequencia_p => nr_seq_conjunto_w,
                                         nm_usuario_p 	=> nm_usuario_p);

		end;
	elsif (ds_lista_cme_w IS NOT NULL AND ds_lista_cme_w::text <> '') then
		begin
		open C03;
		loop
		fetch C03 into
			ds_conjunto_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			ds_conj_cme_w	:= substr(ds_conjunto_w || ', ' || ds_conj_cme_w,1,255);
			end;
		end loop;
		close C03;
            ds_conj_cme_w := substr(ds_conj_cme_w, 1, length(ds_conj_cme_w) -2);

            ds_lista_p := substr(WHEB_MENSAGEM_PCK.get_texto(nr_seq_mensagem_p => 1187349,
                                                             Vl_Macros_P       => 'NR_SEQ_CONJUNTO= ' || nr_seq_conjunto_w || ';NM_CONJUNTO= '|| nm_conjunto_w || ';NR_SEQ_CONJ_CONT= '|| ds_conj_cme_w),1,255);
		end;
	elsif (ds_lista_req_w IS NOT NULL AND ds_lista_req_w::text <> '') then
		begin
            ds_lista_req_w := substr(ds_lista_req_w, 1, length(ds_lista_req_w) -2);
            ds_lista_p := substr(WHEB_MENSAGEM_PCK.get_texto(nr_seq_mensagem_p => 1187351,
                                                             Vl_Macros_P       => 'NR_SEQ_CONJUNTO= ' || nr_seq_conjunto_w || ';NM_CONJUNTO= '|| nm_conjunto_w || ';Nr_SEQ_REQUISICAO= '|| ds_lista_req_w),1,255);
		end;
	elsif (ds_lista_agenda_w IS NOT NULL AND ds_lista_agenda_w::text <> '') then
		begin
            ds_lista_agenda_w := substr(ds_lista_agenda_w, 1, length(ds_lista_agenda_w) -2);
            ds_lista_p := substr(WHEB_MENSAGEM_PCK.get_texto(nr_seq_mensagem_p => 1187354,
                                                             Vl_Macros_P       => 'NR_SEQ_CONJUNTO= ' || nr_seq_conjunto_w || ';NM_CONJUNTO= '|| nm_conjunto_w || ';DS_AGENDA= '|| ds_lista_agenda_w),1,255);
		end;
    elsif (ds_receb_externo_w IS NOT NULL AND ds_receb_externo_w::text <> '') then
        begin
            ds_receb_externo_w := substr(ds_receb_externo_w, 1, length(ds_receb_externo_w) -2);
            ds_lista_p := substr(WHEB_MENSAGEM_PCK.get_texto(nr_seq_mensagem_p => 1187357,
                                                             Vl_Macros_P       => 'NR_SEQ_CONJUNTO= ' || nr_seq_conjunto_w || ';NM_CONJUNTO= '|| nm_conjunto_w || ';NR_SEQ_RECEB_EXTERNO= '|| ds_receb_externo_w),1,255);
        end;
    elsif (ds_envio_externo_w IS NOT NULL AND ds_envio_externo_w::text <> '') then
        begin
            ds_envio_externo_w := substr(ds_envio_externo_w, 1, length(ds_envio_externo_w) -2);
            ds_lista_p := substr(WHEB_MENSAGEM_PCK.get_texto(nr_seq_mensagem_p => 1187358,
                                                             Vl_Macros_P       => 'NR_SEQ_CONJUNTO= ' || nr_seq_conjunto_w || ';NM_CONJUNTO= '|| nm_conjunto_w || ';NR_SEQ_ENVIO_EXTERNO= '|| ds_envio_externo_w),1,255);
        end;
    elsif (ds_expurgo_w IS NOT NULL AND ds_expurgo_w::text <> '') then
        begin
            ds_lista_p := substr(WHEB_MENSAGEM_PCK.get_texto(nr_seq_mensagem_p => 1187359),1,255);
        end;
	end if;

	ds_conjunto_w	    := null;
	ds_lista_cme_w	    := null;
	ds_conj_cme_w	    := null;
	ds_lista_req_w	    := null;
	ds_lista_agenda_w	:= null;
    ds_receb_externo_w  := null;
    ds_expurgo_w        := null;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cme_excluir_conjunto ( ds_conjunto_p text, ds_lista_p INOUT text, nm_usuario_p text) FROM PUBLIC;

