-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ratear_convenio_receb_tit_rec (nr_seq_receb_p bigint, nr_seq_conv_receb_tit_p INOUT bigint, nm_usuario_p text) AS $body$
DECLARE


vl_recebimento_w	convenio_receb.vl_recebimento%Type;
vl_titulo_w		titulo_receber.vl_titulo%type;
vl_total_titulos_w	titulo_receber.vl_titulo%type;
nr_sequencia_w		convenio_receb_tit_rec.nr_sequencia%type;
vl_rateado_w		double precision;
pr_calculo_w		bigint;
vl_acumulado_w		double precision;
vl_diferenca_w		double precision;
C01 CURSOR FOR
	SELECT	t.vl_titulo,
		a.nr_sequencia
	from	convenio_receb_tit_rec a,
		titulo_receber t
	where	a.nr_seq_receb = nr_seq_receb_p
	and	a.nr_titulo = t.nr_titulo
	order by t.vl_titulo;



BEGIN

if (nr_seq_receb_p IS NOT NULL AND nr_seq_receb_p::text <> '') then


	select	vl_recebimento
	into STRICT	vl_recebimento_w
	from	convenio_receb
	where	nr_sequencia = nr_seq_receb_p;

	select	sum(t.vl_titulo)
	into STRICT	vl_total_titulos_w
	from	convenio_receb_tit_rec a,
		titulo_receber t
	where	a.nr_seq_receb = nr_seq_receb_p
	and	a.nr_titulo = t.nr_titulo;

	--Possibilidade 1 Se o recebimetno é maior que a soma dos títulos, então vincula o valor total do título
	/*if	(vl_recebimento_w >= vl_total_titulos_w) then

		update	convenio_receb_tit_rec a
		set	a.vl_vinculado = (select x.vl_titulo from titulo_receber x where x.nr_titulo = a.nr_titulo)
		where	nr_seq_receb = nr_seq_receb_p;	q
	else*/
		vl_acumulado_w := 0;
		nr_sequencia_w := 0;
		open C01;
		loop
		fetch C01 into
			vl_titulo_w,
			nr_sequencia_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */

			pr_calculo_w := (dividir(vl_titulo_w,vl_total_titulos_w) * 100);


			RAISE NOTICE 'pr calc=%', pr_calculo_w;

			vl_rateado_w := dividir((vl_recebimento_w * pr_calculo_w),100);

			RAISE NOTICE 'rateado=%', vl_rateado_w;

			vl_acumulado_w := vl_acumulado_w + vl_rateado_w;

			update	convenio_receb_tit_rec
			set	vl_vinculado = vl_rateado_w,
				nm_usuario   = nm_usuario_p,
				dt_atualizacao = clock_timestamp()
			where	nr_sequencia = nr_sequencia_w;

		end loop;
		close C01;

		vl_diferenca_w := vl_recebimento_w - vl_acumulado_w;
		RAISE NOTICE 'vl_acumulado_w=%', vl_acumulado_w;

		RAISE NOTICE 'vl_recebimento_w=%', vl_recebimento_w;
		RAISE NOTICE 'vl_diferenca_w=%', vl_diferenca_w;
		if (vl_diferenca_w <> 0) then

			update	convenio_receb_tit_rec
			set	vl_vinculado = vl_vinculado +(vl_diferenca_w),
				nm_usuario   = nm_usuario_p,
				dt_atualizacao = clock_timestamp()
			where	nr_sequencia = nr_sequencia_w;

		end if;

	--end if;
commit;

end if;
nr_seq_conv_receb_tit_p := nr_sequencia_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ratear_convenio_receb_tit_rec (nr_seq_receb_p bigint, nr_seq_conv_receb_tit_p INOUT bigint, nm_usuario_p text) FROM PUBLIC;

