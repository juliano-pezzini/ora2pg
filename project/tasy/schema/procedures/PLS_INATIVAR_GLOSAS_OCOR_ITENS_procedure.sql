-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inativar_glosas_ocor_itens ( nr_seq_analise_p pls_analise_conta.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, nr_seq_grupo_atual_p pls_auditoria_conta_grupo.nr_seq_grupo%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


nr_seq_fluxo_w	pls_analise_fluxo_item.nr_sequencia%type;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_conta_proc
	where 	nr_seq_conta = nr_seq_conta_p
	and		coalesce(nr_seq_conta_proc_p::text, '') = ''
	and		coalesce(nr_seq_conta_mat_p::text, '') = ''
	
union all

	SELECT	nr_sequencia
	from	pls_conta_proc
	where 	nr_sequencia = nr_seq_conta_proc_p;

C02 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_conta_mat
	where 	nr_seq_conta = nr_seq_conta_p
	and		coalesce(nr_seq_conta_proc_p::text, '') = ''
	and		coalesce(nr_seq_conta_mat_p::text, '') = ''
	
union all

	SELECT	nr_sequencia
	from	pls_conta_mat
	where 	nr_sequencia = nr_seq_conta_mat_p;

C03 CURSOR( nr_seq_proc_pc	pls_conta_proc.nr_sequencia%type) FOR
	SELECT	nr_sequencia
	from	pls_ocorrencia_benef
	where	nr_seq_conta_proc = nr_seq_proc_pc;

C04 CURSOR( nr_seq_mat_pc	pls_conta_mat.nr_sequencia%type) FOR
	SELECT	nr_sequencia
	from	pls_ocorrencia_benef
	where	nr_seq_conta_mat = nr_seq_mat_pc;
BEGIN

	for r_c01_w in C01 loop

		update 	pls_ocorrencia_benef
		set 	ie_situacao = 'I',
				dt_atualizacao = clock_timestamp(),
				nm_usuario = nm_usuario_p
		where	nr_seq_conta_proc = r_c01_w.nr_sequencia;

		update 	pls_conta_glosa
		set		ie_situacao = 'I',
				dt_atualizacao = clock_timestamp(),
				nm_usuario = nm_usuario_p
		where	nr_seq_conta_proc = r_c01_w.nr_sequencia;

		nr_seq_fluxo_w := pls_gravar_fluxo_analise_item(	nr_seq_analise_p, nr_seq_conta_p, r_c01_w.nr_sequencia, null, null, null, nr_seq_grupo_atual_p, 'L', null, ' Glosa/ocorrência inativada via botão direito Inativar glosas/ocorrências itens', 'N', 'N', nm_usuario_p, 'S', 'L', 1, nr_seq_fluxo_w);


		for r_c03_w in C03(r_c01_w.nr_sequencia) loop
			update pls_analise_glo_ocor_grupo set ie_status = 'L' where nr_seq_ocor_benef= r_c03_w.nr_sequencia;
		end loop;

	end loop;

	for r_c02_w in c02 loop

		update 	pls_ocorrencia_benef
		set 	ie_situacao = 'I',
				dt_atualizacao = clock_timestamp(),
				nm_usuario = nm_usuario_p
		where	nr_seq_conta_proc = r_c02_w.nr_sequencia;

		update 	pls_conta_glosa
		set		ie_situacao = 'I',
				dt_atualizacao = clock_timestamp(),
				nm_usuario = nm_usuario_p
		where	nr_seq_conta_mat = r_c02_w.nr_sequencia;

		nr_seq_fluxo_w := pls_gravar_fluxo_analise_item(	nr_seq_analise_p, nr_seq_conta_p, null, r_c02_w.nr_sequencia, null, null, nr_seq_grupo_atual_p, 'L', null, ' Glosa/ocorrência inativada via botão direito Inativar glosas/ocorrências itens', 'N', 'N', nm_usuario_p, 'S', 'L', 1, nr_seq_fluxo_w);

		for r_c04_w in C04(r_c02_w.nr_sequencia) loop
			update pls_analise_glo_ocor_grupo set ie_status = 'L' where nr_seq_ocor_benef= r_c04_w.nr_sequencia;
		end loop;

	end loop;

	CALL pls_inserir_hist_analise(nr_seq_conta_p, nr_seq_analise_p, 1,
			 null, null, null,
			 null, 'Executada opção Inativar glosas/ocorrências itens', nr_seq_grupo_atual_p,
			 nm_usuario_p, cd_estabelecimento_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inativar_glosas_ocor_itens ( nr_seq_analise_p pls_analise_conta.nr_sequencia%type, nr_seq_conta_p pls_conta.nr_sequencia%type, nr_seq_conta_proc_p pls_conta_proc.nr_sequencia%type, nr_seq_conta_mat_p pls_conta_mat.nr_sequencia%type, nr_seq_grupo_atual_p pls_auditoria_conta_grupo.nr_seq_grupo%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

