-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_dias_ressup_matriz ( cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_material_w 			integer;
ie_abc_w				varchar(1);
ie_xyz_w				varchar(1);
ie_atualizar_w			varchar(1);
qt_dia_interv_ressup_w		bigint;
qt_dia_ressup_forn_w			bigint;
qt_dia_estoque_minimo_w		bigint;


C01 CURSOR FOR
SELECT	cd_material,
	ie_curva_xyz
from	material_estab
where	cd_estabelecimento	= cd_estabelecimento_p
and	(ie_curva_xyz IS NOT NULL AND ie_curva_xyz::text <> '')
and 	(((qt_dia_interv_ressup + qt_dia_ressup_forn + qt_dia_estoque_minimo) > 0)
or 	((coalesce(qt_dia_interv_ressup::text, '') = '') or (coalesce(qt_dia_ressup_forn::text, '') = '') or (coalesce(qt_dia_estoque_minimo::text, '') = '')));


BEGIN

OPEN C01;
LOOP
FETCH C01 	into
		cd_material_w,
		ie_xyz_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

	ie_abc_w			:= null;
	SELECT * FROM Man_Obter_dias_Ressup(	cd_estabelecimento_p, cd_material_w, ie_abc_w, ie_xyz_w, qt_dia_interv_ressup_w, qt_dia_ressup_forn_w, qt_dia_estoque_minimo_w, ie_atualizar_w) INTO STRICT qt_dia_interv_ressup_w, qt_dia_ressup_forn_w, qt_dia_estoque_minimo_w, ie_atualizar_w;
	if (ie_atualizar_w	= 'S') then
		update material_estab
		set	qt_dia_interv_ressup		= CASE WHEN qt_dia_interv_ressup_w=0 THEN  qt_dia_interv_ressup  ELSE qt_dia_interv_ressup_w END ,
			qt_dia_ressup_forn		= CASE WHEN qt_dia_ressup_forn_w=0 THEN  qt_dia_ressup_forn  ELSE qt_dia_ressup_forn_w END ,
			qt_dia_estoque_minimo	= CASE WHEN qt_dia_estoque_minimo_w=0 THEN  qt_dia_estoque_minimo  ELSE qt_dia_estoque_minimo_w END ,
			dt_atualizacao		= clock_timestamp(),
			nm_usuario			= nm_usuario_p
		where	cd_estabelecimento		= cd_estabelecimento_p
		and	cd_material			= cd_material_w;
	end if;

END LOOP;
CLOSE C01;
commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_dias_ressup_matriz ( cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

