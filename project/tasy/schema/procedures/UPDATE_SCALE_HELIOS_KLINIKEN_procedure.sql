-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE update_scale_helios_kliniken ( nr_sequencia_p bigint, nm_usuario_p text, flag_p bigint, qt_pontuacao_w INOUT bigint ) AS $body$
DECLARE


    ie_risco1_w  varchar(30);
    ie_risco2_w  varchar(30);
    qt_risco1_w  numeric(30);
    qt_risco2_w  numeric(30);
    sql_w        varchar(200);


BEGIN
    qt_pontuacao_w := 0;
    SELECT
        MAX(ie_risco)
    INTO STRICT ie_risco1_w
    FROM
        escala_helios_prof1
    WHERE
            nr_seq_helios = nr_sequencia_p
        AND coalesce(ie_situacao, 'A') = 'A';

    SELECT
        MAX(ie_risco)
    INTO STRICT ie_risco2_w
    FROM
        escala_helios_prof2
    WHERE
            nr_seq_helios = nr_sequencia_p
        AND coalesce(ie_situacao, 'A') = 'A';

--INICIO MD 1
    BEGIN
        sql_w := 'CALL obter_pont_helios_kliniken_md(:1, :2) INTO :qt_pontuacao_w';

        EXECUTE sql_w
            USING IN ie_risco1_w, IN ie_risco2_w,  OUT qt_pontuacao_w;

    EXCEPTION
        WHEN OTHERS THEN
            qt_pontuacao_w := NULL;
    END;
--FIM MD 1
    UPDATE escala_helios
    SET
        qt_pontuacao = qt_pontuacao_w
    WHERE
        nr_sequencia = nr_sequencia_p;

    IF ( flag_p = 1 ) THEN
        UPDATE escala_helios_prof1
        SET
            dt_liberacao = clock_timestamp()
        WHERE
                nr_seq_helios = nr_sequencia_p
            AND coalesce(dt_liberacao::text, '') = ''
            AND nm_usuario = nm_usuario_p;

    ELSIF ( flag_p = 2 ) THEN
        UPDATE escala_helios_prof2
        SET
            dt_liberacao = clock_timestamp()
        WHERE
                nr_seq_helios = nr_sequencia_p
            AND coalesce(dt_liberacao::text, '') = ''
            AND nm_usuario = nm_usuario_p;

    END IF;

    COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE update_scale_helios_kliniken ( nr_sequencia_p bigint, nm_usuario_p text, flag_p bigint, qt_pontuacao_w INOUT bigint ) FROM PUBLIC;

