-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicar_limpar_classif_diag (( nr_atendimento_p bigint, nm_usuario_p text) is ie_diag_tratamento_w diagnostico_doenca.ie_diag_tratamento%type) RETURNS varchar AS $body$
DECLARE

	ie_marcado_w varchar(1);
	
BEGIN
	
	select  	coalesce(max(ie_valor_padrao), 'N')
	into STRICT	ie_marcado_w
	from    	classificacao_diagnostico
	where   	ie_classificacao_diagnostico = ds_atrib_dominio_p;
	
	return ie_marcado_w;
end;

begin
	
	for c01_w in C01 loop
	begin
		insert into diagnostico_doenca_depart(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_profissional,
			nr_atendimento,
			ie_situacao,
			cd_pessoa_fisica,
			cd_doenca,
			dt_diagnostico,
			ie_tipo_afeicao,
			dt_registro,
			ie_diag_tratamento,
			ie_diag_referencia,
			ie_diag_princ_episodio,
			ie_diag_princ_depart,
			ie_diag_pre_cir,
			ie_diag_obito,
			ie_diag_cirurgia,
			ie_diag_alta,
			ie_diag_admissao,
			ie_diag_trat_cert,
			cd_setor_atendimento,
			ie_diag_trat_especial,
			ie_diag_cronico
		) values (
			nextval('diagnostico_doenca_depart_seq'),
			clock_timestamp(),
			nm_usuario_p,
			c01_w.dt_atualizacao,
			c01_w.nm_usuario,
			c01_w.cd_medico,
			c01_w.nr_atendimento,
			c01_w.ie_situacao,
			obter_pessoa_atendimento(c01_w.nr_atendimento, 'C'),
			c01_w.cd_doenca,
			c01_w.dt_diagnostico,
			c01_w.ie_tipo_afeicao,
			c01_w.dt_atualizacao,
			c01_w.ie_diag_tratamento,
			c01_w.ie_diag_referencia,
			c01_w.ie_diag_princ_episodio,
			c01_w.ie_diag_princ_depart,
			c01_w.ie_diag_pre_cir,
			c01_w.ie_diag_obito,
			c01_w.ie_diag_cirurgia,
			c01_w.ie_diag_alta,
			c01_w.ie_diag_admissao,
			c01_w.ie_diag_trat_cert,
			c01_w.cd_setor_atendimento,
			c01_w.ie_diag_trat_especial,
			c01_w.ie_diag_cronico
		);
		
		ie_diag_tratamento_w 		:= ie_marcado_auto('BEH');
		ie_diag_referencia_w 		:= ie_marcado_auto('UBE');
		ie_diag_princ_episodio_w 		:= ie_marcado_auto('DPE');
		ie_diag_princ_depart_w 		:= ie_marcado_auto('FAC');
		ie_diag_pre_cir_w 			:= ie_marcado_auto('POD');
		ie_diag_obito_w 			:= ie_marcado_auto('TOD');
		ie_diag_cirurgia_w 			:= ie_marcado_auto('OPD');
		ie_diag_alta_w 			:= ie_marcado_auto('ENT');
		ie_diag_admissao_w 		:= ie_marcado_auto('AUF');
		ie_diag_trat_cert_w 		:= ie_marcado_auto('BHS');
		ie_diag_cronico_w			:= ie_marcado_auto('FAL');
		ie_diag_trat_especial_w  		:= ie_marcado_auto('ASV');
		
		update 	diagnostico_doenca
		set	ie_diag_tratamento = ie_diag_tratamento_w,
			ie_diag_referencia = ie_diag_referencia_w,
			ie_diag_princ_episodio = ie_diag_princ_episodio_w,
			ie_diag_princ_depart = ie_diag_princ_depart_w,
			ie_diag_pre_cir = ie_diag_pre_cir_w,
			ie_diag_obito = ie_diag_obito_w,
			ie_diag_cirurgia = ie_diag_cirurgia_w,
			ie_diag_alta = ie_diag_alta_w,
			ie_diag_admissao = ie_diag_admissao_w,
			ie_diag_trat_cert = ie_diag_trat_cert_w,
			ie_diag_cronico = ie_diag_cronico_w,
			ie_diag_trat_especial = ie_diag_trat_especial_w
		where	nr_atendimento = nr_atendimento_p
		and	cd_doenca = c01_w.cd_doenca
		and 	dt_diagnostico = c01_w.dt_diagnostico;
		
	end;
	end loop;
		
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_limpar_classif_diag (( nr_atendimento_p bigint, nm_usuario_p text) is ie_diag_tratamento_w diagnostico_doenca.ie_diag_tratamento%type) FROM PUBLIC;

