-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_contato_resc_estip ( nr_seq_solicitacao_p pls_solicitacao_rescisao.nr_sequencia%type, ie_commit_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_contrato_w		pls_solicitacao_rescisao.nr_seq_contrato%type;
nr_seq_intercambio_w		pls_solicitacao_rescisao.nr_seq_intercambio%type;
cd_cgc_w			pessoa_juridica.cd_cgc%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
nr_ddi_telefone_estip_w		compl_pessoa_fisica.nr_ddi_telefone%type;
nr_ddd_telefone_estip_w		compl_pessoa_fisica.nr_ddd_telefone%type;
nr_telefone_estip_w		compl_pessoa_fisica.nr_telefone%type;
ds_email_estip_w		compl_pessoa_fisica.ds_email%type;
ds_bairro_estip_w		compl_pessoa_fisica.ds_bairro%type;
cd_municipio_ibge_estip_w	compl_pessoa_fisica.cd_municipio_ibge%type;
ds_municipio_estip_w		compl_pessoa_fisica.ds_municipio%type;
sg_estado_estip_w		compl_pessoa_fisica.sg_estado%type;
ds_complemento_estip_w		compl_pessoa_fisica.ds_complemento%type;
cd_cep_estip_w			compl_pessoa_fisica.cd_cep%type;
ds_endereco_estip_w		compl_pessoa_fisica.ds_endereco%type;
nr_endereco_estip_w		compl_pessoa_fisica.nr_endereco%type;
ie_forma_envio_estip_w		pls_solic_resc_contato.ie_forma_envio%type;
nr_seq_tipo_contato_w		pls_tp_contato_solic_resc.nr_sequencia%type;


BEGIN

select	max(nr_seq_contrato),
	max(nr_seq_intercambio)
into STRICT	nr_seq_contrato_w,
	nr_seq_intercambio_w
from	pls_solicitacao_rescisao
where	nr_sequencia	= nr_seq_solicitacao_p;

if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then
	ie_forma_envio_estip_w	:= null;
	
	select	max(ds_email)
	into STRICT	ds_email_estip_w
	from	pls_contrato_pagador
	where	nr_seq_contrato	= nr_seq_contrato_w
	and	ie_tipo_pagador = 'P'; --Buscar o e-mail do pagador principal do contrato, que e a propria empresa
	
	begin
	select	a.cd_cgc_estipulante,
		a.cd_estabelecimento,
		b.nr_ddi_telefone,
		b.nr_ddd_telefone,
		b.nr_telefone,
		b.ds_bairro,
		b.cd_municipio_ibge,
		b.ds_municipio,
		b.sg_estado,
		b.ds_complemento,
		b.cd_cep,
		b.ds_endereco,
		somente_numero(b.nr_endereco)
	into STRICT	cd_cgc_w,
		cd_estabelecimento_w,
		nr_ddi_telefone_estip_w,
		nr_ddd_telefone_estip_w,
		nr_telefone_estip_w,
		ds_bairro_estip_w,
		cd_municipio_ibge_estip_w,
		ds_municipio_estip_w,
		sg_estado_estip_w,
		ds_complemento_estip_w,
		cd_cep_estip_w,
		ds_endereco_estip_w,
		nr_endereco_estip_w
	from	pls_contrato a,
		pessoa_juridica b
	where	b.cd_cgc	= a.cd_cgc_estipulante
	and	a.nr_sequencia	= nr_seq_contrato_w;
	
	if (coalesce(ds_email_estip_w::text, '') = '') then
		select	max(ds_email)
		into STRICT	ds_email_estip_w
		from	pessoa_juridica_estab
		where	cd_cgc	= cd_cgc_w
		and	cd_estabelecimento = cd_estabelecimento_w;
	end if;
	
	if (ds_email_estip_w IS NOT NULL AND ds_email_estip_w::text <> '') then
		ie_forma_envio_estip_w	:= '1';
	else
		ie_forma_envio_estip_w	:= '2';
	end if;
	exception
	when others then
		nr_ddi_telefone_estip_w		:= null;
		nr_ddd_telefone_estip_w		:= null;
		nr_telefone_estip_w		:= null;
		ds_email_estip_w		:= null;
		ds_bairro_estip_w		:= null;
		cd_municipio_ibge_estip_w	:= null;
		ds_municipio_estip_w		:= null;
		sg_estado_estip_w		:= null;
		ds_complemento_estip_w		:= null;
		cd_cep_estip_w			:= null;
		ds_endereco_estip_w		:= null;
		nr_endereco_estip_w		:= null;
	end;
	
	if (ie_forma_envio_estip_w IS NOT NULL AND ie_forma_envio_estip_w::text <> '') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_tipo_contato_w
		from	pls_tp_contato_solic_resc
		where	ie_padrao_estipulante = 'S'
		and	ie_situacao = 'A';
		
		if (nr_seq_tipo_contato_w IS NOT NULL AND nr_seq_tipo_contato_w::text <> '') then
			insert	into	pls_solic_resc_contato(	nr_sequencia, nr_seq_solicitacao, nr_seq_tipo_contato,
					dt_atualizacao, dt_atualizacao_nrec, nm_usuario, nm_usuario_nrec,
					ds_email, cd_cep, ds_endereco, nr_endereco,
					ds_complemento, ds_bairro, cd_municipio_ibge, sg_estado,
					nr_ddi_telefone, nr_ddd_telefone, nr_telefone,
					ie_forma_envio)
			values (nextval('pls_solic_resc_contato_seq'), nr_seq_solicitacao_p, nr_seq_tipo_contato_w,
					clock_timestamp(), clock_timestamp(), nm_usuario_p, nm_usuario_p,
					ds_email_estip_w, cd_cep_estip_w, ds_endereco_estip_w, nr_endereco_estip_w,
					ds_complemento_estip_w, ds_bairro_estip_w, cd_municipio_ibge_estip_w, sg_estado_estip_w,
					nr_ddi_telefone_estip_w, nr_ddd_telefone_estip_w, nr_telefone_estip_w,
					ie_forma_envio_estip_w);
		end if;
	end if;

elsif (nr_seq_intercambio_w IS NOT NULL AND nr_seq_intercambio_w::text <> '') then
	ie_forma_envio_estip_w	:= null;
	
	select	max(ds_email)
	into STRICT	ds_email_estip_w
	from	pls_contrato_pagador
	where	nr_seq_pagador_intercambio	= nr_seq_intercambio_w
	and	ie_tipo_pagador = 'P'; --Buscar o e-mail do pagador principal do contrato intercambio, que e a propria empresa
	
	begin
	select	a.cd_cgc,
		a.cd_estabelecimento,
		b.nr_ddi_telefone,
		b.nr_ddd_telefone,
		b.nr_telefone,
		b.ds_bairro,
		b.cd_municipio_ibge,
		b.ds_municipio,
		b.sg_estado,
		b.ds_complemento,
		b.cd_cep,
		b.ds_endereco,
		somente_numero(b.nr_endereco)
	into STRICT	cd_cgc_w,
		cd_estabelecimento_w,
		nr_ddi_telefone_estip_w,
		nr_ddd_telefone_estip_w,
		nr_telefone_estip_w,
		ds_bairro_estip_w,
		cd_municipio_ibge_estip_w,
		ds_municipio_estip_w,
		sg_estado_estip_w,
		ds_complemento_estip_w,
		cd_cep_estip_w,
		ds_endereco_estip_w,
		nr_endereco_estip_w
	from	pls_intercambio a,
		pessoa_juridica b
	where	b.cd_cgc	= a.cd_cgc
	and	a.nr_sequencia	= nr_seq_intercambio_w;
	
	if (coalesce(ds_email_estip_w::text, '') = '') then
		select	max(ds_email)
		into STRICT	ds_email_estip_w
		from	pessoa_juridica_estab
		where	cd_cgc	= cd_cgc_w
		and	cd_estabelecimento = cd_estabelecimento_w;
	end if;
	
	if (ds_email_estip_w IS NOT NULL AND ds_email_estip_w::text <> '') then
		ie_forma_envio_estip_w	:= '1';
	else
		ie_forma_envio_estip_w	:= '2';
	end if;
	exception
	when others then
		nr_ddi_telefone_estip_w		:= null;
		nr_ddd_telefone_estip_w		:= null;
		nr_telefone_estip_w		:= null;
		ds_email_estip_w		:= null;
		ds_bairro_estip_w		:= null;
		cd_municipio_ibge_estip_w	:= null;
		ds_municipio_estip_w		:= null;
		sg_estado_estip_w		:= null;
		ds_complemento_estip_w		:= null;
		cd_cep_estip_w			:= null;
		ds_endereco_estip_w		:= null;
		nr_endereco_estip_w		:= null;
	end;
	
	if (ie_forma_envio_estip_w IS NOT NULL AND ie_forma_envio_estip_w::text <> '') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_tipo_contato_w
		from	pls_tp_contato_solic_resc
		where	ie_padrao_estipulante = 'S'
		and	ie_situacao = 'A';
		
		if (nr_seq_tipo_contato_w IS NOT NULL AND nr_seq_tipo_contato_w::text <> '') then
			insert	into	pls_solic_resc_contato(	nr_sequencia, nr_seq_solicitacao, nr_seq_tipo_contato,
					dt_atualizacao, dt_atualizacao_nrec, nm_usuario, nm_usuario_nrec,
					ds_email, cd_cep, ds_endereco, nr_endereco,
					ds_complemento, ds_bairro, cd_municipio_ibge, sg_estado,
					nr_ddi_telefone, nr_ddd_telefone, nr_telefone,
					ie_forma_envio)
			values (nextval('pls_solic_resc_contato_seq'), nr_seq_solicitacao_p, nr_seq_tipo_contato_w,
					clock_timestamp(), clock_timestamp(), nm_usuario_p, nm_usuario_p,
					ds_email_estip_w, cd_cep_estip_w, ds_endereco_estip_w, nr_endereco_estip_w,
					ds_complemento_estip_w, ds_bairro_estip_w, cd_municipio_ibge_estip_w, sg_estado_estip_w,
					nr_ddi_telefone_estip_w, nr_ddd_telefone_estip_w, nr_telefone_estip_w,
					ie_forma_envio_estip_w);
		end if;
	end if;
end if;

if (ie_commit_p = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_contato_resc_estip ( nr_seq_solicitacao_p pls_solicitacao_rescisao.nr_sequencia%type, ie_commit_p text, nm_usuario_p text) FROM PUBLIC;

