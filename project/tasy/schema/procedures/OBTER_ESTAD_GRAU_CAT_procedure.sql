-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_estad_grau_cat ( cd_topografia_p text, cd_tumor_primario_p text, cd_linfonodo_regional_p text, cd_metastase_distancia_p text, cd_estadio_p INOUT text, cd_categoria_p text, cd_grau_histo_p text, ie_utiliza_loc_tnm_p text, cd_dunkes_p text, cd_mac_p text, nr_seq_loco_reg_p bigint, ie_tipo_tnm_p text, ie_classificacao_tnm_p text, vl_soma_escore_p bigint) AS $body$
DECLARE


cd_estadio_w		varchar(20);

C01 CURSOR FOR
	SELECT	a.cd_estadio
	from	cido_topografia b,
		can_estadio a
	where	a.nr_seq_loc_tnm = b.nr_seq_loc_tnm
	and	b.cd_topografia = cd_topografia_p
	and	((coalesce(cd_tumor_primario_p::text, '') = '' and coalesce(a.cd_tumor_primario::text, '') = '') or a.cd_tumor_primario = cd_tumor_primario_p)
	and	((coalesce(cd_linfonodo_regional_p::text, '') = '' and coalesce(a.cd_linfonodo_regional::text, '') = '') or a.cd_linfonodo_regional = cd_linfonodo_regional_p)
	and	((coalesce(cd_metastase_distancia_p::text, '') = '' and coalesce(a.cd_metastase_distancia::text, '') = '') or a.cd_metastase_distancia = cd_metastase_distancia_p)
	and	coalesce(a.cd_grau_histo,coalesce(cd_grau_histo_p,'0'))	= coalesce(cd_grau_histo_p,'0')
	and	coalesce(a.cd_categoria,coalesce(cd_categoria_p,'0'))	= coalesce(cd_categoria_p,'0')
	and	coalesce(a.cd_dunkes,coalesce(cd_dunkes_p,'0'))		= coalesce(cd_dunkes_p,'0')
	and	coalesce(a.cd_mac,coalesce(cd_mac_p,'0'))			= coalesce(cd_mac_p,'0')
	and (
			((vl_soma_escore_p IS NOT NULL AND vl_soma_escore_p::text <> '') and a.vl_fator_risco_estadio = vl_soma_escore_p) or (coalesce(vl_soma_escore_p::text, '') = '' and valida_fator_prognostico(a.nr_sequencia, nr_seq_loco_reg_p) = 'S')
		)
	and a.ie_tipo_tnm = ie_tipo_tnm_p
	and a.ie_classificacao_tnm = ie_classificacao_tnm_p
	order by 	a.cd_grau_histo,
			a.cd_categoria,
			a.cd_dunkes,
			a.cd_mac;

C02 CURSOR FOR
	SELECT	a.cd_estadio
	from	cido_topografia b,
		can_estadio a
	where	a.nr_seq_loc_tnm = b.nr_seq_loc_tnm
	and	b.cd_topografia = cd_topografia_p
	and	((coalesce(cd_tumor_primario_p::text, '') = '' and coalesce(a.cd_tumor_primario::text, '') = '') or a.cd_tumor_primario = cd_tumor_primario_p)
	and	((coalesce(cd_linfonodo_regional_p::text, '') = '' and coalesce(a.cd_linfonodo_regional::text, '') = '') or a.cd_linfonodo_regional = cd_linfonodo_regional_p)
	and	((coalesce(cd_metastase_distancia_p::text, '') = '' and coalesce(a.cd_metastase_distancia::text, '') = '') or a.cd_metastase_distancia = cd_metastase_distancia_p)
	and	coalesce(a.cd_grau_histo,coalesce(cd_grau_histo_p,'0'))	= coalesce(cd_grau_histo_p,'0')
	and	coalesce(a.cd_categoria,coalesce(cd_categoria_p,'0'))	= coalesce(cd_categoria_p,'0')
	and	coalesce(a.cd_dunkes,coalesce(cd_dunkes_p,'0'))		= coalesce(cd_dunkes_p,'0')
	and	coalesce(a.cd_mac,coalesce(cd_mac_p,'0'))			= coalesce(cd_mac_p,'0')
	and (
			((vl_soma_escore_p IS NOT NULL AND vl_soma_escore_p::text <> '') and a.vl_fator_risco_estadio = vl_soma_escore_p) or (coalesce(vl_soma_escore_p::text, '') = '' and valida_fator_prognostico(a.nr_sequencia, nr_seq_loco_reg_p) = 'S')
		)
	and a.ie_tipo_tnm = ie_tipo_tnm_p
	and coalesce(a.ie_classificacao_tnm::text, '') = ''
	order by 	a.cd_grau_histo,
			a.cd_categoria,
			a.cd_dunkes,
			a.cd_mac;

C03 CURSOR FOR
	SELECT	a.cd_estadio
	from	cido_topografia b,
		can_estadio a
	where	a.nr_seq_loc_tnm = b.nr_seq_loc_tnm
	and	b.cd_topografia = cd_topografia_p
	and	((coalesce(cd_tumor_primario_p::text, '') = '' and coalesce(a.cd_tumor_primario::text, '') = '') or a.cd_tumor_primario = cd_tumor_primario_p)
	and	((coalesce(cd_linfonodo_regional_p::text, '') = '' and coalesce(a.cd_linfonodo_regional::text, '') = '') or a.cd_linfonodo_regional = cd_linfonodo_regional_p)
	and	((coalesce(cd_metastase_distancia_p::text, '') = '' and coalesce(a.cd_metastase_distancia::text, '') = '') or a.cd_metastase_distancia = cd_metastase_distancia_p)
	and	coalesce(a.cd_grau_histo,coalesce(cd_grau_histo_p,'0'))	= coalesce(cd_grau_histo_p,'0')
	and	coalesce(a.cd_categoria,coalesce(cd_categoria_p,'0'))	= coalesce(cd_categoria_p,'0')
	and	coalesce(a.cd_dunkes,coalesce(cd_dunkes_p,'0'))		= coalesce(cd_dunkes_p,'0')
	and	coalesce(a.cd_mac,coalesce(cd_mac_p,'0'))			= coalesce(cd_mac_p,'0')
	and (
			((vl_soma_escore_p IS NOT NULL AND vl_soma_escore_p::text <> '') and a.vl_fator_risco_estadio = vl_soma_escore_p) or (coalesce(vl_soma_escore_p::text, '') = '' and valida_fator_prognostico(a.nr_sequencia, nr_seq_loco_reg_p) = 'S')
		)
	and coalesce(a.ie_tipo_tnm::text, '') = ''
	and a.ie_classificacao_tnm = ie_classificacao_tnm_p
	order by 	a.cd_grau_histo,
			a.cd_categoria,
			a.cd_dunkes,
			a.cd_mac;

C04 CURSOR FOR
	SELECT	a.cd_estadio
	from	cido_topografia b,
		can_estadio a
	where	a.nr_seq_loc_tnm = b.nr_seq_loc_tnm
	and	b.cd_topografia = cd_topografia_p
	and	((coalesce(cd_tumor_primario_p::text, '') = '' and coalesce(a.cd_tumor_primario::text, '') = '') or a.cd_tumor_primario = cd_tumor_primario_p)
	and	((coalesce(cd_linfonodo_regional_p::text, '') = '' and coalesce(a.cd_linfonodo_regional::text, '') = '') or a.cd_linfonodo_regional = cd_linfonodo_regional_p)
	and	((coalesce(cd_metastase_distancia_p::text, '') = '' and coalesce(a.cd_metastase_distancia::text, '') = '') or a.cd_metastase_distancia = cd_metastase_distancia_p)
	and	coalesce(a.cd_grau_histo,coalesce(cd_grau_histo_p,'0'))	= coalesce(cd_grau_histo_p,'0')
	and	coalesce(a.cd_categoria,coalesce(cd_categoria_p,'0'))	= coalesce(cd_categoria_p,'0')
	and	coalesce(a.cd_dunkes,coalesce(cd_dunkes_p,'0'))		= coalesce(cd_dunkes_p,'0')
	and	coalesce(a.cd_mac,coalesce(cd_mac_p,'0'))			= coalesce(cd_mac_p,'0')
	and (
			((vl_soma_escore_p IS NOT NULL AND vl_soma_escore_p::text <> '') and a.vl_fator_risco_estadio = vl_soma_escore_p) or (coalesce(vl_soma_escore_p::text, '') = '' and valida_fator_prognostico(a.nr_sequencia, nr_seq_loco_reg_p) = 'S')
		)
	and coalesce(a.ie_tipo_tnm::text, '') = ''
	and coalesce(a.ie_classificacao_tnm::text, '') = ''
	order by 	a.cd_grau_histo,
			a.cd_categoria,
			a.cd_dunkes,
			a.cd_mac;
					
C05 CURSOR FOR
	SELECT	a.cd_estadio
	from	estadios_tnm_v a
	where	a.cd_topografia = cd_topografia_p
	and	((coalesce(cd_tumor_primario_p::text, '') = '' and coalesce(a.cd_tumor_primario::text, '') = '') or a.cd_tumor_primario = cd_tumor_primario_p)
	and	((coalesce(cd_linfonodo_regional_p::text, '') = '' and coalesce(a.cd_linfonodo_regional::text, '') = '') or a.cd_linfonodo_regional = cd_linfonodo_regional_p)
	and	((coalesce(cd_metastase_distancia_p::text, '') = '' and coalesce(a.cd_metastase_distancia::text, '') = '') or a.cd_metastase_distancia = cd_metastase_distancia_p)
	and	coalesce(a.cd_grau_histo,coalesce(cd_grau_histo_p,'0'))	= coalesce(cd_grau_histo_p,'0')
	and	coalesce(a.cd_categoria,coalesce(cd_categoria_p,'0'))	= coalesce(cd_categoria_p,'0')
	and	coalesce(a.cd_dunkes,coalesce(cd_dunkes_p,'0'))		= coalesce(cd_dunkes_p,'0')
	and	coalesce(a.cd_mac,coalesce(cd_mac_p,'0'))			= coalesce(cd_mac_p,'0')
	and (
			((vl_soma_escore_p IS NOT NULL AND vl_soma_escore_p::text <> '') and a.vl_fator_risco_estadio = vl_soma_escore_p) or (coalesce(vl_soma_escore_p::text, '') = '' and valida_fator_prognostico(a.nr_sequencia, nr_seq_loco_reg_p) = 'S')
		)
	and a.ie_tipo_tnm = ie_tipo_tnm_p
	and a.ie_class_tnm_estadio = ie_classificacao_tnm_p
	order by 	a.cd_grau_histo,
			a.cd_categoria,
			a.cd_dunkes,
			a.cd_mac;

C06 CURSOR FOR
	SELECT	a.cd_estadio
	from	estadios_tnm_v a
	where	a.cd_topografia = cd_topografia_p
	and	((coalesce(cd_tumor_primario_p::text, '') = '' and coalesce(a.cd_tumor_primario::text, '') = '') or a.cd_tumor_primario = cd_tumor_primario_p)
	and	((coalesce(cd_linfonodo_regional_p::text, '') = '' and coalesce(a.cd_linfonodo_regional::text, '') = '') or a.cd_linfonodo_regional = cd_linfonodo_regional_p)
	and	((coalesce(cd_metastase_distancia_p::text, '') = '' and coalesce(a.cd_metastase_distancia::text, '') = '') or a.cd_metastase_distancia = cd_metastase_distancia_p)
	and	coalesce(a.cd_grau_histo,coalesce(cd_grau_histo_p,'0'))	= coalesce(cd_grau_histo_p,'0')
	and	coalesce(a.cd_categoria,coalesce(cd_categoria_p,'0'))	= coalesce(cd_categoria_p,'0')
	and	coalesce(a.cd_dunkes,coalesce(cd_dunkes_p,'0'))		= coalesce(cd_dunkes_p,'0')
	and	coalesce(a.cd_mac,coalesce(cd_mac_p,'0'))			= coalesce(cd_mac_p,'0')
	and (
			((vl_soma_escore_p IS NOT NULL AND vl_soma_escore_p::text <> '') and a.vl_fator_risco_estadio = vl_soma_escore_p) or (coalesce(vl_soma_escore_p::text, '') = '' and valida_fator_prognostico(a.nr_sequencia, nr_seq_loco_reg_p) = 'S')
		)
	and a.ie_tipo_tnm = ie_tipo_tnm_p
	and coalesce(a.ie_class_tnm_estadio::text, '') = ''
	order by 	a.cd_grau_histo,
			a.cd_categoria,
			a.cd_dunkes,
			a.cd_mac;
			
C07 CURSOR FOR
	SELECT	a.cd_estadio
	from	estadios_tnm_v a
	where	a.cd_topografia = cd_topografia_p
	and	((coalesce(cd_tumor_primario_p::text, '') = '' and coalesce(a.cd_tumor_primario::text, '') = '') or a.cd_tumor_primario = cd_tumor_primario_p)
	and	((coalesce(cd_linfonodo_regional_p::text, '') = '' and coalesce(a.cd_linfonodo_regional::text, '') = '') or a.cd_linfonodo_regional = cd_linfonodo_regional_p)
	and	((coalesce(cd_metastase_distancia_p::text, '') = '' and coalesce(a.cd_metastase_distancia::text, '') = '') or a.cd_metastase_distancia = cd_metastase_distancia_p)
	and	coalesce(a.cd_grau_histo,coalesce(cd_grau_histo_p,'0'))	= coalesce(cd_grau_histo_p,'0')
	and	coalesce(a.cd_categoria,coalesce(cd_categoria_p,'0'))	= coalesce(cd_categoria_p,'0')
	and	coalesce(a.cd_dunkes,coalesce(cd_dunkes_p,'0'))		= coalesce(cd_dunkes_p,'0')
	and	coalesce(a.cd_mac,coalesce(cd_mac_p,'0'))			= coalesce(cd_mac_p,'0')
	and (
			((vl_soma_escore_p IS NOT NULL AND vl_soma_escore_p::text <> '') and a.vl_fator_risco_estadio = vl_soma_escore_p) or (coalesce(vl_soma_escore_p::text, '') = '' and valida_fator_prognostico(a.nr_sequencia, nr_seq_loco_reg_p) = 'S')
		)
	and coalesce(a.ie_tipo_tnm::text, '') = ''
	and a.ie_class_tnm_estadio = ie_classificacao_tnm_p
	order by 	a.cd_grau_histo,
			a.cd_categoria,
			a.cd_dunkes,
			a.cd_mac;
			
C08 CURSOR FOR
	SELECT	a.cd_estadio
	from	estadios_tnm_v a
	where	a.cd_topografia = cd_topografia_p
	and	((coalesce(cd_tumor_primario_p::text, '') = '' and coalesce(a.cd_tumor_primario::text, '') = '') or a.cd_tumor_primario = cd_tumor_primario_p)
	and	((coalesce(cd_linfonodo_regional_p::text, '') = '' and coalesce(a.cd_linfonodo_regional::text, '') = '') or a.cd_linfonodo_regional = cd_linfonodo_regional_p)
	and	((coalesce(cd_metastase_distancia_p::text, '') = '' and coalesce(a.cd_metastase_distancia::text, '') = '') or a.cd_metastase_distancia = cd_metastase_distancia_p)
	and	coalesce(a.cd_grau_histo,coalesce(cd_grau_histo_p,'0'))	= coalesce(cd_grau_histo_p,'0')
	and	coalesce(a.cd_categoria,coalesce(cd_categoria_p,'0'))	= coalesce(cd_categoria_p,'0')
	and	coalesce(a.cd_dunkes,coalesce(cd_dunkes_p,'0'))		= coalesce(cd_dunkes_p,'0')
	and	coalesce(a.cd_mac,coalesce(cd_mac_p,'0'))			= coalesce(cd_mac_p,'0')
	and (
			((vl_soma_escore_p IS NOT NULL AND vl_soma_escore_p::text <> '') and a.vl_fator_risco_estadio = vl_soma_escore_p) or (coalesce(vl_soma_escore_p::text, '') = '' and valida_fator_prognostico(a.nr_sequencia, nr_seq_loco_reg_p) = 'S')
		)
	and coalesce(a.ie_tipo_tnm::text, '') = ''
	and coalesce(a.ie_class_tnm_estadio::text, '') = ''
	order by 	a.cd_grau_histo,
			a.cd_categoria,
			a.cd_dunkes,
			a.cd_mac;


BEGIN
if (ie_utiliza_loc_tnm_p = 'N') then
	open C01;
	loop
	fetch C01 into
		cd_estadio_w;
	EXIT WHEN NOT FOUND or (cd_estadio_w IS NOT NULL AND cd_estadio_w::text <> '');  /* apply on C01 */
	end loop;
	close C01;
	
	if (coalesce(cd_estadio_w::text, '') = '') then
		open C02;
		loop
		fetch C02 into
			cd_estadio_w;
		EXIT WHEN NOT FOUND or (cd_estadio_w IS NOT NULL AND cd_estadio_w::text <> '');  /* apply on C02 */
		end loop;
		close C02;
		
		if (coalesce(cd_estadio_w::text, '') = '') then
			open C03;
			loop
			fetch C03 into
				cd_estadio_w;
			EXIT WHEN NOT FOUND or (cd_estadio_w IS NOT NULL AND cd_estadio_w::text <> '');  /* apply on C03 */
			end loop;
			close C03;
			
			if (coalesce(cd_estadio_w::text, '') = '') then
				open C04;
				loop
				fetch C04 into
					cd_estadio_w;
				EXIT WHEN NOT FOUND or (cd_estadio_w IS NOT NULL AND cd_estadio_w::text <> '');  /* apply on C04 */
				end loop;
				close C04;
			end if;
		end if;
	end if;

elsif (ie_utiliza_loc_tnm_p = 'S') then
	open C05;
	loop
	fetch C05 into
		cd_estadio_w;
	EXIT WHEN NOT FOUND or (cd_estadio_w IS NOT NULL AND cd_estadio_w::text <> '');  /* apply on C05 */
	end loop;
	close C05;
	
	if (coalesce(cd_estadio_w::text, '') = '') then
		open C06;
		loop
		fetch C06 into
			cd_estadio_w;
		EXIT WHEN NOT FOUND or (cd_estadio_w IS NOT NULL AND cd_estadio_w::text <> '');  /* apply on C06 */
		end loop;
		close C06;
		
		if (coalesce(cd_estadio_w::text, '') = '') then
			open C07;
			loop
			fetch C07 into
				cd_estadio_w;
			EXIT WHEN NOT FOUND or (cd_estadio_w IS NOT NULL AND cd_estadio_w::text <> '');  /* apply on C07 */
			end loop;
			close C07;
			
			if (coalesce(cd_estadio_w::text, '') = '') then
				open C08;
				loop
				fetch C08 into
					cd_estadio_w;
				EXIT WHEN NOT FOUND or (cd_estadio_w IS NOT NULL AND cd_estadio_w::text <> '');  /* apply on C08 */
				end loop;
				close C08;
			end if;
		end if;
	end if;
end if;

cd_estadio_p			:= cd_estadio_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_estad_grau_cat ( cd_topografia_p text, cd_tumor_primario_p text, cd_linfonodo_regional_p text, cd_metastase_distancia_p text, cd_estadio_p INOUT text, cd_categoria_p text, cd_grau_histo_p text, ie_utiliza_loc_tnm_p text, cd_dunkes_p text, cd_mac_p text, nr_seq_loco_reg_p bigint, ie_tipo_tnm_p text, ie_classificacao_tnm_p text, vl_soma_escore_p bigint) FROM PUBLIC;

