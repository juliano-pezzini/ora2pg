-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mx_cfdi_gerar_nf ( nr_sequencia_p bigint, nr_seq_nf_p INOUT text) AS $body$
DECLARE


nr_seq_nota_w			bigint;
ds_serie_w				nf_imp_nota.ds_serie%type;
ds_numero_w				nf_imp_nota.ds_numero%type;
nr_ident_emissor_w		nf_imp_nota.nr_ident_emissor%type;
nr_sequencia_nf_w		nota_fiscal.nr_sequencia_nf%type;
ds_erro_w				varchar(2000);


BEGIN

	select	ds_serie,
			ds_numero,
			nr_ident_emissor
	into STRICT	ds_serie_w,
			ds_numero_w,
			nr_ident_emissor_w
	from	nf_imp_nota
	where	nr_sequencia = nr_sequencia_p;

	select (coalesce(max(nr_sequencia_nf),0)+1)
	into STRICT	nr_sequencia_nf_w
	from	nota_fiscal
	where 	cd_estabelecimento	= wheb_usuario_pck.get_cd_estabelecimento
	and 	cd_cgc_emitente	= nr_ident_emissor_w
	and 	nr_nota_fiscal	= ds_numero_w
	and 	cd_serie_nf	= ds_serie_w;

select	nextval('nota_fiscal_seq')
into STRICT	nr_seq_nota_w
;

insert into nota_fiscal(
	nr_sequencia,
	cd_estabelecimento,
	cd_cgc_emitente,
	cd_serie_nf,
	nr_nota_fiscal,
	nr_sequencia_nf,
	cd_operacao_nf,
	dt_emissao,
	dt_entrada_saida,
	ie_acao_nf,
	ie_emissao_nf,
	ie_tipo_frete,
	vl_frete,
	vl_descontos,
	vl_mercadoria,
	vl_total_nota,
	qt_peso_bruto,
	qt_peso_liquido,
	dt_atualizacao,
	nm_usuario,
	cd_cgc,
	cd_natureza_operacao,
	cd_condicao_pagamento,
	ie_situacao,
	nr_ordem_compra,
	ie_tipo_nota)
SELECT
	nr_seq_nota_w,
	wheb_usuario_pck.get_cd_estabelecimento,
	coalesce(substr(nr_ident_emissor, 1, 14), '0'),
	ds_serie,
	coalesce(ds_numero, '0'),-- nr_nota_fiscal verificar parametro
	nr_sequencia_nf_w,
	cd_operacao_nf,
	coalesce(dt_emissao, clock_timestamp()),
	clock_timestamp(),
	1,
	0,
	'0',
	0,
	coalesce(vl_desconto, 0),
	0,
	coalesce(vl_total, 0),
	0,
	'0',
	clock_timestamp(),
	wheb_usuario_pck.get_nm_usuario,
	coalesce(substr(nr_ident_emissor, 1, 14), '0'),
	cd_natureza_operacao,
	nr_seq_chave_forma_pag,
	'1',
	null,
	'EN'
	from nf_imp_nota
	where nr_sequencia = nr_sequencia_p;

commit;

nr_seq_nf_p := nr_seq_nota_w;

ds_erro_w := mx_cfdi_vincular_nf(nr_sequencia_p, nr_seq_nota_w, 'N', 'N', ds_erro_w, 'N');
CALL mx_cfdi_gerar_nf_imp(nr_seq_nota_w);
CALL mx_cfdi_gerar_nf_item(nr_seq_nota_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mx_cfdi_gerar_nf ( nr_sequencia_p bigint, nr_seq_nf_p INOUT text) FROM PUBLIC;

