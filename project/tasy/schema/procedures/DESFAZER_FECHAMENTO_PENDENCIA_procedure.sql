-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_fechamento_pendencia ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_estagio_w		bigint;
nr_seq_estagio_ant_w	bigint;
nr_sequencia_w		bigint;
ie_apagar_ult_hist_w	varchar(1):=	'S';
nr_seq_estagio_param_w		bigint;


BEGIN 
 
ie_apagar_ult_hist_w:= coalesce(obter_valor_param_usuario(7042, 17, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento),'S');
nr_seq_estagio_param_w	:= coalesce(obter_valor_param_usuario(7042, 33, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento),0);
 
if (nr_sequencia_p > 0) then 
 
	select	coalesce(max(a.nr_sequencia),0) 
	into STRICT	nr_sequencia_w 
	from	cta_estagio_pend b, 
		cta_pendencia_hist a 
	where	b.ie_situacao = 'A' 
	and	a.nr_seq_pend = nr_sequencia_p 
	and	b.ie_tipo_estagio = 'F';
 
	select	coalesce(max(a.nr_seq_estagio),0), 
		coalesce(max(a.nr_seq_estagio_ant),0) 
	into STRICT	nr_seq_estagio_w, 
		nr_seq_estagio_ant_w 
	from	cta_estagio_pend b, 
		cta_pendencia_hist a 
	where	b.ie_situacao = 'A' 
	and	a.nr_seq_pend = nr_sequencia_p 
	and 	a.nr_sequencia = nr_sequencia_w 
	and	b.ie_tipo_estagio = 'F';
 
	if (nr_seq_estagio_param_w > 0) then 
		nr_seq_estagio_ant_w	:= nr_seq_estagio_param_w;
	end if;
	 
	if (coalesce(ie_apagar_ult_hist_w,'S') = 'S') then 
	 
		update	cta_pendencia 
		set	dt_fechamento  = NULL, 
			nm_usuario = nm_usuario_p, 
			dt_atualizacao = clock_timestamp(), 
			nr_seq_estagio = nr_seq_estagio_ant_w 
		where	nr_sequencia = nr_sequencia_p;
		 
		delete	from cta_pendencia_hist 
		where	nr_sequencia = nr_sequencia_w;
	 
		select	coalesce(max(a.nr_sequencia),0) 
		into STRICT	nr_sequencia_w 
		from	cta_estagio_pend b, 
			cta_pendencia_hist a 
		where	b.ie_situacao = 'A' 
		and	a.nr_seq_pend = nr_sequencia_p;
	 
		if (nr_sequencia_w > 0) then 
			update	cta_pendencia_hist 
			set	dt_final_estagio  = NULL, 
				qt_horas_estagio  = NULL, 
				ie_tipo_meta    = NULL 
			where	nr_sequencia = nr_sequencia_w;
		end if;
		 
	elsif (coalesce(ie_apagar_ult_hist_w,'S') = 'N') then 
					 
		CALL Cta_registrar_historico_pend(nr_sequencia_p, nr_seq_estagio_ant_w, wheb_mensagem_pck.get_Texto(311436), '1', nm_usuario_p); /*'Fechamento desfeito por ação do usuário'*/
		 
		update	cta_pendencia 
		set	dt_fechamento  = NULL, 
			nm_usuario = nm_usuario_p, 
			dt_atualizacao = clock_timestamp(), 
			nr_seq_estagio = nr_seq_estagio_ant_w 
		where	nr_sequencia = nr_sequencia_p;		
		 
	end if;
	 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_fechamento_pendencia ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

