-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_enviar_sms_tit_barras ( ds_remetente_p text, nr_titulo_p bigint, nr_seq_atendimento_p bigint, ds_destinatario_p text, nm_usuario_p text, ds_mensagem_p text, ds_mensagem_retorno_p INOUT text) AS $body$
DECLARE


id_sms_w		bigint;
ds_mensagem_w		varchar(255);
dt_vencimento_yyyy_w	varchar(10);
dt_vencimento_yy_w	varchar(10);
ds_sigla_moeda_w	varchar(10);
vl_titulo_w		varchar(20);
cd_barras_w		varchar(255);
qtd_letras_w		varchar(255);
nm_pessoa_w 		varchar(255);
vl_total_titulo_w	varchar(30);
qt_dias_vencidos_w	bigint;
nr_seq_tipo_historico_w	bigint;


BEGIN
if (nr_titulo_p IS NOT NULL AND nr_titulo_p::text <> '') and (nr_seq_atendimento_p IS NOT NULL AND nr_seq_atendimento_p::text <> '') and (ds_destinatario_p IS NOT NULL AND ds_destinatario_p::text <> '') and (ds_mensagem_p IS NOT NULL AND ds_mensagem_p::text <> '') and (ds_remetente_p IS NOT NULL AND ds_remetente_p::text <> '') then

	ds_mensagem_w	:=	ds_mensagem_p;

	CALL gerar_bloqueto_tit_rec(nr_titulo_p,null);

	select	replace(vl_titulo, ',', '.'),
		replace(substr(converte_codigo_Bloqueto('Barra_Editado', a.nr_bloqueto),1,80),'.','-'),
		obter_desc_sigla_moeda(cd_moeda),
		to_char(dt_pagamento_previsto, 'dd/mm/yyyy'),
		to_char(dt_pagamento_previsto, 'dd/mm/yy'),
		obter_nome_pessoa_fisica(a.cd_pessoa_fisica,null),
		(a.vl_saldo_titulo + coalesce(vl_juros_boleto,0) + coalesce(vl_multa_boleto,0)),
		obter_dias_entre_datas(dt_pagamento_previsto,clock_timestamp())
	into STRICT	vl_titulo_w,
		cd_barras_w,
		ds_sigla_moeda_w,
		dt_vencimento_yyyy_w,
		dt_vencimento_yy_w,
		nm_pessoa_w,
		vl_total_titulo_w,
		qt_dias_vencidos_w
	from	titulo_receber a
	where	nr_titulo	=	nr_titulo_p;

	ds_mensagem_w	:=	substr(replace_macro(ds_mensagem_w,'@VL_TITULO',vl_titulo_w), 1, 255);
	ds_mensagem_w	:= 	substr(replace_macro(ds_mensagem_w,'@VENC_DD_MM_YYYY',dt_vencimento_yyyy_w), 1, 255);
	ds_mensagem_w	:= 	substr(replace_macro(ds_mensagem_w,'@VENC_DD_MM_YY',dt_vencimento_yy_w), 1, 255);
	ds_mensagem_w	:= 	substr(replace_macro(ds_mensagem_w,'@QT_DIAS_VENC',qt_dias_vencidos_w), 1, 255);
	ds_mensagem_w	:= 	substr(replace_macro(ds_mensagem_w,'@DS_SIGLA_MOEDA',ds_sigla_moeda_w), 1, 255);
	ds_mensagem_w	:= 	substr(replace_macro(ds_mensagem_w,'@CD_BARRAS',cd_barras_w), 1, 255);
	ds_mensagem_w	:=	substr(replace_macro(ds_mensagem_w,'@NM_PESSOA',nm_pessoa_w), 1, 255);
	ds_mensagem_w	:=	substr(replace_macro(ds_mensagem_w,'@VL_TOTAL_TIT',vl_total_titulo_w), 1, 255);

	select 	length(ds_mensagem_w)
	into STRICT	qtd_letras_w
	;

	if (qtd_letras_w > 150) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(321572,'QTD_LETRAS_W=' || qtd_letras_w || ' ');
	end if;

	id_sms_w := wheb_sms.enviar_sms(ds_remetente_p, ds_destinatario_p, ds_mensagem_w, nm_usuario_p, id_sms_w);

	if (pls_obter_se_controle_estab('AT') = 'S') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_tipo_historico_w
		from	pls_tipo_historico_atend
		where	ie_gerado_sistema	= 'S'
		and	ie_situacao		= 'A'
		and (cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento );
	else
		select	max(nr_sequencia)
		into STRICT	nr_seq_tipo_historico_w
		from	pls_tipo_historico_atend
		where	ie_gerado_sistema	= 'S'
		and	ie_situacao		= 'A';
	end if;

	insert into pls_atendimento_historico(	nr_sequencia,
						nr_seq_atendimento,
						ds_historico_long,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_seq_tipo_historico,
						dt_historico,
						ie_origem_historico,
						ie_gerado_sistema)
	values (					nextval('pls_atendimento_historico_seq'),
						nr_seq_atendimento_p,
						substr('Código de barras  ' || cd_barras_w || ' enviado via SMS para o Celular Nº ' || ds_destinatario_p || chr(13) || chr(10) ||
						'Mensagem: ' || ds_mensagem_w,1,4000),
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_tipo_historico_w,
						clock_timestamp(),
						2,
						'S');

	insert into 	log_envio_sms(nr_sequencia,dt_atualizacao,nm_usuario,
			dt_envio,nr_telefone,ds_mensagem,
			id_sms)
	values (nextval('log_envio_sms_seq'),clock_timestamp(),nm_usuario_p,
			clock_timestamp(),ds_destinatario_p,ds_mensagem_w,
			id_sms_w);
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_enviar_sms_tit_barras ( ds_remetente_p text, nr_titulo_p bigint, nr_seq_atendimento_p bigint, ds_destinatario_p text, nm_usuario_p text, ds_mensagem_p text, ds_mensagem_retorno_p INOUT text) FROM PUBLIC;

