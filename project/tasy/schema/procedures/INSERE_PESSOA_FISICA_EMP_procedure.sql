-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insere_pessoa_fisica_emp ( cd_cgc_empregador_p pessoa_fisica_empregador.cd_cgc%type, dt_inicio_trabalho_p pessoa_fisica_empregador.dt_inicio_trabalho%type, nm_usuario_p pessoa_fisica_empregador.nm_usuario%type, cd_pessoa_fisica_p pessoa_fisica_empregador.cd_pessoa_fisica%type, dt_fim_trabalho_p pessoa_fisica_empregador.dt_fim_trabalho%type, cd_profissao_p pessoa_fisica_empregador.cd_profissao%type, ds_profissao_p pessoa_fisica_empregador.ds_profissao%type, cd_cgc_empregador_old_p pessoa_fisica_empregador.cd_cgc%type, ie_master_person_p text default 'N', ds_empresa_p pessoa_fisica_empregador.ds_empresa_texto%type DEFAULT NULL, ds_empresa_old_p pessoa_fisica_empregador.ds_empresa_texto%type DEFAULT NULL, ds_endereco_empreg_p pessoa_fisica_empregador.ds_endereco_empreg%type default null, nr_endereco_empreg_p pessoa_fisica_empregador.nr_endereco_empreg%type default null, ds_pais_empreg_p pessoa_fisica_empregador.ds_pais_empreg%type default null, cd_cep_empreg_p pessoa_fisica_empregador.cd_cep_empreg%type default null, ds_municipio_empreg_p pessoa_fisica_empregador.ds_municipio_empreg%type default null, nr_telefone_p pessoa_fisica_empregador.nr_telefone%type default null) AS $body$
DECLARE


nr_sequencia_w	pessoa_fisica_empregador.nr_sequencia%type;
ie_existe_empregador_w	varchar(1) := 'S';
ish_activate_w	varchar(1) := 'N';

c_atend_pac_inf CURSOR FOR
SELECT	api.nr_sequencia
from  	atendimento_paciente_inf api
where 	api.nr_atendimento in (	SELECT	ap.nr_atendimento
							from	atendimento_paciente ap,
									tipo_admissao_fat taf
							where	ap.cd_pessoa_fisica = cd_pessoa_fisica_p
							and		coalesce(ap.dt_alta::text, '') = ''
							and		coalesce(ap.dt_cancelamento::text, '') = ''
							and		taf.nr_sequencia = ap.nr_seq_tipo_admissao_fat
							and		taf.ie_tipo_bg = 'S')
and api.dt_inicio_trabalho = dt_inicio_trabalho_p
and		((ish_activate_w = 'S') or (ish_activate_w = 'N'
		and	api.cd_cgc_empregador = cd_cgc_empregador_p
		and	coalesce(api.ds_empresa, 'NULL') = coalesce(ds_empresa_p, 'NULL')));

BEGIN

if (cd_cgc_empregador_p IS NOT NULL AND cd_cgc_empregador_p::text <> '' AND cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then

	CALL wheb_usuario_pck.set_ie_executar_trigger('N');

	select	coalesce(max('S'),'N')
	into STRICT		ish_activate_w
	from	intpd_eventos_sistema
	where	ie_situacao = 'A'
	and		ds_action = 'PatcaseAddinpatadmiss';

	if (ie_master_person_p = 'S') then

		if (coalesce(dt_fim_trabalho_p::text, '') = '') then
		for c_atend_pac_inf_w in c_atend_pac_inf loop

			update	atendimento_paciente_inf
			set		nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp(),
					dt_inicio_trabalho = dt_inicio_trabalho_p,
					cd_cgc_empregador = cd_cgc_empregador_p,
					cd_profissao = cd_profissao_p,
					ds_profissao = ds_profissao_p,
					ds_empresa = ds_empresa_p,
					ds_endereco_empreg = ds_endereco_empreg_p,
					nr_endereco_empreg = nr_endereco_empreg_p,
					ds_pais_empreg = ds_pais_empreg_p,
					cd_cep_empreg = cd_cep_empreg_p,
					ds_municipio_empreg = ds_municipio_empreg_p,
					nr_telefone = nr_telefone_p
			where 	nr_sequencia = c_atend_pac_inf_w.nr_sequencia;

		end loop;
		end if;

	elsif (coalesce(cd_cgc_empregador_old_p,'NULL') <> cd_cgc_empregador_p)  or (coalesce(ds_empresa_old_p,'NULL') <> ds_empresa_p) then

			if (ish_activate_w = 'S') then
				select	coalesce(max('S'),'N')
				into STRICT		ie_existe_empregador_w
				from	pessoa_fisica_empregador
				where	cd_cgc = cd_cgc_empregador_p
				and		cd_pessoa_fisica = cd_pessoa_fisica_p
				and (coalesce(ds_empresa_texto, 'NULL') = coalesce(ds_empresa_p, 'NULL'))
				and		((coalesce(dt_fim_trabalho::text, '') = '') or (dt_fim_trabalho >= clock_timestamp()));

				if (ie_existe_empregador_w = 'N') then

					update pessoa_fisica_empregador
					set	   dt_fim_trabalho = dt_inicio_trabalho_p
					where  cd_pessoa_fisica = cd_pessoa_fisica_p
					and	   coalesce(dt_fim_trabalho::text, '') = '';

					CALL wheb_usuario_pck.set_ie_executar_trigger('N');

					insert into pessoa_fisica_empregador(
						nr_sequencia,
						nm_usuario,
						nm_usuario_nrec,
						dt_atualizacao,
						dt_atualizacao_nrec,
						cd_pessoa_fisica,
						cd_cgc,
						dt_inicio_trabalho,
						cd_profissao,
						ds_profissao,
						ds_empresa_texto,
						ds_endereco_empreg,
						nr_endereco_empreg,
						ds_pais_empreg,
						cd_cep_empreg,
						ds_municipio_empreg,
						nr_telefone
					) values (
						nextval('pessoa_fisica_empregador_seq'),
						nm_usuario_p,
						nm_usuario_p,
						clock_timestamp(),
						clock_timestamp(),
						cd_pessoa_fisica_p,
						cd_cgc_empregador_p,
						dt_inicio_trabalho_p,
						cd_profissao_p,
						ds_profissao_p,
						ds_empresa_p,
						ds_endereco_empreg_p,
						nr_endereco_empreg_p,
						ds_pais_empreg_p,
						cd_cep_empreg_p,
						ds_municipio_empreg_p,
						nr_telefone_p
					);

				end if;
			else

				insert into pessoa_fisica_empregador(
					nr_sequencia,
					cd_cgc,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					cd_pessoa_fisica,
					dt_inicio_trabalho,
					dt_fim_trabalho,
					cd_profissao,
					ds_profissao,
					ds_empresa_texto,
					ds_endereco_empreg,
					nr_endereco_empreg,
					ds_pais_empreg,
					cd_cep_empreg,
					ds_municipio_empreg,
					nr_telefone
				) values (
					nextval('pessoa_fisica_empregador_seq'),
					cd_cgc_empregador_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					cd_pessoa_fisica_p,
					dt_inicio_trabalho_p,
					dt_fim_trabalho_p,
					cd_profissao_p,
					ds_profissao_p,
					ds_empresa_p,
					ds_endereco_empreg_p,
					nr_endereco_empreg_p,
					ds_pais_empreg_p,
					cd_cep_empreg_p,
					ds_municipio_empreg_p,
					nr_telefone_p
				);

			end if;

	else

		select 	max(nr_sequencia)
		into STRICT	nr_sequencia_w
		from	pessoa_fisica_empregador pfe
		where 	cd_cgc = cd_cgc_empregador_p
		and		coalesce(ds_empresa_texto,'NULL') = coalesce(ds_empresa_p,'NULL')
		and		cd_pessoa_fisica = cd_pessoa_fisica_p
		and	   ((coalesce(dt_fim_trabalho::text, '') = '') or (dt_fim_trabalho >= clock_timestamp()));

		if (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') then

			update	pessoa_fisica_empregador
			set		nm_usuario = nm_usuario_p,
					dt_atualizacao = clock_timestamp(),
					dt_inicio_trabalho = dt_inicio_trabalho_p,
					cd_profissao = cd_profissao_p,
					ds_profissao = ds_profissao_p,
					ds_empresa_texto = ds_empresa_p,
					ds_endereco_empreg = ds_endereco_empreg_p,
					nr_endereco_empreg = nr_endereco_empreg_p,
					ds_pais_empreg = ds_pais_empreg_p,
					cd_cep_empreg = cd_cep_empreg_p,
					ds_municipio_empreg = ds_municipio_empreg_p,
					nr_telefone = nr_telefone_p
			where 	nr_sequencia = nr_sequencia_w;

		end if;
	end if;

	if (wheb_usuario_pck.get_ie_executar_trigger = 'N') then
		CALL wheb_usuario_pck.set_ie_executar_trigger('S');
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insere_pessoa_fisica_emp ( cd_cgc_empregador_p pessoa_fisica_empregador.cd_cgc%type, dt_inicio_trabalho_p pessoa_fisica_empregador.dt_inicio_trabalho%type, nm_usuario_p pessoa_fisica_empregador.nm_usuario%type, cd_pessoa_fisica_p pessoa_fisica_empregador.cd_pessoa_fisica%type, dt_fim_trabalho_p pessoa_fisica_empregador.dt_fim_trabalho%type, cd_profissao_p pessoa_fisica_empregador.cd_profissao%type, ds_profissao_p pessoa_fisica_empregador.ds_profissao%type, cd_cgc_empregador_old_p pessoa_fisica_empregador.cd_cgc%type, ie_master_person_p text default 'N', ds_empresa_p pessoa_fisica_empregador.ds_empresa_texto%type DEFAULT NULL, ds_empresa_old_p pessoa_fisica_empregador.ds_empresa_texto%type DEFAULT NULL, ds_endereco_empreg_p pessoa_fisica_empregador.ds_endereco_empreg%type default null, nr_endereco_empreg_p pessoa_fisica_empregador.nr_endereco_empreg%type default null, ds_pais_empreg_p pessoa_fisica_empregador.ds_pais_empreg%type default null, cd_cep_empreg_p pessoa_fisica_empregador.cd_cep_empreg%type default null, ds_municipio_empreg_p pessoa_fisica_empregador.ds_municipio_empreg%type default null, nr_telefone_p pessoa_fisica_empregador.nr_telefone%type default null) FROM PUBLIC;

