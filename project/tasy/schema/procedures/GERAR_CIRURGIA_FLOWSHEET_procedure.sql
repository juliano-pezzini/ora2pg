-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cirurgia_flowsheet ((nr_seq_modelo_p bigint, nr_cirurgia_p bigint, nr_seq_pepo_p bigint, cd_pessoa_fisica_p text) is nr_seq_flowsheet_w bigint) RETURNS varchar AS $body$
DECLARE


    ds_retorno_w    varchar(255);


BEGIN
    ds_retorno_w:= ds_valor_p ||  ' ' || ds_descricao_p;
    if (coalesce(nr_seq_anest_ocor_p,0) > 0)
    and (ie_modo_adm_p = 'CO')
    and (coalesce(qt_dose_ataque_p,0) > 0) then
        ds_retorno_w    := substr(obter_desc_expressao(1055382,null) || ' ' || ds_valor_p || ' ' || obter_desc_expressao(703346,null),1,255);
    end if;

    return ds_retorno_w;
    end;
	
	procedure current_therapies_adm(nr_seq_sup_p in number,
                               description_p in varchar2,
                               color_p in varchar2) is
							
	type typeHemodAdm is table of c_adm_hemoderivados%rowtype;
	a_HemodAdm typeHemodAdm;

    begin
    
			open c_adm_hemoderivados(nr_seq_sup_p,description_p);
			fetch c_adm_hemoderivados bulk collect into a_HemodAdm limit 1000;
			close c_adm_hemoderivados;

			forall i in a_HemodAdm.first .. a_HemodAdm.last
            insert into w_flowsheet_cirurgia_reg(   nr_sequencia,
                                                    dt_atualizacao,
                                                    nm_usuario,
                                                    dt_atualizacao_nrec,
                                                    nm_usuario_nrec,
                                                    dt_resultado,
                                                    vl_resultado,
                                                    nr_seq_info,
                                                    ie_symbol,
                                                    ds_cor_symbol,
                                                    ie_style,
                                                    dt_inicio,
                                                    dt_fim,
                                                    dt_fim_grid,
                                                    nr_max,
                                                    nr_min,
                                                    ds_tooltip1,
                                                    ds_tooltip2,
                                                    ds_comentario,
                                                    ds_comentario_end,
                                                    cd_grupo,
                                                    dt_liberacao
                                                    )
            values (nextval('w_flowsheet_cirurgia_reg_seq'),
                                                    clock_timestamp(),
                                                    wheb_usuario_pck.get_nm_usuario,
                                                    clock_timestamp(),
                                                    wheb_usuario_pck.get_nm_usuario,
                                                    a_HemodAdm[i].x,
                                                    a_HemodAdm[i].qt_dose,
                                                    nr_seq_info_w,
                                                    'SQUARE',
                                                    color_p,
                                                    ie_ds_style_w,
                                                    a_HemodAdm[i].dt_start,
                                                    a_HemodAdm[i].dt_end,
                                                    a_HemodAdm[i].dt_fim_grid,
                                                    10,
                                                    180,
                                                    a_HemodAdm[i].ds_tooltip1,
                                                    a_HemodAdm[i].ds_tooltip2,
                                                    get_valor_comentario_graf(nr_cirurgia_p,a_hemodadm[i].nr_sequencia,'ATEND_MONIT_HEMOD',null),
                                                    get_valor_comentario_graf(nr_cirurgia_p,a_HemodAdm[i].nr_sequencia,'ATEND_MONIT_HEMOD',null,'F'),
                                                    a_hemodadm[i].nr_sequencia,
                                                    a_HemodAdm[i].dt_liberacao);

    end;
	
	procedure device_details(nr_sequencia_p     in number,
                             ds_tolltip_p       in varchar2) is

    c_dispositivos_detail CURSOR FOR
      SELECT  substr(obter_cor_grafico_dispositivo(b.nr_sequencia,'S'),1,30) cor,
        a.nr_sequencia,
        a.dt_instalacao,
        coalesce(a.dt_retirada,clock_timestamp()) dt_retirada,
        aux.shape,
        aux.style,
        null as ds_tooltip1,
        null as ds_tooltip2,
      a.dt_instalacao as dt_liberacao,
      a.dt_retirada as dt_retirada2,
      a.dt_retirada_prev
      FROM dispositivo b,
         atend_pac_dispositivo a,
		 (SELECT 'CIRCLE' as shape, 'line' as style ) aux
      where a.nr_sequencia = nr_sequencia_p
       and a.nr_seq_dispositivo = b.nr_sequencia
       and (((coalesce(nr_cirurgia_p,0) > 0) and (a.nr_cirurgia = nr_cirurgia_p)) or ((coalesce(nr_seq_pepo_p,0) > 0) and (a.nr_seq_pepo = nr_seq_pepo_p)))
       and coalesce(obter_se_exibe_graf_disp(a.nr_sequencia), 'N')  = 'S'
       and a.dt_instalacao >= get_start_end_surgery_graph(nr_cirurgia_p,nr_seq_pepo_p,'START',0,0);

     type typeDevicesDetail is table of c_dispositivos_detail%rowtype;
     a_devicedetail typedevicesdetail;
     a_devicedetail_aux typedevicesdetail;

    begin
    
      open c_dispositivos_detail;
	    fetch c_dispositivos_detail bulk collect into a_devicedetail limit 1000;
      close c_dispositivos_detail;

          forall i in a_devicedetail.first .. a_devicedetail.last
          insert into w_flowsheet_cirurgia_reg(nr_sequencia,
                                     dt_atualizacao,
                                     nm_usuario,
                                     dt_atualizacao_nrec,
                                     nm_usuario_nrec,
                                     dt_resultado,
                                     vl_resultado,
                                     ds_resultado,
                                     nr_seq_info,
                                     ie_symbol,
                                     ds_cor_symbol,
                                     ie_style,
                                     dt_inicio,
                                     dt_fim,
                                     vl_y_max,
                                     vl_y_min,
                                     ds_tooltip1,
                                     ds_tooltip2,
                                     cd_grupo,
                                     ds_comentario,
                                     ie_valor_fora_faixa,
									 dt_liberacao
                            )
                    values (nextval('w_flowsheet_cirurgia_reg_seq'),
                            clock_timestamp(),
                            wheb_usuario_pck.get_nm_usuario,
                            clock_timestamp(),
                            wheb_usuario_pck.get_nm_usuario,
                            a_devicedetail[i].dt_instalacao,
                            0,
                            null,
                            nr_seq_info_w,
                            a_devicedetail[i].shape,
                            a_devicedetail[i].cor,
                            a_devicedetail[i].style,
                            a_devicedetail[i].dt_instalacao,
                            a_devicedetail[i].dt_retirada,
                            null,
                            null,
                            ds_tolltip_p,
                            w_ds_tooltip,
                            a_devicedetail[i].nr_sequencia,
                            get_valor_comentario_graf(nr_cirurgia_p,a_devicedetail[i].nr_sequencia,'ATEND_PAC_DISPOSITIVO',null),
                            null,
                            a_devicedetail[i].dt_liberacao);
      v_counter := 1;
      a_devicedetail_aux := typedevicesdetail();

    for i in 1 .. a_devicedetail.count() loop
      if (a_devicedetail[i](.dt_retirada_prev IS NOT NULL AND .dt_retirada_prev::text <> '') and a_devicedetail[i]coalesce(.dt_retirada2::text, '') = '') then
        a_devicedetail_aux.extend;
        a_devicedetail_aux(v_counter) := a_devicedetail(i);
        v_counter := v_counter + 1;
      end if;
    end loop;

		forall i in a_devicedetail_aux.first .. a_devicedetail_aux.last
          insert
               into w_flowsheet_cirurgia_reg(nr_sequencia,
                     dt_atualizacao,
                     nm_usuario,
                     dt_atualizacao_nrec,
                     nm_usuario_nrec,
                     dt_resultado,
                     vl_resultado,
                     ds_resultado,
                     nr_seq_info,
                     ie_symbol,
                     ds_cor_symbol,
                     ie_style,
                     dt_inicio,
                     dt_fim,
                     vl_y_max,
                     vl_y_min,
                     ds_tooltip1,
                     ds_tooltip2,
                     cd_grupo,
                     ds_comentario,
                     ie_valor_fora_faixa,
                     dt_liberacao,
                     ie_dev_ret_prev,
                     ie_image_legend
                    )
             values (nextval('w_flowsheet_cirurgia_reg_seq'),
                     clock_timestamp(),
                     wheb_usuario_pck.get_nm_usuario,
                     clock_timestamp(),
                     wheb_usuario_pck.get_nm_usuario,
                     a_devicedetail_aux[i].dt_retirada_prev,
                     0,
                     null,
                     nr_seq_info_w,
                     a_devicedetail_aux[i].shape,
                     a_devicedetail_aux[i].cor,
                     a_devicedetail_aux[i].style,
                     a_devicedetail_aux[i].dt_retirada_prev,
                     a_devicedetail_aux[i].dt_retirada_prev,
                     null,
                     null,
                     ds_tolltip_p,
                     w_ds_tooltip,
                     a_devicedetail_aux[i].nr_sequencia,
                     get_valor_comentario_graf(nr_cirurgia_p,a_devicedetail_aux[i].nr_sequencia,'ATEND_PAC_DISPOSITIVO',null),
                     null,
                     a_devicedetail_aux[i].dt_liberacao,
                    'S',
                    'assets/icons/status-and-feedback/bandage-clock.svg'
                    );
    end;

begin

if (nr_seq_modelo_p IS NOT NULL AND nr_seq_modelo_p::text <> '') then

if (coalesce(nr_cirurgia_p,0) > 0) and (coalesce(nr_seq_pepo_p,0) = 0) then
    select  max(nr_seq_pepo)
    into STRICT        nr_seq_pepo_ww
    from        cirurgia
    where       nr_cirurgia = nr_cirurgia_p;
end if;

CALL configurar_cirurgia_flowsheet(nr_cirurgia_p,nr_seq_pepo_p,nr_seq_modelo_p, wheb_usuario_pck.get_nm_usuario);

cd_pessoa_usuario_w := obter_pessoa_fisica_usuario(wheb_usuario_pck.get_nm_usuario, 'C');
ie_nivel_atencao_w  := coalesce(obter_se_prontuario_liberado(cd_pessoa_fisica_p, cd_pessoa_usuario_w), 'T');

ie_desc_comercial_w := obter_param_usuario(872, 224, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_desc_comercial_w);
dark_mode_w := obter_param_usuario(872, 546, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, dark_mode_w);

/* Limpar carga anterior*/

delete
  from w_flowsheet_cirurgia_reg a
 where a.nr_seq_info in (SELECT x.nr_sequencia
                           from w_flowsheet_cirurgia_info x,
                                w_flowsheet_cirurgia_grupo y,
                                w_flowsheet_cirurgia_pac z
                          where x.nr_seq_grupo = y.nr_sequencia
                            and y.nr_seq_flowsheet = z.nr_sequencia
                            and z.nm_usuario = wheb_usuario_pck.get_nm_usuario
                            and coalesce(z.nr_cirurgia,0) = coalesce(nr_cirurgia_p,0)
                            and coalesce(z.nr_seq_pepo,0) = coalesce(nr_seq_pepo_p, 0));

delete
  from w_flowsheet_cirurgia_info a
 where a.nr_seq_grupo in (SELECT y.nr_sequencia
                            from w_flowsheet_cirurgia_grupo y,
                                 w_flowsheet_cirurgia_pac z
                           where y.nr_seq_flowsheet = z.nr_sequencia
                             and z.nm_usuario = wheb_usuario_pck.get_nm_usuario
                             and coalesce(z.nr_cirurgia,0) = coalesce(nr_cirurgia_p,0)
                             and coalesce(z.nr_seq_pepo,0) = coalesce(nr_seq_pepo_p, 0));

delete
  from w_flowsheet_cirurgia_grupo a
 where a.nr_seq_flowsheet in (SELECT z.nr_sequencia
                                from w_flowsheet_cirurgia_pac z
                               where z.nm_usuario = wheb_usuario_pck.get_nm_usuario
                                 and coalesce(z.nr_cirurgia,0) = coalesce(nr_cirurgia_p,0)
                                 and coalesce(z.nr_seq_pepo,0) = coalesce(nr_seq_pepo_p, 0));

delete
  from w_flowsheet_cirurgia_pac z
 where z.nm_usuario = wheb_usuario_pck.get_nm_usuario
   and coalesce(z.nr_cirurgia,0) = coalesce(nr_cirurgia_p,0)
   and coalesce(z.nr_seq_pepo,0) = coalesce(nr_seq_pepo_p, 0);
commit;

/* Limpar carga anterior*/

select nextval('w_flowsheet_cirurgia_pac_seq')
  into STRICT nr_seq_flowsheet_w
;

select coalesce(dt_inicio_real,clock_timestamp()), coalesce(dt_fim_cirurgia,clock_timestamp())
into STRICT dt_incio_cirurgia_w, dt_fim_cirurgia_w
from cirurgia where nr_cirurgia = nr_cirurgia_p or nr_seq_pepo = nr_seq_pepo_p;

insert into w_flowsheet_cirurgia_pac(nr_sequencia,
                                    dt_atualizacao,
                                    nm_usuario,
                                    dt_atualizacao_nrec,
                                    nm_usuario_nrec,
                                    nr_cirurgia,
                                    nr_seq_pepo,
                                    nr_seq_modelo
                                    )
values (nr_seq_flowsheet_w,
                                    clock_timestamp(),
                                    wheb_usuario_pck.get_nm_usuario,
                                    clock_timestamp(),
                                    wheb_usuario_pck.get_nm_usuario,
                                    nr_cirurgia_p,
                                    nr_seq_pepo_p,
                                    nr_seq_modelo_p);
<<read_secao>>
for r_secao in c_secao
    loop
    ds_tipo_evolucao_w:= '';

    select   nextval('w_flowsheet_cirurgia_grupo_seq')
    into STRICT     nr_seq_grupo_w
;

    insert into w_flowsheet_cirurgia_grupo( nr_sequencia,
                                            dt_atualizacao,
                                            nm_usuario,
                                            dt_atualizacao_nrec,
                                            nm_usuario_nrec,
                                            ds_nome,
                                            nr_seq_flowsheet,
                                            nr_seq_apresentacao,
                                            ie_modo_visualizacao,
                      ie_sumarizado,
                                            ds_caminho_imagem,
                                            nr_seq_config_grupo,
                                            nr_seq_linked_data,
                                            ie_chart_view,
                                            ie_grid_view)
    values (nr_seq_grupo_w,
                                        clock_timestamp(),
                                        wheb_usuario_pck.get_nm_usuario,
                                        clock_timestamp(),
                                        wheb_usuario_pck.get_nm_usuario,
                                        r_secao.ds_titulo,
                                        nr_seq_flowsheet_w,
                                        r_secao.nr_seq_apresentacao,
                                        r_secao.ie_modo_visualizacao,
                    r_secao.ie_sumarizado,
                    CASE WHEN r_secao.cd_secao='SH' THEN 'assets/icons/status-and-feedback/blood-bag.svg' WHEN r_secao.cd_secao='AG' THEN 'assets/icons/status-and-feedback/medicines-solutions.svg' WHEN r_secao.cd_secao='SV' THEN 'assets/icons/status-and-feedback/vital-signs.svg' WHEN r_secao.cd_secao='BH' THEN 'assets/icons/status-and-feedback/balance-hydric.svg' WHEN r_secao.cd_secao='TA' THEN 'assets/icons/status-and-feedback/infusion.svg' WHEN r_secao.cd_secao='EV' THEN 'assets/icons/status-and-feedback/report.svg' WHEN r_secao.cd_secao='EL' THEN 'assets/icons/status-and-feedback/laboratory.svg'  ELSE 'assets/icons/status-and-feedback/intravenous-circle.svg' END ,
                                        r_secao.nr_seq_config,
                    CASE WHEN r_secao.cd_secao='SH' THEN 257 WHEN r_secao.cd_secao='AG' THEN 258 WHEN r_secao.cd_secao='SV' THEN 259 WHEN r_secao.cd_secao='BH' THEN 260 WHEN r_secao.cd_secao='TA' THEN 261 WHEN r_secao.cd_secao='EV' THEN 262 WHEN r_secao.cd_secao='EL' THEN 263  ELSE 264 END ,
                                        r_secao.ie_chart_view,
                                        r_secao.ie_grid_view
                    ); --Cadastrado na tabela LINKED_DATA
    case r_secao.cd_secao
    when    'SH' then
        <<read_hemoderivados>>
        for r_hemoderivados in c_hemoderivados(r_secao.nr_seq_config, dark_mode_w)
            loop
            select   nextval('w_flowsheet_cirurgia_info_seq')
            into STRICT     nr_seq_info_w
;

            insert
              into w_flowsheet_cirurgia_info( 
                                             nr_sequencia,
                                             dt_atualizacao,
                                             nm_usuario,
                                             dt_atualizacao_nrec,
                                             nm_usuario_nrec,
                                             ds_informacao,
                                             ds_informacao_complementar,
                                             nr_seq_apresentacao,
                                             nm_tabela,
                                             nm_atributo,
                                             nr_seq_grupo,
                                             nr_seq_superior,
                                             ie_temporario,
                                             ie_modo_adm,
                                             cd_material,
                                             cd_unid_medida_adm,
                                             nr_altura,
                                             ie_visivel,
                                             nr_seq_conf_info,
                                             ds_unidade_medida,
                                             ie_tipo,
                                             ie_tipo_agrupamento,
                                             ds_total_dose,
                                             ds_caminho_imagem
                                            )
                                     values (
                                             nr_seq_info_w,
                                             clock_timestamp(),
                                             wheb_usuario_pck.get_nm_usuario,
                                             clock_timestamp(),
                                             wheb_usuario_pck.get_nm_usuario,
                                             r_hemoderivados.name,
                                             null,
                                             0,
                                             'CIRURGIA_AGENTE_ANESTESICO',
                                             'QT_DOSE_' || nr_seq_info_w,
                                             nr_seq_grupo_w,
                                             r_hemoderivados.nr_seq_superior,
                                             'N',
                                             r_hemoderivados.ie_modo_adm,
                                             r_hemoderivados.cd_material,
                                             r_hemoderivados.cd_unid_medida_adm,
                                             28,
                                             r_hemoderivados.ie_visivel,
                                             r_hemoderivados.nr_seq_conf_info,
                                             r_hemoderivados.description,
                                             5,
                                             r_secao.ie_tipo_agrupamento,
                                             r_hemoderivados.ds_total_dose,
                                             r_hemoderivados.ds_caminho_imagem
                                            );


            <<read_adm_hemoderivados>>
            for r_adm_hemoderivados in c_adm_hemoderivados(r_hemoderivados.nr_sequencia, r_hemoderivados.description)
                loop
                select   nextval('w_flowsheet_cirurgia_reg_seq')
                into STRICT     nr_seq_registro_w
;

                insert into w_flowsheet_cirurgia_reg(   nr_sequencia,
                                                        dt_atualizacao,
                                                        nm_usuario,
                                                        dt_atualizacao_nrec,
                                                        nm_usuario_nrec,
                                                        dt_resultado,
                                                        vl_resultado,
                                                        nr_seq_info,
                                                        ie_symbol,
                                                        ds_cor_symbol,
                                                        ie_style,
                                                        dt_inicio,
                                                        dt_fim,
                                                        dt_fim_grid,
                                                        nr_max,
                                                        nr_min,
                                                        ds_tooltip1,
                                                        ds_tooltip2,
                                                        ds_comentario,
														ds_comentario_end,
                                                        cd_grupo,
														dt_liberacao
                                                        )
                values (nr_seq_registro_w,
                                                        clock_timestamp(),
                                                        wheb_usuario_pck.get_nm_usuario,
                                                        clock_timestamp(),
                                                        wheb_usuario_pck.get_nm_usuario,
                                                        r_adm_hemoderivados.x,
                                                        r_adm_hemoderivados.qt_dose,
                                                        nr_seq_info_w,
                                                        'SQUARE',
                                                        r_hemoderivados.color,
                                                        r_hemoderivados.style,
                                                        r_adm_hemoderivados.dt_start,
                                                        r_adm_hemoderivados.dt_end,
                                                        r_adm_hemoderivados.dt_fim_grid,
                                                        10,
                                                        180,
                                                        r_adm_hemoderivados.ds_tooltip1,
                                                        r_adm_hemoderivados.ds_tooltip2,
                                                        get_valor_comentario_graf(nr_cirurgia_p,r_adm_hemoderivados.nr_sequencia,'ATEND_MONIT_HEMOD',null),
														get_valor_comentario_graf(nr_cirurgia_p,r_adm_hemoderivados.nr_sequencia,'ATEND_MONIT_HEMOD',null,'F'),
                                                        r_adm_hemoderivados.nr_sequencia,
														r_adm_hemoderivados.dt_liberacao);

                end loop read_adm_hemoderivados;
            end loop read_hemoderivados;

      open c_hemod_default(r_secao.nr_sequencia, r_secao.nr_seq_config);
      fetch c_hemod_default bulk collect into array_ds_informacao_w, array_ds_unidade_medida_w, array_nr_seq_hemod_w, array_ie_modo_adm_w, array_ie_visivel_w, array_nr_seq_conf_info_w, array_ds_caminho_imagem limit 1000;
      close c_hemod_default;

      forall i in array_ds_informacao_w.first..array_ds_informacao_w.last
            insert 
              into w_flowsheet_cirurgia_info( 
                                             nr_sequencia,
                                             dt_atualizacao,
                                             nm_usuario,
                                             dt_atualizacao_nrec,
                                             nm_usuario_nrec,
                                             ds_informacao,
                                             ds_informacao_complementar,
                                             nr_seq_apresentacao,
                                             nm_tabela,
                                             nm_atributo,
                                             nr_seq_grupo,
                                             nr_seq_superior,
                                             ie_temporario,
                                             ie_modo_adm,
                                             cd_material,
                                             cd_unid_medida_adm,
                                             nr_altura,
                                             ie_visivel,
                                             nr_seq_conf_info,
                                             ds_unidade_medida,
                                             ie_tipo,
                                             ie_tipo_agrupamento,
                                             nr_seq_hemod,
                                             ds_caminho_imagem
                                            )
                                     values (
                                             nextval('w_flowsheet_cirurgia_info_seq'),
                                             clock_timestamp(),
                                             wheb_usuario_pck.get_nm_usuario,
                                             clock_timestamp(),
                                             wheb_usuario_pck.get_nm_usuario,
                                             array_ds_informacao_w(i), 
                                             null,
                                             0,
                                             'CIRURGIA_AGENTE_ANESTESICO',
                                             'QT_TEMPORARIO_' || currval('w_flowsheet_cirurgia_info_seq'),
                                             nr_seq_grupo_w,
                                             null,
                                             'N',
                                             array_ie_modo_adm_w(i),
                                             null,
                                             null,
                                             28,
                                             array_ie_visivel_w(i),
                                             array_nr_seq_conf_info_w(i),
                                             array_ds_unidade_medida_w(i),
                                             5,
                                             r_secao.ie_tipo_agrupamento,
                                             array_nr_seq_hemod_w(i),
                                             array_ds_caminho_imagem(i)
                                            );
    when    'AG' then
        <<read_agentes>>
        for r_agentes_medicamentos in c_agentes_medicamentos(r_secao.nr_seq_config, dark_mode_w)
            loop
            select substr(CASE WHEN r_agentes_medicamentos.ie_medic_nao_inform='N' THEN                                     CASE WHEN ie_desc_comercial_w='N' THEN                                         r_agentes_medicamentos.name  ELSE r_agentes_medicamentos.comercial_name END   ELSE coalesce(r_agentes_medicamentos.comercial_name,r_agentes_medicamentos.name) END ,1,255)
            into STRICT name_w
;
            ds_linha_complementar_w:= '';
            vl_contador_w:= 1;
            if (r_agentes_medicamentos.ie_tipo = 2) then
                <<read_componentes_agentes>>
                for r_comp_agentes_medicamentos in c_comp_agentes_medicamentos(r_agentes_medicamentos.nr_seq_superior)
                loop

                vl_contador_w:= vl_contador_w + 1;
                ds_linha_complementar_w :=   ds_linha_complementar_w ||
                                            r_comp_agentes_medicamentos.ds_material || ' ' ||
                                            r_comp_agentes_medicamentos.cd_unidade_medida || '<p>';
                end loop read_componentes_agentes;
            end if;
             nr_altura_w:= 28;
            if (vl_contador_w > 1 and vl_contador_w <= 2) then
                nr_altura_w:= 28 + (vl_contador_w * 8);
            elsif (vl_contador_w >= 3) then
                nr_altura_w:= 28 + (vl_contador_w * 8) + (vl_contador_w * 4);
            end if;

            select   nextval('w_flowsheet_cirurgia_info_seq')
            into STRICT     nr_seq_info_w
;

            insert into w_flowsheet_cirurgia_info( nr_sequencia,
                                                    dt_atualizacao,
                                                    nm_usuario,
                                                    dt_atualizacao_nrec,
                                                    nm_usuario_nrec,
                                                    ds_informacao,
                                                    ds_informacao_complementar,
                                                    nr_seq_apresentacao,
                                                    nm_tabela,
                                                    nm_atributo,
                                                    nr_seq_grupo,
                                                    ds_total_dose,
                                                    nr_seq_superior,
                                                    ie_temporario,
                                                    nr_seq_agente,
                                                    ds_dosagem,
                                                    ie_modo_adm,
                                                    ds_linha_complementar,
                                                    ie_tipo,
                                                    cd_unid_medida_adm,
                                                    cd_material,
                                                    nr_altura,
                                                    ie_visivel,
                                                    nr_seq_conf_info,
                                                    ds_unidade_medida,
                                                    ie_tipo_agrupamento,
                                                    ds_caminho_imagem,
                                                    ie_bomba_infusao,
                                                    ds_icone_inter_medic)
            values (nr_seq_info_w,
                                                clock_timestamp(),
                                                wheb_usuario_pck.get_nm_usuario,
                                                clock_timestamp(),
                                                wheb_usuario_pck.get_nm_usuario,
                                                name_w,
                                                null,
                                                r_agentes_medicamentos.seq_apresentacao,
                                                'CIRURGIA_AGENTE_ANESTESICO',
                                                'QT_DOSE_' || nr_seq_info_w,
                                                nr_seq_grupo_w,
                                                r_agentes_medicamentos.ds_total_dose,
                                                r_agentes_medicamentos.nr_seq_superior,
                                                'N',
                                                r_agentes_medicamentos.nr_seq_agente,
                                                r_agentes_medicamentos.ds_dosagem,
                                                r_agentes_medicamentos.ie_modo_adm,
                                                ds_linha_complementar_w,
                                                r_agentes_medicamentos.ie_tipo,
                                                r_agentes_medicamentos.cd_unid_medida_adm,
                                                r_agentes_medicamentos.cd_material,
                                                nr_altura_w,
                                                r_agentes_medicamentos.ie_visivel,
                                                r_agentes_medicamentos.nr_seq_conf_info,
                                                r_agentes_medicamentos.description,
                                                r_secao.ie_tipo_agrupamento,
                                                r_agentes_medicamentos.ds_caminho_imagem,
                                                r_agentes_medicamentos.ie_bomba_infusao,
                                                r_agentes_medicamentos.ds_icone_inter_medic);

            <<read_adm_agentes>>
            for r_adm_agentes_medicamentos in c_adm_agentes_medicamentos(r_agentes_medicamentos.nr_seq_superior, r_agentes_medicamentos.style, r_agentes_medicamentos.description)
                loop
                ie_ds_style_w:= r_agentes_medicamentos.style;
                if (r_adm_agentes_medicamentos.dt_start = r_adm_agentes_medicamentos.dt_end) then
                    ie_ds_style_w := 'points';
                end if;

                ds_tooltip2_w := obter_desc_tooltip(r_adm_agentes_medicamentos.nr_sequencia,
                                                    r_adm_agentes_medicamentos.qt_dose_ataque,
                                                    r_adm_agentes_medicamentos.ie_modo_adm,
                                                    r_adm_agentes_medicamentos.ds_valor,
                                                    r_agentes_medicamentos.description);

                select   nextval('w_flowsheet_cirurgia_reg_seq')
                into STRICT     nr_seq_registro_w
;

                insert into w_flowsheet_cirurgia_reg(nr_sequencia,
                                                     dt_atualizacao,
                                                     nm_usuario,
                                                     dt_atualizacao_nrec,
                                                     nm_usuario_nrec,
                                                     dt_resultado,
                                                     vl_resultado,
                                                     nr_seq_info,
                                                     ie_symbol,
                                                     ds_cor_symbol,
                                                     ie_style,
                                                     dt_inicio,
                                                     dt_fim,
                                                     dt_fim_grid,
                                                     nr_max,
                                                     nr_min,
                                                     ds_tooltip1,
                                                     ds_tooltip2,
                                                     ds_comentario,
													 ds_comentario_end,
                                                     cd_grupo,
													 dt_liberacao
                                                     )
                values (nr_seq_registro_w,
                                                     clock_timestamp(),
                                                     wheb_usuario_pck.get_nm_usuario,
                                                     clock_timestamp(),
                                                     wheb_usuario_pck.get_nm_usuario,
                                                     r_adm_agentes_medicamentos.x,
                                                     r_adm_agentes_medicamentos.y,
                                                     nr_seq_info_w,
                                                     'CIRCLE',
                                                     r_agentes_medicamentos.color,
                                                     ie_ds_style_w,
                                                     r_adm_agentes_medicamentos.dt_start,
                                                     r_adm_agentes_medicamentos.dt_end,
                                                     r_adm_agentes_medicamentos.dt_fim_grid,
                                                     10,
                                                     180,
                                                     r_adm_agentes_medicamentos.ds_tooltip1,
                                                     ds_tooltip2_w,
                                                     get_valor_comentario_graf(nr_cirurgia_p,r_adm_agentes_medicamentos.nr_sequencia,'CIRURGIA_AGENTE_ANEST_OCOR',null),
													 get_valor_comentario_graf(nr_cirurgia_p,r_adm_agentes_medicamentos.nr_sequencia,'CIRURGIA_AGENTE_ANEST_OCOR',null,'F'),
                                                     r_adm_agentes_medicamentos.nr_sequencia,
													 r_adm_agentes_medicamentos.dt_liberacao);
                end loop read_adm_agentes;
            end loop read_agentes;

            <<read_subsecao_agentes_default>>
            for r_subsecao_agentes_default in c_subsecao_agentes_default(r_secao.nr_sequencia, r_secao.nr_seq_config)
            loop
                select substr(CASE WHEN ie_desc_comercial_w='N' THEN                                 coalesce(r_subsecao_agentes_default.name, r_subsecao_agentes_default.comercial_name)  ELSE r_subsecao_agentes_default.comercial_name END ,1,255)
                into STRICT name_w
;

                select   nextval('w_flowsheet_cirurgia_info_seq')
                into STRICT     nr_seq_info_w
;

                insert into w_flowsheet_cirurgia_info( nr_sequencia,
                                                        dt_atualizacao,
                                                        nm_usuario,
                                                        dt_atualizacao_nrec,
                                                        nm_usuario_nrec,
                                                        ds_informacao,
                                                        ds_informacao_complementar,
                                                        nr_seq_apresentacao,
                                                        nm_tabela,
                                                        nm_atributo,
                                                        nr_seq_grupo,
                                                        ds_total_dose,
                                                        nr_seq_superior,
                                                        ie_temporario,
                                                        nr_seq_agente,
                                                        cd_material,
                                                        nr_altura,
                                                        ie_visivel,
                                                        nr_seq_conf_info,
                                                        nr_seq_mod_sec_agt_med,
                                                        ie_tipo_agrupamento,
                                                        ds_caminho_imagem,
                                                        ds_icone_inter_medic)
                values (nr_seq_info_w,
                                                    clock_timestamp(),
                                                    wheb_usuario_pck.get_nm_usuario,
                                                    clock_timestamp(),
                                                    wheb_usuario_pck.get_nm_usuario,
                                                    name_w,
                                                    null,
                                                    (r_subsecao_agentes_default.nr_seq_apresentacao * 100),
                                                    'CIRURGIA_AGENTE_ANESTESICO',
                                                    'QT_TEMPORARIO_' || nr_seq_info_w,
                                                    nr_seq_grupo_w,
                                                    null,
                                                    null,
                                                    'S',
                                                    r_subsecao_agentes_default.nr_seq_agente,
                                                    r_subsecao_agentes_default.cd_material,
                                                    28,
                                                    r_subsecao_agentes_default.ie_visivel,
                                                    r_subsecao_agentes_default.nr_seq_conf_info,
                                                    r_subsecao_agentes_default.nr_sequencia,
                                                    r_secao.ie_tipo_agrupamento,
                                                    r_subsecao_agentes_default.ds_caminho_imagem,
                                                    r_subsecao_agentes_default.ds_icone_inter_medic);

            end loop read_subsecao_agentes_default;

        when    'TA' then
        <<read_terapias_atuais>>
        for r_terapias_atuais in c_terapias_atuais(r_secao.nr_seq_config, dark_mode_w)
            loop
            select substr(CASE WHEN ie_desc_comercial_w='N' THEN                                     coalesce(r_terapias_atuais.name, r_terapias_atuais.comercial_name)  ELSE r_terapias_atuais.comercial_name END ,1,255)
            into STRICT name_w
;

            select   nextval('w_flowsheet_cirurgia_info_seq')
            into STRICT     nr_seq_info_w
;

            insert into w_flowsheet_cirurgia_info( nr_sequencia,
                                                    dt_atualizacao,
                                                    nm_usuario,
                                                    dt_atualizacao_nrec,
                                                    nm_usuario_nrec,
                                                    ds_informacao,
                                                    ds_informacao_complementar,
                                                    nr_seq_apresentacao,
                                                    nm_tabela,
                                                    nm_atributo,
                                                    nr_seq_grupo,
                                                    ds_total_dose,
                                                    nr_seq_superior,
                                                    ie_temporario,
                                                    ds_dosagem,
                                                    ie_modo_adm,
                                                    cd_unid_medida_adm,
                                                    cd_material,
                                                    ie_tipo,
                                                    nr_altura,
                                                    ie_visivel,
                                                    nr_seq_conf_info,
                                                    ds_unidade_medida,
                                                    ie_tipo_agrupamento,
                                                    ds_caminho_imagem,
                                                    ds_icone_inter_medic)
            values (nr_seq_info_w,
                                                clock_timestamp(),
                                                wheb_usuario_pck.get_nm_usuario,
                                                clock_timestamp(),
                                                wheb_usuario_pck.get_nm_usuario,
                                                coalesce(name_w,r_terapias_atuais.name),
                                                null,
                                                r_terapias_atuais.seq_apresentacao,
                                                'CIRURGIA_AGENTE_ANESTESICO',
                                                'QT_DOSE_' || nr_seq_info_w,
                                                nr_seq_grupo_w,
                                                r_terapias_atuais.ds_total_dose,
                                                r_terapias_atuais.nr_seq_superior,
                                                'N',
                                                r_terapias_atuais.ds_dosagem,
                                                r_terapias_atuais.ie_modo_adm,
                                                r_terapias_atuais.cd_unid_medida_adm,
                                                r_terapias_atuais.cd_material,
                                                r_terapias_atuais.ie_tipo,
                                                28,
                                                r_terapias_atuais.ie_visivel,
                                                r_terapias_atuais.nr_seq_conf_info,
                                                r_terapias_atuais.description,
                                                r_secao.ie_tipo_agrupamento,
                                                r_terapias_atuais.ds_caminho_imagem,
                                                r_terapias_atuais.ds_icone_inter_medic);
            <<read_terapias_atuais_adm>>
            for r_terapias_atuais_adm in c_terapias_atuais_adm(r_terapias_atuais.nr_seq_superior, r_terapias_atuais.style, r_terapias_atuais.description)
                loop
                ie_ds_style_w:= r_terapias_atuais.style;
                if (r_terapias_atuais_adm.dt_start = r_terapias_atuais_adm.dt_end) then
                    ie_ds_style_w := 'points';
                end if;

                ds_tooltip2_w := obter_desc_tooltip(r_terapias_atuais_adm.nr_sequencia,
                                                    r_terapias_atuais_adm.qt_dose_ataque,
                                                    r_terapias_atuais_adm.ie_modo_adm,
                                                    r_terapias_atuais_adm.ds_valor,
                                                    r_terapias_atuais.description);

                select   nextval('w_flowsheet_cirurgia_reg_seq')
                into STRICT     nr_seq_registro_w
;

                insert into w_flowsheet_cirurgia_reg(nr_sequencia,
                                                     dt_atualizacao,
                                                     nm_usuario,
                                                     dt_atualizacao_nrec,
                                                     nm_usuario_nrec,
                                                     dt_resultado,
                                                     vl_resultado,
                                                     nr_seq_info,
                                                     ie_symbol,
                                                     ds_cor_symbol,
                                                     ie_style,
                                                     dt_inicio,
                                                     dt_fim,
                                                     dt_fim_grid,
                                                     nr_max,
                                                     nr_min,
                                                     ds_tooltip1,
                                                     ds_tooltip2,
                                                     ds_comentario,
                                                     cd_grupo,
													 dt_liberacao
                                                     )
                values (nr_seq_registro_w,
                                                     clock_timestamp(),
                                                     wheb_usuario_pck.get_nm_usuario,
                                                     clock_timestamp(),
                                                     wheb_usuario_pck.get_nm_usuario,
                                                     r_terapias_atuais_adm.x,
                                                     r_terapias_atuais_adm.y,
                                                     nr_seq_info_w,
                                                     'CIRCLE',
                                                     r_terapias_atuais.color,
                                                     r_terapias_atuais.style,
                                                     r_terapias_atuais_adm.dt_start,
                                                     r_terapias_atuais_adm.dt_end,
                                                     r_terapias_atuais_adm.dt_fim_grid,
                                                     10,
                                                     180,
                                                     r_terapias_atuais_adm.ds_tooltip1,
                                                     ds_tooltip2_w,
                                                     get_valor_comentario_graf(nr_cirurgia_p,r_terapias_atuais_adm.nr_sequencia,'CIRURGIA_AGENTE_ANEST_OCOR',null),
                                                     r_terapias_atuais_adm.nr_sequencia,
													 r_terapias_atuais_adm.dt_liberacao);
                end loop read_terapias_atuais_adm;
				
				current_therapies_adm(r_terapias_atuais.nr_seq_superior,r_terapias_atuais.description, r_terapias_atuais.color);
end loop read_terapias_atuais;

        when    'SV' then
        <<read_sinais_vitais>>
        for r_sinais_vitais in c_sinais_vitais_modelo(r_secao.nr_sequencia, r_secao.nr_seq_config, dark_mode_w)
            loop
            description_w:= r_sinais_vitais.description;
            if (coalesce(description_w::text, '') = '') then
                case    r_sinais_vitais.ie_sinal_vital
                    when    'QTRV' then
                    description_w := obter_desc_expressao(935055,'dyna.seg.cm-5');
                    when    'TXRV' then
                    description_w := obter_desc_expressao(935055,'dyna.seg.cm-5');
                    when    'PAM' then
                    description_w := obter_desc_expressao(792358,'mmHg');
                    when    'ICA' then
                    description_w := obter_desc_expressao(935052,'l/min/m2');
                    when    'QTFREQVENT' then
                    description_w := obter_desc_expressao(935060,'ciclos/min');
                    when    'PAI' then
                    description_w := obter_desc_expressao(792358,'mmHg');
                    when    'PANI' then
                    description_w := obter_desc_expressao(792358,'mmHg');
                    else
                    description_w := null;
                end case;
            end if;
            ie_visivel_w:= 'N';
            if (r_sinais_vitais.ie_visivel IS NOT NULL AND r_sinais_vitais.ie_visivel::text <> '') then
                ie_visivel_w:= r_sinais_vitais.ie_visivel;
            elsif (r_sinais_vitais.nr_seq_modelo_secao IS NOT NULL AND r_sinais_vitais.nr_seq_modelo_secao::text <> '') then
                ie_visivel_w:= 'S';
            end if;
            ds_color_w  :=  r_sinais_vitais.color;
            ds_style_w  :=  r_sinais_vitais.style;
            ds_shape_w  :=  r_sinais_vitais.shape;

			for r_pepo_config_cliente in c_pepo_config_cliente(r_sinais_vitais.nr_sequencia, dark_mode_w) loop
				begin
					ds_color_w  := r_pepo_config_cliente.color;
					ds_style_w  := r_pepo_config_cliente.style;
					ds_shape_w  := r_pepo_config_cliente.shape;
				end;
			end loop;
		

            select   nextval('w_flowsheet_cirurgia_info_seq')
            into STRICT     nr_seq_info_w
;
            insert into w_flowsheet_cirurgia_info(nr_sequencia,
                                                  dt_atualizacao,
                                                  nm_usuario,
                                                  dt_atualizacao_nrec,
                                                  nm_usuario_nrec,
                                                  ds_informacao,
                                                  ds_informacao_complementar,
                                                  cd_unid_medida_adm,
                                                  nr_seq_apresentacao,
                                                  nm_tabela,
                                                  nm_atributo,
                                                  nr_seq_grupo,
                                                  ds_total_dose,
                                                  nr_seq_superior,
                                                  ie_temporario,
                                                  nr_seq_agente,
                                                  ds_dosagem,
                                                  ie_modo_adm,
                                                  ds_linha_complementar,
                                                  ie_tipo,
                                                  cd_material,
                                                  ie_timeout_sv,
                                                  vl_timeout_sv,
                                                  nr_altura,
                                                  ds_unidade_medida,
                                                  ie_visivel,
                                                  nr_seq_conf_info,
                                                  nr_seq_sinal_vital,
                                                  ds_cor,
                                                  ie_symbol_legend,
                                                  ie_style_legend,
                                                  ie_tipo_agrupamento,
                                                  cd_tipo_escala,
                                                  vl_max_escala,
                                                  vl_min_escala,
                                                  vl_intervalo_escala,
                                                  ds_cor_escala,
                                                  ie_trend,
                                                  ie_line,
                                                  nr_size,
                                                  ds_caminho_imagem
                                                  )
            values (nr_seq_info_w,
                                                  clock_timestamp(),
                                                  wheb_usuario_pck.get_nm_usuario,
                                                  clock_timestamp(),
                                                  wheb_usuario_pck.get_nm_usuario,
                                                  r_sinais_vitais.name,
                                                  null,
                                                  null,
                                                  r_sinais_vitais.nr_seq_apresentacao,
                                                  'ATENDIMENTO_SINAL_VITAL',
                                                  r_sinais_vitais.ie_sinal_vital || '_' || nr_seq_info_w,
                                                  nr_seq_grupo_w,
                                                  null,null,
                                                  'N',
                                                  null,null,null,null,null,null,
                                                  r_sinais_vitais.ie_timeout_sv,
                                                  r_sinais_vitais.vl_timeout_sv,
                                                  28,
                                                  description_w,
                                                  ie_visivel_w,
                                                  r_sinais_vitais.nr_seq_conf_info,
                                                  r_sinais_vitais.nr_seq_sinal_vital,
                                                  ds_color_w,
                                                  ds_shape_w,
                                                  ds_style_w,
                                                  r_secao.ie_tipo_agrupamento,
                                                  coalesce(r_sinais_vitais.cd_tipo_escala,'EP'),
                                                  CASE WHEN r_secao.ie_sumarizado='N' THEN  null  ELSE CASE WHEN r_sinais_vitais.cd_tipo_escala='E1' THEN  r_secao.vl_max_escala_1 WHEN r_sinais_vitais.cd_tipo_escala='E2' THEN  r_secao.vl_max_escala_2 WHEN r_sinais_vitais.cd_tipo_escala='E3' THEN  r_secao.vl_max_escala_3 WHEN r_sinais_vitais.cd_tipo_escala='E4' THEN  r_secao.vl_max_escala_4  ELSE r_secao.vl_max_escala_padrao END  END ,
                                                  CASE WHEN r_secao.ie_sumarizado='N' THEN  null  ELSE CASE WHEN r_sinais_vitais.cd_tipo_escala='E1' THEN  r_secao.vl_min_escala_1 WHEN r_sinais_vitais.cd_tipo_escala='E2' THEN  r_secao.vl_min_escala_2 WHEN r_sinais_vitais.cd_tipo_escala='E3' THEN  r_secao.vl_min_escala_3 WHEN r_sinais_vitais.cd_tipo_escala='E4' THEN  r_secao.vl_min_escala_4  ELSE r_secao.vl_min_escala_padrao END  END ,
                                                  CASE WHEN r_sinais_vitais.cd_tipo_escala='E1' THEN  r_secao.vl_intervalo_escala_1 WHEN r_sinais_vitais.cd_tipo_escala='E2' THEN  r_secao.vl_intervalo_escala_2 WHEN r_sinais_vitais.cd_tipo_escala='E3' THEN  r_secao.vl_intervalo_escala_3 WHEN r_sinais_vitais.cd_tipo_escala='E4' THEN  r_secao.vl_intervalo_escala_4  ELSE r_secao.vl_intervalo_escala_padrao END ,
                                                  CASE WHEN r_sinais_vitais.cd_tipo_escala='E1' THEN  r_secao.ds_cor_escala_1 WHEN r_sinais_vitais.cd_tipo_escala='E2' THEN  r_secao.ds_cor_escala_2 WHEN r_sinais_vitais.cd_tipo_escala='E3' THEN  r_secao.ds_cor_escala_3 WHEN r_sinais_vitais.cd_tipo_escala='E4' THEN  r_secao.ds_cor_escala_4  ELSE r_secao.ds_cor_escala_padrao END ,
                                                  r_sinais_vitais.ie_trend,
                                                  r_sinais_vitais.ie_line,
                                                  r_sinais_vitais.nr_size,
                                                  r_sinais_vitais.ds_caminho_imagem
                                                  );
            if (ie_visivel_w = 'S') then
                <<read_valores_sinais_vitais>>
                for r_sinal in c_sinal(r_sinais_vitais.ie_sinal_vital, r_sinais_vitais.description) loop
                    select   nextval('w_flowsheet_cirurgia_reg_seq')
                    into STRICT     nr_seq_registro_w
;

                    insert into w_flowsheet_cirurgia_reg(nr_sequencia,
                                                         dt_atualizacao,
                                                         nm_usuario,
                                                         dt_atualizacao_nrec,
                                                         nm_usuario_nrec,
                                                         dt_resultado,
                                                         vl_resultado,
                                                         ds_resultado,
                                                         nr_seq_info,
                                                         ie_symbol,
                                                         ds_cor_symbol,
                                                         ie_style,
                                                         dt_inicio,
                                                         dt_fim,
                                                         vl_y_max,
                                                         vl_y_min,
                                                         ds_tooltip1,
                                                         ds_tooltip2,
                                                         ds_comentario,
                                                         ie_valor_fora_faixa
                                                        )
                    values (nr_seq_registro_w,
                                                        clock_timestamp(),
                                                        wheb_usuario_pck.get_nm_usuario,
                                                        clock_timestamp(),
                                                        wheb_usuario_pck.get_nm_usuario,
                                                        r_sinal.dt_registro,
                                                        r_sinal.qt_valor,
                                                        null,
                                                        nr_seq_info_w,
                                                        ds_shape_w,
                                                        ds_color_w,
                                                        ds_style_w,
                                                        r_sinal.dt_registro,
                                                        r_sinal.dt_registro,
                                                        r_sinal.y_max,
                                                        r_sinal.y_min,
                                                        r_sinal.ds_tooltip1,
                                                        r_sinal.ds_tooltip2,
                                                        null,
                                                        obter_sinal_out_graf(r_sinais_vitais.ie_sinal_vital,nr_seq_modelo_p,r_sinal.qt_valor, nr_cirurgia_p, nr_seq_pepo_p));
                end loop read_valores_sinais_vitais;
                select  round((min(vl_resultado))::numeric,3)
                into STRICT    vl_min_w
                from    w_flowsheet_cirurgia_reg
                where   nr_seq_info = nr_seq_info_w;

                select  round((max(vl_resultado))::numeric,3)
                into STRICT    vl_max_w
                from    w_flowsheet_cirurgia_reg
                where   nr_seq_info = nr_seq_info_w;

                select  round((sum(vl_resultado)/count(nr_sequencia))::numeric,3)
                into STRICT    vl_med_w
                from    w_flowsheet_cirurgia_reg
                where   nr_seq_info = nr_seq_info_w
                and     (vl_resultado IS NOT NULL AND vl_resultado::text <> '');

                update w_flowsheet_cirurgia_info
                set vl_min   = vl_min_w,
                    vl_max   = vl_max_w,
                    vl_med   = vl_med_w
                where  nr_sequencia = nr_seq_info_w;
            end if;
        end loop read_sinais_vitais;

        when    'BH' then
        begin
        <<read_balanco_hidrico>>
        for r_balanco_hidrico in c_balanco_hidrico(r_secao.nr_seq_config, dark_mode_w)
            loop
            select   nextval('w_flowsheet_cirurgia_info_seq')
            into STRICT     nr_seq_info_w
;

            insert into w_flowsheet_cirurgia_info(nr_sequencia,
                                                  dt_atualizacao,
                                                  nm_usuario,
                                                  dt_atualizacao_nrec,
                                                  nm_usuario_nrec,
                                                  ds_informacao,
                                                  ds_informacao_complementar,
                                                  ds_unidade_medida,
                                                  nr_seq_apresentacao,
                                                  nm_tabela,
                                                  nm_atributo,
                                                  nr_seq_grupo,
                                                  nr_seq_superior,
                                                  ie_temporario,
                                                  nr_altura,
                                                  ie_visivel,
                                                  nr_seq_conf_info,
                                                  ie_resumo_bh,
                                                  nr_seq_tipo_bh,
                                                  ie_tipo_agrupamento,
                                                  ds_caminho_imagem
                                                  )
            values (nr_seq_info_w,
                                                clock_timestamp(),
                                                wheb_usuario_pck.get_nm_usuario,
                                                clock_timestamp(),
                                                wheb_usuario_pck.get_nm_usuario,
                                                r_balanco_hidrico.name,
                                                null,
                                                r_balanco_hidrico.description,
                                                0,
                                                r_balanco_hidrico.nm_tabela,
                                                'DS_TIPO_' || nr_seq_info_w || '_' || r_balanco_hidrico.nr_seq_tipo,
                                                nr_seq_grupo_w,
                                                r_balanco_hidrico.nr_seq_superior,
                                                'N',
                                                28,
                                                r_balanco_hidrico.ie_visivel,
                                                r_balanco_hidrico.nr_seq_conf_info,
                                                'N',
                                                r_balanco_hidrico.nr_seq_tipo,
                                                r_secao.ie_tipo_agrupamento,
                                                r_balanco_hidrico.ds_caminho_imagem
                                                );
            <<read_bh_perda_ganho>>
            for r_bh_perda_ganho in c_bh_perda_ganho(r_balanco_hidrico.nr_seq_tipo) loop
                select   nextval('w_flowsheet_cirurgia_reg_seq')
                into STRICT     nr_seq_registro_w
;

                insert into w_flowsheet_cirurgia_reg(nr_sequencia,
                                                     dt_atualizacao,
                                                     nm_usuario,
                                                     dt_atualizacao_nrec,
                                                     nm_usuario_nrec,
                                                     dt_resultado,
                                                     vl_resultado,
                                                     ds_resultado,
                                                     nr_seq_info,
                                                     ie_symbol,
                                                     ds_cor_symbol,
                                                     ie_style,
                                                     dt_inicio,
                                                     dt_fim,
                                                     nr_max,
                                                     nr_min,
                                                     ds_tooltip1,
                                                     ds_tooltip2,
                                                     ds_comentario,
													 cd_grupo,
													 dt_liberacao
                                                     )
                values (nr_seq_registro_w,
                                                    clock_timestamp(),
                                                    wheb_usuario_pck.get_nm_usuario,
                                                    clock_timestamp(),
                                                    wheb_usuario_pck.get_nm_usuario,
                                                    r_bh_perda_ganho.dt_registro,
                                                    r_bh_perda_ganho.qt_valor,
                                                    null,
                                                    nr_seq_info_w,
                                                    r_balanco_hidrico.symbol,
                                                    r_balanco_hidrico.color,
                                                    upper(coalesce(r_balanco_hidrico.style,'POINTS')),
                                                    r_bh_perda_ganho.dt_registro,
                                                    r_bh_perda_ganho.dt_registro,
                                                    null,
                                                    null,
                                                    r_bh_perda_ganho.ds_tooltip1,
                                                    r_bh_perda_ganho.ds_tooltip2,
                                                    get_valor_comentario_graf(nr_cirurgia_p,r_bh_perda_ganho.nr_sequencia,r_bh_perda_ganho.nm_tabela,null),
													r_bh_perda_ganho.nr_sequencia,
													r_bh_perda_ganho.dt_liberacao
                                                    );
            end loop read_bh_perda_ganho;

            select  round((sum(vl_resultado))::numeric,3)
            into STRICT    vl_soma_w
            from    w_flowsheet_cirurgia_reg
            where   nr_seq_info = nr_seq_info_w
            and     (vl_resultado IS NOT NULL AND vl_resultado::text <> '');

            if (vl_soma_w IS NOT NULL AND vl_soma_w::text <> '') then
                if (r_balanco_hidrico.ie_tipo_pg = 'G') then
                    update  w_flowsheet_cirurgia_info
                    set     ds_total_dose = obter_desc_expressao(1062573)|| ': ' || vl_soma_w || ' (ml)'
                    where   nr_sequencia = nr_seq_info_w;
                else
                    update  w_flowsheet_cirurgia_info
                    set     ds_total_dose = obter_desc_expressao(1062571)|| ': ' || vl_soma_w || ' (ml)'
                    where   nr_sequencia = nr_seq_info_w;
                end if;
            end if;
        end loop read_balanco_hidrico;
        <<read_balanco_hidrico_resumo>>
        for r_balanco_hidrico_resumo in c_balanco_hidrico_resumo(r_secao.nr_seq_config, dark_mode_w)
            loop
            select   nextval('w_flowsheet_cirurgia_info_seq')
            into STRICT     nr_seq_info_w
;

            insert into w_flowsheet_cirurgia_info(nr_sequencia,
                                                  dt_atualizacao,
                                                  nm_usuario,
                                                  dt_atualizacao_nrec,
                                                  nm_usuario_nrec,
                                                  ds_informacao,
                                                  ds_informacao_complementar,
                                                  ds_unidade_medida,
                                                  nr_seq_apresentacao,
                                                  nm_tabela,
                                                  nm_atributo,
                                                  nr_seq_grupo,
                                                  nr_seq_superior,
                                                  ie_temporario,
                                                  nr_altura,
                                                  ie_visivel,
                                                  nr_seq_conf_info,
                                                  ie_resumo_bh,
                                                  ie_tipo_agrupamento
                                                 )
            values (nr_seq_info_w,
                                                clock_timestamp(),
                                                wheb_usuario_pck.get_nm_usuario,
                                                clock_timestamp(),
                                                wheb_usuario_pck.get_nm_usuario,
                                                r_balanco_hidrico_resumo.name,
                                                null,
                                                r_balanco_hidrico_resumo.description,
                                                20,
                                                r_balanco_hidrico_resumo.nm_tabela,
                                                'DS_TIPO_' || nr_seq_info_w,
                                                nr_seq_grupo_w,
                                                r_balanco_hidrico_resumo.nr_seq_superior,
                                                'N',
                                                28,
                                                r_balanco_hidrico_resumo.ie_visivel,
                                                r_balanco_hidrico_resumo.nr_seq_conf_info,
                                                'S',
                                                r_secao.ie_tipo_agrupamento);
            vl_total_v_w:= null;
            <<read_bh_perda_ganho_resumo>>
            for r_bh_perda_ganho_resumo in c_bh_perda_ganho_resumo loop
                select   nextval('w_flowsheet_cirurgia_reg_seq')
                into STRICT     nr_seq_registro_w
;

                insert into w_flowsheet_cirurgia_reg(nr_sequencia,
                                                     dt_atualizacao,
                                                     nm_usuario,
                                                     dt_atualizacao_nrec,
                                                     nm_usuario_nrec,
                                                     dt_resultado,
                                                     vl_resultado,
                                                     ds_resultado,
                                                     nr_seq_info,
                                                     ie_symbol,
                                                     ds_cor_symbol,
                                                     ie_style,
                                                     dt_inicio,
                                                     dt_fim,
                                                     nr_max,
                                                     nr_min,
                                                     ds_tooltip1,
                                                     ds_tooltip2,
                                                     ds_comentario,
                                                     cd_grupo
                                                     )
                values (nr_seq_registro_w,
                                                    clock_timestamp(),
                                                    wheb_usuario_pck.get_nm_usuario,
                                                    clock_timestamp(),
                                                    wheb_usuario_pck.get_nm_usuario,
                                                    r_bh_perda_ganho_resumo.dt_registro,
                                                    r_bh_perda_ganho_resumo.qt_valor,
                                                    null,
                                                    nr_seq_info_w,
                                                    r_balanco_hidrico_resumo.symbol,
                                                    r_balanco_hidrico_resumo.color,
                                                    upper(coalesce(r_balanco_hidrico_resumo.style,'line')),
                                                    r_bh_perda_ganho_resumo.dt_registro,
                                                    r_bh_perda_ganho_resumo.dt_registro,
                                                    null,
                                                    null,
                                                    r_bh_perda_ganho_resumo.ds_tooltip1,
                                                    r_bh_perda_ganho_resumo.ds_tooltip2,
                                                    null,
                                                    1);
            vl_total_v_w:=  r_bh_perda_ganho_resumo.qt_valor;
            end loop read_bh_perda_ganho_resumo;

            if (vl_total_v_w IS NOT NULL AND vl_total_v_w::text <> '') then
                update  w_flowsheet_cirurgia_info
                set     ds_total_dose = obter_desc_expressao(1062551)|| ': ' || vl_total_v_w || ' (ml)'
                where   nr_sequencia = nr_seq_info_w;
            end if;

        end loop read_balanco_hidrico_resumo;
        <<bh_perda_ganho_default>>
        for r_bh_perda_ganho_default in c_bh_perda_ganho_default(r_secao.nr_sequencia, r_secao.nr_seq_config, dark_mode_w)
        loop

        select   nextval('w_flowsheet_cirurgia_info_seq')
            into STRICT     nr_seq_info_w
;

            insert into w_flowsheet_cirurgia_info(nr_sequencia,
                                                  dt_atualizacao,
                                                  nm_usuario,
                                                  dt_atualizacao_nrec,
                                                  nm_usuario_nrec,
                                                  ds_informacao,
                                                  ds_informacao_complementar,
                                                  ds_unidade_medida,
                                                  nr_seq_apresentacao,
                                                  nm_tabela,
                                                  nm_atributo,
                                                  nr_seq_grupo,
                                                  nr_seq_superior,
                                                  ie_temporario,
                                                  nr_altura,
                                                  ie_visivel,
                                                  nr_seq_conf_info,
                                                  ie_resumo_bh,
                                                  nr_seq_tipo_bh,
                                                  ie_tipo_agrupamento,
                                                  ds_caminho_imagem
                                                  )
            values (nr_seq_info_w,
                                                clock_timestamp(),
                                                wheb_usuario_pck.get_nm_usuario,
                                                clock_timestamp(),
                                                wheb_usuario_pck.get_nm_usuario,
                                                r_bh_perda_ganho_default.name,
                                                null,
                                                r_bh_perda_ganho_default.description,
                                                0,
                                                r_bh_perda_ganho_default.nm_tabela,
                                                'DS_TEMPORARIO_' ||'0_'||r_bh_perda_ganho_default.nr_sequencia,
                                                nr_seq_grupo_w,
                                                r_bh_perda_ganho_default.nr_seq_superior,
                                                'N',
                                                28,
                                                r_bh_perda_ganho_default.ie_visivel,
                                                r_bh_perda_ganho_default.nr_seq_conf_info,
                                                'N',
                                                r_bh_perda_ganho_default.nr_sequencia,
                                                r_secao.ie_tipo_agrupamento,
                                                r_bh_perda_ganho_default.ds_caminho_imagem);
        end loop;
        end;
        when    'EV' then
        <<read_evolucoes>>
        for r_evolucao_paciente in c_evolucao_paciente(r_secao.nr_seq_config)
            loop
                ds_tipo_evolucao_w:= r_evolucao_paciente.ds_tipo_evolucao;
                select   nextval('w_flowsheet_cirurgia_info_seq')
                into STRICT     nr_seq_info_w
;

                insert into w_flowsheet_cirurgia_info(nr_sequencia,
                                                      dt_atualizacao,
                                                      nm_usuario,
                                                      dt_atualizacao_nrec,
                                                      nm_usuario_nrec,
                                                      ds_informacao,
                                                      ds_informacao_complementar,
                                                      nr_seq_apresentacao,
                                                      nm_tabela,
                                                      nm_atributo,
                                                      nr_seq_grupo,
                                                      nr_seq_superior,
                                                      ie_temporario,
                                                      nr_altura,
                                                      ie_visivel,
                                                      nr_seq_conf_info,
                                                      cd_evolucao,
                                                      ie_tipo_agrupamento,
                                                      ds_caminho_imagem
                                                      )
                values (nr_seq_info_w,
                                                    clock_timestamp(),
                                                    wheb_usuario_pck.get_nm_usuario,
                                                    clock_timestamp(),
                                                    wheb_usuario_pck.get_nm_usuario,
                                                    substr(obter_texto_tasy(1138842, wheb_usuario_pck.get_nr_seq_idioma) || ' - ' || r_evolucao_paciente.ds_tipo_evolucao,0,100),
                                                    null,
                                                    0,
                                                    'EVOLUCAO_PACIENTE',
                                                    'DS_EVOLUCAO_' || nr_seq_info_w,
                                                    nr_seq_grupo_w,
                                                    null,
                                                    'N',
                                                    28,
                                                    r_evolucao_paciente.ie_visivel,
                                                    r_evolucao_paciente.nr_seq_conf_info,
                                                    r_evolucao_paciente.cd_evolucao,
                                                    r_secao.ie_tipo_agrupamento,
                                                    r_evolucao_paciente.ds_caminho_imagem);

          select   nextval('w_flowsheet_cirurgia_reg_seq')
            into STRICT     nr_seq_registro_w
;

            insert into w_flowsheet_cirurgia_reg(nr_sequencia,
                                                 dt_atualizacao,
                                                 nm_usuario,
                                                 dt_atualizacao_nrec,
                                                 nm_usuario_nrec,
                                                 dt_resultado,
                                                 vl_resultado,
                                                 ds_resultado,
                                                 nr_seq_info,
                                                 ie_symbol,
                                                 ds_cor_symbol,
                                                 ie_style,
                                                 dt_inicio,
                                                 dt_fim,
                                                 nr_max,
                                                 nr_min,
                                                 ds_tooltip1,
                                                 ds_tooltip2,
                                                 ds_comentario,
												 dt_liberacao
                                                )
            values (nr_seq_registro_w,
                                                clock_timestamp(),
                                                wheb_usuario_pck.get_nm_usuario,
                                                clock_timestamp(),
                                                wheb_usuario_pck.get_nm_usuario,
                                                r_evolucao_paciente.dt_evolucao,
                                                0,
                                                'X',
                                                nr_seq_info_w,
                                                'CIRCLE',
                                                '#f1c40f',
                                                'POINTS',
                                                r_evolucao_paciente.dt_evolucao,
                                                r_evolucao_paciente.dt_evolucao,
                                                10,
                                                180,
                                                r_evolucao_paciente.ds_tooltip1,
                                                obter_texto_tasy(1138842, wheb_usuario_pck.get_nr_seq_idioma) || ' - ' || r_evolucao_paciente.ds_tipo_evolucao,
                                                null,
												r_evolucao_paciente.dt_liberacao);
            end loop read_evolucoes;
        when    'EL' then

        <<read_exames>>
        for r_exames_lab in c_exames_lab(r_secao.nr_seq_config, dt_incio_cirurgia_w, dt_fim_cirurgia_w)
            loop
            select   nextval('w_flowsheet_cirurgia_info_seq')
            into STRICT     nr_seq_info_w
;

            insert into w_flowsheet_cirurgia_info(nr_sequencia,
                                                  dt_atualizacao,
                                                  nm_usuario,
                                                  dt_atualizacao_nrec,
                                                  nm_usuario_nrec,
                                                  ds_informacao,
                                                  ds_informacao_complementar,
                                                  nr_seq_apresentacao,
                                                  nm_tabela,
                                                  nm_atributo,
                                                  nr_seq_grupo,
                                                  ds_material,
                                                  ds_unidade_medida,
                                                  ie_temporario,
                                                  nr_altura,
                                                  nr_seq_result_item,
                                                  nr_seq_resultado,
                                                  ie_visivel,
                                                  nr_seq_conf_info,
                                                  ie_tipo_agrupamento,
                                                  ds_caminho_imagem
                                                 )
            values (nr_seq_info_w,
                                                clock_timestamp(),
                                                wheb_usuario_pck.get_nm_usuario,
                                                clock_timestamp(),
                                                wheb_usuario_pck.get_nm_usuario,
                                                substr(r_exames_lab.ds_evento,0,100),
                                                null,
                                                0,
                                                r_exames_lab.nm_tabela,
                                                'DS_EXAMES_' || nr_seq_info_w ||'_'||r_exames_lab.nr_seq_exame,
                                                nr_seq_grupo_w,
                                                r_exames_lab.ds_material_exame,
                                                r_exames_lab.UNIDADE_MEDIDA,
                                                'N',
                                                28,
                                                r_exames_lab.nr_seq_item,
                                                r_exames_lab.nr_sequencia,
                                                r_exames_lab.ie_visivel,
                                                r_exames_lab.nr_seq_conf_info,
                                                r_secao.ie_tipo_agrupamento,
                                                r_exames_lab.ds_caminho_imagem);

            select   nextval('w_flowsheet_cirurgia_reg_seq')
            into STRICT     nr_seq_registro_w
;

            insert into w_flowsheet_cirurgia_reg(nr_sequencia,
                                                 dt_atualizacao,
                                                 nm_usuario,
                                                 dt_atualizacao_nrec,
                                                 nm_usuario_nrec,
                                                 dt_resultado,
                                                 vl_resultado,
                                                 ds_resultado,
                                                 nr_seq_info,
                                                 ie_symbol,
                                                 ds_cor_symbol,
                                                 ie_style,
                                                 dt_inicio,
                                                 dt_fim,
                                                 nr_max,
                                                 nr_min,
                                                 ds_tooltip1,
                                                 ds_tooltip2,
                                                 ds_comentario,
												 dt_liberacao
                                                )
            values (nr_seq_registro_w,
                                                clock_timestamp(),
                                                wheb_usuario_pck.get_nm_usuario,
                                                clock_timestamp(),
                                                wheb_usuario_pck.get_nm_usuario,
                                                r_exames_lab.dt_registro,
                                                r_exames_lab.vl_resultado,
                                                substr(r_exames_lab.ds_resultado,0,100),
                                                nr_seq_info_w,
                                                'CIRCLE',
                                                '#f1c40f',
                                                'POINTS',
                                                r_exames_lab.dt_registro,
                                                r_exames_lab.dt_registro,
                                                10,
                                                180,
                                                r_exames_lab.ds_tooltip1,
                                                substr(coalesce(to_char(r_exames_lab.vl_resultado), r_exames_lab.ds_resultado) ||' '||r_exames_lab.UNIDADE_MEDIDA,1,255),
                                                get_valor_comentario_graf(nr_cirurgia_p,r_exames_lab.nr_sequencia,r_exames_lab.nm_tabela,null),
												r_exames_lab.dt_liberacao);
            end loop read_exames;
        <<read_exames_default>>
        for r_exames_lab_default in c_exames_lab_default(r_secao.nr_sequencia, r_secao.nr_seq_config, dt_incio_cirurgia_w, dt_fim_cirurgia_w) loop
            select   nextval('w_flowsheet_cirurgia_info_seq')
            into STRICT     nr_seq_info_w
;

                        insert into w_flowsheet_cirurgia_info(nr_sequencia,
                                                  dt_atualizacao,
                                                  nm_usuario,
                                                  dt_atualizacao_nrec,
                                                  nm_usuario_nrec,
                                                  ds_informacao,
                                                  ds_informacao_complementar,
                                                  nr_seq_apresentacao,
                                                  nm_tabela,
                                                  nm_atributo,
                                                  nr_seq_grupo,
                                                  ds_material,
                                                  ds_unidade_medida,
                                                  ie_temporario,
                                                  nr_altura,
                                                  nr_seq_result_item,
                                                  nr_seq_resultado,
                                                  ie_visivel,
                                                  nr_seq_conf_info,
                                                  nr_seq_exame,
                                                  ie_tipo_agrupamento,
                                                  ds_caminho_imagem
                                                 )
            values (nr_seq_info_w,
                                                clock_timestamp(),
                                                wheb_usuario_pck.get_nm_usuario,
                                                clock_timestamp(),
                                                wheb_usuario_pck.get_nm_usuario,
                                                substr(r_exames_lab_default.ds_evento,0,100),
                                                null,
                                                0,
                                                r_exames_lab_default.nm_tabela,
                                                'DS_TEMPORARIO_' || nr_seq_info_w || '_' ||r_exames_lab_default.nr_seq_lab_test,
                                                nr_seq_grupo_w,
                                                null,
                                                null,
                                                'S',
                                                28,
                                                null,
                                                null,
                                                r_exames_lab_default.ie_visivel,
                                                r_exames_lab_default.nr_seq_conf_info,
                                                r_exames_lab_default.nr_seq_lab_test,
                                                r_secao.ie_tipo_agrupamento,
                                                r_exames_lab_default.ds_caminho_imagem);
        end loop;
    when 'DV' then
    <<read_dispositivos>>
      for r_dispositivos in c_dispositivos(r_secao.nr_sequencia, r_secao.nr_seq_config) loop
        select nextval('w_flowsheet_cirurgia_info_seq')
          into STRICT nr_seq_info_w
;

            w_ds_tooltip := '<p><b>' || r_dispositivos.name || '</b></p>';
            if (r_dispositivos.ds_topografia IS NOT NULL AND r_dispositivos.ds_topografia::text <> '') then
              w_ds_tooltip := w_ds_tooltip || '<p><b>' || wheb_mensagem_pck.get_texto(766907) || ': </b>'; --topografia
              w_ds_tooltip := w_ds_tooltip || r_dispositivos.ds_topografia || '</p>';
            end if;
            if (r_dispositivos.ds_lado IS NOT NULL AND r_dispositivos.ds_lado::text <> '') then
              w_ds_tooltip := w_ds_tooltip || '<p><b>' || wheb_mensagem_pck.get_texto(309129) || ': </b>'; --lado
              w_ds_tooltip := w_ds_tooltip || r_dispositivos.ds_lado || '</p>';
            end if;

            if (r_dispositivos.dt_instalacao IS NOT NULL AND r_dispositivos.dt_instalacao::text <> '') then
              w_ds_tooltip := w_ds_tooltip || '<p><b>' || wheb_mensagem_pck.get_texto(309131) || ': </b>';  --instalado em
              w_ds_tooltip := w_ds_tooltip || r_dispositivos.dt_instalacao;
                            w_ds_tooltip := w_ds_tooltip || ' ' || obter_desc_expressao(296059, null) || ' ';
                            w_ds_tooltip := w_ds_tooltip || r_dispositivos.nm_pessoa || '</p>';
            end if;

            if ((r_dispositivos.dt_retirada_prev IS NOT NULL AND r_dispositivos.dt_retirada_prev::text <> '') and coalesce(r_dispositivos.dt_retirada::text, '') = '') then
              w_ds_tooltip := w_ds_tooltip || '<p><b>' || wheb_mensagem_pck.get_texto(309137) || ': </b>';  --Periodo validade
              w_ds_tooltip := w_ds_tooltip || r_dispositivos.dt_retirada_prev || '</p>';
            end if;

            if (r_dispositivos.ds_setor IS NOT NULL AND r_dispositivos.ds_setor::text <> '') then
              w_ds_tooltip := w_ds_tooltip || '<p><b>' || wheb_mensagem_pck.get_texto(309136) || ': </b>'; --setor
              w_ds_tooltip := w_ds_tooltip || r_dispositivos.ds_setor || '</p>';
            end if;
            if (r_dispositivos.ds_calibre IS NOT NULL AND r_dispositivos.ds_calibre::text <> '') then
              w_ds_tooltip := w_ds_tooltip || '<p><b>' || wheb_mensagem_pck.get_texto(309140) || ': </b>'; --calibre
              w_ds_tooltip := w_ds_tooltip || r_dispositivos.ds_calibre || '</p>';
            end if;

            ie_image_legend_w:=null;
            if (coalesce(r_dispositivos.dt_retirada::text, '') = ''
            and (r_dispositivos.dt_retirada_prevista IS NOT NULL AND r_dispositivos.dt_retirada_prevista::text <> '')
            and r_dispositivos.dt_retirada_prevista > clock_timestamp()
            and r_dispositivos.dt_retirada_prevista < r_dispositivos.dt_comparacao) then
              ie_image_legend_w:= 'assets/icons/status-and-feedback/intravenous-clock-yellow.svg';
            elsif ((r_dispositivos.dt_alta IS NOT NULL AND r_dispositivos.dt_alta::text <> '')
            and r_dispositivos.ie_disp_alta = 'S') then
              ie_image_legend_w:= 'assets/icons/status-and-feedback/intravenous-arrow-up.svg';
            elsif (r_dispositivos.ie_sucesso = 'N') then
              ie_image_legend_w:= 'assets/icons/status-and-feedback/intravenous-cancel.svg';
            elsif (coalesce(r_dispositivos.dt_retirada::text, '') = ''
            and coalesce(r_dispositivos.dt_alta::text, '') = ''
            and (r_dispositivos.dt_retirada_prevista IS NOT NULL AND r_dispositivos.dt_retirada_prevista::text <> '')
            and r_dispositivos.dt_retirada_prevista < clock_timestamp()) then
              ie_image_legend_w:= 'assets/icons/status-and-feedback/intravenous-minor-warning.svg';
            elsif (r_dispositivos.dt_retirada IS NOT NULL AND r_dispositivos.dt_retirada::text <> '') then
              ie_image_legend_w:= 'assets/icons/status-and-feedback/intravenous-circle.svg';
            elsif ((coalesce(r_dispositivos.dt_retirada::text, '') = ''
            and  coalesce(r_dispositivos.dt_retirada_prevista::text, '') = '')
            or (coalesce(r_dispositivos.dt_retirada::text, '') = ''
            and  r_dispositivos.dt_retirada_prevista > clock_timestamp())) then
              ie_image_legend_w:= 'assets/icons/status-and-feedback/intravenous-partial.svg';
            end if;

                        insert into w_flowsheet_cirurgia_info(nr_sequencia,
                                                  dt_atualizacao,
                                                  nm_usuario,
                                                  dt_atualizacao_nrec,
                                                  nm_usuario_nrec,
                                                  ds_informacao,
                                                  ds_informacao_complementar,
                                                  nr_seq_apresentacao,
                                                  nm_tabela,
                                                  nm_atributo,
                                                  nr_seq_grupo,
                                                  ds_material,
                                                  ds_unidade_medida,
                                                  ie_temporario,
                                                  nr_altura,
                                                  nr_seq_result_item,
                                                  nr_seq_resultado,
                                                  ie_visivel,
                                                  nr_seq_conf_info,
                                                  nr_seq_exame,
                          nr_seq_dispositivo,
                                                  ie_tipo_agrupamento,
                          ds_tooltip,
                          ie_image_legend,
                          ds_caminho_imagem
                                                 )
            values (nr_seq_info_w,
                                                clock_timestamp(),
                                                wheb_usuario_pck.get_nm_usuario,
                                                clock_timestamp(),
                                                wheb_usuario_pck.get_nm_usuario,
                                                substr(r_dispositivos.name,0,100),
                                                null,
                                                0,
                                                r_dispositivos.nm_tabela,
                                                'IC_DEVICE_' || nr_seq_info_w,
                                                nr_seq_grupo_w,
                                                null,
                                                null,
                                                'S',
                                                28,
                                                null,
                                                null,
                                                r_dispositivos.ie_visivel,
                                                r_dispositivos.nr_seq_conf_info,
                                                null,
                        r_dispositivos.nr_seq_dispositivo,
                                                r_secao.ie_tipo_agrupamento,
                        w_ds_tooltip,
                        ie_image_legend_w,
                        r_dispositivos.ds_caminho_imagem
                                                );

        device_details(r_dispositivos.nr_sequencia,r_dispositivos.ds_tooltip1);
		
      end loop;
    end case;
    end loop read_secao;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cirurgia_flowsheet ((nr_seq_modelo_p bigint, nr_cirurgia_p bigint, nr_seq_pepo_p bigint, cd_pessoa_fisica_p text) is nr_seq_flowsheet_w bigint) FROM PUBLIC;

