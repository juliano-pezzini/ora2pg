-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cobranca_hsbc_240_reg ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ds_conteudo_w			varchar(240);

/* Header do arquivo */
 
nm_empresa_w			varchar(30);
nm_banco_w			varchar(30);
cd_cgc_w			varchar(14);
cd_agencia_bancaria_w		varchar(6);
dt_remessa_retorno_w		timestamp;
cd_conta_w			varchar(13);
cd_carteira_w			varchar(10);

/* Detalhe */
 
nm_pessoa_w			varchar(40);
ds_endereco_w			varchar(40);
ds_bairro_w			varchar(15);
ds_cidade_w			varchar(15);
nr_inscricao_w			varchar(15);
ds_nosso_numero_w		varchar(15);
vl_titulo_w			varchar(15);
vl_desconto_w			varchar(15);
vl_juros_mora_w			varchar(15);
nr_titulo_w			varchar(16);
cd_cep_w			varchar(8);
dt_emissao_w			varchar(8);
dt_vencimento_w			varchar(8);
ds_uf_w				varchar(2);
ie_tipo_inscricao_w		varchar(1);
cd_convenio_banco_w		banco_estabelecimento.cd_convenio_banco%type;
nr_seq_carteira_cobr_w	cobranca_escritural.nr_seq_carteira_cobr%type;
dt_emissao_bloqueto_w	titulo_receber.dt_emissao_bloqueto%type;

/* Trailer de Lote */
 
vl_titulos_cobr_w		varchar(15);
qt_titulos_cobr_w		integer;
qt_registro_lote_w		smallint	:= 0;

/* Trailer do Arquivo */
 
qt_registro_w			integer	:= 0;
qt_registro_P_w			integer	:= 0;
qt_registro_Q_w			integer	:= 0;

C01 CURSOR FOR 
SELECT	lpad(coalesce(c.cd_agencia_bancaria,'0'),5,'0'), 
	lpad(82||somente_numero(lpad(b.nr_titulo,8,'0')||'-'|| calcula_digito('Modulo11',(82||lpad(b.nr_titulo,8,'0')))),15,'0') ds_nosso_numero, 
	lpad(b.nr_titulo,16,0) nr_titulo, 
	to_char(coalesce(b.dt_pagamento_previsto,clock_timestamp()),'DDMMYYYY') dt_vencimento, 
	lpad(replace(to_char(b.vl_titulo, 'fm0000000000000.00'),'.',''),15,'0') vl_titulo, 
	to_char(coalesce(b.dt_emissao,clock_timestamp()),'DDMMYYYY') dt_emissao, 
	lpad(replace(to_char(b.vl_titulo * b.tx_juros / 100 / 30, 'fm0000000000000.00'),'.',''),15,'0') vl_juros_mora, 
	lpad(replace(to_char(b.TX_DESC_ANTECIPACAO, 'fm0000000000000.00'),'.',''),15,'0') vl_desconto, 
	coalesce(CASE WHEN coalesce(b.cd_pessoa_fisica::text, '') = '' THEN  '2'  ELSE '1' END ,'0') ie_tipo_inscricao, 
	lpad(CASE WHEN CASE WHEN coalesce(b.cd_pessoa_fisica::text, '') = '' THEN  2  ELSE 1 END =2 THEN obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'C') WHEN CASE WHEN coalesce(b.cd_pessoa_fisica::text, '') = '' THEN  2  ELSE 1 END =1 THEN (substr(obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'C'),1,9) || '0000' || substr(obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'C'),10,2))  ELSE '000000000000000' END ,15,'0') nr_inscricao, 
	rpad(substr(coalesce(elimina_caractere_especial(obter_nome_pf_pj(b.cd_pessoa_fisica, b.cd_cgc)),' '),1,40),40,' ') nm_pessoa, 
	rpad(substr(coalesce(elimina_caractere_especial(pls_obter_compl_pagador(d.nr_seq_pagador,'E')),' '),1,38),38,' ') ds_endereco, 
	rpad(substr(coalesce(elimina_caractere_especial(pls_obter_compl_pagador(d.nr_seq_pagador,'B')),' '),1,15),15,' ') ds_bairro, 
	lpad(substr(coalesce(elimina_caractere_especial(pls_obter_compl_pagador(d.nr_seq_pagador,'CEP')),' '),1,8),8,'0') cd_cep, 
	rpad(substr(coalesce(elimina_caractere_especial(pls_obter_compl_pagador(d.nr_seq_pagador,'CI')),' '),1,15),15,' ') ds_cidade, 
	rpad(substr(coalesce(elimina_caractere_especial(pls_obter_compl_pagador(d.nr_seq_pagador,'UF')),' '),1,2),2,' ') ds_uf, 
	to_char(coalesce(dt_emissao_bloqueto, clock_timestamp()),'DDMMYYYY') dt_emissao_bloqueto 
FROM titulo_receber_cobr c, cobranca_escritural a, titulo_receber b
LEFT OUTER JOIN pls_mensalidade d ON (b.nr_seq_mensalidade = d.nr_sequencia)
WHERE a.nr_sequencia		= c.nr_seq_cobranca and c.nr_titulo		= b.nr_titulo  and a.nr_sequencia		= nr_seq_cobr_escrit_p;
	

BEGIN 
 
delete	from w_envio_banco 
where	nm_usuario	= nm_usuario_p;
 
/* Header do Arquivo */
 
 
select	lpad(b.cd_cgc,14,'0'), 
	lpad(coalesce(c.cd_agencia_bancaria,'0'),6,'0') cd_agencia_bancaria, 
	lpad(coalesce(c.cd_conta,'0'),12,'0') || lpad(coalesce(c.ie_digito_conta,'0'),1,'0') cd_conta, 
	rpad(substr(coalesce(elimina_caractere_especial(obter_razao_social(b.cd_cgc)),' '),1,30),30,' ') nm_empresa, 
	rpad('BANCO HSBC SA', 30, ' ') nm_banco, 
	coalesce(a.dt_remessa_retorno,clock_timestamp()), 
	substr(coalesce(c.cd_carteira,'0'),1,1) cd_carteira, 
	c.cd_convenio_banco, 
	a.nr_seq_carteira_cobr 
into STRICT	cd_cgc_w, 
	cd_agencia_bancaria_w, 
	cd_conta_w, 
	nm_empresa_w, 
	nm_banco_w, 
	dt_remessa_retorno_w, 
	cd_carteira_w, 
	cd_convenio_banco_w, 
	nr_seq_carteira_cobr_w 
from banco_estabelecimento c, 
	estabelecimento b, 
	cobranca_escritural a 
where	a.cd_estabelecimento	= b.cd_estabelecimento 
and	a.nr_seq_conta_banco	= c.nr_sequencia 
and	a.nr_sequencia		= nr_seq_cobr_escrit_p;
 
qt_registro_w	:= qt_registro_w + 1;
 
ds_conteudo_w	:= 	'399' || 
			'0000' || 
			'0' || 
			rpad(' ',9,' ') || 
			'2' || -- TIPO DE INSCRIÇÃO DA EMPRESA 
			cd_cgc_w || -- Nº DE INSCRIÇÃO DA EMPRESA 
			'COB'|| --Verificar 20 
			'CNAB' || 
			lpad(coalesce(nr_seq_carteira_cobr_w,cd_convenio_banco_w),13,'0') || -- CODIGO CONTRATO COB/DESC 13		 
			cd_agencia_bancaria_w || 
			cd_conta_w || 
			'0' || 
			nm_empresa_w || -- NOME DA EMPRESA 
			nm_banco_w || -- NOME DO BANCO 
			rpad(' ',10,' ') || -- USO EXCLUSIVO FEBRABAN/CNAB 
			'1' || -- CÓDIGO REMESSA / RETORNO --- fixo retorno 
			lpad(to_char(dt_remessa_retorno_w,'DDMMYYYY'),8,'0') || 
			lpad(to_char(dt_remessa_retorno_w,'hh24miss'),6,'0') || 
			'000000' || 
			'010' || --Nº DA VERSÃO DO LAYOUT ARQUIVO 
			'00000' || -- DENSIDADE DE GRAVAÇÃO DO ARQUIVO 
			'S' || --ENVIO PARA CART COBRANÇA SIMPLES 
			rpad(' ',11,' ') || -- NUM CONTRATO LIMITE 
			'S' || -- LIBERACAO AUTOMATICA OPER.DESC. 
			rpad(' ',7,' ') || -- PARA USO RESERVADO DO BANCO 
			rpad(' ',20,' ') || -- PARA USO RESERVADO DA EMPRESA 
			rpad(' ',29,' '); --USO EXCLUSIVO FEBRABAN/CNAB 
					
 
insert	into w_envio_banco(cd_estabelecimento, 
	ds_conteudo, 
	dt_atualizacao, 
	dt_atualizacao_nrec, 
	nm_usuario, 
	nm_usuario_nrec, 
	nr_sequencia) 
values (cd_estabelecimento_p, 
	ds_conteudo_w, 
	clock_timestamp(), 
	clock_timestamp(), 
	nm_usuario_p, 
	nm_usuario_p, 
	nextval('w_envio_banco_seq'));
 
/*	Header do Lote	*/
 
 
qt_registro_lote_w	:= qt_registro_lote_w + 1;
qt_registro_w		:= qt_registro_w + 1;
 
ds_conteudo_w		:= 	'399' || -- CÓDIGO DO BANCO NA COMPENSAÇÃO 
				lpad(qt_registro_lote_w,4,'0') || -- LOTE DE SERVIÇO 
				'1' || -- REGISTRO HEADER DE LOTE 
				'T' || -- TIPO DE OPERAÇÃO 
				'01' || --TIPO DE SERVIÇO 
				'00' || --FORMA DE LANÇAMENTO 
				'010' || --Nº DA VERSÃO DO LAYOUT DO LOTE 
				' ' || --USO EXCLUSIVO FEBRABAN/CNAB 
				'2' || --TIPO DE INSCRIÇÃO DA EMPRESA 
				lpad(cd_cgc_w,15,'0') || --Nº DE INSCRIÇÃO DA EMPRESA 
				'COB' || -- CÓDIGO DO APLICATIVO NO BANCO 
				rpad(' ',4,' ') || 
				'0000000000000' || 
				cd_agencia_bancaria_w || -- AGÊNCIA MANTENEDORA DA CONTA 
				cd_conta_w || --NÚMERO DA CONTA CORRENTE 
				'0' || -- DÍGITO VERIFICADOR DA AG/CONTA 
				nm_empresa_w || -- NOME DA EMPRESA 
				rpad(' ',80,' ') || --MENSAGEM 1 e 2 
				'00000001' || --NÚMERO REMESSA/RETORNO 
				to_char(dt_remessa_retorno_w,'DDMMYYYY') || --DATA DE GRAVAÇÃO REMESSA/RETORNO 
				to_char(dt_remessa_retorno_w,'DDMMYYYY') || --DATA DO CRÉDITO 
				rpad(' ',33,' ');
 
insert	into w_envio_banco(cd_estabelecimento, 
	ds_conteudo, 
	dt_atualizacao, 
	dt_atualizacao_nrec, 
	nm_usuario, 
	nm_usuario_nrec, 
	nr_sequencia) 
values (cd_estabelecimento_p, 
	ds_conteudo_w, 
	clock_timestamp(), 
	clock_timestamp(), 
	nm_usuario_p, 
	nm_usuario_p, 
	nextval('w_envio_banco_seq'));
				 
/* Segmento P, SegmentoQ */
 
 
open	C01;
loop 
fetch	C01 into 
	cd_agencia_bancaria_w, 
	ds_nosso_numero_w, 
	nr_titulo_w, 
	dt_vencimento_w, 
	vl_titulo_w, 
	dt_emissao_w, 
	vl_juros_mora_w, 
	vl_desconto_w, 
	ie_tipo_inscricao_w, 
	nr_inscricao_w, 
	nm_pessoa_w, 
	ds_endereco_w, 
	ds_bairro_w, 
	cd_cep_w, 
	ds_cidade_w, 
	ds_uf_w, 
	dt_emissao_bloqueto_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
 
	/* Segmento P */
 
 
	qt_registro_w		:= qt_registro_w + 1;
	qt_registro_P_w		:= qt_registro_P_w + 1;
 
	ds_conteudo_w		:=	'399' || -- CÓDIGO DO BANCO NA COMPENSAÇÃO 
					lpad(qt_registro_lote_w,4,'0') || --LOTE DE SERVIÇO 
					'3' || --TIPO DE REGISTRO 
					lpad(qt_registro_P_w,5,'0') || --Nº SEQUENCIAL DO REGISTRO NO LOTE 
					'P' || --CÓD. SEGMENTO DO REGISTRO DETALHE 
					' ' || --USO EXCLUSIVO DA FEBRABAN/CNAB 
					'01' || --CÓDIGO DE MOVIMENTO 
					cd_agencia_bancaria_w || --AGÊNCIA MANTENEDORA DA CONTA 6 
					cd_conta_w || --NÚMERO DA CONTA CORRENTE 13 
					'0' || 
					nr_titulo_w ||--IDENTIFICAÇÃO DO BOLETO NO BANCO 
					rpad(' ',4,' ') || 
					cd_carteira_w || --CÓDIGO DA CARTEIRA 
					'1' || --COM CADASTRAMENTO 
					'2' || --ESCRITURAL 
					'9' || --Banco Emite (Boleto Auto-Envelopado) 
					'1' || --BANCO DISTRIBUI 
					rpad(' ',15,' ') || --NÚMERO DO DOCUMENTO DE COBRANÇA 
					dt_vencimento_w || --DATA DO VENCIMENTO DO BOLETO 
					vl_titulo_w || --VALOR NOMINAL DO BOLETO 
					cd_agencia_bancaria_w || --AGÊNCIA COBRADORA/RECEBEDORA 6 
					'04' || --ESPÉCIE DO BOLETO 
					'A' || 
					dt_emissao_bloqueto_w|| 
					'1'|| 
					to_char(clock_timestamp(),'DDMMYYYY')|| 
					vl_juros_mora_w|| -- 15 
					'1'|| 
					to_char(clock_timestamp(),'DDMMYYYY') || 
					vl_desconto_w || --15 
					'000000000000000' || --15 
					vl_titulo_w|| --15 
					rpad(' ',25,' ') || --IDENTIF. DO BOLETO NA EMPRESA 
					'3' || --Não protestar 
					'00' || --NÚMERO DE DIAS PARA PROTESTO E SERASA 
					'1' || --BAIXAR/DEVOLVER 
					'000' || 
					'09' || --CÓDIGO DA MOEDA 
					'0000000000' || --N. DO CONTR. DA OPERAÇÃO DE CRÉD. 10 
					' '; --USO EXCLUSIVO FEBRABAN/CNAB 
	insert	into w_envio_banco(cd_estabelecimento, 
		ds_conteudo, 
		dt_atualizacao, 
		dt_atualizacao_nrec, 
		nm_usuario, 
		nm_usuario_nrec, 
		nr_sequencia) 
	values (cd_estabelecimento_p, 
		ds_conteudo_w, 
		clock_timestamp(), 
		clock_timestamp(), 
		nm_usuario_p, 
		nm_usuario_p, 
		nextval('w_envio_banco_seq'));
 
	/* Segmento Q */
 
 
	qt_registro_w		:= qt_registro_w + 1;
	qt_registro_P_w		:= qt_registro_P_w + 1;
	 
	ds_conteudo_w		:=	'399' || --CÓDIGO DO BANCO NA COMPENSAÇÃO 
					lpad(qt_registro_lote_w, 4, '0') || --LOTE DE SERVIÇO 
					'3' || --REGISTRO DETALHE 
					lpad(qt_registro_P_w, 5, '0') || --Nº SEQUENCIAL DO REGISTRO NO LOTE 
					'Q' || --CÓD. SEGMENTO DO REGISTRO DETALHE 
					' ' || --USO EXCLUSIVO DA FEBRABAN/CNAB 
					'06' || --CÓDIGO DE MOVIMENTO 
					ie_tipo_inscricao_w || 
					nr_inscricao_w|| 
					nm_pessoa_w|| 
					ds_endereco_w|| 
					' '|| 
					ds_bairro_w|| 
					cd_cep_w|| 
					ds_cidade_w|| 
					ds_uf_w|| 
					ie_tipo_inscricao_w|| 
					nr_inscricao_w|| 
					rpad(' ',71,' ');
 
 
	insert	into w_envio_banco(cd_estabelecimento, 
		ds_conteudo, 
		dt_atualizacao, 
		dt_atualizacao_nrec, 
		nm_usuario, 
		nm_usuario_nrec, 
		nr_sequencia) 
	values (cd_estabelecimento_p, 
		ds_conteudo_w, 
		clock_timestamp(), 
		clock_timestamp(), 
		nm_usuario_p, 
		nm_usuario_p, 
		nextval('w_envio_banco_seq'));
 
end	loop;
close	C01;
 
/*	Trailer de Lote	*/
 
 
select	lpad(count(1),6,'0'), 
	replace(to_char(sum(c.vl_titulo), 'fm0000000000000.00'),'.','') 
into STRICT	qt_titulos_cobr_w, 
	vl_titulos_cobr_w 
from	titulo_receber c, 
	titulo_receber_cobr b, 
	cobranca_escritural a 
where	b.nr_titulo	= c.nr_titulo 
and	a.nr_sequencia	= b.nr_seq_cobranca 
and	a.nr_sequencia	= nr_seq_cobr_escrit_p;
 
qt_registro_lote_w	:= qt_registro_lote_w + 1;
 
ds_conteudo_w		:=	'399' || 
				'0001' || 
				'5' || 
				rpad(' ',9,' ') || 
				lpad(qt_registro_w,6,'0') || 
				lpad(qt_titulos_cobr_w,6,'0') || 
				lpad(vl_titulos_cobr_w,17,'0') || 
				'000000' || 
				'00000000000000000' || 
				'000000' || 
				'00000000000000000' || 
				'000000' || 
				'00000000000000000' || 
				rpad(' ',8,' ') || 
				rpad(' ',117,' ');
 
qt_registro_w		:= qt_registro_w + 1;
 
insert	into w_envio_banco(cd_estabelecimento, 
	ds_conteudo, 
	dt_atualizacao, 
	dt_atualizacao_nrec, 
	nm_usuario, 
	nm_usuario_nrec, 
	nr_sequencia) 
values (cd_estabelecimento_p, 
	ds_conteudo_w, 
	clock_timestamp(), 
	clock_timestamp(), 
	nm_usuario_p, 
	nm_usuario_p, 
	nextval('w_envio_banco_seq'));
 
/* Trailer do Arquivo */
 
 
qt_registro_w	:= qt_registro_w + 1;
 
ds_conteudo_w	:=	'399' || 
			'9999' || 
			'9' || 
			rpad(' ',9,' ') || 
			'000001' || 
			lpad(qt_registro_w,6,'0') || 
			'000000' || 
			rpad(' ',205,' ');
 
insert	into w_envio_banco(cd_estabelecimento, 
	ds_conteudo, 
	dt_atualizacao, 
	dt_atualizacao_nrec, 
	nm_usuario, 
	nm_usuario_nrec, 
	nr_sequencia) 
values (cd_estabelecimento_p, 
	ds_conteudo_w, 
	clock_timestamp(), 
	clock_timestamp(), 
	nm_usuario_p, 
	nm_usuario_p, 
	nextval('w_envio_banco_seq'));
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cobranca_hsbc_240_reg ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

