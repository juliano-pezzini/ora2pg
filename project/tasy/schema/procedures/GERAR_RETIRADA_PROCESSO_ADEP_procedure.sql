-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_retirada_processo_adep ( nr_seq_processo_p bigint, ie_retirar_p text, cd_pessoa_fisica_p text, nm_usuario_p text) AS $body$
DECLARE


dt_processo_w			timestamp;
dt_dispensacao_w		timestamp;
ie_status_processo_w	varchar(15);


BEGIN
if (nr_seq_processo_p IS NOT NULL AND nr_seq_processo_p::text <> '') and (ie_retirar_p IS NOT NULL AND ie_retirar_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then

	if (ie_retirar_p = 'S') then

		if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
			update	adep_processo
			set		dt_retirada			= clock_timestamp(),
					nm_usuario_retirada	= nm_usuario_p,
					cd_pessoa_retirada	= cd_pessoa_fisica_p,
					nm_usuario			= nm_usuario_p
			where	nr_sequencia		= nr_seq_processo_p;
		else
			---É necessário informar a pessoa responsável pela retirada do processo da farmácia. Favor verificar!
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(261485);
		end if;

	elsif (ie_retirar_p = 'N') then

		select	max(dt_processo),
				max(dt_dispensacao)
		into STRICT	dt_processo_w,
				dt_dispensacao_w
		from	adep_processo
		where	nr_sequencia		= nr_seq_processo_p;

		if (dt_dispensacao_w IS NOT NULL AND dt_dispensacao_w::text <> '') then
			ie_status_processo_w	:= 'D';
		else
			ie_status_processo_w	:= 'G';
		end if;

		update	adep_processo
		set		dt_retirada			 = NULL,
				nm_usuario_retirada	 = NULL,
				cd_pessoa_retirada	 = NULL,
				ie_status_processo	= ie_status_processo_w,
				nm_usuario			= nm_usuario_p
		where	nr_sequencia		= nr_seq_processo_p;

	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_retirada_processo_adep ( nr_seq_processo_p bigint, ie_retirar_p text, cd_pessoa_fisica_p text, nm_usuario_p text) FROM PUBLIC;

