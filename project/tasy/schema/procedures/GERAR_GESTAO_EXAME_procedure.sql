-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_gestao_exame ( cd_estabelecimento_p bigint, cd_perfil_p bigint, cd_setor_atendimento_p bigint, cd_setor_prescricao_p bigint, ie_status_execucao_p text, ie_status_exec_p text, ie_data_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, nr_prescricao_p bigint, nr_atendimento_p bigint, cd_paciente_p text, cd_prescritor_p text, cd_executor_prev_p text, cd_executor_p text, cd_laudante_p text, cd_medico_prev_laudo_p text, cd_motivo_baixa_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_proc_interno_p bigint, nr_protocolo_p bigint, nr_exame_p text, nm_ditador_p text, ie_somente_pendente_p text, ie_somente_antecipado_p text, ie_somente_com_exame_p text, ie_laudo_normal_p text, ie_somente_sem_alta_p text, ie_somente_com_alta_p text, ie_somente_setor_p text, ie_somente_lib_p text, ie_somente_suspensos_p text, ie_somente_justif_baixa_p text, ie_exame_complementar_p text, ie_exige_lib_enf_p text, cd_tipo_proced_padrao_p text, cd_tipo_proced_filtro_p bigint, nr_acesso_dicom_p text, ie_opcao_setor_p text, ds_filtros_p text, ds_filtros_geral_p text, ie_exige_lib_tecnica_p text, nm_usuario_p text, ie_status_patologia_p text, ie_somente_com_exames_p text, ie_proced_bloqueado_p text, ie_somente_cancelados_p text, ie_status_ind_comple_p text, ie_nome_interno_p text, ie_acm_sn_aprazado_p text, ie_somente_proc_anest_p text, ie_somente_setor_classif_pa_p text, cd_conv_nome_interno_p text, nr_exame_lote_p bigint, ie_aprovacao_execucao_p text, ie_agrupa_patologia_conta_p text, cg_cgc_laboratorio_p text, ie_exibe_libera_autorizacao_p text, ie_resp_seg_aprov_p text, ie_somente_nao_cancelados_p text, ie_exibe_nao_lib_setor_p text, ie_exibe_refazer_exame_p text, ie_exibe_agendamento_ageint_p text, ie_somente_mat_medic_assoc_p text, ie_somente_beira_leito_p text, ie_tumor_p text) is ds_sep_bv_w varchar(50) RETURNS varchar AS $body$
BEGIN
        dt_inicial_v  := to_char(dt_inicial_,'dd/mm/yyyy hh24:mi:ss');
        dt_final_v    := to_char(dt_final_,'dd/mm/yyyy hh24:mi:ss');

return 'to_date('''||dt_inicial_v||''',''dd/mm/yyyy hh24:mi:ss'') and to_date('''||dt_final_v||''',''dd/mm/yyyy hh24:mi:ss'')';
end;

begin
/*
exec Gerar_Gestao_Exame(1,1889,0,0,'','N','0',SYSDATE - 100,SYSDATE,0,0,'','','','','',0,0,0,0,0,0,'','S','N','N','N','S','S','S','N','','P','','','Edilson')
*/
ds_sep_bv_w  := obter_separador_bv;
--insert into temp values (sysdate,1);
CALL exec_sql_dinamico(nm_usuario_p,'truncate table w_gestao_exame');
CALL exec_sql_dinamico(nm_usuario_p,'truncate table w_ge_temp');

--insert into temp values (sysdate,2);
ds_regra_wcpanel_w := obter_regra_atributo_wcpanel(9457,cd_perfil_p,nm_usuario_p);

while(ds_regra_wcpanel_w IS NOT NULL AND ds_regra_wcpanel_w::text <> '') loop
  begin
  nr_pos_sep_w    := position(';' in ds_regra_wcpanel_w);
  ds_regra_atributo_w  := substr(ds_regra_wcpanel_w,1,nr_pos_sep_w-1);
  ds_regra_wcpanel_w  := replace(ds_regra_wcpanel_w, ds_regra_atributo_w||';', '');
  nr_pos_sep_w    := position('=' in ds_regra_atributo_w);
  nr_seq_atributo_w  := (substr(ds_regra_atributo_w,1,nr_pos_sep_w-1))::numeric;
  ie_atributo_w    := substr(ds_regra_atributo_w,nr_pos_sep_w+1,1);

  if (nr_seq_atributo_w = 9853) then
    ie_medico_prev_exec_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9854) then
    ie_medico_executor_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 12053) then
    ie_medico_prescritor_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9855) then
    ie_medico_laudo_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9856) then
    ie_autorizacao_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9857) then
    ie_motivo_parada_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9858) then
    ie_autoriz_senha_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9859) then
    ie_setor_atendimento_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9860) then
    ie_motivo_baixa_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9861) then
    ie_setor_paciente_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9862) then
    ie_arquivo_ditado_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9863) then
    ie_laudo_ant_w    := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9864) then
    ie_dt_ditado_w    := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9865) then
    ie_procedencia_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9866) then
    ie_inicio_agenda_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9867) then
    ie_inicio_agenda_atend_w:= ie_atributo_w;
  elsif (nr_seq_atributo_w = 9868) then
    ie_lado_proced_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9869) then
    ie_mat_med_w    := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9870) then
    ie_mat_med_setor_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9871) then
    ie_tipo_atend_w    := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9872) then
    ie_idade_w    := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9873) then
    ie_nascimento_w    := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9874) then
    ie_convenio_w    := ie_atributo_w;
/*  elsif  (nr_seq_atributo_w = ) then
    ie_usuario_convenio_w  := ie_atributo_w;
  elsif  (nr_seq_atributo_w = ) then
    ie_nr_crm_w    := ie_atributo_w;
  elsif  (nr_seq_atributo_w = ) then
    ie_uf_medico_w    := ie_atributo_w;
  elsif  (nr_seq_atributo_w = ) then
    ie_senha_laudo_medico_w  := ie_atributo_w;*/
  elsif (nr_seq_atributo_w = 13125) then
    ie_local_breve_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9879) then
    ie_local_paciente_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9880) then
    ie_obs_proced_w    := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9881) then
    ie_qt_prescrito_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9882) then
    ie_qt_liberado_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9883) then
    ie_qt_exame_w    := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9884) then
    ie_status_agenda_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9885) then
    ie_exame_lab_w    := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9886) then
    ie_material_exame_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9887) then
    ie_func_executor_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9888) then
    ie_motivo_ant_w    := ie_atributo_w;
/*  elsif  (nr_seq_atributo_w = ) then
    ie_acesso_dicom_w  := ie_atributo_w;*/
  elsif (nr_seq_atributo_w = 9890) then
    ie_usuario_ditado_w  := ie_atributo_w;
/*  elsif  (nr_seq_atributo_w = ) then
    ie_breve_local_w  := ie_atributo_w;
  elsif  (nr_seq_atributo_w = ) then
    ie_email_medico_prescr_w:= ie_atributo_w;*/
  elsif (nr_seq_atributo_w = 9892) then
    ie_anestesista_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9893) then
    ie_contraste_w    := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9894) then
    ie_intervalo_w    := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9895) then
    ie_prof_previsto_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9896) then
    ie_tipo_isolamento_cih_w:= ie_atributo_w;
/*  elsif  (nr_seq_atributo_w = ) then
    ie_cor_isolamento_cih_w  := ie_atributo_w;
  elsif  (nr_seq_atributo_w = ) then
    ie_exame_cancelado_w  := ie_atributo_w;
  elsif  (nr_seq_atributo_w = ) then
    ie_seq_tipo_isolamento_cih_w  := ie_atributo_w;*/
  elsif (nr_seq_atributo_w = 9900) then
    ie_ds_proced_conta_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 9901) then
    ie_cd_proced_conta_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 12056) then
    ie_solic_externa_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 23242) then
    ie_ds_localizacao_laudo_w := ie_atributo_w;
  elsif (nr_seq_atributo_w = 39231) then
    ie_possui_hist_w := ie_atributo_w;
  elsif (nr_seq_atributo_w = 54504) then
    ie_dt_impressao_imagem_w := ie_atributo_w;
  elsif (nr_seq_atributo_w = 66246) then
    ie_ie_solicitacao_exame_w := ie_atributo_w;
  elsif (nr_seq_atributo_w = 69402) then
    ie_dt_alta_w := ie_atributo_w;
  elsif (nr_seq_atributo_w = 91969) then
    ie_nr_crm_prescrito_w := ie_atributo_w;
  elsif (nr_seq_atributo_w = 104033) then
    ie_nm_usu_lib_pat_w := ie_atributo_w;
  elsif (nr_seq_atributo_w = 104034) then
    ie_dt_usu_lib_pat_w := ie_atributo_w;
  elsif (nr_seq_atributo_w = 23103) then
    ie_ie_subamostra_exec_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 30796) then
    ie_ds_setor_local_w := ie_atributo_w;
  elsif (nr_seq_atributo_w = 31533) then
    ie_nr_reserva_w := ie_atributo_w;
  elsif (nr_seq_atributo_w = 31534) then
    ie_nr_transfusao_w := ie_atributo_w;
  elsif (nr_seq_atributo_w = 107494) then
    ie_ds_peca_principal_w := ie_atributo_w;
  elsif (nr_seq_atributo_w = 120775) then
    ie_medico_laudo_reg_w := ie_atributo_w;
  elsif (nr_seq_atributo_w = 183256) then
    ie_pago_ww := ie_atributo_w;
  elsif (nr_seq_atributo_w = 194569) then
    ie_ds_motivo_atraso_w := ie_atributo_w;
  elsif (nr_seq_atributo_w = 195841) then
    ie_ds_obs_agenda_w := ie_atributo_w;
  elsif (nr_seq_atributo_w = 198127) then
    ie_possui_evento_ww := ie_atributo_w;
  elsif (nr_seq_atributo_w = 198594) then
    ie_ds_contraste_conta_w := ie_atributo_w;
  elsif (nr_seq_atributo_w = 198595) then
    ie_qt_filme_w := ie_atributo_w;
  elsif (nr_seq_atributo_w = 198666) then
    ie_pessoa_entrega_imagem_w := ie_atributo_w;
  elsif (nr_seq_atributo_w = 203412) then
    ie_nr_prioridade_triagem_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 224480) then
    ie_ds_profissional_pref_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 245356) then
    ie_ds_status_sr_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 245357) then
    ie_dt_status_sr_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 246743) then
    ie_dt_hora_agenda_w  := ie_atributo_w;
  elsif (nr_seq_atributo_w = 257980) then
    ie_ds_categoria_convenio_w := ie_atributo_w;
  elsif (nr_seq_atributo_w = 265466) then
    ie_senha_fila_w := ie_atributo_w;
  elsif (nr_seq_atributo_w = 246743) then
    ie_dt_solicit_w := ie_atributo_w;
  end if;
  end;
end loop;
--insert into temp values (sysdate,3);
ds_setores_pacs_w := Obter_Param_Usuario(942, 385, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ds_setores_pacs_w);
ie_filtro_data_W := Obter_Param_Usuario(942, 389, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_filtro_data_W);
ds_gerar_prioridade_w := Obter_Param_Usuario(942, 439, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ds_gerar_prioridade_w);

ds_comando_w  :=
'insert into w_ge_temp(
 nr_prescricao,
 nr_atendimento,
 cd_procedimento,
 ie_origem_proced,
 cd_setor_atendimento,
 ie_status_execucao,
 cd_medico_exec,
 nr_seq_interno,
 nr_sequencia,
 cd_medico,
 dt_liberacao,
 dt_prescricao,
 nr_seq_agenda,
 cd_pessoa_fisica,
 ie_autorizacao,
 nr_seq_proc_interno,
 cd_motivo_baixa,
 ie_lado,
 cd_convenio,
 dt_inicio_exame,
 dt_baixa,
 nr_seq_exame,
 cd_material_exame,
 nr_seq_motivo_antecipacao,
 nr_seq_contraste,
 cd_intervalo,
 cd_profissional,
 ds_material_especial,
 dt_cancelamento,
 nr_doc_convenio,
 dt_entrega,
 ie_recem_nato,
 dt_liberacao_medico,
 cd_estabelecimento_prescricao,
 nr_seq_pepo,
 qt_peso,
 nm_usuario_prescr_medica,
 nm_usuario_origin_prescr,
 nr_seq_locate,
 nr_controle,
 ds_dado_clinico,
 cd_categoria,
 ds_forma_entrega_laudo,
 ds_cor_entrega_laudo,
 ds_exame_anterior,
 nr_seq_prioridade,
 nr_seq_mot_anteci_result,
 DT_SOL_ANTECIP_RES)
select a.nr_prescricao,
 a.nr_atendimento,
 b.cd_procedimento,
 b.ie_origem_proced,
 nvl(b.cd_setor_atendimento,nvl(a.cd_setor_entrega, a.cd_setor_atendimento)),
 b.ie_status_execucao,
 b.cd_medico_exec,
 b.nr_seq_interno,
 b.nr_sequencia,
 a.cd_medico,
 a.dt_liberacao,
 a.dt_prescricao,
 a.nr_seq_agenda,
 a.cd_pessoa_fisica,
 b.ie_autorizacao,
 b.nr_seq_proc_interno,
 b.cd_motivo_baixa,
 b.ie_lado,
 b.cd_convenio,
 b.dt_inicio_exame,
 b.dt_baixa,
 b.nr_seq_exame,
 b.cd_material_exame,
 b.nr_seq_motivo_antecipacao,
 b.nr_seq_contraste,
 b.cd_intervalo,
 b.cd_profissional,
 b.ds_material_especial,
 b.dt_cancelamento,
 b.nr_doc_convenio,
 a.dt_entrega,
 a.ie_recem_nato,
 a.dt_liberacao_medico,
 a.cd_estabelecimento,
 a.nr_seq_pepo,
 a.qt_peso,
 a.nm_usuario,
 a.nm_usuario_original,
 a.nr_prescricao||b.nr_sequencia nr_seq_locate,
 NVL(b.nr_controle_ext,a.nr_controle) nr_controle,
 SUBSTR(nvl(b.ds_dado_clinico,a.ds_dado_clinico),1,255) ds_dado_clinico,
 SUBSTR(Obter_Categoria_Atendimento(a.nr_atendimento),1,80) cd_categoria,
 fel.ds_forma ds_forma_entrega_laudo,
 fel.ds_cor ds_cor_entrega_laudo,
 SUBSTR(a.ds_exame_anterior,1,255) ds_exame_anterior,
 b.nr_seq_prioridade,
 b.nr_seq_mot_anteci_result,
 b.DT_SOL_ANTECIP_RES
from prescr_procedimento b,
 prescr_medica a,
 forma_entrega_laudo fel
where  a.nr_prescricao    = b.nr_prescricao
and    a.nr_seq_forma_laudo = fel.nr_sequencia (+)
';

if  (((coalesce(ie_filtro_data_W,'N') = 'N') and (nr_atendimento_p = 0) and (nr_prescricao_p = 0)) or (coalesce(ie_filtro_data_W,'N') = 'S')) then
  begin
  if (ie_data_p = 0) then
    ds_comando_w  := ds_comando_w ||chr(10)||' and a.dt_prescricao between '||getDataToString(dt_inicial_p,dt_final_p);
    /*ds_comando_w  := ds_comando_w ||chr(10)||' and a.dt_prescricao between :dt_inicial and :dt_final ';
    ds_parametros_w  := ds_parametros_w||'DT_INICIAL='||to_char(dt_inicial_p,'dd/mm/yyyy hh24:mi:ss')|| ds_sep_bv_w;
    ds_parametros_w  := ds_parametros_w||'DT_FINAL='||to_char(dt_final_p,'dd/mm/yyyy hh24:mi:ss')|| ds_sep_bv_w;*/
  elsif (ie_data_p = 1) then
    ds_comando_w  := ds_comando_w ||' and b.dt_prev_execucao between '||getDataToString(dt_inicial_p,dt_final_p);
    /*ds_comando_w  := ds_comando_w ||' and b.dt_prev_execucao between :dt_inicial and :dt_final ';
    ds_parametros_w  := ds_parametros_w ||'DT_INICIAL='||to_char(dt_inicial_p,'dd/mm/yyyy hh24:mi:ss')|| ds_sep_bv_w;
    ds_parametros_w  := ds_parametros_w ||'DT_FINAL='||to_char(dt_final_p,'dd/mm/yyyy hh24:mi:ss')|| ds_sep_bv_w;*/
  elsif (ie_data_p = 2) then
    ds_comando_w  := ds_comando_w ||' and  a.dt_entrega between '||getDataToString(dt_inicial_p,dt_final_p);
    /*ds_comando_w  := ds_comando_w ||' and  a.dt_entrega between :dt_inicial and :dt_final ';
    ds_parametros_w  := ds_parametros_w ||'DT_INICIAL='||to_char(dt_inicial_p,'dd/mm/yyyy hh24:mi:ss')|| ds_sep_bv_w;
    ds_parametros_w  := ds_parametros_w ||'DT_FINAL='||to_char(dt_final_p,'dd/mm/yyyy hh24:mi:ss')|| ds_sep_bv_w;*/
  elsif (ie_data_p = 5) then
    ds_comando_w  := ds_comando_w ||' and  b.dt_resultado between '||getDataToString(dt_inicial_p,dt_final_p);
    /*ds_comando_w  := ds_comando_w ||' and  b.dt_resultado between :dt_inicial and :dt_final ';
    ds_parametros_w  := ds_parametros_w ||'DT_INICIAL='||to_char(dt_inicial_p,'dd/mm/yyyy hh24:mi:ss')|| ds_sep_bv_w;
    ds_parametros_w  := ds_parametros_w ||'DT_FINAL='||to_char(dt_final_p,'dd/mm/yyyy hh24:mi:ss')|| ds_sep_bv_w;*/
  end if;
  end;
end if;

if (ie_data_p = 4) then
    ds_comando_w  := ds_comando_w ||' and  exists( select 1 from procedimento_paciente  c
                            where  a.nr_prescricao = c.nr_prescricao
               and  b.nr_sequencia = c.nr_sequencia_prescricao
               and  a.nr_atendimento = c.nr_atendimento
               and    c.dt_procedimento between '||getDataToString(dt_inicial_p,dt_final_p)||')';

  /*ds_comando_w  := ds_comando_w ||' and  exists( select 1 from procedimento_paciente  c
                            where  a.nr_prescricao = c.nr_prescricao
               and  b.nr_sequencia = c.nr_sequencia_prescricao
               and  a.nr_atendimento = c.nr_atendimento
               and    c.dt_procedimento between :dt_inicial and :dt_final )';
  ds_parametros_w  := ds_parametros_w ||'DT_INICIAL='||to_char(dt_inicial_p,'dd/mm/yyyy hh24:mi:ss')|| ds_sep_bv_w;
  ds_parametros_w  := ds_parametros_w ||'DT_FINAL='||to_char(dt_final_p,'dd/mm/yyyy hh24:mi:ss')|| ds_sep_bv_w;*/
end if;

ie_oculta_associados_w := Obter_Param_Usuario(942, 292, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_oculta_associados_w);
if (ie_Oculta_associados_w = 'N') then
  ds_comando_w  := ds_comando_w||chr(10)||' and b.nr_seq_proc_princ is null';
end if;

ie_visu_exam_nao_auto_w := Obter_Param_Usuario(942, 391, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_visu_exam_nao_auto_w);
if (ie_visu_exam_nao_auto_w = 'N') then
  ds_comando_w  := ds_comando_w||chr(10)||' and ((b.ie_autorizacao = ''A'') or (b.ie_autorizacao = ''L'')) ';
end if;

qt_horas_w := Obter_Param_Usuario(942, 386, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, qt_horas_w);

if (qt_horas_w <> 0) then
  begin

  dt_final_w    := (clock_timestamp() + (qt_horas_w / 24));

  if (dt_final_p > dt_final_w) then
    begin
    ds_comando_w  := ds_comando_w ||' and ((b.ie_status_execucao = '||chr(39) ||'10'||chr(39)|| ') and (b.dt_prev_execucao between '||getDataToString(dt_inicial_p,dt_final_w)||') or (b.ie_status_execucao <> '||chr(39) ||'10'||chr(39)|| ')) ';
    /*ds_comando_w  := ds_comando_w ||' and ((b.ie_status_execucao = '||chr(39) ||'10'||chr(39)|| ') and (b.dt_prev_execucao between :dt_inicial and :dt_fim) or (b.ie_status_execucao <> '||chr(39) ||'10'||chr(39)|| ')) ';
    ds_parametros_w  := ds_parametros_w ||'DT_INICIAL='||to_char(dt_inicial_p,'dd/mm/yyyy hh24:mi:ss')|| ds_sep_bv_w;
    ds_parametros_w  := ds_parametros_w ||'DT_FIM='||to_char(dt_final_w,'dd/mm/yyyy hh24:mi:ss')|| ds_sep_bv_w;*/
    end;
  end if;

  end;
end if;

if (nr_prescricao_p > 0) then
    ds_comando_w  := ds_comando_w ||chr(10)||' and a.nr_prescricao = '||nr_prescricao_p;
  /*ds_comando_w  := ds_comando_w ||chr(10)||' and a.nr_prescricao = :nr_prescricao ';
  ds_parametros_w  := ds_parametros_w ||'nr_prescricao='||nr_prescricao_p||ds_sep_bv_w;*/
end if;

if (nr_atendimento_p > 0) then
  ds_comando_w  := ds_comando_w ||chr(10)||' and a.nr_atendimento = '||nr_atendimento_p;
  /*ds_comando_w  := ds_comando_w ||chr(10)||' and a.nr_atendimento = :nr_atendimento ';
  ds_parametros_w  := ds_parametros_w ||'nr_atendimento='||nr_atendimento_p||ds_sep_bv_w;*/
end if;

ie_Restrige_estab_w := Obter_Param_Usuario(942, 34, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_Restrige_estab_w);

if (cd_estabelecimento_p > 0) and (ie_Restrige_estab_w = 'S') then
  ds_comando_w  := ds_comando_w ||chr(10)||' and a.cd_estabelecimento = '||cd_estabelecimento_p;
  /*ds_comando_w  := ds_comando_w ||chr(10)||' and a.cd_estabelecimento = :cd_estabelecimento ';
  ds_parametros_w  := ds_parametros_w ||'cd_estabelecimento='||cd_estabelecimento_p||ds_sep_bv_w;*/
else
  ds_comando_w  := ds_comando_w ||chr(10)|| 'and exists (select 1 from usuario_estabelecimento x  where  x.nm_usuario_param = '''||nm_usuario_p||''' and x.cd_estabelecimento = a.cd_estabelecimento  '
      || 'union all '||
      'select 1 from usuario x where x.nm_usuario = '''||nm_usuario_p||''' and x.cd_estabelecimento = a.cd_estabelecimento)';

  /*ds_comando_w  := ds_comando_w ||chr(10)|| 'and exists (select 1 from usuario_estabelecimento x  where  x.nm_usuario_param = :nm_usuario and x.cd_estabelecimento = a.cd_estabelecimento  '
      || 'union all '||
      'select 1 from usuario x where x.nm_usuario = :nm_usuario and x.cd_estabelecimento = a.cd_estabelecimento)';
  ds_parametros_w  := ds_parametros_w ||'nm_usuario='||nm_usuario_p||ds_sep_bv_w;*/
end if;

if (cd_setor_atendimento_p > 0) then
  ds_comando_w  := ds_comando_w ||chr(10)||' and b.cd_setor_atendimento  = '||cd_setor_atendimento_p;
  /*ds_comando_w  := ds_comando_w ||chr(10)||' and b.cd_setor_atendimento  = :cd_setor_atendimento ';
  ds_parametros_w  := ds_parametros_w ||'cd_setor_atendimento='||cd_setor_atendimento_p||ds_sep_bv_w;*/
end if;

if (cd_setor_prescricao_p > 0) then
  ds_comando_w  := ds_comando_w ||chr(10)||' and a.cd_setor_atendimento  = '||cd_setor_prescricao_p;
  /*ds_comando_w  := ds_comando_w ||chr(10)||' and a.cd_setor_atendimento  = :cd_setor_prescr ';
  ds_parametros_w  := ds_parametros_w ||'cd_setor_prescr='||cd_setor_prescricao_p||ds_sep_bv_w;*/
end if;

ie_status_patologia_w := Obter_Param_Usuario(942, 136, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_status_patologia_w);

if (ie_status_execucao_p IS NOT NULL AND ie_status_execucao_p::text <> '') and (ie_status_patologia_w = 'N') then
  ds_comando_w  := ds_comando_w ||chr(10)||' and ((  b.ie_status_execucao = '||chr(39) ||ie_status_execucao_p||chr(39) ||')';
  /*ds_comando_w  := ds_comando_w ||chr(10)||' and ((  b.ie_status_execucao = :ie_status_execucao )';*/

  if (ie_somente_com_exames_p = 'S') and (ie_status_ind_comple_p = 'S') then
    ds_comando_w  := ds_comando_w ||' or (obter_se_possui_compl_pato(b.nr_prescricao,b.nr_sequencia) = '||chr(39) ||'S'||chr(39) ||')) ';
    /*ds_comando_w  := ds_comando_w ||' or (obter_se_possui_compl_pato(b.nr_prescricao,b.nr_sequencia) = :ie_possui_exame_compl)) ';
    ds_parametros_w  := ds_parametros_w ||'ie_possui_exame_compl='||'S'||ds_sep_bv_w;  */
  else
    ds_comando_w  := ds_comando_w ||')';
  end if;

  ds_parametros_w  := ds_parametros_w ||'ie_status_execucao='||ie_status_execucao_p||ds_sep_bv_w;
end if;

if (cd_paciente_p IS NOT NULL AND cd_paciente_p::text <> '') then
  ds_comando_w  := ds_comando_w ||chr(10)||' and a.cd_pessoa_fisica = '||cd_paciente_p;
/*  ds_comando_w  := ds_comando_w ||chr(10)||' and a.cd_pessoa_fisica = :cd_paciente ';
  ds_parametros_w  := ds_parametros_w ||'cd_paciente='||cd_paciente_p||ds_sep_bv_w;*/
end if;

if (cd_prescritor_p IS NOT NULL AND cd_prescritor_p::text <> '') then
  ds_comando_w  := ds_comando_w ||chr(10)||' and a.cd_medico = '||cd_prescritor_p;
  /*ds_comando_w  := ds_comando_w ||chr(10)||' and a.cd_medico = :cd_prescritor ';
  ds_parametros_w  := ds_parametros_w ||'cd_prescritor='||cd_prescritor_p||ds_sep_bv_w;*/
end if;

if (cd_executor_prev_p IS NOT NULL AND cd_executor_prev_p::text <> '') then
  ds_comando_w  := ds_comando_w ||chr(10)||' and b.cd_medico_exec = '||cd_executor_prev_p;
  /*ds_comando_w  := ds_comando_w ||chr(10)||' and b.cd_medico_exec = :cd_executor_prev ';
  ds_parametros_w  := ds_parametros_w ||'cd_executor_prev='||cd_executor_prev_p||ds_sep_bv_w;*/
end if;

if (cd_motivo_baixa_p > 0) then
  ds_comando_w  := ds_comando_w ||chr(10)||' and b.cd_motivo_baixa = '||cd_motivo_baixa_p;
  /*ds_comando_w  := ds_comando_w ||chr(10)||' and b.cd_motivo_baixa = :cd_motivo_baixa ';
  ds_parametros_w  := ds_parametros_w ||'cd_motivo_baixa='||cd_motivo_baixa_p||ds_sep_bv_w;*/
end if;

if (cd_procedimento_p > 0) and (ie_origem_proced_p > 0) then
  ds_comando_w  := ds_comando_w ||chr(10)||' and b.cd_procedimento = '||cd_procedimento_p;
  ds_comando_w  := ds_comando_w ||chr(10)||' and b.ie_origem_proced = '||ie_origem_proced_p;
  /*ds_comando_w  := ds_comando_w ||chr(10)||' and b.cd_procedimento = :cd_procedimento ';
  ds_comando_w  := ds_comando_w ||chr(10)||' and b.ie_origem_proced = :ie_origem_proced ';
  ds_parametros_w  := ds_parametros_w ||'cd_procedimento='||cd_procedimento_p||ds_sep_bv_w;
  ds_parametros_w  := ds_parametros_w ||'ie_origem_proced='||ie_origem_proced_p||ds_sep_bv_w;*/
end if;

if (nm_ditador_p IS NOT NULL AND nm_ditador_p::text <> '') then
  ds_comando_w  := ds_comando_w ||chr(10)||' and upper(substr(Obter_Usuario_Ditado(b.nr_seq_interno),1,80)) = upper('''||nm_ditador_p||''') ';
  /*ds_comando_w  := ds_comando_w ||chr(10)||' and upper(substr(Obter_Usuario_Ditado(b.nr_seq_interno),1,80)) = upper(:nm_ditador) ';
  ds_parametros_w  := ds_parametros_w ||'nm_ditador='||nm_ditador_p||ds_sep_bv_w;*/
end if;

if (nr_seq_proc_interno_p > 0) then
  ds_comando_w  := ds_comando_w ||chr(10)||' and b.nr_seq_proc_interno = '||nr_seq_proc_interno_p;
  /*ds_comando_w  := ds_comando_w ||chr(10)||' and b.nr_seq_proc_interno = :nr_seq_proc_interno ';
  ds_parametros_w  := ds_parametros_w ||'nr_seq_proc_interno='||nr_seq_proc_interno_p||ds_sep_bv_w;*/
end if;

if (nr_exame_p IS NOT NULL AND nr_exame_p::text <> '') then
  ds_comando_w  := ds_comando_w ||chr(10)||' and b.nr_seq_lab = '||chr(39)||nr_exame_p||chr(39);
  /*ds_comando_w  := ds_comando_w ||chr(10)||' and b.nr_seq_lab = :nr_exame ';
  ds_parametros_w  := ds_parametros_w ||'nr_exame='||nr_exame_p||ds_sep_bv_w;*/
end if;

if (ie_somente_antecipado_p = 'S') then
  ds_comando_w  := ds_comando_w ||chr(10)||' and b.dt_antecipa_result is not null ';
end if;

if (ie_somente_com_exame_p = 'S') then
  ds_comando_w  := ds_comando_w ||chr(10)||' and b.nr_seq_lab is not null ';
end if;

if (ie_somente_setor_p = 'S') then
  ds_comando_w  := ds_comando_w ||chr(10)||' and b.cd_setor_atendimento is not null ';
end if;

if (ie_somente_lib_p = 'S') then
  if (ie_exige_lib_enf_p = 'S') then
    ds_comando_w  := ds_comando_w ||chr(10)||' and (a.dt_liberacao is not null) ';
  else
    ds_comando_w  := ds_comando_w ||chr(10)||' and ((a.dt_liberacao_medico is not null) or (a.dt_liberacao is not null)) ';
  end if;
elsif (ie_somente_lib_p = 'P') then
  if (ie_exige_lib_enf_p = 'S') then
    ds_comando_w  := ds_comando_w ||chr(10)||' and (((a.dt_liberacao_medico is not null) and (a.dt_liberacao is not null))
                  or  ((a.nr_cirurgia is not null) or (a.nr_cirurgia is null and exists(select 1 from cirurgia ci where ci.nr_prescricao = a.nr_prescricao)))) ';
  else
    ds_comando_w  := ds_comando_w ||chr(10)||' and (((a.dt_liberacao_medico is not null) or (a.dt_liberacao is not null))
                  or  ((a.nr_cirurgia is not null) or (a.nr_cirurgia is null and exists(select 1 from cirurgia ci where ci.nr_prescricao = a.nr_prescricao)))) ';
  end if;
end if;

if (coalesce(ie_status_execucao_p::text, '') = '') and (ie_somente_pendente_p = 'S') then
  ds_comando_w  := ds_comando_w ||chr(10)||' and b.ie_status_execucao not in ('||chr(39) ||'990'||chr(39)||
            ','||chr(39)||'70'||chr(39)||','||chr(39)||'BE'||chr(39)||') ';
end if;

if (ie_somente_suspensos_p = 'S') then
  ds_comando_w  := ds_comando_w ||chr(10)||' and b.dt_suspensao is not null ';
end if;

if (ie_acm_sn_aprazado_p = 'S') then
  ds_comando_w  := ds_comando_w ||chr(10)||' and obter_se_acm_sn_apraz(b.nr_prescricao, b.nr_sequencia) = ''S'' ';
end if;

if (ie_somente_proc_anest_p = 'S') then
  ds_comando_w  := ds_comando_w ||chr(10)||' and obter_se_proc_anest(b.nr_seq_proc_interno, b.cd_procedimento, b.ie_origem_proced) = '||chr(39) ||'S'||chr(39) ||'';
  /*ds_comando_w  := ds_comando_w ||chr(10)||' and obter_se_proc_anest(b.nr_seq_proc_interno, b.cd_procedimento, b.ie_origem_proced) = :ie_somente_proc_anest ';
  ds_parametros_w  := ds_parametros_w ||'ie_somente_proc_anest='||'S'||ds_sep_bv_w;*/
end if;

if (ie_exige_lib_tecnica_p = 'S') then
  begin
  ds_comando_w  := ds_comando_w ||chr(10)||' and nvl(b.ie_exige_liberacao,''N'') =  '||chr(39) ||'N'||chr(39) ||'';
  /*ds_comando_w  := ds_comando_w ||chr(10)||' and nvl(b.ie_exige_liberacao,''N'') =  :ie_exige_liberacao ';
  ds_parametros_w  := ds_parametros_w ||'ie_exige_liberacao='||'N'||ds_sep_bv_w;*/
  end;
end if;

if (ie_status_patologia_p IS NOT NULL AND ie_status_patologia_p::text <> '') then
  ds_comando_w  := ds_comando_w ||chr(10)||' and ((Obter_desc_status_pato_dom(nr_seq_status_pato,''C'') = '||chr(39) ||ie_status_patologia_p||chr(39) ||') ';
  /*ds_comando_w  := ds_comando_w ||chr(10)||' and ((Obter_desc_status_pato_dom(nr_seq_status_pato,''C'') = :ie_status_patologia) ';*/

  if (ie_somente_com_exames_p = 'S') and (ie_status_ind_comple_p = 'S') then
    ds_comando_w  := ds_comando_w ||' or (obter_se_possui_compl_pato(b.nr_prescricao,b.nr_sequencia) = '||chr(39) ||'S'||chr(39) ||')) ';
    /*ds_comando_w  := ds_comando_w ||' or (obter_se_possui_compl_pato(b.nr_prescricao,b.nr_sequencia) = :ie_possui_exame_compl)) ';
    ds_parametros_w  := ds_parametros_w ||'ie_possui_exame_compl='||'S'||ds_sep_bv_w;  */
  else
    ds_comando_w  := ds_comando_w ||')';
  end if;
  --ds_parametros_w  := ds_parametros_w ||'ie_status_patologia='||ie_status_patologia_p||ds_sep_bv_w;
end if;

if (ie_somente_com_exames_p = 'S') and
  ((ie_status_ind_comple_p = 'N') or ((coalesce(ie_status_execucao_p::text, '') = '') and (coalesce(ie_status_patologia_p::text, '') = '')) ) then
  ds_comando_w  := ds_comando_w ||chr(10)||' and obter_se_possui_compl_pato(b.nr_prescricao,b.nr_sequencia) = ''S''';
  /*ds_comando_w  := ds_comando_w ||chr(10)||' and obter_se_possui_compl_pato(b.nr_prescricao,b.nr_sequencia) = :ie_possui_exame_compl ';
  ds_parametros_w  := ds_parametros_w ||'ie_possui_exame_compl='||'S'||ds_sep_bv_w;  */
end if;

if (ie_proced_bloqueado_p = 'S') then
  ds_comando_w  :=  ds_comando_w||chr(10)||' and (ie_proced_bloqueado = ''S'') ';
end if;

if (ie_somente_suspensos_p <> 'S') then
ds_comando_w  := ds_comando_w ||chr(10)||' and a.dt_suspensao is null ';
ds_comando_w  := ds_comando_w ||chr(10)||' and b.ie_suspenso <> '||chr(39)||'S'||chr(39);
end if;
ds_comando_w  := ds_comando_w ||chr(10)||' and ((nvl(b.cd_motivo_baixa,0) = 0) or (b.ie_status_execucao <> '||chr(39)||'10'||chr(39)||') or ('||chr(39) ||ie_status_exec_p||chr(39) ||' = '||chr(39)||'S'||chr(39)||'))';
/*ds_comando_w  := ds_comando_w ||chr(10)||' and ((b.cd_motivo_baixa = 0) or (b.ie_status_execucao <> '||chr(39)||'10'||chr(39)||') or (:ie_status_exec = '||chr(39)||'S'||chr(39)||'))';
ds_parametros_w  := ds_parametros_w ||'ie_status_exec='||ie_status_exec_p||ds_sep_bv_w;*/
if (nr_exame_lote_p > 0) then
  ds_comando_w  := ds_comando_w ||chr(10)||' and b.nr_seq_lote_prescr = '||nr_exame_lote_p;
  /*ds_comando_w  := ds_comando_w ||chr(10)||' and b.nr_seq_lote_prescr = :nr_exame_lote_p ';
  ds_parametros_w  := ds_parametros_w ||'nr_exame_lote_p='||nr_exame_lote_p||ds_sep_bv_w;*/
end if;

if (ie_exame_complementar_p = 'S') then
  begin
  ds_comando_w  := ds_comando_w ||chr(10)||' and obter_se_exame_complementar(a.nr_prescricao,b.nr_sequencia) = '''||ie_exame_complementar_p||'';
  /*ds_comando_w  := ds_comando_w ||chr(10)||' and obter_se_exame_complementar(a.nr_prescricao,b.nr_sequencia) = :ie_exame_complet_p';
  ds_parametros_w  := ds_parametros_w ||'ie_exame_complet_p='||ie_exame_complementar_p||ds_sep_bv_w;*/
  end;
end if;

if (nr_acesso_dicom_p IS NOT NULL AND nr_acesso_dicom_p::text <> '') then
  --ds_comando_w  := ds_comando_w ||chr(10)||' and b.nr_acesso_dicom = '||nr_acesso_dicom_p;
    ds_comando_w  := ds_comando_w ||chr(10)||' and b.nr_acesso_dicom =  '||chr(39) ||nr_acesso_dicom_p||chr(39) ||'';
  /*ds_comando_w  := ds_comando_w ||chr(10)||' and b.nr_acesso_dicom = :nr_acesso_dicom_p ';
  ds_parametros_w  := ds_parametros_w ||'nr_acesso_dicom_p='||nr_acesso_dicom_p||ds_sep_bv_w;*/
end if;

if (ie_aprovacao_execucao_p = 'S') then
  begin
  ds_comando_w := ds_comando_w ||chr(10)||' and b.ie_aprovacao_execucao = ''N'' ';
  end;
end if;

if (cg_cgc_laboratorio_p IS NOT NULL AND cg_cgc_laboratorio_p::text <> '') then
  begin
  ds_comando_w  := ds_comando_w ||chr(10)||' and    b.cd_cgc_laboratorio = '''||cg_cgc_laboratorio_p||'';
  /*ds_comando_w  := ds_comando_w ||chr(10)||' and    b.cd_cgc_laboratorio = :cd_cgc_laboratorio_p ';
  ds_parametros_w  := ds_parametros_w ||'cd_cgc_laboratorio_p='||cg_cgc_laboratorio_p||ds_sep_bv_w;  */
  end;
end if;

if (ie_somente_justif_baixa_p = 'S') then
  ds_comando_w  := ds_comando_w ||chr(10)||' and b.nr_seq_motivo_just is not null ';
end if;

qt_anos_limite_w := Obter_Param_Usuario(942, 334, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, qt_anos_limite_w);

if (qt_anos_limite_w IS NOT NULL AND qt_anos_limite_w::text <> '') then
  ds_comando_w  := ds_comando_w ||chr(10)|| ' and (exists (   select  1
                  from   pessoa_fisica b
                  where   a.cd_pessoa_fisica = b.cd_pessoa_fisica
                  and nvl(trunc(months_between(sysdate, dt_nascimento) / 12),0) <= '||qt_anos_limite_w||')
              or a.ie_recem_nato = ''S'')';
  /*ds_comando_w  := ds_comando_w ||chr(10)|| ' and (exists (   select  1
                  from   pessoa_fisica b
                  where   a.cd_pessoa_fisica = b.cd_pessoa_fisica
                  and nvl(trunc(months_between(sysdate, dt_nascimento) / 12),0) <= :cd_idade_maxima_p)
              or a.ie_recem_nato = ''S'')';
  ds_parametros_w  := ds_parametros_w ||'cd_idade_maxima_p='||qt_anos_limite_w||ds_sep_bv_w;*/
end if;

qt_idade_minima_w := Obter_Param_Usuario(942, 338, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, qt_idade_minima_w);

if (qt_idade_minima_w IS NOT NULL AND qt_idade_minima_w::text <> '') then
  ds_comando_w  := ds_comando_w ||chr(10)|| ' and exists (   select  1
                  from   pessoa_fisica b
                  where   a.cd_pessoa_fisica = b.cd_pessoa_fisica
                  and nvl(trunc(months_between(sysdate, dt_nascimento) / 12),0) >= '||qt_idade_minima_w||') ';
  /*ds_comando_w  := ds_comando_w ||chr(10)|| ' and exists (   select  1
                  from   pessoa_fisica b
                  where   a.cd_pessoa_fisica = b.cd_pessoa_fisica
                  and nvl(trunc(months_between(sysdate, dt_nascimento) / 12),0) >= :cd_idade_minima_p) ';
  ds_parametros_w  := ds_parametros_w ||'cd_idade_minima_p='||qt_idade_minima_w||ds_sep_bv_w;    */
end if;

if (coalesce(ie_exibe_refazer_exame_p,'N') = 'S') then
  ds_comando_w   := ds_comando_w ||chr(10)|| ' and obter_se_refazer_exame(b.nr_prescricao,b.nr_sequencia) = ''S''';
end if;

if (coalesce(ie_exibe_agendamento_ageint_p,'N') = 'S') then
  ds_comando_w   := ds_comando_w ||chr(10)|| ' and obter_se_exame_agendado(b.nr_prescricao,b.nr_sequencia) = ''S''';
end if;

if (coalesce(ie_somente_mat_medic_assoc_p,'N') = 'S') then
  ds_comando_w  := ds_comando_w ||chr(10)|| ' and obter_se_possui_mat_med_assoc(b.nr_prescricao,b.nr_sequencia, 0) = ''S''';
end if;

if (coalesce(ie_somente_beira_leito_p,'N') = 'S') then

  ds_comando_w  := ds_comando_w ||chr(10)|| ' and b.ie_executar_leito = ''S''';

end if;

select  substr(max(obter_dados_param_faturamento(cd_estabelecimento_p, 'FLUXO_MMED')),1,255)
into STRICT  ie_fluxo_mmed_w
;

if (ie_fluxo_mmed_w = 'S') then
  ds_comando_w  := ds_comando_w || chr(10) || ' and obter_restricao_exame_mmed(b.nr_prescricao, a.nr_atendimento) = ''S''';
end if;

begin

select  coalesce(length(ds_filtros_p),0)
into STRICT  qt_filtro_multi_selecao_w
;

exception
when others then
  CALL Wheb_mensagem_pck.exibir_mensagem_abort(253824);
  --? necess?rio reduzir as op??es dos filtros multi-sele??o para realizar a consulta.
commit;

end;

select  coalesce(length(ds_comando_w),0)
into STRICT  qt_comando_w
;


if  ((qt_filtro_multi_selecao_w + qt_comando_w) > 4000) then
  CALL Wheb_mensagem_pck.exibir_mensagem_abort(253824);
  --? necess?rio reduzir as op??es dos filtros multi-sele??o para realizar a consulta.
end if;

if (ds_filtros_p IS NOT NULL AND ds_filtros_p::text <> '') then
  ds_comando_w  := ds_comando_w ||chr(10)||ds_filtros_p;
end if;						
--insert into temp values (sysdate,3);

--insert into temp2 values(ds_comando_w); commit;
CALL Exec_sql_Dinamico('GE',ds_comando_w);
--Exec_sql_Dinamico_bv('GE',ds_comando_w,ds_parametros_w );

--insert into temp values (sysdate,4);
if (coalesce(ie_exibe_nao_lib_setor_p,'N') = 'N') then

  ds_tabela_adicional_w    := ds_tabela_adicional_w || ' inner join usuario_setor_v x on ( a.cd_setor_atendimento  = x.cd_setor_atendimento and  x.nm_usuario    = :nm_usuario)';

end if;

--insert into temp values ('Andrey1 - '||ds_comando_w,

 --                       obter_usuario_ativo,

 --                       sysdate,

--                          1);
restr_zerar_conta := Obter_Param_Usuario(942, 420, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, restr_zerar_conta);

ds_comando2_w  :=
  'select a.nr_prescricao,
a.nr_atendimento,
a.nr_seq_interno,
c.nr_sequencia,
nvl(d.nr_sequencia, c.nr_laudo),
o.nr_interno_conta,
a.ie_status_execucao,
a.cd_medico_exec,
c.cd_medico_executor,
d.cd_medico_resp,
a.ie_autorizacao,
a.nr_seq_proc_interno,
a.cd_procedimento,
a.ie_origem_proced,
d.nr_seq_motivo_parada,
a.cd_setor_atendimento,
a.cd_motivo_baixa,
a.cd_pessoa_fisica,
z.cd_procedencia,
a.nr_seq_agenda,
a.ie_lado,
z.ie_tipo_atendimento,
a.cd_convenio,
a.nr_sequencia,
a.dt_prescricao,
a.dt_liberacao,
a.dt_inicio_exame,
a.dt_baixa,
a.nr_seq_exame,
a.cd_material_exame,
c.cd_pessoa_fisica,
a.nr_seq_motivo_antecipacao,
a.cd_medico,
d.cd_anestesista,
a.nr_seq_contraste,
a.cd_intervalo,
a.cd_profissional,
nvl(z.ie_paciente_isolado,'||chr(39) ||'N'||chr(39) ||'),
c.cd_procedimento,
c.ie_origem_proced,
w.ds_procedimento,
a.ds_material_especial,
a.dt_cancelamento,
obter_setor_atendimento(a.nr_atendimento),
z.nr_seq_pac_senha_fila,
d.dt_liberacao dt_liberacao_laudo,
d.nm_usuario   nm_usuario_laudo,
d.dt_laudo,
d.nm_usuario_aprovacao,
d.nm_usuario_seg_aprov,
d.dt_impressao,
c.dt_procedimento,
c.nm_usuario_original,
c.qt_procedimento,
nvl(c.nr_doc_convenio, a.nr_doc_convenio) nr_doc_convenio,
c.cd_medico_prev_laudo,
a.dt_entrega,
a.ie_recem_nato,
a.dt_liberacao_medico,
a.cd_estabelecimento_prescricao,
a.nr_seq_pepo,
a.qt_peso,
a.nm_usuario_prescr_medica,
a.nm_usuario_origin_prescr,
a.nr_seq_locate,
a.nr_controle,
a.ds_dado_clinico,
a.cd_categoria,
a.ds_forma_entrega_laudo,
a.ds_cor_entrega_laudo,
a.ds_exame_anterior,
nvl(tcp.nr_seq_prioridade,999) ie_prioridade_classif,
tcp.ds_classificacao ds_prioridade_classif,
tcp.ds_cor cor_prioridade_classif,
ppp.ds_prioridade ds_prioridade,
ppp.ds_cor ds_cor_prioridade,
mnar.ds_motivo_neg_antecip nr_seq_mot_anteci_result,
nvl(tcr.nr_seq_prioridade,999) ie_prioridade,
tcr.ds_classificacao ds_classif_urgencia,
substr(nvl(tcr.ds_classificacao,obter_desc_sem_triagem(z.nr_seq_triagem)),1,60) ds_triagem,
tcr.ds_cor ds_cor_urgencia,
nvl(ca.nr_seq_prioridade,999) ie_prior_classif_atend,
substr(obter_valor_dominio(17,z.ie_clinica),1,255) ds_clinica,
tcr.ds_cor_fonte ds_cor_fonte_urgencia,
substr(decode('||chr(39)||ie_local_breve_w||chr(39)||','|| chr(39)||'S'||chr(39)||',pl.ds_local),1,100) ds_breve_local,
decode('||chr(39)||ie_nr_prioridade_triagem_w||chr(39)||','|| chr(39)||'S'||chr(39)||',tcr.nr_seq_prioridade) nr_prioridade_triagem,
decode('||chr(39)||ie_dt_alta_w||chr(39)||','|| chr(39)||'S'||chr(39)||',z.dt_alta) dt_alta,
decode('||chr(39)||ie_nr_crm_w||chr(39)||','|| chr(39)||'S'||chr(39)||',mr.uf_crm) nr_crm,
decode('||chr(39)||ie_uf_medico_w||chr(39)||','|| chr(39)||'S'||chr(39)||',mr.uf_crm) ds_uf_medico,
decode('||chr(39)||ie_exame_lab_w||chr(39)||','|| chr(39)||'S'||chr(39)||',decode(a.nr_seq_exame,null,substr(w.ds_procedimento,1,100),substr(el.nm_exame,1,100))) ds_exame_lab,
decode('||chr(39)||ie_arquivo_ditado_w||chr(39)||','|| chr(39)||'S'||chr(39)||',nvl(ppd.ds_arquivo,substr(wheb_mensagem_pck.get_texto(306335),1,80))) ds_arquivo,
decode('||chr(39)||ie_usuario_ditado_w||chr(39)||','|| chr(39)||'S'||chr(39)||',ppd.nm_usuario) nm_usuario_ditado,
decode('||chr(39)||ie_dt_ditado_w||chr(39)||','|| chr(39)||'S'||chr(39)||',ppd.dt_atualizacao) dt_ditado,
decode('||chr(39)||ie_ds_obs_agenda_w||chr(39)||','|| chr(39)||'S'||chr(39)||',substr(ap.ds_observacao,1,255)) ds_observacao_agenda,
decode('||chr(39)||ie_motivo_baixa_w||chr(39)||','|| chr(39)||'S'||chr(39)||',substr(tbp.ds_tipo_baixa,1,60)) ds_tipo_baixa,
decode('||chr(39)||ie_exame_cancelado_w||chr(39)||','|| chr(39)||'S'||chr(39)||',tbp.ie_conta_paciente) ie_exame_cancelado,
decode('||chr(39)||ie_dt_solicit_w||chr(39)||','|| chr(39)||'S'||chr(39)||',a.DT_SOL_ANTECIP_RES) DT_SOL_ANTECIP_RES,
decode('||chr(39)||ie_nm_usu_lib_pat_w||chr(39)||','|| chr(39)||'S'||chr(39)||',substr(lab_obter_dados_lib_laudar(a.nr_prescricao, a.nr_sequencia, ''U''),1,100)) nm_usu_lib_pat,
decode('||chr(39)||ie_dt_usu_lib_pat_w||chr(39)||','|| chr(39)||'S'||chr(39)||',to_date(substr(lab_obter_dados_lib_laudar(a.nr_prescricao, a.nr_sequencia, ''D''),1,100),''dd/mm/yyyy hh24:mi:ss'')) dt_usu_lib_pat,
d.ie_tumor ie_tumor,
decode(b.ds_imunohistoquimica, null, '|| chr(39)||'N'||chr(39)||','|| chr(39)||'S'||chr(39)||') ds_imunohistoquimica,
d.dt_cancelamento dt_laudo_cancelamento,
o.nr_seq_protocolo,
obter_nome_agenda(ap.cd_agenda) ds_agenda
from w_ge_temp a
    inner join procedimento w on  (a.cd_procedimento = w.cd_procedimento and   a.ie_origem_proced = w.ie_origem_proced)
    left join proc_interno i on (a.nr_seq_proc_interno = i.nr_sequencia)
    left join atendimento_paciente z on (a.nr_atendimento = z.nr_atendimento)
    left join procedimento_paciente c on (a.nr_prescricao = c.nr_prescricao and a.nr_sequencia = c.nr_sequencia_prescricao)
    left join conta_paciente o on(c.nr_interno_conta = o.nr_interno_conta)
    left join laudo_paciente d on (c.nr_laudo = d.nr_sequencia)
    left join laudo_paciente_compl b on d.nr_sequencia = b.nr_seq_laudo
    left join triagem_classif_prioridade tcp on (z.nr_seq_triagem_prioridade = tcp.nr_sequencia)
    left join proced_patologia_prior ppp on (a.nr_seq_prioridade = ppp.nr_sequencia)
    left join motivo_neg_antecip_result mnar on (a.nr_seq_mot_anteci_result = mnar.nr_sequencia)
    left join triagem_classif_risco tcr on (z.nr_seq_triagem = tcr.nr_sequencia)
    left join classificacao_atendimento ca on (z.nr_seq_classificacao = ca.nr_sequencia)
    left join exame_laboratorio el on (a.nr_seq_exame = el.nr_seq_exame)
    left join agenda_paciente ap on (a.nr_seq_agenda = ap.nr_sequencia)
    left join prescr_proc_ditado ppd on (a.nr_seq_interno = ppd.nr_seq_prescr_proc)
    left join medico mr on (d.cd_medico_resp = mr.cd_pessoa_fisica)
    left join pa_local pl on (z.nr_seq_local_pa = pl.nr_sequencia)
    left join tipo_baixa_prescricao tbp on (a.cd_motivo_baixa = tbp.cd_tipo_baixa and   tbp.ie_prescricao_devolucao = ''P'')
    ' || ds_tabela_adicional_w || '
where nvl(o.ie_cancelamento,'||chr(39)||'N'||chr(39) || ') = '||chr(39)||'N'||chr(39);

ie_ocultar_laudos_cancelados_w := Obter_Param_Usuario(942, 434, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_ocultar_laudos_cancelados_w);
if (ie_ocultar_laudos_cancelados_w = 'S') then
  ds_comando2_w  := ds_comando2_w|| chr(10) ||' and d.dt_cancelamento is null ';
end if;

ie_ocultar_laudos_compl_w := Obter_Param_Usuario(942, 430, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_ocultar_laudos_compl_w);
if (ie_ocultar_laudos_compl_w = 'S') then
  ds_comando2_w  := ds_comando2_w|| chr(10) ||' and nvl(c.cd_funcao, 0) <> 945 ';
end if;

if (coalesce(restr_zerar_conta,'N') = 'N') then
  ds_comando2_w := ds_comando2_w || ' and   nvl(c.qt_procedimento,1) > 0';
end if;

if (ie_agrupa_patologia_conta_p = 'S') then
  begin

  ds_comando2_w := ds_comando2_w ||chr(10)||'AND((c.nr_sequencia =(select max(t.nr_sequencia)
from w_ge_temp a
     inner join procedimento w on (a.cd_procedimento = w.cd_procedimento and   a.ie_origem_proced = w.ie_origem_proced)
     left join procedimento_paciente t on (a.nr_prescricao = t.nr_prescricao and   a.nr_sequencia = t.nr_sequencia_prescricao)
     left join atendimento_paciente z on (a.nr_atendimento = z.nr_atendimento)
     left join conta_paciente o on (t.nr_interno_conta = o.nr_interno_conta)
     left join laudo_paciente d on (t.nr_laudo = d.nr_sequencia)
     left join laudo_paciente_compl b on d.nr_sequencia = b.nr_seq_laudo
     left join prescr_proc_lib_caso pplc on (a.nr_prescricao = pplc.nr_prescricao and a.nr_sequencia = pplc.nr_seq_prescr)
where t.nr_prescricao = c.nr_prescricao
and   t.nr_sequencia_prescricao = c.nr_sequencia_prescricao
							
and   a.cd_setor_atendimento = x.cd_setor_atendimento';

  if (ie_data_p = 4) then
    ds_comando2_w  := ds_comando2_w ||' and  t.dt_procedimento between :dt_inicial and :dt_final ';
  end if;

  if (cd_executor_p IS NOT NULL AND cd_executor_p::text <> '') then
    ds_comando2_w  := ds_comando2_w ||chr(10)||' and t.cd_medico_executor = :cd_medico_executor ';
  end if;

  ds_comando2_w := ds_comando2_w ||chr(10)||'AND  NVL(o.ie_cancelamento,'||chr(39)||'N'||chr(39) || ')  = '||chr(39)||'N'||chr(39) || '
              AND  NVL(t.qt_procedimento,1) > 0)) OR
                        (NOT EXISTS(SELECT 1 FROM
                        procedimento_paciente t
                        WHERE   t.nr_prescricao = a.nr_prescricao
                        AND  t.nr_sequencia_prescricao  = a.nr_sequencia)))';
  end;
end if;

if (ie_data_p = 4) then
    ds_comando2_w  := ds_comando2_w ||' and  c.dt_procedimento between :dt_inicial and :dt_final ';
end if;

if (coalesce(ie_status_execucao_p::text, '') = '') and (ie_somente_pendente_p = 'S') then
  ds_comando2_w  := ds_comando2_w ||chr(10)||' and (a.ie_status_execucao not in ('||chr(39)||'60'||chr(39)||','||chr(39) ||'990'||chr(39)||
            ','||chr(39)||'70'||chr(39)||','||chr(39)||'BE'||chr(39)||') or ( a.ie_status_execucao = '||chr(39)||'60'||chr(39)||' and c.nr_laudo is null)) ';
end if;

if (ie_laudo_normal_p = 'S') then
  ds_comando2_w  := ds_comando2_w ||chr(10)||' and d.ie_normal = '||chr(39)||'S'||chr(39);
end if;

if (ie_somente_sem_alta_p = 'S') then
  ds_comando2_w  := ds_comando2_w ||chr(10)||' and z.dt_alta is null ';
end if;
if (ie_somente_com_alta_p = 'S') then
  ds_comando2_w  := ds_comando2_w ||chr(10)||' and z.dt_alta is not null ';
end if;
if (cd_executor_p IS NOT NULL AND cd_executor_p::text <> '') then
  ds_comando2_w  := ds_comando2_w ||chr(10)||' and c.cd_medico_executor = :cd_medico_executor ';
end if;

if (cd_laudante_p IS NOT NULL AND cd_laudante_p::text <> '') then
  ds_comando2_w  := ds_comando2_w ||chr(10)||' and d.cd_medico_resp = :cd_medico_resp ';
end if;

if (cd_medico_prev_laudo_p IS NOT NULL AND cd_medico_prev_laudo_p::text <> '') then
  ds_comando2_w  := ds_comando2_w ||chr(10)||' and c.cd_medico_prev_laudo = :cd_medico_prev_laudo ';
end if;

if (cd_tipo_proced_padrao_p IS NOT NULL AND cd_tipo_proced_padrao_p::text <> '') then
begin
  if (substr(cd_tipo_proced_padrao_p,-1) = ',') then
    ds_comando2_w  := ds_comando2_w ||chr(10)||' and w.cd_tipo_procedimento in ( '|| substr(cd_tipo_proced_padrao_p, 1, length(cd_tipo_proced_padrao_p)-1) ||') ';
  else
    ds_comando2_w  := ds_comando2_w ||chr(10)||' and w.cd_tipo_procedimento in ( '||cd_tipo_proced_padrao_p ||') ';
  end if;
end;
end if;

if (cd_tipo_proced_filtro_p > 0) then
  ds_comando2_w  := ds_comando2_w ||chr(10)||' and w.cd_tipo_procedimento = :cd_tipo_procedimento ';
end if;

if (nr_protocolo_p > 0) then
  ds_comando2_w  := ds_comando2_w ||chr(10)||' and o.nr_seq_protocolo = :nr_protocolo';
end if;

/*if  (nr_exame_lote_p > 0) then
  ds_comando_w  := ds_comando_w ||chr(10)||' and p.nr_seq_lote_prescr = :nr_exame_lote ';
end if;
*/
if (ie_somente_cancelados_p = 'S') then
  ds_comando2_w  := ds_comando2_w ||chr(10)||' and a.dt_cancelamento is not null ';
end if;

if (ie_resp_seg_aprov_p = 'S') then
  ds_comando2_w  := ds_comando2_w ||chr(10)||' and d.cd_resp_seg_aprov = :cd_resp_seg_aprov ';
end if;

if (ie_somente_nao_cancelados_p = 'S') then
  ds_comando2_w  := ds_comando2_w ||chr(10)||' and a.dt_cancelamento is null ';
end if;

if (ie_tumor_p IS NOT NULL AND ie_tumor_p::text <> '') then
  ds_comando2_w  := ds_comando2_w ||chr(10)|| ' and d.ie_tumor = :ie_tumor';
end if;

if (ds_filtros_geral_p IS NOT NULL AND ds_filtros_geral_p::text <> '') then
  ds_comando2_w  := ds_comando2_w ||chr(10)||ds_filtros_geral_p;
end if;

--insert into temp2 values (ds_comando_w);

--insert into temp values (ds_comando2_w,

--                         obter_usuario_ativo,

--                         sysdate,

--                         2);
C04 := DBMS_SQL.OPEN_CURSOR;
DBMS_SQL.PARSE(C04, ds_comando2_w, dbms_sql.Native);

DBMS_SQL.DEFINE_COLUMN(C04,1,nr_prescricao_w);
DBMS_SQL.DEFINE_COLUMN(C04,2,nr_atendimento_w);
DBMS_SQL.DEFINE_COLUMN(C04,3,nr_seq_interno_w);
DBMS_SQL.DEFINE_COLUMN(C04,4,nr_seq_propaci_w);
DBMS_SQL.DEFINE_COLUMN(C04,5,nr_seq_laudo_w);
DBMS_SQL.DEFINE_COLUMN(C04,6,nr_interno_conta_w);
DBMS_SQL.DEFINE_COLUMN(C04,7,ie_status_execucao_w, 15);
DBMS_SQL.DEFINE_COLUMN(C04,8,cd_medico_exec_w,10);
DBMS_SQL.DEFINE_COLUMN(C04,9,cd_medico_executor_w,10);
DBMS_SQL.DEFINE_COLUMN(C04,10,cd_medico_resp_w,10);
DBMS_SQL.DEFINE_COLUMN(C04,11,ie_autorizacao2_w,15);
DBMS_SQL.DEFINE_COLUMN(C04,12,nr_seq_proc_interno_w);
DBMS_SQL.DEFINE_COLUMN(C04,13,cd_procedimento_w);
DBMS_SQL.DEFINE_COLUMN(C04,14,ie_origem_proced_w);
DBMS_SQL.DEFINE_COLUMN(C04,15,nr_seq_motivo_parada_w);
DBMS_SQL.DEFINE_COLUMN(C04,16,cd_setor_atendimento_w);
DBMS_SQL.DEFINE_COLUMN(C04,17,cd_motivo_baixa_w);
DBMS_SQL.DEFINE_COLUMN(C04,18,cd_pessoa_fisica_w,10);
DBMS_SQL.DEFINE_COLUMN(C04,19,cd_procedencia_w);
DBMS_SQL.DEFINE_COLUMN(C04,20,nr_seq_agenda_w);
DBMS_SQL.DEFINE_COLUMN(C04,21,ie_lado_w,1);
DBMS_SQL.DEFINE_COLUMN(C04,22,ie_tipo_atendimento_w);
DBMS_SQL.DEFINE_COLUMN(C04,23,cd_convenio_w);
DBMS_SQL.DEFINE_COLUMN(C04,24,nr_sequencia_w);
DBMS_SQL.DEFINE_COLUMN(C04,25,dt_prescricao_w);
DBMS_SQL.DEFINE_COLUMN(C04,26,dt_liberacao_w);
DBMS_SQL.DEFINE_COLUMN(C04,27,dt_inicio_exame_w);
DBMS_SQL.DEFINE_COLUMN(C04,28,dt_baixa_w);
DBMS_SQL.DEFINE_COLUMN(C04,29,nr_seq_exame_w);
DBMS_SQL.DEFINE_COLUMN(C04,30,cd_material_exame_w,20);
DBMS_SQL.DEFINE_COLUMN(C04,31,cd_funcionario_w,10);
DBMS_SQL.DEFINE_COLUMN(C04,32,nr_seq_motivo_antecipacao_w);
DBMS_SQL.DEFINE_COLUMN(C04,33,cd_medico_prescr_w,10);
DBMS_SQL.DEFINE_COLUMN(C04,34,cd_anestesista_w,10);
DBMS_SQL.DEFINE_COLUMN(C04,35,nr_seq_contraste_w);
DBMS_SQL.DEFINE_COLUMN(C04,36,cd_intervalo_w,7);
DBMS_SQL.DEFINE_COLUMN(C04,37,cd_profissional_w,10);
DBMS_SQL.DEFINE_COLUMN(C04,38,ie_paciente_isolado_w,1);
DBMS_SQL.DEFINE_COLUMN(C04,39,cd_procedimento_conta_w);
DBMS_SQL.DEFINE_COLUMN(C04,40,ie_origem_proced_conta_w);
DBMS_SQL.DEFINE_COLUMN(C04,41,ds_procedimento_w,255);
DBMS_SQL.DEFINE_COLUMN(C04,42,ds_material_especial_w,240);
DBMS_SQL.DEFINE_COLUMN(C04,43,dt_cancelamento_w);
DBMS_SQL.DEFINE_COLUMN(C04,44,cd_setor_paciente_w);
DBMS_SQL.DEFINE_COLUMN(C04,45,nr_seq_senha_pac_fila_w);
DBMS_SQL.DEFINE_COLUMN(C04,46,dt_liberacao_laudo_w);
DBMS_SQL.DEFINE_COLUMN(C04,47,nm_usuario_laudo_w,15);
DBMS_SQL.DEFINE_COLUMN(C04,48,dt_laudo_w);
DBMS_SQL.DEFINE_COLUMN(C04,49,nm_usuario_aprovacao_w,15);
DBMS_SQL.DEFINE_COLUMN(C04,50,nm_usuario_seg_aprov_w,15);
DBMS_SQL.DEFINE_COLUMN(C04,51,dt_impressao_w);
DBMS_SQL.DEFINE_COLUMN(C04,52,dt_procedimento_w);
DBMS_SQL.DEFINE_COLUMN(C04,53,nm_usuario_original_w,15);
DBMS_SQL.DEFINE_COLUMN(C04,54,qt_procedimento_w);
DBMS_SQL.DEFINE_COLUMN(C04,55,nr_doc_convenio_w,20);
DBMS_SQL.DEFINE_COLUMN(C04,56,cd_medico_prev_laudo_w,20);
DBMS_SQL.DEFINE_COLUMN(C04,57,dt_entrega_w);
DBMS_SQL.DEFINE_COLUMN(C04,58,ie_recem_nato_w,2);
DBMS_SQL.DEFINE_COLUMN(C04,59,dt_liberacao_medico_w);
DBMS_SQL.DEFINE_COLUMN(C04,60,cd_estabelecimento_prescr_w,10);
DBMS_SQL.DEFINE_COLUMN(C04,61,nr_seq_pepo_w,20);
DBMS_SQL.DEFINE_COLUMN(C04,62,qt_peso_w);
DBMS_SQL.DEFINE_COLUMN(C04,63,nm_usuario_prescr_medica_w,15);
DBMS_SQL.DEFINE_COLUMN(C04,64,nm_usuario_origin_prescr_w,15);
DBMS_SQL.DEFINE_COLUMN(C04,65,nr_seq_locate_w,20);
DBMS_SQL.DEFINE_COLUMN(C04,66,nr_controle_w,15);
DBMS_SQL.DEFINE_COLUMN(C04,67,ds_dado_clinico_w,255);
DBMS_SQL.DEFINE_COLUMN(C04,68,cd_categoria_w,80);
DBMS_SQL.DEFINE_COLUMN(C04,69,ds_forma_entrega_laudo_w,80);
DBMS_SQL.DEFINE_COLUMN(C04,70,ds_cor_entrega_laudo_w,80);
DBMS_SQL.DEFINE_COLUMN(C04,71,ds_exame_anterior_w,150);
DBMS_SQL.DEFINE_COLUMN(C04,72,ie_prioridade_classif_w);
DBMS_SQL.DEFINE_COLUMN(C04,73,ds_prioridade_classif_w,60);
DBMS_SQL.DEFINE_COLUMN(C04,74,cor_prioridade_classif_w,15);
DBMS_SQL.DEFINE_COLUMN(C04,75,ds_prioridade_w,80);
DBMS_SQL.DEFINE_COLUMN(C04,76,ds_cor_prioridade_w,80);
DBMS_SQL.DEFINE_COLUMN(C04,77,nr_seq_mot_anteci_result_w,120);
DBMS_SQL.DEFINE_COLUMN(C04,78,ie_prioridade_w);
DBMS_SQL.DEFINE_COLUMN(C04,79,ds_classif_urgencia_w,80);
DBMS_SQL.DEFINE_COLUMN(C04,80,ds_triagem_w,60);
DBMS_SQL.DEFINE_COLUMN(C04,81,ds_cor_urgencia_w,15);
DBMS_SQL.DEFINE_COLUMN(C04,82,ie_prior_classif_atend_w);
DBMS_SQL.DEFINE_COLUMN(C04,83,ds_clinica_w,255);
DBMS_SQL.DEFINE_COLUMN(C04,84,ds_cor_fonte_urgencia_w,15);
DBMS_SQL.DEFINE_COLUMN(C04,85,ds_breve_local_w,100);
DBMS_SQL.DEFINE_COLUMN(C04,86,nr_prioridade_triagem_w);
DBMS_SQL.DEFINE_COLUMN(C04,87,dt_alta_w);
DBMS_SQL.DEFINE_COLUMN(C04,88,nr_crm_w,15);
DBMS_SQL.DEFINE_COLUMN(C04,89,ds_uf_medico_w,15);
DBMS_SQL.DEFINE_COLUMN(C04,90,ds_exame_lab_w,100);
DBMS_SQL.DEFINE_COLUMN(C04,91,ds_arquivo_w,80);
DBMS_SQL.DEFINE_COLUMN(C04,92,nm_usuario_ditado_w,40);
DBMS_SQL.DEFINE_COLUMN(C04,93,dt_ditado_w);
DBMS_SQL.DEFINE_COLUMN(C04,94,ds_obs_agenda_w,255);
DBMS_SQL.DEFINE_COLUMN(C04,95,ds_motivo_baixa_w,60);
DBMS_SQL.DEFINE_COLUMN(C04,96,ie_exame_cancelado2_w,1);
DBMS_SQL.DEFINE_COLUMN(C04,97,dt_solicit_antecip_w);
DBMS_SQL.DEFINE_COLUMN(C04,98,nm_usu_lib_pat_w,100);
DBMS_SQL.DEFINE_COLUMN(C04,99,dt_usu_lib_pat_w);
DBMS_SQL.DEFINE_COLUMN(C04,100,ie_tumor_w,1);
DBMS_SQL.DEFINE_COLUMN(C04,101,ds_imunohistoquimica_w, 4000);
DBMS_SQL.DEFINE_COLUMN(C04,102,dt_laudo_cancelamento_w);
DBMS_SQL.DEFINE_COLUMN(C04,103,nr_seq_protocolo_w);
DBMS_SQL.DEFINE_COLUMN(C04,104,ds_agenda_w,50);

if (coalesce(ie_exibe_nao_lib_setor_p,'N') = 'N') then
  DBMS_SQL.BIND_VARIABLE(C04,'NM_USUARIO', nm_usuario_p);
end if;

if (cd_executor_p IS NOT NULL AND cd_executor_p::text <> '') then
  DBMS_SQL.BIND_VARIABLE(C04,'CD_MEDICO_EXECUTOR', cd_executor_p);
end if;

if (cd_laudante_p IS NOT NULL AND cd_laudante_p::text <> '') then
  DBMS_SQL.BIND_VARIABLE(C04,'CD_MEDICO_RESP', cd_laudante_p);
end if;

if (cd_medico_prev_laudo_p IS NOT NULL AND cd_medico_prev_laudo_p::text <> '') then
  DBMS_SQL.BIND_VARIABLE(C04,'CD_MEDICO_PREV_LAUDO', cd_medico_prev_laudo_p);
end if;

if (nr_protocolo_p > 0) then
  DBMS_SQL.BIND_VARIABLE(C04,'NR_PROTOCOLO', nr_protocolo_p);
end if;

if (cd_tipo_proced_filtro_p > 0) then
  DBMS_SQL.BIND_VARIABLE(C04,'CD_TIPO_PROCEDIMENTO', cd_tipo_proced_filtro_p);
end if;

if (ie_data_p = 4)  then
  DBMS_SQL.BIND_VARIABLE(C04,'DT_INICIAL', dt_inicial_p);
  DBMS_SQL.BIND_VARIABLE(C04,'DT_FINAL', dt_final_p);
end if;

if (ie_resp_seg_aprov_p = 'S') then

  select  max(cd_pessoa_fisica)
  into STRICT  cd_pessoa_fisica_usuario_w
  from  usuario
  where  nm_usuario = nm_usuario_p;

  DBMS_SQL.BIND_VARIABLE(C04,'CD_RESP_SEG_APROV', cd_pessoa_fisica_usuario_w);
end if;

if (ie_tumor_p IS NOT NULL AND ie_tumor_p::text <> '') then
  DBMS_SQL.BIND_VARIABLE(C04,'IE_TUMOR', ie_tumor_p);
end if;

--insert into temp values (sysdate,9);
retorno_w := DBMS_SQL.execute(C04);
--insert into temp values (sysdate,10);
while( DBMS_SQL.FETCH_ROWS(C04) > 0 ) loop
  begin
  nr_prescricao_w      := null;
  nr_atendimento_w    := null;
  ie_status_execucao_w    := null;
  nr_seq_interno_w    := null;
  ds_status_execucao_w    := null;
  nm_medico_prev_exec_w    := null;
  nm_medico_executor_w    := null;
  nm_medico_laudo_w    := null;
  ds_autorizacao_w    := null;
  ds_procedimento_w    := null;
  ds_motivo_parada_w    := null;
  ds_senha_w      := null;
  ds_setor_atendimento_w    := null;
  ds_motivo_baixa_w    := null;
  ds_setor_paciente_w    := null;
  ds_arquivo_w      := null;
  ds_laudo_ant_w      := null;
  dt_ditado_w      := null;
  ds_procedencia_w    := null;
  dt_inicio_w      := null;
  dt_inicio_agenda_atend_w  := null;
  ds_lado_proced_w    := null;
  ie_mat_med2_w      := null;
  ie_mat_med_setor2_w    := null;
  ds_tipo_atend_w      := null;
  ds_idade_w      := null;
  dt_nascimento_w      := null;
  ds_convenio_w      := null;
  cd_usuario_convenio_w    := null;
  nr_crm_w      := null;
  ds_uf_medico_w      := null;
  ds_senha_laudo_medico_w    := null;
  ds_local_w      := null;
  ie_obs_proced2_w    := null;
  qt_prescrito_w      := null;
  qt_liberado_w      := null;
  qt_exame_w      := null;
  ds_status_agenda_w    := null;
  ds_exame_lab_w      := null;
  ds_material_exame_w    := null;
  nm_funcionario_executor_w  := null;
  ds_motivo_ant_w      := null;
  nr_acesso_dicom_w    := null;
  nm_usuario_ditado_w    := null;
  ds_email_medico_prescr_w  := null;
  nm_anestesista_w    := null;
  ds_contraste_w      := null;
  ds_intervalo_w      := null;
  nm_profissional_previsto_w  := null;
  ds_tipo_isolamento_cih_w  := null;
  ds_cor_isolamento_cih_w    := null;
  ie_exame_cancelado2_w    := null;
  nr_seq_tipo_isolamento_cih_w  := null;
  ds_proced_conta_w    := null;
  cd_proced_conta_w    := null;
  nm_medico_w      := null;
  ds_solic_externa_w    := null;
  ds_atend_alerta_w    := null;
  qt_vol_hemocomp_w    := null;
  ds_material_especial_w    := null;
  ds_localizacao_laudo_w    := null;
  dt_cancelamento_w    := null;
  cd_setor_paciente_w    := null;
  nr_seq_senha_pac_fila_w  := null;
  dt_liberacao_laudo_w := null;
  nm_usuario_laudo_w := null;
  dt_laudo_w := null;
  nm_usuario_aprovacao_w := null;
  nm_usuario_seg_aprov_w := null;
  dt_impressao_w := null;
  dt_procedimento_w := null;
  nm_usuario_original_w := null;
  qt_procedimento_w := null;
  nr_doc_convenio_w := null;
  cd_medico_prev_laudo_w := null;
  dt_liberacao_w :=null;
  dt_liberacao_final_w :=null;
  dt_prescricao_w := null;
  dt_entrega_w := null;
  ie_recem_nato_w := null;
  dt_liberacao_medico_w := null;
  cd_estabelecimento_prescr_w := null;
  nr_seq_pepo_w := null;
  qt_peso_w := null;
  nm_usuario_prescr_medica_w := null;
  nm_usuario_origin_prescr_w := null;
  nr_seq_locate_w := null;
  cd_setor_atendimento_w := null;
  nr_controle_w := null;
  ds_dado_clinico_w := null;
  cd_categoria_w := null;
  ds_forma_entrega_laudo_w := null;
  ds_cor_entrega_laudo_w := null;
  ds_exame_anterior_w := null;
  ie_prioridade_classif_w := null;
  ds_prioridade_classif_w := null;
  cor_prioridade_classif_w := null;
  ds_prioridade_w := null;
  ds_cor_prioridade_w := null;
  nr_seq_mot_anteci_result_w := null;
  ie_prioridade_w := null;
  ds_classif_urgencia_w := null;
  ds_triagem_w := null;
  ds_cor_urgencia_w := null;
  ie_prior_classif_atend_w := null;
  ds_clinica_w := null;
  ds_cor_fonte_urgencia_w := null;
  ds_breve_local_w := null;
  nr_prioridade_triagem_w := null;
  dt_alta_w := null;
  nr_crm_w := null;
  ds_uf_medico_w := null;
  ds_obs_agenda_w := null;
  ie_exame_cancelado2_w := null;
  ds_motivo_baixa_w := null;
  dt_solicit_antecip_w := null;
  nm_usu_lib_pat_w := null;
  dt_usu_lib_pat_w := null;
  ie_tumor_w := null;
  ds_imunohistoquimica_w := null;
  dt_laudo_cancelamento_w := null;
  nr_seq_protocolo_w := null;
  nr_prioridade_w := null;
  nr_seq_prioridade_w := null;
  nr_seq_medicacao_w := null;
  nr_tmp_execucao_w := null;
  ds_tmp_para_execucao_w := null;
  dt_prazo_execucao_w := null;
  ds_agenda_w := null;

  DBMS_SQL.COLUMN_VALUE(C04,1,nr_prescricao_w);
  DBMS_SQL.COLUMN_VALUE(C04,2,nr_atendimento_w);
  DBMS_SQL.COLUMN_VALUE(C04,3,nr_seq_interno_w);
  DBMS_SQL.COLUMN_VALUE(C04,4,nr_seq_propaci_w);
  DBMS_SQL.COLUMN_VALUE(C04,5,nr_seq_laudo_w);
  DBMS_SQL.COLUMN_VALUE(C04,6,nr_interno_conta_w);
  DBMS_SQL.COLUMN_VALUE(C04,7,ie_status_execucao_w);
  DBMS_SQL.COLUMN_VALUE(C04,8,cd_medico_exec_w);
  DBMS_SQL.COLUMN_VALUE(C04,9,cd_medico_executor_w);
  DBMS_SQL.COLUMN_VALUE(C04,10,cd_medico_resp_w);
  DBMS_SQL.COLUMN_VALUE(C04,11,ie_autorizacao2_w);
  DBMS_SQL.COLUMN_VALUE(C04,12,nr_seq_proc_interno_w);
  DBMS_SQL.COLUMN_VALUE(C04,13,cd_procedimento_w);
  DBMS_SQL.COLUMN_VALUE(C04,14,ie_origem_proced_w);
  DBMS_SQL.COLUMN_VALUE(C04,15,nr_seq_motivo_parada_w);
  DBMS_SQL.COLUMN_VALUE(C04,16,cd_setor_atendimento_w);
  DBMS_SQL.COLUMN_VALUE(C04,17,cd_motivo_baixa_w);
  DBMS_SQL.COLUMN_VALUE(C04,18,cd_pessoa_fisica_w);
  DBMS_SQL.COLUMN_VALUE(C04,19,cd_procedencia_w);
  DBMS_SQL.COLUMN_VALUE(C04,20,nr_seq_agenda_w);
  DBMS_SQL.COLUMN_VALUE(C04,21,ie_lado_w);
  DBMS_SQL.COLUMN_VALUE(C04,22,ie_tipo_atendimento_w);
  DBMS_SQL.COLUMN_VALUE(C04,23,cd_convenio_w);
  DBMS_SQL.COLUMN_VALUE(C04,24,nr_sequencia_w);
  DBMS_SQL.COLUMN_VALUE(C04,25,dt_prescricao_w);
  DBMS_SQL.COLUMN_VALUE(C04,26,dt_liberacao_w);
  DBMS_SQL.COLUMN_VALUE(C04,27,dt_inicio_exame_w);
  DBMS_SQL.COLUMN_VALUE(C04,28,dt_baixa_w);
  DBMS_SQL.COLUMN_VALUE(C04,29,nr_seq_exame_w);
  DBMS_SQL.COLUMN_VALUE(C04,30,cd_material_exame_w);
  DBMS_SQL.COLUMN_VALUE(C04,31,cd_funcionario_w);
  DBMS_SQL.COLUMN_VALUE(C04,32,nr_seq_motivo_antecipacao_w);
  DBMS_SQL.COLUMN_VALUE(C04,33,cd_medico_prescr_w);
  DBMS_SQL.COLUMN_VALUE(C04,34,cd_anestesista_w);
  DBMS_SQL.COLUMN_VALUE(C04,35,nr_seq_contraste_w);
  DBMS_SQL.COLUMN_VALUE(C04,36,cd_intervalo_w);
  DBMS_SQL.COLUMN_VALUE(C04,37,cd_profissional_w);
  DBMS_SQL.COLUMN_VALUE(C04,38,ie_paciente_isolado_w);
  DBMS_SQL.COLUMN_VALUE(C04,39,cd_procedimento_conta_w);
  DBMS_SQL.COLUMN_VALUE(C04,40,ie_origem_proced_conta_w);
  DBMS_SQL.COLUMN_VALUE(C04,41,ds_procedimento_w);
  DBMS_SQL.COLUMN_VALUE(C04,42,ds_material_especial_w);
  DBMS_SQL.COLUMN_VALUE(C04,43,dt_cancelamento_w);
  DBMS_SQL.COLUMN_VALUE(C04,44,cd_setor_paciente_w);
  DBMS_SQL.COLUMN_VALUE(C04,45,nr_seq_senha_pac_fila_w);
  DBMS_SQL.COLUMN_VALUE(C04,46,dt_liberacao_laudo_w);
  DBMS_SQL.COLUMN_VALUE(C04,47,nm_usuario_laudo_w);
  DBMS_SQL.COLUMN_VALUE(C04,48,dt_laudo_w);
  DBMS_SQL.COLUMN_VALUE(C04,49,nm_usuario_aprovacao_w);
  DBMS_SQL.COLUMN_VALUE(C04,50,nm_usuario_seg_aprov_w);
  DBMS_SQL.COLUMN_VALUE(C04,51,dt_impressao_w);
  DBMS_SQL.COLUMN_VALUE(C04,52,dt_procedimento_w);
  DBMS_SQL.COLUMN_VALUE(C04,53,nm_usuario_original_w);
  DBMS_SQL.COLUMN_VALUE(C04,54,qt_procedimento_w);
  DBMS_SQL.COLUMN_VALUE(C04,55,nr_doc_convenio_w);
  DBMS_SQL.COLUMN_VALUE(C04,56,cd_medico_prev_laudo_w);
  DBMS_SQL.COLUMN_VALUE(C04,57,dt_entrega_w);
  DBMS_SQL.COLUMN_VALUE(C04,58,ie_recem_nato_w);
  DBMS_SQL.COLUMN_VALUE(C04,59,dt_liberacao_medico_w);
  DBMS_SQL.COLUMN_VALUE(C04,60,cd_estabelecimento_prescr_w);
  DBMS_SQL.COLUMN_VALUE(C04,61,nr_seq_pepo_w);
  DBMS_SQL.COLUMN_VALUE(C04,62,qt_peso_w);
  DBMS_SQL.COLUMN_VALUE(C04,63,nm_usuario_prescr_medica_w);
  DBMS_SQL.COLUMN_VALUE(C04,64,nm_usuario_origin_prescr_w);
  DBMS_SQL.COLUMN_VALUE(C04,65,nr_seq_locate_w);
  DBMS_SQL.COLUMN_VALUE(C04,66,nr_controle_w);
  DBMS_SQL.COLUMN_VALUE(C04,67,ds_dado_clinico_w);
  DBMS_SQL.COLUMN_VALUE(C04,68,cd_categoria_w);
  DBMS_SQL.COLUMN_VALUE(C04,69,ds_forma_entrega_laudo_w);
  DBMS_SQL.COLUMN_VALUE(C04,70,ds_cor_entrega_laudo_w);
  DBMS_SQL.COLUMN_VALUE(C04,71,ds_exame_anterior_w);
  DBMS_SQL.COLUMN_VALUE(C04,72,ie_prioridade_classif_w);
  DBMS_SQL.COLUMN_VALUE(C04,73,ds_prioridade_classif_w);
  DBMS_SQL.COLUMN_VALUE(C04,74,cor_prioridade_classif_w);
  DBMS_SQL.COLUMN_VALUE(C04,75,ds_prioridade_w);
  DBMS_SQL.COLUMN_VALUE(C04,76,ds_cor_prioridade_w);
  DBMS_SQL.COLUMN_VALUE(C04,77,nr_seq_mot_anteci_result_w);
  DBMS_SQL.COLUMN_VALUE(C04,78,ie_prioridade_w);
  DBMS_SQL.COLUMN_VALUE(C04,79,ds_classif_urgencia_w);
  DBMS_SQL.COLUMN_VALUE(C04,80,ds_triagem_w);
  DBMS_SQL.COLUMN_VALUE(C04,81,ds_cor_urgencia_w);
  DBMS_SQL.COLUMN_VALUE(C04,82,ie_prior_classif_atend_w);
  DBMS_SQL.COLUMN_VALUE(C04,83,ds_clinica_w);
  DBMS_SQL.COLUMN_VALUE(C04,84,ds_cor_fonte_urgencia_w);
  DBMS_SQL.COLUMN_VALUE(C04,85,ds_breve_local_w);
  DBMS_SQL.COLUMN_VALUE(C04,86,nr_prioridade_triagem_w);
  DBMS_SQL.COLUMN_VALUE(C04,87,dt_alta_w);
  DBMS_SQL.COLUMN_VALUE(C04,88,nr_crm_w);
  DBMS_SQL.COLUMN_VALUE(C04,89,ds_uf_medico_w);
  DBMS_SQL.COLUMN_VALUE(C04,90,ds_exame_lab_w);
  DBMS_SQL.COLUMN_VALUE(C04,91,ds_arquivo_w);
  DBMS_SQL.COLUMN_VALUE(C04,92,nm_usuario_ditado_w);
  DBMS_SQL.COLUMN_VALUE(C04,93,dt_ditado_w);
  DBMS_SQL.COLUMN_VALUE(C04,94,ds_obs_agenda_w);
  DBMS_SQL.COLUMN_VALUE(C04,95,ds_motivo_baixa_w);
  DBMS_SQL.COLUMN_VALUE(C04,96,ie_exame_cancelado2_w);
  DBMS_SQL.COLUMN_VALUE(C04,97,dt_solicit_antecip_w);
  DBMS_SQL.COLUMN_VALUE(C04,98,nm_usu_lib_pat_w);
  DBMS_SQL.COLUMN_VALUE(C04,99,dt_usu_lib_pat_w);
  DBMS_SQL.COLUMN_VALUE(C04,100,ie_tumor_w);
  DBMS_SQL.COLUMN_VALUE(C04,101, ds_imunohistoquimica_w);
  DBMS_SQL.COLUMN_VALUE(C04,102, dt_laudo_cancelamento_w);
  DBMS_SQL.COLUMN_VALUE(C04,103, nr_seq_protocolo_w);
  DBMS_SQL.COLUMN_VALUE(C04,104,ds_agenda_w);


if (ie_status_execucao_w <> '20' AND ie_status_execucao_w <> '40')and (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '')
	and (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') 
	and (ds_gerar_prioridade_w = 'S') then
  
	begin

    SELECT  coalesce(max(c.NR_SEQ_REG_PRIOR_PROCED_EXAME),0)
	into STRICT	nr_seq_prioridade_w	
	 FROM   prescr_procedimento a,
			cpoe_procedimento b,
			protocolo_medic_proc c,
			prescr_medica d
	 WHERE  a.nr_seq_proc_cpoe = b.nr_sequencia
	 AND    a.nr_seq_proc_interno = b.nr_seq_proc_interno
	 AND    b.nr_seq_protocolo = c.nr_sequencia
	 AND    b.cd_protocolo = c.cd_protocolo 
	 AND    b.nr_seq_proc_interno = c.nr_seq_proc_interno
	 AND    a.nr_prescricao = nr_prescricao_w
	 AND    a.nr_seq_proc_interno = nr_seq_proc_interno_w
	 AND    d.nr_prescricao = a.NR_PRESCRICAO;

    exception
      when others then
        nr_seq_prioridade_w  := null;
    end;	

	if (nr_seq_prioridade_w IS NOT NULL AND nr_seq_prioridade_w::text <> '') then
		select max(rppe.nr_prioridade),
			max(rppe.nr_tempo_execucao)
		into STRICT nr_prioridade_w,
			nr_tmp_execucao_w
		from reg_prior_proced_exame rppe
		where rppe.nr_sequencia = nr_seq_prioridade_w;		
			
		if (nr_tmp_execucao_w IS NOT NULL AND nr_tmp_execucao_w::text <> '') and (nr_tmp_execucao_w > 0) then

			select ADICIONAR_MINUTOS_DATA(cd_estabelecimento_p, dt_liberacao_w, nr_tmp_execucao_w, 'COR')
			into STRICT dt_prazo_execucao_w
			;
			
			select obter_horas_min(clock_timestamp(), dt_prazo_execucao_w)
			into STRICT ds_tmp_para_execucao_w
			;
			
			if (((clock_timestamp() - dt_prazo_execucao_w)*24*60) > nr_tmp_execucao_w)
				or (((clock_timestamp() - dt_prazo_execucao_w)*24*60) > 0) then
				ds_tmp_para_execucao_w := 0;
			end if;

		end if;
	end if;
  end if;

  if (ie_medico_prescritor_w = 'S') then
    select  substr(max(obter_nome_pf(cd_pessoa_fisica)),1,60)
    into STRICT  nm_medico_w
    from  pessoa_fisica
    where  cd_pessoa_fisica  = cd_medico_prescr_w;
  end if;

  if (ie_status_execucao_w IS NOT NULL AND ie_status_execucao_w::text <> '') then
    select  substr(max(obter_desc_expressao(CD_EXP_VALOR_DOMINIO)),1,80)
    into STRICT  ds_status_execucao_w
    from  valor_dominio_v
    where  cd_dominio  = 1226
    and  vl_dominio  = ie_status_execucao_w;
  end if;

  if (cd_medico_exec_w IS NOT NULL AND cd_medico_exec_w::text <> '') and (IE_MEDICO_PREV_EXEC_W = 'S') THEN
    select  substr(max(nm_pessoa_fisica),1,60)
    into STRICT  nm_medico_prev_exec_w
    from  pessoa_fisica
    where  cd_pessoa_fisica  = cd_medico_exec_w;
  end if;
  if (cd_medico_executor_w IS NOT NULL AND cd_medico_executor_w::text <> '') and (ie_medico_executor_w = 'S') then
    select  substr(max(nm_pessoa_fisica),1,60)
    into STRICT  nm_medico_executor_w
    from  pessoa_fisica
    where  cd_pessoa_fisica  = cd_medico_executor_w;
  end if;

  if (cd_medico_resp_w IS NOT NULL AND cd_medico_resp_w::text <> '') and (ie_medico_laudo_w = 'S') then
    select  substr(nm_pessoa_fisica,1,60)
    into STRICT  nm_medico_laudo_w
    from  pessoa_fisica
    where  cd_pessoa_fisica  = cd_medico_resp_w;
  end if;

  if (ie_autorizacao2_w IS NOT NULL AND ie_autorizacao2_w::text <> '') and (ie_autorizacao_w = 'S') then
		select max(coalesce(substr(ds_valor_dominio_cliente, 1, 30), substr(obter_desc_expressao(cd_exp_valor_dominio), 1, 30)))
    into STRICT  ds_autorizacao_w
    from  valor_dominio_v
     where  cd_dominio  = 1227
    and  vl_dominio  = ie_autorizacao2_w;
  end if;

  if (ie_exibe_libera_autorizacao_p = 'S') and (coalesce(ds_autorizacao_w::text, '') = '') then
    ds_autorizacao_w := substr(wheb_mensagem_pck.get_texto(306334),1,255);--Liberado
  end if;


  if (nr_seq_proc_interno_w > 0) then
    select  substr(ds_proc_exame,1,100)
    into STRICT  ds_procedimento_w
    from  proc_interno
    where  nr_sequencia  = nr_seq_proc_interno_w;

    cd_convenio2_w  := Obter_Convenio_Atendimento(nr_atendimento_w);

    if (ie_nome_interno_p = 'S') and (cd_procedimento_w > 0) and
      ((cd_convenio2_w in (cd_conv_nome_interno_p)) or (coalesce(cd_conv_nome_interno_p::text, '') = '')) then

      if (ie_origem_proced_w = 1) then
        select  substr(ds_procedimento,1,100)
        into STRICT  ds_procedimento2_w
        from  procedimento
        where  cd_procedimento    = cd_procedimento_w
        and  ie_origem_proced  = ie_origem_proced_w;
      else
        select  max(substr(b.ds_procedimento,1,100))
        into STRICT  ds_procedimento2_w
        from  proc_interno_conv a, procedimento b
        where  a.cd_procedimento = b.cd_procedimento
        and  a.ie_origem_proced = b.ie_origem_proced
        and  a.nr_seq_proc_interno  = nr_seq_proc_interno_w
        and  coalesce(a.ie_origem_proc_filtro,a.ie_origem_proced)  = 1
        and  coalesce(a.cd_convenio,cd_convenio2_w)  = cd_convenio2_w;
      end if;

      if (ds_procedimento2_w IS NOT NULL AND ds_procedimento2_w::text <> '') then
        ds_procedimento_w := ds_procedimento2_w;
      end if;
    end if;
  end if;

  if (ie_motivo_parada_w = 'S') and (nr_seq_motivo_parada_w > 0) then
    select  substr(ds_motivo,1,80)
    into STRICT  ds_motivo_parada_w
    from  motivo_laudo_parado
    where  nr_sequencia  = nr_seq_motivo_parada_w;
  end if;

  if (ie_autoriz_senha_w = 'S') then
    ds_senha_w  := substr(Obter_senha_autoriz_proced(nr_prescricao_w,nr_atendimento_w,cd_procedimento_w,ie_origem_proced_w),1,20);
  end if;

  if (ie_setor_atendimento_w = 'S') and (cd_setor_atendimento_w > 0) then
    select  max(substr(ds_setor_atendimento,1,60))
    into STRICT  ds_setor_atendimento_w
    from  setor_atendimento
    where  cd_setor_atendimento  = cd_setor_atendimento_w;
  end if;

  if (ie_setor_paciente_w = 'S') then
    ds_setor_paciente_w  := substr(Obter_setor_ge(ie_opcao_setor_p,nr_prescricao_w,nr_atendimento_w,'D'),1,60);

    if (ds_setor_paciente_w IS NOT NULL AND ds_setor_paciente_w::text <> '') then
       cd_setor_pac_w     := Obter_setor_ge(ie_opcao_setor_p,nr_prescricao_w,nr_atendimento_w,'C');

    end if;

  end if;

  if (ie_laudo_ant_w = 'S') and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
    begin

    select  b.nr_sequencia
    into STRICT   count_w
    from     laudo_paciente b,
      atendimento_paciente a
    where  a.nr_atendimento  = b.nr_atendimento
    and  a.cd_pessoa_fisica  = cd_pessoa_fisica_w
    and  (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')  LIMIT 1;

    exception
      when others then
        count_w  := 0;
    end;

    if (count_w > 0) then
      ds_laudo_ant_w := 'S';
    else
      ds_laudo_ant_w := 'N';
    end if;
  end if;
--20 Subs
  if (ie_procedencia_w = 'S') and (cd_procedencia_w > 0) then
    select  substr(ds_procedencia,1,40)
    into STRICT  ds_procedencia_w
    from  procedencia
    where  cd_procedencia  = cd_procedencia_w;
  end if;

  if (ie_inicio_agenda_w = 'S') then
  begin
    select coalesce(pp.nr_seq_agenda, pm.nr_seq_agenda),
    pp.cd_procedimento
  into STRICT nr_seq_agenda_pp_w,
  cd_procedimento_pp_w
  from prescr_procedimento pp,
  prescr_medica pm
  where  pp.nr_prescricao  = nr_prescricao_w
    and  pp.nr_sequencia  = nr_sequencia_w
    and  pm.nr_prescricao = pp.nr_prescricao;

  if (nr_seq_agenda_pp_w IS NOT NULL AND nr_seq_agenda_pp_w::text <> '') then
      select ap.hr_inicio
    into STRICT dt_inicio_w
    from agenda_paciente ap
    where ap.nr_sequencia = nr_seq_agenda_pp_w
     and (
           (ap.cd_procedimento =  cd_procedimento_pp_w)
           or
	         (
             (
              SELECT count(b.nr_sequencia) 
              from agenda_integrada_item a, ageint_exame_adic_item b
              where a.nr_sequencia = b.nr_seq_item
              and a.nr_seq_agenda_exame = ap.nr_sequencia
             ) > 0
           )
           or
           (
             (
              SELECT count(a.nr_sequencia) 
              from AGENDA_PACIENTE_PROC a
              where a.nr_sequencia  = ap.nr_sequencia
             ) > 0           
           )
           
         )
    and ap.ie_status_agenda <>'C';
    else
    dt_inicio_w := null;
  end if;

    exception
      when others then
        dt_inicio_w := null;
  end;
  end if;

  if (ie_inicio_agenda_atend_w = 'S') then
    begin
  select coalesce(Obter_Horario_item_Ageint(nr_seq_agenda_cons, nr_Seq_Agenda_exame,nr_sequencia),qt_obter_horario_agendado(nr_sequencia))
  into STRICT dt_inicio_agenda_atend_w
  from agenda_integrada_item
  where nr_prescricao = nr_prescricao_w
  and nr_sequencia_prescricao = nr_sequencia_w;

    exception
      when others then
        dt_inicio_agenda_atend_w := null;
    end;
  end if;

  if (ie_lado_proced_w = 'S') and (ie_lado_w IS NOT NULL AND ie_lado_w::text <> '') then
    select  max(substr(obter_desc_expressao(CD_EXP_VALOR_DOMINIO),1,30))
    into STRICT  ds_lado_proced_w
    from  valor_dominio_v
    where  cd_dominio  = 1372
    and  vl_dominio  = ie_lado_w;

  end if;

  if (ie_mat_med_w = 'S') and (nr_atendimento_w > 0) then
    select  coalesce(max('S'),'N')
    into STRICT  ie_mat_med2_w
    from  material_atend_paciente
    where  nr_atendimento = nr_atendimento_w;
  end if;

  if (ie_mat_med_setor_w = 'S') and (nr_atendimento_w > 0) and (cd_setor_atendimento_w > 0) then
    select  /*+ INDEX(A MATPACI_ATEPACI_FK_I) */        CASE WHEN Count(1)=0 THEN  'N'  ELSE 'S' END
       into STRICT ie_mat_med_setor2_w
    from  material_atend_paciente a
    where  nr_atendimento    = nr_atendimento_w
     AND  CD_SETOR_ATENDIMENTO  = CD_SETOR_ATENDIMENTO_W
     AND  coalesce(CD_MOTIVO_EXC_CONTA::text, '') = ''  LIMIT 1;
  end if;

  if (ie_tipo_atend_w = 'S') and (ie_tipo_atendimento_w > 0) then
    select max(coalesce(ds_valor_dominio_cliente,substr(obter_desc_expressao(cd_exp_valor_dominio),1,60)))
    into STRICT  ds_tipo_atend_w
    from  valor_dominio_v
    where  vl_dominio  = ie_tipo_atendimento_w
          and  cd_dominio  = 12;
  end if;

  if (ie_idade_w = 'S')  and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
    select  dt_nascimento,
      coalesce(dt_obito,clock_timestamp())
    into STRICT  dt_nascimento_w,
      dt_otito_w
    from  pessoa_fisica
    where  cd_pessoa_fisica  = cd_pessoa_fisica_w;

    if (ie_idade_w = 'S') then
      ds_idade_w  := substr(obter_idade(dt_nascimento_w,dt_otito_w,'AM'),1,60);
    end if;
  end if;

  if (ie_nascimento_w = 'S') and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
    select  dt_nascimento
    into STRICT  dt_nascimento_w
    from  pessoa_fisica
    where  cd_pessoa_fisica  = cd_pessoa_fisica_w;
  end if;

  if (ie_convenio_w = 'S') then

    ie_conv_conta_proc_w := Obter_Param_Usuario(942, 286, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_conv_conta_proc_w);

    if (coalesce(cd_convenio_w,0) = 0) then
      if (coalesce(ie_conv_conta_proc_w,'N') = 'S') then

        select  coalesce(max(cd_convenio),0)
        into STRICT  cd_convenio_w
        from  procedimento_paciente
        where  nr_prescricao = nr_prescricao_w
        and  nr_sequencia_prescricao = nr_sequencia_w;
        if (cd_convenio_w = 0) then
          cd_convenio_w  := Obter_Convenio_Atendimento(nr_atendimento_w);
        end if;
      else
        cd_convenio_w  := Obter_Convenio_Atendimento(nr_atendimento_w);
      end if;
    else
      if (coalesce(ie_conv_conta_proc_w,'N') = 'S') then

        select  coalesce(max(cd_convenio),0)
        into STRICT  cd_convenio_w
        from  procedimento_paciente
        where  nr_prescricao = nr_prescricao_w
        and  nr_sequencia_prescricao = nr_sequencia_w;
      end if;
    end if;

    if (cd_convenio_w > 0) then
      select  substr(ds_convenio,1,255)
      into STRICT  ds_convenio_w
      from  convenio
      where  cd_convenio  = cd_convenio_w;
    end if;
  end if;
  if (ie_usuario_convenio_w = 'S') then
    begin
    select  /*+ index (a ATECACO_I3) */      cd_usuario_convenio
    into STRICT  cd_usuario_convenio_w
    from  Atend_categoria_convenio
    where  nr_seq_interno  = obter_atecaco_atendimento(nr_atendimento_w);
    exception
      when others then
        cd_usuario_convenio_w  := null;
    end;
  end if;
  if (ie_senha_laudo_medico_w = 'S') and (cd_medico_resp_w IS NOT NULL AND cd_medico_resp_w::text <> '') then
    select coalesce(max(ds_senha_laudo),null)
    into STRICT  ds_senha_laudo_medico_w
    from  usuario
    where  cd_pessoa_fisica = cd_medico_resp_w;
  end if;
  if (ie_local_paciente_w = 'S') then

    cd_classif_setor_w := obter_classif_setor(cd_setor_atendimento_w);

    if (ie_somente_setor_classif_pa_p = 'S') and (cd_classif_setor_w = 5)  then
      cd_classif_setor_w := 0;
    end if;

    select  max(CASE WHEN cd_classif_setor_w=1 THEN  substr(obter_nome_setor(cd_setor_atendimento_w) || ' ' || obter_desc_abrev_local_pa(nr_seq_local_pa),1,80) WHEN cd_classif_setor_w=5 THEN  CASE WHEN coalesce(nr_seq_local_pa::text, '') = '' THEN  substr(obter_unidade_atendimento(nr_atendimento_w, 'IAA', 'SU'),1,80)  ELSE substr(obter_nome_setor(cd_setor_atendimento_w) || ' ' || obter_desc_abrev_local_pa(nr_seq_local_pa),1,80) END   ELSE substr(obter_unidade_atendimento(nr_atendimento_w, 'IAA', 'SU'),1,80) END ) ds_local
    into STRICT  ds_local_w
    from  atendimento_paciente
    where   nr_atendimento = nr_atendimento_w;

  end if;
  if (cd_setor_paciente_w IS NOT NULL AND cd_setor_paciente_w::text <> '') then
    select  max(CASE WHEN obter_classif_setor(cd_setor_paciente_w)=1 THEN          substr(obter_nome_setor(cd_setor_paciente_w) || ' ' || obter_desc_abrev_local_pa(nr_seq_local_pa),1,80) WHEN obter_classif_setor(cd_setor_paciente_w)=5 THEN  CASE WHEN coalesce(nr_seq_local_pa::text, '') = '' THEN  substr(obter_unidade_atendimento(nr_atendimento_w, 'IAA', 'SU'),1,80)  ELSE substr(obter_nome_setor(cd_setor_paciente_w) || ' ' || obter_desc_abrev_local_pa(nr_seq_local_pa),1,80) END   ELSE substr(obter_unidade_atendimento(nr_atendimento_w, 'IAA', 'SU'),1,80) END ) ds_local_paciente
    into STRICT  ds_local_paciente_w
    from  atendimento_paciente
    where   nr_atendimento = nr_atendimento_w;
  end if;

--40 sub
  if (ie_obs_proced_w = 'S') then
    select  CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
    into STRICT  ie_obs_proced2_w
    from  prescr_procedimento_obs
    where  nr_prescricao    = nr_prescricao_w
    and  nr_seq_prescricao  = nr_sequencia_w;
  end if;
  if (ie_qt_prescrito_w = 'S') and (dt_prescricao_w IS NOT NULL AND dt_prescricao_w::text <> '') then
    qt_prescrito_w  := obter_minutos_espera(dt_prescricao_w, dt_liberacao_w);
  end if;
  if (ie_qt_liberado_w = 'S') and (dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '') then
    qt_liberado_w  := obter_minutos_espera(dt_liberacao_w, dt_inicio_exame_w);
  end if;
  if (ie_qt_exame_w = 'S') and (dt_inicio_exame_w IS NOT NULL AND dt_inicio_exame_w::text <> '') then
    qt_exame_w  := obter_minutos_espera(dt_inicio_exame_w, dt_baixa_w);
  end if;
  if (ie_status_agenda_w = 'S') and (nr_seq_agenda_w > 0) then
    select  max(substr(obter_desc_expressao(b.CD_EXP_VALOR_DOMINIO),1,200))
    into STRICT  ds_status_agenda_w
    from  valor_dominio_v b,
      agenda_paciente a
    where  a.ie_status_agenda  = b.vl_dominio
    and  a.nr_sequencia    = nr_seq_agenda_w
    and  b.cd_dominio    = 83;
  end if;
  if (ie_material_exame_w = 'S') and (cd_material_exame_w IS NOT NULL AND cd_material_exame_w::text <> '') then
    select  max(substr(ds_material_exame,1,80))
    into STRICT  ds_material_exame_w
    from  material_exame_lab
    where  cd_material_exame  = cd_material_exame_w;
  end if;
  if (ie_func_executor_w = 'S') and (cd_funcionario_w IS NOT NULL AND cd_funcionario_w::text <> '') then
    select  substr(nm_pessoa_fisica,1,60)
    into STRICT  nm_funcionario_executor_w
    from  pessoa_fisica
    where  cd_pessoa_fisica  = cd_funcionario_w;
  end if;
  if (ie_motivo_ant_w = 'S') and (nr_seq_motivo_antecipacao_w > 0) then
    select   max(substr(ds_motivo_ant,1,90))
    into STRICT  ds_motivo_ant_w
    from  motivo_antecipacao_result
    where  nr_sequencia = nr_seq_motivo_antecipacao_w;
  end if;
  if (ie_acesso_dicom_w = 'S') then
    nr_acesso_dicom_w  := Obter_nr_acesso_dicom(nr_prescricao_w,nr_sequencia_w,nr_seq_propaci_w);
  end if;
  if (ie_email_medico_prescr_w = 'S') and (cd_medico_prescr_w IS NOT NULL AND cd_medico_prescr_w::text <> '') then
    select  max(substr(ds_email,1,60))
    into STRICT  ds_email_medico_prescr_w
    from  compl_pessoa_fisica
    where  cd_pessoa_fisica  = cd_medico_prescr_w
    and  ie_tipo_complemento  = 2;
  end if;
  if (ie_anestesista_w = 'S') and (cd_anestesista_w IS NOT NULL AND cd_anestesista_w::text <> '') then
    select  substr(nm_pessoa_fisica,1,60)
    into STRICT  nm_anestesista_w
    from  pessoa_fisica
    where  cd_pessoa_fisica  = cd_anestesista_w;
  end if;
  if (ie_contraste_w = 'S') and (nr_seq_contraste_w > 0) then
    select   max(ds_contraste)
    into STRICT   ds_contraste_w
    from   proc_interno_contraste
    where   nr_sequencia = nr_seq_contraste_w;
  end if;
  if (ie_intervalo_w = 'S') and (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') then
    select   max(ds_prescricao)
    into STRICT   ds_intervalo_w
    from   intervalo_prescricao
    where   cd_intervalo  = cd_intervalo_w;
  end if;
  if (ie_prof_previsto_w = 'S') and (cd_profissional_w IS NOT NULL AND cd_profissional_w::text <> '') then
    select  nm_pessoa_fisica
    into STRICT  nm_profissional_previsto_w
    from  pessoa_fisica
    where  cd_pessoa_fisica  = cd_profissional_w;
  end if;
  if (ie_tipo_isolamento_cih_w = 'S') and (nr_atendimento_w > 0) and (ie_paciente_isolado_w = 'S') then
    ds_tipo_isolamento_cih_w  := substR(obter_tipos_isolamentos_cih(nr_atendimento_w,'D'),1,255);
  end if;
  if  ((ie_cor_isolamento_cih_w = 'S') or (ie_seq_tipo_isolamento_cih_w = 'S')) and (nr_atendimento_w > 0) and (ie_paciente_isolado_w = 'S') then
    nr_seq_tipo_isolamento_cih_w  := obter_tipo_isolamento_cih(nr_atendimento_w);
    if (ie_cor_isolamento_cih_w = 'S') and (nr_seq_tipo_isolamento_cih_w > 0) then
      select  max(ds_cor)
      into STRICT  ds_cor_isolamento_cih_w
      from  cih_tipo_isolamento
      where  nr_sequencia  = nr_seq_tipo_isolamento_cih_w;
    end if;
  end if;

  --60 sub
  if (ie_ds_proced_conta_w = 'S') and (cd_procedimento_conta_w > 0) and (ie_origem_proced_conta_w > 0) then
    select  substr(ds_procedimento,1,150)
    into STRICT  ds_proced_conta_w
    from  procedimento
    where  cd_procedimento  = cd_procedimento_conta_w
    and  ie_origem_proced= ie_origem_proced_conta_w;
  end if;
  if (ie_cd_proced_conta_w = 'S') then
    cd_proced_conta_w := to_char(cd_procedimento_conta_w);
  end if;

  if (ie_solic_externa_w = 'S') then
    select  CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
    into STRICT   ds_solic_externa_w
    from  laudo_paciente_reg_result a
    where  a.nr_prescricao = nr_prescricao_w
    and  a.nr_seq_prescr = nr_sequencia_w;
  end if;

  if (ie_atend_alerta_w = 'S') then
    select  CASE WHEN coalesce(obter_se_mostra_alerta(cd_pessoa_fisica_w,nr_atendimento_w)::text, '') = '' THEN 'N'  ELSE 'S' END
    into STRICT  ds_atend_alerta_w
;
  end if;

  if (ie_qt_vol_hemocomp_w = 'S') then
    select  coalesce(max(qt_vol_hemocomp),0)
    into STRICT  qt_vol_hemocomp_w
    from  prescr_procedimento
    where  nr_prescricao  = nr_prescricao_w
    and  nr_sequencia  = nr_sequencia_w;
  end if;

  if (ie_ds_localizacao_laudo_w = 'S') and (coalesce(nr_seq_laudo_w,0) > 0) then
    ds_localizacao_laudo_w  := substr(obter_localizacao_laudo(nr_seq_laudo_w),1,240);
  end if;

  if (ie_possui_hist_w = 'S') then

    select   CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
    into STRICT  possui_hist_w
    from  prescr_procedimento_hist
    where  nr_prescricao     = nr_prescricao_w
    and  nr_seq_procedimento   = nr_sequencia_w
    and  ie_situacao     = 'A';

  end if;
  if (ie_dt_impressao_imagem_w = 'S') then
    dt_impressao_imagem_w := obter_data_impressao_imagem(nr_prescricao_w, nr_sequencia_w);
  end if;

  if (ie_ie_solicitacao_exame_w = 'S') then
    ie_solicitacao_exame_w := coalesce(substr(obter_se_exame_complementar(nr_prescricao_w,nr_sequencia_w),1,1),'N');
  end if;

  if (ie_nr_crm_prescrito_w = 'S') then
    select  coalesce(substr(max(obter_crm_medico(cd_pessoa_fisica)), 1, 255),'')
    into STRICT  nr_crm_prescrito_w
    from  medico
    where  cd_pessoa_fisica  = cd_medico_prescr_w;
  end if;

  if (ie_ie_subamostra_exec_w = 'S') then
    ie_subamostra_exec_w := substr(Obter_Se_SubAmostra_Exec(nr_prescricao_w, nr_sequencia_w),1,1);
  end if;
  if (ie_ds_setor_local_w = 'S') and (coalesce(nr_seq_laudo_w,0) > 0) then
    ds_setor_local_w := substr(Obter_setor_localizacao_laudo(nr_seq_laudo_w),1,255);
  end if;
  if (ie_nr_reserva_w = 'S') or (ie_nr_transfusao_w = 'S') then
    nr_reserva_w := obter_codigo_reserva(nr_prescricao_w);
  end if;
  if (ie_nr_transfusao_w = 'S') then
    nr_transfusao_w := obter_codigo_transfusao(nr_reserva_w);
  end if;
  if (ie_ds_peca_principal_w = 'S') then
    ds_peca_principal_w := substr(obter_desc_peca_principal(nr_prescricao_w, nr_sequencia_w),1,255);
  end if;

  if (ie_medico_laudo_reg_w = 'S')  then

    select   max(substr(obter_nome_pf(cd_medico),1,255))
    into STRICT   nm_medico_laudo_reg_w
    from   laudo_paciente_reg_result
    where  nr_sequencia = (SELECT max(nr_sequencia)
          from   laudo_paciente_reg_result
          where  nr_prescricao = nr_prescricao_w
          and  nr_seq_prescr = nr_sequencia_w);

  end if;

  if (ie_pago_ww = 'S') then
    ie_pago_w  := substr(obter_se_valores_pendente_ge(cd_pessoa_fisica_w, nr_atendimento_w, cd_estabelecimento_p, 'N', 1),1,1);
  end if;


  if (ie_ds_motivo_atraso_w = 'S') then

    select  max(ds_motivo_atraso)
    into STRICT  ds_motivo_atraso_w
    from  laudo_motivo_atraso b,
      prescr_procedimento a
    where  b.nr_sequencia = a.nr_seq_motivo_atraso
    and  a.nr_prescricao  = nr_prescricao_w
    and  a.nr_sequencia  = nr_sequencia_w;

  end if;

  --80 sub
  if (ie_possui_evento_ww = 'S') then

    select  CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
    into STRICT  ie_possui_evento_w
    from    qua_evento_paciente
    where   nr_atendimento = nr_atendimento_w
    and  (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
    and  coalesce(dt_inativacao::text, '') = '';
  end if;

  if (ie_ds_contraste_conta_w = 'S') then
    open C03;
    loop
    fetch C03 into
      ds_contraste_conta_w;
    EXIT WHEN NOT FOUND; /* apply on C03 */
      null;
    end loop;
    close C03;
  end if;


  if (ie_qt_filme_w = 'S') then
  qt_filme_w := null;
    open C05;
    loop
    fetch C05 into
      qt_filme_w;
    EXIT WHEN NOT FOUND; /* apply on C05 */
      null;
    end loop;
    close C05;

    if (coalesce(qt_filme_w::text, '') = '') then

      select  max(qt_filme)
      into STRICT  qt_filme_w
      from  procedimento_paciente
      where  nr_sequencia =  nr_seq_propaci_w;
    end if;

  end if;

  select CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
  into STRICT  ie_imagem_entregue_w
  from  prescr_proc_info_laudo
  where nr_prescricao = nr_prescricao_w
  and    nr_seq_prescr  = nr_sequencia_w
  and    ie_entrega_imagem = 'S';

  if (ie_pessoa_entrega_imagem_w = 'S') then
    select  max(coalesce(obter_nome_pf(cd_pessoa_recebido), nm_pessoa_externo))
    into STRICT    nm_pessoa_recebido_w
    from    prescr_proc_info_laudo
    where   nr_prescricao = nr_prescricao_w
    and      nr_seq_prescr  = nr_sequencia_w
    and      ie_entrega_imagem = 'S';
  end if;

  if (ie_ds_profissional_pref_w = 'S') then
    select   substr(max(obter_nome_pf(b.cd_profissional_pref)),1,200)
    into STRICT  ds_profissional_pref_w
    from     prescr_medica a,
      agenda_paciente b
    where    a.nr_prescricao = nr_prescricao_w
    and      a.nr_seq_agenda = b.nr_sequencia;
  end if;

  if (ie_ds_status_sr_w = 'S') then

    SELECT   substr(MAX(b.ds_status),1,200),
      max(b.ie_entrada_sr),
      max(b.ie_saida_sr)
    into STRICT  ds_status_sr_w,
      ie_entrada_sr_w,
      ie_saida_sr_w
    FROM   PRESCR_PROCEDIMENTO_HIST a,
      PRESCR_PROC_HIST_STATUS b
    WHERE   a.nr_seq_prescr_status_hist = b.nr_sequencia
    AND  a.dt_evento = (SELECT MAX(x.dt_evento)
              FROM prescr_procedimento_hist x
              WHERE x.nr_prescricao = a.nr_prescricao
              AND  ((b.ie_entrada_sr = 'S') OR (b.ie_saida_sr = 'S'))
              AND x.nr_seq_procedimento = a.nr_seq_procedimento)
    AND  a.nr_prescricao = nr_prescricao_w
    AND  a.nr_seq_procedimento = nr_sequencia_w;

    if (ie_entrada_sr_w = 'S') then
      ds_cor_fundo_status_sr_w := 'E';
    end if;

    if (ie_saida_sr_w = 'S') then
      ds_cor_fundo_status_sr_w := 'S';
    end if;

  end if;

  if (ie_dt_status_sr_w = 'S') then

    SELECT   MAX(a.dt_evento)
    into STRICT  dt_status_sr_w
    FROM   PRESCR_PROCEDIMENTO_HIST a,
      PRESCR_PROC_HIST_STATUS b
    WHERE   a.nr_seq_prescr_status_hist = b.nr_sequencia
    AND  a.dt_evento = (SELECT MAX(x.dt_evento)
              FROM prescr_procedimento_hist x
              WHERE x.nr_prescricao = a.nr_prescricao
              AND  ((b.ie_entrada_sr = 'S') OR (b.ie_saida_sr = 'S'))
              AND x.nr_seq_procedimento = a.nr_seq_procedimento)
    AND  a.nr_prescricao = nr_prescricao_w
    AND  a.nr_seq_procedimento = nr_sequencia_w;

  end if;

  if (ie_dt_hora_agenda_w = 'S') then

    select   coalesce(max(nr_seq_proc_excl),0)
    into STRICT  nr_seq_proc_exclui_w
    from  prescr_procedimento
    where   nr_prescricao = nr_prescricao_w
    and    nr_sequencia = nr_sequencia_w;

    if (nr_seq_proc_exclui_w = 0) then
      begin

      SELECT  max(coalesce(Obter_Horario_item_Ageint(a.nr_seq_agenda_cons, a.nr_Seq_Agenda_exame,a.nr_sequencia),qt_obter_horario_agendado(a.nr_sequencia)))
      into STRICT  dt_hora_agenda_w
      FROM  agenda_integrada_item a
      WHERE  a.nr_prescricao = nr_prescricao_w
      and    a.nr_sequencia_prescricao = nr_sequencia_w;

      if (coalesce(dt_hora_agenda_w::text, '') = '') then

        select   max(dt_prevista)
        into STRICT  dt_hora_agenda_w
        from    ageint_exame_lab a,
              agenda_integrada_item b
        where   a.nr_seq_ageint = b.nr_seq_agenda_int
        and     b.nr_prescricao = nr_prescricao_w;

      end if;

      end;
    else
      begin

      SELECT  max(coalesce(Obter_Horario_item_Ageint(a.nr_seq_agenda_cons, a.nr_Seq_Agenda_exame,a.nr_sequencia),qt_obter_horario_agendado(a.nr_sequencia)))
      into STRICT  dt_hora_agenda_w
      FROM  agenda_integrada_item a,
          prescr_procedimento b
      WHERE  b.nr_seq_interno = nr_seq_proc_exclui_w
      and    b.nr_prescricao = a.nr_prescricao
      and    b.nr_sequencia = a.nr_sequencia_prescricao;

      end;
    end if;

  end if;

  if (ie_ds_categoria_convenio_w = 'S') then

    select  coalesce(max(b.ds_categoria),'')
    into STRICT  ds_categoria_convenio_w
    from     atend_categoria_convenio a,
      categoria_convenio b
    where  b.cd_convenio     = a.cd_convenio
    and  b.cd_categoria     = a.cd_categoria
    and  a.nr_seq_interno  = obter_atecaco_atendimento(nr_atendimento_w);

  end if;

  if (ie_senha_fila_w = 'S') then
    ds_senha_pac_fila_w := substr(obter_dados_senha(nr_seq_senha_pac_fila_w, 'LC'),1,255);
  end if;


  select COUNT(*)
  into STRICT qt_proc_int_exec_w
  from gestao_exame_v
  where nr_atendimento = nr_atendimento_w
  and nr_prescricao = nr_prescricao_w
  and nr_seq_proc_interno = nr_seq_proc_interno_w
  and cd_procedimento = cd_procedimento_w;

  if (qt_proc_int_exec_w = 0 or obtain_user_locale(nm_usuario_p) not in ('de_AT', 'de_DE')) then

    insert into w_gestao_exame(
      nr_prescricao,
      nr_atendimento,
      nr_seq_interno,
      nr_seq_propaci,
      nr_seq_laudo,
      nr_interno_conta,
      ie_status_execucao,
      ds_status_execucao,
      nm_medico,
      nm_medico_prev_exec,
      nm_medico_executor,
      nm_medico_laudo,
      ds_autorizacao,
      ds_procedimento,
      ds_motivo_parada,
      ds_senha,
      ds_setor_atendimento,
      ds_motivo_baixa,
      ds_setor_paciente,
      ds_arquivo,
      ie_laudo_ant,
      dt_ditado,
      ds_procedencia,
      dt_inicio,
      dt_inicio_agenda_atend,
      ds_lado_proced,
      ie_mat_med,
      ie_mat_med_setor,
      ds_tipo_atend,
      ds_idade,
      dt_nascimento,
      ds_convenio,
      cd_usuario_convenio,
      nr_crm,
      ds_uf_medico,
      ds_senha_laudo_medico,
      ds_local,
      ie_obs_proced,
      qt_prescrito,
      qt_liberado,
      qt_exame,
      ds_status_agenda,
      ds_exame_lab,
      ds_material_exame,
      nm_funcionario_executor,
      ds_motivo_ant,
      nr_acesso_dicom,
      nm_usuario_ditado,
      ds_email_medico_prescr,
      nm_anestesista,
      ds_contraste,
      ds_intervalo,
      nm_profissional_previsto,
      ds_tipo_isolamento_cih,
      ds_cor_isolamento_cih,
      ie_exame_cancelado,
      nr_seq_tipo_isolamento_cih,
      ds_proced_conta,
      cd_proced_conta,
      ie_solic_externa,
      ie_atend_alerta,
      qt_vol_hemocomp,
      ds_breve_local,
      ds_material_especial,
      ds_localizacao_laudo,
      dt_cancelamento,
      ds_local_paciente,
      ie_imagem_entregue,
      ie_possui_hist,
      dt_impressao_imagem,
      ie_solicitacao_exame,
      dt_alta,
      nr_crm_prescrito,
      nm_usu_lib_pat,
      dt_usu_lib_pat,
      ie_subamostra_exec,
      ds_setor_local,
      nr_reserva,
      nr_transfusao,
      ds_peca_principal,
      nm_medico_laudo_reg,
      ie_pago,
      ds_motivo_atraso,
      ds_obs_agenda,
      ie_possui_evento,
      ds_contraste_conta,
      qt_filme,
      nm_pessoa_receb_img,
      nr_prioridade_triagem,
      ds_profissional_pref,
      ds_status_sr,
      dt_status_sr,
      ds_cor_status_sr,
      dt_agenda_integrada,
      ds_categoria_convenio,
      ds_senha_pac_fila,
      dt_solicit_antecip,
      cd_setor_pac,
      dt_liberacao_laudo,
      nm_usuario_laudo,
      dt_laudo,
      nm_usuario_aprovacao,
      nm_usuario_seg_aprov,
      dt_impressao,
      cd_medico_executor,
      dt_procedimento,
      nm_usuario_original,
      nr_doc_convenio,
      qt_procedimento,
      cd_medico_prev_laudo,
      dt_liberacao_prescricao,
      dt_prescricao,
      dt_entrega,
      cd_pessoa_fisica_prescr_medica,
      ie_recem_nato,
      dt_liberacao_medico,
      cd_medico_prescricao,
      cd_estabelecimento_prescricao,
      nr_seq_pepo,
      qt_peso,
      nm_usuario_prescr_medica,
      nm_usuario_origin_prescr,
      nr_seq_locate,
      cd_setor_atendimento,
      nr_controle,
      ds_dado_clinico,
      cd_categoria,
      ds_forma_entrega_laudo,
      ds_cor_entrega_laudo,
      ds_exame_anterior,
      ie_prioridade_classif,
      ds_prioridade_classif,
      cor_prioridade_classif,
      ds_prioridade,
      ds_cor_prioridade,
      nr_seq_mot_anteci_result,
      ie_prioridade,
      ds_classif_urgencia,
      ds_triagem,
      ds_cor_urgencia,
      nr_seq_proced,
      ie_prior_classif_atend,
      ds_clinica,
      ds_cor_fonte_urgencia,
      ie_tumor,
      ds_imunohistoquimica,
      dt_laudo_cancelamento,
      ds_agenda,
      cd_prioridade,
      ds_tmp_para_execucao)
    Values (  nr_prescricao_w,
      nr_atendimento_w,
      nr_seq_interno_w,
      nr_seq_propaci_w,
      nr_seq_laudo_w,
      nr_interno_conta_w,
      ie_status_execucao_w,
      ds_status_execucao_w,
      nm_medico_w,
      nm_medico_prev_exec_w,
      nm_medico_executor_w,
      nm_medico_laudo_w,
      ds_autorizacao_w,
      substr(ds_procedimento_w,1,100),
      ds_motivo_parada_w,
      ds_senha_w,
      ds_setor_atendimento_w,
      ds_motivo_baixa_w,
      ds_setor_paciente_w,
      ds_arquivo_w,
      ds_laudo_ant_w,
      dt_ditado_w,
      ds_procedencia_w,
      dt_inicio_w,
      dt_inicio_agenda_atend_w,
      ds_lado_proced_w,
      ie_mat_med2_w,
      ie_mat_med_setor2_w,
      ds_tipo_atend_w,
      ds_idade_w,
      dt_nascimento_w,
      ds_convenio_w,
      cd_usuario_convenio_w,
      nr_crm_w,
      ds_uf_medico_w,
      ds_senha_laudo_medico_w,
      ds_local_w,
      ie_obs_proced2_w,
      qt_prescrito_w,
      qt_liberado_w,
      qt_exame_w,
      ds_status_agenda_w,
      ds_exame_lab_w,
      ds_material_exame_w,
      nm_funcionario_executor_w,
      ds_motivo_ant_w,
      nr_acesso_dicom_w,
      nm_usuario_ditado_w,
      ds_email_medico_prescr_w,
      nm_anestesista_w,
      ds_contraste_w,
      ds_intervalo_w,
      nm_profissional_previsto_w,
      ds_tipo_isolamento_cih_w,
      ds_cor_isolamento_cih_w,
      ie_exame_cancelado2_w,
      nr_seq_tipo_isolamento_cih_w,
      ds_proced_conta_w,
      cd_proced_conta_w,
      ds_solic_externa_w,
      ds_atend_alerta_w,
      qt_vol_hemocomp_w,
      ds_breve_local_w,
      ds_material_especial_w,
      ds_localizacao_laudo_w,
      dt_cancelamento_w,
      ds_local_paciente_w,
      ie_imagem_entregue_w,
      possui_hist_w,
      dt_impressao_imagem_w,
      ie_solicitacao_exame_w,
      dt_alta_w,
      nr_crm_prescrito_w,
      nm_usu_lib_pat_w,
      dt_usu_lib_pat_w,
      ie_subamostra_exec_w,
      ds_setor_local_w,
      nr_reserva_w,
      nr_transfusao_w,
      ds_peca_principal_w,
      nm_medico_laudo_reg_w,
      ie_pago_w,
      ds_motivo_atraso_w,
      ds_obs_agenda_w,
      ie_possui_evento_w,
      ds_contraste_conta_w,
      qt_filme_w,
      nm_pessoa_recebido_w,
      nr_prioridade_triagem_w,
      ds_profissional_pref_w,
      ds_status_sr_w,
      dt_status_sr_w,
      ds_cor_fundo_status_sr_w,
      dt_hora_agenda_w,
      ds_categoria_convenio_w,
      ds_senha_pac_fila_w,
      dt_solicit_antecip_w,
      cd_setor_pac_w,
      dt_liberacao_laudo_w,
      nm_usuario_laudo_w,
      dt_laudo_w,
      nm_usuario_aprovacao_w,
      nm_usuario_seg_aprov_w,
      dt_impressao_w,
      cd_medico_executor_w,
      dt_procedimento_w,
      nm_usuario_original_w,
      nr_doc_convenio_w,
      qt_procedimento_w,
      cd_medico_prev_laudo_w,
      dt_liberacao_w,
      dt_prescricao_w,
      dt_entrega_w,
      cd_pessoa_fisica_w,
      ie_recem_nato_w,
      dt_liberacao_medico_w,
      cd_medico_prescr_w,
      cd_estabelecimento_prescr_w,
      nr_seq_pepo_w,
      qt_peso_w,
      nm_usuario_prescr_medica_w,
      nm_usuario_origin_prescr_w,
      nr_seq_locate_w,
      cd_setor_atendimento_w,
      nr_controle_w,
      ds_dado_clinico_w,
      cd_categoria_w,
      ds_forma_entrega_laudo_w,
      ds_cor_entrega_laudo_w,
      ds_exame_anterior_w,
      ie_prioridade_classif_w,
      ds_prioridade_classif_w,
      cor_prioridade_classif_w,
      ds_prioridade_w,
      ds_cor_prioridade_w,
      nr_seq_mot_anteci_result_w,
      ie_prioridade_w,
      ds_classif_urgencia_w,
      ds_triagem_w,
      ds_cor_urgencia_w,
      nr_sequencia_w,
      ie_prior_classif_atend_w,
      ds_clinica_w,
      ds_cor_fonte_urgencia_w,
      ie_tumor_w,
      ds_imunohistoquimica_w,
      dt_laudo_cancelamento_w,
      ds_agenda_w,
      nr_prioridade_w,
      ds_tmp_para_execucao_w);

  end if;

  end;
END LOOP;



DBMS_SQL.CLOSE_CURSOR(C04);
--insert into temp values ('Andrey3 - '||ds_comando_w,

--                         obter_usuario_ativo,

--                         sysdate,

--                        5);

--insert into temp values (sysdate,11);
commit;
--insert into temp values (sysdate,5);commit;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_gestao_exame ( cd_estabelecimento_p bigint, cd_perfil_p bigint, cd_setor_atendimento_p bigint, cd_setor_prescricao_p bigint, ie_status_execucao_p text, ie_status_exec_p text, ie_data_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, nr_prescricao_p bigint, nr_atendimento_p bigint, cd_paciente_p text, cd_prescritor_p text, cd_executor_prev_p text, cd_executor_p text, cd_laudante_p text, cd_medico_prev_laudo_p text, cd_motivo_baixa_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_proc_interno_p bigint, nr_protocolo_p bigint, nr_exame_p text, nm_ditador_p text, ie_somente_pendente_p text, ie_somente_antecipado_p text, ie_somente_com_exame_p text, ie_laudo_normal_p text, ie_somente_sem_alta_p text, ie_somente_com_alta_p text, ie_somente_setor_p text, ie_somente_lib_p text, ie_somente_suspensos_p text, ie_somente_justif_baixa_p text, ie_exame_complementar_p text, ie_exige_lib_enf_p text, cd_tipo_proced_padrao_p text, cd_tipo_proced_filtro_p bigint, nr_acesso_dicom_p text, ie_opcao_setor_p text, ds_filtros_p text, ds_filtros_geral_p text, ie_exige_lib_tecnica_p text, nm_usuario_p text, ie_status_patologia_p text, ie_somente_com_exames_p text, ie_proced_bloqueado_p text, ie_somente_cancelados_p text, ie_status_ind_comple_p text, ie_nome_interno_p text, ie_acm_sn_aprazado_p text, ie_somente_proc_anest_p text, ie_somente_setor_classif_pa_p text, cd_conv_nome_interno_p text, nr_exame_lote_p bigint, ie_aprovacao_execucao_p text, ie_agrupa_patologia_conta_p text, cg_cgc_laboratorio_p text, ie_exibe_libera_autorizacao_p text, ie_resp_seg_aprov_p text, ie_somente_nao_cancelados_p text, ie_exibe_nao_lib_setor_p text, ie_exibe_refazer_exame_p text, ie_exibe_agendamento_ageint_p text, ie_somente_mat_medic_assoc_p text, ie_somente_beira_leito_p text, ie_tumor_p text) is ds_sep_bv_w varchar(50) FROM PUBLIC;

