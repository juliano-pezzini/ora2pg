-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cancelar_agenda_equipamento_hc ( nr_atendimento_p bigint, nm_usuario_p text, dt_alteracao_p timestamp default clock_timestamp()) AS $body$
DECLARE


nr_seq_equipamento_w	bigint;
nr_seq_agenda_hc_w	bigint;
nr_seq_atend_ext_w	bigint;

c01 CURSOR FOR


	SELECT	b.nr_sequencia
	from	paciente_home_care a,
		hc_pac_equipamento b
	where	b.nr_seq_paciente = a.nr_sequencia
	and	((coalesce(b.dt_fim_utilizacao::text, '') = '') or (b.dt_fim_utilizacao > clock_timestamp())) /*Ajustado para considerar tambem os equipamentos com data fim utilização superior à data atual*/
	and	a.nr_atendimento_origem = nr_atendimento_p;

C02 CURSOR FOR
	SELECT	b.nr_sequencia
	from	paciente_home_care a,
		agenda_hc_paciente b
	where	b.nr_seq_paciente_hc = a.nr_sequencia
	and	b.ie_status_agenda = 'A'
	and	a.nr_atendimento_origem = nr_atendimento_p;

C03 CURSOR FOR
	SELECT	a.nr_sequencia
	from	paciente_hc_atend_ext a,
		paciente_home_care b
	where	coalesce(dt_alta::text, '') = ''
	and	a.nr_seq_paciente = b.nr_sequencia
	and	b.nr_atendimento_origem = nr_atendimento_p;


BEGIN
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then

	open c01;
	loop
	fetch c01 into
		nr_seq_equipamento_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		update  hc_pac_equipamento
		set	dt_fim_utilizacao = dt_alteracao_p
		where	nr_sequencia = nr_seq_equipamento_w;

	end loop;
	close c01;


	open C02;
	loop
	fetch C02 into
		nr_seq_agenda_hc_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		update  agenda_hc_paciente
		set	ie_status_agenda = 'C'
		where	nr_sequencia = nr_seq_agenda_hc_w;

		end;
	end loop;
	close C02;

	open C03;
	loop
	fetch C03 into
		nr_seq_atend_ext_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin

		update	paciente_hc_atend_ext
		set	dt_alta = dt_alteracao_p
		where	nr_sequencia = nr_seq_atend_ext_w;

		end;
	end loop;
	close C03;

	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cancelar_agenda_equipamento_hc ( nr_atendimento_p bigint, nm_usuario_p text, dt_alteracao_p timestamp default clock_timestamp()) FROM PUBLIC;

