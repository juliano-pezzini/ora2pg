-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_atendimento_qep_setores (nr_atendimento_p bigint, cd_setor_atendimento_p bigint, nm_computador_p text, nr_seq_que_atendimento_p INOUT text) AS $body$
DECLARE

 
ie_entrou_cursor_w	varchar(1) := 'N';

C01 CURSOR FOR 
	SELECT	a.cd_setor_atendimento, 
		a.ds_setor_atendimento 
	from	setor_atendimento a, 
		qep_setor_computador b, 
		computador c 
	where	b.nr_seq_computador = c.nr_sequencia 
	and	a.cd_setor_atendimento = b.cd_setor_atendimento 
	and	upper(c.nm_computador) = upper(nm_computador_p) 
	and	coalesce(c.ie_situacao,'A') = 'A';
	
c01_w	c01%rowtype;

nr_seq_que_atendimento_w	que_atendimento.nr_sequencia%type;
ds_retorno_w			varchar(4000);


BEGIN 
 
open C01;
loop 
fetch C01 into	 
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	ie_entrou_cursor_w := 'S';
	 
	nr_seq_que_atendimento_w := gerar_atendimento_QEP(nr_atendimento_p, c01_w.cd_setor_atendimento, nr_seq_que_atendimento_w);
 
	if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then 
		ds_retorno_w	:= ds_retorno_w || ',';
	end if;
	 
	ds_retorno_w	:= ds_retorno_w || nr_seq_que_atendimento_w;
	end;
end loop;
close C01;
 
if (ie_entrou_cursor_w = 'N') then 
	nr_seq_que_atendimento_w := gerar_atendimento_QEP(nr_atendimento_p, cd_setor_atendimento_p, nr_seq_que_atendimento_w);
	ds_retorno_w	:= nr_seq_que_atendimento_w;
end if;
 
nr_seq_que_atendimento_p := ds_retorno_w;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_atendimento_qep_setores (nr_atendimento_p bigint, cd_setor_atendimento_p bigint, nm_computador_p text, nr_seq_que_atendimento_p INOUT text) FROM PUBLIC;

