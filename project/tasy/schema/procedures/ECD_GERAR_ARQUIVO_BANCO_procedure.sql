-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ecd_gerar_arquivo_banco (nr_seq_controle_sped_p bigint, nm_usuario_p text) AS $body$
DECLARE


arq_texto_w			utl_file.file_type;
ds_arquivo_w			varchar(4000);
ds_arquivo_compl_w		varchar(4000);
cd_estabelecimento_w		smallint;
ds_diretorio_w			varchar(255);
nm_arquivo_w			varchar(255);
dt_inicio_w			varchar(10);
qt_contador_w			bigint	:= 0;
cd_registro_w			varchar(15);
nr_linha_w			bigint;
ds_longo_w			text;
ds_erro_w			varchar(2000);
ds_mensagem_w			varchar(4000);

C01 CURSOR FOR
SELECT	cd_registro,
	ds_arquivo,
	ds_arquivo_compl,
	nr_linha,
	ds_longo
from	ctb_sped_registro
where	nr_seq_controle_sped	= nr_seq_controle_sped_p
order by	nr_linha;

-- O parâmetro do banco utl_file_dir deverá estar com valor "*" para que o arquivo possa ser gerado em qualquer diretório do servidor.
BEGIN

select	cd_estabelecimento,
	to_char(dt_ref_inicial,'ddmmyyyy')
into STRICT	cd_estabelecimento_w,
	dt_inicio_w
from	ctb_sped_controle
where	nr_sequencia = nr_seq_controle_sped_p;

nm_arquivo_w 		:= ('ArquivoECD' || dt_inicio_w || '.txt');
CALL gravar_processo_longo('Carregando informações ' || nm_arquivo_w,'ECD_GERAR_ARQUIVO_BANCO',qt_contador_w);
--Parametro 1: diretório a ser gravado o arquivo
--Parametro 2: nome_do_arquivo a ser gerado
begin

select 	substr(ds_local,1,255) ds_local
into STRICT   	ds_diretorio_w
from 	evento_tasy_utl_file
where 	cd_evento = 25
and 	cd_funcao = 923
and 	ie_tipo = 'G'  LIMIT 1;

arq_texto_w := utl_file.fopen(ds_diretorio_w,nm_arquivo_w,'W');
exception when others then
	ds_erro_w	:= substr(sqlerrm(SQLSTATE),1,2000);

	if (coalesce(ds_diretorio_w::text, '') = '') then
	    ds_diretorio_w := wheb_mensagem_pck.get_texto(803111);
	end if;

	CALL wheb_mensagem_pck.exibir_mensagem_abort(803107, 'DS_DIRETORIO=' || ds_diretorio_w || ';' ||
							'DS_ERRO=' || ds_erro_w);
		/*Não foi possível criar o arquivo no diretório do banco de dados.
		Verifique se o recurso de UTL_FILE foi ativado corretamente, se o diretório configurado na regra (SHIFT + F11 )  Sistema/Usuário/Eventos gravação/leitura de arquivos (UTL_FILE) é o mesmo que foi configurado pelo DBA.
		Verifique também se existe permissão para o Oracle gravar o arquivo no diretório selecionado.
		Diretório informado na regra: #@DS_DIRETORIO#@
		Detalhes técnicos: #@DS_ERRO#@*/
end;

open C01;
loop
fetch C01 into
	cd_registro_w,
	ds_arquivo_w,
	ds_arquivo_compl_w,
	nr_linha_w,
	ds_longo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	qt_contador_w	:= nr_linha_w;
	CALL gravar_processo_longo('Gerando arquivo' || cd_registro_w || '-' || nm_arquivo_w ,'ECD_GERAR_ARQUIVO_BANCO',qt_contador_w);
	if (cd_registro_w = 'J800') then
		begin
		utl_file.put_line(arq_texto_w,substr(ds_arquivo_w,1,6) || ds_longo_w || '|J800FIM|' || chr(13));
		utl_file.fflush(arq_texto_w);
		end;
	else
		begin
		utl_file.put_line(arq_texto_w,ds_arquivo_w || chr(13));
		utl_file.fflush(arq_texto_w);
		end;
	end if;
end loop;
close C01;
	--fecha e libera o arquivo
utl_file.fclose(arq_texto_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ecd_gerar_arquivo_banco (nr_seq_controle_sped_p bigint, nm_usuario_p text) FROM PUBLIC;

