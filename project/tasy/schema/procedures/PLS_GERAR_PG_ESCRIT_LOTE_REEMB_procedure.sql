-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_pg_escrit_lote_reemb ( nr_seq_lote_reemb_cred_p pls_lote_reemb_credito.nr_sequencia%type, nm_usuario_p text) AS $body$
DECLARE


nr_seq_conta_banco_w		pls_lote_reemb_credito.nr_seq_conta_banco%type;
dt_geracao_pag_escrit_w		pls_lote_reemb_credito.dt_geracao_pag_escrit%type;
cd_banco_w			banco_estabelecimento.cd_banco%type;
cd_estabelecimento_w		pls_lote_reemb_credito.cd_estabelecimento%type;
nr_seq_banco_escrit_w		banco_escritural.nr_sequencia%type;

c01 CURSOR(nr_seq_lote_reemb_cred_pc		pls_lote_reemb_credito.nr_sequencia%type) FOR
	SELECT	a.nr_titulo
	from	titulo_pagar a,
		pls_protocolo_conta b
	where	a.nr_seq_reembolso		= b.nr_sequencia
	and	a.ie_situacao 			= 'A'
	and	b.nr_seq_lote_reemb_cred	= nr_seq_lote_reemb_cred_pc;

BEGIN

select	a.nr_seq_conta_banco,
	a.cd_estabelecimento,
	a.dt_geracao_pag_escrit
into STRICT	nr_seq_conta_banco_w,
	cd_estabelecimento_w,
	dt_geracao_pag_escrit_w
from	pls_lote_reemb_credito a
where	a.nr_sequencia = nr_seq_lote_reemb_cred_p;

if (dt_geracao_pag_escrit_w IS NOT NULL AND dt_geracao_pag_escrit_w::text <> '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(307377);
end if;

select	a.cd_banco

into STRICT	cd_banco_w

from	banco_estabelecimento a
where	a.nr_sequencia = nr_seq_conta_banco_w;

if (coalesce(cd_banco_w::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(307160);
end if;

select 	nextval('banco_escritural_seq')
into STRICT	nr_seq_banco_escrit_w
;

insert into banco_escritural(nr_sequencia, cd_estabelecimento, dt_atualizacao_nrec,
	nm_usuario_nrec, dt_atualizacao, nm_usuario,
	nr_seq_conta_banco, cd_banco, dt_remessa_retorno,
	ie_remessa_retorno, ie_cobranca_pagto)
values (nr_seq_banco_escrit_w, cd_estabelecimento_w, clock_timestamp(),
	nm_usuario_p, clock_timestamp(), nm_usuario_p,
	nr_seq_conta_banco_w, cd_banco_w, trunc(clock_timestamp(),'dd'),
	'R', 'C');

for r_c01_w in c01(nr_seq_lote_reemb_cred_p) loop
	CALL GERAR_TITULO_ESCRITURAL(r_c01_w.nr_titulo, nr_seq_banco_escrit_w, nm_usuario_p);
end loop;

update 	pls_lote_reemb_credito
set	nr_seq_banco_escrit 	= nr_seq_banco_escrit_w,
	dt_geracao_pag_escrit	= clock_timestamp(),
	dt_atualizacao		= clock_timestamp(),
	nm_usuario		= nm_usuario_p
where	nr_sequencia		= nr_seq_lote_reemb_cred_p;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_pg_escrit_lote_reemb ( nr_seq_lote_reemb_cred_p pls_lote_reemb_credito.nr_sequencia%type, nm_usuario_p text) FROM PUBLIC;

