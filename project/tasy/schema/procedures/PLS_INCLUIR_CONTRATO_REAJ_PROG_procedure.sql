-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_incluir_contrato_reaj_prog ( nr_seq_lote_p bigint, nr_contrato_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


dt_reajuste_w			timestamp;
dt_mes_reajuste_final_w		timestamp;
dt_inicio_analise_w		timestamp;
dt_fim_analise_w		timestamp;
ie_preco_w			pls_prog_reaj_colet_lote.ie_preco%type;
ie_tipo_contratacao_w		pls_prog_reaj_colet_lote.ie_tipo_contratacao%type;
ie_regulamentacao_w		pls_prog_reaj_colet_lote.ie_regulamentacao%type;
qt_vidas_inicial_w		pls_prog_reaj_colet_lote.qt_vidas_inicial%type;
qt_vidas_final_w		pls_prog_reaj_colet_lote.qt_vidas_final%type;
ie_tipo_data_vidas_w		pls_prog_reaj_colet_lote.ie_tipo_data_vidas%type;
nr_seq_indice_reajuste_w	pls_prog_reaj_colet_lote.nr_seq_indice_reajuste%type;
nr_seq_grupo_relac_reaj_w	pls_prog_reaj_colet_lote.nr_seq_grupo_relac_reaj%type;
tx_sinistralidade_inicial_w	pls_prog_reaj_colet_lote.tx_sinistralidade_inicial%type;
tx_sinistralidade_final_w	pls_prog_reaj_colet_lote.tx_sinistralidade_final%type;
ie_reajustar_copartic_w		pls_prog_reaj_colet_lote.ie_reajustar_copartic%type;
dt_reajuste_mes_w		bigint;
dt_reajuste_mes_final_w		bigint;
qt_contrato_w			integer;
ds_mes_reajuste_w		varchar(2);
dt_rescisao_w			timestamp;
nr_seq_outro_lote_w		pls_prog_reaj_colet_lote.nr_sequencia%type;
qt_produto_contrato_w		integer;
nr_seq_grupo_relac_reajuste_w	pls_grupo_contrato.nr_sequencia%type;
dt_reajuste_contrato_w		timestamp;
dt_qt_vidas_w			timestamp;
qt_vidas_contrato_w		integer;
ie_reajustar_benef_cancelado_w	pls_parametros.ie_reajustar_benef_cancelado%type;
vl_resultado_mensalidade_w	double precision;
vl_resultado_despesa_w		double precision;
tx_sinistralidade_w		double precision;
tx_resultado_w			pls_prog_reaj_coletivo.tx_resultado_grupo%type;
tx_sinistralidade_ideal_w	pls_contrato_inf_reajuste.tx_sinistralidade_ideal%type;
nr_seq_prog_reaj_w		pls_prog_reaj_coletivo.nr_sequencia%type;
nr_seq_contrato_w		pls_contrato.nr_sequencia%type;

/* Obs 1: foi acordado com o analista que para os contratos incluidos manualmente as regras de excecao (tabela PLS_PROG_REAJ_EXCECAO) nao precisarao ser verificadas */


/* Obs 2: esta procedure foi feita com base na procedure PLS_GERAR_PROGR_REAJUSTE_CONTR que e a responsavel por incluir os contratos automaticamente */

BEGIN

select	max(nr_sequencia)
into STRICT	nr_seq_contrato_w
from	pls_contrato
where	nr_contrato = nr_contrato_p;

select	trunc(dt_mes_reajuste,'Month'),
	coalesce(dt_mes_reajuste_final,dt_mes_reajuste),
	dt_inicio_analise,
	dt_fim_analise,
	ie_preco,
	ie_tipo_contratacao,
	ie_regulamentacao,
	qt_vidas_inicial,
	qt_vidas_final,
	coalesce(ie_tipo_data_vidas,'A'),
	nr_seq_indice_reajuste,
	nr_seq_grupo_relac_reaj,
	tx_sinistralidade_inicial,
	tx_sinistralidade_final,
	coalesce(ie_reajustar_copartic,'N')
into STRICT	dt_reajuste_w,
	dt_mes_reajuste_final_w,
	dt_inicio_analise_w,
	dt_fim_analise_w,
	ie_preco_w,
	ie_tipo_contratacao_w,
	ie_regulamentacao_w,
	qt_vidas_inicial_w,
	qt_vidas_final_w,
	ie_tipo_data_vidas_w,
	nr_seq_indice_reajuste_w,
	nr_seq_grupo_relac_reaj_w,
	tx_sinistralidade_inicial_w,
	tx_sinistralidade_final_w,
	ie_reajustar_copartic_w
from	pls_prog_reaj_colet_lote
where	nr_sequencia = nr_seq_lote_p;

dt_reajuste_mes_w 		:= (to_char(dt_reajuste_w,'mm'))::numeric;
dt_reajuste_mes_final_w		:= (to_char(dt_mes_reajuste_final_w,'mm'))::numeric;

if (coalesce(dt_inicio_analise_w::text, '') = '') and (coalesce(dt_fim_analise_w::text, '') = '') then
	dt_inicio_analise_w	:= add_months(dt_reajuste_w,-12);
	dt_fim_analise_w	:= fim_dia(dt_reajuste_w-1);
end if;

select	count(1)
into STRICT	qt_contrato_w
from	pls_contrato	a
where	a.nr_sequencia = nr_seq_contrato_w
and	(pls_obter_mes_reaj_contrato(a.nr_sequencia,null,'MM'))::numeric  between dt_reajuste_mes_w and dt_reajuste_mes_final_w
and	trunc(a.dt_contrato,'month') < dt_reajuste_w
and	(a.cd_cgc_estipulante IS NOT NULL AND a.cd_cgc_estipulante::text <> '')
and	a.ie_situacao <> '4' --Nao entra contrato cancelado
and	((nr_seq_indice_reajuste = nr_seq_indice_reajuste_w) or (coalesce(nr_seq_indice_reajuste_w::text, '') = ''))
and	not exists (	SELECT 1
			from	pls_reajuste c,
				pls_prog_reaj_colet_lote  d
			where	c.nr_seq_lote_reaj_colet = d.nr_sequencia
			and	trunc(c.dt_reajuste,'MM') = trunc(d.dt_mes_reajuste,'MM')
			and	c.nr_contrato = a.nr_contrato
			and	d.nr_sequencia = nr_seq_lote_p)
and (coalesce(nr_seq_grupo_relac_reaj_w::text, '') = ''
	or	exists (select	1
			from	pls_contrato_grupo x,
				pls_grupo_contrato y
			where	x.nr_seq_grupo = y.nr_sequencia
			and	y.nr_sequencia = nr_seq_grupo_relac_reaj_w
			and	x.nr_seq_contrato  = a.nr_sequencia));
			
if (qt_contrato_w > 0) then
	select	pls_obter_mes_reaj_contrato(a.nr_sequencia,null,'MM') ds_mes_reajuste,
		coalesce(a.dt_rescisao_contrato,a.dt_cancelamento) dt_rescisao
	into STRICT	ds_mes_reajuste_w,
		dt_rescisao_w
	from	pls_contrato	a
	where	a.nr_sequencia = nr_seq_contrato_w;	

	select	max(b.nr_sequencia)
	into STRICT	nr_seq_outro_lote_w
	from	pls_prog_reaj_coletivo		a,
		pls_prog_reaj_colet_lote	b
	where	a.nr_seq_lote = b.nr_sequencia
	and	a.nr_seq_contrato = nr_seq_contrato_w
	and	to_char(b.dt_mes_reajuste,'yyyy') = to_char(dt_reajuste_w,'yyyy')
	and	not exists (	SELECT	1
				from	pls_reajuste
				where	nr_sequencia = a.nr_seq_reajuste
				and	(nr_seq_lote_deflator IS NOT NULL AND nr_seq_lote_deflator::text <> ''));
				
	if (coalesce(nr_seq_outro_lote_w,0) > 0) then
		-- Mensagem: Este contrato nao podera ser incluso porque ele ja esta no lote!
		CALL wheb_mensagem_pck.exibir_mensagem_abort(834376);
	end if;

	select	count(1)
	into STRICT	qt_produto_contrato_w
	from	pls_contrato_plano	a,
		pls_plano		b
	where	a.nr_seq_plano		= b.nr_sequencia
	and	a.nr_seq_contrato	= nr_seq_contrato_w
	and	((coalesce(ie_preco_w::text, '') = '') or (ie_preco_w = b.ie_preco))
	and	((b.ie_tipo_contratacao = ie_tipo_contratacao_w) or (substr(b.ie_tipo_contratacao,1,1) = ie_tipo_contratacao_w) or -- Coletivos
		 (coalesce(ie_tipo_contratacao_w,'T') = 'T')) -- Todos
	and	((b.ie_regulamentacao = ie_regulamentacao_w) or (coalesce(ie_regulamentacao_w::text, '') = ''));


	if (qt_produto_contrato_w = 0) then
		-- Mensagem: Este contrato nao podera ser incluso porque o produto do mesmo nao possui as especificacoes informadas no lote de programacao de contratos!
		CALL wheb_mensagem_pck.exibir_mensagem_abort(834378);
	end if;
	
	if (qt_vidas_inicial_w IS NOT NULL AND qt_vidas_inicial_w::text <> '') or (qt_vidas_final_w IS NOT NULL AND qt_vidas_final_w::text <> '') then
		select	max(b.nr_sequencia)
		into STRICT	nr_seq_grupo_relac_reajuste_w
		from	pls_contrato_grupo a,
			pls_grupo_contrato b
		where	b.nr_sequencia	= a.nr_seq_grupo
		and	a.nr_seq_contrato = nr_seq_contrato_w
		and	b.ie_tipo_relacionamento = '2';

		dt_reajuste_contrato_w := to_date('01/'||ds_mes_reajuste_w||'/'||to_char(dt_reajuste_w,'yyyy'));

		if (ie_tipo_data_vidas_w = 'A') then --Atual
			dt_qt_vidas_w	:= clock_timestamp();
		elsif (ie_tipo_data_vidas_w = 'AC') then --Aniversario do contrato
			dt_qt_vidas_w	:= add_months(dt_reajuste_contrato_w,-12);
		end if;

		dt_qt_vidas_w	:= trunc(dt_qt_vidas_w,'mm');

		if (nr_seq_grupo_relac_reajuste_w IS NOT NULL AND nr_seq_grupo_relac_reajuste_w::text <> '') then
			qt_vidas_contrato_w := pls_obter_qt_vidas_grupo_relac(nr_seq_grupo_relac_reajuste_w, dt_qt_vidas_w);
		else
			select	count(1)
			into STRICT	qt_vidas_contrato_w
			from	pls_segurado
			where	nr_seq_contrato	= nr_seq_contrato_w
			and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
			and (coalesce(dt_rescisao::text, '') = '' or ((dt_rescisao IS NOT NULL AND dt_rescisao::text <> '') and dt_rescisao >= dt_qt_vidas_w))
			and	trunc(dt_contratacao,'mm') <= dt_qt_vidas_w;
		end if;

		if (not qt_vidas_contrato_w between coalesce(qt_vidas_inicial_w, qt_vidas_contrato_w) and coalesce(qt_vidas_final_w,qt_vidas_contrato_w)) then
			-- Mensagem: Este contrato nao podera ser incluso porque a quantidade de vidas informada no lote de programacao nao corresponde a quantidade de vidas do contrato!
			CALL wheb_mensagem_pck.exibir_mensagem_abort(834379);			
		end if;
	end if;
	
	select	max(ie_reajustar_benef_cancelado)
	into STRICT	ie_reajustar_benef_cancelado_w
	from	pls_parametros
	where	cd_estabelecimento = cd_estabelecimento_p;

	ie_reajustar_benef_cancelado_w := coalesce(ie_reajustar_benef_cancelado_w,'N');
	
	if (dt_rescisao_w <= dt_reajuste_w) and (ie_reajustar_benef_cancelado_w not in ('T','C')) then
		-- Mensagem: Este contrato nao podera ser incluso porque ele esta rescindido!
		CALL wheb_mensagem_pck.exibir_mensagem_abort(834380);
	end if;
	
	SELECT * FROM pls_ar_gerar_resultado_pck.obter_sinistralidade(nr_seq_contrato_w, null, null, null, dt_inicio_analise_w, dt_fim_analise_w, null, cd_estabelecimento_p, tx_sinistralidade_w, tx_resultado_w, vl_resultado_mensalidade_w, vl_resultado_despesa_w) INTO STRICT tx_sinistralidade_w, tx_resultado_w, vl_resultado_mensalidade_w, vl_resultado_despesa_w;
			
	if (tx_sinistralidade_w between coalesce(tx_sinistralidade_inicial_w,tx_sinistralidade_w) and coalesce(tx_sinistralidade_final_w,tx_sinistralidade_w)) then
		select	max(tx_sinistralidade_ideal)
		into STRICT	tx_sinistralidade_ideal_w
		from	pls_contrato_inf_reajuste
		where	nr_seq_contrato	= nr_seq_contrato_w;	
			
		select	nextval('pls_prog_reaj_coletivo_seq')
		into STRICT	nr_seq_prog_reaj_w
		;

		insert	into	pls_prog_reaj_coletivo(	nr_sequencia, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
				nr_seq_lote, nr_seq_contrato, vl_receita, vl_despesas, tx_resultado_grupo, tx_sinistralidade, ie_indice_reajuste,
				ie_status, tx_reajuste_copartic, tx_reajuste_copartic_max, tx_reajuste_inscricao,
				dt_reajuste, ie_reajustar_copartic, qt_vidas, dt_reajuste_contrato,
				tx_sinistralidade_ideal, ie_exibir_portal)
			values (	nr_seq_prog_reaj_w, clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p,
				nr_seq_lote_p, nr_seq_contrato_w, vl_resultado_mensalidade_w, vl_resultado_despesa_w, tx_resultado_w, tx_sinistralidade_w, '3',
				'N', 0, 0, 0,
				dt_reajuste_contrato_w, ie_reajustar_copartic_w, qt_vidas_contrato_w, dt_reajuste_contrato_w,
				tx_sinistralidade_ideal_w, 'N');

		CALL pls_consistir_prog_reajuste(nr_seq_prog_reaj_w, null, nr_seq_contrato_w, null, null, 'N', nm_usuario_p);
				
		insert into pls_log_prog_reaj_col(	nr_sequencia, cd_estabelecimento, dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
				nm_usuario_nrec, nr_seq_lote_prog, nr_seq_contrato, ds_mensagem, ie_acao)
			values (	nextval('pls_log_prog_reaj_col_seq'), cd_estabelecimento_p, clock_timestamp(), nm_usuario_p, clock_timestamp(),
				nm_usuario_p, nr_seq_lote_p, nr_seq_contrato_w, wheb_mensagem_pck.get_texto(1187055, 'NR_CONTRATO='||nr_contrato_p), 'I');
	else
		-- Mensagem: Este contrato nao podera ser incluso devido a taxa de sinistralidade(resultado) informada no lote de programacao!		
		CALL wheb_mensagem_pck.exibir_mensagem_abort(834381);
	end if;
else
	/* Mensagem: Este contrato nao podera ser incluso por algum dos seguintes motivos:
			- O ultimo reajuste realizado neste contrato nao corresponde com o periodo de reajuste informado no lote de programacao;
			- A data de contratacao e superior ou igual a data do reajuste informada no lote de programacao;
			- O contrato e de um estipulante Pessoa Fisica;
			- O contrato esta cancelado;
			- O indice de reajuste do contrato e diferente do indice de reajuste informado no lote de programacao;
			- Este contrato ja teve seu reajuste aplicado neste mes;
			- O grupo de relacionamento informado no lote de programacao nao correponde com o grupo em que o contrato esta. */
	CALL wheb_mensagem_pck.exibir_mensagem_abort(834384);
end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_incluir_contrato_reaj_prog ( nr_seq_lote_p bigint, nr_contrato_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

