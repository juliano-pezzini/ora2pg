-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rp_liberar_ausencia_prof (cd_pessoa_fisica_p text, cd_substituto_p text, dt_inicial_P timestamp, dt_final_p timestamp, nr_seq_motivo_licenca_p bigint, nm_usuario_p text, nr_seq_ausencia_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE


ds_motivo_licenca_w		varchar(255);				
nr_seq_agenda_w			agenda_consulta.nr_sequencia%type;
ie_status_agenda_w		varchar(3);
cd_motivo_cancelamento_w	varchar(3);
cd_motivo_cancel_prof_aus_w	varchar(3);

C01 CURSOR FOR
	SELECT	b.nr_sequencia
	from	agenda a,
		agenda_consulta b
	where	a.cd_agenda = b.cd_agenda
	and	a.cd_tipo_agenda = 5
	and	b.cd_medico = cd_pessoa_fisica_p
	and	b.dt_agenda between trunc(dt_inicial_p) and dt_final_p + 86399/86400
	and	((b.nr_seq_rp_mod_item IS NOT NULL AND b.nr_seq_rp_mod_item::text <> '') or (b.nr_seq_rp_item_ind IS NOT NULL AND b.nr_seq_rp_item_ind::text <> ''))
	and	b.ie_status_agenda not in ('C','F','E');

				

BEGIN
	
select 	substr(ds_motivo_licenca,1,255)
into STRICT	ds_motivo_licenca_w
from	rp_motivo_licenca
where	nr_sequencia = nr_seq_motivo_licenca_p;

select	max(ie_status_agenda_prof_aus),
	max(cd_motivo_cancelamento)
into STRICT	ie_status_agenda_w,
	cd_motivo_cancel_prof_aus_w
from	rp_parametros
where	cd_estabelecimento = cd_estabelecimento_p;


update	rp_licenca_profissional
set	dt_liberacao 		= clock_timestamp(),
	nm_usuario_liberacao	= nm_usuario_p
where	nr_sequencia		= nr_seq_ausencia_p;


if (ie_status_agenda_w IS NOT NULL AND ie_status_agenda_w::text <> '') then
	
	if (ie_status_agenda_w	= 'C') then
         	cd_motivo_cancelamento_w	:= cd_motivo_cancel_prof_aus_w;
	else
		cd_motivo_cancelamento_w	:= '';
	end if;
	
	open C01;
	loop
	fetch C01 into	
		nr_seq_agenda_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		
		if (coalesce(cd_substituto_p::text, '') = '') then			
			update	agenda_consulta
			set	ie_status_agenda	= ie_status_agenda_w,
				ds_motivo_status 	= ds_motivo_licenca_w,
				cd_motivo_cancelamento	= cd_motivo_cancelamento_w
			where	nr_sequencia 		= nr_seq_agenda_w;
		end if;
		
		if (cd_substituto_p IS NOT NULL AND cd_substituto_p::text <> '') then			
			update	agenda_consulta
			set	cd_medico = cd_substituto_p
			where	nr_sequencia 		= nr_seq_agenda_w;
		end if;
					
		end;
	end loop;
	close C01;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rp_liberar_ausencia_prof (cd_pessoa_fisica_p text, cd_substituto_p text, dt_inicial_P timestamp, dt_final_p timestamp, nr_seq_motivo_licenca_p bigint, nm_usuario_p text, nr_seq_ausencia_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

