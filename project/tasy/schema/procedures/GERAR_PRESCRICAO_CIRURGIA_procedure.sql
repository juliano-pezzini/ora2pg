-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_prescricao_cirurgia ( cd_kit_material_p bigint, nr_seq_kit_estoque_p bigint, nr_cirurgia_p bigint, nr_seq_agenda_p bigint, ie_origem_inf_p text, nm_usuario_p text, nr_prescricao_p bigint, nr_doc_interno_p bigint, cd_local_estoque_p bigint, cd_funcao_p bigint, cd_perfil_p bigint, cd_medico_p text, nr_doc_interno_aux_p bigint, ie_tipo_doc_interno_p text, ie_tipo_doc_interno_aux_p text, nr_seq_justif_kit_p bigint default null) AS $body$
DECLARE



nr_seq_apresentacao_w		bigint;
cd_convenio_w				integer;
cd_material_w				integer;
qt_material_w				double precision;
nr_seq_prescr_material_w	integer;
nr_agrupamento_w			double precision;
cd_kit_material_w			integer;
nr_seq_componente_w			integer;
cd_material_opcao_w			integer;
qt_idade_w					smallint := 0;
cd_convenio_ww				integer;
cd_estabelecimento_w		smallint;
nr_seq_lote_fornec_w		bigint;
cd_funcao_w					bigint;
nr_doc_interno_w			numeric(20);
nr_doc_interno_aux_w		numeric(20);
nr_atendimento_w			bigint;
nr_seq_reg_kit_w			bigint;
nr_seq_kit_estoque_w		bigint;
qt_existe_w					bigint;
cd_setor_atendimento_w		integer;
nr_cirurgia_w				bigint;
nr_seq_agenda_w				agenda_paciente.nr_sequencia%type;
ie_tipo_convenio_w			smallint;
cd_medico_w					varchar(10);
cd_unidade_medida_w			varchar(30);
hr_prim_horario_w			varchar(05);
ie_via_aplicacao_w			varchar(05);
ie_dispensavel_w			varchar(01);
ds_materiais_w				varchar(255);
cd_fornecedor_w				varchar(14);
cd_fornecedor_ww			varchar(14);
ie_video_w					varchar(1);
ie_tipo_material_w			varchar(3);
cd_categoria_w				varchar(10);
cd_intervalo_w				varchar(7);
ie_duplica_prescr_w			varchar(1);
ie_registra_w				varchar(1);
ie_acumula_w				varchar(01);
ie_gera_kit_w				varchar(01);
ie_gera_opme_w				varchar(01);
ie_utiliza_med_req_w		varchar(1);
ie_gerar_consistido_w		varchar(15) := 'N';
ie_gerar_consistido_param_w	varchar(15) := 'N';
ie_recem_nato_w				varchar(1);
cd_pessoa_fisica_w			varchar(10);
cd_pessoa_fisica_ww			varchar(10);
cd_pessoa_fisica_E_w		varchar(10);
cd_pessoa_fisica_F_w		varchar(10);
ie_sexo_w					varchar(1);
ie_gerado_avulso_w			varchar(1) := 'N';
ie_gerar_kit_w				varchar(1);
ie_gera_prescr_mat_autor_w	varchar(1);
ie_gera_prescr_mat_esp_w	varchar(1);
ie_gerou_itens_w			varchar(1) := 'N';
ie_gerar_consis_kit_proc_w	varchar(1);
ie_somente_consistidos_w	varchar(1);
ie_fornec_consignados_w		varchar(1);
ie_consignado_w				varchar(1);
ie_tipo_saldo_w				varchar(3);
ds_kit_marcado_agenda_w		varchar(255) := null;
ie_vinc_conv_kit_w			varchar(1);
ie_objetivo_w				varchar(1);
qt_dia_w			bigint;

c02 CURSOR FOR
	SELECT	cd_material
	from	componente_kit_opcao
	where	cd_kit_material		= cd_kit_material_w
	and	nr_seq_componente	= nr_seq_componente_w;

c01 CURSOR FOR
	SELECT	9999 nr_seq_apresentacao,
		a.cd_material,
		a.qt_material,
		substr(obter_dados_material_estab(a.cd_material,cd_estabelecimento_w,'UMS'),1,30) cd_unidade_medida_consumo,
		d.ie_via_aplicacao,
		'N' ie_dispensavel,
		0 cd_kit_material,
		0 nr_seq_componente,
		'' cd_fornecedor,
		d.ie_tipo_material,
		CASE WHEN ie_vinc_conv_kit_w='S' THEN coalesce(b.cd_convenio,0)  ELSE 0 END , CASE WHEN ie_vinc_conv_kit_w='S' THEN  b.cd_categoria  ELSE null END , --Adicionada a categoria do convenio a partir do kit estoque - Ronaldo OS 502832.
		'S' ie_duplica_prescr,
		nr_seq_lote_fornec,
		'N'
	from	material d,
		kit_estoque b,
		kit_estoque_comp a
	where (b.nr_sequencia 		= a.nr_seq_kit_estoque)
	and (a.cd_material		= d.cd_material)
	and (a.nr_seq_kit_estoque 	= nr_seq_kit_estoque_p)
	and (coalesce(b.dt_utilizacao::text, '') = '')
	and (coalesce(nr_seq_kit_estoque_p,0) > 0)
	and (coalesce(cd_kit_material_p,0) 	= 0)
	and	coalesce(a.nr_seq_motivo_exclusao::text, '') = ''
	and (d.ie_situacao		= 'A')
	and (b.cd_estabelecimento	= cd_estabelecimento_w)
	and	((ie_somente_consistidos_w = 'N') or (coalesce(a.ie_gerado_barras,'S') = 'S'))
	
union all

	SELECT 	coalesce(b.nr_seq_apresentacao,9999) nr_seq_apresentacao,
		b.cd_material,
		b.qt_material,
		coalesce(b.cd_unidade_medida_prescr, substr(obter_dados_material_estab(b.cd_material,cd_estabelecimento_w,'UMS'),1,30)),
		d.ie_via_aplicacao,
		coalesce(b.ie_dispensavel,'N'),
		b.cd_kit_material,
		b.nr_sequencia,
		b.cd_fornecedor,
		d.ie_tipo_material,
		0, null,
		coalesce(b.ie_duplica_prescr,'S'),
		null,
		'N'
	from 	material d,
		componente_kit b,
		kit_material a
	where (a.cd_kit_material		= b.cd_kit_material)
	and (b.cd_material		= d.cd_material)
	/* and (b.cd_medico is null or b.cd_medico = cd_medico_w) --> rafael em 02/11/2006 os43577 substituido pela linha abaixo */

	and (coalesce(obter_se_utiliza_comp_kit(b.cd_kit_material, b.nr_sequencia, cd_medico_w, nr_cirurgia_w),'S') = 'S')
	and	((b.ie_recem_nato =  coalesce(ie_recem_nato_w, 'A')) or (coalesce(b.ie_recem_nato, 'A') = 'A'))
	and	((coalesce(b.cd_estab_regra::text, '') = '') or (b.cd_estab_regra = cd_estabelecimento_w))
	and 	(b.cd_convenio = cd_convenio_w or (coalesce(b.cd_convenio::text, '') = '') and
					not exists
						(	select	1
							from	componente_kit x
							where	x.ie_situacao	  = 'A'
							and	x.cd_kit_material	= b.cd_kit_material
							and	x.cd_material	  = b.cd_material
							and	x.cd_convenio 	  = cd_convenio_w
							and	((coalesce(x.cd_estab_regra::text, '') = '') or (x.cd_estab_regra = cd_estabelecimento_w))))
	and 	(b.ie_tipo_convenio = ie_tipo_convenio_w or (coalesce(b.ie_tipo_convenio::text, '') = '') and
					not exists
						(	select	1
							from	componente_kit x
							where	x.ie_situacao	  = 'A'
							and	x.cd_kit_material	= b.cd_kit_material
							and	x.cd_material	  = b.cd_material
							and	x.ie_tipo_convenio 	  = ie_tipo_convenio_w
							and	((coalesce(x.cd_estab_regra::text, '') = '') or (x.cd_estab_regra = cd_estabelecimento_w))))
	and (a.cd_kit_material 		= cd_kit_material_p)
	and (coalesce(cd_kit_material_p,0) 	> 0)
	and (coalesce(nr_seq_kit_estoque_p,0)	= 0)
	and (b.ie_situacao			= 'A')
	and (d.ie_situacao			= 'A')
	and (coalesce(a.ie_situacao,'A')		= 'A')
	and (substr(CASE WHEN a.ie_forma_baixa='D' THEN coalesce(b.ie_forma_baixa,'C')  ELSE 'B' END ,1,1) = 'B')
	and (b.ie_video = 'A' or b.ie_video = coalesce(ie_video_w, b.ie_video))
	and (qt_idade_w between coalesce(b.qt_idade_minima,0) and coalesce(qt_idade_maxima,999))
	and	coalesce(b.ie_sexo, coalesce(ie_sexo_w,0))		= coalesce(ie_sexo_w,0) /*thlima - 26/05/2010 - OS 218824 - tratar sexo do paciente com o sexo do componente do kit*/
	
union all

	select	coalesce(b.nr_seq_apresentacao,9999) nr_seq_apresentacao,
		b.cd_material,
		b.qt_material,
		coalesce(b.cd_unidade_medida_prescr, substr(obter_dados_material_estab(b.cd_material,cd_estabelecimento_w,'UMS'),1,30)),
		d.ie_via_aplicacao,
		coalesce(b.ie_dispensavel,'N'),
		c.cd_kit_material,
		b.nr_sequencia,
		b.cd_fornecedor,
		d.ie_tipo_material,
		0, null,
		coalesce(b.ie_duplica_prescr,'S'),
		null,
		'N'
	from 	material d,
		proc_interno c,
		componente_kit b,
		kit_material a
	where (a.cd_kit_material 		= b.cd_kit_material)
	and (b.cd_kit_material 		= c.cd_kit_material)
	and (b.cd_material			= d.cd_material)
	and	((b.ie_recem_nato =  coalesce(ie_recem_nato_w, 'A')) or (coalesce(b.ie_recem_nato, 'A') = 'A'))
	/* and (b.cd_medico is null or b.cd_medico = cd_medico_w) --> rafael em 02/11/2006 os43577 substituido pela linha abaixo */

	and (coalesce(obter_se_utiliza_comp_kit(b.cd_kit_material, b.nr_sequencia, cd_medico_w, nr_cirurgia_w),'S') = 'S')
	and	((coalesce(b.cd_estab_regra::text, '') = '') or (b.cd_estab_regra = cd_estabelecimento_w))
	and 	(b.cd_convenio = cd_convenio_w or (coalesce(b.cd_convenio::text, '') = '') and
					not exists
						(	select	1
							from	componente_kit x
							where	x.ie_situacao	  = 'A'
							and	x.cd_kit_material = b.cd_kit_material
							and	x.cd_material	  = b.cd_material
							and	x.cd_convenio 	  = cd_convenio_w
							and	((coalesce(x.cd_estab_regra::text, '') = '') or (x.cd_estab_regra = cd_estabelecimento_w))))
	and 	(b.ie_tipo_convenio = ie_tipo_convenio_w or (coalesce(b.ie_tipo_convenio::text, '') = '') and
					not exists
						(	select	1
							from	componente_kit x
							where	x.ie_situacao	  = 'A'
							and	x.cd_kit_material = b.cd_kit_material
							and	x.cd_material	  = b.cd_material
							and	x.ie_tipo_convenio 	  = ie_tipo_convenio_w
							and	((coalesce(x.cd_estab_regra::text, '') = '') or (x.cd_estab_regra = cd_estabelecimento_w))))
	and (coalesce(cd_kit_material_p,0) 	= 0)
	and (coalesce(nr_seq_kit_estoque_p,0)	= 0)
	and (b.ie_situacao			= 'A')
	and (d.ie_situacao			= 'A')
	and (coalesce(a.ie_situacao,'A')		= 'A')
	and (b.ie_video = 'A' or b.ie_video = coalesce(ie_video_w, b.ie_video))
	and (qt_idade_w between coalesce(b.qt_idade_minima,0) and coalesce(qt_idade_maxima,999))
	and 	c.nr_sequencia in (	select	z.nr_seq_proc_interno
				from 	prescr_procedimento z,
					cirurgia x
				where 	x.nr_prescricao 	= z.nr_prescricao
				and 	x.nr_cirurgia 	= nr_cirurgia_w
				and 	coalesce(ie_gerar_kit_w,'S') = 'S'
				and	(z.nr_seq_proc_interno IS NOT NULL AND z.nr_seq_proc_interno::text <> ''))
	and	coalesce(b.ie_sexo, coalesce(ie_sexo_w,0))		= coalesce(ie_sexo_w,0)/*thlima - 26/05/2010 - OS 218824 - tratar sexo do paciente com o sexo do componente do kit*/
	
union all
 /*Bruna OS103582 inclui union para proc_interno_kit*/
	select	coalesce(b.nr_seq_apresentacao,9999) nr_seq_apresentacao,
		b.cd_material,
		b.qt_material,
		coalesce(b.cd_unidade_medida_prescr, substr(obter_dados_material_estab(b.cd_material,cd_estabelecimento_w,'UMS'),1,30)),
		d.ie_via_aplicacao,
		coalesce(b.ie_dispensavel,'N'),
		e.cd_kit_material,
		b.nr_sequencia,
		b.cd_fornecedor,
		d.ie_tipo_material,
		0, null,
		coalesce(b.ie_duplica_prescr,'S'),
		null,
		'N'
	from 	material d,
		proc_interno c,
		componente_kit b,
		kit_material a,
		proc_interno_kit e
	where 	coalesce(e.cd_setor_atendimento,coalesce(cd_setor_atendimento_w,0)) = coalesce(cd_setor_atendimento_w,0)
	and (a.cd_kit_material 		= b.cd_kit_material)
	and (e.cd_estabelecimento		= cd_estabelecimento_w)
	and (c.nr_sequencia 		= e.nr_seq_proc_interno)
	and (coalesce(e.cd_medico,cd_medico_w)	= cd_medico_w)
	and (b.cd_kit_material 		= e.cd_kit_material)
	and	((coalesce(b.cd_estab_regra::text, '') = '') or (b.cd_estab_regra = cd_estabelecimento_w))
	and 	(((e.ie_somente_exclusivo = 'S') and not exists (	select  1
									from	proc_interno_kit x
									where	x.cd_estabelecimento	= cd_estabelecimento_w
									and	c.nr_sequencia 		= x.nr_seq_proc_interno
									and	x.cd_medico		= cd_medico_w)) or (coalesce(e.ie_somente_exclusivo,'N') = 'N'))
	and (b.cd_material			= d.cd_material)
	and	((b.ie_recem_nato =  coalesce(ie_recem_nato_w, 'A')) or (coalesce(b.ie_recem_nato, 'A') = 'A'))
	and (coalesce(obter_se_utiliza_comp_kit(b.cd_kit_material, b.nr_sequencia, cd_medico_w, nr_cirurgia_w),'S') = 'S')
	and 	(b.cd_convenio = cd_convenio_w or (coalesce(b.cd_convenio::text, '') = '') and
					not exists
						(	select	1
							from	componente_kit x
							where	x.ie_situacao	  = 'A'
							and	x.cd_kit_material = b.cd_kit_material
							and	x.cd_material	  = b.cd_material
							and	x.cd_convenio 	  = cd_convenio_w
							and	((coalesce(x.cd_estab_regra::text, '') = '') or (x.cd_estab_regra = cd_estabelecimento_w))))
	and 	(b.ie_tipo_convenio = ie_tipo_convenio_w or (coalesce(b.ie_tipo_convenio::text, '') = '') and
					not exists
						(	select	1
							from	componente_kit x
							where	x.ie_situacao	  = 'A'
							and	x.cd_kit_material = b.cd_kit_material
							and	x.cd_material	  = b.cd_material
							and	x.ie_tipo_convenio = ie_tipo_convenio_w
							and	((coalesce(x.cd_estab_regra::text, '') = '') or (x.cd_estab_regra = cd_estabelecimento_w))))
	and (coalesce(cd_kit_material_p,0) 	= 0)
	and (coalesce(nr_seq_kit_estoque_p,0)	= 0)
	and (b.ie_situacao			= 'A')
	and (d.ie_situacao			= 'A')
	and (coalesce(a.ie_situacao,'A')		= 'A')
	and (b.ie_video = 'A' or b.ie_video = coalesce(ie_video_w, b.ie_video))
	and (qt_idade_w between coalesce(b.qt_idade_minima,0) and coalesce(qt_idade_maxima,999))
	and 	c.nr_sequencia in (	select	z.nr_seq_proc_interno
				from 	prescr_procedimento z,
					cirurgia x
				where 	x.nr_prescricao 	= z.nr_prescricao
				and 	x.nr_cirurgia 	= nr_cirurgia_w
				and 	coalesce(ie_gerar_kit_w,'S') = 'S'
				and	(z.nr_seq_proc_interno IS NOT NULL AND z.nr_seq_proc_interno::text <> ''))
	and 	c.nr_sequencia not in (	select	t.nr_seq_proc_interno
				from 	agenda_paciente t
				where 	t.nr_sequencia = nr_seq_agenda_p
				
union

				select 	t.nr_seq_proc_interno
				from 	agenda_paciente_proc t,
						agenda_paciente z
				where	z.nr_sequencia 		= t.nr_sequencia
				and 	coalesce(ie_gerar_kit_w,'S') = 'S'
	 			and 	t.nr_sequencia 		= nr_seq_agenda_p)					
	and	coalesce(b.ie_sexo, coalesce(ie_sexo_w,0))		= coalesce(ie_sexo_w,0) /*thlima - 26/05/2010 - OS 218824 - tratar sexo do paciente com o sexo do componente do kit*/
	and	coalesce(e.cd_convenio, coalesce(cd_convenio_w,0)) = coalesce(cd_convenio_w,0)
	and	coalesce(b.ie_tipo_convenio, coalesce(ie_tipo_convenio_w,0)) = coalesce(ie_tipo_convenio_w,0)
	and	qt_dia_w between obter_idade_kit_proced(e.nr_sequencia,'MIN') and obter_idade_kit_proced(e.nr_sequencia,'MAX')
	and     coalesce(e.cd_perfil,cd_perfil_p)   = cd_perfil_p
	and     e.cd_estabelecimento          = cd_estabelecimento_w
	
union all

	select 	coalesce(b.nr_seq_apresentacao,9999) nr_seq_apresentacao,
		b.cd_material,
		b.qt_material,
		coalesce(b.cd_unidade_medida_prescr, substr(obter_dados_material_estab(b.cd_material,cd_estabelecimento_w,'UMS'),1,30)),
		d.ie_via_aplicacao,
		coalesce(b.ie_dispensavel,'N'),
		b.cd_kit_material,
		b.nr_sequencia,
		b.cd_fornecedor,
		d.ie_tipo_material,
		0, null,
		coalesce(b.ie_duplica_prescr,'S'),
		null,
		'N'
	from 	material d,
		procedimento c,
		componente_kit b,
		kit_material a
	where (a.cd_kit_material 		= b.cd_kit_material)
	and (b.cd_kit_material 		= c.cd_kit_material)
	and (b.cd_material			= d.cd_material)
	/* and (b.cd_medico is null or b.cd_medico = cd_medico_w) --> rafael em 02/11/2006 os43577 substituido pela linha abaixo */

	and	((b.ie_recem_nato =  coalesce(ie_recem_nato_w, 'A')) or (coalesce(b.ie_recem_nato, 'A') = 'A'))
	and (coalesce(obter_se_utiliza_comp_kit(b.cd_kit_material, b.nr_sequencia, cd_medico_w, nr_cirurgia_w),'S') = 'S')
	and	((coalesce(b.cd_estab_regra::text, '') = '') or (b.cd_estab_regra = cd_estabelecimento_w))
	and 	(b.cd_convenio = cd_convenio_w or (coalesce(b.cd_convenio::text, '') = '') and
					not exists
						(	select 	1
							from 	componente_kit x
							where	x.ie_situacao	  = 'A'
							and	x.cd_kit_material = b.cd_kit_material
							and	x.cd_material	  = b.cd_material
							and	x.cd_convenio 	  = cd_convenio_w
							and	((coalesce(x.cd_estab_regra::text, '') = '') or (x.cd_estab_regra = cd_estabelecimento_w))))
	and 	(b.ie_tipo_convenio = ie_tipo_convenio_w or (coalesce(b.ie_tipo_convenio::text, '') = '') and
					not exists
						(	select 	1
							from 	componente_kit x
							where	x.ie_situacao	  = 'A'
							and	x.cd_kit_material = b.cd_kit_material
							and	x.cd_material	  = b.cd_material
							and	x.ie_tipo_convenio = ie_tipo_convenio_w
							and	((coalesce(x.cd_estab_regra::text, '') = '') or (x.cd_estab_regra = cd_estabelecimento_w))))
	and (coalesce(cd_kit_material_p,0) 	= 0)
	and (coalesce(nr_seq_kit_estoque_p,0)	= 0)
	and (b.ie_situacao			= 'A')
	and (d.ie_situacao			= 'A')
	and (coalesce(a.ie_situacao,'A')		= 'A')
	and (b.ie_video = 'A' or b.ie_video = coalesce(ie_video_w, b.ie_video))
	and (qt_idade_w between coalesce(b.qt_idade_minima,0) and coalesce(qt_idade_maxima,999))
	and 	c.cd_procedimento in (	select 	x.cd_procedimento_princ
				from 	cirurgia x
				where 	x.nr_cirurgia = nr_cirurgia_w
				
union

				select 	z.cd_procedimento
				from 	proc_interno y,
					prescr_procedimento z,
					cirurgia x
				where 	x.nr_prescricao 	= z.nr_prescricao
				and 	x.nr_cirurgia 	= nr_cirurgia_w
				and 	coalesce(ie_gerar_kit_w,'S') = 'S'
				and	z.nr_seq_proc_interno = y.nr_sequencia
				and	coalesce(y.cd_kit_material::text, '') = ''
				
union

				select 	z.cd_procedimento
				from 	prescr_procedimento z,
					cirurgia x
				where 	x.nr_prescricao 	= z.nr_prescricao
				and 	x.nr_cirurgia 		= nr_cirurgia_w
				and 	coalesce(ie_gerar_kit_w,'S') = 'S'
				and	coalesce(z.nr_seq_proc_interno::text, '') = '')
	and	coalesce(b.ie_sexo, coalesce(ie_sexo_w,0))		= coalesce(ie_sexo_w,0) /*thlima - 26/05/2010 - OS 218824 - tratar sexo do paciente com o sexo do componente do kit*/
	
union all

	select  coalesce(b.nr_seq_apresentacao,9999) nr_seq_apresentacao,
		b.cd_material,
		b.qt_material,
		coalesce(b.cd_unidade_medida_prescr, substr(obter_dados_material_estab(b.cd_material,cd_estabelecimento_w,'UMS'),1,30)),
		d.ie_via_aplicacao,
		coalesce(b.ie_dispensavel,'N'),
		b.cd_kit_material,
		b.nr_sequencia,
		b.cd_fornecedor,
		d.ie_tipo_material,
		(obter_convenio_proc_adic(c.nr_sequencia, null, nr_seq_agenda_p, 'CO'))::numeric ,
		obter_convenio_proc_adic(c.nr_sequencia, null, nr_seq_agenda_p, 'CA'),
		coalesce(b.ie_duplica_prescr,'S'),
		null,
		'N'
	from 	material d,
		proc_interno c,
		componente_kit b,
		kit_material a
	where (a.cd_kit_material = b.cd_kit_material)
	and (b.cd_kit_material = c.cd_kit_material)
	and (b.cd_material	= d.cd_material)
	/* and (b.cd_medico is null or b.cd_medico 	= cd_medico_w) --> rafael em 02/11/2006 os43577 substituido pela linha abaixo */

	and	((b.ie_recem_nato =  coalesce(ie_recem_nato_w, 'A')) or (coalesce(b.ie_recem_nato, 'A') = 'A'))
	and (coalesce(obter_se_utiliza_comp_kit(b.cd_kit_material, b.nr_sequencia, cd_medico_w, nr_cirurgia_w),'S') = 'S')
	and	((coalesce(b.cd_estab_regra::text, '') = '') or (b.cd_estab_regra = cd_estabelecimento_w))
	and 	(b.cd_convenio = cd_convenio_w or (coalesce(b.cd_convenio::text, '') = '') and
				not exists
					(	select	1
						from	componente_kit x
						where	x.ie_situacao	  = 'A'
						and	x.cd_kit_material = b.cd_kit_material
						and	x.cd_material	  = b.cd_material
						and	x.cd_convenio 	  = cd_convenio_w
						and	((coalesce(x.cd_estab_regra::text, '') = '') or (x.cd_estab_regra = cd_estabelecimento_w))))
	and 	(b.ie_tipo_convenio = ie_tipo_convenio_w or (coalesce(b.ie_tipo_convenio::text, '') = '') and
				not exists
					(	select	1
						from	componente_kit x
						where	x.ie_situacao	  = 'A'
						and	x.cd_kit_material = b.cd_kit_material
						and	x.cd_material	  = b.cd_material
						and	x.ie_tipo_convenio = ie_tipo_convenio_w
						and	((coalesce(x.cd_estab_regra::text, '') = '') or (x.cd_estab_regra = cd_estabelecimento_w))))
	and (coalesce(cd_kit_material_p,0) 		= 0)
	and (coalesce(nr_seq_kit_estoque_p,0) 	= 0)
	and (b.ie_situacao			= 'A')
	and (d.ie_situacao			= 'A')
	and (coalesce(a.ie_situacao,'A')		= 'A')
	and (b.ie_video = 'A' or b.ie_video = coalesce(ie_video_w, b.ie_video))
	and (qt_idade_w between coalesce(b.qt_idade_minima,0) and coalesce(qt_idade_maxima,999))
	and 	(c.cd_kit_material IS NOT NULL AND c.cd_kit_material::text <> '')
	and 	c.nr_sequencia in (	select	x.nr_seq_proc_interno
				from 	agenda_paciente x
				where 	x.nr_sequencia = nr_seq_agenda_p
				
union

				select 	z.nr_seq_proc_interno
				from 	agenda_paciente_proc z,
					agenda_paciente x
				where	x.nr_sequencia 		= z.nr_sequencia
				and 	coalesce(ie_gerar_kit_w,'S') = 'S'
	 			and 	x.nr_sequencia 		= nr_seq_agenda_p)
	and	coalesce(b.ie_sexo, coalesce(ie_sexo_w,0))		= coalesce(ie_sexo_w,0) /*thlima - 26/05/2010 - OS 218824 - tratar sexo do paciente com o sexo do componente do kit*/
	and	((coalesce(ds_kit_marcado_agenda_w::text, '') = '') or (obter_se_contido_char(a.cd_kit_material,ds_kit_marcado_agenda_w) = 'S'))
	
union all
 /*Bruna OS103582 inclui union para proc_interno_kit*/
	select  coalesce(b.nr_seq_apresentacao,9999) nr_seq_apresentacao,
		b.cd_material,
		b.qt_material,
		coalesce(b.cd_unidade_medida_prescr, substr(obter_dados_material_estab(b.cd_material,cd_estabelecimento_w,'UMS'),1,30)),
		d.ie_via_aplicacao,
		coalesce(b.ie_dispensavel,'N'),
		b.cd_kit_material,
		b.nr_sequencia,
		b.cd_fornecedor,
		d.ie_tipo_material,
		(obter_convenio_proc_adic(c.nr_sequencia, null, nr_seq_agenda_p, 'CO'))::numeric ,
		obter_convenio_proc_adic(c.nr_sequencia, null, nr_seq_agenda_p, 'CA'),
		coalesce(b.ie_duplica_prescr,'S'),
		null, 
		'N'
	from 	material d,
		proc_interno c,
		componente_kit b,
		kit_material a,
		proc_interno_kit e
	where 	coalesce(e.cd_setor_atendimento,coalesce(cd_setor_atendimento_w,0)) = coalesce(cd_setor_atendimento_w,0)
	and (a.cd_kit_material 	= b.cd_kit_material)
	and (e.cd_estabelecimento	= cd_estabelecimento_w)
	and (c.nr_sequencia 	= e.nr_seq_proc_interno)
	and (b.cd_kit_material 	= e.cd_kit_material)
	and (coalesce(e.cd_medico,cd_medico_w)	= cd_medico_w)
	and 	(((e.ie_somente_exclusivo = 'S') and not exists (	select  1 
									from	proc_interno_kit x
									where	x.cd_estabelecimento	= cd_estabelecimento_w
									and	c.nr_sequencia 		= x.nr_seq_proc_interno
									and	x.cd_medico		= cd_medico_w)) or (coalesce(e.ie_somente_exclusivo,'N') = 'N'))
	and (b.cd_material	= d.cd_material)
	/* and (b.cd_medico is null or b.cd_medico 	= cd_medico_w) --> rafael em 02/11/2006 os43577 substituido pela linha abaixo */

	and	((b.ie_recem_nato =  coalesce(ie_recem_nato_w, 'A')) or (coalesce(b.ie_recem_nato, 'A') = 'A'))
	and (coalesce(obter_se_utiliza_comp_kit(b.cd_kit_material, b.nr_sequencia, cd_medico_w, nr_cirurgia_w),'S') = 'S')
	and	((coalesce(b.cd_estab_regra::text, '') = '') or (b.cd_estab_regra = cd_estabelecimento_w))
	and 	(b.cd_convenio = cd_convenio_w or (coalesce(b.cd_convenio::text, '') = '') and
				not exists
					(	select	1
						from	componente_kit x
						where	x.ie_situacao	  = 'A'
						and	x.cd_kit_material = b.cd_kit_material
						and	x.cd_material	  = b.cd_material
						and	x.cd_convenio 	  = cd_convenio_w
						and	((coalesce(x.cd_estab_regra::text, '') = '') or (x.cd_estab_regra = cd_estabelecimento_w))))
	and 	(b.ie_tipo_convenio = ie_tipo_convenio_w or (coalesce(b.ie_tipo_convenio::text, '') = '') and
				not exists
					(	select	1
						from	componente_kit x
						where	x.ie_situacao	  = 'A'
						and	x.cd_kit_material = b.cd_kit_material
						and	x.cd_material	  = b.cd_material
						and	x.ie_tipo_convenio = ie_tipo_convenio_w
						and	((coalesce(x.cd_estab_regra::text, '') = '') or (x.cd_estab_regra = cd_estabelecimento_w))))
	and (coalesce(cd_kit_material_p,0) 		= 0)
	and (coalesce(nr_seq_kit_estoque_p,0) 	= 0)
	and (b.ie_situacao			= 'A')
	and (d.ie_situacao			= 'A')
	and (coalesce(a.ie_situacao,'A')		= 'A')
	and (b.ie_video = 'A' or b.ie_video = coalesce(ie_video_w, b.ie_video))
	and (qt_idade_w between coalesce(b.qt_idade_minima,0) and coalesce(qt_idade_maxima,999))
	and 	c.nr_sequencia in (	select	x.nr_seq_proc_interno
				from 	agenda_paciente x
				where 	x.nr_sequencia = nr_seq_agenda_p
				
union

				select 	z.nr_seq_proc_interno
				from 	agenda_paciente_proc z,
					agenda_paciente x
				where	x.nr_sequencia 		= z.nr_sequencia
				and 	coalesce(ie_gerar_kit_w,'S') = 'S'
	 			and 	x.nr_sequencia 		= nr_seq_agenda_p)
	and	coalesce(b.ie_sexo, coalesce(ie_sexo_w,0))		= coalesce(ie_sexo_w,0) /*thlima - 26/05/2010 - OS 218824 - tratar sexo do paciente com o sexo do componente do kit*/
	and	coalesce(e.cd_convenio, coalesce(cd_convenio_w,0)) = coalesce(cd_convenio_w,0)
	and	coalesce(b.ie_tipo_convenio, coalesce(ie_tipo_convenio_w,0)) = coalesce(ie_tipo_convenio_w,0)
	and	((coalesce(ds_kit_marcado_agenda_w::text, '') = '') or (obter_se_contido_char(a.cd_kit_material,ds_kit_marcado_agenda_w) = 'S'))
	and	qt_dia_w between obter_idade_kit_proced(e.nr_sequencia,'MIN') and obter_idade_kit_proced(e.nr_sequencia,'MAX')
	and     coalesce(e.cd_perfil,cd_perfil_p)   = cd_perfil_p
	and     e.cd_estabelecimento          = cd_estabelecimento_w
	
union all

	select 	coalesce(b.nr_seq_apresentacao,9999) nr_seq_apresentacao,
		b.cd_material,
		b.qt_material,
		coalesce(b.cd_unidade_medida_prescr, substr(obter_dados_material_estab(b.cd_material,cd_estabelecimento_w,'UMS'),1,30)),
		d.ie_via_aplicacao,
		coalesce(b.ie_dispensavel,'N'),
		b.cd_kit_material,
		b.nr_sequencia,
		b.cd_fornecedor,
		d.ie_tipo_material,
		(obter_convenio_proc_adic(null, c.cd_procedimento, nr_seq_agenda_p, 'CO'))::numeric ,
		obter_convenio_proc_adic(null, c.cd_procedimento, nr_seq_agenda_p, 'CA'),
		coalesce(b.ie_duplica_prescr,'S'),
		null, 
		'N'
	from 	material d,
		procedimento c,
		componente_kit b,
		kit_material a
	where (a.cd_kit_material = b.cd_kit_material)
	and (b.cd_kit_material = c.cd_kit_material)
	and (b.cd_material	= d.cd_material)
	/* and 	(b.cd_medico is null or b.cd_medico 	= cd_medico_w) --> rafael em 02/11/2006 os43577 substituido pela linha abaixo */

	and	((b.ie_recem_nato =  coalesce(ie_recem_nato_w, 'A')) or (coalesce(b.ie_recem_nato, 'A') = 'A'))
	and (coalesce(obter_se_utiliza_comp_kit(b.cd_kit_material, b.nr_sequencia, cd_medico_w, nr_cirurgia_w),'S') = 'S')
	and	((coalesce(b.cd_estab_regra::text, '') = '') or (b.cd_estab_regra = cd_estabelecimento_w))
	and 	(b.cd_convenio = cd_convenio_w or (coalesce(b.cd_convenio::text, '') = '') and
					not exists
						(	select 	1
							from 	componente_kit x
							where	x.ie_situacao	  = 'A'
							and	x.cd_kit_material = b.cd_kit_material
							and	x.cd_material	  = b.cd_material
							and	x.cd_convenio 	  = cd_convenio_w
							and	((coalesce(x.cd_estab_regra::text, '') = '') or (x.cd_estab_regra = cd_estabelecimento_w))))
	and 	(b.ie_tipo_convenio = ie_tipo_convenio_w or (coalesce(b.ie_tipo_convenio::text, '') = '') and
					not exists
						(	select 	1
							from 	componente_kit x
							where	x.ie_situacao	  = 'A'
							and	x.cd_kit_material = b.cd_kit_material
							and	x.cd_material	  = b.cd_material
							and	x.ie_tipo_convenio = ie_tipo_convenio_w
							and	((coalesce(x.cd_estab_regra::text, '') = '') or (x.cd_estab_regra = cd_estabelecimento_w))))
	and (coalesce(cd_kit_material_p,0) 		= 0)
	and (coalesce(nr_seq_kit_estoque_p,0) 	= 0)
	and (b.ie_situacao			= 'A')
	and (d.ie_situacao			= 'A')
	and (coalesce(a.ie_situacao,'A')		= 'A')
	and (b.ie_video = 'A' or b.ie_video = coalesce(ie_video_w, b.ie_video))
	and (qt_idade_w between coalesce(b.qt_idade_minima,0) and coalesce(qt_idade_maxima,999))
	and 	c.cd_procedimento in (	select 	x.cd_procedimento
				from 	agenda_paciente x
				where 	x.nr_sequencia = nr_seq_agenda_p
				and	coalesce(x.nr_seq_proc_interno::text, '') = '' /* dalcastagne em 18/04/2007 - os 53882 */
				
union

				select 	z.cd_procedimento
				from	agenda_paciente_proc z,
					agenda_paciente x
				where 	x.nr_sequencia 		= z.nr_sequencia
				and 	coalesce(ie_gerar_kit_w,'S') = 'S'
				and 	x.nr_sequencia 		= nr_seq_agenda_p
				and 	coalesce(z.nr_seq_proc_interno::text, '') = '')
	and	coalesce(b.ie_sexo, coalesce(ie_sexo_w,0))		= coalesce(ie_sexo_w,0) /*thlima - 26/05/2010 - OS 218824 - tratar sexo do paciente com o sexo do componente do kit*/
	and	((coalesce(ds_kit_marcado_agenda_w::text, '') = '') or (obter_se_contido_char(a.cd_kit_material,ds_kit_marcado_agenda_w) = 'S'))
	
union all
 /* protocolos de cirurgia */
	select 	coalesce(b.nr_seq_apresentacao,9999) nr_seq_apresentacao,
		b.cd_material,
		b.qt_material,
		coalesce(b.cd_unidade_medida_prescr, substr(obter_dados_material_estab(b.cd_material,cd_estabelecimento_w,'UMS'),1,30)),
		d.ie_via_aplicacao,
		coalesce(b.ie_dispensavel,'N'),
		c.cd_kit_material,
		b.nr_sequencia,
		b.cd_fornecedor,
		d.ie_tipo_material,
		0, null,
		coalesce(b.ie_duplica_prescr,'S'),
		null, 
		'N'
	from 	material d,
		proc_interno c,
		componente_kit b,
		kit_material a,
		protocolo_medicacao e
	where (a.cd_kit_material 		= b.cd_kit_material)
	and (e.nr_seq_interna 		= c.nr_seq_protocolo)
	and (b.cd_material			= d.cd_material)
	and (a.nr_seq_protocolo		= e.nr_seq_interna)
	and (coalesce(obter_se_utiliza_comp_kit(b.cd_kit_material, b.nr_sequencia, cd_medico_w, nr_cirurgia_w),'S') = 'S')
	and	((b.ie_recem_nato =  coalesce(ie_recem_nato_w, 'A')) or (coalesce(b.ie_recem_nato, 'A') = 'A'))
	and	((coalesce(b.cd_estab_regra::text, '') = '') or (b.cd_estab_regra = cd_estabelecimento_w))
	and 	(b.cd_convenio = cd_convenio_w or (coalesce(b.cd_convenio::text, '') = '') and
					not exists
						(	select 	1
							from 	componente_kit x
							where	x.ie_situacao	  = 'A'
							and	x.cd_kit_material = b.cd_kit_material
							and	x.cd_material	  = b.cd_material
							and	x.cd_convenio 	  = cd_convenio_w
							and	((coalesce(x.cd_estab_regra::text, '') = '') or (x.cd_estab_regra = cd_estabelecimento_w))))
	and 	(b.ie_tipo_convenio = ie_tipo_convenio_w or (coalesce(b.ie_tipo_convenio::text, '') = '') and
					not exists
						(	select 	1
							from 	componente_kit x
							where	x.ie_situacao	  = 'A'
							and	x.cd_kit_material = b.cd_kit_material
							and	x.cd_material	  = b.cd_material
							and	x.ie_tipo_convenio = ie_tipo_convenio_w
							and	((coalesce(x.cd_estab_regra::text, '') = '') or (x.cd_estab_regra = cd_estabelecimento_w))))
	and (coalesce(cd_kit_material_p,0) 	= 0)
	and (coalesce(nr_seq_kit_estoque_p,0)	= 0)
	and (b.ie_situacao			= 'A')
	and (d.ie_situacao			= 'A')
	and (coalesce(a.ie_situacao,'A')		= 'A')
	and (b.ie_video = 'A' or b.ie_video = coalesce(ie_video_w, b.ie_video))
	and (qt_idade_w between coalesce(b.qt_idade_minima,0) and coalesce(qt_idade_maxima,999))
	and 	c.nr_sequencia in (	select 	z.nr_seq_proc_interno
				from 	prescr_procedimento z,
					cirurgia x
				where 	x.nr_prescricao 	= z.nr_prescricao
				and 	x.nr_cirurgia 	= nr_cirurgia_w
				and 	coalesce(ie_gerar_kit_w,'S') = 'S'
				and	(z.nr_seq_proc_interno IS NOT NULL AND z.nr_seq_proc_interno::text <> ''))
	and	coalesce(b.ie_sexo, coalesce(ie_sexo_w,0))		= coalesce(ie_sexo_w,0) /*thlima - 26/05/2010 - OS 218824 - tratar sexo do paciente com o sexo do componente do kit*/
	and	((coalesce(ds_kit_marcado_agenda_w::text, '') = '') or (obter_se_contido_char(a.cd_kit_material,ds_kit_marcado_agenda_w) = 'S'))
	
union all

	select 	coalesce(b.nr_seq_apresentacao,9999) nr_seq_apresentacao,
		b.cd_material,
		b.qt_material,
		coalesce(b.cd_unidade_medida_prescr, substr(obter_dados_material_estab(b.cd_material,cd_estabelecimento_w,'UMS'),1,30)),
		d.ie_via_aplicacao,
		coalesce(b.ie_dispensavel,'N'),
		b.cd_kit_material,
		b.nr_sequencia,
		b.cd_fornecedor,
		d.ie_tipo_material,
		(obter_convenio_proc_adic(c.nr_sequencia, null, nr_seq_agenda_p, 'CO'))::numeric ,
		obter_convenio_proc_adic(c.nr_sequencia, null, nr_seq_agenda_p, 'CA'),
		coalesce(b.ie_duplica_prescr,'S'),
		null,
		'N'
	from 	material d,
		proc_interno c,
		componente_kit b,
		kit_material a,
		protocolo_medicacao e
	where (a.cd_kit_material 		= b.cd_kit_material)
	and (e.nr_seq_interna 		= c.nr_seq_protocolo)
	and (b.cd_material			= d.cd_material)
	and (a.nr_seq_protocolo		= e.nr_seq_interna)
	and (coalesce(obter_se_utiliza_comp_kit(b.cd_kit_material, b.nr_sequencia, cd_medico_w, nr_cirurgia_w),'S') = 'S')
	and	((b.ie_recem_nato =  coalesce(ie_recem_nato_w, 'A')) or (coalesce(b.ie_recem_nato, 'A') = 'A'))
	and	((coalesce(b.cd_estab_regra::text, '') = '') or (b.cd_estab_regra = cd_estabelecimento_w))
	and 	(b.cd_convenio = cd_convenio_w or (coalesce(b.cd_convenio::text, '') = '') and
				not exists
					(	select 	1
						from 	componente_kit x
						where	x.ie_situacao	  = 'A'
						and	x.cd_kit_material = b.cd_kit_material
						and	x.cd_material	  = b.cd_material
						and	x.cd_convenio 	  = cd_convenio_w
						and	((coalesce(x.cd_estab_regra::text, '') = '') or (x.cd_estab_regra = cd_estabelecimento_w))))
	and 	(b.ie_tipo_convenio = ie_tipo_convenio_w or (coalesce(b.ie_tipo_convenio::text, '') = '') and
				not exists
					(	select 	1
						from 	componente_kit x
						where	x.ie_situacao	  = 'A'
						and	x.cd_kit_material = b.cd_kit_material
						and	x.cd_material	  = b.cd_material
						and	x.ie_tipo_convenio = ie_tipo_convenio_w
						and	((coalesce(x.cd_estab_regra::text, '') = '') or (x.cd_estab_regra = cd_estabelecimento_w))))
	and (coalesce(cd_kit_material_p,0) 		= 0)
	and (coalesce(nr_seq_kit_estoque_p,0) 	= 0)
	and (b.ie_situacao			= 'A')
	and (d.ie_situacao			= 'A')
	and (coalesce(a.ie_situacao,'A')		= 'A')
	and (b.ie_video = 'A' or b.ie_video = coalesce(ie_video_w, b.ie_video))
	and (qt_idade_w between coalesce(b.qt_idade_minima,0) and coalesce(qt_idade_maxima,999))
	and 	(c.nr_seq_protocolo IS NOT NULL AND c.nr_seq_protocolo::text <> '')
	and 	c.nr_sequencia in (	select 	x.nr_seq_proc_interno
			from 	agenda_paciente x
			where 	x.nr_sequencia = nr_seq_agenda_p
			
union

			select 	z.nr_seq_proc_interno
			from 	agenda_paciente_proc z,
				agenda_paciente x
			where 	x.nr_sequencia 		= z.nr_sequencia
			and 	coalesce(ie_gerar_kit_w,'S') = 'S'
			and 	x.nr_sequencia 		= nr_seq_agenda_p)
	and	coalesce(b.ie_sexo, coalesce(ie_sexo_w,0))		= coalesce(ie_sexo_w,0) /*thlima - 26/05/2010 - OS 218824 - tratar sexo do paciente com o sexo do componente do kit*/
	and	((coalesce(ds_kit_marcado_agenda_w::text, '') = '') or (obter_se_contido_char(a.cd_kit_material,ds_kit_marcado_agenda_w) = 'S'))
	
union all

	select 	coalesce(b.nr_seq_apresentacao,9999) nr_seq_apresentacao,
		b.cd_material,
		b.qt_material,
		coalesce(b.cd_unidade_medida_prescr, substr(obter_dados_material_estab(b.cd_material,cd_estabelecimento_w,'UMS'),1,30)),
		d.ie_via_aplicacao,
		coalesce(b.ie_dispensavel,'N'),
		c.cd_kit_material,
		b.nr_sequencia,
		b.cd_fornecedor,
		d.ie_tipo_material,
		0, null,
		coalesce(b.ie_duplica_prescr,'S'),
		null,
		'N'
	from 	material d,
		proc_interno c,
		componente_kit b,
		kit_material a,
		protocolo_medicacao e,
		proc_interno_estab f
	where (a.cd_kit_material 		= b.cd_kit_material)
	and (e.nr_seq_interna 		= f.nr_seq_protocolo)
	and (b.cd_material			= d.cd_material)
	and (a.nr_seq_protocolo		= e.nr_seq_interna)
	and (f.nr_seq_proc_interno		= c.nr_sequencia)
	and (f.cd_estabelecimento 		= cd_estabelecimento_w)
	and (coalesce(obter_se_utiliza_comp_kit(b.cd_kit_material, b.nr_sequencia, cd_medico_w, nr_cirurgia_w),'S') = 'S')
	and	((b.ie_recem_nato =  coalesce(ie_recem_nato_w, 'A')) or (coalesce(b.ie_recem_nato, 'A') = 'A'))
	and	((coalesce(b.cd_estab_regra::text, '') = '') or (b.cd_estab_regra = cd_estabelecimento_w))
	and 	(b.cd_convenio = cd_convenio_w or (coalesce(b.cd_convenio::text, '') = '') and
				not exists
					(	select 	1
						from 	componente_kit x
						where	x.ie_situacao	  = 'A'
						and	x.cd_kit_material = b.cd_kit_material
						and	x.cd_material	  = b.cd_material
						and	x.cd_convenio 	  = cd_convenio_w
						and	((coalesce(x.cd_estab_regra::text, '') = '') or (x.cd_estab_regra = cd_estabelecimento_w))))
	and 	(b.ie_tipo_convenio = ie_tipo_convenio_w or (coalesce(b.ie_tipo_convenio::text, '') = '') and
				not exists
					(	select 	1
						from 	componente_kit x
						where	x.ie_situacao	  = 'A'
						and	x.cd_kit_material = b.cd_kit_material
						and	x.cd_material	  = b.cd_material
						and	x.ie_tipo_convenio = ie_tipo_convenio_w
						and	((coalesce(x.cd_estab_regra::text, '') = '') or (x.cd_estab_regra = cd_estabelecimento_w))))
	and (coalesce(cd_kit_material_p,0) 	= 0)
	and (coalesce(nr_seq_kit_estoque_p,0)	= 0)
	and (b.ie_situacao			= 'A')
	and (d.ie_situacao			= 'A')
	and (coalesce(a.ie_situacao,'A')		= 'A')
	and (b.ie_video = 'A' or b.ie_video = coalesce(ie_video_w, b.ie_video))
	and (qt_idade_w between coalesce(b.qt_idade_minima,0) and coalesce(qt_idade_maxima,999))
	and 	c.nr_sequencia in (	select 	z.nr_seq_proc_interno
				from 	prescr_procedimento z,
					cirurgia x
				where 	x.nr_prescricao 	= z.nr_prescricao
				and 	x.nr_cirurgia 		= nr_cirurgia_w
				and 	coalesce(ie_gerar_kit_w,'S') = 'S'
				and	(z.nr_seq_proc_interno IS NOT NULL AND z.nr_seq_proc_interno::text <> ''))
	and	coalesce(b.ie_sexo, coalesce(ie_sexo_w,0))		= coalesce(ie_sexo_w,0) /*thlima - 26/05/2010 - OS 218824 - tratar sexo do paciente com o sexo do componente do kit*/
	and	((coalesce(ds_kit_marcado_agenda_w::text, '') = '') or (obter_se_contido_char(a.cd_kit_material,ds_kit_marcado_agenda_w) = 'S'))
	
union all

	select 	coalesce(b.nr_seq_apresentacao,9999) nr_seq_apresentacao,
		b.cd_material,
		b.qt_material,
		coalesce(b.cd_unidade_medida_prescr, substr(obter_dados_material_estab(b.cd_material,cd_estabelecimento_w,'UMS'),1,30)),
		d.ie_via_aplicacao,
		coalesce(b.ie_dispensavel,'N'),
		b.cd_kit_material,
		b.nr_sequencia,
		b.cd_fornecedor,
		d.ie_tipo_material,
		(obter_convenio_proc_adic(c.nr_sequencia, null, nr_seq_agenda_p, 'CO'))::numeric ,
		obter_convenio_proc_adic(c.nr_sequencia, null, nr_seq_agenda_p, 'CA'),
		coalesce(b.ie_duplica_prescr,'S'),
		null,
		'N'
	from 	material d,
		proc_interno c,
		componente_kit b,
		kit_material a,
		protocolo_medicacao e,
		proc_interno_estab f
	where (a.cd_kit_material 		= b.cd_kit_material)
	and (e.nr_seq_interna 		= f.nr_seq_protocolo)
	and (b.cd_material			= d.cd_material)
	and (a.nr_seq_protocolo		= e.nr_seq_interna)
	and (f.nr_seq_proc_interno		= c.nr_sequencia)
	and (coalesce(obter_se_utiliza_comp_kit(b.cd_kit_material, b.nr_sequencia, cd_medico_w, nr_cirurgia_w),'S') = 'S')
	and	((b.ie_recem_nato =  coalesce(ie_recem_nato_w, 'A')) or (coalesce(b.ie_recem_nato, 'A') = 'A'))
	and	((coalesce(b.cd_estab_regra::text, '') = '') or (b.cd_estab_regra = cd_estabelecimento_w))
	and 	(b.cd_convenio = cd_convenio_w or (coalesce(b.cd_convenio::text, '') = '') and
				not exists
					(	select	1
						from 	componente_kit x
						where	x.ie_situacao	  = 'A'
						and	x.cd_kit_material = b.cd_kit_material
						and	x.cd_material	  = b.cd_material
						and	x.cd_convenio 	  = cd_convenio_w
						and	((coalesce(x.cd_estab_regra::text, '') = '') or (x.cd_estab_regra = cd_estabelecimento_w))))
	and 	(b.ie_tipo_convenio = ie_tipo_convenio_w or (coalesce(b.ie_tipo_convenio::text, '') = '') and
				not exists
					(	select	1
						from 	componente_kit x
						where	x.ie_situacao	  = 'A'
						and	x.cd_kit_material = b.cd_kit_material
						and	x.cd_material	  = b.cd_material
						and	x.ie_tipo_convenio = ie_tipo_convenio_w
						and	((coalesce(x.cd_estab_regra::text, '') = '') or (x.cd_estab_regra = cd_estabelecimento_w))))
	and (coalesce(cd_kit_material_p,0) 		= 0)
	and (coalesce(nr_seq_kit_estoque_p,0) 	= 0)
	and (b.ie_situacao			= 'A')
	and (d.ie_situacao			= 'A')
	and (coalesce(a.ie_situacao,'A')		= 'A')
	and (b.ie_video = 'A' or b.ie_video = coalesce(ie_video_w, b.ie_video))
	and (qt_idade_w between coalesce(b.qt_idade_minima,0) and coalesce(qt_idade_maxima,999))
	and 	(f.nr_seq_protocolo IS NOT NULL AND f.nr_seq_protocolo::text <> '')
	and 	f.cd_estabelecimento = cd_estabelecimento_w
	and 	c.nr_sequencia in (	select	x.nr_seq_proc_interno
				from 	agenda_paciente x
				where 	x.nr_sequencia = nr_seq_agenda_p
				
union

				select	z.nr_seq_proc_interno
				from 	agenda_paciente_proc z,
					agenda_paciente x
				where	x.nr_sequencia 		= z.nr_sequencia
				and 	coalesce(ie_gerar_kit_w,'S') = 'S'
				and 	x.nr_sequencia 		= nr_seq_agenda_p)
	and	coalesce(b.ie_sexo, coalesce(ie_sexo_w,0))		= coalesce(ie_sexo_w,0) /*thlima - 26/05/2010 - OS 218824 - tratar sexo do paciente com o sexo do componente do kit*/
	and	((coalesce(ds_kit_marcado_agenda_w::text, '') = '') or (obter_se_contido_char(a.cd_kit_material,ds_kit_marcado_agenda_w) = 'S'))
	
union all
 /* dalcastagne em 10/04/2007 - os 52137 */
	select	9999 nr_seq_apresentacao,
		a.cd_material,
		a.qt_material,
		substr(obter_dados_material_estab(a.cd_material,cd_estabelecimento_w,'UMS'),1,30) cd_unidade_medida_consumo,
		b.ie_via_aplicacao,
		'N' ie_dispensavel,
		0 cd_kit_material,
		0 nr_seq_componente,
		'' cd_fornecedor,
		b.ie_tipo_material,
		0, 
		null, 
		'S', 
		null,
		'N'
	from	material b,
		agenda_pac_opme a
	where	a.cd_material			=	b.cd_material
	and	a.ie_autorizado			=	'A'
	and	a.nr_seq_agenda			=	nr_seq_agenda_p
	and	ie_gera_opme_w			= 	'S'
	
union all

	select	9999 nr_seq_apresentacao,
		a.cd_material,
		a.qt_material,
		substr(obter_dados_material_estab(a.cd_material,cd_estabelecimento_w,'UMS'),1,30) cd_unidade_medida_consumo,
		b.ie_via_aplicacao,
		'N' ie_dispensavel,
		0 cd_kit_material,
		0 nr_seq_componente,
		'' cd_fornecedor,
		b.ie_tipo_material,
		0, 
		null, 
		'S', 
		a.nr_seq_lote_fornec,
		'A' ie_gerado_avulso_w
	from	material b,
		kit_estoque_comp_avulso a
	where	a.cd_material = b.cd_material
	and 	a.nr_seq_reg_kit = nr_seq_reg_kit_w
	and 	not exists ( select 1 
			from prescr_material c
			where a.nr_seq_reg_kit = c.nr_seq_reg_kit)
	
union all

	select	9999 nr_seq_apresentacao,
		a.cd_material,
		a.qt_material,
		substr(obter_dados_material_estab(a.cd_material,cd_estabelecimento_w,'UMS'),1,30) cd_unidade_medida_consumo,
		b.ie_via_aplicacao,
		'N' ie_dispensavel,
		0 cd_kit_material,
		0 nr_seq_componente,
		'' cd_fornecedor,
		b.ie_tipo_material,
		0, 
		null, 
		'S', 
		null,
		'A' ie_gerado_avulso_w
	from	material b,
		agenda_material_avulso a
	where	a.cd_material	= b.cd_material
	and 	a.nr_seq_agenda	= nr_seq_agenda_p
	order by nr_seq_apresentacao;
	
	

BEGIN
nr_cirurgia_w := coalesce(nr_cirurgia_p,0);
if (nr_cirurgia_w = 0) then
	select	coalesce(max(nr_cirurgia),0)
	into STRICT	nr_cirurgia_w
	from	agenda_paciente
	where	nr_sequencia = nr_seq_agenda_p;
end if;	

if (coalesce(nr_seq_agenda_p,0) > 0) then
	nr_seq_agenda_w := nr_seq_agenda_p;
else
	select	max(nr_sequencia)
	into STRICT	nr_seq_agenda_w
	from	agenda_paciente
	where	nr_cirurgia = nr_cirurgia_w;
end if;

select	max(ds_kit_marcado_agenda)
into STRICT	ds_kit_marcado_agenda_w
from	agenda_paciente
where	nr_sequencia = nr_seq_agenda_w;

select	coalesce(max(cd_setor_atendimento),0)
into STRICT	cd_setor_atendimento_w
from	cirurgia
where	nr_cirurgia	=	nr_cirurgia_w;

cd_funcao_w := OBTER_FUNCAO_ATIVA;

if (nr_doc_interno_p <> 0) then
	nr_doc_interno_w	:= nr_doc_interno_p;
else
	nr_doc_interno_w	:= null;
end if;
if (nr_doc_interno_aux_p <> 0) then
	nr_doc_interno_aux_w	:= nr_doc_interno_aux_p;
else
	nr_doc_interno_aux_w	:= null;
end if;

begin
select	cd_estabelecimento,
	ie_recem_nato
into STRICT	cd_estabelecimento_w,
	ie_recem_nato_w
from	prescr_medica
where	nr_prescricao	=	nr_prescricao_p;
exception
	when others then
	begin
	cd_estabelecimento_w	:= 0;
	ie_recem_nato_w		:= 'A';
	end;
end;


/*thlima - 26/05/2010 - OS 218824 - tratar sexo do paciente com o sexo do componente do kit*/

if (coalesce(nr_cirurgia_w,0) > 0) then
	begin
	select	cd_pessoa_fisica
	into STRICT	cd_pessoa_fisica_w
	from 	cirurgia
	where	nr_cirurgia	=	nr_cirurgia_w;
	
	ie_sexo_w	:=	obter_sexo_pf(cd_pessoa_fisica_w,'C');
	end;
elsif (coalesce(nr_prescricao_p,0) > 0) then
		begin
		select  max(cd_pessoa_fisica)
		into STRICT	cd_pessoa_fisica_ww
		from 	prescr_medica
		where	nr_prescricao	=	nr_prescricao_p;
	
		ie_sexo_w	:=	obter_sexo_pf(cd_pessoa_fisica_ww,'C');
		end;
	
end if;



select 	coalesce(Obter_Valor_Param_Usuario(901, 133, Obter_Perfil_ativo, nm_usuario_p, cd_estabelecimento_w), 'S')
into STRICT	ie_acumula_w
;

if (cd_funcao_w = 900) and (ie_acumula_w = 'S') then /* Realizado o tratamento de ie_acumula_w = S, para nao mudar o padrao para nenhum cliente */
	select 	coalesce(Obter_Valor_Param_Usuario(900, 130, Obter_Perfil_ativo, nm_usuario_p, cd_estabelecimento_w), 'S')
	into STRICT	ie_acumula_w
	;
end if;

select 	coalesce(Obter_Valor_Param_Usuario(871, 141, Obter_Perfil_ativo, nm_usuario_p, cd_estabelecimento_w), 'S')
into STRICT	ie_gera_kit_w
;

select 	coalesce(Obter_Valor_Param_Usuario(871, 171, Obter_Perfil_ativo, nm_usuario_p, cd_estabelecimento_w), 'S')
into STRICT	ie_gera_opme_w
;

select	coalesce(Obter_Valor_Param_Usuario(900, 115, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w), 'N')
into STRICT	ie_gerar_consistido_param_w
;

select	coalesce(Obter_Valor_Param_Usuario(871, 428, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w), 'S')
into STRICT	ie_gerar_kit_w
;

select	coalesce(Obter_Valor_Param_Usuario(900, 374, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w), 'S')
into STRICT	ie_gerar_consis_kit_proc_w
;

if (ie_gerar_consistido_param_w = 'S') and (nr_seq_kit_estoque_p > 0) then
	ie_gerar_consistido_w := 'S';
end if;

if (ie_gerar_consis_kit_proc_w = 'S') and (coalesce(nr_seq_kit_estoque_p,0) = 0) and (nr_cirurgia_w > 0) and (coalesce(cd_kit_material_p,0) = 0) then
	ie_gerar_consistido_w := 'S';
end if;


if (cd_funcao_p <> 900) then
	ie_gerar_consistido_w	:= 'N';
end if;


select	max(cd_intervalo)
into STRICT	cd_intervalo_w
from	intervalo_prescricao
where	ie_agora = 'S'
and 	qt_operacao = 1
and 	coalesce(ie_situacao, 'A') = 'A';

if (coalesce(cd_intervalo_w::text, '') = '') then	
	select	coalesce(max(cd_intervalo),1)
	into STRICT	cd_intervalo_w
	from	intervalo_prescricao
	where	ie_agora = 'S';
end if;	

select 	coalesce(max(nr_seq_reg_kit),0)
into STRICT	nr_seq_reg_kit_w
from	kit_estoque
where	nr_sequencia = nr_seq_kit_estoque_p;


if (coalesce(nr_cirurgia_w,0) > 0) then
	select	cd_medico_cirurgiao,
		cd_convenio
	into STRICT	cd_medico_w,
		cd_convenio_w
	from	cirurgia
	where	nr_cirurgia = nr_cirurgia_w;
	
	if (cd_convenio_w IS NOT NULL AND cd_convenio_w::text <> '') then
		select	ie_tipo_convenio
		into STRICT	ie_tipo_convenio_w
		from	convenio
		where	cd_convenio = cd_convenio_w;
	end if;

	select	coalesce(max(qt_idade_paciente),0),
		coalesce(trunc(max(obter_idade(dt_nascimento_pac,clock_timestamp(),'DIA'))),0)
	into STRICT	qt_idade_w,
		qt_dia_w
	from	agenda_paciente
	where	nr_sequencia = (
		SELECT	max(nr_sequencia)
		from	agenda_paciente
		where	nr_cirurgia = nr_cirurgia_w);

end if;

ie_utiliza_med_req_w := Obter_Param_Usuario(871, 174, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_utiliza_med_req_w);
ie_gera_prescr_mat_autor_w := Obter_Param_Usuario(871, 499, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_gera_prescr_mat_autor_w);
ie_gera_prescr_mat_esp_w := Obter_Param_Usuario(871, 536, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_gera_prescr_mat_esp_w);
ie_somente_consistidos_w := Obter_Param_Usuario(900, 412, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_somente_consistidos_w);
ie_fornec_consignados_w := Obter_Param_Usuario(900, 424, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_fornec_consignados_w);
ie_vinc_conv_kit_w := Obter_Param_Usuario(900, 444, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_vinc_conv_kit_w);

if (coalesce(nr_seq_agenda_p,0) > 0) then
	select	coalesce(qt_idade_paciente,0),
		CASE WHEN ie_utiliza_med_req_w='S' THEN coalesce(cd_medico_req,cd_medico)  ELSE cd_medico END ,
		cd_convenio,
		ie_video,
		coalesce(trunc(obter_idade(dt_nascimento_pac,clock_timestamp(),'DIA')),0)
	into STRICT 	qt_idade_w,
		cd_medico_w,
		cd_convenio_w,
		ie_video_w,
		qt_dia_w
	from	agenda_paciente
	where	nr_sequencia = nr_seq_agenda_p;
	
	if (cd_convenio_w IS NOT NULL AND cd_convenio_w::text <> '') then
		select	ie_tipo_convenio
		into STRICT	ie_tipo_convenio_w
		from	convenio
		where	cd_convenio = cd_convenio_w;
	end if;

	if (ie_video_w	= 'N') then
		select	CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
		into STRICT	ie_video_w
		from 	agenda_pac_equip a, equipamento b
		where 	a.cd_equipamento     	= b.cd_equipamento
		and   	b.ie_video   		= 'S'
		and	a.nr_seq_agenda		= nr_seq_agenda_p;

	end if;
end if;

if (cd_medico_p IS NOT NULL AND cd_medico_p::text <> '') then
	cd_medico_w	:= cd_medico_p;
end if;

if (coalesce(nr_doc_interno_p,0) > 0) then
	if (ie_tipo_doc_interno_p = 'B') then
		select 	max(cd_pessoa_fisica)
		into STRICT	cd_pessoa_fisica_F_w
		from 	usuario
		
		where 	Campo_numerico_parametro(cd_barras, '999999999999999999999999999D9999') = to_char(nr_doc_interno_p);
	elsif (ie_tipo_doc_interno_p = 'C') then
		select 	max(cd_pessoa_fisica)
		into STRICT	cd_pessoa_fisica_F_w
		from 	medico
		
		where 	Campo_numerico_parametro(nr_crm, '999999999999999999999999999D9999') = to_char(nr_doc_interno_p);
	end if;	
end if;	

if (coalesce(nr_doc_interno_aux_p,0) > 0) then	
	if (ie_tipo_doc_interno_aux_p = 'B') then
		select 	max(cd_pessoa_fisica)
		into STRICT	cd_pessoa_fisica_E_w
		from 	usuario
		
		where 	Campo_numerico_parametro(cd_barras, '999999999999999999999999999D9999') = to_char(nr_doc_interno_aux_p);
	elsif (ie_tipo_doc_interno_aux_p = 'C') then
		select 	max(cd_pessoa_fisica)
		into STRICT	cd_pessoa_fisica_E_w
		from 	medico
		
		where 	Campo_numerico_parametro(nr_crm, '999999999999999999999999999D9999') = to_char(nr_doc_interno_aux_p);
	end if;
end if;

if (coalesce(nr_prescricao_p,0) <> 0) and
	((ie_gera_kit_w = 'S') or (cd_funcao_p <> 871)) then
	begin
	if (qt_idade_w = 0) then
		select	coalesce((obter_idade_pf(cd_pessoa_fisica, clock_timestamp(), 'A'))::numeric ,0)
		into STRICT	qt_idade_w
		from	prescr_medica
		where	nr_prescricao = nr_prescricao_p;
	end if;
	
	open c01;
	loop
	fetch c01 into  nr_seq_apresentacao_w,
			cd_material_w,
			qt_material_w,
			cd_unidade_medida_w,
			ie_via_aplicacao_w,
			ie_dispensavel_w,
			cd_kit_material_w,
			nr_seq_componente_w,
			cd_fornecedor_w,
			ie_tipo_material_w,
			cd_convenio_ww,
			cd_categoria_w,
			ie_duplica_prescr_w,
			nr_seq_lote_fornec_w,
			ie_gerado_avulso_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
	cd_fornecedor_ww := null;
	
	if (ie_fornec_consignados_w = 'S') and (coalesce(nr_seq_kit_estoque_p, 0) > 0) then
		begin
		SELECT	MAX(ie_consignado)
		INTO STRICT	ie_consignado_w
		FROM	material
		WHERE	cd_material	= cd_material_w;
	
		if (ie_consignado_w = '1') then
			begin
			if (coalesce(nr_seq_lote_fornec_w,0) > 0) then
				select	cd_cgc_fornec
				into STRICT	cd_fornecedor_ww
				from	material_lote_fornec
				where	nr_sequencia = nr_seq_lote_fornec_w;
			else
				cd_fornecedor_ww := obter_fornecedor_regra_consig(cd_estabelecimento_w,cd_material_w,'1');
			end if;
			end;
		elsif (ie_consignado_w = '2') then
			SELECT * FROM obter_fornec_consig_ambos(
				cd_estabelecimento_w, cd_material_w, nr_seq_lote_fornec_w, cd_local_estoque_p, ie_tipo_saldo_w, cd_fornecedor_ww) INTO STRICT ie_tipo_saldo_w, cd_fornecedor_ww;	
		end if;
		end;
	end if;
	
	ds_materiais_w	:= ' ';

	if (cd_kit_material_w <> 0) and (nr_seq_componente_w <> 0) then
		begin
		open	c02;
		loop
		fetch	c02 into
			cd_material_opcao_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
			if (ds_materiais_w	= ' ') then
				ds_materiais_w	:= wheb_mensagem_pck.get_texto(299955) || ' ';
			end if;
			ds_materiais_w	:= ds_materiais_w || cd_material_opcao_w || ';';
		end;
		end loop;
		close c02;
		end;
	end if;

	select	coalesce(max(nr_sequencia),0) + 1
	into STRICT	nr_seq_prescr_material_w
	from	prescr_material
	where	nr_prescricao = nr_prescricao_p;

	select	coalesce(max(nr_agrupamento),0) + 1
	into STRICT	nr_agrupamento_w
	from	prescr_material
	where	nr_prescricao = nr_prescricao_p;

	select	to_char(dt_primeiro_horario,'HH24:MM')
	into STRICT	hr_prim_horario_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;

	select	coalesce(max('N'),'S')
	into STRICT	ie_registra_w
	from	prescr_material
	where	cd_material = cd_material_w
	and	nr_prescricao = nr_prescricao_p
	and	coalesce(ie_duplica_prescr_w,'S') = 'N';
	
	if (coalesce(nr_seq_kit_estoque_p,0) = 0) then
		nr_seq_kit_estoque_w := null;
	elsif (coalesce(nr_seq_kit_estoque_p,0) > 0) and (ie_gerado_avulso_w = 'A') then
		nr_seq_kit_estoque_w := null;
	elsif (coalesce(nr_seq_kit_estoque_p,0) > 0) and (ie_gerado_avulso_w <> 'A') then
		nr_seq_kit_estoque_w := nr_seq_kit_estoque_p;
	end if;
	
	if (ie_registra_w = 'S') then
		begin
		ie_gerou_itens_w := 'S';
				
		if (cd_pessoa_fisica_F_w IS NOT NULL AND cd_pessoa_fisica_F_w::text <> '') and (obter_se_mat_lib_profissional(cd_pessoa_fisica_F_w,cd_material_w,'E') = 'N') then
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(190004,	'DS_USUARIO='||substr(obter_nome_pf(cd_pessoa_fisica_F_w),1,100)||
									';DS_MATERIAL='||substr(obter_desc_material(cd_material_w),1,100));
		elsif (cd_pessoa_fisica_E_w IS NOT NULL AND cd_pessoa_fisica_E_w::text <> '') and (obter_se_mat_lib_profissional(cd_pessoa_fisica_E_w,cd_material_w,'R') = 'N') then
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(190014,	'DS_USUARIO='||substr(obter_nome_pf(cd_pessoa_fisica_E_w),1,100)||
									';DS_MATERIAL='||substr(obter_desc_material(cd_material_w),1,100));
		end if;	
		
		select	max('P')
		into STRICT	ie_objetivo_w
		from	material
		where	cd_material = cd_material_w
		and		coalesce(ie_controle_medico,'0') <> '0';		

		update	prescr_material
		set	qt_dose		= qt_dose + qt_material_w,
	 		qt_unitaria	= qt_unitaria + qt_material_w,
			qt_material	= qt_material + qt_material_w,
			qt_total_dispensar = qt_total_dispensar + qt_material_w
		where	nr_prescricao	= nr_prescricao_p
		and	ie_origem_inf	= ie_origem_inf_p
		and	cd_material	= cd_material_w
		and	cd_unidade_medida	= cd_unidade_medida_w
		and	ie_status_cirurgia	= 'GI'
		and	ie_acumula_w		= 'S'
		and	cd_motivo_baixa = 0
		and	coalesce(dt_baixa::text, '') = ''
		and	coalesce(nr_seq_kit_estoque,0) = coalesce(nr_seq_kit_estoque_w,0)
		and	coalesce(nr_seq_lote_fornec, 0) = coalesce(nr_seq_lote_fornec_w, 0);

		if (NOT FOUND) or (ie_acumula_w = 'N') then
			begin
			insert into prescr_material(nr_prescricao,
				nr_sequencia,
				ie_origem_inf,
				cd_material,
				cd_unidade_medida,
				qt_dose,
		 		qt_unitaria,
				qt_material,
			 	dt_atualizacao,
				nm_usuario,
				cd_intervalo,
				ds_horarios,
			 	ds_observacao,
			 	ie_via_aplicacao,
	 		 	nr_agrupamento,
			 	cd_motivo_baixa,
			 	dt_baixa,
			 	ie_utiliza_kit,
			 	cd_unidade_medida_dose,
				qt_conversao_dose,
			 	ie_urgencia,
			 	nr_ocorrencia,
			 	qt_total_dispensar,
			 	cd_fornec_consignado,
			 	nr_sequencia_solucao,
			 	nr_sequencia_proc,
			 	qt_solucao,
			 	hr_dose_especial,
			 	qt_dose_especial,
			 	ds_dose_diferenciada,
			 	ie_medicacao_paciente,
			 	nr_sequencia_diluicao,
			 	hr_prim_horario,
			 	nr_dia_util,
			 	nr_sequencia_dieta,
			 	ie_agrupador,
			 	dt_emissao_setor_atend,
			 	ie_suspenso,
			 	ds_justificativa,
			 	qt_dias_solicitado,
			 	qt_dias_liberado,
			 	nm_usuario_liberacao,
			 	dt_liberacao,
			 	ie_se_necessario,
			 	qt_min_aplicacao,
			 	nr_seq_lote_fornec,
			 	ie_status_cirurgia,
				ie_bomba_infusao,
				ie_aplic_bolus,
				ie_aplic_lenta,
				ie_acm,
				cd_kit_material,
				ie_recons_diluente_fixo,
				nr_seq_kit_estoque,
				cd_convenio,
				cd_categoria,
				ie_sem_aprazamento,
				nr_doc_interno,
				cd_local_estoque,
				nr_seq_reg_kit,
				nr_doc_interno_aux,
				ie_tipo_doc_interno,
				ie_tipo_doc_interno_aux,
				nm_usuario_original,
				nr_seq_justif_kit,
				ie_objetivo)
			values (  nr_prescricao_p,
			 	nr_seq_prescr_material_w,
			 	ie_origem_inf_p,
			 	cd_material_w,
			 	cd_unidade_medida_w,
			 	qt_material_w,
			 	qt_material_w,
			 	qt_material_w,
			 	clock_timestamp(),
			 	nm_usuario_p,
			 	cd_intervalo_w,
			 	null,
			 	ds_materiais_w,
			 	ie_via_aplicacao_w,
			 	nr_agrupamento_w,
				0,
			 	null,
			 	'N',
			 	null,
			 	null,
			 	'N',
			 	1,
			 	qt_material_w,
			 	coalesce(cd_fornecedor_w,cd_fornecedor_ww),
			 	null,
			 	null,
			 	null,
			 	null,
				 null,
			 	null,
			 	'N',
			 	null,
			 	hr_prim_horario_w,
			 	null,
			 	null,
			 	CASE WHEN ie_tipo_material_w='1' THEN  2 WHEN ie_tipo_material_w='2' THEN  1 WHEN ie_tipo_material_w='3' THEN  1  ELSE 2 END ,
			 	null,
			 	'N',
			 	null,
			 	null,
			 	null,
			 	null,
			 	null,
			 	ie_dispensavel_w,
			 	null,
			 	nr_seq_lote_fornec_w,
			 	CASE WHEN ie_gerar_consistido_w='S' THEN  'CB'  ELSE 'GI' END ,
				'N',
				'N',
				'N',
				'N',
				CASE WHEN cd_kit_material_p=0 THEN  CASE WHEN coalesce(cd_kit_material_w,0)=0 THEN null  ELSE cd_kit_material_w END   ELSE cd_kit_material_p END , /* Fabricio em 1/08/2008 OS 101127*/
				'N',
				nr_seq_kit_estoque_w, --decode(nvl(nr_seq_kit_estoque_p,0),0,null, nr_seq_kit_estoque_p),
				CASE WHEN cd_convenio_ww=0 THEN null  ELSE cd_convenio_ww END ,
				cd_categoria_w,
				'N',
				nr_doc_interno_w,
				CASE WHEN cd_local_estoque_p=0 THEN null  ELSE cd_local_estoque_p END ,
				CASE WHEN nr_seq_reg_kit_w=0 THEN null  ELSE nr_seq_reg_kit_w END ,
				nr_doc_interno_aux_w,
				ie_tipo_doc_interno_p,
				ie_tipo_doc_interno_aux_p,
				nm_usuario_p,
				nr_seq_justif_kit_p,
				ie_objetivo_w);
			end;
		end if;
		end;
	end if;
	end;
	end loop;
	close c01;
	commit;
	end;
end if;

if (coalesce(nr_seq_kit_estoque_p,0) > 0) and (coalesce(nr_cirurgia_w,0) > 0) and (coalesce(ie_gerou_itens_w, 'N') = 'S') then
	select	max(nr_atendimento)
	into STRICT	nr_atendimento_w
	from	prescr_medica
	where	nr_prescricao 	= nr_prescricao_p;
	
	if (ie_somente_consistidos_w = 'S') then		
		delete	from kit_estoque_comp
		where   nr_seq_kit_estoque = nr_seq_kit_estoque_p
		and     ie_gerado_barras = 'N';
	end if;

	update	kit_estoque
	set	dt_utilizacao = clock_timestamp(),
		nm_usuario_util 	= nm_usuario_p,
		nr_cirurgia	= nr_cirurgia_w,
		nr_prescricao	= nr_prescricao_p,
		nr_atendimento	= nr_atendimento_w
	where	nr_sequencia 	= nr_seq_kit_estoque_p;
end if;

select	count(*)
into STRICT	qt_existe_w
from	agenda_paciente
where 	nr_sequencia =  nr_seq_agenda_p
and	coalesce(ie_opme_integracao,'N') = 'S';

if (coalesce(qt_existe_w,0) > 0) then
	update	cirurgia
	set	ie_integracao_opme	= 'S'
	where	nr_seq_agenda		= nr_seq_agenda_p;
end if;

if (ie_gera_prescr_mat_esp_w = 'S') then
	CALL gerar_opme_materias_especiais(nr_seq_agenda_p,nm_usuario_p,cd_estabelecimento_w);
end if;	

if (ie_gera_prescr_mat_autor_w = 'S') and (coalesce(nr_cirurgia_w,0) > 0) then
	CALL Gerar_Prescr_Autoriz_Cirurgia(nr_cirurgia_w,nm_usuario_p,cd_estabelecimento_w);
end if;	

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_prescricao_cirurgia ( cd_kit_material_p bigint, nr_seq_kit_estoque_p bigint, nr_cirurgia_p bigint, nr_seq_agenda_p bigint, ie_origem_inf_p text, nm_usuario_p text, nr_prescricao_p bigint, nr_doc_interno_p bigint, cd_local_estoque_p bigint, cd_funcao_p bigint, cd_perfil_p bigint, cd_medico_p text, nr_doc_interno_aux_p bigint, ie_tipo_doc_interno_p text, ie_tipo_doc_interno_aux_p text, nr_seq_justif_kit_p bigint default null) FROM PUBLIC;

