-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_horario_med_agenda ( nr_seq_agenda_p bigint, cd_medico_p text, nr_minuto_duracao_p bigint, cd_tipo_agenda_p bigint, ds_erro_p INOUT text, dt_agenda_p timestamp default null) AS $body$
DECLARE


dt_inicial_w			timestamp;
dt_final_w			timestamp;
nr_seq_agenda_w			agenda_paciente.nr_sequencia%type;
nm_paciente_w			varchar(60);
ds_agenda_w			varchar(50);
dt_agenda_w			timestamp;
nm_medico_w			varchar(60);
cd_agenda_w			bigint;
cd_estabelecimento_w		integer;
ie_forma_cons_hor_medic_w	varchar(1);
cd_pessoa_fisica_w		varchar(10);
ie_somente_cirur_w		varchar(1);
cd_tipo_agenda_w		bigint;
ie_consiste_prof_cirurgia_w	varchar(1);
nr_minuto_duracao_w		agenda_paciente.nr_minuto_duracao%type;
nr_sequencia_prof_w		profissional_agenda.nr_sequencia%type;


BEGIN

ie_somente_cirur_w := obter_param_usuario(871, 266, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_somente_cirur_w);


if (coalesce(cd_medico_p::text, '') = '') then
	
		if (cd_tipo_agenda_p = 3)then
			
			begin
				select 	a.cd_pessoa_fisica
				into STRICT	cd_pessoa_fisica_w
				from	agenda_consulta b,
						agenda a
				where	a.cd_agenda 	 = b.cd_agenda
				and	b.nr_sequencia 	 = nr_seq_agenda_p;
			exception
			when others then
				cd_pessoa_fisica_w := null;
			end;
			
			
			BEGIN

			SELECT	dt_agenda,
					dt_agenda + (coalesce(nr_minuto_duracao_p, nr_minuto_duracao) / 1440) - (1/86400),
					cd_agenda
			INTO STRICT	dt_inicial_w,
					dt_final_w,
					cd_agenda_w
			FROM	agenda_consulta
			WHERE	nr_sequencia	= nr_seq_agenda_p;
			EXCEPTION
			WHEN OTHERS THEN
				dt_inicial_w	:= NULL;
				dt_final_w	:= NULL;
			END;	
		elsif (cd_tipo_agenda_p = 2)then
		
			begin
				select 	b.cd_medico_Exec
				into STRICT	cd_pessoa_fisica_w
				from	agenda_paciente b,
						agenda a
				where	a.cd_agenda = b.cd_agenda
				and		b.nr_sequencia = nr_seq_agenda_p;
			exception
			when others then
				cd_pessoa_fisica_w := null;
			end;
			
			BEGIN

			SELECT	hr_inicio,
					hr_inicio + (coalesce(nr_minuto_duracao_p, nr_minuto_duracao) / 1440) - (1/86400),
					cd_agenda
			INTO STRICT	dt_inicial_w,
					dt_final_w,
					cd_agenda_w
			FROM	agenda_paciente
			WHERE	nr_sequencia	= nr_seq_agenda_p;
			EXCEPTION
			WHEN OTHERS THEN
					dt_inicial_w	:= NULL;
					dt_final_w		:= NULL;
			END;		
		end if;
elsif (cd_tipo_agenda_p = 5) then
	BEGIN
	
	cd_pessoa_fisica_w := cd_medico_p;
	
	SELECT	cd_agenda
	INTO STRICT	cd_agenda_w
	FROM	agenda_consulta
	WHERE	nr_sequencia	= nr_seq_agenda_p;
	
	select	coalesce(max(pkg_date_utils.get_DiffDate(a.hr_inicial, a.hr_final, 'MINUTE')),0)
	into STRICT	nr_minuto_duracao_w
	from	agenda_turno a
	where	a.nr_sequencia =	(SELECT	coalesce(max(b.nr_seq_turno),0)
				from	agenda_consulta b
				WHERE	b.nr_sequencia	= nr_seq_agenda_p);
	
	SELECT	coalesce(dt_agenda_p,dt_agenda),
		coalesce(dt_agenda_p,dt_agenda) +  (nr_minuto_duracao_w / 1440) - (1/86400)
	INTO STRICT	dt_inicial_w,
		dt_final_w
	FROM	agenda_consulta
	WHERE	nr_sequencia	= nr_seq_agenda_p;
	EXCEPTION
	WHEN OTHERS THEN
		dt_inicial_w	:= NULL;
		dt_final_w	:= NULL;
	END;
	
else
	cd_pessoa_fisica_w := cd_medico_p;
	
	BEGIN
	SELECT	hr_inicio,
			hr_inicio + (coalesce(nr_minuto_duracao_p, nr_minuto_duracao) / 1440) - (1/86400),
			cd_agenda
	INTO STRICT	dt_inicial_w,
			dt_final_w,
			cd_agenda_w
	FROM	agenda_paciente
	WHERE	nr_sequencia	= nr_seq_agenda_p;
	EXCEPTION
	WHEN OTHERS THEN
			dt_inicial_w	:= NULL;
			dt_final_w	:= NULL;
	END;
end if;

begin
	SELECT	cd_estabelecimento
	INTO STRICT	cd_estabelecimento_w
	FROM	agenda
	WHERE	cd_agenda = cd_agenda_w;
exception
when others then
	cd_estabelecimento_w := null;
end;


SELECT	coalesce(max(ie_forma_cons_hor_medic),'R'),
	coalesce(max(ie_consiste_prof_cirur),'N')
INTO STRICT	ie_forma_cons_hor_medic_w,
	ie_consiste_prof_cirurgia_w
FROM	parametro_agenda
WHERE	cd_estabelecimento = cd_estabelecimento_w;

if ie_forma_cons_hor_medic_w = 'R' then	
	if (cd_tipo_agenda_p <> 5 ) then		
		SELECT	coalesce(max(b.nr_sequencia), 0)
		INTO STRICT	nr_seq_agenda_w
		FROM	agenda_paciente b,
			agenda a
		WHERE	a.cd_agenda = b.cd_agenda
		AND	a.ie_situacao = 'A'
		AND	b.hr_inicio BETWEEN dt_inicial_w AND dt_final_w
		AND	b.nr_sequencia	<> nr_seq_agenda_p
		and (coalesce(b.cd_medico_exec, b.cd_medico) = cd_pessoa_fisica_w)
		AND	b.ie_status_agenda NOT IN ('C','L','B','II');		
	else		
		SELECT	coalesce(max(b.nr_sequencia), 0)
		INTO STRICT	nr_seq_agenda_w
		FROM	agenda_paciente b,
			agenda a
		WHERE	a.cd_agenda = b.cd_agenda
		AND	a.ie_situacao = 'A'
		AND	b.hr_inicio BETWEEN dt_inicial_w AND dt_final_w
		AND	b.nr_sequencia	<> nr_seq_agenda_p
		and (coalesce(b.cd_medico_exec, b.cd_medico) = cd_pessoa_fisica_w)
		AND	b.ie_status_agenda NOT IN ('C','L','B','II');		
	end if;
	
	if (nr_seq_agenda_w = 0) then				
		SELECT	coalesce(max(b.nr_sequencia), 0)
		INTO STRICT	nr_seq_agenda_w
		FROM	agenda_paciente b,
			agenda a
		WHERE	a.cd_agenda = b.cd_agenda
		AND	a.ie_situacao = 'A'
		and	b.hr_inicio + (b.nr_minuto_duracao / 1440) - (1/86400) BETWEEN dt_inicial_w AND dt_final_w
		and (coalesce(b.cd_medico_exec, b.cd_medico) = cd_pessoa_fisica_w)
		AND		b.nr_sequencia	<> nr_seq_agenda_p
		AND		b.ie_status_agenda NOT IN ('C','L','B','II');	
			
		if (nr_seq_agenda_w = 0) then						
			SELECT	coalesce(max(b.nr_sequencia), 0)
			INTO STRICT	nr_seq_agenda_w
			FROM	agenda_paciente b,
				agenda a
			WHERE	a.cd_agenda = b.cd_agenda
			AND	a.ie_situacao = 'A'
			and	((b.hr_inicio < dt_inicial_w) AND (b.hr_inicio + (b.nr_minuto_duracao / 1440) - (1/86400) > dt_final_w))
			and (coalesce(b.cd_medico_exec, b.cd_medico) = cd_pessoa_fisica_w)
			AND		b.nr_sequencia	<> nr_seq_agenda_p
			AND		b.ie_status_agenda NOT IN ('C','L','B','II');								
		end if;
	end if;
else nr_seq_agenda_w	:= 0;
end if;

if (nr_seq_agenda_w = 0) then
	
	if ( ie_forma_cons_hor_medic_w = 'E') then				
		SELECT	coalesce(max(b.nr_sequencia), 0)
		INTO STRICT	nr_seq_agenda_w
		FROM	agenda_paciente b,
			agenda a
		WHERE	a.cd_agenda = b.cd_agenda
		AND	a.ie_situacao = 'A'
		AND	b.hr_inicio BETWEEN dt_inicial_w AND dt_final_w
		AND	b.cd_medico_exec	= cd_pessoa_fisica_w
		AND	b.nr_sequencia	<> nr_seq_agenda_p
		AND	b.ie_status_agenda NOT IN ('C','L','B','II');
		
		if (nr_seq_agenda_w = 0) then								
			SELECT	coalesce(max(b.nr_sequencia), 0)
			INTO STRICT	nr_seq_agenda_w
			FROM	agenda_paciente b,
				agenda a
			WHERE	a.cd_agenda = b.cd_agenda
			AND	a.ie_situacao = 'A'
			AND	b.hr_inicio + (b.nr_minuto_duracao / 1440) - (1/86400) BETWEEN dt_inicial_w AND dt_final_w
			AND	b.cd_medico_exec	= cd_pessoa_fisica_w
			AND	b.nr_sequencia	<> nr_seq_agenda_p
			AND	b.ie_status_agenda NOT IN ('C','L','B','II');

			if (nr_seq_agenda_w = 0) then
				SELECT	coalesce(max(b.nr_sequencia), 0)
				INTO STRICT	nr_seq_agenda_w
				FROM	agenda_paciente b,
					agenda a
				WHERE	a.cd_agenda = b.cd_agenda
				AND	a.ie_situacao = 'A'
				AND	((b.hr_inicio < dt_inicial_w) AND (b.hr_inicio + (b.nr_minuto_duracao / 1440) - (1/86400) > dt_final_w))
				AND	b.cd_medico_exec	= cd_pessoa_fisica_w
				AND	b.nr_sequencia	<> nr_seq_agenda_p
				AND	b.ie_status_agenda NOT IN ('C','L','B','II');
			end if;
		end if;
	else
		nr_seq_agenda_w := 0;
	end if;	
	
	if (nr_seq_agenda_w = 0) and (ie_consiste_prof_cirurgia_w = 'S') and (ie_forma_cons_hor_medic_w in ('E', 'R')) then		
		SELECT	coalesce(max(a.nr_sequencia), 0)
		INTO STRICT	nr_seq_agenda_w
		FROM	agenda_paciente a,
			profissional_agenda b,
			agenda c
		WHERE	a.cd_agenda = c.cd_agenda
		and	c.ie_situacao = 'A'
		and	a.nr_sequencia = b.nr_seq_agenda
		and	a.hr_inicio BETWEEN dt_inicial_w AND dt_final_w
		AND	b.cd_profissional	= cd_pessoa_fisica_w
		AND	a.nr_sequencia	<> nr_seq_agenda_p
		AND	a.ie_status_agenda NOT IN ('C','L','B','II');
		if (nr_seq_agenda_w = 0) then				
			SELECT	coalesce(max(a.nr_sequencia), 0)
			INTO STRICT	nr_seq_agenda_w
			FROM	agenda_paciente a,
				profissional_agenda b,
				agenda c
			WHERE	a.cd_agenda = c.cd_agenda
			and	c.ie_situacao = 'A'
			and	a.nr_sequencia = b.nr_seq_agenda
			and	a.hr_inicio + (nr_minuto_duracao / 1440) - (1/86400) BETWEEN dt_inicial_w AND dt_final_w
			AND	b.cd_profissional	= cd_pessoa_fisica_w
			AND	a.nr_sequencia	<> nr_seq_agenda_p
			AND	a.ie_status_agenda NOT IN ('C','L','B','II');				
			if (nr_seq_agenda_w = 0) then
				SELECT	coalesce(max(a.nr_sequencia), 0)
				INTO STRICT	nr_seq_agenda_w
				FROM	agenda_paciente a,
					profissional_agenda b,
					agenda c
				WHERE	a.cd_agenda = c.cd_agenda
				and	c.ie_situacao = 'A'
				and	a.nr_sequencia = b.nr_seq_agenda
				and	((a.hr_inicio < dt_inicial_w) AND (a.hr_inicio + (a.nr_minuto_duracao / 1440) - (1/86400) > dt_final_w))
				AND	b.cd_profissional	= cd_pessoa_fisica_w
				AND	a.nr_sequencia	<> nr_seq_agenda_p
				AND	a.ie_status_agenda NOT IN ('C','L','B','II');
			end if;
		end if;
	--else 

	--	nr_seq_agenda_w := 0;
	end if;
end if;

IF (nr_seq_agenda_w > 0) THEN	
	SELECT	SUBSTR(obter_nome_pf(b.cd_pessoa_fisica),1,60),
		b.hr_inicio,
		SUBSTR(obter_nome_agenda(b.cd_agenda),1,50),
		SUBSTR(obter_nome_pf(coalesce(b.cd_medico_exec,b.cd_medico)),1,60),
		obter_tipo_agenda(b.cd_agenda)
	INTO STRICT	nm_paciente_w,
		dt_agenda_w,
		ds_agenda_w,
		nm_medico_w,
		cd_tipo_agenda_w
	FROM	agenda_paciente b,
		agenda a
	WHERE	b.nr_sequencia	= nr_seq_agenda_w
	AND	b.cd_agenda = a.cd_agenda
	AND	a.ie_situacao = 'A';
	
	IF (nr_seq_agenda_w > 0) and (coalesce(nm_medico_w::text, '') = '') and (ie_consiste_prof_cirurgia_w = 'S') THEN		
		select 	coalesce(max(b.nr_sequencia), 0)
		into STRICT	nr_sequencia_prof_w
		FROM	agenda_paciente a,
			profissional_agenda b,
			agenda c
		WHERE	a.cd_agenda = c.cd_agenda
		AND	c.ie_situacao = 'A'
		AND	a.nr_sequencia = b.nr_seq_agenda
		AND	a.nr_sequencia	= nr_seq_agenda_w;
		
		if (nr_sequencia_prof_w > 0) then
			SELECT	SUBSTR(obter_nome_pf(a.cd_pessoa_fisica),1,60),
				a.hr_inicio,
				SUBSTR(obter_nome_agenda(a.cd_agenda),1,50),
				SUBSTR(obter_nome_pf(coalesce(b.cd_profissional, a.cd_medico_exec)),1,60),
				obter_tipo_agenda(a.cd_agenda)
			INTO STRICT	nm_paciente_w,
				dt_agenda_w,
				ds_agenda_w,
				nm_medico_w,
				cd_tipo_agenda_w
			FROM	agenda_paciente a,
				profissional_agenda b,
				agenda c
			WHERE	a.nr_sequencia = b.nr_seq_agenda
			and	a.cd_agenda = c.cd_agenda
			and	c.ie_situacao = 'A'
			and	b.nr_sequencia = nr_sequencia_prof_w
			AND	a.nr_sequencia	= nr_seq_agenda_w;
		end if;
	END IF;
	
	if (ie_somente_cirur_w = 'S') and (cd_tipo_agenda_w <> 1) then
		nm_medico_w := null;
	end if;
	
	IF (nm_medico_w IS NOT NULL AND nm_medico_w::text <> '') THEN
		ds_erro_p :=	WHEB_MENSAGEM_PCK.get_texto(278091,'NM_MEDICO='||nm_medico_w||';NM_PACIENTE='||nm_paciente_w||';DT_AGENDA='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_agenda_w, 'short', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)||';DS_AGENDA='||ds_agenda_w) || CHR(13);
	END IF;
ELSE
	BEGIN
	
	if ie_forma_cons_hor_medic_w IN ('E','R') and (coalesce(ie_somente_cirur_w,'N') = 'N') then		
		SELECT	coalesce(max(nr_sequencia), 0)
		INTO STRICT	nr_seq_agenda_w
		FROM	agenda b,
				agenda_consulta a
		WHERE	a.cd_agenda = b.cd_agenda
		and		b.ie_situacao = 'A'
		and		dt_agenda BETWEEN dt_inicial_w AND dt_final_w
		AND		B.cd_pessoa_FISica	= cd_pessoa_fisica_w
		AND		nr_sequencia	<> nr_seq_agenda_p
		AND		ie_status_agenda NOT IN ('C','L','B','II');	
		if (nr_seq_agenda_w = 0) then
			SELECT	coalesce(max(nr_sequencia), 0)
			INTO STRICT	nr_seq_agenda_w
			FROM	agenda b,
					agenda_consulta a
			WHERE	a.cd_agenda = b.cd_agenda
			and		b.ie_situacao = 'A'
			and		dt_agenda + (nr_minuto_duracao / 1440) - (1/86400) BETWEEN dt_inicial_w AND dt_final_w
			AND		B.cd_pessoa_FISica	= cd_pessoa_fisica_w
			AND		nr_sequencia	<> nr_seq_agenda_p
			AND		ie_status_agenda NOT IN ('C','L','B','II');			
			if (nr_seq_agenda_w = 0) then
				SELECT	coalesce(max(nr_sequencia), 0)
				INTO STRICT	nr_seq_agenda_w
				FROM	agenda b,
						agenda_consulta a
				WHERE	a.cd_agenda = b.cd_agenda
				and		b.ie_situacao = 'A'
				and		((dt_agenda < dt_inicial_w) AND (dt_agenda + (nr_minuto_duracao / 1440) - (1/86400) > dt_final_w))
				AND		B.cd_pessoa_FISica	= cd_pessoa_fisica_w
				AND		nr_sequencia	<> nr_seq_agenda_p
				AND		ie_status_agenda NOT IN ('C','L','B','II');
			end if;
		end if;
		
		if (cd_tipo_agenda_p = 5) and (coalesce(nr_seq_agenda_w,0) = 0) then			
			SELECT	coalesce(max(nr_sequencia), 0)
			INTO STRICT	nr_seq_agenda_w
			FROM	agenda b,
					agenda_consulta a
			WHERE	a.cd_agenda = b.cd_agenda
			and		b.ie_situacao = 'A'
			and		dt_agenda BETWEEN dt_inicial_w AND dt_final_w
			AND		a.cd_medico	= cd_pessoa_fisica_w
			and		b.cd_tipo_agenda	= 5
			AND		nr_sequencia	<> nr_seq_agenda_p
			and		a.cd_agenda		<> cd_Agenda_w
			AND		ie_status_agenda NOT IN ('C','L','B','II');
			if (nr_seq_agenda_w = 0) then						
				SELECT	coalesce(max(nr_sequencia), 0)
				INTO STRICT	nr_seq_agenda_w
				FROM	agenda b,
						agenda_consulta a
				WHERE	a.cd_agenda = b.cd_agenda
				and		b.ie_situacao = 'A'
				and		dt_agenda + (nr_minuto_duracao / 1440) - (1/86400) BETWEEN dt_inicial_w AND dt_final_w
				AND		a.cd_medico	= cd_pessoa_fisica_w
				and		b.cd_tipo_agenda	= 5
				AND		nr_sequencia	<> nr_seq_agenda_p
				and		a.cd_agenda		<> cd_Agenda_w
				AND		ie_status_agenda NOT IN ('C','L','B','II')
				AND 	nr_minuto_duracao > 0
				And     (nr_minuto_duracao IS NOT NULL AND nr_minuto_duracao::text <> '');
				if (nr_seq_agenda_w = 0) then					
					SELECT	coalesce(max(nr_sequencia), 0)
					INTO STRICT	nr_seq_agenda_w
					FROM	agenda b,
							agenda_consulta a
					WHERE	a.cd_agenda = b.cd_agenda
					and		b.ie_situacao = 'A'
					and		((dt_agenda < dt_inicial_w) AND (dt_agenda + (nr_minuto_duracao / 1440) - (1/86400) > dt_final_w))
					AND		a.cd_medico	= cd_pessoa_fisica_w
					and		b.cd_tipo_agenda	= 5
					AND		nr_sequencia	<> nr_seq_agenda_p
					and		a.cd_agenda		<> cd_Agenda_w
					AND		ie_status_agenda NOT IN ('C','L','B','II')
					AND 	nr_minuto_duracao > 0
					And     (nr_minuto_duracao IS NOT NULL AND nr_minuto_duracao::text <> '');
				end if;
			end if;								
		end if;		
		
		if (cd_tipo_agenda_p = 3) and (nr_seq_agenda_w = 0) then
			SELECT	coalesce(max(a.nr_sequencia), 0)
			INTO STRICT	nr_seq_agenda_w
			FROM	agenda_consulta a,
				agenda b
			WHERE	a.cd_agenda = b.cd_agenda
			AND	b.ie_situacao = 'A'
			AND	a.dt_agenda BETWEEN dt_inicial_w AND dt_final_w
			AND	a.cd_medico = cd_pessoa_fisica_w
			AND	a.nr_sequencia	<> nr_seq_agenda_p
			AND	a.ie_status_agenda NOT IN ('C','L','B','II');
		end if;
	else nr_seq_agenda_w := 0;
	end if;
	
	exception
	when others then
		nr_seq_agenda_w := 0;
		dt_inicial_w	:= NULL;
		dt_final_w		:= NULL;
	END;
	
	IF (nr_seq_agenda_w > 0) THEN
	
		BEGIN
		SELECT	SUBSTR(obter_nome_pf(a.cd_pessoa_fisica),1,60),
				dt_agenda,
				SUBSTR(obter_nome_medico_combo_agcons(cd_estabelecimento_w, b.cd_Agenda, b.cd_tipo_Agenda, 'N'),1,50),
				CASE WHEN b.cd_tipo_agenda=5 THEN SUBSTR(obter_nome_pf(a.cd_medico),1,60)  ELSE SUBSTR(obter_nome_pf(b.cd_pessoa_fisica),1,60) END
		INTO STRICT	nm_paciente_w,
				dt_agenda_w,
				ds_agenda_w,
				nm_medico_w
		FROM	agenda_consulta a,
				agenda b
		WHERE	a.cd_agenda = b.cd_agenda
		and	b.ie_situacao = 'A'
		and		nr_sequencia	= nr_seq_agenda_w;
		EXCEPTION
		WHEN OTHERS THEN
				nm_medico_w := NULL;
		END;

		IF (nm_medico_w IS NOT NULL AND nm_medico_w::text <> '') THEN
			ds_erro_p :=	WHEB_MENSAGEM_PCK.get_texto(278091,'NM_MEDICO='||nm_medico_w||';NM_PACIENTE='||nm_paciente_w||';DT_AGENDA='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_agenda_w, 'short', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)||';DS_AGENDA='||ds_agenda_w) || CHR(13);
		END IF;
	END IF;	
END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_horario_med_agenda ( nr_seq_agenda_p bigint, cd_medico_p text, nr_minuto_duracao_p bigint, cd_tipo_agenda_p bigint, ds_erro_p INOUT text, dt_agenda_p timestamp default null) FROM PUBLIC;

