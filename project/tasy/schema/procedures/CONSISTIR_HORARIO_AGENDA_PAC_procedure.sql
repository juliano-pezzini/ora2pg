-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_horario_agenda_pac (cd_agenda_p bigint, ie_dia_semana_p bigint, hr_inicio_p timestamp, hr_final_p timestamp, ds_erro_p INOUT text) AS $body$
DECLARE

 
 
ds_erro_w		varchar(255)	:= '';
cd_medico_w		varchar(10);
cd_agenda_w		varchar(10);
qt_agenda_w		bigint	:= 0;
qt_agenda_total_w	bigint	:= 0;

c01 CURSOR FOR 
	SELECT	a.cd_pessoa_fisica, 
		a.cd_agenda 
	from	agenda a, 
		agenda_medico b 
	where	a.cd_pessoa_fisica	= b.cd_medico 
	and	b.cd_agenda		= cd_agenda_p 
	and	a.ie_situacao		= 'A';

c02 CURSOR FOR 
	SELECT	count(*) 
	from	agenda b, 
		agenda_turno a 
	where	a.cd_agenda	= cd_agenda_w 
	and	a.cd_agenda	= b.cd_agenda 
	and	b.ie_situacao	= 'A' 
	and	ie_dia_semana	= ie_dia_semana_p 
	and	to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_final, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') > 
			to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_inicio_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') 
	and	to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_inicial, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') < 
			to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_inicio_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') 
	
union
 
	SELECT	count(*) 
	from	agenda b, 
		agenda_turno a 
	where	a.cd_agenda	= cd_agenda_w 
	and	a.cd_agenda	= b.cd_agenda 
	and	b.ie_situacao	= 'A' 
	and	ie_dia_semana	= ie_dia_semana_p 
	and	to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_inicial, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') < 
			to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_final_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') 
	and	to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_final, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') > 
			to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_final_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') 
	
union
 
	select	count(*) 
	from	agenda b, 
		agenda_turno a 
	where	a.cd_agenda	= cd_agenda_w 
	and	a.cd_agenda	= b.cd_agenda 
	and	b.ie_situacao	= 'A' 
	and	ie_dia_semana	= ie_dia_semana_p 
	and	to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_inicial, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') >= 
			to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_inicio_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') 
 
	and	to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_final, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') <= 
			to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_final_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') 
	
union
 
	select	count(*) 
	from	agenda b, 
		agenda_turno a 
	where	a.cd_agenda	= cd_agenda_w 
	and	a.cd_agenda	= b.cd_agenda 
	and	b.ie_situacao	= 'A' 
	and	ie_dia_semana	= ie_dia_semana_p 
	and	to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_inicial, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') >= 
			to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_inicio_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') 
 
	and	to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_inicial, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') >= 
			to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_final_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') 
 
	and	to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_final, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') <= 
			to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_final_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') 
	
union
 
	select	count(*) 
	from	agenda b, 
		agenda_turno a 
	where	a.cd_agenda	= cd_agenda_w 
	and	a.cd_agenda	= b.cd_agenda 
	and	b.ie_situacao	= 'A' 
	and	ie_dia_semana	= ie_dia_semana_p 
	and	to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_inicial, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') <= 
			to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_inicio_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') 
 
	and	to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_final, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') >= 
			to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_final_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') 
	
union
 
	select	count(*) 
	from	agenda b, 
		agenda_turno a 
	where	a.cd_agenda	= cd_agenda_w 
	and	a.cd_agenda	= b.cd_agenda 
	and	b.ie_situacao	= 'A' 
	and	ie_dia_semana	= ie_dia_semana_p 
	and	to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_inicial, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') <= 
			to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_inicio_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') 
 
	and	to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_final, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') <= 
			to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_final_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') 
 
	and	to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_final, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss') > 
			to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || to_char(hr_inicio_p, 'hh24:mi:ss'), 'dd/mm/yyyy hh24:mi:ss');


BEGIN 
 
open	c01;
loop 
fetch	c01 into 
	cd_medico_w, 
	cd_agenda_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
 
	open	c02;
	loop 
	fetch	c02 into 
		qt_agenda_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin 
 
		qt_agenda_total_w	:= qt_agenda_total_w + qt_agenda_w;
			 
		end;
	end loop;
	close c02;
 
	end;
end loop;
close c01;
 
if (qt_agenda_total_w > 0) then 
	ds_erro_w	:= wheb_mensagem_pck.get_texto(279111);
end if;
 
ds_erro_p	:= ds_erro_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_horario_agenda_pac (cd_agenda_p bigint, ie_dia_semana_p bigint, hr_inicio_p timestamp, hr_final_p timestamp, ds_erro_p INOUT text) FROM PUBLIC;

