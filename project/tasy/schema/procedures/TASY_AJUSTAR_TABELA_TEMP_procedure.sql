-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_ajustar_tabela_temp () AS $body$
DECLARE


nm_tabela_w		varchar(50);
nm_tablespace_w		varchar(50);
qt_processo_w		bigint;
nm_indice_w		varchar(30);
ie_recriar_w		varchar(1) := 'N';
ie_online_w		varchar(1) := 'N';

C01 CURSOR FOR
SELECT 	a.nm_tabela
from	tabela_sistema a,
	user_tables b
where	a.nm_tabela = b.table_name
and	a.ie_temporaria = 'S'
and	b.tablespace_name <> nm_tablespace_w
and	not exists (	select 1 from tabela_atributo x
			where x.nm_tabela = a.nm_tabela
			  and x.ie_tipo_atributo = 'LONG');

C02 CURSOR FOR
	SELECT	index_name
	from	user_indexes
	where	table_name 	= nm_tabela_w
	and	status = 'UNUSABLE' or ie_recriar_w = 'S';

C03 CURSOR FOR
	SELECT	index_name
	from	user_indexes
	where	status = 'UNUSABLE';

C04 CURSOR FOR
	SELECT	a.table_name
	from	user_tables a,
		tabela_sistema b
	where	a.table_name = b.nm_tabela
	and	b.ie_temporaria not in ('G','GD')
	and	a.logging = 'NO';

C05 CURSOR FOR
	SELECT 	a.nm_tabela
	from	tabela_sistema a,
		user_tables b
	where	a.nm_tabela = b.table_name
	and	a.ie_temporaria in ('G','GD')
	and	(b.tablespace_name IS NOT NULL AND b.tablespace_name::text <> '')
	
union

	SELECT 	a.nm_tabela
	from	tabela_sistema a,
		user_tables b
	where	a.nm_tabela = b.table_name
	and	a.ie_temporaria = 'S'
	and	coalesce(b.tablespace_name::text, '') = ''
	
union

	select 	a.nm_tabela
	from	tabela_sistema a,
			user_tables b
	where	a.nm_tabela = b.table_name
	and		a.ie_temporaria = 'N'
	and		coalesce(b.tablespace_name::text, '') = ''
	
union

	select 	a.nm_tabela
	from	tabela_sistema a,
		user_tables b
	where	a.nm_tabela = b.table_name
	and	a.ie_temporaria = 'S'
	and	b.tablespace_name <> nm_tablespace_w
	and	exists (select 1 from tabela_atributo x
			where x.nm_tabela = a.nm_tabela
			  and x.ie_tipo_atributo = 'LONG');


BEGIN
qt_processo_w	:=	0;

CALL GRAVAR_PROCESSO_LONGO('','TASY_AJUSTAR_TABELA_TEMP',qt_processo_w);

/*Ajusta a tablespace das tabelas temporÃ¡rias*/

select 	trim(both upper(obter_tablespace_tab_temp))
into STRICT	nm_tablespace_w
;

open C01;
loop
fetch C01 into
	nm_tabela_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
		if (wheb_usuario_pck.get_configurar_tablespace = 'S') then
			nm_tablespace_w	:= obter_tablespace_tab_temp(nm_tabela_w);
			CALL exec_sql_dinamico('Tabela ->'|| nm_tabela_w,'alter table '|| nm_tabela_w ||' move tablespace '|| nm_tablespace_w);
		else
			CALL exec_sql_dinamico('Tabela ->'|| nm_tabela_w,'alter table '|| nm_tabela_w ||' move tablespace '|| nm_tablespace_w);
		end	if;
		CALL gravar_processo_longo('Tabela -> Move Tablespace'||nm_tabela_w ,'TASY_AJUSTAR_TABELA_TEMP',qt_processo_w);
		qt_processo_w := qt_processo_w + 1;
		open C02;
		loop
		fetch C02 into
			nm_indice_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
				CALL exec_sql_dinamico('Tabela ->'|| nm_tabela_w,'alter index '||nm_indice_w||' rebuild');
			end;
		end loop;
		close C02;
	end;
end loop;
close C01;

ie_online_w := obter_online_index_build;

open C05;
loop
fetch C05 into
	nm_tabela_w;
EXIT WHEN NOT FOUND; /* apply on C05 */
	begin
		CALL exec_sql_dinamico('Tabela ->'|| nm_tabela_w,' drop table '||nm_tabela_w||' cascade constraints');
		CALL Tasy_Criar_Alterar_Tabela(nm_tabela_w, 'C', '');
		ie_recriar_w := 'S';

		begin
		open C03;
		loop
		fetch C03 into nm_indice_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
			CALL Tasy_Criar_Indice(nm_tabela_w, nm_indice_w, 1, 'S', ie_online_w);
		end loop;
		close C03;
		exception
			when others then
				ie_recriar_w := 'N';
		end;
		ie_recriar_w := 'N';
	end;
end loop;
close C05;

open C03;
loop
fetch C03 into
	nm_indice_w;
EXIT WHEN NOT FOUND; /* apply on C03 */
	begin
		CALL exec_sql_dinamico('Indice ->'|| nm_indice_w,'alter index '||nm_indice_w||' rebuild');
	end;
end loop;
close C03;

open C04;
loop
fetch C04 into
	nm_tabela_w;
EXIT WHEN NOT FOUND; /* apply on C04 */
	begin
		CALL exec_sql_dinamico('Tabela ->'|| nm_tabela_w,'alter table '||nm_tabela_w||' logging');
	end;
end loop;
close C04;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_ajustar_tabela_temp () FROM PUBLIC;

