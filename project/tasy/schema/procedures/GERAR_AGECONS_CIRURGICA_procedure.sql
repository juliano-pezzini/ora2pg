-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_agecons_cirurgica ( nr_seq_agecons_p bigint, nr_seq_agecir_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
cd_pessoa_fisica_w		varchar(10);
cd_convenio_w			integer;
dt_nascimento_w			timestamp;
qt_idade_w				smallint;
cd_categoria_w			varchar(10);
cd_plano_w				varchar(10);
cd_tipo_acomodacao_w	smallint;
cd_usuario_convenio_w	varchar(30);
nr_doc_convenio_w		varchar(20);
dt_validade_carteira_w	timestamp;
nr_atendimento_w		bigint;
ie_status_agenda_w		varchar(3);
nr_telefone_w			agenda_paciente.nr_telefone%type;


BEGIN 
 
if (nr_seq_agecons_p IS NOT NULL AND nr_seq_agecons_p::text <> '') and (nr_seq_agecir_p IS NOT NULL AND nr_seq_agecir_p::text <> '') then 
	begin 
 
	/* obter dados da agenda cirúrgica */
 
	select	a.cd_pessoa_fisica, 
			a.cd_convenio, 
			to_date(obter_dados_pf(a.cd_pessoa_fisica,'DN'),'dd/mm/yyyy'), 
			(obter_dados_pf(a.cd_pessoa_fisica,'I'))::numeric , 
			a.cd_categoria, 
			a.cd_plano, 
			a.cd_tipo_acomodacao, 
			a.cd_usuario_convenio, 
			a.nr_doc_convenio, 
			a.dt_validade_carteira, 
			a.nr_atendimento, 
			a.ie_status_agenda, 
			a.nr_telefone 
	into STRICT	cd_pessoa_fisica_w, 
			cd_convenio_w, 
			dt_nascimento_w, 
			qt_idade_w, 
			cd_categoria_w, 
			cd_plano_w, 
			cd_tipo_acomodacao_w, 
			cd_usuario_convenio_w, 
			nr_doc_convenio_w, 
			dt_validade_carteira_w, 
			nr_atendimento_w, 
			ie_status_agenda_w, 
			nr_telefone_w 
	from	agenda_paciente a 
	where	a.nr_sequencia = nr_seq_agecir_p;
 
	if (ie_status_agenda_w <> 'C') and (ie_status_agenda_w <> 'B') and (ie_status_agenda_w <> 'L') then 
	 
		if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then 
		/* Gerando a agenda consulta conforme a agenda cirúrgica */
 
		update	agenda_consulta 
		set	cd_pessoa_fisica		= cd_pessoa_fisica_w, 
			cd_convenio				= cd_convenio_w, 
			dt_nascimento_pac		= dt_nascimento_w, 
			qt_idade_pac			= qt_idade_w, 
			cd_categoria			= cd_categoria_w, 
			cd_plano				= cd_plano_w, 
			cd_tipo_acomodacao		= cd_tipo_acomodacao_w, 
			cd_usuario_convenio		= cd_usuario_convenio_w, 
			dt_validade_carteira	= dt_validade_carteira_w, 
			ie_status_agenda		= 'N', 
			dt_atualizacao			= clock_timestamp(), 
			nm_usuario				= nm_usuario_p, 
			nm_paciente				= obter_nome_pf(cd_pessoa_fisica_w), 
			nm_usuario_origem		= nm_usuario_p, 
			dt_agendamento			= clock_timestamp(), 
			nr_atendimento			= nr_atendimento_w, 
			nr_seq_agepaci			= nr_seq_agecir_p, 
			nr_telefone				= nr_telefone_w 
		where	nr_sequencia		= nr_seq_agecons_p;
		else 
			CALL wheb_mensagem_pck.EXIBIR_MENSAGEM_ABORT(818230);
		end if;
	end if;
 
	end;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_agecons_cirurgica ( nr_seq_agecons_p bigint, nr_seq_agecir_p bigint, nm_usuario_p text) FROM PUBLIC;

