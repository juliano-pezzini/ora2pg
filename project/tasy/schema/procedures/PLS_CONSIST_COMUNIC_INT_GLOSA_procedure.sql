-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consist_comunic_int_glosa (nr_seq_lote_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Consistir a comunicação de internação
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [ ] Tasy (Delphi/Java) [ x ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_segurado_guia_w		bigint;
qt_registros_w			bigint;
nr_seq_guia_w			bigint;
ie_guia_apres_w			varchar(1) := 'N';
ie_origem_lote_w		varchar(1);
ie_status_w			varchar(2) := 'CS';
ie_status_lote_w		varchar(2) := 'CS';
nr_seq_prestador_lote_w		bigint;
cd_prestador_w			varchar(30);
cd_prestador_guia_w		varchar(30);
nr_seq_prestador_w		bigint;
ie_tipo_vinculo_w		pls_param_import_int_alta.ie_tipo_vinculo%type;

C01 CURSOR FOR
	SELECT	cd_guia,
		cd_usuario_plano,
		nr_seq_segurado,
		nr_seq_guia,
		nr_sequencia
	from	pls_comunicacao_internacao
	where	nr_seq_lote_inter = nr_seq_lote_p;

BEGIN


select	max(nr_seq_prestador)
into STRICT	nr_seq_prestador_lote_w
from	pls_lote_comunicacao_inter
where	nr_Sequencia = nr_seq_lote_p;

begin
	select	coalesce(ie_tipo_vinculo, '0')
	into STRICT	ie_tipo_vinculo_w
	from	pls_param_import_int_alta;
exception
when others then
	ie_tipo_vinculo_w := '0';
end;

if (coalesce(nr_seq_prestador_lote_w::text, '') = '') then
	-- seta a sequencia do prestador no lote, pois quando o mesmo é gerado por WS não possui o prestador logodo
	select	max(b.nr_seq_prestador)
	into STRICT	nr_seq_prestador_w
	from	pls_comunicacao_internacao a,
		pls_guia_plano b
	where	a.nr_seq_guia = b.nr_sequencia
	and	a.nr_seq_lote_inter =  nr_seq_lote_p;

	update	pls_lote_comunicacao_inter
	set	nr_seq_prestador = nr_seq_prestador_w
	where	nr_sequencia =  nr_seq_lote_p;
end if;

begin
	select	ie_origem_lote,
		nr_seq_prestador,
		coalesce(cd_prestador,'X')
	into STRICT	ie_origem_lote_w,
		nr_seq_prestador_lote_w,
		cd_prestador_w
	from 	pls_lote_comunicacao_inter
	where	nr_sequencia = nr_seq_lote_p;
exception
when others then
	nr_seq_prestador_lote_w := NULL;
end;




for r_C01 in C01 loop

	ie_status_w := 'CS';

	if (coalesce(r_C01.nr_seq_segurado::text, '') = '') then
		-- Número da carteira inválido
		CALL pls_salvar_comunic_int_glosa(r_C01.nr_sequencia, '1001',nm_usuario_p);
	elsif (r_C01.nr_seq_guia IS NOT NULL AND r_C01.nr_seq_guia::text <> '') then

		begin
			select	nr_seq_segurado,
				nr_seq_prestador
			into STRICT	nr_seq_segurado_guia_w,
				nr_seq_prestador_w
			from	pls_guia_plano
			where	nr_sequencia = r_C01.nr_seq_guia;
		exception
		when others then
			nr_seq_prestador_w := null;
			nr_seq_segurado_guia_w := null;
		end;

		if (nr_seq_segurado_guia_w <> coalesce(r_C01.nr_seq_segurado,0)) then
			-- Identificação do beneficiário não consistente
			CALL pls_salvar_comunic_int_glosa(r_C01.nr_sequencia, '1011',nm_usuario_p);
		end if;

		if (ie_origem_lote_w = 'T') then
			if (coalesce(nr_seq_prestador_lote_w,0) <> nr_seq_prestador_w) then

					select	max(cd_prestador)
					into STRICT	cd_prestador_guia_w
					from	pls_prestador
					where	nr_Sequencia = coalesce(nr_seq_prestador_lote_w,0)
					and	ie_situacao = 'A';

					if (coalesce(cd_prestador_guia_w, cd_prestador_w||'X') <> cd_prestador_w) then
						/* Código Prestador inválido */

						CALL pls_salvar_comunic_int_glosa(r_C01.nr_sequencia, '1203',nm_usuario_p);
					end if;

			end if;
		end if;

	end if;

	-- Só vai consistir a glosa 1307 se o sistema estiver parametrizado para vincular a comunicação a uma guia automacicamente
	if (coalesce(r_C01.nr_seq_guia::text, '') = '') and (ie_tipo_vinculo_w = '0') then
		/* Conforme conversado com o Leonardo Cunha, pode ter situações que a guia ainda não existe na comunicação de internação, exemplo uma internação de emêrgencia.. */

		--if (ie_origem_lote_w <> 'X') then
			-- Número da guia inválido
		CALL pls_salvar_comunic_int_glosa(r_C01.nr_sequencia, '1307',nm_usuario_p);
		--end if;
	else
		select  count(1)
		into STRICT	qt_registros_w
		from    pls_conta x
		where   x.nr_seq_guia = r_C01.nr_seq_guia;

		if (qt_registros_w > 0) then
			ie_guia_apres_w := 'S';

			-- Se o lote veio via xml, o sistema verifica se existe uma guia de prorrogação para a guia de internação
			if (ie_origem_lote_w = 'X') then
				select	max(nr_sequencia)
				into STRICT	nr_seq_guia_w
				from	pls_guia_plano a
				where	nr_seq_guia_principal = r_C01.nr_seq_guia
				and	ie_tipo_guia = '8'
				and	ie_status  = '1'
				and	not exists (SELECT 1
					           from	  pls_conta x
						   where  x.nr_seq_guia = a.nr_sequencia);

				if (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') then
					ie_guia_apres_w := 'N';

					update	pls_comunicacao_internacao
					set	nr_seq_guia = nr_seq_guia_w
					where	nr_sequencia = r_C01.nr_sequencia;
				end if;
			end if;

			if (ie_guia_apres_w = 'S') then
				/* Guia já apresentada  */

				CALL pls_salvar_comunic_int_glosa(r_C01.nr_sequencia, '1308',nm_usuario_p);
			end if;

		end if;
	end if;

	select	count(1)
	into STRICT	qt_registros_w
	from	pls_comunic_int_glosa
	where	nr_seq_comunicado_int = r_C01.nr_sequencia;

	if (qt_registros_w > 0) then
		ie_status_w := 'CG';
		ie_status_lote_w := 'CG';
	end if;

	update	pls_comunicacao_internacao
	   set	ie_status = ie_status_w
	 where  nr_sequencia = r_C01.nr_sequencia;

end loop;




update	pls_lote_comunicacao_inter
   set	ie_status = ie_status_lote_w
 where  nr_sequencia = nr_seq_lote_p;

commit;

-- Caso esteja consistido sem glosa, e a origem seja texto, o sistema vai atualizar a guia
--Na OS 773076, - Foi liberado para atualizar tanto noTXT como no XML
-- OS 973038 - adicionado tratamento para o parametro Tipo processo (OPS - Gestão de Operadoras > Parametros da OPS > Comunicação de Internação/Alta XML)
-- que define se a comunicação vai ser vinculada com uma guia automaticamente ou manualmente.
if ( ie_status_w = 'CS' ) and ( ie_tipo_vinculo_w = '0' ) then
	CALL pls_atualizar_comunic_int_guia(nr_seq_lote_p, nm_usuario_p);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consist_comunic_int_glosa (nr_seq_lote_p bigint, nm_usuario_p text) FROM PUBLIC;

