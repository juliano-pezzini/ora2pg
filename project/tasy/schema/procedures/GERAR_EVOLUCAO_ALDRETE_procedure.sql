-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_evolucao_aldrete ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE
 			
 
ds_evolucao_w		varchar(32000);
ds_titulo_w		varchar(32000);
ds_compl_w		varchar(32000);
cd_medico_w		varchar(10);
nr_atendimento_w	bigint;
cd_pessoa_fisica_w	varchar(10);		
ie_inserir_w		boolean;	
dt_avaliacao_w		timestamp;
IE_TIPO_EVOLUCAO_ALDRETE_W varchar(100);
cd_estabelecimento_w	bigint;
IE_TIPO_EVOLUCAO_w	varchar(10);
cd_evolucao_w		bigint;
ds_atividade_w		varchar(255);
ds_respiracao_w		varchar(255);
ds_pressao_arterial_w	varchar(255);
ds_consciencia_w	varchar(255);
ds_coloracao_w		varchar(255);
nr_cirurgia_w		bigint;
ds_pontuacao_w		varchar(255);
nm_profissional_w	varchar(255);

expressao1_w	varchar(255) := obter_desc_expressao_idioma(670744, null, wheb_usuario_pck.get_nr_seq_idioma);--0 - Não move extremidades ao comando 
expressao2_w	varchar(255) := obter_desc_expressao_idioma(670737, null, wheb_usuario_pck.get_nr_seq_idioma);--1 - Move duas extremidades ao comando 
expressao3_w	varchar(255) := obter_desc_expressao_idioma(670733, null, wheb_usuario_pck.get_nr_seq_idioma);--2 - Move quatro extremidades voluntariamente ou ao comando 
expressao4_w	varchar(255) := obter_desc_expressao_idioma(670751, null, wheb_usuario_pck.get_nr_seq_idioma);--0 - Apnéia 
expressao5_w	varchar(255) := obter_desc_expressao_idioma(670749, null, wheb_usuario_pck.get_nr_seq_idioma);--1 - Dispnéia 
expressao6_w	varchar(255) := obter_desc_expressao_idioma(670745, null, wheb_usuario_pck.get_nr_seq_idioma);--2 - Respira profundamente e tosse livremente 
expressao7_w	varchar(255) := obter_desc_expressao_idioma(670754, null, wheb_usuario_pck.get_nr_seq_idioma);--0 - PA acima 50% > ou < níveis pré-anestésicos 
expressao8_w	varchar(255) := obter_desc_expressao_idioma(670753, null, wheb_usuario_pck.get_nr_seq_idioma);--1 - PA entre 20 - 49% > ou < níveis pré-anestésicos 
expressao9_w	varchar(255) := obter_desc_expressao_idioma(670752, null, wheb_usuario_pck.get_nr_seq_idioma);--2 - PA ATé 20% > ou < níveis pré-anestésicos 
expressao10_w	varchar(255) := obter_desc_expressao_idioma(670758, null, wheb_usuario_pck.get_nr_seq_idioma);--0 - Não responde 
expressao11_w	varchar(255) := obter_desc_expressao_idioma(670757, null, wheb_usuario_pck.get_nr_seq_idioma);--1 - Desperta ao chamado 
expressao12_w	varchar(255) := obter_desc_expressao_idioma(670755, null, wheb_usuario_pck.get_nr_seq_idioma);--2 - Completamente acordado 
expressao13_w	varchar(255) := obter_desc_expressao_idioma(670761, null, wheb_usuario_pck.get_nr_seq_idioma);--0 - Cianótico/ Sat O² < 90% com suplementação de oxigênio 
expressao14_w	varchar(255) := obter_desc_expressao_idioma(670760, null, wheb_usuario_pck.get_nr_seq_idioma);--1 - Pálido ou marmóreo/ necessita de O² para manter Sat O² > 90% 
expressao15_w	varchar(255) := obter_desc_expressao_idioma(670759, null, wheb_usuario_pck.get_nr_seq_idioma);--2 - Róseo/ Sat O² > 92% em ar ambiente 
expressao16_w	varchar(255) := obter_desc_expressao_idioma(774084, null, wheb_usuario_pck.get_nr_seq_idioma);--Evolução de alta da SRA - Transferência Interna 
expressao17_w	varchar(255) := obter_desc_expressao_idioma(283891, null, wheb_usuario_pck.get_nr_seq_idioma);--Atividade 
expressao18_w	varchar(255) := obter_desc_expressao_idioma(297717, null, wheb_usuario_pck.get_nr_seq_idioma);--Respiração 
expressao19_w	varchar(255) := obter_desc_expressao_idioma(296235, null, wheb_usuario_pck.get_nr_seq_idioma);--Pressão arterial sistêmica 
expressao20_w	varchar(255) := obter_desc_expressao_idioma(285710, null, wheb_usuario_pck.get_nr_seq_idioma);--Consciência 
expressao21_w	varchar(255) := obter_desc_expressao_idioma(285493, null, wheb_usuario_pck.get_nr_seq_idioma);--Coloração/oximetria 
expressao22_w	varchar(255) := obter_desc_expressao_idioma(296032, null, wheb_usuario_pck.get_nr_seq_idioma);--Pontos 
	

BEGIN 
 
SELECT	SUBSTR(obter_pessoa_atendimento(nr_atendimento,'C'),1,150), 
	nr_atendimento, 
	dt_avaliacao, 
	cd_profissional, 
	CASE WHEN ie_atividade=0 THEN expressao1_w WHEN ie_atividade=1 THEN expressao2_w WHEN ie_atividade=2 THEN expressao3_w END  ie_atividade, 
	CASE WHEN ie_respiracao=0 THEN expressao4_w WHEN ie_respiracao=1 THEN expressao5_w WHEN ie_respiracao=2 THEN expressao6_w END  ie_respiracao, 
	CASE WHEN ie_pressao_arterial=0 THEN expressao7_w WHEN ie_pressao_arterial=1 THEN expressao8_w WHEN ie_pressao_arterial=2 THEN expressao9_w END  ie_pressao_arterial, 
	CASE WHEN ie_consciencia=0 THEN expressao10_w WHEN ie_consciencia=1 THEN expressao11_w WHEN ie_consciencia=2 THEN expressao12_w END  ie_consciencia, 
	CASE WHEN ie_coloracao=0 THEN expressao13_w WHEN ie_coloracao=1 THEN expressao14_w WHEN ie_coloracao=2 THEN expressao15_w END  ie_coloracao, 
	nr_cirurgia, 
	qt_aldrete || ' - ' || substr(obter_desc_escala_chung(qt_aldrete),1,100), 
	substr(obter_nome_pf(cd_profissional),1,150) 
INTO STRICT	cd_pessoa_fisica_w, 
	nr_atendimento_w, 
	dt_avaliacao_w, 
	cd_medico_w, 
	ds_atividade_w, 
	ds_respiracao_w, 
	ds_pressao_arterial_w, 
	ds_consciencia_w, 
	ds_coloracao_w, 
	nr_cirurgia_w, 
	ds_pontuacao_w, 
	nm_profissional_w 
FROM	escala_aldrete 
WHERE	nr_sequencia	= nr_sequencia_p;
 
cd_estabelecimento_w	:= OBTER_ESTAB_ATEND(nr_atendimento_w);
 
select	max(IE_TIPO_EVOLUCAO_ALDRETE) 
into STRICT	IE_TIPO_EVOLUCAO_ALDRETE_w 
from	parametros_pepo 
where	cd_estabelecimento = cd_estabelecimento_w;
 
if (IE_TIPO_EVOLUCAO_ALDRETE_w IS NOT NULL AND IE_TIPO_EVOLUCAO_ALDRETE_w::text <> '') then 
 
	ds_evolucao_w	:= wheb_rtf_pck.GET_CABECALHO;
 
	ds_titulo_w	:= wheb_rtf_pck.get_quebra_linha||wheb_rtf_pck.get_negrito(true)||expressao16_w||wheb_rtf_pck.get_negrito(false);
		 
	if (ds_atividade_w IS NOT NULL AND ds_atividade_w::text <> '') then 
		ds_compl_w	:= ds_compl_w||wheb_rtf_pck.get_quebra_linha||wheb_rtf_pck.get_negrito(true)||expressao17_w || ': ' ||wheb_rtf_pck.get_negrito(false)||ds_atividade_w;
	end if;
 
	if (ds_respiracao_w IS NOT NULL AND ds_respiracao_w::text <> '') then 
		ds_compl_w	:= ds_compl_w||wheb_rtf_pck.get_quebra_linha||wheb_rtf_pck.get_negrito(true)|| expressao18_w || ': '||wheb_rtf_pck.get_negrito(false)||ds_respiracao_w;
	end if;
	 
	if (ds_pressao_arterial_w IS NOT NULL AND ds_pressao_arterial_w::text <> '') then 
		ds_compl_w	:= ds_compl_w||wheb_rtf_pck.get_quebra_linha||wheb_rtf_pck.get_negrito(true)|| expressao19_w || ': '||wheb_rtf_pck.get_negrito(false)||ds_pressao_arterial_w;
	end if;
	 
	if (ds_consciencia_w IS NOT NULL AND ds_consciencia_w::text <> '') then 
		ds_compl_w	:= ds_compl_w||wheb_rtf_pck.get_quebra_linha||wheb_rtf_pck.get_negrito(true)||expressao20_w || ': '||wheb_rtf_pck.get_negrito(false)||ds_consciencia_w;
	end if;
 
	if (ds_coloracao_w IS NOT NULL AND ds_coloracao_w::text <> '') then 
		ds_compl_w	:= ds_compl_w||wheb_rtf_pck.get_quebra_linha||wheb_rtf_pck.get_negrito(true)||expressao21_w || ': '||wheb_rtf_pck.get_negrito(false)||ds_coloracao_w;
	end if;	
	 
	if (ds_pontuacao_w IS NOT NULL AND ds_pontuacao_w::text <> '') then 
		ds_compl_w	:= ds_compl_w||wheb_rtf_pck.get_quebra_linha||wheb_rtf_pck.get_negrito(true)||expressao22_w || ': '||wheb_rtf_pck.get_negrito(false)||ds_pontuacao_w;
	end if;	
	 
	ds_evolucao_w	:= substr(ds_evolucao_w||ds_titulo_w||ds_compl_w,1,32000);
	ie_inserir_w	:= true;
 
	ds_evolucao_w	:= ds_evolucao_w||wheb_rtf_pck.get_rodape;
 
	if (ie_inserir_w) then 
	 
		select	max(IE_TIPO_EVOLUCAO) 
		into STRICT	IE_TIPO_EVOLUCAO_w 
		from	usuario 
		where	nm_usuario = nm_usuario_p;
		 
		select	nextval('evolucao_paciente_seq') 
		into STRICT	cd_evolucao_w 
		;
		 
		insert into evolucao_paciente(	cd_evolucao, 
						dt_evolucao, 
						ie_tipo_evolucao, 
						cd_pessoa_fisica, 
						dt_atualizacao, 
						nm_usuario, 
						nr_atendimento, 
						ds_evolucao,					 
						dt_liberacao, 
						ie_evolucao_clinica, 
						cd_medico, 
						nr_cirurgia) 
				values (	cd_evolucao_w, 
						clock_timestamp(), 
						coalesce(IE_TIPO_EVOLUCAO_w,1), 
						cd_pessoa_fisica_w, 
						clock_timestamp(), 
						nm_usuario_p, 
						nr_atendimento_w, 
						ds_evolucao_w,					 
						null, 
						IE_TIPO_EVOLUCAO_ALDRETE_w, 
						cd_medico_w, 
						nr_cirurgia_w);
		 
		--liberar_evolucao(cd_evolucao_w,nm_usuario_p); Não gerar liberado por causa da assinatura digital. 
		 
		commit;
	end if;
 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_evolucao_aldrete ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

