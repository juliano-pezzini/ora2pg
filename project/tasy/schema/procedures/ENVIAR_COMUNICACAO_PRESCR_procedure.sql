-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_comunicacao_prescr (nr_prescricao_p bigint, ds_usuario_p text, ds_perfil_p text, nm_usuario_p text, ds_mensagem_p text) AS $body$
DECLARE

 
dt_liberacao_w		timestamp;
nr_atendimento_w	bigint;
nm_paciente_w		varchar(60);
nm_medico_w			varchar(60);
nr_sequencia_w		bigint;


BEGIN 
 
select	min(nr_sequencia) 
into STRICT	nr_sequencia_w 
from	comunic_interna_classif 
where	ie_tipo	= 'F';
 
select	dt_liberacao, 
		nr_atendimento, 
		substr(obter_nome_pf(cd_pessoa_fisica),1,60), 
		substr(obter_nome_pf(cd_medico),1,60) 
into STRICT	dt_liberacao_w, 
		nr_atendimento_w, 
		nm_paciente_w, 
		nm_medico_w 
from	prescr_medica 
where	nr_prescricao	= nr_prescricao_p;
 
if (dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '') then 
	begin 
	insert	into comunic_interna(dt_comunicado, 
								 ds_titulo, 
								 ds_comunicado, 
								 nm_usuario, 
								 dt_atualizacao, 
								 ie_geral, 
								 nm_usuario_destino, 
								 ie_gerencial, 
								 ds_perfil_adicional, 
								 nr_sequencia, 
								 nr_seq_classif, 
								 dt_liberacao) 
	values (clock_timestamp(), 
		  obter_desc_expressao(296208)/*'Prescrição '*/
|| to_char(nr_prescricao_p) ||' necessita autorização.', 
		  'A prescrição foi liberada com itens glosados ou que necessitam de autorização '|| chr(13) || 
		  obter_desc_expressao(325814)/*'Prescrição: '*/
|| to_char(nr_prescricao_p)|| chr(13) || 
		  obter_desc_expressao(775048)/*'Atendimento: '*/
|| to_char(nr_atendimento_w)|| chr(13) || 
		  obter_desc_expressao(325811)/*'Paciente: '*/
|| nm_paciente_w || chr(13) || 
		  obter_desc_expressao(622367)/*'Médico: '*/
|| nm_medico_w || chr(13) || 
		  ds_mensagem_p, 
		  nm_usuario_p, 
		  clock_timestamp(), 
		  'N', 
		  ds_usuario_p, 
		  'N', 
		  ds_perfil_p, 
		  nextval('comunic_interna_seq'), 
		  nr_sequencia_w, 
		  clock_timestamp());
	end;
end if;
 
COMMIT;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_comunicacao_prescr (nr_prescricao_p bigint, ds_usuario_p text, ds_perfil_p text, nm_usuario_p text, ds_mensagem_p text) FROM PUBLIC;

