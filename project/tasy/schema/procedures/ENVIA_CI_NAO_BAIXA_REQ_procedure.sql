-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE envia_ci_nao_baixa_req ( nr_requisicao_p bigint, cd_material_p bigint, cd_motivo_baixa_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
nr_seq_classif_w				bigint;
cd_estabelecimento_w				smallint := cd_estabelecimento_p;
cd_setor_atendimento_w				integer := wheb_usuario_pck.get_cd_setor_atendimento;

/* C01 */
 
cd_material_w					integer;
ds_material_w					varchar(255);
ds_motivo_baixa_w				varchar(255);

/*C02*/
 
nr_seq_regra_w					bigint;
cd_perfil_regra_w				integer;
ds_titulo_w					varchar(80);
ds_comunicacao_w				varchar(2000);

/* Regra de envio de CI */
 
ds_lista_material_w				varchar(2000);
cd_perfil_destino_w				varchar(4000);
ds_setor_destino_w				varchar(4000);
nm_usuario_destino_w				varchar(4000);

c01 CURSOR FOR 
SELECT	cd_material, 
	substr(obter_desc_material(cd_material),1,255), 
	substr(obter_desc_motivo_baixa_req(cd_motivo_baixa),1,255) ds_motivo_baixa 
from	item_requisicao_material 
where	nr_requisicao = nr_requisicao_p 
and	obter_tipo_motivo_baixa_req(cd_motivo_baixa) <> 1 
and	coalesce(obter_tipo_motivo_baixa_req(cd_motivo_baixa),0) <> 0;

C02 CURSOR FOR 
SELECT	b.nr_sequencia, 
	b.cd_perfil, 
	b.ds_titulo, 
	b.ds_comunicacao 
from	regra_envio_comunic_compra a, 
	regra_envio_comunic_evento b 
where	a.nr_sequencia = b.nr_seq_regra 
and	a.cd_funcao = 109 
and	b.cd_evento = 65 
and	b.ie_situacao = 'A' 
and	a.cd_estabelecimento = cd_estabelecimento_p 
and	((coalesce(b.cd_setor_destino::text, '') = '') or (coalesce(b.cd_setor_destino, cd_setor_atendimento_w) = cd_setor_atendimento_w)) 
and	substr(obter_se_envia_ci_regra_compra(b.nr_sequencia,null,null,obter_perfil_ativo,nm_usuario_p,null),1,1) = 'S'; -- Filtros da regra 
BEGIN 
 
if (obter_tipo_motivo_baixa_req(cd_motivo_baixa_p) <> 1) then 
	begin 
 
	open C02;
	loop 
	fetch C02 into 
		nr_seq_regra_w, 
		cd_perfil_regra_w, 
		ds_titulo_w, 
		ds_comunicacao_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
 
		select	substr(obter_desc_motivo_baixa_req(cd_motivo_baixa_p),1,80) 
		into STRICT	ds_motivo_baixa_w 
		;
 
		nm_usuario_destino_w	:= '';
		nm_usuario_destino_w	:= obter_usuarios_comunic_compras(nr_requisicao_p,null,65,nr_seq_regra_w,'');
		cd_perfil_destino_w	:= obter_perfil_envio_comunic_usu(nr_seq_regra_w);
		ds_setor_destino_w	:= obter_setor_envio_comunic_usu(nr_seq_regra_w);
 
		if (cd_material_p <> 0) then 
			ds_lista_material_w := substr(ds_lista_material_w || cd_material_p || ' - ' || obter_desc_material(cd_material_p),1,2000);
		else 
			open C01;
			loop 
			fetch C01 into 
				cd_material_w, 
				ds_material_w, 
				ds_motivo_baixa_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				begin 
				ds_lista_material_w := substr(ds_lista_material_w || cd_material_w || ' - ' 
										 || ds_material_w || chr(13) || chr(10),1,2000);
				end;
			end loop;
			close C01;
		end if;
 
		ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@nr_requisicao_w', nr_requisicao_p), 1, 2000);
		ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_motivo_baixa_w', ds_motivo_baixa_w), 1, 2000);
		ds_comunicacao_w := substr(replace_macro(ds_comunicacao_w, '@ds_lista_material_w', ds_lista_material_w), 1, 2000);
 
		if (nm_usuario_destino_w IS NOT NULL AND nm_usuario_destino_w::text <> '') or (cd_perfil_destino_w IS NOT NULL AND cd_perfil_destino_w::text <> '') then 
		 
			select	max(obter_classif_comunic('F')) 
			into STRICT	nr_seq_classif_w 
			;
 
			CALL Gerar_Comunic_Padrao( 
				clock_timestamp(), 
				ds_titulo_w, 
				ds_comunicacao_w, 
				nm_usuario_p, 
				'N', 
				nm_usuario_destino_w, 
				'N', 
				nr_seq_classif_w, 
				cd_perfil_destino_w, 
				'', 
				ds_setor_destino_w, 
				clock_timestamp(), 
				'', 
				'');
		end if;	-- envia comunicados para os usu√°rios 
		end;
	end loop;
	close C02;
 
	end;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE envia_ci_nao_baixa_req ( nr_requisicao_p bigint, cd_material_p bigint, cd_motivo_baixa_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

