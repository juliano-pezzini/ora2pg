-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ppm_metrica_satif_os ( nr_seq_metrica_p bigint, nr_seq_objetivo_metrica_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, dt_referencia_p timestamp) AS $body$
DECLARE


/*Procedure criada com base na rotina PPM_SATISFACAO_ACUMULADA, utilizada no relatório CSIS 822 - PPM - Indicadores de ReD*/

resultado_w		double precision;
qt_satisfacao_w		bigint;
qt_insatisfacao_w	bigint;
dt_ref_inicio_w		timestamp;
dt_ref_fim_w		timestamp;
dt_referencia_w		timestamp;
nr_seq_diretoria_w	ppm_objetivo.nr_seq_diretoria%type;
nr_seq_gerencia_w	ppm_objetivo.nr_seq_gerencia%type;
nr_seq_grupo_w		ppm_objetivo.nr_seq_grupo%type;


BEGIN

dt_ref_inicio_w := pkg_date_utils.start_of(dt_referencia_p,'MONTH');
dt_ref_fim_w 	:= pkg_date_utils.end_of(last_day(dt_referencia_p),'DAY');
dt_referencia_w	:= trunc(dt_referencia_p);

select	max(nr_seq_gerencia),
	max(nr_seq_grupo),
	max(nr_seq_diretoria)
into STRICT	nr_seq_gerencia_w,
	nr_seq_grupo_w,
	nr_seq_diretoria_w
from	ppm_objetivo_metrica a,
	ppm_objetivo_meta b,
	ppm_objetivo c
where	a.nr_sequencia		= nr_seq_objetivo_metrica_p
and	a.nr_seq_meta		= b.nr_sequencia
and	b.nr_seq_objetivo	= c.nr_sequencia;

if (nr_seq_grupo_w IS NOT NULL AND nr_seq_grupo_w::text <> '') then

	--Quantidade de OS com satisfação informada
	select	max(coalesce(QT_OS_SATISF_INF,0))
	into STRICT	qt_satisfacao_w
	from	w_indicador_desenv_apres
	where	dt_referencia 	= dt_referencia_w
	and	nr_seq_grupo	= nr_seq_grupo_w
	and	ie_abrangencia 	= 'GRU';

	--Quantidade de OS com insatisfação
	select	max(coalesce(QT_OS_INSATISFACAO,0))
	into STRICT	qt_insatisfacao_w
	from	w_indicador_desenv_apres
	where	dt_referencia 	= dt_referencia_w
	and	nr_seq_grupo	= nr_seq_grupo_w
	and	ie_abrangencia 	= 'GRU';

elsif (nr_seq_gerencia_w IS NOT NULL AND nr_seq_gerencia_w::text <> '') then

	--Quantidade de OS com satisfação informada
	select	max(coalesce(QT_OS_SATISF_INF,0))
	into STRICT	qt_satisfacao_w
	from	w_indicador_desenv_apres
	where	dt_referencia 	= dt_referencia_w
	and	nr_seq_gerencia	= nr_seq_gerencia_w
	and	ie_abrangencia 	= 'GER';

	--Quantidade de OS com insatisfação
	select	max(coalesce(QT_OS_INSATISFACAO,0))
	into STRICT	qt_insatisfacao_w
	from	w_indicador_desenv_apres
	where	dt_referencia 	= dt_referencia_w
	and	nr_seq_gerencia	= nr_seq_gerencia_w
	and	ie_abrangencia 	= 'GER';

elsif (nr_seq_diretoria_w IS NOT NULL AND nr_seq_diretoria_w::text <> '') then

	--Quantidade de OS com satisfação informada
	select	max(coalesce(QT_OS_SATISF_INF,0))
	into STRICT	qt_satisfacao_w
	from	w_indicador_desenv_apres
	where	dt_referencia 		= dt_referencia_w
	and	nr_seq_diretoria	= nr_seq_diretoria_w
	and	ie_abrangencia 		= 'DIRE';

	--Quantidade de OS com insatisfação
	select	max(coalesce(QT_OS_INSATISFACAO,0))
	into STRICT	qt_insatisfacao_w
	from	w_indicador_desenv_apres
	where	dt_referencia 		= dt_referencia_w
	and	nr_seq_diretoria	= nr_seq_diretoria_w
	and	ie_abrangencia 		= 'DIRE';

else
	--Quantidade de OS com satisfação informada por usuário
	select	sum(qt_informacao)
	into STRICT	qt_satisfacao_w
	from	w_indicador_desenv
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p
	and	dt_referencia		= dt_referencia_w
	and	ie_indicador		= 'SAT'
	and	ie_abrangencia		= 'IND'
	and	ie_informacao		= 'QTSAI';

	--Quantidade de OS com insatisfação por usuário
	select	sum(qt_informacao)
	into STRICT	qt_insatisfacao_w
	from	w_indicador_desenv
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p
	and	dt_referencia		= dt_referencia_w
	and	ie_indicador		= 'SAT'
	and	ie_abrangencia		= 'IND'
	and	ie_informacao		= 'QTINS';

end if;

if (qt_satisfacao_w > 0) and (qt_insatisfacao_w > 0) then

	resultado_w := 100 - (dividir(qt_insatisfacao_w, qt_satisfacao_w) * 100);
else
	resultado_w := 100;
end if;

CALL PPM_GRAVAR_RESULTADO(nr_seq_objetivo_metrica_p, dt_referencia_p, resultado_w, qt_satisfacao_w, (qt_satisfacao_w - qt_insatisfacao_w), nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ppm_metrica_satif_os ( nr_seq_metrica_p bigint, nr_seq_objetivo_metrica_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, dt_referencia_p timestamp) FROM PUBLIC;

