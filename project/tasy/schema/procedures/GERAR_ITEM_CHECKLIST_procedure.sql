-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_item_checklist ( nm_usuario_p text, nr_seq_atend_checklist_p bigint, nr_seq_item_p bigint, cd_profissional_p text, nr_seq_med_aval_old_p bigint) AS $body$
DECLARE


nr_seq_checklist_w   		bigint;
nr_atendimento_w   			bigint;
cd_pessoa_fisica_w   		varchar(10);
nr_cirurgia_w				bigint;
nr_seq_pepo_w				bigint;
nr_seq_avaliacao_w   		bigint;
nr_sequencia_avaliacao_w 	bigint;
nr_seq_tipo_aval_copia_w	bigint;

C01 CURSOR FOR
	SELECT	nr_seq_item,
			clock_timestamp(),
			nm_usuario_p,
			qt_resultado,
			ds_resultado,
			ds_result_long,
			ds_auxiliar
	from	med_avaliacao_result
	where	nr_seq_avaliacao = nr_seq_med_aval_old_p;

BEGIN

select  max(nr_seq_checklist),
		max(nr_atendimento),
		max(cd_pessoa_fisica),
		max(nr_cirurgia),
		max(nr_seq_pepo)
into STRICT 	nr_seq_checklist_w,
		nr_atendimento_w,
		cd_pessoa_fisica_w,
		nr_cirurgia_w,
		nr_seq_pepo_w
from 	atendimento_checklist
where 	nr_sequencia = nr_seq_atend_checklist_p;

select	max(nr_seq_avaliacao)
into STRICT	nr_seq_avaliacao_w
from	checklist_processo_item
where	nr_sequencia = nr_seq_item_p;

select  nextval('med_avaliacao_paciente_seq')
into STRICT 	nr_sequencia_avaliacao_w
;

select  max(nr_seq_tipo_avaliacao)
into STRICT 	nr_seq_tipo_aval_copia_w
from  	med_avaliacao_paciente
where	nr_sequencia = nr_seq_med_aval_old_p;

insert into 	med_avaliacao_paciente(nr_sequencia,
					cd_pessoa_fisica,
					cd_medico,
					dt_avaliacao,
					dt_atualizacao,
					nm_usuario,
					nm_usuario_nrec,
					ie_situacao,
					cd_estabelecimento,
					nr_seq_atend_checklist,
					nr_seq_checklist_item,
					nr_seq_tipo_avaliacao,
					nr_atendimento,
					dt_atualizacao_nrec,
					ie_atualiza_macro,
					nr_cirurgia,
					nr_seq_pepo)
values (		nr_sequencia_avaliacao_w,
					cd_pessoa_fisica_w,
					cd_profissional_p,
					clock_timestamp(),
					clock_timestamp(),
					nm_usuario_p,
					nm_usuario_p,
					'A',
					wheb_usuario_pck.get_cd_estabelecimento,
					nr_seq_atend_checklist_p,
					nr_seq_item_p,
					CASE WHEN nr_seq_med_aval_old_p=0 THEN nr_seq_avaliacao_w  ELSE nr_seq_tipo_aval_copia_w END ,
					nr_atendimento_w,
					clock_timestamp(),
					'S',
					nr_cirurgia_w,
					nr_seq_pepo_w);

if (nr_seq_med_aval_old_p > 0) then
	for C01_w in C01 loop
		insert into med_avaliacao_result(
			nr_seq_avaliacao,
			nr_seq_item,
			dt_atualizacao,
			nm_usuario,
			qt_resultado,
			ds_resultado,
			ds_result_long,
			ds_auxiliar)
		values (	nr_sequencia_avaliacao_w,
			C01_w.nr_seq_item,
			clock_timestamp(),
			nm_usuario_p,
			C01_w.qt_resultado,
			C01_w.ds_resultado,
			C01_w.ds_result_long,
			C01_w.ds_auxiliar);
	end loop;
end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_item_checklist ( nm_usuario_p text, nr_seq_atend_checklist_p bigint, nr_seq_item_p bigint, cd_profissional_p text, nr_seq_med_aval_old_p bigint) FROM PUBLIC;

