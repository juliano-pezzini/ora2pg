-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_conpaci_desc_item_pac (nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_interno_conta_w	bigint;
pr_desconto_w		real;
vl_desconto_w		double precision;
vl_liquido_w		double precision;

cd_estrutura_w		integer;
vl_estrutura_w		double precision;
vl_liq_estrut_w		double precision;
cd_setor_atendimento_w	bigint;

nr_sequencia_w		bigint;
vl_total_estrut_w		double precision;
vl_total_desc_w		double precision;
vl_desc_estrut_w		double precision;

ie_tipo_desconto_w	integer;
ie_ok_w			integer;

cd_item_w		bigint;
ie_origem_proced_w	bigint;

nr_seq_proc_pacote_w	bigint;
dt_item_w		timestamp;

C01 CURSOR FOR 
	SELECT	nr_seq_proc_pacote, 
		ie_emite_conta, 
		max(dt_item), 
		sum(vl_item) 
	from conta_paciente_v 
	where nr_interno_conta = nr_interno_conta_w 
	 and coalesce(cd_motivo_exc_conta::text, '') = '' 
	 and coalesce(nr_seq_proc_pacote, 0) = nr_sequencia 
	 and (ie_emite_conta IS NOT NULL AND ie_emite_conta::text <> '') 
	group by nr_seq_proc_pacote, 		 
		 ie_emite_conta 
	having sum(vl_item) <> 0;


BEGIN 
 
select	nr_interno_conta, 
	pr_desconto, 
	vl_desconto, 
	vl_liquido, 
	ie_tipo_desconto 
into STRICT	nr_interno_conta_w, 
	pr_desconto_w, 
	vl_desconto_w, 
	vl_liquido_w, 
	ie_tipo_desconto_w 
from 	conta_paciente_desconto 
where 	nr_sequencia = nr_sequencia_p;
 
select 	count(*) 
into STRICT 	ie_ok_w 
from 	conta_paciente_v 
where 	nr_interno_conta = nr_interno_conta_w 
and	coalesce(cd_motivo_exc_conta::text, '') = '' 
and 	somente_numero(coalesce(ie_emite_conta_honor, ie_emite_conta)) = 0;
 
if (ie_ok_w > 0) then 
	--r.aise_application_error(-20011,'Existem itens sem estrutura. Geração cancelada !'); 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(263336);
end if;
 
vl_total_estrut_w := 0;
vl_total_desc_w	:= 0;
 
open C01;
loop 
	fetch C01 into	nr_seq_proc_pacote_w, 
			cd_estrutura_w, 
			dt_item_w, 
			vl_estrutura_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
 
	select nextval('conta_paciente_desc_item_seq') 
	into STRICT nr_sequencia_w 
	;
	 
	vl_desc_estrut_w := (vl_estrutura_w / 100) * pr_desconto_w;
	vl_liq_estrut_w  := vl_estrutura_w - vl_desc_estrut_w;
 
	vl_total_estrut_w := vl_total_estrut_w + vl_liq_estrut_w;
	vl_total_desc_w  := vl_total_desc_w + vl_desc_estrut_w;
 
	insert into conta_paciente_desc_item(nr_sequencia, 
		nr_seq_desconto, 
		cd_estrutura, 
		dt_atualizacao, 
		nm_usuario, 
		vl_conta, 
		ie_calcula, 
		pr_desconto, 
		vl_desconto, 
		vl_liquido, 
		cd_setor_atendimento, 
		cd_medico, 
		ie_desc_material, 
		nr_seq_proc_pacote, 
		dt_item) 
	values (nr_sequencia_w, 
		nr_sequencia_p, 
		cd_estrutura_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		vl_estrutura_w, 
		'S', 
		pr_desconto_w, 
		vl_desc_estrut_w, 
		vl_liq_estrut_w, 
		CASE WHEN cd_setor_atendimento_w=0 THEN  null  ELSE cd_setor_atendimento_w END , null, 'S', 
		nr_seq_proc_pacote_w, 
		dt_item_w);
end loop;
close C01;
 
if (vl_total_estrut_w <> vl_liquido_w) or (vl_total_desc_w <> vl_desconto_w) then 
	vl_desc_estrut_w := vl_desc_estrut_w + (vl_desconto_w - vl_total_desc_w);
	vl_liq_estrut_w := vl_liq_estrut_w + (vl_liquido_w - vl_total_estrut_w);
 
	update conta_paciente_desc_item 
	set	vl_liquido = vl_liq_estrut_w, 
		vl_desconto = vl_desc_estrut_w 
	where nr_sequencia = nr_sequencia_w;
end if;
 
commit;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_conpaci_desc_item_pac (nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

