-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_atlz_proj_migr_cron ( nr_seq_projeto_p bigint, nr_seq_os_p text, dt_os_p timestamp, ds_documentacao_p text, ie_tipo_atualizacao_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_cronograma_w	bigint;
ie_tipo_atual_cron_w	varchar(15);
ds_tipo_atual_cron_w	varchar(50);
nr_seq_fase_w		bigint;


BEGIN
if (nr_seq_projeto_p IS NOT NULL AND nr_seq_projeto_p::text <> '') and (nr_seq_os_p IS NOT NULL AND nr_seq_os_p::text <> '') and (ie_tipo_atualizacao_p IS NOT NULL AND ie_tipo_atualizacao_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin
	nr_seq_cronograma_w := proj_desenv_obter_cron_ativ_os(nr_seq_projeto_p);

	if (coalesce(nr_seq_cronograma_w,0) > 0) then
		begin
		if (ie_tipo_atualizacao_p = 'T') then
			begin
			ie_tipo_atual_cron_w := 'ATL_TEC';
			ds_tipo_atual_cron_w := 'Atualizações Tecnologia';
			end;
		else
			begin
			ie_tipo_atual_cron_w := 'ATL_DES';
			ds_tipo_atual_cron_w := 'Atualizações Desenvolvimento';
			end;
		end if;

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_fase_w
		from	proj_cron_etapa
		where	nr_seq_cronograma = nr_seq_cronograma_w
		and	ie_fase = 'S'
		and	ie_tipo_obj_proj_migr = ie_tipo_atual_cron_w;

		if (nr_seq_fase_w > 0) then
			begin
			CALL adic_ativ_atlz_cron_proj_migr(ie_tipo_atual_cron_w, nr_seq_os_p, dt_os_p, ds_documentacao_p, 0, nr_seq_fase_w, nm_usuario_p);
			end;
		else
			begin
			CALL adic_fase_extra_cron_proj_migr(nr_seq_cronograma_w, 'ATL', 'Atualizações do Projeto', nm_usuario_p);

			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_seq_fase_w
			from	proj_cron_etapa
			where	nr_seq_cronograma = nr_seq_cronograma_w
			and	ie_tipo_obj_proj_migr = 'ATL';

			CALL adic_sub_fase_cron_proj_migr(nr_seq_cronograma_w, nr_seq_fase_w, 'ATL_TEC', 'Atualizações Tecnologia', nm_usuario_p);
			CALL adic_sub_fase_cron_proj_migr(nr_seq_cronograma_w, nr_seq_fase_w, 'ATL_DES', 'Atualizações Desenvolvimento', nm_usuario_p);

			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_seq_fase_w
			from	proj_cron_etapa
			where	nr_seq_cronograma = nr_seq_cronograma_w
			and	ie_tipo_obj_proj_migr = ie_tipo_atual_cron_w
			and	ie_fase = 'S';

			CALL adic_ativ_atlz_cron_proj_migr(ie_tipo_atual_cron_w, nr_seq_os_p, dt_os_p, ds_documentacao_p, 0, nr_seq_fase_w, nm_usuario_p);
			end;
		end if;
		end;
	end if;
	end;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_atlz_proj_migr_cron ( nr_seq_projeto_p bigint, nr_seq_os_p text, dt_os_p timestamp, ds_documentacao_p text, ie_tipo_atualizacao_p text, nm_usuario_p text) FROM PUBLIC;

