-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_triagem_incompleta ( nr_atendimento_p bigint, ie_classif_manchester_p text, dt_inicio_triagem_p timestamp, nm_usuario_p text, ds_queixa_princ_p text, ds_observacao_p text, ie_retriagem_p text, nr_seq_manchester_fluxo_p bigint, nr_seq_discriminador_p bigint, ie_nao_p text, nr_seq_fluxo_original_p bigint, ds_detalhe_p text ) AS $body$
DECLARE


nr_seq_classif_w		atendimento_paciente.nr_seq_triagem%type;
ie_clinica_w			atendimento_paciente.ie_clinica%type;
nr_sequencia_w			triagem_pronto_atend.nr_sequencia%type;
cd_setor_atendimento_w	atend_paciente_unidade.cd_setor_atendimento%type;


BEGIN
	
	if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '' AND ie_classif_manchester_p IS NOT NULL AND ie_classif_manchester_p::text <> '') then
	
		select	max(nr_sequencia)
		into STRICT	nr_seq_classif_w
		from	triagem_classif_risco
		where	ie_classif_manchester = ie_classif_manchester_p
		and		coalesce(ie_situacao,'A') = 'A';
	
		update	atendimento_paciente
		set		dt_inicio_atendimento = coalesce(dt_inicio_atendimento, dt_inicio_triagem_p),
				nr_seq_triagem = nr_seq_classif_w
		where	nr_atendimento = nr_atendimento_p;
	
		select	max(ie_clinica)
		into STRICT	ie_clinica_w
		from	atendimento_paciente  
		where	nr_atendimento = nr_atendimento_p
		and     not exists (SELECT 	1
							from   	triagem_pronto_atend b
							where 	 b.nr_atendimento = nr_atendimento_p);

		select 	max(cd_setor_atendimento)
		into STRICT   	cd_setor_atendimento_w
		from   	atend_paciente_unidade
		where 	nr_atendimento = nr_atendimento_p
		and   	not exists (SELECT 	1
							from   	triagem_pronto_atend b
							where 	 b.nr_atendimento = nr_atendimento_p);
							
		select nextval('triagem_pronto_atend_seq')
		into STRICT   nr_sequencia_w
		;

		insert into triagem_pronto_atend(
			nr_sequencia,
			nm_usuario,
			nm_usuario_nrec,
			nm_usuario_triagem,
			nr_atendimento,
			cd_pessoa_fisica,
			dt_inicio_triagem,
			dt_fim_triagem,
			ds_queixa_princ,
			ds_observacao,
			nr_seq_classif,
			dt_atualizacao,
			cd_estabelecimento,
			ie_retriagem,
			nr_seq_manchester_fluxo,
			cd_classificador,
			dt_atualizacao_nrec,
			nr_seq_discriminador,
			ie_nao,
			nr_seq_fluxo_original,
			ie_status_paciente,
			ds_resumo_manchester,
			ie_clinica,
			cd_setor_atendimento,
			dt_triagem_incompleta
		) values (
			nr_sequencia_w,
			nm_usuario_p,
			nm_usuario_p,
			nm_usuario_p,
			nr_atendimento_p,
			obter_pessoa_atendimento(nr_atendimento_p,'C'),
			dt_inicio_triagem_p,
			null,
			ds_queixa_princ_p,
			ds_observacao_p,
			nr_seq_classif_w,
			clock_timestamp(),
			wheb_usuario_pck.get_cd_estabelecimento,
			ie_retriagem_p,
			nr_seq_manchester_fluxo_p,
			obter_dados_usuario_opcao(nm_usuario_p,'C'),
			clock_timestamp(),
			nr_seq_discriminador_p,
			ie_nao_p,
			nr_seq_fluxo_original_p,
			'T',
			ds_detalhe_p,
			ie_clinica_w,
			cd_setor_atendimento_w,
			clock_timestamp()
		);
		commit;
		
	end if;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_triagem_incompleta ( nr_atendimento_p bigint, ie_classif_manchester_p text, dt_inicio_triagem_p timestamp, nm_usuario_p text, ds_queixa_princ_p text, ds_observacao_p text, ie_retriagem_p text, nr_seq_manchester_fluxo_p bigint, nr_seq_discriminador_p bigint, ie_nao_p text, nr_seq_fluxo_original_p bigint, ds_detalhe_p text ) FROM PUBLIC;

