-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desdobrar_oc_por_data_entrega ( nr_ordem_compra_p bigint, nm_usuario_p text, ds_lista_ordem_p INOUT text) AS $body$
DECLARE

 
	 
 
 
nr_item_oci_w				bigint;
nr_item_oci_ww				bigint;
cd_material_w				bigint;
dt_prevista_entrega_w			timestamp;
dt_prevista_entrega_ww			timestamp;
dt_primeira_entrega_w			timestamp;
qt_prevista_entrega_w			double precision;
qt_prevista_entrega_ww			double precision;
nr_nova_ordem_compra_w			bigint;
ds_lista_ordem_w				varchar(4000);
ie_desdobrou_w				varchar(1) := 'N';
	
c01 CURSOR FOR 
SELECT	b.nr_item_oci, 
	b.cd_material, 
	trunc(c.dt_prevista_entrega,'dd') dt_prevista_entrega, 
	c.qt_prevista_entrega 
from	ordem_compra_item b, 
	ordem_compra_item_entrega c 
where	b.nr_ordem_compra = c.nr_ordem_compra 
and	b.nr_item_oci = c.nr_item_oci 
and	coalesce(c.dt_cancelamento::text, '') = '' 
and	b.nr_ordem_compra = nr_ordem_compra_p 
order by dt_prevista_entrega, 
	nr_item_oci;						
						 

BEGIN 
select	trunc(min(c.dt_prevista_entrega),'dd') dt_prevista_entrega 
into STRICT	dt_primeira_entrega_w 
from	ordem_compra_item b, 
	ordem_compra_item_entrega c 
where	b.nr_ordem_compra = c.nr_ordem_compra 
and	b.nr_item_oci = c.nr_item_oci 
and	coalesce(c.dt_cancelamento::text, '') = '' 
and	b.nr_ordem_compra = nr_ordem_compra_p;				
 
open C01;
loop 
fetch C01 into	 
	nr_item_oci_w, 
	cd_material_w, 
	dt_prevista_entrega_w, 
	qt_prevista_entrega_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	if (dt_prevista_entrega_w = dt_primeira_entrega_w) then 
		 
		update	ordem_compra 
		set	dt_entrega = dt_primeira_entrega_w 
		where	nr_ordem_compra = nr_ordem_compra_p;
		 
		select	sum(c.qt_prevista_entrega) 
		into STRICT	qt_prevista_entrega_ww 
		from	ordem_compra_item b, 
			ordem_compra_item_entrega c 
		where	b.nr_ordem_compra = c.nr_ordem_compra 
		and	b.nr_item_oci = c.nr_item_oci 
		and	b.nr_ordem_compra = nr_ordem_compra_p 
		and	b.nr_item_oci = nr_item_oci_w;
		 
		update	ordem_compra_item 
		set	qt_material = qt_prevista_entrega_ww, 
			vl_total_item = round(( qt_prevista_entrega_ww * vl_unitario_material)::numeric,4) 
		where	nr_ordem_compra = nr_ordem_compra_p 
		and	nr_item_oci = nr_item_oci_w;		
 
	else 
		if (dt_prevista_entrega_ww = dt_prevista_entrega_w) and (nr_nova_ordem_compra_w > 0) then 
			 
			select	coalesce(max(nr_item_oci),0) +1 
			into STRICT	nr_item_oci_ww 
			from	ordem_compra_item 
			where	nr_ordem_compra = nr_nova_ordem_compra_w;
			 
			insert into ordem_compra_item( 
				nr_ordem_compra, 
				nr_item_oci, 
				cd_material, 
				cd_unidade_medida_compra, 
				vl_unitario_material, 
				qt_material, 
				dt_atualizacao, 
				nm_usuario, 
				ie_situacao, 
				cd_pessoa_solicitante, 
				qt_material_entregue, 
				pr_descontos, 
				cd_local_estoque, 
				ds_material_direto, 
				ds_observacao, 
				cd_motivo_alteracao, 
				nr_cot_compra, 
				nr_item_cot_compra, 
				ds_marca, 
				vl_item_liquido, 
				cd_centro_custo, 
				cd_conta_contabil, 
				nr_solic_compra, 
				nr_item_solic_compra, 
				qt_conv_unid_fornec, 
				ie_geracao_solic, 
				nr_seq_proj_rec, 
				pr_desc_financ, 
				nr_seq_lic_item, 
				nr_seq_conta_financ, 
				qt_original, 
				dt_validade, 
				nr_seq_marca, 
				nr_seq_ordem_serv, 
				vl_ultima_compra, 
				vl_dif_ultima_compra, 
				pr_dif_ultima_compra, 
				nr_seq_unidade_adic, 
				vl_desconto, 
				nr_atendimento, 
				vl_total_item) 
			SELECT	nr_nova_ordem_compra_w, 
				nr_item_oci_ww, 
				cd_material, 
				cd_unidade_medida_compra, 
				vl_unitario_material, 
				qt_prevista_entrega_w, 
				clock_timestamp(), 
				nm_usuario_p, 
				ie_situacao, 
				cd_pessoa_solicitante, 
				qt_material_entregue, 
				pr_descontos, 
				cd_local_estoque, 
				ds_material_direto, 
				ds_observacao, 
				cd_motivo_alteracao, 
				nr_cot_compra, 
				nr_item_cot_compra, 
				ds_marca, 
				0, 
				cd_centro_custo, 
				cd_conta_contabil, 
				nr_solic_compra, 
				nr_item_solic_compra, 
				qt_conv_unid_fornec, 
				ie_geracao_solic, 
				nr_seq_proj_rec, 
				pr_desc_financ, 
				nr_seq_lic_item, 
				nr_seq_conta_financ, 
				qt_prevista_entrega_w, 
				dt_validade, 
				nr_seq_marca, 
				nr_seq_ordem_serv, 
				vl_ultima_compra, 
				vl_dif_ultima_compra, 
				pr_dif_ultima_compra, 
				nr_seq_unidade_adic, 
				coalesce(vl_desconto,0), 
				nr_atendimento, 
				round((qt_prevista_entrega_w * vl_unitario_material)::numeric,4) 
			from	ordem_compra_item 
			where	nr_ordem_compra = nr_ordem_compra_p 
			and	nr_item_oci = nr_item_oci_w;
 
			insert	into ordem_compra_item_entrega( 
				nr_ordem_compra, 
				nr_item_oci, 
				dt_prevista_entrega, 
				dt_real_entrega, 
				dt_entrega_original, 
				dt_entrega_limite, 
				qt_prevista_entrega, 
				qt_real_entrega, 
				dt_atualizacao, 
				nm_usuario, 
				ds_observacao, 
				dt_cancelamento, 
				nr_sequencia) 
			SELECT	nr_nova_ordem_compra_w, 
				nr_item_oci_ww, 
				dt_prevista_entrega_w, 
				null, 
				dt_prevista_entrega_w, 
				dt_prevista_entrega_w, 
				qt_prevista_entrega_w, 
				null, 
				clock_timestamp(), 
				nm_usuario_p, 
				ds_observacao, 
				null, 
				nextval('ordem_compra_item_entrega_seq') 
			from	ordem_compra_item_entrega 
			where	nr_ordem_compra = nr_ordem_compra_p 
			and	nr_item_oci = nr_item_oci_w 
			and	dt_prevista_entrega = dt_prevista_entrega_w;
			 
			delete	from ordem_compra_item_entrega 
			where	nr_ordem_compra = nr_ordem_compra_p 
			and	nr_item_oci = nr_item_oci_w 
			and	dt_prevista_entrega = dt_prevista_entrega_w;
			 
			delete from ordem_compra_item a 
			where	nr_ordem_compra = nr_ordem_compra_p 
			and	nr_item_oci = nr_item_oci_w 
			and not exists (	SELECT	1 
					from	ordem_compra_item_entrega x 
					where	x.nr_ordem_compra = a.nr_ordem_compra 
					and	x.nr_item_oci = a.nr_item_oci);		
			 
			ie_desdobrou_w := 'S';
		else 
			select	nextval('ordem_compra_seq') 
			into STRICT	nr_nova_ordem_compra_w 
			;
			 
			insert into ordem_compra( 
				nr_ordem_compra, 
				cd_estabelecimento, 
				cd_cgc_fornecedor, 
				cd_condicao_pagamento, 
				cd_comprador, 
				dt_ordem_compra, 
				dt_atualizacao, 
				nm_usuario, 
				cd_moeda, 
				ie_situacao, 
				dt_inclusao, 
				cd_pessoa_solicitante, 
				cd_cgc_transportador, 
				ie_frete, 
				vl_frete, 
				pr_multa_atraso, 
				pr_desconto, 
				pr_desc_pgto_antec, 
				pr_juros_negociado, 
				dt_emissao, 
				ds_pessoa_contato, 
				ds_observacao, 
				cd_motivo_alteracao, 
				cd_local_entrega, 
				dt_entrega, 
				nr_prescricao, 
				ie_aviso_chegada, 
				nr_requisicao, 
				cd_pessoa_fisica, 
				nr_ordem_agrup, 
				ie_emite_obs, 
				ie_urgente, 
				nr_seq_interno, 
				nr_atendimento, 
				nm_usuario_imp, 
				ie_somente_pagto, 
				nr_seq_motivo_cancel, 
				vl_despesa_acessoria, 
				cd_setor_atendimento, 
				nr_seq_subgrupo_compra, 
				pr_desc_financeiro, 
				dt_leitura, 
				dt_aceite, 
				nm_usuario_aceite, 
				nr_seq_forma_pagto, 
				vl_desconto, 
				ie_tipo_ordem) 
			SELECT	nr_nova_ordem_compra_w, 
				cd_estabelecimento, 
				cd_cgc_fornecedor, 
				cd_condicao_pagamento, 
				cd_comprador, 
				dt_ordem_compra, 
				clock_timestamp(), 
				nm_usuario_p, 
				cd_moeda, 
				ie_situacao, 
				dt_inclusao, 
				cd_pessoa_solicitante, 
				cd_cgc_transportador, 
				ie_frete, 
				vl_frete, 
				pr_multa_atraso, 
				pr_desconto, 
				pr_desc_pgto_antec, 
				pr_juros_negociado, 
				clock_timestamp(), 
				ds_pessoa_contato, 
				CASE WHEN coalesce(ds_observacao::text, '') = '' THEN  wheb_mensagem_pck.get_texto(299421, 'NR_ORDEM_COMPRA=' || nr_ordem_compra_p)  ELSE ds_observacao || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(299421, 'NR_ORDEM_COMPRA=' || nr_ordem_compra_p) END , 
				cd_motivo_alteracao, 
				cd_local_entrega, 
				dt_prevista_entrega_w, 
				nr_prescricao, 
				ie_aviso_chegada, 
				nr_requisicao, 
				cd_pessoa_fisica, 
				nr_ordem_agrup, 
				ie_emite_obs, 
				ie_urgente, 
				nr_seq_interno, 
				nr_atendimento, 
				nm_usuario_imp, 
				ie_somente_pagto, 
				nr_seq_motivo_cancel, 
				vl_despesa_acessoria, 
				cd_setor_atendimento, 
				nr_seq_subgrupo_compra, 
				pr_desc_financeiro, 
				dt_leitura, 
				dt_aceite, 
				nm_usuario_aceite, 
				nr_seq_forma_pagto, 
				coalesce(vl_desconto,0), 
				'D' 
			from	ordem_compra 
			where	nr_ordem_compra = nr_ordem_compra_p;
			 
			select	coalesce(max(nr_item_oci),0) +1 
			into STRICT	nr_item_oci_ww 
			from	ordem_compra_item 
			where	nr_ordem_compra = nr_nova_ordem_compra_w;
			 
			insert into ordem_compra_item( 
				nr_ordem_compra, 
				nr_item_oci, 
				cd_material, 
				cd_unidade_medida_compra, 
				vl_unitario_material, 
				qt_material, 
				dt_atualizacao, 
				nm_usuario, 
				ie_situacao, 
				cd_pessoa_solicitante, 
				qt_material_entregue, 
				pr_descontos, 
				cd_local_estoque, 
				ds_material_direto, 
				ds_observacao, 
				cd_motivo_alteracao, 
				nr_cot_compra, 
				nr_item_cot_compra, 
				ds_marca, 
				vl_item_liquido, 
				cd_centro_custo, 
				cd_conta_contabil, 
				nr_solic_compra, 
				nr_item_solic_compra, 
				qt_conv_unid_fornec, 
				ie_geracao_solic, 
				nr_seq_proj_rec, 
				pr_desc_financ, 
				nr_seq_lic_item, 
				nr_seq_conta_financ, 
				qt_original, 
				dt_validade, 
				nr_seq_marca, 
				nr_seq_ordem_serv, 
				vl_ultima_compra, 
				vl_dif_ultima_compra, 
				pr_dif_ultima_compra, 
				nr_seq_unidade_adic, 
				vl_desconto, 
				nr_atendimento, 
				vl_total_item) 
			SELECT	nr_nova_ordem_compra_w, 
				nr_item_oci_ww, 
				cd_material, 
				cd_unidade_medida_compra, 
				vl_unitario_material, 
				qt_prevista_entrega_w, 
				clock_timestamp(), 
				nm_usuario_p, 
				ie_situacao, 
				cd_pessoa_solicitante, 
				qt_material_entregue, 
				pr_descontos, 
				cd_local_estoque, 
				ds_material_direto, 
				ds_observacao, 
				cd_motivo_alteracao, 
				nr_cot_compra, 
				nr_item_cot_compra, 
				ds_marca, 
				0, 
				cd_centro_custo, 
				cd_conta_contabil, 
				nr_solic_compra, 
				nr_item_solic_compra, 
				qt_conv_unid_fornec, 
				ie_geracao_solic, 
				nr_seq_proj_rec, 
				pr_desc_financ, 
				nr_seq_lic_item, 
				nr_seq_conta_financ, 
				qt_original, 
				dt_validade, 
				nr_seq_marca, 
				nr_seq_ordem_serv, 
				vl_ultima_compra, 
				vl_dif_ultima_compra, 
				pr_dif_ultima_compra, 
				nr_seq_unidade_adic, 
				coalesce(vl_desconto,0), 
				nr_atendimento, 
				round((qt_prevista_entrega_w * vl_unitario_material)::numeric,4) 
			from	ordem_compra_item 
			where	nr_ordem_compra = nr_ordem_compra_p 
			and	nr_item_oci = nr_item_oci_w;
 
			insert	into ordem_compra_item_entrega( 
				nr_ordem_compra, 
				nr_item_oci, 
				dt_prevista_entrega, 
				dt_real_entrega, 
				dt_entrega_original, 
				dt_entrega_limite, 
				qt_prevista_entrega, 
				qt_real_entrega, 
				dt_atualizacao, 
				nm_usuario, 
				ds_observacao, 
				dt_cancelamento, 
				nr_sequencia) 
			SELECT	nr_nova_ordem_compra_w, 
				nr_item_oci_ww, 
				dt_prevista_entrega_w, 
				null, 
				dt_prevista_entrega_w, 
				dt_prevista_entrega_w, 
				qt_prevista_entrega_w, 
				null, 
				clock_timestamp(), 
				nm_usuario_p, 
				ds_observacao, 
				null, 
				nextval('ordem_compra_item_entrega_seq') 
			from	ordem_compra_item_entrega 
			where	nr_ordem_compra = nr_ordem_compra_p 
			and	nr_item_oci = nr_item_oci_w 
			and	dt_prevista_entrega = dt_prevista_entrega_w;
			 
			delete	from ordem_compra_item_entrega 
			where	nr_ordem_compra = nr_ordem_compra_p 
			and	nr_item_oci = nr_item_oci_w 
			and	dt_prevista_entrega = dt_prevista_entrega_w;
			 
			delete from ordem_compra_item a 
			where	nr_ordem_compra = nr_ordem_compra_p 
			and	nr_item_oci = nr_item_oci_w 
			and not exists (	SELECT	1 
					from	ordem_compra_item_entrega x 
					where	x.nr_ordem_compra = a.nr_ordem_compra 
					and	x.nr_item_oci = a.nr_item_oci);
			 
			ie_desdobrou_w := 'S';
			ds_lista_ordem_w := substr(ds_lista_ordem_w || nr_nova_ordem_compra_w || ', ',1,4000);
		end if;
		 
		dt_prevista_entrega_ww := dt_prevista_entrega_w;
	end if;
	 
	end;
end loop;
close C01;
 
ds_lista_ordem_w := substr(ds_lista_ordem_w,1,length(ds_lista_ordem_w)-2);
 
if (ie_desdobrou_w = 'S') then 
 
	CALL gerar_ordem_compra_hist(	nr_ordem_compra_p, 
					'S', 
					wheb_mensagem_pck.get_texto(299422), 
					substr( wheb_mensagem_pck.get_texto(299424, 'DS_LISTA=' || ds_lista_ordem_w),1,4000), 
					nm_usuario_p);
end if;
 
ds_lista_ordem_p := ds_lista_ordem_w;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desdobrar_oc_por_data_entrega ( nr_ordem_compra_p bigint, nm_usuario_p text, ds_lista_ordem_p INOUT text) FROM PUBLIC;

