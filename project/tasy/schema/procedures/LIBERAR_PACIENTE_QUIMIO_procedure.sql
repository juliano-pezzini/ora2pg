-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_paciente_quimio ( nr_seq_atendimento_p bigint, nr_seq_paciente_p bigint, nr_ciclo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ds_dia_ciclo_p text, nr_seq_motivo_bloq_p bigint, cd_pessoa_fisica_p text) AS $body$
DECLARE


ie_permite_autorizacao_w	varchar(255);
ie_autorizacao_quimio_w		varchar(1) := '';
aval_pac_lib_w			varchar(1) := '';
ie_avaliacao_w varchar(255);

BEGIN

ie_permite_autorizacao_w := obter_param_usuario(3130, 246, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_permite_autorizacao_w);
ie_avaliacao_w := Obter_Param_Usuario(3130, 354, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_avaliacao_w);

if ((nr_seq_motivo_bloq_p IS NOT NULL AND nr_seq_motivo_bloq_p::text <> '') or (ie_avaliacao_w IS NOT NULL AND ie_avaliacao_w::text <> '')) then
	begin
	select substr(obter_se_aval_pac_lib(cd_pessoa_fisica_p),1,1)
	into STRICT aval_pac_lib_w
	;

	if (aval_pac_lib_w = 'N') then
		begin
		CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(203119);	
		end;
	end if;
	end;
end if;

if (ie_permite_autorizacao_w IS NOT NULL AND ie_permite_autorizacao_w::text <> '') then
	begin
	
	select	coalesce(max('S'),'N')
	into STRICT 	ie_autorizacao_quimio_w
	from	paciente_atendimento
	where	nr_seq_paciente = nr_seq_paciente_p
	and (obter_se_contido(campo_numerico(obter_autorizacao_quimio(nr_seq_atendimento_p,nr_ciclo_p, ds_dia_ciclo_p,'N')),ie_permite_autorizacao_w) = 'S');
	
	
	if (ie_autorizacao_quimio_w = 'N') then
		begin
		CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(96016);
		end;
	end if;
	end;
end if;


update	paciente_atendimento
set	dt_liberacao	= clock_timestamp(),
	nm_usuario	= nm_usuario_p,
	nm_usuario_lib	= nm_usuario_p,
	ie_exige_liberacao	= 'N'
where	nr_seq_atendimento	= nr_seq_atendimento_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_paciente_quimio ( nr_seq_atendimento_p bigint, nr_seq_paciente_p bigint, nr_ciclo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ds_dia_ciclo_p text, nr_seq_motivo_bloq_p bigint, cd_pessoa_fisica_p text) FROM PUBLIC;

