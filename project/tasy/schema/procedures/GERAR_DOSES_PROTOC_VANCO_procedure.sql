-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_doses_protoc_vanco ( nm_usuario_p text, cd_estabelecimento_p text, cd_perfil_p text, nr_prescricao_p bigint, cd_material_p bigint, qt_dose_ataque_p bigint, qt_dose_manutencao_p bigint, cd_unid_med_dose_p text, cd_unid_med_consumo_p text, cd_intervalo_p text, ie_via_aplicacao_p text, ds_observacao_p text, ds_justificativa_p text, ie_lado_p text, ie_objetivo_p text, cd_microorganismo_cih_p text, cd_amostra_cih_p text, ie_origem_infeccao_p text, cd_topografia_cih_p text, ie_indicacao_p text, ie_uso_antimicrobiano_p text, ie_bomba_infusao_p text, qt_dias_util_p bigint, qt_min_aplicacao_p bigint, qt_hora_aplicacao_p bigint, ie_aplic_bolus_p text, ie_aplic_lenta_p text, ie_medicacao_paciente_p text, nr_ultima_sequencia_p INOUT bigint, ie_administrar_p text, nr_regra_serica_p bigint ) AS $body$
DECLARE

									 
qt_dias_util_w			bigint;
hr_prim_horario_w		varchar(5);
cd_interv_ataque_w		varchar(10);
nr_ocorrencia_w			double precision;
nr_horas_validade_w		bigint;
dt_prescricao_w			timestamp;
dt_inicio_prescr_w		timestamp;
dt_prim_inicio_medic_w	timestamp;
nr_atendimento_w		bigint;
nr_dia_util_w			bigint;
qt_dias_liberado_w		bigint;
qt_dias_lib_atend_w		bigint;
ie_controle_medico_w	varchar(5);
qt_conversao_dose_w		double precision;
nr_sequencia_w			bigint;
nr_agrupamento_w		double precision;
qt_min_intervalo_w		bigint;
qt_dia_prim_hor_w		bigint;
qt_unitaria_w			double precision;
qt_material_w			double precision;
qt_total_dias_lib_w		integer;
qt_total_dispensar_w	double precision;
ds_horarios_w			varchar(2000);
ds_horarios2_w			varchar(2000);
qt_operacao_interv_w	double precision;
ds_erro_w				varchar(4000);
ie_regra_disp_w			varchar(1);
nr_receita_w			bigint;
qt_hora_intervalo_w		smallint;
nr_seq_medic_material_w	prescr_material.nr_seq_medic_material%type;

-- Parâmetros da REP 
ie_REP_1069_w			varchar(1);


BEGIN 
 
if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then 
	 
	if (nr_ultima_sequencia_p IS NOT NULL AND nr_ultima_sequencia_p::text <> '') then 
		delete	FROM prescr_material 
		where	nr_sequencia = nr_ultima_sequencia_p 
		and		nr_prescricao = nr_prescricao_p;
		 
		commit;
		nr_ultima_sequencia_p	:= null;
	end if;
 
	ie_REP_1069_w := obter_param_usuario(924, 1069, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_REP_1069_w);
	 
	select	coalesce(max(nr_horas_validade), 24), 
			max(dt_inicio_prescr), 
			max(dt_prescricao), 
			max(nr_atendimento) 
	into STRICT	nr_horas_validade_w, 
			dt_inicio_prescr_w, 
			dt_prescricao_w, 
			nr_atendimento_w 
	from	prescr_medica 
	where	nr_prescricao = nr_prescricao_p;
 
	select	coalesce(max(qt_conversao),0) 
	into STRICT	qt_conversao_dose_w 
	from	unidade_medida_dose_v 
	where	cd_unidade_medida = cd_unid_med_dose_p 
	and		cd_material = cd_material_p;
 
	SELECT * FROM Consiste_Util_Medic(nr_prescricao_p, nr_atendimento_w, dt_prescricao_w, cd_material_p, nr_dia_util_w, qt_dias_liberado_w, ie_controle_medico_w, qt_dias_lib_atend_w) INTO STRICT nr_dia_util_w, qt_dias_liberado_w, ie_controle_medico_w, qt_dias_lib_atend_w;
			 
	-- Dose ATAQUE 
	select	coalesce(max(nr_sequencia),0) + 1 
	into STRICT	nr_sequencia_w 
	from	prescr_material 
	where	nr_prescricao	= nr_prescricao_p;
 
	select	coalesce(max(nr_agrupamento),0) + 1 
	into STRICT	nr_agrupamento_w 
	from	prescr_material 
	where	ie_agrupador	= 1 
	and		nr_prescricao	= nr_prescricao_p;
	 
	cd_interv_ataque_w	:= Obter_interv_acm_sn_agora_lib(cd_estabelecimento_p, 1, 2, 1, cd_material_p, null, nr_prescricao_p, null, null);
 
	select	max(qt_min_agora) 
	into STRICT	qt_min_intervalo_w 
	from	intervalo_prescricao 
	where	cd_intervalo = cd_interv_ataque_w;
 
	qt_dia_prim_hor_w	:= 0;
 
	dt_prim_inicio_medic_w	:= to_date(to_char(dt_prescricao_w, 'dd/mm/yyyy ') || coalesce(hr_prim_horario_w, to_char(dt_prescricao_w, 'hh24:mi')),'dd/mm/yyyy hh24:mi') + qt_operacao_interv_w/24;
	hr_prim_horario_w		:= to_char(dt_prim_inicio_medic_w, 'hh24:mi');
	 
	if (trunc(dt_prim_inicio_medic_w) > trunc(dt_inicio_prescr_w)) then 
		qt_dia_prim_hor_w	:= 1;
	end if;
	 
	hr_prim_horario_w	:= to_char(dt_prescricao_w + qt_dia_prim_hor_w + ((coalesce(qt_min_intervalo_w,0) + 30) / 1440),'hh24:mi');
	 
	qt_min_intervalo_w	:= null;
	 
	ds_horarios_w	:= hr_prim_horario_w;
	 
	nr_ocorrencia_w		:= 1;
	 
	if	((coalesce(qt_dose_ataque_p::text, '') = '') or (qt_conversao_dose_w = 0)) then 
		qt_unitaria_w	:= 0;
	else 
		qt_unitaria_w	:= dividir(qt_dose_ataque_p, qt_conversao_dose_w);
	end if;
	 
	Insert into Prescr_Material( 
		nr_prescricao, 
		nr_sequencia, 
		ie_origem_inf, 
		cd_material, 
		cd_unidade_medida, 
		qt_dose, 
		qt_unitaria, 
		qt_material, 
		dt_atualizacao, 
		dt_atualizacao_nrec, 
		nm_usuario, 
		nm_usuario_nrec, 
		nm_usuario_original, 
		cd_intervalo, 
		ds_observacao, 
		ie_via_aplicacao, 
		nr_agrupamento, 
		cd_motivo_baixa, 
		ie_utiliza_kit, 
		cd_unidade_medida_dose, 
		qt_conversao_dose, 
		ie_urgencia, 
		nr_ocorrencia, 
		qt_total_dispensar, 
		ds_horarios, 
		nr_sequencia_solucao, 
		nr_sequencia_dieta, 
		nr_sequencia_proc, 
		hr_prim_horario, 
		ie_suspenso, 
		ie_agrupador, 
		qt_min_aplicacao, 
		qt_hora_aplicacao, 
		ie_bomba_infusao, 
		ie_aplic_bolus, 
		ie_aplic_lenta, 
		ie_se_necessario, 
		ie_acm, 
		qt_solucao, 
		ie_cultura_cih, 
		ie_antibiograma, 
		ie_uso_antimicrobiano, 
		ie_recons_diluente_fixo, 
		ie_sem_aprazamento, 
		nr_dia_util, 
		qt_total_dias_lib, 
		ie_regra_disp, 
		ie_lado, 
		ie_objetivo, 
		qt_dias_solicitado, 
		qt_min_intervalo, 
		ie_checar_adep, 
		ie_permite_substituir, 
		ds_justificativa, 
		qt_hora_intervalo, 
		cd_topografia_cih, 
		nr_receita, 
		cd_microorganismo_cih, 
		cd_amostra_cih, 
		ie_origem_infeccao, 
		ie_indicacao, 
		ie_medicacao_paciente, 
		ie_dose_espec_agora, 
		qt_dose_especial, 
		hr_dose_especial, 
		ie_aplicar, 
		ds_observacao_far, 
		ie_fator_correcao, 
		qt_dia_prim_hor, 
		ie_em_protocolo_vanco) 
	values ( 
		nr_prescricao_p, 
		nr_sequencia_w, 
		'S', 
		cd_material_p, 
		cd_unid_med_consumo_p, 
		qt_dose_ataque_p, 
		coalesce(qt_unitaria_w,0), 
		coalesce(qt_material_w,0), 
		clock_timestamp(), 
		clock_timestamp(), 
		nm_usuario_p, 
		nm_usuario_p, 
		nm_usuario_p, 
		cd_interv_ataque_w, 
		ds_observacao_p, 
		ie_via_aplicacao_p, 
		(substr(nr_agrupamento_w,1,7))::numeric , 
		0, 
		'N', 
		cd_unid_med_dose_p, 
		qt_conversao_dose_w, 
		'S', 
		nr_ocorrencia_w, 
		0, 
		ds_horarios_w, 
		null, 
		null, 
		null, 
		hr_prim_horario_w, 
		'N', 
		1, 
		qt_min_aplicacao_p, 
		qt_hora_aplicacao_p, 
		ie_bomba_infusao_p, 
		ie_aplic_bolus_p, 
		ie_aplic_lenta_p, 
		'N', 
		'N', 
		null, 
		'N', 
		'N', 
		'N', 
		'N', 
		'N', 
		nr_dia_util_w, 
		qt_dias_lib_atend_w, 
		ie_regra_disp_w, 
		ie_lado_p, 
		ie_objetivo_p, 
		qt_dias_util_p, 
		qt_min_intervalo_w, 
		'S', 
		'S', 
		ds_justificativa_p, 
		qt_hora_intervalo_w, 
		cd_topografia_cih_p, 
		nr_receita_w, 
		cd_microorganismo_cih_p, 
		cd_amostra_cih_p, 
		ie_origem_infeccao_p, 
		ie_indicacao_p, 
		ie_medicacao_paciente_p, 
		'N', 
		null, 
		null, 
		'S', 
		null, 
		'N', 
		qt_dia_prim_hor_w, 
		'S');
	commit;
	 
	CALL Gravar_acao_protocolo_vanco(nm_usuario_p, 
								nr_atendimento_w, 
								nr_prescricao_p, 
								nr_sequencia_w, 
								qt_dose_ataque_p, 
								qt_dose_ataque_p, 
								null, 
								null, 
								cd_unid_med_dose_p, 
								cd_unid_med_dose_p, 
								cd_interv_ataque_w, 
								cd_interv_ataque_w, 
								'', 
								nr_regra_serica_p, 
								'S');
	 
	SELECT * FROM Obter_Quant_Dispensar(cd_estabelecimento_p, cd_material_p, nr_prescricao_p, nr_sequencia_w, cd_intervalo_p, ie_via_aplicacao_p, qt_unitaria_w, 0, nr_ocorrencia_w, '', 'S', cd_unid_med_dose_p, qt_dias_util_w, qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w, 'N', 'N') INTO STRICT qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w;
 
	update	prescr_material 
	set 	nr_ocorrencia		= nr_ocorrencia_w, 
			qt_total_dispensar	= qt_total_dispensar_w, 
			qt_material			= qt_material_w, 
			ie_regra_disp		= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END , 
			ie_administrar		= ie_administrar_p 
	where	nr_sequencia		= nr_sequencia_w 
	and		nr_prescricao 		= nr_prescricao_p;
 
	update	prescr_material 
	set		nr_dia_util			= nr_dia_util_w, 
			qt_total_dias_lib 	= qt_dias_lib_atend_w 
	where	nr_sequencia		= nr_sequencia_w 
	and		nr_prescricao 		= nr_prescricao_p;
 
	CALL Gerar_Reconst_Diluicao(nr_prescricao_p, nr_sequencia_w, 'A');
	CALL Ajustar_Dose_Diluente(nr_prescricao_p, nr_sequencia_w);
 
	if (ie_REP_1069_w = 'S') and (obter_se_medic_diluido(nr_prescricao_p, nr_sequencia_w) = 'S') then 
		update	prescr_material 
		set		qt_solucao = qt_dose 
		where	nr_sequencia = nr_sequencia_w 
		and		nr_prescricao = nr_prescricao_p;
	end if;
 
	CALL Ajustar_Prescr_Material(nr_prescricao_p, nr_sequencia_w);
 
	ds_erro_w := consistir_prescr_material(nr_prescricao_p, nr_sequencia_w, nm_usuario_p, cd_perfil_p, ds_erro_w);
 
	nr_seq_medic_material_w		:= nr_sequencia_w;
	 
	-- Dose MANUTENÇÃO 
	select	coalesce(max(nr_sequencia),0) + 1 
	into STRICT	nr_sequencia_w 
	from	prescr_material 
	where	nr_prescricao	= nr_prescricao_p;
 
	select	coalesce(max(nr_agrupamento),0) + 1 
	into STRICT	nr_agrupamento_w 
	from	prescr_material 
	where	ie_agrupador	= 1 
	and		nr_prescricao	= nr_prescricao_p;
	 
	select	max(qt_min_intervalo), 
			max(qt_operacao) 
	into STRICT	qt_min_intervalo_w, 
			qt_operacao_interv_w 
	from	intervalo_prescricao 
	where	cd_intervalo = cd_intervalo_p;
	 
	if (coalesce(qt_operacao_interv_w::text, '') = '') then 
		dt_prim_inicio_medic_w	:=	dt_inicio_prescr_w;
	else 
		dt_prim_inicio_medic_w	:= to_date(to_char(dt_inicio_prescr_w, 'dd/mm/yyyy ') || hr_prim_horario_w,'dd/mm/yyyy hh24:mi') + qt_operacao_interv_w/24;
	end if;
	 
	-- Conforme definição com Dr. Haertel e equipe clínica, o horário em sequência deverá ser sempre arredondado. 
	dt_prim_inicio_medic_w	:= round(dt_prim_inicio_medic_w, 'hh24');
	hr_prim_horario_w		:= to_char(dt_prim_inicio_medic_w, 'hh24:mi');
	 
	ds_horarios_w	:= '';
	ds_horarios2_w	:= '';
	nr_ocorrencia_w	:= 0;
	 
	SELECT * FROM Calcular_Horario_Prescricao( nr_prescricao_p, cd_intervalo_p, dt_inicio_prescr_w, dt_prim_inicio_medic_w, nr_horas_validade_w, cd_material_p, qt_hora_intervalo_w, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w, 'N', '') INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w;
	 
	ds_horarios_w	:= ds_horarios_w || ds_horarios2_w;
	 
	qt_dia_prim_hor_w	:= 0;
	 
	if (trunc(dt_prim_inicio_medic_w) > trunc(dt_inicio_prescr_w)) then 
		qt_dia_prim_hor_w	:= 1;
	end if;
	 
	if	((coalesce(qt_dose_manutencao_p::text, '') = '') or (qt_conversao_dose_w = 0)) then 
		qt_unitaria_w	:= 0;
	else 
		qt_unitaria_w	:= qt_dose_manutencao_p / qt_conversao_dose_w;
	end if;
 
	Insert into Prescr_Material( 
				nr_prescricao, 
				nr_sequencia, 
				ie_origem_inf, 
				cd_material, 
				cd_unidade_medida, 
				qt_dose, 
				qt_unitaria, 
				qt_material, 
				dt_atualizacao, 
				dt_atualizacao_nrec, 
				nm_usuario, 
				nm_usuario_nrec, 
				nm_usuario_original, 
				cd_intervalo, 
				ds_observacao, 
				ie_via_aplicacao, 
				nr_agrupamento, 
				cd_motivo_baixa, 
				ie_utiliza_kit, 
				cd_unidade_medida_dose, 
				qt_conversao_dose, 
				ie_urgencia, 
				nr_ocorrencia, 
				qt_total_dispensar, 
				ds_horarios, 
				nr_sequencia_solucao, 
				nr_sequencia_dieta, 
				nr_sequencia_proc, 
				hr_prim_horario, 
				ie_suspenso, 
				ie_agrupador, 
				qt_min_aplicacao, 
				qt_hora_aplicacao, 
				ie_bomba_infusao, 
				ie_aplic_bolus, 
				ie_aplic_lenta, 
				ie_se_necessario, 
				ie_acm, 
				qt_solucao, 
				ie_cultura_cih, 
				ie_antibiograma, 
				ie_uso_antimicrobiano, 
				ie_recons_diluente_fixo, 
				ie_sem_aprazamento, 
				nr_dia_util, 
				qt_total_dias_lib, 
				ie_regra_disp, 
				ie_lado, 
				ie_objetivo, 
				qt_dias_solicitado, 
				qt_min_intervalo, 
				ie_checar_adep, 
				ie_permite_substituir, 
				ds_justificativa, 
				qt_hora_intervalo, 
				cd_topografia_cih, 
				nr_receita, 
				cd_microorganismo_cih, 
				cd_amostra_cih, 
				ie_origem_infeccao, 
				ie_indicacao, 
				ie_medicacao_paciente, 
				ie_dose_espec_agora, 
				qt_dose_especial, 
				hr_dose_especial, 
				ie_aplicar, 
				ds_observacao_far, 
				ie_fator_correcao, 
				qt_dia_prim_hor, 
				ie_em_protocolo_vanco, 
				nr_seq_medic_material) 
			values ( 
				nr_prescricao_p, 
				nr_sequencia_w, 
				'S', 
				cd_material_p, 
				cd_unid_med_consumo_p, 
				qt_dose_manutencao_p, 
				coalesce(qt_unitaria_w,0), 
				coalesce(qt_material_w,0), 
				clock_timestamp(), 
				clock_timestamp(), 
				nm_usuario_p, 
				nm_usuario_p, 
				nm_usuario_p, 
				cd_intervalo_p, 
				ds_observacao_p, 
				ie_via_aplicacao_p, 
				(substr(nr_agrupamento_w,1,7))::numeric , 
				0, 
				'N', 
				cd_unid_med_dose_p, 
				qt_conversao_dose_w, 
				'N', 
				nr_ocorrencia_w, 
				0, 
				ds_horarios_w, 
				null, 
				null, 
				null, 
				hr_prim_horario_w, 
				'N', 
				1, 
				qt_min_aplicacao_p, 
				qt_hora_aplicacao_p, 
				ie_bomba_infusao_p, 
				ie_aplic_bolus_p, 
				ie_aplic_lenta_p, 
				'N', 
				'N', 
				null, 
				'N', 
				'N', 
				'N', 
				'N', 
				'N', 
				nr_dia_util_w, 
				qt_dias_lib_atend_w, 
				ie_regra_disp_w, 
				ie_lado_p, 
				ie_objetivo_p, 
				qt_dias_util_p, 
				qt_min_intervalo_w, 
				'S', 
				'S', 
				ds_justificativa_p, 
				qt_hora_intervalo_w, 
				cd_topografia_cih_p, 
				nr_receita_w, 
				cd_microorganismo_cih_p, 
				cd_amostra_cih_p, 
				ie_origem_infeccao_p, 
				ie_indicacao_p, 
				ie_medicacao_paciente_p, 
				'N', 
				null, 
				null, 
				'S', 
				null, 
				'N', 
				qt_dia_prim_hor_w, 
				'S', 
				nr_seq_medic_material_w);
	commit;
	 
	CALL Gravar_acao_protocolo_vanco(nm_usuario_p, 
								nr_atendimento_w, 
								nr_prescricao_p, 
								nr_sequencia_w, 
								null, 
								null, 
								qt_dose_manutencao_p, 
								qt_dose_manutencao_p, 
								cd_unid_med_dose_p, 
								cd_unid_med_dose_p, 
								cd_intervalo_p, 
								cd_intervalo_p, 
								'', 
								nr_regra_serica_p, 
								'S');
		 
	SELECT * FROM Obter_Quant_Dispensar(cd_estabelecimento_p, cd_material_p, nr_prescricao_p, nr_sequencia_w, cd_intervalo_p, ie_via_aplicacao_p, qt_unitaria_w, 0, nr_ocorrencia_w, '', 'S', cd_unid_med_dose_p, qt_dias_util_w, qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w, 'N', 'N') INTO STRICT qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w;
 
	update	prescr_material 
	set 	nr_ocorrencia		= nr_ocorrencia_w, 
			qt_total_dispensar	= qt_total_dispensar_w, 
			qt_material			= qt_material_w, 
			ie_regra_disp		= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END , 
			ie_administrar		= ie_administrar_p 
	where	nr_sequencia		= nr_sequencia_w 
	and		nr_prescricao 		= nr_prescricao_p;
 
	update	prescr_material 
	set		nr_dia_util			= nr_dia_util_w, 
			qt_total_dias_lib 	= qt_dias_lib_atend_w 
	where	nr_sequencia		= nr_sequencia_w 
	and		nr_prescricao 		= nr_prescricao_p;
 
	CALL Gerar_Reconst_Diluicao(nr_prescricao_p, nr_sequencia_w, 'A');
	CALL Ajustar_Dose_Diluente(nr_prescricao_p, nr_sequencia_w);
 
	if (ie_REP_1069_w = 'S') and (obter_se_medic_diluido(nr_prescricao_p, nr_sequencia_w) = 'S') then 
		update	prescr_material 
		set		qt_solucao = qt_dose 
		where	nr_sequencia = nr_sequencia_w 
		and		nr_prescricao = nr_prescricao_p;
	end if;
 
	CALL Ajustar_Prescr_Material(nr_prescricao_p, nr_sequencia_w);
 
	ds_erro_w := consistir_prescr_material(nr_prescricao_p, nr_sequencia_w, nm_usuario_p, cd_perfil_p, ds_erro_w);
				 
	commit;
	 
	nr_ultima_sequencia_p	:= nr_sequencia_w;
end if;
 
commit;
	 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_doses_protoc_vanco ( nm_usuario_p text, cd_estabelecimento_p text, cd_perfil_p text, nr_prescricao_p bigint, cd_material_p bigint, qt_dose_ataque_p bigint, qt_dose_manutencao_p bigint, cd_unid_med_dose_p text, cd_unid_med_consumo_p text, cd_intervalo_p text, ie_via_aplicacao_p text, ds_observacao_p text, ds_justificativa_p text, ie_lado_p text, ie_objetivo_p text, cd_microorganismo_cih_p text, cd_amostra_cih_p text, ie_origem_infeccao_p text, cd_topografia_cih_p text, ie_indicacao_p text, ie_uso_antimicrobiano_p text, ie_bomba_infusao_p text, qt_dias_util_p bigint, qt_min_aplicacao_p bigint, qt_hora_aplicacao_p bigint, ie_aplic_bolus_p text, ie_aplic_lenta_p text, ie_medicacao_paciente_p text, nr_ultima_sequencia_p INOUT bigint, ie_administrar_p text, nr_regra_serica_p bigint ) FROM PUBLIC;

