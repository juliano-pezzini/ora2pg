-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_alerta_troca_setor ( nm_usuario_p text, cd_novo_setor_atendimento_p bigint, ie_commit_p text) AS $body$
DECLARE
 		
nr_seq_evento_w		bigint;
cd_pessoa_fisica_w	varchar(10);
				
c01 CURSOR FOR 
	SELECT	a.nr_seq_evento 
	from	regra_envio_sms a 
	where	a.ie_evento_disp = 'TSU' 
	and	coalesce(a.ie_situacao,'A') = 'A';
	

BEGIN 
select	coalesce(max(cd_pessoa_fisica),0) 
into STRICT	cd_pessoa_fisica_w 
from	usuario 
where	nm_usuario = nm_usuario_p;
 
open C01;
loop 
fetch C01 into	 
	nr_seq_evento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin	 
	CALL gerar_evento_paciente(	nr_seq_evento_w, 
							null, 
							cd_pessoa_fisica_w, 
							null, 
							nm_usuario_p, 
							null, 
							null, 
							null, 
							null, 
							null, 
							null, 
							null, 
							null, 
							null, 
							null, 
							ie_commit_p, 
							null, 
							clock_timestamp(), 
							null, 
							cd_novo_setor_atendimento_p);
	end;
end loop;
close C01;
 
if (ie_commit_p = 'S') then 
	commit;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_alerta_troca_setor ( nm_usuario_p text, cd_novo_setor_atendimento_p bigint, ie_commit_p text) FROM PUBLIC;

