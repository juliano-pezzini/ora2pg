-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_nom_rc_alergia ( nr_seq_cabecalho_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* Alergias */

nr_atendimento_w			atendimento_paciente.nr_atendimento%type;
nr_seq_episodio_w			episodio_paciente.nr_sequencia%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;

ds_agente_w			varchar(2000);
dt_registro_w		timestamp;
nm_medico_w			pessoa_fisica.nm_pessoa_fisica%type;
ds_tipo_reacao_w	varchar(255);
ds_situacao_w		varchar(255);
ds_observacao_w		varchar(4000);
dt_inicio_w			timestamp;

qt_registro_w		bigint	:= 0;

ds_html_w			varchar(32000)	:= null;

c_alergias CURSOR FOR
	SELECT	distinct coalesce(
				substr(obter_estrut_princ_ativo(a.nr_seq_ficha_tecnica,'P'),1,2000),
				substr(obter_desc_dcb(a.nr_seq_dcb),1,80),
				substr(obter_desc_dcb_mat(a.cd_material,'D'),1,80),
				substr(obter_desc_material(a.cd_material),1,100),
				substr(obter_desc_classe_mat(a.cd_classe_mat),1,60),
				a.ds_medic_nao_cad,
				substr(obter_desc_alergeno(a.nr_seq_tipo),1,80)) ds_agente,
			a.dt_inicio,
			obter_nome_pf(a.cd_profissional) nm_medico,
			substr(obter_desc_reacao_alergica(a.nr_seq_reacao),1,100) ds_tipo_reacao,
			CASE WHEN a.ie_estado_atual='S' THEN  obter_texto_tasy(1015134, NULL)  ELSE obter_texto_tasy(1015133, NULL) END  ds_situacao,
			a.ds_observacao ds_observacao
	from	paciente_alergia a,
			atendimento_paciente b
	where 	a.cd_pessoa_fisica = b.cd_pessoa_fisica
	and 	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and 	coalesce(a.dt_inativacao::text, '') = ''
	and 	coalesce(ie_nega_alergias, 'N') = 'N'
	and		b.nr_atendimento in (SELECT	x.nr_atendimento
									from	nom_rc_cabecalho x
									where	x.nr_sequencia = nr_seq_cabecalho_p
									and		(x.nr_atendimento IS NOT NULL AND x.nr_atendimento::text <> '')
									
union

									select	y.nr_atendimento
									from	atendimento_paciente y,
											nom_rc_cabecalho x
									where	x.nr_seq_episodio = y.nr_seq_episodio
									and		x.nr_sequencia = nr_seq_cabecalho_p);

BEGIN

delete from nom_rc_alergia
where nr_seq_cabecalho = nr_seq_cabecalho_p;

select	a.nr_atendimento,
		a.nr_seq_episodio
into STRICT	nr_atendimento_w,
		nr_seq_episodio_w
from	nom_rc_cabecalho a
where	a.nr_sequencia	= nr_seq_cabecalho_p;


if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
	null;
elsif (nr_seq_episodio_w IS NOT NULL AND nr_seq_episodio_w::text <> '') then
	select	min(nr_atendimento)
	into STRICT	nr_atendimento_w
	from	atendimento_paciente a
	where	a.nr_seq_episodio = nr_seq_episodio_w;
end if;


if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
	ds_html_w	:= '<table class="wrichedit-table" width="100%" xmlns="urn:hl7-org:v3">';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || '<thead>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '<tr>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Alergeno</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Fecha inicial</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Médico</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Reacción</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Estado actual</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Observaciones</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '</tr>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) ||  '</thead>';

	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || '<tbody>';
	for	r_c_alergias in c_alergias loop

		qt_registro_w	:= qt_registro_w + 1;
		ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '<tr>';

		ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || r_c_alergias.ds_agente || '</td>';
		ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || obter_data_utc(r_c_alergias.dt_inicio, 'NOM_TABLE') || '</td>';
		ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || r_c_alergias.nm_medico || '</td>';
		ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || r_c_alergias.ds_tipo_reacao || '</td>';
		ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || r_c_alergias.ds_situacao || '</td>';
		ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || r_c_alergias.ds_observacao || '</td>';

		ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '</tr>';
	end loop;

	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || '</tbody>';

	ds_html_w	:= ds_html_w || chr(13) || chr(10) || '</table>';

	ds_html_w	:= substr(ds_html_w, 0, 32000);

	if (qt_registro_w = 0) then
		ds_html_w	:= '<table class="wrichedit-table" width="100%" xmlns="urn:hl7-org:v3">';
		ds_html_w	:= ds_html_w || '<thead>';
		ds_html_w	:= ds_html_w || '<tr>';
		ds_html_w	:= ds_html_w || '<th>Alergias</th>';
		ds_html_w	:= ds_html_w || '</tr>';
		ds_html_w	:= ds_html_w || '</thead>';

		ds_html_w	:= ds_html_w || '<tbody>';

		ds_html_w	:= ds_html_w || '<tr>';
		ds_html_w	:= ds_html_w || '<td>' || 'Sin alergias registradas' || '</td>';
		ds_html_w	:= ds_html_w || '</tr>';

		ds_html_w	:= ds_html_w || '</tbody>';
		ds_html_w	:= ds_html_w || '</table>';
	end if;

	insert into nom_rc_alergia(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ds_alergias,
		nr_seq_cabecalho)
	values (nextval('nom_rc_motivo_ref_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		ds_html_w,
		nr_seq_cabecalho_p);
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_nom_rc_alergia ( nr_seq_cabecalho_p bigint, nm_usuario_p text) FROM PUBLIC;

