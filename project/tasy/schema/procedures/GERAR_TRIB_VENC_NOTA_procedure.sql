-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_trib_venc_nota ( nr_sequencia_p bigint, cd_tributo_p bigint, nm_usuario_p text, dt_vigencia_p timestamp) AS $body$
DECLARE


cd_tributo_w			bigint;
pr_imposto_w			double precision;
vl_liquido_w			double precision;
vl_inss_w			double precision;
vl_tributo_w			double precision;
cd_estabelecimento_w		smallint;
cd_cond_pagto_w			smallint;
cd_cgc_w			varchar(20);
cd_cgc_emitente_w		varchar(20);
cd_pessoa_fisica_w		varchar(10);
cd_beneficiario_w		varchar(20);
ie_acumulativo_w		varchar(1);
cd_conta_financ_w		bigint;
nr_seq_trans_reg_w		bigint;
nr_seq_trans_baixa_w		bigint;
cd_natureza_operacao_w		bigint;
vl_minimo_base_calculo_w	double precision;
vl_minimo_tributo_w		double precision;
vl_soma_trib_nao_retido_w	double precision;
vl_soma_base_nao_retido_w	double precision;
vl_soma_trib_adic_w		double precision;
vl_soma_base_adic_w		double precision;
vl_tributo_a_reter_w		double precision;
vl_base_a_reter_w		double precision;
vl_trib_nao_retido_w		double precision;
vl_base_nao_retido_w		double precision;
vl_trib_adic_w			double precision;
vl_base_adic_w			double precision;
vl_liquido_original_w		double precision;
vl_trib_anterior_w		double precision;
vl_base_venc_w			double precision;
vl_total_nota_w			double precision;
vl_vencimento_w			double precision;
dt_emissao_w			timestamp;
vl_teto_base_w			double precision;
vl_total_base_w			double precision;
vl_desc_nf_w			double precision;
ie_tipo_tributo_w		varchar(15);
ie_irpf_w			varchar(1);
ie_apuracao_piso_w		varchar(3);
ie_ordem_w			varchar(1);
vl_reducao_w			double precision;
vl_desc_dependente_w		double precision;
qt_dependente_w			smallint;
cd_darf_w			varchar(20);
ie_corpo_item_w			varchar(5);
ie_soma_diminui_w		varchar(5);
cont_w				integer;
cd_variacao_w			varchar(2);
ie_periodicidade_w		varchar(1);
nr_contrato_w			bigint;
cd_condicao_pagamento_w		bigint;
ie_forma_pagamento_w		smallint;
ie_corpo_item_ant_w		varchar(20);
cd_cnpj_raiz_w			varchar(20);
ie_cnpj_w			varchar(20);
cd_cnpj_emitente_raiz_w		varchar(20);
nr_ccm_w			bigint	:= null;
ie_tipo_tributacao_w		varchar(255);	
cd_tipo_servico_w		varchar(100);
ds_irrelevante_w		varchar(4000);
nr_seq_regra_w			bigint;
cd_grupo_material_regra_w	bigint;
cd_subgrupo_material_regra_w	bigint;
cd_classe_material_regra_w	bigint;
cd_material_regra_w		bigint;
vl_item_nf_w			double precision;
cd_estab_regra_w		bigint;
vl_base_calculo_paga_w		double precision;
cd_empresa_regra_w		bigint;
cd_operacao_nf_w		smallint;
cd_tributo_pf_w			bigint;
vl_base_tributo_pf_w		double precision;
vl_tributo_pf_w			double precision;
dt_inicio_vigencia_w		timestamp;
dt_fim_vigencia_w		timestamp;
cd_pessoa_fisica_pf_w		varchar(10);
ie_vencimento_pf_w		varchar(255);
ds_emp_retencao_w		varchar(255);
ie_tipo_data_w			varchar(255);
ie_pago_prev_rep_w		varchar(255);
qt_registro_w			bigint;
ie_trib_pago_prev_w		varchar(255);
ie_restringe_estab_w		varchar(255);
ie_desc_nf_w			varchar(255);
vl_pago_w			double precision;
qt_pago_outros_w		bigint;
nr_seq_classe_w			bigint;
cd_tipo_baixa_neg_w		integer;
qt_regra_material_w		bigint	:= 0;
qt_regra_duplicada_w		bigint	:= 0;
ie_gera_trib_geral_w		varchar(15);
vl_tributo_venc_w			double precision;
dt_vencimento_w			timestamp;
cd_empresa_w			smallint;
nr_seq_regra_irpf_w		regra_calculo_irpf.nr_sequencia%type;

C01 CURSOR FOR
SELECT	ie_ordem,
	cd_tributo,
	ie_tipo_tributo,
	ie_apuracao_piso,
	ie_corpo_item,
	ie_soma_diminui,
	ie_cnpj,
	ie_restringe_estab,
	ie_desc_nf
from	(SELECT	CASE WHEN a.ie_tipo_tributo='IR' THEN 'Z' WHEN a.ie_tipo_tributo='ISRDOM' THEN 'Z'  ELSE 'A' END  ie_ordem,
		a.cd_tributo,
		a.ie_tipo_tributo,
		a.ie_apuracao_piso,
		a.ie_corpo_item,
		a.ie_soma_diminui,
		a.ie_cnpj,
		a.ie_restringe_estab,
		coalesce(a.ie_desc_nf,'N') ie_desc_nf
	from	Tributo a
	where	a.ie_conta_pagar	= 'S'
	and	a.ie_situacao		= 'A'
	and	coalesce(nr_contrato_w,0) > 0
	and	((ie_gera_trib_geral_w = 'S') and
		not exists (	select	1
				from 	CONTRATO_REGRA_PAGTO_TRIB d,
					CONTRATO_REGRA_NF c
				where	d.nr_seq_regra_nf	= c.nr_sequencia
				and	c.nr_seq_contrato	= nr_contrato_w))
	and	a.ie_corpo_item = 'V'
	and (coalesce(ie_baixa_titulo,'N')	= 'N')
	and	((coalesce(ie_tipo_tributacao_w, 'X') <> '0') or (coalesce(ie_super_simples, 'S') = 'S'))
	and	coalesce(cd_tributo_p, a.cd_tributo)	= a.cd_tributo
	and	((coalesce(ie_pf_pj,'A') 	= 'A') or
		 (ie_pf_pj = 'PF' AND cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') or
		 ((ie_pf_pj = 'PJ') and ((cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') and (coalesce(cd_pessoa_fisica_w::text, '') = ''))))
	and (coalesce(nr_ccm_w::text, '') = '' or coalesce(a.ie_ccm,'S') = 'S')
	and	not exists (select 1 from nota_fiscal_trib x where x.nr_sequencia = nr_sequencia_p and x.cd_tributo = a.cd_tributo and (coalesce(x.ie_pago_prev,'V') = 'V')
			
union

			 select 1 from nota_fiscal_venc_trib x where x.nr_sequencia = nr_sequencia_p and x.cd_tributo = a.cd_tributo)
	and	coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
	
union

	select	CASE WHEN a.ie_tipo_tributo='IR' THEN 'Z' WHEN a.ie_tipo_tributo='ISRDOM' THEN 'Z'  ELSE 'A' END  ie_ordem,
		a.cd_tributo,
		a.ie_tipo_tributo,
		a.ie_apuracao_piso,
		a.ie_corpo_item,
		a.ie_soma_diminui,
		a.ie_cnpj,
		a.ie_restringe_estab,
		coalesce(a.ie_desc_nf,'N')
	from	Tributo a
	where	a.ie_conta_pagar	= 'S'
	and	a.ie_situacao		= 'A'
	and	((coalesce(nr_contrato_w,0) > 0 and ie_gera_trib_geral_w = 'C') or (coalesce(nr_contrato_w,0) = 0))
	and	a.ie_corpo_item = 'V'
	and (coalesce(ie_baixa_titulo,'N')	= 'N')
	and	((coalesce(ie_tipo_tributacao_w, 'X') <> '0') or (coalesce(ie_super_simples, 'S') = 'S'))
	and	coalesce(cd_tributo_p, a.cd_tributo)	= a.cd_tributo
	and	((coalesce(ie_pf_pj,'A') 	= 'A') or
		 (ie_pf_pj = 'PF' AND cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') or
		 ((ie_pf_pj = 'PJ') and ((cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') and (coalesce(cd_pessoa_fisica_w::text, '') = ''))))
	and (coalesce(nr_ccm_w::text, '') = '' or coalesce(a.ie_ccm,'S') = 'S')
	and	not exists (select 1 from nota_fiscal_trib x where x.nr_sequencia = nr_sequencia_p and x.cd_tributo = a.cd_tributo and (coalesce(x.ie_pago_prev,'V') = 'V')
			 
union

			 select 1 from nota_fiscal_venc_trib x where x.nr_sequencia = nr_sequencia_p and x.cd_tributo = a.cd_tributo)
	and	coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
	
union

	select	CASE WHEN a.ie_tipo_tributo='IR' THEN 'Z' WHEN a.ie_tipo_tributo='ISRDOM' THEN 'Z'  ELSE 'A' END  ie_ordem,
		a.cd_tributo,
		a.ie_tipo_tributo,
		a.ie_apuracao_piso,
		a.ie_corpo_item,
		a.ie_soma_diminui,
		a.ie_cnpj,
		a.ie_restringe_estab,
		coalesce(a.ie_desc_nf,'N')
	from	Tributo a
	where	a.ie_conta_pagar	= 'S'
	and	a.ie_situacao		= 'A'
	and	((coalesce(nr_contrato_w,0) > 0) and (ie_gera_trib_geral_w = 'N') and
		exists (select	1
			from 	CONTRATO_REGRA_PAGTO_TRIB d,
				CONTRATO_REGRA_NF c
			where	d.nr_seq_regra_nf	= c.nr_sequencia
			and	d.cd_tributo		= a.cd_tributo
			and	c.nr_seq_contrato	= nr_contrato_w
			and	coalesce(d.ie_regra_trib,'N') = 'S'))
	and	a.ie_corpo_item = 'V'
	and (coalesce(ie_baixa_titulo,'N')	= 'N')
	and	((coalesce(ie_tipo_tributacao_w, 'X') <> '0') or (coalesce(ie_super_simples, 'S') = 'S'))
	and	coalesce(cd_tributo_p, a.cd_tributo)	= a.cd_tributo
	and	((coalesce(ie_pf_pj,'A') 	= 'A') or
		 (ie_pf_pj = 'PF' AND cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') or
		 ((ie_pf_pj = 'PJ') and ((cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') and (coalesce(cd_pessoa_fisica_w::text, '') = ''))))
	and (coalesce(nr_ccm_w::text, '') = '' or coalesce(a.ie_ccm,'S') = 'S')
	and	not exists (select 1 from nota_fiscal_trib x where x.nr_sequencia = nr_sequencia_p and x.cd_tributo = a.cd_tributo and (coalesce(x.ie_pago_prev,'V') = 'V')
			 
union

			 select 1 from nota_fiscal_venc_trib x where x.nr_sequencia = nr_sequencia_p and x.cd_tributo = a.cd_tributo)
	and	coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w) a
order by CASE WHEN a.ie_tipo_tributo='INSS' THEN 1  ELSE 2 END ,
	CASE WHEN a.ie_corpo_item='C' THEN  0  ELSE 1 END ,
	ie_ordem;

C02 CURSOR FOR
SELECT	1 ie_ordem,
	a.cd_estabelecimento,
	a.cd_cgc,
	a.cd_cgc_emitente,
	a.cd_pessoa_fisica,
	b.dt_vencimento,
	b.vl_base_venc
from	nota_fiscal_venc b,
	nota_fiscal a
where	a.nr_sequencia	= nr_sequencia_p
and	a.nr_sequencia	= b.nr_sequencia
and	ie_corpo_item_w	= 'V'
order by	ie_ordem,
	dt_vencimento asc;

C03 CURSOR FOR
SELECT	b.dt_vencimento
from	nota_fiscal_venc b,
	nota_fiscal a
where	a.nr_sequencia	= nr_sequencia_p
and	a.nr_sequencia	= b.nr_sequencia
order by	dt_vencimento desc;


BEGIN
select	a.cd_estabelecimento,
	a.cd_cgc,
	a.cd_cgc_emitente,
	a.cd_pessoa_fisica,
	a.dt_emissao,
	a.cd_condicao_pagamento,
	obter_cnpj_raiz(a.cd_cgc),
	obter_cnpj_raiz(a.cd_cgc_emitente),
	a.cd_natureza_operacao,
	a.cd_tipo_servico,
	a.cd_operacao_nf,
	coalesce(a.vl_descontos,0),
	b.cd_empresa
into STRICT	cd_estabelecimento_w,
	cd_cgc_w,
	cd_cgc_emitente_w,
	CD_pessoa_fisica_w,
	dt_emissao_w,
	cd_condicao_pagamento_w,
	cd_cnpj_raiz_w,
	cd_cnpj_emitente_raiz_w,
	cd_natureza_operacao_w,
	cd_tipo_servico_w,
	cd_operacao_nf_w,
	vl_desc_nf_w,
	cd_empresa_w
from	estabelecimento b,
	nota_fiscal a
where	a.cd_estabelecimento	= b.cd_estabelecimento
and	a.nr_sequencia		= nr_sequencia_p;

select	coalesce(max(obter_valor_param_usuario(40, 221, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w)),'N')
into STRICT	ie_trib_pago_prev_w
;

select	coalesce(max(ie_gera_tributo_geral),'N')
into STRICT	ie_gera_trib_geral_w
from	parametro_compras
where	cd_estabelecimento = cd_estabelecimento_w;

if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
	select	max(nr_ccm)
	into STRICT	nr_ccm_w
	from	pessoa_fisica
	where	cd_pessoa_fisica	= cd_pessoa_fisica_w;
end if;

select	ie_forma_pagamento
into STRICT	ie_forma_pagamento_w
from	condicao_pagamento
where	cd_condicao_pagamento = cd_condicao_pagamento_w;

select	coalesce(sum(vl_liquido),0)
into STRICT	vl_liquido_original_w
from	nota_fiscal_item
where	nr_sequencia = nr_sequencia_p;

select	max(coalesce(nr_contrato,0))
into STRICT	nr_contrato_w
from	nota_fiscal_item
where	nr_sequencia = nr_sequencia_p;

-- afstringari 166959 16/10/2009
select	max(ie_tipo_tributacao)
into STRICT	ie_tipo_tributacao_w
from	pessoa_juridica
where	cd_cgc	= cd_cgc_w;

OPEN C01;
LOOP
FETCH C01 into
	ie_ordem_w,
	cd_tributo_w,
	ie_tipo_tributo_w,
	ie_apuracao_piso_w,
	ie_corpo_item_w,
	ie_soma_diminui_w,
	IE_CNPJ_w,
	ie_restringe_estab_w,
	ie_desc_nf_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	-- Edgar, 07/12/2007, OS 71984, recalcular os vencimentos qdo os tributos do corpo da NF forem gerados
	if (ie_corpo_item_ant_w = 'C') and (ie_corpo_item_w = 'V') and (ie_forma_pagamento_w <> 10) then
		CALL gerar_vencimento_nota_fiscal(nr_sequencia_p, nm_usuario_p);
	end if;
	ie_corpo_item_ant_w		:= ie_corpo_item_w;

	open c02;
	loop
	fetch c02 into
		ie_ordem_w,
		cd_estabelecimento_w,
		cd_cgc_w,
		cd_cgc_emitente_w,
		CD_pessoa_fisica_w,
		dt_emissao_w,
		vl_base_venc_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */

		vl_liquido_w				:= vl_liquido_original_w;
		if (ie_desc_nf_w = 'S') then
			vl_liquido_w			:= vl_liquido_w - vl_desc_nf_w;
		end if;

		if (ie_corpo_item_w = 'V') and (ie_forma_pagamento_w <> 10) then	/*conforme vencimentos*/
			vl_liquido_w			:= vl_base_venc_w;
		end if;

		PR_IMPOSTO_W			:= 0;

		select	count(*)
		into STRICT	qt_pago_outros_w
		from	nota_fiscal_trib
		where	nr_sequencia	= nr_sequencia_p
		and	cd_tributo	= cd_tributo_w
		and	ie_pago_prev	= 'P';

		cd_material_regra_w	:= null;
		
		select	count(distinct a.cd_material)
		into STRICT	qt_regra_duplicada_w
		from	estrutura_material_v b,
			nota_fiscal_item a
		where	exists
			(SELECT	1
			from	tributo_conta_pagar x
			where	obter_se_estrutura_mat(x.cd_grupo_material, x.cd_subgrupo_material, x.cd_classe_material, x.cd_material, a.cd_material, 'S') = 'S'
			and	((x.cd_material		= a.cd_material) or (x.cd_grupo_material	= b.cd_grupo_material) or (x.cd_subgrupo_material	= b.cd_subgrupo_material) or (x.cd_classe_material	= b.cd_classe_material))
			and (coalesce(x.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w)
			and	dt_emissao_w between coalesce(dt_inicio_vigencia, dt_emissao_w - 1) and coalesce(dt_fim_vigencia, dt_emissao_w + 1)
			and	x.cd_tributo	= cd_tributo_w
			having	count(*) > 1)
		and	a.cd_material	= b.cd_material
		and	a.nr_sequencia	= nr_sequencia_p;

		if (qt_regra_duplicada_w = 0) then
			select	max(a.cd_material)
			into STRICT	cd_material_regra_w
			from	estrutura_material_v b,
				nota_fiscal_item a
			where	exists
				(SELECT	1
				from	tributo_conta_pagar x
				where	obter_se_estrutura_mat(x.cd_grupo_material, x.cd_subgrupo_material, x.cd_classe_material, x.cd_material, a.cd_material, 'S') = 'S'
				and	((x.cd_material		= a.cd_material) or (x.cd_grupo_material	= b.cd_grupo_material) or (x.cd_subgrupo_material	= b.cd_subgrupo_material) or (x.cd_classe_material	= b.cd_classe_material))
				and (coalesce(x.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w)
				and	dt_emissao_w between coalesce(dt_inicio_vigencia, dt_emissao_w - 1) and coalesce(dt_fim_vigencia, dt_emissao_w + 1)
				and	x.cd_tributo	= cd_tributo_w)
			and	a.cd_material	= b.cd_material
			and	a.nr_sequencia	= nr_sequencia_p;
		end if;

		SELECT * FROM OBTER_DADOS_TRIB_TIT_PAGAR(CD_TRIBUTO_w, CD_ESTABELECIMENTO_w, CD_CGC_w, CD_pessoa_fisica_w, CD_BENEFICIARIO_w, PR_IMPOSTO_W, CD_COND_PAGTO_w, CD_CONTA_FINANC_w, NR_SEQ_TRANS_REG_w, NR_SEQ_TRANS_BAIXA_w, VL_MINIMO_BASE_CALCULO_W, vl_minimo_tributo_w, ie_acumulativo_w, vl_teto_base_w, vl_desc_dependente_w, cd_darf_w, dt_emissao_w, cd_variacao_w, ie_periodicidade_w, null, cd_natureza_operacao_w, cd_tipo_servico_w, cd_material_regra_w, null, null, nr_seq_regra_w, cd_operacao_nf_w, qt_pago_outros_w, nr_seq_classe_w, cd_tipo_baixa_neg_w, vl_liquido_w, 'N', null, null, null, null) INTO STRICT CD_BENEFICIARIO_w, PR_IMPOSTO_W, CD_COND_PAGTO_w, CD_CONTA_FINANC_w, NR_SEQ_TRANS_REG_w, NR_SEQ_TRANS_BAIXA_w, VL_MINIMO_BASE_CALCULO_W, vl_minimo_tributo_w, ie_acumulativo_w, vl_teto_base_w, vl_desc_dependente_w, cd_darf_w, cd_variacao_w, ie_periodicidade_w, nr_seq_regra_w, nr_seq_classe_w, cd_tipo_baixa_neg_w;

		select	max(a.cd_estabelecimento),
			max(a.cd_empresa)
		into STRICT	cd_estab_regra_w,
			cd_empresa_regra_w
		from	tributo_conta_pagar a
		where	a.nr_sequencia	= nr_seq_regra_w;

		vl_tributo_w	:= (vl_liquido_w * PR_IMPOSTO_W) / 100;

		if (pr_imposto_w > 0) then

			select	/*+ USE_CONCAT */ coalesce(sum(VL_SOMA_TRIB_NAO_RETIDO),0),
				coalesce(sum(VL_SOMA_BASE_NAO_RETIDO),0),
				coalesce(sum(VL_SOMA_TRIB_ADIC),0),
				coalesce(sum(VL_SOMA_BASE_ADIC),0),
				coalesce(sum(VL_tributo),0),
				coalesce(sum(VL_TOTAL_BASE),0),
				coalesce(sum(vl_reducao),0)
			into STRICT	vl_soma_trib_nao_retido_w,
				vl_soma_base_nao_retido_w,
				vl_soma_trib_adic_w,
				vl_soma_base_adic_w,
				vl_trib_anterior_w,
				vl_total_base_w,
				vl_reducao_w
			from	VALORES_TRIBUTO_V a
			where	coalesce(a.cd_empresa,coalesce(cd_empresa_w,0)) = coalesce(cd_empresa_w,0)
			and	a.cd_tributo			= cd_tributo_w
			and	trunc(a.dt_tributo, 'month')	= trunc(dt_emissao_w, 'month')
			and	(
				  (
				    ((coalesce(a.cd_cgc_emitente, 'X') = coalesce(cd_cgc_emitente_w, 'X')) and (a.ie_origem_valores = 'NFE')) or
				    (ie_cnpj_w = 'Empresa' AND cd_cnpj_emitente_raiz = cd_cnpj_emitente_raiz_w)
				  ) or
				  (
				    (coalesce(a.cd_cgc_emitente::text, '') = '') and (a.ie_origem_valores <> 'NFE')
				  )
				)
			and	(
				  ((cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and a.cd_pessoa_fisica = cd_pessoa_fisica_w) or
				  (
				    (coalesce(cd_pessoa_fisica_w::text, '') = '') and (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') and (coalesce(a.cd_pessoa_fisica::text, '') = '') and
				    (
				       (a.cd_cgc 		= cd_cgc_w) or
				       (IE_CNPJ_w = 'Empresa' AND a.cd_cnpj_raiz = cd_cnpj_raiz_w)
				    )
				  )
				)
			and (a.ie_origem_valores		= 'NFE' or ie_apuracao_piso_w = 'S')
			and	((ie_restringe_estab_w		= 'N') or (a.cd_estabelecimento		= cd_estabelecimento_w) or (a.cd_estab_financeiro		= cd_estabelecimento_w) or (coalesce(cd_estab_regra_w::text, '') = '' and a.cd_empresa = cd_empresa_regra_w))
			and (ie_apuracao_piso_w		= 'N' or
				ie_apuracao_piso_w		= ie_base_calculo)
			and	ie_baixa_titulo			= 'N';

			ie_irpf_w			:= 'N';

			if (ie_tipo_tributo_w = 'IR') and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then

				select	coalesce(sum(a.vl_tributo),0)
				into STRICT	vl_inss_w
				from	tributo b,
					nota_fiscal_trib a
				where	a.cd_tributo		= b.cd_tributo
				and	a.nr_sequencia		= nr_sequencia_p
				and	b.ie_tipo_tributo		= 'INSS';

				select	coalesce(qt_dependente,0)
				into STRICT	qt_dependente_w
				from	pessoa_fisica
				where	cd_pessoa_fisica	= cd_pessoa_fisica_w;

				ie_irpf_w			:= 'S';
				vl_liquido_w			:= vl_liquido_w - vl_inss_w;

			elsif (ie_tipo_tributo_w = 'ISRDOM') then
				if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
					select	coalesce(qt_dependente,0)
					into STRICT	qt_dependente_w
					from	pessoa_fisica
					where	cd_pessoa_fisica	= cd_pessoa_fisica_w;

					ie_irpf_w			:= 'S';
				end if;
			end if;

			select	coalesce(sum(vl_base_calculo),0),
				coalesce(sum(vl_tributo),0)
			into STRICT	vl_base_calculo_paga_w,
				vl_pago_w
			from	nota_fiscal_trib
			where	nr_sequencia	= nr_sequencia_p
			and	cd_tributo	= cd_tributo_w
			and	ie_pago_prev	= 'P';

			if (coalesce(vl_pago_w,0) > 0) then
				vl_base_calculo_paga_w	:= 0;
			end if;				

			SELECT * FROM obter_valores_tributo(	ie_acumulativo_w, pr_imposto_w, vl_minimo_base_calculo_w, vl_minimo_tributo_w, vl_soma_trib_nao_retido_w, vl_soma_trib_adic_w, vl_soma_base_nao_retido_w, vl_soma_base_adic_w, vl_liquido_w, vl_tributo_w, vl_trib_nao_retido_w, vl_trib_adic_w, vl_base_nao_retido_w, vl_base_adic_w, vl_teto_base_w, vl_trib_anterior_w, ie_irpf_w, vl_total_base_w, vl_reducao_w, vl_desc_dependente_w, qt_dependente_w, vl_base_calculo_paga_w, null, null, obter_outras_reducoes_irpf(cd_pessoa_fisica_w, cd_estabelecimento_w, dt_emissao_w), clock_timestamp(), nr_seq_regra_irpf_w) INTO STRICT pr_imposto_w, vl_liquido_w, vl_tributo_w, vl_trib_nao_retido_w, vl_trib_adic_w, vl_base_nao_retido_w, vl_base_adic_w, vl_reducao_w, vl_desc_dependente_w, nr_seq_regra_irpf_w;

			if (vl_pago_w < vl_tributo_w) then
				vl_tributo_w	:= vl_tributo_w - vl_pago_w;
			end if;

			if (vl_tributo_w > vl_liquido_original_w) then
				vl_tributo_w	:= vl_liquido_original_w;
			end if;

			if (vl_tributo_w < 0) then
				vl_tributo_w	:= 0;
			end if;
						
			if (ie_corpo_item_w = 'V') and (coalesce(qt_regra_duplicada_w,0) = 0) then

				insert	into nota_fiscal_venc_trib(nr_sequencia,
					dt_vencimento,
					cd_tributo,
					vl_tributo,
					dt_atualizacao,
					nm_usuario,
					vl_base_calculo,
					tx_tributo,
					vl_desc_base,
					VL_TRIB_NAO_RETIDO,
					VL_BASE_NAO_RETIDO,
					VL_TRIB_ADIC,
					VL_BASE_ADIC,
					vl_reducao,
					cd_darf,
					ie_origem)
				values (nr_sequencia_p,
					dt_emissao_w,
					cd_tributo_w,
					vl_tributo_w,
					clock_timestamp(),
					nm_usuario_p,
					vl_liquido_w,
					pr_imposto_w,
					vl_desc_dependente_w,
					VL_TRIB_NAO_RETIDO_w,
					VL_BASE_NAO_RETIDO_w,
					VL_TRIB_ADIC_w,
					VL_BASE_ADIC_w,
					vl_reducao_w,
					cd_darf_w,
					'N');
				update	nota_fiscal_venc
				set	vl_vencimento	= vl_vencimento + (CASE WHEN ie_soma_diminui_w='S' THEN  vl_tributo_w WHEN ie_soma_diminui_w='D' THEN  vl_tributo_w * -1  ELSE 0 END )
				where	nr_sequencia	= nr_sequencia_p
				and	dt_vencimento	= dt_emissao_w;
			end if;
		end if;

	end loop;
	close c02;

END LOOP;
CLOSE C01;

-- Edgar 19/02/2007, OS 50572, tratar vencimentos
select	count(*)
into STRICT	cont_w
from	nota_fiscal_venc_trib
where	nr_sequencia	= nr_sequencia_p;

if (cont_w > 0) then

	CALL atualiza_total_nota_fiscal(nr_sequencia_p, nm_usuario_p);

	select	vl_total_nota
	into STRICT	vl_total_nota_w
	from	nota_fiscal
	where	nr_sequencia	= nr_sequencia_p;

	select	coalesce(sum(vl_vencimento),0)
	into STRICT	vl_vencimento_w
	from	nota_fiscal_venc
	where	nr_sequencia	= nr_sequencia_p;

	if (coalesce(vl_vencimento_w,0) <> coalesce(vl_total_nota_w,0)) then

		open c03;
		loop
		fetch c03 into
			dt_vencimento_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
		end loop;
		close c03;

		update	nota_fiscal_venc
		set	vl_vencimento	= vl_vencimento + vl_total_nota_w - vl_vencimento_w
		where	nr_sequencia	= nr_sequencia_p
		and	dt_vencimento	= dt_vencimento_w;

	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_trib_venc_nota ( nr_sequencia_p bigint, cd_tributo_p bigint, nm_usuario_p text, dt_vigencia_p timestamp) FROM PUBLIC;

