-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_reg_ecf_j100 ( nr_seq_controle_p text, ds_separador_p text, cd_estabelecimento_p text, nm_usuario_p text, cd_empresa_p text, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint, ie_scp_p text) AS $body$
DECLARE


				
nr_seq_registro_w	bigint := nr_sequencia_p;	
nr_linha_w		bigint := qt_linha_p;
ds_arquivo_w		varchar(4000);	
ds_arquivo_compl_w	varchar(4000);	
ds_linha_w		varchar(4000);
sep_w			varchar(2) := ds_separador_p;

tp_registro_w		varchar(5);
dt_inicio_apuracao_w	timestamp;
dt_atualizacao_w	timestamp;
cd_centro_custo_w	integer;
ds_centro_custo_w	varchar(80);

c01 CURSOR FOR
SELECT	trunc(dt_inicio_apuracao_w,'year') dt_atualizacao,
	a.cd_centro_custo,
	a.ds_centro_custo
from	estabelecimento b,
	centro_custo a
where	a.cd_estabelecimento		= b.cd_estabelecimento
and    ((ie_scp_p = 'S' AND b.cd_estabelecimento 	= cd_estabelecimento_p)
or (ie_scp_p = 'N')
       and (b.cd_estabelecimento 	in (	SELECT cd_estabelecimento
						from   estabelecimento
						where  coalesce(ie_scp, 'N') = 'N')))
and	b.cd_empresa			= cd_empresa_p;


BEGIN

select  max(dt_inicio_apuracao)
into STRICT	dt_inicio_apuracao_w
from	fis_controle_ecf
where	nr_sequencia 		= nr_seq_controle_p;

open C01;
loop
fetch C01 into	
	dt_atualizacao_w,
	cd_centro_custo_w,
	ds_centro_custo_w;	
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	tp_registro_w		:= 'J100';
	
	ds_linha_w	:= substr(	sep_w || tp_registro_w 				|| -- Registro (1)
					sep_w || to_char(dt_atualizacao_w,'ddmmyyyy') 	|| -- Data da Alterao (Incluso/Alterao) (2)
					sep_w || cd_centro_custo_w 			|| -- Cdigo do Centro de Custos (3)
					sep_w || ds_centro_custo_w 			|| sep_w,1,8000); -- Nome do Centro de Custos (4)
	
	ds_arquivo_w		:= substr(ds_linha_w,1,4000);
	ds_arquivo_compl_w	:= substr(ds_linha_w,4001,4000);
	nr_seq_registro_w	:= nr_seq_registro_w + 1;
	nr_linha_w		:= nr_linha_w + 1;
	
	insert into fis_ecf_arquivo(
		nr_sequencia,
		nm_usuario,
		dt_atualizacao,
		nm_usuario_nrec,
		dt_atualizacao_nrec,
		nr_seq_controle_ecf,
		nr_linha,
		cd_registro,
		ds_arquivo,
		ds_arquivo_compl)
	values (	nr_seq_registro_w,
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nr_seq_controle_p,
		nr_linha_w,
		tp_registro_w,
		ds_arquivo_w,
		ds_arquivo_compl_w);
	
	end;
end loop;
close C01;

commit;

qt_linha_p	:= nr_linha_w;
nr_sequencia_p	:= nr_seq_registro_w;

SELECT * FROM fis_reg_ecf_J990(nr_seq_controle_p, ds_separador_p, cd_estabelecimento_p, nm_usuario_p, cd_empresa_p, qt_linha_p, nr_sequencia_p) INTO STRICT qt_linha_p, nr_sequencia_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_reg_ecf_j100 ( nr_seq_controle_p text, ds_separador_p text, cd_estabelecimento_p text, nm_usuario_p text, cd_empresa_p text, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint, ie_scp_p text) FROM PUBLIC;

