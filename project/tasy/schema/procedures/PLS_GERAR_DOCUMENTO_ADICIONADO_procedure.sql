-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_documento_adicionado ( nr_seq_contrato_p bigint, nr_seq_instrumento_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_instrumento_w	varchar(255);
nr_seq_documento_w	bigint;
nr_seq_plano_instr_w	bigint;
cd_classificacao_w	varchar(20);
nm_dispositivo_w	varchar(255);
ds_tema_w		text;
ie_gerar_titulo_w	varchar(1);
ie_quebra_pagina_w	varchar(1);
nr_seq_doc_texto_w	bigint;
nr_seq_tipo_tema_w	pls_contrato_doc_texto.nr_seq_tipo_tema%type;

C01 CURSOR FOR
	SELECT	nr_sequencia,
		cd_classificacao,
		nm_dispositivo,
		ie_gerar_titulo,
		ie_quebra_pagina,
		nr_seq_tipo_tema
	from	pls_plano_instrumento
	where	nr_seq_instrumento	= nr_seq_instrumento_p
	and	coalesce(ie_adicionar_termo, 'N') = 'S'
	and	coalesce(ie_permite_inclusao_termo, 'S') = 'S';


BEGIN

select	ds_instrumento
into STRICT	ds_instrumento_w
from	pls_instrumento
where	nr_sequencia	= nr_seq_instrumento_p;

delete	from pls_contrato_doc_texto
where	nr_seq_documento in (	SELECT	nr_sequencia
				from	pls_contrato_documento
				where	nr_seq_contrato = nr_seq_contrato_p);

delete	from pls_contrato_documento
where	nr_seq_contrato = nr_seq_contrato_p;

select	nextval('pls_contrato_documento_seq')
into STRICT	nr_seq_documento_w
;

insert into pls_contrato_documento(	nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		nr_seq_contrato,
		nr_seq_instrumento,
		ds_documento,
		dt_atualizacao_nrec,
		nm_usuario_nrec)
values (		nr_seq_documento_w,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_contrato_p,
		nr_seq_instrumento_p,
		ds_instrumento_w,
		clock_timestamp(),
		nm_usuario_p);

open C01;
loop
fetch C01 into
	nr_seq_plano_instr_w,
	cd_classificacao_w,
	nm_dispositivo_w,
	ie_gerar_titulo_w,
	ie_quebra_pagina_w,
	nr_seq_tipo_tema_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	select	nextval('pls_contrato_doc_texto_seq')
	into STRICT	nr_seq_doc_texto_w
	;
	
	insert into pls_contrato_doc_texto(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
			nr_seq_documento,cd_classificacao,ds_dispositivo,ds_tema,ie_converte_macro,
			ie_imprimir_titulo,ie_quebra_pagina, nr_seq_tipo_tema)
	values (	nr_seq_doc_texto_w,clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
			nr_seq_documento_w,cd_classificacao_w,nm_dispositivo_w,ds_tema_w,'N',
			ie_gerar_titulo_w,ie_quebra_pagina_w, nr_seq_tipo_tema_w);
			
	CALL COPIA_CAMPO_LONG_DE_PARA('PLS_PLANO_INSTRUMENTO','DS_TEMA','where nr_sequencia = :nr_sequencia','nr_sequencia='||nr_seq_plano_instr_w,
				'PLS_CONTRATO_DOC_TEXTO','DS_TEMA','where nr_sequencia = :nr_sequencia','nr_sequencia='||nr_seq_doc_texto_w);
	
	CALL pls_gerar_texto_macro(nr_seq_doc_texto_w, ds_tema_w, nr_seq_contrato_p, nm_usuario_p, 'C');
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_documento_adicionado ( nr_seq_contrato_p bigint, nr_seq_instrumento_p bigint, nm_usuario_p text) FROM PUBLIC;

