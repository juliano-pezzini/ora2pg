-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ret_conv_ratear_item_imp (nr_seq_movto_p bigint, nr_interno_conta_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_retorno_w	bigint;
cd_item_w		bigint;
dt_execucao_w		timestamp;
vl_pago_w		double precision;
vl_glosa_w		double precision;
nr_seq_mat_paci_w	bigint;
cd_material_w		integer;
vl_material_w		double precision;
vl_mat_conta_total_w	double precision;
vl_pago_item_w		double precision;
vl_glosado_item_w	double precision;
vl_pago_total_w		double precision;
vl_glosado_total_w	double precision;
nr_seq_movto_w		bigint;
qt_itens_conta_w	bigint;

c01 CURSOR FOR
SELECT	nr_sequencia,
	cd_material,
	vl_material
from	material_atend_paciente
where	nr_interno_conta	= nr_interno_conta_p
and	cd_material_convenio	= cd_item_w
and	trunc(dt_atendimento)	= dt_execucao_w
and	coalesce(cd_motivo_exc_conta::text, '') = ''
order by nr_sequencia;


BEGIN

if (nr_interno_conta_p IS NOT NULL AND nr_interno_conta_p::text <> '') then

	select	nr_seq_retorno,
		cd_item,
		dt_execucao,
		vl_pago,
		vl_glosa
	into STRICT	nr_seq_retorno_w,
		cd_item_w,
		dt_execucao_w,
		vl_pago_w,
		vl_glosa_w
	from	convenio_retorno_movto
	where	nr_sequencia	= nr_seq_movto_p;

	select	count(*)
	into STRICT	qt_itens_conta_w
	from	material_atend_paciente
	where	nr_interno_conta	= nr_interno_conta_p
	and	cd_material_convenio	= cd_item_w
	and	trunc(dt_atendimento)	= dt_execucao_w
	and	coalesce(cd_motivo_exc_conta::text, '') = '';

	select	sum(vl_material)
	into STRICT	vl_mat_conta_total_w
	from	material_atend_paciente
	where	nr_interno_conta	= nr_interno_conta_p
	and	cd_material_convenio	= cd_item_w
	and	trunc(dt_atendimento)	= dt_execucao_w
	and	coalesce(cd_motivo_exc_conta::text, '') = '';

	if (qt_itens_conta_w > 1) and --Se tem mais de 1 tem que ratear
		(vl_mat_conta_total_w > 0) then

		vl_pago_total_w		:= 0;
		vl_glosado_total_w	:= 0;

		open C01;
		loop
		fetch C01 into
			nr_seq_mat_paci_w,
			cd_material_w,
			vl_material_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			vl_pago_item_w		:= dividir_sem_round(vl_material_w,vl_mat_conta_total_w) * vl_pago_w;
			vl_glosado_item_w	:= dividir_sem_round(vl_material_w,vl_mat_conta_total_w) * vl_glosa_w;

			select	nextval('convenio_retorno_movto_seq')
			into STRICT	nr_seq_movto_w
			;

			insert into convenio_retorno_movto(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nr_seq_retorno,
				nr_doc_convenio,
				cd_usuario_convenio,
				cd_item,
				vl_total_pago,
				vl_glosa,
				ds_complemento,
				vl_pago,
				vl_cobrado,
				nr_conta,
				ie_gera_resumo,
				dt_execucao,
				nr_seq_item_conta)
			SELECT	nr_seq_movto_w,
				clock_timestamp(),
				'Tasy_Imp',
				nr_seq_retorno_w,
				nr_doc_convenio,
				cd_usuario_convenio,
				cd_item_w,
				vl_pago_item_w,
				vl_glosado_item_w,
				'RT #'||ds_complemento,
				vl_pago_item_w,
				vl_material_w,
				nr_conta,
				ie_gera_resumo,
				dt_execucao,
				nr_seq_mat_paci_w
			from	convenio_retorno_movto
			where	nr_sequencia	= nr_seq_movto_p;


			vl_pago_total_w		:= vl_pago_total_w + vl_pago_item_w;
			vl_glosado_total_w	:= vl_glosado_total_w + vl_glosado_item_w;
			end;
		end loop;
		close C01;

		update	convenio_retorno_movto
		set	ie_gera_resumo	= 'N'
		where	nr_sequencia	= nr_seq_movto_p;

	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ret_conv_ratear_item_imp (nr_seq_movto_p bigint, nr_interno_conta_p bigint, nm_usuario_p text) FROM PUBLIC;

