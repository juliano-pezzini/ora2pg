-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_regra_prescr_proced ( nr_prescricao_p bigint, nr_seq_proced_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text) AS $body$
DECLARE



qt_pecas_proc_w		bigint;
qt_frascos_env_w		bigint;
nr_seq_anatomia_w	bigint;

/* parametros */

qt_hora_proced_duplic_w		bigint := 0;
ie_consistir_proced_duplic_w	varchar(15);
ie_consistir_patol_cli_lab_w	varchar(15);
ie_perm_lib_sem_setor_exec_w	varchar(15);
ie_consistir_proced_indic_w	varchar(15);

ie_lib_proc_result_exame_w 	varchar(1) := 'S';
ds_inf_just_exam_w		varchar(4000);

/* parametros medicos */

ie_consistir_glosa_convenio_w	varchar(15);
ie_consistir_setor_proced_w	varchar(1);

/* globais */

nr_seq_erro_w			bigint;
cd_cgc_solic_w			varchar(14);
qt_erro_param_w			bigint;
nr_horas_sus_w			smallint;
nr_seq_proced_w			bigint;
VarConsisteHemo_w		varchar(1);
ie_quantidade_w			varchar(1);
ie_just_hemot_w			varchar(1);
cont_w2				bigint;
nr_seq_condicao_w		bigint;
cd_medico_exec_w		PRESCR_PROCEDIMENTO.CD_MEDICO_EXEC%type;
cd_medico_w			varchar(20);
ie_consiste_urgencia_w		varchar(2);
varParam984_w			varchar(2);
ds_stack_w			varchar(2000);
ie_topografia_w			varchar(2);
ie_consiste_justif_w		varchar(2);
ie_exige_condicao_w		varchar(2);
ie_permite_proc_dupl_w		varchar(2);
ie_reserva_w			varchar(2);
ie_obriga_tipo_w		varchar(2);
ie_obriga_coagulopatia_w	varchar(2);
VarIeConsisteReservado_w	varchar(1);
ie_forma_exame_w		varchar(50);
ds_coagulopatia_w		varchar(255);
ie_consiste_programado_w	varchar(2);
ie_consiste_qt_dt_dose_w	varchar(2);
ie_sexo_paciente_w		varchar(12);
ie_sexo_sus_w			varchar(12);
ie_consiste_mesma_prescr_w	varchar(2);
ie_erro_liberar_prescr_w	varchar(1);
cd_exame_w			varchar(20);
ie_consistir_regra_uso_w	varchar(15);
qt_albumina_w			double precision;
qt_calcio_w			double precision;
qt_magnesio_w			double precision;
nr_seq_topografia_w		bigint;
ie_sexo_w			varchar(1);
qt_idade_w			bigint;
qt_bilirrubina_dir_w		double precision;
qt_bilirrubina_ind_w		double precision;
qt_hemoglobina_s_w		double precision;
ie_coombs_direto_w		varchar(15);
ie_consiste_fpo_w		varchar(5);
ie_fibrinogenio_w		varchar(10);
ie_setor_exec_Exame_w		varchar(10);
ds_material_especial_w		varchar(255);
ds_inconsist_prescr_w		varchar(255);
ie_erro_regra_uso_w		varchar(2000);
ds_consistencia_hemo_w		varchar(2000);
ie_justif_hemo_w		varchar(1);
ie_filtrado_w			varchar(1);
ie_irradiado_w			varchar(1);
ie_lavado_w			varchar(1);
ds_justificativa_w		varchar(4000);
ds_retorno_fpo_w		varchar(255);
cd_prescritor_w			varchar(255);
dt_suspensao_w			timestamp;
dt_validade_prescr_w		timestamp;
dt_entrada_w			timestamp;
qt_erro_nao_lib_w		bigint;
qt_erro_lib_w			bigint;
ds_horarios_inconsistentes_w	varchar(2000);
ie_erro_liberar_prescr_68_w	varchar(1);
ie_erro_liberar_prescr_69_w	varchar(1);
ie_erro_liberar_prescr_70_w	varchar(1);
ie_erro_liberar_prescr_199_w regra_consiste_prescr_par.ie_forma_consistencia%type;
ie_anatomia_patologica_w varchar(1);

/* regras */

ie_proced_duplic_w		varchar(1);
ds_prescr_duplic_w		varchar(2000);
ie_dose_assoc_lib_w		varchar(1);
ie_regra_indic_clinica_obrig_w	varchar(1);
ie_peso_altura_rep_w		varchar(1);
ie_erro_interv_solic_exame_w	varchar(255);
ds_observacao_w			varchar(2000);
ie_impede_lib_solic_exame_w	varchar(1);
ie_prot_glic_nivel_w		varchar(1);
ie_proced_externo_w		varchar(15);
ds_proced_regra_w		varchar(255);
ds_proced_w			varchar(255);
ie_permite_agora_w		varchar(1);
dt_procedimento_w		timestamp;
cd_senha_w			varchar(20);
qt_horas_w			double precision;
qt_minutos_w			smallint;
ie_exige_anestesia_w		varchar(3);
ie_consistir_proc_duplic_w	varchar(1);
/* rep */

nr_atendimento_w		bigint;
dt_prescricao_w			timestamp;
dt_inicio_prescr_w		timestamp;
cd_estab_prescr_w		smallint;
qt_peso_w			real;
qt_altura_cm_w			real;
dt_prescricao_mi_w		timestamp;
ie_origem_inf_w			varchar(1);
ds_mensagem_regra_w		varchar(255);
ds_mensagem_data_w		varchar(255);
nr_hora_validade_w		double precision;
cd_funcao_origem_w		prescr_medica.cd_funcao_origem%type;

/* procedimento */

cd_procedimento_w		bigint;
cd_procedimento_ww		bigint;
cd_proced_regra_w		bigint;
ie_origem_proced_w		bigint;
cd_material_exame_w		varchar(20);
dt_prev_execucao_w		timestamp;
ie_proced_lado_w		varchar(15);
ie_lado_w			varchar(15);
ie_situacao_proced_w		varchar(1);
nr_seq_exame_w			bigint;
cd_especialidade_proced_w	bigint;
cd_setor_proced_w		integer;
ie_classificacao_w		varchar(1);
qt_procedimento_w		double precision;
nr_seq_proc_interno_w		bigint;
ds_dado_clinico_w		varchar(2000);
ds_resumo_clinico_w		varchar(2000);
nr_seq_grupo_exame_w		bigint;
cd_area_procedimento_w		bigint;
cd_grupo_procedimento_w		bigint;
nr_seq_subgrupo_w		bigint;
dt_prev_execucao_mi_w		timestamp;
nr_seq_prot_glic_w		bigint;
ie_setor_exec_proced_w		varchar(1);
ie_proced_agora_w		varchar(1);
cd_setor_atendimento_w		integer;
ie_consiste_medic_proc_w 	varchar(1);
ie_consiste_prescr_proc_w 	varchar(1);
ie_consiste_exame_dia_w		varchar(1);
ds_medic_proc_w			varchar(2000);
ds_horarios_w			varchar(2000);
dt_ult_dose_medic_w		timestamp;
qt_ult_dose_medic_w		double precision;
ie_anestesia_w			varchar(3);
ie_pergunta_tecnica_obrig_w 	varchar(1);
ds_mensagem_w			varchar(255);

/* gerais */

cd_convenio_w			integer;
cd_categoria_w			varchar(10);
cd_tipo_acomodacao_w		smallint;
ie_tipo_atendimento_w		smallint;
cd_plano_convenio_w		varchar(10);
tx_ajuste_w			double precision;
tx_ajuste_custo_oper_w		double precision;
tx_ajuste_medico_w		double precision;
tx_ajuste_partic_w		double precision;
tx_ajuste_filme_w		double precision;
vl_negociado_w			double precision;
ie_preco_informado_w		varchar(1);
ie_glosa_w			varchar(1);
cd_procedimento_esp_w		bigint;
nr_seq_regra_preco_w		bigint;
cd_edicao_ajuste_w		integer;
vl_medico_w			double precision;
vl_custo_operacional_w		double precision;
qt_filme_w			double precision;
nr_auxiliares_w			smallint;
qt_porte_anestesico_w		smallint;
pr_glosa_w			double precision;
vl_glosa_w			double precision;
cd_motivo_exc_conta_w		bigint;
ie_autor_particular_w		varchar(1);
cd_convenio_glosa_w		integer;
cd_categoria_glosa_w		varchar(10);
nr_seq_regra_ajuste_w		bigint;
ie_proc_edicao_w		varchar(1) := 'S';
ie_pacote_convenio_w		varchar(1);
ie_erro_autorizacao_w		varchar(255);
ie_regra_plano_w		smallint;
nr_seq_regra_plano_w		bigint := null;
qt_proc_edicao_w		bigint;
qt_prescr_proc_w		bigint;
cd_intervalo_w			varchar(7);
cd_pessoa_fisica_w		varchar(10);
cd_convenio_particular_w 	integer := null;
cd_categoria_particular_w 	varchar(10) := null;
ie_glosa_zerado_w		varchar(10);
cd_estabelecimento_w		smallint;
cd_setor_prescricao_w		integer;
ie_consiste_proc_duplic_w 	varchar(1);
ie_obriga_just_w		varchar(5);
HR_PREV_W			varchar(5);
cd_tipo_procedimento_w		bigint;
cont_w				bigint;
cd_tipo_convenio_w		smallint;
ie_clinica_w			integer;
qt_exame_obriga_dose_w		bigint;
nr_seq_origem_w			convenio_origem_usuario.nr_sequencia%type;
ie_setor_ativo_w		varchar(1);
ie_exige_justif_sexo_w			proc_interno.ie_exige_justif_sexo%type;
ie_aprenta_exame_sexo_w		proc_interno.ie_aprenta_exame_sexo%type;

/* Hemoderivados */

nr_seq_derivado_w		bigint;
nr_seq_outras_w			varchar(10);
nr_seq_solic_sangue_w		bigint;
ie_tipo_proced_w		varchar(15);
ie_hemoglobina_w		varchar(1);
ie_hematocrito_w		varchar(1);
ie_consiste_ambos_w		varchar(1);
ie_plaquetas_w			varchar(1);
ie_tap_w			varchar(1);
ie_inr_w			varchar(1);
ie_obriga_albumina_w		varchar(1);
ie_obriga_calcio_w		varchar(1);
ie_obriga_magnesio_w		varchar(1);
ie_obriga_bili_dir_w		varchar(1);
ie_obriga_bili_ind_w		varchar(1);
ie_obriga_hemoglobina_s_w 	varchar(1);
ie_obriga_coombs_w		varchar(1);
qt_plaqueta_w			bigint;
qt_hemoglobina_w		double precision;
qt_fibrinogenio_w		double precision;
qt_tap_w			double precision;
qt_ttpa_w			double precision;
qt_ttpa_rel_w			double precision;
qt_tap_inr_w			double precision;
qt_hematocrito_w		double precision;
ie_tipo_w			bigint;
ie_consiste_extrema_w		varchar(2);
ie_se_necessario_w		varchar(1);
ie_acm_w			varchar(1);
ds_hor_aux_w			varchar(2000);
x				bigint;
ie_autorizacao_w		varchar(10);
ds_aux_w			varchar(255);
ds_complemento_71_w		varchar(2000);
qt_minimo_caracter_w		bigint;
ie_obriga_indicacao_w		varchar(1);
ie_exige_responsavel_w		varchar(10);
cd_pessoa_responsavel_w		varchar(10);
vl_filme_w			double precision;
ie_tipo_protocolo_w		varchar(1);
nr_seq_contraste_w		varchar(10);
ie_util_hemocomponente_w 	varchar(15);
ie_consiste_hemo_confirmada_w 	varchar(1);
nr_seq_cobertura_w		bigint;
nr_seq_classif_atend_w		bigint := 0;
cd_setor_regra_w		bigint;
cd_medico_resp_w		varchar(10);
ie_carater_inter_sus_w		varchar(2);
qt_autor_ageint_exame_lab_w	bigint := 0;
nr_seq_ageint_exame_lab_w	bigint;
ie_consiste_generico_w		varchar(1);
ie_operacao_w			varchar(1);
ie_exige_menstruacao_w		varchar(1);
dt_ultima_menstruacao_w		timestamp;
dt_ult_menstruacao_w		timestamp;
dt_ultima_data_w		timestamp;
cd_protocolo_w			bigint;
nr_seq_protocolo_w		integer;
cd_protocolo_item_w		bigint;
ie_tipo_sangue_compativel_w varchar(200);
ds_complemento_erro_w varchar(200);
ie_justificado_w		varchar(1) := 'S';
cd_pessoa_atend_w		varchar(10);
cd_procedencia_w		integer;
ie_invasivo_w			varchar(1);
ie_glosa_plano_w		regra_ajuste_proc.ie_glosa%type;
nr_seq_regra_preco_plano_w	regra_ajuste_proc.nr_sequencia%type;
nr_seq_classif_medico_w		atendimento_paciente.nr_seq_classif_medico%type;


c00 REFCURSOR;

c01 CURSOR FOR
SELECT	substr(Obter_Regra_obrig_proc(nr_sequencia, ie_tipo_atendimento_w, cd_material_exame_w),1,1),
		coalesce(qt_minimo_caracter,0),
		coalesce(cd_setor_prescricao,999999)
from	regra_indic_clinica_obrig
where	/*(((coalesce(qt_minimo_caracter,0) = 0) and (ds_justificativa_w is null)) or
		 (coalesce(length(ds_justificativa_w),0) < qt_minimo_caracter))
and*/
		coalesce(nr_seq_exame_lab,nr_seq_exame_w,0)		= coalesce(nr_seq_exame_w,0)
and		coalesce(nr_seq_grupo_lab,nr_seq_grupo_exame_w,0)	= coalesce(nr_seq_grupo_exame_w,0)
and		coalesce(nr_seq_exame_interno,nr_seq_proc_interno_w,0)	= coalesce(nr_seq_proc_interno_w,0)
and		coalesce(cd_area_procedimento,cd_area_procedimento_w,0)	= coalesce(cd_area_procedimento_w,0)
and		coalesce(cd_especialidade,cd_especialidade_proced_w,0)	= coalesce(cd_especialidade_proced_w,0)
and		coalesce(cd_grupo_proc,cd_grupo_procedimento_w,0)	= coalesce(cd_grupo_procedimento_w,0)
and		coalesce(cd_procedimento,cd_procedimento_w,0)		= coalesce(cd_procedimento_w,0)
and		coalesce(ie_origem_proced,ie_origem_proced_w,0)		= coalesce(ie_origem_proced_w,0)
and		coalesce(cd_perfil,cd_perfil_p,0)			= coalesce(cd_perfil_p,0)
and		coalesce(cd_setor_prescricao,cd_setor_prescricao_w,0)	= coalesce( cd_setor_prescricao_w,0)
and		coalesce(ie_tipo_convenio, cd_tipo_convenio_w,0)	= coalesce(cd_tipo_convenio_w,0)
and		coalesce(cd_tipo_procedimento, cd_tipo_procedimento_w,0) = coalesce(cd_tipo_procedimento_w,0)
and		((coalesce(ie_autorizacao,'N') = 'N') or (ie_regra_plano_w = 5))
and		coalesce(nr_seq_subgrupo,nr_seq_subgrupo_w)			= nr_seq_subgrupo_w
and		coalesce(cd_convenio, cd_convenio_w)				= cd_convenio_w
and		coalesce(ie_campo_obriga,'0') = '6'
and		cd_estabelecimento					= cd_estab_prescr_w
order by coalesce(cd_setor_prescricao,999999) desc;


BEGIN

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then

	select	a.nr_atendimento,
			a.cd_estabelecimento,
			a.dt_prescricao,
			a.qt_peso,
			a.qt_altura_cm,
			trunc(a.dt_prescricao,'mi'),
			a.cd_pessoa_fisica,
			a.cd_setor_atendimento,
			a.ie_origem_inf,
			a.cd_prescritor,
			a.dt_validade_prescr,
			a.cd_medico,
			a.cd_cgc_solic,
			a.ds_dado_clinico,
			a.cd_senha,
			obter_sexo_pf(a.cd_pessoa_fisica,'C'),
			obter_idade_pf(a.cd_pessoa_fisica,clock_timestamp(),'A'),
			coalesce((obter_dados_categ_conv(nr_atendimento,'OC'))::numeric ,0),
			a.dt_inicio_prescr,
			coalesce(nr_horas_validade,24),
			a.cd_protocolo,
			a.nr_seq_protocolo,
			a.cd_funcao_origem
	into STRICT	nr_atendimento_w,
			cd_estab_prescr_w,
			dt_prescricao_w,
			qt_peso_w,
			qt_altura_cm_w,
			dt_prescricao_mi_w,
			cd_pessoa_fisica_w,
			cd_setor_prescricao_w,
			ie_origem_inf_w,
			cd_prescritor_w,
			dt_validade_prescr_w,
			cd_medico_w,
			cd_cgc_solic_w,
			ds_dado_clinico_w,
			cd_senha_w,
			ie_sexo_w,
			qt_idade_w,
			nr_seq_origem_w,
			dt_inicio_prescr_w,
			nr_hora_validade_w,
			cd_protocolo_w,
			nr_seq_protocolo_w,
			cd_funcao_origem_w
	from	prescr_medica a
	where	a.nr_prescricao		= nr_prescricao_p;

	if (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') then
		cd_estabelecimento_w := cd_estabelecimento_p;
	else
		cd_estabelecimento_w := cd_estab_prescr_w;
	end if;

	if (nr_atendimento_w > 0) then
		cd_categoria_w		:= substr(obter_categoria_atendimento(nr_atendimento_w),1,10);
		cd_tipo_acomodacao_w	:= substr(obter_tipo_acomod_atend(nr_atendimento_w,'C'),1,4);
		ie_tipo_atendimento_w	:= obter_tipo_atendimento(nr_atendimento_w);
		cd_plano_convenio_w	:= substr(obter_dados_categ_conv(nr_atendimento_w,'P'),1,10);
		cd_convenio_w		:= obter_convenio_atendimento(nr_atendimento_w);
		cd_tipo_convenio_w	:= Obter_Tipo_Convenio(cd_convenio_w);
		cd_procedencia_w	:= coalesce(Obter_Procedencia_atend(nr_atendimento_w,'C'),0);

		select	coalesce(max(nr_seq_classificacao),0),
				max(ie_clinica),
				max(cd_pessoa_responsavel),
				max(dt_entrada),
				max(cd_medico_resp),
				max(ie_carater_inter_sus),
				max(cd_pessoa_fisica),
				max(nr_seq_classif_medico)
		into STRICT	nr_seq_classif_atend_w,
				ie_clinica_w,
				cd_pessoa_responsavel_w,
				dt_entrada_w,
				cd_medico_resp_w,
				ie_carater_inter_sus_w,
				cd_pessoa_atend_w,
				nr_seq_classif_medico_w
		from	atendimento_paciente
		where	nr_atendimento = nr_atendimento_w;
	end if;

	select	coalesce(max(b.ie_pergunta_tecnica_obrig),'N')
	into STRICT	ie_pergunta_tecnica_obrig_w
	from 	lab_parametro b
	where	b.cd_estabelecimento	= cd_estab_prescr_w;

	CALL Wheb_assist_pck.set_informacoes_usuario( cd_estabelecimento_w, cd_perfil_p, nm_usuario_p);
	ie_consistir_proced_duplic_w 	:= Wheb_assist_pck.obterParametroFuncao(924,228);
	ie_perm_lib_sem_setor_exec_w	:= Wheb_assist_pck.obterParametroFuncao(924,191);
	ie_consistir_proced_indic_w		:= Wheb_assist_pck.obterParametroFuncao(924,102);
	ie_obriga_just_w				:= Wheb_assist_pck.obterParametroFuncao(924,426);
	ie_consiste_extrema_w			:= Wheb_assist_pck.obterParametroFuncao(924,343);
	VarConsisteHemo_w				:= Wheb_assist_pck.obterParametroFuncao(924,574);
	ie_consiste_fpo_w				:= Wheb_assist_pck.obterParametroFuncao(924,595);
	ie_consiste_urgencia_w			:= Wheb_assist_pck.obterParametroFuncao(924,632);
	ie_consiste_mesma_prescr_w		:= Wheb_assist_pck.obterParametroFuncao(924,653);
	ie_consiste_justif_w			:= Wheb_assist_pck.obterParametroFuncao(924,716);
	ie_consiste_qt_dt_dose_w		:= Wheb_assist_pck.obterParametroFuncao(924,770);
	ie_consiste_programado_w		:= Wheb_assist_pck.obterParametroFuncao(924,942);
	ie_consiste_hemo_confirmada_w	:= Wheb_assist_pck.obterParametroFuncao(924,952);
	varParam984_w					:= Wheb_assist_pck.obterParametroFuncao(924,984);
	VarIeConsisteReservado_w		:= Wheb_assist_pck.obterParametroFuncao(924,1111);
	qt_hora_proced_duplic_w			:= Wheb_assist_pck.obterParametroFuncao(924,261);
	ie_consistir_patol_cli_lab_w	:= Wheb_assist_pck.obterParametroFuncao(924,201);

	select	coalesce(max(ie_consiste_glosa_conv),'N'),
			coalesce(max(ie_consiste_setor_proc),'N'),
			coalesce(max(ie_consiste_regra_uso_conv),'N'),
			max(nr_horas_sus),
			coalesce(max(ie_just_hemot),'N')
	into STRICT	ie_consistir_glosa_convenio_w,
			ie_consistir_setor_proced_w,
			ie_consistir_regra_uso_w,
			nr_horas_sus_w,
			ie_just_hemot_w
	from	parametro_medico
	where	cd_estabelecimento	= cd_estabelecimento_w;

	if (nr_seq_proced_p = 0) then
		delete
		from	prescr_medica_erro
		where	nr_prescricao	= nr_prescricao_p
		and	(nr_seq_proced IS NOT NULL AND nr_seq_proced::text <> '')
		and	((coalesce(ie_tipo::text, '') = '') or (ie_tipo = 'I'));

	delete
		from	prescr_medica_erro_just
		where	nr_prescricao	= nr_prescricao_p
		and	(nr_seq_proced IS NOT NULL AND nr_seq_proced::text <> '')
		and	((coalesce(ie_tipo::text, '') = '') or (ie_tipo = 'I'));

		update	prescr_procedimento
		set		ie_erro			= 0,
				nr_seq_cor_erro 	= 0,
				ds_cor_erro		 = NULL
		where	nr_prescricao		= nr_prescricao_p;

		open c00 for
		SELECT	b.cd_procedimento,
			b.ie_origem_proced,
			b.cd_material_exame,
			b.dt_prev_execucao,
			coalesce(substr(obter_se_proc_exige_lado(b.nr_seq_proc_interno,b.cd_procedimento,b.ie_origem_proced),1,15),'N'),
			b.ie_lado,
			obter_situacao_proced_prescr(b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno),
			b.nr_seq_exame,
			obter_especialidade_proced(b.cd_procedimento,b.ie_origem_proced),
			b.cd_setor_atendimento,
			coalesce(c.ie_classificacao,'1'),
			b.nr_seq_proc_interno,
			coalesce(b.ds_dado_clinico,ds_dado_clinico_w),
			b.ds_resumo_clinico,
			obter_grupo_exame_lab(b.nr_seq_exame),
			c.cd_area_procedimento,
			c.cd_grupo_proc,
			coalesce(substr(sus_obter_seq_estrut_proc(sus_obter_estrut_proc(b.cd_procedimento,b.ie_origem_proced,'C','S'),'S'),1,10),0),
			trunc(b.dt_prev_execucao,'mi'),
			b.nr_seq_prot_glic,
			obter_se_setor_exec(b.cd_setor_atendimento,cd_estab_prescr_w,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno),
			b.ie_urgencia,
			b.cd_intervalo,
			b.cd_setor_atendimento,
			c.cd_tipo_procedimento,
			ds_material_especial,
			b.ds_observacao,
			b.qt_procedimento,
			b.dt_suspensao,
			b.ds_horarios,
			b.nr_seq_derivado,
			b.nr_seq_solic_sangue,
			b.ie_se_necessario,
			b.ie_acm,
			coalesce(b.cd_senha,cd_senha_w),
			CASE WHEN cd_funcao_origem_w=2314 THEN  Obter_se_hemoc_exige_justif(null, b.nr_seq_derivado, b.ie_irradiado, b.ie_lavado, b.ie_filtrado, null, null)  ELSE PERFORM Obter_se_obriga_just_hemo(b.ie_aliquotado, b.ie_filtrado, b.ie_irradiado, b.ie_lavado, b.nr_seq_derivado) END ,
			b.ds_justificativa,
			obter_se_setor_exec_lab(b.cd_setor_atendimento, cd_estab_prescr_w, b.cd_procedimento, b.ie_origem_proced, b.nr_seq_exame),
			b.ie_filtrado,
			b.ie_irradiado,
			b.ie_lavado,
			b.dt_ult_dose_medic,
			b.qt_ult_dose_medic,
			b.nr_seq_condicao,
			to_char(b.dt_prev_execucao,'hh24:mi'),
			b.nr_seq_contraste,
			b.ie_util_hemocomponente,
			b.ie_anestesia,
			b.nr_sequencia,
			b.ie_forma_exame,
			b.nr_seq_topografia,
			b.nr_seq_ageint_exame_lab,
			b.cd_medico_exec,
			b.ie_tipo_proced,
			b.cd_protocolo,
			case when obter_tipo_proc_interno(b.nr_seq_proc_interno) in ('AP', 'APH', 'APC') then 'S' else 'N' end
		from	Estrutura_Procedimento_v c,
			prescr_procedimento b,
			prescr_medica a
		where	a.nr_prescricao		= b.nr_prescricao
		and	b.cd_procedimento	= c.cd_procedimento
		and	b.ie_origem_proced	= c.ie_origem_proced
		and	a.nr_prescricao		= nr_prescricao_p
		and	b.nr_prescricao		= nr_prescricao_p
		and	coalesce(b.dt_suspensao::text, '') = ''
		and	(((obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'O') = 'S' or
			  Obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'AP') = 'S' or
			  Obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'APH') = 'S' or
			  Obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'APC') = 'S') and VarConsisteHemo_w <> 'S') or
			 ((VarConsisteHemo_w = 'S') and (Obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'O') = 'S' or (Obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'BSHE') = 'S') or
			  Obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'AP') = 'S' or
			  Obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'APH') = 'S' or
			  Obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'APC') = 'S')  ) or
			(((Obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'BS')= 'S' ) or (Obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'AT')= 'S')) and (exists ( SELECT 1
				    from  san_derivado d
						WHERE d.nr_sequencia = b.nr_seq_derivado
						AND   d.ie_proced_hemoterapico = 'S'
						and   b.ie_tipo_proced in ('BS','AT')))));

	else
		delete
		from	prescr_medica_erro
		where	nr_prescricao	= nr_prescricao_p
		and	nr_seq_proced	= nr_seq_proced_p
		and	((coalesce(ie_tipo::text, '') = '') or (ie_tipo = 'I'));

	delete
		from	prescr_medica_erro_just
		where	nr_prescricao	= nr_prescricao_p
		and	nr_seq_proced	= nr_seq_proced_p
		and	((coalesce(ie_tipo::text, '') = '') or (ie_tipo = 'I'));

		update	prescr_procedimento
		set	ie_erro			= 0,
			nr_seq_cor_erro 	= 0,
			ds_cor_erro		 = NULL
		where	nr_prescricao		= nr_prescricao_p
		and	nr_sequencia		= nr_seq_proced_p;



		open c00 for
		SELECT	b.cd_procedimento,
			b.ie_origem_proced,
			b.cd_material_exame,
			b.dt_prev_execucao,
			coalesce(substr(obter_se_proc_exige_lado(b.nr_seq_proc_interno,b.cd_procedimento,b.ie_origem_proced),1,15),'N'),
			b.ie_lado,
			obter_situacao_proced_prescr(b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno),
			b.nr_seq_exame,
			obter_especialidade_proced(b.cd_procedimento,b.ie_origem_proced),
			b.cd_setor_atendimento,
			coalesce(c.ie_classificacao,'1'),
			b.nr_seq_proc_interno,
			coalesce(b.ds_dado_clinico,ds_dado_clinico_w),
			b.ds_resumo_clinico,
			obter_grupo_exame_lab(b.nr_seq_exame),
			c.cd_area_procedimento,
			c.cd_grupo_proc,
			coalesce(substr(sus_obter_seq_estrut_proc(sus_obter_estrut_proc(b.cd_procedimento,b.ie_origem_proced,'C','S'),'S'),1,10),0),
			trunc(b.dt_prev_execucao,'mi'),
			b.nr_seq_prot_glic,
			obter_se_setor_exec(b.cd_setor_atendimento,cd_estab_prescr_w,b.cd_procedimento,b.ie_origem_proced,b.nr_seq_proc_interno),
			b.ie_urgencia,
			b.cd_intervalo,
			b.cd_setor_atendimento,
			c.cd_tipo_procedimento,
			ds_material_especial,
			b.ds_observacao,
			b.qt_procedimento,
			b.dt_suspensao,
			b.ds_horarios,
			b.nr_seq_derivado,
			b.nr_seq_solic_sangue,
			b.ie_se_necessario,
			b.ie_acm,
			coalesce(b.cd_senha,cd_senha_w),
			Obter_se_obriga_just_hemo(b.ie_aliquotado, b.ie_filtrado, b.ie_irradiado, b.ie_lavado, b.nr_seq_derivado),
			b.ds_justificativa,
			obter_se_setor_exec_lab(b.cd_setor_atendimento, cd_estab_prescr_w, b.cd_procedimento, b.ie_origem_proced, b.nr_seq_exame),
			b.ie_filtrado,
			b.ie_irradiado,
			b.ie_lavado,
			b.dt_ult_dose_medic,
			b.qt_ult_dose_medic,
			b.nr_seq_condicao,
			to_char(b.dt_prev_execucao,'hh24:mi'),
			b.nr_seq_contraste,
			b.ie_util_hemocomponente,
			b.ie_anestesia,
			b.nr_sequencia,
			b.ie_forma_exame,
			b.nr_seq_topografia,
			b.nr_seq_ageint_exame_lab,
			b.cd_medico_exec,
			b.ie_tipo_proced,
			b.cd_protocolo,
			case when obter_tipo_proc_interno(b.nr_seq_proc_interno) in ('AP', 'APH', 'APC') then 'S' else 'N' end
		from	Estrutura_Procedimento_v c,
			prescr_procedimento b,
			prescr_medica a
		where	a.nr_prescricao		= b.nr_prescricao
		and	b.cd_procedimento	= c.cd_procedimento
		and	b.ie_origem_proced	= c.ie_origem_proced
		and	a.nr_prescricao		= nr_prescricao_p
		and	b.nr_prescricao		= nr_prescricao_p
		and	b.nr_sequencia		= nr_seq_proced_p
		and	coalesce(b.dt_suspensao::text, '') = ''
		and	(((obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'O') = 'S' or
			  Obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'AP') = 'S' or
			  Obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'APH') = 'S' or
			  Obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'APC') = 'S') and VarConsisteHemo_w <> 'S') or
			((VarConsisteHemo_w = 'S') and (Obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'O') = 'S' or
			  Obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'BSHE') = 'S' or
			  Obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'AP') = 'S' or
			  Obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'APH') = 'S' or
			  Obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'APC') = 'S') ) or
			(((Obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'BS')= 'S') or (Obter_se_exibe_proced(b.nr_prescricao,b.nr_sequencia,b.ie_tipo_proced,'AT')= 'S')) and (exists ( SELECT 1
				    from  san_derivado d
						WHERE d.nr_sequencia = b.nr_seq_derivado
						AND   coalesce(d.ie_proced_hemoterapico,'N') = 'S'
						and   b.ie_tipo_proced in ('BS','AT')))));
	end if;

	loop
	fetch c00 into
		cd_procedimento_w,
		ie_origem_proced_w,
		cd_material_exame_w,
		dt_prev_execucao_w,
		ie_proced_lado_w,
		ie_lado_w,
		ie_situacao_proced_w,
		nr_seq_exame_w,
		cd_especialidade_proced_w,
		cd_setor_proced_w,
		ie_classificacao_w,
		nr_seq_proc_interno_w,
		ds_dado_clinico_w,
		ds_resumo_clinico_w,
		nr_seq_grupo_exame_w,
		cd_area_procedimento_w,
		cd_grupo_procedimento_w,
		nr_seq_subgrupo_w,
		dt_prev_execucao_mi_w,
		nr_seq_prot_glic_w,
		ie_setor_exec_proced_w,
		ie_proced_agora_w,
		cd_intervalo_w,
		cd_setor_atendimento_w,
		cd_tipo_procedimento_w,
		ds_material_especial_w,
		ds_observacao_w,
		qt_procedimento_w,
		dt_suspensao_w,
		ds_horarios_w,
		nr_seq_derivado_w,
		nr_seq_solic_sangue_w,
		ie_se_necessario_w,
		ie_acm_w,
		cd_senha_w,
		ie_justif_hemo_w,
		ds_justificativa_w,
		ie_setor_exec_Exame_w,
		ie_filtrado_w,
		ie_irradiado_w,
		ie_lavado_w,
		dt_ult_dose_medic_w,
		qt_ult_dose_medic_w,
		nr_seq_condicao_w,
		hr_prev_w,
		nr_seq_contraste_w,
		ie_util_hemocomponente_w,
		ie_anestesia_w,
		nr_seq_proced_w,
		ie_forma_exame_w,
		nr_seq_topografia_w,
		nr_seq_ageint_exame_lab_w,
		cd_medico_exec_w,
		ie_tipo_proced_w,
		cd_protocolo_item_w,
		ie_anatomia_patologica_w;
	EXIT WHEN NOT FOUND; /* apply on c00 */
		
		if (coalesce(nr_seq_proc_interno_w::text, '') = '') then
			ie_anatomia_patologica_w := 'N';
		end if;
		
		cd_convenio_particular_w	:= null;
		nr_seq_regra_plano_w		:= null;
		cd_categoria_particular_w	:= null;

		ie_tipo_protocolo_w	:= null;
		if (nr_seq_prot_glic_w IS NOT NULL AND nr_seq_prot_glic_w::text <> '') then
			select	max(ie_tipo)
			into STRICT	ie_tipo_protocolo_w
			from	pep_protocolo_glicemia
			where	nr_sequencia	= nr_seq_prot_glic_w;
		end if;

		ie_proced_externo_w := consistir_proced_externo(nr_prescricao_p, nr_seq_proced_w, nm_usuario_p, cd_perfil_p, ie_proced_externo_w);

		if (nr_seq_solic_sangue_w IS NOT NULL AND nr_seq_solic_sangue_w::text <> '') then
			select	coalesce(max(ie_hemoglobina),'N'),
				coalesce(max(ie_hematocrito),'N'),
				coalesce(max(ie_plaquetas),'N'),
				coalesce(max(ie_tap),'N'),
				coalesce(max(ie_inr),'N'),
				coalesce(max(ie_fibrinogenio),'N'),
				coalesce(max(IE_OBRIGA_AMBOS),'N'),
				coalesce(max(ie_obriga_albumina),'N'),
				coalesce(max(ie_obriga_calcio),'N'),
				coalesce(max(ie_obriga_magnesio),'N'),
				coalesce(max(ie_obriga_bili_dir),'N'),
				coalesce(max(ie_obriga_bili_ind),'N'),
				coalesce(max(ie_obriga_hemoglobina_s),'N'),
				coalesce(max(ie_obriga_coombs),'N'),
				coalesce(max(ie_obriga_coagulopatia),'N')
			into STRICT	ie_hemoglobina_w,
				ie_hematocrito_w,
				ie_plaquetas_w,
				ie_tap_w,
				ie_inr_w,
				ie_fibrinogenio_w,
				ie_consiste_ambos_w,
				ie_obriga_albumina_w,
				ie_obriga_calcio_w,
				ie_obriga_magnesio_w,
				ie_obriga_bili_dir_w,
				ie_obriga_bili_ind_w,
				ie_obriga_hemoglobina_s_w,
				ie_obriga_coombs_w,
				ie_obriga_coagulopatia_w
			from	san_derivado
			where	nr_sequencia	= nr_seq_derivado_w;

			begin
			select	qt_plaqueta,
				qt_hemoglobina,
				qt_tap,
				qt_tap_inr,
				qt_hematocrito,
				ie_tipo,
				qt_fibrinogenio,
				qt_ttpa,
				qt_albumina,
				qt_calcio,
				qt_magnesio,
				qt_bilirrubina_dir,
				qt_bilirrubina_ind,
				qt_hemoglobina_s,
				ie_coombs_direto,
				ds_coagulopatia,
				qt_ttpa_rel,
				ie_reserva
			into STRICT	qt_plaqueta_w,
				qt_hemoglobina_w,
				qt_tap_w,
				qt_tap_inr_w,
				qt_hematocrito_w,
				ie_tipo_w,
				qt_fibrinogenio_w,
				qt_ttpa_w,
				qt_albumina_w,
				qt_calcio_w,
				qt_magnesio_w,
				qt_bilirrubina_dir_w,
				qt_bilirrubina_ind_w,
				qt_hemoglobina_s_w,
				ie_coombs_direto_w,
				ds_coagulopatia_w,
				qt_ttpa_rel_w,
				ie_reserva_w
			from	prescr_solic_bco_sangue
			where	nr_sequencia	= nr_seq_solic_sangue_w;
			exception
			when others then
				qt_plaqueta_w		:= null;
				qt_hemoglobina_w	:= null;
				qt_tap_w		:= null;
				qt_tap_inr_w		:= null;
				qt_hematocrito_w	:= null;
			end;
		end if;


		if (ie_consistir_glosa_convenio_w <> 'N') and (nr_atendimento_w > 0) then

			SELECT * FROM obter_regra_ajuste_proc(	cd_estab_prescr_w, cd_convenio_w, cd_categoria_w, cd_procedimento_w, ie_origem_proced_w, null, dt_prescricao_w, coalesce(cd_tipo_acomodacao_w,0), coalesce(ie_tipo_atendimento_w,0), coalesce(cd_setor_proced_w,0), null, 0, 0, nr_seq_exame_w, nr_seq_proc_interno_w, null, cd_plano_convenio_w, null, null, null, tx_ajuste_w, tx_ajuste_custo_oper_w, tx_ajuste_medico_w, tx_ajuste_partic_w, tx_ajuste_filme_w, vl_negociado_w, ie_preco_informado_w, ie_glosa_w, cd_procedimento_esp_w, nr_seq_regra_preco_w, cd_edicao_ajuste_w, vl_medico_w, vl_custo_operacional_w, qt_filme_w, nr_auxiliares_w, qt_porte_anestesico_w, pr_glosa_w, vl_glosa_w, cd_motivo_exc_conta_w, null, 0, ie_autor_particular_w, cd_convenio_glosa_w, cd_categoria_glosa_w, nr_seq_regra_ajuste_w, null, null, null, null, null, null, null, null, vl_filme_w, (obter_dados_categ_conv(nr_atendimento_w, 'COB'))::numeric , cd_setor_prescricao_w, nr_seq_classif_atend_w, cd_medico_resp_w, ie_carater_inter_sus_w, null, null, nr_seq_origem_w, null, nr_seq_classif_medico_w) INTO STRICT tx_ajuste_w, tx_ajuste_custo_oper_w, tx_ajuste_medico_w, tx_ajuste_partic_w, tx_ajuste_filme_w, vl_negociado_w, ie_preco_informado_w, ie_glosa_w, cd_procedimento_esp_w, nr_seq_regra_preco_w, cd_edicao_ajuste_w, vl_medico_w, vl_custo_operacional_w, qt_filme_w, nr_auxiliares_w, qt_porte_anestesico_w, pr_glosa_w, vl_glosa_w, cd_motivo_exc_conta_w, ie_autor_particular_w, cd_convenio_glosa_w, cd_categoria_glosa_w, nr_seq_regra_ajuste_w, vl_filme_w;
		end if;

		ie_erro_liberar_prescr_w	:= '';


		if (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(294,cd_perfil_p) = 'S') then

			SELECT * FROM proc_lib_prescr_result_exame(nr_atendimento_w, cd_grupo_procedimento_w, cd_especialidade_proced_w, cd_area_procedimento_w, cd_procedimento_w, nr_seq_proc_interno_w, ie_lib_proc_result_exame_w, ds_mensagem_w) INTO STRICT ie_lib_proc_result_exame_w, ds_mensagem_w;

			if ((ie_lib_proc_result_exame_w = 'N') or (ie_lib_proc_result_exame_w = 'J')) then

				ds_inf_just_exam_w := null;

				if (((ie_lib_proc_result_exame_w = 'N') or ie_lib_proc_result_exame_w = 'J') and (coalesce(ds_justificativa_w::text, '') = ''))then
					ie_erro_liberar_prescr_w := 'N';

					if (ie_lib_proc_result_exame_w = 'J') then
						ds_inf_just_exam_w := wheb_mensagem_pck.get_texto(1025154);
					end if;
				else
					ie_erro_liberar_prescr_w := 'S';
				end if;

				if (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') then
					ds_inf_just_exam_w := ds_inf_just_exam_w || ' ' || ds_mensagem_w;
				end if;

				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 294, ie_erro_liberar_prescr_w, ds_inf_just_exam_w, cd_perfil_p, nm_usuario_p, ie_tipo_w, nr_seq_erro_w, null);
			end if;
		end if;

		if (ie_consistir_proced_duplic_w 	<> 'N') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(60,cd_perfil_p) = 'S') then

			ie_consistir_proc_duplic_w	:= obter_se_consistir_proc_duplic(nr_seq_proc_interno_w);

			if (ie_consistir_proc_duplic_w = 'S') then
				if	((ie_consistir_proced_duplic_w <> 'L') or (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '')) then

					select	coalesce(max(ie_permite_proc_dupl),'S')
					into STRICT	ie_permite_proc_dupl_w
					from	setor_atendimento
					where	cd_setor_atendimento = cd_setor_prescricao_w;

					if (ie_consistir_proced_duplic_w <> 'J') then
						ie_proced_duplic_w	:= obter_se_proced_duplic_prescr(nr_atendimento_w, nr_prescricao_p, nr_seq_proced_w, cd_procedimento_w, ie_origem_proced_w, cd_material_exame_w, dt_prev_execucao_w, qt_hora_proced_duplic_w, nr_seq_proc_interno_w, ie_consiste_mesma_prescr_w,nr_seq_exame_w);
					else
						ie_proced_duplic_w	:= obter_se_duplic_prescr_just(nr_atendimento_w, nr_prescricao_p, nr_seq_proced_w, cd_procedimento_w, ie_origem_proced_w, cd_material_exame_w, dt_prev_execucao_w, qt_hora_proced_duplic_w, nr_seq_proc_interno_w,nr_seq_exame_w);
					end if;

					if (ie_permite_proc_dupl_w	= 'S') and (ie_proced_duplic_w 	= 'S') then

						if (ie_consistir_proced_duplic_w in ('S', 'L')) then
							ie_erro_liberar_prescr_w	:= 'S';
						elsif (ie_consistir_proced_duplic_w = 'J') then
								ie_erro_liberar_prescr_w	:= 'N';
						elsif (ie_consistir_proced_duplic_w = 'I') then
							ie_erro_liberar_prescr_w	:= 'N';
						end if;

						ds_prescr_duplic_w	:= obter_prescr_proced_duplic(nr_atendimento_w, nr_prescricao_p, nr_seq_proced_w, cd_procedimento_w, ie_origem_proced_w, cd_material_exame_w, dt_prev_execucao_w, qt_hora_proced_duplic_w);

						if (ie_consistir_proced_duplic_w = 'J') then
							ds_prescr_duplic_w	:= Wheb_mensagem_pck.get_texto(306487, 'DS_PRESCR_DUPLIC_W=' || ds_prescr_duplic_w); -- Informe uma justificativa para o exame. #@DS_PRESCR_DUPLIC_W#@
						end if;

						if (ie_consistir_proced_duplic_w = 'J') and (ds_justificativa_w IS NOT NULL AND ds_justificativa_w::text <> '') THEN
						  nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 60, ie_erro_liberar_prescr_w, ds_prescr_duplic_w, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w, 'S');
						else
							nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 60, ie_erro_liberar_prescr_w, ds_prescr_duplic_w, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
						end if;

					end if;
				end if;
			end if;
		end if;

		ie_erro_liberar_prescr_w := '';

		if (ie_consiste_qt_dt_dose_w = 'S') and (coalesce(dt_ult_dose_medic_w::text, '') = '') and (coalesce(qt_ult_dose_medic_w::text, '') = '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(183,cd_perfil_p) = 'S') then

			qt_exame_obriga_dose_w := Obter_se_seq_prescr_exige_dose(nr_prescricao_p,nr_seq_proced_w);

			if (coalesce(qt_exame_obriga_dose_w,0) > 0) then
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 183, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
		end if;

		ie_erro_liberar_prescr_w := '';

		if (nr_atendimento_w > 0) and (obter_se_obriga_justif_proc(cd_procedimento_w, nr_seq_proc_interno_w, ie_origem_proced_w, cd_area_procedimento_w, cd_especialidade_proced_w, cd_grupo_procedimento_w, nr_atendimento_w) = 'S') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(44,cd_perfil_p) = 'S') then

			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(44, cd_perfil_p);
			if (coalesce(ds_justificativa_w::text, '') = '') then
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 44, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			else
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 44, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w, 'S');
			end if;

		end if;

		if (ie_proced_lado_w = 'S') and (coalesce(ie_lado_w::text, '') = '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(61,cd_perfil_p) = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(61, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 61, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		if (ie_proced_lado_w = 'L') and
			((coalesce(ie_lado_w::text, '') = '') or (ie_lado_w = 'A')) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(97,cd_perfil_p) = 'S') then
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 97, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_consistir_regra_uso_w <> 'N') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(6,cd_perfil_p) = 'S') then
			ie_erro_regra_uso_w	:= obter_se_uso_qtde_proc(nr_atendimento_w, cd_procedimento_w, ie_origem_proced_w, qt_procedimento_w, cd_prescritor_w, cd_setor_prescricao_w, dt_prev_execucao_w, '3', nr_seq_proced_w, null, null,nr_seq_proc_interno_w,cd_categoria_w,cd_plano_convenio_w, nr_seq_exame_w);

			if (ie_erro_regra_uso_w IS NOT NULL AND ie_erro_regra_uso_w::text <> '') then
				if (ie_consistir_regra_uso_w = 'CA') then
					ie_erro_liberar_prescr_w	:= 'S';
				else
					ie_erro_liberar_prescr_w	:= 'N';
				end if;
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 6, ie_erro_liberar_prescr_w, ie_erro_regra_uso_w, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;

		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_proced_lado_w = 'O') and (ie_lado_w IS NOT NULL AND ie_lado_w::text <> '') and (ie_lado_w <> 'N') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(62,cd_perfil_p) = 'S') then
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 62, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(63,cd_perfil_p) = 'S') and (ie_situacao_proced_w = 'I') then
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 63, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(64,cd_perfil_p) = 'S') then
			ie_dose_assoc_lib_w	:= obter_se_matmed_assoc_proc_lib(nr_prescricao_p,nr_seq_proced_w,'D');

			if (ie_dose_assoc_lib_w = 'N') then
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 64, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;

		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (coalesce(nr_seq_exame_w::text, '') = '') and (cd_especialidade_proced_w = 28000005) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(65,cd_perfil_p) = 'S') then

			if (ie_consistir_patol_cli_lab_w <> 'N') then

				if (ie_consistir_patol_cli_lab_w = 'CAI') then
					ie_erro_liberar_prescr_w	:= 'N';
				else
					ie_erro_liberar_prescr_w	:= 'S';
				end if;

				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 65, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_consistir_glosa_convenio_w <> 'N') and (nr_atendimento_w > 0) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(66,cd_perfil_p) = 'S') then

			if (ie_consistir_glosa_convenio_w = 'CAI') then
				ie_erro_liberar_prescr_w	:= 'N';
			else
				ie_erro_liberar_prescr_w	:= 'S';
			end if;

			if (ie_glosa_w in ('T','G')) then
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 66, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;

		end if;

		ie_erro_liberar_prescr_w	:= '';

		ds_aux_w:= '';

		if (ie_consistir_glosa_convenio_w <> 'N') and (nr_atendimento_w > 0) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(67,cd_perfil_p) = 'S') and (obter_se_consiste_proc_conv(cd_procedimento_w, ie_origem_proced_w) = 'S') then

			if (ie_classificacao_w = '2') then
				ie_proc_edicao_w	:= 'S';
			else
				ie_proc_edicao_w	:= coalesce(obter_se_proc_edicao(cd_estab_prescr_w,cd_convenio_w,cd_categoria_w,clock_timestamp(),cd_procedimento_w, ie_tipo_atendimento_w),'S');
			end if;

			if (ie_proc_edicao_w = 'N') then
				ie_pacote_convenio_w	:= coalesce(obter_se_pacote_convenio(cd_procedimento_w,ie_origem_proced_w,cd_convenio_w,cd_estab_prescr_w),'N');
			end if;

			if (cd_edicao_ajuste_w > 0) then
				select 	count(*)
				into STRICT	qt_proc_edicao_w
				from 	preco_amb where		cd_edicao_amb = cd_edicao_ajuste_w
				and 	cd_procedimento = cd_procedimento_w
				and 	ie_origem_proced = ie_origem_proced_w LIMIT 1;
			end if;

			if (ie_proc_edicao_w = 'N') and
				((cd_edicao_ajuste_w = 0) or (cd_edicao_ajuste_w > 0 AND qt_proc_edicao_w = 0)) and (ie_pacote_convenio_w = 'N') then

				if (ie_consistir_glosa_convenio_w = 'CAI') then
					ie_erro_liberar_prescr_w	:= 'N';
				else
					ie_erro_liberar_prescr_w	:= 'S';
				end if;

				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 67, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
				ie_glosa_zerado_w := obter_parametro_geral(3, ie_glosa_zerado_w);

				if (ie_glosa_zerado_w	= 'S') then /*Felipe Martini em 10/11/2008 OS 116538*/
					SELECT * FROM Obter_Convenio_Particular_PF(	cd_estabelecimento_w, cd_convenio_w, cd_pessoa_fisica_w, dt_prescricao_w, cd_convenio_particular_w, cd_categoria_particular_w) INTO STRICT cd_convenio_particular_w, cd_categoria_particular_w;
				end if;
			end if;

		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_consistir_glosa_convenio_w <> 'N') and (nr_atendimento_w > 0) and
			((ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(68,cd_perfil_p) = 'S') or (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(69,cd_perfil_p) = 'S') or (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(70,cd_perfil_p) = 'S') or (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(71,cd_perfil_p) = 'S')) then

			SELECT * FROM consiste_plano_convenio(nr_atendimento_w, cd_convenio_w, cd_procedimento_w, ie_origem_proced_w, dt_prescricao_w, qt_procedimento_w, ie_tipo_atendimento_w, cd_plano_convenio_w, null, ie_erro_autorizacao_w, cd_setor_proced_w, nr_seq_exame_w, ie_regra_plano_w, null, nr_seq_regra_plano_w, nr_seq_proc_interno_w, cd_categoria_w, cd_estabelecimento_w, null, null, cd_pessoa_atend_w, ie_glosa_plano_w, nr_seq_regra_preco_plano_w) INTO STRICT ie_erro_autorizacao_w, ie_regra_plano_w, nr_seq_regra_plano_w, ie_glosa_plano_w, nr_seq_regra_preco_plano_w;


		end if;

		if (ie_consistir_glosa_convenio_w <> 'N') and (nr_atendimento_w > 0) and
			((ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(68,cd_perfil_p) = 'S') or (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(69,cd_perfil_p) = 'S') or (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(70,cd_perfil_p) = 'S')) then

			if (ie_regra_plano_w = 5) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(68,cd_perfil_p) = 'S') and
				((coalesce(ds_observacao_w::text, '') = '') or (ie_obriga_just_w	= 'N')) then

				select	max(ds_inconsist_prescr)
				into STRICT	ds_inconsist_prescr_w
				from	regra_convenio_plano
				where	nr_sequencia	= nr_seq_regra_plano_w;

				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(68, cd_perfil_p);
				if (ie_erro_liberar_prescr_w = 'C') then
					if (ie_consistir_glosa_convenio_w = 'CAI') then
						ie_erro_liberar_prescr_w	:= 'N';
					else
						ie_erro_liberar_prescr_w	:= 'S';
					end if;
				end if;

				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 68, ie_erro_liberar_prescr_w, ds_inconsist_prescr_w, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);

			elsif (ie_regra_plano_w in (3,6,7,8)) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(69,cd_perfil_p) = 'S') and
				((ie_consiste_justif_w	= 'N') or
				 ((cd_funcao_origem_w = 2314 and coalesce(ds_justificativa_w::text, '') = '') or (cd_funcao_origem_w <> 2314 and coalesce(ds_observacao_w::text, '') = ''))) then
				
				select	max(ds_inconsist_prescr)
				into STRICT	ds_inconsist_prescr_w
				from	regra_convenio_plano
				where	nr_sequencia	= nr_seq_regra_plano_w;

				if (coalesce(nr_seq_ageint_exame_lab_w,0) > 0) then
					begin

					select	count(*)
					into STRICT	qt_autor_ageint_exame_lab_w
					from	procedimento_autorizado a,
							autorizacao_convenio b,
							estagio_autorizacao c where		a.nr_sequencia_autor = b.nr_sequencia
					and		b.nr_seq_estagio = c.nr_sequencia
					and		c.ie_interno	 = '10'
					and		coalesce(a.qt_autorizada,0) > 0
					and		a.nr_seq_ageint_exame_lab = nr_seq_ageint_exame_lab_w LIMIT 1;

					end;
				end if;

				/*Philippe em 05/02/2010 - OS 184973*/

				if (coalesce(qt_autor_ageint_exame_lab_w,0) = 0) then
					begin
					ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(69, cd_perfil_p);
					if (ie_erro_liberar_prescr_w = 'C') then
						if (ie_consistir_glosa_convenio_w = 'CAI') then
							ie_erro_liberar_prescr_w	:= 'N';
						else
							ie_erro_liberar_prescr_w	:= 'S';
						end if;
					end if;

					if (ie_erro_autorizacao_w <> '') then
						ie_erro_autorizacao_w := restringir_inconsistencia(cd_estabelecimento_p, cd_convenio_w, cd_categoria_w, ie_tipo_atendimento_w, ie_clinica_w, nr_seq_classif_atend_w, ie_erro_autorizacao_w);
						if (ie_erro_autorizacao_w <> '') then
							nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 69, ie_erro_liberar_prescr_w, ds_inconsist_prescr_w, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
						end if;
					else
						nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 69, ie_erro_liberar_prescr_w, ds_inconsist_prescr_w, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
					end if;
					end;
				end if;

			elsif (ie_regra_plano_w = 2) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(70,cd_perfil_p) = 'S') then

				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(70, cd_perfil_p);
				if (ie_erro_liberar_prescr_w = 'C') then
					if (ie_consistir_glosa_convenio_w = 'CAI') then
						ie_erro_liberar_prescr_w	:= 'N';
					else
						ie_erro_liberar_prescr_w	:= 'S';
					end if;
				end if;
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 70, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);

			end if;

		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(71,cd_perfil_p) = 'S') then

			select	coalesce(max('S'),'N')
			into STRICT	ie_regra_indic_clinica_obrig_w
			from	regra_indic_clinica_obrig where	coalesce(nr_seq_exame_lab,nr_seq_exame_w,0)		= coalesce(nr_seq_exame_w,0)
			and	coalesce(nr_seq_grupo_lab,nr_seq_grupo_exame_w,0)	= coalesce(nr_seq_grupo_exame_w,0)
			and	coalesce(nr_seq_exame_interno,nr_seq_proc_interno_w,0)	= coalesce(nr_seq_proc_interno_w,0)
			and	coalesce(cd_area_procedimento,cd_area_procedimento_w,0)	= coalesce(cd_area_procedimento_w,0)
			and	coalesce(cd_especialidade,cd_especialidade_proced_w,0)	= coalesce(cd_especialidade_proced_w,0)
			and	coalesce(cd_grupo_proc,cd_grupo_procedimento_w,0)	= coalesce(cd_grupo_procedimento_w,0)
			and	coalesce(cd_procedimento,cd_procedimento_w,0)		= coalesce(cd_procedimento_w,0)
			and	coalesce(ie_origem_proced,ie_origem_proced_w,0)		= coalesce(ie_origem_proced_w,0)
			and	coalesce(cd_intervalo,cd_intervalo_w,'XPTO')			= coalesce(cd_intervalo_w,'XPTO')
			and	coalesce(nr_seq_subgrupo,nr_seq_subgrupo_w)			= nr_seq_subgrupo_w
			and	coalesce(cd_convenio, cd_convenio_w)				= cd_convenio_w
			and	coalesce(cd_perfil,cd_perfil_p,0)			= coalesce(cd_perfil_p,0)
			and	coalesce(cd_setor_prescricao,cd_setor_prescricao_w,0)	= coalesce(cd_setor_prescricao_w,0)
			and	coalesce(cd_setor_executor,cd_setor_atendimento_w,0)	= coalesce(cd_setor_atendimento_w,0)
			and	coalesce(cd_tipo_procedimento, cd_tipo_procedimento_w,0) = coalesce(cd_tipo_procedimento_w,0)
			and	coalesce(ie_tipo_convenio, cd_tipo_convenio_w,0)	= coalesce(cd_tipo_convenio_w,0)
			and	Obter_Regra_obrig_proc(nr_sequencia, ie_tipo_atendimento_w, cd_material_exame_w) = 'S'
			and	((coalesce(ie_autorizacao,'N') = 'N') or (ie_regra_plano_w = 5))
			and	(((coalesce(qt_minimo_caracter,0) = 0) and (coalesce(ds_dado_clinico_w::text, '') = '')) or (coalesce(length(ds_dado_clinico_w),0) < qt_minimo_caracter))
			and	cd_estabelecimento					= cd_estab_prescr_w
			and	((coalesce(hr_prev_inicial::text, '') = '') or (to_char(dt_prev_execucao_w,'hh24:mi')	>= substr(hr_prev_inicial,1,5)))
			and	((coalesce(hr_prev_final::text, '') = '') or (to_char(dt_prev_execucao_w,'hh24:mi')	<= substr(hr_prev_final,1,5)))
			and	coalesce(ie_campo_obriga,'0') = '1' LIMIT 1;

			if (ie_regra_indic_clinica_obrig_w = 'S') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(71,cd_perfil_p) = 'S') then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(71, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 71, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;

		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (coalesce(ds_material_especial_w::text, '') = '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(71,cd_perfil_p) = 'S') then

			select	coalesce(max('S'),'N')
			into STRICT	ie_regra_indic_clinica_obrig_w
			from	regra_indic_clinica_obrig where	coalesce(nr_seq_exame_lab,nr_seq_exame_w,0)		= coalesce(nr_seq_exame_w,0)
			and	coalesce(nr_seq_grupo_lab,nr_seq_grupo_exame_w,0)	= coalesce(nr_seq_grupo_exame_w,0)
			and	coalesce(nr_seq_exame_interno,nr_seq_proc_interno_w,0)	= coalesce(nr_seq_proc_interno_w,0)
			and	coalesce(cd_area_procedimento,cd_area_procedimento_w,0)	= coalesce(cd_area_procedimento_w,0)
			and	coalesce(cd_especialidade,cd_especialidade_proced_w,0)	= coalesce(cd_especialidade_proced_w,0)
			and	coalesce(cd_grupo_proc,cd_grupo_procedimento_w,0)	= coalesce(cd_grupo_procedimento_w,0)
			and	coalesce(cd_procedimento,cd_procedimento_w,0)		= coalesce(cd_procedimento_w,0)
			and	coalesce(ie_origem_proced,ie_origem_proced_w,0)		= coalesce(ie_origem_proced_w,0)
			and	coalesce(cd_intervalo,cd_intervalo_w,'XPTO')			= coalesce(cd_intervalo_w,'XPTO')
			and	coalesce(cd_convenio, cd_convenio_w)				= cd_convenio_w
			and	coalesce(nr_seq_subgrupo,nr_seq_subgrupo_w)			= nr_seq_subgrupo_w
			and	coalesce(cd_perfil,cd_perfil_p,0)			= coalesce(cd_perfil_p,0)
			and	coalesce(cd_setor_prescricao,cd_setor_prescricao_w,0)	= coalesce(cd_setor_prescricao_w,0)
			and	coalesce(cd_setor_executor,cd_setor_atendimento_w,0)	= coalesce(cd_setor_atendimento_w,0)
			and	coalesce(cd_tipo_procedimento, cd_tipo_procedimento_w,0) = coalesce(cd_tipo_procedimento_w,0)
			and	coalesce(ie_tipo_convenio, cd_tipo_convenio_w,0)	= coalesce(cd_tipo_convenio_w,0)
			and	Obter_Regra_obrig_proc(nr_sequencia, ie_tipo_atendimento_w, cd_material_exame_w) = 'S'
			and	((coalesce(ie_autorizacao,'N') = 'N') or (ie_regra_plano_w = 5))
			and	cd_estabelecimento					= cd_estab_prescr_w
			and	((coalesce(hr_prev_inicial::text, '') = '') or (to_char(dt_prev_execucao_w,'hh24:mi')	>= substr(hr_prev_inicial,1,5)))
			and	((coalesce(hr_prev_final::text, '') = '') or (to_char(dt_prev_execucao_w,'hh24:mi')	<= substr(hr_prev_final,1,5)))
			and	coalesce(ie_campo_obriga,'0') = '4' LIMIT 1;

			if (ie_regra_indic_clinica_obrig_w = 'S') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(71,cd_perfil_p) = 'S') then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(71, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 71, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if	((ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(71,cd_perfil_p) = 'S') and
			((ie_consistir_proced_indic_w = 'S') or (cd_funcao_origem_w = 2314))) then

			select	coalesce(max('S'),'N')
			into STRICT	ie_regra_indic_clinica_obrig_w
			from	regra_indic_clinica_obrig where coalesce(nr_seq_exame_lab,nr_seq_exame_w,0)		= coalesce(nr_seq_exame_w,0)
			and	coalesce(nr_seq_grupo_lab,nr_seq_grupo_exame_w,0)	= coalesce(nr_seq_grupo_exame_w,0)
			and	coalesce(nr_seq_exame_interno,nr_seq_proc_interno_w,0)	= coalesce(nr_seq_proc_interno_w,0)
			and	coalesce(cd_area_procedimento,cd_area_procedimento_w,0)	= coalesce(cd_area_procedimento_w,0)
			and	coalesce(cd_especialidade,cd_especialidade_proced_w,0)	= coalesce(cd_especialidade_proced_w,0)
			and	coalesce(cd_grupo_proc,cd_grupo_procedimento_w,0)	= coalesce(cd_grupo_procedimento_w,0)
			and	coalesce(cd_procedimento,cd_procedimento_w,0)		= coalesce(cd_procedimento_w,0)
			and	coalesce(ie_origem_proced,ie_origem_proced_w,0)		= coalesce(ie_origem_proced_w,0)
			and	coalesce(nr_seq_subgrupo,nr_seq_subgrupo_w)			= nr_seq_subgrupo_w
			and	coalesce(cd_convenio, cd_convenio_w)				= cd_convenio_w
			and	coalesce(cd_perfil,cd_perfil_p,0)			= coalesce(cd_perfil_p,0)
			and	coalesce(ie_tipo_convenio, cd_tipo_convenio_w,0)	= coalesce(cd_tipo_convenio_w,0)
			and	Obter_Regra_obrig_proc(nr_sequencia, ie_tipo_atendimento_w, cd_material_exame_w) = 'S'
			and	coalesce(cd_tipo_procedimento, cd_tipo_procedimento_w,0) = coalesce(cd_tipo_procedimento_w,0)
			and	((coalesce(ie_autorizacao,'N') = 'N') or (ie_regra_plano_w = 5))
			and	(((coalesce(qt_minimo_caracter,0) = 0) and (coalesce(ds_resumo_clinico_w::text, '') = '')) or (coalesce(length(ds_resumo_clinico_w),0) < qt_minimo_caracter))
			and	cd_estabelecimento					= cd_estab_prescr_w
			and	coalesce(ie_campo_obriga,'0') = '2' LIMIT 1;

			if (ie_regra_indic_clinica_obrig_w = 'S') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(71,cd_perfil_p) = 'S') then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(71, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 71, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
			ie_erro_liberar_prescr_w := '';

			ie_regra_indic_clinica_obrig_w := '';

			open C01;
			loop
			fetch C01 into
				ie_regra_indic_clinica_obrig_w,
				qt_minimo_caracter_w,
				cd_setor_regra_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				begin
				ie_regra_indic_clinica_obrig_w	:= ie_regra_indic_clinica_obrig_w;
				qt_minimo_caracter_w 		:= qt_minimo_caracter_w;
				end;
			end loop;
			close C01;

			if (qt_minimo_caracter_w = 0) then
				ds_complemento_71_w := Wheb_mensagem_pck.get_texto(306494, null); -- Para este procedimento e obrigatorio informar o campo Justificativa
			else
				ds_complemento_71_w := Wheb_mensagem_pck.get_texto(306498, 'QT_MINIMO_CARACTER_W=' || qt_minimo_caracter_w || ';' || 'DS_JUSTIFICATIVA_W=' || coalesce(length(ds_justificativa_w),0)); -- e obrigatorio informar o campo Justificativa com #@QT_MINIMO_CARACTER_W#@ caracteres no minimo. Atual: #@DS_JUSTIFICATIVA_W#@ caracteres.
			end if;

			if (ie_regra_indic_clinica_obrig_w = 'S') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(71,cd_perfil_p) = 'S') then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(71, cd_perfil_p);
				if (((coalesce(qt_minimo_caracter_w,0) = 0) and (coalesce(ds_justificativa_w::text, '') = '')) or (coalesce(length(ds_justificativa_w),0) < qt_minimo_caracter_w)) then
				  nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 71, ie_erro_liberar_prescr_w, ds_complemento_71_w, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
				else
				  nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 71, ie_erro_liberar_prescr_w, ds_complemento_71_w, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w, 'S');
				end if;
			end if;
		ie_erro_liberar_prescr_w	:= '';
		end if;



		ie_erro_liberar_prescr_w	:= '';

		if (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') and (coalesce(cd_material_exame_w::text, '') = '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(72,cd_perfil_p) = 'S') then
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 72, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') and (cd_material_exame_w IS NOT NULL AND cd_material_exame_w::text <> '') and
			((coalesce(qt_peso_w::text, '') = '') or (coalesce(qt_altura_cm_w::text, '') = '')) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(73,cd_perfil_p) = 'S') then
			ie_peso_altura_rep_w	:= obter_se_mat_lab_peso_alt_rep(cd_material_exame_w);

			if (coalesce(ie_peso_altura_rep_w,'N') = 'N') then
				ie_peso_altura_rep_w	:= obter_se_exame_peso_alt_rep(nr_seq_exame_w,cd_material_exame_w);
			end if;

			if (ie_peso_altura_rep_w = 'S') then
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 73, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (dt_prev_execucao_w IS NOT NULL AND dt_prev_execucao_w::text <> '') and (coalesce(dt_suspensao_w::text, '') = '') and (dt_prescricao_mi_w > dt_prev_execucao_mi_w) and
			((cd_funcao_origem_w <> 2314) or (coalesce(ie_proced_agora_w,'N') = 'N')) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(74,cd_perfil_p) = 'S') then
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 74, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';


		if (ie_anatomia_patologica_w = 'N') and (wheb_assist_pck.Obter_Se_Consiste_REP(75,cd_perfil_p) = 'S') then
			begin
			SELECT * FROM consistir_interv_solic_exame(nr_prescricao_p, nr_seq_proced_w, ie_erro_interv_solic_exame_w, ie_impede_lib_solic_exame_w, qt_horas_w, qt_minutos_w, ie_quantidade_w, ds_mensagem_regra_w, ds_mensagem_data_w, dt_ultima_data_w, cd_perfil_p, nm_usuario_p) INTO STRICT ie_erro_interv_solic_exame_w, ie_impede_lib_solic_exame_w, qt_horas_w, qt_minutos_w, ie_quantidade_w, ds_mensagem_regra_w, ds_mensagem_data_w, dt_ultima_data_w;

			if (ie_erro_interv_solic_exame_w IS NOT NULL AND ie_erro_interv_solic_exame_w::text <> '') then
				if (cd_funcao_origem_w = 2314) then					
					
					ie_justificado_w := 'N';
					
					if (ie_impede_lib_solic_exame_w = 'N') then --Nao impede liberacao
						ie_erro_liberar_prescr_w := 'S';
						
					elsif (ie_impede_lib_solic_exame_w = 'S') then --impede liberacao
						ie_erro_liberar_prescr_w := 'N';
						
						if (ds_justificativa_w IS NOT NULL AND ds_justificativa_w::text <> '') and (varParam984_w = 'S') then
							ie_justificado_w := 'S';
							ie_erro_liberar_prescr_w := 'S';
						end if;	
						
					elsif (ie_impede_lib_solic_exame_w = 'J') then ---Libera somente com justificativa
						ie_erro_liberar_prescr_w := 'N';
						
						if (ds_justificativa_w IS NOT NULL AND ds_justificativa_w::text <> '') then
							ie_justificado_w := 'S';
							ie_erro_liberar_prescr_w := 'S';
						end if;					
					end if;						
					
					/*SO 2678336 SBIS*/
						
					if (coalesce(ie_justificado_w,'N') = 'S') or (ie_erro_liberar_prescr_w = 'S') then
						nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 75, 'S', coalesce(ds_mensagem_regra_w, Wheb_mensagem_pck.get_texto(306501, 'QT_HORAS_W=' || qt_horas_w || ';' || 'QT_MINUTOS_W=' || qt_minutos_w))
								  || chr(10) || Wheb_mensagem_pck.get_texto(445426, 'DT_ULTIMA_DATA_W=' || PKG_DATE_FORMATERS.TO_VARCHAR(dt_ultima_data_w, 'timestamp', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, nm_usuario_p) || ';' || 'DS_MENSAGEM_DATA_W=' || ds_mensagem_data_w) || chr(10), cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w, 'N');
								  -- Procedimento(s)/exame(s) ja prescrito(s) em intervalo de tempo menor de #@QT_HORAS_W#@ hora(s) : #@QT_MINUTOS_W#@ minuto(s) / Procedimento solicitado em #@DT_ULTIMA_DATA_W#@, podera ser solicitado novamente em #@DS_MENSAGEM_DATA_W#@			
					else
						nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 75, ie_erro_liberar_prescr_w, coalesce(ds_mensagem_regra_w, Wheb_mensagem_pck.get_texto(306501, 'QT_HORAS_W=' || qt_horas_w || ';' || 'QT_MINUTOS_W=' || qt_minutos_w))
					  || chr(10) || Wheb_mensagem_pck.get_texto(445426, 'DT_ULTIMA_DATA_W=' || PKG_DATE_FORMATERS.TO_VARCHAR(dt_ultima_data_w, 'timestamp', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, nm_usuario_p) || ';' || 'DS_MENSAGEM_DATA_W=' || ds_mensagem_data_w) || chr(10), cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
					  -- Procedimento(s)/exame(s) ja prescrito(s) em intervalo de tempo menor de #@QT_HORAS_W#@ hora(s) : #@QT_MINUTOS_W#@ minuto(s) / Procedimento solicitado em #@DT_ULTIMA_DATA_W#@, podera ser solicitado novamente em #@DS_MENSAGEM_DATA_W#@
					end if;
				
				else
					if (ie_impede_lib_solic_exame_w = 'N') then
						ie_erro_liberar_prescr_w := 'S';
					elsif (ie_impede_lib_solic_exame_w = 'S') then
						ie_erro_liberar_prescr_w := 'N';
					end if;

					if ((coalesce(ds_justificativa_w::text, '') = '') or (varParam984_w = 'N')) then
					  nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 75, ie_erro_liberar_prescr_w, coalesce(ds_mensagem_regra_w, Wheb_mensagem_pck.get_texto(306501, 'QT_HORAS_W=' || qt_horas_w || ';' || 'QT_MINUTOS_W=' || qt_minutos_w))
					  || chr(10) || Wheb_mensagem_pck.get_texto(445426, 'DT_ULTIMA_DATA_W=' || PKG_DATE_FORMATERS.TO_VARCHAR(dt_ultima_data_w, 'timestamp', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, nm_usuario_p) || ';' || 'DS_MENSAGEM_DATA_W=' || ds_mensagem_data_w) || chr(10), cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
					  -- Procedimento(s)/exame(s) ja prescrito(s) em intervalo de tempo menor de #@QT_HORAS_W#@ hora(s) : #@QT_MINUTOS_W#@ minuto(s) / Procedimento solicitado em #@DT_ULTIMA_DATA_W#@, podera ser solicitado novamente em #@DS_MENSAGEM_DATA_W#@
					else
					  nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 75, ie_erro_liberar_prescr_w, coalesce(ds_mensagem_regra_w, Wheb_mensagem_pck.get_texto(306501, 'QT_HORAS_W=' || qt_horas_w || ';' || 'QT_MINUTOS_W=' || qt_minutos_w))
					  || chr(10) || Wheb_mensagem_pck.get_texto(445426, 'DT_ULTIMA_DATA_W=' || PKG_DATE_FORMATERS.TO_VARCHAR(dt_ultima_data_w, 'timestamp', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, nm_usuario_p) || ';' || 'DS_MENSAGEM_DATA_W=' || ds_mensagem_data_w) || chr(10), cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w, 'S');
					  -- Procedimento(s)/exame(s) ja prescrito(s) em intervalo de tempo menor de #@QT_HORAS_W#@ hora(s) : #@QT_MINUTOS_W#@ minuto(s) / Procedimento solicitado em #@DT_ULTIMA_DATA_W#@, podera ser solicitado novamente em #@DS_MENSAGEM_DATA_W#@
					end if;
					
				end if;	
			end if;
			end;
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (nr_seq_prot_glic_w IS NOT NULL AND nr_seq_prot_glic_w::text <> '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(76,cd_perfil_p) = 'S') and (ie_tipo_protocolo_w	= 'C') then

			ie_prot_glic_nivel_w	:= obter_se_prot_glic_nivel_rep(nr_prescricao_p, nr_seq_proced_w);
			if (ie_prot_glic_nivel_w = 'N') then
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 76, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;

		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_consistir_setor_proced_w = 'S') and (ie_setor_exec_proced_w = 'N') then

			ie_consiste_generico_w := 'S';

			if (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') and (coalesce(cd_setor_atendimento_w,cd_setor_prescricao_w) = cd_setor_prescricao_w) then

				select	coalesce(max('N'), 'S')
				into STRICT	ie_consiste_generico_w
				from	proc_interno
				where	coalesce(ie_setor_paciente,'N') = 'S'
				and		nr_sequencia = nr_seq_proc_interno_w  LIMIT 1;
			end if;

			if (ie_consiste_generico_w = 'S') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(77,cd_perfil_p) = 'S') then
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 77, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;

		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_perm_lib_sem_setor_exec_w = 'N') and (coalesce(cd_setor_proced_w::text, '') = '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(78,cd_perfil_p) = 'S') then
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 78, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		elsif (ie_perm_lib_sem_setor_exec_w = 'L') and (coalesce(cd_setor_proced_w::text, '') = '') and (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(78,cd_perfil_p) = 'S') then
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 78, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_proced_externo_w <> 'N') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(79,cd_perfil_p) = 'S') then

			if (ie_proced_externo_w = 'CAI') then
				ie_erro_liberar_prescr_w	:= 'N';
			else
				ie_erro_liberar_prescr_w	:= 'S';
			end if;

			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 79, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') and (ie_proced_agora_w = 'S') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(80,cd_perfil_p) = 'S') then

			ie_permite_agora_w	:= obter_se_exame_permite_agora(nr_seq_exame_w);

			if (ie_permite_agora_w = 'N') then
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 80, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if	((nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') or (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '')) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(85,cd_perfil_p) = 'S') then
			RAISE NOTICE '% - %', nr_seq_exame_w, nr_seq_proc_interno_w;
			ie_consiste_medic_proc_w	:= Obter_se_medic_proced(nr_atendimento_w, nr_seq_proc_interno_w, nr_seq_exame_w,1);
			ds_medic_proc_w			:= Obter_se_medic_proced(nr_atendimento_w, nr_seq_proc_interno_w, nr_seq_exame_w,2);

			if (ie_consiste_medic_proc_w = 'S') then
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 85, 'S', ds_medic_proc_w, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(86,cd_perfil_p) = 'S') then
			ie_consiste_prescr_proc_w	:= obter_se_permite_prescrever(nr_prescricao_p, nr_seq_proced_w, ie_origem_inf_w, cd_perfil_p);

			if (ie_consiste_prescr_proc_w = 'N') then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(86, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 86, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(91,cd_perfil_p) = 'S') then

			if (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') then
				ie_consiste_proc_duplic_w	:= obter_se_lab_duplic_prescr(nr_atendimento_w, nr_prescricao_p, nr_seq_proced_w, nr_seq_exame_w, cd_material_exame_w, nr_seq_proc_interno_w);
			else
				ie_consiste_proc_duplic_w	:= obter_se_proc_duplic_prescr(nr_atendimento_w, nr_prescricao_p, nr_seq_proced_w, cd_procedimento_w, ie_origem_proced_w, cd_material_exame_w, nr_seq_proc_interno_w, ie_lado_w);
			end if;

			if (ie_consiste_proc_duplic_w = 'S') then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(91, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 91, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(94,cd_perfil_p) = 'S') then
			ie_consiste_exame_dia_w		:= obter_se_exame_realizado_dia(nr_prescricao_p,nr_seq_proced_w);

			if (ie_consiste_exame_dia_w = 'S') then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(94, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 94, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(107,cd_perfil_p) = 'S')
		and (cd_tipo_convenio_w = 3)
		and (ie_tipo_atendimento_w not in (8,3)) then --Consistir so se o convenio for SUS e o atendimento for diferente de ambulatorial.
			select	count(*)
			into STRICT	cont_w
			from	procedimento b where		b.cd_procedimento	= cd_procedimento_w
			and		b.ie_origem_proced	= ie_origem_proced_w
			and		b.ie_exige_laudo	= 'S'
			and		not exists (	SELECT	1
								from	sus_laudo_paciente x
								where	x.nr_atendimento	= nr_atendimento_w
								and		x.cd_procedimento_solic	= cd_procedimento_w
								and		x.ie_origem_proced	= ie_origem_proced_w
								and		x.ie_classificacao	= 1
								and		x.ie_tipo_laudo_sus	= 2) LIMIT 1;

			if (cont_w > 0) then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(107, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 107, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
		end if;

		if (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(112,cd_perfil_p) = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(112, cd_perfil_p);
			if (coalesce(nr_seq_proc_interno_w,0) > 0) then
				select	count(*)
				into STRICT	cont_w
				from 	pessoa_fisica d,
						proc_interno c where		c.nr_sequencia		= nr_seq_proc_interno_w
				and		d.cd_pessoa_fisica	= cd_pessoa_fisica_w
				and		obter_idade(d.dt_nascimento,clock_timestamp(),'M') between coalesce(c.qt_idade_min_meses,0) and coalesce(c.qt_idade_max_meses,9999) LIMIT 1;

				if	not(cont_w > 0) then
					nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 112, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
				end if;
			elsif (coalesce(nr_seq_exame_w,0) > 0) then
				/* Verifica se existe alguma regra cadastrada para aquele exame */

				select	count(*)
				into STRICT	cont_w
				from    exame_lab_orientacao where		nr_seq_exame 		= nr_seq_exame_w
				and     qt_idade_w	between coalesce(qt_idade_min,0) and coalesce(qt_idade_max,9999)
				and		coalesce(coalesce(cd_estabelecimento,cd_estabelecimento_w),0) = coalesce(cd_estabelecimento_w,0)
				and     ((ie_sexo 	= ie_sexo_w) or (ie_sexo = 'I')) LIMIT 1;

				if (cont_w > 0) then
					nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 112, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
				end if;
			end if;

		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(280,cd_perfil_p) = 'S') and (ie_sexo_w = 'F') and (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') then

			select	coalesce(max(ie_exige_menstruacao),'N')
			into STRICT	ie_exige_menstruacao_w
			from	exame_laboratorio
			where	nr_seq_exame	= nr_seq_exame_w;

			if (ie_exige_menstruacao_w = 'S') then

				select	max(dt_ult_menstruacao)
				into STRICT	dt_ult_menstruacao_w
				from 	historico_saude_mulher		a where 	a.cd_pessoa_fisica = cd_pessoa_fisica_w LIMIT 1;

				select	max(dt_ultima_menstruacao)
				into STRICT	dt_ultima_menstruacao_w
				from 	med_pac_pre_natal		a where 	a.nr_atendimento = nr_atendimento_w LIMIT 1;

				if (coalesce(dt_ult_menstruacao_w::text, '') = '' and coalesce(dt_ultima_menstruacao_w::text, '') = '') then
					ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(280, cd_perfil_p);
					nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 280, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
				end if;

			end if;

		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(115,cd_perfil_p) = 'S') and (obter_se_paciente_acessorio(cd_pessoa_fisica_w, cd_procedimento_w, ie_origem_proced_w) = 'S') then

			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(115, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 115, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(116,cd_perfil_p) = 'S') and (obter_se_exame_convenio(cd_estabelecimento_w, nr_seq_exame_w, cd_procedimento_w, ie_origem_proced_w, ie_tipo_atendimento_w, cd_convenio_w, cd_categoria_w,clock_timestamp(), nr_seq_proc_interno_w) = 'N') then

			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(116, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 116, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_tipo_protocolo_w = 'C') and (nr_seq_prot_glic_w IS NOT NULL AND nr_seq_prot_glic_w::text <> '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(118,cd_perfil_p) = 'S') and (verificar_protocolo_ccg(nr_seq_prot_glic_w, nr_prescricao_p, nr_seq_proced_w) = 'N') then

			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(118, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 118, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		if (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(122,cd_perfil_p) = 'S') then
			select	count(*)
			into STRICT	cont_w
			from 	pessoa_fisica		c where		c.cd_pessoa_fisica	= cd_medico_w
			and		coalesce(c.nr_seq_cbo_saude::text, '') = '' LIMIT 1;

			if (cont_w > 0) then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(122, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 122, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;

		end if;

		if (cd_cgc_solic_w IS NOT NULL AND cd_cgc_solic_w::text <> '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(123,cd_perfil_p) = 'S') then

			select	count(*)
			into STRICT	cont_w
			from 	pessoa_juridica c where		c.cd_cgc = cd_cgc_solic_w
			and		coalesce(c.cd_cnes::text, '') = '' LIMIT 1;

			if (cont_w > 0) then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(123, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 123, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (cd_tipo_convenio_w = 3) and
			((coalesce(nr_horas_sus_w,0) = 0) or ((dt_entrada_w + nr_horas_sus_w/24) < clock_timestamp())) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(125,cd_perfil_p) = 'S') then

			select	count(*)
			into STRICT	cont_w
			from	sus_procedimento b where	b.cd_procedimento	= cd_procedimento_w
			and	b.ie_origem_proced	= ie_origem_proced_w
			and	not exists (	SELECT	1
						from	sus_laudo_paciente x
						where	x.nr_atendimento	= nr_atendimento_w) LIMIT 1;
						--and	x.ie_classificacao	= 1

						--and	x.ie_tipo_laudo_sus	= 2);
			if (cont_w > 0) then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(125, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 125, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;

		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') and (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(135,cd_perfil_p) = 'S') then

			begin
				ds_horarios_inconsistentes_w	:= Obter_Se_hor_validade_proced(nr_prescricao_p, nr_seq_proced_w);
			exception when others then
				ds_horarios_inconsistentes_w := null;
			end;

			if (ds_horarios_inconsistentes_w IS NOT NULL AND ds_horarios_inconsistentes_w::text <> '') then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(135, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 135, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;

		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (coalesce(ds_horarios_w::text, '') = '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(193,cd_perfil_p) = 'S') then
			begin

			select	coalesce(max(ie_operacao),'')
			into STRICT	ie_operacao_w
			from	intervalo_prescricao
			where	cd_intervalo = cd_intervalo_w;

			/*
				Esse tratamento  foi efetuado devido a OS  787751, conforme acordado em conjunto com Dr. Haertel e Jaqueline.
			*/
			if (nr_hora_validade_w < 24) and (ie_operacao_w =  'V') and (dt_prev_execucao_w IS NOT NULL AND dt_prev_execucao_w::text <> '') and
				(dt_prev_execucao_w >= dt_inicio_prescr_w AND dt_prev_execucao_w < dt_validade_prescr_w) then
				ie_erro_liberar_prescr_w := '';
			else
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(193, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 193, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;

			end;
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(136,cd_perfil_p) = 'S') /*and
			(ds_observacao_w is null) */
then

			select	coalesce(max('S'),'N')
			into STRICT	ie_regra_indic_clinica_obrig_w
			from	regra_indic_clinica_obrig where	coalesce(nr_seq_exame_lab,nr_seq_exame_w,0)		= coalesce(nr_seq_exame_w,0)
			and	coalesce(nr_seq_grupo_lab,nr_seq_grupo_exame_w,0)	= coalesce(nr_seq_grupo_exame_w,0)
			and	coalesce(nr_seq_exame_interno,nr_seq_proc_interno_w,0)	= coalesce(nr_seq_proc_interno_w,0)
			and	coalesce(cd_area_procedimento,cd_area_procedimento_w,0)	= coalesce(cd_area_procedimento_w,0)
			and	coalesce(cd_especialidade,cd_especialidade_proced_w,0)	= coalesce(cd_especialidade_proced_w,0)
			and	coalesce(cd_grupo_proc,cd_grupo_procedimento_w,0)	= coalesce(cd_grupo_procedimento_w,0)
			and	coalesce(cd_procedimento,cd_procedimento_w,0)		= coalesce(cd_procedimento_w,0)
			and	coalesce(ie_origem_proced,ie_origem_proced_w,0)		= coalesce(ie_origem_proced_w,0)
			and	coalesce(cd_intervalo,cd_intervalo_w,'XPTO')			= coalesce(cd_intervalo_w,'XPTO')
			and	coalesce(nr_seq_subgrupo,nr_seq_subgrupo_w)			= nr_seq_subgrupo_w
			and	coalesce(cd_convenio, cd_convenio_w)				= cd_convenio_w
			and	coalesce(cd_perfil,cd_perfil_p,0)			= coalesce(cd_perfil_p,0)
			and	coalesce(cd_setor_prescricao,cd_setor_prescricao_w,0)	= coalesce(cd_setor_prescricao_w,0)
			and	coalesce(cd_setor_executor,cd_setor_atendimento_w,0)	= coalesce(cd_setor_atendimento_w,0)
			and	coalesce(cd_tipo_procedimento, cd_tipo_procedimento_w,0) = coalesce(cd_tipo_procedimento_w,0)
			and	coalesce(ie_tipo_convenio, cd_tipo_convenio_w,0)	= coalesce(cd_tipo_convenio_w,0)
			and	Obter_Regra_obrig_proc(nr_sequencia, ie_tipo_atendimento_w, cd_material_exame_w) = 'S'
			and	(((coalesce(qt_minimo_caracter,0) = 0) and (coalesce(ds_observacao_w::text, '') = '')) or (coalesce(length(ds_observacao_w),0) < qt_minimo_caracter))
			and	cd_estabelecimento	= cd_estab_prescr_w
			and	((coalesce(hr_prev_inicial::text, '') = '') or (to_char(dt_prev_execucao_w,'hh24:mi')	>= substr(hr_prev_inicial,1,5)))
			and	((coalesce(hr_prev_final::text, '') = '') or (to_char(dt_prev_execucao_w,'hh24:mi')	<= substr(hr_prev_final,1,5)))
			and	coalesce(ie_campo_obriga,'0') = '5' LIMIT 1;

			if (ie_regra_indic_clinica_obrig_w = 'S') then
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 136, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;

		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (coalesce(nr_seq_contraste_w::text, '') = '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(178,cd_perfil_p) = 'S') then

			select	coalesce(max('S'),'N')
			into STRICT	ie_regra_indic_clinica_obrig_w
			from	regra_indic_clinica_obrig where	coalesce(nr_seq_exame_lab,nr_seq_exame_w,0)		= coalesce(nr_seq_exame_w,0)
			and	coalesce(nr_seq_grupo_lab,nr_seq_grupo_exame_w,0)	= coalesce(nr_seq_grupo_exame_w,0)
			and	coalesce(nr_seq_exame_interno,nr_seq_proc_interno_w,0)	= coalesce(nr_seq_proc_interno_w,0)
			and	coalesce(cd_area_procedimento,cd_area_procedimento_w,0)	= coalesce(cd_area_procedimento_w,0)
			and	coalesce(cd_especialidade,cd_especialidade_proced_w,0)	= coalesce(cd_especialidade_proced_w,0)
			and	coalesce(cd_grupo_proc,cd_grupo_procedimento_w,0)	= coalesce(cd_grupo_procedimento_w,0)
			and	coalesce(cd_procedimento,cd_procedimento_w,0)		= coalesce(cd_procedimento_w,0)
			and	coalesce(ie_origem_proced,ie_origem_proced_w,0)		= coalesce(ie_origem_proced_w,0)
			and	coalesce(cd_intervalo,cd_intervalo_w,'XPTO')			= coalesce(cd_intervalo_w,'XPTO')
			and	coalesce(nr_seq_subgrupo,nr_seq_subgrupo_w)			= nr_seq_subgrupo_w
			and	coalesce(cd_convenio, cd_convenio_w)				= cd_convenio_w
			and	coalesce(cd_perfil,cd_perfil_p,0)			= coalesce(cd_perfil_p,0)
			and	coalesce(cd_setor_prescricao,cd_setor_prescricao_w,0)	= coalesce(cd_setor_prescricao_w,0)
			and	coalesce(cd_setor_executor,cd_setor_atendimento_w,0)	= coalesce(cd_setor_atendimento_w,0)
			and	coalesce(cd_tipo_procedimento, cd_tipo_procedimento_w,0) = coalesce(cd_tipo_procedimento_w,0)
			and	coalesce(ie_tipo_convenio, cd_tipo_convenio_w,0)	= coalesce(cd_tipo_convenio_w,0)
			and	Obter_Regra_obrig_proc(nr_sequencia, ie_tipo_atendimento_w, cd_material_exame_w) = 'S'
			and	(((coalesce(qt_minimo_caracter,0) = 0) and (coalesce(ds_observacao_w::text, '') = '')) or (coalesce(length(ds_observacao_w),0) < qt_minimo_caracter))
			and	cd_estabelecimento	= cd_estab_prescr_w
			and	((coalesce(hr_prev_inicial::text, '') = '') or (to_char(dt_prev_execucao_w,'hh24:mi')	>= substr(hr_prev_inicial,1,5)))
			and	((coalesce(hr_prev_final::text, '') = '') or (to_char(dt_prev_execucao_w,'hh24:mi')	<= substr(hr_prev_final,1,5)))
			and	coalesce(ie_campo_obriga,'0') = '7' LIMIT 1;

			if (ie_regra_indic_clinica_obrig_w = 'S') then
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 178, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;

		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(137,cd_perfil_p) = 'S') then

			select	max(substr(Obter_Descricao_Procedimento(a.cd_proced_regra,a.ie_origem_proced_regra),1,255)),
					max(substr(Obter_Descricao_Procedimento(a.cd_procedimento,a.ie_origem_proced),1,255)),
					coalesce(max(a.cd_procedimento),0),
					coalesce(max(a.cd_proced_regra),0)
			into STRICT	ds_proced_regra_w,
					ds_proced_w,
					cd_procedimento_ww,
					cd_proced_regra_w
			from	regra_proced_exclusivo a,
					prescr_procedimento b
			where	b.nr_prescricao		= nr_prescricao_p
			and		a.cd_procedimento	= coalesce(b.cd_procedimento,0)
			and		a.ie_origem_proced_regra	= coalesce(b.ie_origem_proced,0)
			AND		a.cd_proced_regra  = coalesce(cd_procedimento_w, a.cd_proced_regra)
			and 	exists (	SELECT	1
								from 	prescr_procedimento c
								where	b.nr_prescricao		= c.nr_prescricao
								and		c.cd_procedimento	= a.cd_proced_regra  LIMIT 1);


			if (ds_proced_regra_w IS NOT NULL AND ds_proced_regra_w::text <> '') and (cd_procedimento_w in (cd_proced_regra_w)) then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep( 137, cd_perfil_p);
				ds_proced_regra_w	:= Wheb_mensagem_pck.get_texto(306506, 'DS_PROCED_REGRA_W=' || ds_proced_regra_w || ';' || 'DS_PROCED_W=' || ds_proced_w); -- O procedimento #@DS_PROCED_REGRA_W#@ interage com o procedimento #@DS_PROCED_W#@
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 137, ie_erro_liberar_prescr_w, ds_proced_regra_w, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;

		end if;

		ie_erro_liberar_prescr_w	:= '';

		if	((coalesce(nr_seq_prot_glic_w::text, '') = '') or (ie_tipo_protocolo_w	= 'I')) and (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(143,cd_perfil_p) = 'S') and (obter_ctrl_glic_proc(nr_seq_proc_interno_w) = 'CCG') then

			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 143, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (coalesce(nr_seq_exame_w::text, '') = '') and (coalesce(nr_seq_solic_sangue_w::text, '') = '') and (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(145,cd_perfil_p) = 'S') then

			begin
				ds_horarios_inconsistentes_w	:= Obter_Se_hor_validade_proced(nr_prescricao_p, nr_seq_proced_w);
			exception when others then
				ds_horarios_inconsistentes_w := null;
			end;

			if (ds_horarios_inconsistentes_w IS NOT NULL AND ds_horarios_inconsistentes_w::text <> '') then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(145, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 145, ie_erro_liberar_prescr_w, Wheb_mensagem_pck.get_texto(306508, 'DS_HORARIOS_INCONSISTENTES_P=' || ds_horarios_inconsistentes_w), cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w); --  Horarios inconsistentes: #@DS_HORARIOS_INCONSISTENTES_P#@
			end if;
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (nr_seq_solic_sangue_w IS NOT NULL AND nr_seq_solic_sangue_w::text <> '') then
			ds_consistencia_hemo_w := Consiste_solic_hemocomponente(nr_seq_solic_sangue_w, nr_seq_derivado_w, cd_estabelecimento_w, nm_usuario_p, ds_consistencia_hemo_w);
		end if;



			select coalesce(max(ie_proced_hemoterapico),'N')
			into STRICT nr_seq_outras_w
			from san_derivado
			where nr_Sequencia = nr_seq_derivado_w;

		if ((nr_seq_solic_sangue_w IS NOT NULL AND nr_seq_solic_sangue_w::text <> '') or ((nr_seq_derivado_w IS NOT NULL AND nr_seq_derivado_w::text <> '') and (nr_seq_outras_w =  'S') and (ie_tipo_proced_w in ('BS','AT'))))and (ie_hemoglobina_w = 'S') and (coalesce(qt_hemoglobina_w::text, '') = '') and
			((coalesce(ie_reserva_w,'N') = 'N') or (VarIeConsisteReservado_w = 'S')) and
			((ie_tipo_w <> 1) or (ie_consiste_programado_w = 'S')) and
			((ie_consiste_extrema_w	= 'S') or (ie_tipo_w		<> 4)) and
			((ie_consiste_urgencia_w = 'S') or (ie_tipo_w		<> 3))  and (ds_consistencia_hemo_w IS NOT NULL AND ds_consistencia_hemo_w::text <> '') and
			((ie_consiste_hemo_confirmada_w = 'N') or (ie_util_hemocomponente_w = 'C')) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(146,cd_perfil_p) = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(146, cd_perfil_p);

			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 146, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';
		if ((nr_seq_solic_sangue_w IS NOT NULL AND nr_seq_solic_sangue_w::text <> '') or ((nr_seq_derivado_w IS NOT NULL AND nr_seq_derivado_w::text <> '') and (nr_seq_outras_w =  'S') and (ie_tipo_proced_w in ('BS','AT'))))and (ie_hematocrito_w = 'S') and (coalesce(qt_hematocrito_w::text, '') = '') and
			((coalesce(ie_reserva_w,'N') = 'N') or (VarIeConsisteReservado_w = 'S')) and
			((ie_tipo_w <> 1) or (ie_consiste_programado_w = 'S')) and
			((ie_consiste_extrema_w	= 'S') or (ie_tipo_w		<> 4)) and
			((ie_consiste_urgencia_w = 'S') or (ie_tipo_w		<> 3))  and (ds_consistencia_hemo_w IS NOT NULL AND ds_consistencia_hemo_w::text <> '') and
			((ie_consiste_hemo_confirmada_w = 'N') or (ie_util_hemocomponente_w = 'C')) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(147,cd_perfil_p) = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(147, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 147, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';
		if ((nr_seq_solic_sangue_w IS NOT NULL AND nr_seq_solic_sangue_w::text <> '') or ((nr_seq_derivado_w IS NOT NULL AND nr_seq_derivado_w::text <> '') and (nr_seq_outras_w =  'S') and (ie_tipo_proced_w in ('BS','AT'))))and (ie_consiste_ambos_w = 'S') and (coalesce(qt_hemoglobina_w::text, '') = '') and (coalesce(qt_hematocrito_w::text, '') = '') and
			((coalesce(ie_reserva_w,'N') = 'N') or (VarIeConsisteReservado_w = 'S')) and
			((ie_tipo_w <> 1) or (ie_consiste_programado_w = 'S')) and
			((ie_consiste_extrema_w	= 'S') or (ie_tipo_w		<> 4)) and
			((ie_consiste_urgencia_w = 'S') or (ie_tipo_w		<> 3))  and (ds_consistencia_hemo_w IS NOT NULL AND ds_consistencia_hemo_w::text <> '') and
			((ie_consiste_hemo_confirmada_w = 'N') or (ie_util_hemocomponente_w = 'C')) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(182,cd_perfil_p) = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(182, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 182, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';
		if ((nr_seq_solic_sangue_w IS NOT NULL AND nr_seq_solic_sangue_w::text <> '') or ((nr_seq_derivado_w IS NOT NULL AND nr_seq_derivado_w::text <> '') and (nr_seq_outras_w =  'S') and (ie_tipo_proced_w in ('BS','AT'))))and (ie_fibrinogenio_w = 'S') and (coalesce(qt_fibrinogenio_w::text, '') = '') and
			((coalesce(ie_reserva_w,'N') = 'N') or (VarIeConsisteReservado_w = 'S')) and
			((ie_tipo_w <> 1) or (ie_consiste_programado_w = 'S')) and
			((ie_consiste_extrema_w	= 'S') or (ie_tipo_w		<> 4)) and
			((ie_consiste_urgencia_w = 'S') or (ie_tipo_w		<> 3)) and
			((ie_consiste_hemo_confirmada_w = 'N') or (ie_util_hemocomponente_w = 'C')) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(162,cd_perfil_p) = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(162, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 162, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';
		if ((nr_seq_solic_sangue_w IS NOT NULL AND nr_seq_solic_sangue_w::text <> '') or ((nr_seq_derivado_w IS NOT NULL AND nr_seq_derivado_w::text <> '') and (nr_seq_outras_w =  'S') and (ie_tipo_proced_w in ('BS','AT'))))and (ie_plaquetas_w = 'S') and (coalesce(qt_plaqueta_w::text, '') = '') and
			((coalesce(ie_reserva_w,'N') = 'N') or (VarIeConsisteReservado_w = 'S')) and
			((ie_tipo_w <> 1) or (ie_consiste_programado_w = 'S')) and
			((ie_consiste_extrema_w	= 'S') or (ie_tipo_w		<> 4)) and
			((ie_consiste_urgencia_w = 'S') or (ie_tipo_w		<> 3))  and (ds_consistencia_hemo_w IS NOT NULL AND ds_consistencia_hemo_w::text <> '') and
			((ie_consiste_hemo_confirmada_w = 'N') or (ie_util_hemocomponente_w = 'C')) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(148,cd_perfil_p) = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(148, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 148, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';
		if ((nr_seq_solic_sangue_w IS NOT NULL AND nr_seq_solic_sangue_w::text <> '') or ((nr_seq_derivado_w IS NOT NULL AND nr_seq_derivado_w::text <> '') and (nr_seq_outras_w =  'S') and (ie_tipo_proced_w in ('BS','AT'))))and
			((coalesce(ie_reserva_w,'N') = 'N') or (VarIeConsisteReservado_w = 'S')) and
			((ie_tipo_w <> 1) or (ie_consiste_programado_w = 'S')) and
			((ie_consiste_urgencia_w = 'S') or (ie_tipo_w		<> 3)) and
			((ie_consiste_extrema_w	= 'S') or (ie_tipo_w		<> 4)) and
			(((ie_tap_w = 'S') and (coalesce(qt_tap_w::text, '') = '') and (coalesce(qt_tap_inr_w::text, '') = '') and (coalesce(qt_ttpa_w::text, '') = '') and (coalesce(qt_ttpa_rel_w::text, '') = '')) or
			 ((ie_inr_w = 'S') and (coalesce(qt_tap_inr_w::text, '') = ''))) and (ds_consistencia_hemo_w IS NOT NULL AND ds_consistencia_hemo_w::text <> '') and
			((ie_consiste_hemo_confirmada_w = 'N') or (ie_util_hemocomponente_w = 'C')) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(149,cd_perfil_p) = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(149, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 149, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_consiste_fpo_w	<> 'N') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(153,cd_perfil_p) = 'S') then

			ds_retorno_fpo_w := sus_consiste_fpo_unif(dt_prev_execucao_w, cd_procedimento_w, ie_origem_proced_w, qt_procedimento_w, nr_atendimento_w, cd_estabelecimento_w, ie_tipo_atendimento_w, '0', ie_consiste_fpo_w, ds_retorno_fpo_w, cd_setor_proced_w, cd_procedencia_w, nm_usuario_p);

			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(153, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 153, ie_erro_liberar_prescr_w, ds_retorno_fpo_w, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if	((ds_horarios_w	<> 'SN' AND ie_se_necessario_w = 'S') or
			(ds_horarios_w	<> 'ACM' AND ie_acm_w = 'S') or
			((coalesce(ie_se_necessario_w, 'N') = 'N') and (coalesce(ie_acm_w,'N') = 'N'))) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(158,cd_perfil_p) = 'S') then

			ds_hor_aux_w	:= replace(replace(ds_horarios_w,' ',''),':','');
			x	:= 1;
			while(x	< length(ds_horarios_w)) loop
				if (substr(ds_hor_aux_w,x,1) not in ('0','1','2','3','4','5','6','7','8','9')) then
					ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(158, cd_perfil_p);
					nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 158, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
					exit;
				end if;
				x	:= x + 1;
			end loop;
		end if;

		if (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') and (coalesce(cd_senha_w::text, '') = '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(159,cd_perfil_p) = 'S') then
			begin
				ie_autorizacao_w := Obter_Autor_Exame_Lab_Convenio(nr_seq_Exame_w, cd_convenio_w, cd_categoria_w, ie_tipo_atendimento_w, wheb_usuario_pck.get_cd_estabelecimento, cd_tipo_convenio_w, nr_seq_proc_interno_w, ie_autorizacao_w);
				if (ie_autorizacao_w	= 'LS') then
					ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(159, cd_perfil_p);
					nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 159, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
				end if;
			exception when others then
				null;
			end;
		end if;


		if (nr_seq_Exame_w IS NOT NULL AND nr_seq_Exame_w::text <> '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(160,cd_perfil_p) = 'S') then
			begin
				ie_autorizacao_w := Obter_Autor_Exame_Lab_Convenio(nr_seq_Exame_w, cd_convenio_w, cd_categoria_w, ie_tipo_atendimento_w, wheb_usuario_pck.get_cd_estabelecimento, cd_tipo_convenio_w, nr_seq_proc_interno_w, ie_autorizacao_w);
				if (ie_autorizacao_w	= 'NL') then
					ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(160, cd_perfil_p);
					nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 160, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
				end if;
			exception when others then
				null;
			end;
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_justif_hemo_w	 = 'S') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(164,cd_perfil_p) = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(164, cd_perfil_p);
			if (coalesce(ds_justificativa_w::text, '') = '') then
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 164, ie_erro_liberar_prescr_w, ds_retorno_fpo_w, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			else
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 164, ie_erro_liberar_prescr_w, ds_retorno_fpo_w, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w, 'S');
			end if;
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (nr_seq_solic_sangue_w IS NOT NULL AND nr_seq_solic_sangue_w::text <> '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(169,cd_perfil_p) = 'S') then
			select	coalesce(max('S'),'N')
			into STRICT	ie_obriga_indicacao_w
			from	prescr_sol_bs_indicacao a,
					san_indicacao b where		a.nr_seq_indicacao	= b.nr_sequencia
			and 	a.nr_seq_solic_bs	= nr_seq_solic_sangue_w
			and 	coalesce(a.ds_indicacao_adic::text, '') = ''
			and 	coalesce(b.ie_permite_outras,'N') = 'S' LIMIT 1;

			if (ie_obriga_indicacao_w = 'S') then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(169, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 169, ie_erro_liberar_prescr_w, ds_retorno_fpo_w, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
		end if;


		if (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(171,cd_perfil_p) = 'S') then
			select	coalesce(max(ie_exige_responsavel),'N')
			into STRICT	ie_exige_responsavel_w
			from	proc_interno
			where	nr_sequencia	= nr_seq_proc_interno_w;

			if (ie_exige_responsavel_w	= 'S') and (coalesce(cd_pessoa_responsavel_w::text, '') = '') then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(171, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 171, ie_erro_liberar_prescr_w, ds_retorno_fpo_w, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(172,cd_perfil_p) = 'S') and (Obter_se_proc_duplic_regra(cd_procedimento_w, ie_origem_proced_w, dt_prescricao_w, ie_tipo_atendimento_w, cd_pessoa_fisica_w, nr_prescricao_p, ie_lado_w, ie_consiste_mesma_prescr_w, nr_seq_proced_w) = 'S') then

			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(172, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 172, ie_erro_liberar_prescr_w, ds_retorno_fpo_w, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_consistir_setor_proced_w = 'S') and (ie_setor_exec_Exame_w = 'N') and (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(173,cd_perfil_p) = 'S') then

			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 173, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);

		end if;

		ie_erro_liberar_prescr_w	:= '';

		-- prescricao permitida no pep (emr)
		if (nr_seq_derivado_w IS NOT NULL AND nr_seq_derivado_w::text <> '') and (nr_seq_solic_sangue_w IS NOT NULL AND nr_seq_solic_sangue_w::text <> '') and (ie_tipo_proced_w in ('BS','AT','ST')) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(288,cd_perfil_p) = 'S') then

			select count(pp.NR_PRESCRICAO)
			into STRICT	cont_w
			from    DIRETRIZ_ATEND_PARAM_CONS a,
					DIRETRIZ_ATENDIMENTO_PARAM b,
					PRESCR_PROCEDIMENTO pp,
					PRESCR_MEDICA pm,
					SAN_DERIVADO c
			where
			  a.NR_SEQ_DIRETRIZ = b.NR_SEQUENCIA
			  and a.NR_SEQ_DERIVADO = c.NR_SEQUENCIA
			  and pp.NR_SEQ_DERIVADO = a.NR_SEQ_DERIVADO
			  and pm.CD_FUNCAO_ORIGEM = 2314
			  and pp.NR_PRESCRICAO = pm.NR_PRESCRICAO
			  and b.IE_DIRETRIZ = 'TS'
			  and pm.NR_PRESCRICAO = nr_prescricao_p
			  and exists (SELECT da.cd_pessoa_fisica
						   from DIRETRIZ_ATENDIMENTO da
							where da.IE_DIRETRIZ = 'TS'
							and da.IE_RESPOSTA = 'N'
							and (da.DT_LIBERACAO IS NOT NULL AND da.DT_LIBERACAO::text <> '')
							and coalesce(da.DT_INATIVACAO::text, '') = ''
							and da.IE_STATUS = 'C'
							and da.cd_pessoa_fisica = pm.cd_pessoa_fisica)
							and a.NR_SEQ_DERIVADO in (select  a.NR_SEQ_DERIVADO
													  from    DIRETRIZ_ATEND_PARAM_CONS a,
															  DIRETRIZ_ATENDIMENTO_PARAM b,
															  SAN_DERIVADO c
													  where a.NR_SEQ_DIRETRIZ = b.NR_SEQUENCIA
															and a.NR_SEQ_DERIVADO = c.NR_SEQUENCIA
															and b.IE_DIRETRIZ = 'TS');

			if (cont_w > 0) then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(288, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 288, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;

		end if;

		if (nr_seq_derivado_w IS NOT NULL AND nr_seq_derivado_w::text <> '') and (nr_seq_solic_sangue_w IS NOT NULL AND nr_seq_solic_sangue_w::text <> '') and (ie_tipo_proced_w in ('BS','AT','ST')) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(299,cd_perfil_p) = 'S') then

			select	count(1)
			into STRICT	cont_w
			from	diretriz_atendimento a
			where	a.ie_status = 'C'
			and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			and	a.ie_diretriz = 'TS'
			and	coalesce(a.dt_inativacao::text, '') = ''
			and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w;

			if (cont_w = 0) then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(299, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 299, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
		end if;

		
		
	ie_erro_liberar_prescr_w	:= '';
	if (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(289,cd_perfil_p) = 'S') then
		    select count(pp.NR_PRESCRICAO)
		    into STRICT	cont_w
		    from    DIRETRIZ_ATEND_PARAM_CONS a,
			    DIRETRIZ_ATENDIMENTO_PARAM b,
			    PRESCR_PROCEDIMENTO pp,
			    PRESCR_MEDICA pm
		    where
		    a.NR_SEQ_DIRETRIZ = b.NR_SEQUENCIA
		    and pm.CD_FUNCAO_ORIGEM = 2314
		    and pp.NR_SEQ_PROC_INTERNO = a.NR_SEQ_PROC_INTERNO
		    and b.IE_DIRETRIZ IN ('I','SV')
		    and pp.NR_PRESCRICAO = pm.NR_PRESCRICAO
		    and pm.NR_PRESCRICAO = nr_prescricao_p
		    and exists (SELECT da.cd_pessoa_fisica
				from DIRETRIZ_ATENDIMENTO da
				    where da.IE_DIRETRIZ IN ('I','SV')
				    and da.IE_RESPOSTA = 'N'
				    and (da.DT_LIBERACAO IS NOT NULL AND da.DT_LIBERACAO::text <> '')
				    and coalesce(da.DT_INATIVACAO::text, '') = ''
				    and da.IE_STATUS = 'C'
				    and da.cd_pessoa_fisica = pm.cd_pessoa_fisica)
				    and a.NR_SEQ_PROC_INTERNO in (select  a.NR_SEQ_PROC_INTERNO
							    from    DIRETRIZ_ATEND_PARAM_CONS a,
								    DIRETRIZ_ATENDIMENTO_PARAM b
							    where a.NR_SEQ_DIRETRIZ = b.NR_SEQUENCIA
								    and b.IE_DIRETRIZ IN ('I','SV'));

		    if (cont_w > 0) then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(289, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 289, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		    end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';
	if (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(292,cd_perfil_p) = 'S') then
		    select count(pp.NR_PRESCRICAO)
		    into STRICT	cont_w
		    from    DIRETRIZ_ATEND_PARAM_CONS a,
			    DIRETRIZ_ATENDIMENTO_PARAM b,
			    PRESCR_PROCEDIMENTO pp,
			    PRESCR_MEDICA pm
		    where
		    a.NR_SEQ_DIRETRIZ = b.NR_SEQUENCIA
		    and pm.CD_FUNCAO_ORIGEM = 2314
		    and pp.NR_SEQ_PROC_INTERNO = a.NR_SEQ_PROC_INTERNO
		    and b.IE_DIRETRIZ = 'R'
		    and pp.NR_PRESCRICAO = pm.NR_PRESCRICAO
		    and pm.NR_PRESCRICAO = nr_prescricao_p
		    and exists (SELECT da.cd_pessoa_fisica
				from DIRETRIZ_ATENDIMENTO da
				    where da.IE_DIRETRIZ = 'R'
				    and da.IE_RESPOSTA = 'N'
				    and (da.DT_LIBERACAO IS NOT NULL AND da.DT_LIBERACAO::text <> '')
				    and coalesce(da.DT_INATIVACAO::text, '') = ''
				    and da.IE_STATUS = 'C'
				    and da.cd_pessoa_fisica = pm.cd_pessoa_fisica)
				    and a.NR_SEQ_PROC_INTERNO in (select  a.NR_SEQ_PROC_INTERNO
							    from    DIRETRIZ_ATEND_PARAM_CONS a,
								    DIRETRIZ_ATENDIMENTO_PARAM b
							    where a.NR_SEQ_DIRETRIZ = b.NR_SEQUENCIA
								    and b.IE_DIRETRIZ = 'R');

		    if (cont_w > 0) then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(292, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 292, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		    end if;
	end if;

	ie_erro_liberar_prescr_w	:= '';
	if (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(291,cd_perfil_p) = 'S') then
		    select count(pp.NR_PRESCRICAO)
		    into STRICT	cont_w
		    from    DIRETRIZ_ATEND_PARAM_CONS a,
			    DIRETRIZ_ATENDIMENTO_PARAM b,
			    PRESCR_PROCEDIMENTO pp,
			    PRESCR_MEDICA pm
		    where
		    a.NR_SEQ_DIRETRIZ = b.NR_SEQUENCIA
		    and pm.CD_FUNCAO_ORIGEM = 2314
		    and pp.NR_SEQ_PROC_INTERNO = a.NR_SEQ_PROC_INTERNO
		    and b.IE_DIRETRIZ = 'MC'
		    and pp.NR_PRESCRICAO = pm.NR_PRESCRICAO
		    and pm.NR_PRESCRICAO = nr_prescricao_p
		    and exists (SELECT da.cd_pessoa_fisica
				from DIRETRIZ_ATENDIMENTO da
				    where da.IE_DIRETRIZ = 'MC'
				    and da.IE_RESPOSTA = 'N'
				    and (da.DT_LIBERACAO IS NOT NULL AND da.DT_LIBERACAO::text <> '')
				    and coalesce(da.DT_INATIVACAO::text, '') = ''
				    and da.IE_STATUS = 'C'
				    and da.cd_pessoa_fisica = pm.cd_pessoa_fisica)
				    and a.NR_SEQ_PROC_INTERNO in (select  a.NR_SEQ_PROC_INTERNO
							    from    DIRETRIZ_ATEND_PARAM_CONS a,
								    DIRETRIZ_ATENDIMENTO_PARAM b
							    where a.NR_SEQ_DIRETRIZ = b.NR_SEQUENCIA
								    and b.IE_DIRETRIZ = 'MC');

		    if (cont_w > 0) then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(291, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 291, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		    end if;
	end if;

		if (nr_seq_derivado_w IS NOT NULL AND nr_seq_derivado_w::text <> '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(175,cd_perfil_p) = 'S') then
			select	count(*)
			into STRICT	cont_w
			from	prescr_procedimento where	nr_prescricao	= nr_prescricao_p
			and	nr_sequencia	<> nr_seq_proced_w
			and	coalesce(ie_filtrado,'N')	= coalesce(ie_filtrado_w,'N')
			and	coalesce(ie_irradiado,'N')	= coalesce(ie_irradiado_w,'N')
			and	coalesce(ie_lavado,'N')	= coalesce(ie_lavado_w,'N') LIMIT 1;

			if (cont_w > 0) then
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 175, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
		end if;

		if (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(176,cd_perfil_p) = 'S') then
			select	count(*)
			into STRICT	cont_w
			from	prescr_procedimento where	nr_prescricao	= nr_prescricao_p
			and	(nr_seq_exame IS NOT NULL AND nr_seq_exame::text <> '')
			and	coalesce(ie_urgencia,'N') = 'N' LIMIT 1;

			if (cont_w = 0) then
				select	count(*)
				into STRICT	cont_w
				from	prescr_procedimento where	nr_prescricao	= nr_prescricao_p
				and	(nr_seq_exame IS NOT NULL AND nr_seq_exame::text <> '')
				and	coalesce(ie_urgencia,'N') = 'S' LIMIT 1;
			end if;

			if (cont_w > 0) then
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 176, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
		end if;


		if (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(177,cd_perfil_p) = 'S') and (obter_se_proced_lib_prescr(cd_procedimento_w, ie_origem_proced_w, nr_seq_exame_w, nr_seq_proc_interno_w, cd_perfil_p, cd_setor_prescricao_w, nm_usuario_p, cd_material_exame_w,nr_prescricao_p,'C', dt_prev_execucao_w) = 'N') then

			ds_mensagem_w	:= obter_se_proced_lib_prescr(cd_procedimento_w, ie_origem_proced_w, nr_seq_exame_w, nr_seq_proc_interno_w, cd_perfil_p, cd_setor_prescricao_w, nm_usuario_p, cd_material_exame_w,nr_prescricao_p,'D', dt_prev_execucao_w);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 177, 'N', ds_mensagem_w, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		if (nr_seq_Exame_w IS NOT NULL AND nr_seq_Exame_w::text <> '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(186,cd_perfil_p) = 'S') then
			select	max(cd_exame)
			into STRICT	cd_exame_w
			from	exame_laboratorio
			where	nr_seq_exame	= nr_seq_Exame_w;

			if (coalesce(cd_exame_w::text, '') = '') then
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 186, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
		end if;

		if (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(199,cd_perfil_p) = 'S') then
			if (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') then
				select	max(ie_sexo)
				into STRICT	ie_sexo_sus_w
				from	exame_laboratorio
				where	nr_seq_exame	= nr_seq_exame_w;
			else
				if (nr_seq_Proc_interno_w > 0) then
					select	max(a.ie_sexo),
		  max(coalesce(a.ie_exige_justif_sexo, 'N'))
					into STRICT	ie_sexo_sus_w,
		ie_exige_justif_sexo_w
					from	proc_interno a
					where	a.nr_sequencia = nr_seq_Proc_interno_w;
				end if;

				select	max(coalesce(ie_sexo_sus_w,ie_sexo_sus))
				into STRICT	ie_sexo_sus_w
				from	procedimento
				where	cd_procedimento		= cd_procedimento_w
				and		ie_origem_proced	= ie_origem_proced_w;
			end if;

			if (ie_sexo_sus_w IS NOT NULL AND ie_sexo_sus_w::text <> '') then
				select	max(ie_sexo)
				into STRICT	ie_sexo_paciente_w
				from	pessoa_fisica
				where	cd_pessoa_fisica	= cd_pessoa_fisica_w;

				if (ie_sexo_sus_w <> ie_sexo_paciente_w) then
	  if (cd_funcao_origem_w <> 2314) then
	    nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 199, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
	  else
	    select	max(coalesce(ie_forma_consistencia, 'N'))
	    into STRICT ie_erro_liberar_prescr_199_w
	    from	regra_consiste_prescr_par
	    where	nr_seq_regra 		= 199
	    and	coalesce(cd_perfil,cd_perfil_p)	= cd_perfil_p;

	    if (ie_erro_liberar_prescr_199_w <> 'X') then
	      if (ie_erro_liberar_prescr_199_w = 'S') then
		nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 199, 'S', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
	      elsif (ie_erro_liberar_prescr_199_w = 'N' and (ie_exige_justif_sexo_w = 'N' or (ie_exige_justif_sexo_w = 'S' and coalesce(ds_justificativa_w::text, '') = ''))) then
		nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 199, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
	      end if;
	    end if;

	  end if;
				end if;
			end if;
		end if;

		select	max(ie_exige_condicao)
		into STRICT	ie_exige_condicao_w
		from	proc_interno
		where	nr_sequencia	= nr_seq_proc_interno_w;

		if (coalesce(nr_seq_condicao_w::text, '') = '') and (ie_exige_condicao_w = 'S') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(201,cd_perfil_p) = 'S') then
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 201, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';
		if ((nr_seq_solic_sangue_w IS NOT NULL AND nr_seq_solic_sangue_w::text <> '') or ((nr_seq_derivado_w IS NOT NULL AND nr_seq_derivado_w::text <> '') and (nr_seq_outras_w =  'S') and (ie_tipo_proced_w in ('BS','AT'))))and (ie_obriga_albumina_w = 'S') and (coalesce(qt_albumina_w::text, '') = '') and
			((ie_tipo_w <> 1) or (ie_consiste_programado_w = 'S')) and
			((ie_consiste_extrema_w	= 'S') or (ie_tipo_w		<> 4)) and
			((ie_consiste_urgencia_w = 'S') or (ie_tipo_w		<> 3))  and (ds_consistencia_hemo_w IS NOT NULL AND ds_consistencia_hemo_w::text <> '') and
			((ie_consiste_hemo_confirmada_w = 'N') or (ie_util_hemocomponente_w = 'C')) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(207,cd_perfil_p) = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(207, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 207, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';
		if ((nr_seq_solic_sangue_w IS NOT NULL AND nr_seq_solic_sangue_w::text <> '') or ((nr_seq_derivado_w IS NOT NULL AND nr_seq_derivado_w::text <> '') and (nr_seq_outras_w =  'S') and (ie_tipo_proced_w in ('BS','AT'))))and (ie_obriga_calcio_w = 'S') and (coalesce(qt_calcio_w::text, '') = '') and
			((ie_tipo_w <> 1) or (ie_consiste_programado_w = 'S')) and
			((ie_consiste_extrema_w	= 'S') or (ie_tipo_w		<> 4)) and
			((ie_consiste_urgencia_w = 'S') or (ie_tipo_w		<> 3))  and (ds_consistencia_hemo_w IS NOT NULL AND ds_consistencia_hemo_w::text <> '') and
			((ie_consiste_hemo_confirmada_w = 'N') or (ie_util_hemocomponente_w = 'C')) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(208,cd_perfil_p) = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(208, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 208, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';
		if (nr_seq_solic_sangue_w IS NOT NULL AND nr_seq_solic_sangue_w::text <> '') and (ie_obriga_magnesio_w = 'S') and (coalesce(qt_magnesio_w::text, '') = '') and
			((ie_tipo_w <> 1) or (ie_consiste_programado_w = 'S')) and
			((ie_consiste_extrema_w	= 'S') or (ie_tipo_w		<> 4)) and
			((ie_consiste_urgencia_w = 'S') or (ie_tipo_w		<> 3))  and (ds_consistencia_hemo_w IS NOT NULL AND ds_consistencia_hemo_w::text <> '') and
			((ie_consiste_hemo_confirmada_w = 'N') or (ie_util_hemocomponente_w = 'C')) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(209,cd_perfil_p) = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(209, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 209, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';
		if ((nr_seq_solic_sangue_w IS NOT NULL AND nr_seq_solic_sangue_w::text <> '') or ((nr_seq_derivado_w IS NOT NULL AND nr_seq_derivado_w::text <> '') and (nr_seq_outras_w =  'S') and (ie_tipo_proced_w in ('BS','AT'))))and (ie_obriga_bili_dir_w = 'S') and (coalesce(qt_bilirrubina_dir_w::text, '') = '') and
			((ie_tipo_w <> 1) or (ie_consiste_programado_w = 'S')) and
			((ie_consiste_extrema_w	= 'S') or (ie_tipo_w		<> 4)) and
			((ie_consiste_urgencia_w = 'S') or (ie_tipo_w		<> 3))  and (ds_consistencia_hemo_w IS NOT NULL AND ds_consistencia_hemo_w::text <> '') and
			((ie_consiste_hemo_confirmada_w = 'N') or (ie_util_hemocomponente_w = 'C')) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(210,cd_perfil_p) = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(210, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 210, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';
		if ((nr_seq_solic_sangue_w IS NOT NULL AND nr_seq_solic_sangue_w::text <> '') or ((nr_seq_derivado_w IS NOT NULL AND nr_seq_derivado_w::text <> '') and (nr_seq_outras_w =  'S') and (ie_tipo_proced_w in ('BS','AT'))))and (ie_obriga_bili_ind_w = 'S') and (coalesce(qt_bilirrubina_ind_w::text, '') = '') and
			((ie_tipo_w <> 1) or (ie_consiste_programado_w = 'S')) and
			((ie_consiste_extrema_w	= 'S') or (ie_tipo_w		<> 4)) and
			((ie_consiste_urgencia_w = 'S') or (ie_tipo_w		<> 3))  and (ds_consistencia_hemo_w IS NOT NULL AND ds_consistencia_hemo_w::text <> '') and
			((ie_consiste_hemo_confirmada_w = 'N') or (ie_util_hemocomponente_w = 'C')) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(211,cd_perfil_p) = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(211, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 211, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';
		if ((nr_seq_solic_sangue_w IS NOT NULL AND nr_seq_solic_sangue_w::text <> '') or ((nr_seq_derivado_w IS NOT NULL AND nr_seq_derivado_w::text <> '') and (nr_seq_outras_w =  'S') and (ie_tipo_proced_w in ('BS','AT'))))and (ie_obriga_hemoglobina_s_w = 'S') and (coalesce(qt_hemoglobina_s_w::text, '') = '') and
			((ie_tipo_w <> 1) or (ie_consiste_programado_w = 'S')) and
			((ie_consiste_extrema_w	= 'S') or (ie_tipo_w		<> 4)) and
			((ie_consiste_urgencia_w = 'S') or (ie_tipo_w		<> 3))  and (ds_consistencia_hemo_w IS NOT NULL AND ds_consistencia_hemo_w::text <> '') and
			((ie_consiste_hemo_confirmada_w = 'N') or (ie_util_hemocomponente_w = 'C')) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(212,cd_perfil_p) = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(212, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 212, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';
		if ((nr_seq_solic_sangue_w IS NOT NULL AND nr_seq_solic_sangue_w::text <> '') or ((nr_seq_derivado_w IS NOT NULL AND nr_seq_derivado_w::text <> '') and (nr_seq_outras_w =  'S') and (ie_tipo_proced_w in ('BS','AT'))))and (ie_obriga_coombs_w = 'S') and (coalesce(ie_coombs_direto_w::text, '') = '') and
			((ie_tipo_w <> 1) or (ie_consiste_programado_w = 'S')) and
			((ie_consiste_extrema_w	= 'S') or (ie_tipo_w		<> 4)) and
			((ie_consiste_urgencia_w = 'S') or (ie_tipo_w		<> 3))  and (ds_consistencia_hemo_w IS NOT NULL AND ds_consistencia_hemo_w::text <> '') and
			((ie_consiste_hemo_confirmada_w = 'N') or (ie_util_hemocomponente_w = 'C')) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(213,cd_perfil_p) = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(213, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 213, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';
		if ((nr_seq_solic_sangue_w IS NOT NULL AND nr_seq_solic_sangue_w::text <> '') or ((nr_seq_derivado_w IS NOT NULL AND nr_seq_derivado_w::text <> '') and (nr_seq_outras_w =  'S') and (ie_tipo_proced_w in ('BS','AT'))))and (ie_obriga_coagulopatia_w = 'S') and (coalesce(ds_coagulopatia_w::text, '') = '') and
			((ie_tipo_w <> 1) or (ie_consiste_programado_w = 'S')) and
			((ie_consiste_extrema_w	= 'S') or (ie_tipo_w		<> 4)) and
			((ie_consiste_urgencia_w = 'S') or (ie_tipo_w		<> 3))  and (ds_consistencia_hemo_w IS NOT NULL AND ds_consistencia_hemo_w::text <> '') and
			((ie_consiste_hemo_confirmada_w = 'N') or (ie_util_hemocomponente_w = 'C')) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(222,cd_perfil_p) = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(222, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 222, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		if (coalesce(ie_proced_agora_w,'N') <> 'S') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(214,cd_perfil_p) = 'S') then

			select	count(*)
			into STRICT	cont_w
			from	setor_horario_atend where		cd_setor_atendimento = cd_setor_atendimento_w LIMIT 1;

			if (cont_w > 0) then

				select	count(*)
				into STRICT	cont_w
				from	setor_horario_atend where	cd_setor_atendimento = cd_setor_atendimento_w
				and	hr_prev_w = to_char(DT_HORARIO,'hh24:mi') LIMIT 1;

				if (cont_w = 0) then
					nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 214, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
				end if;
			end if;
		end if;

		if (coalesce(ie_anestesia_w::text, '') = '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(216,cd_perfil_p) = 'S') then

			select	coalesce(max('S'),'N')
			into STRICT	ie_exige_anestesia_w
			from	regra_indic_clinica_obrig where	coalesce(nr_seq_exame_lab,nr_seq_exame_w,0)		= coalesce(nr_seq_exame_w,0)
			and	coalesce(nr_seq_grupo_lab,nr_seq_grupo_exame_w,0)	= coalesce(nr_seq_grupo_exame_w,0)
			and	coalesce(nr_seq_exame_interno,nr_seq_proc_interno_w,0)	= coalesce(nr_seq_proc_interno_w,0)
			and	coalesce(cd_area_procedimento,cd_area_procedimento_w,0)	= coalesce(cd_area_procedimento_w,0)
			and	coalesce(cd_especialidade,cd_especialidade_proced_w,0)	= coalesce(cd_especialidade_proced_w,0)
			and	coalesce(cd_grupo_proc,cd_grupo_procedimento_w,0)	= coalesce(cd_grupo_procedimento_w,0)
			and	coalesce(cd_procedimento,cd_procedimento_w,0)		= coalesce(cd_procedimento_w,0)
			and	coalesce(ie_origem_proced,ie_origem_proced_w,0)		= coalesce(ie_origem_proced_w,0)
			and	coalesce(cd_intervalo,cd_intervalo_w,'XPTO')			= coalesce(cd_intervalo_w,'XPTO')
			and	coalesce(nr_seq_subgrupo,nr_seq_subgrupo_w)			= nr_seq_subgrupo_w
			and	coalesce(cd_convenio, cd_convenio_w)				= cd_convenio_w
			and	coalesce(cd_perfil,cd_perfil_p,0)			= coalesce(cd_perfil_p,0)
			and	coalesce(cd_setor_prescricao,cd_setor_prescricao_w,0)	= coalesce(cd_setor_prescricao_w,0)
			and	coalesce(cd_setor_executor,cd_setor_atendimento_w,0)	= coalesce(cd_setor_atendimento_w,0)
			and	coalesce(cd_tipo_procedimento, cd_tipo_procedimento_w,0) = coalesce(cd_tipo_procedimento_w,0)
			and	coalesce(ie_tipo_convenio, cd_tipo_convenio_w,0)	= coalesce(cd_tipo_convenio_w,0)
			and	Obter_Regra_obrig_proc(nr_sequencia, ie_tipo_atendimento_w, cd_material_exame_w) = 'S'
			and	(((coalesce(qt_minimo_caracter,0) = 0) and (coalesce(ds_observacao_w::text, '') = '')) or (coalesce(length(ds_observacao_w),0) < qt_minimo_caracter))
			and	cd_estabelecimento	= cd_estab_prescr_w
			and	((coalesce(hr_prev_inicial::text, '') = '') or (to_char(dt_prev_execucao_w,'hh24:mi')	>= substr(hr_prev_inicial,1,5)))
			and	((coalesce(hr_prev_final::text, '') = '') or (to_char(dt_prev_execucao_w,'hh24:mi')	<= substr(hr_prev_final,1,5)))
			and	coalesce(ie_campo_obriga,'0') = '8' LIMIT 1;

			if (ie_exige_anestesia_w = 'N') then

				select	coalesce(max(ie_necessita_anest),'N')
				into STRICT	ie_exige_anestesia_w
				from	proc_interno where		nr_sequencia = nr_seq_proc_interno_w LIMIT 1;

			end if;

			if (ie_exige_anestesia_w = 'S') then
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 216, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
		end if;

		if (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(236,cd_perfil_p) = 'S') then


			select	coalesce(max('S'),'N')
			into STRICT	ie_regra_indic_clinica_obrig_w
			from	regra_indic_clinica_obrig where	coalesce(nr_seq_exame_lab,nr_seq_exame_w,0)		= coalesce(nr_seq_exame_w,0)
			and	coalesce(nr_seq_grupo_lab,nr_seq_grupo_exame_w,0)	= coalesce(nr_seq_grupo_exame_w,0)
			and	coalesce(nr_seq_exame_interno,nr_seq_proc_interno_w,0)	= coalesce(nr_seq_proc_interno_w,0)
			and	coalesce(cd_area_procedimento,cd_area_procedimento_w,0)	= coalesce(cd_area_procedimento_w,0)
			and	coalesce(cd_especialidade,cd_especialidade_proced_w,0)	= coalesce(cd_especialidade_proced_w,0)
			and	coalesce(cd_grupo_proc,cd_grupo_procedimento_w,0)	= coalesce(cd_grupo_procedimento_w,0)
			and	coalesce(cd_procedimento,cd_procedimento_w,0)		= coalesce(cd_procedimento_w,0)
			and	coalesce(ie_origem_proced,ie_origem_proced_w,0)		= coalesce(ie_origem_proced_w,0)
			and	coalesce(cd_intervalo,cd_intervalo_w,'XPTO')		= coalesce(cd_intervalo_w,'XPTO')
			and	coalesce(nr_seq_subgrupo,nr_seq_subgrupo_w)			= nr_seq_subgrupo_w
			and	coalesce(cd_convenio, cd_convenio_w)				= cd_convenio_w
			and	coalesce(cd_perfil,cd_perfil_p,0)			= coalesce(cd_perfil_p,0)
			and	coalesce(cd_setor_prescricao,cd_setor_prescricao_w,0)	= coalesce(cd_setor_prescricao_w,0)
			and	coalesce(cd_setor_executor,cd_setor_atendimento_w,0)	= coalesce(cd_setor_atendimento_w,0)
			and	coalesce(cd_tipo_procedimento, cd_tipo_procedimento_w,0) = coalesce(cd_tipo_procedimento_w,0)
			and	coalesce(ie_tipo_convenio, cd_tipo_convenio_w,0)	= coalesce(cd_tipo_convenio_w,0)
			and	Obter_Regra_obrig_proc(nr_sequencia, ie_tipo_atendimento_w, cd_material_exame_w) = 'S'
			and	((coalesce(ie_autorizacao,'N') = 'N') or (ie_regra_plano_w = 5))
			and	(((coalesce(qt_minimo_caracter,0) = 0) and (coalesce(ds_dado_clinico_w::text, '') = '')) or (coalesce(length(ds_dado_clinico_w),0) < qt_minimo_caracter))
			and	cd_estabelecimento					= cd_estab_prescr_w
			and	((coalesce(hr_prev_inicial::text, '') = '') or (to_char(dt_prev_execucao_w,'hh24:mi')	>= substr(hr_prev_inicial,1,5)))
			and	((coalesce(hr_prev_final::text, '') = '') or (to_char(dt_prev_execucao_w,'hh24:mi')	<= substr(hr_prev_final,1,5)))
			and	coalesce(ie_campo_obriga,'0') = '9' LIMIT 1;

			if (ie_regra_indic_clinica_obrig_w = 'S') then
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 236, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;

		end if;

		if (coalesce(ds_material_especial_w::text, '') = '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(217,cd_perfil_p) = 'S') then

			select	count(*)
			into STRICT	cont_w
			from	material_exame_lab where	cd_material_exame 	= cd_material_exame_w
			and	ie_material_especial 	= 'S' LIMIT 1;

			if (cont_w > 0) then
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 217, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
		end if;

		if (ie_pergunta_tecnica_obrig_w = 'S') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(218,cd_perfil_p) = 'S') then
			select	count(*)
			into STRICT	cont_w
			from	prescr_procedimento r where	r.nr_prescricao = nr_prescricao_p
			and	r.nr_sequencia = nr_seq_proced_w
			and	(((obter_se_int_prescr_fleury(r.nr_prescricao) IS NOT NULL AND (obter_se_int_prescr_fleury(r.nr_prescricao))::text <> '')) or ((obter_se_int_pr_fleury_diag(r.nr_prescricao) IS NOT NULL AND (obter_se_int_pr_fleury_diag(r.nr_prescricao))::text <> '')))
			and	exists (SELECT 1
					from fleury_prescr_proced_valid
					where nr_prescricao = r.nr_prescricao
					and nr_seq_prescr = r.nr_sequencia
					and ie_possui_pergunta_tecnica = 'S')
			and     not exists (select 	1
					from 	fleury_prescr_perg_tec v,
						fleury_prescr_perg_resp u
					where 	v.nr_prescricao = r.nr_prescricao
					and 	v.nr_seq_prescr = r.nr_sequencia
					and     v.nr_sequencia = u.nr_seq_perg_tec) LIMIT 1;

			if (cont_w > 0) then
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 218, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
		end if;

		if (ie_pergunta_tecnica_obrig_w = 'S') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(219,cd_perfil_p) = 'S') then
			select	count(*)
			into STRICT	cont_w
			from	prescr_procedimento a,
				prescr_medica c,
				lab_parametro d where	a.nr_prescricao = c.nr_prescricao
			and	c.cd_estabelecimento = d.cd_estabelecimento
			and	a.nr_prescricao = nr_prescricao_p
			and	d.ie_utiliza_material_tasy = 'N'
			and	(((obter_se_int_prescr_fleury(a.nr_prescricao) IS NOT NULL AND (obter_se_int_prescr_fleury(a.nr_prescricao))::text <> '')) or ((obter_se_int_pr_fleury_diag(a.nr_prescricao) IS NOT NULL AND (obter_se_int_pr_fleury_diag(a.nr_prescricao))::text <> '')))
			and	exists (SELECT 	1
					from 	fleury_prescr_proc_mat b
					where	b.nr_prescricao = a.nr_prescricao
					and	b.nr_seq_prescr = a.nr_sequencia) LIMIT 1;

			if (cont_w > 0) then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(219, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 219, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
		end if;

		if (coalesce(cd_medico_exec_w::text, '') = '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(220,cd_perfil_p) = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(220, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 220, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		if (dt_prev_execucao_w IS NOT NULL AND dt_prev_execucao_w::text <> '') and
			((dt_prev_execucao_w < dt_prescricao_w) or (dt_prev_execucao_w > dt_validade_prescr_w)) and (coalesce(ie_proced_agora_w,'N') <> 'S') and (coalesce(ie_reserva_w,'N') = 'N') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(229,cd_perfil_p) = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(229, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 229, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		if (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(237,cd_perfil_p) = 'S') then

			select	max(ds_mensagem)
			into STRICT	ds_mensagem_w
			from	proc_interno_prescr
			where	nr_seq_proc_interno	 = nr_seq_proc_interno_w
			and		coalesce(cd_setor_atendimento,cd_setor_prescricao_w,cd_setor_atendimento_w,0) = coalesce(cd_setor_prescricao_w,cd_setor_atendimento_w,0)
			and		((coalesce(cd_convenio::text, '') = '') or (cd_convenio = cd_convenio_w))
			and		coalesce(nr_seq_contraste,0) = coalesce(nr_seq_contraste_w,0)
			and		(ds_mensagem IS NOT NULL AND ds_mensagem::text <> '');

			if (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(237, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 237, ie_erro_liberar_prescr_w, ds_mensagem_w, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
		end if;

		if (coalesce(cd_intervalo_w::text, '') = '') and (coalesce(NR_SEQ_DERIVADO_w::text, '') = '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(243,cd_perfil_p) = 'S') then
			ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(243, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 243, ie_erro_liberar_prescr_w, ds_mensagem_w, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		if (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') and (coalesce(ie_forma_exame_w::text, '') = '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(244,cd_perfil_p) = 'S') then
			select	max(ie_obriga_tipo)
			into STRICT	ie_obriga_tipo_w
			from	exame_laboratorio
			where	nr_seq_exame	= nr_seq_Exame_w;

			if (coalesce(ie_obriga_tipo_w,'N') = 'S') then
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 244, 'N', ds_mensagem_w, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(245,cd_perfil_p) = 'S') then
			begin
			SELECT * FROM consistir_interv_solic_exame(nr_prescricao_p, nr_seq_proced_w, ie_erro_interv_solic_exame_w, ie_impede_lib_solic_exame_w, qt_horas_w, qt_minutos_w, ie_quantidade_w, ds_mensagem_regra_w, ds_mensagem_data_w, dt_ultima_data_w, cd_perfil_p, nm_usuario_p) INTO STRICT ie_erro_interv_solic_exame_w, ie_impede_lib_solic_exame_w, qt_horas_w, qt_minutos_w, ie_quantidade_w, ds_mensagem_regra_w, ds_mensagem_data_w, dt_ultima_data_w;

			if (ie_erro_interv_solic_exame_w IS NOT NULL AND ie_erro_interv_solic_exame_w::text <> '') and (ie_quantidade_w = 'N') then
				begin
				if (ie_impede_lib_solic_exame_w = 'N') then
					ie_erro_liberar_prescr_w := 'S';
				elsif (ie_impede_lib_solic_exame_w = 'S') then
					ie_erro_liberar_prescr_w := 'N';
				end if;
				if ((ds_justificativa_w IS NOT NULL AND ds_justificativa_w::text <> '') or (varParam984_w = 'N')) then
				  nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 245, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
				else
				  nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 245, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w, 'S');
				end if;
				end;
			end if;
			end;
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (cd_tipo_convenio_w = 3) and
			((coalesce(nr_horas_sus_w,0) = 0) or ((dt_entrada_w + nr_horas_sus_w/24) < clock_timestamp())) and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(259,cd_perfil_p) = 'S') then
			select	count(*)
			into STRICT	cont_w
			from	sus_laudo_paciente x where	x.nr_atendimento	= nr_atendimento_w LIMIT 1;

			if (cont_w = 0) then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(259, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 259, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;

		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (nr_seq_derivado_w IS NOT NULL AND nr_seq_derivado_w::text <> '') and (ie_just_hemot_w = 'S') and (ie_se_necessario_w = 'S') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(9,cd_perfil_p) = 'S') THEN
			if (coalesce(ds_justificativa_w::text, '') = '') then
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 9, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			else
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 9, 'N', null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w, 'S');
			end if;
		end if;

		if (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') and (coalesce(nr_seq_topografia_w::text, '') = '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(253,cd_perfil_p) = 'S') then
			select	max(ie_topografia)
			into STRICT	ie_topografia_w
			from	proc_interno
			where	nr_sequencia	= nr_seq_proc_interno_w;

			if (ie_topografia_w = 'S') then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(253, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 253, ie_erro_liberar_prescr_w, ds_mensagem_w, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if	((nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') or (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '')) and (coalesce(cd_medico_exec_w::text, '') = '') and (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(279,cd_perfil_p) = 'S') then

			ie_invasivo_w	:= 'N';

			if (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') then

				select	coalesce(max(ie_exame_invasivo),'N')
				into STRICT	ie_invasivo_w
				from	exame_laboratorio
				where	nr_seq_exame = nr_seq_exame_w;

			elsif (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') then

				select	coalesce(max(ie_invasivo),'N')
				into STRICT	ie_invasivo_w
				from	proc_interno
				where	nr_sequencia = nr_seq_proc_interno_w;

			end if;

			if (ie_invasivo_w	= 'S') then
				ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(279, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 279, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;

		end if;

		if (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(285,cd_perfil_p) = 'S') and (obriga_justificativa_protocolo(nr_prescricao_p, cd_protocolo_w, nr_seq_protocolo_w) = 'S') and
		   ((coalesce(cd_protocolo_item_w::text, '') = '') or (cd_protocolo_item_w <> cd_protocolo_w)) and
		   (((coalesce(ds_justificativa_w::text, '') = '') and (ie_consistir_proced_indic_w = 'S')) or (coalesce(ds_observacao_w::text, '') = '')) and (ie_origem_inf_w <> 'A')then
			ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(285, cd_perfil_p);
			nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 285, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(293,cd_perfil_p) = 'S') then

			ie_setor_ativo_w	:= obter_se_setor_ativo(cd_setor_proced_w);

			if (ie_setor_ativo_w = 'I') then
				ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(293, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 293, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
			end if;

		end if;

		ie_erro_liberar_prescr_w	:= '';
		if (ie_anatomia_patologica_w = 'S' and wheb_assist_pck.Obter_Se_Consiste_REP(296,cd_perfil_p) = 'S') then

			select	coalesce(max(a.qt_frasco_env),0),
					max(a.nr_sequencia)
			into STRICT	qt_frascos_env_w,
					nr_seq_anatomia_w
			from	cpoe_anatomia_patologica a,
					prescr_procedimento b
			where	b.nr_seq_proc_cpoe	= a.nr_sequencia
			and		a.cd_funcao_origem	= 2314
			and		b.nr_prescricao		= nr_prescricao_p
			and		b.nr_sequencia		= nr_seq_proced_w
			and		(b.nr_seq_proc_interno IS NOT NULL AND b.nr_seq_proc_interno::text <> '')
			and 	obter_tipo_proc_interno(b.nr_seq_proc_interno) in ('AP', 'APH', 'APC');

			if (nr_seq_anatomia_w IS NOT NULL AND nr_seq_anatomia_w::text <> '') then

				select	count(1)
				into STRICT	qt_pecas_proc_w
				from	cpoe_prescr_proc_peca
				where	nr_seq_cpoe_proc = nr_seq_anatomia_w;
				if (qt_pecas_proc_w <> qt_frascos_env_w ) then
					ie_erro_liberar_prescr_w	:= obter_lib_erro_regra_rep(296, cd_perfil_p);
					nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 296, ie_erro_liberar_prescr_w, null, cd_perfil_p, nm_usuario_p, 'I', nr_seq_erro_w);
				end if;
			end if;

		end if;

		ie_erro_liberar_prescr_w	:= '';

		if (ie_anatomia_patologica_w = 'N' and wheb_assist_pck.Obter_Se_Consiste_REP(295,cd_perfil_p) = 'S') and (nr_seq_solic_sangue_w IS NOT NULL AND nr_seq_solic_sangue_w::text <> '') and (ie_tipo_proced_w in ('O','BS','AT','ST')) then

			ie_tipo_sangue_compativel_w	:= san_obter_se_hemo_compativel(cd_pessoa_fisica_w, nr_seq_derivado_w);

			ds_complemento_erro_w := null;

			if (ie_tipo_sangue_compativel_w <> 'S') then
				if (coalesce(length(ie_tipo_sangue_compativel_w),0) > 1) then
					ds_complemento_erro_w := ie_tipo_sangue_compativel_w;
				end if;
				ie_erro_liberar_prescr_w := obter_lib_erro_regra_rep(295, cd_perfil_p);
				nr_seq_erro_w := gerar_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 295, ie_erro_liberar_prescr_w, ds_complemento_erro_w, cd_perfil_p, nm_usuario_p, ie_tipo_w, nr_seq_erro_w);
			end if;

		end if;

		ie_erro_liberar_prescr_w	:= '';


		select	count(*)
		into STRICT	qt_erro_nao_lib_w
		from	prescr_medica_erro where ie_libera	= 'N'
		and	nr_seq_proced	= nr_seq_proced_w
		and	nr_prescricao	= nr_prescricao_p LIMIT 1;

		if (qt_erro_nao_lib_w > 0) then

			update	prescr_procedimento
			set		ie_erro			= 125,
					nr_seq_cor_erro		= 125,
					nr_seq_regra_plano	= coalesce(nr_seq_regra_plano_w,nr_seq_regra_plano),
					cd_convenio		= coalesce(cd_convenio_particular_w,cd_convenio),
					cd_categoria		= coalesce(cd_categoria_particular_w,cd_categoria),
					ds_cor_erro		= obter_cor_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 125, cd_estabelecimento_w, cd_perfil_p,'C'),
					ds_cor_selecao		= obter_cor_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 125, cd_estabelecimento_w, cd_perfil_p,'S')
			where	nr_sequencia		= nr_seq_proced_w
			and		nr_prescricao		= nr_prescricao_p;
		else

			select	count(*)
			into STRICT	qt_erro_lib_w
			from	prescr_medica_erro where		ie_libera	= 'S'
			and		nr_seq_proced	= nr_seq_proced_w
			and		nr_prescricao	= nr_prescricao_p LIMIT 1;

			if (qt_erro_lib_w > 0) then
				update	prescr_procedimento
				set		ie_erro			= 124,
						nr_seq_cor_erro		= 124,
						nr_seq_regra_plano	= coalesce(nr_seq_regra_plano_w,nr_seq_regra_plano),
						cd_convenio		= coalesce(cd_convenio_particular_w,cd_convenio),
						cd_categoria		= coalesce(cd_categoria_particular_w,cd_categoria),
						ds_cor_erro		= obter_cor_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 124, cd_estabelecimento_w, cd_perfil_p,'C'),
						ds_cor_selecao	= obter_cor_erro_prescr_proced(nr_prescricao_p, nr_seq_proced_w, 124, cd_estabelecimento_w, cd_perfil_p,'S')
				where	nr_sequencia		= nr_seq_proced_w
				and		nr_prescricao		= nr_prescricao_p;
			else

				select	count(*)
				into STRICT	qt_erro_param_w
				from	prescr_medica_erro where		ie_libera	= 'P'
				and		nr_seq_proced	= nr_seq_proced_w
				and		nr_prescricao	= nr_prescricao_p LIMIT 1;

				if (qt_erro_param_w > 0) then /* Itens com inconsistencia que dependem de parametro.. habilitar somente o botao direito e nao pintar. OS 241848.*/
					update	prescr_procedimento
					set		ie_erro			= 130,
							nr_seq_cor_erro 	= 0,
							nr_seq_regra_plano	= coalesce(nr_seq_regra_plano_w,nr_seq_regra_plano),
							cd_convenio		= coalesce(cd_convenio_particular_w,cd_convenio),
							cd_categoria		= coalesce(cd_categoria_particular_w,cd_categoria),
							ds_cor_erro		 = NULL
					where	nr_sequencia		= nr_seq_proced_w
					and		nr_prescricao		= nr_prescricao_p;
				else

					update	prescr_procedimento
					set		ie_erro			= 0,
							nr_seq_cor_erro 	= 0,
							nr_seq_regra_plano	= coalesce(nr_seq_regra_plano_w,nr_seq_regra_plano),
							cd_convenio		= coalesce(cd_convenio_particular_w,cd_convenio),
							cd_categoria		= coalesce(cd_categoria_particular_w,cd_categoria),
							ds_cor_erro		 = NULL
					where	nr_sequencia		= nr_seq_proced_w
					and		nr_prescricao		= nr_prescricao_p;

				end if;
			end if;
		end if;

	end loop;
	close c00;

end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_regra_prescr_proced ( nr_prescricao_p bigint, nr_seq_proced_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text) FROM PUBLIC;

