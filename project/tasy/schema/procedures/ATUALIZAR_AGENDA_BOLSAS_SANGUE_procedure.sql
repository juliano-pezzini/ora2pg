-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_agenda_bolsas_sangue (nr_seq_agenda_p bigint, nr_seq_proc_interno_p bigint, nm_usuario_p text) AS $body$
DECLARE

nr_seq_agenda_san_w	bigint;
qt_bolsas_sangue_w	smallint;
ie_tipagem_sanguinea_w	varchar(1);
ie_tipagem_agenda_w	varchar(1);
qt_bolsas_agenda_w	smallint;
ie_modo_obter_sangue_w	varchar(1);


BEGIN



ie_modo_obter_sangue_w := Obter_Param_Usuario(871, 224, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_modo_obter_sangue_w);

if (coalesce(nr_seq_proc_interno_p,0) > 0) then

	select	coalesce(ie_tipagem_sanguinea,'N'),
		coalesce(qt_bolsas_sangue,0)
	into STRICT	ie_tipagem_sanguinea_w,
		qt_bolsas_sangue_w
	from 	proc_interno
	where	nr_sequencia = nr_seq_proc_interno_p;

	if (qt_bolsas_sangue_w > 0) or (ie_tipagem_sanguinea_w = 'S') then

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_agenda_san_w
		from	agenda_pac_sangue
		where	nr_seq_agenda = nr_seq_agenda_p;

		if (nr_seq_agenda_san_w > 0) and (ie_modo_obter_sangue_w <> 'A') then

			select	coalesce(ie_tipagem_sanguinea,'N'),
				coalesce(qt_bolsas_sangue,0)
			into STRICT	ie_tipagem_agenda_w,
				qt_bolsas_agenda_w
			from 	agenda_pac_sangue
			where	nr_sequencia = nr_seq_agenda_san_w;

			if (ie_tipagem_agenda_w = 'N') and (ie_tipagem_sanguinea_w = 'S') then

				update	agenda_pac_sangue
				set	ie_tipagem_sanguinea 	= ie_tipagem_sanguinea_w,
					nm_usuario		= nm_usuario_p
				where	nr_sequencia = nr_seq_agenda_san_w;
				commit;

			end if;

			if (qt_bolsas_agenda_w < qt_bolsas_sangue_w) then

				update	agenda_pac_sangue
				set	qt_bolsas_sangue 	= qt_bolsas_sangue_w,
					nm_usuario		= nm_usuario_p
				where	nr_sequencia = nr_seq_agenda_san_w;
				commit;

			end if;

		else
			insert into agenda_pac_sangue(nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_seq_agenda,
							ie_tipagem_sanguinea,
							qt_bolsas_sangue)
			values (nextval('agenda_pac_sangue_seq'),
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							nr_seq_agenda_p,
							ie_tipagem_sanguinea_w,
							qt_bolsas_sangue_w);
			commit;

		end if;

	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_agenda_bolsas_sangue (nr_seq_agenda_p bigint, nr_seq_proc_interno_p bigint, nm_usuario_p text) FROM PUBLIC;

