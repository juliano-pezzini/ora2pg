-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_gerar_laudo_lme_receita ( nr_atendimento_p bigint, ds_medicamento_p text, cd_pessoa_fisica_p text, cd_profissional_p text, nm_usuario_p text) AS $body$
DECLARE


cd_cid_principal_w			varchar(10);
cd_cid_secundario_w		varchar(10);
cd_material_w			bigint;
ds_observacao_w			varchar(255);
cd_procedimento_w		bigint;
nr_laudo_w			smallint;
ie_laudo_w			varchar(1) := 'S';
nr_sequencia_w			bigint;
nr_dias_uso_w			integer;
ds_medicamento_w			varchar(1000);
ie_via_aplicacao_w			varchar(5);
cd_intervalo_w			varchar(7);
ie_cid_procedimento_w		varchar(15) := 'N';
cd_estab_usuario_w		integer;
ds_retorno_w			varchar(255);
qt_proced_1_mes_w		medic_uso_continuo.qt_proced_1_mes%type;
qt_proced_2_mes_w		medic_uso_continuo.qt_proced_2_mes%type;
qt_proced_3_mes_w		medic_uso_continuo.qt_proced_3_mes%type;
qt_proced_4_mes_w		medic_uso_continuo.qt_proced_4_mes%type;
qt_proced_5_mes_w		medic_uso_continuo.qt_proced_5_mes%type;
qt_proced_6_mes_w		medic_uso_continuo.qt_proced_6_mes%type;
nr_seq_mat_opm_w		sus_material_opm.nr_sequencia%type;
nr_seq_proc_interno_w		sus_material_opm.nr_seq_proc_interno%type;
ie_tipo_laudo_apac_w		sus_material_opm.ie_tipo_laudo_apac%type;

c01 CURSOR FOR
	SELECT	cd_material,
		cd_cid_principal,
		cd_cid_secundario,
		ds_observacao,
		nr_dias_uso,
		ie_via_aplicacao,
		cd_intervalo,
		qt_proced_1_mes,
		qt_proced_2_mes,
		qt_proced_3_mes,
		qt_proced_4_mes,
        qt_proced_5_mes,
        qt_proced_6_mes
	from	medic_uso_continuo
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p
	and	ds_medicamento_w like '%' || nr_sequencia || '%'
	and	coalesce(dt_suspensao::text, '') = ''
	and	ie_laudo_lme		= 'S'
	order by 1;


BEGIN

begin
cd_estab_usuario_w := wheb_usuario_pck.get_cd_estabelecimento;
exception
when others then
	cd_estab_usuario_w := 0;	
end;
ie_cid_procedimento_w := obter_valor_param_usuario(1124,94,obter_perfil_ativo,nm_usuario_p,cd_estab_usuario_w);

ds_medicamento_w	:= ' ' || ds_medicamento_p || ' ';
ds_medicamento_w	:= replace(ds_medicamento_w, ',',' ');
ds_medicamento_w	:= replace(ds_medicamento_w, '  ',' ');

open c01;
loop
fetch c01 into
	cd_material_w,
	cd_cid_principal_w,
	cd_cid_secundario_w,
	ds_observacao_w,
	nr_dias_uso_w,
	ie_via_aplicacao_w,
	cd_intervalo_w,
	qt_proced_1_mes_w,
	qt_proced_2_mes_w,
	qt_proced_3_mes_w,
	qt_proced_4_mes_w,
    qt_proced_5_mes_w,
    qt_proced_6_mes_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	select	max(nr_sequencia)
	into STRICT	nr_seq_mat_opm_w
	from	sus_material_opm
	where	cd_material		= cd_material_w
	and	ie_origem_proced	= 7;

	if (nr_seq_mat_opm_w > 0) then

		select	cd_procedimento,
			nr_seq_proc_interno,
			ie_tipo_laudo_apac
		into STRICT	cd_procedimento_w,
			nr_seq_proc_interno_w,
			ie_tipo_laudo_apac_w
		from	sus_material_opm
		where	nr_sequencia	= nr_seq_mat_opm_w;

	end if;

	if (coalesce(cd_procedimento_w,0) <> 0) then
		begin

		if (coalesce(ie_laudo_w,'N') = 'S') then
			begin

			select	coalesce(MAX(nr_laudo_sus),0) + 1
			into STRICT	nr_laudo_w
			from	sus_laudo_paciente
			where	nr_atendimento	= nr_atendimento_p;

			select	nextval('sus_laudo_paciente_seq')
			into STRICT	nr_sequencia_w
			;

			insert into sus_laudo_paciente(
						nr_seq_interno,
						nr_laudo_sus,
						ie_classificacao,
						ie_tipo_laudo_sus,
						ie_tipo_laudo_apac,
						ie_diaria_acomp,
						dt_emissao,
						nm_usuario,
						dt_atualizacao,
						cd_medico_responsavel,
						nr_atendimento,
						ds_complemento,
						nr_seq_proc_interno)
					values (	nr_sequencia_w,
						nr_laudo_w,
						14,
						0,
						coalesce(ie_tipo_laudo_apac_w, 8),
						'N',
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						cd_profissional_p,
						nr_atendimento_p,
						ds_observacao_w,
						nr_seq_proc_interno_w);

			ie_laudo_w := 'N';

			end;
		end if;
		
		if (coalesce(ie_cid_procedimento_w,'N') = 'S') then
			cd_cid_principal_w	:= coalesce(obter_cid_procedimento(cd_procedimento_w,7,'P'),cd_cid_principal_w);
			cd_cid_secundario_w	:= coalesce(obter_cid_procedimento(cd_procedimento_w,7,'S'),cd_cid_secundario_w);
		end if;	
		
		ds_retorno_w := sus_consiste_regra_laudo(cd_estab_usuario_w, cd_procedimento_w, 7, ds_retorno_w);
		
		if (coalesce(ds_retorno_w,'X') = 'X') then
			begin
			
			insert into sus_laudo_medicamento(
						nr_sequencia,
						nr_seq_laudo_sus,
						cd_procedimento,
						ie_origem_proced,
						cd_cid_principal,
						cd_cid_secundario,
						qt_proced_1_mes,
						qt_proced_2_mes,
						qt_proced_3_mes,
						qt_proced_4_mes,
						qt_proced_5_mes,
						qt_proced_6_mes,
						nm_usuario,
						dt_atualizacao,
						ie_via_aplicacao,
						cd_intervalo_prescr)
					values (	nextval('sus_laudo_medicamento_seq'),
						nr_sequencia_w,
						cd_procedimento_w,
						7,
						cd_cid_principal_w,
						cd_cid_secundario_w,
						coalesce(qt_proced_1_mes_w, nr_dias_uso_w, 0),
						qt_proced_2_mes_w,
						qt_proced_3_mes_w,
						qt_proced_4_mes_w,
						qt_proced_5_mes_w,
						qt_proced_6_mes_w,
						nm_usuario_p,
						clock_timestamp(),
						ie_via_aplicacao_w,
						cd_intervalo_w);
			end;
		end if;

		end;
	end if;

	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_gerar_laudo_lme_receita ( nr_atendimento_p bigint, ds_medicamento_p text, cd_pessoa_fisica_p text, cd_profissional_p text, nm_usuario_p text) FROM PUBLIC;

