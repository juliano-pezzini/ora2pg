-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_result_laboratorio ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, ds_resultado_p text, nm_usuario_p text, ie_final_p text default 'S', cd_exame_integracao_p text default null, ie_atualizar_rtf_p text default 'N', nr_seq_exame_ref_p bigint default null) AS $body$
DECLARE


cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
dt_coleta_w		timestamp;
ie_formato_texto_w	smallint	:= 1;

nr_seq_exame_w		bigint	:= null;
i					integer;
ds_resultado_w		varchar(32767);
ie_cobranca_w		varchar(1) := 'N';
cd_estabelecimento_w	smallint;
qt_proc_exec_w		bigint;
ie_conta_res_w		varchar(1);

nm_exame_w			exame_laboratorio.nm_exame%type;
nr_seq_result_lab_w	result_laboratorio.nr_sequencia%type;


BEGIN

select	cd_procedimento,
	ie_origem_proced
into STRICT	cd_procedimento_w,
	ie_origem_proced_w
from	prescr_procedimento
where 	nr_prescricao = nr_prescricao_p
and 	nr_sequencia  = nr_seq_prescr_p;

--gera_log_lab(nr_prescricao_p, 'Gravar_Result_Laboratorio 01=' || nr_seq_prescr_p, null,null,'TASY',1);
begin
select	max(coalesce(to_date(lab_obter_data_recoleta(nr_prescricao_p,nr_seq_prescr_p,nm_usuario_p,0),'dd/mm/yyyy hh24:mi:ss') ,(b.dt_coleta)))
into STRICT	dt_coleta_w
from	exame_lab_result_item b,
	exame_lab_resultado a
where	a.nr_seq_resultado	= b.nr_seq_resultado
and	a.nr_prescricao		= nr_prescricao_p
and	b.nr_seq_prescr		= nr_seq_prescr_p
and	(b.nr_seq_material IS NOT NULL AND b.nr_seq_material::text <> '');
exception
	when others then
	dt_coleta_w	:= null;
	end;

if (position('<HTML>' in upper(ds_resultado_p)) > 0) and (position('</HTML>' in upper(ds_resultado_p)) > 0) then
	ie_formato_texto_w	:= 2;
end if;

--gera_log_lab(nr_prescricao_p, 'Gravar_Result_Laboratorio 02=' || nr_seq_prescr_p, null,null,'TASY',1);
ds_resultado_w	:= ds_resultado_p;
if (substr(ds_resultado_p,1,13) = 'NR_SEQ_EXAME=') then
	i := position(';' in ds_resultado_p);
	nr_seq_exame_w	:= (substr(ds_resultado_p,14,i-14))::numeric;
	ds_resultado_w	:= substr(ds_resultado_w, i + 1, length(ds_resultado_w));

	delete FROM result_laboratorio
	where nr_prescricao	= nr_prescricao_p
	  and nr_seq_prescricao = nr_seq_prescr_p
	  and nr_seq_exame	= nr_seq_exame_w;
end if;

--gera_log_lab(nr_prescricao_p, 'Gravar_Result_Laboratorio 03=' || nr_seq_prescr_p, null,null,'TASY',0);
select	max(coalesce(cd_estabelecimento,1))
into STRICT	cd_estabelecimento_w
from	prescr_medica
where 	nr_prescricao = nr_prescricao_p;

select	max(coalesce(ie_gerar_cobranca_result,'N'))
into STRICT	ie_conta_res_w
from	lab_parametro
where	cd_estabelecimento = cd_estabelecimento_w;

if (ie_conta_res_w = 'S') then
	select	count(*)
	into STRICT	qt_proc_exec_w
	from	procedimento_paciente
	where	nr_prescricao = nr_prescricao_p
	and		nr_sequencia_prescricao = nr_seq_prescr_p;

	if (qt_proc_exec_w = 0) then
		ie_cobranca_w := 'S';
	end if;
end if;

if (ie_atualizar_rtf_p = 'N') then
	insert into result_laboratorio(NR_PRESCRICAO, NR_SEQ_PRESCRICAO,
					NM_USUARIO, IE_COBRANCA, IE_ORIGEM_PROCED,
					CD_PROCEDIMENTO,DS_RESULTADO, DT_COLETA,
					IE_FORMATO_TEXTO, NR_SEQ_EXAME, IE_FINAL, CD_EXAME_INTEGRACAO)
	values (nr_prescricao_p, nr_seq_prescr_p,
		nm_usuario_p, ie_cobranca_w, ie_origem_proced_w,
		cd_procedimento_w, ds_resultado_w, dt_coleta_w,
		ie_formato_texto_w, nr_seq_exame_w, ie_final_p, cd_exame_integracao_p);
else
	update	result_laboratorio set
		ds_resultado = ds_resultado_w,
		cd_exame_integracao = cd_exame_integracao_p
	where	nr_prescricao = nr_prescricao_p
	  and	nr_seq_prescricao = nr_seq_prescr_p;
end if;

select	max(nr_sequencia)
into STRICT 	nr_seq_result_lab_w
from	result_laboratorio
where	nr_prescricao = nr_prescricao_p
and		nr_seq_prescricao = nr_seq_prescr_p;

nm_exame_w	:= substr(obter_desc_exame(nr_seq_exame_ref_p),1,80);

CALL lab_incluir_result_laborat_int(	nr_prescricao_p,
								nr_seq_prescr_p,
								nm_usuario_p,
								cd_exame_integracao_p,
								nm_exame_w,
								nr_seq_result_lab_w
								);

--gera_log_lab(nr_prescricao_p, 'Gravar_Result_Laboratorio 04=' ||nr_seq_prescr_p, null,null,'TASY',0);
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_result_laboratorio ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, ds_resultado_p text, nm_usuario_p text, ie_final_p text default 'S', cd_exame_integracao_p text default null, ie_atualizar_rtf_p text default 'N', nr_seq_exame_ref_p bigint default null) FROM PUBLIC;

