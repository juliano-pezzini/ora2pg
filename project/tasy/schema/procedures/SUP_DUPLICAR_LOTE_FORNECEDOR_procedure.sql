-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sup_duplicar_lote_fornecedor ( nr_sequencia_p bigint, qt_duplicar_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_estabelecimento_w	material_lote_fornec.cd_estabelecimento%type;
ds_barras_w		material_lote_fornec.ds_barras%type;
ie_consiste_ds_barras_w		varchar(1);
qt_lotes_ds_barras_w		bigint;


BEGIN

select	cd_estabelecimento,
	ds_barras
into STRICT	cd_estabelecimento_w,
	ds_barras_w
from	material_lote_fornec
where	nr_sequencia = nr_sequencia_p;

ie_consiste_ds_barras_w := Obter_Valor_Param_Usuario(143,356,obter_perfil_ativo,nm_usuario_p,cd_estabelecimento_w);

if (ie_consiste_ds_barras_w = 'S') then
	begin
	select	count(*)
	into STRICT	qt_lotes_ds_barras_w
	from	material_lote_fornec
	where	cd_estabelecimento = cd_estabelecimento_w
	and	upper(ds_barras) = upper(ds_barras_w);

	if (qt_lotes_ds_barras_w > 0) then
		ds_barras_w := null;
	end if;
	end;
end if;

insert into material_lote_fornec(
		nr_sequencia,
		cd_material,
		nr_digito_verif,
		dt_atualizacao,
		nm_usuario,
		ds_lote_fornec,
		dt_validade,
		cd_cgc_fornec,
		nr_sequencia_nf,
		nr_item_nf,
		qt_material,
		cd_estabelecimento,
		nr_lote_producao,
		dt_impressao,
		dt_reimpressao,
		nm_usuario_reimpressao,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_marca,
		ie_origem_lote,
		ie_validade_indeterminada,
		ie_situacao,
		nm_usuario_impressao,
		nr_nota_fiscal,
		ie_bloqueio,
		ds_observacao,
		nm_usuario_bloqueio,
		dt_bloqueio,
		dt_validade_original,
		ds_barras,
		cd_barra_material,
		dt_fabricacao,
		ds_localizacao,
		nr_seq_local,
		nr_serie_material)
SELECT		nextval('material_lote_fornec_seq'),
		a.cd_material,
		calcula_digito('Modulo11', nextval('material_lote_fornec_seq')),
		clock_timestamp(),
		nm_usuario_p,
		a.ds_lote_fornec,
		a.dt_validade,
		a.cd_cgc_fornec,
		a.nr_sequencia_nf,
		a.nr_item_nf,
		a.qt_material,
		a.cd_estabelecimento,
		a.nr_lote_producao,
		a.dt_impressao,
		a.dt_reimpressao,
		a.nm_usuario_reimpressao,
		clock_timestamp(),
		nm_usuario_p,
		a.nr_seq_marca,
		a.ie_origem_lote,
		a.ie_validade_indeterminada,
		a.ie_situacao,
		a.nm_usuario_impressao,
		a.nr_nota_fiscal,
		a.ie_bloqueio,
		a.ds_observacao,
		a.nm_usuario_bloqueio,
		a.dt_bloqueio,
		a.dt_validade_original,
		ds_barras_w,
		a.cd_barra_material,
		a.dt_fabricacao,
		a.ds_localizacao,
		a.nr_seq_local,
		a.nr_serie_material
from		tabela_sistema b,
		material_lote_fornec a
where		a.nr_sequencia = nr_sequencia_p  LIMIT (qt_duplicar_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_duplicar_lote_fornecedor ( nr_sequencia_p bigint, qt_duplicar_p bigint, nm_usuario_p text) FROM PUBLIC;

