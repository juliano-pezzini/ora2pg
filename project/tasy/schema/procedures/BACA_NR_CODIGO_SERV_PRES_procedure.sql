-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_nr_codigo_serv_pres () AS $body$
DECLARE


qt_registro_w 			bigint;
ds_retorno_w			varchar(255);


BEGIN

SELECT	COUNT(*)
into STRICT	qt_registro_w
FROM	user_tab_columns
WHERE	table_name = 'PESSOA_JURIDICA_ESTAB'
AND	column_name = 'NR_CODIGO_SERV_PREST'
AND	data_type = 'NUMBER';

if (qt_registro_w > 0) then

	/*Cria tabela de backup*/

	ds_retorno_w := Executar_SQL_Dinamico('CREATE TABLE BKP_PESSOA_JURIDICA_ESTAB_WHEB AS (SELECT * FROM PESSOA_JURIDICA_ESTAB)', ds_retorno_w);

	/*Criar campo tempor치rio na tabela*/

	ds_retorno_w := Executar_SQL_Dinamico(' ALTER TABLE PESSOA_JURIDICA_ESTAB ADD (NR_CODIGO_SERV_PREST2 NUMBER(5))', ds_retorno_w);

	/*Setar os dados para o campo tempor치rio*/

	ds_retorno_w := Executar_SQL_Dinamico(' UPDATE	PESSOA_JURIDICA_ESTAB SET NR_CODIGO_SERV_PREST2 = NR_CODIGO_SERV_PREST WHERE NR_CODIGO_SERV_PREST IS NOT NULL ', ds_retorno_w);

	/*Limpa o campo*/

	ds_retorno_w := Executar_SQL_Dinamico(' UPDATE	PESSOA_JURIDICA_ESTAB SET NR_CODIGO_SERV_PREST = NULL WHERE NR_CODIGO_SERV_PREST IS NOT NULL', ds_retorno_w);
	commit;

	/*modifica o tipo do campo*/

	ds_retorno_w := Executar_SQL_Dinamico(' ALTER TABLE PESSOA_JURIDICA_ESTAB MODIFY NR_CODIGO_SERV_PREST VARCHAR2(10) ', ds_retorno_w);

	/*Carrega para o campo original*/

	ds_retorno_w := Executar_SQL_Dinamico(' UPDATE	PESSOA_JURIDICA_ESTAB SET NR_CODIGO_SERV_PREST = NR_CODIGO_SERV_PREST2 WHERE NR_CODIGO_SERV_PREST2 IS NOT NULL', ds_retorno_w);

	/*dropa o campo temporario*/

	ds_retorno_w := Executar_SQL_Dinamico(' ALTER TABLE PESSOA_JURIDICA_ESTAB DROP COLUMN NR_CODIGO_SERV_PREST2 ', ds_retorno_w);

	update	tabela_atributo
	set	ie_tipo_atributo = 'VARCHAR2',
		qt_tamanho = 10
	where	nm_tabela = 'PESSOA_JURIDICA_ESTAB'
	and	nm_atributo = 'NR_CODIGO_SERV_PREST';
end if;

SELECT	COUNT(*)
into STRICT	qt_registro_w
FROM	user_tab_columns
WHERE	table_name = 'OPERACAO_NOTA'
AND	column_name = 'NR_CODIGO_SERV_PREST'
AND	data_type = 'NUMBER';

if (qt_registro_w > 0) then

	/*Cria tabela de backup*/

	ds_retorno_w := Executar_SQL_Dinamico('CREATE TABLE BKP_OPERACAO_NOTA_WHEB AS (SELECT * FROM PESSOA_JURIDICA_ESTAB)', ds_retorno_w);

	/*Criar campo tempor치rio na tabela*/

	ds_retorno_w := Executar_SQL_Dinamico(' ALTER TABLE OPERACAO_NOTA ADD (NR_CODIGO_SERV_PREST2 NUMBER(5))', ds_retorno_w);

	/*Setar os dados para o campo tempor치rio*/

	ds_retorno_w := Executar_SQL_Dinamico(' UPDATE	OPERACAO_NOTA SET NR_CODIGO_SERV_PREST2 = NR_CODIGO_SERV_PREST WHERE NR_CODIGO_SERV_PREST IS NOT NULL ', ds_retorno_w);

	/*Limpa o campo*/

	ds_retorno_w := Executar_SQL_Dinamico(' UPDATE	OPERACAO_NOTA SET NR_CODIGO_SERV_PREST = NULL WHERE NR_CODIGO_SERV_PREST IS NOT NULL', ds_retorno_w);
	commit;

	/*modifica o tipo do campo*/

	ds_retorno_w := Executar_SQL_Dinamico(' ALTER TABLE OPERACAO_NOTA MODIFY NR_CODIGO_SERV_PREST VARCHAR2(10) ', ds_retorno_w);

	/*Carrega para o campo original*/

	ds_retorno_w := Executar_SQL_Dinamico(' UPDATE	OPERACAO_NOTA SET NR_CODIGO_SERV_PREST = NR_CODIGO_SERV_PREST2 WHERE NR_CODIGO_SERV_PREST2 IS NOT NULL', ds_retorno_w);

	/*dropa o campo temporario*/

	ds_retorno_w := Executar_SQL_Dinamico(' ALTER TABLE OPERACAO_NOTA DROP COLUMN NR_CODIGO_SERV_PREST2 ', ds_retorno_w);

	update	tabela_atributo
	set	ie_tipo_atributo = 'VARCHAR2',
		qt_tamanho = 10
	where	nm_tabela = 'OPERACAO_NOTA'
	and	nm_atributo = 'NR_CODIGO_SERV_PREST';
end if;

COMMIT;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_nr_codigo_serv_pres () FROM PUBLIC;

