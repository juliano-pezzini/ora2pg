-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_adicionar_termo_benef ( nr_seq_segurado_p pls_segurado_termo.nr_seq_segurado%type, nr_seq_segurado_aceite_p pls_segurado_termo.nr_seq_segurado%type, nr_seq_termo_p pls_segurado_termo.nr_seq_termo%type, ie_status_p text, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


ds_termo_w			pls_termo_beneficiario.ds_termo%type;
nm_pessoa_fisica_w		pessoa_fisica.nm_pessoa_fisica%type;
ds_nacionalidade_w		nacionalidade.ds_nacionalidade%type;
ds_estado_civil_w		varchar(255);
nr_cpf_w			pessoa_fisica.nr_cpf%type;
nr_cpf_pagador_w		pessoa_fisica.nr_cpf%type;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
nm_pagador_w			varchar(255);
ds_endereco_w			compl_pessoa_fisica.ds_endereco%type;
nr_endereco_w			compl_pessoa_fisica.nr_endereco%type;
ds_bairro_w			compl_pessoa_fisica.ds_bairro%type;
ds_municipio_w			compl_pessoa_fisica.ds_municipio%type;
sg_estado_w			compl_pessoa_fisica.sg_estado%type;
cd_cep_w			compl_pessoa_fisica.cd_cep%type;
ds_email_w			compl_pessoa_fisica.ds_email%type;
nr_telefone_w			compl_pessoa_fisica.nr_telefone%type;
ds_profissao_w			profissao.ds_profissao%type;
dt_adesao_w			pls_segurado.dt_contratacao%type;
ds_tipo_beneficiario_w		varchar(255);
nr_seq_segurado_termo_w		pls_segurado_termo.nr_sequencia%type;


BEGIN

select	ds_termo
into STRICT	ds_termo_w
from	pls_termo_beneficiario
where	nr_sequencia	= nr_seq_termo_p;

select	b.nm_pessoa_fisica,
	(	select	max(x.ds_nacionalidade)
		from	nacionalidade x
		where	x.cd_nacionalidade = b.cd_nacionalidade) ds_nacionalidade,
	obter_valor_dominio(5,b.ie_estado_civil) ds_estado_civil,
	b.nr_cpf,
	obter_dados_pf_pj(d.cd_pessoa_fisica,d.cd_cgc,'N') nm_pagador,
	obter_dados_pf(d.cd_pessoa_fisica,'CPF') nr_cpf_pagador,
	c.ds_endereco,
	c.nr_endereco,
	c.ds_bairro,
	c.ds_municipio,
	c.sg_estado,
	c.cd_cep,
	c.ds_email,
	c.nr_telefone,
	(	select	max(x.ds_profissao)
		from	profissao x
		where	x.cd_profissao = c.cd_profissao) ds_profissao,
	a.dt_contratacao,
	obter_valor_dominio(2406,a.ie_tipo_segurado) ds_tipo_beneficiario
into STRICT	nm_pessoa_fisica_w,
	ds_nacionalidade_w,
	ds_estado_civil_w,
	nr_cpf_w,
	nm_pagador_w,
	nr_cpf_pagador_w,
	ds_endereco_w,
	nr_endereco_w,
	ds_bairro_w,
	ds_municipio_w,
	sg_estado_w,
	cd_cep_w,
	ds_email_w,
	nr_telefone_w,
	ds_profissao_w,
	dt_adesao_w,
	ds_tipo_beneficiario_w
FROM pls_segurado a
LEFT OUTER JOIN pls_contrato_pagador d ON (a.nr_seq_pagador = d.nr_sequencia)
, pessoa_fisica b
LEFT OUTER JOIN compl_pessoa_fisica c ON (b.cd_pessoa_fisica = c.cd_pessoa_fisica)
WHERE b.cd_pessoa_fisica = a.cd_pessoa_fisica   and c.ie_tipo_complemento = 1 and a.nr_sequencia	= nr_seq_segurado_p;

ds_termo_w	:= replace(ds_termo_w,'@NM_BENEFICIARIO',nm_pessoa_fisica_w);
ds_termo_w	:= replace(ds_termo_w,'@NACIONALIDADE',ds_nacionalidade_w);
ds_termo_w	:= replace(ds_termo_w,'@ESTADO_CIVIL',ds_estado_civil_w);
ds_termo_w	:= replace(ds_termo_w,'@PROFISSAO',ds_profissao_w);
ds_termo_w	:= replace(ds_termo_w,'@CPF',nr_cpf_w);
ds_termo_w	:= replace(ds_termo_w,'@LOGRADOURO',ds_endereco_w);
ds_termo_w	:= replace(ds_termo_w,'@NR_LOGRADOURO',to_char(nr_endereco_w));
ds_termo_w	:= replace(ds_termo_w,'@BAIRRO',ds_bairro_w);
ds_termo_w	:= replace(ds_termo_w,'@CIDADE',ds_municipio_w);
ds_termo_w	:= replace(ds_termo_w,'@UF',sg_estado_w);
ds_termo_w	:= replace(ds_termo_w,'@CEP',cd_cep_w);	
ds_termo_w	:= replace(ds_termo_w,'@EMAIL',ds_email_w);
ds_termo_w	:= replace(ds_termo_w,'@TELEFONE',nr_telefone_w);
ds_termo_w	:= replace(ds_termo_w,'@DT_ADESAO',to_char(dt_adesao_w,'DD/MM/YYYY'));
ds_termo_w	:= replace(ds_termo_w,'@TIPO_BENEFICIARIO',ds_tipo_beneficiario_w);
ds_termo_w	:= replace(ds_termo_w,'@PAGADOR_NOME',nm_pagador_w);
ds_termo_w	:= replace(ds_termo_w,'@PAGADOR_CPF',nr_cpf_pagador_w);


insert	into	pls_segurado_termo(	nr_sequencia, dt_atualizacao, nm_usuario,
		nr_seq_segurado, nr_seq_termo, ds_termo,
		nr_seq_segurado_aceite, dt_atualizacao_nrec, nm_usuario_nrec)
	values (	nextval('pls_segurado_termo_seq'), clock_timestamp(), nm_usuario_p,
		nr_seq_segurado_p, nr_seq_termo_p, ds_termo_w,
		nr_seq_segurado_aceite_p, clock_timestamp(), nm_usuario_p)
	returning nr_sequencia into nr_seq_segurado_termo_w;

if (ie_status_p in ('C','R')) then
	CALL pls_alterar_status_termo_benef(nr_seq_segurado_termo_w, ie_status_p, nm_usuario_p);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_adicionar_termo_benef ( nr_seq_segurado_p pls_segurado_termo.nr_seq_segurado%type, nr_seq_segurado_aceite_p pls_segurado_termo.nr_seq_segurado%type, nr_seq_termo_p pls_segurado_termo.nr_seq_termo%type, ie_status_p text, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

