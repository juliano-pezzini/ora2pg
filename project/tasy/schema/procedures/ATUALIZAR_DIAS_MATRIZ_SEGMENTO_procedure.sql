-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_dias_matriz_segmento ( cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_material_w 			integer;

ie_atualizar_w			varchar(1);
qt_dia_interv_ressup_w		bigint;
qt_dia_ressup_forn_w		bigint;
qt_dia_estoque_minimo_w		bigint;
qt_compra_melhor_w		double precision;
nr_seq_segmento_w		bigint;
cd_empresa_w			smallint;

qt_dia_interv_ressup_ww		bigint;
qt_dia_ressup_forn_ww		bigint;
qt_dia_estoque_minimo_ww		bigint;
qt_compra_melhor_ww		double precision;

ie_existe_w			varchar(1);
ds_historico_w			varchar(4000);

c01 CURSOR FOR
SELECT	b.nr_seq_segmento,
	coalesce(b.qt_dia_interv_ressup,0),
	coalesce(b.qt_dia_ressup_forn,0),
	coalesce(b.qt_dia_estoque_minimo,0),
	coalesce(b.qt_compra_melhor,0)
from	segmento_compras a,
	mat_peso_segmento_compras b
where	a.nr_sequencia	= b.nr_seq_segmento
and	a.ie_situacao = 'A'
and	coalesce(a.cd_estabelecimento, b.cd_estabelecimento) = b.cd_estabelecimento
and	b.cd_estabelecimento = cd_estabelecimento_p
and	a.cd_empresa = cd_empresa_w

union all

select	c.nr_seq_segmento,
	coalesce(b.qt_dia_interv_ressup,0),
	coalesce(b.qt_dia_ressup_forn,0),
	coalesce(b.qt_dia_estoque_minimo,0),
	coalesce(b.qt_compra_melhor,0)
from	segmento_compras a,
	mat_peso_segmento_compras b,
	segmento_mat_peso c
where	b.nr_sequencia = c.nr_seq_mat_peso
and	a.nr_sequencia	= c.nr_seq_segmento
and	a.ie_situacao = 'A'
and	coalesce(a.cd_estabelecimento, b.cd_estabelecimento) = b.cd_estabelecimento
and	b.cd_estabelecimento = cd_estabelecimento_p
and	a.cd_empresa = cd_empresa_w;

c02 CURSOR FOR
SELECT	e.cd_material
from	segmento_compras a,
	segmento_compras_estrut b,
	estrutura_material_v e
where	a.nr_sequencia	= b.nr_seq_segmento
and (b.ie_curva_abc = 'T' or b.ie_curva_abc = substr(Obter_Curva_ABC_Estab(cd_estabelecimento_p, e.cd_material, 'N',clock_timestamp()),1,1))
and	coalesce(b.nr_seq_familia,coalesce(e.nr_seq_familia,0))		= coalesce(e.nr_seq_familia,0)
and	coalesce(b.cd_grupo_material, e.cd_grupo_material)		= e.cd_grupo_material
and	coalesce(b.cd_subgrupo_material, e.cd_subgrupo_material)	= e.cd_subgrupo_material
and	coalesce(b.cd_classe_material, e.cd_classe_material)		= e.cd_classe_material
and (coalesce(b.cd_material, e.cd_material) 			= e.cd_material)
and	a.nr_sequencia = nr_seq_segmento_w;


BEGIN
select	cd_empresa
into STRICT	cd_empresa_w
from	estabelecimento
where	cd_estabelecimento = cd_estabelecimento_p;

open c01;
loop
fetch c01 into
	nr_seq_segmento_w,
	qt_dia_interv_ressup_w,
	qt_dia_ressup_forn_w,
	qt_dia_estoque_minimo_w,
	qt_compra_melhor_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	if (coalesce(qt_dia_interv_ressup_w,0) > 0) or (coalesce(qt_dia_ressup_forn_w,0) > 0) or (coalesce(qt_dia_estoque_minimo_w,0) > 0) or (coalesce(qt_compra_melhor_w,0) > 0) then
		begin
		open c02;
		loop
		fetch c02 into
			cd_material_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
			ds_historico_w := wheb_mensagem_pck.get_texto(311012);

			select	qt_compra_melhor
			into STRICT	qt_compra_melhor_ww
			from	material
			where	cd_material = cd_material_w;

			ie_existe_w := 'S';
			begin
			select	b.qt_dia_interv_ressup,
				b.qt_dia_ressup_forn,
				b.qt_dia_estoque_minimo
			into STRICT	qt_dia_interv_ressup_ww,
				qt_dia_ressup_forn_ww,
				qt_dia_estoque_minimo_ww
			from	material a,
				material_estab b
			where	a.cd_material = b.cd_material
			and	a.cd_material = cd_material_w
			and	b.cd_estabelecimento = cd_estabelecimento_p;
			exception
			when others then
				begin
				ie_existe_w		:= 'N';
				qt_dia_interv_ressup_ww	:= null;
				qt_dia_ressup_forn_ww	:= null;
				qt_dia_estoque_minimo_ww	:= null;
				end;
			end;

			if (qt_compra_melhor_w = 0) then
				qt_compra_melhor_w := qt_compra_melhor_ww;
			end if;

			update	material
			set	qt_compra_melhor = qt_compra_melhor_w,
				dt_atualizacao = clock_timestamp(),
				nm_usuario = nm_usuario_p
			where	cd_material = cd_material_w;

			ds_historico_w := ds_historico_w || chr(13) || chr(10) ||
					wheb_mensagem_pck.get_texto(311018,'QT_COMPRA_MELHOR_WW='||qt_compra_melhor_ww||';QT_COMPRA_MELHOR_W='||QT_COMPRA_MELHOR_W);

			if (ie_existe_w = 'S') then
				begin
				if (qt_dia_interv_ressup_w = 0) then
					qt_dia_interv_ressup_w := qt_dia_interv_ressup_ww;
				end if;
				if (qt_dia_ressup_forn_w = 0) then
					qt_dia_ressup_forn_w := qt_dia_ressup_forn_ww;
				end if;
				if (qt_dia_estoque_minimo_w = 0) then
					qt_dia_estoque_minimo_w := qt_dia_estoque_minimo_ww;
				end if;

				update	material_estab
				set	qt_dia_interv_ressup	= qt_dia_interv_ressup_w,
					qt_dia_ressup_forn	= qt_dia_ressup_forn_w,
					qt_dia_estoque_minimo	= qt_dia_estoque_minimo_w,
					dt_atualizacao		= clock_timestamp(),
					nm_usuario	= nm_usuario_p
				where	cd_estabelecimento	= cd_estabelecimento_p
				and	cd_material	= cd_material_w;

				ds_historico_w := ds_historico_w || chr(13) || chr(10) ||
						wheb_mensagem_pck.get_texto(311019,	'QT_DIA_INTERV_RESSUP_WW='||to_char(qt_dia_interv_ressup_ww)||';QT_DIA_INTERV_RESSUP_W='||to_char(qt_dia_interv_ressup_w)||
											';QT_DIA_RESSUP_FORN_WW='||to_char(qt_dia_ressup_forn_ww)||';QT_DIA_RESSUP_FORN_W='||to_char(qt_dia_ressup_forn_w)||
											';QT_DIA_ESTOQUE_MINIMO_WW='||to_char(qt_dia_estoque_minimo_ww)||';QT_DIA_ESTOQUE_MINIMO_W='||to_char(qt_dia_estoque_minimo_w));
				end;
			end if;

			CALL sup_gravar_historico_material(
				cd_estabelecimento_p,
				cd_material_w,
				wheb_mensagem_pck.get_texto(311013),
				ds_historico_w,
				'S',
				nm_usuario_p);
			end;
		end loop;
		close c02;
		end;
	end if;
	commit;
	end;
end loop;
close c01;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_dias_matriz_segmento ( cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

