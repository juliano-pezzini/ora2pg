-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_orcamento_custo (cd_estabelecimento_p bigint, cd_tabela_custo_p bigint, cd_centro_controle_p bigint, cd_natureza_gasto_p bigint, vl_orcado_p bigint, qt_dias_prazo_p bigint, nr_seq_tabela_p bigint, nm_usuario_p text, ie_carga_p bigint default 0) AS $body$
DECLARE


cd_centro_controle_w		integer;
ie_tipo_gasto_w			varchar(2);
nr_seq_ng_w			bigint;
cd_empresa_w			tabela_custo.cd_empresa%type;


BEGIN

cd_empresa_w := obter_empresa_estab(cd_estabelecimento_p);

begin
	select	nr_sequencia
	into STRICT	nr_seq_ng_w
	from	natureza_gasto
	where	cd_natureza_gasto = cd_natureza_gasto_p	
	and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p
	and	cd_empresa = cd_empresa_w
        and	ie_situacao = 'A'  LIMIT 1;
	
	select	cd_centro_controle
	into STRICT	cd_centro_controle_w
	from	orcamento_custo
	where	nr_seq_tabela = nr_seq_tabela_p
	and	cd_centro_controle = cd_centro_controle_p
	and	cd_estabelecimento = cd_estabelecimento_p
	and	nr_seq_ng = nr_seq_ng_w  LIMIT 1;
exception
when no_data_found then
	begin
	cd_centro_controle_w := 0;
	end;
end;

ie_tipo_gasto_w	:= substr(cus_obter_tipo_gasto_centro(cd_estabelecimento_p, cd_centro_controle_p, null, cd_natureza_gasto_p,nr_seq_ng_w),1,1);

--se ainda nao existe o centro de custo - insere
if (cd_centro_controle_w = 0) then
	begin
	insert into orcamento_custo(
		nr_sequencia,
		cd_estabelecimento,
		cd_tabela_custo, 
		cd_centro_controle,
		cd_natureza_gasto, 
		dt_atualizacao, 
		nm_usuario, 
		vl_orcado,
		qt_dias_prazo,
		vl_a_distribuir,
		ie_tipo_gasto,
		nr_seq_ng,
		nr_seq_tabela) 
	values (	nextval('orcamento_custo_seq'),
		cd_estabelecimento_p,
		cd_tabela_custo_p,
		cd_centro_controle_p,
		cd_natureza_gasto_p,
		clock_timestamp(),
		nm_usuario_p,
		vl_orcado_p,
		qt_dias_prazo_p,
		0,
		ie_tipo_gasto_w,
		nr_seq_ng_w,
		nr_seq_tabela_p);
end;
else
	begin
	--se ja existe o centro de custo verifica opcao se vai somar com o valor ja existente ou vai subtituir pelo novo valor que vem do arquivo
	if (ie_carga_p = 1) then --soma
	begin
		update	orcamento_custo
		set	vl_orcado = vl_orcado + vl_orcado_p		
		where	cd_centro_controle = cd_centro_controle_w
		and	nr_seq_ng = nr_seq_ng_w
		and	nr_seq_tabela = nr_seq_tabela_p;				
	end;
	elsif (ie_carga_p = 0) then --substitui
	begin
		update 	orcamento_custo
		set	vl_orcado = vl_orcado_p
		where	cd_centro_controle = cd_centro_controle_w
		and	nr_seq_ng = nr_seq_ng_w
		and	nr_seq_tabela = nr_seq_tabela_p;
	end;
	end if;	
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_orcamento_custo (cd_estabelecimento_p bigint, cd_tabela_custo_p bigint, cd_centro_controle_p bigint, cd_natureza_gasto_p bigint, vl_orcado_p bigint, qt_dias_prazo_p bigint, nr_seq_tabela_p bigint, nm_usuario_p text, ie_carga_p bigint default 0) FROM PUBLIC;

