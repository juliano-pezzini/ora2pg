-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gedipa_reaproveit_mat_etapa ( nr_seq_gedipa_reaprov_p bigint, nr_seq_horario_novo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint ) AS $body$
DECLARE

nr_seq_etapa_gedipa_w       gedipa_etapa_hor.nr_seq_etapa_gedipa%type;
nr_seq_gedipa_etapa_hor_w   gedipa_etapa_hor.nr_sequencia%type;
cd_material_w               prescr_material.cd_material%type;
cd_intervalo_w              prescr_material.cd_intervalo%type;
dt_horario_w                prescr_mat_hor.dt_horario%type;
qt_dose_w                   prescr_mat_hor.qt_dose%type;
cd_unidade_medida_dose_w    prescr_mat_hor.cd_unidade_medida_dose%type;
nr_seq_material_w           prescr_material.nr_sequencia%type;
nr_prescricao_w             prescr_mat_hor.nr_prescricao%type;
dt_horario_anterior_w       prescr_mat_hor.dt_horario%type;
nr_seq_ged_etapa_hor_dil_w  gedipa_etapa_hor.nr_sequencia%type;

c01 CURSOR FOR
SELECT  a.nr_sequencia nr_seq_gedipa_reaprov,
        c.nr_sequencia nr_seq_horario
from    gedipa_reaproveitamento a,
        gedipa_etapa_hor b,
        prescr_mat_hor c,
        prescr_material d
where   b.nr_sequencia = a.nr_seq_etapa_hor
and     c.nr_sequencia = b.nr_seq_horario
and     d.nr_sequencia = c.nr_seq_material
and     c.nr_prescricao = d.nr_prescricao
and     d.nr_sequencia_diluicao = nr_seq_material_w
and     d.nr_prescricao = nr_prescricao_w
and     c.dt_horario = dt_horario_anterior_w;

BEGIN

update  gedipa_reaproveitamento
set     ie_status_devolucao = 'R'
where   nr_sequencia = nr_seq_gedipa_reaprov_p;

select  max(b.nr_seq_etapa_gedipa),
        max(b.nr_sequencia),
        max(c.dt_horario),
        max(c.nr_prescricao),
        max(c.nr_seq_material)
into STRICT    nr_seq_etapa_gedipa_w,
        nr_seq_gedipa_etapa_hor_w,
        dt_horario_anterior_w,
        nr_prescricao_w,
        nr_seq_material_w
from    gedipa_reaproveitamento a,
        gedipa_etapa_hor b,
        prescr_mat_hor c
where   a.nr_seq_etapa_hor = b.nr_sequencia
and     c.nr_sequencia = b.nr_seq_horario
and     a.nr_sequencia = nr_seq_gedipa_reaprov_p;

select  max(b.cd_material),
        max(b.cd_intervalo),
        max(a.dt_horario),
        max(a.qt_dose),
        max(a.cd_unidade_medida_dose)
into STRICT    cd_material_w,
        cd_intervalo_w,
        dt_horario_w,
        qt_dose_w,
        cd_unidade_medida_dose_w
from    prescr_mat_hor a,
        prescr_material b
where   a.nr_prescricao = b.nr_prescricao
and     b.nr_sequencia = a.nr_seq_material
and     a.nr_sequencia = nr_seq_horario_novo_p;

update  prescr_mat_hor
set     nr_seq_etapa_gedipa = nr_seq_etapa_gedipa_w
where   nr_sequencia = nr_seq_horario_novo_p;

update  gedipa_etapa_hor
set     nr_seq_horario = nr_seq_horario_novo_p,
        nr_seq_reaproveitamento = nr_seq_gedipa_reaprov_p,
        cd_material = cd_material_w,
        cd_intervalo = cd_intervalo_w,
        dt_horario = dt_horario_w,
        qt_dose = qt_dose_w,
        cd_unidade_medida_dose = cd_unidade_medida_dose_w
where   nr_sequencia = nr_seq_gedipa_etapa_hor_w;

for c01_w in c01
loop
    update  gedipa_reaproveitamento
    set     ie_status_devolucao = 'R'
    where   nr_sequencia = c01_w.nr_seq_gedipa_reaprov;

    select  max(b.nr_seq_etapa_gedipa),
            max(b.nr_sequencia)
    into STRICT    nr_seq_etapa_gedipa_w,
            nr_seq_ged_etapa_hor_dil_w
    from    gedipa_reaproveitamento a,
            gedipa_etapa_hor b
    where   a.nr_seq_etapa_hor = b.nr_sequencia
    and     a.nr_sequencia = c01_w.nr_seq_gedipa_reaprov;

    select  max(b.cd_material),
            max(b.cd_intervalo),
            max(a.dt_horario),
            max(a.qt_dose),
            max(a.cd_unidade_medida_dose)
    into STRICT    cd_material_w,
            cd_intervalo_w,
            dt_horario_w,
            qt_dose_w,
            cd_unidade_medida_dose_w
    from    prescr_mat_hor a,
            prescr_material b
    where   a.nr_prescricao = b.nr_prescricao
    and     b.nr_sequencia = a.nr_seq_material
    and     a.nr_sequencia = c01_w.nr_seq_horario;

    update  prescr_mat_hor
    set     nr_seq_etapa_gedipa = nr_seq_etapa_gedipa_w
    where   nr_sequencia = c01_w.nr_seq_horario;

    update  gedipa_etapa_hor
    set     nr_seq_horario = c01_w.nr_seq_horario,
            nr_seq_reaproveitamento = c01_w.nr_seq_gedipa_reaprov,
            cd_material = cd_material_w,
            cd_intervalo = cd_intervalo_w,
            dt_horario = dt_horario_w,
            qt_dose = qt_dose_w,
            cd_unidade_medida_dose = cd_unidade_medida_dose_w
    where   nr_sequencia = nr_seq_ged_etapa_hor_dil_w;
end loop;

commit;

CALL gedipa_baixar_prescr_mat(nr_seq_gedipa_etapa_hor_w, nm_usuario_p, cd_estabelecimento_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gedipa_reaproveit_mat_etapa ( nr_seq_gedipa_reaprov_p bigint, nr_seq_horario_novo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint ) FROM PUBLIC;

