-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_limpar_pagto_zerados_lote ( nr_seq_lote_pgto_p pls_lote_pagamento.nr_sequencia%type, ie_commit_p text, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

 
qt_registro_w		integer := 0;
qt_recurso_w		integer := 0;

C01 CURSOR(	nr_seq_lote_pgto_pc	pls_lote_pagamento.nr_sequencia%type) FOR 
	SELECT	nr_sequencia 
	from	pls_pagamento_prestador 
	where	nr_seq_lote = nr_seq_lote_pgto_pc;

C02 CURSOR(	nr_seq_pagamento_pc	pls_pagamento_prestador.nr_sequencia%type) FOR 
	SELECT	a.nr_sequencia nr_sequencia, 
		b.nr_sequencia nr_seq_evento 
	from	pls_pagamento_item a, 
		pls_evento b 
	where	a.nr_seq_pagamento = nr_seq_pagamento_pc 
	and	coalesce(a.vl_item,0) = 0 
	and	b.nr_sequencia = a.nr_seq_evento 
	and	b.ie_evento_zerado = 'N';

BEGIN 
dbms_application_info.SET_ACTION('PLS_LIMPAR_PAGTO_ZERADOS_LOTE');
 
for r_C01_w in C01(	nr_seq_lote_pgto_p) loop 
 
	-- retorna todos os registros dos eventos que tenham 
	for r_C02_w in C02(	r_C01_w.nr_sequencia) loop 
 
		-- Exclui o evento movimento zerado 
		delete	FROM pls_evento_movimento x 
		where	x.nr_seq_pagamento_item	= r_C02_w.nr_sequencia 
		and	x.nr_seq_evento = r_C02_w.nr_seq_evento;
		 
		update	pls_conta_rec_resumo_item 
		set	nr_seq_pag_item  = NULL 
		where	nr_seq_pag_item = r_C02_w.nr_sequencia 
		and	nr_seq_evento = r_C02_w.nr_seq_evento;
 
		-- Exclui o item zerado 
		delete	FROM pls_pagamento_item x 
		where	x.nr_sequencia	= r_C02_w.nr_sequencia 
		and	x.nr_seq_evento = r_C02_w.nr_seq_evento;
	end loop;
 
	select	count(1) 
	into STRICT	qt_registro_w 
	from	pls_pagamento_item 
	where	nr_seq_pagamento = r_C01_w.nr_sequencia;
 
	if (qt_registro_w = 0) then 
	 
		update	pls_rec_glosa_proc 
		set	nr_seq_pag_prest  = NULL 
		where	nr_seq_pag_prest = r_C01_w.nr_sequencia;
		 
		update	pls_rec_glosa_mat 
		set	nr_seq_pag_prest  = NULL 
		where	nr_seq_pag_prest = r_C01_w.nr_sequencia;
	 
		-- Exclui o prestador do pagamento zerado 
		delete	FROM pls_pagamento_prestador 
		where	nr_sequencia = r_C01_w.nr_sequencia;
	end if;
end loop;
 
dbms_application_info.SET_ACTION('');
 
if (coalesce(ie_commit_p,'N') = 'S') then 
	commit;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_limpar_pagto_zerados_lote ( nr_seq_lote_pgto_p pls_lote_pagamento.nr_sequencia%type, ie_commit_p text, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

