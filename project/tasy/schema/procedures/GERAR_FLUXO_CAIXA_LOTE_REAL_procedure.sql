-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_fluxo_caixa_lote_real ( nr_seq_lote_fluxo_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_tit_rec_p text, ie_tit_pagar_p text, ie_cheque_p text, ie_cartao_p text, ie_conv_receb_p text, ie_protocolo_p text, ie_ordem_compra_p text, ie_conttrato_p text, ie_fluxo_especial_p text, ie_agenda_p text, ie_bordero_pagar_p text, ie_pagto_escrit_p text, ie_tipo_fluxo_p text default 'R') AS $body$
DECLARE


/*--------------------------------------------------------------- ATENCAO ----------------------------------------------------------------*/


/* Cuidado ao realizar alteraCoes no fluxo de caixa em lote. Toda e qualquer alteraCao realizada em qualquer uma */


/* das procedures do fluxo de caixa em lote deve ser cuidadosamente verificada e realizada no fluxo de caixa      */


/* convencional. Devemos garantir que os dois fluxos de caixa tragam os mesmos valores no resultado, evitando     */


/* assim que existam diferenCas entre os fluxos de caixa.                                                                                                */


/*--------------- AO ALTERAR O FLUXO DE CAIXA EM LOTE ALTERAR TAMBEM O FLUXO DE CAIXA ---------------*/

cd_conta_financ_cpa_w		bigint;
cd_conta_financ_cre_w		bigint;
cd_conta_financ_w		bigint;
vl_fluxo_w				fluxo_caixa_item.vl_fluxo%type	:= 0;
dt_referencia_w			timestamp;
cd_convenio_w			integer;
cd_moeda_atual_w		integer	:= 0;
cd_moeda_padrao_w		integer	:= 0;
ie_integracao_w			varchar(02);
ie_tratar_fim_semana_w		varchar(02);
ie_acumular_vencidos_w		varchar(02);
ie_somente_futuro_w		varchar(02);
ie_oc_parcial_w			varchar(255);
ie_protocolo_conv_w		varchar(02);
dt_inicio_w			timestamp;
dt_final_w			timestamp;
cd_centro_custo_w		integer;
ie_convenio_receb_w		varchar(100);
ie_cheque_avista_real_w		varchar(100);
ie_entrada_saida_w		varchar(100);
ie_tit_rec_fluxo_w		parametro_fluxo_caixa.ie_tit_rec_fluxo%type;
ie_tit_pag_fluxo_w		parametro_fluxo_caixa.ie_tit_pag_fluxo%type;
ie_cheque_pago_pend_w		varchar(1)	:= 'N';
ie_cartao_cr_real_w		varchar(2);
ie_origem_titulo_w		varchar(10);
ie_deposito_fluxo_real_w	varchar(10);
nr_seq_classe_tit_rec_w		bigint;
nr_seq_classe_tit_pag_w		bigint;
ie_conta_fin_tf_receb_w		varchar(1);
ie_forma_calculo_contrato_w	varchar(1);
ie_oc_aprovada_w		varchar(1);
qtd_dias_fluxo_oc_w		bigint;
ie_tipo_titulo_cr_w		titulo_receber.ie_tipo_titulo%type;
ie_tipo_titulo_cp_w		titulo_pagar.ie_tipo_titulo%type;

cd_moeda_padrao_cr_w		integer;
cd_moeda_padrao_cp_w		integer;

ie_identificacao_w		varchar(15);
nr_titulo_pagar_w		titulo_pagar.nr_titulo%type;
nr_titulo_receber_w		titulo_receber.nr_titulo%type;
nr_seq_cheque_cp_w		cheque.nr_sequencia%type;
nr_seq_cheque_cr_w		cheque_cr.nr_seq_cheque%type;
nr_seq_movto_cartao_w		movto_cartao_cr.nr_sequencia%type;
nr_seq_movto_trans_w		movto_trans_financ.nr_sequencia%type;
nr_seq_conv_receb_w		convenio_receb.nr_sequencia%type;
nr_seq_proj_recurso_w		projeto_recurso_fin.nr_sequencia%type;
nr_interno_conta_w		conta_paciente.nr_interno_conta%type;
nr_seq_protocolo_w		protocolo_convenio.nr_seq_protocolo%type;
nr_ordem_compra_w		ordem_compra.nr_ordem_compra%type;
nr_repasse_terceiro_w		repasse_terceiro.nr_repasse_terceiro%type;
cd_agenda_w			agenda.cd_agenda%type;
nr_seq_contrato_w		contrato.nr_sequencia%type;
nr_seq_regra_w			regra_fluxo_caixa.nr_sequencia%type;
cd_empresa_w			empresa.cd_empresa%type;
ie_restringe_estab_w		fluxo_caixa_lote.ie_restringe_estab%type;
cd_moeda_empresa_w		integer;

c010 CURSOR FOR
/* 1 */

SELECT	'CR',
	'1R' ie_identificacao,
	dt_vencimento,
	cd_conta_financ,
	sum(vl_fluxo),
	0 cd_convenio,
	cd_moeda,
	cd_moeda_padrao_cr_w,
	cd_centro_custo,
	ie_origem_titulo,
	nr_seq_classe_tit_rec,
	null nr_seq_classe_tit_pag,
	null ie_tipo_tit_pag,
	ie_tipo_tit_rec,
	null nr_titulo_pagar,
	nr_titulo nr_titulo_receber,
	null nr_seq_cheque_cp,
	null nr_seq_cheque_cr,
	null nr_seq_movto_cartao,
	null nr_seq_movto_trans,
	null nr_seq_conv_receb,
	null nr_seq_proj_recurso,
	null nr_interno_conta,
	null nr_seq_protocolo,
	null nr_ordem_compra,
	null nr_repasse_terceiro,
	null cd_agenda,
	null nr_seq_contrato,
	null nr_seq_regra
from	(SELECT	dt_venc_titulo dt_vencimento,
		cd_conta_financ,
		CASE WHEN 	ie_tit_rec_fluxo_w='T' THEN				CASE WHEN 	coalesce(vl_classificacao::text, '') = '' THEN  vl_saldo_titulo - vl_recurso  ELSE vl_classificacao * dividir_sem_round(vl_saldo_titulo - vl_recurso, vl_dados_tit_rec) END  WHEN 	ie_tit_rec_fluxo_w='L' THEN 				CASE WHEN 	coalesce(vl_classificacao::text, '') = '' THEN  PERFORM dividir_sem_round(vl_saldo_titulo - vl_recurso, vl_dados_tit_rec) * vll_dados_tit_rec  ELSE (dividir_sem_round(vl_classificacao, vl_titulo) * vll_dados_tit_rec) *					dividir_sem_round(vl_saldo_titulo - vl_recurso, vl_dados_tit_rec) END 		 END  vl_fluxo,			
		cd_moeda,
		cd_centro_custo,
		ie_origem_titulo,
		nr_seq_classe_tit_rec,
		ie_tipo_tit_rec,
		nr_titulo
	from	(select	obter_venc_titulo(null, a.nr_titulo) dt_venc_titulo,
			obter_empresa_estab(a.cd_estabelecimento) cd_empresa_estab,
			substr(obter_se_conta_financ_estab(coalesce(b.cd_conta_financ, cd_conta_financ_cre_w), cd_estabelecimento_p,ie_restringe_estab_w),1,1) ie_conta_financ_estab,
			(obter_dados_titulo_receber(a.nr_titulo,'VLL'))::numeric  vll_dados_tit_rec,
			(obter_dados_titulo_receber(a.nr_titulo,'V'))::numeric  vl_dados_tit_rec,
			coalesce(b.cd_conta_financ, cd_conta_financ_cre_w) cd_conta_financ,
			a.cd_moeda,
			b.cd_centro_custo,
			a.ie_origem_titulo,
			a.nr_seq_classe nr_seq_classe_tit_rec,
			a.ie_tipo_titulo ie_tipo_tit_rec,
			a.cd_cgc,
			a.cd_pessoa_fisica,
			a.vl_titulo,
			a.vl_saldo_titulo,
			b.vl_classificacao,
			c.cd_banco,
			a.nr_titulo,
			obter_vl_recurso_titulo(a.nr_titulo) vl_recurso
		FROM titulo_receber a
LEFT OUTER JOIN titulo_receber_classif b ON (a.nr_titulo = b.nr_titulo)
LEFT OUTER JOIN banco_estabelecimento c ON (a.nr_seq_conta_banco = c.nr_sequencia)
WHERE ((ie_restringe_estab_w = 'N') or (ie_restringe_estab_w = 'E' and a.cd_estabelecimento = cd_estabelecimento_p) or (ie_restringe_estab_w = 'S' and (a.cd_estabelecimento = cd_estabelecimento_p or cd_estab_financeiro = cd_estabelecimento_p))) and not exists (	select	1
					from	fluxo_caixa_excecao x
					where	x.ie_integracao		= 'TR'
					and	x.ie_origem_titulo_rec	= a.ie_origem_titulo
					and	x.ie_tipo_fluxo		= 'R') and a.ie_situacao			= '1' and a.vl_saldo_titulo		> 0 and ie_tit_rec_p	= 'S'
		 ) alias25
	where	cd_empresa_estab	= cd_empresa_w
	and (ie_conta_financ_estab = 'S' or ie_restringe_estab_w = 'N')
	and 	dt_venc_titulo		<= dt_final_w
	and	dt_venc_titulo		>= CASE WHEN ie_acumular_vencidos_w='N' THEN  dt_inicio_w  ELSE dt_venc_titulo END 
	) alias27
group by dt_vencimento,
	cd_conta_financ,
	cd_moeda,
	cd_centro_custo,
	ie_origem_titulo,
	nr_seq_classe_tit_rec,
	ie_tipo_tit_rec,
	nr_titulo

union all

/* 2 */

select	'CR',
	'2R' ie_identificacao,
	dt_vencimento,
	coalesce(	CASE WHEN 	coalesce(ie_conta_fin_tf_receb_w,'N')='S' THEN (select	max(y.cd_conta_financ)			from	transacao_financeira y,				caixa_receb x			where	x.nr_seq_trans_financ	= y.nr_sequencia			and	x.nr_sequencia		= nr_seq_caixa_rec)  ELSE null END ,
		coalesce( cd_conta_pre, cd_conta_fin_cheque)),
	sum(vl_fluxo),
	0 cd_convenio,
	cd_moeda,
	cd_moeda_padrao_cr_w,
	0 cd_centro_custo,
	null ie_origem_titulo,
	null nr_seq_classe_tit_rec,
	null nr_seq_classe_tit_pag,
	null ie_tipo_tit_pag,
	null ie_tipo_tit_rec,
	null nr_titulo_pagar,
	null nr_titulo_receber,
	null nr_seq_cheque_cp,
	nr_seq_cheque nr_seq_cheque_cr,
	null nr_seq_movto_cartao,
	null nr_seq_movto_trans,
	null nr_seq_conv_receb,
	null nr_seq_proj_recurso,
	null nr_interno_conta,
	null nr_seq_protocolo,
	null nr_ordem_compra,
	null nr_repasse_terceiro,
	null cd_agenda,
	null nr_seq_contrato,
	null nr_seq_regra
from (select	trunc(coalesce(coalesce(a.dt_prev_terc_desbloqueio, coalesce(a.dt_prev_seg_desbloqueio, a.dt_prev_desbloqueio)),coalesce(a.dt_vencimento_atual, a.dt_vencimento)), 'dd') dt_vencimento,
		coalesce(c.vl_classificacao, a.vl_cheque) vl_fluxo,
		a.nr_seq_caixa_rec,
		obter_conta_fin_cheque_estab(a.nr_seq_cheque,1,ie_restringe_estab_w) cd_conta_fin_cheque,
		a.cd_moeda,
		c.cd_conta_pre,
		b.ie_tipo_devolucao,
		a.nr_seq_cheque,
		obter_status_cheque(a.nr_seq_cheque) ie_status_cheque_cr,
		obter_se_conta_financ_estab(obter_conta_financ_cheque_cr(a.nr_seq_cheque, 1), cd_estabelecimento_p,ie_restringe_estab_w) ie_conta_financ_estab,
		obter_empresa_estab(a.cd_estabelecimento) cd_empresa_estab
	FROM cheque_cr a
LEFT OUTER JOIN motivo_dev_cheque b ON (a.nr_seq_motivo_dev = b.nr_sequencia)
LEFT OUTER JOIN cheque_cr_classif c ON (a.nr_seq_cheque = c.nr_seq_cheque)
WHERE coalesce(a.dt_compensacao::text, '') = '' and coalesce(a.cd_moeda,cd_moeda_empresa_w)	= cd_moeda_empresa_w   -- Projeto Multimoeda - Busca apenas os registros em moeda nacional para o fluxo a realizar
  and (a.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_w = 'N') and (trunc(coalesce(a.dt_vencimento_atual, a.dt_vencimento), 'dd') <> trunc(a.dt_contabil, 'dd') or ie_cheque_avista_real_w = 'S') and (coalesce(a.dt_vencimento_atual, a.dt_vencimento) IS NOT NULL AND (coalesce(a.dt_vencimento_atual, a.dt_vencimento))::text <> '') and trunc(coalesce(coalesce(a.dt_prev_terc_desbloqueio, coalesce(a.dt_prev_seg_desbloqueio, a.dt_prev_desbloqueio)), coalesce(a.dt_vencimento_atual, dt_vencimento)),'dd')	<= dt_final_w and trunc(coalesce(coalesce(a.dt_prev_terc_desbloqueio, coalesce(a.dt_prev_seg_desbloqueio, a.dt_prev_desbloqueio)), coalesce(a.dt_vencimento_atual, a.dt_vencimento)),'dd')	>=
				CASE WHEN ie_acumular_vencidos_w='N' THEN  dt_inicio_w  ELSE trunc(coalesce(coalesce(a.dt_prev_terc_desbloqueio, coalesce(a.dt_prev_seg_desbloqueio, a.dt_prev_desbloqueio)),coalesce(a.dt_vencimento_atual, dt_vencimento)),'dd') END and ie_cheque_p		= 'S' ) alias71
where	((ie_status_cheque_cr in (1,3)) or (ie_status_cheque_cr = 2 and ie_deposito_fluxo_real_w = 'S') or (ie_status_cheque_cr = 5 and coalesce(ie_tipo_devolucao,'N') = 'B'))
and (ie_conta_financ_estab = 'S' or ie_restringe_estab_w = 'N')
and	cd_empresa_estab = cd_empresa_w
and	coalesce(coalesce(cd_conta_pre,cd_conta_fin_cheque),0) > 0
group by dt_vencimento,
	cd_conta_pre,
	cd_conta_fin_cheque,
	cd_moeda,
	nr_seq_cheque,
	nr_seq_caixa_rec

union all

/* 3 */

select	'CR',
	'3R' ie_identificacao,
	dt_vencimento,
	cd_conta_financ,
	sum(vl_cartao),
	0 cd_convenio,
	0 cd_moeda,
	0 cd_moeda_padrao,
	0 cd_centro_custo,
	null ie_origem_titulo,
	null nr_seq_classe_tit_rec,
	null nr_seq_classe_tit_pag,
	null ie_tipo_tit_pag,
	null ie_tipo_tit_rec,
	null nr_titulo_pagar,
	null nr_titulo_receber,
	null nr_seq_cheque_cp,
	null nr_seq_cheque_cr,
	nr_sequencia nr_seq_movto_cartao,
	null nr_seq_movto_trans,
	null nr_seq_conv_receb,
	null nr_seq_proj_recurso,
	null nr_interno_conta,
	null nr_seq_protocolo,
	null nr_ordem_compra,
	null nr_repasse_terceiro,
	null cd_agenda,
	null nr_seq_contrato,
	null nr_seq_regra
from (select	dt_vencimento,
		coalesce(cd_conta_financ,cd_conta_financ_cartao) cd_conta_financ,
		vl_cartao,
		nr_sequencia,
		OBTER_SE_CONTA_FINANC_ESTAB(coalesce(cd_conta_financ,cd_conta_financ_cartao), cd_estabelecimento_p,ie_restringe_estab_w) ie_conta_financ_estab
	from (select	trunc(a.dt_parcela, 'dd') dt_vencimento,
			c.cd_conta_financ,
			dividir_sem_round(coalesce(c.vl_classificacao, b.vl_transacao),b.vl_transacao) * CASE WHEN coalesce(IE_CARTAO_CR_REAL_W,'P')='P' THEN  a.vl_parcela  ELSE a.vl_liquido END  vl_cartao,
			obter_conta_financ_cartao_cr(a.nr_seq_movto) cd_conta_financ_cartao,
			OBTER_EMPRESA_ESTAB(b.cd_estabelecimento) cd_empresa_estab,
			b.nr_sequencia
		FROM movto_cartao_cr_parcela a, movto_cartao_cr b
LEFT OUTER JOIN movto_cartao_cr_classif c ON (b.nr_sequencia = c.nr_seq_movto)
WHERE a.nr_seq_movto					= b.nr_sequencia  and (b.cd_estabelecimento				= cd_estabelecimento_p or ie_restringe_estab_w = 'N') and a.vl_saldo_liquido				> 0 and (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') and coalesce(b.dt_cancelamento::text, '') = '' and coalesce(b.ie_lib_caixa,'S')				= 'S' and a.dt_parcela					<= dt_final_w and a.dt_parcela					>= CASE WHEN IE_ACUMULAR_VENCIDOS_w='N' THEN  dt_inicio_w  ELSE a.dt_parcela END and ie_cartao_p					= 'S' ) alias95
	where	coalesce(cd_conta_financ,coalesce(cd_conta_financ_cartao,0))	> 0
	and	cd_empresa_estab					= cd_empresa_w) alias98
where (ie_conta_financ_estab = 'S' or ie_restringe_estab_w = 'N')
group by dt_vencimento,
	cd_conta_financ,
	nr_sequencia

union all

/* 4 */

select	'CP',
	'4R' ie_identificacao,
	dt_vencimento,
	cd_conta_financ,
	CASE WHEN ie_tit_pag_fluxo_w='T' THEN  				sum((dividir_sem_round(coalesce(vl_classif, vl_titulo) + (dividir_sem_round((vl_saldo_juros + vl_saldo_multa),vl_titulo) * coalesce(vl_classif, vl_titulo)), vl_titulo)) * Obter_Saldo_Titulo_pagar(nr_titulo, trunc(clock_timestamp(),'dd'))) WHEN ie_tit_pag_fluxo_w='L' THEN 				sum((dividir_sem_round(coalesce(vl_classif, vl_titulo) + (dividir_sem_round((vl_saldo_juros + vl_saldo_multa),vl_titulo) * coalesce(vl_classif, vl_titulo)), vl_titulo)) * vl_saldo_titulo) END  vl_titulo,
	0 cd_convenio,
	cd_moeda,
	cd_moeda_padrao_cp_w,
	cd_centro_custo,
	null ie_origem_titulo,
	null nr_seq_classe_tit_rec,
	nr_seq_classe_tit_pag,
	ie_tipo_tit_pag,
	null ie_tipo_tit_rec,
	nr_titulo nr_titulo_pagar,
	null nr_titulo_receber,
	null nr_seq_cheque_cp,
	null nr_seq_cheque_cr,
	null nr_seq_movto_cartao,
	null nr_seq_movto_trans,
	null nr_seq_conv_receb,
	null nr_seq_proj_recurso,
	null nr_interno_conta,
	null nr_seq_protocolo,
	null nr_ordem_compra,
	null nr_repasse_terceiro,
	null cd_agenda,
	null nr_seq_contrato,
	null nr_seq_regra
from (select	obter_venc_titulo(a.nr_titulo, null) dt_vencimento,
		coalesce(b.nr_seq_conta_financ, cd_conta_financ_cpa_w) cd_conta_financ,
		b.vl_titulo vl_classif,
		a.vl_saldo_juros,
		a.vl_saldo_multa,
		(OBTER_DADOS_TIT_PAGAR(a.nr_titulo, 'VT'))::numeric  vl_titulo,
		a.vl_saldo_titulo,
		a.nr_titulo,
		a.cd_moeda,
		b.cd_centro_custo,
		a.nr_seq_classe nr_seq_classe_tit_pag,
		a.ie_tipo_titulo ie_tipo_tit_pag,
		substr(obter_se_conta_financ_estab(coalesce(b.nr_seq_conta_financ, cd_conta_financ_cpa_w), cd_estabelecimento_p,ie_restringe_estab_w),1,1) ie_conta_financ_estab,
		substr(obter_se_tit_pagar_transf(a.nr_titulo),1,1) ie_tit_pagar_transf
	FROM estabelecimento d, titulo_pagar a
LEFT OUTER JOIN titulo_pagar_classif b ON (a.nr_titulo = b.nr_titulo)
WHERE a.cd_estabelecimento	= d.cd_estabelecimento and d.cd_empresa		= cd_empresa_w and (ie_bordero_pagar_p	= 'N' or (coalesce(a.nr_bordero::text, '') = '' and
		not exists (select	1
		from	bordero_tit_pagar x
		where	x.nr_titulo	= a.nr_titulo))) and (ie_pagto_escrit_p	= 'N' or
		not exists (select	1
		from	titulo_pagar_escrit x
		where	x.nr_titulo	= a.nr_titulo)) and (ie_restringe_estab_w = 'N' or (ie_restringe_estab_w = 'E' and a.cd_estabelecimento = cd_estabelecimento_p) or (ie_restringe_estab_w = 'S' and (a.cd_estabelecimento = cd_estabelecimento_p or a.cd_estab_financeiro = cd_estabelecimento_p))) and (ie_oc_parcial_w = 'S' or
		not exists (select	1
		from	ordem_compra y,
			nota_fiscal x
		where	coalesce(y.dt_baixa::text, '') = ''
		and	x.nr_ordem_compra	= y.nr_ordem_compra
		and	x.nr_sequencia		= a.nr_seq_nota_fiscal)) and coalesce(a.dt_liquidacao::text, '') = '' and a.vl_saldo_titulo	> 0 and a.ie_situacao		= 'A' ) alias142
where (ie_restringe_estab_w = 'N' or ie_conta_financ_estab = 'S')
and	coalesce(ie_tit_pagar_transf,'N')	= 'N'
and	dt_vencimento			between dt_inicio_w and dt_final_w
and	ie_tit_pagar_p			= 'S'
group by dt_vencimento,
	cd_conta_financ,
	cd_moeda,
	cd_centro_custo,
	nr_seq_classe_tit_pag,
	ie_tipo_tit_pag,
	nr_titulo

union all

/* 5 */

select	'BP',
	'5R' ie_identificacao,
	dt_vencimento,
	cd_conta_financ,
	--sum((nvl(vl_classif,nvl(vl_bordero,vl_titulo)) / nvl(vl_bordero,vl_titulo)) * Obter_Saldo_Titulo_pagar(nr_titulo, trunc(sysdate, 'dd'))) saldo,
	CASE WHEN coalesce(ie_tipo_fluxo_p,'R')='V' THEN  sum((dividir_sem_round(coalesce(vl_classif,coalesce(vl_bordero,vl_titulo)) + --Valor titulo
																  (dividir_sem_round(((vl_saldo_juros + vl_saldo_multa) - vl_desconto_bordero),vl_titulo) * coalesce(vl_classif,coalesce(vl_bordero,vl_titulo))), --Valor de juros e multa - desconto
																  vl_titulo)) * Obter_Saldo_Titulo_pagar(nr_titulo, trunc(clock_timestamp(), 'dd')))  ELSE sum((dividir_sem_round(coalesce(vl_classif,coalesce(vl_bordero,vl_titulo)) + --Valor titulo
																	  (dividir_sem_round((vl_saldo_juros + vl_saldo_multa),vl_titulo) * coalesce(vl_classif,coalesce(vl_bordero,vl_titulo))), --Valor de juros e multa
																	  vl_titulo)) * Obter_Saldo_Titulo_pagar(nr_titulo, trunc(clock_timestamp(), 'dd'))) END  saldo,
	0 cd_convenio,
	cd_moeda,
	cd_moeda_padrao_cp_w,
	cd_centro_custo,
	null ie_origem_titulo,
	null nr_seq_classe_tit_rec,
	nr_seq_classe_tit_pag,
	ie_tipo_tit_pag,
	null ie_tipo_tit_rec,
	nr_titulo nr_titulo_pagar,
	null nr_titulo_receber,
	null nr_seq_cheque_cp,
	null nr_seq_cheque_cr,
	null nr_seq_movto_cartao,
	null nr_seq_movto_trans,
	null nr_seq_conv_receb,
	null nr_seq_proj_recurso,
	null nr_interno_conta,
	null nr_seq_protocolo,
	null nr_ordem_compra,
	null nr_repasse_terceiro,
	null cd_agenda,
	null nr_seq_contrato,
	null nr_seq_regra
from (select (select	max(coalesce(x.dt_real_pagamento,x.dt_prev_pagamento))
		from	bordero_pagamento x
		where	x.nr_bordero	= coalesce(c.nr_bordero,a.nr_bordero)) dt_vencimento,
		coalesce(b.nr_seq_conta_financ, cd_conta_financ_cpa_w) cd_conta_financ,
		b.vl_titulo vl_classif,
		coalesce(a.vl_saldo_juros,0) vl_saldo_juros,
		coalesce(a.vl_saldo_multa,0) vl_saldo_multa,
		coalesce(c.vl_desconto_bordero,0) vl_desconto_bordero, 
		(OBTER_DADOS_TIT_PAGAR(a.nr_titulo, 'VT'))::numeric  vl_titulo,
		a.nr_titulo,
		a.cd_moeda,
		b.cd_centro_custo,
		a.nr_seq_classe nr_seq_classe_tit_pag,
		c.vl_bordero,
		a.ie_tipo_titulo ie_tipo_tit_pag,
		substr(OBTER_SE_CONTA_FINANC_ESTAB(coalesce(b.nr_seq_conta_financ, cd_conta_financ_cpa_w), cd_estabelecimento_p,ie_restringe_estab_w),1,1) ie_conta_financ_estab,
		substr(obter_se_tit_pagar_transf(a.nr_titulo),1,1) ie_tit_pagar_transf
	FROM estabelecimento d, titulo_pagar a
LEFT OUTER JOIN bordero_tit_pagar c ON (a.nr_titulo = c.nr_titulo)
LEFT OUTER JOIN titulo_pagar_classif b ON (a.nr_titulo = b.nr_titulo)
WHERE d.cd_empresa		= cd_empresa_w and a.cd_estabelecimento	= d.cd_estabelecimento and ((a.nr_bordero IS NOT NULL AND a.nr_bordero::text <> '') or
		exists (select	1
		from	bordero_tit_pagar x
		where	x.nr_titulo	= a.nr_titulo)) and (ie_pagto_escrit_p	= 'N' or
		not exists (select	1
		from	titulo_pagar_escrit x
		where	x.nr_titulo	= a.nr_titulo)) and (ie_restringe_estab_w = 'N' or (ie_restringe_estab_w = 'E' and a.cd_estabelecimento = cd_estabelecimento_p) or (ie_restringe_estab_w = 'S' and (a.cd_estabelecimento = cd_estabelecimento_p or a.cd_estab_financeiro = cd_estabelecimento_p))) and (ie_oc_parcial_w = 'S' or
		not exists (select	1
		from	ordem_compra y,
			nota_fiscal x
		where	coalesce(y.dt_baixa::text, '') = ''
		and	x.nr_ordem_compra	= y.nr_ordem_compra
		and	x.nr_sequencia		= a.nr_seq_nota_fiscal)) and coalesce(a.dt_liquidacao::text, '') = '' and a.vl_saldo_titulo	> 0 and a.ie_situacao		= 'A' ) alias201
where (ie_restringe_estab_w = 'N' or ie_conta_financ_estab = 'S')
and	coalesce(ie_tit_pagar_transf,'N')	= 'N'
and	dt_vencimento			between dt_inicio_w and dt_final_w
and	ie_bordero_pagar_p		= 'S'
group by dt_vencimento,
	cd_conta_financ,
	cd_moeda,
	cd_centro_custo,
	nr_seq_classe_tit_pag,
	ie_tipo_tit_pag,
	nr_titulo

union all

/* 6 */

select	'PE',
	'6R' ie_identificacao,
	dt_vencimento,
	cd_conta_financ,
	--sum((nvl(vl_classif,vl_titulo) / vl_titulo) * Obter_Saldo_Titulo_pagar(nr_titulo, trunc(sysdate, 'dd'))) saldo,
	CASE WHEN coalesce(ie_tipo_fluxo_p,'R')='V' THEN  sum((dividir_sem_round(coalesce(vl_classif,vl_titulo) + --Valor titulo
																  (dividir_sem_round(((vl_saldo_juros + vl_saldo_multa) - vl_desconto),vl_titulo) * coalesce(vl_classif, vl_titulo)), --Valor de juros e multa - descontos
																  vl_titulo)) * Obter_Saldo_Titulo_pagar(nr_titulo, trunc(clock_timestamp(), 'dd')))  ELSE sum((dividir_sem_round(coalesce(vl_classif,vl_titulo) + --Valor titulo
																  (dividir_sem_round((vl_saldo_juros + vl_saldo_multa),vl_titulo) * coalesce(vl_classif, vl_titulo)), --Valor de juros e multa
																  vl_titulo)) * Obter_Saldo_Titulo_pagar(nr_titulo, trunc(clock_timestamp(), 'dd'))) END  saldo,
	0 cd_convenio,
	cd_moeda,
	cd_moeda_padrao_cp_w,
	cd_centro_custo,
	null ie_origem_titulo,
	null nr_seq_classe_tit_rec,
	nr_seq_classe_tit_pag,
	ie_tipo_tit_pag,
	null ie_tipo_tit_rec,
	nr_titulo nr_titulo_pagar,
	null nr_titulo_receber,
	null nr_seq_cheque_cp,
	null nr_seq_cheque_cr,
	null nr_seq_movto_cartao,
	null nr_seq_movto_trans,
	null nr_seq_conv_receb,
	null nr_seq_proj_recurso,
	null nr_interno_conta,
	null nr_seq_protocolo,
	null nr_ordem_compra,
	null nr_repasse_terceiro,
	null cd_agenda,
	null nr_seq_contrato,
	null nr_seq_regra
from (select	e.dt_remessa_retorno dt_vencimento,
		coalesce(b.nr_seq_conta_financ, cd_conta_financ_cpa_w) cd_conta_financ,
		b.vl_titulo vl_classif,
		coalesce(a.vl_saldo_juros,0) vl_saldo_juros,
		coalesce(a.vl_saldo_multa,0) vl_saldo_multa,
		coalesce(c.vl_desconto,0) vl_desconto,
		coalesce(c.vl_liquidacao,c.vl_escritural) vl_titulo,
		a.nr_titulo,
		a.cd_moeda,
		b.cd_centro_custo,
		a.nr_seq_classe nr_seq_classe_tit_pag,
		a.ie_tipo_titulo ie_tipo_tit_pag,
		substr(obter_se_conta_financ_estab(coalesce(b.nr_seq_conta_financ, cd_conta_financ_cpa_w), cd_estabelecimento_p,ie_restringe_estab_w),1,1) ie_conta_financ_estab,
		substr(obter_se_tit_pagar_transf(a.nr_titulo),1,1) ie_tit_pagar_transf
	FROM banco_escritural e, estabelecimento d, titulo_pagar_escrit c, titulo_pagar a
LEFT OUTER JOIN titulo_pagar_classif b ON (a.nr_titulo = b.nr_titulo)
WHERE c.nr_seq_escrit		= e.nr_sequencia and a.nr_titulo		= c.nr_titulo  and d.cd_empresa		= cd_empresa_w and a.cd_estabelecimento	= d.cd_estabelecimento and (ie_bordero_pagar_p	= 'N' or (coalesce(a.nr_bordero::text, '') = '' and
		not exists (select	1
		from	bordero_tit_pagar x
		where	x.nr_titulo	= a.nr_titulo))) and (ie_restringe_estab_w = 'N' or (ie_restringe_estab_w = 'E' and a.cd_estabelecimento = cd_estabelecimento_p) or (ie_restringe_estab_w = 'S' and (a.cd_estabelecimento = cd_estabelecimento_p or a.cd_estab_financeiro = cd_estabelecimento_p))) and (ie_oc_parcial_w = 'S' or
		not exists (select	1
		from	ordem_compra y,
			nota_fiscal x
		where	coalesce(y.dt_baixa::text, '') = ''
		and	x.nr_ordem_compra	= y.nr_ordem_compra
		and	x.nr_sequencia		= a.nr_seq_nota_fiscal)) and coalesce(a.dt_liquidacao::text, '') = '' and a.vl_saldo_titulo	> 0 and a.ie_situacao		= 'A' and e.dt_remessa_retorno	between dt_inicio_w and dt_final_w ) alias250
where (ie_restringe_estab_w = 'N' or ie_conta_financ_estab = 'S')
and	coalesce(ie_tit_pagar_transf,'N')	= 'N'
and	ie_pagto_escrit_p		= 'S'
group by dt_vencimento,
	cd_conta_financ,
	cd_moeda,
	cd_centro_custo,
	nr_seq_classe_tit_pag,
	ie_tipo_tit_pag,
	nr_titulo

union all

/* 7 */

select	'RC',
	'7R' ie_identificacao,
	dt_vencimento,
	0 cd_conta_financ,
	sum(vl_saldo_receb_conv * -1) vl_saldo,
	cd_convenio,
	0 cd_moeda,
	0 cd_moeda_padrao,
	0 cd_centro_custo,
	null ie_origem_titulo,
	null nr_seq_classe_tit_rec,
	null nr_seq_classe_tit_pag,
	null ie_tipo_tit_pag,
	null ie_tipo_tit_rec,
	null nr_titulo_pagar,
	null nr_titulo_receber,
	null nr_seq_cheque_cp,
	null nr_seq_cheque_cr,
	null nr_seq_movto_cartao,
	null nr_seq_movto_trans,
	nr_sequencia nr_seq_conv_receb,
	null nr_seq_proj_recurso,
	null nr_interno_conta,
	null nr_seq_protocolo,
	null nr_ordem_compra,
	null nr_repasse_terceiro,
	null cd_agenda,
	null nr_seq_contrato,
	null nr_seq_regra
from (select	coalesce(a.dt_fluxo_caixa, a.dt_recebimento) dt_vencimento,
		a.cd_convenio,
		a.nr_sequencia,
		obter_empresa_estab(a.cd_estabelecimento) cd_empresa_estab,
		obter_saldo_receb_convenio(a.nr_sequencia, clock_timestamp()) vl_saldo_receb_conv
	from 	Convenio_receb a
	where	ie_status <> 'T'
	and (a.cd_estabelecimento		= cd_estabelecimento_p or ie_restringe_estab_w = 'N')
	and	coalesce(a.cd_moeda,cd_moeda_empresa_w)	= cd_moeda_empresa_w   -- Projeto Multimoeda - Busca apenas os registros em moeda nacional para o fluxo a realizar
	and	coalesce(a.ie_integrar_cb_fluxo,'S')	= 'S'
	and	ie_convenio_receb_w		= 'S'
	and	ie_conv_receb_p			= 'S') alias261
where	cd_empresa_estab	= cd_empresa_w
and	vl_saldo_receb_conv	> 0
group by dt_vencimento,
	cd_convenio,
	nr_sequencia

union all

/* 8 */

select	'PC',
	'8R' ie_identificacao,
	dt_vencimento,
	0 cd_conta_financ,
	sum(coalesce(vl_conta,0)),
	cd_convenio,
	0 cd_moeda,
	0 cd_moeda_padrao,
	0 cd_centro_custo,
	null ie_origem_titulo,
	null nr_seq_classe_tit_rec,
	null nr_seq_classe_tit_pag,
	null ie_tipo_tit_pag,
	null ie_tipo_tit_recl,
	null nr_titulo_pagar,
	null nr_titulo_receber,
	null nr_seq_cheque_cp,
	null nr_seq_cheque_cr,
	null nr_seq_movto_cartao,
	null nr_seq_movto_trans,
	null nr_seq_conv_receb,
	null nr_seq_proj_recurso,
	nr_interno_conta nr_interno_conta,
	nr_seq_protocolo nr_seq_protocolo,
	null nr_ordem_compra,
	null nr_repasse_terceiro,
	null cd_agenda,
	null nr_seq_contrato,
	null nr_seq_regra
from	(select	a.dt_vencimento,
		coalesce(b.vl_conta,0) vl_conta,
		a.cd_convenio,
		a.nr_seq_protocolo,
		b.nr_interno_conta,
		obter_empresa_estab(a.cd_estabelecimento) cd_empresa_estab
	from	conta_paciente b,
		protocolo_convenio a
	where	a.nr_seq_protocolo		= b.nr_seq_protocolo
	and (a.cd_estabelecimento = cd_estabelecimento_p or ie_restringe_estab_w = 'N')
	and	((a.ie_status_protocolo = 1 and ie_protocolo_conv_w = 'S') or (a.ie_status_protocolo in (1,3) and ie_protocolo_conv_w = 'A'))
	and	not exists (select	1
		from	titulo_receber x 
		where	x.nr_seq_protocolo = a.nr_seq_protocolo or x.nr_interno_conta = b.nr_interno_conta)
	and	coalesce(b.ie_cancelamento::text, '') = ''
	and	trunc(a.dt_vencimento,'dd')	between	dt_inicio_w and dt_final_w
	and	ie_protocolo_p			= 'S') alias274
where	cd_empresa_estab = cd_empresa_w
group by dt_vencimento,
	cd_convenio,
	nr_interno_conta,
	nr_seq_protocolo

union all

/* 9 */

select	'CP',
	'9R' ie_identificacao,
	dt_inicio_w,
	cd_conta_financ_cheque,
	sum(vl_cheque),
	0 cd_convenio,
	0 cd_moeda,
	0 cd_moeda_padrao,
	0 cd_centro_custo,
	null ie_origem_titulo,
	null nr_seq_classe_tit_rec,
	null nr_seq_classe_tit_pag,
	null ie_tipo_tit_pag,
	null ie_tipo_tit_rec,
	null nr_titulo_pagar,
	null nr_titulo_receber,
	null nr_seq_cheque_cp,
	nr_sequencia nr_seq_cheque_cr,
	null nr_seq_movto_cartao,
	null nr_seq_movto_trans,
	null nr_seq_conv_receb,
	null nr_seq_proj_recurso,
	null nr_interno_conta,
	null nr_seq_protocolo,
	null nr_ordem_compra,
	null nr_repasse_terceiro,
	null cd_agenda,
	null nr_seq_contrato,
	null nr_seq_regra
from (select	obter_conta_financ_cheque_cp(a.nr_sequencia, 1) cd_conta_financ_cheque,
		a.vl_cheque,
		a.nr_sequencia
	from	cheque a
	where	a.cd_estabelecimento		= cd_estabelecimento_p
	and	coalesce(a.dt_cancelamento::text, '') = ''
	and	coalesce(a.cd_moeda,cd_moeda_empresa_w)	= cd_moeda_empresa_w   -- Projeto Multimoeda - Busca apenas os registros em moeda nacional para o fluxo a realizar
	and (coalesce(a.dt_compensacao::text, '') = '' or a.dt_compensacao > dt_final_w)
	and	trunc(a.dt_emissao,'dd')	< dt_inicio_w
	and	ie_cheque_pago_pend_w		= 'S') alias282
where	cd_conta_financ_cheque	> 0
group by cd_conta_financ_cheque,
	nr_sequencia

union all

/* 10 */


/* valor de glosas a recuperar */

select	distinct 'CR',
	'10R' ie_identificacao,
	CASE WHEN(trunc(dt_vencimento,'dd') - trunc(dt_inicio_w,'dd')) - abs(trunc(dt_vencimento,'dd') - trunc(dt_inicio_w,'dd'))=0 THEN dt_vencimento + 1  ELSE dt_inicio_w END  dt_vencimento,
	cd_conta_financ,
	vl_recurso,
	0 cd_convenio,
	0 cd_moeda,
	0 cd_moeda_padrao,
	0 cd_centro_custo,
	null ie_origem_titulo,
	null nr_seq_classe_tit_rec,
	null nr_seq_classe_tit_pag,
	null ie_tipo_tit_pag,
	null ie_tipo_tit_rec,
	null nr_titulo_pagar,
	null nr_titulo_receber,
	null nr_seq_cheque_cp,
	null nr_seq_cheque_cr,
	null nr_seq_movto_cartao,
	null nr_seq_movto_trans,
	null nr_seq_conv_receb,
	null nr_seq_proj_recurso,
	null nr_interno_conta,
	null nr_seq_protocolo,
	null nr_ordem_compra,
	null nr_repasse_terceiro,
	null cd_agenda,
	null nr_seq_contrato,
	null nr_seq_regra
from	(select	'CR', 
		'10R' ie_identificacao,
		obter_dt_venc_tit_rec(a.cd_cgc, obter_venc_titulo(null, a.nr_titulo), 'N', c.cd_banco, a.cd_pessoa_fisica) dt_vencimento,
		d.cd_conta_financ,
		a.cd_moeda,
		a.ie_origem_titulo,
		a.nr_seq_classe nr_seq_classe_tit_rec,
		a.ie_tipo_titulo ie_tipo_tit_rec,
		obter_vl_recurso_titulo(a.nr_titulo) vl_recurso
	FROM transacao_financeira d, titulo_receber_liq b, titulo_receber a
LEFT OUTER JOIN banco_estabelecimento c ON (a.nr_seq_conta_banco = c.nr_sequencia)
WHERE (d.cd_conta_financ IS NOT NULL AND d.cd_conta_financ::text <> '') and b.nr_seq_trans_fin				= d.nr_sequencia and a.nr_titulo					= b.nr_titulo and b.nr_sequencia	=
		(select	max(x.nr_sequencia)
		from	titulo_receber_liq x 
		where	x.nr_titulo	= a.nr_titulo
		and	not exists (select	1
			from	titulo_receber_liq w
			where	w.nr_seq_liq_origem	= x.nr_sequencia
			and	w.nr_titulo		= x.nr_titulo)
		and	coalesce(x.nr_seq_liq_origem::text, '') = ''
		and	coalesce(x.vl_recurso,0)				<> 0)  and OBTER_VENC_TITULO(null, a.nr_titulo)		<= dt_final_w and a.vl_saldo_titulo				> 0 and a.ie_situacao					= '1' and ie_tit_rec_p					= 'S' and not exists (select	1
		from	fluxo_caixa_excecao x
		where	x.ie_integracao		= 'TR'
		and	x.ie_origem_titulo_rec	= a.ie_origem_titulo
		and	x.ie_tipo_fluxo		= 'R') group by	a.cd_cgc,
		a.nr_titulo,
		c.cd_banco,
		a.cd_pessoa_fisica,
		d.cd_conta_financ,
		a.cd_moeda,
		a.ie_origem_titulo,
		a.nr_seq_classe,
		a.ie_tipo_titulo) alias300
where	coalesce(vl_recurso,0)	<> 0

union all

/* 11 */
 /* Gestao de Emprestimos e Financiamentos */

select 	'CE',
	'11R' ie_identificacao,
	dt_vencimento,
	cd_conta_financ,
	sum(vl_fluxo),
	0 cd_convenio,
	cd_moeda_atual,
	obter_moeda_padrao(cd_estabelecimento_p,'R') cd_moeda_padrao,
	null cd_centro_custo,
	null ie_origem_titulo,
	null nr_seq_classe_tit_rec,
	null nr_seq_classe_tit_pag,
	null ie_tipo_titulo_cp,
	null ie_tipo_titulo_cr,
	null nr_titulo_pagar,
	null nr_titulo_receber,
	null nr_seq_cheque_cp,
	null nr_seq_cheque_cr,
	null nr_seq_movto_cartao,
	null nr_seq_movto_trans,
	null nr_seq_conv_receb,
	null nr_seq_proj_recurso,
	null nr_interno_conta,
	null nr_seq_protocolo,
	null nr_ordem_compra,
	null nr_repasse_terceiro,
	null cd_agenda,
	null nr_seq_contrato,
	null nr_seq_regra
from (	select	a.dt_vencimento dt_vencimento,
		coalesce(b.cd_conta_financ,cd_conta_financ_cpa_w) cd_conta_financ,
		(a.vl_parcela - a.vl_juros - a.vl_amortizacao) vl_fluxo,
		c.cd_moeda_estrangeira cd_moeda_atual
	from	emprest_financ_parc a,
		emprest_financ_regra b,
		contrato c
	where	c.nr_sequencia = b.nr_seq_contrato
	and	c.nr_sequencia = a.nr_seq_contrato	
	and	coalesce(a.vl_parcela - a.vl_juros - a.vl_amortizacao,0) <> 0
	and	coalesce(a.nr_titulo::text, '') = ''
	and	a.dt_vencimento between	dt_inicio_w and dt_final_w
	and 	c.ie_situacao = 'A'
	
union all

	select	a.dt_vencimento dt_vencimento,
		coalesce(b.cd_conta_financ_amort,coalesce(b.cd_conta_financ,cd_conta_financ_cpa_w)) cd_conta_financ,
		a.vl_amortizacao vl_fluxo,
		c.cd_moeda_estrangeira cd_moeda_atual
	from	emprest_financ_parc a,
		emprest_financ_regra b,
		contrato c
	where	c.nr_sequencia = b.nr_seq_contrato
	and	c.nr_sequencia = a.nr_seq_contrato
	and	coalesce(a.vl_amortizacao,0)	<> 0
	and	coalesce(a.nr_titulo::text, '') = ''
	and	a.dt_vencimento between	dt_inicio_w and dt_final_w
	and 	c.ie_situacao = 'A'
	
union all

	select	a.dt_vencimento dt_vencimento,
		coalesce(b.cd_conta_financ_juros,coalesce(b.cd_conta_financ,cd_conta_financ_cpa_w)) cd_conta_financ,
		a.vl_juros vl_fluxo,
		c.cd_moeda_estrangeira cd_moeda_atual
	from	emprest_financ_parc a,
		emprest_financ_regra b,
		contrato c
	where	c.nr_sequencia = b.nr_seq_contrato
	and	c.nr_sequencia = a.nr_seq_contrato
	and	coalesce(a.vl_juros,0) <> 0
	and	coalesce(a.nr_titulo::text, '') = ''
	and	a.dt_vencimento between	dt_inicio_w and dt_final_w
	and 	c.ie_situacao = 'A'
	) alias316
group by
	dt_vencimento,
	cd_conta_financ,
	cd_moeda_atual,
	obter_moeda_padrao(cd_estabelecimento_p,'R')

union all

/* 12 */
 /* Projetos e Investimentos */

select	'PI',
	'12R' ie_identificacao,
	coalesce(a.dt_mes_referencia,b.dt_orcamento),
	a.cd_conta_financ,
	a.vl_orcado,
	0,
	a.cd_moeda,
	obter_moeda_padrao(cd_estabelecimento_p, 'R') cd_moeda_padrao,
	a.cd_centro_custo,
	null ie_origem_titulo,
	null nr_seq_classe_tit_rec,
	null nr_seq_classe_tit_pag,
	null ie_tipo_titulo_cp,
	null ie_tipo_titulo_cr,
	null nr_titulo_pagar,
	null nr_titulo_receber,
	null nr_seq_cheque_cp,
	null nr_seq_cheque_cr,
	null nr_seq_movto_cartao,
	null nr_seq_movto_trans,
	null nr_seq_conv_receb,
	null nr_seq_proj_recurso,
	null nr_interno_conta,
	null nr_seq_protocolo,
	null nr_ordem_compra,
	null nr_repasse_terceiro,
	null cd_agenda,
	null nr_seq_contrato,
	null nr_seq_regra
from	gpi_orc_item a, 
	gpi_orcamento b, 
	gpi_projeto c, 
	estabelecimento d
where	a.nr_seq_orcamento = b.nr_sequencia
and	c.nr_sequencia = b.nr_seq_projeto
and	c.cd_estabelecimento = d.cd_estabelecimento
and	c.ie_situacao = 'A'
and	((c.cd_estabelecimento = cd_estabelecimento_p and ie_restringe_estab_w = 'S')
	or (c.cd_estabelecimento = cd_estabelecimento_p and ie_restringe_estab_w = 'E')
	or (ie_restringe_estab_w = 'N'))
and	d.cd_empresa = cd_empresa_w
and	a.vl_orcado <> 0
and	coalesce(a.dt_mes_referencia,b.dt_orcamento) between dt_inicio_w and dt_final_w

union all

/* 13 */
 /* Planejamento Orcamentario */

select  'PL',
         '13R' ie_identificacao,
        a.dt_referencia,
        a.cd_conta_financ,
        a.vl_planej,
        0 cd_convenio,
        0 cd_moeda_atual,
        CASE WHEN a.cd_estab_exclusivo=obter_moeda_padrao(a.cd_estab_exclusivo, 'R') THEN 0 END  cd_moeda_padrao,
        a.cd_centro_custo,
        null ie_origem_titulo,
        null nr_seq_classe_tit_rec,
        null nr_seq_classe_tit_pag,
        null ie_tipo_titulo_cp,
        null ie_tipo_titulo_cr,
        null nr_titulo_pagar,
        null nr_titulo_receber,
        null nr_seq_cheque_cp,
        null nr_seq_cheque_cr,
        null nr_seq_movto_cartao,
        null nr_seq_movto_trans,
        null nr_seq_conv_receb,
        null nr_seq_proj_recurso,
        null nr_interno_conta,
        null nr_seq_protocolo,
        null nr_ordem_compra,
        null nr_repasse_terceiro,
        null cd_agenda,
        null nr_seq_contrato,
        null nr_seq_regra
from    ctb_planej_orc_valor_v a
where   (a.cd_conta_financ IS NOT NULL AND a.cd_conta_financ::text <> '')
and     coalesce(a.nr_seq_proj_gpi::text, '') = ''
and     ((coalesce(a.cd_estab_exclusivo,cd_estabelecimento_p) = cd_estabelecimento_p and ie_restringe_estab_w in ('S', 'E'))
          or (ie_restringe_estab_w = 'N'))
and     a.cd_empresa = cd_empresa_w
and     coalesce(a.vl_planej,0) <> 0
and     a.dt_referencia between dt_inicio_w and dt_final_w;


BEGIN

select	max(a.cd_empresa)
into STRICT	cd_empresa_w
from	estabelecimento a
where	a.cd_estabelecimento	= cd_estabelecimento_p;

select	trunc(max(a.dt_mesano_referencia),'month') dt_inico,
	fim_mes(max(a.dt_mesano_referencia)) dt_final,
	max(a.ie_restringe_estab)
into STRICT	dt_inicio_w,
	dt_final_w,
	ie_restringe_estab_w
from	fluxo_caixa_lote a
where	a.nr_sequencia	= nr_seq_lote_fluxo_p;

select	obter_moeda_padrao(cd_estabelecimento_p, 'R'),
	obter_moeda_padrao(cd_estabelecimento_p, 'P')
into STRICT	cd_moeda_padrao_cr_w,
	cd_moeda_padrao_cp_w
;

begin
select	cd_conta_financ_cpa,
	cd_conta_financ_cre,
	ie_somente_futuro,
	ie_tratar_fim_semana,
	ie_acumular_vencidos,
	ie_protocolo_conv,
	ie_convenio_receb,
	coalesce(ie_cheque_avista_real, 'N'),
	coalesce(ie_tit_rec_fluxo, 'T'),
	coalesce(ie_tit_pag_fluxo, 'T'),
	coalesce(ie_oc_parcial, 'N'),
	coalesce(ie_cheque_pago_pend,'N'),
	coalesce(ie_cartao_cr_real, 'P'),
	coalesce(ie_deposito_fluxo_real, 'N'),
	coalesce(ie_forma_calculo_contrato,'R'),
	coalesce(ie_oc_aprovada,'S')
into STRICT	cd_conta_financ_cpa_w,
 	cd_conta_financ_cre_w,
	ie_somente_futuro_w,
	ie_tratar_fim_semana_w,
	ie_acumular_vencidos_w,
	ie_protocolo_conv_w,
	ie_convenio_receb_w,
	ie_cheque_avista_real_w,
	ie_tit_rec_fluxo_w,
	ie_tit_pag_fluxo_w,
	ie_oc_parcial_w,
	ie_cheque_pago_pend_w,
	ie_cartao_cr_real_w,
	ie_deposito_fluxo_real_w,
	ie_forma_calculo_contrato_w,
	ie_oc_aprovada_w
from	parametro_fluxo_caixa
where 	cd_estabelecimento = cd_estabelecimento_p;
exception
	when no_data_found then
		/* Parametros do fluxo de caixa nao cadastrados! */

		CALL wheb_mensagem_pck.exibir_mensagem_abort(197611);
end;

/* Projeto Multimoeda - Busca a moeda padrao da empresa para buscar o fluxo. */

select	obter_moeda_padrao_empresa(cd_estabelecimento_p,'E')
into STRICT	cd_moeda_empresa_w
;

ie_conta_fin_tf_receb_w := obter_param_usuario(830, 25, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_conta_fin_tf_receb_w);

if (ie_somente_futuro_w = 'S') then
	dt_inicio_w	:= trunc(clock_timestamp(), 'dd');
end if;

delete	from fluxo_caixa_item
where	nr_seq_lote_fluxo	= nr_seq_lote_fluxo_p;

delete	from fluxo_caixa_data
where	nr_seq_lote_fluxo	= nr_seq_lote_fluxo_p;

open c010;
loop
fetch c010 into
	ie_integracao_w,
	ie_identificacao_w,
	dt_referencia_w,
	cd_conta_Financ_w,
	vl_fluxo_w,
	cd_convenio_w,
	cd_moeda_atual_w,
	cd_moeda_padrao_w,
	cd_centro_custo_w,
	ie_origem_titulo_w,
	nr_seq_classe_tit_rec_w,
	nr_seq_classe_tit_pag_w,
	ie_tipo_titulo_cp_w,
	ie_tipo_titulo_cr_w,
	nr_titulo_pagar_w,
	nr_titulo_receber_w,
	nr_seq_cheque_cp_w,
	nr_seq_cheque_cr_w,
	nr_seq_movto_cartao_w,
	nr_seq_movto_trans_w,
	nr_seq_conv_receb_w,
	nr_seq_proj_recurso_w,
	nr_interno_conta_w,
	nr_seq_protocolo_w,
	nr_ordem_compra_w,
	nr_repasse_terceiro_w,
	cd_agenda_w,
	nr_seq_contrato_w,
	nr_seq_regra_w;
EXIT WHEN NOT FOUND; /* apply on c010 */

	if (dt_referencia_w > dt_final_w) then
		dt_referencia_w   := dt_final_w;
	end if;

	if (ie_tratar_fim_semana_w = 'S') then
		dt_referencia_w	:= obter_proximo_dia_util(cd_estabelecimento_p, dt_referencia_w);
	end if;

	if (dt_referencia_w < Trunc(dt_inicio_w,'dd')) and (ie_identificacao_w <> '10R') then
		if (ie_acumular_vencidos_w = 'S') then
			dt_referencia_w	:= Trunc(dt_inicio_w,'dd');
		else
			goto proximo;
		end if;
	end if;

	if (cd_moeda_atual_w <> 0) and (cd_moeda_padrao_w <> cd_moeda_atual_w) then
		select	Obter_Valor_Moeda_Nac(cd_estabelecimento_p,
					vl_fluxo_w,
					cd_moeda_atual_w,
					dt_referencia_w)
		into STRICT	vl_fluxo_w
		;
	end if;


	if (cd_conta_financ_w = 0) then
	
		ie_entrada_saida_w		:= 'E';
		if (ie_integracao_w = 'CP') then
			ie_entrada_saida_w	:= 'S';
		end if;
		
		cd_conta_financ_w := obter_conta_financeira('E', cd_estabelecimento_p, 0, 0, 0, 0, cd_convenio_w, null, cd_centro_custo_w, cd_conta_financ_w, null, null, null, null, null, null, null, null, ie_origem_titulo_w, null, nr_seq_classe_tit_rec_w, nr_seq_classe_tit_pag_w, null, null, null, null, ie_tipo_titulo_cp_w, ie_tipo_titulo_cr_w, null);
	end if;


	if (cd_conta_financ_w = 0) then
		cd_conta_financ_w	:= cd_conta_financ_cre_w;
	end if;

	CALL GERAR_FLUXO_CAIXA_LOTE(	dt_referencia_w,
				cd_conta_financ_w,
				'',
				ie_identificacao_w,
				ie_integracao_w,
				nm_usuario_p,
				cd_agenda_w,
				nr_interno_conta_w,
				nr_ordem_compra_w,
				nr_repasse_terceiro_w,
				nr_seq_cheque_cp_w,
				nr_seq_cheque_cr_w,
				nr_seq_contrato_w,
				nr_seq_conv_receb_w,
				nr_seq_lote_fluxo_p,
				nr_seq_movto_cartao_w,
				nr_seq_movto_trans_w,
				nr_seq_proj_recurso_w,
				nr_seq_protocolo_w,
				nr_seq_regra_w,
				nr_titulo_pagar_w,
				nr_titulo_receber_w,
				coalesce(vl_fluxo_w,0));
	<<proximo>>
	null;
end loop;
close C010;

if (ie_ordem_compra_p = 'S') and (ie_oc_aprovada_w in ('S','N')) then
	
	qtd_dias_fluxo_oc_w := obter_param_usuario(830, 34, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, qtd_dias_fluxo_oc_w);
				
	CALL GERAR_FLUXO_CAIXA_LOTE_OC(	nr_seq_lote_fluxo_p,
					cd_estabelecimento_p,
					coalesce(qtd_dias_fluxo_oc_w,180),
					dt_inicio_w,
					dt_final_w,
					nm_usuario_p,
					cd_empresa_w);
end if;

if (ie_conttrato_p = 'S') then

	if (coalesce(ie_forma_calculo_contrato_w,'R') = 'M') and (coalesce(ie_tipo_fluxo_p,'R') = 'V') then		
		CALL GERAR_FLUXO_LOTE_PREV_CONTRATO(	nr_seq_lote_fluxo_p,
						cd_estabelecimento_p,
						nm_usuario_p,
						cd_empresa_w,
						ie_restringe_estab_w,
						dt_inicio_w,
						dt_final_w);
	else
		CALL GERAR_FLUXO_CAIXA_LOTE_CONTRAT(	nr_seq_lote_fluxo_p,
						cd_estabelecimento_p,
						nm_usuario_p,
						cd_empresa_w,
						ie_restringe_estab_w,
						dt_inicio_w,
						dt_final_w);
	end if;
end if;

if (ie_fluxo_especial_p = 'S') then
	CALL GERAR_FLUXO_CAIXA_LOTE_ESP(	nr_seq_lote_fluxo_p,
					cd_estabelecimento_p,
					dt_inicio_w,
					dt_final_w,
					nm_usuario_p,
					cd_empresa_w,
					ie_restringe_estab_w);
end if;

if (ie_agenda_p = 'S') then
	CALL GERAR_FLUXO_CAIXA_LOTE_AGENDA(	nr_seq_lote_fluxo_p,
					cd_empresa_w,
					cd_estabelecimento_p,
					dt_inicio_w,
					dt_final_w,
					nm_usuario_p);
end if;

CALL CALCULAR_FLUXO_CAIXA_LOTE(	nr_seq_lote_fluxo_p,
				cd_estabelecimento_p,
				0,  /*tem que ver da onde vem o valor padrao */
				dt_inicio_w,
				dt_final_w,
				'R',
				nm_usuario_p,
				cd_empresa_w,
				ie_restringe_estab_w,
				'N');
			
CALL GERAR_FLUXO_CAIXA_LOTE_AGRUP(	cd_estabelecimento_p,
				dt_inicio_w,
				dt_final_w,
				'R',
				nm_usuario_p,
				cd_empresa_w,
				ie_restringe_estab_w);
				
CALL GERAR_FLUXO_CAIXA_LOTE_EXTERNO(	dt_inicio_w,
				dt_final_w,
				cd_estabelecimento_p,
				cd_empresa_w,
				ie_restringe_estab_w,
				nm_usuario_p,
				nr_seq_lote_fluxo_p);
				
CALL GERAR_FLUXO_CAIXA_LOTE_DATA(	nr_seq_lote_fluxo_p,
				nm_usuario_p,
				cd_estabelecimento_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_fluxo_caixa_lote_real ( nr_seq_lote_fluxo_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_tit_rec_p text, ie_tit_pagar_p text, ie_cheque_p text, ie_cartao_p text, ie_conv_receb_p text, ie_protocolo_p text, ie_ordem_compra_p text, ie_conttrato_p text, ie_fluxo_especial_p text, ie_agenda_p text, ie_bordero_pagar_p text, ie_pagto_escrit_p text, ie_tipo_fluxo_p text default 'R') FROM PUBLIC;

