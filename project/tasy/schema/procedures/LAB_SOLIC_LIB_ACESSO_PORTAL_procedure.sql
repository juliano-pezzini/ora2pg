-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_solic_lib_acesso_portal ( nr_seq_solic_p text, cd_estabelecimento_p bigint, nm_usuario_p text, cd_perfil_p bigint default null) AS $body$
DECLARE


nr_seq_solic_w		bigint;
ds_email_w		varchar(255);
ds_email_medico_ww	varchar(255);
ds_titulo_w		varchar(255);
ds_mensagem_w		varchar(255);
ds_mensagem_ww		varchar(2000);
nr_crm_w		varchar(20);
nm_solicitante_w	varchar(60);
nm_usuario_email_w	varchar(15);
cd_perfil_w		integer;



BEGIN
if (nr_seq_solic_p IS NOT NULL AND nr_seq_solic_p::text <> '')then

	begin
	select 	ds_email,
		nr_crm,
		nm_solicitante
	into STRICT	ds_email_medico_ww,
		nr_crm_w,
		nm_solicitante_w
	from	lab_solic_acesso_portal
	where	nr_sequencia =  nr_seq_solic_p;

	select CASE WHEN obter_perfil_ativo=0 THEN cd_perfil_p  ELSE obter_perfil_ativo END
	into STRICT cd_perfil_w
	;

	ds_email_w := obter_param_usuario(80, 21, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ds_email_w);
	ds_titulo_w := obter_param_usuario(80, 22, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ds_titulo_w);
	ds_mensagem_w := obter_param_usuario(80, 23, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ds_mensagem_w);
	nm_usuario_email_w := obter_param_usuario(80, 29, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, nm_usuario_email_w);

	if (ds_email_w IS NOT NULL AND ds_email_w::text <> '') and (ds_titulo_w IS NOT NULL AND ds_titulo_w::text <> '') and (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') then
		begin
		ds_mensagem_ww := ds_mensagem_w || chr(13) || chr(10) ||obter_desc_expressao(329239)||' '||nm_solicitante_w|| chr(13) || chr(10) ||obter_desc_expressao(612286)||' '||nr_crm_w|| chr(13) || chr(10) ||obter_desc_expressao(289120)||': '||ds_email_medico_ww|| chr(13) || chr(10) || obter_desc_expressao(779465)||': ' || to_char(nr_seq_solic_p);
		CALL enviar_email(ds_titulo_w, ds_mensagem_ww, ds_email_w, ds_email_w, nm_usuario_email_w, 'A');
		end;
	end if;
	end;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_solic_lib_acesso_portal ( nr_seq_solic_p text, cd_estabelecimento_p bigint, nm_usuario_p text, cd_perfil_p bigint default null) FROM PUBLIC;

