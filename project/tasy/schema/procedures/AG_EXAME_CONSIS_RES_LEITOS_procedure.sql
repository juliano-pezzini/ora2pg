-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ag_exame_consis_res_leitos ( cd_agenda_p bigint, ie_reserva_leito_p text, dt_agenda_p timestamp, nm_usuario_p text) AS $body$
DECLARE



qt_leitos_permitidos_w	bigint;
qt_leitos_informados_w	bigint;
cd_agenda_w				bigint;

C01 CURSOR FOR
	SELECT	a.qt_permitido,
			a.cd_agenda
	from	agenda_regra_reserva_leito a
	where	((a.cd_agenda		= cd_agenda_p) or (coalesce(a.cd_agenda::text, '') = ''))
	and		a.ie_reserva_leito	= ie_reserva_leito_p
	order by a.cd_agenda;


BEGIN

open C01;
loop
fetch C01 into
	qt_leitos_permitidos_w,
	cd_agenda_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (qt_leitos_permitidos_w > 0) then

		select	count(*)
		into STRICT	qt_leitos_informados_w
		from	agenda_paciente
		where	((cd_agenda 			= cd_agenda_w) or (coalesce(cd_agenda_w::text, '') = ''))
		and		ie_reserva_leito	= ie_reserva_leito_p
		and		trunc(hr_inicio)	= dt_agenda_p
		and		ie_status_agenda	not in ('L', 'C', 'B', 'F', 'I', 'I');
	else
		qt_leitos_informados_w	:= 0;
	end if;



	if (qt_leitos_informados_w >= qt_leitos_permitidos_w) then
		--A quantidade de leitos reservados para o dia é superior ao número definido na regra Shift + F11(Quantidade de agendamentos por reserva de leito). Agendamento não permitido!
		CALL wheb_mensagem_pck.exibir_mensagem_abort(204628);
	end if;

	end;
end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ag_exame_consis_res_leitos ( cd_agenda_p bigint, ie_reserva_leito_p text, dt_agenda_p timestamp, nm_usuario_p text) FROM PUBLIC;

