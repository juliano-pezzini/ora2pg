-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_dados_nota_fiscal ( cd_estabelecimento_p bigint, nr_sequencia_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, cd_cnpj_p text, ie_calculada_p bigint, ie_situacao_p bigint, ie_entrada_saida_p text, ie_conta_contabil_p text, ie_conta_financ_p text, ie_nota_fiscal_p text, cd_grupo_desconsidera_p bigint, cd_subgrupo_desconsidera_p bigint, cd_classe_desconsidera_p bigint, cd_material_desconsidera_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w			bigint;
nr_sequencia_ww			bigint;
nr_movimento_estoque_w		bigint;
dt_movimento_estoque_w		timestamp;
cd_material_w			integer;
cd_conta_contabil_w		varchar(20);
cd_centro_custo_w		integer;
cd_grupo_desconsidera_w	        Grupo_material.cd_grupo_material%type;	
cd_subgrupo_desconsidera_w	SubGrupo_Material.cd_SubGrupo_Material%type;
cd_classe_desconsidera_w	Classe_material.cd_Classe_material%type;
cd_material_desconsidera_w	Material.cd_material%type;
ie_ctb_online_w			ctb_param_lote_nf.ie_ctb_online%type;

cd_natureza_operacao_w		nota_fiscal.cd_natureza_operacao%type;

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.cd_natureza_operacao
from	nota_fiscal a
where	a.cd_estabelecimento 	= cd_estabelecimento_p
and	a.nr_sequencia		= coalesce(nr_sequencia_ww, a.nr_sequencia)
and	((a.cd_cgc_emitente	= coalesce(cd_cnpj_p, a.cd_cgc_emitente)) or (coalesce(cd_cnpj_p::text, '') = '' and (a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '')))
and	((ie_calculada_p = 2) or
	(ie_calculada_p = 0 AND a.dt_atualizacao_estoque IS NOT NULL AND a.dt_atualizacao_estoque::text <> '') or
	((ie_calculada_p = 1) and (coalesce(a.dt_atualizacao_estoque::text, '') = '')))
and	((ie_situacao_p = 0) or
	(ie_situacao_p = 1 AND a.ie_situacao = '1') or 
	(ie_situacao_p = 2 AND a.ie_situacao = '9') or 
	(ie_situacao_p = 3 AND a.ie_situacao = '3') or 
	(ie_situacao_p = 4 AND a.ie_situacao = '2'))
and (ie_entrada_saida_p = 'T' or obter_se_nota_entrada_saida(a.nr_sequencia) = ie_entrada_saida_p)
and	a.dt_entrada_saida between dt_inicial_p and fim_dia(dt_final_p)
and	((coalesce(a.nr_lote_contabil,0) = 0) or coalesce(ie_ctb_online_w,'N') <> 'N');

C02 CURSOR FOR
SELECT	a.nr_movimento_estoque,
	a.dt_movimento_estoque,
	a.cd_material
from	movimento_estoque a,
	estrutura_material_v e
where	a.cd_material = e.cd_material
and	nr_seq_tab_orig		= nr_sequencia_w
and	ie_origem_documento	= 1
and	((cd_grupo_desconsidera_w = 0) or
	(cd_grupo_desconsidera_w > 0 AND e.cd_grupo_material <> cd_grupo_desconsidera_w))
and	((cd_subgrupo_desconsidera_w = 0) or
	(cd_subgrupo_desconsidera_w > 0 AND e.cd_subgrupo_material <> cd_subgrupo_desconsidera_w))	
and	((cd_classe_desconsidera_w = 0) or
	(cd_classe_desconsidera_w > 0 AND e.cd_classe_material <> cd_classe_desconsidera_w))
and	((cd_material_desconsidera_w = 0) or
	(cd_material_desconsidera_w > 0 AND e.cd_material <> cd_material_desconsidera_w));


BEGIN

nr_sequencia_ww	:= nr_sequencia_p;
cd_grupo_desconsidera_w := coalesce(cd_grupo_desconsidera_p,0);
cd_subgrupo_desconsidera_w := coalesce(cd_subgrupo_desconsidera_p,0);	
cd_classe_desconsidera_w := coalesce(cd_classe_desconsidera_p,0);
cd_material_desconsidera_w := coalesce(cd_material_desconsidera_p,0);

if (nr_sequencia_ww = 0) then
	nr_sequencia_ww := null;
end if;

ie_ctb_online_w := ctb_online_pck.get_modo_lote(2, cd_estabelecimento_p);

open C01;
loop
fetch C01 into	
	nr_sequencia_w,
	cd_natureza_operacao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (coalesce(ie_conta_contabil_p,'N') = 'S') then
		CALL atualizar_conta_contabil_nf(
			cd_estabelecimento_p,
			nr_sequencia_w,
			cd_grupo_desconsidera_w,
			cd_subgrupo_desconsidera_w,
			cd_classe_desconsidera_w,
			cd_material_desconsidera_w,
			nm_usuario_p);
	end if;
	if (ie_conta_financ_p = 'S') then
		CALL atualizar_conta_financ_nf(
			cd_estabelecimento_p,
			nr_sequencia_w,
			cd_grupo_desconsidera_w,
			cd_subgrupo_desconsidera_w,
			cd_classe_desconsidera_w,
			cd_material_desconsidera_w,
			nm_usuario_p);
	end if;

	if (coalesce(ie_nota_fiscal_p,'N') = 'S') then
		begin
		open C02;
		loop
		fetch C02 into	
			nr_movimento_estoque_w,
			dt_movimento_estoque_w,
			cd_material_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			
			SELECT * FROM define_conta_material(
				cd_estabelecimento_p, cd_material_w, '2', null, 0, '0', 0, null, null, null, null, Null, dt_movimento_estoque_w, cd_conta_contabil_w, cd_centro_custo_w, '', null, null, null, null, null, null, cd_natureza_operacao_w) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w;
			
			update	movimento_estoque
			set	cd_conta_contabil	= cd_conta_contabil_w
			where	nr_movimento_estoque	= nr_movimento_estoque_w;
			
			end;
		end loop;
		close c02;
		end;
	end if;

	end;
end loop;
close C01;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_dados_nota_fiscal ( cd_estabelecimento_p bigint, nr_sequencia_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, cd_cnpj_p text, ie_calculada_p bigint, ie_situacao_p bigint, ie_entrada_saida_p text, ie_conta_contabil_p text, ie_conta_financ_p text, ie_nota_fiscal_p text, cd_grupo_desconsidera_p bigint, cd_subgrupo_desconsidera_p bigint, cd_classe_desconsidera_p bigint, cd_material_desconsidera_p bigint, nm_usuario_p text) FROM PUBLIC;

