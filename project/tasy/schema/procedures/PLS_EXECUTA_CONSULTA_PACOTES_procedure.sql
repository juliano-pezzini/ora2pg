-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_executa_consulta_pacotes ( nr_sequencia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint ) AS $body$
DECLARE


w_cd_token varchar(1000);
w_ds_username varchar(1000);
w_ds_password varchar(1000);
w_cd_unimed varchar(1000);
w_cd_unimed_origem varchar(1000);
w_cd_procedimento varchar(1000);
w_cd_procedimento_princ varchar(1000);
w_tp_acomodacao varchar(1000);
w_ie_situacao_pacote varchar(1000);
w_cd_especialidade varchar(1000);
w_tp_pacote varchar(1000);
w_cd_prest_autorizacao varchar(1000);
w_cd_cnpj_cpf_prest varchar(1000);
w_ie_pacote_local varchar(1);
w_qt_limit varchar(10);
w_qt_offset varchar(10);
w_json text;
w_dt_referencia timestamp;
ds_retorno_integracao_w varchar(4000);
w_qt_registros bigint;


BEGIN

select cd_token, ds_username, ds_password,cd_unimed
  into STRICT w_cd_token, w_ds_username, w_ds_password, w_cd_unimed
  from pls_sis_pac_autenticacao
 where dt_inicio <= clock_timestamp()
   and coalesce(dt_fim,clock_timestamp()) >= clock_timestamp()  LIMIT 1;

select cd_unimed_origem, cd_procedimento, cd_procedimento_princ,
       ie_tp_acomodacao, ie_situacao_pacote, cd_especialidade,
       ie_tp_pacote, cd_prest_autorizacao, cd_cnpj_cpf_prest, dt_referencia,
       ie_pacote_local, qt_limit, qt_offset
  into STRICT w_cd_unimed_origem,w_cd_procedimento,w_cd_procedimento_princ,
       w_tp_acomodacao,w_ie_situacao_pacote,w_cd_especialidade,
       w_tp_pacote,w_cd_prest_autorizacao,w_cd_cnpj_cpf_prest, w_dt_referencia,
       w_ie_pacote_local, w_qt_limit, w_qt_offset
  from pls_sis_pac_requisicao
  where nr_sequencia = nr_sequencia_p;

select count(1)
  into STRICT w_qt_registros
  from pls_sis_pac_retorno_pacote
  where nr_seq_requisicao = nr_sequencia_p;

  if (coalesce(w_qt_offset, 0) = 0) then
    update pls_sis_pac_requisicao
       set dt_request = clock_timestamp()
    where nr_sequencia = nr_sequencia_p;
  end if;

  w_json := '{';
  w_json := w_json || '"token": "'     || w_cd_token    || '" ';
  w_json := w_json || ',"username": "' || w_ds_username || '" ';
  w_json := w_json || ',"password": "' || w_ds_password || '" ';
  w_json := w_json || ',"unimed": "'   || w_cd_unimed   || '" ';
  w_json := w_json || ',"request_id":' || nr_sequencia_p;
  w_json := w_json || ',"tasyUser": "' || nm_usuario_p   || '" ';
  w_json := w_json || ',"cd_estabelecimento": '   || cd_estabelecimento_p;


  if (w_cd_unimed_origem IS NOT NULL AND w_cd_unimed_origem::text <> '')then
    w_json := w_json || ',"cd_uni_ori": '    || ltrim(w_cd_unimed_origem,0);
  end if;

  if (w_cd_procedimento IS NOT NULL AND w_cd_procedimento::text <> '')then
    w_json := w_json || ',"cd_pacote": '     || w_cd_procedimento;
  end if;

  if (w_cd_procedimento_princ IS NOT NULL AND w_cd_procedimento_princ::text <> '')then
    w_json := w_json || ',"cd_item": '       || w_cd_procedimento_princ;
  end if;

  if (w_tp_acomodacao IS NOT NULL AND w_tp_acomodacao::text <> '')then
    w_json := w_json || ',"tp_acomodacao": "'|| w_tp_acomodacao  || '"';
  end if;

  if (w_ie_situacao_pacote IS NOT NULL AND w_ie_situacao_pacote::text <> '')then
    w_json := w_json || ',"st_pacote": '     || w_ie_situacao_pacote;
  end if;

  if (w_cd_especialidade IS NOT NULL AND w_cd_especialidade::text <> '')then
    w_json := w_json || ',"cd_espec": '      || w_cd_especialidade;
  end if;

  if (w_tp_pacote IS NOT NULL AND w_tp_pacote::text <> '')then
    w_json := w_json || ',"tp_pacote": '     || w_tp_pacote;
  end if;

  if (w_dt_referencia IS NOT NULL AND w_dt_referencia::text <> '')then
    w_json := w_json || ',"dt_referencia": "' || w_dt_referencia    || '"';
  end if;

  if (w_cd_prest_autorizacao IS NOT NULL AND w_cd_prest_autorizacao::text <> '')then
    w_json := w_json || ',"cd_prest": '    || w_cd_prest_autorizacao;
  end if;

  if (w_cd_cnpj_cpf_prest IS NOT NULL AND w_cd_cnpj_cpf_prest::text <> '')then
    w_json := w_json || ',"cd_cpf_cnpj": ' || w_cd_cnpj_cpf_prest;
  end if;

  w_json := w_json || ',"offset": ' || coalesce(w_qt_offset,0);

  if (w_qt_registros < w_qt_limit) then
    if (w_qt_limit - w_qt_registros > 1000) then
      w_json := w_json || ',"limit": ' || 1000;
    else
      w_json := w_json || ',"limit": ' || (w_qt_limit - w_qt_registros);
    end if;
  else
    w_json := w_json || ',"limit": ' || coalesce(w_qt_limit,1000);
  end if;
  w_json := w_json || '}';

  select bifrost.send_integration_content(
    'consult.pack',w_json,
    nm_usuario_p)
    into STRICT ds_retorno_integracao_w
;
	update pls_sis_pac_requisicao
	   set ie_status_transacao = 'P'
	 where nr_sequencia = nr_sequencia_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_executa_consulta_pacotes ( nr_sequencia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint ) FROM PUBLIC;

