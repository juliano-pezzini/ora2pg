-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_sus_aih_reg_civil () AS $body$
DECLARE


ds_comando_w		varchar(2000);

nr_aih_w		bigint;
nr_atendimento_w	bigint;
nr_sequencia_w		bigint;
qt_contador_w		bigint	:= 0;
qt_atend_null_w		bigint	:= 0;

c01 CURSOR FOR
	SELECT	a.nr_aih,
	   	a.nr_atendimento,
	   	b.nr_sequencia
	from	sus_aih_reg_civil	b,
	   	sus_aih			a
	where	a.nr_aih 	= b.nr_aih
	and	a.nr_sequencia	= b.nr_seq_aih
	and	coalesce(b.nr_atendimento::text, '') = '';


BEGIN

lock table SUS_AIH_REG_CIVIL in exclusive mode;
ds_comando_w	:= 'Alter trigger SUS_AIH_REG_CIVIL_ATUAL disable';
CALL Exec_Sql_Dinamico('Disable trigger', ds_comando_w);

open	c01;
loop
fetch	c01 into
	nr_aih_w,
	nr_atendimento_w,
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	if (nr_atendimento_w > 0) then
		update	sus_aih_reg_civil
		set	nr_atendimento	= nr_atendimento_w
		where	nr_sequencia	= nr_sequencia_w
		and	coalesce(nr_atendimento::text, '') = '';

		qt_contador_w	:= qt_contador_w + 1;

		if (qt_contador_w = 1000) then
			commit;
			qt_contador_w	:= 0;
		end if;
	end if;

	end;
end loop;
close c01;

ds_comando_w	:= 'Alter trigger SUS_AIH_REG_CIVIL_ATUAL enable';
CALL Exec_Sql_Dinamico('Disable trigger', ds_comando_w);

select	count(*)
into STRICT	qt_atend_null_w
from	sus_aih_reg_civil
where	coalesce(nr_atendimento::text, '') = '';

if (qt_atend_null_w = 0) then
	CALL Exec_sql_Dinamico('Felipe', 'alter table sus_aih_reg_civil modify nr_atendimento number(10) not  null');
end if;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_sus_aih_reg_civil () FROM PUBLIC;

