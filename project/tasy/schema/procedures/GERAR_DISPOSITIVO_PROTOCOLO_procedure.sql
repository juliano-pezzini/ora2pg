-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_dispositivo_protocolo ( cd_protocolo_p bigint, nr_Atendimento_p bigint, nr_seq_procolo_p bigint, nm_usuario_p text) AS $body$
DECLARE


Ie_opcao_w				varchar(3);
nr_seq_dispositivo_w	bigint;
nr_seq_topografia_w		bigint;
ie_lado_w				varchar(1);
ds_titulo_w				varchar(100);
qt_hora_permanencia_w	bigint;
qt_hora_perm_curat_w	smallint;
ds_observacao_w			varchar(255);
ie_acao_w				varchar(15);
QT_DISP_UTILIZADOS_w	bigint;
ie_retira_alta_w		varchar(1);
nr_seq_disp_atend_w	bigint;
nr_seq_qua_evento_w		bigint;

C01 CURSOR FOR
	SELECT 	a.nr_seq_dispositivo,
		a.nr_seq_topografia,
		a.ie_lado,
		a.ds_titulo,
		a.qt_hora_permanencia,
		a.qt_hora_perm_curat,
		ds_observacao,
		substr(a.ie_acao,2,length(a.ie_acao)),
		QT_DISP_UTILIZADOS,
		CASE WHEN substr(a.ie_acao,1,1)='S' THEN  'SAE'  ELSE 'P' END
	from	protocolo_dipositivo a
	where	a.cd_protocolo = cd_protocolo_p
	and	a.NR_SEQUENCIA = nr_seq_procolo_p;


BEGIN

If (cd_protocolo_p IS NOT NULL AND cd_protocolo_p::text <> '') and (nr_seq_procolo_p IS NOT NULL AND nr_seq_procolo_p::text <> '') then
	ie_retira_alta_w := obter_param_usuario(1113, 232, Wheb_usuario_pck.get_cd_perfil, nm_usuario_p, 0, ie_retira_alta_w);
	open C01;
	loop
	fetch C01 into
		nr_seq_dispositivo_w,
		nr_seq_topografia_w,
		ie_lado_w,
		ds_titulo_w,
		qt_hora_permanencia_w,
		qt_hora_perm_curat_w,
		ds_observacao_w,
		ie_acao_w,
		QT_DISP_UTILIZADOS_w,
		Ie_opcao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		SELECT * FROM registrar_dipositivo(clock_timestamp(), 0, nr_seq_dispositivo_w, ie_acao_w, 0, 0, 0, 0, null, nr_atendimento_p, nr_seq_topografia_w, ie_lado_w, ds_titulo_w, nm_usuario_p, 'N', null, null, qt_hora_permanencia_w, null, obter_pessoa_fisica_usuario(nm_usuario_p, 'C'), null, null, qt_hora_perm_curat_w, null, null, qt_disp_utilizados_w, 'N', ie_retira_alta_w, ie_opcao_w, nr_seq_disp_atend_w, null, null, null, 'N', 'N', 'N', 'S', null, null, nr_seq_qua_evento_w) INTO STRICT nr_seq_disp_atend_w, nr_seq_qua_evento_w;
		end;
	end loop;
	close C01;
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_dispositivo_protocolo ( cd_protocolo_p bigint, nr_Atendimento_p bigint, nr_seq_procolo_p bigint, nm_usuario_p text) FROM PUBLIC;

