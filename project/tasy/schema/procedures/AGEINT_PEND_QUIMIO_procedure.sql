-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ageint_pend_quimio (nr_seq_agenda_p bigint, lista_pend_quimio text) AS $body$
DECLARE

    nm_usuario_w         varchar(255);
    nr_duracao_w         bigint;
    grupo_quimio_w       bigint;
    tipo_grupo_quimio_w  varchar(15);
    nr_seq_pendencia_w   w_pendencia_agequi.nr_seq_pendencia%TYPE;
    nr_seq_atendimento_w paciente_atendimento.nr_seq_atendimento%TYPE;
    lista_pend_quimio_w  varchar(4000) := lista_pend_quimio || ',';
    tam_lista_w          bigint;
    ie_pos_virgula_w     smallint;

BEGIN

    grupo_quimio_w := obter_param_usuario(869, 320, obter_perfil_ativo, obter_usuario_ativo, obter_estabelecimento_ativo, grupo_quimio_w);

    tipo_grupo_quimio_w := obter_param_usuario(869, 321, obter_perfil_ativo, obter_usuario_ativo, obter_estabelecimento_ativo, tipo_grupo_quimio_w);

    nm_usuario_w := obter_usuario_ativo;

    WHILE(lista_pend_quimio_w IS NOT NULL AND lista_pend_quimio_w::text <> '') LOOP
        BEGIN

            ie_pos_virgula_w := position(',' in lista_pend_quimio_w);
            tam_lista_w      := length(lista_pend_quimio_w);

            IF (ie_pos_virgula_w <> 0) THEN
                nr_seq_pendencia_w  := (substr(lista_pend_quimio_w, 1, (ie_pos_virgula_w - 1)))::numeric;
                lista_pend_quimio_w := substr(lista_pend_quimio_w, (ie_pos_virgula_w + 1), tam_lista_w);

                SELECT MAX(a.qt_tempo_medic)
                  INTO STRICT nr_duracao_w
                  FROM paciente_setor       a,
                       paciente_atendimento b,
                       qt_pendencia_agenda  c
                 WHERE a.nr_seq_paciente = b.nr_seq_paciente
                   AND b.nr_seq_pend_agenda = c.nr_sequencia
                   AND c.nr_sequencia = nr_seq_pendencia_w;

                SELECT MAX(b.nr_seq_atendimento)
                  INTO STRICT nr_seq_atendimento_w
                  FROM qt_pendencia_agenda  c,
                       paciente_atendimento b
                 WHERE c.nr_sequencia = nr_seq_pendencia_w
                   AND b.nr_seq_pend_agenda = c.nr_sequencia;

                INSERT INTO agenda_integrada_item(nr_sequencia,
                     ie_tipo_agendamento,
                     ie_tipo_pend_agenda,
                     nr_minuto_duracao,
                     nr_seq_pend_quimio,
                     nr_seq_agenda_int,
                     dt_atualizacao,
                     nm_usuario,
                     dt_atualizacao_nrec,
                     nm_usuario_nrec,
                     nr_seq_grupo_quimio,
                     nr_seq_atendimento)
                VALUES (nextval('agenda_integrada_item_seq'),
                     'Q',
                     CASE WHEN coalesce(tipo_grupo_quimio_w::text, '') = '' THEN  'Q'  ELSE tipo_grupo_quimio_w END ,
                     nr_duracao_w,
                     nr_seq_pendencia_w,
                     nr_seq_agenda_p,
                     clock_timestamp(),
                     nm_usuario_w,
                     clock_timestamp(),
                     nm_usuario_w,
                     CASE WHEN coalesce(grupo_quimio_w::text, '') = '' THEN  NULL  ELSE grupo_quimio_w END ,
                     nr_seq_atendimento_w);
                COMMIT;
            ELSE
                lista_pend_quimio_w := NULL;
            END IF;
        END;
    END LOOP;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageint_pend_quimio (nr_seq_agenda_p bigint, lista_pend_quimio text) FROM PUBLIC;

