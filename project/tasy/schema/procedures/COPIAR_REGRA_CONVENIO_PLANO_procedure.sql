-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_regra_convenio_plano (cd_convenio_origem_p bigint, cd_plano_origem_p text, ie_tipo_atend_origem_p bigint, cd_convenio_destino_p bigint, cd_plano_destino_p text, ie_tipo_atend_destino_p bigint, ie_copiar_proc_p text, ie_copiar_mat_p text, ie_regra_selecionada_p text, nr_sequencia_p bigint, cd_estab_origem_p bigint, cd_estab_destino_p bigint, nm_usuario_p text) AS $body$
DECLARE


IE_REGRA_w			varchar(3);
IE_TIPO_ATENDIMENTO_w		smallint;
CD_SETOR_ATENDIMENTO_w		bigint;
CD_AREA_PROCEDIMENTO_w		bigint;
CD_ESPECIALIDADE_PROC_w		bigint;
CD_GRUPO_PROC_w			bigint;
CD_PROCEDIMENTO_w		bigint;
IE_ORIGEM_PROCED_w		bigint;
CD_TIPO_ACOMODACAO_w		bigint;
CD_GRUPO_MATERIAL_w		bigint;
CD_SUBGRUPO_MATERIAL_w		bigint;
CD_CLASSE_MATERIAL_w		bigint;
CD_MATERIAL_w			bigint;
ie_valor_w			varchar(3);
qt_ponto_min_w		double precision;
qt_ponto_max_w		double precision;
VL_MATERIAL_MIN_w		double precision;
VL_MATERIAL_MAX_w		double precision;
dt_inicio_vigencia_w		timestamp;
dt_fim_vigencia_w		timestamp;
nr_seq_grupo_w			bigint;
nr_seq_subgrupo_w		bigint;
nr_seq_forma_org_w		bigint;

ie_regra_valor_w		varchar(3);
ie_nova_autorizacao_w		varchar(1);
ie_autor_particular_w		varchar(1);
ie_autor_kit_w			varchar(1);
nr_seq_familia_w		bigint;
ie_situacao_w			varchar(15) := 'A';
cd_estabelecimento_w		integer;
cd_estab_material_w		integer;
nr_seq_proc_interno_w		bigint;

cd_plano_w			varchar(10);
dt_atualizacao_w		timestamp;
nm_usuario_w			varchar(15);
nr_seq_exame_w			bigint;
cd_classif_setor_w		varchar(2);
ie_clinica_w			integer;	
ie_resp_autor_w			varchar(3);
ie_prioridade_w			varchar(1);
cd_doenca_w			varchar(10);
cd_categoria_w			varchar(10);
nr_seq_classif_atend_w		bigint;
cd_setor_entrega_prescr_w	integer;
cd_setor_atual_w		bigint;
ie_carater_inter_sus_w		varchar(2);
cd_empresa_conv_w		bigint;
qt_minimo_w			double precision;
qt_maximo_w			double precision;
nr_seq_classif_w		bigint;
ds_observacao_w			varchar(255);
ds_mascara_carteira_w		varchar(30);
cd_medico_executor_w		varchar(10);
cd_especialidade_medic_w	integer;
ie_autor_particular_w2		varchar(1);
ie_qt_total_autor_w		varchar(1);
ie_somente_item_w		varchar(1);
ds_inconsist_prescr_w		varchar(255);
qt_idade_min_w			smallint;
qt_idade_max_w			smallint;
nr_seq_cobertura_w		bigint;
cd_perfil_w			integer;
cd_edicao_amb_w			integer;
nr_seq_classif_proc_int_w	bigint;	

cd_tipo_acomodacao_w2		smallint;	
ds_observacao_w2		varchar(255);	
cd_classif_setor_w2		varchar(2);
ie_carater_inter_sus_w2		varchar(2);
ie_clinica_w2			integer;
ie_nova_autorizacao_w2		varchar(1);
ds_mascara_carteira_w2		varchar(30);
cd_doenca_w2			varchar(10);
qt_minima_w2			double precision;
qt_maxima_w2			double precision;
cd_empresa_conv_w2		bigint;
ie_gerar_mat_esp_w2		varchar(1);
ie_mat_conta_w2			varchar(1);
ie_autor_kit_w2			varchar(1);
ie_consignado_w2		varchar(1);
nr_seq_cobertura_w2		bigint;
ie_gerar_vl_zerado_w2		varchar(15);
cd_categoria_w2			varchar(10);
ie_valor_dia_w2			varchar(1);
ie_valor_unitario_w2		varchar(1);
nr_seq_classif_w2		bigint;	
ie_resp_autor_w2		varchar(3);
cd_perfil_w2			integer;
ie_tipo_material_w		varchar(3);
ie_classificacao_w		varchar(3);
nr_seq_estrutura_w				regra_convenio_plano_mat.nr_seq_estrutura%type;
ie_regra_quantidade_solic_w 	regra_convenio_plano_mat.ie_regra_quantidade_solic%type;
cd_material_estoque_w		    regra_convenio_plano_mat.cd_material_estoque%type;
ie_final_vig_dose_dia_prescr_w	regra_convenio_plano_mat.ie_final_vig_dose_dia_prescr%type;
ie_exige_just_medica_w			regra_convenio_plano_mat.ie_exige_just_medica%type;
ie_tiss_tipo_anexo_w			regra_convenio_plano_mat.ie_tiss_tipo_anexo%type;
ie_tiss_tipo_etapa_autor_w		regra_convenio_plano_mat.ie_tiss_tipo_etapa_autor%type;
cd_empresa_w regra_convenio_plano.cd_empresa%type;
cd_empresa_mat_w regra_convenio_plano_mat.cd_empresa%type;

c01 CURSOR FOR
SELECT	IE_REGRA,
	IE_TIPO_ATENDIMENTO,
	CD_SETOR_ATENDIMENTO,
	CD_AREA_PROCEDIMENTO,
	CD_ESPECIALIDADE_PROC,
	CD_GRUPO_PROC,
	CD_PROCEDIMENTO,
	IE_ORIGEM_PROCED,
	CD_TIPO_ACOMODACAO,
	IE_VALOR,
	QT_PONTO_MIN,
	QT_PONTO_MAX,
	cd_tipo_acomodacao,
	dt_inicio_vigencia,
	dt_fim_vigencia,
	nr_seq_grupo,
	nr_seq_subgrupo, 
	nr_seq_forma_org,
	ie_regra_valor,
	ie_nova_autorizacao,
	ie_autor_kit,
	coalesce(ie_situacao,'A'),
	cd_estabelecimento,
	nr_seq_proc_interno,
	nr_seq_exame,
	cd_classif_setor,
	ie_clinica,
	ie_resp_autor,
	ie_prioridade,
	cd_doenca,
	nr_seq_classif_atend,
	cd_setor_entrega_prescr,
	cd_setor_atual,
	ie_carater_inter_sus,
	cd_empresa_conv,
	qt_minimo,
	qt_maximo,
	nr_seq_classif,
	ds_observacao,
	ds_mascara_carteira,
	cd_medico_executor,
	cd_especialidade_medic,
	ie_autor_particular,
	ie_qt_total_autor,
	ie_somente_item,
	ds_inconsist_prescr,
	qt_idade_min,
	qt_idade_max,
	nr_seq_cobertura,
	cd_perfil,
	cd_edicao_amb,
	nr_seq_classif_proc_int,
    cd_empresa
from	regra_convenio_plano
where	cd_convenio		= cd_convenio_origem_p
and (coalesce(cd_plano, cd_plano_origem_p)	= cd_plano_origem_p or coalesce(cd_plano_origem_p::text, '') = '')
and (ie_tipo_atendimento	= ie_tipo_atend_origem_p or coalesce(ie_tipo_atend_origem_p::text, '') = '')
and	ie_copiar_proc_p	=  'S'
and 	((ie_regra_selecionada_p = 'S' and nr_sequencia = nr_sequencia_p) or (ie_regra_selecionada_p = 'N'))
and (cd_estabelecimento = cd_estab_origem_p or coalesce(cd_estab_origem_p,0) = 0)
and 	coalesce(cd_empresa, coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0)) = coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0);

c02 CURSOR FOR
SELECT	IE_REGRA,
	IE_TIPO_ATENDIMENTO,
	CD_SETOR_ATENDIMENTO,
	CD_GRUPO_MATERIAL,
	CD_SUBGRUPO_MATERIAL,
	CD_CLASSE_MATERIAL,
	CD_MATERIAL,
	IE_VALOR,
	VL_MATERIAL_MIN,
	VL_MATERIAL_MAX,
	dt_inicio_vigencia,
	dt_fim_vigencia,
	ie_autor_particular,
	nr_seq_familia,
	cd_estabelecimento,
	cd_tipo_acomodacao,
	ds_observacao,
	cd_classif_setor,
	ie_carater_inter_sus,
	ie_clinica,
	ie_nova_autorizacao,
	ds_mascara_carteira,
	cd_doenca,
	qt_minima,
	qt_maxima,
	cd_empresa_conv,
	ie_gerar_mat_esp,
	ie_mat_conta,
	ie_autor_kit,
	ie_consignado,
	nr_seq_cobertura,
	ie_gerar_vl_zerado,
	ie_valor_dia,
	ie_valor_unitario,		
	nr_seq_classif,			
	ie_resp_autor,
	cd_perfil,
	ie_tipo_material,
	ie_classificacao,
	nr_seq_estrutura,		
	ie_regra_quantidade_solic,
	cd_material_estoque,
	ie_final_vig_dose_dia_prescr, 
	ie_exige_just_medica, 
	ie_tiss_tipo_anexo,
	ie_tiss_tipo_etapa_autor,
	cd_categoria,
    cd_empresa
from	regra_convenio_plano_mat
where	cd_convenio		= cd_convenio_origem_p
and (coalesce(cd_plano, cd_plano_origem_p)		= cd_plano_origem_p or coalesce(cd_plano_origem_p::text, '') = '')
and (ie_tipo_atendimento	= ie_tipo_atend_origem_p or coalesce(ie_tipo_atend_origem_p::text, '') = '')
and	ie_copiar_mat_p	=  'S'
and 	((ie_regra_selecionada_p = 'S' and nr_sequencia = nr_sequencia_p) or (ie_regra_selecionada_p = 'N'))
and (cd_estabelecimento = cd_estab_origem_p or coalesce(cd_estab_origem_p,0) = 0)
and 	coalesce(cd_empresa, coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0)) = coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0);


BEGIN

if (coalesce(cd_convenio_origem_p::text, '') = '') or (coalesce(cd_convenio_destino_p::text, '') = '') then
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(194509);
end if;

open c01;
loop
fetch c01 into
	IE_REGRA_w,
	IE_TIPO_ATENDIMENTO_w,
	CD_SETOR_ATENDIMENTO_w,
	CD_AREA_PROCEDIMENTO_w,
	CD_ESPECIALIDADE_PROC_w,
	CD_GRUPO_PROC_w,
	CD_PROCEDIMENTO_w,
	IE_ORIGEM_PROCED_w,
	CD_TIPO_ACOMODACAO_w,
	ie_valor_w,
	qt_ponto_min_w,
	qt_ponto_max_w,
	cd_tipo_acomodacao_w,
	dt_inicio_vigencia_w,
	dt_fim_vigencia_w,
	nr_seq_grupo_w,
	nr_seq_subgrupo_w, 
	nr_seq_forma_org_w,
	ie_regra_valor_w,
	ie_nova_autorizacao_w,
	ie_autor_kit_w,
	ie_situacao_w,
	cd_estabelecimento_w,
	nr_seq_proc_interno_w,	
	nr_seq_exame_w,			
	cd_classif_setor_w,		
	ie_clinica_w,			
	ie_resp_autor_w,			
	ie_prioridade_w,		
	cd_doenca_w,					
	nr_seq_classif_atend_w,		
	cd_setor_entrega_prescr_w,
	cd_setor_atual_w,
	ie_carater_inter_sus_w,
	cd_empresa_conv_w,	
	qt_minimo_w,		
	qt_maximo_w,			
	nr_seq_classif_w,
	ds_observacao_w,		
	ds_mascara_carteira_w,
	cd_medico_executor_w,	
	cd_especialidade_medic_w,
	ie_autor_particular_w2,	
	ie_qt_total_autor_w,	
	ie_somente_item_w,		
	ds_inconsist_prescr_w,
	qt_idade_min_w,	
	qt_idade_max_w,		
	nr_seq_cobertura_w,
	cd_perfil_w,		
	cd_edicao_amb_w,
	nr_seq_classif_proc_int_w,
    cd_empresa_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	insert into regra_convenio_plano(NR_SEQUENCIA,
		CD_CONVENIO,
		CD_PLANO,
		IE_REGRA,
		DT_ATUALIZACAO,
		NM_USUARIO,
		IE_TIPO_ATENDIMENTO,
		CD_SETOR_ATENDIMENTO,
		CD_AREA_PROCEDIMENTO,
		CD_ESPECIALIDADE_PROC,
		CD_GRUPO_PROC,
		CD_PROCEDIMENTO,
		IE_ORIGEM_PROCED,
		CD_TIPO_ACOMODACAO,
		IE_VALOR,
		QT_PONTO_MIN,
		QT_PONTO_MAX,
		dt_inicio_vigencia,
		dt_fim_vigencia,
		nr_seq_grupo,
		nr_seq_subgrupo, 
		nr_seq_forma_org,
		ie_regra_valor,
		ie_nova_autorizacao,
		ie_autor_kit,
		ie_situacao,
		cd_estabelecimento,
		nr_seq_proc_interno,
		nr_seq_exame,
		cd_classif_setor,
		ie_clinica,
		ie_resp_autor,
		ie_prioridade,
		cd_doenca,
		nr_seq_classif_atend,
		cd_setor_entrega_prescr,
		cd_setor_atual,
		ie_carater_inter_sus,
		cd_empresa_conv,
		qt_minimo,
		qt_maximo,
		nr_seq_classif,
		ds_observacao,
		ds_mascara_carteira,
		cd_medico_executor,
		cd_especialidade_medic,
		ie_autor_particular,
		ie_qt_total_autor,
		ie_somente_item,
		ds_inconsist_prescr,
		qt_idade_min,
		qt_idade_max,
		nr_seq_cobertura,
		cd_perfil,
		cd_edicao_amb,
		nr_seq_classif_proc_int,
        cd_empresa)
	values (nextval('regra_convenio_plano_seq'),
		cd_convenio_destino_p,
		cd_plano_destino_p,
		ie_regra_w,
		clock_timestamp(),
		nm_usuario_p,
		coalesce(ie_tipo_atend_destino_p, ie_tipo_atendimento_w),
		cd_setor_atendimento_w,
		cd_area_procedimento_w,
		cd_especialidade_proc_w,
		cd_grupo_proc_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		cd_tipo_acomodacao_w,
		ie_valor_w,
		qt_ponto_min_w,
		qt_ponto_max_w,
		dt_inicio_vigencia_w,
		dt_fim_vigencia_w, 
		nr_seq_grupo_w,
		nr_seq_subgrupo_w, 
		nr_seq_forma_org_w,
		ie_regra_valor_w,
		ie_nova_autorizacao_w,
		ie_autor_kit_w,
		ie_situacao_w,
		CASE WHEN cd_estab_destino_p=0 THEN cd_estabelecimento_w  ELSE cd_estab_destino_p END ,
		nr_seq_proc_interno_w,
		nr_seq_exame_w,			
		cd_classif_setor_w,		
		ie_clinica_w,			
		ie_resp_autor_w,			
		ie_prioridade_w,		
		cd_doenca_w,		
		nr_seq_classif_atend_w,		
		cd_setor_entrega_prescr_w,
		cd_setor_atual_w,
		ie_carater_inter_sus_w,
		cd_empresa_conv_w,	
		qt_minimo_w,		
		qt_maximo_w,			
		nr_seq_classif_w,
		ds_observacao_w,		
		ds_mascara_carteira_w,
		cd_medico_executor_w,	
		cd_especialidade_medic_w,
		ie_autor_particular_w2,	
		ie_qt_total_autor_w,	
		ie_somente_item_w,		
		ds_inconsist_prescr_w,
		qt_idade_min_w,	
		qt_idade_max_w,		
		nr_seq_cobertura_w,
		cd_perfil_w,		
		cd_edicao_amb_w,
		nr_seq_classif_proc_int_w,
        cd_empresa_w);

end loop;
close c01;


open c02;
loop
fetch c02 into
	IE_REGRA_w,
	IE_TIPO_ATENDIMENTO_w,
	CD_SETOR_ATENDIMENTO_w,
	CD_GRUPO_MATERIAL_w,
	CD_SUBGRUPO_MATERIAL_w,
	CD_CLASSE_MATERIAL_w,
	CD_MATERIAL_w,
	IE_VALOR_w,
	VL_MATERIAL_MIN_w,
	VL_MATERIAL_MAX_w,
	dt_inicio_vigencia_w,
	dt_fim_vigencia_w,
	ie_autor_particular_w,
	nr_seq_familia_w,
	cd_estab_material_w,
	cd_tipo_acomodacao_w2,
	ds_observacao_w2,
	cd_classif_setor_w2,
	ie_carater_inter_sus_w2,
	ie_clinica_w2,
	ie_nova_autorizacao_w2,	
	ds_mascara_carteira_w2,	
	cd_doenca_w2,
	qt_minima_w2,
	qt_maxima_w2,
	cd_empresa_conv_w2,
	ie_gerar_mat_esp_w2,
	ie_mat_conta_w2,
	ie_autor_kit_w2,
	ie_consignado_w2,
	nr_seq_cobertura_w2,
	ie_gerar_vl_zerado_w2,
	ie_valor_dia_w2,
	ie_valor_unitario_w2,
	nr_seq_classif_w2,
	ie_resp_autor_w2,
	cd_perfil_w2,
	ie_tipo_material_w,
	ie_classificacao_w,
	nr_seq_estrutura_w,		
	ie_regra_quantidade_solic_w,
	cd_material_estoque_w,
	ie_final_vig_dose_dia_prescr_w, 
	ie_exige_just_medica_w, 
	ie_tiss_tipo_anexo_w,
	ie_tiss_tipo_etapa_autor_w,
	cd_categoria_w2,
    cd_empresa_mat_w;
EXIT WHEN NOT FOUND; /* apply on c02 */

	insert into regra_convenio_plano_mat(NR_SEQUENCIA,
		CD_CONVENIO,
		CD_PLANO,
		IE_REGRA,
		DT_ATUALIZACAO,
		NM_USUARIO,
		IE_TIPO_ATENDIMENTO,
		CD_SETOR_ATENDIMENTO,
		CD_GRUPO_MATERIAL,
		CD_SUBGRUPO_MATERIAL,
		CD_CLASSE_MATERIAL,
		CD_MATERIAL,
		IE_VALOR,
		VL_MATERIAL_MIN,
		VL_MATERIAL_MAX,
		cd_tipo_acomodacao,
		dt_inicio_vigencia,
		dt_fim_vigencia,
		ie_autor_particular,
		nr_seq_familia,
		cd_estabelecimento,
		ds_observacao,
		cd_classif_setor,
		ie_carater_inter_sus,
		ie_clinica,
		ie_nova_autorizacao,
		ds_mascara_carteira,
		cd_doenca,
		qt_minima,
		qt_maxima,
		cd_empresa_conv,
		ie_gerar_mat_esp,
		ie_mat_conta,
		ie_autor_kit,
		ie_consignado,
		nr_seq_cobertura,
		ie_gerar_vl_zerado,
		ie_valor_dia,
		ie_valor_unitario,		
		nr_seq_classif,			
		ie_resp_autor,
		cd_perfil,
		ie_tipo_material,
		ie_classificacao,
		nr_seq_estrutura,		
		ie_regra_quantidade_solic,
		cd_material_estoque,
		ie_final_vig_dose_dia_prescr, 
		ie_exige_just_medica, 
		ie_tiss_tipo_anexo,
		ie_tiss_tipo_etapa_autor,
		cd_categoria,
        cd_empresa)
	values (nextval('regra_convenio_plano_mat_seq'),
		cd_convenio_destino_p,
		check_if_plan_conv_compatible(cd_plano_destino_p, cd_convenio_destino_p),
		ie_regra_w,
		clock_timestamp(),
		nm_usuario_p,
		coalesce(ie_tipo_atend_destino_p, ie_tipo_atendimento_w),
		cd_setor_atendimento_w,
		cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w,
		cd_material_w,
		IE_VALOR_w,
		VL_MATERIAL_MIN_w,
		VL_MATERIAL_MAX_w,
		cd_tipo_acomodacao_w2,
		dt_inicio_vigencia_w,
		dt_fim_vigencia_w,
		ie_autor_particular_w,
		nr_seq_familia_w,
		CASE WHEN cd_estab_destino_p=0 THEN cd_estab_material_w  ELSE cd_estab_destino_p END ,
		ds_observacao_w2,
		cd_classif_setor_w2,
		ie_carater_inter_sus_w2,
		ie_clinica_w2,
		ie_nova_autorizacao_w2,	
		ds_mascara_carteira_w2,	
		cd_doenca_w2,
		qt_minima_w2,
		qt_maxima_w2,
		cd_empresa_conv_w2,
		ie_gerar_mat_esp_w2,
		ie_mat_conta_w2,
		ie_autor_kit_w2,
		ie_consignado_w2,
		nr_seq_cobertura_w2,
		ie_gerar_vl_zerado_w2,
		ie_valor_dia_w2,
		ie_valor_unitario_w2,
		nr_seq_classif_w2,
		ie_resp_autor_w2,
		cd_perfil_w2,
		ie_tipo_material_w,
		ie_classificacao_w,
		nr_seq_estrutura_w,		
		ie_regra_quantidade_solic_w, 
		cd_material_estoque_w,
		ie_final_vig_dose_dia_prescr_w,
		ie_exige_just_medica_w, 
		ie_tiss_tipo_anexo_w,
		ie_tiss_tipo_etapa_autor_w,
		check_if_categ_conv_compatible(cd_categoria_w2, cd_convenio_destino_p),
        cd_empresa_mat_w);

end loop;
close c02;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_regra_convenio_plano (cd_convenio_origem_p bigint, cd_plano_origem_p text, ie_tipo_atend_origem_p bigint, cd_convenio_destino_p bigint, cd_plano_destino_p text, ie_tipo_atend_destino_p bigint, ie_copiar_proc_p text, ie_copiar_mat_p text, ie_regra_selecionada_p text, nr_sequencia_p bigint, cd_estab_origem_p bigint, cd_estab_destino_p bigint, nm_usuario_p text) FROM PUBLIC;

