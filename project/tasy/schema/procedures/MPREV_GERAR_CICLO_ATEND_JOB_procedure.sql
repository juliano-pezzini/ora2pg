-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mprev_gerar_ciclo_atend_job () AS $body$
DECLARE

 
nr_seq_participante_w		mprev_programa_partic.nr_seq_participante%type;
dt_referencia_w			timestamp;		
			 
C01 CURSOR FOR 
	/* Cursor para pegar todos os participantes que o ciclo terminou no dia anterior */
 
	SELECT	distinct 
		b.nr_seq_participante 
	from 	mprev_prog_partic_modulo a, 
		mprev_programa_partic b, 
		mprev_partic_ciclo_atend c 
	where 	a.nr_seq_programa_partic	= b.nr_sequencia 
	and	a.nr_sequencia = c.NR_SEQ_PROG_PARTIC_MOD  
	and  	c.dt_fim_ciclo = trunc(dt_referencia_w-1) 
	
union all
 
	/* Pegar os que ainda n√£o foi gerado o ciclo */
 
	SELECT	b.nr_seq_participante 
	from 	mprev_prog_partic_modulo a, 
		mprev_programa_partic b 
	where 	a.nr_seq_programa_partic	= b.nr_sequencia 
	and  	not exists (select	1 
				from	mprev_partic_ciclo_atend x 
				where	x.nr_seq_prog_partic_mod = a.nr_sequencia);
						

BEGIN 
 
dt_referencia_w	:= clock_timestamp();
 
open C01;
loop 
fetch C01 into	 
	nr_seq_participante_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	CALL mprev_gerar_ciclo_atend(nr_seq_participante_w,null,dt_referencia_w,'Tasy');
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mprev_gerar_ciclo_atend_job () FROM PUBLIC;

