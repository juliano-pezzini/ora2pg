-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tf_gravar_log_ligacao ( cd_estabelecimento_p bigint, nr_ramal_p text, cd_tipo_central_p text, nr_fone_discado_p text, dt_inicio_p timestamp, dt_fim_p timestamp, qt_tempo_p bigint, vl_ligacao_p bigint, nm_usuario_p text, ie_entrada_saida_p text, ds_erro_p INOUT text) AS $body$
DECLARE

 
nr_seq_tipo_lig_w	bigint;
nr_seq_ramal_w		bigint;
ie_tipo_ramal_w		smallint;

nr_atendimento_w	bigint 	:= null;
cd_setor_atendimento_w	integer	:= null;
nr_seq_uniate_w		bigint	:= null;
ds_erro_w		varchar(255)	:= null;

cd_unidade_basica_w	varchar(10);
cd_unidade_compl_w	varchar(10);
ie_ignora_tipo_ligacao_w	varchar(1);
ie_validar_log_ligacao_w	varchar(1);


BEGIN 
 
begin 
select	coalesce(max(nr_sequencia),null), 
	coalesce(max(ie_ignora_tipo_ligacao),'N') 
into STRICT	nr_seq_tipo_lig_w, 
	ie_ignora_tipo_ligacao_w 
from	tf_tipo_ligacao 
where	cd_tipo_central = cd_tipo_central_p;
exception 
	when others then 
		nr_seq_tipo_lig_w		:= null;
		ie_ignora_tipo_ligacao_w	:= 'N';
end;
 
if (coalesce(nr_seq_tipo_lig_w::text, '') = '') then 
	ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(278782) || cd_tipo_central_p ||'"!' || chr(10);
end if;
 
begin 
select 	coalesce(max(ie_validar_log_ligacao),'S') 
into STRICT	ie_validar_log_ligacao_w 
from 	parametro_faturamento 
where	cd_estabelecimento = cd_estabelecimento_p;
exception 
	when others then 
		ie_validar_log_ligacao_w	:= 'S';
end;
 
begin 
select	coalesce(max(nr_sequencia),null) 
into STRICT	nr_seq_ramal_w 
from	ramal_interno 
where	cd_ramal = nr_ramal_p;
exception 
	when others then 
		nr_seq_ramal_w	:= null;
end;
 
if (coalesce(nr_seq_ramal_w::text, '') = '') then 
	ds_erro_w	:= ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(278784) || nr_ramal_p ||'"!';
end if;
 
if (coalesce(ds_erro_w::text, '') = '') and (ie_ignora_tipo_ligacao_w = 'N') then 
	select	ie_tipo_ramal 
	into STRICT	ie_tipo_ramal_w 
	from	ramal_interno 
	where	nr_sequencia = nr_seq_ramal_w;
 
	if (ie_tipo_ramal_w in (2,9)) then 
		begin 
		select	cd_setor_atendimento, 
			cd_unidade_basica, 
			cd_unidade_compl 
		into STRICT	cd_setor_atendimento_w, 
			cd_unidade_basica_w, 
			cd_unidade_compl_w 
		from	unidade_atendimento 
		where	nr_ramal = nr_ramal_p 
		and	coalesce(ie_situacao,'A') = 'A';
		exception 
			when others then 
				ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(278785);
		end;
 
		if (cd_setor_atendimento_w IS NOT NULL AND cd_setor_atendimento_w::text <> '') then 
			begin 
			select	max(nr_atendimento) 
			into STRICT	nr_atendimento_w 
			from	atend_paciente_unidade 
			where	cd_setor_atendimento	= cd_setor_atendimento_w 
			 and	cd_unidade_basica	= cd_unidade_basica_w 
			 and	cd_unidade_compl	= coalesce(cd_unidade_compl_w, cd_unidade_compl) 
			 and	coalesce(coalesce(dt_fim_p,dt_inicio_p),clock_timestamp())	between dt_entrada_unidade and coalesce(dt_saida_unidade,clock_timestamp());
			exception 
				when others then 
					ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(278786);
			end;
		end if;
	end if;
 
	insert into tf_log_ligacao( 
		nr_sequencia,		cd_estabelecimento, 
		nr_seq_tipo_lig,	nr_seq_ramal, 
		nr_fone_discado,	dt_atualizacao, 
		nm_usuario,		dt_atualizacao_nrec, 
		nm_usuario_nrec,	dt_inicio, 
		dt_fim,			qt_tempo, 
		vl_ligacao,		nr_atendimento, 
		cd_setor_atendimento,	nr_seq_uniate, 
		ie_processado,		ds_erro, 
		ie_entrada_saida,	nr_ramal, 
		cd_tipo_central) 
	values (	nextval('tf_log_ligacao_seq'),	cd_estabelecimento_p, 
		nr_seq_tipo_lig_w,		nr_seq_ramal_w, 
		nr_fone_discado_p,		clock_timestamp(), 
		nm_usuario_p,			clock_timestamp(), 
		nm_usuario_p,			dt_inicio_p, 
		dt_fim_p,			qt_tempo_p, 
		vl_ligacao_p,			nr_atendimento_w, 
		cd_setor_atendimento_w,	nr_seq_uniate_w, 
		0,				ds_erro_w, 
		ie_entrada_saida_p,		substr(nr_ramal_p,1,20), 
		substr(cd_tipo_central_p,1,30));
	 
	if (ie_validar_log_ligacao_w = 'S') then 
		commit;
	end if;
end if;
 
ds_erro_p := ds_erro_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tf_gravar_log_ligacao ( cd_estabelecimento_p bigint, nr_ramal_p text, cd_tipo_central_p text, nr_fone_discado_p text, dt_inicio_p timestamp, dt_fim_p timestamp, qt_tempo_p bigint, vl_ligacao_p bigint, nm_usuario_p text, ie_entrada_saida_p text, ds_erro_p INOUT text) FROM PUBLIC;

