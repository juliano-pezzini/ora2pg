-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_prescr_pre_rep ( nr_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

								 
nr_prescricao_w			prescr_medica.nr_prescricao%type;
nr_prescricao_orig_w	prescr_medica.nr_prescricao%type;
cd_setor_atendimento_w	prescr_medica.cd_setor_atendimento%type;
cd_medico_w				prescr_medica.cd_medico%type;
cd_estabelecimento_w	prescr_medica.cd_estabelecimento%type;
cd_pessoa_fisica_w		prescr_medica.cd_pessoa_fisica%type;


BEGIN 
 
select	max(nr_prescricao), 
	max(cd_setor_atendimento), 
	max(cd_medico), 
	max(cd_pessoa_fisica) 
into STRICT	nr_prescricao_orig_w, 
	cd_setor_atendimento_w, 
	cd_medico_w, 
	cd_pessoa_fisica_w 
from	prescr_medica 
where	nr_atendimento	= nr_atendimento_p 
and	ie_hemodialise 	= 'R';
 
if (coalesce(nr_prescricao_orig_w, 0) > 0) then 
 
	select	nextval('prescr_medica_seq') 
	into STRICT	nr_prescricao_w 
	;
 
	insert into prescr_medica( 
		nr_prescricao, 
		cd_pessoa_fisica, 
		nr_atendimento, 
		cd_medico, 
		dt_prescricao, 
		dt_atualizacao, 
		nm_usuario, 
		nm_usuario_original, 
		nr_horas_validade, 
		dt_primeiro_horario, 
		dt_liberacao, 
		cd_setor_atendimento, 
		cd_setor_entrega, 
		dt_entrega, 
		ie_recem_nato, 
		cd_estabelecimento, 
		cd_prescritor, 
		ie_adep) 
	values (nr_prescricao_w, 
		cd_pessoa_fisica_w, 
		nr_atendimento_p, 
		cd_medico_w, 
		clock_timestamp(), 
		clock_timestamp(), 
		nm_usuario_p, 
		nm_usuario_p,		 
		24, 
		clock_timestamp(), 
		null, 
		cd_setor_atendimento_w, 
		cd_setor_atendimento_w, 
		null, 
		'N', 
		cd_estabelecimento_w, 
		obter_dados_usuario_opcao(nm_usuario_p, 'C'), 
		'S');
 
	CALL GERAR_PRE_REP_PROC(nr_prescricao_orig_w, nr_prescricao_w, nm_usuario_p);
	 
end if;
 
if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then 
	commit;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_prescr_pre_rep ( nr_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

