-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_w_declaracao_inss ( cd_pessoa_fisica_p text, nm_usuario_p text) AS $body$
DECLARE


dt_inicial_w				timestamp;
dt_atual_w				timestamp;
vl_inss_w				double precision;
vl_rendimento_w				double precision;


BEGIN

delete from w_pls_declaracao_inss where nm_usuario = nm_usuario_p;

select	trunc(min(a.dt_vencimento_atual),'month')
into STRICT	dt_inicial_w
from	titulo_pagar a
where	a.cd_pessoa_fisica	= cd_pessoa_fisica_p;

dt_atual_w	:= dt_inicial_w;

while dt_atual_w <= trunc(clock_timestamp(),'month') loop
	begin
	select	coalesce(sum(a.vl_titulo),0),
		coalesce(sum(b.vl_imposto),0)
	into STRICT	vl_rendimento_w,
		vl_inss_w
	FROM tributo c, titulo_pagar a
LEFT OUTER JOIN titulo_pagar_imposto b ON (a.nr_titulo = b.nr_titulo)
WHERE b.cd_tributo		= c.cd_tributo and c.ie_tipo_tributo	= 'INSS' and trunc(a.dt_vencimento_atual,'month') = dt_atual_w and a.cd_pessoa_fisica	= cd_pessoa_fisica_p;

	insert into w_pls_declaracao_inss(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				cd_pessoa_fisica,
				dt_competencia,
				vl_rendimento,
				vl_inss)
			values (nextval('w_pls_declaracao_inss_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				cd_pessoa_fisica_p,
				dt_atual_w,
				vl_rendimento_w,
				vl_inss_w);

	select	add_months(trunc(dt_atual_w,'month'),1)
	into STRICT	dt_atual_w
	;

	end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_w_declaracao_inss ( cd_pessoa_fisica_p text, nm_usuario_p text) FROM PUBLIC;

