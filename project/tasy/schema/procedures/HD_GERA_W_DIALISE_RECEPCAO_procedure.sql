-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hd_gera_w_dialise_recepcao ( nr_seq_turno_p bigint, nr_seq_escala_p bigint, cd_pessoa_fisica_p text, tratamento_recepcao_p text, ie_mostra_finalizada_p text, ie_somente_chegaram_p text, ie_setor_p text, nr_dia_semana_p bigint, ie_status_dialise_p bigint, dt_filtro_dialise_p timestamp, nr_seq_unid_dialise_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
restringe_estab_w	varchar(1);

c01 CURSOR FOR 
	SELECT  a.cd_pessoa_fisica, 
		substr(obter_nome_pf(CD_PESSOA_FISICA),1,60) nm_pessoa_fisica, 
		substr(hd_obter_escala_prc(CD_PESSOA_FISICA,'G'),1,255) ds_escala, 
		substr(hd_obter_Turno_PRC_data(CD_PESSOA_FISICA, clock_timestamp(), 'G'),1,255) ds_turno, 
		substr(hd_obter_se_em_dialise(cd_pessoa_fisica,'E'),1,1) ie_dialise, 
		substr(hd_obter_se_em_dialise(cd_pessoa_fisica,'F'),1,1) ie_finalizada, 
		substr(hd_obter_se_em_dialise(cd_pessoa_fisica,'C'),1,1) ie_cancelada, 
		to_date(hd_obter_chegada_paciente(cd_pessoa_fisica), 'dd/mm/yyyy hh24:mi:ss') dt_chegada, 
		to_date(hd_obter_saida_pac(cd_pessoa_fisica), 'dd/mm/yyyy hh24:mi:ss') dt_saida, 
		substr(coalesce(hd_obter_desc_unid_dialise(NR_SEQ_UNIDADE_ATUAL), hd_obter_unidade_prc(cd_pessoa_fisica,'D')),1,200) ds_unid_dialise, 
		coalesce(NR_SEQ_UNIDADE_ATUAL,somente_numero(hd_obter_unidade_prc(cd_pessoa_fisica,'C'))) cd_unid_dialise, 
		(SELECT	coalesce(max(x.ie_pac_faltou),'N') from hd_prc_chegada x where x.cd_pessoa_fisica = a.cd_pessoa_fisica and x.dt_chegada between trunc(clock_timestamp()) and fim_dia(clock_timestamp())) ie_pac_faltou, 
		substr(hd_obter_Desc_Turno_Dia(cd_pessoa_fisica),1,255) ds_turno_dia, 
		hd_obter_hemodialise_atual(a.cd_pessoa_fisica, 'U') nr_seq_dialise_ultima, 
		substr(hd_obter_atend_ultima_dialise(a.cd_pessoa_fisica),1, 10) nr_ultimo_atend 
	from	hd_pac_renal_cronico a 
	where	ie_situacao = 'S' 
	and	hd_obter_se_mostra_unidade(NR_SEQ_UNIDADE_ATUAL, nm_usuario_p) = 'S' 
	and (coalesce(nr_seq_escala_p::text, '') = '' 
		or	hd_obter_escala_prc(cd_pessoa_fisica, 'C') = nr_seq_escala_p) 
	and (coalesce(nr_seq_turno_p::text, '') = '' 
		or (HD_Obter_Turno_PRC_data(cd_pessoa_fisica,clock_timestamp(), 'C') = nr_seq_turno_p) 
		or (hd_obter_se_pac_dia_turno(cd_pessoa_fisica, nr_seq_turno_p) = 'S')) 
	and (coalesce(cd_pessoa_fisica_p::text, '') = '' 
		or	cd_pessoa_fisica = cd_pessoa_fisica_p) 
	and (coalesce(ie_somente_chegaram_p, 'N') = 'N' 
		or	(hd_obter_chegada_paciente(cd_pessoa_fisica) IS NOT NULL AND (hd_obter_chegada_paciente(cd_pessoa_fisica))::text <> '')) 
	and (coalesce(nr_seq_unid_dialise_p::text, '') = '' 
		or	nr_seq_unidade_atual = nr_seq_unid_dialise_p) 
	and (coalesce(ie_mostra_finalizada_p, 'S') = 'S' 
		or	hd_obter_se_em_dialise(cd_pessoa_fisica, 'F') = 'N') 
	and (coalesce(nr_dia_semana_p::text, '') = '' 
		or (hd_obter_se_pac_dia_dialise(cd_pessoa_fisica, nr_dia_semana_p, 'C') = 'S') 
		or (hd_obter_se_pac_dia_semana(cd_pessoa_fisica, nr_dia_semana_p) = 'S')) 
	and (coalesce(tratamento_recepcao_p::text, '') = '' 
		or	obter_se_paciente_tratamento(cd_pessoa_fisica, tratamento_recepcao_p) = 'S') 
	and (coalesce(ie_setor_p::text, '') = '' 
		or	obter_setor_atendimento(hd_obter_atend_pac_unid(nr_seq_unid_dialise, cd_pessoa_fisica)) = ie_setor_p) 
	and (coalesce(ie_status_dialise_p::text, '') = '' 
		or (ie_status_dialise_p = 1 
			and 	exists (	select	1 
					from	hd_dialise x 
					where	x.nr_sequencia = hd_obter_hemodialise_atual(a.cd_pessoa_fisica, 'U') 
					and	(x.dt_cancelamento IS NOT NULL AND x.dt_cancelamento::text <> ''))) 
		or (ie_status_dialise_p = 2 
			and	exists (	select	1 
					from	hd_dialise x 
					where	x.nr_sequencia = hd_obter_hemodialise_atual(a.cd_pessoa_fisica, 'U') 
					and	(x.dt_inicio_dialise IS NOT NULL AND x.dt_inicio_dialise::text <> ''))) 
		or (ie_status_dialise_p = 3 
			and	exists (	select 1 
				from	hd_dialise x 
				where	x.nr_sequencia = hd_obter_hemodialise_atual(a.cd_pessoa_fisica, 'U') 
				and	(x.dt_fim_dialise IS NOT NULL AND x.dt_fim_dialise::text <> ''))) 
		or (ie_status_dialise_p = 4 
			and	(hd_obter_hemodialise_atual(a.cd_pessoa_fisica, 'U') IS NOT NULL AND (hd_obter_hemodialise_atual(a.cd_pessoa_fisica, 'U'))::text <> '')) 
		or (ie_status_dialise_p = 5 
			and	exists (	select	1 
				from	hd_dialise x, 
					hd_dialise_dialisador y 
				where	x.nr_sequencia = y.nr_seq_dialise 
				and	x.nr_sequencia = hd_obter_hemodialise_atual(a.cd_pessoa_fisica, 'U'))) 
		or (ie_status_dialise_p = 6 
			and	substr(hd_obter_se_dial_liberado(a.cd_pessoa_fisica),1,1) = 'S')) 
	and (coalesce(dt_filtro_dialise_p::text, '') = '' 
		or	exists (	select	1 
				from	hd_dialise x 
				where	x.nr_sequencia = hd_obter_hemodialise_atual(a.cd_pessoa_fisica, 'U') 
				and	trunc(x.dt_dialise) = to_date(dt_filtro_dialise_p))) 
	and (coalesce(restringe_estab_w, 'N') = 'N' 
		or	a.cd_estabelecimento = cd_estabelecimento_p);

BEGIN 
 
restringe_estab_w := obter_param_usuario(7009, 161, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, restringe_estab_w);
 
delete from W_DIALISE_RECEPCAO 
where	nm_usuario = nm_usuario_p;
 
for	row_c01 in c01 loop 
 
	insert into W_DIALISE_RECEPCAO( 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_seq_dialise_ultima, 
		cd_pessoa_fisica, 
		ie_finalizada, 
		ie_cancelada, 
		dt_chegada, 
		ie_dialise, 
		nm_pessoa_fisica, 
		ie_pac_faltou, 
		cd_unid_dialise, 
		ds_escala, 
		ds_turno, 
		ds_unid_dialise, 
		ds_turno_dia, 
		dt_saida, 
		nr_ultimo_atend 
	) values ( 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		row_c01.nr_seq_dialise_ultima, 
		row_c01.cd_pessoa_fisica, 
		row_c01.ie_finalizada, 
		row_c01.ie_cancelada, 
		row_c01.dt_chegada, 
		row_c01.ie_dialise, 
		row_c01.nm_pessoa_fisica, 
		row_c01.ie_pac_faltou, 
		row_c01.cd_unid_dialise, 
		row_c01.ds_escala, 
		row_c01.ds_turno, 
		row_c01.ds_unid_dialise, 
		row_c01.ds_turno_dia, 
		row_c01.dt_saida, 
		row_c01.nr_ultimo_atend);
	 
end loop;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hd_gera_w_dialise_recepcao ( nr_seq_turno_p bigint, nr_seq_escala_p bigint, cd_pessoa_fisica_p text, tratamento_recepcao_p text, ie_mostra_finalizada_p text, ie_somente_chegaram_p text, ie_setor_p text, nr_dia_semana_p bigint, ie_status_dialise_p bigint, dt_filtro_dialise_p timestamp, nr_seq_unid_dialise_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

