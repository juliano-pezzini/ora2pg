-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_devolucao_barras ( nr_atendimento_p bigint, cd_material_p bigint, cd_setor_atendimento_p bigint, cd_local_estoque_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE


qt_existe_w			integer;
ds_material_w			varchar(255);
ds_setor_atendimento_w		varchar(100);
ds_local_estoque_w		varchar(40);
cd_estabelecimento_w		smallint;
cd_kit_material_w		integer;
ie_material_pai_w		varchar(1);
ds_erro_w			varchar(255)	:= '';


BEGIN

select	max(ds_material)
into STRICT	ds_material_w
from	material
where	cd_material = cd_material_p;

begin
cd_estabelecimento_w := obter_estab_atendimento(nr_atendimento_p);
exception
	when others then
        cd_estabelecimento_w := 1;
end;

if (cd_setor_atendimento_p > 0) then

	select	coalesce(max(cd_kit_material),0)
	into STRICT	cd_kit_material_w
	from	material_estab
	where	cd_material = cd_material_p
	and	cd_estabelecimento = cd_estabelecimento_w;
	
	if (cd_kit_material_w > 0) then
		select	coalesce(ie_material_pai,'N')
		into STRICT	ie_material_pai_w
		from	kit_material
		where	cd_kit_material = cd_kit_material_w;
	end if;

	select	count(*)
	into STRICT	qt_existe_w
	from	material_atend_paciente
	where	nr_atendimento	= nr_atendimento_p
	and	qt_material > 0
	and (cd_material = cd_material_p or cd_material_exec = cd_material_p)
	and	cd_setor_atendimento = cd_setor_atendimento_p;

	if (qt_existe_w = 0) and
		((cd_kit_material_w = 0) or
		 (cd_kit_material_w > 0 AND ie_material_pai_w = 'S')) then
		select	max(ds_setor_atendimento)
		into STRICT	ds_setor_atendimento_w
		from	setor_atendimento
		where	cd_setor_atendimento = cd_setor_atendimento_p;

		if (ds_setor_atendimento_w IS NOT NULL AND ds_setor_atendimento_w::text <> '') then
			ds_erro_w	:= ds_erro_w ||
					WHEB_MENSAGEM_PCK.get_texto(281085) || ds_material_w ||
					WHEB_MENSAGEM_PCK.get_texto(281086) || ds_setor_atendimento_w || chr(10);
		end if;
	end if;
end if;


if (cd_local_estoque_p > 0) then

	select	coalesce(max(cd_kit_material),0)
	into STRICT	cd_kit_material_w
	from	material_estab
	where	cd_material = cd_material_p
	and	cd_estabelecimento = cd_estabelecimento_w;
	
	if (cd_kit_material_w > 0) then
		select	coalesce(ie_material_pai,'N')
		into STRICT	ie_material_pai_w
		from	kit_material
		where	cd_kit_material = cd_kit_material_w;
	end if;

	select /*+ INDEX(MATERIAL_ATEND_PACIENTE MATPACI_ATEPACI_FK_I) NO_INDEX_COMBINE(MATERIAL_ATEND_PACIENTE) */ COUNT(*)
	into STRICT	qt_existe_w
	from material_atend_paciente
	where nr_atendimento = nr_atendimento_p 
	and qt_material > 0 
	and (cd_material = cd_material_p or cd_material_exec = cd_material_p ) 
	and coalesce(cd_local_estoque, cd_local_estoque_p ) = cd_local_estoque_p;
	
	if (qt_existe_w = 0) and
		((cd_kit_material_w = 0) or
		 (cd_kit_material_w > 0 AND ie_material_pai_w = 'S')) then
		select	max(ds_local_estoque)
		into STRICT	ds_local_estoque_w
		from	local_estoque
		where	cd_local_estoque = cd_local_estoque_p;
		if (ds_local_estoque_w IS NOT NULL AND ds_local_estoque_w::text <> '') then
			ds_erro_w	:= ds_erro_w ||
				WHEB_MENSAGEM_PCK.get_texto(281085) || ds_material_w ||
				WHEB_MENSAGEM_PCK.get_texto(281087) || ds_local_estoque_w || chr(10);
		end if;
	end if;

end if;

ds_erro_p	:= substr(ds_erro_w,1,254);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_devolucao_barras ( nr_atendimento_p bigint, cd_material_p bigint, cd_setor_atendimento_p bigint, cd_local_estoque_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

