-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_prescr_proc_mat_frasco (nr_prescricao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_prescr_p bigint, nr_seq_material_p bigint, qt_volume_padrao_p bigint, qt_tempo_padrao_p bigint, qt_coleta_p bigint, nr_seq_grupo_p bigint, nr_seq_loop_p bigint, ie_amostra_p text, nr_seq_frasco_p bigint, nr_seq_grupo_imp_p bigint, ie_padrao_amostra_p text, nr_seq_lab_p text, dt_liberacao_p text, cd_identificador_p text, ie_status_atend_p bigint) AS $body$
DECLARE

nr_seq_prescr_proc_mat_w 	   bigint;
nr_seq_int_prescr_w		       bigint;
cd_barras_w			             varchar(100);
nr_seq_material_integracao_w varchar(3);

BEGIN
	select nextval('prescr_proc_material_seq')
		into STRICT nr_seq_prescr_proc_mat_w
		;

	select coalesce(max(nr_seq_int_prescr),0) + 1
		into STRICT nr_seq_int_prescr_w
		from prescr_proc_material
   where nr_prescricao = nr_prescricao_p;

	insert into prescr_proc_material(nr_sequencia,
	           nr_prescricao,
						 nr_seq_material,
						 qt_volume,
						 dt_atualizacao,
						 qt_tempo,
						 qt_minuto,
						 nm_usuario,
						 dt_coleta,
						 nr_seq_grupo,
						 nr_amostra,
						 ie_amostra,
						 nr_seq_frasco,
						 nr_seq_grupo_imp,
						 nr_seq_int_prescr)
		 values (nr_seq_prescr_proc_mat_w,
		         nr_prescricao_p,
					   nr_seq_material_p,
					   qt_volume_padrao_p,
					   clock_timestamp(),
					   qt_tempo_padrao_p,
					   0,
					   nm_usuario_p,
					   CASE WHEN qt_coleta_p=1 THEN clock_timestamp()  ELSE null END ,
					   nr_seq_grupo_p,
					   nr_seq_loop_p,
					   ie_amostra_p,
					   nr_seq_frasco_p,
					   nr_seq_grupo_imp_p,
					   nr_seq_int_prescr_w);

	if (ie_padrao_amostra_p IN ('AMO9','AMO10','AMO11','AM11F','AM10F','AMO13','WEB')) then
    cd_barras_w := nr_seq_prescr_proc_mat_w;
	elsif (ie_padrao_amostra_p = 'EAM10') then
		cd_barras_w := lpad(substr(coalesce(cd_estabelecimento_p,1),1,2),2,0) || nr_seq_prescr_proc_mat_w;
	elsif (ie_padrao_amostra_p = 'DGIS') then
		cd_barras_w := dt_liberacao_p || lpad(nr_seq_grupo_imp_p,2,'0') || lpad(nr_seq_lab_p,20,'0') || nr_seq_loop_p;
	elsif (ie_padrao_amostra_p = 'DS4GI') then
		cd_barras_w := dt_liberacao_p || lpad(nr_seq_lab_p,20,'0') || lpad(nr_seq_grupo_imp_p,2,'0') || nr_seq_loop_p;
	elsif (ie_padrao_amostra_p = 'SISB') then

  	select substr(max(ds_material_integracao),1,3)
    	into STRICT nr_seq_material_integracao_w
      from material_exame_lab
     where nr_sequencia = nr_seq_material_p;

    cd_barras_w := substr(cd_identificador_p,1,1)||lpad(to_char(nr_prescricao_p),8,'0')||'M'||lpad(substr(nr_seq_material_integracao_w,1,3),3,'0');
	else
		cd_barras_w := dt_liberacao_p || lpad(nr_seq_grupo_p,2,'0') || lpad(nr_seq_lab_p,20,'0') || nr_seq_loop_p;
	end if;

	begin
		update prescr_proc_material
       set cd_barras = cd_barras_w
		 where nr_sequencia = nr_seq_prescr_proc_mat_w;

	exception
	  when others then
  		update prescr_procedimento
	       set nr_seq_lab  = NULL
			 where nr_prescricao = nr_prescricao_p
				 and nr_sequencia = nr_seq_prescr_p;
	end;

	insert into prescr_proc_mat_item(nr_sequencia,
             dt_atualizacao,
						 nm_usuario,
						 dt_atualizacao_nrec,
						 nm_usuario_nrec,
						 nr_prescricao,
						 nr_seq_prescr,
						 nr_seq_prescr_proc_mat,
						 ie_status,
						 cd_barras,
						 nr_seq_frasco)
 		 values (nextval('prescr_proc_mat_item_seq'),
		         clock_timestamp(),
						 nm_usuario_p,
						 clock_timestamp(),
						 nm_usuario_p,
						 nr_prescricao_p,
						 nr_seq_prescr_p,
						 nr_seq_prescr_proc_mat_w,
						 ie_status_atend_p,
						 cd_barras_w,
						 nr_seq_frasco_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_prescr_proc_mat_frasco (nr_prescricao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_prescr_p bigint, nr_seq_material_p bigint, qt_volume_padrao_p bigint, qt_tempo_padrao_p bigint, qt_coleta_p bigint, nr_seq_grupo_p bigint, nr_seq_loop_p bigint, ie_amostra_p text, nr_seq_frasco_p bigint, nr_seq_grupo_imp_p bigint, ie_padrao_amostra_p text, nr_seq_lab_p text, dt_liberacao_p text, cd_identificador_p text, ie_status_atend_p bigint) FROM PUBLIC;

