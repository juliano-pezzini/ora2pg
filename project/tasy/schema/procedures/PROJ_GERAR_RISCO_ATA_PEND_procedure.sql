-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE proj_gerar_risco_ata_pend ( qt_dia_p bigint, cd_empresa_p bigint) AS $body$
DECLARE


nr_seq_pend_w				bigint;
nr_seq_cliente_w				bigint;
nr_seq_ata_w				bigint;
cd_consultor_w				varchar(10);
ds_ata_w					varchar(80);
ds_pendencia_w				varchar(255);
dt_prev_solucao_w				timestamp;
nr_seq_proj_w				bigint;
quebra_w					varchar(10)	:= chr(13)||chr(10);
CD_COORDENADOR_w			varchar(10);
nm_usuario_ata_w				varchar(25);
nm_usuario_coordenador_w			varchar(25);
nr_seq_etapa_w				bigint;
nr_seq_risco_w				bigint;
ds_razao_social_w				varchar(80);
ds_projeto_w				varchar(80);
nr_seq_projeto_w				bigint;
qt_existe_w				bigint;
qt_dias_repactuada_w			bigint;

C01 CURSOR FOR
	SELECT	a.nr_sequencia,
		b.cd_consultor,
		b.nr_seq_cliente,
		b.ds_ata,
		b.nr_sequencia,
		a.dt_prev_solucao,
		a.ds_pendencia,
		b.nm_usuario,
		b.nr_seq_projeto
	from	proj_ata b,
		proj_ata_pendencia a
	where	trunc(a.dt_prev_solucao,'dd') <= trunc(clock_timestamp() + qt_dia_p,'dd')
	and	trunc(a.dt_prev_solucao,'dd') >= trunc(clock_timestamp(),'dd')
	and	(nr_seq_projeto IS NOT NULL AND nr_seq_projeto::text <> '') /*Elton 237367 - Coloquei esta restrição em função de registros que tem o nr_seq_canal informado, e não tem o campo nr_seq_cliente preenchido,*/
	and	a.nr_seq_ata = b.nr_sequencia
	and	coalesce(a.dt_conclusao_real::text, '') = '';/* Elton 259352 - Coloquei esta restrição para gerar comunicação somente para as pendências não concluídas. */
BEGIN
qt_dias_repactuada_w := Obter_Param_Usuario(993, 147, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, qt_dias_repactuada_w);

open C01;
loop
fetch C01 into
	nr_seq_pend_w,
	cd_consultor_w,
	nr_seq_cliente_w,
	ds_ata_w,
	nr_seq_ata_w,
	dt_prev_solucao_w,
	ds_pendencia_w,
	nm_usuario_ata_w,
	nr_seq_projeto_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	max(nr_sequencia),
		max(cd_coordenador)
	into STRICT	nr_seq_proj_w,
		cd_coordenador_w
	from	proj_projeto
	where	nr_seq_cliente 	= nr_seq_cliente_w;

	select	max(obter_razao_social(CD_CNPJ))
	into STRICT	ds_razao_social_w
	from	com_cliente
	where	nr_sequencia	= nr_seq_cliente_w;

	select 	max(ds_titulo)
	into STRICT	ds_projeto_w
	from	proj_projeto
	where	nr_sequencia	= nr_seq_projeto_w;

	if (cd_coordenador_w IS NOT NULL AND cd_coordenador_w::text <> '') then
		select 	max(nm_usuario)
		into STRICT	nm_usuario_coordenador_w
		from	usuario
		where	cd_pessoa_fisica	= cd_coordenador_w;
	end if;

	select	nextval('proj_risco_implantacao_seq')
	into STRICT	nr_seq_risco_w
	;

	select	count(*)
	into STRICT	qt_existe_w
	from	proj_risco_implantacao
	where	nr_seq_proj	= nr_seq_projeto_w
	and	nr_seq_pend_ata = nr_seq_pend_w;

	if (qt_existe_w = 0) then
		insert into proj_risco_implantacao(
			nr_sequencia,
			cd_empresa,
			nr_seq_cliente,
			cd_pessoa_fisica,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_registro,
			ds_titulo,
			nr_seq_tipo,
			ds_evidencia,
			ds_sugestao,
			dt_prev_solucao,
			cd_responsavel,
			ie_grau_risco,
			dt_fim_real,
			nm_resp_cliente,
			nr_seq_proj,
			nr_seq_pend_ata,
			dt_repactuada_sol)
		values (	nr_seq_risco_w,
			cd_empresa_p,
			nr_seq_cliente_w,
			cd_consultor_w,
			clock_timestamp(),
			'Tasy',
			clock_timestamp(),
			'Tasy',
			clock_timestamp(),
			' ',
			null,
			substr('Conforme a ATA ' || nr_seq_ata_w || ', ' || ds_ata_w || '. Precisa-se da solução da pendência prevista para a data ' || dt_prev_solucao_w || '.',1,4000),
			ds_pendencia_w,  --aadadasdasd
			dt_prev_solucao_w,
			'',
			'',
			null,
			'',
			nr_seq_projeto_w,
			nr_seq_pend_w,
			CASE WHEN qt_dias_repactuada_w=-1 THEN null WHEN qt_dias_repactuada_w=0 THEN dt_prev_solucao_w  ELSE dt_prev_solucao_w+qt_dias_repactuada_w END );

		select	nextval('proj_risco_impl_etapa_seq')
		into STRICT	nr_seq_etapa_w
		;

		insert 	into proj_risco_impl_etapa(nr_sequencia,
			nr_seq_risco,
			nr_seq_etapa,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec)
		values (nr_seq_etapa_w,
			nr_seq_risco_w,
			1,
			clock_timestamp(),
			'Tasy',
			clock_timestamp(),
			'Tasy');

		insert  into	comunic_interna(
			dt_comunicado,
			ds_titulo,
			ds_comunicado,
			nm_usuario,
			dt_atualizacao,
			ie_geral,
			nm_usuario_destino,
			nr_sequencia,
			ie_gerencial,
			nr_seq_classif,
			cd_perfil,
			cd_setor_destino,
			cd_estab_destino,
			ds_setor_adicional,
			dt_liberacao,
			ds_perfil_adicional)
		values (clock_timestamp(),
			'Pendência de ATA de reunião. ' ||ds_ata_w,
			substr('Conforme a ATA ' || nr_seq_ata_w || ', ' || ds_ata_w || '. Precisa-se da solução da pendência prevista para a data ' || dt_prev_solucao_w || '.',1,4000)
					||quebra_w||quebra_w||
					'Cliente: '||ds_razao_social_w||quebra_w||quebra_w||
					'Projeto: '||ds_projeto_w||quebra_w||quebra_w||
					'Pendência: '||ds_pendencia_w||quebra_w||quebra_w||
					'Dt. prev. solução: '||to_char(dt_prev_solucao_w,'dd/mm/yyyy'),
			'Tasy',
			clock_timestamp(),
			'N',
			nm_usuario_ata_w||','||nm_usuario_coordenador_w,
			nextval('comunic_interna_seq'),
			'N',
			1,
			null,
			null,
			null,
			null,
			clock_timestamp(),
			null);
	end if;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proj_gerar_risco_ata_pend ( qt_dia_p bigint, cd_empresa_p bigint) FROM PUBLIC;

