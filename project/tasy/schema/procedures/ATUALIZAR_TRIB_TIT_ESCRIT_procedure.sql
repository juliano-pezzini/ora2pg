-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_trib_tit_escrit (nr_seq_escrit_p bigint, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE


nr_titulo_w		bigint;
vl_tributo_w		double precision;
vl_saldo_titulo_w	double precision;

c01 CURSOR FOR
SELECT	a.nr_titulo,
	coalesce(obter_saldo_titulo_pagar(a.nr_titulo,clock_timestamp()),0)
from	titulo_pagar_escrit a
where	a.nr_seq_escrit	= nr_seq_escrit_p;


BEGIN

if (coalesce(nr_seq_escrit_p,0) > 0) then

	open c01;
	loop
	fetch c01 into
		nr_titulo_w,
		vl_saldo_titulo_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		select	coalesce(sum(vl_imposto),0)
		into STRICT	vl_tributo_w
		from	w_titulo_pagar_imposto
		where	nr_titulo	= nr_titulo_w;

		/* inclusão */

		if (ie_opcao_p	= 'I') then

			update	titulo_pagar_escrit
			set	vl_escritural	= coalesce(vl_escritural,0) - coalesce(vl_tributo_w,0)	/* ahoffelder - 17/04/2013 - alterei pq os títulos nem sempre vão para o pagto escritural com o saldo inteiro */
			where	nr_titulo	= nr_titulo_w
			and	nr_seq_escrit	= nr_seq_escrit_p;
		else
			update	titulo_pagar_escrit
			set	vl_escritural	= coalesce(vl_escritural,0) + coalesce(vl_tributo_w,0)
			where	nr_titulo	= nr_titulo_w
			and	nr_seq_escrit	= nr_seq_escrit_p;
		end if;
	end loop;
	close c01;

	/* excluir */

	if (ie_opcao_p = 'E') then

		delete	from	w_titulo_pagar_imposto
		where	nr_seq_escrit	= nr_seq_escrit_p;

		update	banco_escritural
		set	dt_geracao_tributo	 = NULL
		where	nr_sequencia		= nr_seq_escrit_p;

	else

		update	banco_escritural
		set	dt_geracao_tributo	= clock_timestamp()
		where	nr_sequencia		= nr_seq_escrit_p;

	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_trib_tit_escrit (nr_seq_escrit_p bigint, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

