-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_inserir_hemoterapia_ant ( nr_atendimento_p prescr_medica.nr_atendimento%type, nr_atendimento_ant_p prescr_medica.nr_atendimento%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nr_sequencia_p prescr_material.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_perfil_p perfil.cd_perfil%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_item_gerado_p INOUT text, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, nr_seq_conclusao_apae_p bigint default null, ie_futuro_p text default 'N', nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) AS $body$
DECLARE

			
ie_tipo_hemoterap_w		cpoe_hemoterapia.ie_tipo_hemoterap%type;
dt_programada_w			cpoe_hemoterapia.dt_programada%type;	
ie_tipo_w				cpoe_hemoterapia.ie_tipo%type;	

nr_seq_bco_san_w		prescr_solic_bco_sangue.nr_sequencia%type;
nr_seq_sangue_w		prescr_solic_bco_sangue.nr_sequencia%type;
cd_doenca_cid_w		prescr_solic_bco_sangue.cd_doenca_cid%type;
ie_tipo_paciente_w		prescr_solic_bco_sangue.ie_tipo_paciente%type;
ie_porte_cirurgico_w	prescr_solic_bco_sangue.ie_porte_cirurgico%type;
ie_trans_anterior_w		prescr_solic_bco_sangue.ie_trans_anterior%type;
dt_ultima_transf_w		prescr_solic_bco_sangue.dt_ultima_transf%type;
nr_seq_reacao_w		prescr_solic_bco_sangue.nr_seq_reacao%type;
ie_gravidez_w		prescr_solic_bco_sangue.ie_gravidez%type;
qt_gravidez_w		prescr_solic_bco_sangue.qt_gravidez%type;
qt_aborto_w		prescr_solic_bco_sangue.qt_aborto%type;
dt_cirurgia_w		prescr_solic_bco_sangue.dt_cirurgia%type;
qt_hemoglobina_w		prescr_solic_bco_sangue.qt_hemoglobina%type;
qt_hematocrito_w		prescr_solic_bco_sangue.qt_hematocrito%type;
qt_plaqueta_w		prescr_solic_bco_sangue.qt_plaqueta%type;
qt_tap_w			prescr_solic_bco_sangue.qt_tap%type;
qt_tap_inr_w		prescr_solic_bco_sangue.qt_tap_inr%type;
qt_ttpa_w			prescr_solic_bco_sangue.qt_ttpa%type;
qt_ttpa_rel_w		prescr_solic_bco_sangue.qt_ttpa_rel%type;
qt_fibrinogenio_w		prescr_solic_bco_sangue.qt_fibrinogenio%type;
ie_reserva_w		prescr_solic_bco_sangue.ie_reserva%type;

nr_seq_hemoterapia_w	prescr_procedimento.nr_sequencia%type;
nr_seq_derivado_w		prescr_procedimento.nr_seq_derivado%type;
cd_procedimento_w	prescr_procedimento.cd_procedimento%type;
ie_origem_proced_w	prescr_procedimento.ie_origem_proced%type;
nr_seq_proc_interno_w	prescr_procedimento.nr_seq_proc_interno%type;
ie_via_aplicacao_w		prescr_procedimento.ie_via_aplicacao%type;
ie_aliquotado_w		prescr_procedimento.ie_aliquotado%type;
ie_filtrado_w		prescr_procedimento.ie_filtrado%type;
ie_irradiado_w		prescr_procedimento.ie_irradiado%type;
ie_lavado_w		prescr_procedimento.ie_lavado%type;
ie_se_necessario_w	prescr_procedimento.ie_se_necessario%type;
ie_acm_w		prescr_procedimento.ie_acm%type;
qt_procedimento_w		prescr_procedimento.qt_procedimento%type;
qt_vol_hemocomp_w	prescr_procedimento.qt_vol_hemocomp%type;
qt_veloc_inf_hemo_w	prescr_procedimento.qt_veloc_inf_hemo%type;
ie_unid_med_hemo_w	prescr_procedimento.ie_unid_med_hemo%type;
cd_intervalo_w		prescr_procedimento.cd_intervalo%type;
qt_hora_infusao_w		prescr_procedimento.qt_hora_infusao%type;
qt_tempo_infusao_w	prescr_procedimento.qt_tempo_infusao%type;
ds_justificativa_w		prescr_procedimento.ds_justificativa%type;
ds_observacao_w		prescr_procedimento.ds_observacao%type;

nr_seq_indicacao_w	prescr_sol_bs_indicacao.nr_seq_indicacao%type;

ds_horarios_w			cpoe_procedimento.ds_horarios%type:='';
ds_horarios_aux_w		cpoe_procedimento.ds_horarios%type:='';
hr_prim_horario_w		cpoe_procedimento.hr_prim_horario%type;
nr_ocorrencia_w			prescr_procedimento.nr_ocorrencia%type;
dt_fim_w			timestamp := null;	


qt_min_intervalo_w 		intervalo_prescricao.qt_min_intervalo%type;
ie_fenotipado_w		prescr_procedimento.ie_fenotipado%type;

ie_prescr_alta_agora_w	varchar(1);

count_w			bigint := 0;
sql_w			varchar(4000);
ds_sep_bv_w		varchar(10);
ds_parametros_w		varchar(2000);

C01 CURSOR FOR
SELECT	nr_sequencia,
	cd_doenca_cid,
	ie_tipo_paciente,
	ie_porte_cirurgico,		
	ie_trans_anterior,
	dt_ultima_transf,
	nr_seq_reacao,	
	ie_gravidez,
	qt_gravidez,
	qt_aborto,
	dt_cirurgia,
	qt_hemoglobina,
	qt_hematocrito,
	qt_plaqueta,
	qt_tap,
	qt_tap_inr,
	qt_ttpa,
	qt_ttpa_rel,
	qt_fibrinogenio,
	coalesce(ie_reserva,'N')
from	prescr_solic_bco_sangue
where	nr_prescricao = nr_prescricao_p
and nr_sequencia = nr_seq_sangue_w;

C02 CURSOR FOR	
SELECT	nr_sequencia,
	nr_seq_derivado,
	cd_procedimento,
	nr_seq_proc_interno,
	ie_origem_proced,
	CASE WHEN coalesce(nr_seq_derivado,0)=0 THEN  '1'  ELSE '0' END ,
	ie_via_aplicacao,
	coalesce(ie_aliquotado,'N'),
	coalesce(ie_filtrado,'N'),
	coalesce(ie_irradiado,'N'),
	coalesce(ie_lavado,'N'),
	coalesce(ie_fenotipado, 'N'),
	qt_procedimento,
	qt_vol_hemocomp,
	qt_veloc_inf_hemo,
	ie_unid_med_hemo,
	cd_intervalo,
	qt_hora_infusao,
	qt_tempo_infusao,
	ds_justificativa,
	ds_observacao		
from	prescr_procedimento
where	nr_prescricao = nr_prescricao_p
and	nr_sequencia = nr_sequencia_p
and	nr_seq_solic_sangue = nr_seq_bco_san_w
and (Obter_se_exibe_proced(nr_prescricao,nr_sequencia,ie_tipo_proced,'BSHE') = 'S'
or	Obter_se_exibe_proced(nr_prescricao,nr_sequencia,ie_tipo_proced,'AT') = 'S'
or 	Obter_se_exibe_proced(nr_prescricao,nr_sequencia,ie_tipo_proced,'BS') = 'S');
	
C03 CURSOR FOR
SELECT	nr_seq_indicacao
from	prescr_sol_bs_indicacao
where	nr_seq_solic_bs = nr_seq_bco_san_w  LIMIT 2;


BEGIN

ie_prescr_alta_agora_w := obter_param_usuario(924, 409, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_prescr_alta_agora_w);

select	max(nr_seq_solic_sangue)
into STRICT	nr_seq_sangue_w
from	prescr_procedimento
where	nr_prescricao = nr_prescricao_p
and	nr_sequencia = nr_sequencia_p;

open C01;
loop
fetch C01 into	
	nr_seq_bco_san_w,
	cd_doenca_cid_w,
	ie_tipo_paciente_w,
	ie_porte_cirurgico_w,	
	ie_trans_anterior_w,
	dt_ultima_transf_w,
	nr_seq_reacao_w,	
	ie_gravidez_w,
	qt_gravidez_w,
	qt_aborto_w,
	dt_cirurgia_w,
	qt_hemoglobina_w,
	qt_hematocrito_w,
	qt_plaqueta_w,
	qt_tap_w,
	qt_tap_inr_w,
	qt_ttpa_w,
	qt_ttpa_rel_w,
	qt_fibrinogenio_w,
	ie_reserva_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
		open C02;
		loop
		fetch C02 into
			nr_seq_hemoterapia_w,
			nr_seq_derivado_w,
			cd_procedimento_w,
			nr_seq_proc_interno_w,
			ie_origem_proced_w,
			ie_tipo_hemoterap_w,
			ie_via_aplicacao_w,
			ie_aliquotado_w,
			ie_filtrado_w,
			ie_irradiado_w,
			ie_lavado_w,
			ie_fenotipado_w,
			qt_procedimento_w,
			qt_vol_hemocomp_w,
			qt_veloc_inf_hemo_w,
			ie_unid_med_hemo_w,
			cd_intervalo_w,
			qt_hora_infusao_w,
			qt_tempo_infusao_w,
			ds_justificativa_w,
			ds_observacao_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			
				ds_horarios_w := null;
				dt_programada_w := null;
			
				if (coalesce(ie_prescr_alta_agora_w,'N') = 'S') and (coalesce(ie_item_alta_p,'N') = 'S')	then
					
					select	max(qt_min_intervalo)
					into STRICT	qt_min_intervalo_w
					from	intervalo_prescricao
					where	cd_intervalo = cd_intervalo_w;

					SELECT * FROM cpoe_calcular_horario_prescr(nr_atendimento_p, cd_intervalo_w, null, clock_timestamp(), 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;
					
					ds_horarios_w	:= ds_horarios_w || ds_horarios_aux_w;
				
					hr_prim_horario_w	:= obter_prim_dshorarios(ds_horarios_w);
					dt_programada_w	:= to_date(to_char(clock_timestamp(),'dd/mm/yyyy ') || hr_prim_horario_w, 'dd/mm/yyyy hh24:mi');
				
					if (dt_programada_w < clock_timestamp()) then
						dt_programada_w := dt_programada_w + 1;
					end if;					
				end if;
				
				if (ie_retrogrado_p = 'S' or ie_futuro_p = 'S') then -- retrograde/backward item
					dt_programada_w := dt_inicio_p;
					dt_fim_w := (dt_programada_w + 1) - 1/1440;
					ie_tipo_w := 1;
					
					select	max(qt_min_intervalo)
					into STRICT	qt_min_intervalo_w
					from	intervalo_prescricao
					where	cd_intervalo = cd_intervalo_w;

					SELECT * FROM cpoe_calcular_horario_prescr(	nr_atendimento_p, cd_intervalo_w, null, dt_programada_w, 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;					

					ds_horarios_w	:= ds_horarios_w || ds_horarios_aux_w;
				end if;
			
				select	nextval('cpoe_hemoterapia_seq')
				into STRICT	nr_seq_item_gerado_p
				;

				insert into cpoe_hemoterapia(
							nr_sequencia,
							nr_atendimento,
							cd_doenca_cid,
							ie_trans_anterior,
							dt_ultima_transf,
							nr_seq_reacao,
							ie_gravidez,
							qt_gravidez,
							qt_aborto,
							ie_tipo_paciente,
							ie_porte_cirurgico,
							dt_cirurgia,
							qt_hemoglobina,
							qt_hematocrito,
							qt_plaqueta,
							qt_tap,
							qt_tap_inr,
							qt_ttpa,
							qt_ttpa_rel,
							qt_fibrinogenio,
							ie_tipo_hemoterap,
							nr_seq_derivado,
							cd_procedimento,
							nr_seq_proc_interno,
							ie_origem_proced,
							ie_via_aplicacao,
							qt_procedimento,
							qt_vol_hemocomp,
							qt_hora_min_infusao,
							qt_veloc_inf_hemo,
							ie_unid_med_hemo,
							cd_intervalo,
							ie_aliquotado,
							ie_filtrado,
							ie_irradiado,
							ie_lavado,
							ie_fenotipado,
							ds_justificativa,
							ds_observacao_proc,
							ie_tipo,
							dt_programada,
							ds_horarios,
							ie_urgencia,
							ds_observacao,
							nm_usuario,
							nm_usuario_nrec,
							dt_atualizacao,
							dt_atualizacao_nrec,
							cd_perfil_ativo,
							dt_fim,
							ie_reserva,
							cd_pessoa_fisica,
							cd_funcao_origem,
							nr_seq_transcricao,
							ie_item_alta,
							ie_prescritor_aux,
							cd_medico,
							nr_seq_pepo,
							nr_cirurgia,
							nr_cirurgia_patologia,
							nr_seq_agenda,
							nr_seq_conclusao_apae,
							ie_futuro,
							dt_inicio,
							nr_seq_cpoe_order_unit
						) values (
							nr_seq_item_gerado_p,
							nr_atendimento_p,							
							cd_doenca_cid_w,
							ie_trans_anterior_w,
							dt_ultima_transf_w,
							nr_seq_reacao_w,
							ie_gravidez_w,
							qt_gravidez_w,
							qt_aborto_w,
							CASE WHEN ie_tipo_paciente_w='CL' THEN  'C'  ELSE 'I' END ,
							ie_porte_cirurgico_w,
							dt_cirurgia_w,
							qt_hemoglobina_w,
							qt_hematocrito_w,
							qt_plaqueta_w,
							qt_tap_w,
							qt_tap_inr_w,
							qt_ttpa_w,
							qt_ttpa_rel_w,
							qt_fibrinogenio_w,
							ie_tipo_hemoterap_w,
							nr_seq_derivado_w,
							cd_procedimento_w,
							nr_seq_proc_interno_w,
							ie_origem_proced_w,
							ie_via_aplicacao_w,
							qt_procedimento_w,
							qt_vol_hemocomp_w,
							lpad(substr(coalesce(qt_hora_infusao_w,0),1,2), 2, '0') || ':' ||  lpad(substr(coalesce(qt_tempo_infusao_w,0),1,2), 2, '0'),
							qt_veloc_inf_hemo_w,
							ie_unid_med_hemo_w,
							cd_intervalo_w,
							ie_aliquotado_w,
							ie_filtrado_w,
							ie_irradiado_w,
							ie_lavado_w,
							ie_fenotipado_w,
							ds_justificativa_w,
							ds_observacao_w,
							ie_tipo_w,
							dt_programada_w,
							ds_horarios_w,
							null,
							ds_observacao_w,
							nm_usuario_p,
							nm_usuario_p,
							clock_timestamp(),
							clock_timestamp(),
							cd_perfil_p,
							dt_fim_w,
							ie_reserva_w,
							obter_cd_paciente_prescricao(nr_prescricao_p),
							2314,
							nr_seq_transcricao_p,
							ie_item_alta_p,
							ie_prescritor_aux_p,
							cd_medico_p,
							nr_seq_pepo_p,
							nr_cirurgia_p,
							nr_cirurgia_patologia_p,
							nr_seq_agenda_p,
							nr_seq_conclusao_apae_p,
							ie_futuro_p,
							dt_programada_w,
							nr_seq_cpoe_order_unit_p);
							
				ds_sep_bv_w	:= obter_separador_bv;
							
				open C03;
				loop
				fetch C03 into	
					nr_seq_indicacao_w;
				EXIT WHEN NOT FOUND; /* apply on C03 */
					begin				
					count_w := count_w + 1;
					
					ds_parametros_w	:= 	'nr_seq_indicacao=' || nr_seq_indicacao_w || ds_sep_bv_w||
										'nr_sequencia=' || nr_seq_item_gerado_p || ds_sep_bv_w;
					
					sql_w :='	update	cpoe_hemoterapia '||
							'	set		nr_seq_indicacao'||count_w||' = :nr_seq_indicacao'||
							'  where nr_sequencia = :nr_sequencia';
					
					CALL exec_sql_dinamico_bv('', sql_w, ds_parametros_w);
					
					end;
				end loop;
				close C03;	
				
				count_w := 0;

			end;
		end loop;
		close C02;
	
	end;
end loop;
close C01;

commit;	
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_inserir_hemoterapia_ant ( nr_atendimento_p prescr_medica.nr_atendimento%type, nr_atendimento_ant_p prescr_medica.nr_atendimento%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nr_sequencia_p prescr_material.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_perfil_p perfil.cd_perfil%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_item_gerado_p INOUT text, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, nr_seq_conclusao_apae_p bigint default null, ie_futuro_p text default 'N', nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) FROM PUBLIC;

