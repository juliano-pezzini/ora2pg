-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_recalc_classif_tit (nr_titulo_p bigint, nr_seq_baixa_p bigint, nm_usuario_p text, ds_lista_titulo_p INOUT text) AS $body$
DECLARE

 
cd_estabelecimento_w	bigint;
nr_seq_baixa_w		integer;
nr_titulo_contab_w	bigint;
ds_lista_titulo_w	varchar(255);
nr_lote_contabilizado_w	pls_titulo_rec_liq_mens.nr_lote_contabil%TYPE;

C01 CURSOR FOR 
SELECT	nr_sequencia 
FROM	titulo_receber_liq 
WHERE	nr_titulo = nr_titulo_p 
AND (coalesce(nr_seq_baixa_p,0) = 0 OR nr_sequencia = nr_seq_baixa_p);

 

BEGIN 
 
SELECT	cd_estabelecimento 
INTO STRICT	cd_estabelecimento_w 
FROM	titulo_receber 
WHERE	nr_titulo	= nr_titulo_p;
 
OPEN C01;
LOOP 
FETCH C01 INTO 
	nr_seq_baixa_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	BEGIN 
 
	IF (nr_titulo_p IS NOT NULL AND nr_titulo_p::text <> '') AND (nr_seq_baixa_p IS NOT NULL AND nr_seq_baixa_p::text <> '') THEN 
 
			nr_lote_contabilizado_w	:= NULL;
 
			SELECT	MAX(a.nr_lote_contabil) 
			INTO STRICT	nr_lote_contabilizado_w 
			FROM	pls_titulo_rec_liq_mens	a 
			WHERE	a.nr_titulo	= nr_titulo_p 
			AND	a.nr_seq_baixa	= nr_seq_baixa_w 
			AND	a.nr_lote_contabil <> 0;
 
			IF (nr_lote_contabilizado_w IS NOT NULL AND nr_lote_contabilizado_w::text <> '') THEN 
 
				INSERT INTO w_recalc_tit_rec_cc( 
							nr_sequencia, 
							nr_titulo, 
							nr_seq_baixa, 
							dt_atualizacao, 
							nm_usuario, 
							dt_atualizacao_nrec, 
							nm_usuario_nrec ) 
							VALUES ( 
							nextval('w_recalc_tit_rec_cc_seq'), 
							nr_titulo_p, 
							nr_seq_baixa_w, 
							clock_timestamp(), 
							nm_usuario_p, 
							clock_timestamp(), 
							nm_usuario_p);
			END IF;
	END IF;
 
	END;
END LOOP;
CLOSE C01;
 
 
COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_recalc_classif_tit (nr_titulo_p bigint, nr_seq_baixa_p bigint, nm_usuario_p text, ds_lista_titulo_p INOUT text) FROM PUBLIC;

