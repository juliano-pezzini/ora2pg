-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE transfer_coinsurance_item ( nr_seq_mat_p conta_pac_ded_conv_item.nr_seq_matpaci_origem%type, nr_seq_proc_p conta_pac_ded_conv_item.nr_seq_propaci_origem%type, nr_interno_conta_p conta_pac_deducao_conv.nr_seq_conta_orig%type, nm_usuario_p conta_pac_deducao_conv.nm_usuario%type ) AS $body$
DECLARE


dt_current_s 			constant timestamp := clock_timestamp();
qt_conta_pac_ded_conv_w		integer;
nr_seq_conta_pac_ded_conv_dt_w	conta_pac_deducao_conv.nr_sequencia%type;
nr_seq_conta_pac_ded_conv_og_w	conta_pac_deducao_conv.nr_sequencia%type;
ie_copago_w			conta_pac_deducao_conv.ie_copago%type;
ie_coseguro_w			conta_pac_deducao_conv.ie_coseguro%type;
ie_tipo_calculo_w		conta_pac_deducao_conv.ie_tipo_calculo%type;
nr_seq_conta_des_w		conta_pac_deducao_conv.nr_seq_conta_des%type;
pr_informado_calculo_w		conta_pac_deducao_conv.pr_informado_calculo%type;
vl_informado_calculo_w		conta_pac_deducao_conv.vl_informado_calculo%type;
vl_calculado_w			conta_pac_deducao_conv.vl_calculado%type;
dt_processamento_w		conta_pac_deducao_conv.dt_processamento%type;
cd_convenio_w			conta_pac_deducao_conv.cd_convenio%type;
cd_categoria_w			conta_pac_deducao_conv.cd_categoria%type;
ie_valor_original_w		conta_pac_deducao_conv.ie_valor_original%type;
nr_seq_conta_orig_w		conta_pac_deducao_conv.nr_seq_conta_orig%type;


BEGIN
-- checks if exists more than one item for deduction account
select  count(x.nr_sequencia),
        max(x.nr_seq_deducao_conv),
        max(y.ie_tipo_calculo),
        max(y.ie_copago),
        max(y.ie_coseguro),
        max(y.nr_seq_conta_des),
        max(y.pr_informado_calculo),
        max(y.vl_informado_calculo),
        max(y.vl_calculado),
        max(y.dt_processamento),
        max(y.cd_convenio),
        max(y.cd_categoria),
        max(y.ie_valor_original),
        max(y.nr_seq_conta_orig)
into STRICT 	qt_conta_pac_ded_conv_w,
	nr_seq_conta_pac_ded_conv_og_w,
	ie_tipo_calculo_w,
	ie_copago_w,
	ie_coseguro_w,
	nr_seq_conta_des_w,
	pr_informado_calculo_w,
	vl_informado_calculo_w,
	vl_calculado_w,
	dt_processamento_w,
	cd_convenio_w,
	cd_categoria_w,
	ie_valor_original_w,
	nr_seq_conta_orig_w
from    conta_pac_ded_conv_item x,
        conta_pac_deducao_conv y
where   x.nr_seq_deducao_conv in (
		SELECT  max(a.nr_seq_deducao_conv)
		from    conta_pac_ded_conv_item a,
			conta_pac_deducao_conv b
		where   ((nr_seq_proc_p IS NOT NULL AND nr_seq_proc_p::text <> '') and (a.nr_seq_propaci_origem = nr_seq_proc_p)
			or (nr_seq_mat_p IS NOT NULL AND nr_seq_mat_p::text <> '') and (a.nr_seq_matpaci_origem = nr_seq_mat_p))
		and     a.nr_seq_deducao_conv = b.nr_sequencia)
and     y.nr_sequencia = x.nr_seq_deducao_conv;

-- if has more than one item, duplicates the link
if (qt_conta_pac_ded_conv_w > 1) then
	select	nextval('conta_pac_deducao_conv_seq')
	into STRICT	nr_seq_conta_pac_ded_conv_dt_w
	;

	insert into  conta_pac_deducao_conv(
		nr_seq_conta_orig,
		nr_sequencia,
		nm_usuario,
		nm_usuario_nrec,
		dt_atualizacao,
		dt_atualizacao_nrec,
		ie_tipo_calculo,
		ie_copago,
		ie_coseguro,
		nr_seq_conta_des,
		pr_informado_calculo,
		vl_informado_calculo,
		vl_calculado,
		dt_processamento,
		cd_convenio,
		cd_categoria,
		ie_valor_original
	) values (
		nr_interno_conta_p,
		nr_seq_conta_pac_ded_conv_dt_w,
		nm_usuario_p,
		nm_usuario_p,
		dt_current_s,
		dt_current_s,
		ie_tipo_calculo_w,
		ie_copago_w,
		ie_coseguro_w,
		nr_seq_conta_des_w,
		pr_informado_calculo_w,
		vl_informado_calculo_w,
		vl_calculado_w,
		dt_processamento_w,
		cd_convenio_w,
		cd_categoria_w,
		ie_valor_original_w
	);

	-- just transfer the link between the accounts
	update  conta_pac_ded_conv_item
	set 	nr_seq_deducao_conv = nr_seq_conta_pac_ded_conv_dt_w
	where   ((nr_seq_proc_p IS NOT NULL AND nr_seq_proc_p::text <> '') and (nr_seq_propaci_origem = nr_seq_proc_p)
		or (nr_seq_mat_p IS NOT NULL AND nr_seq_mat_p::text <> '') and (nr_seq_matpaci_origem = nr_seq_mat_p));

	-- splits the account values
	update 	conta_pac_deducao_conv
	set 	vl_calculado = (
		SELECT 	sum(c.vl_procedimento)
		from    conta_pac_deducao_conv a,
		        conta_pac_ded_conv_item b,
		        procedimento_paciente c
		where   a.nr_sequencia = b.nr_seq_deducao_conv
		and     b.nr_seq_propaci_dest = c.nr_sequencia
		and     a.nr_sequencia = nr_seq_conta_pac_ded_conv_og_w
	)
	where 	nr_sequencia = nr_seq_conta_pac_ded_conv_og_w;

	update 	conta_pac_deducao_conv
	set 	vl_calculado = (
		SELECT 	sum(c.vl_procedimento)
		from    conta_pac_deducao_conv a,
		        conta_pac_ded_conv_item b,
		        procedimento_paciente c
		where   a.nr_sequencia = b.nr_seq_deducao_conv
		and     b.nr_seq_propaci_dest = c.nr_sequencia
		and     a.nr_sequencia = nr_seq_conta_pac_ded_conv_dt_w
	)
	where 	nr_sequencia = nr_seq_conta_pac_ded_conv_dt_w;
elsif (qt_conta_pac_ded_conv_w = 1) then
	update 	conta_pac_deducao_conv
	set 	nr_seq_conta_orig = nr_interno_conta_p
	where 	nr_sequencia = nr_seq_conta_pac_ded_conv_og_w;
end if;

-- Original account #@NR_INTERNO_CONTA#@
if (nr_seq_proc_p > 0) then
	update 	procedimento_paciente
	set	ds_observacao = (ds_observacao || CASE WHEN ds_observacao = NULL THEN  ''  ELSE ' - ' END  || wheb_mensagem_pck.get_texto(1216183,'NR_INTERNO_CONTA=' || nr_seq_conta_orig_w))
	where	nr_sequencia = nr_seq_proc_p;
elsif (nr_seq_mat_p > 0) then
	update 	material_atend_paciente
	set	ds_observacao = (ds_observacao || CASE WHEN ds_observacao = NULL THEN  ''  ELSE ' - ' END  || wheb_mensagem_pck.get_texto(1216183,'NR_INTERNO_CONTA=' || nr_seq_conta_orig_w))
	where	nr_sequencia = nr_seq_mat_p;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE transfer_coinsurance_item ( nr_seq_mat_p conta_pac_ded_conv_item.nr_seq_matpaci_origem%type, nr_seq_proc_p conta_pac_ded_conv_item.nr_seq_propaci_origem%type, nr_interno_conta_p conta_pac_deducao_conv.nr_seq_conta_orig%type, nm_usuario_p conta_pac_deducao_conv.nm_usuario%type ) FROM PUBLIC;

