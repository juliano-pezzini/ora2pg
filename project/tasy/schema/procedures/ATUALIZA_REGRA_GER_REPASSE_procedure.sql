-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_regra_ger_repasse (nr_repasse_terceiro_p bigint, cd_regra_p bigint, nm_usuario_p text, ie_considera_regra_p text default null) AS $body$
DECLARE

cont_W	bigint;
nr_seq_rep_terc_regra_w	bigint;


BEGIN

select	count(*)
into STRICT	cont_w
from	repasse_terceiro_regra
where	nr_repasse_terceiro	= nr_repasse_terceiro_p;

if (cont_w	<> 0) then

	select	max(nr_sequencia)
	into STRICT	nr_seq_rep_terc_regra_w
	from	repasse_terceiro_regra
	where	nr_repasse_terceiro	= nr_repasse_terceiro_p;

	update	REPASSE_TERCEIRO_REGRA
	set	cd_regra	= CASE WHEN ie_considera_regra_p='C' THEN cd_regra_p  ELSE null END ,
		cd_regra_fora	= CASE WHEN ie_considera_regra_p='N' THEN cd_regra_p  ELSE null END ,
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_repasse_terceiro	= nr_repasse_terceiro_p
	and	nr_sequencia		= nr_seq_rep_terc_regra_w;
else
	insert	into	repasse_terceiro_regra(
				NR_SEQUENCIA,
				DT_ATUALIZACAO,
				NM_USUARIO,
				NR_REPASSE_TERCEIRO,
				cd_regra,
				cd_regra_fora)
		values (		nextval('repasse_terceiro_regra_seq'),
				clock_timestamp(),
				nm_usuario_p,
				nr_repasse_terceiro_p,
				CASE WHEN ie_considera_regra_p='C' THEN cd_regra_p  ELSE null END ,
				CASE WHEN ie_considera_regra_p='N' THEN cd_regra_p  ELSE null END );
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_regra_ger_repasse (nr_repasse_terceiro_p bigint, cd_regra_p bigint, nm_usuario_p text, ie_considera_regra_p text default null) FROM PUBLIC;

