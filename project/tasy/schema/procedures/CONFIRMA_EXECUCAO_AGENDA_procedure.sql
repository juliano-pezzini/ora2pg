-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE confirma_execucao_agenda ( nr_seq_proc_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_atendimento_w		bigint;
cd_procedimento_w		bigint;
dt_procedimento_w		timestamp;
ie_agenda_executada_w		varchar(1);/*Ivan em 26/10/2007 OS72479*/
cd_estabelecimento_w		smallint;/*Ivan em 26/10/2007 OS72479*/
ie_origem_proced_w		bigint;


BEGIN 
 
select 	max(a.nr_atendimento), 
	max(a.cd_procedimento), 
	max(a.dt_procedimento), 
	max(b.cd_estabelecimento), 
	max(ie_origem_proced) 
into STRICT	nr_atendimento_w, 
	cd_procedimento_w, 
	dt_procedimento_w, 
	cd_estabelecimento_w, 
	ie_origem_proced_w 
from 	atendimento_paciente b, 
	procedimento_paciente a 
where 	b.nr_atendimento	= a.nr_atendimento 
and	a.nr_sequencia 		= nr_seq_proc_p;
 
select	max(coalesce(ie_agenda_executada,'S')) 
into STRICT	ie_agenda_executada_w 
from	parametro_atendimento 
where	cd_estabelecimento	= cd_estabelecimento_w;
 
if (ie_agenda_executada_w = 'S') then 
 
	update 	agenda_paciente 
	set 	ie_status_agenda 	= 'E', 
		nm_usuario 		= nm_usuario_p 
	where 	cd_procedimento 	= cd_procedimento_w 
	and	ie_origem_proced	= ie_origem_proced_w 
	and 	dt_agenda 		< dt_procedimento_w 
	and 	nr_atendimento		= nr_atendimento_w;
	commit;
	 
end if;	
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE confirma_execucao_agenda ( nr_seq_proc_p bigint, nm_usuario_p text) FROM PUBLIC;

