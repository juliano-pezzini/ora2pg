-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reg_fin_ajuste_test_plan_urs ( ds_version_p text, nm_usuario_p text, ie_tipo_ajuste_p text, ds_motivo_exclusao_p text, nr_seq_intencao_uso_p bigint ) AS $body$
DECLARE

    nr_seq_control_w reg_validation_pendencies.nr_seq_control%TYPE;

BEGIN
    IF ( ie_tipo_ajuste_p = 'I' ) THEN
        SELECT
            MAX(nr_sequencia)
        INTO STRICT nr_seq_control_w
        FROM
            reg_validation_control
        WHERE
                cd_versao = ds_version_p
            AND nr_seq_intencao_uso = nr_seq_intencao_uso_p
            AND ie_situacao = 'A';

        IF (nr_seq_control_w IS NOT NULL AND nr_seq_control_w::text <> '') THEN
            INSERT INTO reg_validation_pendencies(
                nr_sequencia,
                dt_atualizacao,
                nm_usuario,
                dt_atualizacao_nrec,
                nm_usuario_nrec,
                nr_seq_cr,
                nr_seq_tc,
                ds_version,
                ie_status,
                nr_seq_control
            )
                SELECT
                    nextval('reg_validation_pendencies_seq'),
                    clock_timestamp(),
                    nm_usuario_p,
                    clock_timestamp(),
                    nm_usuario_p,
                    w.nr_seq_customer_req,
                    w.nr_seq_caso_teste,
                    ds_version_p,
                    'P',
                    nr_seq_control_w
                FROM
                    w_test_plan_ignored_urs w
                WHERE
                        w.nm_usuario = nm_usuario_p
                    AND w.ie_tipo_operacao = 'I';

        END IF;

    ELSIF ( ie_tipo_ajuste_p = 'R' ) THEN
        UPDATE reg_validation_pendencies
        SET
            ie_status = 'E',
            ds_motivo_exclusao = ds_motivo_exclusao_p,
            nm_usuario = nm_usuario_p,
            dt_atualizacao = clock_timestamp()
        WHERE
                ds_version = ds_version_p
            AND coalesce(ie_status, 'P') <> 'E'
            AND nr_seq_tc IN (
                SELECT
                    w.nr_seq_caso_teste
                FROM
                    w_test_plan_ignored_urs w
                WHERE
                        w.nm_usuario = nm_usuario_p
                    AND w.ds_version = ds_version_p
                    AND w.ie_tipo_operacao = 'R'
            );

    END IF;

    DELETE FROM w_test_plan_ignored_urs
    WHERE
            nm_usuario = nm_usuario_p
        AND ie_tipo_operacao = ie_tipo_ajuste_p;

    COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reg_fin_ajuste_test_plan_urs ( ds_version_p text, nm_usuario_p text, ie_tipo_ajuste_p text, ds_motivo_exclusao_p text, nr_seq_intencao_uso_p bigint ) FROM PUBLIC;

