-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE envia_email_aprov_ordem_comp ( nr_ordem_compra_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


/*Campos EMAIL*/

nm_comprador_w		varchar(150);
nm_solicitante_w	varchar(150);
ds_assunto_w		varchar(255);
ds_mensagem_w		varchar(2000);
ds_email_w		varchar(255);
ds_email_comprador_w	varchar(80);
ds_email_destino_w	varchar(2000);
ie_momento_envio_w	varchar(1);
ie_tipo_mensagem_w	integer;
ds_email_remetente_w	varchar(255);
ie_enviou_email_w		varchar(1);
ds_historico_w		varchar(4000);
ds_erro_w		varchar(2000);

/*Campos CURSOR*/

nr_sequencia_w		bigint;
ie_usuario_w		varchar(3);
ds_email_adicional_w	varchar(2000);
cd_perfil_disparar_w	integer;

nr_telefone_w		varchar(15);
nr_ramal_w		varchar(8);
/*Cursor do grupo de compras */

ds_email_grupo_comp_w	varchar(80);
ds_cond_pagto_w		condicao_pagamento.ds_condicao_pagamento%type;


C01 CURSOR FOR
SELECT	nr_sequencia,
	ie_usuario,
	substr(ds_email_adicional,1,2000),
	cd_perfil_disparar,
	coalesce(ds_email_remetente,'X'),
	coalesce(ie_momento_envio,'I'),
	ie_tipo_mensagem
from	regra_envio_email_compra
where	ie_tipo_mensagem in (38,64)
and 	ie_situacao = 'A'
and	cd_estabelecimento = cd_estabelecimento_p
and	obter_se_envia_email_regra(nr_ordem_compra_p, 'OC', ie_tipo_mensagem, cd_estabelecimento_p) = 'S';

C02 CURSOR FOR
SELECT  distinct
	substr(obter_email_usuario(e.cd_comprador,obter_usuario_pessoa(e.cd_comprador),1),1,255)
from 	solic_compra a,
	solic_compra_item b,
	ordem_compra_item c,
	sup_grupo_resp_compras d,
	sup_grupo_resp_comprador e
where 	a.nr_solic_compra 	   = b.nr_solic_compra
and	c.nr_item_solic_compra 	   = b.nr_item_solic_compra
and	c.nr_solic_compra 	   = b.nr_solic_compra
and	e.nr_seq_regra 		   = d.nr_sequencia
and	a.nr_seq_grupo_resp_compra = d.nr_sequencia
and	c.nr_ordem_compra 	   = nr_ordem_compra_p
and	(a.nr_seq_grupo_resp_compra IS NOT NULL AND a.nr_seq_grupo_resp_compra::text <> '');


BEGIN

open C01;
loop
fetch C01 into
	nr_sequencia_w,
	ie_usuario_w,
	ds_email_adicional_w,
	cd_perfil_disparar_w,
	ds_email_remetente_w,
	ie_momento_envio_w,
	ie_tipo_mensagem_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (coalesce(cd_perfil_disparar_w::text, '') = '') or (cd_perfil_disparar_w IS NOT NULL AND cd_perfil_disparar_w::text <> '') and (cd_perfil_disparar_w = obter_perfil_ativo) then
		begin

		if (ie_usuario_w = 'U') then --Usuario
			select	substr(obter_dados_usuario_opcao(nm_usuario_p,'M'),1,8),
				substr(obter_dados_usuario_opcao(nm_usuario_p,'E'),1,255),
				substr(obter_dados_pf_pj(obter_pessoa_fisica_usuario(nm_usuario_p,'C'),obter_cgc_estabelecimento(cd_estabelecimento_p),'T'),1,15)
			into STRICT	nr_ramal_w,
				ds_email_w,
				nr_telefone_w
			from	usuario
			where	nm_usuario = nm_usuario_p;
		elsif	((ie_usuario_w = 'C') or (ie_usuario_w = 'O')) then --Setor compras
			select	ds_email,
				nr_telefone
			into STRICT	ds_email_w,
				nr_telefone_w
			from	parametro_compras
			where	cd_estabelecimento = cd_estabelecimento_p;
		end if;

		select	substr(obter_nome_pf(cd_comprador),1,100),
			substr(obter_nome_pf(cd_pessoa_solicitante),1,100),
			substr(sup_obter_dados_comprador(cd_estabelecimento_p,obter_dados_ordem_compra(nr_ordem_compra_p,'C'),'E'),1,80),
			substr(obter_desc_cond_pagto(cd_condicao_pagamento),1,255)
		into STRICT	nm_comprador_w,
			nm_solicitante_w,
			ds_email_comprador_w,
			ds_cond_pagto_w
		from	ordem_compra
		where	nr_ordem_compra = nr_ordem_compra_p;


		if (ie_tipo_mensagem_w in (38,64)) then
			ds_email_destino_w := ds_email_comprador_w;

		else
			open C02;
			loop
			fetch C02 into
				ds_email_grupo_comp_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin
				ds_email_destino_w := substr(ds_email_destino_w || ds_email_grupo_comp_w || ';',1,2000);
				end;
			end loop;
			close C02;

		ds_email_destino_w := substr(ds_email_destino_w,1,length(ds_email_destino_w)-1);

		end if;

		select	max(	substr(
				replace_macro(
				replace_macro(
				replace_macro(
				replace_macro(ds_assunto,
					'@ordem', nr_ordem_compra_p ),
					'@solicitante', nm_solicitante_w ),
					'@ds_cond_pagto', ds_cond_pagto_w ),
					'@comprador', nm_comprador_w ),1,255)) ds_assunto,
			max(	substr(
				replace_macro(
				replace_macro(
				replace_macro(
				replace_macro(ds_mensagem_padrao,
					'@ordem', nr_ordem_compra_p ),
					'@solicitante', nm_solicitante_w ),
					'@ds_cond_pagto', ds_cond_pagto_w ),
					'@comprador', nm_comprador_w ),1,2000)) ds_mensagem
		into STRICT	ds_assunto_w,
			ds_mensagem_w
		from	regra_envio_email_compra
		where	nr_sequencia = nr_sequencia_w;

		if (ds_email_adicional_w IS NOT NULL AND ds_email_adicional_w::text <> '') then
			ds_email_destino_w := substr(ds_email_destino_w || ';' || ds_email_adicional_w,1,2000);
		end if;

		if (ds_email_remetente_w <> 'X') then
			ds_email_w	:= ds_email_remetente_w;
		end if;

		ie_enviou_email_w := 'N';

		if (ie_momento_envio_w = 'A') then
			begin

			CALL sup_grava_envio_email(
				'OC',
				ie_tipo_mensagem_w,
				nr_ordem_compra_p,
				null,
				null,
				ds_email_destino_w,
				nm_usuario_p,
				ds_email_w,
				ds_assunto_w,
				ds_mensagem_w,
				cd_estabelecimento_p,
				nm_usuario_p);

			ie_enviou_email_w	:= 'S';

			end;
		else

			begin
			CALL enviar_email(	ds_assunto_w,
					ds_mensagem_w,
				 	ds_email_w,
					ds_email_destino_w,
					nm_usuario_p,
					'M');

			ie_enviou_email_w	:= 'S';

			exception
			when others then
				ie_enviou_email_w := 	'N';
				ds_erro_w	:=	substr(SQLERRM(SQLSTATE),1,2000);

				/*Ocorreu erro ao tentar enviar e-mail para: #@DS_EMAIL_DESTINO#@
				Regra de envio: #@NR_SEQUECIA#@
				Erro: #@DS_ERRO#@*/
				ds_historico_w	:=	substr(wheb_mensagem_pck.get_texto(299863,
									'DS_EMAIL_DESTINO=' || ds_email_destino_w ||
									';NR_SEQUECIA=' || to_char(nr_sequencia_w) ||
									';DS_ERRO=' || ds_erro_w),1,4000);

				CALL inserir_historico_ordem_compra(
					nr_ordem_compra_p,
					'S',
					wheb_mensagem_pck.get_texto(255103),
					ds_erro_w,
					nm_usuario_p);

			end; -- Fim exception
		end if;

		if (ie_enviou_email_w = 'S') then
			begin

			/*
			Dados do envio:
			Regra de envio: #@NR_SEQUENCIA#@
			Destino: #@DS_EMAIL_DESTINO#@
			Assunto: #@DS_ASSUNTO#@
			Mensagem: #@DS_MENSAGEM#@
			*/
			ds_historico_w	:= 	substr(wheb_mensagem_pck.get_texto(299866,
							'NR_SEQUENCIA=' || to_char(nr_sequencia_w) ||
							';DS_EMAIL_DESTINO=' || ds_email_destino_w ||
							';DS_ASSUNTO=' || ds_assunto_w ||
							';DS_MENSAGEM=' || ds_mensagem_w),1,4000);

			CALL inserir_historico_ordem_compra(
				nr_ordem_compra_p,
				'S',
				wheb_mensagem_pck.get_texto(299865),
				ds_historico_w,
				nm_usuario_p);

			end;
		end if;

		end; /* FIM DO IF DO PERFIL*/
	end if;

	end;
end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE envia_email_aprov_ordem_comp ( nr_ordem_compra_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

