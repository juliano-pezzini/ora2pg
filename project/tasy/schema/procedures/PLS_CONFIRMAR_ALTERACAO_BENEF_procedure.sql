-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_confirmar_alteracao_benef ( nr_seq_seg_solic_alt_p bigint, nr_seq_motivo_alt_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_gerar_cartao_alt_prod_p text default 'S', ie_copiar_carencia_prod_novo_p text default 'N') AS $body$
DECLARE


ds_erro_w			varchar(255);
nr_seq_contrato_w		pls_segurado.nr_seq_contrato%type;
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
nr_seq_pagador_w		pls_segurado_solic_alt.nr_seq_alt_pagador%type;
ie_tipo_solicitacao_w		pls_segurado_solic_alt.ie_tipo_solicitacao%type;
nr_seq_alt_plano_w		pls_segurado_solic_alt.nr_seq_alt_plano%type;
nr_seq_alt_tabela_w		pls_segurado_solic_alt.nr_seq_alt_tabela%type;
nr_seq_vinculo_est_w		pls_segurado_solic_alt.nr_seq_vinculo_est%type;
cd_matricula_estipulante_w 	pls_segurado_solic_alt.cd_matricula_estipulante%type;
ie_alt_prod_dependente_w	varchar(1);
dt_alteracao_w			pls_segurado_solic_alt.dt_alteracao%type;
nr_seq_localizacao_benef_w	pls_segurado_solic_alt.nr_seq_localizacao_benef%type;
dt_admissao_w			pls_segurado_solic_alt.dt_admissao%type;
nr_seq_subestipulante_w		pls_segurado_solic_alt.nr_seq_subestipulante%type;
cd_cgc_subestipulante_w		pessoa_juridica.cd_cgc%type;
nr_seq_pagador_subestipulant_w	pls_contrato_pagador.nr_sequencia%type;


BEGIN

select	b.nr_seq_contrato,
	b.nr_sequencia nr_seq_segurado,
	a.nr_seq_alt_pagador,
	a.ie_tipo_solicitacao,
	a.nr_seq_alt_plano,
	a.nr_seq_alt_tabela,
	a.nr_seq_vinculo_est,
	a.cd_matricula_estipulante,
	a.dt_alteracao,
	a.nr_seq_localizacao_benef,
	a.dt_admissao,
	a.nr_seq_subestipulante
into STRICT	nr_seq_contrato_w,
	nr_seq_segurado_w,
	nr_seq_pagador_w,
	ie_tipo_solicitacao_w,
	nr_seq_alt_plano_w,
	nr_seq_alt_tabela_w,
	nr_seq_vinculo_est_w,
	cd_matricula_estipulante_w,
	dt_alteracao_w,
	nr_seq_localizacao_benef_w,
	dt_admissao_w,
	nr_seq_subestipulante_w
from	pls_segurado_solic_alt a,
	pls_segurado b
where	a.nr_seq_segurado = b.nr_sequencia
and	a.nr_sequencia = nr_seq_seg_solic_alt_p;

if (ie_tipo_solicitacao_w = '1') then --Alteracao do pagador
	ds_erro_w := pls_alterar_pagador_benef(nr_seq_contrato_w, nr_seq_segurado_w, nr_seq_pagador_w, 'B', cd_estabelecimento_p, nm_usuario_p, clock_timestamp(), nr_seq_motivo_alt_p, null, 'N', null, 'N', 'N', ds_erro_w);
elsif (ie_tipo_solicitacao_w = '2') then --Alteracao do produto
	if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then	
		ie_alt_prod_dependente_w := coalesce(obter_valor_param_usuario(1202, 147, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_p),'S');
		
		if (ie_alt_prod_dependente_w = 'S') then
			CALL pls_alterar_produto_benef(nr_seq_contrato_w,nr_seq_segurado_w,nr_seq_alt_plano_w,nr_seq_alt_tabela_w,'D',cd_estabelecimento_p,nm_usuario_p,dt_alteracao_w, nr_seq_motivo_alt_p,null,null,ie_gerar_cartao_alt_prod_p,'N',ie_copiar_carencia_prod_novo_p,null,null,'N');
		else
			CALL pls_alterar_produto_benef(nr_seq_contrato_w,nr_seq_segurado_w,nr_seq_alt_plano_w,nr_seq_alt_tabela_w,'B',cd_estabelecimento_p,nm_usuario_p,dt_alteracao_w, nr_seq_motivo_alt_p,null,null,ie_gerar_cartao_alt_prod_p,'N',ie_copiar_carencia_prod_novo_p,null,null,'N');
		end if;
	else
		CALL pls_alt_prod_benef_intercambio(nr_seq_segurado_w,nr_seq_alt_plano_w,nr_seq_alt_tabela_w,'D',cd_estabelecimento_p,nm_usuario_p, nr_seq_motivo_alt_p,'N',null);
	end if;
elsif (ie_tipo_solicitacao_w = '3') then --Alteracao de vinculo com o estipulante
	CALL pls_alterar_vinculo_estip(nr_seq_segurado_w,nr_seq_vinculo_est_w,nm_usuario_p,cd_estabelecimento_p);
elsif (ie_tipo_solicitacao_w = '4') then --Alteracao de matricula estipulante
	CALL pls_alterar_matricula_estip(nr_seq_segurado_w,cd_matricula_estipulante_w,nm_usuario_p,'N',cd_estabelecimento_p);
elsif (ie_tipo_solicitacao_w = '5') then
	CALL pls_alt_dt_admissao_benef(nr_seq_segurado_w, dt_admissao_w, nm_usuario_p, cd_estabelecimento_p);
elsif (ie_tipo_solicitacao_w = '6') then
	CALL pls_alt_localizacao_benef(nr_seq_segurado_w, nr_seq_localizacao_benef_w, nm_usuario_p, cd_estabelecimento_p);
elsif (ie_tipo_solicitacao_w = '7') then
	CALL pls_alterar_subestipulante(nr_seq_subestipulante_w, nr_seq_segurado_w, dt_alteracao_w, 'S', nm_usuario_p, cd_estabelecimento_p);
	
	select	max(cd_cgc)
	into STRICT  	cd_cgc_subestipulante_w
	from  	pls_sub_estipulante
	where  	nr_sequencia  = nr_seq_subestipulante_w;

	if (cd_cgc_subestipulante_w IS NOT NULL AND cd_cgc_subestipulante_w::text <> '') then
		select	max(nr_sequencia)
		into STRICT  	nr_seq_pagador_subestipulant_w
		from  	pls_contrato_pagador
		where  	cd_cgc = cd_cgc_subestipulante_w
		and  	nr_seq_contrato = nr_seq_contrato_w;

		if (nr_seq_pagador_subestipulant_w IS NOT NULL AND nr_seq_pagador_subestipulant_w::text <> '') then
			ds_erro_w := pls_alterar_pagador_benef(nr_seq_contrato_w, nr_seq_segurado_w, nr_seq_pagador_subestipulant_w, 'D', cd_estabelecimento_p, nm_usuario_p, clock_timestamp(), null, null, null, null, null, null, ds_erro_w);
		end if;
	end if;	
end if;

if (ds_erro_w <> '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(319678, ds_erro_w);
else
	update	pls_segurado_solic_alt
	set	dt_confirmacao_alteracao	= clock_timestamp(),
		nm_usuario_confirmacao		= nm_usuario_p
	where	nr_sequencia = nr_seq_seg_solic_alt_p;
	
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_confirmar_alteracao_benef ( nr_seq_seg_solic_alt_p bigint, nr_seq_motivo_alt_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_gerar_cartao_alt_prod_p text default 'S', ie_copiar_carencia_prod_novo_p text default 'N') FROM PUBLIC;

