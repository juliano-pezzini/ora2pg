-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE valida_processo_gedipa_js ( nr_seq_processo_p bigint, ie_pasta_p bigint, ie_processo_valido_p INOUT text, nm_usuario_p text, cd_setor_atendimento_p bigint) AS $body$
DECLARE


ie_processo_valido_w	varchar(1);
var_status_processo     varchar(1);
var_vereficar_setor  	varchar(1);
cd_setor_processo_w     integer;
ds_descricao_setor_w    varchar(100);

BEGIN

var_status_processo := Obter_Param_Usuario(3112, 83, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, var_status_processo);
var_vereficar_setor := Obter_Param_Usuario(3112, 84, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, var_vereficar_setor);

if (nr_seq_processo_p IS NOT NULL AND nr_seq_processo_p::text <> '') then
	begin
	select	CASE WHEN coalesce(count(*),0)=0 THEN 'N'  ELSE 'S' END 
	into STRICT	ie_processo_valido_w
	from	adep_processo
	where	nr_sequencia = nr_seq_processo_p;

	if (ie_processo_valido_w = 'N') then
		begin
		--'O numero do processo informado nao existe!'
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(1132327);
		end;
	end if;

	if (ie_pasta_p = 1) then
		begin
		select	CASE WHEN coalesce(count(*),0)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_processo_valido_w
		from 	adep_processo
		where 	nr_sequencia = nr_seq_processo_p
		and 	ie_status_processo = var_status_processo;

		if (ie_processo_valido_w = 'N') then
			begin
			--'O status atual do processo e diferente do informado no parametro [83].Para continuar o status precisa ser o mesmo.'
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(1132328);
			end;
		end if;
		end;
	elsif (ie_pasta_p = 2) then
		begin
		select	CASE WHEN coalesce(count(*),0)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_processo_valido_w
		from 	adep_processo 
		where 	nr_sequencia = nr_seq_processo_p
		and 	ie_status_processo = 'R' 
		and    	coalesce(dt_entrega::text, '') = '';

		if (ie_processo_valido_w = 'N') then
			begin		
			--'O processo informado ainda nao foi dispensado!'
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(1132347);
			end;
		end if;

		end;
	else
		begin
		select	CASE WHEN coalesce(count(*),0)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_processo_valido_w
		from 	adep_processo
		where 	nr_sequencia = nr_seq_processo_p
		and 	ie_status_processo = 'R'
		and    	(dt_entrega IS NOT NULL AND dt_entrega::text <> '')
		and   	coalesce(dt_recebimento::text, '') = '';

		if (ie_processo_valido_w = 'N') then
			begin
			--'O processo informado ainda nao foi entregue no setor!'
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(1132350);
			end;
		end if;
		end;
	end if;
	end;
	
	if ((var_vereficar_setor = 'S') and ((ie_pasta_p = 2) or (ie_pasta_p = 3))) then
		select max(cd_setor_atendimento),
		       substr(max(obter_desc_setor_atend(cd_setor_atendimento)),1,100)
		       into STRICT cd_setor_processo_w,
			    ds_descricao_setor_w
		from adep_processo
		where nr_sequencia = nr_seq_processo_p;
	
		if (cd_setor_processo_w <> cd_setor_atendimento_p AND cd_setor_atendimento_p <> 0) then
		    CALL Wheb_mensagem_pck.exibir_mensagem_abort(291467,'DSSETOR=' || ds_descricao_setor_w);
		end if;
	end if;	
end if;
ie_processo_valido_p := ie_processo_valido_w;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE valida_processo_gedipa_js ( nr_seq_processo_p bigint, ie_pasta_p bigint, ie_processo_valido_p INOUT text, nm_usuario_p text, cd_setor_atendimento_p bigint) FROM PUBLIC;

