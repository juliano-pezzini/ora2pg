-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vincular_conta_paciente_html5 ( nr_interno_conta_p bigint, nr_titulo_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_titulo_w		titulo_receber.nr_titulo%type;
ie_cancelamento_w	conta_paciente.ie_cancelamento%type;
cont_w			bigint;
ie_situacao_w		titulo_receber.ie_situacao%type;
ie_vincular_atend_doc_w	varchar(255);
nr_atend_doc_w		titulo_receber.nr_atendimento%type;


BEGIN 
 
select	max(a.nr_titulo) 
into STRICT	nr_titulo_w 
from	titulo_receber a 
where	a.nr_interno_conta  = nr_interno_conta_p;
 
if (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then 
	CALL wheb_mensagem_pck.EXIBIR_MENSAGEM_ABORT(174335,'NR_INTERNO_CONTA='||nr_interno_conta_p||';NR_TITULO='||nr_titulo_w);
end if;
 
select	max(coalesce(a.ie_cancelamento,'N')), 
	count(1) 
into STRICT	ie_cancelamento_w, 
	cont_w 
from	conta_paciente a 
where	a.nr_interno_conta  = nr_interno_conta_p;
 
if (cont_w = 0) then 
	CALL wheb_mensagem_pck.EXIBIR_MENSAGEM_ABORT(174336,'NR_INTERNO_CONTA='||nr_interno_conta_p);
end if;
 
select	max(ie_situacao) 
into STRICT	ie_situacao_w 
from	titulo_receber 
where	nr_titulo	= nr_titulo_p;
 
if (ie_situacao_w = '3') and (ie_cancelamento_w <> 'C') then 
	CALL wheb_mensagem_pck.EXIBIR_MENSAGEM_ABORT(174337);
end if;
 
if (ie_situacao_w <> '3') and (ie_cancelamento_w = 'C') then 
	CALL wheb_mensagem_pck.EXIBIR_MENSAGEM_ABORT(174338);
end if;
 
ie_vincular_atend_doc_w := Obter_Param_Usuario(801, 119, wheb_usuario_pck.GET_CD_PERFIL, NM_USUARIO_P, wheb_usuario_pck.GET_CD_ESTABELECIMENTO, ie_vincular_atend_doc_w);
 
if (ie_vincular_atend_doc_w = 'S') then 
	select	max(nr_atendimento) 
	into STRICT	nr_atend_doc_w 
	from	conta_paciente 
	where	nr_interno_conta = nr_interno_conta_p;
end if;
 
CALL CALL vincular_conta_paciente(nr_interno_conta_p,nr_atend_doc_w,nr_atend_doc_w,nr_titulo_p,nm_usuario_p);
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vincular_conta_paciente_html5 ( nr_interno_conta_p bigint, nr_titulo_p bigint, nm_usuario_p text) FROM PUBLIC;

