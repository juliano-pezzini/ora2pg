-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_com_ciclo_vendas ( dt_inicial_p timestamp, dt_final_p timestamp, nr_seq_cliente_p text, nr_seq_canal_p text, ie_classificacao_p text, ie_tipo_p text) AS $body$
DECLARE


nr_seq_cliente_w		bigint;
ie_classificacao_w		varchar(15);
nr_seq_fechado_w		bigint;
dt_prospect_w			timestamp;
nr_seq_prospect_w		bigint;
nr_seq_log_lead_qualif_w	bigint;
dt_ini_lead_qualif_w		timestamp;
dt_fim_lead_qualif_w		timestamp;
qt_lead_qualificacao_w		double precision;
nr_seq_log_prosp_abordagem_w	bigint;
dt_ini_prosp_abordagem_w	timestamp;
dt_fim_prosp_abordagem_w	timestamp;
qt_prosp_abordagem_w		double precision;
nr_seq_log_prosp_qualif_w	bigint;
dt_ini_prosp_qualif_w		timestamp;
dt_fim_prosp_qualif_w		timestamp;
qt_prosp_qualificacao_w		double precision;
nr_seq_log_prosp_preabord_w	bigint;
dt_ini_prosp_preabordagem_w	timestamp;
dt_fim_prosp_preabordagem_w	timestamp;
qt_prosp_preabordagem_w		double precision;
nr_seq_log_prosp_prospeccao_w	bigint;
dt_ini_prosp_prospeccao_w	timestamp;
dt_fim_prosp_prospeccao_w	timestamp;
qt_prosp_prospeccao_w		double precision;
nr_seq_log_prosp_demonstr_w	bigint;
dt_ini_prosp_demonstracao_w	timestamp;
dt_fim_prosp_demonstracao_w	timestamp;
qt_prosp_demonstracao_w		double precision;
nr_seq_log_prosp_proposta_w	bigint;
dt_ini_prosp_proposta_w		timestamp;
dt_fim_prosp_proposta_w		timestamp;
qt_prosp_proposta_w		double precision;
nr_seq_log_prosp_negociacao_w	bigint;
dt_ini_prosp_negociacao_w	timestamp;
dt_fim_prosp_negociacao_w	timestamp;
qt_prosp_negociacao_w		double precision;
nr_seq_log_prosp_contrato_w	bigint;
dt_ini_prosp_contrato_w		timestamp;
dt_fim_prosp_contrato_w		timestamp;
qt_prosp_contrato_w		double precision;

C01 CURSOR FOR
	SELECT	a.nr_seq_cliente,
		ie_classificacao
	from	com_canal_cliente a,
		com_cliente b
	where	a.nr_seq_cliente = b.nr_sequencia
	and	a.dt_inicio_atuacao between dt_inicial_p and dt_final_p
	and	coalesce(a.dt_fim_atuacao::text, '') = ''
	and (a.nr_seq_cliente = nr_seq_cliente_p or coalesce(nr_seq_cliente_p::text, '') = '')
	and (a.nr_seq_canal = nr_seq_canal_p or coalesce(nr_seq_canal_p::text, '') = '')
	and (b.ie_classificacao = ie_classificacao_p or coalesce(ie_classificacao_p::text, '') = '')
	and (b.ie_tipo = ie_tipo_p or coalesce(ie_tipo_p::text, '') = '')
	and	a.ie_tipo_atuacao = 'V'
	and	b.ie_situacao = 'A';


BEGIN
delete	from w_com_ciclo_vendas;

open C01;
loop
fetch C01 into
	nr_seq_cliente_w,
	ie_classificacao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_seq_fechado_w
	from	com_cliente_log
	where	nr_seq_cliente = nr_seq_cliente_w
	and	ie_log = 4;

	select	max(dt_log),
		max(nr_sequencia)
	into STRICT	dt_prospect_w,
		nr_seq_prospect_w
	from	com_cliente_log
	where	ie_classificacao = 'P'
	and	nr_seq_cliente = nr_seq_cliente_w
	and	nr_sequencia > nr_seq_fechado_w;

	--Dias em Lead - Qualificação
	select	max(dt_log),
		max(nr_sequencia)
	into STRICT	dt_ini_lead_qualif_w,
		nr_seq_log_lead_qualif_w
	from	com_cliente_log
	where	ie_classificacao = 'L'
	and	nr_seq_cliente = nr_seq_cliente_w
	and	nr_sequencia > nr_seq_fechado_w;

	select	coalesce(min(dt_log),clock_timestamp())
	into STRICT	dt_fim_lead_qualif_w
	from	com_cliente_log
	where	ie_classificacao <> 'L'
	and	nr_sequencia > nr_seq_log_lead_qualif_w
	and	nr_seq_cliente = nr_seq_cliente_w
	and	nr_sequencia > nr_seq_fechado_w;

	qt_lead_qualificacao_w := Obter_Dias_Entre_Datas(dt_ini_lead_qualif_w,dt_fim_lead_qualif_w);

	--Dias em Prospect - Qualificação
	select	max(dt_log),
		max(nr_sequencia)
	into STRICT	dt_ini_prosp_qualif_w,
		nr_seq_log_prosp_qualif_w
	from	com_cliente_log
	where	ie_fase_venda = 'Q'
	and	nr_sequencia > nr_seq_prospect_w
	and	nr_seq_cliente = nr_seq_cliente_w;

	select	coalesce(min(dt_log),clock_timestamp())
	into STRICT	dt_fim_prosp_qualif_w
	from	com_cliente_log
	where	ie_fase_venda <> 'Q'
	and	nr_sequencia > nr_seq_prospect_w
	and	nr_seq_cliente = nr_seq_cliente_w;


	qt_prosp_qualificacao_w := Obter_Dias_Entre_Datas(dt_prospect_w,dt_fim_prosp_qualif_w);

	--Dias em Prospect - Pré abordagem
	select	max(dt_log),
		max(nr_sequencia)
	into STRICT	dt_ini_prosp_preabordagem_w,
		nr_seq_log_prosp_preabord_w
	from	com_cliente_log
	where	ie_fase_venda = 'PA'
	and	nr_sequencia > nr_seq_prospect_w
	and	nr_seq_cliente = nr_seq_cliente_w;

	select	coalesce(min(dt_log),clock_timestamp())
	into STRICT	dt_fim_prosp_preabordagem_w
	from	com_cliente_log
	where	ie_fase_venda <> 'PA'
	and	nr_sequencia > nr_seq_log_prosp_preabord_w
	and	nr_seq_cliente = nr_seq_cliente_w;


	qt_prosp_preabordagem_w := Obter_Dias_Entre_Datas(dt_ini_prosp_preabordagem_w,dt_fim_prosp_preabordagem_w);

	--Dias em Prospect - Abordagem
	select	max(dt_log),
		max(nr_sequencia)
	into STRICT	dt_ini_prosp_abordagem_w,
		nr_seq_log_prosp_abordagem_w
	from	com_cliente_log
	where	ie_fase_venda = 'A'
	and	nr_sequencia > nr_seq_prospect_w
	and	nr_seq_cliente = nr_seq_cliente_w;

	select	coalesce(min(dt_log),clock_timestamp())
	into STRICT	dt_fim_prosp_abordagem_w
	from	com_cliente_log
	where	ie_fase_venda <> 'A'
	and	nr_sequencia > nr_seq_log_prosp_abordagem_w
	and	nr_seq_cliente = nr_seq_cliente_w;


	qt_prosp_abordagem_w := Obter_Dias_Entre_Datas(dt_ini_prosp_abordagem_w,dt_fim_prosp_abordagem_w);

	--Dias em Prospect - Prospecção
	select	max(dt_log),
		max(nr_sequencia)
	into STRICT	dt_ini_prosp_prospeccao_w,
		nr_seq_log_prosp_prospeccao_w
	from	com_cliente_log
	where	ie_fase_venda = 'PR'
	and	nr_sequencia > nr_seq_prospect_w
	and	nr_seq_cliente = nr_seq_cliente_w;

	select	coalesce(min(dt_log),clock_timestamp())
	into STRICT	dt_fim_prosp_prospeccao_w
	from	com_cliente_log
	where	ie_fase_venda <> 'PR'
	and	nr_sequencia > nr_seq_log_prosp_prospeccao_w
	and	nr_seq_cliente = nr_seq_cliente_w;


	qt_prosp_prospeccao_w := Obter_Dias_Entre_Datas(dt_ini_prosp_prospeccao_w,dt_fim_prosp_prospeccao_w);

	--Dias em Prospect - Demonstração
	select	max(dt_log),
		max(nr_sequencia)
	into STRICT	dt_ini_prosp_demonstracao_w,
		nr_seq_log_prosp_demonstr_w
	from	com_cliente_log
	where	ie_fase_venda = 'D'
	and	nr_sequencia > nr_seq_prospect_w
	and	nr_seq_cliente = nr_seq_cliente_w;

	select	coalesce(min(dt_log),clock_timestamp())
	into STRICT	dt_fim_prosp_demonstracao_w
	from	com_cliente_log
	where	ie_fase_venda <> 'D'
	and	nr_sequencia > nr_seq_log_prosp_demonstr_w
	and	nr_seq_cliente = nr_seq_cliente_w;


	qt_prosp_demonstracao_w := Obter_Dias_Entre_Datas(dt_ini_prosp_demonstracao_w,dt_fim_prosp_demonstracao_w);

	--Dias em Prospect -Proposta comercial
	select	max(dt_log),
		max(nr_sequencia)
	into STRICT	dt_ini_prosp_proposta_w,
		nr_seq_log_prosp_proposta_w
	from	com_cliente_log
	where	ie_fase_venda = 'PC'
	and	nr_sequencia > nr_seq_prospect_w
	and	nr_seq_cliente = nr_seq_cliente_w;

	select	coalesce(min(dt_log),clock_timestamp())
	into STRICT	dt_fim_prosp_proposta_w
	from	com_cliente_log
	where	ie_fase_venda <> 'PC'
	and	nr_sequencia > nr_seq_log_prosp_proposta_w
	and	nr_seq_cliente = nr_seq_cliente_w;


	qt_prosp_proposta_w := Obter_Dias_Entre_Datas(dt_ini_prosp_proposta_w,dt_fim_prosp_proposta_w);

	--Dias em Prospect - Negociação
	select	max(dt_log),
		max(nr_sequencia)
	into STRICT	dt_ini_prosp_negociacao_w,
		nr_seq_log_prosp_negociacao_w
	from	com_cliente_log
	where	ie_fase_venda = 'N'
	and	nr_sequencia > nr_seq_prospect_w
	and	nr_seq_cliente = nr_seq_cliente_w;

	select	coalesce(min(dt_log),clock_timestamp())
	into STRICT	dt_fim_prosp_negociacao_w
	from	com_cliente_log
	where	ie_fase_venda <> 'N'
	and	nr_sequencia > nr_seq_log_prosp_negociacao_w
	and	nr_seq_cliente = nr_seq_cliente_w;


	qt_prosp_negociacao_w := Obter_Dias_Entre_Datas(dt_ini_prosp_negociacao_w,dt_fim_prosp_negociacao_w);

	--Dias em Prospect - Contrato
	select	max(dt_log),
		max(nr_sequencia)
	into STRICT	dt_ini_prosp_contrato_w,
		nr_seq_log_prosp_contrato_w
	from	com_cliente_log
	where	ie_fase_venda = 'C'
	and	nr_sequencia > nr_seq_prospect_w
	and	nr_seq_cliente = nr_seq_cliente_w;

	select	coalesce(min(dt_log),clock_timestamp())
	into STRICT	dt_fim_prosp_contrato_w
	from	com_cliente_log
	where	ie_fase_venda <> 'C'
	and	nr_sequencia > nr_seq_log_prosp_contrato_w
	and	nr_seq_cliente = nr_seq_cliente_w;


	qt_prosp_contrato_w := Obter_Dias_Entre_Datas(dt_ini_prosp_contrato_w,dt_fim_prosp_contrato_w);


	insert into w_com_ciclo_vendas(nr_seq_cliente,
					ie_classificacao,
					qt_lead_qualificacao,
					qt_prosp_abordagem,
					qt_prosp_qualificacao,
					qt_prosp_preabordagem,
					qt_prosp_prospeccao,
					qt_prosp_demonstracao,
					qt_prosp_proposta,
					qt_prosp_negociacao,
					qt_prosp_contrato)
				values (nr_seq_cliente_w,
					ie_classificacao_w,
					qt_lead_qualificacao_w,
					qt_prosp_abordagem_w,
					qt_prosp_qualificacao_w,
					qt_prosp_preabordagem_w,
					qt_prosp_prospeccao_w,
					qt_prosp_demonstracao_w,
					qt_prosp_proposta_w,
					qt_prosp_negociacao_w,
					qt_prosp_contrato_w);

	end;

	commit;

end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_com_ciclo_vendas ( dt_inicial_p timestamp, dt_final_p timestamp, nr_seq_cliente_p text, nr_seq_canal_p text, ie_classificacao_p text, ie_tipo_p text) FROM PUBLIC;

