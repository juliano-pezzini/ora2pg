-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_preco_brasindice ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, nr_seq_material_p pls_material.nr_sequencia%type, dt_vigencia_p timestamp, tx_ajuste_pfb_p bigint, tx_pmc_neut_p bigint, tx_pmc_neg_p bigint, tx_pmc_pos_p bigint, ie_tipo_preco_brasindice_p text, vl_medicamento_p INOUT bigint, dt_ult_vigencia_p INOUT timestamp, cd_tiss_p INOUT text, vl_pfb_neutra_brasindice_p bigint, vl_pfb_positiva_brasindice_p bigint, vl_pfb_negativa_brasindice_p bigint, ie_tipo_ajuste_pfb_p text, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


cd_laboratorio_w		brasindice_preco.cd_laboratorio%type;
cd_medicamento_w		brasindice_preco.cd_medicamento%type;
cd_apresentacao_w		brasindice_preco.cd_apresentacao%type;
vl_medicamento_w		double precision := 0;
ie_tipo_preco_regra_w		varchar(3);
ie_tipo_preco_w			varchar(3);
tx_ajuste_pfb_w			double precision := 1;
qt_conversao_w			double precision := 1;
dt_ult_vigencia_w		timestamp := clock_timestamp();
dt_vigencia_bras_w		timestamp := clock_timestamp();
tx_pmc_neut_w			double precision := 1;
tx_pmc_neg_w			double precision := 1;
tx_pmc_pos_w			double precision := 1;
ie_preco_port_w			varchar(1) := '';
pr_ipi_w			real;
ie_exige_lib_w			varchar(1);
ie_pis_cofins_w			varchar(1);
cd_tiss_brasindice_w		varchar(15);
ie_ultimo_valor_valido_w	varchar(1);
ie_restringe_estab_w		varchar(2);
dt_vigencia_considerar_w	timestamp;
ie_tipo_preco_quando_pfm_w 	brasindice_preco.ie_tipo_preco%type;
ie_ultima_vig_brasindice_w	pls_parametros.ie_ultima_vigencia_brasindice%type;
ie_restringir_bras_tiss_w	pls_parametros.IE_RESTRINGIR_BRASINDICE_TISS%type;
dt_vigencia_max_w		timestamp;

c01 CURSOR FOR
	SELECT	cd_laboratorio,
		cd_medicamento,
		cd_apresentacao
	from	brasindice_preco
	where	cd_tiss	= cd_tiss_brasindice_w
	and	dt_inicio_vigencia = (	SELECT	max(a.dt_inicio_vigencia)
					from	brasindice_preco a
					where	a.cd_tiss = cd_tiss_brasindice_w
					and	a.dt_inicio_vigencia <= dt_vigencia_bras_w);

C02 CURSOR FOR
	SELECT	coalesce(vl_preco_final,vl_preco_medicamento) vl_preco,
		ie_tipo_preco,
		dt_inicio_vigencia,
		coalesce(ie_preco_port,'T'),
		coalesce(pr_ipi,0),
		coalesce(ie_pis_cofins,'T')
	from	brasindice_preco
	where	ie_tipo_preco_regra_w = 'PFM'
	and	cd_laboratorio = cd_laboratorio_w
	and	cd_medicamento = cd_medicamento_w
	and	cd_apresentacao = cd_apresentacao_w
	and 	ie_tipo_preco = 'PMC'
	and 	coalesce(vl_preco_final, vl_preco_medicamento) > 0
	and	ie_tipo_preco_quando_pfm_w = 'PMC'
	and	dt_inicio_vigencia = dt_vigencia_considerar_w
	
union all

	SELECT	coalesce(vl_preco_final,vl_preco_medicamento) vl_preco,
		ie_tipo_preco,
		dt_inicio_vigencia,
		coalesce(ie_preco_port,'T'),
		coalesce(pr_ipi,0),
		coalesce(ie_pis_cofins,'T')
	from	brasindice_preco
	where	ie_tipo_preco_regra_w = 'PFM'
	and	cd_laboratorio = cd_laboratorio_w
	and	cd_medicamento = cd_medicamento_w
	and	cd_apresentacao = cd_apresentacao_w
	and 	ie_tipo_preco = 'PFB'
	and (coalesce(vl_preco_final,vl_preco_medicamento) > 0)
	and	ie_tipo_preco_quando_pfm_w = 'PFB'
	and	dt_inicio_vigencia = dt_vigencia_considerar_w
	
union all

	select	coalesce(vl_preco_final,vl_preco_medicamento) vl_preco,
		ie_tipo_preco ,
		dt_inicio_vigencia,
		coalesce(ie_preco_port,'T'),
		coalesce(pr_ipi,0),
		coalesce(ie_pis_cofins,'T')
	from	brasindice_preco
	where	cd_laboratorio = cd_laboratorio_w
	and	cd_medicamento = cd_medicamento_w
	and	cd_apresentacao = cd_apresentacao_w
	and	ie_tipo_preco = coalesce(ie_tipo_preco_regra_w, ie_tipo_preco)
	and (coalesce(vl_preco_final,vl_preco_medicamento) > 0)
	and	coalesce(ie_tipo_preco_quando_pfm_w::text, '') = ''
	and	dt_inicio_vigencia = dt_vigencia_considerar_w
	order by vl_preco, ie_tipo_preco;


BEGIN

dt_vigencia_bras_w := coalesce(dt_vigencia_p, clock_timestamp());

if (coalesce(ie_tipo_preco_brasindice_p,'CR') = 'CR') then

	/* (PFB,PMC,PFM)(PFB,PMC,PFB quando PMC = 0) */

	ie_tipo_preco_regra_w := substr(pls_obter_regra_brasindice(nr_seq_material_p,dt_vigencia_bras_w,nr_seq_prestador_p,cd_estabelecimento_p),1,3);
else
	ie_tipo_preco_regra_w := ie_tipo_preco_brasindice_p;
end if;

tx_ajuste_pfb_w := tx_ajuste_pfb_p;
tx_pmc_neut_w := tx_pmc_neut_p;
tx_pmc_neg_w := coalesce(tx_pmc_neg_p, tx_pmc_neut_p);
tx_pmc_pos_w := coalesce(tx_pmc_pos_p, tx_pmc_neut_p);

select	coalesce(max(ie_exige_lib_bras),'N'),
	coalesce(max(ie_ultima_vigencia_brasindice),'N'),
	coalesce(max(ie_restringir_brasindice_tiss),'N')
into STRICT	ie_exige_lib_w,
	ie_ultima_vig_brasindice_w,
	ie_restringir_bras_tiss_w
from	pls_parametros
where	cd_estabelecimento = cd_estabelecimento_p;

ie_restringe_estab_w := pls_obter_se_controle_estab('RP');

begin
	if (ie_restringe_estab_w = 'S') then

		select	cd_tiss_brasindice,
			coalesce(qt_conversao,0)
		into STRICT	cd_tiss_brasindice_w,
			qt_conversao_w
		from	pls_material
		where	nr_sequencia = nr_seq_material_p
		and	cd_estabelecimento = cd_estabelecimento_p;
	else

		select	cd_tiss_brasindice,
			coalesce(qt_conversao,0)
		into STRICT	cd_tiss_brasindice_w,
			qt_conversao_w
		from	pls_material
		where	nr_sequencia = nr_seq_material_p;
	end if;
exception
	when others then
	cd_tiss_brasindice_w	:= '';
end;

open c01;
loop
fetch c01 into
	cd_laboratorio_w,
	cd_medicamento_w,
	cd_apresentacao_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
end loop;
close c01;

select	coalesce(max(ie_ultimo_valor_valido),'N')
into STRICT	ie_ultimo_valor_valido_w
from	pls_regra_brasindice_preco
where	dt_vigencia_bras_w between dt_inicio_vigencia_ref and dt_fim_vigencia_ref
and	ie_ultimo_valor_valido = 'S'
and	ie_situacao = 'A';


if (ie_restringir_bras_tiss_w = 'N') then
	begin
	if (ie_ultimo_valor_valido_w = 'N') then

		select	vl_preco_final,
			ie_tipo_preco,
			dt_inicio_vigencia,
			ie_preco_port,
			pr_ipi,
			ie_pis_cofins
		into STRICT	vl_medicamento_w,
			ie_tipo_preco_w,
			dt_ult_vigencia_w,
			ie_preco_port_w,
			pr_ipi_w,
			ie_pis_cofins_w
		from	(
			SELECT	coalesce(vl_preco_final,vl_preco_medicamento) vl_preco_final,
				ie_tipo_preco,
				dt_inicio_vigencia,
				coalesce(ie_preco_port,'T') ie_preco_port,
				coalesce(pr_ipi,0) pr_ipi,
				coalesce(ie_pis_cofins,'T') ie_pis_cofins
			from	brasindice_preco
			where	cd_laboratorio		= cd_laboratorio_w
			and	cd_medicamento		= cd_medicamento_w
			and	cd_apresentacao		= cd_apresentacao_w
			and 	ie_tipo_preco		= ie_tipo_preco_regra_w
			and	dt_inicio_vigencia	<= dt_vigencia_bras_w
			and	((ie_exige_lib_w	= 'N') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> ''))
			order by dt_inicio_vigencia desc) alias9 LIMIT 1;
	else
		select	vl_preco_final,
			ie_tipo_preco,
			dt_inicio_vigencia,
			ie_preco_port,
			pr_ipi,
			ie_pis_cofins
		into STRICT	vl_medicamento_w,
			ie_tipo_preco_w,
			dt_ult_vigencia_w,
			ie_preco_port_w,
			pr_ipi_w,
			ie_pis_cofins_w
		from	(
			SELECT	coalesce(vl_preco_final,vl_preco_medicamento) vl_preco_final,
				ie_tipo_preco,
				dt_inicio_vigencia,
				coalesce(ie_preco_port,'T') ie_preco_port,
				coalesce(pr_ipi,0) pr_ipi,
				coalesce(ie_pis_cofins,'T') ie_pis_cofins
			from	brasindice_preco
			where	cd_laboratorio		= cd_laboratorio_w
			and	cd_medicamento		= cd_medicamento_w
			and	cd_apresentacao		= cd_apresentacao_w
			and 	ie_tipo_preco		= ie_tipo_preco_regra_w
			and	dt_inicio_vigencia	<= dt_vigencia_bras_w
			and	cd_tiss			= cd_tiss_brasindice_w
			and	coalesce(coalesce(vl_preco_final,vl_preco_medicamento),0) > 0
			and	((ie_exige_lib_w	= 'N') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> ''))
			order by dt_inicio_vigencia desc) alias9 LIMIT 1;

	end if;

	exception
		when others then

			--Quando regra estiver para PFM
			if (coalesce(ie_tipo_preco_regra_w,'X') = 'PFM') then
				if (ie_ultima_vig_brasindice_w	= 'N') then
					--Prioriza valores PMC que não forem zerados
					select	max(a.dt_inicio_vigencia),
						max(a.ie_tipo_preco)
					into STRICT	dt_vigencia_considerar_w,
						ie_tipo_preco_quando_pfm_w
					from	brasindice_preco a
					where	a.cd_laboratorio	= cd_laboratorio_w
					and	a.cd_medicamento	= cd_medicamento_w
					and	a.cd_apresentacao	= cd_apresentacao_w
					and	a.dt_inicio_vigencia	<= dt_vigencia_bras_w
					and (a.ie_tipo_preco = 'PMC')
					and (coalesce(a.vl_preco_final,a.vl_preco_medicamento) > 0)
					and	((ie_exige_lib_w	= 'N') or (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''));

					--Caso não encontrar, então busca por valores PFB
					if (coalesce(dt_vigencia_considerar_w::text, '') = '') then

						select	max(a.dt_inicio_vigencia),
							max(a.ie_tipo_preco)
						into STRICT	dt_vigencia_considerar_w,
							ie_tipo_preco_quando_pfm_w
						from	brasindice_preco a
						where	a.cd_laboratorio	= cd_laboratorio_w
						and	a.cd_medicamento	= cd_medicamento_w
						and	a.cd_apresentacao	= cd_apresentacao_w
						and	a.dt_inicio_vigencia	<= dt_vigencia_bras_w
						and (a.ie_tipo_preco = 'PFB')
						and	((ie_exige_lib_w	= 'N') or (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''));

					end if;
				else
					select	max(a.dt_inicio_vigencia)
					into STRICT	dt_vigencia_max_w
					from	brasindice_preco a
					where	a.cd_laboratorio	= cd_laboratorio_w
					and	a.cd_medicamento	= cd_medicamento_w
					and	a.cd_apresentacao	= cd_apresentacao_w
					and	a.dt_inicio_vigencia	<= dt_vigencia_bras_w
					and (coalesce(a.vl_preco_final,a.vl_preco_medicamento) > 0)
					and	((ie_exige_lib_w	= 'N') or (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''));

					select	max(a.dt_inicio_vigencia),
						max(a.ie_tipo_preco)
					into STRICT	dt_vigencia_considerar_w,
						ie_tipo_preco_quando_pfm_w
					from	brasindice_preco a
					where	a.cd_laboratorio	= cd_laboratorio_w
					and	a.cd_medicamento	= cd_medicamento_w
					and	a.cd_apresentacao	= cd_apresentacao_w
					and	a.dt_inicio_vigencia	= dt_vigencia_max_w
					and (a.ie_tipo_preco = 'PMC')
					and (coalesce(a.vl_preco_final,a.vl_preco_medicamento) > 0)
					and	((ie_exige_lib_w	= 'N') or (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''));

					--Caso não encontrar, então busca por valores PFB
					if (coalesce(dt_vigencia_considerar_w::text, '') = '') then

						select	max(a.dt_inicio_vigencia),
							max(a.ie_tipo_preco)
						into STRICT	dt_vigencia_considerar_w,
							ie_tipo_preco_quando_pfm_w
						from	brasindice_preco a
						where	a.cd_laboratorio	= cd_laboratorio_w
						and	a.cd_medicamento	= cd_medicamento_w
						and	a.cd_apresentacao	= cd_apresentacao_w
						and	a.dt_inicio_vigencia	= dt_vigencia_max_w
						and (a.ie_tipo_preco = 'PFB')
						and	((ie_exige_lib_w	= 'N') or (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''));

					end if;
				end if;
			--Se regra não for PFM, então busca apenas pela tabela específica. PFB se regra for PFB e PMC se regra for PMC.
			else

				select	max(a.dt_inicio_vigencia)
				into STRICT	dt_vigencia_considerar_w
				from	brasindice_preco a
				where	a.cd_laboratorio = cd_laboratorio_w
				and	a.cd_medicamento = cd_medicamento_w
				and	a.cd_apresentacao = cd_apresentacao_w
				and	a.dt_inicio_vigencia <= dt_vigencia_bras_w
				and (a.ie_tipo_preco = coalesce(ie_tipo_preco_regra_w,a.ie_tipo_preco))
				and	((ie_exige_lib_w = 'N') or (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''));
			end if;

			begin
				open C02;
				loop
				fetch C02 into
					vl_medicamento_w,
					ie_tipo_preco_w,
					dt_ult_vigencia_w,
					ie_preco_port_w,
					pr_ipi_w,
					ie_pis_cofins_w;
				EXIT WHEN NOT FOUND; /* apply on C02 */
				end loop;
				close C02;
			exception
			when others then
				ie_tipo_preco_w := '';
				vl_medicamento_w := 0;
			end;
	end;
else
	begin
	if (ie_ultimo_valor_valido_w = 'N') then

		select	vl_preco_final,
			ie_tipo_preco,
			dt_inicio_vigencia,
			ie_preco_port,
			pr_ipi,
			ie_pis_cofins
		into STRICT	vl_medicamento_w,
			ie_tipo_preco_w,
			dt_ult_vigencia_w,
			ie_preco_port_w,
			pr_ipi_w,
			ie_pis_cofins_w
		from	(
			SELECT	coalesce(vl_preco_final,vl_preco_medicamento) vl_preco_final,
				ie_tipo_preco,
				dt_inicio_vigencia,
				coalesce(ie_preco_port,'T') ie_preco_port,
				coalesce(pr_ipi,0) pr_ipi,
				coalesce(ie_pis_cofins,'T') ie_pis_cofins
			from	brasindice_preco
			where	cd_laboratorio		= cd_laboratorio_w
			and	cd_medicamento		= cd_medicamento_w
			and	cd_apresentacao		= cd_apresentacao_w
			and 	ie_tipo_preco		= ie_tipo_preco_regra_w
			and	cd_tiss	  		= cd_tiss_brasindice_w
			and	dt_inicio_vigencia	<= dt_vigencia_bras_w
			and	((ie_exige_lib_w	= 'N') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> ''))
			order by dt_inicio_vigencia desc) alias8 LIMIT 1;
	else

		select	vl_preco_final,
			ie_tipo_preco,
			dt_inicio_vigencia,
			ie_preco_port,
			pr_ipi,
			ie_pis_cofins
		into STRICT	vl_medicamento_w,
			ie_tipo_preco_w,
			dt_ult_vigencia_w,
			ie_preco_port_w,
			pr_ipi_w,
			ie_pis_cofins_w
		from	(
			SELECT	coalesce(vl_preco_final,vl_preco_medicamento) vl_preco_final,
				ie_tipo_preco,
				dt_inicio_vigencia,
				coalesce(ie_preco_port,'T') ie_preco_port,
				coalesce(pr_ipi,0) pr_ipi,
				coalesce(ie_pis_cofins,'T') ie_pis_cofins
			from	brasindice_preco
			where	cd_laboratorio		= cd_laboratorio_w
			and	cd_medicamento		= cd_medicamento_w
			and	cd_apresentacao		= cd_apresentacao_w
			and 	ie_tipo_preco		= ie_tipo_preco_regra_w
			and	cd_tiss	  		= cd_tiss_brasindice_w
			and	dt_inicio_vigencia	<= dt_vigencia_bras_w
			and	coalesce(coalesce(vl_preco_final,vl_preco_medicamento),0) > 0
			and	((ie_exige_lib_w	= 'N') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> ''))
			order by dt_inicio_vigencia desc) alias9 LIMIT 1;
	end if;

	exception
		when others then

			--Quando regra estiver para PFM
			if (coalesce(ie_tipo_preco_regra_w,'X') = 'PFM') then

				if (ie_ultima_vig_brasindice_w	= 'N') then
					--Prioriza valores PMC que não forem zerados
					select	max(a.dt_inicio_vigencia),
						max(a.ie_tipo_preco)
					into STRICT	dt_vigencia_considerar_w,
						ie_tipo_preco_quando_pfm_w
					from	brasindice_preco a
					where	a.cd_laboratorio	= cd_laboratorio_w
					and	a.cd_medicamento	= cd_medicamento_w
					and	a.cd_apresentacao	= cd_apresentacao_w
					and	a.dt_inicio_vigencia	<= dt_vigencia_bras_w
					and	a.cd_tiss		= cd_tiss_brasindice_w
					and (a.ie_tipo_preco = 'PMC')
					and (coalesce(a.vl_preco_final,a.vl_preco_medicamento) > 0)
					and	((ie_exige_lib_w	= 'N') or (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''));

					--Caso não encontrar, então busca por valores PFB
					if (coalesce(dt_vigencia_considerar_w::text, '') = '') then

						select	max(a.dt_inicio_vigencia),
							max(a.ie_tipo_preco)
						into STRICT	dt_vigencia_considerar_w,
							ie_tipo_preco_quando_pfm_w
						from	brasindice_preco a
						where	a.cd_laboratorio	= cd_laboratorio_w
						and	a.cd_medicamento	= cd_medicamento_w
						and	a.cd_apresentacao	= cd_apresentacao_w
						and	a.dt_inicio_vigencia	<= dt_vigencia_bras_w
						and	a.cd_tiss		= cd_tiss_brasindice_w
						and (a.ie_tipo_preco = 'PFB')
						and	((ie_exige_lib_w	= 'N') or (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''));

					end if;
				else
					select	max(a.dt_inicio_vigencia)
					into STRICT	dt_vigencia_max_w
					from	brasindice_preco a
					where	a.cd_laboratorio	= cd_laboratorio_w
					and	a.cd_medicamento	= cd_medicamento_w
					and	a.cd_apresentacao	= cd_apresentacao_w
					and	a.dt_inicio_vigencia	<= dt_vigencia_bras_w
					and	a.cd_tiss		= cd_tiss_brasindice_w
					and (coalesce(a.vl_preco_final,a.vl_preco_medicamento) > 0)
					and	((ie_exige_lib_w	= 'N') or (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''));

					--Prioriza valores PMC que não forem zerados
					select	max(a.dt_inicio_vigencia),
						max(a.ie_tipo_preco)
					into STRICT	dt_vigencia_considerar_w,
						ie_tipo_preco_quando_pfm_w
					from	brasindice_preco a
					where	a.cd_laboratorio	= cd_laboratorio_w
					and	a.cd_medicamento	= cd_medicamento_w
					and	a.cd_apresentacao	= cd_apresentacao_w
					and	a.dt_inicio_vigencia	= dt_vigencia_max_w
					and	a.cd_tiss		= cd_tiss_brasindice_w
					and (a.ie_tipo_preco = 'PMC')
					and (coalesce(a.vl_preco_final,a.vl_preco_medicamento) > 0)
					and	((ie_exige_lib_w	= 'N') or (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''));

					--Caso não encontrar, então busca por valores PFB
					if (coalesce(dt_vigencia_considerar_w::text, '') = '') then

						select	max(a.dt_inicio_vigencia),
							max(a.ie_tipo_preco)
						into STRICT	dt_vigencia_considerar_w,
							ie_tipo_preco_quando_pfm_w
						from	brasindice_preco a
						where	a.cd_laboratorio	= cd_laboratorio_w
						and	a.cd_medicamento	= cd_medicamento_w
						and	a.cd_apresentacao	= cd_apresentacao_w
						and	a.dt_inicio_vigencia	= dt_vigencia_max_w
						and	a.cd_tiss		= cd_tiss_brasindice_w
						and (a.ie_tipo_preco = 'PFB')
						and	((ie_exige_lib_w	= 'N') or (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''));

					end if;
				end if;
			--Se regra não for PFM, então busca apenas pela tabela específica. PFB se regra for PFB e PMC se regra for PMC.
			else

				select	max(a.dt_inicio_vigencia)
				into STRICT	dt_vigencia_considerar_w
				from	brasindice_preco a
				where	a.cd_laboratorio = cd_laboratorio_w
				and	a.cd_medicamento = cd_medicamento_w
				and	a.cd_apresentacao = cd_apresentacao_w
				and	a.cd_tiss	  = cd_tiss_brasindice_w
				and	a.dt_inicio_vigencia <= dt_vigencia_bras_w
				and (a.ie_tipo_preco = coalesce(ie_tipo_preco_regra_w,a.ie_tipo_preco))
				and	((ie_exige_lib_w = 'N') or (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''));
			end if;

			begin
				open C02;
				loop
				fetch C02 into
					vl_medicamento_w,
					ie_tipo_preco_w,
					dt_ult_vigencia_w,
					ie_preco_port_w,
					pr_ipi_w,
					ie_pis_cofins_w;
				EXIT WHEN NOT FOUND; /* apply on C02 */
				end loop;
				close C02;
			exception
			when others then
				ie_tipo_preco_w := '';
				vl_medicamento_w := 0;
			end;
	end;
end if;

if (ie_tipo_preco_w = 'PFB') then

	if (coalesce(ie_tipo_ajuste_pfb_p,'U') = 'U') and (tx_ajuste_pfb_w IS NOT NULL AND tx_ajuste_pfb_w::text <> '') then

		vl_medicamento_w := (vl_medicamento_w * tx_ajuste_pfb_w);

	elsif (coalesce(ie_tipo_ajuste_pfb_p,'U') = 'T') then

		if (ie_pis_cofins_w = 'S') then

			vl_medicamento_w := dividir_sem_round(vl_medicamento_w,vl_pfb_positiva_brasindice_p);

		elsif (ie_pis_cofins_w = 'N') then

			vl_medicamento_w := dividir_sem_round(vl_medicamento_w,vl_pfb_negativa_brasindice_p);
		else
			vl_medicamento_w := dividir_sem_round(vl_medicamento_w,vl_pfb_neutra_brasindice_p);
		end if;
	end if;
end if;

if (tx_pmc_neut_w IS NOT NULL AND tx_pmc_neut_w::text <> '') and (ie_tipo_preco_w = 'PMC') then

	if (ie_pis_cofins_w = 'S') then
		vl_medicamento_w	:= (vl_medicamento_w * tx_pmc_pos_w);
	elsif (ie_pis_cofins_w = 'N') then
		vl_medicamento_w	:= (vl_medicamento_w * tx_pmc_neg_w);
	else
		vl_medicamento_w	:= (vl_medicamento_w * tx_pmc_neut_w);
	end if;
end if;

if (qt_conversao_w = 0) then
	qt_conversao_w	:= 1;
end if;

if (vl_medicamento_w > 0) then
	vl_medicamento_w := vl_medicamento_w + (vl_medicamento_w * pr_ipi_w / 100);
	vl_medicamento_w := (vl_medicamento_w / qt_conversao_w);
end if;

vl_medicamento_p := vl_medicamento_w;
dt_ult_vigencia_p := dt_ult_vigencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_preco_brasindice ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, nr_seq_material_p pls_material.nr_sequencia%type, dt_vigencia_p timestamp, tx_ajuste_pfb_p bigint, tx_pmc_neut_p bigint, tx_pmc_neg_p bigint, tx_pmc_pos_p bigint, ie_tipo_preco_brasindice_p text, vl_medicamento_p INOUT bigint, dt_ult_vigencia_p INOUT timestamp, cd_tiss_p INOUT text, vl_pfb_neutra_brasindice_p bigint, vl_pfb_positiva_brasindice_p bigint, vl_pfb_negativa_brasindice_p bigint, ie_tipo_ajuste_pfb_p text, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

