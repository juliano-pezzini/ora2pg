-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE comunicar_resp_sensivel_os ( nr_ordem_servico_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_pessoa_fisica_w	usuario.cd_pessoa_fisica%type;
ds_historico_w		man_ordem_serv_tecnico.ds_relat_tecnico%type;
qt_existe_w		smallint;


BEGIN

select	count(1) --So incluir um novo registro caso nao exista nenhuma notificacao para a OS ou caso nao exista notificacao pendente.
into STRICT	qt_existe_w
from 	log_inf_sensivel_os
where	nr_ordem_servico = nr_ordem_servico_p
and	coalesce(dt_liberacao::text, '') = '';

if (qt_existe_w = 0) then
	begin
	ds_historico_w := substr(obter_desc_exp_idioma(1044834,coalesce(man_obter_idioma_os_local(nr_ordem_servico_p),5)),1,4000);
	
	insert into log_inf_sensivel_os(
				nr_sequencia,
				nm_usuario_solic,
				dt_solicitacao,
				nr_ordem_servico)
			values (nextval('log_inf_sensivel_os_seq'),
				nm_usuario_p,
				clock_timestamp(),
				nr_ordem_servico_p);

	insert into man_ordem_serv_tecnico(
				nr_sequencia,
				nr_seq_ordem_serv, 
				dt_atualizacao, 
				dt_historico, 
				dt_liberacao,
				nm_usuario, 
				nr_seq_tipo,
				ie_origem,
				ds_relat_tecnico) 
			values (nextval('man_ordem_serv_tecnico_seq'), 
				nr_ordem_servico_p, 
				clock_timestamp(),
				clock_timestamp(), 
				clock_timestamp(), 
				wheb_usuario_pck.get_nm_usuario,
				259, 
				'I',
				ds_historico_w);

	commit;

	begin
	select	cd_pessoa_fisica
	into STRICT	cd_pessoa_fisica_w
	from	usuario
	where 	nm_usuario = nm_usuario_p;

	CALL enviar_email('SO Identified with sensitive information. Go to Access Control > Internal Control > Sensitive information and check.', 'OS: ' || nr_ordem_servico_p,obter_email_usuario(cd_pessoa_fisica_w,nm_usuario_p,wheb_usuario_pck.get_cd_estabelecimento), 'privacy.emr@philips.com', nm_usuario_p, 'M', null );

	exception
	when others then
		null;
	end;

	end;
else
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1049733);
end if;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE comunicar_resp_sensivel_os ( nr_ordem_servico_p bigint, nm_usuario_p text) FROM PUBLIC;

