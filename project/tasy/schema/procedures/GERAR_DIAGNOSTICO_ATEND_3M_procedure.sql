-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_diagnostico_atend_3m ( nr_atendimento_p bigint, cd_doenca_p text, cd_medico_p text, nm_usuario_p text, ie_tipo_diagnostico_p bigint default 2, ie_classificacao_doenca_p text default 'S', cd_doenca_superior_p text default null, nr_cirurgia_p bigint default null, dt_liberacao_p timestamp default null, ie_status_diag_p text default null, dt_diagnostico_p INOUT timestamp DEFAULT NULL) AS $body$
DECLARE


qt_tempo_w          		bigint;
ie_tipo_doenca_w    	varchar(2);
ie_unidade_tempo_w  	varchar(2);
ie_nivel_atencao_w  	varchar(1);
nr_seq_episodio_w		episodio_paciente.nr_sequencia%type;
is_inpatient_w			varchar(1) := 'N';


BEGIN

ie_nivel_atencao_w := wheb_assist_pck.get_nivel_atencao_perfil;

select  	max(b.qt_tempo),
	max(b.ie_tipo_doenca),
	max(b.ie_unidade_tempo) 
into STRICT	qt_tempo_w,
	ie_tipo_doenca_w,
	ie_unidade_tempo_w
from	diagnostico_doenca   b
where	b.nr_atendimento 	= nr_atendimento_P
and	cd_doenca 	= cd_doenca_p;
	
select	max(dm.dt_diagnostico)
into STRICT	dt_diagnostico_p
from	diagnostico_medico dm
where	pkg_date_utils.start_of(dm.dt_diagnostico,'DD',0)	= pkg_date_utils.start_of(clock_timestamp(),'DD',0)
and	dm.nr_atendimento		= nr_atendimento_p
and	dm.cd_medico		= cd_medico_p;

if (obter_uso_case(nm_usuario_p) = 'S') then

	select 	max(nr_seq_episodio)
	into STRICT	nr_seq_episodio_w
	from 	atendimento_paciente
	where 	nr_atendimento = nr_atendimento_p;
	
	select	CASE WHEN obter_tipo_episodio(nr_seq_episodio_w)=1 THEN 'S'  ELSE 'N' END
	into STRICT	is_inpatient_w
	;

end if;
					
if (cd_doenca_superior_p IS NOT NULL AND cd_doenca_superior_p::text <> '') then
	select 	max(a.dt_diagnostico)
	into STRICT 	dt_diagnostico_p
	from 	diagnostico_doenca a
	where	a.cd_doenca 	= cd_doenca_superior_p
	and 	a.nr_atendimento 	= nr_atendimento_p;
else
	select 	CASE WHEN coalesce(dt_diagnostico_p::text, '') = '' THEN  clock_timestamp()  ELSE (dt_diagnostico_p + 1/86400) END
	into STRICT 	dt_diagnostico_p
	;
						
	insert into diagnostico_medico(
					nr_atendimento,
					dt_diagnostico,
					ie_tipo_diagnostico,
					cd_medico,
					dt_atualizacao,
					nm_usuario,
					ds_diagnostico,
					ie_nivel_atencao
	) values (	
					nr_atendimento_p,
					dt_diagnostico_p,
					coalesce(ie_tipo_diagnostico_p,2),
					cd_medico_p,
					clock_timestamp(),
					nm_usuario_p,
					null,
					ie_nivel_atencao_w);
end if;
	
if (cd_doenca_p IS NOT NULL AND cd_doenca_p::text <> '') then	
	insert into diagnostico_doenca(
				nr_atendimento,
				dt_diagnostico, 
				cd_doenca, 
				dt_atualizacao, 
				nm_usuario, 
				ds_diagnostico, 
				ie_classificacao_doenca,
				ie_tipo_diagnostico,
				dt_liberacao,
				ie_situacao,
				qt_tempo,
				ie_tipo_doenca,
				ie_unidade_tempo,
				ie_nivel_atencao,
				nr_cirurgia,
				cd_doenca_superior,
				ie_status_diag,
				ie_relevante_drg)
	SELECT	nr_atendimento_p,
		dt_diagnostico_p,
		cd_doenca_p,
		clock_timestamp(),
		nm_usuario_p,
		null,
		coalesce(ie_classificacao_doenca_p,'S'),
		coalesce(ie_tipo_diagnostico_p,2),
		dt_liberacao_p,
		'A',
		qt_tempo_w,
		ie_tipo_doenca_w,
		ie_unidade_tempo_w,
		ie_nivel_atencao_w,
		nr_cirurgia_p,
		cd_doenca_superior_p,
		ie_status_diag_p,
		is_inpatient_w
	
	where	not exists (	SELECT	1
			from	diagnostico_doenca c where	c.nr_atendimento	= nr_atendimento_p
			and	c.cd_doenca		= cd_doenca_p
			and	c.dt_diagnostico	= dt_diagnostico_p LIMIT 1);
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_diagnostico_atend_3m ( nr_atendimento_p bigint, cd_doenca_p text, cd_medico_p text, nm_usuario_p text, ie_tipo_diagnostico_p bigint default 2, ie_classificacao_doenca_p text default 'S', cd_doenca_superior_p text default null, nr_cirurgia_p bigint default null, dt_liberacao_p timestamp default null, ie_status_diag_p text default null, dt_diagnostico_p INOUT timestamp DEFAULT NULL) FROM PUBLIC;

