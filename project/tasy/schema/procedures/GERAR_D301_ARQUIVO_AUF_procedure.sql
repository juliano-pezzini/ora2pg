-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_d301_arquivo_auf (nr_seq_arquivo_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		d301_arquivo_auf.nr_sequencia%type;
d301_arquivo_auf_w	d301_arquivo_auf%rowtype;
ie_tipo_lote_w		d301_lote_envio.ie_tipo_lote%type;
cd_estabelecimento_w	d301_lote_envio.cd_estabelecimento%type;
cd_convenio_w		d301_lote_envio.cd_convenio%type;
cd_cgc_comunic_w	pessoa_juridica.cd_cgc%type;
nm_arquivo_w		d301_arquivo_envio.DS_NOME_ARQUIVO%type;
nr_ik_hospital_w	varchar(9);
nr_ik_comunic_w		varchar(9);
nr_ik_convenio_w	varchar(9);
dt_inicio_ref_w		timestamp;
ds_conteudo_w		varchar(4000);
ds_conteudo_aux_w	varchar(4000);
ds_complemento_w	varchar(4000);
qt_tamanho_w		bigint := 0;

	procedure concatena_valor(ds_valor_p	in text,
				ds_valor_out_p	out text) is
	;
BEGIN
	ds_conteudo_w 	:= ds_conteudo_w || ds_valor_p;	
	ds_valor_out_p	:= ds_valor_p;	
	end;
	
begin

select	max(a.ie_tipo_lote),
	max(a.cd_estabelecimento),
	max(coalesce(b.cd_convenio,a.cd_convenio)),
	max(a.dt_inicio_ref),
	max(b.DS_NOME_ARQUIVO)
into STRICT	ie_tipo_lote_w,
	cd_estabelecimento_w,
	cd_convenio_w,
	dt_inicio_ref_w,
	nm_arquivo_w
from	d301_lote_envio a,
	d301_arquivo_envio b
where	a.nr_sequencia	= b.nr_seq_lote_envio
and	b.nr_sequencia	= nr_seq_arquivo_p;

cd_cgc_comunic_w	:= OBTER_C301_PARAMETRO(cd_estabelecimento_w,cd_convenio_w,dt_inicio_ref_w,'CD_CGC_EMPRESA_COMUNIC');

select	substr(max(a.cd_cnes),1,9)
into STRICT	nr_ik_comunic_w
from	pessoa_juridica a
where	a.cd_cgc			= cd_cgc_comunic_w;

select	substr(max(a.cd_cnes),1,9)
into STRICT	nr_ik_convenio_w
from	pessoa_juridica a,
	convenio b
where	a.cd_cgc	= b.cd_cgc
and	b.cd_convenio	= cd_convenio_w;

select	substr(max(a.cd_cnes),1,9)
into STRICT	nr_ik_hospital_w
from	pessoa_juridica a,
	estabelecimento b
where	a.cd_cgc		= b.cd_cgc
and	b.cd_estabelecimento	= cd_estabelecimento_w;

select	coalesce(sum(octet_length(ds_conteudo)),0)
into STRICT	qt_tamanho_w
from	d301_arquivo_conteudo
where	nr_seq_arquivo_envio   = nr_seq_arquivo_p;

ds_conteudo_w	:= '';

select	nextval('d301_arquivo_auf_seq')
into STRICT	nr_sequencia_w
;

d301_arquivo_auf_w.nr_sequencia			:= nr_sequencia_w;		
d301_arquivo_auf_w.dt_atualizacao		:= clock_timestamp();
d301_arquivo_auf_w.nm_usuario			:= nm_usuario_p;
d301_arquivo_auf_w.dt_atualizacao_nrec		:= clock_timestamp();
d301_arquivo_auf_w.nm_usuario_nrec		:= nm_usuario_p;
d301_arquivo_auf_w.nr_seq_arquivo		:= nr_seq_arquivo_p;

concatena_valor('500000', d301_arquivo_auf_w.ds_identificador);
concatena_valor('01', d301_arquivo_auf_w.ds_versao);
concatena_valor('00000348', d301_arquivo_auf_w.qt_tam_arq_auf);
concatena_valor('000', d301_arquivo_auf_w.nr_serial_number);
concatena_valor(ie_tipo_lote_w||'0', d301_arquivo_auf_w.ds_tipo_dado);
concatena_valor('000',d301_arquivo_auf_w.nr_transacao);
concatena_valor('     ',d301_arquivo_auf_w.ds_ident_proc);
concatena_valor(rpad(coalesce(nr_ik_comunic_w,nr_ik_hospital_w),15,' '),d301_arquivo_auf_w.nr_ik_remetente_comunic);
concatena_valor(rpad(nr_ik_hospital_w,15,' '),d301_arquivo_auf_w.nr_ik_remetente_hosp);
concatena_valor(rpad(nr_ik_convenio_w,15,' '),d301_arquivo_auf_w.nr_ik_destinatario_comunic);
concatena_valor(rpad(nr_ik_convenio_w,15,' '),d301_arquivo_auf_w.nr_ik_destinatario_conv);
concatena_valor('000000',d301_arquivo_auf_w.cd_erro); --Inhalt: „00000,“
concatena_valor('000000',d301_arquivo_auf_w.cd_acao_erro); --Inhalt: „00000,“
concatena_valor(rpad(nm_arquivo_w,11,' '),d301_arquivo_auf_w.nm_arquivo);
concatena_valor(to_char(clock_timestamp(),'YYYYMMDDHH24MISS'),d301_arquivo_auf_w.ds_dt_criacao);
concatena_valor('00000000000000',d301_arquivo_auf_w.ds_dt_inicio_trans);
concatena_valor('00000000000000',d301_arquivo_auf_w.ds_dt_inicio_receb);
concatena_valor('00000000000000',d301_arquivo_auf_w.ds_dt_fim_receb);
concatena_valor('000000',d301_arquivo_auf_w.ds_versao_arq);
concatena_valor('0',d301_arquivo_auf_w.ie_arquivo_reenvio);
concatena_valor(lpad(qt_tamanho_w,12,'0'),d301_arquivo_auf_w.qt_tamanho_arq);
concatena_valor(lpad(qt_tamanho_w,12,'0'),d301_arquivo_auf_w.qt_tamanho_arq_cripto);
concatena_valor('I8',d301_arquivo_auf_w.ie_charset);
concatena_valor('00',d301_arquivo_auf_w.ie_compactacao);
concatena_valor('00',d301_arquivo_auf_w.ie_criptografia);
concatena_valor('00',d301_arquivo_auf_w.ie_assinatura);
concatena_valor('U  ',d301_arquivo_auf_w.ie_formato);
concatena_valor('00000',d301_arquivo_auf_w.qt_tamanho_format);
concatena_valor('00000000',d301_arquivo_auf_w.qt_tamanho_block);

--Complementovo padrão no fim do arquivo
ds_complemento_w	:= '00000000000000000000                                                                                                      '; -----------################
concatena_valor(ds_complemento_w,ds_conteudo_aux_w);

d301_arquivo_auf_w.ds_conteudo_auf	:= ds_conteudo_w;

insert into d301_arquivo_auf values (d301_arquivo_auf_w.*);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_d301_arquivo_auf (nr_seq_arquivo_p bigint, nm_usuario_p text) FROM PUBLIC;

