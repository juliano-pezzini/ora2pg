-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE send_device_integration (nr_sequencia_p bigint, nr_atendimento_p bigint, nr_seq_dispositivo_p text, ie_lado_p text, nr_seq_topografia_p bigint, dt_instalacao_p timestamp, dt_retirada_p timestamp, dt_atualizacao_p timestamp) AS $body$
DECLARE

										
visit_id_w 						atend_pac_dispositivo.nr_atendimento%type;
patient_id_w 					atendimento_paciente.cd_pessoa_fisica%type;
invasive_device_id_w			atend_pac_dispositivo.nr_sequencia%type;
invasive_device_code_w			atend_pac_dispositivo.nr_seq_dispositivo%type;
invasive_dev_laterality_code_w	atend_pac_dispositivo.ie_lado%type;
invasive_device_site_code_w		atend_pac_dispositivo.nr_seq_topografia%type;
placement_date_w				varchar(30);
removal_date_w					varchar(30);
updatetimestamp_w				varchar(30);
ie_excluir_w					varchar(1) := '0';
nm_user_w               		atend_pac_dispositivo.nm_usuario%type;
ds_integracao_w					text;
establishment_id_w   smallint;


BEGIN

if	((obter_setor(obter_setor_atual_paciente(nr_atendimento_p)) is not null) and (obter_se_integra_dispositivo('EPIMED', nr_seq_dispositivo_p) = 'S')) then

	select 	max(nr_atendimento_p) visit_id,
      obter_estabelecimento_setor(obter_setor_atual_paciente(max(nr_atendimento_p))) establishment_id,
			max(nr_sequencia_p) invasive_device_id,  
			max(nr_seq_dispositivo_p) invasive_device_code, 
			max(ie_lado_p) invasive_dev_laterality_code, 
			max(nr_seq_topografia_p) invasive_device_site_code,
			to_char(max(dt_instalacao_p), 'yyyymmddhh24miss') placement_date, 
			to_char(max(dt_retirada_p), 'yyyymmddhh24miss') removal_date,
			to_char(max(dt_atualizacao_p), 'yyyymmddhh24miss') updatetimestamp
	into STRICT 	visit_id_w,
      establishment_id_w,
			invasive_device_id_w,
			invasive_device_code_w,
			invasive_dev_laterality_code_w,
			invasive_device_site_code_w,
			placement_date_w,
			removal_date_w,
			updatetimestamp_w
	;
	
	nm_user_w := WHEB_USUARIO_PCK.GET_NM_USUARIO;
	patient_id_w := OBTER_PESSOA_ATENDIMENTO(nr_atendimento_p,'C');
	
	if (patient_id_w IS NOT NULL AND patient_id_w::text <> '') and (visit_id_w IS NOT NULL AND visit_id_w::text <> '') then
	

	
		SELECT BIFROST.SEND_INTEGRATION( 'patientinformation.device',
										'com.philips.tasy.integration.atepac.patientinformation.device.Device',
										'{ "patientId" : "' ||patient_id_w || '",'
										|| '"visitId" : "' ||visit_id_w || '",'
                    || '"establishmentId" : "'||establishment_id_w||'",'
										|| '"invasiveDeviceId" : "' ||invasive_device_id_w || '",'
										|| '"invasiveDeviceCode" : "' || invasive_device_code_w ||'",'
										|| '"invasiveDevLateralityCode" : "' || invasive_dev_laterality_code_w ||'" ,'
										|| '"invasiveDeviceSiteCode" : "' || invasive_device_site_code_w ||'" ,'
										|| '"placementDate" : "' || placement_date_w ||'" ,'
										|| '"removalDate" : "' || removal_date_w ||'" ,'
										|| '"updateTimeStamp" : "' || updatetimestamp_w ||'" ,'
										|| '"toDelete" : "' || ie_excluir_w ||'"'
										|| '}',
										nm_user_w)
			INTO STRICT DS_INTEGRACAO_W
			;
			
	end if;		
	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE send_device_integration (nr_sequencia_p bigint, nr_atendimento_p bigint, nr_seq_dispositivo_p text, ie_lado_p text, nr_seq_topografia_p bigint, dt_instalacao_p timestamp, dt_retirada_p timestamp, dt_atualizacao_p timestamp) FROM PUBLIC;

