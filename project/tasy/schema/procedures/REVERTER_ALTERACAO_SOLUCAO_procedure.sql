-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reverter_alteracao_solucao ( cd_estabelecimento_p bigint, nr_atendimento_p bigint, ie_tipo_solucao_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint, nr_seq_motivo_p bigint, dt_horario_p timestamp, nm_usuario_p text, nr_seq_reserva_p bigint, nr_seq_item_reserva_p bigint, nr_seq_prod_reserva_p bigint, nr_seq_assinatura_p bigint default null, ds_justificativa_p text default null, ie_solucao_separada_p text default null, ie_trocar_frasco_reversao_p text default 'N') AS $body$
DECLARE


nr_seq_evento_w			bigint;
ie_alteracao_w			smallint;
qt_volume_etapa_w		double precision;
nr_seq_esquema_w		bigint;
nr_seq_horario_w		bigint;
nr_seq_processo_w		bigint;
nr_etapa_evento_w		smallint;
ie_erro_w			varchar(1);
ie_reverte_aprazamento_w	varchar(1);
ie_status_item_w		varchar(15);
qt_min_rev_w			bigint;
dt_status_ant_w			timestamp;
nm_usuario_adm_w		prescr_solucao_evento.nm_usuario%type;
ie_param682_w			varchar(1);
dt_horario_w			timestamp;
cd_funcao_w			prescr_solucao_evento.cd_funcao%type;
nr_etapa_w				prescr_solucao_evento.nr_etapa_evento%type;			
ds_msg_w			varchar(255);
ie_param_718_w      varchar(1);
nr_prescricao_w     prescr_medica.nr_prescricao%type;
nr_seq_solucao_w    prescr_solucao.nr_seq_solucao%type;
dt_primeira_checagem_w	adep_processo.dt_primeira_checagem%type;
dt_adm_processo_w	adep_processo.dt_paciente%type;


BEGIN

ie_reverte_aprazamento_w := Obter_Param_Usuario(1113, 345, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_reverte_aprazamento_w);
qt_min_rev_w := obter_param_usuario(1113, 447, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, qt_min_rev_w);
ie_param682_w := obter_param_usuario(1113, 682, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_param682_w);
ie_param_718_w := obter_param_usuario(1113, 718, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_param_718_w);

if (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (ie_tipo_solucao_p IS NOT NULL AND ie_tipo_solucao_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_solucao_p IS NOT NULL AND nr_seq_solucao_p::text <> '') then
	begin
	if (ie_tipo_solucao_p = 1) then --solucao
		begin
        nr_prescricao_w     :=  nr_prescricao_p;
        nr_seq_solucao_w    :=  nr_seq_solucao_p;

        if (ie_param_718_w = 'N' or ie_solucao_separada_p = 'N') then

            select  nr_prescricao,
                    nr_seq_solucao
            into STRICT    nr_prescricao_w,            
                    nr_seq_solucao_w
            from    prescr_solucao_evento
            where   nr_sequencia = (    SELECT  max(nr_sequencia)
                                        from    prescr_solucao_evento
                                        where   nr_seq_cpoe =  obter_nr_seq_cpoe_sol(nr_prescricao_w, nr_seq_solucao_w)
                                        and	ie_evento_valido = 'S'
                                        and	((ie_alteracao < 6) or (ie_alteracao in (7,12,14,15,35,52)) or
							(ie_alteracao = 16 AND ie_reverte_aprazamento_w = 'S'))
                                    );
        end if;

		select	max(ie_status)
		into STRICT	ie_status_item_w
		from	prescr_solucao
		where	nr_prescricao	= nr_prescricao_w
		and		nr_seq_solucao	= nr_seq_solucao_w;

		if (ie_status_item_w = 'S') then
			--O item ja foi suspenso na prescricao, sendo assim, nao sera possivel reverter o ultimo evento!#@#@');
			CALL wheb_mensagem_pck.exibir_mensagem_abort(209792);
		end if;	

		/* obter ultimo evento */

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_evento_w
		from	prescr_solucao_evento
		where	nr_prescricao = nr_prescricao_w
		and	nr_seq_solucao = nr_seq_solucao_w
		and	ie_tipo_solucao = 1
		and	ie_evento_valido = 'S'
			and	((ie_alteracao < 6) or (ie_alteracao in (7,12,14,15,35,52)) or
			 (ie_alteracao = 16 AND ie_reverte_aprazamento_w = 'S'));

		if (nr_seq_evento_w > 0) then
			begin
			if (coalesce(qt_min_rev_w,0) > 0)  then
				Select	max(dt_alteracao)
				into STRICT	dt_status_ant_w
				from	prescr_solucao_evento
				where	nr_sequencia  = nr_seq_evento_w;

				if	(dt_status_ant_w < clock_timestamp() - (qt_min_rev_w/1440)) then
					/*O ultimo evento foi registrado fora'||
						' da margem de '|| qt_min_rev_w ||' minuto(s). '||
						'Nao eh possivel reverter! Parametro[447] #@#@');*/
					CALL Wheb_mensagem_pck.exibir_mensagem_abort(209793, 'QT_MIN_REV_W=' || qt_min_rev_w);
				end if;
			end if;

			/* obter se evento suspensao etapa */

			select	max(ie_alteracao),
					coalesce(max(nr_seq_esquema),0),
					max(nm_usuario),
					max(nr_etapa_evento)
			into STRICT	ie_alteracao_w,
					nr_seq_esquema_w,
					nm_usuario_adm_w,
					nr_etapa_evento_w
			from	prescr_solucao_evento
			where	nr_sequencia = nr_seq_evento_w;		

			if (ie_param682_w = 'N') and (ie_alteracao_w in (1,3)) and (nm_usuario_adm_w <> nm_usuario_p) then
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(452717);
			end if;

			/* atualizar evento */

			update	prescr_solucao_evento
			set		ie_evento_valido = 'N'
			where	nr_sequencia = nr_seq_evento_w;

			update	atendimento_perda_ganho
			set		dt_inativacao		= clock_timestamp(),
					nm_usuario_inativacao	= nm_usuario_p,
					ie_situacao		= 'I'
			where	nr_seq_evento_adep	= nr_seq_evento_w;
			
			if (coalesce(nr_etapa_evento_w::text, '') = '') then
				nr_etapa_evento_w := obter_etapa_atual(nr_prescricao_w, nr_seq_solucao_w);
			end if;
			
			/* gerar evento reversao */

			if (ie_alteracao_w <> 16) then
				begin
				ds_msg_w := gerar_alteracao_solucao_prescr(cd_estabelecimento_p, nr_atendimento_p, 1, nr_prescricao_w, nr_seq_solucao_w, 6, null, null, null, null, null, null, null, null, null, nr_seq_motivo_p, null, nm_usuario_p, nr_etapa_evento_w, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, nr_seq_assinatura_p, null, ds_justificativa_p, null, null, ds_msg_w, null, null, null, ie_trocar_frasco_reversao_p);
				SELECT	max(nr_seq_processo)
				INTO STRICT	nr_seq_processo_w
				FROM	Prescr_mat_hor
				WHERE nr_prescricao	= nr_prescricao_w
				and	nr_seq_solucao	= nr_seq_solucao_w
				and	obter_status_processo_adep(nr_seq_processo) = 'A'
				and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

				SELECT	max(nr_sequencia)
				INTO STRICT	nr_seq_horario_w
				FROM	Prescr_mat_hor
				WHERE	--dt_horario	= dt_horario_p
					nr_prescricao	= nr_prescricao_w
				and	nr_seq_solucao	= nr_seq_solucao_w
				and	obter_status_processo_adep(nr_seq_processo) = 'A'
				and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

				IF ((nr_seq_processo_w IS NOT NULL AND nr_seq_processo_w::text <> '') and ie_alteracao_w <> 2) THEN
					CALL Reverter_processo_horario(nr_seq_horario_w,
								nr_seq_processo_w,
								nm_usuario_p);
				END IF;

				end;
			end if;

			if (ie_alteracao_w in (1,3)) then			
				CALL reverter_lote_fornec_adm_sol(nr_prescricao_w, nr_seq_solucao_w, nr_etapa_evento_w, nr_seq_evento_w, nm_usuario_p);							
			end if;

			/* atualizar valores suspensos */

			if (ie_alteracao_w in (12,15)) then
				begin
				/* obter volume etapa */

				if (nr_seq_esquema_w > 0) then
					begin
					select	coalesce(max(qt_volume),0)
					into STRICT	qt_volume_etapa_w
					from	prescr_solucao_esquema
					where	nr_sequencia = nr_seq_esquema_w;
					end;
				else
					begin
					select	coalesce(max(qt_volume),0)
					into STRICT	qt_volume_etapa_w
					from	prescr_solucao
					where	nr_prescricao = nr_prescricao_w
					and	nr_seq_solucao = nr_seq_solucao_w;
					end;
				end if;

				if (qt_volume_etapa_w > 0) then
					begin
					CALL atualizar_valor_susp_solucao(ie_tipo_solucao_p, nr_prescricao_w, nr_seq_solucao_w, qt_volume_etapa_w, 'N', nm_usuario_p);
					CALL atualizar_status_etapa_sol_pmh(nr_prescricao_w, nr_seq_solucao_w, nr_etapa_evento_w, nm_usuario_p);
					ie_erro_w := atualizar_disp_solucao_susp(nr_prescricao_w, nr_seq_solucao_w, nr_etapa_evento_w, 6, nm_usuario_p, ie_erro_w);
					end;
				end if;
				end;
			elsif (ie_alteracao_w = 16) then
				begin
				CALL reverter_aprazamento_sol_proc(nr_prescricao_w, nr_seq_solucao_w, nr_etapa_evento_w, nm_usuario_p);
				ds_msg_w := gerar_alteracao_solucao_prescr(cd_estabelecimento_p, nr_atendimento_p, 1, nr_prescricao_w, nr_seq_solucao_w, 6, null, null, null, null, null, null, null, null, null, nr_seq_motivo_p, null, nm_usuario_p, nr_etapa_evento_w, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, nr_seq_assinatura_p, null, ds_justificativa_p, null, null, ds_msg_w);
				end;
			end if;
			end;
		end if;
		end;
	elsif (ie_tipo_solucao_p = 2) then --suporte nutricional enteral
		begin

		select	max(ie_status)
		into STRICT	ie_status_item_w
		from	prescr_material
		where	nr_prescricao 	= nr_prescricao_p
		and	nr_sequencia	= nr_seq_solucao_p;

		if (ie_status_item_w = 'S') then
			--O item ja foi suspenso na prescricao, sendo assim, nao sera possivel reverter o ultimo evento!#@#@');
			CALL wheb_mensagem_pck.exibir_mensagem_abort(209792);
		end if;			

		/* obter ultimo evento */

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_evento_w
		from	prescr_solucao_evento
		where	nr_prescricao = nr_prescricao_p
		and	nr_seq_material = nr_seq_solucao_p
		and	ie_tipo_solucao = 2
		and	ie_evento_valido = 'S'
		and	((ie_alteracao < 6) or (ie_alteracao in (7,12,14,15,35)) or
			 (ie_alteracao = 16 AND ie_reverte_aprazamento_w = 'S'));
		--and	ie_alteracao <= 7;
		select	max(ie_alteracao),
				max(nm_usuario),
				max(nr_etapa_evento)
		into STRICT	ie_alteracao_w,
				nm_usuario_adm_w,
				nr_etapa_w
		from	prescr_solucao_evento
		where	nr_sequencia = nr_seq_evento_w;		

		if (ie_param682_w = 'N') and (ie_alteracao_w in (1,3)) and (nm_usuario_adm_w <> nm_usuario_p) then
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(452717);
		end if;		



		if (nr_seq_evento_w > 0) then
			begin

			if (ie_alteracao_w in (1,3)) then	
				select	max(dt_horario)
				into STRICT	dt_horario_w
				from	prescr_mat_hor
				where	nr_prescricao = nr_prescricao_p
				and		nr_seq_material = nr_seq_solucao_p
				and		nr_etapa_sol = nr_etapa_w
				and		ie_agrupador = 8;

				CALL reverter_lote_fornec_adm(0, nr_prescricao_p, nr_seq_solucao_p, dt_horario_w, nm_usuario_p, 'SNE');				
			end if;

			/* atualizar evento */

			update	prescr_solucao_evento
			set		ie_evento_valido = 'N'
			where	nr_sequencia = nr_seq_evento_w;

			/* gerar evento reversao */

			ds_msg_w := gerar_alteracao_solucao_prescr(cd_estabelecimento_p, nr_atendimento_p, 2, nr_prescricao_p, nr_seq_solucao_p, 6, null, null, null, null, null, null, null, null, null, nr_seq_motivo_p, null, nm_usuario_p, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, nr_seq_assinatura_p, null, ds_justificativa_p, null, null, ds_msg_w, null, null, null, ie_trocar_frasco_reversao_p);
			end;
		end if;
		end;
	elsif (ie_tipo_solucao_p 	= 3) and (coalesce(nr_seq_reserva_p,0) > 0) and
		((coalesce(nr_seq_item_reserva_p,0) > 0) or (coalesce(nr_seq_prod_reserva_p,0) > 0)) then --hemocomponente
		begin
		/* obter ultimo evento */

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_evento_w
		from	prescr_solucao_evento
		where	nr_seq_reserva	= nr_seq_reserva_p
		and	((nr_seq_item_reserva = nr_seq_item_reserva_p) or (nr_seq_prod_reserva = nr_seq_prod_reserva_p))
		and	ie_tipo_solucao = 3
		and	ie_evento_valido = 'S'
		and	ie_alteracao <> 6
		and	((ie_alteracao <= 7) or (ie_alteracao = 12) or (ie_alteracao = 53));
		if (nr_seq_evento_w > 0) then
			begin

			select	max(ie_alteracao),
					max(nm_usuario)
			into STRICT	ie_alteracao_w,
					nm_usuario_adm_w
			from	prescr_solucao_evento
			where	nr_sequencia = nr_seq_evento_w;		

			if (ie_param682_w = 'N') and (ie_alteracao_w in (1,3)) and (nm_usuario_adm_w <> nm_usuario_p) then
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(452717);
			end if;

			/* atualizar evento */

			update	prescr_solucao_evento
			set	ie_evento_valido = 'N'
			where	nr_sequencia = nr_seq_evento_w;
			commit;

			/* gerar evento reversao */

			ds_msg_w := gerar_alteracao_solucao_prescr(cd_estabelecimento_p, nr_atendimento_p, 3, null, null, 6, null, null, null, null, null, null, null, null, null, nr_seq_motivo_p, null, nm_usuario_p, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, nr_seq_reserva_p, nr_seq_item_reserva_p, nr_seq_prod_reserva_p, null, null, nr_seq_assinatura_p, null, ds_justificativa_p, null, null, ds_msg_w);

			/* obter se evento suspensao etapa */

			select	ie_alteracao
			into STRICT	ie_alteracao_w
			from	prescr_solucao_evento
			where	nr_sequencia = nr_seq_evento_w;

			end;
		end if;
		end;				
	elsif (ie_tipo_solucao_p 	= 3) then --hemocomponente
		begin

		select	max(ie_status)
		into STRICT	ie_status_item_w
		from	prescr_procedimento
		where	nr_prescricao 	= nr_prescricao_p
		and	nr_sequencia	= nr_seq_solucao_p;

		if (ie_status_item_w = 'S') then
			--O item ja foi suspenso na prescricao, sendo assim, nao sera possivel reverter o ultimo evento!#@#@');
			CALL wheb_mensagem_pck.exibir_mensagem_abort(209792);
		end if;					

		/* obter ultimo evento */

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_evento_w
		from	prescr_solucao_evento
		where	nr_prescricao = nr_prescricao_p
		and	nr_seq_procedimento = nr_seq_solucao_p
		and	ie_tipo_solucao = 3
		and	ie_evento_valido = 'S'
		and	ie_alteracao <> 6
		and	((ie_alteracao <= 7) or (ie_alteracao = 12) or (ie_alteracao = 37));

		if (nr_seq_evento_w > 0) then
			begin

			select	max(ie_alteracao),
					max(nm_usuario),
					max(cd_funcao)
			into STRICT	ie_alteracao_w,
					nm_usuario_adm_w,
					cd_funcao_w
			from	prescr_solucao_evento
			where	nr_sequencia = nr_seq_evento_w;		

			if (ie_param682_w = 'N') and (ie_alteracao_w in (1,3)) and (nm_usuario_adm_w <> nm_usuario_p) then
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(452717);
			end if;

			/* gerar evento reversao */

			ds_msg_w := gerar_alteracao_solucao_prescr(cd_estabelecimento_p, nr_atendimento_p, 3, nr_prescricao_p, nr_seq_solucao_p, 6, null, null, null, null, null, null, null, null, null, nr_seq_motivo_p, null, nm_usuario_p, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, nr_seq_assinatura_p, null, ds_justificativa_p, null, null, ds_msg_w);

			/* atualizar evento */

		/*	update	prescr_solucao_evento
			set	ie_evento_valido = 'N'
			where	nr_sequencia = nr_seq_evento_w;
			commit			*/
			if (ie_alteracao_w = 1) then

				update	prescr_proc_bolsa
				set		ie_bipado = 'N'
				where	nr_prescricao = nr_prescricao_p		
				and		nr_seq_procedimento = nr_seq_solucao_p;				

			end if;

			/* obter se evento suspensao etapa */

			select	ie_alteracao,
				nr_etapa_evento
			into STRICT	ie_alteracao_w,
				nr_etapa_evento_w
			from	prescr_solucao_evento
			where	nr_sequencia = nr_seq_evento_w;


			/* atualizar valores suspensos */

			if (ie_alteracao_w = 12) then
				begin
				/* obter volume etapa */

				select	coalesce(max(dividir(qt_vol_hemocomp,qt_procedimento)),0)
				into STRICT	qt_volume_etapa_w
				from	prescr_procedimento
				where	nr_prescricao = nr_prescricao_p
				and	nr_sequencia = nr_seq_solucao_p
				and	(nr_seq_solic_sangue IS NOT NULL AND nr_seq_solic_sangue::text <> '')
				and	(nr_seq_derivado IS NOT NULL AND nr_seq_derivado::text <> '');

				if (qt_volume_etapa_w = 0) then
					select	coalesce(max(dividir(qt_volume_suspenso,nr_etapas_suspensa)),0)					
					into STRICT	qt_volume_etapa_w
					from	prescr_procedimento
					where	nr_prescricao	= nr_prescricao_p
					and		nr_sequencia = nr_seq_solucao_p
					and		coalesce(qt_volume_suspenso,0) > 0;
				end if;	

				if (qt_volume_etapa_w > 0) then
					begin
					CALL atualizar_valor_susp_solucao(ie_tipo_solucao_p, nr_prescricao_p, nr_seq_solucao_p, qt_volume_etapa_w, 'N', nm_usuario_p);
					end;
				end if;
				end;

			end if;
			end;
		end if;
		end;
	elsif (ie_tipo_solucao_p = 4) then --npt adulto
		begin

		select	max(ie_status)
		into STRICT	ie_status_item_w
		from	nut_paciente
		where	nr_prescricao 	= nr_prescricao_p
		and		nr_sequencia	= nr_seq_solucao_p;

		if (ie_status_item_w = 'S') then
			--O item ja foi suspenso na prescricao, sendo assim, nao sera possivel reverter o ultimo evento!#@#@');
			CALL wheb_mensagem_pck.exibir_mensagem_abort(209792);
		end if;					

		/* obter ultimo evento */

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_evento_w
		from	prescr_solucao_evento
		where	nr_prescricao = nr_prescricao_p
		and	nr_seq_nut = nr_seq_solucao_p
		and	ie_tipo_solucao = 4
		and	ie_evento_valido = 'S'
		and	ie_alteracao < 6;

		if (nr_seq_evento_w > 0) then
			begin

			select	max(ie_alteracao),
					max(nm_usuario)
			into STRICT	ie_alteracao_w,
					nm_usuario_adm_w
			from	prescr_solucao_evento
			where	nr_sequencia = nr_seq_evento_w;		

			if (ie_param682_w = 'N') and (ie_alteracao_w in (1,3)) and (nm_usuario_adm_w <> nm_usuario_p) then
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(452717);
			end if;


			/* atualizar evento */

			update	prescr_solucao_evento
			set	ie_evento_valido = 'N'
			where	nr_sequencia = nr_seq_evento_w;

			/* gerar evento reversao */

			ds_msg_w := gerar_alteracao_solucao_prescr(cd_estabelecimento_p, nr_atendimento_p, 4, nr_prescricao_p, nr_seq_solucao_p, 6, null, null, null, null, null, null, null, null, null, nr_seq_motivo_p, null, nm_usuario_p, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, nr_seq_assinatura_p, null, ds_justificativa_p, null, null, ds_msg_w);
			end;
		end if;
		end;
	elsif (ie_tipo_solucao_p = 5) then --npt neo
		begin

		select	max(ie_status)
		into STRICT	ie_status_item_w
		from	nut_pac
		where	nr_prescricao 	= nr_prescricao_p
		and	nr_sequencia	= nr_seq_solucao_p;

		if (ie_status_item_w = 'S') then
			--O item ja foi suspenso na prescricao, sendo assim, nao sera possivel reverter o ultimo evento!#@#@');
			CALL wheb_mensagem_pck.exibir_mensagem_abort(209792);
		end if;					

		/* obter ultimo evento */

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_evento_w
		from	prescr_solucao_evento
		where	nr_prescricao = nr_prescricao_p
		and	nr_seq_nut_neo = nr_seq_solucao_p
		and	ie_tipo_solucao = 5
		and	ie_evento_valido = 'S'
		and	ie_alteracao < 6;

		if (nr_seq_evento_w > 0) then
			begin

			select	max(ie_alteracao),
					max(nm_usuario)
			into STRICT	ie_alteracao_w,
					nm_usuario_adm_w
			from	prescr_solucao_evento
			where	nr_sequencia = nr_seq_evento_w;		

			if (ie_param682_w = 'N') and (ie_alteracao_w in (1,3)) and (nm_usuario_adm_w <> nm_usuario_p) then
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(452717);
			end if;

			/* atualizar evento */

			update	prescr_solucao_evento
			set	ie_evento_valido = 'N'
			where	nr_sequencia = nr_seq_evento_w;

			/* gerar evento reversao */

			ds_msg_w := gerar_alteracao_solucao_prescr(cd_estabelecimento_p, nr_atendimento_p, 5, nr_prescricao_p, nr_seq_solucao_p, 6, null, null, null, null, null, null, null, null, null, nr_seq_motivo_p, null, nm_usuario_p, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, nr_seq_assinatura_p, null, ds_justificativa_p, null, null, ds_msg_w);
			end;
		end if;
		end;
	elsif (ie_tipo_solucao_p = 6) then --npt Adulta 2
		begin

		select	max(ie_status)
		into STRICT	ie_status_item_w
		from	nut_pac
		where	nr_prescricao 	= nr_prescricao_p
		and	nr_sequencia	= nr_seq_solucao_p;

		if (ie_status_item_w = 'S') then
			--O item ja foi suspenso na prescricao, sendo assim, nao sera possivel reverter o ultimo evento!#@#@');
			CALL wheb_mensagem_pck.exibir_mensagem_abort(209792);
		end if;					

		/* obter ultimo evento */

		select	coalesce(max(nr_sequencia),0),
				max(dt_horario)
		into STRICT	nr_seq_evento_w,
				dt_horario_w
		from	prescr_solucao_evento
		where	nr_prescricao = nr_prescricao_p
		and	nr_seq_nut_neo = nr_seq_solucao_p
		and	ie_tipo_solucao = 6
		and	ie_evento_valido = 'S'
		and	ie_alteracao < 6;

		if (nr_seq_evento_w > 0) then
			begin

			select	max(ie_alteracao),
					max(nm_usuario)
			into STRICT	ie_alteracao_w,
					nm_usuario_adm_w
			from	prescr_solucao_evento
			where	nr_sequencia = nr_seq_evento_w;		

			if (ie_param682_w = 'N') and (ie_alteracao_w in (1,3)) and (nm_usuario_adm_w <> nm_usuario_p) then
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(452717);
			end if;

			/* atualizar evento */

			update	prescr_solucao_evento
			set	ie_evento_valido = 'N'
			where	nr_sequencia = nr_seq_evento_w;

			/* gerar evento reversao */

			ds_msg_w := gerar_alteracao_solucao_prescr(cd_estabelecimento_p, nr_atendimento_p, 6, nr_prescricao_p, nr_seq_solucao_p, 6, null, null, null, null, null, null, null, null, null, nr_seq_motivo_p, null, nm_usuario_p, null, dt_horario_w, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, nr_seq_assinatura_p, null, ds_justificativa_p, null, null, ds_msg_w);
			end;
		end if;
		end;
	elsif (ie_tipo_solucao_p = 7) then --npt pediatrica
		begin

		select	max(ie_status)
		into STRICT	ie_status_item_w
		from	nut_pac
		where	nr_prescricao 	= nr_prescricao_p
		and	nr_sequencia	= nr_seq_solucao_p;

		if (ie_status_item_w = 'S') then
			--O item ja foi suspenso na prescricao, sendo assim, nao sera possivel reverter o ultimo evento!#@#@');
			CALL wheb_mensagem_pck.exibir_mensagem_abort(209792);
		end if;					

		/* obter ultimo evento */

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_evento_w
		from	prescr_solucao_evento
		where	nr_prescricao = nr_prescricao_p
		and	nr_seq_nut_neo = nr_seq_solucao_p
		and	ie_tipo_solucao = 7
		and	ie_evento_valido = 'S'
		and	ie_alteracao < 6;

		if (nr_seq_evento_w > 0) then
			begin

			select	max(ie_alteracao),
					max(nm_usuario)
			into STRICT	ie_alteracao_w,
					nm_usuario_adm_w
			from	prescr_solucao_evento
			where	nr_sequencia = nr_seq_evento_w;		

			if (ie_param682_w = 'N') and (ie_alteracao_w in (1,3)) and (nm_usuario_adm_w <> nm_usuario_p) then
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(452717);
			end if;

			/* atualizar evento */

			update	prescr_solucao_evento
			set	ie_evento_valido = 'N'
			where	nr_sequencia = nr_seq_evento_w;

			/* gerar evento reversao */

			ds_msg_w := gerar_alteracao_solucao_prescr(cd_estabelecimento_p, nr_atendimento_p, 7, nr_prescricao_p, nr_seq_solucao_p, 6, null, null, null, null, null, null, null, null, null, nr_seq_motivo_p, null, nm_usuario_p, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, nr_seq_assinatura_p, null, ds_justificativa_p, null, null, ds_msg_w);
			end;
		end if;
		end;
	elsif (ie_tipo_solucao_p = 8) then -- dialise
		begin
		
		select 	max(ie_status)
		into STRICT	ie_status_item_w
		from 	hd_prescricao
		where 	nr_prescricao 	= nr_prescricao_p
		and 	nr_sequencia 	= nr_seq_solucao_p;

		if (ie_status_item_w = 'S') then
			--O item ja foi suspenso na prescricao, sendo assim, nao sera possivel reverter o ultimo evento!#@#@');
			CALL wheb_mensagem_pck.exibir_mensagem_abort(209792);
		end if;					

		/* obter ultimo evento */

		select 	coalesce(max(nr_sequencia), 0),
				max(nr_etapa_evento)
		into STRICT 	nr_seq_evento_w,
				nr_etapa_evento_w
		from 	hd_prescricao_evento
		where 	nr_prescricao 	 = nr_prescricao_p
		and 	nr_seq_solucao   = nr_seq_solucao_p
		and 	ie_evento in ('II', 'IT', 'DI', 'DT')
		and		coalesce(ie_evento_valido, 'S') = 'S';
		
		select	max(a.nr_seq_processo)
		into STRICT	nr_seq_processo_w
		from	prescr_mat_hor a
		where 	nr_prescricao 	= nr_prescricao_p
		and 	nr_seq_solucao 	= nr_seq_solucao_p
		and		nr_etapa_sol	= nr_etapa_evento_w;
		
		if (nr_seq_processo_w IS NOT NULL AND nr_seq_processo_w::text <> '') then
			CALL atualiza_status_processo_adep(nr_seq_processo_w, null, 'A', 'RA', clock_timestamp(), nm_usuario_p);
			
			update	prescr_mat_hor
			set		dt_inicio_horario  = NULL
			where 	nr_prescricao 	= nr_prescricao_p
			and 	nr_seq_solucao 	= nr_seq_solucao_p
			and		nr_etapa_sol	= nr_etapa_evento_w;
		end if;
		
		/* atualizar evento */

		update 	hd_prescricao_evento
		set 	ie_evento_valido = 'N'
		where 	nr_sequencia 	 = nr_seq_evento_w;

		/* obter ultimo evento */

		select 	coalesce(max(nr_sequencia), 0)
		into STRICT 	nr_seq_evento_w
		from 	hd_prescricao_evento
		where 	nr_prescricao 	 = nr_prescricao_p
		and 	nr_seq_solucao   = nr_seq_solucao_p
		and 	ie_evento in ('II', 'IT', 'DI', 'DT')
		and		coalesce(ie_evento_valido, 'S') = 'S';

		/* obter status solucao */

		select	coalesce(max(ie_evento), 'N')
		into STRICT	ie_status_item_w
		from	hd_prescricao_evento
		where	nr_sequencia = nr_seq_evento_w;

		/* atualizar status */

		update 	prescr_solucao
		set 	ie_status = ie_status_item_w
		where	nr_prescricao  = nr_prescricao_p
		and 	nr_seq_solucao = nr_seq_solucao_p;

		/* gerar evento reversao */

		SELECT	nextval('hd_prescricao_evento_seq')
		INTO STRICT	nr_seq_evento_w
		;

		INSERT INTO hd_prescricao_evento(
			nr_sequencia,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_atualizacao,
			nm_usuario,
			nr_prescricao,
			nr_seq_solucao,
			ie_evento,
			dt_evento,
			cd_pessoa_evento,
			ie_evento_valido)
		VALUES (
			nr_seq_evento_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_prescricao_p,
			nr_seq_solucao_p,
			'R',
			clock_timestamp(),
			SUBSTR(obter_dados_usuario_opcao(nm_usuario_p,'C'),1,10),
			'S');
		end;
	end if;
	end;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reverter_alteracao_solucao ( cd_estabelecimento_p bigint, nr_atendimento_p bigint, ie_tipo_solucao_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint, nr_seq_motivo_p bigint, dt_horario_p timestamp, nm_usuario_p text, nr_seq_reserva_p bigint, nr_seq_item_reserva_p bigint, nr_seq_prod_reserva_p bigint, nr_seq_assinatura_p bigint default null, ds_justificativa_p text default null, ie_solucao_separada_p text default null, ie_trocar_frasco_reversao_p text default 'N') FROM PUBLIC;

