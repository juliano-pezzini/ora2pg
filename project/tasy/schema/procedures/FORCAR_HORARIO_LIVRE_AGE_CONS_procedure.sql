-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE forcar_horario_livre_age_cons ( dt_agenda_forc_p timestamp, cd_agenda_p bigint, nr_minuto_duracao_p bigint, nm_paciente_p text, hr_agenda_forc_p timestamp, ie_classif_agenda_p text) AS $body$
DECLARE

nr_seq_hora_w	bigint;
hr_agenda_forc_w	varchar(5);
dt_forcado_w		timestamp;


BEGIN
if (cd_agenda_p IS NOT NULL AND cd_agenda_p::text <> '') then
	begin
	
	hr_agenda_forc_w := PKG_DATE_FORMATERS.to_varchar(hr_agenda_forc_p, 'hh24:mi',null);
	dt_forcado_w	:= obter_hor_forcado_agecons(dt_agenda_forc_p, hr_agenda_forc_w, cd_agenda_p);
	
	select	coalesce(max(nr_seq_hora),0)+1
	into STRICT	nr_seq_hora_w
	from	agenda_consulta
	where	cd_agenda = cd_agenda_p
	and dt_agenda between PKG_DATE_UTILS.start_of(dt_agenda_forc_p,'dd') and PKG_DATE_UTILS.end_of(dt_agenda_forc_p,'DAY')
	and	PKG_DATE_UTILS.start_of(dt_agenda,'mi') = PKG_DATE_UTILS.start_of(dt_forcado_w,'mi');
	
	insert into agenda_consulta(
		nr_sequencia,
		ie_status_agenda,
		cd_agenda,
		ie_necessita_contato,
		cd_turno,
		nr_seq_hora,
		dt_agenda,
		ie_horario_forcado,
		dt_horario_forcado,
		nr_minuto_duracao,
		nm_paciente,
		ie_classif_agenda,		
		nm_usuario_horario,
		dt_atualizacao,
		nm_usuario)
	values (nextval('agenda_consulta_seq'),
		'LF',
		cd_agenda_p,
		'N',
		obter_turno_horario_agenda(cd_agenda_p, hr_agenda_forc_w),
		nr_seq_hora_w,
		obter_hor_forcado_agecons(dt_agenda_forc_p, hr_agenda_forc_w, cd_agenda_p),
		'S',
		clock_timestamp(),
		coalesce(nr_minuto_duracao_p, 0),
		nm_paciente_p,
		ie_classif_agenda_p,
		wheb_usuario_pck.get_nm_usuario,
		clock_timestamp(),
		wheb_usuario_pck.get_nm_usuario);
		
	end;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE forcar_horario_livre_age_cons ( dt_agenda_forc_p timestamp, cd_agenda_p bigint, nr_minuto_duracao_p bigint, nm_paciente_p text, hr_agenda_forc_p timestamp, ie_classif_agenda_p text) FROM PUBLIC;

