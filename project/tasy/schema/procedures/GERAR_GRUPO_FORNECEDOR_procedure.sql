-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_grupo_fornecedor ( nr_cot_compra_p bigint, nm_usuario_p text, nr_seq_regra_p bigint) AS $body$
DECLARE

 
 
cd_estabelecimento_w			smallint;
cd_moeda_w				integer;
cd_cond_pagto_w				bigint;
qt_dia_prazo_entrega_w			smallint;
nr_sequencia_w				bigint;
cd_cnpj_w				varchar(14);
nr_seq_pj_regra_w			bigint;

 
C01 CURSOR FOR 
	SELECT nr_sequencia, 
		cd_cnpj 
	from 	grupo_pj_compras_fornec 
	where	nr_seq_grupo = nr_seq_regra_p;


BEGIN 
 
open C01;
loop 
fetch C01 into	 
	nr_seq_pj_regra_w, 
	cd_cnpj_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	select	cd_estabelecimento 
	into STRICT	cd_estabelecimento_w 
	from	cot_compra 
	where	nr_cot_compra = nr_cot_compra_p;
 
	select	cd_moeda_padrao, 
		cd_condicao_pagamento_padrao 
	into STRICT	cd_moeda_w, 
		cd_cond_pagto_w 
	from	parametro_compras 
	where	cd_estabelecimento	= cd_estabelecimento_w;	
		 
	select	coalesce(cd_cond_pagto,cd_cond_pagto_w), 
		coalesce(qt_dia_prazo_entrega,0) 
	into STRICT	cd_cond_pagto_w, 
		qt_dia_prazo_entrega_w 
	from	pessoa_juridica_estab 
	where	cd_cgc = cd_cnpj_w 
	and	cd_estabelecimento = cd_estabelecimento_w;	
 
	select	nextval('cot_compra_forn_seq') 
	into STRICT	nr_sequencia_w 
	;
		 
	insert	into cot_compra_forn( 
		nr_sequencia, 
		nr_cot_compra, 
		cd_cgc_fornecedor, 
		dt_atualizacao, 
		nm_usuario, 
		cd_moeda, 
		cd_condicao_pagamento, 
		qt_dias_entrega, 
		vl_desconto, 
		ie_frete, 
		ie_gerado_bionexo) 
	values (	nr_sequencia_w, 
		nr_cot_compra_p, 
		cd_cnpj_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_moeda_w, 
		cd_cond_pagto_w, 
		qt_dia_prazo_entrega_w, 
		0, 
		'C', 
		'N');	
		end;
		 
		 
	CALL gerar_fornec_cot_compra_grupo(nr_cot_compra_p, nr_sequencia_w, nr_seq_pj_regra_w, nm_usuario_p);
 
 
end loop;
close C01;
 
if (coalesce(cd_cond_pagto_w::text, '') = '') then 
	--Não encontrado nenhuma condição de pagamento.' 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(222381);
end if;
 
if (coalesce(cd_moeda_w::text, '') = '') then 
	--Falta selecionar uma moeda padrão nos parâmetros de compras. 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(222382);
end if;	
	 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_grupo_fornecedor ( nr_cot_compra_p bigint, nm_usuario_p text, nr_seq_regra_p bigint) FROM PUBLIC;

