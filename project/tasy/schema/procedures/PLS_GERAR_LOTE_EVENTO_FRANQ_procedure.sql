-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_lote_evento_franq ( nr_seq_franq_pag_p pls_franq_pag.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_seq_lote_evento_w	pls_lote_evento.nr_sequencia%type;
dt_referencia_w		pls_franq_pag.dt_referencia%type;
cd_estabelecimento_w	pls_franq_pag.cd_estabelecimento%type;
nr_seq_regra_w		pls_franq_pag_prest.nr_seq_regra%type;
nr_seq_competencia_w	pls_competencia.nr_sequencia%type;
nr_seq_evento_movto_w	pls_evento_movimento.nr_sequencia%type;

c01 CURSOR(nr_seq_franq_pag_w		pls_franq_pag_prest.nr_seq_franq_pag%type) FOR
SELECT	a.vl_ajuste,
	b.nr_seq_evento_cred,
	b.nr_seq_evento_deb,
	a.nr_seq_prestador,
	a.nr_sequencia
from	pls_regra_franq_pag b,
	pls_franq_pag_prest a
where	a.nr_seq_regra		= b.nr_sequencia
and	a.nr_seq_franq_pag	= nr_seq_franq_pag_w
and	a.vl_ajuste		<> 0;

BEGIN

select	max(dt_referencia),
	max(cd_estabelecimento)
into STRICT	dt_referencia_w,
	cd_estabelecimento_w
from	pls_franq_pag
where	nr_sequencia		= nr_seq_franq_pag_p;

select	max(nr_sequencia)
into STRICT	nr_seq_competencia_w
from	pls_competencia
where	cd_estabelecimento			= cd_estabelecimento_w
and	trunc(dt_mes_competencia, 'month')	= trunc(dt_referencia_w,'month');

select	nextval('pls_lote_evento_seq')
into STRICT	nr_seq_lote_evento_w
;

insert	into pls_lote_evento(nr_sequencia,
	nr_seq_competencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	cd_estabelecimento,
	dt_competencia,
	dt_geracao_titulos,
	dt_liberacao,
	ds_observacao,
	ie_origem,
	dt_inicio_comp,
	dt_fim_comp,
	nr_seq_lote_pagamento,
	nr_lote_contabil,
	dt_geracao_boleto,
	nr_seq_evento,
	nr_seq_lote_plant,
	dt_titulos_terceiros,
	nr_seq_franq_pag)
SELECT	nr_seq_lote_evento_w,
	nr_seq_competencia_w,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	cd_estabelecimento_w,
	dt_referencia_w,
	null,
	null,
	'Lote de eventos gerado a partir do lote de franquia ' || nr_seq_franq_pag_p || '.',
	'A',
	null,
	null,
	null,
	0,
	null,
	null,
	null,
	null,
	nr_seq_franq_pag_p
;

for	r_c01_w in c01(nr_seq_franq_pag_p) loop

	select	nextval('pls_evento_movimento_seq')
	into STRICT	nr_seq_evento_movto_w
	;

	insert into pls_evento_movimento(nr_sequencia,
		nr_seq_lote,
		nr_seq_prestador,
		nr_seq_evento,
		dt_movimento,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		vl_movimento,
		nr_seq_lote_pgto,
		nr_titulo_receber,
		nr_titulo_pagar,
		ie_forma_pagto,
		nr_seq_regra_fixo,
		ds_observacao,
		cd_conta_contabil,
		cd_conta_debito,
		nr_tit_pagar_vinculado,
		nr_tit_rec_vinculado,
		nr_adiant_pago,
		cd_conta_credito,
		nr_lote_contabil,
		cd_historico,
		nr_seq_esquema,
		nr_seq_periodo,
		dt_venc_titulo,
		nr_seq_classe_tit_rec,
		nr_seq_prest_plant_item,
		nr_seq_lote_contest,
		nr_seq_lote_disc,
		nr_seq_lote_pgto_orig,
		dt_mes_comp_lote,
		cd_classif_cred,
		cd_classif_deb,
		nr_seq_conta_ajuste,
		ie_titulo_pagar,
		cd_pf_titulo_pagar,
		cd_cgc_titulo_pagar,
		nr_seq_trans_fin_baixa,
		nr_seq_trans_fin_contab)
	SELECT	nr_seq_evento_movto_w,
		nr_seq_lote_evento_w,
		r_c01_w.nr_seq_prestador,
		CASE WHEN sign(r_c01_w.vl_ajuste)=1 THEN  r_c01_w.nr_seq_evento_cred WHEN sign(r_c01_w.vl_ajuste)=-1 THEN  r_c01_w.nr_seq_evento_deb END ,
		dt_referencia_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		r_c01_w.vl_ajuste,
		null,
		null,
		null,
		'P',
		null,
		null,
		null,
		null,
		null,
		null,
		null,
		null,
		0,
		null,
		null,
		null,
		null,
		null,
		null,
		null,
		null,
		null,
		null,
		null,
		null,
		null,
		null,
		null,
		null,
		null,
		null
	;

	update	pls_franq_pag_prest
	set	nr_seq_evento_movto	= nr_seq_evento_movto_w
	where	nr_sequencia		= r_c01_w.nr_sequencia;

end loop;

CALL pls_liberar_lote_evento(nr_seq_lote_evento_w, 'L', nm_usuario_p, null, 'N');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_lote_evento_franq ( nr_seq_franq_pag_p pls_franq_pag.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

