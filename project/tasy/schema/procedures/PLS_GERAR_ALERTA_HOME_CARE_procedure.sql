-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_alerta_home_care ( ie_tipo_evento_p bigint, nr_seq_requisicao_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Enviar SMS para os médicos da home care
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[ X ]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção: Quando testar a rotina na base wheb, deixar a rotina que envia o SMS
comentado, pois não será enviado o SMS e mostrará uma menssagem.
-------------------------------------------------------------------------------------------------------------------
Referências:

	IE_STATUS_ENVIO_P: 	E - Mensagem enviada
				A - Aguardando envio

	IE_FORMA_ENVIO_P:		EM - Email
				CI - Comunicação interna
				SMS - SMS

	PLS_GERAR_ALERTA_EVENTO
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
cd_medico_resp_w		medico.cd_pessoa_fisica%type;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
ds_destinatario_w		varchar(255);
ds_mensagem_regra_w		pls_alerta_evento_controle.ds_mensagem%type;
ds_remetente_w			pls_alerta_evento_mensagem.ds_remetente_sms%type;
ds_titulo_w			pls_alerta_evento_mensagem.ds_titulo%type;
id_sms_w			pls_alerta_evento_cont_des.id_sms%type;
ie_forma_envio_w		pls_alerta_evento_destino.ie_forma_envio%type;
ie_regra_w			varchar(1) := 'N';
ie_tipo_envio_w			pls_alerta_evento_mensagem.ie_tipo_envio%type;
ie_tipo_guia_w			pls_requisicao.ie_tipo_guia%type;
nm_beneficiario_w		pessoa_fisica.nm_pessoa_fisica%type;
nm_prestador_exec_w		pls_prestador.nm_interno%type;
qt_macro_regra_w		integer := 0;
nr_seq_evento_controle_w	pls_alerta_evento_controle.nr_sequencia%type;
nr_seq_evento_dest_w		pls_alerta_evento_destino.nr_sequencia%type;
nr_seq_evento_mens_w		pls_alerta_evento_mensagem.nr_sequencia%type;
nr_seq_hc_w			paciente_home_care.nr_sequencia%type;
nr_seq_prestador_exec_w		pls_prestador.nr_sequencia%type;
nr_seq_regra_evento_w		pls_regra_geracao_evento.nr_sequencia%type;
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
nr_seq_tipo_evento_w		pls_tipo_alerta_evento.nr_sequencia%type;
nr_telefone_celular_w		pls_alerta_event_dest_fixo.nr_telefone_celular%type;
ie_consiste_destinatario_sms	varchar(1);

C01 CURSOR FOR
	SELECT	nr_seq_evento_mens,
		nr_sequencia
	from	pls_regra_geracao_evento
	where	ie_situacao 		= 'A'
	and	ie_evento_disparo 	= ie_tipo_evento_p
	and (coalesce(ie_tipo_guia::text, '') = ''  or ie_tipo_guia	= ie_tipo_guia_w);

C02 CURSOR FOR
	SELECT	nr_sequencia,
		ie_forma_envio
	from	pls_alerta_evento_destino
	where	nr_seq_evento_mens	= nr_seq_evento_mens_w
	and	ie_tipo_pessoa_dest	= 'MR'
	and	ie_situacao 		= 'A';

C03 CURSOR FOR
	SELECT	nr_telefone_celular
	from	pls_alerta_event_dest_fixo
	where	nr_seq_alerta_event_dest = nr_seq_evento_dest_w;


BEGIN

ie_consiste_destinatario_sms := OBTER_VALOR_PARAM_USUARIO(0,214,0,wheb_usuario_pck.get_nm_usuario,wheb_usuario_pck.get_cd_estabelecimento);

select	ie_tipo_guia,
	nr_seq_segurado,
	nr_seq_prestador_exec
into STRICT	ie_tipo_guia_w,
	nr_seq_segurado_w,
	nr_seq_prestador_exec_w
from	pls_requisicao
where	nr_sequencia = nr_seq_requisicao_p;

cd_pessoa_fisica_w := pls_obter_dados_segurado(nr_seq_segurado_w,'PF');

select	substr(pls_obter_dados_segurado(nr_seq_segurado_w,'N'),1,70)
into STRICT	nm_beneficiario_w
;

select	substr(pls_obter_dados_prestador(nr_seq_prestador_exec_w,'N'),1,70)
into STRICT	nm_prestador_exec_w
;

select	max(nr_sequencia)
into STRICT	nr_seq_hc_w
from	paciente_home_care
where	cd_pessoa_fisica = cd_pessoa_fisica_w
and	coalesce(dt_final::text, '') = ''
and	ie_situacao = 'A';

if (coalesce(nr_seq_hc_w,0) > 0) then

	open C01;
	loop
	fetch C01 into
		nr_seq_evento_mens_w,
		nr_seq_regra_evento_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ie_regra_w := 'S';
		end;
	end loop;
	close C01;

	if (ie_regra_w = 'S') then

		select	ds_mensagem,
			ie_tipo_envio,
			ds_titulo,
			nr_seq_tipo_evento,
			ds_remetente_sms
		into STRICT	ds_mensagem_regra_w,
			ie_tipo_envio_w,
			ds_titulo_w,
			nr_seq_tipo_evento_w,
			ds_remetente_w
		from	pls_alerta_evento_mensagem
		where 	nr_sequencia = nr_seq_evento_mens_w;

		select	cd_medico_resp
		into STRICT	cd_medico_resp_w
		from	paciente_home_care
		where	nr_sequencia = nr_seq_hc_w;

		if (cd_medico_resp_w IS NOT NULL AND cd_medico_resp_w::text <> '') then
			select	CASE WHEN ie_consiste_destinatario_sms='N' THEN nr_ddi_celular || nr_telefone_celular  ELSE nr_telefone_celular END
			into STRICT	ds_destinatario_w
			from	pessoa_fisica
			where	cd_pessoa_fisica = cd_medico_resp_w;
		end if;

		open C02;
		loop
		fetch C02 into
			nr_seq_evento_dest_w,
			ie_forma_envio_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */

			if ( ie_forma_envio_w = 'SMS') then
				ds_remetente_w		:=	substr(ds_remetente_w,0,40);
				ds_destinatario_w	:=	substr(ds_destinatario_w,0,40);

				if (ds_remetente_w IS NOT NULL AND ds_remetente_w::text <> '') and (ds_destinatario_w IS NOT NULL AND ds_destinatario_w::text <> '') and (ds_mensagem_regra_w IS NOT NULL AND ds_mensagem_regra_w::text <> '') then

					select	count(1)
					into STRICT	qt_macro_regra_w
					
					where	ds_mensagem_regra_w like '%@%';

					if ( qt_macro_regra_w > 0) then

						ds_mensagem_regra_w := pls_substituir_macros(ds_mensagem_regra_w, nr_seq_requisicao_p, null, null, null, null);

					end if;

					if (coalesce(nr_seq_evento_controle_w::text, '') = '') then

						select	nextval('pls_alerta_evento_controle_seq')
						into STRICT	nr_seq_evento_controle_w
						;

						insert into pls_alerta_evento_controle(
								nr_sequencia, dt_geracao_evento, ie_evento_disparo,
								nr_seq_tipo_evento, dt_atualizacao, nm_usuario,
								dt_atualizacao_nrec, nm_usuario_nrec, ds_mensagem,
								ds_titulo, ie_tipo_envio)
							values (	nr_seq_evento_controle_w, clock_timestamp(), ie_tipo_evento_p,
								nr_seq_tipo_evento_w, clock_timestamp(), nm_usuario_p,
								clock_timestamp(), nm_usuario_p, ds_mensagem_regra_w,
								ds_titulo_w,ie_tipo_envio_w);
					end if;

					ds_destinatario_w	:= replace(ds_destinatario_w,'(','');
					ds_destinatario_w	:= replace(ds_destinatario_w,')','');
					ds_destinatario_w	:= replace(ds_destinatario_w,'-','');

					id_sms_w := pls_enviar_sms_alerta_evento(ds_remetente_w, ds_destinatario_w, substr(ds_mensagem_regra_w,1,150), nr_seq_tipo_evento_w, nm_usuario_p, id_sms_w);
					CALL pls_gerar_destino_evento(nr_seq_evento_controle_w, 'E', ie_forma_envio_w, nm_usuario_p, cd_medico_resp_w, null, ds_mensagem_regra_w, id_sms_w, ds_destinatario_w);

					if (nr_seq_requisicao_p IS NOT NULL AND nr_seq_requisicao_p::text <> '') then
						CALL pls_requisicao_gravar_hist(nr_seq_requisicao_p,
									'AG',
									'Remetente: ' || ds_remetente_w || chr(13) || chr(10) ||
									'Destino: ' || ds_destinatario_w || chr(13) || chr(10) ||
									'Mensagem: ' || chr(13) || chr(10) ||
									substr(ds_mensagem_regra_w,1,150),
									null,
									nm_usuario_p);
					end if;
				end if;
			end if;

			open C03;
			loop
			fetch C03 into
				nr_telefone_celular_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin

				if ( ie_forma_envio_w = 'SMS') then
					ds_destinatario_w := substr(nr_telefone_celular_w,0,40);

					if (ds_remetente_w IS NOT NULL AND ds_remetente_w::text <> '') and (ds_destinatario_w IS NOT NULL AND ds_destinatario_w::text <> '') and (ds_mensagem_regra_w IS NOT NULL AND ds_mensagem_regra_w::text <> '') and (coalesce(nr_seq_evento_controle_w,0) > 0) then
						ds_destinatario_w	:= replace(ds_destinatario_w,'(','');
						ds_destinatario_w	:= replace(ds_destinatario_w,')','');
						ds_destinatario_w	:= replace(ds_destinatario_w,'-','');

						id_sms_w := pls_enviar_sms_alerta_evento(ds_remetente_w, ds_destinatario_w, substr(ds_mensagem_regra_w,1,150), nr_seq_tipo_evento_w, nm_usuario_p, id_sms_w);
						CALL pls_gerar_destino_evento(nr_seq_evento_controle_w, 'E', ie_forma_envio_w, nm_usuario_p, cd_medico_resp_w, null, ds_mensagem_regra_w, id_sms_w, ds_destinatario_w);

						if (nr_seq_requisicao_p IS NOT NULL AND nr_seq_requisicao_p::text <> '') then
							CALL pls_requisicao_gravar_hist(nr_seq_requisicao_p,
										'AG',
										'Remetente: ' || ds_remetente_w || chr(13) || chr(10) ||
										'Destino: ' || ds_destinatario_w || chr(13) || chr(10) ||
										'Mensagem: ' || chr(13) || chr(10) ||
										substr(ds_mensagem_regra_w,1,150),
										null,
										nm_usuario_p);
						end if;
					end if;
				end if;
				end;
			end loop;
			close C03;
		end loop;
		close C02;
	end if;
end if;

--commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_alerta_home_care ( ie_tipo_evento_p bigint, nr_seq_requisicao_p bigint, nm_usuario_p text) FROM PUBLIC;

