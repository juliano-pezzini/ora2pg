-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_sala_cirurgia ( nr_atendimento_p bigint, nr_cirurgia_p bigint, dt_entrada_unidade_p timestamp, dt_inicio_real_p timestamp, cd_setor_atendimento_p bigint, cd_unidade_basica_p text, cd_unidade_compl_p text, cd_tipo_acomodacao_p bigint, nm_usuario_p text, dt_termino_p timestamp) AS $body$
DECLARE

 
dt_entrada_unidade_w	timestamp;
qt_atendimento_w	bigint;
qt_passagem_w		bigint;
nr_sequencia_w		bigint;
nr_seq_interno_w	bigint;
nr_seq_interno_origem_w	bigint;
					

BEGIN 
 
select	dt_entrada_unidade 
into STRICT	dt_entrada_unidade_w 
from	cirurgia 
where	nr_cirurgia		= nr_cirurgia_p;
 
select	coalesce(max(nr_seq_interno),0) 
into STRICT	nr_seq_interno_origem_w 
from	atend_paciente_unidade 
where	dt_entrada_unidade 	= dt_entrada_unidade_w 
and	nr_atendimento		= nr_atendimento_p;
 
select	count(*) 
into STRICT	qt_atendimento_w 
from	atendimento_paciente 
where	(dt_fim_conta IS NOT NULL AND dt_fim_conta::text <> '') 
and	nr_atendimento		= nr_atendimento_p;
 
if (qt_atendimento_w > 0) then 
	CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(177185);
end if;
 
select	count(*) 
into STRICT	qt_passagem_w 
from	atend_paciente_unidade 
where	nr_atendimento 		= nr_atendimento_p 
and	dt_entrada_unidade 	= dt_entrada_unidade_p;
 
if (qt_passagem_w > 0) then 
	CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(177186);
end if;
 
/* Gerar nova passagem */
 
select	coalesce(max(nr_sequencia),0) + 1 
into STRICT	nr_sequencia_w 
from	atend_paciente_unidade 
where	nr_atendimento		= nr_atendimento_p;
 
select	nextval('atend_paciente_unidade_seq') 
into STRICT	nr_seq_interno_w
;
 
insert	into atend_paciente_unidade(nr_atendimento, 
	nr_sequencia, 
	cd_setor_atendimento, 
	cd_unidade_basica, 
	cd_unidade_compl, 
	dt_entrada_unidade, 
	dt_atualizacao, 
	nm_usuario, 
	cd_tipo_acomodacao, 
	dt_saida_unidade, 
	nr_atend_dia, 
	ds_observacao, 
	nm_usuario_original, 
	dt_saida_interno, 
	ie_passagem_setor, 
	nr_acompanhante, 
	nr_seq_interno, 
	ie_calcular_dif_diaria, 
	nr_seq_motivo_transf) 
values (nr_atendimento_p, 
	nr_sequencia_w, 
	cd_setor_atendimento_p, 
	cd_unidade_basica_p, 
	cd_unidade_compl_p, 
	dt_entrada_unidade_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	cd_tipo_acomodacao_p, 
	dt_termino_p, 
	null, 
	null, 
	nm_usuario_p, 
	dt_termino_p, 
	'S', 
	null, 
	nr_seq_interno_w, 
	'S', 
	null);
 
update	cirurgia 
set	nr_atendimento		= nr_atendimento_p, 
	dt_entrada_unidade	= dt_entrada_unidade_p, 
	dt_inicio_real		= dt_inicio_real_p, 
	nm_usuario		= nm_usuario_p 
where	nr_cirurgia		= nr_cirurgia_p;
commit;
		 
CALL Atend_Paciente_Unid_AfterPost(nr_seq_interno_w, 'I', nm_usuario_p);
 
 
/* TransferÃªncia de gastos */
 
if (nr_seq_interno_origem_w > 0) then 
	update	procedimento_paciente a 
	set	a.cd_setor_Atendimento	=	cd_setor_atendimento_p, 
		a.dt_entrada_unidade	=	dt_entrada_unidade_p, 
		a.nr_seq_atepacu	=	nr_seq_interno_w 
	where	a.nr_seq_atepacu   	= 	nr_seq_interno_origem_w 
	and   a.nr_atendimento 	= 	nr_atendimento_p 
	and  	not exists (	SELECT	nr_atendimento 
				from 	conta_paciente c 
				where	a.nr_interno_conta  	= c.nr_interno_conta 
				and	c.ie_status_acerto 	= 2);
	 
	update	material_atend_paciente a 
	set	a.cd_setor_Atendimento	=	cd_setor_atendimento_p, 
		a.dt_entrada_unidade	=	dt_entrada_unidade_p, 
		a.nr_seq_atepacu	=	nr_seq_interno_w 
	where	a.nr_seq_atepacu   	= 	nr_seq_interno_origem_w 
	and   a.nr_atendimento 	= 	nr_atendimento_p 
	and  	not exists (	SELECT	nr_atendimento 
				from 	conta_paciente c 
				where	a.nr_interno_conta  	= c.nr_interno_conta 
				and	c.ie_status_acerto 	= 2);
				 
	/* Deletar passagem anterior */
 
	delete	from atend_paciente_unidade 
	where	nr_seq_interno	=	nr_seq_interno_origem_w 
	and	nr_atendimento	=	nr_atendimento_p;	
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_sala_cirurgia ( nr_atendimento_p bigint, nr_cirurgia_p bigint, dt_entrada_unidade_p timestamp, dt_inicio_real_p timestamp, cd_setor_atendimento_p bigint, cd_unidade_basica_p text, cd_unidade_compl_p text, cd_tipo_acomodacao_p bigint, nm_usuario_p text, dt_termino_p timestamp) FROM PUBLIC;

