-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_resumo_nota_fiscal ( cd_estabelecimento_p bigint, nm_usuario_p text, ie_agrupa_p text, dt_mesano_referencia_p timestamp) AS $body$
DECLARE

 
cd_codigo_w		integer;
ds_descricao_w		varchar(100);
dt_entrada_saida_w	timestamp;
dt_anterior_w		timestamp;
vl_compra_dia_w		double precision;
vl_compra_mes_w		double precision;

c01 CURSOR FOR 
	SELECT	substr(CASE WHEN ie_agrupa_p='G' THEN b.cd_grupo_material WHEN ie_agrupa_p='S' THEN b.cd_subgrupo_material WHEN ie_agrupa_p='C' THEN b.cd_classe_material WHEN ie_agrupa_p='M' THEN b.cd_material END ,1,100), 
		substr(CASE WHEN ie_agrupa_p='G' THEN b.ds_grupo_material WHEN ie_agrupa_p='S' THEN b.ds_subgrupo_material WHEN ie_agrupa_p='C' THEN b.ds_classe_material WHEN ie_agrupa_p='M' THEN b.ds_material END ,1,100), 
		SUM(c.vl_liquido) vl_liquido 
	from	nota_fiscal_v a, 
		estrutura_material_v b, 
		nota_fiscal_item c 
	where	c.nr_sequencia = a.nr_sequencia 
	and	c.cd_material = b.cd_material 
	and	PKG_DATE_UTILS.start_of(a.dt_entrada_saida,'dd',0) = dt_entrada_saida_w 
	and	a.ie_operacao_fiscal  	= 'E' 
	group by 
		substr(CASE WHEN ie_agrupa_p='G' THEN b.cd_grupo_material WHEN ie_agrupa_p='S' THEN b.cd_subgrupo_material WHEN ie_agrupa_p='C' THEN b.cd_classe_material WHEN ie_agrupa_p='M' THEN b.cd_material END ,1,100), 
		substr(CASE WHEN ie_agrupa_p='G' THEN b.ds_grupo_material WHEN ie_agrupa_p='S' THEN b.ds_subgrupo_material WHEN ie_agrupa_p='C' THEN b.ds_classe_material WHEN ie_agrupa_p='M' THEN b.ds_material END ,1,100);

 

BEGIN 
delete from w_resumo_nota_fiscal;
commit;
 
dt_entrada_saida_w	:= PKG_DATE_UTILS.start_of(dt_mesano_referencia_p,'dd',0);
dt_anterior_w		:= PKG_DATE_UTILS.start_of(PKG_DATE_UTILS.ADD_MONTH(dt_mesano_referencia_p, -1, 0), 'month',0);
 
open c01;
LOOP 
FETCH C01 INTO 
	cd_codigo_w, 
	ds_descricao_w, 
	vl_compra_dia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */	
	begin 
 
	select	SUM(c.vl_liquido) 
	into STRICT	vl_compra_mes_w 
	from	nota_fiscal_v a, 
		estrutura_material_v b, 
		nota_fiscal_item c 
	where	c.nr_sequencia = a.nr_sequencia 
	and	c.cd_material = b.cd_material 
	and	PKG_DATE_UTILS.start_of(a.dt_entrada_saida,'month',0) = dt_anterior_w 
	and	a.ie_operacao_fiscal  	= 'E' 
	and	cd_codigo_w = 
		CASE WHEN ie_agrupa_p='G' THEN b.cd_grupo_material WHEN ie_agrupa_p='S' THEN b.cd_subgrupo_material WHEN ie_agrupa_p='C' THEN b.cd_classe_material WHEN ie_agrupa_p='M' THEN b.cd_material END;
 
	insert into w_resumo_nota_fiscal( 
		nr_sequencia, 
		cd_estabelecimento, 
		dt_atualizacao, 
		nm_usuario, 
		cd_codigo, 
		ds_descricao, 
		vl_compra_dia, 
		vl_compra_mes, 
		vl_compra_mes_ant, 
		vl_perc_variacao, 
		vl_perc_teto) 
	values (	nextval('w_resumo_nota_fiscal_seq'), 
		cd_estabelecimento_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_codigo_w, 
		ds_descricao_w, 
		vl_compra_dia_w, 
		vl_compra_mes_w, 
		0, 
		0, 
		0);
	end;
END LOOP;
CLOSE C01;
 
commit;
	 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_resumo_nota_fiscal ( cd_estabelecimento_p bigint, nm_usuario_p text, ie_agrupa_p text, dt_mesano_referencia_p timestamp) FROM PUBLIC;

