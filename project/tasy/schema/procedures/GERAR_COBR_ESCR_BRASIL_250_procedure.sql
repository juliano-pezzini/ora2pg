-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cobr_escr_brasil_250 ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

	 
-- \\192.168.0.230\UTLFILE 
	 
/* CONTEÚDO */
 
ds_conteudo_w			varchar(250);

/* CONTADOR */
 
nr_seq_apres_w			bigint := 1;

/* HEADER ARQUIVO */
 
ie_tipo_registro_w		varchar(255);
cd_agencia_bancaria_w		varchar(255);
nr_digito_agencia_w		varchar(255);
cd_cgc_cedente_w		varchar(255);
nr_digito_verificador_w		varchar(255);
cd_carteira_w			varchar(255);
cd_variacao_carteira_w		varchar(255);
ds_zeros_w			varchar(255);
nm_empresa_w			varchar(255);
ds_sigla_cedente_w		varchar(255);
tp_impressao_w			varchar(255);
ds_endereco_w			varchar(255);
cd_cep_w			varchar(255);
ds_praca_devolucao_w		varchar(255);
nr_seq_remessa_w		varchar(255);
ds_indic_conferencia_w		varchar(255);
ds_ident_arquivo_w		varchar(255);
cd_personalizacao_w		varchar(255);
cd_convenio_banco_w		varchar(255);

/* DETALHE ARQUIVO */
 
tp_documento_w			varchar(255);
nr_cgc_cpf_w			varchar(255);
nm_pagador_w			varchar(255);
ds_praca_sacado_w		varchar(255);
sg_estado_w			varchar(255);
dt_emissao_w			varchar(255);
dt_vencimento_w			varchar(255);
ds_aceite_w			varchar(255);
ie_especie_titulo_w		varchar(255);
nr_nosso_numero_w		varchar(255);
nr_titulo_w			varchar(255);
cd_moeda_w			varchar(255);
qt_moeda_variavel_w		varchar(255);
vl_titulo_w			varchar(255);
qt_dias_protesto_w		varchar(255);
qt_total_parcelas_w		varchar(255);

/* BRANCOS */
 
ds_brancos_233_w		varchar(233);
ds_brancos_38_w			varchar(38);
ds_brancos_6_w			varchar(6);
ds_brancos_4_w			varchar(4);
ds_brancos_3_w			varchar(3);
ds_brancos_5_w			varchar(5);

arq_texto_w   		utl_file.file_type;
nm_arquivo_w     		varchar(255);
ds_erro_w      		varchar(255);
ds_local_w      		varchar(255);
ie_documento_w			varchar(1);

ds_mensagem_1_w			varchar(60);
ds_mensagem_2_w			varchar(60);
ds_mensagem_3_w			varchar(60);
ds_mensagem_4_w			varchar(60);
ds_mensagem_5_w			varchar(240);
	
C01 CURSOR FOR					 
	SELECT	'11' tp_documento, 
		CASE WHEN pls_obter_dados_pagador(k.nr_seq_pagador, 'T')='PF' THEN  1  ELSE CASE WHEN pls_obter_dados_pagador(k.nr_seq_pagador, 'T')='PJ' THEN 2  ELSE 3 END  END  ie_documento, 
 
 
		lpad(coalesce(b.cd_cgc_cpf,'0'),15, '0') ds_cgc_cpf,		 
		rpad(upper(substr(coalesce(pls_obter_dados_pagador(k.nr_seq_pagador, 'N'),' '),1,60)),60,' ') nm_pagador,		 
		rpad(substr(coalesce(pls_obter_compl_pagador(k.nr_seq_pagador, 'CI'), ' '), 1, 18), 18, ' ') ds_praca_sacado, 
		rpad(substr(coalesce(pls_obter_compl_pagador(k.nr_seq_pagador, 'UF'), ' '), 1, 2), 2, ' ') sg_estado, 
		to_char(b.dt_emissao,'ddmmyy') dt_emissao, 
		to_char(b.dt_pagamento_previsto,'ddmmyy') dt_vencimento, 
		'N' ds_aceite, 
		'DM' ie_especie_titulo, 
		lpad(substr(coalesce(d.cd_convenio_banco,'0'), 1, 7), 7,'0') || lpad(substr(coalesce(b.nr_nosso_numero,'0'), 1, 10), 10,'0') nr_nosso_numero, 
		lpad(coalesce(b.nr_titulo,'0'),10,'0') nr_titulo, 
		'09' cd_moeda, 
		lpad('0',15,'0') qt_moeda_variavel, 
		lpad(replace(replace(campo_mascara_virgula(b.vl_titulo),',',''),'.',''),15,'0') vl_titulo, 
		lpad(coalesce(d.qt_dias_protesto,'0'),2,'0') qt_dias_protesto, 
		'00' qt_total_parcelas, 
		rpad(substr(coalesce(pls_obter_compl_pagador(k.nr_seq_pagador, 'ES'), ' '), 1, 60), 60, ' ') ds_endereco, 
		rpad(substr(coalesce(pls_obter_compl_pagador(k.nr_seq_pagador, 'CEP'), ' '), 1, 8), 8, ' ') cd_cep, 
		rpad(coalesce(obter_instrucao_boleto(b.nr_titulo,a.cd_banco,1),' '),60, ' ') ds_mensagem_1, 
		rpad(coalesce(obter_instrucao_boleto(b.nr_titulo,a.cd_banco,2),' '),60, ' ') ds_mensagem_2, 
		rpad(coalesce(obter_instrucao_boleto(b.nr_titulo,a.cd_banco,3),' '),60, ' ') ds_mensagem_3, 
		rpad(coalesce(obter_instrucao_boleto(b.nr_titulo,a.cd_banco,4),' '),60, ' ') ds_mensagem_4, 
		rpad(coalesce(substr(x.ds_observacao_titulo,1, 240),' '),240, ' ') ds_mensagem_5 
	FROM banco_estabelecimento e, titulo_receber_cobr c, titulo_receber_v b, titulo_receber x
LEFT OUTER JOIN pls_mensalidade k ON (x.nr_seq_mensalidade = k.nr_sequencia)
, cobranca_escritural a
LEFT OUTER JOIN banco_carteira d ON (a.nr_seq_carteira_cobr = d.nr_sequencia)
WHERE a.nr_sequencia		= c.nr_seq_cobranca and b.nr_titulo		= x.nr_titulo  and c.nr_titulo		= b.nr_titulo and a.nr_seq_conta_banco	= e.nr_sequencia  and a.nr_sequencia		= nr_seq_cobr_escrit_p;

BEGIN
nm_arquivo_w	:= to_char(clock_timestamp(),'ddmmyyyy') || to_char(clock_timestamp(),'hh24') || to_char(clock_timestamp(),'mi') || to_char(clock_timestamp(),'ss') || nm_usuario_p || '.rem';
 
SELECT * FROM obter_evento_utl_file(1, null, ds_local_w, ds_erro_w) INTO STRICT ds_local_w, ds_erro_w;
 
begin 
arq_texto_w	:= utl_file.fopen(ds_local_w, nm_arquivo_w, 'W');
exception 
when others then 
	if (SQLSTATE = -29289) then 
		ds_erro_w	:= 'O acesso ao arquivo foi negado pelo sistema operacional (access_denied).';
	elsif (SQLSTATE = -29298) then 
		ds_erro_w	:= 'O arquivo foi aberto usando FOPEN_NCHAR, mas efetuaram-se operações de I/O usando funções nonchar comos PUTF ou GET_LINE (charsetmismatch).';
	elsif (SQLSTATE = -29291) then 
		ds_erro_w	:= 'Não foi possível apagar o arquivo (delete_failed).';
	elsif (SQLSTATE = -29286) then 
		ds_erro_w	:= 'Erro interno desconhecido no package UTL_FILE (internal_error).';
	elsif (SQLSTATE = -29282) then 
		ds_erro_w	:= 'O handle do arquivo não existe (invalid_filehandle).';
	elsif (SQLSTATE = -29288) then 
		ds_erro_w	:= 'O arquivo com o nome especificado não foi encontrado neste local (invalid_filename).';
	elsif (SQLSTATE = -29287) then 
		ds_erro_w	:= 'O valor de MAX_LINESIZE para FOPEN() é inválido; deveria estar na faixa de 1 a 32767 (invalid_maxlinesize).';
	elsif (SQLSTATE = -29281) then 
		ds_erro_w	:= 'O parâmetro open_mode na chamda FOPEN é inválido (invalid_mode).';
	elsif (SQLSTATE = -29290) then 
		ds_erro_w	:= 'O parâmetro ABSOLUTE_OFFSET para a chamada FSEEK() é inválido; deveria ser maior do que 0 e menor do que o número total de bytes do arquivo (invalid_offset).';
	elsif (SQLSTATE = -29283) then 
		ds_erro_w	:= 'O arquivo não pôde ser aberto ou operado da forma desejada - ou o caminho não foi encontrado (invalid_operation).';
	elsif (SQLSTATE = -29280) then 
		ds_erro_w	:= 'O caminho especificado não existe ou não está visível ao Oracle (invalid_path).';
	elsif (SQLSTATE = -29284) then 
		ds_erro_w	:= 'Não é possível efetuar a leitura do arquivo (read_error).';
	elsif (SQLSTATE = -29292) then 
		ds_erro_w	:= 'Não é possível renomear o arquivo.';
	elsif (SQLSTATE = -29285) then 
		ds_erro_w	:= 'Não foi possível gravar no arquivo (write_error).';
	else 
		ds_erro_w	:= 'Erro desconhecido no package UTL_FILE.';
	end if;
	 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(181577, 'DS_ERRO=' || ds_erro_w);
end;
 
select	lpad(' ', 233, ' '), 
	lpad(' ', 38, ' '), 
	lpad(' ', 6, ' '), 
	lpad(' ', 4, ' '), 
	lpad(' ', 3, ' '), 
	lpad(' ', 5, ' ') 
into STRICT	ds_brancos_233_w, 
	ds_brancos_38_w, 
	ds_brancos_6_w, 
	ds_brancos_4_w, 
	ds_brancos_3_w, 
	ds_brancos_5_w
;
	 
/* HEADER ARQUIVO */
 
select	'01' ie_tipo_registro, 
	lpad(replace(replace(c.cd_agencia_bancaria,'-',''),'.',''),4,'0') cd_agencia_bancaria, 
	'1' nr_digito_agencia, 
	'000056936' cd_cgc_cedente, 
	'4' nr_digito_verificador, 
	lpad(substr(coalesce(d.cd_carteira, '0'),1,3), 3, '0') cd_carteira, 
	lpad(substr(replace(coalesce(d.cd_variacao_carteira, '0'), '-', ''),1,3), 3,'0')	cd_variacao_carteira, 
	lpad('0',6,'0')	ds_zeros, 
	rpad(upper(substr(obter_razao_social(b.cd_cgc),1,45)),45,' ') nm_empresa, 
	rpad('ASES',10,' ') sigla_cedente, 
	'01' tp_impressao, 
	rpad(substr(obter_dados_pf_pj(null, b.cd_cgc, 'EC'),1,60),60,' ') ds_endereco, 
	lpad(substr(obter_dados_pf_pj(null, b.cd_cgc, 'CEP'),1,8),8,'0') cd_cep, 
	rpad('CAMPOS GOYTACASES-RJ',20,' ') praca_devolucao, 
	lpad(coalesce(a.nr_remessa,'0'),7,'0') nr_seq_remessa, 
	'N' indicador_conferencia, 
	rpad('CBR454',8,' ') identificador_arquivo, 
	lpad(' ',5,' ')	cd_personalizacao, 
	lpad(substr(coalesce(d.cd_convenio_banco,'0'), 1, 7), 7,'0') cd_convenio_banco 
into STRICT	ie_tipo_registro_w, 
	cd_agencia_bancaria_w, 
	nr_digito_agencia_w, 
	cd_cgc_cedente_w, 
	nr_digito_verificador_w, 
	cd_carteira_w, 
	cd_variacao_carteira_w, 
	ds_zeros_w, 
	nm_empresa_w, 
	ds_sigla_cedente_w, 
	tp_impressao_w, 
	ds_endereco_w, 
	cd_cep_w, 
	ds_praca_devolucao_w, 
	nr_seq_remessa_w, 
	ds_indic_conferencia_w, 
	ds_ident_arquivo_w, 
	cd_personalizacao_w, 
	cd_convenio_banco_w 
FROM agencia_bancaria e, banco_estabelecimento c, estabelecimento b, cobranca_escritural a
LEFT OUTER JOIN banco_carteira d ON (a.nr_seq_carteira_cobr = d.nr_sequencia AND a.nr_seq_carteira_cobr = d.nr_sequencia)
WHERE a.cd_estabelecimento	= b.cd_estabelecimento and a.nr_seq_conta_banco	= c.nr_sequencia  and c.cd_agencia_bancaria	= e.cd_agencia_bancaria  and a.nr_sequencia		= nr_seq_cobr_escrit_p;
 
ds_conteudo_w	:=	ie_tipo_registro_w || cd_agencia_bancaria_w || nr_digito_agencia_w || cd_cgc_cedente_w || 
			nr_digito_verificador_w || cd_carteira_w || cd_variacao_carteira_w || ds_zeros_w || nm_empresa_w || 
			ds_sigla_cedente_w || tp_impressao_w || ds_endereco_w || cd_cep_w || ds_praca_devolucao_w || nr_seq_remessa_w || 
			ds_indic_conferencia_w || ds_brancos_4_w || ds_ident_arquivo_w || ds_brancos_3_w || ds_brancos_38_w || 
			cd_personalizacao_w || cd_convenio_banco_w || ds_brancos_3_w;
 
ds_conteudo_w	:= substr(elimina_acentuacao(ds_conteudo_w), 1, 255);
			 
utl_file.put_line(arq_texto_w, ds_conteudo_w || chr(13));
utl_file.fflush(arq_texto_w);	
/* FIM HEADER ARQUIVO */
 
 
/* DETALHE */
 
open C01;
loop 
fetch C01 into	 
	tp_documento_w, 
	ie_documento_w, 
	nr_cgc_cpf_w, 
	nm_pagador_w, 
	ds_praca_sacado_w, 
	sg_estado_w, 
	dt_emissao_w, 
	dt_vencimento_w, 
	ds_aceite_w, 
	ie_especie_titulo_w, 
	nr_nosso_numero_w, 
	nr_titulo_w, 
	cd_moeda_w, 
	qt_moeda_variavel_w, 
	vl_titulo_w, 
	qt_dias_protesto_w, 
	qt_total_parcelas_w, 
	ds_endereco_w, 
	cd_cep_w, 
	ds_mensagem_1_w, 
	ds_mensagem_2_w, 
	ds_mensagem_3_w, 
	ds_mensagem_4_w, 
	ds_mensagem_5_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	nr_seq_apres_w	:= nr_seq_apres_w + 1;
 
	ds_conteudo_w	:=	'04' || '  ' || ds_mensagem_5_w || ds_brancos_5_w;
	 
	ds_conteudo_w	:= substr(elimina_acentuacao(ds_conteudo_w), 1, 255);
	 
	utl_file.put_line(arq_texto_w, ds_conteudo_w || chr(13));
	utl_file.fflush(arq_texto_w);
	 
	nr_seq_apres_w	:= nr_seq_apres_w + 1;
 
	ds_conteudo_w	:=	'051111' || ds_mensagem_1_w || ds_mensagem_2_w || ds_mensagem_3_w || ds_mensagem_4_w || '  ';
	 
	ds_conteudo_w	:= substr(elimina_acentuacao(ds_conteudo_w), 1, 255);
	 
	utl_file.put_line(arq_texto_w, ds_conteudo_w || chr(13));
	utl_file.fflush(arq_texto_w);
	 
	nr_seq_apres_w	:= nr_seq_apres_w + 1;
 
	ds_conteudo_w	:=	tp_documento_w || ie_documento_w || nr_cgc_cpf_w || nm_pagador_w || ds_endereco_w || cd_cep_w || ds_praca_sacado_w || sg_estado_w || 
				dt_emissao_w || dt_vencimento_w || ds_aceite_w || ie_especie_titulo_w || nr_nosso_numero_w || nr_titulo_w || cd_moeda_w || 
				qt_moeda_variavel_w || vl_titulo_w || qt_dias_protesto_w || ds_brancos_6_w || qt_total_parcelas_w;
	 
	ds_conteudo_w	:= substr(elimina_acentuacao(ds_conteudo_w), 1, 255);
	 
	utl_file.put_line(arq_texto_w, ds_conteudo_w || chr(13));
	utl_file.fflush(arq_texto_w);
	end;	
end loop;
close C01;
/* FIM DETALHE ARQUIVO */
 
 
/* TRAILLER ARQUIVO */
	 
ds_conteudo_w	:= '99' || lpad(nr_seq_apres_w,15,0) || ds_brancos_233_w;
 
nr_seq_apres_w	:= nr_seq_apres_w + 1;
 
ds_conteudo_w	:= substr(elimina_acentuacao(ds_conteudo_w), 1, 255);
 
utl_file.put_line(arq_texto_w, ds_conteudo_w || chr(13));
utl_file.fflush(arq_texto_w);
/* FIM TRAILLER ARQUIVO */
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cobr_escr_brasil_250 ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

