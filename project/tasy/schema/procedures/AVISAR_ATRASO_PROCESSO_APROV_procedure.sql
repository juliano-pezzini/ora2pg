-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE avisar_atraso_processo_aprov ( nr_seq_aprovacao_p bigint, nm_usuario_p text, ie_tipo_p text, dt_justificativa_p timestamp, ds_justificativa_p text) AS $body$
DECLARE

 
nr_sequencia_w			bigint;
cd_solicitante_w			varchar(10);
cd_pessoa_delegacao_w		varchar(10);
nr_ordem_compra_w		bigint;
nr_solic_compra_w			bigint;
nm_solicitante_w			varchar(15);
nm_solicitante_delegacao_w		varchar(15);
nm_usuario_comprador_w		varchar(15);
nr_seq_classif_w			bigint;
ds_comunicado_w			varchar(2000);
nm_usuarios_w			varchar(255);
cd_comprador_w			varchar(10);

nr_documento_w			bigint;
ds_justificativa_w			varchar(2000);


BEGIN 
 
if (ie_tipo_p = 'O') then 
	select	distinct(b.nr_ordem_compra), 
		coalesce(a.cd_pessoa_solicitante, b.cd_pessoa_solicitante), 
		obter_pessoa_delegacao(coalesce(a.cd_pessoa_solicitante, b.cd_pessoa_solicitante),'RC',clock_timestamp()), 
		b.cd_comprador 
	into STRICT	nr_ordem_compra_w, 
		cd_solicitante_w, 
		cd_pessoa_delegacao_w, 
		cd_comprador_w 
	from	ordem_compra b, 
		ordem_compra_item a 
	where	a.nr_seq_aprovacao = nr_seq_aprovacao_p 
	 and	a.nr_ordem_compra = b.nr_ordem_compra;
 
	nr_documento_w := nr_ordem_compra_w;
elsif (ie_tipo_p = 'S') then 
	select	distinct(b.nr_solic_compra), 
		b.cd_pessoa_solicitante, 
		obter_pessoa_delegacao(b.cd_pessoa_solicitante,'RC',clock_timestamp()), 
		b.cd_comprador_resp 
	into STRICT	nr_solic_compra_w, 
		cd_solicitante_w, 
		cd_pessoa_delegacao_w, 
		cd_comprador_w 
	from	solic_compra b, 
		solic_compra_item a 
	where	a.nr_seq_aprovacao = nr_seq_aprovacao_p 
	and	a.nr_solic_compra = b.nr_solic_compra;
 
	nr_documento_w := nr_solic_compra_w;
elsif (ie_tipo_p = 'R') then 
	select	distinct(b.nr_requisicao), 
		b.cd_pessoa_requisitante, 
		obter_pessoa_delegacao(b.cd_pessoa_requisitante,'RC',clock_timestamp()), 
		null 
	into STRICT	nr_solic_compra_w, 
		cd_solicitante_w, 
		cd_pessoa_delegacao_w, 
		cd_comprador_w 
	from	requisicao_material b, 
		item_requisicao_material a 
	where	a.nr_seq_aprovacao = nr_seq_aprovacao_p 
	and	a.nr_requisicao = b.nr_requisicao;
 
	nr_documento_w := nr_solic_compra_w;
elsif (ie_tipo_p = 'C') then 
	select	distinct(b.nr_cot_compra), 
		b.cd_pessoa_solicitante, 
		obter_pessoa_delegacao(b.cd_pessoa_solicitante,'RC',clock_timestamp()), 
		null 
	into STRICT	nr_solic_compra_w, 
		cd_solicitante_w, 
		cd_pessoa_delegacao_w, 
		cd_comprador_w 
	from	cot_compra b, 
		cot_compra_item a 
	where	a.nr_seq_aprovacao = nr_seq_aprovacao_p 
	and	a.nr_cot_compra = b.nr_cot_compra;
 
	nr_documento_w := nr_solic_compra_w;
end if;
 
select	min(nm_usuario) 
into STRICT	nm_solicitante_w 
from	usuario 
where	cd_pessoa_fisica = cd_solicitante_w;
 
select	min(nm_usuario) 
into STRICT	nm_solicitante_delegacao_w 
from	usuario 
where	cd_pessoa_fisica = cd_pessoa_delegacao_w;
 
select	min(nm_usuario) 
into STRICT	nm_usuario_comprador_w 
from	usuario 
where	cd_pessoa_fisica = cd_comprador_w;
 
nm_usuarios_w	:= substr(nm_solicitante_w || ',' || nm_solicitante_delegacao_w || ',' || nm_usuario_comprador_w,1,255);
 
select	nextval('comunic_interna_seq') 
into STRICT	nr_sequencia_w
;
 
select	obter_classif_comunic('F') 
into STRICT	nr_seq_classif_w
;
 
if (ie_tipo_p = 'O') then 
	/*A Ordem de compra: - #@NR_DOCUMENTO#@ terá atraso no seu processo de aprovação*/
 
	ds_comunicado_w	:= wheb_mensagem_pck.get_texto(297629, 'NR_DOCUMENTO=' || nr_ordem_compra_w);
elsif (ie_tipo_p = 'S') then 
	/*A Solicitação de compra: - #@NR_DOCUMENTO#@ terá atraso no seu processo de aprovação*/
 
	ds_comunicado_w	:= wheb_mensagem_pck.get_texto(297632, 'NR_DOCUMENTO=' || nr_solic_compra_w);
elsif (ie_tipo_p = 'R') then 
	/*A Requisição: - #@NR_DOCUMENTO#@ terá atraso no seu processo de aprovação*/
 
	ds_comunicado_w	:= wheb_mensagem_pck.get_texto(297633, 'NR_DOCUMENTO=' || nr_solic_compra_w);
elsif (ie_tipo_p = 'C') then 
	/*A Cotação de compra: - #@NR_DOCUMENTO#@ terá atraso no seu processo de aprovação*/
 
	ds_comunicado_w	:= wheb_mensagem_pck.get_texto(297634, 'NR_DOCUMENTO=' || nr_solic_compra_w);
end if;
 
ds_comunicado_w	:= substr(ds_comunicado_w || /*'Data: '*/
 wheb_mensagem_pck.get_texto(280437) || dt_justificativa_p || chr(13)||chr(10),1,2000);
ds_comunicado_w	:= substr(ds_comunicado_w || /*'Justificativa: '*/
 wheb_mensagem_pck.get_texto(297645) || ds_justificativa_p || chr(13)||chr(10),1,2000);
ds_justificativa_w	:= substr(ds_justificativa_p,1,2000);
 
/*Faz o insert para a justificativa*/
 
insert into proc_aprov_compra_just( 
	nr_sequencia, 
	nr_seq_processo, 
	dt_atualizacao, 
	nm_usuario, 
	dt_justificativa, 
	ds_justificativa) 
values (	nextval('proc_aprov_compra_just_seq'), 
	nr_seq_aprovacao_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	dt_justificativa_p, 
	ds_justificativa_w);
 
/*Faz o insert na comunicação interna*/
 
insert into comunic_interna( 
	dt_comunicado, 
	ds_titulo, 
	ds_comunicado, 
	nm_usuario, 
	dt_atualizacao, 
	ie_geral, 
	nm_usuario_destino, 
	nr_sequencia, 
	ie_gerencial, 
	nr_seq_classif, 
	dt_liberacao) 
values (	clock_timestamp(), 
	wheb_mensagem_pck.get_texto(297646), 
	ds_comunicado_w, 
	nm_usuario_p, 
	clock_timestamp(), 
	'N', 
	nm_usuarios_w, 
	nr_sequencia_w, 
	'n', 
	nr_seq_classif_w, 
	clock_timestamp());
 
/* Envia EMAIL conforme a regra Aprovações pendentes - Ao justificar atraso na aprovação(Avisa solicitante) */
 
begin 
	CALL envia_email_atraso_aprovacao(nr_documento_w, ie_tipo_p, ds_justificativa_p, nm_usuario_p);
exception when others then 
	null;
end;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE avisar_atraso_processo_aprov ( nr_seq_aprovacao_p bigint, nm_usuario_p text, ie_tipo_p text, dt_justificativa_p timestamp, ds_justificativa_p text) FROM PUBLIC;

