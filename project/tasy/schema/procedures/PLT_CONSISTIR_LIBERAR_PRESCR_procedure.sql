-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE plt_consistir_liberar_prescr ( nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE


ie_lib_sem_hor_jejum_w	varchar(1);
ie_apres_inf_adic_w	varchar(1);
ie_obriga_motivo_w	varchar(1);
ie_jejum_sem_hor_w	varchar(1);
ie_libera_prescr_w	varchar(1);
ie_motivo_prescr_w	varchar(3);
ie_origem_inf_w		varchar(1);

BEGIN
if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin
	ie_lib_sem_hor_jejum_w := Obter_Param_Usuario(950, 67, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_lib_sem_hor_jejum_w);
	ie_apres_inf_adic_w := Obter_Param_Usuario(924, 129, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_apres_inf_adic_w);
	ie_obriga_motivo_w := Obter_Param_Usuario(924, 28, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_obriga_motivo_w);

	if (ie_lib_sem_hor_jejum_w <> 'S') then
		begin
		select	CASE WHEN coalesce(count(*),0)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_jejum_sem_hor_w
		from	rep_jejum
		where	nr_prescricao	= nr_prescricao_p;

		if (ie_jejum_sem_hor_w = 'S') then
			begin
			-- Não é possível liberar o plano com um jejum sem data informada. Parâmetro [67]!
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(82035);
			end;
		end if;
		end;
	end if;

	if (ie_apres_inf_adic_w = 'S') then
		begin
		ie_libera_prescr_w := obter_se_libera_prescr(nr_prescricao_p);

		if (ie_libera_prescr_w = 'N') then
			begin
			-- Há procedimentos que exigem informações adicionais que não foram informadas. Os itens do plano terapêutico não serão liberados!
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(82038);
			end;
		end if;
		end;
	end if;

	if (ie_obriga_motivo_w = 'S') then
		begin
		select	ie_motivo_prescricao,
			ie_origem_inf
		into STRICT	ie_motivo_prescr_w,
			ie_origem_inf_w
		from	prescr_medica
		where	nr_prescricao = nr_prescricao_p;

		if (ie_motivo_prescr_w <> '') and (ie_origem_inf_w <> '1') then
			begin
			-- Informe o motivo da prescrição!
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(82047);
			end;
		end if;
		end;
	end if;

	CALL calcular_volume_diluicao(nr_prescricao_p,nm_usuario_p);
	end;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE plt_consistir_liberar_prescr ( nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

