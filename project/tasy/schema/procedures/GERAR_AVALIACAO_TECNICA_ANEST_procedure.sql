-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_avaliacao_tecnica_anest ( nr_seq_tipo_avaliacao_p bigint, nr_seq_tec_anestesica_p bigint, nr_atendimento_p bigint, nr_cirurgia_p bigint, nr_seq_pepo_p bigint) AS $body$
DECLARE


  nr_seq_avaliacao_w med_avaliacao_paciente.nr_sequencia%type;
  cd_medico_w pessoa_fisica.cd_pessoa_fisica%type;
  cd_pessoa_fisica_w pessoa_fisica.cd_pessoa_fisica%type;
  cd_estabelecimento_w estabelecimento.cd_estabelecimento%type := wheb_usuario_pck.get_cd_estabelecimento;
  cd_perfil_w perfil.cd_perfil%type                            := wheb_usuario_pck.get_cd_perfil;
  nm_usuario_w usuario.nm_usuario%type                         := wheb_usuario_pck.get_nm_usuario;


BEGIN

  SELECT cd_profissional
  INTO STRICT cd_medico_w
  FROM CIRURGIA_TEC_ANESTESICA
  WHERE nr_sequencia = nr_seq_tec_anestesica_p;

  IF (nr_cirurgia_p IS NOT NULL AND nr_cirurgia_p::text <> '') THEN
    SELECT cd_pessoa_fisica
    INTO STRICT cd_pessoa_fisica_w
    FROM cirurgia
    WHERE nr_cirurgia   = nr_cirurgia_p;
  ELSIF (nr_seq_pepo_p IS NOT NULL AND nr_seq_pepo_p::text <> '') THEN
    SELECT cd_pessoa_fisica
    INTO STRICT cd_pessoa_fisica_w
    FROM pepo_cirurgia
    WHERE nr_sequencia = nr_seq_pepo_p;
  END IF;

  cd_estabelecimento_w              := wheb_usuario_pck.get_cd_estabelecimento;
  cd_perfil_w                       := wheb_usuario_pck.get_cd_perfil;
  nm_usuario_w                      := wheb_usuario_pck.get_nm_usuario;

  IF (coalesce(nr_seq_tipo_avaliacao_p,0) > 0) AND (coalesce(nr_seq_tec_anestesica_p,0) > 0) THEN
    BEGIN
	
      SELECT nextval('med_avaliacao_paciente_seq') INTO STRICT nr_seq_avaliacao_w;
	
      INSERT
      INTO MED_AVALIACAO_PACIENTE(
          cd_estabelecimento,
          cd_medico,
          cd_perfil_ativo,
          cd_pessoa_fisica,
          dt_atualizacao,
          dt_atualizacao_nrec,
          dt_avaliacao,
          ie_apresentar_web,
          ie_avaliacao_parcial,
          ie_avaliador_aux,
          ie_restricao_visualizacao,
          ie_situacao,
          nm_usuario,
          nm_usuario_nrec,
          nr_atendimento,
          nr_cirurgia,
          nr_seq_pepo,
          nr_seq_tipo_avaliacao,
          nr_seq_tec_anest,
          nr_sequencia
        )
        VALUES (
          cd_estabelecimento_w,
          cd_medico_w,
          cd_perfil_w,
          cd_pessoa_fisica_w,
          clock_timestamp(),
          clock_timestamp(),
          clock_timestamp(),
          'N',
          'N',
          'N',
          'T',
          'A',
          nm_usuario_w,
          nm_usuario_w,
          nr_atendimento_p,
          nr_cirurgia_p,
          nr_seq_pepo_p,
          nr_seq_tipo_avaliacao_p,
          nr_seq_tec_anestesica_p,
          nr_seq_avaliacao_w
        );
      COMMIT;
    EXCEPTION
    WHEN OTHERS THEN
      nr_seq_avaliacao_w := NULL;
    END;
  END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_avaliacao_tecnica_anest ( nr_seq_tipo_avaliacao_p bigint, nr_seq_tec_anestesica_p bigint, nr_atendimento_p bigint, nr_cirurgia_p bigint, nr_seq_pepo_p bigint) FROM PUBLIC;

