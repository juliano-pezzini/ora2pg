-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_transf_novo_atend_pa (nr_atendimento_p bigint, cd_setor_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_atendimento_novo_w	bigint;
cd_unidade_basica_w		varchar(10);
cd_unidade_compl_w		varchar(10);
cd_tipo_acomodacao_w	smallint;
dt_entrada_unidade_w	timestamp;
cd_setor_parametro231_w	integer;
ie_regra_w				varchar(1);
ie_sem_acomodacao_w		varchar(1);

C01 CURSOR FOR 
	SELECT	a.cd_unidade_basica, 
		a.cd_unidade_compl, 
		a.cd_tipo_acomodacao 
	from	tipo_acomodacao b, unidade_atendimento a 
	where	a.cd_setor_atendimento	= cd_setor_atendimento_p 
	and	a.cd_tipo_acomodacao	= b.cd_tipo_acomodacao 
	and	coalesce(b.ie_sem_acomodacao,'N') = ie_sem_acomodacao_w 
	and	a.ie_situacao	= 'A' 
	and	coalesce(a.nr_atendimento::text, '') = '';


BEGIN 
 
select 	coalesce(max(nr_atendimento),0) 
into STRICT	nr_atendimento_novo_w 
from 	atendimento_paciente 
where 	nr_atend_alta = nr_atendimento_p;
 
if (nr_atendimento_novo_w > 0) then 
	/* 
	select	max(a.cd_unidade_basica), 
		max(a.cd_unidade_compl), 
		max(a.cd_tipo_acomodacao) 
	into	cd_unidade_basica_w,	 
		cd_unidade_compl_w, 
		cd_tipo_acomodacao_w 
	from	tipo_acomodacao b, unidade_atendimento a 
	where	a.cd_setor_atendimento	= cd_setor_atendimento_p 
	and	a.cd_tipo_acomodacao	= b.cd_tipo_acomodacao 
	and	b.ie_sem_acomodacao = 'S'; 
 
	*/
 
	 
	cd_setor_parametro231_w := obter_param_usuario(935, 231, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, cd_setor_parametro231_w);
	 
	select	coalesce(max('S'),'N') 
	into STRICT	ie_regra_w 
	from	atendimento_paciente a 
	where	nr_atendimento	= nr_atendimento_p 
	and exists (SELECT	1 
				from	regra_setor_desfecho b 
				where	b.ie_clinica	= a.ie_clinica 
	and	b.ie_tipo_atendimento = a.ie_tipo_atendimento);
	 
	ie_sem_acomodacao_w := 'S';
	if (ie_regra_w = 'N') and (cd_setor_parametro231_w = cd_setor_atendimento_p) then	 
		ie_sem_acomodacao_w := 'N';
	end if;	
	 
	open C01;
	loop 
	fetch C01 into	 
		cd_unidade_basica_w,	 
		cd_unidade_compl_w, 
		cd_tipo_acomodacao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		exit;
	end loop;
	close C01;
		 
	if (cd_unidade_basica_w IS NOT NULL AND cd_unidade_basica_w::text <> '') then 
	 
		select	max(dt_entrada_unidade) 
		into STRICT	dt_entrada_unidade_w 
		from	atend_paciente_unidade 
		where	nr_atendimento	= nr_atendimento_novo_w;
	 
		if (dt_entrada_unidade_w IS NOT NULL AND dt_entrada_unidade_w::text <> '') then 
			dt_entrada_unidade_w	:= (dt_entrada_unidade_w + 86400/86399) - 1;
		else 
			dt_entrada_unidade_w	:= clock_timestamp();
		end if;
	 
		CALL gerar_transferencia_paciente(nr_atendimento_novo_w, cd_setor_atendimento_p, cd_unidade_basica_w, cd_unidade_compl_w, cd_tipo_acomodacao_w, 0, null, null, nm_usuario_p, dt_entrada_unidade_w);
 
	end if;
end if;
 
COMMIT;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_transf_novo_atend_pa (nr_atendimento_p bigint, cd_setor_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

