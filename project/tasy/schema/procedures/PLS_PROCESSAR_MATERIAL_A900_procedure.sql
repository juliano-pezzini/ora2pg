-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_processar_material_a900 ( nr_seq_lote_imp_p bigint, nm_usuario_p text) AS $body$
DECLARE


C01 CURSOR FOR
	-- falhas is not null, significa que ja foi executado pelo menos uma vez, se ja foi executado ao menos uma vez, apaga. durante a execucao ele fica null
	SELECT	job
	from	job_v
	where	lower(comando)	like 'pls_processar_arquivo_a900%'
	and	coalesce(falhas::text, '') = '';

ds_comando_job_w	varchar(2000);
jobno			bigint;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type := wheb_usuario_pck.get_cd_estabelecimento;
	
BEGIN

-- Verificar se a job ja existe, se existir remove
for r_C01_w in C01 loop
	
	update	pls_lote_imp_mat_unimed
	set	dt_fim_importacao	 = NULL,
		dt_inicio_importacao	 = NULL,
		nm_usuario_imp		= nm_usuario_p,
		ie_status		= '4',
		ds_log			= obter_desc_expressao(953962),
		cd_estabelecimento	= cd_estabelecimento_w
	where 	nr_sequencia		= nr_seq_lote_imp_p;
	
	commit;
	return;
end loop;

ds_comando_job_w  := 'pls_processar_arquivo_a900(' 	|| nr_seq_lote_imp_p || ',' -- nr_seq_lote_imp_p
							|| pls_util_pck.aspas_w || nm_usuario_p || pls_util_pck.aspas_w || ',' --nm_usuario_p
							|| pls_util_pck.aspas_w || cd_estabelecimento_w || pls_util_pck.aspas_w || ');';

-- Vai iniciar a procedure em 2.5 segundos apos a conclusao desta e sempre joga a proxima execucao para daqui a 10000 dias
dbms_job.submit(jobno, ds_comando_job_w, clock_timestamp() + interval '216000 seconds' * (1/24/60/60));

-- coloca o id do job responsavel por executar o processo.
update	pls_lote_imp_mat_unimed
set	ie_status 	= '1',
	ds_log		 = NULL
where	nr_sequencia = nr_seq_lote_imp_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_processar_material_a900 ( nr_seq_lote_imp_p bigint, nm_usuario_p text) FROM PUBLIC;

