-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rxt_gerar_agenda_integrada ( cd_pessoa_fisica_p text, cd_convenio_p bigint, nr_seq_tipo_p bigint, nr_seq_integrada_p INOUT bigint, nr_seq_item_p INOUT bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
nr_sequencia_w			bigint;
nr_seq_item_w			bigint;
nr_seq_proc_interno_w	bigint;
nr_seq_trat_proced_w	bigint;
nm_paciente_w			varchar(60);
nr_seq_status_w	bigint;

 
			 

BEGIN 
 
if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then 
	begin 
	 
	nm_paciente_w		:= substr(obter_nome_pf(cd_pessoa_fisica_p),1,60);
	 
	select	nextval('agenda_integrada_seq') 
	into STRICT	nr_sequencia_w 
	;
	 
	SELECT 	MAX(nr_sequencia) 
	into STRICT	nr_seq_status_w 
	FROM 	agenda_integrada_status 
	WHERE 	ie_status_tasy = 'EA';
	 
	 
	insert 	into agenda_integrada(nr_sequencia     , 
			dt_atualizacao     , 
			nm_usuario       , 
			dt_atualizacao_nrec  , 
			nm_usuario_nrec    , 
			dt_inicio_agendamento , 
			dt_fim_agendamento   , 
			nr_seq_status     , 
			cd_pessoa_fisica    , 
			nm_paciente      , 
			cd_convenio      , 
			ie_turno	    ,	 
			cd_estabelecimento) 
	values (nr_sequencia_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			null, 
			nr_seq_status_w, 
			cd_pessoa_fisica_p, 
			nm_paciente_w, 
			cd_convenio_p, 
			2, 
			cd_estabelecimento_p);
 
	select	nextval('agenda_integrada_item_seq') 
	into STRICT	nr_seq_item_w 
	;	
	 
	insert 	into agenda_integrada_item(nr_sequencia    , 
		nr_seq_agenda_int  , 
		dt_atualizacao   ,  
		nm_usuario     ,  
		dt_atualizacao_nrec ,  
		nm_usuario_nrec   ,  
		nr_seq_proc_interno ,  
		ie_tipo_agendamento ,  
		cd_medico      ,  
		cd_especialidade  ,  
		vl_item       ,  
		ie_regra      ,  
		nr_seq_agenda_cons ,  
		nr_seq_agenda_exame ) 
	values (nr_seq_item_w, 
		nr_sequencia_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_seq_proc_interno_w, 
		'S', 
		null, 
		null, 
		null, 
		null, 
		null, 
		null);
		 
	select	coalesce(max(nr_sequencia),0) 
	into STRICT	nr_seq_trat_proced_w 
	from	rxt_tipo_trat_proced 
	where	nr_seq_tipo = nr_seq_tipo_p;
	 
	select	coalesce(max(nr_seq_proc_interno),0) 
	into STRICT	nr_seq_proc_interno_w 
	from	rxt_tipo_trat_proced 
	where	nr_sequencia = nr_seq_trat_proced_w;
 
	if (coalesce(nr_seq_proc_interno_w,0) > 0) then 
	 
		update	agenda_integrada_item 
		set		nr_seq_proc_interno = nr_seq_proc_interno_w 
		where	nr_seq_agenda_int = nr_sequencia_w 
		and		nr_sequencia = nr_seq_item_w;
	 
	end if;
	 
	 
	if (nr_seq_item_w > 0) then 
		CALL ageint_gerar_proc_Assoc(nr_sequencia_w, nr_seq_item_w, nr_seq_proc_interno_w, nm_usuario_p, null );
	end if;
		 
	end;
end if;
 
nr_seq_integrada_p	:= nr_sequencia_w;
nr_seq_item_p		:= nr_seq_item_w;	
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rxt_gerar_agenda_integrada ( cd_pessoa_fisica_p text, cd_convenio_p bigint, nr_seq_tipo_p bigint, nr_seq_integrada_p INOUT bigint, nr_seq_item_p INOUT bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

