-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_atualizar_nfse_lote ( ds_conteudo_p text, nm_usuario_p text) AS $body$
DECLARE

			
nr_seq_nota_w	nota_fiscal.nr_sequencia%type;
nr_seq_nfes_w	nota_fiscal.nr_nfe_imp%type;
ie_existe_nf_w	bigint;
cd_serie_w	nota_fiscal.cd_serie_nf%type;
cd_estab_w	nota_fiscal.cd_estabelecimento%type;
ie_existe_nfse_w	varchar(2) := 'N';


BEGIN

nr_seq_nota_w := obter_valor_separador(ds_conteudo_p,1,'|');
nr_seq_nfes_w := obter_valor_separador(ds_conteudo_p,2,'|');

select 	count(*)
into STRICT	ie_existe_nf_w
from	nota_fiscal
where	nr_sequencia = nr_seq_nota_w;

if (ie_existe_nf_w > 0) then
	
	select 	cd_serie_nf,
		cd_estabelecimento
	into STRICT	cd_serie_w,
		cd_estab_w
	from	nota_fiscal
	where	nr_sequencia = nr_seq_nota_w;
	
	select	obter_se_existe_nfse(nr_seq_nfes_w, cd_serie_w, cd_estab_w)
	into STRICT		ie_existe_nfse_w
	;
	
	if (ie_existe_nfse_w = 'N') then
		update	nota_fiscal
		set	nr_nfe_imp	= nr_seq_nfes_w,
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp()
		where	nr_sequencia	= nr_seq_nota_w;
		
		commit;
		
	end if;
	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_atualizar_nfse_lote ( ds_conteudo_p text, nm_usuario_p text) FROM PUBLIC;

