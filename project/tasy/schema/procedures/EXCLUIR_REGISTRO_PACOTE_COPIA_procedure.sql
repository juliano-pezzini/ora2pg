-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE excluir_registro_pacote_copia ( cd_conv_dest_p text, cd_conv_origem_p bigint, ie_menos_selec_p text, ie_somente_ativo_p text, ie_regra_proc_p text, ie_regra_mat_p text, ie_regra_tipo_acomod_p text, ie_regra_formadores_p text, ie_regra_doc_p text, nm_usuario_p text) AS $body$
DECLARE


cd_convenio_w	integer;
nr_seq_pacote_ww	bigint;
nr_sequencia_w	bigint;
ie_excluir_w	varchar(1) := 'S';

c01 CURSOR FOR
	SELECT	cd_convenio
	from	convenio
	where	cd_convenio <> cd_conv_origem_p
	and	(((ie_menos_selec_p = '1') and (obter_se_contido(cd_convenio, elimina_aspas(cd_conv_dest_p)) = 'S')) or
		((ie_menos_selec_p = '2') and (obter_se_contido(cd_convenio, elimina_aspas(cd_conv_dest_p)) = 'N')))
	order by cd_convenio;

C02 CURSOR FOR
	SELECT	nr_seq_pacote
	from	pacote
	where	cd_convenio = cd_convenio_w
	and	((ie_situacao = 'A') or (ie_somente_ativo_p = 'N'));

C03 CURSOR FOR
	SELECT	nr_sequencia
	from	pacote_tipo_acomodacao
	where	nr_seq_pacote = nr_seq_pacote_ww;


BEGIN

open C01;
loop
fetch C01 into
	cd_convenio_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	open C02;
	loop
	fetch C02 into
		nr_seq_pacote_ww;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		if (ie_regra_formadores_p = 'S') then

			delete	from pacote_formadores
			where	nr_seq_pacote = nr_seq_pacote_ww;

		end if;

		if (ie_regra_mat_p = 'S') then

			delete	from pacote_material_adic
			where	nr_seq_pacote = nr_seq_pacote_ww;

			delete	from pacote_material
			where	nr_seq_pacote = nr_seq_pacote_ww;

		end if;

		if (ie_regra_proc_p = 'S') then

			delete	from pacote_procedimento
			where	nr_seq_pacote = nr_seq_pacote_ww;

		end if;

		if (ie_regra_tipo_acomod_p = 'S') then

			open c03;
			loop
			fetch c03 into
				nr_sequencia_w;
			EXIT WHEN NOT FOUND; /* apply on c03 */
				begin

				delete	from regra_pacote_hora_final
				where	nr_seq_pac_acomod = nr_sequencia_w;

				delete	from pacote_tipo_acomod_proc
				where	nr_seq_pac_acomod = nr_sequencia_w;

				delete	from pacote_tipo_acomod_mat
				where	nr_seq_pac_acomod = nr_sequencia_w;

				delete	from pacote_material
				where	nr_seq_pacote = nr_seq_pacote_ww
				and	(nr_seq_pac_acomod IS NOT NULL AND nr_seq_pac_acomod::text <> '');

				delete	from pacote_procedimento
				where	nr_seq_pacote = nr_seq_pacote_ww
				and	(nr_seq_pac_acomod IS NOT NULL AND nr_seq_pac_acomod::text <> '');

				end;
			end loop;
			close c03;

			delete	from pacote_tipo_acomodacao
			where	nr_seq_pacote = nr_seq_pacote_ww;

		end if;

		if (ie_regra_doc_p = 'S') then

			delete	from pacote_doc
			where	nr_seq_pacote = nr_seq_pacote_ww;

		end if;

		end;
	end loop;
	close C02;

	begin

	if (ie_regra_proc_p = 'S') and (ie_regra_mat_p = 'S') and (ie_regra_tipo_acomod_p = 'S') and (ie_regra_formadores_p = 'S') and (ie_regra_doc_p = 'S') then

		delete	from pacote
		where	cd_convenio = cd_convenio_w;

	end if;

	exception
	when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(229746);
	end;

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE excluir_registro_pacote_copia ( cd_conv_dest_p text, cd_conv_origem_p bigint, ie_menos_selec_p text, ie_somente_ativo_p text, ie_regra_proc_p text, ie_regra_mat_p text, ie_regra_tipo_acomod_p text, ie_regra_formadores_p text, ie_regra_doc_p text, nm_usuario_p text) FROM PUBLIC;

