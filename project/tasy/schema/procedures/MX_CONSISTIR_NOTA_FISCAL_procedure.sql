-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mx_consistir_nota_fiscal ( nr_sequencia_p bigint, ds_msg_p INOUT text) AS $body$
DECLARE



ds_serie_w					nf_imp_nota.ds_serie%type;
ds_numero_w					nf_imp_nota.ds_numero%type;
dt_emissao_w				nf_imp_nota.dt_emissao%type;
vl_total_w					nf_imp_nota.vl_total%type;
nr_ident_emissor_w			nf_imp_nota.nr_ident_emissor%type;
vl_imposto_w				nf_imp_nota_imposto.vl_imposto%type;
cd_imposto_interno_w		nf_imp_nota_imposto.cd_imposto_interno%type;
cd_operacao_nf_w			nf_imp_nota.cd_operacao_nf%type;
ds_consist_serie_w			varchar(2000);
ds_consist_numero_w			varchar(2000);
ds_consist_emissao_w		varchar(2000);
ds_consist_total_w			varchar(2000);
ds_consist_ident_emissor_w	varchar(2000);
ds_consist_vl_imposto_w		varchar(2000);
ds_consist_cd_imposto_w		varchar(2000);
ds_consist_cd_operacao_w	varchar(2000);
/*verifica valores obrigatorios antes de inserir na nota_fiscal*/

c01 CURSOR FOR

	SELECT	nf.ds_serie,
			nf.ds_numero,
			nf.dt_emissao,
			nf.vl_total,
			nf.nr_ident_emissor,
			trib.vl_imposto,
			trib.cd_imposto_interno,
			nf.cd_operacao_nf
	from	nf_imp_nota nf
	left join
		 	nf_imp_nota_imposto trib on trib.nr_seq_nf_imp_nota = nf.nr_sequencia
	where	nf.nr_sequencia = nr_sequencia_p;


BEGIN

ds_msg_p := null;

	open c01;
	loop
	fetch c01 into
			ds_serie_w,
			ds_numero_w,
			dt_emissao_w,
			vl_total_w,
			nr_ident_emissor_w,
			vl_imposto_w,
			cd_imposto_interno_w,
			cd_operacao_nf_w;

	EXIT WHEN NOT FOUND; /* apply on c01 */


	if (coalesce(ds_serie_w::text, '') = '') then
		if (	coalesce(ds_consist_serie_w::text, '') = '')then
			ds_consist_serie_w  := obter_desc_expressao(621872);/*É necessário informar a série da nota fiscal*/
			ds_msg_p := ds_consist_serie_w || ';' || ds_msg_p;
		end if;
	end if;
	if ( coalesce(ds_numero_w::text, '') = '')then
		if ( coalesce(ds_consist_numero_w::text, '') = '' )then
			ds_consist_numero_w := obter_desc_expressao(614756);/*É obrigatório informar o número da nota fiscal.*/
			ds_msg_p := ds_consist_numero_w || ';' || ds_msg_p;
		end if;
	end if;
	if ( coalesce(dt_emissao_w::text, '') = '')then
		if ( coalesce(ds_consist_emissao_w::text, '') = '' )then
			ds_consist_emissao_w := obter_desc_expressao(872810);/*A data de emissão da nota fiscal deve ser informada*/
			ds_msg_p := ds_consist_emissao_w || ';' || ds_msg_p;
		end if;
	end if;
	if ( coalesce(vl_total_w::text, '') = '')then
		if ( coalesce(ds_consist_total_w::text, '') = '' )then
			ds_consist_total_w := obter_desc_expressao(872814);/*O valor da nota fiscal deve ser informado.*/
			ds_msg_p := ds_consist_total_w || ';' || ds_msg_p;
		end if;
	end if;
	if ( coalesce(nr_ident_emissor_w::text, '') = '')then
		if ( coalesce(ds_consist_ident_emissor_w::text, '') = '' )then
			ds_consist_ident_emissor_w := obter_desc_expressao(872816);/*O emissor da nota fiscal deve ser informado*/
			ds_msg_p := ds_consist_ident_emissor_w || ';' || ds_msg_p;
		end if;
	end if;
	if ( coalesce(vl_imposto_w::text, '') = '')then
		if (	coalesce(ds_consist_vl_imposto_w::text, '') = '' )then
			ds_consist_vl_imposto_w := obter_desc_expressao(872818);/*O valor dos impostos da nota fiscal deve ser informado*/
			ds_msg_p := ds_consist_vl_imposto_w || ';' || ds_msg_p;
		end if;
	end if;
	if ( coalesce(cd_imposto_interno_w::text, '') = '')then
		if (	coalesce(ds_consist_cd_imposto_w::text, '') = '' )then
			ds_consist_cd_imposto_w := obter_desc_expressao(872820);/*O código do imposto correspondente deve ser informado.*/
			ds_msg_p := ds_consist_cd_imposto_w || ';' || ds_msg_p;
		end if;
	end if;
	if ( coalesce(cd_operacao_nf_w::text, '') = '')then
		if (	coalesce(ds_consist_cd_operacao_w::text, '') = '' )then
			ds_consist_cd_operacao_w := obter_desc_expressao(503565);/*A operação deve ser informada.*/
			ds_msg_p := ds_consist_cd_operacao_w || ';' || ds_msg_p;
		end if;
	end if;

end loop;

close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mx_consistir_nota_fiscal ( nr_sequencia_p bigint, ds_msg_p INOUT text) FROM PUBLIC;

