-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_email_negociacao_audit () AS $body$
DECLARE

 
cd_estabelecimento_w		bigint;
ds_estabelecimento_w		varchar(255);
cd_convenio_w			bigint;
ds_convenio_w			varchar(255);

nr_processo_w			varchar(255);
nr_seq_lote_audit_w		bigint;
nr_seq_analise_w		bigint;
nr_analise_w			varchar(255);
nr_registro_w			bigint;
dt_envio_w			timestamp;
vl_saldo_conta_w		double precision;
vl_glosa_informada_w		double precision;
vl_glosa_aceita_w		double precision;
vl_reapresentacao_w		double precision;
dt_prevista_contato_w		timestamp;
dt_ultimo_contato_w		timestamp;
qt_dias_ultimo_contato_w	bigint;

vl_tot_saldo_conta_w		double precision	:= 0;
vl_tot_glosa_informada_w	double precision	:= 0;
vl_tot_glosa_aceita_w		double precision	:= 0;
vl_tot_reapresentacao_w		double precision	:= 0;

ds_assunto_w			varchar(255);
ds_comunicado_w			varchar(4000);
ds_comunicado_estab_w		varchar(4000);
ds_comunicado_conv_w		varchar(4000);
ds_comunicado_lotes_w		varchar(4000);
ds_comunicado_lotes_2_w		varchar(4000);
ds_macros_w			varchar(4000);
ds_total_convenio_w		varchar(2000);
ds_email_remetente_w		varchar(255);
qt_dias_negociacao_w		smallint;
nr_seq_regra_w			bigint;
nm_usuario_remetente_w		varchar(15);

nm_usuario_w			varchar(15);
ds_email_dest_w			varchar(255);
ds_email_lista_w		varchar(2000);

ds_lista_lotes_w		varchar(2000);

c01 CURSOR FOR 
SELECT	nr_sequencia, 
	ds_assunto, 
	ds_comunicado, 
	ds_email_remetente, 
	qt_dias_negociacao, 
	nm_usuario_remetente 
from	regra_comunic_negoc_audit 
where	(qt_dias_negociacao IS NOT NULL AND qt_dias_negociacao::text <> '') 
and	ie_situacao		= 'A';

 
c02 CURSOR FOR 
SELECT	substr(obter_nome_estabelecimento(a.cd_estabelecimento),1,255) ds_estabelecimento, 
	substr(obter_nome_convenio(a.cd_convenio),1,255) ds_convenio, 
	a.NR_PROCESO, 
	a.nr_sequencia nr_seq_lote_audit, 
	b.nr_sequencia nr_seq_analise, 
	(to_char(nr_analise) || wheb_mensagem_pck.get_texto(802244)) nr_analise, 
	a.NR_REGISTRO, 
	b.DT_ENVIO, 
	sum(coalesce(obter_saldo_conpaci(c.nr_interno_conta,c.cd_autorizacao),0)) vl_saldo_conta, 
	sum((SELECT	coalesce(sum(x.vl_glosa_informada),0) 
	from	lote_audit_hist_item x 
	where	x.nr_seq_guia	= c.nr_sequencia)) vl_glosa_informada, 
	sum(obter_valores_guia_grc(c.nr_seq_lote_hist,c.nr_interno_conta,c.cd_autorizacao,'VG')) vl_glosa_aceita, 
	sum(obter_valores_guia_grc(c.nr_seq_lote_hist,c.nr_interno_conta,c.cd_autorizacao,'VA')) vl_reapresentacao, 
	to_date(OBTER_DADOS_NEGOCIACAO_AUDIT(a.nr_sequencia,'2'),'dd/mm/yyyy hh24:mi:ss') dt_prevista_contato, 
	to_date(OBTER_DADOS_NEGOCIACAO_AUDIT(a.nr_sequencia,'3'),'dd/mm/yyyy hh24:mi:ss') dt_ultimo_contato, 
	(OBTER_DADOS_NEGOCIACAO_AUDIT(a.nr_sequencia,'4'))::numeric  qt_dias_ultimo_contato 
from	lote_auditoria a, 
	lote_audit_hist b, 
	lote_audit_hist_guia c, 
	conta_paciente d, 
	titulo_receber e 
where	a.nr_sequencia		= b.nr_seq_lote_audit 
and	b.nr_sequencia		= c.NR_SEQ_LOTE_HIST 
and	c.nr_interno_conta	= d.nr_interno_conta 
and	e.nr_titulo		= (obter_titulo_conta_guia(c.nr_interno_conta,c.cd_autorizacao,null,null))::numeric  
and	coalesce(obter_saldo_conpaci(c.nr_interno_conta,c.cd_autorizacao),0) > 0 
and	(OBTER_DADOS_NEGOCIACAO_AUDIT(a.nr_sequencia,'4'))::numeric  > qt_dias_negociacao_w 
group by substr(obter_nome_estabelecimento(a.cd_estabelecimento),1,255), 
	substr(obter_nome_convenio(a.cd_convenio),1,255), 
	a.NR_PROCESO, 
	a.nr_sequencia, 
	b.nr_sequencia, 
	(to_char(nr_analise) || wheb_mensagem_pck.get_texto(802244)), 
	a.NR_REGISTRO, 
	b.DT_ENVIO, 
	to_date(OBTER_DADOS_NEGOCIACAO_AUDIT(a.nr_sequencia,'2'),'dd/mm/yyyy hh24:mi:ss'), 
	to_date(OBTER_DADOS_NEGOCIACAO_AUDIT(a.nr_sequencia,'3'),'dd/mm/yyyy hh24:mi:ss'), 
	(OBTER_DADOS_NEGOCIACAO_AUDIT(a.nr_sequencia,'4'))::numeric  
order by ds_convenio;

c03 CURSOR FOR 
SELECT	nm_usuario_dest, 
	ds_email_destinario 
from	regra_comunic_negoc_dest 
where	nr_seq_regra	= nr_seq_regra_w;

c04 CURSOR FOR 
SELECT	distinct nr_sequencia 
from	lote_auditoria 
where	obter_se_contido(nr_sequencia,nr_seq_lote_audit_w) = 'S';


BEGIN 
 
open C01;
loop 
fetch C01 into 
	nr_seq_regra_w, 
	ds_assunto_w, 
	ds_macros_w, 
	ds_email_remetente_w, 
	qt_dias_negociacao_w, 
	nm_usuario_remetente_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
 
	ds_comunicado_w	:= '';
 
	ds_lista_lotes_w := null;
 
	open C02;
	loop 
	fetch C02 into 
		ds_estabelecimento_w, 
		ds_convenio_w, 
		nr_processo_w, 
		nr_seq_lote_audit_w, 
		nr_seq_analise_w, 
		nr_analise_w, 
		nr_registro_w, 
		dt_envio_w, 
		vl_saldo_conta_w, 
		vl_glosa_informada_w, 
		vl_glosa_aceita_w, 
		vl_reapresentacao_w, 
		dt_prevista_contato_w, 
		dt_ultimo_contato_w, 
		qt_dias_ultimo_contato_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		 
		if (ds_comunicado_lotes_w IS NOT NULL AND ds_comunicado_lotes_w::text <> '') then 
			ds_comunicado_lotes_w	:= ds_comunicado_lotes_w || chr(10) || chr(13) || chr(10) || chr(13) || ds_macros_w;
		else 
			ds_comunicado_lotes_w	:= ds_macros_w;
		end if;
 
		ds_comunicado_lotes_w	:= substr(replace_macro(ds_comunicado_lotes_w,'@nr_processo',nr_processo_w),1,4000);
		ds_comunicado_lotes_w	:= substr(replace_macro(ds_comunicado_lotes_w,'@nr_lote_registro',nr_registro_w),1,4000);
		ds_comunicado_lotes_w	:= substr(replace_macro(ds_comunicado_lotes_w,'@dt_envio',to_char(dt_envio_w,'dd/mm/yyyy')),1,4000);
		ds_comunicado_lotes_w	:= substr(replace_macro(ds_comunicado_lotes_w,'@nr_seq_analise',nr_seq_analise_w),1,4000);
		ds_comunicado_lotes_w	:= substr(replace_macro(ds_comunicado_lotes_w,'@dt_prev_contato',to_char(dt_prevista_contato_w,'dd/mm/yyyy hh24:mi:ss')),1,4000);
		ds_comunicado_lotes_w	:= substr(replace_macro(ds_comunicado_lotes_w,'@dt_ultimo_contato',to_char(dt_ultimo_contato_w,'dd/mm/yyyy hh24:mi:ss')),1,4000);
		ds_comunicado_lotes_w	:= substr(replace_macro(ds_comunicado_lotes_w,'@qt_dias_ultimo_contato',qt_dias_ultimo_contato_w),1,4000);
		ds_comunicado_lotes_w	:= substr(replace_macro(ds_comunicado_lotes_w,'@vl_glosa_informada',Campo_Mascara_virgula(vl_glosa_informada_w)),1,4000);
		ds_comunicado_lotes_w	:= substr(replace_macro(ds_comunicado_lotes_w,'@vl_glosa_aceita',Campo_Mascara_virgula(vl_glosa_aceita_w)),1,4000);
		ds_comunicado_lotes_w	:= substr(replace_macro(ds_comunicado_lotes_w,'@vl_reapresentacao',Campo_Mascara_virgula(vl_reapresentacao_w)),1,4000);
		ds_comunicado_lotes_w	:= substr(replace_macro(ds_comunicado_lotes_w,'@vl_saldo',Campo_Mascara_virgula(vl_saldo_conta_w)),1,4000);
		ds_comunicado_lotes_w	:= substr(replace_macro(ds_comunicado_lotes_w,'@vl_saldo',Campo_Mascara_virgula(vl_saldo_conta_w)),1,4000);
		ds_comunicado_lotes_w	:= substr(replace_macro(ds_comunicado_lotes_w,'@sysdate',to_char(clock_timestamp(),'dd/mm/yyyy')),1,4000);
		ds_comunicado_lotes_w	:= substr(replace_macro(ds_comunicado_lotes_w,'@estabelecimento',ds_estabelecimento_w),1,4000);
		ds_comunicado_lotes_w	:= substr(replace_macro(ds_comunicado_lotes_w,'@convenio',ds_convenio_w),1,4000);
 
		ds_lista_lotes_w	:= ds_lista_lotes_w || nr_seq_lote_audit_w || ',';
 
		end;
 
	end loop;
	close C02;
 
	ds_comunicado_w	:= ds_comunicado_w || ds_comunicado_lotes_w;
 
	if (ds_comunicado_lotes_w IS NOT NULL AND ds_comunicado_lotes_w::text <> '') then 
 
		open C03;
		loop 
		fetch C03 into 
			nm_usuario_w, 
			ds_email_dest_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin 
 
			if (nm_usuario_w IS NOT NULL AND nm_usuario_w::text <> '') and ((Obter_Dados_Usuario_Opcao(nm_usuario_w,'E') IS NOT NULL AND (Obter_Dados_Usuario_Opcao(nm_usuario_w,'E'))::text <> '')) then 
 
				ds_email_lista_w	:= ds_email_lista_w || trim(both Obter_Dados_Usuario_Opcao(nm_usuario_w,'E')) ||',';
 
			elsif (ds_email_dest_w IS NOT NULL AND ds_email_dest_w::text <> '') then 
 
				ds_email_lista_w	:= ds_email_lista_w || trim(both ds_email_dest_w) ||',';
 
			end if;
 
			end;
		end loop;
		close C03;
 
		CALL enviar_email( ds_assunto_w, ds_comunicado_w ,ds_email_remetente_w, ds_email_lista_w, nm_usuario_remetente_w, 'M');
 
	end if;
 
	open C04;
	loop 
	fetch C04 into 
		nr_seq_lote_audit_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
		begin 
 
		insert	into NEGOCIACAO_LOTE_AUDIT_ENV(nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			nr_seq_lote_audit, 
			ds_email_destinatarios, 
			ds_email_remetente, 
			ds_email) 
		values (nextval('negociacao_lote_audit_env_seq'), 
			clock_timestamp(), 
			nm_usuario_remetente_w, 
			clock_timestamp(), 
			nm_usuario_remetente_w, 
			nr_seq_lote_audit_w, 
			ds_email_lista_w, 
			ds_email_remetente_w, 
			ds_comunicado_w);
		end;
	end loop;
	close C04;
	 
	commit;
 
	end;
end loop;
close C01;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_email_negociacao_audit () FROM PUBLIC;

