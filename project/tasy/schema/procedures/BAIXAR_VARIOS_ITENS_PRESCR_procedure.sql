-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baixar_varios_itens_prescr (nr_prescricao_p bigint, cd_motivo_baixa_p bigint, cd_grupo_material_p bigint, ie_urgencia_p text, cd_estabelecimento_p bigint, cd_motivo_baixa_query_p bigint, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE


cd_grupo_mat_w				bigint;
cd_motivo_baixa_w			smallint;
qt_material_w				bigint;
qt_dias_liberado_w			smallint;
qt_dias_solicitado_w			smallint;
qt_total_dispensar_w			double precision;
nr_sequencia_w				integer;
cd_material_w				integer;
nr_seq_lote_fornec_w			bigint;
cd_material_baixa_w			integer;
ie_proximo_w				varchar(1) := 'N';
MedicNaoLib_w			 	bigint := 0;
ItemReprovCCIH_w			bigint := 0;
ie_conta_paciente_w			varchar(1);
ds_erro_w				varchar(255);
Varcd_tipo_baixa_incorreta_w 	 	varchar(1);/*Parâmetro 45*/
VarNaoConsisteQtDisp_w			varchar(1);	/*Parâmetro 46*/
C01 CURSOR FOR
	SELECT	a.cd_grupo_mat,
		b.cd_motivo_baixa,
		b.qt_material,
		b.qt_dias_liberado,
		b.qt_dias_solicitado,
		b.qt_total_dispensar,
		b.nr_sequencia,
		b.cd_material,
		b.nr_seq_lote_fornec,
		b.cd_material_baixa
	from	w_prescr_material a,
		prescr_material   b
	where 	a.nr_prescricao = b.nr_prescricao
	and   	a.nr_sequencia_prescricao = b.nr_sequencia
	and	a.nr_prescricao = nr_prescricao_p
	and 	((a.ie_urgencia = ie_urgencia_p) or (coalesce(ie_urgencia_p::text, '') = ''))
	order by a.nr_sequencia;


BEGIN

Varcd_tipo_baixa_incorreta_w := obter_param_usuario(7025, 45, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, Varcd_tipo_baixa_incorreta_w);
VarNaoConsisteQtDisp_w := obter_param_usuario(7025, 46, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, VarNaoConsisteQtDisp_w);

open C01;
loop
fetch C01 into
		cd_grupo_mat_w,
		cd_motivo_baixa_w,
		qt_material_w,
		qt_dias_liberado_w,
		qt_dias_solicitado_w,
		qt_total_dispensar_w,
		nr_sequencia_w,
		cd_material_w,
		nr_seq_lote_fornec_w,
		cd_material_baixa_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ie_proximo_w	:= 'N';
	if (cd_motivo_baixa_w = 0) then

		if (cd_grupo_material_p <> 0) and (cd_grupo_material_p <> cd_grupo_mat_w) then

			ie_proximo_w:= 'S';

               end if;

	       if (ie_proximo_w = 'N') then

			if (qt_material_w = 0) and (Varcd_tipo_baixa_incorreta_w <> '0') and (Verifica_saldo_baixar(nr_prescricao_p,nr_sequencia_w,cd_estabelecimento_p,
						       cd_motivo_baixa_query_p, nm_usuario_p) = 'S') then

				update	prescr_material
				set	dt_baixa = clock_timestamp(),
					cd_motivo_baixa = somente_numero(Varcd_tipo_baixa_incorreta_w)
				where	nr_prescricao = nr_prescricao_p
				and 	nr_sequencia = nr_sequencia_w;

			else

				if (coalesce(qt_dias_liberado_w::text, '') = '') and (not(coalesce(qt_dias_solicitado_w::text, '') = '')) then
					MedicNaoLib_w:= MedicNaoLib_w + 1;
				end if;

				if 	((VarNaoConsisteQtDisp_w = 'S') or (qt_Total_Dispensar_w = qt_material_w)) and (qt_Total_Dispensar_w > 0) and
					((coalesce(qt_dias_solicitado_w::text, '') = '') or
					((not(coalesce(qt_dias_liberado_w::text, '') = '')) and (qt_dias_liberado_w <> 0 ))) then

					select 	coalesce(max(ie_conta_paciente),'N')
					into STRICT	ie_conta_paciente_w
					from 	tipo_baixa_prescricao
					where 	cd_tipo_baixa = cd_motivo_baixa_query_p;

					if (ie_conta_paciente_w = 'N') and (cd_motivo_baixa_p <> 0) then

						CALL Atualiza_Baixa_Prescr_Material( nr_prescricao_p,
										nr_sequencia_w,
										clock_timestamp(), cd_motivo_baixa_query_p,
										0, cd_estabelecimento_p, nm_usuario_p);
					/*else


						 if  Baixar_Prescricao_Material then
							Atualiza_Baixa_Prescr_Material( nr_prescricao_p,
										nr_sequencia_w,
										sysdate, cd_motivo_baixa_query_p,
										0, cd_estabelecimento_p, nm_usuario_p);
						end if;*/
					end if;
				else

					if (qt_Total_Dispensar_w = 0) then

						update	prescr_material
						set	dt_baixa 	  = clock_timestamp(),
							cd_motivo_baixa   = cd_motivo_baixa_query_p,
							cd_material_baixa = cd_material_baixa
						where 	nr_prescricao 	  = nr_prescricao_p
						and 	nr_sequencia	  = nr_sequencia_w;

					end if;

					if (qt_dias_liberado_w = 0) then
						ItemReprovCCIH_w:= ItemReprovCCIH_w + 1;
					end if;

				end if;

			end if;
		end if;
	end if;
	end;
end loop;
close C01;

ds_erro_w:=	' ';

if (MedicNaoLib_w > 0) then
	ds_erro_w:= ds_erro_w + wheb_mensagem_pck.get_texto(278845, 'MED_NAO_LIBERADO_P=' || MedicNaoLib_w);
end if;

if (ItemReprovCCIH_w > 0) then
	if (MedicNaoLib_w > 0) then
		ds_erro_w:= ds_erro_w + ' e ';
	end if;
	ds_erro_w:= ds_erro_w + wheb_mensagem_pck.get_texto(278848, 'ITEM_REPROVADO_P=' || ItemReprovCCIH_w);
end if;

ds_erro_p:= ds_erro_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baixar_varios_itens_prescr (nr_prescricao_p bigint, cd_motivo_baixa_p bigint, cd_grupo_material_p bigint, ie_urgencia_p text, cd_estabelecimento_p bigint, cd_motivo_baixa_query_p bigint, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

