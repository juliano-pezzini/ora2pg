-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sup_confirma_receb_lote_unit (cd_local_estoque_p bigint, cd_local_est_origem_p bigint, ie_consiste_valid_p text, dt_validade_lote_p text, cd_material_lote_p bigint, nr_sequencia_p bigint, nr_seq_motivo_unit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ds_erro_w		varchar(4000);
nr_seq_motivo_unit_w	bigint;
cd_local_estoque_w	bigint;
dt_validade_lote_w	timestamp;
cd_local_est_padrao_w	bigint;


BEGIN 
	-- Verifica o local de origem para verificar se o local de recebimento foi informado 
	if (cd_local_est_origem_p IS NOT NULL AND cd_local_est_origem_p::text <> '') then 
		if (coalesce(cd_local_estoque_p::text, '') = '') then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(231459);
		else 
			cd_local_estoque_w := cd_local_estoque_p;
		end if;
	end if;
	 
	-- Verifica o parâmetro [306] e realiza a validação do lote 
	if (coalesce(ie_consiste_valid_p,'R') = 'R') then 
		-- Verifica se a validade não é Indeterminada 
		if (dt_validade_lote_p <> wheb_mensagem_pck.get_texto(689324)) then 
			select	obter_dados_lote_fornec_dt(nr_seq_lote_fornec,'V') 
			into STRICT	dt_validade_lote_w 
			from	solic_unitarizacao 
			where	nr_sequencia = nr_sequencia_p;
			 
			SELECT * FROM calcula_val_lote_unit(cd_estabelecimento_p, cd_material_lote_p, dt_validade_lote_w, ds_erro_w) INTO STRICT dt_validade_lote_w, ds_erro_w;
			 
			if (coalesce(ds_erro_w,'') <> '') then 
				if (coalesce(nr_seq_motivo_unit_p::text, '') = '') then 
					CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_erro_w);
				else 
					nr_seq_motivo_unit_w := nr_seq_motivo_unit_p;
				end if;
			end if;
		end if;
	end if;
	 
	CALL sup_receb_solic_unitarizacao(nr_sequencia_p, 
					obter_pessoa_fisica_usuario(nm_usuario_p,'C'), 
					clock_timestamp(), 
					cd_local_estoque_w, 
					nr_seq_motivo_unit_w, 
					nm_usuario_p);
	 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_confirma_receb_lote_unit (cd_local_estoque_p bigint, cd_local_est_origem_p bigint, ie_consiste_valid_p text, dt_validade_lote_p text, cd_material_lote_p bigint, nr_sequencia_p bigint, nr_seq_motivo_unit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

