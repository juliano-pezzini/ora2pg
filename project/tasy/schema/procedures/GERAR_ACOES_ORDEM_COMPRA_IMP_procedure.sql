-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_acoes_ordem_compra_imp ( nr_ordem_compra_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ie_liberar_ordem_cotacao_w	parametro_compras.ie_liberar_ordem_cotacao%type;
nr_item_oci_w			ordem_compra_item.nr_item_oci%type;
qt_registros_w			bigint;
qt_dia_prazo_entrega_w		pessoa_juridica_estab.qt_dia_prazo_entrega%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
cd_cgc_fornecedor_w		ordem_compra.cd_cgc_fornecedor%type;
qt_material_w			ordem_compra_item.qt_material%type;

c01 CURSOR FOR 
SELECT	nr_item_oci, 
	qt_material 
from	ordem_compra_item 
where	nr_ordem_compra = nr_ordem_compra_p;


BEGIN 
 
select	a.cd_estabelecimento, 
	a.cd_cgc_fornecedor, 
	ie_liberar_ordem_cotacao 
into STRICT	cd_estabelecimento_w, 
	cd_cgc_fornecedor_w, 
	ie_liberar_ordem_cotacao_w 
from	ordem_compra a, 
	parametro_compras b 
where	a.cd_estabelecimento = b.cd_estabelecimento 
and	a.nr_ordem_compra = nr_ordem_compra_p;
 
begin 
select	coalesce(qt_dia_prazo_entrega,7) 
into STRICT	qt_dia_prazo_entrega_w 
from	pessoa_juridica_estab 
where	cd_cgc = cd_cgc_fornecedor_w 
and	cd_estabelecimento = cd_estabelecimento_w;
exception 
when others then 
	qt_dia_prazo_entrega_w := 7;
end;
 
open C01;
loop 
fetch C01 into	 
	nr_item_oci_w, 
	qt_material_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	select	count(*) 
	into STRICT	qt_registros_w 
	from	ordem_compra_item_entrega 
	where	nr_ordem_compra = nr_ordem_compra_p 
	and	nr_item_oci = nr_item_oci_w;
	 
	if (qt_registros_w = 0) then 
		CALL gerar_oc_item_entrega( 
			nm_usuario_p, 
			nr_ordem_compra_p, 
			nr_item_oci_w, 
			qt_material_w, 
			pkg_date_utils.start_of(clock_timestamp() + qt_dia_prazo_entrega_w, 'DD', null), 
			pkg_date_utils.start_of(clock_timestamp() + qt_dia_prazo_entrega_w, 'DD', null), 
			null);	
	end if;	
	end;
end loop;
close C01;
 
select	count(*) 
into STRICT	qt_registros_w 
from	ordem_compra_venc 
where	nr_ordem_compra = nr_ordem_compra_p;
 
if (qt_registros_w = 0) then 
	CALL gerar_ordem_compra_venc(nr_ordem_compra_p,nm_usuario_p);
end if;
 
if (ie_liberar_ordem_cotacao_w = 'S') then /* Liberar a Ordem de compras - Gera processo de aprovação*/
 
	CALL Gerar_Aprov_Ordem_Compra(nr_ordem_compra_p, null, 'S', nm_usuario_p);
elsif (ie_liberar_ordem_cotacao_w = 'A') then /*Aprovar a Ordem de compras*/
 
	update	ordem_compra_item 
	set	dt_aprovacao	= clock_timestamp() 
	where	nr_ordem_compra	= nr_ordem_compra_p 
	and	coalesce(dt_aprovacao::text, '') = '';
 
	update	ordem_compra 
	set	dt_aprovacao	= clock_timestamp(), 
		dt_liberacao	= clock_timestamp(), 
		nm_usuario_lib	= nm_usuario_p 
	where	nr_ordem_compra	= nr_ordem_compra_p 
	and	coalesce(dt_aprovacao::text, '') = '';
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_acoes_ordem_compra_imp ( nr_ordem_compra_p bigint, nm_usuario_p text) FROM PUBLIC;

