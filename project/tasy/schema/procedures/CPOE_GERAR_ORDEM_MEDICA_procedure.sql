-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_ordem_medica ( nr_atendimento_p bigint, nr_seq_cpoe_p bigint, nr_seq_tipo_ordem_p bigint, ds_ordem_p text, dt_ordem_p timestamp, cd_medico_p text, nm_usuario_p text, nr_sequencia_p INOUT bigint, ie_origem_ordem_p text default 'M', qt_vel_infusao_p bigint default null, nr_seq_cpoe_rp_p bigint default null) AS $body$
DECLARE


nr_prescricao_w       	prescr_medica.nr_prescricao%type:= null;
cd_material_w			cpoe_material.cd_material%type;
ie_controle_tempo_w		cpoe_material.ie_controle_tempo%type;
ie_material_w			cpoe_material.ie_material%type;
nr_seq_material_w     	prescr_material.nr_sequencia%type:= null;
nr_seq_solucao_w      	prescr_solucao.nr_seq_solucao%type:= null;
nr_seq_gasoterapia_w    prescr_gasoterapia.nr_sequencia%type;
nr_seq_procedimento_w   prescr_procedimento.nr_sequencia%type;
nr_seq_dieta_w          nut_pac.nr_sequencia%type;


BEGIN

    nr_sequencia_p := 0;

    if (coalesce(ie_origem_ordem_p::text, '') = '' or ie_origem_ordem_p = 'M') then
        select	max(cd_material) cd_material,
                coalesce(max(ie_controle_tempo),'N'),
                coalesce(max(ie_material),'N')
        into STRICT	cd_material_w,
                ie_controle_tempo_w, 
                ie_material_w
        from	cpoe_material
        where	nr_sequencia = nr_seq_cpoe_p
        and	((CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  coalesce(dt_fim_cih,dt_fim)  ELSE coalesce(dt_suspensao,dt_fim) END  >= clock_timestamp()) or (CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  coalesce(dt_fim_cih,dt_fim)  ELSE coalesce(dt_suspensao,dt_fim) coalesce(END::text, '') = ''));
        
        if (ie_material_w = 'N') and (ie_controle_tempo_w = 'S') then	
        
            select max(a.nr_prescricao)
            into STRICT  nr_prescricao_w
            from prescr_solucao a,
                prescr_material b
            where a.nr_prescricao = b.nr_prescricao
            and a.nr_seq_solucao = b.nr_sequencia_solucao
            and b.nr_seq_mat_cpoe = nr_seq_cpoe_p;

            select min(a.nr_seq_solucao)
            into STRICT nr_seq_solucao_w
            from prescr_solucao a,
                prescr_material b
            where a.nr_prescricao = b.nr_prescricao
            and a.nr_seq_solucao = b.nr_sequencia_solucao
            and b.nr_prescricao = nr_prescricao_w
            and b.nr_seq_mat_cpoe = nr_seq_cpoe_p;
        else    
        
            select max(nr_prescricao)
            into STRICT nr_prescricao_w
            from prescr_material
            where nr_seq_mat_cpoe = nr_seq_cpoe_p;
         
            select min(nr_sequencia)
            into STRICT nr_seq_material_w
            from prescr_material
            where nr_prescricao = nr_prescricao_w
            and nr_seq_mat_cpoe = nr_seq_cpoe_p;
        end if;

        nr_sequencia_p := Gerar_ordem_medica(	nr_atendimento_p, nr_prescricao_w, null, null, nr_seq_tipo_ordem_p, ds_ordem_p, nr_seq_solucao_w, nr_seq_material_w, cd_medico_p, dt_ordem_p, null, cd_material_w, nm_usuario_p, null, qt_vel_infusao_p, nr_seq_cpoe_rp_p);
                          
    elsif (ie_origem_ordem_p = 'G') then
    
        select	max(c.nr_sequencia),
                max(a.nr_prescricao)
        into STRICT	nr_seq_gasoterapia_w,
                nr_prescricao_w
        from	prescr_medica a,
                prescr_gasoterapia c
        where	a.nr_prescricao = c.nr_prescricao
        and		a.nr_atendimento = nr_atendimento_p
        and		c.nr_seq_gas_cpoe = nr_seq_cpoe_p
        and	    (c.nr_seq_gas IS NOT NULL AND c.nr_seq_gas::text <> '');

        nr_sequencia_p := Gerar_ordem_medica(	nr_atendimento_p, nr_prescricao_w, null, null, nr_seq_tipo_ordem_p, ds_ordem_p, nr_seq_gasoterapia_w, nr_seq_material_w, cd_medico_p, dt_ordem_p, null, null, nm_usuario_p, ie_origem_ordem_p, qt_vel_infusao_p, nr_seq_cpoe_rp_p);
   
   elsif (ie_origem_ordem_p = 'DI') then
    
        select	max(c.nr_seq_solucao),
                max(a.nr_prescricao)
        into STRICT	nr_seq_solucao_w,
                nr_prescricao_w
        from	prescr_medica a,
                prescr_solucao c
        where	a.nr_prescricao = c.nr_prescricao
        and		a.nr_atendimento = nr_atendimento_p
        and		c.nr_seq_dialise_cpoe = nr_seq_cpoe_p
        and	    (c.nr_seq_dialise IS NOT NULL AND c.nr_seq_dialise::text <> '');

        nr_sequencia_p := Gerar_ordem_medica(	nr_atendimento_p, nr_prescricao_w, null, null, nr_seq_tipo_ordem_p, ds_ordem_p, nr_seq_solucao_w, null, cd_medico_p, dt_ordem_p, null, null, nm_usuario_p, ie_origem_ordem_p, qt_vel_infusao_p, nr_seq_cpoe_rp_p);
   
   elsif (ie_origem_ordem_p = 'H') then
    
        select	max(c.nr_sequencia),
                max(a.nr_prescricao)
        into STRICT	nr_seq_procedimento_w,
                nr_prescricao_w
        from	prescr_medica a,
                prescr_procedimento c
        where	a.nr_prescricao = c.nr_prescricao
        and		a.nr_atendimento = nr_atendimento_p
        and		c.nr_seq_proc_cpoe = nr_seq_cpoe_p
        and	    (c.nr_seq_solic_sangue IS NOT NULL AND c.nr_seq_solic_sangue::text <> '');

        nr_sequencia_p := Gerar_ordem_medica(	nr_atendimento_p, nr_prescricao_w, null, null, nr_seq_tipo_ordem_p, ds_ordem_p, nr_seq_procedimento_w, null, cd_medico_p, dt_ordem_p, null, null, nm_usuario_p, ie_origem_ordem_p, qt_vel_infusao_p, nr_seq_cpoe_rp_p);
    
    elsif (ie_origem_ordem_p = 'E') then -- dieta enteral
    
        select	max(c.nr_sequencia),
                max(a.nr_prescricao)
        into STRICT	nr_seq_solucao_w,
                nr_prescricao_w
        from	prescr_medica a, 
                prescr_material c
        where	a.nr_prescricao = c.nr_prescricao
        and		a.nr_atendimento = nr_atendimento_p
        and		c.nr_seq_dieta_cpoe = nr_seq_cpoe_p
        and     c.ie_agrupador = 8;

        nr_sequencia_p := Gerar_ordem_medica(	nr_atendimento_p, nr_prescricao_w, null, null, nr_seq_tipo_ordem_p, ds_ordem_p, nr_seq_solucao_w, null, cd_medico_p, dt_ordem_p, null, null, nm_usuario_p, ie_origem_ordem_p, qt_vel_infusao_p, nr_seq_cpoe_rp_p);
        
    elsif (ie_origem_ordem_p = 'P' or ie_origem_ordem_p = 'I') then -- NPT adulta ou NPT Infanti
       
        select	max(c.nr_sequencia),
                max(a.nr_prescricao)
        into STRICT	nr_seq_dieta_w,
                nr_prescricao_w
        from	prescr_medica a,
                nut_pac c
        where	a.nr_prescricao = c.nr_prescricao
        and		a.nr_atendimento = nr_atendimento_p
        and		c.nr_seq_npt_cpoe = nr_seq_cpoe_p;

        nr_sequencia_p := Gerar_ordem_medica(	nr_atendimento_p, nr_prescricao_w, null, null, nr_seq_tipo_ordem_p, ds_ordem_p, nr_seq_dieta_w, null, cd_medico_p, dt_ordem_p, null, null, nm_usuario_p, ie_origem_ordem_p, qt_vel_infusao_p, nr_seq_cpoe_rp_p);
    end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_ordem_medica ( nr_atendimento_p bigint, nr_seq_cpoe_p bigint, nr_seq_tipo_ordem_p bigint, ds_ordem_p text, dt_ordem_p timestamp, cd_medico_p text, nm_usuario_p text, nr_sequencia_p INOUT bigint, ie_origem_ordem_p text default 'M', qt_vel_infusao_p bigint default null, nr_seq_cpoe_rp_p bigint default null) FROM PUBLIC;

