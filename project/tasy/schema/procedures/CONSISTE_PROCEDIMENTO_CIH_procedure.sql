-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_procedimento_cih (nr_atendimento_p bigint, ie_origem_proced_p bigint, cd_procedimento_p bigint, ie_sus_proc_doenca_p INOUT bigint, cd_cid_principal_p INOUT text, cd_cid_secundario_p INOUT text, ie_sus_proc_doenca_sec_p INOUT bigint) AS $body$
DECLARE


dt_diagnostico_w	timestamp;


BEGIN

ie_sus_proc_doenca_p := 0;

if (ie_origem_proced_p = 2) then

	select	count(*)
	into STRICT	ie_sus_proc_doenca_p
	from	sus_proced_doenca
	where	cd_procedimento	= cd_procedimento_p
	and	ie_origem_proced = 2;

elsif (ie_origem_proced_p = 7) then

	select	count(*)
	into STRICT	ie_sus_proc_doenca_p
	from	sus_procedimento_cid
	where	cd_procedimento	= cd_procedimento_p
	and	ie_origem_proced = 7;
	
	select	count(*)
	into STRICT	ie_sus_proc_doenca_sec_p
	from	sus_procedimento_cid_sec
	where	cd_procedimento	= cd_procedimento_p
	and	ie_origem_proced = 7;	

end if;

if (ie_sus_proc_doenca_p = 0) then
	select	max(dt_diagnostico)
	into STRICT	dt_diagnostico_w
	from	diagnostico_medico
	where	nr_atendimento = nr_atendimento_p;

	begin
		select	b.cd_doenca
		into STRICT	cd_cid_principal_p
		from	diagnostico_doenca b,
			diagnostico_medico a
		where	a.nr_atendimento = b.nr_atendimento
		and	a.dt_diagnostico = b.dt_diagnostico
		and	a.ie_tipo_diagnostico IN (2, 3)
		and	b.ie_classificacao_doenca = 'P'
		and	a.nr_atendimento = nr_atendimento_p
		and	a.dt_diagnostico = dt_diagnostico_w  LIMIT 1;
	exception
		when 	no_data_found then
			select	max(cd_doenca_cid)
			into STRICT	cd_cid_principal_p
			from	procedimento
			where	ie_origem_proced = ie_origem_proced_p
			and	cd_procedimento = cd_procedimento_p;
	end;

	begin
		select	b.cd_doenca
		into STRICT	cd_cid_secundario_p
		from	diagnostico_doenca b,
			diagnostico_medico a
		where	a.nr_atendimento = b.nr_atendimento
		and	a.dt_diagnostico = b.dt_diagnostico
		and	a.ie_tipo_diagnostico IN (2, 3)
		and	b.ie_classificacao_doenca = 'S'
		and	a.nr_atendimento	= nr_atendimento_p
		and	a.dt_diagnostico	= dt_diagnostico_w  LIMIT 1;
	exception
		when	no_data_found then
			select	max(cd_cid_secundario)
			into STRICT	cd_cid_secundario_p
			from	procedimento
			where	ie_origem_proced = ie_origem_proced_p
			and	cd_procedimento = cd_procedimento_p;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_procedimento_cih (nr_atendimento_p bigint, ie_origem_proced_p bigint, cd_procedimento_p bigint, ie_sus_proc_doenca_p INOUT bigint, cd_cid_principal_p INOUT text, cd_cid_secundario_p INOUT text, ie_sus_proc_doenca_sec_p INOUT bigint) FROM PUBLIC;

