-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE abrir_conta_terceiro ( MES_REF_P timestamp, TERC_LIBERADOS_P text) AS $body$
DECLARE


dt_inicial_w			timestamp;
dt_final_w			timestamp;
ie_ctb_online_w			ctb_param_lote_cont_terc.ie_ctb_online%type	:= 'N';

c010 CURSOR FOR
SELECT	a.nr_sequencia,
	a.cd_estabelecimento,
	a.ie_status_conta,
	a.nm_usuario
from	terceiro_conta a
where	a.ie_status_conta = 'D'
and	a.dt_mesano_referencia between dt_inicial_w and dt_final_w
and    	not exists (	select	1
			from	titulo_receber x
			where	x.nr_seq_terc_conta = a.nr_sequencia)

union all

select	a.nr_sequencia,
	a.cd_estabelecimento,
	a.ie_status_conta,
	a.nm_usuario
from	terceiro_conta a
where	ie_status_conta = 'D'
and	a.dt_mesano_referencia between dt_inicial_w and dt_final_w
and    	not exists (	select	1
			from	titulo_receber x
			where	x.nr_seq_terc_conta = a.nr_sequencia
			and	Obter_Se_Contido(nr_seq_terceiro,TERC_LIBERADOS_P ) = 'S');

c010_w	c010%rowtype;


BEGIN

dt_inicial_w	:= trunc(mes_ref_p,'mm');
dt_final_w	:= fim_mes(dt_inicial_w);

open c010;
loop
fetch c010 into
	c010_w;
EXIT WHEN NOT FOUND; /* apply on c010 */
begin
	update	terceiro_conta a
	set	a.ie_status_conta = 'P'
	where 	a.nr_sequencia = c010_w.nr_sequencia;

	begin
	ie_ctb_online_w := ctb_online_pck.get_modo_lote(9,
				c010_w.cd_estabelecimento,
				obter_empresa_estab(c010_w.cd_estabelecimento));
	exception when others then
		ie_ctb_online_w	:= 'N';
	end;

	if (ie_ctb_online_w = 'S') then
	/* Rotina de Contabilização de Controle de Terceiros */

	    CALL ctb_contab_onl_controle_terc( c010_w.nr_sequencia,
				c010_w.ie_status_conta,
				c010_w.nm_usuario);
	end if;
end;
end loop;
close C010;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE abrir_conta_terceiro ( MES_REF_P timestamp, TERC_LIBERADOS_P text) FROM PUBLIC;

