-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_rel_os_prim_atend_sup ( dt_inicial_p timestamp, dt_final_p timestamp, cd_pessoa_solic_p text, nr_seq_grupo_sup_p text, nm_usuario_exec_p text, nm_usuario_p text, ie_os_sem_previsao_p text) AS $body$
DECLARE

			 
nr_seq_ordem_w			bigint;
nr_seq_wheb_w			bigint;
cd_pessoa_solic_w			varchar(10);
nr_seq_grupo_sup_w		bigint;
nm_usuario_exec_w		varchar(15);
ds_dano_breve_w			varchar(80);
nr_seq_estagio_w			bigint;
dt_ordem_servico_w		timestamp;
dt_inicio_previsto_w		timestamp;
dt_fim_previsto_w			timestamp;
nm_solicitante_w			varchar(255);
ds_grupo_suporte_w		varchar(255);
ds_usuario_exec_w			varchar(255);
ds_estagio_w			varchar(255);
ie_primeiro_atend_w		varchar(15);
ds_lista_grupo_sup_w		varchar(4000);
ds_lista_usuario_exec_w		varchar(4000);
ie_restr_grupo_sup_w		varchar(1);
ie_restr_usuario_exec_w		varchar(1);

C01 CURSOR FOR 
	SELECT	a.nr_sequencia, 
		a.nr_seq_wheb, 
		a.cd_pessoa_solicitante, 
		coalesce(a.nr_seq_grupo_sup,0) nr_seq_grupo_sup, 
		coalesce(a.nm_usuario_exec,'0') nm_usuario_exec, 
		a.ds_dano_breve, 
		a.nr_seq_estagio, 
		a.dt_ordem_servico, 
		a.dt_inicio_previsto, 
		a.dt_fim_previsto, 
		substr(obter_nome_pf(a.cd_pessoa_solicitante),1,60) nm_solicitante, 
		substr(coalesce(obter_desc_grupo_suporte(a.nr_seq_grupo_sup),'Não Informado'),1,80) ds_grupo_suporte, 
		substr(coalesce(obter_nome_usuario(a.nm_usuario_exec),'Não Informado'),1,100) ds_usuario_exec, 
		substr(obter_desc_estagio_proc(a.nr_seq_estagio),1,40) ds_estagio 
	from	usuario b, 
		man_ordem_servico a 
	where	b.nm_usuario = a.nm_usuario_exec 
	and	b.cd_setor_atendimento = 4 
	and	a.ie_status_ordem = '3' 
	and	a.ie_classificacao in ('D','E') 
	and	a.dt_fim_real between dt_inicial_p and dt_final_p + 86399/86400	 
	and (coalesce(cd_pessoa_solic_p,'0') = '0' 
		or a.cd_pessoa_solicitante = coalesce(cd_pessoa_solic_p,'0')) 
	and (ds_lista_grupo_sup_w = '0' 
		or obter_se_contido(a.nr_seq_grupo_sup,ds_lista_grupo_sup_w) = ie_restr_grupo_sup_w) 
	and (ds_lista_usuario_exec_w = '0' 
		or obter_se_contido_char(replace(a.nm_usuario_exec,' ',''),ds_lista_usuario_exec_w) = ie_restr_usuario_exec_w) 
	and	a.nr_seq_tipo_solucao not in (51,81,44,43,182,91) 
	and	a.nr_seq_grupo_sup in (	SELECT	l.nr_sequencia 
					from	grupo_suporte l 
					where	l.nr_seq_gerencia_sup = 5 
					and	l.nr_sequencia <> 27 
					and	l.ie_situacao = 'A') 
	and 	((not exists (select 1 
				from	man_ordem_ativ_prev x 
				where	a.nr_sequencia = x.nr_seq_ordem_serv 
				and   (x.dt_prevista IS NOT NULL AND x.dt_prevista::text <> '')) 
				and (ie_os_sem_previsao_p = 'S')) or (exists (select 1 
									from	man_ordem_ativ_prev x 
									where	a.nr_sequencia = x.nr_seq_ordem_serv 
									and	x.nm_usuario_prev = a.nm_usuario_exec 
									and (ie_os_sem_previsao_p = 'N'))));


BEGIN 
select	substr(coalesce(replace(nr_seq_grupo_sup_p,'-',''),'0'),1,4000), 
	substr(coalesce(replace(replace(nm_usuario_exec_p,' ',''),'-',''),'0'),1,4000), 
	CASE WHEN substr(nr_seq_grupo_sup_p,1,1)='-' THEN 'N'  ELSE 'S' END , 
	CASE WHEN substr(nm_usuario_exec_p,1,1)='-' THEN 'N'  ELSE 'S' END  
into STRICT	ds_lista_grupo_sup_w, 
	ds_lista_usuario_exec_w, 
	ie_restr_grupo_sup_w, 
	ie_restr_usuario_exec_w
;
 
delete FROM w_rel_os_prim_atend_sup where nm_usuario = nm_usuario_p;
 
open C01;
loop 
fetch C01 into	 
	nr_seq_ordem_w, 
	nr_seq_wheb_w, 
	cd_pessoa_solic_w, 
	nr_seq_grupo_sup_w, 
	nm_usuario_exec_w, 
	ds_dano_breve_w, 
	nr_seq_estagio_w, 
	dt_ordem_servico_w, 
	dt_inicio_previsto_w, 
	dt_fim_previsto_w, 
	nm_solicitante_w, 
	ds_grupo_suporte_w, 
	ds_usuario_exec_w, 
	ds_estagio_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	ie_primeiro_atend_w := 'N';
	begin 
		select	'N' 
		into STRICT	ie_primeiro_atend_w 
		from	man_ordem_serv_estagio b,  
			man_estagio_processo a  
		where	a.nr_sequencia	= b.nr_seq_estagio 
		and	b.nr_seq_estagio	= 151 
		and	b.nr_seq_ordem	= nr_seq_ordem_w  LIMIT 1;
		exception 
		when others then 
			ie_primeiro_atend_w := 'S';
	end;
	 
	if (ie_primeiro_atend_w = 'N') then 
		begin 
		select	'N' 
		into STRICT	ie_primeiro_atend_w 
		from	man_ordem_ativ_prev 
		where	nr_seq_motivo_reprog in (6,9,11,12,18,19) 
		and	nr_seq_ordem_serv = nr_seq_ordem_w  LIMIT 1;
		exception 
		when others then 
			ie_primeiro_atend_w := 'S';
		end;
	end if;
	 
	insert into w_rel_os_prim_atend_sup( 
				nr_sequencia, 
				nr_seq_grupo_sup, 
				dt_atualizacao, 
				nm_usuario, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				ds_grupo_suporte, 
				nm_usuario_exec, 
				ds_usuario_exec, 
				nr_seq_ordem, 
				nr_seq_wheb, 
				nr_seq_estagio, 
				ds_dano_breve, 
				ds_estagio, 
				dt_ordem_servico, 
				dt_inicio_previsto, 
				dt_fim_previsto, 
				cd_pessoa_solicitante, 
				nm_solicitante, 
				ie_primeiro_atend) 
	values (	nextval('w_rel_os_prim_atend_sup_seq'), 
				nr_seq_grupo_sup_w, 
				clock_timestamp(), 
				nm_usuario_p, 
				clock_timestamp(), 
				nm_usuario_p, 
				ds_grupo_suporte_w, 
				nm_usuario_exec_w, 
				ds_usuario_exec_w, 
				nr_seq_ordem_w, 
				nr_seq_wheb_w, 
				nr_seq_estagio_w, 
				ds_dano_breve_w, 
				ds_estagio_w, 
				dt_ordem_servico_w, 
				dt_inicio_previsto_w, 
				dt_fim_previsto_w, 
				cd_pessoa_solic_w, 
				nm_solicitante_w, 
				ie_primeiro_atend_w);
 
	commit;
	end;
end loop;
close C01;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_rel_os_prim_atend_sup ( dt_inicial_p timestamp, dt_final_p timestamp, cd_pessoa_solic_p text, nr_seq_grupo_sup_p text, nm_usuario_exec_p text, nm_usuario_p text, ie_os_sem_previsao_p text) FROM PUBLIC;

