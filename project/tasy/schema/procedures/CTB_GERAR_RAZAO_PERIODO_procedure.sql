-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_razao_periodo (nm_usuario_p text, cd_conta_contabil_p text, dt_inicio_p timestamp, dt_fim_p timestamp, cd_estabelecimento_p bigint) AS $body$
DECLARE



cd_conta_contabil_w		varchar(15);
cd_conta_contabil_ww		varchar(15);
vl_saldo_anterior_w		double precision;
vl_entrada_w			double precision;
vl_baixa_bem_w			double precision;
vl_saldo_atual_w		double precision;
vl_deprec_ant_w			double precision;
vl_deprec_periodo_w		double precision;
vl_baixa_deprec_w		double precision;
vl_deprec_acum_ant_w		double precision;
vl_deprec_acum_atual_w		double precision;
vl_contabil_w			double precision;
dt_mes_anterior_w		timestamp;
dt_mes_atual_w			timestamp;
dt_inicio_w			timestamp := dt_inicio_p;
dt_fim_w			timestamp;
nr_seq_bem_w			bigint;
vl_contab_bem_w			double precision;
vl_total_contab_w		double precision;

C01 CURSOR FOR
SELECT	a.cd_conta_contabil
from	pat_valor_bem a,
	pat_bem b
where 	trunc(a.dt_valor,'mm') between trunc(dt_inicio_w,'mm') and trunc(dt_fim_w,'mm')
and (a.cd_conta_contabil = cd_conta_contabil_w or cd_conta_contabil_w = '0')
and	a.nr_seq_bem = b.nr_sequencia
and	b.cd_estabelecimento = cd_estabelecimento_p
group by	a.cd_conta_contabil
order by	a.cd_conta_contabil;

C02 CURSOR FOR
SELECT	distinct	b.nr_sequencia
from			pat_valor_bem a,
			pat_bem b
where 			trunc(a.dt_valor,'mm') between trunc(dt_inicio_w,'mm') and trunc(dt_fim_w,'mm')
and			a.cd_conta_contabil = cd_conta_contabil_ww
and			a.nr_seq_bem = b.nr_sequencia
and			b.cd_estabelecimento = cd_estabelecimento_p
group by		b.nr_sequencia;


BEGIN

cd_conta_contabil_w := coalesce(cd_conta_contabil_p,'0');

delete 	from w_razao_patrimonio
where 	nm_usuario = nm_usuario_p;

dt_fim_w := fim_mes(dt_fim_p);

open C01;
loop
fetch C01 into
	cd_conta_contabil_ww;
EXIT WHEN NOT FOUND; /* apply on C01 */

	select 	max(dt_valor)
	into STRICT	dt_mes_atual_w
	from 	pat_valor_bem
	where	cd_conta_contabil = cd_conta_contabil_ww;

	select 	max(dt_valor)
	into STRICT	dt_mes_anterior_w
	from	pat_valor_bem
	where	trunc(dt_valor,'mm') < trunc(dt_inicio_w,'mm')
	and	cd_conta_contabil = cd_conta_contabil_ww;

	select 	coalesce(sum(a.vl_base_deprec),0), 	--saldo anterior ao período selecionado
		coalesce(sum(a.vl_deprec_acum),0)	--depreciação acumulada anterior ao período selecionado.
	into STRICT	vl_saldo_anterior_w,
		vl_deprec_ant_w
	from	pat_valor_bem a,
		pat_bem b
	where	a.nr_seq_bem = b.nr_sequencia
	and	a.cd_conta_contabil = cd_conta_contabil_ww
	and	trunc(a.dt_valor,'mm') = trunc(dt_mes_anterior_w,'mm');

	select 	coalesce(sum(a.vl_deprec_acum),0), --depreciação acumulada atual.
		coalesce(sum(a.vl_base_deprec),0) --saldo atual
	into STRICT	vl_deprec_acum_atual_w,
		vl_saldo_atual_w
	from	pat_valor_bem a,
		pat_bem b
	where	a.nr_seq_bem = b.nr_sequencia
	and	a.cd_conta_contabil = cd_conta_contabil_ww
	and	trunc(a.dt_valor,'mm') = trunc(dt_mes_atual_w,'mm');

	select 	coalesce(sum(a.vl_deprec_mes),0), -- depreciação período
		coalesce(sum(vl_baixa_bem),0), --Baixas no período
		coalesce(sum(vl_baixa_deprec),0) --Baixas depreciação no período
	into STRICT	vl_deprec_periodo_w,
		vl_baixa_bem_w,
		vl_baixa_deprec_w
	from	pat_valor_bem a,
		pat_bem b
	where	a.nr_seq_bem = b.nr_sequencia
	and	a.cd_conta_contabil = cd_conta_contabil_ww
	and	trunc(a.dt_valor,'mm') between trunc(dt_inicio_w,'mm') and trunc(dt_fim_w,'mm');

	vl_contabil_w := vl_saldo_atual_w - vl_deprec_acum_atual_w;

	vl_total_contab_w := 0;

	open C02;
	loop
	fetch C02 into
		nr_seq_bem_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */

		select 	coalesce(sum(vl_original),0)
		into STRICT	vl_contab_bem_w
		from	pat_bem
		where	trunc(dt_aquisicao,'mm') between trunc(dt_inicio_w,'mm') and trunc(dt_fim_w,'mm')
		and	nr_sequencia = nr_seq_bem_w;

		vl_total_contab_w := vl_total_contab_w + vl_contab_bem_w;
	end loop;
	close C02;

	insert into w_razao_patrimonio( nm_usuario,
					cd_conta_contabil,
					vl_saldo_ant,
					vl_saldo_atual,
					vl_deprec_acum_ant,
					vl_deprec_acum_atual,
					vl_deprec_periodo,
					vl_baixa_periodo,
					vl_baixa_deprec,
					vl_contabil,
					vl_aquisicao_periodo)
	values (nm_usuario_p,
					cd_conta_contabil_ww,
					vl_saldo_anterior_w,
					vl_saldo_atual_w,
					vl_deprec_ant_w,
					vl_deprec_acum_atual_w,
					vl_deprec_periodo_w,
					vl_baixa_bem_w,
					vl_baixa_deprec_w,
					vl_contabil_w,
					vl_total_contab_w
					);

end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_razao_periodo (nm_usuario_p text, cd_conta_contabil_p text, dt_inicio_p timestamp, dt_fim_p timestamp, cd_estabelecimento_p bigint) FROM PUBLIC;

