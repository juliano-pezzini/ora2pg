-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lote_ent_reconvoca_fichas ( ds_fichas_p text, nr_seq_lote_p bigint, ie_area_busca_p text, nm_usuario_p text, nr_seq_exame_p bigint default 0, nr_corrida_p bigint default NULL) AS $body$
DECLARE

 
nr_seq_ficha_w   bigint;
ds_exames_w   varchar(255);
ds_sql     varchar(4000);

C01 CURSOR FOR 
  SELECT a.nr_sequencia, 
    obter_select_concatenado_bv(ds_sql, 
          'nr_seq_ficha='||a.nr_sequencia||';'|| 
          'nr_seq_lote_sec='||a.nr_seq_lote_sec||';'|| 
     'nr_corrida='||nr_corrida_p,',') 
  FROM  lote_ent_sec_ficha a 
  WHERE  1 = 1 
  AND a.nr_seq_lote_sec = nr_seq_lote_p 
  AND obter_se_contido(nr_sequencia,ds_fichas_p) = 'S' 
  ORDER BY 1;

BEGIN
 
ds_sql := ' SELECT distinct x.nr_sequencia ' || 
     ' FROM lote_ent_sec_ficha_exam x, ' || 
     '   lote_ent_sec_ficha y, ' || 
     '   prescr_procedimento p ' || 
     ' WHERE x.nr_seq_ficha = :nr_seq_ficha ' || 
     '  and  x.nr_seq_ficha = y.nr_sequencia ' || 
     '  and p.nr_prescricao = y.nr_prescricao ' || 
     '  and p.nr_seq_exame = x.nr_seq_exame ' || 
     '  and ((p.nr_corrida_lote_ent = :nr_corrida) or (:nr_corrida is null)) ' || 
     '  and  y.nr_seq_lote_sec = :nr_seq_lote_sec ';
 
if (coalesce(nr_seq_exame_p,0) <> 0) then 
  ds_sql := ds_sql || ' and p.nr_seq_exame = ' || to_char(nr_seq_exame_p);
end if;
 
open C01;
loop 
fetch C01 into  
  nr_seq_ficha_w, 
  ds_exames_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
  begin 
 
  CALL reconvocacao_ficha_lote_ent(nr_seq_ficha_w, ds_exames_w, nm_usuario_p, ie_area_busca_p);
   
  end;
end loop;
close C01;
   
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lote_ent_reconvoca_fichas ( ds_fichas_p text, nr_seq_lote_p bigint, ie_area_busca_p text, nm_usuario_p text, nr_seq_exame_p bigint default 0, nr_corrida_p bigint default NULL) FROM PUBLIC;

