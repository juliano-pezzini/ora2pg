-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE aprovar_idiomas_doc ( nr_sequencia_p bigint, dt_aprovacao_p timestamp, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
nm_usuario_partic_w	varchar(15);

c01 CURSOR FOR
	SELECT	nr_sequencia
	from	qua_documento
	where	nr_seq_superior = nr_sequencia_p;

c02 CURSOR FOR
	SELECT	distinct
		b.nm_usuario
	from	usuario b,
		qua_doc_participante a
	where	b.cd_pessoa_fisica = a.cd_participante
	and	a.nr_seq_doc = nr_sequencia_p;


BEGIN

	open c01;
	loop
	fetch c01 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
			update	qua_documento
			set	dt_atualizacao = clock_timestamp(),
				nm_usuario = nm_usuario_p,
				dt_aprovacao = dt_aprovacao_p,
				ie_status = 'D',
				nm_usuario_aprov = nm_usuario_p,
				dt_reprovacao  = NULL
			where	nr_sequencia = nr_sequencia_w
			and	(dt_validacao IS NOT NULL AND dt_validacao::text <> '');

			open c02;
			loop
			fetch c02 into
				nm_usuario_partic_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				insert into qua_doc_log_acesso(
					nr_sequencia,
					nr_seq_doc,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					dt_atualizacao,
					nm_usuario,
					dt_acesso,
					dt_leitura,
					ie_log,
					cd_estabelecimento,
					cd_funcao)
				values (	nextval('qua_doc_log_acesso_seq'),
					nr_sequencia_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_partic_w,
					clock_timestamp(),
					clock_timestamp(),
					'C',
					wheb_usuario_pck.get_cd_estabelecimento,
					wheb_usuario_pck.get_cd_funcao);
			end loop;
			close c02;
		end;
	end loop;
	close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE aprovar_idiomas_doc ( nr_sequencia_p bigint, dt_aprovacao_p timestamp, nm_usuario_p text) FROM PUBLIC;

