-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mprev_cancelar_atend_ciclo ( nr_seq_ciclo_atend_p bigint, nr_seq_modulo_p bigint, dt_inicio_ciclo_p timestamp, nr_seq_participante_p bigint, nr_seq_agrupamento_p bigint, ie_cancelamento_p text, nr_seq_motivo_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ie_cancel_troca_mod_w	varchar(2);
					
c01 CURSOR(	nr_seq_ciclo_atend_pc	mprev_partic_ciclo_atend.nr_sequencia%type, 
		nr_seq_modulo_pc	mprev_modulo_atend.nr_sequencia%type, 
		dt_inicio_ciclo_pc	timestamp, 
		nr_seq_participante_pc	mprev_participante.nr_sequencia%type, 
		nr_seq_agrupamento_pc	mprev_agrupamento_modulo.nr_sequencia%type, 
		ie_cancelamento_pc	mprev_prog_partic_modulo.ie_cancelamento%type) FOR 
 
	--(N,CA,CM)(N찾o cancelar,Cancelar se mesmo agrupamento,Cancelar se mesmo m처dulo) 
	-- (BD) Quando o cancelamento foi feito pelo bot찾o direito, ou seja, para cancelar todos do m처dulo selecionado 
	 
	SELECT	a.nr_sequencia 
	from	mprev_partic_ciclo_item_v a 
	where	a.nr_seq_ciclo 	= nr_seq_ciclo_atend_pc 
	and	a.nr_seq_modulo	= nr_seq_modulo_pc 
	and	a.dt_prevista	>= dt_inicio_ciclo_pc 
	and	a.ie_status	= 'P' 
	and	a.nr_seq_participante	= nr_seq_participante_pc 
	and	'CM'	= ie_cancelamento_pc 
	
union all
 
	SELECT	a.nr_sequencia 
	from	mprev_partic_ciclo_item_v a 
	where	a.nr_seq_ciclo 	= nr_seq_ciclo_atend_pc 
	and	a.nr_seq_agrupamento	= nr_seq_agrupamento_pc 
	and	a.dt_prevista	>= dt_inicio_ciclo_pc 
	and	a.ie_status	= 'P' 
	and	a.nr_seq_participante	= nr_seq_participante_pc 
	and	'CA'	= ie_cancelamento_pc 
	
union all
 
	select	a.nr_sequencia 
	from	mprev_partic_ciclo_item_v a 
	where	a.nr_seq_ciclo 	= nr_seq_ciclo_atend_pc 
	and	a.ie_status	= 'P' 
	and	'BD'	= ie_cancelamento_pc;
BEGIN
 
if (ie_cancelamento_p = 'BD') then 
	ie_cancel_troca_mod_w := null;
else 
	ie_cancel_troca_mod_w := 'S';
end if;
 
if (nr_seq_ciclo_atend_p IS NOT NULL AND nr_seq_ciclo_atend_p::text <> '') then 
	for r_c01 in c01( 	nr_seq_ciclo_atend_p, 
				nr_seq_modulo_p, 
				dt_inicio_ciclo_p, 
				nr_seq_participante_p, 
				nr_seq_agrupamento_p, 
				ie_cancelamento_p) loop 
		 
		update	mprev_partic_ciclo_item a 
		set	dt_cancelamento = clock_timestamp(), 
			ie_status = 'C', 
			ie_cancel_troca_mod = ie_cancel_troca_mod_w, 
			nr_seq_motivo_desvio = nr_seq_motivo_p 
		where	nr_sequencia	= r_c01.nr_sequencia;
 
	end loop;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mprev_cancelar_atend_ciclo ( nr_seq_ciclo_atend_p bigint, nr_seq_modulo_p bigint, dt_inicio_ciclo_p timestamp, nr_seq_participante_p bigint, nr_seq_agrupamento_p bigint, ie_cancelamento_p text, nr_seq_motivo_p bigint, nm_usuario_p text) FROM PUBLIC;

