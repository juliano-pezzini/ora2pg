-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE valida_objetos_sistema () AS $body$
DECLARE

nr_objetos_w		bigint;
ds_erro_w			varchar(1000);
qt_resultado_w     	integer;
ds_comando_w       	varchar(2000);

BEGIN
begin

/*INICIO ALTERAÇÃO COELHO -  IMPEDIR DUAS EXECUÇÕES DESTA PROCEDURE OU SIMULTÂNEA A TASY_SINCRONIZAR_BASE*/

CALL gravar_processo_longo('','VALIDA_OBJETOS_SISTEMA',null);

begin
	SELECT	'A procedure VALIDA_OBJETOS_SITEMA já está em execução!!'
 || chr(10) ||
			obter_desc_expressao(648224)/*'Programa   :'*/
 || program || chr(10) ||
			obter_desc_expressao(618748)/*'Sid/Serial :'*/
 || sid     || ',' || serial# || chr(10) ||
			obter_desc_expressao(328225)/*'Usuário    :'*/
 || osuser  || CHR(10) ||
			obter_desc_expressao(289514)/*'Estação    :'*/
 || machine
	INTO STRICT	ds_erro_w
	FROM 	v$session
	WHERE	audsid <> (SELECT userenv('sessionid') )
	AND	username = (select username from v$session where audsid = (select userenv('sessionid') ))
	AND	action like 'VALIDA_OBJETOS_SISTEMA%'
	AND	status = 'ACTIVE';
exception
when others then
	ds_erro_w := '';
end;

if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '')  then
	CALL gravar_processo_longo('','',null);
	CALL wheb_mensagem_pck.exibir_mensagem_abort(278178,'DS_ERRO='||ds_erro_w );
end if;

begin
	SELECT	'A procedure TASY_SINCRONIZAR_BASE está em execução. '
 || chr(10) ||
			'A execução da procedure VALIDA_OBJETOS_SISTEMA foi cancelada !!!'
 || chr(10) ||
			obter_desc_expressao(648224)/*'Programa   :'*/
 || program || chr(10) ||
			obter_desc_expressao(618748)/*'Sid/Serial :'*/
 || sid     || ',' || serial# || chr(10) ||
			obter_desc_expressao(328225)/*'Usuário    :'*/
 || osuser  || CHR(10) ||
			obter_desc_expressao(289514)/*'Estação    :'*/
 || machine
	INTO STRICT	ds_erro_w
	FROM 	v$session
	WHERE	audsid <> (SELECT userenv('sessionid') )
	AND	username = (select username from v$session where audsid = (select userenv('sessionid') ))
	AND	action like 'TASY_SINCRONIZAR_BASE%'
	OR 	action like 'TASY_AJUSTAR_COLUNAS%'
	OR	action like 'TASY_ALTERAR_COLUNA%'
	OR	action like 'TASY_CRIAR_INDICE%'
	OR	action like 'TASY_CRIAR_INTEGRIDADE%'
	OR	action like 'TASY_CRIAR_ALTERAR_TABELA%';
exception
when others then
	ds_erro_w := '';
end;

if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
	CALL gravar_processo_longo('','',null);
	CALL wheb_mensagem_pck.exibir_mensagem_abort(278178,'DS_ERRO='||ds_erro_w );
end if;

begin
	SELECT	'A procedure TASY_CONSISTIR_BASE está em execução. '
 || chr(10) ||
		'A execução da procedure VALIDA_OBJETOS_SISTENA foi cancelada !!!'
 || chr(10) ||
		obter_desc_expressao(648224)/*'Programa   :'*/
 || program || chr(10) ||
		obter_desc_expressao(618748)/*'Sid/Serial :'*/
 || sid     || ',' || serial# || chr(10) ||
	   	obter_desc_expressao(328225)/*'Usuário    :'*/
 || osuser  || CHR(10) ||
	   	obter_desc_expressao(289514)/*'Estação    :'*/
 || machine
	INTO STRICT	ds_erro_w
	FROM 	v$session
	WHERE	audsid <> (SELECT userenv('sessionid') )
	AND	username = (select username from v$session where audsid = (select userenv('sessionid') ))
	AND	action like 'TASY_CONSISTIR_BASE%';
exception
when others then
	ds_erro_w := '';
end;

if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
	CALL gravar_processo_longo('','',null);
	CALL wheb_mensagem_pck.exibir_mensagem_abort(278178,'DS_ERRO='||ds_erro_w );
end if;

/*FIM ALTERAÇÃO COELHO*/

select 	count(*)
into STRICT 	nr_objetos_w
from 	objetos_invalidos_v;
if (nr_objetos_w > 0) then
	begin

	/*ds_comando_w := 'select count(*) ' ||
				'from aplicacao_tasy a ' ||
		'where upper(a.cd_aplicacao_tasy) = ' || CHR(39) || 'TASY' || CHR(39) ||
		'and ie_status_aplicacao =  ' || CHR(39) || 'U' || CHR(39);

	obter_valor_dinamico_bv(ds_comando_w,null,qt_resultado_w);

	if (qt_resultado_w > 0) and (obter_se_base_wheb = 'N') then
		exec_sql_dinamico('Tasy','alter package WHEB_USUARIO_PCK compile');
		exec_sql_dinamico('Tasy','alter package WHEB_USUARIO_PCK compile body');
	end if;*/
	CALL Compila_Objetos_Invalidos();
	Compila_Objetos_Invalidos;
	CALL Compila_Objetos_Invalidos();
	Compila_Objetos_Invalidos;

	end;
end if;

update 	aplicacao_tasy
set	ie_status_aplicacao = 'A'
where	ie_status_aplicacao = 'I';

/*update 	aplicacao_tasy
set	ie_status_aplicacao = 'I'
where		cd_aplicacao_tasy in
		(select distinct(a.ds_aplicacao)
		from objeto_sistema a, user_objects b
		where a.nm_objeto = b.object_name
		  and	b.status	= 'INVALID')
and	ie_status_aplicacao = 'A';*/
end;
commit;

CALL gravar_processo_longo('','',0);

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE valida_objetos_sistema () FROM PUBLIC;

