-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE verifica_alta_transf_senha ( cd_medico_resp_p text, nr_seq_fila_senha_p bigint default null, nr_atendimento_p bigint default null, ie_atend_pa text default 'N', realizou_alta_medica_p INOUT text DEFAULT NULL, realizou_transferencia_senha_p INOUT text DEFAULT NULL) AS $body$
DECLARE


ie_allow_aux_doctor_w varchar(1);
ie_rule_generate_discharge_w varchar(1);
dt_alta_w timestamp;
cd_estabelecimento_w  bigint;
nr_seq_fila_senha_atual_w bigint;
nr_seq_fila_destino_w bigint;
nm_usuario_w			varchar(100);
cd_medico_resp_w	varchar(10);
cd_medico_aux_w	varchar(10);
count_reg_movimentacao_w  smallint;


BEGIN
cd_estabelecimento_w 	:= wheb_usuario_pck.get_cd_estabelecimento;
nm_usuario_w			:= wheb_usuario_pck.get_nm_usuario;

realizou_alta_medica_p := 'S';
realizou_transferencia_senha_p := 'S';

ie_allow_aux_doctor_w := obter_param_usuario(935, 64, obter_perfil_ativo, nm_usuario_w, cd_estabelecimento_w, ie_allow_aux_doctor_w);
ie_rule_generate_discharge_w := obter_param_usuario(935, 10, obter_perfil_ativo, nm_usuario_w, cd_estabelecimento_w, ie_rule_generate_discharge_w);
  
  -- verify discharge
    select a.dt_alta,
		   a.cd_medico_resp,
		   a.cd_medico_aux
    into STRICT dt_alta_w,
		   cd_medico_resp_w,
		   cd_medico_aux_w
    from pep_atendimento_ps_v a
    where a.nr_atendimento = nr_atendimento_p;

  if(ie_atend_pa = 'S'
	 and ie_rule_generate_discharge_w <> 'N'
	 and coalesce(dt_alta_w::text, '') = ''
	 and ((cd_medico_resp_p = cd_medico_resp_w
			or (cd_medico_resp_p = cd_medico_aux_w and ie_allow_aux_doctor_w = 'S'))
		or ie_rule_generate_discharge_w = 'T'
		or ie_rule_generate_discharge_w = 'C')) then
    	
		realizou_alta_medica_p := 'N';
		
  end if;

  -- verify password's transfer
  if ((nr_seq_fila_senha_p IS NOT NULL AND nr_seq_fila_senha_p::text <> '')
	and coalesce(dt_alta_w::text, '') = '') then     
    select nr_seq_fila_senha
      into STRICT nr_seq_fila_senha_atual_w
    from paciente_senha_fila 
    where nr_sequencia = nr_seq_fila_senha_p;
	
    select count(nr_sequencia)
      into STRICT count_reg_movimentacao_w
    from movimentacao_senha_fila
    where nr_seq_pac_senha_fila = nr_seq_fila_senha_p;

    if (count_reg_movimentacao_w <= 1) then
      realizou_transferencia_senha_p := 'N';
    else
      select nr_seq_fila_espera
        into STRICT nr_seq_fila_destino_w
      from (SELECT nr_seq_fila_espera
        from movimentacao_senha_fila
        where nr_seq_pac_senha_fila = nr_seq_fila_senha_p
          and (dt_saida IS NOT NULL AND dt_saida::text <> '')
              order by dt_atualizacao desc) alias1 LIMIT 1;

      if (nr_seq_fila_senha_atual_w <> nr_seq_fila_destino_w) then
        realizou_transferencia_senha_p := 'N';
      end if;
    end if;

  end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE verifica_alta_transf_senha ( cd_medico_resp_p text, nr_seq_fila_senha_p bigint default null, nr_atendimento_p bigint default null, ie_atend_pa text default 'N', realizou_alta_medica_p INOUT text DEFAULT NULL, realizou_transferencia_senha_p INOUT text DEFAULT NULL) FROM PUBLIC;

