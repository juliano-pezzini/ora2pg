-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_proc_apac ( nr_sequencia_p bigint, ie_tipo_ups_p text, ie_tipo_prestador_p text, cd_proc_principal_p bigint, cd_tratamento_p text, ie_tipo_apac_p bigint, cd_varia_atrib_p text, ie_metastase_p text, dt_competencia_p timestamp, cd_motivo_cobranca_p bigint, ie_hiv_p text, qt_idade_p bigint, cd_cid_principal_p text, cd_cid_secundario_p text, qt_tx_realizado_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE


ds_erro_w			varchar(1000);
qt_registros_proc_w		smallint;
ds_procedimentos_w		varchar(2000);
cd_procedimento_w		bigint;
cd_atividade_prof_w		smallint;
qt_procedimento_w		double precision;
qt_proced_conta_w		double precision;
cd_cgc_fornecedor_w		varchar(14);
nr_nota_fiscal_w		varchar(255);
nr_seq_cdx_w			bigint;
nr_seq_atividade_w		bigint;
ie_apac_inicial_w		varchar(1);
ie_apac_continuidade_w	varchar(1);
qt_maxima_w			smallint;
dt_competencia_preco_w	timestamp;
ie_cessao_credito_w		varchar(1);
ie_pab_w			varchar(1);
ie_faec_w			varchar(1);
cd_rub_w			varchar(4);
ds_aux_w			varchar(20);
nr_seq_motivo_cob_w		bigint;
nr_seq_geral_w		bigint;

ie_tipo_ups_w			varchar(2);
ie_tipo_prestador_w		varchar(2);
cd_proc_principal_w		bigint;
cd_tratamento_w		varchar(2);
ie_tipo_apac_w		smallint;
cd_varia_atrib_w		varchar(2);
ie_metastase_w		varchar(1);
dt_competencia_w		timestamp;
cd_motivo_cobranca_w		smallint;
ie_hiv_w			varchar(1);
qt_idade_w			smallint;
cd_cid_principal_w		varchar(4);
cd_cid_secundario_w		varchar(4);
qt_tx_realizado_w		smallint;
nr_seq_propaci_w		bigint;
ie_maxima_w			varchar(4);

C01 CURSOR FOR
SELECT
	a.cd_procedimento,
	a.cd_atividade_prof,
	a.qt_procedimento,
	a.cd_cgc_fornecedor,
	a.nr_nota_fiscal,
	a.nr_seq_propaci
from	sus_apac_proc a
where	a.nr_seq_apac	= nr_sequencia_p
order by	a.nr_sequencia;



BEGIN
ds_erro_w			:= null;
ie_tipo_ups_w		:= ie_tipo_ups_p;
ie_tipo_prestador_w	:= ie_tipo_prestador_p;
cd_proc_principal_w	:= cd_proc_principal_p;
cd_tratamento_w		:= cd_tratamento_p;
ie_tipo_apac_w		:= ie_tipo_apac_p;
cd_varia_atrib_w		:= cd_varia_atrib_p;
ie_metastase_w		:= ie_metastase_p;
dt_competencia_w		:= dt_competencia_p;
cd_motivo_cobranca_w	:= cd_motivo_cobranca_p;
ie_hiv_w			:= ie_hiv_p;
qt_idade_w			:= qt_idade_p;
cd_cid_principal_w	:= cd_cid_principal_p;
cd_cid_secundario_w	:= cd_cid_secundario_p;
qt_tx_realizado_w		:= qt_tx_realizado_p;

/* 99 - Consistencia dos Procedimentos da APAC */

qt_registros_proc_w		:= 0;
ds_procedimentos_w	:= null;
open C01;
loop
fetch c01 into
	cd_procedimento_w,
	cd_atividade_prof_w,
	qt_procedimento_w,
	cd_cgc_fornecedor_w,
	nr_nota_fiscal_w,
	nr_seq_propaci_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	BEGIN


	/* Consistir a quantidade de procedimentos da APAC com a quantidade da conta*/

	if (nr_seq_propaci_w IS NOT NULL AND nr_seq_propaci_w::text <> '') then
		begin
		select	qt_procedimento
		into STRICT	qt_proced_conta_w
		from	procedimento_paciente
		where	nr_sequencia	= nr_seq_propaci_w
		and	coalesce(cd_motivo_exc_conta::text, '') = '';
		exception
			when others then
			qt_proced_conta_w	:= 0;
		end;

		if (qt_procedimento_w <> qt_proced_conta_w) then
			ds_erro_w	:= ds_erro_w || '2161 ';
		end if;
	end if;


	/* Salva string de procedimentos para teste de compatibilidade */

	ds_procedimentos_w := ds_procedimentos_w||to_char(cd_procedimento_w)||';';

	/* Consitencia dos procedimentos da APAC */

	qt_registros_proc_w	:= qt_registros_proc_w + 1;

	/* Consitencia da atividade profissional da APAC  */

	if (coalesce(cd_atividade_prof_w::text, '') = '') then
		ds_erro_w	:= ds_erro_w || '2047 ';
	end if;

	/* Consitencia da atividade profissional da APAC X Tipo da UPS */

	/* consistencia comentada porque não tem nenhum registro para os tipos '01' e '07'  02/07/03 */

	/* comentada tambem por não ter tabela S_UPS nos hospitais /*
	/*
	if	(cd_atividade_prof_w		is not null) 	and
		(ie_tipo_ups_w			is not null) 	and
		(ie_tipo_ups_w			<> '99') 	then
		begin
		nr_seq_cdx_w		:= 0;
		select	nvl(max(nr_sequencia),0)
		into	nr_seq_cdx_w
		from	sus_s_cdx
		where	cd_pri_tabela	= '01'
		and	cd_seg_tabela	= '07'
		and	cd_item_pri_tabela	= ie_tipo_ups_w
		and	cd_item_seg_tabela	= to_char(cd_atividade_prof_w);
		if	(nr_seq_cdx_w = 0) then
			ds_erro_w	:= ds_erro_w || '2053 ';
		end if;
		end;
	end if;
	*/
	/* Consitencia do procedimento  X Tipo prestador da UPS */

	/*
	if	(cd_procedimento_w			is not null) 	and
		(ie_tipo_prestador_w			is not null) 	then
		begin
		nr_seq_cdx_w		:= 0;
		select	nvl(max(nr_sequencia),0)
		into	nr_seq_cdx_w
		from	sus_s_cdx
		where	cd_pri_tabela	= '20'
		and	cd_seg_tabela	= '02'
		and	cd_item_pri_tabela	= to_char(cd_procedimento_w)
		and	cd_item_seg_tabela	= ie_tipo_prestador_w;
		if	(nr_seq_cdx_w = 0) then
			ds_erro_w	:= ds_erro_w || '2054 ';
		end if;
		end;
	end if;
	*/
	/* Consitencia da atividade profissional da APAC X Procedimento */

	if (cd_atividade_prof_w IS NOT NULL AND cd_atividade_prof_w::text <> '') then
		begin
		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_atividade_w
		from	sus_atividade_prof_proc
		where	cd_procedimento		= cd_procedimento_w
		and	ie_origem_proced		= 3
		and	cd_atividade_profissional	= cd_atividade_prof_w;
		if (nr_seq_atividade_w		= 0) then
			ds_erro_w	:= ds_erro_w || '2047 ';
		end if;
		end;
	end if;

	/* Consitencia do tipo de APAC X Procedimento principal e secundário */

	begin
	select	ie_apac_inicial,
		ie_apac_continuidade,
		CASE WHEN ie_maxima='C2' THEN 13 WHEN ie_maxima='C3' THEN 9  ELSE somente_numero(coalesce(ie_maxima,'0')) END ,
		ie_maxima
	into STRICT	ie_apac_inicial_w,
		ie_apac_continuidade_w,
		qt_maxima_w,
		ie_maxima_w
	from	sus_apac_regra_tela
	where	cd_proc_principal	= cd_proc_principal_w
	and	cd_proc_secundario	= cd_procedimento_w
	and	cd_tratamento		= cd_tratamento_w;
	exception
		when others then
		begin
		ie_apac_inicial_w	:= 'X';
		ie_apac_continuidade_w	:= 'X';
		end;
	end;

	/* Procedimento secundario incompativel p/principal neste tratamento */

	if (ie_apac_inicial_w		= 'X') 	and (ie_apac_continuidade_w 	= 'X') 	then
		ds_erro_w	:= ds_erro_w || '2058 ';
	end if;

	if (ie_apac_inicial_w		<> 'X') and (ie_apac_continuidade_w 	<> 'X') then
		begin
		/* Validar APAC inicial */

		if (ie_tipo_apac_w	= 1)	and (ie_apac_inicial_w	= 'N')	then
			ds_erro_w	:= ds_erro_w || '2049 ';
		end if;

		/* Validar APAC continuidade */

		if (ie_tipo_apac_w		= 2)	and (ie_apac_continuidade_w	= 'N')	then
			ds_erro_w	:= ds_erro_w || '2050 ';
		end if;

		/* Validar quantidade do procedimento */

		if (qt_maxima_w		> 0)		and (qt_procedimento_w		> qt_maxima_w)	then
			ds_erro_w	:= ds_erro_w || '2051 ';
		end if;
		end;
	end if;

	/* Procedimento secundario X metastase */

	if (cd_varia_atrib_w = '29')						and (substr(cd_proc_principal_w,1,7) = '2917101')			and (substr(cd_procedimento_w,1,5) in ('29011','29021','29031','29041','29051','29061','29161'))	and (ie_metastase_w	= 'N')						then
		ds_erro_w	:= ds_erro_w || '2069 ';
	end if;
	/* este teste foi solicitado pelo hsj em maio05 */

	if (cd_varia_atrib_w		= '29')					and (cd_proc_principal_w	= 29031087)					and (cd_procedimento_w	= 29171016)					and (ie_metastase_w	= 'N')						then
		ds_erro_w	:= ds_erro_w || '2069 ';
	end if;

	/* Procedimento secundario X CGC Fornecedor */

	begin
	select	coalesce(max(a.dt_competencia),clock_timestamp()),
		coalesce(max(a.ie_cessao_credito),' '),
		coalesce(max(a.ie_pab),' '),
		coalesce(max(a.ie_faec),' '),
		coalesce(max(a.cd_rub),' '),
		coalesce(max(a.ds_aux),' ')
	into STRICT	dt_competencia_preco_w,
		ie_cessao_credito_w,
		ie_pab_w,
		ie_faec_w,
		cd_rub_w,
		ds_aux_w
	from	sus_preco_procbpa a
	where	a.cd_procedimento	= cd_procedimento_w
	and	a.ie_origem_proced	= 3
	and	a.dt_competencia	<= dt_competencia_w;
	end;

	if (ie_cessao_credito_w	= '3')	and (coalesce(cd_cgc_fornecedor_w::text, '') = '')	then
		ds_erro_w	:= ds_erro_w || '2093 ';
	end if;
	END;
end loop;
close C01;

/* 99.00 Teste de compatibilidade entre procedimentos */

if (position('2801115' in ds_procedimentos_w) > 0)	and (position('2801117' in ds_procedimentos_w) > 0)	then
	ds_erro_w	:= ds_erro_w || '2094 ';
end if;
if (position('2801101' in ds_procedimentos_w) > 0)	and (position('2801102' in ds_procedimentos_w) > 0)	then
	ds_erro_w	:= ds_erro_w || '2094 ';
end if;
if (position('2801101' in ds_procedimentos_w) > 0)	and (position('2801108' in ds_procedimentos_w) > 0)	then
	ds_erro_w	:= ds_erro_w || '2094 ';
end if;
if (position('2801102' in ds_procedimentos_w) > 0)	and (position('2801108' in ds_procedimentos_w) > 0)	then
	ds_erro_w	:= ds_erro_w || '2094 ';
end if;
if (position('3607101' in ds_procedimentos_w) > 0	or
	 position('3607102' in ds_procedimentos_w) > 0	or
	 position('3607103' in ds_procedimentos_w) > 0	or
	 position('3607104' in ds_procedimentos_w) > 0	or
	 position('3607106' in ds_procedimentos_w) > 0)	and (position('3607107' in ds_procedimentos_w) > 0	or
	 position('3607108' in ds_procedimentos_w) > 0)	then
	ds_erro_w	:= ds_erro_w || '2094 ';
end if;

/* 99.02 Motivo de cobrança X procedimento principal  */

select	coalesce(max(nr_sequencia),0)
into STRICT	nr_seq_motivo_cob_w
from	sus_s_cdx
where	cd_pri_tabela	= '20'
and	cd_seg_tabela	= '30'
and	cd_item_pri_tabela	= to_char(cd_proc_principal_w)
and	cd_item_seg_tabela	= to_char(cd_motivo_cobranca_w);

if (nr_seq_motivo_cob_w = 0) then
	ds_erro_w	:= ds_erro_w || '2048 ';
end if;

/* 99.03 Motivo de cobrança X tipo tratamento  */

if (cd_varia_atrib_w in ('36','20'))		and (substr(cd_motivo_cobranca_w,1,1) <> '5')	then
	ds_erro_w	:= ds_erro_w || '2065 ';
end if;

/* 99.04 Procedimentos para portadores de HIV - TRS  */

if (cd_varia_atrib_w = '27')						and (substr(cd_proc_principal_w,1,7) in ('2703111','2703112'))	and (ie_hiv_w	<> 'P')							then
	ds_erro_w	:= ds_erro_w || '2066 ';
end if;

/* 99.05 Procedimentos de quimioterapia  */

if (cd_varia_atrib_w = '29')				and (substr(cd_proc_principal_w,1,5) = '29161')	and (qt_idade_w	> 19)						then
	ds_erro_w	:= ds_erro_w || '2067 ';
end if;
if (cd_varia_atrib_w = '29')				and (substr(cd_proc_principal_w,1,5) <> '29161')	and (qt_idade_w	< 18)						then
	ds_erro_w	:= ds_erro_w || '2068 ';
end if;

/* 99.06 Procedimentos da radioterapia  */

if (cd_varia_atrib_w = '28')				and (substr(cd_proc_principal_w,1,7) = '2801114')	and (qt_idade_w	> 10)						then
	ds_erro_w	:= ds_erro_w || '2073 ';
end if;

/* 99.07 Procedimentos de medicamentos X CID principal */

if (cd_varia_atrib_w = '36')			and (cd_cid_principal_w IS NOT NULL AND cd_cid_principal_w::text <> '')	then
	begin
	nr_seq_geral_w	:= 0;
	select coalesce(max(nr_sequencia),0)
	into STRICT	 nr_seq_geral_w
	from	 sus_s_cdx
	where	 cd_pri_tabela		= '20'
	and	 cd_seg_tabela		= '32'
	and	 cd_item_pri_tabela	= to_char(cd_proc_principal_w)
	and	 cd_item_seg_tabela	= cd_cid_principal_w;
	if (nr_seq_geral_w	= 0) then
		ds_erro_w	:= ds_erro_w || '2074 ';
	end if;
	end;
end if;

/* 99.08 Procedimentos de medicamentos X CID secundario */

if (cd_varia_atrib_w = '36')			and (cd_cid_secundario_w IS NOT NULL AND cd_cid_secundario_w::text <> '')	then
	begin
	nr_seq_geral_w	:= 0;
	select coalesce(max(nr_sequencia),0)
	into STRICT	 nr_seq_geral_w
	from	 sus_s_cdx
	where	 cd_pri_tabela		= '20'
	and	 cd_seg_tabela		= '32'
	and	 cd_item_pri_tabela	= to_char(cd_proc_principal_w)
	and	 cd_item_seg_tabela	= cd_cid_secundario_w;
	if (nr_seq_geral_w	= 0) then
		ds_erro_w	:= ds_erro_w || '2075 ';
	end if;
	end;
end if;

/* 99.09 CID secundário para renal crônico */

if (cd_varia_atrib_w = '27')			then
	begin
	if (cd_cid_secundario_w in ('N180','N188','N189') or
		substr(cd_cid_secundario_w,1,3) = 'N19')	then
		ds_erro_w	:= ds_erro_w;
	else
		ds_erro_w	:= ds_erro_w || '2081 ';
	end if;
	end;
end if;

/* 99.10 Procedimento exclusivo para transplantado */

if (substr(cd_proc_principal_w,1,7) = '2704101')	and (coalesce(qt_tx_realizado_w::text, '') = '' or
	qt_tx_realizado_w		= 0)				then
	ds_erro_w	:= ds_erro_w || '2084 ';
end if;


ds_erro_p	:= ds_erro_w;


END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_proc_apac ( nr_sequencia_p bigint, ie_tipo_ups_p text, ie_tipo_prestador_p text, cd_proc_principal_p bigint, cd_tratamento_p text, ie_tipo_apac_p bigint, cd_varia_atrib_p text, ie_metastase_p text, dt_competencia_p timestamp, cd_motivo_cobranca_p bigint, ie_hiv_p text, qt_idade_p bigint, cd_cid_principal_p text, cd_cid_secundario_p text, qt_tx_realizado_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

