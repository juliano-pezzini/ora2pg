-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_cot_compra_integracao ( cd_estabelecimento_p bigint) AS $body$
DECLARE



nr_cot_compra_w			bigint;
ie_evento_w			varchar(15);
qt_existe_w			bigint;
ie_status_envio_w			varchar(15);
ie_operacao_envio_w		varchar(15);

c01 CURSOR FOR
SELECT	a.nr_cot_compra,
	b.ie_evento
from	cot_compra a,
	cot_compra_fila_transm b
where	a.nr_cot_compra = b.nr_cot_compra
and	a.cd_estabelecimento = cd_Estabelecimento_p
and	a.ie_status_envio = 'F'
and	((b.ie_evento = 'EN') or (b.ie_evento = 'EA') and (a.nr_documento_externo IS NOT NULL AND a.nr_documento_externo::text <> ''))  LIMIT 1;


BEGIN

open C01;
loop
fetch C01 into
	nr_cot_compra_w,
	ie_evento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (ie_evento_w = 'EN') then

		select	coalesce(max(ie_operacao_envio),'X')
		into STRICT	ie_operacao_envio_w
		from	cot_compra
		where	nr_cot_compra = nr_cot_compra_w;

		-- Envia integração WAS
		select	count(*)
		into STRICT	qt_existe_w
		from	cliente_integracao
		where	nr_seq_inf_integracao = 134
		and	ie_situacao = 'A'
		and	ie_operacao_envio_w <> 'WASE';

		if (qt_existe_w > 0) then
			CALL gerar_historico_cotacao(
				nr_cot_compra_w,
				Wheb_mensagem_pck.get_Texto(300283), /*'Envio da cotação por WebService(WAS)',*/
				Wheb_mensagem_pck.get_Texto(300285),/* 'A cotação de compras foi enviada por WebService.',*/
				'S',
				'Job');

			CALL gravar_agend_integracao(92,'nr_cot_compra=' || nr_cot_compra_w || ';');


			update	cot_compra
			set	ie_status_envio	= 'P'
			where	nr_cot_compra	= nr_cot_compra_w;

			insert into cot_compra_log_integracao(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_cot_compra,
				ie_status_envio,
				ie_tipo_integracao,
				ds_log)
			values (	nextval('cot_compra_log_integracao_seq'),
				clock_timestamp(),
				'Job',
				clock_timestamp(),
				'Job',
				nr_cot_compra_w,
				'P',
				'C',
				Wheb_mensagem_pck.get_Texto(300286)); /*'A cotação foi enviada para integração.');*/
		end if;

		-- Envia integração WASE
		select	count(*)
		into STRICT	qt_existe_w
		from	cliente_integracao
		where	nr_seq_inf_integracao = 221
		and	ie_situacao = 'A'
		and	ie_operacao_envio_w = 'WASE';

		if (qt_existe_w > 0) then
			CALL gerar_historico_cotacao(
				nr_cot_compra_w,
				Wheb_mensagem_pck.get_Texto(300288), /*'Envio da cotação por WebService(WASE)',*/
				Wheb_mensagem_pck.get_Texto(300290), /*'A cotação de compras foi enviada por WebService.',*/
				'S',
				'Job');

			CALL gravar_agend_integracao(141,'nr_cot_compra=' || nr_cot_compra_w || ';');

			update	cot_compra
			set	ie_status_envio	= 'P'
			where	nr_cot_compra	= nr_cot_compra_w;

			insert into cot_compra_log_integracao(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_cot_compra,
				ie_status_envio,
				ie_tipo_Integracao,
				ds_log)
			values (	nextval('cot_compra_log_integracao_seq'),
				clock_timestamp(),
				'Job',
				clock_timestamp(),
				'Job',
				nr_cot_compra_w,
				'P',
				'C',
				Wheb_mensagem_pck.get_Texto(300291)); /*'A cotação foi enviada para integração.');*/
		end if;
	end if;

	if (ie_evento_w = 'EA') then
		-- Envia integração WAU
		select	count(*)
		into STRICT	qt_existe_w
		from	cliente_integracao
		where	nr_seq_inf_integracao = 209
		and	ie_situacao = 'A';

		if (qt_existe_w > 0) then
			CALL gerar_historico_cotacao(
				nr_cot_compra_w,
				Wheb_mensagem_pck.get_Texto(300292), /*'Envio da alteração da cotação por WebService(WAU)',*/
				Wheb_mensagem_pck.get_Texto(300293), /*'As alterações da cotação de compras foram enviadas por WebService.',*/
				'S',
				'Job');

			CALL gravar_agend_integracao(131,'nr_cot_compra=' || nr_cot_compra_w || ';');

			update	cot_compra
			set	ie_status_envio	= 'P'
			where	nr_cot_compra	= nr_cot_compra_w;

			insert into cot_compra_log_integracao(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_cot_compra,
				ie_status_envio,
				ie_tipo_integracao,
				ds_log)
			values (	nextval('cot_compra_log_integracao_seq'),
				clock_timestamp(),
				'Job',
				clock_timestamp(),
				'Job',
				nr_cot_compra_w,
				'PA',
				'C',
				Wheb_mensagem_pck.get_Texto(300294));/* 'A alteração da cotação foi enviada para integração.');*/
		end if;
	end if;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_cot_compra_integracao ( cd_estabelecimento_p bigint) FROM PUBLIC;

