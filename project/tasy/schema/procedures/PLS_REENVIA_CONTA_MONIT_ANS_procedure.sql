-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_reenvia_conta_monit_ans ( nr_seq_monitor_guia_p bigint, nr_seq_prestador_p bigint, nr_seq_guia_ret_p bigint, nm_usuario_p text) AS $body$
DECLARE

			 
tb_seq_guia_w			pls_util_cta_pck.t_number_table;
qt_registro_transacao_w		integer := 1000;
			
C01 CURSOR( 	nr_seq_guia_ret_pc		pls_monitor_tiss_guia_ret.nr_sequencia%type) FOR 
	SELECT 	z.nr_sequencia 
	from 	pls_monitor_tiss_guia_ret 	b, 
		pls_monitor_tiss_alt_guia 	a, 
		pls_monitor_tiss_alt 		z, 
		pls_monitor_tiss_guia		d 
	where 	b.nr_sequencia		 	= nr_seq_guia_ret_pc 
	and	a.nr_seq_guia_monitor		= b.nr_seq_guia_monitor 
	and	z.nr_sequencia 			= a.nr_seq_cta_alt 
	and	a.nr_seq_guia_monitor		= d.nr_sequencia;
	
C02 CURSOR( 	nr_seq_guia_ret_pc		pls_monitor_tiss_guia_ret.nr_sequencia%type) FOR 
	SELECT 	a.nr_seq_chave_guia 
	from 	pls_monitor_tiss_guia_ret b, 
		pls_monitor_tiss_guia a 
	where 	b.nr_sequencia		= nr_seq_guia_ret_pc 
	and	a.nr_sequencia 		= b.nr_seq_guia_monitor;


BEGIN 
 
update	pls_monitor_tiss_guia_ret 
set	nr_seq_guia_monitor	= nr_seq_monitor_guia_p, 
	nr_seq_prestador	= nr_seq_prestador_p, 
	nm_usuario		= nm_usuario_p, 
	dt_atualizacao		= clock_timestamp() 
where	nr_sequencia		= nr_seq_guia_ret_p;
 
open C01( nr_seq_guia_ret_p );
loop 
	tb_seq_guia_w.delete;
	 
	fetch C01 bulk collect into tb_seq_guia_w 
	limit qt_registro_transacao_w;
	 
	exit when tb_seq_guia_w.count = 0;
	 
	-- manda para o banco 
	forall i in tb_seq_guia_w.first .. tb_seq_guia_w.last 
		 
		update 	pls_monitor_tiss_alt a 
		set	a.ie_status = 'N', 
			a.dt_atualizacao = clock_timestamp(), 
			a.nm_usuario 	= nm_usuario_p 
		where	a.nr_sequencia = tb_seq_guia_w(i);
	commit;
	 
	end loop;
close C01;
 
open C02(nr_seq_guia_ret_p );
loop 
	tb_seq_guia_w.delete;
	 
	fetch C02 bulk collect into tb_seq_guia_w 
	limit qt_registro_transacao_w;
	 
	exit when tb_seq_guia_w.count = 0;
	 
	-- manda para o banco 
	forall i in tb_seq_guia_w.first .. tb_seq_guia_w.last 
		 
		update 	pls_moni_tiss_chave_guia a 
		set	a.ie_status = 'N', 
			a.dt_atualizacao = clock_timestamp(), 
			a.nm_usuario 	= nm_usuario_p 
		where	a.nr_sequencia = tb_seq_guia_w(i);
	commit;
	 
	end loop;
close C02;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_reenvia_conta_monit_ans ( nr_seq_monitor_guia_p bigint, nr_seq_prestador_p bigint, nr_seq_guia_ret_p bigint, nm_usuario_p text) FROM PUBLIC;

