-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_conta_pos ( nr_seq_analise_p bigint, nr_seq_conta_p bigint, ie_opcao_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Gerar as informacoes atuais da conta nas tabelas "W" e tambem atualizar as contas com as 
informacoes das tabelas "W" ao dar ok, passar "G" para gerar as informacoes e "A" para atualizar
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  ]  Objetos do dicionario [ X ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:

QUANDO INCLUIR QUALQUER CAMPO NOS UPDATES, DEVE SER TRATADO O MESMO NO HISTORICO

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ds_observacao_w			varchar(4000);
ds_indicacao_clinica_w		varchar(500);
cd_senha_externa_w		varchar(30);
nr_crm_exec_w			varchar(20);
cd_medico_executor_w		varchar(20);
cd_medico_solicitante_w		varchar(10);
ie_tipo_guia_w			varchar(2);
ie_carater_internacao_w		varchar(1);
ie_regime_internacao_w		varchar(1);
ie_indicacao_acidente_w		varchar(1);
ie_tipo_doenca_w		varchar(1);
ie_transtorno_w			varchar(1);
ie_classificacao_w		varchar(1);
nr_seq_segurado_w		bigint;
nr_seq_prestador_exec_w		bigint;
nr_seq_prestador_solic_w	bigint;
nr_seq_saida_int_w		bigint;
nr_seq_conta_w			bigint;
nr_seq_clinica_w		bigint;
nr_seq_tipo_acomodacao_w	bigint;
nr_seq_saida_spsadt_w		bigint;
nr_seq_tipo_atendimento_w	bigint;
nr_seq_saida_consulta_w		bigint;
nr_seq_cbo_saude_w		bigint;
nr_seq_cbo_saude_solic_w	bigint;
nr_seq_grau_partic_w		bigint;
nr_seq_tipo_conta_w		bigint;
qt_registro_w			bigint;
nr_seq_item_w			bigint;
nr_seq_conta_item_w		bigint;
ie_obito_mulher_w		smallint;
ie_tipo_consulta_w		smallint;
dt_entrada_w			timestamp;
dt_alta_w			timestamp;
dt_atendimento_w		timestamp;
nr_seq_prestador_exec_orig_w	bigint;
ds_historico_w			varchar(4000);
/* Dados da conta anterior */

nr_seq_segurado_ant_w		bigint;
nr_seq_prestador_exec_ant_w	bigint;
nr_seq_prestador_solic_ant_w	bigint;
ie_carater_internacao_ant_w	varchar(3);
nr_seq_saida_int_ant_w		bigint;
ie_tipo_guia_ant_w		varchar(2);
nr_seq_clinica_ant_w		bigint;
ie_regime_internacao_ant_w	varchar(1);
ie_indicacao_acidente_ant_w	varchar(1);
nr_seq_tipo_acomodacao_ant_w	bigint;
nr_seq_saida_spsadt_ant_w	bigint;
nr_seq_tipo_atendimento_ant_w	bigint;
ie_tipo_doenca_ant_w		varchar(1);
nr_seq_saida_consulta_ant_w	bigint;
ie_tipo_consulta_ant_w		varchar(3);
dt_entrada_ant_w		timestamp;
dt_alta_ant_w			timestamp;
dt_atendimento_ant_w		timestamp;
cd_senha_externa_ant_w		varchar(30);
nr_crm_exec_ant_w		varchar(20);
cd_medico_solicitante_ant_w	varchar(10);
cd_medico_executor_ant_w	varchar(10);
ds_indicacao_clinica_ant_w	varchar(500);
nr_seq_cbo_saude_ant_w		bigint;
nr_seq_cbo_saude_solic_ant_w	bigint;
nr_seq_grau_partic_ant_w	bigint;
nr_seq_tipo_conta_ant_w		bigint;
ie_tipo_acomodacao_ptu_w	varchar(2);
ie_tipo_acomodacao_ptu_ww	varchar(2);
nr_seq_prestador_w		pls_conta_pos_cabecalho.nr_seq_prestador%type;
ie_recem_nascido_w		pls_conta_pos_cabecalho.ie_recem_nascido%type;
ie_recem_nascido_ant_w		pls_conta_pos_cabecalho.ie_recem_nascido%type;
ie_preco_plano_w		pls_plano.ie_preco%type;
ie_tipo_segurado_w		pls_segurado.ie_tipo_segurado%type;
nr_seq_plano_w			pls_segurado.nr_seq_plano%type;
cd_doenca_w			pls_diag_conta_obito_pos.cd_doenca%type;
ds_diagnostico_w		pls_diagnostico_conta_pos.ds_diagnostico%type;
ie_classific_diag_w		pls_diagnostico_conta_pos.ie_classificacao%type;
qt_reg_w			integer;
ie_indicador_dorn_w		pls_diag_conta_obito_pos.ie_indicador_dorn%type;
nr_declaracao_obito_w		pls_diag_conta_obito_pos.nr_declaracao_obito%type;
nr_decl_nasc_vivo_w		pls_diagnos_nasc_viv_pos.nr_decl_nasc_vivo%type;
cd_doenca_ant_w			pls_diag_conta_obito_pos.cd_doenca%type;
ds_diagnostico_ant_w		pls_diagnostico_conta_pos.ds_diagnostico%type;
ie_classific_diag_ant_w		pls_diagnostico_conta_pos.ie_classificacao%type;
ie_indicador_dorn_ant_w		pls_diag_conta_obito_pos.ie_indicador_dorn%type;
nr_declaracao_obito_ant_w	pls_diag_conta_obito_pos.nr_declaracao_obito%type;
nr_decl_nasc_vivo_ant_w		pls_diagnos_nasc_viv_pos.nr_decl_nasc_vivo%type;
ie_novo_pos_estab_w		pls_visible_false.ie_novo_pos_estab%type;
ie_regime_atendimento_w		pls_conta_pos_cabecalho.ie_regime_atendimento%type;
ie_saude_ocupacional_w		pls_conta_pos_cabecalho.ie_saude_ocupacional%type;
ie_regime_atendimento_ant_w	pls_conta_pos_cabecalho.ie_regime_atendimento%type;
ie_saude_ocupacional_ant_w	pls_conta_pos_cabecalho.ie_saude_ocupacional%type;


BEGIN

select	coalesce(max(ie_novo_pos_estab),'N')
into STRICT	ie_novo_pos_estab_w
from	pls_visible_false
where	cd_estabelecimento = cd_estabelecimento_p;

if (ie_opcao_p = 'G') then
	delete	from w_pls_conta_alteracao
	where	nr_seq_conta	= nr_seq_conta_p
	and	nm_usuario	= nm_usuario_p;
	
	if (ie_novo_pos_estab_w = 'S') then
		delete	FROM w_pls_diagnostico_conta
		where	nr_seq_conta	= nr_seq_conta_p
		and	nm_usuario	= nm_usuario_p;
		
		delete	FROM w_pls_diagnost_conta_obito
		where	nr_seq_conta	= nr_seq_conta_p
		and	nm_usuario	= nm_usuario_p;
		
		delete	FROM w_pls_diagnostico_nasc_viv
		where	nr_seq_conta	= nr_seq_conta_p
		and	nm_usuario	= nm_usuario_p;
	end if;
	
	select	nr_seq_conta,
		nr_seq_segurado,
		nr_seq_tipo_atendimento,
		dt_alta,
		nr_seq_saida_spsadt,
		dt_entrada,
		ie_tipo_consulta,
		dt_atendimento,
		cd_medico_solicitante,
		cd_medico_executor,
		ie_carater_internacao,
		ie_indicacao_acidente,
		nr_seq_tipo_acomodacao,
		nr_seq_clinica,
		ie_regime_internacao,
		ie_recem_nascido,
		nr_seq_saida_consulta,
		nr_seq_saida_int,       
		ie_tipo_guia,              
		nr_seq_prestador,       
		nr_seq_prestador_exec,
		ie_tipo_doenca,
		cd_senha_externa,
		nr_seq_grau_partic,
		nr_seq_tipo_conta,
		ie_regime_atendimento,
		ie_saude_ocupacional
	into STRICT	nr_seq_conta_w,
		nr_seq_segurado_w,
		nr_seq_tipo_atendimento_w,
		dt_alta_w,
		nr_seq_saida_spsadt_w,
		dt_entrada_w,
		ie_tipo_consulta_w,
		dt_atendimento_w,
		cd_medico_solicitante_w,
		cd_medico_executor_w,
		ie_carater_internacao_w,
		ie_indicacao_acidente_w,
		nr_seq_tipo_acomodacao_w,
		nr_seq_clinica_w,
		ie_regime_internacao_w,
		ie_recem_nascido_w,
		nr_seq_saida_consulta_w,  
		nr_seq_saida_int_w,       
		ie_tipo_guia_w,             
		nr_seq_prestador_solic_w,       
		nr_seq_prestador_exec_w,
		ie_tipo_doenca_w,
		cd_senha_externa_w,
		nr_seq_grau_partic_w,
		nr_seq_tipo_conta_w,
		ie_regime_atendimento_w,
		ie_saude_ocupacional_w
	from	pls_conta_pos_cabecalho		a
	where	a.nr_seq_conta   = nr_seq_conta_p;

	insert into w_pls_conta_alteracao(nr_sequencia,
		dt_atualizacao,
		dt_atualizacao_nrec,
		nm_usuario,
		nm_usuario_nrec,
		nr_seq_segurado,
		nr_seq_prestador_exec,
		nr_seq_prestador,
		ie_carater_internacao,
		nr_seq_saida_int,
		nr_seq_conta,
		ie_tipo_guia,
		nr_seq_clinica,
		ie_regime_internacao,
		ie_indicacao_acidente,
		nr_seq_tipo_acomodacao,
		nr_seq_saida_spsadt,
		nr_seq_tipo_atendimento,
		ie_tipo_doenca,
		nr_seq_saida_consulta,
		dt_entrada,
		dt_alta,
		dt_atendimento,
		cd_senha_externa,
		cd_medico_solicitante,
		cd_medico_executor,
		nr_seq_grau_partic,
		ie_tipo_consulta,
		ie_recem_nascido,
		nr_seq_tipo_conta,
		ie_regime_atendimento,
		ie_saude_ocupacional)
	values (nextval('w_pls_conta_alteracao_seq'),
		clock_timestamp(),
		clock_timestamp(),
		nm_usuario_p,
		nm_usuario_p,
		nr_seq_segurado_w,
		nr_seq_prestador_exec_w,
		nr_seq_prestador_solic_w,
		ie_carater_internacao_w,
		nr_seq_saida_int_w,
		nr_seq_conta_w,
		ie_tipo_guia_w,
		nr_seq_clinica_w,
		ie_regime_internacao_w,
		ie_indicacao_acidente_w,
		nr_seq_tipo_acomodacao_w,
		nr_seq_saida_spsadt_w,
		nr_seq_tipo_atendimento_w,
		ie_tipo_doenca_w,
		nr_seq_saida_consulta_w,
		dt_entrada_w,
		dt_alta_w,
		dt_atendimento_w,
		cd_senha_externa_w,
		cd_medico_solicitante_w,
		cd_medico_executor_w,
		nr_seq_grau_partic_w,
		ie_tipo_consulta_w,
		ie_recem_nascido_w,
		nr_seq_tipo_conta_w,
		ie_regime_atendimento_w,
		ie_saude_ocupacional_w);
	
	if (ie_novo_pos_estab_w = 'S') then
		select	max(cd_doenca),
			max(ds_diagnostico),
			max(ie_classificacao),
			count(1)
		into STRICT	cd_doenca_w,
			ds_diagnostico_w,
			ie_classific_diag_w,
			qt_reg_w
		from	pls_diagnostico_conta_pos
		where	nr_seq_conta = nr_seq_conta_p;
		
		if (qt_reg_w > 0) then
			insert	into	w_pls_diagnostico_conta(	cd_doenca, ds_diagnostico, dt_atualizacao,
					dt_atualizacao_nrec, ie_classificacao, nm_usuario,
					nm_usuario_nrec, nr_seq_conta, nr_sequencia)
			values (	cd_doenca_w, ds_diagnostico_w, clock_timestamp(),
					clock_timestamp(), ie_classific_diag_w, nm_usuario_p,
					nm_usuario_p, nr_seq_conta_p, nextval('w_pls_diagnostico_conta_seq'));
		end if;
		
		select	max(cd_doenca),
			max(ie_indicador_dorn),
			max(nr_declaracao_obito),
			count(1)
		into STRICT	cd_doenca_w,
			ie_indicador_dorn_w,
			nr_declaracao_obito_w,
			qt_reg_w
		from	pls_diag_conta_obito_pos
		where	nr_seq_conta = nr_seq_conta_p;
		
		if (qt_reg_w > 0) then
			insert	into	w_pls_diagnost_conta_obito(	cd_doenca, dt_atualizacao, dt_atualizacao_nrec,
					ie_indicador_dorn, nm_usuario, nm_usuario_nrec,
					nr_declaracao_obito, nr_seq_conta, nr_sequencia)
			values (	cd_doenca_w, clock_timestamp(), clock_timestamp(),
					ie_indicador_dorn_w, nm_usuario_p, nm_usuario_p,
					nr_declaracao_obito_w, nr_seq_conta_p, nextval('w_pls_diagnost_conta_obito_seq'));
			commit;
		end if;
		
		select	max(nr_decl_nasc_vivo),
			count(1)
		into STRICT	nr_decl_nasc_vivo_w,
			qt_reg_w
		from	pls_diagnos_nasc_viv_pos
		where	nr_seq_conta = nr_seq_conta_p;
		
		if (qt_reg_w > 0) then
			insert	into	w_pls_diagnostico_nasc_viv(	dt_atualizacao, dt_atualizacao_nrec, nm_usuario,
					nm_usuario_nrec, nr_decl_nasc_vivo, nr_seq_conta,
					nr_sequencia)
			values (	clock_timestamp(), clock_timestamp(), nm_usuario_p,
					nm_usuario_p, nr_decl_nasc_vivo_w, nr_seq_conta_p,
					nextval('w_pls_diagnostico_nasc_viv_seq'));
			commit;
		end if;
	end if;
	
elsif (ie_opcao_p = 'A') then

	select	nr_seq_segurado,
		nr_seq_tipo_atendimento,
		dt_alta,
		nr_seq_saida_spsadt,
		dt_entrada,
		ie_tipo_consulta,
		dt_atendimento,
		cd_medico_solicitante,
		cd_medico_executor,
		ie_carater_internacao,
		ie_indicacao_acidente,
		nr_seq_tipo_acomodacao,
		nr_seq_clinica,
		ie_regime_internacao,
		ie_recem_nascido,
		nr_seq_saida_consulta,
		nr_seq_saida_int,       
		ie_tipo_guia,              
		nr_seq_prestador,       
		nr_seq_prestador_exec,
		ie_tipo_doenca,
		cd_senha_externa,
		nr_seq_grau_partic,
		nr_seq_tipo_conta,
		ie_regime_atendimento,
		ie_saude_ocupacional
	into STRICT	nr_seq_segurado_ant_w,
		nr_seq_tipo_atendimento_ant_w,
		dt_alta_ant_w,
		nr_seq_saida_spsadt_ant_w,
		dt_entrada_ant_w,
		ie_tipo_consulta_ant_w,
		dt_atendimento_ant_w,
		cd_medico_solicitante_ant_w,
		cd_medico_executor_ant_w,
		ie_carater_internacao_ant_w,
		ie_indicacao_acidente_ant_w,
		nr_seq_tipo_acomodacao_ant_w,
		nr_seq_clinica_ant_w,
		ie_regime_internacao_ant_w,
		ie_recem_nascido_ant_w,
		nr_seq_saida_consulta_ant_w,  
		nr_seq_saida_int_ant_w,       
		ie_tipo_guia_ant_w,             
		nr_seq_prestador_solic_ant_w,       
		nr_seq_prestador_exec_ant_w,
		ie_tipo_doenca_ant_w,
		cd_senha_externa_ant_w,
		nr_seq_grau_partic_ant_w,
		nr_seq_tipo_conta_ant_w,
		ie_regime_atendimento_ant_w,
		ie_saude_ocupacional_ant_w
	from	pls_conta_pos_cabecalho		a
	where	a.nr_seq_conta   = nr_seq_conta_p;
	
	nr_seq_prestador_exec_orig_w := nr_seq_prestador_exec_ant_w;
	
	select	nr_seq_segurado,
		nr_seq_prestador_exec,
		nr_seq_prestador,
		ie_carater_internacao,
		nr_seq_saida_int,
		nr_seq_conta,
		ie_tipo_guia,
		nr_seq_clinica,
		ie_regime_internacao,
		ie_indicacao_acidente,
		nr_seq_tipo_acomodacao,
		nr_seq_saida_spsadt,
		nr_seq_tipo_atendimento,
		ie_tipo_doenca,
		nr_seq_saida_consulta,
		dt_entrada,
		dt_alta,
		dt_atendimento,
		cd_senha_externa,
		cd_medico_solicitante,
		cd_medico_executor,
		nr_seq_grau_partic,
		ie_tipo_consulta,
		ie_recem_nascido,
		nr_seq_tipo_conta
	into STRICT	nr_seq_segurado_w,
		nr_seq_prestador_exec_w,
		nr_seq_prestador_solic_w,
		ie_carater_internacao_w,
		nr_seq_saida_int_w,
		nr_seq_conta_w,
		ie_tipo_guia_w,
		nr_seq_clinica_w,
		ie_regime_internacao_w,
		ie_indicacao_acidente_w,
		nr_seq_tipo_acomodacao_w,
		nr_seq_saida_spsadt_w,
		nr_seq_tipo_atendimento_w,
		ie_tipo_doenca_w,
		nr_seq_saida_consulta_w,
		dt_entrada_w,
		dt_alta_w,
		dt_atendimento_w,
		cd_senha_externa_w,
		cd_medico_solicitante_w,
		cd_medico_executor_w,
		nr_seq_grau_partic_w,
		ie_tipo_consulta_w,
		ie_recem_nascido_w,
		nr_seq_tipo_conta_w
	from	w_pls_conta_alteracao	a
	where	a.nr_seq_conta   = nr_seq_conta_p
	and	nm_usuario	 = nm_usuario_p;
	
	update	pls_conta_pos_cabecalho
	set	nr_seq_segurado			= nr_seq_segurado_w,
		nr_seq_tipo_atendimento		= nr_seq_tipo_atendimento_w,
		dt_alta				= dt_alta_w,
		nr_seq_saida_spsadt		= nr_seq_saida_spsadt_w,
		dt_entrada			= dt_entrada_w,
		ie_tipo_consulta		= ie_tipo_consulta_w,
		dt_atendimento			= dt_atendimento_w,
		cd_medico_solicitante		= cd_medico_solicitante_w,
		cd_medico_executor		= cd_medico_executor_w,
		ie_carater_internacao		= ie_carater_internacao_w,
		ie_indicacao_acidente		= ie_indicacao_acidente_w,
		nr_seq_tipo_acomodacao		= nr_seq_tipo_acomodacao_w,
		nr_seq_clinica			= nr_seq_clinica_w,
		ie_regime_internacao		= ie_regime_internacao_w,
		ie_recem_nascido		= ie_recem_nascido_w,
		nr_seq_saida_consulta		= nr_seq_saida_consulta_w,
		nr_seq_saida_int		= nr_seq_saida_int_w,       
		ie_tipo_guia			= ie_tipo_guia_w,              
		nr_seq_prestador		= nr_seq_prestador_solic_w,       
		nr_seq_prestador_exec		= nr_seq_prestador_exec_w,
		ie_tipo_doenca			= ie_tipo_doenca_w,
		cd_senha_externa		= cd_senha_externa_w,
		nr_seq_grau_partic		= nr_seq_grau_partic_w,
		nr_seq_tipo_conta		= nr_seq_tipo_conta_w,
		ie_regime_atendimento	= ie_regime_atendimento_w,
		ie_saude_ocupacional	= ie_saude_ocupacional_w
	where	nr_seq_conta			= nr_seq_conta_p;
	
	ds_historico_w	:= null;
	
	if (ie_novo_pos_estab_w = 'S') then
		select	max(cd_doenca),
			max(ds_diagnostico),
			max(ie_classificacao),
			count(1)
		into STRICT	cd_doenca_ant_w,
			ds_diagnostico_ant_w,
			ie_classific_diag_ant_w,
			qt_reg_w
		from	pls_diagnostico_conta_pos
		where	nr_seq_conta = nr_seq_conta_p;
		
		if (qt_reg_w > 0) then
			select	max(cd_doenca),
				max(ds_diagnostico),
				max(ie_classificacao)
			into STRICT	cd_doenca_w,
				ds_diagnostico_w,
				ie_classific_diag_w
			from	w_pls_diagnostico_conta
			where	nr_seq_conta = nr_seq_conta_p;
			
			update	pls_diagnostico_conta_pos
			set	cd_doenca = cd_doenca_w,
				ds_diagnostico = ds_diagnostico_w,
				ie_classificacao = ie_classific_diag_w,
				dt_atualizacao = clock_timestamp(),
				nm_usuario = nm_usuario_p
			where	nr_seq_conta = nr_seq_conta_p;
			
			if (coalesce(cd_doenca_w,'X') <> coalesce(cd_doenca_ant_w,'X')) then
				ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado CID do diagnostico de ' || cd_doenca_ant_w || ' para ' || cd_doenca_w;
			end if;
			
			if (coalesce(ds_diagnostico_w,'X') <> coalesce(ds_diagnostico_ant_w,'X')) then
				ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado descricao do diagnostico de ' || ds_diagnostico_ant_w || ' para ' || ds_diagnostico_w;
			end if;
			
			if (coalesce(ie_classific_diag_w,'X') <> coalesce(ie_classific_diag_ant_w,'X')) then
				ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado classificacao do diagnostico de ' || ie_classific_diag_ant_w || ' para ' || ie_classific_diag_w;
			end if;
		end if;
		
		select	max(cd_doenca),
			max(ie_indicador_dorn),
			max(nr_declaracao_obito),
			count(1)
		into STRICT	cd_doenca_ant_w,
			ie_indicador_dorn_ant_w,
			nr_declaracao_obito_ant_w,
			qt_reg_w
		from	pls_diag_conta_obito_pos
		where	nr_seq_conta = nr_seq_conta_p;
		
		if (qt_reg_w > 0) then
			select	max(cd_doenca),
				max(ie_indicador_dorn),
				max(nr_declaracao_obito)
			into STRICT	cd_doenca_w,
				ie_indicador_dorn_w,
				nr_declaracao_obito_w
			from	w_pls_diagnost_conta_obito
			where	nr_seq_conta = nr_seq_conta_p;
			
			update	pls_diag_conta_obito_pos
			set	cd_doenca = cd_doenca_w,
				ie_indicador_dorn = ie_indicador_dorn_w,
				nr_declaracao_obito = nr_declaracao_obito_w,
				dt_atualizacao = clock_timestamp(),
				nm_usuario = nm_usuario_p
			where	nr_seq_conta = nr_seq_conta_p;
			
			if (coalesce(cd_doenca_w,'X') <> coalesce(cd_doenca_ant_w,'X')) then
				ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado CID do obito de ' || cd_doenca_ant_w || ' para ' || cd_doenca_w;
			end if;
			
			if (coalesce(ie_indicador_dorn_w,'X') <> coalesce(ie_indicador_dorn_ant_w,'X')) then
				ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado indicador de obito de RN de ' || ie_indicador_dorn_ant_w || ' para ' || ie_indicador_dorn_w;
			end if;
			
			if (coalesce(nr_declaracao_obito_w,'X') <> coalesce(nr_declaracao_obito_ant_w,'X')) then
				ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado declaracao de obito de ' || nr_declaracao_obito_ant_w || ' para ' || nr_declaracao_obito_w;
			end if;
		end if;
		
		select	max(nr_decl_nasc_vivo),
			count(1)
		into STRICT	nr_decl_nasc_vivo_ant_w,
			qt_reg_w
		from	pls_diagnos_nasc_viv_pos
		where	nr_seq_conta = nr_seq_conta_p;
		
		if (qt_reg_w > 0) then
			select	max(nr_decl_nasc_vivo)
			into STRICT	nr_decl_nasc_vivo_w
			from	w_pls_diagnostico_nasc_viv
			where	nr_seq_conta = nr_seq_conta_p;
			
			update	pls_diagnos_nasc_viv_pos
			set	nr_decl_nasc_vivo = nr_decl_nasc_vivo_w,
				dt_atualizacao = clock_timestamp(),
				nm_usuario = nm_usuario_p
			where	nr_seq_conta = nr_seq_conta_p;
			
			if (coalesce(nr_decl_nasc_vivo_w,'X') <> coalesce(nr_decl_nasc_vivo_ant_w,'X')) then
				ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado declaracao de nascido-vivo de ' || nr_decl_nasc_vivo_ant_w || ' para ' || nr_decl_nasc_vivo_w;
			end if;
		end if;
	end if;
	
	/* Gravar historico na analise da alteracao */

	if (coalesce(nr_seq_segurado_w,0) <> coalesce(nr_seq_segurado_ant_w,0)) then
		select	max(nr_seq_plano),
			max(ie_tipo_segurado)
		into STRICT	nr_seq_plano_w,
			ie_tipo_segurado_w
		from	pls_segurado
		where	nr_sequencia	= nr_seq_segurado_w;
		
		if (nr_seq_plano_w IS NOT NULL AND nr_seq_plano_w::text <> '') then
			select	max(ie_preco)
			into STRICT	ie_preco_plano_w
			from	pls_plano
			where	nr_sequencia	= nr_seq_plano_w;
		end if;
		
		if	(not((ie_preco_plano_w in ('2','3')) or (ie_tipo_segurado_w in ('I','C','T','H')))) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(247098);
		end if;
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado beneficiario de ' || nr_seq_segurado_ant_w || ' para ' || nr_seq_segurado_w;
		
		--aaschlote 16/02/2016 OS 996873
		update	pls_analise_conta
		set	nr_seq_segurado	= nr_seq_segurado_w
		where	nr_sequencia	= nr_seq_analise_p;
		
	end if;
	if (coalesce(nr_seq_prestador_exec_w,0) <> coalesce(nr_seq_prestador_exec_ant_w,0)) then
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado prestador exec de ' || nr_seq_prestador_exec_ant_w || ' para ' || nr_seq_prestador_exec_w;
	end if;
	if (coalesce(nr_seq_prestador_solic_w,0) <> coalesce(nr_seq_prestador_solic_ant_w,0)) then
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado prestador solic de ' || nr_seq_prestador_solic_ant_w || ' para ' || nr_seq_prestador_solic_w;
	end if;
	if (coalesce(ie_carater_internacao_w,0) <> coalesce(ie_carater_internacao_ant_w,0)) then
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado carater internacao de ' || ie_carater_internacao_ant_w || ' para ' || ie_carater_internacao_w;
	end if;
	if (coalesce(nr_seq_saida_int_w,0) <> coalesce(nr_seq_saida_int_ant_w,0)) then
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado tipo saida internacao de ' || nr_seq_saida_int_ant_w || ' para ' || nr_seq_saida_int_w;
	end if;
	
	if (coalesce(ie_tipo_guia_w,0) <> coalesce(ie_tipo_guia_ant_w,0)) then
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado tipo de guia de ' || ie_tipo_guia_ant_w || ' para ' || ie_tipo_guia_w;
	end if;
	if (coalesce(nr_seq_clinica_w,0) <> coalesce(nr_seq_clinica_ant_w,0)) then
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado clinica de ' || nr_seq_clinica_ant_w || ' para ' || nr_seq_clinica_w;
	end if;
	if (coalesce(ie_regime_internacao_w,0) <> coalesce(ie_regime_internacao_ant_w,0)) then
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado regime internacao de ' || ie_regime_internacao_ant_w || ' para ' || ie_regime_internacao_w;
	end if;
	if (coalesce(ie_indicacao_acidente_w,0) <> coalesce(ie_indicacao_acidente_ant_w,0)) then
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado indicacao acid. de ' || ie_indicacao_acidente_ant_w || ' para ' || ie_indicacao_acidente_w;
	end if;
	if (coalesce(nr_seq_tipo_acomodacao_w,0) <> coalesce(nr_seq_tipo_acomodacao_ant_w,0)) then
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado tipo acomod. de ' || nr_seq_tipo_acomodacao_ant_w || ' para ' || nr_seq_tipo_acomodacao_w;
	end if;
	if (coalesce(nr_seq_saida_spsadt_w,0) <> coalesce(nr_seq_saida_spsadt_ant_w,0)) then
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado tipo saida SADT de ' || nr_seq_saida_spsadt_ant_w || ' para ' || nr_seq_saida_spsadt_w;
	end if;
	if (coalesce(nr_seq_tipo_atendimento_w,0) <> coalesce(nr_seq_tipo_atendimento_ant_w,0)) then
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado tipo atend. de ' || nr_seq_tipo_atendimento_ant_w || ' para ' || nr_seq_tipo_atendimento_w;
	end if;
	if (coalesce(ie_regime_atendimento_w,0) <> coalesce(ie_regime_atendimento_ant_w,0)) then
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado regime atend. de ' || ie_regime_atendimento_ant_w || ' para ' || ie_regime_atendimento_w;
	end if;
	if (coalesce(ie_saude_ocupacional_w,0) <> coalesce(ie_saude_ocupacional_ant_w,0)) then
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado saude ocupacional de ' || ie_saude_ocupacional_ant_w || ' para ' || ie_saude_ocupacional_w;
	end if;
	if (coalesce(ie_tipo_doenca_w,0) <> coalesce(ie_tipo_doenca_ant_w,0)) then
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado tipo doenca de ' || ie_tipo_doenca_ant_w || ' para ' || ie_tipo_doenca_w;
	end if;
	if (coalesce(nr_seq_saida_consulta_w,0) <> coalesce(nr_seq_saida_consulta_ant_w,0)) then
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado tipo saida cons. de ' || nr_seq_saida_consulta_ant_w || ' para ' || nr_seq_saida_consulta_w;
	end if;
	if (coalesce(ie_tipo_consulta_w,0) <> coalesce(ie_tipo_consulta_ant_w,0)) then
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado tipo consulta de ' || ie_tipo_consulta_ant_w || ' para ' || ie_tipo_consulta_w;
	end if;
	if (coalesce(dt_entrada_w,clock_timestamp()) <> coalesce(dt_entrada_ant_w,clock_timestamp())) then
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado data de entrada de ' || dt_entrada_ant_w || ' para ' || dt_entrada_w;
	end if;
	if (coalesce(dt_alta_w,clock_timestamp()) <> coalesce(dt_alta_ant_w,clock_timestamp())) then
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado data de alta de ' || dt_alta_ant_w || ' para ' || dt_alta_w;
	end if;
	if (coalesce(dt_atendimento_w,clock_timestamp()) <> coalesce(dt_atendimento_ant_w,clock_timestamp())) then
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado data atendimento de ' || dt_atendimento_ant_w || ' para ' || dt_atendimento_w;
	end if;
	if (coalesce(cd_senha_externa_w,0) <> coalesce(cd_senha_externa_ant_w,0)) then
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado senha externa de ' || cd_senha_externa_ant_w || ' para ' || cd_senha_externa_w;
	end if;
	if (coalesce(cd_medico_solicitante_w,0) <> coalesce(cd_medico_solicitante_ant_w,0)) then
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado medico solic. de ' || cd_medico_solicitante_ant_w || ' para ' || cd_medico_solicitante_w;
	end if;
	if (coalesce(cd_medico_executor_w,0) <> coalesce(cd_medico_executor_ant_w,0)) then
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado medico exec. de ' || cd_medico_executor_ant_w || ' para ' || cd_medico_executor_w;
	end if;
	if (coalesce(nr_seq_grau_partic_w,0) <> coalesce(nr_seq_grau_partic_ant_w,0)) then
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado grau de partic. de ' || nr_seq_grau_partic_ant_w || ' para ' || nr_seq_grau_partic_w;
	end if;
	
	if (coalesce(nr_seq_tipo_conta_w,0) <> coalesce(nr_seq_tipo_conta_ant_w,0)) then
		ds_historico_w	:= ds_historico_w || chr(13) || chr(10) || 'Alterado tipo conta de ' || nr_seq_tipo_conta_ant_w || ' para ' || nr_seq_tipo_conta_w;
	end if;	
	
	if (ds_historico_w IS NOT NULL AND ds_historico_w::text <> '') then
		ds_historico_w	:= 'Conta: ' || nr_seq_conta_p|| ds_historico_w;
		insert into pls_hist_analise_conta(nr_sequencia,
			nm_usuario,
			dt_atualizacao,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			nr_seq_analise,
			nr_seq_conta,
			ie_tipo_historico,
			ds_observacao,
			ds_call_stack)
		values (nextval('pls_hist_analise_conta_seq'),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nr_seq_analise_p,
			nr_seq_conta_p,
			17,
			ds_historico_w,
			substr(dbms_utility.format_call_stack,1,4000));
			
		ds_historico_w	:= null;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_conta_pos ( nr_seq_analise_p bigint, nr_seq_conta_p bigint, ie_opcao_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

