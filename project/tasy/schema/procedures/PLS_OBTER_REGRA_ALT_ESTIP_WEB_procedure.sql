-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_regra_alt_estip_web ( nr_seq_contrato_p bigint, nr_seq_contrato_int_p bigint, nr_seq_requisicao_p bigint, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_regra_p INOUT bigint, qt_dias_solicitacao_guia_p INOUT bigint) AS $body$
DECLARE

		
/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:   Obter regra de alteracao guia auditoria do estipulante
----------------------------------------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  ]  Objetos do dicionario [  ] Tasy (Delphi/Java) [ x ] Portal [  ] Relatorios [ ] Outros:
 ----------------------------------------------------------------------------------------------------------------------------------------------------

Pontos de atencao:  
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/		
nr_seq_requisicao_w		bigint;
dt_validade_req_w		timestamp;
ie_tipo_guia_req_w		varchar(2);
dt_solic_req_w			timestamp;
nr_seq_regra_w			bigint;
qt_dias_solicitacao_guia_w	bigint;


BEGIN
	
nr_seq_requisicao_w := nr_seq_requisicao_p;

begin
select	dt_validade_senha,
	ie_tipo_guia
into STRICT	dt_validade_req_w,
	ie_tipo_guia_req_w
from	pls_requisicao
where	nr_sequencia = nr_seq_requisicao_w
and	pls_obter_se_req_executada(nr_seq_requisicao_w) = 'N';
exception
	when others then
	nr_seq_requisicao_w := null;
end;

if (nr_seq_requisicao_w IS NOT NULL AND nr_seq_requisicao_w::text <> '') then
	if (pls_obter_se_controle_estab('RE') = 'S') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_regra_w
		from	pls_regra_alt_aud_estip
		where	coalesce(dt_inicio_vigencia,clock_timestamp()) <= clock_timestamp()
		and	coalesce(dt_fim_vigencia,clock_timestamp()) >= clock_timestamp()
		and	coalesce(ie_tipo_guia,ie_tipo_guia_req_w)   = ie_tipo_guia_req_w
		and	coalesce(nr_seq_contrato,nr_seq_contrato_p) = nr_seq_contrato_p
		and	coalesce(nr_seq_contrato_int,nr_seq_contrato_int_p) = nr_seq_contrato_int_p
		and	to_date(dt_validade_req_w,'dd/mm/yyyy') < to_date(clock_timestamp(),'dd/mm/yyyy')
		and	ie_altera_validade = 'S'
		and	clock_timestamp() between dt_inicio_vigencia and coalesce(dt_fim_vigencia,clock_timestamp())
		and cd_estabelecimento = cd_estabelecimento_p;
	else
		select	max(nr_sequencia)
		into STRICT	nr_seq_regra_w
		from	pls_regra_alt_aud_estip
		where	coalesce(dt_inicio_vigencia,clock_timestamp()) <= clock_timestamp()
		and	coalesce(dt_fim_vigencia,clock_timestamp()) >= clock_timestamp()
		and	coalesce(ie_tipo_guia,ie_tipo_guia_req_w)   = ie_tipo_guia_req_w
		and	coalesce(nr_seq_contrato,nr_seq_contrato_p) = nr_seq_contrato_p
		and	coalesce(nr_seq_contrato_int,nr_seq_contrato_int_p) = nr_seq_contrato_int_p
		and	to_date(dt_validade_req_w,'dd/mm/yyyy') < to_date(clock_timestamp(),'dd/mm/yyyy')
		and	ie_altera_validade = 'S'
		and	clock_timestamp() between dt_inicio_vigencia and coalesce(dt_fim_vigencia,clock_timestamp());
	end if;
	
	if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then
		select	max(qt_dias_solicitacao_guia)
		into STRICT	qt_dias_solicitacao_guia_w
		from	pls_regra_alt_aud_estip
		where 	nr_sequencia = nr_seq_regra_w;
	end if;
	
end if;

nr_seq_regra_p := nr_seq_regra_w;
qt_dias_solicitacao_guia_p := qt_dias_solicitacao_guia_w;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_regra_alt_estip_web ( nr_seq_contrato_p bigint, nr_seq_contrato_int_p bigint, nr_seq_requisicao_p bigint, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_regra_p INOUT bigint, qt_dias_solicitacao_guia_p INOUT bigint) FROM PUBLIC;

