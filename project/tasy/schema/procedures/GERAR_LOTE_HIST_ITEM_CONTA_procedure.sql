-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_lote_hist_item_conta ( nr_seq_guia_p bigint, ie_material_p text, ie_medicamento_p text, ie_extra_p text, ie_procedimento_p text, ie_honorario_p text, ie_taxa_p text, ie_diaria_p text, ie_complexidade_p text, ie_pacote_p text, nm_usuario_p text, ds_erro_p INOUT text, ie_commit_p text default 'S') AS $body$
DECLARE


nr_interno_conta_w		bigint;
cd_autorizacao_w		varchar(20);
nr_seq_propaci_w		bigint;
nr_seq_matpaci_w		bigint;
nr_seq_lote_hist_w		bigint;
nr_seq_lote_item_w		bigint;
qt_item_w		double precision;
vl_item_w			double precision;
vl_saldo_w		double precision;
ie_ajustar_qtd_w		varchar(1);
cd_estabelecimento_w	smallint;
cd_setor_responsavel_w	integer;
ie_carrega_setor_w		varchar(1);
ie_itens_sem_saldo_w	varchar(1);
vl_original_w		double precision;
ie_item_outra_conta_w	varchar(1);
nr_seq_lote_w		bigint;
qt_outro_lote_w		bigint;
ds_erro_w		varchar(4000);
ie_itens_pacote_w		varchar(1);

c01 CURSOR FOR
SELECT	a.nr_sequencia nr_seq_matpaci,
	(null)::numeric  nr_seq_propaci,
	coalesce((obter_saldo_conpaci_item(null,a.nr_sequencia))::numeric ,0) vl_item,
	a.qt_material,
	CASE WHEN ie_carrega_setor_w='N' THEN null  ELSE a.cd_setor_atendimento END  cd_setor_responsavel,
	a.vl_material vl_original
from	material_atend_paciente a
where	not exists (SELECT	1
	from	lote_audit_hist_item x
	where	x.nr_seq_matpaci	= a.nr_sequencia
	and	x.nr_seq_guia		= nr_seq_guia_p)
and	a.nr_interno_conta		= nr_interno_conta_w
and	lower(coalesce(a.nr_doc_convenio, WHEB_MENSAGEM_PCK.get_texto(281664))) = lower(coalesce(cd_autorizacao_w, WHEB_MENSAGEM_PCK.get_texto(281664)))
and 	((obter_classif_material_proced(a.cd_material, null, null) in (1,5,7,10)      and ie_material_p 	= 'S')
or (obter_classif_material_proced(a.cd_material, null, null)  in (0,2,3,4,6,8,9) and ie_medicamento_p	= 'S')
or (obter_classif_material_proced(a.cd_material, null, null)  in (5)             and ie_extra_p 	= 'S'))
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and	coalesce(ie_complexidade_p::text, '') = ''
and (ie_itens_sem_saldo_w = 'S' or coalesce((obter_saldo_conpaci_item(null,a.nr_sequencia))::numeric ,0) > 0 or a.qt_material < 0)
and	((coalesce(ie_itens_pacote_w,'N') = 'N') or (coalesce(a.nr_seq_proc_pacote::text, '') = ''))

union all

select	(null)::numeric  nr_seq_matpaci,
	a.nr_sequencia nr_seq_propaci,
	coalesce((obter_saldo_conpaci_item(a.nr_sequencia,null))::numeric ,0) vl_item,
	a.qt_procedimento,
	CASE WHEN ie_carrega_setor_w='N' THEN null  ELSE coalesce(a.cd_setor_resp,a.cd_setor_atendimento) END  cd_setor_responsavel,
	a.vl_procedimento vl_original
from	procedimento_paciente a
where	not exists (select	1
	from	lote_audit_hist_item x
	where	x.nr_seq_propaci	= a.nr_sequencia
	and	x.nr_seq_guia		= nr_seq_guia_p)
and	a.nr_interno_conta 	= nr_interno_conta_w
and	lower(coalesce(a.nr_doc_convenio, WHEB_MENSAGEM_PCK.get_texto(281664))) = lower(coalesce(cd_autorizacao_w, WHEB_MENSAGEM_PCK.get_texto(281664)))
and 	(((obter_classif_material_proced(null, a.cd_procedimento, a.ie_origem_proced)	= '1' and obter_se_pasta_honorario(a.ie_responsavel_credito) = 'N') and ie_procedimento_p = 'S')
or 	((obter_classif_material_proced(null, a.cd_procedimento, a.ie_origem_proced)	= '1' and obter_se_pasta_honorario(a.ie_responsavel_credito) = 'S') and ie_honorario_p = 'S')
or (obter_classif_material_proced(null, a.cd_procedimento, a.ie_origem_proced)	= '2' and ie_taxa_p = 'S')
or (obter_classif_material_proced(null, a.cd_procedimento, a.ie_origem_proced)	= '3' and ie_diaria_p = 'S')
or (coalesce(ie_pacote_p,'N') = 'S') and (a.nr_seq_proc_pacote = a.nr_sequencia))
and	((sus_obter_complexidade_proced(a.cd_procedimento, a.ie_origem_proced, 'C') 	= ie_complexidade_p) or (coalesce(ie_complexidade_p::text, '') = ''))
and	((coalesce(a.nr_seq_proc_princ::text, '') = '' and Sus_Validar_Regra(13,a.cd_procedimento,a.ie_origem_proced,a.dt_procedimento) = 0) or (coalesce(ie_complexidade_p::text, '') = ''))
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and (ie_itens_sem_saldo_w = 'S' or coalesce((obter_saldo_conpaci_item(a.nr_sequencia,null))::numeric ,0) > 0 or a.qt_procedimento < 0)
and	((coalesce(ie_itens_pacote_w,'N') = 'N') or (coalesce(a.nr_seq_proc_pacote::text, '') = '' or a.nr_seq_proc_pacote = a.nr_sequencia));



BEGIN
select	max(a.nr_interno_conta),
	max(a.cd_autorizacao),
	max(a.nr_seq_lote_hist),
	max(c.cd_estabelecimento),
	max(c.nr_sequencia)
into STRICT	nr_interno_conta_w,
	cd_autorizacao_w,
	nr_seq_lote_hist_w,
	cd_estabelecimento_w,
	nr_seq_lote_w
from	lote_auditoria c,
	lote_audit_hist b,
	lote_audit_hist_guia a
where	a.nr_sequencia		= nr_seq_guia_p
and	a.nr_seq_lote_hist	= b.nr_sequencia
and	b.nr_seq_lote_audit	= c.nr_sequencia;


if (cd_autorizacao_w = 'N?o Informada') then
	cd_autorizacao_w := WHEB_MENSAGEM_PCK.get_texto(281664);
end if;

ie_carrega_setor_w := obter_param_usuario(69, 20, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_carrega_setor_w);
ie_itens_sem_saldo_w := obter_param_usuario(69, 28, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_itens_sem_saldo_w);
ie_item_outra_conta_w := obter_param_usuario(69, 60, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_item_outra_conta_w);
ie_itens_pacote_w := obter_param_usuario(69, 69, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_itens_pacote_w);

ds_erro_w := '';

open c01;
loop
fetch c01 into
	nr_seq_matpaci_w,
	nr_seq_propaci_w,
	vl_item_w,
	qt_item_w,
	cd_setor_responsavel_w,
	vl_original_w;
EXIT WHEN NOT FOUND; /* apply on c01 */


	if (ie_itens_sem_saldo_w = 'S') and (coalesce(vl_item_w,0) = 0) then /* ahoffelder - OS 365225 - 03/10/2011 - Se for sem saldo, usar o valor original do item */
		vl_item_w	:= vl_original_w;
	end if;

	if (ie_item_outra_conta_w = 'N') and (nr_seq_matpaci_w > 0) then

		select	count(*)
		into STRICT	qt_outro_lote_w
		from	lote_audit_hist_item a,
			lote_audit_hist_guia b,
			lote_audit_hist c
		where	a.nr_seq_guia		= b.nr_sequencia
		and	b.nr_seq_lote_hist	= c.nr_sequencia
		and	a.nr_seq_matpaci	= nr_seq_matpaci_w
		and	b.nr_interno_conta	= nr_interno_conta_w
		and	b.cd_autorizacao	= cd_autorizacao_w
		and	c.nr_seq_lote_audit	<> nr_seq_lote_w;

	elsif (ie_item_outra_conta_w = 'N') and (nr_seq_propaci_w > 0) then
		select	count(*)
		into STRICT	qt_outro_lote_w
		from	lote_audit_hist_item a,
			lote_audit_hist_guia b,
			lote_audit_hist c
		where	a.nr_seq_guia		= b.nr_sequencia
		and	b.nr_seq_lote_hist	= c.nr_sequencia
		and     a.nr_seq_propaci	= nr_seq_propaci_w
		and	b.nr_interno_conta	= nr_interno_conta_w
		and	b.cd_autorizacao	= cd_autorizacao_w
		and	c.nr_seq_lote_audit	<> nr_seq_lote_w;

	end if;

	if (ie_item_outra_conta_w = 'N') and (qt_outro_lote_w > 0) then
		if (coalesce(position(to_char(nr_seq_guia_p) in ds_erro_w),0) = 0) then
			ds_erro_w := ds_erro_w || nr_seq_guia_p;
		end if;
	else
		select	nextval('lote_audit_hist_item_seq')
		into STRICT	nr_seq_lote_item_w
		;

		insert	into lote_audit_hist_item(cd_setor_responsavel,
			dt_atualizacao,
			dt_historico,
			nm_usuario,
			nr_seq_guia,
			nr_seq_lote,
			nr_seq_matpaci,
			nr_seq_propaci,
			nr_sequencia,
			qt_item,
			vl_amenor,
			vl_glosa,
			vl_glosa_informada,
			vl_pago,
			vl_saldo_amenor)
		values (cd_setor_responsavel_w,
			clock_timestamp(),
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_guia_p,
			nr_seq_lote_hist_w,
			nr_seq_matpaci_w,
			nr_seq_propaci_w,
			nr_seq_lote_item_w,
			qt_item_w,
			0,
			0,
			vl_item_w,
			0,
			vl_item_w);
		vl_saldo_w	:= (obter_saldo_lote_audit_item(nr_seq_lote_item_w,'SIA'))::numeric;
	end if;

	update	lote_audit_hist_item
	set	vl_saldo	= vl_saldo_w
	where	nr_sequencia	= nr_seq_lote_item_w;
	end loop;
close c01;

if (coalesce(ie_commit_p,'S') = 'S') then
	commit;
end if;

ie_ajustar_qtd_w := obter_param_usuario(69, 14, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_ajustar_qtd_w);

if (ie_ajustar_qtd_w	= 'S') then
	CALL ajustar_lote_hist_item_conta(nr_seq_guia_p,'S',nm_usuario_p);
elsif (ie_ajustar_qtd_w	= 'A') then
	CALL ajustar_lote_hist_item_conta2(nr_seq_guia_p,'S',nm_usuario_p);
end if;

ds_erro_p := substr(ds_erro_w,1,255);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_lote_hist_item_conta ( nr_seq_guia_p bigint, ie_material_p text, ie_medicamento_p text, ie_extra_p text, ie_procedimento_p text, ie_honorario_p text, ie_taxa_p text, ie_diaria_p text, ie_complexidade_p text, ie_pacote_p text, nm_usuario_p text, ds_erro_p INOUT text, ie_commit_p text default 'S') FROM PUBLIC;

