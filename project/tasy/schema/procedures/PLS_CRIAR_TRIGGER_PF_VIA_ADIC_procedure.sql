-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE campos AS (ds		varchar(32760));


CREATE OR REPLACE PROCEDURE pls_criar_trigger_pf_via_adic () AS $body$
DECLARE

type Vetor is table of  campos index by integer;
ds_script_vetor			Vetor;

ds_script_trigger_w		text;
ds_script_trigger_ww		text;
ds_script_trigger_www		text;
nm_atributo_w			varchar(50);
ie_gerar_via_adic_cartao_w	varchar(10);
ie_tipo_segurado_w		varchar(10);
nr_seq_motivo_via_w		varchar(10);
ds_enter_w			varchar(10) := chr(10);
c001				integer;
retorno_w			integer;

ds_comando_c001_w	varchar(4000) := '' ||
		'	select	a.column_name,			' 		||
		'		b.ie_gerar_via_adic_cartao,	' 		||
		'		b.ie_tipo_segurado,		' 		||
		'		b. nr_seq_motivo_via		'		||
		'	from	user_tab_columns 	a, 	'		||
		'		pls_regra_pf_alt	b' 			||
		'	where	a.column_name	= b.nm_atributo	'		||
		'	and	b.nm_tabela	= ''PESSOA_FISICA''' 		||
		'	and	upper(a.table_name) = ''PESSOA_FISICA'''	||
		'	and	b.ie_situacao	= ''A''		'		||
		'	and	obter_se_atrib_constraint(a.table_name,a.column_name,''PK'') = ''N'''||
		'	and	upper(a.column_name)	not in (''DT_ATUALIZACAO'',''NM_USUARIO'') ';


BEGIN
ds_script_vetor[1].ds := '';
ds_script_vetor[2].ds := '';
ds_script_vetor[3].ds := '';
ds_script_vetor[4].ds := '';
ds_script_vetor[5].ds := '';

c001 := DBMS_SQL.OPEN_CURSOR;
DBMS_SQL.PARSE(C001, ds_comando_c001_w, dbms_sql.Native);
DBMS_SQL.DEFINE_COLUMN(C001, 1, nm_atributo_w,50);
DBMS_SQL.DEFINE_COLUMN(C001, 2, ie_gerar_via_adic_cartao_w,50);
DBMS_SQL.DEFINE_COLUMN(C001, 3, ie_tipo_segurado_w,50);
DBMS_SQL.DEFINE_COLUMN(C001, 4, nr_seq_motivo_via_w,50);
retorno_w := DBMS_SQL.execute(c001);

ds_script_trigger_w :=  'create or replace trigger pls_pessoa_fisica_via_adic ' || ds_enter_w||
			'after update on pessoa_fisica ' || ds_enter_w||
			'for each row '|| ds_enter_w||
			'declare'|| ds_enter_w||ds_enter_w||
			'vl_parametro_w			varchar2(20);'|| ds_enter_w||
			'qt_beneficiarios_plano_w	number(10);'|| ds_enter_w||
			'ie_lancar_via_adic		varchar2(20);'|| ds_enter_w||
			'ie_possui_benef_w		varchar2(1) := ''N'';'||ds_enter_w||ds_enter_w||

			'begin' || ds_enter_w ||
			'ie_lancar_via_adic	:= ''N'';'|| ds_enter_w||
			'select	count(1)'|| ds_enter_w||
			'into	qt_beneficiarios_plano_w'|| ds_enter_w||
			'from	pls_segurado'|| ds_enter_w||
			'where	cd_pessoa_fisica	= :old.cd_pessoa_fisica'|| ds_enter_w||
			'and	((dt_rescisao is null) or (dt_rescisao > sysdate));'|| ds_enter_w||
			ds_enter_w||
			'if	(wheb_usuario_pck.get_ie_executar_trigger	= ''S'') and'	||ds_enter_w||
			'	(qt_beneficiarios_plano_w > 0)	then'|| ds_enter_w||
			'	pls_usuario_pck.set_ie_commit(''S'');'	||ds_enter_w||
			'	if	(wheb_usuario_pck.get_cd_funcao in (1220,1268)) then' || ds_enter_w||
			'		Obter_Param_Usuario(1220, 39, obter_perfil_ativo, :new.nm_usuario, :new.cd_estabelecimento, vl_parametro_w);' || ds_enter_w ||
			'	elsif	(wheb_usuario_pck.get_cd_funcao = 1286) then' || ds_enter_w||
			'		Obter_Param_Usuario(1286, 10, obter_perfil_ativo, :new.nm_usuario, :new.cd_estabelecimento, vl_parametro_w);' || ds_enter_w ||
			'		if	(vl_parametro_w = ''P'') then' || ds_enter_w ||
			'			vl_parametro_w	:= ''S'';' || ds_enter_w ||
			'		end if;' || ds_enter_w ||
			'	else ' || ds_enter_w ||
			'		vl_parametro_w := ''N'';' || ds_enter_w ||
			'	end if;' || ds_enter_w ||
			'	'||ds_enter_w||
			'	if	(vl_parametro_w = ''S'') then' || ds_enter_w ||
			'		null; ' || ds_enter_w ||
			ds_enter_w;


while( DBMS_SQL.FETCH_ROWS(C001) > 0 ) loop
	begin
	DBMS_SQL.COLUMN_VALUE(C001, 1, nm_atributo_w);
	DBMS_SQL.COLUMN_VALUE(C001, 2, ie_gerar_via_adic_cartao_w);
	DBMS_SQL.COLUMN_VALUE(C001, 3, ie_tipo_segurado_w);
	DBMS_SQL.COLUMN_VALUE(C001, 4, nr_seq_motivo_via_w);

	if (ie_gerar_via_adic_cartao_w = 'S') then

		ds_script_trigger_ww	:= ds_script_trigger_ww||	'		select	decode(count(1), 0, ''N'', ''S'') '|| ds_enter_w||
									'		into	ie_possui_benef_w '|| ds_enter_w||
									'		from	dual ' || ds_enter_w ||
									'		where	exists (select	1 ' || ds_enter_w ||
									'				from	pls_segurado '|| ds_enter_w||
									'				where	cd_pessoa_fisica	= :old.cd_pessoa_fisica '|| ds_enter_w ||
									'				and	(ie_tipo_segurado = '''||ie_tipo_segurado_w||''' or  '''||ie_tipo_segurado_w||''' is null) '|| ds_enter_w ||
									'				and	((dt_rescisao is null) or (dt_rescisao > sysdate))); '|| ds_enter_w ||
									ds_enter_w ||
									'		if	(:old.'||nm_atributo_w|| ' <> :new.'||nm_atributo_w||') and ' || ds_enter_w||
									'			(ie_possui_benef_w = ''S'') then'|| ds_enter_w ||
									'			ie_lancar_via_adic	:= ''S'';'|| ds_enter_w||
									'		end if;'|| ds_enter_w||'		'|| ds_enter_w ||
									ds_enter_w ||
									'		if	(ie_lancar_via_adic = ''S'') then' || ds_enter_w ||
									'			pls_incluir_pessoa_via_adic(:new.cd_pessoa_fisica,''' || ie_tipo_segurado_w || ''' , ''' || nr_seq_motivo_via_w || ''', :new.nm_usuario);'||ds_enter_w||
									'		end if;' || ds_enter_w;
	end if;
	end;
end loop;

DBMS_SQL.CLOSE_CURSOR(C001);

ds_script_trigger_w := ds_script_trigger_w|| ds_script_trigger_ww ||ds_script_trigger_www||'	end if;'||ds_enter_w||'end if;'||ds_enter_w|| 'end;';
ds_script_vetor[1].ds := substr(ds_script_trigger_w,1,32000);
ds_script_vetor[2].ds := substr(ds_script_trigger_w,32001,32000);
ds_script_vetor[3].ds := substr(ds_script_trigger_w,64001,32000);
ds_script_vetor[4].ds := substr(ds_script_trigger_w,96001,32000);
ds_script_vetor[5].ds := substr(ds_script_trigger_w,128001,32000);

EXECUTE ds_script_vetor[1].ds || ds_script_vetor[2].ds || ds_script_vetor[3].ds || ds_script_vetor[4].ds || ds_script_vetor[5].ds;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_criar_trigger_pf_via_adic () FROM PUBLIC;

