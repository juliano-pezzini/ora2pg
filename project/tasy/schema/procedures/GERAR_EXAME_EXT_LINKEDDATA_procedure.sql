-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_exame_ext_linkeddata (nm_tabela_p text, nr_seq_template_p bigint, nr_seq_reg_template_p bigint, nr_seq_linked_data_p bigint, lista_informacao_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_exame_w		bigint;
nr_seq_exame_analito_w	bigint;
nr_seq_exame_princ_w	bigint;
nm_exame_analito_w	varchar(255);
nr_seq_apresent_w		bigint;
nm_exame_princ_w		varchar(255);
ie_contador_w		bigint		:= 0;
tam_lista_w		bigint;
ie_pos_virgula_w	smallint;
lista_informacao_w	varchar(2000);
nr_seq_unid_medida_w 	bigint;
nr_seq_metodo_w		bigint;
nr_seq_material_w	bigint;
ie_gera_analitos_exame_w varchar(1) := 'N';
ds_comando_w		varchar(4000);
ds_parametros_w		varchar(4000);
ds_sep_bv_w						varchar(50) := obter_separador_bv;
table_exists smallint;WITH RECURSIVE cte AS (


C01 CURSOR FOR
	SELECT	distinct nr_seq_exame,nm_exame,nr_seq_apresent
	from	exame_laboratorio WHERE nr_seq_superior = nr_seq_exame_w
  UNION ALL


C01 CURSOR FOR
	SELECT	distinct nr_seq_exame,nm_exame,nr_seq_apresent
	from	exame_laboratorio JOIN cte c ON (c.prior nr_seq_exame = nr_seq_superior)

) SELECT * FROM cte WHERE coalesce(ie_situacao,'A') = 'A'
	and	nr_seq_superior = nr_seq_exame_princ_w ORDER BY  3;
;

C02 CURSOR FOR
	SELECT	distinct nr_seq_exame, nm_exame, nr_seq_apresent
	from	exame_laboratorio
	where	coalesce(ie_situacao,'A') = 'A'
	and	nr_seq_superior = nr_seq_exame_w
	order by 3;		
	

BEGIN

SELECT COUNT(*) INTO STRICT table_exists FROM ALL_TABLES WHERE TABLE_name = nm_tabela_p;

if (table_exists = 0) then
  CALL Wheb_mensagem_pck.exibir_mensagem_abort(1183995);
end if;

lista_informacao_w	:= lista_informacao_p;

ie_gera_analitos_exame_w := obter_param_usuario(7012, 7, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_gera_analitos_exame_w);

while	(lista_informacao_w IS NOT NULL AND lista_informacao_w::text <> '') or
	ie_contador_w > 200 loop
	begin
		tam_lista_w		:= length(lista_informacao_w);
		ie_pos_virgula_w	:= position(',' in lista_informacao_w);

		if (ie_pos_virgula_w <> 0) then
			nr_seq_exame_w		:= substr(lista_informacao_w,1,(ie_pos_virgula_w - 1));
			lista_informacao_w	:= substr(lista_informacao_w,(ie_pos_virgula_w + 1),tam_lista_w);
		end if;
		
		select 	coalesce(max(nr_sequencia),null)
		into STRICT	nr_seq_metodo_w
		from (	SELECT 	a.nr_sequencia
			from	metodo_exame_lab a,
				exame_lab_metodo b
			where 	a.nr_sequencia = b.nr_seq_metodo
			and 		b.nr_seq_exame = nr_seq_exame_w
			order by ie_prioridade) alias2 LIMIT 1;
		
		select	coalesce(max(nr_sequencia),null)
		into STRICT	nr_seq_material_w
		from (SELECT	a.nr_sequencia
				from		material_exame_lab a,
							exame_lab_material b
				where		a.nr_sequencia = b.nr_seq_material
				and		b.nr_seq_exame = nr_seq_exame_w
				order by ie_prioridade) alias2 LIMIT 1;
		
		select	coalesce(max(a.nr_sequencia),null)
		into STRICT	nr_seq_unid_medida_w
		from	lab_unidade_medida a,
			exame_laboratorio b
		where	a.nr_sequencia = b.nr_seq_unid_med
		and	b.nr_seq_exame = nr_seq_exame_w;

    ds_comando_w	:=	' insert into ' || nm_tabela_p ||
                      '(nr_sequencia, ' ||
                      'nr_seq_template,' ||
                      'nr_seq_reg_template,' ||
                      'nr_seq_linked_data,' ||
                      'nr_seq_exame,' ||
                      'dt_atualizacao,' ||
                      'nm_usuario,' ||
                      'dt_atualizacao_nrec,' ||
                      'nm_usuario_nrec,' ||
                      'nr_seq_material,' ||
                      'nr_seq_metodo,' ||
                      'nr_seq_unid_med)' ||
                      'values' ||
                      '('|| nm_tabela_p || '_SEQ.nextval,' ||
                      ':nr_seq_template_p,' ||
                      ':nr_seq_reg_template_p,' ||
                      ':nr_seq_linked_data_p,' ||
                      ':nr_seq_exame_w,' ||
                      'sysdate,' ||
                      ':nm_usuario_p,' ||
                      'sysdate,' ||
                      ':nm_usuario_p,' ||
                      ':nr_seq_material_w,' ||
                      ':nr_seq_metodo_w,' ||
                      ':nr_seq_unid_medida_w)';

		if (ie_gera_analitos_exame_w <> 'S') and (ie_gera_analitos_exame_w <> 'A') then

        ds_parametros_w :=  'nr_seq_exame_w=' || nr_seq_exame_w || ds_sep_bv_w ||
                            'nr_seq_template_p=' || nr_seq_template_p || ds_sep_bv_w ||
                            'nr_seq_reg_template_p=' || nr_seq_reg_template_p || ds_sep_bv_w ||
                            'nr_seq_linked_data_p=' || nr_seq_linked_data_p || ds_sep_bv_w ||
                            'nm_usuario_p=' || nm_usuario_p || ds_sep_bv_w ||
                            'nr_seq_material_w=' || nr_seq_material_w || ds_sep_bv_w ||
                            'nr_seq_metodo_w=' || nr_seq_metodo_w || ds_sep_bv_w ||
                            'nr_seq_unid_medida_w=' || nr_seq_unid_medida_w || ds_sep_bv_w;

        CALL exec_sql_dinamico_bv('TASY', ds_comando_w, ds_parametros_w);

		else

      ds_parametros_w :=  'nr_seq_exame_w=' || nr_seq_exame_w || ds_sep_bv_w ||
                          'nr_seq_template_p=' || nr_seq_template_p || ds_sep_bv_w ||
                          'nr_seq_reg_template_p=' || nr_seq_reg_template_p || ds_sep_bv_w ||
                          'nr_seq_linked_data_p=' || nr_seq_linked_data_p || ds_sep_bv_w ||
                          'nm_usuario_p=' || nm_usuario_p || ds_sep_bv_w ||
                          'nr_seq_material_w=' || nr_seq_material_w || ds_sep_bv_w ||
                          'nr_seq_metodo_w=' || nr_seq_metodo_w || ds_sep_bv_w ||
                          'nr_seq_unid_medida_w=' || nr_seq_unid_medida_w || ds_sep_bv_w;

        CALL exec_sql_dinamico_bv('TASY', ds_comando_w, ds_parametros_w);
			open C02;
			loop
			fetch C02 into	
				nr_seq_exame_princ_w,
				nm_exame_princ_w,
				nr_seq_apresent_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin

        ds_parametros_w :=  'nr_seq_exame_w=' || nr_seq_exame_princ_w || ds_sep_bv_w ||
                            'nr_seq_template_p=' || nr_seq_template_p || ds_sep_bv_w ||
                            'nr_seq_reg_template_p=' || nr_seq_reg_template_p || ds_sep_bv_w ||
                            'nr_seq_linked_data_p=' || nr_seq_linked_data_p || ds_sep_bv_w ||
                            'nm_usuario_p=' || nm_usuario_p || ds_sep_bv_w ||
                            'nr_seq_material_w=' || nr_seq_material_w || ds_sep_bv_w ||
                            'nr_seq_metodo_w=' || nr_seq_metodo_w || ds_sep_bv_w ||
                            'nr_seq_unid_medida_w=' || nr_seq_unid_medida_w || ds_sep_bv_w;

        CALL exec_sql_dinamico_bv('TASY', ds_comando_w, ds_parametros_w);

				open C01;
				loop
				fetch C01 into	
					nr_seq_exame_analito_w,
					nm_exame_analito_w,
					nr_seq_apresent_w;
				EXIT WHEN NOT FOUND; /* apply on C01 */
						begin

            ds_parametros_w :=  'nr_seq_exame_w=' || nr_seq_exame_analito_w || ds_sep_bv_w ||
                    'nr_seq_template_p=' || nr_seq_template_p || ds_sep_bv_w ||
                    'nr_seq_reg_template_p=' || nr_seq_reg_template_p || ds_sep_bv_w ||
                    'nr_seq_linked_data_p=' || nr_seq_linked_data_p || ds_sep_bv_w ||
                    'nm_usuario_p=' || nm_usuario_p || ds_sep_bv_w ||
                    'nr_seq_material_w=' || nr_seq_material_w || ds_sep_bv_w ||
                    'nr_seq_metodo_w=' || nr_seq_metodo_w || ds_sep_bv_w ||
                    'nr_seq_unid_medida_w=' || nr_seq_unid_medida_w || ds_sep_bv_w;

            CALL exec_sql_dinamico_bv('TASY', ds_comando_w, ds_parametros_w);

						end;
				end loop;
				close C01;	
				end;
			end loop;
			close C02; 			
			
		end if;
		ie_contador_w	:= ie_contador_w + 1;
		end;
end loop;
	
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_exame_ext_linkeddata (nm_tabela_p text, nr_seq_template_p bigint, nr_seq_reg_template_p bigint, nr_seq_linked_data_p bigint, lista_informacao_p text, nm_usuario_p text) FROM PUBLIC;

