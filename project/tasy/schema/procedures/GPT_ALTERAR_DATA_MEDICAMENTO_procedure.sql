-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gpt_alterar_data_medicamento ( nr_seq_cpoe_mat_p cpoe_material.nr_sequencia%type, dt_nova_data_p timestamp, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type) AS $body$
DECLARE


nr_atendimento_w		cpoe_material.nr_atendimento%type;
cd_intervalo_w			cpoe_material.cd_intervalo%type;
ds_horarios_w			cpoe_material.ds_horarios%type;
ds_horarios2_w			cpoe_material.ds_horarios%type;
cd_material_w			cpoe_material.cd_material%type;
nr_prescricao_w			prescr_material.nr_prescricao%type;
ie_acm_w				prescr_material.ie_acm%type;
ie_sn_w					prescr_material.ie_se_necessario%type;
ie_operacao_w			intervalo_prescricao.ie_operacao%type;
nr_intervalo_w			bigint;
dt_nova_data_w			timestamp;
dt_fim_w				timestamp;


BEGIN

if (nr_seq_cpoe_mat_p IS NOT NULL AND nr_seq_cpoe_mat_p::text <> '' AND dt_nova_data_p IS NOT NULL AND dt_nova_data_p::text <> '') then
	if (trunc(dt_nova_data_p,'mi') < trunc(clock_timestamp(),'mi')) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1046176); --A data de início não pode ser anterior à data atual.
	end if;

	dt_nova_data_w	:= dt_nova_data_p;

	select	max(a.nr_atendimento),
			max(a.cd_intervalo),
			max(a.cd_material),
			max(a.ie_acm),
			max(a.ie_se_necessario),
			max(a.dt_fim)
	into STRICT	nr_atendimento_w,
			cd_intervalo_w,
			cd_material_w,
			ie_acm_w,
			ie_sn_w,
			dt_fim_w
	from	cpoe_material	a
	where	a.nr_sequencia	= nr_seq_cpoe_mat_p;

	if (coalesce(dt_fim_w::text, '') = '' or dt_fim_w > dt_nova_data_p) then
		select	max(ie_operacao)
		into STRICT	ie_operacao_w
		from	intervalo_prescricao	a
		where	a.cd_intervalo	= cd_intervalo_w;

		SELECT * FROM cpoe_calcular_horario_prescr(
			nr_atendimento_w, cd_intervalo_w, null, dt_nova_data_w, null, null, nr_intervalo_w, ds_horarios_w, ds_horarios2_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null, null, null, null, null, null) INTO STRICT nr_intervalo_w, ds_horarios_w, ds_horarios2_w;

			ds_horarios_w := ds_horarios_w || ds_horarios2_w;

		if (ie_acm_w = 'S' or ie_sn_w = 'S') then
			dt_nova_data_w	:= trunc(dt_nova_data_w, 'dd');
			ds_horarios_w := replace(ds_horarios_w, substr(ds_horarios_w, 1, 5), '00:00');
		end if;

		update	cpoe_material	a
		set		a.ds_horarios		= trim(both ds_horarios_w),
				a.dt_inicio			= dt_nova_data_w,
				a.hr_prim_horario	= to_char(dt_nova_data_w,'hh24:mi')
		where	a.nr_sequencia		= nr_seq_cpoe_mat_p;

		select	max(a.nr_prescricao)
		into STRICT	nr_prescricao_w
		from	prescr_material	a
		where	a.nr_seq_mat_cpoe	= nr_seq_cpoe_mat_p;

		CALL cpoe_atualizar_rep(
							nr_prescricao_w,
							nr_seq_cpoe_mat_p,
							'M',
							nm_usuario_p,
							cd_perfil_p,
							cd_estabelecimento_p);

		commit;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gpt_alterar_data_medicamento ( nr_seq_cpoe_mat_p cpoe_material.nr_sequencia%type, dt_nova_data_p timestamp, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type) FROM PUBLIC;

