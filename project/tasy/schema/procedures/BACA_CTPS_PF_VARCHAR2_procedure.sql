-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_ctps_pf_varchar2 (ie_opcao_p bigint) AS $body$
DECLARE


/*
ie_opcao_p
1 - Fazer backup dos valores e alterar o campo
2 - Voltar os valores do backup para o campo
*/
ds_retorno_w		varchar(255);
ie_tipo_serie_ctps_w	varchar(106);
trigger_name_w		varchar(40);

c01 CURSOR FOR
SELECT	trigger_name
from	user_triggers
where	table_name = 'PESSOA_FISICA';


BEGIN

/* Verifica se o campo NR_SERIE_CTPS é do tipo NUMBER */

select	data_type
into STRICT	ie_tipo_serie_ctps_w
from	user_tab_columns
where	table_name = 'PESSOA_FISICA'
and	column_name = 'NR_SERIE_CTPS';

/* Se os campos forem NUMBER, realiza o processo de alteração */

if (ie_tipo_serie_ctps_w = 'NUMBER') and (ie_opcao_p = 1) then
	begin

	/* Insere os dados de CTPS em uma tabela temporária */

	insert into pf_ctps_bkp(
		cd_pessoa_fisica,
		nr_serie_ctps)
	SELECT	cd_pessoa_fisica,
		nr_serie_ctps
	from	pessoa_fisica
	where	(nr_serie_ctps IS NOT NULL AND nr_serie_ctps::text <> '');

	commit;

	/* Limpa o campo NR_SERIE_CTPS para fazer o MODIFY */

	update	pessoa_fisica
	set	nr_serie_ctps  = NULL
	where	(nr_serie_ctps IS NOT NULL AND nr_serie_ctps::text <> '');

	/* Modifica o tipo do campo NR_SERIE_CTPS */

	ds_retorno_w := Executar_SQL_Dinamico(' alter table pessoa_fisica modify (nr_serie_ctps varchar2(10)) ', ds_retorno_w);

	end;
elsif (ie_opcao_p = 2) then
	begin

	/* Desabilita todas as triggers da PESSOA_FISICA */

	open c01;
	loop
	fetch c01 into
		trigger_name_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		CALL exec_sql_dinamico('AJUSTE_CTPS', 'alter trigger ' || trigger_name_w || ' disable');
		end;
	end loop;
	close c01;

	/* Envia os dados novamente para a tabela PESSOA_FISICA */

	update	pessoa_fisica a
	set	a.nr_serie_ctps = (
			SELECT	b.nr_serie_ctps
			from	pf_ctps_bkp b
			where	b.cd_pessoa_fisica = a.cd_pessoa_fisica);

	commit;


	/* Habilita todas as triggers da PESSOA_FISICA novamente */

	open c01;
	loop
	fetch c01 into
		trigger_name_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		CALL exec_sql_dinamico('AJUSTE_CTPS', 'alter trigger ' || trigger_name_w || ' enable');
		end;
	end loop;
	close c01;

	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_ctps_pf_varchar2 (ie_opcao_p bigint) FROM PUBLIC;

