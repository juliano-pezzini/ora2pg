-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicar_anamnese ( nr_sequencia_p bigint, nr_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_anamnese_w	bigint;
cd_medico_w		varchar(10);
cd_medico_resp_w		varchar(10) 	:= null;
ie_medico_w		varchar(10);
ie_prof_anamnese_w	varchar(3);
cd_especialidade_w	integer 	:= null;
cd_estabelecimento_w	smallint;
ie_tipo_evolucao_w		varchar(3);			
	 

BEGIN 
cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
ie_prof_anamnese_w := Obter_Param_Usuario(281, 65, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_prof_anamnese_w);
 
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (ie_prof_anamnese_w = 'S') then 
	 
	select 	Obter_medico_resp_atend(nr_atendimento_p,'C') 
	into STRICT	cd_medico_resp_w 
	;
	 
end if;
 
select	coalesce(max(ie_tipo_evolucao),1), 
	max(cd_pessoa_fisica) 
into STRICT	ie_tipo_evolucao_w, 
	cd_medico_w 
from	usuario 
where	nm_usuario	= nm_usuario_p;
 
select	obter_se_medico(cd_medico_w, 'M') 
into STRICT	ie_medico_w	
;
 
if (ie_medico_w = 'S') then 
	select	obter_especialidade_medico(cd_medico_w,'C') 
	into STRICT	cd_especialidade_w 
	;
end if;
 
select	nextval('anamnese_paciente_seq') 
into STRICT	nr_seq_anamnese_w
;
 
insert into anamnese_paciente( 
		 nr_sequencia, 
		 dt_ananmese, 
		 nr_atendimento, 
		 dt_atualizacao, 
		 nm_usuario, 
		 cd_medico, 
		 dt_atualizacao_nrec, 
		 nm_usuario_nrec, 
		 ie_situacao, 
		 cd_perfil_ativo, 
		 qt_caracteres, 
		 cd_pessoa_fisica, 
		 ie_tipo_evolucao, 
		 cd_especialidade_medico) 
	SELECT	nr_seq_anamnese_w, 
		clock_timestamp(), 
		nr_atendimento, 
		clock_timestamp(), 
		nm_usuario_p, 
		coalesce(cd_medico_resp_w,cd_medico_w), 
		clock_timestamp(), 
		nm_usuario_p, 
		'A', 
		obter_perfil_ativo, 
		qt_caracteres, 
		cd_pessoa_fisica, 
		ie_tipo_evolucao_w, 
		cd_especialidade_w 
	from	anamnese_paciente 
	where	nr_sequencia	= nr_sequencia_p;
 
commit;
	 
copia_campo_long_de_para_Java(	'ANAMNESE_PACIENTE', 
			'DS_ANAMNESE', 
			' where nr_sequencia = :nr_seq_anamnese', 
			'nr_seq_anamnese='||nr_sequencia_p, 
			'ANAMNESE_PACIENTE', 
			'DS_ANAMNESE', 
			' where nr_sequencia = :nr_sequencia', 
			'nr_sequencia='||nr_seq_anamnese_w, 
			'L');	
			commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_anamnese ( nr_sequencia_p bigint, nr_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

