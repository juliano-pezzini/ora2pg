-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_itens_exame_protocolo ( nm_usuario_p text, nr_sequencia_p bigint, nr_prescricao_p bigint, nr_seq_tipo_item_p bigint, ie_tipo_exame_p text, nr_seq_proc_classif_p bigint default null, cd_tipo_proc_p bigint default null) AS $body$
DECLARE

/* 
 
ie_tipo_exame_p 
L = Exames laboratoriais 
O = Outros (Exames não laboratoriais) 
A= Ambos 
 
*/
 
			 
C01 CURSOR FOR 
	SELECT	distinct 
		a.nr_sequencia 
	FROM prescr_procedimento a
LEFT OUTER JOIN proc_interno b ON (a.nr_seq_proc_interno = b.nr_sequencia)
LEFT OUTER JOIN procedimento c ON (a.cd_procedimento = c.cd_procedimento AND a.ie_origem_proced = c.ie_origem_proced)
WHERE a.nr_prescricao 			= nr_prescricao_p and coalesce(b.nr_seq_classif,0)			= coalesce(nr_seq_proc_classif_p,coalesce(b.nr_seq_classif,0)) and coalesce(c.cd_tipo_procedimento,0)		= coalesce(cd_tipo_proc_p, coalesce(c.cd_tipo_procedimento,0)) and coalesce(a.nr_seq_exame,0) 			= CASE WHEN ie_tipo_exame_p='L' THEN coalesce(a.nr_seq_exame,1) WHEN ie_tipo_exame_p='O' THEN 0 WHEN ie_tipo_exame_p='A' THEN coalesce(a.nr_seq_exame,0) END;

c01_w				C01%rowtype;
cd_convenio_w			integer;
qt_inserido_w			integer := 0;
nr_seq_item_w			integer;
nr_seq_tipo_item_w		bigint;
ie_tipo_documento_w		varchar(1);


BEGIN 
ie_tipo_documento_w := obter_param_usuario(290, 106, obter_perfil_Ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_tipo_documento_w);
 
select	max(cd_convenio) 
into STRICT	cd_convenio_w 
from	atend_categoria_convenio 
where	nr_seq_interno = obter_atecaco_atendimento(obter_dados_prescricao(nr_prescricao_p, 'A')) 
and	nr_atendimento = obter_dados_prescricao(nr_prescricao_p, 'A');
 
open C01;
loop 
fetch C01 into	 
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	if (ie_tipo_documento_w = 'S') then 
		select	nr_seq_tipo_doc_item 
		into STRICT	nr_seq_tipo_item_w 
		from	protocolo_documento 
		where	nr_sequencia = nr_sequencia_p;
	end if;
	 
	select	coalesce(max(nr_seq_item),0) + 1 
	into STRICT	nr_seq_item_w 
	from	protocolo_doc_item 
	where	nr_sequencia = nr_sequencia_p;
	 
	insert into protocolo_doc_item(	nr_sequencia, 
					nr_seq_item, 
					nm_usuario, 
					dt_atualizacao, 
					dt_inclusao_item, 
					ie_descartado, -- Campos obrigtórios 
					nr_documento, 
					cd_convenio, 
					nr_doc_item, 
					nr_seq_tipo_item) 
				values (	nr_sequencia_p, 
					nr_seq_item_w, 
					nm_usuario_p, 
					clock_timestamp(), 
					clock_timestamp(), 
					'N', -- Campos obrigtórios 
					nr_prescricao_p, 
					cd_convenio_w, 
					c01_w.nr_sequencia, 
					coalesce(nr_seq_tipo_item_w,nr_seq_tipo_item_p));
	 
	qt_inserido_w := qt_inserido_w + 1;
	if (qt_inserido_w	= 100) then 
		commit;
		qt_inserido_w	:= 0;
	end if;
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_itens_exame_protocolo ( nm_usuario_p text, nr_sequencia_p bigint, nr_prescricao_p bigint, nr_seq_tipo_item_p bigint, ie_tipo_exame_p text, nr_seq_proc_classif_p bigint default null, cd_tipo_proc_p bigint default null) FROM PUBLIC;

