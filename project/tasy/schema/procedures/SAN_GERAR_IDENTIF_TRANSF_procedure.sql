-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_gerar_identif_transf ( nr_sequencia_p bigint, nm_usuario_p text, ie_opcao_p text) AS $body$
DECLARE

					
/*
T = Transfusao
R = Reserva
*/
nr_seq_regra_w		bigint;
nr_inicial_w		bigint;
nr_final_w		bigint;
nr_atual_w		bigint;
ds_adicional_w		varchar(10);
nr_identificacao_w	varchar(20);
ie_atualiza_w		varchar(1);
					

BEGIN

if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then
	
	select	max(nr_sequencia)
	into STRICT	nr_seq_regra_w
	from	san_regra_ident_transf
	where	coalesce(ie_situacao,'A') = 'A'
	and	clock_timestamp() between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_vigencia_ini) and ESTABLISHMENT_TIMEZONE_UTILS.endOfDay(dt_vigencia_fim);


	if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then

		select	nr_inicial,
			nr_final,
			nr_atual,
			ds_adicional
		into STRICT	nr_inicial_w,
			nr_final_w,
			nr_atual_w,
			ds_adicional_w
		from	san_regra_ident_transf
		where	nr_sequencia = nr_seq_regra_w;

		if (nr_atual_w = 0) then
			nr_identificacao_w := nr_inicial_w;
		elsif ((nr_atual_w + 1) <= nr_final_w) then
			nr_identificacao_w := nr_atual_w + 1;
		end if;
		
		if (nr_identificacao_w IS NOT NULL AND nr_identificacao_w::text <> '') then
		
			if (ie_opcao_p = 'T') then
				select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
				into STRICT	ie_atualiza_w
				from	san_transfusao
				where	nr_sequencia = nr_sequencia_p
				and	coalesce(nr_identificacao::text, '') = '';
			
				if (ie_atualiza_w = 'S') then
					update	san_transfusao
					set	nr_identificacao = substr(nr_identificacao_w||ds_adicional_w,1,20)
					where	nr_sequencia = nr_sequencia_p;
					
					update	san_regra_ident_transf
					set	nr_atual = nr_identificacao_w
					where	nr_sequencia = nr_seq_regra_w;
				end if;
				
			elsif (ie_opcao_p = 'R') then
				select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
				into STRICT	ie_atualiza_w
				from	san_reserva
				where	nr_sequencia = nr_sequencia_p
				and	coalesce(nr_identificacao::text, '') = '';
			
				if (ie_atualiza_w = 'S') then
					update	san_reserva
					set	nr_identificacao = substr(nr_identificacao_w||ds_adicional_w,1,20)
					where	nr_sequencia = nr_sequencia_p;
					
					update	san_regra_ident_transf
					set	nr_atual = nr_identificacao_w
					where	nr_sequencia = nr_seq_regra_w;
				end if;
			end if;			
		end if;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_gerar_identif_transf ( nr_sequencia_p bigint, nm_usuario_p text, ie_opcao_p text) FROM PUBLIC;

