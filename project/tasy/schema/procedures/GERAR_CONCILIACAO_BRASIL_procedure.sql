-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_conciliacao_brasil (nr_seq_extrato_p bigint, nm_usuario_p text) AS $body$
DECLARE


/*OS99965 - Elton - Criado para importação de extrato do BB */

vl_saldo_inicial_w	double precision;
vl_saldo_final_w	double precision;
dt_saldo_inicial_w	timestamp;
dt_saldo_final_w	timestamp;
cd_agencia_w		varchar(5);
cd_conta_w		varchar(12);
cd_historico_w		varchar(4);
ds_historico_w		varchar(25);
ie_natureza_w		varchar(15);
nr_documento_w		varchar(39);
dt_movto_w		timestamp;
vl_extrato_w		double precision;
ie_deb_cred_w		varchar(1);
cd_categoria_w		varchar(3);
nr_seq_conta_w		bigint;
nr_lote_w		varchar(30);
cd_conta_num_w		bigint;
ie_digito_conta_w	varchar(1);

c01 CURSOR FOR
SELECT	substr(ds_conteudo,53,5) cd_agencia,
	substr(ds_conteudo,59,12) cd_conta,
	substr(ds_conteudo,170,3) cd_categoria,
	substr(ds_conteudo,173,4) cd_historico,
	substr(ds_conteudo,177,25) ds_historico,
	somente_numero(substr(ds_conteudo,202,39)) nr_documento,
	to_date(substr(ds_conteudo,143,8),'dd/mm/yyyy') dt_movto,
	somente_numero(substr(ds_conteudo,151,16)) || ',' || substr(ds_conteudo,167,2) vl_extrato,
	substr(ds_conteudo,169,1) ie_deb_cred,
	substr(ds_conteudo,4,4) nr_lote
from	w_interf_concil
where	coalesce(trim(both substr(ds_conteudo,71,1)),'X')	= coalesce(ie_digito_conta_w,'X')
and	somente_numero(substr(ds_conteudo,59,12))	= cd_conta_num_w
and	substr(ds_conteudo,8,1)		= '3'
and	substr(ds_conteudo,14,1)	= 'E'
and	nr_seq_conta			= nr_seq_conta_w;


BEGIN

select	nr_seq_conta
into STRICT	nr_seq_conta_w
from	banco_extrato
where	nr_sequencia	= nr_seq_extrato_p;

select	somente_numero(substr(a.cd_conta,1,12)),
	substr(a.ie_digito_conta,1,1) ie_digito_conta
into STRICT	cd_conta_num_w,
	ie_digito_conta_w
from	banco_estabelecimento a
where	a.nr_sequencia	= nr_seq_conta_w;

/* select	max(to_date(substr(ds_conteudo,143,8),'ddmmyyyy')) dt_movto
into	dt_saldo_inicial_w
from	w_interf_concil
where	substr(ds_conteudo,8,1) = '1';

select	max(to_date(substr(ds_conteudo,143,8),'ddmmyyyy')) dt_movto
into	dt_saldo_final_w
from	w_interf_concil
where	substr(ds_conteudo,8,1)		= '5'; */
select	min(to_date(substr(ds_conteudo,143,8),'dd/mm/yyyy')) dt_saldo_inicial,
	max(to_date(substr(ds_conteudo,143,8),'dd/mm/yyyy')) dt_saldo_final
into STRICT	dt_saldo_inicial_w,
	dt_saldo_final_w
from	w_interf_concil
where	coalesce(trim(both substr(ds_conteudo,71,1)),'X')	= coalesce(ie_digito_conta_w,'X')
and	somente_numero(substr(ds_conteudo,59,12))	= cd_conta_num_w
and	substr(ds_conteudo,8,1)		= '3'
and	substr(ds_conteudo,14,1)	= 'E'
and	nr_seq_conta			= nr_seq_conta_w;

select	max(a.vl_saldo_final)
into STRICT	vl_saldo_inicial_w
from	banco_extrato a
where	a.nr_sequencia	=
	(SELECT	max(x.nr_sequencia)
	from	banco_extrato x
	where	x.nr_sequencia	< nr_seq_extrato_p
	and	x.nr_seq_conta	= nr_seq_conta_w);

if (coalesce(vl_saldo_inicial_w::text, '') = '') then

	select	obter_saldo_banco_diario(max(a.nr_sequencia),fim_dia(dt_saldo_inicial_w - 1))
	into STRICT	vl_saldo_inicial_w
	from	banco_saldo a
	where	exists (SELECT	1
		from	movto_trans_financ x
		where	trunc(x.dt_transacao,'dd') = trunc(dt_saldo_inicial_w,'dd'))
	and	a.nr_seq_conta	= nr_seq_conta_w;

	if (coalesce(vl_saldo_inicial_w::text, '') = '') then

		select	max((substr(ds_conteudo,151,16) || ',' || substr(ds_conteudo,167,2))::numeric ) vl_extrato
		into STRICT	vl_saldo_inicial_w
		from	w_interf_concil
		where	substr(ds_conteudo,8,1) = '1';

	end if;

end if;

vl_saldo_final_w	:= vl_saldo_inicial_w;

open c01;
loop
fetch c01 into
	cd_agencia_w,
	cd_conta_w,
	cd_categoria_w,
	cd_historico_w,
	ds_historico_w,
	nr_documento_w,
	dt_movto_w,
	vl_extrato_w,
	ie_deb_cred_w,
	nr_lote_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

ie_natureza_w	:= 'D';

	/*OS73534. 16/11/2007. Incluído o If abaixo para jogar como bloqueado quando o histórico for um desses.*/

	if (coalesce(cd_historico_w,'0') in ('0911','0912','0913','0914','0915','0916','0917','0918','0919')) then
		ie_natureza_w	:= 'B';
	end if;

	if (ie_deb_cred_w	= 'D') then
		vl_saldo_final_w	:= coalesce(vl_saldo_final_w,0) - coalesce(vl_extrato_w,0);
	else
		vl_saldo_final_w	:= coalesce(vl_saldo_final_w,0) + coalesce(vl_extrato_w,0);
	end if;

	insert into banco_extrato_lanc(cd_agencia_origem,
		cd_categoria,
		cd_historico,
		ds_historico,
		dt_atualizacao,
		dt_atualizacao_nrec,
		dt_movimento,
		ie_conciliacao,
		ie_deb_cred,
		nm_usuario,
		nm_usuario_nrec,
		nr_documento,
		nr_seq_extrato,
		nr_sequencia,
		vl_lancamento,
		nr_lote,
		ie_natureza)
	values (cd_agencia_w,
		cd_categoria_w,
		cd_historico_w,
		ds_historico_w,
		clock_timestamp(),
		clock_timestamp(),
		dt_movto_w,
		'N',
		ie_deb_cred_w,
		nm_usuario_p,
		nm_usuario_p,
		nr_documento_w,
		nr_seq_extrato_p,
		nextval('banco_extrato_lanc_seq'),
		vl_extrato_w,
		nr_lote_w,
		ie_natureza_w);
end loop;
close c01;

update	banco_extrato
set	vl_saldo_inicial = vl_saldo_inicial_w,
	vl_saldo_final	= vl_saldo_final_w,
	dt_inicio	= dt_saldo_inicial_w,
	dt_final	= dt_saldo_final_w
where	nr_sequencia	= nr_seq_extrato_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_conciliacao_brasil (nr_seq_extrato_p bigint, nm_usuario_p text) FROM PUBLIC;

