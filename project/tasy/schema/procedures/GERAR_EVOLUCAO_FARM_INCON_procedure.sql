-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_evolucao_farm_incon ( nr_prescricao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE



nr_prescricao_w		bigint;
dt_prescricao_w		varchar(30);
nm_farmaceutico_w		varchar(255);
nr_atendimento_w		bigint;
cd_material_w		bigint;
ds_material_w		varchar(255);
ds_dose_um_inter_w		varchar(100);
qt_dose_w			bigint;
ds_unidade_medida_dose_w	varchar(255);
ds_via_aplicacao_w		varchar(255);
ie_se_necessario_w		varchar(30);
ie_acm_w			varchar(30);
ie_urgencia_w		varchar(30);
ds_intervalo_w		varchar(255);
ds_inconsistencia_w		inconsistencia_med_farm.ds_inconsistencia%type;
ds_evolucao_w		text:= null;
cabecalho_w		varchar(2000);
cabecalho_w2		varchar(2000);
ie_tipo_evolucao_w		varchar(3);
ie_evolucao_clinica_w	varchar(3);
ds_medicamentos_w		text:= null;
cd_perfil_w		integer;
ds_erro_w			varchar(255);
cd_pessoa_fisica_w		varchar(10);
ds_fonte_w		varchar(255);
ds_tam_fonte_w		varchar(255);
nr_tam_fonte_w		bigint;


c01 CURSOR FOR

SELECT	a.nr_prescricao,
	pkg_date_formaters.to_varchar(a.dt_prescricao,'timestamp', cd_estabelecimento_p, nm_usuario_p) dt_prescricao,
	substr(obter_nome_usuario(nm_usuario_p),1,60) nm_farmaceutico,
	a.nr_atendimento,
	b.cd_material,
	substr(obter_desc_material(b.cd_material),1,80) ds_material,
	substr(obter_um_dosagem_prescr(b.nr_prescricao,b.nr_sequencia),1,100),
	substr(obter_dados_inconsist_farm(c.nr_seq_inconsistencia,'D'),1,255) ds_inconsistencia,
	a.cd_pessoa_fisica
from	prescr_medica a,
	prescr_material b,
	prescr_material_incon_farm c
where	a.nr_prescricao = b.nr_prescricao
and	a.nr_prescricao = c.nr_prescricao
and	b.nr_sequencia = c.nr_seq_material
and	coalesce(a.dt_liberacao_parc_farm::text, '') = ''
and	coalesce(a.dt_liberacao_farmacia::text, '') = ''
and	coalesce(c.ie_situacao,'A') = 'A'
and	coalesce(b.ie_suspenso,'N') = 'N'
and	a.nr_prescricao = nr_prescricao_p
and	(nr_seq_mat_cpoe IS NOT NULL AND nr_seq_mat_cpoe::text <> '')
order by	obter_desc_material(b.cd_material),
	ds_material,
	ds_inconsistencia;


BEGIN

begin

cd_perfil_w := wheb_usuario_pck.get_cd_perfil;
ie_evolucao_clinica_w := Obter_Param_Usuario(252, 65, cd_perfil_w, nm_usuario_p, cd_estabelecimento_p, ie_evolucao_clinica_w);
ds_fonte_w := Obter_Param_Usuario(281, 5, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ds_fonte_w);
ds_tam_fonte_w := Obter_Param_Usuario(281, 6, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ds_tam_fonte_w);
nr_tam_fonte_w := somente_numero(ds_tam_fonte_w)*2;
cabecalho_w := '{\rtf1\ansi\ansicpg1252\deff0\deflang1046{\fonttbl{\f0\fswiss\fcharset0 '||ds_fonte_w||';}}'|| '{\*\generator Msftedit 5.41.15.1507;}\viewkind4\uc1\pard\f0\fs'||nr_tam_fonte_w||' ' || obter_desc_expressao(1042884) || wheb_rtf_pck.get_quebra_linha|| wheb_rtf_pck.get_quebra_linha|| wheb_rtf_pck.get_quebra_linha;

open C01;
loop
fetch C01 into
	nr_prescricao_w,
	dt_prescricao_w,
	nm_farmaceutico_w,
	nr_atendimento_w,
	cd_material_w,
	ds_material_w,
	ds_dose_um_inter_w,
	ds_inconsistencia_w,
	cd_pessoa_fisica_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (coalesce(cabecalho_w2::text, '') = '') then
		cabecalho_w2 := obter_desc_expressao(325814) || nr_prescricao_w || wheb_rtf_pck.get_quebra_linha ||
			obter_desc_expressao(287111) || ': '||dt_prescricao_w || wheb_rtf_pck.get_quebra_linha ||
			obter_desc_expressao(729062) || nm_farmaceutico_w || wheb_rtf_pck.get_quebra_linha ||
			wheb_rtf_pck.get_quebra_linha;
	end if;
	if (coalesce(ds_medicamentos_w::text, '') = '') then
		ds_medicamentos_w := obter_desc_expressao(330076) || ' ' || ds_material_w || ' - ' ||
			obter_desc_expressao(288285) || ': ' ||ds_dose_um_inter_w || wheb_rtf_pck.get_quebra_linha ||
			obter_desc_expressao(291821) || ': ' || ds_inconsistencia_w;
	else
		ds_medicamentos_w := ds_medicamentos_w || wheb_rtf_pck.get_quebra_linha || wheb_rtf_pck.get_quebra_linha ||
			obter_desc_expressao(330076) || ' ' || ds_material_w || ' - ' || obter_desc_expressao(288285) || ': ' ||
			ds_dose_um_inter_w || wheb_rtf_pck.get_quebra_linha || obter_desc_expressao(291821) || ': ' || ds_inconsistencia_w;
	end if;
	end;
end loop;
close C01;

if (ds_medicamentos_w IS NOT NULL AND ds_medicamentos_w::text <> '') then
	ds_evolucao_w := cabecalho_w || cabecalho_w2 || ds_medicamentos_w || '}';
end if;

select	ie_tipo_evolucao
into STRICT	ie_tipo_evolucao_w
from	usuario
where	nm_usuario = nm_usuario_p;

if (coalesce(ie_tipo_evolucao_w::text, '') = '') then
	ds_erro_w := substr(obter_texto_dic_objeto(275816,wheb_usuario_pck.get_nr_seq_idioma,null),1,255);
end if;

if (coalesce(ds_erro_w::text, '') = '') and (ds_evolucao_w IS NOT NULL AND ds_evolucao_w::text <> '') then
	insert into	evolucao_paciente(
			ie_situacao,
			nm_usuario,
			dt_atualizacao,
			cd_pessoa_fisica,
			cd_evolucao,
			ds_evolucao,
			ie_tipo_evolucao,
			dt_evolucao,
			nr_atendimento,
			cd_medico,
			ie_evolucao_clinica,
			dt_liberacao)
	values ('A',
			nm_usuario_p,
			clock_timestamp(),
			cd_pessoa_fisica_w,
			nextval('evolucao_paciente_seq'),
			ds_evolucao_w,
			ie_tipo_evolucao_w,
			clock_timestamp(),
			nr_atendimento_w,
			Obter_Pessoa_Fisica_Usuario(nm_usuario_p,'C'),
			ie_evolucao_clinica_w,
			null
			);
	commit;
end if;

exception
when 	others then
	ds_erro_w := substr(SQLERRM(SQLSTATE),1,255);
end;

ds_erro_p := ds_erro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_evolucao_farm_incon ( nr_prescricao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

