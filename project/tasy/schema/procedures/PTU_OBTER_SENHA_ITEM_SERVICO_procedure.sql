-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_obter_senha_item_servico ( nr_seq_guia_p pls_conta.nr_seq_guia%type, nr_seq_guia_no_item_p pls_guia_plano.nr_sequencia%type, nr_seq_guia_proc_p pls_conta_proc.nr_seq_guia_proc%type, nr_seq_guia_mat_p pls_conta_mat.nr_seq_guia_mat%type, nr_seq_segurado_p pls_segurado.nr_sequencia%type, cd_guia_p pls_guia_plano.cd_guia%type, cd_guia_referencia_p pls_conta.cd_guia_referencia%type, cd_excecao_p ptu_nota_cobranca.cd_excecao%type, cd_senha_externa_pos_cab_p pls_conta_pos_cabecalho.cd_senha_externa%type, cd_senha_pos_cab_p pls_conta_pos_cabecalho.cd_senha%type, ie_agrupar_atendimento_p pls_parametro_faturamento.ie_agrupar_atendimento%type, cd_senha_p INOUT text, ie_status_p INOUT text) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Centraliza as regras em comum para levantar a senha da autorização.

-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[X]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
-------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
		Nesta rotina não estão todas as regras para verificar a senha,
		ela retorna a senha que se encaixar nas "regras em comum", as
		rotinas que consumirem esta podem possuir particularidades que alterem o
		retorno.
Alterações:
-------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
cd_senha_w	varchar(40);
cd_senha_guia_w	varchar(40);
ie_status_w	varchar(2);

BEGIN

cd_senha_w := '';

if (cd_excecao_p in ('L', 'C', 'O', 'E', 'I', 'J')) then

	-- Faz a primeira carga da senha
	cd_senha_w := coalesce(cd_senha_externa_pos_cab_p, cd_senha_pos_cab_p);

	-- Obter senha do item (Trans operadora origem)
	-- OS 1369221 - jtonon - O bloco abaixo foi criado para a Unimed Litoral, porém, os mesmos enviam cada item separado, já a Unimed Rio Preto envia todos os itens agrupador
	-- Portanto, adicionamos a leitura do campo 'Agrupar atendimento na geração do arquivo PTU' que fica em OPS - Gestão de Operadoras / Parâmetros da OPS / Faturamento
	if	((coalesce(ie_agrupar_atendimento_p,'N') = 'N') and
		((coalesce(cd_senha_w::text, '') = '') or (nr_seq_guia_p <> nr_seq_guia_no_item_p))) then

		if (nr_seq_guia_proc_p IS NOT NULL AND nr_seq_guia_proc_p::text <> '') then
			select	max(r.nr_seq_origem)
			into STRICT	cd_senha_guia_w
			from	ptu_resposta_autorizacao r,
				pls_guia_plano		g,
				pls_guia_plano_proc	p
			where	g.nr_sequencia		= p.nr_seq_guia
			and	g.nr_sequencia		= r.nr_seq_guia
			and	p.nr_sequencia		= nr_seq_guia_proc_p;

			if (coalesce(cd_senha_guia_w, '0') = '0') then
				select	max(r.nr_seq_origem)
				into STRICT	cd_senha_guia_w
				from	ptu_resposta_auditoria	r,
					pls_guia_plano		g,
					pls_guia_plano_proc	p
				where	g.nr_sequencia		= p.nr_seq_guia
				and	g.nr_sequencia		= r.nr_seq_guia
				and	p.nr_sequencia		= nr_seq_guia_proc_p;
			end if;

		elsif (nr_seq_guia_mat_p IS NOT NULL AND nr_seq_guia_mat_p::text <> '') then
			select	max(r.nr_seq_origem)
			into STRICT	cd_senha_guia_w
			from	ptu_resposta_autorizacao r,
				pls_guia_plano		g,
				pls_guia_plano_mat	m
			where	g.nr_sequencia		= m.nr_seq_guia
			and	g.nr_sequencia		= r.nr_seq_guia
			and	m.nr_sequencia		= nr_seq_guia_mat_p;

			if (coalesce(cd_senha_guia_w, '0') = '0') then
				select	max(r.nr_seq_origem)
				into STRICT	cd_senha_guia_w
				from	ptu_resposta_auditoria	r,
					pls_guia_plano		g,
					pls_guia_plano_mat	m
				where	g.nr_sequencia		= m.nr_seq_guia
				and	g.nr_sequencia		= r.nr_seq_guia
				and	m.nr_sequencia		= nr_seq_guia_mat_p;
			end if;
		end if;

		if (coalesce(cd_senha_guia_w, '0') <> '0') then --
			cd_senha_w := cd_senha_guia_w;
		end if;
	end if;

	-- OS 1401669 - Sempre que o procedimento for autorizado pela Origem, o preenchimento do número de autorização é obrigatório.
	-- Para o tipo de exceção "J", é válida, uma vez que na validação somente a Unimed Origem do arquivo sabe se ocorreu essa autorização.
	-- Diante disso permitimos que em casos de exceção 'J' o sistema entre no if externo mais acima até aqui, daqui em diante não fará as verificações
	if (cd_excecao_p not in ('J')) then
		if (coalesce(cd_senha_w::text, '') = '') then
			if (coalesce(cd_senha_w::text, '') = '') then
				select	coalesce(max(cd_senha_externa), max(cd_senha)),
					max(ie_status)
				into STRICT	cd_senha_w,
					ie_status_w
				from	pls_guia_plano
				where	nr_sequencia	= nr_seq_guia_p
				and	nr_seq_segurado	= nr_seq_segurado_p;
			end if;

			if (coalesce(cd_senha_w::text, '') = '') then
				select	coalesce(max(cd_senha_externa), max(cd_senha)),
					max(ie_status)
				into STRICT	cd_senha_w,
					ie_status_w
				from	pls_guia_plano
				where	cd_guia		= cd_guia_p
				and	nr_seq_segurado	= nr_seq_segurado_p;
			end if;

			if (coalesce(cd_senha_w::text, '') = '') then
				select	coalesce(max(cd_senha_externa), max(cd_senha)),
					max(ie_status)
				into STRICT	cd_senha_w,
					ie_status_w
				from	pls_guia_plano
				where	cd_guia		= cd_guia_referencia_p
				and	nr_seq_segurado	= nr_seq_segurado_p;
			end if;

		end if;
	-- O elsif abaixo foi criado afim de atender a situação anterior a esta alteração, onde no caso de exceção 'J' o sitema não estrava neste if externo mais acima
	elsif (coalesce(cd_senha_w, '0') = '0') then
		cd_senha_w := '0';
	end if;
else
	cd_senha_w := '0';
end if;

cd_senha_p	:= cd_senha_w;
ie_status_p	:= ie_status_w;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_obter_senha_item_servico ( nr_seq_guia_p pls_conta.nr_seq_guia%type, nr_seq_guia_no_item_p pls_guia_plano.nr_sequencia%type, nr_seq_guia_proc_p pls_conta_proc.nr_seq_guia_proc%type, nr_seq_guia_mat_p pls_conta_mat.nr_seq_guia_mat%type, nr_seq_segurado_p pls_segurado.nr_sequencia%type, cd_guia_p pls_guia_plano.cd_guia%type, cd_guia_referencia_p pls_conta.cd_guia_referencia%type, cd_excecao_p ptu_nota_cobranca.cd_excecao%type, cd_senha_externa_pos_cab_p pls_conta_pos_cabecalho.cd_senha_externa%type, cd_senha_pos_cab_p pls_conta_pos_cabecalho.cd_senha%type, ie_agrupar_atendimento_p pls_parametro_faturamento.ie_agrupar_atendimento%type, cd_senha_p INOUT text, ie_status_p INOUT text) FROM PUBLIC;

