-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_desfazer_lote_reajuste ( nr_seq_reajuste_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_reajuste_w		bigint;
nr_seq_lote_inscricao_w		bigint;
nr_seq_lote_copartic_w		bigint;
nr_seq_prog_reaj_coletivo_w	pls_prog_reaj_coletivo.nr_sequencia%type;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_reajuste
	where	nr_seq_lote_referencia = nr_seq_reajuste_p
	order by 1;

C02 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_lote_reaj_inscricao
	where	nr_seq_reajuste = nr_seq_reajuste_p;

C03 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_lote_reaj_copartic
	where	nr_seq_reajuste	= nr_seq_reajuste_p;

C04 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_lote_reaj_inscricao
	where	nr_seq_reajuste = nr_seq_reajuste_w;

C05 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_lote_reaj_copartic
	where	nr_seq_reajuste	= nr_seq_reajuste_w;

C06 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_prog_reaj_coletivo
	where	nr_seq_reajuste = nr_seq_reajuste_w;


BEGIN

delete	from	pls_reajuste_tabela
where	nr_seq_reajuste	= nr_seq_reajuste_p;

open C02;
loop
fetch C02 into
	nr_seq_lote_inscricao_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	delete	from	pls_reajuste_inscricao
	where	nr_seq_lote	= nr_seq_lote_inscricao_w;

	delete	from	pls_lote_reaj_inscricao
	where	nr_sequencia	= nr_seq_lote_inscricao_w;
	end;
end loop;
close C02;

open C03;
loop
fetch C03 into
	nr_seq_lote_copartic_w;
EXIT WHEN NOT FOUND; /* apply on C03 */
	begin
	delete	from	pls_reajuste_copartic
	where	nr_seq_lote	= nr_seq_lote_copartic_w;

	delete	from	pls_lote_reaj_copartic
	where	nr_sequencia	= nr_seq_lote_copartic_w;
	end;
end loop;
close C03;

/* Contratos */

open C01;
loop
fetch C01 into
	nr_seq_reajuste_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	delete	from	pls_reajuste_tabela
	where	nr_seq_reajuste	= nr_seq_reajuste_w;

	open C04;
	loop
	fetch C04 into
		nr_seq_lote_inscricao_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
		begin
		delete	from	pls_reajuste_inscricao
		where	nr_seq_lote	= nr_seq_lote_inscricao_w;

		delete	from	pls_lote_reaj_inscricao
		where	nr_sequencia	= nr_seq_lote_inscricao_w;
		end;
	end loop;
	close C04;

	open C05;
	loop
	fetch C05 into
		nr_seq_lote_copartic_w;
	EXIT WHEN NOT FOUND; /* apply on C05 */
		begin
		delete	from	pls_reajuste_copartic
		where	nr_seq_lote	= nr_seq_lote_copartic_w;

		delete	from	pls_lote_reaj_copartic
		where	nr_sequencia	= nr_seq_lote_copartic_w;
		end;
	end loop;
	close C05;

	open C06;
	loop
	fetch C06 into
		nr_seq_prog_reaj_coletivo_w;
	EXIT WHEN NOT FOUND; /* apply on C06 */
		begin
		update	pls_prog_reaj_coletivo
		set	nr_seq_reajuste  = NULL,
			ie_status	= 'L'
		where	nr_sequencia = nr_seq_prog_reaj_coletivo_w;
		end;
	end loop;
	close C06;
	end;
end loop;
close C01;

delete	from	pls_reajuste
where	nr_seq_lote_referencia	= nr_seq_reajuste_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_desfazer_lote_reajuste ( nr_seq_reajuste_p bigint, nm_usuario_p text) FROM PUBLIC;

