-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


PROCEDURE BFT_INSERT_VITAL_SIGN_JOB IS
  AUTOCHARTING_ID_W LT_NUMBER;
  IE_EXECUTOU_W VARCHAR2(1) := 'N';

  


CREATE OR REPLACE PROCEDURE call_bft_insert_vital_sign (AUTO_CHART_PARAM_W AUTO_CHART_PARAM) AS $body$
DECLARE


  S RECORD;
  X RECORD;

BEGIN
    CALL BFT_INSERT_VITAL_SIGN(IE_INTERFACE_P                 => AUTO_CHART_PARAM_W.IE_INTERFACE,
                          CD_PESSOA_FISICA_P             => AUTO_CHART_PARAM_W.CD_PESSOA_FISICA,
                          DT_SINAL_VITAL_P               => TO_CHAR(AUTO_CHART_PARAM_W.DT_SINAL_VITAL,
                                                                    'yyyymmddhh24miss'),
                          DS_LISTA_PARAMETROS_P          => AUTO_CHART_PARAM_W.DS_LISTA_PARAMETROS,
                          DS_LISTA_PARAMETROS2_P         => AUTO_CHART_PARAM_W.DS_LISTA_PARAMETROS2,
                          NM_USUARIO_P                   => coalesce(AUTO_CHART_PARAM_W.NM_USUARIO_PROC,
                                                                AUTO_CHART_PARAM_W.NM_USUARIO),
                          CD_SETOR_ATENDIMENTO_P         => AUTO_CHART_PARAM_W.CD_SETOR_ATENDIMENTO,
                          CD_UNIDADE_BASICA_P            => AUTO_CHART_PARAM_W.CD_UNIDADE_BASICA,
                          CD_UNIDADE_COMPL_P             => AUTO_CHART_PARAM_W.CD_UNIDADE_COMPL,
                          IE_INTEGRACAO_EXTRA_P          => AUTO_CHART_PARAM_W.IE_INTEGRACAO_EXTRA,
                          NR_SEQ_LOG_INTEGRACAO_P        => NULL,
                          NR_ATENDIMENTO_P               => AUTO_CHART_PARAM_W.NR_ATENDIMENTO,
                          IE_CODIGO_PESSOA_P             => AUTO_CHART_PARAM_W.IE_CODIGO_PESSOA,
                          IE_VERIFICA_LEITO_MONITORADO_P => AUTO_CHART_PARAM_W.IE_VERIFICA_LEITO_MONIT,
                          IE_VERIFICA_PRONT_EXT          => AUTO_CHART_PARAM_W.IE_VERIFICA_PRONT_EXT,
                          CD_PROFESSIONAL_P              => AUTO_CHART_PARAM_W.CD_PROFESSIONAL,
                          DS_LOCALE_P                    => AUTO_CHART_PARAM_W.DS_LOCALE,
                          IE_TREND_UPLOAD_P              => 'N',
                          IE_AUTOCHARTING_P              => 'N');
  END;

BEGIN
  FOR S IN (SELECT S.TIPO, S.NR_SEQUENCIA, S.CD_SETOR_ATENDIMENTO
              FROM (SELECT '1' TIPO,
                           ACS.NR_SEQUENCIA,
                           ACS.DT_ATUALIZACAO,
                           ACS.CD_SETOR_ATENDIMENTO,
                           CASE
                             WHEN ACS.DT_ATUALIZACAO + 120 / 1440 <= clock_timestamp() THEN
                              'S'
                             ELSE
                              'N'
                           END IE_FORCE_DEFAULT,
                           coalesce(ACS.DT_ULTIMA_EXEC, clock_timestamp() - interval '365 days') DT_ULTIMA_EXEC,
                           CASE
                             WHEN coalesce(ACS.NR_SEQ_DEFAULT_RATE, 0) = 0 THEN
                              0
                             WHEN ACS.NR_SEQ_DEFAULT_RATE = 1 THEN
                              5 / 1440
                             WHEN ACS.NR_SEQ_DEFAULT_RATE = 2 THEN
                              10 / 1440
                             WHEN ACS.NR_SEQ_DEFAULT_RATE = 3 THEN
                              15 / 1440
                             WHEN ACS.NR_SEQ_DEFAULT_RATE = 4 THEN
                              30 / 1440
                             WHEN ACS.NR_SEQ_DEFAULT_RATE = 5 THEN
                              60 / 1440
                             WHEN ACS.NR_SEQ_DEFAULT_RATE = 6 THEN
                              120 / 1440
                             WHEN ACS.NR_SEQ_DEFAULT_RATE = 7 THEN
                              240 / 1440
                             ELSE
                              0
                           END QT_DEFAULT_RATE,
                           CASE
                             WHEN coalesce(ACS.NR_SEQ_RUN_RATE, 0) = 0 THEN
                              0
                             WHEN ACS.NR_SEQ_RUN_RATE = 1 THEN
                              30 / 1440
                             WHEN ACS.NR_SEQ_RUN_RATE = 2 THEN
                              60 / 1440
                             WHEN ACS.NR_SEQ_RUN_RATE = 3 THEN
                              120 / 1440
                             WHEN ACS.NR_SEQ_RUN_RATE = 4 THEN
                              240 / 1440
                             ELSE
                              0
                           END QT_RUN_RATE
                      FROM AUTO_CHARTING_SETOR ACS
                     WHERE ACS.CD_SETOR_ATENDIMENTO NOT IN (SELECT ACR.CD_SETOR_ATENDIMENTO
                              FROM AUTO_CHART_RATE ACR
                             WHERE ACR.CD_SETOR_ATENDIMENTO =
                                   ACS.CD_SETOR_ATENDIMENTO)

UNION

                    SELECT '2' TIPO,
                           ACR.NR_SEQUENCIA,
                           ACR.DT_ATUALIZACAO,
                           ACR.CD_SETOR_ATENDIMENTO,
                           CASE
                             WHEN ACR.DT_ATUALIZACAO + 120 / 1440 <= clock_timestamp() THEN
                              'S'
                             ELSE
                              'N'
                           END IE_FORCE_DEFAULT,
                           coalesce(ACR.DT_ULTIMA_EXEC, clock_timestamp() - interval '365 days') DT_ULTIMA_EXEC,
                           CASE
                             WHEN coalesce(ACS.NR_SEQ_DEFAULT_RATE, 0) = 0 THEN
                              0
                             WHEN ACS.NR_SEQ_DEFAULT_RATE = 1 THEN
                              5 / 1440
                             WHEN ACS.NR_SEQ_DEFAULT_RATE = 2 THEN
                              10 / 1440
                             WHEN ACS.NR_SEQ_DEFAULT_RATE = 3 THEN
                              15 / 1440
                             WHEN ACS.NR_SEQ_DEFAULT_RATE = 4 THEN
                              30 / 1440
                             WHEN ACS.NR_SEQ_DEFAULT_RATE = 5 THEN
                              60 / 1440
                             WHEN ACS.NR_SEQ_DEFAULT_RATE = 6 THEN
                              120 / 1440
                             WHEN ACS.NR_SEQ_DEFAULT_RATE = 7 THEN
                              240 / 1440
                             ELSE
                              0
                           END QT_DEFAULT_RATE,
                           CASE
                             WHEN coalesce(ACR.QT_RATE, 0) = 0 THEN
                              0
                             WHEN ACR.QT_RATE = 1 THEN
                              5 / 1440
                             WHEN ACR.QT_RATE = 2 THEN
                              10 / 1440
                             WHEN ACR.QT_RATE = 3 THEN
                              15 / 1440
                             WHEN ACR.QT_RATE = 4 THEN
                              30 / 1440
                             WHEN ACR.QT_RATE = 5 THEN
                              60 / 1440
                             WHEN ACR.QT_RATE = 6 THEN
                              120 / 1440
                             WHEN ACR.QT_RATE = 7 THEN
                              240 / 1440
                             ELSE
                              0
                           END QT_RUN_RATE
                      FROM AUTO_CHART_RATE ACR
                      LEFT JOIN AUTO_CHARTING_SETOR ACS ON (ACR.CD_SETOR_ATENDIMENTO =
                                                           ACS.CD_SETOR_ATENDIMENTO)) S
             WHERE (S.IE_FORCE_DEFAULT = 'S' AND
                   S.DT_ULTIMA_EXEC + S.QT_DEFAULT_RATE <= clock_timestamp())
                OR (S.IE_FORCE_DEFAULT = 'N' AND
                   S.DT_ULTIMA_EXEC + S.QT_RUN_RATE <= clock_timestamp())) LOOP
    IE_EXECUTOU_W := 'N';

    SELECT ACP.NR_SEQUENCIA BULK COLLECT
      INTO STRICT AUTOCHARTING_ID_W
      FROM AUTO_CHART_PARAM ACP
     WHERE trim(both UPPER(ACP.CD_SETOR_ATENDIMENTO)) IN (SELECT DISTINCT trim(both UPPER(UA.NM_SETOR_INTEGRACAO))
              FROM UNIDADE_ATENDIMENTO UA
             WHERE UA.CD_SETOR_ATENDIMENTO = S.CD_SETOR_ATENDIMENTO)
     ORDER BY ACP.NR_SEQUENCIA;

    FOR X IN (SELECT ACP.*
                FROM AUTO_CHART_PARAM ACP
               WHERE ACP.NR_SEQUENCIA IN (SELECT * FROM TABLE(AUTOCHARTING_ID_W))) LOOP
      CALL CALL_BFT_INSERT_VITAL_SIGN(X);

      IE_EXECUTOU_W := 'S';
    END LOOP;

    DELETE FROM AUTO_CHART_PARAM ACP
     WHERE ACP.NR_SEQUENCIA IN (SELECT * FROM TABLE(AUTOCHARTING_ID_W));

    IF (IE_EXECUTOU_W = 'S' AND S.TIPO = '1') THEN
      UPDATE AUTO_CHARTING_SETOR ACS
         SET ACS.DT_ULTIMA_EXEC = clock_timestamp()
       WHERE ACS.NR_SEQUENCIA = S.NR_SEQUENCIA;
    ELSIF (IE_EXECUTOU_W = 'S' AND S.TIPO = '2') THEN
      UPDATE AUTO_CHART_RATE ACR
         SET ACR.DT_ULTIMA_EXEC = clock_timestamp()
       WHERE ACR.NR_SEQUENCIA = S.NR_SEQUENCIA;
    END IF;

    COMMIT;
  END LOOP;

END;
$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE call_bft_insert_vital_sign (AUTO_CHART_PARAM_W AUTO_CHART_PARAM) FROM PUBLIC;

