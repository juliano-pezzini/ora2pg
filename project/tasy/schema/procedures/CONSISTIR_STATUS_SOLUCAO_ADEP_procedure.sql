-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_status_solucao_adep (ie_tipo_solucao_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint, ie_consiste_em_adm_p text, ie_consistencia_p INOUT text, cd_funcao_p bigint, nr_atendimento_p bigint default null, nr_seq_item_cpoe_p bigint default null) AS $body$
DECLARE


ie_status_w	varchar(3);
ie_tem_etapas_w	varchar(3);
nr_seq_mensagem_w bigint := null;

/*  IE_CONSISTENCIA_P
SSI - Suspensão de solução iniciada/reiniciada
SA   - Suspensão de solução administrada.
SSP - Solução com etapas pendentes e nenhuma em andamento
SSIP - Solução com etapa em andamento e etapas pendentes
NC - Não Consiste a administração
*/
BEGIN
if (ie_tipo_solucao_p IS NOT NULL AND ie_tipo_solucao_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_solucao_p IS NOT NULL AND nr_seq_solucao_p::text <> '') then

	/* obter status atual solução */

	select	substr(obter_status_solucao_prescr(ie_tipo_solucao_p, nr_prescricao_p, nr_seq_solucao_p, 'S'),1,3),
		substr(coalesce(obter_se_tem_etapas_prescr(ie_tipo_solucao_p, nr_prescricao_p, nr_seq_solucao_p, nr_seq_item_cpoe_p),'X'),1,3)
	into STRICT	ie_status_w,
		ie_tem_etapas_w
	;

    /* consistir suspensao x stats item adep */

    if (coalesce(ie_consiste_em_adm_p,'S') = 'S') then
        begin
		if	((ie_status_w = 'I') or (ie_status_w = 'R') or (ie_status_w = 'ITX')) then

			if (ie_tem_etapas_w = 'S') then
				ie_consistencia_p := 'SSIP';
				-- Suspender etapas pendentes
				 CALL cpoe_suspender_etapas_prescr(ie_tipo_solucao_p, nr_prescricao_p, nr_seq_solucao_p, nr_seq_item_cpoe_p, nr_atendimento_p);
				-- Informar usuário sobre OM
			else
				ie_consistencia_p := 'SSI';
			end if;

			if	((cd_funcao_p <> 2314) and 
				((cd_funcao_p <> 950) or (ie_tipo_solucao_p <> 1))) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(206429);
			end if;
		
		elsif (ie_tem_etapas_w = 'S' and ie_status_w not in ('I','R','T','X')) then
			ie_consistencia_p := 'SSP';
			-- Suspender etapas pendentes
			CALL cpoe_suspender_etapas_prescr(ie_tipo_solucao_p, nr_prescricao_p, nr_seq_solucao_p, nr_seq_item_cpoe_p, nr_atendimento_p);
		
		elsif (ie_status_w = 'T') then

			ie_consistencia_p := 'SA';

			if	((cd_funcao_p <> 2314) and
				((cd_funcao_p <> 950) or (ie_tipo_solucao_p <> 1))) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(206430);
			end if;
		end if;
        end;
    else
        ie_consistencia_p := 'NC';
    end if;
end if;

if coalesce(ie_consistencia_p::text, '') = '' then
    ie_consistencia_p := coalesce(ie_status_w, 'N');
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_status_solucao_adep (ie_tipo_solucao_p bigint, nr_prescricao_p bigint, nr_seq_solucao_p bigint, ie_consiste_em_adm_p text, ie_consistencia_p INOUT text, cd_funcao_p bigint, nr_atendimento_p bigint default null, nr_seq_item_cpoe_p bigint default null) FROM PUBLIC;

