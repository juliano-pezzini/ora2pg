-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_juros_multa (NR_TITULO_P bigint, NR_SEQUENCIA_P bigint, DT_RECEBIMENTO_P timestamp) AS $body$
DECLARE

 
VL_TAXA_MULTA_W          double precision := 0;
VL_TAXA_JUROS_W          double precision := 0;
NR_DIAS_LIVRE_JUROS_W       integer   := 0;
NR_DIAS_LIVRE_MULTA_W       integer   := 0;
VL_SALDO_TITULO_W         double precision := 0;
TX_JUROS_W             double precision  := 0;
TX_MULTA_W             double precision  := 0;
CD_TIPO_TAXA_JURO_W        bigint  := 0;
CD_TIPO_TAXA_MULTA_W        bigint  := 0;
NR_SEQ_ANTERIOR_W         integer   := 0;
NR_SALDO_JUROS_W          smallint   := 1;
NR_SALDO_MULTA_W          smallint   := 1;
IE_TIPO_TAXA_JUROS_W        varchar(1);
IE_TIPO_TAXA_MULTA_W        varchar(1);
DT_VENCIMENTO_W          timestamp;
DT_RECEB_ATUAL_W          timestamp;
DT_RECEB_ANTERIOR_W        timestamp;

C01 CURSOR FOR 
  SELECT DT_RECEBIMENTO, 
     NR_SEQUENCIA 
  FROM TITULO_RECEBER_LIQ 
  WHERE NR_TITULO  = NR_TITULO_P 
   AND NR_SEQUENCIA <= NR_SEQUENCIA_P 
   and	coalesce(ie_lib_caixa, 'S') = 'S' 
  ORDER BY NR_SEQUENCIA DESC;


BEGIN 
 
/* OBTER DADOS DO TITULO */
 
SELECT VL_SALDO_TITULO, 
    TX_JUROS, 
    TX_MULTA, 
    CD_TIPO_TAXA_JURO, 
    CD_TIPO_TAXA_MULTA, 
    DT_VENCIMENTO 
 INTO STRICT VL_SALDO_TITULO_W, 
    TX_JUROS_W, 
    TX_MULTA_W, 
    CD_TIPO_TAXA_JURO_W, 
    CD_TIPO_TAXA_MULTA_W, 
    DT_VENCIMENTO_W 
FROM TITULO_RECEBER 
WHERE NR_TITULO = NR_TITULO_P;
 
/* OBTER NR. DIAS DE JUROS E O TIPO DE TAXA MENSAL/ANUAL*/
 
SELECT NR_DIAS_LIVRE, 
    IE_TIPO_TAXA 
 INTO STRICT NR_DIAS_LIVRE_JUROS_W, 
    IE_TIPO_TAXA_JUROS_W 
FROM TIPO_TAXA 
WHERE CD_TIPO_TAXA = CD_TIPO_TAXA_JURO_W;
 
/* OBTER NR. DIAS DE MULTA E O TIPO DE TAXA MENSAL/ANUAL*/
 
SELECT NR_DIAS_LIVRE, 
    IE_TIPO_TAXA 
 INTO STRICT NR_DIAS_LIVRE_MULTA_W, 
    IE_TIPO_TAXA_MULTA_W 
FROM TIPO_TAXA 
WHERE CD_TIPO_TAXA = CD_TIPO_TAXA_MULTA_W;
 
IF (NR_SEQUENCIA_P > 1) THEN 
  BEGIN 
  DT_RECEB_ATUAL_W  := DT_RECEBIMENTO_P;
 
  OPEN C01;
  LOOP 
     FETCH C01 
        INTO DT_RECEB_ANTERIOR_W, 
          NR_SEQ_ANTERIOR_W;
     IF C01%FOUND THEN 
       BEGIN 
       IF (DT_RECEB_ATUAL_W > DT_RECEB_ANTERIOR_W) THEN 
         BEGIN  
         IF (NR_SEQ_ANTERIOR_W = 1) THEN 
          BEGIN 
          NR_SALDO_JUROS_W := ((DT_RECEB_ATUAL_W - DT_VENCIMENTO_W) +              
                     NR_DIAS_LIVRE_JUROS_W) + NR_SALDO_JUROS_W;
          NR_SALDO_MULTA_W := ((DT_RECEB_ATUAL_W - DT_VENCIMENTO_W) +    
                     NR_DIAS_LIVRE_MULTA_W) + NR_SALDO_MULTA_W;
          END;
         ELSE 
          BEGIN 
          NR_SALDO_JUROS_W := ((DT_RECEB_ATUAL_W - DT_RECEB_ANTERIOR_W) + 
                     NR_DIAS_LIVRE_JUROS_W) +                      NR_SALDO_JUROS_W;
          NR_SALDO_MULTA_W := ((DT_RECEB_ATUAL_W - DT_RECEB_ANTERIOR_W) + 
                     NR_DIAS_LIVRE_MULTA_W) + 
                     NR_SALDO_MULTA_W;
          END;
         END IF;
         END;
       END IF;
       END;
     ELSE 
       EXIT;
     DT_RECEB_ATUAL_W := DT_RECEB_ANTERIOR_W;
     END IF;
  END LOOP;
  CLOSE C01;
  END;
ELSE 
  BEGIN 
  IF (DT_RECEBIMENTO_P > DT_VENCIMENTO_W) THEN 
    BEGIN  
    NR_SALDO_JUROS_W := (DT_RECEBIMENTO_P - DT_VENCIMENTO_W) +    NR_DIAS_LIVRE_JUROS_W;
    NR_SALDO_MULTA_W := (DT_RECEBIMENTO_P - DT_VENCIMENTO_W) +    NR_DIAS_LIVRE_MULTA_W;
    END;
  ELSE 
    BEGIN  
    NR_SALDO_JUROS_W := (DT_RECEBIMENTO_P - DT_VENCIMENTO_W);
    NR_SALDO_MULTA_W := (DT_RECEBIMENTO_P - DT_VENCIMENTO_W);
    END;
  END IF;
  END;
END IF;
 
IF (DT_RECEBIMENTO_P > DT_VENCIMENTO_W) THEN 
  BEGIN 
  IF (IE_TIPO_TAXA_JUROS_W = 'M') THEN 
    VL_TAXA_JUROS_W := ((TX_JUROS_W / 30 ) * NR_SALDO_JUROS_W);
  ELSE 
    VL_TAXA_JUROS_W := ((TX_JUROS_W / 360 ) * NR_SALDO_JUROS_W);
  END IF;
 
  IF (IE_TIPO_TAXA_MULTA_W = 'M') THEN 
    VL_TAXA_MULTA_W := (( TX_MULTA_W / 30) * NR_SALDO_MULTA_W);
  ELSE 
    VL_TAXA_MULTA_W := (( TX_MULTA_W / 360) * NR_SALDO_MULTA_W);
  END IF;
  END;
END IF;
UPDATE TITULO_RECEBER 
SET VL_SALDO_JUROS = VL_TAXA_JUROS_W, 
  VL_SALDO_MULTA = VL_TAXA_MULTA_W 
WHERE NR_TITULO   = NR_TITULO_P;
 
COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_juros_multa (NR_TITULO_P bigint, NR_SEQUENCIA_P bigint, DT_RECEBIMENTO_P timestamp) FROM PUBLIC;

