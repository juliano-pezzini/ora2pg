-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_regra_tipo_repasse ( nr_seq_tipo_p bigint, nr_repasse_terceiro_p bigint, nm_usuario_p text) AS $body$
DECLARE


c_tipo_repasse_regra_ger CURSOR(nr_seq_tipo_pc	tipo_repasse.nr_sequencia%type) FOR
	SELECT	a.cd_regra,
		a.ie_considerar_regra
	from	tipo_repasse b,
		tipo_repasse_regra_geracao a
	where	a.nr_seq_tipo_repasse	= b.nr_sequencia
	and	b.nr_sequencia = nr_seq_tipo_pc
	and	coalesce(b.cd_regra::text, '') = ''
	
union	all

	PERFORM	a.cd_regra,
		'C' ie_considerar_regra
	from	tipo_repasse a
	where	a.nr_sequencia = nr_seq_tipo_pc
	and	(a.cd_regra IS NOT NULL AND a.cd_regra::text <> '');

BEGIN

delete	FROM repasse_terceiro_regra
where	nr_repasse_terceiro = nr_repasse_terceiro_p;

for r_c_tipo_rep_regra_ger in c_tipo_repasse_regra_ger(nr_seq_tipo_p) loop
	insert	into	repasse_terceiro_regra(	nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						nr_repasse_terceiro,
						cd_regra,
						cd_regra_fora)
		values (		nextval('repasse_terceiro_regra_seq'),
						clock_timestamp(),
						nm_usuario_p,
						nr_repasse_terceiro_p,
						CASE WHEN r_c_tipo_rep_regra_ger.ie_considerar_regra='C' THEN r_c_tipo_rep_regra_ger.cd_regra  ELSE null END ,
						CASE WHEN r_c_tipo_rep_regra_ger.ie_considerar_regra='N' THEN r_c_tipo_rep_regra_ger.cd_regra  ELSE null END );
end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_regra_tipo_repasse ( nr_seq_tipo_p bigint, nr_repasse_terceiro_p bigint, nm_usuario_p text) FROM PUBLIC;

