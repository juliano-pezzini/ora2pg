-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE importar_solic_compra_xml ( ie_etapa_p text, nm_usuario_p text, cd_estabelecimento_p bigint, cd_setor_atendimento_p bigint, dt_solicitacao_compra_P timestamp, cd_pessoa_solicitante_p text, cd_local_estoque_p bigint, cd_centro_custo_p bigint, cd_conta_contabil_p text, ds_observacao_solic_p text, ie_aviso_chegada_p text, ie_aviso_aprov_oc_p text, ie_urgente_p text, nr_documento_externo_p text, cd_material_p bigint, qt_material_p bigint, ds_material_direto_p text, ds_observacao_item_p text, dt_solic_item_p timestamp, qt_entrega_solicitada_p bigint, dt_entrega_solicitada_p timestamp, ds_observacao_entr_p text, nr_solic_compra_p INOUT bigint, nr_item_solic_compra_p INOUT bigint, ds_erro_p INOUT text) AS $body$
DECLARE




nr_solic_compra_w			bigint;
nr_item_solic_compra_w		integer;
nr_item_solic_compra_entr_w		integer;
cd_unidade_medida_compra_w	varchar(30);
qt_existe_w			integer;
cd_local_estoque_w		smallint;
cd_centro_custo_w			integer;
cd_pessoa_solicitante_w		varchar(10);



BEGIN


if (ie_etapa_p = '0') then
	begin

	select	nextval('solic_compra_seq')
	into STRICT	nr_solic_compra_w
	;
	nr_solic_compra_p	:= nr_solic_compra_w;


	if (cd_local_estoque_p > 0) then
		cd_local_estoque_w	:= cd_local_estoque_p;
		select	count(*)
		into STRICT	qt_existe_w
		from	local_estoque
		where	cd_local_estoque = cd_local_estoque_w;
		if (qt_existe_w = 0) then
			ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(279765) || cd_local_estoque_w;
		end if;
	end if;

	if (cd_centro_custo_p > 0) then
		cd_centro_custo_w	:= cd_centro_custo_p;
		select	count(*)
		into STRICT	qt_existe_w
		from	centro_custo
		where	cd_centro_custo = cd_centro_custo_w;
		if (qt_existe_w = 0) then
			ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(279766) || cd_centro_custo_w;
		end if;
	end if;

	if (cd_pessoa_solicitante_p > 0) then
		cd_pessoa_solicitante_w	:= cd_pessoa_solicitante_p;
		select	count(*)
		into STRICT	qt_existe_w
		from	pessoa_fisica
		where	cd_pessoa_fisica = cd_pessoa_solicitante_w;
		if (qt_existe_w = 0) then
			ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(279767) || cd_pessoa_solicitante_w;
		end if;
	end if;

	if (coalesce(ds_erro_p::text, '') = '') then
		begin

		insert into solic_compra(
			nr_solic_compra,
			cd_estabelecimento,
			dt_solicitacao_compra,
			dt_atualizacao,
			nm_usuario,
			ie_situacao,
			cd_pessoa_solicitante,
			cd_local_estoque,
			cd_centro_custo,
			cd_conta_contabil,
			cd_setor_atendimento,
			ds_observacao,
			ie_aviso_chegada,
			ie_aviso_aprov_oc,
			ie_urgente,
			nr_documento_externo,
			ie_tipo_solicitacao,
			ie_comodato,
			ie_semanal,
			nm_usuario_nrec,
			dt_atualizacao_nrec)
		values ( nr_solic_compra_p,
			cd_estabelecimento_p,
			dt_solicitacao_compra_p,
			clock_timestamp(),
			nm_usuario_p,
			'A',
			cd_pessoa_solicitante_p,
			cd_local_estoque_w,
			cd_centro_custo_w,
			cd_conta_contabil_p,
			cd_setor_atendimento_p,
			ds_observacao_solic_p,
			ie_aviso_chegada_p,
			ie_aviso_aprov_oc_p,
			ie_urgente_p,
			nr_documento_externo_p,
			2,'N','N',
			nm_usuario_p,
			clock_timestamp());
		end;
	end if;
	end;
end if;



if (ie_etapa_p = '1') then
	begin

	select	coalesce(max(nr_item_solic_compra), 0) + 1
	into STRICT	nr_item_solic_compra_w
	from	solic_compra_item
	where	nr_solic_compra	= nr_solic_compra_p;
	nr_item_solic_compra_p	:= nr_item_solic_compra_w;

	select	substr(obter_dados_material_estab(cd_material,cd_estabelecimento_p,'UMC'),1,255) cd_unidade_medida_compra
	into STRICT	cd_unidade_medida_compra_w
	from	material
	where	cd_material = cd_material_p;

	insert into solic_compra_item(
		nr_solic_compra,
		nr_item_solic_compra,
		cd_material,
		cd_unidade_medida_compra,
		qt_material,
		dt_atualizacao,
		nm_usuario,
		ie_situacao,
		ds_material_direto,
		ds_observacao,
		ie_geracao,
		qt_conv_compra_est_orig,
		qt_saldo_disp_estoque)
	values (	nr_solic_compra_p,
		nr_item_solic_compra_p,
		cd_material_p,
		cd_unidade_medida_compra_w,
		qt_material_p,
		clock_timestamp(),
		nm_usuario_p,
		'A',
		ds_material_direto_p,
		ds_observacao_solic_p,
		'S',
		obter_dados_material(cd_material_p,'QCE'),
		obter_saldo_disp_estoque(cd_estabelecimento_p, cd_material_p, cd_local_estoque_p, trunc(clock_timestamp(),'mm')));

	end;
end if;


if (ie_etapa_p = '6') then
	begin

	select	coalesce(max(nr_item_solic_compra_entr), 0) + 1
	into STRICT	nr_item_solic_compra_entr_w
	from	solic_compra_item_entrega
	where	nr_solic_compra		= nr_solic_compra_p
	and	nr_item_solic_compra	= nr_item_solic_compra_p;

	insert into solic_compra_item_entrega(
		nr_solic_compra,
		nr_item_solic_compra,
		nr_item_solic_compra_entr,
		qt_entrega_solicitada,
		dt_entrega_solicitada,
		dt_atualizacao,
		nm_usuario,
		ds_observacao)
	values ( nr_solic_compra_p,
		nr_item_solic_compra_p,
		nr_item_solic_compra_entr_w,
		qt_entrega_solicitada_p,
		dt_entrega_solicitada_p,
		clock_timestamp(),
		nm_usuario_p,
		ds_observacao_entr_p);

	end;
end if;



end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importar_solic_compra_xml ( ie_etapa_p text, nm_usuario_p text, cd_estabelecimento_p bigint, cd_setor_atendimento_p bigint, dt_solicitacao_compra_P timestamp, cd_pessoa_solicitante_p text, cd_local_estoque_p bigint, cd_centro_custo_p bigint, cd_conta_contabil_p text, ds_observacao_solic_p text, ie_aviso_chegada_p text, ie_aviso_aprov_oc_p text, ie_urgente_p text, nr_documento_externo_p text, cd_material_p bigint, qt_material_p bigint, ds_material_direto_p text, ds_observacao_item_p text, dt_solic_item_p timestamp, qt_entrega_solicitada_p bigint, dt_entrega_solicitada_p timestamp, ds_observacao_entr_p text, nr_solic_compra_p INOUT bigint, nr_item_solic_compra_p INOUT bigint, ds_erro_p INOUT text) FROM PUBLIC;

