-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE incluir_componente_kit ( ie_tipo_p text, cd_especialidade_p text, cd_material_p text, qt_material_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_sequencia_w		integer;
cd_kit_material_w		integer;
ds_kit_material_w		varchar(80);
ie_situacao_w		varchar(1);
ie_tipo_w			varchar(1);
ie_forma_baixa_w		varchar(1);
ie_material_pai_w		varchar(1);
cd_especialidade_w	integer;
ie_restringe_estab_w	varchar(1);

C01 CURSOR FOR

SELECT	b.cd_kit_material,
	b.ds_kit_material,
	b.ie_situacao,
	b.ie_tipo,
	b.ie_forma_baixa,
	b.ie_material_pai,
	b.cd_especialidade_medica
from	kit_material b
where  	b.ie_tipo = ie_tipo_p
and (b.cd_especialidade_medica = cd_especialidade_p or coalesce(cd_especialidade_p::text, '') = '')
and (ie_restringe_estab_w <> 'E' or (SELECT coalesce(cd_estab_exclusivo,cd_estabelecimento_p) from kit_material where cd_kit_material = b.cd_kit_material) = cd_estabelecimento_p)
and	b.ie_situacao = 'A';


BEGIN

ie_restringe_estab_w := Obter_Param_Usuario(143, 281, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_restringe_estab_w);

open C01;
loop
fetch C01 into
	cd_kit_material_w,
	ds_kit_material_w,
	ie_situacao_w,
	ie_tipo_w,
	ie_forma_baixa_w,
	ie_material_pai_w,
	cd_especialidade_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

	select	coalesce(max(nr_sequencia), 0) + 1
	into STRICT	nr_sequencia_w
	from	componente_kit
	where	cd_kit_material = cd_kit_material_w;

	insert into componente_kit(
		cd_kit_material,
		nr_sequencia,
		cd_material,
		qt_material,
		ie_situacao,
		dt_atualizacao,
		nm_usuario,
		ie_baixa_estoque,
		ie_dispensavel,
		ie_video,
		ie_calcula_preco,
		ie_entra_conta,
		ie_duplica_prescr,
		ie_multiplica_dose,
		ie_duplica_req)
	values (	cd_kit_material_w,
		nr_sequencia_w,
		cd_material_p,
		qt_material_p,
		'A',
		clock_timestamp(),
		nm_usuario_p,
		'S',
		'N',
		'A',
		'S',
		'S',
		'S',
		'N',
		'S');

end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE incluir_componente_kit ( ie_tipo_p text, cd_especialidade_p text, cd_material_p text, qt_material_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

