-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baixar_solic_compra_com_ordem ( nr_ordem_compra_p bigint) AS $body$
DECLARE


nr_solic_compra_w		bigint;
nr_solic_compra_ww		solic_compra.nr_solic_compra%type;
nr_cot_compra_w			bigint;
nr_item_cot_compra_w		integer;
qt_existe_agrup_w		bigint := 0;
nr_item_solic_compra_w		bigint;
ie_cotacao_pendente_w		parametro_compras.ie_cons_cot_pend%type;
qt_material_sci_w			solic_compra_item.qt_material%type;

c01 CURSOR FOR
SELECT	distinct
	nr_solic_compra
from	ordem_compra_item
where	nr_ordem_compra	= nr_ordem_compra_p;

c02 CURSOR FOR
SELECT distinct
	b.nr_cot_compra, 
	b.nr_item_cot_compra
from 	cot_compra_solic_agrup b, ordem_compra_item a
where	b.nr_solic_compra 	= nr_solic_compra_w
and a.nr_cot_compra 	= b.nr_cot_compra
and a.nr_item_cot_compra 	= b.nr_item_cot_compra
and a.nr_ordem_compra	= nr_ordem_compra_p
and	a.nr_solic_compra	= nr_solic_compra_w;

c04 CURSOR FOR			
SELECT	distinct nr_item_solic_compra,
	coalesce(qt_material,0)
from	solic_compra_item
where	nr_solic_compra = nr_solic_compra_w
and	nr_item_solic_compra	in (
			SELECT 	nr_item_solic_compra
			from 	ordem_compra_item
			where	nr_ordem_compra	= nr_ordem_compra_p
			and	nr_solic_compra	= nr_solic_compra_w);

c05 CURSOR FOR	
SELECT	distinct
	b.nr_solic_compra, 
	b.nr_item_solic_compra, 
	coalesce(b.qt_material,0) qt_material
from	cot_compra_solic_agrup a, solic_compra_item b
where	a.nr_cot_compra		= nr_cot_compra_w
and		a.nr_item_cot_compra	= nr_item_cot_compra_w 
and 	a.nr_solic_compra = b.nr_solic_compra
and 	a.nr_item_solic_compra = b.nr_item_solic_compra
and		coalesce(b.dt_baixa::text, '') = '';	


BEGIN

select	coalesce(max(ie_cons_cot_pend),'S')
into STRICT	ie_cotacao_pendente_w
from	parametro_compras
where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

open c01;
loop
fetch c01 into 	
	nr_solic_compra_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	open c04;
	loop
	fetch c04 into
		nr_item_solic_compra_w,
		qt_material_sci_w;
	EXIT WHEN NOT FOUND; /* apply on c04 */
		begin

		if ((ie_cotacao_pendente_w = 'S')
			or ((ie_cotacao_pendente_w = 'N') and ((qt_material_sci_w - coalesce(obter_qt_sc_comprometido(nr_solic_compra_w, nr_item_solic_compra_w, null, wheb_usuario_pck.get_cd_estabelecimento),0)) <= 0))) then
			begin
				update solic_compra_item
				set 	dt_baixa = clock_timestamp()
				where	nr_solic_compra = nr_solic_compra_w
				and	nr_item_solic_compra = nr_item_solic_compra_w;

				CALL gerar_hist_solic_sem_commit(
				nr_solic_compra_w,
				WHEB_MENSAGEM_PCK.get_texto(297809),
				WHEB_MENSAGEM_PCK.get_texto(297901,'NR_ITEM_SOLIC_COMPRA_W=' || nr_item_solic_compra_w || ';' ||
								'NR_SOLIC_COMPRA_W=' || nr_solic_compra_w),
				'B',
				'TASY');
			end;
		end if;

		end;
	end loop;
	close c04;
		
	select count(1)
	into STRICT	qt_existe_agrup_w
	from 	cot_compra_solic_agrup b, ordem_compra_item a
	where	b.nr_solic_compra 	= nr_solic_compra_w
	and a.nr_cot_compra 	= b.nr_cot_compra
	and a.nr_item_cot_compra 	= b.nr_item_cot_compra
	and a.nr_ordem_compra	= nr_ordem_compra_p
	and	a.nr_solic_compra	= nr_solic_compra_w;
		
	if (qt_existe_agrup_w > 0) then
		begin
		open C02;
		loop
		fetch C02 into	
			nr_cot_compra_w,
			nr_item_cot_compra_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			open c05;
			loop
			fetch c05 into
				nr_solic_compra_ww,
				nr_item_solic_compra_w,
				qt_material_sci_w;
			EXIT WHEN NOT FOUND; /* apply on c05 */
				begin

				if ((ie_cotacao_pendente_w = 'S')
					or ((ie_cotacao_pendente_w = 'N') and ((qt_material_sci_w - coalesce(obter_qt_sc_comprometido(nr_solic_compra_ww, nr_item_solic_compra_w, null, wheb_usuario_pck.get_cd_estabelecimento),0)) <= 0))) then
					begin
						update solic_compra_item
						set 	dt_baixa = clock_timestamp()
						where	nr_solic_compra = nr_solic_compra_ww
						and	nr_item_solic_compra = nr_item_solic_compra_w;

						CALL gerar_hist_solic_sem_commit(
						nr_solic_compra_ww,
						WHEB_MENSAGEM_PCK.get_texto(297809),
						WHEB_MENSAGEM_PCK.get_texto(297901,'NR_ITEM_SOLIC_COMPRA_W=' || nr_item_solic_compra_w || ';' ||
										'NR_SOLIC_COMPRA_W=' || nr_solic_compra_ww),
						'B',
						'TASY');
					end;
				end if;

				end;
			end loop;
			close c05;	

			update	solic_compra
			set	dt_baixa = clock_timestamp()
			where	coalesce(dt_baixa::text, '') = ''
			and	nr_solic_compra in (
				SELECT	nr_solic_compra
				from	cot_compra_solic_agrup
				where	nr_cot_compra		= nr_cot_compra_w
				and	nr_item_cot_compra	= nr_item_cot_compra_w)
			and	not exists (
				SELECT 1
				from	solic_compra_item
				where	nr_solic_compra in (
					select	nr_solic_compra
					from	cot_compra_solic_agrup
					where	nr_cot_compra		= nr_cot_compra_w
					and	nr_item_cot_compra	= nr_item_cot_compra_w)
				and	coalesce(dt_baixa::text, '') = '');

			end;
		end loop;
		close C02;
		end;
	end if;
	
	update	solic_compra
	set	dt_baixa		= clock_timestamp()
	where	nr_solic_compra	= nr_solic_compra_w
	and	not exists (
		SELECT 1
		from	solic_compra_item
		where	nr_solic_compra = nr_solic_compra_w
		and	coalesce(dt_baixa::text, '') = '');

	update	processo_aprov_compra a
	set	a.ie_aprov_reprov = 'B',
		a.ds_observacao = substr(WHEB_MENSAGEM_PCK.get_texto(297808,'DS_OBSERVACAO_W=' || a.ds_observacao || ';' || 'NR_ORDEM_COMPRA_P=' || nr_ordem_compra_p),1,2000)
	where	a.nr_sequencia in (
		SELECT	distinct(nr_seq_aprovacao)
		from	solic_compra_item
		where	nr_solic_compra = nr_solic_compra_w)
	and	ie_aprov_reprov = 'P'
	and	not exists (
		SELECT	1
		from	solic_compra_item x
		where	x.nr_seq_aprovacao = a.nr_sequencia
		and	coalesce(dt_baixa::text, '') = '');
	
	end;
end loop;
close c01;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baixar_solic_compra_com_ordem ( nr_ordem_compra_p bigint) FROM PUBLIC;

