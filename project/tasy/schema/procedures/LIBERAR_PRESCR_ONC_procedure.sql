-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_prescr_onc ( nr_prescricao_p bigint, nr_seq_atendimento_p bigint, cd_estabelecimento_p bigint, ds_erro_p text, nm_usuario_p text) AS $body$
DECLARE

								 
cd_pessoa_usuario_w			varchar(15);
ie_medico_w					varchar(2);
ie_gerar_lib_enf_w			varchar(1);
ie_prescricao_w				varchar(1);
nr_prescricao_w				bigint;
nr_atendimento_w			bigint;
ie_liberar_para_agend_w		varchar(1);
ds_erro_w					varchar(255);
cd_medico_prescr_w			bigint;


BEGIN 
 
ie_gerar_lib_enf_w := obter_param_usuario(3130, 50, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_gerar_lib_enf_w);
ie_liberar_para_agend_w := Obter_param_Usuario(281, 1206, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_liberar_para_agend_w);
 
nr_prescricao_w	:=	nr_prescricao_p;
ds_erro_w		:= ds_erro_p;
 
select 	cd_medico 
into STRICT	cd_medico_prescr_w 
from	prescr_medica 
where	nr_prescricao = nr_prescricao_p;
 
select	max(cd_pessoa_fisica) 
into STRICT	cd_pessoa_usuario_w 
from	usuario 
where	nm_usuario	= nm_usuario_p;
 
select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  
into STRICT	ie_medico_w 
from	medico 
where	cd_pessoa_fisica = cd_pessoa_usuario_w 
and	ie_situacao	= 'A';
 
SELECT	a.nr_atendimento 
INTO STRICT	nr_atendimento_w 
FROM	paciente_setor b, 
		paciente_atendimento a 
WHERE	a.nr_seq_atendimento = nr_seq_atendimento_p 
AND		a.nr_seq_paciente = b.nr_seq_paciente;
 
ie_prescricao_w	:= 'N';
if (ie_gerar_lib_enf_w = 'N') then 
	ie_prescricao_w	:= 'S';
end if;
CALL Gerar_kit_Prescricao(cd_estabelecimento_p,nr_prescricao_w,NULL,nm_usuario_p);
CALL Gerar_kit_solucao(nr_prescricao_w,nm_usuario_p,obter_perfil_ativo);
ds_erro_w := liberar_prescricao(nr_prescricao_w, nr_atendimento_w, ie_medico_w, obter_perfil_ativo, nm_usuario_p, ie_prescricao_w, ds_erro_w);
CALL gerar_lanc_auto_prescricao(nr_prescricao_w, nm_usuario_p);
CALL Executar_Material_Lib_Prescr(nr_prescricao_w,nm_usuario_p, 'S', 'S');
--Gerar_prescr_mat_hor(nr_prescricao_w,NULL,obter_perfil_ativo,nm_usuario_p); 
/*if	(ie_liberar_para_agend_w = 'S') then 
	qt_liberar_para_agendamento(nr_seq_atendimento_p,'D','L',nm_usuario_p,cd_estabelecimento_p); 
end if;*/
 
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_prescr_onc ( nr_prescricao_p bigint, nr_seq_atendimento_p bigint, cd_estabelecimento_p bigint, ds_erro_p text, nm_usuario_p text) FROM PUBLIC;

