-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_ptu_nota_fiscal ( nr_seq_cobranca_p ptu_nota_cobranca.nr_sequencia%type, nr_seq_ptu_fatura_p ptu_fatura.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_seq_pls_fatura_w	pls_fatura.nr_sequencia%type;
nr_seq_ptu_fatura_w	ptu_fatura.nr_sequencia%type := nr_seq_ptu_fatura_p;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
nr_nota_fiscal_w	ptu_nota_fiscal.nr_nota_fiscal%type;
ds_link_nfe_w		ptu_nota_fiscal.ds_link_nfe%type;
nr_nota_fiscal_doc2_w	ptu_nota_fiscal.nr_nota_fiscal_doc2%type;
ds_link_nfe_doc2_w	ptu_nota_fiscal.ds_link_nfe_doc2%type;
tp_documento_1_w	ptu_fatura.tp_documento_1%type;
tp_documento_2_w	ptu_fatura.tp_documento_2%type;


BEGIN
-- se não foi informado a fatura, tenta levantar ela pela cobranca
if (coalesce(nr_seq_ptu_fatura_p::text, '') = '') then
	select	max(a.nr_seq_fatura)
	into STRICT	nr_seq_ptu_fatura_w
	from	ptu_nota_cobranca	a
	where	a.nr_sequencia		= nr_seq_cobranca_p;
end if;

-- Pegando a PLS_FATURA
select	max(t.nr_seq_pls_fatura),
	max(t.cd_estabelecimento),
	max(t.tp_documento_1),
	max(t.tp_documento_2)
into STRICT	nr_seq_pls_fatura_w,
	cd_estabelecimento_w,
	tp_documento_1_w,
	tp_documento_2_w
from (	SELECT	f.nr_seq_pls_fatura,
		f.cd_estabelecimento,
		f.tp_documento_1,
		f.tp_documento_2
	from	ptu_nota_cobranca	nc,
		ptu_fatura		f
	where	nc.nr_sequencia		= nr_seq_cobranca_p
	and	f.nr_sequencia		= nc.nr_seq_fatura
	
union all

	SELECT	f.nr_seq_pls_fatura,
		f.cd_estabelecimento,
		f.tp_documento_1,
		f.tp_documento_2
	from	ptu_fatura		f
	where	f.nr_sequencia		= nr_seq_ptu_fatura_w
	and	coalesce(nr_seq_cobranca_p::text, '') = '') t;

if (nr_seq_pls_fatura_w IS NOT NULL AND nr_seq_pls_fatura_w::text <> '') then
	-- Dados da nota fiscal DOC 1
	select	substr(max(nr_nfe_imp),1,20),
		substr(trim(both max(ds_link_rps)),1,255)
	into STRICT	nr_nota_fiscal_w,
		ds_link_nfe_w
	from	nota_fiscal
	where	nr_seq_fatura = nr_seq_pls_fatura_w
	and	(nr_nfe_imp IS NOT NULL AND nr_nfe_imp::text <> '');

	-- Dados da nota fiscal DOC 2
	select	substr(max(nr_nfe_imp),1,20),
		substr(trim(both max(ds_link_rps)),1,255)
	into STRICT	nr_nota_fiscal_doc2_w,
		ds_link_nfe_doc2_w
	from	nota_fiscal
	where	nr_seq_fatura_ndc = nr_seq_pls_fatura_w
	and	(nr_nfe_imp IS NOT NULL AND nr_nfe_imp::text <> '')
	and	(ds_link_rps IS NOT NULL AND ds_link_rps::text <> '');

	if (coalesce(ds_link_nfe_w::text, '') = '') then
		-- Passar espaço em branco para retornar o link padrão
		ds_link_nfe_w := pls_obter_convervao_ptu_a500('DS_LINK_NFE', ' ', ds_link_nfe_w, cd_estabelecimento_w);

		-- Se realmente não tiver link, limpar o número da nota fiscal eletronica
		if (coalesce(trim(both ds_link_nfe_w)::text, '') = '') then
			nr_nota_fiscal_w := null;
		end if;
	end if;
end if;

-- Inserir nota fiscal
if (nr_nota_fiscal_w IS NOT NULL AND nr_nota_fiscal_w::text <> '') or (nr_nota_fiscal_doc2_w IS NOT NULL AND nr_nota_fiscal_doc2_w::text <> '') then
	insert into ptu_nota_fiscal(nr_sequencia,			nr_seq_nota_cobr,		ds_link_nfe,
		dt_atualizacao,			nm_usuario,			dt_atualizacao_nrec,
		nm_usuario_nrec,		nr_nota_fiscal,			nr_seq_fatura,
		nr_nota_fiscal_doc2,		ds_link_nfe_doc2)
	values (nextval('ptu_nota_fiscal_seq'),	nr_seq_cobranca_p,		ds_link_nfe_w,
		clock_timestamp(),			nm_usuario_p,			clock_timestamp(),
		nm_usuario_p,			nr_nota_fiscal_w,		nr_seq_ptu_fatura_w,
		nr_nota_fiscal_doc2_w,		ds_link_nfe_doc2_w);

	if (coalesce(tp_documento_1_w,'1') != '4') and (nr_nota_fiscal_w IS NOT NULL AND nr_nota_fiscal_w::text <> '') then
		-- Se tem informação de nota, tem que enviar como tipo de documento nota fiscal
		update	ptu_fatura
		set	tp_documento_1	= '3'
		where	nr_sequencia	= nr_seq_ptu_fatura_w;
	end if;

	if (coalesce(tp_documento_2_w,'1') != '4') and (nr_nota_fiscal_doc2_w IS NOT NULL AND nr_nota_fiscal_doc2_w::text <> '') then
		-- Se tem informação de nota, tem que enviar como tipo de documento nota fiscal
		update	ptu_fatura
		set	tp_documento_2	= '3'
		where	nr_sequencia	= nr_seq_ptu_fatura_w;
	end if;
end if;

-- Se for fatura de NDC, não pode ter nota fiscal
if (tp_documento_1_w = '4') or (tp_documento_2_w = '4') then
	delete	FROM ptu_nota_fiscal
	where	nr_seq_fatura = nr_seq_ptu_fatura_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_ptu_nota_fiscal ( nr_seq_cobranca_p ptu_nota_cobranca.nr_sequencia%type, nr_seq_ptu_fatura_p ptu_fatura.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

