-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_rel_materiais ( nm_usuario_p text, cd_estab_p bigint, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, cd_unidade_medida_consumo_p text, cd_tipo_material_p bigint, cd_familia_p bigint, cd_armazenamento_p bigint, cd_conta_estoque_p bigint, cd_conta_despesa_p bigint, ie_prescricao_p text, ie_ressup_p text, ie_padronizado_p text, cd_tipo_material_mults_p text, cd_grupo_material_mults_p text, cd_subgrupo_material_mults_p text, cd_classe_material_mults_p text, cd_material_p text, cd_unidade_med_compra_p text, cd_unidade_med_estoque_p text, cd_unidade_med_consumo_p text, cd_familia_material_p text, ie_tipo_relatorio_p bigint, ie_cod_sist_ant_p text, ie_quebra_desc_mat_p text, ie_preco_simpro_p text, ie_desc_reduzida_p text, ie_estoque_controlado_p text, ie_consignado_p bigint, ie_situacao_p text, ie_baixa_estoque_pac_p text, ie_padronizacao_p text, dt_inicio_padronizacao_p timestamp, dt_fim_padronizacao_p timestamp, ie_multidose_p text, ie_embalagem_multipla_p text, ie_manipulados_p text, ie_mate_estab_selec_p text, cd_local_estoque_p bigint, cd_criterio_p bigint, ie_curva_abc_p text, ie_curva_xyz_p text, cd_local_saldo_estoque_p bigint, dt_mesano_ref_p timestamp, cd_estabelecimento_p bigint) AS $body$
DECLARE


C01				integer;
resultado			integer;

cd_material_w			integer;

ds_select_w			varchar(4000);

ds_where_w			varchar(4000);

cd_estab_proc_w			estabelecimento.cd_estabelecimento%type;
dt_mesano_referencia_w		varchar(25);

cd_conta_receita_w		varchar(20);
cd_conta_estoque_w 		varchar(20);
cd_conta_passag_direta_w	varchar(20);
cd_centro_custo_w		double precision;
cd_local_estoque_w		double precision;
cd_material_generico_w		integer;
vl_preco_medicamento_w		double precision;


BEGIN

delete from w_rel_material where nm_usuario = nm_usuario_p;
commit;

cd_estab_proc_w := coalesce(cd_estab_p, coalesce(cd_estabelecimento_p, wheb_usuario_pck.get_cd_estabelecimento));

if (dt_mesano_ref_p IS NOT NULL AND dt_mesano_ref_p::text <> '') then
		dt_mesano_referencia_w := to_char(dt_mesano_ref_p,'dd/mm/yyyy');
else
	dt_mesano_referencia_w := to_char(trunc(clock_timestamp(),'mm'),'dd/mm/yyyy');
end if;

ds_select_w :=	' select	a.cd_material'||
		' from	material a,'||
		' classe_material b,'||
		' subgrupo_material c,'||
		' grupo_material d';

ds_where_w :=	' where c.cd_grupo_material = d.cd_grupo_material'||
		' and b.cd_subgrupo_material = c.cd_subgrupo_material'||
		' and a.cd_classe_material = b.cd_classe_material';

if (ie_situacao_p <> 'O') then
	ds_where_w := ds_where_w || ' and a.ie_situacao = '||chr(39)||ie_situacao_p|| chr(39);
end if;

if (ie_padronizacao_p <> 'N') then		/*RadioGroup*/
	ds_where_w := ds_where_w ||' and exists (select  1'
				||' from material_log_alteracao y'
				||' where y.cd_material = a.cd_material'
				||' and y.dt_atualizacao between to_date('||chr(39)||to_char(dt_inicio_padronizacao_p,'dd/mm/yyyy')||chr(39)||') and to_date('||chr(39)||to_char(dt_fim_padronizacao_p,'dd/mm/yyyy')||chr(39)||') '
				||' and y.nm_tabela = '||chr(39)||'MATERIAL_ESTAB'||chr(39)
				||' and y.nm_atributo = '||chr(39)||'IE_PADRONIZADO'||chr(39);
	if (ie_padronizacao_p = 'P') then	/*RadioGroup*/
		ds_where_w := ds_where_w||' and y.ds_valor_ant = '||chr(39)||'N'||chr(39)
					||' and y.ds_valor_novo = '||chr(39)||'S'||chr(39)
					||')';
	elsif (ie_padronizacao_p = 'D') then	/*RadioGroup*/
		ds_where_w := ds_where_w||' and y.ds_valor_ant = '||chr(39)||'S'||chr(39)
					||' and y.ds_valor_novo = '||chr(39)||'N'||chr(39)
					||')';
	end if;
end if;

if (ie_manipulados_p = 'S') then		/*CheckBox*/
	ds_where_w := ds_where_w ||' and a.ie_manipulado = ' || chr(39) ||'S'|| chr(39);
end if;

if (ie_multidose_p = 'S') then		/*CheckBox*/
	ds_where_w := ds_where_w ||' and a.ie_multidose = '|| chr(39) ||'S'|| chr(39);
end if;

if (ie_embalagem_multipla_p = 'S') then	/*CheckBox*/
	ds_where_w := ds_where_w ||' and a.ie_embalagem_multipla = '|| chr(39) ||'S'|| chr(39);
end if;

if (ie_padronizado_p IS NOT NULL AND ie_padronizado_p::text <> '') then	/*lookup*/
	ds_where_w := ds_where_w ||' and substr(obter_se_material_padronizado('||cd_estab_proc_w||', a.cd_material),1,1) = '||chr(39)||ie_padronizado_p||chr(39);
end if;

if (ie_prescricao_p IS NOT NULL AND ie_prescricao_p::text <> '') then	/*lookup*/
	ds_where_w := ds_where_w ||' and substr(obter_se_material_prescricao('||cd_estab_proc_w||' , a.cd_material),1,1) = '||chr(39)||ie_prescricao_p||chr(39);
end if;

if (ie_ressup_p IS NOT NULL AND ie_ressup_p::text <> '') then		/*lookup*/
	ds_where_w := ds_where_w ||' and substr(obter_se_mat_ressuprimento('||cd_estab_proc_w||', a.cd_material),1,1) = '||chr(39)||ie_ressup_p||chr(39);
end if;

if (cd_grupo_material_p IS NOT NULL AND cd_grupo_material_p::text <> '') then	/*lookup*/
	ds_where_w := ds_where_w ||' and c.cd_grupo_material = '||cd_grupo_material_p;
end if;

if (cd_subgrupo_material_p IS NOT NULL AND cd_subgrupo_material_p::text <> '') then	/*lookup*/
	ds_where_w := ds_where_w ||' and c.cd_subgrupo_material = '||cd_subgrupo_material_p;
end if;

if (cd_classe_material_p IS NOT NULL AND cd_classe_material_p::text <> '') then	/*lookup*/
	ds_where_w := ds_where_w ||' and b.cd_classe_material = '||cd_classe_material_p;
end if;

if (cd_unidade_medida_consumo_p IS NOT NULL AND cd_unidade_medida_consumo_p::text <> '') then	/*lookup*/
	ds_where_w := ds_where_w ||' and a.cd_unidade_medida_consumo like '||chr(39)||cd_unidade_medida_consumo_p||chr(39);
end if;

if (cd_tipo_material_p IS NOT NULL AND cd_tipo_material_p::text <> '') then	/*Lookup*/
	ds_where_w := ds_where_w ||' and a.ie_tipo_material like ' ||cd_tipo_material_p;
end if;

if (cd_familia_p IS NOT NULL AND cd_familia_p::text <> '') then		/*Lookup*/
	ds_where_w := ds_where_w ||' and a.nr_seq_familia = '||cd_familia_p;
end if;

/* Parâmetros Multiseleção início */

if (cd_tipo_material_mults_p IS NOT NULL AND cd_tipo_material_mults_p::text <> '') then
	if (substr(cd_tipo_material_mults_p,1,1) = '-') then
		ds_where_w := ds_where_w ||' and obter_se_contido_char(d.cd_grupo_material, '||chr(39)||substr(cd_tipo_material_mults_p, 2, length(cd_tipo_material_mults_p))||chr(39)||') = '||chr(39)||'N'||chr(39);
	else
		ds_where_w := ds_where_w ||' and obter_se_contido_char(d.cd_grupo_material, '||chr(39)||cd_tipo_material_mults_p||chr(39)||') = '||chr(39)||'S'||chr(39);
	end if;
end if;

if (cd_grupo_material_mults_p IS NOT NULL AND cd_grupo_material_mults_p::text <> '') then
	if (substr(cd_grupo_material_mults_p,1,1) = '-') then
		ds_where_w := ds_where_w ||' and obter_se_contido_char(d.cd_grupo_material, '||chr(39)||substr(cd_grupo_material_mults_p, 2, length(cd_grupo_material_mults_p))||chr(39)||') = '||chr(39)||'N'||chr(39);
	else
		ds_where_w := ds_where_w ||' and obter_se_contido_char(d.cd_grupo_material, '||chr(39)||cd_grupo_material_mults_p||chr(39)||') = '||chr(39)||'S'||chr(39);
	end if;
end if;

if (cd_subgrupo_material_mults_p IS NOT NULL AND cd_subgrupo_material_mults_p::text <> '') then
	if (substr(cd_subgrupo_material_mults_p,1,1) = '-') then
		ds_where_w := ds_where_w ||' and obter_se_contido_char(c.cd_subgrupo_material, '||chr(39)||substr(cd_subgrupo_material_mults_p, 2, length(cd_subgrupo_material_mults_p))||chr(39)||') = '||chr(39)||'N'||chr(39);
	else
		ds_where_w := ds_where_w ||' and obter_se_contido_char(c.cd_subgrupo_material, '||chr(39)||cd_subgrupo_material_mults_p||chr(39)||') = '||chr(39)||'S'||chr(39);
	end if;
end if;

if (cd_classe_material_mults_p IS NOT NULL AND cd_classe_material_mults_p::text <> '') then
	if (substr(cd_classe_material_mults_p,1,1) = '-') then
		ds_where_w := ds_where_w ||' and obter_se_contido_char(b.cd_classe_material, '||chr(39)||substr(cd_classe_material_mults_p, 2, length(cd_classe_material_mults_p))||chr(39)||') = '||chr(39)||'N'||chr(39);
	else
		ds_where_w := ds_where_w ||' and obter_se_contido_char(b.cd_classe_material, '||chr(39)||cd_classe_material_mults_p||chr(39)||') = '||chr(39)||'S'||chr(39);
	end if;
end if;

if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then
	if (substr(cd_material_p,1,1) = '-') then
		ds_where_w := ds_where_w ||' and obter_se_contido_char(a.cd_material, '||chr(39)||substr(cd_material_p, 2, length(cd_material_p))||chr(39)||') = '||chr(39)||'N'||chr(39);
	else
		ds_where_w := ds_where_w ||' and obter_se_contido_char(a.cd_material, '||chr(39)||cd_material_p||chr(39)||') = '||chr(39)||'S'||chr(39);
	end if;
end if;

if (cd_unidade_med_compra_p IS NOT NULL AND cd_unidade_med_compra_p::text <> '') then
	if (substr(cd_unidade_med_compra_p,1,1) = '-') then
		ds_where_w := ds_where_w ||' and obter_se_contido_char(cd_unidade_medida_compra, '||chr(39)||substr(cd_unidade_med_compra_p, 2, length(cd_unidade_med_compra_p))||chr(39)||') = '||chr(39)||'N'||chr(39);
	else
		ds_where_w := ds_where_w ||' and obter_se_contido_char(cd_unidade_medida_compra, '||chr(39)||cd_unidade_med_compra_p||chr(39)||') = '||chr(39)||'S'||chr(39);
	end if;
end if;

if (cd_unidade_med_estoque_p IS NOT NULL AND cd_unidade_med_estoque_p::text <> '') then
	if (substr(cd_unidade_med_estoque_p,1,1) = '-') then
		ds_where_w := ds_where_w ||' and obter_se_contido_char(cd_unidade_medida_estoque, '||chr(39)||substr(cd_unidade_med_estoque_p, 2, length(cd_unidade_med_estoque_p))||chr(39)||') = '||chr(39)||'N'||chr(39);
	else
		ds_where_w := ds_where_w ||' and obter_se_contido_char(cd_unidade_medida_estoque, '||chr(39)||cd_unidade_med_estoque_p||chr(39)||') = '||chr(39)||'S'||chr(39);
	end if;
end if;

if (cd_unidade_med_consumo_p IS NOT NULL AND cd_unidade_med_consumo_p::text <> '') then
	if (substr(cd_unidade_med_consumo_p,1,1) = '-') then
		ds_where_w := ds_where_w ||' and obter_se_contido_char(cd_unidade_medida_consumo, '||chr(39)||substr(cd_unidade_med_consumo_p, 2, length(cd_unidade_med_consumo_p))||chr(39)||') = '||chr(39)||'N'||chr(39);
	else
		ds_where_w := ds_where_w ||' and obter_se_contido_char(cd_unidade_medida_consumo, '||chr(39)||cd_unidade_med_consumo_p||chr(39)||') = '||chr(39)||'S'||chr(39);
	end if;
end if;

if (cd_familia_material_p IS NOT NULL AND cd_familia_material_p::text <> '') then
	if (substr(cd_familia_material_p,1,1) = '-') then
		ds_where_w := ds_where_w ||' and obter_se_contido_char(cd_unidade_medida_consumo, '||chr(39)||substr(cd_familia_material_p, 2, length(cd_familia_material_p))||chr(39)||') = '||chr(39)||'N'||chr(39);
	else
		ds_where_w := ds_where_w ||' and obter_se_contido_char(cd_unidade_medida_consumo, '||chr(39)||cd_familia_material_p||chr(39)||') = '||chr(39)||'S'||chr(39);
	end if;
end if;

/* Parâmetros Multiseleção fim */

if (ie_baixa_estoque_pac_p <> 'A') then	/*RadioGroup*/
	ds_where_w := ds_where_w ||' and substr(obter_material_baixa_estoq_pac('||cd_estab_proc_w||', 0, a.cd_material),1,1) =  '||chr(39)|| ie_baixa_estoque_pac_p||chr(39);
end if;

if (ie_estoque_controlado_p <> 'A') then	/*RadioGroup*/
	ds_where_w := ds_where_w ||' and obter_se_material_estoque('||cd_estab_proc_w||',null, a.cd_material) = '||chr(39)||ie_estoque_controlado_p||chr(39);
end if;

if (ie_mate_estab_selec_p = 'S') then	/*CheckBox*/
	ds_where_w := ds_where_w ||' and exists( select 1 from material_estab x where x.cd_material = a.cd_material and x.cd_estabelecimento = '||cd_estab_proc_w||')';
end if;

if (cd_armazenamento_p IS NOT NULL AND cd_armazenamento_p::text <> '') then	/*Lookup*/
	ds_where_w := ds_where_w ||' and exists( select 1 from material_armazenamento m '
				||' where a.cd_material = m.cd_material '
				||' and m.nr_seq_forma = '||cd_armazenamento_p
				||' and nvl(m.cd_estabelecimento, '||cd_estab_proc_w||') = '||cd_estab_proc_w||')';
end if;

if (cd_local_estoque_p IS NOT NULL AND cd_local_estoque_p::text <> '') then	/*Lookup*/
/*	ds_select_w := ds_select_w ||', obter_localizacao_material(a.cd_material, '||cd_local_estoque_p||') ds_localizacao';*/

	ds_where_w := ds_where_w ||' and exists (select e.cd_material '
				||' from padrao_estoque_local e '
				||' where a.cd_material = e.cd_material '
				||' and e.cd_local_estoque = '||cd_local_estoque_p
				||' and e.cd_estabelecimento = '||cd_estab_proc_w;
	if (cd_criterio_p IS NOT NULL AND cd_criterio_p::text <> '') then 	/*Lookup*/
		ds_where_w := ds_where_w ||' and e.nr_seq_contagem = '||cd_criterio_p;
		/*tem que fazer um tratamento dentro do gerenciador para exibir uma banda que trará a descrição do invetário se e somente se este lookup não estiver nulo*/

	end if;
	ds_where_w := ds_where_w ||')';

end if;

if (ie_consignado_p < 3) then		/*RadioGroup*/
	ds_where_w := ds_where_w ||' and ie_consignado = '||ie_consignado_p;
end if;

if (cd_local_saldo_estoque_p IS NOT NULL AND cd_local_saldo_estoque_p::text <> '') and	/*Lookup*/
	(dt_mesano_ref_p IS NOT NULL AND dt_mesano_ref_p::text <> '') then		/*Lookup*/
	ds_where_w := ds_where_w ||' and exists (select f.cd_material '
				||' from saldo_estoque f '
				||' where a.cd_material = f.cd_material '
				||' and f.cd_local_estoque = '||cd_local_saldo_estoque_p
				||' and f.dt_mesano_referencia = '||chr(39)||dt_mesano_ref_p||chr(39)
				||' and f.cd_estabelecimento = '||cd_estab_proc_w||')';
end if;

if (ie_curva_abc_p <> 'T') then		/*RadioGroup*/
	ds_where_w := ds_where_w||' and obter_curva_abc(a.cd_material, null, '||dt_mesano_referencia_w||') = '||ie_curva_abc_p;
end if;

if (ie_curva_xyz_p <> 'T') then		/*RadioGroup*/
	ds_where_w := ds_where_w||' and obter_curva_xyz(a.cd_material, null, '||dt_mesano_referencia_w||') = '||ie_curva_xyz_p;
end if;

c01 := dbms_sql.open_cursor;

dbms_sql.parse(c01, ds_select_w||ds_where_w, dbms_sql.native);

dbms_sql.define_column(c01, 1, cd_material_w);

resultado := dbms_sql.execute(c01);

while(dbms_sql.fetch_rows(c01) > 0) loop
	begin

	dbms_sql.column_value(c01, 1, cd_material_w);

	insert into w_rel_material(cd_material,
				nm_usuario,
				ie_imprime)
			values (cd_material_w,
				nm_usuario_p,
				'S');

	SELECT * FROM define_todas_contas_material(cd_estab_proc_w, cd_material_w, cd_conta_receita_w, cd_conta_estoque_w, cd_conta_passag_direta_w, cd_centro_custo_w, cd_local_estoque_w) INTO STRICT cd_conta_receita_w, cd_conta_estoque_w, cd_conta_passag_direta_w, cd_centro_custo_w, cd_local_estoque_w;

	if (ie_tipo_relatorio_p = 4) then
		if (cd_conta_estoque_p IS NOT NULL AND cd_conta_estoque_p::text <> '') and (cd_conta_estoque_p <> cd_conta_estoque_w) then
			update	w_rel_material
			set 	ie_imprime = 'N'
			where	cd_material = cd_material_w;
		else
			update	w_rel_material
			set	cd_conta_estoque = cd_conta_estoque_w
			where	cd_material = cd_material_w;
		end if;

		if (cd_conta_despesa_p IS NOT NULL AND cd_conta_despesa_p::text <> '') and (cd_conta_despesa_p <> cd_conta_passag_direta_w) then
			update	w_rel_material
			set	ie_imprime = 'N'
			where	cd_material = cd_material_w;
		else
			update	w_rel_material
			set	cd_conta_despesa = cd_conta_passag_direta_w
			where	cd_material = cd_material_w;
		end if;

	end if;

	if (ie_tipo_relatorio_p = 3) then
		if (ie_preco_simpro_p = 'N') then
			begin

			select	b.vl_preco_medicamento
			into STRICT	vl_preco_medicamento_w
			from	material_brasindice m,
				brasindice_preco b
			where	m.cd_laboratorio = b.cd_laboratorio
			and	m.cd_medicamento = b.cd_medicamento
			and	m.cd_apresentacao = b.cd_apresentacao
			and	m.ie_prioridade = 1
			and	m.cd_material = cd_material_w
			and	b.dt_inicio_vigencia = (SELECT max(dt_inicio_vigencia)
							from	material_brasindice m,
								brasindice_preco b
							where	m.cd_laboratorio = b.cd_laboratorio
							and	m.cd_medicamento = b.cd_medicamento
							and	m.cd_apresentacao = b.cd_apresentacao
							and	m.ie_prioridade = 1
							and	m.cd_material = cd_material_w);

			exception
			when others then
				vl_preco_medicamento_w := null;
			end;
		else
			begin

			select	Obter_Simpro_Preco_mat(b.nr_sequencia, 1, 1, clock_timestamp())
			into STRICT	vl_preco_medicamento_w
			from	material_simpro b,
				simpro_preco a,
				simpro_cadastro c
			where	b.cd_material = cd_material_w
			and	b.cd_simpro = c.cd_simpro
			and	a.cd_simpro = c.cd_simpro
			and	a.cd_simpro = b.cd_simpro
			and	coalesce(a.cd_estabelecimento, cd_estab_proc_w) = cd_estab_proc_w
			and	a.dt_vigencia = (SELECT max(a.dt_vigencia)
						from	material_simpro b,
							simpro_preco a,
							simpro_cadastro c
						where	b.cd_material = cd_material_w
						and	b.cd_simpro = c.cd_simpro
						and	a.cd_simpro = c.cd_simpro
						and	a.cd_simpro = b.cd_simpro
						and	coalesce(a.cd_estabelecimento, cd_estab_proc_w) = cd_estab_proc_w);

			exception
			when others then
				vl_preco_medicamento_w := null;
			end;
		end if;
		if (vl_preco_medicamento_w IS NOT NULL AND vl_preco_medicamento_w::text <> '') then
			update	w_rel_material
			set	vl_preco_medicamento = vl_preco_medicamento_w
			where	cd_material = cd_material_w;
		end if;
	end if;

	end;
end loop;
dbms_sql.close_cursor(c01);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_rel_materiais ( nm_usuario_p text, cd_estab_p bigint, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, cd_unidade_medida_consumo_p text, cd_tipo_material_p bigint, cd_familia_p bigint, cd_armazenamento_p bigint, cd_conta_estoque_p bigint, cd_conta_despesa_p bigint, ie_prescricao_p text, ie_ressup_p text, ie_padronizado_p text, cd_tipo_material_mults_p text, cd_grupo_material_mults_p text, cd_subgrupo_material_mults_p text, cd_classe_material_mults_p text, cd_material_p text, cd_unidade_med_compra_p text, cd_unidade_med_estoque_p text, cd_unidade_med_consumo_p text, cd_familia_material_p text, ie_tipo_relatorio_p bigint, ie_cod_sist_ant_p text, ie_quebra_desc_mat_p text, ie_preco_simpro_p text, ie_desc_reduzida_p text, ie_estoque_controlado_p text, ie_consignado_p bigint, ie_situacao_p text, ie_baixa_estoque_pac_p text, ie_padronizacao_p text, dt_inicio_padronizacao_p timestamp, dt_fim_padronizacao_p timestamp, ie_multidose_p text, ie_embalagem_multipla_p text, ie_manipulados_p text, ie_mate_estab_selec_p text, cd_local_estoque_p bigint, cd_criterio_p bigint, ie_curva_abc_p text, ie_curva_xyz_p text, cd_local_saldo_estoque_p bigint, dt_mesano_ref_p timestamp, cd_estabelecimento_p bigint) FROM PUBLIC;

