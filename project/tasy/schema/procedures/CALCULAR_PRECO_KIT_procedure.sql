-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_preco_kit ( CD_ESTABELECIMENTO_P bigint, CD_CONVENIO_P bigint, CD_CATEGORIA_P text, DT_CONTA_P timestamp, CD_PROCEDIMENTO_P bigint, CD_TIPO_ACOMODACAO_P bigint, QT_IDADE_P bigint, NR_SEQUENCIA_P bigint, IE_TIPO_ATENDIMENTO_P bigint, CD_SETOR_ATENDIMENTO_P bigint, IE_TIPO_ITEM_P bigint, CD_CGC_FORNECEDOR_P text, vl_kit_w INOUT bigint, ie_tipo_convenio_p bigint default null) AS $body$
DECLARE


cd_material_w		bigint;
qt_material_w		bigint;
vl_kit_ww		double precision;
dt_ult_vigencia_w	timestamp;
cd_tab_preco_mat_w	smallint;
ie_origem_preco_w	smallint;
vl_material_w		double precision;
nr_seq_bras_preco_w	bigint;
nr_seq_mat_bras_w	bigint;
nr_seq_conv_bras_w	bigint;
nr_seq_conv_simpro_w	bigint;
nr_seq_mat_simpro_w	bigint;
nr_seq_simpro_preco_w	bigint;
nr_seq_ajuse_mat_w	bigint;
ie_tipo_convenio_w convenio.ie_tipo_convenio%type;

C01 CURSOR FOR
	SELECT 	a.cd_material,
		a.qt_material
	from 	componente_kit a, 
		procedimento b
	where 	a.cd_kit_material = b.cd_kit_material
	and   	coalesce(a.ie_situacao,'A') = 'A'
	and   	coalesce(a.ie_calcula_preco,'S') = 'S'
	and   	b.cd_procedimento = CD_PROCEDIMENTO_P
	and	coalesce(a.cd_convenio, coalesce(cd_convenio_p,0)) = coalesce(cd_convenio_p,0)
	and 	coalesce(a.ie_tipo_convenio, ie_tipo_convenio_w,0) = coalesce(ie_tipo_convenio_w,0)
	and	((coalesce(a.cd_estab_regra::text, '') = '') or (a.cd_estab_regra = cd_estabelecimento_p));


BEGIN

vl_kit_ww:= 0;

if (IE_TIPO_ITEM_P in (0,1)) then
	begin
	if (coalesce(ie_tipo_convenio_p,0) > 0) then
		ie_tipo_convenio_w := ie_tipo_convenio_p;
	else
		select 	obter_tipo_convenio(cd_convenio_p)
		into STRICT	ie_tipo_convenio_w
		;
	end if;
	
	OPEN C01;
	LOOP
		FETCH C01 into
			cd_material_w,
			qt_material_w;	
		EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
        	SELECT * FROM define_preco_material(CD_ESTABELECIMENTO_P, CD_CONVENIO_P, CD_CATEGORIA_P, DT_CONTA_P, cd_material_w, CD_TIPO_ACOMODACAO_P, IE_TIPO_ATENDIMENTO_P, CD_SETOR_ATENDIMENTO_P, CD_CGC_FORNECEDOR_P, QT_IDADE_P, NR_SEQUENCIA_P, null, null, null, null, null, null, null, null, vl_material_w, dt_ult_vigencia_w, cd_tab_preco_mat_w, ie_origem_preco_w, nr_seq_bras_preco_w, nr_seq_mat_bras_w, nr_seq_conv_bras_w, nr_seq_conv_simpro_w, nr_seq_mat_simpro_w, nr_seq_simpro_preco_w, nr_seq_ajuse_mat_w) INTO STRICT vl_material_w, dt_ult_vigencia_w, cd_tab_preco_mat_w, ie_origem_preco_w, nr_seq_bras_preco_w, nr_seq_mat_bras_w, nr_seq_conv_bras_w, nr_seq_conv_simpro_w, nr_seq_mat_simpro_w, nr_seq_simpro_preco_w, nr_seq_ajuse_mat_w;
		vl_kit_ww:= vl_kit_ww + (qt_material_w * vl_material_w);
		end;
	END LOOP;
	CLOSE C01;
	end;
end if;

vl_kit_w:= vl_kit_ww;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_preco_kit ( CD_ESTABELECIMENTO_P bigint, CD_CONVENIO_P bigint, CD_CATEGORIA_P text, DT_CONTA_P timestamp, CD_PROCEDIMENTO_P bigint, CD_TIPO_ACOMODACAO_P bigint, QT_IDADE_P bigint, NR_SEQUENCIA_P bigint, IE_TIPO_ATENDIMENTO_P bigint, CD_SETOR_ATENDIMENTO_P bigint, IE_TIPO_ITEM_P bigint, CD_CGC_FORNECEDOR_P text, vl_kit_w INOUT bigint, ie_tipo_convenio_p bigint default null) FROM PUBLIC;

