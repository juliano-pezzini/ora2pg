-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_ci_recomendacao ( nr_prescricao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_titulo_w				varchar(255);
nm_paciente_w			varchar(255);
nm_medico_w				varchar(255);
nm_usuario_destino_w	varchar(255);
ds_comunicado_w			varchar(4000);
ds_comunic_w			varchar(4000);
ds_material_w			varchar(4000);
ds_justificativa_w		varchar(4000);
cd_perfil_destino_w		varchar(4000);
ds_lista_usuario_destino_w varchar(4000);
ie_somente_padrao_w		varchar(1);
cd_mat_w				bigint;
cd_setor_w				bigint;
cd_perfil_w				varchar(1000);
nr_sequencia_w			bigint;
nr_sequencia_ww			bigint;
cd_grupo_material_w		integer;
cd_subgrupo_material_w	integer;
cd_classe_material_w	integer;
nr_seq_comunic_w		bigint;
nr_min_prescr_w			bigint;
cd_material_w			bigint;
nr_atendimento_w		bigint;
ds_recomendacao_w		varchar(1000);
ds_rec_w				varchar(2000);
cd_intervalo_w			varchar(255);
ds_intervalo_W			varchar(255);
ds_setor_w				varchar(200);
hr_prim_horario_w		varchar(100);
ds_horarios_w			varchar(1000);
ds_unidade_w			varchar(255);
cd_tipo_recomendacao_w	bigint;
dt_prescricao_w			timestamp;
dt_liberacao_w			timestamp;
ie_enviar_executor_w	varchar(1);
cd_pessoa_fisica_w		varchar(15);
cd_medic_resp_atend_w	varchar(15);

c01 CURSOR FOR
SELECT	a.ds_titulo,
		a.cd_tipo_recomendacao,
		a.nr_sequencia,
		coalesce(a.ie_enviar_prescritor,'S')
from	rep_envio_ci_padrao_rec a
where	((cd_pessoa_fisica = cd_medic_resp_atend_w) or (coalesce(cd_pessoa_fisica::text, '') = ''))
and		coalesce(a.ie_situacao,'A') = 'A';

c02 CURSOR FOR
SELECT	b.cd_perfil,
		b.cd_pessoa_fisica
from	rep_envio_ci_perfil_rec b
where	b.nr_seq_regra	= nr_sequencia_ww;

c14 CURSOR FOR
SELECT	substr(Obter_desc_tipo_recomendacao(cd_recomendacao),1,80),
		substr(coalesce(OBTER_DESC_INTERVALO_PRESCR(a.cd_intervalo), OBTER_DESC_INTERVALO(a.cd_intervalo)),1,255),
		a.hr_prim_horario,
		substr(a.ds_horarios,1,255),
		substr(coalesce(obter_desc_intervalo_prescr(a.cd_intervalo), obter_desc_intervalo(a.cd_intervalo)),1,80),
		substr(a.ds_recomendacao,1,255),
		b.cd_prescritor
from	prescr_recomendacao a,
		prescr_medica b
where	a.cd_recomendacao	= cd_tipo_recomendacao_w
and		a.nr_prescricao	= b.nr_prescricao
and		b.nr_prescricao = nr_prescricao_p;


BEGIN

select	min(nr_sequencia)
into STRICT	nr_sequencia_w
from	comunic_interna_classif
where	ie_tipo	= 'F';

select	max(obter_nome_pf_pj(cd_pessoa_fisica,null)),
		max(obter_nome_pf_pj(cd_prescritor,null)),
		max(cd_setor_atendimento),
		max(nr_atendimento),
		max(obter_nome_setor(cd_setor_atendimento)),
		max(dt_prescricao),
		max(dt_liberacao),
		max(obter_unidade_atendimento(nr_atendimento,'A','U'))
into STRICT	nm_paciente_w,
		nm_medico_w,
		cd_setor_w,
		nr_atendimento_w,
		ds_setor_w,
		dt_prescricao_w,
		dt_liberacao_w,
		ds_unidade_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

cd_medic_resp_atend_w	:= Obter_medico_resp_atend(nr_atendimento_w, 'C');

open C01;
loop
fetch C01 into
	ds_titulo_w,
	cd_tipo_recomendacao_w,
	nr_sequencia_ww,
	ie_enviar_executor_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	ds_comunicado_w := null;

	open C14;
	loop
	fetch C14 into
		ds_recomendacao_w,
		cd_intervalo_w,
		hr_prim_horario_w,
		ds_horarios_w,
		ds_intervalo_w,
		ds_rec_w,
		cd_pessoa_fisica_w;
	EXIT WHEN NOT FOUND; /* apply on C14 */
		if (ds_comunicado_w IS NOT NULL AND ds_comunicado_w::text <> '') then
			ds_comunicado_w	:= ds_comunicado_w || chr(13) || chr(13) || ds_recomendacao_w;
		else
			ds_comunicado_w	:= chr(13) || ds_recomendacao_w;
		end if;

		if (ds_intervalo_w IS NOT NULL AND ds_intervalo_w::text <> '') then
      --Intervalo
			ds_comunicado_w := ds_comunicado_w || chr(13) || obter_desc_expressao(292190)||': ' || ds_intervalo_w;
		end if;

		if (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') then
      --1º horário
			ds_comunicado_w := ds_comunicado_w || chr(13) || obter_desc_expressao(302363)||': ' || hr_prim_horario_w;
		end if;

		if (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then
      --Horários
			ds_comunicado_w := ds_comunicado_w || chr(13) || obter_desc_expressao(291449)||': ' || ds_horarios_w;
		end if;

		if (ds_rec_w IS NOT NULL AND ds_rec_w::text <> '') then
      --Complemento
			ds_comunicado_w := ds_comunicado_w || chr(13) || obter_desc_expressao(650866)||': ' || ds_rec_w;
		end if;

		if (ie_enviar_executor_w = 'S') and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
			select	max(nm_usuario)
			into STRICT	nm_usuario_destino_w
			from	usuario
			where	cd_pessoa_fisica = cd_pessoa_fisica_w;

			if (ds_lista_usuario_destino_w IS NOT NULL AND ds_lista_usuario_destino_w::text <> '') then
				ds_lista_usuario_destino_w := substr(ds_lista_usuario_destino_w || ',',1,4000);
			end if;

			ds_lista_usuario_destino_w := substr(ds_lista_usuario_destino_w || nm_usuario_destino_w,1,4000);

		end if;

	end loop;
	close C14;

	if (ds_comunicado_w IS NOT NULL AND ds_comunicado_w::text <> '') then


		cd_perfil_w := null;

		open c02;
		loop
		fetch c02 into
			cd_perfil_destino_w,
			cd_pessoa_fisica_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */

			if (cd_perfil_destino_w IS NOT NULL AND cd_perfil_destino_w::text <> '') then
				if (cd_perfil_w IS NOT NULL AND cd_perfil_w::text <> '') or (cd_perfil_w <> '') then
					cd_perfil_w := cd_perfil_w || ',';
				end if;

				cd_perfil_w := substr(cd_perfil_w || cd_perfil_destino_w,1,1000);
			end if;

			if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
				select	max(nm_usuario)
				into STRICT	nm_usuario_destino_w
				from	usuario
				where	cd_pessoa_fisica = cd_pessoa_fisica_w;

				if (nm_usuario_destino_w IS NOT NULL AND nm_usuario_destino_w::text <> '') then
					if (ds_lista_usuario_destino_w IS NOT NULL AND ds_lista_usuario_destino_w::text <> '') or (ds_lista_usuario_destino_w <> '') then
						ds_lista_usuario_destino_w := substr(ds_lista_usuario_destino_w || ',',1,4000);
					end if;

					ds_lista_usuario_destino_w := substr(ds_lista_usuario_destino_w || nm_usuario_destino_w,1,4000);
				end if;
			end if;

		end loop;
		close c02;

		if (cd_perfil_w IS NOT NULL AND cd_perfil_w::text <> '') and (substr(cd_perfil_w,length(cd_perfil_w), 1) <> ',') then
			cd_perfil_w	:= cd_perfil_w || ',';
		end if;

		if (ds_lista_usuario_destino_w IS NOT NULL AND ds_lista_usuario_destino_w::text <> '') and (substr(ds_lista_usuario_destino_w,length(ds_lista_usuario_destino_w), 1) <> ',') then
			ds_lista_usuario_destino_w	:= substr(ds_lista_usuario_destino_w,1,3999) || ',';
		end if;

		ds_comunic_w	:=
              --Prescrição
              obter_desc_expressao(296208)||': '  || nr_prescricao_p || chr(13) || chr(10) ||
							--Atendimento
              obter_desc_expressao(283863)||': '  || nr_atendimento_w || chr(13) || chr(10) ||
							--Paciente
              obter_desc_expressao(295156)||': '	|| nm_paciente_w ||chr(13) || chr(10) ||
              --Setor
							obter_desc_expressao(696060)||': '	|| ds_setor_w || chr(13) || chr(10)||
							--Leito do paciente
              obter_desc_expressao(345228)||': '	|| ds_unidade_w || chr(13) || chr(10)||
							--Dt Prescrição
              obter_desc_expressao(335718)||': '	|| PKG_DATE_FORMATERS.TO_VARCHAR(dt_prescricao_w, 'timestamp', cd_estabelecimento_p, nm_usuario_p) || chr(13) || chr(10) ||
							--Dt Liberação
              obter_desc_expressao(287026)||': '	|| PKG_DATE_FORMATERS.TO_VARCHAR(dt_liberacao_w, 'timestamp', cd_estabelecimento_p, nm_usuario_p) || chr(13) || chr(10) ||
							--Prescritor
              obter_desc_expressao(296217)||': '	|| nm_medico_w || chr(13) || chr(10)|| chr(13);

		if (ds_titulo_w IS NOT NULL AND ds_titulo_w::text <> '') then

			select	nextval('comunic_interna_seq')
			into STRICT	nr_seq_comunic_w
			;

			insert	into comunic_interna(
					dt_comunicado,
					ds_titulo,
					ds_comunicado,
					nm_usuario,
					nm_usuario_destino,
					dt_atualizacao,
					ie_geral,
					ie_gerencial,
					ds_perfil_adicional,
					nr_sequencia,
					nr_seq_classif,
					dt_liberacao
			) values (
					clock_timestamp(),
					ds_titulo_w,
					ds_comunic_w || chr(13) || ds_comunicado_w,
					nm_usuario_p,
					ds_lista_usuario_destino_w,
					clock_timestamp(),
					'N',
					'N',
					cd_perfil_w,
					nr_seq_comunic_w,
					nr_sequencia_w,
					clock_timestamp());
			if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

			if (ie_enviar_executor_w = 'N') then
				insert into comunic_interna_lida
				values (	nr_seq_comunic_w,
					nm_usuario_p,
					clock_timestamp());
			end if;

			if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

		end if;
	end if;

end loop;
close C01;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_ci_recomendacao ( nr_prescricao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

