-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE medical_guidance_order_epc ( NR_ATENDIMENTO_P bigint, NR_SEQ_EXTER_REFER_P bigint, IE_ORI_EXTER_REFER_P bigint, NM_USUARIO_P text ) AS $body$
DECLARE

    NR_SEQ_CALCULATION_TYPE_W 	bigint;
    CD_PROCEDIMENTO_W       	bigint;
	DS_PROC_EXAME_W				varchar(100);
	DT_CALCULATION_TYPE_W       timestamp;
	CD_ESTABELECIMENTO_W    	bigint;
    CD_PESSOA_FISICA_W      	varchar(10);
    NR_SEQ_W                	bigint;
	
    TABLE_EXTER_REFER_W         varchar(30);

BEGIN
	IF (IE_ORI_EXTER_REFER_P = 1) THEN
        TABLE_EXTER_REFER_W := 'RL_REF_FROM_HOSPITAL';
    ELSIF (IE_ORI_EXTER_REFER_P = 2) THEN
        TABLE_EXTER_REFER_W := 'RL_REP_TO_HOSPITAL';
    ELSIF (IE_ORI_EXTER_REFER_P = 3) THEN
        TABLE_EXTER_REFER_W := 'RL_REF_TO_HOSPITAL';
	END IF;

	IF (NOT coalesce(TABLE_EXTER_REFER_W::text, '') = '') THEN
		BEGIN
			EXECUTE '
				SELECT
					A.NR_SEQ_CALCULATION_TYPE,
					PI.CD_PROCEDIMENTO,
					PI.DS_PROC_EXAME,
					A.DT_CALCULATION_TYPE
				FROM
					' || TABLE_EXTER_REFER_W || ' A INNER JOIN PROC_INTERNO PI ON (
					PI.NR_SEQUENCIA = A.NR_SEQ_CALCULATION_TYPE
				)
				WHERE
					A.NR_SEQUENCIA = ' || TO_CHAR(NR_SEQ_EXTER_REFER_P)
			INTO STRICT
				NR_SEQ_CALCULATION_TYPE_W,
				CD_PROCEDIMENTO_W,
				DS_PROC_EXAME_W,
				DT_CALCULATION_TYPE_W;
			EXCEPTION
			WHEN  no_data_found THEN
				NR_SEQ_CALCULATION_TYPE_W := null;
				CD_PROCEDIMENTO_W := 0;
				DS_PROC_EXAME_W := 0;
				DT_CALCULATION_TYPE_W := NULL;
		END;

		SELECT
			MAX(CD_PESSOA_FISICA),
			MAX(CD_ESTABELECIMENTO)
		INTO STRICT
			CD_PESSOA_FISICA_W,
			CD_ESTABELECIMENTO_W
		FROM
			ATENDIMENTO_PACIENTE
		WHERE
			NR_ATENDIMENTO = NR_ATENDIMENTO_P;

		SELECT
			nextval('medical_guidance_order_seq')
		INTO STRICT
			NR_SEQ_W
		;

		IF (NR_SEQ_CALCULATION_TYPE_W IS NOT NULL AND NR_SEQ_CALCULATION_TYPE_W::text <> '') THEN
			INSERT INTO MEDICAL_GUIDANCE_ORDER(
				NR_SEQUENCIA            ,
				CD_ESTABELECIMENTO      ,
				DT_ATUALIZACAO          ,
				NM_USUARIO              ,
				DT_ATUALIZACAO_NREC     ,
				NM_USUARIO_NREC         ,
				NR_ATENDIMENTO          ,
				NR_SEQ_PROC_INTERNO     ,
				DS_MEDICAL_INSTRUCTION  ,
				IE_ORIGEM_PROCED        ,
				CD_PROCEDIMENTO         ,
				IE_SITUACAO             ,
				DT_LIBERACAO            ,
				CD_PESSOA_FISICA        ,
				DT_GUIDANCE             ,
				DT_CALCULATION
			) VALUES (
				NR_SEQ_W             	 ,
				CD_ESTABELECIMENTO_W 	 ,
				clock_timestamp()              	 ,
				NM_USUARIO_P         	 ,
				clock_timestamp()              	 ,
				NM_USUARIO_P         	 ,
				NR_ATENDIMENTO_P     	 ,
				NR_SEQ_CALCULATION_TYPE_W,
				DS_PROC_EXAME_W          ,
				24                    	 ,
				CD_PROCEDIMENTO_W     	 ,
				'A'                   	 ,
				clock_timestamp()               	 ,
				CD_PESSOA_FISICA_W    	 ,
				DT_CALCULATION_TYPE_W    ,
				clock_timestamp()
			);

			EXECUTE '
				UPDATE
					' || TABLE_EXTER_REFER_W || '
				SET
					NR_SEQ_MED_GUI = ' || TO_CHAR(NR_SEQ_W) || '
				WHERE
					NR_SEQUENCIA = ' || TO_CHAR(NR_SEQ_EXTER_REFER_P)
			;
		END IF;

	END IF;

	COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE medical_guidance_order_epc ( NR_ATENDIMENTO_P bigint, NR_SEQ_EXTER_REFER_P bigint, IE_ORI_EXTER_REFER_P bigint, NM_USUARIO_P text ) FROM PUBLIC;

