-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_justif_class_os ( nr_seq_ordem_p bigint, ie_tipo_justificativa_p text, ds_justificativa_p text, nm_usuario_p text, ie_classificacao_p text, ie_classif_antiga_p text, ds_complemento_p text default null, NR_SEQ_JUSTIF_PHI_P bigint default null) AS $body$
DECLARE

				
nm_user_w		varchar(30);
nr_seq_tipo_w		bigint;
ds_mensagem_w		varchar(4000);
ds_classif_antiga_w	 	varchar(4000);
ds_classificacao_w		varchar(4000);

cd_estabelecimento_w		bigint;
ie_prioridade_w 			man_ordem_servico.ie_prioridade%type;
nr_seq_localizacao_w 		man_ordem_servico.nr_seq_localizacao%type;
nr_grupo_trabalho_w 		man_ordem_servico.nr_grupo_trabalho%type;
dt_ordem_servico_w 		man_ordem_servico.dt_ordem_servico%type;
dt_inicio_real_w 			man_ordem_servico.dt_inicio_real%type;
nr_seq_estagio_w 			man_ordem_servico.nr_seq_estagio%type;
nr_seq_equipamento_w 		man_ordem_servico.nr_seq_equipamento%type;
nr_seq_classif_w 			man_ordem_servico.nr_seq_classif%type;
ie_parado_w 			man_ordem_servico.ie_parado%type;
ds_justificativa_w		varchar(2000);
dt_alteracao_classif_w		timestamp := clock_timestamp();
ie_ambiente_w			man_ordem_servico.ie_ambiente%type;
cd_funcao_w			man_ordem_servico.cd_funcao%type;


BEGIN

select	username
into STRICT	nm_user_w
from	user_users;

if (nm_user_w = 'CORP') then
	nr_seq_tipo_w	:= 148;
end if;

if (man_obter_se_os_sla(nr_seq_ordem_p) = 'S' and ie_classificacao_p <> 'E')then
	select	substr(max(obter_desc_expressao_idioma(cd_exp_informacao, ds_informacao,man_obter_idioma_os_local(nr_seq_ordem_p))),1,4000)
	into STRICT	ds_mensagem_w
	from	dic_objeto	
	where	nr_sequencia = 695275
	and	ie_tipo_objeto = 'T';
end if;

select	substr(obter_valor_dominio_idioma(1149,ie_classificacao_p,man_obter_idioma_os_local(nr_seq_ordem_p)),1,255),
	substr(obter_valor_dominio_idioma(1149,ie_classif_antiga_p,man_obter_idioma_os_local(nr_seq_ordem_p)),1,255)
into STRICT	ds_classificacao_w,
	ds_classif_antiga_w
;

if (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') then
	ds_mensagem_w := ds_mensagem_w || chr(13) || chr(10);
end if;

select coalesce(max(obter_desc_expressao_idioma(cd_exp_observacao, ds_justificativa_p, man_obter_idioma_os_local(nr_seq_ordem_p))), ds_justificativa_p)
into STRICT ds_justificativa_w
from phi_classificacao_justif
where nr_sequencia  = nr_seq_justif_phi_p;

ds_mensagem_w := ds_mensagem_w || SUBSTR(obter_texto_dic_objeto(338098, man_obter_idioma_os_local(nr_seq_ordem_p), 'CLASSIFICACAO_ANTIGA='|| ds_classif_antiga_w
															|| ';CLASSIFICACAO_NOVA=' || ds_classificacao_w 
															|| ';JUSTIFICATIVA=' || ds_justificativa_w),1 , 400);

ds_mensagem_w := substr((ds_mensagem_w || chr(13) || chr(10) || chr(13) || chr(10) ||
		 ds_complemento_p), 1, 4000);

if (ie_classif_antiga_p = 'E' or ie_classif_antiga_p = 'A')then
	begin
		insert into man_ordem_justificativa(nr_sequencia,
			nr_seq_ordem,
			ie_tipo_justificativa,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_justificativa)
		values (nextval('man_ordem_justificativa_seq'),
			nr_seq_ordem_p,
			ie_tipo_justificativa_p,
			dt_alteracao_classif_w, nm_usuario_p,
			dt_alteracao_classif_w, nm_usuario_p,
			substr(ds_justificativa_p,1,255));

		insert into man_ordem_serv_tecnico(nr_sequencia,
			nr_seq_ordem_serv,
			dt_atualizacao,
			nm_usuario,
			ds_relat_tecnico,
			dt_historico,
			ie_origem,
			nr_seq_tipo,
			dt_liberacao,
			nm_usuario_lib)
		values (nextval('man_ordem_serv_tecnico_seq'),
			nr_seq_ordem_p,
			dt_alteracao_classif_w,
			nm_usuario_p,
			ds_mensagem_w,
			dt_alteracao_classif_w,
			'I',
			nr_seq_tipo_w,
			dt_alteracao_classif_w,
			nm_usuario_p);

            if (ie_classificacao_p <> 'E')then
		        CALL Man_Eliminar_SLA_OS(nr_seq_ordem_p, nm_usuario_p);
            end if;

		CALL sla_dashboard_pck.validar_alt_classif_sla(nr_seq_ordem_p, null,null, ie_classificacao_p);
	end;
else
	begin
		insert into man_ordem_serv_tecnico(	nr_sequencia,
			nr_seq_ordem_serv,
			dt_atualizacao,
			nm_usuario,
			ds_relat_tecnico,
			dt_historico,
			dt_liberacao,
			nm_usuario_lib,
			nr_seq_tipo,
			ie_origem)
		values (nextval('man_ordem_serv_tecnico_seq'),
			nr_seq_ordem_p,
			dt_alteracao_classif_w,
			nm_usuario_p,
			ds_mensagem_w,
			dt_alteracao_classif_w,
			dt_alteracao_classif_w,
			nm_usuario_p,
			nr_seq_tipo_w,
			'I');
		
		if (ie_classificacao_p = 'E') then
			select ie_prioridade,
				nr_seq_localizacao,
				nr_grupo_trabalho,
				dt_ordem_servico,
				dt_inicio_real,
				nr_seq_estagio,
				nr_seq_equipamento,
				nr_seq_classif,
				ie_parado,
				ie_ambiente,
				cd_funcao
			into STRICT ie_prioridade_w,
				nr_seq_localizacao_w,
				nr_grupo_trabalho_w,
				dt_ordem_servico_w,
				dt_inicio_real_w,
				nr_seq_estagio_w,
				nr_seq_equipamento_w,
				nr_seq_classif_w,
				ie_parado_w,
				ie_ambiente_w,
				cd_funcao_w
			from man_ordem_servico
			where nr_sequencia = nr_seq_ordem_p;
			
			if (nr_seq_localizacao_w IS NOT NULL AND nr_seq_localizacao_w::text <> '') then
				select	cd_estabelecimento
				into STRICT	cd_estabelecimento_w
				from	man_localizacao
				where	nr_sequencia		= nr_seq_localizacao_w;
			end if;
			
			CALL sla_dashboard_pck.incluir_sla_recebida(
				cd_estabelecimento_w, 	nr_seq_ordem_p, 		nm_usuario_p,
				ie_prioridade_w, 		ie_classificacao_p, 		nr_seq_localizacao_w,
				nr_grupo_trabalho_w, 	dt_ordem_servico_w, 	dt_inicio_real_w,
				nr_seq_estagio_w, 		nr_seq_equipamento_w, 	nr_seq_classif_w,
				ie_parado_w, 'N', ie_ambiente_w, cd_funcao_w, dt_alteracao_classif_w
			);
			
			CALL sla_dashboard_pck.validar_alt_classif_sla(nr_seq_ordem_p, null, null, ie_classificacao_p);
		end if;
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_justif_class_os ( nr_seq_ordem_p bigint, ie_tipo_justificativa_p text, ds_justificativa_p text, nm_usuario_p text, ie_classificacao_p text, ie_classif_antiga_p text, ds_complemento_p text default null, NR_SEQ_JUSTIF_PHI_P bigint default null) FROM PUBLIC;

