-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_atualizar_capex_realizado ( nr_seq_mes_ref_p ctb_mes_ref.nr_sequencia%type, cd_estab_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_centro_custo_w               ctb_orcamento_capex.cd_centro_custo%type;
nr_sequencia_w                  ctb_orcamento_capex.nr_sequencia%type;
ie_real_orc_detalhe_w           varchar(1);
cd_estab_atual_w                estabelecimento.cd_estabelecimento%type;
dt_referencia_w                 ctb_mes_ref.dt_referencia%type;

c01 CURSOR FOR
SELECT  a.cd_conta_contabil,
        a.cd_centro_custo,
        a.vl_movimento,
        a.cd_estabelecimento
from    ctb_grupo_conta c,
        conta_contabil b,
        ctb_saldo a
where   nr_seq_mes_ref      = nr_seq_mes_ref_p
and     a.cd_conta_contabil = b.cd_conta_contabil
and     a.cd_estabelecimento    = coalesce(cd_estab_p, a.cd_estabelecimento)
and     b.cd_grupo  = c.cd_grupo
and     a.vl_movimento <> 0
and     c.ie_tipo   in ('A','P')
and     b.ie_tipo   = 'A';

BEGIN

update  ctb_orcamento_capex
set     vl_realizado    = 0,
        nm_usuario      = nm_usuario_p,
        dt_atualizacao  = clock_timestamp()
where   nr_seq_mes_ref  = nr_seq_mes_ref_p
and     cd_estabelecimento  = coalesce(cd_estab_p, cd_estabelecimento);

commit;

for orc_w in c01 loop
    begin
    cd_centro_custo_w   := coalesce(orc_w.cd_centro_custo,0);

    select  coalesce(max(a.nr_sequencia),0)
    into STRICT    nr_sequencia_w
    from    ctb_orcamento_capex a
    where   a.cd_conta_contabil = orc_w.cd_conta_contabil
    and     coalesce(a.cd_centro_custo, cd_centro_custo_w)   = cd_centro_custo_w
    and     a.nr_seq_mes_ref = nr_seq_mes_ref_p
    and     a.cd_estabelecimento = orc_w.cd_estabelecimento;

    if (nr_sequencia_w <> 0) then

        update  ctb_orcamento_capex a
        set     vl_realizado = orc_w.vl_movimento,
                nm_usuario = nm_usuario_p,
                dt_atualizacao = clock_timestamp()
        where   a.nr_sequencia = nr_sequencia_w;

    else
        begin

        select  nextval('ctb_orcamento_capex_seq')
        into STRICT    nr_sequencia_w
;

        insert into ctb_orcamento_capex(
                    nr_sequencia,
                    nr_seq_mes_ref,
                    dt_atualizacao,
                    nm_usuario,
                    dt_atualizacao_nrec,
                    nm_usuario_nrec,
                    cd_estabelecimento,
                    cd_conta_contabil,
                    cd_centro_custo,
                    vl_orcado,
                    vl_realizado)
        values ( nr_sequencia_w,
                nr_seq_mes_ref_p,
                clock_timestamp(),
                nm_usuario_p,
                clock_timestamp(),
                nm_usuario_p,
                orc_w.cd_estabelecimento,
                orc_w.cd_conta_contabil,
                cd_centro_custo_w,
                0,
                orc_w.vl_movimento);
        end;

    end if;

    end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_atualizar_capex_realizado ( nr_seq_mes_ref_p ctb_mes_ref.nr_sequencia%type, cd_estab_p bigint, nm_usuario_p text) FROM PUBLIC;

