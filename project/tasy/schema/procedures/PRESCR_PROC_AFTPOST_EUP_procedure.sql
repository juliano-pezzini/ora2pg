-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE prescr_proc_aftpost_eup (nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_atendimento_p bigint, cd_convenio_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, dt_procedimento_p timestamp, qt_procedimento_p bigint, ie_tipo_atendimento_p bigint, cd_plano_p text, cd_setor_atendimento_p bigint, nr_seq_exame_p bigint, nr_seq_proc_interno_p bigint, cd_categoria_p text, cd_setor_entrega_prescr_p bigint, cd_medico_p text, nr_sequencia_p bigint, nr_acao_executada_p bigint, nr_prescr_medica_p bigint, nm_usuario_p text, cd_funcao_p bigint, cd_perfil_p bigint, cd_estabelecimento_p bigint, nr_seq_prescricao_p bigint, exec_proc_1_p text, entra_if_1_p text, entra_if_2_p text, nr_seq_proced_p bigint, nr_seq_evento_p bigint, ie_inserindo_p text, ds_msg_erro_p INOUT bigint, ds_msg_aviso_p INOUT text, ie_chamar_funcao_p INOUT text, ie_necis_medico_p INOUT text, ds_texto_p INOUT text, ie_mostra_p INOUT text, ie_passou_if_1_p INOUT text, ie_passou_if_2_p INOUT text, ie_excluir_p INOUT text, nr_seq_avaliacao_p INOUT bigint) AS $body$
DECLARE

 
ie_ger_itens_proc_auto_w		varchar(1);
ie_atualiza_proc_cad_w			varchar(1);
ie_gerar_diag_cid_w				varchar(1);
ie_regra_lanc_aut_w				varchar(1);


BEGIN 
 
ie_regra_lanc_aut_w := Obter_param_Usuario(916, 414, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_regra_lanc_aut_w);
ie_ger_itens_proc_auto_w := Obter_param_Usuario(916, 548, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_ger_itens_proc_auto_w);
ie_atualiza_proc_cad_w := Obter_param_Usuario(916, 732, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_atualiza_proc_cad_w);
ie_gerar_diag_cid_w := Obter_param_Usuario(916, 1011, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_gerar_diag_cid_w);
 
SELECT * FROM prescr_proc_aftpost_abort_eup(nr_prescricao_p, nr_seq_prescr_p, nr_atendimento_p, cd_convenio_p, cd_procedimento_p, ie_origem_proced_p, dt_procedimento_p, qt_procedimento_p, ie_tipo_atendimento_p, cd_plano_p, cd_setor_atendimento_p, nr_seq_exame_p, nr_seq_proc_interno_p, cd_categoria_p, cd_setor_entrega_prescr_p, cd_medico_p, nr_sequencia_p, nr_acao_executada_p, nr_prescr_medica_p, nm_usuario_p, cd_funcao_p, cd_perfil_p, cd_estabelecimento_p, nr_seq_prescricao_p, entra_if_2_p, ds_msg_erro_p, ds_msg_aviso_p, ie_chamar_funcao_p, ie_necis_medico_p, ds_texto_p, nr_seq_avaliacao_p) INTO STRICT ds_msg_erro_p, ds_msg_aviso_p, ie_chamar_funcao_p, ie_necis_medico_p, ds_texto_p, nr_seq_avaliacao_p;
 
if (exec_proc_1_p = 'S') then 
	CALL gerar_lancto_aut_prescr_proc(nr_prescricao_p, nr_seq_proced_p, nr_seq_evento_p, nm_usuario_p, cd_procedimento_p, ie_origem_proced_p, nr_seq_proc_interno_p, 
		nr_seq_exame_p, ie_regra_lanc_aut_w);
end if;
 
if (ie_inserindo_p = 'S') then 
	begin 
	if (ie_ger_itens_proc_auto_w = 'S') then 
		CALL Gerar_med_mat_assoc(nr_prescricao_p, nr_sequencia_p);
	end if;
	CALL Gerar_prescr_proc_assoc(nr_prescricao_p, nr_sequencia_p, '', nm_usuario_p);
	end;
end if;
 
if (entra_if_1_p = 'S') then 
	begin 
	select 	coalesce(max(ie_mostra_dados_adic_prescr), 'N') 
	into STRICT	ie_mostra_p 
	from 	exame_laboratorio 
	where 	nr_seq_exame = nr_seq_exame_p;
	 
	ie_passou_if_1_p := 'S';
	end;
end if;
 
if (ie_atualiza_proc_cad_w = 'S') then 
	begin 
		CALL atualiza_proc_atend_conv(nr_atendimento_p, cd_convenio_p, cd_categoria_p);
	end;
end if;
 
if (entra_if_2_p = 'S') then 
	ie_passou_if_2_p := 'S';
end if;
 
if (ie_gerar_diag_cid_w = 'S') then 
	CALL Gerar_Diagnostico_Procedimento(nr_atendimento_p, cd_procedimento_p, cd_medico_p, dt_procedimento_p, nm_usuario_p);
end if;
 
select	max(ie_excluir_proc_princ) 
into STRICT	ie_excluir_p 
from	proc_interno 
where	nr_sequencia = nr_seq_proc_interno_p;
 
if (ie_excluir_p = 'S') then 
	CALL gera_excl_proced_principal(nr_prescricao_p, nr_seq_proc_interno_p);
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE prescr_proc_aftpost_eup (nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_atendimento_p bigint, cd_convenio_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, dt_procedimento_p timestamp, qt_procedimento_p bigint, ie_tipo_atendimento_p bigint, cd_plano_p text, cd_setor_atendimento_p bigint, nr_seq_exame_p bigint, nr_seq_proc_interno_p bigint, cd_categoria_p text, cd_setor_entrega_prescr_p bigint, cd_medico_p text, nr_sequencia_p bigint, nr_acao_executada_p bigint, nr_prescr_medica_p bigint, nm_usuario_p text, cd_funcao_p bigint, cd_perfil_p bigint, cd_estabelecimento_p bigint, nr_seq_prescricao_p bigint, exec_proc_1_p text, entra_if_1_p text, entra_if_2_p text, nr_seq_proced_p bigint, nr_seq_evento_p bigint, ie_inserindo_p text, ds_msg_erro_p INOUT bigint, ds_msg_aviso_p INOUT text, ie_chamar_funcao_p INOUT text, ie_necis_medico_p INOUT text, ds_texto_p INOUT text, ie_mostra_p INOUT text, ie_passou_if_1_p INOUT text, ie_passou_if_2_p INOUT text, ie_excluir_p INOUT text, nr_seq_avaliacao_p INOUT bigint) FROM PUBLIC;

