-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_update_atendimento_aux ( nr_atendimento_p atendimento_paciente.nr_atendimento%TYPE, nr_seq_agenda_p agenda_consulta.nr_sequencia%TYPE, nr_seq_classif_ind_atend_p atendimento_paciente_aux.nr_seq_classif_indicador_atend%TYPE, ie_response_p INOUT text, cd_especialidade_p atendimento_paciente_aux.CD_ESPECIALIDADE%TYPE DEFAULT NULL, cd_sub_grav_p atendimento_paciente_aux.CD_SUB_GRAV%TYPE DEFAULT NULL, ds_subs_cart_p atendimento_paciente_aux.DS_SUBS_CART%TYPE DEFAULT NULL, ds_contract_partner_p atendimento_paciente_aux.DS_CONTRACT_PARTNER%TYPE DEFAULT NULL, ie_finalidade_consulta_p atendimento_paciente_aux.IE_FINALIDADE_CONSULTA%TYPE DEFAULT NULL, ie_causa_externa_p atendimento_paciente_aux.IE_CAUSA_EXTERNA%TYPE DEFAULT NULL, nr_seq_posicao_p atendimento_paciente_aux.NR_SEQ_POSICAO%TYPE DEFAULT NULL) AS $body$
DECLARE

    is_record_exist   varchar(1) := 'N';
    ie_response_w     varchar(1) := 'N';
    nr_seq_class_indicador_atend_w atendimento_paciente_aux.nr_seq_classif_indicador_atend%type;


BEGIN

    IF ( nr_atendimento_p <> 0 ) THEN
        SELECT
            CASE WHEN COUNT(*)=0 THEN  'N'  ELSE 'S' END ,
	    max(nr_seq_classif_indicador_atend)
        INTO STRICT 
	    is_record_exist,
	    nr_seq_class_indicador_atend_w 
        FROM
            atendimento_paciente_aux
        WHERE
            nr_atendimento = nr_atendimento_p;

        IF ( is_record_exist = 'S' ) THEN

            IF ( nr_seq_agenda_p <> 0 or (cd_especialidade_p IS NOT NULL AND cd_especialidade_p::text <> '')) THEN
                BEGIN
                    UPDATE atendimento_paciente_aux
                    SET
                        nr_seq_agenda = nr_seq_agenda_p,
                        nm_usuario = wheb_usuario_pck.get_nm_usuario,
                        dt_atualizacao = clock_timestamp(),
                        cd_especialidade = cd_especialidade_p,
                        cd_sub_grav = cd_sub_grav_p,
                        ds_subs_cart = ds_subs_cart_p,
                        ds_contract_partner = ds_contract_partner_p,
                        ie_causa_externa = ie_causa_externa_p,
			                  ie_finalidade_consulta = ie_finalidade_consulta_p,
                        nr_seq_posicao = nr_seq_posicao_p
                    WHERE
                        nr_atendimento = nr_atendimento_p;

                END;

            ELSIF ( nr_seq_classif_ind_atend_p <> 0 OR (nr_seq_class_indicador_atend_w IS NOT NULL AND nr_seq_class_indicador_atend_w::text <> '') ) THEN
                BEGIN
                    UPDATE atendimento_paciente_aux
                    SET
                        nr_seq_classif_indicador_atend = nr_seq_classif_ind_atend_p,
                        nm_usuario = wheb_usuario_pck.get_nm_usuario,
                        dt_atualizacao = clock_timestamp(),
			cd_especialidade = cd_especialidade_p,
			cd_sub_grav = cd_sub_grav_p,
			ds_subs_cart = ds_subs_cart_p,
			ds_contract_partner = ds_contract_partner_p,
			ie_causa_externa = ie_causa_externa_p,
			ie_finalidade_consulta = ie_finalidade_consulta_p
                    WHERE
                        nr_atendimento = nr_atendimento_p;

                END;
				
			ELSIF (ie_causa_externa_p IS NOT NULL AND ie_causa_externa_p::text <> '') OR (ie_finalidade_consulta_p IS NOT NULL AND ie_finalidade_consulta_p::text <> '') then
              BEGIN
                  UPDATE atendimento_paciente_aux
                  SET    ie_causa_externa = ie_causa_externa_p,
                        ie_finalidade_consulta = ie_finalidade_consulta_p
                  WHERE  nr_atendimento   = nr_atendimento_p;
			END;

            ELSIF (nr_seq_posicao_p IS NOT NULL AND nr_seq_posicao_p::text <> '') then
                BEGIN
                    UPDATE atendimento_paciente_aux
                    SET    nr_seq_posicao = nr_seq_posicao_p
                    WHERE  nr_atendimento = nr_atendimento_p;
            END;
			END IF;

        ELSE
            INSERT INTO atendimento_paciente_aux(
                nr_sequencia,
                dt_atualizacao,
                dt_atualizacao_nrec,
                nm_usuario,
                nm_usuario_nrec,
                nr_atendimento,
                nr_seq_agenda,
                nr_seq_classif_indicador_atend,
                cd_especialidade,
                cd_sub_grav,
                ds_subs_cart,
                ds_contract_partner,
                ie_finalidade_consulta,
                ie_causa_externa,
                nr_seq_posicao
            ) VALUES (
                nextval('atendimento_paciente_aux_seq'),
                clock_timestamp(),
                clock_timestamp(),
                wheb_usuario_pck.get_nm_usuario,
                wheb_usuario_pck.get_nm_usuario,
                nr_atendimento_p,
                nr_seq_agenda_p,
                nr_seq_classif_ind_atend_p,
                cd_especialidade_p,
                cd_sub_grav_p,
                ds_subs_cart_p,
                ds_contract_partner_p,
                ie_finalidade_consulta_p,
                ie_causa_externa_p,
                nr_seq_posicao_p);

        END IF;

        COMMIT;
        ie_response_w := 'S';

    END IF;

    ie_response_p := ie_response_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_update_atendimento_aux ( nr_atendimento_p atendimento_paciente.nr_atendimento%TYPE, nr_seq_agenda_p agenda_consulta.nr_sequencia%TYPE, nr_seq_classif_ind_atend_p atendimento_paciente_aux.nr_seq_classif_indicador_atend%TYPE, ie_response_p INOUT text, cd_especialidade_p atendimento_paciente_aux.CD_ESPECIALIDADE%TYPE DEFAULT NULL, cd_sub_grav_p atendimento_paciente_aux.CD_SUB_GRAV%TYPE DEFAULT NULL, ds_subs_cart_p atendimento_paciente_aux.DS_SUBS_CART%TYPE DEFAULT NULL, ds_contract_partner_p atendimento_paciente_aux.DS_CONTRACT_PARTNER%TYPE DEFAULT NULL, ie_finalidade_consulta_p atendimento_paciente_aux.IE_FINALIDADE_CONSULTA%TYPE DEFAULT NULL, ie_causa_externa_p atendimento_paciente_aux.IE_CAUSA_EXTERNA%TYPE DEFAULT NULL, nr_seq_posicao_p atendimento_paciente_aux.NR_SEQ_POSICAO%TYPE DEFAULT NULL) FROM PUBLIC;

