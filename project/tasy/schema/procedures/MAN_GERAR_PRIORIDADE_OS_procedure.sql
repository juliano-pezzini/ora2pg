-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_prioridade_os ( nm_usuario_prev_p text, nm_usuario_p text, dt_prevista_p timestamp) AS $body$
DECLARE

 
			 
IE_PRIORIDADE_CLIENTE_W		varchar(20);	
qt_pontuacao_w			bigint;		
IE_CLASSIFICACAO_w		varchar(10);
nr_seq_severidade_score_w	bigint;
DS_CURVA_ABC_w			varchar(10);
qt_dias_os_w			bigint;
dt_ordem_serv_w			timestamp;
nr_ordem_serv_w			bigint;
qt_reg_w			bigint;
qt_prioridade_w			smallint;
nr_seq_ativ_w			bigint;
			
C01 CURSOR FOR 
	SELECT	coalesce(b.ie_prioridade_cliente,b.ie_prioridade) ie_prioridade, 
		b.ie_classificacao, 
		coalesce(b.nr_seq_severidade,b.nr_seq_severidade_wheb) nr_seq_severidade_score, 
		substr(coalesce(man_obter_curva_abc(b.nr_seq_cliente),'C'),1,5) ds_curva_abc, 
		b.dt_ordem_servico, 
		b.nr_sequencia 
	from	man_os_prevista_v a, 
		man_ordem_servico b 
	where	a.nm_usuario_prev = nm_usuario_prev_p 
	and	a.nr_sequencia = b.nr_Sequencia 
	and	coalesce(substr(man_obter_se_mostra_os_confid(a.nr_sequencia,nm_usuario_p),1,1),'S') = 'S' 
	and	a.dt_prevista between trunc(dt_prevista_p,'dd') and fim_dia(dt_prevista_p) 
	and (coalesce(a.ie_situacao_os,'0') <> '3' 
		or exists (	SELECT	1 
				from	man_ordem_serv_ativ x 
				where	x.nr_seq_ordem_serv 	= a.nr_sequencia 
				and	x.nm_usuario_exec	= a.nm_usuario_prev 
				and	trunc(x.dt_atividade,'dd') = trunc(a.dt_prevista,'dd')));			

BEGIN 
 
open C01;
loop 
fetch C01 into	 
	IE_PRIORIDADE_CLIENTE_W, 
	IE_CLASSIFICACAO_w, 
	nr_seq_severidade_score_w, 
	DS_CURVA_ABC_w, 
	dt_ordem_serv_w, 
	nr_ordem_serv_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	qt_pontuacao_w := 0;
	 
	if (IE_PRIORIDADE_CLIENTE_W = 'E') then 
		qt_pontuacao_w	:= qt_pontuacao_w + 6;
	elsif (IE_PRIORIDADE_CLIENTE_W = 'U') then 
		qt_pontuacao_w	:= qt_pontuacao_w + 4;
	elsif (IE_PRIORIDADE_CLIENTE_W = 'A') then 
		qt_pontuacao_w	:= qt_pontuacao_w + 3;
	elsif (IE_PRIORIDADE_CLIENTE_W = 'M') then 
		qt_pontuacao_w	:= qt_pontuacao_w + 2;
	else 
		qt_pontuacao_w	:= qt_pontuacao_w + 1;
	end if;
	 
	if (IE_CLASSIFICACAO_w = 'E') then -- Erro 
 
		if (nr_seq_severidade_score_w = 1) then 
			qt_pontuacao_w	:= qt_pontuacao_w + 70;
		elsif (nr_seq_severidade_score_w = 2) then 
			qt_pontuacao_w	:= qt_pontuacao_w + 60;
		elsif (nr_seq_severidade_score_w = 3) then 
			qt_pontuacao_w	:= qt_pontuacao_w + 55;
		elsif (nr_seq_severidade_score_w = 4) then 
			qt_pontuacao_w	:= qt_pontuacao_w + 50;
		else 
			qt_pontuacao_w	:= qt_pontuacao_w + 45;
		end if;
	elsif (IE_CLASSIFICACAO_w = 'D') then -- DÃºvida 
		qt_pontuacao_w	:= qt_pontuacao_w + 2;
	end if;
	 
	if (DS_CURVA_ABC_w = 'A') then 
		qt_pontuacao_w	:= qt_pontuacao_w + 15;
	elsif (DS_CURVA_ABC_w = 'B') then 
		qt_pontuacao_w	:= qt_pontuacao_w + 9;
	elsif (DS_CURVA_ABC_w = 'C') then 
		qt_pontuacao_w	:= qt_pontuacao_w + 6;
	end if;
		 
	qt_dias_os_w	:= trunc(clock_timestamp() - dt_ordem_serv_w);
 
	if (qt_dias_os_w	> 90) then 
		qt_pontuacao_w	:= qt_pontuacao_w + 20;
	elsif (qt_dias_os_w	> 60) then 
		qt_pontuacao_w	:= qt_pontuacao_w + 15;
	elsif (qt_dias_os_w	> 30) then 
		qt_pontuacao_w	:= qt_pontuacao_w + 10;
	elsif (qt_dias_os_w  > 15) then 
		qt_pontuacao_w := qt_pontuacao_w + 5;
	elsif (qt_dias_os_w  > 7) then 
		qt_pontuacao_w := qt_pontuacao_w + 2;
	end if;
	 
	if (DS_CURVA_ABC_w = 'A') and (qt_dias_os_w >= 10) then 
		qt_pontuacao_w	:= qt_pontuacao_w + 20;
		 
	end if;
	 
	select 	count(1) 
	into STRICT	qt_reg_w 
	from	desenv_acordo_os 
	where	NR_SEQ_ORDEM_SERVICO = nr_ordem_serv_w;
	 
	 
	if (qt_reg_w	> 0 ) then 
		qt_pontuacao_w	:= qt_pontuacao_w + 20;
	end if;
	 
	if (qt_pontuacao_w > 0) and (qt_pontuacao_w <= 5) then 
		qt_prioridade_w := 1;
	elsif (qt_pontuacao_w >= 6) and (qt_pontuacao_w <= 10) then 
		qt_prioridade_w := 2;
	elsif (qt_pontuacao_w >= 11) and (qt_pontuacao_w <= 15) then 
		qt_prioridade_w := 3;
	elsif (qt_pontuacao_w >= 16) and (qt_pontuacao_w <= 25) then 
		qt_prioridade_w := 4;
	elsif (qt_pontuacao_w >= 26) and (qt_pontuacao_w <= 35) then 
		qt_prioridade_w := 5;
	elsif (qt_pontuacao_w >= 36) and (qt_pontuacao_w <= 40) then 
		qt_prioridade_w := 6;
	elsif (qt_pontuacao_w >= 41) and (qt_pontuacao_w <=50) then 
		qt_prioridade_w := 7;
	elsif (qt_pontuacao_w >= 51) and (qt_pontuacao_w <= 70) then 
		qt_prioridade_w := 8;
	elsif (qt_pontuacao_w >= 71) then 
		qt_prioridade_w := 9;
	end if;
 
	select	max(a.nr_sequencia) 
	into STRICT	nr_seq_ativ_w 
	from	man_ordem_ativ_prev a 
	where	a.nr_seq_ordem_serv = nr_ordem_serv_w 
	and	trunc(a.dt_prevista) = trunc(dt_prevista_p) 
	and	coalesce(dt_real::text, '') = '';
	 
	if (nr_seq_ativ_w IS NOT NULL AND nr_seq_ativ_w::text <> '') then 
		update	man_ordem_ativ_prev 
		set	IE_PRIORIDADE_DESEN = qt_prioridade_w 
		where	nr_sequencia = nr_seq_ativ_w;
	end if;
	 
	end;
end loop;
close C01;
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_prioridade_os ( nm_usuario_prev_p text, nm_usuario_p text, dt_prevista_p timestamp) FROM PUBLIC;

