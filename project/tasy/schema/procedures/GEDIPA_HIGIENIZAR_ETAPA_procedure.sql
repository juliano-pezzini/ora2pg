-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gedipa_higienizar_etapa ( nr_seq_etapa_p bigint, nm_usuario_p text) AS $body$
DECLARE

					
nr_sequencia_w 		bigint;
nr_seq_processo_w	adep_processo.nr_sequencia%type;
nr_seq_area_prep_w	prescr_mat_hor.nr_seq_area_prep%type;


BEGIN

SELECT 	max(c.nr_sequencia)
into STRICT 	nr_sequencia_w
FROM 	gedipa_prod_mat_med a, gedipa_etapa_producao c
WHERE   a.nr_seq_etapa_gedipa = c.nr_sequencia
AND 	c.ie_status_etapa = 'S'
AND 	coalesce(a.dt_higienizacao::text, '') = ''
AND 	a.nr_seq_etapa_gedipa = nr_seq_etapa_p;

if (coalesce(nr_sequencia_w::text, '') = '') then
	update	gedipa_etapa_producao
	set 	ie_status_etapa 	= 'H',
		nm_usuario 		= nm_usuario_p
	where	nr_sequencia 		= nr_seq_etapa_p;
	
	
	select 	max(nr_seq_processo),
			max(nr_seq_area_prep)
	into STRICT	nr_seq_processo_w,
			nr_seq_area_prep_w
	from	prescr_mat_hor
	where	nr_seq_etapa_gedipa = nr_seq_etapa_p;
	
	CALL gedipa_higienizar_processo( cd_estabelecimento_p => wheb_usuario_pck.get_cd_estabelecimento,
								cd_perfil_p => wheb_usuario_pck.get_cd_perfil,
								nr_processo_p => nr_seq_processo_w,
								nm_usuario_p => nm_usuario_p,
								nr_seq_area_p => nr_seq_area_prep_w,
								ie_higienizar_p => 'S');
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gedipa_higienizar_etapa ( nr_seq_etapa_p bigint, nm_usuario_p text) FROM PUBLIC;

