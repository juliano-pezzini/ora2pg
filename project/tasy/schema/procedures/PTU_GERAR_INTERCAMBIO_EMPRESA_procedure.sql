-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_gerar_intercambio_empresa ( nr_sequencia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) is /* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[ X ]  Objetos do dicionário [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atenção:
-------------------------------------------------------------------------------------------------------------------

Referências:
	PTU_GERAR_INTERCAMBIO
	PTU_GERAR_LOTE_ENVIO
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 nm_pessoa_fisica_w varchar(255) RETURNS varchar AS $body$
DECLARE

ds_retorno_w	varchar(255);
C01 CURSOR FOR
	SELECT	cd_intercambio
	from	pls_interc_tipo_logradouro
	where (nr_seq_tipo_logradouro = nr_seq_tipo_logradouro_p or (coalesce(nr_seq_tipo_logradouro::text, '') = '' and coalesce(cd_tipo_logradouro::text, '') = ''))
	order by coalesce(nr_seq_tipo_logradouro,0);
BEGIN
ds_retorno_w	:= null;
for r_c01_w in C01 loop
	begin
	ds_retorno_w	:= r_c01_w.cd_intercambio;
	end;
end loop;
return	ds_retorno_w;
end;

begin
indice_contrato_w	:= 0;
tb_nr_seq_contrato_pf_w.delete;

--Obter dados do envio
select	trunc(a.dt_mov_inicio, 'dd'),
	fim_dia(a.dt_mov_fim),
	a.ie_tipo_mov,
	a.cd_unimed_destino,
	(select	max(x.ie_tipo_compartilhamento)
	from	ptu_intercambio_lote_envio x
	where	x.nr_sequencia = a.nr_seq_lote_envio) ie_tipo_compartilhamento
into STRICT	dt_mov_inicio_w,
	dt_mov_fim_w,
	ie_tipo_mov_w,
	cd_unimed_destino_w,
	ie_tipo_compartilhamento_w
from	ptu_intercambio a
where	a.nr_sequencia	= nr_sequencia_p;

select 	coalesce(ie_gerar_liberacao_a100,'N'),
	coalesce(ie_gerar_contrato_pf_a100,'N')
into STRICT	ie_gerar_liberacao_a100_w,
	ie_gerar_contrato_pf_a100_w
from	pls_parametros
where	cd_estabelecimento	= cd_estabelecimento_p;

select	max(nr_sequencia)
into STRICT	nr_seq_congerene_w
from	pls_congenere
where	(cd_cooperativa)::numeric 	= (cd_unimed_destino_w)::numeric;

open C01;
loop
fetch C01 into
	nr_seq_contr_interc_w,
	ie_tipo_contrato_w,
	cd_cgc_estipulante_w,
	cd_caepf_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	if (ie_tipo_contrato_w = 'P') then
		select	cd_cgc_estipulante,
			cd_pf_estipulante,
			dt_contrato,
			dt_rescisao_contrato,
			cd_operadora_empresa
		into STRICT	cd_cgc_estipulante_w,
			cd_pf_estipulante_w,
			dt_contrato_w,
			dt_rescisao_contrato_w,
			cd_empresa_origem_w
		from	pls_contrato
		where	nr_sequencia	= nr_seq_contr_interc_w;
		
		select	CASE WHEN max(b.ie_preco)='1' THEN '1'  ELSE '2' END
		into STRICT	ie_contrato_local_w
		from	pls_contrato_plano a,
			pls_plano b
		where	b.nr_sequencia		= a.nr_seq_plano
		and	a.nr_seq_contrato	= nr_seq_contr_interc_w;
	elsif (ie_tipo_contrato_w = 'I') then
		select	cd_cgc,
			cd_pessoa_fisica,
			dt_inclusao,
			dt_exclusao,
			cd_operadora_empresa,
			CASE WHEN ie_tipo_repasse='P' THEN  '1'  ELSE CASE WHEN ie_tipo_repasse='C' THEN  '2'  ELSE null END  END
		into STRICT	cd_cgc_estipulante_w,
			cd_pf_estipulante_w,
			dt_contrato_w,
			dt_rescisao_contrato_w,
			cd_empresa_origem_w,
			ie_contrato_local_w
		from	pls_intercambio
		where	nr_sequencia	= nr_seq_contr_interc_w;
	end if;	
	
	if ((cd_cgc_estipulante_w IS NOT NULL AND cd_cgc_estipulante_w::text <> '') or ie_gerar_contrato_pf_a100_w = 'S') then
		if (cd_cgc_estipulante_w IS NOT NULL AND cd_cgc_estipulante_w::text <> '') then
			select	substr((ds_razao_social), 1, 40),
				substr((nm_fantasia), 1, 18),
				nr_inscricao_estadual,
				substr((ds_endereco), 1, 40),
				substr((cd_cep), 1, 8),
				substr((ds_complemento), 1, 20),
				substr((ds_bairro), 1, 30),
				substr((ds_municipio), 1, 30),
				substr(sg_estado, 1, 2),
				nr_ddd_telefone,
				substr(somente_numero(nr_telefone), 1, 9),
				substr(somente_numero(nr_fax), 1, 8),
				cd_municipio_ibge || Calcula_Digito('MODULO10',substr(cd_municipio_ibge, 1, 10)),
				nr_endereco,
				nr_seq_tipo_logradouro
			into STRICT	ds_razao_social_w,
				nm_fantasia_w,
				nr_inscricao_estadual_w,
				ds_endereco_w,
				cd_cep_w,
				ds_complemento_w,
				ds_bairro_w,
				ds_municipio_w,
				sg_estado_w,
				nr_ddd_telefone_w,
				nr_telefone_w,
				nr_fax_w,
				cd_municipio_ibge_w,
				nr_endereco_w,
				nr_seq_tipo_logradouro_w
			from	pessoa_juridica
			where	cd_cgc	= cd_cgc_estipulante_w;
			
			ie_tipo_pessoa_w	:= 1;
			cd_cgc_cpf_w		:= cd_cgc_estipulante_w;
			
			nr_inscricao_estadual_w	:= somente_numero(nr_inscricao_estadual_w);
			cd_tipo_logradouro_w	:= obter_cd_tipo_logradouro(nr_seq_tipo_logradouro_w);
			
			if (coalesce(cd_empresa_origem_w::text, '') = '') then
				select	cd_operadora_empresa
				into STRICT	cd_empresa_origem_w
				from	pessoa_juridica
				where	cd_cgc	= cd_cgc_estipulante_w;
			end if;
			
			if (coalesce(cd_cgc_cpf_w::text, '') = '') then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(255866,'NM_PESSOA=' || ds_razao_social_w || ';' ||
										'CD_CGC_ESTIPULANTE=' || cd_cgc_estipulante_w);
			end if;
			
			if (coalesce(cd_cep_w::text, '') = '') then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(255867,'NM_PESSOA=' || ds_razao_social_w || ';' ||
										'CD_CGC_ESTIPULANTE=' || cd_cgc_estipulante_w);
			end if;
			
			if (coalesce(ds_endereco_w::text, '') = '') then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(255868,'NM_PESSOA=' || ds_razao_social_w || ';' ||
										'CD_CGC_ESTIPULANTE=' || cd_cgc_estipulante_w);
			end if;
			
			if (coalesce(cd_empresa_origem_w::text, '') = '') then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(255869,'NM_PESSOA=' || ds_razao_social_w || ';' ||
										'CD_CGC_ESTIPULANTE=' || cd_cgc_estipulante_w);
			end if;
			
			ds_municipio_w		:= Elimina_Acentuacao(elimina_acentos(ds_municipio_w));
			nm_fantasia_w		:= elimina_acentos(nm_fantasia_w);
			nm_fantasia_w		:= Elimina_aspas(nm_fantasia_w);
			nm_fantasia_w		:= replace(replace(replace(replace(nm_fantasia_w, '/', ' '), 'ç', 'c'), 'Ç', 'C'), '-', '');
			ds_razao_social_w	:= elimina_acentos(ds_razao_social_w);
			ds_razao_social_w	:= Elimina_aspas(ds_razao_social_w);
			ds_razao_social_w	:= replace(replace(replace(replace(ds_razao_social_w, '/', ' '), 'ç', 'c'), 'Ç', 'C'), '-', '');
			ds_endereco_w		:= elimina_caractere_especial(ds_endereco_w);
			ds_endereco_w		:= elimina_acentos(ds_endereco_w);
			ds_complemento_w	:= elimina_caractere_especial(ds_complemento_w);
			ds_complemento_w	:= elimina_acentos(ds_complemento_w);
			ds_bairro_w		:= elimina_caractere_especial(ds_bairro_w);
			ds_bairro_w		:= elimina_acentos(ds_bairro_w);
			
			select	nextval('ptu_intercambio_empresa_seq')
			into STRICT	nr_seq_inter_empresa_w
			;
			
			begin
			insert into ptu_intercambio_empresa(	nr_sequencia,nr_seq_intercambio,ds_razao_social,nm_empr_abrev, ie_tipo_pessoa,
					cd_cgc_cpf,ds_endereco,cd_cep, cd_empresa_origem,dt_atualizacao,
					nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,cd_filial,nr_insc_estadual,
					ds_complemento, ds_bairro,nm_cidade,sg_uf,nr_ddd,
					nr_telefone,nr_fax,dt_inclusao,dt_exclusao,cd_municipio_ibge,
					nr_seq_contrato,ie_tipo_contrato,nr_endereco,ie_contrato_local,
					cd_tipo_logradouro, nm_fantasia_empr, cd_caepf)
			values (	nr_seq_inter_empresa_w,nr_sequencia_p,ds_razao_social_w,nm_fantasia_w, ie_tipo_pessoa_w,
					cd_cgc_cpf_w,ds_endereco_w,cd_cep_w, cd_empresa_origem_w,clock_timestamp(),
					nm_usuario_p,clock_timestamp(),nm_usuario_p,substr(cd_cgc_cpf_w, 9, 4),nr_inscricao_estadual_w,
					ds_complemento_w, ds_bairro_w,ds_municipio_w,sg_estado_w,nr_ddd_telefone_w,
					nr_telefone_w,nr_fax_w,dt_contrato_w,dt_rescisao_contrato_w,cd_municipio_ibge_w,
					nr_seq_contr_interc_w,ie_tipo_contrato_w,nr_endereco_w,ie_contrato_local_w,
					cd_tipo_logradouro_w, nm_fantasia_w, cd_caepf_w);
			exception
			when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(240408,'DS_RAZAO_SOCIAL=' || ds_razao_social_w || ';' || 'CD_CGC_CPF=' || cd_cgc_cpf_w );
			end;
			
			CALL ptu_gerar_intercambio_plano(	nr_seq_inter_empresa_w,
							nm_usuario_p,
							cd_estabelecimento_p,
							null);
			
			CALL ptu_gerar_intercambio_benef(	nr_seq_inter_empresa_w,
							nr_seq_congerene_w,
							cd_estabelecimento_p,
							nm_usuario_p,
							null);
			
			select	count(1)
			into STRICT	qt_registros_w
			from	ptu_intercambio_benef	a
			where	a.nr_seq_empresa	= nr_seq_inter_empresa_w;
			
			if (qt_registros_w = 0) then
				delete	FROM ptu_intercambio_plano
				where	nr_seq_empresa	= nr_seq_inter_empresa_w;
				
				delete	FROM ptu_intercambio_empresa
				where	nr_sequencia	= nr_seq_inter_empresa_w;
			end if;
		elsif (cd_pf_estipulante_w IS NOT NULL AND cd_pf_estipulante_w::text <> '') then
			tb_nr_seq_contrato_pf_w(indice_contrato_w)	:= nr_seq_contr_interc_w;
			indice_contrato_w	:= indice_contrato_w + 1;
		end if;
		
	end if;
	end;
end loop;
close C01;

if (tb_nr_seq_contrato_pf_w.count > 0) then
	ie_tipo_contrato_w	:= 'P';
	ie_contrato_local_w	:= '1';
	ie_tipo_pessoa_w	:= 2;
	cd_empresa_origem_w	:= 8888;
	
	select	b.cd_cgc,
		substr((b.ds_razao_social), 1, 40),
		substr((b.nm_fantasia), 1, 18),
		somente_numero(b.nr_inscricao_estadual),
		substr((b.ds_endereco), 1, 40),
		substr((b.cd_cep), 1, 8),
		substr((b.ds_complemento), 1, 20),
		substr((b.ds_bairro), 1, 30),
		substr((b.ds_municipio), 1, 30),
		b.sg_estado,
		b.nr_ddd_telefone,
		substr(somente_numero(b.nr_telefone), 1, 9),
		substr(somente_numero(b.nr_fax), 1, 8),
		b.cd_municipio_ibge || Calcula_Digito('MODULO10',substr(b.cd_municipio_ibge, 1, 10)),
		b.nr_endereco,
		b.nr_seq_tipo_logradouro
	into STRICT	cd_cgc_cpf_w,
		ds_razao_social_w,
		nm_fantasia_w,
		nr_inscricao_estadual_w,
		ds_endereco_w,
		cd_cep_w,
		ds_complemento_w,
		ds_bairro_w,
		ds_municipio_w,
		sg_estado_w,
		nr_ddd_telefone_w,
		nr_telefone_w,
		nr_fax_w,
		cd_municipio_ibge_w,
		nr_endereco_w,
		nr_seq_tipo_logradouro_w
	from	pls_outorgante	a,
		pessoa_juridica	b
	where	b.cd_cgc	= a.cd_cgc_outorgante
	and	a.cd_estabelecimento = cd_estabelecimento_p;
	
	ds_municipio_w		:= Elimina_Acentuacao(elimina_acentos(ds_municipio_w));
	nm_fantasia_w		:= elimina_acentos(nm_fantasia_w);
	nm_fantasia_w		:= Elimina_aspas(nm_fantasia_w);
	nm_fantasia_w		:= replace(replace(replace(replace(nm_fantasia_w, '/', ' '), 'ç', 'c'), 'Ç', 'C'), '-', '');
	ds_razao_social_w	:= elimina_acentos(ds_razao_social_w);
	ds_razao_social_w	:= Elimina_aspas(ds_razao_social_w);
	ds_razao_social_w	:= replace(replace(replace(replace(ds_razao_social_w, '/', ' '), 'ç', 'c'), 'Ç', 'C'), '-', '');
	ds_endereco_w		:= elimina_caractere_especial(ds_endereco_w);
	ds_endereco_w		:= elimina_acentos(ds_endereco_w);
	ds_complemento_w	:= elimina_caractere_especial(ds_complemento_w);
	ds_complemento_w	:= elimina_acentos(ds_complemento_w);
	ds_bairro_w		:= elimina_caractere_especial(ds_bairro_w);
	ds_bairro_w		:= elimina_acentos(ds_bairro_w);
	cd_tipo_logradouro_w	:= obter_cd_tipo_logradouro(nr_seq_tipo_logradouro_w);
	
	begin
	insert into ptu_intercambio_empresa(	nr_sequencia,nr_seq_intercambio,ds_razao_social,nm_empr_abrev, ie_tipo_pessoa,
			cd_cgc_cpf,ds_endereco,cd_cep, cd_empresa_origem,dt_atualizacao,
			nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,cd_filial,nr_insc_estadual,
			ds_complemento, ds_bairro,nm_cidade,sg_uf,nr_ddd,
			nr_telefone,nr_fax,dt_inclusao,dt_exclusao,cd_municipio_ibge,
			nr_seq_contrato,ie_tipo_contrato,nr_endereco,ie_contrato_local,
			cd_tipo_logradouro, nm_fantasia_empr)
	values (	nextval('ptu_intercambio_empresa_seq'),nr_sequencia_p,ds_razao_social_w,nm_fantasia_w, ie_tipo_pessoa_w,
			cd_cgc_cpf_w,ds_endereco_w,cd_cep_w, cd_empresa_origem_w,clock_timestamp(),
			nm_usuario_p,clock_timestamp(),nm_usuario_p,null,nr_inscricao_estadual_w,
			ds_complemento_w, ds_bairro_w,ds_municipio_w,sg_estado_w,nr_ddd_telefone_w,
			nr_telefone_w,nr_fax_w,null,null,cd_municipio_ibge_w,
			null,ie_tipo_contrato_w,nr_endereco_w,ie_contrato_local_w,
			cd_tipo_logradouro_w, nm_fantasia_w)
		returning nr_sequencia into nr_seq_inter_empresa_w;
	exception
	when others then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(240408,'DS_RAZAO_SOCIAL=' || ds_razao_social_w || ';' || 'CD_CGC_CPF=' || cd_cgc_cpf_w);
	end;
	
	for i in tb_nr_seq_contrato_pf_w.first..tb_nr_seq_contrato_pf_w.last loop
		begin
		CALL ptu_gerar_intercambio_plano(nr_seq_inter_empresa_w, nm_usuario_p, cd_estabelecimento_p, tb_nr_seq_contrato_pf_w(i));
		CALL ptu_gerar_intercambio_benef(nr_seq_inter_empresa_w, nr_seq_congerene_w, cd_estabelecimento_p, nm_usuario_p, tb_nr_seq_contrato_pf_w(i));
		end;
	end loop;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_gerar_intercambio_empresa ( nr_sequencia_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) is  nm_pessoa_fisica_w varchar(255) FROM PUBLIC;

