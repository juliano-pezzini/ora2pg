-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_data_checkup ( dt_tipo_p text, nr_seq_checkup_p text, nm_usuario_p text) AS $body$
DECLARE


/*
CC - DT_CANCELAMENTO
CF - DT_CONFIRMACAO
IN - DT_INICIO_REAL
FN - DT_FIM_REAL
ES - DT_FIM_REAL := NULL
DC - DT_CANCELAMENTO := NULL
*/
qt_checkup_w		bigint;
ie_consistir_etapa_w	varchar(1);


BEGIN
if (dt_tipo_p IS NOT NULL AND dt_tipo_p::text <> '')	and (nr_seq_checkup_p IS NOT NULL AND nr_seq_checkup_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin
	ie_consistir_etapa_w := obter_param_usuario(996, 50, obter_perfil_ativo, nm_usuario_p, Obter_Estabelecimento_Ativo, ie_consistir_etapa_w);

	if (ie_consistir_etapa_w = 'S') and (upper(dt_tipo_p)	= 'FN') then
		select	count(*)
		into STRICT	qt_checkup_w
		from	checkup_etapa
		where	nr_seq_checkup = nr_seq_checkup_p
		and	coalesce(dt_fim_etapa::text, '') = ''
		and	coalesce(dt_cancelamento::text, '') = '';

		if (qt_checkup_w > 0) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(203159);
		end if;
	end if;

	if (upper(dt_tipo_p)	= 'CC') then
		begin
		update 	checkup set
			dt_cancelamento   =	clock_timestamp(),
			nm_usuario 	  =	nm_usuario_p,
			nm_usuario_cancel =	nm_usuario_p,
			dt_confirmacao 	   = NULL,
			nm_usuario_conf    = NULL
		 where  nr_sequencia 	  = 	nr_seq_checkup_p;
		 commit;
		end;
	elsif (upper(dt_tipo_p)	= 'CF') then
		begin
		update 	checkup set
			dt_confirmacao 	   = 	clock_timestamp(),
			nm_usuario_conf    =	nm_usuario_p,
			nm_usuario 	   =	nm_usuario_p,
			nm_usuario_cancel   = NULL,
			dt_cancelamento     = NULL
			where nr_sequencia = 	nr_seq_checkup_p;
		 commit;
		end;
	elsif (upper(dt_tipo_p)	= 'IN') then
		begin
		update 	checkup set
			dt_inicio_real 	   = 	clock_timestamp(),
                        nm_usuario 	   =	nm_usuario_p
			where nr_sequencia = 	nr_seq_checkup_p;
		 commit;
		end;
	elsif (upper(dt_tipo_p)	= 'FN') then
		begin
		update 	checkup set
			dt_fim_real 	   = 	clock_timestamp(),
                        nm_usuario 	   =	nm_usuario_p
			where nr_sequencia = 	nr_seq_checkup_p;
		 commit;
		end;
	elsif (upper(dt_tipo_p)	= 'ES') then
		begin
		update 	checkup set
			dt_fim_real 	    = NULL,
                        nm_usuario 	   =	nm_usuario_p
			where nr_sequencia = 	nr_seq_checkup_p;
		 commit;
		end;
	elsif (upper(dt_tipo_p)	= 'DC') then
		begin
		update 	checkup set
			dt_cancelamento    = NULL,
			nm_usuario 	  =	nm_usuario_p,
			nm_usuario_cancel  = NULL,
			dt_confirmacao 	   = NULL,
			nm_usuario_conf    = NULL
		 where  nr_sequencia 	  = 	nr_seq_checkup_p;
		 commit;
		end;
	end if;
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_data_checkup ( dt_tipo_p text, nr_seq_checkup_p text, nm_usuario_p text) FROM PUBLIC;

