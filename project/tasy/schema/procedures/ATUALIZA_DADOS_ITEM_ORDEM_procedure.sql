-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_dados_item_ordem ( nr_ordem_compra_p bigint, nm_usuario_p text, nr_item_oci_p bigint, cd_centro_custo_p text, cd_local_estoque_p text, nr_seq_conta_financ_p text, nr_seq_criterio_rateio_p text, nr_seq_marca_p text, vl_desconto_p bigint, pr_descontos_p bigint) AS $body$
DECLARE


cd_centro_custo_w		varchar(8);
cd_local_estoque_w	varchar(4);
nr_seq_conta_financ_w	varchar(10);
nr_seq_criterio_rateio_w	varchar(10);
nr_seq_marca_w		varchar(10);
vl_desconto_w		double precision;
pr_descontos_w		double precision;

ds_historico_w		varchar(4000);
ds_centro_custo_original_w	varchar(100);
ds_centro_custo_alterado_w	varchar(100);
ds_local_original_w		varchar(100);
ds_local_alterado_w	varchar(100);
ds_conta_financ_original_w	varchar(100);
ds_conta_financ_alterado_w	varchar(100);
ds_criterio_rat_original_w	varchar(100);
ds_criterio_rat_alterado_w	varchar(100);
ds_marca_original_w	varchar(255);
ds_marca_alterado_w	varchar(255);


BEGIN

select	coalesce(cd_centro_custo,'0'),
	coalesce(cd_local_estoque,'0'),
	coalesce(nr_seq_conta_financ,'0'),
	coalesce(nr_seq_criterio_rateio,'0'),
	coalesce(nr_seq_marca,'0'),
	coalesce(vl_desconto,0),
	coalesce(pr_descontos,0)
into STRICT	cd_centro_custo_w,
	cd_local_estoque_w,
	nr_seq_conta_financ_w,
	nr_seq_criterio_rateio_w,
	nr_seq_marca_w,
	vl_desconto_w,
	pr_descontos_w
from	ordem_compra_item
where	nr_ordem_compra = nr_ordem_compra_p
and	nr_item_oci = nr_item_oci_p;

if (cd_centro_custo_p <> cd_centro_custo_w) then
	update	ordem_compra_item
	set	cd_centro_custo = CASE WHEN cd_centro_custo_p='0' THEN null  ELSE cd_centro_custo_p END
	where	nr_ordem_compra = nr_ordem_compra_p
	and	nr_item_oci = nr_item_oci_p;

	select	obter_desc_centro_custo(cd_centro_custo_w),
		obter_desc_centro_custo(cd_centro_custo_p)
	into STRICT	ds_centro_custo_original_w,
		ds_centro_custo_alterado_w
	;

	/*
	Alterado o valor do campo "Centro custo" do item #@NR_ITEM_OCI#@ da ordem de compra, através da opção Alterar dados da ordem de compra.
	De: #@DS_CENTRO_CUSTO_ORIG#@.
	Para: #@DS_CENTRO_CUSTO_ALTERADO#@.
	*/
	ds_historico_w := substr(wheb_mensagem_pck.get_texto(799545,	'NR_ITEM_OCI='||nr_item_oci_p||
									';DS_CENTRO_CUSTO_ORIG='||ds_centro_custo_original_w||
									';DS_CENTRO_CUSTO_ALTERADO='||ds_centro_custo_alterado_w),1,4000);


	CALL inserir_historico_ordem_compra(	nr_ordem_compra_p,
					'S',
					wheb_mensagem_pck.get_texto(799562),--'Alteração de valor do campo "Centro custo" nos dados do item.',
					ds_historico_w,
					nm_usuario_p);
end if;

if (cd_local_estoque_p <> cd_local_estoque_w) then
	update	ordem_compra_item
	set	cd_local_estoque = CASE WHEN cd_local_estoque_p='0' THEN null  ELSE cd_local_estoque_p END
	where	nr_ordem_compra = nr_ordem_compra_p
	and	nr_item_oci = nr_item_oci_p;

	select	obter_desc_local_estoque(cd_local_estoque_w),
		obter_desc_local_estoque(cd_local_estoque_p)
	into STRICT	ds_local_original_w,
		ds_local_alterado_w
	;

	/*
	Alterado o valor do campo "Local estoque" do item #@NR_ITEM_OCI#@ da ordem de compra, através da opção Alterar dados da ordem de compra.
	De: #@DS_LOCAL_ORIG#@.
	Para: #@DS_LOCAL_ALTERADO#@.
	*/
	ds_historico_w := substr(wheb_mensagem_pck.get_texto(799563,	'NR_ITEM_OCI='||nr_item_oci_p||
									';DS_LOCAL_ORIG='||ds_local_original_w||
									';DS_LOCAL_ALTERADO='||ds_local_alterado_w),1,4000);

	CALL inserir_historico_ordem_compra(	nr_ordem_compra_p,
					'S',
					wheb_mensagem_pck.get_texto(799564),--''Alteração de valor do campo "Local estoque" nos dados do item.',
					ds_historico_w,
					nm_usuario_p);
end if;

if (nr_seq_conta_financ_p <> nr_seq_conta_financ_w) then
	update	ordem_compra_item
	set	nr_seq_conta_financ = CASE WHEN nr_seq_conta_financ_p='0' THEN null  ELSE nr_seq_conta_financ_p END
	where	nr_ordem_compra = nr_ordem_compra_p
	and	nr_item_oci = nr_item_oci_p;

	select	obter_desc_conta_financ(nr_seq_conta_financ_w),
		obter_desc_conta_financ(nr_seq_conta_financ_p)
	into STRICT	ds_conta_financ_original_w,
		ds_conta_financ_alterado_w
	;

	/*
	Alterado o valor do campo "Conta financeira" do item #@NR_ITEM_OCI#@ da ordem de compra, através da opção Alterar dados da ordem de compra.
	De: #@DS_CONTA_ORIG#@.
	Para: #@DS_CONTA_ALTERADO#@.
	*/
	ds_historico_w := substr(wheb_mensagem_pck.get_texto(799565,	'NR_ITEM_OCI='||nr_item_oci_p||
									';DS_CONTA_ORIG='||ds_conta_financ_original_w||
									';DS_CONTA_ALTERADO='||ds_conta_financ_alterado_w),1,4000);


	CALL inserir_historico_ordem_compra(	nr_ordem_compra_p,
					'S',
					wheb_mensagem_pck.get_texto(799566),--'Alteração de valor do campo "Conta financeira" nos dados do item.',
					ds_historico_w,
					nm_usuario_p);
end if;

if (nr_seq_criterio_rateio_p <> nr_seq_criterio_rateio_w) then
	update	ordem_compra_item
	set	nr_seq_criterio_rateio = CASE WHEN nr_seq_criterio_rateio_p='0' THEN null  ELSE nr_seq_criterio_rateio_p END
	where	nr_ordem_compra = nr_ordem_compra_p
	and	nr_item_oci = nr_item_oci_p;

	select	obter_desc_crit_rateio(nr_seq_criterio_rateio_w),
		obter_desc_crit_rateio(nr_seq_criterio_rateio_p)
	into STRICT	ds_criterio_rat_original_w,
		ds_criterio_rat_alterado_w
	;

	/*
	Alterado o valor do campo "Critério rateio" do item #@NR_ITEM_OCI#@ da ordem de compra, através da opção Alterar dados da ordem de compra.
	De: #@DS_CRITERIO_ORIG#@.
	Para: #@DS_CRITERIO_ALTERADO#@.
	*/
	ds_historico_w := substr(wheb_mensagem_pck.get_texto(799568,	'NR_ITEM_OCI='||nr_item_oci_p||
									';DS_CRITERIO_ORIG='||ds_criterio_rat_original_w||
									';DS_CRITERIO_ALTERADO='||ds_criterio_rat_alterado_w),1,4000);

	CALL inserir_historico_ordem_compra(	nr_ordem_compra_p,
					'S',
					wheb_mensagem_pck.get_texto(799571),--'Alteração de valor do campo "Critério rateio" nos dados do item.',
					ds_historico_w,
					nm_usuario_p);
end if;

if (nr_seq_marca_p <> nr_seq_marca_w) then
	update	ordem_compra_item
	set	nr_seq_marca = CASE WHEN nr_seq_marca_p='0' THEN null  ELSE nr_seq_marca_p END
	where	nr_ordem_compra = nr_ordem_compra_p
	and	nr_item_oci = nr_item_oci_p;

	select	obter_desc_material_marca(nr_seq_marca_w,cd_material),
		obter_desc_material_marca(nr_seq_marca_p,cd_material)
	into STRICT	ds_marca_original_w,
		ds_marca_alterado_w
	from	ordem_compra_item
	where	nr_ordem_compra = nr_ordem_compra_p
	and	nr_item_oci = nr_item_oci_p;

	/*
	Alterado o valor do campo "Marca" do item #@NR_ITEM_OCI#@ da ordem de compra, através da opção Alterar dados da ordem de compra.
	De: #@DS_MARCA_ORIG#@.
	Para: #@DS_MARCA_ALTERADO#@.
	*/
	ds_historico_w := substr(wheb_mensagem_pck.get_texto(799572,	'NR_ITEM_OCI='||nr_item_oci_p||
									';DS_MARCA_ORIG='||ds_marca_original_w||
									';DS_MARCA_ALTERADO='||ds_marca_alterado_w),1,4000);

	CALL inserir_historico_ordem_compra(	nr_ordem_compra_p,
					'S',
					wheb_mensagem_pck.get_texto(799573),--'Alteração de valor do campo "Marca" nos dados do item.',
					ds_historico_w,
					nm_usuario_p);
end if;

if (vl_desconto_w <> vl_desconto_p) or (pr_descontos_w <> pr_descontos_p) then

	update	ordem_compra_item
	set	vl_desconto = vl_desconto_p,
		pr_descontos = pr_descontos_p
	where	nr_ordem_compra = nr_ordem_compra_p
	and	nr_item_oci = nr_item_oci_p;

	/*
	Alterado o valor do campo "Vl. desconto" e do campo "%Desconto" do item #@NR_ITEM_OCI_P#@ da ordem de compra, através da opção Alterar dados da ordem de compra.
	Valor desconto de: #@VL_DESCONTO_W#@.
	Para: #@VL_DESCONTO_P#@.
	% desconto de: #@PR_DESCONTOS_W#@.
	Para: #@PR_DESCONTOS_P#@.
	*/
	ds_historico_w := substr(wheb_mensagem_pck.get_texto(799597,	'NR_ITEM_OCI='||nr_item_oci_p||
									';VL_DESCONTO_W='||campo_mascara_virgula_casas(vl_desconto_w,2)||
									';VL_DESCONTO_P='||campo_mascara_virgula_casas(vl_desconto_p,2)||
									';PR_DESCONTOS_W='||campo_mascara_virgula_casas(pr_descontos_w,4)||
									';PR_DESCONTOS_P='||campo_mascara_virgula_casas(pr_descontos_p,2)),1,4000);


	CALL inserir_historico_ordem_compra(	nr_ordem_compra_p,
					'S',
					wheb_mensagem_pck.get_texto(799599),--'Alteração de valor do campo "Vl. Desconto" e "% Desconto" nos dados do item.',
					ds_historico_w,
					nm_usuario_p);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_dados_item_ordem ( nr_ordem_compra_p bigint, nm_usuario_p text, nr_item_oci_p bigint, cd_centro_custo_p text, cd_local_estoque_p text, nr_seq_conta_financ_p text, nr_seq_criterio_rateio_p text, nr_seq_marca_p text, vl_desconto_p bigint, pr_descontos_p bigint) FROM PUBLIC;

