-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE import_nurse_shift_user_daily ( nr_sequence_p bigint, dt_month_year_p text, cd_ward_department_p text, cd_staff_id_p text, cd_order_display_p text, cd_team_p text, cd_start_date_p text, cd_end_date_p text, cd_staff_name_p text, cd_kana_name_p text, dt_posture_start_p text, dt_poture_end_p text, cd_position_p text, dt_hiring_start_p text, dt_hiring_end_p text, cd_recurutment_p text, dt_job_type_start_p text, dt_job_type_end_p text, cd_job_p text, dt_placement_start_p text, dt_placement_end_p text, cd_ward_department2_p text, cd_ward_department3_p text, dt_month_year_working_p text, cd_work_code_p text, assoc_dt_acq_p text, nurse_lis_aq_p text, cd_update_p text, dt_update_p text, hr_update_p text) AS $body$
BEGIN

declare

cont_start_w bigint := 0;
cont_end_w bigint := 0;
data_ini_w timestamp;
work_code_w varchar(200) := cd_work_code_p;
work_code_w_indi varchar(120);
nr_seq_master_shift_w bigint;
nr_seq_nurse_shift_w  bigint;
nr_sequencia_w bigint;
nr_sequence_daily_w bigint;
nr_sequencia_log_w bigint;

type v_work_code is varray(1000) of varchar(3);
array_work_code_w v_work_code := v_work_code();

day_1 varchar(2) := null;day_2 varchar(2) := null;day_3 varchar(2) := null;day_4 varchar(2) := null;day_5 varchar(2) := null;
day_6 varchar(2) := null;day_7 varchar(2) := null;day_8 varchar(2) := null;day_9 varchar(2) := null;day_10 varchar(2) := null;
day_11 varchar(2) := null;day_12 varchar(2) := null;day_13 varchar(2) := null;day_14 varchar(2) := null;day_15 varchar(2) := null;
day_16 varchar(2) := null;day_17 varchar(2) := null;day_18 varchar(2) := null;day_19 varchar(2) := null;day_20 varchar(2) := null;
day_21 varchar(2) := null;day_22 varchar(2) := null;day_23 varchar(2) := null;day_24 varchar(2) := null;day_25 varchar(2) := null;
day_26 varchar(2) := null;day_27 varchar(2) := null;day_28 varchar(2) := null;day_29 varchar(2) := null;day_30 varchar(2) := null;
day_31 varchar(2) := null;

begin

data_ini_w := to_date (( substr(dt_posture_start_p, 0, 6)||'01' ),'yyyy-mm-dd');

day_1 := trim(both substr(work_code_w, 1, 2)); day_2 := trim(both substr(work_code_w, 3, 2)); day_3 := trim(both substr(work_code_w, 5, 2)); day_4 := trim(both substr(work_code_w, 7, 2)); day_5 := trim(both substr(work_code_w, 9, 2));
day_6 := trim(both substr(work_code_w, 11, 2)); day_7 := trim(both substr(work_code_w, 13, 2)); day_8 := trim(both substr(work_code_w, 15, 2)); day_9 := trim(both substr(work_code_w, 17, 2)); day_10 := trim(both substr(work_code_w, 19, 2));
day_11 := trim(both substr(work_code_w, 21, 2)); day_12 := trim(both substr(work_code_w, 23, 2)); day_13 := trim(both substr(work_code_w, 25, 2)); day_14 := trim(both substr(work_code_w, 27, 2)); day_15 := trim(both substr(work_code_w, 29, 2));
day_16 := trim(both substr(work_code_w, 31, 2)); day_17 := trim(both substr(work_code_w, 33, 2)); day_18 := trim(both substr(work_code_w, 35, 2)); day_19 := trim(both substr(work_code_w, 37, 2)); day_20 := trim(both substr(work_code_w, 39, 2));
day_21 := trim(both substr(work_code_w, 41, 2)); day_22 := trim(both substr(work_code_w, 43, 2)); day_23 := trim(both substr(work_code_w, 45, 2)); day_24 := trim(both substr(work_code_w, 47, 2)); day_25 := trim(both substr(work_code_w, 49, 2));
day_26 := trim(both substr(work_code_w, 51, 2)); day_27 := trim(both substr(work_code_w, 53, 2)); day_28 := trim(both substr(work_code_w, 55, 2)); day_29 := trim(both substr(work_code_w, 57, 2)); day_30 := trim(both substr(work_code_w, 59, 2));
day_31 := trim(both substr(work_code_w, 61, 2));

array_work_code_w := v_work_code(day_1, day_2, day_3, day_4, day_5, day_6, day_7, day_8, day_9, day_10, 
                                 day_11, day_12, day_13, day_14, day_15, day_16, day_17, day_18, day_19, day_20, 
                                 day_21, day_22, day_23, day_24, day_25, day_26, day_27, day_28, day_29, day_30, 
                                 day_31);


if (day_1 IS NOT NULL AND day_1::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_2 IS NOT NULL AND day_2::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_3 IS NOT NULL AND day_3::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_4 IS NOT NULL AND day_4::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_5 IS NOT NULL AND day_5::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_6 IS NOT NULL AND day_6::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_7 IS NOT NULL AND day_7::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_8 IS NOT NULL AND day_8::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_9 IS NOT NULL AND day_9::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_10 IS NOT NULL AND day_10::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_11 IS NOT NULL AND day_11::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_12 IS NOT NULL AND day_12::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_13 IS NOT NULL AND day_13::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_14 IS NOT NULL AND day_14::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_15 IS NOT NULL AND day_15::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_16 IS NOT NULL AND day_16::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_17 IS NOT NULL AND day_17::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_18 IS NOT NULL AND day_18::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_19 IS NOT NULL AND day_19::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_20 IS NOT NULL AND day_20::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_21 IS NOT NULL AND day_21::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_22 IS NOT NULL AND day_22::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_23 IS NOT NULL AND day_23::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_24 IS NOT NULL AND day_24::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_25 IS NOT NULL AND day_25::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_26 IS NOT NULL AND day_26::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_27 IS NOT NULL AND day_27::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_28 IS NOT NULL AND day_28::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_29 IS NOT NULL AND day_29::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_30 IS NOT NULL AND day_30::text <> '') then cont_end_w := cont_end_w+1; end if;
if (day_31 IS NOT NULL AND day_31::text <> '') then cont_end_w := cont_end_w+1; end if;


while cont_start_w < 31
loop
if ((array_work_code_w(cont_start_w+1) IS NOT NULL AND (array_work_code_w(cont_start_w+1))::text <> ''))
then

select      max(coalesce(nr_sequencia,0))
into STRICT        nr_seq_master_shift_w
from        shift_master
where       cd_shift                =       array_work_code_w(cont_start_w+1);

select      coalesce(max(nr_sequencia),0)
into STRICT        nr_sequencia_w 
from        nurse_shift_user_daily
where       nr_seq_nurse_shift      =       nr_sequence_p
and         dt_work                 =       to_date(data_ini_w,'dd/mm/yyyy');

if (nr_sequencia_w = 0)
then


select      nextval('nurse_shift_user_daily_seq')
into STRICT        nr_sequence_daily_w
;


insert into nurse_shift_user_daily(
                        nr_sequencia,
                        dt_atualizacao, 
                        nm_usuario, 
                        dt_atualizacao_nrec, 
                        nm_usuario_nrec, 
                        cd_staff_id, 
                        cd_job, 
                        cd_work_code, 
                        dt_work, 
                        dt_month_year, 
                        nr_seq_master_shift, 
                        nr_seq_nurse_shift)
                        values (
                                nr_sequence_daily_w, 
                                to_date(clock_timestamp(),'dd/mm/yyyy'), 
                                'user teste', 
                                to_date(clock_timestamp(),'dd/mm/yyyy'),
                                null, 
                                cd_staff_id_p,
                                cd_job_p, 
                                array_work_code_w(cont_start_w+1),
                                to_date(data_ini_w,'dd/mm/yyyy'), 
                                to_char(to_date(dt_month_year_p, 'yyyymmdd'), 'dd/mm/yyyy'),
                                nr_seq_master_shift_w, 
                                nr_sequence_p);

else


nr_sequence_daily_w := nr_sequencia_w;

update      nurse_shift_user_daily
set         cd_work_code            =   array_work_code_w(cont_start_w+1),
            nr_seq_nurse_shift      =   nr_sequence_p
where       dt_work                 =   to_date(data_ini_w,'dd/mm/yyyy')
--and         nr_seq_nurse_shift = nr_sequence_p; 
and         nr_sequencia = nr_sequence_daily_w;

commit;

end if;

select      coalesce(max(nr_sequencia),0)
into STRICT        nr_sequencia_log_w 
from        nurse_shift_user_daily_log
where       nr_seq_shift_daily   =   nr_sequencia_w
and         dt_work              =   to_date(data_ini_w,'dd/mm/yyyy')
and         cd_work_code         =   array_work_code_w(cont_start_w+1);

if (nr_sequencia_log_w = 0)
then


select      nextval('nurse_shift_user_daily_log_seq')
into STRICT        nr_sequencia_log_w
;

insert into nurse_shift_user_daily_log(
                        nr_sequencia,
                        dt_atualizacao, 
                        dt_atualizacao_nrec, 
                        cd_work_code, 
                        dt_work, 
                        nr_seq_shift_daily
                        )values (
                            nr_sequencia_log_w, 
                            clock_timestamp(), 
                            clock_timestamp(), 
                            array_work_code_w(cont_start_w+1), 
                            to_date(data_ini_w,'dd/mm/yyyy'), 
                            nr_sequence_daily_w
                            );
end if;

cont_start_w := cont_start_w+1;
data_ini_w := (to_date(data_ini_w)+1);
else
cont_start_w := cont_start_w+1;
data_ini_w := (to_date(data_ini_w)+1);
end if;
end loop;


end;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE import_nurse_shift_user_daily ( nr_sequence_p bigint, dt_month_year_p text, cd_ward_department_p text, cd_staff_id_p text, cd_order_display_p text, cd_team_p text, cd_start_date_p text, cd_end_date_p text, cd_staff_name_p text, cd_kana_name_p text, dt_posture_start_p text, dt_poture_end_p text, cd_position_p text, dt_hiring_start_p text, dt_hiring_end_p text, cd_recurutment_p text, dt_job_type_start_p text, dt_job_type_end_p text, cd_job_p text, dt_placement_start_p text, dt_placement_end_p text, cd_ward_department2_p text, cd_ward_department3_p text, dt_month_year_working_p text, cd_work_code_p text, assoc_dt_acq_p text, nurse_lis_aq_p text, cd_update_p text, dt_update_p text, hr_update_p text) FROM PUBLIC;

