-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pfcs_detailed_discontinuation ( nr_seq_indicator_p bigint, cd_estabelecimento_p text, nm_usuario_p text) AS $body$
DECLARE


ie_active_w 								varchar(1) := '1';
ds_active_status_w					varchar(15) := 'ACTIVE';
ds_inactive_status_w				varchar(15) := 'INACTIVE';
ds_planned_status_w					varchar(15) := 'PLANNED';
ds_arrived_status_w					varchar(15) := 'ARRIVED';
ds_service_requested_w      varchar(10) := 'E0403';
ds_service_completed_w      varchar(10) := 'E0404';
ds_service_status_w				  varchar(15) := 'COMPLETED';
ds_monitor_dev_type_w 			varchar(10) := 'Monitor';
nr_seq_panel_w							pfcs_panel.nr_sequencia%type;
qt_time_telemetry_rule_w	  pfcs_telemetry_config.qt_time_on_tele__rule%type;

cur_get_tot_review_pfcs CURSOR FOR
	SELECT ds_unit,
		sum(qt_orders_written) qt_orders_written,
		sum(qt_patients_to_review) qt_patients_to_review
    from (
        SELECT loc.ds_department ds_unit,
        count(enc.nr_sequencia)  qt_orders_written,
        0 qt_patients_to_review
        from pfcs_service_request sr,
          pfcs_encounter enc,
          pfcs_patient pat,
          pfcs_encounter_identifier eid,
          pfcs_encounter_location el,
          pfcs_location loc,
          pfcs_device pd,
          pfcs_organization org
        where
          sr.si_status =  ds_active_status_w
          and sr.cd_service = ds_service_requested_w
          and sr.nr_seq_encounter = enc.nr_sequencia
          and enc.si_status in (ds_planned_status_w, ds_arrived_status_w)
          and eid.nr_seq_encounter = enc.nr_sequencia
          and el.nr_seq_encounter = enc.nr_sequencia
          and el.nr_seq_location = loc.nr_sequencia
          and enc.nr_seq_patient = pat.nr_sequencia
          and pat.ie_active = ie_active_w
          and pat.nr_seq_organization = org.nr_sequencia
          and org.cd_estabelecimento = (cd_estabelecimento_p)::numeric
          and pat.nr_sequencia = pd.nr_seq_patient
          and loc.si_status = ds_active_status_w
          and pd.si_status = ds_active_status_w
          and pd.ds_device_type = ds_monitor_dev_type_w
        group by loc.ds_department
      
union

        select loc.ds_department ds_unit,
          0 qt_orders_written,
          count(enc.nr_sequencia) qt_patients_to_review
        from pfcs_service_request sr,
          pfcs_encounter enc,
          pfcs_patient pat,
          pfcs_encounter_identifier eid,
          pfcs_encounter_location el,
          pfcs_location loc,
          pfcs_device pd,
          pfcs_organization org
    where sr.si_status = ds_service_status_w
          and sr.cd_service = ds_service_completed_w
          and sr.nr_seq_encounter = enc.nr_sequencia
          and enc.si_status in (ds_planned_status_w, ds_arrived_status_w)
          and eid.nr_seq_encounter = enc.nr_sequencia
          and el.nr_seq_encounter = enc.nr_sequencia
          and el.nr_seq_location = loc.nr_sequencia
          and enc.nr_seq_patient = pat.nr_sequencia
          and pat.ie_active = ie_active_w
          and pat.nr_seq_organization = org.nr_sequencia
          and org.cd_estabelecimento = (cd_estabelecimento_p)::numeric 
          and pat.nr_sequencia = pd.nr_seq_patient
          and loc.si_status = ds_active_status_w
          and pd.si_status = ds_active_status_w
          and pd.ds_device_type = ds_monitor_dev_type_w
		  and pfcs_get_tele_time(pd.nr_sequencia, 'S') > (qt_time_telemetry_rule_w * 60)
          group by loc.ds_department) alias10
      group by ds_unit;

BEGIN
	-- Get hours configurable from telemetry settings
	select	qt_time_on_tele__rule
	into STRICT	qt_time_telemetry_rule_w
	from	pfcs_telemetry_config;

	for c01_w in cur_get_tot_review_pfcs loop

       := pfcs_pck_v2.pfcs_generate_results(
        vl_indicator_p => c01_w.qt_orders_written, vl_indicator_aux_p => c01_w.qt_patients_to_review, ds_reference_value_p => c01_w.ds_unit, nr_seq_indicator_p => nr_seq_indicator_p, nr_seq_operational_level_p => (cd_estabelecimento_p)::numeric , nm_usuario_p => nm_usuario_p, nr_seq_panel_p => nr_seq_panel_w);

	end loop;

commit;

  CALL pfcs_pck_v2.pfcs_activate_records(
    nr_seq_indicator_p => nr_seq_indicator_p,
    nr_seq_operational_level_p => (cd_estabelecimento_p)::numeric ,
    nm_usuario_p => nm_usuario_p );

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_detailed_discontinuation ( nr_seq_indicator_p bigint, cd_estabelecimento_p text, nm_usuario_p text) FROM PUBLIC;

