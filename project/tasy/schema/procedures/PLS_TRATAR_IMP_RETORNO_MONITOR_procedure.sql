-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_tratar_imp_retorno_monitor ( nr_seq_lote_monitor_ret_p pls_monitor_tiss_lote_ret.nr_sequencia%type, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

			
qt_inicial_w			bigint;
qt_final_w			bigint;			
----------------------------------------------------------------------------------------------------------------------------------------
ie_tipo_registro_w		pls_monitor_tiss_guia_ret.ie_tipo_registro%type;
cd_cnes_prest_exec_w		pls_monitor_tiss_guia_ret.cd_cnes_prest_exec%type;
cpf_cgc_prest_exec_w 		pls_monitor_tiss_guia_ret.cd_cpf_cgc_prest_exec%type;
cd_guia_operadora_w		pls_monitor_tiss_guia_ret.cd_guia_operadora%type;
cd_guia_prestador_w		pls_monitor_tiss_guia_ret.cd_guia_prestador%type;
dt_processamento_w		pls_monitor_tiss_guia_ret.dt_processamento%type;
dt_processamento_ww		varchar(10);
ie_identif_prest_exec_w		pls_monitor_tiss_guia_ret.ie_identif_prest_exec%type;
ie_reembolso_w			pls_monitor_tiss_guia_ret.ie_reembolso%type;
nr_lote_w			pls_monitor_tiss_lote_ret.nr_lote%type;
nr_seq_guia_ret_w		pls_monitor_tiss_guia_ret.nr_sequencia%type;
ds_xml_aux_w			w_pls_monitor_ans_ret.ds_xml%type;
----------------------------------------------------------------------------------------------------------------------------------------
cd_glosa_w			pls_monitor_tiss_glosa.cd_glosa%type;
nr_campo_arquivo_w		pls_monitor_tiss_glosa.nr_campo_arquivo%type;
----------------------------------------------------------------------------------------------------------------------------------------
cd_grupo_proc_w			pls_monitor_tiss_proc_ret.cd_grupo_proc%type;
cd_procedimento_w		pls_monitor_tiss_proc_ret.cd_procedimento%type;
cd_tabela_ref_w			pls_monitor_tiss_proc_ret.cd_tabela_ref%type;
cd_dente_w	  		pls_monitor_tiss_proc_ret.cd_dente%type;
cd_face_dente_w  		pls_monitor_tiss_proc_ret.cd_face_dente%type;
cd_regiao_boca_w 		pls_monitor_tiss_proc_ret.cd_regiao_boca%type;
nr_seq_proc_ret_w		pls_monitor_tiss_proc_ret.nr_sequencia%type;
isAcabouLinhasGlosaItem_w	boolean;
nr_proc_w			integer;
nr_erro_w			integer;
nr_falha_w			integer;
nr_tag_proc_w			integer;
nr_tag_erro_w			integer;	
nr_tag_falha_w			integer;
nr_tag_falha_tst_w	integer;
ds_proc_w			text;
ds_guia_w			text;
ds_falha_w			text;
ie_fornec_direto_w		pls_monitor_tiss_lote.ie_fornec_direto%type;
ie_identif_fornec_w		varchar(100);
ie_tipo_lote_w			varchar(1) := 'G';
nm_ultima_tag_lida		varchar(255) := '';
ds_log_w			varchar(4000);
ds_msg_conclusao_w		varchar(4000);
nr_seq_lote_com_w		pls_monitor_tiss_lote_com.nr_sequencia%type;
nm_arquivo_envio_w		pls_monitor_tiss_lote_ret.nm_arquivo%type;
prossegue_w			varchar(1) := 'S';
nr_lote_envio_w			pls_monitor_tiss_lote.nr_sequencia%type;
nr_seq_arquivo_w		pls_monitor_tiss_lote_ret.nr_seq_arquivo%type;
nr_seq_lote_monitor_arq_w  pls_monitor_tiss_arquivo.nr_sequencia%type;
ie_tipo_envio_w				pls_monitor_tiss_lote.ie_tipo_lote%type;

C01 CURSOR FOR
	SELECT	upper(ds_xml) ds_xml
	from	w_pls_monitor_ans_ret;
procedure ajusta_status_agrup(	nr_seq_lote_monitor_ret_pc	pls_monitor_tiss_lote_ret.nr_sequencia%type,
				nr_seq_lote_monitor_arq_pc  pls_monitor_tiss_arquivo.nr_sequencia%type) is

C01 CURSOR FOR 
	SELECT   z.nr_sequencia,
			trunc(z.dt_evento,'MM') dt_ini,
			fim_mes(z.dt_evento) dt_fim,
			z.nr_seq_conta
	from  	pls_monitor_tiss_guia_ret   b,
			pls_monitor_tiss_alt_guia   a,
			pls_monitor_tiss_alt     z,
			pls_monitor_tiss_guia    d
	where   b.nr_seq_lote_monitor_ret   = nr_seq_lote_monitor_ret_pc
	and  d.nr_seq_arq_monitor    = nr_seq_lote_monitor_arq_pc
	and  a.nr_seq_guia_monitor    = b.nr_seq_guia_monitor
	and  z.nr_sequencia       = a.nr_seq_cta_alt
	and  a.nr_seq_guia_monitor    = d.nr_sequencia
	and	 z.ie_tipo_evento = 'PC';

C02 CURSOR(	dt_ini_pc			pls_monitor_tiss_lote.dt_mes_competencia%type,
			dt_fim_pc			pls_monitor_tiss_lote.dt_mes_competencia%type,
			nr_seq_conta_pc		pls_conta.nr_sequencia%type) FOR
	SELECT  nr_sequencia
	from	pls_monitor_tiss_alt
	where 	dt_evento between dt_ini_pc and dt_fim_pc
	and 	nr_seq_conta = nr_seq_conta_pc
	and 	ie_tipo_evento in ('PR','PD')
	and 	ie_status =  'AG';

BEGIN
	
	for r_c01_w in C01 loop
		
		for r_c02_w in C02(r_c01_w.dt_ini, r_c01_w.dt_fim, r_c01_w.nr_seq_conta) loop
		
			update	pls_monitor_tiss_alt
			set 	ie_status = 'N'
			where 	nr_sequencia = r_c02_w.nr_sequencia;
		
		end loop;
		commit;
	
	end loop;

end;

begin

select	coalesce(max(c.ie_fornec_direto),'N'),
	max(a.nr_sequencia),
	max(nm_arquivo),
	max(c.nr_sequencia) nr_lote_envio,
	max(nr_seq_arquivo)
into STRICT	ie_fornec_direto_w,
	nr_seq_lote_com_w,
	nm_arquivo_envio_w,
	nr_lote_envio_w,
	nr_seq_arquivo_w
from	pls_monitor_tiss_lote_com a,
	pls_monitor_tiss_lote_ret b,
	pls_monitor_tiss_lote c
where	a.nr_sequencia = b.nr_seq_lote_com
and	b.nr_sequencia = nr_seq_lote_monitor_ret_p
and 	a.nr_seq_lote_monitor = c.nr_sequencia;

select  max(b.nr_sequencia),
		max(ie_tipo_lote)
into STRICT  nr_seq_lote_monitor_arq_w,
		ie_tipo_envio_w
from  	pls_monitor_tiss_lote a,
		pls_monitor_tiss_arquivo b
where  a.ie_status    = 'LG'
and  b.nr_seq_lote_monitor  = a.nr_sequencia
and  b.nm_arquivo    = nm_arquivo_envio_w;

if (nm_arquivo_envio_w IS NOT NULL AND nm_arquivo_envio_w::text <> '') then

	select 	coalesce(CASE WHEN count(1)=0 THEN  'S'  ELSE 'N' END ,'S')
	into STRICT	prossegue_w
	from	pls_monitor_tiss_arquivo
	where 	nr_seq_lote_monitor = nr_lote_envio_w
	and 	ds_nome_anterior = nm_arquivo_envio_w;

end if;

if ( prossegue_w = 'S') then
	for r_c01_w in c01 loop

		-- retorno do lote normal de monitoramento
		if (ie_fornec_direto_w = 'N') then
			ie_tipo_lote_w			:= 'G';
			ie_tipo_registro_w		:= '';
			cd_cnes_prest_exec_w		:= '';
			cpf_cgc_prest_exec_w 		:= '';
			cd_guia_operadora_w		:= '';
			cd_guia_prestador_w		:= '';
			dt_processamento_w		:= '';
			ie_identif_prest_exec_w		:= '';
			ie_reembolso_w			:= '';
			nr_lote_w			:= '';
			nr_seq_guia_ret_w		:= '';
			nr_proc_w			:= 1;
			nr_erro_w			:= 1;
			nr_falha_w			:= 1;
			
			begin
				if (position('<ANS:TIPOREGISTRO>' in r_c01_w.ds_xml) > 0) and (position('</ANS:TIPOREGISTRO>' in r_c01_w.ds_xml) > 0) then
					
					nm_ultima_tag_lida := 'ANS:TIPOREGISTRO';
					qt_inicial_w		:= position('<ANS:TIPOREGISTRO>' in r_c01_w.ds_xml)+18;
					qt_final_w		:= position('</ANS:TIPOREGISTRO>' in r_c01_w.ds_xml) - qt_inicial_w;
					ie_tipo_registro_w	:= substr(r_c01_w.ds_xml,qt_inicial_w,qt_final_w);
				end if;
				
				if (position('<ANS:CNES>' in r_c01_w.ds_xml)  > 0) and (position('</ANS:CNES>' in r_c01_w.ds_xml) > 0) then
					nm_ultima_tag_lida := 'ANS:CNES';
					qt_inicial_w		:= position('<ANS:CNES>' in r_c01_w.ds_xml)+10;
					qt_final_w		:= position('</ANS:CNES>' in r_c01_w.ds_xml)-qt_inicial_w;
					cd_cnes_prest_exec_w	:= substr(r_c01_w.ds_xml,qt_inicial_w,qt_final_w);
				end if;
				
				if (position('<ANS:IDENTIFICADOREXECUTANTE>' in r_c01_w.ds_xml)  > 0) and (position('</ANS:IDENTIFICADOREXECUTANTE>' in r_c01_w.ds_xml) > 0) then
					nm_ultima_tag_lida := 'ANS:IDENTIFICADOREXECUTANTE';
					qt_inicial_w		:= position('<ANS:IDENTIFICADOREXECUTANTE>' in r_c01_w.ds_xml)+29;
					qt_final_w		:= position('</ANS:IDENTIFICADOREXECUTANTE>' in r_c01_w.ds_xml)-qt_inicial_w;
					ie_identif_prest_exec_w	:= substr(r_c01_w.ds_xml,qt_inicial_w,qt_final_w);
				end if;
				
				if (position('<ANS:CODIGOCNPJ_CPF>' in r_c01_w.ds_xml)  > 0) and (position('</ANS:CODIGOCNPJ_CPF>' in r_c01_w.ds_xml) > 0) then
					nm_ultima_tag_lida := 'ANS:CODIGOCNPJ_CPF';
					qt_inicial_w		:= position('<ANS:CODIGOCNPJ_CPF>' in r_c01_w.ds_xml)+20;
					qt_final_w		:= position('</ANS:CODIGOCNPJ_CPF>' in r_c01_w.ds_xml)-qt_inicial_w;
					cpf_cgc_prest_exec_w	:= substr(r_c01_w.ds_xml,qt_inicial_w,qt_final_w);
				end if;
				
				if (position('<ANS:NUMEROGUIAPRESTADOR>' in r_c01_w.ds_xml)  > 0) and (position('</ANS:NUMEROGUIAPRESTADOR>' in r_c01_w.ds_xml) > 0) then
					nm_ultima_tag_lida := 'ANS:NUMEROGUIAPRESTADOR';
					qt_inicial_w		:= position('<ANS:NUMEROGUIAPRESTADOR>' in r_c01_w.ds_xml)+25;
					qt_final_w		:= position('</ANS:NUMEROGUIAPRESTADOR>' in r_c01_w.ds_xml)-qt_inicial_w;
					cd_guia_prestador_w	:= substr(r_c01_w.ds_xml,qt_inicial_w,qt_final_w);
				end if;
				
				if (position('<ANS:NUMEROGUIAOPERADORA>' in r_c01_w.ds_xml)  > 0) and (position('</ANS:NUMEROGUIAOPERADORA>' in r_c01_w.ds_xml) > 0) then
					nm_ultima_tag_lida := 'ANS:NUMEROGUIAOPERADORA';
					qt_inicial_w		:= position('<ANS:NUMEROGUIAOPERADORA>' in r_c01_w.ds_xml)+25;
					qt_final_w		:= position('</ANS:NUMEROGUIAOPERADORA>' in r_c01_w.ds_xml)-qt_inicial_w;
					cd_guia_operadora_w	:= substr(r_c01_w.ds_xml,qt_inicial_w,qt_final_w);
				end if;
				
				if (position('<ANS:IDENTIFICADORREEMBOLSO>' in r_c01_w.ds_xml)  > 0) and (position('</ANS:IDENTIFICADORREEMBOLSO>' in r_c01_w.ds_xml) > 0) then
					nm_ultima_tag_lida := 'ANS:IDENTIFICADORREEMBOLSO';
					qt_inicial_w		:= position('<ANS:IDENTIFICADORREEMBOLSO>' in r_c01_w.ds_xml)+28;
					qt_final_w		:= position('</ANS:IDENTIFICADORREEMBOLSO>' in r_c01_w.ds_xml)-qt_inicial_w;
					ie_reembolso_w		:= substr(r_c01_w.ds_xml,qt_inicial_w,qt_final_w);
				end if;
				
				if (position('<ANS:DATAPROCESSAMENTO>' in r_c01_w.ds_xml)  > 0) and (position('</ANS:DATAPROCESSAMENTO>' in r_c01_w.ds_xml) > 0) then
					nm_ultima_tag_lida := 'ANS:DATAPROCESSAMENTO';
					qt_inicial_w		:= position('<ANS:DATAPROCESSAMENTO>' in r_c01_w.ds_xml)+23;
					qt_final_w		:= position('</ANS:DATAPROCESSAMENTO>' in r_c01_w.ds_xml)-qt_inicial_w;
					dt_processamento_ww	:= substr(r_c01_w.ds_xml,qt_inicial_w,qt_final_w);
					
					dt_processamento_ww	:= replace(dt_processamento_ww,'-','');
					if (dt_processamento_ww IS NOT NULL AND dt_processamento_ww::text <> '') then
						dt_processamento_ww		:= substr(dt_processamento_ww,7,2) || substr(dt_processamento_ww,5,2) || substr(dt_processamento_ww,1,4);
						dt_processamento_w		:= to_date(dt_processamento_ww);
					end if;
				end if;

				nr_seq_guia_ret_w := pls_gerencia_envio_ans_pck.gerar_guia_ret_monitor(	nr_seq_lote_monitor_ret_p, cd_cnes_prest_exec_w, cpf_cgc_prest_exec_w, cd_guia_operadora_w, cd_guia_prestador_w, dt_processamento_w, ie_identif_prest_exec_w, ie_reembolso_w, nr_lote_w, nm_usuario_p, ie_tipo_registro_w, null, 'G', nr_seq_guia_ret_w);
										
				ds_xml_aux_w	:= r_c01_w.ds_xml;
										
				while(position('<ANS:ERROSGUIA>' in ds_xml_aux_w)  > 0) and (position('</ANS:ERROSGUIA>' in ds_xml_aux_w) > 0) loop
					
					nm_ultima_tag_lida := 'ANS:ERROSGUIA';
					cd_glosa_w		:= '';
					nr_campo_arquivo_w	:= '';
					
					if (position('<ANS:IDENTIFICADORCAMPO>' in ds_xml_aux_w)  > 0) and (position('</ANS:IDENTIFICADORCAMPO>' in ds_xml_aux_w) > 0) then
						nm_ultima_tag_lida := 'ANS:IDENTIFICADORCAMPO';
						qt_inicial_w		:= position('<ANS:IDENTIFICADORCAMPO>' in ds_xml_aux_w)+24;
						qt_final_w		:= position('</ANS:IDENTIFICADORCAMPO>' in ds_xml_aux_w)-qt_inicial_w;
						nr_campo_arquivo_w	:= substr(ds_xml_aux_w,qt_inicial_w,qt_final_w);
					end if;
					
					if (position('<ANS:CODIGOERRO>' in ds_xml_aux_w)  > 0) and (position('</ANS:CODIGOERRO>' in ds_xml_aux_w) > 0) then
						nm_ultima_tag_lida := 'ANS:CODIGOERRO';
						qt_inicial_w		:= position('<ANS:CODIGOERRO>' in ds_xml_aux_w)+16;
						qt_final_w		:= position('</ANS:CODIGOERRO>' in ds_xml_aux_w)-qt_inicial_w;
						cd_glosa_w		:= substr(ds_xml_aux_w,qt_inicial_w,qt_final_w);
					end if;
					
					CALL pls_gerencia_envio_ans_pck.gerar_glosa_ret_monitor(nr_seq_guia_ret_w,null,null,cd_glosa_w,nr_campo_arquivo_w,nm_usuario_p);
					
					ds_xml_aux_w	:= substr(ds_xml_aux_w,position('</ANS:ERROSGUIA>' in ds_xml_aux_w)+16,length(r_c01_w.ds_xml));
				end loop;
				
				ds_guia_w := pls_util_pck.obter_conteudo_tag(r_c01_w.ds_xml,'ANS:ERROSITENSGUIA',nr_erro_w);
				
				nr_tag_erro_w	:= pls_util_pck.obter_numero_tag(r_c01_w.ds_xml,'ANS:ERROSITENSGUIA');
				
				while(nr_erro_w <= nr_tag_erro_w) loop
					
					nm_ultima_tag_lida := 'ANS:IDENTPROCEDIMENTO';
					ds_proc_w	:= pls_util_pck.obter_conteudo_tag(ds_guia_w,'ANS:IDENTPROCEDIMENTO',nr_erro_w);
					nm_ultima_tag_lida := 'ANS:CODIGOTABELA';
					cd_tabela_ref_w	:= pls_util_pck.obter_conteudo_tag(ds_proc_w,'ANS:CODIGOTABELA',1);
					nm_ultima_tag_lida := 'ANS:GRUPOPROCEDIMENTO';
					cd_grupo_proc_w	:= pls_util_pck.obter_conteudo_tag(ds_proc_w,'ANS:GRUPOPROCEDIMENTO',1);
					nm_ultima_tag_lida := 'ANS:CODIGOPROCEDIMENTO';
					cd_procedimento_w:=pls_util_pck.converte_numero(pls_util_pck.obter_conteudo_tag(ds_proc_w,'ANS:CODIGOPROCEDIMENTO',1));
					nm_ultima_tag_lida := 'ANS:CODDENTE';
					cd_dente_w	:= pls_util_pck.obter_conteudo_tag(ds_proc_w,'ANS:CODDENTE',1);
					nm_ultima_tag_lida := 'ANS:CODREGIAO';
					cd_regiao_boca_w:= pls_util_pck.obter_conteudo_tag(ds_proc_w,'ANS:CODREGIAO',1);
					nm_ultima_tag_lida := 'ANS:DENTEFACE';
					cd_face_dente_w	:= pls_util_pck.obter_conteudo_tag(ds_proc_w,'ANS:DENTEFACE',1);
				
					nr_seq_proc_ret_w := pls_gerencia_envio_ans_pck.gerar_proc_ret_monitor(	nr_seq_guia_ret_w, cd_grupo_proc_w, cd_procedimento_w, cd_tabela_ref_w, cd_dente_w, cd_face_dente_w, cd_regiao_boca_w, nm_usuario_p, nr_seq_proc_ret_w);
									
					nm_ultima_tag_lida := 'ANS:RELACAOERROS';
					nr_tag_falha_w	:= pls_util_pck.obter_numero_tag(ds_guia_w,'ANS:RELACAOERROS');
					nr_tag_falha_tst_w := pls_util_pck.obter_numero_tag(ds_guia_w,'ANS:RELACAOERROS');
					
					while(nr_falha_w <= nr_tag_falha_w) loop
						nm_ultima_tag_lida := 'ANS:RELACAOERROS';
						ds_falha_w	:= pls_util_pck.obter_conteudo_tag(ds_guia_w,'ANS:RELACAOERROS',nr_falha_w);
						nm_ultima_tag_lida := 'ANS:IDENTIFICADORCAMPO';
						nr_campo_arquivo_w	:= pls_util_pck.obter_conteudo_tag(ds_falha_w,'ANS:IDENTIFICADORCAMPO',1);
						nm_ultima_tag_lida := 'ANS:CODIGOERRO';
						cd_glosa_w		:= pls_util_pck.obter_conteudo_tag(ds_falha_w,'ANS:CODIGOERRO',1);

						CALL pls_gerencia_envio_ans_pck.gerar_glosa_ret_monitor(null,nr_seq_proc_ret_w,null,cd_glosa_w,nr_campo_arquivo_w,nm_usuario_p);
						
						nr_falha_w:= nr_falha_w +1;
					end loop;
					nr_falha_w:= 1;		
					nr_erro_w := nr_erro_w + 1;
					ds_guia_w := pls_util_pck.obter_conteudo_tag(r_c01_w.ds_xml,'ANS:ERROSITENSGUIA',nr_erro_w);
				end loop;
				nr_erro_w := 1;
				
			
			
			exception
			when others then
				--tratamento para auxiliar identificacao de problema no arquivo de retorno. rollback de alteracoes do arquivo

				--exclui glosas vinculadas a itens das contas retornadas negadas
				delete From  Pls_Monitor_Tiss_Glosa
				where  nr_seq_guia_proc_ret  in (
					SELECT d.nr_sequencia
					from   PLS_MONITOR_TISS_GUIA_RET a,
					       PLS_MONITOR_TISS_LOTE_RET b,
					       PLS_MONITOR_TISS_PROC_RET d
					where  a.nr_seq_Lote_monitor_ret  = b.nr_sequencia
					and    b.nr_sequencia = nr_seq_lote_monitor_ret_p
					and    a.nr_sequencia = d.nr_seq_guia_monitor_ret			
				);


				-- delete glosas vinculadas as contas retornadas negadas
				delete
				From	Pls_Monitor_Tiss_Glosa
				where	nr_seq_guia_monitor_ret	in (SELECT a.nr_sequencia 
				from   PLS_MONITOR_TISS_GUIA_RET a,
				       PLS_MONITOR_TISS_LOTE_RET b
				where  a.nr_seq_Lote_monitor_ret  = b.nr_sequencia
				and    b.nr_sequencia = nr_seq_lote_monitor_ret_p);

				--deleta intes vinculados as conas retornadas negadas 
				delete from PLS_MONITOR_TISS_PROC_RET where nr_sequencia in (SELECT d.nr_sequencia
				from   PLS_MONITOR_TISS_GUIA_RET a,
				       PLS_MONITOR_TISS_LOTE_RET b,
				       PLS_MONITOR_TISS_PROC_RET d
				where  a.nr_seq_Lote_monitor_ret  = b.nr_sequencia
				and    b.nr_sequencia = nr_seq_lote_monitor_ret_p
				and    a.nr_sequencia = d.nr_seq_guia_monitor_ret);

				--excluir registros de guias aceitas
				delete
				from   pls_mon_tiss_guia_ret_act
				where  nr_sequencia in (      SELECT  a.nr_sequencia 
				       from    pls_mon_tiss_guia_ret_act a,
					       pls_monitor_tiss_lote_ret b
				       where   a.nr_seq_Lote_monitor_ret  = b.nr_sequencia
				       and     b.nr_sequencia = nr_seq_lote_monitor_ret_p);

				--exclui contas retornadas negadas 
				delete from pls_monitor_tiss_guia_ret where nr_sequencia in (SELECT a.nr_sequencia 
				from   pls_monitor_tiss_guia_ret a,
				       pls_monitor_tiss_lote_ret b
				where  a.nr_seq_Lote_monitor_ret  = b.nr_sequencia
				and    b.nr_sequencia = nr_seq_lote_monitor_ret_p);
				
				ds_log_w := sqlerrm;
				
				CALL pls_gerencia_envio_ans_pck.atualiza_dados_ret_lote_com(nr_seq_lote_com_w,nm_usuario_p);
				
				update pls_monitor_tiss_lote_ret
				set	qt_total_erro 		= qt_total_incluido + qt_total_alterado + qt_total_excluido + qt_total_erro,
					qt_total_incluido 	= 0,
					qt_total_alterado 	= 0,
					qt_total_excluido 	= 0,
					nm_arquivo = 'rej_'||nm_arquivo,
					ds_log = 'nm_ultima_tag_lida'||' - '||
					'cd_guia_prestador_w'||cd_guia_prestador_w||' - >'||ds_log_w
				where	nr_sequencia = nr_seq_lote_monitor_ret_p;

				commit;
				CALL wheb_mensagem_pck.exibir_Mensagem_abort(ds_log_w);
				--ds_log_w;
			end;
		
		else -- retorno de um lote de fornecimento direto
			ie_tipo_lote_w			:= '';
			ie_tipo_registro_w		:= '';
			dt_processamento_w		:= '';
			ie_identif_prest_exec_w		:= '';
			nr_lote_w			:= '';
			nr_seq_guia_ret_w		:= '';
			nr_proc_w			:= 1;
			nr_erro_w			:= 1;
			nr_falha_w			:= 1;
			ie_identif_fornec_w		:='';
			
			if (position('<ANS:TIPOREGISTRO>' in r_c01_w.ds_xml) > 0) and (position('</ANS:TIPOREGISTRO>' in r_c01_w.ds_xml) > 0) then
				qt_inicial_w		:= position('<ANS:TIPOREGISTRO>' in r_c01_w.ds_xml)+18;
				qt_final_w		:= position('</ANS:TIPOREGISTRO>' in r_c01_w.ds_xml) - qt_inicial_w;
				ie_tipo_registro_w	:= substr(r_c01_w.ds_xml,qt_inicial_w,qt_final_w);
			end if;
				
			if (position('<ANS:IDENTIFICACAOFORNECIMENTODIRETO>' in r_c01_w.ds_xml)  > 0) and (position('</ANS:IDENTIFICACAOFORNECIMENTODIRETO>' in r_c01_w.ds_xml) > 0) then
				qt_inicial_w		:= position('<ANS:IDENTIFICACAOFORNECIMENTODIRETO>' in r_c01_w.ds_xml)+37;
				qt_final_w		:= position('</ANS:IDENTIFICACAOFORNECIMENTODIRETO>' in r_c01_w.ds_xml)-qt_inicial_w;
				ie_identif_fornec_w	:= substr(r_c01_w.ds_xml,qt_inicial_w,qt_final_w);
			end if;
			
			if (position('<ANS:DATAFORNECIMENTO>' in r_c01_w.ds_xml)  > 0) and (position('</ANS:DATAFORNECIMENTO>' in r_c01_w.ds_xml) > 0) then
				qt_inicial_w		:= position('<ANS:DATAFORNECIMENTO>' in r_c01_w.ds_xml)+22;
				qt_final_w		:= position('</ANS:DATAFORNECIMENTO>' in r_c01_w.ds_xml)-qt_inicial_w;
				dt_processamento_ww	:= substr(r_c01_w.ds_xml,qt_inicial_w,qt_final_w);
				
				dt_processamento_ww	:= replace(dt_processamento_ww,'-','');
				if (dt_processamento_ww IS NOT NULL AND dt_processamento_ww::text <> '') then
					dt_processamento_ww		:= substr(dt_processamento_ww,7,2) || substr(dt_processamento_ww,5,2) || substr(dt_processamento_ww,1,4);
					dt_processamento_w		:= to_date(dt_processamento_ww);
				end if;
			end if;

			nr_seq_guia_ret_w := pls_gerencia_envio_ans_pck.gerar_guia_ret_monitor(	nr_seq_lote_monitor_ret_p, cd_cnes_prest_exec_w, cpf_cgc_prest_exec_w, cd_guia_operadora_w, cd_guia_prestador_w, dt_processamento_w, ie_identif_prest_exec_w, ie_reembolso_w, nr_lote_w, nm_usuario_p, ie_tipo_registro_w, ie_identif_fornec_w, 'F', nr_seq_guia_ret_w);
									
			ds_xml_aux_w	:= r_c01_w.ds_xml;
									
			while(position('<ANS:ERROSFORNECIMENTODIRETO>' in ds_xml_aux_w)  > 0) and (position('</ANS:ERROSFORNECIMENTODIRETO>' in ds_xml_aux_w) > 0) loop
				
				cd_glosa_w		:= '';
				nr_campo_arquivo_w	:= '';
				
				if (position('<ANS:IDENTIFICADORCAMPO>' in ds_xml_aux_w)  > 0) and (position('</ANS:IDENTIFICADORCAMPO>' in ds_xml_aux_w) > 0) then
					qt_inicial_w		:= position('<ANS:IDENTIFICADORCAMPO>' in ds_xml_aux_w)+24;
					qt_final_w		:= position('</ANS:IDENTIFICADORCAMPO>' in ds_xml_aux_w)-qt_inicial_w;
					nr_campo_arquivo_w	:= substr(ds_xml_aux_w,qt_inicial_w,qt_final_w);
				end if;
				
				if (position('<ANS:CODIGOERRO>' in ds_xml_aux_w)  > 0) and (position('</ANS:CODIGOERRO>' in ds_xml_aux_w) > 0) then
					qt_inicial_w		:= position('<ANS:CODIGOERRO>' in ds_xml_aux_w)+16;
					qt_final_w		:= position('</ANS:CODIGOERRO>' in ds_xml_aux_w)-qt_inicial_w;
					cd_glosa_w		:= substr(ds_xml_aux_w,qt_inicial_w,qt_final_w);
				end if;
				
				CALL pls_gerencia_envio_ans_pck.gerar_glosa_ret_monitor(nr_seq_guia_ret_w,null,null,cd_glosa_w,nr_campo_arquivo_w,nm_usuario_p);
				
				ds_xml_aux_w	:= substr(ds_xml_aux_w,position('</ANS:ERROSFORNECIMENTODIRETO>' in ds_xml_aux_w)+30,length(r_c01_w.ds_xml));
			end loop;
			
			ds_guia_w := pls_util_pck.obter_conteudo_tag(r_c01_w.ds_xml,'ANS:ERROSITENSFORNECIMENTODIRETO',nr_erro_w);
			
			nr_tag_erro_w	:= pls_util_pck.obter_numero_tag(r_c01_w.ds_xml,'ANS:ERROSITENSFORNECIMENTODIRETO');
			
			while(nr_erro_w <= nr_tag_erro_w) loop
				ds_proc_w	:= pls_util_pck.obter_conteudo_tag(ds_guia_w,'ANS:IDENTPROCEDIMENTO',nr_erro_w);
				cd_tabela_ref_w	:= pls_util_pck.obter_conteudo_tag(ds_proc_w,'ANS:CODIGOTABELA',1);
				cd_grupo_proc_w	:= pls_util_pck.obter_conteudo_tag(ds_proc_w,'ANS:GRUPOPROCEDIMENTO',1);
				cd_procedimento_w:=pls_util_pck.converte_numero(pls_util_pck.obter_conteudo_tag(ds_proc_w,'ANS:CODIGOPROCEDIMENTO',1));
			
				nr_seq_proc_ret_w := pls_gerencia_envio_ans_pck.gerar_proc_ret_monitor(	nr_seq_guia_ret_w, cd_grupo_proc_w, cd_procedimento_w, cd_tabela_ref_w, cd_dente_w, cd_face_dente_w, cd_regiao_boca_w, nm_usuario_p, nr_seq_proc_ret_w);
											
				nr_tag_falha_w	:= pls_util_pck.obter_numero_tag(ds_guia_w,'ANS:RELACAOERROS');
				nr_tag_falha_tst_w := pls_util_pck.obter_numero_tag(ds_guia_w,'ANS:RELACAOERROS');
				
				while(nr_falha_w <= nr_tag_falha_w) loop
					ds_falha_w	:= pls_util_pck.obter_conteudo_tag(ds_guia_w,'ANS:RELACAOERROS',nr_falha_w);
					nr_campo_arquivo_w	:= pls_util_pck.obter_conteudo_tag(ds_falha_w,'ANS:IDENTIFICADORCAMPO',1);
					cd_glosa_w		:= pls_util_pck.obter_conteudo_tag(ds_falha_w,'ANS:CODIGOERRO',1);

					CALL pls_gerencia_envio_ans_pck.gerar_glosa_ret_monitor(null,nr_seq_proc_ret_w,null,cd_glosa_w,nr_campo_arquivo_w,nm_usuario_p);
					
					nr_falha_w:= nr_falha_w +1;
				end loop;
				nr_falha_w:= 1;		
				nr_erro_w := nr_erro_w + 1;
				ds_guia_w := pls_util_pck.obter_conteudo_tag(r_c01_w.ds_xml,'ANS:ERROSITENSFORNECIMENTODIRETO',nr_erro_w);
			end loop;
			nr_erro_w := 1;
		end if;
			
	end loop;

else
	--Se teve geracao de arquivo novo, vai emitir msg abort
	
	delete from pls_monitor_tiss_lote_ret where nr_seq_arquivo = nr_seq_arquivo_w;
	commit;
	CALL wheb_mensagem_pck.exibir_Mensagem_abort(1122098);

end if;

ds_msg_conclusao_w := wheb_mensagem_pck.get_texto(1120440); -- 1120440
update 	pls_monitor_tiss_lote_ret
set	ds_log = ds_msg_conclusao_w
where	nr_sequencia = nr_seq_lote_monitor_ret_p;


if ( ie_tipo_envio_w = 0) then
	ajusta_status_agrup( nr_seq_lote_monitor_ret_p, nr_seq_lote_monitor_arq_w);
end if;
CALL pls_gerencia_envio_ans_pck.gera_contas_aceitas(nr_seq_lote_monitor_ret_p, ie_tipo_lote_w, nm_usuario_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_tratar_imp_retorno_monitor ( nr_seq_lote_monitor_ret_p pls_monitor_tiss_lote_ret.nr_sequencia%type, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

