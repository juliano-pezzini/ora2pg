-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE preenche_dados_visu_senha ( nr_sequencia_fila_p bigint, nr_seq_pac_senha_fila_p bigint, nr_seq_local_chamada_p bigint, nm_usuario_p text) AS $body$
DECLARE




IE_MOSTRA_MONITOR_W 		varchar(1);

--Parametros funcao
QT_DIAS_CHAMADA_W			smallint; --151
QT_LIMITE_CHAMADAS_W		smallint; --24
--Parametros procedure
NR_SEQ_PAC_SENHA_FILA_W		DADOS_VISUALIZACAO_SENHA.NR_SEQ_PAC_SENHA_FILA%type;
NR_SEQ_FILA_SENHA_ORIGEM_W	DADOS_VISUALIZACAO_SENHA.NR_SEQ_FILA_SENHA_ORIGEM%type;
CD_SENHA_GERADA_W			DADOS_VISUALIZACAO_SENHA.CD_SENHA_GERADA%type;
DT_CHAMADA_W				DADOS_VISUALIZACAO_SENHA.DT_CHAMADA%type;
DT_PRIMEIRA_CHAMADA_W		DADOS_VISUALIZACAO_SENHA.DT_PRIMEIRA_CHAMADA%type;
DT_GERACAO_SENHA_W			DADOS_VISUALIZACAO_SENHA.DT_GERACAO_SENHA%type;
NM_PACIENTE_W				DADOS_VISUALIZACAO_SENHA.NM_PACIENTE%type;
NR_SEQ_FILA_SENHA_W			DADOS_VISUALIZACAO_SENHA.NR_SEQ_FILA_SENHA%type;
NR_SEQ_LOCAL_SENHA_W		DADOS_VISUALIZACAO_SENHA.NR_SEQ_LOCAL_SENHA%type;
CD_ESTABELECIMENTO_W		DADOS_VISUALIZACAO_SENHA.CD_ESTABELECIMENTO%type;
QT_CHAMADAS_W				DADOS_VISUALIZACAO_SENHA.QT_CHAMADAS%type;
DS_COR_FUNDO_W				DADOS_VISUALIZACAO_SENHA.DS_COR_FUNDO%type;
DS_COR_FONTE_W				DADOS_VISUALIZACAO_SENHA.DS_COR_FONTE%type;
NR_SEQ_GRUPO_LOCAL_SENHA_W	DADOS_VISUALIZACAO_SENHA.NR_SEQ_GRUPO_LOCAL_SENHA%type;


BEGIN

CD_ESTABELECIMENTO_W := wheb_usuario_pck.get_cd_estabelecimento;
QT_DIAS_CHAMADA_W := Obter_param_Usuario(10021, 151, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, QT_DIAS_CHAMADA_W);
QT_LIMITE_CHAMADAS_W := Obter_param_Usuario(10021, 24, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, QT_LIMITE_CHAMADAS_W);

select 	coalesce(a.IE_MOSTRA_MONITOR,'N'),
		b.NR_SEQUENCIA,
		b.NR_SEQ_FILA_SENHA_ORIGEM,
		b.CD_SENHA_GERADA,
		b.DT_CHAMADA,
		b.DT_PRIMEIRA_CHAMADA,
		b.DT_GERACAO_SENHA,
		COALESCE(b.nm_paciente, CASE WHEN coalesce(b.cd_pessoa_fisica::text, '') = '' THEN  null  ELSE obter_nome_pf(b.cd_pessoa_fisica) END ) nm_pessoa_fisica,
		b.NR_SEQ_FILA_SENHA,
		b.NR_SEQ_LOCAL_SENHA,
		b.CD_ESTABELECIMENTO,
		b.QT_CHAMADAS	
into STRICT	IE_MOSTRA_MONITOR_W,
		NR_SEQ_PAC_SENHA_FILA_W,
		NR_SEQ_FILA_SENHA_ORIGEM_W,
		CD_SENHA_GERADA_W,
		DT_CHAMADA_W,
		DT_PRIMEIRA_CHAMADA_W,
		DT_GERACAO_SENHA_W,
		NM_PACIENTE_W,
		NR_SEQ_FILA_SENHA_W,
		NR_SEQ_LOCAL_SENHA_W,
		CD_ESTABELECIMENTO_W,
		QT_CHAMADAS_W
from 	FILA_ESPERA_SENHA a,
		PACIENTE_SENHA_FILA b
WHERE	a.NR_SEQUENCIA = b.NR_SEQ_FILA_SENHA
and		b.NR_SEQUENCIA = NR_SEQ_PAC_SENHA_FILA_P;



if(	IE_MOSTRA_MONITOR_W = 'S'
	AND  DT_GERACAO_SENHA_W > clock_timestamp() - QT_DIAS_CHAMADA_W
	AND  (((QT_LIMITE_CHAMADAS_W)::numeric  = 0) OR (QT_CHAMADAS_W <= (QT_LIMITE_CHAMADAS_W)::numeric ))
	AND (coalesce(NR_SEQ_GRUPO_LOCAL_SENHA_W,0) = 0)) then



		INSERT INTO DADOS_VISUALIZACAO_SENHA(
												NR_SEQUENCIA,
												DT_ATUALIZACAO_NREC,
												NM_USUARIO_NREC,
												DT_ATUALIZACAO,
												NM_USUARIO,
												NR_SEQ_FILA_VISUALIZACAO,
												NR_SEQ_PAC_SENHA_FILA,
												NR_SEQ_FILA_SENHA_ORIGEM,
												CD_SENHA_GERADA,
												DT_CHAMADA,
												DT_PRIMEIRA_CHAMADA,
												DT_GERACAO_SENHA,
												NM_PACIENTE,
												NR_SEQ_FILA_SENHA,
												NR_SEQ_LOCAL_SENHA,
												CD_ESTABELECIMENTO,
												QT_CHAMADAS,
												DS_COR_FUNDO,
												DS_COR_FONTE,
												NR_SEQ_GRUPO_LOCAL_SENHA
												)
			VALUES (
												nextval('dados_visualizacao_senha_seq'),
												clock_timestamp(),
												nm_usuario_p,
												clock_timestamp(),
												nm_usuario_p,
												NR_SEQUENCIA_FILA_P,
												NR_SEQ_PAC_SENHA_FILA_W,
												NR_SEQ_FILA_SENHA_ORIGEM_W,
												CD_SENHA_GERADA_W,
												DT_CHAMADA_W,
												DT_PRIMEIRA_CHAMADA_W,
												DT_GERACAO_SENHA_W,
												NM_PACIENTE_W,
												NR_SEQ_FILA_SENHA_W,
												NR_SEQ_LOCAL_SENHA_W,
												CD_ESTABELECIMENTO_W,
												QT_CHAMADAS_W,
												DS_COR_FUNDO_W,
												DS_COR_FONTE_W,
												NR_SEQ_GRUPO_LOCAL_SENHA_W
												);






end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE preenche_dados_visu_senha ( nr_sequencia_fila_p bigint, nr_seq_pac_senha_fila_p bigint, nr_seq_local_chamada_p bigint, nm_usuario_p text) FROM PUBLIC;

