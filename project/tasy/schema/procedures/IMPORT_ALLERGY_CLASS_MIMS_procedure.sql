-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE import_allergy_class_mims ( nm_usuario_p text, version_p bigint DEFAULT 1) AS $body$
DECLARE


ds_group_name_w				varchar(50) := 'TASY_GROUP_MIMS';
ds_subgroup_name_w			varchar(50) := 'TASY_SUBGROUP_MIMS';
cd_group_material_w        		bigint;
cd_group_material_seq_w			bigint;
cd_subgroup_material_seq_w		bigint;
cd_classe_material_w			bigint;
cd_adic_seq				bigint;


		c_material CURSOR FOR
		SELECT	cd_material, 
			nr_seq_ficha_tecnica 
		FROM	material 
		WHERE	(nr_seq_ficha_tecnica IS NOT NULL AND nr_seq_ficha_tecnica::text <> '');

		c_gencode CURSOR( nr_seq_ficha_tecnica_val bigint) FOR
		SELECT	c.cd_dcb 
		FROM	medic_ficha_tecnica a 
		inner	join	dcb_medic_controlado c 
		ON	c.nr_sequencia = a.nr_seq_dcb 
		WHERE	a.nr_sequencia = nr_seq_ficha_tecnica_val and regexp_like(c.cd_dcb, '^[0-9]+$')
		
UNION
 
		SELECT	c.cd_dcb 
		FROM	medic_ficha_tecnica a 
		inner join dcb_medic_controlado c 
		ON	c.nr_sequencia = a.nr_seq_dcb 
		WHERE 	a.nr_seq_superior = nr_seq_ficha_tecnica_val and regexp_like(c.cd_dcb, '^[0-9]+$');

		c_substance CURSOR(gcode bigint) FOR
		SELECT	s.substance_class_id,
			s.substance_class_name 
		FROM	generic_substance g 
		inner join substance_class s 
		ON	g.substance_class_id = s.substance_class_id 
		WHERE	g.gencode = gcode 
		AND	g.VERSION = version_p
		AND	s.VERSION = version_p;
BEGIN
BEGIN

		SELECT	cd_subgrupo_material 
		INTO STRICT	cd_subgroup_material_seq_w 
		FROM	subgrupo_material 
		WHERE	cd_grupo_material = (SELECT DISTINCT cd_grupo_material 
		FROM	grupo_material 
		WHERE	ds_grupo_material = ds_group_name_w);
		EXCEPTION 
		WHEN	no_data_found 
		THEN	cd_subgroup_material_seq_w := NULL;
END;

	IF ( coalesce(cd_subgroup_material_seq_w::text, '') = '' )THEN

		SELECT Max(cd_grupo_material) + 1
		INTO STRICT   cd_group_material_seq_w 
		FROM   grupo_material;

		INSERT INTO grupo_material(cd_grupo_material, 
			ds_grupo_material, 
			ie_situacao, 
			dt_atualizacao, 
			nm_usuario, 
			cd_conta_contabil, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			ie_hist_saude, 
			cd_sistema_ant) 
		VALUES ( cd_group_material_seq_w, 
			ds_group_name_w, 
			'A', 
			clock_timestamp(), 
			nm_usuario_p, 
			NULL, 
			clock_timestamp(), 
			nm_usuario_p, 
			NULL, 
			NULL );

		SELECT Max(cd_subgrupo_material) + 1 
		INTO STRICT   cd_subgroup_material_seq_w 
		FROM   subgrupo_material;

		INSERT INTO subgrupo_material(cd_subgrupo_material, 
			ds_subgrupo_material, 
			cd_grupo_material, 
			ie_situacao, 
			dt_atualizacao, 
			nm_usuario, 
			cd_conta_contabil, 
			cd_sistema_ant) 
		VALUES (cd_subgroup_material_seq_w, 
			ds_subgroup_name_w, 
			cd_group_material_seq_w, 
			'A', 
			clock_timestamp(), 
			nm_usuario_p, 
			NULL, 
			NULL );
	END IF;

	FOR r_material IN c_material LOOP 

		FOR r_gencode IN c_gencode(r_material.nr_seq_ficha_tecnica) LOOP     

			FOR r_substance IN c_substance(r_gencode.cd_dcb)LOOP 

			BEGIN

				SELECT	cd_classe_material 
				INTO STRICT	cd_classe_material_w 
				FROM	classe_material 
				WHERE cd_sistema_ant = to_char(r_substance.substance_class_id)
				AND	cd_subgrupo_material = cd_subgroup_material_seq_w;
				EXCEPTION
				WHEN	no_data_found 
				THEN	cd_classe_material_w := NULL;

			END;

		IF ( coalesce(cd_classe_material_w::text, '') = '' )THEN

				SELECT	Max(cd_classe_material) + 1 
				INTO STRICT	cd_classe_material_w 
				FROM	classe_material;

			INSERT INTO classe_material(cd_classe_material, 
				ds_classe_material, 
				cd_subgrupo_material, 
				ie_situacao, 
				dt_atualizacao, 
				nm_usuario, 
				cd_conta_contabil, 
				ie_tipo_classe, 
				nr_seq_apres, 
				cd_sistema_ant) 
			VALUES (cd_classe_material_w, 
				r_substance.substance_class_name, 
				cd_subgroup_material_seq_w, 
				'A', 
				clock_timestamp(), 
				nm_usuario_p, 
				NULL, 
				NULL, 
				NULL, 
				r_substance.substance_class_id );
                END IF;

BEGIN
				select	nr_sequencia into STRICT cd_adic_seq from material_classe_adic 
				where	cd_material = r_material.cd_material
				and	CD_CLASSE_MATERIAL = cd_classe_material_w;
				EXCEPTION
				WHEN	no_data_found 
				THEN	cd_adic_seq := 0;

                END;

		IF (cd_adic_seq = 0) THEN

			INSERT INTO material_classe_adic(nr_sequencia,
				cd_material, 
				dt_atualizacao, 
				nm_usuario, 
				cd_classe_material, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec) 
			VALUES ( nextval('material_classe_adic_seq'), 
				r_material.cd_material, 
				clock_timestamp(), 
				nm_usuario_p, 
				cd_classe_material_w, 
				clock_timestamp(), 
				nm_usuario_p );
		END IF;
			END LOOP;
		END LOOP;
	END LOOP;
COMMIT;

	BEGIN
		CALL UPDATE_AI_SYNONYM_MIMS();
	EXCEPTION WHEN OTHERS THEN
		null;
	END;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE import_allergy_class_mims ( nm_usuario_p text, version_p bigint DEFAULT 1) FROM PUBLIC;

