-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_desfazer_importacao_lote ( nr_seq_intercambio_p bigint) AS $body$
DECLARE


qt_registro_confirmado_w	bigint;

C01 CURSOR FOR
	SELECT	b.nr_sequencia nr_seq_beneficiario
	from	ptu_intercambio_benef		b,
		ptu_intercambio_empresa		a
	where	a.nr_sequencia = b.nr_seq_empresa
	and	a.nr_seq_intercambio = nr_seq_intercambio_p;

C02 CURSOR FOR
	SELECT	nr_sequencia nr_seq_empresa
	from	ptu_intercambio_empresa
	where	nr_seq_intercambio = nr_seq_intercambio_p;

BEGIN

select 	count(1)
into STRICT	qt_registro_confirmado_w
from   	ptu_retorno_movimentacao a,
	ptu_retorno_mov_benef b
where  	a.nr_sequencia = b.nr_seq_retorno_mov
and    	a.nr_seq_intercambio = nr_seq_intercambio_p
and    	(a.dt_confirmacao_envio IS NOT NULL AND a.dt_confirmacao_envio::text <> '');

if (qt_registro_confirmado_w > 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1063335);
else
	delete from ptu_retorno_mov_benef
	where	nr_sequencia in (	SELECT	b.nr_sequencia
					from   	ptu_retorno_movimentacao a,
						ptu_retorno_mov_benef b
					where  	a.nr_sequencia = b.nr_seq_retorno_mov
					and    	a.nr_seq_intercambio = nr_seq_intercambio_p);
					
	delete from ptu_retorno_movimentacao
	where	nr_seq_intercambio = nr_seq_intercambio_p;
end if;

delete	from	ptu_intercambio_benef_simp
where	nr_seq_intercambio	= nr_seq_intercambio_p;


for r_c01_w in C01 loop
	begin
	delete	from ptu_beneficiario_carencia
	where	nr_seq_beneficiario = r_c01_w.nr_seq_beneficiario;
	
	delete	from ptu_benef_plano_agregado
	where	nr_seq_beneficiario = r_c01_w.nr_seq_beneficiario;
	
	delete	from ptu_beneficiario_compl
	where	nr_seq_beneficiario = r_c01_w.nr_seq_beneficiario;
	
	delete	from ptu_beneficiario_contato
	where	nr_seq_beneficiario = r_c01_w.nr_seq_beneficiario;
	
	delete	from ptu_benef_preexistencia
	where	nr_seq_beneficiario = r_c01_w.nr_seq_beneficiario;
	
	delete	FROM ptu_intercambio_consist
	where	nr_seq_inter_benef = r_c01_w.nr_seq_beneficiario;
	end;
end loop; --C01
for r_c02_w in C02 loop
	begin
	delete 	from ptu_intercambio_benef
	where	nr_seq_empresa = r_c02_w.nr_seq_empresa;
	
	delete 	from ptu_intercambio_plano
	where	nr_seq_empresa = r_c02_w.nr_seq_empresa;
	end;
end loop; --C02
delete	from ptu_intercambio_empresa
where	nr_seq_intercambio = nr_seq_intercambio_p;
	
delete	from ptu_intercambio
where	nr_sequencia = nr_seq_intercambio_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_desfazer_importacao_lote ( nr_seq_intercambio_p bigint) FROM PUBLIC;

