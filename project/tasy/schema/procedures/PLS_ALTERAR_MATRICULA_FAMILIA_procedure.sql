-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alterar_matricula_familia ( nr_seq_segurado_p bigint, cd_matricula_p bigint, cd_estabelecimento_p bigint, ie_tipo_incremento_p bigint, ie_gerar_cartao_p text, nm_usuario_p text) AS $body$
DECLARE

 
cd_matricula_ant_w	bigint;
qt_matricula_w		bigint;
nr_seq_segurado_w	bigint;
ds_historico_w		varchar(250);
cd_operadora_empresa_w	bigint;
dt_validade_w			timestamp;
dt_inicio_vig_cart_w		timestamp;
dt_base_carteira_w		timestamp;
cd_matricula_estipulante_w	varchar(30);
ie_data_inic_vig_cart_w		varchar(10);
ie_gerar_validade_cartao_w	varchar(1);
dt_validade_cart_parmetros_w	varchar(1);
nr_seq_contrato_w		pls_contrato.nr_sequencia%type;
dt_contratacao_w		pls_segurado.dt_contratacao%type;
nr_seq_titular_w		pls_segurado.nr_seq_titular%type;
dt_contrato_w			pls_contrato.dt_contrato%type;

/* 
ie_tipo_incremento_p 
1 - Sequencial 
2 - Sequencial por empresa 
3 - Sequencial por contrato 
*/
 
 
C01 CURSOR FOR 
	SELECT	nr_sequencia	 
	from	pls_segurado 
	where	nr_sequencia	= nr_seq_titular_w 
	
union all
 
	SELECT	nr_sequencia	 
	from	pls_segurado 
	where	nr_seq_titular	= nr_seq_titular_w 
	order by nr_sequencia;
			

BEGIN 
 
ie_data_inic_vig_cart_w	:= coalesce(obter_valor_param_usuario(1202, 111, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_p),'S');
 
select	nr_seq_titular, 
	cd_matricula_familia, 
	nr_seq_contrato, 
	cd_operadora_empresa, 
	dt_contratacao 
into STRICT	nr_seq_titular_w, 
	cd_matricula_ant_w, 
	nr_seq_contrato_w, 
	cd_operadora_empresa_w, 
	dt_contratacao_w 
from	pls_segurado 
where	nr_sequencia	= nr_seq_segurado_p;
 
if (coalesce(nr_seq_titular_w,0)	= 0) then /* Se o beneficiário é dependente */
 
	nr_seq_titular_w	:= nr_seq_segurado_p;
end if;
 
/*aaschlote 30/03/2012 - OS - 426732*/
 
if (ie_tipo_incremento_p = 1) then 
	select	count(*) 
	into STRICT	qt_matricula_w 
	from	pls_segurado 
	where	cd_matricula_familia	= cd_matricula_p;
elsif (ie_tipo_incremento_p = 2) then 
	select	count(*) 
	into STRICT	qt_matricula_w 
	from	pls_segurado 
	where	cd_matricula_familia	= cd_matricula_p 
	and	cd_operadora_empresa	= cd_operadora_empresa_w;
elsif (ie_tipo_incremento_p = 3) then 
	select	count(*) 
	into STRICT	qt_matricula_w 
	from	pls_segurado 
	where	cd_matricula_familia	= cd_matricula_p 
	and	nr_seq_contrato		= nr_seq_contrato_w;
end if;
 
if (qt_matricula_w = 0) then 
	 
	ds_historico_w	:= 'Alteração da matrícula: ' || cd_matricula_ant_w ||'.Para a matrícula: '|| cd_matricula_p;
 
	update	pls_segurado 
	set	cd_matricula_familia	= cd_matricula_p 
	where	((nr_seq_titular	= nr_seq_titular_w) or (nr_sequencia	= nr_seq_titular_w));
	 
	/* Gerar histórico */
 
	open C01;
	loop 
	fetch C01 into	 
		nr_seq_segurado_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		CALL pls_gerar_segurado_historico(	nr_seq_segurado_w, '28', clock_timestamp(), ds_historico_w, 
						'pls_alterar_matricula_familia', null, null, null, 
						null, null, null, null, 
						null, null, null, null, 
						nm_usuario_p, 'N');		
		end;
	end loop;
	close C01;
	 
elsif (qt_matricula_w > 0) then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(183725,'CD_MATRICULA='||cd_matricula_p);
end if;	
 
if (coalesce(ie_gerar_cartao_p,'S') = 'S') then 
	 
	select	coalesce(ie_gerar_validade_cartao,'S'),	 
		coalesce(dt_base_validade_carteira,'B') 
	into STRICT	ie_gerar_validade_cartao_w, 
		dt_validade_cart_parmetros_w 
	from	pls_parametros 
	where	cd_estabelecimento	= cd_estabelecimento_p;
	 
	select	dt_contrato, 
		coalesce(dt_base_validade_carteira,dt_validade_cart_parmetros_w), 
		coalesce(dt_base_carteira,dt_contrato) 
	into STRICT	dt_contrato_w, 
		dt_validade_cart_parmetros_w, 
		dt_base_carteira_w 
	from	pls_contrato 
	where	nr_sequencia	= nr_seq_contrato_w;
	 
	dt_validade_w		:= null;
	 
	if (ie_gerar_validade_cartao_w = 'S') then 
			dt_validade_w := pls_obter_validade_cart_benef(dt_contratacao_w, dt_contrato_w, dt_base_carteira_w, dt_validade_cart_parmetros_w, cd_estabelecimento_p);
	end if;
		 
	if (ie_data_inic_vig_cart_w = 'B') then 
		dt_inicio_vig_cart_w	:= dt_contratacao_w;
	elsif (ie_data_inic_vig_cart_w = 'C') then 
		dt_inicio_vig_cart_w	:= dt_contrato_w;
	end if;
	 
	CALL pls_gerar_carteira_usuario(nr_seq_segurado_p, nr_seq_titular_w, dt_inicio_vig_cart_w, dt_validade_w, 'P', 'MF',null, nm_usuario_p);
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alterar_matricula_familia ( nr_seq_segurado_p bigint, cd_matricula_p bigint, cd_estabelecimento_p bigint, ie_tipo_incremento_p bigint, ie_gerar_cartao_p text, nm_usuario_p text) FROM PUBLIC;

