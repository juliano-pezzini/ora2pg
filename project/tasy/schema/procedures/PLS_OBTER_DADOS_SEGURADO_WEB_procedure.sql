-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_dados_segurado_web (nr_seq_segurado_p bigint, cd_usuario_plano_p text, ie_restringe_benef_p text, cd_estabelecimento_p bigint, nm_segurado_p INOUT text, nr_carteira_p INOUT text, nr_seq_seg_p INOUT bigint, nr_seq_plano_p INOUT bigint, ds_plano_p INOUT text, ie_sexo_p INOUT text, nr_idade_p INOUT bigint, ie_registros_p INOUT text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Retornar os dados do beneficiario
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[ ]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  x]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
ie_restringe_benef_p = parametro[3] da funcao OPSW - Beneficiarios
ie_registros_p = S : 'Encontrou benef', R : 'Nao encontrou beneficiario devido ao parametro', N : 'Nao encontrou benef'
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_segurado_w		bigint;
qt_registros_w			bigint;
nr_idade_w			bigint;
ie_sexo_sigla_w			varchar(4);


BEGIN

if (cd_usuario_plano_p IS NOT NULL AND cd_usuario_plano_p::text <> '') then
	select	max(a.nr_sequencia)
	into STRICT	nr_seq_segurado_w
	from  	pls_segurado a,
		pls_segurado_carteira b
	where   a.nr_sequencia = b.nr_seq_segurado
	and     b.cd_usuario_plano = cd_usuario_plano_p
	and     a.cd_estabelecimento = cd_estabelecimento_p;
else
	nr_seq_segurado_w := nr_seq_segurado_p;
end if;

--verifica se o segurado existe na base
select	max(nr_sequencia)
into STRICT	nr_seq_segurado_w
from	pls_segurado
where 	nr_sequencia = nr_seq_segurado_w;

if ((nr_seq_segurado_w IS NOT NULL AND nr_seq_segurado_w::text <> '') and (ie_restringe_benef_p IS NOT NULL AND ie_restringe_benef_p::text <> '') and ie_restringe_benef_p <> '') then
	select	count(1)
	into STRICT	qt_registros_w
	from	pls_segurado
	where  	nr_sequencia 		= nr_seq_segurado_w
	and	ie_tipo_segurado	= ie_restringe_benef_p;
	
	if (qt_registros_w = 0) then
		nr_seq_segurado_w := null;
		ie_registros_p := 'R';
	end if;
elsif (coalesce(nr_seq_segurado_w::text, '') = '') then
	ie_registros_p := 'N';
end if;

if (nr_seq_segurado_w IS NOT NULL AND nr_seq_segurado_w::text <> '') then

	nr_seq_plano_p := pls_obter_produto_benef(nr_seq_segurado_w, clock_timestamp());

	select	pls_obter_dados_produto(nr_seq_plano_p, 'N'),
		pls_obter_dados_segurado(a.nr_sequencia,'NS'),
		pls_obter_dados_segurado(a.nr_sequencia,'ID'),
		pls_obter_dados_segurado(a.nr_sequencia,'SXS')
	into STRICT	ds_plano_p,
		nm_segurado_p,
		nr_idade_w,
		ie_sexo_sigla_w
	from	pls_segurado a
	where	a.nr_sequencia = nr_seq_segurado_w;
	
	if (coalesce(cd_usuario_plano_p::text, '') = '') then
		-- Jucimara - OS 1093690
		select	pls_obter_dados_segurado(nr_seq_segurado_w, 'CR')
		into STRICT	nr_carteira_p
		;
	else
		nr_carteira_p := cd_usuario_plano_p;
	end if;

	ie_sexo_p := ie_sexo_sigla_w;
	nr_idade_p := nr_idade_w;
	
	nr_seq_seg_p := nr_seq_segurado_w;
	ie_registros_p := 'S';
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_dados_segurado_web (nr_seq_segurado_p bigint, cd_usuario_plano_p text, ie_restringe_benef_p text, cd_estabelecimento_p bigint, nm_segurado_p INOUT text, nr_carteira_p INOUT text, nr_seq_seg_p INOUT bigint, nr_seq_plano_p INOUT bigint, ds_plano_p INOUT text, ie_sexo_p INOUT text, nr_idade_p INOUT bigint, ie_registros_p INOUT text) FROM PUBLIC;

