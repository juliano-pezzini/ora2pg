-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE intpd_atualiza_status_fila ( nr_sequencia_p bigint, xml_p xml) AS $body$
DECLARE


				
	
ds_erro_w			varchar(4000);
ie_exception_w			varchar(1) := 'N';
ie_evento_w			intpd_fila_transmissao.ie_evento%type;
nr_seq_documento_w		intpd_fila_transmissao.nr_seq_documento%type;

c01 CURSOR FOR
SELECT	nr_atendimento
from	xmltable('/STRUCTURE/FILTERS' passing xml_p columns
	nr_atendimento bigint path 'NR_ENCOUNTER');
c01_w c01%rowtype;



BEGIN

select	coalesce(max(ie_evento),'0')
into STRICT	ie_evento_w
from	intpd_fila_transmissao
where	nr_sequencia = nr_sequencia_p;

begin
if (ie_evento_w = '163') then
	begin
	open C01;
	loop
	fetch C01 into	
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		nr_seq_documento_w := c01_w.nr_atendimento;
		end;
	end loop;
	close C01;	
	end;
end if;
exception
when others then
	nr_seq_documento_w := null;
end;

update	intpd_fila_transmissao
set	ie_status = 'R',
	nr_seq_documento = nr_seq_documento_w
where	nr_sequencia = nr_sequencia_p;
commit;

begin
intpd_gravar_log_recebimento(nr_sequencia_p, obter_desc_expressao(883595), 'INTPDTASY','0008');
exception
when others then
	begin
	ds_erro_w := substr(dbms_utility.format_error_backtrace || chr(13) || chr(10) || sqlerrm,1,4000);
	rollback;

	update	intpd_fila_transmissao
	set	ie_status 	 	= 'E',
		cd_default_message 	= CASE WHEN ds_erro_w = NULL THEN null  ELSE '0005' END ,
		ds_log 		= ds_erro_w
	where	nr_sequencia 	= nr_sequencia_p;

	ie_exception_w := 'S';

	end;
end;

if (ie_exception_w = 'N') then

	update	intpd_fila_transmissao
	set	ie_status		= 'S',
		cd_default_message = '0000'
	where	nr_sequencia	= nr_sequencia_p;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE intpd_atualiza_status_fila ( nr_sequencia_p bigint, xml_p xml) FROM PUBLIC;

