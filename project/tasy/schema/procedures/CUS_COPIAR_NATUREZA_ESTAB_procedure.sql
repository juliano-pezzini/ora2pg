-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cus_copiar_natureza_estab ( cd_estabelecimento_p bigint, cd_natureza_gasto_p bigint, nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_registro_w				bigint;
qt_reg_gng_w				bigint;
cd_empresa_w				bigint;
cd_estabelecimento_w			bigint;
nr_seq_gng_w				bigint;


c01 CURSOR FOR
SELECT	cd_estabelecimento
from	estabelecimento
where	cd_empresa		= cd_empresa_w
and	cd_estabelecimento	<> cd_estabelecimento_p
order by 1;


BEGIN

cd_empresa_w	:= obter_empresa_estab(cd_estabelecimento_p);

open C01;
loop
fetch C01 into
	cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	coalesce(max(nr_seq_gng),0)
	into STRICT	nr_seq_gng_w
	from	natureza_gasto
	where	nr_sequencia	= nr_sequencia_p;

	select	count(*)
	into STRICT	qt_reg_gng_w
	from	grupo_natureza_gasto
	where	nr_sequencia				= nr_seq_gng_w
	and	cd_empresa				= cd_empresa_w
	and	coalesce(cd_estabelecimento, cd_estabelecimento_w)	= cd_estabelecimento_w;

	if (qt_reg_gng_w = 0) then
		/*'Falta cadastrar o grupo de natureza de gasto: ' || nr_seq_gng_w);*/

		CALL wheb_mensagem_pck.exibir_mensagem_abort(266455,'NR_SEQ_GNG=' || nr_seq_gng_w);
	end if;

	select	count(*)
	into STRICT	qt_registro_w
	from	natureza_gasto
	where	cd_natureza_gasto	= cd_natureza_gasto_p
	and	cd_estabelecimento	= cd_estabelecimento_w;

	if (qt_registro_w = 0) then

		insert into natureza_gasto(
			nr_sequencia,
			cd_estabelecimento,
			cd_natureza_gasto,
			ds_natureza_gasto,
			nm_usuario,
			dt_atualizacao,
			ie_situacao,
			ie_natureza_gasto,
			cd_grupo_natureza_gasto,
			qt_dias_prazo_medio,
			ie_resumo,
			cd_classif_result,
			cd_conta_contabil,
			nr_seq_gng,
			cd_empresa,
			dt_atualizacao_nrec,
			nm_usuario_nrec)
		SELECT	nextval('natureza_gasto_seq'),
			cd_estabelecimento_w,
			cd_natureza_gasto,
			ds_natureza_gasto,
			nm_usuario_p,
			clock_timestamp(),
			ie_situacao,
			ie_natureza_gasto,
			cd_grupo_natureza_gasto,
			qt_dias_prazo_medio,
			ie_resumo,
			cd_classif_result,
			cd_conta_contabil,
			nr_seq_gng,
			cd_empresa,
			clock_timestamp(),
			nm_usuario_p
		from	natureza_gasto
		where	nr_sequencia	= nr_sequencia_p;

	end if;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cus_copiar_natureza_estab ( cd_estabelecimento_p bigint, cd_natureza_gasto_p bigint, nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

