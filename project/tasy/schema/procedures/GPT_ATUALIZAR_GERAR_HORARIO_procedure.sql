-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gpt_atualizar_gerar_horario ( nr_prescricao_vigente_p prescr_medica.nr_prescricao%type, nr_seq_cpoe_p bigint, ie_tipo_item_p text, nm_usuario_p usuario.nm_usuario%type, cd_perfil_p perfil.cd_perfil%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


nr_seq_proc_interno_w			cpoe_procedimento.nr_seq_proc_interno%type;

type nr_prescricao_w is table of prescr_medica.nr_prescricao%type index by integer;
array_nr_prescricao_w			nr_prescricao_w;

type nr_sequencia_material_w is table of prescr_material.nr_sequencia%type index by integer;
array_nr_sequencia_material_w	nr_sequencia_material_w;

type nr_sequencia_procedimento_w is table of prescr_procedimento.nr_sequencia%type index by integer;
array_nr_seq_procedimento_w		nr_sequencia_procedimento_w;

type nr_sequencia_recomendacao_w is table of prescr_recomendacao.nr_sequencia%type index by integer;
array_nr_seq_recomendacao_w		nr_sequencia_recomendacao_w;

type nr_sequencia_gasoterapia_w is table of prescr_gasoterapia.nr_sequencia%type index by integer;
array_nr_seq_gasoterapia_w		nr_sequencia_gasoterapia_w;

c01 CURSOR FOR
	SELECT	a.nr_sequencia,
			a.nr_prescricao
	from	prescr_material a
	where	a.nr_seq_mat_cpoe = nr_seq_cpoe_p
	and		a.nr_prescricao < nr_prescricao_vigente_p
	and		not exists (	SELECT	1
						from	prescr_mat_hor x
						where	x.nr_prescricao = a.nr_prescricao
						and		x.nr_seq_material = a.nr_sequencia
						and		(x.dt_lib_horario IS NOT NULL AND x.dt_lib_horario::text <> ''))
	order by a.nr_prescricao;

c02 CURSOR FOR
	SELECT	distinct a.nr_prescricao,
			a.nr_sequencia
	from	prescr_procedimento a
	where	a.nr_prescricao < nr_prescricao_vigente_p
	and		a.nr_seq_proc_cpoe = nr_seq_cpoe_p
	and		a.nr_seq_proc_interno = nr_seq_proc_interno_w
	and		coalesce(a.nr_seq_origem::text, '') = ''
	and		not exists (	SELECT	1
						from	prescr_proc_hor z
						where	z.nr_prescricao = a.nr_prescricao
						and		z.nr_seq_procedimento = a.nr_sequencia
						and		(z.dt_lib_horario IS NOT NULL AND z.dt_lib_horario::text <> ''))
	order by a.nr_prescricao;

c03 CURSOR FOR
	SELECT	distinct a.nr_prescricao
	from	prescr_material a
	where	a.nr_prescricao < nr_prescricao_vigente_p
	and		a.nr_seq_dieta_cpoe = nr_seq_cpoe_p
	and		a.ie_agrupador in (8, 12, 16)
	and		not exists (	SELECT	1
						from	prescr_mat_hor z
						where	z.nr_prescricao = a.nr_prescricao
						and		z.nr_seq_material = a.nr_sequencia
						and		(z.dt_lib_horario IS NOT NULL AND z.dt_lib_horario::text <> ''))
	order by a.nr_prescricao;

c04 CURSOR FOR
	SELECT	distinct a.nr_prescricao
	from	prescr_dieta a
	where	a.nr_prescricao < nr_prescricao_vigente_p
	and		a.nr_seq_dieta_cpoe = nr_seq_cpoe_p
	and		not exists (	SELECT	1
						from	prescr_dieta_hor z
						where	z.nr_prescricao = a.nr_prescricao
						and		z.nr_seq_dieta = a.nr_sequencia
						and		(z.dt_lib_horario IS NOT NULL AND z.dt_lib_horario::text <> ''))
	order by a.nr_prescricao;

c05 CURSOR FOR
	SELECT	distinct a.nr_prescricao,
			a.nr_sequencia
	from	prescr_recomendacao a
	where	a.nr_prescricao < nr_prescricao_vigente_p
	and		a.nr_seq_rec_cpoe = nr_seq_cpoe_p
	and		not exists (	SELECT	1
						from	prescr_rec_hor z
						where	z.nr_prescricao = a.nr_prescricao
						and		z.nr_seq_recomendacao = a.nr_sequencia
						and		(z.dt_lib_horario IS NOT NULL AND z.dt_lib_horario::text <> ''))
	order by a.nr_prescricao;

c06 CURSOR FOR
	SELECT	distinct a.nr_prescricao,
			a.nr_sequencia
	from	prescr_gasoterapia a
	where	a.nr_prescricao < nr_prescricao_vigente_p
	and		a.nr_seq_gas_cpoe = nr_seq_cpoe_p
	and		not exists (	SELECT	1
						from	prescr_gasoterapia_hor z
						where	z.nr_prescricao = a.nr_prescricao
						and		z.nr_seq_gasoterapia = a.nr_sequencia
						and		(z.dt_lib_horario IS NOT NULL AND z.dt_lib_horario::text <> ''))
	order by a.nr_prescricao;

c07 CURSOR FOR
	SELECT	distinct a.nr_prescricao
	from	nut_pac a
	where	a.nr_prescricao < nr_prescricao_vigente_p
	and		a.nr_seq_npt_cpoe = nr_seq_cpoe_p
	order by a.nr_prescricao;


BEGIN

	if (ie_tipo_item_p	= 'M') then

		open c01;
		fetch c01 bulk collect into array_nr_sequencia_material_w, array_nr_prescricao_w;
		close c01;

		forall i in array_nr_prescricao_w.first..array_nr_prescricao_w.last
			update	prescr_material a
			set		a.hr_prim_horario  = NULL,
					a.ds_horarios  = NULL
			where	a.nr_sequencia = array_nr_sequencia_material_w(i)
			and		a.nr_prescricao = array_nr_prescricao_w(i);

		forall i in array_nr_prescricao_w.first..array_nr_prescricao_w.last
			update	prescr_material a
			set		a.hr_prim_horario  = NULL,
					a.ds_horarios  = NULL
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_kit = array_nr_sequencia_material_w(i)
			and		coalesce(a.nr_seq_recomendacao::text, '') = '';

	elsif (ie_tipo_item_p = 'SOL') then

		open c01;
		fetch c01 bulk collect into array_nr_sequencia_material_w, array_nr_prescricao_w;
		close c01;

		forall i in array_nr_prescricao_w.first..array_nr_prescricao_w.last
			update	prescr_material a
			set		a.ie_gerar_horario = 'N',
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_sequencia = array_nr_sequencia_material_w(i)
			and		a.nr_prescricao = array_nr_prescricao_w(i);

		forall i in array_nr_prescricao_w.first..array_nr_prescricao_w.last
			update	prescr_material a
			set		a.ie_gerar_horario = 'N',
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_kit = array_nr_sequencia_material_w(i)
			and		coalesce(a.nr_seq_recomendacao::text, '') = '';

	elsif (ie_tipo_item_p	= 'P') then

		select	max(a.nr_seq_proc_interno)
		into STRICT	nr_seq_proc_interno_w
		from	cpoe_procedimento a
		where	a.nr_sequencia = nr_seq_cpoe_p;

		open c02;
		fetch c02 bulk collect into array_nr_prescricao_w, array_nr_seq_procedimento_w;
		close c02;

		forall i in array_nr_prescricao_w.first..array_nr_prescricao_w.last
			update	prescr_procedimento a
			set		a.dt_prev_execucao  = NULL,
					a.ds_horarios  = NULL,
					a.dt_atualizacao = clock_timestamp(),
					a.nm_usuario = nm_usuario_p
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_sequencia = array_nr_seq_procedimento_w(i);

		/*Itens associados ao procedimento*/

		forall i in array_nr_prescricao_w.first..array_nr_prescricao_w.last
			update	prescr_material a
			set		a.ie_gerar_horario = 'N',
					a.dt_atualizacao = clock_timestamp(),
					a.nm_usuario = nm_usuario_p
			where	a.nr_sequencia_proc = array_nr_seq_procedimento_w(i)
			and		a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.ie_checar_adep = 'N'
			and		not exists (	SELECT	1
								from	prescr_mat_hor z
								where	z.nr_prescricao = a.nr_prescricao
								and		z.nr_seq_material = a.nr_sequencia
								and		(z.dt_lib_horario IS NOT NULL AND z.dt_lib_horario::text <> ''));

	elsif (ie_tipo_item_p = 'S') then

		open c03;
		fetch c03 bulk collect into array_nr_prescricao_w;
		close c03;

		forall i in array_nr_prescricao_w.first..array_nr_prescricao_w.last
			update	prescr_material a
			set		a.ie_gerar_horario = 'N',
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_dieta_cpoe = nr_seq_cpoe_p
			and		coalesce(a.ie_suspenso, 'N') = 'N'
			and		a.ie_agrupador = 12;

		forall i in array_nr_prescricao_w.first..array_nr_prescricao_w.last
			update	prescr_material a
			set		a.ie_gerar_horario = 'N',
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_kit in (	SELECT	b.nr_sequencia
										from	prescr_material b
										where	b.nr_prescricao = a.nr_prescricao
										and		b.nr_seq_dieta_cpoe = nr_seq_cpoe_p
										and		coalesce(b.ie_suspenso, 'N') = 'N'
										and		b.ie_agrupador = 12)
			and		coalesce(a.nr_seq_recomendacao::text, '') = '';

	elsif (ie_tipo_item_p = 'D') then

		open c04;
		fetch c04 bulk collect into array_nr_prescricao_w;
		close c04;
		
		forall i in array_nr_prescricao_w.first..array_nr_prescricao_w.last
			update	prescr_dieta a
			set		a.ie_gerar_horario = 'N',
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_dieta_cpoe = nr_seq_cpoe_p;

	elsif (ie_tipo_item_p = 'SNE') then

		open c03;
		fetch c03 bulk collect into array_nr_prescricao_w;
		close c03;

		forall i in array_nr_prescricao_w.first..array_nr_prescricao_w.last
			update	prescr_material a
			set		a.ie_gerar_horario = 'N',
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_dieta_cpoe = nr_seq_cpoe_p
			and		coalesce(a.ie_suspenso, 'N') = 'N'
			and		a.ie_agrupador = 8;

		forall i in array_nr_prescricao_w.first..array_nr_prescricao_w.last
			update	prescr_material a
			set		a.ie_gerar_horario = 'N',
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_kit in (	SELECT	b.nr_sequencia
										from	prescr_material b
										where	b.nr_prescricao = a.nr_prescricao
										and		b.nr_seq_dieta_cpoe = nr_seq_cpoe_p
										and		coalesce(b.ie_suspenso, 'N') = 'N'
										and		b.ie_agrupador = 8)
			and		coalesce(a.nr_seq_recomendacao::text, '') = '';

	elsif (ie_tipo_item_p = 'LD') then

		open c03;
		fetch c03 bulk collect into array_nr_prescricao_w;
		close c03;

		forall i in array_nr_prescricao_w.first..array_nr_prescricao_w.last
			update	prescr_material a
			set		a.ds_horarios  = NULL,
					a.hr_prim_horario  = NULL,
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_dieta_cpoe = nr_seq_cpoe_p
			and		coalesce(a.ie_suspenso, 'N') = 'N'
			and		a.ie_agrupador = 16;

		forall i in array_nr_prescricao_w.first..array_nr_prescricao_w.last
			update	prescr_material a
			set		a.ie_gerar_horario = 'N',
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_kit in (	SELECT	b.nr_sequencia
										from	prescr_material b
										where	b.nr_prescricao = a.nr_prescricao
										and		b.nr_seq_dieta_cpoe = nr_seq_cpoe_p
										and		coalesce(b.ie_suspenso, 'N') = 'N'
										and		b.ie_agrupador = 16)
			and		coalesce(a.nr_seq_recomendacao::text, '') = '';

	elsif (ie_tipo_item_p = 'R') then

		open c05;
		fetch c05 bulk collect into array_nr_prescricao_w, array_nr_seq_recomendacao_w;
		close c05;
		
		forall i in array_nr_prescricao_w.first..array_nr_prescricao_w.last
			update	prescr_recomendacao a
			set		a.ie_gerar_horario = 'N',
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_rec_cpoe = nr_seq_cpoe_p;

		forall i in array_nr_prescricao_w.first..array_nr_prescricao_w.last
			update	prescr_material a
			set		a.ie_gerar_horario = 'N',
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_kit = array_nr_seq_recomendacao_w(i)
			and		a.nr_seq_recomendacao = array_nr_seq_recomendacao_w(i);

	elsif (ie_tipo_item_p = 'O') then

		open c06;
		fetch c06 bulk collect into array_nr_prescricao_w, array_nr_seq_gasoterapia_w;
		close c06;

		forall i in array_nr_prescricao_w.first..array_nr_prescricao_w.last
			update	prescr_gasoterapia a
			set		a.ie_gerar_horario = 'N',
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_gas_cpoe = nr_seq_cpoe_p;

		forall i in array_nr_prescricao_w.first..array_nr_prescricao_w.last
			update	prescr_material a
			set		a.ie_gerar_horario = 'N',
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_gasoterapia = array_nr_seq_gasoterapia_w(i);

	elsif (ie_tipo_item_p in ('NPTA', 'NPTI')) then

		open c07;
		fetch c07 bulk collect into array_nr_prescricao_w;
		close c07;

		forall i in array_nr_prescricao_w.first..array_nr_prescricao_w.last
			update	nut_pac a
			set		a.ie_gerar_horario = 'N',
					a.nm_usuario = nm_usuario_p,
					a.dt_atualizacao = clock_timestamp()
			where	a.nr_prescricao = array_nr_prescricao_w(i)
			and		a.nr_seq_npt_cpoe = nr_seq_cpoe_p;

	end if;

	commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gpt_atualizar_gerar_horario ( nr_prescricao_vigente_p prescr_medica.nr_prescricao%type, nr_seq_cpoe_p bigint, ie_tipo_item_p text, nm_usuario_p usuario.nm_usuario%type, cd_perfil_p perfil.cd_perfil%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

