-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE eis_gerar_gestao_exame (dt_referencia_p timestamp, ie_opcao_p text) AS $body$
DECLARE



ie_opcao_w	varchar(2);


BEGIN

if (dt_referencia_p IS NOT NULL AND dt_referencia_p::text <> '') then

	if (ie_opcao_p = 'D') then
		ie_opcao_w	:= 'dd';
	else
		ie_opcao_w	:= 'mm';
	end if;

	delete	FROM eis_gestao_exame
	where	trunc(dt_prescricao, ie_opcao_w) = trunc(dt_referencia_p, ie_opcao_w);
	
	insert into eis_gestao_exame(	nr_sequencia,
					nr_prescricao,
					dt_prescricao,
					cd_medico,
					dt_liberacao_medico,
					nm_usuario_original,
					nm_usuario,
					dt_emissao_setor_atend,
					dt_liberacao,
					cd_pessoa_fisica,
					dt_prev_execucao,
					nr_seq_laudo,
					dt_liberacao_laudo,
					ie_status_execucao,
					cd_setor_atendimento,
					cd_procedimento,
					ie_origem_proced,
					nm_usuario_laudo,
					nm_usuario_aprovacao,
					nm_usuario_seg_aprov,
					cd_medico_exec,
					cd_medico_executor,
					cd_medico_resp,
					ie_autorizacao,
					ds_observacao,
					nr_seq_proc_interno,
					nr_seq_proced,
					nr_seq_propaci,
					ds_dado_clinico,
					nr_seq_motivo_parada,
					nr_atendimento,
					cd_material_exame,
					nr_prontuario,
					cd_setor_entrega,
					dt_baixa,
					dt_procedimento,
					cd_motivo_baixa,
					nr_seq_interno,
					cd_procedencia,
					nr_seq_agenda,
					ie_lado,
					cd_estabelecimento,
					nm_usuario_exec,
					ie_urgencia,
					ie_tipo_atendimento,
					ie_executar_leito,
					dt_inicio_exame,
					nr_seq_exame,
					cd_tipo_procedimento,
					cd_grupo_proc,
					cd_empresa,
					cd_setor_prescr_proced,
					cd_setor_prescricao,
					cd_proc_exec,
					ie_origem_exec,
					nr_seq_proc_interno_exec,
					nr_seq_tamanho_filme,
					qt_filme)
				SELECT	nextval('eis_gestao_exame_seq'),
					a.nr_prescricao,
					a.dt_prescricao,
					a.cd_medico,
					a.dt_liberacao_medico,
					a.nm_usuario_original,
					a.nm_usuario,
					b.dt_emissao_setor_atend,
					a.dt_liberacao,
					a.cd_pessoa_fisica,				
					b.dt_prev_execucao,
					d.nr_sequencia,
					d.dt_liberacao,
					b.ie_status_execucao,
					coalesce(b.cd_setor_atendimento, coalesce(a.cd_setor_entrega, a.cd_setor_atendimento)),
					b.cd_procedimento,
					b.ie_origem_proced,
					d.nm_usuario,
					d.nm_usuario_aprovacao,
					d.nm_usuario_seg_aprov,
					b.cd_medico_exec,
					c.cd_medico_executor,
					d.cd_medico_resp,
					b.ie_autorizacao,
					substr(b.ds_observacao,1,255),
					b.nr_seq_proc_interno,
					b.nr_sequencia,
					c.nr_sequencia,
					b.ds_dado_clinico,
					d.nr_seq_motivo_parada,
					a.nr_atendimento,
					b.cd_material_exame,
					g.nr_prontuario,
					a.cd_setor_entrega,
					b.dt_baixa,
					c.dt_procedimento,
					b.cd_motivo_baixa,
					b.nr_seq_interno,
					z.cd_procedencia,
					a.nr_seq_agenda,
					b.ie_lado,
					a.cd_estabelecimento,
					c.nm_usuario_original,
					b.ie_urgencia,
					z.ie_tipo_atendimento,
					coalesce(b.ie_executar_leito,'N'),
					b.dt_inicio_exame,
					b.nr_seq_exame,
					w.cd_tipo_procedimento,
					w.cd_grupo_proc,
					e.cd_empresa,
					b.cd_setor_atendimento,
					a.cd_setor_atendimento,
					c.cd_procedimento,
					c.ie_origem_proced,
					c.nr_seq_proc_interno,
					c.nr_seq_tamanho_filme,
					c.qt_filme
				FROM procedimento w, pessoa_fisica g, procedimento_paciente c
LEFT OUTER JOIN laudo_paciente d ON (c.nr_laudo = d.nr_sequencia)
LEFT OUTER JOIN conta_paciente f ON (c.nr_interno_conta = f.nr_interno_conta)
, prescr_procedimento b
LEFT OUTER JOIN procedimento_paciente c ON (b.nr_prescricao = c.nr_prescricao AND b.nr_sequencia = c.nr_sequencia_prescricao)
, prescr_medica a
LEFT OUTER JOIN atendimento_paciente z ON (a.nr_atendimento = z.nr_atendimento)
LEFT OUTER JOIN estabelecimento e ON (z.cd_estabelecimento = e.cd_estabelecimento)
WHERE w.cd_procedimento = b.cd_procedimento and w.ie_origem_proced = b.ie_origem_proced and a.cd_pessoa_fisica = g.cd_pessoa_fisica  and a.nr_prescricao = b.nr_prescricao      and ((b.cd_motivo_baixa = 0) or (coalesce(b.cd_motivo_baixa::text, '') = '') or (b.ie_status_execucao <> '10')) and coalesce(f.ie_cancelamento::text, '') = '' and b.ie_suspenso  <> 'S' and coalesce(a.dt_suspensao::text, '') = '' and trunc(a.dt_prescricao, ie_opcao_w) = trunc(dt_referencia_p, ie_opcao_w) and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '');				
	
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eis_gerar_gestao_exame (dt_referencia_p timestamp, ie_opcao_p text) FROM PUBLIC;

