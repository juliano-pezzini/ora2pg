-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE troca_libera_contrato_user ( cd_perfil_p bigint, nm_usuario_p text, cd_setor_p bigint, nm_usuario_lib_p text , cd_perfil_old_p bigint, cd_setor_old_p bigint, nm_usuario_lib_old_p text) AS $body$
BEGIN

if (cd_perfil_p IS NOT NULL AND cd_perfil_p::text <> '') then

    if (cd_perfil_p <> cd_perfil_old_p) then

        update contrato_usuario_lib a
        set a.cd_perfil = cd_perfil_p,
            a.dt_atualizacao = clock_timestamp(),
            a.nm_usuario = nm_usuario_p
        where a.cd_perfil = cd_perfil_old_p
        and (coalesce(obter_dados_contrato(nr_seq_contrato,'DF')::text, '') = '' or to_date(obter_dados_contrato(nr_seq_contrato,'DF'),'dd/mm/yyyy hh24:mi:ss') >= clock_timestamp())
        and	exists (SELECT 1 
                    from contrato b
                    where  b.nr_sequencia = a.nr_seq_contrato
                    and b.ie_situacao = 'A');

    else 
    
        CALL wheb_mensagem_pck.exibir_mensagem_abort(1096238);

    end if;

    
    
    elsif (cd_setor_p IS NOT NULL AND cd_setor_p::text <> '') then
    
         if (cd_setor_p <> cd_setor_old_p) then
                                  
            update contrato_usuario_lib a
            set a.cd_setor = cd_setor_p,
            a.dt_atualizacao = clock_timestamp(),
            a.nm_usuario = nm_usuario_p
            where a.cd_setor = cd_setor_old_p
            and (coalesce(obter_dados_contrato(nr_seq_contrato,'DF')::text, '') = '' or to_date(obter_dados_contrato(nr_seq_contrato,'DF'),'dd/mm/yyyy hh24:mi:ss') >= clock_timestamp())
            and	exists (SELECT 1 
                        from contrato b
                        where  b.nr_sequencia = a.nr_seq_contrato
                        and b.ie_situacao = 'A');

        else 
        
            CALL wheb_mensagem_pck.exibir_mensagem_abort(1096239);

        end if;

    elsif (nm_usuario_lib_p IS NOT NULL AND nm_usuario_lib_p::text <> '') then
   
        if (nm_usuario_lib_p <> nm_usuario_lib_old_p) then
                 
            update contrato_usuario_lib a
            set a.nm_usuario_lib = nm_usuario_lib_p,
            a.dt_atualizacao = clock_timestamp(),
            a.nm_usuario = nm_usuario_p
            where a.nm_usuario_lib = nm_usuario_lib_old_p
            and (coalesce(obter_dados_contrato(nr_seq_contrato,'DF')::text, '') = '' or to_date(obter_dados_contrato(nr_seq_contrato,'DF'),'dd/mm/yyyy hh24:mi:ss') >= clock_timestamp())
            and	exists (SELECT 1 
                        from contrato b
                        where  b.nr_sequencia = a.nr_seq_contrato
                        and b.ie_situacao = 'A');

        else 
        
            CALL wheb_mensagem_pck.exibir_mensagem_abort(1096240);

        end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE troca_libera_contrato_user ( cd_perfil_p bigint, nm_usuario_p text, cd_setor_p bigint, nm_usuario_lib_p text , cd_perfil_old_p bigint, cd_setor_old_p bigint, nm_usuario_lib_old_p text) FROM PUBLIC;

