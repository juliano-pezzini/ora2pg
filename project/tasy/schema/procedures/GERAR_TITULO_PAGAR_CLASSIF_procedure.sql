-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_titulo_pagar_classif ( ds_lista_titulos_p text, nr_titulo_destino_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w			bigint;
vl_titulo_w				double precision;
cd_conta_contabil_w		varchar(20);
cd_centro_custo_w		bigint;
nr_seq_conta_financ_w	bigint;
nr_seq_trans_fin_w		bigint;
nr_contrato_w			bigint;
vl_desconto_w			double precision;
nr_titulo_w				bigint;
nr_seq_produto_w		bigint;
ds_mensagem_w			varchar(255);

c01 CURSOR FOR
SELECT	cd_conta_contabil,
	cd_centro_custo,
	nr_seq_conta_financ,
	vl_titulo,
	nr_seq_trans_fin,
	nr_contrato,
	vl_desconto,
	nr_seq_produto
from	titulo_pagar_classif
where (' ' || replace(ds_lista_titulos_p, ',' , ' ') || ' ')  like('% ' || to_char(nr_titulo) || ' %');

c02 CURSOR FOR
SELECT	nr_titulo
from	titulo_pagar
where (' ' || replace(ds_lista_titulos_p, ',' , ' ') || ' ')  like('% ' || to_char(nr_titulo) || ' %');


BEGIN

open c01;
loop
fetch c01 into
	cd_conta_contabil_w,
	cd_centro_custo_w,
	nr_seq_conta_financ_w,
	vl_titulo_w,
	nr_seq_trans_fin_w,
	nr_contrato_w,
	vl_desconto_w,
	nr_seq_produto_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	update	titulo_pagar_classif
	set	vl_desconto = vl_desconto + vl_desconto_w,
		vl_titulo = vl_titulo + vl_titulo_w,
		nm_usuario = nm_usuario_p,
		dt_atualizacao = clock_timestamp()
	where	nr_titulo = nr_titulo_destino_p
	and	coalesce(cd_conta_contabil,0) = coalesce(cd_conta_contabil_w,0)
	and	coalesce(cd_centro_custo,0) = coalesce(cd_centro_custo_w,0)
	and	coalesce(nr_seq_conta_financ,0) = coalesce(nr_seq_conta_financ_w,0)
	and	coalesce(nr_seq_trans_fin,0) = coalesce(nr_seq_trans_fin_w,0)
	and	coalesce(nr_contrato,0) = coalesce(nr_contrato_w,0)
	and	coalesce(nr_seq_produto,0) = coalesce(nr_seq_produto_w,0);

	if (NOT FOUND) then
		begin
		select	coalesce(max(nr_sequencia), 0) + 1
		into STRICT	nr_sequencia_w
		from	titulo_pagar_classif
		where	nr_titulo	= nr_titulo_destino_p;

		insert into titulo_pagar_classif(
			nr_titulo,
			nr_sequencia,
			vl_titulo,
			dt_atualizacao,
			nm_usuario,
			cd_conta_contabil,
			cd_centro_custo,
			nr_seq_conta_financ,
			nr_seq_trans_fin,
			nr_contrato,
			nr_seq_produto,
			vl_desconto,
			vl_original)
		values (	nr_titulo_destino_p,
			nr_sequencia_w,
			vl_titulo_w,
			clock_timestamp(),
			nm_usuario_p,
			cd_conta_contabil_w,
			cd_centro_custo_w,
			nr_seq_conta_financ_w,
			nr_seq_trans_fin_w,
			nr_contrato_w,
			nr_seq_produto_w,
			vl_desconto_w,
			0);
		end;
	end if;
	end;
end loop;
close c01;

/* francisco - 142333 - troquei pelo cursor para atualizar o saldo e trocar a situacao */

open c02;
loop
fetch c02 into
	nr_titulo_w;
EXIT WHEN NOT FOUND; /* apply on c02 */

	ds_mensagem_w := substr(wheb_mensagem_pck.get_texto(304597),1,255);


	update	titulo_pagar
	set	ds_observacao_titulo	= substr(substr(ds_observacao_titulo, 1, 3733) || ' ' || ds_mensagem_w || ' ' || to_char(nr_titulo_destino_p), 1,4000), --substr de 3733 pois serão 4000 - 255 da ds_mensagem_W - 10 do título (maximo) - 2 espaços em branco
		nr_titulo_transf		= nr_titulo_destino_p
	where	nr_titulo			= nr_titulo_w;

	CALL atualizar_saldo_tit_pagar(nr_titulo_w,nm_usuario_p);
	CALL gerar_w_tit_pag_imposto(nr_titulo_w, nm_usuario_p);
end loop;
close c02;

--commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_titulo_pagar_classif ( ds_lista_titulos_p text, nr_titulo_destino_p bigint, nm_usuario_p text) FROM PUBLIC;

