-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_partic_analise ( nr_seq_analise_p bigint, nr_seq_grupo_p bigint, nr_seq_participante_p bigint, nr_seq_conta_proc_p bigint, ie_acao_executada_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text ) AS $body$
DECLARE

 
nr_seq_grau_partic_w	bigint;
nr_seq_participante_w	bigint;
ds_grau_participacao_w	varchar(255);
nr_seq_prestador_pgto_w	bigint;
nr_seq_conta_w		bigint;
nm_medico_w		varchar(255);
nm_prestador_w		varchar(255);
vl_calculado_w		bigint;
vl_total_apres_w	double precision;
vl_unitario_apres_w	double precision;
qt_apresentado_w	bigint;
nr_identificador_w	bigint;
nr_seq_cbo_saude_w	bigint;
cd_medico_w		bigint;
nr_seq_prestador_w	bigint;


BEGIN 
 
begin 
select	a.nr_seq_conta,	 
	a.qt_procedimento_imp 
into STRICT	nr_seq_conta_w,	 
	qt_apresentado_w 
from	pls_conta_proc 		a 
where	a.nr_sequencia		= nr_seq_conta_proc_p;
exception 
when others then 
	nr_seq_conta_w		:= null;
	qt_apresentado_w	:= null;
end;	
 
select	pls_obter_dados_prestador(a.nr_seq_prestador,'N'), 
	obter_nome_medico(a.cd_medico,'N'), 
	nr_seq_grau_partic,		 
	a.nr_seq_cbo_saude, 
	nr_seq_prestador, 
	cd_medico 
into STRICT	nm_prestador_w, 
	nm_medico_w, 
	nr_seq_grau_partic_w, 
	nr_seq_cbo_saude_w, 
	nr_seq_prestador_w, 
	cd_medico_w 
from	pls_proc_participante a 
where	a.nr_sequencia 	= nr_seq_participante_p;
 
select 	max(ds_grau_participacao) 
into STRICT	ds_grau_participacao_w		 
from  	pls_grau_participacao 
where 	ie_situacao 		= 'A' 
and 	cd_estabelecimento 	= cd_estabelecimento_p 
and	nr_sequencia		= nr_seq_grau_partic_w;
 
if (coalesce(ie_acao_executada_p,0) = 3) then 
 
	delete 	from pls_conta_medica_resumo 
	where 	nr_seq_conta_proc_partic = nr_seq_participante_p;
 
	delete	FROM pls_ocorrencia_benef 
	where	nr_seq_proc_partic	= nr_seq_participante_p;
	 
	delete	FROM pls_conta_glosa 
	where	nr_seq_proc_partic	= nr_seq_participante_p;
	 
	delete	FROM pls_analise_parecer_item 
	where	nr_seq_item		in (	SELECT	nr_sequencia 
						from	pls_analise_conta_item 
						where	nr_seq_proc_partic	= nr_seq_participante_p	);
	 
	delete	FROM pls_analise_conta_item 
	where	nr_seq_proc_partic	= nr_seq_participante_p;	
	 
	delete	FROM w_pls_resumo_conta 
	where	ie_tipo_item		= 'R' 
	and	nr_seq_partic_proc	= nr_seq_participante_p;
 
elsif (coalesce(ie_acao_executada_p,0) = 2) then 
	 
	CALL pls_atualiza_valor_proc(nr_seq_conta_proc_p, 'S', nm_usuario_p,'S',null,null);
	 
	update	pls_conta_proc 
	set	ie_status	= 'A' 
	where	nr_sequencia	= nr_seq_conta_proc_p 
	and	ie_status 	<> 'D';
	 
	begin 
	select	nr_seq_prestador_pgto, 
		coalesce(vl_calculado,0), 
		coalesce(dividir_sem_round(vl_apresentado, coalesce(qt_apresentado_w,0)),0), 
		coalesce(vl_apresentado,0) 
	into STRICT	nr_seq_prestador_pgto_w,	 
		vl_calculado_w, 
		vl_unitario_apres_w, 
		vl_total_apres_w 
	from	pls_proc_participante 
	where	nr_sequencia = nr_seq_participante_p;
	exception 
	when others then 
		nr_seq_prestador_pgto_w	:= null;
		vl_calculado_w		:= 0;
		vl_unitario_apres_w	:= 0;
		vl_total_apres_w	:= 0;
	end;
	 
	update	w_pls_resumo_conta 
	set	nm_participante		= coalesce(substr(pls_obter_dados_prestador(nr_seq_prestador_w,'N'),1,255),obter_nome_medico(cd_medico_w,'N')), 
		ds_grau_participacao	= pls_obter_grau_participacao( nr_seq_grau_partic_w ), 
		nr_seq_cbo_saude	= nr_seq_cbo_saude_w, 
		vl_calculado		= vl_calculado_w, 
		vl_unitario_apres	= vl_unitario_apres_w, 
		vl_total_apres		= vl_total_apres_w		 
	where	ie_tipo_item		= 'R' 
	and	nr_seq_partic_proc	= nr_seq_participante_p;	
 
elsif (coalesce(ie_acao_executada_p,0) = 1) then 
	 
	CALL pls_atualiza_valor_proc(nr_seq_conta_proc_p, 'S', nm_usuario_p,'S',null,null);
	 
	update	pls_conta_proc 
	set	ie_status	= 'A' 
	where	nr_sequencia	= nr_seq_conta_proc_p 
	and	ie_status 	<> 'D';
		 
	select	nr_seq_prestador_pgto, 
		coalesce(vl_calculado,0), 
		dividir_sem_round(vl_apresentado, coalesce(qt_apresentado_w,0)), 
		coalesce(vl_apresentado,0) 
	into STRICT	nr_seq_prestador_pgto_w,	 
		vl_calculado_w, 
		vl_unitario_apres_w, 
		vl_total_apres_w 
	from	pls_proc_participante 
	where	nr_sequencia = nr_seq_participante_p;
	 
	select (coalesce(max(nr_identificador),0) + 1) 
	into STRICT	nr_identificador_w 
	from	w_pls_resumo_conta 
	where	nr_seq_analise = nr_seq_analise_p;
		 
	insert into w_pls_resumo_conta(nr_sequencia, nr_seq_conta, nr_seq_item, 
		ds_tipo_despesa, ie_via_acesso, nr_seq_prestador_exec, 
		dt_item, cd_item, ie_origem_proced, 
		nr_seq_grau_partic, tx_item, ds_grau_participacao, 
		qt_apresentado, qt_liberado, vl_unitario, 
		vl_total, nr_seq_conta_referencia, cd_medico_executor, 
		ie_tipo_guia, cd_guia_referencia, cd_guia, 
		nr_seq_apres_prof,nm_usuario, dt_atualizacao, 
		nm_usuario_nrec, dt_atualizacao_nrec, ds_item, 
		nm_participante, ds_via_acesso,	nm_prestador, 
		ds_tipo_guia,ie_status,vl_calculado, 
		ie_ocorrencia_glosa, vl_unitario_apres, vl_total_apres, 
		nr_seq_protocolo, ie_status_conta, nm_prestador_pagamento, 
		ie_tipo_despesa, ie_tipo_item, ds_status_conta, 
		nr_seq_analise, cd_porte_anestesico, nr_auxiliares, 
		nr_seq_prestador_pgto, nr_seq_guia, ie_autorizado, 
		cd_classificacao_sip, cd_classif_cred, cd_classif_deb, 
		ie_carater_internacao, ie_exige_nf, nr_nota_fiscal, 
		nr_seq_res_conta_princ, nr_seq_prestador_solic, nm_prestador_solic, 
		nr_seq_prest_fornec, ds_fornecedor, ie_pagamento, 
		nr_seq_segurado, nm_segurado, cd_usuario_plano, 
		nm_prestador_exec, nr_identificador, nr_seq_partic_proc, 
		nr_seq_cbo_saude, nr_seq_item_ref, dt_inicio_item) 
	SELECT	nextval('w_pls_resumo_conta_seq'), nr_seq_conta, nr_seq_item, 
		'R' || ie_tipo_despesa, ie_via_acesso, nr_seq_prestador_exec, 
		dt_item, cd_item, ie_origem_proced, 
		nr_seq_grau_partic_w, tx_item, ds_grau_participacao_w, 
		coalesce(qt_apresentado,1), 0, 0, 
		0, nr_seq_conta_referencia, cd_medico_executor, 
		ie_tipo_guia, cd_guia_referencia, cd_guia, 
		nr_seq_apres_prof,nm_usuario, dt_atualizacao, 
		nm_usuario_nrec, dt_atualizacao_nrec, ds_item, 
		coalesce(substr(pls_obter_dados_prestador(nr_seq_prestador_w,'N'),1,255),obter_nome_medico(cd_medico_w,'N')), ds_via_acesso,	nm_prestador, 
		ds_tipo_guia,'L',coalesce(vl_calculado_w,0), 
		ie_ocorrencia_glosa, coalesce(vl_unitario_apres_w,0), vl_total_apres_w, 
		nr_seq_protocolo, ie_status_conta, nm_prestador_pagamento, 
		ie_tipo_despesa, 'R', ds_status_conta, 
		nr_seq_analise, cd_porte_anestesico, nr_auxiliares, 
		nr_seq_prestador_pgto_w, nr_seq_guia, ie_autorizado, 
		cd_classificacao_sip, cd_classif_cred, cd_classif_deb, 
		ie_carater_internacao, ie_exige_nf, nr_nota_fiscal, 
		nr_seq_res_conta_princ, nr_seq_prestador_solic, nm_prestador_solic, 
		nr_seq_prest_fornec, ds_fornecedor, 'G', 
		nr_seq_segurado, nm_segurado, cd_usuario_plano, 
		nm_prestador_exec, nr_identificador_w, nr_seq_participante_p, 
		nr_seq_cbo_saude_w, nr_seq_item_ref, dt_inicio_item 
	from	w_pls_resumo_conta 
	where	ie_tipo_item 	= 'P' 
	and	nr_seq_item	= nr_seq_conta_proc_p 
	and	nr_seq_analise	= nr_seq_analise_p;	
end if;
 
CALL pls_atualizar_conta_pos_estab(	nr_seq_conta_w, nr_seq_conta_proc_p, null, 
				nr_seq_analise_p, 'N', cd_estabelecimento_p, 
				nm_usuario_p	);
 
CALL pls_analise_status_item(nr_seq_conta_w,	null, null,				 
			nr_seq_analise_p, cd_estabelecimento_p,	nm_usuario_p, 
			nr_seq_participante_w);	
	 
CALL pls_analise_status_pgto(nr_seq_conta_w,	null, null,				 
			nr_seq_analise_p, cd_estabelecimento_p,	nm_usuario_p, 
			nr_seq_participante_w, null, null, 
			null);
			 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_partic_analise ( nr_seq_analise_p bigint, nr_seq_grupo_p bigint, nr_seq_participante_p bigint, nr_seq_conta_proc_p bigint, ie_acao_executada_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text ) FROM PUBLIC;

