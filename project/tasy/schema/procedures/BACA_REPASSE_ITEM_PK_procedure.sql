-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_repasse_item_pk (nm_usuario_p text) AS $body$
DECLARE


nr_seq_terceiro_w	bigint;
NR_REPASSE_TERCEIRO_w	bigint;
NR_SEQUENCIA_ITEM_w  	integer;
nr_sequencia_w		bigint;
nr_items_w		bigint := 0;


c01 CURSOR FOR

SELECT 	NR_REPASSE_TERCEIRO,
	NR_SEQUENCIA_ITEM,
	nextval('repasse_terceiro_item_seq')
from 	repasse_terceiro_item
where	coalesce(nr_sequencia::text, '') = '';


BEGIN

OPEN C01;
LOOP
FETCH C01 into	NR_REPASSE_TERCEIRO_w,
		NR_SEQUENCIA_ITEM_w,
		nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

	nr_items_w := nr_items_w + 1;

	select  max(nr_seq_terceiro)
	into STRICT	nr_seq_terceiro_w
	from	repasse_terceiro
	where	NR_REPASSE_TERCEIRO = NR_REPASSE_TERCEIRO_w;

	update 	repasse_terceiro_item
	set 	nr_sequencia 	= nr_sequencia_w,
		nr_seq_terceiro = nr_seq_terceiro_w,
		dt_liberacao 	= coalesce(dt_lancamento,dt_atualizacao)
	where	nr_repasse_terceiro = NR_REPASSE_TERCEIRO_w
	and	nr_sequencia_item = NR_SEQUENCIA_ITEM_w;

	if (nr_items_w = 5000) then
		commit;
		nr_items_w := 0;
	end if;


END LOOP;
close c01;

CALL Exec_sql_Dinamico('TASY', 	'ALTER TABLE REPASSE_TERCEIRO_ITEM ADD ' ||
				'(  ' ||
				'      CONSTRAINT REPTEIT_UK Unique  ( ' ||
				'               NR_REPASSE_TERCEIRO, ' ||
				'               NR_SEQUENCIA_ITEM) ' ||
				'USING INDEX   Tablespace TASY_INDEX) ');

CALL Exec_Sql_Dinamico('TASY',' alter table repasse_terceiro_item drop constraint REPTEIT_PK');

CALL Exec_Sql_Dinamico('TASY',' drop index REPTEIT_PK');

CALL Exec_Sql_Dinamico('TASY', ' ALTER TABLE repasse_terceiro_item ' ||
			  ' ADD (CONSTRAINT REPTEIT_PK Primary Key  (NR_SEQUENCIA) ' ||
			  ' USING INDEX   Tablespace TASY_INDEX) ');

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_repasse_item_pk (nm_usuario_p text) FROM PUBLIC;

