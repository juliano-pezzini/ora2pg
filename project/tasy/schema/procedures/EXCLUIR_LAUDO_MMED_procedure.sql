-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE excluir_laudo_mmed ( NR_SEQUENCIA_P bigint, NM_USUARIO_P text) AS $body$
DECLARE


NR_SEQUENCIA_PROC_W			bigint;
NR_SEQUENCIA_PRESCRICAO_W	bigint;
NR_PRESCRICAO_W				bigint;
NR_SEQ_INTERNO_W			bigint;
QT_EXISTE_PROC_DITADO_W		bigint;	
IE_STATUS_EXEC_W 			bigint;
NR_SEQUENCIA_OBS_W 			bigint;
			
C01 CURSOR FOR
SELECT	PROCEDIMENTO_PACIENTE.NR_SEQUENCIA,
	PROCEDIMENTO_PACIENTE.NR_PRESCRICAO,
	PROCEDIMENTO_PACIENTE.NR_SEQUENCIA_PRESCRICAO
FROM	PROCEDIMENTO_PACIENTE
LEFT JOIN 	CONTA_PACIENTE
ON 	PROCEDIMENTO_PACIENTE.NR_INTERNO_CONTA = CONTA_PACIENTE.NR_INTERNO_CONTA
WHERE	coalesce(CONTA_PACIENTE.IE_CANCELAMENTO,'N') = 'N'
AND	PROCEDIMENTO_PACIENTE.NR_LAUDO = NR_SEQUENCIA_P
AND (PROCEDIMENTO_PACIENTE.NR_PRESCRICAO IS NOT NULL AND PROCEDIMENTO_PACIENTE.NR_PRESCRICAO::text <> '')
AND (PROCEDIMENTO_PACIENTE.NR_SEQUENCIA_PRESCRICAO IS NOT NULL AND PROCEDIMENTO_PACIENTE.NR_SEQUENCIA_PRESCRICAO::text <> '');

C02_INTEGRACAO CURSOR FOR
SELECT DISTINCT OBS.NR_SEQUENCIA
FROM PROCEDIMENTO_PACIENTE P
JOIN PRESCR_PROCEDIMENTO PP ON (P.NR_PRESCRICAO = PP.NR_PRESCRICAO AND P.NR_SEQUENCIA_PRESCRICAO = PP.NR_SEQUENCIA)
JOIN PRESCR_PROCEDIMENTO_OBS OBS ON (PP.NR_PRESCRICAO = OBS.NR_PRESCRICAO AND PP.NR_SEQUENCIA = OBS.NR_SEQ_PRESCRICAO)
WHERE NR_LAUDO = NR_SEQUENCIA_P AND OBS.NM_USUARIO = 'SLEEPWARE';
			

BEGIN
OPEN C01;
LOOP
FETCH C01 INTO	
	NR_SEQUENCIA_PROC_W,
	NR_PRESCRICAO_W,
	NR_SEQUENCIA_PRESCRICAO_W;
EXIT WHEN NOT FOUND; /* apply on C01 */
	BEGIN
	
	SELECT	NR_SEQ_INTERNO
	INTO STRICT	NR_SEQ_INTERNO_W
	FROM	PRESCR_PROCEDIMENTO
	WHERE	NR_PRESCRICAO = NR_PRESCRICAO_W
	AND	NR_SEQUENCIA = NR_SEQUENCIA_PRESCRICAO_W;
	
	SELECT	COUNT(*)
	INTO STRICT	QT_EXISTE_PROC_DITADO_W
	FROM	PRESCR_PROC_DITADO
	WHERE	NR_SEQ_PRESCR_PROC = NR_SEQ_INTERNO_W;
	
  IF (QT_EXISTE_PROC_DITADO_W > 0) THEN
		
		DELETE	FROM PRESCR_PROC_STATUS
		WHERE	NR_PRESCRICAO = NR_PRESCRICAO_W
		AND	NR_SEQ_PRESCR = NR_SEQUENCIA_PRESCRICAO_W
		AND	IE_STATUS_EXEC > '25';

		UPDATE	PRESCR_PROCEDIMENTO
		SET	IE_STATUS_EXECUCAO = 25
		WHERE	NR_PRESCRICAO = NR_PRESCRICAO_W
		AND	NR_SEQUENCIA = NR_SEQUENCIA_PRESCRICAO_W;
		
	ELSE
  	BEGIN
      SELECT IE_STATUS_EXEC
        INTO STRICT IE_STATUS_EXEC_W 
        FROM (SELECT IE_STATUS_EXEC FROM PRESCR_PROC_STATUS WHERE NR_PRESCRICAO = NR_PRESCRICAO_W 
              AND NR_SEQ_PRESCR = NR_SEQUENCIA_PRESCRICAO_W AND IE_STATUS_EXEC IN ('20','22') ORDER BY DT_ATUALIZACAO DESC) alias1 LIMIT 1;
    EXCEPTION
       WHEN no_data_found THEN
        IE_STATUS_EXEC_W := 20;
    END;

		DELETE	FROM PRESCR_PROC_STATUS
		WHERE	NR_PRESCRICAO = NR_PRESCRICAO_W
		AND	NR_SEQ_PRESCR = NR_SEQUENCIA_PRESCRICAO_W
		AND	IE_STATUS_EXEC > '22';
		
		UPDATE	PRESCR_PROCEDIMENTO
		SET	IE_STATUS_EXECUCAO = IE_STATUS_EXEC_W
		WHERE	NR_PRESCRICAO = NR_PRESCRICAO_W
		AND	NR_SEQUENCIA = NR_SEQUENCIA_PRESCRICAO_W;	
	END IF;
	
	CALL GRAVAR_AUDITORIA_MMED(NR_PRESCRICAO_W,NR_SEQUENCIA_PRESCRICAO_W,NM_USUARIO_P,21,NULL);

	END;
END LOOP;
CLOSE C01;

OPEN C02_INTEGRACAO;
	LOOP
	FETCH C02_INTEGRACAO INTO	
		NR_SEQUENCIA_OBS_W;
	EXIT WHEN NOT FOUND; /* apply on C02_INTEGRACAO */
		BEGIN
			DELETE FROM PRESCR_PROCEDIMENTO_OBS
			WHERE NR_SEQUENCIA = NR_SEQUENCIA_OBS_W;
		END;
	END LOOP;
CLOSE C02_INTEGRACAO;

UPDATE	PROCEDIMENTO_PACIENTE
SET	NR_LAUDO  = NULL
WHERE	NR_LAUDO = NR_SEQUENCIA_P;

DELETE	FROM ENVELOPE_LAUDO_ITEM
WHERE	NR_SEQ_LAUDO =  NR_SEQUENCIA_P;

DELETE	FROM LAUDO_PACIENTE_MEDICO
WHERE	NR_SEQ_LAUDO =  NR_SEQUENCIA_P;

DELETE	FROM PRESCR_PROCED_INF_ADIC
WHERE	NR_SEQ_LAUDO =  NR_SEQUENCIA_P;

DELETE	FROM LAUDO_PACIENTE_PDF
WHERE	NR_SEQ_LAUDO = NR_SEQUENCIA_P;

DELETE	FROM LAUDO_PACIENTE_PDF_SERIAL
WHERE	NR_SEQ_LAUDO = NR_SEQUENCIA_P;

DELETE	FROM LAUDO_PACIENTE
WHERE	NR_SEQUENCIA = NR_SEQUENCIA_P;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE excluir_laudo_mmed ( NR_SEQUENCIA_P bigint, NM_USUARIO_P text) FROM PUBLIC;

