-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE salvar_posicao_card_suep ( nr_seq_suep_p bigint, ds_lista_posicoes_card_p text ) AS $body$
DECLARE


ds_lista_posicoes_card_w 	varchar(4000);
ds_lista_card_w 			varchar(4000);
ds_tipo_item_w				varchar(5);
pos_x_w						bigint;
pos_y_w						bigint;

ds_item_gerado_w			varchar(5);
pos_x_gerado_w				bigint;
pos_y_gerado_w				bigint;

nm_usuario_w				varchar(15);

nr_seq_apresenta_w			bigint := 0;

ie_item_cadastro_w			varchar(1);

C01 CURSOR FOR
	SELECT	ds_tipo_item,
			pos_x,
			pos_y
	from	w_suep_salvar_posicao
	where 	nm_usuario = nm_usuario_w
	and		nr_seq_suep = nr_seq_suep_p
	order by pos_y, pos_x, ds_tipo_item;


BEGIN

nm_usuario_w := wheb_usuario_pck.get_nm_usuario;

delete from w_suep_salvar_posicao
where 	nm_usuario = nm_usuario_w
and		nr_seq_suep = nr_seq_suep_p;

commit;


ds_lista_posicoes_card_w := substr(ds_lista_posicoes_card_p,1,4000);


if (substr(ds_lista_posicoes_card_w, length(ds_lista_posicoes_card_w))	<> '|') then
		ds_lista_posicoes_card_w	:= ds_lista_posicoes_card_w ||'|';
	end if;

while (ds_lista_posicoes_card_w IS NOT NULL AND ds_lista_posicoes_card_w::text <> '') loop
	begin

	ds_lista_card_w := substr( ds_lista_posicoes_card_w, 1, position('|' in ds_lista_posicoes_card_w) - 1);


	if (substr(ds_lista_card_w, length(ds_lista_card_w))	<> ',') then
		ds_lista_card_w	:= ds_lista_card_w ||',';
	end if;

	--  Item
	ds_tipo_item_w :=  substr(ds_lista_card_w, 1, position(',' in ds_lista_card_w) - 1);
	ds_lista_card_w	:= substr(ds_lista_card_w, position(',' in ds_lista_card_w) + 1, length(ds_lista_card_w));

	-- Posicao X
	pos_x_w :=  substr(ds_lista_card_w, 1, position(',' in ds_lista_card_w) - 1);
	ds_lista_card_w	:= substr(ds_lista_card_w, position(',' in ds_lista_card_w) + 1, length(ds_lista_card_w));

	-- Posicao Y
	pos_y_w :=  substr(ds_lista_card_w, 1, position(',' in ds_lista_card_w) - 1);
	ds_lista_card_w	:= substr(ds_lista_card_w, position(',' in ds_lista_card_w) + 1, length(ds_lista_card_w));

	if (ds_tipo_item_w IS NOT NULL AND ds_tipo_item_w::text <> '') then

		insert into  w_suep_salvar_posicao(  	nr_sequencia,
												dt_atualizacao,
												nm_usuario,
												dt_atualizacao_nrec,
												nm_usuario_nrec,
												ds_tipo_item,
												pos_x,
												pos_y,
												nr_seq_suep)
									values (  	nextval('w_suep_salvar_posicao_seq'),
												clock_timestamp(),
												nm_usuario_w,
												clock_timestamp(),
												nm_usuario_w,
												ds_tipo_item_w,
												pos_x_w,
												pos_y_w,
												nr_seq_suep_p);

		commit;

		Select  coalesce(max('S'),'N')
		into STRICT	ie_item_cadastro_w
		from	suep_posicao_usuario
		where 	nm_usuario = nm_usuario_w
		and		nr_seq_suep = nr_seq_suep_p
		and		ie_tipo_item = ds_tipo_item_w;

		if ( ie_item_cadastro_w = 'N') then

			insert into  suep_posicao_usuario(  	nr_sequencia,
												dt_atualizacao,
												nm_usuario,
												dt_atualizacao_nrec,
												nm_usuario_nrec,
												ie_tipo_item,
												nr_seq_suep)
									values (  	nextval('suep_posicao_usuario_seq'),
												clock_timestamp(),
												nm_usuario_w,
												clock_timestamp(),
												nm_usuario_w,
												ds_tipo_item_w,
												nr_seq_suep_p);

			commit;

		end if;

	end if;

	ds_lista_posicoes_card_w	:= substr(ds_lista_posicoes_card_w, position('|' in ds_lista_posicoes_card_w) + 1, length(ds_lista_posicoes_card_w));

	end;
end loop;

open C01;
loop
fetch C01 into
	ds_item_gerado_w,
	pos_x_gerado_w,
	pos_y_gerado_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	nr_seq_apresenta_w := nr_seq_apresenta_w + 10;


	update suep_posicao_usuario
	set	   nr_seq_apres = nr_seq_apresenta_w,
		   pos_x = pos_x_gerado_w,
		   pos_y = pos_y_gerado_w,
		   nm_usuario = nm_usuario_w,
		   dt_atualizacao = clock_timestamp()
	where  nr_seq_suep = nr_seq_suep_p
	and	   ie_tipo_item = 	ds_item_gerado_w;

	commit;

	end;
end loop;
close C01;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE salvar_posicao_card_suep ( nr_seq_suep_p bigint, ds_lista_posicoes_card_p text ) FROM PUBLIC;

