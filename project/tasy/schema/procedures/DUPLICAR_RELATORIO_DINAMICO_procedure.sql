-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicar_relatorio_dinamico (nr_seq_relatorio_p bigint, cd_relatorio_p bigint, nm_usuario_p text, nr_seq_novo_relatorio_p INOUT text) AS $body$
DECLARE


nr_seq_relatorio_dinamico_w bigint;
cd_relatorio_w bigint;
nr_seq_relatorio_w bigint;
classificacao_w varchar(1);

c01 CURSOR FOR
	SELECT nr_sequencia
	from relatorio_dinamico
	where nr_seq_relatorio = nr_seq_relatorio_p
	and cd_relatorio = cd_relatorio_p;


BEGIN

    select nextval('relatorio_seq')
    into STRICT nr_seq_relatorio_w
;
	
	select substr(cd_classif_relat,1,1)
	into STRICT classificacao_w
	from relatorio
	where nr_sequencia = nr_seq_relatorio_p
	and cd_relatorio = cd_relatorio_p;
	
	if (classificacao_w <> 'W') then

		select	Obter_Menor_Codigo_Relat('C')
		into STRICT	cd_relatorio_w
		;
	else
		select	Obter_Menor_Codigo_Relat('W')
		into STRICT	cd_relatorio_w
		;
	end	if;

	insert into relatorio(nr_sequencia,
		ds_titulo,
		dt_atualizacao,
		nm_usuario,
		ie_borda_sup,
		ie_borda_inf,
		ie_borda_esq,
		ie_borda_dir,
		ie_orientacao,
		ie_imprime_vazio,
		ie_filtro_html,
		ie_filtro_word,
		ie_tipo_papel,
		ie_filtro_excel,
		ie_filtro_texto,
		ds_cor_fundo,
		qt_margem_sup,
		qt_margem_inf,
		qt_margem_esq,
		qt_margem_dir,
		qt_espaco_coluna,    
		qt_coluna,
		nm_tabela, 
		ds_sql,
		nr_seq_modulo,  
		ie_chamada_direta,  
		cd_classif_relat, 
		cd_relatorio,    
		cd_relatorio_wheb, 
		cd_cgc_cliente,
		ie_etiqueta, 
		ie_gerar_base, 
		ds_regra, 
		ds_procedure,   
		ie_gerar_relatorio,
		qt_altura,
		qt_largura, 
		nr_seq_mod_impl,
		nr_seq_ordem_serv,   
		cd_classif_relat_wheb,  
		nr_versao,   
		cd_pais,     
		cd_relatorio_pais,     
		cd_classif_relat_pais, 
		cd_version,
		ds_action_name, 
		ie_ajustar_tamanho,  
		dt_last_modification,                       
		ds_report_title_custom)
	SELECT nr_seq_relatorio_w,
		substr(Obter_desc_expressao(342086) || nm_usuario_p || ' ' || ds_titulo,1,80),
		clock_timestamp(),                
		nm_usuario_p,
		ie_borda_sup,
		ie_borda_inf,
		ie_borda_esq,
		ie_borda_dir,
		ie_orientacao,
		ie_imprime_vazio,
		ie_filtro_html,
		ie_filtro_word,
		ie_tipo_papel,
		ie_filtro_excel,
		ie_filtro_texto,
		ds_cor_fundo,
		qt_margem_sup,
		qt_margem_inf,
		qt_margem_esq,
		qt_margem_dir,
		qt_espaco_coluna,    
		qt_coluna,
		nm_tabela, 
		ds_sql,
		nr_seq_modulo,  
		ie_chamada_direta,  
		cd_classif_relat, 
		cd_relatorio_w,    
		cd_relatorio_wheb, 
		cd_cgc_cliente,
		ie_etiqueta, 
		ie_gerar_base, 
		ds_regra, 
		ds_procedure,   
		ie_gerar_relatorio,
		qt_altura,
		qt_largura, 
		nr_seq_mod_impl,
		nr_seq_ordem_serv,   
		cd_classif_relat_wheb,  
		nr_versao,   
		cd_pais,     
		cd_relatorio_pais,     
		cd_classif_relat_pais, 
		cd_version,
		ds_action_name, 
		ie_ajustar_tamanho,  
		dt_last_modification,                       
		ds_report_title_custom
	from relatorio
	where nr_sequencia = nr_seq_relatorio_p
	and cd_relatorio = cd_relatorio_p;

	open c01;
	loop
	fetch c01 into
		nr_seq_relatorio_dinamico_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		insert into relatorio_dinamico(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,        
			nm_usuario_nrec,
			cd_relatorio,
			cd_tipo,
			ds_label,  
			nr_eixo_y,
			nr_eixo_x,
			nr_altura,
			nr_comprimento,
			qt_rotacao,
			nm_label,  
			ie_ajustar_tamanho,
			nr_seq_apres,  
			nr_tipo_banda,  
			nr_seq_relatorio, 
			qt_tamanho_banda,
			qt_altura_banda)
			SELECT nextval('relatorio_dinamico_seq'),
			clock_timestamp(),        
			nm_usuario_p,
			clock_timestamp(),        
			nm_usuario_p,
			cd_relatorio_w,
			cd_tipo,
			ds_label,  
			nr_eixo_y,
			nr_eixo_x,
			nr_altura,
			nr_comprimento,
			qt_rotacao,
			nm_label,  
			ie_ajustar_tamanho,
			nr_seq_apres,  
			nr_tipo_banda,  
			nr_seq_relatorio_w, 
			qt_tamanho_banda,
			qt_altura_banda
		from relatorio_dinamico
		where nr_sequencia = nr_seq_relatorio_dinamico_w;

	end loop;
	close c01;

	insert into parametro_relat_dinamico(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec, 
		nm_usuario_nrec,
		cd_relatorio,
		nr_seq_relatorio,
		nm_atributo,
		ie_tipo_comparacao,
		ie_tipo_atributo,
		ds_mascara,
		ie_formato_campo,
		nr_tamanho_obrigatorio,
		nr_linha,
		ds_valor_padrao)
	SELECT nextval('parametro_relat_dinamico_seq'),
		clock_timestamp(),         
		nm_usuario_p,
		clock_timestamp(), 
		nm_usuario_p,
		cd_relatorio_w,
		nr_seq_relatorio_w,
		nm_atributo,
		ie_tipo_comparacao,
		ie_tipo_atributo,
		ds_mascara,
		ie_formato_campo,
		nr_tamanho_obrigatorio,
		nr_linha,
		ds_valor_padrao
	from parametro_relat_dinamico
	where nr_seq_relatorio = nr_seq_relatorio_p
	and cd_relatorio = cd_relatorio_p;
	
	nr_seq_novo_relatorio_p := nr_seq_relatorio_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_relatorio_dinamico (nr_seq_relatorio_p bigint, cd_relatorio_p bigint, nm_usuario_p text, nr_seq_novo_relatorio_p INOUT text) FROM PUBLIC;

