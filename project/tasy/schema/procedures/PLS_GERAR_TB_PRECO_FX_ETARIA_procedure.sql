-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_tb_preco_fx_etaria ( nr_seq_tabela_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_tabela_nova_w		bigint;
qt_faixa_etaria_w		bigint;
nr_seq_plano_w			bigint;
nr_seq_preco_aux_w		bigint;
dt_inicio_vigencia_w		timestamp;
cd_codigo_ant_w			varchar(20);
nm_tabela_w			varchar(255);
vl_preco_atual_w		double precision;
vl_preco_atual_novo_w		double precision;
qt_idade_inicial_w		integer;
qt_idade_final_w		integer;
qt_idade_minima_w		integer;
nr_seq_preco_w			bigint;
nr_seq_sca_w			bigint;
ie_grau_titularidade_w		varchar(2);
nr_seq_faixa_etaria_w		bigint;
qt_vidas_inicial_w		integer;
qt_vidas_final_w		integer;
ie_proposta_adesao_w		varchar(2);
ie_preco_vidas_contrato_w	varchar(2);
ie_calculo_vidas_w		varchar(2);
nr_seq_principal_w		bigint;
tx_reajuste_w			double precision;
nr_seq_contrato_w		bigint;
dt_liberacao_w			pls_tabela_preco.dt_liberacao%type;

c01 CURSOR FOR
	SELECT	nr_sequencia,
		qt_idade_inicial,
		qt_idade_final
	from	pls_plano_preco
	where	nr_seq_tabela	= nr_seq_tabela_p
	order by qt_vidas_inicial, qt_idade_inicial;

c02 CURSOR FOR
	SELECT	nr_sequencia,
		qt_idade_inicial,
		qt_idade_final,
		ie_grau_titularidade,
		qt_vidas_inicial,
		qt_vidas_final,
		tx_reajuste
	from	pls_plano_preco
	where	nr_seq_tabela	= nr_seq_tabela_p
	order by qt_vidas_inicial, qt_idade_inicial;


BEGIN
select	nm_tabela,
	dt_inicio_vigencia,
	cd_codigo_ant,
	nr_seq_plano,
	nr_seq_sca,
	nr_seq_faixa_etaria,
	ie_proposta_adesao,
	ie_preco_vidas_contrato,
	ie_calculo_vidas,
	nr_seq_principal,
	nr_contrato,
	dt_liberacao
into STRICT	nm_tabela_w,
	dt_inicio_vigencia_w,
	cd_codigo_ant_w,
	nr_seq_plano_w,
	nr_seq_sca_w,
	nr_seq_faixa_etaria_w,
	ie_proposta_adesao_w,
	ie_preco_vidas_contrato_w,
	ie_calculo_vidas_w,
	nr_seq_principal_w,
	nr_seq_contrato_w,
	dt_liberacao_w
from	pls_tabela_preco
where	nr_sequencia	= nr_seq_tabela_p;

select	count(*)
into STRICT	qt_faixa_etaria_w
from	pls_plano_preco
where	nr_seq_tabela	= nr_seq_tabela_p;

if (qt_faixa_etaria_w > 0) then
	open c01;
	loop
	fetch c01 into
		nr_seq_preco_w,
		qt_idade_inicial_w,
		qt_idade_final_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		select	nextval('pls_tabela_preco_seq')
		into STRICT	nr_seq_tabela_nova_w
		;

		insert into pls_tabela_preco(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nm_tabela,
			dt_inicio_vigencia,
			nr_seq_plano,
			cd_codigo_ant,
			ie_tabela_base,
			nr_seq_sca,
			nr_seq_faixa_etaria,
			ie_proposta_adesao,
			ie_preco_vidas_contrato,
			ie_calculo_vidas,
			nr_seq_principal,
			nr_seq_faixa_etaria_princ,
			nr_contrato,
			dt_liberacao)
		values (nr_seq_tabela_nova_w,
			clock_timestamp(),
			nm_usuario_p,
			nm_tabela_w ||' - AdesÃ£o entre '||qt_idade_inicial_w||' a '||qt_idade_final_w,
			dt_inicio_vigencia_w,
			nr_seq_plano_w,
			cd_codigo_ant_w,
			'N',
			nr_seq_sca_w,
			nr_seq_faixa_etaria_w,
			ie_proposta_adesao_w,
			ie_preco_vidas_contrato_w,
			ie_calculo_vidas_w,
			nr_seq_tabela_p,
			nr_seq_preco_w,
			nr_seq_contrato_w,
			dt_liberacao_w);

		vl_preco_atual_novo_w	:= 0;

		open c02;
		loop
		fetch c02 into
			nr_seq_preco_aux_w,
			qt_idade_inicial_w,
			qt_idade_final_w,
			ie_grau_titularidade_w,
			qt_vidas_inicial_w,
			qt_vidas_final_w,
			tx_reajuste_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
			select	qt_idade_inicial,
				vl_preco_atual
			into STRICT	qt_idade_minima_w,
				vl_preco_atual_w
			from	pls_plano_preco
			where	nr_sequencia	= nr_seq_preco_w;

			if (qt_idade_inicial_w >= qt_idade_minima_w) then
				if (vl_preco_atual_novo_w = 0) then
					vl_preco_atual_novo_w := vl_preco_atual_w;
				else
					vl_preco_atual_novo_w	:= vl_preco_atual_novo_w + (vl_preco_atual_novo_w * tx_reajuste_w / 100);
				end if;
			else
				vl_preco_atual_novo_w	:= 0;
				tx_reajuste_w		:= 0;
			end if;

			insert into pls_plano_preco(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				nr_seq_tabela,
				qt_idade_inicial,
				qt_idade_final,
				vl_preco_inicial,
				vl_preco_atual,
				ie_grau_titularidade,
				tx_acrescimo,
				qt_vidas_inicial,
				qt_vidas_final)
			values (nextval('pls_plano_preco_seq'),
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_tabela_nova_w,
				qt_idade_inicial_w,
				qt_idade_final_w,
				vl_preco_atual_novo_w,
				vl_preco_atual_novo_w,
				ie_grau_titularidade_w,
				tx_reajuste_w,
				qt_vidas_inicial_w,
				qt_vidas_final_w);
			end;
		end loop;
		close c02;
		end;
	end loop;
	close c01;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_tb_preco_fx_etaria ( nr_seq_tabela_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

