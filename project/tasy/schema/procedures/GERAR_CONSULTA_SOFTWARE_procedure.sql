-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_consulta_software (nm_estacao_p text) AS $body$
DECLARE


ds_comando_w		varchar(512);
qt_tabela_w		smallint;
nm_estacao_w		varchar(255);
nr_seq_captura_w	bigint;

nm_software_w			varchar(60);
ds_local_instalador_w		varchar(255);
ie_instalacao_restrita_w	varchar(1);
ie_status_software_w		varchar(1);
ds_Sep_bv_w 			varchar(50);
ds_software_w			varchar(255);
nr_seq_software_w		bigint;

C01 CURSOR FOR
	/*Retorna os softwares livres ativos que não estão instalados na estação de trabalho*/

	SELECT 	a.nr_sequencia,
		a.nm_software,
		a.ds_local_instalador,
		a.ie_instalacao_restrita,
		a.ds_software,
		'N'
	from 	software a
	where	a.ie_tipo_licenca = 'L'
	and		a.ie_situacao = 'A'
	and	not exists (	SELECT 	1
			from	captura_software_detalhe b,
					captura_soft_det_espec c
			where	b.nr_sequencia = c.nr_seq_capt_soft_det
			and	b.nr_seq_capt_software = nr_seq_captura_w
			and	b.nr_id_soft_cap = a.nr_id_soft_cap
			and	c.nm_estacao_captura = nm_estacao_w)
	/*union
	select 	a.nr_sequencia,
			a.nm_software,
			a.ds_local_instalador,
			a.ie_instalacao_restrita,
			a.ds_software,
			'R'
	from 	software a
	WHERE	a.ie_situacao = 'I'
	and		a.ie_tipo_licenca not in ('D','U','L')
	and	exists (	select 	1
					from	captura_software_detalhe b,
							captura_soft_det_espec c
					where	b.nr_sequencia = c.nr_seq_capt_soft_det
					and		b.nr_seq_capt_software = nr_seq_captura_w
					and		b.nr_id_soft_cap = a.nr_id_soft_cap
					and		c.nm_estacao_captura = nm_estacao_w)*/
	
union

	select 	a.nr_sequencia,
			a.nm_software,
			a.ds_local_instalador,
			a.ie_instalacao_restrita,
			a.ds_software,
			'N'
	from 	software a,
		software_estacao b
	where	a.ie_tipo_licenca in ('P','LR')
	and	a.nr_sequencia = b.nr_seq_software
	and	b.nm_estacao_licenca = nm_estacao_w
	and	a.ie_situacao = 'A'
	and	not exists (	select 	1
			from	captura_software_detalhe b,
				captura_soft_det_espec c
			where	b.nr_sequencia = c.nr_seq_capt_soft_det
			and	b.nr_seq_capt_software = nr_seq_captura_w
			and	b.nr_id_soft_cap = a.nr_id_soft_cap
			and	c.nm_estacao_captura = nm_estacao_w)
	
union

	/*Retorna os softwares instalados de situação ativa*/

	select 	a.nr_sequencia,
			a.nm_software,
			a.ds_local_instalador,
			a.ie_instalacao_restrita,
			a.ds_software,
			'I'
	from 	software a
	where	a.ie_situacao = 'A'
	and	exists (	select 	1
			from	captura_software_detalhe b,
					captura_soft_det_espec c
			where	b.nr_sequencia = c.nr_seq_capt_soft_det
			and	c.ie_inconsistente = 'N'
			and	b.nr_seq_capt_software = nr_seq_captura_w
			and	b.nr_id_soft_cap = a.nr_id_soft_cap
			and	c.nm_estacao_captura = nm_estacao_w)
	
union

	/*Retorna os softwares instalados de situação inativa porém livres - O software não está inconsistênte porém não deve ser realizada novas instalações em outras estações.*/

	select 	a.nr_sequencia,
			a.nm_software,
			a.ds_local_instalador,
			a.ie_instalacao_restrita,
			a.ds_software,
			'I'
	from 	software a
	where	a.ie_situacao = 'I'
	and		a.ie_tipo_licenca = 'L'
	and	exists (	select 	1
			from	captura_software_detalhe b,
					captura_soft_det_espec c
			where	b.nr_sequencia = c.nr_seq_capt_soft_det
			and	c.ie_inconsistente = 'N'
			and	b.nr_seq_capt_software = nr_seq_captura_w
			and	b.nr_id_soft_cap = a.nr_id_soft_cap
			and	c.nm_estacao_captura = nm_estacao_w)
	
union

	/*Retorna os softwares inconsistêntes que devem ser removidos*/

	select 	0,
			substr(b.ds_software_cap,1,60),
			'',
			'',
			'',
			'R'
	from	captura_software_detalhe b,
			captura_soft_det_espec c
	where	b.nr_sequencia = c.nr_seq_capt_soft_det
	and		c.ie_inconsistente = 'S'
	and		b.nr_seq_capt_software = nr_seq_captura_w
	and		c.nm_estacao_captura = nm_estacao_w;



BEGIN
nm_estacao_w := upper(nm_estacao_p);
ds_sep_bv_w := obter_separador_bv;
--Criação da tabela temporária
select	count(*)
into STRICT	qt_tabela_w
from	tab
where	tname = 'W_CONSULTA_SOFTWARE';

if (qt_tabela_w = 0) then
	ds_comando_w := ' Create global temporary Table W_CONSULTA_SOFTWARE(nr_sequencia number(10), nm_software varchar2(60), ds_local_instalador varchar2(255), ds_software varchar2(255), ie_instalacao_restrita varchar2(1) , ie_status_software varchar2(1)) ON COMMIT PRESERVE ROWS';
	EXECUTE ds_comando_w;
else
	CALL exec_sql_dinamico('Tasy',' truncate table  W_CONSULTA_SOFTWARE ');
end if;

--Obterm a última captura
select 	max(nr_sequencia)
into STRICT	nr_seq_captura_w
from	captura_software;


open C01;
loop
fetch C01 into
	nr_seq_software_w,
	nm_software_w,
	ds_local_instalador_w,
	ie_instalacao_restrita_w,
	ds_software_w,
	ie_status_software_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

		CALL exec_sql_dinamico_bv('W_CONSULTA_SOFTWARE',
			'insert into W_CONSULTA_SOFTWARE ('||
			'	nr_sequencia,'||
			'	nm_software,'||
			'	ds_local_instalador,'||
			'	ie_instalacao_restrita,'||
			'	ie_status_software,'||
			'	ds_software'||
			') values ('||
			'	:nr_sequencia,'||
			'	:nm_software,'||
			'	:ds_local_instalador,'||
			'	:ie_instalacao_restrita,'||
			'	:ie_status_software,'||
			'	:ds_software)',
			'nr_sequencia='||nr_seq_software_w||ds_sep_bv_w||
			'nm_software='||nm_software_w||ds_sep_bv_w||
			'ds_local_instalador='||ds_local_instalador_w||ds_sep_bv_w||
			'ie_instalacao_restrita='||ie_instalacao_restrita_w||ds_sep_bv_w||
			'ie_status_software='||ie_status_software_w||ds_sep_bv_w||
			'ds_software='||ds_software_w);
	end;
end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_consulta_software (nm_estacao_p text) FROM PUBLIC;

