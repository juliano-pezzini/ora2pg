-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_prescricao_protocolo ( cd_pessoa_fisica_p text, cd_medico_p text, nr_atendimento_p bigint, cd_protocolo_p bigint, nr_sequencia_p bigint, qt_superf_corp_p bigint, qt_peso_p bigint, nr_horas_validade_p bigint, nr_prescricao_p INOUT bigint, dt_procedimento_p timestamp, ds_dados_clinicos_p text, dt_primeiro_horario_p text, dt_prescricao_p timestamp, cd_intervalo_p text, qt_protocolo_p bigint, ie_adep_p text, nm_usuario_p text, nm_computador_p text, dt_prim_horario_itens_p text, ie_urgencia_p text, nr_seq_pend_pac_acao_p bigint default null, ds_observacao_p text default null, ie_html_p text default 'N', ie_gerar_setor_pa_p text default 'N') AS $body$
DECLARE


qt_hora_w					bigint;
VarConsisteDataFutura_w		varchar(1);
VarVincularAtendPaciente_w	varchar(2);
ie_rec_alta_w				varchar(2);
cd_convenio_w				integer;
cd_estabelecimento_w		smallint;
nr_prescricao_w				bigint;
cd_setor_prot_w				bigint;
ie_origem_inf_w				varchar(1);
dt_primeiro_horario_w		timestamp;
dt_prim_horario_setor_w		timestamp;
ds_erro_w					varchar(255);
cd_pessoa_fisica_w			varchar(10);
cd_pessoa_paciente_w		varchar(10);
qt_altura_cm_w				real;
qt_peso_w					real;
ie_adep_w					varchar(1);
ie_hemodialise_w			varchar(1);
var_pac_usu_w				varchar(2);
dt_prim_horario_itens_w		varchar(15) := null;
cd_setor_usuario_w			integer;
cd_setor_rn_w			integer;
cd_setor_mae_w			integer;
cd_setor_prescr_w			integer := null;
qt_registro_w				bigint;
VarIdentPrescrADEP_w		varchar(15);
ie_recem_nato_w				varchar(2) := 'N';
ie_copia_peso_w				varchar(1);
ie_copia_altura_w			varchar(1);
ie_consiste_medic_w			varchar(10);
nr_atendimento_ww			bigint;
ds_observacao_w				varchar(2000);
ie_precritor_aux_w			varchar(1);
cd_setor_entrega_w			bigint;
ie_setor_Entrega_w			varchar(10);
ie_data_entrega_w			varchar(10);
dt_entrega_w				timestamp;
dt_entrada_w				timestamp;
dt_alta_w					timestamp;
ie_rep_alta_w				varchar(1);
ie_prescr_pos_alta_w		varchar(1);
dt_alta_medico_w			timestamp;
cd_perfil_w					integer	:= obter_perfil_ativo;
ie_setor_mae_w				char(1) := 'N';
nr_atendimento_mae_w		bigint;
qt_setor_exibe_rn_w			integer;	
ie_motivo_prescricao_w		varchar(3);
ie_rep_cpoe_w				parametro_medico.ie_rep_cpoe%type:='N';
cd_medico_w					prescr_medica.cd_medico%type;
cd_medic_w					prescr_medica.cd_medico%type;


BEGIN

-- Obter estabelecimento
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
	Select	cd_estabelecimento,
			dt_entrada,
			dt_alta,
			cd_pessoa_fisica,
			dt_alta_medico,
			cd_medico_resp
	into STRICT	cd_estabelecimento_w,
			dt_entrada_w,
			dt_alta_w,
			cd_pessoa_paciente_w,
			dt_alta_medico_w,
			cd_medic_w
	from	atendimento_paciente
	where	nr_atendimento	= nr_atendimento_p;
	
else
	select	cd_estabelecimento
	into STRICT	cd_estabelecimento_w
	from	usuario
	where	nm_usuario = nm_usuario_p;
	
	cd_pessoa_paciente_w	:= cd_pessoa_fisica_p;
	
end if;

ie_consiste_medic_w := obter_param_usuario(924, 18, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_consiste_medic_w);
ie_prescr_pos_alta_w := Obter_Param_Usuario(924, 174, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_prescr_pos_alta_w);

if (ie_prescr_pos_alta_w	= 'N') and (dt_alta_medico_w IS NOT NULL AND dt_alta_medico_w::text <> '') then
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(283054);
end if;

CALL Consiste_Protocolo_prescricao(cd_estabelecimento_w, cd_protocolo_p, nr_sequencia_p, ie_consiste_medic_w);

/* --> Rafael em 03/09/2007 OS67468;
Obter_Param_Usuario(924,162,obter_perfil_ativo,nm_usuario_p,cd_estabelecimento_w,ie_adep_w);
*/
if (Obter_Funcao_Ativa	= 950) then
	var_pac_usu_w := Obter_Param_Usuario(950, 6, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, var_pac_usu_w);
else
	var_pac_usu_w := Obter_Param_Usuario(924, 42, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, var_pac_usu_w);
end if;

/* obter_param_usuario(924,217,obter_perfil_ativo,nm_usuario_p,cd_estabelecimento_w,varPrescrNaoMedicaADEP_w); */

VarIdentPrescrADEP_w := obter_param_usuario(924, 246, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, VarIdentPrescrADEP_w);
ie_copia_peso_w := obter_param_usuario(924, 380, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_copia_peso_w);
ie_copia_altura_w := obter_param_usuario(924, 381, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_copia_altura_w);
ie_precritor_aux_w  := obter_param_usuario(924, 580, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_precritor_aux_w );
VarVincularAtendPaciente_w := obter_param_usuario(924, 729, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, VarVincularAtendPaciente_w);

select 	coalesce(max(nr_atendimento_mae),0)
into STRICT	nr_atendimento_mae_w
from	atendimento_paciente
where 	nr_atendimento = nr_atendimento_p;

	if (nr_atendimento_mae_w > 0) then
										
		select count(cd_setor_atendimento)
		into STRICT qt_setor_exibe_rn_w
		from setor_atendimento
		where ie_rn_mae = 'S'
		and cd_estabelecimento = cd_estabelecimento_w;

		if (qt_setor_exibe_rn_w > 0) then
	
			if (var_pac_usu_w in ('A','P')) then
				cd_setor_prescr_w := obter_unidade_atendimento(nr_atendimento_mae_w,'A','CS');
			elsif (var_pac_usu_w = 'D') then
			begin
			  select coalesce(ie_rn_mae,'N'), cd_setor_atendimento
			  into STRICT ie_setor_mae_w, cd_setor_mae_w
			  from setor_atendimento
			  where cd_setor_atendimento = obter_unidade_atendimento(nr_atendimento_mae_w,'A','CS');

			  select coalesce(max(a.cd_setor_atendimento),0)
			  into STRICT cd_setor_rn_w
			  from unidade_atendimento a
			  where a.nr_seq_interno = (SELECT coalesce(b.nr_seq_unidade_rn,0) from setor_atendimento b
        			                   where b.cd_setor_atendimento = obter_unidade_atendimento(nr_atendimento_p,'A','CS'));
			  if (ie_setor_mae_w = 'S') and (cd_setor_mae_w = cd_setor_rn_w) then
			    cd_setor_prescr_w := cd_setor_mae_w;
			  else
			    cd_setor_prescr_w := coalesce(obter_unidade_atendimento(nr_atendimento_p,'A','CS'), 0);
			  end if;
			end;
			else
				cd_setor_prescr_w := coalesce(obter_unidade_atendimento(nr_atendimento_p,'IA','CS'),obter_unidade_atendimento(nr_atendimento_p,'A','CS'));
			end if;
			
			select coalesce(ie_rn_mae,'N')
			into STRICT ie_setor_mae_w
			from setor_atendimento		
			where cd_setor_atendimento = cd_setor_prescr_w;
									
		end if;
		
	end if;

	if (ie_setor_mae_w = 'N') then

		if (var_pac_usu_w = 'U') then
			begin
			select	obter_setor_usuario(nm_usuario_p)
			into STRICT	cd_setor_usuario_w
			;

			select	count(*)
			into STRICT	qt_registro_w
			from	setor_atendimento a  
			where	a.cd_setor_atendimento in (	SELECT	b.cd_setor_atendimento    
								from	atend_paciente_unidade b     
								where	b.nr_atendimento	= NR_ATENDIMENTO_P 
								and	b.cd_setor_atendimento	= cd_setor_usuario_w );
			exception
			when others then
				qt_registro_w	:= 0;
			end;
		end if;

		if (var_pac_usu_w = 'C') then
			select	max(cd_setor_atendimento)
			into STRICT	cd_setor_prescr_w
			from	computador
			where	nm_computador_pesquisa  = padronizar_nome(upper(nm_computador_p));
			
			if (coalesce(cd_setor_prescr_w,0) = 0) then
				Select	coalesce(obter_unidade_atendimento(NR_ATENDIMENTO_P,'IA','CS'), obter_unidade_atendimento(NR_ATENDIMENTO_P,'A','CS'))
				into STRICT	cd_setor_prescr_w	
				;
			end if;
		elsif (var_pac_usu_w = 'A') then
			Select	coalesce(obter_unidade_atendimento(NR_ATENDIMENTO_P,'A','CS'), obter_unidade_atendimento(NR_ATENDIMENTO_P,'A','CS'))
			into STRICT	cd_setor_prescr_w	
			;
		elsif (var_pac_usu_w = 'U') and (NR_ATENDIMENTO_P > 0) and (qt_registro_w > 0) then
			cd_setor_prescr_w	:=	cd_setor_usuario_w;	
		elsif (NR_ATENDIMENTO_P > 0) then
			Select	coalesce(obter_unidade_atendimento(NR_ATENDIMENTO_P,'IA','CS'), obter_unidade_atendimento(NR_ATENDIMENTO_P,'A','CS'))
			into STRICT	cd_setor_prescr_w	
			;
		end if;

		if (var_pac_usu_w = 'R') then
			cd_setor_prescr_w	:= Obter_setor_prescr_regra(obter_perfil_ativo);
		end if;
	end if;

	select	max(cd_setor_atendimento),
			coalesce(max(ie_rep_alta),'N'),
			coalesce(max(ie_recem_nato),'N'),
			max(ie_hemodialise),
			max(ds_observacao),
			max(ie_motivo_prescricao)
	into STRICT	cd_setor_prot_w,
			ie_rep_alta_w,
			ie_recem_nato_w,
			ie_hemodialise_w,
			ds_observacao_w,
			ie_motivo_prescricao_w
	from	protocolo_medicacao
	where	cd_protocolo	= cd_protocolo_p
	and		nr_sequencia	= nr_sequencia_p;

	if (cd_setor_prot_w IS NOT NULL AND cd_setor_prot_w::text <> '') then
		cd_setor_prescr_w := cd_setor_prot_w;
	end if;	

	if (Obter_Funcao_Ativa	= 924 or Obter_Funcao_Ativa	= 950 or Obter_Funcao_Ativa	= 281) then
		
		ie_setor_Entrega_w  := obter_param_usuario(924, 167, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_setor_Entrega_w );

		if (ie_setor_Entrega_w	= 'S') then
			cd_setor_entrega_w	:= coalesce(wheb_usuario_pck.get_cd_setor_Atendimento,cd_setor_usuario_w);
		elsif (ie_setor_Entrega_w	= 'P' and (cd_setor_prescr_w IS NOT NULL AND cd_setor_prescr_w::text <> '')) then
			cd_setor_entrega_w	:= cd_setor_prescr_w;
		end if;
		
	end if;

begin
if (Obter_Funcao_Ativa	= 916) then
	
	ie_setor_Entrega_w  := obter_param_usuario(916, 270, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_setor_Entrega_w );
	ie_data_entrega_w  := obter_param_usuario(916, 45, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_data_entrega_w );
	
	
	if (ie_setor_Entrega_w	= 'P') and (nr_atendimento_p	> 0) then
		cd_setor_entrega_w	:= coalesce(obter_unidade_atendimento(NR_ATENDIMENTO_P,'IA','CS'), obter_unidade_atendimento(NR_ATENDIMENTO_P,'A','CS'));
	elsif (ie_setor_Entrega_w	= 'U') then
		cd_setor_entrega_w	:= coalesce(wheb_usuario_pck.get_cd_setor_Atendimento,cd_setor_usuario_w);
	elsif (ie_setor_Entrega_w	= 'C') then
		select	max(cd_setor_atendimento)
		into STRICT	ie_setor_Entrega_w
		from	computador
		where	nm_computador_pesquisa  = padronizar_nome(upper(nm_computador_p));
	
	end if;
	
	if (coalesce(nr_atendimento_p,0)	> 0) then
		if (ie_data_entrega_w	= 'E') then
			dt_entrega_w		:= dt_entrada_w;
		elsif (ie_data_entrega_w	= 'AE') and (dt_alta_w IS NOT NULL AND dt_alta_w::text <> '') then
			dt_entrega_w	:= dt_entrada_w;
		else
			dt_entrega_w	:= clock_timestamp();
			
		end if;
	
	end if;
	
end if;
exception
	when others then
	null;
end;

ie_adep_w := coalesce(ie_adep_p,'S');

select coalesce(max(ie_rep_cpoe),'N')
into STRICT	ie_rep_cpoe_w
from	parametro_medico
where	cd_estabelecimento	= cd_estabelecimento_w;

if (nr_prescricao_p = 0) then
	begin
	qt_hora_w := obter_param_usuario(924, 22, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, qt_hora_w);
	VarConsisteDataFutura_w := obter_param_usuario(924, 44, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, VarConsisteDataFutura_w);

	if	((nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') or (VarConsisteDataFutura_w = 'S')) and
		((clock_timestamp() + qt_hora_w / 24) < dt_prescricao_p) then
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(193888,'QT_DIAS='||qt_hora_w);
	end if;

	if (coalesce(cd_medico_p::text, '') = '') or (coalesce(dt_prescricao_p::text, '') = '') or (coalesce(cd_pessoa_fisica_p::text, '') = '') or (coalesce(cd_protocolo_p::text, '') = '') or (coalesce(nr_sequencia_p::text, '') = '') then
		--	'Os Campos Medico, Data, Paciente e Protocolo/Sequencia devem ser informados');
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(193889);		
	end if;

	-- Obter_Convenio do Atendimento
	if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
		begin
		select	cd_convenio
		into STRICT	cd_convenio_w
		from	atend_categoria_convenio
		where	nr_atendimento		= nr_atendimento_p
		and	dt_inicio_vigencia	=
				(SELECT	max(dt_inicio_vigencia)
				from	atend_categoria_convenio
				where	nr_atendimento = nr_atendimento_p);
		exception
			when others then
				cd_convenio_w := null;
		end;
	end if;

	
	-- Obter ie_origem_inf se e medico ou nao
	select 	coalesce(max('1'),'3')
	into STRICT	ie_origem_inf_w
	from	Medico b,
			Usuario a
	where 	a.nm_usuario		= nm_usuario_p
	and	a.cd_pessoa_fisica	= b.cd_pessoa_fisica;
	
	cd_medico_w := cd_medico_p;
	if ((coalesce(wheb_assist_pck.obterParametroFuncao(924, 1037),'N') = 'S') and (coalesce(obter_se_usuario_medico(nm_usuario_p),'S') = 'N')) then
      cd_medico_w := cd_medic_w;
	end if;
	
	begin
	dt_primeiro_horario_w	:= to_date(to_char(dt_prescricao_p,'dd/mm/yyyy ') ||
				substr(dt_Primeiro_horario_p,1,5)||':'||to_char(dt_prescricao_p,'ss'),'dd/mm/yyyy hh24:mi:ss');
	exception
		when others then
			dt_primeiro_horario_w	:= clock_timestamp();
	end;	
	
	begin
	select	cd_pessoa_fisica
	into STRICT	cd_pessoa_fisica_w
	from	usuario
	where	nm_usuario	= nm_usuario_p;
	exception
		when others then
			cd_pessoa_fisica_w	:= null;
	end;

	begin
	select	obter_sinal_vital(nr_atendimento_P,obter_desc_expressao(283402)/*'Altura'*/
),
		coalesce(qt_peso_p,obter_ultimo_sinal_vital_pf(cd_pessoa_fisica_w,'Peso'))
	into STRICT	qt_altura_cm_w,
		qt_peso_w
	;
	exception
		when others then
			qt_altura_cm_w	:= null;
			qt_peso_w	:= null;
	end;

	if (cd_setor_prescr_w > 0) then
		select	coalesce(max(ie_adep),ie_adep_w)
		into STRICT	ie_adep_w
		from	setor_atendimento
		where	cd_setor_atendimento = cd_setor_prescr_w;
	end if;
	
	/* Dalcastagne em 25/09/2008 OS 107843 */

	if (VarIdentPrescrADEP_w = 'NV') or (VarIdentPrescrADEP_w = 'PNV')then
		ie_adep_w := 'N';
	elsif (VarIdentPrescrADEP_w = 'SV') then
		ie_adep_w := 'S';
	end if;
	
	/* fim Rafael em 11/6/8 OS95393 */

	
	if (ie_copia_peso_w = 'N') then
		qt_peso_w	:= null;
	end if;
	
	if (ie_copia_altura_w = 'N') then
		qt_altura_cm_w	:= null;
	end if;
	
	nr_atendimento_ww := nr_atendimento_p;
	
	if (coalesce(nr_atendimento_p,0) = 0) then
		if (VarVincularAtendPaciente_w = 'S') then
			select	max(nr_atendimento)
			into STRICT		nr_atendimento_ww
			from		atendimento_paciente a
			where	cd_pessoa_fisica = cd_pessoa_paciente_w
			and		cd_estabelecimento = cd_estabelecimento_w
			and		ie_tipo_atendimento = 1
			and		coalesce(dt_alta::text, '') = ''
			and		ie_fim_conta <> 'F';
		elsif (VarVincularAtendPaciente_w = 'T') then
			select	max(nr_atendimento)
			into STRICT		nr_atendimento_ww
			from		atendimento_paciente a
			where	cd_pessoa_fisica = cd_pessoa_paciente_w
			and		cd_estabelecimento = cd_estabelecimento_w
			and		coalesce(dt_alta::text, '') = ''
			and		ie_fim_conta <> 'F';
		else
			nr_atendimento_ww := null;
		end if;
	end if;	
	
	if (coalesce(ie_html_p,'N') = 'N') then
		
		-- Obter numero da proxima prescricao
		select	nextval('prescr_medica_seq')
		into STRICT	nr_prescricao_w
		;
		
		insert into prescr_medica(
			nr_prescricao,
			cd_pessoa_fisica,
			nr_atendimento,
			cd_medico,
			dt_prescricao,
			dt_atualizacao,
			nm_usuario,
			nr_horas_validade,
			dt_primeiro_horario,
			ie_origem_inf,
			ie_recem_nato,
			nm_usuario_original,
			cd_protocolo,
			nr_seq_protocolo,
			cd_estabelecimento,
			cd_prescritor,
			qt_altura_cm,
			qt_peso,
			ie_adep,
			ie_prescr_emergencia,
			ie_prescricao_alta,
			cd_setor_atendimento,
			ie_hemodialise,
			ie_prescritor_aux,
			cd_setor_entrega,
			dt_entrega,
			nr_seq_pend_pac_acao,
			ds_observacao,
			cd_funcao_origem,
			ie_motivo_prescricao)
		values (
			somente_numero(nr_prescricao_w),
			cd_pessoa_paciente_w,
			nr_atendimento_ww,
			somente_numero(cd_medico_w),
			dt_prescricao_p,
			clock_timestamp(),
			nm_usuario_p,
			somente_numero(nr_horas_validade_p),
			dt_primeiro_horario_w,
			Somente_numero(ie_origem_inf_w),
			ie_recem_nato_w,
			nm_usuario_p,
			Somente_numero(cd_protocolo_p),
			Somente_numero(nr_sequencia_p),
			cd_estabelecimento_w,
			cd_pessoa_fisica_w,
			qt_altura_cm_w,
			qt_peso_w,
			ie_adep_w,
			'N',
			ie_rep_alta_w,
			cd_setor_prescr_w,
			ie_hemodialise_w,
			ie_precritor_aux_w,
			cd_setor_entrega_w,
			dt_entrega_w,
			nr_seq_pend_pac_acao_p,
			coalesce(ds_observacao_p,ds_observacao_w),
			obter_funcao_ativa,
			ie_motivo_prescricao_w);
		end if;
	end;
else
	nr_prescricao_w	:= nr_prescricao_p;
end if;

nr_prescricao_p	:= nr_prescricao_w;

if (dt_prim_horario_itens_p <> '  :  ') then
	dt_prim_horario_itens_w	:= dt_prim_horario_itens_p;
end if;

if (coalesce(ie_html_p,'N') = 'S') then
	nr_prescricao_p := null;
	CALL gerar_itens_protocolo_cpoe( cd_protocolo_p, nr_sequencia_p, nr_atendimento_p,  cd_pessoa_paciente_w,  cd_pessoa_fisica_w,  cd_estabelecimento_w, cd_perfil_w,
								nm_usuario_p, nr_seq_pend_pac_acao_p,  ie_rep_alta_w, null, somente_numero(cd_medico_w), 
								null, null, null, null, null, null, null, 'N', null, ie_gerar_setor_pa_p);	
else	
	CALL Inserir_item_protocolo_prescr(nr_prescricao_w, cd_protocolo_p, nr_sequencia_p, cd_intervalo_p, qt_protocolo_p, nm_usuario_p, coalesce(ie_urgencia_p,'N'),
					dt_procedimento_p, dt_prim_horario_itens_w, ds_dados_clinicos_p, qt_peso_p);


	ie_rec_alta_w := Obter_se_recomendacao_alta(nr_prescricao_w);
					
	if (coalesce(ie_rec_alta_w,'N') = 'S') then
		update prescr_medica
		set		ie_prescricao_alta = 'S'
		where	nr_prescricao = nr_prescricao_w;
	end if;
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

CALL gerar_plt_controle(cd_pessoa_paciente_w,nr_atendimento_ww,nm_usuario_p);

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_prescricao_protocolo ( cd_pessoa_fisica_p text, cd_medico_p text, nr_atendimento_p bigint, cd_protocolo_p bigint, nr_sequencia_p bigint, qt_superf_corp_p bigint, qt_peso_p bigint, nr_horas_validade_p bigint, nr_prescricao_p INOUT bigint, dt_procedimento_p timestamp, ds_dados_clinicos_p text, dt_primeiro_horario_p text, dt_prescricao_p timestamp, cd_intervalo_p text, qt_protocolo_p bigint, ie_adep_p text, nm_usuario_p text, nm_computador_p text, dt_prim_horario_itens_p text, ie_urgencia_p text, nr_seq_pend_pac_acao_p bigint default null, ds_observacao_p text default null, ie_html_p text default 'N', ie_gerar_setor_pa_p text default 'N') FROM PUBLIC;

