-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_processar_analise_cta_pend ( nm_usuario_p usuario.nm_usuario%type, nr_seq_analise_cons_p pls_cta_analise_cons.nr_sequencia%type) AS $body$
DECLARE


qt_registros_w			integer;
cd_estabelecimento_w		pls_conta.cd_estabelecimento%type;
ds_erro_w			pls_cta_analise_cons.ds_falha%type;
ds_stack_w			varchar(4000);
ds_err_stack_w			varchar(4000);
ds_sqlerrm_w			varchar(4000);
nm_id_sid_w			pls_cta_analise_cons.nm_id_sid%type;
nm_id_serial_w			pls_cta_analise_cons.nm_id_serial%type;
ie_status_final_w		pls_cta_analise_cons.ie_status%type;
dados_sid_w			pls_util_pck.dados_sid;


C01 CURSOR(	nr_seq_analise_cons_pc	pls_cta_analise_cons.nr_sequencia%type) FOR
	SELECT	nr_sequencia,
		nr_seq_analise
	from	pls_cta_analise_cons
	where	ie_status	= 'P'
	and	coalesce(nr_seq_analise_cons_pc::text, '') = ''
	
union all

	SELECT	nr_sequencia,
		nr_seq_analise
	from	pls_cta_analise_cons
	where	ie_status	<> 'F'
	and	nr_sequencia	= nr_seq_analise_cons_pc;

BEGIN
-- pega os dados da sessão atual para salvar no registro a fim de ter um maior controle sobre o mesmo
-- utilizada a pls_util_pck pois a mesma possui tratamento para ambientes RAC
dados_sid_w := pls_util_pck.obter_sid_sessao_atual;
CALL wheb_usuario_pck.set_nm_usuario(nm_usuario_p);
for r_c01_w in C01(nr_seq_analise_cons_p) loop

	select	count(1)
	into STRICT	qt_registros_w
	from	pls_cta_analise_cons
	where	nr_sequencia	= r_c01_w.nr_sequencia
	and	ie_status	in ('P','X');

	--Verifica se ainda está pendente o registro ou com falha
	if (qt_registros_w	> 0) then
		--Marca o registro para inicio de processamento
		update 	pls_cta_analise_cons
		set	ie_status		= 'I',
			dt_inicio_processamento	= clock_timestamp(),
			nm_id_sid		= dados_sid_w.nm_id_sid,
			nm_id_serial		= dados_sid_w.nm_id_serial
		where	nr_sequencia		= r_c01_w.nr_sequencia;

		commit;

		select	max(cd_estabelecimento)
		into STRICT	cd_estabelecimento_w
		from	pls_conta
		where	nr_seq_analise	= r_c01_w.nr_seq_analise;

		ds_erro_w		:= '';
		ie_status_final_w	:= 'F';

		--Consiste a análise
		begin
		CALL pls_consistir_analise(r_c01_w.nr_seq_analise,null,cd_estabelecimento_w,nm_usuario_p);
		exception
		when others then
			ds_stack_w := dbms_utility.format_call_stack;
			ds_err_stack_w := dbms_utility.format_error_backtrace;
			ds_sqlerrm_w := sqlerrm;
			ie_status_final_w := 'X';

			ds_erro_w := substr(	'Erro: ' || ds_sqlerrm_w || pls_util_pck.enter_w || pls_util_pck.enter_w ||
						'Stack:' || pls_util_pck.enter_w ||
						ds_stack_w || pls_util_pck.enter_w ||
						'Error Back Trace: ' || pls_util_pck.enter_w ||
						ds_err_stack_w,1,4000);
		end;


		--Marca o registro para fim de processamento
		update	pls_cta_analise_cons
		set	ds_falha		= ds_erro_w,
			ie_status		= ie_status_final_w,
			dt_fim_processamento  	= clock_timestamp()
		where	nr_sequencia		= r_c01_w.nr_sequencia;

		if (ie_status_final_w	!= 'X') then

			--Marca a análise para "Em auditoria"
			update	pls_analise_conta
			set	ie_status	= 'A'
			where	nr_sequencia	= r_c01_w.nr_seq_analise
			and	ie_status	= 'D';
		end if;

		commit;
	end if;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_processar_analise_cta_pend ( nm_usuario_p usuario.nm_usuario%type, nr_seq_analise_cons_p pls_cta_analise_cons.nr_sequencia%type) FROM PUBLIC;

