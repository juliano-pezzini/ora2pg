-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE proj_gerar_score_consult_con ( nr_seq_projeto_p bigint, nr_seq_item_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_executor_w			bigint;
nr_seq_executor_w		bigint;
nr_seq_quant_modulo_w		bigint;
nr_seq_conhecimento_w		bigint;
nr_Seq_consultor_w		bigint;
pr_conhecimento_total_w		bigint;
qt_funcoes_w			bigint;
pr_conhecimento_total_ww	bigint;
qt_modulo_ww			bigint;
qt_modulo_w			bigint;
qt_funcoes_ww			bigint;
qt_consultor_w			bigint;
qt_resultado_w			bigint;


C01 CURSOR FOR
	SELECT	distinct a.cd_executor, b.nr_sequencia
	from	proj_rat a,
		com_canal_consultor b
	where	a.cd_executor = b.cd_pessoa_fisica
	and	a.nr_seq_proj = nr_seq_projeto_p;

C02 CURSOR FOR
	SELECT 	count(distinct b.nr_seq_mod_impl)
	from   	com_cons_gest_con_fun a,
		com_cons_gest_con_mod b
	where  	a.nr_seq_conhecimento = b.nr_sequencia
	and 	b.nr_seq_consultor = nr_seq_executor_w;


BEGIN

select	count(distinct cd_executor)
into STRICT	qt_consultor_w
from	proj_rat a,
	com_canal_consultor b
where	a.cd_executor = b.cd_pessoa_fisica
and	a.nr_seq_proj = nr_seq_projeto_p;

open C01;
loop
fetch C01 into
	cd_executor_w,
	nr_seq_executor_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select 	count(*)
	into STRICT	qt_funcoes_w
	from   	com_cons_gest_con_fun a,
		com_cons_gest_con_mod b
	where  	a.nr_seq_conhecimento = b.nr_sequencia
	and	b.nr_seq_consultor = nr_seq_executor_w;

	qt_funcoes_ww := qt_funcoes_ww + qt_funcoes_w;

	/*select 	count(*)
	into	qt_modulo_w
	from   	com_cons_gest_con_mod
	where  	nr_seq_consultor = nr_seq_consultor_w;

	qt_modulo_ww := qt_modulo_ww + qt_modulo_w;*/
	open C02;
	loop
	fetch C02 into
		nr_seq_quant_modulo_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		select 	sum(pr_conhecimento)
		into STRICT	pr_conhecimento_total_w
		from   	com_cons_gest_con_fun a,
			com_cons_gest_con_mod b
		where  	a.nr_seq_conhecimento = b.nr_sequencia
		and	b.nr_seq_consultor = nr_seq_executor_w;

		pr_conhecimento_total_ww := pr_conhecimento_total_ww + pr_conhecimento_total_w;
		end;
	end loop;
	close C02;
	end;
end loop;
close C01;

if (qt_funcoes_ww > 0) and (pr_conhecimento_total_ww > 0) then
	qt_resultado_w := ((pr_conhecimento_total_ww / qt_funcoes_ww) / qt_consultor_w);
end if;

update 	proj_escore_item
set	qt_escore_real = qt_resultado_w
where	nr_sequencia = nr_seq_item_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proj_gerar_score_consult_con ( nr_seq_projeto_p bigint, nr_seq_item_p bigint, nm_usuario_p text) FROM PUBLIC;

