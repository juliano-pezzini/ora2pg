-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_elem_prot_hemodialise ( nr_prescricao_p bigint, nr_seq_solucao_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
qt_itens_w			bigint;
nr_seq_elemento_w			bigint;
cd_unidade_medida_w		varchar(30);
qt_elemento_w			double precision;
nr_sequencia_w			bigint;
nr_seq_protocolo_w		bigint;
nr_seq_elem_mat_w		bigint;
qt_volume_w			double precision;
qt_volume_ww			double precision;
nr_erro_w				bigint;
cd_material_w			integer;
qt_dose_w			double precision;
ie_via_aplicacao_w			varchar(5);
ie_dose_peso_w			varchar(5);
cd_intervalo_w			varchar(7);
ie_dispensacao_w			varchar(5);
qt_peso_w			real;

cd_estabelecimento_w		smallint;
dt_prescricao_w			timestamp;
dt_primeiro_horario_w		timestamp;
nr_horas_validade_w		integer;
cd_setor_atendimento_w		integer;

 
cd_unidade_consumo_w		varchar(30);
ds_horarios_w			varchar(2000);
ds_horarios_ww			varchar(2000);
nr_agrupamento_w			double precision;
nr_intervalo_w			bigint;
qt_conversao_dose_w		double precision;
qt_unitaria_w			double precision;
qt_produto_w			double precision;
qt_total_dispensar_w		double precision;
ds_erro_w			varchar(255);
cd_unidade_medida_ww		varchar(255);
ds_observacao_w			varchar(4000);
hr_prim_horario_w			varchar(5);

nr_seq_material_w			integer;
qt_solucao_w			double precision;

ie_regra_disp_w			varchar(1);/* Rafael em 15/3/8 OS86206 */
 
c01 CURSOR FOR 
	SELECT	nr_seq_elemento, 
		cd_unidade_medida, 
		qt_elemento 
	from	protocolo_npt_item 
	where	nr_seq_protocolo = nr_seq_protocolo_w;

c02 CURSOR FOR 
	SELECT	cd_material, 
		qt_volume, 
		cd_unidade_medida, 
		ds_observacao, 
		ie_dose_peso, 
		ie_dispensacao 
	from	protocolo_npt_prod 
	where	nr_seq_protocolo = nr_seq_protocolo_w;

 

BEGIN 
 
if (nr_seq_solucao_p IS NOT NULL AND nr_seq_solucao_p::text <> '') then 
	begin 
	delete	FROM prescr_material 
	where	nr_prescricao		= nr_prescricao_p 
	and	nr_sequencia_solucao	= nr_seq_solucao_p 
	and	ie_agrupador		= 13;
	 
	delete	FROM hd_prescr_sol_elem 
	where	nr_prescricao	= nr_prescricao_p 
	and	nr_seq_solucao	= nr_seq_solucao_p;
	 
	commit;
	 
	select	coalesce(max(nr_seq_protocolo),0) 
	into STRICT	nr_seq_protocolo_w 
	from	prescr_solucao 
	where	nr_prescricao	= nr_prescricao_p 
	and	nr_seq_solucao	= nr_seq_solucao_p;
 
	select	count(*) 
	into STRICT	qt_itens_w 
	from	hd_prescr_sol_elem 
	where	nr_prescricao	= nr_prescricao_p 
	and	nr_seq_solucao	= nr_seq_solucao_p;
 
	if (qt_itens_w = 0) then 
		begin 
 
		open c01;
		loop 
		fetch c01 into 
			nr_seq_elemento_w, 
			cd_unidade_medida_w, 
			qt_elemento_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
	 
			select	nextval('hd_prescr_sol_elem_seq') 
			into STRICT	nr_sequencia_w 
			;
 
			insert	into hd_prescr_sol_elem( 
				nr_sequencia, 
				dt_atualizacao, 
				nm_usuario, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				nr_prescricao, 
				nr_seq_solucao, 
				nr_seq_elemento, 
				cd_unidade_medida, 
				qt_elemento) 
			values ( 
				nr_sequencia_w, 
				clock_timestamp(), 
				nm_usuario_p, 
				clock_timestamp(), 
				nm_usuario_p, 
				nr_prescricao_p, 
				nr_seq_solucao_p, 
				nr_seq_elemento_w, 
				cd_unidade_medida_w, 
				qt_elemento_w);
		end loop;
		close c01;
		 
		end;
	end if;
 
	select	count(*) 
	into STRICT	qt_itens_w 
	from	prescr_material 
	where	nr_prescricao		= nr_prescricao_p 
	and	nr_sequencia_solucao	= nr_seq_solucao_p 
	and	ie_agrupador		= 13;
 
	if (qt_itens_w = 0) then 
		begin 
	 
		/* gerar produto */
 
		select	coalesce(max(nr_sequencia),0), 
			coalesce(max(nr_agrupamento),0)					 
		into STRICT	nr_seq_material_w, 
			nr_agrupamento_w 
		from	prescr_material 
		where	nr_prescricao = nr_prescricao_p;
 
		cd_unidade_medida_w	:= obter_unid_med_usua('ml');
 
		open c02;
		loop 
		fetch c02 into 	cd_material_w, 
				qt_volume_w, 
				cd_unidade_medida_ww, 
				ds_observacao_w, 
				ie_dose_peso_w, 
				ie_dispensacao_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
	 
			if (cd_unidade_medida_ww IS NOT NULL AND cd_unidade_medida_ww::text <> '') then 
				cd_unidade_medida_w := cd_unidade_medida_ww;
			end if;
			 
			select	coalesce(qt_volume_w,coalesce(max(qt_volume),0)), 
				coalesce(max(nr_etapas),1) 
			into STRICT	qt_dose_w, 
				nr_intervalo_w 
			from	prescr_solucao 
			where	nr_prescricao	= nr_prescricao_p 
			and	nr_seq_solucao	= nr_seq_solucao_p;
			 
			 
 
			/* obter dados prescricao */
 
			select	cd_estabelecimento, 
				dt_prescricao, 
				dt_primeiro_horario, 
				nr_horas_validade, 
				cd_setor_atendimento, 
				qt_peso 
			into STRICT	cd_estabelecimento_w, 
				dt_prescricao_w, 
				dt_primeiro_horario_w, 
				nr_horas_validade_w, 
				cd_setor_atendimento_w, 
				qt_peso_w 
			from	prescr_medica 
			where	nr_prescricao = nr_prescricao_p;
			 
			if (ie_dose_peso_w = 'S') and (coalesce(qt_peso_w,0) > 0) then 
				qt_dose_w	:= qt_dose_w * qt_peso_w;
			end if;
 
			/* obter unidade consumo material */
 
			select	substr(obter_dados_material_estab(cd_material,cd_estabelecimento_w,'UMS'),1,30) cd_unidade_medida_consumo 
			into STRICT	cd_unidade_consumo_w 
			from	material 
			where	cd_material = cd_material_w;
 
			/* obter conversao dose */
 
			select	obter_conversao_unid_med(cd_material_w, cd_unidade_medida_w) 
			into STRICT	qt_conversao_dose_w 
			;
 
			/* obter quantidade consumo */
 
			select	obter_conversao_unid_med_cons(cd_material_w, cd_unidade_medida_w, qt_dose_w) 
			into STRICT	qt_unitaria_w 
			;
 
			/* obter quantidade dispensar */
 
			SELECT * FROM obter_quant_dispensar(cd_estabelecimento_w, cd_material_w, nr_prescricao_p, 0, cd_intervalo_w, ie_via_aplicacao_w, qt_unitaria_w, 0, 1, null, null, cd_unidade_medida_w, null, qt_produto_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w, 'N', 'N') INTO STRICT qt_produto_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w;
			 
			/* Verifica o campo IE_DISPENSACAO da tabela PROTOCOLO_NPT_PROD e aplica a regra do mesmo */
 
			if (ie_dispensacao_w = 'N') then 
				ie_regra_disp_w := 'N';
			elsif (ie_dispensacao_w = 'T') then 
				ie_regra_disp_w := 'S';
			end if;
			 
			/* atualizar agrupamento */
 
			nr_agrupamento_w 	:= nr_agrupamento_w + 1;
			nr_seq_material_w	:= nr_seq_material_w + 1;
			 
			/*obter se medicamento possui convers√£o para ml*/
 
			select	coalesce(obter_conversao_ml(cd_material_w,qt_dose_w,cd_unidade_medida_w),0) 
			into STRICT	qt_volume_ww 
			;
 
			/* inserir produto */
 
			insert into prescr_material( 
				nr_prescricao, 
				nr_sequencia, 
				nr_sequencia_solucao, 
				ie_origem_inf, 
				cd_material, 
				cd_unidade_medida, 
				qt_dose, 
				qt_unitaria, 
				qt_material, 
				qt_solucao, 
				dt_atualizacao, 
				nm_usuario, 
				cd_intervalo, 
				nr_agrupamento, 
				cd_motivo_baixa, 
				ie_utiliza_kit, 
				cd_unidade_medida_dose, 
				qt_conversao_dose, 
				ie_urgencia, 
				nr_ocorrencia, 
				qt_total_dispensar, 
				ie_medicacao_paciente, 
				ie_agrupador, 
				ie_suspenso, 
				ie_se_necessario, 
				ie_bomba_infusao, 
				ie_aplic_bolus, 
				ie_aplic_lenta, 
				ie_acm, 
				ie_cultura_cih, 
				ie_antibiograma, 
				ie_uso_antimicrobiano, 
				ie_recons_diluente_fixo, 
				ie_sem_aprazamento, 
				ie_regra_disp, 
				ds_observacao) 
			values ( 
				nr_prescricao_p, 
				nr_seq_material_w, 
				nr_seq_solucao_p, 
				'N', 
				cd_material_w, 
				cd_unidade_consumo_w, 
				qt_dose_w, 
				qt_unitaria_w, 
				qt_produto_w, 
				qt_volume_ww, 
				clock_timestamp(), 
				nm_usuario_p, 
				cd_intervalo_w, 
				nr_agrupamento_w, 
				0, 
				'N', 
				cd_unidade_medida_w, 
				qt_conversao_dose_w, 
				'N', 
				nr_intervalo_w, 
				qt_total_dispensar_w, 
				'N', 
				13, 
				'N', 
				'N', 
				'N', 
				'N', 
				'N', 
				'N', 
				'N', 
				'N', 
				'N', 
				'N', 
				'N', 
				ie_regra_disp_w, 
				ds_observacao_w);
				 
			nr_erro_w := Consistir_Prescr_Material(nr_prescricao_p, nr_seq_material_w, nm_usuario_p, obter_perfil_ativo, nr_erro_w); /*Almir em 09/10/2007 OS70754 */
 
		end loop;
		close c02;
		 
		end;
	end if;
	end;
end if;
 
select	sum(qt_solucao) 
into STRICT	qt_solucao_w 
from	prescr_material 
where	nr_prescricao		= nr_prescricao_p 
and	nr_sequencia_solucao	= nr_seq_solucao_p 
and	ie_agrupador		= 13;
 
update	prescr_solucao 
set	qt_solucao_total	= qt_solucao_w 
where	nr_prescricao		= nr_prescricao_p 
and	nr_seq_solucao		= nr_seq_solucao_p;
 
CALL Calcular_Elem_Hemodialise(nr_prescricao_p, nr_seq_solucao_p, nm_usuario_p);
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_elem_prot_hemodialise ( nr_prescricao_p bigint, nr_seq_solucao_p bigint, nm_usuario_p text) FROM PUBLIC;

