-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_liberar_auditoria ( nr_seq_auditoria_p bigint, nm_usuario_p text, ie_item_pendente_p INOUT text) AS $body$
DECLARE



ds_observacao_w			varchar(4000);
ie_ajuste_w			varchar(255)	:= 'N';				
dt_ult_parecer_dia_w 		varchar(255);
dt_ult_parecer_hora_w 		varchar(255);
dt_atual_grupo_hora_w		varchar(255);
dt_atual_grupo_dia_w		varchar(255);
cd_pessoa_fisica_w		varchar(14);
ie_tipo_despesa_w		varchar(10);
ie_envia_email_aud_externo_w	varchar(2);
ie_tipo_processo_w		varchar(2);
ie_exige_senha_ext_w		varchar(2);
ie_encerrar_analise_grupos_w	varchar(1);
ie_existe_item_pendente_w	varchar(1)	:= 'N';
ie_auditoria_estip_w		varchar(1);
ds_liberar_parecer_w		varchar(1);
ds_liberar_parecer_auditor_w	varchar(1);
ie_parecer_w			varchar(1)	:= 'S';
ie_tipo_item_w			varchar(1);
ie_parecer_auditor_item_w	varchar(1);
ie_externo_w			varchar(1);
ie_regra_despesa_w		varchar(1);
ie_utiliza_nivel_lib_w		varchar(1)	:= 'N';	
ie_possui_nivel_lib_w		varchar(1)	:= 'S';
ie_inserir_parecer_glosa_w	varchar(1)	:= 'N';
qt_original_w			double precision;
qt_ajuste_w			double precision;
qt_liberacao_w			bigint;
nr_seq_grupo_w			bigint;
nr_seq_guia_w			bigint;
nr_seq_requisicao_w		bigint;
nr_seq_auditoria_item_w		bigint;
nr_seq_grupo_auditor_w		bigint;
nr_seq_item_origem_w		bigint;
nr_seq_execucao_w		bigint;
nr_seq_regra_pos_estip_w	bigint;
nr_seq_historico_aud_w		bigint;
qt_grupo_w			integer;
qt_item_pendente_w		integer;
qt_parecer_w			integer;
cd_estabelecimento_w		smallint;
ie_tipo_auditoria_w		smallint;
ie_status_w			pls_auditoria_item.ie_status%type;
qt_itens_aut_w			integer := 0;

C01 CURSOR FOR
	SELECT	nr_sequencia,
		ie_tipo_despesa,
		CASE WHEN coalesce(cd_procedimento::text, '') = '' THEN  'M'  ELSE 'P' END ,
		qt_original,
		qt_ajuste
	from	pls_auditoria_item
	where	nr_seq_auditoria	= nr_seq_auditoria_p
	and	ie_status_solicitacao	= 'P'	
	and	((coalesce(ie_acao_auditor::text, '') = '') or (ie_acao_auditor <> 'E'));
	
C02 CURSOR FOR
	SELECT	nr_sequencia,
		ie_status
	from	pls_auditoria_item
	where	nr_seq_auditoria	= nr_seq_auditoria_p;
	

BEGIN
ds_liberar_parecer_w		:= obter_valor_param_usuario(1270, 5, Obter_Perfil_Ativo, nm_usuario_p, 0);
ds_liberar_parecer_auditor_w	:= obter_valor_param_usuario(1270, 8, Obter_Perfil_Ativo, nm_usuario_p, 0);
ie_encerrar_analise_grupos_w	:= obter_valor_param_usuario(1270, 30, Obter_Perfil_Ativo, nm_usuario_p, 0);
ie_inserir_parecer_glosa_w	:= obter_valor_param_usuario(1270, 77, Obter_Perfil_Ativo, nm_usuario_p, 0);

nr_seq_grupo_w	:= coalesce(pls_obter_grupo_analise_atual(nr_seq_auditoria_p), 0);

select	nr_seq_guia,
	nr_seq_requisicao,
	nr_seq_execucao,
	ie_auditoria_estipulante,
	cd_estabelecimento
into STRICT	nr_seq_guia_w,
	nr_seq_requisicao_w,
	nr_seq_execucao_w,
	ie_auditoria_estip_w,
	cd_estabelecimento_w
from	pls_auditoria
where	nr_sequencia	= nr_seq_auditoria_p;

select	nr_seq_grupo
into STRICT	nr_seq_grupo_auditor_w
from	pls_auditoria_grupo
where	nr_sequencia	= nr_seq_grupo_w;

begin
select	ie_tipo_auditoria
into STRICT	ie_tipo_auditoria_w
from	pls_grupo_auditor
where	nr_sequencia	= nr_seq_grupo_auditor_w;
exception
when others then
	ie_tipo_auditoria_w	:= 0;
end;

-- Verificar o parametro 5
if (ds_liberar_parecer_w = 'N') and (ie_tipo_auditoria_w <> 3) then
	ie_utiliza_nivel_lib_w	:= pls_obter_se_uti_nivel_lib_aut(cd_estabelecimento_w);
	
	if (coalesce(nr_seq_guia_w,0) > 0) then
		open C01;
		loop
		fetch C01 into
			nr_seq_auditoria_item_w,
			ie_tipo_despesa_w,
			ie_tipo_item_w,
			qt_original_w,
			qt_ajuste_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			ie_regra_despesa_w	:= pls_obter_se_regra_despesa_aud(	ie_tipo_despesa_w,
											ie_tipo_item_w,
											nr_seq_grupo_auditor_w);
			
			if (ie_utiliza_nivel_lib_w	= 'S')
			and (ie_tipo_auditoria_w <> 4) then
				ie_possui_nivel_lib_w	:= pls_obter_se_auditor_nivel_lib(	nr_seq_auditoria_p,
												nr_seq_auditoria_item_w,
												nr_seq_grupo_auditor_w,
												nm_usuario_p,
												'N');
			end if;
			
			if (ie_regra_despesa_w = 'S') and (ie_possui_nivel_lib_w = 'S') then				
				select	count(1)
				into STRICT	qt_parecer_w
				from	pls_guia_plano_historico
				where (ie_tipo_historico = 'AP'
				or	ie_tipo_historico = 'AM')
				and	nr_seq_grupo	= nr_seq_grupo_auditor_w
				and	nr_Seq_item	= nr_seq_auditoria_item_w;
				
				Select 	to_char(min(Dt_Atualizacao), 'DD/MM/YYYY'),
					to_char(min(Dt_Atualizacao), 'HH24:MI:SS')
				into STRICT	dt_atual_grupo_dia_w,
					dt_atual_grupo_hora_w
				From	Pls_Auditoria_Grupo
				Where	Nr_Seq_Grupo 		= nr_seq_grupo_auditor_w
				And	coalesce(Dt_Liberacao::text, '') = ''
				And	Nr_Seq_Auditoria 	= nr_seq_auditoria_p
				and	nm_usuario_exec		= nm_usuario_p;
				
				Select	to_char(max(Dt_Atualizacao), 'DD/MM/YYYY'),
					to_char(max(Dt_Atualizacao), 'HH24:MI:SS')
				into STRICT	dt_ult_parecer_dia_w,
					dt_ult_parecer_hora_w
				From	Pls_Guia_Plano_Historico
				Where (Ie_Tipo_Historico = 'AP'
				Or	Ie_Tipo_Historico = 'AM')
				And	Nr_Seq_Grupo	= nr_seq_grupo_auditor_w
				And	Nr_Seq_Item	= nr_seq_auditoria_item_w;

				if (qt_parecer_w = 0) or (to_date(dt_atual_grupo_dia_w, 'DD/MM/YYYY') > to_date(dt_ult_parecer_dia_w, 'DD/MM/YYYY')) or
					((to_date(dt_atual_grupo_dia_w, 'DD/MM/YYYY') = to_date(dt_ult_parecer_dia_w, 'DD/MM/YYYY')) and (to_date(dt_atual_grupo_hora_w, 'HH24:MI:SS') > to_date(dt_ult_parecer_hora_w, 'HH24:MI:SS'))) then

					ie_parecer_w	:= 'N';
					exit;
				end if;			
			end if;
			end;
		end loop;
		close C01;
	elsif (coalesce(nr_seq_requisicao_w, 0) > 0) then
		open C01;
		loop
		fetch C01 into
			nr_seq_auditoria_item_w,
			ie_tipo_despesa_w,
			ie_tipo_item_w,
			qt_original_w,
			qt_ajuste_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			ie_regra_despesa_w	:= pls_obter_se_regra_despesa_aud(	ie_tipo_despesa_w,
											ie_tipo_item_w,
											nr_seq_grupo_auditor_w);
			if (ie_utiliza_nivel_lib_w	= 'S') then
				ie_possui_nivel_lib_w	:= pls_obter_se_auditor_nivel_lib(	nr_seq_auditoria_p,
												nr_seq_auditoria_item_w,
												nr_seq_grupo_auditor_w,
												nm_usuario_p,
												'N');
			end if;
			
			if (ie_regra_despesa_w = 'S') and (ie_possui_nivel_lib_w = 'S') then	
				select	count(1)
				into STRICT	qt_parecer_w
				from	pls_requisicao_historico
				where (ie_tipo_historico = 'AP'
				or	ie_tipo_historico = 'AM')
				and	nr_seq_grupo	= nr_seq_grupo_auditor_w
				and	nr_Seq_item	= nr_seq_auditoria_item_w;
				
				Select 	to_char(min(Dt_Atualizacao), 'DD/MM/YYYY'),
					to_char(min(Dt_Atualizacao), 'HH24:MI:SS')
				into STRICT	dt_atual_grupo_dia_w,
					dt_atual_grupo_hora_w
				From	Pls_Auditoria_Grupo
				Where	Nr_Seq_Grupo 		= nr_seq_grupo_auditor_w
				And	coalesce(Dt_Liberacao::text, '') = ''
				And	Nr_Seq_Auditoria 	= nr_seq_auditoria_p
				and	nm_usuario_exec		= nm_usuario_p;
				
				Select	to_char(max(Dt_Atualizacao), 'DD/MM/YYYY'),
					to_char(max(Dt_Atualizacao), 'HH24:MI:SS')
				into STRICT	dt_ult_parecer_dia_w,
					dt_ult_parecer_hora_w
				From	pls_requisicao_historico
				Where (Ie_Tipo_Historico = 'AP'
				Or	Ie_Tipo_Historico = 'AM')
				And	Nr_Seq_Grupo	= nr_seq_grupo_auditor_w
				And	Nr_Seq_Item	= nr_seq_auditoria_item_w;
				
				if (qt_parecer_w = 0) or (to_date(dt_atual_grupo_dia_w, 'DD/MM/YYYY') > to_date(dt_ult_parecer_dia_w, 'DD/MM/YYYY')) or
					((to_date(dt_atual_grupo_dia_w, 'DD/MM/YYYY') = to_date(dt_ult_parecer_dia_w, 'DD/MM/YYYY')) and (to_date(dt_atual_grupo_hora_w, 'HH24:MI:SS') > to_date(dt_ult_parecer_hora_w, 'HH24:MI:SS'))) then

					ie_parecer_w	:= 'N';
					exit;
				end if;
			end if;
			end;
		end loop;
		close C01;
	end if;	
end if;

if (ie_parecer_w = 'S') then
	select	count(1)
	into STRICT	qt_grupo_w
	from	pls_auditoria_grupo
	where	nr_seq_auditoria	= nr_seq_auditoria_p
	and	coalesce(dt_liberacao::text, '') = '';

	select	count(1)
	into STRICT	qt_item_pendente_w
	from	pls_auditoria_item
	where	nr_seq_auditoria	= nr_seq_auditoria_p
	and	ie_status in ('P','J');

	if (qt_grupo_w = 1) and (qt_item_pendente_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(177257,'');
		--Voce nao pode encerrar a analise enquanto houver algum item pendente ou aguardando justificativa
	end if;

	update	pls_auditoria_grupo
	set	dt_liberacao	= clock_timestamp(),
		ie_status	= 'P',
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_seq_grupo_w;
	
	if (qt_grupo_w > 1) and (ie_encerrar_analise_grupos_w = 'S') then
		ie_existe_item_pendente_w := pls_liberar_todos_grupos(	nr_seq_auditoria_p, nm_usuario_p, ie_existe_item_pendente_w);		
	end if;
	
	ie_item_pendente_p	:= ie_existe_item_pendente_w;
	
	select	count(1)
	into STRICT	qt_liberacao_w
	from	pls_auditoria_grupo
	where	coalesce(dt_liberacao::text, '') = ''
	and	nr_seq_auditoria	= nr_seq_auditoria_p;

	if (coalesce(nr_seq_requisicao_w, 0) > 0) then
		select	ie_tipo_processo
		into STRICT	ie_tipo_processo_w
		from	pls_requisicao
		where	nr_sequencia	= nr_seq_requisicao_w;
	elsif (coalesce(nr_seq_guia_w,0) > 0) then
		select	ie_tipo_processo
		into STRICT	ie_tipo_processo_w
		from	pls_guia_plano
		where	nr_sequencia	= nr_seq_guia_w;
	end if;

	if (qt_liberacao_w = 0) then
		update	pls_auditoria
		set	dt_liberacao	= clock_timestamp(),
			ie_status	= 'F',
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp()
		where	nr_sequencia	= nr_seq_auditoria_p;

		--OS 482469 - Realizado o tratamento abaixo para setar ao campo ie_auditor_finaliza o valor S, sendo utilizado para saber qual foi o ultimo historico gerado para o item da analise 
		if (coalesce(nr_seq_guia_w, 0) > 0) then
			open C02;
			loop
			fetch C02 into	
				nr_seq_auditoria_item_w,
				ie_status_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin
				
				select	max(nr_sequencia)
				into STRICT	nr_seq_historico_aud_w
				from	pls_guia_plano_historico
				where	ie_tipo_historico in ('AP', 'AM')
				and	nr_seq_item	= nr_seq_auditoria_item_w;
				
				if (coalesce(nr_seq_historico_aud_w, 0) > 0) then
					update	pls_guia_plano_historico
					set	ie_auditor_finaliza	= 'S'
					where	nr_sequencia		= nr_seq_historico_aud_w;
					
					if (ie_inserir_parecer_glosa_w = 'S') and (ie_status_w = 'N') then								
						select	substr(ds_observacao,position('-' in ds_observacao)+2,3800)
						into STRICT	ds_observacao_w
						from	pls_guia_plano_historico
						where	nr_sequencia	= nr_seq_historico_aud_w;
								
						update	pls_auditoria_item
						set	ds_observacao_glosa	= ds_observacao_w
						where	nr_sequencia		= nr_seq_auditoria_item_w;
					end if;
				end if;
				end;
			end loop;
			close C02;
		elsif (coalesce(nr_seq_requisicao_w, 0) > 0) then
			open C02;
			loop
			fetch C02 into	
				nr_seq_auditoria_item_w,
				ie_status_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin
				select	max(nr_sequencia)
				into STRICT	nr_seq_historico_aud_w
				from	pls_requisicao_historico
				where	ie_tipo_historico in ('AP', 'AM')
				and	nr_seq_item	= nr_seq_auditoria_item_w;
				
				if (coalesce(nr_seq_historico_aud_w, 0) > 0) then
					update	pls_requisicao_historico
					set	ie_auditor_finaliza	= 'S'
					where	nr_sequencia		= nr_seq_historico_aud_w;
					
					if (ie_inserir_parecer_glosa_w = 'S') and (ie_status_w = 'N') then								
						select	substr(ds_historico,position('-' in ds_historico)+2,3800)
						into STRICT	ds_observacao_w
						from	pls_requisicao_historico
						where	nr_sequencia	= nr_seq_historico_aud_w;
						
						update	pls_auditoria_item
						set	ds_observacao_glosa	= ds_observacao_w
						where	nr_sequencia		= nr_seq_auditoria_item_w;
					end if;
				end if;
				end;
			end loop;
			close C02;
		end if;
		
		select	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
		into STRICT	ie_ajuste_w
		from	pls_auditoria_item
		where	nr_seq_auditoria	= nr_seq_auditoria_p
		and	qt_original		> qt_ajuste
		and	ie_status_solicitacao	= 'P'
		and	ie_status	in ('A', 'P')
		and	((coalesce(ie_acao_auditor::text, '') = '') or (ie_acao_auditor <> 'E'));
		
		if (coalesce(nr_seq_guia_w, 0) > 0) then
			CALL pls_atualizar_guia_liberada(	nr_seq_auditoria_p,
							nm_usuario_p);
			
			if (ie_ajuste_w = 'S') and (ie_tipo_processo_w <> 'I') then
				update	pls_guia_plano
				set	ie_estagio	= '10'
				where	nr_sequencia	= nr_seq_guia_w;
			end if;
		elsif (coalesce(nr_seq_requisicao_w,0) > 0) then

			select	count(1)
			into STRICT	qt_itens_aut_w
			from	pls_auditoria_item
			where	nr_seq_auditoria	= nr_seq_auditoria_p
			and	ie_status		= 'A';

			if (qt_itens_aut_w > 0) then
				ie_exige_senha_ext_w	:= pls_obter_se_exige_senha_ext(null, nr_seq_requisicao_w);
			else	
				ie_exige_senha_ext_w	:= 'N';
			end if;
			
			if (ie_exige_senha_ext_w	= 'S') then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(177258,'');
				--Esta requisicao necessita de senha externa para ser liberada
			else
				CALL pls_atualizar_req_liberada( nr_seq_auditoria_p, nm_usuario_p);
			end if;
			
			if (ie_ajuste_w = 'S') and (ie_tipo_processo_w <> 'I') then
				update	pls_requisicao
				set	ie_estagio	= '6'
				where	nr_sequencia	= nr_seq_requisicao_w;
			end if;
		elsif (coalesce(nr_seq_execucao_w, 0) > 0) then
			CALL pls_atualizar_exec_liberada(	nr_seq_auditoria_p,
							nm_usuario_p);
		end if;
		-- Retirada a chamada para gerar a ordem de compra, conforme solicitacao da Unimed Maringa na OS 977328

		--pls_gerar_ordem_compra_cotacao(	nr_seq_auditoria_p, cd_estabelecimento_w, nm_usuario_p);
		
		CALL pls_gerar_alerta_evento(1,
					nr_seq_auditoria_p,
					null,
					null,
					nm_usuario_p);
	elsif (qt_liberacao_w > 0) and (coalesce(nr_seq_guia_w, 0) > 0) then
		ie_envia_email_aud_externo_w	:= obter_valor_param_usuario(1270, 12, Obter_Perfil_Ativo, nm_usuario_p, 0);
				
		if (ie_tipo_processo_w <> 'P') and (ie_envia_email_aud_externo_w = 'S') then
			CALL pls_gerar_alerta_evento(2,
						nr_seq_auditoria_p,
						null,
						null,
						nm_usuario_p);
		end if;
	elsif (qt_liberacao_w > 0) and (coalesce(nr_seq_requisicao_w, 0) > 0) then
		-- Tratamento realizado pois quando a requisicao for para analise do contratante no portal web, o status da analise mudara para "Analise estipulante",  quando o mesmo terminar analise o status deve voltar para "Analise"
		if (ie_auditoria_estip_w = 'S') then
			select	coalesce(pls_obter_grupo_analise_atual(nr_seq_auditoria_p),0 )
			into STRICT	nr_seq_grupo_auditor_w
			;
		
			select	nr_seq_grupo
			into STRICT	nr_seq_grupo_w
			from	pls_auditoria_grupo
			where	nr_sequencia	= nr_seq_grupo_auditor_w;
			
			select	CASE WHEN ie_tipo_auditoria=3 THEN  'S'  ELSE 'N' END
			into STRICT	ie_externo_w
			from	pls_grupo_auditor
			where	nr_sequencia	= nr_seq_grupo_w;
			
			select	nr_seq_regra_pos_estip
			into STRICT	nr_seq_regra_pos_estip_w
			from	pls_requisicao
			where	nr_sequencia = nr_seq_requisicao_w;
			
			if (ie_externo_w = 'S') then
				CALL pls_enviar_email_requisicao(	nr_seq_requisicao_w,
								1,
								nr_seq_regra_pos_estip_w,
								nm_usuario_p);
				
				update	pls_auditoria
				set	ie_status			= 'AE',
					ie_auditoria_estipulante	= 'S',
					ie_visualizada_estip 		= 'N'
				where	nr_sequencia			= nr_seq_auditoria_p;
			else
				update	pls_auditoria
				set	ie_status	= 'A'
				where	nr_sequencia	= nr_seq_auditoria_p;

			end if;			
		end if;
	end if;
else
	CALL wheb_mensagem_pck.exibir_mensagem_abort(177259,'');
	--Voce nao pode encerrar a analise enquanto nao informar pelo menos um parecer para cada item,  que tenha o status de solicitacao como pendente. Verificar o  parametro 5
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_liberar_auditoria ( nr_seq_auditoria_p bigint, nm_usuario_p text, ie_item_pendente_p INOUT text) FROM PUBLIC;

