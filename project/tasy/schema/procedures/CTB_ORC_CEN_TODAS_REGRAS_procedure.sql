-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_orc_cen_todas_regras ( nr_seq_cenario_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_centro_custo_w				bigint;
cd_centro_origem_w			bigint;
cd_classif_Centro_w			varchar(20);
cd_classif_Conta_w				varchar(20);
cd_conta_contabil_w			varchar(20);
cd_conta_origem_w			varchar(20);
cd_empresa_w				smallint;
cd_estabelecimento_w			smallint;
dt_mes_inic_w				timestamp;
dt_mes_fim_w				timestamp;
ds_observacao_w				varchar(255);
ie_regra_valor_w				varchar(20);
ie_sobrepor_w				varchar(20);
nr_sequencia_w				bigint;
nr_seq_criterio_rateio_w			bigint;
nr_seq_mes_ref_orig_w			bigint;
nr_seq_metrica_w				bigint;
pr_aplicar_w				double precision;
vl_fixo_w					double precision;

C01 CURSOR FOR
SELECT	nr_sequencia,
	cd_estabelecimento,
	cd_centro_custo,
	cd_conta_contabil,
	cd_classif_conta,
	cd_classif_centro,
	nr_seq_mes_ref_orig,
	dt_mes_inic,
	dt_mes_fim,
	cd_centro_origem,
	cd_conta_origem,
	ie_regra_valor,
	pr_aplicar,
	ie_sobrepor,
	nr_seq_criterio_rateio,
	vl_fixo,
	ds_observacao
From	Ctb_orc_Cen_regra
where	nr_seq_cenario	= nr_seq_cenario_p
order by nr_seq_regra;


BEGIN
/*Limpar valores gerados */

delete from ctb_orc_cen_valor
where	nr_seq_cenario = nr_seq_cenario_p;

select	cd_empresa
into STRICT	cd_empresa_w
from	ctb_orc_cenario
where	nr_sequencia	= nr_seq_cenario_p;

OPEN C01;
LOOP
FETCH C01 into
	nr_sequencia_w,
	cd_estabelecimento_w,
	cd_centro_custo_w,
	cd_conta_contabil_w,
	cd_classif_conta_w,
	cd_classif_centro_w,
	nr_seq_mes_ref_orig_w,
	dt_mes_inic_w,
	dt_mes_fim_w,
	cd_centro_origem_w,
	cd_conta_origem_w,
	ie_regra_valor_w,
	pr_aplicar_w,
	ie_sobrepor_w,
	nr_seq_criterio_rateio_w,
	vl_fixo_w,
	ds_observacao_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	if (ie_regra_valor_w = 'CM') then
		CALL CTB_Gerar_Cen_Metrica(
			nr_seq_cenario_p,
			nr_sequencia_w,
			cd_centro_custo_w,
			dt_mes_inic_w,
			dt_mes_fim_w,
			ie_sobrepor_w,
			cd_estabelecimento_w,
			cd_empresa_w,
			ds_observacao_w,
			nm_usuario_p);
	elsif (ie_regra_valor_w = 'OD') then
		ctb_cen_gerar_valor_detalhe(
			nr_seq_cenario_p,
			cd_estabelecimento_w,
			ie_sobrepor_w,
			nm_usuario_p);
	else
		CALL CTB_ORC_CEN_Aplicar_Regra(
			nr_seq_cenario_p,
			nr_sequencia_w,
			cd_centro_custo_w,
			cd_conta_contabil_w,
			cd_classif_conta_w,
			cd_classif_centro_w,
			nr_seq_mes_ref_orig_w,
			dt_mes_inic_w,
			dt_mes_fim_w,
			cd_centro_origem_w,
			cd_conta_origem_w,
			ie_regra_valor_w,
			pr_aplicar_w,
			ie_sobrepor_w,
			nr_seq_criterio_rateio_w,
			vl_fixo_w,
			cd_empresa_w,
			cd_estabelecimento_w,
			nm_usuario_p,
			dt_mes_inic_w,
			ds_observacao_w);
	end if;

END LOOP;
CLOSE C01;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_orc_cen_todas_regras ( nr_seq_cenario_p bigint, nm_usuario_p text) FROM PUBLIC;

