-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE buscar_tributo_nota ( nr_seq_nota_p bigint, nr_seq_titulo_p bigint, nm_usuario_p text ) AS $body$
DECLARE


C01 CURSOR FOR
	SELECT	tx_tributo,
			vl_base_adic,
			vl_base_calculo,
			vl_base_nao_retido,
			vl_trib_adic,
			vl_trib_nao_retido,
			vl_tributo,
			ie_origem_trib,
			cd_tributo,
			nr_sequencia
	from	nota_fiscal_trib n
	where	n.nr_sequencia = nr_seq_nota_p;

	vet01 C01%RowType;


BEGIN

open C01;
loop
fetch C01 into
	vet01;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	insert	into titulo_receber_trib(
				nr_sequencia,
                cd_tributo,
                tx_tributo,
                vl_tributo,
                vl_base_calculo,
                dt_atualizacao,
                nm_usuario,
                nr_titulo,
                vl_saldo,
                vl_trib_nao_retido,
                vl_base_nao_retido,
                vl_trib_adic,
                vl_base_adic,
                dt_atualizacao_nrec,
                nm_usuario_nrec,
                nr_seq_nota_fiscal,
                ie_origem_tributo,
                dt_tributo,
                nr_seq_nf_trib,
                nr_seq_trans_financ,
                nr_lote_contabil,
                nr_seq_mens_trib)
			values (
				nextval('titulo_receber_trib_seq'),
                vet01.cd_tributo,
                vet01.tx_tributo,
                vet01.vl_tributo,
                vet01.vl_base_calculo,
                clock_timestamp(),
                nm_usuario_p,
                nr_seq_titulo_p,
                null, --vl_saldo
                vet01.vl_trib_nao_retido,
                vet01.vl_base_nao_retido,
                vet01.vl_trib_adic,
                vet01.vl_base_adic,
                clock_timestamp(),
                nm_usuario_p,
                vet01.nr_sequencia, --OS 1222291. Se o tributo vem da nota, add essa informação no tributo no titulo. Isso influencia no campo Vl líquido do título.
                vet01.ie_origem_trib,
                null, --dt_tributo
                null, --nr_seq_nf_trib
                null, --nr_seq_trans_financ
                null, --nr_lote_contabil
                null); --nr_seq_mens_trib
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE buscar_tributo_nota ( nr_seq_nota_p bigint, nr_seq_titulo_p bigint, nm_usuario_p text ) FROM PUBLIC;

