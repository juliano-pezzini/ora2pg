-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_dados_enviar_email ( nr_seq_contrato_p bigint, cd_estabelecimento_p bigint, nr_seq_grupo_contrato_p bigint, nm_usuario_p text, ds_email_p INOUT text, cd_relatorio_p INOUT bigint, nr_seq_historico_p INOUT bigint, nr_seq_sequencia_p INOUT bigint, ds_texto_p INOUT bigint) AS $body$
DECLARE

ds_email_w		varchar(255);
cd_relatorio_w		bigint;
nr_seq_historico_w	bigint;
nr_seq_sequencia_w	bigint;
ds_texto_w		varchar(2000);

BEGIN
if (nr_seq_contrato_p IS NOT NULL AND nr_seq_contrato_p::text <> '') and (nr_seq_grupo_contrato_p IS NOT NULL AND nr_seq_grupo_contrato_p::text <> '') and (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then 
	begin 
	select	obter_dados_pf_pj_estab(cd_estabelecimento_p, a.cd_pf_estipulante, a.cd_cgc_estipulante, 'M') 
	into STRICT	ds_email_w 
	from	pls_contrato_grupo b, 
		pls_contrato    a 
	where	b.nr_seq_contrato	= a.nr_sequencia 
	and	nr_seq_contrato		= nr_seq_contrato_p;
	select	b.cd_relatorio 
	into STRICT	cd_relatorio_w 
	from	pls_parametros a, 
		relatorio   b 
	where	a.nr_seq_relatorio   = b.nr_sequencia 
	and	a.cd_estabelecimento  = cd_estabelecimento_p;
	select	max(nr_sequencia) 
	into STRICT	nr_seq_historico_w 
	from	pls_grupo_contrato_hist 
	where	nr_seq_grupo_contrato = nr_seq_grupo_contrato_p;
	if (nr_seq_historico_w IS NOT NULL AND nr_seq_historico_w::text <> '') then 
		begin 
		nr_seq_sequencia_w := converte_rtf_html( 
			'select	ds_historico	from	pls_grupo_contrato_hist	where	nr_sequencia  = :nr_sequencia_p', nr_seq_historico_w, nm_usuario_p, nr_seq_sequencia_w);
		if (nr_seq_sequencia_w IS NOT NULL AND nr_seq_sequencia_w::text <> '') then 
			begin 
			select	ds_texto 
			into STRICT	ds_texto_w 
			from	tasy_conversao_rtf 
			where	nr_sequencia = nr_seq_sequencia_w;
			end;
		end if;
		end;
	end if;
	end;
end if;
ds_email_p := ds_email_w;
cd_relatorio_p := cd_relatorio_w;
nr_seq_historico_p :=nr_seq_historico_w;
nr_seq_sequencia_p := nr_seq_sequencia_w;
ds_texto_p := ds_texto_w;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_dados_enviar_email ( nr_seq_contrato_p bigint, cd_estabelecimento_p bigint, nr_seq_grupo_contrato_p bigint, nm_usuario_p text, ds_email_p INOUT text, cd_relatorio_p INOUT bigint, nr_seq_historico_p INOUT bigint, nr_seq_sequencia_p INOUT bigint, ds_texto_p INOUT bigint) FROM PUBLIC;

