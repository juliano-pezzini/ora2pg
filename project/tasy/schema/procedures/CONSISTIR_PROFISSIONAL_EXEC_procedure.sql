-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_profissional_exec (nr_seq_horario_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_proc_interno_w	bigint;
qt_classe_proc_w		bigint;
ie_prof_user_w		varchar(15);
qt_compativel_w		bigint;


BEGIN
if (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	/* obter se proc interno */

	select	coalesce(max(nr_seq_proc_interno),0)
	into STRICT	nr_seq_proc_interno_w
	from	prescr_proc_hor
	where	nr_sequencia = nr_seq_horario_p
	and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

	if (nr_seq_proc_interno_w > 0) then
		/* obter se proc classe */

		select	count(*)
		into STRICT	qt_classe_proc_w
		from	proc_interno_prof
		where	nr_seq_proc_interno = nr_seq_proc_interno_w;

		if (qt_classe_proc_w > 0) then
			/* obter classe usuário */

			select	max(ie_profissional)
			into STRICT	ie_prof_user_w
			from	usuario
			where	nm_usuario = nm_usuario_p;

			/* validar classe usuário x classe proc */

			if (ie_prof_user_w IS NOT NULL AND ie_prof_user_w::text <> '') then
				select	count(*)
				into STRICT	qt_compativel_w
				from	proc_interno_prof
				where	nr_seq_proc_interno = nr_seq_proc_interno_w
				and	ie_profissional = ie_prof_user_w;

				if (qt_compativel_w = 0) then
					/*Você não tem permissão para executar este procedimento!'||chr(10)||
										'Favor verificar as regras definidas em Exames e Procedimentos Internos.#@#@');*/
					CALL Wheb_mensagem_pck.exibir_mensagem_abort(261471);

				end if;
			else
				/*Não foi definida a classe profissional deste usuário.'||chr(10)||
									'Favor entrar em contato com o administrador do sistema.#@#@');*/
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(261476);
			end if;
		end if;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_profissional_exec (nr_seq_horario_p bigint, nm_usuario_p text) FROM PUBLIC;

