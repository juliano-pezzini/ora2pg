-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE med_inserir_anteced_pessoal (cd_medico_p text, nr_ficha_p bigint, ds_anteced_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_cliente_w	bigint;
nr_seq_consulta_w	bigint;
cd_cid_w		varchar(10);
dt_evolucao_w		timestamp;


BEGIN

select	coalesce(max(nr_sequencia),0)
into STRICT	nr_seq_cliente_w
from	med_cliente
where	cd_medico		= cd_medico_p
and	cd_pessoa_sist_orig	= nr_ficha_p;


if (nr_seq_cliente_w > 0) then
	begin

	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_seq_consulta_w
	from	med_consulta
	where	NR_SEQ_CLIENTE		= nr_seq_cliente_w
	and	ie_tipo_consulta	= 5;

	if (nr_seq_consulta_w = 0) then
		begin

		select	nextval('med_consulta_seq')
		into STRICT	nr_seq_consulta_w
		;


		insert	into med_consulta(nr_sequencia,
			ie_tipo_consulta,
			nr_seq_cliente,
			dt_atualizacao,
			nm_usuario,
			ds_consulta,
			ie_pressao)
		values (nr_seq_consulta_w,
			5,
			nr_seq_cliente_w,
			clock_timestamp(), nm_usuario_p,
			ds_anteced_p, 'N');



		end;
	else
		begin

		select	coalesce(min(dt_evolucao), trunc(clock_timestamp(), 'dd'))
		into STRICT	dt_evolucao_w
		from	med_evolucao
		where	nr_seq_cliente	= nr_seq_cliente_w;


		select	nextval('med_evolucao_seq')
		into STRICT	nr_seq_consulta_w
		;


		insert 	into med_evolucao(NR_SEQUENCIA   ,
			DT_ATUALIZACAO ,
			NM_USUARIO     ,
			DT_EVOLUCAO    ,
			DS_EVOLUCAO    ,
			nr_seq_cliente)
		values (nr_seq_consulta_w,
			clock_timestamp(),
			nm_usuario_p,
			dt_evolucao_w,
			ds_anteced_p,
			nr_seq_cliente_w);


		end;
	end if;

	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE med_inserir_anteced_pessoal (cd_medico_p text, nr_ficha_p bigint, ds_anteced_p text, nm_usuario_p text) FROM PUBLIC;

