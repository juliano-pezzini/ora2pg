-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE nut_imp_receita_estab (cd_estab_p bigint, cd_estab_origem_p bigint, nm_usuario_p text, cd_tab_comp_alim_p bigint) AS $body$
DECLARE


nr_seq_receita_w    	nut_receita.nr_sequencia%type;
nex_receita_w       	nut_receita.nr_sequencia%type;
nr_seq_modo_preparo_w   nut_modo_preparo.ds_modo_preparo%type;
nr_seq_receita_comp_w	nut_receita_comp.nr_sequencia%type;
cd_estabelecimento_w    estabelecimento.cd_estabelecimento%type;

c01 CURSOR FOR
	SELECT  a.cd_estabelecimento,
	    a.ds_preparo,
	    a.ds_receita,
	    a.dt_atualizacao,
	    a.ie_situacao,
	    a.nm_usuario,
	    a.nr_seq_composicao,
	    a.nr_seq_grupo,
	    a.nr_sequencia,
	    a.qt_g_pessoa,
	    a.qt_refeicao,
	    a.qt_rendimento
	from    nut_receita a
	where 	a.cd_estabelecimento = cd_estab_origem_p
	and 	ds_receita not in ( SELECT ds_receita
			    from nut_receita
			    where cd_estabelecimento = cd_estab_p)
	and (not exists (select 1
			from 	nut_receita_comp x, 
				nut_genero_alim y 
			where 	x.nr_seq_gen_alim = y.nr_sequencia 
			and 	a.nr_sequencia = x.nr_seq_receita 
			and 	y.nr_seq_tabela <> cd_tab_comp_alim_p
			and	y.cd_estabelecimento = cd_estab_origem_p
			and 	y.ie_situacao = 'A') or coalesce(cd_tab_comp_alim_p::text, '') = '')
	and a.ie_situacao = 'A';

	c02 CURSOR FOR	
	SELECT	a.nr_seq_receita,
		a.nr_seq_tipo_preparo,
		a.nr_sequencia,
		a.qt_componente,
		a.qt_componente_calc,
		a.qt_fator_coccao,
		a.qt_fator_correcao,
		(SELECT max(nr_sequencia)
		from nut_genero_alim
		where nr_seq_genero_origem_imp = a.nr_seq_gen_alim
		and cd_estabelecimento = cd_estabelecimento_w
		and ie_situacao = 'A') nr_seq_gen_alim,
		(select max(nr_sequencia)
		from nut_genero_alim
		where nr_seq_genero_origem_imp = a.nr_seq_gen_alim_calc
		and cd_estabelecimento = cd_estabelecimento_w
		and ie_situacao = 'A') nr_seq_gen_alim_calc
	from    nut_receita_comp a
	where   a.nr_seq_receita = nr_seq_receita_w;

c03 CURSOR(nr_seq_comp_rec_pc nut_receita_comp.nr_sequencia%type) FOR
	SELECT  a.cd_dieta,
	    a.ds_observacao,
	    a.nr_seq_comp_rec,
	    a.nr_seq_medida,
	    a.nr_seq_receita,
	    a.qt_medida,
	    a.qt_unidade
	from    nut_receita_med_cas a
	where   a.nr_seq_receita = nr_seq_receita_w
	and	a.NR_SEQ_COMP_REC = nr_seq_comp_rec_pc;

c04 CURSOR FOR
	SELECT  dt_atualizacao,
	    dt_atualizacao_nrec,
	    nm_usuario,
	    nm_usuario_nrec,
	    nr_seq_area,
	    nr_seq_receita,
	    nr_sequencia
	from    nut_area_prod_rec
	where   nr_seq_receita = nr_seq_receita_w;

c05 CURSOR FOR
	SELECT  a.cd_dieta,
	    a.dt_atualizacao,
	    a.dt_atualizacao_nrec,
	    a.nm_usuario,
	    a.nm_usuario_nrec,
	    a.nr_seq_grupo,
	    a.nr_seq_receita,
	    a.nr_sequencia 
	from    nut_dieta_rec a,
		dieta b
	where   a.cd_dieta = b.cd_dieta    
	and	a.nr_seq_receita = nr_seq_receita_w
	and 	coalesce(b.cd_estabelecimento::text, '') = ''
	
union

	SELECT  a.cd_dieta,
		a.dt_atualizacao,
		a.dt_atualizacao_nrec,
		a.nm_usuario,
		a.nm_usuario_nrec,
		a.nr_seq_grupo,
		a.nr_seq_receita,
		a.nr_sequencia 
	from    nut_dieta_rec a,
		nut_grupo_producao c
	where   a.nr_seq_receita = nr_seq_receita_w
	and	c.nr_sequencia = a.nr_seq_grupo;

c06 CURSOR FOR
	SELECT  a.dt_atualizacao,
	    a.dt_atualizacao_nrec,
	    a.nm_usuario,
	    a.nm_usuario_nrec,
	    a.nr_seq_receita,
	    a.nr_sequencia
	from    nut_modo_preparo a
	where   a.nr_seq_receita = nr_seq_receita_w;
BEGIN

cd_estabelecimento_w :=	obter_estabelecimento_ativo();

for c01_w in c01 loop
begin
	select	nextval('nut_receita_seq')
	into STRICT 	nex_receita_w
	;

	insert into nut_receita(cd_estabelecimento,
				ds_preparo,
				ds_receita,
				dt_atualizacao,
				ie_situacao,
				nm_usuario,
				nr_seq_composicao,
				nr_seq_grupo,
				nr_sequencia,
				qt_g_pessoa,
				qt_refeicao,
				qt_rendimento)
	values ( cd_estab_p,
		c01_w.ds_preparo,
		c01_w.ds_receita,
		clock_timestamp(),
		c01_w.ie_situacao,
		nm_usuario_p,
		c01_w.nr_seq_composicao,
		c01_w.nr_seq_grupo,
		nex_receita_w,
		c01_w.qt_g_pessoa,
		c01_w.qt_refeicao,
		c01_w.qt_rendimento);

	nr_seq_receita_w := c01_w.nr_sequencia;

	for c02_w in c02 loop
	
	select 	nextval('nut_receita_comp_seq')
	into STRICT	nr_seq_receita_comp_w
	;
	
	insert into nut_receita_comp(	dt_atualizacao,
				    nm_usuario,
				    nr_seq_gen_alim,
				    nr_seq_gen_alim_calc,
				    nr_seq_receita,
				    nr_seq_tipo_preparo,
				    nr_sequencia,
				    qt_componente,
				    qt_componente_calc,
				    qt_fator_coccao,
				    qt_fator_correcao)
	values (   clock_timestamp(),
		nm_usuario_p,
		c02_w.nr_seq_gen_alim,
		c02_w.nr_seq_gen_alim_calc,
		nex_receita_w,
		c02_w.nr_seq_tipo_preparo,
		nr_seq_receita_comp_w,
		c02_w.qt_componente,
		c02_w.qt_componente_calc,
		c02_w.qt_fator_coccao,
		c02_w.qt_fator_correcao);
		
		for c03_w in c03(nr_seq_receita_comp_w) loop
		insert into nut_receita_med_cas(   cd_dieta,
					ds_observacao,
					dt_atualizacao,
					dt_atualizacao_nrec,
					nm_usuario,
					nm_usuario_nrec,
					nr_seq_comp_rec,
					nr_seq_medida,
					nr_seq_receita,
					nr_sequencia,
					qt_medida,
					qt_unidade)
		values (c03_w.cd_dieta,
			c03_w.ds_observacao,
			clock_timestamp(),
			clock_timestamp(),
			nm_usuario_p,
			nm_usuario_p,
			nr_seq_receita_comp_w,
			c03_w.nr_seq_medida,
			nex_receita_w,
			nextval('nut_receita_med_cas_seq'),
			c03_w.qt_medida,
			c03_w.qt_unidade);
		end loop;
		
	end loop;

	for c04_w in c04 loop
	insert into nut_area_prod_rec( dt_atualizacao,
				    dt_atualizacao_nrec,
				    nm_usuario,
				    nm_usuario_nrec,
				    nr_seq_area,
				    nr_seq_receita,
				    nr_sequencia)
	values (    clock_timestamp(),
		clock_timestamp(),
		nm_usuario_p,
		nm_usuario_p,
		c04_w.nr_seq_area,
		nex_receita_w,
		nextval('nut_area_prod_rec_seq') );
	end loop;

	for c05_w in c05 loop
	insert into nut_dieta_rec(	cd_dieta,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nm_usuario,
				nm_usuario_nrec,
				nr_seq_grupo,
				nr_seq_receita,
				nr_sequencia)
	values (	c05_w.cd_dieta,
	    clock_timestamp(),
	    clock_timestamp(),
	    nm_usuario_p,
	    nm_usuario_p,
	    c05_w.nr_seq_grupo,
	    nex_receita_w,
	    nextval('nut_dieta_rec_seq'));
	end loop;

	for c06_w in c06 loop
	select	nextval('nut_modo_preparo_seq')
	into STRICT	nr_seq_modo_preparo_w
	;

	insert into nut_modo_preparo(	dt_atualizacao,
					dt_atualizacao_nrec,
					nm_usuario,
					nm_usuario_nrec,
					nr_seq_receita,
					nr_sequencia)
	values (clock_timestamp(),
		clock_timestamp(),
		nm_usuario_p,
		nm_usuario_p,
		nex_receita_w,
		nr_seq_modo_preparo_w
	);

	CALL copia_campo_long_de_para_novo(	'nut_modo_preparo',
					'ds_modo_preparo',
					'where nr_sequencia = :nr_seq_preparo',
					'nr_seq_preparo='||c06_w.nr_sequencia,
					'nut_modo_preparo',
					'ds_modo_preparo',
					'where nr_sequencia = :nr_sequencia',
					'nr_sequencia='||nr_seq_modo_preparo_w,
					'l');
	end loop
	commit;
		
exception
when others then
	CALL gravar_log_nutricao(68631, 'Erro imp receita: '||c01_w.nr_sequencia||' - '||substr(dbms_utility.format_call_stack,1,1500)
				||' Estab orig: '||cd_estab_origem_p, nm_usuario_p);
end;
	
end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nut_imp_receita_estab (cd_estab_p bigint, cd_estab_origem_p bigint, nm_usuario_p text, cd_tab_comp_alim_p bigint) FROM PUBLIC;

