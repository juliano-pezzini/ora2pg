-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicar_modelo_carta_medica ( nr_seq_modelo_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_modelo_w		bigint;
nr_seq_carta_med_mod_lib_old_w 	carta_medica_modelo_lib.nr_sequencia%type;
nr_seq_carta_med_mod_lib_w 		carta_medica_modelo_lib.nr_sequencia%type;

C01 CURSOR FOR
	SELECT  nr_sequencia,
			nm_usuario_regra,
			ie_permite_utilizar,
			ie_permite_editar,
			cd_setor_atendimento,
			cd_perfil,
			cd_departamento
	from    carta_medica_modelo_lib
	where   nr_seq_modelo = nr_seq_modelo_p;

C02 CURSOR FOR
	SELECT  ie_status,
			ie_permissao
	from    carta_medica_lib_status
	where   nr_seq_carta_med_mod_lib = nr_seq_carta_med_mod_lib_old_w;
BEGIN

select	nextval('carta_medica_modelo_seq')
into STRICT	nr_seq_modelo_w
;

insert into carta_medica_modelo(
		nr_sequencia,
		cd_estabelecimento,
		cd_perfil,
		nm_modelo,
		ds_modelo,
		ie_preliminar,
		qt_divisor,
		ie_situacao,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
        ds_titulo_definitivo,
		ds_titulo_adicional,
		ie_metodo_busca_info)
SELECT	nr_seq_modelo_w,
		cd_estabelecimento,
		cd_perfil,
		substr(Wheb_mensagem_pck.get_texto(1021458, 'DS_MODELO_W='||nm_modelo),1,255),
		ds_modelo,
		ie_preliminar,
		qt_divisor,
		ie_situacao,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
        ds_titulo_definitivo,
		ds_titulo_adicional,
		ie_metodo_busca_info
from	carta_medica_modelo
where	nr_sequencia = nr_seq_modelo_p;

insert into carta_medica_modelo_macro(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ds_chave,
		nr_seq_modelo,
		ie_macro_pf)
SELECT	nextval('carta_medica_modelo_macro_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		ds_chave,
		nr_seq_modelo_w,
		ie_macro_pf
from	carta_medica_modelo_macro
where	nr_seq_modelo = nr_seq_modelo_p;

insert into participante_carta_medica(
		nr_sequencia,
		dt_atualizacao,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nm_usuario_resp,
		nm_usuario_assinat,
		ie_deve_assinar,
		nr_seq_apresent,
		nm_destinatario,
		nm_usuario,
		nr_seq_modelo,
		nr_seq_assinatura)
SELECT	nextval('participante_carta_medica_seq'),
		clock_timestamp(),
		clock_timestamp(),
		nm_usuario_p,
		nm_usuario_resp,
		nm_usuario_assinat,
		ie_deve_assinar,
		nr_seq_apresent,
		nm_destinatario,
		nm_usuario_p,
		nr_seq_modelo_w,
		nr_seq_assinatura
from	participante_carta_medica
where	nr_seq_modelo = nr_seq_modelo_p;

commit;

CALL EXPORTAR_REGRAS_CARTA_MEDICA(nr_seq_modelo_p, nr_seq_modelo_w, 'TD', nm_usuario_p);

for c01_w in C01 loop
	begin
		nr_seq_carta_med_mod_lib_old_w := c01_w.nr_sequencia;

		select 	nextval('carta_medica_modelo_lib_seq')
		into STRICT	nr_seq_carta_med_mod_lib_w
		;

		insert into carta_medica_modelo_lib(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_regra,
			nm_usuario_nrec,
			ie_permite_utilizar,
			cd_setor_atendimento,
			cd_perfil,
			cd_departamento,
			ie_permite_editar,
			nr_seq_modelo
		) values (
			nr_seq_carta_med_mod_lib_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			c01_w.NM_USUARIO_REGRA,
			nm_usuario_p,
			c01_w.ie_permite_utilizar,
			c01_w.cd_setor_atendimento,
			c01_w.cd_perfil,
			c01_w.cd_departamento,
			c01_w.ie_permite_editar,
			nr_seq_modelo_w);

		for c02_w in C02 loop
			begin
				insert into carta_medica_lib_status(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					ie_status,
					ie_permissao,
					nr_seq_carta_med_mod_lib
				) values (
					nextval('carta_medica_lib_status_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					c02_w.ie_status,
					c02_w.ie_permissao,
					nr_seq_carta_med_mod_lib_w);
			end;
		end loop;
	end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_modelo_carta_medica ( nr_seq_modelo_p bigint, nm_usuario_p text) FROM PUBLIC;

