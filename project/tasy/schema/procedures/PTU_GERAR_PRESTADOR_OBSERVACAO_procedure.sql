-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_gerar_prestador_observacao ( nr_seq_prestador_p ptu_prestador.nr_sequencia%type, dt_referencia_p ptu_movimento_prestador.dt_referencia%type, nm_usuario_p usuario.nm_usuario%type ) AS $body$
DECLARE


C01 CURSOR(nr_seq_prestador_pc	ptu_prestador.nr_sequencia%type,
		dt_referencia_pc	ptu_movimento_prestador.dt_referencia%type) FOR
	SELECT	substr(c.ds_observacao,1,250) ds_observacao
	from	ptu_prestador		 a,
		pls_prestador		 b,
		pls_prestador_observacao c
	where	b.nr_sequencia	= a.nr_seq_prestador
	and	b.nr_sequencia	= c.nr_seq_prestador
	and	a.nr_sequencia	= nr_seq_prestador_pc
	and	dt_referencia_pc between trunc(coalesce(c.dt_inicio_vigencia, dt_referencia_pc)) and fim_dia(coalesce(c.dt_fim_vigencia, dt_referencia_pc));

BEGIN

-- R410 – OBSERVAÇÕES (OPCIONAL)
for r_c01_w in c01( nr_seq_prestador_p, dt_referencia_p ) loop

	insert into ptu_prestador_observacao(nr_sequencia,				dt_atualizacao,		nm_usuario,
		dt_atualizacao_nrec,			nm_usuario_nrec,	nr_seq_prestador,
		ds_divulgacao_obs)
	values (nextval('ptu_prestador_observacao_seq'),	clock_timestamp(),		nm_usuario_p,
		clock_timestamp(),				nm_usuario_p,		nr_seq_prestador_p,
		r_c01_w.ds_observacao);
end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_gerar_prestador_observacao ( nr_seq_prestador_p ptu_prestador.nr_sequencia%type, dt_referencia_p ptu_movimento_prestador.dt_referencia%type, nm_usuario_p usuario.nm_usuario%type ) FROM PUBLIC;

