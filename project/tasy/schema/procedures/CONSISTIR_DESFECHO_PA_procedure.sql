-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_desfecho_pa ( nr_atendimento_p bigint, nm_usuario_p text, ds_erro_p INOUT text, item_posicionar_p INOUT text, ds_erro2_p INOUT text, ie_desfecho_p text default null, ie_html_p text default 'N') AS $body$
DECLARE


ds_erro_w			varchar(32000)	:= '';
qt_registro_w			bigint;
ie_evolucao_w			varchar(1);
ie_avaliacao_w			varchar(1);
ie_diagnostico_w		varchar(1);
ie_anamnese_w			varchar(1);
ie_prescr_material_w		varchar(1);
cd_estabelecimento_w		smallint;
ie_exige_lib_evol_w		varchar(255);
ie_evolucao_clinica_w		varchar(10);
ie_laudo_internacao_sus_w	varchar(10);
ie_tipo_convenio_w		integer;
ie_prescr_sem_evol_w		varchar(10);
dt_prescr_w			timestamp;

ie_lib_avaliacao_w			varchar(1);
ie_lib_anamnese_w			varchar(1);
ie_lib_diag_medico_w		varchar(1);
ie_lib_orientacao_alta_w  	varchar(1);

cd_grupo_material_w 		bigint;
cd_subgrupo_material_w 		bigint;
cd_classe_material_w 		bigint;
cd_material_w 			bigint;
cd_area_proced_w 		bigint;
cd_especial_proced_w 		bigint;
cd_grupo_proced_w 		bigint;
cd_procedimento_w 		bigint;
ie_origem_proced_w 		bigint;
ie_consiste_w 			varchar(15);
dt_referencia_w			timestamp:= clock_timestamp() - interval '2 days';
ie_regra_w				varchar(10);
qt_evol_w				bigint;
ie_tipo_evolucao_w		varchar(3);
dt_evolucao_w        timestamp;
total_ev_w           bigint;
ie_clinica_w			 integer;
ie_lib_parecer_medico_w   varchar(1);
ie_parecer_resposta_w    varchar(1);
nr_seq_tipo_avaliacao_w  bigint;	
cd_setor_atendimento_w	 setor_atendimento.cd_setor_atendimento%type;
ie_entrou_w				char(1) := 'N';
ie_resumo_alta_w		varchar(1);
ie_status_sepsis_w	escala_sepse.ie_status_sepsis%type;

ie_tipo_escala_w	integer;
nr_seq_tipo_template_w bigint;
template_w integer;
ds_template_w varchar(100);


C01 CURSOR FOR
	SELECT	coalesce(ie_evolucao,'N'),
		coalesce(ie_avaliacao,'N'),
		coalesce(ie_diagnostico,'N'),
		coalesce(ie_anamnese,'N'),
		coalesce(ie_prescr_material,'N'),
		ie_evolucao_clinica,
		coalesce(ie_laudo_internacao_sus,'N'),
		coalesce(ie_prescr_sem_evol,'N'),
		coalesce(ie_parecer_resposta,'N'),
		ie_tipo_evolucao,
		coalesce(nr_seq_tipo_avaliacao,0),
		coalesce(ie_tipo_escala,0),
		coalesce(ie_resumo_alta,'N'),
        coalesce(nr_seq_tipo_template,0)
	from	consistencia_desfecho
	where	cd_estabelecimento	= cd_estabelecimento_w
	and (((coalesce(ie_desfecho_p,'XPTO') = 'XPTO') and coalesce(ie_desfecho::text, '') = '') or (coalesce(ie_desfecho,coalesce(ie_desfecho_p,'XPTO')) =  coalesce(ie_desfecho_p,'XPTO')))
	and coalesce(ie_clinica,ie_clinica_w) =  ie_clinica_w
	and	coalesce(cd_setor_atendimento,cd_setor_atendimento_w) = cd_setor_atendimento_w
	and coalesce(cd_perfil,obter_perfil_ativo) = obter_perfil_ativo;
	
c02 CURSOR FOR
	SELECT	cd_grupo_material,
		cd_subgrupo_material,
		cd_classe_material,
		cd_material,
		cd_area_proced,
		cd_especial_proced,
		cd_grupo_proced,
		cd_procedimento,
		ie_origem_proced,
		ie_consiste,
		ie_regra,
		IE_EVOLUCAO_CLINICA
	from	consiste_desfecho;


BEGIN

--Ivan em 07/09/2007 OS68005 - In?o
select	max(cd_estabelecimento),
		max(coalesce(Obter_Setor_Atendimento(nr_atendimento),0))
into STRICT	cd_estabelecimento_w,
		cd_setor_atendimento_w
from	atendimento_paciente
where	nr_atendimento	= nr_atendimento_p;


select max(coalesce(ie_clinica,0))
into STRICT    ie_clinica_w
from    atendimento_paciente
where	nr_atendimento = nr_atendimento_p;

select 	max(coalesce(ie_lib_parecer_medico,'N')),
		max(coalesce(ie_lib_diag_medico,'N')),
		max(coalesce(ie_lib_anamnese,'N')),
		max(coalesce(ie_lib_orientacao_alta,'N'))
into STRICT    ie_lib_parecer_medico_w,
		ie_lib_diag_medico_w,
		ie_lib_anamnese_w,
		ie_lib_orientacao_alta_w
from    parametro_medico
where 	cd_estabelecimento = cd_estabelecimento_w;

/* Obter par?tro 37 do menu do sistema */

ie_exige_lib_evol_w := obter_param_usuario(0, 37, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_exige_lib_evol_w);

ie_lib_avaliacao_w := obter_param_usuario(281, 509, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_lib_avaliacao_w);

open C01;
loop
fetch C01 into	
	ie_evolucao_w,
	ie_avaliacao_w,
	ie_diagnostico_w,
	ie_anamnese_w,
	ie_prescr_material_w,
	ie_evolucao_clinica_w,
	ie_laudo_internacao_sus_w,
	ie_prescr_sem_evol_w,
	ie_parecer_resposta_w,
	ie_tipo_evolucao_w,
	nr_seq_tipo_avaliacao_w,
	ie_tipo_escala_w,
	ie_resumo_alta_w,
    nr_seq_tipo_template_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	if	(ie_evolucao_w = 'S' AND ie_exige_lib_evol_w = 'S') then
		select	count(*)
		into STRICT	qt_registro_w
		from	evolucao_paciente
		where	nr_atendimento	=	nr_atendimento_p
		and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and	coalesce(dt_inativacao::text, '') = '';
		
		if (qt_registro_w = 0) then	
			ds_erro_w := ds_erro_w || wheb_mensagem_pck.get_texto(277852);
			item_posicionar_p := '5';
		end if;
	elsif	(ie_evolucao_w = 'S' AND ie_exige_lib_evol_w = 'N') then --Ivan em 07/09/2007 OS68005
		select	count(*)
		into STRICT	qt_registro_w
		from	evolucao_paciente
		where	nr_atendimento	=	nr_atendimento_p;
		
		if (qt_registro_w = 0) then	
			ds_erro_w := ds_erro_w || wheb_mensagem_pck.get_texto(277854);
			item_posicionar_p := '5';
		end if;
	end if;

	if (ie_diagnostico_w = 'S') then
		select	count(*)
		into STRICT	qt_registro_w
		from	diagnostico_doenca a
		where	nr_atendimento = nr_atendimento_p
		and    (((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') and (coalesce(a.dt_inativacao::text, '') = '')) or (ie_lib_diag_medico_w = 'N'));

		if (qt_registro_w = 0) then	
			ds_erro_w := ds_erro_w || wheb_mensagem_pck.get_texto(277856);
			item_posicionar_p := '1';
		end if;
	elsif (ie_diagnostico_w = 'D') then
		select	count(*)
		into STRICT	qt_registro_w
		from	diagnostico_doenca a
		where	nr_atendimento = nr_atendimento_p
		and	ie_tipo_diagnostico IN (2, 3)
		and    (((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') and (coalesce(a.dt_inativacao::text, '') = '')) or (ie_lib_diag_medico_w = 'N'));

		if (qt_registro_w = 0) then	
			ds_erro_w := ds_erro_w || wheb_mensagem_pck.get_texto(277857);
			item_posicionar_p := '1';
		end if;
	end if;
	

	if (ie_evolucao_clinica_w IS NOT NULL AND ie_evolucao_clinica_w::text <> '') then
		select	count(*)
		into STRICT	qt_registro_w
		from	evolucao_paciente
		where	nr_atendimento		= nr_atendimento_p
		and	ie_evolucao_clinica	= ie_evolucao_clinica_w
		and	(((dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') and (coalesce(dt_inativacao::text, '') = '')) or (ie_exige_lib_evol_w = 'N'));
		
		if (qt_registro_w	= 0) then
				
			ds_erro_w := ds_erro_w || wheb_mensagem_pck.get_texto(277862, 'IE_EVOLUCAO_CLINICA_P=' || substr(Obter_desc_tipo_evolucao(ie_evolucao_clinica_w),1,200));
			item_posicionar_p := '5';
		end if;
	end if;


	if (ie_tipo_evolucao_w IS NOT NULL AND ie_tipo_evolucao_w::text <> '') then

		select	count(*)
		into STRICT	qt_registro_w
		from	evolucao_paciente
		where	nr_atendimento		= nr_atendimento_p
		and	ie_tipo_evolucao	= ie_tipo_evolucao_w
		and	(((dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') and (coalesce(dt_inativacao::text, '') = '')) or (ie_exige_lib_evol_w = 'N'));		


		if (qt_registro_w	= 0) then

			ds_erro_w := ds_erro_w || wheb_mensagem_pck.get_texto(277864, 'IE_TIPO_EVOLUCAO_P=' ||substr(obter_valor_dominio(72,ie_tipo_evolucao_w),1,200));
			item_posicionar_p := '5';
		end if;
	end if;	
	
	
	if (ie_anamnese_w = 'S' and coalesce(ie_html_p,'N') <> 'S') then
		select	count(*)
		into STRICT	qt_registro_w
		from	anamnese_paciente a
		where	nr_atendimento = nr_atendimento_p;

		if (qt_registro_w = 0) then	
			ds_erro_w := ds_erro_w || wheb_mensagem_pck.get_texto(277865);
			item_posicionar_p := '83';
		end if;
	end if;
	
	if (ie_anamnese_w = 'L' and coalesce(ie_html_p,'N') <> 'S') then
		select	count(*)
		into STRICT	qt_registro_w
		from	anamnese_paciente a
		where	nr_atendimento = nr_atendimento_p
		and    (((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') and (coalesce(a.dt_inativacao::text, '') = '')) or (ie_lib_anamnese_w = 'N'));

		if (qt_registro_w = 0) then	
			ds_erro_w := ds_erro_w || wheb_mensagem_pck.get_texto(277865);
			item_posicionar_p := '83';
		end if;
	end if;

	if	((ie_avaliacao_w = 'S') or (ie_avaliacao_w = 'L')) then
		select	count(*)
		into STRICT	qt_registro_w
		from	med_avaliacao_paciente 
		where	nr_atendimento = nr_atendimento_p
		and    ((nr_seq_tipo_avaliacao = nr_seq_tipo_avaliacao_w) or (nr_seq_tipo_avaliacao_w = 0))
        and    ie_situacao <> 'I';

		if (qt_registro_w = 0) then	
			ds_erro_w := ds_erro_w || wheb_mensagem_pck.get_texto(277866);
			item_posicionar_p := '7';
		end if;
	end if;

	if (ie_avaliacao_w = 'L') then	
		select	count(*)
		into STRICT	qt_registro_w
		from	med_avaliacao_paciente a
		where	nr_atendimento = nr_atendimento_p
		and    (((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') and (coalesce(a.dt_inativacao::text, '') = '')) or (ie_lib_avaliacao_w = 'N'))
		and    ((nr_seq_tipo_avaliacao = nr_seq_tipo_avaliacao_w) or (nr_seq_tipo_avaliacao_w = 0))
        and    ie_situacao <> 'I';
		
		if (qt_registro_w = 0) then	
			ds_erro_w := ds_erro_w || wheb_mensagem_pck.get_texto(277867);
			item_posicionar_p := '7';
		end if;
	end if;
	
	if (ie_tipo_escala_w = 57) then	
	
		select	count(*)
		into STRICT	qt_registro_w
		FROM	escala_tev a
		WHERE	nr_atendimento = nr_atendimento_p
		AND    (((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') AND (coalesce(a.dt_inativacao::text, '') = '')));
		
		if (qt_registro_w = 0) and (ie_entrou_w = 'N') then	
			ds_erro_w := ds_erro_w ||wheb_mensagem_pck.get_texto(691039);
			item_posicionar_p := '374';
			ie_entrou_w := 'S';
		end if;
	end if;

	if (ie_tipo_escala_w = 168) then
		select	count(*)
		into STRICT	qt_registro_w
		from	escala_sepse a
		where	a.nr_atendimento = nr_atendimento_p
		and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and	coalesce(a.dt_inativacao::text, '') = '';

		if (qt_registro_w > 0) then
			select	count(*)
			into STRICT	qt_registro_w
			from	escala_sepse a
			where	a.nr_atendimento = nr_atendimento_p
			and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			and	coalesce(a.dt_inativacao::text, '') = ''
			and	(a.ie_status_sepsis IS NOT NULL AND a.ie_status_sepsis::text <> '')
			and	a.ie_status_sepsis in ('RC','SC','RE','D','RD','RF','SN','CS');

			if (qt_registro_w = 0) and (ie_entrou_w = 'N') then
				select	max(a.ie_status_sepsis)
				into STRICT	ie_status_sepsis_w
				from	escala_sepse a
				where	a.nr_atendimento = nr_atendimento_p
				and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
				and	coalesce(a.dt_inativacao::text, '') = ''
				and	(a.ie_status_sepsis IS NOT NULL AND a.ie_status_sepsis::text <> '')
				and	a.ie_status_sepsis not in ('RC','SC','RE','D','RD','RF','SN','CS');

				if (ie_status_sepsis_w IS NOT NULL AND ie_status_sepsis_w::text <> '') then
					ds_erro_w := ds_erro_w ||substr(obter_des_status_sepse(ie_status_sepsis_w),1,255);
				else
					ds_erro_w := ds_erro_w ||wheb_mensagem_pck.get_texto(1121595);
				end if;

				item_posicionar_p := '374';
				ie_entrou_w := 'S';
			end if;
		end if;
	end if;

	if (ie_prescr_material_w = 'S') then	
		select	count(*)
		into STRICT	qt_registro_w
		from	prescr_material	b,
			prescr_medica	a
		where	a.nr_atendimento		= nr_atendimento_p
		and	b.nr_prescricao			= a.nr_prescricao
		and	coalesce(b.cd_motivo_baixa,0)	= 0
		and	coalesce(a.dt_suspensao::text, '') = ''
		and	coalesce(b.dt_suspensao::text, '') = ''
		and	(a.DT_LIBERACAO IS NOT NULL AND a.DT_LIBERACAO::text <> '');
		
		if (qt_registro_w > 0) then	
			ds_erro_w := ds_erro_w || wheb_mensagem_pck.get_texto(277869);
			item_posicionar_p := '0';
		end if;
	end if;
	if (ie_parecer_resposta_w  = 'S') then
		Select count(*)
		into STRICT   qt_registro_w
		from   parecer_medico_req a
		where  a.nr_atendimento = nr_atendimento_p
		and    (((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') and (coalesce(a.dt_inativacao::text, '') = '')) or (ie_lib_parecer_medico_w = 'N'))
		and    not exists (SELECT 1
			from     parecer_medico b
			where    b.nr_parecer = a.nr_parecer
			and	(((b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') and (coalesce(b.dt_inativacao::text, '') = '')) or (ie_lib_parecer_medico_w = 'N')));
				if (qt_registro_w > 0) then	
					ds_erro_w := ds_erro_w || wheb_mensagem_pck.get_texto(327927);
				end if;
	end if;

	if (ie_laudo_internacao_sus_w = 'S') then
		begin
		
		begin
		select	coalesce(obter_tipo_convenio(cd_convenio),0)
		into STRICT	ie_tipo_convenio_w
		from	atend_categoria_convenio
		where	nr_atendimento = nr_atendimento_p;
		exception
		when others then
			ie_tipo_convenio_w := 0;
		end;


		if (ie_tipo_convenio_w = 3) then
			begin	
			
			select	count(*)
			into STRICT	qt_registro_w
			from	sus_laudo_paciente
			where	nr_atendimento = nr_atendimento_p
			and	ie_classificacao = 1;
			
			if (qt_registro_w = 0) then
				ds_erro_w := ds_erro_w || wheb_mensagem_pck.get_texto(277871);
				item_posicionar_p := '365';
			end if;			
			end;
		end if;
		end;
	end if;
	if ( ie_prescr_sem_evol_w = 'S') then
		begin
		
		select	max(dt_prescricao)
		into STRICT	   dt_prescr_w
		from	   prescr_medica	a
		where	   a.nr_atendimento = nr_atendimento_p
		and	   coalesce(a.dt_suspensao::text, '') = '';	
		
      select  max(dt_evolucao),
              count(*)
		into STRICT	  dt_evolucao_w,
              total_ev_w
		from    evolucao_paciente a
		where   a.nr_atendimento = nr_atendimento_p
		and	  coalesce(a.dt_inativacao::text, '') = ''
		and	  (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '');
		
		if (dt_prescr_w > dt_evolucao_w ) or (total_ev_w = 0) then
			ds_erro_w := ds_erro_w || wheb_mensagem_pck.get_texto(277872);
			item_posicionar_p := '5';
		end if;		
		
		end;
	end if;
	if (ie_resumo_alta_w = 'S') then
		select count(1)
		into STRICT   qt_registro_w
		from   atendimento_alta
		where  nr_atendimento = nr_atendimento_p
		and    ie_tipo_orientacao <> 'P'
		and   ((ie_lib_orientacao_alta_w = 'N') or (dt_liberacao IS NOT NULL AND dt_liberacao::text <> ''));
		
		if (qt_registro_w = 0) then
			ds_erro_w := ds_erro_w || wheb_mensagem_pck.get_texto(290651);
			item_posicionar_p := '153';
		end if;		
	end if;
    if (nr_seq_tipo_template_w > 0) then
        select count(*)
		into STRICT  template_w
		from  ehr_registro
		where nr_atendimento = nr_atendimento_p
		and   nr_seq_templ = nr_seq_tipo_template_w
		and   (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
        and   coalesce(dt_inativacao::text, '') = '';
		
		if (template_w = 0) then
            select ds_template
            into STRICT ds_template_w
            from ehr_template
            where nr_sequencia = nr_seq_tipo_template_w;
			ds_erro_w := ds_erro_w || wheb_mensagem_pck.get_texto(1133431, 'DS_TEMPLATE_P=' || ds_template_w);
			item_posicionar_p := '0';
		end if;	
    end if;
	end;
end loop;
close C01;

open C02;
loop
fetch C02 into	
	cd_grupo_material_w,
	cd_subgrupo_material_w,
	cd_classe_material_w,
	cd_material_w,
	cd_area_proced_w,
	cd_especial_proced_w,
	cd_grupo_proced_w,
	cd_procedimento_w,
	ie_origem_proced_w,
	ie_consiste_w,
	ie_regra_w,
	IE_EVOLUCAO_CLINICA_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	
	
	if (ie_regra_w	= 'P') then
	
		if (ie_consiste_w	= 'P') then
			select	count(*)
			into STRICT	qt_registro_w
			from	prescr_procedimento b,
				prescr_medica a,
				estrutura_procedimento_v c
			where	a.nr_prescricao		= b.nr_prescricao
			and	coalesce(b.nr_seq_origem::text, '') = ''
			and	c.cd_procedimento	= b.cd_procedimento
			and	c.ie_origem_proced	= b.ie_origem_proced
			and	a.nr_atendimento	= nr_atendimento_p
			and	(coalesce(a.dt_liberacao, a.dt_liberacao_medico) IS NOT NULL AND (coalesce(a.dt_liberacao, a.dt_liberacao_medico))::text <> '')
			and	b.cd_motivo_baixa	= 0
			and	b.ie_suspenso		= 'N'
			and	a.dt_prescricao		> dt_referencia_w
			and	((coalesce(cd_area_proced_w::text, '') = '') or (c.CD_AREA_PROCEDIMENTO	= cd_area_proced_w))
			and	((coalesce(cd_especial_proced_w::text, '') = '') or (c.cd_especialidade = cd_especial_proced_w))
			and	((coalesce(cd_grupo_proced_w::text, '') = '') or (c.CD_GRUPO_PROC = cd_grupo_proced_w))
			and	((coalesce(cd_procedimento_w::text, '') = '') or (c.cd_procedimento = cd_procedimento_w));
			
		
			if (qt_registro_w	> 0) then
				ds_erro_w := ds_erro_w || wheb_mensagem_pck.get_texto(277873);
				item_posicionar_p := '0';
			end if;
		
		elsif (ie_consiste_w	= 'M') then
			
			select count(*)
			into STRICT	qt_registro_w
			from 	prescr_material b,
				prescr_medica a,
				ESTRUTURA_MATERIAL_V c
			where	a.nr_prescricao	= b.nr_prescricao
			and	c.cd_material	= b.cd_material
			and	a.nr_atendimento	= nr_atendimento_p
			and	b.cd_motivo_baixa	= 0
			and	a.dt_prescricao		> dt_referencia_w
			and	(coalesce(a.dt_liberacao, a.dt_liberacao_medico) IS NOT NULL AND (coalesce(a.dt_liberacao, a.dt_liberacao_medico))::text <> '')
			and	b.ie_suspenso		= 'N'
			and	((coalesce(cd_grupo_material_w::text, '') = '') or (c.cd_grupo_material	= cd_grupo_material_w))
			and	((coalesce(cd_subgrupo_material_w::text, '') = '') or (c.cd_subgrupo_material = cd_subgrupo_material_w))
			and	((coalesce(cd_classe_material_w::text, '') = '') or (c.cd_classe_material = cd_classe_material_w))
			and	((coalesce(cd_material_w::text, '') = '') or (c.cd_material = cd_material_w));
			
			if (qt_registro_w	> 0) then
				ds_erro_w := ds_erro_w || wheb_mensagem_pck.get_texto(277869);
				item_posicionar_p := '0';
			end if;
		end if;
		
		elsif (ie_regra_w	= 'E') then
	
			if (ie_consiste_w	= 'P') then
				select	count(*)
				into STRICT	qt_registro_w
				from	prescr_procedimento b,
					prescr_medica a,
					estrutura_procedimento_v c
				where	a.nr_prescricao		= b.nr_prescricao
				and	coalesce(b.nr_seq_origem::text, '') = ''
				and	c.cd_procedimento	= b.cd_procedimento
				and	c.ie_origem_proced	= b.ie_origem_proced
				and	a.nr_atendimento	= nr_atendimento_p
				and	(coalesce(a.dt_liberacao, a.dt_liberacao_medico) IS NOT NULL AND (coalesce(a.dt_liberacao, a.dt_liberacao_medico))::text <> '')
				and	(b.dt_baixa IS NOT NULL AND b.dt_baixa::text <> '')
				and	b.ie_suspenso		= 'N'
				and	a.dt_prescricao		> dt_referencia_w
				and	((coalesce(cd_area_proced_w::text, '') = '') or (c.CD_AREA_PROCEDIMENTO	= cd_area_proced_w))
				and	((coalesce(cd_especial_proced_w::text, '') = '') or (c.cd_especialidade = cd_especial_proced_w))
				and	((coalesce(cd_grupo_proced_w::text, '') = '') or (c.CD_GRUPO_PROC = cd_grupo_proced_w))
				and	((coalesce(cd_procedimento_w::text, '') = '') or (c.cd_procedimento = cd_procedimento_w));
				
			
				if (qt_registro_w	> 0) then
				
					select	count(*)
					into STRICT	qt_evol_w
					from	evolucao_paciente a
					where	a.nr_atendimento	= nr_atendimento_p
					and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
					and		coalesce(a.dt_inativacao::text, '') = ''
					and (a.IE_EVOLUCAO_CLINICA	= IE_EVOLUCAO_CLINICA_w or coalesce(IE_EVOLUCAO_CLINICA_w::text, '') = '');
				
					if (qt_evol_w	= 0) then
						ds_erro_w := ds_erro_w || wheb_mensagem_pck.get_texto(277880, 'DS_TIPO_EVOLUCAO_P=' ||substr(obter_descricao_padrao('TIPO_EVOLUCAO','DS_TIPO_EVOLUCAO', IE_EVOLUCAO_CLINICA_w),1,200));
						item_posicionar_p := '0';
					end if;
				
					
					
				end if;
			
			elsif (ie_consiste_w	= 'M') then
				
				select count(*)
				into STRICT	qt_registro_w
				from 	prescr_material b,
					prescr_medica a,
					ESTRUTURA_MATERIAL_V c
				where	a.nr_prescricao	= b.nr_prescricao
				and	c.cd_material	= b.cd_material
				and	a.nr_atendimento	= nr_atendimento_p
				and	(b.dt_baixa IS NOT NULL AND b.dt_baixa::text <> '')
				and	a.dt_prescricao		> dt_referencia_w
				and	(coalesce(a.dt_liberacao, a.dt_liberacao_medico) IS NOT NULL AND (coalesce(a.dt_liberacao, a.dt_liberacao_medico))::text <> '')
				and	b.ie_suspenso		= 'N'
				and	((coalesce(cd_grupo_material_w::text, '') = '') or (c.cd_grupo_material	= cd_grupo_material_w))
				and	((coalesce(cd_subgrupo_material_w::text, '') = '') or (c.cd_subgrupo_material = cd_subgrupo_material_w))
				and	((coalesce(cd_classe_material_w::text, '') = '') or (c.cd_classe_material = cd_classe_material_w))
				and	((coalesce(cd_material_w::text, '') = '') or (c.cd_material = cd_material_w));
				
				if (qt_registro_w	> 0) then
				
					select	count(*)
					into STRICT	qt_evol_w
					from	evolucao_paciente a
					where	a.nr_atendimento	= nr_atendimento_p
					and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
					and		coalesce(a.dt_inativacao::text, '') = ''
					and (a.IE_EVOLUCAO_CLINICA	= IE_EVOLUCAO_CLINICA_w or coalesce(IE_EVOLUCAO_CLINICA_w::text, '') = '');
				
					if (qt_evol_w	= 0) then
						ds_erro_w := ds_erro_w || wheb_mensagem_pck.get_texto(277880, 'DS_TIPO_EVOLUCAO_P=' || substr(obter_descricao_padrao('TIPO_EVOLUCAO','DS_TIPO_EVOLUCAO', IE_EVOLUCAO_CLINICA_w),1,200));
						item_posicionar_p := '0';
					end if;
				
					
					
				end if;
			
			end if;
			
	end if;

		
	end;
end loop;
close C02;

ds_erro_p	:= null;
ds_erro2_p	:= null;

if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') or (ds_erro_w <> '') then
	ds_erro_w := wheb_mensagem_pck.get_texto(277881) || ds_erro_w;
	ds_erro_p :=  substr(ds_erro_w,1,254);
	ds_erro2_p := substr(ds_erro_w,255,255);
end if;

--ds_erro_p := ds_erro_w;
end;


$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_desfecho_pa ( nr_atendimento_p bigint, nm_usuario_p text, ds_erro_p INOUT text, item_posicionar_p INOUT text, ds_erro2_p INOUT text, ie_desfecho_p text default null, ie_html_p text default 'N') FROM PUBLIC;

