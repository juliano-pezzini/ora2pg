-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_dashboard_regra ( nr_seq_protocolo_p protocolo_convenio.nr_seq_protocolo%type, nr_seq_retorno_p convenio_retorno.nr_sequencia%type default null, nr_seq_lote_hist_p lote_audit_hist.nr_sequencia%type default null) AS $body$
DECLARE


/*
	Date/Timestamp:	January 13th, 2021
	Object: 	GERAR_DASHBOARD_REGRA
	Type:		Procedure
	Job avaiable:	N/A
	Author(s):	Cunha, Nicolas Filipe; Alves, Ronaldo Rodrigues
	Usage:		Verifies if the dashboard package should be invoked to the inbound insurance protocol sequence.
			Further validations can be done here to avoid code duplication.
	Project:	12069
	Note:		N/A
*/
dt_referencia_w		protocolo_convenio.dt_mesano_referencia%type;
cd_estabelecimento_w	protocolo_convenio.cd_estabelecimento%type;

ie_executa_dashboard_w	parametro_faturamento.ie_show_eis_dam%type;

/*
	Patient accounts' insurance protocols sequences based on the insurance return forms.
*/
protocolos_retorno CURSOR FOR
SELECT	distinct a.nr_seq_protocolo nr_seq_protocolo
from	conta_paciente a,
	convenio_retorno_item b
where	a.nr_interno_conta 	= b.nr_interno_conta
and	b.nr_seq_retorno 	= nr_seq_retorno_p;

/*
	Patient accounts' insurance protocols sequences based on the analysis' forms.
*/
protocolos_analise CURSOR FOR
SELECT	distinct b.nr_seq_protocolo nr_seq_protocolo
from	conta_paciente b,
	lote_audit_hist_guia a
where	b.nr_interno_conta	= a.nr_interno_conta
and	a.nr_seq_lote_hist 	= nr_seq_lote_hist_p;
BEGIN

select	coalesce(max(ie_show_eis_dam), 'N')
into STRICT	ie_executa_dashboard_w
from	parametro_faturamento
where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

if	ie_executa_dashboard_w = 'S' then

	if 	coalesce(nr_seq_protocolo_p, 0) > 0 then

		select		max(dt_mesano_referencia),
				max(cd_estabelecimento)
		into STRICT		dt_referencia_w,
				cd_estabelecimento_w
		from		protocolo_convenio
		where		nr_seq_protocolo = nr_seq_protocolo_p;
		
		CALL tiss_dashboard_data_pck.popular_protocolo(dt_referencia_w, cd_estabelecimento_w,
			nr_seq_protocolo_p, wheb_usuario_pck.get_nm_usuario);
		
	elsif 	coalesce(nr_seq_retorno_p, 0) > 0 then

		for protocolo in protocolos_retorno loop
			CALL gerar_dashboard_regra(protocolo.nr_seq_protocolo);
		end loop;
		
	elsif 	coalesce(nr_seq_lote_hist_p, 0) > 0 then
		
		for protocolo in protocolos_analise loop
			CALL gerar_dashboard_regra(protocolo.nr_seq_protocolo);
		end loop;

	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_dashboard_regra ( nr_seq_protocolo_p protocolo_convenio.nr_seq_protocolo%type, nr_seq_retorno_p convenio_retorno.nr_sequencia%type default null, nr_seq_lote_hist_p lote_audit_hist.nr_sequencia%type default null) FROM PUBLIC;

