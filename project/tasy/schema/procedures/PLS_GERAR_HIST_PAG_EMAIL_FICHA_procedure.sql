-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_hist_pag_email_ficha ( nr_titulo_p bigint, ds_email_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_pagador_w		bigint;
ds_historico_w			varchar(4000);
dt_envio_w				timestamp;
dt_hora_envio_w		varchar(10);
cd_funcao_w    			integer;
ie_origem_w				pls_email.ie_origem%type;
ds_parametro_w    	varchar(5);
ds_email_w  varchar(1000);


BEGIN
select	max(a.nr_sequencia)
into STRICT	nr_seq_pagador_w
from	pls_mensalidade		c,
	titulo_receber		b,
	pls_contrato_pagador	a
where	c.nr_sequencia	= b.nr_seq_mensalidade
and	a.nr_sequencia	= c.nr_seq_pagador
and	b.nr_titulo	= nr_titulo_p;

  cd_funcao_w := obter_funcao_ativa();
  ds_parametro_w := Obter_Param_Usuario(5512, 24, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ds_parametro_w);

    if cd_funcao_w = 5512 then
        ie_origem_w := '12'; -- Ficha Financeira
    end if;
	
/*OS 1951075 - Liberar historico ao enviar email. Feito dessa forma para n criar novos parametros In nessa proc do OPS.*/

dt_envio_w		:= clock_timestamp();
dt_hora_envio_w := substr(to_char(clock_timestamp(),'hh24:mi'),1,10);

	if (ie_origem_w = '12') and (ds_parametro_w = 'S') then
    ds_email_w := replace(ds_email_p,';',',');
		ds_historico_w 	:= substr(wheb_mensagem_pck.get_texto(1202851, 'ds_email_p=' || ds_email_w || ';dt_envio_p=' || dt_envio_w || ';dt_hora_envio_p='||dt_hora_envio_w||';nr_titulo_p='||nr_titulo_p),1,3999);
	else
		ds_historico_w 	:= substr(wheb_mensagem_pck.get_texto(1084585, 'ds_email_p=' || ds_email_p || ';dt_envio_p=' || dt_envio_w || ';dt_hora_envio_p='||dt_hora_envio_w||';nr_titulo_p='||nr_titulo_p),1,3999);
end if;

if (nr_seq_pagador_w IS NOT NULL AND nr_seq_pagador_w::text <> '') then
	CALL pls_gerar_hist_fin_pagador(	nr_seq_pagador_w, 'FF',
					ds_historico_w ||'#@LIB#@',
					nm_usuario_p, cd_estabelecimento_p);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_hist_pag_email_ficha ( nr_titulo_p bigint, ds_email_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

