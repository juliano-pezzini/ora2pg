-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE release_vital_sign_integration ( nr_seq_sv_p bigint, nr_seq_hemo_p bigint, nr_seq_resp_p bigint, nr_atendimento_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE

ie_exige_aprovacao_w varchar(3);
ds_retorno_valida_sv_w      varchar(2000);
ie_retorno_valida_sv_w      varchar(10);
ie_aprovacao_sinal_vital_w setor_atendimento.ie_aprovacao_sinal_vital%type;


BEGIN

ie_exige_aprovacao_w := obter_param_usuario(281, 1493, 0, 0, cd_estabelecimento_p, ie_exige_aprovacao_w);

select  coalesce(max(ie_aprovacao_sinal_vital),'D')
    into STRICT	ie_aprovacao_sinal_vital_w
    from	setor_atendimento
    where	cd_setor_atendimento = obter_setor_atendimento(nr_atendimento_p);

    if (ie_aprovacao_sinal_vital_w = 'S' or (ie_aprovacao_sinal_vital_w = 'D' and ie_exige_aprovacao_w = 'N')) then
			update atendimento_sinal_vital set dt_liberacao = clock_timestamp() where nr_sequencia = nr_seq_sv_p;
			update atendimento_monit_resp  set dt_liberacao = clock_timestamp() where nr_sequencia = nr_seq_resp_p;
			update atend_monit_hemod       set dt_liberacao = clock_timestamp() where nr_sequencia = nr_seq_hemo_p;
			commit;

    elsif (ie_aprovacao_sinal_vital_w = 'D' and ie_exige_aprovacao_w = 'C') then

			SELECT * FROM consiste_itens_sinal_vital(nr_seq_sv_p, ds_retorno_valida_sv_w, ie_retorno_valida_sv_w) INTO STRICT ds_retorno_valida_sv_w, ie_retorno_valida_sv_w;

			if (ie_retorno_valida_sv_w <> 'E' AND ie_retorno_valida_sv_w <> 'A')then

				update atendimento_sinal_vital set dt_liberacao = clock_timestamp() where nr_sequencia = nr_seq_sv_p;
				update atendimento_monit_resp  set dt_liberacao = clock_timestamp() where nr_sequencia = nr_seq_resp_p;
				update atend_monit_hemod       set dt_liberacao = clock_timestamp() where nr_sequencia = nr_seq_hemo_p;
				commit;

			end if;
    end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE release_vital_sign_integration ( nr_seq_sv_p bigint, nr_seq_hemo_p bigint, nr_seq_resp_p bigint, nr_atendimento_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

