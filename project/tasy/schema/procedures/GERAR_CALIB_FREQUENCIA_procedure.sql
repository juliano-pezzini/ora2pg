-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_calib_frequencia () AS $body$
DECLARE


vl_dominio_w		varchar(15);
ds_valor_dominio_w	varchar(255);
qt_registro_w		bigint;
qt_dias_iguais_w	bigint;

C01 CURSOR FOR
	SELECT	vl_dominio,
		ds_valor_dominio
	from	valor_dominio
	where	1 = 1
	and	cd_dominio = 2540
	and	ie_situacao = 'A'
	order by ds_valor_dominio;


BEGIN

open C01;
loop
fetch C01 into
	vl_dominio_w,
	ds_valor_dominio_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	count(*)
	into STRICT	qt_registro_w
	from	man_freq_calib
	where	qt_dia = CASE WHEN vl_dominio_w='A' THEN 365 WHEN vl_dominio_w='S' THEN 7 WHEN vl_dominio_w='M' THEN 30 WHEN vl_dominio_w='D' THEN 1 WHEN vl_dominio_w='E' THEN 180 WHEN vl_dominio_w='T' THEN 90 WHEN vl_dominio_w='B' THEN 60 WHEN vl_dominio_w='Q' THEN 120 WHEN vl_dominio_w='I' THEN 730 END;

		if (qt_registro_w = 0) then
			insert into man_freq_calib(nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							qt_dia,
							ie_situacao,
							ds_frequencia
							)
						values (nextval('man_freq_calib_seq'),
							clock_timestamp(),
							'TASY',
							clock_timestamp(),
							'TASY',
							CASE WHEN vl_dominio_w='A' THEN 365 WHEN vl_dominio_w='S' THEN 7 WHEN vl_dominio_w='M' THEN 30 WHEN vl_dominio_w='D' THEN 1 WHEN vl_dominio_w='E' THEN 180 WHEN vl_dominio_w='T' THEN 90 WHEN vl_dominio_w='B' THEN 60 WHEN vl_dominio_w='Q' THEN 120 WHEN vl_dominio_w='I' THEN 730 END ,
							'A',
							ds_valor_dominio_w
							);

		end if;

	end;
end loop;
close C01;


update 	man_equip_calibracao a
set	nr_seq_frequencia = (	SELECT 	max(b.nr_sequencia)
				from 	man_freq_calib b,
					valor_dominio c
				where	CASE WHEN c.vl_dominio='A' THEN 365 WHEN c.vl_dominio='S' THEN 7 WHEN c.vl_dominio='M' THEN 30 WHEN c.vl_dominio='D' THEN 1 WHEN c.vl_dominio='E' THEN 180 WHEN c.vl_dominio='T' THEN 90 WHEN c.vl_dominio='B' THEN 60 WHEN c.vl_dominio='Q' THEN 120 WHEN c.vl_dominio='I' THEN 730 END  = b.qt_dia
				and	c.cd_dominio = 2540
				and	c.vl_dominio = a.ie_frequencia)
where	coalesce(nr_seq_frequencia::text, '') = '';

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_calib_frequencia () FROM PUBLIC;

