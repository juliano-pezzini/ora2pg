-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_dieta_protocolo ( nr_prescricao_p bigint, cd_protocolo_p bigint, nr_sequencia_p bigint, nr_seq_dieta_p bigint, cd_intervalo_p text, qt_protocolo_p bigint, nm_usuario_p text, qt_parametro_p bigint default null) AS $body$
DECLARE

ds_erro_w		varchar(255);
ie_cig_w		varchar(255);
dt_primeiro_horario_w	timestamp;
cd_convenio_w		integer;
nr_atendimento_w		bigint;
nr_horas_validade_w	integer;
nr_seq_material_w		integer;
nr_seq_procedimento_w	integer;
qt_dose_ataque_w	double precision;

nr_seq_dieta_w		integer;
nr_seq_dieta_novo_w	integer;
nr_seq_dieta_prot_w	integer;
cd_dieta_w		bigint;
ie_destino_dieta_w	varchar(2);
ie_tipo_sol_w		varchar(5);
cd_estab_w			smallint;
ie_tipo_convenio_w		smallint;
ds_dado_clinico_w	varchar(255);
ie_refeicao_w		varchar(3);
ds_horarios_dieta_w	varchar(2000);
ds_observacao_dieta_w		varchar(2000);
ds_exame_fis_achado_cirur_w	varchar(2000);
ds_resumo_clinico_w	varchar(2000);

nr_seq_rec_w		integer;

nr_seq_solucao_w		integer;
nr_seq_solucao_novo_w	integer;
nr_seq_solucao_prot_w	integer;
nr_agrupamento_sol_w	double precision;
ie_tipo_dosagem_w		varchar(3);
cd_setor_atend_w		integer;
qt_dosagem_w		double precision;
qt_solucao_total_w		double precision;
qt_tempo_aplicacao_w	double precision;
cd_categoria_w			varchar(10);
qt_volume_w		double precision;
nr_etapas_w		smallint;
ie_bomba_infusao_w	varchar(1);
ie_esquema_alternado_w	varchar(1);
ie_calc_aut_w		varchar(1);
ie_acm_sol_w		varchar(1);
qt_hora_fase_w		double precision;
ds_horarios_sol_w		varchar(2000);

nr_seq_proc_w		integer;
nr_agrupamento_proc_w	double precision;
nr_seq_proc_novo_w	integer;
nr_seq_proc_prot_w	integer;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
qt_procedimento_w		double precision;
ds_observacao_w		varchar(2000);
cd_intervalo_w		varchar(7);
cd_setor_exclusivo_w	integer;
cd_material_exame_w	varchar(20);
nr_seq_exame_w		bigint;
ie_se_necessario_w	varchar(1);
ie_acm_proced_w		varchar(1);
hr_prim_horario_proced_w	varchar(5);
ds_material_especial_w	varchar(45);
ie_agora_w		varchar(1);
cd_proced_aux_w		bigint;
ie_origem_aux_w		bigint;
ds_horarios_proced_w        	varchar(2000);
ds_horarios_proced2_w        	varchar(2000);
nr_ocorrencia_proced_w	double precision;
ie_objetivo_onco_w		varchar(15);
ie_executar_leito_w		varchar(1);
nr_seq_contraste_w		bigint;
qt_limite_uma_hora_w		double precision;
hr_prim_hor_sol_w		varchar(5);



cd_material_w              	integer;
qt_dose_w       		double precision;
cd_unidade_medida_dose_w	varchar(30);
nr_sequencia_w		bigint;
qt_dose_ml_w		double precision;
qt_total_etapa_w		double precision;
qt_dosagem_final_w	double precision;
qt_conversao_ml_w		double precision;

ds_solucao_w		varchar(100);
nr_seq_proc_interno_w	bigint;
ie_lado_w		varchar(1);

dt_prescricao_w		timestamp;

nr_seq_nut_w		bigint;
nr_seq_fator_ativ_w	bigint;
nr_seq_fator_stress_w	bigint;
pr_proteina_w		smallint;
pr_lipidio_w		smallint;
pr_carboidrato_w		smallint;
qt_kcal_prot_w		integer;
qt_kcal_lipidio_w               	integer;
qt_kcal_carboidrato_w           	integer;
qt_kcal_total_w                 	integer;
qt_kcal_kg_w                    	real;
qt_grama_prot_kg_dia_w        real;
pr_npt_w                        	real;
qt_fase_npt_w                   	smallint;
qt_gotejamento_npt_w            smallint;
cd_pessoa_fisica_w	varchar(10);
qt_peso_w	 	real;
qt_altura_w		real;
qt_idade_w		smallint;
nr_seq_npt_w		bigint;
cd_estabelecimento_w	smallint;
DS_DOSE_DIFERENCIADA_w	varchar(50);
ie_medic_internado_w		varchar(255);
ie_tipo_atendimento_w		smallint;
ie_urgencia_w			varchar(1);
cd_setor_prescr_w			integer;/* Rafael em 28/2/8 OS81068 */
ie_respiracao_w			varchar(15);
cd_mod_vent_w			varchar(15);
qt_fluxo_oxigenio_w		double precision;
dt_prim_horario_proced_w	timestamp;

ie_tipo_hemodialise_w	varchar(15);
qt_sessao_sem_w		smallint;
qt_hora_sessao_w	smallint;
qt_min_sessao_w		smallint;
qt_fluxo_sangue_w	double precision;
nr_seq_mod_dialisador_w	bigint;
ie_ultrafiltracao_w	varchar(15);
qt_ultrafiltracao_w	double precision;
ie_tipo_dialise_w	varchar(1);
ie_tipo_peritoneal_w	varchar(15);
nr_seq_maq_cicladora_w	bigint;
qt_volume_total_w	double precision;
dt_status_w		timestamp;
ie_status_w		varchar(15);
nr_seq_hd_prescr_w	bigint;


ie_pos_dialisador_w	varchar(1);
ie_hemodialise_w	varchar(1);
nr_seq_protocolo_w	bigint;
ie_tipo_solucao_w	varchar(15);
qt_temp_solucao_w	real;
ie_momento_w		varchar(1);
ie_unid_vel_inf_w	varchar(3);

nr_seq_elemento_w	bigint;
cd_unidade_medida_w	varchar(30);
qt_elemento_w		double precision;
nr_seq_sol_elem_w	bigint;
nr_seq_medic_w		bigint;
dt_inicio_prescr_w	timestamp;
qt_min_intervalo_w	integer;
ie_gerar_setor_w	varchar(10);

nr_seq_bco_sangue_w	bigint;
ie_tipo_paciente_w	varchar(2);
ie_porte_cirurgico_w	varchar(2);
ie_tipo_w		bigint;
ds_diag_bco_sangue_w	varchar(256);
nr_seq_proc_sangue_w	bigint;
nr_seq_derivado_w	bigint;
qt_vol_hemocomp_w	bigint;
dt_prev_execucao_w	timestamp;
qt_veloc_inf_hemo_w	bigint;
cd_setor_atendimento_w	integer;
ie_util_hemocomponente_w	varchar(15);
nr_seq_prescr_sangue_w	bigint;
nr_seq_prot_glic_w	bigint;
ie_se_necessario_sol_w	varchar(15);

nr_seq_gasoterapia_w	bigint;
ie_disp_resp_esp_w	varchar(15);
cd_modalidade_vent_w	varchar(15);
nr_seq_gas_w		bigint;
ie_modo_adm_w		varchar(5);
ie_inicio_w		varchar(15);
ie_unidade_medida_w	varchar(15);
qt_gasoterapia_w	double precision;
qt_freq_vent_w		smallint;
nr_seq_gas_prot_w	bigint;

ie_solucao_pca_w	varchar(15);
ie_tipo_analgesia_w	varchar(15);
ie_pca_modo_prog_w	varchar(15);
qt_dose_inicial_pca_w	double precision;
qt_vol_infusao_pca_w	double precision;
qt_bolus_pca_w		double precision;
qt_intervalo_bloqueio_w	double precision;
qt_limite_quatro_hora_w	double precision;
ds_orientacao_w		varchar(255);

nr_seq_tipo_w		bigint;
nr_seq_objetivo_w	bigint;
dt_inicio_w		timestamp;
dt_fim_w		timestamp;
dt_evento_w		timestamp;
qt_min_ant_w		integer;
qt_min_depois_w		integer;
qt_hora_ant_w		integer;
qt_hora_depois_w	integer;
ds_evento_w		varchar(255);
ie_repete_copia_w	varchar(1);
nr_seq_jejum_w		bigint;
ie_consiste_medic_w	varchar(1);
ie_dt_prescr_dt_exec_proc_w	varchar(1);
ie_arredondar_w		varchar(1);
ie_urgencia_Prot_W	varchar(1);

cd_setor_entrega_w	integer;

C01 CURSOR FOR
SELECT	nr_seq_dieta + nr_seq_dieta_w,
	nr_seq_dieta,
	cd_dieta,
	ie_destino_dieta,
	ie_refeicao,
	ds_observacao,
	cd_intervalo
from	Protocolo_medic_dieta
where	cd_protocolo	 	= cd_protocolo_p
and	nr_sequencia		= nr_sequencia_p
and (coalesce(nr_seq_dieta_p::text, '') = '' or nr_seq_dieta = nr_seq_dieta_p);


BEGIN

ie_urgencia_w	:= 'N';


select	dt_primeiro_horario,
	nr_atendimento,
	nr_horas_validade,
	dt_prescricao,
	cd_estabelecimento,
	cd_setor_atendimento,
	dt_inicio_prescr
into STRICT	dt_primeiro_horario_w,
	nr_atendimento_w,
	nr_horas_validade_w,
	dt_prescricao_w,
	cd_estabelecimento_w,
	cd_setor_prescr_w,
	dt_inicio_prescr_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

ie_medic_internado_w := Obter_Param_Usuario(924, 177, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_medic_internado_w);
ie_consiste_medic_w := Obter_Param_Usuario(924, 18, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_consiste_medic_w);
ie_dt_prescr_dt_exec_proc_w := Obter_Param_Usuario(924, 397, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_dt_prescr_dt_exec_proc_w);
ie_arredondar_w := obter_param_usuario(924, 560, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_arredondar_w);


select	max(coalesce(ie_tipo_atendimento,1))
into STRICT	ie_tipo_atendimento_w
from	atendimento_paciente
where	nr_atendimento	= nr_atendimento_w;

CALL Consiste_Protocolo_prescricao(cd_estabelecimento_w, cd_protocolo_p, nr_sequencia_p, ie_consiste_medic_w);

-- Obter_ConvÃªnio do Atendimento
if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
	begin
	select	cd_convenio
	into STRICT	cd_convenio_w
	from	atend_categoria_convenio
	where	nr_atendimento = nr_atendimento_w
	and	dt_inicio_vigencia =
		(SELECT	max(dt_inicio_vigencia)
		from	atend_categoria_convenio
		where	nr_atendimento = nr_atendimento_w);
	exception
		when others then
			cd_convenio_w := null;
	end;
end if;


select	coalesce(max(nr_sequencia),0)
into STRICT	nr_seq_dieta_w
from	prescr_dieta
where	nr_prescricao = nr_prescricao_p;

OPEN C01;
LOOP
	fetch C01 into
		nr_seq_dieta_novo_w,
		nr_seq_dieta_prot_w,
		cd_dieta_w,
		ie_destino_dieta_w,
		ie_refeicao_w,
		ds_observacao_dieta_w,
		cd_intervalo_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	Insert into Prescr_Dieta(
		nr_prescricao,
		nr_sequencia,
		cd_dieta,
		dt_atualizacao,
		nm_usuario,
		ie_destino_dieta,
		ie_refeicao,
		ie_suspenso,
		ds_observacao,
		QT_PARAMETRO,
		cd_intervalo)
	values (	nr_prescricao_p,
		nr_seq_dieta_novo_w,
		cd_dieta_w,
		clock_timestamp(),
		nm_usuario_p,
		ie_destino_dieta_w,
		ie_refeicao_w,
		'N',
		ds_observacao_dieta_w,
		qt_parametro_p,
		cd_intervalo_w);	
	
	CALL Inserir_mat_prescr_prot(nr_prescricao_p, cd_protocolo_p, nr_sequencia_p,0,
				6, nr_seq_dieta_prot_w, 0, 0, nr_seq_dieta_novo_w,
				null, null, cd_intervalo_p, qt_protocolo_p, nm_usuario_p, coalesce(ie_urgencia_w,'N'),0,null,0,0, null,null,null,null,null,null,null,null,null,null,null,null,null,'S',null,null,null,null,null,null,null,null,null,null,null,null);
	end;
END LOOP;
CLOSE C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_dieta_protocolo ( nr_prescricao_p bigint, cd_protocolo_p bigint, nr_sequencia_p bigint, nr_seq_dieta_p bigint, cd_intervalo_p text, qt_protocolo_p bigint, nm_usuario_p text, qt_parametro_p bigint default null) FROM PUBLIC;

