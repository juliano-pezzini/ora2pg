-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_pacote ( nr_seq_procedimento_p bigint, ie_tipo_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE

		 
/*pls_gerar_pacote foi substuida pela pls_abrir_proc_pacote*/
 
		 
/* IE_TIPO_P 
	C - Conta médica 
	A - Autorização 
*/
 
 
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
nr_seq_prestador_exec_w		bigint;
nr_seq_tipo_acomodacao_w	bigint;
dt_pacote_w			timestamp;
nr_seq_pacote_w			bigint;
cd_proc_pacote_w		bigint;
ie_origem_pacote_w		bigint;
vl_pacote_w			pls_conta_proc.vl_unitario%type;

vl_medico_w			double precision;
vl_anestesista_w		double precision;
vl_auxiliares_w			double precision;
vl_custo_operacional_w		double precision;
vl_materiais_w			double precision;
nr_seq_conta_w			bigint;
qt_registro_w			integer	:= 0;
nr_seq_segurado_w        bigint;
nr_seq_congenere_w       bigint;
nr_contrato_w          varchar(20);
nr_seq_plano_w         bigint;
ie_internado_w         varchar(10);
ie_origem_conta_w		varchar(3);
nr_seq_regra_pacote_w		bigint;
nr_seq_intercambio_w		bigint;
nr_seq_classificacao_prest_w	bigint;
ie_tipo_intercambio_w		varchar(1);
sg_estado_w			pessoa_juridica.sg_estado%type;
sg_estado_int_w			pessoa_juridica.sg_estado%type;


BEGIN 
 
if (ie_tipo_p	= 'C') then 
	select	a.cd_procedimento, 
		a.ie_origem_proced, 
		b.nr_seq_prestador_exec, 
		b.nr_seq_tipo_acomodacao, 
		coalesce(a.dt_procedimento, b.dt_emissao), 
		a.nr_seq_conta, 
		substr(pls_obter_se_internado(b.nr_sequencia,'X'),1,1), 
		b.nr_seq_plano, 
		nr_seq_segurado, 
		ie_origem_conta 
	into STRICT	cd_procedimento_w, 
		ie_origem_proced_w, 
		nr_seq_prestador_exec_w, 
		nr_seq_tipo_acomodacao_w, 
		dt_pacote_w, 
		nr_seq_conta_w, 
		ie_internado_w, 
		nr_seq_plano_w, 
		nr_seq_segurado_w, 
		ie_origem_conta_w 
	from	pls_conta	b, 
		pls_conta_proc	a 
	where	a.nr_seq_conta	= b.nr_sequencia 
	and	a.nr_sequencia	= nr_seq_procedimento_p;
 
    begin 
    select coalesce(a.nr_contrato,0), 
        b.nr_seq_congenere 
    into STRICT  nr_contrato_w, 
        nr_seq_congenere_w 
    FROM pls_segurado b
LEFT OUTER JOIN pls_contrato a ON (b.nr_seq_contrato = a.nr_sequencia)
WHERE b.nr_sequencia = nr_seq_segurado_w;
    exception 
    when others then 
        nr_contrato_w  := 0;
    end;	
	 
	select	max(nr_seq_intercambio) 
	into STRICT	nr_seq_intercambio_w 
	from	pls_segurado 
	where	nr_sequencia = nr_seq_segurado_w;
	 
	select	max(nr_seq_classificacao) 
	into STRICT	nr_seq_classificacao_prest_w 
	from	pls_prestador 
	where	nr_sequencia = nr_seq_prestador_exec_w;
	 
end if;
select	coalesce(max(sg_estado),'X') 
into STRICT	sg_estado_w 
from	pessoa_juridica 
where	cd_cgc	= (	SELECT	max(cd_cgc_outorgante) 
			from	pls_outorgante 
			where	cd_estabelecimento	= cd_estabelecimento_p);
select	coalesce(max(a.sg_estado),'X') 
into STRICT	sg_estado_int_w 
from	pessoa_juridica	a, 
	pls_congenere	b 
where	a.cd_cgc	= b.cd_cgc 
and	b.nr_sequencia	= nr_seq_congenere_w;
 
if (sg_estado_w <> 'X') and (sg_estado_int_w <> 'X') then 
	if (sg_estado_w	= sg_estado_int_w) then 
		ie_tipo_intercambio_w	:= 'E';
	else	 
		ie_tipo_intercambio_w	:= 'N';
	end if;
else 
	ie_tipo_intercambio_w	:= 'A';
end if;
	 
SELECT * FROM pls_define_preco_pacote(cd_estabelecimento_p, nr_seq_prestador_exec_w, nr_seq_tipo_acomodacao_w, dt_pacote_w, cd_procedimento_w, ie_origem_proced_w, ie_internado_w, nr_seq_plano_w, nr_contrato_w, nr_seq_congenere_w, nm_usuario_p, ie_origem_conta_w, ie_tipo_intercambio_w, nr_seq_pacote_w, nr_seq_regra_pacote_w, cd_proc_pacote_w, ie_origem_pacote_w, vl_pacote_w, vl_medico_w, vl_anestesista_w, vl_auxiliares_w, vl_custo_operacional_w, vl_materiais_w, nr_seq_intercambio_w, nr_seq_classificacao_prest_w, nr_seq_procedimento_p, nr_seq_segurado_w, null, 'S', null, 1) INTO STRICT nr_seq_pacote_w, nr_seq_regra_pacote_w, cd_proc_pacote_w, ie_origem_pacote_w, vl_pacote_w, vl_medico_w, vl_anestesista_w, vl_auxiliares_w, vl_custo_operacional_w, vl_materiais_w;
			 
if (coalesce(cd_proc_pacote_w,0) > 0) then 
	select	count(*) 
	into STRICT	qt_registro_w 
	from	pls_conta_proc 
	where	nr_seq_conta		= nr_seq_conta_w 
	and	cd_procedimento		= cd_proc_pacote_w 
	and	ie_origem_proced	= ie_origem_pacote_w;
	 
	if (qt_registro_w	= 0) then 
		insert into pls_conta_proc(nr_sequencia, dt_atualizacao, nm_usuario, 
			dt_atualizacao_nrec, nm_usuario_nrec, dt_procedimento, 
			cd_procedimento, ie_origem_proced, qt_procedimento, 
			vl_unitario, vl_procedimento, nr_seq_conta, 
			vl_liberado, vl_glosa, ie_tipo_despesa,         
			ie_situacao, ie_status, vl_custo_operacional, 
			vl_anestesista, vl_materiais, vl_medico,            
			vl_auxiliares, ds_log, nr_seq_pacote, 
			nr_seq_preco_pacote) 
		values (	nextval('pls_conta_proc_seq'), clock_timestamp(), nm_usuario_p, 
			clock_timestamp(), nm_usuario_p, clock_timestamp(), 
			cd_proc_pacote_w, ie_origem_pacote_w, 1, 
			vl_pacote_w, vl_pacote_w, nr_seq_conta_w, 
			0, 0, '4', 
			'D', 'U', vl_custo_operacional_w, 
			vl_anestesista_w, vl_materiais_w, vl_medico_w, 
			vl_auxiliares_w, 'pls_gerar_pacote', nr_seq_pacote_w, 
			nr_seq_regra_pacote_w);
 
	end if;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_pacote ( nr_seq_procedimento_p bigint, ie_tipo_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

