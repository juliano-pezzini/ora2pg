-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';


procedure ish_receber_hcm is

/*com quebra 23 linhas*/

--nm_arquivo_w			varchar2(255)	:=	'20170907102200_ntish.dat';
/*sem quebra - 23 linhas*/

--nm_arquivo_w			varchar2(255)	:=	'20170907103300_ntish.dat';
--nm_arquivo_w			varchar2(255)	:=	'20170905114100_ntish.dat';
--ds_diretorio_w			varchar2(255)	:= 	'/oraprd03/utlfile/ISH';
ds_conteudo_w				varchar2(32000);
ie_status_w				intpd_fila_transmissao.ie_status%type;
ie_tipo_w					varchar2(3);
nr_seq_mensagem_w			number(10);
nr_seq_registro_w				number(10);
nr_seq_segmento_w			number(10);
qt_tamanho_w				number(5);
ds_segmento_w				varchar2(4000);
ds_segmento_ant_w			varchar2(4000);
hcm_kopf_w				hcm_kopf%rowtype;
hcm_patienten_w				hcm_patienten%rowtype;
hcm_fall_w				hcm_fall%rowtype;
hcm_angehorigen_w			hcm_angehorigen%rowtype;
hcm_fallklassifikations_w			hcm_fallklassifikations%rowtype;
hcm_versicherungsverhaltni_w		hcm_versicherungsverhaltni%rowtype;
hcm_pat_zusammenfuhrung_w		hcm_pat_zusammenfuhrung%rowtype;
cd_pessoa_fisica_w			pessoa_fisica.cd_pessoa_fisica%type;
nr_seq_fila_w				intpd_fila_transmissao.nr_sequencia%type;
reg_integracao_w				gerar_int_padrao.reg_integracao;
nr_seq_agrupamento_w			number(10);
nm_usuario_w				varchar(15)	:=	'ISH-HCM';
job_w					job_v.job%type;
ie_agendado_w				varchar2(1);
intpd_fila_w				gerar_int_padrao.t_intpd_fila;
i					integer;
sapevent_w				hcm_kopf.sapevent%type;
qt_reg_w					number(5);
qt_reg_proc_w				number(5);

cursor c01 is
select	ds_arquivo
from    hcm_message
where   ie_status = 'P'
and     ds_arquivo is not null
group by ds_arquivo;

cursor c02 (p_ds_arquivo varchar2) is
select	nr_sequencia,
        ds_arquivo,
        ds_conteudo
from    hcm_message
where   ie_status   = 'P'
and     ds_arquivo  = p_ds_arquivo
order by nr_sequencia;

cursor c03 is
select 	a.*,
	decode(ie_evento,'81',1,'365',1,'PMR',1,
			'104',2,'117',2,
			'108',3,'130',3,'185',3,
			'131',4,			
			'84',5,'253',5,
			'105',6,'110',6,
			'119',7) ie_ordem
from 	hcm_fila_transmissao  a
order by patientno, 
	caseno nulls first,
	ie_ordem,
	nr_sequencia;
			
c03_w	c03%rowtype;

cursor c04 is
select	min(nr_sequencia) nr_seq_fila,
	nr_seq_agrupador,
	ie_evento,
	ds_action,
	caseno,
	movenumber,
	patientno	
from (	select	a.nr_sequencia,  
		nr_seq_agrupador,
		a.ie_evento,
		b.ds_action,
		(select	max(x.caseno)
		from	hcm_fall x
		where	x.nr_sequencia = somente_numero(decode(a.ie_evento, '81', '0', '365', '0', a.nr_seq_documento))) caseno,
		(select	max(x.movenumber)
		from	hcm_fall x
		where	x.nr_sequencia = somente_numero(decode(a.ie_evento, '81', '0', '365', '0', a.nr_seq_documento))) movenumber,
		(select	max(x.patientno)
		from	hcm_patienten x
		where	x.nr_sequencia = somente_numero(decode(a.ie_evento, '81', a.nr_seq_documento, '365', a.nr_seq_documento))) patientno		
	from	intpd_fila_transmissao a,
		intpd_eventos_sistema b
	where	a.nr_seq_evento_sistema = b.nr_sequencia
	and	substr(obter_se_integracao_ish(b.nr_seq_projeto_xml),1,1) = 'S'
	and	a.ie_envio_recebe = 'C'
	and	a.ie_status not in ('S','R'))
having	count(1) > 1
group by	nr_seq_agrupador,
	ie_evento,
	ds_action,
	caseno,
	movenumber,
	patientno;

c04_w	c04%rowtype;

	


CREATE OR REPLACE PROCEDURE agendar_mensagem_fila (ie_evento_p text, ie_operacao_p text, nr_seq_documento_p text, caseno_p text, patientno_p text, movenumber_p text default null) AS $body$
DECLARE


	nr_sequencia_w	hcm_fila_transmissao.nr_sequencia%type;
	
BEGIN

	begin
	select	nr_sequencia
	into STRICT	nr_sequencia_w
	from	hcm_fila_transmissao
	where	ie_evento	= ie_evento_p
	and	ie_operacao	= ie_operacao_p
	and (caseno		= caseno_p or coalesce(caseno_p::text, '') = '')
	and (patientno	= patientno_p or coalesce(patientno_p::text, '') = '')
	and (movenumber	= movenumber_p or coalesce(movenumber_p::text, '') = '')  LIMIT 1;
	exception
	when others then
		nr_sequencia_w	:= null;
	end;
	
	if (coalesce(nr_sequencia_w::text, '') = '') then
		insert into hcm_fila_transmissao(nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,ie_evento,ie_operacao,caseno,patientno,nr_seq_documento, movenumber)
		values (nextval('hcm_fila_transmissao_seq'), clock_timestamp(), nm_usuario_w, clock_timestamp(), nm_usuario_w, ie_evento_p, ie_operacao_p, caseno_p, patientno_p, nr_seq_documento_p, movenumber_p);		
	end if;

	end;

begin

CALL wheb_usuario_pck.set_nm_usuario(nm_usuario_w);
delete	FROM hcm_fila_transmissao;
commit;

qt_reg_proc_w	:=	0;

for c01_w in c01 loop
	begin
		
	for c02_w in c02(c01_w.ds_arquivo) loop
		begin
		qt_reg_proc_w	:=	qt_reg_proc_w + 1;
		
		ds_conteudo_w	:=	c02_w.ds_conteudo;

		if (length(ds_segmento_ant_w) > 0) then
			ds_conteudo_w	:=	substr(ds_segmento_ant_w || ds_conteudo_w,1,32000);
		end if;

		loop
			begin
			ie_tipo_w	:=	substr(ds_conteudo_w,1,3);

			if (ie_tipo_w = 'HEA') then
				qt_tamanho_w	:=	97;
			elsif (ie_tipo_w = 'PAT') then
				qt_tamanho_w	:=	743;
			elsif (ie_tipo_w = 'FAL') then
				qt_tamanho_w	:=	2900;
			elsif (ie_tipo_w = 'ANG') then
				qt_tamanho_w	:=	134;
			elsif (ie_tipo_w = 'FKL') then
				qt_tamanho_w	:=	133;
			elsif (ie_tipo_w = 'VVF') then
				qt_tamanho_w	:=	1058;
			elsif (ie_tipo_w = 'PMR') then
				qt_tamanho_w	:=	17;
			elsif (ie_tipo_w = 'END') then
				begin

				select	nextval('hcm_registro_seq')
				into STRICT	nr_seq_registro_w
				;

				ds_segmento_ant_w	:=	null;
				exit;
				end;
			else
				exit;
			end if;

			ds_segmento_w	:=	substr(ds_conteudo_w, 1, qt_tamanho_w);
			ds_conteudo_w	:=	substr(ds_conteudo_w, qt_tamanho_w + 1, 32000);

			if (length(ds_segmento_w) <> qt_tamanho_w) then
				ds_segmento_ant_w	:=	ds_segmento_w;
			else
				begin

				ie_agendado_w := 'N';

				if (coalesce(nr_seq_registro_w::text, '') = '') then
					select	nextval('hcm_registro_seq')
					into STRICT	nr_seq_registro_w
					;					
				end if;

				select	nextval('hcm_segmento_seq')
				into STRICT	nr_seq_segmento_w
				;

				nr_seq_mensagem_w :=  c02_w.nr_sequencia;

				insert into hcm_segmento(
					nr_sequencia,
					nr_seq_mensagem,
					nr_seq_registro,
					ie_tipo,
					ds_segmento,
					dt_atualizacao,
					nm_usuario)
				values (	nr_seq_segmento_w,
					nr_seq_mensagem_w,
					nr_seq_registro_w,
					ie_tipo_w,
					ds_segmento_w,
					clock_timestamp(),
					nm_usuario_w);

				ds_segmento_ant_w		        :=	null;
				reg_integracao_w.ie_operacao	:=	'I';
				reg_integracao_w.caseno		:=	null;
				reg_integracao_w.patientno	:=	null;

				if (ie_tipo_w = 'HEA') then
					begin
					hcm_kopf_w := ish_processar_hea(ds_segmento_w, hcm_kopf_w);

					select	nextval('hcm_kopf_seq')
					into STRICT	hcm_kopf_w.nr_sequencia
					;

					hcm_kopf_w.dt_atualizacao	:=	clock_timestamp();
					hcm_kopf_w.nm_usuario		:=	nm_usuario_w;
					hcm_kopf_w.nr_seq_segmento	:=	nr_seq_segmento_w;

					insert into hcm_kopf values (hcm_kopf_w.*);
					end;
				elsif (ie_tipo_w = 'PAT') then
					begin
					hcm_patienten_w := ish_processar_pat(ds_segmento_w, hcm_patienten_w);

					select	nextval('hcm_patienten_seq')
					into STRICT	hcm_patienten_w.nr_sequencia
					;

					hcm_patienten_w.dt_atualizacao	:=	clock_timestamp();
					hcm_patienten_w.nm_usuario	:=	nm_usuario_w;
					hcm_patienten_w.nr_seq_segmento	:=	nr_seq_segmento_w;

					insert into hcm_patienten values (hcm_patienten_w.*);
										
					--consultar pessoa fisica
					--gerar_int_padrao.gravar_integracao('81', hcm_patienten_w.nr_sequencia, nm_usuario_w, reg_integracao_w);
					CALL agendar_mensagem_fila('81', 'I', hcm_patienten_w.nr_sequencia, null, hcm_patienten_w.patientno);
					CALL agendar_mensagem_fila('365', 'I', hcm_patienten_w.nr_sequencia, null, hcm_patienten_w.patientno);
					
					if (substr(hcm_kopf_w.sapevent,1,6) in ('NP0600')) then
						CALL agendar_mensagem_fila('PMR', 'I', hcm_patienten_w.nr_sequencia, null, hcm_patienten_w.patientno);
					end if;
					end;
				elsif (ie_tipo_w = 'FAL') then
					begin
					hcm_fall_w := ish_processar_fal(ds_segmento_w, hcm_fall_w);

					select	nextval('hcm_fall_seq')
					into STRICT	hcm_fall_w.nr_sequencia
					;

					hcm_fall_w.dt_atualizacao		:=	clock_timestamp();
					hcm_fall_w.nm_usuario		    :=	nm_usuario_w;
					hcm_fall_w.nr_seq_segmento      :=	nr_seq_segmento_w;

					insert into hcm_fall values (hcm_fall_w.*);
					
					/*NA3009 (set billing flag) - OS 1967002*/

					if (substr(hcm_kopf_w.sapevent,1,6) in ('NA3009')) then
						CALL ish_close_reopen_case(hcm_fall_w.caseno, 'C');
					/*NA3006 (revoke billing flag) - OS 1967002*/

					elsif (substr(hcm_kopf_w.sapevent,1,6) in ('NA3009')) then
						CALL ish_close_reopen_case(hcm_fall_w.caseno, 'R');
					elsif (substr(hcm_kopf_w.sapevent,1,4) in ('NP32')) then
						begin

						reg_integracao_w.ie_operacao	:=	'T';

						--consultar episodio do paciente
						--gerar_int_padrao.gravar_integracao('104',  hcm_fall_w.nr_sequencia, nm_usuario_w, reg_integracao_w);
						CALL agendar_mensagem_fila('104', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );
						CALL agendar_mensagem_fila('362', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );
						end;

					elsif (substr(hcm_kopf_w.sapevent,1,4) in ('NP11','NP12','NV04','NV07','NV05','NV08')) then
						begin
						if	((hcm_kopf_w.sapevent like 'NP11%') or (substr(hcm_kopf_w.sapevent,1,4) in ('NV04','NV07'))) then
							reg_integracao_w.ie_operacao	:=	'I';
						elsif (hcm_kopf_w.sapevent like 'NP12%S') then
							reg_integracao_w.ie_operacao	:=	'E';
						elsif	((hcm_kopf_w.sapevent like 'NP12') or (substr(hcm_kopf_w.sapevent,1,4) in ('NV05','NV08'))) then
							reg_integracao_w.ie_operacao	:=	'A';
						end if;

						--consultar episodio do paciente
						--gerar_int_padrao.gravar_integracao('104',  hcm_fall_w.nr_sequencia, nm_usuario_w, reg_integracao_w);
						CALL agendar_mensagem_fila('104', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );
						CALL agendar_mensagem_fila('362', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );
						
						if	((substr(hcm_kopf_w.sapevent,1,4) like 'NP12') and (hcm_kopf_w.sapevent not like 'NP12%S')) then
							--consultar acompanhante paciente
							--gerar_int_padrao.gravar_integracao('253',  hcm_fall_w.nr_sequencia, nm_usuario_w, reg_integracao_w);
							CALL agendar_mensagem_fila('253', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );
						end if;
						
						-- consultar diagnosticos
						--gerar_int_padrao.gravar_integracao('84',  hcm_fall_w.nr_sequencia, nm_usuario_w, reg_integracao_w);
						--agendar_mensagem_fila('84', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );
						
						--consultar movimentacoes do episodio do paciente
						--gerar_int_padrao.gravar_integracao('108',  hcm_fall_w.nr_sequencia, nm_usuario_w, reg_integracao_w);
						--agendar_mensagem_fila('108', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );
						
						--consultar procedimentos executados
						--gerar_int_padrao.gravar_integracao('105',  hcm_fall_w.nr_sequencia, nm_usuario_w, reg_integracao_w);
						--agendar_mensagem_fila('105', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );
						end;

					elsif (substr(hcm_kopf_w.sapevent,1,4) = 'NP61') then -- consultar diagnosticos
						begin
						--gerar_int_padrao.gravar_integracao('84',  hcm_fall_w.nr_sequencia, nm_usuario_w, reg_integracao_w);
						CALL agendar_mensagem_fila('84', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );	
						end;
					elsif (substr(hcm_kopf_w.sapevent,1,4) in ('NWFA')) then
						--gerar_int_padrao.gravar_integracao('104',  hcm_fall_w.nr_sequencia, nm_usuario_w, reg_integracao_w); --consultar episodio do paciente
						CALL agendar_mensagem_fila('104', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );	
						--gerar_int_padrao.gravar_integracao('84',  hcm_fall_w.nr_sequencia, nm_usuario_w, reg_integracao_w); -- consultar diagnosticos
						CALL agendar_mensagem_fila('84', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );	
						--gerar_int_padrao.gravar_integracao('108',  hcm_fall_w.nr_sequencia, nm_usuario_w, reg_integracao_w); --consultar movimentacoes do episodio do paciente
						CALL agendar_mensagem_fila('108', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );	
						--gerar_int_padrao.gravar_integracao('105',  hcm_fall_w.nr_sequencia, nm_usuario_w, reg_integracao_w); --consultar procedimentos executados
						CALL agendar_mensagem_fila('105', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );	
						--gerar_int_padrao.gravar_integracao('110',  hcm_fall_w.nr_sequencia, nm_usuario_w, reg_integracao_w); --consultar servicos executados
						CALL agendar_mensagem_fila('110', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );		
						CALL agendar_mensagem_fila('362', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );						
					elsif (substr(hcm_kopf_w.sapevent,1,4) in ('NWFS')) then
						--gerar_int_padrao.gravar_integracao('117',  hcm_fall_w.nr_sequencia, nm_usuario_w, reg_integracao_w); --consultar case outpatient						
						CALL agendar_mensagem_fila('117', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );	
						--gerar_int_padrao.gravar_integracao('108',  hcm_fall_w.nr_sequencia, nm_usuario_w, reg_integracao_w); --consultar movimentacoes do episodio do paciente
						CALL agendar_mensagem_fila('108', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );	
						CALL agendar_mensagem_fila('362', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );
						
					elsif (substr(hcm_kopf_w.sapevent,1,4) in ('NV11','NV12')) then						
						--gerar_int_padrao.gravar_integracao('104',  hcm_fall_w.nr_sequencia, nm_usuario_w, reg_integracao_w); --consultar episodio do paciente
						--agendar_mensagem_fila('104', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );	
						--gerar_int_padrao.gravar_integracao('130',  hcm_fall_w.nr_sequencia, nm_usuario_w, reg_integracao_w); --consultar movimentacoes do paciente
						CALL agendar_mensagem_fila('130', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno, hcm_fall_w.movenumber);	
						--gerar_int_padrao.gravar_integracao('105',  hcm_fall_w.nr_sequencia, nm_usuario_w, reg_integracao_w); --consultar procedimentos executados
						--agendar_mensagem_fila('105', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );	
						
					elsif (substr(hcm_kopf_w.sapevent,1,4) in ('NP41','NP42','NV44','NV47','NV45','NV48','NP38')) then
					
						if (hcm_kopf_w.sapevent like 'NP42%S') or
							(hcm_kopf_w.sapevent like 'NP38%S') then --Se cancelamento do outpatient, entao agenda o '104' para verificar se o case foi cancelado no ISH.
							reg_integracao_w.ie_operacao	:= 'E';
							CALL agendar_mensagem_fila('104', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );
						end if;					
						--gerar_int_padrao.gravar_integracao('117',  hcm_fall_w.nr_sequencia, nm_usuario_w, reg_integracao_w); --consultar case outpatient
						CALL agendar_mensagem_fila('117', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno, hcm_fall_w.movenumber );	
						--gerar_int_padrao.gravar_integracao('108',  hcm_fall_w.nr_sequencia, nm_usuario_w, reg_integracao_w); --consultar movimentacoes do episodio do paciente
						--agendar_mensagem_fila('108', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );							
						CALL agendar_mensagem_fila('362', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );
					elsif (substr(hcm_kopf_w.sapevent,1,4) in ('NP37')) then
						--gerar_int_padrao.gravar_integracao('117',  hcm_fall_w.nr_sequencia, nm_usuario_w, reg_integracao_w); --consultar case outpatient
						CALL agendar_mensagem_fila('117', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );	
						CALL agendar_mensagem_fila('362', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );
					elsif (substr(hcm_kopf_w.sapevent,1,4) in ('NP97','NP98','NP98')) then
						--gerar_int_padrao.gravar_integracao('119',  hcm_fall_w.nr_sequencia, nm_usuario_w, reg_integracao_w); --consultar alta paciente
						
						if (hcm_kopf_w.sapevent like 'NP98%S') then
							reg_integracao_w.ie_operacao	:= 'E';
						end if;
						
						CALL agendar_mensagem_fila('119', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );	
					elsif (substr(hcm_kopf_w.sapevent,1,4) = 'PROC') then
						--gerar_int_padrao.gravar_integracao('105',  hcm_fall_w.nr_sequencia, nm_usuario_w, reg_integracao_w); --consultar procedimentos executados						
						CALL agendar_mensagem_fila('105', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno );	
					elsif (substr(hcm_kopf_w.sapevent,1,4) in ('NP91', 'NP92')) then
						--gerar_int_padrao.gravar_integracao('185',  hcm_fall_w.nr_sequencia, nm_usuario_w, reg_integracao_w); --Consultar saida temporaria do setor
						CALL agendar_mensagem_fila('185', reg_integracao_w.ie_operacao, hcm_fall_w.nr_sequencia, hcm_fall_w.caseno, hcm_fall_w.casepatno);	
					end if;
					end;
				elsif (ie_tipo_w = 'ANG') then
					begin
					hcm_angehorigen_w := ish_processar_ang(ds_segmento_w, hcm_angehorigen_w);

					select	nextval('hcm_angehorigen_seq')
					into STRICT	hcm_angehorigen_w.nr_sequencia
					;

					hcm_angehorigen_w.dt_atualizacao	:=	clock_timestamp();
					hcm_angehorigen_w.nm_usuario	:=	nm_usuario_w;
					hcm_angehorigen_w.nr_seq_segmento	:=	nr_seq_segmento_w;

					insert into hcm_angehorigen values (hcm_angehorigen_w.*);
					end;
				elsif (ie_tipo_w = 'FKL') then
					begin
					hcm_fallklassifikations_w := ish_processar_fkl(ds_segmento_w, hcm_fallklassifikations_w);

					select	nextval('hcm_fallklassifikations_seq')
					into STRICT	hcm_fallklassifikations_w.nr_sequencia
					;

					hcm_fallklassifikations_w.dt_atualizacao	:=	clock_timestamp();
					hcm_fallklassifikations_w.nm_usuario		:=	nm_usuario_w;
					hcm_fallklassifikations_w.nr_seq_segmento	:=	nr_seq_segmento_w;

					insert into hcm_fallklassifikations values (hcm_fallklassifikations_w.*);
					end;
				elsif (ie_tipo_w = 'VVF') then
					begin

					hcm_versicherungsverhaltni_w := ish_processar_vvf(ds_segmento_w, hcm_versicherungsverhaltni_w);

					select	nextval('hcm_versicherungsverhaltni_seq')
					into STRICT	hcm_versicherungsverhaltni_w.nr_sequencia
					;

					hcm_versicherungsverhaltni_w.dt_atualizacao	:=	clock_timestamp();
					hcm_versicherungsverhaltni_w.nm_usuario	        :=	nm_usuario_w;
					hcm_versicherungsverhaltni_w.nr_seq_segmento	:=	nr_seq_segmento_w;

					insert into hcm_versicherungsverhaltni values (hcm_versicherungsverhaltni_w.*);

					if (substr(hcm_kopf_w.sapevent,1,4) in ('NV33')) then

						--consultar episodio do paciente
						--gerar_int_padrao.gravar_integracao('104',  hcm_versicherungsverhaltni_w.nr_sequencia, nm_usuario_w, reg_integracao_w);
						--agendar_mensagem_fila('104', reg_integracao_w.ie_operacao, hcm_versicherungsverhaltni_w.nr_sequencia, hcm_versicherungsverhaltni_w.caseno, hcm_versicherungsverhaltni_w.patientno );	
						
						--consultar dados do convenio do atendimento do paciente
						--gerar_int_padrao.gravar_integracao('131',  hcm_versicherungsverhaltni_w.nr_sequencia, nm_usuario_w, reg_integracao_w);						
						CALL agendar_mensagem_fila('131', reg_integracao_w.ie_operacao, hcm_versicherungsverhaltni_w.nr_sequencia, hcm_versicherungsverhaltni_w.caseno, hcm_versicherungsverhaltni_w.patientno );							
					end if;
					end;
				elsif (ie_tipo_w = 'PMR') then
					begin
					hcm_pat_zusammenfuhrung_w := ish_processar_pmr(ds_segmento_w, hcm_pat_zusammenfuhrung_w);

					select	nextval('hcm_pat_zusammenfuhrung_seq')
					into STRICT	hcm_pat_zusammenfuhrung_w.nr_sequencia
					;

					hcm_pat_zusammenfuhrung_w.dt_atualizacao	:=	clock_timestamp();
					hcm_pat_zusammenfuhrung_w.nm_usuario	    	:=	nm_usuario_w;
					hcm_pat_zusammenfuhrung_w.nr_seq_segmento	:=	nr_seq_segmento_w;

					insert into hcm_pat_zusammenfuhrung values (hcm_pat_zusammenfuhrung_w.*);
					end;
				end if;
				end;
			end if;
			end;
		end loop;
		
		update	hcm_message
		set	ie_status 	= 'S'
		where	ds_arquivo 	= c01_w.ds_arquivo
		and	nr_sequencia	= c02_w.nr_sequencia;
		
		end;
	end loop;	
	
	open c03;
	loop
	fetch c03 into
		c03_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		begin	
		reg_integracao_w.caseno		:=	c03_w.caseno;
		reg_integracao_w.patientno	:=	c03_w.patientno;
		reg_integracao_w.ie_operacao	:=	c03_w.ie_operacao;
		
		sapevent_w	:=	null;
		
		if (somente_numero(c03_w.patientno) > 0) then
			sapevent_w	:=	ish_get_event_hcm(c03_w.nr_seq_documento, null);
		elsif (somente_numero(c03_w.caseno) > 0) then
			sapevent_w	:=	ish_get_event_hcm(null, c03_w.nr_seq_documento);
		end if;
		
		if (c03_w.ie_evento = 'PMR') then
			reg_integracao_w := gerar_int_padrao.gravar_integracao('81', c03_w.nr_seq_documento, nm_usuario_w, reg_integracao_w);
		else
			reg_integracao_w := gerar_int_padrao.gravar_integracao(c03_w.ie_evento, c03_w.nr_seq_documento, nm_usuario_w, reg_integracao_w);
		end if;
		
		intpd_fila_w	:=	gerar_int_padrao.get_intpd_fila;
		
		for i in 0..intpd_fila_w.count-1 loop
			begin
			select	nr_seq_agrupador
			into STRICT	nr_seq_agrupamento_w
			from	intpd_fila_transmissao
			where	nr_sequencia = intpd_fila_w[i].nr_sequencia;
			
			if (sapevent_w like 'NP12%S') then
				begin
				select	count(1)
				into STRICT	qt_reg_w
				from	intpd_fila_transmissao a			
				where	a.nr_seq_agrupador = nr_seq_agrupamento_w
				and	a.ie_evento not in ('12','81')
				and	a.ie_status in ('R', 'S');
				
				if (qt_reg_w = 0) then
					update	intpd_fila_transmissao a			
					set	ie_status = 'S',
						nr_seq_dependencia = intpd_fila_w[i].nr_sequencia
					where	a.nr_seq_agrupador = nr_seq_agrupamento_w
					and	a.ie_evento not in ('12','81')
					and	a.ie_status not in ('R', 'S');
				end if;
				end;
			elsif (sapevent_w like 'NP020S') then
				select	count(1)
				into STRICT	qt_reg_w
				from	intpd_fila_transmissao a			
				where	a.nr_seq_agrupador = nr_seq_agrupamento_w				
				and	a.ie_status in ('R', 'S');
				
				if (qt_reg_w = 0) then
					update	intpd_fila_transmissao a			
					set	ie_status = 'S',
						nr_seq_dependencia = intpd_fila_w[i].nr_sequencia
					where	a.nr_seq_agrupador = nr_seq_agrupamento_w					
					and	a.ie_status not in ('R', 'S');
				end if;
			end if;
			end;
		end loop;		
		end;
	end loop;
	close c03;
		
	delete	FROM hcm_fila_transmissao;
	commit;
	
	if (qt_reg_proc_w > 400) then
		exit;
	end if;
	exception
	when others then
		rollback;
	end;
end loop;

open c04;
loop
fetch c04 into	
	c04_w;
EXIT WHEN NOT FOUND; /* apply on c04 */
	begin
	select	max(a.ie_status)
	into STRICT	ie_status_w
	from	intpd_fila_transmissao a
	where	a.nr_sequencia = c04_w.nr_seq_fila;
	
	if (ie_status_w = 'E') then
		update	intpd_fila_transmissao a
		set	ie_status = 'P'
		where	a.nr_sequencia = c04_w.nr_seq_fila;
	end if;
	
	if (c04_w.ie_evento in ('81', '365')) then
		update	intpd_fila_transmissao a
		set	a.ie_status = 'S',
			a.nr_seq_dependencia = c04_w.nr_seq_fila
		where	a.nr_seq_agrupador = c04_w.nr_seq_agrupador
		and	a.ie_evento =   c04_w.ie_evento
		and	a.ie_status not in ('S','R')
		and	a.nr_sequencia > c04_w.nr_seq_fila
		and	'NP0600' <> coalesce(ish_get_sapevent(a.nr_seq_documento),'NULL');
	else
		update	intpd_fila_transmissao a
		set	a.ie_status = 'S',
			a.nr_seq_dependencia = c04_w.nr_seq_fila
		where	a.nr_seq_agrupador = c04_w.nr_seq_agrupador
		and	a.ie_evento =   c04_w.ie_evento
		and	a.ie_status not in ('S','R')
		and	a.nr_sequencia > c04_w.nr_seq_fila
		and	exists (	SELECT	1
				from	hcm_fall x
				where	x.nr_sequencia = somente_numero(a.nr_seq_documento)
				and	x.caseno = c04_w.caseno
				and	coalesce(x.movenumber,'X') = coalesce(c04_w.movenumber,'X'));
	end if;
	
	commit;
	end;
end loop;
close c04;

commit;

end;
$body$
LANGUAGE PLPGSQL
;
-- REVOKE ALL ON PROCEDURE agendar_mensagem_fila (ie_evento_p text, ie_operacao_p text, nr_seq_documento_p text, caseno_p text, patientno_p text, movenumber_p text default null) FROM PUBLIC;

