-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_atualiza_equip_alta ( nr_atendimento_p bigint, nr_seq_equipamento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
qt_existe_w		bigint;
cd_pessoa_fisica_w	varchar(10);
ds_historico_w		varchar(4000);
nm_pessoa_fisica_w	varchar(60);
nr_seq_tipo_w		bigint;
nr_seq_pac_reab_w	bigint;


BEGIN 
if (nr_atendimento_p > 0) and (nr_seq_equipamento_p > 0) then 
	begin 
	select	count(*) 
	into STRICT	qt_existe_w 
	from	man_equipamento 
	where	nr_sequencia = nr_seq_equipamento_p;
	 
	if (qt_existe_w > 0) then 
		select	cd_pessoa_fisica, 
			substr(obter_nome_pf(cd_pessoa_fisica),1,60) 
		into STRICT	cd_pessoa_fisica_w, 
			nm_pessoa_fisica_w 
		from	atendimento_paciente 
		where	nr_atendimento = nr_atendimento_p;
	 
		update	man_equipamento 
		set	ie_propriedade 		= 'T',	--dom 1632, 
			cd_pessoa_terceiro		= cd_pessoa_fisica_w, 
			nm_usuario		= nm_usuario_p, 
			dt_atualizacao		= clock_timestamp() 
		where	nr_sequencia		= nr_seq_equipamento_p;
		 
		ds_historico_w := substr(	wheb_mensagem_pck.get_texto(307420) || ': ' || nr_atendimento_p || chr(13) || chr(10) || 
					wheb_mensagem_pck.get_texto(791350) || ': ' || nm_pessoa_fisica_w || chr(13) || chr(10) || 
					wheb_mensagem_pck.get_texto(793494) || ': ' || to_char(clock_timestamp(),pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(wheb_usuario_pck.get_cd_estabelecimento, nm_usuario_p))),1,4000);
		 
		select	man_obter_tipo_hist_equip_evt('A') 
		into STRICT	nr_seq_tipo_w 
		;
		 
		insert into man_equipamento_hist( 
				nr_sequencia, 
				nr_seq_equipamento, 
				dt_historico, 
				dt_atualizacao, 
				nm_usuario, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				ds_historico, 
				ie_origem, 
				nr_seq_tipo) 
			values (	nextval('man_equipamento_hist_seq'), 
				nr_seq_equipamento_p, 
				clock_timestamp(), 
				clock_timestamp(), 
				nm_usuario_p, 
				clock_timestamp(), 
				nm_usuario_p, 
				ds_historico_w, 
				'S', 
				nr_seq_tipo_w);
				 
		-- busca paciente reabilitação 
		select 	nr_sequencia 
		into STRICT	nr_seq_pac_reab_w 
		from	rp_paciente_reabilitacao 
		where	cd_pessoa_fisica = cd_pessoa_fisica_w;
		 
		if (nr_seq_pac_reab_w > 0) then 
						 
			insert into rp_equipamento( 
					nr_sequencia, 
					nr_seq_pac_reab, 
					nr_seq_equipamento, 
					dt_inicio_utilizacao, 
					dt_atualizacao, 
					nm_usuario, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec 
				) values ( 
					nextval('rp_equipamento_seq'), 
					nr_seq_pac_reab_w, 
					nr_seq_equipamento_p, 
					clock_timestamp(), 
					clock_timestamp(), 
					nm_usuario_p, 
					clock_timestamp(), 
					nm_usuario_p 
				);
		end if;
				 
		commit;
	end if;
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_atualiza_equip_alta ( nr_atendimento_p bigint, nr_seq_equipamento_p bigint, nm_usuario_p text) FROM PUBLIC;

