-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_estrutura_interna ( nm_usuario_p text, cd_material_p bigint, nr_seq_estrutura_p bigint, dt_vigencia_p timestamp default clock_timestamp(), nr_sequencia_p bigint default null, ie_tipo_brasindice_p text default null) AS $body$
DECLARE


qt_cadastro_w			bigint;
ie_atualiza_brasindice_w	varchar(1);
nr_seq_mat_estrutura_w		bigint;
dt_inicio_vigencia_w		timestamp;
ie_tipo_brasindice_w		varchar(1);


BEGIN

dt_inicio_vigencia_w:= coalesce(dt_vigencia_p, clock_timestamp());
ie_tipo_brasindice_w:= coalesce(ie_tipo_brasindice_p,'R');

select	count(*)
into STRICT	qt_cadastro_w
from	mat_estrutura_cadastro
where	cd_material		= cd_material_p
and	nr_seq_estrutura	= nr_seq_estrutura_p;

if (qt_cadastro_w = 0) then

	select 	nextval('mat_estrutura_cadastro_seq')
	into STRICT	nr_seq_mat_estrutura_w
	;

	insert into mat_estrutura_cadastro(
		cd_material,
		dt_atualizacao,
		dt_atualizacao_nrec,
		nm_usuario,
		nm_usuario_nrec,
		nr_seq_estrutura,
		nr_sequencia)
	values (
		cd_material_p,
		clock_timestamp(),
		clock_timestamp(),
		nm_usuario_p,
		nm_usuario_p,
		nr_seq_estrutura_p,
		nr_seq_mat_estrutura_w);

	select 	coalesce(max(ie_atualiza_brasindice),'N')
	into STRICT	ie_atualiza_brasindice_w
	from 	MAT_ESTRUTURA
	where	ie_situacao = 'A'
	and 	nr_sequencia = nr_seq_estrutura_p;

	if (ie_atualiza_brasindice_w = 'S') then
		insert into mat_estrutura_cad_vig(
				NR_SEQUENCIA, NR_SEQ_MAT_ESTRUTURA, DT_ATUALIZACAO, NM_USUARIO, DT_ATUALIZACAO_NREC, NM_USUARIO_NREC, DT_INICIO_VIGENCIA,
				DT_FINAL_VIGENCIA, NR_SEQ_BRASINDICE, IE_TIPO_BRASINDICE)
			values (nextval('mat_estrutura_cad_vig_seq'), nr_seq_mat_estrutura_w , clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p, dt_inicio_vigencia_w,
				null, nr_sequencia_p, ie_tipo_brasindice_w);
	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_estrutura_interna ( nm_usuario_p text, cd_material_p bigint, nr_seq_estrutura_p bigint, dt_vigencia_p timestamp default clock_timestamp(), nr_sequencia_p bigint default null, ie_tipo_brasindice_p text default null) FROM PUBLIC;

