-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE html_create_rule_crud_param ( nr_seq_lote_p bigint, nr_seq_regra_acao_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
vl_parametro_de_w			html_param_to_rule.vl_parametro%type;
nr_seq_parametro_w			html_param_to_rule.nr_seq_parametro%type;
cd_funcao_w					html_param_to_rule.cd_funcao%type;

nr_seq_rule_w				html_param_to_rule.nr_sequencia%type;	
ie_insert_w					html_param_to_rule_action.si_insert%type;
ie_update_w					html_param_to_rule_action.si_update%type;
ie_delete_w					html_param_to_rule_action.si_delete%type;
nr_seq_obj_schematic_w		html_param_to_rule_action.nr_seq_obj_schematic%type;
nm_tabela_w					objeto_schematic.nm_tabela%type;
	
vl_parametro_w				funcao_parametro.vl_parametro%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
cd_perfil_w					perfil.cd_perfil%type;
nm_usuario_param_w			usuario.nm_usuario%type;
ds_observacao_w				varchar(4000);
nr_seq_visao_w				objeto_schematic.nr_seq_visao%type;

c10 CURSOR FOR 
SELECT	cd_estabelecimento, 
		ds_observacao 
from	funcao_param_estab 
where	cd_funcao = cd_funcao_w 
and		nr_seq_param = nr_seq_parametro_w 
and		vl_parametro = vl_parametro_de_w;

c11 CURSOR FOR 
SELECT	cd_estabelecimento, 
		cd_perfil, 
		ds_observacao 
from	funcao_param_perfil 
where	cd_funcao = cd_funcao_w 
and		nr_sequencia = nr_seq_parametro_w 
and		vl_parametro = vl_parametro_de_w;

c12 CURSOR FOR 
SELECT	cd_estabelecimento, 
		nm_usuario_param, 
		ds_observacao 
from	funcao_param_usuario 
where	cd_funcao = cd_funcao_w 
and		nr_sequencia = nr_seq_parametro_w 
and		vl_parametro = vl_parametro_de_w;


BEGIN 
 
select	nr_seq_obj_schematic, 
		si_insert, 
		si_update, 
		si_delete, 
		nr_seq_rule 
into STRICT	nr_seq_obj_schematic_w, 
		ie_insert_w, 
		ie_update_w, 
		ie_delete_w, 
		nr_seq_rule_w 
from	html_param_to_rule_action 
where	nr_sequencia = nr_seq_regra_acao_p;
 
select	nm_tabela, 
	nr_seq_visao 
into STRICT	nm_tabela_w, 
	nr_seq_visao_w 
from	objeto_schematic 
where	nr_sequencia = nr_seq_obj_schematic_w;
 
select	cd_funcao, 
		nr_seq_parametro, 
		vl_parametro 
into STRICT	cd_funcao_w, 
		nr_seq_parametro_w, 
		vl_parametro_de_w 
from	html_param_to_rule 
where	nr_sequencia = nr_seq_rule_w;
 
select	vl_parametro 
into STRICT	vl_parametro_w 
from	funcao_parametro 
where	cd_funcao = cd_funcao_w 
and		nr_sequencia = nr_seq_parametro_w;
 
/* INSERIR REGRA GERAL */
 
if (vl_parametro_w = vl_parametro_de_w) then 
	CALL INSERT_RULE_CRUD_PARAM( 
					nr_seq_lote_p, 
					cd_funcao_w, 
					nr_seq_parametro_w, 
					vl_parametro_de_w, 
					null, 
					null, 
					null, 
					nr_seq_obj_schematic_w, 
					nm_tabela_w, 
					nr_seq_visao_w, 
					ie_insert_w, 
					ie_update_w, 
					ie_delete_w, 
					null, 
					nm_usuario_p);						
end if;
 
open c10;
loop 
fetch c10 into 
		cd_estabelecimento_w, 
		ds_observacao_w;
EXIT WHEN NOT FOUND; /* apply on c10 */
		begin 
		CALL INSERT_RULE_CRUD_PARAM( 
					nr_seq_lote_p, 
					cd_funcao_w, 
					nr_seq_parametro_w, 
					vl_parametro_de_w, 
					cd_estabelecimento_w, 
					null, 
					null, 
					nr_seq_obj_schematic_w, 
					nm_tabela_w, 
					nr_seq_visao_w, 
					ie_insert_w, 
					ie_update_w, 
					ie_delete_w, 
					ds_observacao_w, 
					nm_usuario_p);
		end;
end loop;
close c10;
 
open c11;
loop 
fetch c11 into 
		cd_estabelecimento_w, 
		cd_perfil_w, 
		ds_observacao_w;
EXIT WHEN NOT FOUND; /* apply on c11 */
		begin 
		CALL INSERT_RULE_CRUD_PARAM( 
					nr_seq_lote_p, 
					cd_funcao_w, 
					nr_seq_parametro_w, 
					vl_parametro_de_w, 
					cd_estabelecimento_w, 
					cd_perfil_w, 
					null, 
					nr_seq_obj_schematic_w, 
					nm_tabela_w, 
					nr_seq_visao_w, 
					ie_insert_w, 
					ie_update_w, 
					ie_delete_w, 
					ds_observacao_w, 
					nm_usuario_p);
		end;
end loop;
close c11;
 
open c12;
loop 
fetch c12 into 
		cd_estabelecimento_w, 
		nm_usuario_param_w, 
		ds_observacao_w;
EXIT WHEN NOT FOUND; /* apply on c12 */
		begin 
		CALL INSERT_RULE_CRUD_PARAM( 
					nr_seq_lote_p, 
					cd_funcao_w, 
					nr_seq_parametro_w, 
					vl_parametro_de_w, 
					cd_estabelecimento_w, 
					null, 
					nm_usuario_param_w, 
					nr_seq_obj_schematic_w, 
					nm_tabela_w, 
					nr_seq_visao_w, 
					ie_insert_w, 
					ie_update_w, 
					ie_delete_w, 
					ds_observacao_w, 
					nm_usuario_p);
		end;
end loop;
close c12;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE html_create_rule_crud_param ( nr_seq_lote_p bigint, nr_seq_regra_acao_p bigint, nm_usuario_p text) FROM PUBLIC;

