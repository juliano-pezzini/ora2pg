-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_proced_conversao ( cd_procedimento_p procedimento.cd_procedimento%type, ie_origem_proced_p procedimento.ie_origem_proced%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_tipo_conversao_p bigint, nr_seq_congenere_p bigint, ie_tipo_conversao_scs_p bigint, ie_envio_receb_p pls_conversao_proc.ie_envio_receb%type, nr_seq_contrato_p bigint, nr_seq_intercambio_p bigint, nr_seq_ops_congenere_p bigint, cd_material_p text, ie_tipo_intercambio_p pls_conversao_proc.ie_tipo_intercambio%type, cd_proc_conversao_p INOUT pls_conversao_proc.cd_proc_conversao%type, ie_origem_conversao_p INOUT pls_conversao_proc.ie_origem_conversao%type, nr_seq_regra_p INOUT pls_conversao_proc.nr_sequencia%type, ie_somente_codigo_p INOUT pls_conversao_proc.ie_somente_codigo%type, dt_referencia_p timestamp, nr_seq_tipo_atendimento_p pls_conversao_proc.nr_seq_tipo_atendimento%type, nr_seq_grau_partic_p pls_proc_participante.nr_seq_grau_partic%type, nr_seq_prestador_partic_p pls_proc_participante.nr_seq_prestador%type, ie_pacote_int_p text default 'N', ie_priorizar_conv_pct_int_p pls_parametros.ie_priorizar_conv_pct_int%type default 'N') AS $body$
DECLARE


/*
	IE_TIPO_CONVERSAO_P
	1 - PTU A500
	2 - Importacao da conta
	3 - Requisao
	4 - PTU 700
	5 - Faturamento
	6 - Envio de lotes guias (XML)
	7 - A1200
	8- Digitacao de contas pelo portal
	9 - Complemento de contas
	10- Monitoramento ANS
*/


/*
	ie_tipo_conversao_scs_p
	1 - Conversao utilizada no envio do SCS
	2- Conversao utilizada no recebimento do SCS
	3 - Conversao utilizada no envio e recebimento do SCS
*/


/*
	ie_pacote_int_p - Conversao pacote PTU
*/
cd_proc_conversao_w	pls_conversao_proc.cd_proc_conversao%type;
ie_origem_conversao_w	pls_conversao_proc.ie_origem_conversao%type;
nr_seq_regra_w		pls_conversao_proc.nr_sequencia%type;
ie_origem_proced_w	pls_conversao_proc.ie_origem_proced%type;
cd_grupo_proc_w		pls_conversao_proc.cd_grupo_proc%type;
cd_especialidade_w	pls_conversao_proc.cd_especialidade%type;
cd_area_procedimento_w	pls_conversao_proc.cd_area_procedimento%type;
cd_proc_envio_w		pls_conversao_proc.cd_proc_envio%type;
ie_envio_receb_w	pls_conversao_proc.ie_envio_receb%type;
ie_somente_codigo_w	pls_conversao_proc.ie_somente_codigo%type:= null;
dt_referencia_w		timestamp;
ie_considera_regra_w	boolean;

C01 CURSOR(	ie_envio_receb_pc	pls_conversao_proc.ie_envio_receb%type,
		dt_referencia_pc	timestamp,
		cd_estabelecimento_pc	estabelecimento.cd_estabelecimento%type) FOR
	SELECT	cd_proc_conversao,
		ie_origem_conversao,
		nr_sequencia,
		ie_envio_receb,
		cd_proc_envio,
		ie_somente_codigo,
		ie_ptu,
		ie_importacao_conta,
		ie_requisicao,
		ie_ptu_a700,
		ie_faturamento,
		ie_envio_lote_guias,
		ie_ptu_a1200,
		ie_digitacao_portal,
		ie_complemento,
		ie_monitoramento_ans
	from	pls_conversao_proc
	where	dt_referencia_pc between dt_inicio_vigencia_ref and dt_fim_vigencia_ref
	and	ie_envio_receb = ie_envio_receb_pc
	and	cd_estabelecimento = cd_estabelecimento_pc
	and	ie_situacao = 'A'
	and	((coalesce(nr_seq_prestador::text, '') = '') or (nr_seq_prestador = nr_seq_prestador_p))
	and	((coalesce(nr_seq_congenere::text, '') = '') or (nr_seq_congenere = nr_seq_congenere_p))
	and	((coalesce(cd_procedimento::text, '') = '') or (cd_procedimento = cd_procedimento_p))
	--	Se a variavel da origem estiver nula a regra deve valer tambem.
	and	(((coalesce(ie_origem_proced::text, '') = '') or (coalesce(ie_origem_proced_w::text, '') = '')) or (ie_origem_proced	= ie_origem_proced_w))
	and	((coalesce(cd_grupo_proc::text, '') = '') or (cd_grupo_proc = cd_grupo_proc_w))
	and	((coalesce(cd_especialidade::text, '') = '') or (cd_especialidade = cd_especialidade_w))
	and	((coalesce(cd_area_procedimento::text, '') = '') or (cd_area_procedimento = cd_area_procedimento_w))
	and	((coalesce(nr_seq_contrato::text, '') = '') or (nr_seq_contrato =  nr_seq_contrato_p))
	and	((coalesce(nr_seq_intercambio::text, '') = '') or (nr_seq_intercambio = nr_seq_intercambio_p))
	and	((coalesce(cd_material_imp::text, '') = '') or (cd_material_imp = cd_material_P))
	and	((coalesce(nr_seq_ops_congenere::text, '') = '') or (nr_seq_ops_congenere = nr_seq_ops_congenere_p))
	and	((coalesce(ie_tipo_intercambio::text, '') = '') or (ie_tipo_intercambio = 'A') or (ie_tipo_intercambio	= ie_tipo_intercambio_p))
	and	((coalesce(nr_seq_tipo_atendimento::text, '') = '') or (nr_seq_tipo_atendimento = nr_seq_tipo_atendimento_p))
	and	((coalesce(nr_seq_grau_partic::text, '') = '') or (nr_seq_grau_partic = nr_seq_grau_partic_p))
	and	((coalesce(nr_seq_prestador_partic::text, '') = '') or (nr_seq_prestador_partic = nr_seq_prestador_partic_p))
	--validacao adicionada pois foi criado o filtro por grupo de contrato. Se existir informacao no filtro(nao for nulo), o mesmo ira verificar se o contrato ou o intercambio se encaixam no grupo).
	and 	((coalesce(ie_pacote_intercambio::text, '') = '') or ( ie_pacote_intercambio = 'N'))
	and	((coalesce(nr_seq_grupo_contrato::text, '') = '') or (	(SELECT	count(1)
							from	table(pls_grupos_pck.obter_contrato_grupo(nr_seq_grupo_contrato, nr_seq_contrato_p, nr_seq_intercambio_p))) > 0))
	order by 	coalesce(cd_area_procedimento,0) desc,
			coalesce(cd_especialidade,0) desc,
			coalesce(cd_grupo_proc,0) desc,
			coalesce(cd_procedimento,0) desc,
			coalesce(nr_seq_intercambio,0) desc,
			coalesce(nr_seq_contrato,0) desc,
			coalesce(nr_seq_ops_congenere,0) desc,
			coalesce(nr_seq_congenere,0) desc,
			coalesce(nr_seq_prestador,0) desc,
			coalesce(nr_seq_grupo_contrato, 0) desc,
			coalesce(cd_material_imp,'0') desc,
			coalesce(nr_seq_tipo_atendimento,0) desc,
			coalesce(nr_seq_grau_partic,0) desc,
			coalesce(nr_seq_prestador_partic,0) desc;	

C02 CURSOR(	ie_envio_receb_pc	pls_conversao_proc.ie_envio_receb%type,
		dt_referencia_pc	timestamp,
		cd_estabelecimento_pc	estabelecimento.cd_estabelecimento%type) FOR
	SELECT	cd_proc_conversao,
		ie_origem_conversao,
		nr_sequencia,
		ie_envio_receb,
		cd_proc_envio,
		ie_somente_codigo,
		ie_ptu,
		ie_importacao_conta,
		ie_requisicao,
		ie_ptu_a700,
		ie_faturamento,
		ie_envio_lote_guias,
		ie_ptu_a1200,
		ie_digitacao_portal,
		ie_complemento,
		ie_monitoramento_ans
	from	pls_conversao_proc
	where	dt_referencia_pc between dt_inicio_vigencia_ref and dt_fim_vigencia_ref
	and	ie_envio_receb = ie_envio_receb_pc
	and	cd_estabelecimento = cd_estabelecimento_pc
	and	ie_situacao = 'A'
	and	((coalesce(nr_seq_prestador::text, '') = '') or (nr_seq_prestador = nr_seq_prestador_p))
	and	((coalesce(nr_seq_congenere::text, '') = '') or (nr_seq_congenere = nr_seq_congenere_p))
	and	((coalesce(cd_procedimento::text, '') = '') or (cd_procedimento = cd_procedimento_p))
	and	(((coalesce(ie_origem_proced::text, '') = '') or (coalesce(ie_origem_proced_w::text, '') = '')) or (ie_origem_proced	= ie_origem_proced_w))
	and	((coalesce(cd_grupo_proc::text, '') = '') or (cd_grupo_proc = cd_grupo_proc_w))
	and	((coalesce(cd_especialidade::text, '') = '') or (cd_especialidade = cd_especialidade_w))
	and	((coalesce(cd_area_procedimento::text, '') = '') or (cd_area_procedimento = cd_area_procedimento_w))
	and	((coalesce(nr_seq_contrato::text, '') = '') or (nr_seq_contrato =  nr_seq_contrato_p))
	and	((coalesce(nr_seq_intercambio::text, '') = '') or (nr_seq_intercambio = nr_seq_intercambio_p))
	and	((coalesce(cd_material_imp::text, '') = '') or (cd_material_imp = cd_material_P))
	and	((coalesce(nr_seq_ops_congenere::text, '') = '') or (nr_seq_ops_congenere = nr_seq_ops_congenere_p))
	and	((coalesce(ie_tipo_intercambio::text, '') = '') or (ie_tipo_intercambio = 'A') or (ie_tipo_intercambio	= ie_tipo_intercambio_p))
	and	((coalesce(nr_seq_tipo_atendimento::text, '') = '') or (nr_seq_tipo_atendimento = nr_seq_tipo_atendimento_p))
	and	((coalesce(nr_seq_grau_partic::text, '') = '') or (nr_seq_grau_partic = nr_seq_grau_partic_p))
	and	((coalesce(nr_seq_prestador_partic::text, '') = '') or (nr_seq_prestador_partic = nr_seq_prestador_partic_p))
	and (ie_pacote_int_p = 'S') and ( ie_pacote_intercambio = 'S') --so processa regra de conv pacote intercambio quando parametro ie_pacote_int_p for  "S".
	and	((coalesce(nr_seq_grupo_contrato::text, '') = '') or (	(SELECT	count(1)
							from	table(pls_grupos_pck.obter_contrato_grupo(nr_seq_grupo_contrato, nr_seq_contrato_p, nr_seq_intercambio_p))) > 0))
	order by 	coalesce(cd_area_procedimento,0) desc,
			coalesce(cd_especialidade,0) desc,
			coalesce(cd_grupo_proc,0) desc,
			coalesce(cd_procedimento,0) desc,
			coalesce(nr_seq_intercambio,0) desc,
			coalesce(nr_seq_contrato,0) desc,
			coalesce(nr_seq_ops_congenere,0) desc,
			coalesce(nr_seq_congenere,0) desc,
			coalesce(nr_seq_prestador,0) desc,
			coalesce(nr_seq_grupo_contrato, 0) desc,
			coalesce(cd_material_imp,'0') desc,
			coalesce(nr_seq_tipo_atendimento,0) desc,
			coalesce(nr_seq_grau_partic,0) desc,
			coalesce(nr_seq_prestador_partic,0) desc;			

BEGIN
dt_referencia_w := coalesce(dt_referencia_p,clock_timestamp());

SELECT * FROM pls_obter_estrut_proc(	cd_procedimento_p, ie_origem_proced_p, cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, ie_origem_proced_w ) INTO STRICT cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, ie_origem_proced_w;

cd_proc_conversao_w := cd_procedimento_p;
ie_origem_conversao_w := ie_origem_proced_p;

for r_C01_w in C01(	coalesce(ie_envio_receb_p, 'R'),
			dt_referencia_w,
			cd_estabelecimento_p) loop

	-- sempre inicia dizendo que a regra nao e valida
	ie_considera_regra_w := false;

	case(ie_tipo_conversao_p)
		when 1 then
			if (r_C01_w.ie_ptu = 'S') then
				ie_considera_regra_w := true;
			end if;
		when 2 then
			if (r_C01_w.ie_importacao_conta = 'S') then
				ie_considera_regra_w := true;
			end if;
		when 3 then
			if (r_C01_w.ie_requisicao = 'S') then
				ie_considera_regra_w := true;
			end if;
		when 4 then
			if (r_C01_w.ie_ptu_a700 = 'S') then
				ie_considera_regra_w := true;
			end if;
		when 5 then
			if (r_C01_w.ie_faturamento = 'S') then
				ie_considera_regra_w := true;
			end if;
		when 6 then
			if (r_C01_w.ie_envio_lote_guias = 'S') then
				ie_considera_regra_w := true;
			end if;
		when 7 then
			if (r_C01_w.ie_ptu_a1200 = 'S') then
				ie_considera_regra_w := true;
			end if;
		when 8 then
			if (r_C01_w.ie_digitacao_portal = 'S') then
				ie_considera_regra_w := true;
			end if;
		when 9 then
			if (r_C01_w.ie_complemento = 'S') then
				ie_considera_regra_w := true;
			end if;
		when 10 then
			if (r_C01_w.ie_monitoramento_ans = 'S') then
				ie_considera_regra_w := true;
			end if;
		else
			ie_considera_regra_w := false;
	end case;

	-- se e para considerar a regra alimenta as variaveis de retorno
	if (ie_considera_regra_w = true) then

		cd_proc_conversao_w 	:= r_C01_w.cd_proc_conversao;
		ie_origem_conversao_w 	:= r_C01_w.ie_origem_conversao;
		nr_seq_regra_w 		:= r_C01_w.nr_sequencia;
		ie_envio_receb_w 	:= coalesce(r_C01_w.ie_envio_receb, 'R');
		cd_proc_envio_w 	:= r_C01_w.cd_proc_envio;
		ie_somente_codigo_w 	:= r_C01_w.ie_somente_codigo;
		
		-- ajustado a ordenacao do cursor para que o primeiro registro retornado seja o correto
		exit;
	end if;
end loop;

--Abre cursor com regras marcadas como pacote intercambio.  

--Se parametro global ie_priorizar_conv_pct_int_p diz que a conversao de pacotes deve ser priorizada:

-- 		entao lerah as regras ou entao, caso

-- Se parametro global aponta que a prioridade seja para as outras regras: 

-- 		Caso ja tenha encontrado regra, entoa nao ira ler as regras, marcadas como  pacote intercambio, 

--		Caso nao tenha encontrado nenhuma regra,  ai tambem lera as regras marcadas como pacote intercambio 
if ( ie_tipo_conversao_p in (1, 4) and (ie_priorizar_conv_pct_int_p = 'S') or ( coalesce(ie_priorizar_conv_pct_int_p,'N') = 'N' and coalesce(nr_seq_regra_w::text, '') = ''))then

	--Utilizado cursor para manter como a abertura das demais regras. Caso venha a ser altera a caracteristica de retornar a primeira regra encontrada, bastara remover o exit
	for r_C02_w in C02(	coalesce(ie_envio_receb_p, 'R'), dt_referencia_w, cd_estabelecimento_p) loop

		cd_proc_conversao_w 	:= r_C02_w.cd_proc_conversao;
		ie_origem_conversao_w 	:= r_C02_w.ie_origem_conversao;
		nr_seq_regra_w 			:= r_C02_w.nr_sequencia;
		ie_envio_receb_w 		:= coalesce(r_C02_w.ie_envio_receb, 'R');
		cd_proc_envio_w 		:= r_C02_w.cd_proc_envio;
		ie_somente_codigo_w 	:= r_C02_w.ie_somente_codigo;			
		exit;
		
	end loop;

end if;

if (coalesce(ie_envio_receb_w,'R') = 'R') and (coalesce(ie_envio_receb_p,'R') = 'R') then
	cd_proc_conversao_p	:= cd_proc_conversao_w;
	ie_origem_conversao_p	:= ie_origem_conversao_w;
	ie_somente_codigo_p	:= null;

elsif (coalesce(ie_envio_receb_w,'R') = 'E') and (coalesce(ie_envio_receb_p,'E') = 'E') then
	if (ie_tipo_conversao_p = 10) then
		cd_proc_conversao_p	:= coalesce(cd_proc_envio_w,cd_procedimento_p);
		ie_origem_conversao_p	:= ie_origem_conversao_w;
		ie_somente_codigo_p	:= null;
	else
		cd_proc_conversao_p	:= cd_proc_envio_w;
		ie_somente_codigo_p	:= ie_somente_codigo_w;
	end if;
end if;

nr_seq_regra_p		:= nr_seq_regra_w;

if (ie_tipo_conversao_p = 10) and (coalesce(cd_proc_conversao_p,0) =0 ) then
    cd_proc_conversao_p  := cd_procedimento_p;
    ie_origem_conversao_p  := ie_origem_conversao_w;
    ie_somente_codigo_p  := null;
end If;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_proced_conversao ( cd_procedimento_p procedimento.cd_procedimento%type, ie_origem_proced_p procedimento.ie_origem_proced%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_tipo_conversao_p bigint, nr_seq_congenere_p bigint, ie_tipo_conversao_scs_p bigint, ie_envio_receb_p pls_conversao_proc.ie_envio_receb%type, nr_seq_contrato_p bigint, nr_seq_intercambio_p bigint, nr_seq_ops_congenere_p bigint, cd_material_p text, ie_tipo_intercambio_p pls_conversao_proc.ie_tipo_intercambio%type, cd_proc_conversao_p INOUT pls_conversao_proc.cd_proc_conversao%type, ie_origem_conversao_p INOUT pls_conversao_proc.ie_origem_conversao%type, nr_seq_regra_p INOUT pls_conversao_proc.nr_sequencia%type, ie_somente_codigo_p INOUT pls_conversao_proc.ie_somente_codigo%type, dt_referencia_p timestamp, nr_seq_tipo_atendimento_p pls_conversao_proc.nr_seq_tipo_atendimento%type, nr_seq_grau_partic_p pls_proc_participante.nr_seq_grau_partic%type, nr_seq_prestador_partic_p pls_proc_participante.nr_seq_prestador%type, ie_pacote_int_p text default 'N', ie_priorizar_conv_pct_int_p pls_parametros.ie_priorizar_conv_pct_int%type default 'N') FROM PUBLIC;

