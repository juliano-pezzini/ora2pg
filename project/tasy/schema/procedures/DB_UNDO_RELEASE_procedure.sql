-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE db_undo_release ( nm_usuario_p text, ds_reason_p text, nr_seq_doc_template_p bigint DEFAULT NULL, nr_seq_content_item_p bigint DEFAULT NULL, nr_seq_content_macro_p bigint DEFAULT NULL) AS $body$
DECLARE

  nm_usuario_release_w usuario.nm_usuario%type;
  dt_release_w timestamp;

BEGIN
  IF (nr_seq_doc_template_p IS NOT NULL AND nr_seq_doc_template_p::text <> '') THEN
    SELECT dt_liberacao,
      nm_usuario
    INTO STRICT dt_release_w,
      nm_usuario_release_w
    FROM db_document_template
    WHERE nr_sequencia = nr_seq_doc_template_p;
    UPDATE db_document_template
    SET dt_liberacao    = NULL,
      nm_usuario       = nm_usuario_p,
      dt_atualizacao   = clock_timestamp()
    WHERE nr_sequencia = nr_seq_doc_template_p;
  END IF;
  IF (nr_seq_content_item_p IS NOT NULL AND nr_seq_content_item_p::text <> '') THEN
    SELECT dt_liberacao,
      nm_usuario
    INTO STRICT dt_release_w,
      nm_usuario_release_w
    FROM db_content_item
    WHERE nr_sequencia = nr_seq_content_item_p;
    UPDATE db_content_item
    SET dt_liberacao    = NULL,
      nm_usuario       = nm_usuario_p,
      dt_atualizacao   = clock_timestamp()
    WHERE nr_sequencia = nr_seq_content_item_p;
  END IF;
  IF (nr_seq_content_macro_p IS NOT NULL AND nr_seq_content_macro_p::text <> '') THEN
    SELECT dt_liberacao,
      nm_usuario
    INTO STRICT dt_release_w,
      nm_usuario_release_w
    FROM db_content_macro
    WHERE nr_sequencia = nr_seq_content_macro_p;
    UPDATE db_content_macro
    SET dt_liberacao    = NULL,
      nm_usuario       = nm_usuario_p,
      dt_atualizacao   = clock_timestamp()
    WHERE nr_sequencia = nr_seq_content_macro_p;
  END IF;
  INSERT
  INTO db_undo_reason(
      nr_sequencia,
      dt_atualizacao_nrec,
      nm_usuario_nrec,
      dt_atualizacao,
      nm_usuario,
      ds_reason,
      nr_seq_doc_template,
      nr_seq_content_item,
      nr_seq_content_macro
    )
    VALUES (
      nextval('db_undo_reason_seq'),
      clock_timestamp(),
      nm_usuario_p,
      dt_release_w,
      nm_usuario_release_w,
      ds_reason_p,
      nr_seq_doc_template_p,
      nr_seq_content_item_p,
      nr_seq_content_macro_p
    );
  COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE db_undo_release ( nm_usuario_p text, ds_reason_p text, nr_seq_doc_template_p bigint DEFAULT NULL, nr_seq_content_item_p bigint DEFAULT NULL, nr_seq_content_macro_p bigint DEFAULT NULL) FROM PUBLIC;

