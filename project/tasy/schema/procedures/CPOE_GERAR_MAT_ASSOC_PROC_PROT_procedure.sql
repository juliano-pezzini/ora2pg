-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_mat_assoc_proc_prot ( nr_atendimento_p bigint, nr_seq_procedimento_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_protocolo_p bigint, nr_seq_protocolo_p bigint, nr_seq_proc_p bigint, cd_setor_atendimento_p bigint, cd_paciente_p text, qt_idade_dia_p bigint, qt_idade_mes_p bigint, qt_idade_ano_p bigint, qt_peso_p bigint, cd_prescritor_p text, ds_mat_adic_proc_p INOUT text, dt_prev_execucao_p timestamp, cd_intervalo_proc_p text, ie_urgencia_p char ) AS $body$
DECLARE


cd_mat_proc_w				material.cd_material%type;

cd_unid_medida_dose_mat_w	unidade_medida.cd_unidade_medida%type;

ie_via_mat_proc_w			via_aplicacao.ie_via_aplicacao%type;

qt_dose_mat_w				protocolo_medic_material.qt_dose%type;
qt_dose_peso_w				protocolo_medic_material.qt_dose_peso%type;
ds_recomendacao_w			protocolo_medic_material.ds_recomendacao%type;
ie_arredondar_w				protocolo_medic_material.ie_arredondar%type;
qt_min_intervalo_w			protocolo_medic_material.qt_minuto_aplicacao%type;
qt_hora_intervalo_w			protocolo_medic_material.qt_hora_intervalo%type;
ds_obs_item_prot_w			protocolo_medic_material.ds_recomendacao%type;

cd_intervalo_w				intervalo_prescricao.cd_intervalo%type;

qt_casas_retorno_w			rep_regra_arredond_dose.qt_casas%type;

nr_seq_agrupamento_w		setor_atendimento.nr_seq_agrupamento%type;

dt_prescricao_w				timestamp;
dt_inicio_prescr_w			timestamp;
ie_se_necessario_w			char(1);
ie_acm_w					char(1);
ie_urgencia_mat_w			char(1);
ie_adm_mat_w				char(1);
ie_limpar_prim_horario_w	char(1);
hr_prim_horario_w			char(5);
ds_horarios_w				varchar(4000);
ds_horarios_aux_w			varchar(4000);
i							smallint;
ds_observacao_w				varchar(2000);
nr_ocorrencia_w				double precision;
qt_dose_limite_w			double precision;

c01 CURSOR FOR
	SELECT	a.cd_material,
			a.cd_unidade_medida,
			a.qt_dose,
			a.qt_dose_peso,
			a.ie_via_aplicacao,
			substr(a.ds_recomendacao,1,2000),
			coalesce(a.cd_intervalo, cd_intervalo_proc_p),
			a.ds_horarios,
			coalesce(a.ie_se_necessario,'N'),
			coalesce(a.ie_acm,'N'),
			a.hr_prim_horario,
			coalesce(a.ie_urgencia,'N'),
			coalesce(a.ie_arredondar,'N'),
			a.ds_justificativa,
			a.qt_hora_intervalo,
			a.qt_min_intervalo
	from 	protocolo_medic_material a
	where	a.cd_protocolo = cd_protocolo_p
	and		a.nr_sequencia = nr_seq_protocolo_p
	and		a.ie_agrupador = 5
	and		a.nr_seq_proc = nr_seq_proc_p
	order by
			a.nr_seq_material;

	procedure inserir_mat_associados_proc is
	nr_proximo_w	bigint;
	
BEGIN
		ie_adm_mat_w		:= 'P';
		if (ie_urgencia_mat_w IS NOT NULL AND ie_urgencia_mat_w::text <> '') then
			ie_urgencia_mat_w	:= 0;
		else
			ie_urgencia_mat_w	:= null;
			if (ie_se_necessario_w = 'S') then
				ie_adm_mat_w	:= 'N';
			elsif (ie_acm_w = 'S') then
				ie_adm_mat_w	:= 'C';
			end if;
		end if;

		nr_proximo_w	:= position(',' in ds_mat_adic_proc_p);
		i := substr(ds_mat_adic_proc_p,1,nr_proximo_w-1);
		ds_mat_adic_proc_p	:= substr(ds_mat_adic_proc_p,nr_proximo_w+1,length(ds_mat_adic_proc_p));

		CALL exec_sql_dinamico_bv(
			'CPOE',
				' update	cpoe_procedimento ' ||
				' set		cd_mat_proc'||i||' = :cd_mat_proc_w, ' ||
				' 			ie_via_mat_proc'||i||' = :ie_via_mat_proc_w, ' ||
				' 			qt_dose_mat'||i||' = :qt_dose_mat_w, ' ||
				' 			cd_unid_medida_dose_mat'||i||' = :cd_unid_medida_dose_mat_w, ' ||
				' 			cd_interv_proc'||i||' = :cd_interv_proc_w, ' ||
				' 			ds_hor_proc'||i||' = :ds_hor_proc_w, ' ||
				' 			dt_inicio_proc'||i||' = :dt_inicio_proc_w, ' ||
				' 			hr_prim_hor_proc'||i||' = :hr_prim_hor_proc_w, ' ||
				' 			ds_obser_proc'||i||' = :ds_obser_proc_w, ' ||
				' 			ie_urgencia_mat'||i||' = :ie_urgencia_mat_w, ' ||
				' 			ie_adm_mat'||i||' = :ie_adm_mat_w ' ||
				' where		nr_atendimento = :nr_atendimento_p ' ||
				' and		nr_sequencia = :nr_seq_procedimento_p ',
			'cd_mat_proc_w='||cd_mat_proc_w||
			'#@#@ie_via_mat_proc_w='||ie_via_mat_proc_w||
			'#@#@qt_dose_mat_w='||qt_dose_mat_w||
			'#@#@cd_unid_medida_dose_mat_w='||cd_unid_medida_dose_mat_w||
			'#@#@cd_interv_proc_w='||cd_intervalo_w||
			'#@#@ds_hor_proc_w='||ds_horarios_w||
			'#@#@dt_inicio_proc_w='||dt_prev_execucao_p||
			'#@#@hr_prim_hor_proc_w='||hr_prim_horario_w||
			'#@#@ds_obser_proc_w='||ds_observacao_w||
			'#@#@ie_urgencia_mat_w='||ie_urgencia_mat_w||
			'#@#@ie_adm_mat_w='||ie_adm_mat_w||
			'#@#@nr_atendimento_p='||nr_atendimento_p||
			'#@#@nr_seq_procedimento_p='||nr_seq_procedimento_p||
			'#@#@');
		commit;
	end;

begin
if (ds_mat_adic_proc_p = 'X') then
	ds_mat_adic_proc_p	:= '1,2,3,4,5,';
else
	if (coalesce(ds_mat_adic_proc_p::text, '') = '') then
		return;
	end if;

	ds_mat_adic_proc_p	:= ds_mat_adic_proc_p;
end if;

select	coalesce(max(qt_casas),0)
into STRICT	qt_casas_retorno_w
from	rep_regra_arredond_dose
where	qt_peso_p between qt_peso_inicial and qt_peso_final;

dt_prescricao_w		:= trunc(dt_prev_execucao_p,'mi') + 1/24;
dt_inicio_prescr_w	:= dt_prev_execucao_p;

open c01;
loop
fetch c01 into
	cd_mat_proc_w,
	cd_unid_medida_dose_mat_w,
	qt_dose_mat_w,
	qt_dose_peso_w,
	ie_via_mat_proc_w,
	ds_recomendacao_w,
	cd_intervalo_w,
	ds_horarios_w,
	ie_se_necessario_w,
	ie_acm_w,
	hr_prim_horario_w,
	ie_urgencia_mat_w,
	ds_obs_item_prot_w,
	ie_arredondar_w,
	qt_hora_intervalo_w,
	qt_min_intervalo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (coalesce(ie_urgencia_p, 'N') = 'S') or (ie_urgencia_mat_w = 'S') then
		ie_urgencia_mat_w 	:= 'S';
		ie_acm_w		 	:= 'N';
		ie_se_necessario_w	:= 'N';
	elsif (ie_acm_w = 'S') then
		ie_urgencia_mat_w	:= 'N';
		ie_se_necessario_w	:= 'N';
	elsif (ie_se_necessario_w = 'S') then
		ie_urgencia_mat_w	:= 'N';
		ie_acm_w			:= 'N';
	else
		ie_urgencia_mat_w	:= 'N';
		ie_acm_w			:= 'N';
		ie_se_necessario_w	:= 'N';
	end if;

	if (ie_urgencia_mat_w = 'S') and (coalesce(cd_intervalo_w::text, '') = '') then
		dt_prescricao_w := clock_timestamp();

		select	coalesce(max(a.cd_intervalo),cd_intervalo_w)
		into STRICT	cd_intervalo_w
		from	intervalo_prescricao a
		where	/*obter_se_exibe_intervalo(nr_prescricao_p, a.cd_intervalo, cd_setor_atendimento_p) = 'S'
		and		*/
a.ie_agora	= 'S'
		and		a.ie_situacao = 'A';
	end if;

	if (ie_urgencia_mat_w <> 'S') and (ie_acm_w <> 'S') then
		select	max(cd_intervalo)
		into STRICT	cd_intervalo_w
		from	intervalo_prescricao
		where	ie_situacao = 'A'
		and		cd_intervalo = cd_intervalo_w
		and		Obter_se_intervalo(cd_intervalo, 1) = 'S'
		and		Obter_se_intervalo_material(cd_mat_proc_w, cd_intervalo) = 'S'
		and		((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_p))
		--and     obter_se_exibe_intervalo(nr_prescricao_p, cd_intervalo, null) = 'S'
		order by
				coalesce(nr_seq_apresent,999),
				ds_intervalo;
	elsif (ie_urgencia_mat_w = 'S') then
		select	max(cd_intervalo)
		into STRICT	cd_intervalo_w
		from    intervalo_prescricao
		where   ie_situacao = 'A'
		and     coalesce(ie_agora,'N') = 'S'
		and		cd_intervalo = cd_intervalo_w
		and		((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_p))
		and		Obter_se_intervalo(cd_intervalo, 1) = 'S'
		--and		obter_se_exibe_intervalo(nr_prescricao_p,cd_intervalo, null) = 'S'
		order by
				coalesce(nr_seq_apresent,999),
				ds_intervalo;
	else
		select	max(cd_intervalo)
		into STRICT	cd_intervalo_w
		from    intervalo_prescricao
		where   ie_situacao = 'A'
		and 	cd_intervalo = cd_intervalo_w
		and     ((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_p))
		and		Obter_se_intervalo(cd_intervalo, 1) = 'S'
		--and		obter_se_exibe_intervalo(nr_prescricao_p,cd_intervalo, null) = 'S'
		order by
			coalesce(nr_seq_apresent,999),
			 ds_intervalo;
	end if;

	if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') then
		ie_limpar_prim_horario_w := obter_se_limpa_prim_hor(cd_intervalo_w,cd_setor_atendimento_p);
	end if;

	if (ie_limpar_prim_horario_w = 'S') then
		hr_prim_horario_w	:= '';
		ds_horarios_w		:= '';
	else
		begin
		if (hr_prim_horario_w = '  :  ') then
			hr_prim_horario_w	:= null;
		end if;

		if (coalesce(hr_prim_horario_w::text, '') = '') then
			hr_prim_horario_w := CPOE_Obter_primeiro_horario( nr_atendimento_p, cd_intervalo_w, cd_mat_proc_w, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p );
		end if;

		if	((coalesce(hr_prim_horario_w::text, '') = '') or (ie_urgencia_mat_w = 'S')) then
			hr_prim_horario_w	:= substr(to_char(dt_prescricao_w,'dd/mm/yyyy hh24:mi:ss'),12,5);
		end if;

		if (ie_acm_w = 'S') then
			ds_horarios_w := 'ACM';
		elsif (ie_se_necessario_w = 'S') then
			ds_horarios_w := 'SN';
			hr_prim_horario_w := '';
		end if;

		nr_ocorrencia_w		:= 0;

		if (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') then
			dt_prescricao_w := to_date(to_char(dt_prescricao_w,'dd/mm/yyyy ') || hr_prim_horario_w,'dd/mm/yyyy hh24:mi');
		end if;

		if (ie_urgencia_mat_w = 'S') then
			dt_prescricao_w := clock_timestamp();
		end if;

		if (coalesce(qt_min_intervalo_w::text, '') = '') then
			select	max(qt_min_intervalo)
			into STRICT	qt_min_intervalo_w
			from	intervalo_prescricao
			where	cd_intervalo	= cd_intervalo_w;
		end if;

		SELECT * FROM cpoe_calcular_horario_prescr(	nr_atendimento_p, cd_intervalo_w, null, dt_prev_execucao_p, qt_hora_intervalo_w, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null, null, null, null, null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;

		ds_horarios_w	:= ds_horarios_w || ds_horarios_aux_w;
		end;
	end if;

	ie_via_mat_proc_w	:= coalesce(CPOE_Obter_padrao_param_prescr(	nr_atendimento_p, cd_mat_proc_w, ie_via_mat_proc_w, ie_se_necessario_w,
																	'V', cd_intervalo_w, cd_estabelecimento_p, cd_perfil_p,
																	nm_usuario_p ), ie_via_mat_proc_w);

	if (coalesce(ie_via_mat_proc_w::text, '') = '') then
		select	max(ie_via_aplicacao)
		into STRICT	ie_via_mat_proc_w
		from	material
		where	cd_material = cd_mat_proc_w;
	end if;

	if (qt_dose_peso_w > 0) and (qt_peso_p > 0) then
		qt_dose_mat_w	:= qt_dose_peso_w * qt_peso_p;

		if (ie_arredondar_w = 'S') then
			qt_dose_mat_w := Arredondamento(qt_dose_mat_w, 1, 'R');
		end if;

		if (upper(cd_unid_medida_dose_mat_w) = 'GTS') then
			qt_dose_mat_w := round(qt_dose_mat_w);
		end if;
	end if;

	ds_observacao_w	:= trim(both substr( Obter_orientacao_medic(cd_mat_proc_w) ,1,2000));

	if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
		ds_observacao_w	:= substr(ds_observacao_w || ' - ',1,2000);
	end if;

	ds_observacao_w	:= substr(ds_observacao_w || ds_recomendacao_w || ds_obs_item_prot_w,1,2000);

	qt_dose_mat_w			:= coalesce(qt_dose_mat_w, 0);

	select	max(nr_seq_agrupamento)
	into STRICT	nr_seq_agrupamento_w
	from	setor_atendimento
	where	cd_setor_atendimento	= cd_setor_atendimento_p;

	qt_dose_limite_w	:= CPOE_Obter_dose_maxima(	cd_estabelecimento_p, cd_mat_proc_w, cd_unid_medida_dose_mat_w, qt_dose_mat_w,
													ie_via_mat_proc_w, cd_setor_atendimento_p, nr_seq_agrupamento_w, cd_prescritor_p,
													qt_idade_dia_p, qt_idade_mes_p, qt_idade_ano_p, qt_peso_p );

	if (qt_dose_limite_w > 0) then
		qt_dose_mat_w	:= qt_dose_limite_w;
	end if;

	if (coalesce(ds_observacao_w::text, '') = '') then
		ds_observacao_w	:= substr(CPOE_Obter_padrao_param_prescr(	nr_atendimento_p, cd_mat_proc_w, ie_via_mat_proc_w, ie_se_necessario_w,
																	'O', cd_intervalo_w, cd_estabelecimento_p, cd_perfil_p,
																	nm_usuario_p ),1,2000);
	end if;

	if (qt_casas_retorno_w > 0) then
		qt_dose_mat_w	:= round(qt_dose_mat_w,qt_casas_retorno_w);
	end if;

	inserir_mat_associados_proc;

	if (coalesce(ds_mat_adic_proc_p::text, '') = '') then
		exit;
	end if;
	end;
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_mat_assoc_proc_prot ( nr_atendimento_p bigint, nr_seq_procedimento_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_protocolo_p bigint, nr_seq_protocolo_p bigint, nr_seq_proc_p bigint, cd_setor_atendimento_p bigint, cd_paciente_p text, qt_idade_dia_p bigint, qt_idade_mes_p bigint, qt_idade_ano_p bigint, qt_peso_p bigint, cd_prescritor_p text, ds_mat_adic_proc_p INOUT text, dt_prev_execucao_p timestamp, cd_intervalo_proc_p text, ie_urgencia_p char ) FROM PUBLIC;

