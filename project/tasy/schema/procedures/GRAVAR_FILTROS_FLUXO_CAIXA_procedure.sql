-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_filtros_fluxo_caixa (ie_classificacao_p text, ie_operacao_p text, ie_periodo_p text, ie_restringir_estab_p text, ie_todas_contas_p text, ie_dias_uteis_p text, ie_somente_ativo_result_p text, vl_saldo_anterior_p bigint, nr_nivel_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, cd_conta_financ_avancado_p text default null, nm_usuario_p text DEFAULT NULL, cd_empresa_p bigint DEFAULT NULL, cd_estabelecimento_p bigint DEFAULT NULL, cd_moeda_p bigint DEFAULT NULL, NR_SEQ_REGRA_COMPOSICAO_P bigint default null, cd_empresa_avancado_p text default null, cd_estabelecimento_avancado_p text default null, IE_TIT_REC_P text DEFAULT NULL, IE_TIT_PAGAR_P text DEFAULT NULL, IE_CHEQUE_P text DEFAULT NULL, IE_CARTAO_P text DEFAULT NULL, IE_CONV_RECEB_P text DEFAULT NULL, IE_PROTOCOLO_P text DEFAULT NULL, IE_ORDEM_COMPRA_P text DEFAULT NULL, IE_CONTRATO_P text DEFAULT NULL, IE_FLUXO_ESPECIAL_P text DEFAULT NULL, IE_AGENDA_P text DEFAULT NULL, IE_BORDERO_PAGAR_P text DEFAULT NULL, IE_PAGTO_ESCRIT_P text DEFAULT NULL, DS_USUARIO_NOTIFICACAO_P text DEFAULT NULL, DS_PERFIL_NOTIFICACAO_P text DEFAULT NULL) AS $body$
DECLARE


jobno			bigint;
ds_comando_job_w	varchar(2000);

C01 CURSOR FOR
	-- falhas is not null significa que ja foi executado pelo menos uma vez
	-- se ja foi executado ao menos uma vez, apaga.
	-- durante a execucao ele fica null
	SELECT	job
	from	job_v
	where	comando	like 'gerar_fluxo_caixa_html%'
	and	(falhas IS NOT NULL AND falhas::text <> '') or PARADA = 'Y';
	
BEGIN	
	for r_C01_w in C01 loop
		dbms_job.remove(r_C01_w.job);
		commit;
	end loop;

	delete FROM FLUXO_CAIXA_FILTRO
	where nm_usuario = nm_usuario_p;
	
	delete FROM NOTIFICACOES
	where cd_grupo_notificacao = 'fluxo-caixa';

	insert into FLUXO_CAIXA_FILTRO(
		nr_sequencia,
		ie_classificacao,
		ie_operacao,
		ie_periodo,
		ie_restringir_estab,
		ie_todas_contas,
		ie_dias_uteis,
		ie_somente_ativo_result,
		vl_saldo_anterior,
		nr_nivel,
		dt_inicial,
		dt_final,
		CD_CONTA_FINANC_AVANCADO,
		nm_usuario,
		cd_empresa,
		cd_estabelecimento,
		cd_moeda,
		NR_SEQ_REGRA_COMPOSICAO,
		dt_atualizacao,
		IE_STATUS_AGEND,
		CD_EMPRESA_AVANCADO,
		CD_ESTABELECIMENTO_AVANCADO,
		IE_TIT_REC,
		IE_TIT_PAGAR,
		IE_CHEQUE,
		IE_CARTAO,
		IE_CONV_RECEB,
		IE_PROTOCOLO,
		IE_ORDEM_COMPRA,
		IE_CONTRATO,
		IE_FLUXO_ESPECIAL,
		IE_AGENDA,
		IE_BORDERO_PAGAR,
		IE_PAGTO_ESCRIT,
		DS_USUARIO_NOTIFICACAO,
		DS_PERFIL_NOTIFICACAO)
	values (nextval('fluxo_caixa_filtro_seq'),
		ie_classificacao_p,
		ie_operacao_p,
		ie_periodo_p,
		ie_restringir_estab_p,
		ie_todas_contas_p,
		ie_dias_uteis_p,
		ie_somente_ativo_result_p, 
		vl_saldo_anterior_p,
		nr_nivel_p,
		dt_inicial_p,
		dt_final_p,
		cd_conta_financ_avancado_p,
		nm_usuario_p,
		cd_empresa_p,
		cd_estabelecimento_p,
		cd_moeda_p,
		nr_seq_regra_composicao_p,
		clock_timestamp(),
		'P',
		CD_EMPRESA_AVANCADO_P,
		CD_ESTABELECIMENTO_AVANCADO_P,
		IE_TIT_REC_P,
		IE_TIT_PAGAR_P,
		IE_CHEQUE_P,
		IE_CARTAO_P,
		IE_CONV_RECEB_P,
		IE_PROTOCOLO_P,
		IE_ORDEM_COMPRA_P,
		IE_CONTRATO_P,
		IE_FLUXO_ESPECIAL_P,
		IE_AGENDA_P,
		IE_BORDERO_PAGAR_P,
		IE_PAGTO_ESCRIT_P,
		DS_USUARIO_NOTIFICACAO_P,
		DS_PERFIL_NOTIFICACAO_P);
		
begin 	
dbms_job.submit(jobno, 'gerar_fluxo_caixa_html('''|| nm_usuario_p ||''');',clock_timestamp() + interval '1 days'/24/60);
END;


commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_filtros_fluxo_caixa (ie_classificacao_p text, ie_operacao_p text, ie_periodo_p text, ie_restringir_estab_p text, ie_todas_contas_p text, ie_dias_uteis_p text, ie_somente_ativo_result_p text, vl_saldo_anterior_p bigint, nr_nivel_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, cd_conta_financ_avancado_p text default null, nm_usuario_p text DEFAULT NULL, cd_empresa_p bigint DEFAULT NULL, cd_estabelecimento_p bigint DEFAULT NULL, cd_moeda_p bigint DEFAULT NULL, NR_SEQ_REGRA_COMPOSICAO_P bigint default null, cd_empresa_avancado_p text default null, cd_estabelecimento_avancado_p text default null, IE_TIT_REC_P text DEFAULT NULL, IE_TIT_PAGAR_P text DEFAULT NULL, IE_CHEQUE_P text DEFAULT NULL, IE_CARTAO_P text DEFAULT NULL, IE_CONV_RECEB_P text DEFAULT NULL, IE_PROTOCOLO_P text DEFAULT NULL, IE_ORDEM_COMPRA_P text DEFAULT NULL, IE_CONTRATO_P text DEFAULT NULL, IE_FLUXO_ESPECIAL_P text DEFAULT NULL, IE_AGENDA_P text DEFAULT NULL, IE_BORDERO_PAGAR_P text DEFAULT NULL, IE_PAGTO_ESCRIT_P text DEFAULT NULL, DS_USUARIO_NOTIFICACAO_P text DEFAULT NULL, DS_PERFIL_NOTIFICACAO_P text DEFAULT NULL) FROM PUBLIC;

