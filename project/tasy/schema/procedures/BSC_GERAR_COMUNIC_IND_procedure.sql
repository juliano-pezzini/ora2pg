-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE bsc_gerar_comunic_ind ( dt_referencia_p timestamp, nm_usuario_p text) AS $body$
DECLARE

				

cd_ano_w			smallint;
cd_dia_w				smallint;
cd_periodo_w			smallint;
ds_comunicado_w			text;
ds_comunicado_ww		text;
ds_origem_indicador_w		varchar(80);	
ds_titulo_w			varchar(255);
ds_titulo_ww			varchar(4000);
nm_indicador_w			varchar(255);
nm_pessoa_fisica_w		varchar(60);
nm_usuario_resp_w			varchar(15);
nm_usuario_destino_w		varchar(2000);
nr_dia_liberacao_w			smallint;
nr_seq_indicador_w			bigint;
nr_seq_origem_w			bigint;
nr_seq_regra_w			bigint;
qt_dia_aviso_w			bigint;
qt_meta_w			double precision;
qt_limite_w			double precision;
qt_real_w				double precision;
ie_comunicacao_w			varchar(1);
ie_email_w			varchar(1);
ds_email_origem_w			varchar(255);
ds_email_w			varchar(255);
cd_pessoa_fisica_w		varchar(10);
ds_out_w				varchar(50);
ds_comunicado_email_w		varchar(4000);

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	coalesce(a.ds_titulo,''),
	coalesce(a.qt_dia_aviso,0),
	a.ds_comunicado,
	coalesce(a.ie_comunicacao,''),
	coalesce(a.ie_email,''),
	coalesce(a.ds_email_origem,'')
from	bsc_regra_comunic_ind a
where	a.ie_situacao	= 'A';

c02 CURSOR FOR
SELECT	a.nr_sequencia,
	a.nm_indicador,
	a.nr_dia_liberacao,
	a.nr_seq_origem
from	bsc_indicador a
where	a.ie_situacao	= 'A'
and	exists (	SELECT	1
		from	bsc_ind_inf x
		where	x.nr_seq_indicador 	= a.nr_sequencia
		and	x.cd_ano		= cd_ano_w
		and	x.cd_periodo	= cd_periodo_w
		and	coalesce(x.dt_liberacao::text, '') = '')
and	exists (	select	1
		from	bsc_ind_resp y
		where	y.nr_seq_indicador	= a.nr_sequencia)
and	(a.nr_dia_liberacao IS NOT NULL AND a.nr_dia_liberacao::text <> '');

c03 CURSOR FOR
SELECT	a.nm_usuario
from	bsc_ind_resp b,
	usuario a
where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
and	b.nr_seq_indicador	= nr_seq_indicador_w
and	bsc_obter_se_resp_indic(nr_seq_indicador_w,dt_referencia_p,a.nm_usuario) = 'S'
and	a.ie_situacao = 'A'
and	coalesce(b.ie_receb_comunic_inf,'S') = 'S'
order by 1;


BEGIN
cd_dia_w	:= (to_char(dt_referencia_p,'DD'))::numeric;
cd_periodo_w	:= (to_char(dt_referencia_p,'MM'))::numeric;
cd_ano_w	:= (to_char(dt_referencia_p,'YYYY'))::numeric;

open c01;
loop
fetch c01 into	
	nr_seq_regra_w,
	ds_titulo_w,
	qt_dia_aviso_w,
	ds_comunicado_w,
	ie_comunicacao_w,
	ie_email_w,
	ds_email_origem_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	open c02;	
	loop
	fetch c02 into	
		nr_seq_indicador_w,
		nm_indicador_w,
		nr_dia_liberacao_w,
		nr_seq_origem_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin		
		ds_comunicado_ww	:= ds_comunicado_w;
		select	max(ds_origem_indicador)
		into STRICT	ds_origem_indicador_w
		from	bsc_origem_indic
		where	nr_sequencia	= nr_seq_origem_w;

		select	coalesce(max(qt_meta),0),
			coalesce(max(qt_limite),0),
			coalesce(max(qt_real),0)	
		into STRICT	qt_meta_w,
			qt_limite_w,
			qt_real_w
		from	bsc_ind_inf
		where	nr_seq_indicador	= nr_seq_indicador_w
		and	cd_ano		= cd_ano_w
		and	cd_periodo	= cd_periodo_w;	

		ds_titulo_ww		:= '';

		if (cd_dia_w = nr_dia_liberacao_w) then
			ds_titulo_ww	:= substr(wheb_mensagem_pck.get_texto(799484) || nm_indicador_w || chr(13) || chr(10),1,4000);
		end if;
			
		if (qt_dia_aviso_w > 0) and
			(dt_referencia_p >= (to_date(nr_dia_liberacao_w||'/'||to_char(dt_referencia_p,'mm/yyyy'),'dd/mm/yyyy') - qt_dia_aviso_w)) and (dt_referencia_p <= to_date(nr_dia_liberacao_w||'/'||to_char(dt_referencia_p,'mm/yyyy'),'dd/mm/yyyy')) then
			ds_titulo_ww	:= substr(' ' || wheb_mensagem_pck.get_texto(799485) || ' ' || qt_dia_aviso_w || wheb_mensagem_pck.get_texto(799486) || nm_indicador_w || chr(13) || chr(10),1,4000);		
		end if;
		
		
		/*if	(qt_dia_aviso_w > 0) and
			(cd_dia_w = (nr_dia_liberacao_w - qt_dia_aviso_w)) then
			ds_titulo_ww	:= substr(' Faltam: ('  || qt_dia_aviso_w || ') dia(s) para o termino do prazo para a liberacao das informacoes do indicador: ' || nm_indicador_w || chr(13) || chr(10),1,4000);
		end if;*/
		if (coalesce(ds_titulo_ww,'X') <> 'X') then
			begin
			nm_usuario_destino_w		:= '';
			open c03;
			loop
			fetch c03 into
				nm_usuario_resp_w;
			EXIT WHEN NOT FOUND; /* apply on c03 */
				begin
				nm_usuario_destino_w	:= nm_usuario_destino_w || nm_usuario_resp_w || ',';
				end;
			end loop;
			close c03;

			if (coalesce(ds_comunicado_ww,'X') <> 'X') then
				begin
				nm_pessoa_fisica_w	:= substr(obter_pessoa_fisica_usuario(nm_usuario_resp_w, 'N'),1,60);
				ds_comunicado_ww	:= substr(replace_macro(ds_comunicado_ww,'@NM_RESP_INDICADOR',nm_pessoa_fisica_w),1,4000);
				ds_comunicado_ww	:= substr(replace_macro(ds_comunicado_ww,'@INDICADOR',nm_indicador_w),1,4000);
				ds_comunicado_ww	:= substr(replace_macro(ds_comunicado_ww,'@META',campo_mascara_virgula(qt_meta_w)),1,4000);
				ds_comunicado_ww	:= substr(replace_macro(ds_comunicado_ww,'@LIMITE',campo_mascara_virgula(qt_limite_w)),1,4000);
				ds_comunicado_ww	:= substr(replace_macro(ds_comunicado_ww,'@REAL',campo_mascara_virgula(qt_real_w)),1,4000);
				end;
			end if;

			if (coalesce(nm_usuario_destino_w,'X') <> 'X') and (coalesce(ie_comunicacao_w,'S') = 'S') then
				begin
				CALL gerar_comunic_padrao(	clock_timestamp(),
							ds_titulo_w,
							ds_comunicado_ww,
							nm_usuario_p,
							'N',
							nm_usuario_destino_w,
							'N',
							null,
							'',
							null,
							'',
							clock_timestamp(),
							'',
							'');
				end;
			end if;

			
			open C03;
			loop
			fetch C03 into	
				nm_usuario_resp_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin
				if (coalesce(nm_usuario_resp_w,'X') <> 'X') and (coalesce(ie_email_w,'N') = 'S') then
					begin
					select	a.cd_pessoa_fisica
					into STRICT	cd_pessoa_fisica_w
					from	usuario a
					where	a.nm_usuario = nm_usuario_resp_w;

					ds_email_w := obter_dados_compl_pf_pj(null,cd_pessoa_fisica_w,'EMA');

					if (coalesce(ds_email_w,'X') <> 'X') then
						begin
						ds_out_w := converte_rtf_string('select ds_comunicado from bsc_regra_comunic_ind where nr_sequencia = :nr', nr_seq_regra_w, nm_usuario_p, ds_out_w);

						select	ds_texto
						into STRICT	ds_comunicado_email_w
						from	tasy_conversao_rtf
						where	nr_sequencia = ds_out_w;
						
						if (coalesce(ds_comunicado_email_w,'X') <> 'X') then
							begin
							nm_pessoa_fisica_w	:= substr(obter_pessoa_fisica_usuario(nm_usuario_resp_w, 'N'),1,60);
							ds_comunicado_email_w	:= substr(replace_macro(ds_comunicado_email_w,'@NM_RESP_INDICADOR',nm_pessoa_fisica_w),1,4000);
							ds_comunicado_email_w	:= substr(replace_macro(ds_comunicado_email_w,'@INDICADOR',nm_indicador_w),1,4000);
							ds_comunicado_email_w	:= substr(replace_macro(ds_comunicado_email_w,'@META',campo_mascara_virgula(qt_meta_w)),1,4000);
							ds_comunicado_email_w	:= substr(replace_macro(ds_comunicado_email_w,'@LIMITE',campo_mascara_virgula(qt_limite_w)),1,4000);
							ds_comunicado_email_w	:= substr(replace_macro(ds_comunicado_email_w,'@REAL',campo_mascara_virgula(qt_real_w)),1,4000);
                            CALL enviar_email(	ds_titulo_w,
									substr(ds_comunicado_email_w,1,4000),
									ds_email_origem_w,
									ds_email_w,
									nm_usuario_p,
									'A');
							end;
						end if;
						end;
					end if;
					end;
				end if;	
				end;
			end loop;
			close C03;
			end;
		end if;
		end;
	end loop;
	close c02;
	end;
end loop;
close c01;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE bsc_gerar_comunic_ind ( dt_referencia_p timestamp, nm_usuario_p text) FROM PUBLIC;

