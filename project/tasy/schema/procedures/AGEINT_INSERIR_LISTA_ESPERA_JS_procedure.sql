-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ageint_inserir_lista_espera_js (nr_seq_ageint_p bigint, nr_seq_ageint_item_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
cd_convenio_w		bigint;
cd_categoria_w		varchar(10);
cd_plano_w		varchar(10);
cd_pessoa_fisica_w	varchar(10);
cd_agenda_w		bigint;
cd_procedimento_w	bigint;
nr_seq_proc_interno_w	bigint;
ie_origem_proced_w	bigint;
cd_especialidade_w	integer;
ie_lado_w		varchar(1);
nr_telefone_w		varchar(255);
nm_paciente_w		varchar(255);
nm_pessoa_contato_w	varchar(50);
ie_classif_agenda_w	agenda_integrada_item.ie_classif_agenda%type;

 

BEGIN 
select	max(cd_agenda) 
into STRICT	cd_agenda_w 
from	agenda_paciente 
where	nr_sequencia = (SELECT	max(nr_seq_agenda_exame) 
			from	agenda_integrada_item 
			where	nr_sequencia = nr_seq_ageint_item_p);
 
if (cd_agenda_w IS NOT NULL AND cd_agenda_w::text <> '') then 
 
	select	max(cd_convenio), 
			max(cd_categoria), 
			max(cd_plano), 
			max(cd_pessoa_fisica) 
	into STRICT	cd_convenio_w, 
			cd_categoria_w, 
			cd_plano_w, 
			cd_pessoa_fisica_w 
	from	agenda_integrada 
	where	nr_sequencia = nr_seq_ageint_p;
 
	select	max(cd_procedimento), 
			max(nr_seq_proc_interno), 
			max(ie_origem_proced), 
			max(cd_especialidade), 
			max(ie_lado), 
			max(ie_classif_agenda) 
	into STRICT	cd_procedimento_w, 
			nr_seq_proc_interno_w, 
			ie_origem_proced_w, 
			cd_especialidade_w, 
			ie_lado_w, 
			ie_classif_agenda_w 
	from	agenda_integrada_item 
	where	nr_sequencia = nr_seq_ageint_item_p;
	 
	select	max(SUBSTR(OBTER_NOME_PF(cd_pessoa_fisica), 0, 60)) 
	into STRICT	nm_paciente_w 
	from	pessoa_fisica 
	where	cd_pessoa_fisica = cd_pessoa_fisica_w;
	 
	nr_telefone_w	:= obter_fone_pac_agenda(cd_pessoa_fisica_w);
	 
	if (coalesce(cd_pessoa_fisica_w::text, '') = '')then 
		begin 
		 
		select	substr(nm_paciente, 1, 60), 
				nr_telefone, 
				nm_contato 
		into STRICT	nm_paciente_w, 
				nr_telefone_w, 
				nm_pessoa_contato_w 
		from	agenda_integrada 
		where	nr_sequencia = nr_seq_ageint_p;
		 
		end;	
	end if;
 
	insert into agenda_lista_espera(nr_sequencia, 
					nm_pessoa_lista, 
					cd_especialidade, 
					cd_agenda, 
					cd_pessoa_fisica, 
					cd_procedimento, 
					nr_seq_proc_interno, 
					ie_origem_proced, 
					ie_lado, 
					cd_convenio, 
					cd_categoria, 
					cd_plano, 
					nr_telefone, 
					ie_urgente, 
					ie_status_espera, 
					dt_agendamento, 
					dt_desejada, 
					nm_usuario_agenda, 
					nm_usuario, 
					nm_usuario_nrec, 
					dt_atualizacao, 
					dt_atualizacao_nrec, 
					nm_pessoa_contato, 
					ie_classif_agenda) 
				values (nextval('agenda_lista_espera_seq'), 
					 nm_paciente_w, 
					 cd_especialidade_w, 
					 cd_agenda_w, 
					 cd_pessoa_fisica_w, 
					 cd_procedimento_w, 
					 nr_seq_proc_interno_w, 
					 ie_origem_proced_w, 
					 ie_lado_w, 
					 cd_convenio_w, 
					 cd_categoria_w, 
					 cd_plano_w, 
					 nr_telefone_w, 
					 'N', 
					 'A', 
					 clock_timestamp(), 
					 clock_timestamp(), 
					 nm_usuario_p, 
					 nm_usuario_p, 
					 nm_usuario_p, 
					 clock_timestamp(), 
					 clock_timestamp(), 
					 nm_pessoa_contato_w, 
					 ie_classif_agenda_w);
	commit;
end if;
	 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageint_inserir_lista_espera_js (nr_seq_ageint_p bigint, nr_seq_ageint_item_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

