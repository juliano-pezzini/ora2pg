-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_trans_fin_assoc_holding (nr_sequencia_p bigint, nr_seq_transacao_p bigint, ie_operacao_p bigint, nm_tabela_p text, nm_usuario_p text) AS $body$
DECLARE


cd_estabelecimento_w	trans_financ_contab.cd_estabelecimento%type;
cd_conta_referencia_w	conta_contabil.cd_conta_referencia%type;
cd_conta_contabil_w	trans_financ_contab.cd_conta_contabil%type;
cd_centro_custo_ref_w	trans_financ_contab.cd_centro_custo%type;
cd_centro_custo_w	trans_financ_contab.cd_centro_custo%type;
cd_historico_w	trans_financ_contab.cd_historico%type;
cd_historico_ref_w	trans_financ_contab.cd_historico%type;
nm_usuario_param_w	trans_financ_usuario.nm_usuario_param%type;
cd_perfil_w	trans_financ_usuario.cd_perfil%type;

trans_financ_campo_w  trans_financ_campo%rowtype;
trans_financ_contab_w  trans_financ_contab%rowtype;

c01 CURSOR FOR
	SELECT	t.nr_sequencia,
			 	t.cd_empresa,
				t.cd_estabelecimento
  	from  transacao_financeira t
  	where  t.nr_seq_trans_fin_ref  = nr_seq_transacao_p;

c01_w    c01%rowtype;


BEGIN

cd_estabelecimento_w	:= wheb_usuario_pck.get_cd_estabelecimento;

open c01;
loop
	fetch c01 into
		c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
if (ie_operacao_p = 1) then
	if (nm_tabela_p = 'TRANS_FINANC_USUARIO') then
		insert	into	trans_financ_usuario(nr_sequencia,
			nr_seq_transacao,
			nm_usuario,
			dt_atualizacao,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			nm_usuario_param,
			cd_perfil,
			nr_sequencia_ref)
		SELECT	nextval('trans_financ_usuario_seq'),
			c01_w.nr_sequencia,
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_param,
			cd_perfil,
			nr_sequencia
		from	trans_financ_usuario
		where	nr_seq_transacao	= nr_seq_transacao_p
		and	nr_sequencia	= nr_sequencia_p;

	elsif (nm_tabela_p = 'TRANS_FINANC_CONTAB') then

		insert into trans_financ_contab(
			nr_sequencia,
			nr_seq_trans_financ,
			ie_debito_credito, 
			ie_regra_conta, 
			ie_regra_centro_custo, 
			dt_atualizacao, 
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_conta_contabil,
			cd_centro_custo, 
			nm_atributo,
			cd_historico,
			ie_valor_absoluto, 
			ie_situacao,
			cd_estabelecimento,
			dt_inicio_vigencia, 
			dt_fim_vigencia,
			nr_seq_rateio_ccusto,
			nr_seq_produto, 
			ie_tipo_titulo_pagar,
			nr_sequencia_ref,
			cd_tipo_lote_contabil,
			ie_tipo_custo,
			cd_tipo_baixa,
			cd_tipo_recebimento,
			ie_tipo_titulo_receber,
			ie_origem_tit_pagar,
			ie_origem_tit_receber,
			ie_tipo_pessoa,
			nr_seq_classe_tp,
			nr_seq_classe_tr,
			nr_seq_classif_movto,
			ie_movto_estab_regra,
			cd_estab_fixo_movto,
			cd_tributo)
		SELECT	nextval('trans_financ_contab_seq'),
			c01_w.nr_sequencia,
			ie_debito_credito, 
			ie_regra_conta,
			ie_regra_centro_custo, 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			holding_pck.get_conta_contab_ref(c01_w.cd_empresa, cd_conta_contabil), 
			holding_pck.get_centro_custo_ref(c01_w.cd_empresa, cd_centro_custo), 
			nm_atributo, 
			cd_historico, 
			ie_valor_absoluto, 
			ie_situacao, 
			c01_w.cd_estabelecimento, 
			dt_inicio_vigencia, 
			dt_fim_vigencia,
			nr_seq_rateio_ccusto, 
			nr_seq_produto, 
			ie_tipo_titulo_pagar,
			nr_sequencia,
			cd_tipo_lote_contabil,
			ie_tipo_custo,
			cd_tipo_baixa,
			cd_tipo_recebimento,
			ie_tipo_titulo_receber,
			ie_origem_tit_pagar,
			ie_origem_tit_receber,
			ie_tipo_pessoa,
			(SELECT max(ctp.nr_sequencia) from classe_titulo_pagar ctp where ctp.nr_sequencia_ref = nr_seq_classe_tp and ctp.cd_estabelecimento = c01_w.cd_estabelecimento),
			nr_seq_classe_tr,
			nr_seq_classif_movto,
			ie_movto_estab_regra,
			cd_estab_fixo_movto,
			cd_tributo
		from	trans_financ_contab
		where	nr_seq_trans_financ	= nr_seq_transacao_p
		and	cd_estabelecimento	= cd_estabelecimento_w
		and	nr_sequencia	= nr_sequencia_p;

	elsif (nm_tabela_p = 'TRANS_FINANC_CONTA_CTB') then
		select	holding_pck.get_conta_contab_ref(c01_w.cd_empresa, cd_conta_contabil)
		into STRICT	cd_conta_contabil_w
		from	trans_financ_conta_ctb
		where	nr_seq_trans_financ = nr_seq_transacao_p
		and	nr_sequencia	= nr_sequencia_p;

		if (coalesce(cd_conta_contabil_w, '0') <> '0') then
			insert into	trans_financ_conta_ctb(	nr_sequencia,
				nr_seq_trans_financ,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				cd_conta_contabil,
				nr_sequencia_ref
			)
			values (
				nextval('trans_financ_conta_ctb_seq'),
				c01_w.nr_sequencia,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				cd_conta_contabil_w,
				nr_sequencia_p);
		end if;

	elsif (nm_tabela_p = 'TRANS_FINANC_CAMPO') then
		insert	into	trans_financ_campo(	nr_sequencia,
			nr_seq_trans_financ,
			dt_atualizacao,
			nm_usuario,
			nm_atributo,
			ie_obrigatorio,
			nm_atributo_mut_excl,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ie_primeiro_focus,
			nr_sequencia_ref)
		SELECT	nextval('trans_financ_campo_seq'),
			c01_w.nr_sequencia,
			clock_timestamp(),
			nm_usuario_p,
			nm_atributo,
			ie_obrigatorio,
			nm_atributo_mut_excl,
			clock_timestamp(),
			nm_usuario_p,
			coalesce(ie_primeiro_focus,'N'),
			nr_sequencia
		from	trans_financ_campo
		where	nr_seq_trans_financ	= nr_seq_transacao_p
		and	nr_sequencia	= nr_sequencia_p;
	end if;
else
	if (nm_tabela_p = 'TRANS_FINANC_CAMPO') then
		select	t.*
		into STRICT	trans_financ_campo_w
		from	trans_financ_campo t
		where	nr_seq_trans_financ	= nr_seq_transacao_p
		and	nr_sequencia	= nr_sequencia_p;

		update	trans_financ_campo
		set 	dt_atualizacao = clock_timestamp(),
				nm_usuario = nm_usuario_p,
				nm_atributo = trans_financ_campo_w.nm_atributo,
				ie_obrigatorio = trans_financ_campo_w.ie_obrigatorio,
				nm_atributo_mut_excl = trans_financ_campo_w.nm_atributo_mut_excl,
				ie_primeiro_focus = trans_financ_campo_w.ie_primeiro_focus
		where nr_sequencia_ref = nr_sequencia_p
		and	nr_seq_trans_financ = c01_w.nr_sequencia;

	elsif (nm_tabela_p = 'TRANS_FINANC_CONTA_CTB') then
		select	holding_pck.get_conta_contab_ref(c01_w.cd_empresa, cd_conta_contabil)
		into STRICT	cd_conta_contabil_w
		from	trans_financ_conta_ctb t
		where	t.nr_seq_trans_financ	= nr_seq_transacao_p
		and	t.nr_sequencia = nr_sequencia_p;

		update trans_financ_conta_ctb
		set dt_atualizacao = clock_timestamp(),
			nm_usuario = nm_usuario_p,
			cd_conta_contabil = cd_conta_contabil_w
		where nr_sequencia_ref = nr_sequencia_p
		and	nr_seq_trans_financ = c01_w.nr_sequencia;

	elsif (nm_tabela_p = 'TRANS_FINANC_CONTAB') then
		select	 t.*
		into STRICT	trans_financ_contab_w
		from	trans_financ_contab t
		where	t.nr_seq_trans_financ	= nr_seq_transacao_p
		and	t.nr_sequencia = nr_sequencia_p;

		update trans_financ_contab
		set 	ie_debito_credito = trans_financ_contab_w.ie_debito_credito,
				ie_regra_conta = trans_financ_contab_w.ie_regra_conta, 
				ie_regra_centro_custo = trans_financ_contab_w.ie_regra_centro_custo, 
				dt_atualizacao	= clock_timestamp(), 
				nm_usuario = nm_usuario_p, 
				cd_conta_contabil = holding_pck.get_conta_contab_ref(c01_w.cd_empresa, trans_financ_contab_w.cd_conta_contabil),
				cd_centro_custo = holding_pck.get_centro_custo_ref(c01_w.cd_empresa, trans_financ_contab_w.cd_centro_custo), 
				nm_atributo = trans_financ_contab_w.nm_atributo,
				cd_historico = trans_financ_contab_w.cd_historico,
				ie_valor_absoluto = trans_financ_contab_w.ie_valor_absoluto, 
				ie_situacao = trans_financ_contab_w.ie_situacao,
				cd_estabelecimento = c01_w.cd_estabelecimento,
				dt_inicio_vigencia = trans_financ_contab_w.dt_inicio_vigencia, 
				dt_fim_vigencia = trans_financ_contab_w.dt_fim_vigencia,
				nr_seq_rateio_ccusto = trans_financ_contab_w.nr_seq_rateio_ccusto,
				nr_seq_produto = trans_financ_contab_w.nr_seq_produto, 
				ie_tipo_titulo_pagar = trans_financ_contab_w.ie_tipo_titulo_pagar,
				cd_tipo_lote_contabil = trans_financ_contab_w.cd_tipo_lote_contabil,
				ie_tipo_custo = trans_financ_contab_w.ie_tipo_custo,
				cd_tipo_baixa = trans_financ_contab_w.cd_tipo_baixa,
				cd_tipo_recebimento = trans_financ_contab_w.cd_tipo_recebimento,
				ie_tipo_titulo_receber = trans_financ_contab_w.ie_tipo_titulo_receber,
				ie_origem_tit_pagar = trans_financ_contab_w.ie_origem_tit_pagar,
				ie_origem_tit_receber = trans_financ_contab_w.ie_origem_tit_receber,
				ie_tipo_pessoa = trans_financ_contab_w.ie_tipo_pessoa,
				nr_seq_classe_tp = 
					(SELECT max(ctp.nr_sequencia) 
						from classe_titulo_pagar ctp 
						where ctp.nr_sequencia_ref = trans_financ_contab_w.nr_seq_classe_tp 
							and ctp.cd_estabelecimento = c01_w.cd_estabelecimento
					),
				nr_seq_classe_tr = trans_financ_contab_w.nr_seq_classe_tr,
				nr_seq_classif_movto = trans_financ_contab_w.nr_seq_classif_movto,
				cd_tributo = trans_financ_contab_w.cd_tributo,
				ie_movto_estab_regra = trans_financ_contab_w.ie_movto_estab_regra,
				cd_estab_fixo_movto = trans_financ_contab_w.cd_estab_fixo_movto
		where nr_sequencia_ref = nr_sequencia_p
		and	nr_seq_trans_financ = c01_w.nr_sequencia;

	elsif (nm_tabela_p = 'TRANS_FINANC_USUARIO') then
		select	t.nm_usuario_param,
					t.cd_perfil
		into STRICT	nm_usuario_param_w,
				cd_perfil_w
		from	trans_financ_usuario t
		where	t.nr_sequencia = nr_sequencia_p
		and nr_seq_transacao = nr_seq_transacao_p;

		update trans_financ_usuario
		set nm_usuario = nm_usuario_p,
			dt_atualizacao = clock_timestamp(),
			nm_usuario_param = nm_usuario_param_w,
			cd_perfil = cd_perfil_w
		where nr_sequencia_ref = nr_sequencia_p
		and	nr_seq_transacao = c01_w.nr_sequencia;

	end if;
end if;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_trans_fin_assoc_holding (nr_sequencia_p bigint, nr_seq_transacao_p bigint, ie_operacao_p bigint, nm_tabela_p text, nm_usuario_p text) FROM PUBLIC;

