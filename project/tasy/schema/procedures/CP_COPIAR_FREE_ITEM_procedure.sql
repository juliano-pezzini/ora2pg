-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cp_copiar_free_item ( NR_SEQ_PRESCR_NEW_P PE_PRESCRICAO.NR_SEQUENCIA%TYPE, NR_SEQ_PRESCR_ANT_P PE_PRESCRICAO.NR_SEQUENCIA%TYPE, NM_USUARIO_P text ) AS $body$
DECLARE

    pe_prescr_diag_seq_w PE_PRESCR_DIAG.NR_SEQUENCIA%TYPE;
    cursor_diag_w CURSOR FOR
        SELECT
            a.*
        FROM PE_PRESCR_DIAG a
            WHERE 
                a.NR_SEQ_PRESCR = NR_SEQ_PRESCR_ANT_P AND
                a.IE_FREE_ITEM = 'S' AND
                coalesce(a.dt_end::text, '') = '' AND
                coalesce(a.dt_cancelamento::text, '') = '' AND
                NOT EXISTS (
                    SELECT 1 FROM pe_prescr_item_result_diag b WHERE b.NR_SEQ_DIAG = a.NR_SEQUENCIA
                );
BEGIN
    FOR r_cursor_diag_w IN cursor_diag_w LOOP

        SELECT nextval('pe_prescr_diag_seq') INTO STRICT pe_prescr_diag_seq_w;

        INSERT
            INTO pe_prescr_diag(
                nr_sequencia,
                nr_seq_prescr,
                nr_seq_diag,
                nm_usuario,
                dt_atualizacao,
                nm_usuario_nrec,
                dt_atualizacao_nrec,
                ie_recorrencia,
                nr_seq_ordenacao,
                ie_diag_colab,
                nr_prioridade,
                IE_FREE_ITEM
              ) VALUES (
                pe_prescr_diag_seq_w,
                NR_SEQ_PRESCR_NEW_P,
                r_cursor_diag_w.nr_seq_diag,
                NM_USUARIO_P,
                clock_timestamp(),
                NM_USUARIO_P,
                clock_timestamp(),
                r_cursor_diag_w.ie_recorrencia,
                r_cursor_diag_w.nr_seq_ordenacao,
                r_cursor_diag_w.ie_diag_colab,
                r_cursor_diag_w.nr_prioridade,
                r_cursor_diag_w.IE_FREE_ITEM
              );
        CALL CP_COPIAR_PRESCR_PROC(NR_SEQ_PRESCR_NEW_P,NR_SEQ_PRESCR_ANT_P,null,null,pe_prescr_diag_seq_w,r_cursor_diag_w.NR_SEQUENCIA,NM_USUARIO_P);
    END LOOP;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cp_copiar_free_item ( NR_SEQ_PRESCR_NEW_P PE_PRESCRICAO.NR_SEQUENCIA%TYPE, NR_SEQ_PRESCR_ANT_P PE_PRESCRICAO.NR_SEQUENCIA%TYPE, NM_USUARIO_P text ) FROM PUBLIC;

