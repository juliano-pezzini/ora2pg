-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_oc_cta_tratar_val_47_imp ( nr_seq_combinada_p pls_oc_cta_combinada.nr_sequencia%type, ie_regra_excecao_p pls_oc_cta_combinada.ie_excecao%type, nr_id_transacao_p pls_oc_cta_selecao_imp.nr_id_transacao%type) AS $body$
DECLARE


_ora2pg_r RECORD;
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:	Aplicar a validação 47 - Validar procedimento x grau de participação para os registros na tabela
	de seleção durante a geração da ocorrência combinada.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[ X]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 */
 -- Dados da tabela de seleção.
dados_tb_sel_w	pls_tipos_ocor_pck.dados_table_selecao_ocor;
tb_seq_selecao_w	pls_util_cta_pck.t_number_table;
tb_valido_w		pls_util_cta_pck.t_varchar2_table_1;
tb_observacao_w		pls_util_cta_pck.t_varchar2_table_4000;

cs_procs_ocorrencia_imp CURSOR(	nr_id_transacao_pc	pls_oc_cta_selecao_ocor_v.nr_id_transacao%type) FOR
	-- Neste primeiro passo seleciona os procedimentos que não tem participante informado e deveriam ter.
	SELECT	sel.nr_sequencia,
		'S' ie_valido,
		'A operadora exige que seja informado um grau de paticipação para este procedimento.' ds_observacao
	from	pls_oc_regra_proc_partic	regra,
		pls_oc_cta_selecao_imp		sel,
		pls_conta_proc_imp		proc
	where	regra.ie_partic_obrigatorio = 'S'
	and	sel.nr_id_transacao = nr_id_transacao_pc
	and	sel.ie_valido		= 'S'
	and	proc.nr_sequencia 	= sel.nr_seq_conta_proc
	and	proc.ie_origem_proced_conv	= regra.ie_origem_proced
	and	proc.cd_procedimento_conv  	= regra.cd_procedimento
	-- Se este procedimento não tiver participantes válidos deve gerar a ocorrência.
	and	not exists (	SELECT	1
				from	pls_conta_item_equipe_imp partic
				where	partic.nr_seq_conta_proc = proc.nr_sequencia
				and	(partic.cd_grau_partic IS NOT NULL AND partic.cd_grau_partic::text <> ''))
	
union

	-- Neste passo obtém os procedimentos com grau de participação inválida.
	select	sel.nr_sequencia,
		'S' ie_valido,
		'A apresentação do grau de participação ' ||
			(select	max(x.cd_tiss) || ' - ' ||  max(x.ds_grau_participacao)
			 from	pls_grau_participacao x
			 where	x.nr_sequencia = partic.nr_seq_grau_partic_conv)||
		' não é autorizada para este procedimento. ' ds_observacao
	from	pls_oc_regra_proc_partic	regra,
		pls_oc_cta_selecao_imp		sel,
		pls_conta_item_equipe_imp	partic,
		pls_conta_proc_imp		proc
	where	regra.ie_partic_obrigatorio = 'N'
	and	sel.nr_id_transacao = nr_id_transacao_pc
	and	sel.ie_valido = 'S'
	and	partic.nr_seq_conta_proc = sel.nr_seq_conta_proc
	and	partic.nr_seq_conta_proc = proc.nr_sequencia
	and	proc.ie_origem_proced_conv  = regra.ie_origem_proced
	and	proc.cd_procedimento_conv = regra.cd_procedimento
	and	(partic.cd_grau_partic IS NOT NULL AND partic.cd_grau_partic::text <> '')
	-- Se o participante tiver grau de participação diferente do definido na regra gera ocorrência
	-- Para o xml olha o valor do CD_TISS por que no XML vem este valor informado
	and	partic.cd_grau_partic not in (	select	coalesce(tipo.cd_tiss,'Nulo')
							from	pls_proc_grau_partic	grau,
								pls_grau_participacao	tipo
							where	grau.nr_seq_regra = regra.nr_sequencia
							and	grau.ie_situacao = 'A'
							and (coalesce(grau.dt_inicio_vigencia::text, '') = '' or grau.dt_inicio_vigencia <= proc.dt_execucao_conv)
							and (coalesce(grau.dt_fim_vigencia::text, '') = '' or grau.dt_fim_vigencia >= proc.dt_execucao_conv)
							and	tipo.nr_sequencia = grau.nr_seq_grau_partic);

-- Regras da validação.
cs_regras CURSOR(	nr_seq_combinada_pc	pls_oc_cta_combinada.nr_sequencia%type) FOR
	SELECT	a.ie_valida_proc_vs_grau
	from	pls_oc_cta_val_47 a
	where	a.nr_seq_oc_cta_comb = nr_seq_combinada_pc;
BEGIN

-- Só processa algo com regra válida.
if (nr_seq_combinada_p IS NOT NULL AND nr_seq_combinada_p::text <> '') then

	-- varrer as regras da ocorrência cadastradas
	for	rw_regra_w in cs_regras(nr_seq_combinada_p) loop

		if (rw_regra_w.ie_valida_proc_vs_grau = 'S') then

			-- tratamento em campo auxiliar para identificar posteriormente os registros que foram alterados
			CALL pls_ocor_imp_pck.atualiza_campo_auxiliar('V', 'N', nr_id_transacao_p, null);

			begin
				-- Buscar e mandar para o BD.
				for r_c01_w in cs_procs_ocorrencia_imp(nr_id_transacao_p) loop
					SELECT * FROM pls_ocor_imp_pck.limpar_nested_tables(	tb_seq_selecao_w, tb_valido_w, tb_observacao_w) INTO STRICT _ora2pg_r;
 	tb_seq_selecao_w := _ora2pg_r.tb_nr_seq_selecao_p; tb_valido_w := _ora2pg_r.tb_ie_valido_p; tb_observacao_w := _ora2pg_r.tb_ds_observacao_p;
					fetch cs_procs_ocorrencia_imp
					bulk collect into	tb_seq_selecao_w,
								tb_valido_w,
								tb_observacao_w
					limit pls_util_cta_pck.qt_registro_transacao_w;

					exit when dados_tb_sel_w.nr_seq_selecao.count = 0;

					CALL pls_ocor_imp_pck.gerencia_selecao_validacao(
						tb_seq_selecao_w, tb_valido_w, tb_observacao_w, nr_id_transacao_p, 'SEQ');
				end loop;

			exception
			when others then

				-- Tratar erro gerado, será inserido registro no log e abortado o processo exibindo mensagem de erro.
				CALL pls_ocor_imp_pck.trata_erro_sql_dinamico(	nr_seq_combinada_p,
										null,
										sqlerrm,
										nr_id_transacao_p,
										wheb_usuario_pck.get_nm_usuario,
										'N');
			end;

			-- seta os registros que serão válidos ou inválidos após o processamento
			CALL pls_ocor_imp_pck.atualiza_campo_valido('V', 'N',
						ie_regra_excecao_p, null,
						nr_id_transacao_p, null);
		end if;
	end loop;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_oc_cta_tratar_val_47_imp ( nr_seq_combinada_p pls_oc_cta_combinada.nr_sequencia%type, ie_regra_excecao_p pls_oc_cta_combinada.ie_excecao%type, nr_id_transacao_p pls_oc_cta_selecao_imp.nr_id_transacao%type) FROM PUBLIC;

