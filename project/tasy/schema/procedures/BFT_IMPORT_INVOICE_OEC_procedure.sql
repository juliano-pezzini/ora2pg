-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE bft_import_invoice_oec ( authorization_id bigint, oec_id_p bigint, invoice_id_p bigint, account_reference_id_p text, benefit_limitations_p text, claim_fund_assessment_cde_p text, co_payment_amount_p text, co_payment_days_remaining_p text, co_payment_description_p text, patient_first_name_p text, patient_medicare_card_p text, patient_reference_num_p text, excess_amount_p text, excess_amount_description_p text, excess_bonus_amount_p text, exclusion_description_p text, financial_status_p text, fund_reference_id_p text, fund_status_code_p text, medicare_status_code_p text, pea_potential_ind_p text, process_status_cde_p text, table_name_p text, table_description_p text, table_scale_p text, voucher_id_p text, claim_fund_explanation_code_p text, claim_fund_explanationtext_p text, charge_amount_p text, medicare_benefit_amount_p text, schedule_fee_p text, fund_benefit_amount_p text, medicare_explanation_code_p text, service_fund_assessment_code_p text, service_fund_exp_code_p text, service_fund_exp_text_p text, nm_usuario_p text) AS $body$
DECLARE

  ds_copayment_excess_w     varchar(4000);
  nr_seq_previous_letter_w  bigint;
  nr_seq_aut_conv_compl_w   bigint;
  nr_seq_estagio_w          bigint;
  ds_observacao_w           varchar(4000);
  ds_medicare_response_w    varchar(4000);
  ds_medicare_explanation_w varchar(500);
  ds_fund_explanation_w     varchar(500);
  nr_sequencia_w  oec_response.nr_sequencia%type;
  ds_erro_w                 varchar(4000);


BEGIN
  select coalesce(max(nr_sequencia),0)
  into STRICT nr_seq_previous_letter_w
  from autorizacao_convenio_compl
  where nr_sequencia_autor     = authorization_id
  and (nr_documento_portal IS NOT NULL AND nr_documento_portal::text <> '')
  and coalesce(dt_cancelamento::text, '') = '';
  if (nr_seq_previous_letter_w > 0) then
    update autorizacao_convenio_compl
    set dt_cancelamento = clock_timestamp(),
      nm_usuario_canc   = nm_usuario_p
    where nr_sequencia  = nr_seq_previous_letter_w;
  end if;

  select coalesce(max(ds_code),'Description not found')
  into STRICT ds_medicare_response_w
  from eclipse_status_codes
  where cd_code = medicare_status_code_p;

  select coalesce(max(ds_code),'Description not found')
  into STRICT ds_medicare_explanation_w
  from eclipse_status_codes
  where cd_code = medicare_explanation_code_p;

  select coalesce(max(ds_code),'Description not found')
  into STRICT ds_fund_explanation_w
  from eclipse_status_codes
  where cd_code    = fund_status_code_p;

  ds_observacao_w := substr(' Online Eligibility Report ' || chr(13) || chr(10) || 
							' Co-Payment Description: ' || co_payment_description_p || chr(13) || chr(10) || 
							' Excess Description: ' || excess_amount_description_p || chr(13) || chr(10) || 
							' Excess Bonus Amount:'  || excess_bonus_amount_p || chr(13) || chr(10) || 
							' Charge Amount: ' || charge_amount_p || chr(13) || chr(10) || 
							' Medicare Benefit Amount: ' || medicare_benefit_amount_p || chr(13) || chr(10) || 
							' Fund Benefit Amount: ' || fund_benefit_amount_p || chr(13) || chr(10) || 
							' Schedule Fee: ' || schedule_fee_p || chr(13) || chr(10) || 
							' Claim Fund Explanation: ' || claim_fund_explanation_code_p || ' - ' || claim_fund_explanationtext_p || chr(13) || chr(10) || 
							' Medicare Explanation: ' || medicare_explanation_code_p || ' - ' || ds_medicare_explanation_w || chr(13) || chr(10) || 
							' Medicare Status: ' || medicare_status_code_p || ' - ' || ds_medicare_response_w || chr(13) || chr(10) || 
							' Fund Status: ' || fund_status_code_p || ' - ' || ds_fund_explanation_w || chr(13) || chr(10) || 
							' Process Status: ' || process_status_cde_p || chr(13) || chr(10) || 
							' Exclusion Description: ' || exclusion_description_p || chr(13) || chr(10) || 
							' Benefit Limitations: ' ||  benefit_limitations_p || chr(13) || chr(10) || 
							' Financial Status: ' || financial_status_p,1,4000);
							
  select nextval('autorizacao_convenio_compl_seq')
  into STRICT nr_seq_aut_conv_compl_w
;
  insert
  into autorizacao_convenio_compl(
      nr_sequencia,
      dt_atualizacao,
      nm_usuario,
      dt_atualizacao_nrec,
      nm_usuario_nrec,
      nr_sinistro,
      nr_relatorio_renda,
      nr_documento,
      nr_documento_portal,
      pr_coseguro_hosp,
      pr_coseguro_honor,
      vl_deduzivel,
      vl_autorizado,
      ie_modalidade,
      ie_tipo,
      ds_observacao,
      dt_liberacao,
      nm_usuario_lib,
      dt_cancelamento,
      nm_usuario_canc,
      nr_sequencia_autor,
      nr_reclamacao
    )
    values (
      nr_seq_aut_conv_compl_w,
      clock_timestamp(),
      nm_usuario_p,
      clock_timestamp(),
      nm_usuario_p,
      invoice_id_p, --nr_sinistro / eligibility
      null,
      oec_id_p,               --nr_documento / document no.
      account_reference_id_p, -- nr_documento_portal /portal document no.
      null,
      null,
      null,
      null,
      'E',             -- ie_modalidade
      'C',             -- ie_tipo
      ds_observacao_w, -- ds_observacao
      clock_timestamp(),         --dt_liberacao
      nm_usuario_p,    --nm_usuario_lib
      null,
      null,
      authorization_id, --nr_sequencia_autor
      null
    );
  -- coPayment
  if (co_payment_amount_p > 0) then
    begin
      insert
      into autorizacao_conv_deducao(
          nr_sequencia,
          dt_atualizacao,
          nm_usuario,
          dt_atualizacao_nrec,
          nm_usuario_nrec,
          ie_tipo_calculo,
          pr_informado_calculo,
          vl_informado_calculo,
          nr_seq_auto_conv_compl
        )
        values (
          nextval('autorizacao_conv_deducao_seq'),
          clock_timestamp(),
          nm_usuario_p,
          clock_timestamp(),
          nm_usuario_p,
          'C',
          null,
          co_payment_amount_p,
          nr_seq_aut_conv_compl_w
        );
    end;
  end if;
  -- Excess-
  if (excess_amount_p > 0) then
    begin
      insert
      into autorizacao_conv_deducao(
          nr_sequencia,
          dt_atualizacao,
          nm_usuario,
          dt_atualizacao_nrec,
          nm_usuario_nrec,
          ie_tipo_calculo,
          pr_informado_calculo,
          vl_informado_calculo,
          nr_seq_auto_conv_compl
        )
        values (
          nextval('autorizacao_conv_deducao_seq'),
          clock_timestamp(),
          nm_usuario_p,
          clock_timestamp(),
          nm_usuario_p,
          'E',
          null,
          excess_amount_p,
          nr_seq_aut_conv_compl_w
        );
    end;
  end if;
  begin
    if ((financial_status_p = 'Y') or (process_status_cde_p = 'COMPLETE')) then
		
      select max(nr_sequencia)
      into STRICT nr_seq_estagio_w
      from estagio_autorizacao
      where ie_situacao = 'A'
      and ie_interno    = 66;
	
      update autorizacao_convenio
      set nr_seq_estagio = nr_seq_estagio_w,
        nm_usuario       = 'DCInterface',
        dt_atualizacao   = clock_timestamp(),
        dt_retorno       = clock_timestamp()
      where nr_sequencia = authorization_id;
	
    else
      select max(nr_sequencia)
      into STRICT nr_seq_estagio_w
      from estagio_autorizacao
      where ie_situacao = 'A'
      and ie_interno    = 90;
	
      update autorizacao_convenio
      set nr_seq_estagio = nr_seq_estagio_w,
        nm_usuario       = 'DCInterface',
        dt_atualizacao   = clock_timestamp(),
        dt_retorno       = clock_timestamp()
      where nr_sequencia = authorization_id;
	
    end if;
  exception
  when others then
    null;
  end;

    begin
    
	select	nextval('oec_response_seq')
	into STRICT	nr_sequencia_w
	;
	
  insert  into oec_response(
      nr_sequencia,
      dt_atualizacao,
      nm_usuario,
      dt_atualizacao_nrec,
      nm_usuario_nrec,
      nr_seq_transaction,
      cd_status,
      nr_account,
      ds_benefit_lim,
      cd_clm_asses_fund,
      vl_co_pay,
      qt_co_pay_days_left,
      ds_co_pay,
      nm_first,
      cd_medicare_card,
      nr_patient_ref,
      vl_excess_amt,
      ds_excess_amt,
      vl_excess_bonus,
      ds_exclusion,
      cd_financial_status,
      cd_fund_ref,
      cd_fund_status,
      cd_medicare_status,
      ds_table_scale,
      ie_pea_indicator,
      cd_process_status,
      nm_table,
      ds_table,
      nr_voucher,
      nr_seq_authorization
    )
    values (
      nr_sequencia_w,
      clock_timestamp(),
      nm_usuario_p,
      clock_timestamp(),
      nm_usuario_p,
      null,
      null,
      null,
      substr(benefit_limitations_p,1,2000),
      claim_fund_assessment_cde_p,
      co_payment_amount_p,
      co_payment_days_remaining_p,
      substr(co_payment_description_p,1,500),
      null,
      null,
      null,
      excess_amount_p,
      substr(excess_amount_description_p,1,500),
      excess_bonus_amount_p,
      substr(exclusion_description_p,1,500),
      financial_status_p,
      fund_reference_id_p,
      fund_status_code_p,
      medicare_status_code_p,
      substr(table_scale_p,1,15),
      pea_potential_ind_p,
      process_status_cde_p,
      substr(table_name_p,1,80),
      substr(table_description_p,1,500),
      null,
      authorization_id);
	

  insert  into oec_service_resp(
    nr_sequencia,
    dt_atualizacao,
    nm_usuario,
    dt_atualizacao_nrec,
    nm_usuario_nrec,
    vl_charge,
    dt_service,
    vl_fund_benefit,
    cd_item,
    vl_med_amount,
    cd_med_exp,
    cd_service_fund,
    vl_service_fee,
    nr_seq_oec_resp,
    cd_service,
    cd_service_type,
    service_id
     )
    values (
      nextval('oec_service_resp_seq'),
      clock_timestamp(),
      nm_usuario_p,
      clock_timestamp(),
      nm_usuario_p,
      charge_amount_p,
      null,
      fund_benefit_amount_p,
      null,
      medicare_benefit_amount_p,
      medicare_explanation_code_p,
      service_fund_exp_code_p,
      schedule_fee_p,
      nr_sequencia_w,
      null,
      null,
      null);

	exception
	when others then
		null;
	end;	

	
  commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE bft_import_invoice_oec ( authorization_id bigint, oec_id_p bigint, invoice_id_p bigint, account_reference_id_p text, benefit_limitations_p text, claim_fund_assessment_cde_p text, co_payment_amount_p text, co_payment_days_remaining_p text, co_payment_description_p text, patient_first_name_p text, patient_medicare_card_p text, patient_reference_num_p text, excess_amount_p text, excess_amount_description_p text, excess_bonus_amount_p text, exclusion_description_p text, financial_status_p text, fund_reference_id_p text, fund_status_code_p text, medicare_status_code_p text, pea_potential_ind_p text, process_status_cde_p text, table_name_p text, table_description_p text, table_scale_p text, voucher_id_p text, claim_fund_explanation_code_p text, claim_fund_explanationtext_p text, charge_amount_p text, medicare_benefit_amount_p text, schedule_fee_p text, fund_benefit_amount_p text, medicare_explanation_code_p text, service_fund_assessment_code_p text, service_fund_exp_code_p text, service_fund_exp_text_p text, nm_usuario_p text) FROM PUBLIC;

