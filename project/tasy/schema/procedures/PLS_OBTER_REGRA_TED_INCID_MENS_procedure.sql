-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_regra_ted_incid_mens ( nr_seq_mensalidade_p bigint, nr_seq_regra_ted_p bigint, nr_seq_regra_p INOUT bigint) AS $body$
DECLARE


cd_cgc_estipulante_w		pessoa_juridica.cd_cgc%type;
ie_incide_lote_w		pls_ted_regra_mens_incid.ie_incide_lote%type	:= 'N';
nr_seq_pagador_w		pls_contrato_pagador.nr_sequencia%type;
nr_seq_contrato_w		pls_contrato.nr_sequencia%type;
nr_seq_intercambio_w		pls_intercambio.nr_sequencia%type;
ie_envia_cobranca_w		pls_contrato_pagador.ie_envia_cobranca%type;
cd_municipio_ibge_w		compl_pessoa_fisica.cd_municipio_ibge%type;
cd_cep_w			compl_pessoa_fisica.cd_cep%type;
nr_seq_destino_corresp_w	pls_contrato_pagador.nr_seq_destino_corresp%type;

C01 CURSOR(	nr_seq_regra_pc		pls_regra_ted.nr_sequencia%type,
		nr_seq_pagador_pc	pls_contrato_pagador.nr_sequencia%type,
		cd_cgc_estipulante_pc	pessoa_juridica.cd_cgc%type,
		ie_envia_cobranca_pc	pls_contrato_pagador.ie_envia_cobranca%type,
		cd_municipio_ibge_pc	sus_municipio.cd_municipio_ibge%type) FOR
	SELECT	a.ie_incide_lote,
		a.cd_cep_inicial,
		a.cd_cep_final
	from	pls_ted_regra_mens_incid	a
	where	a.nr_seq_regra_ted	= nr_seq_regra_pc
	and	((a.ie_tipo_estipulante = 'A') or (a.ie_tipo_estipulante = 'PF' and coalesce(cd_cgc_estipulante_pc::text, '') = '') or (a.ie_tipo_estipulante = 'PJ' and (cd_cgc_estipulante_pc IS NOT NULL AND cd_cgc_estipulante_pc::text <> '')))
	and	((a.cd_cgc_estipulante = cd_cgc_estipulante_pc) or (coalesce(a.cd_cgc_estipulante::text, '') = ''))
	and	((a.nr_seq_pagador = nr_seq_pagador_pc) or (coalesce(a.nr_seq_pagador::text, '') = ''))
	and	((a.ie_envia_cobranca = ie_envia_cobranca_pc) or (coalesce(a.ie_envia_cobranca::text, '') = ''))
	and (a.cd_municipio_ibge = cd_municipio_ibge_pc or coalesce(a.cd_municipio_ibge::text, '') = '')
	order by
		coalesce(a.ie_envia_cobranca, ' '),
		coalesce(a.cd_cgc_estipulante,' '),
		coalesce(a.nr_seq_pagador,0);

C02 CURSOR(	nr_seq_regra_pc			pls_regra_ted.nr_sequencia%type,
		nr_seq_pagador_pc		pls_contrato_pagador.nr_sequencia%type,
		cd_municipio_ibge_pc		sus_municipio.cd_municipio_ibge%type,
		nr_seq_destino_corresp_pc	pls_destino_corresp.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia,
		a.cd_cep_inicial,
		a.cd_cep_final
	from	pls_ted_regra_mens_excecao a
	where	a.nr_seq_regra_ted	= nr_seq_regra_pc
	and (a.nr_seq_pagador = nr_seq_pagador_pc or coalesce(a.nr_seq_pagador::text, '') = '')
	and (a.cd_municipio_ibge = cd_municipio_ibge_pc or coalesce(a.cd_municipio_ibge::text, '') = '')
	and (a.nr_seq_destino_corresp = nr_seq_destino_corresp_pc or coalesce(a.nr_seq_destino_corresp::text, '') = '')
	and (a.ie_sem_destino_corresp = 'N' or coalesce(nr_seq_destino_corresp_pc::text, '') = '');
BEGIN
select	a.nr_seq_pagador,
	b.nr_seq_contrato,
	b.nr_seq_pagador_intercambio,
	b.ie_envia_cobranca,
	pls_obter_compl_pagador(b.nr_sequencia,'IBGE') cd_municipio_ibge,
	pls_obter_compl_pagador(b.nr_sequencia,'CEP') cd_cep,
	b.nr_seq_destino_corresp
into STRICT	nr_seq_pagador_w,
	nr_seq_contrato_w,
	nr_seq_intercambio_w,
	ie_envia_cobranca_w,
	cd_municipio_ibge_w,
	cd_cep_w,
	nr_seq_destino_corresp_w
from	pls_mensalidade	a,
	pls_contrato_pagador b
where	b.nr_sequencia	= a.nr_seq_pagador
and	a.nr_sequencia	= nr_seq_mensalidade_p;

if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then
	select	max(a.cd_cgc_estipulante)
	into STRICT	cd_cgc_estipulante_w
	from	pls_contrato	a
	where	a.nr_sequencia	= nr_seq_contrato_w;
elsif (nr_seq_intercambio_w IS NOT NULL AND nr_seq_intercambio_w::text <> '') then
	select	max(cd_cgc)
	into STRICT	cd_cgc_estipulante_w
	from	pls_intercambio
	where	nr_sequencia	= nr_seq_intercambio_w;
end if;

for r_c01_w in C01(nr_seq_regra_ted_p, nr_seq_pagador_w, cd_cgc_estipulante_w, ie_envia_cobranca_w, cd_municipio_ibge_w) loop
	begin
	if (coalesce(r_c01_w.cd_cep_inicial::text, '') = '' and coalesce(r_c01_w.cd_cep_final::text, '') = '') or ((cd_cep_w IS NOT NULL AND cd_cep_w::text <> '') and (somente_numero(cd_cep_w))::numeric  between (somente_numero(coalesce(r_c01_w.cd_cep_inicial,cd_cep_w)))::numeric  and (somente_numero(coalesce(r_c01_w.cd_cep_final,cd_cep_w)))::numeric ) then
		ie_incide_lote_w	:= r_c01_w.ie_incide_lote;
	end if;
	end;
end loop;

if (ie_incide_lote_w = 'S') then --Buscar se existe alguma regra de exceção
	for r_c02_w in C02(nr_seq_regra_ted_p, nr_seq_pagador_w, cd_municipio_ibge_w, nr_seq_destino_corresp_w) loop
		begin
		if (coalesce(r_c02_w.cd_cep_inicial::text, '') = '' and coalesce(r_c02_w.cd_cep_final::text, '') = '') or ((cd_cep_w IS NOT NULL AND cd_cep_w::text <> '') and (somente_numero(cd_cep_w))::numeric  between (somente_numero(coalesce(r_c02_w.cd_cep_inicial,cd_cep_w)))::numeric  and (somente_numero(coalesce(r_c02_w.cd_cep_final,cd_cep_w)))::numeric ) then
			ie_incide_lote_w	:= 'N';
		end if;
		end;
	end loop;
end if;

if (ie_incide_lote_w = 'S') then
	nr_seq_regra_p	:= nr_seq_regra_ted_p;
else
	nr_seq_regra_p	:= null;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_regra_ted_incid_mens ( nr_seq_mensalidade_p bigint, nr_seq_regra_ted_p bigint, nr_seq_regra_p INOUT bigint) FROM PUBLIC;

