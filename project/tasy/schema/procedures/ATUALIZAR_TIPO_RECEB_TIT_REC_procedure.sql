-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_tipo_receb_tit_rec (nr_interno_conta_p bigint, nr_seq_protocolo_p bigint, cd_tipo_recebimento_p text, nm_usuario_p text, nr_seq_lote_prot_p bigint default 0) AS $body$
DECLARE


cd_estabelecimento_w			smallint;
nr_titulo_w				numeric(10,0)		:= 0;
vl_vencimento_w				double precision		:= 0;
dt_emissao_p				timestamp;
dt_vencimento_w				timestamp;
cd_pessoa_fisica_w			varchar(10);
cd_cgc_w				varchar(14);
ie_tipo_titulo_w			varchar(5);
ie_situacao_w				varchar(1);
nr_nota_fiscal_w			varchar(255);
ie_integracao_nota_w			varchar(1);
cd_estab_usuario_w			integer := coalesce(wheb_usuario_pck.get_cd_estabelecimento,0);

c01 CURSOR FOR
	SELECT	cd_estabelecimento,
		nr_titulo,
		dt_emissao,
		dt_vencimento,
		cd_pessoa_fisica,
		cd_cgc,
		ie_tipo_titulo,
		ie_situacao,
		nr_nota_fiscal,
		coalesce(vl_titulo,0)
	from	titulo_receber
	where	((nr_interno_conta	= nr_interno_conta_p) or (nr_seq_protocolo	= nr_seq_protocolo_p and nr_seq_lote_prot_p = 0) or (nr_seq_lote_prot	= nr_seq_lote_prot_p));


BEGIN

update	 titulo_receber
set	cd_tipo_recebimento	= cd_tipo_recebimento_p
where	coalesce(cd_tipo_recebimento::text, '') = ''
and	((nr_interno_conta	= nr_interno_conta_p) or (nr_seq_protocolo	= nr_seq_protocolo_p and nr_seq_lote_prot_p = 0) or (nr_seq_lote_prot	= nr_seq_lote_prot_p));

select 	coalesce(max(ie_integracao_titulo),'X')
into STRICT 	ie_integracao_nota_w
from 	parametro_contas_receber
where	cd_estabelecimento = cd_estab_usuario_w;

if (ie_integracao_nota_w = 'P') then
	begin

	open c01;
	loop
	fetch c01 into
		cd_estabelecimento_w,
		nr_titulo_w,
		dt_emissao_p,
		dt_vencimento_w,
		cd_pessoa_fisica_w,
		cd_cgc_w,
		ie_tipo_titulo_w,
		ie_situacao_w,
		nr_nota_fiscal_w,
		vl_vencimento_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		CALL exec_sql_dinamico('Tasy','begin pir_importar_titulo_receber('
				|| coalesce(nr_interno_conta_p,0) || ','
				|| coalesce(nr_seq_protocolo_p,0) || ','
				|| cd_estabelecimento_w || ','
				|| nr_titulo_w || ','
				|| chr(39) || vl_vencimento_w || chr(39) || ','
				|| chr(39) || dt_emissao_p || chr(39) || ','
				|| chr(39) || dt_vencimento_w || chr(39) || ','
				|| chr(39) || coalesce(cd_pessoa_fisica_w,'X')  || chr(39) || ','
				|| chr(39) || coalesce(cd_cgc_w,'X') || chr(39) || ','
				|| chr(39) || ie_tipo_titulo_w || chr(39) || ','
				|| chr(39) || ie_situacao_w || chr(39) || ','
				|| chr(39) || nr_nota_fiscal_w || chr(39) || ','
				|| chr(39) || cd_tipo_recebimento_p || chr(39) || ','
				|| chr(39) || nm_usuario_p || chr(39) || '); end;');

	end loop;
	close c01;

	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_tipo_receb_tit_rec (nr_interno_conta_p bigint, nr_seq_protocolo_p bigint, cd_tipo_recebimento_p text, nm_usuario_p text, nr_seq_lote_prot_p bigint default 0) FROM PUBLIC;

