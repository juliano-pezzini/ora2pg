-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insere_laudo_paciente_pdf (nr_prescricao_p bigint, nr_sequencia_prescricao_p bigint, cd_medico_p text, qt_imagem_p bigint, ds_caminho_arquivo_p text, nm_usuario_p text, ds_titulo_laudo_p text) AS $body$
DECLARE


  cd_setor_execucao_w               procedimento_paciente.cd_setor_atendimento%type;
  nr_atendimento_w                  procedimento_paciente.nr_atendimento%type;
  nr_seq_proced_w                   procedimento_paciente.nr_sequencia%type;
  cd_pessoa_fisica_w                prescr_medica.cd_pessoa_fisica%type;
  nm_usuario_medico_w               usuario.nm_usuario%type;
  nr_laudo_w                        bigint;
  nr_sequencia_laudo_paciente_w     bigint;
  dt_procedimento_w                 timestamp;
  ie_html varchar(1);

  
BEGIN
    select obter_usuario_pessoa(cd_medico_p)
    into STRICT nm_usuario_medico_w
;

    if (coalesce(nm_usuario_medico_w::text, '') = '') then
      CALL wheb_mensagem_pck.exibir_mensagem_abort(1026067);
    end if;

    select nextval('laudo_paciente_seq') 
    into STRICT   nr_sequencia_laudo_paciente_w 
;
    
    select max(nr_sequencia)
    into STRICT   nr_seq_proced_w
    from   procedimento_paciente
    left join conta_paciente on procedimento_paciente.nr_interno_conta = conta_paciente.nr_interno_conta 
    where  coalesce(conta_paciente.ie_cancelamento, 'N') = 'N' 
    and nr_prescricao = nr_prescricao_p
    and procedimento_paciente.qt_procedimento > 0 
    and nr_sequencia_prescricao = nr_sequencia_prescricao_p;

    select a.dt_procedimento, cd_setor_atendimento, nr_atendimento
    into STRICT   dt_procedimento_w, cd_setor_execucao_w, nr_atendimento_w
    from   procedimento_paciente a 
    where  a.nr_sequencia = nr_seq_proced_w;

    select coalesce(max(nr_laudo), 0) + 1 
    into STRICT   nr_laudo_w 
    from   laudo_paciente 
    where  nr_atendimento = nr_atendimento_w;
    
    select max(cd_pessoa_fisica) 
    into STRICT   cd_pessoa_fisica_w 
    from   prescr_medica 
    where  nr_prescricao = nr_prescricao_p;
    
    
    insert into 
    laudo_paciente(nr_sequencia, 
                    ds_laudo, 
                    dt_entrada_unidade, 
                    nr_laudo, 
                    nm_usuario, 
                    dt_atualizacao, 
                    qt_imagem, 
                    nr_seq_proc, 
                    nr_prescricao, 
                    nr_seq_prescricao, 
                    nr_atendimento, 
                    dt_exame, 
                    nm_usuario_digitacao, 
                    nm_usuario_aprovacao,
                    nm_usuario_liberacao,
                    dt_inicio_digitacao, 
                    dt_laudo,
                    dt_aprovacao,
                    dt_liberacao,
                    dt_fim_digitacao,
                    cd_pessoa_fisica, 				
                    cd_setor_execucao,
                    ds_arquivo,
                    ie_formato,
                    cd_medico_resp,
                    ds_titulo_laudo) 
    SELECT nr_sequencia_laudo_paciente_w, 
           'LAUDO EM PDF',
           dt_entrada_unidade, 
           nr_laudo_w, 
           nm_usuario_p, 
           clock_timestamp(), 
           qt_imagem_p, 
           nr_sequencia, 
           nr_prescricao, 
           nr_sequencia_prescricao, 
           nr_atendimento, 
           dt_procedimento_w, 
           nm_usuario_medico_w, 
           nm_usuario_medico_w, 
           nm_usuario_medico_w, 
           clock_timestamp(), 
           clock_timestamp(), 
           clock_timestamp(),
           clock_timestamp(),
           clock_timestamp(),
           cd_pessoa_fisica_w, 			 
           cd_setor_execucao_w,
           ds_caminho_arquivo_p,
           3,
           cd_medico_p,
           ds_titulo_laudo_p
    from   procedimento_paciente 
    where  nr_sequencia = nr_seq_proced_w;

    update procedimento_paciente 
    set    nr_laudo = nr_sequencia_laudo_paciente_w
    where  nr_prescricao = nr_prescricao_p
    and nr_sequencia_prescricao = nr_sequencia_prescricao_p;
    
    update prescr_procedimento
    set    ie_status_execucao = '40',
           nm_usuario         = nm_usuario_p
    where  nr_prescricao = nr_prescricao_p
    and    nr_sequencia = nr_sequencia_prescricao_p;

    If (Obter_Funcao_Ativa = 99010) Then
       Ie_Html := 'S';
    Else
      Ie_Html := 'N';
    End If;

    CALL Autorizacao_Laudo_Mmed(Nr_Sequencia_Laudo_Paciente_W, 1, Nm_Usuario_P, Nm_Usuario_P , null, 1 ,Obter_Estabelecimento_Ativo,  Ie_Html);
    
    commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insere_laudo_paciente_pdf (nr_prescricao_p bigint, nr_sequencia_prescricao_p bigint, cd_medico_p text, qt_imagem_p bigint, ds_caminho_arquivo_p text, nm_usuario_p text, ds_titulo_laudo_p text) FROM PUBLIC;

