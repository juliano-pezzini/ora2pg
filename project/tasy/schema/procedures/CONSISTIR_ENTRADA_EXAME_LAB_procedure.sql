-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_entrada_exame_lab ( nr_sequencia_p bigint, ie_tipo_p bigint, ds_parametro1 text, ds_parametro2 text, ds_parametro3 text, ds_retorno_p INOUT text) AS $body$
DECLARE


/* IE_TIPO_P
1 - Imprimir etiqueta (Pasta Ficha)
2 - Verifica campos obrigatórios (Pasta Ficha) + Tratamento da regra lote_ent_regra (Pasta Ficha)
*/
cd_material_w			material_exame_lab.cd_material_exame%type;
ds_retorno_w			varchar(2000);

ie_npp_f_w				lote_ent_sec_ficha.ie_npp_f%type;
dt_nascimento_f_w		lote_ent_sec_ficha.dt_nascimento_f%type;
dt_coleta_ficha_f_w		lote_ent_sec_ficha.dt_coleta_ficha_f%type;
qt_peso_f_w				lote_ent_sec_ficha.qt_peso_f%type;
ie_premat_s_f_w			lote_ent_sec_ficha.ie_premat_s_f%type;
ie_transfusao_f_w		lote_ent_sec_ficha.ie_transfusao_f%type;
nr_idade_gest_f_w		lote_ent_sec_ficha.nr_idade_gest_f%type;
cd_usuario_conv_ext_w	lote_ent_sec_ficha.cd_usuario_conv_ext%type;
cd_prontuario_f_w		lote_ent_sec_ficha.cd_prontuario_f%type;
nr_pront_externo_w		lote_ent_sec_ficha.nr_prontuario_ex%type;
nr_cartao_sus_w			lote_ent_sec_ficha.nr_cartao_nac_sus%type;

cd_convenio_w			lote_ent_inst_geracao.cd_convenio%type;
cd_instituicao_w		lote_ent_inst_geracao.nr_seq_instituicao%type;
cd_setor_atend_w		lote_ent_inst_geracao.cd_setor_atendimento%type;

ie_cns_w				lote_ent_regra.ie_cns%type;
ie_prontuario_w			lote_ent_regra.ie_prontuario%type;
ie_cod_conv_w			lote_ent_regra.ie_cod_conv%type;
ie_cod_instituicao_w	lote_ent_regra.ie_cod_instituicao%type;
ie_pront_ext_w			lote_ent_regra.ie_pront_ext%type;
ie_cod_sus_w			lote_ent_regra.ie_cod_sus%type;
ie_cd_setor_w			lote_ent_regra.ie_cd_setor%type;

/*Variáveis de consistência OS 627674*/

cd_pessoa_fisica_w		lote_ent_sec_ficha.cd_pessoa_fisica%type;
nm_mae_f_w				lote_ent_sec_ficha.nm_mae_f%type;
cd_dnv_f_w				lote_ent_sec_ficha.cd_dnv_f%type;
ds_cidade_w				varchar(255);

ie_possui_mae_f_w		varchar(1);
ie_possui_dt_nasc_w		varchar(1);
ie_possui_dnv_f_w		varchar(1);
ie_possui_instituicao_w	varchar(1);
ie_possui_prontuario_w	varchar(1);
ie_possui_cidade_w		varchar(1);


BEGIN

if (ie_tipo_p = 1) then
	select	CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
	into STRICT	ds_retorno_w
	from	lote_ent_secretaria a,
			lote_ent_sec_ficha b,
			lote_ent_inst_mat_alert c
	where	1=1
	and		a.nr_sequencia 		= b.nr_seq_lote_sec
	and		a.nr_seq_instituicao 	= c.nr_seq_instituicao
	and		b.nr_sequencia 		= nr_sequencia_p;

elsif (ie_tipo_p = 2) then

	select	max(a.ie_npp_f),
			max(a.dt_nascimento_f),
			max(a.dt_coleta_ficha_f),
			max(a.qt_peso_f),
			max(a.ie_premat_s_f),
			max(a.ie_transfusao_f),
			max(a.nr_idade_gest_f),
			max(a.cd_pessoa_fisica),
			max(a.NM_MAE_F),
			max(a.cd_dnv_f),
			max(substr(obter_compl_pf(a.cd_pessoa_fisica, 1, 'CI'),1,100))
	into STRICT	ie_npp_f_w,
			dt_nascimento_f_w,
			dt_coleta_ficha_f_w,
			qt_peso_f_w,
			ie_premat_s_f_w,
			ie_transfusao_f_w,
			nr_idade_gest_f_w,
			cd_pessoa_fisica_w,
			nm_mae_f_w,
			cd_dnv_f_w,
			ds_cidade_w
	from	lote_ent_sec_ficha a
	where	a.nr_sequencia = nr_sequencia_p;

	if (coalesce(ie_npp_f_w::text, '') = '') then
		ds_retorno_w	:= ds_retorno_w||';'||obter_desc_expressao(608235)||' '||obter_desc_expressao(650882)||' '||obter_desc_expressao(294294);
	end if;

	if (coalesce(dt_nascimento_f_w::text, '') = '') then
		ds_retorno_w	:= ds_retorno_w||';'||obter_desc_expressao(759222);
	end if;

	if (coalesce(dt_coleta_ficha_f_w::text, '') = '') then
		ds_retorno_w	:= ds_retorno_w||';'||obter_desc_expressao(561235);
	end if;

	if (coalesce(qt_peso_f_w::text, '') = '') then
		ds_retorno_w	:= ds_retorno_w||';'||obter_desc_expressao(295720);
	end if;

	if (coalesce(ie_premat_s_f_w::text, '') = '') then
		ds_retorno_w	:= ds_retorno_w||';'||obter_desc_expressao(310414);
	end if;

	if (coalesce(ie_transfusao_f_w::text, '') = '') then
		ds_retorno_w	:= ds_retorno_w||';'||obter_desc_expressao(300409);
	end if;

	if (coalesce(nr_idade_gest_f_w::text, '') = '') then
		ds_retorno_w	:= ds_retorno_w||';'||obter_desc_expressao(608240);
	end if;

	select	max(c.ie_cns),
			max(c.ie_prontuario),
			max(c.ie_cod_conv),
			max(c.ie_cod_instituicao),
			max(c.ie_pront_ext),
			max(c.ie_cod_sus),
			max(c.ie_cd_setor)
	into STRICT	ie_cns_w,
	        ie_prontuario_w,
	        ie_cod_conv_w,
	        ie_cod_instituicao_w,
			ie_pront_ext_w,
			ie_cod_sus_w,
			ie_cd_setor_w
	from	lote_ent_secretaria a,
			lote_ent_sec_ficha b,
			lote_ent_regra c
	where	1=1
	and		a.nr_sequencia 		= b.nr_seq_lote_sec
	and		a.nr_seq_instituicao 	= c.nr_seq_instituicao
	and		b.nr_sequencia 		= nr_sequencia_p;

	--paciente (cd_pessoa_fisica_w), nome da mãe (nm_mae_f_w), data de nascimento (dt_nascimento_f_w), DNV (cd_dnv_f_w), Instituição (cd_instituicao_w), Prontuário (cd_prontuario_f_w) e Cidade.
	SELECT	MAX(a.cd_usuario_conv_ext),
			MAX(a.cd_prontuario_f),
			MAX(c.cd_convenio),
			MAX(b.nr_seq_instituicao),
			MAX(a.nr_prontuario_ex),
			MAX(a.nr_cartao_nac_sus),
			max(c.cd_setor_atendimento)
	INTO STRICT	cd_usuario_conv_ext_w,
			cd_prontuario_f_w,
			cd_convenio_w,
			cd_instituicao_w,
			nr_pront_externo_w,
			nr_cartao_sus_w,
			cd_setor_atend_w
	FROM	lote_ent_sec_ficha a,
			lote_ent_secretaria b,
			lote_ent_inst_geracao c
	WHERE	a.nr_sequencia = nr_sequencia_p
	AND		a.nr_seq_lote_sec = b.nr_sequencia
	AND		b.nr_seq_instituicao = c.nr_seq_instituicao;

	if (ie_cns_w = 'S') and (coalesce(cd_usuario_conv_ext_w::text, '') = '') then
		ds_retorno_w	:= ds_retorno_w||';'||obter_desc_expressao(790811);
	end if;

	if (ie_prontuario_w = 'S') and (coalesce(cd_prontuario_f_w::text, '') = '') then
		ds_retorno_w	:= ds_retorno_w||';'||obter_desc_expressao(747846);
	end if;

	if (ie_cod_conv_w = 'S') and (coalesce(cd_convenio_w::text, '') = '') then
		ds_retorno_w	:= ds_retorno_w||';'||obter_desc_expressao(487426);
	end if;

	if (ie_cod_instituicao_w = 'S') and (coalesce(cd_instituicao_w::text, '') = '') then
		ds_retorno_w	:= ds_retorno_w||';'||obter_desc_expressao(762401);
	end if;

	if (ie_pront_ext_w = 'S') and (coalesce(nr_pront_externo_w::text, '') = '') then
		ds_retorno_w	:= ds_retorno_w||';'||obter_desc_expressao(296551);
	end if;

	if (ie_cod_sus_w = 'S') and (coalesce(nr_cartao_sus_w::text, '') = '') then
		ds_retorno_w	:= ds_retorno_w||';'||obter_desc_expressao(604707);
	end if;

	if (ie_cd_setor_w = 'S') and (coalesce(cd_setor_atend_w::text, '') = '') then
		ds_retorno_w	:= ds_retorno_w||';'||obter_desc_expressao(630277);
	end if;


	/*Consistências via select para verificar se já existem na base fichas com estes dados*/

	if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and (cd_instituicao_w IS NOT NULL AND cd_instituicao_w::text <> '') then

	-- Mesma pessoa física na mesma instituição;
		select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_possui_instituicao_w
		FROM	lote_ent_sec_ficha a,
				lote_ent_secretaria b,
				lote_ent_inst_geracao c
		WHERE	a.nr_sequencia <> nr_sequencia_p
		and		a.cd_pessoa_fisica = cd_pessoa_fisica_w
		AND		a.nr_seq_lote_sec = b.nr_sequencia
		AND		b.nr_seq_instituicao = c.nr_seq_instituicao
		and		b.nr_seq_instituicao = cd_instituicao_w;

		if (ie_possui_instituicao_w = 'S') then
			ds_retorno_w	:= ds_retorno_w||';'||obter_desc_expressao(779573);
		end if;

	end if;

	if (nm_mae_f_w IS NOT NULL AND nm_mae_f_w::text <> '') and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then

	-- Mesmo nome de pessoa fisica e mesma mãe em mais de uma ficha;
		select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_possui_mae_f_w
		from	lote_ent_sec_ficha
		where	upper(trim(both nm_mae_f)) = upper(trim(both nm_mae_f_w))
		and		nr_sequencia <> nr_sequencia_p
		and		cd_pessoa_fisica = cd_pessoa_fisica_w;

		if (ie_possui_mae_f_w = 'S') then
			ds_retorno_w	:= ds_retorno_w||';'||obter_desc_expressao(779575);
		end if;

	end if;

	if (dt_nascimento_f_w IS NOT NULL AND dt_nascimento_f_w::text <> '') and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then

	-- Mesmo nome de pessoa física com mesma data de nascimento em mais de uma ficha;
		select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_possui_dt_nasc_w
		from	lote_ent_sec_ficha
		where	dt_nascimento_f  = dt_nascimento_f_w
		and		cd_pessoa_fisica = cd_pessoa_fisica_w
		and		nr_sequencia <> nr_sequencia_p;

		if (ie_possui_dt_nasc_w = 'S') then
			ds_retorno_w	:= ds_retorno_w||';'||obter_desc_expressao(779579);
		end if;

	end if;

	if (cd_dnv_f_w IS NOT NULL AND cd_dnv_f_w::text <> '') then

	-- Mesma DNV independente da instituição;
		select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_possui_dnv_f_w
		from	lote_ent_sec_ficha
		where	cd_dnv_f  = cd_dnv_f_w
		and		nr_sequencia <> nr_sequencia_p;

		if (ie_possui_dnv_f_w = 'S') then
			ds_retorno_w	:= ds_retorno_w||';'||obter_desc_expressao(779567);
		end if;

	end if;

	if (cd_prontuario_f_w IS NOT NULL AND cd_prontuario_f_w::text <> '') and (cd_instituicao_w IS NOT NULL AND cd_instituicao_w::text <> '') then

	-- Mesmo prontuário na mesma instituição;
		select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_possui_prontuario_w
		FROM	lote_ent_sec_ficha a,
				lote_ent_secretaria b,
				lote_ent_inst_geracao c
		WHERE	a.nr_sequencia <> nr_sequencia_p
		and		a.cd_prontuario_f = cd_prontuario_f_w
		AND		a.nr_seq_lote_sec = b.nr_sequencia
		AND		b.nr_seq_instituicao = c.nr_seq_instituicao
		and		b.nr_seq_instituicao = cd_instituicao_w;

		if (ie_possui_prontuario_w = 'S') then
			ds_retorno_w	:= ds_retorno_w||';'||obter_desc_expressao(779569);
		end if;

	end if;

	if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and (cd_instituicao_w IS NOT NULL AND cd_instituicao_w::text <> '') then

		-- Mesmo nome de pessoa física na mesma cidade em mais de uma ficha.
		select 	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_possui_cidade_w
		from	lote_ent_sec_ficha
		where	cd_pessoa_fisica  = cd_pessoa_fisica_w
		and		upper(trim(both ds_cidade_w)) = upper(trim(both substr(obter_compl_pf(cd_pessoa_fisica, 1, 'CI'),1,100)))
		and		nr_sequencia <> nr_sequencia_p;

		if (ie_possui_cidade_w = 'S') then
			ds_retorno_w	:= ds_retorno_w||';'||obter_desc_expressao(779571);
		end if;

	end if;

	if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
		ds_retorno_w	:= substr(ds_retorno_w,2,255);
	end if;

end if;

ds_retorno_p	:= ds_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_entrada_exame_lab ( nr_sequencia_p bigint, ie_tipo_p bigint, ds_parametro1 text, ds_parametro2 text, ds_parametro3 text, ds_retorno_p INOUT text) FROM PUBLIC;

