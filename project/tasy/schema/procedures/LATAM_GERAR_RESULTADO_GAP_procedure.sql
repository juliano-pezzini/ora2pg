-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE latam_gerar_resultado_gap (nr_seq_parametro_p bigint, nm_usuario_p text) AS $body$
DECLARE


pr_teste_unitario_w 		bigint;
pr_teste_vv_w 			bigint;
vl_lavanderia_w 		double precision;
pr_fracao_homem_hora_w 		bigint;
nr_meses_manut_hc_w 		bigint;
qt_horas_trabalhada_w 		bigint;
nr_viagem_programada_w 		bigint;
pr_frac_homem_hora_vv_w 	bigint;
qt_periodo_testes_w 		bigint;
qt_periodo_desenv_w 		bigint;
vl_conversao_moeda_w 		double precision;
vl_passagem_w 			double precision;
vl_hospedagem_w 		double precision;
vl_transporte_w 		double precision;
vl_alimentacao_w 		double precision;
pr_valor_documentacao_w 	bigint;
pr_ajuste_manutencao_w 		bigint;
cd_moeda_w 			bigint;
vl_homem_hora_w 		double precision;
pr_desenvolvimento_w		bigint;
nr_seq_gap_w			bigint;
qt_head_count_man_w		bigint;
vl_ajustado_w			bigint;
vl_hora_ajustada_w		double precision;
vl_hora_gap_w			bigint;
vl_total_gap_w			double precision;
qt_head_count_rd_w		bigint;
qt_head_count_vv_w   		bigint;
vl_desenvolvimento_w 		double precision;
vl_documentacao_w    		double precision;
vl_teste_unitario_w  		double precision;
vl_teste_vv_w	     		double precision;
qt_registro_w			bigint;



BEGIN

select 	pr_teste_unitario,
	pr_teste_vv,
	vl_lavanderia,
	pr_fracao_homem_hora,
	nr_meses_manut_hc,
	qt_horas_trabalhada,
	nr_viagem_programada,
	pr_frac_homem_hora_vv,
	qt_periodo_testes,
	qt_periodo_desenv,
	vl_conversao_moeda,
	vl_passagem,
	vl_hospedagem,
	vl_transporte,
	vl_alimentacao,
	pr_valor_documentacao,
	pr_ajuste_manutencao,
	cd_moeda,
	vl_homem_hora,
	pr_desenvolvimento,
	nr_seq_gap
into STRICT	pr_teste_unitario_w,
	pr_teste_vv_w,
	vl_lavanderia_w,
	pr_fracao_homem_hora_w,
	nr_meses_manut_hc_w,
	qt_horas_trabalhada_w,
	nr_viagem_programada_w,
	pr_frac_homem_hora_vv_w,
	qt_periodo_testes_w,
	qt_periodo_desenv_w,
	vl_conversao_moeda_w,
	vl_passagem_w,
	vl_hospedagem_w,
	vl_transporte_w,
	vl_alimentacao_w,
	pr_valor_documentacao_w,
	pr_ajuste_manutencao_w,
	cd_moeda_w,
	vl_homem_hora_w,
	pr_desenvolvimento_w,
	nr_seq_gap_w
from	latam_parametros
where	nr_sequencia = nr_seq_parametro_p;


vl_hora_gap_w	    :=	latam_obter_dados_gap(nr_seq_gap_w,'H');
vl_total_gap_w	    :=	latam_obter_dados_gap(nr_seq_gap_w,'V') / vl_conversao_moeda_w;

vl_ajustado_w	    :=  (vl_total_gap_w + (vl_total_gap_w * pr_ajuste_manutencao_w/100));
vl_hora_ajustada_w  := 	vl_hora_gap_w  + (vl_hora_gap_w * pr_ajuste_manutencao_w/100);

qt_head_count_man_w  :=  (vl_hora_ajustada_w * pr_fracao_homem_hora_w)/100;
qt_head_count_man_w  :=  qt_head_count_man_w /coalesce(qt_horas_trabalhada_w,1)/coalesce(nr_meses_manut_hc_w,1);
qt_head_count_rd_w   :=  vl_hora_ajustada_w/coalesce(qt_horas_trabalhada_w,1)/coalesce(qt_periodo_desenv_w,1);

qt_head_count_vv_w   := (vl_hora_ajustada_w * pr_frac_homem_hora_vv_w/100);
qt_head_count_vv_w   := qt_head_count_vv_w * pr_fracao_homem_hora_w/100;
qt_head_count_vv_w   := qt_head_count_vv_w /coalesce(qt_horas_trabalhada_w,1)/coalesce(qt_periodo_testes_w,1);

vl_desenvolvimento_w :=  (vl_ajustado_w * pr_desenvolvimento_w/100);
vl_documentacao_w    :=  (vl_ajustado_w * pr_valor_documentacao_w/100);
vl_teste_unitario_w  :=  (vl_ajustado_w * pr_teste_unitario_w/100);
vl_teste_vv_w	     :=  (vl_ajustado_w * pr_teste_vv_w/100);


select	count(*)
into STRICT	qt_registro_w
from	latam_resumo_gap
where	nr_seq_parametro = nr_seq_parametro_p;

if qt_registro_w > 0 then
	delete
	from 	latam_resumo_gap
	where	nr_seq_parametro = nr_seq_parametro_p;
end if;

insert into latam_resumo_gap(NR_SEQUENCIA,
				DT_ATUALIZACAO,
				NM_USUARIO,
				DT_ATUALIZACAO_NREC,
				NM_USUARIO_NREC,
				VL_TESTE_UNITARIO,
				VL_TESTE_VV,
				VL_DESENVOLVIMENTO,
				QT_HEAD_COUNT_MAN,
				QT_HEAD_COUNT_VV,
				QT_HEAD_COUNT_RD,
				VL_DOCUMENTACAO,
				NR_SEQ_PARAMETRO,
				VL_AJUSTADO,
				VL_TOTAL_MODULOS,
				VL_TOTAL_HORAS,
				VL_HORA_AJUSTADA)
values (nextval('latam_resumo_gap_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				vl_teste_unitario_w,
				vl_teste_vv_w,
				vl_desenvolvimento_w,
				qt_head_count_man_w,
				qt_head_count_vv_w,
				qt_head_count_rd_w,
				vl_documentacao_w,
				nr_seq_parametro_p,
				vl_ajustado_w,
				vl_total_gap_w,
				vl_hora_gap_w,
				vl_hora_ajustada_w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE latam_gerar_resultado_gap (nr_seq_parametro_p bigint, nm_usuario_p text) FROM PUBLIC;

