-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gedipa_gerar_proc_instantaneo ( nr_prescricao_p bigint, nr_sequencia_p bigint, nr_seq_solucao_p bigint, nr_seq_horario_p bigint) AS $body$
DECLARE


nr_atendimento_w		bigint;
dt_horario_w			timestamp;
nr_seq_processo_w		bigint;
nr_prescricao_w			bigint;
nr_seq_solucao_w		integer;
nr_etapa_w				smallint;
nr_seq_processo_agora_w	bigint;
cd_local_estoque_w		smallint;
cd_setor_prescr_w		bigint;
nr_seq_processo_nut_w	bigint;
ie_trans_proc_gedipa_w	varchar(1);
ie_gerar_proc_frac_sol_w varchar(1);
ie_separar_proc_area_w	varchar(1);
nr_seq_area_prep_w		bigint;
ds_erro_w				varchar(1800);
cd_estabelecimento_w	smallint;
ie_grava_log_gedipa_w	parametros_farmacia.ie_grava_log_gedipa%type;


c01 REFCURSOR;


c02 REFCURSOR;


c03 REFCURSOR;

cDietas CURSOR FOR
SELECT	a.nr_atendimento nr_atendimento_w,
	a.dt_horario dt_horario_w,
	a.cd_local_estoque cd_local_estoque_w,
	a.cd_setor_prescr cd_setor_prescr_w,
	a.nr_prescricao nr_prescricao_w
from	setor_atendimento b,
	adep_ged_pend_v a
where	a.cd_setor_prescr = b.cd_setor_atendimento
and	a.cd_estabelecimento = cd_estabelecimento_w
and	a.ie_setor_processo_gedipa = 'S'
and	coalesce(a.nr_seq_processo::text, '') = ''
and	gedipa_obter_gerar_proc(clock_timestamp() - interval '2 days', 'AP_LOTE', a.nr_seq_lote,ie_gedipa)	= 'S'
AND	a.ie_tipo_item = 'D'
and	a.nr_prescricao = nr_prescricao_p
and	((a.nr_seq_item = nr_sequencia_p) or (coalesce(nr_sequencia_p::text, '') = ''))
group by
	a.nr_atendimento, a.dt_horario, a.cd_local_estoque, a.cd_setor_prescr, a.nr_prescricao
order by
	a.nr_atendimento, a.dt_horario;

BEGIN

select	coalesce(max(cd_estabelecimento),coalesce(wheb_usuario_pck.get_cd_estabelecimento,1))
into STRICT	cd_estabelecimento_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

select	coalesce(max(ie_trans_proc_gedipa),'N'),
		coalesce(max(ie_gerar_proc_frac_sol),'N'),
		coalesce(max(ie_gerar_processo_area),'N'),
		coalesce(max(ie_grava_log_gedipa),'N')
into STRICT	ie_trans_proc_gedipa_w,
		ie_gerar_proc_frac_sol_w,
		ie_separar_proc_area_w,
		ie_grava_log_gedipa_w
from	parametros_farmacia
where	cd_estabelecimento = cd_estabelecimento_w;

if (ie_trans_proc_gedipa_w = 'N') then
	open c01 for
	SELECT	a.nr_atendimento,
		a.dt_horario,
		a.cd_local_estoque,
		a.cd_setor_prescr,
		CASE WHEN ie_separar_proc_area_w='S' THEN a.nr_seq_area_prep  ELSE null END ,
		a.nr_prescricao
	from	setor_atendimento b,
		adep_ged_pend_v a
	where	a.cd_setor_prescr 			= b.cd_setor_atendimento
	and	a.cd_estabelecimento			= cd_estabelecimento_w
	and	a.ie_setor_processo_gedipa		= 'S'
	and	coalesce(a.nr_seq_processo::text, '') = ''
	and	gedipa_obter_gerar_proc(clock_timestamp() - interval '2 days', 'AP_LOTE', a.nr_seq_lote,ie_gedipa)	= 'S'
	and	coalesce(a.ie_conferencia,'S') = 'S'
	and	coalesce(a.ie_higienizacao,'S') = 'S'
	and	coalesce(a.ie_preparo,'S')  = 'S'
	and	a.nr_prescricao = nr_prescricao_p
	and	((a.nr_seq_item = nr_sequencia_p) or (coalesce(nr_sequencia_p::text, '') = ''))
	and	((a.nr_seq_horario = nr_seq_horario_p) or (coalesce(nr_seq_horario_p::text, '') = ''))
	group by
		a.nr_atendimento, a.dt_horario, a.cd_local_estoque, a.cd_setor_prescr, CASE WHEN ie_separar_proc_area_w='S' THEN nr_seq_area_prep  ELSE null END , a.nr_prescricao
	order by
		a.nr_atendimento, a.dt_horario;
else
	open c01 for
	SELECT	a.nr_atendimento,
		a.dt_horario,
		a.cd_local_estoque,
		a.cd_setor_prescr,
		CASE WHEN ie_separar_proc_area_w='S' THEN a.nr_seq_area_prep  ELSE null END ,
		a.nr_prescricao
	from	setor_atendimento b,
		adep_ged_pend_v a
	where	a.cd_setor_prescr = b.cd_setor_atendimento
	and	a.cd_estabelecimento						= cd_estabelecimento_w
	and	a.ie_setor_processo_gedipa					= 'S'
	and	gedipa_obter_gerar_proc_status(clock_timestamp() - interval '2 days', 'AP_LOTE', a.nr_seq_lote,ie_gedipa,a.nr_seq_processo, a.nr_seq_area_prep, null)	= 'S'
	and	coalesce(a.ie_conferencia,'S') = 'S'
	and	coalesce(a.ie_higienizacao,'S') = 'S'
	and	coalesce(a.ie_preparo,'S')  = 'S'
	and	a.nr_prescricao = nr_prescricao_p
	and	((a.nr_seq_item = nr_sequencia_p) or (coalesce(nr_sequencia_p::text, '') = ''))
	and	((a.nr_seq_horario = nr_seq_horario_p) or (coalesce(nr_seq_horario_p::text, '') = ''))
	group by
		a.nr_atendimento, a.dt_horario, a.cd_local_estoque, a.cd_setor_prescr, CASE WHEN ie_separar_proc_area_w='S' THEN nr_seq_area_prep  ELSE null END , a.nr_prescricao
	order by
		a.nr_atendimento, a.dt_horario;		
end if;		

if (ie_trans_proc_gedipa_w = 'N') then	
	open c02 for
	SELECT	a.nr_atendimento,
		b.nr_prescricao,
		b.nr_seq_solucao,
		c.dt_horario,
		c.nr_etapa_sol
	from	setor_atendimento e,
		prescr_solucao b,
		prescr_material d,
		prescr_medica a,
		prescr_mat_hor c
	where	e.cd_setor_atendimento						= a.cd_setor_atendimento
	and	d.nr_prescricao							= a.nr_prescricao
	and	d.nr_sequencia_solucao						= b.nr_seq_solucao
	and	d.nr_sequencia							= c.nr_seq_material
	and	d.nr_prescricao							= c.nr_prescricao
	and	c.nr_prescricao							= a.nr_prescricao
	and	b.nr_prescricao							= a.nr_prescricao
	and	(((coalesce(c.ie_aprazado,'N') = 'S') and (b.nr_seq_dialise IS NOT NULL AND b.nr_seq_dialise::text <> '')) or
		 ((coalesce(b.ie_acm,'N') 				<> 'S') and (coalesce(b.ie_se_necessario,'N') 	 	<> 'S')) or (coalesce(b.ie_etapa_especial,'N')		= 'S'))
	and	c.ie_agrupador							in (4,13)
	and	d.ie_agrupador							in (4,13)
	and	coalesce(c.nr_seq_processo::text, '') = ''
	and	e.ie_processo_gedipa	= 'S'
	and	gedipa_obter_gerar_proc(clock_timestamp() - interval '2 days', 'AP_LOTE', c.nr_seq_lote,ie_gedipa)	= 'S'
	and	a.cd_estabelecimento						= cd_estabelecimento_w
	and	(c.dt_lib_horario IS NOT NULL AND c.dt_lib_horario::text <> '')
	and	b.nr_prescricao = nr_prescricao_p
	and	((b.nr_seq_solucao = nr_seq_solucao_p) or (coalesce(nr_seq_solucao_p::text, '') = ''))
	and	((c.nr_sequencia = nr_seq_horario_p) or (coalesce(nr_seq_horario_p::text, '') = ''))
	and	coalesce(c.nr_seq_area_prep,0) > 0
	group by
		a.nr_atendimento,
		b.nr_prescricao,
		b.nr_seq_solucao,
		c.dt_horario,
		c.nr_etapa_sol
	order by
		a.nr_atendimento,
		b.nr_prescricao,
		b.nr_seq_solucao,
		c.dt_horario;
else
	open c02 for
	SELECT	a.nr_atendimento,
		b.nr_prescricao,
		b.nr_seq_solucao,
		c.dt_horario,
		c.nr_etapa_sol
	from	setor_atendimento e,
		prescr_solucao b,
		prescr_material d,
		prescr_medica a,
		prescr_mat_hor c
	where	e.cd_setor_atendimento						= a.cd_setor_atendimento
	and	d.nr_prescricao							= a.nr_prescricao
	and	d.nr_sequencia_solucao						= b.nr_seq_solucao
	and	d.nr_sequencia							= c.nr_seq_material
	and	d.nr_prescricao							= c.nr_prescricao
	and	c.nr_prescricao							= a.nr_prescricao
	and	b.nr_prescricao							= a.nr_prescricao
	and	((coalesce(c.ie_aprazado,'N') = 'S') or
		 ((coalesce(b.ie_acm,'N') 			<> 'S') and (coalesce(b.ie_se_necessario,'N')  	<> 'S')) or (coalesce(b.IE_ETAPA_ESPECIAL,'N')	= 'S'))
	and	c.ie_agrupador							in (4,13)
	and	d.ie_agrupador							in (4,13)
	and	e.ie_processo_gedipa	= 'S'
	and	gedipa_obter_gerar_proc_status(clock_timestamp() - interval '2 days', 'AP_LOTE', c.nr_seq_lote,ie_gedipa,c.nr_seq_processo, c.nr_seq_area_prep, null)	= 'S'
	and	a.cd_estabelecimento						= cd_estabelecimento_w
	and	(c.dt_lib_horario IS NOT NULL AND c.dt_lib_horario::text <> '')
	and	b.nr_prescricao = nr_prescricao_p
	and	((b.nr_seq_solucao = nr_seq_solucao_p) or (coalesce(nr_seq_solucao_p::text, '') = ''))
	and	((c.nr_sequencia = nr_seq_horario_p) or (coalesce(nr_seq_horario_p::text, '') = ''))
	and	coalesce(c.nr_seq_area_prep,0) > 0
	group by
		a.nr_atendimento,
		b.nr_prescricao,
		b.nr_seq_solucao,
		c.dt_horario,
		c.nr_etapa_sol
	order by
		a.nr_atendimento,
		b.nr_prescricao,
		b.nr_seq_solucao,
		c.dt_horario;		
end if;

if (ie_trans_proc_gedipa_w = 'N') then	
	open c03 for
	SELECT	a.nr_atendimento,
		a.dt_horario,
		a.cd_local_estoque,
		a.cd_setor_prescr,
		CASE WHEN ie_separar_proc_area_w='S' THEN nr_seq_area_prep  ELSE null END ,
		a.nr_prescricao
	from	setor_atendimento b,
		adep_ged_pend_v a
	where	a.cd_setor_prescr = b.cd_setor_atendimento
	and	a.cd_estabelecimento						= cd_estabelecimento_w
	and	a.ie_setor_processo_gedipa					= 'S'
	and	coalesce(a.nr_seq_processo::text, '') = ''
	and	gedipa_obter_gerar_proc(clock_timestamp() - interval '2 days', 'AP_LOTE', a.nr_seq_lote,ie_gedipa)	= 'S'
	AND	((coalesce(a.ie_conferencia,'S') = 'N') OR (coalesce(a.ie_higienizacao,'S') = 'N') OR (coalesce(a.ie_preparo,'S')  = 'N'))
	and	a.nr_prescricao = nr_prescricao_p
	and	((a.nr_seq_item = nr_sequencia_p) or (coalesce(nr_sequencia_p::text, '') = ''))
	and	((a.nr_seq_horario = nr_seq_horario_p) or (coalesce(nr_seq_horario_p::text, '') = ''))
	group by
		a.nr_atendimento, a.dt_horario, a.cd_local_estoque, a.cd_setor_prescr, CASE WHEN ie_separar_proc_area_w='S' THEN nr_seq_area_prep  ELSE null END , a.nr_prescricao
	order by
		a.nr_atendimento, a.dt_horario;
else
	open c03 for
	SELECT	a.nr_atendimento,
		a.dt_horario,
		a.cd_local_estoque,
		a.cd_setor_prescr,
		CASE WHEN ie_separar_proc_area_w='S' THEN nr_seq_area_prep  ELSE null END ,
		a.nr_prescricao
	from	setor_atendimento b,
		adep_ged_pend_v a
	where	a.cd_setor_prescr = b.cd_setor_atendimento
	and	a.cd_estabelecimento						= cd_estabelecimento_w
	and	a.ie_setor_processo_gedipa					= 'S'
	and	gedipa_obter_gerar_proc_status(clock_timestamp() - interval '2 days', 'AP_LOTE', a.nr_seq_lote,ie_gedipa,a.nr_seq_processo, a.nr_seq_area_prep, null)	= 'S'
	AND	((coalesce(a.ie_conferencia,'S') = 'N') OR (coalesce(a.ie_higienizacao,'S') = 'N') OR (coalesce(a.ie_preparo,'S')  = 'N'))
	and	a.nr_prescricao = nr_prescricao_p
	and	((a.nr_seq_item = nr_sequencia_p) or (coalesce(nr_sequencia_p::text, '') = ''))
	and	((a.nr_seq_horario = nr_seq_horario_p) or (coalesce(nr_seq_horario_p::text, '') = ''))
	group by
		a.nr_atendimento, a.dt_horario, a.cd_local_estoque, a.cd_setor_prescr, CASE WHEN ie_separar_proc_area_w='S' THEN nr_seq_area_prep  ELSE null END , a.nr_prescricao
	order by
		a.nr_atendimento, a.dt_horario;
end if;

if (ie_grava_log_gedipa_w = 'S') then
	insert into log_gedipa(	nr_sequencia, dt_log, nr_log,
								nm_objeto_execucao, nm_objeto_chamado, 
								ds_parametros, 
								ds_log, nr_seq_processo)
					values (	obter_nextval_sequence('log_gedipa'), clock_timestamp(), 2200, 
								'GEDIPA_GERAR_PROC_INSTANTANEO', 'GEDIPA_GERAR_PROC_INSTANTANEO', 
								substr('{'||chr(10)||
										'"cd_estabelecimento_w" : "'||cd_estabelecimento_w||'",'||chr(10)||
										'"ie_separar_proc_area_w" : "'||ie_separar_proc_area_w||'",'||chr(10)||
										'"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
										'"nr_seq_horario_p" : "'||nr_seq_horario_p||'",'||chr(10)||
										'"nr_sequencia_p" : "'||nr_sequencia_p||'"}',1,1999), 
								substr(wheb_mensagem_pck.get_texto(311528) || chr(10) || 'STACK: ' || dbms_utility.format_call_stack,1,1999), 
								null);
end if;

loop
fetch c01 into
	nr_atendimento_w,
	dt_horario_w,
	cd_local_estoque_w,
	cd_setor_prescr_w,
	nr_seq_area_prep_w,
	nr_prescricao_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
	SELECT * FROM gerar_processo_adep(nr_atendimento_w, dt_horario_w, 'GGPInstantaneo', nr_seq_processo_w, 'S', null, 'GGPI', 'S', 'S', nr_seq_processo_agora_w, cd_local_estoque_w, cd_setor_prescr_w, 'N', nr_seq_processo_nut_w, nr_seq_area_prep_w, nr_prescricao_w) INTO STRICT nr_seq_processo_w, nr_seq_processo_agora_w, nr_seq_processo_nut_w;
	
	CALL gerar_fracionamento_processo(nr_seq_processo_w, 'GGPInstantaneo');

	if (coalesce(nr_seq_processo_nut_w,0) > 0) then
		CALL gerar_fracionamento_processo(nr_seq_processo_nut_w, 'GGPInstantaneo');
	end if;

	CALL gerar_fracionamento_processo(nr_seq_processo_agora_w, 'GGPInstantaneo');
	
	end;
end loop;
close c01;

loop
fetch c02 into	nr_atendimento_w,
		nr_prescricao_w,
		nr_seq_solucao_w,
		dt_horario_w,
		nr_etapa_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin

	nr_seq_processo_w := gerar_processo_adep_sol(nr_atendimento_w, nr_prescricao_w, nr_seq_solucao_w, nr_etapa_w, dt_horario_w, 'GGPInstantaneo', nr_seq_processo_w, 'S', null, 'GGPI', 'S', null, null);
	
	update	prescr_mat_hor a
	set		a.nr_seq_processo	= nr_seq_processo_w
	where	a.nr_prescricao	= nr_prescricao_w
	and		a.dt_horario	= dt_horario_w
	and		coalesce(a.dt_fim_horario::text, '') = ''
	and		a.ie_agrupador	in (4,13)
	and		((coalesce(a.IE_ETAPA_ESPECIAL,'N') = 'S') or (coalesce(a.ie_horario_especial,'N') <> 'S'))
	and 	exists (
			SELECT	1
			from	prescr_material b
			where	b.nr_prescricao		= a.nr_prescricao
			and		b.nr_sequencia		= a.nr_seq_material
			and		b.ie_agrupador		in (4,13)
			and		b.nr_sequencia_solucao	= nr_seq_solucao_w);

	if (ie_gerar_proc_frac_sol_w = 'S') then
		update	prescr_mat_hor a
		set		a.nr_seq_processo	= nr_seq_processo_w
		where	a.nr_prescricao		= nr_prescricao_w
		and		a.dt_horario		= dt_horario_w
		and		coalesce(a.dt_fim_horario::text, '') = ''
		and		((coalesce(a.IE_ETAPA_ESPECIAL,'N') = 'S') or (coalesce(a.ie_horario_especial,'N') <> 'S'))
		and 	exists (
				SELECT	1
				from	prescr_material b
				where	b.nr_prescricao		= a.nr_prescricao
				and		b.nr_sequencia		= a.nr_seq_material
				and		b.nr_seq_kit		in (	SELECT	x.nr_sequencia 
													from	prescr_material x 
													where	x.nr_prescricao			= nr_prescricao_w
													and		x.nr_sequencia_solucao	= nr_seq_solucao_w));
	end if;
	
	CALL atual_proc_area_kit_comp_sol(nr_seq_processo_w, nr_prescricao_w, nr_seq_solucao_w, dt_horario_w, null,'N');
	
	CALL gerar_frac_proc_sol(nr_seq_processo_w, nr_prescricao_w, nr_seq_solucao_w, 'N', 'GGPInstantaneo',null,'N');
	
	end;
end loop;
close c02;

loop
fetch c03 into
	nr_atendimento_w,
	dt_horario_w,
	cd_local_estoque_w,
	cd_setor_prescr_w,
	nr_seq_area_prep_w,
	nr_prescricao_w;
EXIT WHEN NOT FOUND; /* apply on c03 */
	begin
		
	SELECT * FROM gerar_processo_adep(nr_atendimento_w, dt_horario_w, 'GGPInstantaneo', nr_seq_processo_w, 'S', null, 'GGPI', 'S', 'S', nr_seq_processo_agora_w, cd_local_estoque_w, cd_setor_prescr_w, 'S', nr_seq_processo_nut_w, nr_seq_area_prep_w, nr_prescricao_w) INTO STRICT nr_seq_processo_w, nr_seq_processo_agora_w, nr_seq_processo_nut_w;
	
	CALL gerar_fracionamento_processo(nr_seq_processo_w, 'GGPInstantaneo');

	if (coalesce(nr_seq_processo_nut_w,0) > 0) then
		CALL gerar_fracionamento_processo(nr_seq_processo_nut_w, 'GGPInstantaneo');
	end if;
	
	CALL gerar_fracionamento_processo(nr_seq_processo_agora_w, 'GGPInstantaneo');
	
	end;
end loop;
close c03;

for cDietas_w in cDietas
loop
	begin
		SELECT * FROM gerar_processo_adep(nr_atendimento_p 		=> cDietas_w.nr_atendimento_w, dt_horario_p			=> cDietas_w.dt_horario_w, nm_usuario_p			=> 'GGPInstantaneo', nr_seq_processo_p		=> nr_seq_processo_w, ie_somente_gedipa_p		=> 'S', cd_funcao_origem_p		=> null, ie_origem_processo_p	=> 'GGPI', ie_gedipa_p				=> 'S', ie_separar_agora_p		=> 'S', nr_seq_processo_agora_p => nr_seq_processo_agora_w, cd_local_estoque_p		=> cDietas_w.cd_local_estoque_w, cd_setor_prescr_p		=> cDietas_w.cd_setor_prescr_w, ie_intervencao_p		=> 'S', nr_seq_processo_nut_p	=> nr_seq_processo_nut_w, nr_seq_area_prep_p		=> null, nr_prescricao_p			=> cDietas_w.nr_prescricao_w, ie_gera_nutricao_p		=> 'D') INTO STRICT nr_seq_processo_p		=> nr_seq_processo_w, nr_seq_processo_agora_p => nr_seq_processo_agora_w, nr_seq_processo_nut_p	=> nr_seq_processo_nut_w;

		CALL gerar_fracionamento_processo(	nr_seq_processo_p	=> nr_seq_processo_w,
										nm_usuario_p		=> 'GGPInstantaneo');
	end;
end loop;

exception
when others then
	ds_erro_w	:= substr(SQLERRM(SQLSTATE),1,1800);
	insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
	values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 1400, 'GEDIPA_GERAR_PROC_INSTANTANEO', null, 'cd_estabelecimento_w='||to_char(cd_estabelecimento_w)||'; dt_virada_p='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(clock_timestamp() - interval '2 days', 'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone)||'; qt_minuto_p='||to_char(0), obter_desc_expressao(289744) || ' na ' || lower(obter_desc_expressao(308293)) || ' da procedure GEDIPA_GERAR_PROC_INSTANTANEO; E='
||ds_erro_w);
	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gedipa_gerar_proc_instantaneo ( nr_prescricao_p bigint, nr_sequencia_p bigint, nr_seq_solucao_p bigint, nr_seq_horario_p bigint) FROM PUBLIC;

