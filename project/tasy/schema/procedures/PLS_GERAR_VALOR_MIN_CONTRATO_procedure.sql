-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_valor_min_contrato ( nr_seq_lote_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_contrato_w		bigint;
nr_seq_regra_mens_w		bigint;
vl_minimo_w			double precision;
vl_pre_estab_w			double precision;
qt_segurado_w			bigint;
nr_seq_pre_estab_w		bigint;
vl_preco_individual_w		double precision;
vl_conferencia_w		double precision;
vl_diferenca_w			double precision;
nr_seq_mensalidade_w		bigint;
nr_seq_intercambio_w		bigint;
dt_referencia_w			timestamp;

C01 CURSOR FOR
	SELECT	b.nr_seq_contrato,
		b.nr_seq_pagador_intercambio,
		a.nr_sequencia,
		a.dt_referencia
	from	pls_mensalidade		a,
		pls_contrato_pagador	b
	where	a.nr_seq_pagador	= b.nr_sequencia
	and	a.nr_seq_lote		= nr_seq_lote_p;

C02 CURSOR FOR
	SELECT	a.nr_sequencia
	from	pls_mensalidade_seg_item a,
		pls_mensalidade_segurado b,
		pls_segurado c
	where	a.nr_seq_mensalidade_seg	= b.nr_sequencia
	and	b.nr_seq_segurado	= c.nr_sequencia
	and	c.nr_seq_contrato	= nr_seq_contrato_w
	and	b.nr_seq_mensalidade	= nr_seq_mensalidade_w
	and	a.ie_tipo_item	= '1';


BEGIN

open C01;
loop
fetch C01 into
	nr_seq_contrato_w,
	nr_seq_intercambio_w,
	nr_seq_mensalidade_w,
	dt_referencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (coalesce(nr_seq_contrato_w,0) <> 0) then
		select	max(nr_sequencia)
		into STRICT	nr_seq_regra_mens_w
		from	pls_regra_mens_contrato
		where	nr_seq_contrato	= nr_seq_contrato_w
		and	ie_tipo_regra	= 'VM'
		and	dt_referencia_w between coalesce(dt_inicio_vigencia,dt_referencia_w) and coalesce(dt_fim_vigencia,dt_referencia_w);
	elsif (coalesce(nr_seq_intercambio_w,0) <> 0) then
		select	max(nr_sequencia)
		into STRICT	nr_seq_regra_mens_w
		from	pls_regra_mens_contrato
		where	nr_seq_intercambio	= nr_seq_intercambio_w
		and	ie_tipo_regra	= 'VM'
		and	dt_referencia_w between coalesce(dt_inicio_vigencia,dt_referencia_w) and coalesce(dt_fim_vigencia,dt_referencia_w);
	end if;

	if (coalesce(nr_seq_regra_mens_w,0) = 0) then
		select	max(nr_sequencia)
		into STRICT	nr_seq_regra_mens_w
		from	pls_regra_mens_contrato
		where	coalesce(nr_seq_contrato::text, '') = ''
		and	coalesce(nr_seq_intercambio::text, '') = ''
		and	ie_tipo_regra	= 'VM'
		and	dt_referencia_w between coalesce(dt_inicio_vigencia,dt_referencia_w) and coalesce(dt_fim_vigencia,dt_referencia_w);
	end if;

	if (coalesce(nr_seq_regra_mens_w,0) > 0) then
		select	coalesce(vl_minimo,0)
		into STRICT	vl_minimo_w
		from	pls_regra_mens_contrato
		where	nr_sequencia	= nr_seq_regra_mens_w;

		select	sum(c.vl_item)
		into STRICT	vl_pre_estab_w
		from	pls_mensalidade_seg_item	c,
			pls_mensalidade_segurado	b,
			pls_mensalidade			a,
			pls_contrato_pagador		d
		where	b.nr_sequencia		= c.nr_seq_mensalidade_seg
		and	b.nr_seq_mensalidade	= a.nr_sequencia
		and	a.nr_seq_pagador	= d.nr_sequencia
		and	c.ie_tipo_item		= '1'
		and	a.nr_sequencia		= nr_seq_mensalidade_w
		and	d.nr_seq_contrato	= nr_seq_contrato_w;

		if (vl_pre_estab_w < vl_minimo_w) then
			select	count(*)
			into STRICT	qt_segurado_w
			from	pls_mensalidade_segurado a,
				pls_segurado b
			where	a.nr_seq_segurado	= b.nr_sequencia
			and	b.nr_seq_contrato	= nr_seq_contrato_w
			and	a.nr_seq_mensalidade	= nr_seq_mensalidade_w
			and	exists (SELECT	1
					from	pls_mensalidade_seg_item x
					where	x.nr_seq_mensalidade_seg = a.nr_sequencia
					and	x.vl_item > 0);

			vl_preco_individual_w	:= trunc(vl_minimo_w / qt_segurado_w,2);

			open C02;
			loop
			fetch C02 into
				nr_seq_pre_estab_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin

				update	pls_mensalidade_seg_item
				set	vl_item	= vl_preco_individual_w
				where	nr_sequencia	= nr_seq_pre_estab_w;

				end;
			end loop;
			close C02;

			select	sum(c.vl_item)
			into STRICT	vl_conferencia_w
			from	pls_mensalidade_v a,
				pls_mensalidade_segurado b,
				pls_mensalidade_seg_item c
			where	a.nr_seq_mensalidade	= b.nr_seq_mensalidade
			and	b.nr_sequencia	= c.nr_seq_mensalidade_seg
			and	c.ie_tipo_item	= '1'
			and	a.nr_seq_contrato	= nr_seq_contrato_w
			and	a.nr_seq_mensalidade	= nr_seq_mensalidade_w;

			vl_diferenca_w	:= vl_minimo_w - vl_conferencia_w;

			if (vl_diferenca_w <> 0) then -- Para arredondamento
				update	pls_mensalidade_seg_item
				set	vl_item	= vl_item + vl_diferenca_w
				where	nr_sequencia	= nr_seq_pre_estab_w;
			end if;
		end if;
	end if;

	end;
end loop;
close C01;

/* NÃ£o pode dar commit nesta procedure */

--commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_valor_min_contrato ( nr_seq_lote_p bigint, nm_usuario_p text) FROM PUBLIC;

