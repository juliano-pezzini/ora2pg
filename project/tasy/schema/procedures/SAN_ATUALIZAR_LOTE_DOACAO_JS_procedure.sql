-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_atualizar_lote_doacao_js ( cd_mat_barra_p text, ie_tipo_barra_p text, nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_pasta_p text, ie_opcao_p text) AS $body$
DECLARE

 
/* 
ie_pasta_p 
C - Coleta 
P - Produção 
E - Produção de itens emprestados 
*/
 
		 
cd_material_w	bigint;
qt_material_w	double precision;
nr_seq_lote_w	bigint;
nr_seq_loteagrup_w	bigint;
cd_kit_mat_w	integer;
ds_validade_w	varchar(10);
ds_material_w	varchar(255);
cd_unid_med_w	varchar(30);
nr_etiqueta_lp_w	varchar(10);
ds_erro_w		varchar(255);


BEGIN 
 
SELECT * FROM converte_codigo_barras( 
	cd_mat_barra_p, cd_estabelecimento_p, null, ie_tipo_barra_p, cd_material_w, qt_material_w, nr_seq_lote_w, nr_seq_loteagrup_w, cd_kit_mat_w, ds_validade_w, ds_material_w, cd_unid_med_w, nr_etiqueta_lp_w, ds_erro_w) INTO STRICT cd_material_w, qt_material_w, nr_seq_lote_w, nr_seq_loteagrup_w, cd_kit_mat_w, ds_validade_w, ds_material_w, cd_unid_med_w, nr_etiqueta_lp_w, ds_erro_w;
 
if (ie_pasta_p = 'C') then 
 
	CALL san_atualizar_lote_doacao( 
		nr_sequencia_p, 
		nr_seq_lote_w, 
		nm_usuario_p, 
		ie_opcao_p);
	if (ie_opcao_p = 'L') then 
		San_movimento_estoque_bolsa(cd_mat_barra_p,'',nr_sequencia_p,'16', cd_estabelecimento_p,nm_usuario_p);	
	end if;	
elsif (ie_pasta_p = 'S') then --Sangria 
	 
	CALL san_insere_lote_bolsa(null,nr_seq_lote_w,nr_sequencia_p,null,nm_usuario_p,'S');
	 
	San_movimento_estoque_bolsa(cd_mat_barra_p,'',nr_sequencia_p,'19', cd_estabelecimento_p,nm_usuario_p);
 
else 
 
	CALL San_atualizar_lote_producao( 
		nr_sequencia_p, 
		nr_seq_lote_w, 
		nm_usuario_p);
 
	San_movimento_estoque_bolsa(	 
		cd_mat_barra_p, 
		'', 
		nr_sequencia_p, 
		'17', 
		cd_estabelecimento_p, 
		nm_usuario_p);
		 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_atualizar_lote_doacao_js ( cd_mat_barra_p text, ie_tipo_barra_p text, nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_pasta_p text, ie_opcao_p text) FROM PUBLIC;

