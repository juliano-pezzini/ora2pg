-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_multi_ageint_dailycal ( CD_AGENDA_P bigint, NR_SEQ_AGENDA_P bigint, NR_SEQ_AGEINT_P bigint, CD_TIPO_AGENDA_P text, DT_AGENDA_P timestamp, CD_PESSOA_FISICA_P bigint, CD_CONVENIO_P bigint, CD_ESTABELICIMENTO_P bigint, NM_USUARIO_P text, CD_MEDICO_P bigint, CD_ESPECIALIDADE_P bigint DEFAULT NULL, CD_PROCEDIMENTO_P bigint DEFAULT NULL, NR_SEQ_PROC_INTERNO_P bigint DEFAULT NULL, NR_MINUTO_DURACAO_P bigint DEFAULT NULL, DS_DADO_CLINICO_P text DEFAULT NULL) AS $body$
DECLARE


	nr_seq_agenda_int_w  bigint;
  	nr_seq_item_agenda_w bigint;
  	nr_seq_status_w AGENDA_INTEGRADA_STATUS.nr_sequencia%type;
  	nr_seq_ageint_marca_usuario_w bigint;


BEGIN

  	IF (coalesce(NR_SEQ_AGEINT_P::text, '') = '' OR NR_SEQ_AGEINT_P = 0) THEN

    		SELECT 	MAX(a.nr_sequencia)
    		INTO STRICT 	nr_seq_status_w
    		FROM 	AGENDA_INTEGRADA_STATUS a
    		WHERE 	coalesce(a.ie_situacao,'A') 	= 'A'
    		AND 	IE_STATUS_TASY           	= 'AG';

    		SELECT nextval('agenda_integrada_seq') INTO STRICT nr_seq_agenda_int_w;

    		INSERT INTO agenda_integrada(
        			nr_sequencia ,
        			dt_atualizacao ,
        			nm_usuario ,
        			dt_atualizacao_nrec ,
        			nm_usuario_nrec ,
        			dt_inicio_agendamento ,
        			dt_fim_agendamento ,
        			cd_pessoa_fisica ,
        			cd_estabelecimento,
        			nr_seq_status,
        			cd_convenio,
        			cd_profissional,
			ds_indicacao	)
      		VALUES (
        			nr_seq_agenda_int_w,
        			clock_timestamp(),
        			NM_USUARIO_P,
        			clock_timestamp(),
        			NM_USUARIO_P,
        			clock_timestamp(),
        			NULL,
        			CD_PESSOA_FISICA_P,
        			CD_ESTABELICIMENTO_P,
        			nr_seq_status_w,
        			cd_convenio_p,
        			obter_pf_usuario(obter_usuario_ativo, 'C'),
			ds_dado_clinico_p	);

    		SELECT	nextval('agenda_integrada_item_seq')
		INTO STRICT 	nr_seq_item_agenda_w
		;

    		IF (CD_TIPO_AGENDA_P IN (3, 5) ) THEN

      			INSERT INTO agenda_integrada_item(
          				nr_sequencia ,
          				nr_seq_agenda_int ,
          				dt_atualizacao ,
          				nm_usuario ,
          				dt_atualizacao_nrec ,
          				nm_usuario_nrec ,
          				ie_tipo_agendamento ,
          				cd_medico ,
          				cd_especialidade ,
          				vl_item ,
          				ie_regra ,
          				cd_estabelecimento ,
          				nr_seq_agenda_cons	)
        			VALUES (
          				nr_seq_item_agenda_w,
          				nr_seq_agenda_int_w,
          				clock_timestamp(),
          				nm_usuario_p,
          				clock_timestamp(),
          				nm_usuario_p,
          				CASE WHEN CD_TIPO_AGENDA_P=3 THEN  'C'  ELSE 'S' END ,
          				CD_MEDICO_P,
          				CD_ESPECIALIDADE_P,
          				NULL,
          				NULL,
          				CD_ESTABELICIMENTO_P,
          				NR_SEQ_AGENDA_P	);

    		ELSE
    			INSERT INTO agenda_integrada_item(
          				nr_sequencia ,
          				nr_seq_agenda_int ,
          				dt_atualizacao ,
          				nm_usuario ,
          				dt_atualizacao_nrec ,
          				nm_usuario_nrec ,
          				ie_tipo_agendamento ,
          				cd_medico ,
          				cd_procedimento ,
          				nr_seq_proc_interno ,
          				vl_item ,
          				ie_regra ,
          				nr_seq_agenda_exame,
          				cd_estabelecimento,
          				ie_gestao_exame	)
        			VALUES (
          				nr_seq_item_agenda_w,
          				nr_seq_agenda_int_w,
          				clock_timestamp(),
          				nm_usuario_p,
          				clock_timestamp(),
          				nm_usuario_p,
          				'E',
          				CD_MEDICO_P,
          				CD_PROCEDIMENTO_P,
          				NR_SEQ_PROC_INTERNO_P,
          				NULL,
          				NULL,
          				NR_SEQ_AGENDA_P,
          				CD_ESTABELICIMENTO_P,
          				'N'	);
    		END IF;

    		SELECT	nextval('ageint_marcacao_usuario_seq')
    		INTO STRICT 	nr_seq_ageint_marca_usuario_w
    		;

    		INSERT INTO ageint_marcacao_usuario(
        			nr_Sequencia,
        			cd_Agenda,
        			hr_agenda,
        			nm_usuario,
        			nr_Seq_ageint,
        			nr_minuto_duracao,
        			nr_Seq_agenda,
        			nr_seq_ageint_item,
        			ie_horario_auxiliar,
        			cd_pessoa_fisica,
        			ie_gerado		)
      		VALUES (
        			nr_seq_ageint_marca_usuario_w,
        			CD_AGENDA_P,
        			DT_AGENDA_P,
        			NM_USUARIO_P,
        			nr_seq_agenda_int_w,
        			NR_MINUTO_DURACAO_P,
        			NR_SEQ_AGENDA_P,
        			nr_seq_item_agenda_w,
        			'N',
        			CD_PESSOA_FISICA_P,
        			'S'	);

	END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_multi_ageint_dailycal ( CD_AGENDA_P bigint, NR_SEQ_AGENDA_P bigint, NR_SEQ_AGEINT_P bigint, CD_TIPO_AGENDA_P text, DT_AGENDA_P timestamp, CD_PESSOA_FISICA_P bigint, CD_CONVENIO_P bigint, CD_ESTABELICIMENTO_P bigint, NM_USUARIO_P text, CD_MEDICO_P bigint, CD_ESPECIALIDADE_P bigint DEFAULT NULL, CD_PROCEDIMENTO_P bigint DEFAULT NULL, NR_SEQ_PROC_INTERNO_P bigint DEFAULT NULL, NR_MINUTO_DURACAO_P bigint DEFAULT NULL, DS_DADO_CLINICO_P text DEFAULT NULL) FROM PUBLIC;

