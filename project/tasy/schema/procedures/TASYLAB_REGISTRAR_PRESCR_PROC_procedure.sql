-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasylab_registrar_prescr_proc ( nr_prescricao_p bigint, nr_sequencia_p bigint, ie_origem_inf_p bigint, cd_procedimento_p bigint, cd_material_exame_p text, cd_exame_p text, qt_procedimento_p bigint, dt_coleta_p timestamp, dt_resultado_p timestamp, dt_prev_execucao_p timestamp, ie_urgencia_p text, ds_observacao_p text, nr_seq_externo_p bigint, ds_observacao_coleta_p text, cd_erro_p INOUT bigint, ds_erro_p INOUT text) AS $body$
DECLARE



cd_equipamento_w		equipamento_lab.cd_equipamento%type;

nr_seq_exame_w			exame_laboratorio.nr_seq_exame%type;

cd_medico_exec_w		prescr_medica.cd_medico%type;

cd_material_exame_w		material_exame_lab.cd_material_exame%type;

ie_base_wheb_w			varchar(1);
ie_existe_w			varchar(1);

cd_procedimento_w   exame_laboratorio.cd_procedimento%type;

ie_origem_proced_w  exame_laboratorio.ie_origem_proced%type;



BEGIN

cd_erro_p	:= 0;

CALL tasy_atualizar_dados_sessao(nr_seq_externo_p);

if (coalesce(nr_sequencia_p::text, '') = '') then
	cd_erro_p	:= 13;
elsif (coalesce(cd_material_exame_p::text, '') = '') then
	cd_erro_p	:= 14;
elsif (coalesce(cd_exame_p::text, '') = '') then
	cd_erro_p	:= 15;
else
	select	max(a.cd_equipamento)
	into STRICT	cd_equipamento_w
	from	equipamento_lab a
	where	a.ds_sigla = 'TLAB';

	if (coalesce(cd_equipamento_w::text, '') = '') then
		cd_erro_p	:= 16;
	else
		if (cd_erro_p = 0) then
			select	max(b.cd_material_exame)
			into STRICT	cd_material_exame_w
			from	material_exame_lab_int a,
					material_exame_lab b
			where	a.nr_seq_material = b.nr_sequencia
			and		a.cd_material_integracao = cd_material_exame_p
			and		a.cd_equipamento = cd_equipamento_w;

			if (coalesce(cd_material_exame_w::text, '') = '') then
				cd_erro_p	:= 17;
			end if;
		end if;

		if (cd_erro_p = 0) then
			select 	max(a.nr_seq_exame)
			into STRICT	nr_seq_exame_w
			from	lab_exame_equip a,
					exame_laboratorio b
			where	a.nr_seq_exame = b.nr_seq_exame
			and		b.ie_situacao = 'A'
			and		a.cd_exame_equip = cd_exame_p
			and		a.cd_equipamento = cd_equipamento_w;



			if (coalesce(nr_seq_exame_w::text, '') = '') then
				cd_erro_p	:= 18;
			end if;

			if (cd_erro_p = 0) then
				select	max(cd_medico)
				into STRICT	cd_medico_exec_w
				from	prescr_medica
				where	nr_prescricao = nr_prescricao_p;

				if (coalesce(cd_medico_exec_w::text, '') = '') then
					cd_medico_exec_w	:= 9;
				end if;
			end if;

			if (cd_erro_p = 0) then

				--Verifica se esta na base Wheb para alterar os valores padr√µes da procedure
				SELECT	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
				into STRICT	ie_base_wheb_w
				FROM 	estabelecimento a
				where	a.cd_estabelecimento = 1
				and		a.cd_cgc = '01950338000177';

				select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
				into STRICT	ie_existe_w
				from	prescr_procedimento a
				where	nr_prescricao = nr_prescricao_p
				and	nr_sequencia = nr_sequencia_p;

  				select	coalesce(max(a.cd_procedimento),0),
          					coalesce(max(a.ie_origem_proced),0)
  				into STRICT         cd_procedimento_w,
            					ie_origem_proced_w
				from	procedimento b,
      					exame_laboratorio a
				where	a.nr_seq_exame		= nr_seq_exame_w
				and	a.cd_procedimento	= b.cd_procedimento
				and	a.ie_origem_proced	= b.ie_origem_proced;


				if (cd_erro_p = 0) then
						if (ie_existe_w = 'N') then
						begin
						insert into prescr_procedimento(
													nr_prescricao,
													nr_sequencia,
													ie_origem_inf,
													cd_procedimento,
													cd_material_exame,
													nr_seq_exame,
													qt_procedimento,
													dt_coleta,
													dt_resultado,
													dt_prev_execucao,
													cd_setor_coleta,
													cd_setor_entrega,
													cd_setor_atendimento,
													cd_motivo_baixa,
													cd_medico_exec,
													ie_suspenso,
													nm_usuario,
													dt_atualizacao,
													ie_pendente_amostra,
													ie_exame_bloqueado,
													ie_origem_proced,
													ie_status_atend,
													ie_urgencia,
													ds_observacao,
													ds_observacao_coleta)
										values (
													nr_prescricao_p,
													nr_sequencia_p,
													'L',
													cd_procedimento_p,
													cd_material_exame_w,
													nr_seq_exame_w,
													qt_procedimento_p,
													dt_coleta_p,
													dt_resultado_p,
													dt_prev_execucao_p,
													CASE WHEN ie_base_wheb_w='S' THEN  79351  ELSE 322 END ,
													CASE WHEN ie_base_wheb_w='S' THEN  79351  ELSE 322 END ,
													CASE WHEN ie_base_wheb_w='S', 79351, 331), --decode(ie_base_wheb_w, 'S' THEN  46  ELSE 134 END , Alterado OS464445
													0,
													cd_medico_exec_w,
													'N',
													'TasyLab-Proced',
													clock_timestamp(),
													'N',
													'N',
													ie_origem_inf_p,
													5,
													ie_urgencia_p,
													ds_observacao_p,
													ds_observacao_coleta_p);
						--OS727249 - Ivan
						--commit;
						exception
						when others then
							cd_erro_p	:= 1;
							ds_erro_p	:= substr('Erro ao inserir o procedimento '||sqlerrm,1,2000);
						end;
					else
						begin
						update prescr_procedimento set
													ie_origem_inf = 'L',
													cd_procedimento = cd_procedimento_w,
													ie_origem_proced = ie_origem_proced_w,
													cd_material_exame = cd_material_exame_w,
													nr_seq_exame = nr_seq_exame_w,
													qt_procedimento = qt_procedimento_p,
													dt_coleta = dt_coleta_p,
													dt_resultado = dt_resultado_p,
													dt_prev_execucao = dt_prev_execucao_p,
													cd_setor_coleta = CASE WHEN ie_base_wheb_w='S' THEN  79351  ELSE 322 END ,
													cd_setor_entrega = CASE WHEN ie_base_wheb_w='S' THEN  79351  ELSE 322 END ,
													cd_setor_atendimento = CASE WHEN ie_base_wheb_w='S', 79351, 331), --decode(ie_base_wheb_w, 'S' THEN  46  ELSE 134 END , Alterado OS464445
													cd_medico_exec = cd_medico_exec_w,
													nm_usuario = 'TasyLab-Proced',
													dt_atualizacao = clock_timestamp(),
													ie_urgencia = ie_urgencia_p,
													ds_observacao = ds_observacao_p,
													ds_observacao_coleta = ds_observacao_coleta_p
												where
													nr_prescricao = nr_prescricao_p
												and 	nr_sequencia = nr_sequencia_p;
						--OS727249 - Ivan
						--commit;
						exception
						when others then
							cd_erro_p	:= 1;
							ds_erro_p	:= substr('Erro ao atualizar o procedimento '||sqlerrm,1,2000);
						end;

					end if;
				end if;
			end if;

		end if;
	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasylab_registrar_prescr_proc ( nr_prescricao_p bigint, nr_sequencia_p bigint, ie_origem_inf_p bigint, cd_procedimento_p bigint, cd_material_exame_p text, cd_exame_p text, qt_procedimento_p bigint, dt_coleta_p timestamp, dt_resultado_p timestamp, dt_prev_execucao_p timestamp, ie_urgencia_p text, ds_observacao_p text, nr_seq_externo_p bigint, ds_observacao_coleta_p text, cd_erro_p INOUT bigint, ds_erro_p INOUT text) FROM PUBLIC;

