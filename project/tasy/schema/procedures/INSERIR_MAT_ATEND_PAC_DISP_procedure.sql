-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_mat_atend_pac_disp ( nr_atendimento_p bigint, dt_entrada_unidade_p timestamp, dt_atendimento_p timestamp, cd_unidade_medida_p text, qt_material_p bigint, cd_material_p bigint, cd_material_exec_p bigint, cd_cgc_fornecedor_p text, cd_setor_atendimento_p bigint, cd_local_estoque_p bigint, qt_executada_p bigint, nr_seq_lote_fornec_p bigint, ds_observacao_p text, nm_usuario_p text, ie_opcao_arq_p text, nr_seq_atepacu_p bigint) AS $body$
DECLARE

 
nr_sequencia_w		bigint;
cd_convenio_w		integer;
cd_categoria_w		varchar(10);
nr_doc_convenio_w	varchar(20);
ie_tipo_guia_w		varchar(02);
cd_senha_w		varchar(20);
cd_setor_atendimento_w	integer;
dt_entrada_unidade_w	timestamp;
nr_seq_interno_w	bigint;


BEGIN 
 
SELECT * FROM obter_convenio_execucao(nr_atendimento_p, dt_atendimento_p, cd_convenio_w, cd_categoria_w, nr_doc_convenio_w, ie_tipo_guia_w, cd_senha_w) INTO STRICT cd_convenio_w, cd_categoria_w, nr_doc_convenio_w, ie_tipo_guia_w, cd_senha_w;
			 
 
select	obter_setor_atendimento(nr_atendimento_p) 
into STRICT	cd_setor_atendimento_w
;
 
select	coalesce(max(a.dt_entrada_unidade),clock_timestamp()) 
into STRICT	dt_entrada_unidade_w 
from 	tipo_acomodacao b, 
	setor_atendimento c, 
	atend_paciente_unidade a 
where 	a.cd_tipo_acomodacao = b.cd_tipo_acomodacao 
and  	a.cd_setor_atendimento = c.cd_setor_atendimento 
and  	nr_atendimento = nr_atendimento_p 
and 	a.cd_setor_atendimento = cd_setor_atendimento_w;
 
select	max(a.nr_seq_interno) 
into STRICT	nr_seq_interno_w 
from 	tipo_acomodacao b, 
	setor_atendimento c, 
	atend_paciente_unidade a 
where 	a.cd_tipo_acomodacao = b.cd_tipo_acomodacao 
and  	a.cd_setor_atendimento = c.cd_setor_atendimento 
and  	nr_atendimento = nr_atendimento_p 
and 	a.cd_setor_atendimento = cd_setor_atendimento_w;
 
if (coalesce(ie_opcao_arq_p,'C') = 'C') then 
	begin 
	 
	select	nextval('material_atend_paciente_seq') 
	into STRICT	nr_sequencia_w 
	;
	 
	insert into material_atend_paciente( 
		nr_sequencia, 
		nr_atendimento, 
		dt_entrada_unidade, 
		dt_atendimento, 
		cd_unidade_medida, 
		qt_material, 
		dt_atualizacao, 
		cd_material, 
		cd_cgc_fornecedor, 
		cd_setor_atendimento, 
		cd_local_estoque, 
		qt_executada, 
		nr_seq_lote_fornec, 
		ds_observacao, 
		nm_usuario, 
		nr_seq_atepacu, 
		cd_acao, 
		nr_doc_convenio, 
		cd_convenio, 
		cd_categoria, 
		ie_tipo_guia, 
		ie_auditoria, 
		ie_guia_informada, 
		qt_ajuste_conta, 
		cd_material_exec) 
	values (	nr_sequencia_w, 
		nr_atendimento_p, 
		coalesce(dt_entrada_unidade_w,dt_entrada_unidade_p), 
		dt_atendimento_p, 
		cd_unidade_medida_p, 
		qt_material_p, 
		clock_timestamp(), 
		cd_material_p, 
		cd_cgc_fornecedor_p, 
		coalesce(cd_setor_atendimento_w,cd_setor_atendimento_p), 
		cd_local_estoque_p, 
		qt_executada_p, 
		CASE WHEN coalesce(nr_seq_lote_fornec_p,0)=0 THEN null  ELSE nr_seq_lote_fornec_p END , 
		ds_observacao_p, 
		nm_usuario_p, 
		coalesce(nr_seq_interno_w,nr_seq_atepacu_p), 
		'1', 
		nr_doc_convenio_w, 
		cd_convenio_w, 
		cd_categoria_w, 
		ie_tipo_guia_w, 
		'N', 
		'N', 
		0, 
		CASE WHEN coalesce(cd_material_exec_p,0)=0 THEN null  ELSE cd_material_exec_p END );
 
	CALL atualiza_preco_material(nr_sequencia_w, nm_usuario_p);
	end;	
end if;
 
if (coalesce(ie_opcao_arq_p,'C') = 'D') then 
	begin 
	 
	select	nextval('material_atend_paciente_seq') 
	into STRICT	nr_sequencia_w 
   	;
		 
	insert into material_atend_paciente( 
		nr_sequencia, 
		nr_atendimento, 
		dt_entrada_unidade, 
		dt_atendimento, 
		cd_unidade_medida, 
		qt_material, 
		dt_atualizacao, 
		cd_material, 
		cd_cgc_fornecedor, 
		cd_setor_atendimento, 
		cd_local_estoque, 
		qt_executada, 
		nr_seq_lote_fornec, 
		ds_observacao, 
		nm_usuario, 
		nr_seq_atepacu, 
		cd_acao, 
		nr_doc_convenio, 
		cd_convenio, 
		cd_categoria, 
		ie_tipo_guia, 
		ie_auditoria, 
		ie_guia_informada, 
		qt_ajuste_conta, 
		cd_material_exec) 
	values (	nr_sequencia_w, 
		nr_atendimento_p, 
		coalesce(dt_entrada_unidade_w,dt_entrada_unidade_p), 
		dt_atendimento_p, 
		cd_unidade_medida_p, 
		(0 - qt_material_p), 
		clock_timestamp(), 
		cd_material_p, 
		cd_cgc_fornecedor_p, 
		coalesce(cd_setor_atendimento_w,cd_setor_atendimento_p), 
		cd_local_estoque_p, 
		qt_material_p, 
		CASE WHEN coalesce(nr_seq_lote_fornec_p,0)=0 THEN null  ELSE nr_seq_lote_fornec_p END , 
		ds_observacao_p, 
		nm_usuario_p, 
		coalesce(nr_seq_interno_w,nr_seq_atepacu_p), 
		'2', 
		nr_doc_convenio_w, 
		cd_convenio_w, 
		cd_categoria_w, 
		ie_tipo_guia_w, 
		'N', 
		'N', 
		0, 
		CASE WHEN coalesce(cd_material_exec_p,0)=0 THEN null  ELSE cd_material_exec_p END );
 
	CALL atualiza_preco_material(nr_sequencia_w, nm_usuario_p);
	 
	end;			
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_mat_atend_pac_disp ( nr_atendimento_p bigint, dt_entrada_unidade_p timestamp, dt_atendimento_p timestamp, cd_unidade_medida_p text, qt_material_p bigint, cd_material_p bigint, cd_material_exec_p bigint, cd_cgc_fornecedor_p text, cd_setor_atendimento_p bigint, cd_local_estoque_p bigint, qt_executada_p bigint, nr_seq_lote_fornec_p bigint, ds_observacao_p text, nm_usuario_p text, ie_opcao_arq_p text, nr_seq_atepacu_p bigint) FROM PUBLIC;

