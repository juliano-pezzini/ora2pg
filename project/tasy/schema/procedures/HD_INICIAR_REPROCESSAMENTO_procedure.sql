-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hd_iniciar_reprocessamento ( nr_seq_dialisador_p bigint, nr_seq_reproc_p bigint, cd_estabelecimento_p bigint, dt_inicio_p timestamp, nm_usuario_p text, ds_erro_p INOUT bigint) AS $body$
DECLARE


nr_reuso_reproc_w		bigint;
nr_reuso_dialis_w		bigint;
qt_priming_atual_w		double precision;
pr_perda_w			real;
qt_reuso_w			bigint;
ie_tipo_w			varchar(2);
ie_status_anterior_w		varchar(1);
dt_prim_lavagem_W		timestamp;
qt_reuso_dialisador_w		smallint;
qt_reproc_w hd_dializador.qt_reuso%type;


BEGIN

/* Verifica informacoes do reprocessador */

select	coalesce(nr_max_reuso,0)
into STRICT	nr_reuso_reproc_w
from	hd_reproc_dializador
where	nr_sequencia		= nr_seq_reproc_p;

/* Verifica informacoes do dializador */

select	coalesce(nr_max_reuso,0),
	coalesce(qt_priming_atual,0),
	coalesce(pr_perda,0),
	coalesce(qt_reuso,0),
	coalesce(ie_tipo,'I'),
	ie_status,
	dt_prim_lavagem
into STRICT	nr_reuso_dialis_w,
	qt_priming_atual_w,
	pr_perda_w,
	qt_reuso_w,
	ie_tipo_w,
	ie_status_anterior_w,
	dt_prim_lavagem_W
from	hd_dializador
where	nr_sequencia		= nr_seq_dialisador_p;

/* Verifica atualizac?o do reuso */

if	(ie_status_anterior_w = 'P' AND dt_prim_lavagem_w IS NOT NULL AND dt_prim_lavagem_w::text <> '') THEN
  SELECT count(1) INTO STRICT qt_reproc_w
  FROM hd_dialisador_reproc
  WHERE nr_seq_dialisador = nr_seq_dialisador_p  LIMIT 1;
  if (qt_reuso_w = 0 AND qt_reproc_w = 0) then
  	update	hd_dializador
      set	qt_reuso	= qt_reuso_w
     where	nr_sequencia	= nr_seq_dialisador_p;
  else
  	update	hd_dializador
      set	qt_reuso	= qt_reuso + 1
     where	nr_sequencia	= nr_seq_dialisador_p;
  end if;
end if;

/* Atualiza Maximo de reuso do dialisador */

if	((nr_reuso_reproc_w < nr_reuso_dialis_w) or (nr_reuso_dialis_w = 0)) then
	update	hd_dializador
	set	nr_max_reuso	= nr_reuso_reproc_w
	where	nr_sequencia	= nr_seq_dialisador_p;
end if;	

/* Atualiza a data da primeira lavagem e reuso do dialisador de emergencia - SOMENTE NA PRIMEIRA VEZ*/

if	(qt_reuso_w = 1 AND ie_tipo_w = 'M') then
	update	hd_dializador
	set	dt_prim_lavagem		= dt_inicio_p,
		cd_profissional		= substr(obter_pessoa_fisica_usuario(nm_usuario_p,'C'),1,10),
		qt_reuso		= qt_reuso + 1
	where	nr_sequencia		= nr_seq_dialisador_p;
end if;


select 	max(qt_reuso)
into STRICT	qt_reuso_dialisador_w
from	hd_dializador
where	nr_sequencia	= nr_seq_dialisador_p;


/* Atualiza dados do reprocessamento */

insert into hd_dialisador_reproc(
	nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_seq_dialisador,
	dt_inicio,
	cd_pf_inicio,
	nr_seq_reproc,
	qt_priming_atual,
	pr_perda_atual,
	cd_estabelecimento,
	qt_reuso
) values (
	nextval('hd_dialisador_reproc_seq'),
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_dialisador_p,
	dt_inicio_p,
	substr(obter_pessoa_fisica_usuario(nm_usuario_p,'C'),1,10),
	nr_seq_reproc_p,
	qt_priming_atual_w,
	pr_perda_w,
	cd_estabelecimento_p,
	qt_reuso_dialisador_w
);

/* Atualiza status do dialisador */

update	hd_dializador
set	ie_status		= 'R'
where	nr_sequencia		= nr_seq_dialisador_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hd_iniciar_reprocessamento ( nr_seq_dialisador_p bigint, nr_seq_reproc_p bigint, cd_estabelecimento_p bigint, dt_inicio_p timestamp, nm_usuario_p text, ds_erro_p INOUT bigint) FROM PUBLIC;

