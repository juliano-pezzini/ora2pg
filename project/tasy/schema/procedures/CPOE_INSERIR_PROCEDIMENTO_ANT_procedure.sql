-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_inserir_procedimento_ant ( nr_atendimento_p prescr_medica.nr_atendimento%type, nr_atendimento_ant_p prescr_medica.nr_atendimento%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nr_sequencia_p prescr_procedimento.nr_sequencia%type, nm_usuario_p prescr_medica.nm_usuario%type, cd_perfil_p bigint, cd_estabelecimento_p bigint, cd_paciente_p cpoe_procedimento.cd_pessoa_fisica%type, nr_seq_item_gerado_p INOUT bigint, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, ie_oncologia_p text default 'N', nr_seq_conclusao_apae_p bigint default null, ie_futuro_p text default 'N', nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) AS $body$
DECLARE


-- Duplicata da procedure CPOE_REP_GERAR_PROCEDIMENTO
cd_procedimento_w				prescr_procedimento.cd_procedimento%type;
ie_origem_proced_w				prescr_procedimento.ie_origem_proced%type;
nr_seq_procedimento_w			prescr_procedimento.nr_sequencia%type;
cd_intervalo_w					prescr_procedimento.cd_intervalo%type;
cd_material_exame_w				prescr_procedimento.cd_material_exame%type;
ds_horarios_w					prescr_procedimento.ds_horarios%type;
ds_horarios_ww					prescr_procedimento.ds_horarios%type;
ds_justificativa_w				prescr_procedimento.ds_justificativa%type;
ds_material_especial_w			prescr_procedimento.ds_material_especial%type;
ds_observacao_w					prescr_procedimento.ds_observacao%type;
dt_prev_execucao_w				prescr_procedimento.dt_prev_execucao%type;
ie_acm_w						prescr_procedimento.ie_acm%type;
ie_lado_w						prescr_procedimento.ie_lado%type;
ie_se_necessario_w				prescr_procedimento.ie_se_necessario%type;
nr_ocorrencia_w					prescr_procedimento.nr_ocorrencia%type;
nr_seq_proc_interno_w			prescr_procedimento.nr_seq_proc_interno%type;
nr_seq_prot_glic_w				prescr_procedimento.nr_seq_prot_glic%type;
nr_seq_topografia_w				prescr_procedimento.nr_seq_topografia%type;
qt_procedimento_w				prescr_procedimento.qt_procedimento%type;
nr_seq_condicao_w				prescr_procedimento.nr_seq_condicao%type;
nr_seq_contraste_w				prescr_procedimento.nr_seq_contraste%type;

ie_administracao_w				cpoe_procedimento.ie_administracao%type;
hr_prim_horario_w				cpoe_procedimento.hr_prim_horario%type;
ie_urgencia_w					cpoe_procedimento.ie_urgencia%type:='';
ds_horarios_aux_w				cpoe_procedimento.ds_horarios%type:='';
ie_duracao_w					cpoe_procedimento.ie_duracao%type;
dt_fim_w						cpoe_procedimento.dt_fim%type;
ie_evento_unico_w				cpoe_procedimento.ie_evento_unico%type;

qt_min_intervalo_w 				intervalo_prescricao.qt_min_intervalo%type;
ie_dose_unica_cpoe_w			intervalo_prescricao.ie_dose_unica_cpoe%type;
ie_interv_agora_w				intervalo_prescricao.ie_agora%type;

ie_prescr_alta_agora_w			varchar(1);
ie_possuir_hor_dia_seguinte_w	varchar(1);
ie_urgencia_proc_w				varchar(1);

c01 CURSOR FOR
SELECT	nr_sequencia,
		cd_intervalo,
		cd_material_exame,
		ds_horarios,
		ds_justificativa,
		ds_material_especial,
		ds_observacao,
		dt_prev_execucao,
		ie_lado,
		coalesce(ie_acm,'N'),
		coalesce(ie_se_necessario,'N'),
		nr_ocorrencia,
		nr_seq_proc_interno,
		cd_procedimento,
		ie_origem_proced,
		nr_seq_prot_glic,
		nr_seq_topografia,
		qt_procedimento,
		nr_seq_condicao,
		to_char(dt_prev_execucao, 'hh24:mi'),
		nr_seq_contraste
from	prescr_procedimento
where	nr_prescricao = nr_prescricao_p
and		nr_sequencia = nr_sequencia_p;


BEGIN

ie_prescr_alta_agora_w := obter_param_usuario(924, 409, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_prescr_alta_agora_w);

open c01;
loop
fetch c01 into	nr_seq_procedimento_w,
				cd_intervalo_w,
				cd_material_exame_w,
				ds_horarios_w,
				ds_justificativa_w,
				ds_material_especial_w,
				ds_observacao_w,
				dt_prev_execucao_w,
				ie_lado_w,
				ie_acm_w,
				ie_se_necessario_w,
				nr_ocorrencia_w,
				nr_seq_proc_interno_w,
				cd_procedimento_w,
				ie_origem_proced_w,
				nr_seq_prot_glic_w,
				nr_seq_topografia_w,
				qt_procedimento_w,
				nr_seq_condicao_w,
				hr_prim_horario_w,
				nr_seq_contraste_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	if (coalesce(ie_prescr_alta_agora_w,'N') = 'S') and (coalesce(ie_item_alta_p,'N') = 'S')	then
	
		ie_urgencia_w := 0;
		
		select	max(qt_min_intervalo)
		into STRICT	qt_min_intervalo_w
		from	intervalo_prescricao
		where	cd_intervalo = cd_intervalo_w;

		SELECT * FROM cpoe_calcular_horario_prescr(nr_atendimento_p, cd_intervalo_w, null, clock_timestamp(), 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;
		
		ds_horarios_w	:= ds_horarios_w || ds_horarios_aux_w;
	
		hr_prim_horario_w	:= obter_prim_dshorarios(ds_horarios_w);
		dt_prev_execucao_w	:= to_date(to_char(clock_timestamp(),'dd/mm/yyyy ') || hr_prim_horario_w, 'dd/mm/yyyy hh24:mi');
	
		if (dt_prev_execucao_w < clock_timestamp()) then
			dt_prev_execucao_w := dt_prev_execucao_w + 1;
		end if;
	else	
		ie_urgencia_w := '';
		SELECT * FROM cpoe_atualizar_periodo_vig_ant(ds_horarios_w, hr_prim_horario_w, dt_prev_execucao_w) INTO STRICT ds_horarios_w, hr_prim_horario_w, dt_prev_execucao_w;
		
		if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') then
			select	max(ie_dose_unica_cpoe),
					coalesce(max(ie_agora),'N'),
					max(qt_min_intervalo)
			into STRICT	ie_dose_unica_cpoe_w,
					ie_interv_agora_w,
					qt_min_intervalo_w
			from	intervalo_prescricao
			where	cd_intervalo = cd_intervalo_w;
			
			if (coalesce(ie_dose_unica_cpoe_w, 'N') = 'S') then
			
				ie_duracao_w := 'P';
				ie_evento_unico_w 	:= 'S';
				
				ie_se_necessario_w 	:= 'N';
				ie_acm_w			:= 'N';
				
				if (ie_interv_agora_w = 'S') then
					ie_urgencia_proc_w 	:= 'S';
				end if;
			end if;
		end if;
		
		if (ie_urgencia_proc_w = 'S') then
			dt_prev_execucao_w := clock_timestamp();
		end if;
		
		SELECT * FROM cpoe_calcular_horario_prescr(nr_atendimento_p, cd_intervalo_w, null, dt_prev_execucao_w, 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null, null, cd_procedimento_w, ie_origem_proced_w, nr_seq_proc_interno_w) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;
		
		ds_horarios_w := ds_horarios_w || ds_horarios_aux_w;
		
		hr_prim_horario_w := obter_prim_dshorarios(ds_horarios_w);
	end if;

	ie_administracao_w	:= 'P';
	
	if (ie_urgencia_proc_w = 'S') then
		ie_urgencia_w		:= '0';
		ie_se_necessario_w	:= 'N';
		ie_acm_w			:= 'N';
	else
		ie_urgencia_w := null;
		if (ie_acm_w = 'S') then
			ie_se_necessario_w	:= 'N';
			ie_administracao_w	:= 'C';
			ds_horarios_w		:= '';
			hr_prim_horario_w	:= '';
		elsif (ie_se_necessario_w = 'S') then
			ie_acm_w			:= 'N';
			ie_administracao_w	:= 'N';
			ds_horarios_w		:= '';
			hr_prim_horario_w	:= '';
		end if;
	end if;
	
	ie_duracao_w := 'C';
	
	if (ie_retrogrado_p = 'S' or ie_futuro_p = 'S') then -- retrograde item
		dt_prev_execucao_w := dt_inicio_p;
		dt_fim_w := (dt_prev_execucao_w + 1) - 1/1440;
		
		ie_urgencia_w	:= null;	
		ie_duracao_w	:= 'P';	
		nr_ocorrencia_w	:= 0;	
		ds_horarios_w	:= '';
		ds_horarios_aux_w	:= '';

		select	max(qt_min_intervalo)
		into STRICT	qt_min_intervalo_w
		from	intervalo_prescricao
		where	cd_intervalo = cd_intervalo_w;

		SELECT * FROM cpoe_calcular_horario_prescr(  nr_atendimento_p, cd_intervalo_w, null, dt_prev_execucao_w, 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null, null, cd_procedimento_w, ie_origem_proced_w, nr_seq_proc_interno_w) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;

		ds_horarios_w	:= ds_horarios_w || ds_horarios_aux_w;
		hr_prim_horario_w	:= obter_prim_dshorarios(ds_horarios_w);		
	end if;
	
	if (consiste_se_copia_proc_int(nr_seq_proc_interno_w) = 'N') then
	
		ie_duracao_w := 'P';
		if (position('A' in CPOE_Padroniza_horario_prescr(ds_horarios_w,dt_prev_execucao_w)) > 0 ) then
			ie_possuir_hor_dia_seguinte_w := 'S';
		end if;   	
		
		if (coalesce(ie_possuir_hor_dia_seguinte_w,'N') = 'N') then
			dt_fim_w := fim_dia(dt_prev_execucao_w);
		else
			dt_fim_w := fim_dia(dt_prev_execucao_w+1);
		end if;		
		
	end if;
	
	select	nextval('cpoe_procedimento_seq')
	into STRICT	nr_seq_item_gerado_p
	;
	
	insert into cpoe_procedimento(
					nr_sequencia,
					nr_atendimento,
					ie_administracao,
					ie_duracao,
					dt_inicio,
					dt_fim,
					hr_prim_horario,
					cd_intervalo,
					cd_material_exame,
					ds_horarios,
					ds_justificativa,
					ds_material_especial,
					ds_observacao,
					dt_prev_execucao,
					ie_acm,
					ie_lado,
					ie_se_necessario,
					ie_urgencia,
					nr_ocorrencia,
					nr_seq_proc_interno,
					nr_seq_prot_glic,
					nr_seq_topografia,
					qt_procedimento,
					nm_usuario,
					nm_usuario_nrec,
					dt_atualizacao,
					dt_atualizacao_nrec,
					cd_perfil_ativo,
					nr_seq_condicao,
					cd_pessoa_fisica,
					cd_funcao_origem,
					nr_seq_transcricao,
					ie_item_alta,
					ie_prescritor_aux,
					cd_medico,
					ie_retrogrado,
					nr_seq_pepo,
					nr_cirurgia,
					nr_cirurgia_patologia,
					nr_seq_agenda,
					ie_oncologia,
					nr_seq_conclusao_apae,
					nr_seq_contraste,
					ie_futuro,
					nr_seq_cpoe_order_unit,
					ie_evento_unico
      ) values (
					nr_seq_item_gerado_p,
					nr_atendimento_p,
					ie_administracao_w,
					ie_duracao_w,
					dt_prev_execucao_w,
					dt_fim_w,
					hr_prim_horario_w,
					cd_intervalo_w,
					cd_material_exame_w,
					ds_horarios_w,
					ds_justificativa_w,
					ds_material_especial_w,
					ds_observacao_w,
					dt_prev_execucao_w,
					ie_acm_w,
					ie_lado_w,
					ie_se_necessario_w,
					ie_urgencia_w,
					nr_ocorrencia_w,
					nr_seq_proc_interno_w,
					nr_seq_prot_glic_w,
					nr_seq_topografia_w,
					qt_procedimento_w,
					nm_usuario_p,
					nm_usuario_p,
					clock_timestamp(),
					clock_timestamp(),
					cd_perfil_p,
					nr_seq_condicao_w,
					cd_paciente_p,
					2314,
					nr_seq_transcricao_p,
					ie_item_alta_p,
					ie_prescritor_aux_p,
					cd_medico_p,
					ie_retrogrado_p,
					nr_seq_pepo_p,
					nr_cirurgia_p,
					nr_cirurgia_patologia_p,
					nr_seq_agenda_p,
					ie_oncologia_p,
					nr_seq_conclusao_apae_p,
					nr_seq_contraste_w,
					ie_futuro_p,
					nr_seq_cpoe_order_unit_p,
					ie_evento_unico_w
      );

	commit;

  	  CALL cpoe_consis_proced_insert(nr_seq_item_gerado_p,nm_usuario_p);
	
	if (nr_seq_prot_glic_w IS NOT NULL AND nr_seq_prot_glic_w::text <> '') then
		CALL cpoe_gerar_proc_glic( nr_seq_item_gerado_p, nr_seq_prot_glic_w, nm_usuario_p, nr_atendimento_p,cd_paciente_p);
	end if;
	
	CALL CPOE_REP_Gerar_mat_assoc_proc( nr_seq_procedimento_w, nr_seq_item_gerado_p, nr_prescricao_p, nr_atendimento_p, coalesce(dt_prev_execucao_w,trunc(clock_timestamp() + interval '1 days'/24,'hh24')), cd_paciente_p, null, 2314);

	CALL cpoe_gerar_prescr_proc_assoc(nr_seq_item_gerado_p, nm_usuario_p, cd_estabelecimento_p);
	
	end;
end loop;
close c01;

commit;
	

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_inserir_procedimento_ant ( nr_atendimento_p prescr_medica.nr_atendimento%type, nr_atendimento_ant_p prescr_medica.nr_atendimento%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nr_sequencia_p prescr_procedimento.nr_sequencia%type, nm_usuario_p prescr_medica.nm_usuario%type, cd_perfil_p bigint, cd_estabelecimento_p bigint, cd_paciente_p cpoe_procedimento.cd_pessoa_fisica%type, nr_seq_item_gerado_p INOUT bigint, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, ie_oncologia_p text default 'N', nr_seq_conclusao_apae_p bigint default null, ie_futuro_p text default 'N', nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) FROM PUBLIC;

