-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inst_sick_patient ( NR_ATENDIMENTO_P SICK_LEAVE_REPORT.NR_ATENDIMENTO%TYPE, NM_USUARIO_P SICK_LEAVE_REPORT.NM_USUARIO%TYPE, NM_USUARIO_NREC_P SICK_LEAVE_REPORT.NM_USUARIO_NREC%TYPE ) AS $body$
DECLARE

dob_cnst_p constant SICK_LEAVE_REPORT.NM_PAT_NAME%type := 'A';
sexo_cnst_p constant SICK_LEAVE_REPORT.NM_PAT_NAME%type := 'D';
medico_cnst_p constant SICK_LEAVE_REPORT.NM_PAT_NAME%type := 'C';
medico_pms_cnst_p constant SICK_LEAVE_REPORT.NM_PAT_NAME%type := 'PMS';
comp_flg_cnst_p constant SICK_LEAVE_REPORT.NM_PAT_NAME%type := 'N';

BEGIN
    INSERT INTO SICK_LEAVE_REPORT(
        NR_SEQUENCIA,
        DT_ATUALIZACAO,
        NM_USUARIO,
        DT_ATUALIZACAO_NREC,
        NM_USUARIO_NREC,
        NR_ATENDIMENTO,
        NM_PAT_NAME,
        NM_FILE_NUMBER,
        NM_PACIENT_AGE,
        DT_PAT_DOB,
        IE_GENDER,
        NM_NATIONALITY,
        NM_PAT_WARD,
        DT_DATE_VISIT_PAT,
        NM_MEDICO,
        CD_MEDICO_RESP,
        DS_TITLE,
		IE_COMP_FLG
    )
        SELECT
            nextval('sick_leave_report_seq'),
            clock_timestamp(),
            NM_USUARIO_P,
            clock_timestamp(),
            NM_USUARIO_NREC_P,
            NR_ATENDIMENTO_P,
            OBTER_NOME_PF(PF.CD_PESSOA_FISICA),
            PF.NR_PRONTUARIO,
            OBTER_IDADE(PF.DT_NASCIMENTO, clock_timestamp(), dob_cnst_p),
            PF.DT_NASCIMENTO,
            OBTER_SEXO_PF(PF.CD_PESSOA_FISICA, sexo_cnst_p),
            NC.DS_NACIONALIDADE,
            PLS_OBTER_SETOR_ATENDIMENTO(APV.CD_SETOR_ATENDIMENTO),
            AP.DT_ENTRADA,
            APV.NM_MEDICO,
            AP.CD_MEDICO_RESP,
            OBTER_NOME_MEDICO(OBTER_PF_USUARIO(AP.CD_MEDICO_RESP, medico_cnst_p), medico_pms_cnst_p),
			comp_flg_cnst_p
        FROM
            PESSOA_FISICA            PF
            JOIN ATENDIMENTO_PACIENTE     AP ON PF.CD_PESSOA_FISICA = AP.CD_PESSOA_FISICA
            JOIN ATENDIMENTO_PACIENTE_V   APV ON AP.NR_ATENDIMENTO = APV.NR_ATENDIMENTO
            LEFT JOIN NACIONALIDADE            NC ON NC.CD_NACIONALIDADE = PF.CD_NACIONALIDADE
        WHERE
            AP.NR_ATENDIMENTO = NR_ATENDIMENTO_P;

EXCEPTION
    WHEN unique_violation THEN
        NULL;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inst_sick_patient ( NR_ATENDIMENTO_P SICK_LEAVE_REPORT.NR_ATENDIMENTO%TYPE, NM_USUARIO_P SICK_LEAVE_REPORT.NM_USUARIO%TYPE, NM_USUARIO_NREC_P SICK_LEAVE_REPORT.NM_USUARIO_NREC%TYPE ) FROM PUBLIC;

