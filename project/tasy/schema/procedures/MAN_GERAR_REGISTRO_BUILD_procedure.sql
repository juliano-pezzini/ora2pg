-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_registro_build ( nr_sequencia_ctrl_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_versoes_w	bigint := 0;
nr_seq_regra_w	bigint;
ie_aplicacao_w	varchar(1);

C01 CURSOR FOR
	SELECT distinct cd_versao, nr_sequencia
		from (	SELECT	cd_versao,
						nr_sequencia
				from	man_regra_versao_build
				where	ie_regra = 'F'
				
union

				select	cd_versao,
						nr_seq_regra_w
				from (	select	cd_versao cd_versao
							from	aplicacao_tasy_versao
							where	cd_aplicacao_tasy = 'Tasy'
							and	coalesce(IE_VERSAO_OFICIAL, 'N') = 'S'
							--and	(sysdate - dt_versao) > 3
							order by dt_versao desc) alias1 LIMIT (qt_versoes_w)) a
		where	not exists (select 1 from man_os_ctrl_build b where a.cd_versao = b.cd_versao and nr_seq_man_os_ctrl_desc = nr_sequencia_ctrl_p)
	order by	cd_versao desc;

BEGIN

select	max(ie_aplicacao)
into STRICT	ie_aplicacao_w
from	man_os_ctrl_desc
where	nr_sequencia = nr_sequencia_ctrl_p;

if (not(ie_aplicacao_w = 'H' or ie_aplicacao_w = 'S')) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1017740, null);
end if;

select	max(nr_sequencia),
		max(qt_versoes)
into STRICT	nr_seq_regra_w,
		qt_versoes_w
from	man_regra_versao_build
where	nr_sequencia = 	(	SELECT	max(nr_sequencia)
							from	man_regra_versao_build
							where	ie_regra = 'V');

for rs_w in C01 loop
	insert into man_os_ctrl_build(	nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								cd_versao,
								cd_build,
								dt_inicio_geracao,
								nr_seq_man_os_ctrl_desc,
								dt_fim_geracao,
								nm_usuario_geracao,
								nr_seq_regra,
								ie_situacao)
							values (
								nextval('man_os_ctrl_build_seq'),
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								rs_w.cd_versao,
								null,
								null,
								nr_sequencia_ctrl_p,
								null,
								null,
								rs_w.nr_sequencia,
								'A');
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_registro_build ( nr_sequencia_ctrl_p bigint, nm_usuario_p text) FROM PUBLIC;

