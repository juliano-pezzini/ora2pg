-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE com_alerta_canal_previsao ( qt_dia_p bigint, cd_empresa_p bigint) AS $body$
DECLARE

 
nr_sequencia_w		bigint;
nm_cliente_w		varchar(255);
qt_dias_falta_w		bigint;
ds_assunto_w		varchar(100);
ds_mensagem_w		varchar(2000);
ds_email_w		varchar(2000);
nm_fantasia_w		varchar(255);
ds_canal_w		varchar(254);
ds_email_gestor_w		varchar(2000);
dt_fim_atuacao_w		timestamp;
ds_produto_w		varchar(80);

c01 CURSOR FOR 
SELECT	a.nr_sequencia, 
	substr(Obter_Desc_Cliente(a.nr_sequencia,'N'),1,255) nm_cliente, 
	obter_dias_entre_datas(clock_timestamp(), coalesce(a.dt_revisao_prevista,trunc(clock_timestamp()))), 
	substr(Obter_Desc_Cliente(a.nr_sequencia,'F'),1,255) nm_fantasia 
from	com_cliente a 
where	a.cd_empresa = cd_empresa_p 
and	a.ie_classificacao = 'P' 
and (obter_dias_entre_datas(clock_timestamp(), coalesce(a.dt_revisao_prevista,trunc(clock_timestamp()))) <= qt_dia_p) 
and	a.nr_sequencia in (	SELECT	b.nr_seq_cliente 
			from	com_canal_cliente b 
			where	b.nr_seq_cliente = a.nr_sequencia 
			and	coalesce(b.dt_fim_atuacao::text, '') = '' 
			and	b.ie_tipo_atuacao = 'V');

c02 CURSOR FOR 
	SELECT	substr(obter_dados_pf_pj(null,b.cd_cnpj,'N'),1,254) 
	from	com_canal b, 
		com_cliente c, 
		com_canal_cliente a 
	where	a.nr_seq_canal 	= b.nr_sequencia 
	and	a.nr_seq_cliente	= c.nr_sequencia 
	and	a.nr_seq_cliente 	= nr_sequencia_w 
	and	c.ie_classificacao	= 'P' 
	and	a.ie_tipo_atuacao	= 'V' 
	and	((a.dt_fim_atuacao	= trunc(dt_fim_atuacao_w,'dd')) or (coalesce(a.dt_fim_atuacao::text, '') = ''));

c03 CURSOR FOR 
	SELECT	substr(obter_compl_pf(cd_pessoa_fisica,1,'M'),1,2000) 
	from	com_cliente_gestor 
	where	nr_seq_cliente = nr_sequencia_w 
	and	coalesce(dt_final::text, '') = '';


BEGIN 
 
open c01;
loop 
fetch c01 into 
	nr_sequencia_w, 
	nm_cliente_w, 
	qt_dias_falta_w, 
	nm_fantasia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	ds_assunto_w	:= substr(wheb_mensagem_pck.get_texto(305554,'NM_FANTASIA_W='||nm_fantasia_w),1,70); --'Alerta previsão de fechamento: ' || nm_fantasia_w 
	begin 
	select	max(substr(obter_dados_pf_pj_estab(cd_empresa_p,null,b.cd_cnpj,'M'),1,255) || ',' || 'canais@wheb.com.br') 
	into STRICT	ds_email_w 
	from	com_canal b, 
		com_canal_cliente a 
	where	a.nr_seq_canal = b.nr_sequencia 
	and	coalesce(a.dt_fim_atuacao::text, '') = '' 
	and	a.ie_tipo_atuacao	= 'V' 
	and	a.nr_seq_cliente = nr_sequencia_w;
	exception 
		when no_data_found then 
		ds_email_w	:= 'canais@wheb.com.br';
	end;
 
	open c02;
	loop 
	fetch c02 into 
		ds_canal_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
 
		if (substr(ds_email_w,1,1) = ',') then	 
			ds_email_w := substr(ds_email_w,2,255);
		end if;
 
		open c03;
		loop 
		fetch c03 into 
			ds_email_gestor_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin 
			ds_email_w	:= substr(ds_email_w || ',' || ds_email_gestor_w,1,2000);
			end;
		end loop;
		close c03;
 
		select	substr(obter_valor_dominio(2668,a.ie_produto),1,60) 
		into STRICT	ds_produto_w 
		from	com_cliente a 
		where	a.nr_sequencia = nr_sequencia_w;
		--'Faltam ' || abs(qt_dias_falta_w) || ' dia(s) para vencer a sua previsão de fechamento da conta: ' || nr_sequencia_w || ' - ' || nm_cliente_w || 'Produto: ' || ds_produto_w 
		ds_mensagem_w	:= substr(wheb_mensagem_pck.get_texto(305555,'QT_DIAS_FALTA_W='||abs(qt_dias_falta_w)||';NR_SEQUENCIA_W='||nr_sequencia_w||';NM_CLIENTE_W= '||nm_cliente_w||';DS_PRODUTO_W='||ds_produto_w),1,2000);
		if (qt_dias_falta_w < 0) and (qt_dias_falta_w >= -30) then 
			--'Passaram ' || abs(qt_dias_falta_w) || ' dia(s) do vencimento da sua previsão de fechamento da conta: ' || nm_cliente_w 
			ds_mensagem_w	:= substr(wheb_mensagem_pck.get_texto(305556,'QT_DIAS_FALTA_W='||abs(qt_dias_falta_w)||';NM_CLIENTE_W='||nm_cliente_w||';DS_PRODUTO_W='||ds_produto_w),1,2000);
		elsif (qt_dias_falta_w < -30) then 
			begin 
			dt_fim_atuacao_w	:= clock_timestamp();
 
			update	com_canal_cliente 
			set	dt_fim_atuacao	= trunc(dt_fim_atuacao_w,'dd'), 
				dt_atualizacao	= dt_fim_atuacao_w, 
				nm_usuario	= 'Tasy' 
			where	nr_seq_cliente	= nr_sequencia_w 
			and	ie_tipo_atuacao	= 'V' 
			and	coalesce(dt_fim_atuacao::text, '') = '';
			 
			update	com_cliente		/*Anderson 14/05/08 - OS93056*/
 
			set	ie_classificacao = 'AA', 
				nm_usuario	= 'Tasy', 
				dt_atualizacao	= clock_timestamp(), 
				ie_fase_venda	= 'F', 
				nr_seq_ativ	= 23 
			where	nr_sequencia	= nr_sequencia_w;
			--A atuação do canal ' || ds_canal_w || ' na conta ' || nm_cliente_w || ' foi encerrada automaticamente pelo Tasy pois está a mais de 30 dias sem ser atualizada. 
			ds_mensagem_w	:= wheb_mensagem_pck.get_texto(305557,'DS_CANAL_W='||ds_canal_w||'NM_CLIENTE_W='||nm_cliente_w);
			end;
		end if;
		 
		ds_email_w := replace(ds_email_w,';',',');
		 
		--begin 
		CALL enviar_email(ds_assunto_w, ds_mensagem_w, 'comercial@wheb.com.br', ds_email_w, 'Tasy', 'M');
		 
		insert into com_cliente_envio(	 
					nr_sequencia, 
					dt_atualizacao, 
					nm_usuario, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec, 
					nr_seq_cliente, 
					dt_envio, 
					ie_tipo_envio, 
					ds_destino, 
					ds_observacao) 
				values (	nextval('com_cliente_envio_seq'), 
					clock_timestamp(), 
					'Tasy', 
					clock_timestamp(), 
					'Tasy', 
					nr_sequencia_w, 
					clock_timestamp(), 
					'J', 
					substr(ds_email_w,1,255), 
					--'Job de alerta de previsão de fechamento' 
					substr(wheb_mensagem_pck.get_texto(305558) || chr(13) || chr(10) || ds_mensagem_w,1,2000));
		/*exception when others then 
			insert into logxxxxtasy( 
					dt_atualizacao, 
					nm_usuario, 
					cd_log, 
					ds_log) 
				values(	sysdate, 
					'JobAlertaPrev', 
					55765, 
					substr(ds_mensagem_w,1,2000)); 
		end;*/
 
		end;
	END LOOP;
	CLOSE C02;
	end;
end loop;
close c01;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE com_alerta_canal_previsao ( qt_dia_p bigint, cd_empresa_p bigint) FROM PUBLIC;

