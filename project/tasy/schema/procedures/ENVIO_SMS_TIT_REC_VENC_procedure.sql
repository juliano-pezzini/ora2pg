-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE envio_sms_tit_rec_venc (nm_usuario_p text) AS $body$
DECLARE

 
nr_ddd_celular_w	  	varchar(3);
nr_telefone_celular_w	numeric(20);
id_sms_w			bigint;
ds_remetente_w		varchar(50);
ds_mensagem_w		varchar(200);
ds_nome_w		varchar(50);
dt_vencimento_w		timestamp;
ds_erro_w		varchar(4000);
ds_esconder_ddi_w	varchar(1);

C01 CURSOR FOR 
SELECT	distinct      
	CASE WHEN ds_esconder_ddi_w='S' THEN  b.nr_ddd_celular  ELSE b.nr_ddi_celular END  nr_ddd, 
	somente_numero(b.nr_telefone_celular) nr_celular, 
	substr(obter_primeiro_nome(obter_nome_pf(a.cd_pessoa_fisica)),1,20) ds_nome 
from	titulo_receber a, 
	pessoa_fisica b 
where	a.cd_pessoa_fisica = b.cd_pessoa_fisica 
and 	(a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '') 
and 	(b.nr_telefone_celular IS NOT NULL AND b.nr_telefone_celular::text <> '') 
and 	(b.nr_ddd_celular IS NOT NULL AND b.nr_ddd_celular::text <> '') 
and	a.dt_pagamento_previsto	= trunc(clock_timestamp() - interval '2 days') 
and	a.vl_saldo_titulo > 0 

union all
 
SELECT	distinct 
    CASE WHEN ds_esconder_ddi_w='S' THEN  d.nr_ddd_telefone  ELSE d.nr_ddi_telefone END  nr_ddd, 
	somente_numero(d.nr_telefone_celular) nr_celular, 
	substr(obter_primeiro_nome(obter_nome_razao_social(a.cd_cgc)),1,20) ds_nome 
from	titulo_receber a, 
	pessoa_juridica c, 
	pessoa_juridica_compl d 
where	a.cd_cgc = c.cd_cgc 
and 	a.cd_cgc = d.cd_cgc 
and 	(a.cd_cgc IS NOT NULL AND a.cd_cgc::text <> '') 
and 	(d.nr_telefone_celular IS NOT NULL AND d.nr_telefone_celular::text <> '') 
and 	(d.nr_ddd_telefone IS NOT NULL AND d.nr_ddd_telefone::text <> '') 
and	a.dt_pagamento_previsto	= trunc(clock_timestamp() - interval '2 days') 
and	a.vl_saldo_titulo > 0;


BEGIN 
ds_esconder_ddi_w := OBTER_VALOR_PARAM_USUARIO(0,214,0,obter_usuario_ativo,obter_estabelecimento_ativo);
 
select 	substr(obter_nome_estabelecimento(obter_estabelecimento_ativo),1,50) 
into STRICT	ds_remetente_w
;
 
open c01;
loop 
fetch c01 into	 
	nr_ddd_celular_w, 
	nr_telefone_celular_w, 
	ds_nome_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
 
	--Sr(a). #@DS_NOME#@, não identificamos o pgto do seu boleto venc. em #@DT_VENCIMENTO#@. 
	--Se já efetuado o pgto, favor desconsiderar esta mensagem. 
	--Att. Clinica São Roque 
 
	select 	wheb_mensagem_pck.get_texto(352395, 'DS_NOME=' || ds_nome_w || ';DT_VENCIMENTO=' || to_char(clock_timestamp() - interval '2 days','dd/mm/yyyy')) 
	into STRICT	ds_mensagem_w 
	;	
 
	id_sms_w := wheb_sms.enviar_sms(ds_remetente_w, nr_ddd_celular_w||nr_telefone_celular_w, ds_mensagem_w, nm_usuario_p, id_sms_w);
 
	insert into log_envio_sms(nr_sequencia, 
		dt_atualizacao, 
		dt_atualizacao_nrec, 
		nm_usuario, 
		dt_envio, 
		nr_telefone, 
		ds_mensagem,	 
		id_sms) 
	values (nextval('log_envio_sms_seq'), 
		clock_timestamp(), 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nr_telefone_celular_w, 
		ds_mensagem_w, 
		id_sms_w);
 
	exception 
	when others then 
		ds_erro_w	:= sqlerrm;
 
		insert into log_envio_sms(nr_sequencia, 
			dt_atualizacao, 
			dt_atualizacao_nrec, 
			nm_usuario, 
			dt_envio, 
			nr_telefone, 
			ds_mensagem,	 
			id_sms) 
		values (nextval('log_envio_sms_seq'), 
			clock_timestamp(), 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nr_ddd_celular_w || nr_telefone_celular_w, 
			substr(' Erro: ' || ds_erro_w ,1,2000), 
			0);	
	end;	
	 
end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE envio_sms_tit_rec_venc (nm_usuario_p text) FROM PUBLIC;

