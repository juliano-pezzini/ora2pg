-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_pp_atualiza_evento_resumo ( dt_inicio_p timestamp, dt_fim_p timestamp, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


-- em testes na base da USJRP não estava utilizando o indice pela data e sim pelo cmapo nr_seq_lote_pgto + ie_situacao
-- caso de algum problema de performance lá tentar utilizar o hint pelo indice /*+ INDEX(a plscomr_i8) */
c01 CURSOR(	dt_inicio_pc	timestamp,
		dt_fim_pc	timestamp) FOR
	SELECT	distinct a.nr_seq_conta nr_seq_conta
	from	pls_conta_medica_resumo a
	where	a.dt_competencia_pgto between dt_inicio_pc and dt_fim_pc
	and	a.ie_situacao	= 'A'
	and	a.ie_status	= 'F'
	and	coalesce(a.nr_seq_pp_lote::text, '') = ''
	and	coalesce(a.nr_seq_lote_pgto::text, '') = '';

BEGIN
-- verifica se tem algo para atualizar nas tabelas
CALL pls_gerencia_upd_obj_pck.atualizar_objetos('Tasy', 'PLS_FILTRO_REGRA_EVENT_CTA_PCK.GERENCIA_REGRA_FILTRO', 'PLS_GRUPO_SERVICO_TM');
CALL pls_gerencia_upd_obj_pck.atualizar_objetos('Tasy', 'PLS_FILTRO_REGRA_EVENT_CTA_PCK.GERENCIA_REGRA_FILTRO', 'PLS_ESTRUTURA_MATERIAL_TM');

for r_c01_w in c01(dt_inicio_p, dt_fim_p) loop

	CALL pls_filtro_regra_event_cta_pck.gerencia_regra_filtro(	null, r_c01_w.nr_seq_conta, cd_estabelecimento_p,
								nm_usuario_p);
end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pp_atualiza_evento_resumo ( dt_inicio_p timestamp, dt_fim_p timestamp, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

