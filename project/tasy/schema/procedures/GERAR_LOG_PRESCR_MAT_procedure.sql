-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_log_prescr_mat ( nr_prescricao_p bigint, nr_seq_item_p bigint, ie_agrupador_p bigint, nr_seq_horario_p bigint, ie_tipo_item_p text, ds_log_p text, nm_usuario_p text, ie_commit_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
nr_seq_dieta_w		bigint;
nr_seq_material_w	bigint;
nr_seq_procedimento_w	bigint;
nr_seq_rec_w		bigint;
ds_stack_w		varchar(4000);
ds_log_w		varchar(4000);
ie_tipo_item_w		varchar(10);


BEGIN

ds_stack_w	:= substr(dbms_utility.format_call_stack,1,4000);
ds_log_w	:= substr(ds_log_p,1,4000);

if (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') then
	ie_tipo_item_w	:= substr(ie_tipo_item_p,1,10);
elsif (ie_agrupador_p IS NOT NULL AND ie_agrupador_p::text <> '') then
	case	to_char(ie_agrupador_p)
		when	'1'	then ie_tipo_item_w := 'M';
		when	'2'	then ie_tipo_item_w := 'MAT';
		when 	'4'	then ie_tipo_item_w := 'SOL';
		when	'5'	then ie_tipo_item_w := 'IA';
		when	'6'	then ie_tipo_item_w := 'M';
		when	'8'	then ie_tipo_item_w := 'SNE';
		when	'12'	then ie_tipo_item_w := 'S';
		when	'16'	then ie_tipo_item_w := 'LD';
		else		ie_tipo_item_w := '';
	end case;
end if;

if (ie_tipo_item_w	in ('P','G','HM','I','L')) then
	nr_seq_procedimento_w	:= nr_seq_item_p;
elsif (ie_tipo_item_w	in ('S','SNE','M','MAT','LD','IA','IAG')) then
	nr_seq_material_w	:= nr_seq_item_p;
elsif (ie_tipo_item_w	in ('D')) then
	nr_seq_dieta_w	:= nr_seq_item_p;
elsif (ie_tipo_item_w	in ('R')) then
	nr_seq_rec_w	:= nr_seq_item_p;
end if;

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (ds_log_p IS NOT NULL AND ds_log_p::text <> '') then
	begin
	select	nextval('log_prescr_material_seq')
	into STRICT	nr_sequencia_w
	;

	insert	into log_prescr_material(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_prescricao,
				nr_seq_material,
				ie_agrupador,
				ds_log,
				ds_stack)
		values (nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_prescricao_p,
			nr_seq_material_w,
			ie_agrupador_p,
			ds_log_w,
			ds_stack_w);

	if (ie_commit_p = 'S') then
		commit;
	end if;
	exception
	when others then
		nr_seq_rec_w	:= 0;
	end;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_log_prescr_mat ( nr_prescricao_p bigint, nr_seq_item_p bigint, ie_agrupador_p bigint, nr_seq_horario_p bigint, ie_tipo_item_p text, ds_log_p text, nm_usuario_p text, ie_commit_p text) FROM PUBLIC;

