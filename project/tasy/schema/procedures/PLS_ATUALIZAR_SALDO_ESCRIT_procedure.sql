-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_saldo_escrit ( nr_seq_escrituracao_p bigint, nm_usuario_p text, ie_abre_cursor_p text) AS $body$
DECLARE

			
ie_tipo_escrituracao_w		varchar(2)	:= null;
vl_saldo_acumulado_w		double precision	:= 0;
vl_saldo_acumulado_ant_w	double precision	:= 0;
nr_seq_escrituracao_w		bigint;
nr_seq_cooperado_w		bigint;
pr_acrescimo_w			double precision	:= 0;
dt_lancamento_w			timestamp;
dt_lancamento_ant_w		timestamp;
nr_seq_escrit_anterior_w	bigint;

C01 CURSOR FOR
	SELECT	a.nr_sequencia
	from	pls_escrituracao_quota	a,
		pls_tipo_escrit_quota	b
	where	b.nr_sequencia	= a.nr_seq_tipo_escrit_quota
	and	a.nr_sequencia	<> nr_seq_escrituracao_p
	and	a.nr_seq_cooperado = nr_seq_cooperado_w
	and	trunc(a.dt_lancamento, 'dd') >= dt_lancamento_w
	order by a.dt_lancamento,
		a.nr_sequencia;


BEGIN

select	max(b.ie_tipo_escrituracao),
	coalesce(max(a.pr_acrescimo),0),
	trunc(max(a.dt_lancamento),'dd'),
	max(a.nr_seq_cooperado)
into STRICT	ie_tipo_escrituracao_w,
	pr_acrescimo_w,
	dt_lancamento_w,
	nr_seq_cooperado_w
from	pls_escrituracao_quota	a,
	pls_tipo_escrit_quota	b
where	b.nr_sequencia	= a.nr_seq_tipo_escrit_quota
and	a.nr_sequencia	= nr_seq_escrituracao_p;

select	max(x.nr_sequencia)
into STRICT	nr_seq_escrit_anterior_w
from	pls_escrituracao_quota	x
where	trunc(x.dt_lancamento, 'dd')	<= dt_lancamento_w
and	x.nr_sequencia			<> nr_seq_escrituracao_p
and	x.nr_seq_cooperado		= nr_seq_cooperado_w;

select	coalesce(max(a.vl_saldo_acumulado),0)
into STRICT	vl_saldo_acumulado_ant_w
from	pls_escrituracao_quota	a
where	a.nr_sequencia		= nr_seq_escrit_anterior_w;

if (ie_tipo_escrituracao_w = 'IQ') then
	select	vl_escrituracao + vl_saldo_acumulado_ant_w
	into STRICT	vl_saldo_acumulado_w
	from	pls_escrituracao_quota
	where	nr_sequencia	= nr_seq_escrituracao_p;
	
elsif (ie_tipo_escrituracao_w = 'AS') then
	select	vl_escrituracao
	into STRICT	vl_saldo_acumulado_w
	from	pls_escrituracao_quota
	where	nr_sequencia	= nr_seq_escrituracao_p;
	
elsif (ie_tipo_escrituracao_w = 'AC') then
	vl_saldo_acumulado_w	:= vl_saldo_acumulado_ant_w + (dividir(vl_saldo_acumulado_ant_w * pr_acrescimo_w,100));
	
elsif (ie_tipo_escrituracao_w = 'DS') then
	vl_saldo_acumulado_w	:= vl_saldo_acumulado_ant_w - (dividir(vl_saldo_acumulado_ant_w * pr_acrescimo_w,100));
	
elsif (ie_tipo_escrituracao_w = 'DQ') then
	select (vl_saldo_acumulado_ant_w - vl_escrituracao)
	into STRICT	vl_saldo_acumulado_w
	from	pls_escrituracao_quota
	where	nr_sequencia		= nr_seq_escrituracao_p;
end if;

update	pls_escrituracao_quota
set	vl_saldo_acumulado	= vl_saldo_acumulado_w
where	nr_sequencia		= nr_seq_escrituracao_p;

if (ie_abre_cursor_p = 'S') then
	open C01;
	loop
	fetch C01 into	
		nr_seq_escrituracao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		CALL pls_atualizar_saldo_escrit(nr_seq_escrituracao_w, nm_usuario_p,'N');	
		end;
	end loop;
	close C01;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_saldo_escrit ( nr_seq_escrituracao_p bigint, nm_usuario_p text, ie_abre_cursor_p text) FROM PUBLIC;

