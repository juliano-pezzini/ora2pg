-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_status_analise_finalizada ( nr_seq_conta_p bigint, nm_usuario_p text, cd_estabelecimento_p text) AS $body$
DECLARE


qt_contas_analise_w		bigint;
nr_seq_fatura_w			bigint;
nr_seq_acao_w			bigint	:= null;
nr_titulo_w			bigint;
nr_titulo_ndc_w			bigint;
dt_liquidacao_w			timestamp;
ie_status_fatura_w		ptu_fatura.ie_status%type;


BEGIN
select	max(nr_seq_fatura)
into STRICT	nr_seq_fatura_w
from	pls_conta
where	nr_sequencia	= nr_seq_conta_p;

if (nr_seq_fatura_w IS NOT NULL AND nr_seq_fatura_w::text <> '') then
	select	count(*)
	into STRICT	qt_contas_analise_w
	from	pls_analise_conta	a,
		pls_conta		b
	where	b.nr_seq_analise	= a.nr_sequencia
	and	b.nr_seq_fatura		= nr_seq_fatura_w
	and	a.ie_status		<> 'T';

	select	max(a.nr_titulo),
		max(a.nr_titulo_ndc),
		max(a.ie_status)
	into STRICT	nr_titulo_w,
		nr_titulo_ndc_w,
		ie_status_fatura_w
	from	ptu_fatura a
	where	a.nr_sequencia = nr_seq_fatura_w;

	if (qt_contas_analise_w = 0) and (ie_status_fatura_w <> 'V') then
		CALL ptu_atualizar_status_fatura(nr_seq_fatura_w, 'AF', null, nm_usuario_p);
	end if;

	if (nr_seq_fatura_w IS NOT NULL AND nr_seq_fatura_w::text <> '') then
		nr_seq_acao_w := pls_obter_acao_intercambio(	'4',  -- Finalização da análise das contas
						'2',  -- Gerar título a pagar
						nr_seq_fatura_w, null, null, null, clock_timestamp(), 'A500', 'N', nr_seq_acao_w);

		if (nr_seq_acao_w IS NOT NULL AND nr_seq_acao_w::text <> '') then
			CALL ptu_gerar_tit_pagar_fatura(nr_seq_fatura_w,nr_seq_acao_w,'G',cd_estabelecimento_p,nm_usuario_p);
		end if;

		nr_seq_acao_w := pls_obter_acao_intercambio(	'4',  -- Finalização da análise das contas
						'5',  -- Liberar pagamento do título
						nr_seq_fatura_w, null, null, null, clock_timestamp(), 'A500', 'N', nr_seq_acao_w);

		if (nr_seq_acao_w IS NOT NULL AND nr_seq_acao_w::text <> '') then
			if (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then
				CALL pls_liberar_fatura_pagamento(nr_titulo_w,nm_usuario_p);
			end if;

			if (nr_titulo_ndc_w IS NOT NULL AND nr_titulo_ndc_w::text <> '') then
				CALL pls_liberar_fatura_pagamento(nr_titulo_ndc_w,nm_usuario_p);
			end if;
		end if;

		nr_seq_acao_w := pls_obter_acao_intercambio(	'4',  -- Finalização da análise das contas
						'8',  -- Mudar status do título a pagar
						nr_seq_fatura_w, null, null, null, clock_timestamp(), 'A500', 'N', nr_seq_acao_w);

		if (nr_seq_acao_w IS NOT NULL AND nr_seq_acao_w::text <> '') then
			if (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then
				CALL pls_alterar_status_fatura_pag(nr_titulo_w,nm_usuario_p);
			end if;

			if (nr_titulo_ndc_w IS NOT NULL AND nr_titulo_ndc_w::text <> '') then
				CALL pls_alterar_status_fatura_pag(nr_titulo_ndc_w,nm_usuario_p);
			end if;
		end if;

		nr_seq_acao_w := pls_obter_acao_intercambio(	'4',  -- Finalização da análise das contas
						'7',  -- Baixar valor glosado no título
						nr_seq_fatura_w, null, null, null, clock_timestamp(), 'A500', 'N', nr_seq_acao_w);

		if (nr_seq_acao_w IS NOT NULL AND nr_seq_acao_w::text <> '') then
			CALL pls_baixar_glosas_conta_pag(nr_seq_conta_p,nr_seq_acao_w,nr_seq_fatura_w,nm_usuario_p,cd_estabelecimento_p);
		end if;
	end if;

	--aaschlote 21/10/2015 - OS 880346 Caso tenha todas as análises com atendimento encerrado e o título a pagar já esteja liquidado, atualizar o status do protocolo
	if (qt_contas_analise_w	= 0) and (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then

		select	max(dt_liquidacao)
		into STRICT	dt_liquidacao_w
		from	titulo_pagar
		where	nr_titulo	= nr_titulo_w;

		if (dt_liquidacao_w IS NOT NULL AND dt_liquidacao_w::text <> '') then
			CALL pls_protocolo_atualizar_status(nr_titulo_w,nm_usuario_p);
		end if;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_status_analise_finalizada ( nr_seq_conta_p bigint, nm_usuario_p text, cd_estabelecimento_p text) FROM PUBLIC;

