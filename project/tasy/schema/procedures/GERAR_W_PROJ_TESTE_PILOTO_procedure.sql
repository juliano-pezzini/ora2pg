-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_proj_teste_piloto ( nr_seq_projeto_p text) AS $body$
DECLARE



dt_prev_inic_w		timestamp;
nr_seq_tp_cliente_w	bigint;
nm_modulo_w		varchar(40);
ds_roteiro_w		varchar(80);
pr_efetividade_w	double precision;

c01 CURSOR FOR
SELECT	e.dt_prev_inic,
	e.nr_sequencia
from	proj_tp_cliente e
where	e.nr_seq_proj = nr_seq_projeto_p;

c02 CURSOR FOR
SELECT	a.nm_modulo,
	b.ds_roteiro,
	coalesce(proj_tp_rot_aderencia(c.nr_seq_cliente, c.nr_seq_roteiro),0) pr_efetividade
from	proj_tp_cli_rot c,
	proj_tp_roteiro b,
	modulo_implantacao a
where	a.nr_sequencia	= b.nr_seq_modulo
and	b.nr_sequencia	= c.nr_seq_roteiro
and	c.nr_seq_cliente	= nr_seq_tp_cliente_w;


BEGIN

delete from w_proj_teste_piloto;

open	c01;
loop
fetch	c01 into
	dt_prev_inic_w,
	nr_seq_tp_cliente_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	open	c02;
	loop
	fetch	c02 into
		nm_modulo_w,
		ds_roteiro_w,
		pr_efetividade_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin

		insert into 	w_proj_teste_piloto(	dt_teste_piloto,
							ds_modulo,
							ds_roteiro,
							pr_efetividade,
							nr_seq_tp_cliente)
						values (	dt_prev_inic_w,
							nm_modulo_w,
							ds_roteiro_w,
							pr_efetividade_w,
							nr_seq_tp_cliente_w);

		commit;

		end;
	end loop;
	close c02;

	end;
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_proj_teste_piloto ( nr_seq_projeto_p text) FROM PUBLIC;

