-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_movto_trans_financ ( nr_documento_p bigint, ie_tipo_documento_p bigint, dt_transacao_p timestamp, nm_usuario_p text, cd_tipo_baixa_cpa_p bigint, nr_seq_trans_financ_p bigint default null) AS $body$
DECLARE


dt_emissao_w 		titulo_receber.dt_emissao%type;
ie_permite_bx_tit_bordero_w	varchar(1);
cont_w 			smallint;
nr_bordero_w 		bordero_pagamento.nr_bordero%type;
vl_transacao_w 		movto_trans_financ.vl_transacao%type;
ie_acao_w 		transacao_financeira.ie_acao%type;
ds_transacao_w 		transacao_financeira.ds_transacao%type;
ie_bordero_banco_w 	varchar(1);
ie_altera_valor_tit_escrit_w    parametros_contas_pagar.ie_altera_valor_tit_escrit%type;
cd_estabelecimento_w	bigint;
qt_registro_w   integer;

/*----------------------------------------------------------------------------------------------------------------------------------------------------      
Essa Rotina foi criada para ser utilizada no no Movto_Trans_financ_dbpBeforePost no delphi devido ao 
problema de salvar o registro na MOVTO_TRANS_FINANC e depois no AfterPost do delphi
chamar a rotina de atualizar_movto_banco que  chama atualizar_transacao_finance ira e existem
muitas consistencias nelas. Qualquer consistencia que for apresentada nisso vai causar problema
pois  apenas aquilo que seria inserido/atualizado/deletado pela rotina que foi chamada no afterpost do delphi
ira ocorrer rollback. O post na MOVTO_TRANS_FINANC ficara, onde o registro ficara no banco.

Um exemplo seria a baixa de um titulo com data de recebimento a sua emissao, onde salva o registro no banco
MOVTO_TRANS_FINANC e nao lanca a baixa no titulo.

 IE_TIPO_DOCUMENTO_P

        1 - Titulo Receber
        2 - Titulo Pagar
        3 - Bordero a Pagar
*/
BEGIN

cd_estabelecimento_w := obter_estabelecimento_ativo;

select	max(coalesce(b.ie_acao,0)),
	max(b.ds_transacao)
into STRICT	ie_acao_w,
	ds_transacao_w
from	transacao_financeira b
where	b.nr_sequencia		= nr_seq_trans_financ_p;
	
if ((nr_documento_p IS NOT NULL AND nr_documento_p::text <> '') and ie_tipo_documento_p = '3') then
	select max(ie_bordero_banco)
	into STRICT ie_bordero_banco_w
	from bordero_pagamento
	where nr_bordero = nr_documento_p;
	
	if (coalesce(ie_bordero_banco_w::text, '') = '' or ie_bordero_banco_w  = 'P') then
		select	max(ie_bordero_banco)
		into STRICT	ie_bordero_banco_w
		from	parametros_contas_pagar
		where	cd_estabelecimento	= cd_estabelecimento_w;
	end if;
else
	select	max(ie_bordero_banco)
	into STRICT	ie_bordero_banco_w
	from	parametros_contas_pagar
	where	cd_estabelecimento	= cd_estabelecimento_w;
end if;

ie_permite_bx_tit_bordero_w := Obter_Param_Usuario(814, 98, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_permite_bx_tit_bordero_w);

if ( coalesce(nr_documento_p,0) <> 0 ) and ( coalesce(ie_tipo_documento_p,0) <> 0 ) then

		/*Titulo Receber*/

		if (ie_tipo_documento_p = '1') then

			select  max(a.dt_emissao)
			into STRICT    dt_emissao_w
			from    titulo_receber a
			where   a.nr_titulo     = nr_documento_p;

			if (dt_emissao_w IS NOT NULL AND dt_emissao_w::text <> '') and (dt_transacao_p IS NOT NULL AND dt_transacao_p::text <> '') then
			/*RRRR no lugar de YYYY devido a mudanca do seculo. Se deixar YYYY e o titulo emitido em 99 e  a baixa ocorrer em 2015, vai consistir, pois pegara apenas 99 com 15, onde 99 e maior que 15 caindo incorretamente na consistencia.*/

				if ( to_date(dt_transacao_p,'dd/mm/RRRR hh24:mi:ss') < to_date(dt_emissao_w,'dd/mm/RRRR hh24:mi:ss') )	then
								/*A data de recebimento nao pode ser menor do que a data de emissao do titulo!*/

								CALL wheb_mensagem_pck.exibir_mensagem_abort(337608, 'DT_RECEBIMENTO_W=' || dt_transacao_p || ';' || 'DT_EMISSAO_W=' || dt_emissao_w || ';' || 'NR_TITULO_W=' || nr_documento_p );
				end if;
			end if;

		/*Titulos Pagar*/

		elsif (ie_tipo_documento_p = '2') then
			/*Consistencia para nao deixar titulos que estao em bordero serem baixados no controle bancario, param 97*/

			if ( coalesce(ie_permite_bx_tit_bordero_w,'S') = 'N') then
			
				select	count(*),
						max(a.nr_bordero)
				into STRICT	cont_w,
						nr_bordero_w
				from	titulo_pagar_bordero_v a
				where	a.nr_titulo = nr_documento_p;
				
				if (cont_w > 0) then
					/*Este titulo esta em bordero, nao pode ser baixado via banco. Parametro [97]
					Nr titulo: #@nr_documento_p#@
					Nr bordero: #@nr_bordero_w#@*/
					CALL wheb_mensagem_pck.exibir_mensagem_abort(359854,'nr_documento_p='||nr_documento_p||';'|| 'nr_bordero_w='||nr_bordero_w);
				end if;
			
			end if;

			select coalesce(max(ie_altera_valor_tit_escrit), 'N')
			into STRICT   ie_altera_valor_tit_escrit_w
			from   parametros_contas_pagar
			where  cd_estabelecimento = cd_estabelecimento_w;

			if (ie_altera_valor_tit_escrit_w = 'N') then
					select count(*)
					into STRICT   qt_registro_w
					from   banco_escritural b,
									titulo_pagar_escrit a
					where  b.nr_sequencia = a.nr_seq_escrit
					and    b.ie_remessa_retorno = 'R'
					and    a.nr_titulo = nr_documento_p;
			
					if (qt_registro_w > 0) then
							CALL wheb_mensagem_pck.exibir_mensagem_abort(231370, 'NR_TITULO=' || nr_documento_p);
							/* 'Titulo ja vinculado a uma remessa de pagamento escritural.' || chr(13) || 'O mesmo so pode ser baixado pela funcao "Pagamento escritural",' || chr(13) || 'Titulo: ' || ); */

					end if;
			end if;

			CALL Atualizar_Saldo_Tit_Pagar(nr_documento_p, nm_usuario_p);

		/*Bordero a Pagar*/
	
		elsif (ie_tipo_documento_p = '3') then
	
			if (coalesce(cd_tipo_baixa_cpa_p,0) = 0) then
				-- O tipo de baixa nao foi informado na transacao!
				CALL wheb_mensagem_pck.exibir_mensagem_abort(988279);
			end if;
	
		end if;
	
else
	if (ie_acao_w = 2) then
		if (ie_bordero_banco_w <> 'R' or coalesce(cd_tipo_baixa_cpa_p::text, '') = '') then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1083982,'DS_TRANSACAO_W='||DS_TRANSACAO_W);
			--'A transacao "' || ds_transacao_w ||'" nao tem tipo de baixa ou o numero do titulo nao foi informado!');
		end if;
	end if;
end if;

--Essa procedure nao tem commit pois e apenas para consistencias.

--commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_movto_trans_financ ( nr_documento_p bigint, ie_tipo_documento_p bigint, dt_transacao_p timestamp, nm_usuario_p text, cd_tipo_baixa_cpa_p bigint, nr_seq_trans_financ_p bigint default null) FROM PUBLIC;

