-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE create_acc_batch_revenue ( cd_estabelecimento_p bigint, qt_days_p bigint, nm_usuario_p text) AS $body$
DECLARE


					
C01 CURSOR FOR
	SELECT	a.nr_seq_protocolo
	from	protocolo_convenio a
	where	a.IE_STATUS_PROTOCOLO = 2
	and	a.DT_DEFINITIVO	between trunc(clock_timestamp()-qt_days_p) and clock_timestamp()
	and	not exists (	SELECT	1
					from	conta_paciente x
					where	x.nr_seq_protocolo = a.nr_seq_protocolo
					and	coalesce(x.nr_lote_contabil,0)	> 0);
		
	
ds_valor_parametro_w	varchar(8000);
nr_lote_contabil_w	bigint;
					
parametro_w	techone_pck.batchparameters_tp;
					
BEGIN



for r_c01 in c01 loop
	begin

	if (coalesce(ds_valor_parametro_w::text, '') = '') then
		ds_valor_parametro_w	:= r_c01.nr_seq_protocolo;
	else
		ds_valor_parametro_w	:= ds_valor_parametro_w ||','||r_c01.nr_seq_protocolo;
	end if;
	
	end;
end loop;


if (ds_valor_parametro_w IS NOT NULL AND ds_valor_parametro_w::text <> '') then
	
	CALL wheb_usuario_pck.set_nm_usuario(nm_usuario_p);
	CALL wheb_usuario_pck.set_cd_estabelecimento(cd_estabelecimento_p);
	CALL philips_param_pck.set_nr_seq_idioma(9);
	nr_lote_contabil_w	:= techone_pck.create_batch(	cd_estabelecimento_p,
								6,
								clock_timestamp(),
								nm_usuario_p);
								
	if (nr_lote_contabil_w IS NOT NULL AND nr_lote_contabil_w::text <> '') then
		
		parametro_w.DS_VALOR_PARAMETRO	:= ds_valor_parametro_w;
		
		CALL techone_pck.update_parameters(	nr_lote_contabil_w,
						9,
						parametro_w);
						
		CALL techone_pck.Generate_batch(	nr_lote_contabil_w,
						nm_usuario_p,
						'N');		

		CALL techone_pck.send_integration(	nr_lote_contabil_w,
						nm_usuario_p);
		
	end if;
	
end if;



commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE create_acc_batch_revenue ( cd_estabelecimento_p bigint, qt_days_p bigint, nm_usuario_p text) FROM PUBLIC;

