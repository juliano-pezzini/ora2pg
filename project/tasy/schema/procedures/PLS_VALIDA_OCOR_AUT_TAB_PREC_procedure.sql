-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_valida_ocor_aut_tab_prec ( nr_seq_ocor_combinada_p pls_ocor_aut_combinada.nr_sequencia%type, nr_seq_ocorrencia_p pls_ocorrencia.nr_sequencia%type, nr_seq_motivo_glosa_p tiss_motivo_glosa.nr_sequencia%type, nr_seq_guia_p pls_guia_plano.nr_sequencia%type, nr_seq_requisicao_p pls_requisicao.nr_sequencia%type, nr_seq_execucao_p pls_execucao_requisicao.nr_sequencia%type, ie_utiliza_filtro_p pls_ocor_aut_combinada.ie_utiliza_filtro%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type ) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
Validar a ocorrência combinada 'Valida tabela de preço no processo de intercâmbio online',
onde é validado a tabela de preço dos itens no processo de intercâmbio online,.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[x]  Objetos do dicionário [] Tasy (Delphi/Java) [] Portal []  Relatórios [] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ie_gerar_ocorrencia_w		varchar(2);
ie_gerar_ocorrencia_preco_w	varchar(2);
nr_seq_requisicao_w		pls_requisicao.nr_sequencia%type;
nr_seq_prestador_w		pls_prestador.nr_sequencia%type;
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
ie_tipo_ocorrencia_w		varchar(2);
ie_regra_w			varchar(2);
nr_seq_oc_benef_w		pls_ocorrencia_benef.nr_sequencia%type;
ie_gerou_ocor_cabecalho_w	varchar(2);
cd_especialidade_w		especialidade_medica.cd_especialidade%type;
nr_seq_preco_item_w		pls_material_preco_item.nr_sequencia%type;
nr_seq_preco_valor_item_w	pls_material_valor_item.nr_sequencia%type;
vl_material_w			double precision;
nr_seq_pedido_compl_w		ptu_pedido_compl_aut.nr_sequencia%type;
nr_seq_pedido_aut_w		ptu_pedido_autorizacao.nr_sequencia%type;
vl_servico_w			ptu_pedido_aut_servico.vl_servico%type;
vl_uni_servico_w		ptu_pedido_aut_servico.vl_uni_servico%type;
qt_servico_w			ptu_pedido_aut_servico.qt_servico%type;
ie_tipo_processo_w		pls_requisicao.ie_tipo_processo%type;
ie_tipo_intercambio_w		pls_requisicao.ie_tipo_intercambio%type;

C01 CURSOR FOR
	SELECT	nr_sequencia,
		coalesce(ie_tipo_validacao, 'A') ie_tipo_validacao,
		nr_seq_material_preco
	from	pls_validacao_aut_tab_prec
	where	nr_seq_ocor_aut_combinada	= nr_seq_ocor_combinada_p
	and	ie_situacao			= 'A';

C04 CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_material
	from	pls_guia_plano_mat
	where	nr_seq_guia	= nr_seq_guia_p;

C05 CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_material
	from	pls_requisicao_mat
	where	nr_seq_requisicao	= nr_seq_requisicao_p;
BEGIN

if (nr_seq_requisicao_p IS NOT NULL AND nr_seq_requisicao_p::text <> '') then
	begin
		select	nr_seq_prestador,
			nr_seq_segurado,
			coalesce(cd_especialidade,0),
			ie_tipo_processo,
			ie_tipo_intercambio
		into STRICT	nr_seq_prestador_w,
			nr_seq_segurado_w,
			cd_especialidade_w,
			ie_tipo_processo_w,
			ie_tipo_intercambio_w
		from	pls_requisicao
		where 	nr_sequencia	= nr_seq_requisicao_p;
	exception
	when others then
		nr_seq_prestador_w	:= null;
	end;

	if (ie_tipo_processo_w	= 'I') and (ie_tipo_intercambio_w	= 'E') then
		for r_C01_w in C01 loop
			begin
			for r_C05_w in C05 loop
				begin
					select	max(nr_sequencia)
					into STRICT	nr_seq_pedido_compl_w
					from	ptu_pedido_compl_aut
					where	nr_seq_requisicao = nr_seq_requisicao_p;

					if (coalesce(nr_seq_pedido_compl_w::text, '') = '') then
						select	max(nr_sequencia)
						into STRICT	nr_seq_pedido_aut_w
						from	ptu_pedido_autorizacao
						where	nr_seq_requisicao = nr_seq_requisicao_p;
					end if;

					if (nr_seq_pedido_compl_w IS NOT NULL AND nr_seq_pedido_compl_w::text <> '') then
						select	vl_servico,
							vl_uni_servico,
							qt_servico
						into STRICT	vl_servico_w,
							vl_uni_servico_w,
							qt_servico_w
						from	ptu_pedido_compl_aut_serv
						where	nr_seq_pedido = nr_seq_pedido_compl_w
						and	nr_seq_req_mat = r_C05_w.nr_sequencia;
					elsif (nr_seq_pedido_aut_w IS NOT NULL AND nr_seq_pedido_aut_w::text <> '') then
						select	vl_servico,
							vl_uni_servico,
							qt_servico
						into STRICT	vl_servico_w,
							vl_uni_servico_w,
							qt_servico_w
						from	ptu_pedido_aut_servico
						where	nr_seq_pedido = nr_seq_pedido_aut_w
						and	nr_seq_req_mat = r_C05_w.nr_sequencia;
					end if;

					select	max(nr_sequencia)
					into STRICT	nr_seq_preco_item_w
					from	pls_material_preco_item
					where	nr_seq_material	= r_C05_w.nr_seq_material
					and	nr_seq_material_preco = r_C01_w.nr_seq_material_preco
					and	ie_situacao = 'A';

					select	max(nr_sequencia)
					into STRICT	nr_seq_preco_valor_item_w
					from	pls_material_valor_item
					where	nr_seq_preco_item = nr_seq_preco_item_w
					and	dt_inicio_vigencia = (SELECT	max(dt_inicio_vigencia)
									from	pls_material_valor_item
									where	nr_seq_preco_item = nr_seq_preco_item_w
									and	dt_inicio_vigencia <= clock_timestamp());

					select	max(vl_material)
					into STRICT	vl_material_w
					from	pls_material_valor_item
					where	nr_sequencia = nr_seq_preco_valor_item_w;

					if (vl_material_w IS NOT NULL AND vl_material_w::text <> '') then
						--(U,T,A)(Validar valor unitário,Validar valor total,Ambos)
						if (r_C01_w.ie_tipo_validacao = 'U') and (vl_uni_servico_w <> vl_material_w) then
							ie_gerar_ocorrencia_preco_w := 'S';
						elsif (r_C01_w.ie_tipo_validacao = 'T') and
							((vl_servico_w) <> (vl_material_w * qt_servico_w)) then
							ie_gerar_ocorrencia_preco_w := 'S';
						elsif (r_C01_w.ie_tipo_validacao = 'A') and
							((vl_uni_servico_w <> vl_material_w) or
							((vl_servico_w) <> (vl_material_w * qt_servico_w))) then
							ie_gerar_ocorrencia_preco_w := 'S';
						else
							ie_gerar_ocorrencia_preco_w := 'N';
						end if;

						ie_gerar_ocorrencia_w	:= 'S';

						if (ie_utiliza_filtro_p	= 'S') then
							/* Tratamento para filtros */

							SELECT * FROM pls_gerar_ocor_aut_filtro(	nr_seq_ocor_combinada_p, null, nr_seq_requisicao_p, null, null, null, null, r_C05_w.nr_sequencia, null, null, null, r_C05_w.nr_seq_material, null, nr_seq_prestador_w, nr_seq_ocorrencia_p, null, null, null, nm_usuario_p, ie_regra_w, ie_tipo_ocorrencia_w) INTO STRICT ie_regra_w, ie_tipo_ocorrencia_w;

							if (ie_regra_w	= 'S') then
								ie_gerar_ocorrencia_w	:= 'S';
							elsif (ie_regra_w	in ('E','N')) then
								ie_gerar_ocorrencia_w	:= 'N';
							end if;
						end if;

						if (ie_gerar_ocorrencia_w	= 'S') then
							ie_gerar_ocorrencia_w	:= ie_gerar_ocorrencia_preco_w;

							if (ie_gerar_ocorrencia_w	= 'S') then
								nr_seq_oc_benef_w := pls_inserir_ocorrencia(	nr_seq_segurado_w, nr_seq_ocorrencia_p, nr_seq_requisicao_p, null, null, null, r_C05_w.nr_sequencia, nr_seq_ocor_combinada_p, nm_usuario_p, null, nr_seq_motivo_glosa_p, 6, cd_estabelecimento_p, 'N', null, nr_seq_oc_benef_w, null, null, null, null);

								CALL pls_atualizar_status_ocor_comb(	nr_seq_ocorrencia_p, nr_seq_ocor_combinada_p, nr_seq_motivo_glosa_p,
												null, nr_seq_requisicao_p, null,
												null, r_C05_w.nr_sequencia, null,
												null, null, null,
												nm_usuario_p, cd_estabelecimento_p);
							end if;
						end if;
					end if;
				end;
			end loop;
			end;
		end loop;
	end if;
elsif (nr_seq_guia_p IS NOT NULL AND nr_seq_guia_p::text <> '') then
	begin
		select	nr_seq_prestador,
			nr_seq_segurado,
			coalesce(cd_especialidade,0),
			ie_tipo_processo,
			ie_tipo_intercambio
		into STRICT	nr_seq_prestador_w,
			nr_seq_segurado_w,
			cd_especialidade_w,
			ie_tipo_processo_w,
			ie_tipo_intercambio_w
		from	pls_guia_plano
		where 	nr_sequencia	= nr_seq_guia_p;
	exception
	when others then
		nr_seq_prestador_w	:= null;
	end;

	if (ie_tipo_processo_w	= 'I') and (ie_tipo_intercambio_w	= 'E') then
		for r_C01_w in C01 loop
			begin
			for r_C04_w in C04 loop
				begin
					select	max(nr_sequencia)
					into STRICT	nr_seq_pedido_compl_w
					from	ptu_pedido_compl_aut
					where	nr_seq_guia = nr_seq_guia_p;

					if (coalesce(nr_seq_pedido_compl_w::text, '') = '') then
						select	max(nr_sequencia)
						into STRICT	nr_seq_pedido_aut_w
						from	ptu_pedido_autorizacao
						where	nr_seq_guia = nr_seq_guia_p;
					end if;

					if (nr_seq_pedido_compl_w IS NOT NULL AND nr_seq_pedido_compl_w::text <> '') then
						select	vl_servico,
							vl_uni_servico,
							qt_servico
						into STRICT	vl_servico_w,
							vl_uni_servico_w,
							qt_servico_w
						from	ptu_pedido_compl_aut_serv
						where	nr_seq_pedido = nr_seq_pedido_compl_w
						and	nr_seq_guia_mat = r_c04_w.nr_sequencia;
					elsif (nr_seq_pedido_aut_w IS NOT NULL AND nr_seq_pedido_aut_w::text <> '') then
						select	vl_servico,
							vl_uni_servico,
							qt_servico
						into STRICT	vl_servico_w,
							vl_uni_servico_w,
							qt_servico_w
						from	ptu_pedido_aut_servico
						where	nr_seq_pedido = nr_seq_pedido_aut_w
						and	nr_seq_guia_mat = r_c04_w.nr_sequencia;
					end if;

					select	max(nr_sequencia)
					into STRICT	nr_seq_preco_item_w
					from	pls_material_preco_item
					where	nr_seq_material	= r_C04_w.nr_seq_material
					and	nr_seq_material_preco = r_C01_w.nr_seq_material_preco
					and	ie_situacao = 'A';

					select	max(nr_sequencia)
					into STRICT	nr_seq_preco_valor_item_w
					from	pls_material_valor_item
					where	nr_seq_preco_item = nr_seq_preco_item_w
					and	dt_inicio_vigencia = (SELECT	max(dt_inicio_vigencia)
									from	pls_material_valor_item
									where	nr_seq_preco_item = nr_seq_preco_item_w
									and	dt_inicio_vigencia <= clock_timestamp());

					select	max(vl_material)
					into STRICT	vl_material_w
					from	pls_material_valor_item
					where	nr_sequencia = nr_seq_preco_valor_item_w;

					if (vl_material_w IS NOT NULL AND vl_material_w::text <> '') then
						--(U,T,A)(Validar valor unitário,Validar valor total,Ambos)
						if (r_C01_w.ie_tipo_validacao = 'U') and (vl_uni_servico_w <> vl_material_w) then
							ie_gerar_ocorrencia_preco_w := 'S';
						elsif (r_C01_w.ie_tipo_validacao = 'T') and
							((vl_servico_w) <> (vl_material_w * qt_servico_w)) then
							ie_gerar_ocorrencia_preco_w := 'S';
						elsif (r_C01_w.ie_tipo_validacao = 'A') and
							((vl_uni_servico_w <> vl_material_w) or
							((vl_servico_w) <> (vl_material_w * qt_servico_w))) then
							ie_gerar_ocorrencia_preco_w := 'S';
						else
							ie_gerar_ocorrencia_preco_w := 'N';
						end if;

						ie_gerar_ocorrencia_w	:= 'S';

						if (ie_utiliza_filtro_p	= 'S') then
							/* Tratamento para filtros */

							SELECT * FROM pls_gerar_ocor_aut_filtro(	nr_seq_ocor_combinada_p, nr_seq_guia_p, nr_seq_requisicao_p, nr_seq_execucao_p, null, r_C04_w.nr_sequencia, null, null, null, null, null, r_C04_w.nr_seq_material, ie_gerou_ocor_cabecalho_w, nr_seq_prestador_w, nr_seq_ocorrencia_p, null, null, null, nm_usuario_p, ie_regra_w, ie_tipo_ocorrencia_w) INTO STRICT ie_regra_w, ie_tipo_ocorrencia_w;

							if (ie_regra_w	= 'S') then
								ie_gerar_ocorrencia_w	:= 'S';
							elsif (ie_regra_w	in ('E','N')) then
								ie_gerar_ocorrencia_w	:= 'N';
							end if;
						end if;

						if (ie_gerar_ocorrencia_w	= 'S') then
							ie_gerar_ocorrencia_w	:= ie_gerar_ocorrencia_preco_w;

							if (ie_gerar_ocorrencia_w	= 'S') then
								nr_seq_oc_benef_w := pls_inserir_ocorrencia(	nr_seq_segurado_w, nr_seq_ocorrencia_p, null, nr_seq_guia_p, null, null, r_C04_w.nr_sequencia, nr_seq_ocor_combinada_p, nm_usuario_p, null, nr_seq_motivo_glosa_p, 2, cd_estabelecimento_p, 'N', null, nr_seq_oc_benef_w, null, null, null, null);

								CALL pls_atualizar_status_ocor_comb(	nr_seq_ocorrencia_p, nr_seq_ocor_combinada_p, nr_seq_motivo_glosa_p,
												nr_seq_guia_p, null, null,
												null, r_C04_w.nr_sequencia, null,
												null, null, null,
												nm_usuario_p, cd_estabelecimento_p);
							end if;
						end if;
					end if;
				end;
			end loop;
			end;
		end loop;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_valida_ocor_aut_tab_prec ( nr_seq_ocor_combinada_p pls_ocor_aut_combinada.nr_sequencia%type, nr_seq_ocorrencia_p pls_ocorrencia.nr_sequencia%type, nr_seq_motivo_glosa_p tiss_motivo_glosa.nr_sequencia%type, nr_seq_guia_p pls_guia_plano.nr_sequencia%type, nr_seq_requisicao_p pls_requisicao.nr_sequencia%type, nr_seq_execucao_p pls_execucao_requisicao.nr_sequencia%type, ie_utiliza_filtro_p pls_ocor_aut_combinada.ie_utiliza_filtro%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type ) FROM PUBLIC;

