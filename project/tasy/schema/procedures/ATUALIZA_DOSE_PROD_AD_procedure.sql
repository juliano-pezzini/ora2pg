-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_dose_prod_ad ( nr_prescricao_p bigint, nr_seq_material_p bigint) AS $body$
DECLARE

 
--ParÃ¢metros da REP 
vl_param_530_w				varchar(5);
					
qt_dose_w					prescr_material.qt_dose%type;
qt_dose_aux_w				prescr_material.qt_dose%type;
qt_porcentagem_w			prescr_material.qt_porcentagem%type;
qt_unitaria_w				prescr_material.qt_unitaria%type;
qt_material_w				prescr_material.qt_material%type;
qt_total_dispensar_w		prescr_material.qt_total_dispensar%type;
qt_conversao_dose_w			prescr_material.qt_conversao_dose%type;
nr_seq_mat_adic_w			prescr_material.nr_sequencia%type;
nr_ocorrencia_w				prescr_material.nr_ocorrencia%type;
cd_material_w				prescr_material.cd_material%type;
cd_unidade_medida_dose_w	prescr_material.cd_unidade_medida_dose%type;
ie_via_aplicacao_w			prescr_material.ie_via_aplicacao%type;
ie_regra_disp_w				prescr_material.ie_regra_disp%type;
ie_se_necessario_w			prescr_material.ie_se_necessario%type;
ie_acm_w					prescr_material.ie_acm%type;
ie_origem_inf_w				prescr_material.ie_origem_inf%type;
ds_horarios_w				prescr_material.ds_horarios%type;

cd_intervalo_w				intervalo_prescricao.cd_intervalo%type;

nm_usuario_w				usuario.nm_usuario%type;

cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;

cd_perfil_w					perfil.cd_perfil%type;

ds_erro_w					varchar(4000);

c01 CURSOR FOR 
	SELECT	nr_sequencia, 
			qt_porcentagem, 
			coalesce(cd_unidade_medida_dose,cd_unidade_medida), 
			cd_material, 
			cd_intervalo, 
			ie_via_aplicacao, 
			ie_se_necessario, 
			ie_acm, 
			ie_origem_inf 
	from	prescr_material 
	where	nr_prescricao = nr_prescricao_p 
	and		nr_sequencia_diluicao = nr_seq_material_p 
	and		ie_agrupador = 17;	

BEGIN 
 
cd_perfil_w		:= coalesce(obter_perfil_ativo,0);
 
select	coalesce(max(cd_estabelecimento),1) 
into STRICT	cd_estabelecimento_w 
from	prescr_medica 
where	nr_prescricao = nr_prescricao_p;
 
vl_param_530_w := Obter_Param_Usuario(924, 530, cd_perfil_w, nm_usuario_w, cd_estabelecimento_w, vl_param_530_w);
 
select	coalesce(max(qt_dose),0), 
		max(nr_ocorrencia), 
		max(ds_horarios), 
		max(nm_usuario) 
into STRICT	qt_dose_w, 
		nr_ocorrencia_w, 
		ds_horarios_w, 
		nm_usuario_w 
from	prescr_material 
where	nr_prescricao = nr_prescricao_p 
and		nr_sequencia = nr_seq_material_p 
and		ie_agrupador = 16;
 
open c01;
loop 
fetch c01 into	 
	nr_seq_mat_adic_w, 
	qt_porcentagem_w, 
	cd_unidade_medida_dose_w, 
	cd_material_w, 
	cd_intervalo_w, 
	ie_via_aplicacao_w, 
	ie_se_necessario_w, 
	ie_acm_w, 
	ie_origem_inf_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	qt_dose_aux_w	:= qt_dose_w;
 
	if (qt_dose_aux_w > 0) then 
		qt_dose_aux_w	:= (qt_porcentagem_w * qt_dose_w) / 100;
	end if;
	 
	qt_conversao_dose_w		:= coalesce(obter_conversao_unid_med(cd_material_w, cd_unidade_medida_dose_w),0);
	 
	if (qt_conversao_dose_w > 0) then 
		qt_unitaria_w		:= dividir(qt_dose_aux_w, qt_conversao_dose_w);
	else 
		qt_conversao_dose_w	:= 0;
		qt_unitaria_w		:= 0;
	end if;
	 
	SELECT * FROM obter_quant_dispensar(	cd_estabelecimento_w, cd_material_w, nr_prescricao_p, nr_seq_mat_adic_w, cd_intervalo_w, ie_via_aplicacao_w, qt_unitaria_w, 0, nr_ocorrencia_w, '', ie_origem_inf_w, cd_unidade_medida_dose_w, 0, qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w;
	 
	update	prescr_material 
	set		qt_dose = qt_dose_aux_w, 
			qt_unitaria = coalesce(qt_unitaria_w,0), 
			qt_material = coalesce(qt_material_w,0), 
			qt_total_dispensar = coalesce(qt_total_dispensar_w,0), 
			nr_ocorrencia = coalesce(nr_ocorrencia_w,nr_ocorrencia), 
			ds_horarios = ds_horarios_w 
	where	nr_prescricao = nr_prescricao_p 
	and		nr_sequencia = nr_seq_mat_adic_w 
	and		ie_agrupador = 17;
	 
	if (vl_param_530_w = 'S') THEN		 
		CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p, nr_seq_mat_adic_w, cd_perfil_w, 'N', nm_usuario_w, null);
	end if;		
	commit;
	end;
end loop;
close c01;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_dose_prod_ad ( nr_prescricao_p bigint, nr_seq_material_p bigint) FROM PUBLIC;

