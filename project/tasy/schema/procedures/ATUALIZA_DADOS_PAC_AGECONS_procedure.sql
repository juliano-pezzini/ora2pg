-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_dados_pac_agecons ( cd_pessoa_fisica_p text, nm_usuario_p text) AS $body$
DECLARE

 
nm_pessoa_fisica_w	varchar(60);
nr_telefone_celular_w	varchar(40);
nr_tel_complementar_w	varchar(40);
nr_tel_complementar_ww	varchar(255);
				
 
C01 CURSOR FOR 
	SELECT	distinct 
		SUBSTR(OBTER_NOME_PF(a.cd_pessoa_fisica), 0, 60) as nm_pessoa_fisica, 
		a.nr_telefone_celular, 
		Obter_Telefone_PF(cd_pessoa_fisica_p,4), 
		Obter_Telefone_PF(cd_pessoa_fisica_p,11) 
	FROM 	pessoa_fisica a		 
	WHERE	a.cd_pessoa_fisica	= cd_pessoa_fisica_p;
	

BEGIN	 
 
OPEN C01;
LOOP 
FETCH C01 INTO 
   nm_pessoa_fisica_w, 
   nr_telefone_celular_w, 
   nr_tel_complementar_w, 
   nr_tel_complementar_ww;	
EXIT WHEN NOT FOUND; /* apply on C01 */ 				
 
	IF (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') THEN 
		BEGIN		 
		UPDATE 	agenda_consulta a 
		SET	a.nm_paciente		= nm_pessoa_fisica_w, 
			a.nr_telefone		= nr_telefone_celular_w||' '||nr_tel_complementar_w||' '||nr_tel_complementar_ww, 
			a.nm_usuario		= nm_usuario_p, 
			a.dt_atualizacao	= clock_timestamp() 
		WHERE	a.cd_pessoa_fisica	= cd_pessoa_fisica_p;
		END;
	END IF;
END LOOP;
CLOSE C01;
 
commit;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_dados_pac_agecons ( cd_pessoa_fisica_p text, nm_usuario_p text) FROM PUBLIC;

