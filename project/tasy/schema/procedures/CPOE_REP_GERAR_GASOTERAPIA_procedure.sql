-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_rep_gerar_gasoterapia ( nr_prescricao_p prescr_medica.nr_prescricao%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, dt_inicio_prescr_p timestamp, dt_validade_prescr_p timestamp, dt_liberacao_p timestamp, nm_usuario_p usuario.nm_usuario%type, cd_funcao_origem_p funcao.cd_funcao%type, cd_setor_atendimento_p prescr_medica.cd_setor_atendimento%type default null) AS $body$
DECLARE


cd_intervalo_w					prescr_gasoterapia.cd_intervalo%type;
cd_modalidade_vent_w			prescr_gasoterapia.cd_modalidade_vent%type;
ds_horarios_w					prescr_gasoterapia.ds_horarios%type;
ds_observacao_w					prescr_gasoterapia.ds_observacao%type;
dt_prev_execucao_w				prescr_gasoterapia.dt_prev_execucao%type;
ie_disp_resp_esp_w				prescr_gasoterapia.ie_disp_resp_esp%type;
ie_inicio_w						prescr_gasoterapia.ie_inicio%type;
ie_modo_adm_w					prescr_gasoterapia.ie_modo_adm%type;
ie_respiracao_w					prescr_gasoterapia.ie_respiracao%type;
ie_tipo_onda_w					prescr_gasoterapia.ie_tipo_onda%type;
ie_unidade_medida_w				prescr_gasoterapia.ie_unidade_medida%type;
nr_seq_gas_w					prescr_gasoterapia.nr_seq_gas%type;
nr_seq_gasoterapia_w			prescr_gasoterapia.nr_sequencia%type;
qt_acima_peep_w					prescr_gasoterapia.qt_acima_peep%type;
qt_be_w							prescr_gasoterapia.qt_be%type;
qt_bic_w						prescr_gasoterapia.qt_bic%type;
qt_fluxo_insp_w					prescr_gasoterapia.qt_fluxo_insp%type;
qt_freq_vent_w					prescr_gasoterapia.qt_freq_vent%type;
qt_gasoterapia_w				prescr_gasoterapia.qt_gasoterapia%type;
qt_min_intervalo_w				prescr_gasoterapia.qt_min_intervalo%type;
qt_pco2_w						prescr_gasoterapia.qt_pco2%type;
qt_peep_w						prescr_gasoterapia.qt_peep%type;
qt_ph_w							prescr_gasoterapia.qt_ph%type;
qt_pip_w						prescr_gasoterapia.qt_pip%type;
qt_ps_w							prescr_gasoterapia.qt_ps%type;
qt_referencia_w					prescr_gasoterapia.qt_referencia%type;
qt_sato2_w						prescr_gasoterapia.qt_sato2%type;
qt_sensib_resp_w				prescr_gasoterapia.qt_sensib_resp%type;
qt_tempo_insp_w					prescr_gasoterapia.qt_tempo_insp%type;
qt_ti_te_w						prescr_gasoterapia.qt_ti_te%type;
cd_perfil_ativo_w				prescr_gasoterapia.cd_perfil_ativo%type;

nr_sequencia_w					cpoe_gasoterapia.nr_sequencia%type;
ie_urgencia_w					cpoe_gasoterapia.ie_urgencia%type;
ie_se_necessario_w				cpoe_gasoterapia.ie_se_necessario%type;
ie_acm_w						cpoe_gasoterapia.ie_acm%type;
ie_administracao_w				cpoe_gasoterapia.ie_administracao%type;
nr_ocorrencia_w					cpoe_gasoterapia.nr_ocorrencia%type;

ie_retrogrado_w					prescr_medica.ie_prescr_emergencia%type;
cd_pessoa_fisica_w				prescr_medica.cd_pessoa_fisica%type;
dt_liberacao_enf_w				timestamp;
nm_usuario_lib_enf_w	prescr_medica.nm_usuario_lib_enf%type;
cd_medico_w						prescr_medica.cd_medico%type;

c01 CURSOR FOR
SELECT	cd_intervalo,
		cd_modalidade_vent,
		ds_horarios,
		ds_observacao,
		dt_prev_execucao,
		ie_disp_resp_esp,
		ie_inicio,
		ie_modo_adm,
		ie_respiracao,
		ie_tipo_onda,
		ie_unidade_medida,
		nr_seq_gas,
		nr_sequencia,
		qt_acima_peep,
		qt_be,
		qt_bic,
		qt_fluxo_insp,
		qt_freq_vent,
		qt_gasoterapia,
		qt_min_intervalo,
		qt_pco2,
		qt_peep,
		qt_ph,
		qt_pip,
		qt_ps,
		qt_referencia,
		qt_sato2,
		qt_sensib_resp,
		qt_tempo_insp,
		qt_ti_te,
		cd_perfil_ativo
from	prescr_gasoterapia
where	nr_prescricao = nr_prescricao_p;


BEGIN

select 	max(coalesce(ie_prescr_emergencia,'N')),
		max(cd_pessoa_fisica),
		max(dt_liberacao),
		max(nm_usuario_lib_enf),
		max(cd_medico)
into STRICT	ie_retrogrado_w,
		cd_pessoa_fisica_w,
		dt_liberacao_enf_w,
		nm_usuario_lib_enf_w,
		cd_medico_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;	

open c01;
loop
fetch c01 into	cd_intervalo_w,
				cd_modalidade_vent_w,
				ds_horarios_w,
				ds_observacao_w,
				dt_prev_execucao_w,
				ie_disp_resp_esp_w,
				ie_inicio_w,
				ie_modo_adm_w,
				ie_respiracao_w,
				ie_tipo_onda_w,
				ie_unidade_medida_w,
				nr_seq_gas_w,
				nr_seq_gasoterapia_w,
				qt_acima_peep_w,
				qt_be_w,
				qt_bic_w,
				qt_fluxo_insp_w,
				qt_freq_vent_w,
				qt_gasoterapia_w,
				qt_min_intervalo_w,
				qt_pco2_w,
				qt_peep_w,
				qt_ph_w,
				qt_pip_w,
				qt_ps_w,
				qt_referencia_w,
				qt_sato2_w,
				qt_sensib_resp_w,
				qt_tempo_insp_w,
				qt_ti_te_w,
				cd_perfil_ativo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	ie_administracao_w	:= 'P';
	ie_urgencia_w		:= '';
	ie_acm_w			:= 'N';
	ie_se_necessario_w	:= 'N';
	nr_ocorrencia_w		:= null;

	SELECT * FROM CPOE_Calcula_horarios_etapas(	nm_usuario_p, dt_prev_execucao_w, 'S', nr_ocorrencia_w, cd_intervalo_w, 24, 0, 0, 'N') INTO STRICT nr_ocorrencia_w, ds_horarios_w;
	
	if (ie_inicio_w = 'A') then
		ie_urgencia_w		:= '0';
	elsif (ie_inicio_w = 'ACM') then
		ie_acm_w			:= 'S';
		ds_horarios_w		:= '';
		ie_administracao_w	:= 'C';
	elsif (ie_inicio_w = 'D') then
		ie_se_necessario_w	:= 'S';
		ds_horarios_w		:= '';
		ie_administracao_w	:= 'N';
	end if;

	select	nextval('cpoe_gasoterapia_seq')
	into STRICT	nr_sequencia_w
	;
	
	insert into cpoe_gasoterapia(
				nr_sequencia,
				nr_atendimento,
				ie_administracao,
				ie_duracao,
				ie_urgencia,
				ie_se_necessario,
				ie_acm,
				dt_inicio,
				dt_fim,
				dt_prox_geracao,
				dt_liberacao,
				hr_prim_horario,
				cd_intervalo,
				cd_modalidade_vent,
				ds_horarios,
				ds_observacao,
				dt_prev_execucao,
				ie_disp_resp_esp,
				ie_inicio,
				ie_modo_adm,
				ie_respiracao,
				ie_tipo_onda,
				ie_unidade_medida,
				nr_seq_gas,
				qt_acima_peep,
				qt_be,
				qt_bic,
				qt_fluxo_insp,
				qt_freq_vent,
				qt_gasoterapia,
				qt_min_intervalo,
				qt_pco2,
				qt_peep,
				qt_ph,
				qt_pip,
				qt_ps,
				qt_referencia,
				qt_sato2,
				qt_sensib_resp,
				qt_tempo_insp,
				qt_ti_te,
				nm_usuario,
				nm_usuario_nrec,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nr_ocorrencia,
				cd_perfil_ativo,
				cd_funcao_origem,
				cd_setor_atendimento,
				ie_retrogrado,
				cd_pessoa_fisica,
				dt_liberacao_enf,
				nm_usuario_lib_enf,
				cd_medico)
			values (
				nr_sequencia_w,
				nr_atendimento_p,
				ie_administracao_w,
				'P',
				ie_urgencia_w,
				ie_se_necessario_w,
				ie_acm_w,
				dt_prev_execucao_w,
				dt_validade_prescr_p,
				dt_prev_execucao_w + 12/24,
				dt_liberacao_p,
				to_char(dt_prev_execucao_w,'hh24:mi'),
				cd_intervalo_w,
				cd_modalidade_vent_w,
				ds_horarios_w,
				ds_observacao_w,
				dt_prev_execucao_w,
				ie_disp_resp_esp_w,
				ie_inicio_w,
				ie_modo_adm_w,
				ie_respiracao_w,
				ie_tipo_onda_w,
				ie_unidade_medida_w,
				nr_seq_gas_w,
				qt_acima_peep_w,
				qt_be_w,
				qt_bic_w,
				qt_fluxo_insp_w,
				qt_freq_vent_w,
				qt_gasoterapia_w,
				qt_min_intervalo_w,
				qt_pco2_w,
				qt_peep_w,
				qt_ph_w,
				qt_pip_w,
				qt_ps_w,
				qt_referencia_w,
				qt_sato2_w,
				qt_sensib_resp_w,
				qt_tempo_insp_w,
				qt_ti_te_w,
				nm_usuario_p,
				nm_usuario_p,
				clock_timestamp(),
				clock_timestamp(),
				nr_ocorrencia_w,
				cd_perfil_ativo_w,
				cd_funcao_origem_p,
				cd_setor_atendimento_p,
				ie_retrogrado_w,
				cd_pessoa_fisica_w,
				dt_liberacao_enf_w,
				nm_usuario_lib_enf_w,
				cd_medico_w);
				
	CALL CPOE_REP_Gerar_mat_assoc_gas( nr_prescricao_p, nr_atendimento_p, nr_seq_gasoterapia_w, nr_sequencia_w);
				
	update	prescr_gasoterapia
	set		nr_seq_gas_cpoe = nr_sequencia_w
	where	nr_sequencia = nr_seq_gasoterapia_w
	and		nr_prescricao = nr_prescricao_p;
	
	end;
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_rep_gerar_gasoterapia ( nr_prescricao_p prescr_medica.nr_prescricao%type, nr_atendimento_p atendimento_paciente.nr_atendimento%type, dt_inicio_prescr_p timestamp, dt_validade_prescr_p timestamp, dt_liberacao_p timestamp, nm_usuario_p usuario.nm_usuario%type, cd_funcao_origem_p funcao.cd_funcao%type, cd_setor_atendimento_p prescr_medica.cd_setor_atendimento%type default null) FROM PUBLIC;

