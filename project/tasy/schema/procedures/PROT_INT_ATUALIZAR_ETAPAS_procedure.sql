-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE prot_int_atualizar_etapas ( nr_seq_protocolo_int_pac_p protocolo_int_paciente.nr_sequencia%TYPE ) AS $body$
DECLARE


dt_inicial_previsto_w protocolo_int_paciente.dt_inicial_previsto%TYPE;
dt_final_previsto_w protocolo_int_paciente.dt_final_previsto%TYPE;

C01 CURSOR FOR
SELECT
    nr_sequencia,
    nr_dias_previsto,
    coalesce(ie_evento_sumario,'N') as ie_evento_sumario
FROM protocolo_int_pac_etapa
WHERE nr_seq_protocolo_int_pac = nr_seq_protocolo_int_pac_p
ORDER BY nr_sequencia;

BEGIN

IF (nr_seq_protocolo_int_pac_p IS NOT NULL AND nr_seq_protocolo_int_pac_p::text <> '') THEN

    SELECT dt_inicial_previsto
    INTO STRICT dt_inicial_previsto_w
    FROM protocolo_int_paciente
    WHERE nr_sequencia = nr_seq_protocolo_int_pac_p;

    FOR etapa IN C01 LOOP BEGIN

        if (coalesce(pkg_i18n.get_user_locale, 'pt_BR') <> 'ja_JP') then

          dt_final_previsto_w := dt_inicial_previsto_w + etapa.nr_dias_previsto - 1;

          UPDATE protocolo_int_pac_etapa
          SET dt_inicial_previsto = dt_inicial_previsto_w,
              dt_final_previsto = dt_final_previsto_w
          WHERE
              nr_sequencia = etapa.nr_sequencia;

          dt_inicial_previsto_w := dt_final_previsto_w + 1;

          COMMIT;

          CALL calc_dt_real_etapa_prot_int(etapa.nr_sequencia);

        elsif (etapa.ie_evento_sumario = 'N') then

          CALL calc_dt_real_etapa_prot_int(etapa.nr_sequencia);

        end if;

    END; END LOOP;

    CALL prot_int_atualizar_eventos(nr_seq_protocolo_int_pac_p);

    COMMIT;

END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE prot_int_atualizar_etapas ( nr_seq_protocolo_int_pac_p protocolo_int_paciente.nr_sequencia%TYPE ) FROM PUBLIC;

