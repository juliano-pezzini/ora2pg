-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_palmweb_confirmar_coleta (nr_prescricao_p bigint, nr_seq_prescricao_p bigint, ie_status_atend_p bigint, nm_usuario_p text, ie_acao_p text default 'COMETIQUETA') AS $body$
DECLARE


cd_estabelecimento_w		        prescr_medica.cd_estabelecimento%type;
ie_status_coleta_integ_w	        lab_parametro.ie_status_coleta_integ%type;
nr_seq_prescr_mat_alt_comp_w        prescr_mat_alteracao_comp.nr_sequencia%type;
nr_sequencia_prescr_mat_alt_w       prescr_mat_alteracao.nr_sequencia%type;
nr_seq_motivo_adm_w                bigint;


BEGIN

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_prescricao_p IS NOT NULL AND nr_seq_prescricao_p::text <> '') then

	update	prescr_procedimento
	set	dt_coleta = clock_timestamp(),
		dt_atualizacao = clock_timestamp(),
		nm_usuario = nm_usuario_p,
		ie_status_atend = ie_status_atend_p
	where	nr_prescricao = nr_prescricao_p
	and	nr_sequencia = nr_seq_prescricao_p;	

    if (ie_acao_p IS NOT NULL AND ie_acao_p::text <> '') then
          insert into lab_palm_coleta_hist(nr_sequencia, 
                                            dt_atualizacao, 
                                            nm_usuario, 
                                            dt_atualizacao_nrec, 
                                            nm_usuario_nrec, 
                                            ie_status_atend, 
                                            nr_seq_prescricao, 
                                            nr_prescricao, 
                                            ds_acao) 
          values (nextval('lab_palm_coleta_hist_seq'),
                 clock_timestamp(),
                 nm_usuario_p, 
                 clock_timestamp(), 
                 nm_usuario_p,
                 ie_status_atend_p,  
                 nr_seq_prescricao_p, 
                 nr_prescricao_p,
                 ie_acao_p);

          
          if ie_acao_p = 'SEMETIQUETA' then
                select max(nr_sequencia)
                into STRICT nr_sequencia_prescr_mat_alt_w
                from prescr_mat_alteracao
                where nr_prescricao = nr_prescricao_p
                  and nr_seq_procedimento = nr_seq_prescricao_p;

		
                nr_seq_motivo_adm_w := obter_param_usuario(88, 350, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, nr_seq_motivo_adm_w);

                if (nr_sequencia_prescr_mat_alt_w IS NOT NULL AND nr_sequencia_prescr_mat_alt_w::text <> '') and (nr_seq_motivo_adm_w IS NOT NULL AND nr_seq_motivo_adm_w::text <> '') then

                    select max(nr_sequencia)+1
                    into STRICT nr_seq_prescr_mat_alt_comp_w
                    from prescr_mat_alteracao_comp;
    
                    INSERT INTO prescr_mat_alteracao_comp(nr_sequencia, 
                        dt_atualizacao, 
                        cd_intervalo, 
                        nm_usuario, 
                        dt_atualizacao_nrec, 
                        nm_usuario_nrec, 
                        nr_sequencia_prescr,
                        qt_dose,
                        nr_seq_motivo_adm)
                    VALUES (nr_seq_prescr_mat_alt_comp_w,
                        clock_timestamp(),
                        null,
                        nm_usuario_p,
                        clock_timestamp(),
                        nm_usuario_p,
                        nr_sequencia_prescr_mat_alt_w,
                        null,
                        nr_seq_motivo_adm_w);
                end if;
          end if;
    end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_palmweb_confirmar_coleta (nr_prescricao_p bigint, nr_seq_prescricao_p bigint, ie_status_atend_p bigint, nm_usuario_p text, ie_acao_p text default 'COMETIQUETA') FROM PUBLIC;

