-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE dados_composic_proc AS (	nr_seq_composicao		pls_util_cta_pck.t_number_table,
			nr_seq_pacote			pls_util_cta_pck.t_number_table,
			nr_seq_imp_pacote		pls_util_cta_pck.t_number_table,
			cd_procedimento			pls_util_cta_pck.t_number_table,
			ie_origem_proced		pls_util_cta_pck.t_number_table,
			qt_procedimento			pls_util_cta_pck.t_number_table,
			vl_negociado			pls_util_cta_pck.t_number_table);
CREATE TYPE dados_composic_mat AS (	nr_seq_composicao		pls_util_cta_pck.t_number_table,
			nr_seq_pacote			pls_util_cta_pck.t_number_table,
			nr_seq_imp_pacote		pls_util_cta_pck.t_number_table,
			nr_seq_material			pls_util_cta_pck.t_number_table,
			qt_material			pls_util_cta_pck.t_number_table,
			vl_negociado			pls_util_cta_pck.t_number_table);


CREATE OR REPLACE PROCEDURE pls_gerar_pacotes_lote_imp ( nr_seq_lote_pct_p pls_imp_pacote.nr_seq_lote_pct%type, nm_composicao_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_procedimento_w	pls_pacote.cd_procedimento%type;
ie_origem_proced_w	pls_pacote.ie_origem_proced%type := 4;
cd_procedimento_comp_w	pls_pacote_procedimento.cd_procedimento%type;
nr_seq_material_comp_w	pls_pacote_material.nr_seq_material%type;
ie_origem_proced_comp_w	pls_pacote_procedimento.ie_origem_proced%type;
nr_seq_pacote_w		pls_pacote.nr_sequencia%type;
nr_seq_composicao_w	pls_pacote_composicao.nr_sequencia%type;
dados_insert_proc_w	dados_composic_proc;
dados_insert_mat_w	dados_composic_mat;
dados_ins_proc_prop_w	dados_composic_proc;
dados_ins_mat_prop_w	dados_composic_mat;
p			integer := 0;
m			integer := 0;
x			integer := 0;
y			integer := 0;
qt_registros_w		integer := 0;
cd_versao_tiss_w	pls_versao_tiss.cd_versao_tiss%type;
ie_pacote_local_w	pls_pacote.ie_pacote_local%type;

C01 CURSOR(nr_seq_lote_pct_pc	pls_imp_pacote.nr_seq_lote_pct%type) FOR
	SELECT	trunc(dt_inicio_vigencia,'dd') dt_inicio_vigencia,
		cd_tipo_tabela_imp,
		cd_pacote,
		cd_tipo_tabela_comp,
		qt_composicao,
		round((vl_tot_composicao)::numeric,2) vl_tot_composicao,
		cd_composicao,
		nr_sequencia
	from	pls_imp_pacote
	where	nr_seq_lote_pct	= nr_seq_lote_pct_pc;

procedure incluir_registro_log(	ds_log			pls_log_geracao_pct.ds_log%type) is;
BEGIN

insert into pls_log_geracao_pct(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
		nr_seq_lote_pct,ds_log)
values (	nextval('pls_log_geracao_pct_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
		nr_seq_lote_pct_p,ds_log);

end;

begin

cd_versao_tiss_w	:= pls_obter_versao_tiss;

for r_c01_w in C01(nr_seq_lote_pct_p) loop
	begin

	select	max(cd_procedimento)
	into STRICT	cd_procedimento_w
	from	procedimento
	where	cd_procedimento		= r_c01_w.cd_pacote
	and	ie_origem_proced	= ie_origem_proced_w;

	if (cd_procedimento_w IS NOT NULL AND cd_procedimento_w::text <> '') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_pacote_w
		from	pls_pacote
		where	cd_procedimento		= cd_procedimento_w
		and	ie_origem_proced	= ie_origem_proced_w;

		if (coalesce(nr_seq_pacote_w::text, '') = '') then
			insert into pls_pacote(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
					cd_estabelecimento,ie_situacao,ds_observacao,cd_procedimento,ie_origem_proced,
					ie_regra_preco,ie_situacao_liberacao, ie_pacote_local)
			values (	nextval('pls_pacote_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
					cd_estabelecimento_p,'A','IMPORTADO CONFORME PADRÃO FEDERAÇÃO PARANAENSE',cd_procedimento_w,ie_origem_proced_w,
					'N','N','N')
			returning nr_sequencia into nr_seq_pacote_w;
		else
			select	coalesce(ie_pacote_local,'N')
			into STRICT	ie_pacote_local_w
			from	pls_pacote
			where	nr_sequencia = nr_seq_pacote_w;
		end if;

		if (coalesce(ie_pacote_local_w,'N') = 'N') then
			select	max(nr_sequencia)
			into STRICT	nr_seq_composicao_w
			from	pls_pacote_composicao
			where	nr_seq_pacote	= nr_seq_pacote_w
			and	trunc(dt_inicio_vigencia,'dd') = r_c01_w.dt_inicio_vigencia;

			if (coalesce(nr_seq_composicao_w::text, '') = '') then
				insert into pls_pacote_composicao(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
						ds_composicao,ie_situacao,nr_seq_pacote,dt_liberacao,nm_usuario_liberacao,
						dt_inicio_vigencia)
				values (	nextval('pls_pacote_composicao_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
						nm_composicao_p,'A',nr_seq_pacote_w,clock_timestamp(),nm_usuario_p,
						r_c01_w.dt_inicio_vigencia)
				returning nr_sequencia into nr_seq_composicao_w;
			end if;

			if (r_c01_w.cd_tipo_tabela_comp in ('00','0')) then

				nr_seq_material_comp_w := null;
				ie_origem_proced_comp_w := 4;

				select	max(cd_procedimento)
				into STRICT	cd_procedimento_comp_w
				from	procedimento
				where	cd_procedimento		= r_c01_w.cd_composicao
				and	ie_origem_proced	= ie_origem_proced_comp_w;

				if (coalesce(cd_procedimento_comp_w::text, '') = '') then

					 nr_seq_material_comp_w := pls_obter_mat_tiss_vigente( nr_seq_material_comp_w, r_c01_w.dt_inicio_vigencia, r_c01_w.cd_composicao, 'O', 'S', cd_versao_tiss_w);

					if (coalesce(nr_seq_material_comp_w::text, '') = '') then
						 nr_seq_material_comp_w := pls_obter_mat_tiss_vigente( nr_seq_material_comp_w, r_c01_w.dt_inicio_vigencia, r_c01_w.cd_composicao, 'O', 'N', cd_versao_tiss_w);
						if (coalesce(nr_seq_material_comp_w::text, '') = '') then
							 nr_seq_material_comp_w := pls_obter_mat_tiss_vigente( nr_seq_material_comp_w, r_c01_w.dt_inicio_vigencia, r_c01_w.cd_composicao, 'O', 'N', null);
						end if;
					end if;

					if (coalesce(nr_seq_material_comp_w::text, '') = '') then
						incluir_registro_log('Não foi encontrado nem procedimento nem material com o código próprio ' || r_c01_w.cd_composicao);
					end if;
				end if;

				if (cd_procedimento_comp_w IS NOT NULL AND cd_procedimento_comp_w::text <> '') then

					select	count(1)
					into STRICT	qt_registros_w
					from	pls_pacote_procedimento
					where	cd_procedimento		= cd_procedimento_comp_w
					and	ie_origem_proced	= ie_origem_proced_comp_w
					and	nr_seq_composicao	= nr_seq_composicao_w
					and	qt_procedimento		= r_c01_w.qt_composicao
					and	vl_negociado		= r_c01_w.vl_tot_composicao  LIMIT 1;

					if (qt_registros_w	= 0) then
						dados_ins_proc_prop_w.nr_seq_composicao(x)	:= nr_seq_composicao_w;
						dados_ins_proc_prop_w.nr_seq_pacote(x)		:= nr_seq_pacote_w;
						dados_ins_proc_prop_w.cd_procedimento(x)	:= cd_procedimento_comp_w;
						dados_ins_proc_prop_w.ie_origem_proced(x)	:= ie_origem_proced_comp_w;
						dados_ins_proc_prop_w.qt_procedimento(x)	:= r_c01_w.qt_composicao;
						dados_ins_proc_prop_w.vl_negociado(x)		:= r_c01_w.vl_tot_composicao;
						dados_ins_proc_prop_w.nr_seq_imp_pacote(x)	:= r_c01_w.nr_sequencia;

						if (x >= pls_util_cta_pck.qt_registro_transacao_w) then
							forall i in dados_ins_proc_prop_w.cd_procedimento.first..dados_ins_proc_prop_w.cd_procedimento.last
								insert into pls_pacote_procedimento(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
										nr_seq_composicao,cd_procedimento,ie_origem_proced,
										qt_procedimento,vl_negociado,ie_estrutura,ie_gerar_a1200,ie_gerar_a500,ie_situacao)
								values (	nextval('pls_pacote_procedimento_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
										dados_ins_proc_prop_w.nr_seq_composicao(i),dados_ins_proc_prop_w.cd_procedimento(i),dados_ins_proc_prop_w.ie_origem_proced(i),
										dados_ins_proc_prop_w.qt_procedimento(i),dados_ins_proc_prop_w.vl_negociado(i),'S','N','N','A');

							forall i in dados_ins_proc_prop_w.cd_procedimento.first..dados_ins_proc_prop_w.cd_procedimento.last
								update	pls_imp_pacote
								set	nr_seq_composicao	= dados_ins_proc_prop_w.nr_seq_composicao(i),
									nr_seq_pacote		= dados_ins_proc_prop_w.nr_seq_pacote(i)
								where	nr_sequencia		= dados_ins_proc_prop_w.nr_seq_imp_pacote(i);

							dados_ins_proc_prop_w.nr_seq_composicao.delete;
							dados_ins_proc_prop_w.nr_seq_pacote.delete;
							dados_ins_proc_prop_w.cd_procedimento.delete;
							dados_ins_proc_prop_w.ie_origem_proced.delete;
							dados_ins_proc_prop_w.qt_procedimento.delete;
							dados_ins_proc_prop_w.vl_negociado.delete;
							dados_ins_proc_prop_w.nr_seq_imp_pacote.delete;

							x := 0;

						else
							x := x +1;
						end if;
					end if;

				elsif (nr_seq_material_comp_w IS NOT NULL AND nr_seq_material_comp_w::text <> '') then

					select	count(1)
					into STRICT	qt_registros_w
					from	pls_pacote_material
					where	nr_seq_material		= nr_seq_material_comp_w
					and	nr_seq_composicao	= nr_seq_composicao_w
					and	qt_material		= r_c01_w.qt_composicao
					and	vl_negociado		= r_c01_w.vl_tot_composicao  LIMIT 1;

					if (qt_registros_w	= 0) then
						dados_ins_mat_prop_w.nr_seq_composicao(y)	:= nr_seq_composicao_w;
						dados_ins_mat_prop_w.nr_seq_pacote(y)		:= nr_seq_pacote_w;
						dados_ins_mat_prop_w.nr_seq_material(y)		:= nr_seq_material_comp_w;
						dados_ins_mat_prop_w.qt_material(y)		:= r_c01_w.qt_composicao;
						dados_ins_mat_prop_w.vl_negociado(y)		:= r_c01_w.vl_tot_composicao;
						dados_ins_mat_prop_w.nr_seq_imp_pacote(y)	:= r_c01_w.nr_sequencia;

						if (y >= pls_util_cta_pck.qt_registro_transacao_w) then
							forall i in dados_ins_mat_prop_w.nr_seq_material.first..dados_ins_mat_prop_w.nr_seq_material.last
								insert into pls_pacote_material(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
										nr_seq_composicao,nr_seq_material,qt_material,
										vl_negociado,ie_gerar_a1200,ie_gerar_a500,ie_situacao)
								values (	nextval('pls_pacote_material_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
										dados_ins_mat_prop_w.nr_seq_composicao(i),dados_ins_mat_prop_w.nr_seq_material(i),dados_ins_mat_prop_w.qt_material(i),
										dados_ins_mat_prop_w.vl_negociado(i),'N','N','A');

							forall i in dados_ins_mat_prop_w.nr_seq_composicao.first..dados_ins_mat_prop_w.nr_seq_composicao.last
								update	pls_imp_pacote
								set	nr_seq_composicao	= dados_ins_mat_prop_w.nr_seq_composicao(i),
									nr_seq_pacote		= dados_ins_mat_prop_w.nr_seq_pacote(i)
								where	nr_sequencia		= dados_ins_mat_prop_w.nr_seq_imp_pacote(i);

							dados_ins_mat_prop_w.nr_seq_composicao.delete;
							dados_ins_mat_prop_w.nr_seq_pacote.delete;
							dados_ins_mat_prop_w.nr_seq_material.delete;
							dados_ins_mat_prop_w.qt_material.delete;
							dados_ins_mat_prop_w.vl_negociado.delete;
							dados_ins_mat_prop_w.nr_seq_imp_pacote.delete;

							y := 0;
						else
							y := y +1;
						end if;
					end if;
				end if;

			elsif (r_c01_w.cd_tipo_tabela_comp in ('18','22','97')) then

				if (r_c01_w.cd_tipo_tabela_comp <> '97') then
					ie_origem_proced_comp_w	:= 8;
				else
					ie_origem_proced_comp_w	:= 4;
				end if;

				select	max(cd_procedimento)
				into STRICT	cd_procedimento_comp_w
				from	procedimento
				where	cd_procedimento		= r_c01_w.cd_composicao
				and	ie_origem_proced	= ie_origem_proced_comp_w;

				if (coalesce(cd_procedimento_comp_w::text, '') = '') then
					incluir_registro_log('Não foi encontrado o procedimento com o código ' || r_c01_w.cd_composicao || ' e a com origem ' ||
								substr(obter_valor_dominio(30,to_char(ie_origem_proced_comp_w)),1,255));
				else
					select	count(1)
					into STRICT	qt_registros_w
					from	pls_pacote_procedimento
					where	cd_procedimento		= cd_procedimento_comp_w
					and	ie_origem_proced	= ie_origem_proced_comp_w
					and	nr_seq_composicao	= nr_seq_composicao_w
					and	qt_procedimento		= r_c01_w.qt_composicao
					and	vl_negociado		= r_c01_w.vl_tot_composicao  LIMIT 1;

					if (qt_registros_w	= 0) then
						dados_insert_proc_w.nr_seq_composicao(p)	:= nr_seq_composicao_w;
						dados_insert_proc_w.nr_seq_pacote(p)		:= nr_seq_pacote_w;
						dados_insert_proc_w.cd_procedimento(p)		:= cd_procedimento_comp_w;
						dados_insert_proc_w.ie_origem_proced(p)		:= ie_origem_proced_comp_w;
						dados_insert_proc_w.qt_procedimento(p)		:= r_c01_w.qt_composicao;
						dados_insert_proc_w.vl_negociado(p)		:= r_c01_w.vl_tot_composicao;
						dados_insert_proc_w.nr_seq_imp_pacote(p)	:= r_c01_w.nr_sequencia;

						if (p >= pls_util_cta_pck.qt_registro_transacao_w) then
							forall i in dados_insert_proc_w.cd_procedimento.first..dados_insert_proc_w.cd_procedimento.last
								insert into pls_pacote_procedimento(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
										nr_seq_composicao,cd_procedimento,ie_origem_proced,
										qt_procedimento,vl_negociado,ie_estrutura,ie_gerar_a1200,ie_gerar_a500,ie_situacao)
								values (	nextval('pls_pacote_procedimento_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
										dados_insert_proc_w.nr_seq_composicao(i),dados_insert_proc_w.cd_procedimento(i),dados_insert_proc_w.ie_origem_proced(i),
										dados_insert_proc_w.qt_procedimento(i),dados_insert_proc_w.vl_negociado(i),'S','N','N','A');

							forall i in dados_insert_proc_w.cd_procedimento.first..dados_insert_proc_w.cd_procedimento.last
								update	pls_imp_pacote
								set	nr_seq_composicao	= dados_insert_proc_w.nr_seq_composicao(i),
									nr_seq_pacote		= dados_insert_proc_w.nr_seq_pacote(i)
								where	nr_sequencia		= dados_insert_proc_w.nr_seq_imp_pacote(i);

							dados_insert_proc_w.nr_seq_composicao.delete;
							dados_insert_proc_w.nr_seq_pacote.delete;
							dados_insert_proc_w.cd_procedimento.delete;
							dados_insert_proc_w.ie_origem_proced.delete;
							dados_insert_proc_w.qt_procedimento.delete;
							dados_insert_proc_w.vl_negociado.delete;
							dados_insert_proc_w.nr_seq_imp_pacote.delete;

							p := 0;

						else
							p := p +1;
						end if;
					end if;
				end if;
			elsif (r_c01_w.cd_tipo_tabela_comp in ('19','20','95','96')) then

				nr_seq_material_comp_w	:= null;

				 nr_seq_material_comp_w := pls_obter_mat_tiss_vigente( nr_seq_material_comp_w, r_c01_w.dt_inicio_vigencia, r_c01_w.cd_composicao, 'O', 'S', cd_versao_tiss_w);

				if (coalesce(nr_seq_material_comp_w::text, '') = '') then
					 nr_seq_material_comp_w := pls_obter_mat_tiss_vigente( nr_seq_material_comp_w, r_c01_w.dt_inicio_vigencia, r_c01_w.cd_composicao, 'O', 'N', cd_versao_tiss_w);
					if (coalesce(nr_seq_material_comp_w::text, '') = '') then
						 nr_seq_material_comp_w := pls_obter_mat_tiss_vigente( nr_seq_material_comp_w, r_c01_w.dt_inicio_vigencia, r_c01_w.cd_composicao, 'O', 'N', null);
					end if;
				end if;

				if (coalesce(nr_seq_material_comp_w::text, '') = '') then
					incluir_registro_log('Não foi encontrado o material com o código ' || r_c01_w.cd_composicao);
				else
					select	count(1)
					into STRICT	qt_registros_w
					from	pls_pacote_material
					where	nr_seq_material		= nr_seq_material_comp_w
					and	nr_seq_composicao	= nr_seq_composicao_w
					and	qt_material		= r_c01_w.qt_composicao
					and	vl_negociado		= r_c01_w.vl_tot_composicao  LIMIT 1;

					if (qt_registros_w	= 0) then
						dados_insert_mat_w.nr_seq_composicao(m)	:= nr_seq_composicao_w;
						dados_insert_mat_w.nr_seq_pacote(m)	:= nr_seq_pacote_w;
						dados_insert_mat_w.nr_seq_material(m)	:= nr_seq_material_comp_w;
						dados_insert_mat_w.qt_material(m)	:= r_c01_w.qt_composicao;
						dados_insert_mat_w.vl_negociado(m)	:= r_c01_w.vl_tot_composicao;
						dados_insert_mat_w.nr_seq_imp_pacote(m)	:= r_c01_w.nr_sequencia;

						if (m >= pls_util_cta_pck.qt_registro_transacao_w) then
							forall i in dados_insert_mat_w.nr_seq_material.first..dados_insert_mat_w.nr_seq_material.last
								insert into pls_pacote_material(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
										nr_seq_composicao,nr_seq_material,qt_material,
										vl_negociado,ie_gerar_a1200,ie_gerar_a500,ie_situacao)
								values (	nextval('pls_pacote_material_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
										dados_insert_mat_w.nr_seq_composicao(i),dados_insert_mat_w.nr_seq_material(i),dados_insert_mat_w.qt_material(i),
										dados_insert_mat_w.vl_negociado(i),'N','N','A');

							forall i in dados_insert_mat_w.nr_seq_composicao.first..dados_insert_mat_w.nr_seq_composicao.last
								update	pls_imp_pacote
								set	nr_seq_composicao	= dados_insert_mat_w.nr_seq_composicao(i),
									nr_seq_pacote		= dados_insert_mat_w.nr_seq_pacote(i)
								where	nr_sequencia		= dados_insert_mat_w.nr_seq_imp_pacote(i);

							dados_insert_mat_w.nr_seq_composicao.delete;
							dados_insert_mat_w.nr_seq_pacote.delete;
							dados_insert_mat_w.nr_seq_material.delete;
							dados_insert_mat_w.qt_material.delete;
							dados_insert_mat_w.vl_negociado.delete;
							dados_insert_mat_w.nr_seq_imp_pacote.delete;

							m := 0;
						else
							m := m +1;
						end if;
					end if;
				end if;
			end if;
		end if;
	else
		incluir_registro_log('Não foi encontrado o procedimento ' || r_c01_w.cd_pacote || ' com origem Próprio ');
	end if;
	end;
end loop;

if (dados_insert_proc_w.cd_procedimento.count > 0) then
	forall i in dados_insert_proc_w.cd_procedimento.first..dados_insert_proc_w.cd_procedimento.last
		insert into pls_pacote_procedimento(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
				nr_seq_composicao,cd_procedimento,ie_origem_proced,
				qt_procedimento,vl_negociado,ie_estrutura,ie_gerar_a1200,ie_gerar_a500,ie_situacao)
		values (	nextval('pls_pacote_procedimento_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
				dados_insert_proc_w.nr_seq_composicao(i),dados_insert_proc_w.cd_procedimento(i),dados_insert_proc_w.ie_origem_proced(i),
				dados_insert_proc_w.qt_procedimento(i),dados_insert_proc_w.vl_negociado(i),'S','N','N','A');

	forall i in dados_insert_proc_w.cd_procedimento.first..dados_insert_proc_w.cd_procedimento.last
		update	pls_imp_pacote
		set	nr_seq_composicao	= dados_insert_proc_w.nr_seq_composicao(i),
			nr_seq_pacote		= dados_insert_proc_w.nr_seq_pacote(i)
		where	nr_sequencia		= dados_insert_proc_w.nr_seq_imp_pacote(i);

	dados_insert_proc_w.nr_seq_composicao.delete;
	dados_insert_proc_w.nr_seq_pacote.delete;
	dados_insert_proc_w.cd_procedimento.delete;
	dados_insert_proc_w.ie_origem_proced.delete;
	dados_insert_proc_w.qt_procedimento.delete;
	dados_insert_proc_w.vl_negociado.delete;
	dados_insert_proc_w.nr_seq_imp_pacote.delete;
end if;

if (dados_ins_proc_prop_w.cd_procedimento.count > 0) then
	forall i in dados_ins_proc_prop_w.cd_procedimento.first..dados_ins_proc_prop_w.cd_procedimento.last
		insert into pls_pacote_procedimento(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
				nr_seq_composicao,cd_procedimento,ie_origem_proced,
				qt_procedimento,vl_negociado,ie_estrutura,ie_gerar_a1200,ie_gerar_a500,ie_situacao)
		values (	nextval('pls_pacote_procedimento_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
				dados_ins_proc_prop_w.nr_seq_composicao(i),dados_ins_proc_prop_w.cd_procedimento(i),dados_ins_proc_prop_w.ie_origem_proced(i),
				dados_ins_proc_prop_w.qt_procedimento(i),dados_ins_proc_prop_w.vl_negociado(i),'S','N','N','A');

	forall i in dados_ins_proc_prop_w.cd_procedimento.first..dados_ins_proc_prop_w.cd_procedimento.last
		update	pls_imp_pacote
		set	nr_seq_composicao	= dados_ins_proc_prop_w.nr_seq_composicao(i),
			nr_seq_pacote		= dados_ins_proc_prop_w.nr_seq_pacote(i)
		where	nr_sequencia		= dados_ins_proc_prop_w.nr_seq_imp_pacote(i);

	dados_ins_proc_prop_w.nr_seq_composicao.delete;
	dados_ins_proc_prop_w.nr_seq_pacote.delete;
	dados_ins_proc_prop_w.cd_procedimento.delete;
	dados_ins_proc_prop_w.ie_origem_proced.delete;
	dados_ins_proc_prop_w.qt_procedimento.delete;
	dados_ins_proc_prop_w.vl_negociado.delete;
	dados_ins_proc_prop_w.nr_seq_imp_pacote.delete;
end if;

if (dados_insert_mat_w.nr_seq_material.count > 0) then
	forall i in dados_insert_mat_w.nr_seq_material.first..dados_insert_mat_w.nr_seq_material.last
		insert into pls_pacote_material(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
				nr_seq_composicao,nr_seq_material,qt_material,
				vl_negociado,ie_gerar_a1200,ie_gerar_a500,ie_situacao)
		values (	nextval('pls_pacote_material_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
				dados_insert_mat_w.nr_seq_composicao(i),dados_insert_mat_w.nr_seq_material(i),dados_insert_mat_w.qt_material(i),
				dados_insert_mat_w.vl_negociado(i),'N','N','A');

	forall i in dados_insert_mat_w.nr_seq_composicao.first..dados_insert_mat_w.nr_seq_composicao.last
		update	pls_imp_pacote
		set	nr_seq_composicao	= dados_insert_mat_w.nr_seq_composicao(i),
			nr_seq_pacote		= dados_insert_mat_w.nr_seq_pacote(i)
		where	nr_sequencia		= dados_insert_mat_w.nr_seq_imp_pacote(i);

	dados_insert_mat_w.nr_seq_composicao.delete;
	dados_insert_mat_w.nr_seq_pacote.delete;
	dados_insert_mat_w.nr_seq_material.delete;
	dados_insert_mat_w.qt_material.delete;
	dados_insert_mat_w.vl_negociado.delete;
	dados_insert_mat_w.nr_seq_imp_pacote.delete;
end if;

if (dados_ins_mat_prop_w.nr_seq_material.count > 0) then
	forall i in dados_ins_mat_prop_w.nr_seq_material.first..dados_ins_mat_prop_w.nr_seq_material.last
		insert into pls_pacote_material(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
				nr_seq_composicao,nr_seq_material,qt_material,
				vl_negociado,ie_gerar_a1200,ie_gerar_a500,ie_situacao)
		values (	nextval('pls_pacote_material_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
				dados_ins_mat_prop_w.nr_seq_composicao(i),dados_ins_mat_prop_w.nr_seq_material(i),dados_ins_mat_prop_w.qt_material(i),
				dados_ins_mat_prop_w.vl_negociado(i),'N','N','A');

	forall i in dados_ins_mat_prop_w.nr_seq_composicao.first..dados_ins_mat_prop_w.nr_seq_composicao.last
		update	pls_imp_pacote
		set	nr_seq_composicao	= dados_ins_mat_prop_w.nr_seq_composicao(i),
			nr_seq_pacote		= dados_ins_mat_prop_w.nr_seq_pacote(i)
		where	nr_sequencia		= dados_ins_mat_prop_w.nr_seq_imp_pacote(i);

	dados_ins_mat_prop_w.nr_seq_composicao.delete;
	dados_ins_mat_prop_w.nr_seq_pacote.delete;
	dados_ins_mat_prop_w.nr_seq_material.delete;
	dados_ins_mat_prop_w.qt_material.delete;
	dados_ins_mat_prop_w.vl_negociado.delete;
	dados_ins_mat_prop_w.nr_seq_imp_pacote.delete;
end if;

update	pls_imp_lote_pacote
set	dt_geracao_pacote	= clock_timestamp()
where	nr_sequencia		= nr_seq_lote_pct_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_pacotes_lote_imp ( nr_seq_lote_pct_p pls_imp_pacote.nr_seq_lote_pct%type, nm_composicao_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

