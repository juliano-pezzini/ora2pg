-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dirf_mensal_registro_vpeim ( nr_seq_lote_p bigint, nm_usuario_p text) AS $body$
DECLARE


separador_w	varchar(1) := '|';
ds_arquivo_w	varchar(2000);
ie_registro_w	dirf_titulo_pagar.ie_registro%type;
nr_seq_apres_w	w_dirf_arquivo.nr_seq_apresentacao%type;

C01 CURSOR FOR
	SELECT	t.cd_cgc,
		obter_dados_pf_pj(null, t.cd_cgc, 'N') nome
	from	dirf_titulo_pagar t,
		dirf_lote_mensal d,
		dirf_agrupar_lote a,
		dirf_lote l
	where	t.nr_seq_lote_dirf = d.nr_sequencia
	and	d.nr_sequencia 	   = a.nr_seq_lote_mensal
	and	l.nr_sequencia 	= a.nr_seq_lote_anual
	and    	a.nr_seq_lote_anual = nr_seq_lote_p
	and	t.ie_registro = ie_registro_w
	group by cd_cgc,
		obter_dados_pf_pj(null, cd_cgc, 'N');
c01_w c01%rowtype;


BEGIN

nr_seq_apres_w := 500000;

ie_registro_w := 'RIMUN';

open C01;
loop
fetch C01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select 	'VPEIM' || separador_w ||
		c01_w.cd_cgc || separador_w ||
		c01_w.nome || separador_w
	into STRICT	ds_arquivo_w
	from	dirf_lote a
	where	a.nr_sequencia = nr_seq_lote_p;

	insert 	into w_dirf_arquivo(nr_sequencia,
				     nm_usuario,
				     nm_usuario_nrec,
				     dt_atualizacao,
				     dt_atualizacao_nrec,
				     ds_arquivo,
				     nr_seq_apresentacao,
				     nr_seq_registro)
	values (nextval('w_dirf_arquivo_seq'),
				     nm_usuario_p,
				     nm_usuario_p,
				     clock_timestamp(),
				     clock_timestamp(),
				     substr(ds_arquivo_w,1,4000),
				     nr_seq_apres_w,
				     0);

	nr_seq_apres_w 	:= nr_seq_apres_w + 1;

	nr_seq_apres_w := dirf_grava_RIMUN_RISEN(nr_seq_lote_p, nm_usuario_p, nr_seq_apres_w, c01_w.cd_cgc, ie_registro_w);

	end;
end loop;
close C01;

ie_registro_w := 'RISEN';

open C01;
loop
fetch C01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select 	'VPEIM' || separador_w ||
		c01_w.cd_cgc || separador_w ||
		c01_w.nome || separador_w
	into STRICT	ds_arquivo_w
	from	dirf_lote a
	where	a.nr_sequencia = nr_seq_lote_p;

	insert 	into w_dirf_arquivo(nr_sequencia,
				     nm_usuario,
				     nm_usuario_nrec,
				     dt_atualizacao,
				     dt_atualizacao_nrec,
				     ds_arquivo,
				     nr_seq_apresentacao,
				     nr_seq_registro)
	values (nextval('w_dirf_arquivo_seq'),
				     nm_usuario_p,
				     nm_usuario_p,
				     clock_timestamp(),
				     clock_timestamp(),
				     substr(ds_arquivo_w,1,4000),
				     nr_seq_apres_w,
				     0);

	nr_seq_apres_w 	:= nr_seq_apres_w + 1;

	nr_seq_apres_w := dirf_grava_RIMUN_RISEN(nr_seq_lote_p, nm_usuario_p, nr_seq_apres_w, c01_w.cd_cgc, ie_registro_w);

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dirf_mensal_registro_vpeim ( nr_seq_lote_p bigint, nm_usuario_p text) FROM PUBLIC;

