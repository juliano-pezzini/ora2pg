-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pfcs_ev_calc_inout_24h ( cd_establishment_p bigint, nm_user_p text) AS $body$
DECLARE


pfcs_panel_seq_w        pfcs_panel.nr_sequencia%type;
ds_timezone_w           establishment_locale.ds_timezone%type;
nr_seq_organization_w   pfcs_organization.nr_sequencia%type;

dt_current_day_tz_w     timestamp;
qt_admissions_w         integer     := 0;
qt_discharges_w         integer     := 0;



BEGIN
    ds_timezone_w := get_establishment_timezone(cd_establishment_p);
    dt_current_day_tz_w := trunc(timezone_utils.getDate(clock_timestamp(),ds_timezone_w));

    select  max(org.nr_sequencia)
    into STRICT    nr_seq_organization_w
    from    pfcs_organization org
    where   org.cd_estabelecimento = cd_establishment_p;

    select count(enc.id_encounter)
    into STRICT qt_admissions_w
    from pfcs_encounter enc,
        pfcs_service_request svc
    where (enc.period_start IS NOT NULL AND enc.period_start::text <> '')
        and enc.nr_seq_organization = nr_seq_organization_w
        and svc.nr_seq_encounter = enc.nr_sequencia
        and svc.nr_seq_patient = enc.nr_seq_patient
        and ((svc.cd_service = PFCS_PCK_CONSTANTS.CD_ADMISSION
                    and svc.si_status = PFCS_PCK_CONSTANTS.SI_STATUS_COMPLETED
                    and svc.si_intent = PFCS_PCK_CONSTANTS.SI_INTENT_ORDER)
                or svc.cd_service = PFCS_PCK_CONSTANTS.CD_TRANSFER
                or svc.cd_service = PFCS_PCK_CONSTANTS.CD_DISCHARGE)
        and trunc(timezone_utils.getDate(enc.period_start,ds_timezone_w)) = dt_current_day_tz_w;

    select count(enc.id_encounter)
    into STRICT qt_discharges_w
    from pfcs_encounter enc,
        pfcs_service_request svc
    where (enc.period_start IS NOT NULL AND enc.period_start::text <> '')
        and (enc.period_end IS NOT NULL AND enc.period_end::text <> '')
        and enc.nr_seq_organization = nr_seq_organization_w
        and svc.nr_seq_encounter = enc.nr_sequencia
        and svc.nr_seq_patient = enc.nr_seq_patient
        and svc.cd_service = PFCS_PCK_CONSTANTS.CD_DISCHARGE
        and svc.si_status = PFCS_PCK_CONSTANTS.SI_STATUS_COMPLETED
        and svc.si_intent = PFCS_PCK_CONSTANTS.SI_INTENT_ORDER
        and trunc(timezone_utils.getDate(svc.dt_authored_on,ds_timezone_w)) = dt_current_day_tz_w;

     := pfcs_pck.pfcs_generate_results(
            vl_indicator_p => qt_admissions_w, nr_seq_indicator_p => 105, nr_seq_operational_level_p => cd_establishment_p, nm_usuario_p => nm_user_p, nr_seq_panel_p => pfcs_panel_seq_w);
     := pfcs_pck.pfcs_generate_results(
            vl_indicator_p => qt_discharges_w, nr_seq_indicator_p => 106, nr_seq_operational_level_p => cd_establishment_p, nm_usuario_p => nm_user_p, nr_seq_panel_p => pfcs_panel_seq_w);

    CALL pfcs_pck.pfcs_activate_records(
            nr_seq_indicator_p => 105,
            nr_seq_operational_level_p => cd_establishment_p,
            nm_usuario_p => nm_user_p);
    CALL pfcs_pck.pfcs_activate_records(
            nr_seq_indicator_p => 106,
            nr_seq_operational_level_p => cd_establishment_p,
            nm_usuario_p => nm_user_p);
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_ev_calc_inout_24h ( cd_establishment_p bigint, nm_user_p text) FROM PUBLIC;

