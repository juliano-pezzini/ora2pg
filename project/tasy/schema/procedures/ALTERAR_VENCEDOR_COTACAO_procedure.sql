-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_vencedor_cotacao ( cd_material_p bigint, nr_cot_compra_p bigint, nr_item_cot_compra_p bigint, nr_seq_fornec_ant_p bigint, nr_seq_fornecedor_p bigint, ds_justificativa_p text, nm_usuario_p text, ie_motivo_alter_venc_p text default '') AS $body$
DECLARE


cd_cgc_w		varchar(14);
cd_cgc_ww		varchar(14);
nr_seq_cot_item_forn_w	bigint;
ds_motivo_venc_alt_w	varchar(4000);
nm_fornecedor_ant_w	varchar(80);
nm_fornecedor_w		varchar(80);


BEGIN

select	coalesce(max(cd_cgc_fornecedor),'')
into STRICT	cd_cgc_w
from	cot_compra_forn
where	nr_cot_compra	= nr_cot_compra_p
and	nr_sequencia	= nr_seq_fornec_ant_p;

nm_fornecedor_ant_w	:= substr(obter_nome_pf_pj(null, cd_cgc_w),1,80);

select	coalesce(max(cd_cgc_fornecedor),'')
into STRICT	cd_cgc_ww
from	cot_compra_forn
where	nr_cot_compra	= nr_cot_compra_p
and	nr_sequencia	= nr_seq_fornecedor_p;

nm_fornecedor_w		:= substr(obter_nome_pf_pj(null, cd_cgc_ww),1,80);

ds_motivo_venc_alt_w	:= substr(
			WHEB_MENSAGEM_PCK.get_texto(297139,
						'NM_USUARIO_P='||NM_USUARIO_P||
						';DT_ATUAL_W='||to_char(clock_timestamp(),'dd/mm/yyyy hh24:mi:ss')||
						';NM_FORNECEDOR_ANT_W='||NM_FORNECEDOR_ANT_W||
						';NM_FORNECEDOR_W='||NM_FORNECEDOR_W),1,4000);

if (ds_justificativa_p IS NOT NULL AND ds_justificativa_p::text <> '') then
	ds_motivo_venc_alt_w	:= substr(ds_motivo_venc_alt_w || chr(13) || chr(10) ||
				ds_justificativa_p,1,4000);
end if;

select	max(nr_sequencia)
into STRICT	nr_seq_cot_item_forn_w
from	cot_compra_forn_item
where	nr_cot_compra			= nr_cot_compra_p
and	nr_item_cot_compra		= nr_item_cot_compra_p
and	nr_seq_cot_forn			= nr_seq_fornecedor_p
and	cd_material			= cd_material_p;

update	cot_compra_item
set	cd_cgc_fornecedor_venc_alt		= cd_cgc_ww,
	cd_cgc_fornecedor_venc_sis		= cd_cgc_w,
	nr_seq_cot_item_forn		= nr_seq_cot_item_forn_w,
	dt_atualizacao			= clock_timestamp(),
	ds_motivo_venc_alt			= CASE WHEN substr(ds_motivo_venc_alt,1,4000) = NULL THEN substr(ds_motivo_venc_alt_w,1,4000)  ELSE substr(ds_motivo_venc_alt || chr(13) || chr(10) || chr(13) || chr(10) || ds_motivo_venc_alt_w,1,4000) END ,
	nm_usuario			= nm_usuario_p,
	ie_motivo_alter_venc		= ie_motivo_alter_venc_p
where	nr_cot_compra			= nr_cot_compra_p
and	nr_item_cot_compra		= nr_item_cot_compra_p;

CALL gerar_hist_cotacao_sem_commit(
	nr_cot_compra_p,
	WHEB_MENSAGEM_PCK.get_texto(297145),
	substr(	WHEB_MENSAGEM_PCK.get_texto(297147,
				'CD_MATERIAL_P='||CD_MATERIAL_P||
				';NM_FORNECEDOR_ANT_W='||NM_FORNECEDOR_ANT_W||
				';NM_FORNECEDOR_W='||NM_FORNECEDOR_W||
				';DS_JUSTIFICATIVA_P='||DS_JUSTIFICATIVA_P),1,4000),
	'S',
	nm_usuario_p);


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_vencedor_cotacao ( cd_material_p bigint, nr_cot_compra_p bigint, nr_item_cot_compra_p bigint, nr_seq_fornec_ant_p bigint, nr_seq_fornecedor_p bigint, ds_justificativa_p text, nm_usuario_p text, ie_motivo_alter_venc_p text default '') FROM PUBLIC;

