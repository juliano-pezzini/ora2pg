-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consulta_conv_ativo_intilab_ws ( nr_prontuario_p bigint, cd_setor_atendimento_p bigint, cd_convenio_p INOUT bigint, cd_plano_convenio_p INOUT text, ds_erro_p INOUT text) AS $body$
DECLARE


  cd_pessoa_fisica_w  	pessoa_fisica.cd_pessoa_fisica%type;
  nr_atendimento_w    	atendimento_paciente.nr_atendimento%type;
  cd_convenio_w       	atend_categoria_convenio.cd_convenio%type;
  cd_plano_convenio_w 	atend_categoria_convenio.cd_plano_convenio%type;
  cd_setor_atendimento_w	procedimento_paciente.cd_setor_atendimento%type;

  
  ds_retorno_w        varchar(2000);
  ds_erro_w          	varchar(2000);


BEGIN
    

  begin
      	select 	cd_pessoa_fisica 
      	into STRICT	cd_pessoa_fisica_w
     	from   	pessoa_fisica
     	where  	nr_prontuario = nr_prontuario_p;

      	exception
      	when others then        
      	ds_erro_w  := obter_desc_expressao(513083,'');
      	goto final_ds_erro;
  end;
  
  begin
	select  	cd_setor_atendimento
	into STRICT   	cd_setor_atendimento_w
	from    	setor_atendimento
	where   	cd_setor_atendimento = cd_setor_atendimento_p;
	
	exception
     	when others then
      	ds_erro_w  := obter_desc_expressao(619365,'');
    	goto final_ds_erro;

  end;

  begin
  	select	coalesce(max(a.nr_atendimento),0) nr_atendimento
      	into STRICT    	nr_atendimento_w
     	from    	pessoa_fisica b,
              		atendimento_paciente_v a
      	where   	a.cd_pessoa_fisica = b.cd_pessoa_fisica
     	and     	b.nr_prontuario = nr_prontuario_p
    	and    	 a.cd_setor_atendimento = cd_setor_atendimento_p;

  	exception
      	when others then        
      	ds_erro_w  := obter_desc_expressao(894542,'') || ' ( ' || nr_prontuario_p ||' ) ' || 
         	obter_desc_expressao(298466,'')  || ' ( '|| cd_setor_atendimento_p ||' ) !';
      	goto final_ds_erro;

  end;

  select	adiciona_zeros_esquerda(coalesce(max(cd_convenio),0),5) cd_convenio,
            	coalesce(max(cd_plano_convenio),0) cd_plano_convenio
  into STRICT    	cd_convenio_w,
            	cd_plano_convenio_w
  from    	atend_categoria_convenio a
  where   	a.nr_atendimento    = nr_atendimento_w
  and     	a.dt_inicio_vigencia  = 
            	(  SELECT  max(dt_inicio_vigencia)
              	from  Atend_categoria_convenio b
              	where   nr_atendimento  = nr_atendimento_w
            	);

  <<final_ds_erro>>
  cd_convenio_p		:= cd_convenio_w;
  cd_plano_convenio_p 	:= cd_plano_convenio_w;
  ds_erro_p           		:= substr(ds_erro_w,1,255);
					
					
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consulta_conv_ativo_intilab_ws ( nr_prontuario_p bigint, cd_setor_atendimento_p bigint, cd_convenio_p INOUT bigint, cd_plano_convenio_p INOUT text, ds_erro_p INOUT text) FROM PUBLIC;

