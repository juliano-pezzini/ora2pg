-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE intpd_recebimento_nota_fiscal (( nr_sequencia_p bigint, xml_p xml, id_event_p text default '18') is ie_conversao_w intpd_eventos_sistema.ie_conversao%type) RETURNS bigint AS $body$
DECLARE


_ora2pg_r RECORD;
ie_bloqueio_nr_serie_w		varchar(1);
ie_consiste_estab_w		varchar(1);
ie_bloqueio_nr_w		varchar(1);
nr_sequencia_w			nota_fiscal.nr_sequencia%type;

BEGIN

if	((coalesce(cd_cgc_emitente_p, 'XX') <> 'XX') or (ie_tipo_nota_p = 'EF')) then
	
	nr_sequencia_w		:= null;
	ie_bloqueio_nr_serie_w	:= substr(coalesce(obter_valor_param_usuario(40, 102, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p),'S'),1,1);
	ie_consiste_estab_w	:= substr(coalesce(obter_valor_param_usuario(40, 277, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p),'S'),1,1);
		
	if (ie_bloqueio_nr_serie_w = 'D') then
		ie_bloqueio_nr_serie_w := substr(obter_consiste_nf_mesmo_nr(cd_cgc_emitente_p, nm_usuario_p, cd_estabelecimento_p),1,1);
	end if;
	if (ie_bloqueio_nr_serie_w = 'P') then
		
		if (ie_tipo_nota_p = 'EF') then
			begin
			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_sequencia_w
			from	nota_fiscal
			where (ie_consiste_estab_w = 'N' or cd_estabelecimento = cd_estabelecimento_p)
			and	trunc(dt_emissao,'yyyy') = trunc(dt_emissao_p,'yyyy')
			and	cd_pessoa_fisica = cd_pessoa_fisica_p
			and	cd_serie_nf = cd_serie_nf_p
			and	nr_nota_fiscal = nr_nota_fiscal_p
			and	ie_situacao = ie_situacao_p	
			and 	nr_sequencia <> nr_seq_nota_p
			and	((dt_atualizacao_estoque IS NOT NULL AND dt_atualizacao_estoque::text <> '' AND ie_calculado_p = 'S') or (ie_calculado_p = 'N'));
			end;
		else
			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_sequencia_w
			from	nota_fiscal
			where (ie_consiste_estab_w = 'N' or cd_estabelecimento = cd_estabelecimento_p)
			and	trunc(dt_emissao,'yyyy') = trunc(dt_emissao_p,'yyyy')
			and	cd_cgc_emitente = cd_cgc_emitente_p
			and	cd_serie_nf = cd_serie_nf_p
			and	nr_nota_fiscal = nr_nota_fiscal_p
			and	ie_situacao = ie_situacao_p
			and 	nr_sequencia <> nr_seq_nota_p
			and	((dt_atualizacao_estoque IS NOT NULL AND dt_atualizacao_estoque::text <> '' AND ie_calculado_p = 'S') or (ie_calculado_p = 'N'));
		end if;
		
		
	elsif (ie_bloqueio_nr_serie_w = 'S') then
	
		if (ie_tipo_nota_p = 'EF') then
			begin
			
			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_sequencia_w
			from	nota_fiscal
			where (ie_consiste_estab_w = 'N' or cd_estabelecimento = cd_estabelecimento_p)
			and	cd_pessoa_fisica = cd_pessoa_fisica_p
			and	cd_serie_nf = cd_serie_nf_p
			and	nr_nota_fiscal = nr_nota_fiscal_p
			and	ie_situacao = ie_situacao_p
			and 	nr_sequencia <> nr_seq_nota_p
			and	((dt_atualizacao_estoque IS NOT NULL AND dt_atualizacao_estoque::text <> '' AND ie_calculado_p = 'S') or (ie_calculado_p = 'N'));
			
			end;
		else
			
			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_sequencia_w
			from	nota_fiscal
			where (ie_consiste_estab_w = 'N' or cd_estabelecimento = cd_estabelecimento_p)
			and	cd_cgc_emitente = cd_cgc_emitente_p
			and	cd_serie_nf = cd_serie_nf_p
			and	nr_nota_fiscal = nr_nota_fiscal_p
			and	ie_situacao = ie_situacao_p
			and 	nr_sequencia <> nr_seq_nota_p
			and	((dt_atualizacao_estoque IS NOT NULL AND dt_atualizacao_estoque::text <> '' AND ie_calculado_p = 'S') or (ie_calculado_p = 'N'))  LIMIT 1;
			
		end if;

	end if;
	
	if (coalesce(nr_sequencia_w::text, '') = '') then
		begin
		ie_bloqueio_nr_w	:= substr(coalesce(obter_valor_param_usuario(40, 183, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p),'S'),1,1);
		
		if (ie_bloqueio_nr_w = 'S') then
			
			if (ie_tipo_nota_p = 'EF') then
				begin
				select	coalesce(max(nr_sequencia),0)
				into STRICT	nr_sequencia_w
				from	nota_fiscal
				where (ie_consiste_estab_w = 'N' or cd_estabelecimento = cd_estabelecimento_p)
				and	cd_pessoa_fisica = cd_pessoa_fisica_p
				and	nr_nota_fiscal = nr_nota_fiscal_p
				and	ie_situacao = ie_situacao_p
				and 	nr_sequencia <> nr_seq_nota_p
				and	((dt_atualizacao_estoque IS NOT NULL AND dt_atualizacao_estoque::text <> '' AND ie_calculado_p = 'S') or (ie_calculado_p = 'N'));
				end;
			else
				select	coalesce(max(nr_sequencia),0)
				into STRICT	nr_sequencia_w
				from	nota_fiscal
				where (ie_consiste_estab_w = 'N' or cd_estabelecimento = cd_estabelecimento_p)
				and	cd_cgc_emitente = cd_cgc_emitente_p
				and	nr_nota_fiscal = nr_nota_fiscal_p
				and	ie_situacao = ie_situacao_p
				and 	nr_sequencia <> nr_seq_nota_p
				and	((dt_atualizacao_estoque IS NOT NULL AND dt_atualizacao_estoque::text <> '' AND ie_calculado_p = 'S') or (ie_calculado_p = 'N'));
			end if;
			
		elsif (ie_bloqueio_nr_w = 'P') then
			if (ie_tipo_nota_p = 'EF')  then
				begin
				select	coalesce(max(nr_sequencia),0)
				into STRICT	nr_sequencia_w
				from	nota_fiscal
				where (ie_consiste_estab_w = 'N' or cd_estabelecimento = cd_estabelecimento_p)
				and	trunc(dt_emissao,'yyyy') = trunc(dt_emissao_p,'yyyy')
				and	cd_pessoa_fisica = cd_pessoa_fisica_p
				and	nr_nota_fiscal = nr_nota_fiscal_p
				and	ie_situacao = ie_situacao_p
				and 	nr_sequencia <> nr_seq_nota_p				
				and	((dt_atualizacao_estoque IS NOT NULL AND dt_atualizacao_estoque::text <> '' AND ie_calculado_p = 'S') or (ie_calculado_p = 'N'));
				end;
			else
				select	coalesce(max(nr_sequencia),0)
				into STRICT	nr_sequencia_w
				from	nota_fiscal
				where (ie_consiste_estab_w = 'N' or cd_estabelecimento = cd_estabelecimento_p)
				and	trunc(dt_emissao,'yyyy') = trunc(dt_emissao_p,'yyyy')
				and	cd_cgc_emitente = cd_cgc_emitente_p
				and	nr_nota_fiscal = nr_nota_fiscal_p
				and	ie_situacao = ie_situacao_p
				and 	nr_sequencia <> nr_seq_nota_p
				and	((dt_atualizacao_estoque IS NOT NULL AND dt_atualizacao_estoque::text <> '' AND ie_calculado_p = 'S') or (ie_calculado_p = 'N'));
			end if;
			

		end if;
		end;
	end if;
	
end if;

return	nr_sequencia_w;

end;


begin

update	intpd_fila_transmissao
set	ie_status = 'R'
where	nr_sequencia = nr_sequencia_p;

commit;

begin
select	coalesce(b.ie_conversao,'I'),
	nr_seq_sistema,
	nr_seq_projeto_xml,
	nr_seq_regra_conv
into STRICT	ie_conversao_w,
	nr_seq_sistema_w,
	nr_seq_projeto_xml_w,
	nr_seq_regra_w
from	intpd_fila_transmissao a,
	intpd_eventos_sistema b
where	a.nr_seq_evento_sistema = b.nr_sequencia
and	a.nr_sequencia = nr_sequencia_p;

ie_sistema_externo_w	:=	nr_seq_sistema_w;

reg_integracao_w.nr_seq_fila_transmissao	:=	nr_sequencia_p;
reg_integracao_w.ie_envio_recebe		:=	'R';
reg_integracao_w.ie_sistema_externo		:=	ie_sistema_externo_w;
reg_integracao_w.ie_conversao			:=	ie_conversao_w;
reg_integracao_w.nr_seq_projeto_xml		:=	nr_seq_projeto_xml_w;
reg_integracao_w.nr_seq_regra_conversao		:=	nr_seq_regra_w;
reg_integracao_w.intpd_log_receb.delete;
reg_integracao_w.qt_reg_log			:=	0;

open c01;
loop
fetch c01 into	
	c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin	

	reg_integracao_w.nm_tabela		:=	'NOTA_FISCAL';
	reg_integracao_w.nm_elemento		:=	'INVOICE';
	reg_integracao_w.nr_seq_visao		:=	0;
	
	ds_action := c01_w.ie_action;
	
	if (coalesce(c01_w.ie_action,'INSERT') = 'INSERT') THEN
	
		select	nextval('nota_fiscal_seq')
		into STRICT	nr_sequencia_w
		;
		
		if (nr_sequencia_w > 0) then
		
			nota_fiscal_w.nr_sequencia := nr_sequencia_w;
			
		end if;
	
		
		ds_campo_w := 'NR_NOTA_FISCAL';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_NOTA_FISCAL', pls_elimina_zeros_esquerda(c01_w.NR_NOTA_FISCAL), 'N', nota_fiscal_w.NR_NOTA_FISCAL) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.NR_NOTA_FISCAL := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'CD_OPERACAO_NF';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_OPERACAO_NF', c01_w.CD_OPERACAO_NF, 'N', nota_fiscal_w.CD_OPERACAO_NF) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.CD_OPERACAO_NF := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'IE_TIPO_NOTA';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_TIPO_NOTA', c01_w.IE_TIPO_NOTA, 'N', nota_fiscal_w.IE_TIPO_NOTA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.IE_TIPO_NOTA := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'DT_EMISSAO';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_EMISSAO', c01_w.DT_EMISSAO, 'N', nota_fiscal_w.DT_EMISSAO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.DT_EMISSAO := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'DT_ENTRADA_SAIDA';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_ENTRADA_SAIDA', c01_w.DT_ENTRADA_SAIDA, 'N', nota_fiscal_w.DT_ENTRADA_SAIDA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.DT_ENTRADA_SAIDA := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'CD_NATUREZA_OPERACAO';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_NATUREZA_OPERACAO', c01_w.CD_NATUREZA_OPERACAO, 'N', nota_fiscal_w.CD_NATUREZA_OPERACAO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.CD_NATUREZA_OPERACAO := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'IE_SITUACAO';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_SITUACAO', c01_w.IE_SITUACAO, 'N', nota_fiscal_w.IE_SITUACAO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.IE_SITUACAO := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'CD_SERIE_NF';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_SERIE_NF', c01_w.CD_SERIE_NF, 'N', nota_fiscal_w.CD_SERIE_NF) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.CD_SERIE_NF := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'CD_CONDICAO_PAGAMENTO';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CONDICAO_PAGAMENTO', c01_w.CD_CONDICAO_PAGAMENTO, 'N', nota_fiscal_w.CD_CONDICAO_PAGAMENTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.CD_CONDICAO_PAGAMENTO := _ora2pg_r.ds_valor_retorno_p;	
		ds_campo_w := 'CD_CGC_EMITENTE';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CGC_EMITENTE', c01_w.CD_CGC_EMITENTE, 'N', nota_fiscal_w.CD_CGC_EMITENTE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.CD_CGC_EMITENTE := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'NR_ORDEM_COMPRA';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_ORDEM_COMPRA', c01_w.NR_ORDEM_COMPRA, 'N', nota_fiscal_w.NR_ORDEM_COMPRA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.NR_ORDEM_COMPRA := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'NR_CONTA';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_CONTA', c01_w.NR_CONTA, 'N', nota_fiscal_w.NR_CONTA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.NR_CONTA := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'NR_SEQ_PROTOCOLO';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_PROTOCOLO', c01_w.NR_SEQ_PROTOCOLO, 'N', nota_fiscal_w.NR_SEQ_PROTOCOLO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.NR_SEQ_PROTOCOLO := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'NR_LOTE_CONTABIL';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_LOTE_CONTABIL', c01_w.NR_LOTE_CONTABIL, 'N', nota_fiscal_w.NR_LOTE_CONTABIL) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.NR_LOTE_CONTABIL := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'NR_SEQ_CLASSIF_FISCAL';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_CLASSIF_FISCAL', c01_w.NR_SEQ_CLASSIF_FISCAL, 'N', nota_fiscal_w.NR_SEQ_CLASSIF_FISCAL) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.NR_SEQ_CLASSIF_FISCAL := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'CD_CONV_INTEGRACAO';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CONV_INTEGRACAO', c01_w.CD_CONV_INTEGRACAO, 'N', nota_fiscal_w.CD_CONV_INTEGRACAO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.CD_CONV_INTEGRACAO := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'NR_NFE_IMP';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_NFE_IMP', c01_w.NR_NFE_IMP, 'N', nota_fiscal_w.NR_NFE_IMP) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.NR_NFE_IMP := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'IE_STATUS_ENVIO';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_STATUS_ENVIO', c01_w.IE_STATUS_ENVIO, 'N', nota_fiscal_w.IE_STATUS_ENVIO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.IE_STATUS_ENVIO := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'DS_OBSERVACAO';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_OBSERVACAO', SUBSTR(c01_w.DS_OBSERVACAO, 1, 255), 'N', nota_fiscal_w.DS_OBSERVACAO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.DS_OBSERVACAO := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'CD_PESSOA_FISICA';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_PESSOA_FISICA', c01_w.CD_PESSOA_FISICA, 'N', nota_fiscal_w.CD_PESSOA_FISICA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.CD_PESSOA_FISICA := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'CD_CGC';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CGC', c01_w.CD_CGC, 'N', nota_fiscal_w.CD_CGC) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.CD_CGC := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'VL_DESCONTOS';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_DESCONTOS', replace(c01_w.VL_DESCONTOS, ',', '.'), 'N', nota_fiscal_w.VL_DESCONTOS) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.VL_DESCONTOS := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'VL_MERCADORIA';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_MERCADORIA', replace(c01_w.VL_MERCADORIA, ',', '.'), 'N', nota_fiscal_w.VL_MERCADORIA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.VL_MERCADORIA := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'VL_TOTAL_NOTA';		
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_TOTAL_NOTA', replace(c01_w.VL_TOTAL_NOTA, ',', '.'), 'N', nota_fiscal_w.VL_TOTAL_NOTA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.VL_TOTAL_NOTA := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'VL_DESPESA_ACESSORIA';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_DESPESA_ACESSORIA', replace(c01_w.VL_DESPESA_ACESSORIA, ',', '.'), 'N', nota_fiscal_w.VL_DESPESA_ACESSORIA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.VL_DESPESA_ACESSORIA := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'VL_SEGURO';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_SEGURO', replace(c01_w.VL_SEGURO, ',', '.'), 'N', nota_fiscal_w.VL_SEGURO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.VL_SEGURO := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'CD_ESTABELECIMENTO';		
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_ESTABELECIMENTO', c01_w.CD_ESTABELECIMENTO, 'N', nota_fiscal_w.CD_ESTABELECIMENTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.CD_ESTABELECIMENTO := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'CD_VERIFICACAO_NFSE';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_VERIFICACAO_NFSE', c01_w.CD_VERIFICACAO_NFSE, 'N', nota_fiscal_w.CD_VERIFICACAO_NFSE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.CD_VERIFICACAO_NFSE := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := 'NR_NF_EXTERNO';
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_NF_EXTERNO', c01_w.NR_NF_EXTERNO, 'N', nota_fiscal_w.NR_NF_EXTERNO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_w.NR_NF_EXTERNO := _ora2pg_r.ds_valor_retorno_p;
		ds_campo_w := '';

		nota_fiscal_w.nm_usuario		:= 'INTEGRACAO';
		nota_fiscal_w.dt_atualizacao		:= clock_timestamp();
	        nota_fiscal_w.ie_sistema_origem         := 'INTEGRACAO';
		nota_fiscal_w.ie_acao_nf		:= 1;
		nota_fiscal_w.ie_emissao_nf		:= 0;
		nota_fiscal_w.ie_tipo_frete		:= 0;
		nota_fiscal_w.qt_peso_bruto		:= 0;
		nota_fiscal_w.qt_peso_liquido		:= 0;
		
		if (coalesce(c01_w.IE_SITUACAO::text, '') = '') then
			nota_fiscal_w.IE_SITUACAO	:= 1;
		end if;

                if (nota_fiscal_w.ie_tipo_nota in ('SD','SE','SF','ST')) then

                     nota_fiscal_w.nr_nota_fiscal := nota_fiscal_w.nr_sequencia + 800000;

                end if;		
				
		select	coalesce(max(nr_sequencia_nf),0) + 1	
		into STRICT	nota_fiscal_w.nr_sequencia_nf
		from	nota_fiscal
		where	cd_estabelecimento	= nota_fiscal_w.CD_ESTABELECIMENTO
		and	cd_serie_nf		= nota_fiscal_w.CD_SERIE_NF
		and	nr_nota_fiscal		= nota_fiscal_w.NR_NOTA_FISCAL;	
					
		insert into nota_fiscal values (nota_fiscal_w.*);
		ie_atualizou_w	:= 'S';

		if (ie_atualizou_w = 'S')	then
			update	intpd_fila_transmissao
			set	ie_status = 'S',
				nr_seq_documento = nota_fiscal_w.nr_sequencia
			where	nr_sequencia = nr_sequencia_p;
		end if;
		
	
	elsif (coalesce(c01_w.ie_action,'INSERT') = 'UPDATE') then		
		begin
		if (coalesce(c01_w.ie_situacao,'0') = '3') then
			CALL estornar_nota_fiscal(c01_w.nr_sequencia,'INTEGRACAO');
			
			update	intpd_fila_transmissao
			set	ie_status = 'S',
				nr_seq_documento = c01_w.nr_sequencia
			where	nr_sequencia = nr_sequencia_p;
			
		elsif (coalesce(c01_w.ie_situacao,'0') = '1') then
			if (c01_w.NR_NFE_IMP IS NOT NULL AND c01_w.NR_NFE_IMP::text <> '') then
				update 	nota_fiscal
				set	nr_nfe_imp = c01_w.NR_NFE_IMP
				where	nr_sequencia = c01_w.nr_sequencia;

			end if;
		end if;
		
		update	intpd_fila_transmissao
		set	ie_status = 'S',
			nr_seq_documento = c01_w.nr_sequencia
		where	nr_sequencia = nr_sequencia_p;
		
		end;
	else
		delete	FROM nota_fiscal
		where	nr_sequencia = c01_w.nr_sequencia;
		
		update	intpd_fila_transmissao
		set	ie_status = 'S',
			nr_seq_documento = c01_w.nr_sequencia
		where	nr_sequencia = nr_sequencia_p;
	end if;

	
	open c02;
	loop
	fetch c02 into	
		c02_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin

		reg_integracao_w.nm_tabela		:=	'NOTA_FISCAL_ITEM';
		reg_integracao_w.nm_elemento		:=	'ITEM';
		reg_integracao_w.nr_seq_visao		:=	0;
		
		nota_fiscal_item_w.nr_sequencia		:=	nota_fiscal_w.nr_sequencia;
		nota_fiscal_item_w.cd_estabelecimento	:= 	nota_fiscal_w.cd_estabelecimento;
	
		if (coalesce(ds_action,'INSERT') = 'INSERT') THEN
		
		        ds_campo_w := 'CD_MATERIAL';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_MATERIAL', c02_w.CD_MATERIAL, 'S', nota_fiscal_item_w.CD_MATERIAL) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.CD_MATERIAL := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'NR_ITEM_NF';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_ITEM_NF', c02_w.NR_ITEM_NF, 'N', nota_fiscal_item_w.NR_ITEM_NF) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.NR_ITEM_NF := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'NR_ATENDIMENTO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_ATENDIMENTO', c02_w.NR_ATENDIMENTO, 'N', nota_fiscal_item_w.NR_ATENDIMENTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.NR_ATENDIMENTO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'NR_ORDEM_COMPRA';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_ORDEM_COMPRA', c02_w.NR_ORDEM_COMPRA, 'N', nota_fiscal_item_w.NR_ORDEM_COMPRA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.NR_ORDEM_COMPRA := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'NR_ITEM_OCI';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_ITEM_OCI', c02_w.NR_ITEM_OCI, 'N', nota_fiscal_item_w.NR_ITEM_OCI) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.NR_ITEM_OCI := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'CD_PROCEDIMENTO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_PROCEDIMENTO', c02_w.CD_PROCEDIMENTO, 'N', nota_fiscal_item_w.CD_PROCEDIMENTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.CD_PROCEDIMENTO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'NR_SEQ_PROC_INTERNO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_PROC_INTERNO', c02_w.NR_SEQ_PROC_INTERNO, 'N', nota_fiscal_item_w.NR_SEQ_PROC_INTERNO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.NR_SEQ_PROC_INTERNO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'CD_IMOBILIZADO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_IMOBILIZADO', c02_w.CD_IMOBILIZADO, 'N', nota_fiscal_item_w.CD_IMOBILIZADO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.CD_IMOBILIZADO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'CD_IMOB_SERIE';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_IMOB_SERIE', c02_w.CD_IMOB_SERIE, 'N', nota_fiscal_item_w.CD_IMOB_SERIE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.CD_IMOB_SERIE := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'CD_UNIDADE_MEDIDA_COMPRA';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_UNIDADE_MEDIDA_COMPRA', c02_w.CD_UNIDADE_MEDIDA_COMPRA, 'N', nota_fiscal_item_w.CD_UNIDADE_MEDIDA_COMPRA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.CD_UNIDADE_MEDIDA_COMPRA := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'DT_ENTREGA_ORDEM';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_ENTREGA_ORDEM', c02_w.DT_ENTREGA_ORDEM, 'N', nota_fiscal_item_w.DT_ENTREGA_ORDEM) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.DT_ENTREGA_ORDEM := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'QT_ITEM_NF';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'QT_ITEM_NF', replace(c02_w.QT_ITEM_NF, ',', '.'), 'N', nota_fiscal_item_w.QT_ITEM_NF) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.QT_ITEM_NF := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'VL_UNITARIO_ITEM_NF';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_UNITARIO_ITEM_NF', replace(c02_w.VL_UNITARIO_ITEM_NF, ',', '.'), 'N', nota_fiscal_item_w.VL_UNITARIO_ITEM_NF) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.VL_UNITARIO_ITEM_NF := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'PR_DESCONTO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'PR_DESCONTO', replace(c02_w.PR_DESCONTO, ',', '.'), 'N', nota_fiscal_item_w.PR_DESCONTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.PR_DESCONTO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'VL_DESCONTO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_DESCONTO', replace(c02_w.VL_DESCONTO, ',', '.'), 'N', nota_fiscal_item_w.VL_DESCONTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.VL_DESCONTO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'VL_DESC_FINANC';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_DESC_FINANC', replace(c02_w.VL_DESC_FINANC, ',', '.'), 'N', nota_fiscal_item_w.VL_DESC_FINANC) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.VL_DESC_FINANC := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'VL_TOTAL_ITEM_NF';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_TOTAL_ITEM_NF', replace(c02_w.VL_TOTAL_ITEM_NF, ',', '.'), 'N', nota_fiscal_item_w.VL_TOTAL_ITEM_NF) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.VL_TOTAL_ITEM_NF := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'CD_UNIDADE_MEDIDA_ESTOQUE';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_UNIDADE_MEDIDA_ESTOQUE', c02_w.CD_UNIDADE_MEDIDA_ESTOQUE, 'N', nota_fiscal_item_w.CD_UNIDADE_MEDIDA_ESTOQUE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.CD_UNIDADE_MEDIDA_ESTOQUE := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'QT_ITEM_ESTOQUE';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'QT_ITEM_ESTOQUE', replace(c02_w.QT_ITEM_ESTOQUE, ',', '.'), 'N', nota_fiscal_item_w.QT_ITEM_ESTOQUE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.QT_ITEM_ESTOQUE := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'VL_LIQUIDO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_LIQUIDO', replace(c02_w.VL_LIQUIDO, ',', '.'), 'N', nota_fiscal_item_w.VL_LIQUIDO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.VL_LIQUIDO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'CD_LOCAL_ESTOQUE';			
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_LOCAL_ESTOQUE', c02_w.CD_LOCAL_ESTOQUE, 'N', nota_fiscal_item_w.CD_LOCAL_ESTOQUE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.CD_LOCAL_ESTOQUE := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'CD_CONTA_CONTABIL';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CONTA_CONTABIL', c02_w.CD_CONTA_CONTABIL, 'N', nota_fiscal_item_w.CD_CONTA_CONTABIL) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.CD_CONTA_CONTABIL := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'CD_NATUREZA_OPERACAO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_NATUREZA_OPERACAO', c02_w.CD_NATUREZA_OPERACAO, 'N', nota_fiscal_item_w.CD_NATUREZA_OPERACAO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.CD_NATUREZA_OPERACAO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'CD_CENTRO_CUSTO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CENTRO_CUSTO', c02_w.CD_CENTRO_CUSTO, 'N', nota_fiscal_item_w.CD_CENTRO_CUSTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.CD_CENTRO_CUSTO := _ora2pg_r.ds_valor_retorno_p;	
			ds_campo_w := 'NR_CONTRATO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_CONTRATO', c02_w.NR_CONTRATO, 'N', nota_fiscal_item_w.NR_CONTRATO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.NR_CONTRATO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'NR_SEQ_CONTA_FINANC';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_CONTA_FINANC', c02_w.NR_SEQ_CONTA_FINANC, 'N', nota_fiscal_item_w.NR_SEQ_CONTA_FINANC) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.NR_SEQ_CONTA_FINANC := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'NR_SEQ_PROJ_REC';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_PROJ_REC', c02_w.NR_SEQ_PROJ_REC, 'N', nota_fiscal_item_w.NR_SEQ_PROJ_REC) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.NR_SEQ_PROJ_REC := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'DS_OBSERVACAO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_OBSERVACAO', SUBSTR(c02_w.DS_OBSERVACAO, 1, 255), 'N', nota_fiscal_item_w.DS_OBSERVACAO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.DS_OBSERVACAO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'DS_COMPLEMENTO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_COMPLEMENTO', c02_w.DS_COMPLEMENTO, 'N', nota_fiscal_item_w.DS_COMPLEMENTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.DS_COMPLEMENTO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'CD_LOTE_FABRICACAO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_LOTE_FABRICACAO', c02_w.CD_LOTE_FABRICACAO, 'N', nota_fiscal_item_w.CD_LOTE_FABRICACAO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.CD_LOTE_FABRICACAO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'DT_VALIDADE';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_VALIDADE', c02_w.DT_VALIDADE, 'N', nota_fiscal_item_w.DT_VALIDADE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.DT_VALIDADE := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'DS_JUSTIFICATIVA';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_JUSTIFICATIVA', c02_w.DS_JUSTIFICATIVA, 'N', nota_fiscal_item_w.DS_JUSTIFICATIVA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.DS_JUSTIFICATIVA := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'DT_FABRICACAO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_FABRICACAO', c02_w.DT_FABRICACAO, 'N', nota_fiscal_item_w.DT_FABRICACAO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.DT_FABRICACAO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'IE_INDETERMINADO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_INDETERMINADO', c02_w.IE_INDETERMINADO, 'N', nota_fiscal_item_w.IE_INDETERMINADO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.IE_INDETERMINADO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'NR_SEQ_MARCA';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_MARCA', c02_w.NR_SEQ_MARCA, 'N', nota_fiscal_item_w.NR_SEQ_MARCA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.NR_SEQ_MARCA := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'DT_INICIO_GARANTIA';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_INICIO_GARANTIA', c02_w.DT_INICIO_GARANTIA, 'N', nota_fiscal_item_w.DT_INICIO_GARANTIA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.DT_INICIO_GARANTIA := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'DT_FIM_GARANTIA';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_FIM_GARANTIA', c02_w.DT_FIM_GARANTIA, 'N', nota_fiscal_item_w.DT_FIM_GARANTIA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.DT_FIM_GARANTIA := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'NR_SERIE_MATERIAL';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SERIE_MATERIAL', c02_w.NR_SERIE_MATERIAL, 'N', nota_fiscal_item_w.NR_SERIE_MATERIAL) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.NR_SERIE_MATERIAL := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'CD_PACIENTE';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_PACIENTE', c02_w.CD_PACIENTE, 'N', nota_fiscal_item_w.CD_PACIENTE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.CD_PACIENTE := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'NR_SEQ_MODELO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_MODELO', c02_w.NR_SEQ_MODELO, 'N', nota_fiscal_item_w.NR_SEQ_MODELO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.NR_SEQ_MODELO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'NR_SEQ_CLASSIF_TRIB';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_CLASSIF_TRIB', c02_w.NR_SEQ_CLASSIF_TRIB, 'N', nota_fiscal_item_w.NR_SEQ_CLASSIF_TRIB) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.NR_SEQ_CLASSIF_TRIB := _ora2pg_r.ds_valor_retorno_p;			
			ds_campo_w := 'VL_FRETE';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_FRETE', replace(c02_w.VL_FRETE, ',', '.'), 'N', nota_fiscal_item_w.VL_FRETE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.VL_FRETE := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'VL_DESPESA_ACESSORIA';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_DESPESA_ACESSORIA', replace(c02_w.VL_DESPESA_ACESSORIA, ',', '.'), 'N', nota_fiscal_item_w.VL_DESPESA_ACESSORIA) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.VL_DESPESA_ACESSORIA := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'VL_DESCONTO_RATEIO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_DESCONTO_RATEIO', replace(c02_w.VL_DESCONTO_RATEIO, ',', '.'), 'N', nota_fiscal_item_w.VL_DESCONTO_RATEIO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.VL_DESCONTO_RATEIO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'VL_SEGURO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_SEGURO', replace(c02_w.VL_SEGURO, ',', '.'), 'N', nota_fiscal_item_w.VL_SEGURO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.VL_SEGURO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'DS_BARRAS';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_BARRAS', c02_w.DS_BARRAS, 'N', nota_fiscal_item_w.DS_BARRAS) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_w.DS_BARRAS := _ora2pg_r.ds_valor_retorno_p;
				
			ds_campo_w := '';
			
			if (coalesce(nota_fiscal_item_w.vl_liquido, 0) = 0) then
				nota_fiscal_item_w.vl_liquido:= nota_fiscal_item_w.vl_total_item_nf - nota_fiscal_item_w.vl_desconto;
			end if;
			
			nota_fiscal_item_w.nm_usuario		:= 'INTEGRACAO';
			nota_fiscal_item_w.dt_atualizacao	:= clock_timestamp();
			nota_fiscal_item_w.cd_serie_nf          := nota_fiscal_w.cd_serie_nf;
			nota_fiscal_item_w.nr_sequencia_nf      := nota_fiscal_w.nr_sequencia_nf;
			nota_fiscal_item_w.nr_nota_fiscal	:= nota_fiscal_w.nr_nota_fiscal;
			nota_fiscal_item_w.cd_cgc_emitente	:= nota_fiscal_w.cd_cgc_emitente;
			
			begin
				select	coalesce(ie_devolucao, 'N')
				into STRICT	ie_devolucao_w
				from	operacao_nota
				where	cd_operacao_nf = nota_fiscal_w.cd_operacao_nf;
			exception
			when others then
				ie_devolucao_w:= 'N';	
			end;
			
			nr_seq_lote_fornec_w := null;

			if ((coalesce(c02_w.nr_seq_nota_devolucao,'XX') <> 'XX' and coalesce(c02_w.nr_seq_nota_devolucao,'xx') > 0) and (ie_devolucao_w = 'S')) then
				
				select	coalesce(max(nr_seq_lote_fornec),0)
				into STRICT	nr_seq_lote_fornec_w
				from	nota_fiscal_item a,
					material_lote_fornec b
				where	a.nr_sequencia 	= 	c02_w.nr_seq_nota_devolucao
				and	a.nr_item_nf 	=	nota_fiscal_item_w.nr_item_nf
				and	b.nr_sequencia 	= 	a.nr_seq_lote_fornec;
				
				if (nr_seq_lote_fornec_w = 0) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(1099885);
				end if;

			end if;

			insert into nota_fiscal_item values (nota_fiscal_item_w.*);
			
			if ((coalesce(nota_fiscal_item_w.ds_barras, 'XX') <> 'XX') or (ie_devolucao_w = 'S')) then
				begin
				select	nextval('nota_fiscal_item_lote_seq')
				into STRICT	nr_sequencia_w
				;
				
				nota_fiscal_item_lote_w.nr_sequencia		:= nr_sequencia_w;
				nota_fiscal_item_lote_w.nr_item_nf		:= nota_fiscal_item_w.nr_item_nf;
				nota_fiscal_item_lote_w.nr_seq_nota		:= nota_fiscal_w.nr_sequencia;
				nota_fiscal_item_lote_w.qt_material		:= nota_fiscal_item_w.qt_item_nf;
				nota_fiscal_item_lote_w.ds_barras		:= nota_fiscal_item_w.ds_barras;
				nota_fiscal_item_lote_w.cd_lote_fabricacao	:= nota_fiscal_item_w.cd_lote_fabricacao;
				nota_fiscal_item_lote_w.dt_atualizacao		:= clock_timestamp();
				nota_fiscal_item_lote_w.nm_usuario		:= 'INTEGRACAO';
				
				if (coalesce(nr_seq_lote_fornec_w,0) > 0) then
					nota_fiscal_item_lote_w.nr_seq_lote_fornec := nr_seq_lote_fornec_w;
				end if;
				
				insert into nota_fiscal_item_lote values (nota_fiscal_item_lote_w.*);
				end;
			end if;
					
			
		elsif (coalesce(c01_w.ie_action,'INSERT') = 'DELETE') then
		
			delete	FROM nota_fiscal_item_lote
			where	nr_seq_nota	= nota_fiscal_item_w.nr_sequencia
			and 	nr_item_nf	= nota_fiscal_item_w.nr_item_nf;
		
		
			delete	FROM nota_fiscal_item
			where	nr_item_nf = nota_fiscal_item_w.nr_item_nf
			and	cd_material = nota_fiscal_item_w.cd_material
			and	nr_sequencia = nota_fiscal_item_w.nr_sequencia;
		end if;
		
		open c03;
		loop
		fetch c03 into	
			c03_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
			begin
			reg_integracao_w.nm_tabela		:=	'NOTA_FISCAL_ITEM_TRIB';
			reg_integracao_w.nm_elemento		:=	'TRIBUTES_ITEM';
			reg_integracao_w.nr_seq_visao		:=	0;
			
			nota_fiscal_item_trib_w.nr_sequencia		:=	nota_fiscal_w.nr_sequencia;			
			nota_fiscal_item_trib_w.nr_item_nf		:=	nota_fiscal_item_w.nr_item_nf;
			
			if (coalesce(ds_action,'INSERT') = 'INSERT') THEN
				ds_campo_w := 'CD_TRIBUTO';
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_TRIBUTO', c03_w.CD_TRIBUTO, 'N', nota_fiscal_item_trib_w.CD_TRIBUTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_trib_w.CD_TRIBUTO := _ora2pg_r.ds_valor_retorno_p;
				ds_campo_w := 'VL_BASE_CALCULO';
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_BASE_CALCULO', replace(c03_w.VL_BASE_CALCULO, ',', '.'), 'N', nota_fiscal_item_trib_w.VL_BASE_CALCULO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_trib_w.VL_BASE_CALCULO := _ora2pg_r.ds_valor_retorno_p;
				ds_campo_w := 'VL_REDUCAO_BASE';
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_REDUCAO_BASE', replace(c03_w.VL_REDUCAO_BASE, ',', '.'), 'N', nota_fiscal_item_trib_w.VL_REDUCAO_BASE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_trib_w.VL_REDUCAO_BASE := _ora2pg_r.ds_valor_retorno_p;
				ds_campo_w := 'TX_TRIBUTO';
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'TX_TRIBUTO', replace(c03_w.TX_TRIBUTO, ',', '.'), 'N', nota_fiscal_item_trib_w.TX_TRIBUTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_trib_w.TX_TRIBUTO := _ora2pg_r.ds_valor_retorno_p;
				ds_campo_w := 'VL_TRIBUTO';
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_TRIBUTO', replace(c03_w.VL_TRIBUTO, ',', '.'), 'N', nota_fiscal_item_trib_w.VL_TRIBUTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_trib_w.VL_TRIBUTO := _ora2pg_r.ds_valor_retorno_p;
				ds_campo_w := 'NR_SEQ_SIT_TRIB';
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_SIT_TRIB', c03_w.NR_SEQ_SIT_TRIB, 'N', nota_fiscal_item_trib_w.NR_SEQ_SIT_TRIB) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_trib_w.NR_SEQ_SIT_TRIB := _ora2pg_r.ds_valor_retorno_p;
				ds_campo_w := 'IE_TRIBUTACAO_CST';
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_TRIBUTACAO_CST', c03_w.IE_TRIBUTACAO_CST, 'N', nota_fiscal_item_trib_w.IE_TRIBUTACAO_CST) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_trib_w.IE_TRIBUTACAO_CST := _ora2pg_r.ds_valor_retorno_p;
				ds_campo_w := 'IE_TRIBUTACAO_CSOSN';
				SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_TRIBUTACAO_CSOSN', c03_w.IE_TRIBUTACAO_CSOSN, 'N', nota_fiscal_item_trib_w.IE_TRIBUTACAO_CSOSN) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_item_trib_w.IE_TRIBUTACAO_CSOSN := _ora2pg_r.ds_valor_retorno_p;
				ds_campo_w := '';

				nota_fiscal_item_trib_w.nm_usuario	:= 'INTEGRACAO';
				nota_fiscal_item_trib_w.dt_atualizacao	:= clock_timestamp();			
				
				if (nota_fiscal_item_trib_w.cd_tributo IS NOT NULL AND nota_fiscal_item_trib_w.cd_tributo::text <> '') then
					begin
					/*'Busca o registro atual do Tasy pela PK'*/

						select	*
						into STRICT	nota_fiscal_item_trib_w
						from	nota_fiscal_item_trib
						where	cd_tributo = nota_fiscal_item_trib_w.cd_tributo
						and	nr_sequencia = nota_fiscal_item_trib_w.nr_sequencia;
					exception
					when others then
						nota_fiscal_item_trib_w.nr_sequencia	:=	null;
					end;
				end if;
				
				if (reg_integracao_w.qt_reg_log = 0) then
					begin
					if (nota_fiscal_item_trib_w.cd_tributo IS NOT NULL AND nota_fiscal_item_trib_w.cd_tributo::text <> '') then
						begin
							update	nota_fiscal_item_trib
							set	row = nota_fiscal_item_trib_w
							where	cd_tributo = nota_fiscal_item_trib_w.cd_tributo
							and	nr_sequencia = nota_fiscal_item_trib_w.nr_sequencia;
						end;
					else
													
						
						insert into nota_fiscal_item_trib values (nota_fiscal_item_trib_w.*);
						
					end if;
					ie_atualizou_w	:= 'S';
					end;
					
				end if;
				
			else
				delete	FROM nota_fiscal_item_trib
				where	cd_tributo = nota_fiscal_item_trib_w.cd_tributo
				and	nr_sequencia = nota_fiscal_item_trib_w.nr_sequencia;
			end if;
			end;
		end loop;
		close c03;	
		
		end;

		nota_fiscal_item_w := null;
		
	end loop;
	close c02;
	
	
	
	open c04;
	loop
	fetch c04 into	
		c04_w;
	EXIT WHEN NOT FOUND; /* apply on c04 */
		begin
		reg_integracao_w.nm_tabela		:=	'NOTA_FISCAL_TRIB';
		reg_integracao_w.nm_elemento		:=	'TRIBUTES';
		reg_integracao_w.nr_seq_visao		:=	0;
		
		nota_fiscal_trib_w.nr_sequencia		:=	nota_fiscal_w.nr_sequencia;
		

		
		if (coalesce(ds_action,'INSERT') = 'INSERT') THEN	
			ds_campo_w := 'CD_TRIBUTO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_TRIBUTO', c04_w.CD_TRIBUTO, 'N', nota_fiscal_trib_w.CD_TRIBUTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_trib_w.CD_TRIBUTO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'VL_BASE_CALCULO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_BASE_CALCULO', replace(c04_w.VL_BASE_CALCULO, ',', '.'), 'N', nota_fiscal_trib_w.VL_BASE_CALCULO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_trib_w.VL_BASE_CALCULO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'VL_REDUCAO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_REDUCAO', replace(c04_w.VL_REDUCAO, ',', '.'), 'N', nota_fiscal_trib_w.VL_REDUCAO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_trib_w.VL_REDUCAO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'VL_REDUCAO_BASE';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_REDUCAO_BASE', replace(c04_w.VL_REDUCAO_BASE, ',', '.'), 'N', nota_fiscal_trib_w.VL_REDUCAO_BASE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_trib_w.VL_REDUCAO_BASE := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'TX_TRIBUTO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'TX_TRIBUTO', replace(c04_w.TX_TRIBUTO, ',', '.'), 'N', nota_fiscal_trib_w.TX_TRIBUTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_trib_w.TX_TRIBUTO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'VL_TRIBUTO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_TRIBUTO', replace(c04_w.VL_TRIBUTO, ',', '.'), 'N', nota_fiscal_trib_w.VL_TRIBUTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_trib_w.VL_TRIBUTO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'VL_BASE_NAO_RETIDO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_BASE_NAO_RETIDO', replace(c04_w.VL_BASE_NAO_RETIDO, ',', '.'), 'N', nota_fiscal_trib_w.VL_BASE_NAO_RETIDO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_trib_w.VL_BASE_NAO_RETIDO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'VL_BASE_ADIC';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_BASE_ADIC', replace(c04_w.VL_BASE_ADIC, ',', '.'), 'N', nota_fiscal_trib_w.VL_BASE_ADIC) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_trib_w.VL_BASE_ADIC := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'VL_TRIB_NAO_RETIDO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_TRIB_NAO_RETIDO', replace(c04_w.VL_TRIB_NAO_RETIDO, ',', '.'), 'N', nota_fiscal_trib_w.VL_TRIB_NAO_RETIDO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_trib_w.VL_TRIB_NAO_RETIDO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'VL_TRIB_ADIC';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_TRIB_ADIC', replace(c04_w.VL_TRIB_ADIC, ',', '.'), 'N', nota_fiscal_trib_w.VL_TRIB_ADIC) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_trib_w.VL_TRIB_ADIC := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'VL_BC_MATRIZ_FILIAL';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_BC_MATRIZ_FILIAL', replace(c04_w.VL_BC_MATRIZ_FILIAL, ',', '.'), 'N', nota_fiscal_trib_w.VL_BC_MATRIZ_FILIAL) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_trib_w.VL_BC_MATRIZ_FILIAL := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'IE_RETENCAO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_RETENCAO', c04_w.IE_RETENCAO, 'N', nota_fiscal_trib_w.IE_RETENCAO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_trib_w.IE_RETENCAO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := '';
			
			nota_fiscal_trib_w.nm_usuario	:= 'INTEGRACAO';
			nota_fiscal_trib_w.dt_atualizacao	:= clock_timestamp();

			if (nota_fiscal_trib_w.cd_tributo IS NOT NULL AND nota_fiscal_trib_w.cd_tributo::text <> '') then
				begin
				/*'Busca o registro atual do Tasy pela PK'*/

					select	*
					into STRICT	nota_fiscal_trib_w
					from	nota_fiscal_trib
					where	cd_tributo = nota_fiscal_trib_w.cd_tributo
					and	nr_sequencia = nota_fiscal_trib_w.nr_sequencia;
				exception
				when others then
					nota_fiscal_trib_w.nr_sequencia	:=	null;
				end;
			end if;
			
			if (reg_integracao_w.qt_reg_log = 0) then
				begin
				if (nota_fiscal_trib_w.cd_tributo IS NOT NULL AND nota_fiscal_trib_w.cd_tributo::text <> '') then
					begin
						update	nota_fiscal_trib
						set	row = nota_fiscal_trib_w
						where	cd_tributo = nota_fiscal_trib_w.cd_tributo
						and	nr_sequencia = nota_fiscal_trib_w.nr_sequencia;
					end;
				else
					
										
					select 	max(coalesce(nr_seq_interno,0))+1
					into STRICT    nota_fiscal_trib_w.nr_seq_interno
					from 	nota_fiscal_trib
					where 	nr_sequencia = nota_fiscal_trib_w.nr_sequencia;
					

					insert into nota_fiscal_trib values (nota_fiscal_trib_w.*);
					
				end if;
				ie_atualizou_w	:= 'S';
				end;
				
			end if;
			
		else
			delete	FROM nota_fiscal_trib
			where	cd_tributo = nota_fiscal_trib_w.cd_tributo
			and	nr_sequencia = nota_fiscal_trib_w.nr_sequencia;
		end if;

		end;
	end loop;
	close c04;
	
	open c05;
	loop
	fetch c05 into	
		c05_w;
	EXIT WHEN NOT FOUND; /* apply on c05 */
		begin
		reg_integracao_w.nm_tabela		:=	'NOTA_FISCAL_TRANSPORTADORA';
		reg_integracao_w.nm_elemento		:=	'FREIGHT';
		reg_integracao_w.nr_seq_visao		:=	0;
		
		nota_fiscal_transportadora_w.nr_seq_nota	:=	nota_fiscal_w.nr_sequencia;
		

		
		if (coalesce(ds_action,'INSERT') = 'INSERT') THEN	
			ds_campo_w := 'CD_CNPJ';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CNPJ', c05_w.CD_CNPJ, 'N', nota_fiscal_transportadora_w.CD_CNPJ) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_transportadora_w.CD_CNPJ := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'IE_TIPO_FRETE';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_TIPO_FRETE', c05_w.IE_TIPO_FRETE, 'N', nota_fiscal_transportadora_w.IE_TIPO_FRETE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_transportadora_w.IE_TIPO_FRETE := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'NR_PLACA_VEICULO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_PLACA_VEICULO', c05_w.NR_PLACA_VEICULO, 'N', nota_fiscal_transportadora_w.NR_PLACA_VEICULO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_transportadora_w.NR_PLACA_VEICULO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'UF_PLACA_VEICULO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'UF_PLACA_VEICULO', c05_w.UF_PLACA_VEICULO, 'N', nota_fiscal_transportadora_w.UF_PLACA_VEICULO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_transportadora_w.UF_PLACA_VEICULO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'DS_ESPECIE';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_ESPECIE', c05_w.DS_ESPECIE, 'N', nota_fiscal_transportadora_w.DS_ESPECIE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_transportadora_w.DS_ESPECIE := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'QT_TRANSPORTE';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'QT_TRANSPORTE', c05_w.QT_TRANSPORTE, 'N', nota_fiscal_transportadora_w.QT_TRANSPORTE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_transportadora_w.QT_TRANSPORTE := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'QT_VOLUME';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'QT_VOLUME', c05_w.QT_VOLUME, 'N', nota_fiscal_transportadora_w.QT_VOLUME) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_transportadora_w.QT_VOLUME := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'QT_PESO_BRUTO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'QT_PESO_BRUTO', c05_w.QT_PESO_BRUTO, 'N', nota_fiscal_transportadora_w.QT_PESO_BRUTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_transportadora_w.QT_PESO_BRUTO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'QT_PESO_LIQUIDO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'QT_PESO_LIQUIDO', c05_w.QT_PESO_LIQUIDO, 'N', nota_fiscal_transportadora_w.QT_PESO_LIQUIDO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_transportadora_w.QT_PESO_LIQUIDO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'NR_LACRE';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_LACRE', c05_w.NR_LACRE, 'N', nota_fiscal_transportadora_w.NR_LACRE) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_transportadora_w.NR_LACRE := _ora2pg_r.ds_valor_retorno_p;	
			ds_campo_w := '';
			
			nota_fiscal_transportadora_w.nm_usuario	:= 'INTEGRACAO';
			nota_fiscal_transportadora_w.dt_atualizacao	:= clock_timestamp();

					
			select  nextval('nota_fiscal_transportadora_seq')	
			into STRICT    nota_fiscal_transportadora_w.nr_sequencia
			;
						
			insert into nota_fiscal_transportadora values (nota_fiscal_transportadora_w.*);
			
			if (c05_w.VL_FRETE IS NOT NULL AND c05_w.VL_FRETE::text <> '') then
				update nota_fiscal
				set vl_frete = c05_w.VL_FRETE
				where nr_sequencia = nota_fiscal_w.nr_sequencia;
			end if;
					

			ie_atualizou_w	:= 'S';	
			
		elsif (coalesce(c01_w.ie_action,'INSERT') = 'DELETE') then
		
			delete	FROM nota_fiscal_transportadora
			where	nr_seq_nota = nota_fiscal_transportadora_w.nr_seq_nota;
			
		end if;
		
		end;
	end loop;
	close c05;	
	end;
	
	open c06;
	loop
	fetch c06 into	
	      c06_w;
	EXIT WHEN NOT FOUND; /* apply on c06 */
	begin
		if (coalesce(ds_action,'INSERT') = 'INSERT') then
				
			reg_integracao_w.nm_tabela		:=	'NOTA_FISCAL_VENC';
			reg_integracao_w.nm_elemento		:=	'DUE';
			reg_integracao_w.nr_seq_visao		:=	 0;
			ds_campo_w := 'DT_VENCIMENTO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_VENCIMENTO', c06_w.DT_VENCIMENTO, 'N', nota_fiscal_venc_w.DT_VENCIMENTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_venc_w.DT_VENCIMENTO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'VL_VENCIMENTO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_VENCIMENTO', replace(c06_w.VL_VENCIMENTO, ',', '.'), 'N', nota_fiscal_venc_w.VL_VENCIMENTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_venc_w.VL_VENCIMENTO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'VL_BASE_VENC';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_BASE_VENC', replace(c06_w.VL_BASE_VENC, ',', '.'), 'N', nota_fiscal_venc_w.VL_BASE_VENC) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_venc_w.VL_BASE_VENC := _ora2pg_r.ds_valor_retorno_p;		
			ds_campo_w := 'VL_DESCONTO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_DESCONTO', replace(c06_w.VL_DESCONTO, ',', '.'), 'N', nota_fiscal_venc_w.VL_DESCONTO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_venc_w.VL_DESCONTO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'VL_DESC_FINANC';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_DESC_FINANC', replace(c06_w.VL_DESC_FINANC, ',', '.'), 'N', nota_fiscal_venc_w.VL_DESC_FINANC) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_venc_w.VL_DESC_FINANC := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'NR_TITULO_PAGAR';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_TITULO_PAGAR', c06_w.NR_TITULO_PAGAR, 'N', nota_fiscal_venc_w.NR_TITULO_PAGAR) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_venc_w.NR_TITULO_PAGAR := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := 'DS_OBSERVACAO';
			SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_OBSERVACAO', SUBSTR(c06_w.DS_OBSERVACAO, 1, 255), 'N', nota_fiscal_venc_w.DS_OBSERVACAO) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; nota_fiscal_venc_w.DS_OBSERVACAO := _ora2pg_r.ds_valor_retorno_p;
			ds_campo_w := '';
			
                        nota_fiscal_venc_w.cd_estabelecimento := nota_fiscal_w.cd_estabelecimento;
			nota_fiscal_venc_w.cd_serie_nf := nota_fiscal_w.cd_serie_nf;
			nota_fiscal_venc_w.dt_atualizacao := clock_timestamp();
			nota_fiscal_venc_w.ie_origem := 'N';
			nota_fiscal_venc_w.nm_usuario := 'INTEGRACAO';
			nota_fiscal_venc_w.nr_sequencia_nf :=  nota_fiscal_w.nr_sequencia_nf;
			nota_fiscal_venc_w.nr_sequencia := nota_fiscal_w.nr_sequencia;
			
			insert into nota_fiscal_venc values (nota_fiscal_venc_w.*);
							
		end  if;
	
	
	end;
	end loop;
	close c06;
		
	if	((reg_integracao_w.qt_reg_log > 0) and (coalesce(id_event_p, 18) = 404)) then
		begin
		
		rollback;
		
		for i in 0..reg_integracao_w.qt_reg_log-1 loop
			intpd_gravar_log_recebimento(nr_sequencia_p,reg_integracao_w.intpd_log_receb[i].ds_log,'INTEGRACAO');
			
			if (coalesce(reg_integracao_w.intpd_log_receb[i].ds_log, 'XX') <> 'XX') then
				ds_erro_w:= reg_integracao_w.intpd_log_receb[i].ds_log;
			end if;
			
		end loop;
		
		update	intpd_fila_transmissao
		set	ie_status = 'E',
			ds_log = ds_erro_w
		where	nr_sequencia = nr_sequencia_p;
		
		end;
	else
		if (coalesce(c01_w.ie_action,'INSERT') = 'INSERT') then
			begin
			
			nr_seq_nota_duplic_w:=	nota_duplicada(	nota_fiscal_w.nr_sequencia,
									nota_fiscal_w.nr_nota_fiscal,
									nota_fiscal_w.cd_serie_nf,	
									nota_fiscal_w.ie_situacao,
									nota_fiscal_w.cd_estabelecimento,
									nota_fiscal_w.cd_cgc_emitente,
									nota_fiscal_w.ie_tipo_nota,
									nota_fiscal_w.cd_pessoa_fisica,
									nota_fiscal_w.dt_emissao,
									nota_fiscal_w.nm_usuario,
									'N');

			if (coalesce(nr_seq_nota_duplic_w,0) > 0) then
				begin
				
				rollback;
				
				ds_erro_w:= 	wheb_mensagem_pck.get_texto(248040, 'NR_SEQUENCIA_W=' || nr_seq_nota_duplic_w);
				
				update	intpd_fila_transmissao
				set	ie_status = 'E',
					ds_log = ds_erro_w
				where	nr_sequencia = nr_sequencia_p;
				
				end;
			else
				begin

				qt_inconsistencia_nota_w:= 0;
				
				if (coalesce(id_event_p, 18) = 404) then
					begin
					
					CALL atualiza_total_nota_fiscal(nota_fiscal_w.nr_sequencia,'INTEGRACAO');

					qt_inconsistencia_nota_w := consiste_nota_integra(nota_fiscal_w.nr_sequencia, 'INTEGRACAO', qt_inconsistencia_nota_w, ie_devolucao_w);
					
					end;
				end if;
				
				if (qt_inconsistencia_nota_w > 0) then
					
					ds_consistencia_w := fis_buscar_inconsist_nota(nota_fiscal_w.nr_sequencia);
					
					if (coalesce(ds_consistencia_w, 'XX') = 'XX') then
						qt_inconsistencia_nota_w := 0;
					end if;
				
				end if;
					
				if (((coalesce(id_event_p, 18) = 18) or ((coalesce(id_event_p, 18) = 404) and (coalesce(qt_inconsistencia_nota_w,0) = 0))) and (c01_w.dt_atualizacao_estoque IS NOT NULL AND c01_w.dt_atualizacao_estoque::text <> '')) then
					begin
					begin
					
					CALL gerar_lote_fornec_nf(nota_fiscal_w.nr_sequencia,'N','INTEGRACAO','N','N');	
					
					if (nota_fiscal_w.ie_tipo_nota = 'SF') then	
						CALL atualizar_nota_fiscal(nota_fiscal_w.nr_sequencia,'I','INTEGRACAO',4);
					elsif (nota_fiscal_w.ie_tipo_nota = 'SE') then
						CALL atualizar_nota_fiscal(nota_fiscal_w.nr_sequencia,'I','INTEGRACAO',3);
					else
						CALL atualizar_nota_fiscal(nota_fiscal_w.nr_sequencia,'I','INTEGRACAO',0);
					end if;
					
					
					exception
					when others then
					
						rollback;
					
						ds_erro_w:= sqlerrm;
					
						update	intpd_fila_transmissao
						set	ie_status = 'E',
							ds_log = ds_erro_w
						where	nr_sequencia = nr_sequencia_p;
					end;
				
					end;
				else
					begin
					
					rollback;
					
					--intpd_gravar_log_recebimento(nr_sequencia_p,ds_consistencia_w,'INTEGRACAO');
					
					
					if (coalesce(ds_consistencia_w, 'XX') <> 'XX') then
						ds_erro_w	:= ds_consistencia_w;
					else
						ds_erro_w:= wheb_mensagem_pck.get_texto(1093061) || ' ' || wheb_mensagem_pck.get_texto(1093058)  || ' ' ||  wheb_mensagem_pck.get_texto(1093063)  || ' ' ||  wheb_mensagem_pck.get_texto(1093065);
					end if;
								
					update	intpd_fila_transmissao
					set	ie_status = 'E',
						ds_log = ds_erro_w,
						nr_seq_documento = 0
					where	nr_sequencia = nr_sequencia_p;
					
					end;
				end if;
				
				end;
			end if;
			end;
		end if;
	
	end if;
	
end loop;
close c01;
exception
when others then
	begin
	
	ds_erro_w	:=	substr(sqlerrm,1,4000);
	rollback;
	update	intpd_fila_transmissao
	set	ie_status = 'E',
		ds_log =  ds_erro_w || '-' || ds_campo_w,
		nr_seq_documento = 0
	where	nr_sequencia = nr_sequencia_p;
	
	end;
end;
	
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE intpd_recebimento_nota_fiscal (( nr_sequencia_p bigint, xml_p xml, id_event_p text default '18') is ie_conversao_w intpd_eventos_sistema.ie_conversao%type) FROM PUBLIC;

