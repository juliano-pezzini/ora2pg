-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE avisar_chegada_ordem_compra ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nm_usuarios_w			varchar(4000);
ds_titulo_w			varchar(50);
ds_comunicado_w			varchar(4000);
qt_usuario_w			bigint;
nr_solic_compra_w		bigint;
nr_ordem_compra_w		bigint;
nr_nota_fiscal_w		varchar(255);
cd_material_w			integer;
ds_material_w			varchar(255);
qt_item_nf_w			double precision;
nm_usuario_w			varchar(15);
nr_sequencia_w			bigint;
nr_seq_classif_w		bigint;
nm_fornecedor_w			pessoa_juridica.ds_razao_social%type;
nm_usuario_delegacao_w		varchar(15);
nm_solicitante_w		varchar(255);
ds_estabelecimento_w		varchar(255);

c01 CURSOR FOR
SELECT	distinct
	d.nm_usuario,
	substr(obter_usuario_pessoa(obter_pessoa_delegacao(c.cd_comprador,'RC',clock_timestamp())),1,15) nm_usuario_delegacao
from 	usuario d,
	ordem_compra c,
	nota_fiscal_item a
where	a.nr_sequencia	= nr_sequencia_p
  and	a.nr_ordem_compra	= c.nr_ordem_compra
  and	c.cd_comprador	= d.cd_pessoa_fisica
order by 1;

c02 CURSOR FOR
SELECT	b.nr_ordem_compra,
	e.nr_nota_fiscal,
	m.cd_material,
	m.ds_material,
	obter_usuario_pessoa(c.cd_pessoa_solicitante),
	substr(obter_usuario_pessoa(obter_pessoa_delegacao(c.cd_comprador,'RC',clock_timestamp())),1,15) nm_usuario_delegacao,
	a.qt_item_nf,
	substr(obter_nome_estabelecimento(c.cd_estabelecimento),1,100),
	substr(obter_nome_pf(c.cd_pessoa_solicitante),1,100)
from 	material m,
	nota_fiscal e,
	ordem_compra c,
	ordem_compra_item b,
	nota_fiscal_item a
where	a.nr_sequencia	= nr_sequencia_p
  and a.nr_ordem_compra 	= b.nr_ordem_compra
  and a.nr_ordem_compra 	= c.nr_ordem_compra
  and a.nr_item_oci		= b.nr_item_oci
  and a.cd_material		= m.cd_material
  and a.nr_sequencia	= e.nr_sequencia
order by 5, 1, 4;


BEGIN

nm_usuarios_w		:= null;
ds_comunicado_w	      	:= substr(WHEB_MENSAGEM_PCK.get_texto(297647),1,4000);
ds_comunicado_w	      	:= substr(ds_comunicado_w || chr(13)||chr(10),1,4000);
ds_comunicado_w	      	:= substr(ds_comunicado_w || chr(13)||chr(10),1,4000);

nm_usuarios_w		:= '';
select obter_classif_comunic('F')
into STRICT       nr_seq_classif_w
;

open c01;
loop
	fetch c01 into
			nm_usuario_w,
			nm_usuario_delegacao_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		
		if (nm_usuario_delegacao_w IS NOT NULL AND nm_usuario_delegacao_w::text <> '') then
			nm_usuario_w := nm_usuario_w || ',' || nm_usuario_delegacao_w;
		end if;
		
		select coalesce(position(nm_usuario_w in nm_usuarios_w),0)
		into STRICT qt_usuario_w
		;
		if (qt_usuario_w = 0) then
			nm_usuarios_w	:= substr(nm_usuarios_w || nm_usuario_w || ', ',1,4000);
		end if;
		end;
end loop;
close c01;

ds_comunicado_w	      	:= substr(WHEB_MENSAGEM_PCK.get_texto(297647),1,4000);
ds_comunicado_w	      	:= substr(ds_comunicado_w || chr(13)||chr(10),1,4000);
ds_comunicado_w	      	:= substr(ds_comunicado_w || chr(13)||chr(10),1,4000);

select	max(ds_razao_social)
into STRICT	nm_fornecedor_w
from	pessoa_juridica b,
	nota_fiscal a
where	a.nr_sequencia	= nr_sequencia_p
and	a.cd_cgc		= b.cd_cgc;

open c02;
loop
	fetch c02 into
		nr_ordem_compra_w,
		nr_nota_fiscal_w,
		cd_material_w,
		ds_material_w,
		nm_usuario_w,
		nm_usuario_delegacao_w,
		qt_item_nf_w,
		ds_estabelecimento_w,
		nm_solicitante_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		if (nm_usuario_delegacao_w IS NOT NULL AND nm_usuario_delegacao_w::text <> '') then
			nm_usuario_w := nm_usuario_w || ',' || nm_usuario_delegacao_w;
		end if;
		
		select coalesce(position(nm_usuario_w in nm_usuarios_w),0)
		into STRICT qt_usuario_w
		;
		if (qt_usuario_w = 0) then
			nm_usuarios_w	:= substr(nm_usuarios_w || nm_usuario_w || ', ',1,4000);
		end if;
		if (length(ds_comunicado_w) < 3800) then
			ds_comunicado_w	      := substr(ds_comunicado_w ||
			WHEB_MENSAGEM_PCK.get_texto(297671,'NR_ORDEM_COMPRA_W=' || to_char(nr_ordem_compra_w) || ';' ||
							'DS_MATERIAL_W=' || ds_material_w || ';' || 'QT_ITEM_NF_W=' || qt_item_nf_w),1,4000);
		end if;
		
		
		end;
end loop;
close c02;

if (nm_usuarios_w IS NOT NULL AND nm_usuarios_w::text <> '') then
	begin
	ds_titulo_w		:= WHEB_MENSAGEM_PCK.get_texto(297672);
	
	
	ds_comunicado_w	:= substr(ds_comunicado_w || WHEB_MENSAGEM_PCK.get_texto(297673,'DS_COMUNICADO_W=' || '' || ';' ||
								'NR_NOTA_FISCAL_W=' || nr_nota_fiscal_w || ';' ||
								'NM_FORNECEDOR_W=' || nm_fornecedor_w || ';' ||
								'NM_SOLICITANTE_W=' || nm_solicitante_w || ';' ||
								'DS_ESTABELECIMENTO_W=' || ds_estabelecimento_w),1,4000);


	select nextval('comunic_interna_seq')
	into STRICT nr_sequencia_w
	;


	insert into comunic_interna(
		dt_comunicado,
		ds_titulo,
		ds_comunicado,
		nm_usuario,
		dt_atualizacao,
		ie_geral,
		nm_usuario_destino,
		nr_sequencia,
		ie_gerencial,
		nr_seq_classif,
		dt_liberacao)
	values (clock_timestamp() + interval '1 days'/86400,
		ds_titulo_w,
		ds_comunicado_w,
		obter_desc_expressao(284862),
		clock_timestamp(),
		'N',
		nm_usuarios_w,
		nr_sequencia_w,
		'N',
		nr_seq_classif_w,
		clock_timestamp());
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE avisar_chegada_ordem_compra ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

