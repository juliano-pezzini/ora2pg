-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_movto_baixa_cartao (nr_seq_baixa_p bigint, nm_usuario_p text, nr_seq_lote_p bigint) AS $body$
DECLARE

 
nr_seq_movto_cartao_w		bigint;
nr_seq_trans_financ_w		bigint;
nr_seq_conta_banco_w		bigint;
dt_baixa_w			timestamp;
vl_baixa_w			double precision;
nr_sequencia_w			bigint;
vl_despesa_w			double precision;
nr_seq_trans_fin_desp_w		bigint;
nr_seq_trans_desp_equip_w	bigint;
vl_desp_equip_w			double precision;
ds_observacao_w			varchar(4000);
ie_obs_cartao_hist_cb_w		varchar(1);
cd_estabelecimento_w		smallint;
ie_valor_movto_bco_w		varchar(1);
nr_seq_parcela_w		bigint;
nr_seq_trans_fin_despesa_w	bigint;
ie_trans_despesa_w		varchar(1);
ie_baixa_desp_cartao_cc_w	varchar(1);
cd_centro_custo_w		integer;
cd_conta_financ_w		bigint;
vl_classificacao_w		double precision;
vl_tot_classificacao_w		double precision;
ie_deduzir_despesa_cartao_w	parametro_contas_receber.ie_deduzir_despesa_cartao%type;
nr_seq_baixa_orig_w		movto_cartao_cr_baixa.nr_seq_baixa_orig%type;
ie_estorno_w			movto_trans_financ.ie_estorno%type;
nr_seq_movto_orig_w		movto_trans_financ.nr_sequencia%type;
ie_estorno_controle_w			varchar(1) := 'N';
/*variaveis do cursor 02*/
nr_sequencia_trib_w			movto_cartao_cr_trib.nr_sequencia%type;
nr_seq_trans_financ_trib_w	movto_cartao_cr_trib.nr_seq_trans_financ%type;
cd_tributo_w				movto_cartao_cr_trib.cd_tributo%type;
vl_imposto_w				movto_cartao_cr_trib.vl_imposto%type;
nr_seq_movto_orig_trib_w	movto_trans_financ.nr_sequencia%type;
vl_imposto_parcela_w		movto_cartao_cr_parcela.vl_imposto%type;
vl_liquido_w				movto_cartao_cr_parcela.vl_liquido%type;
ds_obs_trib_w				varchar(4000);
ds_imposto_w				varchar(255);
vl_baixa_trib_w				movto_trans_financ.vl_transacao%type;
nr_seq_baixa_w				movto_cartao_cr_baixa.nr_sequencia%type;

C01 CURSOR FOR 
SELECT	a.cd_centro_custo, 
	a.cd_conta_financ, 
	sum(vl_classificacao) vl_classificacao 
from 	titulo_receber_classif a, 
	titulo_receber_liq b, 
	movto_cartao_cr c, 
	movto_cartao_cr_baixa d 
where	a.nr_titulo = b.nr_titulo 
and	b.nr_seq_caixa_rec = c.nr_seq_caixa_rec 
and	c.nr_sequencia = d.nr_seq_movto 
and	d.nr_sequencia = nr_seq_baixa_p 
group by a.cd_centro_custo, 
	 a.cd_conta_financ;

	 
C02 CURSOR FOR 
	SELECT	a.nr_sequencia, 
			a.nr_seq_trans_financ, 
			a.cd_tributo, 
			a.vl_imposto 
	from	movto_cartao_cr_trib a 
	where	a.nr_seq_movto_cartao = nr_seq_movto_cartao_w 
	order by a.nr_sequencia;	
 

BEGIN 
 
if (coalesce(nr_seq_baixa_p,0) <> 0) then 
	begin 
	begin 
	select	max(nr_seq_movto), 
		max(nr_seq_trans_financ), 
		max(nr_seq_conta_banco), 
		max(dt_baixa), 
		coalesce(max(vl_baixa),0), 
		coalesce(max(vl_despesa),0), 
		coalesce(max(vl_desp_equip),0), 
		max(ds_observacao), 
		max(nr_seq_parcela), 
		max(nr_seq_baixa_orig) 
	into STRICT	nr_seq_movto_cartao_w, 
		nr_seq_trans_financ_w, 
		nr_seq_conta_banco_w, 
		dt_baixa_w, 
		vl_baixa_w, 
		vl_despesa_w, 
		vl_desp_equip_w, 
		ds_observacao_w, 
		nr_seq_parcela_w, 
		nr_seq_baixa_orig_w 
	from	movto_cartao_cr_baixa 
	where	nr_sequencia	= nr_seq_baixa_p;
 
	if (nr_seq_baixa_orig_w IS NOT NULL AND nr_seq_baixa_orig_w::text <> '') then 
 
		ie_estorno_w	:= 'E';
 
	else 
 
		ie_estorno_w	:= null;
 
	end if;	
	 
 
	select	somente_numero(obter_valor_bandeira_estab(c.nr_sequencia,b.cd_estabelecimento,'NR_SEQ_TRANS_FIN_DESP')), 
		somente_numero(obter_valor_bandeira_estab(c.nr_sequencia,b.cd_estabelecimento,'NR_SEQ_TRANS_DESP_EQUIP')), 
		b.cd_estabelecimento, 
		c.ie_valor_movto_bco 
	into STRICT	nr_seq_trans_fin_desp_w, 
		nr_seq_trans_desp_equip_w, 
		cd_estabelecimento_w, 
		ie_valor_movto_bco_w 
	from	bandeira_cartao_cr c, 
		movto_cartao_cr b, 
		movto_cartao_cr_baixa a 
	where	b.nr_seq_bandeira	= c.nr_sequencia 
	and	a.nr_seq_movto		= b.nr_sequencia 
	and	a.nr_sequencia		= nr_seq_baixa_p;
	exception when others then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(235209);
	end;
 
	select	coalesce(max(ie_obs_cartao_hist_cb),'N'), 
		coalesce(max(ie_baixa_desp_cartao_cc), 'N'), 
		coalesce(max(ie_deduzir_despesa_cartao), 'N') 
	into STRICT	ie_obs_cartao_hist_cb_w, 
		ie_baixa_desp_cartao_cc_w, 
		ie_deduzir_despesa_cartao_w 
	from	parametro_contas_receber 
	where	cd_estabelecimento	= cd_estabelecimento_w;
 
	if (ie_obs_cartao_hist_cb_w = 'N') then 
		ds_observacao_w	:= null;
	end if;
 
	if (ie_valor_movto_bco_w = 'S') then 
	 
		if (vl_baixa_w < 0) then -- Se for baixa de estorno 
			ie_estorno_controle_w := 'S';
		end if;
 
		select	coalesce(sum(a.vl_parcela),0) 
		into STRICT	vl_baixa_w 
		from	movto_cartao_cr_parcela a 
		where	a.nr_sequencia	= nr_seq_parcela_w;
		 
		if ( coalesce(ie_estorno_controle_w,'N') = 'S') then -- Se for de estorno, multiplica por *-1. 
			vl_baixa_w := coalesce(vl_baixa_w,0) * -1;
		end if;
 
	end if;
 
	ie_trans_despesa_w 		:= substr(coalesce(obter_valor_param_usuario(3020,42,obter_perfil_ativo,nm_usuario_p,cd_estabelecimento_w),'N'),1,1);
 
	if (ie_trans_despesa_w = 'S') and (nr_seq_lote_p > 0) then 
 
		select	max(a.nr_seq_trans_fin_despesa) 
		into STRICT	nr_seq_trans_fin_despesa_w 
		from	lote_baixa_cartao_cr a 
		where	a.nr_sequencia	= nr_seq_lote_p;
 
		nr_seq_trans_fin_desp_w	:= nr_seq_trans_fin_despesa_w;
 
	end if;
 
 
	if (coalesce(ie_deduzir_despesa_cartao_w,'N') = 'S') then 
		vl_baixa_w := coalesce(vl_baixa_w,0) - coalesce(vl_despesa_w,0);
	end if;
 
	if (nr_seq_conta_banco_w IS NOT NULL AND nr_seq_conta_banco_w::text <> '') and (nr_seq_trans_financ_w IS NOT NULL AND nr_seq_trans_financ_w::text <> '') and (vl_baixa_w <> 0) then 
 
		if (coalesce(ie_estorno_w,'X')	= 'E') then 
 
			/* obter a movimentação de origem do estorno */
 
			select	max(a.nr_sequencia) 
			into STRICT	nr_seq_movto_orig_w 
			from	movto_trans_financ a 
			where	a.nr_seq_trans_financ	= nr_seq_trans_financ_w 
			and	not exists (SELECT	1 
				from	movto_trans_financ x 
				where	a.nr_seq_movto_orig	= a.nr_sequencia) 
			and	coalesce(a.nr_seq_movto_orig::text, '') = '' 
			and	a.nr_seq_parc_cartao	= nr_seq_parcela_w 
			and	a.nr_seq_movto_cartao	= nr_seq_movto_cartao_w;
 
		else 
 
			nr_seq_movto_orig_w	:= null;
 
		end if;
		 
		select	nextval('movto_trans_financ_seq') 
		into STRICT	nr_sequencia_w 
		;
 
		insert	into movto_trans_financ(nr_sequencia, 
						dt_transacao, 
						nr_seq_trans_financ, 
						vl_transacao, 
						dt_atualizacao, 
						nm_usuario, 
						nr_lote_contabil, 
						ie_conciliacao, 
						nr_seq_movto_cartao, 
						nr_seq_banco, 
						dt_referencia_saldo, 
						ds_historico, 
						nr_seq_parc_cartao, 
						ie_estorno, 
						nr_seq_movto_orig) 
					values (nr_sequencia_w, 
						dt_baixa_w, 
						nr_seq_trans_financ_w, 
						vl_baixa_w, 
						clock_timestamp(), 
						nm_usuario_p, 
						0, 
						'N', 
						nr_seq_movto_cartao_w, 
						nr_seq_conta_banco_w, 
						clock_timestamp(), 
						substr(ds_observacao_w,1,255), 
						nr_seq_parcela_w, 
						ie_estorno_w, 
						nr_seq_movto_orig_w);
						 
		CALL gravar_agend_integracao(417, 'NR_SEQ_MVTO_FIN=' || nr_sequencia_w || ';');
		 
		/*Cursor para lançar movimento no banco para a baixa dos tributos.*/
 
		open C02;
		loop 
		fetch C02 into	 
			nr_sequencia_trib_w, 
			nr_seq_trans_financ_trib_w, 
			cd_tributo_w, 
			vl_imposto_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin 
			 
			if ( coalesce(nr_seq_parcela_w,0) <> 0) then 
			 
				select	coalesce(max(a.vl_imposto),0), 
						max(a.vl_liquido) 
				into STRICT	vl_imposto_parcela_w, 
						vl_liquido_w 
				from	movto_cartao_cr_parcela a 
				where	a.nr_sequencia			= nr_seq_parcela_w 
				and		a.nr_seq_movto			= nr_seq_movto_cartao_w;	
			 
			end if;
			 
			if ( coalesce(nr_seq_trans_financ_trib_w,0) <> 0 ) and ( coalesce(vl_imposto_parcela_w,0) <> 0 ) then 
			 
 
				vl_baixa_trib_w := (dividir_sem_round((vl_baixa_w * vl_imposto_parcela_w),vl_liquido_w));
			 
				ds_imposto_w := substr(obter_desc_tributo(cd_tributo_w),1,100);
				 
				ds_obs_trib_w:= substr(wheb_mensagem_pck.get_texto(348434,'NR_SEQ_PARCELA_W=' || NR_SEQ_PARCELA_W || ';' || 'NR_SEQ_MOVTO_W=' || NR_SEQ_MOVTO_CARTAO_W || ';' || 'DS_IMPOSTO_W=' || substr(DS_IMPOSTO_W,1,100)),1,3999);
				 
				if (coalesce(ie_estorno_w,'X')	= 'E') then 
 
					/* obter a movimentação de origem do estorno */
 
					select	max(a.nr_sequencia) 
					into STRICT	nr_seq_movto_orig_trib_w 
					from	movto_trans_financ a 
					where	a.nr_seq_trans_financ	= nr_seq_trans_financ_trib_w 
					and	not exists (SELECT	1 
						from	movto_trans_financ x 
						where	a.nr_seq_movto_orig	= a.nr_sequencia) 
					and	coalesce(a.nr_seq_movto_orig::text, '') = '' 
					and	a.nr_seq_parc_cartao	= nr_seq_parcela_w 
					and	a.nr_seq_movto_cartao	= nr_seq_movto_cartao_w;
 
				else 
 
					nr_seq_movto_orig_w	:= null;
 
				end if;
 
				select	nextval('movto_trans_financ_seq') 
				into STRICT	nr_sequencia_w 
				;
			 
				insert	into movto_trans_financ(nr_sequencia, 
						dt_transacao, 
						nr_seq_trans_financ, 
						vl_transacao, 
						dt_atualizacao, 
						nm_usuario, 
						nr_lote_contabil, 
						ie_conciliacao, 
						nr_seq_movto_cartao, 
						nr_seq_banco, 
						dt_referencia_saldo, 
						ds_historico, 
						nr_seq_parc_cartao, 
						ie_estorno, 
						nr_seq_movto_orig) 
					values (nr_sequencia_w, 
						dt_baixa_w, 
						nr_seq_trans_financ_trib_w, 
						coalesce(vl_baixa_trib_w,0), 
						clock_timestamp(), 
						nm_usuario_p, 
						0, 
						'N', 
						nr_seq_movto_cartao_w, 
						nr_seq_conta_banco_w, 
						clock_timestamp(), 
						substr(ds_obs_trib_w,1,3999), 
						nr_seq_parcela_w, 
						ie_estorno_w, 
						nr_seq_movto_orig_trib_w);
						 
				select	max(a.nr_sequencia) 
				into STRICT	nr_seq_baixa_w 
				from	movto_cartao_cr_baixa a 
				where	a.nr_seq_movto		=	nr_seq_movto_cartao_w 
				and		a.nr_seq_parcela	=	nr_seq_parcela_w;
 
				if (nr_seq_baixa_w IS NOT NULL AND nr_seq_baixa_w::text <> '') then 
						 
					update	movto_cartao_cr_baixa a 
					set		a.vl_imposto		=	vl_baixa_trib_w 
					where	a.nr_seq_movto		=	nr_seq_movto_cartao_w 
					and		a.nr_seq_parcela	=	nr_seq_parcela_w 
					and		a.nr_sequencia		=	nr_seq_baixa_w;
			 
				end if;
				 
			end if;	
			 
			end;
		end loop;
		close C02;
 
	end if;
 
 
	if (nr_seq_conta_banco_w IS NOT NULL AND nr_seq_conta_banco_w::text <> '') and (coalesce(nr_seq_trans_fin_desp_w,0) <> 0) and (vl_despesa_w <> 0) and (coalesce(ie_deduzir_despesa_cartao_w,'N') = 'N') then 
 
			if (coalesce(ie_estorno_w,'X')	= 'E') then 
 
			/* obter a movimentação de origem do estorno */
 
			select	max(a.nr_sequencia) 
			into STRICT	nr_seq_movto_orig_w 
			from	movto_trans_financ a 
			where	a.nr_seq_trans_financ	= nr_seq_trans_fin_desp_w 
			and	not exists (SELECT	1 
				from	movto_trans_financ x 
				where	a.nr_seq_movto_orig	= a.nr_sequencia) 
			and	coalesce(a.nr_seq_movto_orig::text, '') = '' 
			and	a.nr_seq_parc_cartao	= nr_seq_parcela_w 
			and	a.nr_seq_movto_cartao	= nr_seq_movto_cartao_w;
 
		else 
 
			nr_seq_movto_orig_w	:= null;
 
		end if;
 
		select	nextval('movto_trans_financ_seq') 
		into STRICT	nr_sequencia_w 
		;
 
		insert	into movto_trans_financ(nr_sequencia, 
						dt_transacao, 
						nr_seq_trans_financ, 
						vl_transacao, 
						dt_atualizacao, 
						nm_usuario, 
						nr_lote_contabil, 
						ie_conciliacao, 
						nr_seq_movto_cartao, 
						nr_seq_banco, 
						dt_referencia_saldo, 
						ds_historico, 
						nr_seq_parc_cartao, 
						ie_estorno, 
						nr_seq_movto_orig) 
					values (nr_sequencia_w, 
						dt_baixa_w, 
						nr_seq_trans_fin_desp_w, 
						vl_despesa_w, 
						clock_timestamp(), 
						nm_usuario_p, 
						0, 
						'N', 
						nr_seq_movto_cartao_w, 
						nr_seq_conta_banco_w, 
						clock_timestamp(), 
						substr(ds_observacao_w,1,255), 
						nr_seq_parcela_w, 
						ie_estorno_w, 
						nr_seq_movto_orig_w);
						 
		if (ie_baixa_desp_cartao_cc_w = 'S') then				 
			begin 
			select	sum(vl_classificacao) vl_classificacao 
			into STRICT	vl_tot_classificacao_w 
			from 	titulo_receber_classif a, 
				titulo_receber_liq b, 
				movto_cartao_cr c, 
				movto_cartao_cr_baixa d 
			where	a.nr_titulo = b.nr_titulo 
			and	b.nr_seq_caixa_rec = c.nr_seq_caixa_rec 
			and	c.nr_sequencia = d.nr_seq_movto 
			and	d.nr_sequencia = nr_seq_baixa_p;
			 
			open C01;
			loop 
			fetch C01 into	 
				cd_centro_custo_w, 
				cd_conta_financ_w, 
				vl_classificacao_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				begin 
				insert into movto_trans_financ_cc(nr_sequencia, 
					nr_seq_movto_trans, 
					cd_centro_custo, 
					vl_transacao, 
					dt_atualizacao, 
					nm_usuario, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec, 
					cd_conta_financ) 
				SELECT	nextval('movto_trans_financ_cc_seq'), 
					nr_sequencia_w, 
					cd_centro_custo_w, 
					dividir_sem_round(vl_classificacao_w * vl_despesa_w, vl_tot_classificacao_w), 
					clock_timestamp(), 
					nm_usuario_p, 
					clock_timestamp(), 
					nm_usuario_p, 
					cd_conta_financ_w 
				;
				end;
			end loop;
			close C01;	
			end;
			 
		CALL gravar_agend_integracao(417, 'NR_SEQ_MVTO_FIN=' || nr_sequencia_w || ';');
		 
		end if;
	end if;
 
 
	/* Francisco - OS 73824 - 09/11/2007 - Tratar despesa de equipamento */
 
	if (nr_seq_conta_banco_w IS NOT NULL AND nr_seq_conta_banco_w::text <> '') and (coalesce(nr_seq_trans_desp_equip_w,0) <> 0) and (vl_desp_equip_w <> 0) then 
 
		if (coalesce(ie_estorno_w,'X')	= 'E') then 
 
			/* obter a movimentação de origem do estorno */
 
			select	max(a.nr_sequencia) 
			into STRICT	nr_seq_movto_orig_w 
			from	movto_trans_financ a 
			where	a.nr_seq_trans_financ	= nr_seq_trans_desp_equip_w 
			and	not exists (SELECT	1 
				from	movto_trans_financ x 
				where	a.nr_seq_movto_orig	= a.nr_sequencia) 
			and	coalesce(a.nr_seq_movto_orig::text, '') = '' 
			and	a.nr_seq_parc_cartao	= nr_seq_parcela_w 
			and	a.nr_seq_movto_cartao	= nr_seq_movto_cartao_w;
 
		else 
 
			nr_seq_movto_orig_w	:= null;
 
		end if;
 
		select	nextval('movto_trans_financ_seq') 
		into STRICT	nr_sequencia_w 
		;
 
		insert	into movto_trans_financ(nr_sequencia, 
						dt_transacao, 
						nr_seq_trans_financ, 
						vl_transacao, 
						dt_atualizacao, 
						nm_usuario, 
						nr_lote_contabil, 
						ie_conciliacao, 
						nr_seq_movto_cartao, 
						nr_seq_banco, 
						dt_referencia_saldo, 
						ds_historico, 
						nr_seq_parc_cartao, 
						ie_estorno, 
						nr_seq_movto_orig) 
					values (nr_sequencia_w, 
						dt_baixa_w, 
						nr_seq_trans_desp_equip_w, 
						vl_desp_equip_w, 
						clock_timestamp(), 
						nm_usuario_p, 
						0, 
						'N', 
						nr_seq_movto_cartao_w, 
						nr_seq_conta_banco_w, 
						clock_timestamp(), 
						substr(ds_observacao_w,1,255), 
						nr_seq_parcela_w, 
						ie_estorno_w, 
						nr_seq_movto_orig_w);
						 
		CALL gravar_agend_integracao(417, 'NR_SEQ_MVTO_FIN=' || nr_sequencia_w || ';');		
							 
	end if;
	end;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_movto_baixa_cartao (nr_seq_baixa_p bigint, nm_usuario_p text, nr_seq_lote_p bigint) FROM PUBLIC;

