-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_regra_data_venc_cp (cd_estabelecimento_p bigint, dt_inclusao_p timestamp, dt_vencimento_p timestamp, nm_usuario_p text) AS $body$
DECLARE


ie_data_ref_w		varchar(5);
qt_dia_venc_w		bigint;
ie_dia_semana_w		integer;
ie_dia_semana_regra_w	integer;

c01 CURSOR FOR
SELECT	ie_data_ref,
	qt_dia_venc,
	ie_dia_semana
from	regra_data_venc_cp
where	cd_estabelecimento	= cd_estabelecimento_p;


BEGIN

if (dt_vencimento_p IS NOT NULL AND dt_vencimento_p::text <> '') then

	open c01;
	loop
	fetch c01 into
		ie_data_ref_w,
		qt_dia_venc_w,
		ie_dia_semana_regra_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		if (dt_inclusao_p IS NOT NULL AND dt_inclusao_p::text <> '') and
			((trunc(dt_inclusao_p) + qt_dia_venc_w) < trunc(dt_vencimento_p)) then

			/* A data de vencimento do título é menor que a data permitida.
			Data permitida: to_char(dt_inclusao_p + qt_dia_venc_w,'dd/mm/yyyy'). */
			CALL wheb_mensagem_pck.exibir_mensagem_abort(262446,'DT_INCLUSAO_P='||to_char(dt_inclusao_p + qt_dia_venc_w,'dd/mm/yyyy'));

		elsif (ie_dia_semana_regra_w IS NOT NULL AND ie_dia_semana_regra_w::text <> '') then

			select	CASE WHEN obter_se_feriado(cd_estabelecimento_p,dt_vencimento_p)=0 THEN pkg_date_utils.get_WeekDay(dt_vencimento_p)  ELSE 0 END  ie_dia_semana
			into STRICT	ie_dia_semana_w
			;

			if	not ((ie_dia_semana_w	= ie_dia_semana_regra_w) or
				((ie_dia_semana_regra_w	= 9) and (ie_dia_semana_w in (2,3,4,5,6)))) then

				/* Este dia da semana não é permitido para o vencimento do título! Verifique a regra de vencimento do contas a pagar. */

				CALL wheb_mensagem_pck.exibir_mensagem_abort(262448);

			end if;

		end if;

	end loop;
	close c01;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_regra_data_venc_cp (cd_estabelecimento_p bigint, dt_inclusao_p timestamp, dt_vencimento_p timestamp, nm_usuario_p text) FROM PUBLIC;

