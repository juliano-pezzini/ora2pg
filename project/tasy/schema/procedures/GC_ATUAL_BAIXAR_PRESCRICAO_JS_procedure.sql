-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gc_atual_baixar_prescricao_js ( nr_atendimento_p bigint, nr_prescricao_p bigint, nr_cirurgia_p bigint, cd_local_estoque_p bigint, nr_seq_atepacu_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, cd_perfil_p bigint, cd_funcao_p bigint, cd_setor_atendimento_p bigint, cd_pessoa_fisica_p bigint ) AS $body$
DECLARE

	 
ds_erro_w			varchar(255):= '';
grava_receita_prescricao_w	varchar(1);
ie_conta_fechada_w		varchar(1);
perm_baixa_prescr_cfechada_w	varchar(1);
gerar_novo_carrinho_kit_w	varchar(1);
ie_exibe_numero_kit_gerado_w	varchar(1);
ds_retorno_w			varchar(255);
ds_retorno_ww			varchar(255);


BEGIN 
 
ds_erro_w := baixa_prescr_mat_cirurgia(nr_cirurgia_p, nr_prescricao_p, cd_local_estoque_p, nr_seq_atepacu_p, nm_usuario_p, cd_perfil_p, cd_setor_atendimento_p, cd_funcao_p, ds_erro_w);
 
if (ds_erro_w <> '') then 
	begin 
	--(-20011, substr(ds_erro_w,1,255) || '#@#@'); 
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(263646,'DS_ERRO_W=' || DS_ERRO_W);
	end;
end if;
 
perm_baixa_prescr_cfechada_w := obter_param_usuario(900, 77, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, perm_baixa_prescr_cfechada_w);
grava_receita_prescricao_w := obter_param_usuario(900, 147, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, grava_receita_prescricao_w);
gerar_novo_carrinho_kit_w := obter_param_usuario(900, 254, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, gerar_novo_carrinho_kit_w);
ie_exibe_numero_kit_gerado_w := obter_param_usuario(900, 310, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_exibe_numero_kit_gerado_w);
 
 
if (grava_receita_prescricao_w = 'S') then 
	begin 
	CALL grava_receita_com_prescricao(nr_prescricao_p);
	end;
end if;
 
select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  
into STRICT	ie_conta_fechada_w 
from	atendimento_paciente 
where	nr_atendimento = nr_atendimento_p 
and	ie_fim_conta = 'F' 
and	(dt_fim_conta IS NOT NULL AND dt_fim_conta::text <> '');
 
if	((perm_baixa_prescr_cfechada_w = 'N' AND ie_conta_fechada_w = 'N') or (perm_baixa_prescr_cfechada_w = 'S') or (perm_baixa_prescr_cfechada_w = 'A') or 
    (perm_baixa_prescr_cfechada_w = 'B' AND ie_conta_fechada_w = 'N')) then 
	begin 
	--(-20011, substr(obter_texto_tasy (51329, wheb_usuario_pck.get_nr_seq_idioma),1,255) || '#@#@'); 
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(51329);
	end;
end if;
 
 
if (gerar_novo_carrinho_kit_w = 'S') then 
  	begin 
	SELECT * FROM gerar_carrinho_kit_estoque(cd_estabelecimento_p, cd_pessoa_fisica_p, nm_usuario_p, nr_prescricao_p, cd_local_estoque_p, ds_retorno_w, ds_retorno_ww) INTO STRICT ds_retorno_w, ds_retorno_ww;	
	 
	if (ie_exibe_numero_kit_gerado_w = 'S') and (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '')then 
		begin 
		--(-20011, substr(obter_texto_tasy (55119, wheb_usuario_pck.get_nr_seq_idioma),1,255) || ds_retorno_w || '#@#@'); 
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(55119);
		end;
	end if;
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gc_atual_baixar_prescricao_js ( nr_atendimento_p bigint, nr_prescricao_p bigint, nr_cirurgia_p bigint, cd_local_estoque_p bigint, nr_seq_atepacu_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, cd_perfil_p bigint, cd_funcao_p bigint, cd_setor_atendimento_p bigint, cd_pessoa_fisica_p bigint ) FROM PUBLIC;

