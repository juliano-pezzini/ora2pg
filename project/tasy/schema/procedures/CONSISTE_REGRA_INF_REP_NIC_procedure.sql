-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_regra_inf_rep_nic ( nr_atendimento_p bigint, nr_prescricao_p bigint, cd_pessoa_fisica_p bigint, nr_seq_regra_p bigint, ie_inconsistente_p INOUT boolean, ie_informacao_w_p INOUT text, ie_escala_indice_p INOUT text, ie_informacao_p text, quebra_p text, ds_mensag_p text, ds_mensagem_p INOUT text) AS $body$
DECLARE

qt_registros_w bigint;
qt_contraste_w bigint;
dt_criacao_regra_w timestamp;


BEGIN
	select	count(*)
  into STRICT	  qt_registros_w
  from	  escala_nic
  where	  nr_atendimento = nr_atendimento_p
  and		  (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
  and		  coalesce(dt_inativacao::text, '') = '';

	select	max(dt_atualizacao_nrec)
	into STRICT	  dt_criacao_regra_w
	from	  regra_consiste_inf_rep
	where 	nr_sequencia = nr_seq_regra_p;

  select  count(pp.nr_prescricao)
  into STRICT   	qt_contraste_w -- QUANTIDADE DE PROCEDIMENTOS COM CONTRASTE
  from    prescr_medica pm
  join    prescr_procedimento pp on pp.nr_prescricao = pm.nr_prescricao
  join    proc_interno_contraste pi on pp.nr_seq_contraste = pi.nr_sequencia
  where   (pp.nr_seq_contraste IS NOT NULL AND pp.nr_seq_contraste::text <> '')
  and     pp.ie_suspenso = 'N'
  and     pi.ie_situacao = 'A'
  and     pm.cd_pessoa_fisica = cd_pessoa_fisica_p
  and     pm.nr_atendimento = nr_atendimento_p
  and     pm.nr_prescricao = nr_prescricao_p
  and     coalesce(pp.dt_atualizacao_nrec, pp.dt_atualizacao) >= dt_criacao_regra_w;

  if (qt_registros_w = 0 and qt_contraste_w > 0) then
    if (ds_mensag_p IS NOT NULL AND ds_mensag_p::text <> '') then
      ds_mensagem_p := ds_mensag_p || quebra_p;
    else
      ds_mensagem_p := ds_mensagem_p || wheb_mensagem_pck.get_texto(1056449, null) || quebra_p; /*-- N√ÉO FOI CADASTRADA A ESCALA NIC PARA ESTE ATENDIMENTO.*/
    end if;
    ie_inconsistente_p := true;
    ie_informacao_w_p := ie_informacao_p;
    ie_escala_indice_p := 'NIC';
	end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_regra_inf_rep_nic ( nr_atendimento_p bigint, nr_prescricao_p bigint, cd_pessoa_fisica_p bigint, nr_seq_regra_p bigint, ie_inconsistente_p INOUT boolean, ie_informacao_w_p INOUT text, ie_escala_indice_p INOUT text, ie_informacao_p text, quebra_p text, ds_mensag_p text, ds_mensagem_p INOUT text) FROM PUBLIC;

