-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cme_gerar_requisicao ( nr_seq_agenda_p bigint, cd_pessoa_fisica_p text, cd_setor_atendimento_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_requisicao_p INOUT bigint) AS $body$
DECLARE


qt_existe_conjunto_w	bigint;
nr_seq_requisicao_w	bigint;
nr_seq_req_item_w	bigint;
nr_seq_conjunto_w	bigint;
qt_conjunto_w		bigint;
qt_requisicao_w		bigint;
nr_seq_classif_w 	bigint;
					
c01 CURSOR FOR
	SELECT	nr_seq_conjunto,
		qt_conjunto
	from	agenda_pac_cme
	where	nr_seq_agenda = nr_seq_agenda_p
	and	ie_origem_inf = 'I'
	and 	(nr_seq_conjunto IS NOT NULL AND nr_seq_conjunto::text <> '');
	
c02 CURSOR FOR
	SELECT	nr_seq_classif,
		qt_conjunto
	from	agenda_pac_cme
	where	nr_seq_agenda = nr_seq_agenda_p
	and	ie_origem_inf = 'I'
	and 	(nr_seq_classif IS NOT NULL AND nr_seq_classif::text <> '');	


BEGIN

if (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') then
	begin	
	select	count(*)
	into STRICT	qt_existe_conjunto_w
	from	agenda_pac_cme
	where	nr_seq_agenda = nr_seq_agenda_p;
	
	
	select 	count(*)
	into STRICT	qt_requisicao_w
	from	cm_requisicao
	where	nr_seq_agenda = nr_seq_agenda_p;
	
	if (qt_existe_conjunto_w > 0) and (qt_requisicao_w = 0) then
		
		begin	
		
		select	nextval('cm_requisicao_seq')
		into STRICT	nr_seq_requisicao_w
		;
		
		insert into cm_requisicao(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_requisicao,
			cd_setor_atendimento,
			cd_pessoa_requisitante,
			cd_estabelecimento,
			dt_liberacao,
			nr_seq_agenda,
			ie_urgente
			)
		values (nr_seq_requisicao_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			cd_setor_atendimento_p,
			cd_pessoa_fisica_p,
			cd_estabelecimento_p,
			clock_timestamp(),
			nr_seq_agenda_p,
			'N'
			);
			
		open c01;
		loop
		fetch c01 into
			nr_seq_conjunto_w,
			qt_conjunto_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin	

			select	nextval('cm_requisicao_item_seq')
			into STRICT	nr_seq_req_item_w
			;

			insert into cm_requisicao_item(
				nr_sequencia,
				nr_seq_requisicao,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_conjunto,
				qt_conjunto,
				ie_devolucao,
				ie_emprestimo
				)
			values (nr_seq_req_item_w,
				nr_seq_requisicao_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_conjunto_w,
				qt_conjunto_w,
				'N',
				'N');
			end;
		end loop;
		close c01;			

		open c02;
		loop
		fetch c02 into
			nr_seq_classif_w,
			qt_conjunto_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin	

			select	nextval('cm_requisicao_item_seq')
			into STRICT	nr_seq_req_item_w
			;

			insert into cm_requisicao_item(
				nr_sequencia,
				nr_seq_requisicao,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_classif,
				qt_conjunto,
				ie_devolucao,
				ie_emprestimo
				)
			values (nr_seq_req_item_w,
				nr_seq_requisicao_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_classif_w,
				qt_conjunto_w,
				'N',
				'N');
			end;
		end loop;
		close c02;			
		end;
	end if;	
	end;
end if;


nr_requisicao_p	:= nr_seq_requisicao_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cme_gerar_requisicao ( nr_seq_agenda_p bigint, cd_pessoa_fisica_p text, cd_setor_atendimento_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_requisicao_p INOUT bigint) FROM PUBLIC;

