-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_imposto_receb_tit_rec (nr_seq_retorno_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_tributo_w		smallint;
nr_lote_contabil_w	bigint;
nr_titulo_w		bigint;
vl_adicional_w		double precision;
tx_tributo_w		double precision;
vl_base_calculo_w	double precision;
cd_estabelecimento_w	smallint;
ie_gerar_imposto_tit_w	varchar(1);
vl_total_pago_w		double precision;
vl_imposto_w		double precision;
vl_recebido_w		double precision;
vl_total_imposto_w	double precision;
nr_seq_tributo_w	bigint;
nr_seq_trans_financ_w	bigint;

c01 CURSOR FOR
SELECT	a.cd_tributo,
	a.nr_lote_contabil,
	a.nr_titulo,
	a.vl_adicional,
	a.nr_seq_trans_financ
from	convenio_receb_adic a
where	not exists (select	1
	from	titulo_receber_trib x
	where	x.cd_tributo	= a.cd_tributo
	and	x.nr_titulo	= a.nr_titulo)
and	(a.cd_tributo IS NOT NULL AND a.cd_tributo::text <> '')
and	exists (select	1
	from	convenio_ret_receb x
	where	x.nr_seq_retorno	= nr_seq_retorno_p
	and	x.nr_seq_receb		= a.nr_seq_receb);

c02 CURSOR FOR
SELECT	a.nr_titulo,
	sum(a.vl_recebido) vl_recebido
from	titulo_receber_liq a
where	a.vl_recebido		<> 0
and	a.nr_seq_retorno	= nr_seq_retorno_p
group by	a.nr_titulo;


BEGIN

select	coalesce(sum(a.vl_pago),0)
into STRICT	vl_total_pago_w
from	convenio_retorno_item a
where	a.nr_seq_retorno	= nr_seq_retorno_p;

select	max(a.cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	convenio_retorno a
where	a.nr_sequencia		= nr_seq_retorno_p;

ie_gerar_imposto_tit_w := obter_param_usuario(27, 200, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_gerar_imposto_tit_w);

open	c01;
loop
fetch	c01 into
	cd_tributo_w,
	nr_lote_contabil_w,
	nr_titulo_w,
	vl_adicional_w,
	nr_seq_trans_financ_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	/* se não tem título informado, ratear para os títulos do retorno */

	if (coalesce(nr_titulo_w::text, '') = '') then

		vl_total_imposto_w	:= 0;
		nr_seq_tributo_w	:= null;

		open	c02;
		loop
		fetch	c02 into
			nr_titulo_w,
			vl_recebido_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */

			select	coalesce(max(a.vl_titulo),0)
			into STRICT	vl_base_calculo_w
			from	titulo_receber a
			where	a.nr_titulo	= nr_titulo_w;

			/* o valor do imposto é calculado sobre o valor recebido */

			vl_imposto_w		:= (coalesce(vl_adicional_w,0) * vl_recebido_w) / vl_total_pago_w;
			vl_total_imposto_w	:= coalesce(vl_total_imposto_w,0) + coalesce(vl_imposto_w,0);
			/* a taxa é calculada sobre o valor do título */

			tx_tributo_w		:= (coalesce(vl_imposto_w,0) * 100) / vl_base_calculo_w;

			select	nextval('titulo_receber_trib_seq')
			into STRICT	nr_seq_tributo_w
			;

			insert	into titulo_receber_trib(cd_tributo,
				dt_atualizacao,
				dt_atualizacao_nrec,
				dt_tributo,
				ie_origem_tributo,
				nm_usuario,
				nm_usuario_nrec,
				nr_lote_contabil,
				nr_sequencia,
				nr_titulo,
				tx_tributo,
				vl_base_adic,
				vl_base_calculo,
				vl_base_nao_retido,
				vl_trib_adic,
				vl_trib_nao_retido,
				vl_tributo,
				nr_seq_trans_financ)
			values (cd_tributo_w,
				clock_timestamp(),
				clock_timestamp(),
				clock_timestamp(),
				CASE WHEN ie_gerar_imposto_tit_w='D' THEN 'CD'  ELSE 'C' END ,
				nm_usuario_p,
				nm_usuario_p,
				nr_lote_contabil_w,
				nr_seq_tributo_w,
				nr_titulo_w,
				tx_tributo_w,
				0,
				vl_base_calculo_w,
				0,
				0,
				0,
				vl_imposto_w,
				nr_seq_trans_financ_w);

		end	loop;
		close	c02;

		/* sobra do rateio */

		update	titulo_receber_trib
		set	vl_tributo	= vl_tributo + coalesce(vl_adicional_w,0) - coalesce(vl_total_imposto_w,0)
		where	nr_sequencia	= nr_seq_tributo_w;

	else

		select	coalesce(max(a.vl_titulo),0)
		into STRICT	vl_base_calculo_w
		from	titulo_receber a
		where	a.nr_titulo	= nr_titulo_w;

		tx_tributo_w	:= (coalesce(vl_adicional_w,0) * 100) / vl_base_calculo_w;

		insert	into titulo_receber_trib(cd_tributo,
			dt_atualizacao,
			dt_atualizacao_nrec,
			dt_tributo,
			ie_origem_tributo,
			nm_usuario,
			nm_usuario_nrec,
			nr_lote_contabil,
			nr_seq_trans_financ,
			nr_sequencia,
			nr_titulo,
			tx_tributo,
			vl_base_adic,
			vl_base_calculo,
			vl_base_nao_retido,
			vl_trib_adic,
			vl_trib_nao_retido,
			vl_tributo)
		values (cd_tributo_w,
			clock_timestamp(),
			clock_timestamp(),
			clock_timestamp(),
			CASE WHEN ie_gerar_imposto_tit_w='D' THEN 'CD'  ELSE 'C' END ,
			nm_usuario_p,
			nm_usuario_p,
			nr_lote_contabil_w,
			nr_seq_trans_financ_w,
			nextval('titulo_receber_trib_seq'),
			nr_titulo_w,
			tx_tributo_w,
			0,
			vl_base_calculo_w,
			0,
			0,
			0,
			vl_adicional_w);

	end if;

end	loop;
close	c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_imposto_receb_tit_rec (nr_seq_retorno_p bigint, nm_usuario_p text) FROM PUBLIC;

