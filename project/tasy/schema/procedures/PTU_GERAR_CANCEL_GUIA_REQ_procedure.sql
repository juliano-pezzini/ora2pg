-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_gerar_cancel_guia_req ( nr_seq_pedido_cancel_p ptu_cancelamento.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, ie_tipo_resposta_p INOUT text, nr_seq_origem_p INOUT ptu_cancelamento.nr_seq_origem%type) AS $body$
DECLARE

 
nr_seq_cancel_wsd_w	pls_guia_motivo_cancel.nr_sequencia%type;
nr_seq_requisicao_w	pls_requisicao.nr_sequencia%type;

ie_tipo_resposta_w	varchar(5)	:= 'C';
ds_log_call_w		varchar(1500);
ds_observacao_w		varchar(4000);

C01 CURSOR( nr_seq_pedido_cancel_pc 	ptu_cancelamento.nr_sequencia%type) FOR 
	SELECT	nr_seq_execucao, 
		nr_seq_requisicao, 
		nr_seq_guia, 
		cd_unimed_executora, 
		nr_seq_origem, 
		(SELECT	max(b.nr_sequencia) 
		from	pls_guia_plano b 
		where	b.nr_seq_guia_principal = a.nr_seq_guia 
		and	b.ie_status <> '3') nr_seq_guia_plano, 
		(select	max(b.nr_seq_guia) 
		from	pls_execucao_req_item b 
		where	b.nr_seq_requisicao = a.nr_seq_requisicao) nr_seq_guia_exec, 
		(select	max(nr_sequencia) 
		from 	pls_guia_motivo_cancel 
		where 	ie_motivo_cancel_wsd = 'IC' 
		and	ie_situacao = 'A') nr_seq_motivo_cancel 
	from	ptu_cancelamento a 
	where	a.nr_sequencia = nr_seq_pedido_cancel_pc;

BEGIN 
 
--Carregar as informações da Guia e da Requisição 
for c01_w in C01( nr_seq_pedido_cancel_p ) loop 
	 
	nr_seq_origem_p	  := c01_w.nr_seq_origem;
	nr_seq_cancel_wsd_w := c01_w.nr_seq_motivo_cancel;
	 
	if ( coalesce(nr_seq_cancel_wsd_w::text, '') = '') then 
		select	max(nr_sequencia) 
		into STRICT 	nr_seq_cancel_wsd_w 
		from 	pls_guia_motivo_cancel;
	end if;
	 
	if (c01_w.nr_seq_requisicao IS NOT NULL AND c01_w.nr_seq_requisicao::text <> '') then 
	 
		select	max(nr_sequencia) 
		into STRICT	nr_seq_requisicao_w 
		from	pls_requisicao 
		where	nr_seq_guia_principal = c01_w.nr_seq_guia_exec 
		and	ie_estagio	not in (3,7);
 
		--Caso não exista registro de cancelamendo o sistema gera o mesmo 
		if ( coalesce(nr_seq_requisicao_w::text, '') = '' ) then 
			begin 
				CALL pls_cancelar_requisicao(c01_w.nr_seq_requisicao, nr_seq_cancel_wsd_w, '', nm_usuario_p, cd_estabelecimento_p);
				CALL pls_cancelar_guia_execut_scs(c01_w.nr_seq_requisicao, nm_usuario_p);
				CALL pls_requisicao_gravar_hist(c01_w.nr_seq_requisicao,'L','Recebido e processado o pedido de cancelamento da Unimed '||c01_w.cd_unimed_executora,null,nm_usuario_p);
			exception 
			when others then 
				ie_tipo_resposta_w	:= 'CI';
				ds_log_call_w := substr(pls_obter_detalhe_exec(false),1,1500);
				ds_observacao_w := 'Recebido e processado o pedido de cancelamento da Unimed '||c01_w.cd_unimed_executora||' porém não foi possível cancelar a requisição ' ||chr(13)||chr(10)||chr(13)||chr(10)||ds_log_call_w;
				CALL pls_requisicao_gravar_hist(c01_w.nr_seq_requisicao,'L',ds_observacao_w,null,nm_usuario_p);
			end;
		end if;
	elsif (c01_w.nr_seq_guia IS NOT NULL AND c01_w.nr_seq_guia::text <> '') then	 
	 
		--Caso não exista registro de cancelamendo o sistema gera o mesmo 
		if ( coalesce(c01_w.nr_seq_guia_plano::text, '') = '' ) then 
			begin 
				CALL pls_cancelar_autorizacao(c01_w.nr_seq_guia,nr_seq_cancel_wsd_w,nm_usuario_p,'I');
				CALL pls_guia_gravar_historico(c01_w.nr_seq_guia,nr_seq_cancel_wsd_w,'Recebido e processado o pedido de cancelamento da Unimed '||c01_w.cd_unimed_executora,'',nm_usuario_p);
			exception 
			when others then 
				ie_tipo_resposta_w	:= 'CI';
				ds_log_call_w := substr(pls_obter_detalhe_exec(false),1,1500);
				ds_observacao_w := 'Recebido e processado o pedido de cancelamento da Unimed '||c01_w.cd_unimed_executora||' porém não foi possível cancelar a guia '||chr(13)||chr(10)||chr(13)||chr(10)||ds_log_call_w;						
				CALL pls_guia_gravar_historico(c01_w.nr_seq_guia, nr_seq_cancel_wsd_w, ds_observacao_w,'',nm_usuario_p);
			end;
		end if;
	end if;
end loop;
 
ie_tipo_resposta_p := ie_tipo_resposta_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_gerar_cancel_guia_req ( nr_seq_pedido_cancel_p ptu_cancelamento.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, ie_tipo_resposta_p INOUT text, nr_seq_origem_p INOUT ptu_cancelamento.nr_seq_origem%type) FROM PUBLIC;

