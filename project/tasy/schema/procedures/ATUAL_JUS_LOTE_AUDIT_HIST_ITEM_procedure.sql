-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atual_jus_lote_audit_hist_item (nr_seq_guia_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_estabelecimento_w		smallint;
cd_convenio_w			integer;
nr_seq_lote_hist_w		bigint;
ie_atualiza_just_anl_ant_w 	varchar(1);
nr_seq_matpaci_atual_w		bigint;
nr_seq_propaci_atual_w		bigint;
nr_seq_atual_w			bigint;
ds_observacao_atual_w 		varchar(4000);

c01 CURSOR FOR
SELECT  nr_sequencia,
	nr_seq_matpaci,
	nr_seq_propaci,
	ds_observacao
from 	lote_audit_hist_item
where 	nr_seq_lote 	= nr_seq_lote_hist_w;


BEGIN

select	max(a.nr_seq_lote_hist),
	max(c.cd_estabelecimento),
	max(c.cd_convenio)
into STRICT	nr_seq_lote_hist_w,
	cd_estabelecimento_w,
	cd_convenio_w
from	lote_auditoria c,
	lote_audit_hist b,
	lote_audit_hist_guia a
where	b.nr_seq_lote_audit	= c.nr_sequencia
and	a.nr_seq_lote_hist	= b.nr_sequencia
and	a.nr_sequencia		= nr_seq_guia_p;

select	max(a.ie_atualiza_just_anl_ant)
into STRICT	ie_atualiza_just_anl_ant_w
from	convenio_estabelecimento a
where	a.cd_estabelecimento = cd_estabelecimento_w
and	a.cd_convenio = cd_convenio_w;


if (coalesce(ie_atualiza_just_anl_ant_w, 'N') <> 'N') then

	open c01;
		loop
			fetch c01 into
				nr_seq_atual_w,
				nr_seq_matpaci_atual_w,
				nr_seq_propaci_atual_w,
				ds_observacao_atual_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */

			if ((coalesce(ie_atualiza_just_anl_ant_w, 'N') = 'T') or
				((coalesce(ie_atualiza_just_anl_ant_w, 'N') = 'S') and (coalesce(ds_observacao_atual_w, 'X') = 'X'))) then

				update 	lote_audit_hist_item d
				set 	d.ds_observacao 	= (SELECT 	max(x.ds_observacao)
								from	lote_audit_hist_item x
								where 	x.nr_seq_lote 	= (select max(c.nr_sequencia)
											from	lote_audit_hist_item a,
											lote_audit_hist_guia b,
											lote_audit_hist c
											where	a.nr_Seq_guia 			= b.nr_Sequencia
												and	b.nr_Seq_lote_hist 	= c.nr_Sequencia
												and	((a.nr_seq_propaci	= nr_seq_propaci_atual_w or (nr_seq_matpaci = nr_seq_matpaci_atual_w))
												and 	c.nr_sequencia 		< nr_seq_lote_hist_w))
									and (x.nr_seq_propaci	= nr_seq_propaci_atual_w or x.nr_seq_matpaci = nr_seq_matpaci_atual_w))
				where d.nr_sequencia 	= nr_seq_atual_w;
			end if;
		end loop;
	close c01;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atual_jus_lote_audit_hist_item (nr_seq_guia_p bigint, nm_usuario_p text) FROM PUBLIC;

