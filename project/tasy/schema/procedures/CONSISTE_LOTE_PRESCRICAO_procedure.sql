-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_lote_prescricao ( nr_seq_lote_p bigint, nr_prescricao_p bigint, nm_usuario_p text, ds_erro_p INOUT text, ds_erro2_p INOUT text, ie_opcao_p text default null) AS $body$
DECLARE


ie_conta_aberta_w		varchar(1):= 'N';
ie_fim_conta_w			varchar(1);
dt_fim_conta_w			timestamp;
dt_alta_w			timestamp;
dt_atend_lote_w			timestamp;
dt_cancelamento_w		timestamp;
dt_validade_prescr_w		timestamp;
nr_atendimento_w		bigint;
ds_erro_w			varchar(255);
ds_erro2_w			varchar(255);
qt_reg_w			bigint;
nr_seq_turno_w			bigint;
ie_status_lote_w		varchar(3);
ie_hor_inicio_ultrapassado_w	varchar(1);
cd_estabelecimento_w		smallint;
varAtendAlta_w			varchar(1);
VarAtendAposValPrescr_w		varchar(1);
VarBaixaLoteSemAtend_w		varchar(1) := 'N';
cd_funcao_origem_w		integer;
ie_cpoe_segunda_ordem_w 	varchar(1) := 'N';


BEGIN
ds_erro_w:= '';

select 	max(nr_seq_turno),
	max(ie_status_lote)
into STRICT	nr_seq_turno_w,
	ie_status_lote_w
from 	ap_lote
where 	nr_sequencia = nr_seq_lote_p;

if (ie_status_lote_w <> 'G') then
	begin
	if (ie_status_lote_w = 'C') then
		ds_erro_w:= WHEB_MENSAGEM_PCK.get_texto(277908);
	elsif (ie_status_lote_w = 'CA') then
		ds_erro_w:= WHEB_MENSAGEM_PCK.get_texto(312788);		
	elsif (ie_status_lote_w = 'S') then
		ds_erro_w:= WHEB_MENSAGEM_PCK.get_texto(277910);
	else
		ds_erro_w:= WHEB_MENSAGEM_PCK.get_texto(277911);
	end if;
	end;
else
	select 	max(dt_atend_lote)
	into STRICT	dt_atend_lote_w
	from 	ap_lote
	where 	nr_sequencia = nr_seq_lote_p;	
	
	if (coalesce(nr_prescricao_p,0) = 0) then
		select	max(nr_atendimento)
		into STRICT	nr_atendimento_w
		from 	ap_lote
		where 	nr_sequencia = nr_seq_lote_p;
	end if;
	
	if (coalesce(nr_atendimento_w::text, '') = '') then
		select 	coalesce(max(nr_atendimento),0),
				coalesce(max(dt_validade_prescr),clock_timestamp()),
                coalesce(max(cd_funcao_origem),0)
		into STRICT	nr_atendimento_w,
				dt_validade_prescr_w,
                cd_funcao_origem_w
		from 	prescr_medica
		where 	nr_prescricao = nr_prescricao_p;
	end if;
	
	select 	max(ie_fim_conta),
		max(dt_fim_conta),
		max(dt_alta),
		max(cd_estabelecimento),
		max(dt_cancelamento)
	into STRICT	ie_fim_conta_w,
		dt_fim_conta_w,
		dt_alta_w,
		cd_estabelecimento_w,
		dt_cancelamento_w
	from	atendimento_paciente
	where	nr_atendimento = nr_atendimento_w;
	
	
	ie_hor_inicio_ultrapassado_w := Obter_Param_Usuario(7029, 12, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_hor_inicio_ultrapassado_w);
	varAtendAlta_w := Obter_Param_Usuario(7029, 17, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, varAtendAlta_w);
	VarAtendAposValPrescr_w := Obter_Param_Usuario(7029, 100, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, VarAtendAposValPrescr_w);
	VarBaixaLoteSemAtend_w := Obter_Param_Usuario(7029, 110, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, VarBaixaLoteSemAtend_w);
	if (ie_opcao_p = '388') then
		ie_hor_inicio_ultrapassado_w := Obter_Param_Usuario(88, 301, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_hor_inicio_ultrapassado_w);
	end if;
	
	if (ie_opcao_p = '388') and ((ie_hor_inicio_ultrapassado_w = 'S') or (ie_hor_inicio_ultrapassado_w = 'A')) and (dt_atend_lote_w > clock_timestamp()) then
		ds_erro2_w := wheb_mensagem_pck.get_texto(341187); -- Nao possui permissao para atender lotes com horario inicio futuro. Parametro [301].
	elsif	((ie_hor_inicio_ultrapassado_w = 'S') or (ie_hor_inicio_ultrapassado_w = 'A')) and (dt_atend_lote_w > clock_timestamp()) then			
		ds_erro2_w := wheb_mensagem_pck.get_texto(312825); -- Nao possui permissao para atender lotes com horario inicio futuro. Parametro [12]
	end if;

	if (VarBaixaLoteSemAtend_w = 'N') then
		if (ie_fim_conta_w <> 'F') and (coalesce(dt_fim_conta_w::text, '') = '') then
			ie_conta_aberta_w:= 'S';
		else
			ds_erro_w:= WHEB_MENSAGEM_PCK.get_texto(277913);
		end if;
	
		if (varAtendAlta_w = 'N') and  not(coalesce(dt_alta_w::text, '') = '') then
			ds_erro_w:= WHEB_MENSAGEM_PCK.get_texto(277914);
		end if;
	
		if (dt_cancelamento_w IS NOT NULL AND dt_cancelamento_w::text <> '') then
			ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(277915);
		end if;

		select  qt_reg
		into STRICT	ie_cpoe_segunda_ordem_w
		from (  SELECT  CASE WHEN count(nr_sequencia)=0 THEN  'N'  ELSE 'S' END  qt_reg
				from (  SELECT a.nr_sequencia
						from cpoe_material a
						where coalesce(a.dt_fim::text, '') = ''
                        and a.ie_duracao = 'C'
                        and exists ( select	1
									 from	prescr_medica y,
											prescr_material z
									 where y.nr_prescricao  = nr_prescricao_p
                                     and   y.nr_prescricao = z.nr_prescricao
									 and   y.nr_atendimento = a.nr_atendimento
									 and   z.nr_seq_mat_cpoe = a.nr_sequencia)

						
union

						select a.nr_sequencia
						from cpoe_dialise a
						where coalesce(a.dt_fim::text, '') = '' 
                        and a.ie_duracao = 'C'
                        and exists ( select	1
									 from	prescr_medica y,
											prescr_material z
									 where y.nr_prescricao  = nr_prescricao_p
                                     and   y.nr_prescricao = z.nr_prescricao
									 and   y.nr_atendimento = a.nr_atendimento
									 and   z.nr_seq_mat_cpoe = a.nr_sequencia)
						
union

						select a.nr_sequencia
						from cpoe_dieta a
						where coalesce(a.dt_fim::text, '') = '' 
                        and a.ie_duracao = 'C'
                        and exists (	select	1
									from	prescr_medica y
									where	y.nr_atendimento = a.nr_atendimento
									and		y.nr_prescricao = nr_prescricao_p
									and		exists (	select	1
														from	prescr_material z
														where	z.nr_prescricao  = nr_prescricao_p
                                                        and     z.nr_prescricao = y.nr_prescricao
														and		z.nr_seq_dieta_cpoe = a.nr_sequencia
														
union

														select	1
														from	prescr_dieta z
                                                        where	z.nr_prescricao  = nr_prescricao_p
                                                        and z.nr_prescricao = y.nr_prescricao
														and		z.nr_seq_dieta_cpoe = a.nr_sequencia
														
union

														select	1
														from	rep_jejum z
														where	z.nr_prescricao  = nr_prescricao_p
                                                        and 	z.nr_prescricao = y.nr_prescricao
														and		z.nr_seq_dieta_cpoe = a.nr_sequencia
														
union

														select	1
														from	prescr_leite_deriv z
														where	z.nr_prescricao  = nr_prescricao_p
                                                        and 	z.nr_prescricao = y.nr_prescricao
														and		z.nr_seq_dieta_cpoe = a.nr_sequencia
														
union

														select	1
														from	nut_pac z
														where	z.nr_prescricao  = nr_prescricao_p
                                                        and 	z.nr_prescricao = y.nr_prescricao
														and		z.nr_seq_npt_cpoe = a.nr_sequencia))
						
union

						select a.nr_sequencia
						from cpoe_gasoterapia a
						where coalesce(a.dt_fim::text, '') = '' 
                        and a.ie_duracao = 'C'
                        and exists ( select	1
                                     from	prescr_medica y,
                                            prescr_material z
                                     where y.nr_prescricao  = nr_prescricao_p
                                     and   y.nr_prescricao = z.nr_prescricao
                                     and   y.nr_atendimento = a.nr_atendimento
                                     and   z.nr_seq_mat_cpoe = a.nr_sequencia)
						
union

						select a.nr_sequencia
						from cpoe_recomendacao a
						where coalesce(a.dt_fim::text, '') = '' 
                        and a.ie_duracao = 'C'
                        and exists ( select	1
                                     from	prescr_medica y,
                                            prescr_material z
                                     where y.nr_prescricao  = nr_prescricao_p
                                     and   y.nr_prescricao = z.nr_prescricao
                                     and   y.nr_atendimento = a.nr_atendimento
                                     and   z.nr_seq_mat_cpoe = a.nr_sequencia)) alias12) alias13;
		
		if	((VarAtendAposValPrescr_w = 'N') and (dt_validade_prescr_w < clock_timestamp() and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> ''))
			and not(cd_funcao_origem_w = 2314 and ie_cpoe_segunda_ordem_w = 'S')) then
				ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(277917);
		end if;
	end if;
end if;

ds_erro_p:= ds_erro_w;
ds_erro2_p := ds_erro2_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_lote_prescricao ( nr_seq_lote_p bigint, nr_prescricao_p bigint, nm_usuario_p text, ds_erro_p INOUT text, ds_erro2_p INOUT text, ie_opcao_p text default null) FROM PUBLIC;

