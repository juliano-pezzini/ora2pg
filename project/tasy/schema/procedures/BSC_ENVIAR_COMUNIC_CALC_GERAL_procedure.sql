-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE bsc_enviar_comunic_calc_geral ( nr_seq_regra_comunic_p bigint, cd_periodo_p bigint, cd_ano_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE




nm_usuario_dest_w		varchar(4000);
nr_seq_regra_dest_w		bigint;
ds_titulo_w			varchar(255)	:= ' ';
ds_titulo_ww			varchar(255);
ds_comunicado_w			text;
ds_cabecalho_comunicado_w	varchar(255);
ds_setor_adicional_w		varchar(255);
ds_perfil_adicional_w		varchar(255);
nm_usuario_w			varchar(4000);
nm_usuario_ant_w		varchar(4000);



c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.cd_setor_atendimento,
	a.cd_perfil
from	bsc_regra_com_calc_dest a
where	a.nr_seq_regra_comunic	= nr_seq_regra_comunic_p
order by	coalesce(nm_usuario_dest, 'A'),
	coalesce(cd_perfil, 0),
	coalesce(cd_setor_atendimento, 0);


c02 CURSOR FOR
SELECT	a.nm_usuario_dest
from	bsc_regra_com_calc_dest a
where	a.nr_seq_regra_comunic	= nr_seq_regra_comunic_p
order by	coalesce(nm_usuario_dest, 'A'),
	coalesce(cd_perfil, 0),
	coalesce(cd_setor_atendimento, 0);



BEGIN

select	a.ds_comunicado,
	a.ds_titulo
into STRICT	ds_comunicado_w,
	ds_titulo_w
from	bsc_regra_comunic_calc a
where	a.nr_sequencia	= nr_seq_regra_comunic_p;


ds_comunicado_w		:= substr(ds_comunicado_w, 1, 2000);
--ds_titulo_ww		:= substr(ds_titulo_w || ' - Calculo dos indicadores do BSC - Per√≠odo '|| to_char(cd_periodo_p) || '/' ||to_char(cd_ano_p), 1, 255);
ds_titulo_ww		:= substr(ds_titulo_w || wheb_mensagem_pck.get_texto(299145, 'CD_PERIODO_P=' || to_char(cd_periodo_p) || ';CD_ANO_P=' || to_char(cd_ano_p)), 1, 255);


open c02;
loop
fetch c02 into
	nm_usuario_w;

EXIT WHEN NOT FOUND; /* apply on c02 */
	begin
	if ( coalesce(nm_usuario_ant_w::text, '') = '')then
		nm_usuario_ant_w := nm_usuario_w;
	else
		nm_usuario_ant_w := nm_usuario_ant_w || ',' || nm_usuario_w;
	end if;

end;
end loop;
close c02;

nm_usuario_dest_w := substr(nm_usuario_ant_w,1,4000);



open c01;
loop
fetch c01 into
	nr_seq_regra_dest_w,
	ds_setor_adicional_w,
	ds_perfil_adicional_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	CALL gerar_comunic_padrao(	clock_timestamp(),
					ds_titulo_ww,
					ds_comunicado_w,
					nm_usuario_p,
					null,
					nm_usuario_dest_w,
					'N',
					null,
					ds_perfil_adicional_w,
					cd_estabelecimento_p,
					ds_setor_adicional_w,
					clock_timestamp(),
					null,
					null);
end;
end loop;
close c01;




commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE bsc_enviar_comunic_calc_geral ( nr_seq_regra_comunic_p bigint, cd_periodo_p bigint, cd_ano_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

