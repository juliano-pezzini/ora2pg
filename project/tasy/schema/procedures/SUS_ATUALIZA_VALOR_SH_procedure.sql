-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_atualiza_valor_sh ( nr_seq_protocolo_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_interno_conta_w		bigint;
qt_registros_w			bigint;
qt_contador_pb_w		bigint;
				
c01 CURSOR FOR 
	SELECT	a.nr_interno_conta 
	from	conta_paciente a 
	where	a.nr_seq_protocolo	= nr_seq_protocolo_p 
	and	coalesce(a.ie_cancelamento::text, '') = '';	
 
type 		fetch_array is table of c01%rowtype;
s_array 	fetch_array;
i		integer := 1;
type vetor is table of fetch_array index by integer;
vetor_c01_w			vetor;
	
BEGIN 
 
select	count(1) 
into STRICT	qt_registros_w 
from	sus_regra_rateio_sh 
where	coalesce(ie_sus_unificado,'N')	= 'S'  LIMIT 1;
 
if (qt_registros_w	> 0)	then 
 
	qt_contador_pb_w := 0;
	CALL gravar_processo_longo(WHEB_MENSAGEM_PCK.get_texto(299371) ,'RECALCULAR_PROTOCOLO-Rateio SH',qt_contador_pb_w);	
	 
	open c01;
	loop 
	fetch c01 bulk collect into s_array limit 100000;
		vetor_c01_w(i) := s_array;
		i := i + 1;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	end loop;
	close c01;
	 
	for i in 1..vetor_c01_w.count loop 
		begin 
		s_array := vetor_c01_w(i);
		for z in 1..s_array.count loop 
			begin 
			 
			nr_interno_conta_w	:= s_array[z].nr_interno_conta;
			 
			qt_contador_pb_w := qt_contador_pb_w + 1;			
			CALL gravar_processo_longo(nr_interno_conta_w ,'RECALCULAR_PROTOCOLO-Rateio SH',qt_contador_pb_w);	
			/* Eliminar registros anteriores */
 
			delete	from w_conta_sus_sh 
			where	nr_interno_conta	= nr_interno_conta_w;
			/*Insere os valores na tabela w_conta_sus_sh*/
 
			CALL sus_gerar_itens_sh(nr_interno_conta_w,nm_usuario_p);
			/*Calcula os valores do Rateio*/
 
			CALL sus_calcula_valor_sh(nr_interno_conta_w,nm_usuario_p);
			/*Atualiza a Receita as Taxas*/
 
			CALL sus_atualiza_receita_sh(nr_interno_conta_w,nm_usuario_p);
			/*Atualizar os valores da Conta Paciente*/
 
			CALL sus_atualiza_itens_conpaci_sh(nr_interno_conta_w,nm_usuario_p);
			 
			commit;
			 
			CALL atualizar_valor_proc_sus(nr_interno_conta_w);
			 
			end;
		end loop;
		end;
	end loop;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_atualiza_valor_sh ( nr_seq_protocolo_p bigint, nm_usuario_p text) FROM PUBLIC;

