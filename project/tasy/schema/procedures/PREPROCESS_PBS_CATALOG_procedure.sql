-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE preprocess_pbs_catalog ( nr_pbs_version_p bigint, nm_usuario_p text) AS $body$
DECLARE


pbsimp_via_aplicacao_w			pbsimp_via_aplicacao%rowtype;
nr_count_w						pbsload_rdf.nr_sequencia%type;
ds_route_w          			pbsload_rdf.rdf_about%type;
ie_type_w           			constant pbsload_rdf.rdf_about%type := 'p:manner-of-administration';
nr_counter_w 					pbsload_rdf.nr_sequencia%type;



	c_pbsload_rdf CURSOR FOR
		SELECT p.rdf_about,
		p.ds_title
		from PBSLOAD_RDF p
		where p.NR_PBS_VERSION = nr_pbs_version_p and p.IE_TYPE = ie_type_w
		and p.RDF_ABOUT not like '%manner-of-administration';

BEGIN

	if (nr_pbs_version_p IS NOT NULL AND nr_pbs_version_p::text <> '' AND nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
		nr_counter_w := 0;

		<<process_route_desc>>
		for r_pbsload_rdf in c_pbsload_rdf loop

		ds_route_w := SUBSTR(r_pbsload_rdf.rdf_about,INSTR(r_pbsload_rdf.rdf_about, '/', -1)+1);

			select
			case when exists (select 1 from pbsimp_via_aplicacao where cd_via_aplicacao = ds_route_w)
			then 99
			else 0
			end
			into STRICT nr_count_w;

			if (nr_count_w = 0) then
			nr_counter_w := nr_counter_w + 1;

            pbsimp_via_aplicacao_w.dt_atualizacao 			:= clock_timestamp();
            pbsimp_via_aplicacao_w.nm_usuario 				:= nm_usuario_p;
            pbsimp_via_aplicacao_w.nr_pbs_version 			:= nr_pbs_version_p;
            pbsimp_via_aplicacao_w.cd_via_aplicacao 		:= ds_route_w;
            pbsimp_via_aplicacao_w.ds_via_aplicacao 		:= r_pbsload_rdf.ds_title;
            pbsimp_via_aplicacao_w.ie_situacao 			    := 'A';

            insert into pbsimp_via_aplicacao values (pbsimp_via_aplicacao_w.*);

			end if;

			if ( mod(nr_counter_w,500) = 0 ) then
				commit;
			end if;

		end loop process_route_desc;

		update pbsload_version set IE_PREPROCESS_STATUS = 1 where nr_sequencia = nr_pbs_version_p;

		commit;

	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE preprocess_pbs_catalog ( nr_pbs_version_p bigint, nm_usuario_p text) FROM PUBLIC;

