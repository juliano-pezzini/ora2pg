-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE finalizar_nc_curva_abc ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


ie_curva_atual_w			varchar(1);
ie_curva_segmento_w		varchar(1);
cd_material_w			bigint;
ds_segmento_ant_w		varchar(255);
ds_segmento_atual_w		varchar(255);
nr_seq_segmento_ant_w		bigint;
nr_seq_segmento_atual_w		bigint;
ds_log_w				varchar(4000);
ds_texto_w			varchar(255);

c01 CURSOR FOR
SELECT	a.cd_material,
	a.ie_curva_segmento,
	a.ie_curva_atual,
	a.nr_seq_segmento,
	a.nr_seq_segmento_atual
from	nc_curva_abc_item a
where	nr_seq_nc		= nr_sequencia_p
and	nr_seq_segmento_atual	> 0;


BEGIN

CALL Exec_Sql_Dinamico('Tasy', 'ALTER TRIGGER SEGMENTO_COMPRAS_ESTRUT_INSERT DISABLE');
ds_texto_w := substr(wheb_mensagem_pck.get_texto(310766),1,255);--TransferÃªncia de item entre segmentos
open C01;
loop
fetch C01 into
	cd_material_w,
	ie_curva_segmento_w,
	ie_curva_atual_w,
	nr_seq_segmento_ant_w,
	nr_seq_segmento_atual_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	substr(obter_desc_segmento_compras(nr_seq_segmento_ant_w),1,255),
		substr(obter_desc_segmento_compras(nr_seq_segmento_atual_w),1,255)
	into STRICT	ds_segmento_ant_w,
		ds_segmento_atual_w
	;

	delete from segmento_compras_estrut
	where	nr_seq_segmento = nr_seq_segmento_ant_w
	and	cd_material	= cd_material_w;

	insert into segmento_compras_estrut(
		nr_sequencia,
		nr_seq_segmento,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_material,
		ie_curva_abc)
	values (	nextval('segmento_compras_estrut_seq'),
		nr_seq_segmento_atual_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_material_w,
		ie_curva_atual_w);

	/*
	Esse item foi transferido para outro segmento.
	Segmento anterior: ds_segmento_ant_w
	Segmento atual: ds_segmento_atual_w
	Curva anterior: ie_curva_segmento_w
	Curva atual: ie_curva_atual_w
	*/
	ds_log_w	:=	substr(	wheb_mensagem_pck.get_texto(310765, 'DS_SEGMENTO_ANT_P='|| ds_segmento_ant_w ||
									';DS_SEGMENTO_ATUAL_P='|| ds_segmento_atual_w ||
									';IE_CURVA_SEGMENTO_P='|| ie_curva_segmento_w ||
									';IE_CURVA_ATUAL_P='|| ie_curva_atual_w ),1,4000);

	insert into log_material_nc_curva_abc(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ds_titulo,
		ds_log,
		cd_material,
		ie_curva_abc_ant,
		ie_curva_abc_atual,
		nr_seq_segmento_ant,
		nr_seq_segmento_atual)
	values (	nextval('log_material_nc_curva_abc_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		ds_texto_w,
		ds_log_w,
		cd_material_w,
		ie_curva_segmento_w,
		ie_curva_atual_w,
		nr_seq_segmento_ant_w,
		nr_seq_segmento_atual_w);

	end;
end loop;
close C01;

update	nc_curva_abc
set	dt_atualizacao_registro	= clock_timestamp(),
	nm_usuario_atualiz		= nm_usuario_p,
	dt_atualizacao		= clock_timestamp(),
	nm_usuario		= nm_usuario_p
where	nr_sequencia		= nr_sequencia_p;


CALL Exec_Sql_Dinamico('Tasy', 'ALTER TRIGGER SEGMENTO_COMPRAS_ESTRUT_INSERT ENABLE');

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE finalizar_nc_curva_abc ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

