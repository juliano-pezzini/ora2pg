-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE verifica_envio_comunic_opme ( ie_opcao_p text, cd_estabelecimento_p bigint, nr_sequencia_p bigint, nm_usuario_p text, ie_acao_p text) AS $body$
DECLARE

 
nr_cirurgia_w		bigint;
qt_agendamento_w	integer;
qt_agendamento_ww	integer;
qt_itens_opme_w		integer;
ie_status_agenda_w	varchar(3);


BEGIN 
if (ie_opcao_p = 'A') then 
	begin 
	select	count(*) 
	into STRICT	qt_agendamento_w 
	from	agenda_paciente 
	where	nr_sequencia = nr_sequencia_p 
	and	to_char(hr_inicio,'dd/mm/yyyy hh24:mi:ss') between to_char((clock_timestamp() + interval '1 days'),'dd/mm/yyyy hh24:mi:ss') and to_char((clock_timestamp() + interval '2 days'),'dd/mm/yyyy hh24:mi:ss');
 
	select	count(*) 
	into STRICT	qt_agendamento_ww 
	from	agenda_paciente 
	where	nr_sequencia = nr_sequencia_p 
	and	to_char(hr_inicio,'dd/mm/yyyy hh24:mi:ss') between to_char((clock_timestamp()),'dd/mm/yyyy hh24:mi:ss') and to_char((clock_timestamp() + interval '1 days'),'dd/mm/yyyy hh24:mi:ss');
 
	if (qt_agendamento_w > 0) then 
		CALL enviar_comunic_agend_int_opme(cd_estabelecimento_p,nr_sequencia_p,40,nm_usuario_p,'');
	end if;
 
	if (qt_agendamento_ww > 0) then 
		CALL enviar_comunic_agend_int_opme(cd_estabelecimento_p,nr_sequencia_p,41,nm_usuario_p,'');
	end if;
	end;
elsif (ie_opcao_p = 'B') then 
	begin 
	select	count(*) 
	into STRICT	qt_itens_opme_w 
	from	agenda_pac_desc_material 
	where	nr_seq_agenda = nr_sequencia_p;
	 
	if (qt_itens_opme_w > 0) then 
		CALL enviar_comunic_agend_int_opme(cd_estabelecimento_p,nr_sequencia_p,42,nm_usuario_p,'');
	end if;
	end;
elsif (ie_opcao_p = 'C') then 
	begin 
	CALL enviar_comunic_agend_int_opme(cd_estabelecimento_p,nr_sequencia_p,43,nm_usuario_p,'');
	end;
elsif (ie_opcao_p = 'D') then 
	begin 
	select	count(*) 
	into STRICT	qt_itens_opme_w 
	from	agenda_pac_desc_material 
	where	nr_seq_agenda = nr_sequencia_p;
	 
	if (qt_itens_opme_w > 0) then 
		CALL enviar_comunic_agend_int_opme(cd_estabelecimento_p,nr_sequencia_p,45,nm_usuario_p,'');
	end if;
	end;
elsif (ie_opcao_p = 'E') then 
	begin 
	select	count(*) 
	into STRICT	qt_itens_opme_w 
	from	agenda_pac_desc_material 
	where	nr_seq_agenda = nr_sequencia_p;
	 
	if (qt_itens_opme_w > 0) then 
		CALL enviar_comunic_agend_int_opme(cd_estabelecimento_p,nr_sequencia_p,44,nm_usuario_p,'');
	end if;
	end;
elsif (ie_opcao_p = 'F') then 
	begin 
	select	count(*) 
	into STRICT	qt_itens_opme_w 
	from	agenda_pac_desc_material 
	where	nr_seq_agenda = nr_sequencia_p;
	 
	if (qt_itens_opme_w > 0) then 
		if (coalesce(ie_acao_p,'A') = 'I') then 
			CALL enviar_comunic_agend_int_opme(cd_estabelecimento_p,nr_sequencia_p,46,nm_usuario_p,'S');
		else 
			CALL enviar_comunic_agend_int_opme(cd_estabelecimento_p,nr_sequencia_p,46,nm_usuario_p,'A');
		end if;
	end if;
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE verifica_envio_comunic_opme ( ie_opcao_p text, cd_estabelecimento_p bigint, nr_sequencia_p bigint, nm_usuario_p text, ie_acao_p text) FROM PUBLIC;

