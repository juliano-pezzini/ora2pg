-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_proced_material_conta (ie_procedimentos_p text, ie_medicamentos_p text, ie_diarias_p text, ie_servicos_p text, ie_materiais_p text, nr_interno_conta_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
dt_periodo_inicial_w	timestamp;
dt_periodo_final_w	timestamp;
dt_acerto_conta_w	timestamp;
nr_atendimento_w	bigint;
cd_convenio_parametro_w	bigint;


BEGIN 
select 	dt_acerto_conta, 
	nr_atendimento, 
	dt_periodo_inicial, 
	dt_periodo_final, 
	cd_convenio_parametro 
into STRICT	dt_acerto_conta_w, 
	nr_atendimento_w, 
	dt_periodo_inicial_w, 
	dt_periodo_final_w, 
	cd_convenio_parametro_w 
from	conta_paciente 
where	nr_interno_conta = nr_interno_conta_p;
 
UPDATE 	/*+ index (X Propaci_i1) */ PROCEDIMENTO_PACIENTE X 
SET 	X.DT_ACERTO_CONTA = dt_acerto_conta_w, 
	X.NR_INTERNO_CONTA = nr_interno_conta_p, 
	x.nm_usuario = nm_usuario_p, 
	x.dt_atualizacao = clock_timestamp() 
WHERE (coalesce(X.dt_acerto_conta::text, '') = '') 
AND (coalesce(X.nr_interno_conta::text, '') = '') 
AND (X.nr_atendimento = nr_atendimento_w) 
AND (coalesce(X.dt_acerto_convenio::text, '') = '') 
AND (coalesce(X.cd_motivo_exc_conta::text, '') = '') 
AND (X.dt_procedimento between dt_periodo_inicial_w and dt_periodo_final_w) 
AND (X.cd_convenio = cd_convenio_parametro_w) 
AND (upper(ie_procedimentos_p) = 'S' or X.CD_PROCEDIMENTO NOT IN (SELECT CD_PROCEDIMENTO FROM PROCEDIMENTO WHERE IE_CLASSIFICACAO = 1)) 
AND (upper(ie_servicos_p) = 'S' or X.CD_PROCEDIMENTO NOT IN (SELECT CD_PROCEDIMENTO FROM PROCEDIMENTO WHERE IE_CLASSIFICACAO = 2)) 
AND (upper(ie_diarias_p) = 'S' or X.CD_PROCEDIMENTO NOT IN (SELECT CD_PROCEDIMENTO FROM PROCEDIMENTO WHERE IE_CLASSIFICACAO = 3));
 
UPDATE 	/*+ index (X Matpaci_i1) */ MATERIAL_ATEND_PACIENTE X 
SET 	X.DT_ACERTO_CONTA = dt_acerto_conta_w, 
	X.NR_INTERNO_CONTA = nr_interno_conta_p, 
	x.nm_usuario = nm_usuario_p, 
	x.dt_atualizacao = clock_timestamp() 
WHERE (coalesce(X.nr_interno_conta::text, '') = '') 
AND (coalesce(X.cd_motivo_exc_conta::text, '') = '') 
AND (X.nr_atendimento = nr_atendimento_w) 
AND (X.dt_atendimento between dt_periodo_inicial_w and dt_periodo_final_w) 
AND (X.cd_convenio = cd_convenio_parametro_w) 
AND (upper(ie_materiais_p) = 'S' or X.CD_MATERIAL IN (SELECT CD_MATERIAL FROM MATERIAL WHERE IE_TIPO_MATERIAL < 2)) 
AND (upper(ie_medicamentos_p) = 'S' or X.CD_MATERIAL IN (SELECT CD_MATERIAL FROM MATERIAL WHERE IE_TIPO_MATERIAL > 1));
 
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_proced_material_conta (ie_procedimentos_p text, ie_medicamentos_p text, ie_diarias_p text, ie_servicos_p text, ie_materiais_p text, nr_interno_conta_p bigint, nm_usuario_p text) FROM PUBLIC;

