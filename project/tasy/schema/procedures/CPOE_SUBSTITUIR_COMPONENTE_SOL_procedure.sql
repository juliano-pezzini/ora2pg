-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_substituir_componente_sol ( nr_prescricao_p bigint, nr_seq_solucao_p bigint, cd_material_p material.cd_material%type) AS $body$
DECLARE


nr_sequencia_w				cpoe_material.nr_sequencia%type;
nr_seq_cpoe_ant_w			cpoe_material.nr_sequencia%type;
cd_material_w				cpoe_material.cd_material%type;
qt_dose_w					cpoe_material.qt_dose%type;
cd_unidade_medida_w			cpoe_material.cd_unidade_medida%type;
ds_dose_diferenciada_w		cpoe_material.ds_dose_diferenciada%type;
qt_volume_w					cpoe_material.qt_volume%type;
qt_dosagem_w				cpoe_material.qt_dosagem%type;
ie_tipo_dosagem_w			cpoe_material.ie_tipo_dosagem%type;
ds_orientacao_preparo_w		cpoe_material.ds_orientacao_preparo%type;
ie_tipo_informacao_w		varchar(10);

c01 CURSOR FOR
SELECT	a.cd_material,
		a.qt_dose,
		a.cd_unidade_medida_dose,
		a.ds_dose_diferenciada
from	prescr_material a
where	a.nr_prescricao = nr_prescricao_p
and		a.nr_sequencia_solucao = nr_seq_solucao_p
and		a.ie_agrupador = 4
and		coalesce(a.ie_suspenso,'N') = 'N'
and		not exists ( SELECT	1
					from	cpoe_material_v b
					where	b.nr_sequencia = a.nr_seq_mat_cpoe
					and		b.cd_material =  a.cd_material
					and		coalesce(b.qt_dose,0) = coalesce(a.qt_dose,0)
					and		coalesce(b.cd_unidade_medida,'XPTO') = coalesce(a.cd_unidade_medida_dose,'XPTO')
					and		coalesce(b.ds_dose_diferenciada,'XPTO') = coalesce(a.ds_dose_diferenciada,'XPTO'));
					


BEGIN

select	max(nr_seq_mat_cpoe)
into STRICT	nr_sequencia_w
from	prescr_material
where	nr_prescricao = nr_prescricao_p
and		nr_sequencia_solucao = nr_seq_solucao_p;

if (coalesce(nr_sequencia_w,0) > 0) then	
			
	open c01;
	loop
	fetch c01 into	cd_material_w,
					qt_dose_w,
					cd_unidade_medida_w,
					ds_dose_diferenciada_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		
		select	max(a.ie_tipo_item)
		into STRICT	ie_tipo_informacao_w
		from	cpoe_material_v a
		where	a.nr_sequencia = nr_sequencia_w
		and 	a.cd_material = cd_material_p;











		
		if (ie_tipo_informacao_w = 'MAT') then
			update	cpoe_material
			set		cd_material = cd_material_w,
					qt_dose = qt_dose_w,
					cd_unidade_medida = cd_unidade_medida_w,
					ds_dose_diferenciada = ds_dose_diferenciada_w
			where	nr_sequencia = nr_sequencia_w;
		elsif (ie_tipo_informacao_w = 'MDIL') then
			update	cpoe_material
			set		cd_mat_dil = cd_material_w,
					qt_dose_dil = qt_dose_w,
					cd_unid_med_dose_dil = cd_unidade_medida_w,
					ds_dose_diferenciada_dil = ds_dose_diferenciada_w
			where	nr_sequencia = nr_sequencia_w;
		elsif (ie_tipo_informacao_w = 'MRECONS') then
			update	cpoe_material
			set		cd_mat_recons = cd_material_w,
					qt_dose_recons = qt_dose_w,
					cd_unid_med_dose_recons = cd_unidade_medida_w,
					ds_dose_diferenciada_rec = ds_dose_diferenciada_w
			where	nr_sequencia = nr_sequencia_w;
		elsif (ie_tipo_informacao_w = 'MRED') then
			update	cpoe_material
			set		cd_mat_red = cd_material_w,
					qt_dose_red = qt_dose_w,
					cd_unid_med_dose_red = cd_unidade_medida_w,
					ds_dose_diferenciada_red = ds_dose_diferenciada_w
			where	nr_sequencia = nr_sequencia_w;
		elsif (ie_tipo_informacao_w = 'MCOMP1') then
			update	cpoe_material
			set		cd_mat_comp1 = cd_material_w,
					qt_dose_comp1 = qt_dose_w,
					cd_unid_med_dose_comp1 = cd_unidade_medida_w,
					ds_dose_diferenciada_comp1 = ds_dose_diferenciada_w
			where	nr_sequencia = nr_sequencia_w;
		elsif (ie_tipo_informacao_w = 'MCOMP2') then
			update	cpoe_material
			set		cd_mat_comp2 = cd_material_w,
					qt_dose_comp2 = qt_dose_w,
					cd_unid_med_dose_comp2 = cd_unidade_medida_w,
					ds_dose_diferenciada_comp2 = ds_dose_diferenciada_w
			where	nr_sequencia = nr_sequencia_w;
		elsif (ie_tipo_informacao_w = 'MCOMP3') then
			update	cpoe_material
			set		cd_mat_comp3 = cd_material_w,
					qt_dose_comp3 = qt_dose_w,
					cd_unid_med_dose_comp3 = cd_unidade_medida_w,
					ds_dose_diferenciada_comp3 = ds_dose_diferenciada_w
			where	nr_sequencia = nr_sequencia_w;	
		elsif (ie_tipo_informacao_w = 'MCOMP4') then
			update	cpoe_material
			set		cd_mat_comp4 = cd_material_w,
					qt_dose_comp4 = qt_dose_w,
					cd_unid_med_dose_comp4 = cd_unidade_medida_w,
					ds_dose_diferenciada_comp4 = ds_dose_diferenciada_w
			where	nr_sequencia = nr_sequencia_w;	
		elsif (ie_tipo_informacao_w = 'MCOMP5') then
			update	cpoe_material
			set		cd_mat_comp5 = cd_material_w,
					qt_dose_comp5 = qt_dose_w,
					cd_unid_med_dose_comp5 = cd_unidade_medida_w,
					ds_dose_diferenciada_comp5 = ds_dose_diferenciada_w
			where	nr_sequencia = nr_sequencia_w;	
		elsif (ie_tipo_informacao_w = 'MCOMP6') then
			update	cpoe_material
			set		cd_mat_comp6 = cd_material_w,
					qt_dose_comp6 = qt_dose_w,
					cd_unid_med_dose_comp6 = cd_unidade_medida_w,
					ds_dose_diferenciada_comp6 = ds_dose_diferenciada_w
			where	nr_sequencia = nr_sequencia_w;	
		end if;
		end;
	end loop;
	close c01;
	
	select 	max(CPOE_obter_diluicao(ie_tipo_solucao, qt_volume_adep, qt_tempo_aplicacao, cd_intervalo, nr_etapas, qt_dosagem, qt_solucao_total, null, qt_hora_fase, ie_tipo_dosagem, 'I')),
			max(qt_volume_adep),
			max(qt_dosagem),
			max(ie_tipo_dosagem)
	into STRICT	ds_orientacao_preparo_w,
			qt_volume_w,
			qt_dosagem_w,
			ie_tipo_dosagem_w
	from	prescr_solucao
	where	nr_prescricao = nr_prescricao_p
	and		nr_seq_solucao = nr_seq_solucao_p;

	update	cpoe_material
	set		qt_volume = qt_volume_w,
			qt_dosagem = qt_dosagem_w,
			ie_tipo_dosagem = ie_tipo_dosagem_w,
			ds_orientacao_preparo = ds_orientacao_preparo_w,
			ds_ref_calculo = ds_orientacao_preparo_w
	where	nr_sequencia = nr_sequencia_w;
	
	commit;
end if;				
				
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_substituir_componente_sol ( nr_prescricao_p bigint, nr_seq_solucao_p bigint, cd_material_p material.cd_material%type) FROM PUBLIC;

