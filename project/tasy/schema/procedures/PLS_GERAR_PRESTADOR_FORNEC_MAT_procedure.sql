-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_prestador_fornec_mat ( cd_cgc_p text, cd_fornecedor_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_reg_pj_w		bigint;
dt_inclusao_w		timestamp;
ie_situacao_w		varchar(1);
qt_reg_prestador_w	bigint;
nr_seq_fornecedor_w	bigint;


BEGIN

if (length(cd_cgc_p) = 14) then
	select	count(*)
	into STRICT	qt_reg_pj_w
	from	pessoa_juridica
	where	cd_cgc	= cd_cgc_p;

	select	count(*)
	into STRICT	qt_reg_prestador_w
	from	pls_prestador
	where	cd_cgc	= cd_cgc_p;

	select	dt_inclusao,
		ie_situacao,
		nr_sequencia
	into STRICT	dt_inclusao_w,
		ie_situacao_w,
		nr_seq_fornecedor_w
	from	pls_fornec_mat_fed_sc
	where	cd_fornecedor	= cd_fornecedor_p;

	if (coalesce(dt_inclusao_w::text, '') = '') then
		CALL pls_inserir_inco_forn_material(nr_seq_fornecedor_w,'PR','Problemas ao cadastrar a data de inclusÃ£o do prestador fornecedor.',nm_usuario_p);
	end if;
	if (qt_reg_pj_w > 0) and (qt_reg_prestador_w = 0) and (dt_inclusao_w IS NOT NULL AND dt_inclusao_w::text <> '') then
		insert into pls_prestador(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
				cd_estabelecimento,dt_cadastro,ie_abramge,ie_tipo_relacao,ie_situacao,
				ie_tipo_vinculo,ie_regra_data_preco_proc,ie_regra_data_preco_taxas,ie_regra_data_preco_diaria,
				ie_regra_data_preco_pacote,ie_regra_data_preco_mat,ie_guia_medico,ie_ptu_a400,ie_acidente_trabalho,
				ie_urgencia_emergencia,ie_tabela_propria,ie_prestador_alto_custo,cd_cgc,ie_tipo_endereco, cd_prestador)
		values (	nextval('pls_prestador_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
				cd_estabelecimento_p,dt_inclusao_w,'N','F',ie_situacao_w,
				'C','E','E','E',
				'E','E','S','N','N',
				'N','N','N',cd_cgc_p,'PJ',cd_fornecedor_p);
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_prestador_fornec_mat ( cd_cgc_p text, cd_fornecedor_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

