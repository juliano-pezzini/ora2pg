-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE generate_dmb_analysis_history ( nr_seq_ordem_serv_p man_ordem_servico.nr_sequencia%type, ie_potencial_safety_p man_ordem_servico.ie_potencial_safety%type, ie_potencial_security_p man_ordem_servico.ie_potencial_security%type, ie_potencial_privacy_p man_ordem_servico.ie_potencial_privacy%type, ie_classificacao_p man_ordem_servico.ie_classificacao%type, nm_usuario_p man_ordem_servico.nm_usuario%type) is new_line_w varchar(2) DEFAULT chr(13) || chr(10) RETURNS varchar AS $body$
BEGIN
		return 	case ie_resposta_pp
			when 'S' then obter_desc_expressao_idioma(327113, 'Yes', 5) || '. ' || ds_justificativa_pp
			when 'N' then PERFORM obter_desc_expressao_idioma(327114, 'No', 5) || '.'
			else PERFORM obter_desc_expressao_idioma(344145, 'N/A', 5) || '.'
			end;
	end;

	procedure insert_history_assesssment(
			nr_seq_tipo_pp 		number,
			ds_relat_tecnico_pp 	varchar2) is
		ds_tipo_w		man_tipo_hist.ds_tipo%type;
		ds_mensagem_w		varchar2(4000);
		ie_atualiza_os_w	varchar2(1 char);
	begin
		select	ds_tipo
		into STRICT	ds_tipo_w
		from	man_tipo_hist
		where	nr_sequencia = nr_seq_tipo_pp;
		
		if (ds_tipo_w IS NOT NULL AND ds_tipo_w::text <> '') then
			ds_mensagem_w	:= ds_tipo_w || CHR(10) || CHR(13) || CHR(10) || CHR(13);
		end if;
		ds_mensagem_w := ds_mensagem_w || ds_relat_tecnico_pp;

		CALL man_gravar_historico_ordem(
				nr_seq_ordem_serv_p 	=> nr_seq_ordem_serv_p,
				dt_liberacao_p 		=> clock_timestamp(),
				ds_relat_tecnico_p 	=> ds_mensagem_w,
				ie_origem_p 		=> 'I',
				nr_seq_tipo_p 		=> nr_seq_tipo_pp,
				nm_usuario_p 		=> nm_usuario_p);

		ie_atualizar_os_p 	=> ie_atualiza_os_w := man_update_os_stage(
				nr_seq_tipo_hist_p 	=> nr_seq_tipo_pp, nr_seq_ordem_p 		=> nr_seq_ordem_serv_p, ie_atualizar_os_p 	=> ie_atualiza_os_w);				
	end;

	function get_text_dmb_analysis(
			ie_potencial_safety_p		man_ordem_servico.ie_potencial_safety%type,
			ie_potencial_security_p		man_ordem_servico.ie_potencial_security%type,
			ie_potencial_privacy_p		man_ordem_servico.ie_potencial_privacy%type,
			ie_classificacao_p		man_ordem_servico.ie_classificacao%type) return varchar2 is
	begin
	return obter_desc_expressao_idioma(9511491, 'DMB classifies this anomaly as:', 5) || new_line_w || new_line_w || new_line_w
	|| obter_desc_expressao_idioma(325936, 'Classification:', 5) || ' ' 
	|| coalesce(obter_valor_dominio_idioma(1149, ie_classificacao_p, 5), obter_desc_expressao_idioma(344145, 'N/A', 5)) || new_line_w || new_line_w 
	|| obter_desc_expressao_idioma(959754, 'Potential risk to patient safety?', 5) || ' '
	|| get_text_answer_assessment(ie_potencial_safety_p, '') || new_line_w || new_line_w
	|| obter_desc_expressao_idioma(959756, 'Potential risk to product security?', 5) || ' '
	|| get_text_answer_assessment(ie_potencial_security_p, '') || new_line_w || new_line_w
	|| obter_desc_expressao_idioma(959758, 'Potential risk to data privacy?', 5) || ' '
	|| get_text_answer_assessment(ie_potencial_privacy_p, '');
	end;
	
begin
	insert_history_assesssment(245, get_text_dmb_analysis(ie_potencial_safety_p, ie_potencial_security_p, ie_potencial_privacy_p, ie_classificacao_p)); -- DMB Analysis
	commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE generate_dmb_analysis_history ( nr_seq_ordem_serv_p man_ordem_servico.nr_sequencia%type, ie_potencial_safety_p man_ordem_servico.ie_potencial_safety%type, ie_potencial_security_p man_ordem_servico.ie_potencial_security%type, ie_potencial_privacy_p man_ordem_servico.ie_potencial_privacy%type, ie_classificacao_p man_ordem_servico.ie_classificacao%type, nm_usuario_p man_ordem_servico.nm_usuario%type) is new_line_w varchar(2) DEFAULT chr(13) || chr(10) FROM PUBLIC;

