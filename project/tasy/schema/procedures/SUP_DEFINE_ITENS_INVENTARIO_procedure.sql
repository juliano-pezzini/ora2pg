-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sup_define_itens_inventario (ie_opcao_p text, nr_seq_inventario_p bigint, nr_seq_item_invent_p bigint, ie_coluna_contagem_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE




qt_contagem_w		inventario_material.qt_contagem%type;
qt_seg_contagem_w	inventario_material.qt_recontagem%type;
qt_terc_contagem_w	inventario_material.qt_seg_recontagem%type;
qt_quarta_contagem_w	inventario_material.qt_terc_recontagem%type;
ie_contagem_atual_w	inventario.ie_contagem_atual%type;
qt_inventario_w		inventario_material.qt_inventario%type;
qt_total_w		bigint;
ie_define_sem_cont_w	varchar(1);
ie_avanca_contagem_w	varchar(1);
ds_erro_w		varchar(4000);
authorized_count_w smallint;
qt_invetario_count_w smallint;
qt_invetario_count_wp smallint;


BEGIN

if (nr_seq_inventario_p IS NOT NULL AND nr_seq_inventario_p::text <> '') then
	ie_define_sem_cont_w := obter_param_usuario(143, 47, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_define_sem_cont_w);

	if (ie_opcao_p = 'I' and (nr_seq_item_invent_p IS NOT NULL AND nr_seq_item_invent_p::text <> '')) then
		if (coalesce(ie_define_sem_cont_w,'S') <> 'S') then
			select	max(a.qt_contagem),
				max(a.qt_recontagem),
				max(a.qt_seg_recontagem),
				max(a.qt_terc_recontagem),
				coalesce(max(b.ie_contagem_atual),'0')
			into STRICT	qt_contagem_w,
				qt_seg_contagem_w,
				qt_terc_contagem_w,
				qt_quarta_contagem_w,
				ie_contagem_atual_w
			from	inventario_material a,
				inventario b
			where	a.nr_seq_inventario = b.nr_sequencia
			and	a.nr_sequencia = nr_seq_item_invent_p;
			
			if ((ie_contagem_atual_w = '1' and coalesce(qt_contagem_w::text, '') = '')
				or (ie_contagem_atual_w = '2' and coalesce(qt_seg_contagem_w::text, '') = '')
				or (ie_contagem_atual_w = '3' and coalesce(qt_terc_contagem_w::text, '') = '')
				or (ie_contagem_atual_w = '4' and coalesce(qt_quarta_contagem_w::text, '') = '')) then
				
				CALL wheb_mensagem_pck.exibir_mensagem_abort(175688);
			end if;
		end if;
		
		CALL definir_inventario(nr_seq_inventario_p,nr_seq_item_invent_p,nm_usuario_p);
		
		select	max(qt_inventario)
		into STRICT	qt_inventario_w
		from	inventario_material
		where	nr_sequencia = nr_seq_item_invent_p;
		
		if (coalesce(qt_inventario_w::text, '') = '') then
			
			CALL wheb_mensagem_pck.exibir_mensagem_abort(175690);
		end if;
		
	elsif (ie_opcao_p = 'C' and (nr_seq_item_invent_p IS NOT NULL AND nr_seq_item_invent_p::text <> '')) then
		CALL definir_inventario_contagem(
					nm_usuario_p		=> nm_usuario_p,
					cd_estabelecimento_p	=> cd_estabelecimento_p,
					nr_seq_inventario_p	=> nr_seq_inventario_p,
					nr_seq_item_p		=> nr_seq_item_invent_p,
					ie_coluna_contagem_p	=> ie_coluna_contagem_p,
					ie_estoque_lote_p	=> null);

		select	max(qt_inventario)
		into STRICT	qt_inventario_w
		from	inventario_material
		where	nr_sequencia = nr_seq_item_invent_p;
		
		if (coalesce(qt_inventario_w::text, '') = '') then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(175690);
		end if;
	elsif (ie_opcao_p = 'T') then
		ie_avanca_contagem_w := obter_param_usuario(143, 339, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_avanca_contagem_w);
		
		if (coalesce(ie_define_sem_cont_w,'S') <> 'S') then
			select	coalesce(max(ie_contagem_atual),'0')
			into STRICT	ie_contagem_atual_w
			from	inventario
			where	nr_sequencia = nr_seq_inventario_p;
			
			select 	count(*) qt_total
			into STRICT	qt_total_w
			from 	inventario_material
			where 	nr_seq_inventario = nr_seq_inventario_p;
			
			select 	coalesce(count(*),0) qt_contagem
			into STRICT	qt_contagem_w
			from 	inventario_material
			where 	coalesce(qt_contagem::text, '') = '' 
			and 	coalesce(qt_inventario::text, '') = '' 
			and 	nr_seq_inventario = nr_seq_inventario_p;
			
			if (qt_contagem_w > 0 and qt_contagem_w < qt_total_w and ie_contagem_atual_w = '1') then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(175715);
			end if;
			
			select 	count(*) qt_recontagem
			into STRICT	qt_seg_contagem_w
			from 	inventario_material
			where 	coalesce(qt_recontagem::text, '') = '' 
			and 	coalesce(qt_inventario::text, '') = '' 
			and 	nr_seq_inventario = nr_seq_inventario_p;
			
			if (qt_seg_contagem_w > 0 and qt_seg_contagem_w < qt_total_w and ie_contagem_atual_w = '2') then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(175715);
			end if;
			
			select 	count(*) qt_seg_recontagem
			into STRICT	qt_terc_contagem_w
			from 	inventario_material
			where 	coalesce(qt_seg_recontagem::text, '') = '' 
			and 	coalesce(qt_inventario::text, '') = '' 
			and 	nr_seq_inventario = nr_seq_inventario_p;
			
			if (qt_terc_contagem_w > 0 and qt_terc_contagem_w < qt_total_w and ie_contagem_atual_w = '3') then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(175715);
			end if;
			
			select 	count(*) qt_terc_recontagem
			into STRICT	qt_quarta_contagem_w
			from 	inventario_material
			where 	coalesce(qt_terc_recontagem::text, '') = '' 
			and 	coalesce(qt_inventario::text, '') = '' 
			and 	nr_seq_inventario = nr_seq_inventario_p;
			
			if (qt_quarta_contagem_w > 0 and qt_quarta_contagem_w < qt_total_w and ie_contagem_atual_w = '4') then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(175715);
			end if;
		end if;
		
		CALL definir_inventario(nr_seq_inventario_p,null,nm_usuario_p);
		
		if (coalesce(ie_avanca_contagem_w,'N') = 'S') then
			if (coalesce(ie_contagem_atual_w,'0') = '0') then
				CALL atualizar_contagem_atual_inv(nr_seq_inventario_p,1);
			else
				ds_erro_w := sup_consistir_alterar_contagem(nr_seq_inventario_p, (ie_contagem_atual_w)::numeric  + 1, nm_usuario_p, ds_erro_w);
				
				if (coalesce(ds_erro_w,'') <> '') then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_erro_w);
				end if;
			end if;
			
			CALL alterar_coluna_inventario(nr_seq_inventario_p,(ie_contagem_atual_w)::numeric  + 1,nm_usuario_p);
		end if;
	end if;
	
	SELECT  COUNT(*) into STRICT authorized_count_w
	FROM SUP_AUTORIZA_INVENTARIO a ,
		USUARIO b
	WHERE b.nm_usuario                = nm_usuario_p
	AND a.IE_TIPO_INVENTARIO         IN ('B','A')
	AND a.DT_INICIO                  <=clock_timestamp()
	AND coalesce(IE_AUTOMATIC_APPROVAL,'N')='S'
	AND a.DT_FINAL                   >= clock_timestamp()
	AND a.CD_PESSOA_AUTORIZADA        =b.CD_PESSOA_FISICA;
	
	if (authorized_count_w > 0) then
        select count(*) into STRICT qt_invetario_count_w from inventario_material where nr_seq_inventario = nr_seq_inventario_p;
        select count(*) into STRICT qt_invetario_count_wp from inventario_material where nr_seq_inventario=nr_seq_inventario_p and (qt_inventario IS NOT NULL AND qt_inventario::text <> '');
             if (qt_invetario_count_w=qt_invetario_count_wp)then
                 ds_erro_w := SUP_APROVAR_INVENTARIO(nr_seq_inventario_p, nm_usuario_p, cd_estabelecimento_p, ds_erro_w);
            end if;
	end if;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_define_itens_inventario (ie_opcao_p text, nr_seq_inventario_p bigint, nr_seq_item_invent_p bigint, ie_coluna_contagem_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

