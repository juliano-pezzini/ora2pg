-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_seq_assinatura (nr_seq_assinatura_p bigint, nr_prescricao_p bigint, nr_seq_item_p bigint, ie_tipo_item_p text, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w	bigint;
nr_sequencia_pendencia_w 	pep_item_pendente.nr_sequencia%type;


BEGIN

if (coalesce(nr_seq_assinatura_p,0) > 0) and (coalesce(nr_prescricao_p,0) > 0) and (coalesce(nr_seq_item_p,0) > 0) and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') then

	if (ie_tipo_item_p = 'O') then

		select	max(nr_sequencia)
		into STRICT    nr_sequencia_pendencia_w
		from 	pep_item_pendente
		where   nr_prescricao = nr_prescricao_p
		and     nr_seq_gasoterapia = nr_seq_item_p
		and     ie_tipo_pendencia = 'A';

		select 	max(nr_sequencia)
		into STRICT	nr_sequencia_w
		from 	prescr_gasoterapia_evento
		where	nr_seq_gasoterapia = nr_seq_item_p
		and 	ie_evento = 'SH';

		if (coalesce(nr_sequencia_w,0) > 0) then

			update 	prescr_gasoterapia_evento
			set		nr_seq_assinatura = nr_seq_assinatura_p
			where	nr_sequencia = nr_sequencia_w;
		end if;
	elsif (ie_tipo_item_p in ('SOL','SNE','NAN','NPN','HM')) then

		if (ie_tipo_item_p = 'SOL') then

		    select	max(nr_sequencia)
			into STRICT    nr_sequencia_pendencia_w
			from 	pep_item_pendente
			where   nr_prescricao = nr_prescricao_p
			and     nr_seq_solucao = nr_seq_item_p
			and     ie_tipo_pendencia = 'A';

			select 	max(nr_sequencia)
			into STRICT	nr_sequencia_w
			from 	prescr_solucao_evento
			where	nr_prescricao = nr_prescricao_p
			and		nr_seq_solucao = nr_seq_item_p
			and 	ie_alteracao = 10;
		elsif (ie_tipo_item_p = 'SNE') then

			select 	max(nr_sequencia)
			into STRICT	nr_sequencia_w
			from 	prescr_solucao_evento
			where	nr_prescricao = nr_prescricao_p
			and		nr_seq_material = nr_seq_item_p
			and 	ie_alteracao = 10;
		elsif (ie_tipo_item_p in ('NAN','NPN')) then

			select	max(nr_sequencia)
			into STRICT    nr_sequencia_pendencia_w
			from 	pep_item_pendente
			where   nr_prescricao = nr_prescricao_p
			and     nr_seq_nut_prot = nr_seq_item_p
			and     ie_tipo_pendencia = 'A';

			select 	max(nr_sequencia)
			into STRICT	nr_sequencia_w
			from 	prescr_solucao_evento
			where	nr_prescricao = nr_prescricao_p
			and		nr_seq_nut_neo = nr_seq_item_p
			and 	ie_alteracao = 10;
		elsif (ie_tipo_item_p = 'HM') then

			select 	max(nr_sequencia)
			into STRICT	nr_sequencia_w
			from 	prescr_solucao_evento
			where	nr_prescricao = nr_prescricao_p
			and		nr_seq_procedimento = nr_seq_item_p
			and 	ie_alteracao = 10;
		end if;

		if (coalesce(nr_sequencia_w,0) > 0) then

			update 	prescr_solucao_evento
			set		nr_seq_assinatura = nr_seq_assinatura_p
			where	nr_sequencia = nr_sequencia_w;
		end if;
	elsif (ie_tipo_item_p in ('S','M','MAT','R','P','D','L','J')) then

		if (ie_tipo_item_p in ('S','M','MAT','D','J')) then

			select 	max(nr_sequencia)
			into STRICT	nr_sequencia_w
			from 	prescr_mat_alteracao
			where	nr_prescricao = nr_prescricao_p
			and		nr_seq_prescricao = nr_seq_item_p
			and 	ie_alteracao = 13;
		elsif (ie_tipo_item_p = 'R') then

			select	max(nr_sequencia)
			into STRICT    nr_sequencia_pendencia_w
			from 	pep_item_pendente
			where   nr_prescricao = nr_prescricao_p
			and     nr_seq_recomendacao = nr_seq_item_p
			and     ie_tipo_pendencia = 'A';

			select 	max(nr_sequencia)
			into STRICT	nr_sequencia_w
			from 	prescr_mat_alteracao
			where	nr_prescricao = nr_prescricao_p
			and		nr_seq_recomendacao = nr_seq_item_p
			and 	ie_alteracao = 13;
		elsif (ie_tipo_item_p in ('P', 'L')) then

			select 	max(nr_sequencia)
			into STRICT	nr_sequencia_w
			from 	prescr_mat_alteracao
			where	nr_prescricao = nr_prescricao_p
			and		nr_seq_procedimento = nr_seq_item_p
			and 	ie_alteracao = 13;
		end if;

		if (coalesce(nr_sequencia_w,0) > 0) then

			update 	prescr_mat_alteracao
			set		nr_seq_assinatura = nr_seq_assinatura_p
			where	nr_sequencia = nr_sequencia_w;

			if (ie_tipo_item_p in ('M','MAT','SNE','S')) then
				select	max(nr_sequencia)
				into STRICT    nr_sequencia_pendencia_w
				from 	pep_item_pendente
				where   nr_prescricao = nr_prescricao_p
				and     nr_seq_material_rep = nr_seq_item_p
				and     ie_tipo_pendencia = 'A';

			elsif (ie_tipo_item_p in ('P','L','HM')) then
				select	max(nr_sequencia)
				into STRICT    nr_sequencia_pendencia_w
				from 	pep_item_pendente
				where   nr_prescricao = nr_prescricao_p
				and     nr_seq_proced_rep = nr_seq_item_p
				and     ie_tipo_pendencia = 'A';
		    end if;

			if (coalesce(nr_sequencia_pendencia_w,0) > 0) then
				CALL registrar_assinatura_item_rep(nr_sequencia_pendencia_w,nr_prescricao_p,nm_usuario_p);
			end if;

		end if;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_seq_assinatura (nr_seq_assinatura_p bigint, nr_prescricao_p bigint, nr_seq_item_p bigint, ie_tipo_item_p text, nm_usuario_p text) FROM PUBLIC;

