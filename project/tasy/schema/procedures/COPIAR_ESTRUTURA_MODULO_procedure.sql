-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_estrutura_modulo ( area_sequence_p bigint, nr_seq_produto_area_p bigint, nr_seq_area_modulo_p bigint, nm_usuario_p text, modulo_sequence_p INOUT bigint) AS $body$
DECLARE

    nr_seq_area_w		mkt_area_modulo.nr_seq_area%type;
    nr_seq_modulo_w		mkt_area_modulo.nr_seq_modulo%type;
    ds_area_modulo_w    	mkt_area_modulo.ds_area_modulo%type;
    nr_seq_produto_w    	mkt_produto_area.nr_seq_produto%type;
    mkt_modulo_mercado_seq_w	mkt_modulo_mercado.nr_sequencia%type;

	C01 CURSOR FOR
	SELECT	a.nr_seq_mercado,
		a.nr_sequencia
	from	mkt_modulo_mercado a
	where	a.nr_seq_modulo = nr_seq_area_modulo_p
	and	a.nr_seq_mercado not in ((	SELECT	b.nr_seq_mercado
						from	mkt_modulo_mercado b
						where	b.nr_seq_modulo = modulo_sequence_p));
						

	C02 CURSOR FOR
	SELECT	a.nr_seq_mercado,
		a.nr_sequencia,
		mkt.nr_sequencia nr_modulo_mercado_antigo
	from	mkt_modulo_mercado a,
		(	SELECT	b.nr_seq_mercado,
			b.nr_sequencia
			from	mkt_modulo_mercado b
			where	b.nr_seq_modulo = nr_seq_area_modulo_p) mkt
	where	a.nr_seq_modulo = modulo_sequence_p
	and	a.nr_seq_mercado in (mkt.nr_seq_mercado);

BEGIN

	select	nr_seq_produto
	into STRICT	nr_seq_produto_w
	from	mkt_produto_area
	where	nr_sequencia = area_sequence_p;

	select	max(nr_seq_area),
		max(nr_seq_modulo),
		max(ds_area_modulo)
	into STRICT    nr_seq_area_w,
		nr_seq_modulo_w,
		ds_area_modulo_w
	from	mkt_area_modulo
	where	nr_seq_prod_area = nr_seq_produto_area_p
	and	nr_sequencia = nr_seq_area_modulo_p;

    if ((nr_seq_modulo_w IS NOT NULL AND nr_seq_modulo_w::text <> '') or (ds_area_modulo_w IS NOT NULL AND ds_area_modulo_w::text <> '')) then
        select nextval('mkt_area_modulo_seq') into STRICT modulo_sequence_p;

        insert	into	mkt_area_modulo(	nr_sequencia,
                            dt_atualizacao,
                            dt_atualizacao_nrec,
                            nm_usuario,
                            nm_usuario_nrec,
                            nr_seq_area,
                            nr_seq_modulo,
                            nr_seq_prod_area,
	            ds_area_modulo)
            values (	modulo_sequence_p,
                clock_timestamp(),
                clock_timestamp(),
                nm_usuario_p,
                nm_usuario_p,
                nr_seq_area_w,
                nr_seq_modulo_w,
                area_sequence_p,
	ds_area_modulo_w);	

        insert	into	mkt_modulo_indicador(	nr_sequencia,
                            dt_atualizacao,
                            dt_atualizacao_nrec,
                            nm_usuario,
                            nm_usuario_nrec,
                            nr_seq_modulo,
                            nr_seq_indicador )
            SELECT	nextval('mkt_modulo_indicador_seq'),
                clock_timestamp(),
                clock_timestamp(),
                nm_usuario_p,
                nm_usuario_p,
                modulo_sequence_p,
                nr_seq_indicador
            from	mkt_modulo_indicador
            where	nr_seq_modulo = nr_seq_area_modulo_p;

        insert	into	mkt_modulo_integracao(	nr_sequencia,
                            dt_atualizacao,
                            dt_atualizacao_nrec,
                            nm_usuario,
                            nm_usuario_nrec,
                            nr_seq_modulo,
                            nr_seq_integracao)
            SELECT	nextval('mkt_modulo_integracao_seq'),
                clock_timestamp(),
                clock_timestamp(),
                nm_usuario_p,
                nm_usuario_p,
                modulo_sequence_p,
                nr_seq_integracao 
            from	mkt_modulo_integracao
            where	nr_seq_modulo = nr_seq_area_modulo_p;

        insert	into	mkt_modulo_tabela(	nr_sequencia,
                            dt_atualizacao,
                            dt_atualizacao_nrec,
                            nm_usuario,
                            nm_usuario_nrec,
                            nr_seq_modulo,
                            nm_tabela)
            SELECT	nextval('mkt_modulo_tabela_seq'),
                clock_timestamp(),
                clock_timestamp(),
                nm_usuario_p,
                nm_usuario_p,
                modulo_sequence_p,
                nm_tabela
            from	mkt_modulo_tabela
            where	nr_seq_modulo = nr_seq_area_modulo_p;

        insert	into	mkt_modulo_relatorio(	nr_sequencia,
                            dt_atualizacao,
                            dt_atualizacao_nrec,
                            nm_usuario,
                            nm_usuario_nrec,
                            nr_seq_modulo,
                            nr_seq_relatorio)
            SELECT	nextval('mkt_modulo_relatorio_seq'),
                clock_timestamp(),
                clock_timestamp(),
                nm_usuario_p,
                nm_usuario_p,
                modulo_sequence_p,
                nr_seq_relatorio
            from	mkt_modulo_relatorio
            where	nr_seq_modulo = nr_seq_area_modulo_p;
	
	insert into mkt_in_charge(	nr_sequencia,
					ie_situacao,
					cd_pessoa_fisica,
					nm_usuario,
					dt_atualizacao,
					nr_seq_area_modulo,
					nr_seq_modulo_mercado,
					nr_seq_modulo_funcao,
					nr_seq_funcao_mercado,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_area_mercado,
					nr_seq_produto_area,
					nr_seq_produto_mercado,
					nr_seq_mercado,
					ds_note,
					nr_seq_produto) 
		SELECT	nextval('mkt_in_charge_seq'),
			ie_situacao,
			cd_pessoa_fisica,
			nm_usuario_p,
			clock_timestamp(),
			modulo_sequence_p,
			nr_seq_modulo_mercado,
			nr_seq_modulo_funcao,
			nr_seq_funcao_mercado,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_area_mercado,
			area_sequence_p,
			nr_seq_produto_mercado,
			nr_seq_mercado,
			ds_note,
			nr_seq_produto_w
		from	mkt_in_charge
		where	nr_seq_area_modulo = nr_seq_area_modulo_p;
		
	for r_c01 in c01 loop
		select nextval('mkt_modulo_mercado_seq') into STRICT mkt_modulo_mercado_seq_w;
		insert into mkt_modulo_mercado(nr_sequencia,
					dt_atualizacao, 
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_modulo,
					nr_seq_mercado ) values (mkt_modulo_mercado_seq_w, 
			clock_timestamp(), 
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			modulo_sequence_p,
			r_c01.nr_seq_mercado
			);
		

		insert into mkt_in_charge(	nr_sequencia,
						ie_situacao,
						cd_pessoa_fisica,
						nm_usuario,
						dt_atualizacao,
						nr_seq_area_modulo,
						nr_seq_modulo_mercado,
						nr_seq_modulo_funcao,
						nr_seq_funcao_mercado,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_seq_area_mercado,
						nr_seq_produto_area,
						nr_seq_produto_mercado,
						nr_seq_mercado,
						ds_note,
						nr_seq_produto)
			SELECT	nextval('mkt_in_charge_seq'),
				ie_situacao,
				cd_pessoa_fisica,
				nm_usuario_p,
				clock_timestamp(),
				modulo_sequence_p,
				r_c01.nr_sequencia,
				nr_seq_modulo_funcao,
				nr_seq_funcao_mercado,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_area_mercado,
				nr_seq_produto_area,
				nr_seq_produto_mercado,
				r_c01.nr_seq_mercado,
				ds_note,
				nr_seq_produto
			from	mkt_in_charge
			where	nr_seq_modulo_mercado = r_c01.nr_sequencia;
	end loop;

	for r_c02 in c02 loop

		insert into mkt_in_charge(	nr_sequencia,
						ie_situacao,
						cd_pessoa_fisica,
						nm_usuario,
						dt_atualizacao,
						nr_seq_area_modulo,
						nr_seq_modulo_mercado,
						nr_seq_modulo_funcao,
						nr_seq_funcao_mercado,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_seq_area_mercado,
						nr_seq_produto_area,
						nr_seq_produto_mercado,
						nr_seq_mercado,
						ds_note,
						nr_seq_produto)
			SELECT	nextval('mkt_in_charge_seq'),
				ie_situacao,
				cd_pessoa_fisica,
				nm_usuario_p,
				clock_timestamp(),
				modulo_sequence_p,
				r_c02.nr_sequencia,
				nr_seq_modulo_funcao,
				nr_seq_funcao_mercado,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_area_mercado,
				nr_seq_produto_area,
				nr_seq_produto_mercado,
				r_c02.nr_seq_mercado,
				ds_note,
				nr_seq_produto
			from	mkt_in_charge
			where	nr_seq_modulo_mercado = r_c02.nr_modulo_mercado_antigo;
	end loop;
        commit;
    end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_estrutura_modulo ( area_sequence_p bigint, nr_seq_produto_area_p bigint, nr_seq_area_modulo_p bigint, nm_usuario_p text, modulo_sequence_p INOUT bigint) FROM PUBLIC;

