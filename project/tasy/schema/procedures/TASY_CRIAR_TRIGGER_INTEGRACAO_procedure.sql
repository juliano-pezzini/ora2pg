-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE campos AS (ds		varchar(32760));


CREATE OR REPLACE PROCEDURE tasy_criar_trigger_integracao () AS $body$
DECLARE

TYPE Vetor IS TABLE OF  campos INDEX BY integer;
ds_script_vetor			Vetor;

nm_tabela_w 		varchar(50);
nm_atributo_w		varchar(50);
ds_script_trigger_w	text;
ds_aspa_w			varchar(1) :=CHR(39);
dt_geracao_versao_w	timestamp;
ie_tipo_atributo_w	varchar(10);
ds_mascara_w		varchar(30);
c01 CURSOR FOR
	SELECT	DISTINCT a.nm_tabela
	FROM	tabela_atributo a
	WHERE	ie_tipo_atributo IN ('DATE','NUMBER','VARCHAR2')
	AND		nm_tabela = 'PESSOA_FISICA'
	AND 	NOT EXISTS (	SELECT	1
				FROM	user_triggers b
				WHERE	b.table_name = a.nm_tabela
				AND	b.trigger_name = SUBSTR(a.nm_tabela,1,27)||'_TI');
--AND 	(dt_criacao > dt_geracao_versao_w))
C02 CURSOR FOR
	SELECT	a.nm_atributo,
			a.ie_tipo_atributo,
			a.ds_mascara
	FROM	tabela_atributo a
	WHERE	a.nm_tabela = nm_tabela_w
	AND		ie_tipo_atributo IN ('DATE','NUMBER','VARCHAR2')
	ORDER BY nm_atributo;


BEGIN
dt_geracao_versao_w := OBTER_DATA_GERACAO_VERSAO;
OPEN C01;
LOOP
FETCH C01 INTO
	nm_tabela_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	BEGIN
		ds_script_vetor[1].ds := '';
		ds_script_vetor[2].ds := '';
		ds_script_vetor[3].ds := '';
		ds_script_vetor[4].ds := '';
		ds_script_vetor[5].ds := '';
		ds_script_trigger_w :=  ' create or replace trigger '|| SUBSTR(nm_tabela_w,1,27) ||'_ti '||
					' after insert or update on ' || nm_tabela_w ||
					' FOR EACH ROW '||
					' DECLARE'||
					' begin'||
					' 	wheb_exportar_xml_pck.limpa_parametros;'||
					'	wheb_exportar_xml_pck.armazena_parametro('||ds_aspa_w||'NM_TABELA_REF'||ds_aspa_w||','||ds_aspa_w||nm_tabela_w||ds_aspa_w||');';

		OPEN C02;
		LOOP
		FETCH C02 INTO
			nm_atributo_w,
			ie_tipo_atributo_w,
			ds_mascara_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			BEGIN
				IF (ie_tipo_atributo_w = 'DATE') THEN
					IF (LENGTH(ds_mascara_w) > 10 ) THEN
						ds_mascara_w := 'dd/mm/yyyy hh24:mi:ss';
					END IF;
					ds_script_trigger_w := ds_script_trigger_w  ||'	wheb_exportar_xml_pck.armazena_parametro('||ds_aspa_w||nm_atributo_w||ds_aspa_w||',to_char(:new.'||nm_atributo_w||','||ds_aspa_w||ds_mascara_w||ds_aspa_w||'));';
				ELSE
					ds_script_trigger_w := ds_script_trigger_w  ||'	wheb_exportar_xml_pck.armazena_parametro('||ds_aspa_w||nm_atributo_w||ds_aspa_w||',:new.'||nm_atributo_w||');';
				END IF;
			END;
		END LOOP;
		CLOSE C02;
		ds_script_trigger_w := ds_script_trigger_w || ' ' ||
			' gravar_log_integracao(:new.nm_usuario,5,'||ds_aspa_w||'CD_PESSOA_FISICA='||ds_aspa_w||'||:new.cd_pessoa_fisica||'||ds_aspa_w||';'||ds_aspa_w||'); end;';
		--ds_script_trigger_w := ds_script_trigger_w || ' ' || ' exception when others then ds_w:= '||ds_aspa_w || '1' || ds_aspa_w||'; end; end;';
		ds_script_vetor[1].ds := SUBSTR(ds_script_trigger_w,1,32000);
		ds_script_vetor[2].ds := SUBSTR(ds_script_trigger_w,32001,32000);
		ds_script_vetor[3].ds := SUBSTR(ds_script_trigger_w,64001,32000);
		ds_script_vetor[4].ds := SUBSTR(ds_script_trigger_w,96001,32000);
		ds_script_vetor[5].ds := SUBSTR(ds_script_trigger_w,128001,32000);
		EXECUTE ds_script_vetor[1].ds || ds_script_vetor[2].ds || ds_script_vetor[3].ds || ds_script_vetor[4].ds || ds_script_vetor[5].ds;
	END;
END LOOP;
CLOSE C01;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_criar_trigger_integracao () FROM PUBLIC;

