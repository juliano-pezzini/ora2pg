-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_email_atend_agenda (nr_seq_agenda_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ds_email_atend_exame_w		varchar(2000);
ds_tit_email_atend_exame_w		varchar(255);
ds_rem_email_atend_exame_w	varchar(255);
nm_paciente_w			varchar(60);
nm_medico_w			varchar(100);
cd_pessoa_fisica_w		varchar(10);
ds_convenio_w			varchar(40);
ds_procedimento_w			varchar(255);
ds_email_destino_w			varchar(255);
ds_mensagem_w			varchar(4000);
ie_erro_w				varchar(1);
cd_agenda_w			bigint;
ie_enviar_email_atend_w		varchar(1);


BEGIN 
 
select	max(cd_agenda) 
into STRICT	cd_agenda_w 
from	agenda_paciente 
where	nr_sequencia = nr_seq_agenda_p;
 
select	coalesce(max(ie_enviar_email_atend),'S') 
into STRICT	ie_enviar_email_atend_w 
from	agenda 
where	cd_agenda = cd_agenda_w;
 
if (ie_enviar_email_atend_w = 'S') then 
 
	select	max(ds_email_atend_exame), 
		max(ds_tit_email_atend_exame), 
		max(ds_rem_email_atend_exame) 
	into STRICT	ds_email_atend_exame_w, 
		ds_tit_email_atend_exame_w, 
		ds_rem_email_atend_exame_w 
	from	parametro_agenda 
	where	cd_estabelecimento = cd_estabelecimento_p;
 
	if (ds_email_atend_exame_w IS NOT NULL AND ds_email_atend_exame_w::text <> '') and (ds_tit_email_atend_exame_w IS NOT NULL AND ds_tit_email_atend_exame_w::text <> '') and (ds_rem_email_atend_exame_w IS NOT NULL AND ds_rem_email_atend_exame_w::text <> '') then 
 
		select	max(nm_paciente), 
			max(cd_pessoa_fisica), 
			max(substr(obter_nome_convenio(cd_convenio),1,40)), 
			max(substr(obter_nome_medico(cd_medico,'NCD'),1,100)), 
			max(substr(obter_exame_agenda(cd_procedimento, ie_origem_proced, nr_seq_proc_interno),1,240)) 
		into STRICT	nm_paciente_w, 
			cd_pessoa_fisica_w, 
			ds_convenio_w, 
			nm_medico_w, 
			ds_procedimento_w 
		from	agenda_paciente 
		where	nr_sequencia = nr_seq_agenda_p;
 
		select	max(b.ds_email) 
		into STRICT	ds_email_destino_w 
		from	pessoa_fisica a, 
			compl_pessoa_fisica b 
		where	a.cd_pessoa_fisica 	= b.cd_pessoa_fisica 
		and	b.ie_tipo_complemento 	= 1 
		and	a.cd_pessoa_fisica	= cd_pessoa_fisica_w;
 
		ds_mensagem_w 	:= ds_email_atend_exame_w;
		ds_mensagem_w	:= substr(replace_macro(ds_mensagem_w, '@Paciente', nm_paciente_w),1,4000);
		ds_mensagem_w	:= substr(replace_macro(ds_mensagem_w, '@Convenio', ds_convenio_w),1,4000);
		ds_mensagem_w	:= substr(replace_macro(ds_mensagem_w, '@Requisitante', nm_medico_w),1,4000);
		ds_mensagem_w	:= substr(replace_macro(ds_mensagem_w, '@Exame', ds_procedimento_w),1,4000);
 
		if (position('@' in ds_email_destino_w) > 0) then 
			begin 
			CALL enviar_email(ds_tit_email_atend_exame_w, ds_mensagem_w, ds_rem_email_atend_exame_w, ds_email_destino_w, 'Tasy', 'A');
			exception 
			when others then 
			ie_erro_w	:= 'S';
			end;
		end if;
	end if;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_email_atend_agenda (nr_seq_agenda_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

