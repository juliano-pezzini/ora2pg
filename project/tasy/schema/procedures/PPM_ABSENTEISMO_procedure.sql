-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ppm_absenteismo (nr_seq_metrica_p bigint, nr_seq_objetivo_metrica_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, dt_referencia_p timestamp) AS $body$
DECLARE


dt_aux_w		timestamp;
dt_referencia_w		timestamp;
dt_final_w		timestamp;
pr_absenteismo_w	double precision;
resultado_w		double precision;
nr_seq_diretoria_w	ppm_objetivo.nr_seq_diretoria%type;
nr_seq_gerencia_w	ppm_objetivo.nr_seq_gerencia%type;
nr_seq_grupo_w		ppm_objetivo.nr_seq_grupo%type;


BEGIN

select	max(nr_seq_gerencia),
	max(nr_seq_grupo),
	max(nr_seq_diretoria)
into STRICT	nr_seq_gerencia_w,
	nr_seq_grupo_w,
	nr_seq_diretoria_w
from	ppm_objetivo_metrica a,
	ppm_objetivo_meta b,
	ppm_objetivo c
where	a.nr_sequencia		= nr_seq_objetivo_metrica_p
and	a.nr_seq_meta		= b.nr_sequencia
and	b.nr_seq_objetivo	= c.nr_sequencia;

if (nr_seq_grupo_w IS NOT NULL AND nr_seq_grupo_w::text <> '') then

	select	KPI_OBTER_ABSENTEISMO_UTIL(null, nr_seq_grupo_w, null, dt_referencia_p)
	into STRICT	pr_absenteismo_w
	;

elsif (nr_seq_gerencia_w IS NOT NULL AND nr_seq_gerencia_w::text <> '') then

	select	KPI_OBTER_ABSENTEISMO_UTIL(nr_seq_gerencia_w, null, null, dt_referencia_p)
	into STRICT	pr_absenteismo_w
	;

elsif (nr_seq_diretoria_w IS NOT NULL AND nr_seq_diretoria_w::text <> '') then

	select	avg(KPI_OBTER_ABSENTEISMO_UTIL(nr_sequencia, null, null, dt_referencia_p))
	into STRICT	pr_absenteismo_w
	from	gerencia_wheb a
	where	a.nr_seq_diretoria	= nr_seq_diretoria_w
	and	a.ie_situacao		= 'A';

elsif (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then

	select	KPI_OBTER_ABSENTEISMO_UTIL(null, null, cd_pessoa_fisica_p, dt_referencia_p)
	into STRICT	pr_absenteismo_w
	;
end if;

if (pr_absenteismo_w > 0) then
	pr_absenteismo_w	:= 100 - pr_absenteismo_w;
else
	pr_absenteismo_w	:= 0;
end if;

CALL PPM_GRAVAR_RESULTADO(nr_seq_objetivo_metrica_p, dt_referencia_p, pr_absenteismo_w, null, null, nm_usuario_p);

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ppm_absenteismo (nr_seq_metrica_p bigint, nr_seq_objetivo_metrica_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, dt_referencia_p timestamp) FROM PUBLIC;

