-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_regra_pacote ( nr_pacote_orig_p bigint, nr_pacote_dest_p bigint, nm_usuario_p text, ie_procedimento_p text, ie_material_p text, ie_acomodacao_p text, ie_somente_ativo_p text, dt_vigencia_p timestamp, ie_deletar_p text, ie_excluir_dados_p text, ie_regra_cid_p text) AS $body$
DECLARE


cd_procedimento_origem_w	bigint;
ie_origem_proced_w		bigint;
nr_seq_tipo_acomod_w		bigint;
nr_seq_material_w		bigint;
nr_seq_aux_w			bigint;

c01 CURSOR FOR
	SELECT	nr_pacote_dest_p,
		ie_tipo_acomod,
		clock_timestamp(),
		nm_usuario_p,
		qt_dias_pacote,
		qt_dias_hospital,
		qt_dias_uti,
		ie_excedente,
		cd_procedimento,
		ie_origem_proced,
		vl_pacote,
		vl_honorario,
		qt_ponto_pacote,
		qt_ponto_honorario,
		cd_estrutura_conta,
		ie_classificacao,
		cd_categoria,
		dt_vigencia,
		dt_vigencia_final,
		ie_exige_gabarito,
		ie_regra_hora_inicio,
		ie_regra_hora_fim,
		ie_situacao,
		ie_ratear_repasse,
		ie_tipo_atendimento,
		ie_gerar_proced_negativo,
		vl_anestesista,
		nr_sequencia,
		coalesce(ie_atend_retorno,'N') ie_atend_retorno,
		coalesce(ie_atend_acomp,'N') ie_atend_acomp,
		qt_idade_min,
		qt_idade_max,
		qt_dias_inter_inicio,
		qt_dias_inter_final,
		ie_tipo_anestesia,
		hr_final_pacote,
		pr_faturar_pacote,
		cd_setor_atendimento,
		nr_seq_proc_interno,
		cd_medico_executor,
		ie_clinica,
		vl_materiais,
		ie_consiste_cirurgia,
		ie_exige_item_conta,
		vl_auxiliares,
		ds_observacao,
		ie_sexo,
		pr_acrescimo_rn,
		ie_lado,
		ie_setor_lanc_exclusivo,
		qt_procedimento,
		ie_tipo_atend_conta,
		cd_centro_custo,
		ie_credenciado,
		qt_hora,
		cd_plano,
        ie_carater_inter_sus
	from 	pacote_tipo_acomodacao
	where 	nr_seq_pacote = nr_pacote_orig_p
	and	((ie_somente_ativo_p = 'S' and ie_situacao = 'A') or (ie_somente_ativo_p  = 'N'))
	and	((trunc(dt_vigencia)	= trunc(dt_vigencia_p)) or (coalesce(dt_vigencia_p::text, '') = ''));


c02 CURSOR FOR
	SELECT	nr_pacote_dest_p,
		ie_inclui_exclui,
		clock_timestamp(),
		nm_usuario_p,
		ie_excedente,
		cd_grupo_material,
		cd_subgrupo_material,
		cd_classe_material,
		cd_material,
		qt_limite,
		cd_setor_atendimento,
		ie_tipo_atendimento,
		ie_valor,
		vl_minimo,
		vl_maximo,
		pr_desconto,
		ie_tipo_setor,
		nr_seq_familia,
		qt_idade_min,
		qt_idade_max,
		ie_objetivo,
		ie_considera_generico,
		pr_orcamento,
		ie_sexo,
		cd_centro_custo,
                ie_somente_sem_rla,
                ie_setor_exclusivo,
		ie_ratear_item,
                ie_consiste_limite_item,
		vl_negociado,
		nr_seq_estrutura,
		cd_local_estoque		
	from 	pacote_material
	where 	nr_seq_pacote		 = nr_pacote_orig_p
	and	nr_seq_pac_acomod 	= nr_seq_aux_w;


c03 CURSOR FOR
	SELECT	nr_pacote_dest_p,
		nr_sequencia,
		ie_inclui_exclui,
		clock_timestamp(),
		nm_usuario_p,
		ie_excedente,
		cd_area_proced,
		cd_especial_proced,
		cd_grupo_proced,
		cd_procedimento,
		ie_origem_proced,
		qt_limite,
		ie_considera_honorario,
		cd_setor_atendimento,
		ie_tipo_atendimento,
		ie_calcula_honorario,
		ie_calcula_custo_oper,
		nr_seq_tipo_acomod_w,
		pr_desconto,
		ie_tipo_valor,
		qt_idade_min,
		qt_idade_max,
		vl_maximo,
		vl_minimo,
		nr_seq_proc_interno,
		ie_ratear_item,
		pr_desc,
		vl_negociado,
		ie_agendavel,
		ie_sexo,
		cd_centro_custo,
		nr_seq_classif,
		ie_valida_limite_proc,
		nr_seq_estrutura
	from 	pacote_procedimento
	where 	nr_seq_pacote 		= nr_pacote_orig_p
	and	nr_seq_pac_acomod 	= nr_seq_aux_w;
c01_w	c01%rowtype;	
c02_w	c02%rowtype;
c03_w	c03%rowtype;

BEGIN

select	cd_proced_pacote,
	ie_origem_proced
into STRICT	cd_procedimento_origem_w,
	ie_origem_proced_w
from	pacote
where	nr_seq_pacote	= nr_pacote_dest_p;	



if (ie_procedimento_p	= 'S') then

if (ie_excluir_dados_p = 'S') then

	delete from pacote_procedimento
	where 	nr_seq_pacote = nr_pacote_dest_p
	and	coalesce(nr_seq_pac_acomod::text, '') = '';

	end if;

	insert into pacote_procedimento(	nr_seq_pacote,
						nr_sequencia,
						ie_inclui_exclui,
						dt_atualizacao,
						nm_usuario,
						ie_excedente,
						cd_area_proced,
						cd_especial_proced,
						cd_grupo_proced,
						cd_procedimento,
						ie_origem_proced,
						qt_limite,
						ie_considera_honorario,
						cd_setor_atendimento,
						ie_tipo_atendimento,
						ie_calcula_honorario,
						ie_calcula_custo_oper,
						nr_seq_pac_acomod,
						pr_desconto,
						ie_tipo_valor,
						qt_idade_min,
						qt_idade_max,
						vl_maximo,
						vl_minimo,
						nr_seq_proc_interno,
						ie_ratear_item,
						pr_desc,
						vl_negociado,
						ie_agendavel,
						ie_sexo,
						cd_centro_custo,
						nr_seq_classif,
						ie_valida_limite_proc,
						nr_seq_estrutura)
	SELECT	nr_pacote_dest_p,
		nextval('pacote_procedimento_seq'),
		ie_inclui_exclui,
		clock_timestamp(),
		nm_usuario_p,
		ie_excedente,
		cd_area_proced,
		cd_especial_proced,
		cd_grupo_proced,
		cd_procedimento,
		ie_origem_proced,
		qt_limite,
		ie_considera_honorario,
		cd_setor_atendimento,
		ie_tipo_atendimento,
		ie_calcula_honorario,
		ie_calcula_custo_oper,
		nr_seq_pac_acomod,
		pr_desconto,
		ie_tipo_valor,
		qt_idade_min,
		qt_idade_max,
		vl_maximo,
		vl_minimo,
		nr_seq_proc_interno,
		ie_ratear_item,
		pr_desc,
		vl_negociado,
		ie_agendavel,
		ie_sexo,
		cd_centro_custo,
		nr_seq_classif,
		ie_valida_limite_proc,
		nr_seq_estrutura
	from 	pacote_procedimento
	where 	nr_seq_pacote = nr_pacote_orig_p
	and	coalesce(nr_seq_pac_acomod::text, '') = '';

end if;

if (ie_material_p = 'S') then


	if (ie_excluir_dados_p = 'S') then

		delete from pacote_material
		where 	nr_seq_pacote = nr_pacote_dest_p
		and	coalesce(nr_seq_pac_acomod::text, '') = '';

	end if;

	insert into pacote_material(	nr_seq_pacote,
					nr_sequencia,
					ie_inclui_exclui,
					dt_atualizacao,
					nm_usuario,
					ie_excedente,
					cd_grupo_material,
					cd_subgrupo_material,
					cd_classe_material,
					cd_material,
					qt_limite,
					cd_setor_atendimento,
					ie_tipo_atendimento,
					ie_valor,
					vl_minimo,
					vl_maximo,
					pr_desconto,
					ie_tipo_setor,
					qt_idade_min,
					qt_idade_max,
					ie_objetivo,
					ie_considera_generico,
					pr_orcamento,
					ie_sexo,
					cd_centro_custo,
                                        ie_somente_sem_rla,
                                        ie_setor_exclusivo,
                                        ie_ratear_item,
                                        ie_consiste_limite_item,
					nr_seq_estrutura,
					cd_local_estoque)
				SELECT	nr_pacote_dest_p,
					nextval('pacote_material_seq'),
					ie_inclui_exclui,
					clock_timestamp(),
					nm_usuario_p,
					ie_excedente,
					cd_grupo_material,
					cd_subgrupo_material,
					cd_classe_material,
					cd_material,
					qt_limite,
					cd_setor_atendimento,
					ie_tipo_atendimento,
					ie_valor,
					vl_minimo,
					vl_maximo,
					pr_desconto,
					ie_tipo_setor,
					qt_idade_min,
					qt_idade_max,
					ie_objetivo,
					ie_considera_generico,
					pr_orcamento,
					ie_sexo,
					cd_centro_custo,
                                        ie_somente_sem_rla,
                                        ie_setor_exclusivo,
                                        ie_ratear_item,
                                        ie_consiste_limite_item,
					nr_seq_estrutura,
					cd_local_estoque
				from 	pacote_material
				where 	nr_seq_pacote = nr_pacote_orig_p
				and	coalesce(nr_seq_pac_acomod::text, '') = '';

end if;

if (ie_regra_cid_p = 'S') then

	if (ie_excluir_dados_p = 'S') then

		delete from pacote_cid
		where 	nr_seq_pacote = nr_pacote_dest_p;

	end if;

	insert into pacote_cid(NR_SEQUENCIA,
					CD_DOENCA,           
					NR_SEQ_PACOTE,          
					DT_ATUALIZACAO,               
					NM_USUARIO,          
					DT_ATUALIZACAO_NREC,                   
					NM_USUARIO_NREC,             
					IE_SITUACAO)
	SELECT  nextval('pacote_cid_seq'),
			cd_doenca,
			nr_pacote_dest_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			ie_situacao
	from 	pacote_cid
	where 	nr_seq_pacote = nr_pacote_orig_p;


end if;


if (ie_acomodacao_p	= 'S') then

	if (dt_vigencia_p IS NOT NULL AND dt_vigencia_p::text <> '') and (ie_deletar_p = 'S')then

		delete from pacote_material
		where	nr_seq_pacote	= nr_pacote_dest_p
		and	nr_seq_pac_acomod in (	SELECT	nr_sequencia
							from 	pacote_tipo_acomodacao 
						where 	dt_vigencia 		= dt_vigencia_p
						and	nr_seq_pacote 		= nr_pacote_dest_p );
		delete from  pacote_procedimento
		where	nr_seq_pacote	= nr_pacote_dest_p
		and	nr_seq_pac_acomod in (	SELECT	nr_sequencia
						from 	pacote_tipo_acomodacao 
						where 	dt_vigencia 		= dt_vigencia_p
						and	nr_seq_pacote 		= nr_pacote_dest_p);
						
		delete from	pacote_tipo_acomod_proc a	
			where  	exists (SELECT 1 from pacote_tipo_acomodacao b 	
						where b.nr_sequencia	= a.nr_seq_pac_acomod	
						and   dt_vigencia 		= dt_vigencia_p	
						and   b.nr_seq_pacote	= nr_pacote_dest_p );

		delete from  pacote_tipo_acomodacao
		where	dt_vigencia 		= dt_vigencia_p
		and	nr_seq_pacote 		= nr_pacote_dest_p;

	end if;

	open C01;
	loop
	fetch C01 into	
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		select	nextval('pacote_tipo_acomodacao_seq')
		into STRICT	nr_seq_tipo_acomod_w
		;


		insert into pacote_tipo_acomodacao(nr_seq_pacote,
				ie_tipo_acomod,
				dt_atualizacao,
				nm_usuario,
				qt_dias_pacote,
				qt_dias_hospital,
				qt_dias_uti,
				ie_excedente,
				cd_procedimento,
				ie_origem_proced,
				vl_pacote,
				vl_honorario,
				qt_ponto_pacote,
				qt_ponto_honorario,
				cd_estrutura_conta,
				ie_classificacao,
				nr_sequencia,
				cd_categoria,
				dt_vigencia,
				dt_vigencia_final,
				ie_exige_gabarito,
				ie_regra_hora_inicio,
				ie_regra_hora_fim,
				ie_situacao,
				ie_ratear_repasse,
				ie_tipo_atendimento,
				ie_gerar_proced_negativo,
				vl_anestesista,
				ie_atend_retorno,
				ie_atend_acomp,
				qt_idade_min,
				qt_idade_max,
				qt_dias_inter_inicio,
				qt_dias_inter_final,
				ie_tipo_anestesia,
				hr_final_pacote,
				pr_faturar_pacote,
				cd_setor_atendimento,
				nr_seq_proc_interno,
				cd_medico_executor,
				ie_clinica,
				vl_materiais,
				ie_consiste_cirurgia,
				ie_exige_item_conta,
				vl_auxiliares,
				ds_observacao,
				ie_sexo,
				pr_acrescimo_rn,
				ie_lado,
				ie_setor_lanc_exclusivo,
				qt_procedimento,
				ie_tipo_atend_conta,
				cd_centro_custo,
				ie_credenciado,
				qt_hora,
				cd_plano,
                ie_carater_inter_sus)
		values (	nr_pacote_dest_p,
				c01_w.ie_tipo_acomod,
				clock_timestamp(),
				nm_usuario_p,
				c01_w.qt_dias_pacote,
				c01_w.qt_dias_hospital,
				c01_w.qt_dias_uti,
				c01_w.ie_excedente,
				c01_w.cd_procedimento,
				c01_w.ie_origem_proced,
				c01_w.vl_pacote,
				c01_w.vl_honorario,
				c01_w.qt_ponto_pacote,
				c01_w.qt_ponto_honorario,
				c01_w.cd_estrutura_conta,
				c01_w.ie_classificacao,
				nr_seq_tipo_acomod_w,
				c01_w.cd_categoria,
				c01_w.dt_vigencia,
				c01_w.dt_vigencia_final,
				c01_w.ie_exige_gabarito,
				c01_w.ie_regra_hora_inicio,
				c01_w.ie_regra_hora_fim,
				c01_w.ie_situacao,
				c01_w.ie_ratear_repasse,
				c01_w.ie_tipo_atendimento,
				c01_w.ie_gerar_proced_negativo,
				c01_w.vl_anestesista,
				c01_w.ie_atend_retorno,
				c01_w.ie_atend_acomp,
				c01_w.qt_idade_min,
				c01_w.qt_idade_max,
				c01_w.qt_dias_inter_inicio,
				c01_w.qt_dias_inter_final,
				c01_w.ie_tipo_anestesia,
				c01_w.hr_final_pacote,
				c01_w.pr_faturar_pacote,
				c01_w.cd_setor_atendimento,
				c01_w.nr_seq_proc_interno,
				c01_w.cd_medico_executor,
				c01_w.ie_clinica,
				c01_w.vl_materiais,
				c01_w.ie_consiste_cirurgia,
				c01_w.ie_exige_item_conta,
				c01_w.vl_auxiliares,
				c01_w.ds_observacao,
				c01_w.ie_sexo,
				c01_w.pr_acrescimo_rn,
				c01_w.ie_lado,
				c01_w.ie_setor_lanc_exclusivo,
				c01_w.qt_procedimento,
				c01_w.ie_tipo_atend_conta,
				c01_w.cd_centro_custo,
				c01_w.ie_credenciado,
				c01_w.qt_hora,
				c01_w.cd_plano,
                c01_w.ie_carater_inter_sus);

		nr_seq_aux_w	:= c01_w.nr_sequencia;

		open c02;
		loop
		fetch c02 into	
			c02_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			select	nextval('pacote_material_seq')
			into STRICT	nr_seq_material_w
			;

			insert into pacote_material(	
					nr_seq_pacote,
					nr_sequencia,
					ie_inclui_exclui,
					dt_atualizacao,
					nm_usuario,
					ie_excedente,
					cd_grupo_material,
					cd_subgrupo_material,
					cd_classe_material,
					cd_material,
					qt_limite,
					cd_setor_atendimento,
					ie_tipo_atendimento,
					ie_valor,
					vl_minimo,
					vl_maximo,
					pr_desconto,
					ie_tipo_setor,
					nr_seq_pac_acomod,
					nr_seq_familia,
					qt_idade_min,
					qt_idade_max,
					ie_objetivo,
					ie_considera_generico,
					pr_orcamento,
					ie_sexo,
					cd_centro_custo,
                                        ie_somente_sem_rla,
                                        ie_setor_exclusivo,
					ie_ratear_item,
                                        ie_consiste_limite_item,
					vl_negociado,
					nr_seq_estrutura,
					cd_local_estoque)
			values (nr_pacote_dest_p,
				nr_seq_material_w,
				c02_w.ie_inclui_exclui,
				clock_timestamp(),
				nm_usuario_p,
				c02_w.ie_excedente,
				c02_w.cd_grupo_material,
				c02_w.cd_subgrupo_material,
				c02_w.cd_classe_material,
				c02_w.cd_material,
				c02_w.qt_limite,
				c02_w.cd_setor_atendimento,
				c02_w.ie_tipo_atendimento,
				c02_w.ie_valor,
				c02_w.vl_minimo,
				c02_w.vl_maximo,
				c02_w.pr_desconto,
				c02_w.ie_tipo_setor,
				nr_seq_tipo_acomod_w,
				c02_w.nr_seq_familia,
				c02_w.qt_idade_min,
				c02_w.qt_idade_max,
				c02_w.ie_objetivo,
				c02_w.ie_considera_generico,
				c02_w.pr_orcamento,
				c02_w.ie_sexo,
				c02_w.cd_centro_custo,
                                c02_w.ie_somente_sem_rla,
                                c02_w.ie_setor_exclusivo,
				c02_w.ie_ratear_item,
                                c02_w.ie_consiste_limite_item,
				c02_w.vl_negociado,
				c02_w.nr_seq_estrutura,
				c02_w.cd_local_estoque);

			end;
		end loop;
		close C02;


		open C03;
		loop
		fetch C03 into	
			c03_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin

			select	nextval('pacote_procedimento_seq')
			into STRICT	nr_seq_material_w
			;

			insert into pacote_procedimento(	
				nr_seq_pacote,
				nr_sequencia,
				ie_inclui_exclui,
				dt_atualizacao,
				nm_usuario,
				ie_excedente,
				cd_area_proced,
				cd_especial_proced,
				cd_grupo_proced,
				cd_procedimento,
				ie_origem_proced,
				qt_limite,
				ie_considera_honorario,
				cd_setor_atendimento,
				ie_tipo_atendimento,
				ie_calcula_honorario,
				ie_calcula_custo_oper,
				nr_seq_pac_acomod,
				pr_desconto,
				ie_tipo_valor,
				qt_idade_min,
				qt_idade_max,
				vl_maximo,
				vl_minimo,
				nr_seq_proc_interno,
				ie_ratear_item,
				pr_desc,
				vl_negociado,
				ie_agendavel,
				ie_sexo,
				cd_centro_custo,
				nr_seq_classif,
				ie_valida_limite_proc,
				nr_seq_estrutura)
			values (nr_pacote_dest_p,
				nr_seq_material_w,
				c03_w.ie_inclui_exclui,
				clock_timestamp(),
				nm_usuario_p,
				c03_w.ie_excedente,
				c03_w.cd_area_proced,
				c03_w.cd_especial_proced,
				c03_w.cd_grupo_proced,
				c03_w.cd_procedimento,
				c03_w.ie_origem_proced,
				c03_w.qt_limite,
				c03_w.ie_considera_honorario,
				c03_w.cd_setor_atendimento,
				c03_w.ie_tipo_atendimento,
				c03_w.ie_calcula_honorario,
				c03_w.ie_calcula_custo_oper,
				nr_seq_tipo_acomod_w,
				c03_w.pr_desconto,
				c03_w.ie_tipo_valor,
				c03_w.qt_idade_min,
				c03_w.qt_idade_max,
				c03_w.vl_maximo,
				c03_w.vl_minimo,
				c03_w.nr_seq_proc_interno,
				c03_w.ie_ratear_item,
				c03_w.pr_desc,
				c03_w.vl_negociado,
				c03_w.ie_agendavel,
				c03_w.ie_sexo,
				c03_w.cd_centro_custo,
				c03_w.nr_seq_classif,
				c03_w.ie_valida_limite_proc,
				c03_w.nr_seq_estrutura);

			end;
		end loop;
		close C03;


		insert into pacote_tipo_acomod_proc( nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						nr_seq_pac_acomod,
						cd_procedimento,
						ie_origem_proced,
						dt_atualizacao_nrec,
						nm_usuario_nrec)
		SELECT	nextval('pacote_tipo_acomod_proc_seq'),
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_tipo_acomod_w,
			cd_procedimento,
			ie_origem_proced,
			clock_timestamp(),
			nm_usuario_p
		from	pacote_tipo_acomod_proc
		where	nr_seq_pac_acomod	= c01_w.nr_sequencia;



		end;
	end loop;
	close C01;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_regra_pacote ( nr_pacote_orig_p bigint, nr_pacote_dest_p bigint, nm_usuario_p text, ie_procedimento_p text, ie_material_p text, ie_acomodacao_p text, ie_somente_ativo_p text, dt_vigencia_p timestamp, ie_deletar_p text, ie_excluir_dados_p text, ie_regra_cid_p text) FROM PUBLIC;

