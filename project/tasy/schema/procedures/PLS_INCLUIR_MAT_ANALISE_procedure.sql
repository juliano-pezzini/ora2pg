-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_incluir_mat_analise ( nr_seq_analise_p bigint, nr_seq_conta_mat_p bigint, nr_seq_grupo_atual_p bigint, nr_seq_conta_p bigint, ie_tipo_guia_p text, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_item_criado_p INOUT bigint) AS $body$
DECLARE

				
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  ]  Objetos do dicionário [ X ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ds_observacao_w			varchar(500);
cd_material_w			varchar(20);
ie_valor_informado_w		varchar(1)	:= 'N';
ie_geracao_pos_estab_w		varchar(1);
nr_seq_mat_w			bigint;
nr_seq_conta_w			bigint;
dt_material_w			timestamp;
ie_origem_conta_w		pls_conta.ie_origem_conta%type;
ie_consistir_analise_w		varchar(1);
i				integer;
nr_registro_anvisa_w		w_pls_conta_mat.nr_registro_anvisa%type;
ds_aut_funcionamento_w		w_pls_conta_mat.ds_aut_funcionamento%type;
cd_unidade_medida_w		w_pls_conta_mat.cd_unidade_medida%type;
cd_ref_fabricante_w		w_pls_conta_mat.cd_ref_fabricante%type;

c01 CURSOR( nm_usuario_pc text ) FOR
	SELECT	to_date(to_char(coalesce(dt_atendimento, clock_timestamp()),'dd/mm/yyyy') || ' ' || to_char(dt_inicio_atend,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss') dt_material,
		coalesce(vl_material_imp,0) vl_material_imp,
		coalesce(vl_unitario_imp,0) vl_unitario_imp,
		nr_nota_fiscal,
		nr_seq_prest_fornec,
		nr_seq_material,
		qt_material_imp,
		dt_inicio_atend,
		nr_registro_anvisa,
		ds_aut_funcionamento,
		cd_unidade_medida,
		cd_ref_fabricante,
		det_reg_anvisa
	from	w_pls_conta_mat
	where	nm_usuario	= nm_usuario_pc;
	
TYPE tb_w_pls_conta_mat_type IS
      TABLE OF c01%ROWTYPE
      INDEX BY integer;

tb_w_pls_conta_mat tb_w_pls_conta_mat_type;


BEGIN
ie_consistir_analise_w := Obter_Param_Usuario(1365, 16, wheb_usuario_pck.get_cd_perfil, nm_usuario_p, cd_estabelecimento_p, ie_consistir_analise_w);

begin
select	coalesce(ie_geracao_pos_estabelecido,'F')
into STRICT	ie_geracao_pos_estab_w
from	pls_parametros
where	cd_estabelecimento	= cd_estabelecimento_p;
exception
when others then
	ie_geracao_pos_estab_w := null;
end;

if (nr_seq_conta_p IS NOT NULL AND nr_seq_conta_p::text <> '') then
	/*Obtem a conta principal do tipo de guia passada*/

	select	max(ie_origem_conta)
	into STRICT	ie_origem_conta_w
	from	pls_conta
	where	nr_sequencia	= nr_seq_conta_p;
	
	nr_seq_conta_w	:= nr_seq_conta_p;
else
	select	min(nr_sequencia),
		max(ie_origem_conta)
	into STRICT	nr_seq_conta_w,
		ie_origem_conta_w
	from	pls_conta
	where	nr_seq_analise	= nr_seq_analise_p
	and	ie_tipo_guia	= ie_tipo_guia_p;	
end if;

if (ie_origem_conta_w	= 'A') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(277096);
end if;

open  c01(nm_usuario_p);
loop
	fetch c01 bulk collect into tb_w_pls_conta_mat limit 100;

	exit when tb_w_pls_conta_mat.count = 0;	
	
	for i in tb_w_pls_conta_mat.first..tb_w_pls_conta_mat.last loop

select	coalesce(tb_w_pls_conta_mat[i].dt_material, dt_emissao)
into STRICT	dt_material_w
from	pls_conta
where	nr_sequencia	= nr_seq_conta_w;

select	nextval('pls_conta_mat_seq')
into STRICT	nr_seq_mat_w
;

insert into pls_conta_mat(
	nr_sequencia,
	nr_seq_material,
	qt_material,
	qt_material_imp,
	vl_unitario_imp,
	vl_material_imp,
	dt_atendimento,
	nr_seq_conta,
	nm_usuario,
	nm_usuario_nrec,
	dt_atualizacao, 
	dt_atualizacao_nrec, 
	ie_situacao, 
	ie_status, 
	nr_nota_fiscal,
	nr_seq_prest_fornec,
	vl_unitario,  
	vl_liberado,	 
	ie_valor_informado,
	ie_vl_apresentado_sistema, 
	dt_inicio_atend,
	nr_registro_anvisa,
	ds_aut_funcionamento,
	cd_unidade_medida,
	cd_ref_fabricante,
	ie_acao_analise,
	det_reg_anvisa)
values (
	nr_seq_mat_w,
	tb_w_pls_conta_mat[i].nr_seq_material,
	0,
	tb_w_pls_conta_mat[i].qt_material_imp,
	tb_w_pls_conta_mat[i].vl_unitario_imp,
	tb_w_pls_conta_mat[i].vl_material_imp,
	dt_material_w,
	nr_seq_conta_w,
	nm_usuario_p,
	nm_usuario_p,
	clock_timestamp(), 
	clock_timestamp(), 
	'D', 
	'U', 
	tb_w_pls_conta_mat[i].nr_nota_fiscal,
	tb_w_pls_conta_mat[i].nr_seq_prest_fornec,
	0, 
	0,
	ie_valor_informado_w,
	'N', 
	tb_w_pls_conta_mat[i].dt_inicio_atend,
	tb_w_pls_conta_mat[i].nr_registro_anvisa,
	tb_w_pls_conta_mat[i].ds_aut_funcionamento,
	tb_w_pls_conta_mat[i].cd_unidade_medida,
	tb_w_pls_conta_mat[i].cd_ref_fabricante,
	'I',
	tb_w_pls_conta_mat[i].det_reg_anvisa);
	
CALL pls_cta_proc_mat_regra_pck.cria_registro_regra_mat(nr_seq_mat_w, nm_usuario_p);
CALL pls_cta_proc_mat_regra_pck.gera_seq_tiss_mat(nr_seq_mat_w, null, null, nr_seq_conta_w, nm_usuario_p);


/*Rotina para vincular regra de liberacao de valores para conta no procedimento, quando inserido manualmente pela anaálise. */

update	pls_conta_mat
set	ie_status	= 'A'
where	nr_sequencia	= nr_seq_mat_w;

if (ie_geracao_pos_estab_w = 'C')then
	CALL pls_gerar_valor_pos_estab(nr_seq_conta_w, nm_usuario_p, ie_geracao_pos_estab_w,null,nr_seq_mat_w,'A');
end if;

ds_observacao_w :=	'Material inserido: '||coalesce(cd_material_w,tb_w_pls_conta_mat[i].nr_seq_material) || '-' || pls_obter_desc_material(tb_w_pls_conta_mat[i].nr_seq_material) || chr(13) || chr(10) ||
			'Quantidade inserida: ' || tb_w_pls_conta_mat[i].qt_material_imp;
/*Inserindo histórico*/

CALL pls_inserir_hist_analise(nr_seq_conta_w,  nr_seq_analise_p, 20, nr_seq_mat_w, 'M', null, null,ds_observacao_w, nr_seq_grupo_atual_p, nm_usuario_p,cd_estabelecimento_p);

nr_seq_item_criado_p	:= nr_seq_mat_w;
if (ie_consistir_analise_w = 'N') then
	CALL pls_analise_consistir_item(nr_seq_analise_p, 'I', nr_seq_grupo_atual_p, nr_seq_conta_p, null, nr_seq_mat_w, cd_estabelecimento_p, nm_usuario_p);
end if;
	
	end loop;
		
end loop;

close c01;

delete	from w_pls_conta_mat
where	nm_usuario	= nm_usuario_p;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_incluir_mat_analise ( nr_seq_analise_p bigint, nr_seq_conta_mat_p bigint, nr_seq_grupo_atual_p bigint, nr_seq_conta_p bigint, ie_tipo_guia_p text, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_item_criado_p INOUT bigint) FROM PUBLIC;

