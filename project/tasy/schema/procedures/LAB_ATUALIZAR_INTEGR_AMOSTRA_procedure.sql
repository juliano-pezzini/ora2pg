-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_atualizar_integr_amostra (nr_prescricao_p bigint, ie_status_pos_envio_p bigint, ie_status_envio_p bigint, sigla_equip_p text, nm_usuario_p text, cd_interface_p bigint default null) AS $body$
DECLARE

nr_seq_proc_mat_item_w	bigint;
nr_seq_prescr_w		bigint;
qt_etapa_amostra_w	smallint;
qt_total_amostra_w	smallint;
ie_tipo_atendimento_w	bigint;
cd_estabelecimento_w	bigint;
sigla_equip_w		varchar(255);

c01 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.nr_seq_prescr
	from	prescr_proc_mat_item a,
		prescr_procedimento b
	where	a.nr_seq_prescr  = b.nr_sequencia
	and	a.nr_prescricao = b.nr_prescricao
	and 	(b.nr_seq_exame IS NOT NULL AND b.nr_seq_exame::text <> '')
	and	coalesce(a.dt_integracao::text, '') = ''
	and	a.ie_status = ie_status_envio_p
	and	(Obter_Equip_Exame_online(b.nr_seq_exame,null,sigla_equip_w,ie_tipo_atendimento_w, cd_estabelecimento_w) IS NOT NULL AND (Obter_Equip_Exame_online(b.nr_seq_exame,null,sigla_equip_w,ie_tipo_atendimento_w, cd_estabelecimento_w))::text <> '')
	and	a.nr_prescricao = nr_prescricao_p;



BEGIN
CALL gravar_log_lab_pragma(
    cd_log_p => 2321,
    ds_log_p => 'nr_prescricao_p->'||nr_prescricao_p||
                ' - ie_status_pos_envio_p->'||ie_status_pos_envio_p||
                ' - ie_status_envio_p->'||ie_status_envio_p||
                ' - sigla_equip_p->'||sigla_equip_p||
                ' - nm_usuario_p->'||nm_usuario_p||
                ' - cd_interface_p->'||cd_interface_p,
    nm_usuario_p => nm_usuario_p,
    nr_prescricao_p => nr_prescricao_p
);

select	coalesce(max(ds_valor_dominio),sigla_equip_p)
into STRICT	sigla_equip_w
from	valor_dominio
where	cd_dominio = 1638
and	vl_dominio = cd_interface_p;


select	max(b.ie_tipo_atendimento),
	max(a.cd_estabelecimento)
into STRICT	ie_tipo_atendimento_w,
	cd_estabelecimento_w
from	prescr_medica a,
	atendimento_paciente b
where	a.nr_atendimento = b.nr_atendimento
and	a.nr_prescricao = nr_prescricao_p;


open c01;
loop
fetch c01 into
	nr_seq_proc_mat_item_w,
	nr_seq_prescr_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
	update 	prescr_proc_mat_item
	set 	ie_status = ie_status_pos_envio_p,
		dt_integracao = clock_timestamp(),
		dt_atualizacao = clock_timestamp(),
		nm_usuario = nm_usuario_p
	where 	nr_sequencia = nr_seq_proc_mat_item_w;

	/*insert into log  tasy
		(DT_ATUALIZACAO,
		NM_USUARIO,
		CD_LOG,
		DS_LOG)
	values	(sysdate,
		nm_usuario_p,
		-7706,
		'lab_atualizar_integr_amostra - nr_seq_proc_mat_item_w='||nr_seq_proc_mat_item_w||' ie_status_pos_envio_p: '||ie_status_pos_envio_p||' nr_prescricao_p: '||nr_prescricao_p);
	*/
	
	select  count(*)
	into STRICT	qt_total_amostra_w
	from	prescr_proc_mat_item
	where	nr_prescricao = nr_prescricao_p
	and	nr_seq_prescr = nr_seq_prescr_w;

	select count(*)
	into STRICT	qt_etapa_amostra_w
	from	prescr_proc_mat_item
	where	nr_prescricao 	= nr_prescricao_p
	and	ie_status 	= ie_status_pos_envio_p
	and	nr_seq_prescr 	= nr_seq_prescr_w;

    CALL gravar_log_lab_pragma(
        cd_log_p => 2322,
        ds_log_p => 'qt_total_amostra_w->'||qt_total_amostra_w||
                    ' - qt_etapa_amostra_w->'||qt_etapa_amostra_w,
        nm_usuario_p => nm_usuario_p,
        nr_prescricao_p => nr_prescricao_p
    );

	if (qt_total_amostra_w = qt_etapa_amostra_w) and (qt_etapa_amostra_w > 0) then

		update prescr_procedimento
		set ie_status_atend = ie_status_pos_envio_p,
		    dt_integracao = clock_timestamp(),
		    nm_usuario = nm_usuario_p,
		    dt_atualizacao = clock_timestamp()
		where nr_prescricao = nr_prescricao_p
		and nr_sequencia = nr_seq_prescr_w
		and coalesce(dt_integracao::text, '') = ''
		and ie_status_atend <= ie_status_pos_envio_p;


	end if;
	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_atualizar_integr_amostra (nr_prescricao_p bigint, ie_status_pos_envio_p bigint, ie_status_envio_p bigint, sigla_equip_p text, nm_usuario_p text, cd_interface_p bigint default null) FROM PUBLIC;

