-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_diops_cadastral ( nr_seq_operadora_p bigint, nr_seq_periodo_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Gerar as informações cadastrais do DIOPS
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[ X ]  Objetos do dicionário [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
-------------------------------------------------------------------------------------------------------------------
Referências:
	PLS_GERAR_DIOPS
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nm_fantasia_w			varchar(255);
ds_email_repre_um_w		varchar(255);
ds_email_repre_dois_w		varchar(255);
ds_email_repre_rn117_w		varchar(255);
nm_resp_tecnico_w		varchar(255);
ds_razao_social_w		varchar(80);
ds_transacao_w			varchar(60);
ds_email_w			varchar(60);
nm_representante_w		varchar(60);
nm_repre_rn117_w		varchar(60);
cd_ans_w			varchar(20);
nr_rg_repre_rn117_w		varchar(15);
cd_cgc_w			varchar(14);
nr_cpf_representante_w		varchar(11);
nr_cpf_repre_rn117_w		varchar(11);
cd_representante_w		varchar(10);
cd_repre_rn117_w		varchar(10);
ds_orgao_emis_rn117_w		pessoa_fisica.ds_orgao_emissor_ci%type;
ie_seg_operadora_w		varchar(6);
ie_tipo_operadora_w		varchar(2);
cd_cargo_repre_rn117_w		integer;
cd_estabelecimento_w		smallint;
cd_pais_repre_rn117_w		smallint;
dt_periodo_inicial_w		timestamp;
dt_periodo_final_w		timestamp;
dt_expedicao_rn117_w		timestamp;
dt_validade_rg_rn117_w		timestamp;


BEGIN
/* Limpar tabelas transitórias */

delete	from w_diops_cad_telfax
where	nr_seq_operadora	= nr_seq_operadora_p
and	nr_seq_periodo		= nr_seq_periodo_p;

delete	from w_diops_cad_endereco
where	nr_seq_operadora	= nr_seq_operadora_p
and	nr_seq_periodo		= nr_seq_periodo_p;

delete	from w_diops_cad_mun_atuacao
where	nr_seq_operadora	= nr_seq_operadora_p
and	nr_seq_periodo		= nr_seq_periodo_p;

delete	from w_diops_cad_responsavel
where	nr_seq_operadora	= nr_seq_operadora_p
and	nr_seq_periodo		= nr_seq_periodo_p;

delete	from w_diops_cad_administrador
where	nr_seq_operadora	= nr_seq_operadora_p
and	nr_seq_periodo		= nr_seq_periodo_p;

delete	from w_diops_cad_resp_tecnico
where	nr_seq_operadora	= nr_seq_operadora_p
and	nr_seq_periodo		= nr_seq_periodo_p;

delete	from w_diops_cad_acion_pf_pj
where	nr_seq_operadora	= nr_seq_operadora_p
and	nr_seq_periodo		= nr_seq_periodo_p;

delete	from w_diops_cad_acionquotista
where	nr_seq_operadora	= nr_seq_operadora_p
and	nr_seq_periodo		= nr_seq_periodo_p;

delete	from w_diops_cad_coligadas
where	nr_seq_operadora	= nr_seq_operadora_p
and	nr_seq_periodo		= nr_seq_periodo_p;

delete	from w_diops_cad_emp_depend
where	nr_seq_operadora	= nr_seq_operadora_p
and	nr_seq_periodo		= nr_seq_periodo_p;

delete	from w_diops_cad_identif
where	nr_seq_operadora	= nr_seq_operadora_p
and	nr_seq_periodo		= nr_seq_periodo_p;

ds_transacao_w	:= 'ENVIO_DIOPS_CADASTRAL';

/* Obter dados da operadora */

begin
select	cd_ans,
	cd_cgc_outorgante,
	ie_tipo_outorgante,
	cd_estabelecimento,
	ie_segmentacao_operadora,
	cd_representante,
	cd_representante_rn117,
	cd_cargo_rep_rn117,
	nm_fantasia
into STRICT	cd_ans_w,
	cd_cgc_w,
	ie_tipo_operadora_w,
	cd_estabelecimento_w,
	ie_seg_operadora_w,
	cd_representante_w,
	cd_repre_rn117_w,
	cd_cargo_repre_rn117_w,
	nm_fantasia_w
from	pls_outorgante
where	nr_sequencia	= nr_seq_operadora_p;

ds_razao_social_w	:= substr(obter_razao_social(cd_cgc_w),1,80);
nr_cpf_representante_w	:= substr(obter_dados_pf(cd_representante_w, 'CPF'),1,11);
nm_representante_w	:= substr(obter_nome_pf(cd_representante_w),1,60);

begin
ds_email_repre_um_w	:= substr(obter_compl_pf(cd_representante_w, 1, 'M'),1,255);
exception
when others then
	ds_email_repre_um_w	:= null;
end;

nr_cpf_repre_rn117_w	:= substr(obter_dados_pf(cd_repre_rn117_w, 'CPF'),1,11);
nm_repre_rn117_w	:= substr(obter_nome_pf(cd_repre_rn117_w),1,60);

begin
ds_email_repre_rn117_w	:= substr(obter_compl_pf(cd_repre_rn117_w, 1, 'M'),1,255);
exception
when others then
	ds_email_repre_rn117_w	:= null;
end;

nr_rg_repre_rn117_w	:= substr(obter_dados_pf(cd_repre_rn117_w, 'RG'),1,11);
dt_expedicao_rn117_w	:= to_date(substr(obter_dados_pf(cd_repre_rn117_w, 'DRG'),1,10),'dd/mm/yyyy');
ds_orgao_emis_rn117_w	:= obter_dados_pf(cd_repre_rn117_w, 'O');
dt_validade_rg_rn117_w	:= to_date(substr(obter_dados_pf(cd_repre_rn117_w, 'VRG'),1,10),'dd/mm/yyyy');

exception
when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(233796, 'NR_SEQ_OPERADORA=' + nr_seq_operadora_p);
end;

/* Obter dados do DIOPS */

begin
select	coalesce(dt_periodo_inicial,''),
	coalesce(dt_periodo_final, '')
into STRICT	dt_periodo_inicial_w,
	dt_periodo_final_w
from	diops_periodo
where	nr_sequencia	= nr_seq_periodo_p;
exception
when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(183308, 'NR_SEQ_OPERADORA=' + nr_seq_operadora_p + ';' +
							'NR_SEQ_PERIODO=' + nr_seq_periodo_p);
end;

/* Obter dados da pessoa juridica */

begin
ds_email_w	:= substr(obter_dados_pf_pj_estab(cd_estabelecimento_w, '', cd_cgc_w, 'M'),1,60);
exception
when others then
	ds_email_w	:= null;
end;

/*obter_dados_pais*/

select	coalesce(max(c.cd_pais_sib),'32')
into STRICT	cd_pais_repre_rn117_w
from	pais			c,
	compl_pessoa_fisica	b,
	pessoa_fisica		a
where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
and	b.nr_seq_pais		= c.nr_sequencia
and	b.ie_tipo_complemento	= 1
and	a.cd_pessoa_fisica	= cd_repre_rn117_w;

/* obter e-mail comercial */

select	max(b.ds_email)
into STRICT	ds_email_repre_dois_w
from	compl_pessoa_fisica	b,
	pessoa_fisica		a
where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
and	b.ie_tipo_complemento	= 2
and	a.cd_pessoa_fisica	= cd_representante_w;

insert into w_diops_cad_identif(nr_sequencia,
	nr_seq_operadora,
	cd_ans,
	ds_razao_social,
	cd_cgc,
	dt_periodo_inicial,
	ds_transacao,
	dt_atualizacao,
	nm_usuario,
	ie_tipo_operadora,
	cd_estabelecimento,
	nm_fantasia,
	ds_email,
	ie_segmentacao_operadora,
	cd_representante,
	nr_cpf_representante,
	nm_representante,
	ds_email_repre_um,
	ds_email_repre_dois,
	cd_repre_rn117,
	nr_cpf_repre_rn117,
	nm_repre_rn117,
	ds_email_repre_rn117,
	nr_rg_repre_rn117,
	dt_expedicao_rn117,
	ds_orgao_emissor_rn117,
	dt_validade_rg_rn117,
	cd_pais_repre_rn117,
	cd_cargo_repre_rn117,
	dt_periodo_final,
	nr_seq_periodo)
values (nextval('w_diops_cad_identif_seq'),
	nr_seq_operadora_p,
	cd_ans_w,
	ds_razao_social_w,
	cd_cgc_w,
	dt_periodo_inicial_w,
	ds_transacao_w,
	clock_timestamp(),
	nm_usuario_p,
	ie_tipo_operadora_w,
	cd_estabelecimento_w,
	nm_fantasia_w,
	ds_email_w,
	ie_seg_operadora_w,
	cd_representante_w,
	nr_cpf_representante_w,
	nm_representante_w,
	ds_email_repre_um_w,
	ds_email_repre_dois_w,
	cd_repre_rn117_w,
	nr_cpf_repre_rn117_w,
	nm_repre_rn117_w,
	ds_email_repre_rn117_w,
	nr_rg_repre_rn117_w,
	dt_expedicao_rn117_w,
	ds_orgao_emis_rn117_w,
	dt_validade_rg_rn117_w,
	cd_pais_repre_rn117_w,
	cd_cargo_repre_rn117_w,
	dt_periodo_final_w,
	nr_seq_periodo_p);

/* ct_enderecoDiops */

CALL diops_cadastral_gerar_endereco(nr_seq_operadora_p, nr_seq_periodo_p, nm_usuario_p);

/* ct_telefone */

CALL diops_cadastral_gerar_telfax(nr_seq_operadora_p, nr_seq_periodo_p, nm_usuario_p);

/* ct_municipiosAtuacao */

CALL diops_cad_gerar_munatuacao(nr_seq_operadora_p, nr_seq_periodo_p, nm_usuario_p);

/* ct_responsavel */

CALL diops_cad_gerar_responsavel(nr_seq_operadora_p, nr_seq_periodo_p, nm_usuario_p);

/* ct_administradores */

CALL diops_cad_gerar_adm(nr_seq_operadora_p, nr_seq_periodo_p, nm_usuario_p);

/* ct_respTecnico */

CALL diops_cad_gerar_resp_tecnico(nr_seq_operadora_p, nr_seq_periodo_p, nm_usuario_p);

/* ct_acionista */

CALL diops_cad_gerar_acionquotista(nr_seq_operadora_p, nr_seq_periodo_p, nm_usuario_p);

/* ct_controlColigadas */

CALL diops_cad_gerar_coligadas(nr_seq_operadora_p, nr_seq_periodo_p, nm_usuario_p);

/* ct_empresaDependente */

CALL diops_cad_gerar_emp_depend(nr_seq_operadora_p, nr_seq_periodo_p, nm_usuario_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_diops_cadastral ( nr_seq_operadora_p bigint, nr_seq_periodo_p bigint, nm_usuario_p text) FROM PUBLIC;

