-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_conversao_mat_conv ( cd_convenio_p bigint, cd_material_conv_p text, ds_material_conv_p text, cd_unidade_conv_p text, nm_usuario_p text, ie_acao_p text) AS $body$
DECLARE


qt_mat_conv_w		bigint;


BEGIN

if (ie_acao_p = 'U') then

	update	conversao_material_convenio
	set	dt_final_vigencia	= clock_timestamp(),
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp()
	where	cd_convenio		= cd_convenio_p
	and	coalesce(dt_final_vigencia::text, '') = '';
	commit;

end if;

if (ie_acao_p = 'I') then
	select 	count(*)
	into STRICT	qt_mat_conv_w
	from 	conversao_material_convenio
	where  	cd_convenio 		= cd_convenio_p
	and  	cd_material_convenio 	= substr(cd_material_conv_p,1,20);

	if (qt_mat_conv_w = 0) then

		insert into conversao_material_convenio(
				nr_sequencia,
	        	        cd_convenio,
        			cd_material_convenio,
                		dt_atualizacao,
                	        nm_usuario,
                	        cd_grupo_material,
                	        cd_subgrupo_material,
                	        cd_classe_material,
                	        cd_material,
                	        ds_material_convenio,
                	        cd_grupo,
                	        tx_conversao_qtde,
				cd_unidade_convenio,
				cd_setor_atendimento,
                	        cd_cgc,
                	        ie_situacao,
				dt_inicio_vigencia)
			values (
				nextval('conversao_mat_convenio_seq'),
                	        cd_convenio_p,
                	        substr(cd_material_conv_p,1,20),
				clock_timestamp(),
				nm_usuario_p,
                	        null,
				null,
				null,
                	        null,
				substr(ds_material_conv_p,1,200),
				null,
                	        null,
				substr(cd_unidade_conv_p,1,5),
				null,
				null,
                	        'I',
				clock_timestamp());

	else

		update	conversao_material_convenio
		set	dt_final_vigencia	 = NULL,
			nm_usuario		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp()
		where	cd_convenio		= cd_convenio_p
		and	cd_material_convenio 	= substr(cd_material_conv_p,1,20);

	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_conversao_mat_conv ( cd_convenio_p bigint, cd_material_conv_p text, ds_material_conv_p text, cd_unidade_conv_p text, nm_usuario_p text, ie_acao_p text) FROM PUBLIC;

