-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_titulo_ressarcimento ( nr_seq_processo_p bigint, dt_vencimento_p timestamp, dt_documento_p timestamp, nr_documento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


cd_moeda_w			integer;
vl_ressarcir_w			double precision;
nr_titulo_w			bigint;
nr_seq_classif_w		bigint;
cd_conta_financ_w		bigint;
cd_cgc_param_w			pls_parametros.cd_cgc_ressarc%type;
nr_seq_trans_fin_baixa_ress_w	pls_parametros.nr_seq_trans_fin_baixa_ress%type;
nr_seq_classe_ressarc_w		pls_parametros.nr_seq_classe_ressarc%type;


BEGIN

select	pls_processo_obter_valor(nr_sequencia,4)
into STRICT	vl_ressarcir_w
from	pls_processo
where	nr_sequencia	= nr_seq_processo_p;

select	cd_moeda_padrao
into STRICT	cd_moeda_w
from	parametros_contas_pagar
where	cd_estabelecimento = cd_estabelecimento_p;

select	cd_conta_financ_ressarcimento,
	cd_cgc_ressarc,
	nr_seq_trans_fin_baixa_ress,
	nr_seq_classe_ressarc
into STRICT	cd_conta_financ_w,
	cd_cgc_param_w,
	nr_seq_trans_fin_baixa_ress_w,
	nr_seq_classe_ressarc_w
from	pls_parametros
where	cd_estabelecimento	= cd_estabelecimento_p;

insert into titulo_pagar(	nr_titulo,
				cd_estabelecimento,
				dt_atualizacao,
				nm_usuario,
				dt_contabil,
				dt_emissao,
				dt_vencimento_original,
				dt_vencimento_atual,
				vl_titulo,
				vl_saldo_titulo,
				vl_saldo_juros,
				vl_saldo_multa,
				cd_moeda,
				ie_origem_titulo,
				ie_situacao,
				ie_pls,
				ie_tipo_titulo,
				tx_juros,
				tx_multa,
				cd_tipo_taxa_juro,
				cd_tipo_taxa_multa,
				cd_cgc,
				nr_seq_processo,
				nr_documento,
				ie_status,
				nr_seq_trans_fin_baixa,
				nr_seq_classe)
			values (	nextval('titulo_pagar_seq'),
				cd_estabelecimento_p,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				dt_documento_p,
				dt_vencimento_p,
				dt_vencimento_p,
				vl_ressarcir_w,
				vl_ressarcir_w,
				0,
				0,
				cd_moeda_w,
				'9',
				'A',
				'S',
				'10',
				0,
				0,
				1,
				1,
				cd_cgc_param_w,
				nr_seq_processo_p,
				nr_documento_p,
				'D',
				nr_seq_trans_fin_baixa_ress_w,
				nr_seq_classe_ressarc_w) returning nr_titulo into nr_titulo_w;

			CALL atualizar_inclusao_tit_pagar(nr_titulo_w, nm_usuario_p);

select	coalesce(max(nr_sequencia),0) + 1
into STRICT	nr_seq_classif_w
from	titulo_pagar_classif
where	nr_titulo	= nr_titulo_w;

insert into titulo_pagar_classif(	dt_atualizacao,
					nm_usuario,
					nr_seq_conta_financ,
					nr_sequencia,
					nr_titulo,
					vl_acrescimo,
					vl_desconto,
					vl_original,
					vl_titulo)
				values (	clock_timestamp(),
					nm_usuario_p,
					cd_conta_financ_w,
					nr_seq_classif_w,
					nr_titulo_w,
					0,
					0,
					vl_ressarcir_w,
					vl_ressarcir_w);

update	pls_processo_conta
set	ie_status_pagamento	= CASE WHEN vl_ressarcir=0 THEN 'N'  ELSE 'R' END  -- N - Não haverá pagamento - R - Ressarcimento pago
where	nr_seq_processo		= nr_seq_processo_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_titulo_ressarcimento ( nr_seq_processo_p bigint, dt_vencimento_p timestamp, dt_documento_p timestamp, nr_documento_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

