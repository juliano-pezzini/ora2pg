-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_dados_painel_cir_ini_fim ( ie_informacao_p text, nr_seq_agenda_p bigint, ie_origem_informacao_p text, nm_usuario_p text) AS $body$
DECLARE


/*
ie_informacao_p:
DT_PACIENTE_AGUARDO	- DPA
DT_CHEGADA		- DC
DT_CHEGADA_FIM		- DCF
DT_SALA_RECUPERACAO	- DSR
DT_ALTA_CC		- DAC
DT_SAIDA_PACIENTE_CC - DS
DT_ANALISE		- IN
DT_CHAMADA_PRE_INDUCAO	- DCP
DT_PACIENTE_AGUARDO	- PA

ie_origem_informacao_p:
'A' = Gestão da Agenda Cirúrgica (AtePacA6)
'P' = PEPO
*/
dt_chegada_w			timestamp;
dt_chegada_fim_w		timestamp;
dt_sala_recuperacao_w		timestamp;
dt_alta_cc_w			timestamp;
dt_saida_paciente_cc_w		timestamp;
dt_analise_w			timestamp;
dt_chamada_pre_inducao_w	timestamp;
nr_cirurgia_w			bigint;
cd_agenda_w			bigint;
dt_agenda_w			timestamp;
hr_inicio_w			timestamp;
hr_inicio_ww			timestamp;
qt_agenda_w			bigint;
dt_paciente_aguardo_w		timestamp;


BEGIN


IF (ie_informacao_p = 'DPA') THEN
		UPDATE	agenda_paciente
		SET 	dt_paciente_aguardo = clock_timestamp()
		WHERE 	nr_sequencia = nr_seq_agenda_p;

ELSIF (ie_informacao_p = 'DC') THEN
		UPDATE	agenda_paciente
		SET 	dt_chegada = clock_timestamp()
		WHERE 	nr_sequencia = nr_seq_agenda_p;

ELSIF (ie_informacao_p = 'DCF') THEN
		UPDATE 	agenda_paciente
		SET 	dt_chegada_fim = clock_timestamp()
		WHERE 	nr_sequencia = nr_seq_agenda_p;

ELSIF (ie_informacao_p = 'DSR') THEN
		UPDATE 	agenda_paciente
		SET 	dt_sala_recuperacao = clock_timestamp()
		WHERE 	nr_sequencia = nr_seq_agenda_P;

ELSIF (ie_informacao_p = 'DAC') THEN
		UPDATE 	agenda_paciente
		SET 	dt_alta_cc = clock_timestamp()
		WHERE 	nr_sequencia = nr_seq_agenda_p;

ELSIF (ie_informacao_p = 'DS') THEN

		UPDATE	agenda_paciente
		SET 	dt_saida_paciente_cc 	= clock_timestamp()
		WHERE 	nr_sequencia 			= nr_seq_agenda_p;

ELSIF (ie_informacao_p = 'IN') THEN

		UPDATE	agenda_paciente
		SET 	dt_analise = clock_timestamp()
		WHERE 	nr_sequencia = nr_seq_agenda_p;


ELSIF (ie_informacao_p = 'PA') THEN
		UPDATE	agenda_paciente
		SET 	dt_paciente_aguardo = clock_timestamp()
		WHERE 	nr_sequencia = nr_seq_agenda_p;

ELSIF (ie_informacao_p = 'E') THEN
	BEGIN

	SELECT	max(cd_agenda),
		max(hr_inicio)
	INTO STRICT	cd_agenda_w,
		hr_inicio_w
	FROM	agenda_paciente
	where	nr_sequencia = nr_seq_agenda_p;

	select	max(hr_inicio)
	into STRICT	hr_inicio_ww
	from	agenda_paciente
	where	cd_agenda 	 = cd_agenda_w
	and	hr_inicio 	 = hr_inicio_w
	and	ie_status_agenda = 'E'
	and	nr_sequencia 	 <> nr_seq_agenda_p;

	UPDATE	agenda_paciente
	SET 	ie_status_agenda = 'E',
		hr_inicio	 = CASE WHEN hr_inicio_ww = NULL THEN hr_inicio  ELSE hr_inicio_ww + 1/86400 END
	WHERE 	nr_sequencia 	 = nr_seq_agenda_p;


	END;

ELSIF (ie_informacao_p = 'DCP') THEN

		UPDATE	agenda_paciente
		SET 	dt_chamada_pre_inducao = clock_timestamp()
		WHERE 	nr_sequencia = nr_seq_agenda_p;

END IF;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_dados_painel_cir_ini_fim ( ie_informacao_p text, nr_seq_agenda_p bigint, ie_origem_informacao_p text, nm_usuario_p text) FROM PUBLIC;

