-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE solicitar_paracer_aprovacao ( nr_sequencia_p bigint, nr_seq_proc_aprov_p bigint, nm_usuario_p text, nm_usuario_parecer_p text, ds_observacao_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_seq_regra_w			bigint;
nr_sequencia_w			bigint;
nr_seq_classif_w			bigint;
ds_titulo_w			varchar(80);
ds_comunicado_w			varchar(2000);
nm_usuario_w			varchar(2000);
qt_regra_usuario_w			bigint;
nr_ordem_solic_w			bigint;
ds_documento_w			varchar(80) := wheb_mensagem_pck.get_texto(799918);
cd_estabelecimento_w		integer;
ds_estabelecimento_w		varchar(255);
cd_perfil_w			varchar(10);
ie_ci_lida_w			varchar(1);

ds_setor_adicional_w                   	varchar(2000) := '';

cd_setor_regra_usuario_w		integer;
ds_observacao_w			varchar(2000);

c01 CURSOR FOR
SELECT	b.nr_sequencia,
	b.cd_perfil
from	regra_envio_comunic_compra a,
	regra_envio_comunic_evento b
where	a.nr_sequencia = b.nr_seq_regra
and	a.cd_funcao = 267
and	b.cd_evento = 6
and	b.ie_situacao = 'A'
and	a.cd_estabelecimento = cd_estabelecimento_p
and	substr(obter_se_envia_ci_regra_compra(b.nr_sequencia,0,'X',obter_perfil_ativo,nm_usuario_p,null),1,1) = 'S';

c05 CURSOR FOR
SELECT	coalesce(a.cd_setor_atendimento,0) cd_setor_atendimento
from	regra_envio_comunic_usu a
where	a.nr_seq_evento = nr_seq_regra_w;


BEGIN

select	max(ds_observacao)
into STRICT	ds_observacao_w
from	processo_aprov_compra
where	nr_sequencia	= nr_sequencia_p
and	nr_seq_proc_aprov = nr_seq_proc_aprov_p;

if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '')then
  ds_observacao_w := ds_observacao_w || chr(10) || chr(10);
end if;

ds_observacao_w	:= substr(wheb_mensagem_pck.get_texto(821690,
					'DS_OBSERVACAO=' || substr(ds_observacao_w,1,1900) ||
					';NM_USUARIO=' || nm_usuario_p ||
					';DT_SOLIC=' || clock_timestamp() ||
					';NM_USUARIO_PARECER=' || nm_usuario_parecer_p ||
					';DS_OBSERVACAO_P=' ||  substr(ds_observacao_p,1,1900)),1,2000);

update	processo_aprov_compra
set	nm_usuario_parecer	= nm_usuario_parecer_p,
	nm_usuario_solic_parecer	= nm_usuario_p,
	dt_solic_parecer		= clock_timestamp(),
	dt_resp_parecer		= '',
	ds_observacao		= ds_observacao_w

where	nr_sequencia		= nr_sequencia_p
and	nr_seq_proc_aprov	= nr_seq_proc_aprov_p;

select	coalesce(max(a.nr_solic_compra),0),
	coalesce(max(b.cd_estabelecimento),0)
into STRICT	nr_ordem_solic_w,
	cd_estabelecimento_w
from	solic_compra_item a,
	solic_compra b
where 	a.nr_solic_compra	= b.nr_solic_compra	
and	nr_seq_aprovacao	= nr_sequencia_p;

if (nr_ordem_solic_w = 0) then	
	select	coalesce(max(a.nr_ordem_compra),0),
		coalesce(max(b.cd_estabelecimento),0)
	into STRICT	nr_ordem_solic_w,
		cd_estabelecimento_w
	from	ordem_compra_item a,
		ordem_compra b
	where	a.nr_ordem_compra		= b.nr_ordem_compra
	and	a.nr_seq_aprovacao	= nr_sequencia_p;
	
	ds_documento_w := wheb_mensagem_pck.get_texto(799924);--'Ordem';
	
	if (nr_ordem_solic_w = 0) then	
		select	coalesce(max(a.nr_requisicao),0),
			coalesce(max(a.cd_estabelecimento),0)
		into STRICT	nr_ordem_solic_w,
			cd_estabelecimento_w
		from	requisicao_material a,
			item_requisicao_material b
		where	a.nr_requisicao	= b.nr_requisicao
		and	nr_seq_aprovacao	= nr_sequencia_p;
		
		ds_documento_w := wheb_mensagem_pck.get_texto(799923);
		
		if (nr_ordem_solic_w = 0) then	
			select	coalesce(max(a.nr_cot_compra),0),
				coalesce(max(a.cd_estabelecimento),0)
			into STRICT	nr_ordem_solic_w,
				cd_estabelecimento_w
			from	cot_compra a,
				cot_compra_item b
			where	a.nr_cot_compra	= b.nr_cot_compra
			and	nr_seq_aprovacao	= nr_sequencia_p;
			
			ds_documento_w := wheb_mensagem_pck.get_texto(799925);
			
			if (nr_ordem_solic_w = 0) then	
				select	coalesce(max(a.nr_sequencia),0),
					coalesce(max(a.cd_estabelecimento),0)
				into STRICT	nr_ordem_solic_w,
					cd_estabelecimento_w
				from	nota_fiscal a,
					nota_fiscal_item b
				where	a.nr_sequencia	= b.nr_sequencia
				and	nr_seq_aprovacao	= nr_sequencia_p;
				
				ds_documento_w := wheb_mensagem_pck.get_texto(799926);

				if (nr_ordem_solic_w = 0) then	
					select	coalesce(max(a.nr_sequencia),0),
						coalesce(max(a.cd_estabelecimento),0)
					into STRICT	nr_ordem_solic_w,
						cd_estabelecimento_w
					from	reg_licitacao a,
						reg_lic_item b
					where	a.nr_sequencia	= b.nr_seq_licitacao
					and	b.nr_seq_aprovacao	= nr_sequencia_p;
					
					ds_documento_w := wheb_mensagem_pck.get_texto(799927);
				end if;
			end if;
		end if;	
	end if;		
end if;	

select	substr(obter_nome_estabelecimento(cd_estabelecimento_w),1,255)
into STRICT	ds_estabelecimento_w
;

open C01;
loop
fetch C01 into	
	nr_seq_regra_w,
	cd_perfil_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	select	b.ds_titulo,
		ds_comunicacao
	into STRICT	ds_titulo_w,
		ds_comunicado_w
	from	regra_envio_comunic_evento b,
		regra_envio_comunic_compra a
	where	a.nr_sequencia = b.nr_seq_regra
	and	b.nr_sequencia = nr_seq_regra_w;
	
	ds_comunicado_w := substr(replace_macro(ds_comunicado_w,'@nr_documento',nr_sequencia_p),1,2000);
	ds_comunicado_w := substr(replace_macro(ds_comunicado_w,'@ds_documento', ds_documento_w),1,2000);
	ds_comunicado_w := substr(replace_macro(ds_comunicado_w,'@nr_ordem_solic', nr_ordem_solic_w),1,2000);
	ds_comunicado_w := substr(replace_macro(ds_comunicado_w,'@usuario', nm_usuario_p),1,2000);
	ds_comunicado_w := substr(replace_macro(ds_comunicado_w,'@observacao', ds_observacao_p),1,2000);
	ds_comunicado_w := substr(replace_macro(ds_comunicado_w,'@estabelecimento', ds_estabelecimento_w),1,2000);
	
	select	obter_classif_comunic('P')
	into STRICT	nr_seq_classif_w
	;
	
	select	nextval('comunic_interna_seq')
	into STRICT	nr_sequencia_w
	;
	
	if (cd_perfil_w IS NOT NULL AND cd_perfil_w::text <> '') then
		cd_perfil_w := cd_perfil_w ||',';
	end if;
	
	open C05;
	loop
	fetch C05 into	
		cd_setor_regra_usuario_w;
	EXIT WHEN NOT FOUND; /* apply on C05 */
		begin
		if (cd_setor_regra_usuario_w <> 0) and (obter_se_contido_char(cd_setor_regra_usuario_w, ds_setor_adicional_w) = 'N') then
			ds_setor_adicional_w := substr(ds_setor_adicional_w || cd_setor_regra_usuario_w || ',',1,2000);
		end if;
		end;
	end loop;
	close C05;

	nm_usuario_w	:= nm_usuario_parecer_p || ',';
	
	select	count(*)
	into STRICT	qt_regra_usuario_w
	from	regra_envio_comunic_compra a,
		regra_envio_comunic_evento b,
		regra_envio_comunic_usu c
	where	a.nr_sequencia = b.nr_seq_regra
	and	b.nr_sequencia = c.nr_seq_evento
	and	b.nr_sequencia = nr_seq_regra_w;

	select	coalesce(ie_ci_lida,'N')
	into STRICT	ie_ci_lida_w
	from 	regra_envio_comunic_evento
	where 	nr_sequencia = nr_seq_regra_w;

	if (qt_regra_usuario_w > 0) then
		nm_usuario_w := obter_usuarios_comunic_compras(nr_sequencia_p,null,6,nr_seq_regra_w,nm_usuario_parecer_p);
	end if;
	
	insert into comunic_interna(
		dt_comunicado,		ds_titulo,
		ds_comunicado,		nm_usuario,
		dt_atualizacao,		ie_geral,
		nm_usuario_destino,	nr_sequencia,
		ie_gerencial,		nr_seq_classif,
		dt_liberacao,		ds_perfil_adicional,
		ds_setor_adicional)
	values (clock_timestamp(),			ds_titulo_w,
		ds_comunicado_w,		nm_usuario_p,
		clock_timestamp(),			'N',
		nm_usuario_w,		nr_sequencia_w,
		'N',			nr_seq_classif_w,
		clock_timestamp(),		cd_perfil_w,
		ds_setor_adicional_w);

	if (ie_ci_lida_w = 'S') then
		insert into comunic_interna_lida(nr_sequencia,nm_usuario,dt_atualizacao)values (nr_sequencia_w,nm_usuario_p,clock_timestamp());
	end if;

	end;
end loop;
close C01;
	
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE solicitar_paracer_aprovacao ( nr_sequencia_p bigint, nr_seq_proc_aprov_p bigint, nm_usuario_p text, nm_usuario_parecer_p text, ds_observacao_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

