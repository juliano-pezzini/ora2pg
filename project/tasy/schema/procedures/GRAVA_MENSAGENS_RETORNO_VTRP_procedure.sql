-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE grava_mensagens_retorno_vtrp (nr_sequencia_pdf_p bigint, cd_mensagem_ext_p text, nm_usuario_p text, cd_procedimento_p bigint, nr_seq_lote_externo_p bigint, novo_nr_lote_ext_p INOUT bigint) AS $body$
DECLARE


nr_sequencia_w             bigint;
nr_prescricao_w            bigint;
nr_seq_prescr_w            bigint;
cd_mensagem_ext_w          varchar(20);
nr_seq_exame_w             bigint;
cd_material_exame_w        varchar(20);
cd_setor_coleta_w          bigint;
nr_seq_lote_externo_w      bigint;
cd_cgc_externo_w	         varchar(14);
nr_atendimento_w	         atendimento_paciente.nr_atendimento%type;
cd_convenio_w		           convenio.cd_convenio%type;
cd_cgc_ext_cad_w	         exame_laboratorio_externo.cd_cgc_externo%type;
nr_seq_material_w	         exame_laboratorio_externo.nr_seq_material%type;
Ie_atual_desc_lote_w	     varchar(1);
ie_utilizar_setor_coleta_w varchar(1);
cd_estabelecimento_w       bigint;

C01 CURSOR FOR
  SELECT rl.nr_prescricao, rl.nr_seq_prescricao
    from result_laboratorio rl
   inner join result_laboratorio_pdf rlp on rlp.nr_seq_resultado = rl.nr_sequencia and rlp.nr_prescricao = rl.nr_prescricao and rlp.nr_seq_prescricao = rl.nr_seq_prescricao
   where rl.nr_sequencia = nr_sequencia_pdf_p
     and ((rl.cd_procedimento = cd_procedimento_p) or (coalesce(cd_procedimento_p::text, '') = ''))

union

  SELECT pp.nr_prescricao, pp.nr_sequencia nr_seq_prescricao
    from prescr_procedimento pp
   inner join result_laboratorio rl on rl.nr_prescricao = pp.nr_prescricao and rl.nr_seq_prescricao = pp.nr_sequencia
   inner join result_laboratorio_pdf rlp on rlp.nr_seq_resultado = rl.nr_sequencia and rlp.nr_prescricao = rl.nr_prescricao and rlp.nr_seq_prescricao = rl.nr_seq_prescricao
   where pp.nr_seq_lote_externo = nr_seq_lote_externo_p
     and ((pp.cd_procedimento = cd_procedimento_p) or (coalesce(cd_procedimento_p::text, '') = ''));

BEGIN
  nr_seq_lote_externo_w := null;

  select max(cd_estabelecimento)
    into STRICT cd_estabelecimento_w
    from lab_lote_externo
   where nr_sequencia = nr_seq_lote_externo_p;

	open C01;
	loop
	fetch C01 into nr_prescricao_w, nr_seq_prescr_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */

    if (cd_mensagem_ext_p <> '1') then
      update prescr_procedimento set nr_seq_lote_externo  = NULL
       where nr_prescricao = nr_prescricao_w
         and nr_sequencia = nr_seq_prescr_w;

      select pp.nr_seq_exame, pp.cd_material_exame, pp.cd_setor_coleta
        into STRICT nr_seq_exame_w, cd_material_exame_w, cd_setor_coleta_w
        from prescr_procedimento pp
  inner join lab_exame_equip lee on lee.nr_seq_exame = pp.nr_seq_exame
  inner join equipamento_lab el on el.cd_equipamento = lee.cd_equipamento and el.ds_sigla = 'RESPRESTUN'
       where pp.nr_prescricao = nr_prescricao_w
         and pp.nr_sequencia = nr_seq_prescr_w;

      select coalesce(max(cd_cgc_externo),null)
        into STRICT cd_cgc_externo_w
        from exame_laboratorio
       where nr_seq_exame = nr_seq_exame_w;

      if (coalesce(cd_cgc_externo_w::text, '') = '')  then
        select Max(nr_atendimento)
          into STRICT nr_atendimento_w
          from prescr_medica
         where nr_prescricao = nr_prescricao_w;

        select coalesce(max(c.cd_convenio),0)
          into STRICT cd_convenio_w
          from atend_categoria_convenio c
         where c.nr_atendimento = nr_atendimento_w
	         and c.nr_seq_interno = ( SELECT coalesce(MAX(nr_seq_interno),0)
		                                  FROM atend_categoria_convenio z
		                                 WHERE z.nr_atendimento = c.nr_atendimento
		                                   AND z.dt_inicio_vigencia	=	(SELECT	MAX(x.dt_inicio_vigencia)
			                                                               FROM atend_categoria_convenio x
			                                                              WHERE x.nr_atendimento = c.nr_atendimento));

        select coalesce(max(nr_sequencia),0)
          into STRICT nr_seq_material_w
          from material_exame_lab
         where cd_material_exame = cd_material_exame_w;

        select MAX(cd_cgc_externo)
       	  into STRICT cd_cgc_ext_cad_w
          from (SELECT cd_cgc_externo
                  from exame_laboratorio_externo
                 where nr_seq_exame = nr_seq_exame_w
                   and coalesce(cd_convenio, cd_convenio_w) = cd_convenio_w
		               and coalesce(nr_seq_material, nr_seq_material_w) = nr_seq_material_w
		            order by coalesce(cd_convenio,9999999999), coalesce(ie_prioridade,1)) alias5 LIMIT 1;

        cd_cgc_externo_w  :=  cd_cgc_ext_cad_w;
      end if;

      Ie_atual_desc_lote_w := Obter_Param_Usuario(718, 6, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, Ie_atual_desc_lote_w);
      ie_utilizar_setor_coleta_w := Obter_Param_Usuario(718, 22, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_utilizar_setor_coleta_w);

      if (ie_utilizar_setor_coleta_w = 'S' AND cd_setor_coleta_w IS NOT NULL AND cd_setor_coleta_w::text <> '') then
     		select	coalesce(max(nr_sequencia),0)
      		into STRICT	nr_seq_lote_externo_w
      		from	lab_lote_externo
      	 where	cd_cgc = cd_cgc_externo_w
       		 and		lab_obter_regra_estab_ext(cd_estabelecimento,cd_estabelecimento_w,0) = 'S'
       		 and		coalesce(cd_setor_atendimento,cd_setor_coleta_w) = cd_setor_coleta_w
           and		coalesce(dt_envio::text, '') = '';
      else
    		select	coalesce(max(nr_sequencia),0)
      		into STRICT	nr_seq_lote_externo_w
      		from	lab_lote_externo
      	 where	cd_cgc = cd_cgc_externo_w
       		 and		lab_obter_regra_estab_ext(cd_estabelecimento,cd_estabelecimento_w,0) = 'S'
        	 and		coalesce(dt_envio::text, '') = '';
      end if;

      if (nr_seq_lote_externo_w = 0) then
         if (cd_cgc_externo_w IS NOT NULL AND cd_cgc_externo_w::text <> '') then
           select nextval('lab_lote_externo_seq')
             into STRICT nr_seq_lote_externo_w
;

           if (ie_utilizar_setor_coleta_w <> 'S') then
             cd_setor_coleta_w := null;
           end if;

           insert into lab_lote_externo( nr_sequencia, cd_cgc, dt_lote, dt_retorno_prev, dt_atualizacao, nm_usuario,
                                          dt_envio, dt_retorno, cd_estabelecimento,ds_arquivo,cd_setor_atendimento)
                              	 values ( nr_seq_lote_externo_w, cd_cgc_externo_w, clock_timestamp(), clock_timestamp(), clock_timestamp(), nm_usuario_p,
                                     			null,null, cd_estabelecimento_w,CASE WHEN Ie_atual_desc_lote_w='S' THEN to_char(clock_timestamp(),'ddmmyyyy')  ELSE null END ,cd_setor_coleta_w);
         end if;
       end if;

      if (nr_seq_lote_externo_w <> 0) then
         update prescr_procedimento set NR_SEQ_LOTE_EXTERNO = nr_seq_lote_externo_w,
                                        nm_usuario = nm_usuario_p,
                                        dt_atualizacao = clock_timestamp()
          where nr_prescricao = nr_prescricao_w
            and nr_sequencia  = nr_seq_prescr_w;
      end if;
    end if;
	end loop;
	close c01;

  novo_nr_lote_ext_p := nr_seq_lote_externo_w;

  commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE grava_mensagens_retorno_vtrp (nr_sequencia_pdf_p bigint, cd_mensagem_ext_p text, nm_usuario_p text, cd_procedimento_p bigint, nr_seq_lote_externo_p bigint, novo_nr_lote_ext_p INOUT bigint) FROM PUBLIC;

