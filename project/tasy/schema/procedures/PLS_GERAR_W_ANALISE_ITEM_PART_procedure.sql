-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_w_analise_item_part ( nr_seq_analise_p bigint, nr_seq_conta_proc_p bigint, nr_seq_grupo_p bigint, ie_minha_analise_p text, ie_pendentes_p text, qt_informativo_p bigint, nm_usuario_p text, ie_somente_ocor_p text default 'N', nr_id_transacao_p w_pls_analise_item.nr_id_transacao%type DEFAULT NULL) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[ X ]  Objetos do dicionário [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 
ds_item_w			varchar(255);
nm_medico_w			varchar(255);
ds_via_acesso_w			varchar(255);
ds_tipo_guia_w			varchar(255);
nm_prestador_solic_w		varchar(255);
nm_prestador_exec_w		varchar(255);
nm_prestador_pag_w		varchar(255);
ds_fornecedor_w			varchar(255);
ds_setor_atend_w		varchar(255);
ds_item_importacao_w		varchar(255);
ds_espec_cbo_w			varchar(255);
ds_medico_executor_w		varchar(255);
ds_grau_partic_w		varchar(255);
ds_status_item_w		varchar(255);
nm_medico_executor_imp_w	varchar(255);
ie_glosa_w			varchar(255);
ie_autorizado_ww		varchar(255);
ds_procedimento_w		procedimento.ds_procedimento%TYPE;
ds_ident_nivel_1_w		varchar(60);
ds_ident_nivel_2_w		varchar(60);
ds_ident_nivel_3_w		varchar(60);
ds_identacao_w			varchar(30);
cd_guia_w			varchar(30);
cd_guia_conta_w			varchar(30);
ie_autorizado_w			varchar(20);
cd_medico_executor_w		varchar(20);
ie_tipo_guia_conta_w		varchar(20);
ie_tipo_linha_w			varchar(10);
ie_tipo_despesa_w		varchar(10);
ie_tipo_item_w			varchar(10);
cd_medico_w			varchar(10);
ie_via_acesso_w			varchar(10);
cd_porte_anestesico_w		varchar(10);
cd_pessoa_prest_w		varchar(10);
ie_status_analise_w		varchar(3)	:= 'S';/* Analisado pelo sistema */
ie_pagamento_w			varchar(3)	:= null;
ie_status_item_w		varchar(2);
ie_tipo_guia_w			varchar(2);
ie_expandido_w			varchar(1)	:= null;
ie_pend_grupo_w			varchar(1)	:= null;
ie_minha_analise_w		varchar(1)	:= 'N';
ie_pendentes_w			varchar(1)	:= 'N';
ie_nao_finalizar_w		varchar(1)	:= null;
ie_item_nao_encontrado_w	varchar(1);
ie_proc_ref_w			varchar(1);
ie_selecionado_w		varchar(1)	:= 'N';
ie_sem_fluxo_w			varchar(1)	:= null;
vl_taxa_servico_imp_w		double precision;
vl_taxa_co_imp_w		double precision;
vl_taxa_material_imp_w		double precision;
vl_taxa_servico_w		double precision;
vl_taxa_co_w			double precision;
vl_taxa_material_w		double precision;
vl_procedimento_imp_w		double precision;
vl_proc_unitario_w		double precision;
vl_procedimento_w		double precision;
vl_unitario_imp_w		double precision;
vl_glosa_w			double precision;
vl_liberado_w			double precision;
vl_glosa_material_w		double precision;
vl_glosa_hi_w			double precision;
vl_glosa_co_w			double precision;
vl_custo_operacional_w		double precision;
vl_liberado_material_w		double precision;
vl_liberado_co_w		double precision;
vl_liberado_hi_w		double precision;
vl_calculado_material_w		double precision;
vl_calculado_co_w		double precision;
vl_calculado_hi_w		double precision;
vl_taxa_intercambio_w		double precision;
vl_taxa_intercambio_imp_w	double precision;
vl_unitario_apres_w		double precision;
vl_base_w			double precision;
vl_material_ptu_imp_w		double precision;
vl_procedimento_ptu_imp_w	double precision;
vl_co_ptu_imp_w			double precision;
cd_procedimento_w		bigint;
qt_liberado_w			double precision;
qt_procedimento_imp_w		double precision;
qt_liberar_w			double precision;
nr_seq_conta_proc_w		bigint;
nr_seq_proc_partic_w		bigint;
nr_seq_prestador_pgto_w		bigint;
nr_seq_proc_pai_w		bigint;
ie_origem_proced_w		bigint;
nr_seq_guia_w			bigint;
nr_seq_prestador_exec_w		bigint;
nr_seq_protocolo_w		bigint;
nr_seq_prest_fornec_w		bigint;
nr_seq_setor_atend_w		bigint;
nr_auxiliares_w			bigint;
nr_seq_grau_partic_w		bigint;
nr_sequencia_w			bigint	:= 0;
qt_informativo_w		bigint;
nr_seq_proc_ref_w		bigint;
nr_seq_prestador_honor_w	bigint;
nr_seq_conta_w			bigint;
nr_seq_protocolo_conta_w	bigint;
nr_seq_prestador_solic_w	bigint;
nr_seq_cbo_saude_w		bigint;
qt_selecao_w			bigint;
nr_seq_autogerado_w		bigint;
nr_identificador_w		bigint;
tx_item_w			double precision;
tx_reducao_acrescimo_w		double precision;
tx_intercambio_w		double precision;
tx_intercambio_imp_w		double precision;
qt_fluxo_analise_w		integer;
ie_valor_base_w			smallint;
nr_nivel_w			smallint	:= 1;
dt_procedimento_w		timestamp;
dt_atend_ref_conta_w		timestamp;
nr_seq_agrup_analise_w		bigint;
qt_informativo_proc_w		bigint;
ie_pacote_w			varchar(1);
nr_seq_prestador_partic_w	pls_prestador.nr_sequencia%type;
nr_seq_cbo_saude_part_w		cbo_saude.nr_sequencia%type;
cd_cbo_saude_w				cbo_saude.cd_cbo%type;
ie_aviso_a520_proc_w		pls_conta_proc_regra.ie_a520%type;
nr_seq_prest_pgto_proc_w	pls_proc_participante.nr_seq_prestador_pgto%type;
nr_seq_prest_pgto_res_w		pls_proc_participante.nr_seq_prestador_pgto%type;

C03 CURSOR FOR
SELECT	a.nr_sequencia,
		b.nr_seq_conta,
		c.nr_seq_protocolo,
		a.nr_seq_conta_proc,
		'IC', /* Item da conta */
		'R', /* Participante */
		b.ie_tipo_despesa,
		b.qt_procedimento_imp,
		coalesce(a.vl_apresentado,0),
		0,
		a.vl_calculado,
		a.cd_medico,
		coalesce(b.nr_seq_prestador_pgto,c.nr_seq_prestador_exec),
		a.nr_seq_prestador,
		(	SELECT 	max(nr_seq_prestador_pgto)
			from	pls_conta_medica_resumo
			where 	nr_seq_conta = c.nr_sequencia
			and 	nr_seq_conta_proc = b.nr_sequencia
			and		nr_seq_conta_proc_partic = a.nr_sequencia) nr_seq_prest_pgto_resumo,
		a.nr_seq_conta_proc,
		b.cd_procedimento,
		b.ie_origem_proced,
		null,
		null cd_porte_anestesico,
		b.nr_seq_setor_atend,
		substr(b.cd_procedimento_imp || ' - ' || b.ds_procedimento_imp,1,255),
		0 vl_glosa_material,
		a.vl_glosa vl_glosa_hi,
		0 vl_glosa_co,
		0 vl_custo_operacional,
		0 vl_liberado_material,
		0 vl_liberado_co,
		a.vl_participante vl_liberado_hi,
		0 vl_materiais,
		0 vl_custo_operacional,
		0 vl_total_partic,
		0 tx_intercambio,
		0 tx_intercambio_imp,
		coalesce(a.qt_liberada,b.qt_procedimento) qt_procedimento,
		0 tx_item,
		a.vl_glosa,
		a.vl_participante,
		dividir(a.vl_calculado, coalesce(a.qt_liberada,b.qt_procedimento)),--b.vl_unitario_imp,
		b.ie_valor_base,
		a.nr_seq_grau_partic,
		0 vl_taxa_servico_imp,
		0 vl_taxa_co_imp,
		0 vl_taxa_material_imp,
		0 vl_taxa_servico,
		0 vl_taxa_co,
		0 vl_taxa_material,
		CASE WHEN ie_origem_conta='A' THEN coalesce(a.nm_medico_executor_imp, c.nm_prestador_exec_imp)  ELSE a.nm_medico_executor_imp END ,
		b.dt_procedimento,
		a.ie_glosa,
		a.ie_status_pagamento,
		b.nr_seq_autogerado,
		a.nr_id_analise,
		b.nr_seq_agrup_analise,
		vl_material_ptu_imp,
		vl_procedimento_ptu_imp,
		vl_co_ptu_imp,
		b.ie_pacote_ptu,
		a.nr_seq_prestador,
		a.nr_seq_cbo_saude,
		(	select	coalesce(max(x.ie_a520), 'N')
			from	pls_conta_proc_regra	x
			where	x.nr_sequencia		= b.nr_sequencia) ie_a520
	from	pls_conta		c,
		pls_conta_proc		b,
		pls_proc_participante	a
	where	c.nr_sequencia			= b.nr_seq_conta
	and	a.nr_seq_conta_proc		= b.nr_sequencia
	and	b.nr_sequencia			= nr_seq_conta_proc_p
	and	c.ie_status <> 'C'
	and (b.ie_lanc_manual_pos = 'N' or coalesce(b.ie_lanc_manual_pos::text, '') = '')
	and (ie_somente_ocor_p = 'N')
	and	((not exists (select	1
				from	pls_conta_proc	x
				where	x.nr_seq_participante_hi	= a.nr_sequencia)) or (exists (select	1
				from	pls_conta	y,
					pls_conta_proc	x
				where	x.nr_seq_participante_hi	= a.nr_sequencia
				and	y.nr_sequencia			= x.nr_seq_conta
				and	coalesce(y.nr_seq_analise::text, '') = '')))
	and	((nr_nivel_w > 2) or (exists (select	1
						from	w_pls_analise_item_exp	x
						where	x.nr_seq_conta_proc	= b.nr_sequencia)))
	
union all

	select	a.nr_sequencia,
		b.nr_seq_conta,
		c.nr_seq_protocolo,
		a.nr_seq_conta_proc,
		'IC', /* Item da conta */
		'R', /* Participante */
		b.ie_tipo_despesa,
		b.qt_procedimento_imp,
		coalesce(a.vl_apresentado,0),
		0,
		a.vl_calculado,
		a.cd_medico,
		coalesce(b.nr_seq_prestador_pgto,c.nr_seq_prestador_exec),
		a.nr_seq_prestador,
		(	select 	max(nr_seq_prestador_pgto)
			from	pls_conta_medica_resumo
			where 	nr_seq_conta = c.nr_sequencia
			and 	nr_seq_conta_proc = b.nr_sequencia
			and		nr_seq_conta_proc_partic = a.nr_sequencia) nr_seq_prest_pgto_resumo,
		a.nr_seq_conta_proc,
		b.cd_procedimento,
		b.ie_origem_proced,
		null,
		null cd_porte_anestesico,
		b.nr_seq_setor_atend,
		substr(b.cd_procedimento_imp || ' - ' || b.ds_procedimento_imp,1,255),
		0 vl_glosa_material,
		a.vl_glosa vl_glosa_hi,
		0 vl_glosa_co,
		0 vl_custo_operacional,
		0 vl_liberado_material,
		0 vl_liberado_co,
		a.vl_participante vl_liberado_hi,
		0 vl_materiais,
		0 vl_custo_operacional,
		0 vl_total_partic,
		0 tx_intercambio,
		0 tx_intercambio_imp,
		coalesce(a.qt_liberada,b.qt_procedimento) qt_procedimento,
		0 tx_item,
		a.vl_glosa,
		a.vl_participante,
		dividir(a.vl_calculado, coalesce(a.qt_liberada,b.qt_procedimento)),--b.vl_unitario_imp,
		b.ie_valor_base,
		a.nr_seq_grau_partic,
		0 vl_taxa_servico_imp,
		0 vl_taxa_co_imp,
		0 vl_taxa_material_imp,
		0 vl_taxa_servico,
		0 vl_taxa_co,
		0 vl_taxa_material,
		CASE WHEN ie_origem_conta='A' THEN coalesce(a.nm_medico_executor_imp, c.nm_prestador_exec_imp)  ELSE a.nm_medico_executor_imp END ,
		b.dt_procedimento,
		a.ie_glosa,
		a.ie_status_pagamento,
		b.nr_seq_autogerado,
		a.nr_id_analise,
		b.nr_seq_agrup_analise,
		vl_material_ptu_imp,
		vl_procedimento_ptu_imp,
		vl_co_ptu_imp,
		b.ie_pacote_ptu,
		a.nr_seq_prestador,
		a.nr_seq_cbo_saude,
		(	select	coalesce(max(x.ie_a520), 'N')
			from	pls_conta_proc_regra	x
			where	x.nr_sequencia		= b.nr_sequencia) ie_a520
	from	pls_conta		c,
		pls_conta_proc		b,
		pls_proc_participante	a
	where	c.nr_sequencia			= b.nr_seq_conta
	and	a.nr_seq_conta_proc		= b.nr_sequencia
	and	b.nr_sequencia			= nr_seq_conta_proc_p
	and	c.ie_status <> 'C'
	and (b.ie_lanc_manual_pos = 'N' or coalesce(b.ie_lanc_manual_pos::text, '') = '')
	and (ie_somente_ocor_p = 'S')
	and	exists (	select	1
				from	pls_conta_glosa
				where	ie_situacao	= 'A'
				and	nr_seq_proc_partic	= a.nr_sequencia
				
union all

				select	1
				from	pls_ocorrencia_benef
				where	ie_situacao	= 'A'
				and	nr_seq_proc_partic	= a.nr_sequencia)
	and	((not exists (select	1
				from	pls_conta_proc	x
				where	x.nr_seq_participante_hi	= a.nr_sequencia)) or (exists (select	1
				from	pls_conta	y,
					pls_conta_proc	x
				where	x.nr_seq_participante_hi	= a.nr_sequencia
				and	y.nr_sequencia			= x.nr_seq_conta
				and	coalesce(y.nr_seq_analise::text, '') = '')))
	and	((nr_nivel_w > 2) or (exists (select	1
						from	w_pls_analise_item_exp	x
						where	x.nr_seq_conta_proc	= b.nr_sequencia)));


BEGIN
ie_minha_analise_w	:= coalesce(ie_minha_analise_p,'N');
ie_pendentes_w		:= coalesce(ie_pendentes_p,'N');
ds_identacao_w		:= '       ';
ds_ident_nivel_1_w	:= ds_identacao_w;
ds_ident_nivel_2_w	:= ds_identacao_w || ds_identacao_w;
ds_ident_nivel_3_w	:= ds_identacao_w || ds_identacao_w || ds_identacao_w;
nr_nivel_w		:= pls_consulta_analise_pck.get_nr_nivel;
ie_tipo_guia_w		:= pls_consulta_analise_pck.get_ie_tipo_guia;

select	coalesce(b.nr_seq_guia,a.nr_seq_guia),
	a.nr_seq_protocolo,
	a.nr_seq_prestador,
	a.nr_seq_prestador_exec,
	a.dt_atendimento_referencia,
	a.nr_seq_cbo_saude,
	a.cd_medico_executor,
	a.cd_guia,
	a.ie_tipo_guia,
	b.ie_status,
	b.ie_via_acesso,
	b.nr_seq_conta
into STRICT	nr_seq_guia_w,
	nr_seq_protocolo_w,
	nr_seq_prestador_solic_w,
	nr_seq_prestador_exec_w,
	dt_atend_ref_conta_w,
	nr_seq_cbo_saude_w,
	cd_medico_executor_w,
	cd_guia_conta_w,
	ie_tipo_guia_conta_w,
	ie_status_item_w,
	ie_via_acesso_w,
	nr_seq_conta_w
from	pls_conta_proc	b,
	pls_conta 	a
where	b.nr_sequencia	= nr_seq_conta_proc_p
and	a.nr_sequencia	= b.nr_seq_conta;

nm_prestador_exec_w	:= substr(pls_obter_dados_prestador(nr_seq_prestador_exec_w,'N'),1,255);

if (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') then
	select	obter_valor_dominio(1746,a.ie_tipo_guia),
		cd_guia,
		CASE WHEN ie_status=1 THEN  'S'  ELSE 'N' END
	into STRICT	ds_tipo_guia_w,
		cd_guia_w,
		ie_autorizado_w
	from	pls_guia_plano a
	where	nr_sequencia = nr_seq_guia_w;
else
	cd_guia_w	:= cd_guia_conta_w;
	ds_tipo_guia_w	:= obter_valor_dominio(1746,ie_tipo_guia_conta_w);
end if;

open C03;
loop
fetch C03 into
	nr_seq_proc_partic_w,
	nr_seq_conta_w,
	nr_seq_protocolo_w,
	nr_seq_conta_proc_w,
	ie_tipo_linha_w,
	ie_tipo_item_w,
	ie_tipo_despesa_w,
	qt_procedimento_imp_w,
	vl_procedimento_imp_w,
	vl_proc_unitario_w,
	vl_procedimento_w,
	cd_medico_w,
	nr_seq_prestador_pgto_w,
	nr_seq_prest_pgto_proc_w,
	nr_seq_prest_pgto_res_w,	
	nr_seq_proc_pai_w,
	cd_procedimento_w,
	ie_origem_proced_w,
	nr_auxiliares_w,
	cd_porte_anestesico_w,
	nr_seq_setor_atend_w,
	ds_item_importacao_w,
	vl_glosa_material_w,
	vl_glosa_hi_w,
	vl_glosa_co_w,
	vl_custo_operacional_w,
	vl_liberado_material_w,
	vl_liberado_co_w,
	vl_liberado_hi_w,
	vl_calculado_material_w,
	vl_calculado_co_w,
	vl_calculado_hi_w,
	tx_intercambio_w,
	tx_intercambio_imp_w,
	qt_liberado_w,
	tx_item_w,
	vl_glosa_w,
	vl_liberado_w,
	vl_unitario_apres_w,
	ie_valor_base_w,
	nr_seq_grau_partic_w,
	vl_taxa_servico_imp_w,
	vl_taxa_co_imp_w,
	vl_taxa_material_imp_w,
	vl_taxa_servico_w,
	vl_taxa_co_w,
	vl_taxa_material_w,
	nm_medico_executor_imp_w,
	dt_procedimento_w,
	ie_glosa_w,
	ie_pagamento_w,
	nr_seq_autogerado_w,
	nr_identificador_w,
	nr_seq_agrup_analise_w,
	vl_material_ptu_imp_w,
	vl_procedimento_ptu_imp_w,
	vl_co_ptu_imp_w,
	ie_pacote_w,
	nr_seq_prestador_partic_w,
	nr_seq_cbo_saude_part_w,
	ie_aviso_a520_proc_w;
EXIT WHEN NOT FOUND; /* apply on C03 */
	begin
	ds_via_acesso_w		:= null;
	ds_grau_partic_w	:= null;
	cd_cbo_saude_w		:= null;
	
	ie_pend_grupo_w		:= ie_pend_grupo_w;
	ie_pend_grupo_w		:= pls_obter_pend_grupo_analise(nr_seq_analise_p,nr_seq_conta_w, null, nr_seq_proc_partic_w, null, nr_seq_grupo_p, 'N');
	
	if	((ie_minha_analise_w = 'S' AND ie_pend_grupo_w IS NOT NULL AND ie_pend_grupo_w::text <> '') or (ie_minha_analise_w = 'N')) and
		((ie_pendentes_w = ie_pend_grupo_w) or (ie_pendentes_w = 'N')) then
		if (coalesce(nr_seq_agrup_analise_w, nr_seq_conta_proc_p) <> nr_seq_conta_proc_p) then
			select	count(1)
			into STRICT	qt_informativo_w
			from	w_pls_analise_item a
			where	a.nr_seq_analise	= nr_seq_analise_p
			and	a.ie_informativo	= 'S'
			and	a.nr_seq_conta_proc	= nr_seq_agrup_analise_w;
		else
			qt_informativo_w	:= qt_informativo_p;
		end if;

			
		if (cd_medico_w IS NOT NULL AND cd_medico_w::text <> '') then
			ds_item_w	:= obter_nome_medico(cd_medico_w,'NCD');
		else
		
			
			if (nr_seq_prest_pgto_proc_w IS NOT NULL AND nr_seq_prest_pgto_proc_w::text <> '') then
				nr_seq_prestador_pgto_w := nr_seq_prest_pgto_proc_w;
			elsif (nr_seq_prest_pgto_res_w IS NOT NULL AND nr_seq_prest_pgto_res_w::text <> '') then
				nr_seq_prestador_pgto_w := nr_seq_prest_pgto_res_w;
			end if;

		
			if (nm_medico_executor_imp_w IS NOT NULL AND nm_medico_executor_imp_w::text <> '') then
				ds_item_w	:= nm_medico_executor_imp_w;
			elsif (nr_seq_prestador_pgto_w IS NOT NULL AND nr_seq_prestador_pgto_w::text <> '') then
				ds_item_w	:= pls_obter_dados_prestador(nr_seq_prestador_pgto_w,'N');
			else
				ds_item_w	:= 'Sem profissional informado';
			end if;
		end if;
		
		ds_item_w	:= 'Partic: ' || ds_item_w;
		
		if (qt_informativo_w = 0) then
			ds_item_w	:= ds_ident_nivel_2_w || ds_item_w;
		else
			ds_item_w	:= ds_ident_nivel_3_w || ds_item_w;
		end if;
		
		ie_autorizado_ww	:= null;
		
		if (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') then
			select	CASE WHEN count(1)=0 THEN  'N'  ELSE ie_autorizado_w END
			into STRICT	ie_autorizado_ww
			from	pls_guia_plano_proc	a
			where	a.nr_seq_guia		= nr_seq_guia_w
			and	a.cd_procedimento	= cd_procedimento_w
			and	a.ie_origem_proced	= ie_origem_proced_w;
		end if;
		
		if (nr_seq_prestador_pgto_w IS NOT NULL AND nr_seq_prestador_pgto_w::text <> '') then
			nm_prestador_pag_w	:= pls_obter_dados_prestador(nr_seq_prestador_pgto_w,'N');
		end if;
		
		vl_taxa_intercambio_imp_w	:= coalesce(vl_taxa_servico_imp_w,0) + coalesce(vl_taxa_co_imp_w,0) + coalesce(vl_taxa_material_imp_w,0);
		vl_taxa_intercambio_w		:= coalesce(vl_taxa_servico_w,0) + coalesce(vl_taxa_co_w,0) + coalesce(vl_taxa_material_w,0);

		if (nr_seq_grau_partic_w IS NOT NULL AND nr_seq_grau_partic_w::text <> '') then
			select	substr(ds_grau_participacao,1,255)
			into STRICT	ds_grau_partic_w
			from	pls_grau_participacao
			where	nr_sequencia	= nr_seq_grau_partic_w;
		end if;

		/* Obter status geral de análise do item */

		ie_status_analise_w	:= pls_obter_status_analise_item(nr_seq_analise_p,null, null, null, nr_seq_proc_partic_w, ie_item_nao_encontrado_w,'N');
		
		/* Obter se possui fluxo de análise */

		ie_sem_fluxo_w		:= pls_obter_se_item_sem_fluxo(nr_seq_analise_p,null, null, null,nr_seq_proc_partic_w);
		
		if (coalesce(ie_pagamento_w::text, '') = '') then
			ie_pagamento_w	:= pls_analise_obter_status_pag(ie_status_item_w,qt_procedimento_imp_w,qt_liberado_w,
							vl_procedimento_imp_w,vl_procedimento_w,vl_liberado_w,vl_glosa_w, ie_glosa_w);
		end if;

		nr_sequencia_w	:= pls_consulta_analise_pck.get_nr_seq_item;
		
		qt_liberar_w	:= null;
		
		if (pls_consulta_analise_pck.get_se_selecao) then
			select	count(1),
				max(qt_liberar)
			into STRICT	qt_selecao_w,
				qt_liberar_w
			from	w_pls_analise_selecao_item	a
			where	a.nr_seq_analise	= nr_seq_analise_p
			and	a.nr_seq_w_item		= nr_sequencia_w;
		end if;
		
		if (qt_selecao_w > 0) then
			ie_selecionado_w	:= 'S';
		else
			ie_selecionado_w	:= 'N';
		end if;
		
		if (nr_seq_prestador_partic_w IS NOT NULL AND nr_seq_prestador_partic_w::text <> '') and (nr_seq_cbo_saude_part_w IS NOT NULL AND nr_seq_cbo_saude_part_w::text <> '') then
			select	max(cd_cbo)
			into STRICT	cd_cbo_saude_w
			from	cbo_saude
			where	nr_sequencia = nr_seq_cbo_saude_part_w;
		end if;
		
		insert into w_pls_analise_item(nr_sequencia,
			nm_usuario,
			dt_atualizacao,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			nr_seq_analise,
			nr_seq_conta,
			nr_seq_conta_proc,
			nr_seq_proc_partic,
			ds_item,
			ie_tipo_despesa,
			ie_tipo_linha,
			ie_tipo_item,
			qt_apresentada,
			vl_apresentado,
			vl_calculado_unitario,
			vl_calculado,
			nr_seq_proc_pai,
			cd_procedimento,
			ie_origem_proced,
			ie_via_acesso,
			ds_via_acesso,
			nm_prestador_solic,
			nr_auxiliares,
			cd_porte_anestesico,
			ds_tipo_guia,
			nm_prestador_exec,
			nm_prestador_pag,
			ds_espec_cbo,
			nr_seq_protocolo,
			ie_autoriz_previa,
			cd_guia,
			ds_setor_atend,
			ds_item_importacao,
			ds_medico_executor,
			vl_glosa_material,
			vl_glosa_hi,
			vl_glosa_co,
			vl_custo_operacional,
			vl_liberado_material,
			vl_liberado_co,
			vl_liberado_hi,
			vl_calculado_material,
			vl_calculado_co,
			vl_calculado_hi,
			tx_intercambio,
			tx_intercambio_imp,
			vl_taxa_intercambio,
			vl_taxa_intercambio_imp,
			qt_liberado,
			tx_item,
			vl_glosa,
			vl_liberado,
			vl_unitario_apres,
			nr_seq_prestador_exec,
			nr_seq_guia,
			ie_status_analise,
			ie_pagamento,
			ie_valor_base,
			ds_grau_partic,
			ie_status_item,
			ds_status_item,
			ie_pend_grupo,
			ie_item_nao_encontrado,
			ie_selecionado,
			qt_liberar,
			ie_sem_fluxo,
			ie_tipo_guia,
			nr_seq_autogerado,
			nr_identificador,
			vl_material_ptu_imp,
			vl_procedimento_ptu_imp,
			vl_co_ptu_imp,
			ie_pacote_ptu,
			cd_cbo_saude,
			nr_id_transacao,
			ie_a520)
		values (nr_sequencia_w,
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nr_seq_analise_p,
			nr_seq_conta_w,
			nr_seq_conta_proc_w,
			nr_seq_proc_partic_w,
			ds_item_w,
			ie_tipo_despesa_w,
			ie_tipo_linha_w,
			ie_tipo_item_w,
			qt_procedimento_imp_w,
			vl_procedimento_imp_w,
			vl_proc_unitario_w,
			vl_procedimento_w,
			nr_seq_proc_pai_w,
			cd_procedimento_w,
			ie_origem_proced_w,
			ie_via_acesso_w,
			null,--ds_via_acesso_w,
			null,--nm_prestador_solic_w,
			nr_auxiliares_w,
			cd_porte_anestesico_w,
			null,--ds_tipo_guia_w,
			nm_prestador_exec_w,
			nm_prestador_pag_w,
			null,--ds_espec_cbo_w,
			nr_seq_protocolo_w,
			ie_autorizado_ww,
			cd_guia_w,
			null,--ds_setor_atend_w,
			ds_item_importacao_w,
			null,--ds_medico_executor_w,
			vl_glosa_material_w,
			vl_glosa_hi_w,
			vl_glosa_co_w,
			vl_custo_operacional_w,
			vl_liberado_material_w,
			vl_liberado_co_w,
			vl_liberado_hi_w,
			vl_calculado_material_w,
			vl_calculado_co_w,
			vl_calculado_hi_w,
			tx_intercambio_w,
			tx_intercambio_imp_w,
			vl_taxa_intercambio_w,
			vl_taxa_intercambio_imp_w,
			qt_liberado_w,
			null,--tx_item_w,
			vl_glosa_w,
			vl_liberado_w,
			vl_unitario_apres_w,
			nr_seq_prestador_exec_w,
			nr_seq_guia_w,
			ie_status_analise_w,
			ie_pagamento_w,
			ie_valor_base_w,
			ds_grau_partic_w,
			ie_status_item_w,
			null,--ds_status_item_w,
			ie_pend_grupo_w,
			ie_item_nao_encontrado_w,
			ie_selecionado_w,
			qt_liberar_w,
			ie_sem_fluxo_w,
			ie_tipo_guia_w,
			nr_seq_autogerado_w,
			nr_identificador_w,
			vl_material_ptu_imp_w,
			vl_procedimento_ptu_imp_w,
			vl_co_ptu_imp_w,
			ie_pacote_w,
			cd_cbo_saude_w,
			nr_id_transacao_p,
			ie_aviso_a520_proc_w);
			
		CALL pls_consulta_analise_pck.set_nr_seq_item(nr_sequencia_w + 1);
	end if;
	end;
end loop;
close C03;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_w_analise_item_part ( nr_seq_analise_p bigint, nr_seq_conta_proc_p bigint, nr_seq_grupo_p bigint, ie_minha_analise_p text, ie_pendentes_p text, qt_informativo_p bigint, nm_usuario_p text, ie_somente_ocor_p text default 'N', nr_id_transacao_p w_pls_analise_item.nr_id_transacao%type DEFAULT NULL) FROM PUBLIC;

