-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_arquivo_peona ( nr_seq_peona_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade: 
------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[ ] Objetos do dicionário [ X ] Tasy (Delphi/Java) [ ] Portal [ ] Relatórios [ ] Outros: 
 ------------------------------------------------------------------------------------------------------------------ 
Pontos de atenção: 
------------------------------------------------------------------------------------------------------------------- 
Referências: 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 
 
dt_inicial_w			timestamp;
dt_final_w			timestamp;
dt_referencia_w			timestamp;
dt_ocorrencia_sus_w		timestamp;
dt_ocorrencia_w			timestamp;
cd_unimed_w			varchar(255);
ie_rede_w			varchar(255);
vl_avisado_w			varchar(16);
vl_coparticipacao_w		varchar(16);
dt_aviso_w			varchar(16);
vl_liquido_w			varchar(16);
vl_clpp_w			varchar(16);
cd_unimed_sus_w			varchar(255);
ie_rede_sus_w			varchar(255);
ie_ressarc_sus_w		varchar(1);
dt_aviso_sus_w			varchar(255);
nr_contador_w			bigint;
vl_avisado_sus_w		varchar(16);
vl_coparticipacao_sus_w		varchar(16);
vl_liquido_sus_w		varchar(16);
cd_cooperativa_w		pls_congenere.cd_cooperativa%type;
cd_cgc_w			estabelecimento.cd_cgc%type;
ds_conteudo_w			w_arquivo_peona.ds_conteudo%type;
ds_conteudo_sus_w		w_arquivo_peona.ds_conteudo%type;

/*Variáveis de geração do arquivo*/
 
ds_erro_w			varchar(255);
ds_local_w			varchar(255);
arq_texto_w			utl_file.file_type;
nm_arquivo_w			varchar(255);

 
 
c_linha CURSOR FOR 
	SELECT	ds_conteudo || chr(13) || chr(10) ds_linha 
	from	w_arquivo_peona 
	where 	nr_seq_peona 	= nr_seq_peona_p 
	and 	nm_usuario 	= nm_usuario_p 
	order by nr_sequencia;

c_valores CURSOR FOR 
	SELECT	cd_unimed, 
		ie_rede, 
		dt_ocorrencia, 
		dt_aviso, 
		sum(coalesce(vl_avisado,0)) vl_avisado, 
		sum(coalesce(vl_coparticipacao,0)) vl_coparticipacao, 
		(sum(coalesce(vl_avisado,0)) - sum(coalesce(vl_coparticipacao,0))) vl_liquido 
	from	(SELECT	substr(pls_obter_dados_segurado(s.nr_sequencia, 'C'),2,3) cd_unimed, 
			CASE WHEN v.ie_tipo_protocolo='R' THEN 'P' WHEN v.ie_tipo_protocolo='I' THEN 'I'  ELSE 'P' END  ie_rede, 
			trunc(CASE WHEN v.ie_tipo_protocolo='R' THEN v.dt_referencia  ELSE coalesce(CASE WHEN v.ie_tipo_guia='5' THEN  v.dt_entrada  ELSE v.dt_atendimento_referencia END ,v.dt_referencia) END ,'month') dt_ocorrencia, 
			to_char(v.dt_referencia,'mmyyyy') dt_aviso, 
			coalesce(sum(v.vl_peona),0) vl_avisado, 
			(select	sum(x.vl_coparticipacao) 
			from	pls_conta_coparticipacao	x 
			where	x.nr_seq_conta			= v.nr_seq_conta 
			and	x.ie_status_coparticipacao	= 'S') vl_coparticipacao 
		from	pls_peona_v 	v, 
			pls_segurado	s 
		where	s.nr_sequencia	= v.nr_seq_segurado 
		and	trunc(v.dt_referencia,'month') between dt_inicial_w and dt_final_w 
		and	v.ie_tipo_valor		= 'D' 
		group by s.nr_sequencia, 
			s.ie_tipo_segurado, 
			v.ie_tipo_guia, 
			v.dt_referencia, 
			v.dt_entrada, 
			v.nr_seq_conta, 
			v.dt_atendimento_referencia, 
			v.ie_tipo_protocolo) alias19 
	group by 
		cd_unimed, 
		ie_rede, 
		dt_ocorrencia, 
		dt_aviso 
	having sum(coalesce(vl_avisado,0)) + sum(coalesce(vl_coparticipacao,0)) <> 0 
	order by dt_ocorrencia desc;

BEGIN 
 
ie_ressarc_sus_w	:= 'N';
vl_clpp_w		:= null;
 
delete	from w_arquivo_peona 
where	nr_seq_peona	= nr_seq_peona_p 
and	nm_usuario	= nm_usuario_p;
 
select	a.dt_competencia 
into STRICT	dt_referencia_w 
from	pls_peona	a 
where	a.nr_sequencia	= nr_seq_peona_p;
 
select	max(cd_cgc) 
into STRICT	cd_cgc_w 
from	estabelecimento 
where	cd_estabelecimento = cd_estabelecimento_p;
 
select	max(substr(cd_cooperativa,2,3)) 
into STRICT	cd_cooperativa_w 
from	pls_congenere 
where	cd_cgc = cd_cgc_w;
 
dt_inicial_w	:= trunc(dt_referencia_w,'month');
dt_final_w	:= fim_dia(fim_mes(dt_inicial_w));
 
select	count(*) 
into STRICT	nr_contador_w 
from	( 
	SELECT	cd_unimed, 
		ie_rede, 
		dt_ocorrencia, 
		dt_aviso, 
		sum(coalesce(vl_avisado,0)) vl_avisado, 
		sum(coalesce(vl_coparticipacao,0)) vl_coparticipacao, 
		(sum(coalesce(vl_avisado,0)) - sum(coalesce(vl_coparticipacao,0))) vl_liquido 
	from	(SELECT	substr(pls_obter_dados_segurado(s.nr_sequencia, 'C'),2,3) cd_unimed, 
			CASE WHEN v.ie_tipo_protocolo='R' THEN 'P' WHEN v.ie_tipo_protocolo='I' THEN 'I'  ELSE 'P' END  ie_rede, 
			trunc(CASE WHEN v.ie_tipo_protocolo='R' THEN v.dt_referencia  ELSE coalesce(CASE WHEN v.ie_tipo_guia='5' THEN  v.dt_entrada  ELSE v.dt_atendimento_referencia END ,v.dt_referencia) END ,'month') dt_ocorrencia, 
			trunc(v.dt_referencia,'month') dt_aviso, 
			coalesce(sum(v.vl_peona),0) vl_avisado, 
			(select	sum(x.vl_coparticipacao) 
			from	pls_conta_coparticipacao	x 
			where	x.nr_seq_conta			= v.nr_seq_conta 
			and	x.ie_status_coparticipacao	= 'S') vl_coparticipacao 
		from	pls_peona_v 	v, 
			pls_segurado	s 
		where	s.nr_sequencia	= v.nr_seq_segurado 
		and	trunc(v.dt_referencia,'month') between dt_inicial_w and dt_final_w 
		and	v.ie_tipo_valor		= 'D' 
		group by s.nr_sequencia, 
			s.ie_tipo_segurado, 
			v.ie_tipo_guia, 
			v.dt_referencia, 
			v.dt_entrada, 
			v.nr_seq_conta, 
			v.dt_atendimento_referencia, 
			v.ie_tipo_protocolo) alias20 
	group by 
		cd_unimed, 
		ie_rede, 
		dt_ocorrencia, 
		dt_aviso 
	having sum(coalesce(vl_avisado,0)) + sum(coalesce(vl_coparticipacao,0)) <> 0) alias25 
group by dt_aviso;
 
begin 
	select	'026' cd_unimed, 
		'S' ie_rede, 
		trunc(max(b.dt_ressarcimento_sus),'month') dt_ocorrencia, 
		to_char(max(a.dt_competencia),'mmyyyy') dt_aviso, 
		sum(coalesce(b.vl_ressarcimento_sus,0)) vl_avisado, 
		0 vl_coparticipacao, 
		sum(coalesce(b.vl_ressarcimento_sus,0)) vl_liquido 
	into STRICT	cd_unimed_sus_w, 
		ie_rede_sus_w, 
		dt_ocorrencia_sus_w, 
		dt_aviso_sus_w, 
		vl_avisado_sus_w, 
		vl_coparticipacao_sus_w, 
		vl_liquido_sus_w 
	from	pls_peona		a, 
		pls_valores_peona	b 
	where	a.nr_sequencia	= b.nr_seq_peona 
	and	coalesce(b.vl_ressarcimento_sus,0) <> 0 
	and	a.nr_sequencia	= nr_seq_peona_p;
exception 
when others then 
	cd_unimed_sus_w		:= null;
	ie_rede_sus_w		:= null;
	dt_ocorrencia_sus_w	:= null;
	dt_aviso_sus_w		:= null;
	vl_avisado_sus_w	:= null;
	vl_coparticipacao_sus_w	:= null;
	vl_liquido_sus_w	:= null;
end;
 
if (coalesce(vl_liquido_sus_w,0) <> 0)	then 
	vl_avisado_sus_w		:= substr(lpad(replace(replace(campo_mascara_virgula_casas(vl_avisado_sus_w,2),',',''),'.',''),16,'0'),1,16);
	vl_coparticipacao_sus_w		:= substr(lpad(replace(replace(campo_mascara_virgula_casas(vl_coparticipacao_sus_w,2),',',''),'.',''),16,'0'),1,16);
	vl_liquido_sus_w		:= substr(lpad(replace(replace(campo_mascara_virgula_casas(vl_liquido_sus_w,2),',',''),'.',''),16,'0'),1,16);
end if;
 
 
begin 
select	sum(coalesce(a.vl_peona,0)) 
into STRICT	vl_clpp_w 
from	pls_peona_v a 
where	a.dt_referencia between dt_inicial_w and dt_final_w 
and	a.ie_tipo_valor = 'R';
exception 
when others then 
	vl_clpp_w	:= null;
end;
 
open c_valores;
loop 
fetch c_valores into	 
	cd_unimed_w, 
	ie_rede_w, 
	dt_ocorrencia_w, 
	dt_aviso_w, 
	vl_avisado_w, 
	vl_coparticipacao_w, 
	vl_liquido_w;
EXIT WHEN NOT FOUND; /* apply on c_valores */
	begin 
	 
	nr_contador_w	:= nr_contador_w - 1;
	 
	if	((coalesce(vl_liquido_sus_w,0) <> 0) and (dt_ocorrencia_w <= dt_ocorrencia_sus_w) and coalesce(ie_ressarc_sus_w,'N') = 'N') then 
 
		ds_conteudo_w		:= 	cd_unimed_sus_w				|| ';' || 
						ie_rede_sus_w				|| ';' || 
						to_char(dt_ocorrencia_sus_w,'mmyyyy')	|| ';' || 
						dt_aviso_sus_w				|| ';' || 
						vl_avisado_sus_w			|| ';' || 
						vl_coparticipacao_sus_w			|| ';' || 
						vl_liquido_sus_w			|| ';';
		 
		insert into w_arquivo_peona(ds_conteudo, 
			dt_atualizacao, 
			dt_atualizacao_nrec, 
			nm_usuario, 
			nm_usuario_nrec, 
			nr_seq_peona, 
			nr_sequencia) 
		values (ds_conteudo_w, 
			clock_timestamp(), 
			clock_timestamp(), 
			nm_usuario_p, 
			nm_usuario_p, 
			nr_seq_peona_p, 
			nextval('w_arquivo_peona_seq'));
			 
		vl_liquido_sus_w	:= 0;
		ie_ressarc_sus_w	:= 'S';	
	end if;
	 
	vl_avisado_w		:= substr(lpad(replace(replace(campo_mascara_virgula_casas(vl_avisado_w,2),',',''),'.',''),16,'0'),1,16);
	vl_coparticipacao_w	:= substr(lpad(replace(replace(campo_mascara_virgula_casas(vl_coparticipacao_w,2),',',''),'.',''),16,'0'),1,16);
	vl_liquido_w		:= substr(lpad(replace(replace(campo_mascara_virgula_casas(vl_liquido_w,2),',',''),'.',''),16,'0'),1,16);
	 
	ds_conteudo_w		:= 	cd_unimed_w				|| ';' || 
					ie_rede_w				|| ';' || 
					to_char(dt_ocorrencia_w,'mmyyyy')	|| ';' || 
					dt_aviso_w				|| ';' || 
					vl_avisado_w				|| ';' || 
					vl_coparticipacao_w			|| ';' || 
					vl_liquido_w				|| ';';
					 
	if	((nr_contador_w = 0) and (coalesce(vl_clpp_w,0) <> 0) and ((coalesce(vl_liquido_sus_w,0) = 0) or (coalesce(ie_ressarc_sus_w,'N') = 'S'))) then 
		vl_clpp_w	:= substr(lpad(replace(replace(campo_mascara_virgula_casas(vl_clpp_w,2),',',''),'.',''),16,'0'),1,16);
		 
		ds_conteudo_w	:= 	ds_conteudo_w	|| 
					vl_clpp_w 	|| ';';
	end if;
	 
	insert into w_arquivo_peona(ds_conteudo, 
		dt_atualizacao, 
		dt_atualizacao_nrec, 
		nm_usuario, 
		nm_usuario_nrec, 
		nr_seq_peona, 
		nr_sequencia) 
	values (ds_conteudo_w, 
		clock_timestamp(), 
		clock_timestamp(), 
		nm_usuario_p, 
		nm_usuario_p, 
		nr_seq_peona_p, 
		nextval('w_arquivo_peona_seq'));					
	end;
end loop;
close c_valores;
 
if	((coalesce(vl_liquido_sus_w,0) <> 0) and (coalesce(ie_ressarc_sus_w,'N') = 'N')) then 
		ds_conteudo_w		:= 	cd_unimed_sus_w				|| ';' || 
						ie_rede_sus_w				|| ';' || 
						to_char(dt_ocorrencia_sus_w,'mmyyyy')	|| ';' || 
						dt_aviso_sus_w				|| ';' || 
						vl_avisado_sus_w			|| ';' || 
						vl_coparticipacao_sus_w			|| ';' || 
						vl_liquido_sus_w			|| ';';
		 
		if (coalesce(vl_clpp_w,0) <> 0) then 
			vl_clpp_w	:= substr(lpad(replace(replace(campo_mascara_virgula_casas(vl_clpp_w,2),',',''),'.',''),16,'0'),1,16);
		 
			ds_conteudo_w	:= 	ds_conteudo_w	|| 
						vl_clpp_w 	|| ';';
		end if;
		 
		insert into w_arquivo_peona(ds_conteudo, 
			dt_atualizacao, 
			dt_atualizacao_nrec, 
			nm_usuario, 
			nm_usuario_nrec, 
			nr_seq_peona, 
			nr_sequencia) 
		values (ds_conteudo_w, 
			clock_timestamp(), 
			clock_timestamp(), 
			nm_usuario_p, 
			nm_usuario_p, 
			nr_seq_peona_p, 
			nextval('w_arquivo_peona_seq'));
end if;
	 
commit;
 
nm_arquivo_w	:= 'PEONA' || to_char(clock_timestamp(),'ddmmyyyyhh24miss') || '.txt';
 
SELECT * FROM obter_evento_utl_file(1, null, ds_local_w, ds_erro_w) INTO STRICT ds_local_w, ds_erro_w;
 
arq_texto_w := utl_file.fopen(ds_local_w,nm_arquivo_w,'W');
 
for vetl in c_linha loop 
	begin 
	utl_file.put_line(arq_texto_w,vetl.ds_linha);
	utl_file.fflush(arq_texto_w);
	end;
end loop;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_arquivo_peona ( nr_seq_peona_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

