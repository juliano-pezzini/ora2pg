-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ajustar_protocolo_mat_proc ( cd_protocolo_p bigint, nr_sequencia_p bigint, nr_seq_proc_p bigint) AS $body$
DECLARE



nr_seq_material_w	integer;
cd_intervalo_w		varchar(7);
ie_acm_w		varchar(1);
ie_se_necessario_w	varchar(1);


C01 CURSOR FOR
SELECT	coalesce(nr_seq_material,0)
from	protocolo_medic_material
where	cd_protocolo	= cd_protocolo_p
and	nr_sequencia	= nr_sequencia_p
and	nr_seq_proc	= nr_seq_proc_p
and	(cd_material IS NOT NULL AND cd_material::text <> '');


BEGIN

Select	max(cd_intervalo),
	coalesce(max(ie_se_necessario),'N'),
	coalesce(max(ie_acm),'N')
into STRICT	cd_intervalo_w,
	ie_se_necessario_w,
	ie_acm_w
from	protocolo_medic_proc
where	cd_protocolo	= cd_protocolo_p
and	nr_sequencia	= nr_sequencia_p
and	nr_seq_proc	= nr_seq_proc_p;



open C01;
loop
	fetch C01 into
		nr_seq_material_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */

	Update	protocolo_medic_material
	set	cd_intervalo	= cd_intervalo_w,
		ie_acm		= ie_acm_w,
		ie_se_necessario = ie_se_necessario_w
	where	cd_protocolo	= cd_protocolo_p
	and	nr_sequencia	= nr_sequencia_p
	and	nr_seq_material	= nr_seq_material_w
	and	nr_seq_proc	= nr_seq_proc_p;

end loop;
close C01;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ajustar_protocolo_mat_proc ( cd_protocolo_p bigint, nr_sequencia_p bigint, nr_seq_proc_p bigint) FROM PUBLIC;

