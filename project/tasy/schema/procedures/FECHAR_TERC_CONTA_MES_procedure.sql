-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fechar_terc_conta_mes (dt_mes_ref_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_conta_p bigint) AS $body$
DECLARE


cd_empresa_w            	empresa.cd_empresa%type;
ie_ctb_online_w			ctb_param_lote_nf.ie_ctb_online%type := 'N';
nr_sequencia_w			bigint;
ie_titulo_terceiro_w		varchar(10);
ds_terceiros_liberados_w	varchar(4000) 	:= null;
ds_lista_terceiros_liberados_w	varchar(4000)	:= null;
ie_somente_terc_lib_w		varchar(255);

c01 CURSOR FOR
SELECT	nr_sequencia
from	terceiro_conta
where	trunc(dt_mesano_referencia, 'month')	= trunc(dt_mes_ref_p, 'month')
and	cd_estabelecimento			= cd_estabelecimento_p
and	nr_sequencia				= coalesce(nr_seq_conta_p, nr_sequencia)
and	ie_status_conta				= 'P'
and 	((ds_lista_terceiros_liberados_w like '% ' || nr_seq_terceiro || ' %') or coalesce(ds_terceiros_liberados_w::text, '') = '');


BEGIN

select	ie_titulo_terceiro
into STRICT	ie_titulo_terceiro_w
from	parametro_contas_receber
where	cd_estabelecimento	= cd_estabelecimento_p;

ie_somente_terc_lib_w := obter_param_usuario(907, 53, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_somente_terc_lib_w);
if (coalesce(ie_somente_terc_lib_w,'N') = 'S') then
	ds_terceiros_liberados_w := obter_param_usuario(907, 43, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ds_terceiros_liberados_w);
	ds_lista_terceiros_liberados_w	:= ' ' || replace(ds_terceiros_liberados_w,',',' ') || ' ';
end if;

open c01;
loop
fetch c01 into
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	update	terceiro_conta
	set	ie_status_conta	= 'D',
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_sequencia_w;

	if (ie_titulo_terceiro_w = 'S') then
		CALL GERAR_TIT_REC_TERC_CONTA(nr_sequencia_w, nm_usuario_p);
	end if;

	cd_empresa_w	:= obter_empresa_estab(cd_estabelecimento_p);
	begin
	ie_ctb_online_w := ctb_online_pck.get_modo_lote(  9, cd_estabelecimento_p, cd_empresa_w);
	exception when others then
		ie_ctb_online_w	:= 'N';
	end;
	if (ie_ctb_online_w = 'S') then
		begin
		/* Rotina de Contabilização de Controle de Terceiros */

		CALL ctb_contab_onl_controle_terc( nr_sequencia_w,
							'D',
							nm_usuario_p);
		end;
	end if;

end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fechar_terc_conta_mes (dt_mes_ref_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_conta_p bigint) FROM PUBLIC;

