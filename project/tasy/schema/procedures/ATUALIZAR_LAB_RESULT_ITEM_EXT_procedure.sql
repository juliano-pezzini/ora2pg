-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_lab_result_item_ext (NR_ATENDIMENTO_P bigint, CD_EXAME_P text, DT_RESULTADO_P timestamp, DT_COLETA_P timestamp, DS_RESULTADO_P text, QT_RESULTADO_P bigint, PR_RESULTADO_P bigint, DS_REFERENCIA_P text, DS_UNIDADE_MEDIDA_P text, DS_OBSERVACAO_P text, NM_USUARIO_P text, QT_MINIMA_P bigint DEFAULT NULL, QT_MAXIMA_P bigint DEFAULT NULL, PR_MINIMO_P bigint DEFAULT NULL, PR_MAXIMO_P bigint DEFAULT NULL, DS_FLAG_P text DEFAULT NULL, CD_COMMENT_EXT_P text DEFAULT NULL) AS $body$
DECLARE

  NR_SEQ_RESULTADO_W EXAME_LAB_RESULTADO.NR_SEQ_RESULTADO%TYPE;
  NR_SEQ_EXAME_W     EXAME_LABORATORIO.NR_SEQ_EXAME%TYPE;
  NR_SEQUENCIA_W     EXAME_LAB_RESULT_ITEM.NR_SEQUENCIA%TYPE;

  C01 CURSOR FOR
    SELECT EL.NR_SEQ_EXAME, EL.NR_SEQ_SUPERIOR
      FROM EXAME_LABORATORIO EL
     WHERE coalesce(EL.CD_EXAME_INTEGRACAO, EL.CD_EXAME) = CD_EXAME_P
       AND IE_SITUACAO = 'A'

UNION

    SELECT E.NR_SEQ_EXAME, E.NR_SEQ_SUPERIOR
      FROM EXAME_LABORATORIO E
     WHERE E.NR_SEQ_EXAME = (OBTER_EQUIP_EXAME_INTEGRACAO(CD_EXAME_P, 'FLEURY', 1))::numeric 
       AND IE_SITUACAO = 'A'
    
UNION

    SELECT E.NR_SEQ_EXAME, E.NR_SEQ_SUPERIOR
      FROM EXAME_LABORATORIO E
     WHERE E.NR_SEQ_EXAME = (OBTER_EQUIP_EXAME_INTEGRACAO(CD_EXAME_P, 'LABEXT', 1))::numeric 
       AND IE_SITUACAO = 'A'
     ORDER BY 1;
BEGIN
for r_c01 in c01 loop
	begin
	nr_seq_exame_w	:= r_c01.nr_seq_exame;
	exit;
	end;
end loop;

if (nr_seq_exame_w IS NOT NULL AND nr_seq_exame_w::text <> '') and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_atendimento_p	> 0 ) then
	
	
	select	max(nr_seq_resultado)
	into STRICT	nr_seq_resultado_w
	from 	exame_lab_resultado
	where	nr_atendimento	= nr_atendimento_p
	and	dt_resultado	= dt_resultado_p;

	if (coalesce(nr_seq_resultado_w::text, '') = '') then

		select	coalesce(max(nr_seq_resultado),0) + 1
		into STRICT	nr_seq_resultado_w
		from 	exame_lab_resultado;	

		insert into exame_lab_resultado(	nr_seq_resultado,
							dt_resultado,
							dt_atualizacao,
							nm_usuario,
							nr_prescricao, 
							nr_atendimento,
							dt_liberacao,
							cd_pessoa_fisica)
					values (		nr_seq_resultado_w, 
							dt_resultado_p, 
							clock_timestamp(), 
							nm_usuario_p, 
							null, 
							nr_atendimento_p,
							clock_timestamp(),
							obter_pessoa_atendimento(nr_atendimento_p,'C'));
	end if;

	
	
	select	coalesce(max(nr_sequencia),0) + 1
	into STRICT	nr_sequencia_w
	from 	exame_lab_result_item
	where 	nr_seq_resultado = nr_seq_resultado_w;
		
	insert into	exame_lab_result_item(	nr_seq_resultado,
						nr_sequencia, 
						nr_seq_exame, 
						dt_atualizacao, 
						nm_usuario,
						qt_resultado, 
						ds_resultado, 
						nr_seq_metodo, 
						nr_seq_material, 
						pr_resultado,
						ie_status, 
						dt_aprovacao, 
						nm_usuario_aprovacao, 
						nr_seq_prescr, 
						dt_coleta,
						ds_observacao, 
						ds_referencia, 
						ds_unidade_medida, 
						qt_minima, 
						qt_maxima, 
						pr_minimo, 
						pr_maximo, 
						ds_flag,
						cd_comentario_ext)
				values (	nr_seq_resultado_w, 
						nr_sequencia_w, 
						nr_seq_exame_w, 
						clock_timestamp(), 
						coalesce(nm_usuario_p,obter_desc_expressao(292158)),
						qt_resultado_p, 
						ds_resultado_p, 
						null, 
						null, 
						pr_resultado_p,
						null, 
						clock_timestamp(), 
						nm_usuario_p, 
						null, 
						dt_coleta_p,
						ds_observacao_p, 
						ds_referencia_p, 
						ds_unidade_medida_p, 
						qt_minima_p, 
						qt_maxima_p, 
						pr_minimo_p, 
						pr_maximo_p, 
						DS_FLAG_P,
						cd_comment_ext_p);
	
end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_lab_result_item_ext (NR_ATENDIMENTO_P bigint, CD_EXAME_P text, DT_RESULTADO_P timestamp, DT_COLETA_P timestamp, DS_RESULTADO_P text, QT_RESULTADO_P bigint, PR_RESULTADO_P bigint, DS_REFERENCIA_P text, DS_UNIDADE_MEDIDA_P text, DS_OBSERVACAO_P text, NM_USUARIO_P text, QT_MINIMA_P bigint DEFAULT NULL, QT_MAXIMA_P bigint DEFAULT NULL, PR_MINIMO_P bigint DEFAULT NULL, PR_MAXIMO_P bigint DEFAULT NULL, DS_FLAG_P text DEFAULT NULL, CD_COMMENT_EXT_P text DEFAULT NULL) FROM PUBLIC;

