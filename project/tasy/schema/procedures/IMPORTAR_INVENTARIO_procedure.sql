-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE importar_inventario ( nr_sequencia_p bigint, cd_material_p bigint, qt_inventario_p bigint, ds_barras_p text, nm_usuario_p text) AS $body$
DECLARE

cd_material_w		integer;
cd_material_ww		integer;
cd_estabelecimento_w	smallint;

qt_material_w		double precision;
nr_seq_lote_w		bigint;
nr_seq_lote_agrup_w	bigint;
cd_kit_mat_w		bigint;
ds_validade_w		varchar(255);
ds_material_w		varchar(255);
cd_unid_med_w		varchar(30);
nr_etiqueta_lp_w		varchar(255);
ds_erro_w		varchar(255);
ie_estoque_lote_w		varchar(1);
qt_inventario_w		double precision;


BEGIN 
cd_material_ww	:= cd_material_p;
qt_inventario_w	:= qt_inventario_p;
 
select	cd_estabelecimento 
into STRICT	cd_estabelecimento_w 
from	inventario 
where	nr_sequencia = nr_sequencia_p;
 
select	coalesce(max(cd_material_estoque),0) 
into STRICT	cd_material_w 
from	material 
where	cd_material = cd_material_ww;
 
select	coalesce(max(ie_estoque_lote),'N') 
into STRICT	ie_estoque_lote_w 
from	material_estab 
where	cd_material = cd_material_w 
and	cd_estabelecimento = cd_estabelecimento_w;
 
if (ds_barras_p IS NOT NULL AND ds_barras_p::text <> '') and (ie_estoque_lote_w = 'S') then 
	begin	 
	SELECT * FROM Converte_Codigo_Barras( 
			ds_barras_p, cd_estabelecimento_w, null, 'N', cd_material_w, qt_material_w, nr_seq_lote_w, nr_seq_lote_agrup_w, cd_kit_mat_w, ds_validade_w, ds_material_w, cd_unid_med_w, nr_etiqueta_lp_w, ds_erro_w) INTO STRICT cd_material_w, qt_material_w, nr_seq_lote_w, nr_seq_lote_agrup_w, cd_kit_mat_w, ds_validade_w, ds_material_w, cd_unid_med_w, nr_etiqueta_lp_w, ds_erro_w;					
	end;
end if;
 
if (cd_material_w > 0) then 
	begin	 
	ds_erro_w := Inventario_barras(nr_sequencia_p, cd_material_w, qt_inventario_w, nr_seq_lote_w, '1', nm_usuario_p, ds_erro_w);
	ds_erro_w := Inventario_barras(nr_sequencia_p, cd_material_w, qt_inventario_w, nr_seq_lote_w, '2', nm_usuario_p, ds_erro_w);
	end;
end if;
	 
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE importar_inventario ( nr_sequencia_p bigint, cd_material_p bigint, qt_inventario_p bigint, ds_barras_p text, nm_usuario_p text) FROM PUBLIC;

