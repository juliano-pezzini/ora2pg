-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_inf_grafico_anestesico ( cd_pessoa_fisica_p text, nr_atendimento_p bigint, nr_cirurgia_p bigint, nr_seq_pepo_p bigint) AS $body$
DECLARE

				
retorno_w			   integer;
C02				      integer;
ds_alerta_w			   varchar(4000);
ds_sql_w			      varchar(4000);
cd_perfil_w			   integer;
ie_sensitive_w	      varchar(1);
nr_seq_apresentacao_w   bigint := 1;
nm_titulo_w				varchar(255);
								
c01 CURSOR FOR
	SELECT   ds_sql, nm_titulo
	from	   regra_inf_grafico_cirurgia
	where	   coalesce(ie_situacao,'A') 		= 'A'
	order by coalesce(NR_SEQ_APRESENTACAO,0);
				

BEGIN

delete	from informacao_grafico_cir
where    (((coalesce(nr_cirurgia_p,0) > 0) and (nr_cirurgia = nr_cirurgia_p)) or
          ((coalesce(nr_seq_pepo_p,0) > 0) and (nr_seq_pepo = nr_seq_pepo_p)));
commit;

open C01;
loop
fetch C01 into	
	ds_sql_w,
	nm_titulo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	C02 := DBMS_SQL.OPEN_CURSOR;
	DBMS_SQL.PARSE(C02, ds_sql_w, dbms_sql.Native);
	DBMS_SQL.DEFINE_COLUMN(C02,1,ds_alerta_w,4000);
	
	if (position(':NR_ATENDIMENTO' in upper(ds_sql_w)) > 0) then
		DBMS_SQL.BIND_VARIABLE(C02,'NR_ATENDIMENTO', nr_atendimento_p);
	end if;	
	if (position(':CD_PESSOA_FISICA' in upper(ds_sql_w)) > 0) then
		DBMS_SQL.BIND_VARIABLE(C02,'CD_PESSOA_FISICA', cd_pessoa_fisica_p);
	end if;	
   if (position(':NR_CIRURGIA' in upper(ds_sql_w)) > 0) then
		DBMS_SQL.BIND_VARIABLE(C02,'NR_CIRURGIA', nr_cirurgia_p);
	end if;	
	if (position(':NR_SEQ_PEPO' in upper(ds_sql_w)) > 0) then
		DBMS_SQL.BIND_VARIABLE(C02,'NR_SEQ_PEPO', nr_seq_pepo_p);
	end if;	
	retorno_w := DBMS_SQL.execute(C02);
	while( DBMS_SQL.FETCH_ROWS(C02) > 0 ) loop
		begin
		DBMS_SQL.COLUMN_VALUE(C02,1,ds_alerta_w);
		insert	into	informacao_grafico_cir(	
               ds_texto,
					nr_seq_apresentacao,
               nr_seq_pepo,
               nr_cirurgia,
			   nm_titulo)
		values (	ds_alerta_w,
					nr_seq_apresentacao_w,
               nr_seq_pepo_p,
               nr_cirurgia_p,
			   nm_titulo_w);
      nr_seq_apresentacao_w := nr_seq_apresentacao_w + 1;
		commit;
		end;
	end loop;
	DBMS_SQL.CLOSE_CURSOR(C02);
	end;		
end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_inf_grafico_anestesico ( cd_pessoa_fisica_p text, nr_atendimento_p bigint, nr_cirurgia_p bigint, nr_seq_pepo_p bigint) FROM PUBLIC;

