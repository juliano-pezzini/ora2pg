-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_auditoria_externa (nr_seq_auditoria_p bigint, nr_interno_conta_p bigint, dt_periodo_inicial_p timestamp, dt_periodo_final_p timestamp, ie_tipo_data_p bigint, cd_setor_atendimento_p bigint, nr_prescricao_p text, ie_nao_auditados_p text, ie_proc_mat_p text, cd_area_proc_p bigint, cd_especialidade_p bigint, cd_grupo_proc_p bigint, cd_grupo_mat_p bigint, cd_subgrupo_p bigint, cd_classe_p bigint, nm_usuario_p text, nr_seq_regra_audit_p bigint, nr_seq_regra_audit_ext_p bigint, ie_opcao_geracao_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
qt_item_w		double precision;
cd_material_w		integer;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
nr_seq_item_w		bigint;
ie_status_acerto_w	varchar(01);
ds_filtros_auditoria_w	varchar(2000);
ie_pacote_w		varchar(1);
cd_setor_atendimento_w	integer;
cd_area_procedimento_w	bigint;
cd_especialidade_w	bigint;
cd_grupo_proc_w		bigint;
cd_grupo_material_w	smallint;
cd_subgrupo_material_w	smallint;
cd_classe_material_w	integer;
ie_tipo_item_w		varchar(1);
ie_tipo_data_w		varchar(1);
dt_item_w		timestamp;
cd_setor_atend_w	integer;
ie_agrupar_w		varchar(1);
ie_proc_mat_w		varchar(1);
vl_unitario_w		double precision;

vl_orig_w		double precision;
vl_medico_orig_w	double precision;
vl_custo_oper_orig_w	double precision;
vl_mat_orig_w		double precision;
vl_proc_orig_w		double precision;

vl_original_w		double precision;
ie_resumo_auditoria_w	varchar(1);

-- Itens que serão gerados na auditoria
c01 CURSOR FOR
	SELECT	/*+INDEX(A MATPACI_CONPACI_I) */		a.nr_sequencia
	from	estrutura_material_v b,
		material_atend_paciente a
	where	a.cd_material		= b.cd_material
	and	((coalesce(cd_grupo_mat_p, 0)= 0) or (b.cd_grupo_material = cd_grupo_mat_p))
	and	((coalesce(cd_subgrupo_p, 0)	= 0) or (b.cd_subgrupo_material = cd_subgrupo_p))
	and	((coalesce(cd_classe_p, 0)	= 0) or (b.cd_classe_material = cd_classe_p))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_atendimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 0) or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 1))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(a.nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and (ie_proc_mat_p in ('A','M'))
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	coalesce(nr_seq_regra_audit_p::text, '') = ''
	and 	(((a.cd_material = cd_material_w) and (ie_opcao_geracao_p in ('AI','AR'))) or
		 ((a.cd_material = cd_material_w) and ( ((trunc(dt_atendimento,'dd') = dt_item_w) and (ie_tipo_data_p = 0)) or
							((trunc(dt_conta,'dd') = dt_item_w) and (ie_tipo_data_p = 1)) ) and (ie_opcao_geracao_p = 'AD')) or
		 ((a.cd_material = cd_material_w) and (a.cd_setor_atendimento = cd_setor_atend_w) and (ie_opcao_geracao_p in ('AS','ASM'))) or
		 ((a.cd_material = cd_material_w) and (a.cd_setor_atendimento = cd_setor_atend_w) and (a.vl_unitario = vl_unitario_w) and (ie_opcao_geracao_p = 'ASV')) or
		 ((a.cd_material = cd_material_w) and (a.cd_setor_atendimento = cd_setor_atend_w) and (ie_opcao_geracao_p = 'ASD') and
				(((trunc(dt_atendimento,'dd') = dt_item_w) and (ie_tipo_data_p = 0)) or ((trunc(dt_conta,'dd') = dt_item_w) and (ie_tipo_data_p = 1)))))
	
union	all

	PERFORM	/*+INDEX(A MATPACI_CONPACI_I) */		a.nr_sequencia
	from	estrutura_material_v b,
		material_atend_paciente a
	where	a.cd_material		= b.cd_material
	and	((coalesce(cd_grupo_material_w, 0)= 0) or (b.cd_grupo_material = cd_grupo_material_w))
	and	((coalesce(cd_subgrupo_material_w, 0)= 0) or (b.cd_subgrupo_material = cd_subgrupo_material_w))
	and	((coalesce(cd_classe_material_w, 0)	= 0) or (b.cd_classe_material = cd_classe_material_w))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_w, cd_setor_atendimento)
	and	((a.dt_atendimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'A') or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'C'))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(a.nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and (ie_tipo_item_w in ('A','M'))
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	(nr_seq_regra_audit_p IS NOT NULL AND nr_seq_regra_audit_p::text <> '')
	and 	(((a.cd_material = cd_material_w) and (ie_opcao_geracao_p in ('AI','AR'))) or
		 ((a.cd_material = cd_material_w) and ( ((trunc(dt_atendimento,'dd') = dt_item_w) and (ie_tipo_data_p = 0)) or
							((trunc(dt_conta,'dd') = dt_item_w) and (ie_tipo_data_p = 1)) ) and (ie_opcao_geracao_p = 'AD')) or
		 ((a.cd_material = cd_material_w) and (a.cd_setor_atendimento = cd_setor_atend_w) and (ie_opcao_geracao_p in ('AS','ASM','ASV'))) or
		 ((a.cd_material = cd_material_w) and (a.cd_setor_atendimento = cd_setor_atend_w) and (ie_opcao_geracao_p = 'ASD') and
				(((trunc(dt_atendimento,'dd') = dt_item_w) and (ie_tipo_data_p = 0)) or ((trunc(dt_conta,'dd') = dt_item_w) and (ie_tipo_data_p = 1)))));


c02 CURSOR FOR
	SELECT	a.nr_sequencia
	from	estrutura_procedimento_v b,
		procedimento_paciente a
	where	a.cd_procedimento	= b.cd_procedimento
	and	a.ie_origem_proced	= b.ie_origem_proced
	and	((coalesce(cd_area_proc_p, 0)= 0) or (b.cd_area_procedimento = cd_area_proc_p))
	and	((coalesce(cd_especialidade_p, 0) = 0) or (b.cd_especialidade = cd_especialidade_p))
	and	((coalesce(cd_grupo_proc_p, 0) = 0) or (b.CD_GRUPO_PROC = cd_grupo_proc_p))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_procedimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 0) or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 1))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_proc_mat_p in ('A','P'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	coalesce(nr_seq_regra_audit_p::text, '') = ''
	and 	(((a.cd_procedimento = cd_procedimento_w) and (a.ie_origem_proced = ie_origem_proced_w) and (ie_opcao_geracao_p in ('AI','AR'))) or
		 ((a.cd_procedimento = cd_procedimento_w) and (a.ie_origem_proced = ie_origem_proced_w) and (	((trunc(dt_procedimento,'dd') = dt_item_w) and (ie_tipo_data_p = 0)) or
														((trunc(dt_conta,'dd') = dt_item_w) and (ie_tipo_data_p = 1)) ) and (ie_opcao_geracao_p = 'AD')) or
		 ((a.cd_procedimento = cd_procedimento_w) and (a.ie_origem_proced = ie_origem_proced_w) and (a.cd_setor_atendimento = cd_setor_atend_w) and (ie_opcao_geracao_p in ('AS','ASV'))) or
		 ((a.cd_procedimento = cd_procedimento_w) and (a.ie_origem_proced = ie_origem_proced_w) and (a.cd_setor_atendimento = cd_setor_atend_w) and (ie_opcao_geracao_p = 'ASD') and
						(((trunc(dt_procedimento,'dd') = dt_item_w) and (ie_tipo_data_p = 0)) or ((trunc(dt_conta,'dd') = dt_item_w) and (ie_tipo_data_p = 1)))))
	
union all

	SELECT	a.nr_sequencia
	from	estrutura_procedimento_v b,
		procedimento_paciente a
	where	a.cd_procedimento	= b.cd_procedimento
	and	a.ie_origem_proced	= b.ie_origem_proced
	and	((coalesce(cd_area_procedimento_w, 0) = 0) or (b.cd_area_procedimento = cd_area_procedimento_w))
	and	((coalesce(cd_especialidade_w, 0) = 0) or (b.cd_especialidade = cd_especialidade_w))
	and	((coalesce(cd_grupo_proc_w, 0) = 0) or (b.cd_grupo_proc = cd_grupo_proc_w))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_procedimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'A') or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'C'))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_tipo_item_w in ('A','P'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	(nr_seq_regra_audit_p IS NOT NULL AND nr_seq_regra_audit_p::text <> '')
	and 	(((a.cd_procedimento = cd_procedimento_w) and (a.ie_origem_proced = ie_origem_proced_w) and (ie_opcao_geracao_p in ('AI','AR'))) or
		 ((a.cd_procedimento = cd_procedimento_w) and (a.ie_origem_proced = ie_origem_proced_w) and ( 	((trunc(dt_procedimento,'dd') = dt_item_w) and (ie_tipo_data_p = 0)) or
														((trunc(dt_conta,'dd') = dt_item_w) and (ie_tipo_data_p = 1)) ) and (ie_opcao_geracao_p = 'AD')) or
		 ((a.cd_procedimento = cd_procedimento_w) and (a.ie_origem_proced = ie_origem_proced_w) and (a.cd_setor_atendimento = cd_setor_atend_w) and (ie_opcao_geracao_p in ('AS','ASV'))) or
		 ((a.cd_procedimento = cd_procedimento_w) and (a.ie_origem_proced = ie_origem_proced_w) and (a.cd_setor_atendimento = cd_setor_atend_w) and (ie_opcao_geracao_p = 'ASD') and
						(((trunc(dt_procedimento,'dd') = dt_item_w) and (ie_tipo_data_p = 0)) or ((trunc(dt_conta,'dd') = dt_item_w) and (ie_tipo_data_p = 1)))));


--Agrupados por Item
c03 CURSOR FOR
	SELECT	/*+INDEX(A MATPACI_CONPACI_I) */		a.cd_material,
		sum(a.qt_material),
		sum(a.vl_material)
	from	estrutura_material_v b,
		material_atend_paciente a
	where	a.cd_material		= b.cd_material
	and	((coalesce(cd_grupo_mat_p, 0)= 0) or (b.cd_grupo_material = cd_grupo_mat_p))
	and	((coalesce(cd_subgrupo_p, 0)	= 0) or (b.cd_subgrupo_material = cd_subgrupo_p))
	and	((coalesce(cd_classe_p, 0)	= 0) or (b.cd_classe_material = cd_classe_p))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_atendimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 0) or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 1))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(a.nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and (ie_proc_mat_p in ('A','M'))
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	coalesce(nr_seq_regra_audit_p::text, '') = ''
	and 	ie_opcao_geracao_p = 'AI'
	group by a.cd_material
	
union	all

	PERFORM	/*+INDEX(A MATPACI_CONPACI_I) */		a.cd_material,
		sum(a.qt_material),
		sum(a.vl_material)
	from	estrutura_material_v b,
		material_atend_paciente a
	where	a.cd_material		= b.cd_material
	and	((coalesce(cd_grupo_material_w, 0)= 0) or (b.cd_grupo_material = cd_grupo_material_w))
	and	((coalesce(cd_subgrupo_material_w, 0)= 0) or (b.cd_subgrupo_material = cd_subgrupo_material_w))
	and	((coalesce(cd_classe_material_w, 0)	= 0) or (b.cd_classe_material = cd_classe_material_w))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_w, cd_setor_atendimento)
	and	((a.dt_atendimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'A') or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'C'))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(a.nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and (ie_tipo_item_w in ('A','M'))
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	(nr_seq_regra_audit_p IS NOT NULL AND nr_seq_regra_audit_p::text <> '')
	and 	ie_opcao_geracao_p = 'AI'
	group by a.cd_material;


c04 CURSOR FOR
	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		sum(a.qt_procedimento),
		sum(a.vl_procedimento)
	from	estrutura_procedimento_v b,
		procedimento_paciente a
	where	a.cd_procedimento	= b.cd_procedimento
	and	a.ie_origem_proced	= b.ie_origem_proced
	and	((coalesce(cd_area_proc_p, 0)= 0) or (b.cd_area_procedimento = cd_area_proc_p))
	and	((coalesce(cd_especialidade_p, 0) = 0) or (b.cd_especialidade = cd_especialidade_p))
	and	((coalesce(cd_grupo_proc_p, 0) = 0) or (b.CD_GRUPO_PROC = cd_grupo_proc_p))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_procedimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 0) or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 1))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_proc_mat_p in ('A','P'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	coalesce(nr_seq_regra_audit_p::text, '') = ''
	and 	ie_opcao_geracao_p = 'AI'
	group by a.cd_procedimento,
		a.ie_origem_proced
	
union all

	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		sum(a.qt_procedimento),
		sum(a.vl_procedimento)
	from	estrutura_procedimento_v b,
		procedimento_paciente a
	where	a.cd_procedimento	= b.cd_procedimento
	and	a.ie_origem_proced	= b.ie_origem_proced
	and	((coalesce(cd_area_procedimento_w, 0) = 0) or (b.cd_area_procedimento = cd_area_procedimento_w))
	and	((coalesce(cd_especialidade_w, 0) = 0) or (b.cd_especialidade = cd_especialidade_w))
	and	((coalesce(cd_grupo_proc_w, 0) = 0) or (b.cd_grupo_proc = cd_grupo_proc_w))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_procedimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'A') or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'C'))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_tipo_item_w in ('A','P'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	(nr_seq_regra_audit_p IS NOT NULL AND nr_seq_regra_audit_p::text <> '')
	and 	ie_opcao_geracao_p = 'AI'
	group by a.cd_procedimento,
		a.ie_origem_proced;


--Agrupados por Item/Dia
c05 CURSOR FOR
	SELECT	/*+INDEX(A MATPACI_CONPACI_I) */		a.cd_material,
		trunc(CASE WHEN ie_tipo_data_p=0 THEN  a.dt_atendimento  ELSE a.dt_conta END ,'dd'),
		sum(a.qt_material),
		sum(a.vl_material)
	from	estrutura_material_v b,
		material_atend_paciente a
	where	a.cd_material		= b.cd_material
	and	((coalesce(cd_grupo_mat_p, 0)= 0) or (b.cd_grupo_material = cd_grupo_mat_p))
	and	((coalesce(cd_subgrupo_p, 0)	= 0) or (b.cd_subgrupo_material = cd_subgrupo_p))
	and	((coalesce(cd_classe_p, 0)	= 0) or (b.cd_classe_material = cd_classe_p))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_atendimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 0) or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 1))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(a.nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and (ie_proc_mat_p in ('A','M'))
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	coalesce(nr_seq_regra_audit_p::text, '') = ''
	and 	ie_opcao_geracao_p = 'AD'
	group by a.cd_material,
		trunc(CASE WHEN ie_tipo_data_p=0 THEN  a.dt_atendimento  ELSE a.dt_conta END ,'dd')
	
union	all

	PERFORM	/*+INDEX(A MATPACI_CONPACI_I) */		a.cd_material,
		trunc(CASE WHEN ie_tipo_data_p=0 THEN  a.dt_atendimento  ELSE a.dt_conta END ,'dd'),
		sum(a.qt_material),
		sum(a.vl_material)
	from	estrutura_material_v b,
		material_atend_paciente a
	where	a.cd_material		= b.cd_material
	and	((coalesce(cd_grupo_material_w, 0)= 0) or (b.cd_grupo_material = cd_grupo_material_w))
	and	((coalesce(cd_subgrupo_material_w, 0)= 0) or (b.cd_subgrupo_material = cd_subgrupo_material_w))
	and	((coalesce(cd_classe_material_w, 0)	= 0) or (b.cd_classe_material = cd_classe_material_w))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_w, cd_setor_atendimento)
	and	((a.dt_atendimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'A') or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'C'))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(a.nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and (ie_tipo_item_w in ('A','M'))
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	(nr_seq_regra_audit_p IS NOT NULL AND nr_seq_regra_audit_p::text <> '')
	and 	ie_opcao_geracao_p = 'AD'
	group by a.cd_material,
		trunc(CASE WHEN ie_tipo_data_p=0 THEN  a.dt_atendimento  ELSE a.dt_conta END ,'dd');


c06 CURSOR FOR
	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		trunc(CASE WHEN ie_tipo_data_p=0 THEN  a.dt_procedimento  ELSE a.dt_conta END ,'dd'),
		sum(a.qt_procedimento),
		sum(a.vl_procedimento)
	from	estrutura_procedimento_v b,
		procedimento_paciente a
	where	a.cd_procedimento	= b.cd_procedimento
	and	a.ie_origem_proced	= b.ie_origem_proced
	and	((coalesce(cd_area_proc_p, 0)= 0) or (b.cd_area_procedimento = cd_area_proc_p))
	and	((coalesce(cd_especialidade_p, 0) = 0) or (b.cd_especialidade = cd_especialidade_p))
	and	((coalesce(cd_grupo_proc_p, 0) = 0) or (b.CD_GRUPO_PROC = cd_grupo_proc_p))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_procedimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 0) or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 1))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_proc_mat_p in ('A','P'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	coalesce(nr_seq_regra_audit_p::text, '') = ''
	and 	ie_opcao_geracao_p = 'AD'
	group by a.cd_procedimento,
		a.ie_origem_proced,
		trunc(CASE WHEN ie_tipo_data_p=0 THEN  a.dt_procedimento  ELSE a.dt_conta END ,'dd')
	
union all

	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		CASE WHEN ie_tipo_data_p=0 THEN  a.dt_procedimento  ELSE a.dt_conta END ,
		sum(a.qt_procedimento),
		sum(a.vl_procedimento)
	from	estrutura_procedimento_v b,
		procedimento_paciente a
	where	a.cd_procedimento	= b.cd_procedimento
	and	a.ie_origem_proced	= b.ie_origem_proced
	and	((coalesce(cd_area_procedimento_w, 0) = 0) or (b.cd_area_procedimento = cd_area_procedimento_w))
	and	((coalesce(cd_especialidade_w, 0) = 0) or (b.cd_especialidade = cd_especialidade_w))
	and	((coalesce(cd_grupo_proc_w, 0) = 0) or (b.cd_grupo_proc = cd_grupo_proc_w))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_procedimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'A') or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'C'))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_tipo_item_w in ('A','P'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	(nr_seq_regra_audit_p IS NOT NULL AND nr_seq_regra_audit_p::text <> '')
	and 	ie_opcao_geracao_p = 'AD'
	group by a.cd_procedimento,
		a.ie_origem_proced,
		CASE WHEN ie_tipo_data_p=0 THEN  a.dt_procedimento  ELSE a.dt_conta END;


--Todos os lançamentos (Aberto)
c07 CURSOR FOR
	SELECT	/*+INDEX(A MATPACI_CONPACI_I) */		a.cd_material,
		a.dt_atendimento,
		a.qt_material,
		a.nr_sequencia,
		a.vl_material
	from	estrutura_material_v b,
		material_atend_paciente a
	where	a.cd_material		= b.cd_material
	and	((coalesce(cd_grupo_mat_p, 0)= 0) or (b.cd_grupo_material = cd_grupo_mat_p))
	and	((coalesce(cd_subgrupo_p, 0)	= 0) or (b.cd_subgrupo_material = cd_subgrupo_p))
	and	((coalesce(cd_classe_p, 0)	= 0) or (b.cd_classe_material = cd_classe_p))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_atendimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 0) or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 1))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(a.nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and (ie_proc_mat_p in ('A','M'))
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	coalesce(nr_seq_regra_audit_p::text, '') = ''
	and 	ie_opcao_geracao_p = 'TL'
	
union	all

	PERFORM	/*+INDEX(A MATPACI_CONPACI_I) */		a.cd_material,
		a.dt_atendimento,
		a.qt_material,
		a.nr_sequencia,
		a.vl_material
	from	estrutura_material_v b,
		material_atend_paciente a
	where	a.cd_material		= b.cd_material
	and	((coalesce(cd_grupo_material_w, 0)= 0) or (b.cd_grupo_material = cd_grupo_material_w))
	and	((coalesce(cd_subgrupo_material_w, 0)= 0) or (b.cd_subgrupo_material = cd_subgrupo_material_w))
	and	((coalesce(cd_classe_material_w, 0)	= 0) or (b.cd_classe_material = cd_classe_material_w))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_w, cd_setor_atendimento)
	and	((a.dt_atendimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'A') or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'C'))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(a.nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and (ie_tipo_item_w in ('A','M'))
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	(nr_seq_regra_audit_p IS NOT NULL AND nr_seq_regra_audit_p::text <> '')
	and 	ie_opcao_geracao_p = 'TL';


c08 CURSOR FOR
	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		a.dt_procedimento,
		a.qt_procedimento,
		a.nr_sequencia,
		a.vl_procedimento
	from	estrutura_procedimento_v b,
		procedimento_paciente a
	where	a.cd_procedimento	= b.cd_procedimento
	and	a.ie_origem_proced	= b.ie_origem_proced
	and	((coalesce(cd_area_proc_p, 0)= 0) or (b.cd_area_procedimento = cd_area_proc_p))
	and	((coalesce(cd_especialidade_p, 0) = 0) or (b.cd_especialidade = cd_especialidade_p))
	and	((coalesce(cd_grupo_proc_p, 0) = 0) or (b.CD_GRUPO_PROC = cd_grupo_proc_p))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_procedimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 0) or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 1))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_proc_mat_p in ('A','P'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	coalesce(nr_seq_regra_audit_p::text, '') = ''
	and 	ie_opcao_geracao_p in ('TL','ASM')
	
union all

	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		a.dt_procedimento,
		a.qt_procedimento,
		a.nr_sequencia,
		a.vl_procedimento
	from	estrutura_procedimento_v b,
		procedimento_paciente a
	where	a.cd_procedimento	= b.cd_procedimento
	and	a.ie_origem_proced	= b.ie_origem_proced
	and	((coalesce(cd_area_procedimento_w, 0) = 0) or (b.cd_area_procedimento = cd_area_procedimento_w))
	and	((coalesce(cd_especialidade_w, 0) = 0) or (b.cd_especialidade = cd_especialidade_w))
	and	((coalesce(cd_grupo_proc_w, 0) = 0) or (b.cd_grupo_proc = cd_grupo_proc_w))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_procedimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'A') or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'C'))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_tipo_item_w in ('A','P'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	(nr_seq_regra_audit_p IS NOT NULL AND nr_seq_regra_audit_p::text <> '')
	and 	ie_opcao_geracao_p in ('TL','ASM');


--Agrupados por Item/Setor  e  Agrupados por Item/Setor  (Somente Mat/Med)
c09 CURSOR FOR
	SELECT	/*+INDEX(A MATPACI_CONPACI_I) */		a.cd_material,
		a.cd_setor_atendimento,
		sum(a.qt_material),
		sum(a.vl_material)
	from	estrutura_material_v b,
		material_atend_paciente a
	where	a.cd_material		= b.cd_material
	and	((coalesce(cd_grupo_mat_p, 0)= 0) or (b.cd_grupo_material = cd_grupo_mat_p))
	and	((coalesce(cd_subgrupo_p, 0)	= 0) or (b.cd_subgrupo_material = cd_subgrupo_p))
	and	((coalesce(cd_classe_p, 0)	= 0) or (b.cd_classe_material = cd_classe_p))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_atendimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 0) or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 1))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(a.nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and (ie_proc_mat_p in ('A','M'))
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	coalesce(nr_seq_regra_audit_p::text, '') = ''
	and 	ie_opcao_geracao_p in ('AS','ASM')
	group by a.cd_material,
		a.cd_setor_atendimento
	
union	all

	PERFORM	/*+INDEX(A MATPACI_CONPACI_I) */		a.cd_material,
		a.cd_setor_atendimento,
		sum(a.qt_material),
		sum(a.vl_material)
	from	estrutura_material_v b,
		material_atend_paciente a
	where	a.cd_material		= b.cd_material
	and	((coalesce(cd_grupo_material_w, 0)= 0) or (b.cd_grupo_material = cd_grupo_material_w))
	and	((coalesce(cd_subgrupo_material_w, 0)= 0) or (b.cd_subgrupo_material = cd_subgrupo_material_w))
	and	((coalesce(cd_classe_material_w, 0)	= 0) or (b.cd_classe_material = cd_classe_material_w))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_w, cd_setor_atendimento)
	and	((a.dt_atendimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'A') or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'C'))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(a.nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and (ie_tipo_item_w in ('A','M'))
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	(nr_seq_regra_audit_p IS NOT NULL AND nr_seq_regra_audit_p::text <> '')
	and 	ie_opcao_geracao_p in ('AS','ASM')
	group by a.cd_material,
		a.cd_setor_atendimento;


c10 CURSOR FOR
	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		a.cd_setor_atendimento,
		sum(a.qt_procedimento),
		sum(a.vl_procedimento)
	from	estrutura_procedimento_v b,
		procedimento_paciente a
	where	a.cd_procedimento	= b.cd_procedimento
	and	a.ie_origem_proced	= b.ie_origem_proced
	and	((coalesce(cd_area_proc_p, 0)= 0) or (b.cd_area_procedimento = cd_area_proc_p))
	and	((coalesce(cd_especialidade_p, 0) = 0) or (b.cd_especialidade = cd_especialidade_p))
	and	((coalesce(cd_grupo_proc_p, 0) = 0) or (b.CD_GRUPO_PROC = cd_grupo_proc_p))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_procedimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 0) or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 1))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_proc_mat_p in ('A','P'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	coalesce(nr_seq_regra_audit_p::text, '') = ''
	and 	ie_opcao_geracao_p = 'AS'
	group by a.cd_procedimento,
		a.ie_origem_proced,
		a.cd_setor_atendimento
	
union all

	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		a.cd_setor_atendimento,
		sum(a.qt_procedimento),
		sum(a.vl_procedimento)
	from	estrutura_procedimento_v b,
		procedimento_paciente a
	where	a.cd_procedimento	= b.cd_procedimento
	and	a.ie_origem_proced	= b.ie_origem_proced
	and	((coalesce(cd_area_procedimento_w, 0) = 0) or (b.cd_area_procedimento = cd_area_procedimento_w))
	and	((coalesce(cd_especialidade_w, 0) = 0) or (b.cd_especialidade = cd_especialidade_w))
	and	((coalesce(cd_grupo_proc_w, 0) = 0) or (b.cd_grupo_proc = cd_grupo_proc_w))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_procedimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'A') or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'C'))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_tipo_item_w in ('A','P'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	(nr_seq_regra_audit_p IS NOT NULL AND nr_seq_regra_audit_p::text <> '')
	and 	ie_opcao_geracao_p = 'AS'
	group by a.cd_procedimento,
		a.ie_origem_proced,
		a.cd_setor_atendimento;


-- Agrupado ou não Conforme a regra SHIFT + F11 (Pró Cardíaco)
c11 CURSOR FOR
	SELECT	/*+INDEX(A MATPACI_CONPACI_I) */		a.cd_material,
		a.dt_atendimento,
		a.qt_material,
		a.nr_sequencia,
		a.vl_material
	from	estrutura_material_v b,
		material_atend_paciente a
	where	a.cd_material		= b.cd_material
	and	((coalesce(cd_grupo_mat_p, 0)= 0) or (b.cd_grupo_material = cd_grupo_mat_p))
	and	((coalesce(cd_subgrupo_p, 0)	= 0) or (b.cd_subgrupo_material = cd_subgrupo_p))
	and	((coalesce(cd_classe_p, 0)	= 0) or (b.cd_classe_material = cd_classe_p))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_atendimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 0) or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 1))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(a.nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and (ie_proc_mat_p in ('A','M'))
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	coalesce(nr_seq_regra_audit_p::text, '') = ''
	and 	ie_opcao_geracao_p = 'AR'
	
union	all

	PERFORM	/*+INDEX(A MATPACI_CONPACI_I) */		a.cd_material,
		a.dt_atendimento,
		a.qt_material,
		a.nr_sequencia,
		a.vl_material
	from	estrutura_material_v b,
		material_atend_paciente a
	where	a.cd_material		= b.cd_material
	and	((coalesce(cd_grupo_material_w, 0)= 0) or (b.cd_grupo_material = cd_grupo_material_w))
	and	((coalesce(cd_subgrupo_material_w, 0)= 0) or (b.cd_subgrupo_material = cd_subgrupo_material_w))
	and	((coalesce(cd_classe_material_w, 0)	= 0) or (b.cd_classe_material = cd_classe_material_w))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_w, cd_setor_atendimento)
	and	((a.dt_atendimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'A') or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'C'))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(a.nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and (ie_tipo_item_w in ('A','M'))
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	(nr_seq_regra_audit_p IS NOT NULL AND nr_seq_regra_audit_p::text <> '')
	and 	ie_opcao_geracao_p = 'AR';


c12 CURSOR FOR
	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		a.dt_procedimento,
		a.qt_procedimento,
		a.nr_sequencia,
		a.vl_procedimento
	from	estrutura_procedimento_v b,
		procedimento_paciente a
	where	a.cd_procedimento	= b.cd_procedimento
	and	a.ie_origem_proced	= b.ie_origem_proced
	and	((coalesce(cd_area_proc_p, 0)= 0) or (b.cd_area_procedimento = cd_area_proc_p))
	and	((coalesce(cd_especialidade_p, 0) = 0) or (b.cd_especialidade = cd_especialidade_p))
	and	((coalesce(cd_grupo_proc_p, 0) = 0) or (b.CD_GRUPO_PROC = cd_grupo_proc_p))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_procedimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 0) or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 1))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_proc_mat_p in ('A','P'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	coalesce(nr_seq_regra_audit_p::text, '') = ''
	and 	ie_opcao_geracao_p = 'AR'
	
union all

	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		a.dt_procedimento,
		a.qt_procedimento,
		a.nr_sequencia,
		a.vl_procedimento
	from	estrutura_procedimento_v b,
		procedimento_paciente a
	where	a.cd_procedimento	= b.cd_procedimento
	and	a.ie_origem_proced	= b.ie_origem_proced
	and	((coalesce(cd_area_procedimento_w, 0) = 0) or (b.cd_area_procedimento = cd_area_procedimento_w))
	and	((coalesce(cd_especialidade_w, 0) = 0) or (b.cd_especialidade = cd_especialidade_w))
	and	((coalesce(cd_grupo_proc_w, 0) = 0) or (b.cd_grupo_proc = cd_grupo_proc_w))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_procedimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'A') or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'C'))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_tipo_item_w in ('A','P'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	(nr_seq_regra_audit_p IS NOT NULL AND nr_seq_regra_audit_p::text <> '')
	and 	ie_opcao_geracao_p = 'AR';


C13 CURSOR FOR
	SELECT	a.nr_seq_item,
		a.ie_proc_mat
	from	w_auditoria_externa a
	where	a.ie_agrupa = 'N'
	and 	a.nm_usuario = nm_usuario_p
	and 	a.nr_seq_auditoria = nr_seq_auditoria_p
	and 	ie_opcao_geracao_p = 'AR'
	order by a.ie_proc_mat,
		a.nr_seq_item;

-- Procedimento
C14 CURSOR FOR
	SELECT	b.cd_procedimento,
		b.ie_origem_proced,
		sum(b.qt_procedimento),
		sum(b.vl_procedimento)
	from	procedimento_paciente   b,
		w_auditoria_externa a
	where	a.ie_agrupa = 'S'
	and 	b.nr_sequencia = a.nr_seq_item
	and 	a.nm_usuario = nm_usuario_p
	and 	a.nr_seq_auditoria = nr_seq_auditoria_p
	and 	b.nr_interno_conta = nr_interno_conta_p
	and 	ie_opcao_geracao_p = 'AR'
	and 	a.ie_proc_mat = 'P'
	group by b.cd_procedimento,
		b.ie_origem_proced
	having sum(b.qt_procedimento) <> 0
	order by b.cd_procedimento,
		b.ie_origem_proced;

C15 CURSOR FOR
	SELECT	a.nr_seq_item
	from	procedimento_paciente   b,
		w_auditoria_externa 	a
	where	a.ie_agrupa = 'S'
	and 	b.nr_sequencia = a.nr_seq_item
	and 	a.nm_usuario = nm_usuario_p
	and 	a.nr_seq_auditoria = nr_seq_auditoria_p
	and 	b.nr_interno_conta = nr_interno_conta_p
	and 	ie_opcao_geracao_p = 'AR'
	and 	a.ie_proc_mat = 'P'
	and 	(b.cd_procedimento = cd_procedimento_w AND b.ie_origem_proced = ie_origem_proced_w)
	order by b.cd_procedimento,
		b.ie_origem_proced;

-- Material
C16 CURSOR FOR
	SELECT	b.cd_material,
		sum(b.qt_material),
		sum(b.vl_material)
	from	material_atend_paciente   b,
		w_auditoria_externa a
	where	a.ie_agrupa = 'S'
	and 	b.nr_sequencia = a.nr_seq_item
	and 	a.nm_usuario = nm_usuario_p
	and 	a.nr_seq_auditoria = nr_seq_auditoria_p
	and 	b.nr_interno_conta = nr_interno_conta_p
	and 	ie_opcao_geracao_p = 'AR'
	and 	a.ie_proc_mat = 'M'
	group by b.cd_material
	having 	sum(b.qt_material) <> 0
	order by b.cd_material;

C17 CURSOR FOR
	SELECT	a.nr_seq_item
	from	material_atend_paciente   b,
		w_auditoria_externa a
	where	a.ie_agrupa = 'S'
	and 	b.nr_sequencia = a.nr_seq_item
	and 	a.nm_usuario = nm_usuario_p
	and 	a.nr_seq_auditoria = nr_seq_auditoria_p
	and 	b.nr_interno_conta = nr_interno_conta_p
	and 	ie_opcao_geracao_p = 'AR'
	and 	a.ie_proc_mat = 'M'
	and (b.cd_material = cd_material_w)
	order by b.cd_material;

--Agrupados por Item/Setor/Valor Unitário
c18 CURSOR FOR
	SELECT	/*+INDEX(A MATPACI_CONPACI_I) */		a.cd_material,
		a.cd_setor_atendimento,
		a.vl_unitario,
		sum(a.qt_material),
		sum(a.vl_material)
	from	estrutura_material_v b,
		material_atend_paciente a
	where	a.cd_material		= b.cd_material
	and	((coalesce(cd_grupo_mat_p, 0)= 0) or (b.cd_grupo_material = cd_grupo_mat_p))
	and	((coalesce(cd_subgrupo_p, 0)	= 0) or (b.cd_subgrupo_material = cd_subgrupo_p))
	and	((coalesce(cd_classe_p, 0)	= 0) or (b.cd_classe_material = cd_classe_p))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_atendimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 0) or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 1))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(a.nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and (ie_proc_mat_p in ('A','M'))
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	coalesce(nr_seq_regra_audit_p::text, '') = ''
	and 	ie_opcao_geracao_p = 'ASV'
	group by a.cd_material,
		a.cd_setor_atendimento,
		a.vl_unitario
	
union	all

	PERFORM	/*+INDEX(A MATPACI_CONPACI_I) */		a.cd_material,
		a.cd_setor_atendimento,
		a.vl_unitario,
		sum(a.qt_material),
		sum(a.vl_material)
	from	estrutura_material_v b,
		material_atend_paciente a
	where	a.cd_material		= b.cd_material
	and	((coalesce(cd_grupo_material_w, 0)= 0) or (b.cd_grupo_material = cd_grupo_material_w))
	and	((coalesce(cd_subgrupo_material_w, 0)= 0) or (b.cd_subgrupo_material = cd_subgrupo_material_w))
	and	((coalesce(cd_classe_material_w, 0)	= 0) or (b.cd_classe_material = cd_classe_material_w))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_w, cd_setor_atendimento)
	and	((a.dt_atendimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'A') or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'C'))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(a.nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and (ie_tipo_item_w in ('A','M'))
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	(nr_seq_regra_audit_p IS NOT NULL AND nr_seq_regra_audit_p::text <> '')
	and 	ie_opcao_geracao_p = 'ASV'
	group by a.cd_material,
		a.cd_setor_atendimento,
		a.vl_unitario;


c19 CURSOR FOR
	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		a.cd_setor_atendimento,
		sum(a.qt_procedimento),
		sum(a.vl_procedimento)
	from	estrutura_procedimento_v b,
		procedimento_paciente a
	where	a.cd_procedimento	= b.cd_procedimento
	and	a.ie_origem_proced	= b.ie_origem_proced
	and	((coalesce(cd_area_proc_p, 0)= 0) or (b.cd_area_procedimento = cd_area_proc_p))
	and	((coalesce(cd_especialidade_p, 0) = 0) or (b.cd_especialidade = cd_especialidade_p))
	and	((coalesce(cd_grupo_proc_p, 0) = 0) or (b.CD_GRUPO_PROC = cd_grupo_proc_p))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_procedimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 0) or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 1))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_proc_mat_p in ('A','P'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	coalesce(nr_seq_regra_audit_p::text, '') = ''
	and 	ie_opcao_geracao_p = 'ASV'
	group by a.cd_procedimento,
		a.ie_origem_proced,
		a.cd_setor_atendimento
	
union all

	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		a.cd_setor_atendimento,
		sum(a.qt_procedimento),
		sum(a.vl_procedimento)
	from	estrutura_procedimento_v b,
		procedimento_paciente a
	where	a.cd_procedimento	= b.cd_procedimento
	and	a.ie_origem_proced	= b.ie_origem_proced
	and	((coalesce(cd_area_procedimento_w, 0) = 0) or (b.cd_area_procedimento = cd_area_procedimento_w))
	and	((coalesce(cd_especialidade_w, 0) = 0) or (b.cd_especialidade = cd_especialidade_w))
	and	((coalesce(cd_grupo_proc_w, 0) = 0) or (b.cd_grupo_proc = cd_grupo_proc_w))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_procedimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'A') or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_w = 'C'))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_tipo_item_w in ('A','P'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and	(nr_seq_regra_audit_p IS NOT NULL AND nr_seq_regra_audit_p::text <> '')
	and 	ie_opcao_geracao_p = 'ASV'
	group by a.cd_procedimento,
		a.ie_origem_proced,
		a.cd_setor_atendimento;

--Agrupados por Item/Setor /Dia
c20 CURSOR FOR
	SELECT	/*+INDEX(A MATPACI_CONPACI_I) */		a.cd_material,
		a.cd_setor_atendimento,
		trunc(CASE WHEN ie_tipo_data_p=0 THEN  a.dt_atendimento  ELSE a.dt_conta END ,'dd'),
		sum(a.qt_material),
		sum(a.vl_material)
	from	estrutura_material_v b,
		material_atend_paciente a
	where	a.cd_material		= b.cd_material
	and	((coalesce(cd_grupo_mat_p, 0)= 0) or (b.cd_grupo_material = cd_grupo_mat_p))
	and	((coalesce(cd_subgrupo_p, 0)	= 0) or (b.cd_subgrupo_material = cd_subgrupo_p))
	and	((coalesce(cd_classe_p, 0)	= 0) or (b.cd_classe_material = cd_classe_p))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_atendimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 0) or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 1))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(a.nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and (ie_proc_mat_p in ('A','M'))
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and 	ie_opcao_geracao_p = 'ASD'
	group by a.cd_material,
		a.cd_setor_atendimento,
		trunc(CASE WHEN ie_tipo_data_p=0 THEN  a.dt_atendimento  ELSE a.dt_conta END ,'dd');

c21 CURSOR FOR
	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		a.cd_setor_atendimento,
		trunc(CASE WHEN ie_tipo_data_p=0 THEN  a.dt_procedimento  ELSE a.dt_conta END ,'dd'),
		sum(a.qt_procedimento),
		sum(a.vl_procedimento)
	from	estrutura_procedimento_v b,
		procedimento_paciente a
	where	a.cd_procedimento	= b.cd_procedimento
	and	a.ie_origem_proced	= b.ie_origem_proced
	and	((coalesce(cd_area_proc_p, 0)= 0) or (b.cd_area_procedimento = cd_area_proc_p))
	and	((coalesce(cd_especialidade_p, 0) = 0) or (b.cd_especialidade = cd_especialidade_p))
	and	((coalesce(cd_grupo_proc_p, 0) = 0) or (b.CD_GRUPO_PROC = cd_grupo_proc_p))
	and	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.cd_setor_atendimento	= coalesce(cd_setor_atendimento_p, cd_setor_atendimento)
	and	((a.dt_procedimento between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 0) or
		 (a.dt_conta between dt_periodo_inicial_p and dt_periodo_final_p AND ie_tipo_data_p = 1))
	and	((coalesce(nr_prescricao_p::text, '') = '') or (obter_se_contido(nr_prescricao, '(' || nr_prescricao_p || ')') = 'S'))
	and (ie_proc_mat_p in ('A','P'))
	and (ie_nao_auditados_p = 'N' or coalesce(ie_auditoria,'N') = 'N')
	and 	((ie_pacote_w = 'S') or ((ie_pacote_w = 'N') and (coalesce(nr_seq_proc_pacote::text, '') = '')))
	and 	ie_opcao_geracao_p = 'ASD'
	group by a.cd_procedimento,
		a.ie_origem_proced,
		a.cd_setor_atendimento,
		trunc(CASE WHEN ie_tipo_data_p=0 THEN  a.dt_procedimento  ELSE a.dt_conta END ,'dd');


BEGIN

select	ie_status_acerto
into STRICT	ie_status_acerto_w
from	conta_paciente
where	nr_interno_conta	= nr_interno_conta_p;

if (ie_status_acerto_w = 2) then
	-- A conta está com status em definitivo, não pode ser auditada!
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(237395);
end if;

ie_pacote_w:= obter_valor_param_usuario(1116, 22, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);

/*if (nvl(nr_seq_regra_audit_p,0) > 0) then

	select	cd_setor_atendimento,
		cd_area_procedimento,
		cd_especialidade,
		cd_grupo_proc,
		cd_grupo_material,
		cd_subgrupo_material,
		cd_classe_material,
		ie_tipo_item,
		ie_tipo_data
	into	cd_setor_atendimento_w,
		cd_area_procedimento_w,
		cd_especialidade_w,
		cd_grupo_proc_w,
		cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w,
		ie_tipo_item_w,
		ie_tipo_data_w
	from	regra_geracao_auditoria
	where	nr_sequencia = nr_seq_regra_audit_p
	and	ie_situacao = 'A';

end if;*/
/* ***** Agrupamento por Item ***** */

-- Materiais
open	c03;
loop
fetch	c03 into
	cd_material_w,
	qt_item_w,
	vl_original_w;
EXIT WHEN NOT FOUND; /* apply on c03 */
	begin

	select	nextval('auditoria_externa_seq')
	into STRICT	nr_seq_item_w
	;

	insert	into auditoria_externa(NR_SEQUENCIA,
		DT_ATUALIZACAO,
		NM_USUARIO,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		IE_TIPO_ITEM,
		CD_ITEM,
		IE_ORIGEM_PROCED,
		IE_AGRUPAMENTO,
		DT_ITEM,
		QT_ORIGINAL,
		QT_AJUSTE,
		NR_SEQ_MOTIVO,
		NR_SEQ_AUDITORIA,
		vl_original)
	values (nr_seq_item_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		'M',
		cd_material_w,
		null,
		ie_opcao_geracao_p,
		null,
		qt_item_w,
		null,
		null,
		nr_seq_auditoria_p,
		vl_original_w);

	--Itens que estão sendo auditados (Materiais)
	open	c01;
	loop
	fetch	c01 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		select 	coalesce(max(vl_material),0)
		into STRICT	vl_orig_w
		from 	material_atend_paciente
		where 	nr_sequencia = nr_sequencia_w;

		insert into auditoria_externa_item(NR_SEQUENCIA,
			NR_SEQ_AUDIT_EXT,
			NR_SEQ_ITEM,
			IE_TIPO_ITEM,
			DT_ATUALIZACAO,
			NM_USUARIO,
			DT_ATUALIZACAO_NREC,
			NM_USUARIO_NREC,
			VL_MATERIAL_ORIGINAL)
		values (nextval('auditoria_externa_item_seq'),
			nr_seq_item_w,
			nr_sequencia_w,
			'M',
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			vl_orig_w);

		update	material_atend_paciente
		set	ie_auditoria	= 'A'
		where	nr_sequencia	= nr_sequencia_w;

		end;

	end loop;
	close c01;

	end;
end loop;
close c03;

-- Procedimentos
open	c04;
loop
fetch	c04 into
	cd_procedimento_w,
	ie_origem_proced_w,
	qt_item_w,
	vl_original_w;
EXIT WHEN NOT FOUND; /* apply on c04 */
	begin

	select	nextval('auditoria_externa_seq')
	into STRICT	nr_seq_item_w
	;

	insert	into auditoria_externa(NR_SEQUENCIA,
		DT_ATUALIZACAO,
		NM_USUARIO,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		IE_TIPO_ITEM,
		CD_ITEM,
		IE_ORIGEM_PROCED,
		IE_AGRUPAMENTO,
		DT_ITEM,
		QT_ORIGINAL,
		QT_AJUSTE,
		NR_SEQ_MOTIVO,
		NR_SEQ_AUDITORIA,
		vl_original)
	values (nr_seq_item_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		'P',
		cd_procedimento_w,
		ie_origem_proced_w,
		ie_opcao_geracao_p,
		null,
		qt_item_w,
		null,
		null,
		nr_seq_auditoria_p,
		vl_original_w);

	--Itens que estão sendo auditados (Procedimentos)
	open	c02;
	loop
	fetch	c02 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin

		select 	coalesce(max(vl_medico),0),
			coalesce(max(vl_custo_operacional),0),
			coalesce(max(vl_materiais),0),
			coalesce(max(vl_procedimento),0)
		into STRICT	vl_medico_orig_w,
			vl_custo_oper_orig_w,
			vl_mat_orig_w,
			vl_proc_orig_w
		from 	procedimento_paciente
		where 	nr_sequencia = nr_sequencia_w;

		insert into auditoria_externa_item(NR_SEQUENCIA,
			NR_SEQ_AUDIT_EXT,
			NR_SEQ_ITEM,
			IE_TIPO_ITEM,
			DT_ATUALIZACAO,
			NM_USUARIO,
			DT_ATUALIZACAO_NREC,
			NM_USUARIO_NREC,
			VL_MEDICO_ORIGINAL,
			VL_CUSTO_OPER_ORIGINAL,
			VL_MATERIAIS_ORIGINAL,
			VL_PROCEDIMENTO_ORIG)
		values (nextval('auditoria_externa_item_seq'),
			nr_seq_item_w,
			nr_sequencia_w,
			'P',
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			vl_medico_orig_w,
			vl_custo_oper_orig_w,
			vl_mat_orig_w,
			vl_proc_orig_w);

		update	procedimento_paciente
		set	ie_auditoria	= 'A'
		where	nr_sequencia	= nr_sequencia_w;

		end;
	end loop;
	close c02;

	end;
end loop;
close c04;




/* ***** Agrupamento por Item / Dia  ***** */

-- Materiais
open	c05;
loop
fetch	c05 into
	cd_material_w,
	dt_item_w,
	qt_item_w,
	vl_original_w;
EXIT WHEN NOT FOUND; /* apply on c05 */
	begin

	select	nextval('auditoria_externa_seq')
	into STRICT	nr_seq_item_w
	;

	insert	into auditoria_externa(NR_SEQUENCIA,
		DT_ATUALIZACAO,
		NM_USUARIO,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		IE_TIPO_ITEM,
		CD_ITEM,
		IE_ORIGEM_PROCED,
		IE_AGRUPAMENTO,
		DT_ITEM,
		QT_ORIGINAL,
		QT_AJUSTE,
		NR_SEQ_MOTIVO,
		NR_SEQ_AUDITORIA,
		vl_original)
	values (nr_seq_item_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		'M',
		cd_material_w,
		null,
		ie_opcao_geracao_p,
		dt_item_w,
		qt_item_w,
		null,
		null,
		nr_seq_auditoria_p,
		vl_original_w);


	--Itens que estão sendo auditados (Materiais)
	open	c01;
	loop
	fetch	c01 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		select 	coalesce(max(vl_material),0)
		into STRICT	vl_orig_w
		from 	material_atend_paciente
		where 	nr_sequencia = nr_sequencia_w;

		insert into auditoria_externa_item(NR_SEQUENCIA,
			NR_SEQ_AUDIT_EXT,
			NR_SEQ_ITEM,
			IE_TIPO_ITEM,
			DT_ATUALIZACAO,
			NM_USUARIO,
			DT_ATUALIZACAO_NREC,
			NM_USUARIO_NREC,
			VL_MATERIAL_ORIGINAL)
		values (nextval('auditoria_externa_item_seq'),
			nr_seq_item_w,
			nr_sequencia_w,
			'M',
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			vl_orig_w);

		update	material_atend_paciente
		set	ie_auditoria	= 'A'
		where	nr_sequencia	= nr_sequencia_w;

		end;

	end loop;
	close c01;

	end;
end loop;
close c05;

-- Procedimentos
open	c06;
loop
fetch	c06 into
	cd_procedimento_w,
	ie_origem_proced_w,
	dt_item_w,
	qt_item_w,
	vl_original_w;
EXIT WHEN NOT FOUND; /* apply on c06 */
	begin

	select	nextval('auditoria_externa_seq')
	into STRICT	nr_seq_item_w
	;

	insert	into auditoria_externa(NR_SEQUENCIA,
		DT_ATUALIZACAO,
		NM_USUARIO,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		IE_TIPO_ITEM,
		CD_ITEM,
		IE_ORIGEM_PROCED,
		IE_AGRUPAMENTO,
		DT_ITEM,
		QT_ORIGINAL,
		QT_AJUSTE,
		NR_SEQ_MOTIVO,
		NR_SEQ_AUDITORIA,
		vl_original)
	values (nr_seq_item_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		'P',
		cd_procedimento_w,
		ie_origem_proced_w,
		ie_opcao_geracao_p,
		dt_item_w,
		qt_item_w,
		null,
		null,
		nr_seq_auditoria_p,
		vl_original_w);

	--Itens que estão sendo auditados (Procedimentos)
	open	c02;
	loop
	fetch	c02 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin

		select 	coalesce(max(vl_medico),0),
			coalesce(max(vl_custo_operacional),0),
			coalesce(max(vl_materiais),0),
			coalesce(max(vl_procedimento),0)
		into STRICT	vl_medico_orig_w,
			vl_custo_oper_orig_w,
			vl_mat_orig_w,
			vl_proc_orig_w
		from 	procedimento_paciente
		where 	nr_sequencia = nr_sequencia_w;

		insert into auditoria_externa_item(NR_SEQUENCIA,
			NR_SEQ_AUDIT_EXT,
			NR_SEQ_ITEM,
			IE_TIPO_ITEM,
			DT_ATUALIZACAO,
			NM_USUARIO,
			DT_ATUALIZACAO_NREC,
			NM_USUARIO_NREC,
			VL_MEDICO_ORIGINAL,
			VL_CUSTO_OPER_ORIGINAL,
			VL_MATERIAIS_ORIGINAL,
			VL_PROCEDIMENTO_ORIG)
		values (nextval('auditoria_externa_item_seq'),
			nr_seq_item_w,
			nr_sequencia_w,
			'P',
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			vl_medico_orig_w,
			vl_custo_oper_orig_w,
			vl_mat_orig_w,
			vl_proc_orig_w);

		update	procedimento_paciente
		set	ie_auditoria	= 'A'
		where	nr_sequencia	= nr_sequencia_w;

		end;
	end loop;
	close c02;

	end;
end loop;
close c06;



/* ***** Todos os lançamentos aberto  ***** */

-- Materiais
open	c07;
loop
fetch	c07 into
	cd_material_w,
	dt_item_w,
	qt_item_w,
	nr_sequencia_w,
	vl_original_w;
EXIT WHEN NOT FOUND; /* apply on c07 */
	begin

	select	nextval('auditoria_externa_seq')
	into STRICT	nr_seq_item_w
	;

	insert	into auditoria_externa(NR_SEQUENCIA,
		DT_ATUALIZACAO,
		NM_USUARIO,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		IE_TIPO_ITEM,
		CD_ITEM,
		IE_ORIGEM_PROCED,
		IE_AGRUPAMENTO,
		DT_ITEM,
		QT_ORIGINAL,
		QT_AJUSTE,
		NR_SEQ_MOTIVO,
		NR_SEQ_AUDITORIA,
		vl_original)
	values (nr_seq_item_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		'M',
		cd_material_w,
		null,
		ie_opcao_geracao_p,
		dt_item_w,
		qt_item_w,
		null,
		null,
		nr_seq_auditoria_p,
		vl_original_w);


	select 	coalesce(max(vl_material),0)
	into STRICT	vl_orig_w
	from 	material_atend_paciente
	where 	nr_sequencia = nr_sequencia_w;

	insert into auditoria_externa_item(NR_SEQUENCIA,
		NR_SEQ_AUDIT_EXT,
		NR_SEQ_ITEM,
		IE_TIPO_ITEM,
		DT_ATUALIZACAO,
		NM_USUARIO,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		VL_MATERIAL_ORIGINAL)
	values (nextval('auditoria_externa_item_seq'),
		nr_seq_item_w,
		nr_sequencia_w,
		'M',
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		vl_orig_w);

	update	material_atend_paciente
	set	ie_auditoria	= 'A'
	where	nr_sequencia	= nr_sequencia_w;

	end;
end loop;
close c07;

-- Procedimentos
open	c08;
loop
fetch	c08 into
	cd_procedimento_w,
	ie_origem_proced_w,
	dt_item_w,
	qt_item_w,
	nr_sequencia_w,
	vl_original_w;
EXIT WHEN NOT FOUND; /* apply on c08 */
	begin

	select	nextval('auditoria_externa_seq')
	into STRICT	nr_seq_item_w
	;

	insert	into auditoria_externa(NR_SEQUENCIA,
		DT_ATUALIZACAO,
		NM_USUARIO,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		IE_TIPO_ITEM,
		CD_ITEM,
		IE_ORIGEM_PROCED,
		IE_AGRUPAMENTO,
		DT_ITEM,
		QT_ORIGINAL,
		QT_AJUSTE,
		NR_SEQ_MOTIVO,
		NR_SEQ_AUDITORIA,
		vl_original)
	values (nr_seq_item_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		'P',
		cd_procedimento_w,
		ie_origem_proced_w,
		ie_opcao_geracao_p,
		dt_item_w,
		qt_item_w,
		null,
		null,
		nr_seq_auditoria_p,
		vl_original_w);

	select 	coalesce(max(vl_medico),0),
		coalesce(max(vl_custo_operacional),0),
		coalesce(max(vl_materiais),0),
		coalesce(max(vl_procedimento),0)
	into STRICT	vl_medico_orig_w,
		vl_custo_oper_orig_w,
		vl_mat_orig_w,
		vl_proc_orig_w
	from 	procedimento_paciente
	where 	nr_sequencia = nr_sequencia_w;

	insert into auditoria_externa_item(NR_SEQUENCIA,
		NR_SEQ_AUDIT_EXT,
		NR_SEQ_ITEM,
		IE_TIPO_ITEM,
		DT_ATUALIZACAO,
		NM_USUARIO,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		VL_MEDICO_ORIGINAL,
		VL_CUSTO_OPER_ORIGINAL,
		VL_MATERIAIS_ORIGINAL,
		VL_PROCEDIMENTO_ORIG)
	values (nextval('auditoria_externa_item_seq'),
		nr_seq_item_w,
		nr_sequencia_w,
		'P',
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		vl_medico_orig_w,
		vl_custo_oper_orig_w,
		vl_mat_orig_w,
		vl_proc_orig_w);

	update	procedimento_paciente
	set	ie_auditoria	= 'A'
	where	nr_sequencia	= nr_sequencia_w;

	end;
end loop;
close c08;


/* ***** Agrupamento por Item / SETOR ***** */

-- Materiais
open	c09;
loop
fetch	c09 into
	cd_material_w,
	cd_setor_atend_w,
	qt_item_w,
	vl_original_w;
EXIT WHEN NOT FOUND; /* apply on c09 */
	begin

	select	nextval('auditoria_externa_seq')
	into STRICT	nr_seq_item_w
	;

	insert	into auditoria_externa(NR_SEQUENCIA,
		DT_ATUALIZACAO,
		NM_USUARIO,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		IE_TIPO_ITEM,
		CD_ITEM,
		IE_ORIGEM_PROCED,
		IE_AGRUPAMENTO,
		DT_ITEM,
		QT_ORIGINAL,
		QT_AJUSTE,
		NR_SEQ_MOTIVO,
		NR_SEQ_AUDITORIA,
		CD_SETOR_ATENDIMENTO,
		vl_original)
	values (nr_seq_item_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		'M',
		cd_material_w,
		null,
		ie_opcao_geracao_p,
		null,
		qt_item_w,
		null,
		null,
		nr_seq_auditoria_p,
		cd_setor_atend_w,
		vl_original_w);

	--Itens que estão sendo auditados (Materiais)
	open	c01;
	loop
	fetch	c01 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		select 	coalesce(max(vl_material),0)
		into STRICT	vl_orig_w
		from 	material_atend_paciente
		where 	nr_sequencia = nr_sequencia_w;

		insert into auditoria_externa_item(NR_SEQUENCIA,
			NR_SEQ_AUDIT_EXT,
			NR_SEQ_ITEM,
			IE_TIPO_ITEM,
			DT_ATUALIZACAO,
			NM_USUARIO,
			DT_ATUALIZACAO_NREC,
			NM_USUARIO_NREC,
			VL_MATERIAL_ORIGINAL)
		values (nextval('auditoria_externa_item_seq'),
			nr_seq_item_w,
			nr_sequencia_w,
			'M',
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			vl_orig_w);

		update	material_atend_paciente
		set	ie_auditoria	= 'A'
		where	nr_sequencia	= nr_sequencia_w;

		end;

	end loop;
	close c01;

	end;
end loop;
close c09;

-- Procedimentos
open	c10;
loop
fetch	c10 into
	cd_procedimento_w,
	ie_origem_proced_w,
	cd_setor_atend_w,
	qt_item_w,
	vl_original_w;
EXIT WHEN NOT FOUND; /* apply on c10 */
	begin

	select	nextval('auditoria_externa_seq')
	into STRICT	nr_seq_item_w
	;

	insert	into auditoria_externa(NR_SEQUENCIA,
		DT_ATUALIZACAO,
		NM_USUARIO,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		IE_TIPO_ITEM,
		CD_ITEM,
		IE_ORIGEM_PROCED,
		IE_AGRUPAMENTO,
		DT_ITEM,
		QT_ORIGINAL,
		QT_AJUSTE,
		NR_SEQ_MOTIVO,
		NR_SEQ_AUDITORIA,
		CD_SETOR_ATENDIMENTO,
		vl_original)
	values (nr_seq_item_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		'P',
		cd_procedimento_w,
		ie_origem_proced_w,
		ie_opcao_geracao_p,
		null,
		qt_item_w,
		null,
		null,
		nr_seq_auditoria_p,
		cd_setor_atend_w,
		vl_original_w);

	--Itens que estão sendo auditados (Procedimentos)
	open	c02;
	loop
	fetch	c02 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin

		select 	coalesce(max(vl_medico),0),
			coalesce(max(vl_custo_operacional),0),
			coalesce(max(vl_materiais),0),
			coalesce(max(vl_procedimento),0)
		into STRICT	vl_medico_orig_w,
			vl_custo_oper_orig_w,
			vl_mat_orig_w,
			vl_proc_orig_w
		from 	procedimento_paciente
		where 	nr_sequencia = nr_sequencia_w;

		insert into auditoria_externa_item(NR_SEQUENCIA,
			NR_SEQ_AUDIT_EXT,
			NR_SEQ_ITEM,
			IE_TIPO_ITEM,
			DT_ATUALIZACAO,
			NM_USUARIO,
			DT_ATUALIZACAO_NREC,
			NM_USUARIO_NREC,
			VL_MEDICO_ORIGINAL,
			VL_CUSTO_OPER_ORIGINAL,
			VL_MATERIAIS_ORIGINAL,
			VL_PROCEDIMENTO_ORIG)
		values (nextval('auditoria_externa_item_seq'),
			nr_seq_item_w,
			nr_sequencia_w,
			'P',
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			vl_medico_orig_w,
			vl_custo_oper_orig_w,
			vl_mat_orig_w,
			vl_proc_orig_w);

		update	procedimento_paciente
		set	ie_auditoria	= 'A'
		where	nr_sequencia	= nr_sequencia_w;

		end;
	end loop;
	close c02;

	end;
end loop;
close c10;

delete from w_auditoria_externa
where nm_usuario = nm_usuario_p;

/* ***** Agrupamento conforme REGRA  (Agrupa ou não agrupa)***** */

-- Materiais
open	c11;
loop
fetch	c11 into
	cd_material_w,
	dt_item_w,
	qt_item_w,
	nr_sequencia_w,
	vl_original_w;
EXIT WHEN NOT FOUND; /* apply on c11 */
	begin

	select 	Obter_se_agrup_audit_ext(nr_seq_regra_audit_ext_p, nr_sequencia_w, 'M')
	into STRICT	ie_agrupar_w
	;

	insert into w_auditoria_externa(NR_SEQ_AUDITORIA,
		DT_ATUALIZACAO,
		NM_USUARIO,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		NR_SEQ_ITEM,
		IE_AGRUPA,
		IE_PROC_MAT)
	values (nr_seq_auditoria_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_sequencia_w,
		ie_agrupar_w,
		'M');

	commit;

	end;
end loop;
close c11;

-- Procedimentos
open	c12;
loop
fetch	c12 into
	cd_procedimento_w,
	ie_origem_proced_w,
	dt_item_w,
	qt_item_w,
	nr_sequencia_w,
	vl_original_w;
EXIT WHEN NOT FOUND; /* apply on c12 */
	begin

	select 	Obter_se_agrup_audit_ext(nr_seq_regra_audit_ext_p, nr_sequencia_w, 'P')
	into STRICT	ie_agrupar_w
	;

	insert into w_auditoria_externa(NR_SEQ_AUDITORIA,
		DT_ATUALIZACAO,
		NM_USUARIO,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		NR_SEQ_ITEM,
		IE_AGRUPA,
		IE_PROC_MAT)
	values (nr_seq_auditoria_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_sequencia_w,
		ie_agrupar_w,
		'P');

	commit;

	end;
end loop;
close c12;

/* Itens que não agrupam 1 para 1 */

open C13;
loop
fetch c13 into
	nr_sequencia_w,
	ie_proc_mat_w;
EXIT WHEN NOT FOUND; /* apply on C13 */
	begin

	select	nextval('auditoria_externa_seq')
	into STRICT	nr_seq_item_w
	;

	if (ie_proc_mat_w = 'P') then

		select 	max(cd_procedimento),
			max(ie_origem_proced),
			max(qt_procedimento),
			coalesce(max(vl_medico),0),
			coalesce(max(vl_custo_operacional),0),
			coalesce(max(vl_materiais),0),
			coalesce(max(vl_procedimento),0)
		into STRICT	cd_procedimento_w,
			ie_origem_proced_w,
			qt_item_w,
			vl_medico_orig_w,
			vl_custo_oper_orig_w,
			vl_mat_orig_w,
			vl_proc_orig_w
		from 	procedimento_paciente
		where 	nr_Sequencia = nr_sequencia_w;


	else

		select 	max(cd_material),
			max(qt_material),
			coalesce(max(vl_material),0)
		into STRICT	cd_material_w,
			qt_item_w,
			vl_orig_w
		from 	material_atend_paciente
		where 	nr_Sequencia = nr_sequencia_w;

	end if;

	insert	into auditoria_externa(NR_SEQUENCIA,
		DT_ATUALIZACAO,
		NM_USUARIO,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		IE_TIPO_ITEM,
		CD_ITEM,
		IE_ORIGEM_PROCED,
		IE_AGRUPAMENTO,
		DT_ITEM,
		QT_ORIGINAL,
		QT_AJUSTE,
		NR_SEQ_MOTIVO,
		NR_SEQ_AUDITORIA,
		CD_SETOR_ATENDIMENTO,
		vl_original)
	values (nr_seq_item_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		ie_proc_mat_w,
		CASE WHEN ie_proc_mat_w='P' THEN  cd_procedimento_w  ELSE cd_material_w END ,
		CASE WHEN ie_proc_mat_w='P' THEN  ie_origem_proced_w  ELSE null END ,
		ie_opcao_geracao_p,
		null,
		qt_item_w,
		null,
		null,
		nr_seq_auditoria_p,
		null,
		CASE WHEN ie_proc_mat_w='P' THEN  vl_proc_orig_w  ELSE vl_orig_w END );

	insert into auditoria_externa_item(NR_SEQUENCIA,
		NR_SEQ_AUDIT_EXT,
		NR_SEQ_ITEM,
		IE_TIPO_ITEM,
		DT_ATUALIZACAO,
		NM_USUARIO,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		VL_MATERIAL_ORIGINAL,
		VL_MEDICO_ORIGINAL,
		VL_CUSTO_OPER_ORIGINAL,
		VL_MATERIAIS_ORIGINAL,
		VL_PROCEDIMENTO_ORIG)
	values (nextval('auditoria_externa_item_seq'),
		nr_seq_item_w,
		nr_sequencia_w,
		ie_proc_mat_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		CASE WHEN ie_proc_mat_w='P' THEN  null  ELSE vl_orig_w END ,
		CASE WHEN ie_proc_mat_w='P' THEN vl_medico_orig_w  ELSE null END ,
		CASE WHEN ie_proc_mat_w='P' THEN vl_custo_oper_orig_w  ELSE null END ,
		CASE WHEN ie_proc_mat_w='P' THEN vl_mat_orig_w  ELSE null END ,
		CASE WHEN ie_proc_mat_w='P' THEN vl_proc_orig_w  ELSE null END );

	update	procedimento_paciente
	set	ie_auditoria	= 'A'
	where	nr_sequencia	= nr_sequencia_w;

	end;
end loop;
close C13;

/* Itens que agrupam */

/* Procedimentos */

-- Procedimentos
open	c14;
loop
fetch	c14 into
	cd_procedimento_w,
	ie_origem_proced_w,
	qt_item_w,
	vl_original_w;
EXIT WHEN NOT FOUND; /* apply on c14 */
	begin

	select	nextval('auditoria_externa_seq')
	into STRICT	nr_seq_item_w
	;

	insert	into auditoria_externa(NR_SEQUENCIA,
		DT_ATUALIZACAO,
		NM_USUARIO,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		IE_TIPO_ITEM,
		CD_ITEM,
		IE_ORIGEM_PROCED,
		IE_AGRUPAMENTO,
		DT_ITEM,
		QT_ORIGINAL,
		QT_AJUSTE,
		NR_SEQ_MOTIVO,
		NR_SEQ_AUDITORIA,
		CD_SETOR_ATENDIMENTO,
		vl_original)
	values (nr_seq_item_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		'P',
		cd_procedimento_w,
		ie_origem_proced_w,
		ie_opcao_geracao_p,
		null,
		qt_item_w,
		null,
		null,
		nr_seq_auditoria_p,
		null,
		vl_original_w);

	--Itens que estão sendo auditados (Procedimentos)
	open	c15;
	loop
	fetch	c15 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on c15 */
		begin

		select 	coalesce(max(vl_medico),0),
			coalesce(max(vl_custo_operacional),0),
			coalesce(max(vl_materiais),0),
			coalesce(max(vl_procedimento),0)
		into STRICT	vl_medico_orig_w,
			vl_custo_oper_orig_w,
			vl_mat_orig_w,
			vl_proc_orig_w
		from 	procedimento_paciente
		where 	nr_sequencia = nr_sequencia_w;

		insert into auditoria_externa_item(NR_SEQUENCIA,
			NR_SEQ_AUDIT_EXT,
			NR_SEQ_ITEM,
			IE_TIPO_ITEM,
			DT_ATUALIZACAO,
			NM_USUARIO,
			DT_ATUALIZACAO_NREC,
			NM_USUARIO_NREC,
			VL_MEDICO_ORIGINAL,
			VL_CUSTO_OPER_ORIGINAL,
			VL_MATERIAIS_ORIGINAL,
			VL_PROCEDIMENTO_ORIG)
		values (nextval('auditoria_externa_item_seq'),
			nr_seq_item_w,
			nr_sequencia_w,
			'P',
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			vl_medico_orig_w,
			vl_custo_oper_orig_w,
			vl_mat_orig_w,
			vl_proc_orig_w);

		update	procedimento_paciente
		set	ie_auditoria	= 'A'
		where	nr_sequencia	= nr_sequencia_w;

		end;
	end loop;
	close c15;

	end;
end loop;
close c14;

/*Materiais */

open	c16;
loop
fetch	c16 into
	cd_material_w,
	qt_item_w,
	vl_original_w;
EXIT WHEN NOT FOUND; /* apply on c16 */
	begin

	select	nextval('auditoria_externa_seq')
	into STRICT	nr_seq_item_w
	;

	insert	into auditoria_externa(NR_SEQUENCIA,
		DT_ATUALIZACAO,
		NM_USUARIO,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		IE_TIPO_ITEM,
		CD_ITEM,
		IE_ORIGEM_PROCED,
		IE_AGRUPAMENTO,
		DT_ITEM,
		QT_ORIGINAL,
		QT_AJUSTE,
		NR_SEQ_MOTIVO,
		NR_SEQ_AUDITORIA,
		CD_SETOR_ATENDIMENTO,
		vl_original)
	values (nr_seq_item_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		'M',
		cd_material_w,
		null,
		ie_opcao_geracao_p,
		null,
		qt_item_w,
		null,
		null,
		nr_seq_auditoria_p,
		null,
		vl_original_w);

	--Itens que estão sendo auditados (Materiais)
	open	c17;
	loop
	fetch	c17 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on c17 */
		begin

		select 	coalesce(max(vl_material),0)
		into STRICT	vl_orig_w
		from 	material_atend_paciente
		where 	nr_sequencia = nr_sequencia_w;

		insert into auditoria_externa_item(NR_SEQUENCIA,
			NR_SEQ_AUDIT_EXT,
			NR_SEQ_ITEM,
			IE_TIPO_ITEM,
			DT_ATUALIZACAO,
			NM_USUARIO,
			DT_ATUALIZACAO_NREC,
			NM_USUARIO_NREC,
			VL_MATERIAL_ORIGINAL)
		values (nextval('auditoria_externa_item_seq'),
			nr_seq_item_w,
			nr_sequencia_w,
			'M',
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			vl_orig_w);

		update	material_atend_paciente
		set	ie_auditoria	= 'A'
		where	nr_sequencia	= nr_sequencia_w;

		end;
	end loop;
	close c17;

	end;
end loop;
close c16;


/* ***** Agrupamento por Item / SETOR / Valor Unitário  ***** */

-- Materiais
open	c18;
loop
fetch	c18 into
	cd_material_w,
	cd_setor_atend_w,
	vl_unitario_w,
	qt_item_w,
	vl_original_w;
EXIT WHEN NOT FOUND; /* apply on c18 */
	begin

	select	nextval('auditoria_externa_seq')
	into STRICT	nr_seq_item_w
	;

	insert	into auditoria_externa(NR_SEQUENCIA,
		DT_ATUALIZACAO,
		NM_USUARIO,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		IE_TIPO_ITEM,
		CD_ITEM,
		IE_ORIGEM_PROCED,
		IE_AGRUPAMENTO,
		DT_ITEM,
		QT_ORIGINAL,
		QT_AJUSTE,
		NR_SEQ_MOTIVO,
		NR_SEQ_AUDITORIA,
		CD_SETOR_ATENDIMENTO,
		vl_unitario,
		vl_original)
	values (nr_seq_item_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		'M',
		cd_material_w,
		null,
		ie_opcao_geracao_p,
		null,
		qt_item_w,
		null,
		null,
		nr_seq_auditoria_p,
		cd_setor_atend_w,
		vl_unitario_w,
		vl_original_w);

	--Itens que estão sendo auditados (Materiais)
	open	c01;
	loop
	fetch	c01 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		select 	coalesce(max(vl_material),0)
		into STRICT	vl_orig_w
		from 	material_atend_paciente
		where 	nr_sequencia = nr_sequencia_w;

		insert into auditoria_externa_item(NR_SEQUENCIA,
			NR_SEQ_AUDIT_EXT,
			NR_SEQ_ITEM,
			IE_TIPO_ITEM,
			DT_ATUALIZACAO,
			NM_USUARIO,
			DT_ATUALIZACAO_NREC,
			NM_USUARIO_NREC,
			VL_MATERIAL_ORIGINAL)
		values (nextval('auditoria_externa_item_seq'),
			nr_seq_item_w,
			nr_sequencia_w,
			'M',
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			vl_orig_w);

		update	material_atend_paciente
		set	ie_auditoria	= 'A'
		where	nr_sequencia	= nr_sequencia_w;

		end;

	end loop;
	close c01;

	end;
end loop;
close c18;

-- Procedimentos
open	c19;
loop
fetch	c19 into
	cd_procedimento_w,
	ie_origem_proced_w,
	cd_setor_atend_w,
	qt_item_w,
	vl_original_w;
EXIT WHEN NOT FOUND; /* apply on c19 */
	begin

	select	nextval('auditoria_externa_seq')
	into STRICT	nr_seq_item_w
	;

	insert	into auditoria_externa(NR_SEQUENCIA,
		DT_ATUALIZACAO,
		NM_USUARIO,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		IE_TIPO_ITEM,
		CD_ITEM,
		IE_ORIGEM_PROCED,
		IE_AGRUPAMENTO,
		DT_ITEM,
		QT_ORIGINAL,
		QT_AJUSTE,
		NR_SEQ_MOTIVO,
		NR_SEQ_AUDITORIA,
		CD_SETOR_ATENDIMENTO,
		vl_original)
	values (nr_seq_item_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		'P',
		cd_procedimento_w,
		ie_origem_proced_w,
		ie_opcao_geracao_p,
		null,
		qt_item_w,
		null,
		null,
		nr_seq_auditoria_p,
		cd_setor_atend_w,
		vl_original_w);

	--Itens que estão sendo auditados (Procedimentos)
	open	c02;
	loop
	fetch	c02 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin

		select 	coalesce(max(vl_medico),0),
			coalesce(max(vl_custo_operacional),0),
			coalesce(max(vl_materiais),0),
			coalesce(max(vl_procedimento),0)
		into STRICT	vl_medico_orig_w,
			vl_custo_oper_orig_w,
			vl_mat_orig_w,
			vl_proc_orig_w
		from 	procedimento_paciente
		where 	nr_sequencia = nr_sequencia_w;

		insert into auditoria_externa_item(NR_SEQUENCIA,
			NR_SEQ_AUDIT_EXT,
			NR_SEQ_ITEM,
			IE_TIPO_ITEM,
			DT_ATUALIZACAO,
			NM_USUARIO,
			DT_ATUALIZACAO_NREC,
			NM_USUARIO_NREC,
			VL_MEDICO_ORIGINAL,
			VL_CUSTO_OPER_ORIGINAL,
			VL_MATERIAIS_ORIGINAL,
			VL_PROCEDIMENTO_ORIG)
		values (nextval('auditoria_externa_item_seq'),
			nr_seq_item_w,
			nr_sequencia_w,
			'P',
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			vl_medico_orig_w,
			vl_custo_oper_orig_w,
			vl_mat_orig_w,
			vl_proc_orig_w);

		update	procedimento_paciente
		set	ie_auditoria	= 'A'
		where	nr_sequencia	= nr_sequencia_w;

		end;
	end loop;
	close c02;

	end;
end loop;
close c19;


/* ***** Agrupamento por Item / Setor / Dia ***** */

-- Materiais
open	c20;
loop
fetch	c20 into
	cd_material_w,
	cd_setor_atend_w,
	dt_item_w,
	qt_item_w,
	vl_original_w;
EXIT WHEN NOT FOUND; /* apply on c20 */
	begin

	select	nextval('auditoria_externa_seq')
	into STRICT	nr_seq_item_w
	;

	insert	into auditoria_externa(NR_SEQUENCIA,
		DT_ATUALIZACAO,
		NM_USUARIO,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		IE_TIPO_ITEM,
		CD_ITEM,
		IE_ORIGEM_PROCED,
		IE_AGRUPAMENTO,
		DT_ITEM,
		QT_ORIGINAL,
		QT_AJUSTE,
		NR_SEQ_MOTIVO,
		NR_SEQ_AUDITORIA,
		CD_SETOR_ATENDIMENTO,
		vl_original)
	values (nr_seq_item_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		'M',
		cd_material_w,
		null,
		ie_opcao_geracao_p,
		dt_item_w,
		qt_item_w,
		null,
		null,
		nr_seq_auditoria_p,
		cd_setor_atend_w,
		vl_original_w);

	--Itens que estão sendo auditados (Materiais)
	open	c01;
	loop
	fetch	c01 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		select 	coalesce(max(vl_material),0)
		into STRICT	vl_orig_w
		from 	material_atend_paciente
		where 	nr_sequencia = nr_sequencia_w;

		insert into auditoria_externa_item(NR_SEQUENCIA,
			NR_SEQ_AUDIT_EXT,
			NR_SEQ_ITEM,
			IE_TIPO_ITEM,
			DT_ATUALIZACAO,
			NM_USUARIO,
			DT_ATUALIZACAO_NREC,
			NM_USUARIO_NREC,
			VL_MATERIAL_ORIGINAL)
		values (nextval('auditoria_externa_item_seq'),
			nr_seq_item_w,
			nr_sequencia_w,
			'M',
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			vl_orig_w);

		update	material_atend_paciente
		set	ie_auditoria	= 'A'
		where	nr_sequencia	= nr_sequencia_w;

		end;

	end loop;
	close c01;

	end;
end loop;
close c20;

-- Procedimentos
open	c21;
loop
fetch	c21 into
	cd_procedimento_w,
	ie_origem_proced_w,
	cd_setor_atend_w,
	dt_item_w,
	qt_item_w,
	vl_original_w;
EXIT WHEN NOT FOUND; /* apply on c21 */
	begin

	select	nextval('auditoria_externa_seq')
	into STRICT	nr_seq_item_w
	;

	insert	into auditoria_externa(NR_SEQUENCIA,
		DT_ATUALIZACAO,
		NM_USUARIO,
		DT_ATUALIZACAO_NREC,
		NM_USUARIO_NREC,
		IE_TIPO_ITEM,
		CD_ITEM,
		IE_ORIGEM_PROCED,
		IE_AGRUPAMENTO,
		DT_ITEM,
		QT_ORIGINAL,
		QT_AJUSTE,
		NR_SEQ_MOTIVO,
		NR_SEQ_AUDITORIA,
		CD_SETOR_ATENDIMENTO,
		vl_original)
	values (nr_seq_item_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		'P',
		cd_procedimento_w,
		ie_origem_proced_w,
		ie_opcao_geracao_p,
		dt_item_w,
		qt_item_w,
		null,
		null,
		nr_seq_auditoria_p,
		cd_setor_atend_w,
		vl_original_w);

	--Itens que estão sendo auditados (Procedimentos)
	open	c02;
	loop
	fetch	c02 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin

		select 	coalesce(max(vl_medico),0),
			coalesce(max(vl_custo_operacional),0),
			coalesce(max(vl_materiais),0),
			coalesce(max(vl_procedimento),0)
		into STRICT	vl_medico_orig_w,
			vl_custo_oper_orig_w,
			vl_mat_orig_w,
			vl_proc_orig_w
		from 	procedimento_paciente
		where 	nr_sequencia = nr_sequencia_w;

		insert into auditoria_externa_item(NR_SEQUENCIA,
			NR_SEQ_AUDIT_EXT,
			NR_SEQ_ITEM,
			IE_TIPO_ITEM,
			DT_ATUALIZACAO,
			NM_USUARIO,
			DT_ATUALIZACAO_NREC,
			NM_USUARIO_NREC,
			VL_MEDICO_ORIGINAL,
			VL_CUSTO_OPER_ORIGINAL,
			VL_MATERIAIS_ORIGINAL,
			VL_PROCEDIMENTO_ORIG)
		values (nextval('auditoria_externa_item_seq'),
			nr_seq_item_w,
			nr_sequencia_w,
			'P',
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			vl_medico_orig_w,
			vl_custo_oper_orig_w,
			vl_mat_orig_w,
			vl_proc_orig_w);

		update	procedimento_paciente
		set	ie_auditoria	= 'A'
		where	nr_sequencia	= nr_sequencia_w;

		end;
	end loop;
	close c02;

	end;
end loop;
close c21;



if (coalesce(nr_seq_regra_audit_p,0) = 0) then

	ds_filtros_auditoria_w	:='dt_periodo_inicial='||to_Char(dt_periodo_inicial_p,'dd/mm/yyyy hh24:mi:ss')||';'||
			'dt_periodo_final='||to_char(dt_periodo_final_p,'dd/mm/yyyy hh24:mi:ss')||';'||
			'ie_tipo_data='||ie_tipo_data_p||';'||
			'cd_setor_atendimento='||cd_setor_atendimento_p||';'||
			'nr_prescricao='||nr_prescricao_p||';'||
			'ie_nao_auditados='||ie_nao_auditados_p||';'||
			'ie_proc_mat='||ie_proc_mat_p||';'||
			'cd_area_proc='||cd_area_proc_p||';'||
			'cd_especialidade='||cd_especialidade_p||';'||
			'cd_grupo_proc='||cd_grupo_proc_p||';'||
			'cd_grupo_mat='||cd_grupo_mat_p||';'||
			'cd_subgrupo='||cd_subgrupo_p||';'||
			'cd_classe='||cd_classe_p ||';'||
			'cd_setor_atendimento='||cd_setor_atendimento_p;

	update	auditoria_conta_paciente
	set	dt_periodo_inicial = dt_periodo_inicial_p,
		dt_periodo_final = dt_periodo_final_p,
		ds_filtros = ds_filtros_auditoria_w,
		vl_auditoria_orig = obter_valor_auditoria(nr_seq_auditoria_p, nr_interno_conta_p),
		cd_setor_atendimento = cd_setor_atendimento_p,
		nr_seq_regra_audit = nr_seq_regra_audit_p,
		ie_agrupamento = ie_opcao_geracao_p
	where	nr_sequencia = nr_seq_auditoria_p;

else

	ds_filtros_auditoria_w	:='dt_periodo_inicial='||to_Char(dt_periodo_inicial_p,'dd/mm/yyyy hh24:mi:ss')||';'||
			'dt_periodo_final='||to_char(dt_periodo_final_p,'dd/mm/yyyy hh24:mi:ss')||';'||
			'ie_tipo_data='||ie_tipo_data_w||';'||
			'cd_setor_atendimento='||cd_setor_atendimento_w||';'||
			'nr_prescricao='||nr_prescricao_p||';'||
			'ie_nao_auditados='||ie_nao_auditados_p||';'||
			'ie_proc_mat='||ie_tipo_item_w||';'||
			'cd_area_proc='||cd_area_procedimento_w||';'||
			'cd_especialidade='||cd_especialidade_w||';'||
			'cd_grupo_proc='||cd_grupo_proc_w||';'||
			'cd_grupo_mat='||cd_grupo_material_w||';'||
			'cd_subgrupo='||cd_subgrupo_material_w||';'||
			'cd_classe='||cd_classe_material_w ||';'||
			'cd_setor_atendimento='||cd_setor_atendimento_w;

	update	auditoria_conta_paciente
	set	dt_periodo_inicial = dt_periodo_inicial_p,
		dt_periodo_final = dt_periodo_final_p,
		ds_filtros = ds_filtros_auditoria_w,
		vl_auditoria_orig = obter_valor_auditoria(nr_seq_auditoria_p, nr_interno_conta_p),
		cd_setor_atendimento = cd_setor_atendimento_w,
		nr_seq_regra_audit = nr_seq_regra_audit_p,
		ie_agrupamento = ie_opcao_geracao_p
	where	nr_sequencia = nr_seq_auditoria_p;

end if;

ie_resumo_auditoria_w := coalesce(obter_valor_param_usuario(1116, 193, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento),'S');

if (ie_resumo_auditoria_w = 'S') then
	CALL Atualizar_Resumo_Auditoria(nr_seq_auditoria_p,'I',nm_usuario_p);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_auditoria_externa (nr_seq_auditoria_p bigint, nr_interno_conta_p bigint, dt_periodo_inicial_p timestamp, dt_periodo_final_p timestamp, ie_tipo_data_p bigint, cd_setor_atendimento_p bigint, nr_prescricao_p text, ie_nao_auditados_p text, ie_proc_mat_p text, cd_area_proc_p bigint, cd_especialidade_p bigint, cd_grupo_proc_p bigint, cd_grupo_mat_p bigint, cd_subgrupo_p bigint, cd_classe_p bigint, nm_usuario_p text, nr_seq_regra_audit_p bigint, nr_seq_regra_audit_ext_p bigint, ie_opcao_geracao_p text) FROM PUBLIC;

