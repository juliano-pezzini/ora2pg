-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inserir_contato_solic_resc ( nr_seq_solicitacao_p bigint, cd_pessoa_fisica_p text, ie_commit_p text, nm_usuario_p text) AS $body$
DECLARE


nr_ddi_celular_w		pessoa_fisica.nr_ddi_celular%type;
nr_ddd_celular_w		pessoa_fisica.nr_ddd_celular%type;
nr_telefone_celular_w		pessoa_fisica.nr_telefone_celular%type;
ds_email_w			compl_pessoa_fisica.ds_email%type		:= null;
cd_cep_w			compl_pessoa_fisica.cd_cep%type			:= null;
ds_endereco_w			compl_pessoa_fisica.ds_endereco%type		:= null;
nr_endereco_w			compl_pessoa_fisica.nr_endereco%type		:= null;
ds_complemento_w		compl_pessoa_fisica.ds_complemento%type		:= null;
ds_bairro_w			compl_pessoa_fisica.ds_bairro%type		:= null;
cd_municipio_ibge_w		compl_pessoa_fisica.cd_municipio_ibge%type	:= null;
sg_estado_w			compl_pessoa_fisica.sg_estado%type		:= null;
nr_ddi_telefone_w		compl_pessoa_fisica.nr_ddi_telefone%type	:= null;
nr_ddd_telefone_w		compl_pessoa_fisica.nr_ddd_telefone%type	:= null;
nr_telefone_w			compl_pessoa_fisica.nr_telefone%type		:= null;
nr_seq_tipo_contato_w		pls_tp_contato_solic_resc.nr_sequencia%type;
ie_forma_envio_w		pls_solic_resc_contato.ie_forma_envio%type;


BEGIN

select	max(nr_sequencia)
into STRICT	nr_seq_tipo_contato_w
from	pls_tp_contato_solic_resc
where	ie_padrao = 'S'
and	ie_situacao = 'A';

if (coalesce(nr_seq_tipo_contato_w::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(784905); --É necessário cadastrar um tipo de contato padrão
end if;

select	nr_ddi_celular,
	nr_ddd_celular,
	nr_telefone_celular
into STRICT	nr_ddi_celular_w,
	nr_ddd_celular_w,
	nr_telefone_celular_w
from	pessoa_fisica
where	cd_pessoa_fisica = cd_pessoa_fisica_p;

begin
select	trim(both ds_email) ds_email,
	cd_cep,
	ds_endereco,
	coalesce(nr_endereco, ds_compl_end) nr_endereco,
	ds_complemento,
	ds_bairro,
	cd_municipio_ibge,
	sg_estado,
	nr_ddi_telefone,
	nr_ddd_telefone,
	nr_telefone
into STRICT	ds_email_w,
	cd_cep_w,
	ds_endereco_w,
	nr_endereco_w,
	ds_complemento_w,
	ds_bairro_w,
	cd_municipio_ibge_w,
	sg_estado_w,
	nr_ddi_telefone_w,
	nr_ddd_telefone_w,
	nr_telefone_w
from	compl_pessoa_fisica
where	cd_pessoa_fisica = cd_pessoa_fisica_p
and	ie_tipo_complemento = 1;
exception
when others then
	null;
end;

if (ds_email_w IS NOT NULL AND ds_email_w::text <> '') and (length(ds_email_w) > 6) then --Tratamento para evitar considerar a forma de envio para e-mails inválidos
	ie_forma_envio_w	:= '1'; --E-mail
else
	ie_forma_envio_w	:= '2'; --Carta
end if;

insert	into	pls_solic_resc_contato(	nr_sequencia, nr_seq_solicitacao, cd_pessoa_fisica, nr_seq_tipo_contato,
		dt_atualizacao, dt_atualizacao_nrec, nm_usuario, nm_usuario_nrec,
		ds_email, cd_cep, ds_endereco, nr_endereco,
		ds_complemento, ds_bairro, cd_municipio_ibge, sg_estado,
		nr_ddi_celular, nr_ddd_celular, nr_telefone_celular,
		nr_ddi_telefone, nr_ddd_telefone, nr_telefone,
		ie_forma_envio)
	values (nextval('pls_solic_resc_contato_seq'), nr_seq_solicitacao_p, cd_pessoa_fisica_p, nr_seq_tipo_contato_w,
		clock_timestamp(), clock_timestamp(), nm_usuario_p, nm_usuario_p,
		ds_email_w, cd_cep_w, ds_endereco_w, nr_endereco_w,
		ds_complemento_w, ds_bairro_w, cd_municipio_ibge_w, sg_estado_w,
		nr_ddi_celular_w, nr_ddd_celular_w, nr_telefone_celular_w,
		nr_ddi_telefone_w, nr_ddd_telefone_w, nr_telefone_w,
		ie_forma_envio_w);

if (ie_commit_p = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inserir_contato_solic_resc ( nr_seq_solicitacao_p bigint, cd_pessoa_fisica_p text, ie_commit_p text, nm_usuario_p text) FROM PUBLIC;

