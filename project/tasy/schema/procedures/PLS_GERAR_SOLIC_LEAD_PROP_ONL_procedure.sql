-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_solic_lead_prop_onl ( nr_seq_prop_onl_p pls_proposta_online.nr_sequencia%type, nm_usuario_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


nr_seq_prop_benef_onl_w	pls_proposta_benef_online.nr_sequencia%type;
cd_cep_w		pls_proposta_benef_online.cd_cep%type;
cd_municipio_ibge_w	pls_proposta_benef_online.cd_municipio_ibge%type;
ds_bairro_w		pls_proposta_benef_online.ds_bairro%type;
ds_complemento_w	pls_proposta_benef_online.ds_complemento%type;
ds_email_w		pls_proposta_benef_online.ds_email%type;
ds_endereco_w		pls_proposta_benef_online.ds_endereco%type;
dt_nascimento_w		pls_proposta_benef_online.dt_nascimento%type;
nm_pessoa_fisica_w	pls_proposta_benef_online.nm_pessoa_fisica%type;
nr_cpf_w		pls_proposta_benef_online.nr_cpf%type;
nr_ddd_celular_w	pls_proposta_benef_online.nr_ddd_celular%type;
nr_ddi_telefone_w	pls_proposta_benef_online.nr_ddi_telefone%type;
nr_ddi_celular_w	pls_proposta_benef_online.nr_ddi_celular%type;
nr_endereco_w		pls_proposta_benef_online.nr_endereco%type;
nr_identidade_w		pls_proposta_benef_online.nr_identidade%type;
nr_telefone_w		pls_proposta_benef_online.nr_telefone%type;
nr_telefone_celular_w	pls_proposta_benef_online.nr_telefone_celular%type;
sg_estado_w		pls_proposta_benef_online.sg_estado%type;
nr_seq_solicitacao_w	pls_solicitacao_comercial.nr_sequencia%type;

C01 CURSOR FOR
	SELECT	nm_pessoa_fisica,
		dt_nascimento,
		obter_idade(dt_nascimento,clock_timestamp(),'A') qt_idade,
		nr_seq_parentesco
	from	pls_proposta_benef_online
	where	nr_seq_prop_online = nr_seq_prop_onl_p
	and	ie_tipo_benef = 'D';

BEGIN

select	max(nr_sequencia)
into STRICT	nr_seq_prop_benef_onl_w
from	pls_proposta_benef_online
where	nr_seq_prop_online = nr_seq_prop_onl_p
and	ie_tipo_benef = 'T';

if (nr_seq_prop_benef_onl_w IS NOT NULL AND nr_seq_prop_benef_onl_w::text <> '') then
	
	select	cd_cep,
		cd_municipio_ibge,
		ds_bairro,
		ds_complemento,
		ds_email,
		ds_endereco,
		dt_nascimento,
		nm_pessoa_fisica,
		nr_cpf,
		nr_ddd_celular,
		nr_ddi_telefone,
		nr_ddi_celular,
		nr_endereco,
		nr_identidade,
		nr_telefone,
		nr_telefone_celular,
		sg_estado
	into STRICT	cd_cep_w,
		cd_municipio_ibge_w,
		ds_bairro_w,
		ds_complemento_w,
		ds_email_w,
		ds_endereco_w,
		dt_nascimento_w,
		nm_pessoa_fisica_w,
		nr_cpf_w,
		nr_ddd_celular_w,
		nr_ddi_telefone_w,
		nr_ddi_celular_w,
		nr_endereco_w,
		nr_identidade_w,
		nr_telefone_w,
		nr_telefone_celular_w,
		sg_estado_w
	from	pls_proposta_benef_online
	where	nr_sequencia = nr_seq_prop_benef_onl_w;
	
	insert into pls_solicitacao_comercial(nr_sequencia, cd_estabelecimento, ie_status,
		nm_pessoa_fisica, dt_atualizacao, nm_usuario,
		dt_solicitacao, nr_cpf, nm_usuario_nrec,
		dt_atualizacao_nrec, cd_cep, nr_ddi,
		ds_bairro, cd_municipio_ibge,ds_complemento,
		ds_email, ds_endereco, dt_nascimento,
		nr_ddd_celular, nr_ddi_celular, nr_endereco,
		nr_identidade, nr_telefone, nr_celular, 
		sg_uf_municipio, nr_seq_proposta_online, ie_origem_solicitacao)
	values (nextval('pls_solicitacao_comercial_seq'), cd_estabelecimento_p, 'PE',
		nm_pessoa_fisica_w, clock_timestamp(), nm_usuario_p,
		clock_timestamp(), nr_cpf_w, nm_usuario_p,
		clock_timestamp(), cd_cep_w, nr_ddi_telefone_w, 
		ds_bairro_w, cd_municipio_ibge_w, ds_complemento_w,
		ds_email_w, ds_endereco_w, dt_nascimento_w,
		nr_ddd_celular_w, nr_ddi_celular_w, nr_endereco_w, 
		nr_identidade_w, nr_telefone_w, nr_telefone_celular_w,
		sg_estado_w, nr_seq_prop_onl_p, 'P')
		returning nr_sequencia into nr_seq_solicitacao_w;
	
	for r_c01_w in C01 loop
		begin
		insert	into	pls_solicitacao_dependente(	nr_sequencia, nr_seq_solicitacao_lead, dt_atualizacao,
				nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
				nm_pessoa, dt_nascimento, qt_idade,
				nr_seq_parentesco )
			values (	nextval('pls_solicitacao_dependente_seq'), nr_seq_solicitacao_w, clock_timestamp(),
				nm_usuario_p, clock_timestamp(), nm_usuario_p,
				r_c01_w.nm_pessoa_fisica, r_c01_w.dt_nascimento, r_c01_w.qt_idade,
				r_c01_w.nr_seq_parentesco);
		end;
	end loop;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_solic_lead_prop_onl ( nr_seq_prop_onl_p pls_proposta_online.nr_sequencia%type, nm_usuario_p text, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

