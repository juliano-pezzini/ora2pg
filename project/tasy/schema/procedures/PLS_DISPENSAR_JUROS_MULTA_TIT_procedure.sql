-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_dispensar_juros_multa_tit (nr_titulo_p bigint, vl_juros_p bigint, vl_multa_p bigint, nm_usuario_p text) AS $body$
DECLARE

cd_moeda_w		integer;
nr_seq_titulo_w		bigint;


BEGIN
if (nr_titulo_p IS NOT NULL AND nr_titulo_p::text <> '') and (vl_juros_p IS NOT NULL AND vl_juros_p::text <> '') or (vl_multa_p IS NOT NULL AND vl_multa_p::text <> '') then
	if (obter_juros_multa_titulo(nr_titulo_p,clock_timestamp(),'R','J') < abs(vl_juros_p)) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(237469, 'VL_JUROS=' || campo_mascara_virgula(abs(vl_juros_p)));
	end if;
	if (obter_juros_multa_titulo(nr_titulo_p,clock_timestamp(),'R','M') < abs(vl_multa_p)) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(237468, 'VL_MULTA=' || campo_mascara_virgula(abs(vl_multa_p)));
	end if;

	select 	max(cd_moeda_padrao)
	into STRICT	cd_moeda_w
	from 	parametro_contas_receber;

	if (vl_juros_p > 0) then
		select	coalesce(max(nr_sequencia),0) + 1
		into STRICT	nr_seq_titulo_w
		from	titulo_juros_multa
		where	nr_titulo	= nr_titulo_p;

		insert	into titulo_juros_multa(nr_sequencia,
			nr_titulo,
			cd_moeda,
			cd_motivo,
			ie_juros_multa,
			ie_acao,
			vl_movimento,
			dt_movimento,
			dt_atualizacao,
			nm_usuario)
		values (nr_seq_titulo_w,
			nr_titulo_p,
			cd_moeda_w,
			4,
			'J',
			'I',
			abs(vl_juros_p),
			clock_timestamp(),
			clock_timestamp(),
			nm_usuario_p);
	end if;

	if (vl_multa_p > 0) then
		select	coalesce(max(nr_sequencia),0) + 1
		into STRICT	nr_seq_titulo_w
		from	titulo_juros_multa
		where	nr_titulo	= nr_titulo_p;

		insert	into titulo_juros_multa(nr_sequencia,
			nr_titulo,
			cd_moeda,
			cd_motivo,
			ie_juros_multa,
			ie_acao,
			vl_movimento,
			dt_movimento,
			dt_atualizacao,
			nm_usuario)
		values (nr_seq_titulo_w,
			nr_titulo_p,
			cd_moeda_w,
			5,
			'M',
			'I',
			abs(vl_multa_p),
			clock_timestamp(),
			clock_timestamp(),
			nm_usuario_p);
	end if;

	commit;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_dispensar_juros_multa_tit (nr_titulo_p bigint, vl_juros_p bigint, vl_multa_p bigint, nm_usuario_p text) FROM PUBLIC;

