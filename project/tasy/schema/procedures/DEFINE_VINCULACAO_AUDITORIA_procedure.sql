-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE define_vinculacao_auditoria (nr_seq_auditoria_p bigint, nr_seq_audit_vinc_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
nr_seq_pend_w		bigint;
dt_inicio_estagio_w	timestamp;
nr_seq_pendencia_w	bigint;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	cta_pendencia
	where	nr_seq_auditoria = nr_seq_auditoria_p;

C02 CURSOR FOR
	SELECT	nr_sequencia
	from	cta_pendencia_hist
	where	nr_seq_pend = nr_seq_pend_w
	and 	coalesce(dt_final_estagio::text, '') = '';


BEGIN

update	auditoria_conta_paciente
set 	nr_seq_audit_vinc = nr_seq_audit_vinc_p
where 	nr_sequencia = nr_seq_auditoria_p;

select 	max(nr_sequencia)
into STRICT	nr_seq_pendencia_w
from 	cta_pendencia
where 	nr_seq_auditoria = nr_seq_audit_vinc_p;

select 	coalesce(max(dt_inicio_estagio),clock_timestamp())
into STRICT	dt_inicio_estagio_w
from 	cta_pendencia_hist
where 	nr_seq_pend = nr_seq_pendencia_w;

open C01;
loop
fetch C01 into
	nr_seq_pend_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	open C02;
	loop
	fetch C02 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		update	cta_pendencia_hist
		set 	dt_final_estagio = dt_inicio_estagio_w,
			qt_horas_estagio = trunc((dt_inicio_estagio_w - dt_inicio_estagio) * 24),
			ie_tipo_meta = Obter_Tipo_Meta_Estagio(nr_seq_estagio, 0, trunc((dt_inicio_estagio_w - dt_inicio_estagio) * 24))
		where 	nr_sequencia = nr_sequencia_w;

		end;
	end loop;
	close C02;

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE define_vinculacao_auditoria (nr_seq_auditoria_p bigint, nr_seq_audit_vinc_p bigint, nm_usuario_p text) FROM PUBLIC;

