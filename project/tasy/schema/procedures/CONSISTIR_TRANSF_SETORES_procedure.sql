-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_transf_setores ( cd_setor_origem_p bigint, cd_setor_destino_p bigint, cd_estabelecimento_p bigint, nr_atendimento_p bigint, ds_retorno_p INOUT text) AS $body$
DECLARE


ds_mensagem_w	varchar(255);
nr_seq_regra_w regra_transferencia_setor.nr_sequencia%type;
ds_setor_origem_w	varchar(40);
ds_setor_destino_w	varchar(40);
cd_convenio_w		integer;
ds_mensagem_bloqueio_w regra_transferencia_setor.ds_mensagem_bloqueio%type;


BEGIN

if (coalesce(cd_setor_origem_p,0) > 0) and (coalesce(cd_setor_destino_p,0) > 0) then


	select	coalesce(max(cd_convenio),0)
	into STRICT	cd_convenio_w
	from	atend_categoria_convenio
	where	nr_atendimento	= nr_atendimento_p
	and	nr_seq_interno  = obter_atecaco_atendimento(nr_atendimento_p);


	select	max(nr_Sequencia)
	into STRICT	nr_seq_regra_w
	from	regra_transferencia_setor
	where	coalesce(cd_setor_origem,cd_setor_origem_p)	 = cd_setor_origem_p
	and		coalesce(cd_setor_destino,cd_setor_destino_p) = cd_setor_destino_p
	and		coalesce(cd_convenio,cd_convenio_w)		 = cd_convenio_w
	and 	cd_estabelecimento			 = cd_estabelecimento_p
	and		coalesce(ie_permite_transferencia,'S') = 'N'
	and 	ie_situacao = 'A';

	if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then
		select max(ds_mensagem_bloqueio)
		into STRICT 	ds_mensagem_bloqueio_w
		from 	regra_transferencia_setor
		where nr_Sequencia = nr_seq_regra_w;

		select	substr(obter_nome_setor(cd_setor_origem_p),1,40)
		into STRICT	ds_setor_origem_w
		;

		select	substr(obter_nome_setor(cd_setor_destino_p),1,40)
		into STRICT	ds_setor_destino_w
		;


		ds_retorno_p	:=  coalesce(ds_mensagem_bloqueio_w, wheb_mensagem_pck.get_texto(403171, 'DS_SETOR_ORIGEM_W=' || ds_setor_origem_w || ';DS_SETOR_DESTINO_W=' || ds_setor_destino_w));


	end if;
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_transf_setores ( cd_setor_origem_p bigint, cd_setor_destino_p bigint, cd_estabelecimento_p bigint, nr_atendimento_p bigint, ds_retorno_p INOUT text) FROM PUBLIC;

