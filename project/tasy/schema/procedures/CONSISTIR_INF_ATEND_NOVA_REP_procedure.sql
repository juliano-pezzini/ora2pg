-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_inf_atend_nova_rep ( ie_prescr_setor_p text, ie_setores_usuario_p text, nm_maquina_atual_p text, ie_calcular_validade_p text, ie_estender_p text, ie_regra_prim_prescr_p text, ie_prescr_sem_diag_p text, ie_consiste_internacao_sus_p text, cd_medico_p text, ie_consistir_setor_p text, cd_setor_atendimento_p bigint, nr_prescricao_p bigint, nr_atendimento_p bigint, nr_seq_transcricao_p bigint, dt_prescricao_p timestamp, nr_prescr_transf_p INOUT bigint, ds_mensagem_p INOUT text, nr_horas_validade_p INOUT bigint, cd_setor_atend_p INOUT bigint, dt_prim_horario_p INOUT timestamp, ie_tipo_convenio_p INOUT text, cd_perfil_p bigint, nm_usuario_p text, cd_prescritor_p bigint) AS $body$
DECLARE


cd_setor_atendimento_w			setor_atendimento.cd_setor_atendimento%type;
ie_existe_setor_w				char(1);
ds_mensagem_w					varchar(2000);
ds_msg_retorno_w				varchar(2000);
ie_permite_lib_w				varchar(1);
dt_prim_horario_w				timestamp;
nr_horas_validade_w				bigint;
ie_tipo_convenio_w				convenio.ie_tipo_convenio%type;
nr_prescr_transf_w				prescr_medica.nr_prescricao%type;
nr_atendimento_mae_w			atendimento_paciente.nr_atendimento%type;
ie_usa_setor_mae_w				char(1) := 'N';
qt_setor_exibe_rn_w				integer;
cd_convenio_w					convenio.cd_convenio%type;
cd_setor_atendimento_mae_w		setor_atendimento.cd_setor_atendimento%type;
cd_setor_atendimento_filho_w	setor_atendimento.cd_setor_atendimento%type;

BEGIN
if (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin		
	select 	coalesce(max(nr_atendimento_mae),0)
	into STRICT	nr_atendimento_mae_w
	from 	atendimento_paciente
	where	nr_atendimento = nr_atendimento_p;

	if (nr_atendimento_mae_w > 0) then
		select	count(cd_setor_atendimento)
		into STRICT	qt_setor_exibe_rn_w
		from	setor_atendimento
		where	ie_rn_mae = 'S'
		and		cd_estabelecimento = obter_estabelecimento_ativo;
	end if;

	if (qt_setor_exibe_rn_w > 0) then
		cd_setor_atendimento_w := coalesce(obter_unidade_atendimento(nr_atendimento_mae_w,'IA','CS'),obter_unidade_atendimento(nr_atendimento_mae_w,'A','CS'));
		select	coalesce(max(ie_rn_mae),'N')
		into STRICT	ie_usa_setor_mae_w
		from	setor_atendimento
		where	cd_setor_atendimento = cd_setor_atendimento_w;
	end if;
	
	if (ie_usa_setor_mae_w = 'N') then
		if (ie_prescr_setor_p = 'C') then
			select	max(cd_setor_atendimento)
			into STRICT	cd_setor_atendimento_w
			from	computador
			where	nm_computador_pesquisa  = padronizar_nome(upper(nm_maquina_atual_p));
		elsif (ie_prescr_setor_p = 'R') then
			cd_setor_atendimento_w := (obter_setor_prescr_regra(cd_perfil_p))::numeric;
		elsif (ie_prescr_setor_p = 'U') and (ie_setores_usuario_p = 'S') then
			cd_setor_atendimento_w	:= cd_setor_atendimento_p;
		elsif (ie_prescr_setor_p = 'U') and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_atendimento_P > 0) then
			begin
			select	coalesce(max('S'),'N')
			into STRICT	ie_existe_setor_w
			from	setor_atendimento a,
					atend_paciente_unidade b where		a.cd_setor_atendimento	= b.cd_setor_atendimento
			and		b.nr_atendimento	= nr_atendimento_p
			and		b.cd_setor_atendimento	= cd_setor_atendimento_p LIMIT 1;

			if (ie_existe_setor_w = 'S') then
				cd_setor_atendimento_w	:= cd_setor_atendimento_p;
			end if;
			end;
		elsif (ie_prescr_setor_p = 'A') and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_atendimento_P > 0) then
				
			cd_setor_atendimento_w	:= coalesce(obter_unidade_atendimento(nr_atendimento_p,'A','CS'), obter_unidade_atendimento(nr_atendimento_p,'IA','CS'));
			
		elsif (nr_atendimento_p > 0) and (ie_prescr_setor_p <> 'B') then
				cd_setor_atendimento_w	:= coalesce(obter_unidade_atendimento(nr_atendimento_p,'IA','CS'), obter_unidade_atendimento(nr_atendimento_p,'A','CS'));
		end if;
	elsif (ie_prescr_setor_p = 'A') or (ie_prescr_setor_p = 'P') then
			begin
			if (nr_atendimento_mae_w > 0) then
				select	coalesce(max(a.cd_setor_atendimento),0)
				into STRICT	cd_setor_atendimento_w
				from	setor_atendimento a
				where	a.cd_setor_atendimento = obter_unidade_atendimento(nr_atendimento_mae_w,'A','CS')
				and 	a.ie_rn_mae = 'S';
				
				if (coalesce(cd_setor_atendimento_w::text, '') = '') then
					cd_setor_atendimento_w	:= coalesce(obter_unidade_atendimento(nr_atendimento_p,'IA','CS'), obter_unidade_atendimento(nr_atendimento_p,'A','CS'));
				end if;
			elsif (ie_prescr_setor_p = 'A') then
				cd_setor_atendimento_w := obter_unidade_atendimento(nr_atendimento_p,'A','CS');	
			end if;		
			end;
	elsif (ie_prescr_setor_p = 'D') then
			begin
				if (nr_atendimento_mae_w > 0) then
					
					select	coalesce(max(cd_setor_atendimento),0)
					into STRICT 	cd_setor_atendimento_mae_w
					from 	setor_atendimento
					where 	cd_setor_atendimento = obter_unidade_atendimento(nr_atendimento_mae_w,'A','CS')
					and 	ie_rn_mae = 'S';
						
					select	coalesce(max(a.cd_setor_atendimento),0)
					into STRICT 	cd_setor_atendimento_filho_w
					from 	unidade_atendimento a
					where 	a.nr_seq_interno = (SELECT coalesce(max(b.nr_seq_unidade_rn),0) 
												from setor_atendimento b
												where b.cd_setor_atendimento = obter_unidade_atendimento(nr_atendimento_p, 'A', 'CS'));
											
					if (cd_setor_atendimento_mae_w > 0 AND cd_setor_atendimento_mae_w = cd_setor_atendimento_filho_w) then
						cd_setor_atendimento_w := cd_setor_atendimento_mae_w;
					end if;	
				end if;
				
				if (((coalesce(cd_setor_atendimento_mae_w::text, '') = '') or (cd_setor_atendimento_mae_w = 0)) and (nr_atendimento_p > 0)) then
					cd_setor_atendimento_w := obter_unidade_atendimento(nr_atendimento_p,'A','CS');
				end if;
			end;	
	elsif (nr_atendimento_p > 0) and (ie_prescr_setor_p <> 'B') then
			cd_setor_atendimento_w	:= coalesce(obter_unidade_atendimento(nr_atendimento_p,'IA','CS'), obter_unidade_atendimento(nr_atendimento_p,'A','CS'));

	end if;

	dt_prim_horario_w	:= obter_prim_horario_prescricao(nr_atendimento_p,cd_setor_atendimento_w,dt_prescricao_p,nm_usuario_p,'R');

	if (ie_calcular_validade_p = 'S') then
		nr_horas_validade_w	:= obter_horas_validade_prescr(dt_prim_horario_w,nr_atendimento_p,ie_estender_p,ie_regra_prim_prescr_p,dt_prescricao_p,nr_prescricao_p);
	end if;

	if (ie_prescr_sem_diag_p <> 'S') and (nr_atendimento_p > 0) then
		begin
		if (obter_qt_diag_atend(nr_atendimento_p) = 0) and
			((ie_prescr_sem_diag_p = 'N') or
			 ((ie_prescr_sem_diag_p = 'T') and (Obter_medico_resp_atend(nr_atendimento_p,'C') = cd_prescritor_p))) then
			-- Não é permitido fazer nova prescrição para paciente sem diagnóstico. Parâmetro [90] da REP.
			CALL wheb_mensagem_pck.exibir_mensagem_abort(57259);
		end if;
		end;
	end if;

	ie_tipo_convenio_w	:= obter_tipo_convenio(obter_convenio_atendimento(nr_atendimento_p));
	cd_convenio_w	:=  obter_convenio_atendimento(nr_atendimento_p);

	if (ie_consiste_internacao_sus_p <> 'N') and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
		begin

		if (ie_tipo_convenio_w = 3) then
			begin
			SELECT * FROM sus_consiste_internacao(nr_atendimento_p, ds_mensagem_w, ie_permite_lib_w) INTO STRICT ds_mensagem_w, ie_permite_lib_w;
			if (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') then
				begin
				if (ie_permite_lib_w = 'S') or
					((ie_consiste_internacao_sus_p = 'S') or (ie_consiste_internacao_sus_p = 'T')) then
					ds_msg_retorno_w := ds_mensagem_w;
				else
					-- #@DS_MENSAGEM#@Não é permitido definir a previsão de alta para antes da data da prescrição!
					CALL wheb_mensagem_pck.exibir_mensagem_abort(57319,'DS_MENSAGEM='||ds_mensagem_w);
				end if;
				end;
			end if;
			end;
		end if;
		end;
	end if;

	if (nr_seq_transcricao_p > 0) then
		begin
		select	coalesce(max(nr_prescricao),0)
		into STRICT	nr_prescr_transf_w
		from	prescr_medica
		where	nr_seq_transcricao	= nr_seq_transcricao_p;
		end;
	end if;

	if (ie_consistir_setor_p = 'S') then
		CALL obter_se_med_lib_conv_setor(cd_medico_p, cd_convenio_w, cd_setor_atendimento_p);
	end if;
	end;
end if;

commit;
dt_prim_horario_p	:= dt_prim_horario_w;
nr_horas_validade_p	:= nr_horas_validade_w;
cd_setor_atend_p	:= cd_setor_atendimento_w;
ds_mensagem_p		:= ds_msg_retorno_w;
nr_prescr_transf_p	:= nr_prescr_transf_w;
ie_tipo_convenio_p	:= ie_tipo_convenio_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_inf_atend_nova_rep ( ie_prescr_setor_p text, ie_setores_usuario_p text, nm_maquina_atual_p text, ie_calcular_validade_p text, ie_estender_p text, ie_regra_prim_prescr_p text, ie_prescr_sem_diag_p text, ie_consiste_internacao_sus_p text, cd_medico_p text, ie_consistir_setor_p text, cd_setor_atendimento_p bigint, nr_prescricao_p bigint, nr_atendimento_p bigint, nr_seq_transcricao_p bigint, dt_prescricao_p timestamp, nr_prescr_transf_p INOUT bigint, ds_mensagem_p INOUT text, nr_horas_validade_p INOUT bigint, cd_setor_atend_p INOUT bigint, dt_prim_horario_p INOUT timestamp, ie_tipo_convenio_p INOUT text, cd_perfil_p bigint, nm_usuario_p text, cd_prescritor_p bigint) FROM PUBLIC;

