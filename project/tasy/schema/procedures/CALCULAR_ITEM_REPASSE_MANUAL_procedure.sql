-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_item_repasse_manual ( nr_repasse_terceiro_p bigint, nm_usuario_p text ) AS $body$
DECLARE


cd_estabelecimento_w		bigint;
nr_seq_trans_fin_prov_w		bigint;
nr_seq_terceiro_w		bigint;
nr_seq_regra_w			bigint;
dt_repasse_w			timestamp;
nr_seq_trans_financ_w		bigint;
cd_convenio_w			bigint;
pr_calcular_w			double precision;
vl_repasse_w			double precision;
vl_item_w			double precision;
nr_seq_item_w			bigint;
ie_tipo_convenio_w		bigint;
cd_banco_w			integer;
ie_positivo_w			varchar(01);
ie_limpa_item_w			varchar(01);
ds_titulo_w			varchar(255);
ie_item_repasse_auto_w		varchar(255);
cont_w				smallint;
cd_condicao_pagamento_w		bigint;
vl_fixo_w			double precision;
ie_repasse_neg_w		varchar(1);
cd_area_procedimento_w		bigint;
cd_classe_material_w		integer;
cd_especialidade_w		bigint;
cd_grupo_material_w		smallint;
cd_grupo_proc_w			bigint;
cd_material_w			bigint;
cd_procedimento_w		bigint;
cd_subgrupo_material_w		smallint;
ie_origem_proced_w		bigint;
vl_repasse_item_w		double precision;
ie_tipo_conv_proc_w		smallint;
ie_tipo_conv_mat_w		smallint;
ie_data_contabil_w		varchar(2);
ie_partic_tributo_w		repasse_terceiro_item.ie_partic_tributo%type;
dt_mesano_referencia_w		timestamp;
dt_contabil_w			timestamp := null;
ie_regra_calculo_w		varchar(1);
cd_medico_w			varchar(10);
ds_item_w			varchar(4000);
vl_procmat_w			double precision;
ds_obs_w			varchar(4000);
cd_medico_item_w		varchar(10);
cd_medico_regra_w		varchar(10);
nr_seq_terc_regra_w		terceiro.nr_sequencia%type;
nr_seq_tipo_w			bigint;
qt_maximo_w			regra_calc_item_rep_trans.qt_maximo%type;
qt_minimo_w			regra_calc_item_rep_trans.qt_minimo%type;
qt_producao_w			bigint;
nr_seq_grupo_w			bigint;
nr_seq_subgrupo_w		bigint;
--Variaveis para controle quando marcado o Checkbox Obriga geracao.
ie_obriga_geracao_w		regra_calc_item_repasse.ie_obriga_geracao%type;
vl_total_repasse_w		repasse_terceiro_item.vl_repasse%type;
nr_sequencia_w			repasse_terceiro_item.nr_sequencia%type;
ie_participa_piso_w     repasse_terceiro_item.ie_participa_piso%type;

C01 CURSOR FOR
SELECT	nr_sequencia,
	ie_limpa_item,
	ds_titulo,
	coalesce(ie_repasse_neg,'S'),
	coalesce(ie_data_contabil,'N'),
	a.nr_seq_terceiro,
	coalesce(ie_partic_tributo,'S'),
	coalesce(ie_obriga_geracao,'N')
from	regra_calc_item_repasse a
where (coalesce(ie_mensal,'N') = 'N' or
	not exists (SELECT	1
	from	repasse_terceiro y,
		repasse_terceiro_item x
	where	pkg_date_utils.start_of(y.dt_mesano_referencia,'MONTH',0) = pkg_date_utils.start_of(dt_mesano_referencia_w,'MONTH',0)
	and	y.nr_seq_terceiro	= nr_seq_terceiro_w
	and	x.nr_repasse_terceiro	= y.nr_repasse_terceiro
	and	x.nr_seq_regra		= a.nr_sequencia))
and	cd_estabelecimento				= cd_estabelecimento_w
and	dt_inicio_vigencia				<= dt_repasse_w
and	coalesce(dt_fim_vigencia, dt_repasse_w)		>= dt_repasse_w
and	coalesce(cd_banco, coalesce(cd_banco_w,0))		= coalesce(cd_banco_w,0)
and	coalesce(nr_seq_terceiro, nr_seq_terceiro_w)		= nr_seq_terceiro_w
and	coalesce(ie_tipo_convenio, coalesce(ie_tipo_convenio_w,0))	= coalesce(ie_tipo_convenio_w,0)
and	coalesce(ie_gerar_acao_usuario,'N')			= 'S'
and	exists (	select	1
		from	regra_calc_item_rep_trans x
		where	x.nr_seq_regra	= a.nr_sequencia
		and	x.cd_medico	= cd_medico_regra_w)
/*and	a.nr_seq_terceiro is null
	or exists(	select	1
		from	terceiro x
		where	x.nr_sequencia	= a.nr_seq_terceiro
		and	x.cd_pessoa_fisica	= cd_medico_regra_w
		union	all
		select	1
		from	terceiro y,
			terceiro_pessoa_fisica x
		where	x.nr_seq_terceiro	= y.nr_sequencia
		and	y.nr_sequencia		= a.nr_seq_terceiro
		and	x.cd_pessoa_fisica	= cd_medico_regra_w))*/
and	coalesce(a.ie_situacao,'A') = 'A'
order by	coalesce(cd_banco,0),
	coalesce(nr_seq_terceiro,0),
	coalesce(ie_tipo_convenio, 0);

C02 CURSOR FOR
SELECT	nr_seq_trans_financ,
	pr_calcular,
	ie_positivo,
	0 vl_fixo,
	nr_seq_trans_financ_prov,
	a.cd_area_procedimento,
	a.cd_classe_material,
	a.cd_especialidade,
	a.cd_grupo_material,
	a.cd_grupo_proc,
	a.cd_material,
	a.cd_procedimento,
	a.cd_subgrupo_material,
	a.ie_origem_proced,
	a.ie_tipo_conv_proc,
	a.ie_tipo_conv_mat,
	a.ie_regra_calculo,
	a.cd_medico,
	a.nr_seq_tipo,
	a.qt_minimo,
	a.qt_maximo,
	a.nr_seq_grupo,
	a.nr_seq_subgrupo,
  coalesce(a.ie_participa_piso,'S')
from	regra_calc_item_rep_trans a
where	nr_seq_regra		= nr_seq_regra_w
and	coalesce(pr_calcular,0)	<> 0

union

SELECT	nr_seq_trans_financ,
	0 pr_calcular,
	ie_positivo,
	vl_fixo,
	nr_seq_trans_financ_prov,
	a.cd_area_procedimento,
	a.cd_classe_material,
	a.cd_especialidade,
	a.cd_grupo_material,
	a.cd_grupo_proc,
	a.cd_material,
	a.cd_procedimento,
	a.cd_subgrupo_material,
	a.ie_origem_proced,
	a.ie_tipo_conv_proc,
	a.ie_tipo_conv_mat,
	a.ie_regra_calculo,
	a.cd_medico,
	a.nr_seq_tipo,
	a.qt_minimo,
	a.qt_maximo,
	a.nr_seq_grupo,
	a.nr_seq_subgrupo,
  coalesce(a.ie_participa_piso,'S')
from	regra_calc_item_rep_trans a
where	nr_seq_regra		= nr_seq_regra_w
and	coalesce(vl_fixo,0)		<> 0;

C03 CURSOR FOR
SELECT	a.vl_liberado,
	substr(obter_desc_procedimento(b.cd_procedimento,b.ie_origem_proced),1,255) ds_item,
	a.cd_medico
FROM estrutura_procedimento_v c, procedimento_paciente b
LEFT OUTER JOIN convenio d ON (b.cd_convenio = d.cd_convenio)
, procedimento_repasse a
LEFT OUTER JOIN proc_criterio_repasse e ON (a.nr_seq_criterio = e.nr_sequencia)
WHERE a.nr_repasse_terceiro	= nr_repasse_terceiro_p and a.nr_seq_procedimento	= b.nr_sequencia  and coalesce(e.ie_rep_auto,'S')	= 'S' and (coalesce(cd_procedimento_w::text, '') = ''
	or b.cd_procedimento 	= cd_procedimento_w) and (coalesce(ie_origem_proced_w::text, '') = ''
	or c.ie_origem_proced	= ie_origem_proced_w) and b.cd_procedimento	=	c.cd_procedimento and b.ie_origem_proced	= c.ie_origem_proced and (coalesce(cd_area_procedimento_w::text, '') = ''
	or c.cd_area_procedimento	= cd_area_procedimento_w) and (coalesce(cd_especialidade_w::text, '') = ''
	or c.cd_especialidade	= cd_especialidade_w) and (coalesce(cd_grupo_proc_w::text, '') = ''
	or c.cd_grupo_proc	= cd_grupo_proc_w)  and coalesce(a.cd_medico,'0')	= coalesce(coalesce(cd_medico_w,a.cd_medico),'0') and d.ie_tipo_convenio		= coalesce(ie_tipo_conv_proc_w,d.ie_tipo_convenio)

union all

SELECT	a.vl_liberado,
	substr(obter_desc_material(b.cd_material),1,255) ds_item,
	a.cd_medico
FROM estrutura_material_v c, material_atend_paciente b
LEFT OUTER JOIN convenio d ON (b.cd_convenio = d.cd_convenio)
, material_repasse a
LEFT OUTER JOIN mat_criterio_repasse e ON (a.nr_seq_criterio = e.nr_sequencia)
WHERE a.nr_repasse_terceiro	= nr_repasse_terceiro_p and a.nr_seq_material		= b.nr_sequencia  and coalesce(e.ie_rep_auto,'S')	= 'S' and (coalesce(cd_material_w::text, '') = ''
	or b.cd_material		= cd_material_w) and b.cd_material		= c.cd_material and (coalesce(cd_classe_material_w::text, '') = ''
	or c.cd_classe_material	= cd_classe_material_w) and (coalesce(cd_grupo_material_w::text, '') = ''
	or c.cd_grupo_material	= cd_grupo_material_w) and (coalesce(cd_subgrupo_material_w::text, '') = ''
	or c.cd_subgrupo_material	= cd_subgrupo_material_w)  and coalesce(a.cd_medico,'0')		= coalesce(coalesce(cd_medico_w,a.cd_medico),'0') and d.ie_tipo_convenio		= coalesce(ie_tipo_conv_mat_w,d.ie_tipo_convenio);

c04 CURSOR FOR
SELECT	distinct
	a.cd_medico
from	procedimento_repasse a
where	a.nr_repasse_terceiro	= nr_repasse_terceiro_p

union
	
SELECT	distinct
	a.cd_medico
from	material_repasse a
where	a.nr_repasse_terceiro	= nr_repasse_terceiro_p;

c05 CURSOR FOR
SELECT	nr_sequencia,
	ie_limpa_item,
	ds_titulo,
	coalesce(ie_repasse_neg,'S'),
	coalesce(ie_data_contabil,'N'),
	a.nr_seq_terceiro,
	coalesce(ie_partic_tributo,'S'),
	coalesce(ie_obriga_geracao,'N')
from	regra_calc_item_repasse a
where (coalesce(ie_mensal,'N') = 'N' or
	not exists (SELECT	1
	from	repasse_terceiro y,
		repasse_terceiro_item x
	where	pkg_date_utils.start_of(y.dt_mesano_referencia,'MONTH',0) = pkg_date_utils.start_of(dt_mesano_referencia_w,'MONTH',0)
	and	y.nr_seq_terceiro	= nr_seq_terceiro_w
	and	x.nr_repasse_terceiro	= y.nr_repasse_terceiro
	and	x.nr_seq_regra		= a.nr_sequencia))
and	cd_estabelecimento				= cd_estabelecimento_w
and	dt_inicio_vigencia				<= dt_repasse_w
and	coalesce(dt_fim_vigencia, dt_repasse_w)		>= dt_repasse_w
and	coalesce(cd_banco, coalesce(cd_banco_w,0))		= coalesce(cd_banco_w,0)
and	coalesce(nr_seq_terceiro, nr_seq_terceiro_w)		= nr_seq_terceiro_w
and	coalesce(ie_tipo_convenio, coalesce(ie_tipo_convenio_w,0))	= coalesce(ie_tipo_convenio_w,0)
and	coalesce(ie_gerar_acao_usuario,'N')			= 'S'
and	exists (	select	1
		from	regra_calc_item_rep_trans x
		where	x.nr_seq_regra	= a.nr_sequencia
		and	coalesce(x.cd_medico::text, '') = '')
and	coalesce(a.ie_situacao,'A') = 'A'
order by	coalesce(cd_banco,0),
	coalesce(nr_seq_terceiro,0),
	coalesce(ie_tipo_convenio, 0);

BEGIN

dt_repasse_w		:= clock_timestamp();
cd_medico_w		:= '';

select	cd_estabelecimento,
	nr_seq_terceiro,
	cd_condicao_pagamento,
	cd_convenio,
	coalesce(IE_ITEM_REPASSE_AUTO, 'S'),
	dt_mesano_referencia,
	ie_tipo_convenio
into STRICT	cd_estabelecimento_w,
	nr_seq_terceiro_w,
	cd_condicao_pagamento_w,
	cd_convenio_w,
	IE_ITEM_REPASSE_AUTO_w,
	dt_mesano_referencia_w,
	ie_tipo_convenio_w
from	repasse_terceiro
where	nr_repasse_terceiro		= nr_repasse_terceiro_p;

if (coalesce(ie_tipo_convenio_w,0) = 0) then
	
	select	coalesce(max(ie_tipo_convenio), 0)
	into STRICT	ie_tipo_convenio_w
	from	convenio
	where	cd_convenio	= cd_convenio_w;
	
	if (coalesce(ie_tipo_convenio_w,0) = 0) then
		select	coalesce(max(ie_tipo_convenio), 0)
		into STRICT	ie_tipo_convenio_w
		from	REPASSE_TERCEIRO_REGRA
		where	nr_repasse_terceiro	= nr_repasse_terceiro_p
		and	(ie_tipo_convenio IS NOT NULL AND ie_tipo_convenio::text <> '');
	end if;	
end if;

select	max(nr_sequencia_item)
into STRICT	nr_seq_item_w
from	repasse_terceiro_item
where	nr_repasse_terceiro		= nr_repasse_terceiro_p;

select	max(substr(obter_banco_repasse_pf_pj(a.cd_pessoa_fisica, a.cd_cgc),1,254))
into STRICT	cd_banco_w
from	terceiro a
where	nr_sequencia	= nr_seq_terceiro_w;

OPEN c04;
LOOP
FETCH c04 into
	cd_medico_regra_w;
EXIT WHEN NOT FOUND; /* apply on c04 */
	/*Cursor c01 Gera somente para as regras com medicos informados*/

	
	OPEN C01;
	LOOP
	FETCH C01 into
		nr_seq_regra_w,
		ie_limpa_item_w,
		ds_titulo_w,
		ie_repasse_neg_w,
		ie_data_contabil_w,
		nr_seq_terc_regra_w,
		ie_partic_tributo_w,
		ie_obriga_geracao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		
		nr_seq_regra_w	:= nr_seq_regra_w;
		
		if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') and (IE_ITEM_REPASSE_AUTO_w = 'S') then
			/*if	(ie_limpa_item_w = 'S') then
				delete	from repasse_terceiro_item
				where	nr_repasse_terceiro	= nr_repasse_terceiro_p
				and	nr_seq_regra		is not null;
			end if;*/
			
			if (ie_obriga_geracao_w = 'S') then
				vl_total_repasse_w := obter_valor_repasse(nr_repasse_terceiro_p,'R');
			end if;
			
			select	coalesce(max(nr_sequencia_item),0)
			into STRICT	nr_seq_item_w
			from	repasse_terceiro_item
			where	nr_repasse_terceiro		= nr_repasse_terceiro_p;
			
			cd_medico_w		:= '';			
			
			OPEN C02;
			LOOP
			FETCH C02 into
				nr_seq_trans_financ_w,
				pr_calcular_w,
				ie_positivo_w,
				vl_fixo_w,
				nr_seq_trans_fin_prov_w,
				cd_area_procedimento_w,
				cd_classe_material_w,
				cd_especialidade_w,
				cd_grupo_material_w,
				cd_grupo_proc_w,
				cd_material_w,
				cd_procedimento_w,
				cd_subgrupo_material_w,
				ie_origem_proced_w,
				ie_tipo_conv_proc_w,
				ie_tipo_conv_mat_w,
				ie_regra_calculo_w,
				cd_medico_w,
				nr_seq_tipo_w,
				qt_minimo_w,
				qt_maximo_w,
				nr_seq_grupo_w,
				nr_seq_subgrupo_w,
        ie_participa_piso_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
					vl_repasse_item_w	:= 0;
					nr_seq_item_w		:= nr_seq_item_w + 1;

					vl_item_w		:= 0;
					
					if (coalesce(pr_calcular_w,0) <> 0) then
						
						if (coalesce(ie_regra_calculo_w,'S') = 'S') then
						
							select	coalesce(sum(vl_liberado),0),
								count(vl_liberado)
							into STRICT	vl_repasse_w,
								qt_producao_w
							from	(SELECT	a.vl_liberado
								FROM estrutura_procedimento_v c, procedimento_paciente b
LEFT OUTER JOIN convenio d ON (b.cd_convenio = d.cd_convenio)
, procedimento_repasse a
LEFT OUTER JOIN proc_criterio_repasse e ON (a.nr_seq_criterio = e.nr_sequencia)
WHERE a.nr_repasse_terceiro	= nr_repasse_terceiro_p and a.nr_seq_procedimento	= b.nr_sequencia  and coalesce(e.ie_rep_auto,'S')	= 'S' and (coalesce(cd_procedimento_w::text, '') = ''
									 or b.cd_procedimento 	= cd_procedimento_w) and (coalesce(ie_origem_proced_w::text, '') = ''
									or c.ie_origem_proced	= ie_origem_proced_w) and b.cd_procedimento	=	c.cd_procedimento and b.ie_origem_proced	= c.ie_origem_proced and (coalesce(cd_area_procedimento_w::text, '') = ''
									 or c.cd_area_procedimento	= cd_area_procedimento_w) and (coalesce(cd_especialidade_w::text, '') = ''
									 or c.cd_especialidade	= cd_especialidade_w) and (coalesce(cd_grupo_proc_w::text, '') = ''
									 or c.cd_grupo_proc	= cd_grupo_proc_w)  and coalesce(a.cd_medico,'0')	= coalesce(coalesce(cd_medico_w,a.cd_medico),'0') and d.ie_tipo_convenio		= coalesce(ie_tipo_conv_proc_w,d.ie_tipo_convenio) and (coalesce(nr_seq_grupo_w::text, '') = ''
									or nr_seq_grupo_w	= (	select	c.nr_seq_grupo
												from	sus_procedimento a,
													sus_forma_organizacao b,
													sus_subgrupo c
												where	b.nr_seq_subgrupo	= c.nr_sequencia
												and	a.nr_seq_forma_org	= b.nr_sequencia
												and	a.cd_procedimento	= c.cd_procedimento
												and	a.ie_origem_proced	= c.ie_origem_proced  LIMIT 1)) and (coalesce(nr_seq_subgrupo_w::text, '') = ''
									or nr_seq_subgrupo_w	= (	select	b.nr_seq_subgrupo
													from	sus_procedimento a,
														sus_forma_organizacao b,
														sus_subgrupo c
													where	b.nr_seq_subgrupo	= c.nr_sequencia
													and	a.nr_seq_forma_org	= b.nr_sequencia
													and	a.cd_procedimento	= c.cd_procedimento
													and	a.ie_origem_proced	= c.ie_origem_proced  LIMIT 1))
								
union all

								SELECT	a.vl_liberado
								FROM estrutura_material_v c, material_atend_paciente b
LEFT OUTER JOIN convenio d ON (b.cd_convenio = d.cd_convenio)
, material_repasse a
LEFT OUTER JOIN mat_criterio_repasse e ON (a.nr_seq_criterio = e.nr_sequencia)
WHERE a.nr_repasse_terceiro	= nr_repasse_terceiro_p and a.nr_seq_material		= b.nr_sequencia  and coalesce(e.ie_rep_auto,'S')	= 'S' and (coalesce(cd_material_w::text, '') = ''
									 or b.cd_material		= cd_material_w) and b.cd_material		= c.cd_material and (coalesce(cd_classe_material_w::text, '') = ''
									 or c.cd_classe_material	= cd_classe_material_w) and (coalesce(cd_grupo_material_w::text, '') = ''
									 or c.cd_grupo_material	= cd_grupo_material_w) and (coalesce(cd_subgrupo_material_w::text, '') = ''
									 or c.cd_subgrupo_material	= cd_subgrupo_material_w)  and coalesce(a.cd_medico,'0')	= coalesce(coalesce(cd_medico_w,a.cd_medico),'0') and d.ie_tipo_convenio		= coalesce(ie_tipo_conv_mat_w,d.ie_tipo_convenio) ) alias41;

							/* ahoffelder - OS 233373 - 02/08/2010 - so buscar o valor do item se nenhum
								material ou procedimento tiver sido informado na regra */

							/*if	(cd_area_procedimento_w is null) and (cd_classe_material_w is null) and
								(cd_especialidade_w is null) and (cd_grupo_material_w is null) and
								(cd_grupo_proc_w is null) and (cd_material_w is null) and
								(cd_procedimento_w is null) and (cd_subgrupo_material_w is null) then

								select	nvl(sum(a.vl_repasse),0)
								into	vl_repasse_item_w
								from	regra_esp_repasse b,
									repasse_terceiro_item a
								where	a.nr_seq_regra_esp	= b.nr_sequencia(+)
								and	nvl(b.ie_rep_auto,'S')	= 'S'
								and	a.nr_repasse_terceiro	= nr_repasse_terceiro_p
								and	nvl(nvl(cd_medico,cd_medico_w),'0')	= nvl(cd_medico_w,'0')
								and	(ie_repasse_neg_w		= 'S'
									 or a.vl_repasse		> 0);
							end if;*/
							
						elsif (coalesce(ie_regra_calculo_w,'S') = 'M') then
						
							select	coalesce(sum(vl_desconto),0)/coalesce(sum(qt_desconto),1),
								count(vl_desconto)
							into STRICT	vl_repasse_w,
								qt_producao_w
							from	(	SELECT	b.vl_procedimento vl_desconto,
									b.qt_procedimento qt_desconto
								FROM estrutura_procedimento_v c, procedimento_paciente b
LEFT OUTER JOIN convenio d ON (b.cd_convenio = d.cd_convenio)
, procedimento_repasse a
LEFT OUTER JOIN proc_criterio_repasse e ON (a.nr_seq_criterio = e.nr_sequencia)
WHERE a.nr_repasse_terceiro	= nr_repasse_terceiro_p and a.nr_seq_procedimento	= b.nr_sequencia  and coalesce(e.ie_rep_auto,'S')	= 'S' and (coalesce(cd_procedimento_w::text, '') = ''
									 or b.cd_procedimento 	= cd_procedimento_w) and (coalesce(ie_origem_proced_w::text, '') = ''
									or c.ie_origem_proced	= ie_origem_proced_w) and b.cd_procedimento	=	c.cd_procedimento and b.ie_origem_proced	= c.ie_origem_proced and (coalesce(cd_area_procedimento_w::text, '') = ''
									 or c.cd_area_procedimento	= cd_area_procedimento_w) and (coalesce(cd_especialidade_w::text, '') = ''
									 or c.cd_especialidade	= cd_especialidade_w) and (coalesce(cd_grupo_proc_w::text, '') = ''
									 or c.cd_grupo_proc	= cd_grupo_proc_w)  and coalesce(a.cd_medico,'0')		= coalesce(coalesce(cd_medico_w,a.cd_medico),'0') and d.ie_tipo_convenio		= coalesce(ie_tipo_conv_proc_w,d.ie_tipo_convenio) and (coalesce(nr_seq_grupo_w::text, '') = ''
									or nr_seq_grupo_w	= (	select	c.nr_seq_grupo
													from	sus_procedimento a,
														sus_forma_organizacao b,
														sus_subgrupo c
													where	b.nr_seq_subgrupo	= c.nr_sequencia
													and	a.nr_seq_forma_org	= b.nr_sequencia
													and	a.cd_procedimento	= c.cd_procedimento
													and	a.ie_origem_proced	= c.ie_origem_proced  LIMIT 1)) and (coalesce(nr_seq_subgrupo_w::text, '') = ''
									or nr_seq_subgrupo_w	= (	select	b.nr_seq_subgrupo
													from	sus_procedimento a,
														sus_forma_organizacao b,
														sus_subgrupo c
													where	b.nr_seq_subgrupo	= c.nr_sequencia
													and	a.nr_seq_forma_org	= b.nr_sequencia
													and	a.cd_procedimento	= c.cd_procedimento
													and	a.ie_origem_proced	= c.ie_origem_proced  LIMIT 1))
								
union all

								SELECT	b.vl_material,
									b.qt_material
								FROM estrutura_material_v c, material_atend_paciente b
LEFT OUTER JOIN convenio d ON (b.cd_convenio = d.cd_convenio)
, material_repasse a
LEFT OUTER JOIN mat_criterio_repasse e ON (a.nr_seq_criterio = e.nr_sequencia)
WHERE a.nr_repasse_terceiro	= nr_repasse_terceiro_p and a.nr_seq_material		= b.nr_sequencia  and coalesce(e.ie_rep_auto,'S')	= 'S' and (coalesce(cd_material_w::text, '') = ''
									 or b.cd_material		= cd_material_w) and b.cd_material		= c.cd_material and (coalesce(cd_classe_material_w::text, '') = ''
									 or c.cd_classe_material	= cd_classe_material_w) and (coalesce(cd_grupo_material_w::text, '') = ''
									 or c.cd_grupo_material	= cd_grupo_material_w) and (coalesce(cd_subgrupo_material_w::text, '') = ''
									 or c.cd_subgrupo_material	= cd_subgrupo_material_w)  and coalesce(a.cd_medico,'0')		= coalesce(coalesce(cd_medico_w,a.cd_medico),'0') and d.ie_tipo_convenio		= coalesce(ie_tipo_conv_mat_w,d.ie_tipo_convenio) ) alias41;
						end if;
						
						if (ie_obriga_geracao_w = 'S') then
							vl_item_w	:= (coalesce(vl_total_repasse_w,0) * coalesce(pr_calcular_w,0)) / 100;
						else
							vl_item_w	:= ((coalesce(vl_repasse_w,0) + coalesce(vl_repasse_item_w,0)) * coalesce(pr_calcular_w,0)) / 100;
						end if;	
					
					elsif (coalesce(vl_fixo_w,0) <> 0) then
						vl_item_w	:= vl_fixo_w;
					end if;
					
					if (ie_positivo_w = 'N') and (vl_item_w > 0) then
						vl_item_w	:= vl_item_w * -1;
					end if;
					/*if	(cd_medico_regra_w = '72222') then	
						r.aise_application_error(-20011,' vl_item_w= '||vl_item_w||' vl_repasse_w= '||vl_repasse_w||' vl_repasse_item_w= '||vl_repasse_item_w||' pr_calcular_w= '||pr_calcular_w);
					end if;*/
					if (ie_data_contabil_w = 'R') then
						dt_contabil_w	:= dt_mesano_referencia_w;
					end if;
					
					if (coalesce(ie_regra_calculo_w,'S') = 'U') then
						if (coalesce(qt_minimo_w,0)	<> 0) and (coalesce(qt_maximo_w,0)	<> 0) then
							select	count(*)
							into STRICT	qt_producao_w
							from	(SELECT	1
								FROM estrutura_procedimento_v c, procedimento_paciente b
LEFT OUTER JOIN convenio d ON (b.cd_convenio = d.cd_convenio)
, procedimento_repasse a
LEFT OUTER JOIN proc_criterio_repasse e ON (a.nr_seq_criterio = e.nr_sequencia)
WHERE a.nr_repasse_terceiro	= nr_repasse_terceiro_p and a.nr_seq_procedimento	= b.nr_sequencia  and coalesce(e.ie_rep_auto,'S')	= 'S' and (coalesce(cd_procedimento_w::text, '') = ''
									or b.cd_procedimento 	= cd_procedimento_w) and (coalesce(ie_origem_proced_w::text, '') = ''
									or c.ie_origem_proced	= ie_origem_proced_w) and b.cd_procedimento	=	c.cd_procedimento and b.ie_origem_proced	= c.ie_origem_proced and (coalesce(cd_area_procedimento_w::text, '') = ''
									or c.cd_area_procedimento	= cd_area_procedimento_w) and (coalesce(cd_especialidade_w::text, '') = ''
									or c.cd_especialidade	= cd_especialidade_w) and (coalesce(cd_grupo_proc_w::text, '') = ''
									or c.cd_grupo_proc	= cd_grupo_proc_w)  and coalesce(a.cd_medico,'0')	= coalesce(coalesce(cd_medico_w,a.cd_medico),'0') and d.ie_tipo_convenio		= coalesce(ie_tipo_conv_proc_w,d.ie_tipo_convenio) and (coalesce(nr_seq_grupo_w::text, '') = ''
									or nr_seq_grupo_w	= (	select	c.nr_seq_grupo
													from	sus_procedimento a,
														sus_forma_organizacao b,
														sus_subgrupo c
													where	b.nr_seq_subgrupo	= c.nr_sequencia
													and	a.nr_seq_forma_org	= b.nr_sequencia
													and	a.cd_procedimento	= c.cd_procedimento
													and	a.ie_origem_proced	= c.ie_origem_proced  LIMIT 1)) and (coalesce(nr_seq_subgrupo_w::text, '') = ''
									or nr_seq_subgrupo_w	= (	select	b.nr_seq_subgrupo
													from	sus_procedimento a,
														sus_forma_organizacao b,
														sus_subgrupo c
													where	b.nr_seq_subgrupo	= c.nr_sequencia
													and	a.nr_seq_forma_org	= b.nr_sequencia
													and	a.cd_procedimento	= c.cd_procedimento
													and	a.ie_origem_proced	= c.ie_origem_proced  LIMIT 1))
								
union all

								SELECT	1
								FROM estrutura_material_v c, material_atend_paciente b
LEFT OUTER JOIN convenio d ON (b.cd_convenio = d.cd_convenio)
, material_repasse a
LEFT OUTER JOIN mat_criterio_repasse e ON (a.nr_seq_criterio = e.nr_sequencia)
WHERE a.nr_repasse_terceiro	= nr_repasse_terceiro_p and a.nr_seq_material		= b.nr_sequencia  and coalesce(e.ie_rep_auto,'S')	= 'S' and (coalesce(cd_material_w::text, '') = ''
									or b.cd_material		= cd_material_w) and b.cd_material		= c.cd_material and (coalesce(cd_classe_material_w::text, '') = ''
									or c.cd_classe_material	= cd_classe_material_w) and (coalesce(cd_grupo_material_w::text, '') = ''
									or c.cd_grupo_material	= cd_grupo_material_w) and (coalesce(cd_subgrupo_material_w::text, '') = ''
									or c.cd_subgrupo_material	= cd_subgrupo_material_w)  and coalesce(a.cd_medico,'0')		= coalesce(coalesce(cd_medico_w,a.cd_medico),'0') and d.ie_tipo_convenio		= coalesce(ie_tipo_conv_mat_w,d.ie_tipo_convenio) ) alias41;
						end if;
						
						OPEN C03;
						LOOP
						FETCH C03 into
							vl_procmat_w,
							ds_item_w,
							cd_medico_item_w;
						EXIT WHEN NOT FOUND; /* apply on C03 */
							ds_obs_w	:= '';	
							if (coalesce(pr_calcular_w,0) <> 0) then
								vl_item_w	:= coalesce(vl_procmat_w,0) * coalesce(pr_calcular_w,0) / 100;
							elsif (coalesce(vl_fixo_w,0) <> 0) then
								vl_item_w	:= vl_fixo_w;
							end if;
							
							if (ie_positivo_w = 'N') then
								vl_item_w	:= vl_item_w * -1;
							end if;
							
							ds_obs_w	:= ds_titulo_w;
							ds_obs_w	:= ds_obs_w||' - ' || OBTER_DESC_EXPRESSAO(606383) || ' '||ds_item_w;				-- 606383: 'Item:'
							
							if	((coalesce(qt_minimo_w,0)	= 0) and (coalesce(qt_maximo_w,0)	= 0)) or
								((coalesce(qt_producao_w,0)	>= coalesce(qt_minimo_w,0)) and (coalesce(qt_producao_w,0)	<= coalesce(qt_maximo_w,0))) then
								insert into repasse_terceiro_item(
									nr_repasse_terceiro,
									nr_sequencia_item,
									vl_repasse,
									dt_atualizacao,
									nm_usuario,
									ds_observacao,
									nr_seq_trans_fin,
									nr_seq_regra,
									dt_liberacao,
									nr_seq_terceiro,
									nr_sequencia,
									dt_lancamento,
									nr_seq_trans_fin_prov,
									ie_partic_tributo,
									dt_contabil,
									cd_medico,
									nr_seq_tipo,
									ie_participa_piso)
								values (
									nr_repasse_terceiro_p,
									nr_seq_item_w,
									vl_item_w,
									clock_timestamp(),
									nm_usuario_p,
									ds_obs_w,
									nr_seq_trans_financ_w,
									nr_seq_regra_w,
									clock_timestamp(),
									nr_seq_terceiro_w,
									nextval('repasse_terceiro_item_seq'),
									clock_timestamp(),
									nr_seq_trans_fin_prov_w,
									ie_partic_tributo_w,
									dt_contabil_w,
									coalesce(cd_medico_w,cd_medico_item_w),
									nr_seq_tipo_w,
									ie_participa_piso_w);
								nr_seq_item_w		:= nr_seq_item_w + 1;
							end if;	
						END LOOP;
						CLOSE C03;
					end if;
					if (coalesce(ie_regra_calculo_w,'S') <> 'U') then
						if	((coalesce(qt_minimo_w,0)	= 0) and (coalesce(qt_maximo_w,0)	= 0)) or
							((coalesce(qt_producao_w,0)	>= coalesce(qt_minimo_w,0)) and (coalesce(qt_producao_w,0)	<= coalesce(qt_maximo_w,0))) then
							
							select	nextval('repasse_terceiro_item_seq')
							into STRICT	nr_sequencia_w
							;
							
							insert into repasse_terceiro_item(
								nr_repasse_terceiro,
								nr_sequencia_item,
								vl_repasse,
								dt_atualizacao,
								nm_usuario,
								ds_observacao,
								nr_seq_trans_fin,
								nr_seq_regra,
								dt_liberacao,
								nr_seq_terceiro,
								nr_sequencia,
								dt_lancamento,
								nr_seq_trans_fin_prov,
								ie_partic_tributo,
								dt_contabil,
								cd_medico,
								nr_seq_tipo,
								ie_participa_piso)
							values (
								nr_repasse_terceiro_p,
								nr_seq_item_w,
								vl_item_w,
								clock_timestamp(),
								nm_usuario_p,
								ds_titulo_w,
								nr_seq_trans_financ_w,
								nr_seq_regra_w,
								clock_timestamp(),
								nr_seq_terceiro_w,
								nr_sequencia_w,
								clock_timestamp(),
								nr_seq_trans_fin_prov_w,
								ie_partic_tributo_w,
								dt_contabil_w,
								cd_medico_w,
								nr_seq_tipo_w,
								ie_participa_piso_w);
						end if;		
					end if;
			END LOOP;
			CLOSE C02;
		end if;
		end;
	END LOOP;
	CLOSE C01;
END LOOP;
CLOSE c04;

/*Cursor c05 gera somente para as regras sem medico informado*/

OPEN C05;
LOOP
FETCH C05 into
	nr_seq_regra_w,
	ie_limpa_item_w,
	ds_titulo_w,
	ie_repasse_neg_w,
	ie_data_contabil_w,
	nr_seq_terc_regra_w,
	ie_partic_tributo_w,
	ie_obriga_geracao_w;
EXIT WHEN NOT FOUND; /* apply on C05 */
	begin
	nr_seq_regra_w	:= nr_seq_regra_w;
	
	if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') and (IE_ITEM_REPASSE_AUTO_w = 'S') then
		/*if	(ie_limpa_item_w = 'S') then
			delete	from repasse_terceiro_item
			where	nr_repasse_terceiro	= nr_repasse_terceiro_p
			and	nr_seq_regra		is not null;
		end if;*/
		
		if (ie_obriga_geracao_w = 'S') then
			vl_total_repasse_w := obter_valor_repasse(nr_repasse_terceiro_p,'R');
		end if;
		
		select	coalesce(max(nr_sequencia_item),0)
		into STRICT	nr_seq_item_w
		from	repasse_terceiro_item
		where	nr_repasse_terceiro		= nr_repasse_terceiro_p;
		
		cd_medico_w		:= '';
		
		OPEN C02;
		LOOP
		FETCH C02 into
			nr_seq_trans_financ_w,
			pr_calcular_w,
			ie_positivo_w,
			vl_fixo_w,
			nr_seq_trans_fin_prov_w,
			cd_area_procedimento_w,
			cd_classe_material_w,
			cd_especialidade_w,
			cd_grupo_material_w,
			cd_grupo_proc_w,
			cd_material_w,
			cd_procedimento_w,
			cd_subgrupo_material_w,
			ie_origem_proced_w,
			ie_tipo_conv_proc_w,
			ie_tipo_conv_mat_w,
			ie_regra_calculo_w,
			cd_medico_w,
			nr_seq_tipo_w,
			qt_minimo_w,
			qt_maximo_w,
			nr_seq_grupo_w,
			nr_seq_subgrupo_w,
      ie_participa_piso_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
				vl_repasse_item_w	:= 0;
				nr_seq_item_w		:= nr_seq_item_w + 1;

				vl_item_w		:= 0;
				
				if (coalesce(pr_calcular_w,0) <> 0) then
					
					if (coalesce(ie_regra_calculo_w,'S') = 'S') then
					
						select	coalesce(sum(vl_liberado),0),
							count(vl_liberado)
						into STRICT	vl_repasse_w,
							qt_producao_w
						from	(SELECT	a.vl_liberado
							FROM estrutura_procedimento_v c, procedimento_paciente b
LEFT OUTER JOIN convenio d ON (b.cd_convenio = d.cd_convenio)
, procedimento_repasse a
LEFT OUTER JOIN proc_criterio_repasse e ON (a.nr_seq_criterio = e.nr_sequencia)
WHERE a.nr_repasse_terceiro	= nr_repasse_terceiro_p and a.nr_seq_procedimento	= b.nr_sequencia  and coalesce(e.ie_rep_auto,'S')	= 'S' and (coalesce(cd_procedimento_w::text, '') = ''
								 or b.cd_procedimento 	= cd_procedimento_w) and (coalesce(ie_origem_proced_w::text, '') = ''
								or c.ie_origem_proced	= ie_origem_proced_w) and b.cd_procedimento	=	c.cd_procedimento and b.ie_origem_proced	= c.ie_origem_proced and (coalesce(cd_area_procedimento_w::text, '') = ''
								 or c.cd_area_procedimento	= cd_area_procedimento_w) and (coalesce(cd_especialidade_w::text, '') = ''
								 or c.cd_especialidade	= cd_especialidade_w) and (coalesce(cd_grupo_proc_w::text, '') = ''
								 or c.cd_grupo_proc	= cd_grupo_proc_w)  and coalesce(a.cd_medico,'0')	= coalesce(coalesce(cd_medico_w,a.cd_medico),'0') and d.ie_tipo_convenio		= coalesce(ie_tipo_conv_proc_w,d.ie_tipo_convenio) and (coalesce(nr_seq_grupo_w::text, '') = ''
								or nr_seq_grupo_w	= (	select	c.nr_seq_grupo
												from	sus_procedimento a,
													sus_forma_organizacao b,
													sus_subgrupo c
												where	b.nr_seq_subgrupo	= c.nr_sequencia
												and	a.nr_seq_forma_org	= b.nr_sequencia
												and	a.cd_procedimento	= c.cd_procedimento
												and	a.ie_origem_proced	= c.ie_origem_proced  LIMIT 1)) and (coalesce(nr_seq_subgrupo_w::text, '') = ''
								or nr_seq_subgrupo_w	= (	select	b.nr_seq_subgrupo
												from	sus_procedimento a,
													sus_forma_organizacao b,
													sus_subgrupo c
												where	b.nr_seq_subgrupo	= c.nr_sequencia
												and	a.nr_seq_forma_org	= b.nr_sequencia
												and	a.cd_procedimento	= c.cd_procedimento
												and	a.ie_origem_proced	= c.ie_origem_proced  LIMIT 1))
							
union all

							SELECT	a.vl_liberado
							FROM estrutura_material_v c, material_atend_paciente b
LEFT OUTER JOIN convenio d ON (b.cd_convenio = d.cd_convenio)
, material_repasse a
LEFT OUTER JOIN mat_criterio_repasse e ON (a.nr_seq_criterio = e.nr_sequencia)
WHERE a.nr_repasse_terceiro	= nr_repasse_terceiro_p and a.nr_seq_material		= b.nr_sequencia  and coalesce(e.ie_rep_auto,'S')	= 'S' and (coalesce(cd_material_w::text, '') = ''
								 or b.cd_material		= cd_material_w) and b.cd_material		= c.cd_material and (coalesce(cd_classe_material_w::text, '') = ''
								 or c.cd_classe_material	= cd_classe_material_w) and (coalesce(cd_grupo_material_w::text, '') = ''
								 or c.cd_grupo_material	= cd_grupo_material_w) and (coalesce(cd_subgrupo_material_w::text, '') = ''
								 or c.cd_subgrupo_material	= cd_subgrupo_material_w)  and coalesce(a.cd_medico,'0')	= coalesce(coalesce(cd_medico_w,a.cd_medico),'0') and d.ie_tipo_convenio		= coalesce(ie_tipo_conv_mat_w,d.ie_tipo_convenio) ) alias41;

						/* ahoffelder - OS 233373 - 02/08/2010 - so buscar o valor do item se nenhum
							material ou procedimento tiver sido informado na regra */
						if (coalesce(cd_area_procedimento_w::text, '') = '') and (coalesce(cd_classe_material_w::text, '') = '') and (coalesce(cd_especialidade_w::text, '') = '') and (coalesce(cd_grupo_material_w::text, '') = '') and (coalesce(cd_grupo_proc_w::text, '') = '') and (coalesce(cd_material_w::text, '') = '') and (coalesce(cd_procedimento_w::text, '') = '') and (coalesce(cd_subgrupo_material_w::text, '') = '') then

							select	coalesce(sum(vl_repasse),0)
							into STRICT	vl_repasse_item_w
							from (SELECT	coalesce(sum(a.vl_repasse),0) vl_repasse
								FROM repasse_terceiro_item a
LEFT OUTER JOIN regra_esp_repasse b ON (a.nr_seq_regra_esp = b.nr_sequencia)
WHERE coalesce(b.ie_rep_auto,'S')	= 'S' and a.nr_repasse_terceiro	= nr_repasse_terceiro_p and coalesce(coalesce(cd_medico,cd_medico_w),'0')	= coalesce(cd_medico_w,'0') and ie_repasse_neg_w	= 'S' and coalesce(nr_seq_regra,0) <> nr_seq_regra_w
								
union	all

								PERFORM	coalesce(sum(a.vl_repasse),0) vl_repasse
								FROM repasse_terceiro_item a
LEFT OUTER JOIN regra_esp_repasse b ON (a.nr_seq_regra_esp = b.nr_sequencia)
WHERE coalesce(b.ie_rep_auto,'S')	= 'S' and a.nr_repasse_terceiro	= nr_repasse_terceiro_p and coalesce(coalesce(cd_medico,cd_medico_w),'0')	= coalesce(cd_medico_w,'0') and ie_repasse_neg_w	= 'N' and a.vl_repasse		> 0 and coalesce(nr_seq_regra,0) <> nr_seq_regra_w ) alias32;
								
						end if;
						
					elsif (coalesce(ie_regra_calculo_w,'S') = 'M') then
					
						select	coalesce(sum(vl_desconto),0)/coalesce(sum(qt_desconto),1),
							count(vl_desconto)
						into STRICT	vl_repasse_w,
							qt_producao_w
						from	(	SELECT	b.vl_procedimento vl_desconto,
								b.qt_procedimento qt_desconto
							FROM estrutura_procedimento_v c, procedimento_paciente b
LEFT OUTER JOIN convenio d ON (b.cd_convenio = d.cd_convenio)
, procedimento_repasse a
LEFT OUTER JOIN proc_criterio_repasse e ON (a.nr_seq_criterio = e.nr_sequencia)
WHERE a.nr_repasse_terceiro	= nr_repasse_terceiro_p and a.nr_seq_procedimento	= b.nr_sequencia  and coalesce(e.ie_rep_auto,'S')	= 'S' and (coalesce(cd_procedimento_w::text, '') = ''
								 or b.cd_procedimento 	= cd_procedimento_w) and (coalesce(ie_origem_proced_w::text, '') = ''
								or c.ie_origem_proced	= ie_origem_proced_w) and b.cd_procedimento	=	c.cd_procedimento and b.ie_origem_proced	= c.ie_origem_proced and (coalesce(cd_area_procedimento_w::text, '') = ''
								 or c.cd_area_procedimento	= cd_area_procedimento_w) and (coalesce(cd_especialidade_w::text, '') = ''
								 or c.cd_especialidade	= cd_especialidade_w) and (coalesce(cd_grupo_proc_w::text, '') = ''
								 or c.cd_grupo_proc	= cd_grupo_proc_w)  and coalesce(a.cd_medico,'0')		= coalesce(coalesce(cd_medico_w,a.cd_medico),'0') and d.ie_tipo_convenio		= coalesce(ie_tipo_conv_proc_w,d.ie_tipo_convenio) and (coalesce(nr_seq_grupo_w::text, '') = ''
								or nr_seq_grupo_w	= (	select	c.nr_seq_grupo
												from	sus_procedimento a,
													sus_forma_organizacao b,
													sus_subgrupo c
												where	b.nr_seq_subgrupo	= c.nr_sequencia
												and	a.nr_seq_forma_org	= b.nr_sequencia
												and	a.cd_procedimento	= c.cd_procedimento
												and	a.ie_origem_proced	= c.ie_origem_proced  LIMIT 1)) and (coalesce(nr_seq_subgrupo_w::text, '') = ''
								or nr_seq_subgrupo_w	= (	select	b.nr_seq_subgrupo
												from	sus_procedimento a,
													sus_forma_organizacao b,
													sus_subgrupo c
												where	b.nr_seq_subgrupo	= c.nr_sequencia
												and	a.nr_seq_forma_org	= b.nr_sequencia
												and	a.cd_procedimento	= c.cd_procedimento
												and	a.ie_origem_proced	= c.ie_origem_proced  LIMIT 1))
							
union all

							SELECT	b.vl_material,
								b.qt_material
							FROM estrutura_material_v c, material_atend_paciente b
LEFT OUTER JOIN convenio d ON (b.cd_convenio = d.cd_convenio)
, material_repasse a
LEFT OUTER JOIN mat_criterio_repasse e ON (a.nr_seq_criterio = e.nr_sequencia)
WHERE a.nr_repasse_terceiro	= nr_repasse_terceiro_p and a.nr_seq_material		= b.nr_sequencia  and coalesce(e.ie_rep_auto,'S')	= 'S' and (coalesce(cd_material_w::text, '') = ''
								 or b.cd_material		= cd_material_w) and b.cd_material		= c.cd_material and (coalesce(cd_classe_material_w::text, '') = ''
								 or c.cd_classe_material	= cd_classe_material_w) and (coalesce(cd_grupo_material_w::text, '') = ''
								 or c.cd_grupo_material	= cd_grupo_material_w) and (coalesce(cd_subgrupo_material_w::text, '') = ''
								 or c.cd_subgrupo_material	= cd_subgrupo_material_w)  and coalesce(a.cd_medico,'0')		= coalesce(coalesce(cd_medico_w,a.cd_medico),'0') and d.ie_tipo_convenio		= coalesce(ie_tipo_conv_mat_w,d.ie_tipo_convenio) ) alias41;
					end if;
				
					if (ie_obriga_geracao_w = 'S') then
						vl_item_w	:= (coalesce(vl_total_repasse_w,0) * coalesce(pr_calcular_w,0)) / 100;
					else	
						vl_item_w	:= ((coalesce(vl_repasse_w,0) + coalesce(vl_repasse_item_w,0)) * coalesce(pr_calcular_w,0)) / 100;
					end if;	
				
				elsif (coalesce(vl_fixo_w,0) <> 0) then
					vl_item_w	:= vl_fixo_w;
				end if;
				
				if (ie_positivo_w = 'N') then
					vl_item_w	:= vl_item_w * -1;
				end if;
				/*if	(cd_medico_regra_w = '72222') then	
					r.aise_application_error(-20011,' vl_item_w= '||vl_item_w||' vl_repasse_w= '||vl_repasse_w||' vl_repasse_item_w= '||vl_repasse_item_w||' pr_calcular_w= '||pr_calcular_w);
				end if;*/
				if (ie_data_contabil_w = 'R') then
					dt_contabil_w	:= dt_mesano_referencia_w;
				end if;
				
				if (coalesce(ie_regra_calculo_w,'S') = 'U') then
					if (coalesce(qt_minimo_w,0)	<> 0) and (coalesce(qt_maximo_w,0)	<> 0) then
						select	count(*)
						into STRICT	qt_producao_w
						from	(SELECT	1
							FROM estrutura_procedimento_v c, procedimento_paciente b
LEFT OUTER JOIN convenio d ON (b.cd_convenio = d.cd_convenio)
, procedimento_repasse a
LEFT OUTER JOIN proc_criterio_repasse e ON (a.nr_seq_criterio = e.nr_sequencia)
WHERE a.nr_repasse_terceiro	= nr_repasse_terceiro_p and a.nr_seq_procedimento	= b.nr_sequencia  and coalesce(e.ie_rep_auto,'S')	= 'S' and (coalesce(cd_procedimento_w::text, '') = ''
								or b.cd_procedimento 	= cd_procedimento_w) and (coalesce(ie_origem_proced_w::text, '') = ''
								or c.ie_origem_proced	= ie_origem_proced_w) and b.cd_procedimento	=	c.cd_procedimento and b.ie_origem_proced	= c.ie_origem_proced and (coalesce(cd_area_procedimento_w::text, '') = ''
								or c.cd_area_procedimento	= cd_area_procedimento_w) and (coalesce(cd_especialidade_w::text, '') = ''
								or c.cd_especialidade	= cd_especialidade_w) and (coalesce(cd_grupo_proc_w::text, '') = ''
								or c.cd_grupo_proc	= cd_grupo_proc_w)  and coalesce(a.cd_medico,'0')	= coalesce(coalesce(cd_medico_w,a.cd_medico),'0') and d.ie_tipo_convenio		= coalesce(ie_tipo_conv_proc_w,d.ie_tipo_convenio) and (coalesce(nr_seq_grupo_w::text, '') = ''
								or nr_seq_grupo_w	= (	select	c.nr_seq_grupo
												from	sus_procedimento a,
													sus_forma_organizacao b,
													sus_subgrupo c
												where	b.nr_seq_subgrupo	= c.nr_sequencia
												and	a.nr_seq_forma_org	= b.nr_sequencia
												and	a.cd_procedimento	= c.cd_procedimento
												and	a.ie_origem_proced	= c.ie_origem_proced  LIMIT 1)) and (coalesce(nr_seq_subgrupo_w::text, '') = ''
								or nr_seq_subgrupo_w	= (	select	b.nr_seq_subgrupo
												from	sus_procedimento a,
													sus_forma_organizacao b,
													sus_subgrupo c
												where	b.nr_seq_subgrupo	= c.nr_sequencia
												and	a.nr_seq_forma_org	= b.nr_sequencia
												and	a.cd_procedimento	= c.cd_procedimento
												and	a.ie_origem_proced	= c.ie_origem_proced  LIMIT 1))
							 
union all

							SELECT	1
							FROM estrutura_material_v c, material_atend_paciente b
LEFT OUTER JOIN convenio d ON (b.cd_convenio = d.cd_convenio)
, material_repasse a
LEFT OUTER JOIN mat_criterio_repasse e ON (a.nr_seq_criterio = e.nr_sequencia)
WHERE a.nr_repasse_terceiro	= nr_repasse_terceiro_p and a.nr_seq_material		= b.nr_sequencia  and coalesce(e.ie_rep_auto,'S')	= 'S' and (coalesce(cd_material_w::text, '') = ''
								or b.cd_material		= cd_material_w) and b.cd_material		= c.cd_material and (coalesce(cd_classe_material_w::text, '') = ''
								or c.cd_classe_material	= cd_classe_material_w) and (coalesce(cd_grupo_material_w::text, '') = ''
								or c.cd_grupo_material	= cd_grupo_material_w) and (coalesce(cd_subgrupo_material_w::text, '') = ''
								or c.cd_subgrupo_material	= cd_subgrupo_material_w)  and coalesce(a.cd_medico,'0')		= coalesce(coalesce(cd_medico_w,a.cd_medico),'0') and d.ie_tipo_convenio		= coalesce(ie_tipo_conv_mat_w,d.ie_tipo_convenio) ) alias41;
					end if;
					
					OPEN C03;
					LOOP
					FETCH C03 into
						vl_procmat_w,
						ds_item_w,
						cd_medico_item_w;
					EXIT WHEN NOT FOUND; /* apply on C03 */
						ds_obs_w	:= '';	
						if (coalesce(pr_calcular_w,0) <> 0) then
							vl_item_w	:= coalesce(vl_procmat_w,0) * coalesce(pr_calcular_w,0) / 100;
						elsif (coalesce(vl_fixo_w,0) <> 0) then
							vl_item_w	:= vl_fixo_w;
						end if;
						
						if (ie_positivo_w = 'N') and (vl_item_w > 0) then
							vl_item_w	:= vl_item_w * -1;
						end if;
						
						ds_obs_w	:= ds_titulo_w;
						ds_obs_w	:= ds_obs_w||' - ' || OBTER_DESC_EXPRESSAO(606383) || ' '||ds_item_w;				-- 606383: 'Item:'
						
						if	((coalesce(qt_minimo_w,0)	= 0) and (coalesce(qt_maximo_w,0)	= 0)) or
							((coalesce(qt_producao_w,0)	>= coalesce(qt_minimo_w,0)) and (coalesce(qt_producao_w,0)	<= coalesce(qt_maximo_w,0))) then
							insert into repasse_terceiro_item(
								nr_repasse_terceiro,
								nr_sequencia_item,
								vl_repasse,
								dt_atualizacao,
								nm_usuario,
								ds_observacao,
								nr_seq_trans_fin,
								nr_seq_regra,
								dt_liberacao,
								nr_seq_terceiro,
								nr_sequencia,
								dt_lancamento,
								nr_seq_trans_fin_prov,
								ie_partic_tributo,
								dt_contabil,
								cd_medico,
								nr_seq_tipo,
								ie_participa_piso)
							values (
								nr_repasse_terceiro_p,
								nr_seq_item_w,
								vl_item_w,
								clock_timestamp(),
								nm_usuario_p,
								ds_obs_w,
								nr_seq_trans_financ_w,
								nr_seq_regra_w,
								clock_timestamp(),
								nr_seq_terceiro_w,
								nextval('repasse_terceiro_item_seq'),
								clock_timestamp(),
								nr_seq_trans_fin_prov_w,
								ie_partic_tributo_w,
								dt_contabil_w,
								coalesce(cd_medico_w,cd_medico_item_w),
								nr_seq_tipo_w,
								ie_participa_piso_w);
								
							nr_seq_item_w		:= nr_seq_item_w + 1;
						end if;	
					END LOOP;
					CLOSE C03;
				end if;
				
				if (coalesce(ie_regra_calculo_w,'S') <> 'U') then
					if	((coalesce(qt_minimo_w,0)	= 0) and (coalesce(qt_maximo_w,0)	= 0)) or
						((coalesce(qt_producao_w,0)	>= coalesce(qt_minimo_w,0)) and (coalesce(qt_producao_w,0)	<= coalesce(qt_maximo_w,0))) then
						
						select	nextval('repasse_terceiro_item_seq')
						into STRICT	nr_sequencia_w
						;
						
						insert into repasse_terceiro_item(
							nr_repasse_terceiro,
							nr_sequencia_item,
							vl_repasse,
							dt_atualizacao,
							nm_usuario,
							ds_observacao,
							nr_seq_trans_fin,
							nr_seq_regra,
							dt_liberacao,
							nr_seq_terceiro,
							nr_sequencia,
							dt_lancamento,
							nr_seq_trans_fin_prov,
							ie_partic_tributo,
							dt_contabil,
							cd_medico,
							nr_seq_tipo,
							ie_participa_piso)
						values (
							nr_repasse_terceiro_p,
							nr_seq_item_w,
							vl_item_w,
							clock_timestamp(),
							nm_usuario_p,
							ds_titulo_w,
							nr_seq_trans_financ_w,
							nr_seq_regra_w,
							clock_timestamp(),
							nr_seq_terceiro_w,
							nr_sequencia_w,
							clock_timestamp(),
							nr_seq_trans_fin_prov_w,
							ie_partic_tributo_w,
							dt_contabil_w,
							cd_medico_w,
							nr_seq_tipo_w,
							ie_participa_piso_w);
					end if;		
				end if;
		END LOOP;
		CLOSE C02;
	end if;
	end;
END LOOP;
CLOSE C05;	

select	count(*)
into STRICT	cont_w
from	repasse_terceiro_venc
where	nr_repasse_terceiro	= nr_repasse_terceiro_p;

-- Edgar 11/11/2005, se tiver vencimentos, deve gerar os mesmos novamente, pois o valor do repasse mudou
if (cont_w > 0) and (cd_condicao_pagamento_w IS NOT NULL AND cd_condicao_pagamento_w::text <> '') then
	CALL GERAR_VENC_REPASSE(nr_repasse_terceiro_p, 'S', nm_usuario_p,'S');
end if;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_item_repasse_manual ( nr_repasse_terceiro_p bigint, nm_usuario_p text ) FROM PUBLIC;

