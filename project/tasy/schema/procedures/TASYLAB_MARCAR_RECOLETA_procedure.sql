-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasylab_marcar_recoleta ( nr_prescricao_p bigint, nr_seq_prescricao_p bigint, cd_material_exame_p text, ds_obs_recoleta_p text, nr_seq_externo_p bigint, cd_erro_p INOUT bigint, ds_erro_p INOUT text) AS $body$
DECLARE

 
 
ds_VarStatusRecoleta_w	varchar(255);

nr_seq_evento_w			regra_envio_sms.nr_seq_evento%type;

ie_status_atend_w		prescr_procedimento.ie_status_atend%type;
nr_sequencia_w			prescr_procedimento.nr_sequencia%type;

c02 CURSOR FOR 
	SELECT	a.nr_seq_evento	 
	from	regra_envio_sms a 
	where	a.ie_evento_disp = 'REXL' 
	and	coalesce(a.ie_situacao,'A') = 'A';
	

BEGIN 
 
cd_erro_p	:= 0;
 
CALL tasy_atualizar_dados_sessao(nr_seq_externo_p);
 
if (coalesce(nr_prescricao_p::text, '') = '') then 
	cd_erro_p	:= 24;
elsif (coalesce(nr_seq_prescricao_p::text, '') = '') then 
	cd_erro_p	:= 13;
else	 
	 
	select	max(a.ie_status_atend), 
			max(a.nr_sequencia) 
	into STRICT	ie_status_atend_w, 
			nr_sequencia_w 
	from	prescr_procedimento a 
	where	a.nr_prescricao = nr_prescricao_p 
	and 	a.nr_sequencia = nr_seq_prescricao_p;
	 
	if (coalesce(nr_sequencia_w::text, '') = '') then 
		cd_erro_p	:= 25;
	else	 
		if (coalesce(ie_status_atend_w,0) < 35) then 
			 
			ds_VarStatusRecoleta_w		:= Obter_Valor_Param_Usuario(722, 12, 887, '-122', -1); --887 Ã© perfil da unimed Blumenau 
				
			begin			 
			update	prescr_procedimento 
			set 	nm_usuario = 'TASYLAB', 
					dt_emissao_setor_atend  = NULL, 
					ie_amostra = 'N', 
					ie_status_atend = coalesce(ds_VarStatusRecoleta_w,'20'), 	 
					dt_atualizacao = clock_timestamp(), 
					nr_seq_lab_ext  = NULL, 
					cd_motivo_baixa = 0, 
					dt_baixa  = NULL, 
					nr_seq_lote_externo  = NULL, 
					ds_obs_recoleta = ds_obs_recoleta_p 
			where 	nr_prescricao = nr_prescricao_p 
			and 	nr_sequencia = nr_seq_prescricao_p 
			and		ie_status_atend < 35;
			 
			CALL Retirar_Exame_Lote_LAB(	nr_prescricao_p, nr_seq_prescricao_p);	
			 
			open c02;
			loop 
			fetch c02 into nr_seq_evento_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				begin		 
				CALL gerar_evento_exame_recoleta(nr_seq_evento_w, nr_prescricao_p, nr_Seq_prescricao_p, 'TASYLAB');
				end;
			end loop;
			close c02;
			exception 
			when others then 
				cd_erro_p	:= 1;
				ds_erro_p	:= substr('Erro ao atualizar o item do resultado '||sqlerrm,1,2000);
			end;
		else 
			cd_erro_p	:= 1;
			ds_erro_p	:= obter_texto_tasy(224300, wheb_usuario_pck.get_nr_seq_idioma);			
		end if;
	end if;
	 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasylab_marcar_recoleta ( nr_prescricao_p bigint, nr_seq_prescricao_p bigint, cd_material_exame_p text, ds_obs_recoleta_p text, nr_seq_externo_p bigint, cd_erro_p INOUT bigint, ds_erro_p INOUT text) FROM PUBLIC;

