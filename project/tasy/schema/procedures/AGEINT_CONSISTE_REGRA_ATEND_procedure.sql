-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ageint_consiste_regra_atend (cd_convenio_p bigint, cd_categoria_p text, cd_plano_p text, ie_tipo_atendimento_p bigint, cd_estabelecimento_p bigint, ds_erro_p INOUT text, nr_seq_regra_lib_p INOUT bigint, nm_usuario_p text, ie_perm_bloq_agend_regra_p text default null, nr_seq_classificacao_p bigint default 0) AS $body$
DECLARE


nr_seq_regra_w			bigint;
ie_cons_se_somente_proc_estr	varchar(1);
nr_seq_regra_lib_w		bigint;
ie_utiliza_nova_forma_w		varchar(1);
ie_consiste_conv_tp_atend_w		varchar(1);
ie_Regra_c03_w			varchar(3);
nr_Seq_Regra_c03_w		bigint;
	
C01 CURSOR FOR
	SELECT	a.nr_sequencia
	from 	regra_convenio_plano a
	where	a.cd_convenio					= cd_convenio_p
	and	coalesce(a.cd_plano, coalesce(cd_plano_p,'0'))		= coalesce(cd_plano_p,'0')
	and	coalesce(a.cd_categoria,coalesce(cd_categoria_p,'0'))	= coalesce(cd_categoria_p,'0')
	and (a.cd_estabelecimento = coalesce(cd_estabelecimento_p,cd_estabelecimento) or coalesce(a.cd_estabelecimento::text, '') = '')
        and 	coalesce(cd_empresa, coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0)) = coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0)
	and	((a.ie_tipo_atendimento = ie_tipo_atendimento_p and (coalesce(ie_perm_bloq_agend_regra_p::text, '') = '' or ie_perm_bloq_agend_regra_p = 'S')) or (a.NR_SEQ_CLASSIF_ATEND = nr_seq_classificacao_p and ie_perm_bloq_agend_regra_p = 'CA') or (a.NR_SEQ_CLASSIF_ATEND = nr_seq_classificacao_p and a.ie_tipo_atendimento = ie_tipo_atendimento_p and ie_perm_bloq_agend_regra_p = 'T'))
	and	a.ie_regra in (1,2,5)
	and	coalesce(a.cd_procedimento::text, '') = ''
	and	coalesce(a.nr_seq_proc_interno::text, '') = ''
	and	coalesce(a.cd_area_procedimento::text, '') = ''
	and	coalesce(a.cd_grupo_proc::text, '') = ''
	and	coalesce(a.cd_especialidade_proc::text, '') = ''
	and	coalesce(a.nr_seq_exame::text, '') = ''
	and	coalesce(a.nr_seq_forma_org::text, '') = ''
	and coalesce(a.nr_seq_grupo::text, '') = ''
	and	coalesce(a.nr_seq_subgrupo::text, '') = ''
	and	coalesce(a.cd_setor_atendimento::text, '') = ''
	and	coalesce(a.cd_setor_atual::text, '') = ''
	and coalesce(a.cd_empresa_conv::text, '') = ''
	and	coalesce(a.ie_situacao,'A') = 'A'
	and (clock_timestamp() between coalesce(dt_inicio_vigencia,to_date('01/01/1900','dd/mm/yyyy')) and coalesce(dt_fim_vigencia,to_date('31/12/2099','dd/mm/yyyy')))
	order by  coalesce(a.cd_convenio,0),
		coalesce(a.cd_plano,0),
		coalesce(a.cd_categoria,0),
		coalesce(a.ie_tipo_atendimento,0);	
		
		
C02 CURSOR FOR
	SELECT	a.nr_sequencia
	from 	regra_convenio_plano a
	where	a.cd_convenio					= cd_convenio_p
	and	coalesce(a.cd_plano, coalesce(cd_plano_p,'0'))		= coalesce(cd_plano_p,'0')
	and	coalesce(a.cd_categoria,coalesce(cd_categoria_p,'0'))	= coalesce(cd_categoria_p,'0')
	and (a.cd_estabelecimento = coalesce(cd_estabelecimento_p,cd_estabelecimento) or coalesce(a.cd_estabelecimento::text, '') = '')
	and 	coalesce(cd_empresa, coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0)) = coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0)
	and	((CASE WHEN ie_consiste_conv_tp_atend_w='N' THEN  coalesce(a.ie_tipo_atendimento,ie_tipo_atendimento_p)  ELSE a.ie_tipo_atendimento END  = ie_tipo_atendimento_p and (coalesce(ie_perm_bloq_agend_regra_p::text, '') = '' or ie_perm_bloq_agend_regra_p = 'S')) or (coalesce(a.NR_SEQ_CLASSIF_ATEND, nr_seq_classificacao_p) = nr_seq_classificacao_p and ie_perm_bloq_agend_regra_p = 'CA') or (coalesce(a.NR_SEQ_CLASSIF_ATEND, nr_seq_classificacao_p) = nr_seq_classificacao_p and coalesce(a.ie_tipo_atendimento,ie_tipo_atendimento_p) = ie_tipo_atendimento_p and ie_perm_bloq_agend_regra_p = 'T'))
	and	a.ie_regra in (1,2,5)
	and	coalesce(a.cd_procedimento::text, '') = ''
	and	coalesce(a.nr_seq_proc_interno::text, '') = ''
	and	coalesce(a.cd_area_procedimento::text, '') = ''
	and	coalesce(a.cd_grupo_proc::text, '') = ''
	and	coalesce(a.cd_especialidade_proc::text, '') = ''
	and	coalesce(a.nr_seq_exame::text, '') = ''
	and	coalesce(a.nr_seq_forma_org::text, '') = ''
	and coalesce(a.nr_seq_grupo::text, '') = ''
	and	coalesce(a.nr_seq_subgrupo::text, '') = ''
	and	coalesce(a.cd_setor_atendimento::text, '') = ''
	and	coalesce(a.cd_setor_atual::text, '') = ''
	and coalesce(a.cd_empresa_conv::text, '') = ''
	and	coalesce(a.ie_situacao,'A') = 'A'
	and (clock_timestamp() between coalesce(dt_inicio_vigencia,to_date('01/01/1900','dd/mm/yyyy')) and coalesce(dt_fim_vigencia,to_date('31/12/2099','dd/mm/yyyy')))
	order by  coalesce(a.cd_convenio,0),
		coalesce(a.cd_plano,0),
		coalesce(a.cd_categoria,0),
		coalesce(a.ie_tipo_atendimento,0);		
			
C03 CURSOR FOR
	SELECT	a.nr_sequencia,
			a.ie_Regra
	from 	regra_convenio_plano a
	where	a.cd_convenio					= cd_convenio_p
	and	coalesce(a.cd_plano, coalesce(cd_plano_p,'0'))		= coalesce(cd_plano_p,'0')
	and	coalesce(a.cd_categoria,coalesce(cd_categoria_p,'0'))	= coalesce(cd_categoria_p,'0')
	and (a.cd_estabelecimento = coalesce(cd_estabelecimento_p,cd_estabelecimento) or coalesce(a.cd_estabelecimento::text, '') = '')
        and 	coalesce(cd_empresa, coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0)) = coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0)
	and	((CASE WHEN ie_consiste_conv_tp_atend_w='N' THEN  coalesce(a.ie_tipo_atendimento,ie_tipo_atendimento_p)  ELSE a.ie_tipo_atendimento END  = ie_tipo_atendimento_p and (coalesce(ie_perm_bloq_agend_regra_p::text, '') = '' or ie_perm_bloq_agend_regra_p = 'S')) or (coalesce(a.NR_SEQ_CLASSIF_ATEND, nr_seq_classificacao_p) = nr_seq_classificacao_p and ie_perm_bloq_agend_regra_p = 'CA') or (coalesce(a.NR_SEQ_CLASSIF_ATEND, nr_seq_classificacao_p) = nr_seq_classificacao_p and coalesce(a.ie_tipo_atendimento,ie_tipo_atendimento_p) = ie_tipo_atendimento_p and ie_perm_bloq_agend_regra_p = 'T'))
	and	coalesce(a.cd_procedimento::text, '') = ''
	and	coalesce(a.nr_seq_proc_interno::text, '') = ''
	and	coalesce(a.cd_area_procedimento::text, '') = ''
	and	coalesce(a.cd_grupo_proc::text, '') = ''
	and	coalesce(a.cd_especialidade_proc::text, '') = ''
	and	coalesce(a.nr_seq_exame::text, '') = ''
	and	coalesce(a.nr_seq_forma_org::text, '') = ''
	and coalesce(a.nr_seq_grupo::text, '') = ''
	and	coalesce(a.nr_seq_subgrupo::text, '') = ''
	and	coalesce(a.cd_setor_atendimento::text, '') = ''
	and	coalesce(a.cd_setor_atual::text, '') = ''
	and coalesce(a.cd_empresa_conv::text, '') = ''
	and	coalesce(a.ie_situacao,'A') = 'A'
	and (clock_timestamp() between coalesce(dt_inicio_vigencia,to_date('01/01/1900','dd/mm/yyyy')) and coalesce(dt_fim_vigencia,to_date('31/12/2099','dd/mm/yyyy')))
	order by  coalesce(a.cd_convenio,0),
		coalesce(a.cd_plano,0),
		coalesce(a.cd_categoria,0),
		coalesce(a.ie_tipo_atendimento,0);		
		

BEGIN

ie_cons_se_somente_proc_estr	:=	Obter_Valor_Param_Usuario(869, 151, Obter_Perfil_Ativo, nm_usuario_p, obter_estabelecimento_ativo);

select	coalesce(max(ie_consiste_conv_tp_atend),'S')
into STRICT	ie_consiste_conv_tp_atend_w
from	PARAMETRO_AGENDA_INTEGRADA
where	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;

ie_utiliza_nova_forma_w	:= 'S';

if (ie_utiliza_nova_forma_w = 'S') then

	if (ie_cons_se_somente_proc_estr = 'S') then

		begin
		select	max(x.nr_sequencia)
		into STRICT	nr_seq_regra_lib_w
		from 	regra_convenio_plano x
		where	x.cd_convenio	= cd_convenio_p
		and	coalesce(x.cd_plano, coalesce(cd_plano_p,'0'))		= coalesce(cd_plano_p,'0')
		and	coalesce(x.cd_categoria,coalesce(cd_categoria_p,'0'))	= coalesce(cd_categoria_p,'0')
		and (x.cd_estabelecimento 				= coalesce(cd_estabelecimento_p,cd_estabelecimento) 	or 	coalesce(x.cd_estabelecimento::text, '') = '')	
                and 	coalesce(cd_empresa, coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0)) = coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0)
		and	((x.ie_tipo_atendimento = ie_tipo_atendimento_p and (coalesce(ie_perm_bloq_agend_regra_p::text, '') = '' or ie_perm_bloq_agend_regra_p = 'S')) or (x.NR_SEQ_CLASSIF_ATEND = nr_seq_classificacao_p and ie_perm_bloq_agend_regra_p = 'CA') or (x.NR_SEQ_CLASSIF_ATEND = nr_seq_classificacao_p and x.ie_tipo_atendimento = ie_tipo_atendimento_p and ie_perm_bloq_agend_regra_p = 'T'))
		and	x.ie_regra not in (1,2,5)
		and	coalesce(x.cd_procedimento::text, '') = ''
		and	coalesce(x.nr_seq_proc_interno::text, '') = ''
		and	coalesce(x.cd_area_procedimento::text, '') = ''
		and	coalesce(cd_grupo_proc::text, '') = ''
		and	coalesce(x.ie_situacao,'A') = 'A'
		and	coalesce(x.cd_especialidade_proc::text, '') = ''
		and	coalesce(x.nr_seq_exame::text, '') = ''
		and	coalesce(x.nr_seq_forma_org::text, '') = ''
		and coalesce(x.nr_seq_grupo::text, '') = ''
		and	coalesce(x.nr_seq_subgrupo::text, '') = ''
		and	coalesce(x.cd_setor_atendimento::text, '') = ''
		and	coalesce(x.cd_setor_atual::text, '') = ''
		and coalesce(x.cd_empresa_conv::text, '') = ''
		and (clock_timestamp() between coalesce(dt_inicio_vigencia,to_date('01/01/1900','dd/mm/yyyy')) and coalesce(dt_fim_vigencia,to_date('31/12/2099','dd/mm/yyyy')));
		
		if (coalesce(nr_seq_regra_lib_w::text, '') = '') then
	  		open C02;
	  		loop
	  		fetch C02 into	
	  			nr_seq_regra_w;
	  		EXIT WHEN NOT FOUND; /* apply on C02 */
	  			begin
	  			nr_seq_regra_w := nr_seq_regra_w;
	  			end;
	  		end loop;
	  		close C02;
		end if;
		end;
		
	elsif (ie_cons_se_somente_proc_estr = 'N') then
	
		begin
		
		select	max(a.nr_sequencia)
		into STRICT	nr_seq_regra_w
		from 	regra_convenio_plano a
		where	a.cd_convenio					= cd_convenio_p
		and	coalesce(a.cd_plano, coalesce(cd_plano_p,'0'))		= coalesce(cd_plano_p,'0')
		and	coalesce(a.cd_categoria,coalesce(cd_categoria_p,'0'))	= coalesce(cd_categoria_p,'0')
		and (a.cd_estabelecimento = coalesce(cd_estabelecimento_p,cd_estabelecimento) or coalesce(a.cd_estabelecimento::text, '') = '')
		and 	coalesce(cd_empresa, coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0)) = coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0)
		and	((CASE WHEN ie_consiste_conv_tp_atend_w='N' THEN  coalesce(a.ie_tipo_atendimento,ie_tipo_atendimento_p)  ELSE a.ie_tipo_atendimento END  = ie_tipo_atendimento_p and (coalesce(ie_perm_bloq_agend_regra_p::text, '') = '' or ie_perm_bloq_agend_regra_p = 'S')) or (coalesce(a.NR_SEQ_CLASSIF_ATEND, nr_seq_classificacao_p) = nr_seq_classificacao_p and ie_perm_bloq_agend_regra_p = 'CA') or (coalesce(a.NR_SEQ_CLASSIF_ATEND, nr_seq_classificacao_p) = nr_seq_classificacao_p and coalesce(a.ie_tipo_atendimento,ie_tipo_atendimento_p) = ie_tipo_atendimento_p and ie_perm_bloq_agend_regra_p = 'T'))
        and	a.ie_regra in (1,2,5)
		and	coalesce(a.ie_situacao,'A') = 'A'
		and	not exists	(SELECT	1
					from 	regra_convenio_plano x
					where	x.cd_convenio	= cd_convenio_p
					and	coalesce(x.cd_plano, coalesce(cd_plano_p,'0'))		= coalesce(cd_plano_p,'0')
					and	coalesce(x.cd_categoria,coalesce(cd_categoria_p,'0'))	= coalesce(cd_categoria_p,'0')
					and (x.cd_estabelecimento 				= coalesce(cd_estabelecimento_p,cd_estabelecimento) or coalesce(x.cd_estabelecimento::text, '') = '')	
                    			and 	coalesce(cd_empresa, coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0)) = coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0)
					and	((x.ie_tipo_atendimento = ie_tipo_atendimento_p and (coalesce(ie_perm_bloq_agend_regra_p::text, '') = '' or ie_perm_bloq_agend_regra_p = 'S')) or (x.NR_SEQ_CLASSIF_ATEND = nr_seq_classificacao_p and ie_perm_bloq_agend_regra_p = 'CA') or (x.NR_SEQ_CLASSIF_ATEND = nr_seq_classificacao_p and x.ie_tipo_atendimento = ie_tipo_atendimento_p and ie_perm_bloq_agend_regra_p = 'T'))
					and	coalesce(x.ie_situacao,'A') = 'A'
					and	x.ie_regra not in (1,2,5));
					
		select	max(x.nr_sequencia)
		into STRICT	nr_seq_regra_lib_w
		from 	regra_convenio_plano x
		where	x.cd_convenio	= cd_convenio_p
		and	coalesce(x.cd_plano, coalesce(cd_plano_p,'0'))		= coalesce(cd_plano_p,'0')
		and	coalesce(x.cd_categoria,coalesce(cd_categoria_p,'0'))	= coalesce(cd_categoria_p,'0')
		and (x.cd_estabelecimento 				= coalesce(cd_estabelecimento_p,cd_estabelecimento) or coalesce(x.cd_estabelecimento::text, '') = '')
        	and 	coalesce(cd_empresa, coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0)) = coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0)
		and	((x.ie_tipo_atendimento = ie_tipo_atendimento_p and (coalesce(ie_perm_bloq_agend_regra_p::text, '') = '' or ie_perm_bloq_agend_regra_p = 'S')) or (x.NR_SEQ_CLASSIF_ATEND = nr_seq_classificacao_p and ie_perm_bloq_agend_regra_p = 'CA') or (x.NR_SEQ_CLASSIF_ATEND = nr_seq_classificacao_p and x.ie_tipo_atendimento = ie_tipo_atendimento_p and ie_perm_bloq_agend_regra_p = 'T'))
		and	coalesce(x.ie_situacao,'A') = 'A'
		and	x.ie_regra not in (1,2,5);
		end;	
	else
		open C03;
		loop
		fetch C03 into	
			nr_Seq_Regra_c03_w,
			ie_regra_c03_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			nr_Seq_Regra_c03_w	:= nr_Seq_Regra_c03_w;
			ie_regra_c03_w		:= ie_regra_c03_w;
			end;
		end loop;
		close C03;
		if (ie_regra_c03_w in (1,2,5)) then
			nr_seq_regra_w 		:= nr_Seq_Regra_c03_w;
		else
			nr_seq_regra_lib_w	:= nr_Seq_Regra_c03_w;
		end if;
	end if;	

	if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then
		ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(280115,'NR_SEQ_REGRA='||nr_seq_regra_w);
	end if;

else

	if (ie_cons_se_somente_proc_estr = 'S') then

		begin
		select	max(x.nr_sequencia)
		into STRICT	nr_seq_regra_lib_w
		from 	regra_convenio_plano x
		where	x.cd_convenio	= cd_convenio_p
		and	coalesce(x.cd_plano, coalesce(cd_plano_p,'0'))		= coalesce(cd_plano_p,'0')
		and	coalesce(x.cd_categoria,coalesce(cd_categoria_p,'0'))	= coalesce(cd_categoria_p,'0')
		and (x.cd_estabelecimento 				= coalesce(cd_estabelecimento_p,cd_estabelecimento) or coalesce(x.cd_estabelecimento::text, '') = '')	
        	and 	coalesce(cd_empresa, coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0)) = coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0)
		and	((x.ie_tipo_atendimento = ie_tipo_atendimento_p and (coalesce(ie_perm_bloq_agend_regra_p::text, '') = '' or ie_perm_bloq_agend_regra_p = 'S')) or (x.NR_SEQ_CLASSIF_ATEND = nr_seq_classificacao_p and ie_perm_bloq_agend_regra_p = 'CA') or (x.NR_SEQ_CLASSIF_ATEND = nr_seq_classificacao_p and x.ie_tipo_atendimento = ie_tipo_atendimento_p and ie_perm_bloq_agend_regra_p = 'T'))
		and	x.ie_regra not in (1,2,5)
		and	coalesce(x.cd_procedimento::text, '') = ''
		and	coalesce(x.nr_seq_proc_interno::text, '') = ''
		and	coalesce(x.cd_area_procedimento::text, '') = ''
		and	coalesce(cd_grupo_proc::text, '') = ''
		and	coalesce(x.ie_situacao,'A') = 'A'
		and	coalesce(x.cd_especialidade_proc::text, '') = ''
		and	coalesce(x.nr_seq_exame::text, '') = ''
		and	coalesce(x.nr_seq_forma_org::text, '') = ''
		and coalesce(x.nr_seq_grupo::text, '') = ''
		and	coalesce(x.nr_seq_subgrupo::text, '') = ''
		and	coalesce(x.cd_setor_atendimento::text, '') = ''
		and	coalesce(x.cd_setor_atual::text, '') = ''
		and coalesce(x.cd_empresa_conv::text, '') = ''
		and (clock_timestamp() between coalesce(dt_inicio_vigencia,to_date('01/01/1900','dd/mm/yyyy')) and coalesce(dt_fim_vigencia,to_date('31/12/2099','dd/mm/yyyy')));
		
		if (coalesce(nr_seq_regra_lib_w::text, '') = '') then
	  		open C01;
	  		loop
	  		fetch C01 into	
	  			nr_seq_regra_w;
	  		EXIT WHEN NOT FOUND; /* apply on C01 */
	  			begin
	  			nr_seq_regra_w := nr_seq_regra_w;
	  			end;
	  		end loop;
	  		close C01;
		end if;
		end;
		
	elsif (ie_cons_se_somente_proc_estr = 'N') then
		begin
		
		select	max(a.nr_sequencia)
		into STRICT	nr_seq_regra_w
		from 	regra_convenio_plano a
		where	a.cd_convenio					= cd_convenio_p
		and	coalesce(a.cd_plano, coalesce(cd_plano_p,'0'))		= coalesce(cd_plano_p,'0')
		and	coalesce(a.cd_categoria,coalesce(cd_categoria_p,'0'))	= coalesce(cd_categoria_p,'0')
		and (a.cd_estabelecimento = coalesce(cd_estabelecimento_p,cd_estabelecimento) or coalesce(a.cd_estabelecimento::text, '') = '')
        	and 	coalesce(cd_empresa, coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0)) = coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0)
		and	((a.ie_tipo_atendimento = ie_tipo_atendimento_p and (coalesce(ie_perm_bloq_agend_regra_p::text, '') = '' or ie_perm_bloq_agend_regra_p = 'S')) or (a.NR_SEQ_CLASSIF_ATEND = nr_seq_classificacao_p and ie_perm_bloq_agend_regra_p = 'CA') or (a.NR_SEQ_CLASSIF_ATEND = nr_seq_classificacao_p and a.ie_tipo_atendimento = ie_tipo_atendimento_p and ie_perm_bloq_agend_regra_p = 'T'))
		and	a.ie_regra in (1,2,5)
		and	coalesce(a.ie_situacao,'A') = 'A'
		and	not exists	(SELECT	1
					from 	regra_convenio_plano x
					where	x.cd_convenio	= cd_convenio_p
					and	coalesce(x.cd_plano, coalesce(cd_plano_p,'0'))		= coalesce(cd_plano_p,'0')
					and	coalesce(x.cd_categoria,coalesce(cd_categoria_p,'0'))	= coalesce(cd_categoria_p,'0')
					and (x.cd_estabelecimento 				= coalesce(cd_estabelecimento_p,cd_estabelecimento) 	or coalesce(x.cd_estabelecimento::text, '') = '')	
                    			and 	coalesce(cd_empresa, coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0)) = coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0)
					and	((x.ie_tipo_atendimento = ie_tipo_atendimento_p and (coalesce(ie_perm_bloq_agend_regra_p::text, '') = '' or ie_perm_bloq_agend_regra_p = 'S')) or (x.NR_SEQ_CLASSIF_ATEND = nr_seq_classificacao_p and ie_perm_bloq_agend_regra_p = 'CA') or (x.NR_SEQ_CLASSIF_ATEND = nr_seq_classificacao_p and x.ie_tipo_atendimento = ie_tipo_atendimento_p and ie_perm_bloq_agend_regra_p = 'T'))				
					and	coalesce(x.ie_situacao,'A') = 'A'
					and	x.ie_regra not in (1,2,5));

		select	max(x.nr_sequencia)
		into STRICT	nr_seq_regra_lib_w
		from 	regra_convenio_plano x
		where	x.cd_convenio	= cd_convenio_p
		and	coalesce(x.cd_plano, coalesce(cd_plano_p,'0'))		= coalesce(cd_plano_p,'0')
		and	coalesce(x.cd_categoria,coalesce(cd_categoria_p,'0'))	= coalesce(cd_categoria_p,'0')
		and (x.cd_estabelecimento 				= coalesce(cd_estabelecimento_p,cd_estabelecimento) 	or coalesce(x.cd_estabelecimento::text, '') = '')
        	and 	coalesce(cd_empresa, coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0)) = coalesce(obter_empresa_estab(wheb_usuario_pck.get_cd_estabelecimento),0)
		and	((x.ie_tipo_atendimento = ie_tipo_atendimento_p and (coalesce(ie_perm_bloq_agend_regra_p::text, '') = '' or ie_perm_bloq_agend_regra_p = 'S')) or (x.NR_SEQ_CLASSIF_ATEND = nr_seq_classificacao_p and ie_perm_bloq_agend_regra_p = 'CA') or (x.NR_SEQ_CLASSIF_ATEND = nr_seq_classificacao_p and x.ie_tipo_atendimento = ie_tipo_atendimento_p and ie_perm_bloq_agend_regra_p = 'T'))				
		and	coalesce(x.ie_situacao,'A') = 'A'
		and	x.ie_regra not in (1,2,5);
		
		end;	
		
	end if;	

	if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then
		ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(280115,'NR_SEQ_REGRA='||nr_seq_regra_w);
	end if;
	
end if;

nr_seq_regra_lib_p := nr_seq_regra_lib_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageint_consiste_regra_atend (cd_convenio_p bigint, cd_categoria_p text, cd_plano_p text, ie_tipo_atendimento_p bigint, cd_estabelecimento_p bigint, ds_erro_p INOUT text, nr_seq_regra_lib_p INOUT bigint, nm_usuario_p text, ie_perm_bloq_agend_regra_p text default null, nr_seq_classificacao_p bigint default 0) FROM PUBLIC;

