-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rxt_liberar_tratamento (nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


ie_falta_info_w bigint;	
nr_sequencia_w bigint;
ie_tipo_trat_w varchar(1);
integracao_tasy_w varchar(1) := 'N';

NR_SEQ_TUMOR_w	bigint;	
retorno_integracao_w	text;

c01 CURSOR FOR
SELECT 	a.nr_sequencia
from	RXT_CAMPO a,
		rxt_fase_tratamento b
where a.nr_seq_fase = b.nr_sequencia
and a.ie_situacao = 'A'
and (a.dt_lib_fisico IS NOT NULL AND a.dt_lib_fisico::text <> '')
and coalesce(a.dt_liberacao::text, '') = ''
and b.nr_seq_tratamento = nr_sequencia_p;

c02 CURSOR FOR
SELECT a.nr_sequencia
from 	rxt_braq_campo_aplic_trat a,
		rxt_braq_aplic_trat b
where a.nr_seq_aplic_trat = b.nr_sequencia
and a.ie_situacao = 'A'
and (a.dt_lib_fisico IS NOT NULL AND a.dt_lib_fisico::text <> '')
and coalesce(a.dt_liberacao::text, '') = ''
and b.nr_seq_tratamento = nr_sequencia_p;			
				

BEGIN
if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then

	select Rxt_Obter_Tipo_Trat_Prot(nr_seq_protocolo),
			NR_SEQ_TUMOR
	into STRICT 	ie_tipo_trat_w,
			NR_SEQ_TUMOR_w
	from 	rxt_tratamento
	where 	nr_sequencia =  nr_sequencia_p;
	
	
	select 	count(*)
	into STRICT 	ie_falta_info_w
	from 	rxt_braq_aplic_trat
	where 	nr_seq_tratamento = nr_sequencia_p
	and   	coalesce(nr_ordem_execucao_aplic::text, '') = '';
	

		update  rxt_tratamento
		set 	nm_usuario_lib = nm_usuario_p,
			dt_liberacao = clock_timestamp(),
			ie_replanejamento = 'N'
		WHERE 	nr_sequencia 	= nr_sequencia_p;

    select OBTER_PARAM_USUARIO_LOGADO(9041,10)
    into STRICT integracao_tasy_w
;

		if (integracao_tasy_w = 'S')then
			retorno_integracao_w := BIFROST.SEND_INTEGRATION_CONTENT('VARIAN_authorizeOrReleaseTreatment',
                                                   OBTER_ADT_A01_VARIAN(NR_SEQ_TUMOR_W, NR_SEQUENCIA_P),
                                                   OBTER_USUARIO_ATIVO);
		end if;
		
		if (ie_tipo_trat_w = 'T') then
			open c01;
				loop
				fetch c01 into
					nr_sequencia_w;
					EXIT WHEN NOT FOUND; /* apply on c01 */
				begin
				update RXT_CAMPO
				set dt_liberacao = clock_timestamp(),
					nm_usuario_lib = nm_usuario_p
				where nr_sequencia = nr_sequencia_w;
				
				end;
				end loop;
			close c01;

		elsif (ie_tipo_trat_w = 'B') then
			open c02;
				loop
				fetch c02 into
					nr_sequencia_w;
					EXIT WHEN NOT FOUND; /* apply on c02 */
				begin
				update rxt_braq_campo_aplic_trat
				set dt_liberacao = clock_timestamp(),
					nm_usuario_lib = nm_usuario_p
				where nr_sequencia = nr_sequencia_w;
				
				end;
				end loop;
			close c02;
		end if;		
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rxt_liberar_tratamento (nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

