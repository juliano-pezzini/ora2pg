-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_preco_mat_tab_autor (cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_material_p bigint, nr_seq_marca_p bigint, vl_material_p INOUT bigint, ie_origem_preco_p INOUT text, dt_ult_vigencia_p INOUT timestamp) AS $body$
DECLARE


/* Atencao - Essa procedure foi feita para buscar o preco do material sem
taxa de comercializacao, etc.. So deve ser utilizada na autorizacao de materiais especiais
*/
nr_dec_unitario_w		smallint;
ie_origem_preco_w		smallint;
ie_origem_preco_maior_w		smallint;
ie_origem_preco_menor_w		smallint;
ie_origem_preco_ww		smallint;
ie_tipo_rounded_w		varchar(1);
tx_ajuste_mat_w			double precision	:= 0;
tx_afaturar_w			double precision	:= 0;
cd_tab_preco_material_w		smallint	:= 0;
dt_base_fixo_w			timestamp;
dt_base_bras_w			timestamp;
dt_vigencia_w			timestamp	:= clock_timestamp() - interval '1000 days';
dt_vigencia_maior_w			timestamp	:= clock_timestamp() - interval '1000 days';
dt_vigencia_menor_w			timestamp	:= clock_timestamp() - interval '1000 days';
dt_vigencia_orig_w		timestamp	:= clock_timestamp();

vl_material_w			double precision 	:= 0;
vl_material_orig_w		double precision 	:= 0;

ie_preco_informado_w		varchar(1)	:= 'N';
ie_glosa_w			varchar(1)	:= '';
cd_cgc_fornecedor_w		varchar(14);
tx_brasindice_pfb_w		REGRA_AJUSTE_MATERIAL.TX_BRASINDICE_PFB%type    := 0;--number(15,4)	:= 0;
tx_brasindice_pmc_w		CONVENIO_BRASINDICE.TX_BRASINDICE_PMC%type      := 0;--number(15,4)	:= 0;
tx_pmc_neg_w			CONVENIO_BRASINDICE.TX_PMC_NEG%type             := 0;--number(15,4)	:= 0;
tx_pmc_pos_w			CONVENIO_BRASINDICE.TX_PMC_POS%type             := 0;--number(15,4)	:= 0;
qt_dia_fixo_w			integer	:= 0;
tx_simpro_pfb_w			double precision;
tx_simpro_pmc_w			double precision;
ie_precedencia_w		varchar(01);
ie_origem_w			varchar(05);
ie_origem_ww			varchar(01);
ie_preced_conv_w		varchar(01);
ie_origem_conv_w		varchar(05);

ie_preced_conv_estab_w		varchar(01);
ie_origem_conv_estab_w		varchar(05);

pr_glosa_w			double precision 	:= 0;
vl_material_inf_w		double precision;
cd_tabela_preco_w		bigint;
cd_motivo_exc_conta_w		bigint;
cd_moeda_w			smallint;
cd_moeda_padrao_w		smallint;
vl_cotacao_w			cotacao_moeda.vl_cotacao%type;
tx_ajuste_periodo_w		double precision;
nr_seq_regra_w			bigint;
ie_tipo_preco_conv_w		varchar(03);
cd_tiss_w			varchar(40);
vl_maior_preco_w		double precision;
vl_menor_preco_w		double precision;
vl_mat_orig_taxa_ajuste		double precision;
qt_conversao_w			double precision;
ie_autor_particular_w		varchar(1);
cd_convenio_glosa_ww		integer:= 0;
cd_categoria_glosa_ww		varchar(10):= ' ';

ie_preco_custo_w	  	varchar(01);
cd_tabela_custo_w		bigint;
dt_ref_custo_w			timestamp;
vl_custo_w			double precision;
ie_apuracao_custo_w		varchar(10);
vl_custo_unitario_w		double precision;
pr_imposto_w			double precision	:= 0;
ds_criterio_w			varchar(20);
nr_seq_bras_preco_w		bigint;
nr_seq_mat_bras_w		bigint;
nr_seq_mat_simpro_w		bigint;
nr_seq_simpro_preco_w		bigint;


c01 CURSOR FOR
SELECT	/*+index (a prcmate_pk) */	a.vl_preco_venda,
	a.dt_inicio_vigencia,
	b.cd_tab_preco_mat,
	a.cd_moeda,
	coalesce(a.qt_conversao,1)
from	preco_material 		a,
	convenio_preco_mat	b
where	a.cd_tab_preco_mat	= b.cd_tab_preco_mat
and	b.cd_convenio		= cd_convenio_p
and	b.cd_categoria		= cd_categoria_p
and	a.cd_estabelecimento 	= cd_estabelecimento_p
and	a.cd_estabelecimento 	= b.cd_estabelecimento
and	a.cd_material        	= cd_material_p
and	coalesce(a.ie_situacao,'A')	= 'A'
and	coalesce(b.ie_situacao,'A')	= 'A'
and	dt_vigencia_w between coalesce(b.dt_inicio_vigencia, dt_vigencia_w)	and coalesce(b.dt_final_vigencia, dt_vigencia_w)
and	a.dt_inicio_vigencia	<= clock_timestamp()
order by
	CASE WHEN ie_precedencia_w='D' THEN 0  ELSE coalesce(b.nr_prioridade,1) END  desc,
	CASE WHEN ie_origem_ww='T' THEN coalesce(b.nr_prioridade,1)  ELSE 0 END  desc,
	a.dt_inicio_vigencia,
	CASE WHEN ie_precedencia_w='M' THEN  a.vl_preco_venda *-1  ELSE a.vl_preco_venda END;

BEGIN

vl_maior_preco_w	:= 0;
vl_menor_preco_w	:= 0;
vl_mat_orig_taxa_ajuste := 0;
dt_vigencia_w		:= trunc(clock_timestamp(), 'dd');

/* verificar qual a ordem de busca dos precos */

select	coalesce(max(ie_preco_custo), 'N')
into STRICT	ie_preco_custo_w
from	categoria_convenio
where	cd_convenio		= cd_convenio_p
and	cd_categoria		= cd_categoria_p;

select	max(ie_origem_preco),
	max(ie_precedencia_preco)
into STRICT	ie_origem_conv_estab_w,
	ie_preced_conv_estab_w
from	convenio_estabelecimento
where	cd_convenio		= cd_convenio_p
and	cd_estabelecimento	= cd_estabelecimento_p;

select	coalesce(max(ie_origem_preco),'BT'),
	coalesce(max(ie_precedencia_preco),'D')
into STRICT	ie_origem_conv_w,
	ie_preced_conv_w
from	convenio
where	cd_convenio	= cd_convenio_p;

if (ie_origem_conv_estab_w IS NOT NULL AND ie_origem_conv_estab_w::text <> '') then
	ie_origem_conv_w := ie_origem_conv_estab_w;
end if;

if (ie_preced_conv_estab_w IS NOT NULL AND ie_preced_conv_estab_w::text <> '') then
	ie_preced_conv_w := ie_preced_conv_estab_w;
end if;

vl_material_inf_w		:= vl_material_w;
ie_origem_w			:= coalesce(ie_origem_conv_estab_w,ie_origem_conv_w);
ie_precedencia_w		:= coalesce(ie_preced_conv_estab_w,ie_preced_conv_w);
ie_origem_preco_w 		:= 0;
ie_origem_preco_ww		:= 0;
cd_tab_preco_material_w		:= 0;
ie_origem_preco_maior_w		:= 0;
ie_origem_preco_menor_w := 0;




FOR i IN 1 .. 3 LOOP
	BEGIN
	vl_material_orig_w		:= 0;
	dt_vigencia_orig_w		:= clock_timestamp() - interval '2000 days';

	/* Tabela interna */

	if	((vl_material_w = 0) or (ie_precedencia_w in ('D','P','V','M'))) and (substr(ie_origem_w,i,1) = 'T')	then
	     	begin
		ie_origem_ww	:= 'T';

		open c01;
		loop
		fetch c01 into
			vl_material_orig_w,
            		dt_vigencia_orig_w,
			cd_tab_preco_material_w,
			cd_moeda_w,	
			qt_conversao_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */

		if (qt_conversao_w = 0) then
			qt_conversao_w := 1;
		end if;
		
		vl_material_orig_w	:= (vl_material_orig_w / qt_conversao_w);


		end loop;
		close c01;

		select	coalesce(max(cd_moeda_padrao),0)
		into STRICT	cd_moeda_padrao_w
		from	parametro_compras
		where	cd_estabelecimento = cd_estabelecimento_p;

		if (cd_moeda_padrao_w <> 0) and (cd_moeda_w <> cd_moeda_padrao_w) then
			select	coalesce(max(vl_cotacao),1)
			into STRICT	vl_cotacao_w
			from 	cotacao_moeda
			where	cd_moeda	= cd_moeda_w
			and 	dt_cotacao	= (	SELECT	max(dt_cotacao)
							from 	cotacao_moeda
							where 	cd_moeda = cd_moeda_w
							and 	dt_cotacao <= clock_timestamp());

			vl_material_orig_w	:= vl_material_orig_w * vl_cotacao_w;
		end if;
		ie_origem_preco_ww		:= 2;

		if (vl_maior_preco_w < vl_material_orig_w) then
			vl_maior_preco_w	:= vl_material_orig_w;
			ie_origem_preco_maior_w	:= ie_origem_preco_ww;
			dt_vigencia_maior_w	:= dt_vigencia_orig_w;
		end if;

		vl_mat_orig_taxa_ajuste := vl_material_orig_w;

		if (vl_menor_preco_w = 0 or (vl_mat_orig_taxa_ajuste > 0 and vl_menor_preco_w > vl_mat_orig_taxa_ajuste)) then
			vl_menor_preco_w	:= vl_material_orig_w;
			ie_origem_preco_menor_w	:= ie_origem_preco_ww;
			dt_vigencia_menor_w	:= dt_vigencia_orig_w;
		end if;

     		end;
	
	/* Brasindice */

	elsif	((vl_material_w = 0) or (ie_precedencia_w in ('D','P','V','M'))) and (substr(ie_origem_w,i,1) = 'B')	then
		begin
		ie_origem_ww	:= 'B';
		
		

	     	SELECT * FROM obter_preco_brasindice(
			cd_estabelecimento_p, cd_convenio_p, null, cd_material_p, clock_timestamp(), 1, 1, null, null, 1, 1, null, null, vl_material_orig_w, dt_vigencia_orig_w, cd_tiss_w, null, null, null, null, null, nr_seq_bras_preco_w, nr_seq_mat_bras_w) INTO STRICT vl_material_orig_w, dt_vigencia_orig_w, cd_tiss_w, nr_seq_bras_preco_w, nr_seq_mat_bras_w;

		ie_origem_preco_ww		:= 1;

		if (vl_maior_preco_w < vl_material_orig_w) then
			vl_maior_preco_w	:= vl_material_orig_w;
			ie_origem_preco_maior_w	:= ie_origem_preco_ww;
			dt_vigencia_maior_w	:= dt_vigencia_orig_w;
		end if;

		vl_mat_orig_taxa_ajuste := vl_material_orig_w;

		if (vl_menor_preco_w = 0 or (vl_mat_orig_taxa_ajuste > 0 and vl_menor_preco_w > vl_mat_orig_taxa_ajuste))  then
			vl_menor_preco_w	:= vl_material_orig_w;
			ie_origem_preco_menor_w	:= ie_origem_preco_ww;
			dt_vigencia_menor_w	:= dt_vigencia_orig_w;
		end if;

		end;

	/* Simpro */

	elsif	((vl_material_w = 0) or (ie_precedencia_w in ('D','P','V','M'))) and (substr(ie_origem_w,i,1) = 'S')	then
		begin

		ie_origem_ww	:= 'S';
		

		


	     	SELECT * FROM calcular_preco_simpro(
			cd_estabelecimento_p, cd_convenio_p, cd_material_p, 1, 1, clock_timestamp(), null, vl_material_orig_w, dt_vigencia_orig_w, 1, 1, 1, 1, 'N', 'N', nr_seq_marca_p, nr_seq_mat_simpro_w, nr_seq_simpro_preco_w) INTO STRICT vl_material_orig_w, dt_vigencia_orig_w, nr_seq_mat_simpro_w, nr_seq_simpro_preco_w;
	
		ie_origem_preco_ww		:= 4;

		if (vl_maior_preco_w < vl_material_orig_w) then
			vl_maior_preco_w	:= vl_material_orig_w;
			ie_origem_preco_maior_w	:= ie_origem_preco_ww;
			dt_vigencia_maior_w	:= dt_vigencia_orig_w;
		end if;

		vl_mat_orig_taxa_ajuste := vl_material_orig_w;
		
		if (vl_menor_preco_w = 0 or (vl_mat_orig_taxa_ajuste > 0 and vl_menor_preco_w > vl_mat_orig_taxa_ajuste)) then
			vl_menor_preco_w	:= vl_material_orig_w;
			ie_origem_preco_menor_w	:= ie_origem_preco_ww;
			dt_vigencia_menor_w	:= dt_vigencia_orig_w;
		end if;

		end;
	end if;

	if (vl_material_orig_w > 0) and
		((ie_precedencia_w = 'O') or (vl_material_w = 0) or (dt_vigencia_orig_w	> dt_vigencia_w)) then
		begin
		dt_vigencia_w		:= dt_vigencia_orig_w;
		vl_material_w		:= vl_material_orig_w;
		ie_origem_preco_w	:= ie_origem_preco_ww;
		end;
	end if;

	END;
END LOOP;

if (vl_material_w > 0) then
	begin

	select	max(nr_dec_unitario),
		max(ie_arredondamento)
	into STRICT	nr_dec_unitario_w,
		ie_tipo_rounded_w
	from	convenio_estabelecimento
	where	cd_convenio		= cd_convenio_p
	and	cd_estabelecimento	= cd_estabelecimento_p;

	if (coalesce(nr_dec_unitario_w::text, '') = '') then
		select	coalesce(max(coalesce(vl_parametro, vl_parametro_padrao)),4)
		into STRICT 	nr_dec_unitario_w
		from 	funcao_parametro
		where 	cd_funcao = 81
		and 	nr_sequencia = 1;
	end if;

	if (coalesce(ie_tipo_rounded_w::text, '') = '') then
		select	coalesce(max(coalesce(vl_parametro, vl_parametro_padrao)), 'P')
		into STRICT	ie_tipo_rounded_w
		from 	funcao_parametro
		where 	cd_funcao = 81
		and 	nr_sequencia = 3;
	end if;

	vl_material_w := arredondamento(vl_material_w, nr_dec_unitario_w, ie_tipo_rounded_w);

	end;
end if;

/* Retorno do preco */

if (ie_precedencia_w = 'V') then
    vl_material_p		:= vl_maior_preco_w;
    ie_origem_preco_p	:= ie_origem_preco_maior_w;
    dt_ult_vigencia_p	:= dt_vigencia_maior_w;
elsif (ie_precedencia_w = 'M') then
    vl_material_p		:= vl_menor_preco_w;
    ie_origem_preco_p	:= ie_origem_preco_menor_w;
    dt_ult_vigencia_p	:= dt_vigencia_menor_w;
else
    ie_origem_preco_p	:= ie_origem_preco_w;
    vl_material_p		:= vl_material_w;
    dt_ult_vigencia_p	:= dt_vigencia_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_preco_mat_tab_autor (cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, cd_material_p bigint, nr_seq_marca_p bigint, vl_material_p INOUT bigint, ie_origem_preco_p INOUT text, dt_ult_vigencia_p INOUT timestamp) FROM PUBLIC;

