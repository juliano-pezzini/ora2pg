-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE finalizar_enfermagem_pa ( nr_seq_triagem_p bigint) AS $body$
DECLARE

        
nr_atendimento_w  bigint;
nm_usuario_w    varchar(15);
ie_finalizar_triagem_w  varchar(15);
ie_status_w    varchar(50);
ds_erro_w    varchar(255);
nr_regras_atendidas_w varchar(255);
nr_seq_classif_w triagem_pronto_atend.NR_SEQ_CLASSIF%type;



BEGIN

if (nr_seq_triagem_p IS NOT NULL AND nr_seq_triagem_p::text <> '') then

  /*update  atendimento_paciente a
  set  a.dt_fim_triagem  =   sysdate
  where  a.nr_atendimento  =   nr_atendimento_p;*/
  nm_usuario_w := wheb_usuario_pck.get_nm_usuario;
  ie_finalizar_triagem_w := Obter_param_Usuario(281, 1567, obter_perfil_ativo, nm_usuario_w, wheb_usuario_pck.get_cd_estabelecimento, ie_finalizar_triagem_w);

  select   max(nr_atendimento)
  into STRICT  nr_atendimento_w
  from  triagem_pronto_atend
  where  nr_sequencia    =   nr_seq_triagem_p;

  
  if ( coalesce(nr_atendimento_w,0) > 0) then

  
    update triagem_pronto_atend a
    set    a.dt_fim_triagem    =   clock_timestamp(),
           a.ie_status_paciente   =   CASE WHEN ie_finalizar_triagem_w='S' THEN 'A'  ELSE 'T' END     
    where  a.nr_sequencia    =   nr_seq_triagem_p;

    CALL atualiza_atendimento_triagem(nr_seq_triagem_p,nm_usuario_w);

    select max(NR_SEQ_CLASSIF)
    into STRICT nr_seq_classif_w
    from triagem_pronto_atend
    where nr_sequencia    =   nr_seq_triagem_p;

    if (nr_seq_classif_w > 0)then
    begin
		nr_regras_atendidas_w := gqa_classificacao_risco(nr_seq_classif_w, nr_atendimento_w, nm_usuario_w, nr_regras_atendidas_w);
        CALL gera_protocolo_assistencial(nr_atendimento_w,nm_usuario_w);
        RAISE EXCEPTION 'exception_w' USING ERRCODE = '50008';
     exception
     when SQLSTATE '50008' then
        nr_regras_atendidas_w := 1;
     end;
	end if;


  else
    
    update triagem_pronto_atend a
    set    a.dt_fim_triagem    =   clock_timestamp(),
           a.ie_status_paciente   =   'T'    
    where  a.nr_sequencia    =   nr_seq_triagem_p;
  end if;

  begin
    CALL gerar_log_triagem_pa( null,'F',wheb_usuario_pck.get_nm_usuario, NULL, 'N', NULL, nr_seq_triagem_p);
  exception
  when others then
    ds_erro_w  := substr(sqlerrm,1,255);
  end;

  
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE finalizar_enfermagem_pa ( nr_seq_triagem_p bigint) FROM PUBLIC;

