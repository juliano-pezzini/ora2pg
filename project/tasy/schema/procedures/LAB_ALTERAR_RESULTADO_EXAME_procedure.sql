-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_alterar_resultado_exame (NR_SEQ_RESULTADO_P bigint, NR_SEQUENCIA_P bigint, NM_USUARIO_P text, DS_RESULTADO_P text, DS_RETORNO_P INOUT text) AS $body$
DECLARE

nr_seq_exame_w		bigint;
ds_resultado_w		varchar(4000);
qt_resultado_w		double precision;
pr_resultado_w		double precision;
qt_decimais_w		smallint;
ie_formato_resultado_w	varchar(3);
dt_digitacao_w		timestamp;
nm_usuario_prim_dig_w	varchar(15);
ie_status_w		varchar(1);
ie_formato_incorreto_w  varchar(1);


BEGIN
ie_formato_incorreto_w := 'N';

select	a.nr_seq_exame,
	coalesce(qt_decimais, 0),
	dt_digitacao,
	nm_usuario_prim_dig
into STRICT	nr_seq_exame_w,
	qt_decimais_w,
	dt_digitacao_w,
	nm_usuario_prim_dig_w
from	exame_lab_result_item a
where	a.nr_seq_resultado = nr_seq_resultado_p
and	a.nr_sequencia = nr_sequencia_p;

select	a.ie_formato_resultado
into STRICT	ie_formato_resultado_w
from	exame_laboratorio a
where	a.nr_seq_exame = nr_seq_exame_w;

begin
case	ie_formato_resultado_w
	when	'D'	then	ds_resultado_w := DS_RESULTADO_P;
	when	'DL'	then	ds_resultado_w := DS_RESULTADO_P;
	when	'DD'	then	ds_resultado_w := DS_RESULTADO_P; -- alinhar a direita
	when	'DV'	then
		if (lab_obter_se_somente_numero(DS_RESULTADO_P) = 'S') then
			begin
			--qt_resultado_w:= formata_casas_decimais(DS_RESULTADO_P, qt_decimais_w);
			select (DS_RESULTADO_P)::numeric
			into STRICT qt_resultado_w
			;

			qt_resultado_w:= formata_casas_decimais(DS_RESULTADO_P, qt_decimais_w);
			exception
			when others then
				begin
					select (replace(DS_RESULTADO_P, '.', ','))::numeric
					into STRICT qt_resultado_w
					;
				exception
				when others then
					ds_resultado_w:= DS_RESULTADO_P;
				end;
			end;
		else
			ds_resultado_w:= DS_RESULTADO_P;
		end if;
	when	'V'	then	qt_resultado_w:= formata_casas_decimais(DS_RESULTADO_P, qt_decimais_w);
	when	'P'	then	pr_resultado_w:= formata_casas_decimais(DS_RESULTADO_P, qt_decimais_w);
	when	'VP'	then	qt_resultado_w:= formata_casas_decimais(DS_RESULTADO_P, qt_decimais_w);
	when	'CV'	then	qt_resultado_w:= formata_casas_decimais(DS_RESULTADO_P, qt_decimais_w);
	else
		begin
			ie_formato_incorreto_w := 'S';
			goto FINAL;
		end;
end case;
exception
	when others then
		ie_formato_incorreto_w := 'S';
		goto FINAL;
end;

if (coalesce(dt_digitacao_w::text, '') = '') then
	dt_digitacao_w := clock_timestamp();
end if;

if (coalesce(nm_usuario_prim_dig_w::text, '') = '') then
	nm_usuario_prim_dig_w := nm_usuario_p;
end if;

if 	not((coalesce(ds_resultado_w::text, '') = '') and (coalesce(qt_resultado_w::text, '') = '') and (coalesce(pr_resultado_w::text, '') = '')) then
	ie_status_w := '1';
end if;

update	exame_lab_result_item
set	ds_resultado = ds_resultado_w,
	qt_resultado = qt_resultado_w,
	pr_resultado = pr_resultado_w,
	dt_digitacao = dt_digitacao_w,
	nm_usuario_prim_dig = nm_usuario_prim_dig_w,
	ie_status = ie_status_w
where	nr_seq_resultado = nr_seq_resultado_p
and	nr_sequencia = nr_sequencia_p;

<<FINAL>>

commit;

DS_RETORNO_P := ie_formato_incorreto_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_alterar_resultado_exame (NR_SEQ_RESULTADO_P bigint, NR_SEQUENCIA_P bigint, NM_USUARIO_P text, DS_RESULTADO_P text, DS_RETORNO_P INOUT text) FROM PUBLIC;

