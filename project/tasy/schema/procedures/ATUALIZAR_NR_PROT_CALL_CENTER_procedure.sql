-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_nr_prot_call_center ( nr_seq_atendimento_p bigint, cd_estabelecimento_p text, nm_usuario_p text, nr_protocolo_atendimento_p INOUT text, nr_sequencial_dia_p INOUT bigint) AS $body$
DECLARE


cd_ans_w			pls_outorgante.cd_ans%type;
qt_registro_w			bigint;
ano_w				varchar(4);
mes_w				varchar(2);
dia_w				varchar(2);
nr_protocolo_atendimento_w	pls_atendimento.nr_protocolo_atendimento%type;	
nr_sequencial_dia_w		pls_atendimento.nr_sequencial_dia%type;	
ie_protocolo_atend_w		 varchar(1);			
				

BEGIN
-- A tabela pls_controle_estab permite apenas 1 registro.
select 	coalesce(max(ie_protocolo_atend),'N')
into STRICT	ie_protocolo_atend_w
from 	pls_controle_estab;

ano_w	:= to_char(clock_timestamp(),'yyyy');
mes_w	:= to_char(clock_timestamp(),'mm');	
dia_w	:= to_char(clock_timestamp(),'dd');

/* Se for o primeiro atendimento do dia, precisa reposcionar a sequence */

select	count(1)
into STRICT	qt_registro_w
from	pls_controle_prot_atend a
where	a.dt_atualizacao between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp()) and ESTABLISHMENT_TIMEZONE_UTILS.endOfDay(clock_timestamp());

select	nextval('call_center_sequencial_dia_seq')
into STRICT	nr_sequencial_dia_w
;

if (qt_registro_w = 0) then
	begin
		CALL ajustar_newvalue_sequence('CALL_CENTER_SEQUENCIAL_DIA_SEQ',0);
	exception
	when others then
		EXECUTE 'DROP SEQUENCE CALL_CENTER_SEQUENCIAL_DIA_SEQ';
		EXECUTE 'CREATE SEQUENCE CALL_CENTER_SEQUENCIAL_DIA_SEQ INCREMENT BY 1 START WITH 1 MAXVALUE 999999 CYCLE';
	end;

	select	nextval('call_center_sequencial_dia_seq')
	into STRICT	nr_sequencial_dia_w
	;
	
	insert into	pls_controle_prot_atend(
				nr_sequencia, dt_atualizacao, dt_atualizacao_nrec,
				nm_usuario, nm_usuario_nrec, nr_protocolo)
	values (	
				nextval('pls_controle_prot_atend_seq'), clock_timestamp(), clock_timestamp(),
				nm_usuario_p, nm_usuario_p, nr_sequencial_dia_w);
			
	commit;
			
end if;



select	substr(max(CD_ANS),1,6)
into STRICT	cd_ans_w
from	pls_outorgante
where	(ie_protocolo_atend_w = 'S' AND cd_estabelecimento 	= cd_estabelecimento_p) or (ie_protocolo_atend_w = 'N');

nr_protocolo_atendimento_w	:= cd_ans_w || ano_w || mes_w || dia_w || lpad(nr_sequencial_dia_w,6,'0');

nr_protocolo_atendimento_p 	:= nr_protocolo_atendimento_w;
nr_sequencial_dia_p		:= nr_sequencial_dia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_nr_prot_call_center ( nr_seq_atendimento_p bigint, cd_estabelecimento_p text, nm_usuario_p text, nr_protocolo_atendimento_p INOUT text, nr_sequencial_dia_p INOUT bigint) FROM PUBLIC;

