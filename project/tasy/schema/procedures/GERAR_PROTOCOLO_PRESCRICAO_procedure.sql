-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_protocolo_prescricao ( nr_prescricao_p bigint, nm_usuario_p text, cd_protocolo_dest_p bigint, nr_seq_destino_p bigint, ie_dietas_p text, ie_solucoes_p text, ie_medicamentos_p text, ie_materiais_p text, ie_procedimentos_p text, ie_recomendacoes_p text, ie_hemodialise_p text, ie_gasoterapia_p text, ie_leite_p text, ie_itens_kit_p text, ie_hemoterapia_p text) AS $body$
DECLARE


nr_sequencia_w			bigint;
nr_seq_hd_prescr_w		bigint;
nr_seq_sol_elem_w		bigint;
nr_seq_solucao_w		bigint;
nr_seq_solucao_ww		bigint;
nr_seq_elemento_w		bigint;
cd_unidade_medida_w		varchar(30);
qt_elemento_w			double precision;
ie_tipo_hemodialise_w		varchar(15);
qt_sessao_sem_w			smallint;
qt_hora_sessao_w		smallint;
qt_min_sessao_w			smallint;
qt_fluxo_sangue_w		double precision;
nr_seq_mod_dialisador_w		bigint;
ie_ultrafiltracao_w		varchar(15);
qt_ultrafiltracao_w		double precision;
ie_tipo_dialise_w		varchar(1);
ie_tipo_peritoneal_w		varchar(15);
nr_seq_maq_cicladora_w		bigint;
qt_volume_total_w		double precision;
dt_status_w			timestamp;
ie_status_w			varchar(15);
nr_seq_diametro_agulha_w	bigint;
nr_seq_tipo_agulha_w		bigint;
nr_seq_tipo_agulha_art_w	bigint;
nr_seq_ultra_w				protocolo_hd_prescricao.nr_seq_ultra%type;
nr_seq_perfil_sodio_w		bigint;
qt_zero_um_w			bigint;
qt_um_dois_w			bigint;
qt_dois_tres_w			bigint;
qt_tres_quatro_w		bigint;
ie_ligar_prime_w		varchar(1);
qt_peso_seco_w			double precision;
ie_continuo_w			varchar(1);
cd_material_prod_w		bigint;
cd_material_dil_w		bigint;
cd_material_w			bigint;
qt_dose_w			double precision;
cd_unidade_medida_dose_w	varchar(50);
nr_agrupamento_w		bigint;
ds_observacao_w			varchar(4000);
ie_via_aplicacao_w		varchar(4000);
nr_sequencia_diluicao_w		bigint;
hr_prim_horario_w		varchar(5);
nr_sequencia_dieta_w		bigint;
nr_sequencia_proc_w		bigint;
nr_sequencia_solucao_w		bigint;
cd_intervalo_w			varchar(50);
ds_agrupador_w			varchar(50);
ds_horarios_w			varchar(2000);
ie_se_necessario_w		varchar(50);
qt_min_aplicacao_w		bigint;
qt_hora_aplicacao_w		bigint;
ie_bomba_infusao_w		varchar(5);
ie_aplic_bolus_w		varchar(5);
ie_aplic_lenta_w		varchar(5);
ie_acm_w			varchar(5);
ds_dose_diferenciada_w		varchar(255);
qt_solucao_w			double precision;
ie_urgencia_w			varchar(5);
qt_vel_infusao_w		double precision;
ie_agrupador_w			bigint;
ie_lado_w			varchar(5);
ie_objetivo_w			varchar(5);
cd_topografia_cih_w		varchar(5);
cd_microorganismo_cih_w		bigint;
cd_amostra_cih_w		bigint;
ie_origem_infeccao_w		varchar(5);
ie_indicacao_w			varchar(5);
ie_uso_antimicrobiano_w		varchar(5);
nr_seq_leite_deriv_w		bigint;
qt_volume_oral_w		integer;
qt_volume_sonda_w		integer;
nr_seq_disp_succao_w		bigint;
nr_seq_leite_prot_w		bigint;
nr_seq_prod_prot_w		bigint;
nr_seq_dil_prot_w		bigint;
nr_seq_prod_w			bigint;
qt_porcentagem_w		prescr_material.qt_porcentagem%type;
ie_categoria_w			varchar(1);
ie_grupo_hemocom_w		prescr_sol_bs_indicacao.ie_grupo_hemocom%type;
nr_seq_indicacao_w		prescr_sol_bs_indicacao.nr_seq_indicacao%type;
ds_indicacao_adic_w		prescr_sol_bs_indicacao.ds_indicacao_adic%type;
nr_seq_derivado_w		prescr_procedimento.nr_seq_derivado%type;
qt_procedimento_w		prescr_procedimento.qt_procedimento%type;
qt_vol_hemocomp_w		prescr_procedimento.qt_vol_hemocomp%type;
dt_prev_execucao_w		prescr_procedimento.dt_prev_execucao%type;
qt_veloc_inf_hemo_w		prescr_procedimento.qt_veloc_inf_hemo%type;
cd_setor_atendimento_w	prescr_procedimento.cd_setor_atendimento%type;
ie_util_hemocomponente_w	prescr_procedimento.ie_util_hemocomponente%type;
cd_procedimento_w		prescr_procedimento.cd_procedimento%type;
ie_origem_proced_w		prescr_procedimento.ie_origem_proced%type;
nr_seq_proc_interno_w	prescr_procedimento.nr_seq_proc_interno%type;
nr_seq_amostra_princ_w	prescr_procedimento.nr_seq_amostra_princ%type;
ie_tipo_proced_w		prescr_procedimento.ie_tipo_proced%type;
qt_sodio_w					double precision;
qt_bicarbonato_w			double precision;

qt_zero_um_bic_w   			bigint;
qt_um_dois_bic_w   			bigint;
qt_dois_tres_bic_w 			bigint;
qt_tres_quatro_bic_w		bigint;
qt_quatro_cinco_bic_w		bigint;
qt_cinco_seis_bic_w			bigint;
nr_seq_perfil_bic_w			bigint;
qt_quatro_cinco_w      		bigint;
qt_cinco_seis_w         	bigint;
IE_MEDICACAO_PACIENTE_W	prescr_material.IE_MEDICACAO_PACIENTE%type;


c01 CURSOR FOR
	SELECT	nr_seq_solucao
	from	prescr_solucao
	where	nr_prescricao = nr_prescricao_p;

c02 CURSOR FOR
	SELECT	nr_seq_elemento,
		cd_unidade_medida,
		qt_elemento
	from	hd_prescr_sol_elem
	where	nr_prescricao	= nr_prescricao_p
	  and	nr_seq_solucao	= nr_seq_solucao_w;

c03 CURSOR FOR
	SELECT	ie_tipo_hemodialise,
		coalesce(qt_sessao_sem,3),
		qt_hora_sessao,
		qt_min_sessao,
		qt_fluxo_sangue,
		nr_seq_mod_dialisador,
		ie_ultrafiltracao,
		qt_ultrafiltracao,
		ie_tipo_peritoneal,
		dt_status,
		ie_status,
		ie_tipo_dialise,
		qt_volume_total,
		nr_seq_maq_cicladora,
		nr_seq_diametro_agulha,
		nr_seq_tipo_agulha,
		nr_seq_tipo_agulha_art,
		nr_seq_ultra,
		nr_seq_perfil_sodio,
		qt_zero_um,
		qt_um_dois,
		qt_dois_tres,
		qt_tres_quatro,
		ie_ligar_prime,
		qt_peso_seco,
		ds_observacao,
		ie_continuo,
		ie_categoria,
		qt_sodio,
		qt_bicarbonato,
		qt_zero_um_bic,
		qt_um_dois_bic,
		qt_dois_tres_bic,
		qt_tres_quatro_bic,
		qt_quatro_cinco_bic,
		qt_cinco_seis_bic,
		nr_seq_perfil_bic,
		qt_seto_oito,
		qt_cinco_seis
	from	hd_prescricao
	where 	nr_prescricao	= nr_prescricao_p;

c04 CURSOR FOR
SELECT	nr_sequencia,
		cd_material,
		coalesce(qt_dose,coalesce(qt_unitaria,0)),
		coalesce(cd_unidade_medida_dose,cd_unidade_medida),
		coalesce(nr_agrupamento,0),
		substr(ds_observacao,1,255),
		ie_via_aplicacao,
		nr_sequencia_diluicao,
		nr_sequencia_dieta,
		nr_sequencia_proc,
		nr_sequencia_solucao,
		ie_agrupador,
		cd_intervalo,
		ds_horarios,
		ie_se_necessario,
		qt_min_aplicacao,
		qt_hora_aplicacao,
		coalesce(ie_bomba_infusao,'N'),
		coalesce(ie_aplic_bolus,'N'),
		coalesce(ie_aplic_lenta,'N'),
		coalesce(ie_acm,'N'),
		ds_dose_diferenciada,
		qt_solucao,
		coalesce(ie_urgencia,'N'),
		qt_vel_infusao,
		CASE WHEN ie_agrupador=1 THEN 'S' WHEN ie_agrupador=2 THEN 'S'  ELSE 'N' END ,
		ie_lado,
		ie_objetivo,
		cd_topografia_cih,
		cd_microorganismo_cih,
		cd_amostra_cih,
		ie_origem_infeccao,
		ie_indicacao,
		ie_uso_antimicrobiano,
		CASE WHEN ie_agrupador=1 THEN  IE_MEDICACAO_PACIENTE  ELSE null END
from 	Prescr_material
where	nr_prescricao	= nr_prescricao_p
and		ie_agrupador	in (1,3,7,8,12)
and		((ie_itens_kit_p = 'S') or (coalesce(nr_seq_kit::text, '') = ''))
order by nr_sequencia,
	ie_agrupador;

c05 CURSOR FOR
SELECT	cd_intervalo,
		ie_se_necessario,
		hr_prim_horario,
		ie_via_aplicacao,
		qt_volume_oral,
		qt_volume_sonda,
		nr_seq_disp_succao,
		nr_sequencia
from	prescr_leite_deriv
where	nr_prescricao	= nr_prescricao_p;

c06 CURSOR FOR
SELECT	cd_material,
		nr_sequencia
from	prescr_material
where	nr_prescricao		= nr_prescricao_p
and		nr_seq_leite_deriv	= nr_seq_leite_deriv_w
and		ie_agrupador 		= 16;

c07 CURSOR FOR
SELECT	cd_material,
		coalesce(qt_porcentagem,0),
		coalesce(cd_unidade_medida_dose,cd_unidade_medida)
from	prescr_material
where	nr_prescricao		= nr_prescricao_p
and		nr_sequencia_diluicao	= nr_seq_prod_w
and		ie_agrupador 		= 17;

c08 CURSOR FOR  --mat/med associados
SELECT	nr_sequencia,
		cd_material,
		coalesce(qt_dose,coalesce(qt_unitaria,0)),
		coalesce(cd_unidade_medida_dose,cd_unidade_medida),
		coalesce(nr_agrupamento,0),
		substr(ds_observacao,1,255),
		ie_via_aplicacao,
		nr_sequencia_diluicao,
		nr_sequencia_dieta,
		nr_sequencia_proc,
		nr_sequencia_solucao,
		ie_agrupador,
		cd_intervalo,
		ds_horarios,
		ie_se_necessario,
		qt_min_aplicacao,
		qt_hora_aplicacao,
		coalesce(ie_bomba_infusao,'N'),
		coalesce(ie_aplic_bolus,'N'),
		coalesce(ie_aplic_lenta,'N'),
		coalesce(ie_acm,'N'),
		ds_dose_diferenciada,
		qt_solucao,
		coalesce(ie_urgencia,'N'),
		qt_vel_infusao,
		CASE WHEN ie_agrupador=1 THEN 'S' WHEN ie_agrupador=2 THEN 'S'  ELSE 'N' END ,
		ie_lado,
		ie_objetivo,
		cd_topografia_cih,
		cd_microorganismo_cih,
		cd_amostra_cih,
		ie_origem_infeccao,
		ie_indicacao,
		ie_uso_antimicrobiano
from 	Prescr_material
where	nr_prescricao	= nr_prescricao_p
and		ie_agrupador	= 5
and		((ie_itens_kit_p = 'S') or (coalesce(cd_kit_material::text, '') = ''))
order by nr_sequencia,
	ie_agrupador;
	
C09 CURSOR FOR
SELECT	a.ie_grupo_hemocom,
		a.nr_seq_indicacao,
		a.ds_indicacao_adic		
from	prescr_sol_bs_indicacao a,
		prescr_solic_bco_sangue b
where	b.nr_prescricao = nr_prescricao_p
and		a.nr_seq_solic_bs = b.nr_sequencia	
order by a.nr_sequencia;	

C10 CURSOR FOR
SELECT	a.nr_seq_derivado,
		a.qt_procedimento, 
		a.qt_vol_hemocomp, 
		a.dt_prev_execucao,
		a.cd_intervalo, 
		a.qt_veloc_inf_hemo,
		a.cd_setor_atendimento, 
		a.ie_util_hemocomponente,
		a.ds_observacao,
		a.cd_procedimento,
		a.ie_origem_proced,
		a.nr_seq_proc_interno,
		a.nr_seq_amostra_princ,
		a.ie_tipo_proced
from	prescr_procedimento a,
		prescr_solic_bco_sangue b
where	a.nr_prescricao = nr_prescricao_p
and 	a.nr_seq_solic_sangue = b.nr_sequencia
and		obter_se_exibe_proced(a.nr_prescricao, a.nr_sequencia, a.ie_tipo_proced,'BSHE') = 'S'
order by a.nr_sequencia;		


BEGIN

delete	from protocolo_hd_prescricao
where	cd_protocolo 		= cd_protocolo_dest_p
and	nr_seq_protocolo	= nr_seq_destino_p;

delete	from protocolo_medic_dieta
where	cd_protocolo 	= cd_protocolo_dest_p
and	nr_sequencia	= nr_seq_destino_p;

delete	from protocolo_medic_jejum
where	cd_protocolo 	= cd_protocolo_dest_p
and	nr_sequencia	= nr_seq_destino_p;

delete	from protocolo_medic_proc
where	cd_protocolo 	= cd_protocolo_dest_p
and	nr_sequencia	= nr_seq_destino_p;

delete	from protocolo_medic_rec
where	cd_protocolo 	= cd_protocolo_dest_p
and	nr_sequencia	= nr_seq_destino_p;

delete	from protocolo_medic_sol_esq
where	cd_protocolo 	= cd_protocolo_dest_p
and	nr_seq_subitem	= nr_seq_destino_p;

delete	from protocolo_medic_solucao
where	cd_protocolo 	= cd_protocolo_dest_p
and	nr_sequencia	= nr_seq_destino_p;

delete	from protocolo_medic_material
where	cd_protocolo 	= cd_protocolo_dest_p
and	nr_sequencia	= nr_seq_destino_p;

delete	from protocolo_medic_gas
where	cd_protocolo 	= cd_protocolo_dest_p
and	nr_seq_protocolo = nr_seq_destino_p;

delete	from protocolo_medic_elem
where	cd_protocolo	= cd_protocolo_dest_p
and	nr_sequencia	= nr_seq_destino_p;

delete	from protocolo_medic_npt
where	cd_protocolo	= cd_protocolo_dest_p
and	nr_sequencia	= nr_seq_destino_p;

delete	from prot_hd_prescr_sol_elem
where	cd_protocolo	= cd_protocolo_dest_p
and	nr_seq_medic	= nr_seq_destino_p;

if (ie_dietas_p = 'S')		then
	insert into protocolo_medic_dieta(
		cd_protocolo,
		nr_sequencia,
		nr_seq_dieta,
		cd_dieta,
		dt_atualizacao,
		nm_usuario,
		ie_destino_dieta,
		ie_refeicao,
		ds_observacao,
		cd_intervalo)
	SELECT 	cd_protocolo_dest_p,
		nr_seq_destino_p,
		nr_sequencia,
		cd_dieta,
		clock_timestamp(),
		nm_usuario_p,
		ie_destino_dieta,
		ie_refeicao,
		substr(ds_observacao,1,255),
		cd_intervalo
	from 	Prescr_dieta
	where 	nr_prescricao	= nr_prescricao_p;

	insert into protocolo_medic_jejum(cd_protocolo,
		nr_sequencia,
		nr_seq_jejum,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_tipo,
		nr_seq_objetivo,
		ie_inicio,
		dt_inicio,
		dt_fim,
		dt_evento,
		qt_min_ant,
		qt_min_depois,
		qt_hora_ant,
		qt_hora_depois,
		ds_evento,
		ds_observacao,
		ie_repete_copia)
	SELECT	cd_protocolo_dest_p,
		nr_seq_destino_p,
		nr_sequencia,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_tipo,
		nr_seq_objetivo,
		ie_inicio,
		dt_inicio,
		dt_fim,
		dt_evento,
		qt_min_ant,
		qt_min_depois,
		qt_hora_ant,
		qt_hora_depois,
		ds_evento,
		substr(ds_observacao,1,255),
		ie_repete_copia
	from	rep_jejum
	where 	nr_prescricao	= nr_prescricao_p;
end if;

if (ie_procedimentos_p = 'S')	then --Prescrição de Procedimentos
	insert into protocolo_medic_proc(
		cd_protocolo,
		nr_sequencia,
		nr_seq_proc,
		cd_procedimento,
		ie_origem_proced,
	    qt_procedimento,
		dt_atualizacao,
		nm_usuario,
		cd_intervalo,
		ds_observacao,
		ds_dado_clinico,
		cd_material_exame,
		nr_seq_exame,
		cd_setor_atendimento,
		ie_se_necessario,
		ie_acm,
		ds_material_especial,
		ie_urgencia,
		nr_seq_proc_interno,
		ie_lado,
		ie_multiplicar_quant,
		ie_respiracao,
		cd_mod_vent,
		ie_disp_resp_esp,
		qt_fluxo_oxigenio,
		dt_prev_execucao,
		ds_justificativa,
		nr_seq_prot_glic,
		cd_procedimento_lcb,
		nr_seq_amostra_princ,
		ie_anatomia)
	SELECT
		cd_protocolo_dest_p,
		nr_seq_destino_p,
		nr_sequencia,
		cd_procedimento,
		ie_origem_proced,
		qt_procedimento,
		clock_timestamp(),
		nm_usuario_p,
		cd_intervalo,
		substr(ds_observacao,1,255),
		substr(ds_dado_clinico,1,255),
		cd_material_exame,
		nr_seq_exame,
		cd_setor_atendimento,
		coalesce(ie_se_necessario,'N'),
		coalesce(ie_acm,'N'),
		substr(ds_material_especial,1,45),
		coalesce(ie_urgencia,'N'),
		nr_seq_proc_interno,
		ie_lado,
		'S',
		ie_respiracao,
		cd_mod_vent,
		ie_disp_resp_esp,
		qt_fluxo_oxigenio,
		dt_prev_execucao,
		ds_justificativa,
		nr_seq_prot_glic,
		nr_seq_proc_interno,
		nr_seq_amostra_princ,
		CASE WHEN ie_tipo_proced='AP' THEN  'S'  ELSE 'N' END
	from 	prescr_procedimento
	where 	nr_prescricao	= nr_prescricao_p
	and		coalesce(nr_seq_solic_sangue::text, '') = '';
	
	open c08;
	loop
	fetch c08 into
		nr_sequencia_w,
		cd_material_w,
		qt_dose_w,
		cd_unidade_medida_dose_w,
		nr_agrupamento_w,
		ds_observacao_w,
		ie_via_aplicacao_w,
		nr_sequencia_diluicao_w,
		nr_sequencia_dieta_w,
		nr_sequencia_proc_w,
		nr_sequencia_solucao_w,
		ie_agrupador_w,
		cd_intervalo_w,
		ds_horarios_w,
		ie_se_necessario_w,
		qt_min_aplicacao_w,
		qt_hora_aplicacao_w,
		ie_bomba_infusao_w,
		ie_aplic_bolus_w,
		ie_aplic_lenta_w,
		ie_acm_w,
		ds_dose_diferenciada_w,
		qt_solucao_w,
		ie_urgencia_w,
		qt_vel_infusao_w,
		ds_agrupador_w,
		ie_lado_w,
		ie_objetivo_w,
		cd_topografia_cih_w,
		cd_microorganismo_cih_w,
		cd_amostra_cih_w,
		ie_origem_infeccao_w,
		ie_indicacao_w,
		ie_uso_antimicrobiano_w;
	EXIT WHEN NOT FOUND; /* apply on C08 */
		begin
		insert into protocolo_medic_material(
			cd_protocolo,
			nr_sequencia,
			nr_seq_material,
			cd_material,
			qt_dose,
			cd_unidade_medida,
			ds_dias_aplicacao,
			dt_atualizacao,
			nm_usuario,
			nr_agrupamento,
			ds_recomendacao,
			ie_via_aplicacao,
			nr_seq_diluicao,
			nr_seq_dieta,
			nr_seq_proc,
			nr_seq_solucao,
			ie_agrupador,
			cd_intervalo,
			ds_horarios,
			ie_se_necessario,
			qt_minuto_aplicacao,
			qt_hora_aplicacao,
			ie_bomba_infusao,
			ie_aplic_bolus,
			ie_aplic_lenta,
			ie_acm,
			ds_dose_diferenciada,
			qt_solucao,
			ie_urgencia,
			qt_vel_infusao,
			ie_intervalo_fixo,
			ie_multiplicar_dose,
			ie_lado,
			ie_objetivo,
			cd_topografia_cih,
			cd_microorganismo_cih,
			cd_amostra_cih,
			ie_origem_infeccao,
			ie_indicacao,
			ie_uso_antimicrobiano)
		values (cd_protocolo_dest_p,
			nr_seq_destino_p,
			nr_sequencia_w,
			cd_material_w,
			qt_dose_w,
			cd_unidade_medida_dose_w,
			'',
			clock_timestamp(),
			nm_usuario_p,
			nr_agrupamento_w,
			ds_observacao_w,
			ie_via_aplicacao_w,
			nr_sequencia_diluicao_w,
			nr_sequencia_dieta_w,
			nr_sequencia_proc_w,
			nr_sequencia_solucao_w,
			ie_agrupador_w,
			cd_intervalo_w,
			ds_horarios_w,
			ie_se_necessario_w,
			qt_min_aplicacao_w,
			qt_hora_aplicacao_w,
			ie_bomba_infusao_w,
			ie_aplic_bolus_w,
			ie_aplic_lenta_w,
			ie_acm_w,
			ds_dose_diferenciada_w,
			qt_solucao_w,
			ie_urgencia_w,
			qt_vel_infusao_w,
			'N',
			ds_agrupador_w,
			ie_lado_w,
			ie_objetivo_w,
			cd_topografia_cih_w,
			cd_microorganismo_cih_w,
			cd_amostra_cih_w,
			ie_origem_infeccao_w,
			ie_indicacao_w,
			ie_uso_antimicrobiano_w);
		exception when others then
			null;
		end;

	end loop;
	close c08;
end if;

if (ie_recomendacoes_p = 'S')	then --Recomendação da Prescrição
	insert into protocolo_medic_rec(
		cd_protocolo,
		nr_sequencia,
		nr_seq_rec,
		dt_atualizacao,
		nm_usuario,
		ds_recomendacao,
		qt_recomendacao,
		cd_recomendacao,
		nr_seq_classif,
		cd_intervalo,
		ds_horarios,
		cd_kit,
		ie_acm,
		ie_se_necessario,
		ie_urgencia,
		nr_seq_topografia)
	SELECT
		cd_protocolo_dest_p,
		nr_seq_destino_p,
		nr_sequencia,
		clock_timestamp(),
		nm_usuario_p,
		substr(ds_recomendacao,1,255),
		qt_recomendacao,
		cd_recomendacao,
		nr_seq_classif,
		cd_intervalo,
		ds_horarios,
		cd_kit,
		ie_acm,
		ie_se_necessario,
		ie_urgencia,
		nr_seq_topografia
	from 	prescr_recomendacao
	where 	nr_prescricao	= nr_prescricao_p;
end if;

if (ie_hemodialise_p = 'S') then
	open c03;
	loop

		fetch c03 into	ie_tipo_hemodialise_w,
				qt_sessao_sem_w,
				qt_hora_sessao_w,
				qt_min_sessao_w,
				qt_fluxo_sangue_w,
				nr_seq_mod_dialisador_w,
				ie_ultrafiltracao_w,
				qt_ultrafiltracao_w,
				ie_tipo_peritoneal_w,
				dt_status_w,
				ie_status_w,
				ie_tipo_dialise_w,
				qt_volume_total_w,
				nr_seq_maq_cicladora_w,
				nr_seq_diametro_agulha_w,
				nr_seq_tipo_agulha_w,
				nr_seq_tipo_agulha_art_w,
				nr_seq_ultra_w,
				nr_seq_perfil_sodio_w,
				qt_zero_um_w,
				qt_um_dois_w,
				qt_dois_tres_w,
				qt_tres_quatro_w,
				ie_ligar_prime_w,
				qt_peso_seco_w,
				ds_observacao_w,
				ie_continuo_w,
				ie_categoria_w,
				qt_sodio_w,
				qt_bicarbonato_w,
				qt_zero_um_bic_w,   	
				qt_um_dois_bic_w,   	
				qt_dois_tres_bic_w, 	
				qt_tres_quatro_bic_w,
				qt_quatro_cinco_bic_w,
				qt_cinco_seis_bic_w,	
				nr_seq_perfil_bic_w,	
				qt_quatro_cinco_w,
				qt_cinco_seis_w;
			EXIT WHEN NOT FOUND; /* apply on c03 */

		/* obter sequencia protocolo HD prescrição */

		select	nextval('protocolo_hd_prescricao_seq')
		into STRICT	nr_seq_hd_prescr_w
		;

		insert into protocolo_hd_prescricao(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_protocolo,
			nr_seq_protocolo,
			ie_tipo_hemodialise,
			qt_sessao_sem,
			qt_hora_sessao,
			qt_min_sessao,
			qt_fluxo_sangue,
			nr_seq_mod_dialisador,
			ie_ultrafiltracao,
			qt_ultrafiltracao,
			ie_tipo_peritoneal,
			dt_status,
			ie_status,
			ie_tipo_dialise,
			qt_volume_total,
			nr_seq_maq_cicladora,
			nr_seq_diametro_agulha,
			nr_seq_tipo_agulha,
			nr_seq_tipo_agulha_art,
			nr_seq_ultra,
			nr_seq_perfil_sodio,
			qt_zero_um,
			qt_um_dois,
			qt_dois_tres,
			qt_tres_quatro,
			ie_ligar_prime,
			qt_peso_seco,
			ds_observacao,
			ie_continuo,
			ie_categoria,
			qt_sodio,
			qt_bicarbonato,
			qt_zero_um_bic,
			qt_um_dois_bic,
			qt_dois_tres_bic,
			qt_tres_quatro_bic,
			qt_quatro_cinco_bic,
			qt_cinco_seis_bic,
			nr_seq_perfil_bic,
			qt_quatro_cinco,
			qt_cinco_seis)
		values (
			nr_seq_hd_prescr_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_protocolo_dest_p,
			nr_seq_destino_p,
			ie_tipo_hemodialise_w,
			qt_sessao_sem_w,
			qt_hora_sessao_w,
			qt_min_sessao_w,
			qt_fluxo_sangue_w,
			nr_seq_mod_dialisador_w,
			ie_ultrafiltracao_w,
			qt_ultrafiltracao_w,
			ie_tipo_peritoneal_w,
			dt_status_w,
			ie_status_w,
			ie_tipo_dialise_w,
			qt_volume_total_w,
			nr_seq_maq_cicladora_w,
			nr_seq_diametro_agulha_w,
			nr_seq_tipo_agulha_w,
			nr_seq_tipo_agulha_art_w,
			nr_seq_ultra_w,
			nr_seq_perfil_sodio_w,
			qt_zero_um_w,
			qt_um_dois_w,
			qt_dois_tres_w,
			qt_tres_quatro_w,
			ie_ligar_prime_w,
			qt_peso_seco_w,
			ds_observacao_w,
			ie_continuo_w,
			ie_categoria_w,
			qt_sodio_w,
			qt_bicarbonato_w,
			qt_zero_um_bic_w,
			qt_um_dois_bic_w,
			qt_dois_tres_bic_w,
			qt_tres_quatro_bic_w,
			qt_quatro_cinco_bic_w,
			qt_cinco_seis_bic_w,
			nr_seq_perfil_bic_w,
			qt_quatro_cinco_w,
			qt_cinco_seis_w);

	end loop;
	close c03;
end if;

if (ie_solucoes_p = 'S')	then --Soluções da hemodiálise
	insert into protocolo_medic_solucao(
		cd_protocolo,
		nr_sequencia,
		nr_seq_solucao,
		nr_agrupamento,
		dt_atualizacao,
		nm_usuario,
		ie_tipo_dosagem,
		qt_dosagem,
		qt_volume,
		qt_solucao_total,
		qt_tempo_aplicacao,
		nr_etapas,
		ie_bomba_infusao,
		ds_horarios,
		ie_esquema_alternado,
		ie_calc_aut,
		ie_acm,
		qt_hora_fase,
		ds_solucao,
		ie_tipo_solucao,
		qt_temp_solucao,
		ie_momento,
		ie_pos_dialisador,
		ie_hemodialise,
		nr_seq_protocolo,
		ie_unid_vel_inf,
		ds_orientacao,
		nr_seq_dialise,
		ie_solucao_pca,
		ie_tipo_analgesia,
		ie_pca_modo_prog,
		qt_dose_inicial_pca,
		qt_vol_infusao_pca,
		qt_bolus_pca,
		qt_intervalo_bloqueio,
		qt_limite_quatro_hora,
		nr_seq_interno,
		ie_via_aplicacao,
		cd_intervalo)
	SELECT
		cd_protocolo_dest_p,
		nr_seq_destino_p,
		nr_seq_solucao,
		nr_agrupamento,
		clock_timestamp(),
		nm_usuario_p,
		ie_tipo_dosagem,
		qt_dosagem,
		qt_volume,
		qt_solucao_total,
		qt_tempo_aplicacao,
		nr_etapas,
		ie_bomba_infusao,
		ds_horarios,
		coalesce(ie_esquema_alternado, 'N'),
		coalesce(ie_calc_aut,'S'),
		coalesce(ie_acm,'N'),
		qt_hora_fase,
		ds_solucao,
		ie_tipo_solucao,
		qt_temp_solucao,
		ie_momento,
		ie_pos_dialisador,
		ie_hemodialise,
		nr_seq_protocolo,
		ie_unid_vel_inf,
		ds_orientacao,
		nr_seq_hd_prescr_w,
		ie_solucao_pca,
		ie_tipo_analgesia,
		ie_pca_modo_prog,
		qt_dose_inicial_pca,
		qt_vol_infusao_pca,
		qt_bolus_pca,
		qt_intervalo_bloqueio,
		qt_limite_quatro_hora,
		nextval('protocolo_medic_solucao_seq'),
		ie_via_aplicacao,
		cd_intervalo
	from 	prescr_solucao
	where 	nr_prescricao	= nr_prescricao_p;

	insert into protocolo_medic_material(
		cd_protocolo	,
		nr_sequencia,
		nr_seq_material,
		cd_material,
		qt_dose,
		cd_unidade_medida,
		ds_dias_aplicacao,
		dt_atualizacao,
		nm_usuario,
		nr_agrupamento,
		ds_recomendacao,
		ie_via_aplicacao,
		nr_seq_diluicao,
		nr_seq_dieta,
		nr_seq_proc,
		nr_seq_solucao,
		ie_agrupador,
		cd_intervalo,
		ds_horarios,
		ie_se_necessario,
		qt_minuto_aplicacao,
		qt_hora_aplicacao,
		ie_bomba_infusao,
		ie_aplic_bolus,
		ie_aplic_lenta,
		ie_acm,
		ds_dose_diferenciada,
		qt_solucao,
		ie_urgencia,
		qt_vel_infusao,
		ie_intervalo_fixo,
		ie_multiplicar_dose,
		ie_lado)
	SELECT
		cd_protocolo_dest_p,
		nr_seq_destino_p,
		nr_sequencia,
		cd_material,
		coalesce(qt_dose,coalesce(qt_unitaria,0)),
		coalesce(cd_unidade_medida_dose,cd_unidade_medida),
		'',
		clock_timestamp(),
		nm_usuario_p,
		coalesce(nr_agrupamento,0),
		substr(ds_observacao,1,255),
		ie_via_aplicacao,
		nr_sequencia_diluicao,
		nr_sequencia_dieta,
		nr_sequencia_proc,
		nr_sequencia_solucao,
		ie_agrupador,
		cd_intervalo,
		ds_horarios,
		ie_se_necessario,
		qt_min_aplicacao,
		qt_hora_aplicacao,
		coalesce(ie_bomba_infusao,'N'),
		coalesce(ie_aplic_bolus,'N'),
		coalesce(ie_aplic_lenta,'N'),
		coalesce(ie_acm,'N'),
		ds_dose_diferenciada,
		qt_solucao,
		coalesce(ie_urgencia,'N'),
		qt_vel_infusao,
		'N',
		CASE WHEN ie_agrupador=1 THEN 'S' WHEN ie_agrupador=2 THEN 'S'  ELSE 'N' END ,
		ie_lado
	from 	Prescr_material
	where 	nr_prescricao	= nr_prescricao_p
	and		ie_agrupador in (4, 13);

	--Esquema de solução
	insert into protocolo_medic_sol_esq(
		nr_sequencia,
		cd_protocolo,
		nr_seq_subitem,
		nr_seq_solucao,
		dt_atualizacao,
		nm_usuario,
		qt_volume,
		qt_dosagem,
		ds_horario)
	SELECT
		nextval('protocolo_medic_sol_esq_seq'),
		cd_protocolo_dest_p,
		nr_seq_destino_p,
		nr_seq_solucao,
		clock_timestamp(),
		nm_usuario_p,
		qt_volume,
		qt_dosagem,
		ds_horario
	from 	prescr_solucao_esquema
	where	nr_prescricao = nr_prescricao_p;
end if;

if (ie_medicamentos_p = 'S')	then --Prescrição de Material
	open C04;
	loop
	fetch C04 into
		nr_sequencia_w,
		cd_material_w,
		qt_dose_w,
		cd_unidade_medida_dose_w,
		nr_agrupamento_w,
		ds_observacao_w,
		ie_via_aplicacao_w,
		nr_sequencia_diluicao_w,
		nr_sequencia_dieta_w,
		nr_sequencia_proc_w,
		nr_sequencia_solucao_w,
		ie_agrupador_w,
		cd_intervalo_w,
		ds_horarios_w,
		ie_se_necessario_w,
		qt_min_aplicacao_w,
		qt_hora_aplicacao_w,
		ie_bomba_infusao_w,
		ie_aplic_bolus_w,
		ie_aplic_lenta_w,
		ie_acm_w,
		ds_dose_diferenciada_w,
		qt_solucao_w,
		ie_urgencia_w,
		qt_vel_infusao_w,
		ds_agrupador_w,
		ie_lado_w,
		ie_objetivo_w,
		cd_topografia_cih_w,
		cd_microorganismo_cih_w,
		cd_amostra_cih_w,
		ie_origem_infeccao_w,
		ie_indicacao_w,
		ie_uso_antimicrobiano_w,
		ie_medicacao_paciente_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
		begin
		insert into protocolo_medic_material(
			cd_protocolo,
			nr_sequencia,
			nr_seq_material,
			cd_material,
			qt_dose,
			cd_unidade_medida,
			ds_dias_aplicacao,
			dt_atualizacao,
			nm_usuario,
			nr_agrupamento,
			ds_recomendacao,
			ie_via_aplicacao,
			nr_seq_diluicao,
			nr_seq_dieta,
			nr_seq_proc,
			nr_seq_solucao,
			ie_agrupador,
			cd_intervalo,
			ds_horarios,
			ie_se_necessario,
			qt_minuto_aplicacao,
			qt_hora_aplicacao,
			ie_bomba_infusao,
			ie_aplic_bolus,
			ie_aplic_lenta,
			ie_acm,
			ds_dose_diferenciada,
			qt_solucao,
			ie_urgencia,
			qt_vel_infusao,
			ie_intervalo_fixo,
			ie_multiplicar_dose,
			ie_lado,
			ie_objetivo,
			cd_topografia_cih,
			cd_microorganismo_cih,
			cd_amostra_cih,
			ie_origem_infeccao,
			ie_indicacao,
			ie_uso_antimicrobiano,
			IE_MEDICACAO_PACIENTE)
		values (cd_protocolo_dest_p,
			nr_seq_destino_p,
			nr_sequencia_w,
			cd_material_w,
			qt_dose_w,
			cd_unidade_medida_dose_w,
			'',
			clock_timestamp(),
			nm_usuario_p,
			nr_agrupamento_w,
			ds_observacao_w,
			ie_via_aplicacao_w,
			nr_sequencia_diluicao_w,
			nr_sequencia_dieta_w,
			nr_sequencia_proc_w,
			nr_sequencia_solucao_w,
			ie_agrupador_w,
			cd_intervalo_w,
			ds_horarios_w,
			ie_se_necessario_w,
			qt_min_aplicacao_w,
			qt_hora_aplicacao_w,
			ie_bomba_infusao_w,
			ie_aplic_bolus_w,
			ie_aplic_lenta_w,
			ie_acm_w,
			ds_dose_diferenciada_w,
			qt_solucao_w,
			ie_urgencia_w,
			qt_vel_infusao_w,
			'N',
			ds_agrupador_w,
			ie_lado_w,
			ie_objetivo_w,
			cd_topografia_cih_w,
			cd_microorganismo_cih_w,
			cd_amostra_cih_w,
			ie_origem_infeccao_w,
			ie_indicacao_w,
			ie_uso_antimicrobiano_w,
			IE_MEDICACAO_PACIENTE_W);
		exception when others then
			null;
		end;

	end loop;
	close C04;

end if;

if (ie_materiais_p = 'S')	then --Prescrição de Material
	insert into protocolo_medic_material(
		cd_protocolo	,
		nr_sequencia,
		nr_seq_material,
		cd_material,
		qt_dose,
		cd_unidade_medida,
		ds_dias_aplicacao,
		dt_atualizacao,
		nm_usuario,
		nr_agrupamento,
		ds_recomendacao,
		ie_via_aplicacao,
		nr_seq_diluicao,
		nr_seq_dieta,
		nr_seq_proc,
		nr_seq_solucao,
		ie_agrupador,
		cd_intervalo,
		ds_horarios,
		ie_se_necessario,
		qt_minuto_aplicacao,
		qt_hora_aplicacao,
		ie_bomba_infusao,
		ie_aplic_bolus,
		ie_aplic_lenta,
		ie_acm,
		ds_dose_diferenciada,
		qt_solucao,
		ie_urgencia,
		qt_vel_infusao,
		ie_intervalo_fixo,
		ie_multiplicar_dose,
		ie_lado,
		IE_OBJETIVO,
		CD_TOPOGRAFIA_CIH,
		cd_microorganismo_cih,
		cd_amostra_cih,
		ie_origem_infeccao,
		ie_indicacao,
		ie_uso_antimicrobiano)
	SELECT
		cd_protocolo_dest_p,
		nr_seq_destino_p,
		nr_sequencia,
		cd_material,
		coalesce(qt_dose,coalesce(qt_unitaria,0)),
		coalesce(cd_unidade_medida_dose,cd_unidade_medida),
		'',
		clock_timestamp(),
		nm_usuario_p,
		coalesce(nr_agrupamento,0),
		substr(ds_observacao,1,255),
		ie_via_aplicacao,
		nr_sequencia_diluicao,
		nr_sequencia_dieta,
		nr_sequencia_proc,
		nr_sequencia_solucao,
		ie_agrupador,
		cd_intervalo,
		ds_horarios,
		ie_se_necessario,
		qt_min_aplicacao,
		qt_hora_aplicacao,
		coalesce(ie_bomba_infusao,'N'),
		coalesce(ie_aplic_bolus,'N'),
		coalesce(ie_aplic_lenta,'N'),
		coalesce(ie_acm,'N'),
		ds_dose_diferenciada,
		qt_solucao,
		coalesce(ie_urgencia,'N'),
		qt_vel_infusao,
		'N',
		CASE WHEN ie_agrupador=1 THEN 'S' WHEN ie_agrupador=2 THEN 'S'  ELSE 'N' END ,
		ie_lado,
		IE_OBJETIVO,
		CD_TOPOGRAFIA_CIH,
		cd_microorganismo_cih,
		cd_amostra_cih,
		ie_origem_infeccao,
		ie_indicacao,
		ie_uso_antimicrobiano
	from 	Prescr_material
	where 	nr_prescricao	= nr_prescricao_p
	and	ie_agrupador = 2;

end if;

if (ie_dietas_p = 'S')	then --Elementos da Nutrição do Paciente
	insert into protocolo_medic_npt(
		cd_protocolo,
		nr_sequencia,
		nr_seq_npt,
		dt_atualizacao,
		nm_usuario,
		nr_seq_fator_ativ,
		nr_seq_fator_stress,
		pr_proteina,
		pr_lipidio,
		pr_carboidrato,
		qt_kcal_prot,
		qt_kcal_lipidio,
		qt_kcal_carboidrato,
		qt_kcal_total,
		qt_kcal_kg,
		qt_grama_prot_kg_dia,
		pr_npt,
		qt_fase_npt,
		ie_bomba_infusao,
		qt_gotejamento_npt)
	SELECT
		cd_protocolo_dest_p,
		nr_seq_destino_p,
		nr_sequencia,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_fator_ativ,
		nr_seq_fator_stress,
		pr_proteina,
		pr_lipidio,
		pr_carboidrato,
		qt_kcal_prot,
		qt_kcal_lipidio,
		qt_kcal_carboidrato,
		qt_kcal_total,
		qt_kcal_kg,
		qt_grama_prot_kg_dia,
		pr_npt,
		qt_fase_npt,
		ie_bomba_infusao,
		qt_gotejamento_npt
	from	nut_paciente
	where	nr_prescricao = nr_prescricao_p;


	select	max(nr_sequencia)
	into STRICT	nr_sequencia_w
	from	nut_paciente
	where	nr_prescricao = nr_prescricao_p;

	insert into protocolo_medic_elem(
		cd_protocolo,
		nr_sequencia,
		nr_seq_elem,
		nr_seq_prot_npt,
		nr_seq_elemento,
		dt_atualizacao,
		nm_usuario,
		qt_kcal,
		qt_elemento,
		nr_seq_elem_unid_med,
		nr_seq_elem_mat,
		qt_volume,
		qt_vol_1_fase,
		qt_vol_2_fase,
		qt_vol_3_fase,
		cd_unid_med_prescr,
		qt_prescricao,
		qt_dispensar)
	SELECT
		cd_protocolo_dest_p,
		nr_seq_destino_p,
		nr_sequencia,
		nr_seq_nut_pac,
		nr_seq_elemento,
		clock_timestamp(),
		nm_usuario_p,
		qt_kcal,
		qt_elemento,
		nr_seq_elem_unid_med,
		nr_seq_elem_mat,
		qt_volume,
		qt_vol_1_fase,
		qt_vol_2_fase,
		qt_vol_3_fase,
		cd_unid_med_prescr,
		qt_prescricao,
		qt_dispensar
	from	nut_paciente_elemento
	where	nr_seq_nut_pac = nr_sequencia_w;
end if;

if (ie_hemodialise_p = 'S')	then --Elementos do protocolo de solução de hemodiálise
	open c01;
	loop

		fetch c01 into	nr_seq_solucao_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */

		if (nr_seq_solucao_w IS NOT NULL AND nr_seq_solucao_w::text <> '') then


		open c02;
		loop

		fetch c02 into	nr_seq_elemento_w,
				cd_unidade_medida_w,
				qt_elemento_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */

			select	nextval('prot_hd_prescr_sol_elem_seq')
			into STRICT	nr_seq_sol_elem_w
			;

			insert into prot_hd_prescr_sol_elem(
				nr_sequencia,
				cd_protocolo,
				nr_seq_medic,
				nr_seq_solucao,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_elemento,
				cd_unidade_medida,
				qt_elemento)
			values (
				nr_seq_sol_elem_w,
				cd_protocolo_dest_p,
				nr_seq_destino_p,
				nr_seq_solucao_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_elemento_w,
				cd_unidade_medida_w,
				qt_elemento_w);
		end loop;
		close c02;
		end if;
	end loop;
	close c01;
end if;

if (ie_gasoterapia_p = 'S') then
	insert into protocolo_medic_gas(
		cd_protocolo,
		nr_seq_protocolo,
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ie_respiracao,
		ie_disp_resp_esp,
		cd_modalidade_vent,
		nr_seq_gas,
		ie_modo_adm,
		ie_inicio,
		ie_unidade_medida,
		qt_gasoterapia,
		qt_freq_vent,
		ds_observacao,
		IE_ROTINA)
	SELECT	cd_protocolo_dest_p,
		nr_seq_destino_p,
		nextval('protocolo_medic_gas_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		ie_respiracao,
		ie_disp_resp_esp,
		cd_modalidade_vent,
		nr_seq_gas,
		ie_modo_adm,
		ie_inicio,
		ie_unidade_medida,
		qt_gasoterapia,
		qt_freq_vent,
		ds_observacao,
		'N'
	from 	prescr_gasoterapia
	where 	nr_prescricao	= nr_prescricao_p;
end if;

if (ie_leite_p = 'S') then

	open C05;
	loop
	fetch C05 into
		cd_intervalo_w,
		ie_se_necessario_w,
		hr_prim_horario_w,
		ie_via_aplicacao_w,
		qt_volume_oral_w,
		qt_volume_sonda_w,
		nr_seq_disp_succao_w,
		nr_seq_leite_deriv_w;
	EXIT WHEN NOT FOUND; /* apply on C05 */
		begin

		select	nextval('protocolo_medic_leite_seq')
		into STRICT	nr_seq_leite_prot_w
		;

		insert into protocolo_medic_leite(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_protocolo,
			nr_seq_protocolo,
			cd_intervalo,
			ie_se_necessario,
			hr_prim_horario,
			ie_via_aplicacao,
			qt_volume_oral,
			qt_volume_sonda,
			nr_seq_disp_succao)
		values (nr_seq_leite_prot_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				cd_protocolo_dest_p,
				nr_seq_destino_p,
				cd_intervalo_w,
				ie_se_necessario_w,
				hr_prim_horario_w,
				ie_via_aplicacao_w,
				qt_volume_oral_w,
				qt_volume_sonda_w,
				nr_seq_disp_succao_w);

		open C06;
		loop
		fetch C06 into
			cd_material_prod_w,
			nr_seq_prod_w;
		EXIT WHEN NOT FOUND; /* apply on C06 */
			begin

			select	nextval('protocolo_medic_produto_seq')
			into STRICT	nr_seq_prod_prot_w
			;

			insert into protocolo_medic_produto(cd_material,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nm_usuario,
				nm_usuario_nrec,
				nr_seq_prot_leite,
				nr_sequencia)
			values (cd_material_prod_w,
					clock_timestamp(),
					clock_timestamp(),
					nm_usuario_p,
					nm_usuario_p,
					nr_seq_leite_prot_w,
					nr_seq_prod_prot_w);

			open C07;
			loop
			fetch C07 into
				cd_material_dil_w,
				qt_porcentagem_w,
				cd_unidade_medida_w;
			EXIT WHEN NOT FOUND; /* apply on C07 */
				begin

				select	nextval('protocolo_medic_prod_adic_seq')
				into STRICT	nr_seq_dil_prot_w
				;

				insert into protocolo_medic_prod_adic(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_produto,
					cd_material,
					qt_porcentagem,
					cd_unidade_medida_dose)
				values (nr_seq_dil_prot_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_prod_prot_w,
						cd_material_dil_w,
						qt_porcentagem_w,
						cd_unidade_medida_w);

				end;
			end loop;
			close C07;

			end;
		end loop;
		close C06;

		end;
	end loop;
	close C05;

end if;

if (ie_hemoterapia_p = 'S') then

	select nextval('prot_solic_bco_sangue_seq')
	into STRICT	nr_sequencia_w
	;
	

	insert into prot_solic_bco_sangue(nr_sequencia,
				cd_protocolo,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nm_usuario,
				nm_usuario_nrec,
				nr_seq_protocolo,		
				ie_porte_cirurgico,
				ie_tipo,
				ie_tipo_paciente,
				ie_reserva)
		SELECT  nr_sequencia_w,
				cd_protocolo_dest_p,
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_p,
				nm_usuario_p,
				nr_seq_destino_p,
				ie_porte_cirurgico, 
				ie_tipo,
				ie_tipo_paciente,
				ie_reserva
		from	prescr_solic_bco_sangue
		where	nr_prescricao = nr_prescricao_p;
		
	open C09;
	loop
	fetch C09 into	
		ie_grupo_hemocom_w,
		nr_seq_indicacao_w,
		ds_indicacao_adic_w;
	EXIT WHEN NOT FOUND; /* apply on C09 */
		begin		
		
		insert into protocolo_solic_indicacao(nr_sequencia,	
					nr_seq_solic_bs, 		
					nm_usuario_nrec,
					nm_usuario, 		 
					dt_atualizacao_nrec, 
					dt_atualizacao, 
					nr_seq_indicacao, 
					ie_grupo_hemocom,		
					ds_indicacao_adic)
		values (	nextval('protocolo_solic_indicacao_seq'),
					nr_sequencia_w,
					nm_usuario_p,
					nm_usuario_p,		
					clock_timestamp(),
					clock_timestamp(),
					nr_seq_indicacao_w,
					ie_grupo_hemocom_w,
					ds_indicacao_adic_w);		
		end;
	end loop;
	close C09;	

	open C10;
	loop
	fetch C10 into	
		nr_seq_derivado_w,
		qt_procedimento_w, 
		qt_vol_hemocomp_w, 
		dt_prev_execucao_w,
		cd_intervalo_w, 
		qt_veloc_inf_hemo_w,
		cd_setor_atendimento_w, 
		ie_util_hemocomponente_w,
		ds_observacao_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		nr_seq_proc_interno_w,
		nr_seq_amostra_princ_w,
		ie_tipo_proced_w;
	EXIT WHEN NOT FOUND; /* apply on C10 */
		begin
		
		select	coalesce(max(nr_seq_proc),0) + 1
		into STRICT	nr_sequencia_proc_w
		from	protocolo_medic_proc
		where	cd_protocolo	= cd_protocolo_dest_p
		and	nr_sequencia	= nr_seq_destino_p;
		
		insert into protocolo_medic_proc(cd_protocolo,
					nr_sequencia,
					nr_seq_proc,
					nr_seq_solic_bs,
					cd_procedimento,
					ie_origem_proced,	
					dt_atualizacao,
					nm_usuario,				
					ds_dado_clinico,
					cd_material_exame,
					nr_seq_exame,		
					ie_se_necessario,
					ie_acm,
					ds_material_especial,
					ie_urgencia,
					nr_seq_proc_interno,
					ie_lado,
					ie_multiplicar_quant,
					ie_respiracao,
					cd_mod_vent,
					ie_disp_resp_esp, 
					qt_fluxo_oxigenio,		
					ds_justificativa,
					nr_seq_prot_glic,
					nr_seq_derivado,
					qt_procedimento,
					qt_vol_hemocomp,
					dt_prev_execucao,
					cd_intervalo,
					qt_veloc_inf_hemo,
					cd_setor_atendimento,
					ie_util_hemocomponente,
					ds_observacao,
					cd_procedimento_lcb,
					nr_seq_amostra_princ,
					ie_anatomia)			
		values (cd_protocolo_dest_p,
					nr_seq_destino_p,
					nr_sequencia_proc_w,
					nr_sequencia_w,
					cd_procedimento_w,
					ie_origem_proced_w,		
					clock_timestamp(),
					nm_usuario_p,			
					null,
					null,
					null,		
					'N',
					'N',
					null,
					'N',
					nr_seq_proc_interno_w,
					null,
					null,
					null,
					null,
					null,
					null,		
					null,
					null,
					nr_seq_derivado_w,
					qt_procedimento_w,
					qt_vol_hemocomp_w,
					dt_prev_execucao_w,
					cd_intervalo_w,
					qt_veloc_inf_hemo_w,
					cd_setor_atendimento_w,
					ie_util_hemocomponente_w,
					substr(ds_observacao_w,1,255),
					nr_seq_proc_interno_w,
					nr_seq_amostra_princ_w,
					CASE WHEN ie_tipo_proced_w='AP' THEN  'S'  ELSE 'N' END );
		end;
	end loop;
	close C10;	

end if;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_protocolo_prescricao ( nr_prescricao_p bigint, nm_usuario_p text, cd_protocolo_dest_p bigint, nr_seq_destino_p bigint, ie_dietas_p text, ie_solucoes_p text, ie_medicamentos_p text, ie_materiais_p text, ie_procedimentos_p text, ie_recomendacoes_p text, ie_hemodialise_p text, ie_gasoterapia_p text, ie_leite_p text, ie_itens_kit_p text, ie_hemoterapia_p text) FROM PUBLIC;

