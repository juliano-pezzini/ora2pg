-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pat_gerar_mes_ref ( cd_empresa_p bigint, cd_estabelecimento_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text) AS $body$
DECLARE



cd_estabelecimento_w	bigint;
dt_mes_w			timestamp;


c01 CURSOR FOR
SELECT	a.cd_estabelecimento
from	estabelecimento a
where	a.cd_empresa		= cd_empresa_p
and	a.cd_estabelecimento	= coalesce(cd_estabelecimento_p, a.cd_estabelecimento)
and	exists (	select	1
		from	pat_bem x
		where	x.cd_estabelecimento	= a.cd_estabelecimento);/*Somente se o estabelecimento ja possuir bens*/
c02 CURSOR FOR
SELECT	a.dt_mes
from	mes_v a
where	a.dt_mes between dt_inicial_p and dt_final_p
and	not exists (	select	1
			from	pat_mes_ref x
			where	x.cd_estabelecimento	= cd_estabelecimento_w
			and	trunc(x.dt_mes_ref, 'mm')	= trunc(a.dt_mes, 'mm'));/*Somente se ja não existir*/
BEGIN


open C01;
loop
fetch C01 into
	cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	/*Inserir meses calculo patrimônio..*/

	open C02;
	loop
	fetch C02 into
		dt_mes_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		dt_mes_w	:= trunc(fim_mes(dt_mes_w));

		insert into pat_mes_ref(
			nr_sequencia,
			cd_estabelecimento,
			dt_atualizacao,
			nm_usuario,
			dt_mes_ref,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ie_situacao)
		values (	nextval('pat_mes_ref_seq'),
			cd_estabelecimento_w,
			clock_timestamp(),
			nm_usuario_p,
			dt_mes_w,
			clock_timestamp(),
			nm_usuario_p,
			0);


		end;
	end loop;
	close C02;

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pat_gerar_mes_ref ( cd_empresa_p bigint, cd_estabelecimento_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text) FROM PUBLIC;

