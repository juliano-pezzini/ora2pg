-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_data_entrega_oci ( nr_sequencia_p bigint, dt_entrega_alterada_p timestamp, nm_usuario_p text, cd_motivo_p bigint, ds_observacao_p text, ie_mesma_data_p text, ds_erro_p INOUT text) AS $body$
DECLARE


dt_prevista_entrega_w			timestamp;					
nr_item_oci_w				integer;
nr_ordem_compra_w			bigint;
qt_existe_w				bigint;
cd_material_w				integer;
ds_material_w				varchar(255);
ds_motivo_pend_w				varchar(255);
ds_razao_social_w				varchar(100);
ds_erro_w				varchar(255) := '';
ds_motivo_w				varchar(80);
ds_entrega_original_w			varchar(255) := '';
ds_entrega_atual_w			varchar(255) := '';
qt_prevista_entrega_w			double precision;
qt_real_entrega_w				double precision;
dt_inicio_pendencia_w			timestamp;
ds_email_comprador_w			varchar(255);
ds_usuario_comprador_w			varchar(255);
ds_email_origem_w				varchar(255);
ds_usuario_origem_w			varchar(255);
ie_usuario_w				varchar(3);
nr_Sequencia_w				bigint;
cd_perfil_dispara_w				integer;
nr_seq_regra_w				bigint;
cd_estabelecimento_w			bigint;
ds_email_adicional_w			varchar(2000);
ds_email_destino_w				varchar(255);
cd_unidade_medida_compra_w		varchar(30);
ds_assunto_w				varchar(255);
ds_mensagem_w				varchar(2000);
ie_momento_envio_w			varchar(1);
ie_sistema_origem_w			varchar(15);
ds_email_remetente_w			varchar(255);


BEGIN

select	b.qt_prevista_entrega,
	b.dt_prevista_entrega,
	b.nr_item_oci,
	b.nr_ordem_compra,
	a.cd_material,
	substr(obter_desc_material(a.cd_material),1,255),
	a.cd_unidade_medida_compra,
	dt_inicio_pendencia,
	substr(obter_desc_motivo_pend_entr(nr_seq_motivo_pend),1,255) ds_motivo_pend
into STRICT	qt_prevista_entrega_w,
	dt_prevista_entrega_w,
	nr_item_oci_w,
	nr_ordem_compra_w,
	cd_material_w,
	ds_material_w,
	cd_unidade_medida_compra_w,
	dt_inicio_pendencia_w,
	ds_motivo_pend_w
from	ordem_compra_item_entrega b,
	ordem_compra_item a
where	a.nr_ordem_compra = b.nr_ordem_compra
and	a.nr_item_oci = b.nr_item_oci
and	b.nr_sequencia = nr_sequencia_p;

select	ds_motivo
into STRICT	ds_motivo_w
from	motivo_alteracao_entrega
where	nr_sequencia = cd_motivo_p;

select	max(ie_sistema_origem)
into STRICT	ie_sistema_origem_w
from	ordem_compra
where	nr_ordem_compra = nr_ordem_compra_w;

if (dt_entrega_alterada_p < trunc(clock_timestamp(),'dd')) then
	ds_erro_w := 	WHEB_MENSAGEM_PCK.get_texto(280416) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(280417) ||
			WHEB_MENSAGEM_PCK.get_texto(280418);
end if;

if (ie_mesma_data_p = 'N') then
	begin

	select	count(*)
	into STRICT	qt_existe_w
	from	ordem_compra_item_entrega
	where	trunc(dt_prevista_entrega) = trunc(dt_entrega_alterada_p)
	and	nr_item_oci = nr_item_oci_w
	and	nr_ordem_compra = nr_ordem_compra_w
	and	coalesce(dt_real_entrega::text, '') = ''
	and	coalesce(qt_real_entrega,0) = 0;

	if (coalesce(ds_erro_w::text, '') = '') and (qt_existe_w >= 1) then
		ds_erro_w := 	WHEB_MENSAGEM_PCK.get_texto(280419) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(280420) || dt_entrega_alterada_p || '.'||
				WHEB_MENSAGEM_PCK.get_texto(280418);
	end if;
	
	if (coalesce(ds_erro_w::text, '') = '') and (qt_existe_w = 0) then
	
		update	ordem_compra_item_entrega
		set	dt_prevista_entrega	= dt_entrega_alterada_p,
			dt_entrega_limite	= dt_entrega_alterada_p,
			nm_usuario		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp(),
			ds_observacao		= substr(ds_observacao_p,1,255)
		where	nr_sequencia = nr_sequencia_p;
		
		if (ie_sistema_origem_w IS NOT NULL AND ie_sistema_origem_w::text <> '') then
	
			update	ordem_compra
			set	ie_necessita_enviar_int	= 'S',
				nm_usuario_altera_int	= nm_usuario_p
			where	nr_ordem_compra		= nr_ordem_compra_w;

		end if;
		
		CALL inserir_historico_ordem_compra(
			nr_ordem_compra_w,
			'S',
			WHEB_MENSAGEM_PCK.get_texto(280422),
			substr(WHEB_MENSAGEM_PCK.get_texto(280424) || nm_usuario_p || WHEB_MENSAGEM_PCK.get_texto(280425) || cd_material_w ||
			WHEB_MENSAGEM_PCK.get_texto(280426) || dt_prevista_entrega_w || WHEB_MENSAGEM_PCK.get_texto(280427) || dt_entrega_alterada_p || '.' || chr(13) || chr(10) ||
			WHEB_MENSAGEM_PCK.get_texto(280436) || ds_motivo_w || chr(13) || chr(10) || ds_observacao_p,1,4000),
			nm_usuario_p);
			
		ds_entrega_original_w	:= WHEB_MENSAGEM_PCK.get_texto(280437) ||  dt_prevista_entrega_w || chr(13) || chr(10);
		ds_entrega_atual_w	:= WHEB_MENSAGEM_PCK.get_texto(280437) || 	dt_entrega_alterada_p || chr(13) || chr(10);
	
 
		CALL envia_comunic_altera_entr_oc(nr_ordem_compra_w, nr_item_oci_w, ds_entrega_original_w, ds_entrega_atual_w, nm_usuario_p);			
	end if;
	end;
else
	begin
	
	select	coalesce(sum(qt_real_entrega),0)
	into STRICT	qt_real_entrega_w
	from	ordem_compra_item_entrega
	where	dt_prevista_entrega = dt_entrega_alterada_p
	and	nr_item_oci = nr_item_oci_w
	and	nr_ordem_compra = nr_ordem_compra_w;
	
	if (coalesce(ds_erro_w::text, '') = '') and (qt_real_entrega_w > 0) then
		ds_erro_w := 	WHEB_MENSAGEM_PCK.get_texto(280438) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(280420) || dt_entrega_alterada_p || '.'||
				WHEB_MENSAGEM_PCK.get_texto(280418);
	end if;
	
	if (coalesce(ds_erro_w::text, '') = '') then
	
		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_sequencia_w
		from	ordem_compra_item_entrega
		where	dt_prevista_entrega = dt_entrega_alterada_p
		and	nr_item_oci = nr_item_oci_w
		and	nr_ordem_compra = nr_ordem_compra_w
		and	coalesce(dt_cancelamento::text, '') = '';
		
		if (nr_sequencia_w > 0) then
		
			update	ordem_compra_item_entrega
			set	qt_prevista_entrega	= qt_prevista_entrega + qt_prevista_entrega_w
			where	nr_sequencia		= nr_sequencia_w;
			
			delete from ordem_compra_item_entrega
			where nr_sequencia = nr_sequencia_p;

			if (ie_sistema_origem_w IS NOT NULL AND ie_sistema_origem_w::text <> '') then
				
				update	ordem_compra
				set	ie_necessita_enviar_int	= 'S',
					nm_usuario_altera_int	= nm_usuario_p
				where	nr_ordem_compra		= nr_ordem_compra_w;

			end if;			
		else
			update	ordem_compra_item_entrega
			set	dt_prevista_entrega	= dt_entrega_alterada_p,
				dt_fim_pendencia	= clock_timestamp(),
				nm_usuario_fim_pend	= nm_usuario_p			
			where	nr_sequencia		= nr_sequencia_p;
			
			if (ie_sistema_origem_w IS NOT NULL AND ie_sistema_origem_w::text <> '') then
	
				update	ordem_compra
				set	ie_necessita_enviar_int	= 'S',
					nm_usuario_altera_int	= nm_usuario_p
				where	nr_ordem_compra		= nr_ordem_compra_w;

			end if;
			
		end if;
		
		CALL inserir_historico_ordem_compra(
			nr_ordem_compra_w,
			'S',
			WHEB_MENSAGEM_PCK.get_texto(280422),
			substr(WHEB_MENSAGEM_PCK.get_texto(280424) || nm_usuario_p || WHEB_MENSAGEM_PCK.get_texto(280425) || cd_material_w ||
			WHEB_MENSAGEM_PCK.get_texto(280426) || dt_prevista_entrega_w || WHEB_MENSAGEM_PCK.get_texto(280427) || dt_entrega_alterada_p || '.' || chr(13) || chr(10) ||
			WHEB_MENSAGEM_PCK.get_texto(280436) || ds_motivo_w || chr(13) || chr(10) || ds_observacao_p,1,4000),
			nm_usuario_p);
			
		ds_entrega_original_w	:= WHEB_MENSAGEM_PCK.get_texto(280437) ||  dt_prevista_entrega_w || chr(13) || chr(10);
		ds_entrega_atual_w	:= WHEB_MENSAGEM_PCK.get_texto(280437) || 	dt_entrega_alterada_p || chr(13) || chr(10);	
 
		CALL envia_comunic_altera_entr_oc(nr_ordem_compra_w, nr_item_oci_w, ds_entrega_original_w, ds_entrega_atual_w, nm_usuario_p);	
	
	end if;
	end;
end if;	

select	cd_estabelecimento,
	substr(obter_nome_pf_pj(null, cd_cgc_fornecedor),1,100),
	substr(obter_dados_pf_pj_estab(cd_estabelecimento, cd_pessoa_fisica, cd_cgc_fornecedor, 'M'),1,255)
into STRICT	cd_estabelecimento_w,
	ds_razao_social_w,
	ds_email_destino_w
from	ordem_compra
where	nr_ordem_compra = nr_ordem_compra_w;

select	coalesce(sum(qt_prevista_entrega),0)
into STRICT	qt_prevista_entrega_w
from	ordem_compra_item_entrega
where	dt_prevista_entrega = dt_entrega_alterada_p
and	nr_item_oci = nr_item_oci_w
and	nr_ordem_compra = nr_ordem_compra_w
and	coalesce(dt_cancelamento::text, '') = '';

select	coalesce(max(nr_sequencia),0),
	coalesce(max(ds_email_remetente),'X'),
	max(replace(ds_email_adicional,',',';')),
	max(cd_perfil_disparar),
	coalesce(max(ie_momento_envio),'I')
into STRICT	nr_seq_regra_w,
	ds_email_remetente_w,
	ds_email_adicional_w,
	cd_perfil_dispara_w,
	ie_momento_envio_w
from	regra_envio_email_compra
where	ie_tipo_mensagem = 54
and	ie_situacao = 'A'
and	cd_estabelecimento = cd_estabelecimento_w
and	obter_se_envia_email_regra(nr_ordem_compra_w, 'OC', 54, cd_estabelecimento_w) = 'S';

if (ds_email_destino_w IS NOT NULL AND ds_email_destino_w::text <> '') and (nr_seq_regra_w > 0) and
	((coalesce(cd_perfil_dispara_w::text, '') = '') or
	(cd_perfil_dispara_w IS NOT NULL AND cd_perfil_dispara_w::text <> '' AND cd_perfil_dispara_w = obter_perfil_ativo)) then
	begin	

	select	ds_assunto,
		ds_mensagem_padrao
	into STRICT	ds_assunto_w,
		ds_mensagem_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_seq_regra_w;

	ds_assunto_w := substr(replace_macro(ds_assunto_w, '@ordem', nr_ordem_compra_w),1,255);
	ds_assunto_w := substr(replace_macro(ds_assunto_w, '@nr_item', nr_item_oci_w),1,255);
	ds_assunto_w := substr(replace_macro(ds_assunto_w, '@dt_prev_entrega', dt_entrega_alterada_p),1,255);
	ds_assunto_w := substr(replace_macro(ds_assunto_w, '@qt_prev_entrega', qt_prevista_entrega_w),1,255);
	ds_assunto_w := substr(replace_macro(ds_assunto_w, '@material', cd_material_w),1,255);
	ds_assunto_w := substr(replace_macro(ds_assunto_w, '@descricao', ds_material_w),1,255);
	ds_assunto_w := substr(replace_macro(ds_assunto_w, '@cd_unid_medida', cd_unidade_medida_compra_w),1,255);
	ds_assunto_w := substr(replace_macro(ds_assunto_w, '@ds_fornecedor', ds_razao_social_w),1,255);
	ds_assunto_w := substr(replace_macro(ds_assunto_w, '@ds_motivo', ds_motivo_pend_w),1,255);

	ds_mensagem_w := substr(replace_macro(ds_mensagem_w, '@ordem', nr_ordem_compra_w),1,2000);
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w, '@nr_item', nr_item_oci_w),1,2000);
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w, '@dt_prev_entrega', dt_entrega_alterada_p),1,2000);
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w, '@qt_prev_entrega', qt_prevista_entrega_w),1,2000);
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w, '@material', cd_material_w),1,2000);
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w, '@descricao', ds_material_w),1,2000);
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w, '@cd_unid_medida', cd_unidade_medida_compra_w),1,2000);
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w, '@ds_fornecedor', ds_razao_social_w),1,2000);
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w, '@ds_motivo', ds_motivo_pend_w),1,2000);

	select	coalesce(max(ie_usuario),'U')
	into STRICT	ie_usuario_w
	from	regra_envio_email_compra
	where	nr_sequencia = nr_seq_regra_w;

	if (ie_usuario_w = 'U') then --Usuario
		select	ds_email,
			nm_usuario
		into STRICT	ds_email_origem_w,
			ds_usuario_origem_w
		from	usuario
		where	nm_usuario = nm_usuario_p;
	elsif (ie_usuario_w = 'C') then --Setor compras
		select	ds_email
		into STRICT	ds_email_origem_w
		from	parametro_compras
		where	cd_estabelecimento = cd_estabelecimento_w;
		
		select	coalesce(ds_fantasia,ds_razao_social)
		into STRICT	ds_usuario_origem_w
		from	estabelecimento_v
		where	cd_estabelecimento = cd_estabelecimento_w;
	elsif (ie_usuario_w = 'O') then --Comprador
		ds_email_origem_w	:= ds_email_comprador_w;
		ds_usuario_origem_w	:= ds_usuario_comprador_w;
	end if;

	if (ds_email_adicional_w IS NOT NULL AND ds_email_adicional_w::text <> '') then
		ds_email_destino_w := ds_email_destino_w || ';' || ds_email_adicional_w;
	end if;

	if (ds_email_remetente_w <> 'X') then
		ds_email_origem_w	:= ds_email_remetente_w;
	end if;

	select	count(*)
	into STRICT	qt_existe_w
	
	where 	obter_se_envia_email_internet(54,null,cd_estabelecimento_w, nr_ordem_compra_w) = 'S'
	and	obter_se_envia_email_ordem(54,nr_ordem_compra_w, cd_estabelecimento_w) = 'S';

	if (qt_existe_w > 0) then
		begin

		if (ie_momento_envio_w = 'A') then
			begin

			CALL sup_grava_envio_email(
				'OC',
				'54',
				nr_ordem_compra_w,
				null,
				null,
				ds_email_destino_w,
				ds_usuario_origem_w,
				ds_email_origem_w,
				ds_assunto_w,
				ds_mensagem_w,
				cd_estabelecimento_w,
				nm_usuario_p);

				end;
			else
				begin
				CALL enviar_email(ds_assunto_w, ds_mensagem_w, ds_email_origem_w, ds_email_destino_w, ds_usuario_origem_w, 'M');
				exception when others then
					ds_assunto_w := '';
				end;
			end if;

		end;
	end if;
	end;
end if;

CALL atualizar_data_entrega_nf_oci(	nr_sequencia_p,
				dt_prevista_entrega_w,
				nm_usuario_p);

ds_erro_p := ds_erro_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_data_entrega_oci ( nr_sequencia_p bigint, dt_entrega_alterada_p timestamp, nm_usuario_p text, cd_motivo_p bigint, ds_observacao_p text, ie_mesma_data_p text, ds_erro_p INOUT text) FROM PUBLIC;

