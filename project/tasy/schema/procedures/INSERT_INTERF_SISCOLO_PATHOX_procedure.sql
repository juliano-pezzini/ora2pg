-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_interf_siscolo_pathox (nr_seq_siscolo_p siscolo_atendimento.nr_sequencia%type) AS $body$
DECLARE


nr_sequencia_interf_w		w_interf_siscolo_pathox.nr_sequencia%type;
nr_atendimento_w		atendimento_paciente.nr_atendimento%type;
sg_estado_w			pessoa_juridica.sg_estado%type;
cd_municipio_ibge_w		pessoa_juridica.cd_municipio_ibge%type;
cd_cnes_w			pessoa_juridica.cd_cnes%type;
ds_razao_social_w		pessoa_juridica.ds_razao_social%type;
nr_prontuario_w			pessoa_fisica.nr_prontuario%type;
ie_fez_papanicolau_w		siscolo_cito_anamnese.ie_fez_papanicolau%type;
dt_ultimo_exame_papanic_w	siscolo_cito_anamnese.dt_ultimo_exame_papanic%type;
ie_usa_diu_w			siscolo_cito_anamnese.ie_usa_diu%type;
ie_gravida_w			siscolo_cito_anamnese.ie_gravida%type;
ie_usa_anticoncep_w		siscolo_cito_anamnese.ie_usa_anticoncep%type;
ie_usa_hormonio_w		siscolo_cito_anamnese.ie_usa_hormonio%type;
ie_fez_radio_w			siscolo_cito_anamnese.ie_fez_radio%type;
dt_ultima_mestrua_w		siscolo_cito_anamnese.dt_ultima_mestrua%type;
ie_sang_relacao_w		siscolo_cito_anamnese.ie_sang_relacao%type;
ie_sang_menopausa_w		siscolo_cito_anamnese.ie_sang_menopausa%type;
ie_inspecao_colo_w		siscolo_cito_anamnese.ie_inspecao_colo%type;
ie_sinal_dst_w			siscolo_cito_anamnese.ie_sinal_dst%type;
dt_coleta_w			siscolo_cito_anamnese.dt_coleta%type;
dt_recebimento_w		frasco_pato_loc_status.dt_atualizacao_nrec%type;
nm_pessoa_coleta_w		pessoa_fisica.nm_pessoa_fisica%type;
ie_pessoa_coleta_w		w_interf_siscolo_pathox.ie_pessoa_coleta%type;
nr_prescricao_w			siscolo_atendimento.nr_prescricao%type;
dt_emissao_w                    siscolo_atendimento.dt_emissao%type;


BEGIN

select	nr_prescricao,
	nr_atendimento,
        dt_emissao
into STRICT	nr_prescricao_w,
	nr_atendimento_w,
        dt_emissao_w
from	siscolo_atendimento
where	nr_sequencia = nr_seq_siscolo_p;

begin
select 	b.sg_estado,
	b.cd_municipio_ibge,
	b.cd_cnes,
	substr(elimina_aspas(b.ds_razao_social),1,40)
into STRICT	sg_estado_w,
	cd_municipio_ibge_w,
	cd_cnes_w,
	ds_razao_social_w
from	siscolo_atendimento a,
	pessoa_juridica b
where
	a.cd_cnpj_unidade_saude = b.cd_cgc and
	nr_atendimento = nr_atendimento_w;
exception
when others then
	sg_estado_w := null;
end;

begin
select 	CASE WHEN ie_fez_papanicolau='S' THEN '3' WHEN ie_fez_papanicolau='N' THEN '1' WHEN ie_fez_papanicolau='X' THEN '2' WHEN ie_fez_papanicolau='F' THEN '4'  ELSE '0' END ,
        CASE WHEN ie_usa_diu='S' THEN '3' WHEN ie_usa_diu='N' THEN '1'  ELSE '2' END ,
        CASE WHEN ie_gravida='S' THEN '3' WHEN ie_gravida='N' THEN '1'  ELSE '2' END ,
        CASE WHEN ie_usa_anticoncep='S' THEN '3' WHEN ie_usa_anticoncep='N' THEN '1'  ELSE '2' END ,
        CASE WHEN ie_usa_hormonio='S' THEN '3' WHEN ie_usa_hormonio='N' THEN '1'  ELSE '2' END ,
        CASE WHEN ie_fez_radio='S' THEN '3' WHEN ie_fez_radio='N' THEN '1'  ELSE '2' END ,
        CASE WHEN ie_sang_relacao='S' THEN '3'  ELSE '1' END ,
        CASE WHEN ie_sang_menopausa='S' THEN '3'  ELSE '1' END ,
        CASE WHEN ie_inspecao_colo='N' THEN '1' WHEN ie_inspecao_colo='T' THEN '2' WHEN ie_inspecao_colo='A' THEN '3' WHEN ie_inspecao_colo='C' THEN '4'  ELSE '0' END ,
        CASE WHEN ie_sinal_dst='S' THEN '3' WHEN ie_sinal_dst='N' THEN '1'  ELSE '0' END ,
	dt_ultimo_exame_papanic,
	dt_ultima_mestrua,
	dt_coleta
into STRICT	ie_fez_papanicolau_w,
	ie_usa_diu_w,
	ie_gravida_w,
	ie_usa_anticoncep_w,
	ie_usa_hormonio_w,
	ie_fez_radio_w,
	ie_sang_relacao_w,
	ie_sang_menopausa_w,
	ie_inspecao_colo_w,
	ie_sinal_dst_w,
	dt_ultimo_exame_papanic_w,
	dt_ultima_mestrua_w,
	dt_coleta_w
from 	siscolo_cito_anamnese
where 	nr_seq_siscolo = nr_seq_siscolo_p;
exception
when others then
	dt_coleta_w := null;
end;

begin
	select	obter_data_frasco_pato(nr_sequencia, 30) dt_recebimento
	into STRICT	dt_recebimento_w
	from 	frasco_pato_loc
	where 	nr_prescricao = nr_prescricao_w;
exception
when others then
	dt_recebimento_w := null;
end;

if (coalesce(dt_recebimento_w::text, '') = '') then
        dt_recebimento_w := dt_emissao_w;
end if;

begin
select 	substr(elimina_aspas(nm_pessoa_fisica),1,40),
	nr_prontuario,
	CASE WHEN coalesce(nm_pessoa_fisica::text, '') = '' THEN  'N'  ELSE 'S' END
into STRICT	nm_pessoa_coleta_w,
	nr_prontuario_w,
	ie_pessoa_coleta_w
from 	prescr_procedimento a,
	pessoa_fisica b
where	a.cd_pessoa_coleta = b.cd_pessoa_fisica and
	nr_prescricao = nr_prescricao_w;
exception
when others then
	nm_pessoa_coleta_w := null;
end;

begin
select 	nr_sequencia
into STRICT	nr_sequencia_interf_w
from 	w_interf_siscolo_pathox
where 	nr_seq_siscolo = nr_seq_siscolo_p;
exception
when others then
	nr_sequencia_interf_w := null;
end;

if (coalesce(nr_sequencia_interf_w::text, '') = '') then

	select	nextval('w_interf_siscolo_pathox_seq')
	into STRICT	nr_sequencia_interf_w
	;

	insert into w_interf_siscolo_pathox(
		nr_sequencia,
		dt_atualizacao,
		dt_atualizacao_nrec,
		nm_usuario,
		nm_usuario_nrec,
		sg_estado,
		cd_municipio_ibge,
		cd_cnes,
		ds_razao_social,
		nr_prontuario,
		ie_fez_papanicolau,
		dt_ultimo_exame_papanic,
		ie_usa_diu,
		ie_gravida,
		ie_usa_anticoncep,
		ie_usa_hormonio,
		ie_fez_radio,
		dt_ultima_mestrua,
		ie_sang_relacao,
		ie_sang_menopausa,
		ie_inspecao_colo,
		ie_sinal_dst,
		dt_coleta,
		dt_recebimento,
		nm_pessoa_coleta,
		ie_pessoa_coleta,
		nr_seq_siscolo,
		nr_prescricao)
	values (
		nr_sequencia_interf_w,
		clock_timestamp(),
		clock_timestamp(),
		coalesce(wheb_usuario_pck.get_nm_usuario,''),
		coalesce(wheb_usuario_pck.get_nm_usuario,''),
		sg_estado_w,
		cd_municipio_ibge_w,
		cd_cnes_w,
		ds_razao_social_w,
		nr_prontuario_w,
		ie_fez_papanicolau_w,
		dt_ultimo_exame_papanic_w,
		ie_usa_diu_w,
		ie_gravida_w,
		ie_usa_anticoncep_w,
		ie_usa_hormonio_w,
		ie_fez_radio_w,
		dt_ultima_mestrua_w,
		ie_sang_relacao_w,
		ie_sang_menopausa_w,
		ie_inspecao_colo_w,
		ie_sinal_dst_w,
		dt_coleta_w,
		dt_recebimento_w,
		nm_pessoa_coleta_w,
		ie_pessoa_coleta_w,
		nr_seq_siscolo_p,
		nr_prescricao_w);
	commit;
else
	update	w_interf_siscolo_pathox
	set	dt_atualizacao = clock_timestamp(),
		nm_usuario = coalesce(wheb_usuario_pck.get_nm_usuario,''),
		sg_estado = sg_estado_w,
		cd_municipio_ibge = cd_municipio_ibge_w,
		cd_cnes = cd_cnes_w,
		ds_razao_social = ds_razao_social_w,
		nr_prontuario = nr_prontuario_w,
		ie_fez_papanicolau = ie_fez_papanicolau_w,
		dt_ultimo_exame_papanic = dt_ultimo_exame_papanic_w,
		ie_usa_diu = ie_usa_diu_w,
		ie_gravida = ie_gravida_w,
		ie_usa_anticoncep = ie_usa_anticoncep_w,
		ie_usa_hormonio = ie_usa_hormonio_w,
		ie_fez_radio = ie_fez_radio_w,
		dt_ultima_mestrua = dt_ultima_mestrua_w,
		ie_sang_relacao = ie_sang_relacao_w,
		ie_sang_menopausa = ie_sang_menopausa_w,
		ie_inspecao_colo = ie_inspecao_colo_w,
		ie_sinal_dst = ie_sinal_dst_w,
		dt_coleta = dt_coleta_w,
		dt_recebimento = dt_recebimento_w,
		nm_pessoa_coleta = nm_pessoa_coleta_w,
		ie_pessoa_coleta = ie_pessoa_coleta_w,
		nr_prescricao = nr_prescricao_w
	where 	nr_sequencia = nr_sequencia_interf_w;
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_interf_siscolo_pathox (nr_seq_siscolo_p siscolo_atendimento.nr_sequencia%type) FROM PUBLIC;

