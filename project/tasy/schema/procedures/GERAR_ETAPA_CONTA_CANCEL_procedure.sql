-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_etapa_conta_cancel (nr_interno_conta_p bigint, nm_usuario_p text, ie_opcao_p text default 'S') AS $body$
DECLARE

 
nr_sequencia_w		bigint;
nr_seq_etapa_padrao_w	bigint;
cd_convenio_w		integer;
cd_estabelecimento_w	bigint;
ie_tipo_atendimento_w	smallint;
nr_seq_classificacao_w	bigint;
cd_categoria_w		varchar(10);
ie_clinica_w		integer;
cd_setor_atendimento_w	bigint;
nr_seq_motivo_dev_w	bigint;
nr_atendimento_w	bigint;
cd_setor_atend_etapa_w	bigint;
ie_pessoa_etapa_w	varchar(3);
ie_etapa_critica_w	varchar(1);
nm_usuario_original_w	varchar(15);
cd_pessoa_fisica_w	varchar(10);
cd_perfil_w		perfil.cd_perfil%type := obter_perfil_ativo;
qt_regra_restringe_w	bigint;
nr_seq_w		fatur_etapa_conta.nr_sequencia%type;

C01 CURSOR FOR 
	SELECT	nr_sequencia,		 
		nr_seq_etapa, 
		nr_seq_motivo_dev, 
		cd_setor_atend_etapa, 
		coalesce(ie_pessoa_etapa,'L'), 
		coalesce(ie_etapa_critica,'N') 
	from	fatur_etapa_conta 
	where	ie_situacao = 'A' 
	and 	coalesce(cd_convenio, coalesce(cd_convenio_w,0)) = coalesce(cd_convenio_w,0) 
	and 	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_w,0)) = coalesce(cd_estabelecimento_w,0) 
	and	coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w,0)) = coalesce(ie_tipo_atendimento_w,0) 
	and	coalesce(nr_seq_classificacao, coalesce(nr_seq_classificacao_w,0)) = coalesce(nr_seq_classificacao_w,0) 
	and	coalesce(cd_categoria, coalesce(cd_categoria_w,'0')) = coalesce(cd_categoria_w,'0') 
	and	coalesce(ie_clinica, coalesce(ie_clinica_w,0)) = coalesce(ie_clinica_w,0) 
	and	coalesce(cd_setor_atendimento, coalesce(cd_setor_atendimento_w,0)) = coalesce(cd_setor_atendimento_w,0) 
	and 	coalesce(IE_CONTA_AJUSTE_CANCEL,'N') = coalesce(ie_opcao_p,'S') 
	and	coalesce(ie_conta_desdobramento,'S') = 'S' 
	and	coalesce(cd_perfil,coalesce(cd_perfil_w,0))	= coalesce(cd_perfil_w,0) 
	order by coalesce(cd_convenio,0), 
		coalesce(cd_estabelecimento,0), 
		coalesce(ie_tipo_atendimento,0), 
		coalesce(nr_seq_classificacao,0), 
		coalesce(cd_categoria,'0'), 
		coalesce(ie_clinica,0), 
		coalesce(cd_setor_atendimento,0), 
		coalesce(cd_perfil,0);


BEGIN 
 
select	max(cd_convenio_parametro), 
	max(cd_estabelecimento), 
	max(cd_categoria_parametro), 
	max(coalesce(obter_setor_atendimento(nr_atendimento),0)), 
	max(nr_atendimento), 
	max(coalesce(nm_usuario_original,'')) 
into STRICT	cd_convenio_w, 
	cd_estabelecimento_w, 
	cd_categoria_w, 
	cd_setor_atendimento_w, 
	nr_atendimento_w, 
	nm_usuario_original_w 
from 	conta_paciente 
where 	nr_interno_conta = nr_interno_conta_p;
	 
nr_seq_etapa_padrao_w:= null;
 
select	coalesce(max(ie_tipo_atendimento),0), 
	coalesce(max(nr_seq_classificacao),0), 
	coalesce(max(ie_clinica),0) 
into STRICT	ie_tipo_atendimento_w, 
	nr_seq_classificacao_w, 
	ie_clinica_w 
from	atendimento_paciente 
where	nr_atendimento = nr_atendimento_w;
 
open C01;
loop 
fetch C01 into	 
	nr_seq_w,	 
	nr_seq_etapa_padrao_w, 
	nr_seq_motivo_dev_w, 
	cd_setor_atend_etapa_w, 
	ie_pessoa_etapa_w, 
	ie_etapa_critica_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	nr_seq_etapa_padrao_w	:= nr_seq_etapa_padrao_w;
	nr_seq_motivo_dev_w	:= nr_seq_motivo_dev_w;
	cd_setor_atend_etapa_w	:= cd_setor_atend_etapa_w;
	ie_pessoa_etapa_w	:= ie_pessoa_etapa_w;
	ie_etapa_critica_w	:= ie_etapa_critica_w;
	end;
end loop;
close C01;
 
select 	count(*) 
into STRICT	qt_regra_restringe_w 
from 	fatur_etapa_conta_conv 
where 	nr_seq_regra = nr_seq_w 
and 	cd_convenio = cd_convenio_w;
 
if (qt_regra_restringe_w > 0) then 
	nr_seq_etapa_padrao_w:= null;
end if;
 
if (nr_seq_etapa_padrao_w IS NOT NULL AND nr_seq_etapa_padrao_w::text <> '') then 
 
	select	substr(Obter_Pessoa_Fisica_Usuario(CASE WHEN ie_pessoa_etapa_w='L' THEN  nm_usuario_p  ELSE nm_usuario_original_w END ,'C'),1,10) 
	into STRICT	cd_pessoa_fisica_w 
	;
 
	select	nextval('conta_paciente_etapa_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	insert into conta_paciente_etapa( 
		NR_SEQUENCIA, 
		NR_INTERNO_CONTA, 
		DT_ATUALIZACAO, 
		NM_USUARIO, 
		DT_ETAPA, 
		NR_SEQ_ETAPA, 
		CD_SETOR_ATENDIMENTO, 
		CD_PESSOA_FISICA, 
		nr_seq_motivo_dev, 
		ds_observacao, 
		nr_lote_barras, 
		ie_etapa_critica) 
	values (nr_sequencia_w, 
		nr_interno_conta_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nr_seq_etapa_padrao_w, 
		cd_setor_atend_etapa_w, 
		cd_pessoa_fisica_w, 
		nr_seq_motivo_dev_w, 
		wheb_mensagem_pck.get_texto(306347), 
		null, 
		ie_etapa_critica_w);
		 
end if;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_etapa_conta_cancel (nr_interno_conta_p bigint, nm_usuario_p text, ie_opcao_p text default 'S') FROM PUBLIC;

