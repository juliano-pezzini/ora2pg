-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_congelamento_movi_estoque (nr_seq_congelacao_p bigint, nr_seq_lote_p bigint, cd_unidade_medida_p text, cd_operacao_estoque_p bigint, qt_estoque_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_centro_custo_w	integer;
cd_local_estoque_w	smallint;
cd_material_w		integer;
cd_mov_estoq_w		bigint;


BEGIN
if (nr_seq_lote_p IS NOT NULL AND nr_seq_lote_p::text <> '') and (cd_operacao_estoque_p IS NOT NULL AND cd_operacao_estoque_p::text <> '') and (cd_unidade_medida_p IS NOT NULL AND cd_unidade_medida_p::text <> '') then

	select	nextval('movimento_estoque_seq')
	into STRICT	cd_mov_estoq_w
	;

	select	coalesce(max(x.cd_local_estoque),0)
	into STRICT    cd_local_estoque_w
	from    setor_atendimento x
	where   x.cd_setor_atendimento	= wheb_usuario_pck.get_cd_setor_atendimento
	and     x.cd_estabelecimento	= wheb_usuario_pck.get_cd_estabelecimento;

	select	coalesce(max(z.cd_centro_custo), 0)
	into STRICT	cd_centro_custo_w
	from	local_estoque z
	where	z.cd_local_estoque	= cd_local_estoque_w;

	select	coalesce(max(x.cd_material),0)
	into STRICT	cd_material_w
	from	material_lote_fornec x
	where	x.nr_sequencia		= nr_seq_lote_p;

	if (nr_seq_congelacao_p != 0) then
		update	san_dados_congelacao
		set	dt_atualizacao		= clock_timestamp(),
			dt_liberacao		= clock_timestamp(),
			nm_usuario_lib		= nm_usuario_p
		where	nr_sequencia		= nr_seq_congelacao_p;
	end if;

	insert into movimento_estoque(
			nr_movimento_estoque,
			cd_estabelecimento,
			cd_local_estoque,
			cd_operacao_estoque,
			cd_acao,
			cd_material,
			cd_unidade_med_mov,
			cd_unidade_medida_estoque,
			cd_setor_atendimento,
			cd_centro_custo,
			qt_movimento,
			qt_estoque,
			ie_origem_documento,
			nm_usuario,
			dt_movimento_estoque,
			dt_mesano_referencia,
			dt_atualizacao
	) values (
			cd_mov_estoq_w,
			wheb_usuario_pck.get_cd_estabelecimento,
			cd_local_estoque_w,
			cd_operacao_estoque_p,
			'1',
			cd_material_w,
			cd_unidade_medida_p,
			cd_unidade_medida_p,
			wheb_usuario_pck.get_cd_setor_atendimento,
			cd_centro_custo_w,
			qt_estoque_p,
			qt_estoque_p,
			'10',
			nm_usuario_p,
			clock_timestamp(),
			clock_timestamp(),
			clock_timestamp()
	);


end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_congelamento_movi_estoque (nr_seq_congelacao_p bigint, nr_seq_lote_p bigint, cd_unidade_medida_p text, cd_operacao_estoque_p bigint, qt_estoque_p bigint, nm_usuario_p text) FROM PUBLIC;

