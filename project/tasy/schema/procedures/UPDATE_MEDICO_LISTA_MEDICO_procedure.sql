-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE update_medico_lista_medico ( nm_usuario_p text, nr_seq_lista_p bigint, nr_prescricao_p bigint, nr_sequencia_prescricao_p bigint) AS $body$
DECLARE

  nm_usuario_w              lista_central_exame.nm_usuario%type;
  nr_seq_lista_w            lista_central_exame.nr_seq_lista_medico%type;
  nr_prescricao_w           lista_central_exame.nr_prescricao%type;
  nr_sequencia_prescricao_w lista_central_exame.nr_sequencia_prescricao%type;
  nr_ordem_apresentacao_w   lista_central_exame.nr_ordem_apresentacao%type;
  ie_contido_mesma_lista    varchar(1);


BEGIN
  nm_usuario_w              := nm_usuario_p;
  nr_seq_lista_w            := nr_seq_lista_p;
  nr_prescricao_w           := nr_prescricao_p;
  nr_sequencia_prescricao_w := nr_sequencia_prescricao_p;

  SELECT CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
  INTO STRICT ie_contido_mesma_lista
  FROM lista_central_exame a
  WHERE a.nr_seq_lista_medico = nr_seq_lista_w
  AND a.nr_prescricao = nr_prescricao_w
  AND a.nr_sequencia_prescricao = nr_sequencia_prescricao_w;

  IF (ie_contido_mesma_lista = 'N') THEN
  BEGIN
    SELECT coalesce(MAX(a.nr_ordem_apresentacao),0)+5
    INTO STRICT nr_ordem_apresentacao_w
    FROM lista_central_exame a
    WHERE a.nr_seq_lista_medico = nr_seq_lista_w
    AND a.nr_prescricao IN (SELECT pp.nr_prescricao
                            FROM prescr_procedimento pp
                            WHERE a.nr_prescricao         = pp.nr_prescricao
                            AND a.nr_sequencia_prescricao = pp.nr_sequencia
                            AND pp.ie_status_execucao     = '20');

    UPDATE lista_central_exame
    SET nr_seq_lista_medico = nr_seq_lista_w,
        nm_usuario = nm_usuario_w,
        nr_ordem_apresentacao = nr_ordem_apresentacao_w
    WHERE nr_prescricao = nr_prescricao_w
    AND nr_sequencia_prescricao = nr_sequencia_prescricao_w;

    COMMIT;
  END;
  END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE update_medico_lista_medico ( nm_usuario_p text, nr_seq_lista_p bigint, nr_prescricao_p bigint, nr_sequencia_prescricao_p bigint) FROM PUBLIC;

