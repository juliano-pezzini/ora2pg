-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_alteracao_glicemia_proc ( nr_atendimento_p bigint, nr_seq_horario_p bigint, ie_inativar_glic_p text, nm_usuario_p text) AS $body$
DECLARE


ie_ctrl_glic_w		varchar(15);
nr_seq_cig_w		bigint;
nr_seq_ccg_w		bigint;
nr_seq_max_cig_w	bigint;
nr_seq_max_ccg_w	bigint;
nr_cig_atend_w		bigint;
nr_glicemia_atend_w	bigint;
nr_seq_glicemia_w	bigint;
nr_seq_proc_hor_w	bigint;
nr_seq_protocolo_w	bigint;
nr_seq_mat_alt_w	bigint;
nr_prescricao_w		bigint;
nr_seq_proced_w		integer;
cd_procedimento_w	bigint;
nr_seq_proc_interno_w	bigint;
ie_inativar_glic_w	varchar(1);
ie_tipo_item_w		varchar(10);
nr_seq_hor_proc_w	bigint;
nr_seq_mat_hor_w	bigint;
cd_estabelecimento_w	smallint;
cd_material_w		integer;
nr_seq_item_w		bigint;
dt_horario_w		timestamp;
dt_horario_mat_w	timestamp;
dt_horario_proc_w	timestamp;
nr_seq_prot_glic_w	prescr_procedimento.nr_seq_prot_glic%type;
ie_prot_cobra_adm_w	varchar(1);
nr_seq_map_w		bigint;


c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.cd_material,
	a.dt_horario,
	a.nr_seq_material
from	prescr_mat_hor a,
	prescr_proc_hor b
where	a.nr_prescricao	= b.nr_prescricao
and	a.ie_agrupador	= 5
and	a.nr_seq_hor_glic	= b.nr_sequencia
and	b.nr_sequencia	= nr_seq_horario_p
and	b.nr_prescricao	= nr_prescricao_w
and	b.nr_seq_procedimento = nr_seq_proced_w
and	coalesce(a.dt_suspensao::text, '') = '';


BEGIN
if (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin

	ie_inativar_glic_w := coalesce(ie_inativar_glic_p,'N');

	select	obter_ctrl_glic_proc(nr_seq_proc_interno)
	into STRICT	ie_ctrl_glic_w
	from	prescr_proc_hor
	where	nr_sequencia = nr_seq_horario_p
	and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

	select max(a.nr_seq_prot_glic)
	into STRICT	nr_seq_prot_glic_w
	from	prescr_procedimento a,
		prescr_proc_hor b
	where a.nr_prescricao 	      = b.nr_prescricao
	and	b.nr_seq_procedimento = a.nr_sequencia
	and	b.nr_sequencia              = nr_seq_horario_p;

	if (ie_ctrl_glic_w in ('CIG', 'CCG')) then
		begin
		if (ie_ctrl_glic_w = 'CIG') then
			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_seq_cig_w
			from	atendimento_cig
			where	nr_atendimento	= nr_atendimento_p
			and	nr_seq_horario	= nr_seq_horario_p
			and	coalesce(ie_status_cig, 'P') <> 'V';

			if (nr_seq_cig_w > 0) then
				begin

				select	coalesce(max(nr_sequencia),0)
				into STRICT	nr_seq_max_cig_w
				from	atendimento_cig
				where	nr_atendimento	= nr_atendimento_p;

				if (nr_seq_max_cig_w > 0) and (nr_seq_max_cig_w = nr_seq_cig_w) then
					begin
					select	coalesce(max(nr_cig_atend),0),
						coalesce(max(nr_seq_glicemia),0),
						coalesce(max(nr_seq_proc_hor),0)
					into STRICT	nr_cig_atend_w,
						nr_seq_glicemia_w,
						nr_seq_proc_hor_w
					from	atendimento_cig
					where	nr_sequencia = nr_seq_cig_w;
					end;
				end if;

				end;
			end if;
		else

			select	coalesce(max(nr_sequencia),0)
			into STRICT	nr_seq_ccg_w
			from	atendimento_glicemia
			where	nr_atendimento	= nr_atendimento_p
			and		nr_seq_horario	= nr_seq_horario_p
			and		coalesce(ie_status_glicemia, 'P') <> 'V';

			if (nr_seq_ccg_w > 0) then

				select	coalesce(max(nr_sequencia),0)
				into STRICT	nr_seq_max_ccg_w
				from	atendimento_glicemia
				where	nr_atendimento	= nr_atendimento_p
				and	coalesce(ie_status_glicemia, 'P') <> 'V';

				if (nr_seq_max_ccg_w > 0) and (nr_seq_max_ccg_w = nr_seq_ccg_w) then
					begin

					select	coalesce(max(nr_glicemia_atend),0),
							coalesce(max(nr_seq_glicemia),0),
							coalesce(max(nr_seq_horario),0),
							coalesce(max(nr_seq_protocolo),0)
					into STRICT	nr_glicemia_atend_w,
							nr_seq_glicemia_w,
							nr_seq_proc_hor_w,
							nr_seq_protocolo_w
					from	atendimento_glicemia
					where	nr_sequencia = nr_seq_ccg_w;
					end;
				else
					-- 'Já foram realizadas medições de glicemia posteriores a esta. '||chr(10)||
					-- 'Não será possível reverter a administração deste horário, favor verificar!#@#@');
					CALL Wheb_mensagem_pck.exibir_mensagem_abort(214138);
				end if;


			end if;

		end if;

		if (nr_seq_proc_hor_w > 0) then

			/*update	prescr_proc_hor          Solicitado pelo analista retirar esse tratamento na OS 1230814.
			set	ie_situacao 	= 'I',
				dt_atualizacao	= sysdate,
				nm_usuario	= nm_usuario_p
			where	nr_sequencia	= nr_seq_proc_hor_w
			and	dt_suspensao	is null
			and	dt_fim_horario	is null;*/
			UPDATE	prescr_mat_hor
			SET		dt_fim_horario	 = NULL,
					nm_usuario_adm	 = NULL
			WHERE	nr_seq_hor_glic		= nr_seq_proc_hor_w
			AND		(dt_fim_horario IS NOT NULL AND dt_fim_horario::text <> '');


			select	nextval('prescr_mat_alteracao_seq')
			into STRICT	nr_seq_mat_alt_w
			;

			select	nr_prescricao,
					nr_seq_procedimento,
					dt_horario,
					cd_procedimento,
					nr_seq_proc_interno
			into STRICT	nr_prescricao_w,
					nr_seq_proced_w,
					dt_horario_w,
					cd_procedimento_w,
					nr_seq_proc_interno_w
			from	prescr_proc_hor
			where	nr_sequencia = nr_seq_horario_p
			and		Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

			select	max(cd_estabelecimento)
			into STRICT	cd_estabelecimento_w
			from	prescr_medica
			where	nr_prescricao	= nr_prescricao_w;

			if (ie_ctrl_glic_w = 'CCG') then
				ie_tipo_item_w	:= 'G';
			else
				ie_tipo_item_w	:= 'C';
			end if;

			if (ie_ctrl_glic_w = 'CCG') then
				begin

				if (ie_inativar_glic_w = 'S') then
					CALL inativar_ccg(nr_atendimento_p, nr_seq_glicemia_w, nr_seq_protocolo_w, nr_glicemia_atend_w, nr_seq_max_ccg_w, nm_usuario_p);
				else
					CALL excluir_glicemia_atendimento(nr_atendimento_p, nr_seq_glicemia_w, nr_seq_protocolo_w, nr_glicemia_atend_w, nr_seq_max_ccg_w, nm_usuario_p);
				end if;

				end;
			else
				begin

				if (ie_inativar_glic_w = 'S') then
					CALL inativar_cig(nr_atendimento_p, nr_seq_glicemia_w, nr_cig_atend_w, nr_seq_cig_w, nm_usuario_p);
				else
					CALL excluir_cig_atendimento(nr_atendimento_p, nr_seq_glicemia_w, nr_cig_atend_w, nr_seq_cig_w, nm_usuario_p);
				end if;

				end;
			end if;

			open C01;
			loop
			fetch C01 into
				nr_seq_mat_hor_w,
				cd_material_w,
				dt_horario_mat_w,
				nr_seq_item_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				begin
				CALL Suspender_prescr_mat_hor(nr_seq_mat_hor_w, nm_usuario_p, null, obter_desc_expressao(782148)/*'Suspensão automática conforme a reversão do registro da medição.'*/
,'N',null);
				CALL gerar_alter_hor_prescr_adep(nr_atendimento_p,'IAG',cd_material_w, nr_prescricao_w, nr_seq_item_w, nr_seq_mat_hor_w, dt_horario_mat_w, 5, null, /*'Suspensão automática conforme a reversão do registro da medição.'*/ PERFORM obter_desc_expressao(782148) || ' ',null,nm_usuario_p);

				select	coalesce(max(c.ie_cobra_adm),'N')
				into STRICT	ie_prot_cobra_adm_w
				from	pep_protocolo_glicemia c,
						prescr_procedimento b,
						prescr_material a
				where	a.nr_prescricao	= b.nr_prescricao
				and		a.nr_sequencia_proc	= b.nr_sequencia
				and		b.nr_seq_prot_glic	= c.nr_sequencia
				and		a.nr_prescricao	= nr_prescricao_w
				and		a.nr_sequencia	= nr_seq_item_w;

				if (ie_prot_cobra_adm_w = 'S') then
					nr_seq_map_w := Gerar_estornar_adep_map(NULL, nr_seq_mat_hor_w, NULL, 'E', dt_horario_mat_w, nm_usuario_p, nr_seq_map_w, 'GAP', null, null);
				end if;

				end;
			end loop;
			close C01;

			select	max(a.nr_sequencia),
					max(a.dt_horario)
			into STRICT	nr_seq_proc_hor_w,
					dt_horario_proc_w
			from	prescr_proc_hor a,
					prescr_proc_hor b
			where	a.nr_prescricao		= b.nr_prescricao
			and		a.nr_seq_procedimento	= b.nr_seq_procedimento
			and		a.nr_seq_hor_glic	= b.nr_sequencia
			and		b.nr_sequencia		= nr_seq_horario_p
			and		b.nr_prescricao		= nr_prescricao_w
			and		b.nr_seq_procedimento	= nr_seq_proced_w
			and		coalesce(a.dt_suspensao::text, '') = '';

			if (nr_seq_proc_hor_w IS NOT NULL AND nr_seq_proc_hor_w::text <> '') then
				CALL suspender_prescr_proc_hor(nr_seq_proc_hor_w, nm_usuario_p);
				CALL Gerar_Alter_Hor_Prescr_Adep(nr_atendimento_p, ie_tipo_item_w, cd_procedimento_w, nr_prescricao_w, nr_seq_proced_w, nr_seq_proc_hor_w,dt_horario_proc_w, 12, null, /*'Suspensão automática conforme a reversão do registro da medição.'*/
 obter_desc_expressao(782148)|| ' ', null, nm_usuario_p);
			end if;

		end if;
		end;
	end if;

	end;
end if;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_alteracao_glicemia_proc ( nr_atendimento_p bigint, nr_seq_horario_p bigint, ie_inativar_glic_p text, nm_usuario_p text) FROM PUBLIC;

