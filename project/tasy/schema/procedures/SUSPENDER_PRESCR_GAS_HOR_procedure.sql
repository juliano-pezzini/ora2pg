-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE suspender_prescr_gas_hor ( nr_prescricao_p bigint, nr_seq_gasoterapia_p bigint, nr_seq_horario_p bigint, nm_usuario_p text, ie_gas_evento_p text default 'S') AS $body$
DECLARE


nr_seq_horario_ww		bigint;
nr_seq_horario_w		bigint;
ie_hor_supenso_w		varchar(2);
ie_evento_ww			varchar(15);
ie_horario_especial_w	varchar(10);
ie_verifica_w			bigint;
nr_seq_evento_w			bigint;
nr_etapa_evento_w		bigint;

BEGIN
	select	obter_se_gas_hor_susp(nr_prescricao_p, nr_seq_gasoterapia_p)
	into STRICT 	ie_hor_supenso_w
	;

	if (coalesce(nr_seq_horario_p::text, '') = '') or (nr_seq_horario_p = 0) or (nr_seq_horario_p <> '') then
		select	min(nr_sequencia)
		into STRICT	nr_seq_horario_ww
		from	prescr_gasoterapia_hor
		where	nr_seq_gasoterapia	= nr_seq_gasoterapia_p
		and 	nr_prescricao		= nr_prescricao_p
		and		coalesce(dt_fim_horario::text, '') = ''
		and 	coalesce(dt_suspensao::text, '') = '';
	else
		nr_seq_horario_ww := nr_seq_horario_p;
	end if;

	if (ie_hor_supenso_w = 'S')then
		update	prescr_gasoterapia_hor
		set		dt_suspensao = clock_timestamp(),
				nm_usuario_susp = nm_usuario_p
		where	nr_seq_gasoterapia	= nr_seq_gasoterapia_p
		and 	nr_prescricao		= nr_prescricao_p
		and	coalesce(dt_fim_horario::text, '') = '';
		ie_evento_ww := 'S';

	elsif (ie_hor_supenso_w = 'N') then
		select	max(ie_horario_especial)
		into STRICT	ie_horario_especial_w
		from 	prescr_gasoterapia_hor
		where 	nr_prescricao = nr_prescricao_p
		and 	nr_seq_gasoterapia = nr_seq_gasoterapia_p
		and 	nr_sequencia	 = nr_seq_horario_ww
		and 	coalesce(dt_suspensao::text, '') = '';
		-- Se houver  um horário selecionado, suspende aquele horário
		if (nr_seq_horario_ww IS NOT NULL AND nr_seq_horario_ww::text <> '') and (nr_seq_horario_ww > 0) and (ie_horario_especial_w = 'N') then
			select 	max(nr_Etapa)
			into STRICT	nr_etapa_evento_w
			from 	prescr_gasoterapia_hor
			where	nr_prescricao = nr_prescricao_p
			and 	nr_sequencia	= nr_seq_horario_ww
			and	nr_seq_gasoterapia	= nr_seq_gasoterapia_p;

			update	prescr_gasoterapia_hor
			set		dt_suspensao = clock_timestamp(),
					nm_usuario_susp = nm_usuario_p
			where	nr_seq_gasoterapia	= nr_seq_gasoterapia_p
			and 	nr_sequencia		= nr_seq_horario_ww
			and 	nr_prescricao		= nr_prescricao_p
			and		coalesce(dt_fim_horario::text, '') = '';
			ie_evento_ww  := 'SH';
			nr_seq_horario_w := nr_seq_horario_ww;
		--- Se não suspende o item todo
		elsif (ie_horario_especial_w = 'S') then
			update	prescr_gasoterapia_hor
			set		dt_suspensao = clock_timestamp(),
					nm_usuario_susp = nm_usuario_p
			where	nr_seq_gasoterapia	= nr_seq_gasoterapia_p
			and 	nr_prescricao		= nr_prescricao_p
			and		coalesce(dt_fim_horario::text, '') = '';
			ie_evento_ww := 'S';
		else
			select	count(*)
			into STRICT	ie_verifica_w
			from 	prescr_gasoterapia_hor
			where 	nr_prescricao = nr_prescricao_p
			and 	nr_seq_gasoterapia = nr_seq_gasoterapia_p
			and	ie_horario_especial <> 'S';

			if (ie_verifica_w > 0) then
				select	min(nr_sequencia)
				into STRICT	nr_seq_horario_w
				from 	prescr_gasoterapia_hor
				where	nr_seq_gasoterapia = nr_seq_gasoterapia_p
				and 	nr_prescricao	= nr_prescricao
				and 	ie_horario_especial <> 'S';

				update	prescr_gasoterapia_hor
				set		dt_suspensao = clock_timestamp(),
						nm_usuario_susp = nm_usuario_p
				where	nr_seq_gasoterapia	= nr_seq_gasoterapia_p
				and 	nr_sequencia		= nr_seq_horario_w
				and 	nr_prescricao		= nr_prescricao_p
				and		coalesce(dt_fim_horario::text, '') = '';
				ie_evento_ww  := 'SH';
			else
				update	prescr_gasoterapia_hor
				set		dt_suspensao = clock_timestamp(),
						nm_usuario_susp = nm_usuario_p
				where	coalesce(dt_fim_horario::text, '') = ''
				and		nr_seq_gasoterapia	= nr_seq_gasoterapia_p
				and 	nr_prescricao		= nr_prescricao_p;
				ie_evento_ww := 'S';
			end if;
		end if;
	end if;

	if (ie_gas_evento_p = 'S') then
		select	nextval('prescr_gasoterapia_evento_seq')
		into STRICT	nr_seq_evento_w
		;

		insert into prescr_gasoterapia_evento(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_gasoterapia,
					ie_evento,
					dt_evento,
					ie_evento_valido,
					nr_seq_assinatura,
					nr_seq_horario,
					ds_justificativa,
					nr_etapa_evento)
		values (nr_seq_evento_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_gasoterapia_p,
					ie_evento_ww,
					clock_timestamp(),
					'S',
					0,
					nr_seq_horario_w,
					null,
					nr_etapa_evento_w);
	end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE suspender_prescr_gas_hor ( nr_prescricao_p bigint, nr_seq_gasoterapia_p bigint, nr_seq_horario_p bigint, nm_usuario_p text, ie_gas_evento_p text default 'S') FROM PUBLIC;

