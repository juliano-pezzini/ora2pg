-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consistir_dados_inter_a550 (nr_seq_contest_p ptu_camara_contestacao.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, ie_tipo_arquivo_p w_pls_inconsistencia_int.ie_tipo_arquivo%type ) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Efetuar consistencia do A550 TXT
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[X]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 

nr_seq_questionamento_w		bigint;
nr_seq_quest_codigo_w		bigint;
nr_seq_mot_questionamento_w	bigint;
ds_complemento_w		w_pls_inconsistencia_int.ds_complemento%type := null;
ie_pacote_w			varchar(2);
cd_pacote_w			varchar(10);
ds_parecer_glosa_w		varchar(4000);
cd_motivo_w			varchar(10);
ds_motivo_w			varchar(255);
qt_registro_w			bigint := 0;
qt_cobrada_w			integer;
qt_reconh_w			integer;
vl_acordo_w			double precision := 0;
vl_acordo_adic_co_w		double precision := 0;
vl_acordo_adic_filme_w		double precision := 0;
vl_acordo_adic_serv_w		double precision := 0;
vl_acordo_co_w			double precision := 0;
vl_acordo_filme_w		double precision := 0;
vl_cobr_adic_co_w		double precision := 0;
vl_cobr_adic_filme_w		double precision := 0;
vl_cobr_adic_serv_w		double precision := 0;
vl_cobrado_w			double precision := 0;
vl_cobr_co_w			double precision := 0;
vl_cobr_filme_w			double precision := 0;
vl_reconh_adic_co_w		double precision := 0;
vl_reconh_adic_filme_w		double precision := 0;
vl_reconh_adic_serv_w		double precision := 0;
vl_reconh_co_w			double precision := 0;
vl_reconhecido_w		double precision := 0;
vl_reconh_filme_w		double precision := 0;
vl_total_contestacao_w		double precision := 0;
vl_total_pago_w			double precision := 0;
vl_total_fatura_w		double precision := 0;
vl_total_contest_ndc_w		double precision := 0;
vl_total_pago_ndc_w		double precision := 0;
vl_total_ndc_a500_w		double precision := 0;
ie_negativo_w			varchar(2) := 'N';
nr_nota_w			ptu_nota_cobranca.nr_nota%type;
ds_mot_questionamento_w		varchar(2000);
nr_seq_conta_proc_w		ptu_questionamento.nr_seq_conta_proc%type;
nr_seq_conta_mat_w		ptu_questionamento.nr_seq_conta_mat%type;
nr_id_analise_w			bigint;
nr_seq_lote_contest_w		bigint;
nr_seq_ptu_fatura_w		bigint;
nr_seq_pls_fatura_w		bigint;
nr_seq_lote_fat_w		bigint;
cd_servico_w			bigint;
nr_seq_conta_w			bigint;
ie_tipo_tabela_w		smallint;
nr_nota_numerico_w		ptu_questionamento.nr_nota_numerico%type;
qt_tot_r552_w			bigint;
ie_tipo_arquivo_cob_w		ptu_camara_contestacao.ie_tipo_arquivo_cob%type;
nr_seq_congenere_w		pls_congenere.nr_sequencia%type;
qt_cong_camara_w		integer;
ie_processo_w			varchar(255);

C01 CURSOR FOR
	SELECT	nr_sequencia,
		coalesce(ie_pacote,'N'),
		cd_pacote,
		coalesce(qt_cobrada,0),
		coalesce(qt_reconh,0),
		coalesce(vl_acordo,0),
		coalesce(vl_acordo_adic_co,0),
		coalesce(vl_acordo_adic_filme,0),
		coalesce(vl_acordo_adic_serv,0),
		coalesce(vl_acordo_co,0),
		coalesce(vl_acordo_filme,0),
		coalesce(vl_cobr_adic_co,0),
		coalesce(vl_cobr_adic_filme,0),
		coalesce(vl_cobr_adic_serv,0),
		coalesce(vl_cobrado,0),
		coalesce(vl_cobr_co,0),
		coalesce(vl_cobr_filme,0),
		coalesce(vl_reconh_adic_co,0),
		coalesce(vl_reconh_adic_filme,0),
		coalesce(vl_reconh_adic_serv,0),
		coalesce(vl_reconh_co,0),
		coalesce(vl_reconhecido,0),
		coalesce(vl_reconh_filme,0),
		nr_nota,
		nr_seq_conta_proc,
		nr_seq_conta_mat,
		cd_servico,
		nr_seq_conta,
		ie_tipo_tabela,
		nr_nota_numerico
	from	ptu_questionamento
	where	nr_seq_contestacao	= nr_seq_contest_p
	and	ie_tipo_acordo not in ('11')
	and	ie_tipo_arquivo_cob_w	= '502'
	order by 1;
	
C02 CURSOR FOR
	SELECT	nr_sequencia,
		ds_parecer_glosa,
		nr_seq_mot_questionamento,
		substr(pls_obter_desc_contestacao(nr_seq_mot_questionamento, null),1,255)
	from	ptu_questionamento_codigo
	where	nr_seq_registro = nr_seq_questionamento_w
	order by 1;
	

BEGIN
delete	FROM w_pls_inconsistencia_int
where	nr_seq_contestacao = nr_seq_contest_p;

select	coalesce(max(vl_total_contestacao),0),
	coalesce(max(vl_total_pago),0),
	coalesce(max(vl_total_fatura),0),
	coalesce(max(vl_total_contest_ndc),0),
	coalesce(max(vl_total_pago_ndc),0),
	coalesce(max(vl_total_ndc_a500),0),
	max(nr_seq_lote_contest),
	max(coalesce(qt_tot_r552,0)),
	coalesce(max(ie_tipo_arquivo_cob),'502')
into STRICT	vl_total_contestacao_w,
	vl_total_pago_w,
	vl_total_fatura_w,
	vl_total_contest_ndc_w,
	vl_total_pago_ndc_w,
	vl_total_ndc_a500_w,
	nr_seq_lote_contest_w,
	qt_tot_r552_w,
	ie_tipo_arquivo_cob_w
from	ptu_camara_contestacao
where	nr_sequencia = nr_seq_contest_p;

-- Gerar LOG
pls_gerar_contest_log(	nr_seq_lote_contest_w, null, null, null, null, null, 'CA550', 'N', nm_usuario_p);

if (nr_seq_lote_contest_w IS NOT NULL AND nr_seq_lote_contest_w::text <> '') then
	select	nr_seq_ptu_fatura,
		nr_seq_pls_fatura,
		pls_obter_dados_lote_contest(nr_sequencia,'PC') ie_processo
	into STRICT	nr_seq_ptu_fatura_w,
		nr_seq_pls_fatura_w,
		ie_processo_w
	from	pls_lote_contestacao
	where	nr_sequencia = nr_seq_lote_contest_w;
end if;

if (nr_seq_pls_fatura_w IS NOT NULL AND nr_seq_pls_fatura_w::text <> '') then
	select	max(nr_seq_lote),
		max(nr_seq_congenere)
	into STRICT	nr_seq_lote_fat_w,
		nr_seq_congenere_w
	from	pls_fatura
	where	nr_sequencia = nr_seq_pls_fatura_w;
elsif (nr_seq_ptu_fatura_w IS NOT NULL AND nr_seq_ptu_fatura_w::text <> '') then
	select	max(nr_sequencia)
	into STRICT	nr_seq_congenere_w
	from	pls_congenere
	where	somente_numero(cd_cooperativa) = (	SELECT	somente_numero(max(cd_unimed_origem))
					from	ptu_fatura
					where	nr_sequencia = nr_seq_ptu_fatura_w);	
end if;

--verificar se a fatura e de camera pra nao gerar a inconsistencia abaixo
if (nr_seq_congenere_w IS NOT NULL AND nr_seq_congenere_w::text <> '') then
	select count(1)
	into STRICT	qt_cong_camara_w
	from	pls_congenere_camara
	where	nr_seq_congenere = nr_seq_congenere_w;
else
	qt_cong_camara_w := 0;
end if;	

if (nr_seq_ptu_fatura_w IS NOT NULL AND nr_seq_ptu_fatura_w::text <> '') then
	if	((vl_total_contestacao_w + vl_total_pago_w) <> vl_total_fatura_w) and (qt_cong_camara_w = 0) and (ie_processo_w = 'P') then -- 19/04/16 - OS 1049419 - jtonon
		ds_complemento_w := 	substr(	'Valor total calculado esta diferente do valor total da fatura.'||chr(10)||chr(10)||
						'- Vl total contestado fatura: '||Campo_Mascara_virgula(vl_total_contestacao_w)||chr(10)||
						'- Vl total pago fatura: '||Campo_Mascara_virgula(vl_total_pago_w)||chr(10)||
						'- Vl total calulado: '||Campo_Mascara_virgula(vl_total_contestacao_w + vl_total_pago_w)||chr(10)||chr(10)||
						'- Vl total da fatura: '||Campo_Mascara_virgula(vl_total_fatura_w),1,2000);
		
		-- 32 - O resultado da soma dos campos "Vl total contestado fatura" e "Vl total pago fatura" esta diferente do campo "Vl total da fatura"
		pls_inserir_incon_intercambio( 32, null, nr_seq_contest_p, ds_complemento_w, cd_estabelecimento_p, nm_usuario_p, ie_tipo_arquivo_p, nr_seq_lote_contest_w);
	end if;
	
	if	((vl_total_contest_ndc_w + vl_total_pago_ndc_w) <> vl_total_ndc_a500_w) and (ie_processo_w = 'P') then -- 19/04/16 - OS 1049419 - jtonon
		ds_complemento_w := 	substr(	'Valor total calculado esta diferente do valor total da NDC.'||chr(10)||chr(10)||
						'- Vl total contestado NDC: '||Campo_Mascara_virgula(vl_total_contest_ndc_w)||chr(10)||
						'- Vl total pago NDC: '||Campo_Mascara_virgula(vl_total_pago_ndc_w)||chr(10)||
						'- Vl total calulado: '||Campo_Mascara_virgula(vl_total_contest_ndc_w + vl_total_pago_ndc_w)||chr(10)||chr(10)||
						'- Vl total NDC: '||Campo_Mascara_virgula(vl_total_ndc_a500_w),1,2000);
		
		-- 33 - O resultado da soma dos campos "Vl total contestado NDC" e "Vl total pago NDC" esta diferente do campo "Vl total NDC"
		pls_inserir_incon_intercambio( 33, null, nr_seq_contest_p, ds_complemento_w, cd_estabelecimento_p, nm_usuario_p, ie_tipo_arquivo_p, nr_seq_lote_contest_w);
	end if;
end if;

if (qt_tot_r552_w > 0) then
	select	count(1)
	into STRICT	qt_registro_w
	from	ptu_questionamento
	where	nr_seq_contestacao = nr_seq_contest_p;
	
	if (qt_registro_w <> qt_tot_r552_w) then
		ds_complemento_w := 	substr(	'Quantidade total do registro 552: '||qt_tot_r552_w||chr(10)||
						'Quantidade total de servicos: '||qt_registro_w,1,2000);
		
		-- 137 - A quantidade total do registro 552 esta diferente da quantidade total de servicos
		pls_inserir_incon_intercambio( 137, null, nr_seq_contest_p, ds_complemento_w, cd_estabelecimento_p, nm_usuario_p, ie_tipo_arquivo_p, nr_seq_lote_contest_w);
	end if;
end if;
	
open C01;
loop
fetch C01 into	
	nr_seq_questionamento_w,
	ie_pacote_w,
	cd_pacote_w,
	qt_cobrada_w,
	qt_reconh_w,
	vl_acordo_w,
	vl_acordo_adic_co_w,
	vl_acordo_adic_filme_w,
	vl_acordo_adic_serv_w,
	vl_acordo_co_w,
	vl_acordo_filme_w,
	vl_cobr_adic_co_w,
	vl_cobr_adic_filme_w,
	vl_cobr_adic_serv_w,
	vl_cobrado_w,
	vl_cobr_co_w,
	vl_cobr_filme_w,
	vl_reconh_adic_co_w,
	vl_reconh_adic_filme_w,
	vl_reconh_adic_serv_w,
	vl_reconh_co_w,
	vl_reconhecido_w,
	vl_reconh_filme_w,
	nr_nota_w,
	nr_seq_conta_proc_w,
	nr_seq_conta_mat_w,
	cd_servico_w,
	nr_seq_conta_w,
	ie_tipo_tabela_w,
	nr_nota_numerico_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ie_negativo_w 		:= 'N';
	ds_complemento_w 	:= '';
	ds_mot_questionamento_w := null;
	nr_id_analise_w		:= null;
	
	if (nr_seq_conta_proc_w IS NOT NULL AND nr_seq_conta_proc_w::text <> '') then
		select	max(nr_id_analise)
		into STRICT	nr_id_analise_w
		from	pls_conta_proc
		where	nr_sequencia	= nr_seq_conta_proc_w;
		
	elsif (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') then
		select	max(nr_id_analise)
		into STRICT	nr_id_analise_w
		from	pls_conta_mat
		where	nr_sequencia	= nr_seq_conta_mat_w;
	end if;
	
	open C02;
	loop
	fetch C02 into	
		nr_seq_quest_codigo_w,
		ds_parecer_glosa_w,
		nr_seq_mot_questionamento_w,
		ds_motivo_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		if (coalesce(ds_mot_questionamento_w::text, '') = '') then
			ds_mot_questionamento_w := substr('- '||ds_motivo_w,1,2000);
		else
			ds_mot_questionamento_w := substr(ds_mot_questionamento_w ||chr(10)||'- '||ds_motivo_w,1,2000);
		end if;
		end;
	end loop;
	close C02;
	
	ds_motivo_w := null;
	
	if (ie_pacote_w = 'S') and (coalesce(cd_pacote_w::text, '') = '') and (nr_seq_ptu_fatura_w IS NOT NULL AND nr_seq_ptu_fatura_w::text <> '') then		
		ds_complemento_w := 	substr(	'O item e de pacote mas nao contem codigo do pacote.'||chr(10)||chr(10)||
						'Questionamento: '||nr_seq_questionamento_w||chr(10)||
						'Nr nota: '||nr_nota_w||chr(10)||
						'Nr ID analise: ' || nr_id_analise_w||chr(10)||chr(10)||
						'Motivo questionamente: '||chr(10)||ds_mot_questionamento_w,1,2000);

		-- 8 - Quando o campo IE_PACOTE for preenchido com S, o campo CD_PACOTE e obrigatorio.
		pls_inserir_incon_intercambio( 8, null, nr_seq_contest_p, ds_complemento_w, cd_estabelecimento_p, nm_usuario_p, ie_tipo_arquivo_p, nr_seq_lote_contest_w);
	end if;
	
	open C02;
	loop
	fetch C02 into	
		nr_seq_quest_codigo_w,
		ds_parecer_glosa_w,
		nr_seq_mot_questionamento_w,
		ds_motivo_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		select	max(cd_motivo)
		into STRICT	cd_motivo_w
		from	ptu_motivo_questionamento
		where	nr_sequencia = nr_seq_mot_questionamento_w;
		
		if (cd_motivo_w = '98') and (coalesce(ds_parecer_glosa_w::text, '') = '') and (nr_seq_ptu_fatura_w IS NOT NULL AND nr_seq_ptu_fatura_w::text <> '') then
			ds_complemento_w := 	substr(	'Quando for motivo de questionamento de codigo "98", o parecer e obrigatorio.'||chr(10)||
							'Motivo: '|| ds_motivo_w ||chr(10)||chr(10)||
							'Questionamento: '||nr_seq_questionamento_w||chr(10)||
							'Nr nota: '||nr_nota_w||chr(10)||
							'Nr ID analise: ' || nr_id_analise_w||chr(10)||chr(10)||
							'Motivo questionamente: '||chr(10)||ds_mot_questionamento_w,1,2000);

			-- 27 - O questionamento com motivo 98 nao contem parecer.
			pls_inserir_incon_intercambio( 27, null, nr_seq_contest_p, ds_complemento_w, cd_estabelecimento_p, nm_usuario_p, ie_tipo_arquivo_p, nr_seq_lote_contest_w);
		end if;
		
		end;
	end loop;
	close C02;
	
	select	count(1)
	into STRICT	qt_registro_w
	from	ptu_questionamento_codigo
	where	nr_seq_registro = nr_seq_questionamento_w  LIMIT 1;
	
	if (qt_registro_w = 0) and (nr_seq_ptu_fatura_w IS NOT NULL AND nr_seq_ptu_fatura_w::text <> '') then
		ds_complemento_w := 	'Item de questionamento gerado sem motivo de questionamento.'||chr(10)||chr(10)||
					'Questionamento: '||nr_seq_questionamento_w||chr(10)||
					'Nr nota: '||nr_nota_w||chr(10)||
					'Nr ID analise: ' || nr_id_analise_w;

		-- 28 - O questionamento foi gerado sem motivo de questionamento.
		pls_inserir_incon_intercambio( 28, null, nr_seq_contest_p, ds_complemento_w, cd_estabelecimento_p, nm_usuario_p, ie_tipo_arquivo_p, nr_seq_lote_contest_w);
	end if;
	
	ds_complemento_w := '';
	if (qt_cobrada_w < 0) then
		ie_negativo_w := 'S';
		ds_complemento_w := ds_complemento_w||chr(10)||'- Qt cobrada';
	end if;
	
	if (qt_reconh_w < 0) then
		ie_negativo_w := 'S';
		ds_complemento_w := ds_complemento_w||chr(10)||'- Qt reconhecida';
	end if;
	
	if (vl_acordo_w < 0) then
		ie_negativo_w := 'S';
		ds_complemento_w := ds_complemento_w||chr(10)||'- Vl acordo HI';
	end if;
	
	if (vl_acordo_adic_co_w < 0) then
		ie_negativo_w := 'S';
		ds_complemento_w := ds_complemento_w||chr(10)||'- Vl acordo adic CO';
	end if;
	
	if (vl_acordo_adic_filme_w < 0) then
		ie_negativo_w := 'S';
		ds_complemento_w := ds_complemento_w||chr(10)||'- Vl acordo adic filme';
	end if;
	
	if (vl_acordo_adic_serv_w < 0) then
		ie_negativo_w := 'S';
		ds_complemento_w := ds_complemento_w||chr(10)||'- Vl acordo adic serv';
	end if;
	
	if (vl_acordo_co_w < 0) then
		ie_negativo_w := 'S';
		ds_complemento_w := ds_complemento_w||chr(10)||'- Vl acordo CO';
	end if;
	
	if (vl_acordo_filme_w < 0) then
		ie_negativo_w := 'S';
		ds_complemento_w := ds_complemento_w||chr(10)||'- Vl acordo flime';
	end if;
	
	if (vl_cobr_adic_co_w < 0) then
		ie_negativo_w := 'S';
		ds_complemento_w := ds_complemento_w||chr(10)||'- Vl cobrado adic CO';
	end if;
	
	if (vl_cobr_adic_filme_w < 0) then
		ie_negativo_w := 'S';
		ds_complemento_w := ds_complemento_w||chr(10)||'- Vl cobrado adic filme';
	end if;
	
	if (vl_cobr_adic_serv_w < 0) then
		ie_negativo_w := 'S';
		ds_complemento_w := ds_complemento_w||chr(10)||'- Vl cobrado adic serv';
	end if;
	
	if (vl_cobrado_w < 0) then
		ie_negativo_w := 'S';
		ds_complemento_w := ds_complemento_w||chr(10)||'- Vl cobrado HI';
	end if;
	
	if (vl_cobr_co_w < 0) then
		ie_negativo_w := 'S';
		ds_complemento_w := ds_complemento_w||chr(10)||'- Vl cobrado CO';
	end if;
	
	if (vl_cobr_filme_w < 0) then
		ie_negativo_w := 'S';
		ds_complemento_w := ds_complemento_w||chr(10)||'- Vl cobrado filme';
	end if;
	
	if (vl_reconh_adic_co_w < 0) then
		ie_negativo_w := 'S';
		ds_complemento_w := ds_complemento_w||chr(10)||'- Vl reconhecido adic CO';
	end if;
	
	if (vl_reconh_adic_filme_w < 0) then
		ie_negativo_w := 'S';
		ds_complemento_w := ds_complemento_w||chr(10)||'- Vl reconheido adic filme';
	end if;
	
	if (vl_reconh_adic_serv_w < 0) then
		ie_negativo_w := 'S';
		ds_complemento_w := ds_complemento_w||chr(10)||'- Vl reconhecido adic serv';
	end if;
	
	if (vl_reconh_co_w < 0) then
		ie_negativo_w := 'S';
		ds_complemento_w := ds_complemento_w||chr(10)||'- Vl reconhecido CO';
	end if;
	
	if (vl_reconhecido_w < 0) then
		ie_negativo_w := 'S';
		ds_complemento_w := ds_complemento_w||chr(10)||'- Vl reconhecido HI';
	end if;
	
	if (vl_reconh_filme_w < 0) then
		ie_negativo_w := 'S';
		ds_complemento_w := ds_complemento_w||chr(10)||'- Vl reconhecido filme';
	end if;
	
	if (coalesce(ie_negativo_w,'N') = 'S') and (nr_seq_ptu_fatura_w IS NOT NULL AND nr_seq_ptu_fatura_w::text <> '') then	
		ds_complemento_w := 	substr(	'Campos: ' ||chr(10)||ds_complemento_w ||chr(10)||chr(10)||
						'Questionamento: '||nr_seq_questionamento_w||chr(10)||
						'Nr nota: '||nr_nota_w||chr(10)||
						'Nr ID analise: ' || nr_id_analise_w||chr(10)||chr(10)||
						'Motivo questionamente: '||chr(10)||ds_mot_questionamento_w,1,2000);
					
		-- 29 - Questionamento gerado com valor ou quantidade negativa.
		pls_inserir_incon_intercambio( 29, null, nr_seq_contest_p, ds_complemento_w, cd_estabelecimento_p, nm_usuario_p, ie_tipo_arquivo_p, nr_seq_lote_contest_w);
	end if;	
	
	if (nr_seq_pls_fatura_w IS NOT NULL AND nr_seq_pls_fatura_w::text <> '') then
		if (coalesce(nr_seq_conta_w::text, '') = '') then
			select	count(1)
			into STRICT	qt_registro_w
			from	ptu_nota_cobranca c,
				ptu_fatura	a
			where	a.nr_sequencia		= c.nr_seq_fatura
			and	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_w
			and	c.nr_nota		= nr_nota_w;
			
			if (qt_registro_w = 0) then
				select	count(1)
				into STRICT	qt_registro_w
				from	ptu_nota_cobranca c,
					ptu_fatura	a
				where	a.nr_sequencia		= c.nr_seq_fatura
				and	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_w
				and	substr(c.nr_nota,1,11)	= nr_nota_w;
				
				if (qt_registro_w = 0) then
					select	count(1)
					into STRICT	qt_registro_w
					from	ptu_nota_cobranca c,
						ptu_fatura	a
					where	a.nr_sequencia		= c.nr_seq_fatura
					and	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_w
					and	c.nr_nota_numerico	= nr_nota_numerico_w;
				end if;
			end if;
		
			if (qt_registro_w = 0) then
				ds_complemento_w :=	substr(	'Nao foi localizado na fatura o NR_NOTA: '|| nr_nota_w ||chr(10)||chr(10)||
								'Questionamento: '||nr_seq_questionamento_w||chr(10)||
								'Nr nota: '||nr_nota_w||chr(10)||
								'Fatura: '||nr_seq_pls_fatura_w||chr(10)||
								'Lote faturamento: '||nr_seq_lote_fat_w||chr(10)||chr(10)||
								'Observacao: Funcao OPS - Faturamento, pasta PTU> Notas> Cobrancas',1,2000);
							
				-- 35 - Nota inexistente na fatura
				pls_inserir_incon_intercambio( 35, null, nr_seq_contest_p, ds_complemento_w, cd_estabelecimento_p, nm_usuario_p, ie_tipo_arquivo_p, nr_seq_lote_contest_w);
			end if;
		
			select	count(1)
			into STRICT	qt_registro_w
			from	ptu_nota_servico	c,
				ptu_nota_cobranca	b,
				ptu_fatura		a
			where	c.nr_seq_nota_cobr	= b.nr_sequencia
			and	b.nr_seq_fatura		= a.nr_sequencia
			and	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_w
			and	b.nr_nota		= nr_nota_w
			and	((c.cd_servico		= cd_servico_w) or (c.cd_procedimento	= cd_servico_w) or
				(cd_servico_w		= (	SELECT	max(cd_material_ops)
								from	pls_material
								where	nr_sequencia 	= c.nr_seq_material)))
			and	c.ie_tipo_tabela	= ie_tipo_tabela_w;
			
		
			if (qt_registro_w = 0) then
				select	count(1)
				into STRICT	qt_registro_w
				from	ptu_nota_servico	c,
					ptu_nota_cobranca	b,
					ptu_fatura		a
				where	c.nr_seq_nota_cobr	= b.nr_sequencia
				and	b.nr_seq_fatura		= a.nr_sequencia
				and	a.nr_seq_pls_fatura	= nr_seq_pls_fatura_w
				and	b.nr_nota_numerico	= nr_nota_numerico_w
				and	((c.cd_servico		= cd_servico_w) or (c.cd_procedimento	= cd_servico_w) or
					(cd_servico_w		= (	SELECT	max(cd_material_ops)
									from	pls_material
									where	nr_sequencia 	= c.nr_seq_material)))
				and	c.ie_tipo_tabela	= ie_tipo_tabela_w;
			end if;
			
			if (qt_registro_w = 0) then
				ds_complemento_w :=	substr(	'Nao foi localizado na nota (cobranca) o servico: '|| cd_servico_w ||chr(10)||chr(10)||
								'Questionamento: '||nr_seq_questionamento_w||chr(10)||
								'Nr nota: '||nr_nota_w||chr(10)||
								'Fatura: '||nr_seq_pls_fatura_w||chr(10)||
								'Lote faturamento: '||nr_seq_lote_fat_w||chr(10)||chr(10)||
								'Observacao: Funcao OPS - Faturamento, pasta PTU> Notas> Cobrancas (Servicos)',1,2000);
							
				-- 36 - Servico inexistente para a nota informada
				pls_inserir_incon_intercambio( 36, null, nr_seq_contest_p, ds_complemento_w, cd_estabelecimento_p, nm_usuario_p, ie_tipo_arquivo_p, nr_seq_lote_contest_w);
			end if;
		end if;
	end if;
	
	if (nr_seq_ptu_fatura_w IS NOT NULL AND nr_seq_ptu_fatura_w::text <> '') then
		qt_registro_w := 0;
		
		if (nr_seq_conta_proc_w IS NOT NULL AND nr_seq_conta_proc_w::text <> '') then
			select	count(1)
			into STRICT	qt_registro_w
			from	pls_conta_proc
			where	nr_sequencia	= nr_seq_conta_proc_w
			and	coalesce(vl_glosa,0) <= 0;
		
		elsif (nr_seq_conta_mat_w IS NOT NULL AND nr_seq_conta_mat_w::text <> '') then
			select	count(1)
			into STRICT	qt_registro_w
			from	pls_conta_mat
			where	nr_sequencia	= nr_seq_conta_mat_w
			and	coalesce(vl_glosa,0) <= 0;
		end if;	
		
		if (qt_registro_w > 0) then
			ds_complemento_w := 	substr(	'O item nao tem valor de glosa (cobranca) necessario para geracao do arquivo A550.'||chr(10)||chr(10)||
							'Questionamento: '||nr_seq_questionamento_w||chr(10)||
							'Nr nota: '||nr_nota_w||chr(10)||
							'Nr ID analise: ' || nr_id_analise_w||chr(10)||chr(10)||
							'Motivo questionamente: '||chr(10)||ds_mot_questionamento_w,1,2000);

			-- 144 - O item nao tem valor de glosa (cobranca) necessario para geracao do arquivo A550.
			pls_inserir_incon_intercambio( 144, null, nr_seq_contest_p, ds_complemento_w, cd_estabelecimento_p, nm_usuario_p, ie_tipo_arquivo_p, nr_seq_lote_contest_w);
		end if;
	end if;
	
	end;
end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consistir_dados_inter_a550 (nr_seq_contest_p ptu_camara_contestacao.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, ie_tipo_arquivo_p w_pls_inconsistencia_int.ie_tipo_arquivo%type ) FROM PUBLIC;

