-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_prot_material ( cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_protocolo_p bigint, nr_seq_protocolo_p bigint, nr_seq_item_p bigint, nr_atendimento_p bigint, cd_paciente_p text, cd_prescritor_p text, cd_setor_atendimento_p bigint, nr_seq_agrupamento_p bigint, qt_idade_dia_p bigint, qt_idade_mes_p bigint, qt_idade_ano_p bigint, qt_peso_p bigint, nr_seq_item_gerado_p INOUT cpoe_material.nr_sequencia%type, nr_seq_pend_pac_acao_p gqa_pend_pac_acao.nr_sequencia%type default null, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, ie_oncologia_p text default 'N', nr_seq_conclusao_apae_p bigint default null, dt_fim_presc_p timestamp default null, dt_inicio_presc_p timestamp default null, ie_futuro_p text default 'N', nr_seq_cpoe_rp_p cpoe_rp.nr_sequencia%type default null, nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) AS $body$
DECLARE
							

ds_stack_w					log_cpoe.ds_stack%type;
ds_log_cpoe_w				log_cpoe.ds_log%type;
cd_material_w				protocolo_medic_material.cd_material%type;
cd_unidade_medida_w			protocolo_medic_material.cd_unidade_medida%type;
qt_dose_w					protocolo_medic_material.qt_dose%type;
qt_dose_limite_w			protocolo_medic_material.qt_dose%type;
cd_intervalo_w				protocolo_medic_material.cd_intervalo%type;
cd_intervalo_agora_w		protocolo_medic_material.cd_intervalo%type;
hr_prim_horario_w			protocolo_medic_material.hr_prim_horario%type;
ds_justificativa_w			protocolo_medic_material.ds_justificativa%type;
ie_urgencia_w				protocolo_medic_material.ie_urgencia%type;

ie_urgencia_cpoe_w			cpoe_material.ie_urgencia%type;
ds_horarios_aux_w			cpoe_material.ds_horarios%type;
ds_horarios_w				cpoe_material.ds_horarios%type;
nr_ocorrencia_w				cpoe_material.nr_ocorrencia%type;
qt_unitaria_w				cpoe_material.qt_unitaria%type;
dt_inicio_w					cpoe_material.dt_inicio%type;
dt_inicio_base_w			cpoe_material.dt_inicio%type;
dt_fim_w					cpoe_material.dt_inicio%type;

ie_limpar_prim_horario_w	intervalo_prescricao.ie_limpa_prim_hor%type;
qt_min_intervalo_w			intervalo_prescricao.qt_min_intervalo%type;

qt_conversao_dose_w			material_conversao_unidade.qt_conversao%type;
ie_prescr_alta_agora_w		varchar(1);
nr_seq_material_w			protocolo_medic_material.nr_seq_material%type;

c01 CURSOR FOR
SELECT	a.cd_material,
		a.cd_unidade_medida,
		a.qt_dose,
		a.cd_intervalo,
		coalesce(a.ie_urgencia,'N'),
		a.ds_justificativa,
		a.nr_seq_material
from 	protocolo_medic_material a
where	a.cd_protocolo = cd_protocolo_p
and		a.nr_sequencia = nr_seq_protocolo_p
and		a.nr_seq_material = coalesce(nr_seq_item_p,nr_seq_material)
and		a.ie_agrupador = 2
order by
	nr_seq_material;

BEGIN

	if (dt_inicio_presc_p IS NOT NULL AND dt_inicio_presc_p::text <> '') then
		dt_inicio_base_w := dt_inicio_presc_p;
	else	
		dt_inicio_base_w := trunc(clock_timestamp() + (1/24),'hh24');
	end if;

open c01;
loop
fetch c01 into
		cd_material_w,
		cd_unidade_medida_w,
		qt_dose_w,
		cd_intervalo_w,
		ie_urgencia_w,
		ds_justificativa_w,
		nr_seq_material_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	dt_inicio_w			:= dt_inicio_base_w;
	ds_horarios_w		:= '';
	ds_horarios_aux_w	:= '';
	nr_ocorrencia_w		:= 0;
	
	if (coalesce(obter_se_marca_agora(cpoe_obter_setor_atend_prescr(nr_atendimento_p, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p)),'N') = 'S') then
		cd_intervalo_agora_w := cpoe_busca_intervalo_agora(nr_atendimento_p,'2',cd_estabelecimento_p,cd_perfil_p, nm_usuario_p);
		
		if (cd_intervalo_agora_w IS NOT NULL AND cd_intervalo_agora_w::text <> '') then
			cd_intervalo_w := cd_intervalo_agora_w;
			ie_urgencia_w := 'S';
		end if;
		
	end if;		
	
	if (ie_urgencia_w = 'S') then
		ie_urgencia_cpoe_w := '0';
	end if;
	
	if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') then
		select	max(cd_intervalo)
		into STRICT	cd_intervalo_w
		from    intervalo_prescricao
		where   ie_situacao = 'A'
		and 	cd_intervalo = cd_intervalo_w
		and     Obter_se_intervalo(cd_intervalo, '2') = 'S'
		and		Obter_se_intervalo_material(cd_material_w, cd_intervalo) = 'S'
		and     ((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_p))
		order by
			coalesce(nr_seq_apresent,999),
			ds_intervalo;
			
		ie_limpar_prim_horario_w := coalesce(obter_se_limpa_prim_hor(cd_intervalo_w,cd_setor_atendimento_p),'N');
	end if;
			
	if (coalesce(hr_prim_horario_w::text, '') = '') then
		hr_prim_horario_w := cpoe_obter_primeiro_horario(nr_atendimento_p,cd_intervalo_w,cd_material_w,cd_estabelecimento_p,cd_perfil_p,nm_usuario_p, cd_paciente_p);
		if ((coalesce(hr_prim_horario_w::text, '') = '') or (hr_prim_horario_w = '  :  ')) then
			hr_prim_horario_w	:=	to_char(trunc(dt_inicio_base_w,'hh24'),'hh24:mi');
		end if;
	end if;
	
	if ((coalesce(dt_inicio_presc_p::text, '') = '') and (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '')) then
		dt_inicio_w := ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_inicio_base_w, substr(hr_prim_horario_w,1,5));
		if (dt_inicio_w < trunc(clock_timestamp(),'mi')) then
			dt_inicio_w := dt_inicio_w + 1;
		elsif (dt_inicio_w = trunc(clock_timestamp(),'mi')) then
			dt_inicio_w	:= dt_inicio_base_w;
			hr_prim_horario_w	:=	to_char(trunc(dt_inicio_base_w,'hh24'),'hh24:mi');
		end if;
	end if;
		
	if (ie_urgencia_w = 'S') then
		dt_inicio_w			:= clock_timestamp();
		hr_prim_horario_w	:= to_char(trunc(clock_timestamp(),'mi'),'hh24:mi');
	end if;

	select	max(qt_min_intervalo)
	into STRICT	qt_min_intervalo_w
	from	intervalo_prescricao
	where	cd_intervalo = cd_intervalo_w;
	
	SELECT * FROM cpoe_calcular_horario_prescr(	nr_atendimento_p, cd_intervalo_w, cd_material_w, dt_inicio_w, 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;
			
	ds_horarios_w	:= ds_horarios_w || ds_horarios_aux_w;

	if (ie_limpar_prim_horario_w = 'S') then
		ds_horarios_w		:= '';
		hr_prim_horario_w	:= '';
	else
		-- Clear out the text inside the line and adds the sufix of ":00" as needed, fitting it 
		ds_horarios_w := REPLACE(Padroniza_horario_prescr(ds_horarios_w,NULL),'A','');
	end if;
		
	qt_dose_limite_w := coalesce(cpoe_obter_dose_maxima( cd_estabelecimento_p,cd_material_w,cd_unidade_medida_w,qt_dose_w,null,cd_setor_atendimento_p,nr_seq_agrupamento_p,cd_prescritor_p,qt_idade_dia_p,qt_idade_mes_p,qt_idade_ano_p,qt_peso_p),0);
	if (qt_dose_limite_w > 0) then
		qt_dose_w := qt_dose_limite_w;
	end if;
	
	qt_conversao_dose_w	:= coalesce(obter_conversao_unid_med(cd_material_w,cd_unidade_medida_w),1);
	qt_unitaria_w := dividir(trunc(dividir(qt_dose_w * 1000,qt_conversao_dose_w)),1000);
	
	
	
	if (coalesce(ie_prescr_alta_agora_w,'N') = 'S') and (coalesce(ie_item_alta_p,'N') = 'S')	then	

		ie_urgencia_w := 0;	

		hr_prim_horario_w	:= obter_prim_dshorarios(ds_horarios_w);

		dt_inicio_w	:= ESTABLISHMENT_TIMEZONE_UTILS.todayAtTime(hr_prim_horario_w);

		if (dt_inicio_w < clock_timestamp()) then

			dt_inicio_w := dt_inicio_w + 1;

		end if;
	end if;
	
	if (ie_retrogrado_p = 'S' or ie_futuro_p = 'S') then -- retrograde/backward item
		dt_inicio_w := dt_inicio_p;	
		ie_urgencia_cpoe_w 	:= null;	
		nr_ocorrencia_w 	:= 0;
		
		select	max(qt_min_intervalo)
		into STRICT	qt_min_intervalo_w
		from	intervalo_prescricao
		where	cd_intervalo = cd_intervalo_w;
		
		SELECT * FROM cpoe_calcular_horario_prescr(	nr_atendimento_p, cd_intervalo_w, cd_material_w, dt_inicio_w, 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;
				
		ds_horarios_w	:= ds_horarios_w || ds_horarios_aux_w;
		hr_prim_horario_w	:= obter_prim_dshorarios(ds_horarios_w);

		if (ie_limpar_prim_horario_w = 'S') then
			ds_horarios_w		:= '';
			hr_prim_horario_w	:= '';
		else
			-- Clear out the text inside the line and adds the sufix of ":00" as needed, fitting it 
			ds_horarios_w := REPLACE(Padroniza_horario_prescr(ds_horarios_w,NULL),'A','');
		end if;
	end if;
	
	select	nextval('cpoe_material_seq')
	into STRICT	nr_seq_item_gerado_p
	;

	if (dt_fim_presc_p IS NOT NULL AND dt_fim_presc_p::text <> '') then
		dt_fim_w := dt_fim_presc_p;
	else	
		dt_fim_w := ((dt_inicio_w + 1) - 1/1440);
	end if;

	insert into cpoe_material(
				nr_sequencia,
				nr_atendimento, 
				cd_pessoa_fisica,
				cd_material, 
				ie_material,
				qt_dose, 
				cd_unidade_medida, 
				dt_inicio, 
				hr_prim_horario,
				dt_fim,
				cd_intervalo, 
				ie_urgencia, 
				ds_horarios, 
				nr_ocorrencia,
				qt_unitaria,
				ds_justificativa, 
				nm_usuario, 
				nm_usuario_nrec, 
				dt_atualizacao, 
				dt_atualizacao_nrec, 
				cd_perfil_ativo,
				cd_funcao_origem,
				cd_protocolo,
				nr_seq_protocolo,
				nr_seq_pend_pac_acao,
				nr_seq_transcricao,
				ie_item_alta,
				ie_prescritor_aux,
				cd_medico,
				ie_retrogrado,
				ie_futuro,
				nr_seq_pepo,
				nr_cirurgia,
				nr_cirurgia_patologia,
				nr_seq_agenda,
				ie_oncologia,
				nr_seq_conclusao_apae,
				ie_forma_geracao,
				ie_administracao,
				ie_duracao,
				nr_seq_mat_protocolo,
				nr_seq_cpoe_rp, 
				nr_seq_cpoe_order_unit)
			values (
				nr_seq_item_gerado_p,
				nr_atendimento_p, 
				cd_paciente_p,
				cd_material_w,
				'S',
				qt_dose_w,
				cd_unidade_medida_w,
				dt_inicio_w, 
				hr_prim_horario_w,
				dt_fim_w,				
				cd_intervalo_w,
				ie_urgencia_cpoe_w,
				ds_horarios_w,
				nr_ocorrencia_w,
				qt_unitaria_w,
				ds_justificativa_w, 
				nm_usuario_p,
				nm_usuario_p,
				clock_timestamp(),
				clock_timestamp(),
				cd_perfil_p,
				2314,
				cd_protocolo_p,
				nr_seq_protocolo_p,
				nr_seq_pend_pac_acao_p,
				nr_seq_transcricao_p,
				ie_item_alta_p,
				ie_prescritor_aux_p,
				cd_medico_p,
				ie_retrogrado_p,
				ie_futuro_p,
				nr_seq_pepo_p,
				nr_cirurgia_p,
				nr_cirurgia_patologia_p,
				nr_seq_agenda_p,
				ie_oncologia_p,
				nr_seq_conclusao_apae_p,
				'P',
				'P',
				'P',
				nr_seq_material_w,
				nr_seq_cpoe_rp_p, 
				nr_seq_cpoe_order_unit_p);
	end;	
	
	CALL cpoe_gerar_plano_protocolo(nr_atendimento_p, dt_fim_presc_p, nr_seq_item_gerado_p, nm_usuario_p, 'MA');

    CALL cpoe_utils_pck.set_list_itens(nr_seq_item_gerado_p, 'MA');
end loop;
close c01;

commit;

exception
   when others then
	rollback;

	ds_stack_w	:= substr(dbms_utility.format_call_stack,1,2000);
	ds_log_cpoe_w := substr('CPOE_GERAR_PROT_MATERIAL '
		|| chr(13) || ' - cd_estabelecimento_p: ' || cd_estabelecimento_p
		|| chr(13) || ' - cd_perfil_p: ' || cd_perfil_p
		|| chr(13) || ' - nm_usuario_p: ' || nm_usuario_p
		|| chr(13) || ' - cd_protocolo_p: ' || cd_protocolo_p
		|| chr(13) || ' - nr_seq_protocolo_p: ' || nr_seq_protocolo_p
		|| chr(13) || ' - nr_seq_item_p: ' || nr_seq_item_p
		|| chr(13) || ' - nr_atendimento_p: ' || nr_atendimento_p
		|| chr(13) || ' - cd_paciente_p: ' || cd_paciente_p
		|| chr(13) || ' - cd_prescritor_p: ' || cd_prescritor_p
		|| chr(13) || ' - cd_setor_atendimento_p: ' || cd_setor_atendimento_p
		|| chr(13) || ' - nr_seq_agrupamento_p: ' || nr_seq_agrupamento_p
		|| chr(13) || ' - qt_idade_dia_p: ' || qt_idade_dia_p
		|| chr(13) || ' - qt_idade_mes_p: ' || qt_idade_mes_p
		|| chr(13) || ' - qt_idade_ano_p: ' || qt_idade_ano_p
		|| chr(13) || ' - qt_peso_p: ' || qt_peso_p
		|| chr(13) || ' - nr_seq_item_gerado_p: ' || nr_seq_item_gerado_p
		|| chr(13) || ' - nr_seq_pend_pac_acao_p: ' || nr_seq_pend_pac_acao_p
		|| chr(13) || ' - nr_seq_transcricao_p: ' || nr_seq_transcricao_p
		|| chr(13) || ' - ie_item_alta_p: ' || ie_item_alta_p
		|| chr(13) || ' - ie_prescritor_aux_p: ' || ie_prescritor_aux_p
		|| chr(13) || ' - cd_medico_p: ' || cd_medico_p
		|| chr(13) || ' - ie_retrogrado_p: ' || ie_retrogrado_p
		|| chr(13) || ' - ie_futuro_p: ' || ie_futuro_p
		|| chr(13) || ' - dt_inicio_p: ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_inicio_p,'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.gettimezone)
		|| chr(13) || ' - nr_seq_pepo_p: ' || nr_seq_pepo_p
		|| chr(13) || ' - nr_cirurgia_p: ' || nr_cirurgia_p
		|| chr(13) || ' - nr_cirurgia_patologia_p: ' || nr_cirurgia_patologia_p
		|| chr(13) || ' - nr_seq_agenda_p: ' || nr_seq_agenda_p
		|| chr(13) || ' - ie_oncologia_p: ' || ie_oncologia_p
		|| chr(13) || ' - nr_seq_conclusao_apae_p: ' || nr_seq_conclusao_apae_p
		|| chr(13) || ' - dt_fim_presc_p: ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_fim_presc_p,'timestamp', ESTABLISHMENT_TIMEZONE_UTILS.gettimezone)
		|| chr(13) || ' - dt_inicio_presc_p: ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_inicio_presc_p,'timestamp',  ESTABLISHMENT_TIMEZONE_UTILS.gettimezone)
		|| chr(13) || ' - ERRO: ' || sqlerrm
		|| chr(13) || ' - FUNCAO('||to_char(obter_funcao_ativa)||'); PERFIL('||to_char(obter_perfil_ativo)||')',1,2000);
		
	insert into log_cpoe(
		nr_sequencia,
		nr_atendimento, 
		dt_atualizacao, 
		nm_usuario, 
		ds_log, 
		ds_stack) 
	values (
		nextval('log_cpoe_seq'), 
		nr_atendimento_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		ds_log_cpoe_w, 
		ds_stack_w);
		
	commit;

	CALL wheb_mensagem_pck.exibir_mensagem_abort(sqlerrm);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_prot_material ( cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_protocolo_p bigint, nr_seq_protocolo_p bigint, nr_seq_item_p bigint, nr_atendimento_p bigint, cd_paciente_p text, cd_prescritor_p text, cd_setor_atendimento_p bigint, nr_seq_agrupamento_p bigint, qt_idade_dia_p bigint, qt_idade_mes_p bigint, qt_idade_ano_p bigint, qt_peso_p bigint, nr_seq_item_gerado_p INOUT cpoe_material.nr_sequencia%type, nr_seq_pend_pac_acao_p gqa_pend_pac_acao.nr_sequencia%type default null, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, ie_oncologia_p text default 'N', nr_seq_conclusao_apae_p bigint default null, dt_fim_presc_p timestamp default null, dt_inicio_presc_p timestamp default null, ie_futuro_p text default 'N', nr_seq_cpoe_rp_p cpoe_rp.nr_sequencia%type default null, nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) FROM PUBLIC;

