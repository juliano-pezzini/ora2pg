-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE comunic_marcar_todas_lidas ( nm_usuario_cor_p text, ie_restringir_p text, ie_gerencial_p text, apenas_enviada_meu_usuario_p text, ie_somente_meu_usuario_p text, param49_p text, nr_seq_classif_p bigint, cd_setor_usuario_p bigint, cd_usuario_destino_p bigint, nr_seq_p bigint, apenas_enviada_meu_setor_cb_p text, ie_enviar_receb_p text, nr_lista_sequencia_p text, ie_remetente_p text, possui_registros_p text, possui_virgulas_p text, nm_usuario_p text, ie_so_liberadas_p text, ie_restringir_periodo_p text, ie_usuario_destinatario_p text, nm_usuario_destino_p text, nr_dias_anterior_p bigint, ds_titulo_p text, ie_visualiza_estab_dest_adic_p text, dt_inicial_p timestamp, dt_final_p timestamp) AS $body$
DECLARE



query_w                       varchar(8000);
seq_w						lista_varchar_pck.tabela_varchar;

BEGIN
	query_w     := 'select nr_sequencia from comunic_interna where 1 = 1 ';

	query_w     := query_w || 'and substr(obter_se_mostra_comunicacao(nr_sequencia, ' || nm_usuario_cor_p || ', ' || ie_restringir_p || ', ' || ie_gerencial_p || ', ' || nr_seq_classif_p || 'nm_usuario, substr(nm_usuario_destino, 1, 2000), substr(nm_usuario_destino, 2001, 2000), ' || 'ie_geral, ie_gerencial, cd_perfil, nr_seq_classif, substr(ds_perfil_adicional, 1, 2000), substr(ds_perfil_adicional, 2001, 2000), ' || 'ds_setor_adicional, cd_setor_destino, cd_estab_destino, ds_grupo, nm_usuario_oculto, substr(ds_grupo_perfil, 1, 2000), ds_usuarios_ocultos, ' || ie_visualiza_estab_dest_adic_p || ', ds_estab_adicional, cd_especialidade, cd_cargo, cd_perfil_origem, ie_envio_terceiro, ie_funcionario), 1, 1) = ''S''';

  IF ('S'      = apenas_enviada_meu_setor_cb_p AND 'S' = ie_somente_meu_usuario_p) THEN
    query_w   := query_w || ' and (((cd_setor_destino = ' || cd_setor_usuario_p || ') ' || 'or (instr(ds_setor_adicional, ' || cd_setor_usuario_p || ') > 0)) or (';
    IF ('S'    = param49_p) THEN
      query_w := query_w || '((instr(NM_USUARIO_DESTINO, ' || apenas_enviada_meu_usuario_p || ') > 0) ' || ' or (ie_geral = ''S'')))) ';
    ELSE
      query_w := query_w || ' ((instr(NM_USUARIO_DESTINO, ' ||cd_usuario_destino_p || ') > 0)))) ';
    END IF;
  ELSE
    IF ('S'    = apenas_enviada_meu_setor_cb_p) THEN
      query_w := query_w || '    and ((cd_setor_destino = ' || cd_setor_usuario_p || ') ' ||'    or (instr(ds_setor_adicional, ' || cd_setor_usuario_p ||') > 0))   ';
    END IF;
    IF ('S'          = ie_somente_meu_usuario_p) THEN
      IF ('S'        = param49_p) THEN
        IF ('S'      = possui_registros_p)THEN
          IF ('S'    = possui_virgulas_p) THEN
            query_w := query_w || ' and ((instr(NM_USUARIO_DESTINO, ' ||nm_usuario_destino_p ||','') > 0) ' || ' or (ie_geral = ''S''' || ' )) ';
          ELSE
            query_w := query_w || ' and ((instr(NM_USUARIO_DESTINO, ' || nm_usuario_destino_p || ') > 0) ' || ' or (ie_geral = ''S'')) ';
          END IF;
        END IF;
      ELSE
        IF ('S'      = possui_registros_p) THEN
          IF ('S'     = possui_virgulas_p)THEN
            query_w := query_w || ' and instr(nm_usuario_destino, ' ||nm_usuario_p || ') > 0  ';
          ELSE
            query_w := query_w || ' and instr(nm_usuario_destino, ' || nm_usuario_p||', ) > 0 ';
          END IF;
        END IF;
      END IF;
    END IF;
  END IF;

  IF ('S'    = ie_so_liberadas_p) THEN
    query_w := query_w || ' and ((dt_liberacao is not null) or (nm_usuario = ' || nm_usuario_cor_p || ')) ';
  END IF;

  IF ('S'    = ie_restringir_periodo_p) THEN
    query_w := query_w || ' and dt_comunicado between PKG_DATE_UTILS.START_OF(' ||dt_inicial_p || ', ''DD'')'
    || ' and PKG_DATE_UTILS.END_OF(' ||dt_final_p || ', ''DAY'')';
  ELSE
    query_w := query_w || ' and dt_comunicado >= (sysdate - ' || nr_dias_anterior_p || ') ';
  END IF;

  IF (ie_remetente_p IS NOT NULL AND ie_remetente_p::text <> '') THEN
    query_w          := query_w || ' and upper(nm_usuario) = ' || ie_remetente_p;
  END IF;

  IF (ie_usuario_destinatario_p IS NOT NULL AND ie_usuario_destinatario_p::text <> '') THEN
    query_w                     := query_w || ' and instr(nm_usuario_destino, '|| ie_usuario_destinatario_p ||') > 0 ';
  END IF;

  IF (nr_seq_p IS NOT NULL AND nr_seq_p::text <> '') THEN
    query_w    := query_w || ' and nr_sequencia = nr_seq_p ';
  END IF;

  IF ((ie_enviar_receb_p IS NOT NULL AND ie_enviar_receb_p::text <> '') AND '2' <> ie_enviar_receb_p) THEN
    IF ('0'              = ie_enviar_receb_p) THEN
      query_w           := query_w || ' and nm_usuario = nm_usuario_cor_p';
    END IF;
    IF ('1'    = ie_enviar_receb_p) THEN
      query_w := query_w || ' and nm_usuario <> nm_usuario_cor_p';
    END IF;
  END IF;

  IF (nr_lista_sequencia_p IS NOT NULL AND nr_lista_sequencia_p::text <> '') THEN
		seq_w := obter_lista_string2(nr_lista_sequencia_p, ',');
		query_w := query_w || ' and nr_sequencia in ( -1 ';
		FOR	i IN seq_w.first..seq_w.last LOOP
			BEGIN
				query_w := query_w || ', ' || seq_w(i);
			EXCEPTION
			WHEN OTHERS THEN
				query_w := query_w;
			END;
		END LOOP;
		query_w := query_w + ')';
  END IF;

  IF (ds_titulo_p IS NOT NULL AND ds_titulo_p::text <> '') THEN
    query_w       := query_w || ' and lower(ds_titulo) like %' ||ds_titulo_p ||'%';
  END IF;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE comunic_marcar_todas_lidas ( nm_usuario_cor_p text, ie_restringir_p text, ie_gerencial_p text, apenas_enviada_meu_usuario_p text, ie_somente_meu_usuario_p text, param49_p text, nr_seq_classif_p bigint, cd_setor_usuario_p bigint, cd_usuario_destino_p bigint, nr_seq_p bigint, apenas_enviada_meu_setor_cb_p text, ie_enviar_receb_p text, nr_lista_sequencia_p text, ie_remetente_p text, possui_registros_p text, possui_virgulas_p text, nm_usuario_p text, ie_so_liberadas_p text, ie_restringir_periodo_p text, ie_usuario_destinatario_p text, nm_usuario_destino_p text, nr_dias_anterior_p bigint, ds_titulo_p text, ie_visualiza_estab_dest_adic_p text, dt_inicial_p timestamp, dt_final_p timestamp) FROM PUBLIC;

