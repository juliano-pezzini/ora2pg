-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_solic_perda ( nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_ordem_w		bigint;
nr_sequencia_w		bigint;
nr_seq_item_prescr_w	bigint;
qt_desfazer_w		bigint;

c01 CURSOR FOR
	SELECT 	a.nr_sequencia,
		c.nr_sequencia,
		c.nr_seq_item_prescr
	from   	can_ordem_prod_mat c,
		can_ordem_item_prescr b,
		can_ordem_prod a
	where  	c.nr_seq_item_prescr 	= b.nr_sequencia
	and	b.nr_seq_ordem 		= c.nr_seq_ordem
	and   	a.nr_sequencia 		= b.nr_seq_ordem
	and	a.nr_prescricao	   	= nr_prescricao_p
	and    	(a.dt_solic_perda IS NOT NULL AND a.dt_solic_perda::text <> '');

BEGIN

select 	count(*)
into STRICT	qt_desfazer_w
from   	can_ordem_prod_mat c,
	can_ordem_item_prescr b,
	can_ordem_prod a
where  	c.nr_seq_item_prescr 	= b.nr_sequencia
and	b.nr_seq_ordem 		= c.nr_seq_ordem
and   	a.nr_sequencia 		= b.nr_seq_ordem
and	a.nr_prescricao	   	= nr_prescricao_p
and    	(a.dt_solic_perda IS NOT NULL AND a.dt_solic_perda::text <> '');

if (coalesce(qt_desfazer_w,0) = 0) then
	CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(207930);
end if;

open c01;
loop
fetch c01 into
	nr_seq_ordem_w,
	nr_sequencia_w,
	nr_seq_item_prescr_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	update 	can_ordem_prod
	set 	dt_solic_perda  = NULL
	where 	nr_sequencia = nr_seq_ordem_w
	and 	(dt_solic_perda IS NOT NULL AND dt_solic_perda::text <> '');

	update 	can_ordem_item_prescr
	set 	dt_solic_perda  = NULL
	where	nr_seq_ordem = nr_seq_ordem_w
	and	nr_sequencia = nr_seq_item_prescr_w;

	update 	can_ordem_prod_mat
	set 	dt_solic_perda = clock_timestamp()
	where 	nr_seq_ordem =  nr_seq_ordem_w
	and 	nr_sequencia = nr_sequencia_w;

	end;
end loop;
close c01;



commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_solic_perda ( nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

