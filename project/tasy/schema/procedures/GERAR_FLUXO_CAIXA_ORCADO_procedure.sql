-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_fluxo_caixa_orcado ( cd_estabelecimento_p bigint, vl_saldo_anterior_p bigint, dt_inicio_p timestamp, dt_final_p timestamp, ie_periodo_p text, ie_classif_p text, nm_usuario_p text, cd_empresa_p bigint, ie_restringe_estab_p text, ie_passado_real_p text, ie_todas_contas_p text, ie_somente_ativa_p text) AS $body$
DECLARE


/*--------------------------------------------------------------- ATENÇÃO ----------------------------------------------------------------*/


/* Cuidado ao realizar alterações no fluxo de caixa. Toda e qualquer alteração realizada em qualquer uma das       */


/* procedures do fluxo de caixa deve ser cuidadosamente verificada e realizada no fluxo de caixa em lote.           */


/* Devemos garantir que os dois fluxos de caixa tragam os mesmos valores no resultado, evitando assim que           */


/* existam diferenças entre os fluxos de caixa.                                                                                                                */


/*--------------- AO ALTERAR O FLUXO DE CAIXA ALTERAR TAMBÉM O FLUXO DE CAIXA EM LOTE ---------------*/

cd_conta_financ_w	bigint;
nr_seq_regra_comp_w	parametro_fluxo_caixa.nr_seq_regra_comp%type;
cd_moeda_empresa_w	integer;
qt_loop_w				bigint;
ds_log_w				varchar(4000);	

C020 CURSOR FOR
SELECT	cd_conta_financ
from	conta_financeira
where	CASE WHEN ie_somente_ativa_p='S' THEN ie_situacao  ELSE 'A' END  = 'A'
and (cd_empresa		= cd_empresa_p or cd_estabelecimento = cd_estabelecimento_p)
and (OBTER_SE_CONTA_FINANC_ESTAB(cd_conta_financ, cd_estabelecimento_p,ie_restringe_estab_p) = 'S' or ie_restringe_estab_p = 'N')
and	coalesce(ie_todas_contas_p,'N') = 'S';


BEGIN

select	max(nr_seq_regra_comp)
into STRICT	nr_seq_regra_comp_w
from	parametro_fluxo_caixa
where	cd_estabelecimento = cd_estabelecimento_p;

/* Projeto Multimoeda - Busca a moeda padrão da empresa para gravar no fluxo. */

select	obter_moeda_padrao_empresa(cd_estabelecimento_p,'E')
into STRICT	cd_moeda_empresa_w
;

/*aamfirmo OS 951267*/

delete	
from 	fluxo_Caixa
where 	dt_referencia		>= dt_inicio_p
and 	ie_classif_fluxo 	= 'O'
and 	ie_origem 			<> 'D'
and (cd_empresa		= cd_empresa_p or cd_estabelecimento = cd_estabelecimento_p);


/*Inicio 1895850*/

ds_log_w := substr('Parâmetros Fluxo Caixa Orçado(gerar_fluxo_caixa_orcado):'|| chr(13) ||
				   'nr_seq_regra_comp_w: '|| nr_seq_regra_comp_w ||chr(13)||
				   'cd_moeda_empresa_w: '||cd_moeda_empresa_w||chr(13)||
				   'cd_estabelecimento_p: '||cd_estabelecimento_p||chr(13)||
				   'vl_saldo_anterior_p: '||vl_saldo_anterior_p||chr(13)||
				   'dt_inicio_p: '||dt_inicio_p||chr(13)||
				   'dt_final_p: '||dt_final_p||chr(13)||
				   'ie_periodo_p: '||ie_periodo_p||chr(13)||
				   'ie_classif_p: '||ie_classif_p||chr(13)||
				   'nm_usuario_p: '||nm_usuario_p||chr(13)||
				   'cd_empresa_p: '||cd_empresa_p||chr(13)||
				   'ie_restringe_estab_p: '||ie_restringe_estab_p||chr(13)||
				   'ie_passado_real_p: '||ie_passado_real_p||chr(13)||
				   'ie_todas_contas_p: '||ie_todas_contas_p||chr(13)||
				   'ie_somente_ativa_p: '||ie_somente_ativa_p,1,4000);
				
/*forçar sair do loop em casa de algum problema*/
			
qt_loop_w := 1;	
while((ds_log_w IS NOT NULL AND ds_log_w::text <> '') and qt_loop_w < 3) loop
	insert into log_tasy( cd_log,
						   ds_log,
						   nm_usuario,
						   dt_atualizacao)
				values ( 96587,
						   substr(ds_log_w,1,2000),
						   nm_usuario_p,
						   clock_timestamp());

	ds_log_w := substr(ds_log_w,2001,length(ds_log_w));
	qt_loop_w := qt_loop_w + 1;						
end loop;			
/*Fim 1895850*/

commit;

open C020;
loop
fetch C020 into
	cd_conta_financ_w;
EXIT WHEN NOT FOUND; /* apply on C020 */
	insert into fluxo_caixa(cd_estabelecimento,
		dt_referencia,
		cd_conta_financ, 
		ie_classif_fluxo,
		dt_atualizacao, 
		nm_usuario, 
		vl_fluxo, 
		ie_origem, 
		ie_periodo, 
		ie_integracao,
		cd_empresa,
		cd_moeda)
	values (cd_estabelecimento_p, 
		dt_inicio_p, 
		cd_conta_financ_w, 
		'O',
		clock_timestamp(), 
		nm_usuario_p, 
		0, 
		'I', 
		ie_periodo_p,
		'X',
		cd_empresa_p,
		cd_moeda_empresa_w);
end loop;
close C020;
CALL GERAR_FLUXO_CAIXA_ESP(cd_estabelecimento_p,dt_inicio_p,dt_final_p,nm_usuario_p,cd_empresa_p,ie_restringe_estab_p,'A',ie_somente_ativa_p,'O');
commit;


CALL CALCULAR_FLUXO_CAIXA(	cd_estabelecimento_p,
			vl_saldo_anterior_p,
			dt_inicio_p,
        		dt_final_p,
			ie_periodo_p,
			ie_classif_p,
			nm_usuario_p,
			cd_empresa_p,
			ie_restringe_estab_p,
			ie_passado_real_p,
			ie_somente_ativa_p,
			nr_seq_regra_comp_w);

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_fluxo_caixa_orcado ( cd_estabelecimento_p bigint, vl_saldo_anterior_p bigint, dt_inicio_p timestamp, dt_final_p timestamp, ie_periodo_p text, ie_classif_p text, nm_usuario_p text, cd_empresa_p bigint, ie_restringe_estab_p text, ie_passado_real_p text, ie_todas_contas_p text, ie_somente_ativa_p text) FROM PUBLIC;

