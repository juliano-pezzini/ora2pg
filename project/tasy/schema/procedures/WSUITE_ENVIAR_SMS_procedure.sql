-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE wsuite_enviar_sms (ds_destinatario_p text, ds_mensagem_p text, ie_aplicacao_p bigint, cd_estab_portal_p bigint, ds_user_portal_p text, ie_origem_envio_p text) AS $body$
DECLARE


ds_remetente_w	varchar(60);
nm_usuario_w	wsuite_regra_login.nm_usuario_sms%type;
cd_perfil_w		wsuite_regra_login.cd_perfil%type;
id_sms_w		bigint;

/* ie_origem_envio_p - Origens de envio:
1 - Cadastro de novo usuario Portal;
2 - Cadastro de novo usuario Cadastro Completo;
3 - Cadastro de novo usuario Cadastro Simplificado;
4 - Redefinicao de senha Portal;
*/
procedure gravar_log_sms(ie_status_envio_p in text, ds_erro_p in text) is
;
BEGIN
	insert into wsuite_log_sms(
				nr_sequencia,
				ie_origem_envio,
				ds_mensagem,
				ie_status_envio,
				ds_log_erro_envio,
				ie_aplicacao,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				dt_atualizacao,
				nm_usuario,
				nr_telefone
				) values (
				nextval('wsuite_log_sms_seq'),
				ie_origem_envio_p,
				ds_mensagem_p,
				ie_status_envio_p,
				ds_erro_p,
				ie_aplicacao_p,
				clock_timestamp(),
				ds_user_portal_p,
				clock_timestamp(),
				ds_user_portal_p,
				substr(ds_destinatario_p,1,30)
				);
				
	commit;
end;
							
begin

	select 	max(CD_PERFIL),
			max(NM_USUARIO_SMS)
	into STRICT	cd_perfil_w,
			nm_usuario_w
	from	WSUITE_REGRA_LOGIN
	where	IE_APLICACAO = IE_APLICACAO_P
	and		IE_SITUACAO = 'A';	

	CALL wheb_usuario_pck.set_nm_usuario(nm_usuario_w);
	CALL wheb_usuario_pck.set_cd_perfil(cd_perfil_w);
	CALL wheb_usuario_pck.set_cd_estabelecimento(cd_estab_portal_p);

	ds_remetente_w := obter_valor_param_usuario(0,63,coalesce(cd_perfil_w,0),nm_usuario_w, coalesce(cd_estab_portal_p,1));

	begin
		id_sms_w := wheb_sms.enviar_sms(ds_remetente_w, ds_destinatario_p, ds_mensagem_p, nm_usuario_w, id_sms_w);
		gravar_log_sms('S','');
	exception
	when others then
		gravar_log_sms('E',SUBSTR(SQLERRM, 1, 2000));
	end;

	commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE wsuite_enviar_sms (ds_destinatario_p text, ds_mensagem_p text, ie_aplicacao_p bigint, cd_estab_portal_p bigint, ds_user_portal_p text, ie_origem_envio_p text) FROM PUBLIC;

