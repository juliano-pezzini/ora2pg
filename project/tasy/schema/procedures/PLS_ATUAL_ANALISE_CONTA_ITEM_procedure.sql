-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atual_analise_conta_item ( nr_seq_item_analise_p bigint, nr_seq_conta_p bigint, nr_seq_conta_proc_p bigint, nr_seq_conta_mat_p bigint, nr_seq_partic_proc_p bigint, nr_seq_conta_glosa_p bigint, nr_seq_ocorrencia_benef_p bigint, qt_glosada_p bigint, vl_glosado_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_analise_p bigint, nr_seq_glosa_oc_gerada_p INOUT bigint ) AS $body$
DECLARE

				
/*Diego OS 329472 - 22/06/20111 - Esta rotina possui a funcao de copiar uma glosa ou ocorrencia da conta para a analise.*/

cd_codigo_w		varchar(15);
ds_observacao_w		varchar(4000);
ie_tipo_w		varchar(1);	
nr_seq_conta_w		bigint;
nr_seq_conta_mat_w	bigint;
nr_seq_conta_proc_w	bigint;
nr_seq_glosa_oc_w	bigint;
ie_status_w		varchar(1);
nr_seq_motivo_padrao_w	bigint;
ie_tipo_motivo_w	varchar(1) := 'P';
nr_seq_item_w		bigint;
ie_existe_grupo_glosa_w varchar(1);
nr_seq_conta_item_w	bigint;
nr_seq_glosa_ref_w	bigint;
qt_glosa_w		bigint;
vl_glosa_w		double precision;
ie_auditoria_w		varchar(1);
nr_seq_ocorrencia_w	bigint;
nr_seq_glosa_w		bigint;
ie_finalizar_analise_w	varchar(1);
ie_tipo_glosa_w		varchar(1);
nr_seq_analise_item_w	bigint;
ds_obs_glosa_oc_w	varchar(255);
ie_glosar_pagamento_w	varchar(1);
ie_glosar_faturamento_w varchar(1);
ie_origem_conta_w	varchar(1);
nr_seq_grupo_w		bigint;
ie_tipo_despesa_proc_w	varchar(1);
ie_tipo_despesa_mat_w	varchar(1);
nr_seq_grupo_oc_w	bigint;
qt_despesa_w		bigint;
ie_gera_grupo_w		varchar(1) := 'S';
ie_origem_analise_w	pls_analise_conta.ie_origem_analise%type;
C01 CURSOR FOR
	SELECT	a.nr_seq_grupo,
		a.nr_sequencia
	from	pls_ocorrencia_grupo a,
		pls_ocorrencia_benef b,
		pls_ocorrencia c
	where	a.nr_seq_ocorrencia = c.nr_sequencia
	and	b.nr_seq_ocorrencia = c.nr_sequencia
	and	coalesce(a.ie_origem_conta,ie_origem_conta_w) = ie_origem_conta_w
	and	coalesce(a.ie_conta_medica,'S') = 'S'
	and	a.ie_situacao		= 'A'
	and	((coalesce(a.ie_tipo_analise::text, '') = '') or (a.ie_tipo_analise = 'A') or (a.ie_tipo_analise = 'C' and ie_origem_analise_w in ('1','3','4','5','6')) or (a.ie_tipo_analise	= 'P' and ie_origem_analise_w in ('2','7')))
	and	b.nr_sequencia = nr_seq_ocorrencia_w
	and	not exists (SELECT	x.nr_sequencia
				 from	pls_analise_grupo_item x
				 where	x.nr_seq_item_analise	= nr_seq_item_w
				 and	x.nr_seq_grupo		= a.nr_seq_grupo);


BEGIN

select	substr(tiss_obter_motivo_glosa(nr_seq_motivo_glosa,'C'),1,10) cd_codigo,								
	substr(ds_observacao,1,255) ds_observacao,
	'G' ie_tipo,
	a.nr_seq_conta 		nr_seq_conta,
	a.nr_seq_conta_mat	nr_seq_mat,
	a.nr_seq_conta_proc	nr_seq_proc,
	a.nr_sequencia,
	null,
	a.qt_glosa,
	a.vl_glosa,
	null,
	null,
	a.nr_sequencia,
	null,
	'S',
	null
into STRICT	cd_codigo_w,
	ds_observacao_w,
	ie_tipo_w,
	nr_seq_conta_w,
	nr_seq_conta_mat_w,
	nr_seq_conta_proc_w,
	nr_seq_glosa_oc_w,
	nr_seq_glosa_ref_w,
	qt_glosa_w,
	vl_glosa_w,
	ie_auditoria_w,
	nr_seq_ocorrencia_w,
	nr_seq_glosa_w,
	ie_finalizar_analise_w,
	ie_glosar_pagamento_w,
	ie_glosar_faturamento_w
from	pls_conta_glosa	a		
where	a.nr_sequencia 			= nr_seq_conta_glosa_p	

union

SELECT	b.cd_ocorrencia cd_codigo,
	substr(b.ds_documentacao,1,4000) ds_observacao,
	'O' ie_tipo,
	a.nr_seq_conta	nr_seq_conta,
	a.nr_seq_mat	nr_seq_mat,
	a.nr_seq_proc	nr_seq_proc,										
	a.nr_sequencia,
	coalesce(a.nr_seq_glosa, (	SELECT	max(x.nr_sequencia)
				from	pls_conta_glosa x
				where	x.nr_seq_ocorrencia_benef = a.nr_sequencia ) ), -- Diego 28/04/2011 - Cria o vinculo com a glosa sera aquela gerada pela ocorrencia ou que gerou a ocorrencia
	a.qt_glosa,
	a.vl_glosa,
	coalesce(b.ie_auditoria_conta,'N'),	
	a.nr_sequencia,
	null,
	a.ie_finalizar_analise,
	b.ie_glosar_pagamento,
	b.ie_glosar_faturamento
from	pls_ocorrencia_benef	a,
	pls_ocorrencia		b
where	a.nr_seq_ocorrencia = b.nr_sequencia
and	coalesce(nr_seq_guia_plano::text, '') = ''
and	coalesce(nr_seq_requisicao::text, '') = ''
and	(nr_seq_conta IS NOT NULL AND nr_seq_conta::text <> '')
and 	a.nr_sequencia = nr_seq_ocorrencia_benef_p;

if (ie_auditoria_w = 'N') and (ie_tipo_w = 'O') then
	/*Diego Os 342553 - Caso a ocorrencia nao seja de auditoria sera meramente informativa.*/

	ie_tipo_motivo_w := 'I';	
else
	if (coalesce(ie_finalizar_analise_w,'S') = 'S') then
		ie_tipo_motivo_w := 'P';
	else
		ie_tipo_motivo_w := 'E';
	end if;
end if;

if (ie_tipo_w = 'O') 	 and (nr_seq_glosa_ref_w > 0) then
	
	select	max(nr_sequencia)
	into STRICT	nr_seq_analise_item_w
	from	pls_analise_conta_item
	where	ie_tipo		= 'G'
	and	nr_seq_glosa	= nr_seq_glosa_ref_w
	and	nr_seq_analise	= nr_seq_analise_p;
	
end if;	

if (ie_glosar_pagamento_w	 = 'S') and (ie_glosar_faturamento_w = 'S') then
	ie_tipo_glosa_w := 'A';
elsif (ie_glosar_pagamento_w = 'S') then
	ie_tipo_glosa_w := 'P';
elsif (ie_glosar_faturamento_w = 'S') then
	ie_tipo_glosa_w := 'F';
else
	ie_tipo_glosa_w := null;
end if;

select	max(ie_origem_analise)
into STRICT	ie_origem_analise_w
from	pls_analise_conta
where	nr_sequencia = nr_seq_analise_p;


select	max(ie_origem_conta)
into STRICT	ie_origem_conta_w
from	pls_conta
where	nr_sequencia = nr_seq_conta_p;
if (coalesce(nr_seq_analise_item_w,0) > 0) then
	/*No caso de a glosa ter virado uma ocorrencia.*/

	update	pls_analise_conta_item
	set	ie_tipo 	  = 'O',
		nr_seq_glosa_oc   = nr_seq_glosa_oc_w,
		cd_codigo	  = cd_codigo_w,
		ds_obs_glosa_oc   = ds_observacao_w,
		nr_seq_glosa 	   = NULL,
		nr_seq_ocorrencia = nr_seq_ocorrencia_w,
		nr_seq_glosa_ref  = nr_seq_glosa_ref_w
	where	nr_sequencia	  = nr_seq_analise_item_w;
	
	nr_seq_item_w := nr_seq_analise_item_w;
else	
	select  nextval('pls_analise_conta_item_seq')
	into STRICT	nr_seq_item_w
	;
	
	insert into pls_analise_conta_item(cd_codigo, ds_obs_glosa_oc, dt_atualizacao,
		 dt_atualizacao_nrec, ie_situacao, ie_status,
		 ie_tipo, nm_usuario, nm_usuario_nrec,
		 nr_seq_analise, nr_seq_conta, nr_seq_conta_mat,
		 nr_seq_conta_proc, nr_seq_glosa_oc, nr_sequencia,
		 qt_glosa, vl_glosa, nr_seq_glosa_ref,
		 nr_seq_ocorrencia, nr_seq_glosa, ie_finalizar_analise,
		 nr_seq_proc_partic, ie_principal, ie_tipo_glosa,
		 nr_seq_w_resumo_conta	)	
	values (cd_codigo_w, ds_observacao_w, clock_timestamp(),
		 clock_timestamp(), 'A', ie_tipo_motivo_w,
		 ie_tipo_w, nm_usuario_p, nm_usuario_p,
		 nr_seq_analise_p, nr_seq_conta_p, nr_seq_conta_mat_w,
		 nr_seq_conta_proc_w, nr_seq_glosa_oc_w, nr_seq_item_w,
		 coalesce(qt_glosada_p,0), coalesce(vl_glosado_p,0), nr_seq_glosa_ref_w,
		 nr_seq_ocorrencia_w, nr_seq_glosa_w, ie_finalizar_analise_w,
		 nr_seq_partic_proc_p, 'S', ie_tipo_glosa_w,
		 nr_seq_item_analise_p	);
end if;

if (coalesce(nr_seq_ocorrencia_benef_p,0) > 0) then	
	open C01;
	loop
	fetch C01 into	
		nr_seq_grupo_w,
		nr_seq_grupo_oc_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ie_gera_grupo_w := 'S';
		
		ie_tipo_despesa_proc_w:= null;
		ie_tipo_despesa_mat_w:= null;
		
		select	count(1)
		into STRICT 	qt_despesa_w
		from	pls_oc_grupo_tipo_desp
		where	nr_seq_ocorrencia_grupo = nr_seq_grupo_oc_w;
		
		if (qt_despesa_w > 0) then
			if (nr_seq_conta_proc_p > 0) then
				select	max(ie_tipo_despesa)
				into STRICT	ie_tipo_despesa_proc_w
				from	pls_conta_proc
				where	nr_sequencia = nr_seq_conta_proc_p;
				
				if (ie_tipo_despesa_proc_w IS NOT NULL AND ie_tipo_despesa_proc_w::text <> '') then
					select	count(1)
					into STRICT 	qt_despesa_w
					from	pls_oc_grupo_tipo_desp
					where	nr_seq_ocorrencia_grupo = nr_seq_grupo_oc_w
					and	ie_tipo_despesa_proc = ie_tipo_despesa_proc_w;
					
					if (coalesce(qt_despesa_w,0) = 0) then
						ie_gera_grupo_w := 'N';
					end if;
				end if;
			elsif (nr_seq_conta_mat_p > 0) then
				select	max(ie_tipo_despesa)
				into STRICT	ie_tipo_despesa_mat_w
				from	pls_conta_mat
				where	nr_sequencia = nr_seq_conta_mat_p;
				
				if (ie_tipo_despesa_mat_w IS NOT NULL AND ie_tipo_despesa_mat_w::text <> '') then
					select	count(1)
					into STRICT 	qt_despesa_w
					from	pls_oc_grupo_tipo_desp
					where	nr_seq_ocorrencia_grupo = nr_seq_grupo_oc_w
					and	ie_tipo_despesa_mat = ie_tipo_despesa_mat_w;
					
					if (coalesce(qt_despesa_w,0) = 0) then
						ie_gera_grupo_w := 'N';
					end if;
				end if;
			end if;
		end if;
		
		if (ie_gera_grupo_w = 'S') then
			insert into pls_analise_grupo_item(nr_sequencia, cd_estabelecimento, dt_atualizacao,
				 nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
				 nr_seq_grupo, nr_seq_item_analise)
			values (nextval('pls_analise_grupo_item_seq'), cd_estabelecimento_p, clock_timestamp(),
				nm_usuario_p, clock_timestamp(), nm_usuario_p,
				nr_seq_grupo_w, nr_seq_item_w);
		end if;
		
		end;
	end loop;
	close C01;
end if;
	
nr_seq_glosa_oc_gerada_p := nr_seq_item_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atual_analise_conta_item ( nr_seq_item_analise_p bigint, nr_seq_conta_p bigint, nr_seq_conta_proc_p bigint, nr_seq_conta_mat_p bigint, nr_seq_partic_proc_p bigint, nr_seq_conta_glosa_p bigint, nr_seq_ocorrencia_benef_p bigint, qt_glosada_p bigint, vl_glosado_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_analise_p bigint, nr_seq_glosa_oc_gerada_p INOUT bigint ) FROM PUBLIC;

