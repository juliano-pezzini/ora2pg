-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_interv_horarios_esp (nr_prescricao_p bigint, nr_seq_item_p bigint, ie_tipo_item_p text, ie_adm_p INOUT text, ds_adm_p INOUT text) AS $body$
DECLARE


nr_seq_horario_w		bigint;
dt_horario_w		timestamp;
cd_intervalo_w		varchar(7);
ds_intervalo_w		varchar(40);
ds_item_w		varchar(255);
ie_operacao_w		varchar(1);
qt_operacao_w		intervalo_prescricao.qt_operacao%type;
qt_adm_w		bigint;
dt_prox_adm_w		timestamp;
ie_adm_w		varchar(1);
ds_adm_w		varchar(240);


BEGIN
ie_adm_w := 'S';
ds_adm_w := '';
if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_item_p IS NOT NULL AND nr_seq_item_p::text <> '') and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') then
	if (ie_tipo_item_p in ('M','S')) then
		/* obter sequencia horario */

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_horario_w
		from	prescr_mat_hor
		where	nr_prescricao = nr_prescricao_p
		and	nr_seq_material = nr_seq_item_p
		and	(dt_fim_horario IS NOT NULL AND dt_fim_horario::text <> '')
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

		/* obter data adm */

		if (coalesce(nr_seq_horario_w,0) > 0) then
			select	dt_horario
			into STRICT	dt_horario_w
			from	prescr_mat_hor
			where	nr_sequencia = nr_seq_horario_w
			and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

			/* verificar intervalo item */

			if (dt_horario_w IS NOT NULL AND dt_horario_w::text <> '') then
				select	coalesce(max(cd_intervalo),'0')
				into STRICT	cd_intervalo_w
				from	prescr_material
				where	nr_prescricao = nr_prescricao_p
				and	nr_sequencia = nr_seq_item_p;

				/* obter dados intervalo */

				if (coalesce(cd_intervalo_w,'0') <> '0') then
					select	ds_intervalo,
						ie_operacao,
						qt_operacao
					into STRICT	ds_intervalo_w,
						ie_operacao_w,
						qt_operacao_w
					from	intervalo_prescricao
					where	cd_intervalo = cd_intervalo_w;

					/* obter dados item */

					select	b.ds_material
					into STRICT	ds_item_w
					from	material b,
						prescr_material a
					where	b.cd_material = a.cd_material
					and	a.nr_prescricao = nr_prescricao_p
					and	a.nr_sequencia = nr_seq_item_p;

					/* realizar consistencias */

					if (ie_operacao_w <> 'H') and (qt_operacao_w > 0) then
						select	coalesce(count(*),0)
						into STRICT	qt_adm_w
						from	prescr_mat_hor
						where	nr_prescricao = nr_prescricao_p
						and	nr_seq_material = nr_seq_item_p
						and	trunc(dt_horario,'dd') = trunc(clock_timestamp())
						and	(dt_fim_horario IS NOT NULL AND dt_fim_horario::text <> '')
						and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

						if (qt_adm_w >= qt_operacao_w) then
							ie_adm_w := 'N';
							/*ds_adm_w := 'Atencao: O item ' || ds_item_w || ' foi prescrito com o seguinte intervalo: ' || ds_intervalo_w || '.' || chr(10) ||
								    'Na presente data estas administracoes ja foram realizadas!';
								    */
							ds_adm_w := wheb_mensagem_pck.get_texto(300540, 'DS_ITEM='||ds_item_w||';DS_INTERVALO='||ds_intervalo_w);
						end if;
					elsif (ie_operacao_w = 'H') and (qt_operacao_w > 0) then
						select	dt_horario_w + (qt_operacao_w/24)
						into STRICT	dt_prox_adm_w
						;
					
						if (dt_prox_adm_w > clock_timestamp()) then
							ie_adm_w := 'N';
							/*
							ds_adm_w := 'Atencao: O item ' || ds_item_w || ' foi prescrito com o seguinte intervalo: ' || ds_intervalo_w || '.' || chr(10) ||
								    'A proxima administracao somente deveria ser realizada em: ' || to_char(dt_prox_adm_w,'dd/mm/yyyy hh24:mi'); */
							ds_adm_w := wheb_mensagem_pck.get_texto(300547, 'DS_ITEM='||ds_item_w||';DS_INTERVALO='||ds_intervalo_w||';DT='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_prox_adm_w, 'short', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone));
						end if;
					end if;
				end if;
			end if;
		end if;
	elsif (ie_tipo_item_p = 'P') then
		/* obter sequencia horario */

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_horario_w
		from	prescr_proc_hor
		where	nr_prescricao = nr_prescricao_p
		and	nr_seq_procedimento = nr_seq_item_p
		and	(dt_fim_horario IS NOT NULL AND dt_fim_horario::text <> '')
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

		/* obter data adm */

		if (coalesce(nr_seq_horario_w,0) > 0) then
			select	dt_horario
			into STRICT	dt_horario_w
			from	prescr_proc_hor
			where	nr_sequencia = nr_seq_horario_w
			and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

			/* verificar intervalo item */

			if (dt_horario_w IS NOT NULL AND dt_horario_w::text <> '') then
				select	coalesce(max(cd_intervalo),'0')
				into STRICT	cd_intervalo_w
				from	prescr_procedimento
				where	nr_prescricao = nr_prescricao_p
				and	nr_sequencia = nr_seq_item_p;

				/* obter dados intervalo */

				if (coalesce(cd_intervalo_w,'0') <> '0') then
					select	ds_intervalo,
						ie_operacao,
						qt_operacao
					into STRICT	ds_intervalo_w,
						ie_operacao_w,
						qt_operacao_w
					from	intervalo_prescricao
					where	cd_intervalo = cd_intervalo_w;

					/* obter dados item */

					select	substr(obter_desc_prescr_proc(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno),1,240)
					into STRICT	ds_item_w
					from	prescr_procedimento a
					where	a.nr_prescricao = nr_prescricao_p
					and	a.nr_sequencia = nr_seq_item_p;

					/* realizar consistencias */

					if (ie_operacao_w <> 'H') and (qt_operacao_w > 0) then
						select	coalesce(count(*),0)
						into STRICT	qt_adm_w
						from	prescr_proc_hor
						where	nr_prescricao = nr_prescricao_p
						and	nr_seq_procedimento = nr_seq_item_p
						and	trunc(dt_horario,'dd') = trunc(clock_timestamp())
						and	(dt_fim_horario IS NOT NULL AND dt_fim_horario::text <> '')
						and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

						if (qt_adm_w >= qt_operacao_w) then
							ie_adm_w := 'N';
							/*ds_adm_w := 'Atencao: O item ' || ds_item_w || ' foi prescrito com o seguinte intervalo: ' || ds_intervalo_w || '.' || chr(10) ||
								    'Na presente data estas administracoes ja foram realizadas!';
							*/
							ds_adm_w := wheb_mensagem_pck.get_texto(300540, 'DS_ITEM='||ds_item_w||';DS_INTERVALO='||ds_intervalo_w);
						end if;
					elsif (ie_operacao_w = 'H') and (qt_operacao_w > 0) then
						select	dt_horario_w + (qt_operacao_w/24)
						into STRICT	dt_prox_adm_w
						;
					
						if (dt_prox_adm_w > clock_timestamp()) then
							ie_adm_w := 'N';
							/*ds_adm_w := 'Atencao: O item ' || ds_item_w || ' foi prescrito com o seguinte intervalo: ' || ds_intervalo_w || '.' || chr(10) ||
								    'A proxima administracao somente deveria ser realizada em ' || to_char(dt_prox_adm_w,'dd/mm/yyyy hh24:mi');*/
							ds_adm_w := wheb_mensagem_pck.get_texto(300547, 'DS_ITEM='||ds_item_w||';DS_INTERVALO='||ds_intervalo_w||';DT='||PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_prox_adm_w, 'short', ESTABLISHMENT_TIMEZONE_UTILS.getTimeZone));
						end if;
					end if;
				end if;
			end if;
		end if;
	end if;
end if;

ie_adm_p := ie_adm_w;
ds_adm_p := ds_adm_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_interv_horarios_esp (nr_prescricao_p bigint, nr_seq_item_p bigint, ie_tipo_item_p text, ie_adm_p INOUT text, ds_adm_p INOUT text) FROM PUBLIC;

