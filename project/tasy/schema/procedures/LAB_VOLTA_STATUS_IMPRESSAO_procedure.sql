-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_volta_status_impressao ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, ie_status_atend_p bigint, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE


status_base_w		smallint;
nr_seq_imp_mapa_w	bigint;
cd_mapa_w		bigint;
ie_status_imp_w		smallint;
ds_exame_w		varchar(255);


BEGIN

ds_erro_p := '';

status_base_w := Obter_Param_Usuario(10209, 3, OBTER_PERFIL_ATIVO, nm_usuario_p, OBTER_ESTABELECIMENTO_ATIVO, status_base_w);

if (ie_status_atend_p <= status_base_w) then

	select	coalesce(max(a.nr_sequencia),0),
		max(a.cd_mapa),
		max(a.ie_status),
		max(Obter_Desc_Exame(b.nr_seq_exame))
	into STRICT	nr_seq_imp_mapa_w,
		cd_mapa_w,
		ie_status_imp_w,
		ds_exame_w
	from	lab_impressao_mapa a,
		prescr_procedimento b
	where	b.nr_prescricao = a.nr_prescricao
	and	b.nr_sequencia = a.nr_seq_prescr
	and	a.nr_prescricao = nr_prescricao_p
	and	a.nr_seq_prescr = nr_seq_prescr_p;

	if (nr_seq_imp_mapa_w > 0) then

		if (ie_status_imp_w = 20) then
			-- 300855 = O exame #@DS_EXAME#@ da prescrição #@DS_PRESCRICAO#@ está sendo impresso neste momento. Somente após a impressão do mapa de trabalho é que o status do exame pode ser alterado para pendente.
			ds_erro_p := obter_texto_dic_objeto(300855, wheb_usuario_pck.get_nr_seq_idioma, 'DS_EXAME='||ds_exame_w||';DS_PRESCRICAO='||nr_prescricao_p);
		else
			CALL lab_insere_impressao_mapa_log(nr_prescricao_p, nr_seq_prescr_p, 60, cd_mapa_w, nm_usuario_p);

			update	prescr_procedimento
			set	nr_seq_imp_mapa  = NULL
			where	nr_prescricao = nr_prescricao_p
			and	nr_sequencia = nr_seq_prescr_p;

			delete	FROM lab_impressao_mapa
			where	nr_sequencia = nr_seq_imp_mapa_w;

			commit;
		end if;

	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_volta_status_impressao ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, ie_status_atend_p bigint, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

