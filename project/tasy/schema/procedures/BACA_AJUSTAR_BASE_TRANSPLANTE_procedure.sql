-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_ajustar_base_transplante () AS $body$
DECLARE


qt_registro_w		bigint;
dt_versao_atual_cliente_w 	timestamp;


BEGIN

CALL abortar_se_base_wheb();

/*FAVOR COLOCAR OS NOVOS AJUSTES SEMPRE NO FINAL DA PROCEDURE.*/

dt_versao_atual_cliente_w  := coalesce(TO_DATE(TO_CHAR(obter_data_geracao_versao-1,'dd/mm/yyyy') ||' 23:59:59','dd/mm/yyyy hh24:mi:ss'),clock_timestamp() - interval '90 days');

/* Ivan em 24/03/2008 OS86372 */

if (dt_versao_atual_cliente_w < to_date('23/04/2008','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registro_w
	from	user_tab_columns
	where	table_name 	= 'TX_DOADOR'
	and	column_name	= 'NR_SEQ_ORGAO';
	if (qt_registro_w > 0) then
		begin
		CALL Exec_Sql_Dinamico('Ivan','alter table TX_DOADOR drop constraint TXDOAD_TXORGA_FK');
		CALL Exec_Sql_Dinamico('Ivan','drop index TXDOAD_TXORGA_FK_I');
		CALL Exec_Sql_Dinamico('Ivan','alter table TX_DOADOR drop column NR_SEQ_ORGAO');
		end;
	end if;
	select	count(*)
	into STRICT	qt_registro_w
	from	user_tab_columns
	where	table_name 	= 'TX_DOADOR'
	and	column_name	= 'DT_RETIRADA';
	if (qt_registro_w > 0) then
		begin
		CALL Exec_Sql_Dinamico('Ivan','alter table TX_DOADOR drop column DT_RETIRADA');
		end;
	end if;
	select	count(*)
	into STRICT	qt_registro_w
	from	user_tab_columns
	where	table_name 	= 'TX_DOADOR_POTENCIAL'
	and	column_name	= 'NR_SEQ_ORGAO';
	if (qt_registro_w > 0) then
		begin
		CALL Exec_Sql_Dinamico('Ivan','drop index TXDOPO_UK');
		CALL Exec_Sql_Dinamico('Ivan','alter table TX_DOADOR_POTENCIAL drop constraint TXDOPO_TXDOAD_FK');
		CALL Exec_Sql_Dinamico('Ivan','drop index TXDOPO_TXDOAD_FK_I');
		CALL Exec_Sql_Dinamico('Ivan','alter table TX_DOADOR_POTENCIAL drop column NR_SEQ_ORGAO');
		end;
	end if;
	CALL Exec_Sql_Dinamico('Ivan','drop trigger tx_doador_befinsupd');
	CALL Exec_Sql_Dinamico('Ivan','drop trigger tx_doador_potencial_befinsupd');
end if;

/* Bruna em 30/04/2008 */

if (dt_versao_atual_cliente_w < to_date('30/04/2008','dd/mm/yyyy')) then

	CALL Exec_Sql_Dinamico('Bruna','alter table MEDIC_USO_CONTINUO drop constraint MEUSCON_TXRECE_FK');
	CALL Exec_Sql_Dinamico('Bruna','drop index MEUSCON_TXRECE_FK_I');

	CALL Exec_Sql_Dinamico('Bruna','alter table MEDIC_USO_CONTINUO_HIST drop constraint MEUSCO_TXRECE_FK');
	CALL Exec_Sql_Dinamico('Bruna','drop index MEUSCO_TXRECE_FK_I');

	CALL Exec_Sql_Dinamico('Bruna','alter table MEDIC_USO_CONTINUO drop column NR_SEQ_RECEPTOR');
	CALL Exec_Sql_Dinamico('Bruna','alter table MEDIC_USO_CONTINUO_HIST drop column NR_SEQ_RECEPTOR');
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_ajustar_base_transplante () FROM PUBLIC;

