-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE define_material_tuss ( cd_estabelecimento_p bigint, cd_material_p bigint, cd_convenio_p bigint, cd_categoria_p text, ie_tipo_atendimento_p bigint, ie_origem_preco_p bigint, dt_vigencia_p timestamp, nr_seq_simp_preco_p bigint, nr_seq_bras_preco_p bigint, nr_seq_lote_fornec_p bigint, nm_usuario_p text, cd_material_tuss_p INOUT bigint, nr_seq_tuss_mat_item_p INOUT bigint, ds_material_tuss_p INOUT text, cd_cgc_fornecedor_p text) AS $body$
DECLARE


qt_regra_tuss_w		bigint;
cd_material_tuss_w	bigint;
nr_seq_tuss_mat_item_w	bigint;
nr_seq_tuss_mat_w	bigint;
ds_material_tuss_w	varchar(255);
nr_seq_marca_w		material_lote_fornec.nr_seq_marca%type;
ie_ordem_tuss_mat_w	parametro_faturamento.ie_ordem_tuss_mat%type;
	
C01 CURSOR FOR
	SELECT	nr_seq_tuss_mat_item,
		cd_material_tuss
	from	material_tuss
	where	cd_material = cd_material_p
	and 	ie_situacao = 'A'
	and 	coalesce(cd_convenio, coalesce(cd_convenio_p,0)) 			=  coalesce(cd_convenio_p,0)
	and 	coalesce(cd_categoria, coalesce(cd_categoria_p, '0')) 		=  coalesce(cd_categoria_p, '0')
	and 	coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_p,0)) 	=  coalesce(ie_tipo_atendimento_p,0)
	and 	coalesce(ie_origem_preco, coalesce(ie_origem_preco_p,0)) 		= coalesce(ie_origem_preco_p,0)
	and 	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) 	= coalesce(cd_estabelecimento_p,0)
	and 	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_vigencia_p) between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_vigencia_inicial) and  coalesce(dt_vigencia_final, dt_vigencia_p)	
	and 	coalesce(nr_seq_marca, nr_seq_marca_w) 			= nr_seq_marca_w
	and 	coalesce(cd_cgc_fornecedor, coalesce(cd_cgc_fornecedor_p, '0')) 	= coalesce(cd_cgc_fornecedor_p, '0')
	order by  coalesce(ie_tipo_atendimento,0),
		  coalesce(ie_origem_preco,0),
		  coalesce(cd_categoria,'0'),
		  coalesce(cd_convenio,0),
		  coalesce(cd_estabelecimento,0),
		  coalesce(nr_seq_marca,0),
		  coalesce(cd_cgc_fornecedor,'0');
		
C01_w	C01%rowtype;		
		  

BEGIN

select 	coalesce(max(ie_ordem_tuss_mat),'O')
into STRICT	ie_ordem_tuss_mat_w
from 	parametro_faturamento
where 	cd_estabelecimento = cd_estabelecimento_p;

cd_material_tuss_w	:= 0;
nr_seq_tuss_mat_item_w	:= 0;
ds_material_tuss_w	:= null;

if (ie_ordem_tuss_mat_w = 'O') then -- Origem do Preco / Material x TUSS 
	if (coalesce(nr_seq_simp_preco_p,0) > 0) and (coalesce(ie_origem_preco_p,0) = 4) then	
		
		select	max(cd_tuss)
		into STRICT	cd_material_tuss_w
		from	simpro_preco
		where	nr_sequencia = nr_seq_simp_preco_p;
		
		if (coalesce(cd_material_tuss_w,0) <> 0) then
		
				select 	coalesce(max(a.nr_sequencia),0)
				into STRICT	nr_seq_tuss_mat_w
				from   	tuss_material a
				where  	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
				and 	exists (SELECT 	1
						from 	tuss_material_item b
						where 	b.nr_seq_carga_tuss = a.nr_sequencia
						and 	b.cd_material_tuss = cd_material_tuss_w);
			
				select 	max(nr_sequencia),
						max(ds_material)
				into STRICT	nr_seq_tuss_mat_item_w,
						ds_material_tuss_w
				from 	tuss_material_item
				where 	nr_seq_carga_tuss = nr_seq_tuss_mat_w
				and 	cd_material_tuss = cd_material_tuss_w;
			
		end if;
		
	end if;

	if (coalesce(nr_seq_bras_preco_p,0) > 0) and (coalesce(ie_origem_preco_p,0) = 1) then
		
		select	max(cd_tuss)
		into STRICT	cd_material_tuss_w
		from	brasindice_preco
		where	nr_sequencia = nr_seq_bras_preco_p;
		
		if (coalesce(cd_material_tuss_w,0) <> 0) then
		
				select 	coalesce(max(a.nr_sequencia),0)
				into STRICT	nr_seq_tuss_mat_w
				from   	tuss_material a
				where  	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
				and 	exists (SELECT 	1
						from 	tuss_material_item b
						where 	b.nr_seq_carga_tuss = a.nr_sequencia
						and 	b.cd_material_tuss = cd_material_tuss_w);
				
				select 	max(nr_sequencia),
						max(ds_material)
				into STRICT	nr_seq_tuss_mat_item_w,
						ds_material_tuss_w
				from 	tuss_material_item
				where 	nr_seq_carga_tuss = nr_seq_tuss_mat_w
				and 	cd_material_tuss = cd_material_tuss_w;
				
		end if;
		
	end if;

	if (coalesce(cd_material_tuss_w,0) = 0) then

		select 	count(*)
		into STRICT	qt_regra_tuss_w
		from 	material_tuss
		where 	cd_material = cd_material_p
		and 	ie_situacao = 'A';

		if (qt_regra_tuss_w > 0) then
		
			nr_seq_marca_w:= 0;
			if (coalesce(nr_seq_lote_fornec_p,0) > 0) then
		
				select	coalesce(max(nr_seq_marca),0)
				into STRICT	nr_seq_marca_w
				from	material_lote_fornec
				where	nr_sequencia = nr_seq_lote_fornec_p;

			end if;

			open C01;
			loop
			fetch C01 into	
				C01_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				begin		
				nr_seq_tuss_mat_item_w	:= C01_w.nr_seq_tuss_mat_item;		
				cd_material_tuss_w	:= C01_w.cd_material_tuss;		
				end;
			end loop;
			close C01;
			
			select 	max(ds_material)
			into STRICT	ds_material_tuss_w
			from 	tuss_material_item
			where 	nr_sequencia = nr_seq_tuss_mat_item_w;
		end if;
		
	end if;
	
elsif (ie_ordem_tuss_mat_w = 'M') then -- Material x TUSS / Origem do Preco 
	select 	count(*)
	into STRICT	qt_regra_tuss_w
	from 	material_tuss
	where 	cd_material = cd_material_p
	and 	ie_situacao = 'A';

	if (qt_regra_tuss_w > 0) then
	
		nr_seq_marca_w:= 0;
		if (coalesce(nr_seq_lote_fornec_p,0) > 0) then
	
			select	coalesce(max(nr_seq_marca),0)
			into STRICT	nr_seq_marca_w
			from	material_lote_fornec
			where	nr_sequencia = nr_seq_lote_fornec_p;

		end if;

		open C01;
		loop
		fetch C01 into	
			C01_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin		
			nr_seq_tuss_mat_item_w	:= C01_w.nr_seq_tuss_mat_item;		
			cd_material_tuss_w	:= C01_w.cd_material_tuss;		
			end;
		end loop;
		close C01;
		
		select 	max(ds_material)
		into STRICT	ds_material_tuss_w
		from 	tuss_material_item
		where 	nr_sequencia = nr_seq_tuss_mat_item_w;
	end if;
	
	if (coalesce(nr_seq_simp_preco_p,0) > 0) and (coalesce(ie_origem_preco_p,0) = 4) and (coalesce(cd_material_tuss_w,0) = 0) then	
		
		select	max(cd_tuss)
		into STRICT	cd_material_tuss_w
		from	simpro_preco
		where	nr_sequencia = nr_seq_simp_preco_p;
		
		if (coalesce(cd_material_tuss_w,0) <> 0) then
		
				select 	coalesce(max(a.nr_sequencia),0)
				into STRICT	nr_seq_tuss_mat_w
				from   	tuss_material a
				where  	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
				and 	exists (SELECT 	1
						from 	tuss_material_item b
						where 	b.nr_seq_carga_tuss = a.nr_sequencia
						and 	b.cd_material_tuss = cd_material_tuss_w);
				
				select 	max(nr_sequencia),
						max(ds_material)
				into STRICT	nr_seq_tuss_mat_item_w,
						ds_material_tuss_w
				from 	tuss_material_item
				where 	nr_seq_carga_tuss = nr_seq_tuss_mat_w
				and 	cd_material_tuss = cd_material_tuss_w;
				
		end if;
		
	end if;

	if (coalesce(nr_seq_bras_preco_p,0) > 0) and (coalesce(ie_origem_preco_p,0) = 1) and (coalesce(cd_material_tuss_w,0) = 0) then
		
		select	max(cd_tuss)
		into STRICT	cd_material_tuss_w
		from	brasindice_preco
		where	nr_sequencia = nr_seq_bras_preco_p;
		
		
		if (coalesce(cd_material_tuss_w,0) <> 0) then
		
				select 	coalesce(max(a.nr_sequencia),0)
				into STRICT	nr_seq_tuss_mat_w
				from   	tuss_material a
				where  	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
				and 	exists (SELECT 	1
						from 	tuss_material_item b
						where 	b.nr_seq_carga_tuss = a.nr_sequencia
						and 	b.cd_material_tuss = cd_material_tuss_w);
				
				select 	max(nr_sequencia),
						max(ds_material)
				into STRICT	nr_seq_tuss_mat_item_w,
						ds_material_tuss_w
				from 	tuss_material_item
				where 	nr_seq_carga_tuss = nr_seq_tuss_mat_w
				and 	cd_material_tuss = cd_material_tuss_w;
				
		end if;
				
	end if;
		
end if;

cd_material_tuss_p	:= cd_material_tuss_w;
nr_seq_tuss_mat_item_p	:= nr_seq_tuss_mat_item_w;
ds_material_tuss_p	:=  ds_material_tuss_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE define_material_tuss ( cd_estabelecimento_p bigint, cd_material_p bigint, cd_convenio_p bigint, cd_categoria_p text, ie_tipo_atendimento_p bigint, ie_origem_preco_p bigint, dt_vigencia_p timestamp, nr_seq_simp_preco_p bigint, nr_seq_bras_preco_p bigint, nr_seq_lote_fornec_p bigint, nm_usuario_p text, cd_material_tuss_p INOUT bigint, nr_seq_tuss_mat_item_p INOUT bigint, ds_material_tuss_p INOUT text, cd_cgc_fornecedor_p text) FROM PUBLIC;

