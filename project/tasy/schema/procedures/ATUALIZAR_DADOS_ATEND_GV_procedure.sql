-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_dados_atend_gv ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_estabelecimento_w		smallint;
ie_atualiza_setor_atual_w	varchar(1);
ie_altera_status_acomod_w	varchar(1);
nr_atendimento_w		bigint;
cd_setor_atual_w                bigint;
cd_tipo_acomod_atual_w          bigint;
cd_unid_basica_atual_w		gestao_vaga.cd_unid_basica_atual%type;
cd_unid_compl_atual_w		gestao_vaga.cd_unid_compl_atual%type;
			

BEGIN

cd_estabelecimento_w	  := wheb_usuario_pck.get_cd_estabelecimento;		
ie_atualiza_setor_atual_w := obter_valor_param_usuario(1002,48,obter_perfil_ativo,nm_usuario_p,cd_estabelecimento_w);
ie_altera_status_acomod_w := obter_valor_param_usuario(1002,26,obter_perfil_ativo,nm_usuario_p,cd_estabelecimento_w);

if (coalesce(nr_sequencia_p,0) > 0) then
	
	select	max(nr_atendimento)
	into STRICT	nr_atendimento_w
	from	gestao_vaga
	where	nr_sequencia = nr_sequencia_p;
	
	if (coalesce(nr_atendimento_w,0) > 0) then
	
		if (coalesce(ie_atualiza_setor_atual_w,'N') = 'S') then
	
			select	obter_unidade_atendimento(nr_atendimento_w,'IAA','CS')
			into STRICT	cd_setor_atual_w
			;
			
			Select  obter_unidade_atendimento(nr_atendimento_w,'IAA','CTA')
			into STRICT	cd_tipo_acomod_atual_w
			;
			
			select substr(obter_unidade_atendimento(nr_atendimento_w,'IAA','UB'),1,40)
			into STRICT 	cd_unid_basica_atual_w
			;
				
			select substr(obter_unidade_atendimento(nr_atendimento_w,'IAA','UC'),1,40)
			into STRICT 	cd_unid_compl_atual_w
			;
			
			
			update	gestao_vaga
			set	cd_setor_atual	     = cd_setor_atual_w,
				cd_tipo_acomod_atual = cd_tipo_acomod_atual_w,
				cd_unid_basica_atual = cd_unid_basica_atual_w,
				cd_unid_compl_atual	 = cd_unid_compl_atual_w
			where	nr_sequencia	 = nr_sequencia_p
			and	nr_atendimento 	     = nr_atendimento_w;
	
		end if;
	
		if (coalesce(ie_altera_status_acomod_w,'N') = 'S') then
		
			update  gestao_vaga
			set     ie_status      = 'F', 
				dt_acomodacao  = clock_timestamp(),         
				nm_resp_transf = nm_usuario_p,
				nm_usuario     = nm_usuario_p,
				dt_atualizacao = clock_timestamp()         
			where   nr_sequencia   = nr_sequencia_p
			and	nr_atendimento = nr_atendimento_w;
		
		end if;	
	
	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_dados_atend_gv ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

