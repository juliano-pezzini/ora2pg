-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_ctg_seq_prescription ( nr_sequencia_p bigint, nm_usuario_p fa_receita_farmacia.nm_usuario%type) AS $body$
DECLARE
						

nr_presc_ctg_w			bigint;
cd_presc_ctg_w varchar(2);
dt_prescription_w timestamp;
ds_prescr_ctg_w varchar(6);
cd_pessoa_fisica_w pessoa_fisica.cd_pessoa_fisica%type;
nr_seq_etnia_w bigint;


BEGIN

if (pkg_i18n.get_user_locale()='en_AU') then

    if	((coalesce(nr_sequencia_p,0)) > 0) then

          begin
    
                select  dt_receita,cd_pessoa_fisica into STRICT dt_prescription_w,cd_pessoa_fisica_w 
                from fa_receita_farmacia 
                where nr_sequencia = nr_sequencia_p;

                select nr_seq_etnia into STRICT nr_seq_etnia_w
                from pessoa_fisica
                where cd_pessoa_fisica = cd_pessoa_fisica_w;

                if (nr_seq_etnia_w IS NOT NULL AND nr_seq_etnia_w::text <> '') then
                      begin
                              select mod(count(*)+1,99) into STRICT nr_presc_ctg_w 
                              from  fa_receita_farmacia 
                              where trunc(dt_receita) = trunc(dt_prescription_w) 
                              and cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento
                              and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
                              and coalesce(dt_cancelamento::text, '') = ''
                              and (cd_ctg_prescr IS NOT NULL AND cd_ctg_prescr::text <> '');

                              
                              if ( nr_presc_ctg_w < 10) then
                                cd_presc_ctg_w := '0' ||to_char(nr_presc_ctg_w);
                              else
                                cd_presc_ctg_w := to_char(nr_presc_ctg_w);
                              end if;

              
                              select ('CTG' || cd_presc_ctg_w || CASE WHEN mod((cd_presc_ctg_w || to_char(dt_prescription_w,'ddmmyy'))::numeric ,19)=0 THEN 'B' WHEN mod((cd_presc_ctg_w || to_char(dt_prescription_w,'ddmmyy'))::numeric ,19)=1 THEN 'C' WHEN mod((cd_presc_ctg_w || to_char(dt_prescription_w,'ddmmyy'))::numeric ,19)=2 THEN 'D' WHEN mod((cd_presc_ctg_w || to_char(dt_prescription_w,'ddmmyy'))::numeric ,19)=3 THEN 'E' WHEN mod((cd_presc_ctg_w || to_char(dt_prescription_w,'ddmmyy'))::numeric ,19)=4 THEN 'F' WHEN mod((cd_presc_ctg_w || to_char(dt_prescription_w,'ddmmyy'))::numeric ,19)=5 THEN 'G' WHEN mod((cd_presc_ctg_w || to_char(dt_prescription_w,'ddmmyy'))::numeric ,19)=6 THEN 'H' WHEN mod((cd_presc_ctg_w || to_char(dt_prescription_w,'ddmmyy'))::numeric ,19)=7 THEN 'J' WHEN mod((cd_presc_ctg_w || to_char(dt_prescription_w,'ddmmyy'))::numeric ,19)=8 THEN 'K' WHEN mod((cd_presc_ctg_w || to_char(dt_prescription_w,'ddmmyy'))::numeric ,19)=9 THEN 'L' WHEN mod((cd_presc_ctg_w || to_char(dt_prescription_w,'ddmmyy'))::numeric ,19)=10 THEN 'M' WHEN mod((cd_presc_ctg_w || to_char(dt_prescription_w,'ddmmyy'))::numeric ,19)=11 THEN 'N' WHEN mod((cd_presc_ctg_w || to_char(dt_prescription_w,'ddmmyy'))::numeric ,19)=12 THEN 'P' WHEN mod((cd_presc_ctg_w || to_char(dt_prescription_w,'ddmmyy'))::numeric ,19)=13 THEN 'Q' WHEN mod((cd_presc_ctg_w || to_char(dt_prescription_w,'ddmmyy'))::numeric ,19)=14 THEN 'R' WHEN mod((cd_presc_ctg_w || to_char(dt_prescription_w,'ddmmyy'))::numeric ,19)=15 THEN 'T' WHEN mod((cd_presc_ctg_w || to_char(dt_prescription_w,'ddmmyy'))::numeric ,19)=16 THEN 'W' WHEN mod((cd_presc_ctg_w || to_char(dt_prescription_w,'ddmmyy'))::numeric ,19)=17 THEN 'X'  ELSE 'Y' END )
                              into STRICT ds_prescr_ctg_w;

              
              
                              update fa_receita_farmacia 
                              set nr_prescr_seq_ctg = nr_presc_ctg_w , 
                              cd_ctg_prescr =  ds_prescr_ctg_w,
                              nm_usuario = nm_usuario_p, 
                              dt_atualizacao = clock_timestamp(),
                              dt_liberacao    = clock_timestamp(),
                              nm_usuario_lib	= nm_usuario_p
                              where nr_sequencia = nr_sequencia_p;
                              commit;

                    
                     end;
                    end if;
          end;

    end if;

end if;
exception
when others then 
null;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_ctg_seq_prescription ( nr_sequencia_p bigint, nm_usuario_p fa_receita_farmacia.nm_usuario%type) FROM PUBLIC;

