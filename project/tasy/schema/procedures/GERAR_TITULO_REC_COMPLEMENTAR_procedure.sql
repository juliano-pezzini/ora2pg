-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_titulo_rec_complementar (nr_titulo_p titulo_receber.nr_titulo%type, nr_seq_protocolo_p protocolo_convenio.nr_seq_protocolo%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


cd_estabelecimento_w			protocolo_convenio.cd_estabelecimento%type;
cd_convenio_w				protocolo_convenio.cd_convenio%type;
nr_sequencia_w				regra_tit_rec_complementar.nr_sequencia%type;
cd_area_procedimento_w			regra_tit_rec_complementar.cd_area_procedimento%type;
cd_especialidade_w			regra_tit_rec_complementar.cd_especialidade%type;
cd_grupo_proc_w				regra_tit_rec_complementar.cd_grupo_proc%type;
cd_procedimento_w			regra_tit_rec_complementar.cd_procedimento%type;
cd_setor_exec_proc_w			regra_tit_rec_complementar.cd_setor_exec_proc%type;
ie_origem_proced_w			regra_tit_rec_complementar.ie_origem_proced%type;
nr_seq_form_org_sus_w			regra_tit_rec_complementar.nr_seq_form_org_sus%type;
nr_seq_grupo_sus_w			regra_tit_rec_complementar.nr_seq_grupo_sus%type;
nr_seq_subgrupo_sus_w			regra_tit_rec_complementar.nr_seq_subgrupo_sus%type;
pr_sobre_valor_w			regra_tit_rec_complementar.pr_sobre_valor%type;
vl_fixo_w				regra_tit_rec_complementar.vl_fixo%type;
vl_procedimento_w			procedimento_paciente.vl_procedimento%type := 0;
qt_procedimento_w			procedimento_paciente.qt_procedimento%type := 0;
vl_titulo_w				titulo_receber.vl_titulo%type := 0;
nr_titulo_w				titulo_receber.nr_titulo%type;
ds_observacao_titulo_w			titulo_receber.ds_observacao_titulo%type := '';
ie_gerar_imposto_w			parametro_contas_receber.ie_gerar_imposto_tit_rec%type;
ie_integracao_titulo_w			parametro_contas_receber.ie_integracao_titulo%type;
ds_erro_w				erros_integracao_piramide.ds_erro%type := '';
vl_trib_titulo_w			titulo_receber_trib.vl_tributo%type;
vl_tributo_tit_saldo_w			titulo_receber_trib.vl_tributo%type;

C01 CURSOR FOR
	SELECT	nr_sequencia,
		cd_area_procedimento,
		cd_especialidade,
		cd_grupo_proc,
		cd_procedimento,
		cd_setor_exec_proc,
		ie_origem_proced,
		nr_seq_form_org_sus,
		nr_seq_grupo_sus,
		nr_seq_subgrupo_sus,
		pr_sobre_valor,
		vl_fixo
	from	regra_tit_rec_complementar
	where (coalesce(vl_fixo,0) > 0 or coalesce(pr_sobre_valor,0) > 0)
	and	coalesce(ie_situacao,'I') = 'A'
	and	cd_estabelecimento = cd_estabelecimento_w
	and	cd_convenio = cd_convenio_w
	order by nr_sequencia;

type 		fetch_array is table of c01%rowtype;
s_array 	fetch_array;
i		integer := 1;
type vetor is table of fetch_array index by integer;
vetor_c01_w			vetor;

BEGIN

begin
select	cd_estabelecimento,
	cd_convenio
into STRICT	cd_estabelecimento_w,
	cd_convenio_w
from	protocolo_convenio
where	nr_seq_protocolo = nr_seq_protocolo_p;
exception
when others then
	cd_estabelecimento_w	:= 0;
	cd_convenio_w		:= 0;
end;

open c01;
loop
fetch c01 bulk collect into s_array limit 1000;
	vetor_c01_w(i) := s_array;
	i := i + 1;
EXIT WHEN NOT FOUND; /* apply on c01 */
end loop;
close c01;

for i in 1..vetor_c01_w.count loop
	begin
	s_array := vetor_c01_w(i);
	for z in 1..s_array.count loop
		begin

		nr_sequencia_w		:= s_array[z].nr_sequencia;
		cd_area_procedimento_w	:= s_array[z].cd_area_procedimento;
		cd_especialidade_w	:= s_array[z].cd_especialidade;
		cd_grupo_proc_w		:= s_array[z].cd_grupo_proc;
		cd_procedimento_w	:= s_array[z].cd_procedimento;
		cd_setor_exec_proc_w	:= s_array[z].cd_setor_exec_proc;
		ie_origem_proced_w	:= s_array[z].ie_origem_proced;
		nr_seq_form_org_sus_w	:= s_array[z].nr_seq_form_org_sus;
		nr_seq_grupo_sus_w	:= s_array[z].nr_seq_grupo_sus;
		nr_seq_subgrupo_sus_w	:= s_array[z].nr_seq_subgrupo_sus;
		pr_sobre_valor_w	:= s_array[z].pr_sobre_valor;
		vl_fixo_w               := s_array[z].vl_fixo;

		begin
		select	sum(vl_procedimento),
			sum(qt_procedimento)
		into STRICT	vl_procedimento_w,
			qt_procedimento_w
		from	procedimento_paciente a,
			conta_paciente b,
			estrutura_procedimento_v c
		where	a.nr_interno_conta = b.nr_interno_conta
		and	b.nr_seq_protocolo = nr_seq_protocolo_p
		and	a.cd_procedimento = c.cd_procedimento
		and	a.ie_origem_proced = c.ie_origem_proced
		and	((coalesce(cd_procedimento_w,0) = 0) or
			(cd_procedimento_w = a.cd_procedimento AND ie_origem_proced_w = a.ie_origem_proced))
		and	((coalesce(cd_area_procedimento_w,0) = 0) or (cd_area_procedimento_w = c.cd_area_procedimento))
		and	((coalesce(cd_especialidade_w,0) = 0) or (cd_especialidade_w = c.cd_especialidade))
		and	((coalesce(cd_grupo_proc_w,0) = 0) or (cd_grupo_proc_w = c.cd_grupo_proc))
		and	((coalesce(nr_seq_form_org_sus_w,0) = 0) or (nr_seq_form_org_sus_w = coalesce(sus_obter_estrut_proc(a.cd_procedimento,a.ie_origem_proced,'S','F'),'0')))
		and	((coalesce(nr_seq_grupo_sus_w,0) = 0) or (nr_seq_grupo_sus_w = coalesce(sus_obter_estrut_proc(a.cd_procedimento,a.ie_origem_proced,'S','G'),'0')))
		and	((coalesce(nr_seq_subgrupo_sus_w,0) = 0) or (nr_seq_subgrupo_sus_w = coalesce(sus_obter_estrut_proc(a.cd_procedimento,a.ie_origem_proced,'S','S'),'0')))
		and	((coalesce(cd_setor_exec_proc_w,0) = 0) or (cd_setor_exec_proc_w = a.cd_setor_atendimento))
		and	coalesce(a.cd_motivo_exc_conta::text, '') = '';
		exception
		when others then
			vl_procedimento_w := 0;
		end;

		if (vl_procedimento_w > 0) then
			begin

			if (vl_fixo_w > 0) then
				vl_titulo_w := (vl_fixo_w*qt_procedimento_w);
			elsif (pr_sobre_valor_w > 0) then
				vl_titulo_w := ((vl_procedimento_w*pr_sobre_valor_w)/100);
			end if;

			if (vl_titulo_w > 0) then
				begin

				select 	coalesce(max(ie_gerar_imposto_tit_rec),'N'),
					max(ie_integracao_titulo)
				into STRICT 	ie_gerar_imposto_w,
					ie_integracao_titulo_w
				from 	parametro_contas_receber
				where	cd_estabelecimento  = cd_estabelecimento_w;

				select	nextval('titulo_seq')
				into STRICT	nr_titulo_w
				;

				ds_observacao_titulo_w	:= substr(wheb_mensagem_pck.get_texto(998787,'NR_SEQ_REGRA_P='||nr_sequencia_w),1,4000);

				insert into titulo_receber(
					nr_titulo,		cd_agencia_bancaria,		cd_banco,
					cd_cgc,			cd_convenio_conta,		cd_estabelecimento,
					cd_estab_financeiro,	cd_moeda,			cd_pessoa_fisica,
					cd_portador,		cd_serie,			cd_tipo_portador,
					cd_tipo_recebimento,	cd_tipo_taxa_juro,		cd_tipo_taxa_multa,
					ds_observacao_titulo,	dt_atualizacao,			dt_contabil,
					dt_credito_bancario,	dt_emissao,			dt_emissao_bloqueto,
					dt_envio_serasa,	dt_inclusao,			dt_integracao_externa,
					dt_limite_desconto,	dt_liquidacao,			dt_pagamento_previsto,
					dt_ref_conta,		dt_ultima_alteracao,		dt_ultima_devolucao,
					dt_vencimento,		ie_data_juros_multa,		ie_dig_nosso_numero,
					ie_entrada_confirmada,	ie_integra_unimed,		ie_liq_inadimplencia,
					ie_negociacao_impressa,	ie_negociado,			ie_origem_titulo,
					ie_pls,			ie_prorrogacao_portal,		ie_situacao,
					ie_tipo_carteira,	ie_tipo_emissao_titulo,		ie_tipo_inclusao,
					ie_tipo_titulo,		nm_usuario,			nm_usuario_orig,
					nr_atendimento,		nr_bloqueto,			nr_documento,
					nr_duplicata,		nr_guia,			nr_interno_conta,
					nr_livro,		nr_lote_contabil,		nr_lote_contabil_curto_prazo,
					nr_nosso_numero,	nr_nota_fiscal,			nr_processo_aih,
					nr_rps,			nr_seq_agrupamento,		nr_seq_carteira_cobr,
					nr_seq_classe,		nr_seq_cliente,			nr_seq_cob_previa,
					nr_seq_conta_banco,	nr_seq_contrato,		nr_seq_controle_pessoa,
					nr_seq_eme_fatura,	nr_seq_empresa,			nr_seq_grupo_prod,
					nr_seq_guia,		nr_seq_lote_empresa,		nr_seq_lote_enc_contas,
					nr_seq_lote_prot,	nr_seq_mensalidade,		nr_seq_mens_segurado,
					nr_seq_negociacao_origem,nr_seq_nf_saida,		nr_seq_nota_deb_conclusao,
					nr_seq_pagador,		nr_seq_pag_conta_evento,	nr_seq_pls_lote_camara,
					nr_seq_pls_lote_contest,nr_seq_pls_lote_disc,		nr_seq_proj_rec,
					nr_seq_protocolo,	nr_seq_ptu_fatura,		nr_seq_ptu_fatura_old,
					nr_seq_segurado_mens,	nr_seq_terc_conta,		nr_seq_tf_curto_prazo,
					nr_seq_trans_fin_baixa,	nr_seq_trans_fin_contab,	nr_sequencia_doc,
					nr_sistema_ant,		nr_titulo_dest,			nr_titulo_externo,
					nr_titulo_ext_numerico,	tx_desc_antecipacao,		tx_juros,
					tx_multa,		vl_abatimento,			vl_cotacao,
					vl_desc_previsto,	vl_juros_boleto,		vl_multa_boleto,
					vl_multa_fixo,		vl_outras_despesas,		vl_saldo_juros,
					vl_saldo_multa,		vl_saldo_titulo,		vl_titulo,
					vl_titulo_estrang)
				SELECT	nr_titulo_w,		cd_agencia_bancaria,		cd_banco,
					cd_cgc,			cd_convenio_conta,		cd_estabelecimento,
					cd_estab_financeiro,	cd_moeda,			cd_pessoa_fisica,
					cd_portador,		cd_serie,			cd_tipo_portador,
					cd_tipo_recebimento,	cd_tipo_taxa_juro,		cd_tipo_taxa_multa,
					ds_observacao_titulo_w,	clock_timestamp(),			dt_contabil,
					dt_credito_bancario,	dt_emissao,			dt_emissao_bloqueto,
					dt_envio_serasa,	dt_inclusao,			dt_integracao_externa,
					dt_limite_desconto,	dt_liquidacao,			dt_pagamento_previsto,
					dt_ref_conta,		dt_ultima_alteracao,		dt_ultima_devolucao,
					dt_vencimento,		ie_data_juros_multa,		ie_dig_nosso_numero,
					ie_entrada_confirmada,	ie_integra_unimed,		ie_liq_inadimplencia,
					ie_negociacao_impressa,	ie_negociado,			ie_origem_titulo,
					ie_pls,			ie_prorrogacao_portal,		ie_situacao,
					ie_tipo_carteira,	ie_tipo_emissao_titulo,		ie_tipo_inclusao,
					ie_tipo_titulo,		nm_usuario_p,			nm_usuario_orig,
					nr_atendimento,		nr_bloqueto,			nr_documento,
					nr_duplicata,		nr_guia,			nr_interno_conta,
					nr_livro,		nr_lote_contabil,		nr_lote_contabil_curto_prazo,
					nr_nosso_numero,	nr_nota_fiscal,			nr_processo_aih,
					nr_rps,			nr_seq_agrupamento,		nr_seq_carteira_cobr,
					nr_seq_classe,		nr_seq_cliente,			nr_seq_cob_previa,
					nr_seq_conta_banco,	nr_seq_contrato,		nr_seq_controle_pessoa,
					nr_seq_eme_fatura,	nr_seq_empresa,			nr_seq_grupo_prod,
					nr_seq_guia,		nr_seq_lote_empresa,		nr_seq_lote_enc_contas,
					nr_seq_lote_prot,	nr_seq_mensalidade,		nr_seq_mens_segurado,
					nr_seq_negociacao_origem,nr_seq_nf_saida,		nr_seq_nota_deb_conclusao,
					nr_seq_pagador,		nr_seq_pag_conta_evento,	nr_seq_pls_lote_camara,
					nr_seq_pls_lote_contest,nr_seq_pls_lote_disc,		nr_seq_proj_rec,
					nr_seq_protocolo,	nr_seq_ptu_fatura,		nr_seq_ptu_fatura_old,
					nr_seq_segurado_mens,	nr_seq_terc_conta,		nr_seq_tf_curto_prazo,
					nr_seq_trans_fin_baixa,	nr_seq_trans_fin_contab,	nr_sequencia_doc,
					nr_sistema_ant,		nr_titulo_dest,			nr_titulo_externo,
					nr_titulo_ext_numerico,	tx_desc_antecipacao,		tx_juros,
					0,			0,				0,
					0,			0,				0,
					0,			0,				0,
					0,			vl_titulo_w,			vl_titulo_w,
					CASE WHEN coalesce(vl_cotacao,0)=0 THEN 0  ELSE coalesce((vl_titulo_w/vl_cotacao),0) END
				FROM	titulo_receber
				where	nr_titulo = nr_titulo_p
				and	nr_seq_protocolo = nr_seq_protocolo_p;

				if (ie_gerar_imposto_w = 'S') and (coalesce(nr_seq_protocolo_p,0) <> 0)then
					CALL Gerar_Imposto_Tit_Rec(nr_titulo_w, nm_usuario_p);
				end if;

				begin
				select	coalesce(sum(CASE WHEN a.ie_soma_diminui='D' THEN (coalesce(b.vl_tributo,0) * - 1) WHEN a.ie_soma_diminui='S' THEN  coalesce(b.vl_tributo,0)  ELSE 0 END ),0)
				into STRICT	vl_trib_titulo_w
				from	tributo a,
					titulo_receber_trib b
				where	coalesce(a.ie_incide_conta,'N')	= 'S'
				and	a.cd_tributo		= b.cd_tributo
				and	b.nr_titulo		= nr_titulo_w;
				exception
				when others then
					vl_trib_titulo_w := 0;
				end;

				begin
				select	coalesce(sum(VL_TRIBUTO),0) * -1
				into STRICT	vl_tributo_tit_saldo_w
				from	titulo_receber_trib
				where	nr_titulo			= nr_titulo_w
				and	coalesce(ie_origem_tributo, 'C') 	= 'CD';
				exception
				when others then
					vl_tributo_tit_saldo_w := 0;
				end;

				update	titulo_receber
				set	vl_titulo		= coalesce(vl_titulo,0) + coalesce(vl_trib_titulo_w,0),
					vl_saldo_titulo		= coalesce(vl_saldo_titulo,0) + coalesce(vl_trib_titulo_w,0) + vl_tributo_tit_saldo_w
				where	nr_titulo		= nr_titulo_w;

				if (ie_integracao_titulo_w = 'P') then
					begin

					begin
					delete from erros_integracao_piramide
					where	cd_Estabelecimento = cd_estabelecimento_w
					and	nm_usuario = nm_usuario_p
					and	ie_funcao in ('TI','CLI');
					exception
					when others then
						ds_erro_w := 'X';
					end;

					begin
					select	max(ds_erro)
					into STRICT	ds_erro_w
					from	erros_integracao_piramide
					where	cd_Estabelecimento = cd_estabelecimento_w
					and	nm_usuario = nm_usuario_p
					and	ie_funcao in ('TI','CLI');
					exception
					when others then
						ds_erro_w := 'X';
					end;

					if (coalesce(ds_erro_w,'X') <> 'X') then
						CALL wheb_mensagem_pck.exibir_mensagem_abort(186197,'DS_ERRO_P='||ds_erro_w);
					end if;

					end;
				end if;

				end;
			end if;

			end;
		end if;

		end;
	end loop;
	end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_titulo_rec_complementar (nr_titulo_p titulo_receber.nr_titulo%type, nr_seq_protocolo_p protocolo_convenio.nr_seq_protocolo%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

