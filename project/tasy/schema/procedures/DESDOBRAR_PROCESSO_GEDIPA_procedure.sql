-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desdobrar_processo_gedipa ( nr_processo_p bigint, nr_etiquetas_desdobrar_p bigint, nr_seq_area_prep_p bigint, nr_processo_desdobrado_p INOUT bigint, nm_usuario_p text, ie_atualizar_processo_p text default 'S') AS $body$
DECLARE


nr_processo_desdobrado_w	bigint;
ie_possui_item_w varchar(1);					
					

BEGIN

if (nr_processo_p IS NOT NULL AND nr_processo_p::text <> '') then

	nr_processo_desdobrado_w := Adep_Desdobrar_Processo(nr_processo_p, nr_etiquetas_desdobrar_p, nr_seq_area_prep_p, nm_usuario_p, nr_processo_desdobrado_w);
	
  select coalesce(max('S'), 'N')
  into STRICT ie_possui_item_w
  from prescr_mat_hor a
  where a.nr_prescricao = nr_processo_p
  and a.nr_seq_area_prep = nr_seq_area_prep_p;

  if (ie_possui_item_w = 'N')  then
    CALL desfazer_processo_adep(nr_processo_p, 'S', nm_usuario_p);
  end if;

	if (ie_atualizar_processo_p = 'S') then
	
		if (coalesce(nr_processo_desdobrado_w,0)  > 0) then
		
			CALL Atualiza_Status_Processo_Adep(nr_processo_desdobrado_w, nr_seq_area_prep_p, 'G', 'P', clock_timestamp(), nm_usuario_p);
			
			update  adep_processo_area a
			set     a.dt_preparo    = clock_timestamp(),                                
					a.nm_usuario_preparo 	= nm_usuario_p                                     
					where   a.nr_seq_processo    = nr_processo_desdobrado_w
					and     not exists (                                                   
						SELECT   1                                            
											from     adep_processo_area x                         
											where    x.nr_seq_processo    = nr_processo_desdobrado_w
											and      x.nr_seq_area_prep   <> a.nr_seq_area_prep);
		
		end if;
	
	end if;

end if;

commit;

nr_processo_desdobrado_p := nr_processo_desdobrado_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desdobrar_processo_gedipa ( nr_processo_p bigint, nr_etiquetas_desdobrar_p bigint, nr_seq_area_prep_p bigint, nr_processo_desdobrado_p INOUT bigint, nm_usuario_p text, ie_atualizar_processo_p text default 'S') FROM PUBLIC;

