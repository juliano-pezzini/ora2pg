-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_disp_cirurgia (nr_cirurgia_p bigint) AS $body$
DECLARE


qt_material_w			double precision;
qt_disp_pepo_w			double precision;
nr_prescricao_w			bigint;
nr_sequencia_w			bigint;
qt_dispensacao_w		double precision;
qt_diferenca_w			double precision;
ie_consolidacao_generico_w	varchar(1);
cd_unidade_medida_w		varchar(30);
cd_material_w			integer;



c01 CURSOR FOR

	SELECT	coalesce(b.qt_material,0),
		coalesce(b.qt_disp_pepo,0),
		b.nr_prescricao,
		b.nr_sequencia
	from	cirurgia a,
		prescr_material b
	where	a.nr_prescricao 	= b.nr_prescricao
	and	b.cd_material		= cd_material_w
	and	b.cd_unidade_medida	= cd_unidade_medida_w
	and	a.nr_cirurgia		= nr_cirurgia_p
	order by b.qt_material desc,nr_sequencia;


c02 CURSOR FOR
	SELECT	coalesce(a.qt_dispensacao,0) qt_dispensacao,
		a.cd_unidade_medida,
		a.cd_material
	from	cirurgia_agente_disp a,
		material b
	where	a.cd_material			= b.cd_material_estoque
	and	a.ie_operacao			= 'D'
	and	a.nr_cirurgia			= nr_cirurgia_p
	and	ie_consolidacao_generico_w 	= 'S'
	
union all

	SELECT	coalesce(a.qt_dispensacao,0) qt_dispensacao,
		a.cd_unidade_medida,
		a.cd_material
	from	cirurgia_agente_disp a
	where	a.nr_cirurgia			= nr_cirurgia_p
	and	a.ie_operacao			= 'D'
	and	ie_consolidacao_generico_w 	= 'N'
	order by cd_material,qt_dispensacao;


BEGIN

update	prescr_material
set	qt_disp_pepo 	= 0
where	nr_prescricao 	= (SELECT max(nr_prescricao) from cirurgia where nr_cirurgia = nr_cirurgia_p);

commit;

ie_consolidacao_generico_w := obter_param_usuario(872, 152, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_consolidacao_generico_w);

open c02;
loop
fetch c02 into
	qt_dispensacao_w,
	cd_unidade_medida_w,
	cd_material_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin
	open c01;
	loop
	fetch c01 into
		qt_material_w,
		qt_disp_pepo_w,
		nr_prescricao_w,
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		if (qt_dispensacao_w > 0) and (qt_disp_pepo_w < qt_material_w) then
			if (qt_dispensacao_w = 1) then
				update	prescr_material
				set	qt_disp_pepo	= coalesce(qt_disp_pepo,0) + 1
				where	nr_prescricao	= nr_prescricao_w
				and	nr_sequencia	= nr_sequencia_w;
				qt_dispensacao_w 	:= 0;
			else
				qt_diferenca_w := qt_material_w	- qt_disp_pepo_w;
				if (qt_diferenca_w >= qt_dispensacao_w) then
					update	prescr_material
					set	qt_disp_pepo	= coalesce(qt_disp_pepo,0) + qt_dispensacao_w
					where	nr_prescricao	= nr_prescricao_w
					and	nr_sequencia	= nr_sequencia_w;
					qt_dispensacao_w 	:= 0;
				else
					qt_dispensacao_w	:= qt_dispensacao_w - qt_diferenca_w;
					update	prescr_material
					set	qt_disp_pepo	= qt_material
					where	nr_prescricao	= nr_prescricao_w
					and	nr_sequencia	= nr_sequencia_w;
				end if;
			end if;
		end if;
		end;
		end loop;
		close c01;
	if (qt_dispensacao_w > 0) then
		update	prescr_material
		set	qt_disp_pepo	= qt_disp_pepo + qt_dispensacao_w
		where	nr_prescricao	= nr_prescricao_w
		and	nr_sequencia	= nr_sequencia_w;
	end if;

	begin
	commit;
	exception
		when others then
		nr_sequencia_w := null;
	end;
	end;
end loop;
close c02;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_disp_cirurgia (nr_cirurgia_p bigint) FROM PUBLIC;

