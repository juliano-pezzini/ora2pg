-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_codigo_pj_int_br ( cd_cnpj_p INOUT text, nr_seq_idioma_p bigint default 1, nm_usuario_p text DEFAULT NULL) AS $body$
DECLARE


			
cd_cnpj_intern_w	varchar(255);
ie_incrementar_pj_w	varchar(1) := 'N';
qt_existe_w		bigint;
qt_pessoa_juridica_w	bigint;
ie_valida_pj_w		bigint:= 1;


BEGIN
if (nr_seq_idioma_p <> 1) then
	ie_incrementar_pj_w := 'S';
end if;

if (ie_incrementar_pj_w = 'S') then

	while(ie_valida_pj_w <> 0) loop
		begin
		
		select 	adiciona_zeros_esquerda(coalesce(max(nr_ultimo_cnpj), 0) + ie_valida_pj_w, 14)
		into STRICT	cd_cnpj_intern_w
		from 	parametros_pj
		where	ie_incrementar_pj = 'S';
		
		select 	count(1)
		into STRICT    qt_pessoa_juridica_w
		from 	pessoa_juridica
		where 	cd_cgc = cd_cnpj_intern_w  LIMIT 1;
		
		if (qt_pessoa_juridica_w = 0) then
			ie_valida_pj_w:= 0;
		else	
			ie_valida_pj_w:= ie_valida_pj_w + 1;
		end if;
		
		end;
	end loop;

	cd_cnpj_p		:=  cd_cnpj_intern_w;

	select	count(*)
	into STRICT	qt_existe_w
	from	parametros_pj;
	
	if (qt_existe_w = 0) then
		insert into parametros_pj(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ie_incrementar_pj,
			nr_ultimo_cnpj)
		values (	nextval('parametros_pj_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			'S',
			cd_cnpj_intern_w);
	else
		update	parametros_pj
		set	nr_ultimo_cnpj =  cd_cnpj_intern_w;
	end if;
end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_codigo_pj_int_br ( cd_cnpj_p INOUT text, nr_seq_idioma_p bigint default 1, nm_usuario_p text DEFAULT NULL) FROM PUBLIC;

