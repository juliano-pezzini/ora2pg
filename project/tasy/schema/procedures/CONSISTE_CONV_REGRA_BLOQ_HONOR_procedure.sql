-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_conv_regra_bloq_honor ( nr_atendimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_medico_executor_p bigint, dt_procedimento_p timestamp, cd_convenio_p bigint) AS $body$
DECLARE

 
dt_cirurgia_w		timestamp;
cd_medico_executor_w	varchar(10);
qt_dias_w		bigint;
cd_procedimento_w	bigint;
qt_dias_cirurgia_w	bigint;
qt_regra_w		bigint;
cd_area_proc_w		bigint;
cd_grupo_proc_w		bigint;
cd_especialidade_w	bigint;


BEGIN 
 
begin 
select	cd_area_procedimento, 
	cd_grupo_proc, 
	cd_especialidade 
into STRICT	cd_area_proc_w, 
	cd_grupo_proc_w, 
	cd_especialidade_w 
from	estrutura_procedimento_v 
where	cd_procedimento	= cd_procedimento_p 
and	ie_origem_proced	= ie_origem_proced_p;
exception 
	when others then 
	cd_area_proc_w		:= 0;
	cd_grupo_proc_w		:= 0;
	cd_especialidade_w	:= 0;
	end;
 
select 	count(*), 
	coalesce(max(qt_dias_cirurgia),0) 
into STRICT	qt_regra_w, 
	qt_dias_cirurgia_w 
from  	conv_regra_bloq_honorario 
where	ie_situacao = 'A' 
and 	cd_convenio = cd_convenio_p 
and	coalesce(cd_area_procedimento,cd_area_proc_w)	= cd_area_proc_w 
and	coalesce(cd_especialidade,cd_especialidade_w)	= cd_especialidade_w 
and	coalesce(cd_grupo_proc,cd_grupo_proc_w)		= cd_grupo_proc_w 
and	coalesce(cd_procedimento,cd_procedimento_p)		= cd_procedimento_p 
and	coalesce(ie_origem_proced,ie_origem_proced_p)	= ie_origem_proced_p;
 
if (qt_regra_w > 0) then 
 
	select	coalesce(max(a.dt_procedimento),to_date('01/01/1970','dd/mm/yyyy hh24:mi:ss')) 
	into STRICT	dt_cirurgia_w 
	from	procedimento_paciente a, 
		conta_paciente    b 
	where	a.nr_atendimento = nr_atendimento_p 
	and	a.cd_medico_executor = cd_medico_executor_p 
	and 	a.nr_interno_conta = b.nr_interno_conta 
	and 	a.dt_procedimento <= dt_procedimento_p 
	and	(a.nr_cirurgia IS NOT NULL AND a.nr_cirurgia::text <> '');
 
	select 	obter_dias_entre_datas(dt_cirurgia_w,dt_procedimento_p) 
	into STRICT	qt_dias_w 
	;
	 
	if (qt_dias_w <= qt_dias_cirurgia_w) then 
		--O número de dias da última cirurgia desse profissional, é inferior ao número de dias limite para lançamento de honorários 
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(225421);
	end if;
	 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_conv_regra_bloq_honor ( nr_atendimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, cd_medico_executor_p bigint, dt_procedimento_p timestamp, cd_convenio_p bigint) FROM PUBLIC;

