-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_qtd_ocorrencia_req ( nr_seq_requisicao_p bigint, qt_tipo_quantidade_p bigint, ie_tipo_qtde_p text, qt_liberada_p bigint, ie_rotorno_p INOUT text, ds_observacao_p INOUT text) AS $body$
DECLARE


dt_requisicao_w			timestamp;
nr_seq_segurado_w		bigint;
nr_seq_prestador_w		bigint;
dt_liberacao_w			timestamp;
nr_seq_requisicao_w		bigint;
dt_requisicao_ww		timestamp;
nm_medico_solic_w		varchar(255);


BEGIN

ie_rotorno_p	:= pls_obter_se_qtd_ocorr_req(	nr_seq_requisicao_p, qt_tipo_quantidade_p, ie_tipo_qtde_p,
						qt_liberada_p);

if (ie_rotorno_p	= 'N') then
	begin					
		select	dt_requisicao,
			nr_seq_segurado,
			nr_seq_prestador
		into STRICT	dt_requisicao_w,
			nr_seq_segurado_w,
			nr_seq_prestador_w
		from	pls_requisicao
		where	nr_sequencia	= nr_seq_requisicao_p;

		if (ie_tipo_qtde_p	= 'D') then   	
			dt_liberacao_w	:= trunc(dt_requisicao_w - (qt_tipo_quantidade_p - 1));		
		elsif (ie_tipo_qtde_p	= 'M') then
			dt_liberacao_w	:= (add_months(dt_requisicao_w, -qt_tipo_quantidade_p) + 1);
		elsif (ie_tipo_qtde_p	= 'A') then
			dt_liberacao_w	:= (add_months(dt_requisicao_w, -qt_tipo_quantidade_p * 12) + 1); /* Vezes 12 meses ao ano */
		elsif (ie_tipo_qtde_p = 'G') then
			dt_liberacao_w := clock_timestamp();
		end if;

		select 	max(nr_sequencia)
		into STRICT	nr_seq_requisicao_w
		from	pls_requisicao		
		where	ie_estagio		= 2
		and	nr_seq_segurado		= nr_seq_segurado_w
		and	nr_sequencia		<> nr_seq_requisicao_p
		and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_requisicao) 	between dt_liberacao_w and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_requisicao_w);

		select	dt_requisicao,
			substr(obter_nome_pessoa_fisica(cd_medico_solicitante, null),1,255)
		into STRICT	dt_requisicao_ww,
			nm_medico_solic_w
		from	pls_requisicao
		where	nr_sequencia	= nr_seq_requisicao_w;

		ds_observacao_p	:= substr('Requisicao: '||nr_seq_requisicao_w||'. Data:'||PKG_DATE_FORMATERS.TO_VARCHAR(dt_requisicao_ww,'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, WHEB_USUARIO_PCK.get_nm_usuario)||'. Medico solic: '||nm_medico_solic_w,1,400);
	exception
	when others then
		ds_observacao_p	:= '';
	end;
end if;

--commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_qtd_ocorrencia_req ( nr_seq_requisicao_p bigint, qt_tipo_quantidade_p bigint, ie_tipo_qtde_p text, qt_liberada_p bigint, ie_rotorno_p INOUT text, ds_observacao_p INOUT text) FROM PUBLIC;

