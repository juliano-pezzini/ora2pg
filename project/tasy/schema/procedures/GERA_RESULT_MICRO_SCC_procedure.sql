-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gera_result_micro_scc ( nr_seq_interno_p text, cd_microorganismo_p text, cd_medicamento_p text, ie_resultado_p text, ds_obs_microorganismo_p text, ds_resultado_antib_p text ) AS $body$
DECLARE

     nr_prescricao_w           bigint;
     nr_seq_prescr_w           bigint;
     nr_seq_resultado_w        bigint;
     nr_seq_result_item_w      bigint;
     cd_microorganismo_w       bigint;
     cd_medicamento_w          bigint;
     ie_resultado_w            varchar(1);
     ie_status_atend_w         smallint;
     ie_gera_result_presc_w    varchar(1);
     nr_seq_exame_w            exame_laboratorio.nr_seq_exame%TYPE;
     nr_seq_material_w         material_exame_lab.nr_sequencia%TYPE;
     dt_prescricao_w           prescr_medica.dt_prescricao%TYPE;
     dt_nascimento_w           timestamp;
     ie_sexo_w                 varchar(1);
     nr_sequencia_w            exame_lab_result_antib.nr_sequencia%TYPE;
     count_w                   smallint;


BEGIN

if (coalesce(nr_seq_interno_p::text, '') = '') then
  CALL WHEB_MENSAGEM_PCK.exibir_mensagem_abort(277600);
end if;

select  count(1)
into STRICT    count_w
from    prescr_procedimento c
where   c.nr_seq_interno = nr_seq_interno_p;

if (count_w = 0)then
  CALL WHEB_MENSAGEM_PCK.exibir_mensagem_abort(1111467,'NR_SEQ_INTERNO='||nr_seq_interno_p);
end if;

SELECT (nr_prescricao),
        (nr_sequencia)
INTO STRICT    nr_prescricao_w,
        nr_seq_prescr_w
FROM    prescr_procedimento
WHERE   nr_seq_interno = nr_seq_interno_p;

SELECT  MAX(ie_status_atend),
        MAX(nr_seq_exame),
        MAX(b.nr_sequencia)
INTO STRICT    ie_status_atend_w,
        nr_seq_exame_w,
        nr_seq_material_w
FROM    prescr_procedimento   a,
        material_exame_lab    b
WHERE   a.cd_material_exame = b.cd_material_exame
        AND a.nr_prescricao = nr_prescricao_w
        AND a.nr_sequencia = nr_seq_prescr_w;

IF ( ie_status_atend_w <= 35 ) THEN
SELECT  MAX(a.ie_gerar_result_prescr)
INTO STRICT    ie_gera_result_presc_w
FROM    lab_parametro   a,
        prescr_medica   b
WHERE   a.cd_estabelecimento = b.cd_estabelecimento
        AND b.nr_prescricao = nr_prescricao_w;

IF ( ie_gera_result_presc_w = 'N' ) THEN
       CALL gera_exame_result_lab(nr_prescricao_w, nr_seq_prescr_w, 'N', 'N', 'S', 'SCC');
ELSE
SELECT MAX(nr_seq_resultado)
INTO STRICT   nr_seq_resultado_w
FROM   exame_lab_resultado
WHERE  nr_prescricao = nr_prescricao_w;


IF ( ( coalesce(nr_seq_resultado_w::text, '') = '' ) OR ( nr_seq_resultado_w <= 0 ) ) THEN
       CALL gera_exame_result_lab(nr_prescricao_w, nr_seq_prescr_w, 'N', 'N', 'S', 'SCC');
SELECT MAX(nr_seq_resultado)
INTO STRICT   nr_seq_resultado_w
FROM   exame_lab_resultado
WHERE  nr_prescricao = nr_prescricao_w;

END IF;


 SELECT dt_prescricao,
        obter_nascimento_prescricao(nr_prescricao_w),
        obter_sexo_prescricao(nr_prescricao_w)
INTO STRICT    dt_prescricao_w,
        dt_nascimento_w,
        ie_sexo_w
FROM    prescr_medica
WHERE   nr_prescricao = nr_prescricao_w;

CALL gera_resultado_lab(nr_seq_resultado_w, nr_prescricao_w, nr_seq_prescr_w, nr_seq_exame_w, nr_seq_material_w,(dt_prescricao_w - dt_nascimento_w) / 365.25, ie_sexo_w, 'SCC');

END IF;


SELECT  MAX(nr_seq_resultado)
INTO STRICT    nr_seq_resultado_w
FROM    exame_lab_resultado
WHERE   nr_prescricao = nr_prescricao_w;

END IF;

SELECT  MAX(i.nr_sequencia)
INTO STRICT    nr_seq_result_item_w
FROM    exame_lab_result_item   i,
        exame_laboratorio       e
WHERE   i.nr_seq_exame = e.nr_seq_exame
        AND i.nr_seq_resultado = nr_seq_resultado_w
        AND i.nr_seq_prescr = nr_seq_prescr_w
        AND e.ie_formato_resultado IN ('SM','SDM');

SELECT  MAX(cd_microorganismo)
INTO STRICT    cd_microorganismo_w
FROM    cih_microorganismo
WHERE   coalesce(ds_microorganismo_integr, cd_microorganismo) = cd_microorganismo_p;


SELECT  MAX(a.cd_medicamento)
INTO STRICT    cd_medicamento_w
FROM    cih_medicamento       a,
        cih_medicamento_int   b,
        equipamento_lab       c
WHERE   a.cd_medicamento = b.cd_medicamento
        AND b.cd_equipamento = c.cd_equipamento
        AND c.ds_sigla = 'SCC'
        AND b.cd_medicamento_integracao = cd_medicamento_p;


IF ( coalesce(cd_medicamento_w::text, '') = '' ) THEN
SELECT  MAX(cd_medicamento)
INTO STRICT    cd_medicamento_w
FROM    cih_medicamento a
WHERE   coalesce(ds_codigo_integr, cd_medicamento) = cd_medicamento_p;

END IF;


IF (nr_seq_result_item_w IS NOT NULL AND nr_seq_result_item_w::text <> '') AND (cd_microorganismo_w IS NOT NULL AND cd_microorganismo_w::text <> '') AND (cd_medicamento_w IS NOT NULL AND cd_medicamento_w::text <> '') THEN
ie_resultado_w := substr(ie_resultado_p, 1, 1);
SELECT  coalesce(MAX(a.nr_sequencia), 0)
INTO STRICT    nr_sequencia_w
FROM    exame_lab_result_antib a
WHERE   a.nr_seq_resultado = nr_seq_resultado_w
        AND a.nr_seq_result_item = nr_seq_result_item_w
        AND a.cd_microorganismo = cd_microorganismo_w
        AND a.cd_medicamento = cd_medicamento_w;


IF ( nr_sequencia_w > 0 ) THEN
UPDATE exame_lab_result_antib
SET     nr_seq_resultado = nr_seq_resultado_w,
        nr_seq_result_item = nr_seq_result_item_w,
        cd_microorganismo = cd_microorganismo_w,
        cd_medicamento = cd_medicamento_w,
        ie_resultado = ie_resultado_w,
        dt_atualizacao = clock_timestamp(),
        nm_usuario = 'SCC',
        ds_obs_microorganismo = ds_obs_microorganismo_p,
        ds_resultado_antib = ds_resultado_antib_p
 WHERE  nr_sequencia = nr_sequencia_w;
ELSE
INSERT INTO exame_lab_result_antib(
	nr_sequencia,
        nr_seq_resultado,
        nr_seq_result_item,
        cd_microorganismo,
        cd_medicamento,
        ie_resultado,
        dt_atualizacao,
        nm_usuario,
        ds_obs_microorganismo,
        nr_cultura_microorg,
        ds_resultado_antib)
 VALUES ( nextval('exame_lab_result_antib_seq'),
          nr_seq_resultado_w,
          nr_seq_result_item_w,
          cd_microorganismo_w,
          cd_medicamento_w,
          ie_resultado_w,
          clock_timestamp(),
          'SCC',
          ds_obs_microorganismo_p,
          0,
          ds_resultado_antib_p);


END IF;

END IF;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gera_result_micro_scc ( nr_seq_interno_p text, cd_microorganismo_p text, cd_medicamento_p text, ie_resultado_p text, ds_obs_microorganismo_p text, ds_resultado_antib_p text ) FROM PUBLIC;

