-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_ihc_response (nr_seq_claim_p bigint, cd_transaction_p text, cd_status_p text, nr_account_p text, cd_clm_asses_fund_p text, vl_co_pay_p bigint, vl_excess_amt_p bigint, cd_facility_p text, cd_fund_brand_p text, cd_fund_ref_p text, cd_fund_status_p bigint, vl_total_benefit_p bigint, vl_charge_p bigint, nm_usuario_p text) AS $body$
DECLARE


nm_usuario_w 		ihc_response.nm_usuario%type;
nr_sequencia_w 		ihc_response.nr_seq_claim%type;
count_w				integer := 0;


BEGIN
	select	max(nr_sequencia),
			nm_usuario
	into STRICT 	nr_sequencia_w,
			nm_usuario_w
	from	ihc_claim
	where 	cd_transaction = cd_transaction_p
	group by nr_sequencia, nm_usuario;

	select count(1)
	into STRICT count_w
	from ihc_response
	where nr_seq_claim = nr_sequencia_w;

	if (count_w > 0) then
		delete from ihc_service_details
		where nr_seq_service in (SELECT 	a.nr_sequencia
								from 	ihc_service_response a,
										ihc_response b
								where 	b.nr_seq_claim = nr_sequencia_w);

		delete from ihc_service_response
		where nr_seq_response in (	SELECT nr_sequencia
									from ihc_response
									where nr_seq_claim = nr_sequencia_w);

		delete from ihc_response_details
		where nr_seq_response in (	SELECT nr_sequencia
									from ihc_response
									where nr_seq_claim = nr_sequencia_w);

		delete from ihc_response
		where nr_seq_claim = nr_sequencia_w;
	end if;

	insert into ihc_response(nr_sequencia,
							 dt_atualizacao,
							 nm_usuario,
							 dt_atualizacao_nrec,
							 nm_usuario_nrec,
							 nr_seq_claim,
							 cd_transaction,
							 cd_status,
							 nr_account,
							 cd_clm_asses_fund,
							 vl_co_pay,
							 vl_excess_amt,
							 cd_facility,
							 cd_fund_brand,
							 cd_fund_ref,
							 cd_fund_status,
							 vl_total_benefit,
							 vl_charge)
					 values (nextval('ihc_response_seq'),
							clock_timestamp(),
							coalesce(nm_usuario_p, nm_usuario_w),
							clock_timestamp(),
							coalesce(nm_usuario_p, nm_usuario_w),
							coalesce(nr_sequencia_w, nr_seq_claim_p),
							cd_transaction_p,
							cd_status_p,
							nr_account_p,
							cd_clm_asses_fund_p,
							vl_co_pay_p,
							vl_excess_amt_p,
							cd_facility_p,
							cd_fund_brand_p,
							cd_fund_ref_p,
							cd_fund_status_p,
							vl_total_benefit_p,
							vl_charge_p);
	commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_ihc_response (nr_seq_claim_p bigint, cd_transaction_p text, cd_status_p text, nr_account_p text, cd_clm_asses_fund_p text, vl_co_pay_p bigint, vl_excess_amt_p bigint, cd_facility_p text, cd_fund_brand_p text, cd_fund_ref_p text, cd_fund_status_p bigint, vl_total_benefit_p bigint, vl_charge_p bigint, nm_usuario_p text) FROM PUBLIC;

