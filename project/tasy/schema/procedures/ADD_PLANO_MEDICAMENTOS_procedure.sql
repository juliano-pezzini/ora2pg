-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE add_plano_medicamentos ( cd_material_p bigint , ds_dose_diferenciada_p text, cd_pessoa_fisica_p text, qt_dose_manha_p bigint, qt_dose_almoco_p bigint, qt_dose_tarde_p bigint, qt_dose_noite_p bigint, cd_unidade_medida_p text ) AS $body$
DECLARE


nr_sequencia_w      	bigint;
nm_usuario_w       		varchar(100);
nr_seq_versao_w     	bigint;
cd_pessoa_usuario_w 	varchar(10);

BEGIN

if (cd_material_p > 0) then
    nm_usuario_w        := wheb_usuario_pck.get_nm_usuario;
    cd_pessoa_usuario_w := obter_pf_usuario(wheb_usuario_pck.get_nm_usuario,'C');

    select  	max(nr_sequencia)
    into STRICT    	nr_seq_versao_w
    from    	plano_versao
    where  cd_pessoa_fisica = cd_pessoa_fisica_p
    and     coalesce(dt_liberacao::text, '') = '';

    if (coalesce(nr_seq_versao_w::text, '') = '')then
        nr_seq_versao_w := gerar_plano_muster(obter_nome_pf(cd_pessoa_usuario_w), cd_pessoa_fisica_p, clock_timestamp(), nr_seq_versao_w);
    end if;

    select  	nextval('plano_versao_medic_seq')
    into STRICT    	nr_sequencia_w
;

    insert into plano_versao_medic(    
                nr_sequencia,
                dt_atualizacao,
                nm_usuario,
                dt_atualizacao_nrec,
                nm_usuario_nrec,
                dt_registro,
                cd_pessoa_fisica,
                cd_material,
                cd_unidade_medida,
                nr_seq_versao,
                ds_dose_diferenciada,
                cd_profissional,
                qt_dose_manha,  
                qt_dose_almoco,
                qt_dose_tarde,  
                qt_dose_noite,
                ie_tipo_medicamento,
                ds_princ_ativo,
                ds_potencia,
                ie_exibir_plano_medic)
    values ( 
                nr_sequencia_w, 
                clock_timestamp(),
                nm_usuario_w,   
                clock_timestamp(),
                nm_usuario_w,
                clock_timestamp(),
                cd_pessoa_fisica_p,
                cd_material_p,
                cd_unidade_medida_p,
                nr_seq_versao_w,
                ds_dose_diferenciada_p,
                cd_pessoa_usuario_w,
                qt_dose_manha_p,    
                qt_dose_almoco_p,
                qt_dose_tarde_p,    
                qt_dose_noite_p,
                'S',
                obter_princ_ativo_plano(cd_material_p,'P'),
                obter_princ_ativo_plano(cd_material_p,'C'),
                'N');

    commit;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE add_plano_medicamentos ( cd_material_p bigint , ds_dose_diferenciada_p text, cd_pessoa_fisica_p text, qt_dose_manha_p bigint, qt_dose_almoco_p bigint, qt_dose_tarde_p bigint, qt_dose_noite_p bigint, cd_unidade_medida_p text ) FROM PUBLIC;

