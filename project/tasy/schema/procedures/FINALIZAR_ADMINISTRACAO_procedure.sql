-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE finalizar_administracao ( ie_opcao_p text, nr_seq_atendimento_p bigint, ie_evento_p text, nr_atendimento_p bigint, dt_referencia_p timestamp, dt_real_p timestamp, nr_prescricao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ds_alerta_p INOUT text, ds_pergunta_p INOUT text) AS $body$
DECLARE

 
/*	ie_opcao_p 
	F - finalizar 
	D - desfazer 
	*/
 
 
ie_adm_medic_termino_w	varchar(1);
ie_executa_agenda_w	varchar(1);
ie_executa_proced_prescr_w	varchar(1);
ie_motivo_altera_w		varchar(1);
ie_desfazer_adm_ordem_w	varchar(1);
nr_motivo_alta_padrao_w	bigint;
nr_seq_agenda_quimio_w	bigint;
ie_gerar_alta_w		varchar(1);
ie_tipo_atendimento_w	smallint;
ie_param697_w		varchar(1);


BEGIN 
 
if (ie_opcao_p = 'F') then 
	begin	 
 
	select	max(ds_mensagem) 
	into STRICT	ds_alerta_p 
	from	regra_alerta_pac_atend 
	where	ie_evento = ie_evento_p;
 
	select	CASE WHEN count(*)=0 THEN  'N'   ELSE 'S' END  
	into STRICT	ie_motivo_altera_w 
	from	atendimento_paciente 
	where	(cd_motivo_alta IS NOT NULL AND cd_motivo_alta::text <> '') 
	and	nr_atendimento	= nr_atendimento_p;
	 
	select	max(obter_tipo_atendimento(nr_atendimento_p)) 
	into STRICT	ie_tipo_atendimento_w 
	;
 
	/* Quimioterapia - Parâmetro [115] - Motivo de alta padrão ao finalizar administração do medicamento */
 
	nr_motivo_alta_padrao_w := obter_param_usuario(3130, 115, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, nr_motivo_alta_padrao_w);
	/* Quimioterapia - Parâmetro[223] - Ao gerar alta consistir se tipo de atendimento é ambulatorial */
 
	ie_gerar_alta_w := obter_param_usuario(3130, 223, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_gerar_alta_w);
	ie_param697_w := obter_param_usuario(1113, 697, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_param697_w);
	 
	if (coalesce(nr_motivo_alta_padrao_w, 0) > 0) and (ie_motivo_altera_w = 'N') and 
		((ie_gerar_alta_w = 'N') or (ie_tipo_atendimento_w = 8))then 
		ds_pergunta_p	:= substr(obter_texto_tasy(59917, wheb_usuario_pck.get_nr_seq_idioma),1,255);
	end if;
 
	/* Quimioterapia - Parâmetro [132] - Ao utilizar a opção "Término administração", caso o medicamento não esteja administrado, administrar o mesmo */
 
	ie_adm_medic_termino_w := obter_param_usuario(3130, 132, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_adm_medic_termino_w);
 
	if (ie_adm_medic_termino_w = 'S') then 
		CALL administrar_medic_quimio(nr_seq_atendimento_p, nm_usuario_p, cd_estabelecimento_p);
	end if;
 
	/* Quimioterapia - Parâmetro [134] - Ao realizar término de administração executar os procedimentos prescritos */
 
	ie_executa_proced_prescr_w := obter_param_usuario(3130, 134, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_executa_proced_prescr_w);
 
	if (ie_executa_proced_prescr_w = 'S') then 
		CALL gerar_proced_prescrito_qt(nr_prescricao_p, nm_usuario_p);
	end if;
 
	CALL gerar_data_admin_dose(dt_referencia_p, dt_real_p, nr_prescricao_p, nm_usuario_p);
	end;
	 
	select	max(nr_sequencia) 
	into STRICT	nr_seq_agenda_quimio_w 
	from	agenda_quimio 
	where	nr_seq_atendimento = nr_seq_atendimento_p;
	 
	if (nr_seq_agenda_quimio_w > 0) then 
		begin 
		/* Agenda de Quimioterapia - Parâmetro [45] - Ao finalizar o dia de tratamento na função Quimioterapia, alterar o status do agendamento para executado */
 
		ie_executa_agenda_w := obter_param_usuario(865, 45, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_executa_agenda_w);
 
		if (ie_executa_agenda_w = 'S') then 
		begin 
			CALL Qt_Alterar_Status_Agenda(nr_seq_agenda_quimio_w, 'E', nm_usuario_p, 'N', null, '', cd_estabelecimento_p, null);
		end;
		end if;
	 
		end;
	end if;
	 
	CALL atualiza_data_campo_pac_atend('DT_FIM_ADM', nr_seq_atendimento_p, 'A', nm_usuario_p);
 
	if (ie_param697_w = 'S') then 
		CALL adm_medic_adep_quimio(nr_seq_atendimento_p, nr_atendimento_p, dt_referencia_p, nr_prescricao_p, nm_usuario_p, cd_estabelecimento_p, 'A', null);
	end if;
	 
elsif (ie_opcao_p = 'D') then 
	begin 
	CALL atualiza_data_campo_pac_atend('DT_FIM_ADM', nr_seq_atendimento_p, 'D', nm_usuario_p);
 
	/* Quimioterapia - Parâmetro [46] - Ao desfazer administração do item, desfazer administração das ordens */
 
	ie_desfazer_adm_ordem_w := obter_param_usuario(3130, 46, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_desfazer_adm_ordem_w);
	ie_param697_w := obter_param_usuario(1113, 697, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_param697_w);
 
	if (ie_desfazer_adm_ordem_w = 'S') then 
		CALL desfazer_data_admin_dose(dt_referencia_p, dt_real_p, nr_prescricao_p, nm_usuario_p);
		if (ie_param697_w = 'S') then 
			CALL adm_medic_adep_quimio(nr_seq_atendimento_p, nr_atendimento_p, dt_referencia_p, nr_prescricao_p, nm_usuario_p, cd_estabelecimento_p, 'R', null);
		end if;
		 
	end if;
 
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE finalizar_administracao ( ie_opcao_p text, nr_seq_atendimento_p bigint, ie_evento_p text, nr_atendimento_p bigint, dt_referencia_p timestamp, dt_real_p timestamp, nr_prescricao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ds_alerta_p INOUT text, ds_pergunta_p INOUT text) FROM PUBLIC;

