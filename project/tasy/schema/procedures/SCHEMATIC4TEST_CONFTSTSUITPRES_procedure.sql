-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE schematic4test_conftstsuitpres () AS $body$
DECLARE

QTD_W bigint;
QTD_W2 bigint;
NR_SEQUENCIA_W bigint;
NR_SEQ_PRESET_W bigint;
NR_SEQ_URL_W bigint;
NR_SEQ_BROWSER_W bigint;
NR_SEQ_SERVICE_W bigint;
NR_SEQ_ROBOT_W bigint;
NR_SEQ_GRID_W bigint;


BEGIN
      --procedure that set profile machines to suite
      SELECT COUNT(suite.NR_SEQUENCIA) NR_SEQUENCIA
          INTO STRICT QTD_W
      FROM SCHEM_TEST_SUITE suite
      WHERE suite.IE_JOBS = '3';
        
      IF (QTD_W <> 0) THEN
        SELECT suite.NR_SEQUENCIA NR_SEQUENCIA, suite.NR_SEQ_PRESET  NR_SEQ_PRESET 
            INTO STRICT NR_SEQUENCIA_W, NR_SEQ_PRESET_W
        FROM SCHEM_TEST_SUITE suite 
		WHERE suite.IE_JOBS = '3'  LIMIT 1;
				
        SELECT COUNT(DISTINCT test1.NR_SEQ_ROBOT) QTD
         INTO STRICT QTD_W2
        FROM SCHEM_TEST_TEST test1
        WHERE test1.NR_SEQ_SUITE = NR_SEQUENCIA_W;

        IF (QTD_W2 = 1) THEN         
			SELECT preset.NR_SEQ_URL NR_SEQ_URL, preset.NR_SEQ_BROWSER NR_SEQ_BROWSER, preset.NR_SEQ_SERVICE NR_SEQ_SERVICE, preset.NR_SEQ_ROBOT NR_SEQ_ROBOT, preset.NR_SEQ_GRID NR_SEQ_GRID
				INTO STRICT NR_SEQ_URL_W, NR_SEQ_BROWSER_W, NR_SEQ_SERVICE_W, NR_SEQ_ROBOT_W, NR_SEQ_GRID_W
			FROM SCHEM_TEST_PRESET preset WHERE preset.NR_SEQUENCIA = NR_SEQ_PRESET_W;

			UPDATE SCHEM_TEST_SUITE SET IE_JOBS = '0', DT_ATUALIZACAO = clock_timestamp() WHERE NR_SEQUENCIA = NR_SEQUENCIA_W;
			UPDATE SCHEM_TEST_TEST SET NR_SEQ_GRID = NR_SEQ_GRID_W, NR_SEQ_ROBOT = NR_SEQ_ROBOT_W, DT_ATUALIZACAO = clock_timestamp() WHERE NR_SEQ_SUITE = NR_SEQUENCIA_W;
			UPDATE SCHEM_TEST_PRESET SET DT_LAST = clock_timestamp() WHERE NR_SEQUENCIA = NR_SEQ_PRESET_W;
			COMMIT;
      END IF;
    END IF;
  EXCEPTION
  WHEN no_data_found THEN
    RAISE NOTICE 'Erro: Data not found';
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE schematic4test_conftstsuitpres () FROM PUBLIC;

