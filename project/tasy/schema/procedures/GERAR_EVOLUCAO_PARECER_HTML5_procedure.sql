-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_evolucao_parecer_html5 ( nr_parecer_p parecer_medico_req.nr_parecer%type, nr_sequencia_p parecer_medico.nr_sequencia%type, ie_tipo_evolucao_p evolucao_paciente.ie_tipo_evolucao%type, nm_usuario_p evolucao_paciente.nm_usuario%type, ds_evolucao_p evolucao_paciente.ds_evolucao%type, cd_evolucao_p INOUT evolucao_paciente.cd_evolucao%type) AS $body$
DECLARE


cd_evolucao_w                   evolucao_paciente.cd_evolucao%type;
ie_relev_resumo_alta_w          evolucao_paciente.ie_relev_resumo_alta%type;
cd_pessoa_fisica_w              evolucao_paciente.cd_pessoa_fisica%type;
nr_atendimento_w                evolucao_paciente.nr_atendimento%type;
cd_medico_w                     evolucao_paciente.cd_medico%type;
cd_setor_atendimento_w          evolucao_paciente.cd_setor_atendimento%type;
cd_especialidade_medico_w       evolucao_paciente.cd_especialidade_medico%type;

ie_evolucao_clinica_w constant  evolucao_paciente.ie_evolucao_clinica%type  :=  'R';
ie_recem_nato_w       constant  evolucao_paciente.ie_recem_nato%type        :=  'N';
ie_situacao_w         constant  evolucao_paciente.ie_situacao%type          :=  'A';
ie_tipo_item_w        constant  evolucao_paciente_vinculo.ie_tipo_item%type :=  'RP';


BEGIN

select	nextval('evolucao_paciente_seq')
into STRICT    cd_evolucao_w
;

select	coalesce(max(ie_relev_resumo_alta),'N')
into STRICT	ie_relev_resumo_alta_w
from	tipo_evolucao
where	cd_tipo_evolucao = 'R';


select
        max(pmr.cd_pessoa_fisica),
        max(pmr.nr_atendimento),
        max(pm.cd_medico),
        max(obter_setor_atendimento(pmr.nr_atendimento)),
        max(CASE WHEN obter_se_especialidade_medico(pm.cd_medico,pmr.cd_especialidade_dest)='S' THEN pmr.cd_especialidade_dest  ELSE null END )
into STRICT    cd_pessoa_fisica_w,
        nr_atendimento_w,
        cd_medico_w,
        cd_setor_atendimento_w,
        cd_especialidade_medico_w
from    parecer_medico pm,
        parecer_medico_req pmr
where  	pm.nr_parecer = pmr.nr_parecer
and    	pmr.nr_parecer = nr_parecer_p
and     pm.nr_sequencia = nr_sequencia_p;


insert into evolucao_paciente(
        cd_evolucao,
        dt_evolucao,
        ie_tipo_evolucao,
        cd_pessoa_fisica,
        dt_atualizacao,
        nm_usuario,
        nr_atendimento,
        ds_evolucao,
        cd_medico,
        dt_liberacao,
        ie_evolucao_clinica,
        cd_setor_atendimento,
        cd_especialidade,
        cd_especialidade_medico,
        cd_medico_parecer,
        ie_recem_nato,
        ie_situacao,
        ie_relev_resumo_alta)
values (
        cd_evolucao_w,
        clock_timestamp(),
        ie_tipo_evolucao_p,
        cd_pessoa_fisica_w,
        clock_timestamp(),
        nm_usuario_p,
        nr_atendimento_w,
        ds_evolucao_p,
        cd_medico_w,
        null,
        ie_evolucao_clinica_w,
        cd_setor_atendimento_w,
        null,
        cd_especialidade_medico_w,
        null,
        ie_recem_nato_w,
        ie_situacao_w,
        ie_relev_resumo_alta_w);

commit;

CALL liberar_evolucao(       cd_evolucao_p   =>      cd_evolucao_w,
                        nm_usuario_p    =>      nm_usuario_p);

CALL gerar_evolucao_vinculo( nr_seq_registro_p       =>      nr_parecer_p,
                        cd_evolucao_p           =>      cd_evolucao_w,
                        ie_tipo_item_p          =>      ie_tipo_item_w,
                        nr_seq_registro_2_p     =>      nr_sequencia_p);

commit;

cd_evolucao_p := cd_evolucao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_evolucao_parecer_html5 ( nr_parecer_p parecer_medico_req.nr_parecer%type, nr_sequencia_p parecer_medico.nr_sequencia%type, ie_tipo_evolucao_p evolucao_paciente.ie_tipo_evolucao%type, nm_usuario_p evolucao_paciente.nm_usuario%type, ds_evolucao_p evolucao_paciente.ds_evolucao%type, cd_evolucao_p INOUT evolucao_paciente.cd_evolucao%type) FROM PUBLIC;

