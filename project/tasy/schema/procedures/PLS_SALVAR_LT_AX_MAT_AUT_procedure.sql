-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_salvar_lt_ax_mat_aut ( nr_seq_lote_anexo_guia_p bigint, cd_material_p text, ds_material_p text, cd_tipo_tabela_imp_p text, ie_opcao_fabricante_p text, qt_solicitado_p bigint, vl_unit_material_solic_p bigint, nr_registro_anvisa_p text, cd_ref_fabricante_imp_p text, cd_aut_funcionamento_p text, ds_observacao_p text, dt_prevista_p timestamp, ie_via_administracao_p text, ie_frequencia_dose_p bigint, qt_autorizado_p bigint, vl_unit_material_aut_p bigint, nm_usuario_p text, qt_unidade_medida_p text) AS $body$
DECLARE



/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Salvar os materiais  nas guias do lote de anexo.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [  ] Tasy (Delphi/Java) [  x] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_material_w		pls_material.nr_sequencia%type;
nr_seq_plano_mat_w		pls_guia_plano_mat.nr_sequencia%type;
nr_seq_req_mat_w		pls_requisicao_mat.nr_sequencia%type;


BEGIN
select	max(nr_sequencia)
into STRICT	nr_seq_material_w
from	pls_material
where	cd_material_ops = cd_material_p;

--Obtem a sequencia da tabela de material da guia
select	max(a.nr_sequencia)
into STRICT	nr_seq_plano_mat_w
from	pls_guia_plano_mat a,
	pls_lote_anexo_guias_imp b
where	a.nr_seq_guia 		= b.nr_seq_guia
and	b.nr_sequencia 		= nr_seq_lote_anexo_guia_p
and	a.nr_seq_material	= nr_seq_material_w;


--Obtem a sequencia da tabela de material da requisição
select	max(a.nr_sequencia)
into STRICT	nr_seq_req_mat_w
from	pls_requisicao_mat a,
	pls_lote_anexo_guias_imp b
where	a.nr_seq_requisicao	= b.nr_seq_requisicao
and	b.nr_sequencia 		= nr_seq_lote_anexo_guia_p
and	a.nr_seq_material	= nr_seq_material_w
and	(b.nr_seq_requisicao IS NOT NULL AND b.nr_seq_requisicao::text <> '');

insert into pls_lote_anexo_mat_imp(
	nr_sequencia, nr_seq_lote_guia_imp, dt_atualizacao,
	nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
	cd_material, ds_material, cd_tipo_tabela_imp,
	ie_opcao_fabricante, qt_solicitado, vl_unit_material_solic,
	nr_registro_anvisa, cd_ref_fabricante_imp, cd_aut_funcionamento,
	ds_observacao, dt_prevista, ie_via_administracao,
	ie_frequencia_dose, qt_autorizado, vl_unit_material_aut,
	nr_seq_material, nr_seq_plano_mat, nr_seq_req_mat,
	qt_unidade_medida, qt_dosagem_total	)
values (nextval('pls_lote_anexo_mat_imp_seq'), nr_seq_lote_anexo_guia_p, clock_timestamp(),
	nm_usuario_p, clock_timestamp(), nm_usuario_p,
	cd_material_p, ds_material_p, cd_tipo_tabela_imp_p,
	ie_opcao_fabricante_p, qt_solicitado_p, vl_unit_material_solic_p,
	nr_registro_anvisa_p, cd_ref_fabricante_imp_p, cd_aut_funcionamento_p,
	ds_observacao_p, dt_prevista_p, ie_via_administracao_p,
	ie_frequencia_dose_p , qt_autorizado_p, coalesce(vl_unit_material_aut_p,vl_unit_material_solic_p),
	nr_seq_material_w, nr_seq_plano_mat_w, nr_seq_req_mat_w,
	qt_unidade_medida_p, qt_solicitado_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_salvar_lt_ax_mat_aut ( nr_seq_lote_anexo_guia_p bigint, cd_material_p text, ds_material_p text, cd_tipo_tabela_imp_p text, ie_opcao_fabricante_p text, qt_solicitado_p bigint, vl_unit_material_solic_p bigint, nr_registro_anvisa_p text, cd_ref_fabricante_imp_p text, cd_aut_funcionamento_p text, ds_observacao_p text, dt_prevista_p timestamp, ie_via_administracao_p text, ie_frequencia_dose_p bigint, qt_autorizado_p bigint, vl_unit_material_aut_p bigint, nm_usuario_p text, qt_unidade_medida_p text) FROM PUBLIC;

