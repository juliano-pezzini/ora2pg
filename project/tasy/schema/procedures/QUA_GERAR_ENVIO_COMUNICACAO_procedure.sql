-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qua_gerar_envio_comunicacao ( nr_sequencia_p bigint, ds_valor_p text, nm_usuario_p text, ie_evento_p text, cd_estabelecimento_p bigint, cd_setor_adicional_p bigint, nr_seq_motivo_cancel_p bigint, ie_usuarios_perfil_p text) AS $body$
DECLARE


qt_existe_w				bigint;
nr_seq_classif_w				comunic_interna_classif.nr_sequencia%type;
nr_seq_regra_w				bigint;
ds_titulo_w				varchar(80);
ds_comunicacao_w				varchar(2000);
ie_usuario_w				varchar(2);
nm_usuario_w				varchar(2000);
ds_usuario_destino_w			varchar(2000);
ds_comunic_w				varchar(32000);
ds_comunic_email_w			varchar(32000);
cd_documento_w				varchar(20);
nm_documento_w				varchar(255);
nm_resp_treinamento_w			varchar(255);
ds_arquivo_w				varchar(255);
nr_sequencia_w				bigint;
nm_usuario_elaboracao_w			varchar(60);
nm_usuario_validacao_w			varchar(60);
nm_usuario_valid_pasta_valid_w		varchar(60);
nm_usuario_valid_revisao_w			varchar(60);
nm_usuario_aprov_revisao_w			varchar(60);
nm_usuario_aprov_w			varchar(60);
nm_usuario_revisao_w			varchar(60);
nm_resp_setor_w				varchar(40);
ds_nao_conformidade_w			varchar(4000);
vl_parametro_w				varchar(255);
nm_resp_receptor_w			varchar(40);
nm_pessoa_eficacia_w			varchar(40);
cd_setor_eficacia_w			bigint;
nm_pessoa_resp_setor_w			varchar(40);
cd_setor_adicional_w			varchar(2000);
tam_lista_w				bigint;
ie_pos_virgula_w				smallint;
lista_usuario_w				varchar(2000);
nm_pf_resp_ocorrencia_w			varchar(40);
nm_pf_abertura_w				varchar(40);
nm_pf_resp_setor_abertura_w			varchar(40);
ds_motivo_cancel_w			varchar(80);
nm_usuario_exec_w			varchar(15);
ds_dano_breve_w				varchar(80);
dt_conclusao_desejada_w			timestamp;
nr_seq_ordem_w				bigint;
ds_comunic_acao_w			varchar(2000);
nm_usuarios_executores_w			varchar(255);
nr_seq_grupo_usuario_w			bigint;
nm_usuario_destino_w			varchar(15);
ds_grupo_w				varchar(255);
ds_tipo_nc_w				varchar(255);
cd_perfil_w				integer;
ds_perfil_adic_w				varchar(4000);
nm_usuario_treinamento_w			varchar(15);
ie_usuarios_perfil_w				varchar(01);
nm_usuario_lib_w				varchar(15);
nm_usuario_particip_w			varchar(15);
nm_usuario_pessoa_w			varchar(40);
nr_seq_ordem_serv_w			bigint;
cd_setor_atendimento_w			integer;
nm_pessoa_validacao_w			varchar(120);
nm_pessoa_validacao_todos_w 		varchar(2000);
nm_pessoa_valid_pasta_valid_w 		varchar(120);
nm_pessoa_aprov_w			varchar(120);
nm_pessoa_revisao_w			varchar(120);
nm_pessoa_valid_revisao_w			varchar(120);
nm_pessoa_aprov_revisao_w			varchar(120);
dt_revisao_w				timestamp;
ds_observacao_w				varchar(2000);
ds_treinamento_w				varchar(255);
dt_prevista_w				timestamp;
qt_tempo_previsto_w			integer;
ds_setor_treinamento_w			varchar(255);
ds_obs_treinamento_w			varchar(2000);
nm_usuario_setor_w			varchar(15);
ie_comunic_interna_w			varchar(1);
ie_email_w				varchar(1);
ds_email_usuario_w				varchar(255);
ds_lista_email_usuario_w			varchar(2000);
qt_tamanho_fonte_w			integer;
ds_fonte_padrao_w				varchar(255);
dt_esperada_w				timestamp;
ds_estabelecimento_w			varchar(80);
ds_historico_nc_w				varchar(4000);
ds_historico_doc_w				varchar(32000);
ds_ultimo_historico_w			varchar(4000);
nr_seq_historico_os_w			bigint;
nm_pf_referencia_w			varchar(40);

ds_par_rnc_w				varchar(255);
ds_par_rnc_evento_w			varchar(255);
nr_seq_evento_w				bigint;
ds_email_origem_w				varchar(255);
nm_usuario_origem_w			varchar(15);
nm_usuario_original_w			varchar(15);
nm_usuario_anonimo_w           		comunic_interna.nm_usuario%TYPE;
nm_usuario_nao_conformidade_w		comunic_interna.nm_usuario%TYPE;
nm_usuario_anonimo_evt_pac_w        	comunic_interna.nm_usuario%TYPE;
nm_usuario_evt_pac_w		        comunic_interna.nm_usuario%TYPE;
nm_usuario_envio_w			varchar(15);
nr_seq_rtf_srtring_w				bigint;
ie_comunic_geral_w			varchar(15);
nr_seq_documento_w			bigint;
nm_usuario_grupo_w			varchar(15);
nm_usuario_pf_aprov_w			varchar(15);
nm_usuario_cargo_aprov_w			varchar(15);
nm_resp_abertura_w			varchar(60);
ds_setor_abertura_w			varchar(100);
nm_resp_setor_abertura_w			varchar(60);
nm_resp_analise_eficacia_w			varchar(60);
dt_aprovacao_w				timestamp;
dt_validacao_w				timestamp;
dt_elaboracao_w				timestamp;
ds_tipo_documento_w			varchar(60);
qt_dias_revisao_w				integer;
ds_status_w				varchar(255);
ds_lib_arq_w				varchar(255);
ds_liberacao_arquivo_w			varchar(2000);
ds_situacao_w				varchar(100);
nr_seq_revisao_doc_w			bigint;
nr_atendimento_w				bigint;
ds_evento_w				varchar(255);
ds_evento_paciente_w			varchar(4000);
ds_classif_evento_w			varchar(255);
ds_status_evento_w			varchar(255);
nm_paciente_w				varchar(255);
nm_setor_receptor_w			varchar(100);
nr_seq_classif_ci_w				comunic_interna_classif.nr_sequencia%type;
nr_seq_classif_padrao_w			comunic_interna_classif.nr_sequencia%type;
cd_setor_aprov_w				qua_doc_aprov.cd_setor_atendimento%type;
ds_comunic_log_w		varchar(255);			

c01 CURSOR FOR
	SELECT	nr_sequencia,
		ds_titulo,
		ds_comunicacao,
		ie_comunicacao_interna,
		ie_email,
		ds_email_origem,
		nm_usuario_origem,
		ie_comunic_geral,
		coalesce(nr_seq_classif_ci,0)
	from	qua_regra_envio_comunic
	where	ie_evento = ie_evento_p
	and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;

c02 CURSOR FOR	
	SELECT	ie_usuario,
		ds_usuario_destino
	from	qua_usuarios_comunicacao
	where	nr_seq_regra = nr_seq_regra_w
	
union

	SELECT	'X',
		''
	
	where	coalesce(ie_comunic_geral_w,'N') = 'S';

c03 CURSOR FOR
	SELECT	substr(obter_usuario_pf_ci(c.cd_pessoa_resp),1,40)
	from	setor_atendimento c,
		qua_nao_conform_setor b,
		qua_nao_conformidade a
	where	a.nr_sequencia = b.nr_seq_nao_conform
	and	c.cd_setor_atendimento = b.cd_setor_atendimento
	and	a.nr_sequencia = nr_sequencia_p;

c04 CURSOR FOR
	SELECT	a.nm_usuario_exec
	from	man_ordem_servico_exec a,
		man_ordem_servico b
	where	a.nr_seq_ordem = b.nr_sequencia
	and	b.ie_status_ordem <> '3'
	and	((b.nr_sequencia = ds_valor_p and ie_evento_p('7','20'))
		or (b.nr_seq_nao_conform = nr_sequencia_p and ie_evento_p <> '7'));

c05 CURSOR FOR
	SELECT	nr_sequencia,
		ds_dano_breve,
		dt_conclusao_desejada
	from	man_ordem_servico
	where	ie_status_ordem <> '3'
	and	((nr_sequencia = ds_valor_p and ie_evento_p('7','20'))
		or (nr_seq_nao_conform = nr_sequencia_p and ie_evento_p <> '7'))
	order	by nr_sequencia;

c06 CURSOR FOR
	SELECT	distinct nr_seq_grupo_usuario_dest
	from	qua_nao_conform_setor
	where	nr_seq_nao_conform = nr_sequencia_p
	and	(nr_seq_grupo_usuario_dest IS NOT NULL AND nr_seq_grupo_usuario_dest::text <> '');

c07 CURSOR FOR
	SELECT	distinct
		cd_perfil,
		nm_usuario_lib,
		cd_setor_atendimento
	from	qua_doc_lib a
	where	a.nr_seq_doc = nr_sequencia_p;


c08 CURSOR FOR
	SELECT	distinct
		substr(obter_usuario_pf_ci(cd_pessoa_resp),1,15)
	from	qua_doc_trein_resp
	where	nr_seq_treinamento = nr_sequencia_p;
	
c09 CURSOR FOR
	SELECT	distinct
		substr(obter_usuario_pf_ci(cd_pessoa_fisica),1,15)
	from	qua_doc_trein_pessoa
	where	nr_seq_treinamento = nr_sequencia_p
	and	(cd_pessoa_fisica IS NOT NULL AND cd_pessoa_fisica::text <> '')
	and	substr(obter_usuario_pf_ci(cd_pessoa_fisica),1,15) is not null;
	
c10 CURSOR FOR
	SELECT	nm_usuario_exec
	from	man_ordem_servico_exec
	where	nr_seq_ordem = nr_seq_ordem_serv_w;
	
C11 CURSOR FOR
	SELECT	substr(obter_usuario_pf_ci(cd_participante),1,15)
	from	qua_doc_participante
	where	nr_seq_doc = nr_sequencia_p;

c12 CURSOR FOR
	SELECT	substr(obter_usuario_pf_ci(c.cd_pessoa_resp),1,40)
	from	setor_atendimento c,
		qua_doc_setor_adic a,
		qua_documento b
	where	c.cd_setor_atendimento = a.cd_setor_atendimento
	and	a.nr_seq_doc = b.nr_sequencia
	and	b.nr_sequencia = nr_sequencia_p;

C13 CURSOR FOR
	SELECT	distinct a.nm_usuario
	from	usuario a,
		setor_atendimento b,
		qua_doc_setor_adic c
	where	b.cd_setor_atendimento = c.cd_setor_atendimento
	and	substr(obter_se_setor_usuario(c.cd_setor_atendimento,a.nm_usuario),1,1) = 'S'
	and	c.nr_seq_doc  = nr_sequencia_p
	and	a.ie_situacao = 'A';
	
C14 CURSOR FOR
	SELECT	a.nm_usuario_exec
	from	man_ordem_servico_exec a,
		man_ordem_servico b
	where	a.nr_seq_ordem = b.nr_sequencia
	and	b.ie_status_ordem = 3
	and	((b.nr_sequencia = ds_valor_p and ie_evento_p('7','20','37'))
		or (b.nr_seq_nao_conform = nr_sequencia_p and ie_evento_p <> '7'));
	
C15 CURSOR FOR
	SELECT	substr(obter_usuario_pf_ci(cd_pessoa_validacao),1,60),
		substr(obter_nome_pf(cd_pessoa_validacao),1,120)
	from	qua_doc_validacao
	where	nr_seq_doc =  nr_sequencia_p;

C16 CURSOR FOR
	SELECT	distinct nm_usuario_destino
	from	qua_nao_conform_setor
	where	nr_seq_nao_conform = nr_sequencia_p
	and	(nm_usuario_destino IS NOT NULL AND nm_usuario_destino::text <> '');
	
C17 CURSOR FOR
	SELECT	distinct nm_usuario_grupo
	from	usuario_grupo
	where	ie_situacao = 'A'
	and	nr_seq_grupo = nr_seq_grupo_usuario_w;
	
C18 CURSOR FOR
	SELECT	distinct substr(obter_usuario_pf_ci(cd_pessoa_aprov),1,15)
	from	qua_doc_aprov
	where	substr(obter_usuario_pf_ci(cd_pessoa_aprov),1,15) is not null
	and	nr_seq_doc = nr_sequencia_p;
	
C19 CURSOR FOR
	SELECT	distinct a.nm_usuario
	from	qua_doc_aprov c,
		pessoa_fisica b,
		usuario a
	where	a.cd_pessoa_fisica = b.cd_pessoa_fisica
	and	b.cd_cargo = c.cd_cargo
	and	(c.cd_cargo IS NOT NULL AND c.cd_cargo::text <> '')
	and	c.nr_seq_doc = nr_sequencia_p;

C20 CURSOR FOR
	SELECT	distinct cd_setor_atendimento
	from	qua_doc_aprov
	where	(cd_setor_atendimento IS NOT NULL AND cd_setor_atendimento::text <> '')
	and	nr_seq_doc = nr_sequencia_p;

c21 CURSOR FOR
	SELECT	ds_local
	from	qua_doc_arquivo
	where	nr_seq_doc = nr_seq_documento_w
	and	(ds_local IS NOT NULL AND ds_local::text <> '')
	
union

	SELECT	ds_publico
	from	qua_doc_arquivo
	where	nr_seq_doc = nr_seq_documento_w
	and	(ds_publico IS NOT NULL AND ds_publico::text <> '');

c_mult_aprov CURSOR FOR
	SELECT substr(obter_usuario_pf_ci(a.cd_pessoa_aprov),1,40) nm_usuario_aprov
	from 	qua_doc_revisao_aprovacao a,
		qua_doc_revisao b
	where 	a.nr_seq_revisao = b.nr_sequencia
	and   	a.nr_seq_revisao = nr_seq_revisao_doc_w;
c_mult_aprov_w 		c_mult_aprov%rowtype;
	
c_mult_valid CURSOR FOR
	SELECT	substr(obter_usuario_pessoa(cd_pessoa_validacao), 1, 255) nm_usuario_aval
	from	qua_doc_revisao_validacao
	where	nr_seq_doc_revisao = nr_seq_revisao_doc_w;
	
c_mult_valid_w		c_mult_valid%rowtype;
	

BEGIN

nr_seq_documento_w	:= nr_sequencia_p;
ds_lib_arq_w		:= '';
ds_liberacao_arquivo_w	:= '';

if (ie_evento_p in ('12','33')) then
	begin
	select	nr_seq_documento
	into STRICT	nr_seq_documento_w
	from	qua_doc_treinamento
	where	nr_sequencia = nr_sequencia_p;
	exception
	when others then
		nr_seq_documento_w := null;
	end;
end if;

if (ie_evento_p = '13') then
	begin
	select	nr_sequencia,
		nr_seq_doc
	into STRICT	nr_seq_revisao_doc_w,
		nr_seq_documento_w
	from	qua_doc_revisao
	where	nr_sequencia = nr_sequencia_p;	
	exception
	when others then
		nr_seq_revisao_doc_w	:= 0;
		nr_seq_documento_w	:= null;
	end;
else
	select	coalesce(max(a.nr_sequencia),0)
	into STRICT	nr_seq_revisao_doc_w
	from	qua_doc_revisao a
	where	a.nr_seq_doc = nr_seq_documento_w;
end if;
qt_tamanho_fonte_w := obter_param_usuario(87, 3, obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_p, qt_tamanho_fonte_w);
ds_fonte_padrao_w := obter_param_usuario(87, 15, obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_p, ds_fonte_padrao_w);

ds_par_rnc_w := obter_param_usuario(4000, 12, obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_p, ds_par_rnc_w);
ds_par_rnc_evento_w := obter_param_usuario(4000, 137, obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_p, ds_par_rnc_evento_w);

ie_usuarios_perfil_w := coalesce(ie_usuarios_perfil_p,'N');

select	count(*)
into STRICT	qt_existe_w
from	qua_regra_envio_comunic
where	ie_evento = ie_evento_p
and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;

if (qt_existe_w > 0) then
	begin

	select	obter_classif_comunic('F')
	into STRICT	nr_seq_classif_padrao_w
	;


	open c01;
	loop
	fetch c01 into
		nr_seq_regra_w,
		ds_titulo_w,
		ds_comunicacao_w,
		ie_comunic_interna_w,
		ie_email_w,
		ds_email_origem_w,
		nm_usuario_origem_w,
		ie_comunic_geral_w,
		nr_seq_classif_ci_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

			
		if (coalesce(nr_seq_classif_ci_w,0) <> 0) then
			nr_seq_classif_w	:= nr_seq_classif_ci_w;
		else		
			nr_seq_classif_w	:= nr_seq_classif_padrao_w;
		end if;

		nm_usuario_original_w  := coalesce(nm_usuario_origem_w, nm_usuario_p);
		ds_grupo_w := null;
		open c02;
		loop
		fetch c02 into
			ie_usuario_w,
			ds_usuario_destino_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
		/*	1 - Documento - Comunicar participantes da revisao
			8 - Documento - Comunicar a elaboracao
			9 - Documento - Comunicar a validacao
			10 - Documento - Comunicar a aprovacao
			11 - Documento - Comunicar a revisao 
			13 - Documento - Comunicar a aprovacao da revisao
			14 - Documento - Comunicar quando for inativado
			16 - Documento - Comunicar a validacao da revisao
			19 - Documento - Comunicar disponibilizacao do documento
			22 - Documento - Comunicar exclusao 
			26 - Documento - Comunicar novo historico 
			27 - Documento - Comunicar a aprovacao (pasta aprovadores)  
			28 - Documento - Criacao de documento previsto
			29 - Documento - Comunicar quando vencido	
			31 - Documento - Comunicar reprovacao da revisao
			32 - Documento - Comunicar  quando expirado
			35 - Documento - Comunicar solicitacao de treinamento
			36 - Documento - Comunicar reprovacao	*/
			if (ie_evento_p in ('1','8','9','10','11','13','14','16','19','22','26','27','28','29','31','32','35','36')) then
				begin

				select	a.cd_documento,
					a.nm_documento,
					a.ds_arquivo,
					substr(obter_usuario_pf_ci(coalesce(a.cd_pessoa_elaboracao,'')),1,60),
					substr(obter_usuario_pf_ci(coalesce(a.cd_pessoa_validacao,'')),1,60) nm_usuario_validacao,
					substr(obter_usuario_pf_ci(coalesce(a.cd_pessoa_aprov,'')),1,60) nm_usuario_aprov,
					substr(obter_usuario_pf_ci(coalesce(b.cd_pessoa_revisao,'')),1,60) nm_usuario_revisao,
					substr(obter_nome_pf(a.cd_pessoa_validacao),1,120) nm_pessoa_validacao,
					substr(obter_nome_pf(a.cd_pessoa_aprov),1,120) nm_pessoa_aprov,
					substr(obter_nome_pf(b.cd_pessoa_revisao),1,120) nm_pessoa_revisao,
					b.dt_revisao,
					substr(b.ds_observacao,1,2000),
					substr(obter_usuario_pf_ci(coalesce(b.cd_pessoa_validacao,'')),1,60) nm_usuario_valid_revisao,
					substr(obter_usuario_pf_ci(coalesce(b.cd_pessoa_aprovacao,'')),1,60) nm_usuario_aprov_revisao,
					substr(obter_nome_pf(b.cd_pessoa_validacao),1,120) nm_pessoa_valid_revisao,
					substr(obter_nome_pf(b.cd_pessoa_aprovacao),1,120) nm_pessoa_aprov_revisao,
					a.dt_aprovacao,
					a.dt_validacao,
					a.dt_elaboracao,
					substr(qua_obter_desc_tipo_doc(a.nr_seq_tipo),1,60) ds_tipo_documento,
					a.qt_dias_revisao,
					substr(obter_valor_dominio(1369,a.ie_status),1,255) ds_status,
					substr(CASE WHEN a.ie_situacao='A' THEN wheb_mensagem_pck.get_texto(306062) WHEN a.ie_situacao='I' THEN wheb_mensagem_pck.get_texto(306063) END ,1,100) ds_situacao
				into STRICT	cd_documento_w,
					nm_documento_w,
					ds_arquivo_w,
					nm_usuario_elaboracao_w,
					nm_usuario_validacao_w,
					nm_usuario_aprov_w,
					nm_usuario_revisao_w,
					nm_pessoa_validacao_w,
					nm_pessoa_aprov_w,
					nm_pessoa_revisao_w,
					dt_revisao_w,
					ds_observacao_w,
					nm_usuario_valid_revisao_w,
					nm_usuario_aprov_revisao_w,
					nm_pessoa_valid_revisao_w,
					nm_pessoa_aprov_revisao_w,
					dt_aprovacao_w,
					dt_validacao_w,
					dt_elaboracao_w,
					ds_tipo_documento_w,
					qt_dias_revisao_w,
					ds_status_w,
					ds_situacao_w
				FROM qua_documento a
LEFT OUTER JOIN qua_doc_revisao b ON (a.nr_sequencia = b.nr_seq_doc)
WHERE a.nr_sequencia = nr_seq_documento_w and coalesce(b.nr_sequencia,nr_seq_revisao_doc_w) = nr_seq_revisao_doc_w;
				
				open c21;
				loop
				fetch c21 into
					ds_lib_arq_w;
				EXIT WHEN NOT FOUND; /* apply on c21 */
					begin
					if (coalesce(ds_lib_arq_w,'X') <> 'X') then
						ds_liberacao_arquivo_w := substr(ds_liberacao_arquivo_w || ds_lib_arq_w || '; ',1,2000);
					end if;
					end;
				end loop;
				close c21;
					
				if (ie_usuario_w = 'E') and (nm_usuario_elaboracao_w IS NOT NULL AND nm_usuario_elaboracao_w::text <> '') then
					nm_usuario_w	:= substr(nm_usuario_elaboracao_w || ', ' || nm_usuario_w,1,2000);
				elsif (ie_usuario_w = 'V') then
					open C15;
					loop
					fetch C15 into
						nm_usuario_valid_pasta_valid_w,
						nm_pessoa_valid_pasta_valid_w;
					EXIT WHEN NOT FOUND; /* apply on C15 */
						begin
						if (nm_usuario_valid_pasta_valid_w IS NOT NULL AND nm_usuario_valid_pasta_valid_w::text <> '') and (coalesce(nm_usuario_valid_pasta_valid_w,'X') <> coalesce(nm_usuario_validacao_w,'X'))then
							nm_usuario_w	:= substr(nm_usuario_valid_pasta_valid_w || ', ' || nm_usuario_w,1,2000);
						end if;

						if (nm_pessoa_valid_pasta_valid_w IS NOT NULL AND nm_pessoa_valid_pasta_valid_w::text <> '') and (coalesce(nm_pessoa_valid_pasta_valid_w,'X') <> coalesce(nm_pessoa_validacao_w,'X'))then
							nm_pessoa_validacao_todos_w	:= substr(nm_pessoa_valid_pasta_valid_w || ' - ' || nm_pessoa_validacao_todos_w,1,2000);
						end if;
						end;
					end loop;
					close C15;
						if (nm_usuario_validacao_w IS NOT NULL AND nm_usuario_validacao_w::text <> '') then
							nm_usuario_w	:= substr(nm_usuario_validacao_w || ', ' || nm_usuario_w,1,2000);
						end if;
						if (nm_pessoa_validacao_w IS NOT NULL AND nm_pessoa_validacao_w::text <> '') then
							nm_pessoa_validacao_todos_w	:= substr(nm_pessoa_validacao_w || ' - ' || nm_pessoa_validacao_todos_w,1,2000);
						end if;
				elsif (ie_usuario_w = 'A') and (nm_usuario_aprov_w IS NOT NULL AND nm_usuario_aprov_w::text <> '') then
					nm_usuario_w	:= substr(nm_usuario_aprov_w || ', ' || nm_usuario_w,1,2000);
				
				elsif (ie_usuario_w = 'AR') then
					if (nm_usuario_aprov_revisao_w IS NOT NULL AND nm_usuario_aprov_revisao_w::text <> '') then
						nm_usuario_w	:= substr(nm_usuario_aprov_revisao_w || ', ' || nm_usuario_w,1,2000);
					end if;
					
					open c_mult_aprov;
					loop
					fetch c_mult_aprov into	
						c_mult_aprov_w;
					EXIT WHEN NOT FOUND; /* apply on c_mult_aprov */
						begin
						nm_usuario_w	:= substr(c_mult_aprov_w.nm_usuario_aprov || ', ' || nm_usuario_w,1,2000);
						end;
					end loop;
					close c_mult_aprov;
					
				elsif (ie_usuario_w = 'VR') then
					if (nm_usuario_valid_revisao_w IS NOT NULL AND nm_usuario_valid_revisao_w::text <> '') then
						nm_usuario_w	:= substr(nm_usuario_valid_revisao_w || ', ' || nm_usuario_w,1,2000);
					end if;
					
					open c_mult_valid;
					loop
					fetch c_mult_valid into	
						c_mult_valid_w;
					EXIT WHEN NOT FOUND; /* apply on c_mult_valid */
						begin
						nm_usuario_w	:= substr(c_mult_valid_w.nm_usuario_aval || ', ' || nm_usuario_w,1,2000);
						end;
					end loop;
					close c_mult_valid;
				elsif (ie_usuario_w = 'R') and (nm_usuario_revisao_w IS NOT NULL AND nm_usuario_revisao_w::text <> '') then
					nm_usuario_w	:= substr(nm_usuario_revisao_w || ', ' || nm_usuario_w,1,2000);
				elsif (ie_usuario_w in ('PL','SL'))  then
					ie_usuarios_perfil_w := 'S';
				elsif (ie_usuario_w in ('SE')) then
					begin
					open c12;
					loop
					fetch c12 into
						nm_resp_setor_w;
					EXIT WHEN NOT FOUND; /* apply on c12 */
						nm_usuario_w	:= substr(nm_resp_setor_w || ', ' || nm_usuario_w,1,2000);
					end loop;
					close c12;
					end;
				elsif (ie_usuario_w in ('UE')) then
					begin
					open c13;
					loop
					fetch c13 into
						nm_usuario_setor_w;
					EXIT WHEN NOT FOUND; /* apply on c13 */
						nm_usuario_w	:= substr(nm_usuario_setor_w || ', ' || nm_usuario_w,1,2000);
					end loop;
					close c13;
					end;
				elsif (ie_usuario_w = 'PA') then
					begin
					open C18;
					loop
					fetch C18 into	
						nm_usuario_pf_aprov_w;
					EXIT WHEN NOT FOUND; /* apply on C18 */
						begin
						if (position(nm_usuario_pf_aprov_w in coalesce(nm_usuario_w,'X')) = 0) then
							nm_usuario_w := substr(nm_usuario_pf_aprov_w || ', ' || nm_usuario_w,1,2000);
						end if;
						end;
					end loop;
					close C18;
					end;
				elsif (ie_usuario_w = 'CA') then
					begin					
					open C19;
					loop
					fetch C19 into	
						nm_usuario_cargo_aprov_w;
					EXIT WHEN NOT FOUND; /* apply on C19 */					
						begin
						if (position(nm_usuario_cargo_aprov_w in coalesce(nm_usuario_w,'X')) = 0) then
							nm_usuario_w := substr(nm_usuario_cargo_aprov_w || ', ' || nm_usuario_w,1,2000);
						end if;
						end;
					end loop;
					close C19;
					end;
				elsif (ie_usuario_w = 'SA') then
					begin					
					open C20;
					loop
					fetch C20 into	
						cd_setor_aprov_w;
					EXIT WHEN NOT FOUND; /* apply on C20 */					
						begin
						if (position(cd_setor_aprov_w in coalesce( cd_setor_adicional_w,'X')) = 0) then
							cd_setor_adicional_w := substr(cd_setor_aprov_w || ', ' ||  cd_setor_adicional_w,1,2000);
						end if;
						end;
					end loop;
					close C20;
					end;
				end if;
				
				/* Se enviar para perfil liberado do documento */

				if (ie_usuarios_perfil_w = 'S') then
					begin
					open c07;
					loop
					fetch c07 into
						cd_perfil_w,
						nm_usuario_lib_w,
						cd_setor_atendimento_w;
					EXIT WHEN NOT FOUND; /* apply on c07 */
						begin
						
						if (coalesce(cd_setor_atendimento_w, 0) <> 0) then
							cd_setor_adicional_w	:= substr(cd_setor_atendimento_w || ', ' || cd_setor_adicional_w,1,2000);
						end if;
						if (coalesce(cd_perfil_w,0) <> 0) then
							ds_perfil_adic_w		:= cd_perfil_w || ', ' || ds_perfil_adic_w;
						end if;
						if ((trim(both nm_usuario_lib_w) IS NOT NULL AND (trim(both nm_usuario_lib_w))::text <> '')) and (trim(both nm_usuario_lib_w) <> ',') then
							nm_usuario_w 		:= substr(nm_usuario_lib_w || ', ' || nm_usuario_w,1,2000);
						end if;
						end;
					end loop;
					close c07;
					end;
				end if;				

				if (cd_setor_adicional_p <> 0) then
					cd_setor_adicional_w	:= substr(cd_setor_adicional_p || ', ',1,2000);
				end if;

				if (ie_usuario_w = 'UP') then
					begin
					open C11;
					loop
					fetch C11 into	
						nm_usuario_particip_w;
					EXIT WHEN NOT FOUND; /* apply on C11 */
						begin
						if ((trim(both nm_usuario_particip_w) IS NOT NULL AND (trim(both nm_usuario_particip_w))::text <> '')) then
							nm_usuario_w 	:= substr(nm_usuario_particip_w || ', ' || nm_usuario_w,1,2000);
						end if;
						end;
					end loop;
					close C11;
					end;
				end if;
				
				end;
			end if;
			
			/*	12 - Documento - Comunicar treinamento
				33 - Documento - Comunicar liberacao treinamento		*/
			if (ie_evento_p in ('12','33')) then
				begin
				
								
				open c21;
				loop
				fetch c21 into
					ds_lib_arq_w;
				EXIT WHEN NOT FOUND; /* apply on c21 */
					begin
					if (coalesce(ds_lib_arq_w,'X') <> 'X') then
						ds_liberacao_arquivo_w := substr(ds_liberacao_arquivo_w || ds_lib_arq_w || '; ',1,2000);
					end if;
					end;
				end loop;
				close c21;

				select	max(a.cd_documento),
					max(a.nm_documento),
					max(b.ds_arquivo),
					max(b.ds_treinamento),
					max(b.dt_prevista),
					max(b.qt_tempo_previsto),
					substr(Obter_Descricao_Padrao('QUA_SETOR_TREINAMENTO','DS_SETOR_TREINAMENTO',max(b.nr_seq_setor_treinamento)),1,255),
					max(b.ds_observacao),
					max(obter_select_concatenado_bv('select substr(obter_nome_pf(cd_pessoa_resp),1,255) 
									from  qua_doc_trein_resp 
									where nr_seq_treinamento = :NR_SEQ_TREINAMENTO','nr_seq_treinamento='||nr_sequencia_p,', ')),
					max(substr(qua_obter_desc_tipo_doc(a.nr_seq_tipo),1,60))
				into STRICT	cd_documento_w,
					nm_documento_w,
					ds_arquivo_w,
					ds_treinamento_w,
					dt_prevista_w,
					qt_tempo_previsto_w,
					ds_setor_treinamento_w,
					ds_obs_treinamento_w,
					nm_resp_treinamento_w,
					ds_tipo_documento_w
				from	qua_documento a,
					qua_doc_treinamento b
				where	a.nr_sequencia = b.nr_seq_documento
				and	b.nr_sequencia = nr_sequencia_p;
				
				if (ie_usuario_w = 'RT') then	/*Responsavel treinamento*/
					open C08;
					loop
					fetch C08 into	
						nm_usuario_treinamento_w;
					EXIT WHEN NOT FOUND; /* apply on C08 */
						begin
						nm_usuario_w	:= substr(nm_usuario_treinamento_w || ', ' || nm_usuario_w,1,2000);
						end;
					end loop;
					close C08;
				
				elsif (ie_usuario_w = 'PT') then	/*Pessoa treinamento*/
					open C09;
					loop
					fetch C09 into	
						nm_usuario_treinamento_w;
					EXIT WHEN NOT FOUND; /* apply on C09 */
						begin
						nm_usuario_w	:= substr(nm_usuario_treinamento_w || ', ' || nm_usuario_w,1,2000);
						end;
					end loop;
					close C09;
				end if;
			
								
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@nome_treinamento', ds_treinamento_w),1,2000);								
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@dt_prev_treinamento', to_char(dt_prevista_w,'dd/mm/yyyy hh24:mi:ss')),1,2000);				
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@qt_tempo_prev_trein', qt_tempo_previsto_w),1,2000);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_setor_treinamento', ds_setor_treinamento_w),1,2000);				
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@obs_treinamento', ds_obs_treinamento_w),1,2000);				
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@responsavel_treinamento', nm_resp_treinamento_w),1,2000);


				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@nome_treinamento', ds_treinamento_w),1,80);								
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@dt_prev_treinamento', to_char(dt_prevista_w,'dd/mm/yyyy hh24:mi:ss')),1,80);				
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@qt_tempo_prev_trein', qt_tempo_previsto_w),1,80);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_setor_treinamento', ds_setor_treinamento_w),1,80);				
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@obs_treinamento', ds_obs_treinamento_w),1,80);				
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@responsavel_treinamento', nm_resp_treinamento_w),1,80);	

				
				end;
			end if;

			/* Documento - Comunicar novo historico */

			if (ie_evento_p = '26') then
				begin
				
				begin
				nr_seq_rtf_srtring_w := converte_rtf_string('select ds_historico from qua_doc_historico where nr_sequencia = :nr_sequencia_p', ds_valor_p, nm_usuario_p, nr_seq_rtf_srtring_w);
				
				select	ds_texto
				into STRICT	ds_historico_doc_w
				from	tasy_conversao_rtf
				where	nr_sequencia = nr_seq_rtf_srtring_w;
				exception
				when others then
					ds_historico_doc_w := '';
				end;
				
				if (coalesce(ds_historico_doc_w::text, '') = '') then
					ds_historico_doc_w := convert_long_to_string('ds_historico','qua_doc_historico','nr_sequencia = ' || ds_valor_p);
				end if;
				end;
			end if;

			ds_comunic_w	:= substr(replace(ds_comunicacao_w, '', wheb_mensagem_pck.get_texto(306065) || ' ' || cd_documento_w || ' - ' || nm_documento_w),1,32000);

			if (nm_documento_w IS NOT NULL AND nm_documento_w::text <> '') then
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@documento', cd_documento_w || ' - ' || nm_documento_w),1,32000);
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@descricao_documento', nm_documento_w),1,32000);
				
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@documento', cd_documento_w || ' - ' || nm_documento_w),1,80);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@descricao_documento', nm_documento_w),1,80);
			end if;
			
			if (nm_pessoa_revisao_w IS NOT NULL AND nm_pessoa_revisao_w::text <> '') then
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@pessoa_revisao', nm_pessoa_revisao_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@pessoa_revisao', nm_pessoa_revisao_w),1,80);
			end if;
			
			if (nm_pessoa_valid_revisao_w IS NOT NULL AND nm_pessoa_valid_revisao_w::text <> '') then
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@pessoa_valid_revisao', nm_pessoa_valid_revisao_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@pessoa_valid_revisao', nm_pessoa_valid_revisao_w),1,80);
			end if;

			if (nm_pessoa_aprov_revisao_w IS NOT NULL AND nm_pessoa_aprov_revisao_w::text <> '') then
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@pessoa_aprov_revisao', nm_pessoa_aprov_revisao_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@pessoa_aprov_revisao', nm_pessoa_aprov_revisao_w),1,80);
			end if;

			if (nm_pessoa_validacao_todos_w IS NOT NULL AND nm_pessoa_validacao_todos_w::text <> '') then
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@pessoa_validacao', nm_pessoa_validacao_todos_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@pessoa_validacao', nm_pessoa_validacao_todos_w),1,80);
			end if;
			
			if (nm_pessoa_aprov_w IS NOT NULL AND nm_pessoa_aprov_w::text <> '') then
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@pessoa_aprovacao', nm_pessoa_aprov_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@pessoa_aprovacao', nm_pessoa_aprov_w),1,80);
			end if;
			
			if (nm_usuario_elaboracao_w IS NOT NULL AND nm_usuario_elaboracao_w::text <> '') then
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@pessoa_elaboracao', substr(obter_nome_usuario(nm_usuario_elaboracao_w),1,120)),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@pessoa_elaboracao', substr(obter_nome_usuario(nm_usuario_elaboracao_w),1,120)),1,80);
			end if;

			if (dt_revisao_w IS NOT NULL AND dt_revisao_w::text <> '') then
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@data_revisao', to_char(dt_revisao_w, 'dd/mm/yyyy')),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@data_revisao', to_char(dt_revisao_w, 'dd/mm/yyyy')),1,80);
			end if;

			if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@observacao_revisao', ds_observacao_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@observacao_revisao', ds_observacao_w),1,80);
			end if;
			
			if (ds_arquivo_w IS NOT NULL AND ds_arquivo_w::text <> '') then
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@endereco', WHEB_MENSAGEM_PCK.get_texto(799462) || ' ' ||  ds_arquivo_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@endereco', WHEB_MENSAGEM_PCK.get_texto(799462) || ' ' ||  ds_arquivo_w),1,80);
			end if;

			if (dt_aprovacao_w IS NOT NULL AND dt_aprovacao_w::text <> '') then
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@data_aprovacao',to_char(dt_aprovacao_w, 'dd/mm/yyyy')),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@data_aprovacao',to_char(dt_aprovacao_w, 'dd/mm/yyyy')),1,80);
			end if;
			
			if (dt_validacao_w IS NOT NULL AND dt_validacao_w::text <> '') then
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@data_validacao',to_char(dt_validacao_w, 'dd/mm/yyyy')),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@data_validacao',to_char(dt_validacao_w, 'dd/mm/yyyy')),1,80);
			end if;
			
			if (dt_elaboracao_w IS NOT NULL AND dt_elaboracao_w::text <> '') then
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@data_elaboracao',to_char(dt_elaboracao_w, 'dd/mm/yyyy')),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@data_elaboracao',to_char(dt_elaboracao_w, 'dd/mm/yyyy')),1,80);
			end if;
			
			if (ds_tipo_documento_w IS NOT NULL AND ds_tipo_documento_w::text <> '') then
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@tipo_documento',ds_tipo_documento_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@tipo_documento',ds_tipo_documento_w),1,80);
			end if;
			
			if (qt_dias_revisao_w IS NOT NULL AND qt_dias_revisao_w::text <> '') then
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@dias_revisao',qt_dias_revisao_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@dias_revisao',qt_dias_revisao_w),1,80);
			end if;
			
			if (ds_status_w IS NOT NULL AND ds_status_w::text <> '') then
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@status_documento',ds_status_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@status_documento',ds_status_w),1,32000);
			end if;

			if (ds_liberacao_arquivo_w IS NOT NULL AND ds_liberacao_arquivo_w::text <> '') then
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@liberacao_arquivo',ds_liberacao_arquivo_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@liberacao_arquivo',ds_liberacao_arquivo_w),1,32000);
			end if;

			if (ds_situacao_w IS NOT NULL AND ds_situacao_w::text <> '') then
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@situacao_documento',ds_situacao_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@situacao_documento',ds_situacao_w),1,32000);
			end if;

			ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@data_envio_comunic',to_char(clock_timestamp(), 'dd/mm/yyyy')),1,32000);
			ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@data_envio_comunic',to_char(clock_timestamp(), 'dd/mm/yyyy')),1,80);
			
			ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@pessoa_envio_comunic',coalesce(Obter_Dados_Usuario_Opcao(nm_usuario_p,'NP'),coalesce(obter_nome_usuario(nm_usuario_p),nm_usuario_p))),1,32000);
			ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@pessoa_envio_comunic',coalesce(Obter_Dados_Usuario_Opcao(nm_usuario_p,'NP'),coalesce(obter_nome_usuario(nm_usuario_p),nm_usuario_p))),1,80);
			
			ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@ds_historico_doc',ds_historico_doc_w),1,32000);
			ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_historico_doc',ds_historico_doc_w),1,80);

			/*	2 - Nao conformidade - Comunicar setores responsaveis/ envolvidos
				3 - Nao conformidade - Comunicar encerramento da acao
				4 - Nao conformidade - Comunicar acao eficaz
				5 - Nao conformidade - Comunicar acao nao eficaz
				6 - Nao conformidade - Comunicar cancelamento
				7 - Nao conformidade - Comunicar executores previstos da acao
				17 - Nao conformidade - Comunicar criacao 
				1 8 - Nao conformidade - Comunicar encerramento
				20 - Acao - Comunicar encerramento (nao eficaz) 
				23 - Nao conformidade - Novo historico 	*/
			if (ie_evento_p in ('2','3','4','5','6','7','17','18','20','21','23','25','37','39')) then
				begin
				if (ie_evento_p in ('3','20','37')) then
					nr_seq_ordem_serv_w := ds_valor_p;
				end if;
				
				select	substr(obter_usuario_pf_ci(coalesce(max(cd_pf_resp_eficacia),'')),1,40),
					max(cd_setor_eficacia)
				into STRICT	nm_pessoa_eficacia_w,
					cd_setor_eficacia_w
				from	qua_nao_conformidade
				where	nr_sequencia = nr_sequencia_p;
				
				if (ie_usuario_w = 'AE') then
					nm_usuario_w	:= substr(nm_pessoa_eficacia_w || ', ' || nm_usuario_w,1,2000);
				elsif (ie_usuario_w = 'SA') then
					if (cd_setor_eficacia_w IS NOT NULL AND cd_setor_eficacia_w::text <> '') then
						begin
						select	substr(obter_usuario_pf_ci(coalesce(max(cd_pessoa_resp),'')),1,40)
						into STRICT	nm_pessoa_resp_setor_w
						from	setor_atendimento
						where	cd_setor_atendimento = cd_setor_eficacia_w;
	
						if (nm_pessoa_resp_setor_w IS NOT NULL AND nm_pessoa_resp_setor_w::text <> '') then
							nm_usuario_w	:= substr(nm_pessoa_resp_setor_w || ', ' || nm_usuario_w,1,2000);
						end if;
						end;
					end if;
				elsif (ie_usuario_w = 'SE') then
					begin
					open c03;
					loop
					fetch c03 into
						nm_resp_setor_w;
					EXIT WHEN NOT FOUND; /* apply on c03 */
						nm_usuario_w	:= substr(nm_resp_setor_w || ', ' || nm_usuario_w,1,2000);
					end loop;
					close c03;
					end;
				elsif (ie_usuario_w = 'SR') then
					begin
					select	substr(obter_usuario_pf_ci(coalesce(max(c.cd_pessoa_resp),'')),1,40)
					into STRICT	nm_resp_receptor_w
					from	setor_atendimento c,
						qua_nao_conformidade a
					where	c.cd_setor_atendimento = a.cd_setor_resp
					and	a.nr_sequencia = nr_sequencia_p;

					if (nm_resp_receptor_w IS NOT NULL AND nm_resp_receptor_w::text <> '') then
						nm_usuario_w	:= substr(nm_resp_receptor_w || ', ' || nm_usuario_w,1,2000);
					end if;
					end;
				elsif (ie_usuario_w = 'RC') then
					begin
					select	substr(obter_usuario_pf_ci(coalesce(max(cd_pf_resp_ocorrencia),'')),1,40)
					into STRICT	nm_pf_resp_ocorrencia_w
					from	qua_nao_conformidade
					where	nr_sequencia = nr_sequencia_p;
	
					if (nm_pf_resp_ocorrencia_w IS NOT NULL AND nm_pf_resp_ocorrencia_w::text <> '') then
						nm_usuario_w	:= substr(nm_pf_resp_ocorrencia_w || ', ' || nm_usuario_w,1,2000);
					end if;
					end;
				elsif (ie_usuario_w = 'RA') then
					begin
					select	substr(obter_usuario_pf_ci(coalesce(max(cd_pf_abertura),'')),1,40)
					into STRICT	nm_pf_abertura_w
					from	qua_nao_conformidade
					where	nr_sequencia = nr_sequencia_p;
	
					if (nm_pf_abertura_w IS NOT NULL AND nm_pf_abertura_w::text <> '') then
						nm_usuario_w	:= substr(nm_pf_abertura_w || ', ' || nm_usuario_w,1,2000);
					end if;
					end;
				elsif (ie_usuario_w = 'EP') then
					begin
					if (ie_evento_p = '3') then
						begin
						open C14;
						loop
						fetch C14 into
							nm_usuario_exec_w;
						EXIT WHEN NOT FOUND; /* apply on C14 */
							nm_usuario_w	:= substr(nm_usuario_exec_w || ', ' || nm_usuario_w,1,2000);
						end loop;
						close C14;
						end;
					elsif (ie_evento_p in ('6','25')) then
						begin
						open c04;
						loop
						fetch c04 into
							nm_usuario_exec_w;
						EXIT WHEN NOT FOUND; /* apply on c04 */
							nm_usuario_w	:= substr(nm_usuario_exec_w || ', ' || nm_usuario_w,1,2000);
						end loop;
						close c04;
						open C14;
						loop
						fetch C14 into
							nm_usuario_exec_w;
						EXIT WHEN NOT FOUND; /* apply on C14 */
							nm_usuario_w	:= substr(nm_usuario_exec_w || ', ' || nm_usuario_w,1,2000);
						end loop;
						close C14;
						end;
					else
						begin
						open c04;
						loop
						fetch c04 into
							nm_usuario_exec_w;
						EXIT WHEN NOT FOUND; /* apply on c04 */
							nm_usuario_w	:= substr(nm_usuario_exec_w || ', ' || nm_usuario_w,1,2000);
						end loop;
						close c04;
						end;
					end if;
					end;
				elsif (ie_usuario_w = 'GE') then
					begin
					open c06;
					loop
					fetch c06 into
						nr_seq_grupo_usuario_w;
					EXIT WHEN NOT FOUND; /* apply on c06 */					
						begin
						ds_grupo_w := nr_seq_grupo_usuario_w || ', ' || ds_grupo_w;						
						open c17;
						loop
						fetch c17 into	
							nm_usuario_grupo_w;
						EXIT WHEN NOT FOUND; /* apply on c17 */
							begin
							if (position(nm_usuario_grupo_w in coalesce(nm_usuario_w,'X')) = 0) then
								nm_usuario_w := substr(nm_usuario_grupo_w || ', ' || nm_usuario_w,1,2000);
							end if;							
							end;
						end loop;
						close c17;						
						end;
					end loop;
					close c06;					
					end;
				elsif (ie_usuario_w = 'UE') then
					begin
					open c16;
					loop
					fetch c16 into
						nm_usuario_destino_w;
					EXIT WHEN NOT FOUND; /* apply on c16 */					
						begin
						nm_usuario_w := substr(nm_usuario_destino_w || ', ' || nm_usuario_w,1,2000);
						end;
					end loop;
					close c16;
					end;
				elsif (ie_usuario_w = 'RB') then
					begin
					select	substr(obter_usuario_pf_ci(max(a.cd_pessoa_resp)),1,40)
					into STRICT	nm_pf_resp_setor_abertura_w
					from	setor_atendimento a,
							qua_nao_conformidade b
					where	a.cd_setor_atendimento = b.cd_setor_atendimento
					and		b.nr_sequencia = nr_sequencia_p;
					
					if (nm_pf_resp_setor_abertura_w IS NOT NULL AND nm_pf_resp_setor_abertura_w::text <> '') then
						nm_usuario_w	:= substr(nm_pf_resp_setor_abertura_w || ', ' || nm_usuario_w,1,2000);
					end if;
					end;
				elsif (ie_usuario_w = 'PR') then
					begin
					select	substr(obter_usuario_pf_ci(coalesce(max(cd_pf_referencia),'')),1,40)
					into STRICT	nm_pf_referencia_w
					from	qua_nao_conformidade
					where	nr_sequencia = nr_sequencia_p;
	
					if (nm_pf_referencia_w IS NOT NULL AND nm_pf_referencia_w::text <> '') then
						nm_usuario_w	:= substr(nm_pf_referencia_w || ', ' || nm_usuario_w,1,2000);
					end if;
					end;
 				end if;
				end;
			end if;
			
			/* 15 - Acao - Comunicar novos historicos  */

			if (ie_evento_p in ('15')) then
				begin
				if (ie_evento_p = '15') then
					select	b.nr_seq_ordem_serv
					into STRICT	nr_seq_ordem_serv_w
					from	man_ordem_serv_tecnico b
					where	b.nr_sequencia = nr_sequencia_p;
				end if;
				
				select	substr(obter_usuario_pf_ci(a.cd_pessoa_solicitante),1,40),
					a.ds_dano_breve
				into STRICT	nm_usuario_pessoa_w,
					ds_dano_breve_w
				from	man_ordem_servico a
				where	a.nr_sequencia = nr_seq_ordem_serv_w;
				
				if (ie_usuario_w = 'ES') then
					
					open C10;
					loop
					fetch C10 into	
						nm_usuario_exec_w;
					EXIT WHEN NOT FOUND; /* apply on C10 */
						begin
						if (nm_usuario_exec_w IS NOT NULL AND nm_usuario_exec_w::text <> '') then
							nm_usuario_w := substr(nm_usuario_exec_w || ', ' || nm_usuario_w,1,2000);
						end if;
						end;
					end loop;
					close C10;
					
				elsif (ie_usuario_w = 'SO') then
					if (nm_usuario_pessoa_w IS NOT NULL AND nm_usuario_pessoa_w::text <> '') then
						nm_usuario_w := substr(nm_usuario_pessoa_w || ', ' || nm_usuario_w,1,2000);
					end if;
				end if;

				ds_comunic_w	:= substr(replace_macro(ds_comunicacao_w, '@acao',nr_seq_ordem_serv_w),1,32000);
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@dano',ds_dano_breve_w),1,32000);
				end;
			end if;

			/* Busca o nome da pasta da Nao conformidade/Ocorrencia conforme o parametro do usuario */

			if (ie_evento_p in ('2','3','4','5','6','7','17','18','20','21','23','25','37')) then
				begin
				
				select	substr(ds_nao_conformidade,1,4000),
					substr(obter_descricao_padrao('QUA_TIPO_NAO_CONFORM','DS_TIPO_NC', nr_seq_tipo),1,255) ds_tipo_nc,
					dt_esperada,
					nr_seq_evento,
					substr(obter_nome_estabelecimento(cd_estabelecimento),1,80),
					substr(obter_nome_pf(cd_pf_abertura),1,60),
					substr(obter_nome_setor(cd_setor_atendimento),1,100),
					substr(obter_dados_setor(cd_setor_atendimento,'NR'),1,60),
					substr(obter_nome_pf(cd_pf_resp_eficacia),1,60),
					substr(obter_nome_setor(cd_setor_resp),1,100)
				into STRICT	ds_nao_conformidade_w,
					ds_tipo_nc_w,
					dt_esperada_w,
					nr_seq_evento_w,
					ds_estabelecimento_w,
					nm_resp_abertura_w,
					ds_setor_abertura_w,
					nm_resp_setor_abertura_w,
					nm_resp_analise_eficacia_w,
					nm_setor_receptor_w
				from	qua_nao_conformidade
				where	nr_sequencia = nr_sequencia_p;
	
				if (coalesce(nr_seq_evento_w,0) = 0) then
					vl_parametro_w	:= ds_par_rnc_w;
				else
					vl_parametro_w	:= ds_par_rnc_evento_w;
				end if;
				
				if (ie_evento_p in ('20','37')) then
					select	ds_dano_breve,
						dt_conclusao_desejada
					into STRICT	ds_dano_breve_w,
						dt_conclusao_desejada_w
					from	man_ordem_servico
					where	nr_sequencia = nr_seq_ordem_serv_w;
				end if;

				if (ie_evento_p = '3') then
					begin

					select	max(nr_sequencia)
					into STRICT	nr_seq_historico_os_w
					from	man_ordem_serv_tecnico
					where	nr_seq_ordem_serv = nr_seq_ordem_serv_w;

					begin
					nr_seq_rtf_srtring_w := converte_rtf_string('select ds_relat_tecnico from man_ordem_serv_tecnico where nr_sequencia = :nr_sequencia_p', nr_seq_historico_os_w, nm_usuario_p, nr_seq_rtf_srtring_w);
					
					select	ds_texto
					into STRICT	ds_ultimo_historico_w
					from	tasy_conversao_rtf
					where	nr_sequencia = nr_seq_rtf_srtring_w;
					exception
					when others then
						ds_ultimo_historico_w := '';
					end;

					end;
				end if;
				
				if (ie_evento_p = '23') then
					begin
					nr_seq_rtf_srtring_w := converte_rtf_string('select ds_historico from qua_nao_conform_hist where nr_sequencia = :nr_sequencia_p', ds_valor_p, nm_usuario_p, nr_seq_rtf_srtring_w);
					select	ds_texto
					into STRICT	ds_historico_nc_w
					from	tasy_conversao_rtf
					where	nr_sequencia = nr_seq_rtf_srtring_w;
					exception
					when others then
						ds_historico_nc_w := '';
					end;
				end if;
				
				ds_comunic_w	:= substr(ds_comunicacao_w || chr(13) || chr(10) ||
						vl_parametro_w || ': ' || nr_sequencia_p || ' - ' || ds_nao_conformidade_w ||  chr(13)    || chr(10) || wheb_mensagem_pck.get_texto(450818) || ' ' || ds_tipo_nc_w,1,32000);

				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@nao_conformidade',nr_sequencia_p),1,32000);
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@tipo_nc',ds_tipo_nc_w),1,32000);
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@dt_esperada_rnc',dt_esperada_w),1,32000);
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@nome_nao_conformidade',vl_parametro_w),1,32000);
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@nome_estabelecimento',ds_estabelecimento_w),1,32000);
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@acao',nr_seq_ordem_serv_w),1,32000);
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@dano',ds_dano_breve_w),1,32000);
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@ds_historico_nc',ds_historico_nc_w),1,32000);
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@ds_ult_historico_os',ds_ultimo_historico_w),1,32000);
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@resp_abertura',nm_resp_abertura_w),1,32000);
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@setor_abertura',ds_setor_abertura_w),1,32000);
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@setor_receptor',nm_setor_receptor_w),1,32000);
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@resp_setor_abertura',nm_resp_setor_abertura_w),1,32000);
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@resp_analise_eficacia',nm_resp_analise_eficacia_w),1,32000);
				
				
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@nao_conformidade',nr_sequencia_p),1,80);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@tipo_nc',ds_tipo_nc_w),1,80);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@dt_esperada_rnc',dt_esperada_w),1,80);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@nome_nao_conformidade',vl_parametro_w),1,80);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@nome_estabelecimento',ds_estabelecimento_w),1,80);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@acao',nr_seq_ordem_serv_w),1,80);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@dano',ds_dano_breve_w),1,80);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_historico_nc',ds_historico_nc_w),1,80);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_ult_historico_os',ds_ultimo_historico_w),1,80);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@resp_abertura',nm_resp_abertura_w),1,80);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@setor_abertura',ds_setor_abertura_w),1,80);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@setor_receptor',nm_setor_receptor_w),1,80);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@resp_setor_abertura',nm_resp_setor_abertura_w),1,80);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@resp_analise_eficacia',nm_resp_analise_eficacia_w),1,80);
				
				
				if (coalesce(nr_seq_motivo_cancel_p,0) > 0) then
					begin
					if (ie_evento_p = '25') then
						select	substr(obter_desc_expressao(cd_exp_motivo,ds_motivo),1,80)
						into STRICT	ds_motivo_cancel_w
						from	qua_nc_motivo_subst
						where	nr_sequencia = nr_seq_motivo_cancel_p;
					else
						select	substr(qua_obter_motivo_cancel_nc(nr_seq_motivo_cancel_p),1,80)
						into STRICT	ds_motivo_cancel_w
						;
					end if;
					
					ds_comunic_w	:= substr(ds_comunic_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(450827) || ' ' ||ds_motivo_cancel_w,1,32000);
					end;
				end if;
			
				if (ie_usuario_w = 'EP') and (ie_evento_p = '7') then
					begin
					open c05;
					loop
					fetch c05 into
						nr_seq_ordem_w,
						ds_dano_breve_w,
						dt_conclusao_desejada_w;
					EXIT WHEN NOT FOUND; /* apply on c05 */
						begin
						select	substr(obter_select_concatenado_bv('select	nm_usuario_exec	from man_ordem_servico_exec
							where nr_seq_ordem = :nr','nr=' || nr_seq_ordem_w,' - '),1,255)
						into STRICT	nm_usuarios_executores_w
						;
			
						ds_comunic_acao_w	:= ds_comunic_acao_w || chr(13) || chr(10) ||
							wheb_mensagem_pck.get_texto(450832) || ' ' || rpad(nr_seq_ordem_w,10) || ' ' ||  wheb_mensagem_pck.get_texto(450838) || ' ' ||  dt_conclusao_desejada_w    || ' ' ||   wheb_mensagem_pck.get_texto(450839) || ' ' || substr(ds_dano_breve_w,1,80) || chr(13) || chr(10) ||
						        wheb_mensagem_pck.get_texto(450841) || ' ' || nm_usuarios_executores_w || chr(13) || chr(10);
						end;
					end loop;
					close c05;				
					end;
				elsif (ie_usuario_w = 'EP') and (ie_evento_p = '20') then
					begin
					select	substr(obter_select_concatenado_bv('select nm_usuario_exec from man_ordem_servico_exec where nr_seq_ordem = :nr','nr=' || nr_seq_ordem_serv_w,' - '),1,255)
					into STRICT	nm_usuarios_executores_w
					;
					
					ds_comunic_acao_w	:= ds_comunic_acao_w || chr(13) || chr(10) ||
							wheb_mensagem_pck.get_texto(450832) || ' ' || rpad(nr_seq_ordem_serv_w,10) || ' ' ||  wheb_mensagem_pck.get_texto(450838) || ' ' ||  dt_conclusao_desejada_w     || ' ' ||   wheb_mensagem_pck.get_texto(450839) || ' ' || substr(ds_dano_breve_w,1,80) || chr(13) || chr(10) ||
							wheb_mensagem_pck.get_texto(450841) || ' ' || nm_usuarios_executores_w || chr(13) || chr(10);
					end;
				end if;
				ds_comunic_w	:= substr(ds_comunic_w || chr(13) || chr(10) || ds_comunic_acao_w,1,32000);
				end;
			end if;
			
			if (ie_evento_p = '34') then
				begin
				select	nr_atendimento,
					substr(obter_descricao_padrao('QUA_EVENTO','DS_EVENTO', nr_seq_evento),1,255),
					substr(obter_descricao_padrao('QUA_EVENTO_CLASSIF','DS_CLASSIFICACAO', nr_seq_classif_evento),1,255),
					obter_valor_dominio(3502, ie_status),
					substr(obter_pessoa_atendimento(nr_atendimento, 'N'),1,255),
					ds_evento ds_evento_paciente
				into STRICT	nr_atendimento_w,
					ds_evento_w,
					ds_classif_evento_w,
					ds_status_evento_w,
					nm_paciente_w,
					ds_evento_paciente_w
				from	qua_evento_paciente
				where	nr_sequencia = nr_sequencia_p;
				
				ds_comunic_w	:= substr(ds_comunic_w || chr(13) || chr(10) || ds_comunic_acao_w,1,32000);						
							
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@nr_atendimento',nr_atendimento_w),1,32000);
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@ds_evento_paciente',ds_evento_paciente_w),1,32000);
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@ds_descricao_evento',ds_classif_evento_w),1,32000);
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@ds_evento',ds_evento_w),1,32000);
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@ds_status',ds_status_evento_w),1,32000);
				ds_comunic_w	:= substr(replace_macro(ds_comunic_w, '@nm_paciente',nm_paciente_w),1,32000);
				
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@nr_atendimento',nr_atendimento_w),1,80);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_evento_paciente',ds_evento_paciente_w),1,80);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_descricao_evento',ds_classif_evento_w),1,80);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_evento',ds_evento_w),1,80);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_status',ds_status_evento_w),1,80);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@nm_paciente',nm_paciente_w),1,80);
				
				end;
			end if;
			
			if (ie_usuario_w = 'UI') and (coalesce(ds_usuario_destino_w,'0') <> '0') then
				nm_usuario_w := substr(ds_usuario_destino_w || ', ' || nm_usuario_w,1,2000);
			end if;
			end;
		end loop;
		close c02;
	
		ds_comunic_email_w := ds_comunic_w;
			/* Envia comunicacao interna para os usuarios conforme o seu cadastro - Regras de envio de comunicacao na  qualidade     (shift + F11) */

		if (ie_comunic_interna_w = 'S') then
			begin
			if (nm_usuario_w IS NOT NULL AND nm_usuario_w::text <> '') or /*Edilson em 01/10/08 OS 110302 Coloquei todos os or depois do nm_usuario. */
				(ds_perfil_adic_w IS NOT NULL AND ds_perfil_adic_w::text <> '') or (ds_grupo_w IS NOT NULL AND ds_grupo_w::text <> '') or (cd_setor_adicional_w IS NOT NULL AND cd_setor_adicional_w::text <> '') or (coalesce(ie_comunic_geral_w,'N') = 'S') then
				begin			
				select	nextval('comunic_interna_seq')
				into STRICT	nr_sequencia_w
				;

				if (substr(trim(both ds_comunic_w),1,1) in ('0','1','2','3','4','5','6','7','8','9')) then
					ds_comunic_w := substr('-' || ds_comunic_w,1,32000);
				end if;

				IF (ie_evento_p = '34') then
					BEGIN	
						select
							substr(obter_descricao_padrao('QUA_EVENTO','IE_ANONIMO', NR_SEQ_EVENTO),1,255),
							nm_usuario
						into STRICT nm_usuario_anonimo_evt_pac_w,
							nm_usuario_evt_pac_w
						from QUA_EVENTO_PACIENTE
						where nr_sequencia = nr_sequencia_p;
						EXCEPTION
						WHEN no_data_found THEN
							nm_usuario_anonimo_evt_pac_w := null;
						WHEN OTHERS THEN
							RAISE;
					END;
					IF (nm_usuario_anonimo_evt_pac_w = 'S') then
					    nm_usuario_original_w := obter_desc_expressao_idioma(710876, null, wheb_usuario_pck.get_nr_seq_idioma);
					END IF;
				END IF;

				begin
				    select
					substr(obter_descricao_padrao('QUA_TIPO_NAO_CONFORM','IE_ANONIMO', nr_seq_tipo),1,255),
					nm_usuario
				    into STRICT nm_usuario_anonimo_w,
					    nm_usuario_nao_conformidade_w    
				    from qua_nao_conformidade
				    where nr_Sequencia = nr_sequencia_p;

				    if (ie_evento_p = '17') and (nm_usuario_anonimo_w = 'S') then
					nm_usuario_original_w := nm_usuario_nao_conformidade_w;
				    end if;
				    exception
				    when others then
					if (ie_evento_p = '17') and (nm_usuario_anonimo_w = 'S') then
						CALL wheb_mensagem_pck.exibir_mensagem_abort(172412);
				    	end if;
               			end;
				insert into comunic_interna(
					dt_comunicado, ds_titulo, ds_comunicado,
					nm_usuario, dt_atualizacao, ie_geral, nm_usuario_destino, nr_sequencia,
					ie_gerencial, nr_seq_classif, dt_liberacao, ds_setor_adicional, ds_grupo, ds_perfil_adicional, cd_estab_destino)
				values (	clock_timestamp(), ds_titulo_w, ds_comunic_w,
					nm_usuario_original_w, clock_timestamp(), coalesce(ie_comunic_geral_w,'N'), CASE WHEN coalesce(ie_comunic_geral_w,'N')='S' THEN ''  ELSE nm_usuario_w END , nr_sequencia_w,
					'N', nr_seq_classif_w, clock_timestamp(), CASE WHEN coalesce(ie_comunic_geral_w,'N')='S' THEN ''  ELSE cd_setor_adicional_w END , CASE WHEN coalesce(ie_comunic_geral_w,'N')='S' THEN ''  ELSE ds_grupo_w END ,
					CASE WHEN coalesce(ie_comunic_geral_w,'N')='S' THEN ''  ELSE ds_perfil_adic_w END , CASE WHEN coalesce(ie_comunic_geral_w,'N')='S' THEN cd_estabelecimento_p  ELSE '' END );
				
				nm_usuario_original_w := coalesce(nm_usuario_origem_w, nm_usuario_p);
				if (ie_evento_p = '34') and (nm_usuario_anonimo_evt_pac_w = 'S') then
				    nm_usuario_original_w := coalesce(nm_usuario_evt_pac_w, nm_usuario_p);
				end if;
				end;
			end if;
			end;
		end if;
		
		ds_comunic_log_w := substr(ds_comunic_w,1,255);		
		
		/*	1 - Documento - Comunicar participantes da revisao
			8 - Documento - Comunicar a elaboracao
			9 - Documento - Comunicar a validacao
			10 - Documento - Comunicar a aprovacao
			11 - Documento - Comunicar a revisao
			12 - Documento - Comunicar treinamento
			13 - Documento - Comunicar a aprovacao da revisao
			14 - Documento - Comunicar quando for inativado
			16 - Documento - Comunicar a validacao da revisao  
			19 - Documento - comunicar a disponibilizacao 
			22 - Documento - Comunicar exclusao
			26 - Documento - Comunicar novo historico
			27 - Documento - Comunicar a aprovacao (pasta aprovadores)
			28 - Documento - Criacao de documento previsto
			29 - Documento - Comunicar quando vencido
			31 - Documento - Comunicar reprovacao da revisao
			32 - Documento - Comunicar  quando expirado
			33 - Documento - Comunicar liberacao treinamento
			35 - Documento - Comunicar solicitacao de treinamento	*/
		if (ie_comunic_interna_w = 'S') and (ie_evento_p in ('1','8','9','10','11','12','13','14','16','19','22','26','27','28','29','31','32','33','35')) then
			begin
			lista_usuario_w	:= substr(nm_usuario_w,1,2000);
			while	(lista_usuario_w IS NOT NULL AND lista_usuario_w::text <> '') loop
				begin
				tam_lista_w	:= length(lista_usuario_w);
				ie_pos_virgula_w	:= position(',' in lista_usuario_w);		
	
				if (ie_pos_virgula_w <> 0) then
					nm_usuario_envio_w	:= substr(substr(lista_usuario_w,1,(ie_pos_virgula_w - 1)),1,15);
					lista_usuario_w	:= substr(lista_usuario_w,(ie_pos_virgula_w + 2), tam_lista_w);
				else
					lista_usuario_w	:= null;
				end if;
			
				if ((trim(both nm_usuario_envio_w) IS NOT NULL AND (trim(both nm_usuario_envio_w))::text <> '')) and (trim(both nm_usuario_envio_w) <> ',') then
				insert into qua_doc_envio(
					nr_sequencia, nr_seq_doc, dt_atualizacao, nm_usuario,
					dt_envio, ie_tipo_envio, ds_destino, ds_observacao)
				values (nextval('qua_doc_envio_seq'), nr_seq_documento_w, clock_timestamp(), nm_usuario_original_w,
					clock_timestamp(), 'D', substr(coalesce(obter_nome_usuario(nm_usuario_envio_w),nm_usuario_envio_w),1,60),  substr(ds_comunic_w,1,255));
					
				end if;
				end;
			end loop;
			end;
		elsif (ie_comunic_interna_w = 'S') and (ie_evento_p in ('2','3','4','5','6','7','17','18','21','23','25','39')) then
			begin
		/*	2 - Nao conformidade - Comunicar setores responsaveis/ envolvidos
			3 - Nao conformidade - Comunicar encerramento da acao
			4 - Nao conformidade - Comunicar acao eficaz
			5 - Nao conformidade - Comunicar acao nao eficaz
			6 - Nao conformidade - Comunicar cancelamento
			7 - Nao conformidade - Comunicar executores previstos da acao
			17 - Nao conformidade - Comunicar criacao
			18 - Nao conformidade - Comunicar encerramento
			23 - Nao conformidade - Novo historico	
			39 - Nao conformidade- Alteracao Status  */
			lista_usuario_w	:= substr(nm_usuario_w,1,2000);
			
			while	(lista_usuario_w IS NOT NULL AND lista_usuario_w::text <> '') loop
				begin
				tam_lista_w	:= length(lista_usuario_w);
				ie_pos_virgula_w	:= position(',' in lista_usuario_w);		
	
				if (ie_pos_virgula_w <> 0) then
					nm_usuario_envio_w	:= substr(substr(lista_usuario_w,1,(ie_pos_virgula_w - 1)),1,15);
					lista_usuario_w	:= substr(lista_usuario_w,(ie_pos_virgula_w + 2), tam_lista_w);
				else
					lista_usuario_w	:= null;
				end if;
					if ((trim(both nm_usuario_envio_w) IS NOT NULL AND (trim(both nm_usuario_envio_w))::text <> '')) and (trim(both nm_usuario_envio_w) <> ',') then
						insert into qua_nao_conform_envio(
								nr_sequencia,
								nr_seq_nao_conform,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								dt_envio,
								ie_tipo_envio,
								ds_destino,
								ds_observacao)
							values (	nextval('qua_nao_conform_envio_seq'),
								nr_sequencia_p,
								clock_timestamp(),
								nm_usuario_original_w,
								clock_timestamp(),
								nm_usuario_original_w,
								clock_timestamp(),
								'I',
								substr(coalesce(substr(obter_nome_usuario(nm_usuario_envio_w),1,255),nm_usuario_envio_w),1,255),
								--substr(ds_comunic_w,1,255)
								ds_comunic_log_w
								);
					end if;
				end;
			end loop;
			
			if (coalesce(ds_grupo_w,'X') <> 'X') then
				insert into qua_nao_conform_envio(
						nr_sequencia,
						nr_seq_nao_conform,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						dt_envio,
						ie_tipo_envio,
						ds_destino,
						ds_observacao)
					values (	nextval('qua_nao_conform_envio_seq'),
						nr_sequencia_p,
						clock_timestamp(),
						nm_usuario_original_w,
						clock_timestamp(),
						nm_usuario_original_w,
						clock_timestamp(),
						'I',
						substr(wheb_mensagem_pck.get_texto(450843) || '' || ds_grupo_w,1,255),
						--substr(ds_comunic_w,1,255)
						ds_comunic_log_w
						);
			end if;
			end;
		end if;
	
		if (ie_email_w = 'S') then
			begin
			lista_usuario_w	:= substr(nm_usuario_w,1,2000);

			while(lista_usuario_w IS NOT NULL AND lista_usuario_w::text <> '') and (trim(both lista_usuario_w) <> ',') loop
				tam_lista_w		:= length(lista_usuario_w);
				ie_pos_virgula_w	:= position(',' in lista_usuario_w);
				if (ie_pos_virgula_w <> 0) then
					nm_usuario_w	:= substr(lista_usuario_w,1,(ie_pos_virgula_w - 1));
					lista_usuario_w	:= substr(lista_usuario_w,(ie_pos_virgula_w + 2), tam_lista_w);
					
					select	trim(both max(ds_email))
					into STRICT	ds_email_usuario_w
					from	usuario
					where	nm_usuario = nm_usuario_w
					and     ie_situacao <> 'I';
					
					if (coalesce(ds_email_usuario_w,'X') <> 'X') then
						begin
						ds_lista_email_usuario_w	:= substr(ds_lista_email_usuario_w||ds_email_usuario_w||',',1,2000);
						end;
					end if;
				else
					lista_usuario_w	:= null;
				end if;
			end loop;
			
			if (coalesce(ds_lista_email_usuario_w,'X') <> 'X') then
				--begin
				CALL enviar_email(	ds_titulo_w,
						ds_comunic_email_w,
						ds_email_origem_w,
						ds_lista_email_usuario_w,
						nm_usuario_original_w,
						'M');
				--exception

				--when others then

				--	wheb_mensagem_pck.exibir_mensagem_abort(225055,'DS_LISTA_EMAIL_USUARIO=' || ds_lista_email_usuario_w || ';DS_EMAIL_ORIGEM=' || ds_email_origem_w);

				--end;
			end if;
			
			/* 1 - Documento - Comunicar participantes da revisao
			   8 - Documento - Comunicar a elaboracao
			   9 - Documento - Comunicar a validacao
			  10 - Documento - Comunicar a aprovacao
			  11 - Documento - Comunicar a revisao
			  12 - Documento - Comunicar treinamento
			  13 - Documento - Comunicar a aprovacao da revisao
			  14 - Documento - Comunicar quando for inativado
			  16 - Documento - Comunicar a validacao da revisao  
			  19 - Documento - comunicar a disponibilizacao 
			  22 - Documento - Comunicar exclusao
			  26 - Documento - Comunicar novo historico
			  27 - Documento - Comunicar a aprovacao (pasta aprovadores) 
			  28 - Documento - Criacao de documento previsto
			  29 - Documento - Comunicar quando vencido
			  31 - Documento - Comunicar reprovacao da revisao	
			  32 - Documento - Comunicar  quando expirado
			  33 - Documento - Comunicar liberacao treinamento
			  35 - Documento - Comunicar solicitacao de treinamento */
			if (ie_evento_p in ('1','8','9','10','11','12','13','14','16','19','22','26','27','28','29','31','32','33','35')) then
				begin
				if (coalesce(ds_lista_email_usuario_w,'X') <> 'X') then
					insert into qua_doc_envio(
						nr_sequencia, nr_seq_doc, dt_atualizacao, nm_usuario,
						dt_envio, ie_tipo_envio, ds_destino, ds_observacao)
					values (nextval('qua_doc_envio_seq'), nr_seq_documento_w, clock_timestamp(), nm_usuario_original_w,
						clock_timestamp(), 'E', substr(ds_lista_email_usuario_w,1,60),  substr(ds_comunic_w,1,255));
				end if;
				end;
			elsif (ie_evento_p in ('2','3','4','5','6','7','17','18','21','23','25','39')) then
				begin
				/* 2 - Nao conformidade - Comunicar setores responsaveis/ envolvidos
				   3 - Nao conformidade - Comunicar encerramento da acao
				   4 - Nao conformidade - Comunicar acao eficaz
				   5 - Nao conformidade - Comunicar acao nao eficaz
				   6 - Nao conformidade - Comunicar cancelamento
				   7 - Nao conformidade - Comunicar executores previstos da acao 
				  17 - Nao conformidade - Comunicar criacao 
				  18 - Nao conformidade - Comunicar encerramento 
				  23 - Nao conformidade - Novo historico 
				  39 - Nao conformidade- Alteracao Status */
		
				if (coalesce(ds_lista_email_usuario_w,'X') <> 'X') then
					insert into qua_nao_conform_envio(
							nr_sequencia,
							nr_seq_nao_conform,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							dt_envio,
							ie_tipo_envio,
							ds_destino,
							ds_observacao)
						values (	nextval('qua_nao_conform_envio_seq'),
							nr_sequencia_p,
							clock_timestamp(),
							nm_usuario_original_w,
							clock_timestamp(),
							nm_usuario_original_w,
							clock_timestamp(),
							'E',
							substr(ds_lista_email_usuario_w,1,255),
							--substr(ds_comunic_w,1,255)
							ds_comunic_log_w
							);
				end if;
				end;		
			end if;
			end;
		end if;

		ds_comunic_w	:= '';
		nm_usuario_w	:= null;
		end;
	end loop;
	close c01;
	end;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qua_gerar_envio_comunicacao ( nr_sequencia_p bigint, ds_valor_p text, nm_usuario_p text, ie_evento_p text, cd_estabelecimento_p bigint, cd_setor_adicional_p bigint, nr_seq_motivo_cancel_p bigint, ie_usuarios_perfil_p text) FROM PUBLIC;

