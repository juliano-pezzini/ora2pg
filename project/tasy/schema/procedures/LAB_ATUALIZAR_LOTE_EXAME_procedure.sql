-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_atualizar_lote_exame ( nr_prescricao_p bigint, cd_setor_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_setor_atendimento_w	integer;
nr_seq_lote_w		bigint;


BEGIN

cd_setor_atendimento_w	:= cd_setor_atendimento_p;
if (coalesce(cd_setor_atendimento_w::text, '') = '') then
	select cd_setor_entrega
	into STRICT cd_setor_atendimento_w
	from prescr_medica
	where nr_prescricao = nr_prescricao_p;
end if;

select	coalesce(max(nr_sequencia),0)
into STRICT	nr_seq_lote_w
from	lab_lote_exame
where	cd_setor_atendimento = cd_setor_atendimento_w
  and	ie_status = 'I';

if (nr_seq_lote_w = 0) then

	select	nextval('lab_lote_exame_seq')
	into STRICT	nr_seq_lote_w
	;

	insert into lab_lote_exame(	NR_SEQUENCIA, 		DT_LOTE,
					DT_ATUALIZACAO, 	NM_USUARIO,
					NR_SEQ_GRUPO,		NR_SEQ_EXAME,
					DT_INICIAL,		DT_FINAL,
					NR_SEQ_GRUPO_IMP,	IE_TIPO_ATENDIMENTO,
					DT_GERACAO,		DS_LOTE,
					IE_LOTE,		IE_STATUS,
					DT_ATUALIZACAO_NREC,	NM_USUARIO_NREC,
					CD_SETOR_ATENDIMENTO,	NR_SEQ_MATERIAL)
	values (nr_seq_lote_w, 			clock_timestamp(),
		clock_timestamp(),			nm_usuario_p,
		null,				null,
		clock_timestamp(),			clock_timestamp(),
		null,				null,
		clock_timestamp(),			obter_desc_expressao(692303) || ' - ' || nr_seq_lote_w,
		'N',				'I',
		clock_timestamp(),			nm_usuario_p,
		cd_setor_atendimento_w,		null);
end if;

insert into lab_lote_exame_item(NR_SEQ_LOTE,	NR_PRESCRICAO,
	 NR_SEQ_PRESCR,	DT_ATUALIZACAO,
	 NM_USUARIO,	DT_ATUALIZACAO_NREC,
	 NM_USUARIO_NREC)
SELECT	 nr_seq_lote_w, nr_prescricao,
	 nr_sequencia,	clock_timestamp(),
	 nm_usuario_p,	clock_timestamp(),
	 nm_usuario_p
from prescr_procedimento
where nr_prescricao = nr_prescricao_p
  and (nr_seq_exame IS NOT NULL AND nr_seq_exame::text <> '');

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_atualizar_lote_exame ( nr_prescricao_p bigint, cd_setor_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

