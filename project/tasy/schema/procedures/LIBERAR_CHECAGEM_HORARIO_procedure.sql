-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_checagem_horario ( cd_estabelecimento_p bigint, nr_atendimento_p bigint, ie_tipo_item_p text, cd_item_p text, cd_intervalo_p text, qt_item_p bigint, nr_seq_horario_p bigint, nr_prescricoes_p text, nr_prescricao_p bigint, nr_seq_item_p bigint, ie_laboratorio_p text, nr_seq_motivo_p bigint, ds_justificativa_p text, nm_usuario_p text, nr_seq_proc_interno_p bigint, cd_unidade_medida_p text default null) AS $body$
DECLARE

 
nr_prescricao_w		bigint;
nr_seq_item_w		bigint;
nr_seq_horario_w	bigint;
dt_horario_w		timestamp := null;
nr_prescr_atual_w	bigint := 0;
ie_data_proc_w		varchar(15);
ie_data_lib_prescr_w varchar(15);
ie_exibe_suspenso_w	varchar(15);
ie_acm_w			varchar(1);
ie_sn_w				varchar(1);
ie_acm_sn_w			varchar(1);
cd_setor_pac_w		bigint;

 
c01 CURSOR FOR 
SELECT	a.nr_prescricao nr_prescricao, /* dieta oral */
 
		null nr_seq_item, 
		c.nr_sequencia nr_seq_hor, 
		'N' ie_acm, 
		'N' ie_sn 
from	prescr_dieta_hor c, 
		prescr_medica a 
where	c.nr_prescricao = a.nr_prescricao 
--and		a.dt_liberacao is not null 
and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S' 
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S' 
and		coalesce(c.ie_situacao,'A') = 'A' 
--and		nvl(c.ie_horario_especial,'N') = 'N' 
and		coalesce(c.dt_fim_horario::text, '') = '' 
and		coalesce(c.dt_suspensao::text, '') = '' 
and		a.dt_validade_prescr > clock_timestamp() 
and		a.nr_atendimento = nr_atendimento_p 
and		obter_se_contido(a.nr_prescricao, '(' || nr_prescricoes_p || ')') = 'S' 
and		c.cd_refeicao = cd_item_p 
and		c.dt_horario = dt_horario_w 
and		ie_tipo_item_p = 'D' 
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S' 

union
 
SELECT	a.nr_prescricao nr_prescricao, 
		b.nr_sequencia nr_seq_item, 
		c.nr_sequencia nr_seq_hor, 
		'N' ie_acm, 
		'N' ie_sn 
from	prescr_medica a, 
		prescr_dieta b, 
		prescr_dieta_hor c 
where	c.nr_prescricao = a.nr_prescricao 
and		c.nr_prescricao = b.nr_prescricao 
and		c.nr_seq_dieta	= b.nr_sequencia 
and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S' 
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S' 
and		coalesce(c.ie_situacao,'A') = 'A' 
and		coalesce(c.dt_fim_horario::text, '') = '' 
and		coalesce(c.dt_suspensao::text, '') = '' 
and		a.dt_validade_prescr > clock_timestamp() 
and		a.nr_atendimento = nr_atendimento_p 
and		obter_se_contido(a.nr_prescricao, '(' || nr_prescricoes_p || ')') = 'S' 
and		to_char(b.cd_dieta) = cd_item_p 
and		coalesce(c.cd_refeicao::text, '') = '' 
and		c.dt_horario = dt_horario_w 
and		ie_tipo_item_p = 'D' 
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S' 

union
 
select	a.nr_prescricao nr_prescricao, /* suplemento oral */
 
		b.nr_sequencia nr_seq_item, 
		c.nr_sequencia nr_seq_hor, 
		'N' ie_acm, 
		'N' ie_sn 
from	prescr_mat_hor c, 
		prescr_material b, 
		prescr_medica a 
where	c.nr_prescricao = b.nr_prescricao 
and		c.nr_seq_material = b.nr_sequencia 
and		b.nr_prescricao = a.nr_prescricao 
--and		a.dt_liberacao is not null 
and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S' 
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S' 
and		b.ie_agrupador in (12) 
and		coalesce(c.ie_situacao,'A') = 'A' 
and		coalesce(c.ie_horario_especial,'N') = 'N' 
and		coalesce(c.dt_fim_horario::text, '') = '' 
and		coalesce(c.dt_suspensao::text, '') = '' 
and		a.dt_validade_prescr > clock_timestamp() 
and		a.nr_atendimento = nr_atendimento_p 
--and		obter_se_contido(a.nr_prescricao, '(' || nr_prescricoes_p || ')') = 'S' 
--and		((nr_seq_item_p is null) or (b.nr_sequencia = nr_seq_item_p)) 
and		obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S' 
and		b.cd_material = cd_item_p 
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO') 
--and		nvl(b.qt_dose,1) = nvl(qt_item_p,1) 
and		coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1)) 
and		c.dt_horario = dt_horario_w 
and		ie_tipo_item_p = 'S' 
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S' 

union
 
select	a.nr_prescricao nr_prescricao, /* medicamentos */
 
		b.nr_sequencia nr_seq_item, 
		c.nr_sequencia nr_seq_hor, 
		coalesce(b.ie_acm, 'N') ie_acm, 
		coalesce(b.ie_se_necessario, 'N') ie_sn 
from	prescr_mat_hor c, 
		prescr_material b, 
		prescr_medica a 
where	c.nr_prescricao = b.nr_prescricao 
and		c.nr_seq_material = b.nr_sequencia 
and		b.nr_prescricao = a.nr_prescricao 
--and		a.dt_liberacao is not null 
and		obter_se_prescr_lib_adep(coalesce(a.dt_liberacao_medico, b.dt_lib_material), coalesce(a.dt_liberacao,b.dt_lib_material), coalesce(a.dt_liberacao_farmacia, b.dt_lib_farmacia), ie_data_lib_prescr_w) = 'S' 
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S' 
and		b.ie_agrupador in (1) 
and		coalesce(c.ie_situacao,'A') = 'A' 
and		coalesce(c.ie_horario_especial,'N') = 'N' 
and		coalesce(c.ie_adep,'S') = 'S' 
and		coalesce(c.dt_fim_horario::text, '') = '' 
and		coalesce(c.dt_suspensao::text, '') = '' 
--and		obter_se_contido(a.nr_prescricao, '(' || nr_prescricoes_p || ')') = 'S' 
--and		((nr_seq_item_p is null) or (b.nr_sequencia = nr_seq_item_p)) 
and		obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S' 
and		b.cd_material = cd_item_p 
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO') 
and		coalesce(cd_unidade_medida_p,'XPTO') in ('XPTO', c.cd_unidade_medida_dose) 
--and		nvl(b.qt_dose,1) = nvl(qt_item_p,1) 
and		coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1)) 
and		c.dt_horario = dt_horario_w 
 
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S' 
and		a.dt_validade_prescr > clock_timestamp() 
and		a.nr_atendimento = nr_atendimento_p 
and		ie_tipo_item_p in ('M', 'IAH') 

union
 
select	a.nr_prescricao nr_prescricao, /* materiais */
 
		b.nr_sequencia nr_seq_item, 
		c.nr_sequencia nr_seq_hor, 
		'N' ie_acm, 
		'N' ie_sn 
from	prescr_mat_hor c, 
		prescr_material b, 
		prescr_medica a 
where	c.nr_prescricao = b.nr_prescricao 
and		c.nr_seq_material = b.nr_sequencia 
and		b.nr_prescricao = a.nr_prescricao 
--and		a.dt_liberacao is not null 
and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S' 
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S' 
and		b.ie_agrupador in (2) 
and		coalesce(c.ie_situacao,'A') = 'A' 
and		coalesce(c.ie_horario_especial,'N') = 'N' 
and		coalesce(c.dt_fim_horario::text, '') = '' 
and		coalesce(c.dt_suspensao::text, '') = '' 
and		a.dt_validade_prescr > clock_timestamp() 
and		a.nr_atendimento = nr_atendimento_p 
--and		obter_se_contido(a.nr_prescricao, '(' || nr_prescricoes_p || ')') = 'S' 
--and		((nr_seq_item_p is null) or (b.nr_sequencia = nr_seq_item_p)) 
and		obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S' 
and		b.cd_material = cd_item_p 
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO') 
--and		nvl(b.qt_dose,1) = nvl(qt_item_p,1) 
and		coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1)) 
and		c.dt_horario = dt_horario_w 
and		ie_tipo_item_p = 'MAT' 
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S' 

union
 
select	a.nr_prescricao nr_prescricao, /* procedimentos e controles de glicemia */
 
		b.nr_sequencia nr_seq_item, 
		c.nr_sequencia nr_seq_hor, 
		'N' ie_acm, 
		'N' ie_sn 
from	prescr_proc_hor c, 
		prescr_procedimento b, 
		prescr_medica a 
where	c.nr_prescricao = b.nr_prescricao 
and		c.nr_seq_procedimento = b.nr_sequencia 
and		b.nr_prescricao = a.nr_prescricao 
--and		a.dt_liberacao is not null 
and		(obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '') 
and		obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S' 
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S' 
and		coalesce(c.ie_situacao,'A') = 'A' 
and		coalesce(c.ie_horario_especial,'N') = 'N' 
and		coalesce(c.dt_fim_horario::text, '') = '' 
and		coalesce(c.dt_suspensao::text, '') = '' 
and		a.dt_validade_prescr > clock_timestamp() 
and		a.nr_atendimento = nr_atendimento_p 
--and		obter_se_contido(a.nr_prescricao, '(' || nr_prescricoes_p || ')') = 'S' 
--and		((nr_seq_item_p is null) or (b.nr_sequencia = nr_seq_item_p)) 
and		obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S' 
and		b.cd_procedimento = cd_item_p 
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO') 
--and		nvl(b.qt_procedimento,1) = nvl(qt_item_p,1) 
and		coalesce(b.qt_procedimento,1) = coalesce(qt_item_p,coalesce(b.qt_procedimento,1)) 
and		((coalesce(b.nr_seq_exame::text, '') = '' and ie_laboratorio_p = 'N') or ((b.nr_seq_exame IS NOT NULL AND b.nr_seq_exame::text <> '') and ie_laboratorio_p = 'S')) 
and		c.dt_horario = dt_horario_w 
and		ie_tipo_item_p in ('P','G','C','I') 
and		coalesce(b.nr_seq_proc_interno,0) = coalesce(nr_seq_proc_interno_p,0) 
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S' 

union
 
select	a.nr_prescricao nr_prescricao, /* recomendações */
 
		b.nr_sequencia nr_seq_item, 
		c.nr_sequencia nr_seq_hor, 
		'N' ie_acm, 
		'N' ie_sn 
from	prescr_rec_hor c, 
		prescr_recomendacao b, 
		prescr_medica a 
where	c.nr_prescricao = b.nr_prescricao 
and		c.nr_seq_recomendacao = b.nr_sequencia 
and		b.nr_prescricao = a.nr_prescricao 
--and		a.dt_liberacao is not null 
and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S' 
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S' 
and		coalesce(c.ie_situacao,'A') = 'A' 
and		coalesce(c.ie_horario_especial,'N') = 'N' 
and		coalesce(c.dt_fim_horario::text, '') = '' 
and		coalesce(c.dt_suspensao::text, '') = '' 
and		a.dt_validade_prescr > clock_timestamp() 
and		a.nr_atendimento = nr_atendimento_p 
--and		obter_se_contido(a.nr_prescricao, '(' || nr_prescricoes_p || ')') = 'S' 
--and		((nr_seq_item_p is null) or (b.nr_sequencia = nr_seq_item_p)) 
and		obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S' 
and		coalesce(to_char(b.cd_recomendacao),b.ds_recomendacao) = cd_item_p 
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO') 
--and		nvl(b.qt_recomendacao,1) = nvl(qt_item_p,1) 
and		coalesce(b.qt_recomendacao,1) = coalesce(qt_item_p,coalesce(b.qt_recomendacao,1)) 
and		c.dt_horario = dt_horario_w 
and		ie_tipo_item_p = 'R' 
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S' 

union
 
select	a.nr_sequencia nr_prescricao, /* sae */
 
		b.nr_sequencia nr_seq_item, 
		c.nr_sequencia nr_seq_hor, 
		'N' ie_acm, 
		'N' ie_sn 
from	pe_prescr_proc_hor c, 
		pe_prescr_proc b, 
		pe_prescricao a 
where	c.nr_seq_pe_proc = b.nr_sequencia 
and		b.nr_seq_prescr = a.nr_sequencia 
and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') 
and		coalesce(b.ie_adep,'N') in ('S','M') 
and		coalesce(c.ie_situacao,'A') = 'A' 
and		coalesce(c.ie_horario_especial,'N') = 'N' 
and		coalesce(c.dt_fim_horario::text, '') = '' 
and		coalesce(c.dt_suspensao::text, '') = '' 
and		a.dt_validade_prescr > clock_timestamp() 
and		a.nr_atendimento = nr_atendimento_p 
--and		obter_se_contido(a.nr_sequencia, '(' || nr_prescricoes_p || ')') = 'S' 
--and		((nr_seq_item_p is null) or (b.nr_sequencia = nr_seq_item_p)) 
and		obter_se_prescr_adep(a.nr_sequencia, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S' 
and		b.nr_seq_proc = cd_item_p 
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO') 
and		c.dt_horario = dt_horario_w 
and		ie_tipo_item_p = 'E' 

union
 
SELECT	a.nr_prescricao nr_prescricao,  /*Solução*/
 
		c.nr_seq_solucao nr_seq_item, 
		c.nr_sequencia nr_seq_hor, 
		'N' ie_acm, 
		'N' ie_sn 
FROM		prescr_mat_hor c, 
		prescr_material b, 
		prescr_medica a 
WHERE		c.nr_prescricao = b.nr_prescricao 
AND		c.nr_seq_material = b.nr_sequencia 
AND		b.nr_prescricao = a.nr_prescricao 
--AND		b.ie_agrupador IN (2) 
AND		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, NULL)= 'S' 
AND		obter_se_exibir_rep_adep_setor(NULL,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S' 
and		obter_se_contido(a.nr_prescricao, '(' || nr_prescricoes_p || ')') = 'S' 
AND		coalesce(c.ie_situacao,'A') = 'A' 
AND		coalesce(c.ie_horario_especial,'N') = 'N' 
AND		coalesce(c.dt_fim_horario::text, '') = '' 
AND		coalesce(c.dt_suspensao::text, '') = '' 
AND   b.nr_prescricao = nr_prescricao_p 
AND   a.nr_atendimento = nr_atendimento_p 
AND		ie_tipo_item_p = 'SOL' 
AND		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S' 
order by 
  1, 2, 3;
	

BEGIN 
 
ie_data_proc_w := obter_param_usuario(924, 223, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_data_proc_w);
ie_data_lib_prescr_w := obter_param_usuario(1113, 115, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_data_lib_prescr_w);
ie_exibe_suspenso_w := obter_param_usuario(1113, 117, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_exibe_suspenso_w);
 
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') and (cd_item_p IS NOT NULL AND cd_item_p::text <> '') and (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') and (nr_prescricoes_p IS NOT NULL AND nr_prescricoes_p::text <> '') and (ie_laboratorio_p IS NOT NULL AND ie_laboratorio_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then 
	 
	cd_setor_pac_w	:= Obter_Unidade_Atendimento(nr_atendimento_p, 'IA', 'CS');
	 
	/* obter horário */
 
	if (ie_tipo_item_p = 'D') then 
		select	dt_horario 
		into STRICT	dt_horario_w 
		from	prescr_dieta_hor 
		where	nr_sequencia = nr_seq_horario_p 
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
	elsif (ie_tipo_item_p in ('S','M','MAT', 'IAH')) then 
		select	dt_horario 
		into STRICT	dt_horario_w 
		from	prescr_mat_hor 
		where	nr_sequencia = nr_seq_horario_p 
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';	
	elsif (ie_tipo_item_p in ('P','G','C','I')) then 
		select	dt_horario 
		into STRICT	dt_horario_w 
		from	prescr_proc_hor 
		where	nr_sequencia = nr_seq_horario_p 
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
	elsif (ie_tipo_item_p = 'R') then 
		select	dt_horario 
		into STRICT	dt_horario_w 
		from	prescr_rec_hor 
		where	nr_sequencia = nr_seq_horario_p 
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
	elsif (ie_tipo_item_p = 'E') then 
		select	dt_horario 
		into STRICT	dt_horario_w 
		from	pe_prescr_proc_hor 
		where	nr_sequencia = nr_seq_horario_p;
	elsif (ie_tipo_item_p = 'SOL') then 
    select	max(dt_horario) 
		into STRICT	dt_horario_w 
		from	prescr_mat_hor 
		where	nr_seq_solucao	= nr_seq_item_p 
		and		nr_etapa_sol 	= nr_seq_horario_p 
		and		nr_prescricao	= nr_prescricao_p 
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';		
	end if;
   
	/* atualizar horários */
 
	if (dt_horario_w IS NOT NULL AND dt_horario_w::text <> '') then 
		open c01;
		loop 
		fetch c01 into	nr_prescricao_w, 
				nr_seq_item_w, 
				nr_seq_horario_w, 
				ie_acm_w, 
				ie_sn_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin 
			if (ie_acm_w = 'S') or (ie_sn_w = 'S') then 
				ie_acm_sn_w := 'S';
			else 
				ie_acm_sn_w := 'N';
			 
			end if;
			 
			if (ie_tipo_item_p = 'D') then 
				update	prescr_dieta_hor 
				set	ie_checagem		= 'L', 
					nm_usuario_checagem	= nm_usuario_p, 
					dt_checagem		= clock_timestamp() 
				where	nr_sequencia		= nr_seq_horario_w;
 
			elsif (ie_tipo_item_p in ('S','M','MAT', 'IAH')) then 
				update	prescr_mat_hor 
				set	ie_checagem		= 'L', 
					nm_usuario_checagem	= nm_usuario_p, 
					dt_checagem		= clock_timestamp() 
				where	nr_sequencia		= nr_seq_horario_w;
 
			elsif (ie_tipo_item_p in ('P','G','C','I')) then 
				update	prescr_proc_hor 
				set	ie_checagem		= 'L', 
					nm_usuario_checagem	= nm_usuario_p, 
					dt_checagem		= clock_timestamp() 
				where	nr_sequencia		= nr_seq_horario_w;
 
			elsif (ie_tipo_item_p = 'R') then 
				update	prescr_rec_hor 
				set	ie_checagem		= 'L', 
					nm_usuario_checagem	= nm_usuario_p, 
					dt_checagem		= clock_timestamp() 
				where	nr_sequencia		= nr_seq_horario_w;
 
			elsif (ie_tipo_item_p = 'E') then 
				update	pe_prescr_proc_hor 
				set	ie_checagem		= 'L', 
					nm_usuario_checagem	= nm_usuario_p, 
					dt_checagem		= clock_timestamp() 
				where	nr_sequencia		= nr_seq_horario_w;	
			elsif (ie_tipo_item_p = 'SOL') then 
				update	prescr_mat_hor 
				set	ie_checagem		= 'L', 
					nm_usuario_checagem	= nm_usuario_p, 
					dt_checagem		= clock_timestamp() 
				where	nr_sequencia		= nr_seq_horario_w;	
			end if;
 
			if (nr_prescricao_w <> nr_prescr_atual_w) then 
				/* gerar evento */
 
				CALL gerar_evento_reaprazamento(nr_atendimento_p, nr_prescricao_w, nr_seq_item_w, nr_seq_horario_w, cd_item_p, ie_tipo_item_p, 16, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_proc_interno_p, ie_acm_sn_w );
			end if;
 
			/* atualizar prescricao cursor */
 
			nr_prescr_atual_w := nr_prescricao_w;
			end;
		end loop;
		close c01;
	end if;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_checagem_horario ( cd_estabelecimento_p bigint, nr_atendimento_p bigint, ie_tipo_item_p text, cd_item_p text, cd_intervalo_p text, qt_item_p bigint, nr_seq_horario_p bigint, nr_prescricoes_p text, nr_prescricao_p bigint, nr_seq_item_p bigint, ie_laboratorio_p text, nr_seq_motivo_p bigint, ds_justificativa_p text, nm_usuario_p text, nr_seq_proc_interno_p bigint, cd_unidade_medida_p text default null) FROM PUBLIC;

