-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atual_saldo_adiant_pago_moeda (nr_adiantamento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
cd_moeda_w				moeda.cd_moeda%type;
cd_moeda_empresa_w		moeda.cd_moeda%type;
vl_cotacao_w			cotacao_moeda.vl_cotacao%type;


BEGIN

select	max(cd_estabelecimento),
		max(cd_moeda)
into STRICT	cd_estabelecimento_w,
		cd_moeda_w
from	adiantamento_pago
where	nr_adiantamento	= nr_adiantamento_p;

select	max(a.cd_moeda_ref)
into STRICT	cd_moeda_empresa_w
from	empresa a,
		estabelecimento b
where	a.cd_empresa			= b.cd_empresa
and		b.cd_estabelecimento	= cd_estabelecimento_w;

if (coalesce(cd_moeda_empresa_w, cd_moeda_w) <> cd_moeda_w) then
	vl_cotacao_w	:= obter_cotacao_moeda_financ(cd_moeda_w, clock_timestamp());
end if;

CALL atualizar_saldo_adiant_pago(nr_adiantamento_p, nm_usuario_p, vl_cotacao_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atual_saldo_adiant_pago_moeda (nr_adiantamento_p bigint, nm_usuario_p text) FROM PUBLIC;

