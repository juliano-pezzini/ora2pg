-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qt_set_accommodation ( nr_seq_agenda_quimio_p bigint, nr_seq_local_p bigint, dt_agenda_p timestamp, nm_usuario_p text, nr_minuto_duracao_p bigint DEFAULT NULL) AS $body$
DECLARE


nr_seq_paciente_w       bigint;
nr_seq_atendimento_w    bigint;
cd_estabelecimento_w    smallint;
dt_prevista_w           timestamp;
ds_msg_w                varchar(255);
ds_erro_w               varchar(255);


BEGIN

IF (nr_seq_agenda_quimio_p IS NOT NULL AND nr_seq_agenda_quimio_p::text <> '') THEN
    IF (nr_minuto_duracao_p IS NOT NULL AND nr_minuto_duracao_p::text <> '') THEN
        UPDATE paciente_atendimento
        SET qt_tempo_medic = nr_minuto_duracao_p
        WHERE nr_seq_atendimento = nr_seq_agenda_quimio_p;
        COMMIT;
    ELSE
        SELECT
            paciente_atendimento.nr_seq_paciente,
            paciente_atendimento.nr_seq_atendimento,
            paciente_atendimento.cd_estabelecimento,
            paciente_atendimento.dt_prevista
        INTO STRICT
            nr_seq_paciente_w,
            nr_seq_atendimento_w,
            cd_estabelecimento_w,
            dt_prevista_w
        FROM paciente_atendimento
        WHERE paciente_atendimento.nr_seq_atendimento = nr_seq_agenda_quimio_p;

        IF (nr_seq_atendimento_w IS NOT NULL AND nr_seq_atendimento_w::text <> '') THEN -- There is result
            SELECT * FROM definir_acomodacao_quimio(
                nr_seq_paciente_p       =>  nr_seq_paciente_w, nr_seq_atendimento_p    =>  nr_seq_atendimento_w, cd_acomodacao_p         =>  nr_seq_local_p, dt_prevista_p           =>  dt_prevista_w, dt_real_p               =>  dt_agenda_p, nm_usuario_p            =>  nm_usuario_p, cd_estabelecimento_p    =>  cd_estabelecimento_w, ds_msg_p                =>  ds_msg_w, ds_erro_p               =>  ds_erro_w
            ) INTO STRICT ds_msg_p                =>  ds_msg_w, ds_erro_p               =>  ds_erro_w
;

            IF (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') THEN
                CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_erro_w);
            END IF;

        ELSE
            CALL wheb_mensagem_pck.exibir_mensagem_abort(1085655);
        END IF;
    END IF;
END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qt_set_accommodation ( nr_seq_agenda_quimio_p bigint, nr_seq_local_p bigint, dt_agenda_p timestamp, nm_usuario_p text, nr_minuto_duracao_p bigint DEFAULT NULL) FROM PUBLIC;

