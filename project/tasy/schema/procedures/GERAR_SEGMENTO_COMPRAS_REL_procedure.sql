-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_segmento_compras_rel ( nm_usuario_p text, cd_empresa_p bigint, ie_tipo_geracao_p text default 'S') AS $body$
DECLARE



nr_seq_seg_compras_rel_w			bigint;
nr_seq_segmento_w			bigint;
cd_estab_segmento_w			smallint;
cd_estabelecimento_w			smallint;
cd_grupo_material_w			bigint;
cd_subgrupo_material_w			bigint;
cd_classe_material_w			bigint;
cd_material_w				bigint;
nr_seq_familia_w				bigint;
qt_existe_w				bigint;
nr_ordem_compra_w			bigint;
nr_solic_compra_w				bigint;
nr_solic_compra_ww				bigint;
ds_segmento_w				varchar(255);
ds_grupo_segmento_w			varchar(255);
dt_emissao_oc_w				timestamp;
cd_cgc_fornecedor_w			varchar(14);
cd_pessoa_fisica_w			varchar(10);
ie_aprovada_w				varchar(1);
qt_material_w				double precision;
dt_prevista_Entrega_w			timestamp;
cd_comprador_oc_w			varchar(10);
qt_consumo_dia_ant_w			double precision;
qt_consumo_7_dias_w			double precision;
qt_consumo_15_dias_w			double precision;
qt_consumo_30_dias_w			double precision;
qt_consumo_60_dias_w			double precision;
qt_consumo_90_dias_w			double precision;
qt_consumo_120_dias_w			double precision;
qt_consumo_150_dias_w			double precision;
qt_consumo_180_dias_w			double precision;
qt_media_consumo_mes01_w			double precision;
qt_media_consumo_mes02_w			double precision;
qt_media_consumo_mes03_w			double precision;
qt_media_maior_w				double precision;
ie_consignado_w				varchar(15);
qt_consumo_base_calculo_w			double precision;
qt_saldo_almoxarifado_w			double precision;
qt_saldo_farmacia_w			double precision;
qt_saldo_farm_cc_w			double precision;
qt_saldo_total_w				segmento_compras_rel_it.qt_saldo_total%type;
qt_cobertura_almoxarifado_w			double precision;
qt_cobertura_farmacia_w			double precision;
qt_dias_cobertura_agrup_w			double precision;
qt_dias_cobertura_param_w			double precision;
vl_custo_medio_w				segmento_compras_rel_it.vl_custo_medio%type;
vl_estoque_w				segmento_compras_rel_it.vl_estoque%type;
qt_ordem_total_w				double precision;
qt_compra_melhor_w			double precision;
qt_dia_compra_w				double precision;
qt_dia_ressup_forn_w			smallint;
qt_dia_frequencia_w			double precision;
qt_estoque_minimo_w			double precision;
qt_eseg_w				double precision;
ds_motivo_w				varchar(255);
ie_solucao_w				varchar(1);
ds_mat_substituto_w			varchar(255);
ds_lista_mat_subst_w			varchar(4000);
qt_saldo_externo_w			double precision;
nr_seq_grupo_seg_w			bigint;
dt_falta_w				timestamp;
ie_consistencia_w			varchar(15);

nr_seq_parecer_origem_w			bigint;
cd_pessoa_parecer_w			varchar(10);
cd_setor_parecer_w			integer;
nr_seq_item_rel_par_w			bigint;
dt_liberacao_w				timestamp;
ds_parecer_w				varchar(4000);
dt_liberacao_parec_w			timestamp;
nm_usuario_lib_parec_w			varchar(15);
nr_seq_item_rel_orig_w			bigint;
nr_seq_parec_orig_w			bigint;
dt_atualizacao_nrec_w			timestamp;
nm_usuario_nrec_w			varchar(15);
nr_seq_item_w				bigint;
qt_dias_parecer_w				integer;
nr_seq_parecer_w				bigint;
nr_seq_rel_anterior_w			bigint;
ds_modalidade_w				varchar(255);
ie_modalidade_w				varchar(15);
vl_fatur_minimo_w			double precision;
cd_cnpj_contratado_w			varchar(14);
cd_comprador_regra_w			varchar(10);
qt_pendente_oc_w			double precision;
dt_prevista_solic_w			timestamp;
dt_prevista_ordem_w			timestamp;
nr_documento_w				bigint;
tp_documento_w				varchar(14);
qt_pendente_w				double precision;
cd_grupo_material_ww			smallint;

c00 CURSOR FOR
SELECT	a.nr_sequencia,
	ds_grupo,
	qt_dias_cobertura
from	grupo_segmento_compras a
where	ie_tipo_geracao_p = 'G'
and	exists 	(SELECT	1
		from	segmento_compras x
		where	x.ie_situacao = 'A'
		and	((coalesce(x.cd_empresa::text, '') = '') or (x.cd_empresa = cd_empresa_p))
		and	exists (select	1
				from	segmento_compras_estrut y
				where	y.nr_seq_segmento = x.nr_sequencia))

union

select	0,
	'',
	0

where	ie_tipo_geracao_p <> 'G';

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.cd_estabelecimento,
	a.ds_Segmento,
	coalesce(a.qt_dia_compra,0),
	coalesce(a.qt_dia_frequencia,0)
from	segmento_compras a
where	ie_tipo_geracao_p <> 'G'
and	a.ie_situacao = 'A'
and	((coalesce(a.cd_empresa::text, '') = '') or (a.cd_empresa = cd_empresa_p))
and exists (
	SELECT	1
	from	segmento_compras_estrut x
	where	x.nr_seq_segmento = a.nr_Sequencia)

union

select	a.nr_sequencia,
	a.cd_estabelecimento,
	a.ds_segmento,
	coalesce(c.qt_dia_compra,0),
	coalesce(c.qt_dia_frequencia,0)
from	segmento_compras a,
	segmento_compra_vinc_grupo b,
	grupo_segmento_compras c
where	ie_tipo_geracao_p = 'G'
and	b.nr_seq_grupo = nr_seq_grupo_seg_w
and	b.nr_seq_grupo = c.nr_sequencia
and	a.nr_sequencia = b.nr_seq_segmento
and	a.ie_situacao = 'A'
and	((coalesce(a.cd_empresa::text, '') = '') or (a.cd_empresa = cd_empresa_p))
and exists (
	select	1
	from	segmento_compras_estrut x
	where	x.nr_seq_segmento = a.nr_Sequencia);

c02 CURSOR FOR
SELECT	cd_estabelecimento
from	estabelecimento
where	ie_situacao = 'A'
and	cd_empresa = cd_empresa_p
and	((coalesce(cd_estab_segmento_w::text, '') = '') or (cd_estabelecimento = cd_estab_segmento_w));

c03 CURSOR FOR
SELECT	cd_grupo_material,
	cd_subgrupo_material,
	cd_classe_material,
	cd_material,
	nr_seq_familia,
	(obter_dados_material(cd_material,'MC'))::numeric
from	segmento_compras_estrut
where	nr_seq_segmento = nr_seq_segmento_w
and	(cd_material IS NOT NULL AND cd_material::text <> '');

/*Para buscar a ordem de compra pendente de entrega mais antiga*/

c05 CURSOR FOR
SELECT	a.nr_ordem_compra,
	trunc(b.dt_prevista_entrega,'dd')
from	ordem_compra a,
	ordem_compra_v b
where	a.nr_ordem_compra = b.nr_ordem_compra
and	coalesce(a.dt_baixa::text, '') = ''
and	coalesce(a.nr_seq_motivo_cancel::text, '') = ''
and	a.cd_estabelecimento = cd_estabelecimento_w
and	b.cd_material = cd_material_w
and	coalesce(b.dt_cancelamento::text, '') = ''
and	coalesce(b.qt_real_entrega,0) < b.qt_prevista_entrega
order by dt_prevista_entrega desc;

c06 CURSOR FOR
SELECT	a.nr_solic_compra,
	trunc(c.dt_entrega_solicitada,'dd')
from	solic_compra a,
	solic_compra_item b,
	solic_compra_item_entrega c
where	a.nr_solic_compra = b.nr_solic_compra
and	b.nr_solic_compra = c.nr_solic_compra
and	b.nr_item_solic_compra = c.nr_item_solic_compra
and	coalesce(a.nr_seq_motivo_cancel::text, '') = ''
and	a.cd_estabelecimento = cd_estabelecimento_w
and	b.cd_material = cd_material_w
and	coalesce(b.dt_baixa::text, '') = ''
order by dt_entrega_solicitada desc;

c07 CURSOR FOR
SELECT	substr(substr(obter_desc_material(b.cd_material),1,80) || substr(Wheb_mensagem_pck.get_texto(456005, 'cod=' || b.cd_material),1,20),1,100)
from	sup_regra_subs_material a,
	sup_lista_subs_material b
where	a.nr_sequencia = b.nr_seq_regra
and	a.cd_estabelecimento = cd_estabelecimento_w
and	a.cd_material = cd_material_w
and	coalesce(a.ie_solicitacao,'N') = 'S'
order by	ie_ordem;

c08 CURSOR FOR
SELECT	a.nr_sequencia,
	a.cd_pessoa_fisica,
	a.cd_setor_atendimento,
	a.nr_seq_item_rel,
	a.dt_liberacao,
	a.ds_parecer,
	a.dt_liberacao_parec,
	a.nm_usuario_lib_parec,
	a.nr_seq_item_rel_orig,
	a.nr_seq_origem,
	a.dt_atualizacao_nrec,
	a.nm_usuario_nrec
from	segmento_compras_rel_parec a,
	segmento_compras_rel_it b
where	a.nr_seq_item_rel = b.nr_sequencia
and	b.nr_seq_seg_rel = nr_seq_rel_anterior_w
and	b.cd_estabelecimento = cd_estabelecimento_w
and	b.cd_material = cd_material_w
and	(a.dt_liberacao_parec IS NOT NULL AND a.dt_liberacao_parec::text <> '')
and (trunc(clock_timestamp()) - qt_dias_parecer_w) <= trunc(a.dt_atualizacao_nrec)
order by	a.nr_sequencia;

c09 CURSOR FOR
SELECT	a.nr_solic_compra
from	solic_compra a,
	solic_compra_item b,
	solic_compra_item_entrega c
where	a.nr_solic_compra = b.nr_solic_compra
and	b.nr_solic_compra = c.nr_solic_compra
and	b.nr_item_solic_compra = c.nr_item_solic_compra
and	coalesce(a.nr_seq_motivo_cancel::text, '') = ''
and	a.cd_estabelecimento = cd_estabelecimento_w
and	b.cd_material = cd_material_w
and	coalesce(b.dt_baixa::text, '') = ''
order by dt_entrega_solicitada desc;


BEGIN

select	nextval('segmento_compras_rel_seq')
into STRICT	nr_seq_seg_compras_rel_w
;

insert into segmento_compras_rel(
	nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	dt_geracao)
values (	nr_seq_seg_compras_rel_w,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp());

select	coalesce(max(nr_sequencia),0)
into STRICT	nr_seq_rel_anterior_w
from	segmento_compras_rel a
where	nr_sequencia <> nr_seq_seg_compras_rel_w
and	exists (SELECT	1
		from	segmento_compras_rel_it x
		where	x.cd_empresa = cd_empresa_p);

open C00;
loop
fetch C00 into
	nr_seq_grupo_seg_w,
	ds_grupo_segmento_w,
	qt_dias_cobertura_agrup_w;
EXIT WHEN NOT FOUND; /* apply on C00 */
	begin

	open C01;
	loop
	fetch C01 into
		nr_seq_segmento_w,
		cd_estab_segmento_w,
		ds_Segmento_w,
		qt_dia_compra_w,
		qt_dia_frequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		open C02;
		loop
		fetch C02 into
			cd_estabelecimento_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin

			select	coalesce(max(qt_dias_cobertura),0)
			into STRICT	qt_dias_cobertura_param_w
			from	parametro_compras
			where	cd_estabelecimento = cd_estabelecimento_w;

			open C03;
			loop
			fetch C03 into
				cd_grupo_material_w,
				cd_subgrupo_material_w,
				cd_classe_material_w,
				cd_material_w,
				nr_seq_familia_w,
				qt_compra_melhor_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin

				dt_prevista_entrega_w 		:= null;
				nr_ordem_compra_w		:= null;
				dt_emissao_oc_w			:= null;
				nr_solic_compra_w			:= null;
				cd_cgc_fornecedor_w		:= '';
				cd_pessoa_fisica_w		:= '';
				ie_aprovada_w			:= 'N';
				cd_comprador_oc_w		:= '';
				qt_material_w			:= 0;
				qt_consumo_dia_ant_w		:= 0;
				qt_consumo_7_dias_w		:= 0;
				qt_consumo_15_dias_w		:= 0;
				qt_consumo_30_dias_w		:= 0;
				qt_consumo_60_dias_w		:= 0;
				qt_consumo_90_dias_w		:= 0;
				qt_consumo_120_dias_w		:= 0;
				qt_consumo_150_dias_w		:= 0;
				qt_consumo_180_dias_w		:= 0;
				qt_media_maior_w			:= 0;
				qt_cobertura_almoxarifado_w		:= 0;
				qt_cobertura_farmacia_w		:= 0;
				qt_saldo_almoxarifado_w		:= 0;
				qt_saldo_farmacia_w		:= 0;
				qt_saldo_farm_cc_w		:= 0;
				qt_saldo_total_w			:= 0;
				vl_estoque_w			:= 0;
				vl_custo_medio_w			:= 0;
				qt_ordem_total_w			:= 0;
				qt_dia_ressup_forn_w		:= 0;
				qt_estoque_minimo_w		:= 0;
				qt_eseg_w			:= 0;

				select	count(*)
				into STRICT	qt_existe_w
				from	segmento_compras_rel_it
				where	nr_seq_seg_rel = nr_seq_seg_compras_rel_w
				and	cd_estabelecimento = cd_estabelecimento_w
				and	cd_material = cd_material_w;

					nr_documento_w	:= null;
					tp_documento_w	:= '';
					qt_pendente_w	:= null;				
				
				if (qt_existe_w = 0) then

					select	count(*)
					into STRICT	qt_existe_w
					from	material_estab
					where	cd_material = cd_material_w
					and	cd_estabelecimento = cd_estabelecimento_w;

					if (qt_existe_w > 0) then
						select	coalesce(qt_dia_ressup_forn,0),
							coalesce(qt_dia_estoque_minimo,0)
						into STRICT	qt_dia_ressup_forn_w,
							qt_estoque_minimo_w
						from	material_estab
						where	cd_material = cd_material_w
						and	cd_estabelecimento = cd_estabelecimento_w;
					end if;

					open C05;
					loop
					fetch C05 into
						nr_ordem_compra_w,
						dt_prevista_entrega_w;
					EXIT WHEN NOT FOUND; /* apply on C05 */
						begin
						nr_ordem_compra_w 	:= nr_ordem_compra_w;
						dt_prevista_entrega_w	:= dt_prevista_entrega_w;
						end;
					end loop;
					close C05;

					dt_prevista_ordem_w		:= dt_prevista_entrega_w;

					if (nr_ordem_compra_w > 0) then
						qt_material_w := 0;
						select	trunc(a.dt_ordem_compra,'dd'),
							a.cd_cgc_fornecedor,
							a.cd_pessoa_fisica,
							CASE WHEN a.dt_aprovacao='' THEN 'N'  ELSE 'S' END ,
							a.cd_comprador
						into STRICT	dt_emissao_oc_w,
							cd_cgc_fornecedor_w,
							cd_pessoa_fisica_w,
							ie_aprovada_w,
							cd_comprador_oc_w
						from	ordem_Compra a
						where	nr_ordem_compra = nr_ordem_Compra_w;

						select	sum(qt_material)
						into STRICT	qt_material_w
						from	ordem_compra_item a
						where	nr_ordem_compra = nr_ordem_compra_w
						and	cd_Material = cd_material_w;
						
						
						qt_pendente_w := qt_material_w;
						nr_documento_w	:= nr_ordem_compra_w;
						tp_documento_w	:= 'OC';
						
						
					else
						qt_material_w		:= 0;
						dt_prevista_entrega_w	:= null;
						open C06;
						loop
						fetch C06 into
							nr_solic_compra_w,
							dt_prevista_entrega_w;
						EXIT WHEN NOT FOUND; /* apply on C06 */
							begin
							nr_solic_compra_w	:= nr_solic_compra_w;
							dt_prevista_entrega_w	:= dt_prevista_entrega_w;
							end;
						end loop;
						close C06;

						if (nr_solic_compra_w > 0) then

							
							select	sum(qt_material)
							into STRICT	qt_material_w
							from	solic_compra_item
							where	nr_solic_compra = nr_solic_compra_w
							and	cd_material	= cd_material_w;
							
							
							--dt_emissao_oc_w := null;

							--cd_cgc_fornecedor_w := null;

							--cd_pessoa_fisica_w := null;

							--ie_aprovada_w := null;
							cd_comprador_oc_w := null;
							qt_pendente_w := qt_material_w;
							nr_documento_w	:= nr_solic_compra_w;
							tp_documento_w	:= 'SC';
							
						end if;
					end if;


					/*nr_documento_w	:= null;
					tp_documento_w	:= ''; 
					qt_pendente_w	:= null;*/
					open C06;
					loop
					fetch C06 into
						nr_solic_compra_w,
						dt_prevista_solic_w;
					EXIT WHEN NOT FOUND; /* apply on C06 */
						begin
						nr_solic_compra_w	:= nr_solic_compra_w;
						dt_prevista_solic_w	:= dt_prevista_solic_w;
						end;
					end loop;
					close C06;

					if	((coalesce(dt_prevista_ordem_w::text, '') = '') or (dt_prevista_ordem_w > dt_prevista_solic_w)) then






						if (nr_solic_compra_w > 0) then

							select	sum(qt_material)
							into STRICT	qt_pendente_w
							from	solic_compra_item
							where	nr_solic_compra = nr_solic_compra_w
							and	cd_material	= cd_material_w;

							
							--dt_emissao_oc_w := null;

							--cd_cgc_fornecedor_w := null;

							--cd_pessoa_fisica_w := null;

							--ie_aprovada_w := null;
							cd_comprador_oc_w := null;							
							nr_documento_w	:= nr_solic_compra_w;
							tp_documento_w	:= 'SC';
							qt_pendente_w := qt_material_w;
							
						end if;

					else






						if (nr_ordem_compra_w > 0) then

							qt_material_w := 0;
						
							select	sum(qt_material)
							into STRICT	qt_material_w
							from	ordem_compra_item a
							where	nr_ordem_compra = nr_ordem_compra_w
							and	cd_Material = cd_material_w;
							
							nr_documento_w	:= nr_ordem_compra_w;
							tp_documento_w	:= 'OC';
							qt_pendente_w := qt_material_w;
						end if;

					end if;

					

					/*CONSUMO DIA ANTERIOR*/

					select	coalesce(sum(qt_consumo),0) qt_consumo_ant
					into STRICT	qt_consumo_dia_ant_w
					from   	movimento_estoque_v a,
						material m
					where  	a.cd_material_estoque	= m.cd_material_estoque
					and  	m.cd_material         	= cd_material_w
					and  	a.cd_estabelecimento 	= cd_estabelecimento_w
					and  	trunc(dt_movimento_estoque,'dd') = trunc(clock_timestamp() - interval '1 days','dd')
					and 	((not exists (
							SELECT   1
							from	operacao_nota x
							where	x.cd_operacao_estoque = a.cd_operacao_estoque
							and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
							and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));
					/*CONSUMO 7 DIAS*/

					select	dividir(coalesce(sum(qt_consumo),0),7) qt_consumo_ant
					into STRICT	qt_consumo_7_dias_w
					from   	movimento_estoque_v a,
						material m
					where  	a.cd_material_estoque	= m.cd_material_estoque
					and  	m.cd_material         	= cd_material_w
					and  	a.cd_estabelecimento 	= cd_estabelecimento_w
					and  	trunc(dt_movimento_estoque,'dd') between trunc(clock_timestamp() - interval '7 days','dd') and trunc(clock_timestamp() - interval '1 days','dd')
					and 	((not exists (
							SELECT   1
							from	operacao_nota x
							where	x.cd_operacao_estoque = a.cd_operacao_estoque
							and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
							and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));

					/*CONSUMO 15 DIAS*/

					select	dividir(coalesce(sum(qt_consumo),0),15) qt_consumo_ant
					into STRICT	qt_consumo_15_dias_w
					from   	movimento_estoque_v a,
						material m
					where  	a.cd_material_estoque	= m.cd_material_estoque
					and  	m.cd_material         	= cd_material_w
					and  	a.cd_estabelecimento 	= cd_estabelecimento_w
					and  	trunc(dt_movimento_estoque,'dd') between trunc(clock_timestamp() - interval '15 days','dd') and trunc(clock_timestamp() - interval '1 days','dd')
					and 	((not exists (
							SELECT	1
							from	operacao_nota x
							where	x.cd_operacao_estoque = a.cd_operacao_estoque
							and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
							and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));

					/*cONSUMO 30 DIAS*/

					select	dividir(coalesce(sum(qt_consumo),0),30) qt_consumo_ant
					into STRICT	qt_consumo_30_dias_w
					from   	movimento_estoque_v a,
						material m
					where  	a.cd_material_estoque	= m.cd_material_estoque
					and  	m.cd_material         	= cd_material_w
					and  	a.cd_estabelecimento 	= cd_estabelecimento_w
					and  	trunc(dt_movimento_estoque,'dd') between trunc(clock_timestamp() - interval '30 days','dd') and trunc(clock_timestamp() - interval '1 days','dd')
					and 	((not exists (
							SELECT  1
							from	operacao_nota x
							where	x.cd_operacao_estoque = a.cd_operacao_estoque
							and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
							and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));

					/*CONSUMO 60 DIAS*/

					select	dividir(coalesce(sum(qt_consumo),0),60) qt_consumo_ant
					into STRICT	qt_consumo_60_dias_w
					from   	movimento_estoque_v a,
						material m
					where  	a.cd_material_estoque	= m.cd_material_estoque
					and  	m.cd_material         	= cd_material_w
					and  	a.cd_estabelecimento 	= cd_estabelecimento_w
					and  	trunc(dt_movimento_estoque,'dd') between trunc(clock_timestamp() - interval '60 days','dd') and trunc(clock_timestamp() - interval '1 days','dd')
					and 	((not exists (
							SELECT	1
							from	operacao_nota x
							where	x.cd_operacao_estoque = a.cd_operacao_estoque
							and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
							and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));

					/*CONSUMO 90 DIAS*/

					select	dividir(coalesce(sum(qt_consumo),0),90) qt_consumo_ant
					into STRICT	qt_consumo_90_dias_w
					from   	movimento_estoque_v a,
						material m
					where  	a.cd_material_estoque	= m.cd_material_estoque
					and  	m.cd_material         	= cd_material_w
					and  	a.cd_estabelecimento 	= cd_estabelecimento_w
					and  	trunc(dt_movimento_estoque,'dd') between trunc(clock_timestamp() - interval '90 days','dd') and trunc(clock_timestamp() - interval '1 days','dd')
					and 	((not exists (
							SELECT	1
							from	operacao_nota x
							where	x.cd_operacao_estoque = a.cd_operacao_estoque
							and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
							and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));


					/*CONSUMO 120 DIAS*/

					select	dividir(coalesce(sum(qt_consumo),0),120) qt_consumo_ant
					into STRICT	qt_consumo_120_dias_w
					from   	movimento_estoque_v a,
						material m
					where  	a.cd_material_estoque	= m.cd_material_estoque
					and  	m.cd_material         	= cd_material_w
					and  	a.cd_estabelecimento 	= cd_estabelecimento_w
					and  	trunc(dt_movimento_estoque,'dd') between trunc(clock_timestamp() - interval '120 days','dd') and trunc(clock_timestamp() - interval '1 days','dd')
					and 	((not exists (
							SELECT	1
							from	operacao_nota x
							where	x.cd_operacao_estoque = a.cd_operacao_estoque
							and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
							and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));

					/*CONSUMO 150 DIAS*/

					select	dividir(coalesce(sum(qt_consumo),0),150) qt_consumo_ant
					into STRICT	qt_consumo_150_dias_w
					from   	movimento_estoque_v a,
						material m
					where  	a.cd_material_estoque	= m.cd_material_estoque
					and  	m.cd_material         	= cd_material_w
					and  	a.cd_estabelecimento 	= cd_estabelecimento_w
					and  	trunc(dt_movimento_estoque,'dd') between trunc(clock_timestamp() - interval '150 days','dd') and trunc(clock_timestamp() - interval '1 days','dd')
					and 	((not exists (
							SELECT	1
							from	operacao_nota x
							where	x.cd_operacao_estoque = a.cd_operacao_estoque
							and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
							and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));

					/*CONSUMO 180 DIAS*/

					select	dividir(coalesce(sum(qt_consumo),0),180) qt_consumo_ant
					into STRICT	qt_consumo_180_dias_w
					from   	movimento_estoque_v a,
						material m
					where  	a.cd_material_estoque	= m.cd_material_estoque
					and  	m.cd_material         	= cd_material_w
					and  	a.cd_estabelecimento 	= cd_estabelecimento_w
					and  	trunc(dt_movimento_estoque,'dd') between trunc(clock_timestamp() - interval '180 days','dd') and trunc(clock_timestamp() - interval '1 days','dd')
					and 	((not exists (
							SELECT	1
							from	operacao_nota x
							where	x.cd_operacao_estoque = a.cd_operacao_estoque
							and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
							and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));


					/*MEDIA DO CONSUMO DO MES ANTERIOR*/

					select	dividir(coalesce(sum(qt_consumo),0),obter_qt_dias_mes(add_months(trunc(clock_timestamp(),'mm'),-1)))
					into STRICT	qt_media_consumo_mes01_w
					from   	movimento_estoque_v a,
						material m
					where  	a.cd_material_estoque	= m.cd_material_estoque
					and  	m.cd_material         	= cd_material_w
					and  	a.cd_estabelecimento 	= cd_estabelecimento_w
					and  	a.dt_mesano_referencia = add_months(trunc(clock_timestamp(),'mm'),-1)
					and 	((not exists (
								SELECT  1
								from	operacao_nota x
								where	x.cd_operacao_estoque = a.cd_operacao_estoque
								and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
								and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));

					/*MEDIA DO CONSUMO DO 2 MES ANTERIOR*/

					select	dividir(coalesce(sum(qt_consumo),0),obter_qt_dias_mes(add_months(trunc(clock_timestamp(),'mm'),-2)))
					into STRICT	qt_media_consumo_mes02_w
					from   	movimento_estoque_v a,
						material m
					where  	a.cd_material_estoque	= m.cd_material_estoque
					and  	m.cd_material         	= cd_material_w
					and  	a.cd_estabelecimento 	= cd_estabelecimento_w
					and  	a.dt_mesano_referencia = add_months(trunc(clock_timestamp(),'mm'),-2)
					and 	((not exists (
							SELECT	1
							from	operacao_nota x
							where	x.cd_operacao_estoque = a.cd_operacao_estoque
							and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
							and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));

					/*MEDIA DO CONSUMO DO 3 MES ANTERIOR*/

					select	dividir(coalesce(sum(qt_consumo),0),obter_qt_dias_mes(add_months(trunc(clock_timestamp(),'mm'),-3)))
					into STRICT	qt_media_consumo_mes03_w
					from   	movimento_estoque_v a,
						material m
					where  	a.cd_material_estoque	= m.cd_material_estoque
					and  	m.cd_material         	= cd_material_w
					and  	a.cd_estabelecimento 	= cd_estabelecimento_w
					and  	a.dt_mesano_referencia = add_months(trunc(clock_timestamp(),'mm'),-3)
					and 	((not exists (
							SELECT  1
							from	operacao_nota x
							where	x.cd_operacao_estoque = a.cd_operacao_estoque
							and	coalesce(x.ie_transferencia_estab, 'N') = 'S'))
							and (a.cd_centro_custo IS NOT NULL AND a.cd_centro_custo::text <> ''));

					qt_media_maior_w	:= qt_media_consumo_mes01_w;

					if (qt_media_consumo_mes02_w > qt_media_maior_w) then
						qt_media_maior_w := qt_media_consumo_mes02_w;
					end if;

					if (qt_media_consumo_mes03_w > qt_media_maior_w) then
						qt_media_maior_w := qt_media_consumo_mes03_w;
					end if;

					qt_consumo_base_calculo_w := qt_consumo_7_dias_w;
					if (qt_consumo_base_calculo_w = 0) then
						qt_consumo_base_calculo_w := qt_consumo_15_dias_w;
					elsif (qt_consumo_base_calculo_w = 0) then
						qt_consumo_base_calculo_w := qt_consumo_30_dias_w;
					elsif (qt_consumo_base_calculo_w = 0) then
						qt_consumo_base_calculo_w := qt_consumo_60_dias_w;
					elsif (qt_consumo_base_calculo_w = 0) then
						qt_consumo_base_calculo_w := qt_consumo_90_dias_w;
					elsif (qt_consumo_base_calculo_w = 0) then
						qt_consumo_base_calculo_w := qt_consumo_120_dias_w;
					elsif (qt_consumo_base_calculo_w = 0) then
						qt_consumo_base_calculo_w := qt_consumo_150_dias_w;
					elsif (qt_consumo_base_calculo_w = 0) then
						qt_consumo_base_calculo_w := qt_consumo_180_dias_w;
					end if;

					select	coalesce(sum(obter_saldo_disp_estoque(cd_estabelecimento_w, cd_material_w, cd_local_estoque, trunc(clock_timestamp(),'mm'))),0)
					into STRICT	qt_saldo_almoxarifado_w
					from	local_estoque
					where	ie_tipo_local = 4
					and	cd_estabelecimento = cd_estabelecimento_w;

					select	coalesce(sum(obter_saldo_disp_estoque(cd_estabelecimento_w, cd_material_w, cd_local_estoque, trunc(clock_timestamp(),'mm'))),0)
					into STRICT	qt_saldo_farmacia_w
					from	local_estoque
					where	ie_tipo_local in (1,2)
					and	cd_estabelecimento = cd_estabelecimento_w;

					select	coalesce(sum(obter_saldo_disp_estoque(cd_estabelecimento_w, cd_material_w, cd_local_estoque, trunc(clock_timestamp(),'mm'))),0)
					into STRICT	qt_saldo_farm_cc_w
					from	local_estoque
					where	ie_tipo_local in (2)
					and	cd_estabelecimento = cd_estabelecimento_w;					

					select	coalesce(sum(obter_saldo_disp_estoque(cd_estabelecimento_w, cd_material_w, cd_local_estoque, trunc(clock_timestamp(),'mm'))),0)
					into STRICT	qt_saldo_externo_w
					from	local_estoque
					where	coalesce(ie_externo,'N') = 'S'
					and	cd_estabelecimento = cd_estabelecimento_w;

					select	coalesce(sum(obter_saldo_disp_estoque(a.cd_estabelecimento, cd_material, cd_local_estoque, dt_mesano_referencia)),0),
						coalesce(max(obter_custo_medio_material(a.cd_estabelecimento, PKG_DATE_UTILS.start_of(clock_timestamp(), 'MONTH', 0), cd_material)),0)
					into STRICT	qt_saldo_total_w,
						vl_custo_medio_w
					from	saldo_estoque a
					where	a.dt_mesano_referencia = trunc(clock_timestamp(),'mm')
					and	a.cd_estabelecimento = cd_Estabelecimento_w
					and	a.cd_material = cd_material_w;
					
					if (vl_custo_medio_w = 0) then
						vl_custo_medio_w := coalesce(obter_ult_custo_medio_mat(cd_estabelecimento_w,cd_material_w),0);					
					end if;
					
					begin
					vl_estoque_w := trunc((qt_saldo_total_w * vl_custo_medio_w),4);
					exception
					when data_exception then
					vl_estoque_w := 0;
					end;

					select	coalesce(sum(qt_compra),0)
					into STRICT	qt_ordem_total_w
					from	compra_pendente_v2
					where	cd_material = cd_material_w
					and	cd_estabelecimento = cd_estabelecimento_w
					and	nr_documento > 0;

					select	coalesce(sum(qt_compra),0)
					into STRICT	qt_pendente_oc_w
					from	compra_pendente_v2
					where	cd_material = cd_material_w
					and	cd_estabelecimento = cd_estabelecimento_w
					and	nr_documento > 0
					and	ie_tipo_documento = 'O';
					
					select	cd_grupo_material
					into STRICT	cd_grupo_material_ww
					from	estrutura_material_v
					where	cd_material = cd_material_w;

					ie_solucao_w		:= '';
					ds_motivo_w		:= '';
					ds_lista_mat_subst_w	:= '';
					dt_falta_w		:= null;

					select	max(ie_solucao),
						max(ds_motivo),
						max(dt_falta)
					into STRICT	ie_solucao_w,
						ds_motivo_w,
						dt_falta_w
					from	material_falta
					where	cd_material		= cd_material_w
					and	cd_estabelecimento	= cd_Estabelecimento_w
					and	coalesce(ie_solucao,'N')	= 'N';

					open C07;
					loop
					fetch C07 into
						ds_mat_substituto_w;
					EXIT WHEN NOT FOUND; /* apply on C07 */
						begin
						ds_lista_mat_subst_w	:= substr(ds_lista_mat_subst_w || ds_mat_substituto_w || ', ',1,4000);
						end;
					end loop;
					close C07;

					ds_lista_mat_subst_w	:= substr(ds_lista_mat_subst_w,1,length(ds_lista_mat_subst_w)-2);

					qt_cobertura_almoxarifado_w		:= coalesce(dividir(qt_saldo_almoxarifado_w,qt_consumo_base_calculo_w),0);
					qt_cobertura_farmacia_w		:= coalesce(dividir(qt_saldo_farmacia_w,qt_consumo_base_calculo_w),0);
					qt_eseg_w			:= qt_dia_compra_w - (qt_dia_frequencia_w + qt_dia_ressup_forn_w);

					ie_consistencia_w		:= '';

					if (dt_prevista_Entrega_w IS NOT NULL AND dt_prevista_Entrega_w::text <> '') and (dt_prevista_Entrega_w < clock_timestamp()) then
						ie_consistencia_w := 'PV';
					elsif (qt_dias_cobertura_param_w > 0) and (coalesce(qt_cobertura_almoxarifado_w,0) < qt_dias_cobertura_param_w) then
						ie_consistencia_w := 'LC';
					elsif (qt_dias_cobertura_param_w > 0) and (qt_dias_cobertura_agrup_w > 0) and (coalesce(qt_cobertura_almoxarifado_w,0) > qt_dias_cobertura_param_w) and (coalesce(qt_cobertura_almoxarifado_w,0) < qt_dias_cobertura_agrup_w) then
						ie_consistencia_w := 'MLC';
					end if;

					ie_modalidade_w		:= '';
					ds_modalidade_w 	:= '';
					vl_fatur_minimo_w	:= 0;
					cd_cnpj_contratado_w	:= '';
					cd_comprador_regra_w	:= '';

					select	obter_item_contrato_mercado(cd_material_w, cd_Estabelecimento_w)
					into STRICT	ie_modalidade_w
					;

					if (ie_modalidade_w = 'C') then
						ds_modalidade_w	:= wheb_mensagem_pck.get_texto(301996);

						select	(obter_dados_contrato_item(cd_material_w, 'FM'))::numeric ,
							obter_dados_contrato_item(cd_material_w, 'PJ')
						into STRICT	vl_fatur_minimo_w,
							cd_cnpj_contratado_w
						;


					elsif (ie_modalidade_w = 'M') then
						ds_modalidade_w	:= wheb_mensagem_pck.get_texto(302240);
					end if;
					nr_solic_compra_ww := null;
					open C09;
					loop
					fetch C09 into
						nr_solic_compra_ww;
					EXIT WHEN NOT FOUND; /* apply on C09 */
						begin
						nr_solic_compra_ww := nr_solic_compra_ww;
						end;
					end loop;
					close C09;

					select	obter_comprador_material(cd_material_w, 'N', cd_estabelecimento_w)
					into STRICT	cd_comprador_regra_w
					;

					select	nextval('segmento_compras_rel_it_seq')
					into STRICT	nr_seq_item_w
					;

					insert into segmento_compras_rel_it(
						nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_seq_seg_rel,
						nr_seq_segmento,
						nr_Seq_grupo_seg_compras,
						cd_empresa,
						cd_estabelecimento,
						cd_material,
						ds_segmento,
						ds_grupo_segmento,
						nr_ordem_compra,
						dt_emissao_oc,
						cd_cgc_fornec_oc,
						ie_aprovacao_oc,
						cd_pessoa_fisica_oc,
						qt_prevista_entrega_oc,
						dt_entrega_prevista_oc,
						cd_comprador_oc,
						qt_consumo_dia_ant,
						qt_consumo_7_dias,
						qt_consumo_15_dias,
						qt_consumo_30_dias,
						qt_consumo_60_dias,
						qt_consumo_90_dias,
						qt_consumo_120_dias,
						qt_consumo_150_dias,
						qt_consumo_180_dias,
						qt_maior_media_cons_3_meses,
						qt_cobertura_almox,
						qt_cobertura_farmacia,
						qt_saldo_almox,
						qt_saldo_farmacia,
						qt_saldo_farm_cc,
						qt_saldo_total,
						vl_estoque,
						vl_custo_medio,
						qt_ordem_total,
						qt_compra_melhor,
						qt_dia_compra,
						qt_dia_ressup_forn,
						qt_dia_frequencia,
						qt_estoque_minimo,
						qt_eseg,
						ie_falta_solucionada,
						ds_motivo_falta,
						ds_mat_substituto,
						qt_saldo_externo,
						dt_inicio_falta,
						ie_consistencia,
						ds_modalidade,
						vl_fatur_minimo,
						cd_cnpj_contratado,
						cd_comprador_regra,
						nr_solic_compra,
						qt_pendente_oc,
						nr_documento,
						tp_documento,
						qt_pendente,
						cd_grupo_material)
					values (	nr_seq_item_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_seg_compras_rel_w,
						nr_seq_segmento_w,
						CASE WHEN nr_seq_grupo_seg_w=0 THEN null  ELSE nr_seq_grupo_seg_w END ,
						cd_empresa_p,
						cd_estabelecimento_w,
						cd_material_w,
						ds_segmento_w,
						ds_grupo_segmento_w,
						CASE WHEN nr_ordem_compra_w=0 THEN null  ELSE nr_ordem_Compra_w END ,
						dt_emissao_oc_w,
						cd_cgc_fornecedor_w,
						ie_aprovada_w,
						cd_pessoa_fisica_w,
						qt_material_w,
						dt_prevista_Entrega_w,
						cd_comprador_oc_w,
						qt_consumo_dia_ant_w,
						qt_consumo_7_dias_w,
						qt_consumo_15_dias_w,
						qt_consumo_30_dias_w,
						qt_consumo_60_dias_w,
						qt_consumo_90_dias_w,
						qt_consumo_120_dias_w,
						qt_consumo_150_dias_w,
						qt_consumo_180_dias_w,
						qt_media_maior_w,
						qt_cobertura_almoxarifado_w,
						qt_cobertura_farmacia_w,
						qt_saldo_almoxarifado_w,
						qt_saldo_farmacia_w,
						qt_saldo_farm_cc_w,
						qt_saldo_total_w,
						vl_estoque_w,
						vl_custo_medio_w,
						qt_ordem_total_w,
						qt_compra_melhor_w,
						qt_dia_compra_w,
						qt_dia_ressup_forn_w,
						qt_dia_frequencia_w,
						qt_estoque_minimo_w,
						qt_eseg_w,
						ie_solucao_w,
						ds_motivo_w,
						ds_lista_mat_subst_w,
						qt_saldo_externo_w,
						dt_falta_w,
						ie_consistencia_w,
						ds_modalidade_w,
						vl_fatur_minimo_w,
						cd_cnpj_contratado_w,
						cd_comprador_regra_w,
						nr_solic_compra_ww,
						qt_pendente_oc_w,
						nr_documento_w,
						tp_documento_w,
						qt_pendente_w,
						cd_grupo_material_ww);

					select	coalesce(max(qt_dias_parecer),0)
					into STRICT	qt_dias_parecer_w
					from	parametro_compras
					where	cd_estabelecimento = cd_estabelecimento_w;

					if (qt_dias_parecer_w > 0) then
						begin

						open c08;
						loop
						fetch c08 into
							nr_seq_parecer_origem_w,
							cd_pessoa_parecer_w,
							cd_setor_parecer_w,
							nr_seq_item_rel_par_w,
							dt_liberacao_w,
							ds_parecer_w,
							dt_liberacao_parec_w,
							nm_usuario_lib_parec_w,
							nr_seq_item_rel_orig_w,
							nr_seq_parec_orig_w,
							dt_atualizacao_nrec_w,
							nm_usuario_nrec_w;
						EXIT WHEN NOT FOUND; /* apply on c08 */
							begin

							select	nextval('segmento_compras_rel_parec_seq')
							into STRICT	nr_seq_parecer_w
							;

							insert into segmento_compras_rel_parec(
								nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								cd_pessoa_fisica,
								cd_setor_atendimento,
								nr_seq_item_rel,
								dt_liberacao,
								dt_liberacao_parec,
								nm_usuario_lib_parec,
								ds_parecer,
								nr_seq_item_rel_orig,
								nr_seq_origem)
							values (
								nr_seq_parecer_w,
								clock_timestamp(),
								nm_usuario_p,
								dt_atualizacao_nrec_w,
								nm_usuario_nrec_w,
								cd_pessoa_parecer_w,
								cd_setor_parecer_w,
								nr_seq_item_w,
								dt_liberacao_w,
								dt_liberacao_parec_w,
								nm_usuario_lib_parec_w,
								ds_parecer_w,
								coalesce(nr_seq_item_rel_orig_w,nr_seq_item_rel_par_w),
								coalesce(nr_seq_parec_orig_w,nr_seq_parecer_origem_w));

							end;
						end loop;
						close c08;

						end;
					end if;

				end if;
				end;

			end loop;
			close C03;
			end;

		end loop;
		close C02;
		end;

	end loop;
	close C01;

	end;
end loop;
close C00;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_segmento_compras_rel ( nm_usuario_p text, cd_empresa_p bigint, ie_tipo_geracao_p text default 'S') FROM PUBLIC;

