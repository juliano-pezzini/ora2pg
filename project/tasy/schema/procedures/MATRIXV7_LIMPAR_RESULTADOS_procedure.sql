-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE matrixv7_limpar_resultados ( nr_prescricao_p bigint, cd_exame_p text, nr_seq_prescr_p bigint DEFAULT 0) AS $body$
DECLARE


    nr_seq_prescr_w      prescr_procedimento.nr_sequencia%TYPE;
    nr_seq_exame_w       prescr_procedimento.nr_seq_exame%TYPE;
    nr_seq_resultado_w   exame_lab_resultado.nr_seq_resultado%TYPE;

BEGIN
	
    if (coalesce(nr_seq_prescr_p,0) = 0) then
		nr_seq_prescr_w := matrixv7_get_nr_seq_prescr(nr_prescricao_p, cd_exame_p);
	else
		nr_seq_prescr_w := 	nr_seq_prescr_p;
	end if;

    SELECT nr_seq_exame
    INTO STRICT nr_seq_exame_w
    FROM prescr_procedimento
    WHERE nr_prescricao = nr_prescricao_p AND nr_sequencia = nr_seq_prescr_w;

    BEGIN
        SELECT nr_seq_resultado
        INTO STRICT nr_seq_resultado_w
        FROM exame_lab_resultado
        WHERE nr_prescricao = nr_prescricao_p;
    EXCEPTION
        WHEN no_data_found THEN
            RETURN;
    END;

    DELETE FROM
        exame_lab_result_item
    WHERE
        nr_seq_resultado = nr_seq_resultado_w
        AND nr_seq_prescr = nr_seq_prescr_w
        AND nr_seq_exame <> nr_seq_exame_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE matrixv7_limpar_resultados ( nr_prescricao_p bigint, cd_exame_p text, nr_seq_prescr_p bigint DEFAULT 0) FROM PUBLIC;

