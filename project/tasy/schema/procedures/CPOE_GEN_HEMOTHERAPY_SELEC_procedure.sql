-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gen_hemotherapy_selec ( ie_tipo_hemoterap_p cpoe_hemoterapia.ie_tipo_hemoterap%type, nr_seq_proc_interno_p cpoe_hemoterapia.nr_seq_proc_interno%type default null, nr_seq_derivado_p cpoe_hemoterapia.nr_seq_derivado%type default null, nr_atendimento_p bigint DEFAULT NULL, cd_perfil_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL, cd_paciente_p text DEFAULT NULL, nr_seq_item_gerado_p INOUT cpoe_hemoterapia.nr_sequencia%type DEFAULT NULL, ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, nr_seq_cpoe_order_unit_p cpoe_hemoterapia.nr_seq_cpoe_order_unit%type DEFAULT NULL, ie_tipo_sangue_p cpoe_hemoterapia.ie_tipo_sangue%type DEFAULT NULL, ie_fator_rh_p cpoe_hemoterapia.ie_fator_rh%type DEFAULT NULL) AS $body$
DECLARE


ie_trans_anterior_w			cpoe_hemoterapia.ie_trans_anterior%type;
qt_transf_anterior_w		cpoe_hemoterapia.qt_transf_anterior%type;
ie_tipo_paciente_w			cpoe_hemoterapia.ie_tipo_paciente%type;
ie_tipo_paciente_cpoe_w		cpoe_hemoterapia.ie_tipo_paciente%type;
qt_aborto_w					cpoe_hemoterapia.qt_aborto%type;
qt_gravidez_w				cpoe_hemoterapia.qt_gravidez%type;
ie_gravidez_w				cpoe_hemoterapia.ie_gravidez%type;
nr_seq_derivado_reac_w		cpoe_hemoterapia.nr_seq_derivado_reac%type;
nr_seq_reacao_w				cpoe_hemoterapia.nr_seq_reacao%type;
dt_ultima_transf_w			cpoe_hemoterapia.dt_ultima_transf%type;
ds_sintoma_w				cpoe_hemoterapia.ds_sintoma%type;
cd_doenca_cid_w				cpoe_hemoterapia.cd_doenca_cid%type;

	

BEGIN

ie_tipo_paciente_w := 'C';
qt_transf_anterior_w := 0;

select	max(qt_aborto),
	max(qt_gravidez),
	max(ie_gravidez),
	max(nr_seq_derivado_reac),
	max(nr_seq_reacao),
	max(ds_sintoma)
into STRICT qt_aborto_w,
	qt_gravidez_w,
	ie_gravidez_w,
	nr_seq_derivado_reac_w,
	nr_seq_reacao_w,
	ds_sintoma_w
from	cpoe_hemoterapia
where	nr_sequencia	=	(SELECT	max(nr_sequencia)
							from	cpoe_hemoterapia
							where	((nr_atendimento  = nr_atendimento_p) or (cd_pessoa_fisica = cd_paciente_p and coalesce(nr_atendimento::text, '') = '')));

cd_doenca_cid_w 	:= obter_cod_diagnostico_atend( nr_atendimento_p);
dt_ultima_transf_w	:= obter_data_ult_transf( nr_atendimento_p, cd_paciente_p);
ie_trans_anterior_w	:= 'N';


if (qt_transf_anterior_w > 0) then
	ie_trans_anterior_w	:= 'S';
end if;
	
ie_tipo_paciente_cpoe_w	:= 'C';

if (ie_tipo_paciente_w = 'CI') then
	ie_tipo_paciente_cpoe_w	:= 'I';
end if;

if (ie_trans_anterior_w = 'N') then
	dt_ultima_transf_w	:= null;
end if;
			
select	nextval('cpoe_hemoterapia_seq')
into STRICT	nr_seq_item_gerado_p
;

		insert into cpoe_hemoterapia(	nr_sequencia,
				nr_atendimento,
				cd_pessoa_fisica,
				cd_doenca_cid,
				ie_tipo_paciente,
				ie_tipo_hemoterap,
				ie_unid_med_hemo,
				dt_ultima_transf,
				ie_trans_anterior,
				qt_aborto,
				qt_gravidez,
				ie_gravidez,
				nr_seq_derivado_reac,
		        nr_seq_reacao,
		        ds_sintoma,
				nm_usuario,
				nm_usuario_nrec,
				dt_atualizacao,
				dt_atualizacao_nrec,
				cd_funcao_origem,
				cd_perfil_ativo,
				ie_prescritor_aux,
				cd_medico,
				nr_seq_cpoe_order_unit,
				nr_seq_proc_interno,
				nr_seq_derivado,
				qt_transf_anterior,
				ie_reserva,
                ie_tipo_sangue,
				ie_fator_rh)
		values (	nr_seq_item_gerado_p,
				nr_atendimento_p,
				cd_paciente_p,
				cd_doenca_cid_w,
				ie_tipo_paciente_cpoe_w,
				ie_tipo_hemoterap_p,
				'gpm',
				dt_ultima_transf_w,
				ie_trans_anterior_w,
				qt_aborto_w,
				qt_gravidez_w,
				ie_gravidez_w,
				nr_seq_derivado_reac_w,
				nr_seq_reacao_w,
				ds_sintoma_w,
			
				nm_usuario_p,
				nm_usuario_p,
				clock_timestamp(),
				clock_timestamp(),
				2314,
				cd_perfil_p,
				ie_prescritor_aux_p,
				cd_medico_p,
                nr_seq_cpoe_order_unit_p,
				nr_seq_proc_interno_p,
				nr_seq_derivado_p,
				qt_transf_anterior_w,
				CASE WHEN ie_tipo_hemoterap_p='0' THEN  'N' END ,
				ie_tipo_sangue_p,
				ie_fator_rh_p
				);						
	
commit;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gen_hemotherapy_selec ( ie_tipo_hemoterap_p cpoe_hemoterapia.ie_tipo_hemoterap%type, nr_seq_proc_interno_p cpoe_hemoterapia.nr_seq_proc_interno%type default null, nr_seq_derivado_p cpoe_hemoterapia.nr_seq_derivado%type default null, nr_atendimento_p bigint DEFAULT NULL, cd_perfil_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL, cd_paciente_p text DEFAULT NULL, nr_seq_item_gerado_p INOUT cpoe_hemoterapia.nr_sequencia%type DEFAULT NULL, ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, nr_seq_cpoe_order_unit_p cpoe_hemoterapia.nr_seq_cpoe_order_unit%type DEFAULT NULL, ie_tipo_sangue_p cpoe_hemoterapia.ie_tipo_sangue%type DEFAULT NULL, ie_fator_rh_p cpoe_hemoterapia.ie_fator_rh%type DEFAULT NULL) FROM PUBLIC;

