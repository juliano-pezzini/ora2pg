-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_atend_setor_lib ( cd_visitante_p bigint, cd_responsavel_p bigint, cd_setor_atendimento_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE

 
qt_regra_visitante_w		bigint;
ie_setor_lib_w			varchar(1)	:= 'N';
ds_lista_pacientes_w		varchar(255)	:= null;

C02 CURSOR FOR 
	SELECT	a.nr_atendimento 
	from	atendimento_visita_bloq a 
	where	(a.cd_pessoa_bloqueio IS NOT NULL AND a.cd_pessoa_bloqueio::text <> '') 
	and	a.cd_pessoa_bloqueio = cd_visitante_p 
	and	obter_setor_atendimento(a.nr_atendimento) = cd_setor_atendimento_p 
	
union all
 
	SELECT	a.nr_atendimento 
	from	atendimento_acomp_bloq a 
	where	(a.cd_pessoa_fisica IS NOT NULL AND a.cd_pessoa_fisica::text <> '') 
	and	a.cd_pessoa_fisica = cd_visitante_p 
	and	obter_setor_atendimento(a.nr_atendimento) = cd_setor_atendimento_p 
	order by nr_atendimento;

c02_w	c02%rowtype;


BEGIN 
 
select	count(*) 
into STRICT	qt_regra_visitante_w 
from	atend_setor_lib 
where	cd_pessoa_fisica = cd_visitante_p 
and	coalesce(ie_situacao,'A') = 'A';
 
if (coalesce(qt_regra_visitante_w,0) > 0)	then 
	select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END  
	into STRICT	ie_setor_lib_w 
	from	atend_setor_lib 
	where	coalesce(cd_Pessoa_fisica, cd_visitante_p) = cd_visitante_p 
	and	coalesce(cd_setor_atendimento,cd_setor_atendimento_p) = cd_setor_atendimento_p 
	and	coalesce(ie_situacao,'A') = 'A';
 
	if (ie_setor_lib_w = 'N')	then 
		ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(256810);
	else 
		open C02;
		loop 
		fetch C02 into	 
			c02_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin 
			if (ds_lista_pacientes_w IS NOT NULL AND ds_lista_pacientes_w::text <> '') then 
				ds_lista_pacientes_w	:= ds_lista_pacientes_w || chr(13) || chr(10);
			end if;
 
			ds_lista_pacientes_w	:= substr(ds_lista_pacientes_w || substr(obter_nome_paciente(c02_w.nr_atendimento),1,255) || 
								' (' || obter_desc_expressao(347752) /* dic_expressao 347752 = 'atendimento' */ || ' ' || to_char(c02_w.nr_atendimento) || ')' 
							,1,255); -- tratamento para nao estourar a variavel 
			end;
		end loop;
		close C02;
		 
		if (ds_lista_pacientes_w IS NOT NULL AND ds_lista_pacientes_w::text <> '') then 
			ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(320453,	'NM_VISITANTE='||substr(obter_nome_pf(cd_visitante_p),1,255) || ';' || 
										'LISTA_PACIENTES='||substr(ds_lista_pacientes_w,1,255) || ';');
		end if;
	end if;
else 
	ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(256810);
 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_atend_setor_lib ( cd_visitante_p bigint, cd_responsavel_p bigint, cd_setor_atendimento_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

