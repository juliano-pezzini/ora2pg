-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_kit_procedimento ( cd_estabelecimento_p bigint, nr_prescricao_p bigint, nr_seq_prescr_p bigint default null, nm_usuario_p text DEFAULT NULL) AS $body$
DECLARE


dt_atualizacao_w		timestamp		:= clock_timestamp();
nr_sequencia_w			bigint;
nr_horas_validade_W		bigint;
nr_seq_derivado_w		bigint;
nr_ocorrencia_w			bigint	:= 1;
nr_agrupamento_w		double precision;
cd_material_w			integer;
qt_material_kit_w		double precision;
qt_material_w			double precision;
ie_origem_inf_w			varchar(1)   	:= 'K';
cd_unidade_medida_w		varchar(30);
cd_intervalo_w			varchar(7);
ie_urgencia_w			varchar(1);
ie_suspenso_w			varchar(1)	:= 'N';
ie_se_necessario_w		varchar(1)	:= 'N';
ie_medicacao_paciente_w	varchar(1)	:= 'N';
nr_seq_proc_w			integer	:= 0;
ds_horarios_w			varchar(2000);
ie_gerar_kit_w			char(1);
nr_cirurgia_w			bigint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
nr_seq_proc_interno_w	bigint;
cd_kit_material_w		bigint;
cd_kit_w				bigint;
cd_setor_atendimento_w	bigint;
ie_agrupador_w			smallint;
qt_procedimento_w		double precision;
cd_convenio_w			integer;/* fabricio em 04/06/2008  os94400 */
cd_medico_w				varchar(10);
cd_medico_prescr_w		varchar(10);
ie_via_aplicacao_w		varchar(10);
ie_acm_w				varchar(10);
ie_gerar_kit_setor_w	varchar(10);
ie_recem_nato_w			varchar(1);
ie_lancar_kit_princ_w	varchar(1);
nr_atendimento_w		bigint;
qt_peso_w				real;
qt_idade_paciente_w		integer;
ie_sexo_paciente_w		varchar(1);
cd_intervalo_kit_w		varchar(7);
cd_motivo_baixa_w		integer;
ie_kit_gerado_w			varchar(1) := 'N';
ie_checar_kit_adep_w	varchar(1);
ie_tipo_convenio_w		smallint;
ie_ja_existe_w			varchar(1);
ie_agrup_w              varchar(1);

c01 CURSOR FOR
	SELECT	nr_agrupamento,
			ie_urgencia,
			cd_intervalo,
			ds_horarios,
			cd_procedimento,
			ie_origem_proced,
			nr_seq_proc_interno,
			coalesce(cd_setor_atendimento,cd_setor_atendimento_w),
			nr_sequencia,
			qt_procedimento,
			coalesce(cd_medico_exec,cd_medico_prescr_w),
			nr_seq_derivado,
			ie_se_necessario,
			ie_acm
	from	prescr_procedimento
	where	((nr_sequencia	= nr_seq_prescr_p) or (coalesce(nr_seq_prescr_p,0) = 0))
	and		coalesce(ie_kit_gerado,'N')	= 'N'
	and		nr_prescricao	= nr_prescricao_p;

c02 CURSOR FOR
	SELECT	c.cd_material,
			CASE WHEN coalesce(c.ie_multiplica_dose,'N')='S' THEN c.qt_material * qt_procedimento_w  ELSE c.qt_material END ,
			coalesce(c.cd_unidade_medida_prescr, substr(obter_dados_material_estab(c.cd_material,cd_estabelecimento_p,'UMS'),1,30)),
			obter_classif_material_proced(c.cd_material,null,null) ie_agrupador,
			c.ie_via_aplicacao,
			c.cd_intervalo,
			coalesce(c.cd_motivo_baixa,0)
	from	componente_kit c,
			kit_material x
	where	coalesce(c.cd_convenio,0) = (SELECT coalesce(max(y.cd_convenio), 0)
									from	componente_kit y
									where	((coalesce(y.cd_estab_regra::text, '') = '') or (y.cd_estab_regra = cd_estabelecimento_p))
									and		y.cd_kit_material = c.cd_kit_material
									and		y.cd_material	  = c.cd_material
									and		y.cd_convenio     = cd_convenio_w)
	and	coalesce(c.ie_tipo_convenio,0) = (select coalesce(max(y.ie_tipo_convenio), 0)
									from	componente_kit y
									where	((coalesce(y.cd_estab_regra::text, '') = '') or (y.cd_estab_regra = cd_estabelecimento_p))
									and		y.cd_kit_material = c.cd_kit_material
									and		y.cd_material	  = c.cd_material
									and		y.ie_tipo_convenio     = ie_tipo_convenio_w)
	and (obter_se_comp_kit_rep(c.cd_kit_material,c.nr_sequencia,cd_medico_prescr_w) = 'S')
	and		((c.ie_recem_nato =  coalesce(ie_recem_nato_w, 'A')) or (coalesce(c.ie_recem_nato, 'A') = 'A'))
	and		coalesce(c.ie_sexo, coalesce(ie_sexo_paciente_w,0)) = coalesce(ie_sexo_paciente_w,0)
	and (qt_idade_paciente_w between coalesce(c.qt_idade_minima,-1) and coalesce(c.qt_idade_maxima,999))
	and (qt_peso_w between coalesce(c.qt_peso_min,-1) and coalesce(c.qt_peso_max,999))
	and		coalesce(c.cd_setor_atendimento, coalesce(cd_setor_atendimento_w,0)) = coalesce(cd_setor_atendimento_w,0)
	and		((coalesce(c.cd_estab_regra::text, '') = '') or (c.cd_estab_regra = cd_estabelecimento_p))
	and		c.ie_situacao	= 'A'
	and		x.cd_kit_material	= c.cd_kit_material
	and		x.cd_kit_material	= cd_kit_material_w
	and		x.ie_situacao	= 'A';


BEGIN

select	max(cd_setor_atendimento)
into STRICT	cd_setor_atendimento_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

select	coalesce(max(ie_gerar_kit_proced),'S')
into STRICT	ie_gerar_kit_setor_w
from	setor_atendimento
where	cd_setor_atendimento	= cd_setor_atendimento_w;

if (ie_gerar_kit_setor_w = 'S') then
	select	coalesce(max('N'),'S')
	into STRICT	ie_gerar_kit_w
	from	cirurgia where		nr_prescricao = nr_prescricao_p LIMIT 1;

	if (ie_gerar_kit_w = 'N') then
		select	coalesce(max(ie_kit_prescr_cir), 'N')
		into STRICT	ie_gerar_kit_w
		from	parametro_estoque
		where	cd_estabelecimento	= cd_estabelecimento_p;
	end if;

	if (ie_gerar_kit_w = 'S') then

		select	coalesce(max(obter_convenio_atendimento(nr_atendimento)),0),
				max(cd_medico),
				coalesce(max(ie_recem_nato), 'A'),
				max(cd_setor_atendimento),
				max(nr_atendimento),
				coalesce(max(obter_idade_pf(cd_pessoa_fisica,clock_timestamp(),'A')),0),
				max(substr(obter_sexo_pf(cd_pessoa_fisica, 'C'),1,1)),
				coalesce(max(qt_peso),0),
				max(nr_horas_validade)
		into STRICT	cd_convenio_w,
				cd_medico_prescr_w,
				ie_recem_nato_w,
				cd_setor_atendimento_w,
				nr_atendimento_w,
				qt_idade_paciente_w,
				ie_sexo_paciente_w,	
				qt_peso_w,
				nr_horas_validade_W
		from	prescr_medica
		where	nr_prescricao	= nr_prescricao_p;
		
		ie_lancar_kit_princ_w := obter_param_usuario(924, 725, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_lancar_kit_princ_w);

		if (cd_convenio_w > 0) then
			select	max(ie_tipo_convenio)
			into STRICT	ie_tipo_convenio_w
			from	convenio
			where	cd_convenio = cd_convenio_w;
		end if;
		
		begin	
		open c01;
		loop
		fetch c01 into
			nr_agrupamento_w,
			ie_urgencia_w,
			cd_intervalo_w,
			ds_horarios_w,
			cd_procedimento_w,
			ie_origem_proced_w,
			nr_seq_proc_interno_w,
			cd_setor_atendimento_w,
			nr_seq_proc_w,
			qt_procedimento_w,
			cd_medico_w,
			nr_seq_derivado_w,
			ie_se_necessario_w,
			ie_acm_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin

			-- mjgoncalves OS 675145/712328 - inicio (busca o kit de material cadastrado para o procedimento na funcao PEP - Cadastros PEP - "Exames/Procedimentos de rotina")
			select	max(a.cd_kit_material)
			into STRICT	cd_kit_material_w
			from	procedimento_rotina a,
				PRESCR_PROCEDIMENTO B
			where ((A.NR_SEQUENCIA	= B.NR_SEQ_ROTINA) or
			       ((a.nr_seq_rotina IS NOT NULL AND a.nr_seq_rotina::text <> '') and (b.ie_origem_proced = 4) and (a.nr_seq_rotina = b.nr_seq_rotina) and
					(((coalesce(a.cd_procedimento, 0) = 0) and (coalesce(a.nr_proc_interno, 0) = coalesce(b.nr_seq_proc_interno, 0))) or
					 ((coalesce(a.nr_proc_interno, 0) = coalesce(b.nr_seq_proc_interno, 0)) and (coalesce(a.cd_procedimento, 0) = coalesce(b.cd_procedimento, 0))))))
			AND	B.NR_PRESCRICAO 	= nr_prescricao_p
			and	b.nr_sequencia		= nr_seq_proc_w
			AND	(B.NR_SEQ_ROTINA IS NOT NULL AND B.NR_SEQ_ROTINA::text <> '')
			AND	(A.CD_KIT_MATERIAL IS NOT NULL AND A.CD_KIT_MATERIAL::text <> '')
			AND	coalesce(a.cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w
			AND	a.cd_estabelecimento	= cd_estabelecimento_p
			AND	coalesce(a.cd_convenio, cd_convenio_w)	= cd_convenio_w
			AND	coalesce(B.ie_kit_gerado,'N')	= 'N'
			and	coalesce(b.nr_seq_exame::text, '') = '';
			-- mjgoncalves OS 675145/712328 - fim

				
			-- mjgoncalves OS 675145/712328 - inicio - (se nao existe kit de material cadastrado em "Exames/Procedimentos de rotina" (funcao PEP - Cadastros PEP), obtem o kit de material cadastrado na funcao "Exames e Procedimentos Internos"
			if (coalesce(cd_kit_material_w::text, '') = ''
				or cd_kit_material_w = 0) then	
			-- mjgoncalves OS 675145/712328 - fim
				cd_kit_material_w := obter_kit_procedimento(	nr_atendimento_w, cd_estabelecimento_p, cd_procedimento_w, ie_origem_proced_w, nr_seq_proc_interno_w, cd_setor_atendimento_w, cd_medico_w, cd_kit_material_w);
			end if;
						
			if (ie_lancar_kit_princ_w = 'N') then
				select	coalesce(max(cd_kit_material),0)
				into STRICT	cd_kit_w
				from	proc_interno
				where	nr_sequencia	= nr_seq_proc_interno_w;
				
				if (cd_kit_w = cd_kit_material_w) then
					cd_kit_material_w	:= null;
				end if;
			end if;
/*
			-- mjgoncalves OS 675145/712328 - inicio - retirei

			if	(nvl(cd_kit_material_w,0) = 0) then	
				select	max(a.cd_kit_material)
				into	cd_kit_material_w
				from	prescr_procedimento b,
						procedimento_rotina a
				where	b.nr_prescricao = nr_prescricao_p
				and		b.nr_sequencia	= nr_seq_proc_w
				and		b.nr_seq_rotina	= a.nr_sequencia;
			end if;			
			-- mjgoncalves OS 675145/712328 - fim

*/
			select	coalesce(max(ie_checar_kit_adep), 'N')
			into STRICT	ie_checar_kit_adep_w
			from	proc_interno
			where	nr_sequencia	= nr_seq_proc_interno_w;	
				
            select  coalesce(max('S'), 'N')
            into STRICT    ie_agrup_w
            from    prescr_material a
            where   a.nr_prescricao = nr_prescricao_p
            and     a.nr_agrupamento = nr_agrupamento_w;

            if (ie_agrup_w = 'S') then
                select  coalesce(max(a.nr_agrupamento), 0) + 1
                into STRICT    nr_agrupamento_w
                from    prescr_material a
                where   a.nr_prescricao = nr_prescricao_p;

                update  prescr_procedimento a
                set     a.nr_agrupamento = nr_agrupamento_w
                where   a.nr_prescricao = nr_prescricao_p
                and     a.nr_sequencia = nr_seq_proc_w;
            end if;

			open c02;
			loop
			fetch c02 into
				cd_material_w,
				qt_material_kit_w,
				cd_unidade_medida_w,
				ie_agrupador_w,
				ie_via_aplicacao_w,
				cd_intervalo_kit_w,
				cd_motivo_baixa_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				begin
						
				select	coalesce(max(nr_sequencia),0) + 1
				into STRICT	nr_sequencia_w
				from	prescr_material
				where	nr_prescricao = nr_prescricao_p;
	
				select	max(obter_ocorrencias_horarios_rep(ds_horarios_w))
				into STRICT	nr_ocorrencia_w
				;
				
				if (nr_ocorrencia_w = 0) then
					select	coalesce(obter_ocorrencia_intervalo(cd_intervalo_w,nr_horas_validade_W,'O'),1)
					into STRICT	nr_ocorrencia_w
					;
				end if;
				
				qt_material_w := qt_material_kit_w * nr_ocorrencia_w;
				
				select	coalesce(max('S'),'N')
				into STRICT	ie_ja_existe_w
				from	prescr_material a
				where	a.nr_prescricao = nr_prescricao_p
				and		a.cd_material = cd_material_w
				and		coalesce(a.ie_via_aplicacao,'XPTO') = coalesce(ie_via_aplicacao_w,'XPTO')
				and		coalesce(a.cd_unidade_medida,'XPTO') = coalesce(cd_unidade_medida_w,'XPTO')
				and		coalesce(a.cd_intervalo,'XPTO') = coalesce(coalesce(cd_intervalo_kit_w,cd_intervalo_w),'XPTO')
				and		a.qt_dose = qt_material_kit_w
				and		a.nr_sequencia_proc = nr_seq_proc_w;
				
				if (ie_ja_existe_w = 'N') then
				
					if (ie_agrupador_w <> 1) then
						ie_agrupador_w := 1;
					else
						ie_agrupador_w := 2;
					end if;
					
					if (nr_seq_proc_w IS NOT NULL AND nr_seq_proc_w::text <> '') and (coalesce(nr_seq_derivado_w,0) = 0) then
						ie_agrupador_w := 5;
					end if;
					
					insert into prescr_material(
									nr_prescricao,
									nr_sequencia,
									ie_origem_inf,
									cd_material,
									cd_unidade_medida,
									qt_dose,
									qt_unitaria,
									qt_material, 
									dt_atualizacao,
									nm_usuario, 
									cd_intervalo, 
									nr_agrupamento,
									ie_urgencia,
									nr_ocorrencia,
									qt_total_dispensar,
									ie_suspenso,
									cd_unidade_medida_dose,
									ie_se_necessario,
									ie_medicacao_paciente,
									nr_sequencia_proc,
									cd_motivo_baixa,
									ie_agrupador,
									ie_bomba_infusao,
									ie_aplic_bolus,
									ie_aplic_lenta,
									ie_acm,
									ds_horarios,
									ie_recons_diluente_fixo, 
									ie_sem_aprazamento,
									cd_kit_material,
									ie_via_aplicacao,
									ie_status_cirurgia,
									ie_checar_adep
								) values (
									nr_prescricao_p, 
									nr_sequencia_w, 
									ie_origem_inf_w,
									cd_material_w, 
									cd_unidade_medida_w, 
									qt_material_kit_w,
									qt_material_kit_w, 
									qt_material_w, 
									dt_atualizacao_w,
									nm_usuario_p,
									coalesce(cd_intervalo_kit_w,cd_intervalo_w),
									nr_agrupamento_w,
									ie_urgencia_w,
									nr_ocorrencia_w,
									qt_material_w,
									ie_suspenso_w,
									cd_unidade_medida_w,
									ie_se_necessario_w,
									ie_medicacao_paciente_w,
									nr_seq_proc_w,
									cd_motivo_baixa_w,
									ie_agrupador_w,
									'N',
									'N',
									'N',
									ie_acm_w,
									ds_horarios_w,
									'N',
									'N',
									cd_kit_material_w,
									ie_via_aplicacao_w,
									'GI',
									ie_checar_kit_adep_w);
					ie_kit_gerado_w	:= 'S';
					end if;
				end;
			end loop;
			close c02;
			CALL atualizar_ie_kit_gerado(ie_kit_gerado_w,nr_prescricao_p,nr_seq_proc_w,'PRESCR_PROCEDIMENTO');
			end;
		end loop;
		close c01;
		end;
	end if;
	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_kit_procedimento ( cd_estabelecimento_p bigint, nr_prescricao_p bigint, nr_seq_prescr_p bigint default null, nm_usuario_p text DEFAULT NULL) FROM PUBLIC;

