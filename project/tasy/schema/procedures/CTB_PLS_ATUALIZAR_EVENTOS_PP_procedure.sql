-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_pls_atualizar_eventos_pp ( nr_seq_lote_pp_p bigint, nr_seq_item_pp_p bigint, nr_seq_atualizacao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, qt_movimento_p INOUT bigint) AS $body$
DECLARE

					
qt_movimento_w				bigint;
cd_conta_debito_w			conta_contabil.cd_conta_contabil%type;
cd_conta_credito_w			conta_contabil.cd_conta_contabil%type;
cd_classificacao_debito_w		conta_contabil.cd_classificacao_atual%type;
cd_classificacao_credito_w		conta_contabil.cd_classificacao_atual%type;
cd_classificacao_item_w			conta_contabil.cd_classificacao_atual%type;
cd_historico_padrao_w			historico_padrao.cd_historico%type;
cd_empresa_w				empresa.cd_empresa%type;
ie_status_w				pls_movimento_contabil.ie_status%type;
nr_seq_esquema_w			pls_esquema_contabil.nr_sequencia%type;
cd_historico_w				historico_padrao.cd_historico%type;
					
c_item CURSOR FOR
	SELECT	i.nr_sequencia nr_seq_item,
		p.nr_sequencia nr_seq_prestador,
		p.nr_seq_tipo_prestador,
		p.ie_tipo_prestador,
		p.ie_tipo_relacao,
		p.cd_pessoa_fisica,
		p.cd_cgc,
		e.nr_sequencia nr_seq_evento,
		coalesce(e.ie_consiste_ctb, 'S') ie_consiste_evento,
		l.dt_mes_competencia
	from	pls_pp_item_lote		i,
		pls_pp_prestador		r,
		pls_prestador			p,
		pls_evento			e,
		pls_pp_lote			l
	where	l.nr_sequencia	= i.nr_seq_lote
	and	l.nr_sequencia	= r.nr_seq_lote
	and	p.nr_sequencia	= i.nr_seq_prestador
	and	e.nr_sequencia	= i.nr_seq_evento
	and	p.nr_sequencia	= r.nr_seq_prestador
	and	l.nr_sequencia	= nr_seq_lote_pp_p
	and	((i.nr_sequencia = nr_seq_item_pp_p) or (coalesce(nr_seq_item_pp_p::text, '') = ''))
	and	e.ie_tipo_evento = 'F';
	
vet_item_w	c_item%rowtype;	
	
c_esquema CURSOR FOR
	SELECT	nr_sequencia nr_seq_esquema,
		cd_historico_padrao
	from	pls_esquema_contabil
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	ie_tipo_regra		= 'PM'
	and	vet_item_w.dt_mes_competencia between dt_inicio_vigencia and coalesce(dt_fim_vigencia,vet_item_w.dt_mes_competencia)
	and	((nr_seq_prestador = vet_item_w.nr_seq_prestador) or (coalesce(nr_seq_prestador::text, '') = ''))
	and	((nr_seq_tipo_prestador = vet_item_w.nr_seq_tipo_prestador) or (coalesce(nr_seq_tipo_prestador::text, '') = ''))
	and	((ie_tipo_ptu = vet_item_w.ie_tipo_prestador) or (coalesce(ie_tipo_ptu::text, '') = ''))
	and	((ie_tipo_relacao = vet_item_w.ie_tipo_relacao) or (coalesce(ie_tipo_relacao::text, '') = ''))
	and	((nr_seq_evento = vet_item_w.nr_seq_evento) or (coalesce(nr_seq_evento::text, '') = ''))
	and	ie_tipo_movimentacao = 13
	order by
		coalesce(nr_seq_evento,0),
		coalesce(nr_seq_prestador,0),
		coalesce(ie_tipo_relacao,' '),
		coalesce(nr_seq_tipo_prestador,0),
		coalesce(ie_tipo_ptu,' '),
		coalesce(dt_inicio_vigencia,clock_timestamp());

c_segmentacao CURSOR FOR
	SELECT	ie_codificacao,
		vl_fixo,
		cd_conta_contabil,
		ie_debito_credito,
		ds_mascara
	from	pls_esquema_contabil_seg
	where	nr_seq_regra_esquema	= nr_seq_esquema_w
	order by
		ie_debito_credito,
		nr_seq_apresentacao;
		
vet_segmentacao_w	c_segmentacao%rowtype;
					

BEGIN

select	max(cd_empresa)
into STRICT	cd_empresa_w
from	estabelecimento
where	cd_estabelecimento	= cd_estabelecimento_p;

qt_movimento_w	:= qt_movimento_p;

CALL wheb_usuario_pck.set_ie_atualizacao_contabil('S');

open c_item;
loop
fetch c_item into	
	vet_item_w;
EXIT WHEN NOT FOUND; /* apply on c_item */
	begin
	cd_classificacao_credito_w		:= null;
	cd_classificacao_debito_w		:= null;
	cd_conta_credito_w			:= null;
	cd_conta_debito_w			:= null;
	nr_seq_esquema_w			:= null;
	cd_historico_w				:= null;
	
	open c_esquema;
	loop
	fetch c_esquema into	
		nr_seq_esquema_w,
		cd_historico_w;
	EXIT WHEN NOT FOUND; /* apply on c_esquema */
	end loop;
	close c_esquema;
	
	open c_segmentacao;
	loop
	fetch c_segmentacao into	
		vet_segmentacao_w;
	EXIT WHEN NOT FOUND; /* apply on c_segmentacao */
		begin
		
		cd_classificacao_item_w := null;
		if (vet_segmentacao_w.ie_debito_credito = 'C') then /* Classificacao CREDITO */
			if (vet_segmentacao_w.ie_codificacao = 'CR') then /* Codigo reduzido */
				select	max(cd_classificacao_atual)
				into STRICT	cd_classificacao_credito_w
				from	conta_contabil
				where	cd_conta_contabil	= vet_segmentacao_w.cd_conta_contabil;
				
				cd_conta_credito_w	:= vet_segmentacao_w.cd_conta_contabil;
			elsif (vet_segmentacao_w.ie_codificacao = 'FX') then /* Fixo */
				cd_classificacao_item_w	:= vet_segmentacao_w.vl_fixo;
			elsif (vet_segmentacao_w.ie_codificacao = 'TR') then /* Tipo de relacao com a OPS */
				cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_tipo_relacao(vet_item_w.ie_tipo_relacao);
			elsif (vet_segmentacao_w.ie_codificacao = 'JP') then
				if (vet_item_w.cd_cgc IS NOT NULL AND vet_item_w.cd_cgc::text <> '') then
					select	max(cd_conta_contabil)
					into STRICT	cd_conta_credito_w
					from	pessoa_jur_conta_cont a
					where	a.cd_cgc		= vet_item_w.cd_cgc
					and	a.cd_empresa	 	= cd_empresa_w
					and	a.ie_tipo_conta		= 'P'
					and	vet_item_w.dt_mes_competencia between coalesce(a.dt_inicio_vigencia,vet_item_w.dt_mes_competencia) and coalesce(a.dt_fim_vigencia,vet_item_w.dt_mes_competencia);
					
				elsif (vet_item_w.cd_pessoa_fisica IS NOT NULL AND vet_item_w.cd_pessoa_fisica::text <> '') then
					select	max(cd_conta_contabil)
					into STRICT	cd_conta_credito_w
					from	pessoa_fisica_conta_ctb	a
					where	a.cd_pessoa_fisica	= vet_item_w.cd_pessoa_fisica
					and	a.cd_empresa	 	= cd_empresa_w
					and	coalesce(a.cd_estabelecimento,cd_estabelecimento_p)	= cd_estabelecimento_p
					and	a.ie_tipo_conta		= 'P'
					and	vet_item_w.dt_mes_competencia between coalesce(a.dt_inicio_vigencia,vet_item_w.dt_mes_competencia) and coalesce(a.dt_fim_vigencia,vet_item_w.dt_mes_competencia);
				end if;
				
				select	max(cd_classificacao_atual)
				into STRICT	cd_classificacao_credito_w
				from	conta_contabil
				where	cd_conta_contabil	= cd_conta_credito_w;
			elsif (vet_segmentacao_w.ie_codificacao = 'RP') then
				if (coalesce(vet_item_w.cd_cgc,0) <> 0) then
					select	max(cd_conta_contabil)
					into STRICT	cd_conta_credito_w
					from	pessoa_jur_conta_cont a
					where	a.cd_cgc	= vet_item_w.cd_cgc
					and	a.cd_empresa	= cd_empresa_w
					and	a.ie_tipo_conta	= 'R'
					and	vet_item_w.dt_mes_competencia between coalesce(a.dt_inicio_vigencia,vet_item_w.dt_mes_competencia) and coalesce(a.dt_fim_vigencia,vet_item_w.dt_mes_competencia);

				elsif (coalesce(vet_item_w.cd_pessoa_fisica,0) <> 0) then
					select	max(cd_conta_contabil)
					into STRICT	cd_conta_credito_w
					from	pessoa_fisica_conta_ctb	a
					where	a.cd_pessoa_fisica 	= vet_item_w.cd_pessoa_fisica
					and	a.cd_empresa		= cd_empresa_w
					and	coalesce(a.cd_estabelecimento,cd_estabelecimento_p)	= cd_estabelecimento_p
					and	a.ie_tipo_conta	= 'R'
					and	vet_item_w.dt_mes_competencia between coalesce(a.dt_inicio_vigencia,vet_item_w.dt_mes_competencia) and coalesce(a.dt_fim_vigencia,vet_item_w.dt_mes_competencia);
				end if;

				select	max(cd_classificacao_atual)
				into STRICT	cd_classificacao_credito_w
				from	conta_contabil
				where	cd_conta_contabil = cd_conta_credito_w;
			end if;
			
			if (cd_classificacao_item_w IS NOT NULL AND cd_classificacao_item_w::text <> '') then
				if (vet_segmentacao_w.ds_mascara = '00') then
					cd_classificacao_item_w	:= lpad(cd_classificacao_item_w,2,'0') || '.';
				elsif (vet_segmentacao_w.ds_mascara = '0.0') then
					cd_classificacao_item_w	:= substr(lpad(cd_classificacao_item_w,2,'0'),1,1) ||'.'||substr(lpad(cd_classificacao_item_w,2,'0'),2,1) || '.';
				elsif (vet_segmentacao_w.ds_mascara = '0_') then
					cd_classificacao_item_w	:= cd_classificacao_item_w;
				else
					cd_classificacao_item_w	:= cd_classificacao_item_w || '.';
				end if;
				
				cd_classificacao_credito_w	:= cd_classificacao_credito_w || cd_classificacao_item_w;
			end if;
		elsif (vet_segmentacao_w.ie_debito_credito = 'D') then /* Classificacao DEBITO */
			if (vet_segmentacao_w.ie_codificacao = 'CR') then /* Codigo reduzido */
				select	max(cd_classificacao_atual)
				into STRICT	cd_classificacao_debito_w
				from	conta_contabil
				where	cd_conta_contabil	= vet_segmentacao_w.cd_conta_contabil;
				
				cd_conta_debito_w	:= vet_segmentacao_w.cd_conta_contabil;
			elsif (vet_segmentacao_w.ie_codificacao = 'FX') then /* Fixo */
				cd_classificacao_item_w	:= vet_segmentacao_w.vl_fixo;
			elsif (vet_segmentacao_w.ie_codificacao = 'TR') then /* Tipo de relacao com a OPS */
				cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_tipo_relacao(vet_item_w.ie_tipo_relacao);
			elsif (vet_segmentacao_w.ie_codificacao = 'JP') then
				if (vet_item_w.cd_cgc IS NOT NULL AND vet_item_w.cd_cgc::text <> '') then
					select	max(cd_conta_contabil)
					into STRICT	cd_conta_debito_w
					from	pessoa_jur_conta_cont a
					where	a.cd_cgc	= vet_item_w.cd_cgc
					and	a.cd_empresa	= cd_empresa_w
					and	a.ie_tipo_conta	= 'P'
					and	vet_item_w.dt_mes_competencia between coalesce(a.dt_inicio_vigencia,vet_item_w.dt_mes_competencia) and coalesce(a.dt_fim_vigencia,vet_item_w.dt_mes_competencia);
				elsif (vet_item_w.cd_pessoa_fisica IS NOT NULL AND vet_item_w.cd_pessoa_fisica::text <> '') then
					select	max(cd_conta_contabil)
					into STRICT	cd_conta_debito_w
					from	pessoa_fisica_conta_ctb	a
					where	a.cd_pessoa_fisica	= vet_item_w.cd_pessoa_fisica
					and	a.cd_empresa		= cd_empresa_w
					and	coalesce(a.cd_estabelecimento,cd_estabelecimento_p)	= cd_estabelecimento_p
					and	a.ie_tipo_conta		= 'P'
					and	vet_item_w.dt_mes_competencia between coalesce(a.dt_inicio_vigencia,vet_item_w.dt_mes_competencia) and coalesce(a.dt_fim_vigencia,vet_item_w.dt_mes_competencia);
				end if;
				
				select	max(cd_classificacao_atual)
				into STRICT	cd_classificacao_debito_w
				from	conta_contabil
				where	cd_conta_contabil	= cd_conta_debito_w;
			elsif (vet_segmentacao_w.ie_codificacao = 'RP') then
				if (coalesce(vet_item_w.cd_cgc,0) <> 0) then
					select	max(cd_conta_contabil)
					into STRICT	cd_conta_debito_w
					from	pessoa_jur_conta_cont a
					where	a.cd_cgc	= vet_item_w.cd_cgc
					and	a.cd_empresa	= cd_empresa_w
					and	a.ie_tipo_conta	= 'R'
					and	vet_item_w.dt_mes_competencia between coalesce(a.dt_inicio_vigencia,vet_item_w.dt_mes_competencia) and coalesce(a.dt_fim_vigencia,vet_item_w.dt_mes_competencia);
				elsif (coalesce(vet_item_w.cd_pessoa_fisica,0) <> 0) then
					select	max(cd_conta_contabil)
					into STRICT	cd_conta_debito_w
					from	pessoa_fisica_conta_ctb	a
					where	a.cd_pessoa_fisica	= vet_item_w.cd_pessoa_fisica
					and	a.cd_empresa		= cd_empresa_w
					and	coalesce(a.cd_estabelecimento,cd_estabelecimento_p)	= cd_estabelecimento_p
					and	a.ie_tipo_conta	= 'R'
					and	vet_item_w.dt_mes_competencia between coalesce(a.dt_inicio_vigencia,vet_item_w.dt_mes_competencia) and coalesce(a.dt_fim_vigencia,vet_item_w.dt_mes_competencia);
				end if;

				select	max(cd_classificacao_atual)
				into STRICT	cd_classificacao_debito_w
				from	conta_contabil
				where	cd_conta_contabil	= cd_conta_debito_w;
			end if;
			
			if (cd_classificacao_item_w IS NOT NULL AND cd_classificacao_item_w::text <> '') then
				if (vet_segmentacao_w.ds_mascara = '00') then
					cd_classificacao_item_w	:= lpad(cd_classificacao_item_w,2,'0') || '.';
				elsif (vet_segmentacao_w.ds_mascara = '0.0') then
					cd_classificacao_item_w	:= substr(lpad(cd_classificacao_item_w,2,'0'),1,1) ||'.'||substr(lpad(cd_classificacao_item_w,2,'0'),2,1) || '.';
				elsif (vet_segmentacao_w.ds_mascara = '0_') then
					cd_classificacao_item_w	:= cd_classificacao_item_w;
				else
					cd_classificacao_item_w	:= cd_classificacao_item_w || '.';
				end if;
				
				cd_classificacao_debito_w	:= cd_classificacao_debito_w || cd_classificacao_item_w;
			end if;
		end if;
		end;
	end loop;
	close c_segmentacao;
	
	/* Remover o ultimo ponto da classificacao */

	if (substr(cd_classificacao_credito_w,length(cd_classificacao_credito_w),length(cd_classificacao_credito_w)) = '.') then
		cd_classificacao_credito_w	:= substr(cd_classificacao_credito_w,1,length(cd_classificacao_credito_w)-1);
	end if;
	
	if (substr(cd_classificacao_debito_w,length(cd_classificacao_debito_w),length(cd_classificacao_debito_w)) = '.') then
		cd_classificacao_debito_w	:= substr(cd_classificacao_debito_w,1,length(cd_classificacao_debito_w)-1);
	end if;
	
	if (coalesce(cd_conta_credito_w::text, '') = '') then
		cd_conta_credito_w	:= ctb_obter_conta_classif(cd_classificacao_credito_w,vet_item_w.dt_mes_competencia,cd_estabelecimento_p);
	end if;
	
	if (coalesce(cd_conta_debito_w::text, '') = '') then
		cd_conta_debito_w	:= ctb_obter_conta_classif(cd_classificacao_debito_w,vet_item_w.dt_mes_competencia,cd_estabelecimento_p);
	end if;
	
	if (nr_seq_atualizacao_p IS NOT NULL AND nr_seq_atualizacao_p::text <> '') then		
		if (coalesce(nr_seq_esquema_w::text, '') = '') then
			if (vet_item_w.ie_consiste_evento = 'N') then
				ie_status_w	:= 6;
			else
				ie_status_w	:= 1;
			end if;
			
			CALL pls_gravar_mov_contabil(nr_seq_atualizacao_p,
						ie_status_w,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						nm_usuario_p,
						nr_seq_esquema_w,
						null,
						null,
						null,
						null,
						null,
						vet_item_w.nr_seq_item,
						null);
						
		elsif	((coalesce(cd_conta_credito_w::text, '') = '') or (coalesce(cd_conta_debito_w::text, '') = '')) then
			if (vet_item_w.ie_consiste_evento = 'N') then
				ie_status_w	:= 6;
			else
				ie_status_w	:= 2;
			end if;
			CALL pls_gravar_mov_contabil(nr_seq_atualizacao_p,
						ie_status_w,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						null,
						nm_usuario_p,
						nr_seq_esquema_w,
						null,
						null,
						null,
						null,
						null,
						vet_item_w.nr_seq_item,
						null);
		end if;
	end if;
		
	update	pls_pp_item_lote
	set	cd_conta_debito		= cd_conta_debito_w,
		cd_conta_credito	= cd_conta_credito_w,
		cd_classif_debito	= cd_classificacao_debito_w,
		cd_classif_credito 	= cd_classificacao_credito_w,
		cd_historico		= cd_historico_w,
		nr_seq_esquema		= nr_seq_esquema_w
	where	nr_sequencia		= vet_item_w.nr_seq_item;
		
	if (mod(qt_movimento_w, 200) = 0) then
		commit;
	end if;
	
	qt_movimento_w	:= qt_movimento_w + 1;
	end;
end loop;
close c_item;
	
commit;

CALL wheb_usuario_pck.set_ie_atualizacao_contabil('N');

qt_movimento_p	:= qt_movimento_w;	

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_pls_atualizar_eventos_pp ( nr_seq_lote_pp_p bigint, nr_seq_item_pp_p bigint, nr_seq_atualizacao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, qt_movimento_p INOUT bigint) FROM PUBLIC;

