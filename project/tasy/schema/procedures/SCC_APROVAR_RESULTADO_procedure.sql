-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE scc_aprovar_resultado ( nr_seq_interno_p text) AS $body$
DECLARE


nr_prescricao_w			prescr_medica.nr_prescricao%type;

nr_seq_prescr_w			prescr_procedimento.nr_sequencia%type;
ie_status_atend_w		   prescr_procedimento.ie_status_atend%type;

nr_seq_exame_w			   exame_laboratorio.nr_seq_exame%type;

nr_seq_resultado_w		exame_lab_resultado.nr_seq_resultado%type;

nr_seq_material_w		   exame_lab_result_item.nr_seq_material%type;
qt_resultado_w			   exame_lab_result_item.qt_resultado%type;
pr_resultado_w			   exame_lab_result_item.pr_resultado%type;
ds_resultado_w			   exame_lab_result_item.ds_resultado%type;

ds_erro_w				   varchar(4000);

c02 CURSOR FOR
SELECT	r.nr_seq_exame,
         coalesce(r.qt_resultado,0),
         r.pr_resultado,
         r.ds_resultado
from     exame_lab_result_item r,
         exame_laboratorio e
where    r.nr_seq_resultado	= nr_seq_resultado_w
and   	r.nr_seq_prescr		= nr_seq_prescr_w
and   	((r.qt_resultado <> 0) or (r.pr_resultado <> 0) or (r.ds_resultado IS NOT NULL AND r.ds_resultado::text <> ''))
and   	r.nr_seq_exame 		= e.nr_seq_exame
order   by 	r.nr_sequencia,
   e.nr_seq_apresent;


BEGIN

begin

select  MAX(c.nr_sequencia),
        MAX(c.ie_status_atend),
        max(c.nr_prescricao)
INTO STRICT	  nr_seq_prescr_w,
        ie_status_atend_w,
		  nr_prescricao_w
from    atendimento_paciente a,
        prescr_medica b,
        prescr_procedimento c,
        material_exame_lab d,
        exame_laboratorio e
where   a.nr_atendimento = b.nr_atendimento
and     b.nr_prescricao = c.nr_prescricao
and     c.cd_material_exame = d.cd_material_exame
and     c.nr_seq_exame = e.nr_seq_exame
and     c.nr_seq_interno = nr_seq_interno_p
AND	  coalesce(c.ie_suspenso,'N') = 'N'
AND	  coalesce(e.ie_situacao,'A') = 'A'
and     c.ie_status_Atend < 35;

if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then

   select	max(nr_seq_resultado)
   into STRICT	nr_seq_resultado_w
   from	exame_lab_resultado
   where	nr_prescricao = nr_prescricao_w;

   if (nr_seq_resultado_w IS NOT NULL AND nr_seq_resultado_w::text <> '') and (nr_seq_prescr_w IS NOT NULL AND nr_seq_prescr_w::text <> '') then

   select	max(nr_seq_material)
   into STRICT	   nr_seq_material_w
   from 	   exame_lab_result_item
   where 	nr_seq_resultado	= nr_seq_resultado_w
   and 	   nr_seq_prescr		= nr_seq_prescr_w
   and 	   (nr_seq_material IS NOT NULL AND nr_seq_material::text <> '');

   open c02;
      loop
      fetch c02 into	nr_seq_exame_w,
         qt_resultado_w,
         pr_resultado_w,
         ds_resultado_w;
   EXIT WHEN NOT FOUND; /* apply on c02 */

   ds_resultado_w := calcular_valores_exame(nr_seq_resultado_w, nr_prescricao_w, nr_seq_prescr_w, nr_seq_material_w, nr_seq_exame_w, qt_resultado_w, pr_resultado_w, ds_resultado_w);


   end loop;
   close c02;

   delete	FROM result_laboratorio
   where	   nr_prescricao = nr_prescricao_w
   and		nr_seq_prescricao = nr_seq_prescr_w;

   update   exame_lab_result_item
   set      dt_aprovacao = clock_timestamp(),
            dt_liberacao = clock_timestamp()
   where    nr_seq_resultado = nr_seq_resultado_w
   and      nr_seq_prescr = nr_seq_prescr_w
   and      (nr_seq_material IS NOT NULL AND nr_seq_material::text <> '');

   update	prescr_procedimento
   set		ie_status_atend = 35
   where	   nr_seq_interno = nr_seq_interno_p
   and		ie_status_atend < 35;

   end if;

end if;

exception
when others then
ds_erro_w	:= substr(sqlerrm,1,1000);		
CALL gravar_log_lab(69999,
      substr('SCC - '||
         obter_desc_expressao(712423)||' '||
         obter_desc_expressao(722599)||' '||nr_seq_resultado_w||' - '||
         obter_desc_expressao(325814)||' '||nr_prescricao_w||' - '||
         'seq_prescricao: '||nr_seq_prescr_w||' - '||
         obter_desc_expressao(326091)||' '||nr_seq_material_w||' - '||
         obter_desc_expressao(621805)||' '||nr_seq_exame_w||' - '||
         'qt_resultado: '||qt_resultado_w||' - '||
         'pr_resultado: '||pr_resultado_w||' - '||
         obter_desc_expressao(504115)||' '||ds_erro_w,1,2000), 'SCC', nr_prescricao_w);
end;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE scc_aprovar_resultado ( nr_seq_interno_p text) FROM PUBLIC;

