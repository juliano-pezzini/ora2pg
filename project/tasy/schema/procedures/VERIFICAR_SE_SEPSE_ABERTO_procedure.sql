-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE verificar_se_sepse_aberto ( nr_sequencia_p bigint, nr_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_var_w       		bigint;
qt_disfuncao_w 		bigint;
qt_suspeita_w  		bigint;
ie_versao_sepse_w   varchar(10);
ie_tipo_sepse_w     varchar(1);
nr_seq_escala_w     bigint;
qt_atributo_cliente_w	bigint;
qt_obrigatorio_w	bigint;
qt_idade_w					integer;
qt_idade_dia_w				bigint;
qt_data_cliente_sepse_w		bigint;
ie_obrigatorio_81_w	varchar(1);
ie_obrigatorio_84_w	varchar(1);


BEGIN

	ie_tipo_sepse_w := obter_se_sepse_liberada(nr_atendimento_p);

	select coalesce(max(ie_versao_sepse),'1')
	into STRICT   ie_versao_sepse_w
	from   parametro_medico
	where  cd_estabelecimento = coalesce(obter_dados_atendimento(nr_atendimento_p,'EST'), obter_estabelecimento_ativo);
	if (ie_tipo_sepse_w = 'P') then
	begin

		nr_seq_escala_w := 178;
		
		select count(a.nr_sequencia)
		into STRICT   qt_disfuncao_w
		from   escala_sepse_infantil_item a, sepse_atributo b
		where  a.nr_seq_escala = nr_sequencia_p
		and    a.nr_seq_atributo = b.nr_sequencia
		and	   a.ie_resultado = 'S'  
		and    b.ie_tipo = 'G'; --DO
		
		select	count(*)
		into STRICT	qt_atributo_cliente_w
		from	sepse_atributo a,
				sepse_atributo_cliente b
		where	a.nr_sequencia = b.nr_seq_atributo
		and     a.ie_tipo_sepse = 'P';
		
		if (qt_atributo_cliente_w > 0) then
		begin
			select	max((obter_idade_pf(obter_pessoa_atendimento(nr_atendimento_p,'C'),clock_timestamp(),'A'))::numeric ),
					trunc(max((obter_idade_pf(obter_pessoa_atendimento(nr_atendimento_p,'C'),clock_timestamp(),'DIA'))::numeric ))
			into STRICT	qt_idade_w,
					qt_idade_dia_w
			;
			
			select 	count(*) -- Checa se há registro de idade dentro de uma regra de cliente, caso não tenha, usa a geral definida.
			into STRICT	qt_data_cliente_sepse_w
			from 	sepse_atrib_cliente_regra a,
					sepse_atributo_cliente b
			where (b.nr_seq_atributo = 81
			or		b.nr_seq_atributo = 84)
			and		a.nr_seq_atrib_cliente = b.nr_sequencia;	
			
			if ( qt_data_cliente_sepse_w > 0) then
		
				select coalesce(max(a.ie_obrigatorio),'N')
				into STRICT   ie_obrigatorio_81_w
				from   sepse_atributo_cliente a, SEPSE_ATRIB_CLIENTE_REGRA b
				where  a.nr_sequencia = b.NR_SEQ_ATRIB_CLIENTE
				and    a.nr_seq_atributo = 81
				and    ((qt_idade_dia_w between b.QT_IDADE_MIN_DIAS and b.QT_IDADE_MAX_DIAS)
				or (qt_idade_w between b.qt_idade_min and b.qt_idade_max));

				select coalesce(max(a.ie_obrigatorio),'N')
				into STRICT   ie_obrigatorio_84_w
				from   sepse_atributo_cliente a, SEPSE_ATRIB_CLIENTE_REGRA b
				where  a.nr_sequencia = b.NR_SEQ_ATRIB_CLIENTE
				and    a.nr_seq_atributo = 84
				and    ((qt_idade_dia_w between b.QT_IDADE_MIN_DIAS and b.QT_IDADE_MAX_DIAS)
				or (qt_idade_w between b.qt_idade_min and b.qt_idade_max));
				
			else
				
				select coalesce(max(a.ie_obrigatorio),'N')
				into STRICT   	ie_obrigatorio_81_w
				from   	sepse_atributo_cliente a,
						sepse_regra_liberacao c
				where 	c.ie_tipo_sepse = 'P'
				and    	a.nr_seq_atributo = 81
				and (qt_idade_dia_w BETWEEN c.qt_dias_min and c.qt_dias_max
				or (qt_idade_w BETWEEN c.qt_idade_min and c.qt_idade_max));

				select coalesce(max(a.ie_obrigatorio),'N')
				into STRICT   ie_obrigatorio_84_w
				from   sepse_atributo_cliente a, sepse_regra_liberacao c
				where 	c.ie_tipo_sepse = 'P'
				and    a.nr_seq_atributo = 84
				and (qt_idade_dia_w BETWEEN c.qt_dias_min and c.qt_dias_max
				or (qt_idade_w BETWEEN c.qt_idade_min and c.qt_idade_max));
				
			end if;
			
			if (ie_obrigatorio_81_w = 'N' and ie_obrigatorio_84_w = 'N') then
				select *
				into STRICT   qt_suspeita_w
				from (SELECT count(*)
				from (select nr_seq_atributo
				  from   escala_sepse_infantil_item a, sepse_atributo b
				  where  a.nr_seq_escala = nr_sequencia_p
				  and    a.nr_seq_atributo = b.nr_sequencia
				  and	 a.ie_resultado = 'S'  
				  and    b.ie_tipo = 'S') alias2) alias3; --SIRS
			elsif (ie_obrigatorio_81_w = 'S' and ie_obrigatorio_84_w = 'N') then
				begin
					select *
					into STRICT   qt_suspeita_w
					from (SELECT count(*)
					from (select nr_seq_atributo
						  from   escala_sepse_infantil_item a, sepse_atributo b
						  where  a.nr_seq_escala = nr_sequencia_p
						  and    a.nr_seq_atributo = b.nr_sequencia
						  and	 a.ie_resultado = 'S'  
						  and    b.ie_tipo = 'S') --SIRS
					having sum(CASE WHEN nr_seq_atributo=81 THEN 1  ELSE 0 END ) > 0) alias4;
				exception when others then
					qt_suspeita_w := 0;
				end;
			elsif (ie_obrigatorio_81_w = 'N' and ie_obrigatorio_84_w = 'S') then	
				begin
					select *
					into STRICT   qt_suspeita_w
					from (SELECT count(*)
					from (select nr_seq_atributo
						  from   escala_sepse_infantil_item a, sepse_atributo b
						  where  a.nr_seq_escala = nr_sequencia_p
						  and    a.nr_seq_atributo = b.nr_sequencia
						  and	 a.ie_resultado = 'S'  
						  and    b.ie_tipo = 'S') --SIRS
					having sum(CASE WHEN nr_seq_atributo=84 THEN 1  ELSE 0 END ) > 0) alias4;
				exception when others then
					qt_suspeita_w := 0;
				end;
			else
				begin
				select *
				into STRICT   qt_suspeita_w -- Contabiliza suspeita dentro de Sepse Infantil
				from (SELECT count(*)
				from (select nr_seq_atributo
					  from   escala_sepse_infantil_item a, sepse_atributo b
					  where  a.nr_seq_escala = nr_sequencia_p
					  and    a.nr_seq_atributo = b.nr_sequencia
					  and	 a.ie_resultado = 'S'
					  and    b.ie_tipo = 'S') --SIRS			
					having sum(CASE WHEN nr_seq_atributo=81 THEN CASE WHEN nr_seq_atributo=84 THEN 1  ELSE 0 END   ELSE 0 END ) > 0) alias3;
				exception when others then
					qt_suspeita_w := 0;
				end;
			end if;
		end;	
		else
			begin
				select *
				into STRICT   qt_suspeita_w
				from (SELECT count(*)
				from (select nr_seq_atributo
					  from   escala_sepse_infantil_item a, sepse_atributo b
					  where  a.nr_seq_escala = nr_sequencia_p
					  and    a.nr_seq_atributo = b.nr_sequencia
					  and	 a.ie_resultado = 'S'  
					  and    b.ie_tipo = 'S') --SIRS
				having sum(CASE WHEN nr_seq_atributo=81 THEN 1  ELSE CASE WHEN nr_seq_atributo=84 THEN 1  ELSE 0 END  END ) > 0) alias3;
			exception when others then
				qt_suspeita_w := 0;
			end;
		end if;
	end;	
	else

		nr_seq_escala_w := 124;
		
		select  count(1)
		into STRICT    qt_disfuncao_w
		from    escala_sepse_item
		where   nr_seq_escala = nr_sequencia_p
		and     ie_resultado = 'S'
		and     ((ie_versao_sepse_w = '1' and nr_seq_atributo in (8,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,30,31,32,34))
		or (ie_versao_sepse_w = '2' and nr_seq_atributo in (41,42,51,59,60,61,62,65,66,72,76,77,95,102,103)));

		select  count(1)
		into STRICT    qt_suspeita_w
		from    escala_sepse_item
		where   nr_seq_escala = nr_sequencia_p
		and     ie_resultado = 'S'
		and     ((ie_versao_sepse_w = '1' and nr_seq_atributo in (4,5,6,7,8,9,11,17,30,31,32,33,35))
		or (ie_versao_sepse_w = '2' and nr_seq_atributo in (47,48,49,50,54,55,56,75)));
		
	end if;

    select  count(1)
    into STRICT    qt_var_w
    from    gqa_pendencia_regra a,
            gqa_pendencia       b
    where   b.nr_sequencia = a.nr_seq_pendencia
    and     b.ie_situacao = 'A'
    and     a.ie_regra_sepse = 'SE'
    and     a.ie_situacao = 'A'
    and     qt_suspeita_w >= coalesce(a.qt_var_suspeita,0)
    and     qt_disfuncao_w >= coalesce(a.qt_var_confirmada,0)
    and     (a.qt_var_suspeita IS NOT NULL AND a.qt_var_suspeita::text <> '')
    and     (a.qt_var_confirmada IS NOT NULL AND a.qt_var_confirmada::text <> '')
	and		GQA_regra_complementar(nm_usuario_p,nr_atendimento_p,a.nr_sequencia) = 'X';
	
    if ( qt_var_w > 0 ) then
        CALL alterar_status_escala_sepse(nr_sequencia_p,'SE',nm_usuario_p,'',nr_atendimento_p);
    end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE verificar_se_sepse_aberto ( nr_sequencia_p bigint, nr_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

