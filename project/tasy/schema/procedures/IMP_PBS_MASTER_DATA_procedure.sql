-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE imp_pbs_master_data ( nr_pbs_version_p bigint, nm_usuario_p text) AS $body$
DECLARE


pbsimp_master_w			pbsimp_master%ROWTYPE;
pbsimp_benf_types_w		pbsimp_benf_types%ROWTYPE;
pbsimp_br_mappings_w	pbsimp_benf_restr_mapping%ROWTYPE;
pbsimp_disp_rules_w		pbsimp_disp_rules_master%ROWTYPE;
pbsimp_markups_w		pbsimp_markups%ROWTYPE;
pbsimp_fee_defs_w		pbsimp_fee_defs%ROWTYPE;
pbsimp_cont_defs_w		pbsimp_container_defs%ROWTYPE;
nr_count_w				pbsimp_master.nr_sequencia%TYPE := 0;
nr_pbsimp_seq_w			pbsimp_master.nr_sequencia%TYPE;
nr_pbsimp_benf_seq_w	pbsimp_master.nr_sequencia%TYPE;
nr_pbsimp_br_map_seq_w	pbsimp_master.nr_sequencia%TYPE;
nr_pbsimp_restr_seq_w	pbsimp_master.nr_sequencia%TYPE;
nr_pbsimp_disp_seq_w	pbsimp_master.nr_sequencia%TYPE;
nr_pbsimp_markup_seq_w	pbsimp_master.nr_sequencia%TYPE;
nr_pbsimp_fee_seq_w		pbsimp_master.nr_sequencia%TYPE;
nr_pbsimp_cont_seq_w	pbsimp_master.nr_sequencia%TYPE;
cd_restr_xml_id_w		pbsimp_restrictions.restriction_xml_id%TYPE;
cd_disp_rule_w			pbsimp_disp_rules_master.cd_disp_rule%TYPE;
ds_disp_rule_w			pbsimp_disp_rules_master.ds_disp_rule%TYPE;
ie_default_rule_w		pbsimp_disp_rules_master.ie_default_rule%TYPE;
ds_disp_fee_w			pbsimp_disp_rules_master.ds_disp_rule%TYPE;
ds_cont_fee_w			pbsimp_disp_rules_master.ds_disp_rule%TYPE;

c_pbsimp_master_w CURSOR FOR
  SELECT a.cd_pbs_code,
    a.ds_preferred_term,
    b.cd_program_code,
    b.ds_program_category,
    b.ds_pricing_model_code,
    b.ds_additional_data,
    c.qt_max_packs,
    c.qt_max_units,
    c.cd_max_units,
    c.qt_num_of_repeats,
    c.cd_atc,
    c.cd_safety_net_duration
  from pbsload_pres_rules a,
    pbsload_program_master b,
    pbsload_pres_sub_types c
  where a.nr_pbs_version = nr_pbs_version_p
  and a.NR_PROGRAM_MASTER_REF = b.nr_sequencia
  and c.NR_PRES_RULE_MASTER_REF = a.nr_sequencia
  and b.nr_pbs_version = nr_pbs_version_p
  and c.nr_pbs_version = nr_pbs_version_p;

c_pbsimp_benf_members_w CURSOR(p_cd_pbs  text) FOR
	SELECT b.cd_pbs_code,
		a.cd_pres_type,
		c.cd_mem_code,
		a.ds_benf_type_rdf_desc,
		a.nr_sequencia benf_type_ref,
		b.nr_sequencia pres_rule_ref
	from
		pbsload_benf_types a,
		pbsload_pres_rules b,
		pbsload_benf_members c
	where b.cd_pbs_code = p_cd_pbs
	and a.nr_pres_rule_master_ref = b.nr_sequencia
	and c.nr_benf_type_ref = a.nr_sequencia
	and a.nr_pbs_version = nr_pbs_version_p
	and a.cd_pres_type = 'DEFAULT'
	and b.nr_pbs_version = nr_pbs_version_p
	and c.nr_pbs_version = nr_pbs_version_p;

c_pbsimp_benf_restr_lnk_w CURSOR(p_pres_rule_ref  bigint, p_benf_type_ref  bigint) FOR
	SELECT distinct cd_restriction_xml_ref
	from pbsload_benf_restrictions a
	where a.nr_pres_rule_master_ref = p_pres_rule_ref
	and a.nr_benf_type_ref = p_benf_type_ref
	and a.nr_pbs_version = nr_pbs_version_p;

c_pbsimp_disp_rule_w CURSOR FOR
	SELECT a.ds_disp_rule_rdf,
		b.cd_program_code,
		c.CD_MEMBER_CODE,
		a.nr_sequencia
	from PBSLOAD_DISP_RULES a
	join PBSLOAD_PROGRAM_MASTER b
		on a.nr_pbs_version = nr_pbs_version_p
		and a.nr_program_master_ref = b.nr_sequencia
		and b.nr_pbs_version = nr_pbs_version_p
	left outer join pbsload_member_lists c
		on c.nr_pbs_version = nr_pbs_version_p
		and c.cd_src_type = 'dispensing-rule'
		and c.ds_member_code like '%default'
		and a.cd_disp_rule_xml_id = c.cd_src_xml_id;

c_pbsimp_markups_w CURSOR(p_disprule_ref  bigint) FOR
	SELECT cd_markup_code,
		qt_markup_limit,
		qt_markup_offset,
		qt_markup_fixed,
		qt_markup_variable
	from pbsload_markups
	where nr_pbs_version = nr_pbs_version_p
	and nr_disp_rule_ref = p_disprule_ref;

c_pbsimp_feedef_w CURSOR(p_disprule_ref  bigint) FOR
	SELECT ds_fee_def_rdf,
		qt_amount
	from pbsload_fee_defs
	where nr_pbs_version = nr_pbs_version_p
	and nr_disp_rule_ref = p_disprule_ref;

c_pbsimp_contdef_w CURSOR(p_disprule_ref  bigint) FOR
	SELECT ds_container_def_rdf,
		qt_amount
	from pbsload_container_defs
	where nr_pbs_version = nr_pbs_version_p
	and nr_disp_rule_ref = p_disprule_ref;
BEGIN

	commit;

	nr_count_w := 0;
	--loop1: for PBS_MASTER and related tables
	for r_pbsimp_master_w in c_pbsimp_master_w loop

		--1. Insert into PBSIMP_MASTER
        select nextval('pbsimp_master_seq') into STRICT nr_pbsimp_seq_w;

		pbsimp_master_w.nr_sequencia 			:= nr_pbsimp_seq_w;
		pbsimp_master_w.dt_atualizacao 			:= clock_timestamp();
		pbsimp_master_w.nm_usuario 				:= nm_usuario_p;
		pbsimp_master_w.nr_pbs_version 			:= nr_pbs_version_p;
		pbsimp_master_w.ie_dirty_pbs_rules 		:= null;
		pbsimp_master_w.ie_changes_imported 	:= null;
		pbsimp_master_w.ie_dirty_check 			:= null;
		pbsimp_master_w.cd_pbs 					:= r_pbsimp_master_w.cd_pbs_code;
		pbsimp_master_w.ds_mpp 					:= r_pbsimp_master_w.ds_preferred_term;
		pbsimp_master_w.cd_program 				:= r_pbsimp_master_w.cd_program_code;
		pbsimp_master_w.ds_program_cat 			:= r_pbsimp_master_w.ds_program_category;
		pbsimp_master_w.ie_situacao 			:= 'A';
		pbsimp_master_w.ds_pricing_model 		:= r_pbsimp_master_w.ds_pricing_model_code;
		pbsimp_master_w.ds_additional_info 		:= r_pbsimp_master_w.ds_additional_data;
		pbsimp_master_w.qt_max_packs 			:= r_pbsimp_master_w.qt_max_packs;
		pbsimp_master_w.qt_max_units 			:= r_pbsimp_master_w.qt_max_units;
		pbsimp_master_w.cd_max_units 			:= r_pbsimp_master_w.cd_max_units;
		pbsimp_master_w.qt_num_repeats 			:= r_pbsimp_master_w.qt_num_of_repeats;
		pbsimp_master_w.cd_atc 					:= r_pbsimp_master_w.cd_atc;
		pbsimp_master_w.cd_safety_net_duration 	:= r_pbsimp_master_w.cd_safety_net_duration;

		INSERT INTO pbsimp_master VALUES (pbsimp_master_w.*);

		--2. Insert into PBSIMP_BENF_TYPES
		for r_pbsimp_benf_members_w IN c_pbsimp_benf_members_w(r_pbsimp_master_w.cd_pbs_code) loop

            select nextval('pbsimp_benf_types_seq') into STRICT nr_pbsimp_benf_seq_w;

			pbsimp_benf_types_w.nr_sequencia               := nr_pbsimp_benf_seq_w;
			pbsimp_benf_types_w.dt_atualizacao             := clock_timestamp();
			pbsimp_benf_types_w.nm_usuario                 := nm_usuario_p;
			pbsimp_benf_types_w.nr_pbs_version             := nr_pbs_version_p;
			pbsimp_benf_types_w.pbsimp_master_ref          := nr_pbsimp_seq_w;
			pbsimp_benf_types_w.cd_pbs                     := r_pbsimp_benf_members_w.cd_pbs_code;
			pbsimp_benf_types_w.ie_dirty_check             := null;
			pbsimp_benf_types_w.cd_prescription_type       := r_pbsimp_benf_members_w.cd_pres_type;
			pbsimp_benf_types_w.cd_prescriber_type         := r_pbsimp_benf_members_w.cd_mem_code;
			pbsimp_benf_types_w.cd_benefit_type            := r_pbsimp_benf_members_w.ds_benf_type_rdf_desc;
			pbsimp_benf_types_w.qt_eapproval_threshold     := null;
			pbsimp_benf_types_w.ie_situacao                := 'A';
			-- pbsimp_benf_types_w.pbsimp_restrictions_xml_id := null; --Now we have a linkage table for benf type and restrictions mapping
			INSERT INTO pbsimp_benf_types VALUES (pbsimp_benf_types_w.*);

			--3. Insert into PBSIMP_BENF_RESTR_MAPPING
			for r_pbsimp_benf_restr_lnk_w in c_pbsimp_benf_restr_lnk_w(r_pbsimp_benf_members_w.pres_rule_ref, r_pbsimp_benf_members_w.benf_type_ref) loop

				cd_restr_xml_id_w := replace( r_pbsimp_benf_restr_lnk_w.cd_restriction_xml_ref,'#', null);

				select max(nr_sequencia)
					into STRICT nr_pbsimp_restr_seq_w from pbsimp_restrictions
				where NR_PBS_VERSION = nr_pbs_version_p and RESTRICTION_XML_ID = cd_restr_xml_id_w
				and ie_situacao = 'A';

				if ( coalesce(nr_pbsimp_restr_seq_w, 0) != 0 ) then

                    select nextval('pbsimp_benf_restr_mapping_seq') into STRICT nr_pbsimp_br_map_seq_w;

					pbsimp_br_mappings_w.nr_sequencia        :=  nr_pbsimp_br_map_seq_w;
					pbsimp_br_mappings_w.dt_atualizacao      :=  clock_timestamp();
					pbsimp_br_mappings_w.nm_usuario          :=  nm_usuario_p;
					pbsimp_br_mappings_w.nr_pbs_version      :=  nr_pbs_version_p;
					pbsimp_br_mappings_w.nr_benftype_ref     :=  nr_pbsimp_benf_seq_w;
					pbsimp_br_mappings_w.nr_restrictions_ref :=  nr_pbsimp_restr_seq_w;
					pbsimp_br_mappings_w.ie_dirty_check      :=  null;
					pbsimp_br_mappings_w.ie_situacao         :=  'A';

					INSERT INTO PBSIMP_BENF_RESTR_MAPPING VALUES (pbsimp_br_mappings_w.*);

				end if;

			end loop; --end of r_pbsimp_benf_restr_lnk_w
		end loop; --end of r_pbsimp_benf_members_w
		nr_count_w := nr_count_w + 1;

		if ( mod(nr_count_w,500) = 0 ) then
			commit;
		end if;

	end loop; --end of r_pbsimp_master_w
	nr_count_w := 0;
	--loop2: for PBS dispensing rules
	for r_pbsimp_disp_rule_w in c_pbsimp_disp_rule_w loop

		--4. Insert into PBSIMP_DISP_RULES_MASTER
        select nextval('pbsimp_disp_rules_master_seq') into STRICT nr_pbsimp_disp_seq_w;

		cd_disp_rule_w 		:= SUBSTR(r_pbsimp_disp_rule_w.ds_disp_rule_rdf,INSTR(r_pbsimp_disp_rule_w.ds_disp_rule_rdf, '/', -1)+1);

		if ( coalesce(r_pbsimp_disp_rule_w.cd_member_code,'no') = 'yes') then
			ie_default_rule_w := 'S';
		else
			ie_default_rule_w := null;
		end if;

		select max(ds_title)
		into STRICT ds_disp_rule_w
		from PBSLOAD_RDF
		where nr_pbs_version = nr_pbs_version_p
		and rdf_about = r_pbsimp_disp_rule_w.ds_disp_rule_rdf;

		pbsimp_disp_rules_w.NR_SEQUENCIA        :=  nr_pbsimp_disp_seq_w;
		pbsimp_disp_rules_w.DT_ATUALIZACAO      :=  clock_timestamp();
		pbsimp_disp_rules_w.NM_USUARIO          :=  nm_usuario_p;
		pbsimp_disp_rules_w.NR_PBS_VERSION      :=  nr_pbs_version_p;
		pbsimp_disp_rules_w.PROGRAM_CODE_REF    :=  r_pbsimp_disp_rule_w.CD_PROGRAM_CODE;
		pbsimp_disp_rules_w.CD_DISP_RULE        :=  cd_disp_rule_w;
		pbsimp_disp_rules_w.IE_DIRTY_CHECK      :=  null;
		pbsimp_disp_rules_w.DS_DISP_RULE        :=  ds_disp_rule_w;
		pbsimp_disp_rules_w.IE_DEFAULT_RULE     :=  ie_default_rule_w;
		pbsimp_disp_rules_w.IE_SITUACAO         :=  'A';

		INSERT INTO PBSIMP_DISP_RULES_MASTER VALUES (pbsimp_disp_rules_w.*);

		--5. Insert into PBSIMP_MARKUPS
		for r_pbsimp_markups_w in c_pbsimp_markups_w(r_pbsimp_disp_rule_w.nr_sequencia) loop
            select nextval('pbsimp_markups_seq') into STRICT nr_pbsimp_markup_seq_w;

			pbsimp_markups_w.nr_sequencia        := nr_pbsimp_markup_seq_w;
			pbsimp_markups_w.dt_atualizacao      := clock_timestamp();
			pbsimp_markups_w.nm_usuario          := nm_usuario_p;
			pbsimp_markups_w.nr_pbs_version      := nr_pbs_version_p;
			pbsimp_markups_w.disp_rule_ref       := nr_pbsimp_disp_seq_w;
			pbsimp_markups_w.cd_markup_code      := r_pbsimp_markups_w.cd_markup_code;
			pbsimp_markups_w.ie_dirty_check      := null;
			pbsimp_markups_w.qt_markup_limit     := r_pbsimp_markups_w.qt_markup_limit;
			pbsimp_markups_w.qt_markup_offset    := r_pbsimp_markups_w.qt_markup_offset;
			pbsimp_markups_w.qt_markup_fixed     := r_pbsimp_markups_w.qt_markup_fixed;
			pbsimp_markups_w.qt_markup_variable  := r_pbsimp_markups_w.qt_markup_variable;
			pbsimp_markups_w.ie_situacao         := 'A';

			INSERT INTO PBSIMP_MARKUPS VALUES (pbsimp_markups_w.*);

		end loop; --end of r_pbsimp_markups_w
		--6. Insert into PBSIMP_FEE_DEFS
		for r_pbsimp_feedef_w in c_pbsimp_feedef_w(r_pbsimp_disp_rule_w.nr_sequencia) loop
            select nextval('pbsimp_fee_defs_seq') into STRICT nr_pbsimp_fee_seq_w;

			select max(ds_title)
			into STRICT ds_disp_fee_w
			from PBSLOAD_RDF
			where nr_pbs_version = nr_pbs_version_p
			and rdf_about = r_pbsimp_feedef_w.ds_fee_def_rdf;

			pbsimp_fee_defs_w.nr_sequencia        	:=  nr_pbsimp_fee_seq_w;
			pbsimp_fee_defs_w.dt_atualizacao      	:=  clock_timestamp();
			pbsimp_fee_defs_w.nm_usuario          	:=  nm_usuario_p;
			pbsimp_fee_defs_w.nr_pbs_version      	:=  nr_pbs_version_p;
			pbsimp_fee_defs_w.disp_rule_ref       	:=  nr_pbsimp_disp_seq_w;
			pbsimp_fee_defs_w.ie_dirty_check      	:=  null;
			pbsimp_fee_defs_w.cd_fee_type		 	:=  SUBSTR(r_pbsimp_feedef_w.ds_fee_def_rdf,INSTR(r_pbsimp_feedef_w.ds_fee_def_rdf, '/', -1)+1);
			pbsimp_fee_defs_w.ds_fee_type         	:=  ds_disp_fee_w;
			pbsimp_fee_defs_w.qt_fee_amount       	:=  r_pbsimp_feedef_w.qt_amount;
			pbsimp_fee_defs_w.ie_situacao         	:= 'A';

			INSERT INTO PBSIMP_FEE_DEFS VALUES (pbsimp_fee_defs_w.*);

		end loop; --end of r_pbsimp_feedef_w
		--7. Insert into PBSIMP_CONTAINER_DEFS
		for r_pbsimp_contdef_w in c_pbsimp_contdef_w(r_pbsimp_disp_rule_w.nr_sequencia) loop
			select nextval('pbsimp_container_defs_seq') into STRICT nr_pbsimp_cont_seq_w;
			select max(ds_title)
			into STRICT ds_cont_fee_w
			from pbsload_rdf
			where nr_pbs_version = nr_pbs_version_p
			and rdf_about = r_pbsimp_contdef_w.ds_container_def_rdf;

			pbsimp_cont_defs_w.nr_sequencia        := nr_pbsimp_cont_seq_w;
			pbsimp_cont_defs_w.dt_atualizacao      := clock_timestamp();
			pbsimp_cont_defs_w.nm_usuario          := nm_usuario_p;
			pbsimp_cont_defs_w.nr_pbs_version      := nr_pbs_version_p;
			pbsimp_cont_defs_w.disp_rule_ref       := nr_pbsimp_disp_seq_w;
			pbsimp_cont_defs_w.ie_dirty_check      := null;
			pbsimp_cont_defs_w.cd_type				:= SUBSTR(r_pbsimp_contdef_w.ds_container_def_rdf,INSTR(r_pbsimp_contdef_w.ds_container_def_rdf, '/', -1)+1);
			pbsimp_cont_defs_w.ds_type             := ds_cont_fee_w;
			pbsimp_cont_defs_w.qt_amount           := r_pbsimp_contdef_w.qt_amount;
			pbsimp_cont_defs_w.ie_situacao         := 'A';

			INSERT INTO PBSIMP_CONTAINER_DEFS VALUES (pbsimp_cont_defs_w.*);

		end loop; --end of r_pbsimp_contdef_w
		nr_count_w := nr_count_w + 1;

		if ( mod(nr_count_w,500) = 0 ) then
			commit;
		end if;

	end loop; --end of r_pbsimp_disp_rule_w
	commit; --commit before returning
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE imp_pbs_master_data ( nr_pbs_version_p bigint, nm_usuario_p text) FROM PUBLIC;

