-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE contabiliza_controle_terceiro ( nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text) AS $body$
DECLARE


dt_referencia_w                         timestamp;
dt_Contabil_w                           timestamp;
cd_estabelecimento_w                    lote_contabil.cd_estabelecimento%type;
nr_documento_w                          bigint;
nr_doc_w                                bigint;
cd_conta_contabil_w                     terceiro.cd_conta_contabil%type;
vl_transacao_w                          double precision;
nr_seq_trans_fin_w                      bigint;
cd_centro_custo_w                       terceiro.cd_centro_custo%type;
ds_conteudo_w                           varchar(255) := '';
ie_compl_hist_w                         varchar(3);
cd_pessoa_fisica_w                      varchar(10);
cd_cgc_w                                terceiro.cd_cgc%type;
nm_terceiro_w                           varchar(80);
ie_ctb_terc_estab_conta_w               varchar(01);
ie_contab_som_terc_conta_w              varchar(1);
nr_seq_movto_w                          bigint;
nr_terceiro_w                           terceiro.nr_sequencia%type;
nr_titulo_w                             varchar(255);
nr_seq_conta_w                          terceiro_Operacao.nr_seq_conta%type;
nr_seq_agrupamento_w                    movimento_contabil.nr_seq_agrupamento%type;
nm_agrupador_w                          varchar(255);
cd_tipo_lote_contabil_w                 bigint;

c010 CURSOR FOR
        SELECT  a.nr_doc,
                round((trunc(coalesce(a.vl_operacao,0) * coalesce(a.qt_operacao,1),2))::numeric,2) vl_transacao,
                coalesce(a.nr_seq_trans_fin, b.nr_seq_trans_fin),
                c.cd_conta_contabil,
                coalesce(c.cd_centro_custo,0),
                c.cd_pessoa_fisica,
                c.cd_cgc,
                c.nr_sequencia,
                a.nr_seq_conta
        from    terceiro c,
                operacao_terceiro b,
                terceiro_Operacao a
        where   nr_Lote_contabil        = nr_lote_contabil_p
        and     a.nr_seq_operacao       = b.nr_sequencia
        and     a.nr_seq_terceiro       = c.nr_sequencia
        and     (coalesce(a.nr_seq_trans_fin, b.nr_seq_trans_fin) IS NOT NULL AND (coalesce(a.nr_seq_trans_fin, b.nr_seq_trans_fin))::text <> '')
        and     coalesce(vl_operacao,0)      <> 0
        and     ((ie_contab_som_terc_conta_w = 'N') or ((ie_contab_som_terc_conta_w = 'S') and (coalesce(c.cd_conta_contabil,'0') <> '0')))
        and     cd_estabelecimento_w    = CASE WHEN ie_ctb_terc_estab_conta_w='S' THEN  a.cd_estabelecimento  ELSE c.cd_estabelecimento END;


BEGIN
        if (ie_exclusao_p <> 'S') then
                select b.cd_tipo_lote_contabil
                into STRICT cd_tipo_lote_contabil_w
                from lote_contabil b
                where b.nr_lote_contabil = nr_lote_contabil_p;
                if (cd_tipo_lote_contabil_w <> 9) then
                        CALL wheb_mensagem_pck.exibir_mensagem_abort(261346);
                end if;
        end if;
        ds_retorno_p            := null;
        delete  FROM w_movimento_contabil
        where   nr_lote_contabil        = nr_lote_contabil_p;

        delete
        from    lote_contabil_log
        where   nr_lote_contabil = nr_lote_contabil_p
        and     cd_log_lote in (9,10);

        commit;

        select  trunc(dt_referencia,'month'),
                dt_referencia,
                cd_estabelecimento,
                obter_se_compl_tipo_lote(cd_estabelecimento, cd_tipo_lote_contabil)
        into STRICT    dt_referencia_w,
                dt_contabil_w,
                cd_estabelecimento_w,
                ie_compl_hist_w
        from    lote_contabil
        where   nr_lote_contabil        = nr_lote_contabil_p;

        select  coalesce(max(ie_ctb_terc_estab_conta),'N'),
                coalesce(max(ie_contab_som_terc_conta),'S')
        into STRICT    ie_ctb_terc_estab_conta_w,
                ie_contab_som_terc_conta_w
        from    parametro_contas_receber
        where   cd_estabelecimento      = cd_estabelecimento_w;

        /* Identifica se e exclusao do lote */

        if (ie_exclusao_p          = 'S') then
                delete  from movimento_contabil
                where   nr_lote_contabil        = nr_lote_contabil_p;

                Update  lote_contabil
                set     vl_credito              = 0,
                        vl_debito               = 0
                where   nr_lote_contabil        = nr_lote_contabil_p;

                update  terceiro_operacao
                set     nr_lote_contabil        = 0
                where   nr_lote_contabil        = nr_lote_contabil_p;
        else
                update  terceiro_operacao a
                set     a.nr_lote_contabil              = nr_lote_contabil_p
                where   coalesce(a.nr_lote_contabil,0)       = 0
                and   exists (SELECT 1
                        from terceiro_conta b
                        where   a.nr_seq_conta          = b.nr_sequencia
                        and     a.cd_estabelecimento    = cd_estabelecimento_w
                        and     trunc(b.dt_mesano_referencia,'month')   = trunc(dt_referencia_w,'month')
                        and     b.ie_status_conta       = 'D');

                ds_retorno_p            := null;

                nm_agrupador_w  := coalesce(trim(both obter_agrupador_contabil(9)),'NR_SEQ_CONTA');

                open c010;
                loop
                fetch c010 into
                        nr_documento_w,
                        vl_transacao_w,
                        nr_seq_trans_fin_w,
                        cd_conta_contabil_w,
                        cd_centro_custo_w,
                        cd_pessoa_fisica_w,
                        cd_cgc_w,
                        nr_terceiro_w,
                        nr_seq_conta_w;
                EXIT WHEN NOT FOUND; /* apply on c010 */
                        nr_doc_w                := nr_documento_w;
                        nr_documento_w          := 0;
                        nr_titulo_w             := '';

                        if (nm_agrupador_w = 'NR_SEQ_TERCEIRO')then
                                nr_seq_agrupamento_w    :=      somente_numero(nr_terceiro_w);
                        elsif (nm_agrupador_w = 'NR_SEQ_CONTA')then
                                nr_seq_agrupamento_w    :=      somente_numero(nr_seq_conta_w);
                        elsif (nm_agrupador_w = 'NR_DOC')then
                                nr_seq_agrupamento_w    :=      somente_numero(nr_documento_w);
                        end if;

                        if (coalesce(nr_seq_agrupamento_w,0) =  0) then
                                nr_seq_agrupamento_w    := somente_numero(nr_seq_conta_w);
                        end if;


                        if (coalesce(nr_seq_conta_w,0) <> 0)then
                                nr_titulo_w     := substr(obter_tit_rec_terc_conta(nr_seq_conta_w,'T'),1,200);
                        end if;

                        nm_terceiro_w   := substr(obter_nome_pf_pj(cd_pessoa_fisica_w,cd_cgc_w),1,80);

                        if (ie_compl_hist_w = 'S') then
                                        ds_conteudo_w   := substr(      vl_transacao_w          || '#@' ||
                                                                        nm_terceiro_w           || '#@' ||
                                                                        nr_doc_w                || '#@' ||
                                                                        nr_titulo_w,1,255);
                        end if;

                        nr_seq_movto_w := Gerar_Contab_trans_financ(
                                cd_estabelecimento_w, null, nr_lote_contabil_p, nm_usuario_p, cd_conta_contabil_w, cd_centro_custo_w, -- Edgar 17/01/2007 OS 48490, coloquei o cd_centro_custo_w
                                nr_documento_w, nr_seq_agrupamento_w, dt_contabil_w, trunc(vl_transacao_w,2), nr_seq_trans_fin_w, null, 'VL_OPERACAO', cd_pessoa_fisica_w, cd_cgc_w, 0, null, null, null, ds_conteudo_w, null, null, null, null, null, null, null, null, null, null, null, null, null, null, nr_seq_movto_w);
                end loop;
                close c010;
                CALL agrupa_movimento_contabil(nr_lote_contabil_p, nm_usuario_p);
        end if;
commit;

if (ie_exclusao_p = 'S') then
        ds_retorno_p            := wheb_mensagem_pck.get_texto(165188,null);
        CALL ctb_gravar_log_lote( nr_lote_contabil_p, 2, '', nm_usuario_p);
else
        ds_retorno_p            := wheb_mensagem_pck.get_texto(165187,null);
        CALL ctb_gravar_log_lote( nr_lote_contabil_p, 1, '', nm_usuario_p);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE contabiliza_controle_terceiro ( nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text) FROM PUBLIC;

