-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inserir_tit_notific (nr_titulo_p titulo_receber.nr_titulo%type, nr_seq_lote_p pls_notificacao_lote.nr_sequencia%type, nr_seq_notific_pagador_p pls_notificacao_item.nr_seq_notific_pagador%type, ie_tipo_vinculacao_p pls_notificacao_item.ie_tipo_vinculacao%type, nm_usuario_p pls_notificacao_item.nm_usuario%type ) AS $body$
DECLARE

 
ie_rescindir_contrato_w	pls_notificacao_regra.ie_rescindir_contrato%type;
ie_titulo_perda_w	pls_notificacao_regra.ie_titulo_perda%type;
ie_suspender_atend_w	pls_notificacao_regra.ie_suspender_atend%type;
vl_juros_w		double precision	:= 0;
vl_multa_w		double precision	:= 0;


BEGIN 
select	b.ie_rescindir_contrato, 
	b.ie_titulo_perda, 
	b.ie_suspender_atend 
into STRICT	ie_rescindir_contrato_w, 
	ie_titulo_perda_w, 
	ie_suspender_atend_w 
from	pls_notificacao_lote	a, 
	pls_notificacao_regra	b 
where	a.nr_seq_regra	= b.nr_sequencia 
and	a.nr_sequencia	= nr_seq_lote_p;
 
vl_juros_w	:= coalesce(obter_juros_multa_titulo(nr_titulo_p, clock_timestamp(), 'R', 'J'),0);
vl_multa_w	:= coalesce(obter_juros_multa_titulo(nr_titulo_p, clock_timestamp(), 'R', 'M'),0);
 
insert into pls_notificacao_item(nr_sequencia, 
	nr_seq_notific_pagador, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	nr_seq_regra, 
	nr_seq_mensalidade, 
	nr_seq_contrato, 
	ie_rescindir_contrato, 
	nr_titulo, 
	vl_saldo_titulo, 
	vl_juros, 
	vl_multa, 
	vl_titulo, 
	dt_vencimento_titulo, 
	dt_liquidacao, 
	vl_pagar, 
	ie_suspender_contrato, 
	dt_vencimento_original, 
	ie_tipo_vinculacao) 
SELECT	nextval('pls_notificacao_item_seq'), 
	nr_seq_notific_pagador_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	null, 
	a.nr_seq_mensalidade, 
	b.nr_seq_contrato, 
	ie_rescindir_contrato_w, 
	a.nr_titulo, 
	coalesce(a.vl_saldo_titulo,0), 
	vl_juros_w, 
	vl_multa_w, 
	coalesce(a.vl_titulo,0), 
	a.dt_pagamento_previsto, 
	a.dt_liquidacao, 
	(CASE WHEN ie_titulo_perda_w='S' THEN  coalesce(a.vl_titulo,0)  ELSE coalesce(a.vl_saldo_titulo,0) END  + vl_juros_w + vl_multa_w), 
	ie_suspender_atend_w, 
	a.dt_vencimento, 
	ie_tipo_vinculacao_p 
FROM pls_contrato_pagador b, titulo_receber a
LEFT OUTER JOIN pls_notificacao_item c ON (a.nr_titulo = c.nr_titulo AND nr_seq_notific_pagador_p = c.nr_seq_notific_pagador)
WHERE b.nr_sequencia			= a.nr_seq_pagador   and coalesce(c.nr_sequencia::text, '') = ''  -- para não inserir titulos duplicados na mesma notificação 
  and a.nr_titulo 			= nr_titulo_p;
 
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inserir_tit_notific (nr_titulo_p titulo_receber.nr_titulo%type, nr_seq_lote_p pls_notificacao_lote.nr_sequencia%type, nr_seq_notific_pagador_p pls_notificacao_item.nr_seq_notific_pagador%type, ie_tipo_vinculacao_p pls_notificacao_item.ie_tipo_vinculacao%type, nm_usuario_p pls_notificacao_item.nm_usuario%type ) FROM PUBLIC;

