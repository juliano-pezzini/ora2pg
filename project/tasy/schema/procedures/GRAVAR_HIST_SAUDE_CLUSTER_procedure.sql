-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_hist_saude_cluster ( nr_seq_template_p text, nr_seq_reg_template_p text, nr_seq_linked_data_p text, nm_tabela_p text, nr_sequencia_p bigint, cd_pessoa_fisica_p text, ie_liberar_p text, nr_atendimento_p bigint, nr_seq_reg_elemento_p bigint, nm_usuario_p text, nr_seq_registro_p INOUT bigint, ds_erro_p INOUT text, nr_seq_triagem_p bigint default 0, nr_seq_atend_cons_pepa_p bigint default null) AS $body$
DECLARE


cd_perfil_w bigint;
dt_liberacao_w timestamp;
ie_nega_w varchar(1);
cont_w bigint := 0;
ds_sql_w varchar(4000);
vl_campo_w varchar(4000);
nr_seq_hist_saude_w bigint;
cd_setor_atend_w integer;
ds_coluns_w varchar(4000);
ds_values_w varchar(4000);
ds_comando_w varchar(4000);
nr_seq_triagem_w bigint;
ie_confirmacao_w varchar(1);
ds_parametro_w varchar(4000);
cd_profissional_w varchar(10);
nm_usuario_liberacao_w varchar(20);

cd_doenca_w paciente_antec_clinico.cd_doenca%type;
column_name_cluster_w user_tab_cols.column_name%type;
ie_paciente_w paciente_antec_clinico.ie_paciente%type;
nr_sequencia_w paciente_antec_clinico.nr_sequencia%type;

c01 CURSOR FOR
  SELECT *
  from  historico_saude
  where  nr_sequencia  = nr_sequencia_p;

c02 CURSOR FOR
  SELECT  a.nm_tabela,
    a.nm_atributo,
    a.ie_tipo_campo,
    b.nr_inf_adic,
    b.ds_inf_adic,
    b.dt_inf_adic
  from  historico_saude_inf_adic a,
    hist_saude_inf_adic_item b
  where  a.nr_sequencia    = b.nr_seq_inf_adic
  and  a.nr_seq_hist_saude  = nr_seq_hist_saude_w
  and  b.cd_pessoa_fisica  = cd_pessoa_fisica_p
  and  b.nm_usuario    = nm_usuario_p
  order by nr_seq_apresentacao desc;

c04 CURSOR FOR
  SELECT column_name
  FROM user_tab_cols
  WHERE table_name = 'EHR_LINKED_'||nr_seq_template_p||'_'||nr_seq_linked_data_p
  order by column_name asc;

c01_w  c01%rowtype;
c02_w  c02%rowtype;


BEGIN
cd_perfil_w  := obter_perfil_ativo;


if (cd_perfil_w  = 0) then
  cd_perfil_w  := null;
end if;

if (ie_liberar_p  = 'S') then
  dt_liberacao_w := clock_timestamp();
  nm_usuario_liberacao_w := nm_usuario_p;
end if;

begin
        open c01;
        loop
        fetch c01 into
                c01_w;
        EXIT WHEN NOT FOUND; /* apply on c01 */
                begin
                nr_seq_hist_saude_w  := c01_w.nr_sequencia;

        ds_sql_w:= 'select ehr_linked_'||nr_seq_template_p||'_'||nr_seq_linked_data_p||'_seq.nextval from dual';

        EXECUTE ds_sql_w INTO STRICT nr_sequencia_w;

            ds_coluns_w := 'NR_SEQ_TEMPLATE, NR_SEQ_LINKED_DATA, NR_SEQ_REG_TEMPLATE,';
            ds_values_w := chr(39)||nr_seq_template_p||chr(39)||','||chr(39)||nr_seq_linked_data_p||chr(39)||','||
                     chr(39)||nr_seq_reg_template_p||chr(39)||',';

            open c04;
            loop
            fetch c04 into column_name_cluster_w;
            EXIT WHEN NOT FOUND; /* apply on c04 */
            begin

              select max(rownum)
              into STRICT cont_w
              from user_tab_cols
              where table_name = nm_tabela_p
              and column_name = column_name_cluster_w;

              if (cont_w = 1) then
                ds_coluns_w := ds_coluns_w || column_name_cluster_w||',';
                
                if (column_name_cluster_w = 'NR_SEQUENCIA') then
                  ds_values_w := ds_values_w || nr_sequencia_w||',';
                elsif (column_name_cluster_w = 'CD_PESSOA_FISICA') then
                  ds_values_w := ds_values_w || chr(39)||cd_pessoa_fisica_p||chr(39)||',';
                elsif (column_name_cluster_w = 'CD_PROFISSIONAL') then
                  cd_profissional_w  := Obter_Pessoa_Fisica_Usuario(nm_usuario_p,'C');
                  ds_values_w := ds_values_w || chr(39)||cd_profissional_w||chr(39)||',';
                elsif (column_name_cluster_w = 'NM_USUARIO') then
                  ds_values_w := ds_values_w || chr(39)||nm_usuario_p||chr(39)||',';
                elsif (column_name_cluster_w = 'NR_SEQ_TIPO') then
                  if (nm_tabela_p = 'PACIENTE_HABITO_VICIO') then
                    ds_values_w := ds_values_w || chr(39)||c01_w.nr_seq_tipo_vicio|| chr(39)|| ',';
                  else
                    ds_values_w := ds_values_w || chr(39)||c01_w.nr_seq_tipo_alergia||chr(39)||',';
                  end if;
                elsif (column_name_cluster_w = 'CD_CLASSE_MAT') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.cd_classe_mat||chr(39)||',';
                elsif (column_name_cluster_w = 'NR_SEQ_REACAO') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.cd_material_alergia||chr(39)||',';
                elsif (column_name_cluster_w = 'IE_INTENSIDADE') then
                  ds_values_w := ds_values_w || 'NVL('||chr(39)||C01_W.ie_intensidade||chr(39)||','||chr(39)||'S'||chr(39)||'),';
                elsif (column_name_cluster_w = 'IE_CONFIRMACAO') then
                  ds_values_w := ds_values_w || 'nvl('||chr(39)||c01_w.ie_confirmacao||chr(39)||','||chr(39)||'C'||chr(39)||'),';
                elsif (column_name_cluster_w = 'NR_SEQ_DCB') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.nr_seq_dcb||chr(39)||',';
                elsif (column_name_cluster_w = 'NR_ATENDIMENTO') then
                  ds_values_w := ds_values_w || 'decode('||nr_atendimento_p||',0,null,'||nr_atendimento_p||'),';
                elsif (column_name_cluster_w = 'DT_REGISTRO') then
                  ds_values_w := ds_values_w || chr(39)||clock_timestamp()||chr(39)||',';
                elsif (column_name_cluster_w = 'DT_ATUALIZACAO_NREC') then
                  ds_values_w := ds_values_w || chr(39)||clock_timestamp()||chr(39)||',';
                elsif (column_name_cluster_w = 'DT_ATUALIZACAO') then
                  ds_values_w := ds_values_w || chr(39)||clock_timestamp()||chr(39)||',';
                elsif (column_name_cluster_w = 'NM_USUARIO_NREC') then
                  ds_values_w := ds_values_w || chr(39)||nm_usuario_p||chr(39)||',';
                elsif (column_name_cluster_w = 'DT_LIBERACAO') then
                  ds_values_w := ds_values_w || chr(39)||dt_liberacao_w||chr(39)||',';
                elsif (column_name_cluster_w = 'NM_USUARIO_LIBERACAO') then
                  ds_values_w := ds_values_w || chr(39)||nm_usuario_liberacao_w||chr(39)||',';
                elsif (column_name_cluster_w = 'NR_SEQ_NIVEL_SEG') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.nr_seq_nivel_seg||chr(39)||',';
                elsif (column_name_cluster_w = 'NR_SEQ_FICHA_TECNICA') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.nr_seq_ficha_tecnica||chr(39)||',';
                elsif (column_name_cluster_w = 'IE_NEGA_ALERGIAS') then
                  ds_values_w := ds_values_w || 'decode(trim('||chr(39)||c01_w.nr_seq_tipo_alergia||chr(39)||'),null,NVL('||chr(39)||C01_W.ie_nega||chr(39)||','||chr(39)||'N'||chr(39)||'),'||chr(39)||'N'||chr(39)||'),';
                elsif (column_name_cluster_w = 'NR_SEQ_REG_ELEMENTO') then
                  ds_values_w := ds_values_w || chr(39)||nr_seq_reg_elemento_p||chr(39)||',';
                elsif (column_name_cluster_w = 'CD_PERFIL_ATIVO') then
                  ds_values_w := ds_values_w || chr(39)||cd_perfil_w||chr(39)||',';
                elsif (column_name_cluster_w = 'DS_MEDIC_NAO_CAD') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.ds_medic_nao_cad||chr(39)||',';
                elsif (column_name_cluster_w = 'IE_ALERTA') then
                  if (nm_tabela_p = 'PACIENTE_EXAME') then
                    ds_values_w := ds_values_w || chr(39)||'N'||chr(39)||',';
                  elsif (nm_tabela_p = 'PF_TIPO_DEFICIENCIA') then
                    ds_values_w := ds_values_w || chr(39)||c01_w.IE_ALERTA||chr(39)||',';
                  else
                    ds_values_w := ds_values_w || 'nvl('||chr(39)||c01_w.ie_alerta||chr(39)||','||chr(39)||'S'||chr(39)||'),';
                  end if;
                elsif (column_name_cluster_w = 'NR_SEQ_FAMILIA') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.NR_SEQ_FAMILIA||chr(39)||',';
                elsif (column_name_cluster_w = 'NR_SEQ_TRIAGEM') then
                  nr_seq_triagem_w := nr_seq_triagem_p;
                  if (nr_seq_triagem_p = 0) then
                    nr_seq_triagem_w := nr_seq_triagem_p;
                  end if;
                  ds_values_w := ds_values_w || chr(39)||nr_seq_triagem_w||chr(39)||',';
                elsif (column_name_cluster_w = 'NR_SEQ_HIST_ROTINA') then
                  ds_values_w := ds_values_w || chr(39)||nr_seq_hist_saude_w||chr(39)||',';
                elsif (column_name_cluster_w = 'NR_SEQ_ATEND_CONS_PEPA') then
                  ds_values_w := ds_values_w || chr(39)||nr_seq_atend_cons_pepa_p||chr(39)||',';
                elsif (column_name_cluster_w = 'IE_SITUACAO') then
                  ds_values_w := ds_values_w || chr(39)||'A'||chr(39)||',';
                elsif (column_name_cluster_w = 'IE_FERTILIDADE') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.ie_fertilidade||chr(39)||',';
                elsif (column_name_cluster_w = 'QT_NASC_MORTOS') then
                  ds_values_w := ds_values_w ||'0,';
                elsif (column_name_cluster_w = 'IE_NEGA_INTERNACAO') then
                  ds_values_w := ds_values_w || chr(39)||'N'||chr(39)||',';
                elsif (column_name_cluster_w = 'DS_INTERCORRENCIA') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.ds_intercorrencia||chr(39)||',';
                elsif (column_name_cluster_w = 'DS_MOTIVO_INTERNACAO') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.ds_motivo_internacao||chr(39)||',';
                elsif (column_name_cluster_w = 'NR_SEQ_TIPO_TRATAMENTO') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.nr_seq_tratamento||chr(39)||',';
                elsif (column_name_cluster_w = 'IE_PFLEGEGRAD') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.IE_PFLEGEGRAD||chr(39)||',';
                elsif (column_name_cluster_w = 'IE_EXAME_PAC') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.ie_exame_pac||chr(39)||',';
                elsif (column_name_cluster_w = 'NR_SEQ_FORMA_REG') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.nr_seq_forma_reg||chr(39)||',';
                elsif (column_name_cluster_w = 'DT_EXAME') then
                  ds_values_w := ds_values_w || chr(39)||clock_timestamp()||chr(39)||',';
                elsif (column_name_cluster_w = 'IE_DOSE') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.ie_dose||chr(39)||',';
                elsif (column_name_cluster_w = 'DT_VACINA') then
                  ds_values_w := ds_values_w ||chr(39)||clock_timestamp()||chr(39)||',';
                elsif (column_name_cluster_w = 'NR_SEQ_VACINA') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.nr_seq_vacina||chr(39)||',';
                elsif (column_name_cluster_w = 'CD_SETOR_ATENDIMENTO') then
                  cd_setor_atend_w := Obter_Setor_Atendimento(nr_atendimento_p);
                  ds_values_w := ds_values_w || chr(39)||cd_setor_atend_w||chr(39)||',';
                elsif (column_name_cluster_w = 'IE_EXECUTADO') then
                  ds_values_w := ds_values_w || chr(39)||'N'||chr(39)||',';
                elsif (column_name_cluster_w = 'IE_LOCALIDADE_INF') then
                  ds_values_w := ds_values_w || chr(39)||'N'||chr(39)||',';
                elsif (column_name_cluster_w = 'IE_CONFIRMADO') then
                  ds_values_w := ds_values_w || chr(39)||'N'||chr(39)||',';
                elsif (column_name_cluster_w = 'NR_SEQ_AMPUTACAO') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.nr_seq_amputacao||chr(39)||',';
                elsif (column_name_cluster_w = 'NR_SEQ_TIPO_DEF') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.nr_seq_tipo_def||chr(39)||',';
                elsif (column_name_cluster_w = 'IE_NEGA_DEFICIENCIA') then
                  ds_values_w := ds_values_w || chr(39)||'N'||chr(39)||',';
                elsif (column_name_cluster_w = 'CD_ESTABELECIMENTO') then
                  ds_values_w := ds_values_w || chr(39)||wheb_usuario_pck.get_cd_estabelecimento||chr(39)||',';
                elsif (column_name_cluster_w = 'NR_SEQ_FATOR_RISCO') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.nr_seq_fator_risco||chr(39)||',';
                elsif (column_name_cluster_w = 'NM_USUARIO_LIB') then
                  ds_values_w := ds_values_w || chr(39)||nm_usuario_liberacao_w||chr(39)||',';
                elsif (column_name_cluster_w = 'NR_SEQ_ACESSORIO') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.nr_seq_acessorio||chr(39)||',';
                elsif (column_name_cluster_w = 'NR_SEQ_CARACTERISTICA') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.nr_seq_caracteristica||chr(39)||',';
                elsif (column_name_cluster_w = 'NR_SEQ_LOCALIZACAO') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.nr_seq_localizacao||chr(39)||',';
                elsif (column_name_cluster_w = 'DS_OBSERVACAO') then
                  if (nm_tabela_p = 'PACIENTE_REP_PRESCRICAO') then
                    ds_values_w := ds_values_w || chr(39)||'N'||chr(39)||',';
                  else
                    ds_values_w := ds_values_w || 'null,';
                  end if;
                elsif (column_name_cluster_w = 'CD_PROCEDIMENTO') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.cd_procedimento||chr(39)||',';
                elsif (column_name_cluster_w = 'IE_ORIGEM_PROCED') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.ie_origem_proced||chr(39)||',';
                elsif (column_name_cluster_w = 'DS_PROCEDIMENTO_INF') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.ds_procedimento_inf||chr(39)||',';
                elsif (column_name_cluster_w = 'IE_CLASSIFICACAO') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.ie_classificacao||chr(39)||',';
                elsif (column_name_cluster_w = 'IE_NEGA_CIRURGIAS') then
                  ds_values_w := ds_values_w || 'NVL('||chr(39)||C01_W.ie_nega||chr(39)||','||chr(39)||'N'||chr(39)||'),';
                elsif (column_name_cluster_w = 'CD_MATERIAL') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.cd_material_medic||chr(39)||',';
                elsif (column_name_cluster_w = 'DS_MEDICAMENTO') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.ds_medicamento||chr(39)||',';
                elsif (column_name_cluster_w = 'IE_NEGA_HABITO') then
                  ds_values_w := ds_values_w || 'NVL('||chr(39)||C01_W.ie_nega||chr(39)||','||chr(39)||'N'||chr(39)||'),';
                elsif (column_name_cluster_w = 'NR_SEQ_PARENTESCO') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.nr_seq_parentesco||chr(39)||',';
                elsif (column_name_cluster_w = 'NR_SEQ_DOENCA') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.nr_seq_doenca||chr(39)||',';
                elsif (column_name_cluster_w = 'DS_DOENCA') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.ds_doenca||chr(39)||',';
                elsif (column_name_cluster_w = 'IE_STATUS') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.ie_status||chr(39)||',';
                elsif (column_name_cluster_w = 'IE_NEGA_DOENCAS') then
                  if (coalesce(c01_w.ds_doenca::text, '') = '') and (coalesce(c01_w.nr_seq_doenca::text, '') = '') and (coalesce(c01_w.cd_doenca::text, '') = '') then
                    ie_nega_w := coalesce(C01_W.ie_nega,'N');
                  else
                    ie_nega_w := 'N';
                  end if;
                  ds_values_w := ds_values_w || chr(39)||ie_nega_w||chr(39)||',';
                elsif (column_name_cluster_w = 'IE_PACIENTE') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.ie_paciente||chr(39)||',';
                elsif (column_name_cluster_w = 'CD_DOENCA') then
                  ds_values_w := ds_values_w || chr(39)||c01_w.cd_doenca||chr(39)||',';
                elsif (column_name_cluster_w = 'IE_NEGA_MEDICAMENTOS') then
                  ds_values_w := ds_values_w || 'NVL('||chr(39)||C01_W.ie_nega||chr(39)||','||chr(39)||'N'||chr(39)||'),';
                else
                  ds_values_w := ds_values_w || 'null,';
                end if;
              end if;
            end;
            end loop;
            close c04;

            ds_coluns_w := substr(ds_coluns_w,1,length(ds_coluns_w)-1);
            ds_values_w := substr(ds_values_w,1,length(ds_values_w)-1);

            ds_sql_w := 'insert into ehr_linked_'||nr_seq_template_p||'_'||nr_seq_linked_data_p||' (' || ds_coluns_w || ') values (' || ds_values_w || ')';

                open c02;
                loop
                fetch c02 into
                        c02_w;
                EXIT WHEN NOT FOUND; /* apply on c02 */
                        begin
                        ds_comando_w  := ' update '||c02_w.nm_tabela||' ';
                        if (c02_w.ie_tipo_campo  = 'D') then
                                ds_comando_w  := ds_comando_w|| ' set '||c02_w.nm_atributo ||' = :dt_parametro ';
                        else
                                ds_comando_w  := ds_comando_w|| ' set '||c02_w.nm_atributo ||' = :cd_parametro ';
                        end if;
                        ds_comando_w  := ds_comando_w|| ' where nr_sequencia = :nr_sequencia ';

                        if (c02_w.ie_tipo_campo  = 'N') then
                                vl_campo_w  := c02_w.nr_inf_adic;
                        elsif (c02_w.ie_tipo_campo  = 'D') then
                                vl_campo_w  := to_char(c02_w.dt_inf_adic,'dd/mm/yyyy hh24:mi:ss');
                        elsif (c02_w.ie_tipo_campo  = 'A') then
                                vl_campo_w  := c02_w.ds_inf_adic;
                        end if;

                        if (c02_w.ie_tipo_campo  = 'D') then
                                ds_parametro_w  := 'nr_sequencia='||nr_sequencia_w||'#@#@'||'dt_parametro='||vl_campo_w||'#@#@';
                        else
                                ds_parametro_w  := 'nr_sequencia='||nr_sequencia_w||'#@#@'||'cd_parametro='||vl_campo_w||'#@#@';
                        end if;

                        if (vl_campo_w IS NOT NULL AND vl_campo_w::text <> '') then
                                CALL exec_sql_dinamico_bv('TASY', ds_comando_w,ds_parametro_w);
                        end if;
                        end;
                end loop;
                close c02;

                end;
        end loop;
        close c01;

    ds_sql_w := replace(ds_sql_w,chr(39)||chr(39),'null');
    EXECUTE ds_sql_w;

  if (nm_tabela_p  = 'PACIENTE_ANTEC_CLINICO') and (dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '')  and (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') then

    select  coalesce(max(ie_paciente),'S'),
        max(cd_doenca)
    into STRICT  ie_paciente_w,
        cd_doenca_w
    from  PACIENTE_ANTEC_CLINICO
    where  nr_sequencia = nr_sequencia_w;

    if (cd_doenca_w IS NOT NULL AND cd_doenca_w::text <> '') and (ie_paciente_w  = 'S') then

      CALL GERAR_PACIENTE_GRUPO(cd_doenca_w,cd_pessoa_fisica_p,nm_usuario_p);

    end if;
  end if;

exception
        when others then
        ds_erro_p       := substr(sqlerrm(SQLSTATE),1,255);
end;

nr_seq_registro_p := nr_sequencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_hist_saude_cluster ( nr_seq_template_p text, nr_seq_reg_template_p text, nr_seq_linked_data_p text, nm_tabela_p text, nr_sequencia_p bigint, cd_pessoa_fisica_p text, ie_liberar_p text, nr_atendimento_p bigint, nr_seq_reg_elemento_p bigint, nm_usuario_p text, nr_seq_registro_p INOUT bigint, ds_erro_p INOUT text, nr_seq_triagem_p bigint default 0, nr_seq_atend_cons_pepa_p bigint default null) FROM PUBLIC;

