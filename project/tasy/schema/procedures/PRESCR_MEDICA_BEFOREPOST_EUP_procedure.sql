-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE prescr_medica_beforepost_eup ( nm_usuario_p text, cd_estab_atend_p bigint, cd_convenio_p bigint, ie_tipo_atendimento_p bigint, ie_carater_inter_sus_p text, ie_clinica_p bigint, nr_seq_classificacao_p bigint, cd_categoria_p text, cd_plano_convenio_p text, cd_estabelecimento_p bigint, nr_atendimento_p bigint, cd_setor_atendimento_p bigint, cd_perfil_p bigint, ie_momento_p text, ie_prescricao_alta_p text, dt_prescricao_p timestamp, cd_pessoa_fisica_p text, ie_novo_registro_p bigint, nr_prescricao_p bigint default null, qt_peso_p bigint default null, nr_seq_forma_laudo_p bigint DEFAULT NULL, cd_medico_p text DEFAULT NULL, cd_setor_entrega_p text DEFAULT NULL, cd_acao_executada_p bigint DEFAULT NULL, dt_mestruacao_p timestamp DEFAULT NULL, nr_controle_p bigint DEFAULT NULL, cd_plano_p bigint DEFAULT NULL, cd_empresa_p bigint DEFAULT NULL, cd_procedencia_p bigint DEFAULT NULL, nr_seq_tipo_acidente_p text DEFAULT NULL, cd_tipo_acomodacao_p bigint DEFAULT NULL, nr_seq_queixa_p text DEFAULT NULL, nr_seq_cobertura_p bigint DEFAULT NULL, dt_vigencia_p timestamp DEFAULT NULL, nr_doc_convenio_p text DEFAULT NULL, cd_senha_p text DEFAULT NULL, nr_doc_conv_p text DEFAULT NULL, cd_senha_old_p text DEFAULT NULL, nr_doc_conv_old_p text DEFAULT NULL, ie_modo_edicao bigint DEFAULT NULL, cd_senha_prescr_p text DEFAULT NULL, ie_gerar_passagem_alta_p INOUT text DEFAULT NULL, ds_msg_83688_p INOUT text DEFAULT NULL, ie_guia_p INOUT text DEFAULT NULL, ie_senha_p INOUT text DEFAULT NULL, ds_msg_83725_p INOUT text DEFAULT NULL, ds_msg_83965_p INOUT text DEFAULT NULL, ds_msg_83728_p INOUT text DEFAULT NULL, ds_msg_84158_p INOUT text DEFAULT NULL, ds_msg_308208_p INOUT text DEFAULT NULL, ds_msg_308356_p INOUT text DEFAULT NULL, ds_msg_96573_p INOUT text DEFAULT NULL, ds_mensagem_p INOUT text DEFAULT NULL, ds_mensagem_adic_p INOUT text DEFAULT NULL, ie_acao_p INOUT text DEFAULT NULL, ie_anamnese_p INOUT text DEFAULT NULL, ie_evolucao_p INOUT text DEFAULT NULL, ie_receita_p INOUT text DEFAULT NULL, ie_diagnostico_p INOUT text DEFAULT NULL, ie_escala_indice_p INOUT text DEFAULT NULL, ie_recomendacao_p INOUT text DEFAULT NULL, cd_protocolo_p INOUT bigint DEFAULT NULL, ie_parecer_p INOUT text DEFAULT NULL, ie_peso_p INOUT text DEFAULT NULL, ie_autorizacao_p INOUT text DEFAULT NULL, ie_laudo_sus_p INOUT text DEFAULT NULL, ie_avaliacao_p INOUT text DEFAULT NULL, ie_item_prontuario_p INOUT text DEFAULT NULL, ds_msg_307154_p INOUT text DEFAULT NULL, qt_pessoa_fisica_p INOUT bigint DEFAULT NULL, ie_permite_prescricao_p INOUT text DEFAULT NULL, ds_sexo_p INOUT text DEFAULT NULL, ie_bloqueia_atendimento_p INOUT text DEFAULT NULL, ds_msg_p INOUT text DEFAULT NULL, ds_erro_p INOUT text DEFAULT NULL, ie_tipo_complemento_p INOUT text DEFAULT NULL) AS $body$
DECLARE

				  
				  
ds_pergunta_w			varchar(255);		
informa_medico_solicitante_w	varchar(1);
consisti_setor_entrega_w	varchar(1);
ie_data_menstruacao_w		varchar(1);
ie_consisti_cod_integra_w	varchar(255);
ie_atend_convenio_w		varchar(1);
ie_tipo_conv_anterior_w		varchar(15);
nr_seq_queixa_anterior_w	varchar(15);
qt_idade_w			bigint;
ie_utiliza_guia_senha_w		varchar(1);
ie_posicionar_pep_w		varchar(1);


BEGIN 
informa_medico_solicitante_w := obter_param_usuario(916, 539, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, informa_medico_solicitante_w);
consisti_setor_entrega_w := obter_param_usuario(916, 553, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, consisti_setor_entrega_w);
ie_data_menstruacao_w := obter_param_usuario(916, 632, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_data_menstruacao_w);
ie_consisti_cod_integra_w := obter_param_usuario(916, 707, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_consisti_cod_integra_w);
ie_atend_convenio_w := obter_param_usuario(916, 788, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_atend_convenio_w);
ie_utiliza_guia_senha_w := obter_param_usuario(916, 835, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_utiliza_guia_senha_w);
 
 
 
 
select coalesce(max(ie_gerar_passagem_alta),'S') 
into STRICT	ie_gerar_passagem_alta_p 
from  parametro_atendimento 
where  cd_estabelecimento  = cd_estab_atend_p;
 
ds_msg_83688_p	:= obter_texto_tasy(83688, 1);
ds_msg_83725_p	:= obter_texto_tasy(83725, 1);
ds_msg_83965_p	:= obter_texto_tasy(83965, 1);
ds_msg_83728_p	:= obter_texto_tasy(83728, 1);
ds_msg_84158_p	:= obter_texto_tasy(84158, 1);
ds_msg_96573_p	:= obter_texto_tasy(96573, 1);
ie_guia_p	:= obter_se_exige_guia_senha(cd_convenio_p, ie_tipo_atendimento_p, 1, 'G', cd_estabelecimento_p, ie_carater_inter_sus_p, ie_clinica_p, null, null, nr_seq_classificacao_p, null, cd_categoria_p, cd_plano_convenio_p, null);
ie_senha_p	:= obter_se_exige_guia_senha(cd_convenio_p, ie_tipo_atendimento_p, 1, 'S', cd_estabelecimento_p, ie_carater_inter_sus_p, ie_clinica_p, null, null, nr_seq_classificacao_p, null, cd_categoria_p, cd_plano_convenio_p, null);
 
 
if (ie_novo_registro_p = 1 )then 
	SELECT * FROM consiste_regra_inf_rep(cd_estabelecimento_p, nr_atendimento_p, cd_setor_atendimento_p, cd_perfil_p, ie_momento_p, ie_prescricao_alta_p, dt_prescricao_p, nm_usuario_p, ds_mensagem_p, ds_mensagem_adic_p, ie_acao_p, ie_anamnese_p, ie_evolucao_p, ie_receita_p, ie_diagnostico_p, ie_escala_indice_p, nr_prescricao_p, cd_pessoa_fisica_p, qt_peso_p, ie_recomendacao_p, cd_protocolo_p, ie_parecer_p, ie_peso_p, ie_autorizacao_p, ie_laudo_sus_p, ie_avaliacao_p, ie_item_prontuario_p, ie_posicionar_pep_w) INTO STRICT ds_mensagem_p, ds_mensagem_adic_p, ie_acao_p, ie_anamnese_p, ie_evolucao_p, ie_receita_p, ie_diagnostico_p, ie_escala_indice_p, ie_recomendacao_p, cd_protocolo_p, ie_parecer_p, ie_peso_p, ie_autorizacao_p, ie_laudo_sus_p, ie_avaliacao_p, ie_item_prontuario_p, ie_posicionar_pep_w;
end if;
 
if (nr_seq_forma_laudo_p IS NOT NULL AND nr_seq_forma_laudo_p::text <> '')then 
	 
	select 	max(ie_tipo_complemento) 
	into STRICT	ie_tipo_complemento_p	 
	from 	forma_entrega_laudo 
	where 	nr_sequencia = nr_seq_forma_laudo_p;
		 
	if (ie_tipo_complemento_p <> 0)then 
		select 	count(*) qt_pessoa_fisica, 
			obter_valor_dominio(8,ie_tipo_complemento_p) ds_pergunta 
		into STRICT 	qt_pessoa_fisica_p, 
			ds_pergunta_w 
		from 	compl_pessoa_fisica 
		where 	cd_pessoa_fisica = cd_pessoa_fisica_p 
		and 	ie_tipo_complemento = ie_tipo_complemento_p;
		 
		ds_msg_307154_p:= substr(obter_texto_dic_objeto(307154, wheb_usuario_pck.get_nr_seq_idioma, 'ITEM='||ds_pergunta_w),1,255);
	end if;
end if;
 
if (informa_medico_solicitante_w = 'S')then 
	CALL atualiza_req_agenda(nr_prescricao_p,nm_usuario_p,cd_medico_p);
end if;	
 
if (consisti_setor_entrega_w = 'S' 
	and (cd_setor_entrega_p IS NOT NULL AND cd_setor_entrega_p::text <> ''))then 
	select coalesce(ie_permite_prescricao,'S') 
	into STRICT	ie_permite_prescricao_p	 
	from 	setor_atendimento 
	where 	cd_setor_atendimento = cd_setor_entrega_p;
	if (ie_permite_prescricao_p = 'N') then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(84151);
		goto fim;
	end if;
end if;	
 
if (cd_acao_executada_p <> 3 
  and ie_data_menstruacao_w = 'S') then 
	select 	obter_sexo_pf(cd_pessoa_fisica_p,'C') 
	into STRICT	ds_sexo_p 
	;
end if;
 
if (ie_consisti_cod_integra_w IS NOT NULL AND ie_consisti_cod_integra_w::text <> '')then 
	ds_msg_308208_p := verifica_numero_controle(nr_atendimento_p, nr_controle_p, ie_consisti_cod_integra_w, ds_msg_308208_p);
end if;		
 
ds_msg_308356_p := consiste_autor_medico_ipe(cd_medico_p, nr_atendimento_p, ds_msg_308356_p);
 
if (ie_atend_convenio_w = 'S' or 
	ie_atend_convenio_w = 'T')then 
	 
	select (select	a.ie_tipo_convenio 
		 from	atendimento_paciente a 
		 where	a.nr_atendimento = (select max(b.nr_atendimento) 
					  		  from  atendimento_paciente b 
					  			  where nr_atendimento < nr_atendimento_p)) ie_tipo_conv_anterior, 
		(select	a.nr_seq_queixa 
		 from	atendimento_paciente a 
		 where	a.nr_atendimento = (select max(b.nr_atendimento) 
									 from    atendimento_paciente b 
									 where	nr_atendimento < nr_atendimento_p)) nr_seq_queixa_anterior, 
		substr(obter_idade_pf(cd_pessoa_fisica_p, clock_timestamp(), 'A'), 1, 3) qt_idade 
	into STRICT ie_tipo_conv_anterior_w, 
	nr_seq_queixa_anterior_w, 
	qt_idade_w			 
	;	
 
	SELECT * FROM obter_se_lib_setor_conv(cd_estabelecimento_p, cd_convenio_p, cd_categoria_p, ie_tipo_atendimento_p, cd_setor_atendimento_p, cd_plano_p, nr_seq_classificacao_p, ds_msg_p, ie_bloqueia_atendimento_p, ie_clinica_p, cd_empresa_p, cd_procedencia_p, nr_seq_cobertura_p, nr_seq_tipo_acidente_p, cd_tipo_acomodacao_p, cd_medico_p, qt_idade_w, ie_tipo_conv_anterior_w, nr_seq_queixa_p, nr_seq_queixa_anterior_w, dt_vigencia_p, cd_pessoa_fisica_p) INTO STRICT ds_msg_p, ie_bloqueia_atendimento_p;
		 
	if (ie_bloqueia_atendimento_p = 'A')then 
		if (coalesce(ds_msg_p::text, '') = '')then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(96610);
			goto fim;
		else		 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(278178,'DS_ERRO='||ds_msg_p);
			goto fim;
		end if;
	end if;
	 
	if (ie_bloqueia_atendimento_p ='T' and (coalesce(nr_doc_convenio_p::text, '') = '' or 
		coalesce(cd_senha_p::text, '') = ''))then 
		if (coalesce(ds_msg_p::text, '') = '')then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(96573);
			goto fim;
		else		 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(278178,'DS_ERRO='||ds_msg_p);
			goto fim;
		end if;
	end if;
	 
	if (ie_bloqueia_atendimento_p = 'G' and 
		coalesce(nr_doc_convenio_p::text, '') = '')then 
		if (coalesce(ds_msg_p::text, '') = '')then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(96573);
			goto fim;
		else		 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(278178,'DS_ERRO='||ds_msg_p);
			goto fim;
		end if;
	end if;
	 
	if (ie_bloqueia_atendimento_p = 'S' and 
		coalesce(cd_senha_p::text, '') = '')then 
		if (coalesce(ds_msg_p::text, '') = '')then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(96573);
			goto fim;
		else		 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(278178,'DS_ERRO='||ds_msg_p);
			goto fim;
		end if;
	end if;
	 
end if;
 
if (ie_utiliza_guia_senha_w = 'S') 
	and (cd_senha_prescr_p <> cd_senha_old_p) 
	and (nr_doc_conv_p <> nr_doc_conv_old_p) 
	and (ie_modo_edicao = 1)then 
 
	CALL atualizar_guia_senha(nr_prescricao_p,cd_senha_p,nr_doc_conv_p);
end if;
 
	<<fim>> 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE prescr_medica_beforepost_eup ( nm_usuario_p text, cd_estab_atend_p bigint, cd_convenio_p bigint, ie_tipo_atendimento_p bigint, ie_carater_inter_sus_p text, ie_clinica_p bigint, nr_seq_classificacao_p bigint, cd_categoria_p text, cd_plano_convenio_p text, cd_estabelecimento_p bigint, nr_atendimento_p bigint, cd_setor_atendimento_p bigint, cd_perfil_p bigint, ie_momento_p text, ie_prescricao_alta_p text, dt_prescricao_p timestamp, cd_pessoa_fisica_p text, ie_novo_registro_p bigint, nr_prescricao_p bigint default null, qt_peso_p bigint default null, nr_seq_forma_laudo_p bigint DEFAULT NULL, cd_medico_p text DEFAULT NULL, cd_setor_entrega_p text DEFAULT NULL, cd_acao_executada_p bigint DEFAULT NULL, dt_mestruacao_p timestamp DEFAULT NULL, nr_controle_p bigint DEFAULT NULL, cd_plano_p bigint DEFAULT NULL, cd_empresa_p bigint DEFAULT NULL, cd_procedencia_p bigint DEFAULT NULL, nr_seq_tipo_acidente_p text DEFAULT NULL, cd_tipo_acomodacao_p bigint DEFAULT NULL, nr_seq_queixa_p text DEFAULT NULL, nr_seq_cobertura_p bigint DEFAULT NULL, dt_vigencia_p timestamp DEFAULT NULL, nr_doc_convenio_p text DEFAULT NULL, cd_senha_p text DEFAULT NULL, nr_doc_conv_p text DEFAULT NULL, cd_senha_old_p text DEFAULT NULL, nr_doc_conv_old_p text DEFAULT NULL, ie_modo_edicao bigint DEFAULT NULL, cd_senha_prescr_p text DEFAULT NULL, ie_gerar_passagem_alta_p INOUT text DEFAULT NULL, ds_msg_83688_p INOUT text DEFAULT NULL, ie_guia_p INOUT text DEFAULT NULL, ie_senha_p INOUT text DEFAULT NULL, ds_msg_83725_p INOUT text DEFAULT NULL, ds_msg_83965_p INOUT text DEFAULT NULL, ds_msg_83728_p INOUT text DEFAULT NULL, ds_msg_84158_p INOUT text DEFAULT NULL, ds_msg_308208_p INOUT text DEFAULT NULL, ds_msg_308356_p INOUT text DEFAULT NULL, ds_msg_96573_p INOUT text DEFAULT NULL, ds_mensagem_p INOUT text DEFAULT NULL, ds_mensagem_adic_p INOUT text DEFAULT NULL, ie_acao_p INOUT text DEFAULT NULL, ie_anamnese_p INOUT text DEFAULT NULL, ie_evolucao_p INOUT text DEFAULT NULL, ie_receita_p INOUT text DEFAULT NULL, ie_diagnostico_p INOUT text DEFAULT NULL, ie_escala_indice_p INOUT text DEFAULT NULL, ie_recomendacao_p INOUT text DEFAULT NULL, cd_protocolo_p INOUT bigint DEFAULT NULL, ie_parecer_p INOUT text DEFAULT NULL, ie_peso_p INOUT text DEFAULT NULL, ie_autorizacao_p INOUT text DEFAULT NULL, ie_laudo_sus_p INOUT text DEFAULT NULL, ie_avaliacao_p INOUT text DEFAULT NULL, ie_item_prontuario_p INOUT text DEFAULT NULL, ds_msg_307154_p INOUT text DEFAULT NULL, qt_pessoa_fisica_p INOUT bigint DEFAULT NULL, ie_permite_prescricao_p INOUT text DEFAULT NULL, ds_sexo_p INOUT text DEFAULT NULL, ie_bloqueia_atendimento_p INOUT text DEFAULT NULL, ds_msg_p INOUT text DEFAULT NULL, ds_erro_p INOUT text DEFAULT NULL, ie_tipo_complemento_p INOUT text DEFAULT NULL) FROM PUBLIC;

