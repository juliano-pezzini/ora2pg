-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cobr_escrit_pend ( nr_seq_cobranca_p bigint, nr_seq_conta_banco_p bigint, cd_banco_p bigint, nr_seq_carteira_cobr_p bigint, ie_emissao_bloqueto_p text, nr_seq_tipo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_novo_lote_p INOUT bigint) AS $body$
DECLARE

 
nr_seq_cobr_escrit_w		bigint;
nr_titulo_w			bigint;
		

BEGIN 
 
if (nr_seq_cobranca_p IS NOT NULL AND nr_seq_cobranca_p::text <> '') then 
 
	if (coalesce(nr_seq_novo_lote_p::text, '') = '') then 
		select	nextval('cobranca_escritural_seq') 
		into STRICT	nr_seq_cobr_escrit_w 
		;
		 
		nr_seq_novo_lote_p	:= nr_seq_cobr_escrit_w;
 
		insert into	cobranca_escritural(nr_sequencia, 
				cd_estabelecimento, 
				nm_usuario, 
				dt_atualizacao, 
				nm_usuario_nrec, 
				dt_atualizacao_nrec, 
				dt_remessa_retorno, 
				nr_seq_conta_banco, 
				cd_banco, 
				nr_seq_carteira_cobr, 
				ie_emissao_bloqueto, 
				nr_seq_tipo, 
				ie_remessa_retorno) 
		values (nr_seq_cobr_escrit_w, 
				cd_estabelecimento_p, 
				nm_usuario_p, 
				clock_timestamp(), 
				nm_usuario_p, 
				clock_timestamp(), 
				clock_timestamp(), 
				nr_seq_conta_banco_p, 
				cd_banco_p, 
				nr_seq_carteira_cobr_p, 
				ie_emissao_bloqueto_p, 
				nr_seq_tipo_p, 
				'R');
	end if;
 
	insert into titulo_receber_cobr(nr_sequencia, 
		nm_usuario, 
		nm_usuario_nrec, 
		dt_atualizacao, 
		dt_atualizacao_nrec, 
		nr_seq_cobranca, 
		cd_agencia_bancaria, 
		cd_banco, 
		cd_camara_compensacao, 
		cd_centro_custo_desc, 
		cd_instrucao, 
		cd_moeda, 
		cd_ocorrencia, 
		dt_liquidacao, 
		ie_digito_conta, 
		nr_conta, 
		nr_seq_mensalidade, 
		nr_seq_motivo_desc, 
		nr_seq_ocorrencia_ret, 
		nr_seq_ocorr_motivo, 
		nr_titulo, 
		qt_dias_instrucao, 
		vl_acrescimo, 
		vl_cobranca, 
		vl_desconto, 
		vl_desc_previsto, 
		vl_despesa_bancaria, 
		vl_juros, 
		vl_liquidacao, 
		vl_multa, 
		vl_saldo_inclusao) 
	SELECT	nextval('titulo_receber_cobr_seq'), 
		nm_usuario_p, 
		nm_usuario_p, 
		clock_timestamp(), 
		clock_timestamp(), 
		nr_seq_novo_lote_p, 
		cd_agencia_bancaria, 
		cd_banco, 
		cd_camara_compensacao, 
		cd_centro_custo_desc, 
		cd_instrucao, 
		cd_moeda, 
		cd_ocorrencia, 
		dt_liquidacao, 
		ie_digito_conta, 
		nr_conta, 
		nr_seq_mensalidade, 
		nr_seq_motivo_desc, 
		nr_seq_ocorrencia_ret, 
		nr_seq_ocorr_motivo, 
		nr_titulo, 
		qt_dias_instrucao, 
		vl_acrescimo, 
		vl_cobranca, 
		vl_desconto, 
		vl_desc_previsto, 
		vl_despesa_bancaria, 
		vl_juros, 
		vl_liquidacao, 
		vl_multa, 
		vl_saldo_inclusao 
	from	titulo_receber_cobr a 
	where	a.nr_sequencia	= nr_seq_cobranca_p;
	 
	select	nr_titulo 
	into STRICT	nr_titulo_w 
	from	titulo_receber_cobr 
	where	nr_sequencia	= nr_seq_cobranca_p;
	 
	update	titulo_receber 
	set	ie_tipo_titulo = '1', 
		nr_seq_conta_banco	= nr_seq_conta_banco_p, 
		nr_seq_carteira_cobr	= nr_seq_carteira_cobr_p 
	where	nr_titulo		= nr_titulo_w;
	 
	CALL Gerar_Bloqueto_Tit_Rec(nr_titulo_w, 'CE');
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cobr_escrit_pend ( nr_seq_cobranca_p bigint, nr_seq_conta_banco_p bigint, cd_banco_p bigint, nr_seq_carteira_cobr_p bigint, ie_emissao_bloqueto_p text, nr_seq_tipo_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_novo_lote_p INOUT bigint) FROM PUBLIC;

