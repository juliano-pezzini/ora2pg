-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE agendamento_externo_atendido (nr_seq_lista_espera_p bigint, cnpj_externo_p text, dt_agendamento_p timestamp, nm_usuario_p text) AS $body$
DECLARE




nr_seq_regulacao_atend_w	regulacao_atend.nr_sequencia%type;
cd_expressao_w bigint;



BEGIN



if (nr_seq_lista_espera_p IS NOT NULL AND nr_seq_lista_espera_p::text <> '') then



  update agenda_lista_espera

  set cnpj_local_agenda_externo  = cnpj_externo_p,

    ds_local_agenda_externo    = obter_nome_pj(cnpj_externo_p),

    dt_agenda_externo      = dt_agendamento_p,

    ie_status_espera      = 'E'

  where nr_sequencia        = nr_seq_lista_espera_p;



  commit;



  select max(nr_seq_regulacao)

  into STRICT nr_seq_regulacao_atend_w

  from agenda_lista_espera a

  where nr_sequencia = nr_seq_lista_espera_p;

  if (nr_seq_regulacao_atend_w IS NOT NULL AND nr_seq_regulacao_atend_w::text <> '') then
    CALL envia_lista_espera_integracao(nr_seq_lista_espera_p, 'S');
    CALL alterar_status_regulacao(nr_seq_regulacao_atend_w,'AG', obter_expressao_dic_objeto(1099807),obter_pessoa_fisica_usuario(nm_usuario_p, null));

  end if;


 cd_expressao_w := 1104023;

  insert into ag_lista_espera_contato(

            nr_sequencia,

            dt_atualizacao,

            dt_atualizacao_nrec,

            nm_usuario,

            nm_usuario_nrec,

          	nr_seq_lista_espera,

						dt_contato,

						ie_origem,

						nm_pessoa_contato,

						nr_seq_situacao_atual,

						ds_observacao,

						dt_liberacao,

						nm_usuario_liberacao,

						ie_contato_realizado

					) values (

						nextval('ag_lista_espera_contato_seq'),

						clock_timestamp(),

						clock_timestamp(),

						nm_usuario_p,

						nm_usuario_p,

						nr_seq_lista_espera_p,

						clock_timestamp(),

						'M',

						obter_pessoa_fisica_usuario(nm_usuario_p, null),

						'',

						obter_expressao_dic_objeto(cd_expressao_w),

						clock_timestamp(),
            
						nm_usuario_p,

						'N'

					);

          commit;

end if;



end;



$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE agendamento_externo_atendido (nr_seq_lista_espera_p bigint, cnpj_externo_p text, dt_agendamento_p timestamp, nm_usuario_p text) FROM PUBLIC;

