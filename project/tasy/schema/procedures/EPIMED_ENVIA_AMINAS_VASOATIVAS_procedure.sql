-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE epimed_envia_aminas_vasoativas ( nr_prescricao_p bigint, nr_seq_solucao_p bigint, nr_etapa_p bigint, nr_atendimento_p bigint, nr_seq_horario_p bigint, nm_usuario_p text, ie_acao_p text default 'A') AS $body$
DECLARE


visit_id_w 					paciente_antec_clinico.nr_atendimento%type;
patient_id_w 				paciente_antec_clinico.cd_pessoa_fisica%type;
ds_integracao_w				text;
nm_usuario_w				paciente_antec_clinico.nm_usuario%type;
qt_dose_w					prescr_mat_hor.qt_dose%type;
cd_unidade_medida_dose_w	prescr_mat_hor.cd_unidade_medida_dose%type;
cd_material_w				material.cd_material%type;
ds_material_w				varchar(255);
qt_tempo_aplicacao_w		prescr_solucao.qt_tempo_aplicacao%type;
vol_etapa_w					prescr_solucao.qt_volume%type;
vel_infucao_w				bigint;
cd_um_velocidade_w			varchar(15);
complicationdate_w			varchar(30);
complication_id_w			prescr_mat_hor.nr_sequencia%type;
complication_code_w			varchar(255);
complication_value_w		varchar(1);
updatetimestamp_w			varchar(30);
ie_integracao_tasy_w		varchar(1);


BEGIN

select 	obter_param_usuario_logado(9041,10)
into STRICT 	ie_integracao_tasy_w
;

if (ie_integracao_tasy_w = 'S') then

	begin
		select 	qt_dose,
				cd_unidade_medida_dose,
				cd_material,
				ds_material,
				qt_tempo_aplicacao,
				vol_etapa,
				vel_infucao,
				cd_um_velocidade,
				visit_id,
				complicationdate,
				complication_id,
				complication_code,
				complication_value,
				updatetimestamp,
				patient_id
		into STRICT	qt_dose_w,
				cd_unidade_medida_dose_w,
				cd_material_w,
				ds_material_w,
				qt_tempo_aplicacao_w,
				vol_etapa_w,
				vel_infucao_w,
				cd_um_velocidade_w,
				visit_id_w,
				complicationdate_w,
				complication_id_w,
				complication_code_w,
				complication_value_w,
				updatetimestamp_w,
				patient_id_w
		from (
		SELECT 	c.qt_dose,
				c.cd_unidade_medida_dose,
				c.cd_material,
				substr(obter_desc_material(c.cd_material),1,255) ds_material,
				x.QT_TEMPO_APLICACAO,
				x.qt_volume vol_etapa,
				x.QT_DOSAGEM vel_infucao,
				x.ie_tipo_dosagem cd_um_velocidade,
				a.nr_atendimento VISIT_ID,
				to_char(c.dt_inicio_horario, 'yyyymmddhh24miss')COMPLICATIONDATE,
				c.nr_sequencia COMPLICATION_ID,
				wheb_mensagem_pck.get_texto(1125485) COMPLICATION_CODE,
				'S' COMPLICATION_VALUE,
				to_char(c.dt_atualizacao, 'yyyymmddhh24miss') UPDATETIMESTAMP,
				coalesce(a.cd_pessoa_fisica, obter_pessoa_atendimento(a.nr_atendimento,'C')) patient_id
		from	prescr_solucao x,
				prescr_mat_hor c,
				prescr_medica a
		where	x.nr_prescricao = c.nr_prescricao
		and		x.nr_seq_solucao = c.nr_seq_solucao
		and		x.nr_prescricao = a.nr_prescricao
		and		c.nr_prescricao = a.nr_prescricao
		and		(c.dt_inicio_horario IS NOT NULL AND c.dt_inicio_horario::text <> '')
		and		a.nr_prescricao = nr_prescricao_p
		and		x.nr_seq_solucao = nr_seq_solucao_p
		and		c.nr_etapa_sol = nr_etapa_p
		and		c.ie_agrupador = 4
		and		Obter_estrutura_material(c.cd_material,'S') = 13
		and		(nr_seq_solucao_p IS NOT NULL AND nr_seq_solucao_p::text <> '')
		and		exists (	SELECT	1
							from	atend_paciente_unidade z
							where	nr_seq_interno = Obter_Atepacu_paciente(nr_atendimento_p, 'A')
							and		obter_dif_data(z.dt_entrada_unidade, c.dt_inicio_horario, 'TS') > 3600 -- Administrado apos 1h
							and		obter_classif_setor(z.cd_setor_atendimento) = 4)		--Setor de UTI
		
union

		select 	c.qt_dose,
				c.cd_unidade_medida_dose,
				c.cd_material,
				substr(obter_desc_material(c.cd_material),1,255),
				x.qt_tempo_aplicacao,
				x.qt_volume vol_etapa,
				x.qt_dosagem vel_infucao,
				x.ie_tipo_dosagem cd_um_velocidade,
				a.nr_atendimento visit_id,
				to_char(c.dt_inicio_horario, 'yyyymmddhh24miss') complicationdate,
				c.nr_sequencia complication_id,
				wheb_mensagem_pck.get_texto(1125486),
				'A' complication_value,
				to_char(c.dt_atualizacao, 'yyyymmddhh24miss') UPDATETIMESTAMP,
				coalesce(a.cd_pessoa_fisica, obter_pessoa_atendimento(a.nr_atendimento,'C')) patient_id
		from	prescr_solucao x,
				prescr_mat_hor c,
				prescr_medica a
		where	x.nr_prescricao = c.nr_prescricao
		and		x.nr_seq_solucao = c.nr_seq_solucao
		and		x.nr_prescricao = a.nr_prescricao
		and		c.nr_prescricao = a.nr_prescricao
		and		(c.dt_inicio_horario IS NOT NULL AND c.dt_inicio_horario::text <> '')
		and		a.nr_prescricao = nr_prescricao_p
		and		x.nr_seq_solucao = nr_seq_solucao_p
		and		c.nr_etapa_sol = nr_etapa_p
		and		c.ie_agrupador = 4
		and		Obter_estrutura_material(c.cd_material,'S') = 13
		and		(nr_seq_solucao_p IS NOT NULL AND nr_seq_solucao_p::text <> '')
		and		exists (	select	1
							from	atend_paciente_unidade z
							where	nr_seq_interno = Obter_Atepacu_paciente(nr_atendimento_p, 'A')
							and		obter_dif_data(z.dt_entrada_unidade, c.dt_inicio_horario, 'TS') <= 86400 -- Administrado ate 24h depois da internacao
							and		obter_classif_setor(z.cd_setor_atendimento) = 4)		--Setor de UTI
		
union

		select 	c.qt_dose,
				c.cd_unidade_medida_dose,
				c.cd_material,
				substr(obter_desc_material(c.cd_material),1,255) ds_material,
				0 QT_TEMPO_APLICACAO,
				0 vol_etapa,
				0 vel_infucao,
				'' cd_um_velocidade,
				a.nr_atendimento VISIT_ID,
				to_char(c.dt_fim_horario, 'yyyymmddhh24miss')COMPLICATIONDATE,
				c.nr_sequencia COMPLICATION_ID,
				wheb_mensagem_pck.get_texto(1125485) COMPLICATION_CODE,
				'S' COMPLICATION_VALUE,
				to_char(c.dt_atualizacao, 'yyyymmddhh24miss') UPDATETIMESTAMP,
				coalesce(a.cd_pessoa_fisica, obter_pessoa_atendimento(a.nr_atendimento,'C')) patient_id
		from	prescr_mat_hor c,
				prescr_medica a
		where	c.nr_prescricao = a.nr_prescricao
		and		(c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> '')
		and		a.nr_prescricao = nr_prescricao_p
		and		c.nr_sequencia = nr_seq_horario_p
		and		Obter_estrutura_material(c.cd_material,'S') = 13
		and		coalesce(nr_seq_solucao_p::text, '') = ''
		and		exists (	select	1
							from	atend_paciente_unidade z
							where	nr_seq_interno = Obter_Atepacu_paciente(nr_atendimento_p, 'A')
							and		obter_dif_data(z.dt_entrada_unidade, c.dt_fim_horario, 'TS') > 3600 -- Administrado apos 1h
							and		obter_classif_setor(z.cd_setor_atendimento) = 4)		--Setor de UTI
		
union

		select 	c.qt_dose,
				c.cd_unidade_medida_dose,
				c.cd_material,
				substr(obter_desc_material(c.cd_material),1,255),
				0 qt_tempo_aplicacao,
				0 vol_etapa,
				0 vel_infucao,
				'' cd_um_velocidade,
				a.nr_atendimento visit_id,
				to_char(c.dt_fim_horario, 'yyyymmddhh24miss') complicationdate,
				c.nr_sequencia complication_id,
				wheb_mensagem_pck.get_texto(1125486),
				'S' complication_value,
				to_char(c.dt_atualizacao, 'yyyymmddhh24miss') UPDATETIMESTAMP,
				coalesce(a.cd_pessoa_fisica, obter_pessoa_atendimento(a.nr_atendimento,'C')) patient_id
		from	prescr_mat_hor c,
				prescr_medica a
		where	c.nr_prescricao = a.nr_prescricao
		and		(c.dt_fim_horario IS NOT NULL AND c.dt_fim_horario::text <> '')
		and		a.nr_prescricao = nr_prescricao_p
		and		c.nr_sequencia = nr_seq_horario_p
		and		Obter_estrutura_material(c.cd_material,'S') = 13
		and		coalesce(nr_seq_solucao_p::text, '') = ''
		and		exists (	select	1
							from	atend_paciente_unidade z
							where	nr_seq_interno = Obter_Atepacu_paciente(nr_atendimento_p, 'A')
							and		obter_dif_data(z.dt_entrada_unidade, c.dt_fim_horario, 'TS') <= 86400 -- Administrado ate 24h depois da internacao
							and		obter_classif_setor(z.cd_setor_atendimento) = 4)		--Setor de UTI
		) tabela LIMIT 1;
	exception
		when others then
			visit_id_w := null;
	end;

	nm_usuario_w := coalesce(nm_usuario_p, wheb_usuario_pck.get_nm_usuario);

	if (visit_id_w IS NOT NULL AND visit_id_w::text <> '') then

		if (ie_acao_p = 'R') then
			complication_value_w := 'N';
		end if;

		SELECT BIFROST.SEND_INTEGRATION_CONTENT( 'patientinformation.complication',
										'{ "visitId" : "' ||visit_id_w || '",'
										|| '"patientId" : "' || patient_id_w ||'",'
										|| '"complicationDate" : "' || complicationdate_w ||'",'
										|| '"complicationId" : "' || complication_id_w ||'" ,'
										|| '"complicationCode" : "' || complication_code_w ||'" ,'
										|| '"complicationValue" : "' || complication_value_w ||'" ,'
										|| '"updatetimestamp" : "' || updatetimestamp_w ||'" ,'
										|| '"dosage" : "' || qt_dose_w ||'" ,'
										|| '"dosageUnitOfMeasurement" : "' || cd_unidade_medida_dose_w ||'" ,'
										|| '"materialId" : "' || cd_material_w ||'" ,'
										|| '"materialDescription" : "' || ds_material_w ||'" ,'
										|| '"applicationTime" : "' || qt_tempo_aplicacao_w ||'" ,'
										|| '"volumeOfStage" : "' || vol_etapa_w ||'" ,'
										|| '"infusionRate" : "' || vel_infucao_w ||'" ,'
										|| '"speedUnitOfMeasurement" : "' || cd_um_velocidade_w ||'" '
										|| '}',
										nm_usuario_w)
		INTO STRICT DS_INTEGRACAO_W
		;
	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE epimed_envia_aminas_vasoativas ( nr_prescricao_p bigint, nr_seq_solucao_p bigint, nr_etapa_p bigint, nr_atendimento_p bigint, nr_seq_horario_p bigint, nm_usuario_p text, ie_acao_p text default 'A') FROM PUBLIC;

