-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE proj_duplicar_aval_cons ( nm_usuario_p text, nr_sequencia_p bigint, ie_duplicate_res_p text default 'N') AS $body$
DECLARE


-- variaveis da avaliacao
nr_sequencia_w			    bigint;
nr_quesito_w			    bigint;
cd_consultor_w			    varchar(10);
cd_empresa_w			    smallint;
dt_avaliacao_w			    timestamp;
ie_complexidade_w			varchar(15);
ie_funcao_exec_w			varchar(15);
ie_regime_contr_w			varchar(15);
nr_seq_cliente_w			bigint;
nr_seq_modelo_w			    bigint;
nr_seq_nivel_consultor_w	bigint;
nr_seq_proj_w			    bigint;
qt_ponto_aval_w			    bigint;
vl_hora_w			        double precision;

-- variaveis dos quesitos
ie_tipo_avaliacao_w     varchar(3);
nr_seq_quesito_w        bigint;
ie_result_cb_w          varchar(1);
nr_seq_opcao_w          bigint;
qt_ponto_w			    bigint;
ds_observacao_w			varchar(255);
qt_ponto_orig_w			bigint;

-- variaveis dos resumos
nr_sequencia_res_w      bigint;
ie_tipo_avaliacao_res_w varchar(3);
qt_ponto_res_w          bigint;
vl_hora_res_w           double precision;

-- cursor quesitos
c01 CURSOR FOR
SELECT	ie_tipo_avaliacao,
	nr_seq_quesito,
	ie_result_cb,
	nr_seq_opcao,
	qt_ponto,
	ds_observacao,
	qt_ponto_orig
from	proj_consultor_aval_quesito
where	nr_seq_avaliacao = nr_sequencia_p;

c02 CURSOR FOR
SELECT  nr_sequencia,
    ie_tipo_avaliacao,
    qt_ponto,
    vl_hora
from    proj_consultor_aval_res
where   nr_seq_avaliacao = nr_sequencia_p;


BEGIN
select	nextval('proj_consultor_aval_seq')
into STRICT	nr_sequencia_w
;

select	cd_consultor,
	cd_empresa,
	dt_avaliacao,
	ie_complexidade,
	ie_funcao_exec,
	ie_regime_contr,
	nr_seq_cliente,
	nr_seq_modelo,
	nr_seq_proj,
	qt_ponto,
	vl_hora
into STRICT	cd_consultor_w,
	cd_empresa_w,
	dt_avaliacao_w,
	ie_complexidade_w,
	ie_funcao_exec_w,
	ie_regime_contr_w,
	nr_seq_cliente_w,
	nr_seq_modelo_w,
	nr_seq_proj_w,
	qt_ponto_aval_w,
	vl_hora_w
from	proj_consultor_aval
where	nr_sequencia = nr_sequencia_p;

select	max(nr_seq_nivel)
into STRICT	nr_seq_nivel_consultor_w
from	proj_consultor_nivel
where	cd_consultor = cd_consultor_w
and	dt_atualizacao = (	SELECT	max(dt_atualizacao)
			from	proj_consultor_nivel
			where	cd_consultor = cd_consultor_w);

--Duplicando avaliacao
insert	into proj_consultor_aval(
	nr_sequencia,
	nr_seq_cliente,
	cd_consultor,
	dt_atualizacao,
	nm_usuario,
	dt_avaliacao,
	dt_inicio_validade,
	qt_ponto,
	vl_hora,
	dt_aprovacao,
	nm_usuario_aprov,
	cd_empresa,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_seq_modelo,
	nr_seq_nivel_consultor,
	ie_complexidade,
	ie_funcao_exec,
	ie_regime_contr,
	nr_seq_proj)
values (nr_sequencia_w,
	nr_seq_cliente_w,
	cd_consultor_w,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	clock_timestamp(),
	qt_ponto_aval_w,
	vl_hora_w,
	null,
	null,
	cd_empresa_w,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_modelo_w,
	nr_seq_nivel_consultor_w,
	ie_complexidade_w,
	ie_funcao_exec_w,
	ie_regime_contr_w,
	nr_seq_proj_w);

open C01;
loop
fetch C01 into
	ie_tipo_avaliacao_w,
	nr_seq_quesito_w,
	ie_result_cb_w,
	nr_seq_opcao_w,
	qt_ponto_w,
	ds_observacao_w,
	qt_ponto_orig_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

	begin
	select	nextval('proj_consultor_aval_quesito_se')
	into STRICT	nr_quesito_w
	;

	insert	into proj_consultor_aval_quesito(
					nr_sequencia,
					nr_seq_avaliacao,
					dt_atualizacao,
					nm_usuario,
					ie_tipo_avaliacao,
					nr_seq_quesito,
					ie_result_cb,
					nr_seq_opcao,
					qt_ponto,
					ds_observacao,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					qt_ponto_orig)
			values (	nr_quesito_w,
					nr_sequencia_w,
					clock_timestamp(),
					nm_usuario_p,
					ie_tipo_avaliacao_w,
					nr_seq_quesito_w,
					ie_result_cb_w,
					nr_seq_opcao_w,
					qt_ponto_w,
					ds_observacao_w,
					clock_timestamp(),
					nm_usuario_p,
					qt_ponto_orig_w);
	end;
end loop;
close C01;

open c02;
loop
fetch C02 into
    nr_sequencia_res_w,
    ie_tipo_avaliacao_res_w,
    qt_ponto_res_w,
    vl_hora_res_w;
EXIT WHEN NOT FOUND; /* apply on c02 */

    begin
    if ie_duplicate_res_p = 'S' then
        select nextval('proj_consultor_aval_res_seq')
        into STRICT nr_sequencia_res_w
;

        insert into proj_consultor_aval_res(
                    nr_sequencia,
                    nr_seq_avaliacao,
                    dt_atualizacao,
                    nm_usuario,
                    ie_tipo_avaliacao,
                    qt_ponto,
                    vl_hora,
                    dt_atualizacao_nrec,
                    nm_usuario_nrec)
            values (
                    nr_sequencia_res_w,
                    nr_sequencia_w,
                    clock_timestamp(),
                    nm_usuario_p,
                    ie_tipo_avaliacao_res_w,
                    qt_ponto_res_w,
                    vl_hora_res_w,
                    clock_timestamp(),
                    nm_usuario_p);
    end if;
    end;
end loop;
close c02;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proj_duplicar_aval_cons ( nm_usuario_p text, nr_sequencia_p bigint, ie_duplicate_res_p text default 'N') FROM PUBLIC;

