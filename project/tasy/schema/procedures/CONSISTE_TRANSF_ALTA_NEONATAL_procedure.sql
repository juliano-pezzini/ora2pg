-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_transf_alta_neonatal (nr_atendimento_p bigint, ie_transf_alta_p text, ds_erro_p INOUT text) AS $body$
DECLARE

ds_erro_w   varchar(255);
ds_atend_rn_w atendimento_paciente.nr_atendimento%type;
ds_result_w	varchar(255);

c01 CURSOR FOR 
SELECT a.nr_atendimento 
from atendimento_paciente a, setor_atendimento b 
where a.nr_atendimento_mae = nr_atendimento_p 
and b.cd_setor_atendimento = obter_setor_atendimento(a.nr_atendimento) 
and coalesce(b.ie_setor_neonatal, 'N') = 'N' 
and coalesce(a.dt_alta::text, '') = '';

BEGIN
ds_erro_w   := null;
ds_atend_rn_w := null;
ds_result_w  := null;
  
 open c01;
 loop 
 fetch c01 into ds_atend_rn_w;
 EXIT WHEN NOT FOUND; /* apply on c01 */
  	begin			  
	if (ds_result_w IS NOT NULL AND ds_result_w::text <> '') then 
		ds_result_w := substr(ds_result_w ||', '|| ds_atend_rn_w,1,255);
	else 
		ds_result_w := ds_atend_rn_w;
	end if;
	end;
 end loop;
 close c01;
 if (ds_result_w IS NOT NULL AND ds_result_w::text <> '') then 
  begin 
   if (ie_transf_alta_p = 'A') then --Alta 
    ds_erro_w := substr(wheb_mensagem_pck.get_texto(444137, 'ATENDRN='|| ds_result_w),1,255);
   elsif (ie_transf_alta_p = 'T') then -- TrasferÃªncia 
 	  ds_erro_w := substr(wheb_mensagem_pck.get_texto(444138, 'ATENDRN='|| ds_result_w),1,255);
   end if;
  end;
 end if;
  
ds_erro_p := ds_erro_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_transf_alta_neonatal (nr_atendimento_p bigint, ie_transf_alta_p text, ds_erro_p INOUT text) FROM PUBLIC;

