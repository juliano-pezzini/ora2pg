-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE campos AS (nr_seq_grupo	bigint,
			nr_seq_grupo_imp bigint,
			nr_seq_material 	bigint,
			cd_exame		varchar(20),
			ds_exame		varchar(255),
			ds_exame2		varchar(500),
			nr_seq_lab		varchar(20),
			qt_exame		integer,
			nr_amostra		integer,
			ds_material_especial	varchar(255),
			dt_prev_execucao	timestamp,
			nr_Seq_origem		bigint,
			nr_Seq_prescr_origem	bigint,
			nr_seq_prescr_proc_mat	bigint,
			cd_cgc_externo		varchar(14),
			ie_externo		varchar(1),
			ie_urgencia		varchar(1));


CREATE OR REPLACE PROCEDURE lab_gerar_etiqueta_prescr (nr_prescricao_p bigint, nr_seq_prescr_p text, qt_exames_p bigint, ie_opcao_p bigint, nm_usuario_p text) AS $body$
DECLARE


TYPE Vetor IS TABLE OF campos INDEX BY integer;
i				integer := 1;
x				integer := 1;
y				integer;
Vetor_Exame_w		Vetor;
nr_seq_grupo_w		bigint;
nr_seq_grupo_imp_w	bigint;
nr_seq_exame_w		bigint;
nr_seq_material_w	bigint;
nr_etiqueta_w		bigint;
cd_exame_w		varchar(20);
qt_exame_w		integer;
nr_seq_prescr_w		varchar(255);
nr_sequencia_w		bigint;
nr_seq_lab_w		varchar(20);
ds_material_especial_w	varchar(255);
dt_prev_execucao_w	timestamp;
cd_exame_integracao_w	varchar(20);
ds_exame_amostra_w	varchar(20);
nr_seq_origem_w		bigint;
nr_Seq_prescr_hor_w	bigint;
nr_seq_prescr_proc_mat_w	bigint;
cd_cgc_externo_w	varchar(14);
ie_externo_w	varchar(1);
ie_urgencia_w	varchar(1);

c01 CURSOR FOR
	SELECT (CASE WHEN ie_opcao_p=2 THEN  0  ELSE CASE WHEN ie_opcao_p=6 THEN 0  ELSE b.nr_seq_grupo END  END ),
		CASE WHEN ie_opcao_p=9 THEN b.nr_seq_grupo_imp  ELSE null END ,
		(b.nr_seq_exame),
		(b.cd_exame),
		Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,a.nr_sequencia,1),
		(coalesce(d.nr_etiqueta,1) + coalesce(d.qt_coleta,1) - 1),
		(a.nr_seq_lab),
		coalesce(a.ds_material_especial,NULL),
		trunc(a.dt_prev_execucao),
		cd_exame_integracao,
		coalesce(nr_Seq_origem,0),
		CASE WHEN coalesce(nr_seq_origem::text, '') = '' THEN null  ELSE a.nr_sequencia END ,
		0 nr_seq_prescr_proc_mat,
		CASE WHEN ie_opcao_p=2 THEN b.cd_cgc_externo  ELSE null END ,
		CASE WHEN ie_opcao_p=7 THEN CASE WHEN coalesce(b.cd_cgc_externo::text, '') = '' THEN 'N'  ELSE 'S' END   ELSE CASE WHEN ie_opcao_p=8 THEN CASE WHEN coalesce(b.cd_cgc_externo::text, '') = '' THEN 'N'  ELSE 'S' END   ELSE null END  END ,
		CASE WHEN ie_opcao_p=10 THEN a.ie_urgencia  ELSE null END
	FROM	exame_lab_material d,
		material_exame_lab c,
		exame_laboratorio b,
		prescr_procedimento a
	WHERE	a.nr_seq_exame = b.nr_seq_exame
	  AND	a.nr_seq_exame = d.nr_seq_exame
	  AND	a.cd_material_exame = c.cd_material_exame
	  AND	c.nr_sequencia = d.nr_seq_material
	  AND	a.ie_suspenso = 'N'
	  AND	a.nr_prescricao = nr_prescricao_p
	  AND	a.nr_sequencia = CASE WHEN nr_sequencia_w=0 THEN a.nr_sequencia  ELSE nr_sequencia_w END 
	  and 	ie_opcao_p <> 5
	
UNION

	SELECT (CASE WHEN ie_opcao_p=2 THEN  0  ELSE CASE WHEN ie_opcao_p=6 THEN 0  ELSE c.nr_seq_grupo END  END ),
		CASE WHEN ie_opcao_p=9 THEN c.nr_seq_grupo_imp  ELSE null END ,
		(b.nr_seq_exame_dep),
		(c.cd_exame),
		b.nr_seq_material,
		1,
		(a.nr_seq_lab),
		coalesce(a.ds_material_especial,NULL),
		trunc(a.dt_prev_execucao),
		cd_exame_integracao,
		0,
		null,
		0 nr_seq_prescr_proc_mat,
		CASE WHEN ie_opcao_p=2 THEN c.cd_cgc_externo  ELSE null END ,
		CASE WHEN ie_opcao_p=7 THEN CASE WHEN coalesce(c.cd_cgc_externo::text, '') = '' THEN 'N'  ELSE 'S' END   ELSE CASE WHEN ie_opcao_p=8 THEN CASE WHEN coalesce(c.cd_cgc_externo::text, '') = '' THEN 'N'  ELSE 'S' END   ELSE null END  END ,
		CASE WHEN ie_opcao_p=10 THEN a.ie_urgencia  ELSE null END 
	FROM	exame_laboratorio c,
		exame_lab_dependente b,
		prescr_procedimento a
	WHERE	a.nr_seq_exame = b.nr_seq_exame
	  AND	b.nr_seq_exame_dep = c.nr_seq_exame
	  AND	a.ie_suspenso = 'N'
	  AND	b.ie_geracao = 2
	  AND	a.nr_prescricao = nr_prescricao_p
	  AND	a.nr_sequencia = CASE WHEN nr_sequencia_w=0 THEN a.nr_sequencia  ELSE nr_sequencia_w END 
	
union

	SELECT (CASE WHEN ie_opcao_p=2 THEN  0  ELSE CASE WHEN ie_opcao_p=6 THEN 0  ELSE b.nr_seq_grupo END  END ),
		CASE WHEN ie_opcao_p=9 THEN b.nr_seq_grupo_imp  ELSE null END ,
		(b.nr_seq_exame),
		(b.cd_exame),
		Obter_Mat_Exame_Lab_prescr(a.nr_prescricao,a.nr_sequencia,1),
		1,
		null,
		coalesce(a.ds_material_especial,NULL),
		trunc(a.dt_prev_execucao),
		cd_exame_integracao,
		0,
		null,
		e.nr_seq_prescr_proc_mat,
		null,
		null,
		null
	FROM	exame_lab_material d,
		material_exame_lab c,
		exame_laboratorio b,
		prescr_procedimento a,
		prescr_proc_mat_item e
	WHERE	a.nr_seq_exame = b.nr_seq_exame
	  AND	a.nr_seq_exame = d.nr_seq_exame
	  AND	a.cd_material_exame = c.cd_material_exame
	  and 	a.nr_prescricao = e.nr_prescricao
	  and   a.nr_sequencia  = e.nr_seq_prescr
	  AND	c.nr_sequencia = d.nr_seq_material
	  AND	a.ie_suspenso = 'N'
	  AND	a.nr_prescricao = nr_prescricao_p
	  AND	a.nr_sequencia = CASE WHEN nr_sequencia_w=0 THEN a.nr_sequencia  ELSE nr_sequencia_w END 
	  and 	ie_opcao_p = 5
     ORDER BY 	1, 4, 7, 5, 10, 12, 13, 3;

BEGIN
DELETE FROM w_lab_etiqueta
WHERE nm_usuario = nm_usuario_p;
nr_seq_prescr_w	:= nr_seq_prescr_p;

IF (coalesce(nr_seq_prescr_w::text, '') = '') THEN
	nr_seq_prescr_w := '0';
END IF;

nr_seq_prescr_w := nr_seq_prescr_w || ',';
qt_exame_w		:= 0;

WHILE LENGTH(nr_seq_prescr_w) > 0 LOOP

	nr_sequencia_w	:= (SUBSTR(nr_seq_prescr_w,1,position(',' in nr_seq_prescr_w) -1))::numeric;
	nr_seq_prescr_w	:= SUBSTR(nr_seq_prescr_w,position(',' in nr_seq_prescr_w) + 1, 255);

	OPEN C01;
	LOOP
		FETCH c01 INTO	nr_seq_grupo_w,
				nr_seq_grupo_imp_w,
				nr_seq_exame_w,
				cd_exame_w,
				nr_seq_material_w,
				nr_etiqueta_w,
				nr_seq_lab_w,
				ds_material_especial_w,
				dt_prev_execucao_w,
				cd_exame_integracao_w,
				nr_Seq_origem_w,
				nr_Seq_prescr_hor_w,
				nr_seq_prescr_proc_mat_w,
				cd_cgc_externo_w,
				ie_externo_w,
				ie_urgencia_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */

		if	(ie_opcao_p = 8 AND ie_externo_w = 'S') or (ie_opcao_p = 7) then
			nr_seq_grupo_w := null;
		end if;



		FOR x IN 1..nr_etiqueta_w LOOP
			y := 0;
			IF (ie_opcao_p <> 3) THEN
				FOR i IN 1..Vetor_Exame_w.COUNT LOOP



					IF	(((Vetor_Exame_w[i].nr_seq_grupo = nr_seq_grupo_w) or (((ie_opcao_p = 8) or (ie_opcao_p = 7)) and (coalesce(nr_seq_grupo_w::text, '') = ''))) and
						((Vetor_Exame_w[i].nr_seq_grupo_imp = nr_seq_grupo_imp_w) or ((Vetor_Exame_w[i]coalesce(.nr_seq_grupo_imp::text, '') = '') and (coalesce(nr_seq_grupo_imp_w::text, '') = ''))) and (Vetor_Exame_w[i].nr_seq_material = nr_seq_material_w) AND
						((Vetor_Exame_w[i].cd_cgc_externo = cd_cgc_externo_w) or ((Vetor_Exame_w[i]coalesce(.cd_cgc_externo::text, '') = '') and (coalesce(cd_cgc_externo_w::text, '') = ''))) AND
--						((Vetor_Exame_w(i).cd_cgc_externo = cd_cgc_externo_w) or (Vetor_Exame_w(i).cd_cgc_externo is null)) AND
						((Vetor_Exame_w[i].ie_externo = ie_externo_w) or (Vetor_Exame_w[i]coalesce(.ie_externo::text, '') = '')) AND
						((Vetor_Exame_w[i].ie_urgencia = ie_urgencia_w) or ((Vetor_Exame_w[i]coalesce(.ie_urgencia::text, '') = '') and (coalesce(ie_urgencia_w::text, '') = ''))) and
						((coalesce(nr_Seq_prescr_hor_w::text, '') = '') or (Vetor_Exame_w[i].nr_Seq_prescr_origem = nr_Seq_prescr_hor_w))  AND
						((Vetor_Exame_w[i].ds_material_especial = ds_material_especial_w) or (Vetor_Exame_w[i]coalesce(.ds_material_especial::text, '') = '')) AND (Vetor_Exame_w[i].cd_exame <> cd_exame_w) AND
						((Vetor_Exame_w[i].dt_prev_execucao = dt_prev_execucao_w) or (ie_opcao_p <> 4)) And
						((ie_opcao_p IN (1,2,6,10)) OR (Vetor_Exame_w[i].qt_exame < qt_exames_p) and (ie_opcao_p <> 5)) or (Vetor_Exame_w[i].nr_seq_prescr_proc_mat = nr_seq_prescr_proc_mat_w and ie_opcao_p = 5)) THEN


						y := i;
						exit;
					END IF;
				END LOOP;
			END IF;

			if (ie_opcao_p = 4) then

				select obter_descr_amostra_lab(nr_prescricao_p,cd_exame_integracao_w,x,0)
				into STRICT  ds_exame_amostra_w
				;

			end if;

			IF (y = 0) THEN
				y := Vetor_Exame_w.COUNT + 1;
				Vetor_Exame_w[y].ds_exame	:= cd_exame_w;
				if ((ie_opcao_p = 4) and (ds_exame_amostra_w IS NOT NULL AND ds_exame_amostra_w::text <> '') and (cd_exame_integracao_w IS NOT NULL AND cd_exame_integracao_w::text <> '')) then
					Vetor_Exame_w[y].ds_exame	:= Vetor_Exame_w[y].ds_exame|| '-' || ds_exame_amostra_w;
				end if;
				Vetor_Exame_w[y].qt_exame	:= 1;
			ELSE
				IF (Vetor_Exame_w[y].qt_exame < qt_exames_p) THEN

					Vetor_Exame_w[y].ds_exame := Vetor_Exame_w[y].ds_exame || ' ' || cd_exame_w;
					if ((ie_opcao_p = 4) and (ds_exame_amostra_w IS NOT NULL AND ds_exame_amostra_w::text <> '') and (cd_exame_integracao_w IS NOT NULL AND cd_exame_integracao_w::text <> '')) then
						Vetor_Exame_w[y].ds_exame := Vetor_Exame_w[y].ds_exame || '-' || ds_exame_amostra_w;
					end if;
				ELSE
					Vetor_Exame_w[y].ds_exame2:= Vetor_Exame_w[y].ds_exame2 || cd_exame_w || ' ';
					if ((ie_opcao_p = 4) and (ds_exame_amostra_w IS NOT NULL AND ds_exame_amostra_w::text <> '') and (cd_exame_integracao_w IS NOT NULL AND cd_exame_integracao_w::text <> '')) then
						Vetor_Exame_w[y].ds_exame2 := Vetor_Exame_w[y].ds_exame2 || '-' || ds_exame_amostra_w;
					end if;

				END IF;
				Vetor_Exame_w[y].qt_exame := Vetor_Exame_w[y].qt_exame + 1;
			END IF;
--			if	(y > 1) then
--			end if;
			Vetor_Exame_w[y].nr_seq_grupo	 	:= nr_seq_grupo_w;
			Vetor_Exame_w[y].nr_seq_grupo_imp 	:= nr_seq_grupo_imp_w;
			Vetor_Exame_w[y].nr_seq_material 	:= nr_seq_material_w;
			Vetor_Exame_w[y].nr_seq_lab	 	:= nr_seq_lab_w;
			Vetor_Exame_w[y].cd_exame	 	:= cd_exame_w;
			Vetor_Exame_w[y].nr_amostra	 	:= x;
			Vetor_Exame_w[y].ds_material_especial	:= ds_material_especial_w;
			Vetor_Exame_w[y].dt_prev_execucao	:= dt_prev_execucao_w;
			Vetor_Exame_w[y].nr_seq_origem		:= nr_seq_origem_w;
			Vetor_Exame_w[y].nr_Seq_prescr_origem	:= nr_Seq_prescr_hor_w;
			Vetor_Exame_w[y].nr_seq_prescr_proc_mat := nr_seq_prescr_proc_mat_w;
			Vetor_Exame_w[y].cd_cgc_externo		:= cd_cgc_externo_w;
			Vetor_Exame_w[y].ie_externo		:= ie_externo_w;
			Vetor_Exame_w[y].ie_urgencia	:= ie_urgencia_w;


		END LOOP;
	END LOOP;
	CLOSE C01;
END LOOP;
nr_seq_material_w := 0;
FOR i IN 1..Vetor_Exame_w.COUNT LOOP
	IF (nr_seq_material_w <> Vetor_Exame_w[i].nr_seq_material) and (ds_material_especial_w <> Vetor_Exame_w[i].ds_material_especial) THEN
		x := i;
	END IF;
	nr_seq_material_w := Vetor_Exame_w[1].nr_seq_material;

	INSERT INTO w_lab_etiqueta(nr_sequencia, nm_usuario, nr_prescricao, nr_seq_grupo, nr_seq_material, ds_exame, ds_exame2, nr_seq_lab,
nr_etiqueta, nr_amostra, nr_seq_prescr_proc_mat, cd_cgc_externo, ie_externo, nr_seq_grupo_imp, ie_urgencia, ds_material_especial)
	VALUES (nextval('w_lab_etiqueta_seq'), nm_usuario_p, nr_prescricao_p, Vetor_Exame_w[i].nr_seq_grupo, Vetor_Exame_w[i].nr_seq_material,
			Vetor_Exame_w[i].ds_exame, Vetor_Exame_w[i].ds_exame2, to_char(obter_somente_numero(Vetor_Exame_w[i].nr_seq_lab)), i - x + 1,
			Vetor_Exame_w[i].nr_amostra, Vetor_Exame_w[i].nr_seq_prescr_proc_mat, Vetor_Exame_w[i].cd_cgc_externo,
			Vetor_Exame_w[i].ie_externo,Vetor_Exame_w[i].nr_seq_grupo_imp,
			Vetor_Exame_w[i].ie_urgencia, Vetor_Exame_w[i].ds_material_especial);
END LOOP;
COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_gerar_etiqueta_prescr (nr_prescricao_p bigint, nr_seq_prescr_p text, qt_exames_p bigint, ie_opcao_p bigint, nm_usuario_p text) FROM PUBLIC;

