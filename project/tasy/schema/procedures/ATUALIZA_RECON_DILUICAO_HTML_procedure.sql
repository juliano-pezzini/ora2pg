-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_recon_diluicao_html ( nr_prescricao_p bigint, nr_seq_cpoe_p bigint, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE

					
cd_mat_dil_w					cpoe_material.cd_mat_dil%type;
cd_mat_recons_w					cpoe_material.cd_mat_recons%type;
cd_mat_red_w					cpoe_material.cd_mat_red%type;
cd_material_w					cpoe_material.cd_material%type;


cd_material_exclusao_w			prescr_material.cd_material%type;
nr_seq_solucao_w				prescr_material.nr_sequencia_solucao%type;
nr_seq_material_w				prescr_material.nr_sequencia%type;
nr_seq_mat_exclusao_w			prescr_material.nr_sequencia%type;

qt_diluente_w					bigint;
qt_reconstituinte_w				bigint;
qt_rediluente_w					bigint;
ie_reg_alt_farm_w				varchar(1);

c01 CURSOR FOR
SELECT	cd_mat_dil,
		cd_mat_recons,
		cd_mat_red,
		cd_material
from	cpoe_material
where	nr_sequencia = nr_seq_cpoe_p;		


	procedure deletar_recon_dil_med(
						ie_agrupador_p		bigint) is
						
	;
BEGIN
		begin
		if (ie_reg_alt_farm_w = 'S') then
		
			select	max(cd_material),
					max(nr_sequencia)
			into STRICT	cd_material_exclusao_w,
					nr_seq_mat_exclusao_w
			from	prescr_material
			where	nr_seq_mat_cpoe = nr_seq_cpoe_p
			and		nr_prescricao = nr_prescricao_p
			and		coalesce(ie_suspenso,'N') = 'N'
			and		ie_agrupador = ie_agrupador_p;
		
			CALL gerar_historico_dil_red_rec('N', 3, ie_agrupador_p, nr_prescricao_p, nr_seq_mat_exclusao_w, cd_material_exclusao_w, null, null, null, null, null, null, null,cd_estabelecimento_p, nm_usuario_p);
		end if;
		
		delete	from prescr_material
		where	nr_seq_mat_cpoe = nr_seq_cpoe_p
		and		nr_prescricao = nr_prescricao_p
		and		coalesce(ie_suspenso,'N') = 'N'
		and		ie_agrupador = ie_agrupador_p;
		commit;
		
		
		exception
			when no_data_found then
				null;
			when others then
				null;
		end;
	end;

begin

ie_reg_alt_farm_w := obter_param_usuario(7010, 48, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_reg_alt_farm_w);

open c01;
loop
fetch c01 into 	cd_mat_dil_w,
				cd_mat_recons_w,
				cd_mat_red_w,
				cd_material_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin	
	select	max(nr_sequencia)
	into STRICT	nr_seq_material_w
	from	prescr_material
	where	cd_material = cd_material_w
	and		nr_seq_mat_cpoe = nr_seq_cpoe_p
	and		coalesce(ie_suspenso,'N') = 'N'
	and		nr_prescricao = nr_prescricao_p;	
		--- Verifica se o diluente da CPOE_MATERIAL é nulo, se for ele exclui da prescr_material senão ele atualiza ou insere caso não exista um diluente para aquele nr_seq_mat_cpoe
	if (coalesce(cd_mat_dil_w::text, '') = '') then
		deletar_recon_dil_med(3);
	else
		select 	count(*)
		into STRICT	qt_diluente_w
		from	prescr_material
		where	nr_seq_mat_cpoe = nr_seq_cpoe_p
		and		nr_prescricao = nr_prescricao_p
		and		coalesce(ie_suspenso,'N') = 'N'
		and		ie_agrupador = 3;
		
		if (qt_diluente_w = 0) then
			CALL html_insere_recon_dil_med(nr_prescricao_p, nr_seq_cpoe_p, nm_usuario_p, cd_perfil_p, cd_estabelecimento_p,'D',ie_reg_alt_farm_w);
		else
			CALL html_atualiza_recon_dil_med(nr_prescricao_p, nr_seq_cpoe_p, nm_usuario_p, cd_estabelecimento_p,'D',ie_reg_alt_farm_w);
		end if;			
	end if;
	--- Verifica se o reconstituinte da CPOE_MATERIAL é nulo, se for ele exclui da prescr_material senão ele atualiza ou insere caso não exista um reconstituinte para aquele nr_seq_mat_cpoe
	if (coalesce(cd_mat_recons_w::text, '') = '') then
		deletar_recon_dil_med(9);
	else
		select 	count(*)
		into STRICT	qt_reconstituinte_w
		from	prescr_material
		where	nr_seq_mat_cpoe = nr_seq_cpoe_p
		and		nr_prescricao = nr_prescricao_p
		and		coalesce(ie_suspenso,'N') = 'N'
		and		ie_agrupador = 9;
		
		if (qt_reconstituinte_w = 0) then
			CALL html_insere_recon_dil_med(nr_prescricao_p, nr_seq_cpoe_p, nm_usuario_p, cd_perfil_p, cd_estabelecimento_p,'R',ie_reg_alt_farm_w);
		else
			CALL html_atualiza_recon_dil_med(nr_prescricao_p, nr_seq_cpoe_p, nm_usuario_p, cd_estabelecimento_p,'R',ie_reg_alt_farm_w);
		end if;			
	end if;
	--- Verifica se o diluente da CPOE_MATERIAL é nulo, se for ele exclui da prescr_material senão ele atualiza ou insere caso não exista um diluente para aquele nr_seq_mat_cpoe
	if (coalesce(cd_mat_red_w::text, '') = '') then
		deletar_recon_dil_med(7);
	else
		select 	count(*)
		into STRICT	qt_rediluente_w
		from	prescr_material
		where	nr_seq_mat_cpoe = nr_seq_cpoe_p
		and		nr_prescricao = nr_prescricao_p
		and		coalesce(ie_suspenso,'N') = 'N'
		and		ie_agrupador = 7;
		
		if (qt_reconstituinte_w = 0) then
			CALL html_insere_recon_dil_med(nr_prescricao_p, nr_seq_cpoe_p, nm_usuario_p, cd_perfil_p, cd_estabelecimento_p,'RD',ie_reg_alt_farm_w);
		else
			CALL html_atualiza_recon_dil_med(nr_prescricao_p, nr_seq_cpoe_p, nm_usuario_p, cd_estabelecimento_p,'RD',ie_reg_alt_farm_w);
		end if;			
	end if;
	
	CALL atualiza_reconst_diluicao( nr_prescricao_p, nr_seq_material_w);
	CALL ajustar_prescr_material( nr_prescricao_p, nr_seq_material_w);
	CALL gerar_prescr_mat_diluicao( nr_prescricao_p, nr_seq_material_w,nm_usuario_p,cd_perfil_p);
	CALL atualizar_tempo_aplic_medic( nr_prescricao_p, nr_seq_material_w);
	end;
end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_recon_diluicao_html ( nr_prescricao_p bigint, nr_seq_cpoe_p bigint, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

