-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_dados_duplic_sae ( nr_sequencia_p bigint, cd_paciente_p text, nr_seq_sae_p INOUT bigint, nr_seq_modelo_p INOUT bigint, ie_tipo_sae_p text default 'SAE') AS $body$
DECLARE


nr_sequencia_w			bigint;
nr_atendimento_w		bigint;
nr_seq_sae_w			bigint;
nr_seq_modelo_w			bigint;
nr_seq_modelo_selec_w		bigint;
ie_ult_sae_duplicar_w	varchar(5);



BEGIN

ie_ult_sae_duplicar_w := obter_param_usuario(281, 1412, obter_perfil_ativo, obter_usuario_ativo, obter_estabelecimento_ativo, ie_ult_sae_duplicar_w);

Select  max(nr_atendimento),
	max(nr_seq_modelo)
into STRICT	nr_atendimento_w,
	nr_seq_modelo_selec_w
from	pe_prescricao
where	nr_sequencia = nr_sequencia_p;

select	max(nr_sequencia)
into STRICT	nr_sequencia_w
from	pe_prescricao
where	ie_situacao = 'A'
and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and		nr_atendimento = nr_atendimento_w
and     Obter_se_modelo_SAE_lib(nr_seq_modelo,cd_paciente_p, nr_atendimento_w) = 'S'
and     coalesce(nr_seq_saep::text, '') = ''
and		coalesce(ie_tipo,ie_tipo_sae_p) = ie_tipo_sae_p
and	((ie_ult_sae_duplicar_w = 'M' AND nr_seq_modelo = nr_seq_modelo_selec_w) or (ie_ult_sae_duplicar_w = 'S'));

if (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') then

	Select  max(nr_seq_modelo)
	into STRICT	nr_seq_modelo_w
	from	pe_prescricao
	where	nr_sequencia = nr_sequencia_w;

	nr_seq_sae_p := nr_sequencia_w;
	nr_seq_modelo_p :=  nr_seq_modelo_w;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_dados_duplic_sae ( nr_sequencia_p bigint, cd_paciente_p text, nr_seq_sae_p INOUT bigint, nr_seq_modelo_p INOUT bigint, ie_tipo_sae_p text default 'SAE') FROM PUBLIC;

