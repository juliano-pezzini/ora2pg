-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_tiss_consistir_diagnostico ( nr_sequencia_p bigint, ie_tipo_glosa_p text, ie_evento_p text, nr_seq_prestador_p bigint, nr_seq_ocorrencia_p bigint, ds_parametro_um_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Realiza a consistência  de um diagnóstico.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  x]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:Performance.
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
/* IE_TIPO_GLOSA_P
	C - Conta
	CP - Conta procedimento
	CM - Conta material
	A - Autorização
	AP - Autorização procedimento
	AM - Autorização material
*/
cd_procedimento_w		bigint;
ie_origem_proced_w		integer;
nr_seq_clinica_w		bigint;
nr_seq_clinica_ww		bigint;
ie_tipo_guia_w			varchar(2);
qt_clinica_w			integer;
ie_internacao_invalida_w	varchar(1) := 'S';
ie_carater_internacao_w		varchar(10);
nr_seq_guia_w			bigint;
nr_seq_clinica_guia_w		pls_guia_plano.nr_seq_clinica%type;


BEGIN

if (ie_tipo_glosa_p	= 'C') then
	/*Obter dados da conta */

	begin
		select	coalesce(nr_seq_clinica,nr_seq_clinica_imp),
			ie_tipo_guia,
			ie_carater_internacao,
			nr_seq_guia
		into STRICT	nr_seq_clinica_w,
			ie_tipo_guia_w,
			ie_carater_internacao_w,
			nr_seq_guia_w
		from	pls_conta
		where	nr_sequencia = nr_sequencia_p;
	exception
	when others then
		nr_seq_clinica_w 	:= null;
		ie_tipo_guia_w		:= null;
		ie_carater_internacao_w	:= null;
		nr_seq_guia_w		:= null;
	end;

	if (ie_evento_p = 'IA') then

		select	max(nr_sequencia)
		into STRICT	nr_seq_clinica_ww
		from	pls_clinica
		where	cd_clinica = nr_seq_clinica_w;

		nr_seq_clinica_w := nr_seq_clinica_ww;

		select	max(ie_carater_internacao_imp)
		into STRICT	ie_carater_internacao_w
		from	pls_conta
		where	nr_sequencia = nr_sequencia_p;
	end if;
elsif (ie_tipo_glosa_p	= 'A') then
	/* Obter dados da guia */

	begin
		select	nr_seq_clinica,
			ie_tipo_guia,
			ie_carater_internacao
		into STRICT	nr_seq_clinica_w,
			ie_tipo_guia_w,
			ie_carater_internacao_w
		from	pls_guia_plano
		where	nr_sequencia = nr_sequencia_p;
	exception
	when others then
		nr_seq_clinica_w := null;
	end;
end if;

if (ie_tipo_glosa_p in ('C','A')) and (nr_seq_clinica_w IS NOT NULL AND nr_seq_clinica_w::text <> '') then

	select	count(1)
	into STRICT	qt_clinica_w
	from	pls_clinica
	where	nr_sequencia = nr_seq_clinica_w;

	if (qt_clinica_w > 0) then
		ie_internacao_invalida_w := 'N';
	end if;
end if;

if (ie_tipo_glosa_p = 'C') and (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') and (nr_seq_clinica_w IS NOT NULL AND nr_seq_clinica_w::text <> '') then

	select	max(nr_seq_clinica)
	into STRICT	nr_seq_clinica_guia_w
	from	pls_guia_plano
	where	nr_sequencia = nr_seq_guia_w;

	if (nr_seq_clinica_guia_w <> nr_seq_clinica_w) then
		ie_internacao_invalida_w := 'S';
	end if;
end if;

/* 1504 - Caráter de Internação Inválido */

if (ie_tipo_guia_w	 not in ('3','6','4','8')) then
	if (ie_carater_internacao_w IS NOT NULL AND ie_carater_internacao_w::text <> '') then
		if (ie_carater_internacao_w = '1') then
			ie_carater_internacao_w := 'E';
		elsif (ie_carater_internacao_w = '2') then
			ie_carater_internacao_w := 'U';
		end if;
	end if;

	if (coalesce(ie_carater_internacao_w,'X') not in ('E','U')) then
		if (coalesce(ie_carater_internacao_w,'X') = 'X') then
			ie_carater_internacao_w := 'N/Inf.';
		end if;

		CALL pls_gravar_glosa_tiss('1504',
				'Caráter internação/solicitação informado não segue o padrão TISS: ' || ie_carater_internacao_w, ie_evento_p,
				nr_sequencia_p, ie_tipo_glosa_p, nr_seq_prestador_p,
				nr_seq_ocorrencia_p, null, nm_usuario_p,
				cd_estabelecimento_p, null);
	end if;
end if;

/*1506 - Tipo de Internação Inválido*/

if (ie_internacao_invalida_w = 'S') and (ie_tipo_guia_w in ('5','1')) then
	CALL pls_gravar_glosa_tiss('1506',
		null, ie_evento_p,
		nr_sequencia_p, ie_tipo_glosa_p, nr_seq_prestador_p,
		nr_seq_ocorrencia_p, '', nm_usuario_p,
		cd_estabelecimento_p, null);
end if;

--commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_tiss_consistir_diagnostico ( nr_sequencia_p bigint, ie_tipo_glosa_p text, ie_evento_p text, nr_seq_prestador_p bigint, nr_seq_ocorrencia_p bigint, ds_parametro_um_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

