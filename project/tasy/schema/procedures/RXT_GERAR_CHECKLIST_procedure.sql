-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rxt_gerar_checklist ( cd_pessoa_fisica_p text, nm_usuario_p text, nr_sequencia_p bigint, cd_medico_p text) AS $body$
DECLARE


nr_seq_checklist_w	bigint;
qt_checklist_w		bigint;
nr_seq_check_w		bigint;
nr_atendimento_w	bigint;

C01 CURSOR FOR
	SELECT	nr_seq_checklist
	from	checklist_processo_regra
	where	ie_momento = 'R'
	order by nr_seq_checklist;

BEGIN

if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then

	open C01;
	loop
	fetch C01 into
		nr_seq_checklist_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		select	count(*)
		into STRICT	qt_checklist_w
		from 	atendimento_checklist
		where	cd_pessoa_fisica = cd_pessoa_fisica_p
		and		nr_seq_checklist = nr_seq_checklist_w;

		if (qt_checklist_w = 0) then

			select	nextval('atendimento_checklist_seq')
			into STRICT	nr_seq_check_w
			;

			insert into atendimento_checklist(nr_sequencia,
												dt_atualizacao,
												nm_usuario,
												dt_atualizacao_nrec,
												nm_usuario_nrec,
												nr_seq_checklist,
												dt_registro,
												cd_pessoa_fisica,
												cd_profissional)
							values (nr_seq_check_w,
									clock_timestamp(),
									nm_usuario_p,
									clock_timestamp(),
									nm_usuario_p,
									nr_seq_checklist_w,
									clock_timestamp(),
									cd_pessoa_fisica_p,
									cd_medico_p);

			update	rxt_tumor
			set	    nr_seq_checklist = nr_seq_check_w
			where	nr_sequencia = nr_sequencia_p;

			select	coalesce(max(nr_atendimento),0)
			into STRICT	nr_atendimento_w
			from	rxt_tumor
			where	nr_sequencia = nr_sequencia_p;

			if (nr_atendimento_w > 0) then

				update	atendimento_checklist
				set		nr_atendimento = nr_atendimento_w
				where	nr_sequencia = nr_seq_check_w;

			end if;

			CALL gerar_checklist_atendimento(nm_usuario_p,nr_seq_check_w,cd_medico_p);

		end if;

		end;
	end loop;
	close C01;

end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rxt_gerar_checklist ( cd_pessoa_fisica_p text, nm_usuario_p text, nr_sequencia_p bigint, cd_medico_p text) FROM PUBLIC;

