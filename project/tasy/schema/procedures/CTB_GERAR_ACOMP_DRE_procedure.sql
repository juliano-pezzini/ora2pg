-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE reg_campos AS (
		vl_mes			double precision);
CREATE TYPE reg_contas AS (
		cd_conta		varchar(40),
		ds_conta		varchar(255));


CREATE OR REPLACE PROCEDURE ctb_gerar_acomp_dre ( cd_empresa_p bigint, cd_estab_p bigint, cd_centro_custo_p bigint, ie_tipo_visual_p bigint, ie_tipo_valor_p bigint, nr_seq_mes_inicial_p bigint, nr_seq_mes_final_p bigint, nr_seq_tipo_estrutura_p bigint, nr_seq_cenario_p bigint, ie_consolidar_p text, nm_usuario_p text, cd_conta_contabil_p text, nr_seq_grupo_centro_p bigint, ie_consolida_holding_p text default 'N') AS $body$
DECLARE

type campos is table of reg_campos index by integer;
type contas is table of reg_contas index by integer;

ar_conta_w			contas;
ar_orc_w			campos;
ar_real_w			campos;

cd_classif_sup_w		varchar(80);
cd_classificacao_w		varchar(80);
cd_classif_conta_w		varchar(40);
cd_classif_centro_w		varchar(40);
cd_conta_contabil_w		varchar(40);
ds_contas_w			varchar(4000);
ds_conta_contabil_w		varchar(255);
ds_cor_fonte_mes_w		varchar(255);
ds_cor_fundo_mes_w		varchar(255);
ds_formatacao_w			varchar(255);
ds_gerencial_w			varchar(255);
dt_mes_inicial_w		timestamp;
dt_mes_final_w			timestamp;
ie_gerar_w			varchar(1);
ie_conta_w			varchar(2);
ie_pos_w			bigint;
ie_tipo_centro_aux_w		varchar(1);
ie_valor_w			varchar(15);
ie_justificativa_w		varchar(1);
ie_resultado_centro_w		varchar(1);
nm_atributo_w			varchar(40);

nr_nivel_classif_w		bigint;

nr_seq_mes_ref_w		bigint;
nr_seq_metrica_w		bigint;
pr_var_01_w			double precision;
pr_var_02_w			double precision;
pr_var_03_w			double precision;
pr_var_04_w			double precision;
pr_var_05_w			double precision;
pr_var_06_w			double precision;
pr_var_07_w			double precision;
pr_var_08_w			double precision;
pr_var_09_w			double precision;
pr_var_10_w			double precision;
pr_var_11_w			double precision;
pr_var_12_w			double precision;
pr_variacao_w			double precision;
qt_meses_w			bigint;
qt_regra_w			bigint;
vl_mes_w			double precision;
vl_media_orc_w			double precision;
vl_media_real_w			double precision;
vl_total_orc_w			double precision;
vl_total_real_w			double precision;
vl_variacao_01_w		double precision;
vl_variacao_02_w		double precision;
vl_variacao_03_w		double precision;
vl_variacao_04_w		double precision;
vl_variacao_05_w		double precision;
vl_variacao_06_w		double precision;
vl_variacao_07_w		double precision;
vl_variacao_08_w		double precision;
vl_variacao_09_w		double precision;
vl_variacao_10_w		double precision;
vl_variacao_11_w		double precision;
vl_variacao_12_w		double precision;
vl_variacao_w			double precision;
ie_consolidar_w			varchar(1);
ie_separador_centro_w		empresa.ie_sep_classif_centro%type;
ds_justificativa_w		varchar(2000);

w_ctb_orcamento_vis_w		w_ctb_orcamento_vis%rowtype;
cd_estab_logado_w		estabelecimento.cd_estabelecimento%type;
nr_sequencia_delete_w		bigint;

c00 CURSOR FOR
        SELECT	a.cd_classificacao cd_classif_centro,
		a.cd_centro_custo,
		a.ds_centro_custo,
		a.ie_tipo,
		a.cd_estabelecimento,
        b.cd_empresa,
		a.cd_classificacao cd_classif_ordem
	from	estabelecimento b,
		centro_custo a
	where	a.cd_estabelecimento	= b.cd_estabelecimento
	and	b.cd_empresa		= cd_empresa_p
	and	b.cd_estabelecimento	= coalesce(cd_estab_p, b.cd_estabelecimento)
	and	a.ie_situacao		= 'A'
	and	a.cd_centro_custo	= CASE WHEN ie_tipo_centro_aux_w='A' THEN cd_centro_custo_p  ELSE CASE WHEN ie_consolidar_w='S' THEN cd_centro_custo_p WHEN ie_consolidar_w='N' THEN a.cd_centro_custo END  END
	and	substr(ctb_obter_se_centro_usuario(a.cd_centro_custo, b.cd_empresa, nm_usuario_p),1,1) in ('S','V')
	and	a.cd_classificacao like cd_classif_centro_w||'%'
	and	coalesce(nr_seq_grupo_centro_p,0) = 0
        and	coalesce(ie_consolida_holding_p,'N') = 'N'
        
union all

        SELECT	null,
		a.cd_centro_custo,
		a.ds_centro_custo,
		a.ie_tipo,
		a.cd_estabelecimento,
        b.cd_empresa,
		a.cd_classificacao cd_classif_ordem
	from	estabelecimento b,
		centro_custo a
	where	a.cd_estabelecimento	= b.cd_estabelecimento
	and	b.cd_empresa		= cd_empresa_p
	and	b.cd_estabelecimento	= coalesce(cd_estab_p, b.cd_estabelecimento)
	and	a.ie_situacao		= 'A'
	and	substr(ctb_obter_se_centro_usuario(a.cd_centro_custo, b.cd_empresa, nm_usuario_p),1,1) in ('S','V')
	and	coalesce(nr_seq_grupo_centro_p,0) <> 0
	and	exists (select	1
			from	ctb_cen_centro_grupo x
			where	a.cd_centro_custo = x.cd_centro_custo
			and 	x.nr_seq_grupo = nr_seq_grupo_centro_p)
        and	coalesce(ie_consolida_holding_p,'N') = 'N'
        
union all

	select	a.cd_classificacao cd_classif_centro,
		a.cd_centro_custo,
		a.ds_centro_custo,
		a.ie_tipo,
		a.cd_estabelecimento,
                b.cd_empresa,
		a.cd_classificacao cd_classif_ordem
	from	estabelecimento b,
		centro_custo a,
                empresa e
	where	a.cd_estabelecimento	= b.cd_estabelecimento
	and	b.cd_empresa	        = e.cd_empresa
	and	a.ie_situacao		= 'A'
        and	a.cd_centro_custo	= CASE WHEN ie_tipo_centro_aux_w='A' THEN cd_centro_custo_p  ELSE CASE WHEN ie_consolidar_w='S' THEN coalesce(cd_centro_custo_p,a.cd_centro_custo) WHEN ie_consolidar_w='N' THEN a.cd_centro_custo END  END 
	and	substr(ctb_obter_se_centro_usuario(a.cd_centro_custo, b.cd_empresa, nm_usuario_p),1,1) in ('S','V')
	and	a.cd_classificacao like cd_classif_centro_w||'%'
	and	coalesce(nr_seq_grupo_centro_p,0) = 0
        and	coalesce(ie_consolida_holding_p,'N') = 'S'
        and	exists (	select	1
			from	grupo_empresa y,
				grupo_emp_estrutura x
			where	y.nr_sequencia	= x.nr_seq_grupo
			and	x.cd_empresa	= e.cd_empresa
			and	y.nr_sequencia	= holding_pck.get_grupo_emp_estrut_vigente(cd_empresa_p))
        
union all

        select	null,
		a.cd_centro_custo,
		a.ds_centro_custo,
		a.ie_tipo,
		a.cd_estabelecimento,
                b.cd_empresa,
		a.cd_classificacao cd_classif_ordem
	from	estabelecimento b,
		centro_custo a,
                empresa e
	where	a.cd_estabelecimento	= b.cd_estabelecimento
	and	b.cd_empresa		= e.cd_empresa
	and	a.ie_situacao		= 'A'
	and	substr(ctb_obter_se_centro_usuario(a.cd_centro_custo, b.cd_empresa, nm_usuario_p),1,1) in ('S','V')
	and	coalesce(nr_seq_grupo_centro_p,0) <> 0
	and	exists (select	1
			from	ctb_cen_centro_grupo x
			where	a.cd_centro_custo = x.cd_centro_custo
			and 	x.nr_seq_grupo = nr_seq_grupo_centro_p)
        and	coalesce(ie_consolida_holding_p,'N') = 'S'
        and	exists (	select	1
			from	grupo_empresa y,
				grupo_emp_estrutura x
			where	y.nr_sequencia	= x.nr_seq_grupo
			and	x.cd_empresa	= e.cd_empresa
			and	y.nr_sequencia	= holding_pck.get_grupo_emp_estrut_vigente(cd_empresa_p))
order by
	cd_classif_ordem desc;

c00_w				c00%rowtype;

c01 CURSOR FOR
	SELECT	row_number() OVER () AS nr_linha,
		ie_union,
		nr_sequencia,
		nr_seq_apres,
		ds_estrutura,
		ie_origem_valor,
		qt_deslocamento,
		ie_negrito,
		ie_italico,
		ie_sublinhado,
        ds_cor_html5,
		ds_cor_fonte,
		ds_cor_fundo,
		nr_seq_calc,
		ie_calc_resultado
	from (SELECT	1 ie_union,
			a.nr_sequencia,
			a.nr_seq_apres,
			a.ds_estrutura,
			a.ie_origem_valor,
			a.qt_deslocamento,
			coalesce(a.ie_negrito,'N') ie_negrito,
			coalesce(a.ie_italico,'N') ie_italico,
			coalesce(a.ie_sublinhado,'N') ie_sublinhado,
            coalesce(a.ds_cor_html5,'#000000') ds_cor_html5,
			coalesce(a.ds_cor_fonte,'clNavy') ds_cor_fonte,
			coalesce(a.ds_cor_fundo,'clWhite') ds_cor_fundo,
			coalesce(a.nr_seq_calc, 0) nr_seq_calc,
			coalesce(a.ie_calc_resultado,'R') ie_calc_resultado
		from	ctb_tipo_estrutura_orc b,
			ctb_estrutura_orc a
		where	b.nr_sequencia	= a.nr_seq_tipo
		and	b.nr_sequencia	= nr_seq_tipo_estrutura_p
		and	a.ie_origem_valor = 'C'
		
union all

		select	2 ie_union,
			a.nr_sequencia,
			a.nr_seq_apres,
			a.ds_estrutura,
			a.ie_origem_valor,
			a.qt_deslocamento,
			coalesce(a.ie_negrito,'N') ie_negrito,
			coalesce(a.ie_italico,'N') ie_italico,
			coalesce(a.ie_sublinhado,'N') ie_sublinhado,
            coalesce(a.ds_cor_html5,'#000000') ds_cor_html5,
			coalesce(a.ds_cor_fonte,'clNavy') ds_cor_fonte,
			coalesce(a.ds_cor_fundo,'clWhite') ds_cor_fundo,
			coalesce(a.nr_seq_calc, 0) nr_seq_calc,
			coalesce(a.ie_calc_resultado,'R') ie_calc_resultado
		from	ctb_tipo_estrutura_orc b,
			ctb_estrutura_orc a
		where	b.nr_sequencia	= a.nr_seq_tipo
		and	b.nr_sequencia	= nr_seq_tipo_estrutura_p
		and	a.ie_origem_valor in ('E','M','TM','FR')
		order by
			ie_union,
			nr_seq_calc,
			nr_seq_apres desc
	) alias17
	where	((c00_w.ie_tipo <> 'T') or (ie_origem_valor in ('E', 'C', 'FR')));

c01_w		c01%rowtype;

c02 CURSOR FOR
	SELECT	row_number() OVER () AS nr_linha,
		nr_seq_mes_ref,
		dt_referencia
	from (SELECT	a.nr_sequencia nr_seq_mes_ref,
			a.dt_referencia
		from	ctb_mes_ref a
		where	a.cd_empresa = c00_w.cd_empresa
		and	a.dt_referencia between dt_mes_inicial_w and dt_mes_final_w
		order by
			a.dt_referencia) alias0;

c02_w		c02%rowtype;

BEGIN

/* Separador contabil, normalmente ponto (.)  */

ie_separador_centro_w := philips_contabil_pck.get_separador_centro;

cd_estab_logado_w := coalesce(cd_estab_p, wheb_usuario_pck.get_cd_estabelecimento);


select	max(cd_classificacao),
	max(ie_tipo)
into STRICT	cd_classif_centro_w,
	ie_tipo_centro_aux_w
from	centro_custo
where	cd_centro_custo	= cd_centro_custo_p;

select	coalesce(max(ie_resultado_centro), 'S')
into STRICT	ie_resultado_centro_w
from	ctb_tipo_estrutura_orc
where	nr_sequencia	= nr_seq_tipo_estrutura_p;

dt_mes_inicial_w	:= ctb_obter_mes_ref(nr_seq_mes_inicial_p);
dt_mes_final_w		:= ctb_obter_mes_ref(nr_seq_mes_final_p);

if (ie_tipo_valor_p = 0) then
	ie_valor_w	:= 'O';
elsif (ie_tipo_valor_p = 1) then
	ie_valor_w	:= 'R';
else
	ie_valor_w	:= 'RO';
end if;

qt_meses_w		:= trunc(coalesce(months_between(dt_mes_final_w, dt_mes_inicial_w),1)) + 1;

ie_consolidar_w		:= coalesce(ie_consolidar_p,'N');

/* CURSOR DE CENTROS */

open c00;
loop
fetch c00 into
	c00_w;
EXIT WHEN NOT FOUND; /* apply on c00 */
	begin
	ie_gerar_w := 'S';

	if (coalesce(nr_seq_cenario_p::text, '') = '') then
		begin
		select	coalesce(max('S'),'N')
		into STRICT	ie_gerar_w
		
		where exists (	SELECT	1
				from	centro_custo z,
					ctb_mes_ref y,
					ctb_orcamento x
				where	x.nr_seq_mes_ref	= y.nr_sequencia
				and	x.cd_centro_custo	= z.cd_centro_custo
				and	x.cd_estabelecimento	= c00_w.cd_estabelecimento
				and	y.dt_referencia between dt_mes_inicial_w and dt_mes_final_w
				and	z.cd_classificacao like c00_w.cd_classif_centro||'%'
				 LIMIT 1);
		end;
	else
		begin
		select	coalesce(max('S'),'N')
		into STRICT	ie_gerar_w
		
		where exists (	SELECT	1
				from	centro_custo z,
					ctb_mes_ref y,
					ctb_orc_cen_valor x
				where	x.nr_seq_mes_ref	= y.nr_sequencia
				and	x.cd_centro_custo	= z.cd_centro_custo
				and	x.cd_estabelecimento	= c00_w.cd_estabelecimento
				and	x.nr_seq_cenario	= nr_seq_cenario_p
				and	y.dt_referencia between dt_mes_inicial_w and dt_mes_final_w
				and	z.cd_classificacao like c00_w.cd_classif_centro||'%'
				 LIMIT 1);
		end;
	end if;

	if (ie_gerar_w = 'S') then
		begin
		if (ie_resultado_centro_w = 'S') then
			begin

			ds_gerencial_w		:= c00_w.ds_centro_custo;
-- @#@# 			ds_gerencial_w		:= substr(lpad(' ',  (nr_nivel_w *2)) || ds_centro_custo_w, 1, 255);
			ds_justificativa_w	:= substr(ctb_obter_justi_orc_periodo(c00_w.cd_empresa, c00_w.cd_centro_custo, cd_conta_contabil_p, dt_mes_inicial_w, dt_mes_final_w),1,255);

			w_ctb_orcamento_vis_w := null;

			select	nextval('w_ctb_orcamento_vis_seq')
			into STRICT	w_ctb_orcamento_vis_w.nr_sequencia
			;

			w_ctb_orcamento_vis_w.dt_atualizacao		:= clock_timestamp();
			w_ctb_orcamento_vis_w.nm_usuario		:= nm_usuario_p;
			w_ctb_orcamento_vis_w.dt_atualizacao_nrec	:= clock_timestamp();
			w_ctb_orcamento_vis_w.nm_usuario_nrec		:= nm_usuario_p;
			w_ctb_orcamento_vis_w.cd_centro_custo		:= c00_w.cd_centro_custo;
			w_ctb_orcamento_vis_w.cd_classificacao		:= case when coalesce(nr_seq_grupo_centro_p,0) = 0 then c00_w.cd_classif_centro else null end;
			w_ctb_orcamento_vis_w.ds_gerencial		:= ds_gerencial_w;
			w_ctb_orcamento_vis_w.cd_estabelecimento	:= c00_w.cd_estabelecimento;
			w_ctb_orcamento_vis_w.ds_justificativa		:= ds_justificativa_w;

			insert into w_ctb_orcamento_vis values (w_ctb_orcamento_vis_w.*);
			end;
		end if;


		open c01;
		loop
		fetch c01 into
			c01_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin
			vl_total_orc_w		:= 0;
			vl_media_orc_w		:= 0;
			vl_total_real_w		:= 0;
			vl_media_real_w		:= 0;
			vl_variacao_w		:= 0;
			pr_variacao_w		:= 0;
			ds_contas_w		:= null;
			nm_atributo_w		:= null;
			nr_seq_metrica_w	:= null;
			ar_conta_w.delete;
			ds_formatacao_w		:= c01_w.ie_negrito || c01_w.ie_italico || c01_w.ie_sublinhado;

			/* Inicializa vetores */

			for j in 1..12 loop
				begin
				ar_orc_w[j].vl_mes	:= 0;
				ar_real_w[j].vl_mes	:= 0;
				end;
			end loop;

			/* Se a origem for do tipo Contas contabeis, percorre todas as contas separadas por virgula e sem espaco */

			if (c01_w.ie_origem_valor = 'C') then
				begin
				/* Calcula a formula de contas contabeis*/

				ds_contas_w	:= substr(ctb_obter_contas_estrut_orc(	null, /* Estabelecimento */
											null, /* Centro */
											c01_w.nr_sequencia),1,4000);
				while(coalesce(ds_contas_w,'X') <> 'X') loop
					begin
					/* Primeira posicao da virgula */

					ie_pos_w := coalesce(position(',' in ds_contas_w),0);

					/* Se tiver virgula pega o numero da conta ate a virgula */

					if (ie_pos_w > 0) then
						begin
						cd_conta_contabil_w	:= substr(ds_contas_w,1,ie_pos_w - 1);
						ds_contas_w		:= substr(ds_contas_w,ie_pos_w + 1, 4000);
						end;
					else /* Na ultima conta limpa a variavel que contem a lista de conta */
						begin
						cd_conta_contabil_w	:= ds_contas_w;
						ds_contas_w		:= '';
						end;
					end if;

					begin
						/* Buscar a conta contabil e descricao da conta */

						select	cd_conta_contabil,
							ds_conta_contabil
						into STRICT	cd_conta_contabil_w,
							ds_conta_contabil_w
						from	conta_contabil
						where	cd_conta_contabil	= cd_conta_contabil_w;
					exception
					when others then
						cd_conta_contabil_w := 'X';
						ds_conta_contabil_w := 'X';
					end;

					/* Se encontrou a conta carrega no vetor*/

					if (coalesce(cd_conta_contabil_w,'X') <> 'X') then
						begin
						ar_conta_w[ar_conta_w.count+1].cd_conta := cd_conta_contabil_w;
						ar_conta_w[ar_conta_w.count].ds_conta := ds_conta_contabil_w;
						end;
					end if;

					end;
				end loop;
				end;
			end if;

			open c02;
			loop
			fetch c02 into
				c02_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				begin
				nm_atributo_w	:= '';

				if (c01_w.ie_origem_valor = 'M') and (coalesce(nr_seq_metrica_w::text, '') = '') then
					begin
					/* Se a origem do valor for metrica busca a descricao da metrica */

					if (coalesce(nr_seq_cenario_p::text, '') = '') then
						begin
						select	max(a.nr_seq_metrica)
						into STRICT	nr_seq_metrica_w
						from	ctb_metrica b,
							ctb_metrica_real a
						where	a.nr_seq_metrica		= b.nr_sequencia
						and	a.nr_seq_mes_ref		= nr_seq_mes_ref_w
						and	a.cd_centro_custo		= cd_centro_custo_p
						and	b.ie_calculo_metrica_real	<> 'I';
						end;
					else
						begin
						select	max(a.nr_seq_metrica)
						into STRICT	nr_seq_metrica_w
						from	centro_custo b,
							ctb_orc_cen_valor a
						where	a.cd_centro_custo	= b.cd_centro_custo
						and	a.cd_centro_custo	= cd_centro_custo_p
						and	a.nr_seq_mes_ref	= nr_seq_mes_ref_w
						and	a.nr_seq_cenario	= nr_seq_cenario_p;
						end;
					end if;

					if (coalesce(nr_seq_metrica_w,0) <> 0) then
						begin
						select	max(ds_metrica)
						into STRICT	c01_w.ds_estrutura
						from	ctb_metrica
						where	nr_sequencia	= nr_seq_metrica_w
						and	cd_empresa	= c00_w.cd_empresa;
						end;
					end if;

					end;

				end if;

				/* Valor Orcado */

				if (position('O' in ie_valor_w) > 0) then
					begin
					/* E= Somatorio das estruturas | FR = Function com rubricas como variaveis*/

					if (c01_w.ie_origem_valor in ('E','FR')) then
						nm_atributo_w	:= 'VL_ORC_' || trim(both to_char(c02_w.nr_linha,'09'));
					end if;

					vl_mes_w	:= ctb_obter_valor_estrut_orc(
										cd_estab_p,
										c00_w.cd_centro_custo,
										c01_w.nr_sequencia,
										c02_w.nr_seq_mes_ref,
										nr_seq_cenario_p,
										'O',
										nm_atributo_w,
										nm_usuario_p);
					ar_orc_w[c02_w.nr_linha].vl_mes	:= coalesce(vl_mes_w,0);
					end;
				end if;

				if (position('R' in ie_valor_w) > 0) then
					begin
					nm_atributo_w	:= '';
					/* E= Somatorio das estruturas | FR = Function com rubricas como variaveis*/

					if (c01_w.ie_origem_valor in ('E','FR')) then
						begin
						nm_atributo_w	:= 'VL_REAL_' || trim(both to_char(c02_w.nr_linha,'09'));
						end;
					end if;

					vl_mes_w	:= ctb_obter_valor_estrut_orc(
										cd_estab_p,
										c00_w.cd_centro_custo,
										c01_w.nr_sequencia,
										c02_w.nr_seq_mes_ref,
										null,
										'R',
										nm_atributo_w,
										nm_usuario_p);

					ar_real_w[c02_w.nr_linha].vl_mes	:= coalesce(vl_mes_w,0);
					end;
				end if;

				end;
			end loop;
			close c02;

			ds_gerencial_w		:= substr(lpad(' ', coalesce(c01_w.qt_deslocamento, 0) * 2) || c01_w.ds_estrutura,1,255);
			cd_classificacao_w	:= case when coalesce(nr_seq_grupo_centro_p,0) = 0 then c00_w.cd_classif_centro || ie_separador_centro_w else null end
						|| substr(trim(both to_char(c01_w.nr_seq_apres,'009')),1,80);
			/* Calcular percentual de variacao */

			pr_var_01_w		:= dividir_sem_round(((ar_real_w[1].vl_mes - ar_orc_w[1].vl_mes) *100), ar_orc_w[1].vl_mes);
			pr_var_02_w		:= dividir_sem_round(((ar_real_w[2].vl_mes - ar_orc_w[2].vl_mes) *100), ar_orc_w[2].vl_mes);
			pr_var_03_w		:= dividir_sem_round(((ar_real_w[3].vl_mes - ar_orc_w[3].vl_mes) *100), ar_orc_w[3].vl_mes);
			pr_var_04_w		:= dividir_sem_round(((ar_real_w[4].vl_mes - ar_orc_w[4].vl_mes) *100), ar_orc_w[4].vl_mes);
			pr_var_05_w		:= dividir_sem_round(((ar_real_w[5].vl_mes - ar_orc_w[5].vl_mes) *100), ar_orc_w[5].vl_mes);
			pr_var_06_w		:= dividir_sem_round(((ar_real_w[6].vl_mes - ar_orc_w[6].vl_mes) *100), ar_orc_w[6].vl_mes);
			pr_var_07_w		:= dividir_sem_round(((ar_real_w[7].vl_mes - ar_orc_w[7].vl_mes) *100), ar_orc_w[7].vl_mes);
			pr_var_08_w		:= dividir_sem_round(((ar_real_w[8].vl_mes - ar_orc_w[8].vl_mes) *100), ar_orc_w[8].vl_mes);
			pr_var_09_w		:= dividir_sem_round(((ar_real_w[9].vl_mes - ar_orc_w[9].vl_mes) *100), ar_orc_w[9].vl_mes);
			pr_var_10_w		:= dividir_sem_round(((ar_real_w[10].vl_mes - ar_orc_w[10].vl_mes) *100), ar_orc_w[10].vl_mes);
			pr_var_11_w		:= dividir_sem_round(((ar_real_w[11].vl_mes - ar_orc_w[11].vl_mes) *100), ar_orc_w[11].vl_mes);
			pr_var_12_w		:= dividir_sem_round(((ar_real_w[12].vl_mes - ar_orc_w[12].vl_mes) *100), ar_orc_w[12].vl_mes);

			/* Calcular variacao */

			vl_variacao_01_w		:= (ar_real_w[1].vl_mes - ar_orc_w[1].vl_mes);
			vl_variacao_02_w		:= (ar_real_w[2].vl_mes - ar_orc_w[2].vl_mes);
			vl_variacao_03_w		:= (ar_real_w[3].vl_mes - ar_orc_w[3].vl_mes);
			vl_variacao_04_w		:= (ar_real_w[4].vl_mes - ar_orc_w[4].vl_mes);
			vl_variacao_05_w		:= (ar_real_w[5].vl_mes - ar_orc_w[5].vl_mes);
			vl_variacao_06_w		:= (ar_real_w[6].vl_mes - ar_orc_w[6].vl_mes);
			vl_variacao_07_w		:= (ar_real_w[7].vl_mes - ar_orc_w[7].vl_mes);
			vl_variacao_08_w		:= (ar_real_w[8].vl_mes - ar_orc_w[8].vl_mes);
			vl_variacao_09_w		:= (ar_real_w[9].vl_mes - ar_orc_w[9].vl_mes);
			vl_variacao_10_w		:= (ar_real_w[10].vl_mes - ar_orc_w[10].vl_mes);
			vl_variacao_11_w		:= (ar_real_w[11].vl_mes - ar_orc_w[11].vl_mes);
			vl_variacao_12_w		:= (ar_real_w[12].vl_mes - ar_orc_w[12].vl_mes);

			/* Valor Orcado */

			if (ie_tipo_valor_p = 0) then
				begin
				vl_total_orc_w	:= ar_orc_w[1].vl_mes + ar_orc_w[2].vl_mes + ar_orc_w[3].vl_mes +
						   ar_orc_w[4].vl_mes + ar_orc_w[5].vl_mes + ar_orc_w[6].vl_mes +
						   ar_orc_w[7].vl_mes + ar_orc_w[8].vl_mes + ar_orc_w[9].vl_mes +
						   ar_orc_w[10].vl_mes + ar_orc_w[11].vl_mes + ar_orc_w[12].vl_mes;
				if (c01_w.ie_origem_valor = 'FR') then
					begin
					vl_total_orc_w	:= ctb_obter_valor_estrut_orc(
										cd_estab_p,
										c00_w.cd_centro_custo,
										c01_w.nr_sequencia,
										null,
										nr_seq_cenario_p,
										'O',
										'VL_TOTAL',
										nm_usuario_p);
					end;
				end if;
				vl_media_orc_w	:= dividir_sem_round(vl_total_orc_w, qt_meses_w);
				end;
			/* Valor Real */

			elsif (ie_tipo_valor_p = 1) then
				begin
				vl_total_orc_w	:= ar_real_w[1].vl_mes + ar_real_w[2].vl_mes + ar_real_w[3].vl_mes +
						   ar_real_w[4].vl_mes + ar_real_w[5].vl_mes + ar_real_w[6].vl_mes +
						   ar_real_w[7].vl_mes + ar_real_w[8].vl_mes + ar_real_w[9].vl_mes +
						   ar_real_w[10].vl_mes + ar_real_w[11].vl_mes + ar_real_w[12].vl_mes;
				/* Function com rubricas como variaveis */

				if (c01_w.ie_origem_valor = 'FR') then
					begin
					vl_total_orc_w	:= ctb_obter_valor_estrut_orc(
										cd_estab_p,
										c00_w.cd_centro_custo,
										c01_w.nr_sequencia,
										null,
										nr_seq_cenario_p,
										'R',
										'VL_TOTAL',
										nm_usuario_p);
					end;
				end if;
				vl_media_orc_w	:= dividir_sem_round(vl_total_orc_w, qt_meses_w);
				end;
			/* Orcado e Real OU Completo sem total */

			elsif (ie_tipo_valor_p in (3,4)) then
				begin
				vl_total_orc_w	:= ar_orc_w[1].vl_mes + ar_orc_w[2].vl_mes + ar_orc_w[3].vl_mes +
						   ar_orc_w[4].vl_mes + ar_orc_w[5].vl_mes + ar_orc_w[6].vl_mes +
						   ar_orc_w[7].vl_mes + ar_orc_w[8].vl_mes + ar_orc_w[9].vl_mes +
						   ar_orc_w[10].vl_mes + ar_orc_w[11].vl_mes + ar_orc_w[12].vl_mes;
				vl_media_orc_w	:= dividir_sem_round(vl_total_orc_w, qt_meses_w);

				vl_total_real_w	:= ar_real_w[1].vl_mes + ar_real_w[2].vl_mes + ar_real_w[3].vl_mes +
						   ar_real_w[4].vl_mes + ar_real_w[5].vl_mes + ar_real_w[6].vl_mes +
						   ar_real_w[7].vl_mes + ar_real_w[8].vl_mes + ar_real_w[9].vl_mes +
						   ar_real_w[10].vl_mes + ar_real_w[11].vl_mes + ar_real_w[12].vl_mes;

				if (c01_w.ie_origem_valor = 'FR') then
					begin
					vl_total_orc_w	:= ctb_obter_valor_estrut_orc(
										cd_estab_p,
										c00_w.cd_centro_custo,
										c01_w.nr_sequencia,
										null,
										nr_seq_cenario_p,
										'O',
										'VL_TOTAL',
										nm_usuario_p);

					vl_total_real_w	:= ctb_obter_valor_estrut_orc(
										cd_estab_p,
										c00_w.cd_centro_custo,
										c01_w.nr_sequencia,
										null,
										nr_seq_cenario_p,
										'R',
										'VL_TOTAL_REAL',
										nm_usuario_p);
					end;
				end if;

				vl_media_real_w	:= dividir_sem_round(vl_total_real_w, qt_meses_w);

				if (c01_w.ie_calc_resultado = 'R') then
					begin
					vl_variacao_w	:= (vl_total_real_w - vl_total_orc_w);
					pr_variacao_w	:= (dividir(vl_total_real_w - vl_total_orc_w,vl_total_orc_w) * 100);
					end;
				elsif (c01_w.ie_calc_resultado = 'D') then
					begin
					vl_variacao_w	:= (vl_total_orc_w - vl_total_real_w);
					pr_variacao_w	:= (dividir(vl_total_orc_w - vl_total_real_w,vl_total_orc_w) * 100);
					end;
				end if;

				end;
			end if;

			w_ctb_orcamento_vis_w := null;

			select	nextval('w_ctb_orcamento_vis_seq')
			into STRICT	w_ctb_orcamento_vis_w.nr_sequencia
			;

			w_ctb_orcamento_vis_w.dt_atualizacao		:= clock_timestamp();
			w_ctb_orcamento_vis_w.nm_usuario		:= nm_usuario_p;
			w_ctb_orcamento_vis_w.dt_atualizacao_nrec	:= clock_timestamp();
			w_ctb_orcamento_vis_w.nm_usuario_nrec		:= nm_usuario_p;
			w_ctb_orcamento_vis_w.cd_centro_custo		:= c00_w.cd_centro_custo;
			w_ctb_orcamento_vis_w.cd_classificacao		:= cd_classificacao_w;
			w_ctb_orcamento_vis_w.ds_gerencial		:= ds_gerencial_w;
			w_ctb_orcamento_vis_w.cd_estabelecimento	:= c00_w.cd_estabelecimento;
			w_ctb_orcamento_vis_w.ds_justificativa		:= ds_justificativa_w;
			w_ctb_orcamento_vis_w.cd_conta_contabil		:= null;
			w_ctb_orcamento_vis_w.cd_classif_conta		:= null;

			w_ctb_orcamento_vis_w.cd_classif_sup		:= null;
			w_ctb_orcamento_vis_w.nr_seq_apres		:= c01_w.nr_seq_apres;
			w_ctb_orcamento_vis_w.nr_seq_estrutura		:= c01_w.nr_sequencia;
			w_ctb_orcamento_vis_w.vl_orc_01			:= ar_orc_w[1].vl_mes;
			w_ctb_orcamento_vis_w.vl_orc_02			:= ar_orc_w[2].vl_mes;
			w_ctb_orcamento_vis_w.vl_orc_03			:= ar_orc_w[3].vl_mes;
			w_ctb_orcamento_vis_w.vl_orc_04			:= ar_orc_w[4].vl_mes;
			w_ctb_orcamento_vis_w.vl_orc_05			:= ar_orc_w[5].vl_mes;
			w_ctb_orcamento_vis_w.vl_orc_06			:= ar_orc_w[6].vl_mes;
			w_ctb_orcamento_vis_w.vl_orc_07			:= ar_orc_w[7].vl_mes;
			w_ctb_orcamento_vis_w.vl_orc_08			:= ar_orc_w[8].vl_mes;
			w_ctb_orcamento_vis_w.vl_orc_09			:= ar_orc_w[9].vl_mes;
			w_ctb_orcamento_vis_w.vl_orc_10			:= ar_orc_w[10].vl_mes;
			w_ctb_orcamento_vis_w.vl_orc_11			:= ar_orc_w[11].vl_mes;
			w_ctb_orcamento_vis_w.vl_orc_12			:= ar_orc_w[12].vl_mes;
			w_ctb_orcamento_vis_w.vl_total			:= vl_total_orc_w;
			w_ctb_orcamento_vis_w.vl_media			:= vl_media_orc_w;
			w_ctb_orcamento_vis_w.vl_real_01		:= ar_real_w[1].vl_mes;
			w_ctb_orcamento_vis_w.vl_real_02		:= ar_real_w[2].vl_mes;
			w_ctb_orcamento_vis_w.vl_real_03		:= ar_real_w[3].vl_mes;
			w_ctb_orcamento_vis_w.vl_real_04		:= ar_real_w[4].vl_mes;
			w_ctb_orcamento_vis_w.vl_real_05		:= ar_real_w[5].vl_mes;
			w_ctb_orcamento_vis_w.vl_real_06		:= ar_real_w[6].vl_mes;
			w_ctb_orcamento_vis_w.vl_real_07		:= ar_real_w[7].vl_mes;
			w_ctb_orcamento_vis_w.vl_real_08		:= ar_real_w[8].vl_mes;
			w_ctb_orcamento_vis_w.vl_real_09		:= ar_real_w[9].vl_mes;
			w_ctb_orcamento_vis_w.vl_real_10		:= ar_real_w[10].vl_mes;
			w_ctb_orcamento_vis_w.vl_real_11		:= ar_real_w[11].vl_mes;
			w_ctb_orcamento_vis_w.vl_real_12		:= ar_real_w[12].vl_mes;
			w_ctb_orcamento_vis_w.pr_var_01			:= pr_var_01_w;
			w_ctb_orcamento_vis_w.pr_var_02			:= pr_var_02_w;
			w_ctb_orcamento_vis_w.pr_var_03			:= pr_var_03_w;
			w_ctb_orcamento_vis_w.pr_var_04			:= pr_var_04_w;
			w_ctb_orcamento_vis_w.pr_var_05			:= pr_var_05_w;
			w_ctb_orcamento_vis_w.pr_var_06			:= pr_var_06_w;
			w_ctb_orcamento_vis_w.pr_var_07			:= pr_var_07_w;
			w_ctb_orcamento_vis_w.pr_var_08			:= pr_var_08_w;
			w_ctb_orcamento_vis_w.pr_var_09			:= pr_var_09_w;
			w_ctb_orcamento_vis_w.pr_var_10			:= pr_var_10_w;
			w_ctb_orcamento_vis_w.pr_var_11			:= pr_var_11_w;
			w_ctb_orcamento_vis_w.pr_var_12			:= pr_var_12_w;
			w_ctb_orcamento_vis_w.ds_formatacao		:= ds_formatacao_w;
            w_ctb_orcamento_vis_w.ds_cor_html5		:= c01_w.ds_cor_html5;
			w_ctb_orcamento_vis_w.ds_cor_fonte		:= c01_w.ds_cor_fonte;
			w_ctb_orcamento_vis_w.ds_cor_fundo		:= c01_w.ds_cor_fundo;
			w_ctb_orcamento_vis_w.vl_total_real		:= vl_total_real_w;
			w_ctb_orcamento_vis_w.vl_media_real		:= vl_media_real_w;
			w_ctb_orcamento_vis_w.vl_variacao		:= vl_variacao_w;
			w_ctb_orcamento_vis_w.pr_variacao		:= pr_variacao_w;
			w_ctb_orcamento_vis_w.vl_var_01			:= vl_variacao_01_w;
			w_ctb_orcamento_vis_w.vl_var_02			:= vl_variacao_02_w;
			w_ctb_orcamento_vis_w.vl_var_03			:= vl_variacao_03_w;
			w_ctb_orcamento_vis_w.vl_var_04			:= vl_variacao_04_w;
			w_ctb_orcamento_vis_w.vl_var_05			:= vl_variacao_05_w;
			w_ctb_orcamento_vis_w.vl_var_06			:= vl_variacao_06_w;
			w_ctb_orcamento_vis_w.vl_var_07			:= vl_variacao_07_w;
			w_ctb_orcamento_vis_w.vl_var_08			:= vl_variacao_08_w;
			w_ctb_orcamento_vis_w.vl_var_09			:= vl_variacao_09_w;
			w_ctb_orcamento_vis_w.vl_var_10			:= vl_variacao_10_w;
			w_ctb_orcamento_vis_w.vl_var_11			:= vl_variacao_11_w;
			w_ctb_orcamento_vis_w.vl_var_12			:= vl_variacao_12_w;

			insert into w_ctb_orcamento_vis values (w_ctb_orcamento_vis_w.*);

			cd_classif_sup_w	:= cd_classificacao_w;

			if (ar_conta_w.count > 0) then
				begin
				for j in 1..12 loop
					begin
					ar_orc_w[j].vl_mes	:= 0;
					ar_real_w[j].vl_mes	:= 0;
					end;
				end loop;

				for i in 1..ar_conta_w.count loop
					begin
					cd_classificacao_w	:= case when coalesce(nr_seq_grupo_centro_p,0) = 0 then c00_w.cd_classif_centro || ie_separador_centro_w else null end
								|| substr(trim(both to_char(c01_w.nr_seq_apres,'009')) ||
								ie_separador_centro_w ||
								trim(both to_char(i,'009')),1,80);

					open c02;
					loop
					fetch c02 into
						c02_w;
					EXIT WHEN NOT FOUND; /* apply on c02 */
						begin
						if (position('O' in ie_valor_w) > 0) then
							begin
							vl_mes_w	:= coalesce(ctb_obter_orc_centro_agrup(
												c00_w.cd_empresa,
												c02_w.nr_seq_mes_ref,
												cd_estab_p,
												nr_seq_cenario_p,
												c00_w.cd_centro_custo,
												ar_conta_w[i].cd_conta,
												'O'),0);
                                                                                                							ar_orc_w[c02_w.nr_linha].vl_mes		:= vl_mes_w;
							end;
						end if;

						if (position('R' in ie_valor_w) > 0) then
							begin
							vl_mes_w	:= coalesce(ctb_obter_orc_centro_agrup(
												c00_w.cd_empresa,
												c02_w.nr_seq_mes_ref,
												cd_estab_p,
												null,
												c00_w.cd_centro_custo,
												ar_conta_w[i].cd_conta,
												'R'),0);
							ar_real_w[c02_w.nr_linha].vl_mes	:= vl_mes_w;
							end;
						end if;
						end;
					end loop;
					close c02;

					ds_gerencial_w		:= substr(lpad(' ', (coalesce(c01_w.qt_deslocamento,0) + 6) * 2) ||
								ar_conta_w[i].ds_conta,1,255);

					begin
					pr_var_01_w		:= dividir_sem_round(((ar_real_w[1].vl_mes - ar_orc_w[1].vl_mes) *100), ar_orc_w[1].vl_mes);
					pr_var_02_w		:= dividir_sem_round(((ar_real_w[2].vl_mes - ar_orc_w[2].vl_mes) *100), ar_orc_w[2].vl_mes);
					pr_var_03_w		:= dividir_sem_round(((ar_real_w[3].vl_mes - ar_orc_w[3].vl_mes) *100), ar_orc_w[3].vl_mes);
					pr_var_04_w		:= dividir_sem_round(((ar_real_w[4].vl_mes - ar_orc_w[4].vl_mes) *100), ar_orc_w[4].vl_mes);
					pr_var_05_w		:= dividir_sem_round(((ar_real_w[5].vl_mes - ar_orc_w[5].vl_mes) *100), ar_orc_w[5].vl_mes);
					pr_var_06_w		:= dividir_sem_round(((ar_real_w[6].vl_mes - ar_orc_w[6].vl_mes) *100), ar_orc_w[6].vl_mes);
					pr_var_07_w		:= dividir_sem_round(((ar_real_w[7].vl_mes - ar_orc_w[7].vl_mes) *100), ar_orc_w[7].vl_mes);
					pr_var_08_w		:= dividir_sem_round(((ar_real_w[8].vl_mes - ar_orc_w[8].vl_mes) *100), ar_orc_w[8].vl_mes);
					pr_var_09_w		:= dividir_sem_round(((ar_real_w[9].vl_mes - ar_orc_w[9].vl_mes) *100), ar_orc_w[9].vl_mes);
					pr_var_10_w		:= dividir_sem_round(((ar_real_w[10].vl_mes - ar_orc_w[10].vl_mes) *100), ar_orc_w[10].vl_mes);
					pr_var_11_w		:= dividir_sem_round(((ar_real_w[11].vl_mes - ar_orc_w[11].vl_mes) *100), ar_orc_w[11].vl_mes);
					pr_var_12_w		:= dividir_sem_round(((ar_real_w[12].vl_mes - ar_orc_w[12].vl_mes) *100), ar_orc_w[12].vl_mes);
					exception when others then
						pr_var_01_w	:= 0;
					end;

					vl_variacao_01_w	:= (ar_real_w[1].vl_mes - ar_orc_w[1].vl_mes);
					vl_variacao_02_w	:= (ar_real_w[2].vl_mes - ar_orc_w[2].vl_mes);
					vl_variacao_03_w	:= (ar_real_w[3].vl_mes - ar_orc_w[3].vl_mes);
					vl_variacao_04_w	:= (ar_real_w[4].vl_mes - ar_orc_w[4].vl_mes);
					vl_variacao_05_w	:= (ar_real_w[5].vl_mes - ar_orc_w[5].vl_mes);
					vl_variacao_06_w	:= (ar_real_w[6].vl_mes - ar_orc_w[6].vl_mes);
					vl_variacao_07_w	:= (ar_real_w[7].vl_mes - ar_orc_w[7].vl_mes);
					vl_variacao_08_w	:= (ar_real_w[8].vl_mes - ar_orc_w[8].vl_mes);
					vl_variacao_09_w	:= (ar_real_w[9].vl_mes - ar_orc_w[9].vl_mes);
					vl_variacao_10_w	:= (ar_real_w[10].vl_mes - ar_orc_w[10].vl_mes);
					vl_variacao_11_w	:= (ar_real_w[11].vl_mes - ar_orc_w[11].vl_mes);
					vl_variacao_12_w	:= (ar_real_w[12].vl_mes - ar_orc_w[12].vl_mes);

					select	coalesce(max('S'), 'N')
					into STRICT	ie_justificativa_w
					from	centro_custo c,
						ctb_mes_ref b,
						ctb_orcamento a
					where	a.nr_seq_mes_ref	= b.nr_sequencia
					and	a.cd_estabelecimento	= c00_w.cd_estabelecimento
					and	a.cd_conta_contabil	= ar_conta_w[i].cd_conta
					and	a.cd_centro_custo	= c.cd_centro_custo
					and	c.cd_classificacao like c00_w.cd_classif_centro||'%'
					and	(a.ds_justificativa IS NOT NULL AND a.ds_justificativa::text <> '')
					and	b.dt_referencia	between dt_mes_inicial_w and dt_mes_final_w  LIMIT 1;

					cd_classif_conta_w	:= substr(ctb_obter_classif_conta(ar_conta_w[i].cd_conta, null, clock_timestamp()),1,40);

					/*variacao - fonte*/

					ds_cor_fonte_mes_w	:= '';
					ds_cor_fonte_mes_w	:= ds_cor_fonte_mes_w|| 'PR_VAR_01='||substr(ctb_obter_regra_cor_orcamento(cd_classif_conta_w, ar_conta_w[i].cd_conta, 'N', vl_variacao_01_w, pr_var_01_w, cd_estab_logado_w, 0),1,255);
					ds_cor_fonte_mes_w	:= ds_cor_fonte_mes_w|| 'PR_VAR_02='||substr(ctb_obter_regra_cor_orcamento(cd_classif_conta_w, ar_conta_w[i].cd_conta, 'N', vl_variacao_02_w, pr_var_02_w, cd_estab_logado_w, 0),1,255);
					ds_cor_fonte_mes_w	:= ds_cor_fonte_mes_w|| 'PR_VAR_03='||substr(ctb_obter_regra_cor_orcamento(cd_classif_conta_w, ar_conta_w[i].cd_conta, 'N', vl_variacao_03_w, pr_var_03_w, cd_estab_logado_w, 0),1,255);
					ds_cor_fonte_mes_w	:= ds_cor_fonte_mes_w|| 'PR_VAR_04='||substr(ctb_obter_regra_cor_orcamento(cd_classif_conta_w, ar_conta_w[i].cd_conta, 'N', vl_variacao_04_w, pr_var_04_w, cd_estab_logado_w, 0),1,255);
					ds_cor_fonte_mes_w	:= ds_cor_fonte_mes_w|| 'PR_VAR_05='||substr(ctb_obter_regra_cor_orcamento(cd_classif_conta_w, ar_conta_w[i].cd_conta, 'N', vl_variacao_05_w, pr_var_05_w, cd_estab_logado_w, 0),1,255);
					ds_cor_fonte_mes_w	:= ds_cor_fonte_mes_w|| 'PR_VAR_06='||substr(ctb_obter_regra_cor_orcamento(cd_classif_conta_w, ar_conta_w[i].cd_conta, 'N', vl_variacao_06_w, pr_var_06_w, cd_estab_logado_w, 0),1,255);
					ds_cor_fonte_mes_w	:= ds_cor_fonte_mes_w|| 'PR_VAR_07='||substr(ctb_obter_regra_cor_orcamento(cd_classif_conta_w, ar_conta_w[i].cd_conta, 'N', vl_variacao_07_w, pr_var_07_w, cd_estab_logado_w, 0),1,255);
					ds_cor_fonte_mes_w	:= ds_cor_fonte_mes_w|| 'PR_VAR_08='||substr(ctb_obter_regra_cor_orcamento(cd_classif_conta_w, ar_conta_w[i].cd_conta, 'N', vl_variacao_08_w, pr_var_08_w, cd_estab_logado_w, 0),1,255);
					ds_cor_fonte_mes_w	:= ds_cor_fonte_mes_w|| 'PR_VAR_09='||substr(ctb_obter_regra_cor_orcamento(cd_classif_conta_w, ar_conta_w[i].cd_conta, 'N', vl_variacao_09_w, pr_var_09_w, cd_estab_logado_w, 0),1,255);
					ds_cor_fonte_mes_w	:= ds_cor_fonte_mes_w|| 'PR_VAR_10='||substr(ctb_obter_regra_cor_orcamento(cd_classif_conta_w, ar_conta_w[i].cd_conta, 'N', vl_variacao_10_w, pr_var_10_w, cd_estab_logado_w, 0),1,255);
					ds_cor_fonte_mes_w	:= ds_cor_fonte_mes_w|| 'PR_VAR_11='||substr(ctb_obter_regra_cor_orcamento(cd_classif_conta_w, ar_conta_w[i].cd_conta, 'N', vl_variacao_11_w, pr_var_11_w, cd_estab_logado_w, 0),1,255);
					ds_cor_fonte_mes_w	:= ds_cor_fonte_mes_w|| 'PR_VAR_12='||substr(ctb_obter_regra_cor_orcamento(cd_classif_conta_w, ar_conta_w[i].cd_conta, 'N', vl_variacao_12_w, pr_var_12_w, cd_estab_logado_w, 0),1,255);

					/*variacao - fundo*/

					ds_cor_fundo_mes_w	:= '';
					ds_cor_fundo_mes_w	:= ds_cor_fundo_mes_w|| 'PR_VAR_01='||substr(ctb_obter_regra_cor_orcamento(cd_classif_conta_w, ar_conta_w[i].cd_conta, 'N', vl_variacao_01_w, pr_var_01_w, cd_estab_logado_w, 1),1,255);
					ds_cor_fundo_mes_w	:= ds_cor_fundo_mes_w|| 'PR_VAR_02='||substr(ctb_obter_regra_cor_orcamento(cd_classif_conta_w, ar_conta_w[i].cd_conta, 'N', vl_variacao_02_w, pr_var_02_w, cd_estab_logado_w, 1),1,255);
					ds_cor_fundo_mes_w	:= ds_cor_fundo_mes_w|| 'PR_VAR_03='||substr(ctb_obter_regra_cor_orcamento(cd_classif_conta_w, ar_conta_w[i].cd_conta, 'N', vl_variacao_03_w, pr_var_03_w, cd_estab_logado_w, 1),1,255);
					ds_cor_fundo_mes_w	:= ds_cor_fundo_mes_w|| 'PR_VAR_04='||substr(ctb_obter_regra_cor_orcamento(cd_classif_conta_w, ar_conta_w[i].cd_conta, 'N', vl_variacao_04_w, pr_var_04_w, cd_estab_logado_w, 1),1,255);
					ds_cor_fundo_mes_w	:= ds_cor_fundo_mes_w|| 'PR_VAR_05='||substr(ctb_obter_regra_cor_orcamento(cd_classif_conta_w, ar_conta_w[i].cd_conta, 'N', vl_variacao_05_w, pr_var_05_w, cd_estab_logado_w, 1),1,255);
					ds_cor_fundo_mes_w	:= ds_cor_fundo_mes_w|| 'PR_VAR_06='||substr(ctb_obter_regra_cor_orcamento(cd_classif_conta_w, ar_conta_w[i].cd_conta, 'N', vl_variacao_06_w, pr_var_06_w, cd_estab_logado_w, 1),1,255);
					ds_cor_fundo_mes_w	:= ds_cor_fundo_mes_w|| 'PR_VAR_07='||substr(ctb_obter_regra_cor_orcamento(cd_classif_conta_w, ar_conta_w[i].cd_conta, 'N', vl_variacao_07_w, pr_var_07_w, cd_estab_logado_w, 1),1,255);
					ds_cor_fundo_mes_w	:= ds_cor_fundo_mes_w|| 'PR_VAR_08='||substr(ctb_obter_regra_cor_orcamento(cd_classif_conta_w, ar_conta_w[i].cd_conta, 'N', vl_variacao_08_w, pr_var_08_w, cd_estab_logado_w, 1),1,255);
					ds_cor_fundo_mes_w	:= ds_cor_fundo_mes_w|| 'PR_VAR_09='||substr(ctb_obter_regra_cor_orcamento(cd_classif_conta_w, ar_conta_w[i].cd_conta, 'N', vl_variacao_09_w, pr_var_09_w, cd_estab_logado_w, 1),1,255);
					ds_cor_fundo_mes_w	:= ds_cor_fundo_mes_w|| 'PR_VAR_10='||substr(ctb_obter_regra_cor_orcamento(cd_classif_conta_w, ar_conta_w[i].cd_conta, 'N', vl_variacao_10_w, pr_var_10_w, cd_estab_logado_w, 1),1,255);
					ds_cor_fundo_mes_w	:= ds_cor_fundo_mes_w|| 'PR_VAR_11='||substr(ctb_obter_regra_cor_orcamento(cd_classif_conta_w, ar_conta_w[i].cd_conta, 'N', vl_variacao_11_w, pr_var_11_w, cd_estab_logado_w, 1),1,255);
					ds_cor_fundo_mes_w	:= ds_cor_fundo_mes_w|| 'PR_VAR_12='||substr(ctb_obter_regra_cor_orcamento(cd_classif_conta_w, ar_conta_w[i].cd_conta, 'N', vl_variacao_12_w, pr_var_12_w, cd_estab_logado_w, 1),1,255);

					if (ie_tipo_valor_p = 0) then
						begin
						vl_total_orc_w	:= ar_orc_w[1].vl_mes + ar_orc_w[2].vl_mes + ar_orc_w[3].vl_mes +
								   ar_orc_w[4].vl_mes + ar_orc_w[5].vl_mes + ar_orc_w[6].vl_mes +
								   ar_orc_w[7].vl_mes + ar_orc_w[8].vl_mes + ar_orc_w[9].vl_mes +
								   ar_orc_w[10].vl_mes + ar_orc_w[11].vl_mes + ar_orc_w[12].vl_mes;
						vl_media_orc_w	:= dividir_sem_round(vl_total_orc_w, qt_meses_w);
						end;
					elsif (ie_tipo_valor_p = 1) then
						begin
						vl_total_orc_w	:= ar_real_w[1].vl_mes + ar_real_w[2].vl_mes + ar_real_w[3].vl_mes +
								   ar_real_w[4].vl_mes + ar_real_w[5].vl_mes + ar_real_w[6].vl_mes +
								   ar_real_w[7].vl_mes + ar_real_w[8].vl_mes + ar_real_w[9].vl_mes +
								   ar_real_w[10].vl_mes + ar_real_w[11].vl_mes + ar_real_w[12].vl_mes;
						vl_media_orc_w	:= dividir_sem_round(vl_total_orc_w, qt_meses_w);
						end;
					elsif (ie_tipo_valor_p in (3,4)) then
						begin
						vl_total_orc_w	:= ar_orc_w[1].vl_mes + ar_orc_w[2].vl_mes + ar_orc_w[3].vl_mes +
								   ar_orc_w[4].vl_mes + ar_orc_w[5].vl_mes + ar_orc_w[6].vl_mes +
								   ar_orc_w[7].vl_mes + ar_orc_w[8].vl_mes + ar_orc_w[9].vl_mes +
								   ar_orc_w[10].vl_mes + ar_orc_w[11].vl_mes + ar_orc_w[12].vl_mes;
						vl_media_orc_w	:= dividir_sem_round(vl_total_orc_w, qt_meses_w);

						vl_total_real_w	:= ar_real_w[1].vl_mes + ar_real_w[2].vl_mes + ar_real_w[3].vl_mes +
								   ar_real_w[4].vl_mes + ar_real_w[5].vl_mes + ar_real_w[6].vl_mes +
								   ar_real_w[7].vl_mes + ar_real_w[8].vl_mes + ar_real_w[9].vl_mes +
								   ar_real_w[10].vl_mes + ar_real_w[11].vl_mes + ar_real_w[12].vl_mes;
						vl_media_real_w	:= dividir_sem_round(vl_total_real_w, qt_meses_w);

						if (c01_w.ie_calc_resultado = 'R') then
							vl_variacao_w	:= (vl_total_real_w - vl_total_orc_w);
							pr_variacao_w	:= (dividir(vl_total_real_w - vl_total_orc_w,vl_total_orc_w) * 100);
						elsif (c01_w.ie_calc_resultado = 'D') then
							vl_variacao_w	:= (vl_total_orc_w - vl_total_real_w);
							pr_variacao_w	:= (dividir(vl_total_orc_w - vl_total_real_w,vl_total_orc_w) * 100);
						end if;
						end;
					end if;

					ie_conta_w	:= ctb_obter_se_conta_filtro(ar_conta_w[i].cd_conta,cd_conta_contabil_p,cd_classif_conta_w);

					ds_justificativa_w	:= substr(ctb_obter_justi_orc_periodo(c00_w.cd_empresa, c00_w.cd_centro_custo, ar_conta_w[i].cd_conta, dt_mes_inicial_w, dt_mes_final_w),1,255);

					if (ie_conta_w = 'S') then
						begin
						w_ctb_orcamento_vis_w := null;

						select	nextval('w_ctb_orcamento_vis_seq')
						into STRICT	w_ctb_orcamento_vis_w.nr_sequencia
						;

						w_ctb_orcamento_vis_w.dt_atualizacao		:= clock_timestamp();
						w_ctb_orcamento_vis_w.nm_usuario		:= nm_usuario_p;
						w_ctb_orcamento_vis_w.dt_atualizacao_nrec	:= clock_timestamp();
						w_ctb_orcamento_vis_w.nm_usuario_nrec		:= nm_usuario_p;
						w_ctb_orcamento_vis_w.cd_centro_custo		:= c00_w.cd_centro_custo;
						w_ctb_orcamento_vis_w.cd_classificacao		:= cd_classificacao_w;
						w_ctb_orcamento_vis_w.ds_gerencial		:= ds_gerencial_w;
						w_ctb_orcamento_vis_w.cd_estabelecimento	:= c00_w.cd_estabelecimento;
						w_ctb_orcamento_vis_w.ds_justificativa		:= ds_justificativa_w;
						w_ctb_orcamento_vis_w.cd_conta_contabil		:= ar_conta_w[i].cd_conta;
						w_ctb_orcamento_vis_w.cd_classif_conta		:= null;
						w_ctb_orcamento_vis_w.cd_classif_sup		:= cd_classif_sup_w;

						w_ctb_orcamento_vis_w.vl_orc_01			:= ar_orc_w[1].vl_mes;
						w_ctb_orcamento_vis_w.vl_orc_02			:= ar_orc_w[2].vl_mes;
						w_ctb_orcamento_vis_w.vl_orc_03			:= ar_orc_w[3].vl_mes;
						w_ctb_orcamento_vis_w.vl_orc_04			:= ar_orc_w[4].vl_mes;
						w_ctb_orcamento_vis_w.vl_orc_05			:= ar_orc_w[5].vl_mes;
						w_ctb_orcamento_vis_w.vl_orc_06			:= ar_orc_w[6].vl_mes;
						w_ctb_orcamento_vis_w.vl_orc_07			:= ar_orc_w[7].vl_mes;
						w_ctb_orcamento_vis_w.vl_orc_08			:= ar_orc_w[8].vl_mes;
						w_ctb_orcamento_vis_w.vl_orc_09			:= ar_orc_w[9].vl_mes;
						w_ctb_orcamento_vis_w.vl_orc_10			:= ar_orc_w[10].vl_mes;
						w_ctb_orcamento_vis_w.vl_orc_11			:= ar_orc_w[11].vl_mes;
						w_ctb_orcamento_vis_w.vl_orc_12			:= ar_orc_w[12].vl_mes;
						w_ctb_orcamento_vis_w.vl_total			:= vl_total_orc_w;
						w_ctb_orcamento_vis_w.vl_media			:= vl_media_orc_w;
						w_ctb_orcamento_vis_w.vl_real_01		:= ar_real_w[1].vl_mes;
						w_ctb_orcamento_vis_w.vl_real_02		:= ar_real_w[2].vl_mes;
						w_ctb_orcamento_vis_w.vl_real_03		:= ar_real_w[3].vl_mes;
						w_ctb_orcamento_vis_w.vl_real_04		:= ar_real_w[4].vl_mes;
						w_ctb_orcamento_vis_w.vl_real_05		:= ar_real_w[5].vl_mes;
						w_ctb_orcamento_vis_w.vl_real_06		:= ar_real_w[6].vl_mes;
						w_ctb_orcamento_vis_w.vl_real_07		:= ar_real_w[7].vl_mes;
						w_ctb_orcamento_vis_w.vl_real_08		:= ar_real_w[8].vl_mes;
						w_ctb_orcamento_vis_w.vl_real_09		:= ar_real_w[9].vl_mes;
						w_ctb_orcamento_vis_w.vl_real_10		:= ar_real_w[10].vl_mes;
						w_ctb_orcamento_vis_w.vl_real_11		:= ar_real_w[11].vl_mes;
						w_ctb_orcamento_vis_w.vl_real_12		:= ar_real_w[12].vl_mes;
						w_ctb_orcamento_vis_w.pr_var_01			:= pr_var_01_w;
						w_ctb_orcamento_vis_w.pr_var_02			:= pr_var_02_w;
						w_ctb_orcamento_vis_w.pr_var_03			:= pr_var_03_w;
						w_ctb_orcamento_vis_w.pr_var_04			:= pr_var_04_w;
						w_ctb_orcamento_vis_w.pr_var_05			:= pr_var_05_w;
						w_ctb_orcamento_vis_w.pr_var_06			:= pr_var_06_w;
						w_ctb_orcamento_vis_w.pr_var_07			:= pr_var_07_w;
						w_ctb_orcamento_vis_w.pr_var_08			:= pr_var_08_w;
						w_ctb_orcamento_vis_w.pr_var_09			:= pr_var_09_w;
						w_ctb_orcamento_vis_w.pr_var_10			:= pr_var_10_w;
						w_ctb_orcamento_vis_w.pr_var_11			:= pr_var_11_w;
						w_ctb_orcamento_vis_w.pr_var_12			:= pr_var_12_w;
						w_ctb_orcamento_vis_w.ie_justificativa		:= ie_justificativa_w;
						w_ctb_orcamento_vis_w.ds_cor_fundo		:= ds_cor_fundo_mes_w;
						w_ctb_orcamento_vis_w.ds_cor_fonte		:= ds_cor_fonte_mes_w;
						w_ctb_orcamento_vis_w.nr_seq_apres		:= c01_w.nr_seq_apres;
						w_ctb_orcamento_vis_w.vl_total_real		:= vl_total_real_w;
						w_ctb_orcamento_vis_w.vl_media_real		:= vl_media_real_w;
						w_ctb_orcamento_vis_w.vl_variacao		:= vl_variacao_w;
						w_ctb_orcamento_vis_w.pr_variacao		:= pr_variacao_w;
						w_ctb_orcamento_vis_w.vl_var_01			:= vl_variacao_01_w;
						w_ctb_orcamento_vis_w.vl_var_02			:= vl_variacao_02_w;
						w_ctb_orcamento_vis_w.vl_var_03			:= vl_variacao_03_w;
						w_ctb_orcamento_vis_w.vl_var_04			:= vl_variacao_04_w;
						w_ctb_orcamento_vis_w.vl_var_05			:= vl_variacao_05_w;
						w_ctb_orcamento_vis_w.vl_var_06			:= vl_variacao_06_w;
						w_ctb_orcamento_vis_w.vl_var_07			:= vl_variacao_07_w;
						w_ctb_orcamento_vis_w.vl_var_08			:= vl_variacao_08_w;
						w_ctb_orcamento_vis_w.vl_var_09			:= vl_variacao_09_w;
						w_ctb_orcamento_vis_w.vl_var_10			:= vl_variacao_10_w;
						w_ctb_orcamento_vis_w.vl_var_11			:= vl_variacao_11_w;
						w_ctb_orcamento_vis_w.vl_var_12			:= vl_variacao_12_w;

						insert into w_ctb_orcamento_vis values (w_ctb_orcamento_vis_w.*);
						end;
					end if;
					commit;
					end;
				end loop;
				end;
			end if;
			end;
		end loop;
		close c01;

		/*Acumular o saldo dos centros */

		CALL ctb_acumular_saldo_centro(
				c00_w.cd_centro_custo,
				c00_w.cd_classif_centro,
				qt_meses_w,
				ie_tipo_valor_p,
				'A',
				nm_usuario_p);

		end;
	end if;

	end;
end loop;
close c00;

commit;

/* Agrupar informacoes por conta contabil - SEM CENTRO DE CUSTO */

if (coalesce(nr_seq_grupo_centro_p,0) <> 0) then
	begin

	select	nextval('w_ctb_orcamento_vis_seq')
	into STRICT	nr_sequencia_delete_w
	;

	insert into w_ctb_orcamento_vis(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_centro_custo,
		cd_classificacao,
		ds_gerencial,
		cd_estabelecimento,
		ds_justificativa,
		cd_conta_contabil,
		cd_classif_conta,
		cd_classif_sup,
		ie_justificativa,
		ds_cor_fundo,
		ds_cor_fonte,
        ds_cor_html5,
		ds_formatacao,
		nr_seq_apres,
		vl_total_real,
		vl_media_real,
		vl_variacao,
		pr_variacao,
		vl_total,
		vl_media,
		vl_orc_01,
		vl_orc_02,
		vl_orc_03,
		vl_orc_04,
		vl_orc_05,
		vl_orc_06,
		vl_orc_07,
		vl_orc_08,
		vl_orc_09,
		vl_orc_10,
		vl_orc_11,
		vl_orc_12,
		vl_real_01,
		vl_real_02,
		vl_real_03,
		vl_real_04,
		vl_real_05,
		vl_real_06,
		vl_real_07,
		vl_real_08,
		vl_real_09,
		vl_real_10,
		vl_real_11,
		vl_real_12,
		pr_var_01,
		pr_var_02,
		pr_var_03,
		pr_var_04,
		pr_var_05,
		pr_var_06,
		pr_var_07,
		pr_var_08,
		pr_var_09,
		pr_var_10,
		pr_var_11,
		pr_var_12,
		vl_var_01,
		vl_var_02,
		vl_var_03,
		vl_var_04,
		vl_var_05,
		vl_var_06,
		vl_var_07,
		vl_var_08,
		vl_var_09,
		vl_var_10,
		vl_var_11,
		vl_var_12,
		nr_seq_estrutura
		)
	SELECT	nextval('w_ctb_orcamento_vis_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		null, /* CD_CENTRO_CUSTO */
		cd_classificacao,
		ds_gerencial,
		cd_estab_logado_w,
		null, /* DS_JUSTIFICATIVA */
		cd_conta_contabil,
		cd_classif_conta,
		null, /* CD_CLASSIF_SUP */
		null, /* IE_JUSTIFICATIVA */
		ds_cor_fundo,
		ds_cor_fonte,
        ds_cor_html5,
		ds_formatacao,
		nr_seq_apres,
		vl_total_real,
		vl_media_real,
		(vl_total_real - vl_total) vl_variacao,
		dividir_sem_round(((vl_total_real - vl_total) *100), vl_total) pr_variacao,
		vl_total, /* TOTAL_ORCADO */
		vl_media, /* MEDIA_ORCADO */
		vl_orc_01,
		vl_orc_02,
		vl_orc_03,
		vl_orc_04,
		vl_orc_05,
		vl_orc_06,
		vl_orc_07,
		vl_orc_08,
		vl_orc_09,
		vl_orc_10,
		vl_orc_11,
		vl_orc_12,
		vl_real_01,
		vl_real_02,
		vl_real_03,
		vl_real_04,
		vl_real_05,
		vl_real_06,
		vl_real_07,
		vl_real_08,
		vl_real_09,
		vl_real_10,
		vl_real_11,
		vl_real_12,
		dividir_sem_round(((vl_real_01 - vl_orc_01) *100), vl_orc_01) pr_var_01,
		dividir_sem_round(((vl_real_02 - vl_orc_02) *100), vl_orc_02) pr_var_02,
		dividir_sem_round(((vl_real_03 - vl_orc_03) *100), vl_orc_03) pr_var_03,
		dividir_sem_round(((vl_real_04 - vl_orc_04) *100), vl_orc_04) pr_var_04,
		dividir_sem_round(((vl_real_05 - vl_orc_05) *100), vl_orc_05) pr_var_05,
		dividir_sem_round(((vl_real_06 - vl_orc_06) *100), vl_orc_06) pr_var_06,
		dividir_sem_round(((vl_real_07 - vl_orc_07) *100), vl_orc_07) pr_var_07,
		dividir_sem_round(((vl_real_08 - vl_orc_08) *100), vl_orc_08) pr_var_08,
		dividir_sem_round(((vl_real_09 - vl_orc_09) *100), vl_orc_09) pr_var_09,
		dividir_sem_round(((vl_real_10 - vl_orc_10) *100), vl_orc_10) pr_var_10,
		dividir_sem_round(((vl_real_11 - vl_orc_11) *100), vl_orc_11) pr_var_11,
		dividir_sem_round(((vl_real_12 - vl_orc_12) *100), vl_orc_12) pr_var_12,
		(vl_real_01 - vl_orc_01) vl_var_01,
		(vl_real_02 - vl_orc_02) vl_var_02,
		(vl_real_03 - vl_orc_03) vl_var_03,
		(vl_real_04 - vl_orc_04) vl_var_04,
		(vl_real_05 - vl_orc_05) vl_var_05,
		(vl_real_06 - vl_orc_06) vl_var_06,
		(vl_real_07 - vl_orc_07) vl_var_07,
		(vl_real_08 - vl_orc_08) vl_var_08,
		(vl_real_09 - vl_orc_09) vl_var_09,
		(vl_real_10 - vl_orc_10) vl_var_10,
		(vl_real_11 - vl_orc_11) vl_var_11,
		(vl_real_12 - vl_orc_12) vl_var_12,
		nr_seq_estrutura
	from (SELECT	cd_classificacao,
			ds_gerencial,
			cd_conta_contabil,
			cd_classif_conta,
			max(ds_cor_fundo) ds_cor_fundo,
			max(ds_cor_fonte) ds_cor_fonte,
            max(ds_cor_html5) ds_cor_html5,
			max(ds_formatacao) ds_formatacao,
			max(nr_seq_apres) nr_seq_apres,
			sum(vl_total_real) vl_total_real,
			sum(vl_media_real) vl_media_real,
			sum(vl_total) vl_total,
			sum(vl_media) vl_media,
			sum(vl_orc_01) vl_orc_01,
			sum(vl_orc_02) vl_orc_02,
			sum(vl_orc_03) vl_orc_03,
			sum(vl_orc_04) vl_orc_04,
			sum(vl_orc_05) vl_orc_05,
			sum(vl_orc_06) vl_orc_06,
			sum(vl_orc_07) vl_orc_07,
			sum(vl_orc_08) vl_orc_08,
			sum(vl_orc_09) vl_orc_09,
			sum(vl_orc_10) vl_orc_10,
			sum(vl_orc_11) vl_orc_11,
			sum(vl_orc_12) vl_orc_12,
			sum(vl_real_01) vl_real_01,
			sum(vl_real_02) vl_real_02,
			sum(vl_real_03) vl_real_03,
			sum(vl_real_04) vl_real_04,
			sum(vl_real_05) vl_real_05,
			sum(vl_real_06) vl_real_06,
			sum(vl_real_07) vl_real_07,
			sum(vl_real_08) vl_real_08,
			sum(vl_real_09) vl_real_09,
			sum(vl_real_10) vl_real_10,
			sum(vl_real_11) vl_real_11,
			sum(vl_real_12) vl_real_12,
			nr_seq_estrutura
		from	w_ctb_orcamento_vis
		where	(cd_classificacao IS NOT NULL AND cd_classificacao::text <> '')
		and	nm_usuario = nm_usuario_p
		group by
			cd_classificacao,
			ds_gerencial,
			cd_conta_contabil,
			cd_classif_conta,
			nr_seq_estrutura) x;

	delete	from w_ctb_orcamento_vis
	where	nr_sequencia < nr_sequencia_delete_w
	and	nm_usuario = nm_usuario_p;

	commit;
	end;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_acomp_dre ( cd_empresa_p bigint, cd_estab_p bigint, cd_centro_custo_p bigint, ie_tipo_visual_p bigint, ie_tipo_valor_p bigint, nr_seq_mes_inicial_p bigint, nr_seq_mes_final_p bigint, nr_seq_tipo_estrutura_p bigint, nr_seq_cenario_p bigint, ie_consolidar_p text, nm_usuario_p text, cd_conta_contabil_p text, nr_seq_grupo_centro_p bigint, ie_consolida_holding_p text default 'N') FROM PUBLIC;

