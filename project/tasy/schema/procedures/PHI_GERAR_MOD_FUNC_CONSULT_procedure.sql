-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE phi_gerar_mod_func_consult ( nr_seq_consultor_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_con_gest_mod_w	bigint;
qr_modulos_consultor_w	bigint;

/**
* Find all the inative functions that had been inserted for the consultant
*/
c01 CURSOR FOR
	SELECT
		ccgcf.nr_sequencia nr_seq_con_gest_fun
	from
		funcao f,
		com_cons_gest_con_fun ccgcf,
		com_cons_gest_con_mod ccgcm
	where
		f.cd_funcao = ccgcf.cd_funcao
	and	ccgcf.nr_seq_conhecimento = ccgcm.nr_sequencia
	and	obter_dados_modulo_implantacao(ccgcm.nr_seq_mod_impl, 'S') <> 'A'
	and	(	(f.ie_situacao = 'W')
		or (f.ds_aplicacao in ('TasySis', 'TasyRel'))
		or (f.cd_funcao < 0)
		)
	and	ccgcm.nr_seq_consultor = nr_seq_consultor_p;

/**
* Find all the functions from the system that are not inserted for the consultor
*/
c02 CURSOR FOR
	SELECT	cd_funcao,
		nr_seq_mod_impl
	from	funcao f
	where	f.ie_situacao not in ('I', 'W')
	and	f.ds_aplicacao not in ('TasySis', 'TasyRel')
	and	f.cd_funcao > 0
	and	(f.nr_seq_mod_impl IS NOT NULL AND f.nr_seq_mod_impl::text <> '')
	and	not exists (
			SELECT	1
			from	com_cons_gest_con_fun ccgcf,
				com_cons_gest_con_mod ccgcm
			where	ccgcm.nr_sequencia = ccgcf.nr_seq_conhecimento
			and	ccgcf.cd_funcao = f.cd_funcao
			and	ccgcm.nr_seq_consultor = nr_seq_consultor_p
		)
	and	exists (
			select	1
			from	modulo_implantacao mi
			where	mi.nr_sequencia = nr_seq_mod_impl
		);
BEGIN

	/**
	* Delete all the inative functions that had been inserted for the
	* consultant
	*/
	for reg01 in c01 loop
	begin
		delete
		from	com_cons_gest_con_fun
		where	nr_sequencia = reg01.nr_seq_con_gest_fun;
	end;
	end loop;
	
	/**
	* Remove modules without functions
	*/
	delete
	from	com_cons_gest_con_mod ccgcm
	where	ccgcm.nr_seq_consultor = nr_seq_consultor_p
	and	not exists (
			SELECT	1
			from	com_cons_gest_con_fun ccgcf
			where	ccgcm.nr_sequencia = ccgcf.nr_seq_conhecimento
		);

	/**
	* Insert all the modules/functions found in the cursor c02
	*/
	for reg02 in c02 loop
	begin

		/**
		* Check if the consultant already have the current module
		*/
		select	count(*)
		into STRICT	qr_modulos_consultor_w
		from	com_cons_gest_con_mod ccgcm
		where	ccgcm.nr_seq_consultor = nr_seq_consultor_p
		and	ccgcm.nr_seq_mod_impl = reg02.nr_seq_mod_impl;

		/**
		* If the record already exists, try to find the sequence.
		* Otherwise, insert the module for the consultant
		*/
		if (qr_modulos_consultor_w > 0) then
			
			select	max(nr_sequencia)
			into STRICT	nr_seq_con_gest_mod_w
			from	com_cons_gest_con_mod
			where	nr_seq_consultor = nr_seq_consultor_p
			and	nr_seq_mod_impl = reg02.nr_seq_mod_impl;
		else
			
			select	nextval('com_cons_gest_con_mod_seq')
			into STRICT	nr_seq_con_gest_mod_w
			;
				
			insert
			into	com_cons_gest_con_mod(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_consultor,
				nr_seq_mod_impl,
				nr_seq_gest_con)
			values (
				nr_seq_con_gest_mod_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_consultor_p,
				reg02.nr_seq_mod_impl,
				null);			
		end if;

		/**
		* Insert the function for the module found above
		*/
		insert
		into	com_cons_gest_con_fun(
			nr_sequencia,
			nr_seq_conhecimento,
			cd_funcao,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_certificacao,
			pr_conhecimento,
			ie_implantou,
			ie_ead,
			ie_treinamento_interno,
			ie_situacao)
		values (
			nextval('com_cons_gest_con_fun_seq'),
			nr_seq_con_gest_mod_w,
			reg02.cd_funcao,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			null,
			0,
			'N',
			'N',
			'N',
			'A');
	end;
	end loop;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE phi_gerar_mod_func_consult ( nr_seq_consultor_p bigint, nm_usuario_p text) FROM PUBLIC;

