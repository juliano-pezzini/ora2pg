-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE intcom_gerar_ordem_compra ( nr_cot_compra_p bigint, ie_forma_calc_entrega_p text, nm_usuario_p text) AS $body$
DECLARE


cd_estabelecimento_w		integer;
cd_material_w			integer	:= 0;
nr_item_cot_compra_w		integer	:= 0;
nr_item_w			integer	:= 0;
nr_ordem_compra_w		bigint	:= 0;
nr_seq_fornecedor_w		bigint	:= 0;
nr_seq_fornecedor_w2		bigint	:= 0;
qt_conv_unid_fornec_w		double precision;
qt_material_w			double precision	:= 0;
vl_unitario_w			double precision	:= 0;
pr_desconto_w			double precision	:= 0;
vl_desconto_w			double precision	:= 0;
cd_unidade_w			varchar(30)	:= '0';
ds_material_direto_w		varchar(255)	:= '0';
ds_observacao_w			varchar(255)	:= '0';
ds_marca_w			varchar(30)	:= '';
ds_marca2_w			varchar(30)	:= '';
ie_situacao_w			varchar(1)	:= '0';
dt_entrega_w			timestamp;
dt_validade_w			timestamp;
ie_ajusta_unid_fornec_w		varchar(1)	:= 'S';
nr_contrato_w			bigint;
dt_entrega_ww			timestamp;
nr_solic_compra_w			bigint;
nr_item_solic_compra_w		bigint;
ds_xml_w				text;
ie_tipo_integracao_w		varchar(15);
nr_documento_externo_w		varchar(100);
nr_sequencia_w			bigint;
nr_ordem_compra_ww		bigint;

c01 CURSOR FOR
SELECT	a.cd_estabelecimento,
	c.nr_seq_cot_forn,
	c.nr_item_cot_compra,
	c.cd_material,
	c.cd_unidade_medida_compra,
	coalesce(c.ie_situacao,'A'),
	sum(c.qt_material),
	c.ds_observacao,
	substr(coalesce(c.ds_marca_fornec,CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ),1,30),
	substr(CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ,1,30),
	c.dt_limite_entrega,
	coalesce(c.vl_unitario_material,0),
	coalesce(c.pr_desconto,0),
	coalesce(c.qt_conv_unid_fornec,0),
	c.dt_validade,
	coalesce(c.vl_desconto,0)
from	cot_compra a,
	cot_compra_resumo_v c
where	c.nr_cot_compra      = nr_cot_compra_p
and	c.nr_cot_compra      = a.nr_cot_compra
and (substr(obter_se_existe_cot_resumo(c.nr_cot_compra),1,1) = 'S')
and	coalesce(obter_dados_cot_compra_item(a.nr_cot_compra, c.nr_item_cot_compra, 'DBI')::text, '') = ''
and	(c.cd_cgc_fornecedor_venc_alt IS NOT NULL AND c.cd_cgc_fornecedor_venc_alt::text <> '')
group by
	a.cd_estabelecimento,
	c.nr_seq_cot_forn,
	c.nr_item_cot_compra,
	c.cd_material,
	c.cd_unidade_medida_compra,
	coalesce(c.ie_situacao,'A'),
	c.ds_observacao,
	coalesce(c.ds_marca_fornec,CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ),
	CASE WHEN position('(' in c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ,
	c.dt_limite_entrega,
	coalesce(c.vl_unitario_material,0),
	coalesce(c.pr_desconto,0),
	coalesce(c.qt_conv_unid_fornec,0),
	c.dt_validade,
	coalesce(c.vl_desconto,0)
order by	c.nr_seq_cot_forn,
	nr_item_cot_compra;

c02 CURSOR FOR
SELECT	distinct nr_ordem_compra
from	ordem_compra_item
where	nr_cot_compra = nr_cot_compra_p;

/* Variacao da busca da function obter_ordem_solic_compra */

c03 CURSOR FOR
SELECT distinct
	nr_solic_compra, 
	nr_item_solic_compra
from (
	SELECT o.nr_solic_compra, o.nr_item_solic_compra
	from ordem_compra_item o, solic_compra_item a
	where o.nr_ordem_compra = nr_ordem_compra_w
	and o.nr_solic_compra = a.nr_solic_compra
	and o.nr_item_solic_compra = a.nr_item_solic_compra
	and	coalesce(obter_se_oc_cancelado(o.nr_ordem_compra), 'N') = 'N'
	and	coalesce(obter_se_item_oc_cancelado(o.nr_ordem_compra, o.nr_item_oci), 'N') = 'N'
	and qt_itens_solic_em_cotacao(a.nr_solic_compra, a.nr_item_solic_compra) >= a.qt_material
	
union

	select c.nr_solic_compra, c.nr_item_solic_compra
	from cot_compra_solic_agrup c, solic_compra_item a
	where c.nr_ordem_compra = nr_ordem_compra_w
	and c.nr_solic_compra = a.nr_solic_compra
	and c.nr_item_solic_compra = a.nr_item_solic_compra
	and	coalesce(obter_se_oc_cancelado(c.nr_ordem_compra), 'N') = 'N'
	and qt_itens_solic_em_cotacao(a.nr_solic_compra, a.nr_item_solic_compra) >= a.qt_material
) alias8;


BEGIN

select	coalesce(max(b.ie_ajusta_unid_fornec),'N'),
	coalesce(max(b.ie_tipo_interface_compras),'0'),
	coalesce(max(a.nr_documento_externo),'')
into STRICT	ie_ajusta_unid_fornec_w,
	ie_tipo_integracao_w,
	nr_documento_externo_w
from	parametro_compras b,
	cot_compra a
where	a.cd_estabelecimento	= b.cd_estabelecimento
and	a.nr_cot_compra		= nr_cot_compra_p;

open C01;
loop
fetch C01 into	
	cd_estabelecimento_w,
	nr_seq_fornecedor_w,
	nr_item_cot_compra_w,
	cd_material_w,
	cd_unidade_w,
	ie_situacao_w,
	qt_material_w,
	ds_observacao_w,
	ds_marca_w,
	ds_marca2_w,
	dt_entrega_w,
	vl_unitario_w,
	pr_desconto_w,
	qt_conv_unid_fornec_w,
	dt_validade_w,
	vl_desconto_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	select	max(nr_contrato)
	into STRICT	nr_contrato_w
	from	cot_compra_item
	where	nr_cot_compra = nr_cot_compra_p
	and	nr_item_cot_compra = nr_item_cot_compra_w;
	
	if (ie_forma_calc_entrega_p = 'L') then
			dt_entrega_ww	:= dt_entrega_w + coalesce(obter_dados_cot_compra_forn(nr_cot_compra_p, nr_seq_fornecedor_w,'DE'), 0);
	elsif (ie_forma_calc_entrega_p = 'F') then
		dt_entrega_ww	:= dt_entrega_w;
	else
		dt_entrega_ww	:= trunc(clock_timestamp(),'dd') + coalesce(obter_dados_cot_compra_forn(nr_cot_compra_p, nr_seq_fornecedor_w,'DE'), 0);
	end if;
	
	if (nr_seq_fornecedor_w2 <> nr_seq_fornecedor_w) then	

		nr_ordem_compra_w := grava_ordem_compra(
			nr_cot_compra_p, cd_estabelecimento_w, nr_seq_fornecedor_w, nm_usuario_p, nr_ordem_compra_w);		
		
		CALL grava_item_ordem_compra(
			nr_ordem_compra_w,
			cd_material_w,
			cd_unidade_w,
			vl_unitario_w,
			qt_material_w,
			ds_observacao_w,
			ds_marca_w,
			ds_marca2_w,
			nm_usuario_p,
			ie_situacao_w,
			dt_entrega_ww,
			pr_desconto_w,
			nr_cot_compra_p,
			nr_item_cot_compra_w,
			nr_seq_fornecedor_w,
			qt_conv_unid_fornec_w,
			ie_ajusta_unid_fornec_w,
			dt_validade_w,
			'S',
			coalesce(vl_desconto_w,0),
			nr_contrato_w,
			null,
			null,
			null);
			
		nr_seq_fornecedor_w2 	:= nr_seq_fornecedor_w;
	else
		CALL grava_item_ordem_compra(
			nr_ordem_compra_w,
			cd_material_w,
			cd_unidade_w,
			vl_unitario_w,
			qt_material_w,
			ds_observacao_w,
			ds_marca_w,
			ds_marca2_w,
			nm_usuario_p,
			ie_situacao_w,
			dt_entrega_ww,
			pr_desconto_w,
			nr_cot_compra_p,
			nr_item_cot_compra_w,
			nr_seq_fornecedor_w,
			qt_conv_unid_fornec_w,
			ie_ajusta_unid_fornec_w,
			dt_validade_w,
			'S',
			coalesce(vl_desconto_w,0),
			nr_contrato_w,
			null,
			null,
			null);
	end if;
	
	CALL gerar_ordem_compra_venc( nr_ordem_compra_w, nm_usuario_p);
	calcular_liquido_ordem_compra( nr_ordem_compra_w, nm_usuario_p);
	
	update	ordem_compra
	set	ie_sistema_origem 	= 'WCF'
	where	nr_ordem_compra		= nr_ordem_compra_w;
	
	begin
	update	ordem_compra
	set	nr_documento_externo	= nr_documento_externo_w
	where	nr_ordem_compra		= nr_ordem_compra_w;
	exception
	when others then
		nr_documento_externo_w := nr_documento_externo_w;
	end;
	end;
end loop;
close C01;

open C02;
loop
fetch C02 into	
	nr_ordem_compra_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin

	update	ordem_compra_item
	set	qt_original	= qt_material
	where	nr_ordem_compra	= nr_ordem_compra_w
	and	coalesce(qt_original::text, '') = '';

	update	ordem_compra_item
	set	vl_unit_mat_original = vl_unitario_material
	where	nr_ordem_compra	= nr_ordem_compra_w
	and	coalesce(vl_unit_mat_original::text, '') = '';
	
	update	ordem_compra_item
	set	dt_aprovacao	= clock_timestamp()
	where	nr_ordem_compra	= nr_ordem_compra_w;
	
	update	ordem_compra
	set	dt_liberacao	= clock_timestamp(),
		nm_usuario_lib	= nm_usuario_p,
		dt_aprovacao	= clock_timestamp()
	where	nr_ordem_compra	= nr_ordem_compra_w;
	
	open C03;
	loop
	fetch C03 into	
		nr_solic_compra_w,
		nr_item_solic_compra_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin
		
		select	obter_ordem_solic_compra(nr_solic_compra_w, nr_item_solic_compra_w)
		into STRICT	nr_ordem_compra_ww
		;
		
		if (nr_ordem_compra_w > 0) then		
			CALL intcom_baixar_item_solic(nr_ordem_compra_w, nr_solic_compra_w, nr_item_solic_compra_w, nm_usuario_p);
		end if;
		end;
	end loop;
	close C03;
		
	end;
end loop;
close C02;

commit;

if (nr_ordem_compra_w > 0) then

	nr_sequencia_w := intcom_gerar_int_confirm_oc(nr_ordem_compra_w, ie_tipo_integracao_w, nm_usuario_p, nr_sequencia_w);
	CALL wheb_exportar_xml_pck.exportar(100044, nr_sequencia_w, 'INTCOM', 'nr_cot_compra=' || nr_cot_compra_p || ';');
	
	update	registro_integr_com_xml
	set	ie_status = 'NP'
	where	nr_sequencia = nr_sequencia_w;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE intcom_gerar_ordem_compra ( nr_cot_compra_p bigint, ie_forma_calc_entrega_p text, nm_usuario_p text) FROM PUBLIC;

