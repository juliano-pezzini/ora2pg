-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_lote_atend_prescricao ( nr_prescricao_p bigint, nr_sequencia_p bigint, nr_seq_horario_p bigint, ie_so_aprazado_p text, nm_usuario_p text, ie_origem_lote_p text, nr_etapa_p bigint default 0) AS $body$
DECLARE


reg_integracao_p			gerar_int_padrao.reg_integracao;
nr_sequencia_w			bigint;
cd_material_w			integer;
cd_mat_est_w			integer;
nr_seq_mat_hor_w			bigint;
cd_unidade_medida_w		varchar(30);
qt_dispensar_w			double precision;
qt_dispensar_hor_w			double precision;
nr_seq_turno_w			bigint;
nr_seq_turno_ant_w		bigint := 0;
cd_setor_atendimento_w		integer;
cd_setor_atendimento_ww		integer;
dt_horario_w			timestamp;
dt_horario_ant_w			timestamp;
hr_inicio_turno_w			varchar(5);
VarNaoGerarSoPrimeiraEtapa_w	varchar(5);
hr_hora_w			varchar(5);
dt_atend_lote_w			timestamp;
dt_inicio_turno_w			timestamp;
cd_estabelecimento_w		smallint;
ie_urgente_w			varchar(1);
ds_maq_user_w 			varchar(80);
cd_perfil_ativo_w			integer;
nr_seq_classif_w			bigint;
nr_seq_classif_ant_w		bigint := 0;
ds_erro_w			varchar(2000);

qt_min_antes_atend_w		bigint;
qt_min_receb_setor_w		bigint;
qt_min_entr_setor_w		bigint;
qt_min_disp_farm_w		bigint;
qt_min_atend_farm_w		bigint;
qt_min_inicio_atend_w		bigint;

cd_tipo_baixa_w			smallint;
ie_conta_paciente_w		varchar(1);
ie_atualiza_estoque_w		varchar(1);
cd_local_estoque_w		smallint;
cd_local_estoque_ant_w		smallint := 0;
cd_local_setor_pac_w		smallint;
ie_hora_antes_w			varchar(1);
ie_classif_nao_padrao_w		varchar(15);
qt_prioridade_w			smallint;

ie_lote_acm_sn_w			varchar(1);
ie_gerar_acm_w			varchar(1);
ie_gerar_sn_w			varchar(1);
ie_acm_w			varchar(1);
ie_se_necessario_w		varchar(1);
ie_gera_lote_orig_w			varchar(1);
ie_gera_lote_medic_pac_w		varchar(1);
ie_gerar_novo_lote_turno_dia_w	varchar(15);
ie_gerar_lote_area_w		varchar(1);
ie_gerar_solucao_separado_w	varchar(1);

ie_termolabil_w			varchar(1);
ie_alto_risco_w			varchar(1);
ie_novo_lote_dia_w			varchar(1);
ie_setor_atual_w			varchar(1);
nr_atendimento_w			bigint;
ie_gera_lote_separado_w		varchar(1);
ie_gera_lote_desdobrado_w		varchar(1);
ie_arq_pyxis_w			varchar(1);
qt_existe_regra_w			bigint;
ie_gerar_lote_apos_horario_w		varchar(1);
nr_seq_regra_termo_w		bigint;
nr_seq_regra_ccih_w		bigint;
nr_seq_regra_alto_risco_w		bigint;
nr_seq_regra_alto_custo_w		bigint;
nr_seq_regra_controlado_w		bigint;
nr_seq_regra_acm_w		bigint;
nr_seq_regra_sn_w			bigint;
ie_itens_associados_termo_w		varchar(1);
ie_itens_associados_w		varchar(1);
ie_itens_associados_custo_w		varchar(1);
ie_itens_associados_ccih_w		varchar(1);
ie_itens_assoc_controlado_w		varchar(1);
ie_itens_assoc_acm_w		varchar(1);
ie_itens_assoc_sn_w		varchar(1);
nr_seq_classif_param_w		bigint;
ie_dose_especial_w		varchar(1);
ie_dose_especial_ww		varchar(1);
ie_gerar_lote_unico_w		varchar(1);
ie_gerou_w			varchar(1);
ie_geracao_rotina_w		varchar(1);
ie_gerar_lote_acm_sn_uti_w		varchar(1);
vl_union_w			integer;
nr_item_prescr_w			bigint;
ie_far_gera_lote_unico_w		varchar(1);
ie_gerar_lote_null_w		varchar(3);
qt_material_w			double precision;
ie_saldo_estoque_w		varchar(1);
ie_gerar_lote_agora_w		varchar(1);
ie_somente_gerar_acm_sn_w		varchar(1);
nr_seq_atend_w			bigint;
ie_gera_lote_prescr_quimio_w		varchar(1);
ie_motivo_prescricao_w		varchar(5);
cd_setor_gedipa_w			integer;
nr_seq_regra_gedipa_w		bigint;
ie_gerar_ap_lote_gedipa_w		varchar(1);
ie_gerar_solucao_w			varchar(1) := 'S';
nr_seq_lote_sep_w			bigint;
dt_seq_horario_w			timestamp;
ie_aprazado_w			varchar(1);
ie_aprazado_ww			varchar(1);
nr_seq_superior_w			bigint;
ie_gerar_lote_solucao_w		varchar(1);
ie_dose_esp_apos_horario_w	varchar(1);
ie_medicacao_paciente_w		varchar(1);
ie_medic_pac_ant_w		varchar(1);
ie_define_disp_prescr_w		varchar(1);
nr_regra_local_disp_w		bigint;
ie_gerar_ap_lote_w		varchar(1) := 'S';
ie_send_integration_w           varchar(1) := 'N';
nr_seq_mat_hor_ww		bigint;
ie_ajusta_local_item_sol_w	varchar(1);
ie_existe_w			varchar(1) := 'N';
ds_param_integ_hl7_w		varchar(4000) := '';
nr_seq_empresa_w		empresa_integracao.nr_sequencia%type;
nr_seq_mat_hor_aip_ais_w	bigint;
ie_origem_lote_w		varchar(100);
ie_setor_lote_w			setor_atendimento.ie_gerar_lote%type;
ie_quimio_w			varchar(1);
ie_agrupador_w  		prescr_mat_hor.ie_agrupador%type;
dt_prescricao_w			prescr_medica.dt_prescricao%type;

ie_gerar_lote_ww		material.ie_gerar_lote%type;
ie_suspenso_ww			prescr_material.ie_suspenso%type;
ie_urgencia_ww			prescr_material.ie_urgencia%type;
ie_agrupador_ww			prescr_material.ie_agrupador%type;
nr_etapa_sol_ww			prescr_mat_hor.nr_etapa_sol%type;
nr_seq_lote_ww			prescr_mat_hor.nr_seq_lote%type;
nr_sequencia_solucao_ww	prescr_material.nr_sequencia_solucao%type;
cd_motivo_baixa_ww		prescr_material.cd_motivo_baixa%type;
qt_dispensar_hor_ww		prescr_mat_hor.qt_dispensar_hor%type;
ie_gerar_lote_hor_w		prescr_mat_hor.ie_gerar_lote%type;
ie_gerar_lote_pm_w		prescr_material.ie_gerar_lote%type;
ie_horario_especial_ww	prescr_mat_hor.ie_horario_especial%type;
dt_liberacao_ww			prescr_medica.dt_liberacao%type;
dt_baixa_ww				prescr_material.dt_baixa%type;
nr_seq_turno_ww			prescr_mat_hor.nr_seq_turno%type;
nr_seq_classif_ww		prescr_mat_hor.nr_seq_classif%type;
ie_se_necessario_ww		prescr_material.ie_se_necessario%type;
ie_acm_ww				prescr_material.ie_acm%type;
hr_prim_horario_ww		prescr_solucao.hr_prim_horario%type;
ie_aprazado_log_w		prescr_mat_hor.ie_aprazado%type;
nr_seq_area_prep_ww		prescr_mat_hor.nr_seq_area_prep%type;
ie_se_horario_lib_ww	varchar(20);
cd_local_estoque_ww		local_estoque.cd_local_estoque%type;
ds_conteudo_ww			varchar(2000);
nr_seq_mat_diluicao_w 	prescr_material.nr_seq_mat_diluicao%type;
ie_gerar_lote_dil_w		material_diluicao.ie_gerar_lote%type;
nr_seq_lote_w			ap_lote.nr_sequencia%type;
ie_atualiza_regra_local_kit_w	varchar(1);
nr_seq_regra_recomend_w		parametros_farmacia.nr_seq_regra_recomend%type;
ie_itens_assoc_recomend_w	regra_geracao_lote_sep.ie_itens_associados%type;
ie_gera_integracao_w 		parametros_farmacia.ie_gera_integracao%type;
ds_param_bifrost_w			varchar(255);
cd_pessoa_fisica_w			pessoa_fisica.cd_pessoa_fisica%type;
dt_horario_pai_w			prescr_mat_hor.dt_horario%type;

nr_seq_lote_integracao_w    prescr_mat_hor.nr_seq_lote%type;
ie_enviar_horarios_disp_w	varchar(1);
ie_enviar_mat_estoque_w	varchar(1) := 'N';
nr_seq_material_hl7_w		prescr_material.nr_sequencia%type;
nr_seq_regra_local_w		regra_local_dispensacao.nr_sequencia%type;
nr_seq_estrut_int_w			mat_estrutura.nr_sequencia%type;
ie_integracao_dispensario_w	mat_estrutura.ie_integracao_dispensario%type;

ie_setor_athena_w				varchar(1) := 'N';
ie_setor_supply_w				varchar(1) := 'N';
ie_gen_batch_per_order_unit_w        parametros_farmacia.ie_gen_batch_per_order_unit%type;

C01 CURSOR FOR
	SELECT  b.cd_material,
		b.nr_sequencia,
		b.cd_unidade_medida,
		b.qt_dispensar,
		b.qt_dispensar_hor,
		coalesce(b.nr_seq_turno,-1),
		b.dt_horario,
		to_char(b.dt_horario,'hh24:mi'),
		coalesce(a.cd_estabelecimento,1),
		b.ie_urgente,
		b.nr_seq_classif,
		coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)) cd_local,
		c.nr_sequencia,
		b.ie_aprazado,
		1 vl_union,
		b.ie_dose_especial,
		c.ie_medicacao_paciente,
		b.ie_agrupador,
		c.nr_seq_mat_diluicao
	from	material x,
		prescr_mat_hor  b,
		prescr_material c,
		prescr_medica   a
	where	a.nr_prescricao = b.nr_prescricao
	and	x.cd_material	= c.cd_material
	and	a.nr_prescricao	= c.nr_prescricao
	and	c.nr_sequencia	= b.nr_seq_material
	and	a.nr_prescricao = nr_prescricao_p
	and	Obter_se_setor_lote(a.cd_setor_atendimento) = 'S'
	and	((ie_gerar_lote_agora_w = 'S') or (coalesce(c.ie_urgencia,'N') = 'N') or (c.ie_agrupador = 2))
	and	((coalesce(nr_sequencia_p, 0) = 0) or (c.nr_sequencia = nr_sequencia_p))
	and ((nr_sequencia_p > 0 and coalesce(nr_seq_kit::text, '') = '') or coalesce(nr_sequencia_p, 0) = 0)
	and	((coalesce(nr_seq_horario_p, 0) = 0) or (b.nr_sequencia = nr_seq_horario_p))
	and	((coalesce(ie_so_aprazado_p, 'N') = 'N') or (coalesce(ie_so_aprazado_p, 'N') = ie_aprazado))
	and	coalesce(b.ie_situacao,'A') <> 'I'
	and	coalesce(c.ie_suspenso,'N') <> 'S'
	and	coalesce(x.ie_gerar_lote,'S') = 'S'
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	coalesce(b.dt_suspensao::text, '') = ''
	and	coalesce(c.cd_motivo_baixa,0) = 0
	and	coalesce(c.dt_baixa::text, '') = ''
	and	(b.nr_seq_turno IS NOT NULL AND b.nr_seq_turno::text <> '')
	and	(b.nr_seq_classif IS NOT NULL AND b.nr_seq_classif::text <> '')
	and	coalesce(b.ie_gerar_lote,'S') = 'S'
	and	coalesce(c.ie_gerar_lote,'S') = 'S'
	and (coalesce(b.ie_horario_especial, 'N') = 'N' or (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
	and	coalesce(b.qt_dispensar_hor,0) > 0
	and	coalesce(c.nr_sequencia_solucao::text, '') = ''
	and	((VarNaoGerarSoPrimeiraEtapa_w = 'N') or (coalesce(b.nr_etapa_sol,1) = 1)  or (ie_origem_lote_p = 'GASR'))
	and (ie_somente_gerar_acm_sn_w = 'N' or (c.ie_se_necessario = 'S' or c.ie_acm = 'S'))
	and	((ie_gerar_lote_null_w = 'S') or (c.ds_horarios IS NOT NULL AND c.ds_horarios::text <> '') or (ie_origem_lote_p = 'AIP') or
		((b.nr_seq_superior IS NOT NULL AND b.nr_seq_superior::text <> '') and exists (	SELECT	1 
								from	prescr_material xp
								where 	xp.nr_prescricao = b.nr_prescricao
								and 	xp.nr_sequencia = b.nr_seq_superior
								and 	(xp.ds_horarios IS NOT NULL AND xp.ds_horarios::text <> ''))))
	and	((coalesce(ie_classif_nao_padrao_w::text, '') = '') or
		 ((coalesce(b.ie_padronizado,'S') = 'S') and (coalesce(b.nr_seq_superior::text, '') = '')) or
		 ((coalesce(b.ie_padronizado,'S') = 'N') and (b.nr_seq_superior IS NOT NULL AND b.nr_seq_superior::text <> '') and exists (	select	1
												from	prescr_material p,
													material_estab o
												where	p.nr_prescricao = b.nr_prescricao
												and	p.nr_sequencia = b.nr_seq_superior
												and	p.cd_material = o.cd_material
												and	coalesce(o.ie_padronizado,'S') = 'S'
												and	o.cd_estabelecimento = a.cd_estabelecimento)) or
		 ((coalesce(b.ie_padronizado,'S') = 'S') and (b.nr_seq_superior IS NOT NULL AND b.nr_seq_superior::text <> '') and exists (	select	1
												from	prescr_material d,
													material_estab t
												where	d.nr_prescricao = b.nr_prescricao
												and	d.nr_sequencia = b.nr_seq_superior
												and	d.cd_material = t.cd_material
												and	coalesce(t.ie_padronizado,'S') = 'S'
												and	t.cd_estabelecimento = a.cd_estabelecimento)))
	and	coalesce(b.nr_seq_lote::text, '') = ''
	and	((ie_origem_lote_p <> 'AIP') or	(ie_origem_lote_p = 'AIP' AND b.ie_aprazado = 'S'))
	and	((ie_gerar_acm_w = 'S') or (ie_gerar_acm_w = 'N' and coalesce(c.ie_acm, 'N') = 'N') or 
		 ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(a.cd_setor_atendimento) = 4)) or (obter_se_hor_dose_especial(b.nr_sequencia) = 'S'))
	and	((ie_gerar_sn_w = 'S') or (ie_gerar_sn_w = 'N' and coalesce(c.ie_se_necessario, 'N') = 'N') or 
		 ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(a.cd_setor_atendimento) = 4)) or (obter_se_hor_dose_especial(b.nr_sequencia) = 'S'))
	and	((ie_gera_lote_orig_w = 'N') or ((ie_origem_lote_p <> 'AIP') or (coalesce(b.ie_aprazado,'N') = 'S')))
	and	((ie_gera_lote_medic_pac_w = 'S') or ((ie_gera_lote_medic_pac_w = 'N') and (coalesce(ie_medicacao_paciente,'N') = 'N')))
	and	((ie_gerar_lote_area_w = 'S') or (coalesce(b.nr_seq_area_prep::text, '') = ''))
	and	((ie_origem_lote_p <> 'AIS') or ((ie_origem_lote_p = 'AIS') and (coalesce(b.ie_horario_especial, 'N') = 'N') and exists (	select	1
															from	prescr_mat_hor d
															where	d.nr_prescricao   = c.nr_prescricao						  									   and	   d.nr_seq_material = c.nr_seq_kit
															and	d.ie_agrupador in (4,13))))
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	and	obter_se_local_gera_lote(coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque))) = 'S'
	and 	((coalesce(ie_gera_lote_separado_w,'N') = 'N') or ((coalesce(ie_gera_lote_separado_w,'N') = 'S') and (coalesce(x.ie_gera_lote_separado,'N') = 'N')))
	and (ie_gerar_solucao_separado_w = 'N' or (not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and	d.ie_agrupador = 4)))
	and	((coalesce(x.ie_termolabil,'N') = 'N') or (coalesce(nr_seq_regra_termo_w,0) = 0))
	and	((coalesce(ie_itens_associados_termo_w,'N') = 'N') or
		((ie_itens_associados_termo_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from material z where z.cd_material = d.cd_material and z.ie_termolabil = 'S')
									
union

									select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and		d.nr_sequencia = c.nr_sequencia_diluicao
									and exists (select 1 from material z where z.cd_material = d.cd_material and z.ie_termolabil = 'S'))))
	and	((obter_se_material_risco(a.cd_setor_atendimento,b.cd_material) = 'N') or (coalesce(nr_seq_regra_alto_risco_w,0) = 0))
	and	((coalesce(ie_itens_associados_w,'N') = 'N') or
		((ie_itens_associados_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and exists (select 1 from material_risco z where z.cd_material = d.cd_material and z.ie_material_risco = 'S' and z.cd_estabelecimento = a.cd_estabelecimento))))	
	and	((obter_se_mat_alto_custo(b.cd_material,coalesce(a.cd_estabelecimento,1)) = 'N') or (coalesce(nr_seq_regra_alto_custo_w,0) = 0))
	and	((coalesce(ie_itens_associados_custo_w,'N') = 'N') or
		((ie_itens_associados_custo_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and exists (select 1 from material_estab z where z.cd_material = d.cd_material and z.cd_estabelecimento = a.cd_estabelecimento and z.ie_classif_custo = 'A'))))
	and	((coalesce(x.ie_controle_medico,0) <> 2) or (coalesce(nr_seq_regra_ccih_w,0) = 0))
	and	((coalesce(ie_itens_associados_ccih_w,'N') = 'N') or
		((ie_itens_associados_ccih_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from material z where z.cd_material = d.cd_material and coalesce(z.ie_controle_medico,0) = 2 and (cd_medicamento IS NOT NULL AND cd_medicamento::text <> '')))))
	and	((obter_se_medic_controlado(b.cd_material) = 'N') or (coalesce(nr_seq_regra_controlado_w,0) = 0))
	and	((coalesce(ie_itens_assoc_controlado_w,'N') = 'N') 
	or	((ie_itens_assoc_controlado_w = 'S') 
	and not exists (	select	1
					from	prescr_mat_hor d
					where	d.nr_prescricao = c.nr_prescricao
					and 	coalesce(d.nr_seq_superior::text, '') = ''
					and 	obter_se_associado(d.nr_prescricao, b.nr_seq_superior, d.nr_seq_material) = 'S'
					and 	exists (select 1 from medic_controlado z where 	z.cd_material = d.cd_material and 	z.ie_situacao = 'A' and	coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w)
					
union

					select	1
					from	prescr_material d
					where	d.nr_prescricao = c.nr_prescricao
					and		d.nr_sequencia = c.nr_sequencia_diluicao
					and exists (select 1 from medic_controlado z where z.cd_material = d.cd_material and z.ie_situacao = 'A' and coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w))))
	and	((coalesce(c.ie_acm,'N') = 'N') or (coalesce(nr_seq_regra_acm_w,0) = 0))
	and	((coalesce(ie_itens_assoc_acm_w,'N') = 'N') or
		((ie_itens_assoc_acm_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and	coalesce(d.ie_acm,'N') = 'S'
								
union

                select	1
                from	prescr_material d
                where	d.nr_prescricao = c.nr_prescricao
                and	d.nr_sequencia = c.nr_sequencia_diluicao
                and coalesce(d.ie_acm,'N') = 'S')))
	and	((coalesce(c.ie_se_necessario,'N') = 'N') or (coalesce(nr_seq_regra_sn_w,0) = 0))
	and	((coalesce(ie_itens_assoc_sn_w,'N') = 'N') or
		((ie_itens_assoc_sn_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and	coalesce(d.ie_se_necessario,'N') = 'S'
								
union

                select	1
                from	prescr_material d
                where	d.nr_prescricao = c.nr_prescricao
                and	d.nr_sequencia = c.nr_sequencia_diluicao
                and coalesce(d.ie_se_necessario,'N') = 'S')))
	and	((coalesce(c.nr_seq_recomendacao,0) = 0) or (coalesce(nr_seq_regra_recomend_w,0) = 0))
	and	((coalesce(ie_itens_assoc_recomend_w,'N') = 'N') or
		((ie_itens_assoc_recomend_w = 'S') and not exists (	select	1
									from	prescr_recomendacao d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = c.nr_seq_recomendacao)))
	
union all

	select  b.cd_material,
		b.nr_sequencia,
		b.cd_unidade_medida,
		b.qt_dispensar,
		b.qt_dispensar_hor,
		coalesce(b.nr_seq_turno,-1),
		b.dt_horario,
		to_char(b.dt_horario,'hh24:mi'),
		coalesce(a.cd_estabelecimento,1),
		b.ie_urgente,
		b.nr_seq_classif,
		coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)) cd_local,
		c.nr_sequencia,
		b.ie_aprazado,
		2 vl_union,
		b.ie_dose_especial,
		c.ie_medicacao_paciente,
		b.ie_agrupador,
		c.nr_seq_mat_diluicao
	from	material x,
		prescr_mat_hor  b,
		prescr_material c,
		prescr_medica   a
	where	a.nr_prescricao = b.nr_prescricao
	and	a.nr_prescricao	= c.nr_prescricao
	and	c.nr_sequencia	= b.nr_seq_material
	and	a.nr_prescricao = nr_prescricao_p
	and	x.cd_material	= c.cd_material
	and	coalesce(x.ie_gerar_lote,'S') = 'S'
	and	coalesce(a.dt_suspensao::text, '') = ''	
	and	coalesce(b.dt_suspensao::text, '') = ''	
	and	coalesce(nr_sequencia_p, 0) > 0
	and	Obter_se_setor_lote(a.cd_setor_atendimento) = 'S'
	and	((ie_gerar_lote_agora_w = 'S') or (coalesce(c.ie_urgencia,'N') = 'N') or (c.ie_agrupador = 2))
	and	((coalesce(ie_so_aprazado_p, 'N') = 'N') or (coalesce(ie_so_aprazado_p, 'N') = ie_aprazado))
	and	coalesce(b.nr_seq_lote::text, '') = ''
	and	coalesce(c.nr_sequencia_solucao::text, '') = ''
 	and (b.nr_seq_superior = nr_sequencia_p
	or 	b.nr_seq_superior in (	select 	w.nr_seq_material 
								from 	prescr_mat_hor w 
								where 	w.nr_prescricao = nr_prescricao_p
								and 	w.nr_seq_superior = nr_sequencia_p)) /*Quando o associado do principal tbm possui kit*/
	and	coalesce(c.nr_seq_kit,0) <> nr_sequencia_p
	and	c.cd_motivo_baixa = 0
	and	coalesce(c.ie_gerar_lote,'S') = 'S'
	and (coalesce(b.ie_horario_especial, 'N') = 'N' or (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
	and	coalesce(b.ie_gerar_lote,'S') = 'S'
	and	coalesce(b.qt_dispensar_hor,0) > 0
	and	coalesce(c.dt_baixa::text, '') = ''
	and	(b.nr_seq_turno IS NOT NULL AND b.nr_seq_turno::text <> '')
	and	(b.nr_seq_classif IS NOT NULL AND b.nr_seq_classif::text <> '')
	and (ie_somente_gerar_acm_sn_w = 'N' or (c.ie_se_necessario = 'S' or c.ie_acm = 'S'))
	--and	((ie_gerar_lote_null_w = 'S') or (c.ds_horarios is not null) or (ie_origem_lote_p = 'AIP'))
	and	((ie_gerar_acm_w = 'S') or (ie_gerar_acm_w = 'N' and coalesce(c.ie_acm, 'N') = 'N') or 
		 ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(a.cd_setor_atendimento) = 4)) or (obter_se_hor_dose_especial(b.nr_sequencia) = 'S'))
	and	((ie_gerar_sn_w = 'S') or (ie_gerar_sn_w = 'N' and coalesce(c.ie_se_necessario, 'N') = 'N') or 
		 ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(a.cd_setor_atendimento) = 4)) or (obter_se_hor_dose_especial(b.nr_sequencia) = 'S'))
	and	((ie_origem_lote_p <> 'AIS') or	(ie_origem_lote_p = 'AIS' AND b.ie_aprazado = 'S'))
	and	((ie_gera_lote_orig_w = 'N') or ((ie_origem_lote_p <> 'AIP') or (coalesce(b.ie_aprazado,'N') = 'S')))
	and	((ie_gera_lote_medic_pac_w = 'S') or ((ie_gera_lote_medic_pac_w = 'N') and (coalesce(ie_medicacao_paciente,'N') = 'N')))
	and	((ie_gerar_lote_area_w = 'S') or (coalesce(b.nr_seq_area_prep::text, '') = ''))
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	and	obter_se_local_gera_lote(coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque))) = 'S'
	and 	((coalesce(ie_gera_lote_separado_w,'N') = 'N') or ((coalesce(ie_gera_lote_separado_w,'N') = 'S') and (coalesce(x.ie_gera_lote_separado,'N') = 'N')))
	and	((coalesce(x.ie_termolabil,'N') = 'N') or (coalesce(nr_seq_regra_termo_w,0) = 0))
	and	((coalesce(ie_itens_associados_termo_w,'N') = 'N') or
		((ie_itens_associados_termo_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from material z where z.cd_material = d.cd_material and z.ie_termolabil = 'S')
									
union

									select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and		d.nr_sequencia = c.nr_sequencia_diluicao
									and exists (select 1 from material z where z.cd_material = d.cd_material and z.ie_termolabil = 'S'))))
	and	((obter_se_material_risco(a.cd_setor_atendimento,b.cd_material) = 'N') or (coalesce(nr_seq_regra_alto_risco_w,0) = 0))
	and	((coalesce(ie_itens_associados_w,'N') = 'N') or
		((ie_itens_associados_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and exists (select 1 from material_risco z where z.cd_material = d.cd_material and z.ie_material_risco = 'S' and z.cd_estabelecimento = a.cd_estabelecimento))))
	and	((obter_se_mat_alto_custo(b.cd_material,coalesce(a.cd_estabelecimento,1)) = 'N') or (coalesce(nr_seq_regra_alto_custo_w,0) = 0))
	and	((coalesce(ie_itens_associados_custo_w,'N') = 'N') or
		((ie_itens_associados_custo_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and exists (select 1 from material_estab z where z.cd_material = d.cd_material and z.cd_estabelecimento = a.cd_estabelecimento and z.ie_classif_custo = 'A'))))
	and	((ie_origem_lote_p <> 'AIS') or ((ie_origem_lote_p = 'AIS') and (coalesce(b.ie_horario_especial, 'N') = 'N') and exists (select	1
															from	prescr_mat_hor d
															where	d.nr_prescricao   = c.nr_prescricao															   and	   d.nr_seq_material = c.nr_seq_kit
															and	d.ie_agrupador in (4,13))))
	and	((coalesce(x.ie_controle_medico,0) <> 2) or (coalesce(nr_seq_regra_ccih_w,0) = 0))
	and	((coalesce(ie_itens_associados_ccih_w,'N') = 'N') or
		((ie_itens_associados_ccih_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from material z where z.cd_material = d.cd_material and coalesce(z.ie_controle_medico,0) = 2 and (cd_medicamento IS NOT NULL AND cd_medicamento::text <> '')))))
	and	((obter_se_medic_controlado(b.cd_material) = 'N') or (coalesce(nr_seq_regra_controlado_w,0) = 0))
	and	((coalesce(ie_itens_assoc_controlado_w,'N') = 'N') 
	or	((ie_itens_assoc_controlado_w = 'S') 
	and not exists (	select	1
					from	prescr_mat_hor d
					where	d.nr_prescricao = c.nr_prescricao
					and 	coalesce(d.nr_seq_superior::text, '') = ''
					and 	obter_se_associado(d.nr_prescricao, b.nr_seq_superior, d.nr_seq_material) = 'S'
					and 	exists (select	1 from medic_controlado z where 	z.cd_material = d.cd_material and 	z.ie_situacao = 'A' and	coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w)
					
union

					select	1
					from	prescr_material d
					where	d.nr_prescricao = c.nr_prescricao
					and		d.nr_sequencia = c.nr_sequencia_diluicao
					and exists (select 1 from medic_controlado z where z.cd_material = d.cd_material and z.ie_situacao = 'A' and coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w))))
	and	((coalesce(c.ie_acm,'N') = 'N') or (coalesce(nr_seq_regra_acm_w,0) = 0))
	and	((coalesce(ie_itens_assoc_acm_w,'N') = 'N') or
		((ie_itens_assoc_acm_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and	coalesce(d.ie_acm,'N') = 'S'
								
union

                select	1
                from	prescr_material d
                where	d.nr_prescricao = c.nr_prescricao
                and	d.nr_sequencia = c.nr_sequencia_diluicao
                and coalesce(d.ie_acm,'N') = 'S')))
	and	((coalesce(c.ie_se_necessario,'N') = 'N') or (coalesce(nr_seq_regra_sn_w,0) = 0))
	and	((coalesce(ie_itens_assoc_sn_w,'N') = 'N') or
		((ie_itens_assoc_sn_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and	coalesce(d.ie_se_necessario,'N') = 'S'
								
union

                select	1
                from	prescr_material d
                where	d.nr_prescricao = c.nr_prescricao
                and	d.nr_sequencia = c.nr_sequencia_diluicao
                and coalesce(d.ie_se_necessario,'N') = 'S')))
	and	((coalesce(c.nr_seq_recomendacao,0) = 0) or (coalesce(nr_seq_regra_recomend_w,0) = 0))
	and	((coalesce(ie_itens_assoc_recomend_w,'N') = 'N') or
		((ie_itens_assoc_recomend_w = 'S') and not exists (	select	1
									from	prescr_recomendacao d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = c.nr_seq_recomendacao)))								
	
union all

	select  b.cd_material,
		b.nr_sequencia,
		b.cd_unidade_medida,
		b.qt_dispensar,
		b.qt_dispensar_hor,
		coalesce(b.nr_seq_turno,-1),
		b.dt_horario,
		to_char(b.dt_horario,'hh24:mi'),
		coalesce(a.cd_estabelecimento,1),
		b.ie_urgente,
		b.nr_seq_classif,
		coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)) cd_local,
		c.nr_sequencia,
		b.ie_aprazado,
		3 vl_union,
		b.ie_dose_especial,
		c.ie_medicacao_paciente,
		b.ie_agrupador,
		c.nr_seq_mat_diluicao
	from	material x,
		prescr_mat_hor  b,
		prescr_material c,
		prescr_medica   a
	where	a.nr_prescricao = b.nr_prescricao
	and	a.nr_prescricao	= c.nr_prescricao
	and	c.nr_sequencia	= b.nr_seq_material
	and	x.cd_material	= c.cd_material
	and	coalesce(x.ie_gerar_lote,'S') = 'S'
	and	coalesce(a.dt_suspensao::text, '') = ''	
	and	coalesce(b.dt_suspensao::text, '') = ''	
	and	Obter_se_setor_lote(a.cd_setor_atendimento) = 'S'
	and	((ie_gerar_lote_agora_w = 'S') or (coalesce(c.ie_urgencia,'N') = 'N') or (c.ie_agrupador = 2))
	and	((coalesce(ie_so_aprazado_p, 'N') = 'N') or (coalesce(ie_so_aprazado_p, 'N') = ie_aprazado))
	and	a.nr_prescricao = nr_prescricao_p
	and	coalesce(nr_sequencia_p, 0) > 0
	and	coalesce(b.nr_seq_lote::text, '') = ''
	and	coalesce(c.nr_sequencia_solucao::text, '') = ''
	and	coalesce(c.nr_seq_kit,0)	= nr_sequencia_p
	and	c.cd_motivo_baixa = 0
	and	coalesce(c.ie_gerar_lote,'S') = 'S'
	and	coalesce(b.ie_gerar_lote,'S') = 'S'
	and (coalesce(b.ie_horario_especial, 'N') = 'N' or (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
	--and 	nvl(x.ie_gera_lote_separado,'N') = 'N'
	and	coalesce(c.dt_baixa::text, '') = ''
	and	coalesce(b.qt_dispensar_hor,0) > 0
	and	(b.nr_seq_turno IS NOT NULL AND b.nr_seq_turno::text <> '')
	and	(b.nr_seq_classif IS NOT NULL AND b.nr_seq_classif::text <> '')
	and (ie_somente_gerar_acm_sn_w = 'N' or (c.ie_se_necessario = 'S' or c.ie_acm = 'S'))
	and	((ie_gerar_lote_null_w = 'S') or (c.ds_horarios IS NOT NULL AND c.ds_horarios::text <> '') or (ie_origem_lote_p = 'AIP'))
	and	((ie_gerar_acm_w = 'S') or (ie_gerar_acm_w = 'N' and coalesce(c.ie_acm, 'N') = 'N') or 
		 ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(a.cd_setor_atendimento) = 4)) or (obter_se_hor_dose_especial(b.nr_sequencia) = 'S'))
	and	((ie_gerar_sn_w = 'S') or (ie_gerar_sn_w = 'N' and coalesce(c.ie_se_necessario, 'N') = 'N') or 
		 ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(a.cd_setor_atendimento) = 4)) or (obter_se_hor_dose_especial(b.nr_sequencia) = 'S'))
	and	((ie_origem_lote_p <> 'AIS') or	(ie_origem_lote_p = 'AIS' AND b.ie_aprazado = 'S'))
	and	((ie_gera_lote_orig_w = 'N') or ((ie_origem_lote_p <> 'AIP') or (coalesce(b.ie_aprazado,'N') = 'S')))
	and	((ie_gera_lote_medic_pac_w = 'S') or ((ie_gera_lote_medic_pac_w = 'N') and (coalesce(ie_medicacao_paciente,'N') = 'N')))
	and	((ie_gerar_lote_area_w = 'S') or (coalesce(b.nr_seq_area_prep::text, '') = ''))
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	and	obter_se_local_gera_lote(coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque))) = 'S'
	and 	((coalesce(ie_gera_lote_separado_w,'N') = 'N') or ((coalesce(ie_gera_lote_separado_w,'N') = 'S') and (coalesce(x.ie_gera_lote_separado,'N') = 'N')))
	and	((coalesce(x.ie_termolabil,'N') = 'N') or (coalesce(nr_seq_regra_termo_w,0) = 0))
	and	((coalesce(ie_itens_associados_termo_w,'N') = 'N') or
		((ie_itens_associados_termo_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from material z where z.cd_material = d.cd_material and z.ie_termolabil = 'S')
									
union

									select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and		d.nr_sequencia = c.nr_sequencia_diluicao
									and exists (select 1 from material z where z.cd_material = d.cd_material and z.ie_termolabil = 'S'))))
	and	((obter_se_material_risco(a.cd_setor_atendimento,b.cd_material) = 'N') or (coalesce(nr_seq_regra_alto_risco_w,0) = 0))
	and	((coalesce(ie_itens_associados_w,'N') = 'N') or
		((ie_itens_associados_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and exists (select 1 from material_risco z where z.cd_material = d.cd_material and z.ie_material_risco = 'S' and z.cd_estabelecimento = a.cd_estabelecimento))))
	and	((obter_se_mat_alto_custo(b.cd_material,coalesce(a.cd_estabelecimento,1)) = 'N') or (coalesce(nr_seq_regra_alto_custo_w,0) = 0))
	and	((coalesce(ie_itens_associados_custo_w,'N') = 'N') or
		((ie_itens_associados_custo_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and exists (select 1 from material_estab z where z.cd_material = d.cd_material and z.cd_estabelecimento = a.cd_estabelecimento and z.ie_classif_custo = 'A'))))
	and	((ie_origem_lote_p <> 'AIS') or ((ie_origem_lote_p = 'AIS') and (coalesce(b.ie_horario_especial, 'N') = 'N') and exists (select	1
															from	prescr_mat_hor d
															where	d.nr_prescricao   = c.nr_prescricao															   and	   d.nr_seq_material = c.nr_seq_kit
															and	d.ie_agrupador in (4,13))))
	and	((coalesce(x.ie_controle_medico,0) <> 2) or (coalesce(nr_seq_regra_ccih_w,0) = 0))
	and	((coalesce(ie_itens_associados_ccih_w,'N') = 'N') or
		((ie_itens_associados_ccih_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from material z where z.cd_material = d.cd_material and coalesce(z.ie_controle_medico,0) = 2 and (cd_medicamento IS NOT NULL AND cd_medicamento::text <> '')))))
	and	((obter_se_medic_controlado(b.cd_material) = 'N') or (coalesce(nr_seq_regra_controlado_w,0) = 0))
		and	((coalesce(ie_itens_assoc_controlado_w,'N') = 'N') 
	or	((ie_itens_assoc_controlado_w = 'S') 
	and not exists (	select	1
					from	prescr_mat_hor d
					where	d.nr_prescricao = c.nr_prescricao
					and 	coalesce(d.nr_seq_superior::text, '') = ''
					and 	obter_se_associado(d.nr_prescricao, b.nr_seq_superior, d.nr_seq_material) = 'S'
					and 	exists (select	1 from medic_controlado z where 	z.cd_material = d.cd_material and 	z.ie_situacao = 'A' and	coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w)
					
union

					select	1
					from	prescr_material d
					where	d.nr_prescricao = c.nr_prescricao
					and		d.nr_sequencia = c.nr_sequencia_diluicao
					and exists (select 1 from medic_controlado z where z.cd_material = d.cd_material and z.ie_situacao = 'A' and coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w))))
	and	((coalesce(c.ie_acm,'N') = 'N') or (coalesce(nr_seq_regra_acm_w,0) = 0))
	and	((coalesce(ie_itens_assoc_acm_w,'N') = 'N') or
		((ie_itens_assoc_acm_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and	coalesce(d.ie_acm,'N') = 'S'
								
union

                select	1
                from	prescr_material d
                where	d.nr_prescricao = c.nr_prescricao
                and	d.nr_sequencia = c.nr_sequencia_diluicao
                and coalesce(d.ie_acm,'N') = 'S')))
	and	((coalesce(c.ie_se_necessario,'N') = 'N') or (coalesce(nr_seq_regra_sn_w,0) = 0))
	and	((coalesce(ie_itens_assoc_sn_w,'N') = 'N') or
		((ie_itens_assoc_sn_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and	coalesce(d.ie_se_necessario,'N') = 'S'
								
union

                select	1
                from	prescr_material d
                where	d.nr_prescricao = c.nr_prescricao
                and	d.nr_sequencia = c.nr_sequencia_diluicao
                and coalesce(d.ie_se_necessario,'N') = 'S')))
	and	((coalesce(c.nr_seq_recomendacao,0) = 0) or (coalesce(nr_seq_regra_recomend_w,0) = 0))
	and	((coalesce(ie_itens_assoc_recomend_w,'N') = 'N') or
		((ie_itens_assoc_recomend_w = 'S') and not exists (	select	1
									from	prescr_recomendacao d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = c.nr_seq_recomendacao)))								
	
union all

	select  b.cd_material,
		b.nr_sequencia,
		b.cd_unidade_medida,
		b.qt_dispensar,
		b.qt_dispensar_hor,
		coalesce(b.nr_seq_turno,-1),
		b.dt_horario,
		to_char(b.dt_horario,'hh24:mi'),
		coalesce(a.cd_estabelecimento,1),
		b.ie_urgente,
		b.nr_seq_classif,
		coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)) cd_local,
		c.nr_sequencia,
		b.ie_aprazado,
		4 vl_union,
		b.ie_dose_especial,
		c.ie_medicacao_paciente,
		b.ie_agrupador,
		c.nr_seq_mat_diluicao
	from	material x,
		prescr_mat_hor  b,
		prescr_material c,
		prescr_solucao d,
		prescr_medica   a
	where	a.nr_prescricao = b.nr_prescricao
	and	a.nr_prescricao	= c.nr_prescricao
	and	c.nr_sequencia	= b.nr_seq_material
	and	c.nr_prescricao = d.nr_prescricao
	and	x.cd_material	= c.cd_material
	and	coalesce(x.ie_gerar_lote,'S') = 'S'
	and	coalesce(c.ie_suspenso,'N') <> 'S'
	and	coalesce(a.dt_suspensao::text, '') = ''	
	and	coalesce(b.dt_suspensao::text, '') = ''	
	and	Obter_se_setor_lote(a.cd_setor_atendimento) = 'S'
	and	((ie_gerar_lote_agora_w = 'S') or (coalesce(c.ie_urgencia,'N') = 'N') or (c.ie_agrupador = 2))
	and	c.nr_sequencia_solucao = d.nr_seq_solucao
	and	a.nr_prescricao = nr_prescricao_p
	and	((coalesce(nr_etapa_p,0) = 0) or (b.nr_etapa_sol = nr_etapa_p AND ie_origem_lote_p = 'GASR'))
	and	((VarNaoGerarSoPrimeiraEtapa_w = 'N') or (c.nr_sequencia_solucao = coalesce(nr_sequencia_p, 0)) or (b.nr_etapa_sol = 1) or ((ie_origem_lote_p = 'GASR') and (coalesce(nr_sequencia_p, 0) = 0)))
	and	coalesce(b.nr_seq_lote::text, '') = ''
	and	c.ie_agrupador in (4,13)
	and	(c.nr_sequencia_solucao IS NOT NULL AND c.nr_sequencia_solucao::text <> '') 
	and	coalesce(c.cd_motivo_baixa,0) = 0
	and	coalesce(b.qt_dispensar_hor,0) > 0
	and	coalesce(b.ie_gerar_lote,'S') = 'S'
	and	coalesce(c.ie_gerar_lote,'S') = 'S'
	and (coalesce(b.ie_horario_especial, 'N') = 'N' or (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''))
	and	coalesce(c.dt_baixa::text, '') = ''
	and	(b.nr_seq_turno IS NOT NULL AND b.nr_seq_turno::text <> '')
	and	(b.nr_seq_classif IS NOT NULL AND b.nr_seq_classif::text <> '')
	--and 	nvl(x.ie_gera_lote_separado,'N') = 'N'
	and	coalesce(ie_gerar_lote_solucao_w, 'S') = 'S'
	and (ie_somente_gerar_acm_sn_w = 'N' or (c.ie_se_necessario = 'S' or c.ie_acm = 'S'))
	and	((ie_gerar_lote_null_w = 'S') or (d.hr_prim_horario IS NOT NULL AND d.hr_prim_horario::text <> '') or (ie_origem_lote_p in ('AIP', 'AIS')))
	and	((ie_gerar_acm_w = 'S') or (ie_gerar_acm_w = 'N' and coalesce(c.ie_acm, 'N') = 'N') or 
		 ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(a.cd_setor_atendimento) = 4)) or (obter_se_hor_dose_especial(b.nr_sequencia) = 'S'))
	and	((ie_gerar_sn_w = 'S') or (ie_gerar_sn_w = 'N' and coalesce(c.ie_se_necessario, 'N') = 'N') or 
		 ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(a.cd_setor_atendimento) = 4)) or (obter_se_hor_dose_especial(b.nr_sequencia) = 'S'))
	and	((ie_origem_lote_p <> 'AIS') or	(ie_origem_lote_p = 'AIS' AND b.ie_aprazado = 'S'))
	and	((ie_origem_lote_p <> 'AIP') or	(ie_origem_lote_p = 'AIP' AND b.ie_aprazado = 'S'))
	and	((ie_gera_lote_orig_w = 'N') or ((ie_origem_lote_p <> 'AIP') or (coalesce(b.ie_aprazado,'N') = 'S')))
	and	((ie_gerar_lote_area_w = 'S') or (coalesce(b.nr_seq_area_prep::text, '') = ''))
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	and	obter_se_local_gera_lote(coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque))) = 'S'
	and 	ie_gerar_solucao_separado_w = 'N'
	and 	((coalesce(ie_gera_lote_separado_w,'N') = 'N') or ((coalesce(ie_gera_lote_separado_w,'N') = 'S') and (coalesce(x.ie_gera_lote_separado,'N') = 'N')))
	and	((coalesce(x.ie_termolabil,'N') = 'N') or (coalesce(nr_seq_regra_termo_w,0) = 0))
	and	((coalesce(ie_itens_associados_termo_w,'N') = 'N') or
		((ie_itens_associados_termo_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from material z where z.cd_material = d.cd_material and z.ie_termolabil = 'S')
									
union

									select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and		d.nr_sequencia = c.nr_sequencia_diluicao
									and exists (select 1 from material z where z.cd_material = d.cd_material and z.ie_termolabil = 'S'))))
	and	((obter_se_material_risco(a.cd_setor_atendimento,b.cd_material) = 'N') or (coalesce(nr_seq_regra_alto_risco_w,0) = 0))
	and	((coalesce(ie_itens_associados_w,'N') = 'N') or
		((ie_itens_associados_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and exists (select 1 from material_risco z where z.cd_material = d.cd_material and z.ie_material_risco = 'S' and z.cd_estabelecimento = a.cd_estabelecimento)
								
union

								select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and		d.nr_sequencia = c.nr_sequencia_diluicao
								and exists (select 1 from material_risco z where z.cd_material = d.cd_material and z.ie_material_risco = 'S' and z.cd_estabelecimento = a.cd_estabelecimento))))
	and	((obter_se_mat_alto_custo(b.cd_material,coalesce(a.cd_estabelecimento,1)) = 'N') or (coalesce(nr_seq_regra_alto_custo_w,0) = 0))
	and	((coalesce(ie_itens_associados_custo_w,'N') = 'N') or
		((ie_itens_associados_custo_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and exists (select 1 from material_estab z where z.cd_material = d.cd_material and z.cd_estabelecimento = a.cd_estabelecimento and z.ie_classif_custo = 'A'))))
	and	((coalesce(x.ie_controle_medico,0) <> 2) or (coalesce(nr_seq_regra_ccih_w,0) = 0))
	and	((coalesce(ie_itens_associados_ccih_w,'N') = 'N') or
		((ie_itens_associados_ccih_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from material z where z.cd_material = d.cd_material and coalesce(z.ie_controle_medico,0) = 2 and (cd_medicamento IS NOT NULL AND cd_medicamento::text <> '')))))
	and	((obter_se_medic_controlado(b.cd_material) = 'N') or (coalesce(nr_seq_regra_controlado_w,0) = 0))
	and	((coalesce(ie_itens_assoc_controlado_w,'N') = 'N') 
	or	((ie_itens_assoc_controlado_w = 'S') 
	and not exists (	select	1
					from	prescr_mat_hor d
					where	d.nr_prescricao = c.nr_prescricao
					and 	coalesce(d.nr_seq_superior::text, '') = ''
					and 	obter_se_associado(d.nr_prescricao, b.nr_seq_superior, d.nr_seq_material) = 'S'
					and 	exists (select	1 from medic_controlado z where 	z.cd_material = d.cd_material and 	z.ie_situacao = 'A' and	coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w)
					
union

					select	1
					from	prescr_material d
					where	d.nr_prescricao = c.nr_prescricao
					and		d.nr_sequencia = c.nr_sequencia_diluicao
					and exists (select 1 from medic_controlado z where z.cd_material = d.cd_material and z.ie_situacao = 'A' and coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w))))
	and	((coalesce(c.ie_acm,'N') = 'N') or (coalesce(nr_seq_regra_acm_w,0) = 0))
	and	((coalesce(ie_itens_assoc_acm_w,'N') = 'N') or
		((ie_itens_assoc_acm_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and	coalesce(d.ie_acm,'N') = 'S'
								
union

                select	1
                from	prescr_material d
                where	d.nr_prescricao = c.nr_prescricao
                and	d.nr_sequencia = c.nr_sequencia_diluicao
                and coalesce(d.ie_acm,'N') = 'S')))
	and	((coalesce(c.ie_se_necessario,'N') = 'N') or (coalesce(nr_seq_regra_sn_w,0) = 0))
	and	((coalesce(ie_itens_assoc_sn_w,'N') = 'N') or
		((ie_itens_assoc_sn_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and	coalesce(d.ie_se_necessario,'N') = 'S'
								
union

                select	1
                from	prescr_material d
                where	d.nr_prescricao = c.nr_prescricao
                and	d.nr_sequencia = c.nr_sequencia_diluicao
                and coalesce(d.ie_se_necessario,'N') = 'S')))
	and	((coalesce(c.nr_seq_recomendacao,0) = 0) or (coalesce(nr_seq_regra_recomend_w,0) = 0))
	and	((coalesce(ie_itens_assoc_recomend_w,'N') = 'N') or
		((ie_itens_assoc_recomend_w = 'S') and not exists (	select	1
									from	prescr_recomendacao d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = c.nr_seq_recomendacao)))								
	order by cd_local,
		 nr_seq_classif,
		 dt_horario,
		 ie_medicacao_paciente;

/*Para os itens que nao sao padronizadas e no caso do hospital utilizar apenas um lote para os nao padronizados.*/

C001 CURSOR FOR
	SELECT  b.cd_material,
		b.nr_sequencia,
		b.cd_unidade_medida,
		b.qt_dispensar,
		b.qt_dispensar_hor,
		coalesce(b.nr_seq_turno,-1),
		b.dt_horario,
		to_char(b.dt_horario,'hh24:mi'),
		coalesce(a.cd_estabelecimento,1),
		b.ie_urgente,
		b.nr_seq_classif,
		coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)) cd_local,
		c.nr_sequencia,
		1 vl_union,
		b.ie_dose_especial
	from	material x,
		prescr_mat_hor  b,
		prescr_material c,
		prescr_medica   a
	where	a.nr_prescricao = b.nr_prescricao
	and	a.nr_prescricao = nr_prescricao_p
	and	x.cd_material	= c.cd_material
	and	coalesce(x.ie_gerar_lote,'S') = 'S'
	and	((coalesce(nr_sequencia_p, 0) = 0) or (c.nr_sequencia = nr_sequencia_p))
	and	((coalesce(nr_seq_horario_p, 0) = 0) or (b.nr_sequencia = nr_seq_horario_p))
	and	((coalesce(ie_so_aprazado_p, 'N') = 'N') or (coalesce(ie_so_aprazado_p, 'N') = ie_aprazado))
	and	coalesce(b.ie_situacao,'A') <> 'I'
	and	coalesce(c.ie_suspenso,'N') <> 'S'
	and	coalesce(a.dt_suspensao::text, '') = ''
	and	c.cd_motivo_baixa = 0
	and	coalesce(c.dt_baixa::text, '') = ''
	and	a.nr_prescricao	= c.nr_prescricao
	and	c.nr_sequencia	= b.nr_seq_material
	and	(b.nr_seq_turno IS NOT NULL AND b.nr_seq_turno::text <> '')
	and	(b.nr_seq_classif IS NOT NULL AND b.nr_seq_classif::text <> '')
	and	(ie_classif_nao_padrao_w IS NOT NULL AND ie_classif_nao_padrao_w::text <> '')
	and (ie_somente_gerar_acm_sn_w = 'N' or (c.ie_se_necessario = 'S' or c.ie_acm = 'S'))
	and	((ie_gerar_lote_null_w = 'S') or (c.ds_horarios IS NOT NULL AND c.ds_horarios::text <> '') or (ie_origem_lote_p = 'AIP'))
	and	(((coalesce(b.ie_padronizado,'S') = 'N') and (coalesce(b.nr_seq_superior::text, '') = '')) or
		 ((coalesce(b.ie_padronizado,'S') = 'N') and (b.nr_seq_superior IS NOT NULL AND b.nr_seq_superior::text <> '') and exists (	SELECT	1
												from	prescr_material p,
													material_estab o
												where	p.nr_prescricao = b.nr_prescricao
												and	p.nr_sequencia = b.nr_seq_superior
												and	p.cd_material = o.cd_material
												and	coalesce(o.ie_padronizado,'S') = 'N'
												and	o.cd_estabelecimento = a.cd_estabelecimento)) or
		 ((coalesce(b.ie_padronizado,'S') = 'S') and (b.nr_seq_superior IS NOT NULL AND b.nr_seq_superior::text <> '') and exists (	select	1
												from	prescr_material d,
													material_estab t
												where	d.nr_prescricao = b.nr_prescricao
												and	d.nr_sequencia = b.nr_seq_superior
												and	d.cd_material = t.cd_material
												and	coalesce(t.ie_padronizado,'S') = 'N'
												and	t.cd_estabelecimento = a.cd_estabelecimento)))
	and	coalesce(b.ie_gerar_lote,'S') = 'S'
	and	coalesce(c.ie_gerar_lote,'S') = 'S'
	and	coalesce(b.ie_horario_especial, 'N') = 'N'
	and	coalesce(b.qt_dispensar_hor,0) > 0
	and	coalesce(c.nr_sequencia_solucao::text, '') = ''
	and	coalesce(b.nr_seq_lote::text, '') = ''
	and 	((VarNaoGerarSoPrimeiraEtapa_w = 'N') or (coalesce(b.nr_etapa_sol,1) = 1) or (ie_origem_lote_p = 'GASR'))
	and	Obter_se_setor_lote(a.cd_setor_atendimento) = 'S'
	and	((ie_gerar_lote_agora_w = 'S') or (coalesce(c.ie_urgencia,'N') = 'N') or (c.ie_agrupador = 2))
	and	((ie_gerar_acm_w = 'S') or (ie_gerar_acm_w = 'N' and coalesce(c.ie_acm, 'N') = 'N') or
		 ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(a.cd_setor_atendimento) = 4)) or (obter_se_hor_dose_especial(b.nr_sequencia) = 'S'))
	and	((ie_gerar_sn_w = 'S') or (ie_gerar_sn_w = 'N' and coalesce(c.ie_se_necessario, 'N') = 'N') or 
		 ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(a.cd_setor_atendimento) = 4)) or (obter_se_hor_dose_especial(b.nr_sequencia) = 'S'))
	and	((ie_gera_lote_orig_w = 'N') or ((ie_origem_lote_p <> 'AIP') or (coalesce(b.ie_aprazado,'N') = 'S')))
	and	((ie_gera_lote_medic_pac_w = 'S') or ((ie_gera_lote_medic_pac_w = 'N') and (coalesce(ie_medicacao_paciente,'N') = 'N')))
	and	((ie_gerar_lote_area_w = 'S') or (coalesce(b.nr_seq_area_prep::text, '') = ''))
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	and	obter_se_local_gera_lote(coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque))) = 'S'
	and ((coalesce(ie_gera_lote_separado_w,'N') = 'N') or ((coalesce(ie_gera_lote_separado_w,'N') = 'S') and (coalesce(x.ie_gera_lote_separado,'N') = 'N')))
	and	((ie_origem_lote_p <> 'AIS') or ((ie_origem_lote_p = 'AIS') and (coalesce(b.ie_horario_especial, 'N') = 'N') and exists (select	1
															from	prescr_mat_hor d
															where	d.nr_prescricao   = c.nr_prescricao						  									   and	   d.nr_seq_material = c.nr_seq_kit
															and	d.ie_agrupador in (4,13))))
	and	((coalesce(x.ie_termolabil,'N') = 'N') or (coalesce(nr_seq_regra_termo_w,0) = 0))
	and	((coalesce(ie_itens_associados_termo_w,'N') = 'N') or
		((ie_itens_associados_termo_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from material z where z.cd_material = d.cd_material and z.ie_termolabil = 'S')
									
union

									select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and		d.nr_sequencia = c.nr_sequencia_diluicao
									and exists (select 1 from material z where z.cd_material = d.cd_material and z.ie_termolabil = 'S'))))
	and	((obter_se_material_risco(a.cd_setor_atendimento,b.cd_material) = 'N') or (coalesce(nr_seq_regra_alto_risco_w,0) = 0))
	and	((coalesce(ie_itens_associados_w,'N') = 'N') or
		((ie_itens_associados_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and exists (select 1 from material_risco z where z.cd_material = d.cd_material and z.ie_material_risco = 'S' and z.cd_estabelecimento = a.cd_estabelecimento))))
	and	((obter_se_mat_alto_custo(b.cd_material,coalesce(a.cd_estabelecimento,1)) = 'N') or (coalesce(nr_seq_regra_alto_custo_w,0) = 0))
	and	((coalesce(ie_itens_associados_custo_w,'N') = 'N') or
		((ie_itens_associados_custo_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and exists (select 1 from material_estab z where z.cd_material = d.cd_material and z.cd_estabelecimento = a.cd_estabelecimento and z.ie_classif_custo = 'A'))))
	and	((coalesce(x.ie_controle_medico,0) <> 2) or (coalesce(nr_seq_regra_ccih_w,0) = 0))
	and	((coalesce(ie_itens_associados_ccih_w,'N') = 'N') or
		((ie_itens_associados_ccih_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from material z where z.cd_material = d.cd_material and coalesce(z.ie_controle_medico,0) = 2 and (cd_medicamento IS NOT NULL AND cd_medicamento::text <> '')))))
	and	((obter_se_medic_controlado(b.cd_material) = 'N') or (coalesce(nr_seq_regra_controlado_w,0) = 0))
	and	((coalesce(ie_itens_assoc_controlado_w,'N') = 'N') 
	or	((ie_itens_assoc_controlado_w = 'S') 
	and not exists (	select	1
					from	prescr_mat_hor d
					where	d.nr_prescricao = c.nr_prescricao
					and 	coalesce(d.nr_seq_superior::text, '') = ''
					and 	obter_se_associado(d.nr_prescricao, b.nr_seq_superior, d.nr_seq_material) = 'S'
					and 	exists (select	1 from medic_controlado z where 	z.cd_material = d.cd_material and 	z.ie_situacao = 'A' and	coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w)
					
union

					select	1
					from	prescr_material d
					where	d.nr_prescricao = c.nr_prescricao
					and		d.nr_sequencia = c.nr_sequencia_diluicao
					and exists (select 1 from medic_controlado z where z.cd_material = d.cd_material and z.ie_situacao = 'A' and coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w))))
	and	((coalesce(c.ie_acm,'N') = 'N') or (coalesce(nr_seq_regra_acm_w,0) = 0))
	and	((coalesce(ie_itens_assoc_acm_w,'N') = 'N') or
		((ie_itens_assoc_acm_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and	coalesce(d.ie_acm,'N') = 'S'
								
union

                select	1
                from	prescr_material d
                where	d.nr_prescricao = c.nr_prescricao
                and	d.nr_sequencia = c.nr_sequencia_diluicao
                and coalesce(d.ie_acm,'N') = 'S')))
	and	((coalesce(c.ie_se_necessario,'N') = 'N') or (coalesce(nr_seq_regra_sn_w,0) = 0))
	and	((coalesce(ie_itens_assoc_sn_w,'N') = 'N') or
		((ie_itens_assoc_sn_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and	coalesce(d.ie_se_necessario,'N') = 'S'
								
union

                select	1
                from	prescr_material d
                where	d.nr_prescricao = c.nr_prescricao
                and	d.nr_sequencia = c.nr_sequencia_diluicao
                and coalesce(d.ie_se_necessario,'N') = 'S')))
	and	((coalesce(c.nr_seq_recomendacao,0) = 0) or (coalesce(nr_seq_regra_recomend_w,0) = 0))
	and	((coalesce(ie_itens_assoc_recomend_w,'N') = 'N') or
		((ie_itens_assoc_recomend_w = 'S') and not exists (	select	1
									from	prescr_recomendacao d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = c.nr_seq_recomendacao)))								
	
union all

	select  b.cd_material,
		b.nr_sequencia,
		b.cd_unidade_medida,
		b.qt_dispensar,
		b.qt_dispensar_hor,
		coalesce(b.nr_seq_turno,-1),
		b.dt_horario,
		to_char(b.dt_horario,'hh24:mi'),
		coalesce(a.cd_estabelecimento,1),
		b.ie_urgente,
		b.nr_seq_classif,
		coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)) cd_local,
		c.nr_sequencia,
		2 vl_union,
		b.ie_dose_especial
	from	material x,
		prescr_mat_hor  b,
		prescr_material c,
		prescr_medica   a
	where	a.nr_prescricao = b.nr_prescricao
	and	a.nr_prescricao	= c.nr_prescricao
	and	c.nr_sequencia	= b.nr_seq_material
	and	x.cd_material	= c.cd_material
	and	coalesce(x.ie_gerar_lote,'S') = 'S'
	and	a.nr_prescricao = nr_prescricao_p
	and	coalesce(nr_sequencia_p, 0) > 0
	and	coalesce(c.nr_sequencia_solucao::text, '') = ''
	and	coalesce(b.nr_seq_lote::text, '') = ''
	and	b.nr_seq_superior = nr_sequencia_p
	and	c.cd_motivo_baixa = 0 /*OS 205363 rfcaldas*/
	and	coalesce(c.dt_baixa::text, '') = ''
	and	(b.nr_seq_turno IS NOT NULL AND b.nr_seq_turno::text <> '')
	and	(b.nr_seq_classif IS NOT NULL AND b.nr_seq_classif::text <> '')
	and	coalesce(b.ie_gerar_lote,'S') = 'S'
	and	coalesce(b.qt_dispensar_hor,0) > 0
	and	coalesce(c.ie_gerar_lote,'S') = 'S'
	and	coalesce(b.ie_horario_especial, 'N') = 'N'
	and	Obter_se_setor_lote(a.cd_setor_atendimento) = 'S'
	and	((ie_gerar_lote_agora_w = 'S') or (coalesce(c.ie_urgencia,'N') = 'N') or (c.ie_agrupador = 2))
	and (ie_somente_gerar_acm_sn_w = 'N' or (c.ie_se_necessario = 'S' or c.ie_acm = 'S'))
	and	((ie_gerar_lote_null_w = 'S') or (c.ds_horarios IS NOT NULL AND c.ds_horarios::text <> '') or (ie_origem_lote_p = 'AIP'))
	and	((ie_gerar_acm_w = 'S') or (ie_gerar_acm_w = 'N' and coalesce(c.ie_acm, 'N') = 'N') or 
		 ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(a.cd_setor_atendimento) = 4)) or (obter_se_hor_dose_especial(b.nr_sequencia) = 'S'))
	and	((ie_gerar_sn_w = 'S') or (ie_gerar_sn_w = 'N' and coalesce(c.ie_se_necessario, 'N') = 'N') or 
		 ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(a.cd_setor_atendimento) = 4)) or (obter_se_hor_dose_especial(b.nr_sequencia) = 'S'))
	and	((ie_origem_lote_p <> 'AIS') or	(ie_origem_lote_p = 'AIS' AND b.ie_aprazado = 'S'))
	and	((ie_gera_lote_orig_w = 'N') or ((ie_origem_lote_p <> 'AIP') or (coalesce(b.ie_aprazado,'N') = 'S')))
	and	((ie_gera_lote_medic_pac_w = 'S') or ((ie_gera_lote_medic_pac_w = 'N') and (coalesce(ie_medicacao_paciente,'N') = 'N')))
	and	((ie_gerar_lote_area_w = 'S') or (coalesce(b.nr_seq_area_prep::text, '') = ''))
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	and	obter_se_local_gera_lote(coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque))) = 'S'
	and 	((coalesce(ie_gera_lote_separado_w,'N') = 'N') or ((coalesce(ie_gera_lote_separado_w,'N') = 'S') and (coalesce(x.ie_gera_lote_separado,'N') = 'N')))
	and	((ie_origem_lote_p <> 'AIS') or ((ie_origem_lote_p = 'AIS') and (coalesce(b.ie_horario_especial, 'N') = 'N') and exists (	select	1
															from	prescr_mat_hor d
															where	d.nr_prescricao   = c.nr_prescricao															   and	   d.nr_seq_material = c.nr_seq_kit
															and	d.ie_agrupador in (4,13))))
	and	exists (	select	1
			from	prescr_material d,
				material o
			where	d.nr_prescricao = c.nr_prescricao
			and	d.nr_sequencia = b.nr_seq_superior
			and	d.cd_material = o.cd_material
			and	coalesce(o.ie_padronizado,'S') = 'N')
	and	((coalesce(c.ie_se_necessario,'N') = 'N') or (coalesce(nr_seq_regra_sn_w,0) = 0))
	and	((coalesce(ie_itens_assoc_sn_w,'N') = 'N') or
		((ie_itens_assoc_sn_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and	coalesce(d.ie_se_necessario,'N') = 'S'
								
union

                select	1
                from	prescr_material d
                where	d.nr_prescricao = c.nr_prescricao
                and	d.nr_sequencia = c.nr_sequencia_diluicao
                and coalesce(d.ie_se_necessario,'N') = 'S')))
		and	((coalesce(x.ie_termolabil,'N') = 'N') or (coalesce(nr_seq_regra_termo_w,0) = 0))
	and	((coalesce(ie_itens_associados_termo_w,'N') = 'N') or
		((ie_itens_associados_termo_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from material z where z.cd_material = d.cd_material and z.ie_termolabil = 'S')
									
union

									select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and		d.nr_sequencia = c.nr_sequencia_diluicao
									and exists (select 1 from material z where z.cd_material = d.cd_material and z.ie_termolabil = 'S'))))and	((obter_se_material_risco(a.cd_setor_atendimento,b.cd_material) = 'N') or (coalesce(nr_seq_regra_alto_risco_w,0) = 0))
	and	((coalesce(ie_itens_associados_w,'N') = 'N') or
		((ie_itens_associados_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and exists (select 1 from material_risco z where z.cd_material = d.cd_material and z.ie_material_risco = 'S' and z.cd_estabelecimento = a.cd_estabelecimento))))
	and	((obter_se_mat_alto_custo(b.cd_material,coalesce(a.cd_estabelecimento,1)) = 'N') or (coalesce(nr_seq_regra_alto_custo_w,0) = 0))
	and	((coalesce(ie_itens_associados_custo_w,'N') = 'N') or
		((ie_itens_associados_custo_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and exists (select 1 from material_estab z where z.cd_material = d.cd_material and z.cd_estabelecimento = a.cd_estabelecimento and z.ie_classif_custo = 'A'))))
	and	((coalesce(x.ie_controle_medico,0) <> 2) or (coalesce(nr_seq_regra_ccih_w,0) = 0))
	and	((coalesce(ie_itens_associados_ccih_w,'N') = 'N') or
		((ie_itens_associados_ccih_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from material z where z.cd_material = d.cd_material and coalesce(z.ie_controle_medico,0) = 2 and (cd_medicamento IS NOT NULL AND cd_medicamento::text <> '')))))
	and	((obter_se_medic_controlado(b.cd_material) = 'N') or (coalesce(nr_seq_regra_controlado_w,0) = 0))
	and	((coalesce(ie_itens_assoc_controlado_w,'N') = 'N') 
	or	((ie_itens_assoc_controlado_w = 'S') 
	and not exists (	select	1
					from	prescr_mat_hor d
					where	d.nr_prescricao = c.nr_prescricao
					and		d.nr_seq_material = b.nr_seq_superior
					and 	exists (select	1 from medic_controlado z where 	z.cd_material = d.cd_material and 	z.ie_situacao = 'A' and	coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w)
					
union

					select	1
					from	prescr_material d
					where	d.nr_prescricao = c.nr_prescricao
					and		d.nr_sequencia = c.nr_sequencia_diluicao
					and exists (select 1 from medic_controlado z where z.cd_material = d.cd_material and z.ie_situacao = 'A' and coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w))))
	and	((coalesce(c.ie_acm,'N') = 'N') or (coalesce(nr_seq_regra_acm_w,0) = 0))
	and	((coalesce(ie_itens_assoc_acm_w,'N') = 'N') or
		((ie_itens_assoc_acm_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and	coalesce(d.ie_acm,'N') = 'S'
								
union

                select	1
                from	prescr_material d
                where	d.nr_prescricao = c.nr_prescricao
                and	d.nr_sequencia = c.nr_sequencia_diluicao
                and coalesce(d.ie_acm,'N') = 'S')))
	and	((coalesce(c.ie_se_necessario,'N') = 'N') or (coalesce(nr_seq_regra_sn_w,0) = 0))
	and	((coalesce(ie_itens_assoc_sn_w,'N') = 'N') or
		((ie_itens_assoc_sn_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and	coalesce(d.ie_se_necessario,'N') = 'S'
								
union

                select	1
                from	prescr_material d
                where	d.nr_prescricao = c.nr_prescricao
                and	d.nr_sequencia = c.nr_sequencia_diluicao
                and coalesce(d.ie_se_necessario,'N') = 'S')))
	and	((coalesce(c.nr_seq_recomendacao,0) = 0) or (coalesce(nr_seq_regra_recomend_w,0) = 0))
	and	((coalesce(ie_itens_assoc_recomend_w,'N') = 'N') or
		((ie_itens_assoc_recomend_w = 'S') and not exists (	select	1
									from	prescr_recomendacao d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = c.nr_seq_recomendacao)))									
	
union all

	select  b.cd_material,
		b.nr_sequencia,
		b.cd_unidade_medida,
		b.qt_dispensar,
		b.qt_dispensar_hor,
		coalesce(b.nr_seq_turno,-1),
		b.dt_horario,
		to_char(b.dt_horario,'hh24:mi'),
		coalesce(a.cd_estabelecimento,1),
		b.ie_urgente,
		b.nr_seq_classif,
		coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)) cd_local,
		c.nr_sequencia,
		3 vl_union,
		b.ie_dose_especial
	from	material x,
		prescr_mat_hor  b,
		prescr_material c,
		prescr_medica   a
	where	a.nr_prescricao = b.nr_prescricao
	and	a.nr_prescricao	= c.nr_prescricao
	and	c.nr_sequencia	= b.nr_seq_material
	and	x.cd_material	= c.cd_material
	and	coalesce(x.ie_gerar_lote,'S') = 'S'
	and	coalesce(nr_sequencia_p, 0) > 0
	and	coalesce(b.qt_dispensar_hor,0) > 0
	and	coalesce(c.nr_sequencia_solucao::text, '') = ''
	and	coalesce(b.nr_seq_lote::text, '') = ''
	and	a.nr_prescricao = nr_prescricao_p
	and	c.cd_motivo_baixa = 0 /*OS 205363 rfcaldas*/
	and	coalesce(c.nr_seq_kit,0)	= nr_sequencia_p
	and	coalesce(c.dt_baixa::text, '') = ''
	and	coalesce(b.ie_gerar_lote,'S') = 'S'
	and	coalesce(c.ie_gerar_lote,'S') = 'S'
	and	coalesce(b.ie_horario_especial, 'N') = 'N'
	and	(b.nr_seq_turno IS NOT NULL AND b.nr_seq_turno::text <> '')
	and	(b.nr_seq_classif IS NOT NULL AND b.nr_seq_classif::text <> '')
	and	Obter_se_setor_lote(a.cd_setor_atendimento) = 'S'
	and	((ie_gerar_lote_agora_w = 'S') or (coalesce(c.ie_urgencia,'N') = 'N') or (c.ie_agrupador = 2))
	and (ie_somente_gerar_acm_sn_w = 'N' or (c.ie_se_necessario = 'S' or c.ie_acm = 'S'))
	and	((ie_gerar_lote_null_w = 'S') or (c.ds_horarios IS NOT NULL AND c.ds_horarios::text <> '') or (ie_origem_lote_p = 'AIP'))
	and	((ie_gerar_acm_w = 'S') or (ie_gerar_acm_w = 'N' and coalesce(c.ie_acm, 'N') = 'N') or 
		 ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(a.cd_setor_atendimento) = 4)) or (obter_se_hor_dose_especial(b.nr_sequencia) = 'S'))
	and	((ie_gerar_sn_w = 'S') or (ie_gerar_sn_w = 'N' and coalesce(c.ie_se_necessario, 'N') = 'N') or 
		 ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(a.cd_setor_atendimento) = 4)) or (obter_se_hor_dose_especial(b.nr_sequencia) = 'S'))
	and	((ie_origem_lote_p <> 'AIS') or	(ie_origem_lote_p = 'AIS' AND b.ie_aprazado = 'S'))
	and	((ie_gera_lote_orig_w = 'N') or ((ie_origem_lote_p <> 'AIP') or (coalesce(b.ie_aprazado,'N') = 'S')))
	and	((ie_gera_lote_medic_pac_w = 'S') or ((ie_gera_lote_medic_pac_w = 'N') and (coalesce(ie_medicacao_paciente,'N') = 'N')))
	and	((ie_gerar_lote_area_w = 'S') or (coalesce(b.nr_seq_area_prep::text, '') = ''))
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	and	obter_se_local_gera_lote(coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque))) = 'S'
	and 	((coalesce(ie_gera_lote_separado_w,'N') = 'N') or ((coalesce(ie_gera_lote_separado_w,'N') = 'S') and (coalesce(x.ie_gera_lote_separado,'N') = 'N')))
	and	((ie_origem_lote_p <> 'AIS') or ((ie_origem_lote_p = 'AIS') and (coalesce(b.ie_horario_especial, 'N') = 'N') and exists (	select	1
															from	prescr_mat_hor d
															where	d.nr_prescricao   = c.nr_prescricao															   and	   d.nr_seq_material = c.nr_seq_kit
															and	d.ie_agrupador in (4,13))))
	and	exists (	select	1
			from	prescr_material d,
				material o
			where	d.nr_prescricao = c.nr_prescricao
			and	d.nr_sequencia = b.nr_seq_superior
			and	d.cd_material = o.cd_material
			and	coalesce(o.ie_padronizado,'S') = 'N')
	and	((coalesce(x.ie_termolabil,'N') = 'N') or (coalesce(nr_seq_regra_termo_w,0) = 0))
	and	((coalesce(ie_itens_associados_termo_w,'N') = 'N') or
		((ie_itens_associados_termo_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from material z where z.cd_material = d.cd_material and z.ie_termolabil = 'S')
									
union

									select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and		d.nr_sequencia = c.nr_sequencia_diluicao
									and exists (select 1 from material z where z.cd_material = d.cd_material and z.ie_termolabil = 'S'))))
	and	((obter_se_material_risco(a.cd_setor_atendimento,b.cd_material) = 'N') or (coalesce(nr_seq_regra_alto_risco_w,0) = 0))
	and	((coalesce(ie_itens_associados_w,'N') = 'N') or
		((ie_itens_associados_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and exists (select 1 from material_risco z where z.cd_material = d.cd_material and z.ie_material_risco = 'S' and z.cd_estabelecimento = a.cd_estabelecimento))))
	and	((obter_se_mat_alto_custo(b.cd_material,coalesce(a.cd_estabelecimento,1)) = 'N') or (coalesce(nr_seq_regra_alto_custo_w,0) = 0))
	and	((coalesce(ie_itens_associados_custo_w,'N') = 'N') or
		((ie_itens_associados_custo_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and exists (select 1 from material_estab z where z.cd_material = d.cd_material and z.cd_estabelecimento = a.cd_estabelecimento and z.ie_classif_custo = 'A'))))
	and	((coalesce(x.ie_controle_medico,0) <> 2) or (coalesce(nr_seq_regra_ccih_w,0) = 0))
	and	((coalesce(ie_itens_associados_ccih_w,'N') = 'N') or
		((ie_itens_associados_ccih_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from material z where z.cd_material = d.cd_material and coalesce(z.ie_controle_medico,0) = 2 and (cd_medicamento IS NOT NULL AND cd_medicamento::text <> '')))))
	and	((obter_se_medic_controlado(b.cd_material) = 'N') or (coalesce(nr_seq_regra_controlado_w,0) = 0))
	and	((coalesce(ie_itens_assoc_controlado_w,'N') = 'N') 
	or	((ie_itens_assoc_controlado_w = 'S') 
	and not exists (	select	1
					from	prescr_mat_hor d
					where	d.nr_prescricao = c.nr_prescricao
					and		d.nr_seq_material = b.nr_seq_superior
					and 	exists (select	1 from medic_controlado z where 	z.cd_material = d.cd_material and 	z.ie_situacao = 'A' and	coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w)
					
union

					select	1
					from	prescr_material d
					where	d.nr_prescricao = c.nr_prescricao
					and		d.nr_sequencia = c.nr_sequencia_diluicao
					and exists (select 1 from medic_controlado z where z.cd_material = d.cd_material and z.ie_situacao = 'A' and coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w))))
	and	((coalesce(c.ie_acm,'N') = 'N') or (coalesce(nr_seq_regra_acm_w,0) = 0))
	and	((coalesce(ie_itens_assoc_acm_w,'N') = 'N') or
		((ie_itens_assoc_acm_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and	coalesce(d.ie_acm,'N') = 'S'
								
union

                select	1
                from	prescr_material d
                where	d.nr_prescricao = c.nr_prescricao
                and	d.nr_sequencia = c.nr_sequencia_diluicao
                and coalesce(d.ie_acm,'N') = 'S')))
	and	((coalesce(c.ie_se_necessario,'N') = 'N') or (coalesce(nr_seq_regra_sn_w,0) = 0))
	and	((coalesce(ie_itens_assoc_sn_w,'N') = 'N') or
		((ie_itens_assoc_sn_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and	coalesce(d.ie_se_necessario,'N') = 'S'
								
union

                select	1
                from	prescr_material d
                where	d.nr_prescricao = c.nr_prescricao
                and	d.nr_sequencia = c.nr_sequencia_diluicao
                and coalesce(d.ie_se_necessario,'N') = 'S')))
	and	((coalesce(c.nr_seq_recomendacao,0) = 0) or (coalesce(nr_seq_regra_recomend_w,0) = 0))
	and	((coalesce(ie_itens_assoc_recomend_w,'N') = 'N') or
		((ie_itens_assoc_recomend_w = 'S') and not exists (	select	1
									from	prescr_recomendacao d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = c.nr_seq_recomendacao)))
	
union all

	select  b.cd_material,
		b.nr_sequencia,
		b.cd_unidade_medida,
		b.qt_dispensar,
		b.qt_dispensar_hor,
		coalesce(b.nr_seq_turno,-1),
		b.dt_horario,
		to_char(b.dt_horario,'hh24:mi'),
		coalesce(a.cd_estabelecimento,1),
		b.ie_urgente,
		b.nr_seq_classif,
		coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque)) cd_local,
		c.nr_sequencia,
		4 vl_union,
		b.ie_dose_especial
	from	material x,
		prescr_mat_hor  b,
		prescr_material c,
		prescr_solucao d,
		prescr_medica   a
	where	a.nr_prescricao = b.nr_prescricao
	and	a.nr_prescricao	= c.nr_prescricao
	and	c.nr_sequencia	= b.nr_seq_material
	and	c.nr_prescricao = d.nr_prescricao
	and	c.nr_sequencia_solucao = d.nr_seq_solucao
	and	x.cd_material	= c.cd_material
	and	coalesce(x.ie_gerar_lote,'S') = 'S'
	and	a.nr_prescricao = nr_prescricao_p
	and	((coalesce(nr_etapa_p,0) = 0) or (b.nr_etapa_sol = nr_etapa_p AND ie_origem_lote_p = 'GASR'))
	and	((VarNaoGerarSoPrimeiraEtapa_w = 'N') or (c.nr_sequencia_solucao = coalesce(nr_sequencia_p, 0)) or (b.nr_etapa_sol = 1) or ((ie_origem_lote_p = 'GASR') and (coalesce(nr_sequencia_p, 0) = 0)))
	and	coalesce(b.nr_seq_lote::text, '') = ''
	and	c.ie_agrupador in (4,13)
	and	coalesce(c.cd_motivo_baixa,0) = 0
	and	coalesce(b.qt_dispensar_hor,0) > 0
	and	coalesce(c.dt_baixa::text, '') = ''
	and	(b.nr_seq_turno IS NOT NULL AND b.nr_seq_turno::text <> '')
	and	(b.nr_seq_classif IS NOT NULL AND b.nr_seq_classif::text <> '')
	and	Obter_se_setor_lote(a.cd_setor_atendimento) = 'S'
	and	((ie_gerar_lote_agora_w = 'S') or (coalesce(c.ie_urgencia,'N') = 'N') or (c.ie_agrupador = 2))
	and	(c.nr_sequencia_solucao IS NOT NULL AND c.nr_sequencia_solucao::text <> '')
	and	coalesce(b.ie_padronizado,'S') = 'N'
	and	coalesce(b.ie_gerar_lote,'S') = 'S'
	and	coalesce(c.ie_gerar_lote,'S') = 'S'
	and	coalesce(b.ie_horario_especial, 'N') = 'N'
	and	coalesce(ie_gerar_lote_solucao_w, 'S') = 'S'
	and (ie_somente_gerar_acm_sn_w = 'N' or (c.ie_se_necessario = 'S' or c.ie_acm = 'S'))	
	and	((ie_gerar_lote_null_w = 'S') or (d.hr_prim_horario IS NOT NULL AND d.hr_prim_horario::text <> '') or (ie_origem_lote_p = 'AIP'))
	and	((ie_gerar_acm_w = 'S') or (ie_gerar_acm_w = 'N' and coalesce(c.ie_acm, 'N') = 'N') or 
		 ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(a.cd_setor_atendimento) = 4)) or (obter_se_hor_dose_especial(b.nr_sequencia) = 'S'))
	and	((ie_gerar_sn_w = 'S') or (ie_gerar_sn_w = 'N' and coalesce(c.ie_se_necessario, 'N') = 'N') or 
		 ((ie_gerar_lote_acm_sn_uti_w = 'S') and (obter_classif_setor(a.cd_setor_atendimento) = 4)) or (obter_se_hor_dose_especial(b.nr_sequencia) = 'S'))
	and	((ie_origem_lote_p <> 'AIS') or	(ie_origem_lote_p = 'AIS' AND b.ie_aprazado = 'S'))
	and	((ie_origem_lote_p <> 'AIP') or	(ie_origem_lote_p = 'AIP' AND b.ie_aprazado = 'S'))
	and	((ie_gera_lote_orig_w = 'N') or ((ie_origem_lote_p <> 'AIP') or (coalesce(b.ie_aprazado,'N') = 'S')))
	and	((ie_gerar_lote_area_w = 'S') or (coalesce(b.nr_seq_area_prep::text, '') = ''))
	and	Obter_se_horario_liberado(b.dt_lib_horario, b.dt_horario) = 'S'
	and	obter_se_local_gera_lote(coalesce(b.cd_local_estoque,coalesce(c.cd_local_estoque,a.cd_local_estoque))) = 'S'
	and 	ie_gerar_solucao_separado_w = 'N'
	and 	((coalesce(ie_gera_lote_separado_w,'N') = 'N') or ((coalesce(ie_gera_lote_separado_w,'N') = 'S') and (coalesce(x.ie_gera_lote_separado,'N') = 'N')))
	and	((coalesce(x.ie_termolabil,'N') = 'N') or (coalesce(nr_seq_regra_termo_w,0) = 0))
	and	((coalesce(ie_itens_associados_termo_w,'N') = 'N') or
		((ie_itens_associados_termo_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from material z where z.cd_material = d.cd_material and z.ie_termolabil = 'S')
									
union

									select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and		d.nr_sequencia = c.nr_sequencia_diluicao
									and exists (select 1 from material z where z.cd_material = d.cd_material and z.ie_termolabil = 'S'))))
	and	((obter_se_material_risco(a.cd_setor_atendimento,b.cd_material) = 'N') or (coalesce(nr_seq_regra_alto_risco_w,0) = 0))
	and	((coalesce(ie_itens_associados_w,'N') = 'N') or
		((ie_itens_associados_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and exists (select 1 from material_risco z where z.cd_material = d.cd_material and z.ie_material_risco = 'S' and z.cd_estabelecimento = a.cd_estabelecimento))))
	and	((obter_se_mat_alto_custo(b.cd_material,coalesce(a.cd_estabelecimento,1)) = 'N') or (coalesce(nr_seq_regra_alto_custo_w,0) = 0))
	and	((coalesce(ie_itens_associados_custo_w,'N') = 'N') or
		((ie_itens_associados_custo_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and exists (select 1 from material_estab z where z.cd_material = d.cd_material and z.cd_estabelecimento = a.cd_estabelecimento and z.ie_classif_custo = 'A'))))
	and	((coalesce(x.ie_controle_medico,0) <> 2) or (coalesce(nr_seq_regra_ccih_w,0) = 0))
	and	((coalesce(ie_itens_associados_ccih_w,'N') = 'N') or
		((ie_itens_associados_ccih_w = 'S') and not exists (	select	1
									from	prescr_material d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = b.nr_seq_superior
									and exists (select 1 from material z where z.cd_material = d.cd_material and coalesce(z.ie_controle_medico,0) = 2 and (cd_medicamento IS NOT NULL AND cd_medicamento::text <> '')))))
	and	((obter_se_medic_controlado(b.cd_material) = 'N') or (coalesce(nr_seq_regra_controlado_w,0) = 0))
	and	((coalesce(ie_itens_assoc_controlado_w,'N') = 'N') 
	or	((ie_itens_assoc_controlado_w = 'S') 
	and not exists (	select	1
					from	prescr_mat_hor d
					where	d.nr_prescricao = c.nr_prescricao
					and		d.nr_seq_material = b.nr_seq_superior
					and 	exists (select	1 from medic_controlado z where 	z.cd_material = d.cd_material and 	z.ie_situacao = 'A' and	coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w)
					
union

					select	1
					from	prescr_material d
					where	d.nr_prescricao = c.nr_prescricao
					and		d.nr_sequencia = c.nr_sequencia_diluicao
					and exists (select 1 from medic_controlado z where z.cd_material = d.cd_material and z.ie_situacao = 'A' and coalesce(z.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w))))
	and	((coalesce(c.ie_acm,'N') = 'N') or (coalesce(nr_seq_regra_acm_w,0) = 0))
	and	((coalesce(ie_itens_assoc_acm_w,'N') = 'N') or
		((ie_itens_assoc_acm_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and	coalesce(d.ie_acm,'N') = 'S'
								
union

                select	1
                from	prescr_material d
                where	d.nr_prescricao = c.nr_prescricao
                and	d.nr_sequencia = c.nr_sequencia_diluicao
                and coalesce(d.ie_acm,'N') = 'S')))
	and	((coalesce(c.ie_se_necessario,'N') = 'N') or (coalesce(nr_seq_regra_sn_w,0) = 0))
	and	((coalesce(ie_itens_assoc_sn_w,'N') = 'N') or
		((ie_itens_assoc_sn_w = 'S') and not exists (	select	1
								from	prescr_material d
								where	d.nr_prescricao = c.nr_prescricao
								and	d.nr_sequencia = b.nr_seq_superior
								and	coalesce(d.ie_se_necessario,'N') = 'S'
								
union

                select	1
                from	prescr_material d
                where	d.nr_prescricao = c.nr_prescricao
                and	d.nr_sequencia = c.nr_sequencia_diluicao
                and coalesce(d.ie_se_necessario,'N') = 'S')))
	and	((coalesce(c.nr_seq_recomendacao,0) = 0) or (coalesce(nr_seq_regra_recomend_w,0) = 0))
	and	((coalesce(ie_itens_assoc_recomend_w,'N') = 'N') or
		((ie_itens_assoc_recomend_w = 'S') and not exists (	select	1
									from	prescr_recomendacao d
									where	d.nr_prescricao = c.nr_prescricao
									and	d.nr_sequencia = c.nr_seq_recomendacao)))								
	order by cd_local,
		 dt_horario;

C02 CURSOR FOR
	SELECT	to_char(b.hr_inicial,'hh24:mi')
	from	regra_turno_disp_param b,
		regra_turno_disp a
	where	a.nr_sequencia		= b.nr_seq_turno
	and	a.cd_estabelecimento	= cd_estabelecimento_w
	and	a.nr_sequencia		= nr_seq_turno_w
	and (coalesce(b.cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w)
	order by coalesce(b.cd_setor_atendimento,0),
		to_char(b.hr_inicial,'hh24:mi');
	
C03 CURSOR FOR
	SELECT	a.cd_setor_atendimento,
		a.nr_seq_turno,
		a.nr_seq_classif,
		a.qt_min_antes_atend,
		a.qt_min_receb_setor,
		a.qt_min_entr_setor,
		a.qt_min_disp_farm,
		a.qt_min_atend_farm,
		a.qt_min_inicio_atend,
		coalesce(a.ie_hora_antes,'H')
	from	regra_tempo_disp a
	where	a.cd_estabelecimento	= cd_estabelecimento_w
	and	coalesce(a.ie_situacao, 'A')	= 'A'
	and	exists(	SELECT	1
		from	ap_lote b
		where	b.nr_prescricao = nr_prescricao_p
		and	((coalesce(a.nr_seq_turno::text, '') = '') or (b.nr_seq_turno = a.nr_seq_turno))
		and	((coalesce(a.nr_seq_classif::text, '') = '') or (b.nr_seq_classif = a.nr_seq_classif))
		and	((coalesce(a.cd_setor_atendimento::text, '') = '') or (b.cd_setor_atendimento = a.cd_setor_atendimento)))
	order by coalesce(a.nr_seq_classif,0), 
		coalesce(a.nr_seq_turno,0),
		coalesce(a.cd_setor_atendimento,0);

C20 CURSOR FOR
	SELECT	cd_tipo_baixa
	from	regra_disp_lote_farm
	where	((ie_motivo_prescricao = ie_motivo_prescricao_w) or (coalesce(ie_motivo_prescricao::text, '') = ''))
	and		coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
	and		clock_timestamp() between to_date(to_char(clock_timestamp(),'dd/mm/yyyy')||' '||to_char(coalesce(dt_hora_inicio,clock_timestamp()),'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss') and
							to_date(to_char(clock_timestamp(),'dd/mm/yyyy')||' '||to_char(coalesce(dt_hora_fim,clock_timestamp()),'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss')
	and		coalesce(cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w
	and		PKG_DATE_UTILS.start_of(clock_timestamp(), 'dd', 0) between PKG_DATE_UTILS.start_of(dt_inicio_vigencia, 'dd', 0) and PKG_DATE_UTILS.start_of(coalesce(dt_fim_vigencia,clock_timestamp()), 'dd', 0)
	and		ie_situacao = 'A'
	and 	((ie_quimio_w <> 'S' and coalesce(ie_quimioterapicas,'N') <> 'S') or (ie_quimio_w = 'S'))
	order by	CASE WHEN ie_quimioterapicas='S' THEN 'Z'  ELSE CASE WHEN ie_quimioterapicas='N' THEN 'C'  ELSE 'B' END  END ,
		coalesce(cd_setor_atendimento,0), coalesce(ie_motivo_prescricao,0);
	
	
C04 CURSOR FOR
	SELECT	nr_sequencia
	from	ap_lote
	where	nr_prescricao = nr_prescricao_p
	order by nr_sequencia;

c05 CURSOR FOR
	SELECT	nr_sequencia
	from	regra_geracao_lote_sep
	where (coalesce(cd_estabelecimento::text, '') = '' or cd_estabelecimento = cd_estabelecimento_w)
	order by coalesce(nr_prioridade,999);

c06 CURSOR FOR
	SELECT	cd_material
	from	(SELECT	cd_material
		from	material
		where	cd_material_generico = cd_material_w
		
union

		select	cd_material_generico
		from	material
		where	cd_material = cd_material_w
		and	(cd_material_generico IS NOT NULL AND cd_material_generico::text <> '')
		
union

		select	cd_material
		from	material
		where	cd_material_generico = (select	max(cd_material_generico)
						from	material
						where	cd_material = cd_material_w
						and	(cd_material_generico IS NOT NULL AND cd_material_generico::text <> ''))) alias4
	group by cd_material
	order by cd_material;
	
C07 CURSOR FOR
	SELECT	nr_sequencia
	from	ap_lote
	where	nr_prescricao = nr_prescricao_p;

c08 CURSOR FOR
  SELECT  distinct
      c.cd_material,
      a.nr_seq_lote,
      c.nr_sequencia,
	  c.nr_seq_regra_local
  from    prescr_mat_hor a,
    prescr_medica b,
    prescr_material c,
    estrutura_material_v s,
    material e
  where  (a.nr_seq_lote IS NOT NULL AND a.nr_seq_lote::text <> '')
  and  a.cd_material = s.cd_material
  and  a.nr_prescricao = b.nr_prescricao
  and  c.nr_prescricao = b.nr_prescricao
  and  a.nr_seq_material = c.nr_sequencia
  and  a.nr_prescricao = nr_prescricao_p
  and  a.cd_material = e.cd_material
  and  c.ie_suspenso <> 'S'
  and  coalesce(a.dt_suspensao::text, '') = ''
  and  exists(  SELECT  1
      from  ap_lote x,
        classif_lote_disp_far y
      where  x.nr_sequencia = a.nr_seq_lote
      and   coalesce(x.ie_integracao, 'N') <> 'P'
      and  y.nr_sequencia = x.nr_seq_classif
      and	((ie_enviar_horarios_disp_w = 'S') or (y.ie_classif_urgente = 'A'))
      and  coalesce(x.dt_atend_farmacia::text, '') = '')
  and  exists(  select  1
      from   regra_local_dispensacao x
      where   x.cd_estabelecimento  = b.cd_estabelecimento
      and  x.cd_setor_atendimento  = b.cd_setor_atendimento
      and  x.nr_sequencia   = coalesce(a.nr_regra_local_disp, c.nr_seq_regra_local)
      and   coalesce(x.nr_seq_classif,a.nr_seq_classif) = a.nr_seq_classif
      and   ((x.cd_material   = s.cd_material) or (x.cd_grupo_material  = s.cd_grupo_material) or (x.cd_subgrupo_material = s.cd_subgrupo_material) or (x.cd_classe_material  = s.cd_classe_material) or ((x.nr_seq_estrut_int IS NOT NULL AND x.nr_seq_estrut_int::text <> '') and consistir_se_mat_contr_estrut(x.nr_seq_estrut_int, s.cd_material) = 'S')));

c010 CURSOR FOR
SELECT  a.nr_sequencia
from    cpoe_order_unit a,
        cpoe_material b,
        prescr_material c
where   a.nr_sequencia = b.nr_seq_cpoe_order_unit
and     c.nr_seq_mat_cpoe = b.nr_sequencia
and     c.nr_prescricao = nr_prescricao_p
and     c.nr_sequencia = nr_item_prescr_w;

BEGIN

select 	coalesce(max('S'),'N')
into STRICT	ie_quimio_w
from	paciente_atendimento
where	nr_prescricao = nr_prescricao_p;

begin

select	substr(wheb_usuario_pck.get_machine ||' - ' || wheb_usuario_pck.get_nm_usuario,1,80)
into STRICT	ds_maq_user_w	
;

cd_perfil_ativo_w	:= obter_perfil_ativo;

if (coalesce(cd_perfil_ativo_w,0) = 0) then
	cd_perfil_ativo_w	:= Obter_dados_usuario_opcao(nm_usuario_p, 'CPI');
end if;

select	max(cd_setor_atendimento),
		max(cd_estabelecimento),
		max(nr_atendimento),
		max(nr_seq_atend),
		max(ie_motivo_prescricao),
		max(cd_pessoa_fisica)
into STRICT	cd_setor_atendimento_w,
		cd_estabelecimento_w,
		nr_atendimento_w,
		nr_seq_atend_w,
		ie_motivo_prescricao_w,
		cd_pessoa_fisica_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

ie_setor_atual_w := obter_param_usuario(1113, 378, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ie_setor_atual_w);

if (ie_setor_atual_w = 'S') and (ie_origem_lote_p = 'AIP') then
	cd_setor_atendimento_w := coalesce(obter_setor_atendimento(nr_atendimento_w),cd_setor_atendimento_w);
end if;

select	max(ie_classif_urgencia),
	coalesce(max(ie_gerar_acm_lote), 'S'),
	coalesce(max(ie_gerar_sn_lote), 'S'),
	coalesce(max(ie_gerar_novo_lote_turno_dia),'S'),
	coalesce(max(ie_gerar_lote_area),'S'),
	coalesce(max(ie_gerar_solucao_separado),'S'),
	coalesce(max(ie_gerar_termo_separado),'S'),
	coalesce(max(ie_gerar_alto_risco_sep),'S'),
	coalesce(max(ie_novo_lote_dia),'N'),
	coalesce(max(ie_gerar_mat_separado),'N'),
	coalesce(max(ie_lote_desdobrado),'N'),
	coalesce(max(ie_gerar_lote_apos_horario),'S'),
	max(nr_seq_regra_alto_risco),
	max(nr_seq_regra_alto_custo),
	max(nr_seq_regra_termo),
	max(nr_seq_regra_ccih),
	max(nr_seq_classif),
	max(nr_seq_regra_controlado),
	max(nr_seq_regra_acm),
	max(nr_seq_regra_sn),
	coalesce(max(ie_gerar_lote_acm_sn_uti),'N'),
	coalesce(max(ie_gerar_lote_unico),'N'),
	coalesce(max(ie_somente_gerar_acm_sn),'N'),
	coalesce(max(ie_gera_lote_prescr_quimio),'S'),
	coalesce(max(ie_gerar_lote_solucao),'S'),
	coalesce(max(ie_dose_esp_apos_horario),'N'),
	coalesce(max(ie_ajusta_local_item_sol),'N'),
	coalesce(max(ie_atualiza_regra_local_kit),'N'),
	max(nr_seq_regra_recomend),
	coalesce(max(ie_gera_integracao),'N'),
  coalesce(max(ie_gen_batch_per_order_unit),'N')
into STRICT	ie_classif_nao_padrao_w,
	ie_gerar_acm_w,
	ie_gerar_sn_w,
	ie_gerar_novo_lote_turno_dia_w,
	ie_gerar_lote_area_w,
	ie_gerar_solucao_separado_w,
	ie_termolabil_w,
	ie_alto_risco_w,
	ie_novo_lote_dia_w,
	ie_gera_lote_separado_w,
	ie_gera_lote_desdobrado_w,
	ie_gerar_lote_apos_horario_w,
	nr_seq_regra_alto_risco_w,
	nr_seq_regra_alto_custo_w,
	nr_seq_regra_termo_w,
	nr_seq_regra_ccih_w,
	nr_seq_classif_param_w,
	nr_seq_regra_controlado_w,
	nr_seq_regra_acm_w,
	nr_seq_regra_sn_w,
	ie_gerar_lote_acm_sn_uti_w,
	ie_far_gera_lote_unico_w,
	ie_somente_gerar_acm_sn_w,
	ie_gera_lote_prescr_quimio_w,
	ie_gerar_lote_solucao_w,
	ie_dose_esp_apos_horario_w,
	ie_ajusta_local_item_sol_w,
	ie_atualiza_regra_local_kit_w,
	nr_seq_regra_recomend_w,
	ie_gera_integracao_w,
  ie_gen_batch_per_order_unit_w
from	parametros_farmacia
where	cd_estabelecimento	= cd_estabelecimento_w;



if	((coalesce(nr_seq_regra_termo_w,0) > 0) and ie_gen_batch_per_order_unit_w = 'N') then
	select	ie_itens_associados
	into STRICT	ie_itens_associados_termo_w
	from 	regra_geracao_lote_sep
	where 	cd_estabelecimento = cd_estabelecimento_w
	and	nr_sequencia = nr_seq_regra_termo_w;
end if;	

if	((coalesce(nr_seq_regra_alto_risco_w,0) > 0) and ie_gen_batch_per_order_unit_w = 'N') then
	select	ie_itens_associados
	into STRICT	ie_itens_associados_w
	from 	regra_geracao_lote_sep
	where 	cd_estabelecimento = cd_estabelecimento_w
	and	nr_sequencia = nr_seq_regra_alto_risco_w;
end if;

if	((coalesce(nr_seq_regra_alto_custo_w,0) > 0) and ie_gen_batch_per_order_unit_w = 'N') then
	select	ie_itens_associados
	into STRICT	ie_itens_associados_custo_w
	from 	regra_geracao_lote_sep
	where 	cd_estabelecimento = cd_estabelecimento_w
	and	nr_sequencia = nr_seq_regra_alto_custo_w;
end if;	

if	((coalesce(nr_seq_regra_ccih_w,0) > 0) and ie_gen_batch_per_order_unit_w = 'N') then
	select	ie_itens_associados
	into STRICT	ie_itens_associados_ccih_w
	from 	regra_geracao_lote_sep
	where 	cd_estabelecimento = cd_estabelecimento_w
	and	nr_sequencia = nr_seq_regra_ccih_w;
end if;

if	((coalesce(nr_seq_regra_controlado_w,0) > 0) and ie_gen_batch_per_order_unit_w = 'N') then
	select	ie_itens_associados
	into STRICT	ie_itens_assoc_controlado_w
	from 	regra_geracao_lote_sep
	where 	cd_estabelecimento = cd_estabelecimento_w
	and	nr_sequencia = nr_seq_regra_controlado_w;
end if;

if	((coalesce(nr_seq_regra_acm_w,0) > 0) and ie_gen_batch_per_order_unit_w = 'N') then
	select	ie_itens_associados
	into STRICT	ie_itens_assoc_acm_w
	from 	regra_geracao_lote_sep
	where 	cd_estabelecimento = cd_estabelecimento_w
	and	nr_sequencia = nr_seq_regra_acm_w;
end if;

if	((coalesce(nr_seq_regra_sn_w,0) > 0) and ie_gen_batch_per_order_unit_w = 'N') then
	select	ie_itens_associados
	into STRICT	ie_itens_assoc_sn_w
	from 	regra_geracao_lote_sep
	where 	cd_estabelecimento = cd_estabelecimento_w
	and	nr_sequencia = nr_seq_regra_sn_w;
end if;

if	((coalesce(nr_seq_regra_recomend_w,0) > 0) and ie_gen_batch_per_order_unit_w = 'N') then	
	select	max(ie_itens_associados)
	into STRICT	ie_itens_assoc_recomend_w
	from 	regra_geracao_lote_sep
	where 	cd_estabelecimento = cd_estabelecimento_w
	and	nr_sequencia = nr_seq_regra_recomend_w;
end if;




select 	coalesce(max(ie_arq_pyxis),'N')
into STRICT	ie_arq_pyxis_w
from	parametro_atendimento
where	cd_estabelecimento = cd_estabelecimento_w;

ie_gera_lote_orig_w 		:= coalesce(obter_valor_param_usuario(1113, 138, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w), 'N'); /* Virgilio 26/05/2009*/
ie_gera_lote_medic_pac_w 	:= coalesce(obter_valor_param_usuario(924, 389, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w), 'N'); /* Virgo 06/08/2009*/
VarNaoGerarSoPrimeiraEtapa_w	:= coalesce(obter_valor_param_usuario(924, 924, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w), 'N');
ie_gerar_lote_null_w		:= coalesce(obter_valor_param_usuario(924, 873, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w), 'S');
ie_define_disp_prescr_w		:= coalesce(obter_valor_param_usuario(924, 851, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w), 'N');

select	coalesce(max(ie_gerar_lote_unico),'N'),
	coalesce(max(ie_gerar_lote_agora),'S')
into STRICT	ie_gerar_lote_unico_w,
	ie_gerar_lote_agora_w
from	setor_atendimento
where	cd_setor_atendimento = cd_setor_atendimento_w
and	cd_estabelecimento = cd_estabelecimento_w;

cd_setor_gedipa_w := Obter_Unidade_Atendimento(nr_atendimento_w,'IAA','CS');
	
if (ie_gera_lote_prescr_quimio_w = 'S') or (coalesce(nr_seq_atend_w,0) = 0) then

	if (ie_gera_lote_desdobrado_w in ('S', 'A')) and ((ie_far_gera_lote_unico_w = 'N') or (ie_gerar_lote_unico_w = 'N')) then

		CALL Gerar_Lote_Atend_Prescr_Desdob(nr_prescricao_p, nr_sequencia_p,	nr_seq_horario_p, ie_so_aprazado_p, nm_usuario_p, ie_origem_lote_p, nr_etapa_p);
	/*elsif	(ie_gera_lote_desdobrado_w = 'U') then
		if	(ie_gerar_lote_unico_w = 'N') then
			Gerar_Lote_Atend_Prescr_Desdob(nr_prescricao_p, nr_sequencia_p,	nr_seq_horario_p, ie_so_aprazado_p, nm_usuario_p, ie_origem_lote_p);
		end if;*/
	elsif	((ie_far_gera_lote_unico_w = 'N') or (ie_gerar_lote_unico_w = 'N')) then

		if (ie_origem_lote_p in ('AIP','GAI', 'AIS')) then
			begin
			ie_lote_acm_sn_w := coalesce(obter_valor_param_usuario(1113, 107, Obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w),'S');	
			if (ie_lote_acm_sn_w = 'S') or (ie_lote_acm_sn_w = 'N') then
				ie_gerar_acm_w := ie_lote_acm_sn_w;
				ie_gerar_sn_w  := ie_lote_acm_sn_w;
			end if;
			
			if (ie_lote_acm_sn_w = 'X') and (nr_sequencia_p > 0) then
				
				select	coalesce(max(ie_acm),'N'),
					coalesce(max(ie_se_necessario),'N'),
					coalesce(max(cd_material),0),
					coalesce(max(qt_material),0)
				into STRICT	ie_acm_w,
					ie_se_necessario_w,
					cd_material_w,
					qt_material_w
				from	prescr_material
				where	nr_sequencia = nr_sequencia_p
				and	nr_prescricao = nr_prescricao_p;
				
				if (ie_acm_w = 'S') or (ie_se_necessario_w = 'S') then

					select	max(obter_local_estoque_setor(obter_setor_atendimento(nr_atendimento),cd_estabelecimento_w))
					into STRICT	cd_local_setor_pac_w
					from	prescr_medica
					where	nr_prescricao = nr_prescricao_p;
				
					ie_saldo_estoque_w := obter_disp_estoque(cd_material_w, cd_local_setor_pac_w, cd_estabelecimento_w, 0, qt_material_w, '', ie_saldo_estoque_w);
					
					if (ie_saldo_estoque_w = 'N') then
					
						open c06;
						loop
						fetch c06 into	
							cd_mat_est_w;
						EXIT WHEN NOT FOUND; /* apply on c06 */
							begin
							if (ie_saldo_estoque_w = 'N') then
								ie_saldo_estoque_w := obter_disp_estoque(cd_mat_est_w, cd_local_setor_pac_w, cd_estabelecimento_w, 0, qt_material_w, '', ie_saldo_estoque_w);
							end if;
							end;
						end loop;
						close c06;
					
					end if;
					
					if (ie_saldo_estoque_w = 'S') then
						ie_gerar_acm_w := 'N';
						ie_gerar_sn_w  := 'N';
					else
						ie_gerar_acm_w := 'S';
						ie_gerar_sn_w  := 'S';
					end if;
					
				end if;
			end if;
			end;
		end if;

		insert into ap_lote_log(
			nr_sequencia,
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			nr_prescricao, 
			nr_seq_mat_hor, 
			nr_seq_lote, 
			ds_tipo_item, 
			ds_conteudo, 
			ds_stack)
		values (	nextval('ap_lote_log_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_prescricao_p,
			nr_seq_horario_p,
			null,
			'100',
			' nr_sequencia_p='		|| nr_sequencia_p           	||
			' nr_seq_horario_p='            || nr_seq_horario_p             || ' ie_so_aprazado_p='           || ie_so_aprazado_p           ||
			' nm_usuario_p='                || nm_usuario_p                 || ' ie_origem_lote_p='           || ie_origem_lote_p           ||
			' nr_etapa_p='                  || nr_etapa_p                   || ' cd_setor_atendimento_w='     || cd_setor_atendimento_w     ||
			' cd_estabelecimento_w='        || cd_estabelecimento_w         || ' nr_atendimento_w='           || nr_atendimento_w           ||
			' ie_setor_atual_w='            || ie_setor_atual_w             || ' ie_classif_nao_padrao_w='    || ie_classif_nao_padrao_w    ||
			' ie_gerar_acm_w='              || ie_gerar_acm_w               || ' ie_gerar_sn_w='              || ie_gerar_sn_w              ||
			' ie_gerar_novo_lote_turno_dia_w=' || ie_gerar_novo_lote_turno_dia_w ||	' ie_gerar_lote_area_w='  || ie_gerar_lote_area_w       ||
			' ie_gerar_solucao_separado_w=' || ie_gerar_solucao_separado_w  || ' ie_termolabil_w='            || ie_termolabil_w            ||
			' ie_alto_risco_w='             || ie_alto_risco_w              || ' ie_novo_lote_dia_w='         || ie_novo_lote_dia_w         ||
			' ie_gera_lote_separado_w='     || ie_gera_lote_separado_w      || ' ie_gera_lote_desdobrado_w='  || ie_gera_lote_desdobrado_w  ||
			' ie_gerar_lote_apos_horario_w='|| ie_gerar_lote_apos_horario_w || ' nr_seq_regra_alto_risco_w='  || nr_seq_regra_alto_risco_w  ||
			' nr_seq_regra_alto_custo_w='   || nr_seq_regra_alto_custo_w    || ' nr_seq_regra_termo_w='       || nr_seq_regra_termo_w       ||
			' nr_seq_regra_ccih_w='         || nr_seq_regra_ccih_w          || ' nr_seq_classif_param_w='     || nr_seq_classif_param_w     ||
			' nr_seq_regra_controlado_w='   || nr_seq_regra_controlado_w    || ' nr_seq_regra_acm_w='         || nr_seq_regra_acm_w         ||
			' nr_seq_regra_sn_w='           || nr_seq_regra_sn_w            || ' ie_gerar_lote_acm_sn_uti_w=' || ie_gerar_lote_acm_sn_uti_w ||
			' ie_arq_pyxis_w='              || ie_arq_pyxis_w               || ' ie_gera_lote_orig_w='        || ie_gera_lote_orig_w        ||
			' VarNaoGerarSoPrimeiraEtapa_w='|| VarNaoGerarSoPrimeiraEtapa_w || ' ie_lote_acm_sn_w='           || ie_lote_acm_sn_w           ||
			' ie_gera_lote_medic_pac_w='    || ie_gera_lote_medic_pac_w     || ' ie_gerar_lote_unico_w='      || ie_gerar_lote_unico_w      ||
			' ie_gerar_lote_agora_w='       || ie_gerar_lote_agora_w        || ' ie_somente_gerar_acm_sn_w='  || ie_somente_gerar_acm_sn_w  ||
			' ie_gerar_lote_null_w='        || ie_gerar_lote_null_w,
			substr(dbms_utility.format_call_stack,1,2000));
		if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

		
		if (ie_ajusta_local_item_sol_w = 'S') then
			CALL ajustar_local_item_sol(nr_prescricao_p,nm_usuario_p);
		end if;

		open C20;
		loop
		fetch C20 into	
			cd_tipo_baixa_w;
		EXIT WHEN NOT FOUND; /* apply on C20 */
			begin
			cd_tipo_baixa_w	:= cd_tipo_baixa_w;
			end;
		end loop;
		close C20;

		if (cd_tipo_baixa_w IS NOT NULL AND cd_tipo_baixa_w::text <> '') then
			select	max(ie_conta_paciente),
				max(ie_atualiza_estoque)
			into STRICT	ie_conta_paciente_w,
				ie_atualiza_estoque_w
			from	tipo_baixa_prescricao
			where	cd_tipo_baixa		= cd_tipo_baixa_w
			and	ie_prescricao_devolucao = 'P';
		end if;
		
		ie_gerou_w := 'N';
		
		-- OS584935 = Gerava itens associados de outro horarioo no lote aprazado
		if (coalesce(nr_seq_horario_p,0) > 0) then
			select	coalesce(max(dt_horario),clock_timestamp()),
				coalesce(max(ie_aprazado),'S')
			into STRICT	dt_seq_horario_w,
				ie_aprazado_w
			from	prescr_mat_hor
			where	nr_sequencia = nr_seq_horario_p;
		end if;
		
		open C01;
		loop
		fetch C01 into	
			cd_material_w,
			nr_seq_mat_hor_w,
			cd_unidade_medida_w,
			qt_dispensar_w,
			qt_dispensar_hor_w,
			nr_seq_turno_w,
			dt_horario_w,
			hr_hora_w,
			cd_estabelecimento_w,
			ie_urgente_w,
			nr_seq_classif_w,
			cd_local_estoque_w,
			nr_item_prescr_w,
			ie_aprazado_ww,
			vl_union_w,
			ie_dose_especial_ww,
			ie_medicacao_paciente_w,
			ie_agrupador_w,
			nr_seq_mat_diluicao_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin

			if (ie_setor_atual_w = 'S') and (ie_origem_lote_p in ('AIP', 'AIS')) and (ie_define_disp_prescr_w = 'N') then
				
				cd_local_estoque_w := obter_local_disp_prescr_item(	nr_prescricao_p,
											nr_item_prescr_w,
											obter_perfil_ativo,
											'N',
											'S',
											'S',
											nm_usuario_p,
											ie_origem_lote_p);
				
			end if;
			
			if (coalesce(nr_seq_classif_param_w,0) > 0)  then
				begin
				
				select	ie_dose_especial
				into STRICT	ie_dose_especial_w
				from	prescr_mat_hor
				where	nr_sequencia = nr_seq_mat_hor_w;
				
				end;
				
				if (coalesce(ie_dose_especial_w,'N') = 'S') then
					begin
					
					nr_seq_classif_w := nr_seq_classif_param_w;
					
					update	prescr_mat_hor
					set	nr_seq_classif	= nr_seq_classif_w
					where	nr_sequencia	= nr_seq_mat_hor_w;

					end;
				end if;
				
			end if;
			
			ie_gerar_ap_lote_gedipa_w := 'S';
			ie_gerar_solucao_w := 'S';
			ie_gerar_lote_dil_w := 'S';
			
			select	count(*)
			into STRICT	qt_existe_regra_w
			from	regra_local_disp_gedipa;
			
			if (qt_existe_regra_w > 0) then
				begin
				select	coalesce(max(nr_seq_superior),0)
				into STRICT	nr_seq_superior_w
				from	prescr_mat_hor
				where	(nr_seq_superior IS NOT NULL AND nr_seq_superior::text <> '')
				and	nr_sequencia = nr_seq_mat_hor_w;
				
				if (nr_seq_superior_w > 0) then
					nr_item_prescr_w := nr_seq_superior_w;
				end if;
				
				nr_seq_regra_gedipa_w := obter_local_estoque_regra_ged(cd_setor_gedipa_w,nr_prescricao_p,nr_item_prescr_w,'S',null,ie_dose_especial_ww);
				
				select	coalesce(max(ie_gerar_ap_lote),'S')
				into STRICT	ie_gerar_ap_lote_gedipa_w
				from	regra_local_disp_gedipa
				where	nr_sequencia = nr_seq_regra_gedipa_w;
				
				exception
				when others then
					ie_gerar_ap_lote_gedipa_w := 'S';
				end;
			end if;
			
			if (ie_define_disp_prescr_w = 'S') then
				
				nr_seq_mat_hor_ww := nr_seq_mat_hor_w;
				
				if (coalesce(ie_atualiza_regra_local_kit_w,'N') = 'N') then
				
					select	coalesce(max(nr_seq_superior),0),
							max(dt_horario)
					into STRICT	nr_seq_superior_w,
							dt_horario_pai_w
					from	prescr_mat_hor
					where	(nr_seq_superior IS NOT NULL AND nr_seq_superior::text <> '')
					and		nr_sequencia = nr_seq_mat_hor_ww
					and		nr_seq_turno = nr_seq_turno_w;

					if (nr_seq_superior_w > 0) then

						select	coalesce(max(nr_sequencia),0)
						into STRICT	nr_seq_mat_hor_ww
						from	prescr_mat_hor
						where	nr_seq_material = nr_seq_superior_w
						and		nr_prescricao	= nr_prescricao_p
						and		nr_seq_turno	= nr_seq_turno_w
						and 	dt_horario		= dt_horario_pai_w;
					end if;
				end if;		
				
				select	coalesce(max(nr_regra_local_disp),0)
				into STRICT	nr_regra_local_disp_w
				from	prescr_mat_hor
				where	nr_sequencia = nr_seq_mat_hor_ww;
			
				
        select	coalesce(max(ie_gerar_ap_lote), 'S'),coalesce(max(ie_send_info_to_integration), 'N')
				into STRICT	ie_gerar_ap_lote_w,ie_send_integration_w
				from	regra_local_dispensacao
				where	nr_sequencia = nr_regra_local_disp_w;
				
			else
			
				select	coalesce(max(nr_seq_superior),0)
				into STRICT	nr_seq_superior_w
				from	prescr_mat_hor
				where	(nr_seq_superior IS NOT NULL AND nr_seq_superior::text <> '')
				and	nr_sequencia = nr_seq_mat_hor_w;
				
				if (nr_seq_superior_w > 0) then
					nr_item_prescr_w := nr_seq_superior_w;
				end if;
				
				select	max(nr_seq_regra_local)
				into STRICT	nr_regra_local_disp_w
				from	prescr_material
				where	nr_prescricao = nr_prescricao_p
				and 	coalesce(nr_seq_recomendacao,0) <> coalesce(nr_item_prescr_w,0)
				and		nr_sequencia = nr_item_prescr_w;
				
        select	coalesce(max(ie_gerar_ap_lote), 'S'),coalesce(max(ie_send_info_to_integration), 'N')
				into STRICT	ie_gerar_ap_lote_w,ie_send_integration_w
				from	regra_local_dispensacao
				where	nr_sequencia = nr_regra_local_disp_w;
				
			end if;
			
			if (ie_gerar_lote_solucao_w = 'N') then
				
				select	coalesce(max(nr_seq_superior),0)
				into STRICT	nr_seq_superior_w
				from	prescr_mat_hor
				where	(nr_seq_superior IS NOT NULL AND nr_seq_superior::text <> '')
				and	nr_sequencia = nr_seq_mat_hor_w;
				
				if (nr_seq_superior_w > 0) then
					
					select	coalesce(max('N'),'S')
					into STRICT	ie_gerar_solucao_w
					from	prescr_material
					where	(nr_sequencia_solucao IS NOT NULL AND nr_sequencia_solucao::text <> '')
					and	nr_sequencia = nr_seq_superior_w
					and	nr_prescricao = nr_prescricao_p;
					
				end if;
			
			end if;

			if (nr_seq_mat_diluicao_w IS NOT NULL AND nr_seq_mat_diluicao_w::text <> '') then
				select 	coalesce(max(m.ie_gerar_lote),'S')
				into STRICT	ie_gerar_lote_dil_w
				from	material_diluicao m
				where 	m.nr_seq_interno = nr_seq_mat_diluicao_w;
			end if;
						
			insert into ap_lote_log(
				nr_sequencia,
				dt_atualizacao, 
				nm_usuario, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				nr_prescricao, 
				nr_seq_mat_hor, 
				nr_seq_lote, 
				ds_tipo_item, 
				ds_conteudo, 
				ds_stack)
			values (	nextval('ap_lote_log_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_prescricao_p,
				nr_seq_horario_p,
				null,
				'101',
				' ie_origem_lote_p = '||ie_origem_lote_p || ' nr_seq_turno_w = ' || nr_seq_turno_w ||
				' nr_seq_turno_ant_w = ' || nr_seq_turno_ant_w || ' nr_seq_classif_w = ' || nr_seq_classif_w ||
				' nr_seq_classif_ant_w = ' || nr_seq_classif_ant_w || ' trunc(dt_horario_w,''dd'') = ' || PKG_DATE_UTILS.start_of(dt_horario_w,'dd',0) ||
				' trunc(dt_horario_ant_w,''dd'') = ' || PKG_DATE_UTILS.start_of(dt_horario_ant_w,'dd',0) || ' dt_horario_w = ' || to_char(dt_horario_w,'dd/mm/yyyy hh24:mi:ss') ||
				' dt_horario_ant_w = ' || to_char(dt_horario_ant_w,'dd/mm/yyyy hh24:mi:ss') || ' ie_gerar_novo_lote_turno_dia_w = ' || ie_gerar_novo_lote_turno_dia_w ||
				' cd_local_estoque_w = ' || cd_local_estoque_w || ' cd_local_estoque_ant_w = ' || cd_local_estoque_ant_w || ' nr_seq_mat_hor_w = ' || nr_seq_mat_hor_w ||
				' nr_prescricao_p = ' || nr_prescricao_p || ' nr_sequencia_p = ' || nr_sequencia_p || ' ie_so_aprazado_p = ' || ie_so_aprazado_p ||
				' nr_seq_lote = ' || nr_sequencia_w || ' vl_union_w = ' || vl_union_w || ' ie_gerar_ap_lote_w = ' || ie_gerar_ap_lote_w || 
				' nr_regra_local_disp_w=' || nr_regra_local_disp_w || ' ie_gerar_solucao_w=' || ie_gerar_solucao_w || ' ie_gerar_ap_lote_gedipa_w=' || ie_gerar_ap_lote_gedipa_w ||
				' dt_inicio_turno_w=' || dt_inicio_turno_w || ' ie_novo_lote_dia_w=' || ie_novo_lote_dia_w || ' ie_gera_lote_medic_pac_w=' || ie_gera_lote_medic_pac_w ||
				' ie_medicacao_paciente_w=' || ie_medicacao_paciente_w || ' ie_medic_pac_ant_w=' || ie_medic_pac_ant_w || ' ie_gerou_w=' || ie_gerou_w ||
				' ie_gerar_lote_apos_horario_w=' || ie_gerar_lote_apos_horario_w || ' ie_dose_esp_apos_horario_w=' || ie_dose_esp_apos_horario_w || ' ie_dose_especial_ww=' || ie_dose_especial_ww ||
				' nr_seq_mat_diluicao_w=' || nr_seq_mat_diluicao_w || ' ie_gerar_lote_dil_w=' || ie_gerar_lote_dil_w,
				substr(dbms_utility.format_call_stack,1,2000));
			if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

			if (ie_gerar_solucao_w = 'S') and (ie_gerar_ap_lote_gedipa_w = 'S') and
				((ie_gerar_ap_lote_w = 'S') or ((ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS'))) and
				((coalesce(nr_seq_mat_diluicao_w::text, '') = '') or (nr_seq_mat_diluicao_w IS NOT NULL AND nr_seq_mat_diluicao_w::text <> '' AND ie_gerar_lote_dil_w = 'S')) and
				((nr_seq_turno_w <> nr_seq_turno_ant_w) or (nr_seq_classif_w <> nr_seq_classif_ant_w) or
				((PKG_DATE_UTILS.start_of(dt_horario_w,'dd',0) <> PKG_DATE_UTILS.start_of(dt_horario_ant_w,'dd',0)) and (ie_gerar_novo_lote_turno_dia_w = 'S')) or
				(((dt_horario_w - dt_inicio_turno_w) >= 1) and (ie_novo_lote_dia_w = 'S')) or (cd_local_estoque_w <> cd_local_estoque_ant_w) or
				((ie_gera_lote_medic_pac_w = 'S') and (ie_medicacao_paciente_w = 'S') and (ie_medicacao_paciente_w <> ie_medic_pac_ant_w)) or (ie_gerou_w = 'N')) and
				((coalesce(nr_seq_horario_p,0) = 0) or (vl_union_w = 1) or (dt_seq_horario_w = dt_horario_w AND ie_aprazado_w = ie_aprazado_ww)) and
				((ie_gerar_lote_apos_horario_w = 'S') or
				(ie_dose_esp_apos_horario_w = 'S' AND ie_dose_especial_ww = 'S') or
				((dt_horario_w > clock_timestamp()) or (ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS')) and (ie_gen_batch_per_order_unit_w = 'N')
        ) then
				begin

				insert into ap_lote_log(
					nr_sequencia, 
					dt_atualizacao, 
					nm_usuario, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec, 
					nr_prescricao, 
					nr_seq_mat_hor, 
					nr_seq_lote, 
					ds_tipo_item, 
					ds_conteudo, 
					ds_stack)
				values (	nextval('ap_lote_log_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_prescricao_p,
					nr_seq_horario_p,
					null,
					'103',
					' ie_origem_lote_p = '||ie_origem_lote_p || ' nr_seq_turno_w = ' || nr_seq_turno_w ||
					' nr_seq_turno_ant_w = ' || nr_seq_turno_ant_w || ' nr_seq_classif_w = ' || nr_seq_classif_w ||
					' nr_seq_classif_ant_w = ' || nr_seq_classif_ant_w || ' trunc(dt_horario_w,''dd'') = ' || PKG_DATE_UTILS.start_of(dt_horario_w,'dd',0) ||
					' trunc(dt_horario_ant_w,''dd'') = ' || PKG_DATE_UTILS.start_of(dt_horario_ant_w,'dd',0) || ' dt_horario_w = ' || to_char(dt_horario_w,'dd/mm/yyyy hh24:mi:ss') ||
					' dt_horario_ant_w = ' || to_char(dt_horario_ant_w,'dd/mm/yyyy hh24:mi:ss') || ' ie_gerar_novo_lote_turno_dia_w = ' || ie_gerar_novo_lote_turno_dia_w ||
					' cd_local_estoque_w = ' || cd_local_estoque_w || ' cd_local_estoque_ant_w = ' || cd_local_estoque_ant_w || ' nr_seq_mat_hor_w = ' || nr_seq_mat_hor_w ||
					' nr_prescricao_p = ' || nr_prescricao_p || ' nr_sequencia_p = ' || nr_sequencia_p || ' ie_so_aprazado_p = ' || ie_so_aprazado_p ||
					' nr_seq_lote = ' || nr_sequencia_w || ' vl_union_w = ' || vl_union_w || ' ie_gerar_ap_lote_w = ' || ie_gerar_ap_lote_w || 
					' nr_regra_local_disp_w=' || nr_regra_local_disp_w || ' ie_gerar_solucao_w=' || ie_gerar_solucao_w || ' ie_gerar_ap_lote_gedipa_w=' || ie_gerar_ap_lote_gedipa_w ||
					' dt_inicio_turno_w=' || dt_inicio_turno_w || ' ie_novo_lote_dia_w=' || ie_novo_lote_dia_w || ' ie_gera_lote_medic_pac_w=' || ie_gera_lote_medic_pac_w ||
					' ie_medicacao_paciente_w=' || ie_medicacao_paciente_w || ' ie_medic_pac_ant_w=' || ie_medic_pac_ant_w || ' ie_gerou_w=' || ie_gerou_w ||
					' ie_gerar_lote_apos_horario_w=' || ie_gerar_lote_apos_horario_w || ' ie_dose_esp_apos_horario_w=' || ie_dose_esp_apos_horario_w || ' ie_dose_especial_ww=' || ie_dose_especial_ww ||
          'ie_gen_batch_per_order_unit_w=' || ie_gen_batch_per_order_unit_w,
					substr(dbms_utility.format_call_stack,1,2000));
				if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
				
				OPEN C02;
				LOOP
					FETCH C02 INTO
						hr_inicio_turno_w;
					EXIT WHEN NOT FOUND; /* apply on c02 */
					begin
					hr_inicio_turno_w := hr_inicio_turno_w;
					end;
				END LOOP;
				CLOSE C02;
				
				select	coalesce(max(qt_prioridade),999)
				into STRICT	qt_prioridade_w
				from	classif_lote_disp_far
				where	nr_sequencia	= nr_seq_classif_w;

				if (hr_hora_w < hr_inicio_turno_w) then
					dt_inicio_turno_w	:= PKG_DATE_UTILS.get_Time(dt_horario_w - 1, replace(hr_inicio_turno_w,'24:','00:'));
				else
					dt_inicio_turno_w	:= PKG_DATE_UTILS.get_Time(dt_horario_w, replace(hr_inicio_turno_w,'24:','00:'));
				end if;
				

				select	nextval('ap_lote_seq')
				into STRICT	nr_sequencia_w
				;
				insert into ap_lote(
					nr_sequencia,
					dt_inicio_turno,
					dt_prim_horario,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					dt_geracao_lote,
					nr_prescricao,
					nr_seq_turno,
					ie_status_lote,
					cd_setor_atendimento,
					nr_seq_classif,
					nm_usuario_geracao,
					ds_maquina_geracao,
					cd_perfil_geracao,
					qt_min_atraso_inicio_atend,
					qt_min_atraso_atend,
					qt_min_atraso_disp,
					qt_min_atraso_entrega,
					qt_min_atraso_receb,
					cd_tipo_baixa,
					ie_conta_paciente,
					ie_atualiza_estoque,
					cd_local_estoque,
					qt_prioridade,
					ie_origem_lote,
					ds_origem_ger_lote,
					nr_seq_local_geracao,
					nr_atendimento)
				values ( nr_sequencia_w,
					dt_inicio_turno_w,
					dt_horario_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nr_prescricao_p,
					nr_seq_turno_w,
					'G',
					cd_setor_atendimento_w,
					nr_seq_classif_w,
					nm_usuario_p,
					ds_maq_user_w,
					cd_perfil_ativo_w,
					0,
					0,
					0,
					0,
					0,
					cd_tipo_baixa_w,
					ie_conta_paciente_w,
					ie_atualiza_estoque_w,
					cd_local_estoque_w,
					qt_prioridade_w,
					ie_origem_lote_p,
					'PD',
					'NO',
					nr_atendimento_w);
          if (ie_send_integration_w ='S' )then
            CALL acceptance_submission_cancel(nr_sequencia_w,clock_timestamp(),null,'A',nr_prescricao_p,nm_usuario_p);
          end if;
				end;
			end if;
			
			select CASE WHEN coalesce(nr_sequencia_w,0)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ie_gerou_w
			;

			if	((coalesce(nr_seq_horario_p,0) = 0) or (vl_union_w = 1) or (dt_seq_horario_w = dt_horario_w AND ie_aprazado_w = ie_aprazado_ww)) and
				/*((ie_gerar_lote_disp_w = 'S') and (ie_gerar_lote_disp_ww = 'S')) and*/

				(ie_gerar_ap_lote_gedipa_w = 'S') and
				((ie_gerar_ap_lote_w = 'S') or ((ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS'))) and
				((coalesce(nr_seq_mat_diluicao_w::text, '') = '') or (nr_seq_mat_diluicao_w IS NOT NULL AND nr_seq_mat_diluicao_w::text <> '' AND ie_gerar_lote_dil_w = 'S')) and (ie_gerar_solucao_w = 'S') and
				((ie_gerar_lote_apos_horario_w = 'S') or
				(ie_dose_esp_apos_horario_w = 'S' AND ie_dose_especial_ww = 'S') or
				((dt_horario_w > clock_timestamp()) or (ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS'))) then
				BEGIN
				nr_seq_turno_ant_w	:= nr_seq_turno_w;
				nr_seq_classif_ant_w	:= nr_seq_classif_w;
				cd_local_estoque_ant_w	:= cd_local_estoque_w;
				dt_horario_ant_w	:= dt_horario_w;
				ie_medic_pac_ant_w	:= ie_medicacao_paciente_w;
				
				insert into ap_lote_item(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_lote,
					nr_seq_mat_hor,
					ie_prescrito,
					qt_dispensar,
					qt_total_dispensar,
					cd_material,
					cd_unidade_medida,
					ie_urgente)
				values (nextval('ap_lote_item_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_sequencia_w,
					nr_seq_mat_hor_w,
					'S',
					coalesce(qt_dispensar_hor_w,0),
					qt_dispensar_w,
					cd_material_w,
					cd_unidade_medida_w,
					ie_urgente_w);
				
				update	prescr_mat_hor
				set	nr_seq_lote = nr_sequencia_w
				where	nr_sequencia = nr_seq_mat_hor_w;
				
				update	prescr_mat_alteracao
				set	nr_seq_lote = nr_sequencia_w
				where	nr_prescricao = nr_prescricao_p
				and	nr_seq_horario = nr_seq_mat_hor_w
				and	nr_seq_prescricao = nr_item_prescr_w;

        for r001 in c010 loop

            UPDATE cpoe_order_unit
                  SET    nr_seq_lote = nr_sequencia_w
                  WHERE  nr_sequencia = r001.nr_sequencia;
        end loop;
				
				if	((ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS') or (ie_origem_lote_p = 'AGND')) then
					nr_seq_mat_hor_aip_ais_w := nr_seq_mat_hor_w;
				end if;
				end;
			end if;
			end;
		end loop;
		close C01;

		cd_local_estoque_ant_w	:= 0;
		open C001;
		loop
		fetch C001 into	
			cd_material_w,
			nr_seq_mat_hor_w,
			cd_unidade_medida_w,
			qt_dispensar_w,
			qt_dispensar_hor_w,
			nr_seq_turno_w,
			dt_horario_w,
			hr_hora_w,
			cd_estabelecimento_w,
			ie_urgente_w,
			nr_seq_classif_w,
			cd_local_estoque_w,
			nr_item_prescr_w,
			vl_union_w,
			ie_dose_especial_ww;
		EXIT WHEN NOT FOUND; /* apply on C001 */
			begin
			
			if (ie_setor_atual_w = 'S') and (ie_origem_lote_p in ('AIP', 'AIS')) then
				
				cd_local_estoque_w := obter_local_disp_prescr_item(	nr_prescricao_p,
											nr_item_prescr_w,
											obter_perfil_ativo,
											'N',
											'S',
											'S',
											nm_usuario_p,
											ie_origem_lote_p);
				
			end if;
			
			if (coalesce(nr_seq_classif_param_w,0) > 0)  then
				begin
				
				select	ie_dose_especial
				into STRICT	ie_dose_especial_w
				from	prescr_mat_hor
				where	nr_sequencia = nr_seq_mat_hor_w;
				
				end;
				
				if (coalesce(ie_dose_especial_w,'N') = 'S') then
					begin
					
					nr_seq_classif_w := nr_seq_classif_param_w;
					
					update	prescr_mat_hor
					set	nr_seq_classif	= nr_seq_classif_w
					where	nr_sequencia	= nr_seq_mat_hor_w;

					end;
				end if;
				
			end if;
			
			if (ie_define_disp_prescr_w = 'S') then
				
				nr_seq_mat_hor_ww := nr_seq_mat_hor_w;
				
				select	coalesce(max(nr_seq_superior),0)
				into STRICT	nr_seq_superior_w
				from	prescr_mat_hor
				where	(nr_seq_superior IS NOT NULL AND nr_seq_superior::text <> '')
				and	nr_sequencia = nr_seq_mat_hor_ww
				and	nr_seq_turno = nr_seq_turno_w;
				
				if (nr_seq_superior_w > 0) then
					
					select	coalesce(max(nr_sequencia), 0)
					into STRICT	nr_seq_mat_hor_ww
					from	prescr_mat_hor
					where	nr_seq_material = nr_seq_superior_w
					and	nr_prescricao	= nr_prescricao_p
					and	nr_seq_turno	= nr_seq_turno_w;

				end if;
				
				select	coalesce(max(nr_regra_local_disp),0)
				into STRICT	nr_regra_local_disp_w
				from	prescr_mat_hor
				where	nr_sequencia = nr_seq_mat_hor_ww;
				
        select	coalesce(max(ie_gerar_ap_lote), 'S'),coalesce(max(ie_send_info_to_integration), 'N')
				into STRICT	ie_gerar_ap_lote_w,ie_send_integration_w
				from	regra_local_dispensacao
				where	nr_sequencia = nr_regra_local_disp_w;
				
			else
			
				select	coalesce(max(nr_seq_superior),0)
				into STRICT	nr_seq_superior_w
				from	prescr_mat_hor
				where	(nr_seq_superior IS NOT NULL AND nr_seq_superior::text <> '')
				and	nr_sequencia = nr_seq_mat_hor_w;
				
				if (nr_seq_superior_w > 0) then
					nr_item_prescr_w := nr_seq_superior_w;
				end if;
				
				select	max(nr_seq_regra_local)
				into STRICT	nr_regra_local_disp_w
				from	prescr_material
				where	nr_prescricao = nr_prescricao_p
				and 	coalesce(nr_seq_recomendacao,0) <> coalesce(nr_item_prescr_w,0)
				and		nr_sequencia = nr_item_prescr_w;
				
        select	coalesce(max(ie_gerar_ap_lote), 'S'),coalesce(max(ie_send_info_to_integration), 'N')
				into STRICT	ie_gerar_ap_lote_w,ie_send_integration_w
				from	regra_local_dispensacao
				where	nr_sequencia = nr_regra_local_disp_w;
				
			end if;
			
			ie_gerar_ap_lote_gedipa_w := 'S';
			
			select	count(*)
			into STRICT	qt_existe_regra_w
			from	regra_local_disp_gedipa;
			
			if (qt_existe_regra_w > 0) then
				begin
				select	coalesce(max(nr_seq_superior),0)
				into STRICT	nr_seq_superior_w
				from	prescr_mat_hor
				where	(nr_seq_superior IS NOT NULL AND nr_seq_superior::text <> '')
				and	nr_sequencia = nr_seq_mat_hor_w;
				
				if (nr_seq_superior_w > 0) then
					nr_item_prescr_w := nr_seq_superior_w;
				end if;
				
				nr_seq_regra_gedipa_w := obter_local_estoque_regra_ged(cd_setor_gedipa_w,nr_prescricao_p,nr_item_prescr_w,'S',null,ie_dose_especial_ww);
				
				select	coalesce(max(ie_gerar_ap_lote),'S')
				into STRICT	ie_gerar_ap_lote_gedipa_w
				from	regra_local_disp_gedipa
				where	nr_sequencia = nr_seq_regra_gedipa_w;
				
				exception
				when others then
					ie_gerar_ap_lote_gedipa_w := 'S';
				end;
			end if;
			
			insert into ap_lote_log(
				nr_sequencia,
				dt_atualizacao, 
				nm_usuario, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				nr_prescricao, 
				nr_seq_mat_hor, 
				nr_seq_lote, 
				ds_tipo_item, 
				ds_conteudo, 
				ds_stack)
			values (	nextval('ap_lote_log_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_prescricao_p,
				nr_seq_horario_p,
				null,
				'102',
				' ie_origem_lote_p = '||ie_origem_lote_p || ' nr_seq_turno_w = ' || nr_seq_turno_w || ' nr_seq_turno_ant_w = ' || nr_seq_turno_ant_w ||
				' nr_seq_classif_w = ' || nr_seq_classif_w || ' nr_seq_classif_ant_w = ' || nr_seq_classif_ant_w || 
				' trunc(dt_horario_w,''dd'') = ' || PKG_DATE_UTILS.start_of(dt_horario_w,'dd',0) || ' trunc(dt_horario_ant_w,''dd'') = ' || PKG_DATE_UTILS.start_of(dt_horario_ant_w,'dd',0) ||
				' dt_horario_w = ' || to_char(dt_horario_w,'dd/mm/yyyy hh24:mi:ss') || ' dt_horario_ant_w = ' || to_char(dt_horario_ant_w,'dd/mm/yyyy hh24:mi:ss') ||
				' ie_gerar_novo_lote_turno_dia_w = ' || ie_gerar_novo_lote_turno_dia_w || ' cd_local_estoque_w = ' || cd_local_estoque_w ||
				' cd_local_estoque_ant_w = ' || cd_local_estoque_ant_w || ' nr_seq_mat_hor_w = ' || nr_seq_mat_hor_w || ' nr_sequencia_p = ' || nr_sequencia_p ||
				' ie_so_aprazado_p = ' || ie_so_aprazado_p || ' nr_seq_lote = ' || nr_sequencia_w || ' vl_union_w = ' || vl_union_w,
				substr(dbms_utility.format_call_stack,1,2000));
			if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

			if (ie_gerar_ap_lote_gedipa_w = 'S') and
				((ie_gerar_ap_lote_w = 'S') or ((ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS'))) and
				((nr_seq_turno_w <> nr_seq_turno_ant_w) or (cd_local_estoque_w <> cd_local_estoque_ant_w) or (nr_seq_classif_w <> nr_seq_classif_ant_w) or
				((PKG_DATE_UTILS.start_of(dt_horario_w,'dd',0) <> PKG_DATE_UTILS.start_of(dt_horario_ant_w,'dd',0)) and (ie_gerar_novo_lote_turno_dia_w = 'S'))) and
				((ie_gerar_lote_apos_horario_w = 'S') or
				(ie_dose_esp_apos_horario_w = 'S' AND ie_dose_especial_ww = 'S') or
				 ((dt_horario_w > clock_timestamp()) or (ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS')) and (ie_gen_batch_per_order_unit_w = 'N')) then

				begin

				OPEN C02;
				LOOP
					FETCH C02 INTO
						hr_inicio_turno_w;
					EXIT WHEN NOT FOUND; /* apply on c02 */
					begin
					hr_inicio_turno_w	:= hr_inicio_turno_w;
					end;
				END LOOP;
				CLOSE C02;

				select	coalesce(max(qt_prioridade),999)
				into STRICT	qt_prioridade_w
				from	classif_lote_disp_far
				where	nr_sequencia	= nr_seq_classif_w;
				
				if (hr_hora_w < hr_inicio_turno_w) then
					dt_inicio_turno_w	:= PKG_DATE_UTILS.get_Time(dt_horario_w - 1, replace(hr_inicio_turno_w,'24:','00:'));
				else
					dt_inicio_turno_w	:= PKG_DATE_UTILS.get_Time(dt_horario_w, replace(hr_inicio_turno_w,'24:','00:'));
				end if;
				
				select	nextval('ap_lote_seq')
				into STRICT	nr_sequencia_w
				;

				insert into ap_lote(nr_sequencia,
					dt_inicio_turno,
					dt_prim_horario,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					dt_geracao_lote,
					nr_prescricao,
					nr_seq_turno,
					ie_status_lote,
					cd_setor_atendimento,
					nr_seq_classif,
					nm_usuario_geracao,
					ds_maquina_geracao,
					cd_perfil_geracao,
					qt_min_atraso_inicio_atend,
					qt_min_atraso_atend,
					qt_min_atraso_disp,
					qt_min_atraso_entrega,
					qt_min_atraso_receb,
					cd_tipo_baixa,
					ie_conta_paciente,
					ie_atualiza_estoque,
					cd_local_estoque,
					qt_prioridade,
					ie_origem_lote,
					ds_origem_ger_lote,
					nr_seq_local_geracao,
					nr_atendimento)
				values (nr_sequencia_w,
					dt_inicio_turno_w,
					dt_horario_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nr_prescricao_p,
					nr_seq_turno_w,
					'G',
					cd_setor_atendimento_w,
					nr_seq_classif_w,
					nm_usuario_p,
					ds_maq_user_w,
					cd_perfil_ativo_w,
					0,
					0,
					0,
					0,
					0,
					cd_tipo_baixa_w,
					ie_conta_paciente_w,
					ie_atualiza_estoque_w,
					cd_local_estoque_w,
					qt_prioridade_w,
					ie_origem_lote_p,
					'PD',
					'NO',
					nr_atendimento_w);
          if (ie_send_integration_w ='S' )then
            CALL acceptance_submission_cancel(nr_sequencia_w,clock_timestamp(),null,'A',nr_prescricao_p,nm_usuario_p);
          end if;
				end;
			end if;
			
			nr_seq_turno_ant_w	:= nr_seq_turno_w;
			nr_seq_classif_ant_w	:= nr_seq_classif_w;
			cd_local_estoque_ant_w	:= cd_local_estoque_w;
			dt_horario_ant_w	:= dt_horario_w;
			
			if (ie_gerar_ap_lote_gedipa_w = 'S') and
				((ie_gerar_lote_apos_horario_w = 'S') or
				(ie_dose_esp_apos_horario_w = 'S' AND ie_dose_especial_ww = 'S') or
				((dt_horario_w > clock_timestamp()) or (ie_origem_lote_p = 'AIP') or (ie_origem_lote_p = 'AIS'))) then		
				begin
				insert into ap_lote_item(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_lote,
					nr_seq_mat_hor,
					ie_prescrito,
					qt_dispensar,
					qt_total_dispensar,
					cd_material,
					cd_unidade_medida,
					ie_urgente)
				values (nextval('ap_lote_item_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_sequencia_w,
					nr_seq_mat_hor_w,
					'S',
					coalesce(qt_dispensar_hor_w,0),
					qt_dispensar_w,
					cd_material_w,
					cd_unidade_medida_w,
					ie_urgente_w);
					
				update	prescr_mat_hor
				set	nr_seq_lote	= nr_sequencia_w
				where	nr_sequencia	= nr_seq_mat_hor_w;
				
				update 	prescr_mat_alteracao
				set 	nr_seq_lote = nr_sequencia_w
				where	nr_prescricao = nr_prescricao_p
				and		nr_seq_horario = nr_seq_mat_hor_w
				and		nr_seq_prescricao = nr_item_prescr_w;
				
				 for r001 in c010 loop
					UPDATE cpoe_order_unit
					SET    nr_seq_lote = nr_sequencia_w
					WHERE  nr_sequencia = r001.nr_sequencia;
				 end loop;
				
				end;
			end if;	
			end;
		end loop;
		close C001;
		
		select	Obter_se_setor_lote(cd_setor_atendimento)
		into STRICT	ie_setor_lote_w
		from	prescr_medica
		where	nr_prescricao = nr_prescricao_p;
		
		if (ie_setor_lote_w = 'S') and (ie_somente_gerar_acm_sn_w = 'N') then
			begin
			
			if (ie_gerar_solucao_separado_w = 'S') then
				CALL gerar_lote_sep_solucao(nr_prescricao_p, 0, 0, ie_so_aprazado_p, nm_usuario_p, ie_origem_lote_p);
			end if;

			if (coalesce(ie_gera_lote_separado_w,'N') = 'S') then
				CALL gerar_mat_lote_separado(nr_prescricao_p, 0, 0, ie_so_aprazado_p, nm_usuario_p, ie_origem_lote_p);
			end if;
			
			open c05;
			loop
			fetch c05 into	
				nr_seq_lote_sep_w;
			EXIT WHEN NOT FOUND; /* apply on c05 */
				begin
				
				if (coalesce(nr_seq_regra_termo_w,0) > 0) and (coalesce(nr_seq_regra_termo_w,0) = coalesce(nr_seq_lote_sep_w,0)) then
					CALL gerar_lote_sep_termolabil(nr_prescricao_p, 0, 0, ie_so_aprazado_p, nm_usuario_p, ie_origem_lote_p);
				end if;

				if (coalesce(nr_seq_regra_ccih_w,0) > 0) and (coalesce(nr_seq_regra_ccih_w,0) = coalesce(nr_seq_lote_sep_w,0)) then
					CALL gerar_lote_sep_cih(nr_prescricao_p, 0, 0, ie_so_aprazado_p, nm_usuario_p, ie_origem_lote_p);
				end if;

				if (coalesce(nr_seq_regra_alto_risco_w,0) > 0) and (coalesce(nr_seq_regra_alto_risco_w,0) = coalesce(nr_seq_lote_sep_w,0)) then
					CALL gerar_lote_sep_alto_risco(nr_prescricao_p, 0, 0, ie_so_aprazado_p, nm_usuario_p, ie_origem_lote_p);
				end if;

				if (coalesce(nr_seq_regra_alto_custo_w,0) > 0) and (coalesce(nr_seq_regra_alto_custo_w,0) = coalesce(nr_seq_lote_sep_w,0)) then
					CALL gerar_lote_sep_alto_custo(nr_prescricao_p, 0, 0, ie_so_aprazado_p, nm_usuario_p, ie_origem_lote_p);
				end if;
				
				if (coalesce(nr_seq_regra_controlado_w,0) > 0) and (coalesce(nr_seq_regra_controlado_w,0) = coalesce(nr_seq_lote_sep_w,0)) then
					CALL gerar_lote_sep_controlado(nr_prescricao_p, 0, 0, ie_so_aprazado_p, nm_usuario_p, ie_origem_lote_p);
				end if;

				if (coalesce(nr_seq_regra_acm_w,0) > 0) and (coalesce(nr_seq_regra_acm_w,0) = coalesce(nr_seq_lote_sep_w,0)) then
					CALL gerar_lote_sep_acm(nr_prescricao_p, 0, 0, ie_so_aprazado_p, nm_usuario_p, ie_origem_lote_p);
				end if;

				if (coalesce(nr_seq_regra_sn_w,0) > 0) and (coalesce(nr_seq_regra_sn_w,0) = coalesce(nr_seq_lote_sep_w,0)) then
					CALL gerar_lote_sep_sn(nr_prescricao_p, 0, 0, ie_so_aprazado_p, nm_usuario_p, ie_origem_lote_p);
				end if;
				
				if (coalesce(nr_seq_regra_recomend_w,0) > 0) and (coalesce(nr_seq_regra_recomend_w,0) = coalesce(nr_seq_lote_sep_w,0)) then
					CALL gerar_lote_sep_recomend(nr_prescricao_p, 0, 0, ie_so_aprazado_p, nm_usuario_p, ie_origem_lote_p);
				end if;
				
				end;
			end loop;
			close c05;
			
			end;
		end if;
		
		open C03;
		loop
		fetch C03 into	
			cd_setor_atendimento_ww,
			nr_seq_turno_w,
			nr_seq_classif_w,
			qt_min_antes_atend_w,
			qt_min_receb_setor_w,
			qt_min_entr_setor_w,
			qt_min_disp_farm_w,
			qt_min_atend_farm_w,
			qt_min_inicio_atend_w,
			ie_hora_antes_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			if (ie_hora_antes_w = 'H') then
				begin
				update	ap_lote
				set	dt_atend_lote		= round(dt_prim_horario - dividir(qt_min_antes_atend_w,1440),'mi'),
					dt_limite_inicio_atend	= round(dt_prim_horario - dividir(qt_min_inicio_atend_w,1440),'mi'),
					dt_limite_atend		= round(dt_prim_horario - dividir(qt_min_atend_farm_w,1440),'mi'),
					dt_limite_disp_farm	= round(dt_prim_horario - dividir(qt_min_disp_farm_w,1440),'mi'),
					dt_limite_entrega_setor	= round(dt_prim_horario - dividir(qt_min_entr_setor_w,1440),'mi'),
					dt_limite_receb_setor	= round(dt_prim_horario - dividir(qt_min_receb_setor_w,1440),'mi')
				where	nr_prescricao		= nr_prescricao_p
				and	((coalesce(cd_setor_atendimento_ww::text, '') = '') or (cd_setor_atendimento_ww = cd_setor_atendimento))
				and	((coalesce(nr_seq_turno_w::text, '') = '') or (nr_seq_turno_w = nr_seq_turno))
				and	((coalesce(nr_seq_classif_w::text, '') = '') or (nr_seq_classif_w = nr_seq_classif));
				end;
			elsif (ie_hora_antes_w = 'I') then
				begin
				update	ap_lote
				set	dt_atend_lote		= round(dt_inicio_turno - dividir(qt_min_antes_atend_w,1440),'mi'),
					dt_limite_inicio_atend	= round(dt_prim_horario - dividir(qt_min_inicio_atend_w,1440),'mi'),
					dt_limite_atend		= round(dt_prim_horario - dividir(qt_min_atend_farm_w,1440),'mi'),
					dt_limite_disp_farm	= round(dt_prim_horario - dividir(qt_min_disp_farm_w,1440),'mi'),
					dt_limite_entrega_setor	= round(dt_prim_horario - dividir(qt_min_entr_setor_w,1440),'mi'),
					dt_limite_receb_setor	= round(dt_prim_horario - dividir(qt_min_receb_setor_w,1440),'mi')
				where	nr_prescricao		= nr_prescricao_p
				and	((coalesce(cd_setor_atendimento_ww::text, '') = '') or (cd_setor_atendimento_ww = cd_setor_atendimento))
				and	((coalesce(nr_seq_turno_w::text, '') = '') or (nr_seq_turno_w = nr_seq_turno))
				and	((coalesce(nr_seq_classif_w::text, '') = '') or (nr_seq_classif_w = nr_seq_classif));
				end;
			elsif (ie_hora_antes_w = 'T') then
				begin
				update	ap_lote
				set	dt_atend_lote		= CASE WHEN to_char(round(dt_inicio_turno - dividir(qt_min_antes_atend_w,1440),'mi'), 'hh24:mi:ss')='00:00:00' THEN  --OS186690
					round(dt_inicio_turno - dividir(qt_min_antes_atend_w,1440),'mi') + 1/86400  ELSE round(dt_inicio_turno - dividir(qt_min_antes_atend_w,1440),'mi') END ,
					dt_limite_inicio_atend	= CASE WHEN to_char(round(dt_inicio_turno - dividir(qt_min_inicio_atend_w,1440),'mi'), 'hh24:mi:ss')='00:00:00' THEN					round(dt_inicio_turno - dividir(qt_min_inicio_atend_w,1440),'mi') + 1/86400  ELSE round(dt_inicio_turno - dividir(qt_min_inicio_atend_w,1440),'mi') END , 
					dt_limite_atend		= round(dt_inicio_turno - dividir(qt_min_atend_farm_w,1440),'mi'),
					dt_limite_disp_farm	= round(dt_inicio_turno - dividir(qt_min_disp_farm_w,1440),'mi'),
					dt_limite_entrega_setor	= round(dt_inicio_turno - dividir(qt_min_entr_setor_w,1440),'mi'),
					dt_limite_receb_setor	= round(dt_inicio_turno - dividir(qt_min_receb_setor_w,1440),'mi')
				where	nr_prescricao		= nr_prescricao_p
				and	((coalesce(cd_setor_atendimento_ww::text, '') = '') or (cd_setor_atendimento_ww = cd_setor_atendimento))
				and	((coalesce(nr_seq_turno_w::text, '') = '') or (nr_seq_turno_w = nr_seq_turno))
				and	((coalesce(nr_seq_classif_w::text, '') = '') or (nr_seq_classif_w = nr_seq_classif));
				end;
			end if;
			end;
		end loop;
		close C03;
		
		begin
		select	nr_sequencia
		into STRICT	nr_seq_empresa_w
		from	empresa_integracao
		where	upper(nm_empresa) = 'SWISSLOG';
		
		select	'S'
		into STRICT	ie_existe_w
		from	far_setores_integracao
		where	nr_seq_empresa_int = nr_seq_empresa_w
		and	cd_setor_atendimento = cd_setor_atendimento_w;
		exception
		when others then
			nr_seq_empresa_w := 0;
			ie_existe_w := 'N';
		end;
		
		if (ie_existe_w = 'S') then
			
			select	coalesce(max(dt_prescricao),clock_timestamp())
			into STRICT 	dt_prescricao_w
			from	prescr_medica
			where	nr_prescricao = nr_prescricao_p;
						
			ie_origem_lote_w := ie_origem_lote_p;
			
			if (ie_origem_lote_p in ('AIP','AIS','AGND')) then
				ie_origem_lote_w := ie_origem_lote_p || nr_seq_mat_hor_aip_ais_w;
			end if;
			
			ds_param_integ_hl7_w := 'nr_atendimento=' || nr_atendimento_w || obter_separador_bv ||
						'nr_prescricao=' || nr_prescricao_p || obter_separador_bv ||
						'ie_aprazado=' || ie_origem_lote_w || obter_separador_bv ||
						'ie_origem=' || 'GLAP' || obter_separador_bv || 
						'nr_seq_horario_p=' || null || obter_separador_bv;
			
			if (obter_se_envia_swisslog(434, nr_prescricao_p, 'GLAP', ie_origem_lote_w) = 'S') then
				CALL swisslog_gerar_integracao(434, ds_param_integ_hl7_w);
				
				update	ap_lote
				set 	ie_integracao = 'W'
				where 	nr_prescricao = nr_prescricao_p;

			end if;

		end if;
		
		select	max(cd_setor_atendimento)
		into STRICT	cd_setor_atendimento_w
		from	prescr_medica
		where	nr_prescricao	= nr_prescricao_p;
		
		select	count(*)
		into STRICT	qt_existe_regra_w
		from	dis_regra_setor
		where	cd_setor_atendimento = cd_setor_atendimento_w;
		
		if (qt_existe_regra_w > 0) then
			begin
			CALL intdisp_gerar_mat_hor(nr_prescricao_p,'1');
			end;
		end if;
		
		if (ie_arq_pyxis_w = 'S') then
			begin
			select 	count(*)
			into STRICT	qt_existe_regra_w
			from	dis_regra_local
			where	cd_estabelecimento = cd_estabelecimento_w;
			
			if (coalesce(qt_existe_regra_w,0) > 0) then
				CALL dis_gerar_arq_prescr(nr_prescricao_p,'1');
			end if;
			end;
		end if;
		
		open C04;
		loop
		fetch C04 into	
			nr_sequencia_w;
		EXIT WHEN NOT FOUND; /* apply on C04 */
			begin
			
			select	obter_se_lote_rotina(nr_sequencia_w)
			into STRICT	ie_geracao_rotina_w
			;
			
			update	ap_lote
			set	ie_geracao_rotina = ie_geracao_rotina_w
			where	nr_sequencia = nr_sequencia_w;
			
			end;
		end loop;
		close C04;
			
	end if;
	
	open C07;
	loop
	fetch C07 into	
		nr_seq_lote_w;
	EXIT WHEN NOT FOUND; /* apply on C07 */
		begin
		
		select	max(cd_local_estoque)
		into STRICT	cd_local_estoque_w
		from 	ap_lote
		where 	nr_Sequencia = nr_seq_lote_w;
		
		reg_integracao_p.cd_estab_documento	:= cd_estabelecimento_w;
		reg_integracao_p.cd_local_estoque	:= cd_local_estoque_w;
		reg_integracao_p.cd_setor_atendimento	:= cd_setor_atendimento_w;
		reg_integracao_p.nr_seq_agrupador	:= nr_seq_lote_w;
		
		reg_integracao_p := gerar_int_padrao.gravar_integracao('260', nr_seq_lote_w, nm_usuario_p, reg_integracao_p);
		
		ds_param_bifrost_w := '{"batchCode" : ' || nr_seq_lote_w ||
							' , "personCode" : "' || cd_pessoa_fisica_w || '"' ||
							' , "encounterNumber" : ' || nr_atendimento_w ||'}';
		
		CALL execute_bifrost_integration(130,ds_param_bifrost_w);		
		end;
	end loop;
	close C07;
	
	select	coalesce(max(ie_gera_integracao),'N')
	into STRICT	ie_gera_integracao_w
	from	parametros_farmacia
	where	cd_estabelecimento	= cd_estabelecimento_w;
	
	if (ie_gera_integracao_w = 'S') then
		CALL disp_prescr_mat_hor(nr_prescricao_p,0,nm_usuario_p);
	end if;	
end if;

begin
  select  'S'
  into STRICT  ie_setor_supply_w
  from  far_setores_integracao
  where  nr_seq_empresa_int =  82 -- SupplyPoint
  and  cd_setor_atendimento = cd_setor_atendimento_w;
exception
when others then
  ie_setor_supply_w := 'N';
end;

begin
  select  'S'
  into STRICT  ie_setor_athena_w
  from  far_setores_integracao
  where  nr_seq_empresa_int = 221 -- Atenha
  and  cd_setor_atendimento = cd_setor_atendimento_w;
exception
when others then
  ie_setor_athena_w := 'N';
end;

if (ie_setor_supply_w = 'S' or ie_setor_athena_w = 'S') then

  select coalesce(max(ie_enviar_horarios_disp), 'N'),
		 coalesce(max(ie_enviar_mat_estoque), 'N')
  into STRICT ie_enviar_horarios_disp_w,
	   ie_enviar_mat_estoque_w
  from parametros_farmacia
  where cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

	open c08;
	loop
	fetch c08 into
	cd_material_w,
	nr_seq_lote_integracao_w,
	nr_seq_material_hl7_w,
	nr_seq_regra_local_w;
	EXIT WHEN NOT FOUND; /* apply on c08 */
		begin
		ds_param_integ_hl7_w := 'nr_atendimento=' || nr_atendimento_w || obter_separador_bv ||
			'nr_prescricao=' || nr_prescricao_p || obter_separador_bv ||
			'nr_seq_lote=' || nr_seq_lote_integracao_w || obter_separador_bv ||
			'cd_material_presc=' || cd_material_w || obter_separador_bv ||
			'ie_aprazado=' || 'GPMH' || obter_separador_bv ||
			'ie_origem=' || 'GLAP' || obter_separador_bv ||
			'nr_seq_material=' || nr_seq_material_hl7_w || obter_separador_bv ||
			'ie_enviar_horarios_disp=' || ie_enviar_horarios_disp_w || obter_separador_bv ||
			'ie_enviar_mat_estoque=' || ie_enviar_mat_estoque_w || obter_separador_bv;
			
		if (nr_seq_regra_local_w IS NOT NULL AND nr_seq_regra_local_w::text <> '') then
			select	max(nr_seq_estrut_int)
			into STRICT	nr_seq_estrut_int_w
			from	regra_local_dispensacao
			where	nr_sequencia = nr_seq_regra_local_w;
			
			if (nr_seq_estrut_int_w IS NOT NULL AND nr_seq_estrut_int_w::text <> '') then
				select	coalesce(max(ie_integracao_dispensario), 'N')
				into STRICT	ie_integracao_dispensario_w
				from	mat_estrutura
				where	nr_sequencia = nr_seq_estrut_int_w;
				
				if (ie_integracao_dispensario_w = 'S') then
					ie_setor_supply_w := 'S';
					ie_setor_athena_w := 'N';
				elsif (ie_integracao_dispensario_w = 'A') then
					ie_setor_athena_w := 'S';
					ie_setor_supply_w := 'N';
				end if;
			end if;
		end if;
		if (ie_setor_supply_w = 'S') then		
			CALL gravar_agend_integracao(434,ds_param_integ_hl7_w, cd_setor_atendimento_w);
		end if;
		if (ie_setor_athena_w = 'S') then
			CALL gravar_agend_integracao(921,ds_param_integ_hl7_w, cd_setor_atendimento_w);
		end if;
		end;
	end loop;
	close c08;

	open c08;
	loop
	fetch c08 into
	cd_material_w,
	nr_seq_lote_integracao_w,
	nr_seq_material_hl7_w,
	nr_seq_regra_local_w;
	EXIT WHEN NOT FOUND; /* apply on c08 */
		begin
		update ap_lote
		set  ie_integracao = 'P'
		where  nr_sequencia = nr_seq_lote_integracao_w;
		end;
	end loop;
	close c08;
end if;

exception
when others then
	ds_erro_w := substr(nr_prescricao_p || SQLERRM(SQLSTATE) || DBMS_UTILITY.FORMAT_ERROR_BACKTRACE,1,2000);
	insert into log_tasy(
		dt_atualizacao,
		nm_usuario,
		cd_log,
		ds_log)
	values (	clock_timestamp(),
		nm_usuario_p,
		4141,
		ds_erro_w);
	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
end;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_lote_atend_prescricao ( nr_prescricao_p bigint, nr_sequencia_p bigint, nr_seq_horario_p bigint, ie_so_aprazado_p text, nm_usuario_p text, ie_origem_lote_p text, nr_etapa_p bigint default 0) FROM PUBLIC;

