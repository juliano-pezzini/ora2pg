-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_sangue_pend_pac (nr_seq_reserva_p bigint, nr_seq_item_reserva_p bigint) AS $body$
DECLARE


nr_sequencia_w san_reserva.nr_sequencia%type;

BEGIN
select 	max(b.nr_sequencia)
into STRICT	nr_sequencia_w
from	san_reserva_item c,
		san_reserva b,
		san_transfusao a
where	c.nr_seq_reserva = b.nr_sequencia
and		b.nr_sequencia = nr_seq_reserva_p
and     nr_seq_derivado not in (SELECT  nr_seq_derivado
								from    san_producao x,
										san_emprestimo y
								where   y.nr_sequencia = x.nr_seq_emp_ent
								and     y.cd_pf_destino = b.cd_pessoa_fisica);
								
if (coalesce(nr_sequencia_w,0) > 0) then
	update san_reserva_item
	set IE_PEND_PACIENTE = 'S'
	where nr_seq_reserva = nr_sequencia_w
    and (nr_seq_item = nr_seq_item_reserva_p or coalesce(nr_seq_item_reserva_p::text, '') = '');
	
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_sangue_pend_pac (nr_seq_reserva_p bigint, nr_seq_item_reserva_p bigint) FROM PUBLIC;

