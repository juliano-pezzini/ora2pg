-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_d301_segmento_txt ( nr_seq_dataset_p bigint, nm_usuario_p text) AS $body$
DECLARE



nr_seq_atend_prev_alta_w	atend_previsao_alta.nr_sequencia%type;
ds_justificativa_w		atend_prev_alta_just.ds_justificativa%type;
ds_texto_w			varchar(70);
qt_tamanho_w			bigint;
pos_ini_w			integer;
pos_final_w			integer;

c01 CURSOR FOR
SELECT	substr(ds_justificativa,1,70) ds_justificativa
from	atend_prev_alta_just
where	nr_sequencia	= nr_seq_atend_prev_alta_w
and	(ds_justificativa IS NOT NULL AND ds_justificativa::text <> '');

c01_w	c01%rowtype;


BEGIN

select	max(nr_seq_atend_prev_alta)
into STRICT	nr_seq_atend_prev_alta_w
from	d301_dataset_envio
where	nr_sequencia	= nr_seq_dataset_p;

select	length(ds_justificativa),
	ds_justificativa
into STRICT	qt_tamanho_w,
	ds_justificativa_w
from	atend_prev_alta_just
where	nr_sequencia	= nr_seq_atend_prev_alta_w
and	(ds_justificativa IS NOT NULL AND ds_justificativa::text <> '');

pos_ini_w	:= 1;
pos_final_w	:= 70;

while(ds_justificativa_w IS NOT NULL AND ds_justificativa_w::text <> '') loop

	select	substr(ds_justificativa_w,pos_ini_w,pos_final_w)
	into STRICT	ds_texto_w
	;

	if ((trim(both ds_texto_w) IS NOT NULL AND (trim(both ds_texto_w))::text <> '')) then

		insert into D301_SEGMENTO_TXT(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_justificativa_med,
			nr_seq_dataset,
			nr_seq_dataset_ret)
		values (nextval('d301_segmento_txt_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			ds_texto_w,
			nr_seq_dataset_p,
			null);
	end if;

	select	substr(ds_justificativa_w,pos_ini_w,4000)
	into STRICT	ds_justificativa_w
	;

	pos_ini_w	:= pos_final_w + 1;

end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_d301_segmento_txt ( nr_seq_dataset_p bigint, nm_usuario_p text) FROM PUBLIC;

