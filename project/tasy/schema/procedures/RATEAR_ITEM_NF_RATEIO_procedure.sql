-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ratear_item_nf_rateio (nr_sequencia_p bigint) AS $body$
DECLARE


vl_desc_item_w  			double precision	:= 0;
vl_desc_rateio_w  			double precision	:= 0;
vl_desc_total_w  			double precision	:= 0;
vl_frete_item_w  			double precision	:= 0;
vl_frete_rateio_w  			double precision	:= 0;
vl_frete_total_w  			double precision	:= 0;
vl_seg_item_w 	 		double precision	:= 0;
vl_seg_rateio_w  			double precision	:= 0;
vl_seg_total_w  			double precision	:= 0;
vl_desp_item_w  			double precision	:= 0;
vl_desp_rateio_w  			double precision	:= 0;
vl_desp_total_w  			double precision	:= 0;
vl_tributo_item_w			double precision	:= 0;
vl_tributo_rateio_w			double precision	:= 0;
vl_tributo_total_w			double precision	:= 0;
nr_ult_sequencia_w			bigint;
nr_seq_item_nf_w			bigint;
nr_sequencia_w			bigint;
vl_rateio_w			double precision;
vl_total_w			double precision;
ie_desp_aces_custo_item_w		varchar(01);
ie_trib_item_rat_w			varchar(1);
vl_desp_doc_w			nota_fiscal_item.vl_despesa_doc%type;
vl_desp_doc_rateio_w		nota_fiscal_item_rateio.vl_despesa_doc%type;
vl_desp_doc_total_w		nota_fiscal_item_rateio.vl_despesa_doc%type;
ie_desp_doc_w				funcao_param_usuario.vl_parametro%type;

c01 CURSOR FOR
SELECT 	a.nr_item_nf,
	coalesce(a.vl_desconto,0) + coalesce(vl_desconto_rateio,0),
	coalesce(a.vl_frete,0),
	coalesce(a.vl_seguro,0),
	coalesce(a.vl_despesa_acessoria,0),
	coalesce(a.vl_despesa_doc,0)
from 	nota_fiscal_item a
where	a.nr_sequencia 	= nr_sequencia_p
and	((coalesce(a.vl_desconto,0) + coalesce(vl_desconto_rateio,0) + coalesce(a.vl_frete,0) + coalesce(a.vl_seguro,0) + coalesce(a.vl_despesa_acessoria,0) + coalesce(a.vl_despesa_doc, 0)) > 0)
and	exists (
	SELECT	1
	from	nota_fiscal_item_rateio b
	where	b.nr_seq_nota	= a.nr_sequencia
	and	b.nr_item_nf	= a.nr_item_nf)

union all

select 	a.nr_item_nf,
	coalesce(a.vl_desconto,0) + coalesce(vl_desconto_rateio,0),
	coalesce(a.vl_frete,0),
	coalesce(a.vl_seguro,0),
	coalesce(a.vl_despesa_acessoria,0),
	coalesce(a.vl_despesa_doc,0)
from 	nota_fiscal_item a
where	a.nr_sequencia 	= nr_sequencia_p
and	((coalesce(a.vl_desconto,0) + coalesce(vl_desconto_rateio,0) + coalesce(a.vl_frete,0) + coalesce(a.vl_seguro,0) + coalesce(a.vl_despesa_acessoria,0) + coalesce(a.vl_despesa_doc, 0)) = 0)
and	exists (	select	1
		from	nota_fiscal_item_rateio b
		where	b.nr_seq_nota	= a.nr_sequencia
		and	b.nr_item_nf	= a.nr_item_nf)
and	exists (	select	1
		from	nota_fiscal_item_trib x,
			tributo t
		where	x.nr_sequencia = a.nr_sequencia
		and	x.nr_item_nf = a.nr_item_nf
		and	x.cd_tributo = t.cd_tributo
		and	ie_soma_diminui in ('S','D'))
and	ie_trib_item_rat_w = 'S';

c02 CURSOR FOR
SELECT	nr_sequencia,
	vl_rateio
from	nota_fiscal_item_rateio
where	nr_seq_nota	= nr_sequencia_p
and	nr_item_nf	= nr_seq_item_nf_w;


BEGIN

ie_desp_doc_w := coalesce(obter_valor_param_usuario(40,507,obter_perfil_ativo,wheb_usuario_pck.get_nm_usuario,wheb_usuario_pck.get_cd_estabelecimento ),'N');

select	ie_desp_aces_custo_item
into STRICT	ie_desp_aces_custo_item_w
from	parametro_estoque b,
	nota_fiscal a
where	a.nr_sequencia	= nr_sequencia_p
and	a.cd_estabelecimento	= b.cd_estabelecimento;

select	coalesce(max(ie_trib_item_rat),'N')
into STRICT	ie_trib_item_rat_w
from	parametro_compras b,
	nota_fiscal a
where	a.nr_sequencia	= nr_sequencia_p
and	a.cd_estabelecimento	= b.cd_estabelecimento;

open c01;
loop
fetch c01 into
	nr_seq_item_nf_w,
	vl_desc_item_w,
	vl_frete_item_w,
	vl_seg_item_w,
	vl_desp_item_w,
	vl_desp_doc_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	if (ie_desp_aces_custo_item_w = 'N') then
		vl_desp_item_w	:= 0;
	end if;
	
	if (ie_trib_item_rat_w = 'S') then
		select	coalesce(sum(CASE WHEN b.ie_soma_diminui='S' THEN a.vl_tributo WHEN b.ie_soma_diminui='D' THEN (a.vl_tributo * -1) END ),0)
		into STRICT	vl_tributo_item_w
		from	nota_fiscal_item_trib a,
			tributo b
		where	a.cd_tributo = b.cd_tributo
		and	b.ie_soma_diminui in ('S','D')
		and	a.nr_sequencia = nr_sequencia_p
		and	a.nr_item_nf = nr_seq_item_nf_w;	
	end if;
	
	select	sum(vl_rateio)
	into STRICT	vl_total_w
	from	nota_fiscal_item_rateio
	where	nr_seq_nota	= nr_sequencia_p
	and	nr_item_nf	= nr_seq_item_nf_w;

	vl_desc_total_w		:= 0;
	vl_frete_total_w	:= 0;
	vl_seg_total_w		:= 0;
	vl_desp_total_w		:= 0;
	vl_tributo_total_w	:= 0;
	vl_desp_doc_total_w	:= 0;

	open c02;
	loop
	fetch c02 into
		nr_sequencia_w,
		vl_rateio_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		nr_ult_sequencia_w := nr_sequencia_w;
		vl_desc_rateio_w	:= (vl_desc_item_w / vl_total_w * vl_rateio_w);
		vl_desc_total_w	:= vl_desc_total_w + vl_desc_rateio_w;

		vl_frete_rateio_w	:= (vl_frete_item_w / vl_total_w * vl_rateio_w);
	     	vl_frete_total_w	:= vl_frete_total_w + vl_frete_rateio_w;

		vl_seg_rateio_w	:= (vl_seg_item_w / vl_total_w * vl_rateio_w);
		vl_seg_total_w	:= vl_seg_total_w + vl_seg_rateio_w;

		vl_desp_rateio_w	:= (vl_desp_item_w / vl_total_w * vl_rateio_w);
		vl_desp_total_w		:= vl_desp_total_w + vl_desp_rateio_w;
		
		vl_desp_doc_rateio_w	:= (vl_desp_doc_w / vl_total_w * vl_rateio_w);
		vl_desp_doc_total_w	:= vl_desp_doc_total_w + vl_desp_doc_rateio_w;
		
		vl_tributo_rateio_w	:= (vl_tributo_item_w / vl_total_w * vl_rateio_w);
		vl_tributo_total_w	:= vl_tributo_total_w + vl_tributo_rateio_w;

		update	nota_fiscal_item_rateio
		set	vl_desconto	= vl_desc_rateio_w,
			vl_frete          	= vl_frete_rateio_w,
			vl_seguro         	= vl_seg_rateio_w,
			vl_despesa_acessoria	= vl_desp_rateio_w,
			vl_tributo		= vl_tributo_rateio_w
        	where	nr_sequencia	= nr_sequencia_w;
		
		if (ie_desp_doc_w = 'S') then --alterar antes de commit
			update	nota_fiscal_item_rateio
			set	vl_despesa_doc	= vl_desp_doc_rateio_w
			where	nr_sequencia	= nr_sequencia_w;
		end if;
		end;
	end loop;
	close c02;

	/* alocar a diferenca de arredondamento no ultimo item do rateio */

	if (nr_ult_sequencia_w <> 0) then
		update	nota_fiscal_item_rateio
		set	vl_desconto	= coalesce(vl_desconto + (vl_desc_item_w - vl_desc_total_w),0),
			vl_frete		= vl_frete + (vl_frete_item_w - vl_frete_total_w),
			vl_seguro		= vl_seguro + (vl_seg_item_w - vl_seg_total_w),
			vl_despesa_acessoria	= vl_despesa_acessoria + (vl_desp_item_w - vl_desp_total_w),
			vl_tributo		= vl_tributo + (vl_tributo_item_w - vl_tributo_total_w)
		where	nr_sequencia	= nr_sequencia_w;
		
		if (ie_desp_doc_w = 'S') then --alterar antes de commit
			update	nota_fiscal_item_rateio
			set	vl_despesa_doc	= coalesce(vl_despesa_doc,0) + (vl_desp_doc_w - vl_desp_doc_total_w)
			where	nr_sequencia	= nr_sequencia_w;
		end if;
		
	end if;
	end;
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ratear_item_nf_rateio (nr_sequencia_p bigint) FROM PUBLIC;

