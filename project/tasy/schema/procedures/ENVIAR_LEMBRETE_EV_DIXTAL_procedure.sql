-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_lembrete_ev_dixtal ( nr_seq_evento_p bigint, nm_usuario_p text, ie_action_p text default 'I') is ds_mensagem_w varchar(4000) RETURNS varchar AS $body$
BEGIN
	
	if (ie_dia_semana_p	= 2) then
		return 'MON^MONDAY^HL70267';
	elsif (ie_dia_semana_p	= 3) then
		return 'TUE^TUESDAY^HL70267';
	elsif (ie_dia_semana_p	= 4) then
		return 'WED^WEDNESDAY^HL70267';
	elsif (ie_dia_semana_p	= 5) then
		return 'THU^THURSDAY^HL70267';
	elsif (ie_dia_semana_p	= 6) then
		return 'FRI^FRIDAY^HL70267';
	elsif (ie_dia_semana_p	= 7) then
		return 'SAT^SATURDAY^HL70267';
	elsif (ie_dia_semana_p	= 1) then
		return 'SUN^SUNDAY^HL70267';
	end if;
	
	return null;
	end;

Begin


delete	from	w_dixtal_ev_lembrete
where	nr_seq_evento	= nr_seq_evento_p;

Select	count(*)
into STRICT	qt_reg_w
from	ev_evento_pac_destino
where	nr_seq_ev_pac = nr_seq_evento_p
and	ie_forma_ev in ('5','6','7');

if ( qt_reg_w > 0) then

	Select	cd_pessoa_fisica,
		nr_atendimento,
		ds_mensagem
	into STRICT	cd_pessoa_fisica_w,
		nr_atendimento_w,
		ds_mensagem_w
	from	ev_evento_paciente
	where	nr_sequencia = nr_seq_evento_p;

	
	open C01;
	loop
	fetch C01 into	
		nr_seq_pac_destino_w,
		cd_pessoa_destino_w,
		nm_usuario_dest_w,
		ie_forma_ev_w,
		ie_pessoa_destino_w,
		ie_frequencia_w,
		NR_DIAS_INTERVALO_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		
		set_id_w := 0;
	
		/* 	Identificador do lembrete	*/
	
		
		set_id_w := set_id_w + 1;	
		insert	into   w_dixtal_ev_lembrete(	nr_sequencia,
							nr_id_obx,
							nr_seq_evento,
							ie_value_type,
							ds_obs_identifier,
							ds_obs_identifier_text,
							ds_obs_identifier_name,						
							ds_obs_value,
							ie_obs_result_status,
							nm_usuario,
							nm_usuario_nrec,
							dt_atualizacao,
							dt_atualizacao_nrec
							)
					Values (	nextval('w_dixtal_ev_lembrete_seq'),
							set_id_w,
							nr_seq_evento_p,
							'ST',
							'DX01-001',
							'D',
							'DX',
							to_char(nr_seq_evento_p),
							'F',
							nm_usuario_p,
							nm_usuario_p,
							clock_timestamp(),
							clock_timestamp());
							
							
		/* 	Acao	*/

		
		
		if (ie_action_p	= 'R') then
		
			set_id_w := set_id_w + 1;
			insert	into   w_dixtal_ev_lembrete(	nr_sequencia,
								nr_id_obx,
								nr_seq_evento,
								ie_value_type,
								ds_obs_identifier,
								ds_obs_identifier_text,
								ds_obs_identifier_name,
								ds_obs_value,
								ie_obs_result_status,
								nm_usuario,
								nm_usuario_nrec,
								dt_atualizacao,
								dt_atualizacao_nrec
								)
						Values (	nextval('w_dixtal_ev_lembrete_seq'),
								set_id_w,
								nr_seq_evento_p,
								'CE',
								'DX01-002',
								'ACTION',
								'DX',
								'DX01-004^REMOVE^DX',
								'F',
								nm_usuario_p,
								nm_usuario_p,
								clock_timestamp(),
								clock_timestamp());
		
		elsif (ie_action_p	= 'I') then
		
			set_id_w := set_id_w + 1;
			insert	into   w_dixtal_ev_lembrete(	nr_sequencia,
								nr_id_obx,
								nr_seq_evento,
								ie_value_type,
								ds_obs_identifier,
								ds_obs_identifier_text,
								ds_obs_identifier_name,
								ds_obs_value,
								ie_obs_result_status,
								nm_usuario,
								nm_usuario_nrec,
								dt_atualizacao,
								dt_atualizacao_nrec
								)
						Values (	nextval('w_dixtal_ev_lembrete_seq'),
								set_id_w,
								nr_seq_evento_p,
								'CE',
								'DX01-002',
								'ACTION',
								'DX',
								'DX01-003^ADD^DX',
								'F',
								nm_usuario_p,
								nm_usuario_p,
								clock_timestamp(),
								clock_timestamp());

			/* 	Texto do lembrete	*/

			
			
			
			RAISE NOTICE '%', ds_mensagem_w;
			
			ds_mensagem_w	:= replace(ds_mensagem_w,chr(10),' ');
			
			RAISE NOTICE '%', ds_mensagem_w;
			
			set_id_w := set_id_w + 1;
			
			insert	into   w_dixtal_ev_lembrete(	nr_sequencia,
								nr_id_obx,
								nr_seq_evento,
								ie_value_type,
								ds_obs_identifier,
								ds_obs_identifier_text,
								ds_obs_identifier_name,
								ds_obs_value,
								ie_obs_result_status,
								nm_usuario,
								nm_usuario_nrec,
								dt_atualizacao,
								dt_atualizacao_nrec
								)
						Values (	nextval('w_dixtal_ev_lembrete_seq'),
								set_id_w,
								nr_seq_evento_p,
								'ST',
								'DX01-005',
								'TEXT',
								'DX',
								substr(ds_mensagem_w,1,255),
								'F',
								nm_usuario_p,
								nm_usuario_p,
								clock_timestamp(),
								clock_timestamp());

			/* 	Opcao de exibicao	*/

			
			If (ie_forma_ev_w  = '6') then
			
				ds_forma_envio_w := 'DX01-008^CENTRAL^DX';
			
			elsif (ie_forma_ev_w  = '7') then	

				ds_forma_envio_w := 'DX01-007^MONITOR^DX';
				
			else	
				ds_forma_envio_w := 'DX01-009^BOTH^DX';	
			
			end if;	

			set_id_w := set_id_w + 1;	
			
			insert	into   w_dixtal_ev_lembrete(	nr_sequencia,
								nr_id_obx,
								nr_seq_evento,
								ie_value_type,
								ds_obs_identifier,
								ds_obs_identifier_text,
								ds_obs_identifier_name,
								ds_obs_value,
								ie_obs_result_status,
								nm_usuario,
								nm_usuario_nrec,
								dt_atualizacao,
								dt_atualizacao_nrec
								)
						Values (	nextval('w_dixtal_ev_lembrete_seq'),
								set_id_w,
								nr_seq_evento_p,
								'CE',
								'DX01-006',
								'DISPLAY',
								'DX',
								ds_forma_envio_w,
								'F',
								nm_usuario_p,
								nm_usuario_p,
								clock_timestamp(),
								clock_timestamp());
			
			
			/* 	Opcao Aplicar a todos os atendimentos		*/

			
			set_id_w := set_id_w + 1;
			
			insert	into   w_dixtal_ev_lembrete(	nr_sequencia,
								nr_id_obx,
								nr_seq_evento,
								ie_value_type,
								ds_obs_identifier,
								ds_obs_identifier_text,
								ds_obs_identifier_name,
								ds_obs_value,
								ie_obs_result_status,
								nm_usuario,
								nm_usuario_nrec,
								dt_atualizacao,
								dt_atualizacao_nrec
								)
						Values (	nextval('w_dixtal_ev_lembrete_seq'),
								set_id_w,
								nr_seq_evento_p,
								'CE',
								'DX01-010',
								'APPLY TO ALL',
								'DX',
								'DX01-011^NO^DX',
								'F',
								nm_usuario_p,
								nm_usuario_p,
								clock_timestamp(),
								clock_timestamp());		
				
			
			/* 	Frequencia	na  data	*/

			set_id_w := set_id_w + 1;	
			
			
			if (ie_frequencia_w	= 'D') then
			
			
				insert	into   w_dixtal_ev_lembrete(	nr_sequencia,
									nr_id_obx,
									nr_seq_evento,
									ie_value_type,
									ds_obs_identifier,
									ds_obs_identifier_text,
									ds_obs_identifier_name,
									ds_obs_value,
									ie_obs_result_status,
									nm_usuario,
									nm_usuario_nrec,
									dt_atualizacao,
									dt_atualizacao_nrec
									)
							Values (	nextval('w_dixtal_ev_lembrete_seq'),
									set_id_w,
									nr_seq_evento_p,
									'CE',
									'260864003',
									'FREQUENCY',
									'SNM',
									'307486002^SINGLE EVENT^SNM',
									'F',
									nm_usuario_p,
									nm_usuario_p,
									clock_timestamp(),
									clock_timestamp());			
			
				open C02;
				loop
				fetch C02 into	
					Data_w;
				EXIT WHEN NOT FOUND; /* apply on C02 */
					begin
						
					set_id_w := set_id_w + 1;
					
					/* 	Detalhe da frequencia	*/
	
					
					insert	into   w_dixtal_ev_lembrete(	nr_sequencia,
										nr_id_obx,
										nr_seq_evento,
										ie_value_type,
										ds_obs_identifier,
										ds_obs_identifier_text,
										ds_obs_identifier_name,
										ds_obs_value,
										ie_obs_result_status,
										nm_usuario,
										nm_usuario_nrec,
										dt_atualizacao,
										dt_atualizacao_nrec
										)
								Values (	nextval('w_dixtal_ev_lembrete_seq'),
										set_id_w,
										nr_seq_evento_p,
										'DT',
										'410671006',
										'DATE',
										'SNM',
										to_char(Data_w,'YYYYMMDD'),
										'F',
										nm_usuario_p,
										nm_usuario_p,
										clock_timestamp(),
										clock_timestamp());

					open C03;
					loop
					fetch C03 into	
						Dt_horario_w;
					EXIT WHEN NOT FOUND; /* apply on C03 */
						begin
					
						/* 	Horarios de exibicao		*/

						
						set_id_w := set_id_w + 1;
						
						insert	into   w_dixtal_ev_lembrete(	nr_sequencia,
											nr_id_obx,
											nr_seq_evento,
											ie_value_type,
											ds_obs_identifier,
											ds_obs_identifier_text,
											ds_obs_identifier_name,
											ds_obs_value,
											ie_obs_result_status,
											nm_usuario,
											nm_usuario_nrec,
											dt_atualizacao,
											dt_atualizacao_nrec
											)
									Values (	nextval('w_dixtal_ev_lembrete_seq'),
											set_id_w,
											nr_seq_evento_p,
											'TM',
											'410670007',
											'TIME',
											'SNM',
											to_char(dt_horario_w,'HH24MI'),
											'F',
											nm_usuario_p,
											nm_usuario_p,
											clock_timestamp(),
											clock_timestamp());				
					
						end;
						end loop;
						close C03;		
				
				end;
				end loop;
				close C02;		
				
			elsif (ie_frequencia_w	= 'ID') then
			
			
				set_id_w := set_id_w + 1;
				insert	into   w_dixtal_ev_lembrete(	nr_sequencia,
									nr_id_obx,
									nr_seq_evento,
									ie_value_type,
									ds_obs_identifier,
									ds_obs_identifier_text,
									ds_obs_identifier_name,
									ds_obs_value,
									ie_obs_result_status,
									nm_usuario,
									nm_usuario_nrec,
									dt_atualizacao,
									dt_atualizacao_nrec
									)
							Values (	nextval('w_dixtal_ev_lembrete_seq'),
									set_id_w,
									nr_seq_evento_p,
									'CE',
									'260864003',
									'FREQUENCY',
									'SNM',
									'69620002^DAILY^SNM',
									'F',
									nm_usuario_p,
									nm_usuario_p,
									clock_timestamp(),
									clock_timestamp());		
				set_id_w := set_id_w + 1;
				insert	into   w_dixtal_ev_lembrete(	nr_sequencia,
											nr_id_obx,
											nr_seq_evento,
											ie_value_type,
											ds_obs_identifier,
											ds_obs_identifier_text,
											ds_obs_identifier_name,
											ds_obs_value,
											ie_obs_result_status,
											nm_usuario,
											nm_usuario_nrec,
											dt_atualizacao,
											dt_atualizacao_nrec
											)
									Values (	nextval('w_dixtal_ev_lembrete_seq'),
											set_id_w,
											nr_seq_evento_p,
											'CE',
											'260864003',
											'INTERVALS OF DAYS',
											'SNM',
											NR_DIAS_INTERVALO_w,
											'F',
											nm_usuario_p,
											nm_usuario_p,
											clock_timestamp(),
											clock_timestamp());	
											
											
						
						
	
			
			
				open C04;
				loop
				fetch C04 into	
					Dt_horario_w;
				EXIT WHEN NOT FOUND; /* apply on C04 */
					begin
					set_id_w := set_id_w + 1;
					insert	into   w_dixtal_ev_lembrete(	nr_sequencia,
										nr_id_obx,
										nr_seq_evento,
										ie_value_type,
										ds_obs_identifier,
										ds_obs_identifier_text,
										ds_obs_identifier_name,
										ds_obs_value,
										ie_obs_result_status,
										nm_usuario,
										nm_usuario_nrec,
										dt_atualizacao,
										dt_atualizacao_nrec
										)
								Values (	nextval('w_dixtal_ev_lembrete_seq'),
										set_id_w,
										nr_seq_evento_p,
										'TM',
										'410670007',
										'TIME',
										'SNM',
										to_char(dt_horario_w,'HH24MI'),
										'F',
										nm_usuario_p,
										nm_usuario_p,
										clock_timestamp(),
										clock_timestamp());	
					
					end;
				end loop;
				close C04;
			
			
			elsif (ie_frequencia_w	= 'DOW') then
					
				set_id_w := set_id_w + 1;
				insert	into   w_dixtal_ev_lembrete(	nr_sequencia,
									nr_id_obx,
									nr_seq_evento,
									ie_value_type,
									ds_obs_identifier,
									ds_obs_identifier_text,
									ds_obs_identifier_name,
									ds_obs_value,
									ie_obs_result_status,
									nm_usuario,
									nm_usuario_nrec,
									dt_atualizacao,
									dt_atualizacao_nrec
									)
							Values (	nextval('w_dixtal_ev_lembrete_seq'),
									set_id_w,
									nr_seq_evento_p,
									'CE',
									'260864003',
									'FREQUENCY',
									'SNM',
									'14497002^WEEKLY^SNM',
									'F',
									nm_usuario_p,
									nm_usuario_p,
									clock_timestamp(),
									clock_timestamp());	
									
									
									
				open C05;
				loop
				fetch C05 into	
					IE_DIA_SEMANA_w;
				EXIT WHEN NOT FOUND; /* apply on C05 */
					begin
					set_id_w := set_id_w + 1;
					ds_dia_semana_w	:= obter_dia_semana_hl7(IE_DIA_SEMANA_w);
					insert	into   w_dixtal_ev_lembrete(	nr_sequencia,
										nr_id_obx,
										nr_seq_evento,
										ie_value_type,
										ds_obs_identifier,
										ds_obs_identifier_text,
										ds_obs_identifier_name,
										ds_obs_value,
										ie_obs_result_status,
										nm_usuario,
										nm_usuario_nrec,
										dt_atualizacao,
										dt_atualizacao_nrec
										)
								Values (	nextval('w_dixtal_ev_lembrete_seq'),
										set_id_w,
										nr_seq_evento_p,
										'CE',
										'307144000',
										'DAYS OF THE WEEK',
										'SNM',
										ds_dia_semana_w,
										'F',
										nm_usuario_p,
										nm_usuario_p,
										clock_timestamp(),
										clock_timestamp());	
					end;
				end loop;
				close C05;
			
			
				open C04;
				loop
				fetch C04 into	
					Dt_horario_w;
				EXIT WHEN NOT FOUND; /* apply on C04 */
					begin
					set_id_w := set_id_w + 1;
					insert	into   w_dixtal_ev_lembrete(	nr_sequencia,
										nr_id_obx,
										nr_seq_evento,
										ie_value_type,
										ds_obs_identifier,
										ds_obs_identifier_text,
										ds_obs_identifier_name,
										ds_obs_value,
										ie_obs_result_status,
										nm_usuario,
										nm_usuario_nrec,
										dt_atualizacao,
										dt_atualizacao_nrec
										)
								Values (	nextval('w_dixtal_ev_lembrete_seq'),
										set_id_w,
										nr_seq_evento_p,
										'TM',
										'410670007',
										'TIME',
										'SNM',
										to_char(dt_horario_w,'HH24MI'),
										'F',
										nm_usuario_p,
										nm_usuario_p,
										clock_timestamp(),
										clock_timestamp());	
					
					end;
				end loop;
				close C04;			
			
			
			end if;
		/* 	Envio de lembrete		*/

		
		end if;	
					
					
		if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then	
						
			Select	max(nr_seq_atepacu)
			into STRICT	nr_seq_atepacu_w	
			from	atendimento_paciente_v
			where	nr_atendimento = nr_atendimento_w;
			
			If (nr_seq_atepacu_w IS NOT NULL AND nr_seq_atepacu_w::text <> '') then

				ds_sep_bv_w := obter_separador_bv;
				
				ds_param_integ_hl7_w := 'nr_atendimento=' || nr_atendimento_w || ds_sep_bv_w ||	
							'nr_seq_interno=' || nr_seq_atepacu_w || ds_sep_bv_w ||	
							'cd_pessoa_fisica=' || cd_pessoa_fisica_w|| ds_sep_bv_w||
							'nr_seq_evento='||nr_seq_evento_p||ds_sep_bv_w;
							
				CALL gravar_agend_integracao(257, ds_param_integ_hl7_w);
				
				if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
		
			end if;
		end if;	
		
	
		
	end;
	end loop;
	close C01;
	

end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_lembrete_ev_dixtal ( nr_seq_evento_p bigint, nm_usuario_p text, ie_action_p text default 'I') is ds_mensagem_w varchar(4000) FROM PUBLIC;

