-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calculo_sinal_vital ( nm_usuario_p text, nr_atendimento_p bigint DEFAULT NULL) AS $body$
DECLARE


  qt_idade_w             bigint;
  cd_setor_atendimento_w bigint := NULL;
  qt_idade_dias_w        integer;
  qt_peso_gramas_w       double precision;
  ie_retorno_w           varchar(1) := 'N';
  ds_titulo_w            varchar(55);
  ds_alerta_w            varchar(255);
  ie_alerta_w            varchar(3);
  cd_pessoa_fisica_w     bigint;

  C01 CURSOR FOR
    SELECT DISTINCT c.DS_TITULO,
      c.DS_ALERTA,
      c.IE_ADVISORY_SEVERITY
    FROM GQA_PENDENCIA_PAC a,
      GQA_PENDENCIA_REGRA b,
      CALCULOS_ENGINE_ADVISORY c
    WHERE a.NR_SEQ_PEND_REGRA = b.NR_SEQUENCIA
    AND a.nr_atendimento      = nr_atendimento_p
    AND c.nr_seq_regra        = b.nr_sequencia;


BEGIN

  SELECT	substr(obter_pessoa_atendimento(nr_atendimento_p,'C'),1,10)
		INTO STRICT	cd_pessoa_fisica_w
;

  IF (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '' AND cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') THEN

    IF (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') THEN
      cd_setor_atendimento_w := obter_setor_atendimento(nr_atendimento_p);
    END IF;

    qt_idade_w       := obter_idade_pf(cd_pessoa_fisica_w,clock_timestamp(),'A');
    qt_idade_dias_w  := obter_idade_pf(cd_pessoa_fisica_w, clock_timestamp(), 'DIA');
    qt_peso_gramas_w := (coalesce(obter_peso_pf(cd_pessoa_fisica_w),0) * 1000);
    OPEN C01;

    LOOP
      FETCH C01 INTO 
        ds_titulo_w, 
        ds_alerta_w, 
        ie_alerta_w;
      EXIT WHEN NOT FOUND; /* apply on C01 */

      BEGIN
      
        INSERT
        INTO CALCULOS_ADVISORY(
            nr_sequencia,
            cd_pessoa_fisica,
            nr_atendimento,
            ie_situacao,
            nm_usuario_nrec,
            ds_titulo,
            ds_alerta,
            ie_advisory_severity,
            dt_atualizacao_nrec
          )
          VALUES (
            nextval('calculos_advisory_seq'),
            cd_pessoa_fisica_w,
            nr_atendimento_p,
            'A',
            nm_usuario_p,
            ds_titulo_w,
            ds_alerta_w,
            ie_alerta_w,
            clock_timestamp()
          );

        COMMIT;
      END;
    END LOOP;
    CLOSE C01;
  END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calculo_sinal_vital ( nm_usuario_p text, nr_atendimento_p bigint DEFAULT NULL) FROM PUBLIC;

