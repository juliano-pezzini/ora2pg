-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_dias_agend_duplic ( nr_seq_agend_p bigint, cd_pessoa_fisica_p text, cd_procedimento_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
 
dt_agenda_w 		timestamp;
qt_dias_regra_w		bigint;
qt_agendamentos_w 	bigint;
ds_agenda_w		varchar(255);		
hr_inicio_w		timestamp;


BEGIN 
 
select	max(dt_agenda) 
into STRICT	dt_agenda_w 
from	agenda_paciente 
where	nr_sequencia = nr_seq_agend_p;
 
select	obter_parametro_agenda(cd_estabelecimento_p, 'IE_DIAS_AGENDA_DUPLIC',null) 
into STRICT	qt_dias_regra_w
;
 
if (qt_dias_regra_w IS NOT NULL AND qt_dias_regra_w::text <> '') and (qt_dias_regra_w > 0)then 
 
	if (qt_dias_regra_w = 1) then 
		select 	count(*) 
		into STRICT	qt_agendamentos_w 
		from	agenda_paciente 
		where	cd_pessoa_fisica = cd_pessoa_fisica_p 
		and		cd_procedimento = cd_procedimento_p 
		and		trunc(dt_agenda) = dt_agenda_w 
		and		nr_sequencia <> nr_seq_agend_p 
		and		ie_status_Agenda	not in ('C','L','B');
		 
		if (coalesce(qt_agendamentos_w,0) > 0) then 
			select 	max(substr(obter_desc_agenda(cd_agenda),1,100)) 
			into STRICT	ds_agenda_w 
			from	agenda_paciente 
			where	cd_pessoa_fisica = cd_pessoa_fisica_p 
			and	cd_procedimento = cd_procedimento_p 
			and	trunc(dt_agenda) = dt_agenda_w 
			and	nr_sequencia <> nr_seq_agend_p 
			and	ie_status_Agenda	not in ('C','L','B');
		end if;
 
	else if (qt_dias_regra_w > 1) then 
	 
		qt_dias_regra_w := qt_dias_regra_w -1;
		 
		select 	count(*) 
		into STRICT	qt_agendamentos_w 
		from	agenda_paciente 
		where	cd_pessoa_fisica = cd_pessoa_fisica_p 
		and	cd_procedimento = cd_procedimento_p 
		and	trunc(dt_agenda) between(dt_agenda_w - qt_dias_regra_w) and (dt_agenda_w + qt_dias_regra_w) 
		and	nr_sequencia <> nr_seq_agend_p 
		and	ie_status_Agenda	not in ('C','L','B');
		 
		if (coalesce(qt_agendamentos_w,0) > 0) then 
			select 	max(substr(obter_desc_agenda(cd_agenda),1,100)), 
					max(dt_agenda), 
					max(hr_inicio) 
			into STRICT	ds_agenda_w, 
					dt_agenda_w, 
					hr_inicio_w 
			from	agenda_paciente 
			where	cd_pessoa_fisica = cd_pessoa_fisica_p 
			and	cd_procedimento = cd_procedimento_p 
			and	trunc(dt_agenda) between(dt_agenda_w - qt_dias_regra_w) and (dt_agenda_w + qt_dias_regra_w) 
			and	nr_sequencia <> nr_seq_agend_p 
			and	ie_status_Agenda	not in ('C','L','B');
		end if;
 
	end if;
	end if;
 
end if;
 
if (qt_agendamentos_w > 0) then 
	CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(207512, 'DS_SALA='||ds_agenda_w||';DT_AGENDA='||to_char(dt_agenda_w,'dd/mm/yyyy')||';HR_INICIO='||to_char(hr_inicio_w,'hh24:mi:ss'));
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_dias_agend_duplic ( nr_seq_agend_p bigint, cd_pessoa_fisica_p text, cd_procedimento_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

