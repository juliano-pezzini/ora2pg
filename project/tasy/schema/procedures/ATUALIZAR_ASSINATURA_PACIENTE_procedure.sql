-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_assinatura_paciente (nr_seq_internos_p text, ds_assinatura_p bytea, nm_usuario_p text) AS $body$
WITH RECURSIVE cte AS (
DECLARE


c01 is CURSOR
with data as (SELECT nr_seq_internos_p str )
SELECT trim(both regexp_substr(str, '[^,]+', 1, 1)) valor_w
from data
instr(str, ',', 1, level - 1) > 0  UNION ALL
DECLARE


c01 is CURSOR
with data as (SELECT nr_seq_internos_p str )
SELECT trim(both regexp_substr(str, '[^,]+', 1, (c.level+1))) valor_w
from data
instr(str, ',', 1, level - 1) > 0 JOIN cte c ON ()

) SELECT * FROM cte;
;

linha_w			            c01%rowtype;
nr_seq_proc_compl_w     prescr_procedimento.nr_seq_proc_compl%type;


BEGIN
  open C01;
  loop
  fetch C01 into
    linha_w;
  EXIT WHEN NOT FOUND; /* apply on c01 */
    begin
      if (linha_w.valor_w IS NOT NULL AND linha_w.valor_w::text <> '') then
        select nr_seq_proc_compl
        into STRICT nr_seq_proc_compl_w
        from prescr_procedimento
        where nr_seq_interno = linha_w.valor_w;

        if (coalesce(nr_seq_proc_compl_w::text, '') = '') then
	select nextval('prescr_procedimento_compl_seq')
	into STRICT nr_seq_proc_compl_w
	;

          insert into prescr_procedimento_compl(nr_sequencia, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, ds_assinatura_entrega_laudo)
          values (nr_seq_proc_compl_w, clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p, ds_assinatura_p);

          update prescr_procedimento
          set nr_seq_proc_compl = nr_seq_proc_compl_w
          where nr_seq_interno = linha_w.valor_w;
        else
          update prescr_procedimento_compl
          set dt_atualizacao = clock_timestamp(), nm_usuario = nm_usuario_p, ds_assinatura_entrega_laudo = ds_assinatura_p
          where nr_sequencia = nr_seq_proc_compl_w;
        end if;
      end if;
    end;
  end loop;
  commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_assinatura_paciente (nr_seq_internos_p text, ds_assinatura_p bytea, nm_usuario_p text) FROM PUBLIC;

