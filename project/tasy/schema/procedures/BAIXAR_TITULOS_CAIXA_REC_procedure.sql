-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baixar_titulos_caixa_rec ( nr_seq_caixa_rec_p bigint, ds_lista_titulo_p text, nr_titulo_p bigint, nm_usuario_p text, ds_msg_retorno_p INOUT text, ie_commit_p text default 'S') AS $body$
DECLARE


nr_titulo_w			bigint;
vl_saldo_titulo_w		double precision;
cd_estabelecimento_w		smallint;
dt_recebimento_w		timestamp;
nr_sequencia_w			integer;
cd_tipo_recebimento_w		integer;
nr_seq_trans_financ_w		bigint;
dt_liquidacao_w			timestamp;
ie_restringe_titulo_w		varchar(1)	:= 'N';
qt_reg_w			bigint;
ie_acao_w			smallint;
ie_juros_multa_w		varchar(1);
vl_juros_w			double precision;
vl_multa_w			double precision;
nr_seq_negociacao_origem_w	bigint;
qt_boleto_w			bigint;
qt_deb_cc_w			bigint;
nr_seq_trans_rec_neg_caixa_w	bigint;
vl_desconto_w			double precision;
ie_tipo_receb_titulo_cartao_w	varchar(1);
nr_seq_trans_caixa_w		bigint;
cd_tipo_receb_cartao_w		integer;
qt_cartao_w			bigint;
nr_documento_w			titulo_receber.nr_documento%type;
cd_centro_custo_w		titulo_receber_liq.cd_centro_custo%type;
nr_seq_trans_fin_baixa_w	titulo_receber.nr_seq_trans_fin_baixa%type;
nr_seq_motivo_desc_w		titulo_receber_liq_desc.nr_seq_motivo_desc%type;
cd_centro_custo_desc_w		titulo_receber_liq_desc.cd_centro_custo%type;
dt_limite_desconto_w		timestamp;
dt_recebimento_ww		timestamp;
ds_msg_retorno_w		varchar(4000);
ie_trans_fin_baixa_titulo_w	varchar(5);
retorno				bigint;
qt_tit_rec_liq_desc_w		bigint;
vl_tit_rec_liq_desc_w		double precision;
/* Projeto Multimoeda - Variaveis */

ie_saldo_estrang_w		varchar(1);
cd_moeda_w			integer;
vl_baixa_estrang_w		double precision;
vl_complemento_w		double precision;
vl_cotacao_w			cotacao_moeda.vl_cotacao%type;
vl_cotacao_tit_w		cotacao_moeda.vl_cotacao%type;
cd_moeda_tit_w			integer;
vl_var_cambial_w		double precision;
vl_cambial_ativo_w		double precision := 0;
vl_cambial_passivo_w		double precision := 0;
tx_desconto_w			titulo_receber.tx_desc_antecipacao%type;

c01 CURSOR FOR
SELECT	nr_titulo,
		vl_saldo_titulo,
		dt_liquidacao,
		cd_estabelecimento,
		coalesce((obter_juros_multa_titulo(nr_titulo,clock_timestamp(),'R','J'))::numeric ,0),
		coalesce((obter_juros_multa_titulo(nr_titulo,clock_timestamp(),'R','M'))::numeric ,0),
		coalesce(vl_desc_previsto,0),
		to_char(nr_documento), --lhalves os365812 em 27/12
		nr_seq_trans_fin_baixa,
		dt_limite_desconto,
		coalesce(tx_desc_antecipacao,0)
from	titulo_receber
where	' ' || ds_lista_titulo_p || ' ' like '% ' || nr_titulo || ' %'
and	ds_lista_titulo_p <> '0'

union

SELECT	nr_titulo,
		vl_saldo_titulo,
		dt_liquidacao,
		cd_estabelecimento,
		coalesce((obter_juros_multa_titulo(nr_titulo,clock_timestamp(),'R','J'))::numeric ,0),
		coalesce((obter_juros_multa_titulo(nr_titulo,clock_timestamp(),'R','M'))::numeric ,0),
		coalesce(vl_desc_previsto,0),
		to_char(nr_documento), --lhalves os365812 em 27/12
		nr_seq_trans_fin_baixa,
		dt_limite_desconto,
		coalesce(tx_desc_antecipacao,0)
from	titulo_receber
where	nr_titulo	= nr_titulo_p
and	nr_titulo_p 	> 0;


BEGIN

if (coalesce(ds_lista_titulo_p::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(179742);
end if;

select	a.dt_recebimento,
	a.nr_seq_trans_financ,
	c.cd_estabelecimento,
	obter_se_saldo_estrang(a.nr_seq_saldo_caixa)
into STRICT	dt_recebimento_w,
	nr_seq_trans_financ_w,
	cd_estabelecimento_w,
	ie_saldo_estrang_w
from	caixa c,
	caixa_saldo_diario b,
	caixa_receb a
where	a.nr_seq_saldo_caixa	= b.nr_sequencia
and	b.nr_seq_caixa		= c.nr_sequencia
and	a.nr_sequencia		= nr_seq_caixa_rec_p;

select	max(nr_seq_trans_rec_neg_caixa)
into STRICT	nr_seq_trans_rec_neg_caixa_w
from	parametro_contas_receber
where	cd_estabelecimento	= cd_estabelecimento_w;

ie_restringe_titulo_w := obter_param_usuario(813, 42, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_restringe_titulo_w);
ie_juros_multa_w := obter_param_usuario(813, 87, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_juros_multa_w);
ie_tipo_receb_titulo_cartao_w := obter_param_usuario(813, 106, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_tipo_receb_titulo_cartao_w);
cd_centro_custo_w := obter_param_usuario(813, 138, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, cd_centro_custo_w);
ie_trans_fin_baixa_titulo_w := obter_param_usuario(813, 153, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_trans_fin_baixa_titulo_w);

if (ds_lista_titulo_p IS NOT NULL AND ds_lista_titulo_p::text <> '') or (nr_titulo_p IS NOT NULL AND nr_titulo_p::text <> '') then

	open c01;
	loop
	fetch c01 into
		nr_titulo_w,
		vl_saldo_titulo_w,
		dt_liquidacao_w,
		cd_estabelecimento_w,
		vl_juros_w,
		vl_multa_w,
		vl_desconto_w,
		nr_documento_w,
		nr_seq_trans_fin_baixa_w,
		dt_limite_desconto_w,
		tx_desconto_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		
		
		select 	max(a.dt_recebimento)
		into STRICT	dt_recebimento_ww
		from	caixa_receb a
		where	a.nr_sequencia = nr_seq_caixa_rec_p;
		
		/*OS 2490420, Ja tratava o valor do desconto, por isso so vai tratar a taxa se nao tiver valor de desconto, ou um ou outro, dando prioridade ao valor que ja existia tratamento*/

		if (tx_desconto_w > 0) and (vl_desconto_w = 0) then
			vl_desconto_w := Obter_Desconto_tit_rec(nr_titulo_w);
		end if;
		
		vl_tit_rec_liq_desc_w := vl_desconto_w;
		
		if (vl_desconto_w <> 0)and (dt_limite_desconto_w IS NOT NULL AND dt_limite_desconto_w::text <> '')and ( trunc(dt_recebimento_ww) > trunc(dt_limite_desconto_w))then
			vl_desconto_w	:= 0;
			ds_msg_retorno_w :=  Wheb_mensagem_pck.get_texto(355706);			
		end if;
		
		select	coalesce(max(nr_sequencia) + 1,1)
		into STRICT	nr_sequencia_w
		from	titulo_receber_liq
		where	nr_titulo	= nr_titulo_w;
		
		select	max(nr_seq_negociacao_origem)
		into STRICT	nr_seq_negociacao_origem_w
		from	titulo_receber
		where	nr_titulo	= nr_titulo_w;
		
		select	count(*)
		into STRICT	qt_boleto_w
		from	negociacao_cr_boleto
		where	nr_titulo	= nr_titulo_w;
		
		select	count(*)
		into STRICT	qt_deb_cc_w
		from	negociacao_cr_deb_cc
		where	nr_titulo	= nr_titulo_w;
		
		if (coalesce(nr_seq_trans_fin_baixa_w,0) > 0) and (coalesce(ie_trans_fin_baixa_titulo_w,'N') = 'S') then
			nr_seq_trans_financ_w	:= nr_seq_trans_fin_baixa_w;		
		elsif (nr_seq_negociacao_origem_w IS NOT NULL AND nr_seq_negociacao_origem_w::text <> '') or (qt_deb_cc_w > 0) or (qt_boleto_w > 0) then
			nr_seq_trans_financ_w	:= coalesce(nr_seq_trans_rec_neg_caixa_w,nr_seq_trans_financ_w);
		end if;	
		
		select	coalesce(max(a.ie_acao),1)
		into STRICT	ie_acao_w
		from	transacao_financeira a
		where	a.nr_sequencia		= nr_seq_trans_financ_w;

		select	max(b.cd_tipo_recebimento)
		into STRICT	cd_tipo_recebimento_w
		from	tipo_recebimento b,
			transacao_financeira a
		where	substr(obter_se_tipo_receb_lib(b.cd_tipo_recebimento,obter_perfil_ativo),1,255) = 'S'
		and	b.ie_situacao		= 'A'
		and	a.cd_tipo_recebimento	= b.cd_tipo_recebimento
		and	a.nr_sequencia		= nr_seq_trans_financ_w;

		if (coalesce(cd_tipo_recebimento_w::text, '') = '') then
			begin
			select	max(cd_tipo_recebimento)
			into STRICT	cd_tipo_recebimento_w
			from	tipo_recebimento
			where	substr(obter_se_tipo_receb_lib(cd_tipo_recebimento,obter_perfil_ativo),1,255) = 'S'
			and	ie_tipo_consistencia	= 0
			and	coalesce(ie_situacao, 'A') 		= 'A'
			and     ((cd_estabelecimento = cd_estabelecimento_w) or (coalesce(cd_estabelecimento::text, '') = ''));
			exception
				when no_data_found then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(179743);
			end;
		end if;
		
		if (coalesce(cd_tipo_recebimento_w,0) = 0) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(179743);
		end if;

		if (ie_tipo_receb_titulo_cartao_w = 'N') then

			select	count(*) qt_cartao,
				max(a.nr_seq_trans_caixa)
			into STRICT	qt_cartao_w,
				nr_seq_trans_caixa_w
			from	movto_cartao_cr a
			where	a.nr_seq_caixa_rec	= nr_seq_caixa_rec_p;

			if (qt_cartao_w > 0) then

				select	max(a.cd_tipo_recebimento)
				into STRICT	cd_tipo_receb_cartao_w
				from	transacao_financeira a
				where	a.nr_sequencia	= nr_seq_trans_caixa_w;

				if (coalesce(cd_tipo_receb_cartao_w::text, '') = '') or (cd_tipo_recebimento_w <> cd_tipo_receb_cartao_w) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(179744);
				end if;

			end if;

		end if;

		if (ie_restringe_titulo_w = 'N') then
			select	count(*)
			into STRICT	qt_reg_w
			from	titulo_receber_liq
			where	nr_titulo		= nr_titulo_w
			and	nr_seq_caixa_rec	= nr_seq_caixa_rec_p;

			if (qt_reg_w > 0) then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(179745,'NR_TITULO_W='||nr_titulo_w);
			end if;
		end if;
		/* Projeto Multimoeda - Quando o caixa permitir moeda estrangeira, verifica se existe algum valor em especie em moeda estrangeira lancado
			no recebimento, caso exista pega a moeda e a cotacao para sugerir na baixa do titulo selecionado para o recebimento. Caso nao exista,
			mantem o padrao atual, sugerindo os valores em moeda nacional na baixa do titulo selecionado. */
		if (coalesce(ie_saldo_estrang_w,'N') = 'S') then
			begin
				select	cd_moeda,
					vl_cotacao
				into STRICT	cd_moeda_w,
					vl_cotacao_w
				from	caixa_receb_estrang
				where	nr_seq_caixa_receb = nr_seq_caixa_rec_p;
				
				vl_baixa_estrang_w := coalesce(vl_saldo_titulo_w,0) / coalesce(vl_cotacao_w,1);
				vl_complemento_w := coalesce(vl_saldo_titulo_w,0) - coalesce(vl_baixa_estrang_w,0);
			exception when others then
				cd_moeda_w := null;
				vl_baixa_estrang_w := null;
				vl_complemento_w := null;
				vl_cotacao_w := null;
			end;
		else
			cd_moeda_w := null;
			vl_baixa_estrang_w := null;
			vl_complemento_w := null;
			vl_cotacao_w := null;
		end if;
		
		/* Projeto Multimoeda - Busca os dados do titulo para verificar a existencia de variacao cambial para titulos em moeda estrangeira quando a baixa for realizada na mesma moeda do titulo.
			Caso seja a mesma moeda e exista cotacao no titulo e na baixa, calcula a variacao entre a emissao do titulo e a baixa a ser realizada para gravar a variacao passiva caso o 
			valor seja negativo ou a variacao ativa caso seja positivo. */
		select	max(cd_moeda),
			max(vl_cotacao)
		into STRICT	cd_moeda_tit_w,
			vl_cotacao_tit_w
		from 	titulo_receber
		where	nr_titulo = nr_titulo_w;
		if (coalesce(cd_moeda_tit_w,0) <> 0 and coalesce(vl_cotacao_tit_w,0) <> 0
			and coalesce(cd_moeda_w,0) <> 0 and coalesce(vl_cotacao_w,0) <> 0) then
			if (cd_moeda_tit_w = cd_moeda_w) then
				vl_var_cambial_w := (coalesce(vl_baixa_estrang_w,0) * vl_cotacao_tit_w) - (coalesce(vl_baixa_estrang_w,0) * vl_cotacao_w);
				if (vl_var_cambial_w < 0) then
					vl_cambial_passivo_w := vl_var_cambial_w * -1;
					vl_cambial_ativo_w := 0;
				else
					vl_cambial_passivo_w := 0;
					vl_cambial_ativo_w := vl_var_cambial_w;
				end if;
			end if;
		end if;
		
		select	max(a.nr_seq_motivo_desc),
			max(a.cd_centro_custo)
		into STRICT	nr_seq_motivo_desc_w,
			cd_centro_custo_desc_w
		from	titulo_receber_liq_desc a
		where	a.nr_titulo = nr_titulo_w
		and		coalesce(nr_seq_liq::text, '') = ''
		and		coalesce(nr_bordero::text, '') = '';
		
		if (coalesce(ie_juros_multa_w,'N') = 'N') then
			vl_juros_w	:= 0;
			vl_multa_w	:= 0;
		end if;
		
		insert	into titulo_receber_liq(nr_titulo,
			nr_sequencia,
			dt_recebimento,
			vl_recebido,
			vl_descontos,
			vl_juros,
			vl_multa,
			vl_rec_maior,
			vl_glosa,
			vl_despesa_bancaria,
			cd_moeda,
			cd_tipo_recebimento,
			nr_seq_trans_caixa,
			ie_acao,
			ie_lib_caixa,
			nr_seq_caixa_rec,
			dt_atualizacao,
			nm_usuario,
			nr_lote_contab_antecip,
			nr_lote_contab_pro_rata,
			nr_lote_contabil,
			nr_documento,
			cd_centro_custo,
			cd_centro_custo_desc,
			nr_seq_motivo_desc,
			vl_recebido_estrang,
			vl_complemento,
			vl_cotacao,
			vl_cambial_passivo,
			vl_cambial_ativo)
		values (nr_titulo_w,
			nr_sequencia_w,
			trunc(dt_recebimento_w,'dd'),
			CASE WHEN ie_acao_w=1 THEN CASE WHEN coalesce(dt_liquidacao_w::text, '') = '' THEN coalesce(vl_saldo_titulo_w,0) - coalesce(vl_desconto_w,0)  ELSE 0 END							 WHEN ie_acao_w=99 THEN CASE WHEN coalesce(dt_liquidacao_w::text, '') = '' THEN coalesce(vl_saldo_titulo_w,0) - coalesce(vl_desconto_w,0)  ELSE 0 END 							  ELSE 0 END ,
			vl_desconto_w,
			vl_juros_w,
			vl_multa_w,
			0,
			CASE WHEN ie_acao_w=18 THEN CASE WHEN coalesce(dt_liquidacao_w::text, '') = '' THEN vl_saldo_titulo_w  ELSE 0 END   ELSE 0 END ,
			0,
			coalesce(cd_moeda_w,obter_moeda_padrao(cd_estabelecimento_w,'R')),
			cd_tipo_recebimento_w,
			nr_seq_trans_financ_w,
			'I',
			'N',
			nr_seq_caixa_rec_p,
			clock_timestamp(),
			nm_usuario_p,
			0,
			0,
			0,
			nr_documento_w,
			cd_centro_custo_w,
			cd_centro_custo_desc_w,
			nr_seq_motivo_desc_w,
			CASE WHEN ie_acao_w=1 THEN CASE WHEN coalesce(dt_liquidacao_w::text, '') = '' THEN vl_baixa_estrang_w  ELSE CASE WHEN coalesce(vl_baixa_estrang_w::text, '') = '' THEN null  ELSE 0 END  END 							 WHEN ie_acao_w=99 THEN CASE WHEN coalesce(dt_liquidacao_w::text, '') = '' THEN vl_baixa_estrang_w  ELSE CASE WHEN coalesce(vl_baixa_estrang_w::text, '') = '' THEN null  ELSE 0 END  END 							  ELSE CASE WHEN coalesce(vl_baixa_estrang_w::text, '') = '' THEN null  ELSE 0 END  END ,
			CASE WHEN ie_acao_w=1 THEN CASE WHEN coalesce(dt_liquidacao_w::text, '') = '' THEN vl_complemento_w  ELSE CASE WHEN coalesce(vl_complemento_w::text, '') = '' THEN null  ELSE 0 END  END 							 WHEN ie_acao_w=99 THEN CASE WHEN coalesce(dt_liquidacao_w::text, '') = '' THEN vl_complemento_w  ELSE CASE WHEN coalesce(vl_complemento_w::text, '') = '' THEN null  ELSE 0 END  END 							  ELSE CASE WHEN coalesce(vl_complemento_w::text, '') = '' THEN null  ELSE 0 END  END ,
			vl_cotacao_w,
			vl_cambial_passivo_w,
			vl_cambial_ativo_w);
			
		select count(*)
		into STRICT qt_tit_rec_liq_desc_w
		from titulo_receber_liq_desc
		where nr_titulo	= nr_titulo_w;	
		
		if (coalesce(qt_tit_rec_liq_desc_w, 0) > 0) and (vl_tit_rec_liq_desc_w > 0) and (dt_limite_desconto_w IS NOT NULL AND dt_limite_desconto_w::text <> '') and (trunc(dt_limite_desconto_w) > trunc(clock_timestamp())) then					
			update titulo_receber_liq_desc
			set nr_seq_liq = nr_sequencia_w
			where nr_titulo = nr_titulo_w;
		end if;			

	end loop;
	close c01;
	
	ds_msg_retorno_p := substr(ds_msg_retorno_w,1,255);

end if;

if (coalesce(ie_commit_p,'S') = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baixar_titulos_caixa_rec ( nr_seq_caixa_rec_p bigint, ds_lista_titulo_p text, nr_titulo_p bigint, nm_usuario_p text, ds_msg_retorno_p INOUT text, ie_commit_p text default 'S') FROM PUBLIC;

