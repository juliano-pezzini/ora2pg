-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reverter_horario_adep ( ie_tipo_item_p text, nr_seq_hor_p bigint) AS $body$
DECLARE


nr_seq_hor_1	varchar(10);
nr_seq_hor_2	varchar(10);
nr_seq_hor_3	varchar(10);
nr_seq_hor_4	varchar(10);
nr_seq_hor_5	varchar(10);


BEGIN

if (ie_tipo_item_p in ('P','L','G','C')) then
	begin
	select  coalesce(max('S'),'N')
	into STRICT	nr_seq_hor_1
	from    prescr_procedimento a,
			prescr_proc_hor b
	where   a.nr_prescricao = b.nr_prescricao
	and     b.nr_seq_procedimento = a.nr_sequencia
	and     b.nr_sequencia = nr_seq_hor_p
	and     coalesce(a.dt_suspensao::text, '') = '';

	if (nr_seq_hor_1 = 'N') then
		CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(1023867);
	end if;

	select	coalesce(max('N'),'S')
	into STRICT	nr_seq_hor_2
	from  	prescr_proc_hor a,
			prescr_mat_alteracao b
	where  a.nr_prescricao	= b.nr_prescricao
	and    a.nr_sequencia    = b.nr_seq_horario_proc
	and    a.nr_sequencia	= nr_seq_hor_p
	and    b.ie_alteracao	= 12
	and    (a.dt_suspensao IS NOT NULL AND a.dt_suspensao::text <> '')
	and    b.nr_sequencia = (SELECT	max(c.nr_sequencia)
							from	prescr_mat_alteracao c
							where	c.nr_prescricao = a.nr_prescricao
							and		c.nr_seq_horario_proc = a.nr_sequencia);

	if (nr_seq_hor_2 = 'N') then
		CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(1023867);
	else
		begin
		select coalesce(max('N'),'S')
		into STRICT 	nr_seq_hor_3
		from	prescr_proc_hor a,
				prescr_mat_alteracao b
		where	a.nr_prescricao        = b.nr_prescricao
		and		a.nr_seq_procedimento  = b.NR_SEQ_PROCEDIMENTO
		and		a.dt_horario           >= b.dt_alteracao
		and		a.nr_sequencia	= nr_seq_hor_p
		and		b.ie_alteracao	= 29
		and		(a.dt_suspensao IS NOT NULL AND a.dt_suspensao::text <> '');

		if (nr_seq_hor_3 = 'N') then
			CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(1023867);
		end if;
		end;
	end if;
	end;
elsif (ie_tipo_item_p = 'R') then
	begin
	Select  coalesce(max('S'),'N')
	into STRICT 	nr_seq_hor_4
	from    prescr_recomendacao a,
			prescr_rec_hor b
	where   a.nr_prescricao 	= b.nr_prescricao
	and     b.nr_seq_recomendacao = a.nr_sequencia
	and     b.nr_sequencia 		= nr_seq_hor_p
	and     coalesce(a.dt_suspensao::text, '') = '';

	if (nr_seq_hor_4 = 'N') then
		CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(1023867);
	end if;
	end;
elsif (ie_tipo_item_p in ('M', 'IAH')) then
	begin
	select coalesce(max('N'),'S')
	into STRICT	nr_seq_hor_5
	from	prescr_mat_hor a,
			prescr_mat_alteracao b
	where  a.nr_prescricao	= b.nr_prescricao
	and    a.nr_sequencia   = b.nr_seq_horario
	and    a.nr_sequencia	= nr_seq_hor_p
	and    b.ie_alteracao	= 12
	and    (a.dt_suspensao IS NOT NULL AND a.dt_suspensao::text <> '')
	and    b.nr_sequencia = (	SELECT	max(c.nr_sequencia)
								from    prescr_mat_alteracao c
								where   c.nr_prescricao = a.nr_prescricao
								and   	c.nr_seq_horario = a.nr_sequencia);

	if (nr_seq_hor_5 = 'N') then
		CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(1023867);
	end if;
	end;
elsif (ie_tipo_item_p = 'LD') then

	select  coalesce(max('S'),'N')
	into STRICT	nr_seq_hor_1
	from    prescr_material a,
			prescr_mat_hor b
	where   a.nr_prescricao = b.nr_prescricao
	and     b.nr_seq_material = a.nr_sequencia
	and     b.nr_sequencia = nr_seq_hor_p
	and     coalesce(a.dt_suspensao::text, '') = '';

	if (nr_seq_hor_1 = 'N') then
		CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(1023867);
	end if;

	select coalesce(max('N'),'S')
	into STRICT	nr_seq_hor_2
	from	prescr_mat_hor a,
			prescr_mat_alteracao b
	where  a.nr_prescricao	= b.nr_prescricao
	and    a.nr_sequencia   = b.nr_seq_horario
	and    a.nr_sequencia	= nr_seq_hor_p
	and    b.ie_alteracao	= 12
	and    (a.dt_suspensao IS NOT NULL AND a.dt_suspensao::text <> '')
	and    b.nr_sequencia = (	SELECT	max(c.nr_sequencia)
								from    prescr_mat_alteracao c
								where   c.nr_prescricao = a.nr_prescricao
								and   	c.nr_seq_horario = a.nr_sequencia);

	if (nr_seq_hor_2 = 'N') then
		CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(1023867);
	end if;
elsif (ie_tipo_item_p = 'D') then

	select  coalesce(max('S'),'N')
	into STRICT	nr_seq_hor_1
	from    prescr_dieta a,
			prescr_dieta_hor b
	where   a.nr_prescricao = b.nr_prescricao
	and     b.nr_seq_dieta = a.nr_sequencia
	and     b.nr_sequencia = nr_seq_hor_p
	and     coalesce(a.dt_suspensao::text, '') = '';

	if (nr_seq_hor_1 = 'N') then
		CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(1023867);
	end if;

	select coalesce(max('N'),'S')
	into STRICT	nr_seq_hor_2
	from	prescr_dieta_hor a,
			prescr_mat_alteracao b
	where  a.nr_prescricao	= b.nr_prescricao
	and    a.nr_sequencia   = b.nr_seq_horario_dieta
	and    a.nr_sequencia	= nr_seq_hor_p
	and    b.ie_alteracao	= 12
	and    (a.dt_suspensao IS NOT NULL AND a.dt_suspensao::text <> '')
	and    b.nr_sequencia = (	SELECT	max(c.nr_sequencia)
								from    prescr_mat_alteracao c
								where   c.nr_prescricao = a.nr_prescricao
								and   	c.nr_seq_horario_dieta = a.nr_sequencia);

	if (nr_seq_hor_2 = 'N') then
		CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(1023867);
	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reverter_horario_adep ( ie_tipo_item_p text, nr_seq_hor_p bigint) FROM PUBLIC;

