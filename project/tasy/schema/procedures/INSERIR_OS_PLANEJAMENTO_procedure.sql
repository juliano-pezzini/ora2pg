-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE VETOR AS (VETOR DESENV_ACORDO_OS.NR_SEQ_ORDEM_SERVICO%type[10]);


CREATE OR REPLACE PROCEDURE inserir_os_planejamento (NR_SEQ_ACORDO_P bigint, nm_usuario_p text) AS $body$
DECLARE


NR_SEQ_ORDEM_SERVICO_W  DESENV_ACORDO_OS.NR_SEQ_ORDEM_SERVICO%type;
CONT_W  bigint;
VET_OS_W VETOR;
VET_STATUS_W VETOR;
NR_SEQ_ESTAGIO_W MAN_ORDEM_SERVICO.NR_SEQ_ESTAGIO%TYPE;

c01 CURSOR FOR
  SELECT  NR_SEQ_ORDEM_SERVICO
  FROM    DESENV_ACORDO_OS
  WHERE   (NR_SEQ_ORDEM_SERVICO IS NOT NULL AND NR_SEQ_ORDEM_SERVICO::text <> '')
  AND     NR_SEQ_ACORDO = NR_SEQ_ACORDO_P
  ORDER BY NR_SEQ_ORDEM_SERVICO;


BEGIN

  DELETE
  FROM  W_PLANEJAMENTO_OS
  WHERE nm_usuario = nm_usuario_p;

  VET_OS_W := VETOR(null, null, null, null, null, null, null, null, null, null);
  VET_STATUS_W := VETOR(null, null, null, null, null, null, null, null, null, null);
  CONT_W := 1;


OPEN c01;
LOOP
  FETCH c01 INTO
	NR_SEQ_ORDEM_SERVICO_W;
  EXIT WHEN NOT FOUND; /* apply on c01 */
	BEGIN
    SELECT NR_SEQ_ESTAGIO
    INTO STRICT NR_SEQ_ESTAGIO_W
    FROM MAN_ORDEM_SERVICO
    WHERE NR_SEQUENCIA = NR_SEQ_ORDEM_SERVICO_W;
    
    VET_STATUS_W(CONT_W) := NR_SEQ_ESTAGIO_W;
    VET_OS_W(CONT_W) := NR_SEQ_ORDEM_SERVICO_W;
    CONT_W := CONT_W +1;

    IF CONT_W = 11 THEN
      BEGIN
        INSERT INTO W_PLANEJAMENTO_OS(Status_Col_1, Col_1, Status_Col_2, Col_2, Status_Col_3, Col_3, Status_Col_4, Col_4, Status_Col_5, Col_5, Status_Col_6, Col_6, Status_Col_7, Col_7, Status_Col_8, Col_8, Status_Col_9, Col_9, Status_Col_10, Col_10, nm_usuario)
        VALUES (VET_STATUS_W(1), VET_OS_W(1), VET_STATUS_W(2), VET_OS_W(2), VET_STATUS_W(3), VET_OS_W(3), VET_STATUS_W(4), VET_OS_W(4), VET_STATUS_W(5), VET_OS_W(5), VET_STATUS_W(6), VET_OS_W(6), VET_STATUS_W(7), VET_OS_W(7), VET_STATUS_W(8), VET_OS_W(8), VET_STATUS_W(9), VET_OS_W(9), VET_STATUS_W(10), VET_OS_W(10), nm_usuario_p);
        VET_OS_W := VETOR(null, null, null, null, null, null, null, null, null, null);
        VET_STATUS_W := VETOR(null, null, null, null, null, null, null, null, null, null);
        CONT_W := 1;
      END;
    END IF;
	END;
END LOOP;
CLOSE c01;

IF CONT_W != 1 THEN
  BEGIN
    INSERT INTO W_PLANEJAMENTO_OS(Status_Col_1, Col_1, Status_Col_2, Col_2, Status_Col_3, Col_3, Status_Col_4, Col_4, Status_Col_5, Col_5, Status_Col_6, Col_6, Status_Col_7, Col_7, Status_Col_8, Col_8, Status_Col_9, Col_9, Status_Col_10, Col_10, nm_usuario)
      VALUES (VET_STATUS_W(1), VET_OS_W(1), VET_STATUS_W(2), VET_OS_W(2), VET_STATUS_W(3), VET_OS_W(3), VET_STATUS_W(4), VET_OS_W(4), VET_STATUS_W(5), VET_OS_W(5), VET_STATUS_W(6), VET_OS_W(6), VET_STATUS_W(7), VET_OS_W(7), VET_STATUS_W(8), VET_OS_W(8), VET_STATUS_W(9), VET_OS_W(9), VET_STATUS_W(10), VET_OS_W(10), nm_usuario_p);
  END;
END IF;

COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_os_planejamento (NR_SEQ_ACORDO_P bigint, nm_usuario_p text) FROM PUBLIC;

