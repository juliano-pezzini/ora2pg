-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_ci_prescr_nao_padrao (nr_prescricao_p bigint, cd_estabelecimento_p bigint, ds_comunicado_p text, cd_perfil_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_titulo_w			varchar(255);
nm_paciente_w			varchar(255);
nm_medico_w			varchar(255);
nm_usuario_destino_w		varchar(255);
ds_comunicado_w			varchar(4000);
ds_lista_usuario_destino_w	varchar(4000);
ds_comunic_w			varchar(4000);
ds_material_w			varchar(4000);
ds_justificativa_w		varchar(4000);
ds_comunic_final_w		varchar(4000);
ie_somente_padrao_w		varchar(1);
ie_primeiro_dia_w		varchar(1);
cd_mat_w			bigint;
cd_perfil_w			varchar(4000);
ds_setor_w			varchar(1000);
ie_enviar_atb_w			varchar(1);
ie_medicacao_paciente_w		varchar(40);
ds_dose_w			varchar(400);
ie_classif_custo_w		varchar(4);
ds_convenio_w			varchar(1000);
cd_perfil_destino_w		bigint;
nr_sequencia_w			bigint;
nr_sequencia_ww			bigint;
cd_setor_w			bigint;
ie_ctrl_medic_w			bigint;
nr_seq_medic_w			bigint;
cd_material_w			bigint;
nr_atendimento_w		bigint;
cd_grupo_material_w		integer;
cd_subgrupo_material_w		integer;
nr_min_prescr_w			bigint;
cd_classe_material_w		integer;
ie_enviar_prescritor_w		varchar(1);
nr_seq_comunic_w		bigint;
ie_objetivo_w			varchar(60);
qt_dias_solicitado_w		smallint;
cd_convenio_w			integer;
cd_categoria_w			varchar(10);
qt_dias_solic_w			smallint;
qt_dias_liberado_w		smallint;
ds_objetivo_w			varchar(50);
ds_microorganismo_w		varchar(255);
ds_amostra_w			varchar(50);
ds_origem_infeccao_w		varchar(50);
ds_topografia_w			varchar(50);
ds_indicacao_w			varchar(50);
ds_uso_atb_w			varchar(50);
ds_horarios_w			varchar(2000);
ie_dias_util_medic_w	varchar(2);
ie_gera_comunicado_w	varchar(2) := 'S';
ie_agrupador_w			prescr_material.ie_agrupador%type;
qt_dias_antib_w			parametro_medico.qt_dias_antibiotico%type;
nr_dia_util_w			prescr_material.nr_dia_util%type;

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.ds_titulo,
	a.ds_comunicado,
	a.ie_somente_padrao,
	a.cd_grupo_material,
	a.cd_subgrupo_material,
	a.cd_classe_material,
	a.cd_material,
	coalesce(a.ie_enviar_prescritor,'S'),
	a.ie_primeiro_dia,
	coalesce(a.ie_dados_atb,'S'),
	ie_classif_custo
from	rep_regra_envio_ci_padrao a
where	obter_se_setor_lib_ci(a.nr_sequencia, cd_setor_w) = 'S'
and	((coalesce(cd_estab::text, '') = '') or (cd_estabelecimento_p = cd_estab))
and	coalesce(a.ie_paciente_medic,'N') = 'N'
and	coalesce(ie_momento,'L') = 'L'
and (coalesce(a.cd_convenio,coalesce(cd_convenio_w,0)) = coalesce(cd_convenio_w,0))
and (coalesce(a.cd_categoria,coalesce(cd_categoria_w,'0')) = coalesce(cd_categoria_w,'0'));

c02 CURSOR FOR
SELECT	b.cd_perfil
from	rep_regra_envio_ci_perfil b
where	b.nr_seq_regra	= nr_sequencia_ww;

c14 CURSOR FOR
SELECT	ds_justificativa,
	substr(obter_descricao_mat_prescr(c.cd_material),1,80),
	a.cd_material,
	(c.qt_dose || c.cd_unidade_medida_dose),
	c.ie_medicacao_paciente,
	obter_ctrl_antimicrobiano_mat(c.cd_material),
	c.nr_sequencia,
	coalesce(c.qt_dias_solicitado,0),
	coalesce(c.qt_dias_liberado,0),
	substr(obter_valor_dominio(1280, c.ie_objetivo),1,50) ds_objetivo,
	substr(obter_desc_microorganismo(c.cd_microorganismo_cih),1,255) ds_microorganismo,
	substr(obter_cih_amostra(c.cd_amostra_cih),1,50) ds_amostra,
	substr(obter_valor_dominio(1288, c.ie_origem_infeccao),1,50) ds_origem_infeccao,
	substr(obter_desc_topografia(c.cd_topografia_cih),1,50) ds_topografia,
	substr(obter_valor_dominio(1927, c.ie_indicacao),1,50) ds_indicacao,
	CASE WHEN coalesce(ie_uso_antimicrobiano,'N')='S', OBTER_DESC_EXPRESSAO(327113), OBTER_DESC_EXPRESSAO(327114)) ds_uso_atb, -- 327113:'Sim';	327114:'Não'	c.ds_horariosfrom	Estrutura_material_v a THEN 	prescr_material c WHEN coalesce(ie_uso_antimicrobiano,'N')=material bwhere	a.cd_material		= c.cd_materialand	c.nr_prescricao		= nr_prescricao_pand	b.cd_material = c.cd_materialand	c.ie_agrupador in (1,2,4)and	coalesce(c.nr_seq_kit::text, '') = ''and	coalesce(c.nr_sequencia_diluicao::text, '') = ''and	((coalesce(ie_classif_custo_w::text, '') = '') or (ie_classif_custo_w = obter_dados_material_estab(c.cd_material, cd_estabelecimento_p, 'CU')))and	((coalesce(cd_mat_w::text, '') = '') or (a.cd_material	= cd_mat_w))and	((coalesce(cd_grupo_material_w::text, '') = '') or (a.cd_grupo_material	= cd_grupo_material_w))and	((coalesce(cd_subgrupo_material_w::text, '') = '') or (a.cd_subgrupo_material = cd_subgrupo_material_w))and	((coalesce(cd_classe_material_w::text, '') = '') or (a.cd_classe_material = cd_classe_material_w))and	(((coalesce(ie_somente_padrao_w,'S') = 'N') and (substr(obter_se_material_padronizado(cd_estabelecimento_p, a.cd_material),1,1) = 'S')) or (substr(obter_se_material_padronizado(cd_estabelecimento_p, a.cd_material),1,1) = 'N'))and	((c.ie_agrupador in (2,4)) or		 ((ie_primeiro_dia_w = 'N') or		  ((b.IE_DIAS_UTIL_MEDIC = 'O' AND c.nr_dia_util = 0) or		   (b.IE_DIAS_UTIL_MEDIC = 'S' AND c.nr_dia_util = 1) or (b.IE_DIAS_UTIL_MEDIC= 'N'))));c15 FORSELECT CURSOR	b.nm_usuario_regrafrom	rep_regra_envio_ci_padrao a THEN 	rep_usuario_ci_medic bwhere	a.nr_sequencia	= b.nr_seq_regraand	b.nr_seq_regra	= nr_sequencia_ww;--and	obter_se_envia_ci_setor(a.nr_sequencia, cd_setor_w) = 'S';
BEGINselect	min(nr_sequencia)into	nr_sequencia_wfrom	comunic_interna_classifwhere	ie_tipo	= 'F';select	max(obter_nome_pf_pj(cd_pessoa_fisica,null)) WHEN coalesce(ie_uso_antimicrobiano,'N')=max(obter_nome_pf_pj(cd_prescritor,null)) THEN 	max(cd_setor_atendimento) WHEN coalesce(ie_uso_antimicrobiano,'N')=max(nr_atendimento) THEN 	max(obter_nome_setor(cd_setor_atendimento)) WHEN coalesce(ie_uso_antimicrobiano,'N')=max(obter_nome_convenio(obter_Convenio_atendimento(nr_atendimento)))into	nm_paciente_w THEN 	nm_medico_w WHEN coalesce(ie_uso_antimicrobiano,'N')=cd_setor_w THEN 	nr_atendimento_w WHEN coalesce(ie_uso_antimicrobiano,'N')=ds_setor_w THEN 	ds_convenio_wfrom	prescr_medicawhere	nr_prescricao	= nr_prescricao_p;select	max(cd_convenio) WHEN coalesce(ie_uso_antimicrobiano,'N')=max(cd_categoria)into	cd_convenio_w THEN 	cd_categoria_wfrom	atend_categoria_conveniowhere	nr_atendimento	= nr_atendimento_w;select coalesce(max(qt_dias_antibiotico),1)into	qt_dias_antib_wfrom parametro_medicowhere cd_estabelecimento = cd_estabelecimento_p;open C01;loopfetch C01 into	nr_sequencia_ww WHEN coalesce(ie_uso_antimicrobiano,'N')=ds_titulo_w THEN 	ds_comunic_w WHEN coalesce(ie_uso_antimicrobiano,'N')=ie_somente_padrao_w THEN 	cd_grupo_material_w WHEN coalesce(ie_uso_antimicrobiano,'N')=cd_subgrupo_material_w THEN 	cd_classe_material_w WHEN coalesce(ie_uso_antimicrobiano,'N')=cd_mat_w THEN 	ie_enviar_prescritor_w WHEN coalesce(ie_uso_antimicrobiano,'N')=ie_primeiro_dia_w THEN 	ie_enviar_atb_w WHEN coalesce(ie_uso_antimicrobiano,'N')=ie_classif_custo_w;EXIT WHEN NOT FOUND; /* apply on C01 */	ds_comunicado_w := null;	open C14;	loop	fetch C14 into		ds_justificativa_w THEN 		ds_material_w WHEN coalesce(ie_uso_antimicrobiano,'N')=cd_material_w THEN 		ds_dose_w WHEN coalesce(ie_uso_antimicrobiano,'N')=ie_medicacao_paciente_w THEN 		ie_ctrl_medic_w WHEN coalesce(ie_uso_antimicrobiano,'N')=nr_seq_medic_w THEN 		qt_dias_solic_w WHEN coalesce(ie_uso_antimicrobiano,'N')=qt_dias_liberado_w THEN 		ds_objetivo_w WHEN coalesce(ie_uso_antimicrobiano,'N')=ds_microorganismo_w THEN 		ds_amostra_w WHEN coalesce(ie_uso_antimicrobiano,'N')=ds_origem_infeccao_w THEN 		ds_topografia_w WHEN coalesce(ie_uso_antimicrobiano,'N')=ds_indicacao_w THEN 		ds_uso_atb_w WHEN coalesce(ie_uso_antimicrobiano,'N')=ds_horarios_w;	EXIT WHEN NOT FOUND; /* apply on C14 */		if (ds_comunicado_w IS NOT NULL AND ds_comunicado_w::text <> '') then			ds_comunicado_w	:= substr(ds_comunicado_w || chr(13) || chr(13) || ds_material_w  || chr(13) || '   ' || OBTER_DESC_EXPRESSAO(326100) || ' ' || ds_dose_w,1,2000); 	--326100: 'Dose:'
		else			ds_comunicado_w	:= substr(chr(13) || ds_material_w || chr(13) || '   ' || OBTER_DESC_EXPRESSAO(326100) || ' ' || ds_dose_w,1,2000); 		--326100: 'Dose:'
		end if;		if (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then			ds_comunicado_w	:= substr(ds_comunicado_w || chr(13) || '   ' || OBTER_DESC_EXPRESSAO(727994) || ' '|| ds_horarios_w,1,2000); 				--727994: 'Horários prescritos:'
		end if;		if (qt_dias_solic_w > 0) then			ds_comunicado_w	:= substr(ds_comunicado_w || chr(13) || '   ' || OBTER_DESC_EXPRESSAO(727998) || ' ' || qt_dias_solic_w,1,2000);			--727998: 'Dias previstos para utilização:'
		end if;		if (qt_dias_liberado_w > 0) then			ds_comunicado_w	:= substr(ds_comunicado_w || chr(13) || '   ' || OBTER_DESC_EXPRESSAO(343379) || ' ' || qt_dias_liberado_w,1,2000);		--343379: 'Liberado:'
		end if;		if (ds_objetivo_w IS NOT NULL AND ds_objetivo_w::text <> '') then			ds_comunicado_w	:= substr(ds_comunicado_w || chr(13) || '   ' || OBTER_DESC_EXPRESSAO(728000) || ' ' || ds_objetivo_w,1,2000);				--728000: 'Objetivo do uso:'
		end if;		if (ds_microorganismo_w IS NOT NULL AND ds_microorganismo_w::text <> '') then			ds_comunicado_w	:= substr(ds_comunicado_w || chr(13) || '   ' || OBTER_DESC_EXPRESSAO(728004) || ' ' || ds_microorganismo_w,1,2000);		--728004: 'Micro-organismo:'
		end if;		if (ds_amostra_w IS NOT NULL AND ds_amostra_w::text <> '') then			ds_comunicado_w	:= substr(ds_comunicado_w || chr(13) || '   ' || OBTER_DESC_EXPRESSAO(728006) || ' ' || ds_amostra_w,1,2000);				--728006: 'Amostra(Material):'
		end if;		if (ds_origem_infeccao_w IS NOT NULL AND ds_origem_infeccao_w::text <> '') then			ds_comunicado_w	:= substr(ds_comunicado_w || chr(13) || '   ' || OBTER_DESC_EXPRESSAO(294936) || ': ' || ds_origem_infeccao_w,1,2000);		--294936: 'Origem da infecção'
		end if;		if (ds_topografia_w IS NOT NULL AND ds_topografia_w::text <> '') then			ds_comunicado_w	:= substr(ds_comunicado_w || chr(13) || '   ' || OBTER_DESC_EXPRESSAO(300156) || ': ' || ds_topografia_w,1,2000);			--300156: 'Topografia'
		end if;		if (ds_indicacao_w IS NOT NULL AND ds_indicacao_w::text <> '') then			ds_comunicado_w	:= substr(ds_comunicado_w || chr(13) || '   ' || OBTER_DESC_EXPRESSAO(291834) || ': ' || ds_indicacao_w,1,2000);			--291834: 'Indicação'
		end if;		if (ds_uso_atb_w IS NOT NULL AND ds_uso_atb_w::text <> '') and (ie_enviar_atb_w = 'S') then			ds_comunicado_w	:= substr(ds_comunicado_w || chr(13) || '   ' || OBTER_DESC_EXPRESSAO(300885) || ': ' || ds_uso_atb_w,1,2000);				--300885: 'Uso anterior antimicrobiano'
		end if;		if (ie_ctrl_medic_w > 0) then			select	substr(obter_valor_dominio(1280,ie_objetivo),1,60) THEN 				coalesce(qt_dias_solicitado,0)qt_dias_solicitado			into STRICT	ie_objetivo_w WHEN coalesce(ie_uso_antimicrobiano,'N')=qt_dias_solicitado_w			from	prescr_material			where	nr_prescricao	= nr_prescricao_p			and	nr_sequencia	= nr_seq_medic_w;			ds_comunicado_w := substr(ds_comunicado_w || chr(13) ||						'  ' || OBTER_DESC_EXPRESSAO(727882) || ':  ' || coalesce(ds_justificativa_w,'') || ' (' || ie_objetivo_w || ')' || chr(13) || 		--727882: 'Justificativa de uso'						'  ' || OBTER_DESC_EXPRESSAO(303740) || ':  ' || qt_dias_solicitado_w,1,2000);													--303740: 'Dias previstos'
		elsif (ds_justificativa_w IS NOT NULL AND ds_justificativa_w::text <> '') then			ds_comunicado_w := substr(ds_comunicado_w || chr(13) || ds_justificativa_w,1,2000);		end if;		if (ie_medicacao_paciente_w = 'S') then			ds_comunicado_w := substr(ds_comunicado_w || chr(13) || OBTER_DESC_EXPRESSAO(339240),1,2000);												--339240: 'Medicação do paciente'
		end if;	end loop;	close C14;	cd_perfil_w := null;	open c02;	loop	fetch c02 into		cd_perfil_destino_w;	EXIT WHEN NOT FOUND; /* apply on c02 */		if (cd_perfil_w IS NOT NULL AND cd_perfil_w::text <> '') or (cd_perfil_w <> '') then			cd_perfil_w := cd_perfil_w || ',';		end if;		cd_perfil_w := substr(cd_perfil_w || cd_perfil_destino_w,1,1000);	end loop;	close c02;	if (cd_perfil_w IS NOT NULL AND cd_perfil_w::text <> '') and (substr(cd_perfil_w,length(cd_perfil_w), 1) <> ',') then		cd_perfil_w	:= cd_perfil_w || ',';	end if;	if (ie_primeiro_dia_w = 'S') then		select	min(a.nr_prescricao)		into STRICT	nr_min_prescr_w		from	prescr_medica b THEN 				prescr_material a  ELSE material c		where	a.nr_prescricao		= b.nr_prescricao		and		b.nr_atendimento	= nr_atendimento_w		and		a.cd_material		= c.cd_material		and		a.cd_material		= cd_material_w		and		coalesce(a.dt_suspensao::text, '') = ''		and		coalesce(b.dt_suspensao::text, '') = ''		and		coalesce(c.ie_dias_util_medic, 'N') = 'N'		and 	a.ie_agrupador = 1		and 	b.dt_inicio_prescr > (clock_timestamp() - interval '6 days');		if (nr_min_prescr_w < nr_prescricao_p) then			ds_comunicado_w	:= '';		end if;	end if;	if (ds_comunicado_w IS NOT NULL AND ds_comunicado_w::text <> '') then		ds_lista_usuario_destino_w := null;		open C15;		loop		fetch C15 into			nm_usuario_destino_w;		EXIT WHEN NOT FOUND; /* apply on C15 */			if (ds_lista_usuario_destino_w IS NOT NULL AND ds_lista_usuario_destino_w::text <> '') then				ds_lista_usuario_destino_w := substr(ds_lista_usuario_destino_w || ',',1,1000);			end if;			ds_lista_usuario_destino_w := substr(ds_lista_usuario_destino_w || nm_usuario_destino_w,1,1000);		end loop;		close C15;		/*ds_comunic_w	:=	substr('Prescrição: ' || nr_prescricao_p || chr(13) ||
					'Atendimento: ' || nr_atendimento_w || chr(13) ||
					'Paciente: ' || nm_paciente_w || chr(13) ||
					'Setor: ' || ds_setor_w|| chr(13) ||
					'Convênio: ' || ds_convenio_w|| chr(13) ||
					'Prescritor: ' || nm_medico_w || chr(13) || chr(13) ||
					ds_comunic_w,1,2000);*/
		ds_comunic_w	:=	substr(WHEB_MENSAGEM_PCK.get_texto(456898,					'nr_prescricao_p='|| nr_prescricao_p ||					';nr_atendimento_w='|| nr_atendimento_w ||					';nm_paciente_w='|| nm_paciente_w ||					';ds_setor_w='|| ds_setor_w ||					';ds_convenio_w='|| ds_convenio_w ||					';nm_medico_w='|| nm_medico_w ||					';ds_comunic_w='|| ds_comunic_w),1,2000);		if (ds_titulo_w IS NOT NULL AND ds_titulo_w::text <> '') then			select	nextval('comunic_interna_seq')			into STRICT	nr_seq_comunic_w			;			ds_comunic_final_w	:= substr(ds_comunic_w || chr(13) || ds_comunicado_w,1,2000);			insert	into comunic_interna(				dt_comunicado,				ds_titulo,				ds_comunicado,				nm_usuario,				dt_atualizacao,				ie_geral,				ie_gerencial,				ds_perfil_adicional,				nr_sequencia,				nr_seq_classif,				dt_liberacao,				nm_usuario_destino)			values (				clock_timestamp(),				ds_titulo_w,				ds_comunic_final_w,				nm_usuario_p,				clock_timestamp(),				'N',				'N',				cd_perfil_w,				nr_seq_comunic_w,				nr_sequencia_w,				clock_timestamp(),				ds_lista_usuario_destino_w);			if (ie_enviar_prescritor_w = 'N') then				insert into comunic_interna_lida				values (	nr_seq_comunic_w,					nm_usuario_p,					clock_timestamp());			end if;			if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;		end if;	end if;end loop;close C01;END; END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_ci_prescr_nao_padrao (nr_prescricao_p bigint, cd_estabelecimento_p bigint, ds_comunicado_p text, cd_perfil_p bigint, nm_usuario_p text) FROM PUBLIC;

