-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_ocorrencia_item_aut ( ie_tipo_item_p text, ie_conta_medica_p text, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_material_p bigint, nr_param_p1 bigint, --vl_item_p desativado
 ie_autorizacao_p text, ie_tipo_conta_p text, nr_seq_segurado_p bigint, nr_seq_requisicao_p bigint, nr_seq_guia_plano_p bigint, nr_seq_conta_p bigint, nr_seq_proc_p bigint, nr_seq_mat_p bigint, ie_exige_medico_p text, nr_seq_grupo_contrato_p bigint, dt_referencia_p timestamp, qt_item_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_ocorrencia_p INOUT text, nr_seq_ocorrencia_p bigint, nr_seq_analise_conta_item_p bigint) AS $body$
DECLARE


nr_seq_regra_item_w		pls_ocorrencia_regra_item.nr_sequencia%type;
ie_nao_informado_w		varchar(10);
nr_seq_ocorrencia_w		pls_ocorrencia.nr_sequencia%type;
nr_seq_motivo_glosa_w		tiss_motivo_glosa.nr_sequencia%type;
nr_seq_ocorrencia_benef_w	pls_ocorrencia_benef.nr_sequencia%type;
ie_tipo_item_w			varchar(10);
ie_tipo_item_ww			bigint;
ie_tipo_conta_w			varchar(10);
vl_item_w			double precision;
ie_tipo_despesa_w		varchar(1)	:= null;
ie_nota_fiscal_w		varchar(1)	:= null;
ie_fornecedor_w			varchar(1)	:= null;
nr_seq_estrutura_w		pls_ocorrencia_estrutura.nr_sequencia%type;
ie_estrutura_w			varchar(1)	:= 'S';

nr_seq_restricao_w		pls_material_restricao.nr_sequencia%type;
qt_minima_w			bigint;
qt_maxima_w			bigint;
ie_consiste_qtd_w		varchar(1)	:= 'N';
ie_consiste_sexo_w		varchar(1)	:= 'N';
ie_consiste_idade_w		varchar(1)	:= 'N';
ie_sexo_seg_w			varchar(1);
ie_idade_seg_w			integer;
ie_sexo_mat_w			varchar(2);
qt_idade_min_mat_w		integer;
qt_idade_max_mat_w		integer;
ie_bloqueia_custo_op_w		varchar(5)	:= 'N';
ie_bloqueia_pre_pag_w		varchar(5)	:= 'N';
ie_bloqueia_intercambio_w	varchar(5)	:= 'N';
ie_bloqueia_prod_nao_reg_w	varchar(5)	:= 'N';
ie_bloqueia_prod_reg_w		varchar(5)	:= 'N';
ie_classif_sip_w		varchar(5)	:= 'N';
ie_pacote_w			varchar(1);
nr_seq_conta_princ_w		bigint;
ie_gerar_oc_pacote_w		varchar(1)	:= 'N';
ie_nao_utilizado_w		varchar(1);
qt_item_autorizado_w		bigint;
qt_item_solic_w			bigint;
ds_observacao_w			varchar(255)	:= '';
ie_autorizacao_especial_w	varchar(1)	:= 'N';
cd_guia_ref_w			varchar(20);
nr_seq_guia_w			pls_guia_plano.nr_sequencia%type;
ie_mat_espec_aut_w		varchar(1);
cd_especialidade_w		bigint;
cd_area_procedimento_w		bigint;
cd_grupo_proc_w			bigint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
nr_seq_estrut_mat_w		pls_estrutura_material.nr_sequencia%type;
nr_seq_grupo_rec_w		grupo_receita.nr_sequencia%type;
ie_via_acesso_w			varchar(1);
nr_nota_fiscal_mat_w		numeric(20);
ie_calculo_coparticipacao_w	varchar(10);
ie_coparticipacao_w		varchar(10);
ie_co_preco_operadora_w		varchar(10);

vl_calculado_w			double precision;
vl_apresentado_w		double precision;
vl_max_item_w			double precision;
vl_minimo_item_w		double precision;
ie_consistencia_valor_w		varchar(1);
ie_tipo_segurado_w		varchar(3);
ie_sexo_w			varchar(2);
qt_idade_min_w			integer;
qt_idade_max_w			integer;
ie_unid_tempo_idade_w		varchar(2);
qt_idade_w			varchar(5);
qt_idade_meses_w		integer;
ie_sem_evento_w			varchar(2);
qt_eventos_pagto_w		bigint;
qt_ocorrencia_w			bigint;
qt_idade_minima_w		integer;
qt_idade_maxima_w		integer;
ie_sexo_exclusivo_w		varchar(1);
ie_auditoria_w			varchar(1);
ie_ocorrencia_w			varchar(1) := 'N';
nr_seq_grupo_produto_w		pls_preco_grupo_produto.nr_sequencia%type;
nr_seq_plano_w			pls_plano.nr_sequencia%type;
nr_seq_regra_duplic_w		bigint;
ie_duplicidade_w		varchar(2);
nr_seq_grupo_material_w		pls_preco_grupo_material.nr_sequencia%type;
ie_grupo_material_w		varchar(1)	:= 'S';

nr_seq_tipo_acomod_conta_w	bigint;
nr_seq_tipo_acomodacao_w	bigint;
ie_exige_hora_item_w		varchar(1);
dt_inicio_proc_w		timestamp;
dt_fim_proc_w			timestamp;
ie_alterado_analise_w 		varchar(1) := 'N';
cd_estabelecimento_w		bigint;
ie_restringe_estab_w		varchar(2);
ie_estrut_mat_w			varchar(1);
nr_seq_material_w		bigint;
nr_seq_estrut_regra_w		bigint;

dt_emissao_w			pls_guia_plano.dt_emissao%type;
nr_seq_prestador_w		pls_guia_plano.nr_seq_prestador%type;
ie_tipo_guia_w			pls_guia_plano.ie_tipo_guia%type;
nr_seq_uni_exec_w		pls_guia_plano.nr_seq_uni_exec%type;
ie_carater_internacao_w		pls_guia_plano.ie_carater_internacao%type;
ie_tipo_repasse_w		pls_segurado.ie_tipo_repasse%type;
qt_excecao_w			bigint := 0;
ie_excecao_w			varchar(10);

C01 CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_motivo_glosa,
		ie_auditoria,
		cd_estabelecimento
	from	pls_ocorrencia
	where	ie_situacao		= 'A'
	and	((ie_restringe_estab_w	= 'N')
	or	(ie_restringe_estab_w	= 'S' AND cd_estabelecimento = cd_estabelecimento_p));

C02 CURSOR FOR
	SELECT	nr_sequencia,
		ie_nao_informado,
		nr_seq_estrutura,
		vl_max_item,
		coalesce(vl_minimo_item,0),
		ie_consistencia_valor,
		coalesce(ie_nao_utilizado,'N'),
		qt_idade_min,
		qt_idade_max,
		ie_unid_tempo_idade,
		ie_sem_evento,
		nr_seq_regra_duplic,
		nr_seq_grupo_material,
		ie_exige_hora_item,
		cd_procedimento,
		ie_origem_proced,
		nr_seq_material,
		nr_seq_estrutura_mat
	from	pls_ocorrencia_regra_item
	where	nr_seq_ocorrencia = nr_seq_ocorrencia_w
	and	ie_situacao = 'A'
	and	trunc(dt_referencia_p) between trunc(dt_inicio_vigencia) and fim_dia(coalesce(dt_fim_vigencia,dt_referencia_p))
	and	((ie_tipo_item = ie_tipo_item_w) or (ie_tipo_item = 'A'))
	and (ie_autorizacao = 'S')
	and	((coalesce(cd_area_procedimento::text, '') = '') or (cd_area_procedimento = coalesce(cd_area_procedimento_w,0)))
	and	((coalesce(cd_especialidade::text, '') = '') or (cd_especialidade = coalesce(cd_especialidade_w,0)))
	and	((coalesce(cd_grupo_proc::text, '') = '') or (cd_grupo_proc = coalesce(cd_grupo_proc_w,0)))
	and	((coalesce(ie_exige_medico,'N') = 'N')	or (coalesce(ie_exige_medico,'N') <> ie_exige_medico_p))
	and	((coalesce(nr_seq_grupo_contrato,0) = coalesce(nr_seq_grupo_contrato_p,0))or (coalesce(nr_seq_grupo_contrato::text, '') = ''))
	and	((ie_consiste_qtd = 'N')   or (ie_consiste_qtd = ie_consiste_qtd_w))
	and	((ie_consiste_sexo = 'N')  or (ie_consiste_sexo = ie_consiste_sexo_w))
	and	((ie_consiste_idade = 'N') or (ie_consiste_idade = ie_consiste_idade_w))
	and	((coalesce(ie_pacote_honorario,'N') = 'N') or ((coalesce(ie_pacote_honorario,'N') = 'S') and (coalesce(ie_gerar_oc_pacote_w,'N') = 'S') and (ie_tipo_despesa_w <> 3)))
	and	((coalesce(nr_seq_grupo_rec::text, '') = '') or (nr_seq_grupo_rec = nr_seq_grupo_rec_w))
	and	((coalesce(ie_tipo_segurado::text, '') = '') or (ie_tipo_segurado = ie_tipo_segurado_w ))
	and	((coalesce(ie_sexo::text, '') = '') or (ie_sexo = ie_sexo_w))
	and	((coalesce(ie_bloqueio_mat::text, '') = '') or (ie_bloqueio_mat in (	ie_bloqueia_custo_op_w,
									ie_bloqueia_pre_pag_w,
									ie_bloqueia_intercambio_w,
									ie_bloqueia_prod_nao_reg_w,
									ie_bloqueia_prod_reg_w )))

	and	((coalesce(ie_regra_valor_co,'N') = 'N') or coalesce(ie_regra_valor_co,'N') = 'S' and coalesce(ie_co_preco_operadora_w,'N') = 'N')
	and	((coalesce(nr_seq_plano::text, '') = '') or (nr_seq_plano = nr_seq_plano_w ))
	and	((coalesce(nr_seq_grupo_produto::text, '') = '') or (nr_seq_grupo_produto = nr_seq_grupo_produto_w ))
	order by
		coalesce(ie_tipo_item,'A'),
		coalesce(nr_seq_grupo_contrato_p,0);


BEGIN
ie_restringe_estab_w	:= pls_obter_se_controle_estab('GO');

/*askono - produto e grupo de produto*/

if (coalesce(nr_seq_segurado_p,0) > 0  ) then
	/*obter dados do segurado*/

	if (nr_seq_requisicao_p IS NOT NULL AND nr_seq_requisicao_p::text <> '') then
		select	max(nr_seq_plano)
		into STRICT	nr_seq_plano_w
		from  	pls_requisicao
		where	nr_sequencia = nr_seq_requisicao_p;
	elsif (nr_seq_guia_plano_p IS NOT NULL AND nr_seq_guia_plano_p::text <> '') then
		select	max(nr_seq_plano)
		into STRICT	nr_seq_plano_w
		from  	pls_guia_plano
		where	nr_sequencia = nr_seq_guia_plano_p;
	else
		begin
		select	nr_seq_plano
		into STRICT	nr_seq_plano_w
		from  	pls_segurado
		where	nr_sequencia = nr_seq_segurado_p;
		exception
		when others then
			nr_seq_plano_w	:= null;
		end;
	end if;

	/*dados do produto -- OS362870 - 17/10/2011*/

	begin
	select	nr_seq_tipo_acomodacao
	into STRICT	nr_seq_tipo_acomodacao_w
	from 	pls_plano_acomodacao
	where	nr_seq_plano = nr_seq_plano_w;
	exception
	when others then
		nr_seq_tipo_acomodacao_w	:= null;
	end;

	/*grupo do produto*/

	begin
	select 	a.nr_seq_grupo
	into STRICT	nr_seq_grupo_produto_w
	from	pls_preco_produto 	a
	where	a.nr_seq_plano 	= nr_seq_plano_w;
	exception
	when others then
		nr_seq_grupo_produto_w	:= null;
	end;
end if;

/* Obter parâmetros da conta médica */

ie_restringe_estab_w	:= pls_obter_se_controle_estab('CO');

select	coalesce(max(ie_calculo_coparticipacao),'P')
into STRICT	ie_calculo_coparticipacao_w
from	pls_parametros
where	((ie_restringe_estab_w	= 'S' AND cd_estabelecimento	= cd_estabelecimento_p)
or (ie_restringe_estab_w	= 'N'));

if (coalesce(nr_seq_proc_p,0) <> 0) then
	ie_tipo_item_w	:= 'P';

	if (coalesce(nr_seq_guia_plano_p,0) > 0) then
		ie_tipo_item_ww	:= 1;

		select	nr_seq_proc_princ,
			coalesce(vl_procedimento,0),
			CASE WHEN coalesce(nr_seq_pacote::text, '') = '' THEN 'N'  ELSE 'S' END
		into STRICT	nr_seq_conta_princ_w,
			vl_calculado_w,
			ie_pacote_w
		from	pls_guia_plano_proc
		where	nr_sequencia = nr_seq_proc_p;

		if	((ie_pacote_w = 'S') and (coalesce(nr_seq_conta_princ_w,0) = 0)) then
			ie_gerar_oc_pacote_w	:= 'S';
		end if;
	elsif (coalesce(nr_seq_requisicao_p,0) > 0) then
		ie_tipo_item_ww	:= 5;

		select	coalesce(vl_procedimento,0)
		into STRICT	vl_calculado_w
		from	pls_requisicao_proc
		where	nr_sequencia = nr_seq_proc_p;
	end if;

elsif (coalesce(nr_seq_mat_p,0) <> 0) then
	ie_tipo_item_w	:= 'M';

	if (coalesce(nr_seq_guia_plano_p,0) > 0) then
		ie_tipo_item_ww	:= 2;

		select	coalesce(vl_material,0)
		into STRICT	vl_calculado_w
		from	pls_guia_plano_mat
		where	nr_sequencia = nr_seq_mat_p;
	elsif (coalesce(nr_seq_requisicao_p,0) > 0) then
		ie_tipo_item_ww	:= 6;

		select	coalesce(vl_material,0)
		into STRICT	vl_calculado_w
		from	pls_requisicao_mat
		where	nr_sequencia = nr_seq_mat_p;
	end if;

	nr_seq_restricao_w := pls_obter_mat_restricao_data(nr_seq_material_p, dt_referencia_p, nr_seq_restricao_w);

	if (coalesce(nr_seq_restricao_w,0) > 0) then

		select	qt_minima,
			qt_maxima,
			CASE WHEN ie_bloqueia_custo_op='S' THEN 'BCO' END ,
			CASE WHEN ie_bloqueia_pre_pag='S' THEN 'BPP' END ,
			CASE WHEN ie_bloqueia_intercambio='S' THEN 'BI' END ,
			CASE WHEN ie_bloqueia_prod_nao_reg='S' THEN 'BNR' END ,
			CASE WHEN ie_bloqueia_prod_reg='S' THEN 'BR' END ,
			coalesce(ie_autorizacao,'N'),
			coalesce(ie_nota_fiscal,'N'),
			qt_idade_minima,
			qt_idade_maxima,
			ie_sexo_exclusivo
		into STRICT	qt_minima_w,
			qt_maxima_w,
			ie_bloqueia_custo_op_w,
			ie_bloqueia_pre_pag_w,
			ie_bloqueia_intercambio_w,
			ie_bloqueia_prod_nao_reg_w,
			ie_bloqueia_prod_reg_w,
			ie_autorizacao_especial_w,
			ie_nota_fiscal_w,
			qt_idade_minima_w,
			qt_idade_maxima_w,
			ie_sexo_exclusivo_w
		from	pls_material_restricao
		where	nr_sequencia	= nr_seq_restricao_w;

		if	((qt_item_p <qt_minima_w) or (qt_item_p > qt_maxima_w)) then
			ie_consiste_qtd_w	:= 'S';
		end if;
	end if;

	if (nr_seq_segurado_p IS NOT NULL AND nr_seq_segurado_p::text <> '') then
		select	a.ie_sexo,
			obter_idade(a.dt_nascimento, clock_timestamp(), 'A')
		into STRICT	ie_sexo_seg_w,
			ie_idade_seg_w
		from	pessoa_fisica a,
			pls_segurado b
		where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
		and	b.nr_sequencia		= nr_seq_segurado_p;

		if (ie_sexo_seg_w	<> ie_sexo_exclusivo_w /*ie_sexo_mat_w*/
) then
			ie_consiste_sexo_w	:= 'S';
		end if;

		if (ie_idade_seg_w > qt_idade_maxima_w /*qt_idade_max_mat_w*/
 or ie_idade_seg_w < qt_idade_minima_w /*qt_idade_min_mat_w*/
) then
			ie_consiste_idade_w	:= 'S';
		end if;

	end if;

end if;

if (coalesce(cd_procedimento_p,0) <> 0) then
	SELECT * FROM pls_obter_estrut_proc(cd_procedimento_p, ie_origem_proced_p, cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, ie_origem_proced_w) INTO STRICT cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, ie_origem_proced_w;

	begin
		select	nr_seq_grupo_rec
		into STRICT	nr_seq_grupo_rec_w
		from	procedimento
		where	cd_procedimento		= cd_procedimento_p
		and	ie_origem_proced	= ie_origem_proced_p;
	exception
	when others then
		nr_seq_grupo_rec_w := null;
	end;
end if;
if (coalesce(nr_seq_material_p,0) <> 0) then
	select	max(nr_seq_estrut_mat)
	into STRICT	nr_seq_estrut_mat_w
	from	pls_material
	where	nr_sequencia	= nr_seq_material_p;
end if;


/*dados do segurado*/

begin
select	b.ie_tipo_segurado,
	a.ie_sexo,
	substr(obter_idade_pf(a.cd_pessoa_fisica, clock_timestamp(), 'A'),1,10),
	substr(obter_idade_pf(a.cd_pessoa_fisica, clock_timestamp(), 'M'),1,10),
	ie_tipo_repasse
into STRICT	ie_tipo_segurado_w,
	ie_sexo_w,
	qt_idade_w,
	qt_idade_meses_w,
	ie_tipo_repasse_w
from	pls_segurado	b,
	pessoa_fisica	a
where	b.nr_sequencia		= nr_seq_segurado_p
and	b.cd_pessoa_fisica	= a.cd_pessoa_fisica;
exception
when others then
	ie_tipo_segurado_w	:= '0';
end;

if (nr_seq_guia_plano_p IS NOT NULL AND nr_seq_guia_plano_p::text <> '') then
	select	dt_solicitacao,
		nr_seq_prestador,
		ie_tipo_guia,
		nr_seq_uni_exec,
		ie_carater_internacao
	into STRICT	dt_emissao_w,
		nr_seq_prestador_w,
		ie_tipo_guia_w,
		nr_seq_uni_exec_w,
		ie_carater_internacao_w
	from	pls_guia_plano
	where	nr_sequencia	= nr_seq_guia_plano_p;

elsif (nr_seq_requisicao_p IS NOT NULL AND nr_seq_requisicao_p::text <> '') then
	select	dt_requisicao,
		nr_seq_prestador,
		ie_tipo_guia,
		nr_seq_uni_exec,
		ie_carater_atendimento
	into STRICT	dt_emissao_w,
		nr_seq_prestador_w,
		ie_tipo_guia_w,
		nr_seq_uni_exec_w,
		ie_carater_internacao_w
	from	pls_requisicao
	where	nr_sequencia	= nr_seq_requisicao_p;
end if;

open C01;
loop
fetch C01 into
	nr_seq_ocorrencia_w,
	nr_seq_motivo_glosa_w,
	ie_auditoria_w,
	cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

	if (nr_seq_requisicao_p IS NOT NULL AND nr_seq_requisicao_p::text <> '') then
		if (ie_tipo_item_w = 'P') then
			select	count(1)
			into STRICT	qt_ocorrencia_w
			from	pls_ocorrencia_benef
			where	nr_seq_ocorrencia		= nr_seq_ocorrencia_w
			and	nr_seq_requisicao		= nr_seq_requisicao_p
			and	nr_seq_proc 			= nr_seq_proc_p  LIMIT 1;
		elsif (ie_tipo_item_w = 'M') then
			select	count(1)
			into STRICT	qt_ocorrencia_w
			from	pls_ocorrencia_benef
			where	nr_seq_ocorrencia		= nr_seq_ocorrencia_w
			and	nr_seq_requisicao		= nr_seq_requisicao_p
			and	nr_seq_mat			= nr_seq_mat_p  LIMIT 1;
		end if;
	elsif (nr_seq_guia_plano_p IS NOT NULL AND nr_seq_guia_plano_p::text <> '') then
		if (ie_tipo_item_w = 'P') then
			select	count(1)
			into STRICT	qt_ocorrencia_w
			from	pls_ocorrencia_benef
			where	nr_seq_ocorrencia		= nr_seq_ocorrencia_w
			and	nr_seq_guia_plano		= nr_seq_guia_plano_p
			and	nr_seq_proc			= nr_seq_proc_p  LIMIT 1;
		elsif (ie_tipo_item_w = 'M') then
			select	count(1)
			into STRICT	qt_ocorrencia_w
			from	pls_ocorrencia_benef
			where	nr_seq_ocorrencia		= nr_seq_ocorrencia_w
			and	nr_seq_guia_plano		= nr_seq_guia_plano_p
			and	nr_seq_mat			= nr_seq_mat_p  LIMIT 1;
		end if;
	end if;

	if (qt_ocorrencia_w > 0) then
		goto final2;
	end if;

	if (ie_tipo_item_ww in (1, 2, 5, 6, 7, 9)) then
		select	count(1)
		into STRICT	qt_excecao_w
		from	pls_excecao_ocorrencia
		where	nr_seq_ocorrencia = nr_seq_ocorrencia_w
		and	ie_autorizacao = 'S';
	end if;

	if (qt_excecao_w > 0) then
		/*Na rotina pls_obter_se_regra_excecao, irá retornar "S" se caiu em alguam regra de exceção, então NÃO irá gerar a ocorrência. Se retornar "N" então não caiu em nenhuma regra*/

		ie_excecao_w := pls_obter_se_regra_excecao_aut(	nr_seq_ocorrencia_w, nr_seq_requisicao_p, nr_seq_guia_plano_p,
								nr_seq_proc_p, nr_seq_mat_p, dt_emissao_w,
								ie_tipo_item_ww, nr_seq_prestador_w, cd_procedimento_p,
								ie_origem_proced_p, nr_seq_material_p, nr_seq_segurado_p,
								ie_tipo_guia_w, nr_seq_plano_w, nm_usuario_p,
								null, nr_seq_uni_exec_w, ie_tipo_repasse_w,
								ie_carater_internacao_w);

		if (ie_excecao_w = 'S') then
			goto final2;
		end if;
end if;

	begin
	open C02;
	loop
	fetch C02 into
		nr_seq_regra_item_w,
		ie_nao_informado_w,
		nr_seq_estrutura_w,
		vl_max_item_w,
		vl_minimo_item_w,
		ie_consistencia_valor_w,
		ie_nao_utilizado_w,
		qt_idade_min_w,
		qt_idade_max_w,
		ie_unid_tempo_idade_w,
		ie_sem_evento_w,
		nr_seq_regra_duplic_w,
		nr_seq_grupo_material_w,
		ie_exige_hora_item_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		nr_seq_material_w,
		nr_seq_estrut_regra_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		qt_ocorrencia_w := 0;
		ds_observacao_w := '';
		ie_estrut_mat_w		:= 'S';

		if (nr_seq_estrut_regra_w IS NOT NULL AND nr_seq_estrut_regra_w::text <> '') then
			if (pls_obter_se_mat_estrutura(nr_seq_material_p, nr_seq_estrut_regra_w) = 'N') then
				ie_estrut_mat_w	:= 'N';
			end if;
		end if;

		if (ie_estrut_mat_w = 'S') then

			/*askono  30/06/11	OS330239  	testa se o valor do item (  vl_min_item e vl_max_item)  dos proc/materiais é comparado com o  valor calculado ( vl_procedimento) ou valor apresentado (  vl_procedimento_imp ) .
			Por padrão o valor é comparado com o valor calculado */
			if (coalesce(ie_consistencia_valor_w,'C')= 'C') then
				if (vl_calculado_w > coalesce(vl_max_item_w, vl_calculado_w) or
					vl_calculado_w < vl_minimo_item_w ) then
					goto final;
				end if;
			elsif (coalesce(ie_consistencia_valor_w,'C')= 'A') then
				if (vl_apresentado_w > coalesce(vl_max_item_w,vl_apresentado_w) or
					vl_apresentado_w < vl_minimo_item_w ) then
					goto final;
				end if;
			end if;

			/* Verificar se for regra de quantidade de idade minima ou maxima da regra, sendo "A" por ano e "M" por meses*/

			if (ie_unid_tempo_idade_w = 'A') then
				if	(qt_idade_min_w IS NOT NULL AND qt_idade_min_w::text <> '' AND qt_idade_min_w > qt_idade_w) or
					(qt_idade_max_w IS NOT NULL AND qt_idade_max_w::text <> '' AND qt_idade_max_w < qt_idade_w) then
					goto final;
				end if;
			elsif (ie_unid_tempo_idade_w = 'M') then
				if	(qt_idade_min_w IS NOT NULL AND qt_idade_min_w::text <> '' AND qt_idade_min_w > qt_idade_meses_w) or
					(qt_idade_max_w IS NOT NULL AND qt_idade_max_w::text <> '' AND qt_idade_max_w < qt_idade_meses_w) then
					goto final;
				end if;
			end if;

			/* Grupo de material */

			if (coalesce(nr_seq_grupo_material_w,0) > 0) and (coalesce(nr_seq_material_p,0) > 0) then
				ie_grupo_material_w	:= pls_se_grupo_preco_material(nr_seq_grupo_material_w, nr_seq_material_p);

				if (ie_grupo_material_w	= 'N') then
					goto final;
				end if;
			end if;

			/*Se for regra de itens com estrutura ou procedimento informado*/

			if (ie_tipo_item_p in (1,2,3,4,5,6)) then
				/*Se for uma regra de procedimento*/

				if (cd_procedimento_w > 0) and (coalesce(nr_seq_estrutura_w,0) = 0) then
					/*Verifica se o procedimento da regra consiste com o do procedimento da conta / guia*/

					if (cd_procedimento_w <> coalesce(cd_procedimento_p,0)) or (ie_origem_proced_w <> coalesce(ie_origem_proced_p,0)) or (coalesce(nr_seq_material_w,0) > 0) then
						goto final;
					end if;
				/*Se for uma regra de material*/

				elsif (coalesce(nr_seq_material_w,0) > 0) and (coalesce(nr_seq_estrutura_w,0) = 0)  then
					if (nr_seq_material_w <> coalesce(nr_seq_material_p,0)) or (coalesce(cd_procedimento_w,0) > 0) then
						goto final;
					end if;
				/*Se for regra de estrutura*/

				elsif (nr_seq_estrutura_w > 0) and
					((coalesce(cd_procedimento_w,0) = 0) and (coalesce(nr_seq_material_w,0) = 0)) then
					/*Verifica-se se algum dos procedimentos daestrutura existe na conta / guia*/

					ie_estrutura_w	:= pls_obter_se_estrut_ocorrencia(nr_seq_estrutura_w, cd_procedimento_p, ie_origem_proced_p, nr_seq_material_p);
					if (ie_estrutura_w = 'N') then
						/*Se não existe */

						goto final;
					end if;
				/*Se for regra de estrutura e procedimento verifica-se os dois*/

				elsif (cd_procedimento_w > 0) and (nr_seq_estrutura_w > 0) then
					/*Se na regra já coincidiu o procedimento com o da conta já é gerado ocorrencia sem necessidadse de verificar a estrutura.	*/

					if	(((cd_procedimento_w <> cd_procedimento_p) or (ie_origem_proced_w <> ie_origem_proced_p)) or (coalesce(cd_procedimento_p,0) = 0)) then
						/*Se for regar de material ou o procedimento não consistir com a regra é verificado a estrutura.*/

						if (pls_obter_se_estrut_ocorrencia(nr_seq_estrutura_w, cd_procedimento_p, ie_origem_proced_p, nr_seq_material_p) = 'N') then
							goto final;
						end if;
					end if;
				/*Se for regra de estrutura e material verifica-se os dois */

				elsif (coalesce(nr_seq_material_w,0) > 0)and (coalesce(nr_seq_estrutura_w,0) > 0) then
					/* Se a regra já coincidiu com o material, já é gerado a ocorrência */

					if	((nr_seq_material_w <> nr_seq_material_p) or (coalesce(nr_seq_material_p,0) = 0))  then
						if (pls_obter_se_estrut_ocorrencia(nr_seq_estrutura_w, cd_procedimento_p, ie_origem_proced_p, nr_seq_material_p) = 'N') then
							goto final;
						end if;
					end if;
				end if;
			end if;


			if (ie_auditoria_w = 'S') then
				ie_ocorrencia_w := 'S';
			end if;

			nr_seq_ocorrencia_benef_w := pls_inserir_ocorrencia(nr_seq_segurado_p, nr_seq_ocorrencia_w, nr_seq_requisicao_p, nr_seq_guia_plano_p, nr_seq_conta_p, nr_seq_proc_p, nr_seq_mat_p, '', nm_usuario_p, ds_observacao_w, nr_seq_motivo_glosa_w, ie_tipo_item_p, cd_estabelecimento_w, 'N', null, nr_seq_ocorrencia_benef_w, null, null, null, null);

			goto final3;

			<<final>>
			ie_estrutura_w	:= ie_estrutura_w;-- esta linha não faz nada, apenas para não gerar erro de sql.
		end if;
		end;
	end loop;
	<<final3>>
	close C02;
	end;
	<<final2>>
	qt_ocorrencia_w := 0;
end loop;
close C01;


--Diego 11/05/2011 - Chamado dentro da consistir conta portanto não pode existir commit
--commit;
ie_ocorrencia_p := ie_ocorrencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_ocorrencia_item_aut ( ie_tipo_item_p text, ie_conta_medica_p text, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_material_p bigint, nr_param_p1 bigint, ie_autorizacao_p text, ie_tipo_conta_p text, nr_seq_segurado_p bigint, nr_seq_requisicao_p bigint, nr_seq_guia_plano_p bigint, nr_seq_conta_p bigint, nr_seq_proc_p bigint, nr_seq_mat_p bigint, ie_exige_medico_p text, nr_seq_grupo_contrato_p bigint, dt_referencia_p timestamp, qt_item_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_ocorrencia_p INOUT text, nr_seq_ocorrencia_p bigint, nr_seq_analise_conta_item_p bigint) FROM PUBLIC;

