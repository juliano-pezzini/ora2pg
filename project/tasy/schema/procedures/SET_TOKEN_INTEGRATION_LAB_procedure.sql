-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE set_token_integration_lab (ds_Token_Integration_p text, ds_Access_Token_p text, ds_Scope_Token_p text, ds_Expiration_Time_p text, ds_Token_Type_p text, ds_User_p text, ds_Establishment_p text) AS $body$
DECLARE

            
	id_Token LAB_EXAME_TOKEN.NR_SEQUENCIA%type;
	dt_token_xpiration LAB_EXAME_TOKEN.dt_expiration%type;

BEGIN	
	begin
		select NR_SEQUENCIA
		into STRICT id_Token
		from LAB_EXAME_TOKEN 
		where DS_INTEGRATION = ds_Token_Integration_p;
	exception
	when others then
		id_Token := 0;
	end;

	--add dsExpirationTime_p miliseconds to sysdate
	dt_token_xpiration := (clock_timestamp() + NUMTODSINTERVAL( ds_Expiration_Time_p / 1000, 'SECOND' ));

	if (id_Token > 0)  then
		update LAB_EXAME_TOKEN set 
			NM_USUARIO = ds_User_p,
			DT_ATUALIZACAO = clock_timestamp(),
			DS_ACCESS_TOKEN = ds_Access_Token_p, 
			DS_SCOPE = ds_Scope_Token_p,
			DS_TOKEN_TYPE = ds_Token_Type_p,
			DS_EXPIRATION_TIME = ds_Expiration_Time_p,
			dt_expiration = dt_token_xpiration
		where NR_SEQUENCIA = id_Token;
	else
		insert into LAB_EXAME_TOKEN(
			NR_SEQUENCIA,
			DS_INTEGRATION,
			DS_ACCESS_TOKEN,
			DS_SCOPE,
			DS_TOKEN_TYPE,
			DS_EXPIRATION_TIME,
			DT_EXPIRATION,
			NM_USUARIO,
			DT_ATUALIZACAO,
			NM_USUARIO_NREC,
			DT_ATUALIZACAO_NREC,
			CD_ESTABELECIMENTO         
		)
		values (
			nextval('lab_exame_token_seq'),--NR_SEQUENCIA
			ds_Token_Integration_p,--DS_INTEGRATION
			ds_Access_Token_p,--DS_ACCESS_TOKEN
			ds_Scope_Token_p,--DS_SCOPE
			ds_Token_Type_p,--DS_TOKEN_TYPE
			ds_Expiration_Time_p,--DS_EXPIRATION_TIME
			dt_token_xpiration,--DS_EXPIRATION_TIME
			ds_User_p,--NM_USUARIO
			clock_timestamp(),--DT_ATUALIZACAO
			ds_User_p, --NM_USUARIO_NREC
			clock_timestamp(),--DT_ATUALIZACAO_NREC
			ds_Establishment_p --CD_ESTABELECIMENTO
		);
	end if;	

	commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE set_token_integration_lab (ds_Token_Integration_p text, ds_Access_Token_p text, ds_Scope_Token_p text, ds_Expiration_Time_p text, ds_Token_Type_p text, ds_User_p text, ds_Establishment_p text) FROM PUBLIC;

