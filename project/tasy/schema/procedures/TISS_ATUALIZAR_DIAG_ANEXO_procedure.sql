-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_atualizar_diag_anexo (nr_sequencia_autor_p bigint, nm_usuario_p text) AS $body$
DECLARE


dt_diagnostico_w		tiss_autor_anexo_diag.dt_diagnostico%type;
cd_cid_w			tiss_autor_anexo_diag.cd_cid%type;
cd_cid_2_w			tiss_autor_anexo_diag.cd_cid_2%type;
ds_plano_terapeutico_w		tiss_autor_anexo_diag.ds_plano_terapeutico%type;
cd_estadiamento_tumor_w		tiss_autor_anexo_diag.cd_estadiamento_tumor%type;
cd_tipo_quimio_w		tiss_autor_anexo_diag.cd_tipo_quimio%type;
cd_finalidade_trat_w		tiss_autor_anexo_diag.cd_finalidade_trat%type;
cd_ecog_w			tiss_autor_anexo_diag.cd_ecog%type;
ds_histopatologico_w		tiss_autor_anexo_diag.ds_histopatologico%type;
ds_info_relevante_w		tiss_autor_anexo_diag.ds_info_relevante%type;
ds_obs_jutificativa_w		tiss_autor_anexo_diag.ds_obs_jutificativa%type;
ds_justificativa_tec_w		tiss_autor_anexo_diag.ds_justificativa_tec%type;
ds_especific_mat_w		tiss_autor_anexo_diag.ds_especific_mat%type;
cd_diagnostico_imagem_w		tiss_autor_anexo_diag.cd_diagnostico_imagem%type;
cd_metastase_w			tiss_autor_anexo_diag.cd_metastase%type;
cd_nodulo_w			tiss_autor_anexo_diag.cd_nodulo%type;
cd_tumor_w			tiss_autor_anexo_diag.cd_tumor%type;

BEGIN

select	dt_diagnostico,
	cd_cid,
	cd_cid_2,
	ds_plano_terapeutico,
	cd_estadiamento_tumor,
	cd_tipo_quimio,
	cd_finalidade_trat,
	cd_ecog,
	ds_histopatologico,
	ds_info_relevante,
	ds_obs_jutificativa,
	ds_justificativa_tec,
	ds_especific_mat,
	cd_diagnostico_imagem,
	cd_metastase,
	cd_nodulo,
	cd_tumor
into STRICT	dt_diagnostico_w,
	cd_cid_w,
	cd_cid_2_w,
	ds_plano_terapeutico_w,
	cd_estadiamento_tumor_w,
	cd_tipo_quimio_w,
	cd_finalidade_trat_w,
	cd_ecog_w,
	ds_histopatologico_w,
	ds_info_relevante_w,
	ds_obs_jutificativa_w,
	ds_justificativa_tec_w,
	ds_especific_mat_w,
	cd_diagnostico_imagem_w,
	cd_metastase_w,
	cd_nodulo_w,
	cd_tumor_w
from	tiss_autor_anexo_diag
where	nr_sequencia_autor	= nr_sequencia_autor_p
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

update	tiss_anexo_guia_diag
set	dt_diagnostico			= coalesce(dt_diagnostico_w,dt_diagnostico),
	cd_cid				= coalesce(cd_cid_w,cd_cid),
	cd_cid_2			= coalesce(cd_cid_2_w,cd_cid_2),
	cd_estadiamento_tumor		= coalesce(cd_estadiamento_tumor_w,cd_estadiamento_tumor),
	cd_finalidade_tratamento	= coalesce(cd_finalidade_trat_w,cd_finalidade_tratamento),
	cd_ecog				= coalesce(cd_ecog_w,cd_ecog),
	ds_diag_histopatologico		= coalesce(ds_histopatologico_w,ds_diag_histopatologico),
	ds_info_relevantes		= coalesce(ds_info_relevante_w,ds_info_relevantes),
	cd_tipo_quimio			= coalesce(cd_tipo_quimio_w,cd_tipo_quimio),
	ds_plano_terapeutico		= coalesce(ds_plano_terapeutico_w,ds_plano_terapeutico),
	cd_diagnostico_imagem		= coalesce(cd_diagnostico_imagem_w,cd_diagnostico_imagem),
	cd_metastase			= coalesce(cd_metastase_w,cd_metastase),
	cd_nodulo			= coalesce(cd_nodulo_w,cd_nodulo),
	cd_tumor			= coalesce(cd_tumor_w,cd_tumor)
where	nr_seq_guia			in (SELECT nr_sequencia
				from 	tiss_anexo_guia
				where 	nr_sequencia_autor = nr_sequencia_autor_p);

update	tiss_anexo_guia
set	ds_justificativa	= coalesce(ds_justificativa_tec_w,coalesce(ds_obs_jutificativa_w,ds_justificativa)),
	ds_observacao		= substr(coalesce(ds_obs_jutificativa_w,ds_observacao),1,500),
	ds_especific_mat	= coalesce(ds_especific_mat_w,ds_especific_mat)
where	nr_sequencia_autor	= nr_sequencia_autor_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_atualizar_diag_anexo (nr_sequencia_autor_p bigint, nm_usuario_p text) FROM PUBLIC;

