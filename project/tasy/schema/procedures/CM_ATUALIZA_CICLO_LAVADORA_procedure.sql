-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cm_atualiza_ciclo_lavadora ( nr_conjunto_cont_p cm_conjunto_cont.nr_sequencia%type, nr_seq_ciclo_p cm_ciclo_lavacao.nr_sequencia%type, ie_opcao_p text, nm_usuario_p usuario.nm_usuario%type, nr_seq_motivo_cancel_p cm_ciclo_lavacao.nr_seq_motivo_cancel%type default null, ds_observacao_p cm_ciclo_lavacao.ds_observacao%type default null) AS $body$
DECLARE



/*
ie_opcao_p
IC = Inclui conjunto;
R = Retirar conjunto do ciclo;
I = Inicio ciclo;
DI = Desfaz inicio ciclo;
FC = Finaliza ciclo;
DFC = Desfaz fim ciclo;
CA = Cancela ciclo;
DC = Desfaz cancelamento;
*/
ie_tipo_equipamento_w	varchar(1);
nr_seq_embalagem_w	bigint;
qt_dia_validade_w	integer;
qt_dia_validade_ww	integer;
ie_status_cancelamento_w		funcao_param_usuario.vl_parametro%type;
ie_status_desfaz_cancel_w		funcao_param_usuario.vl_parametro%type;


BEGIN

select	max(coalesce(Obter_Valor_Param_Usuario(406,241,Obter_Perfil_ativo,nm_usuario_p,wheb_usuario_pck.get_cd_estabelecimento),1))
into STRICT	ie_status_cancelamento_w
;

select	max(coalesce(Obter_Valor_Param_Usuario(406,242,Obter_Perfil_ativo,nm_usuario_p,wheb_usuario_pck.get_cd_estabelecimento),1))
into STRICT	ie_status_desfaz_cancel_w
;

if (ie_opcao_p = 'IC') then

	update	cm_conjunto_cont
	set	nr_seq_ciclo_lav = nr_seq_ciclo_p,
		nm_usuario = nm_usuario_p,
		dt_atualizacao = clock_timestamp()
	where	nr_sequencia = nr_conjunto_cont_p;
	
	select	max(nr_seq_embalagem)
	into STRICT	nr_seq_embalagem_w
	from	cm_conjunto_cont
	where	nr_sequencia = nr_conjunto_cont_p;
	
	select	coalesce(max(qt_dia_validade), 0)
	into STRICT	qt_dia_validade_w
	from	cm_classif_embalagem
	where	nr_sequencia = nr_seq_embalagem_w;
	
	if (qt_dia_validade_w > 0) then
	
		select	coalesce(max(qt_dia_validade), 0)
		into STRICT	qt_dia_validade_ww
		from	cm_classif_embalagem
		where	nr_sequencia = nr_seq_embalagem_w
		and	coalesce(ie_indeterminado, 'N') = 'S';
		
		if (qt_dia_validade_ww = 0) then
			update	cm_conjunto_cont
			set	dt_validade = (clock_timestamp() + qt_dia_validade_w)
			where	nr_sequencia = nr_conjunto_cont_p;
		else
			update	cm_conjunto_cont
			set	dt_validade  = NULL,
				ie_indeterminado = 'S'
			where	nr_sequencia = nr_conjunto_cont_p;
		end if;
	end if;
	
elsif (ie_opcao_p = 'R') then

	update	cm_conjunto_cont
	set	nr_seq_ciclo_lav  = NULL,
		nm_usuario = nm_usuario_p,
		dt_atualizacao = clock_timestamp()
	where	nr_sequencia = nr_conjunto_cont_p;

elsif (ie_opcao_p = 'I') then

	update	cm_ciclo_lavacao
	set	dt_inicio = clock_timestamp(),
		nm_usuario = nm_usuario_p,
		dt_atualizacao = clock_timestamp()
	where	nr_sequencia = nr_seq_ciclo_p;
	
	update	cm_conjunto_cont
	set	ie_status_conjunto = 7,
		nm_usuario = nm_usuario_p,
		dt_atualizacao = clock_timestamp()
	where	nr_seq_ciclo_lav = nr_seq_ciclo_p;
	
	CALL cm_gerar_hist_ciclo(wheb_mensagem_pck.get_texto(311027),'I',null,nr_seq_ciclo_p,nm_usuario_p);

elsif (ie_opcao_p = 'DI') then

	update	cm_ciclo_lavacao
	set	dt_inicio  = NULL,
		nm_usuario = nm_usuario_p,
		dt_atualizacao = clock_timestamp()
	where	nr_sequencia = nr_seq_ciclo_p;

	update	cm_conjunto_cont
	set	ie_status_conjunto = 2,
		nm_usuario = nm_usuario_p,
		dt_atualizacao = clock_timestamp()
	where	nr_seq_ciclo_lav = nr_seq_ciclo_p;

	CALL cm_gerar_hist_ciclo(wheb_mensagem_pck.get_texto(311029),'D',null,nr_seq_ciclo_p,nm_usuario_p);
	
elsif (ie_opcao_p = 'FC') then

	update	cm_ciclo_lavacao
	set	dt_fim = clock_timestamp(),
		nm_usuario = nm_usuario_p,
		dt_atualizacao = clock_timestamp()
	where	nr_sequencia = nr_seq_ciclo_p;

	update	cm_conjunto_cont
	set	ie_status_conjunto = 8,
		nm_usuario = nm_usuario_p,
		dt_atualizacao = clock_timestamp()
	where	nr_seq_ciclo_lav = nr_seq_ciclo_p;

	CALL cm_gerar_hist_ciclo(wheb_mensagem_pck.get_texto(311031),'F',null,nr_seq_ciclo_p,nm_usuario_p);
	
	select	b.ie_tipo
	into STRICT	ie_tipo_equipamento_w
	from	cm_ciclo_lavacao a,
		cm_equipamento b
	where	a.nr_seq_equipamento = b.nr_sequencia
	and	a.nr_sequencia = nr_seq_ciclo_p;
	
	if (ie_tipo_equipamento_w = 'L') then
	
		update	cm_conjunto_cont
		set	ie_expurgo = 'N',
			nm_usuario = nm_usuario_p,
			dt_atualizacao = clock_timestamp()
		where	nr_seq_ciclo_lav = nr_seq_ciclo_p;
	
	end if;
	
elsif (ie_opcao_p = 'DFC') then

	update	cm_ciclo_lavacao
	set	dt_fim  = NULL,
		nm_usuario = nm_usuario_p,
		dt_atualizacao = clock_timestamp()
	where	nr_sequencia = nr_seq_ciclo_p;

	update	cm_conjunto_cont
	set	ie_status_conjunto = 7,
		ie_expurgo = 'S',
		nm_usuario = nm_usuario_p,
		dt_atualizacao = clock_timestamp()
	where	nr_seq_ciclo_lav = nr_seq_ciclo_p;
	
	CALL cm_gerar_hist_ciclo(wheb_mensagem_pck.get_texto(311034),'D',null,nr_seq_ciclo_p,nm_usuario_p);

elsif (ie_opcao_p = 'CA') then

	update	cm_ciclo_lavacao
	set	dt_cancelamento = clock_timestamp(),
		nm_usuario = nm_usuario_p,
		NM_USUARIO_CANCEL	= nm_usuario_p,
		dt_atualizacao = clock_timestamp(),
		nr_seq_motivo_cancel = nr_seq_motivo_cancel_p,
		ds_observacao = ds_observacao_p
	where	nr_sequencia = nr_seq_ciclo_p;
	

	update	cm_conjunto_cont
	set	ie_status_conjunto	= ie_status_cancelamento_w
	where	nr_seq_ciclo_lav	= nr_seq_ciclo_p;
	
	CALL cm_gerar_hist_ciclo(wheb_mensagem_pck.get_texto(158642),'C',null,nr_seq_ciclo_p,nm_usuario_p);
	

elsif (ie_opcao_p = 'DC') then

	update	cm_ciclo_lavacao
	set	dt_cancelamento  = NULL,
		nm_usuario = nm_usuario_p,
		dt_atualizacao = clock_timestamp(),
		nr_seq_motivo_cancel  = NULL
	where	nr_sequencia = nr_seq_ciclo_p;
	
	update	cm_conjunto_cont
	set	ie_status_conjunto	= ie_status_desfaz_cancel_w,
		nm_usuario = nm_usuario_p,
		dt_atualizacao = clock_timestamp()
	where	nr_seq_ciclo_lav	= nr_seq_ciclo_p;

	CALL cm_gerar_hist_ciclo(wheb_mensagem_pck.get_texto(311035),'D',null,nr_seq_ciclo_p,nm_usuario_p);
	
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cm_atualiza_ciclo_lavadora ( nr_conjunto_cont_p cm_conjunto_cont.nr_sequencia%type, nr_seq_ciclo_p cm_ciclo_lavacao.nr_sequencia%type, ie_opcao_p text, nm_usuario_p usuario.nm_usuario%type, nr_seq_motivo_cancel_p cm_ciclo_lavacao.nr_seq_motivo_cancel%type default null, ds_observacao_p cm_ciclo_lavacao.ds_observacao%type default null) FROM PUBLIC;

