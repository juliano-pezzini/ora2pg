-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reg_validate_prs_ccb ( nr_seq_product_rec_p bigint, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE


/*
I - Inclusão
A - Alteração
E - Exclusão
*/
			

ccb_aprovado_w	varchar(1);


BEGIN

if ('I' = ie_opcao_p) then
	select	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
	into STRICT	ccb_aprovado_w
	from	man_ordem_serv_impacto a,
		man_ordem_serv_imp_pr b
	where	a.nr_sequencia = b.nr_seq_impacto
	and	b.nr_product_requirement = nr_seq_product_rec_p
	and	b.ie_impacto_requisito = 'I'
	and	(a.dt_aprovacao IS NOT NULL AND a.dt_aprovacao::text <> '');
	
	if ('N' = ccb_aprovado_w) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1027666);
	end if;	
end if;

if ('A' = ie_opcao_p) then
	select	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
	into STRICT	ccb_aprovado_w
	from	man_ordem_serv_impacto a,
		man_ordem_serv_imp_pr b,
		reg_product_requirement rpr
	where	a.nr_sequencia = b.nr_seq_impacto
	and	b.nr_product_requirement = rpr.nr_sequencia
	and	b.nr_product_requirement = nr_seq_product_rec_p
	and	b.ie_impacto_requisito in ('A', 'D')	
	and	exists (
				SELECT	1
				from	man_ordem_servico mos
				where	a.nr_seq_ordem_serv = mos.nr_sequencia
				and	mos.ie_status_ordem <> '3'
			);
	
	if ('N' = ccb_aprovado_w) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1027667);
	end if;	
end if;

if ('E' = ie_opcao_p) then
	select	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
	into STRICT	ccb_aprovado_w
	from	man_ordem_serv_impacto a,
		man_ordem_serv_imp_pr b,
		reg_product_requirement rpr
	where	a.nr_sequencia = b.nr_seq_impacto
	and	b.nr_product_requirement = rpr.nr_sequencia
	and	b.nr_product_requirement = nr_seq_product_rec_p
	and	b.ie_impacto_requisito in ('E', 'D')
	and	(rpr.dt_aprovacao IS NOT NULL AND rpr.dt_aprovacao::text <> '')
	and	a.dt_aprovacao >= rpr.dt_aprovacao
	and	exists (
				SELECT	1
				from	man_ordem_servico mos
				where	a.nr_seq_ordem_serv = mos.nr_sequencia
				and	mos.ie_status_ordem <> '3'
			);
	
	if ('N' = ccb_aprovado_w) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1027668);
	end if;	
end if;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reg_validate_prs_ccb ( nr_seq_product_rec_p bigint, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

