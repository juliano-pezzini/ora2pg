-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE des_definir_complex_relat_os ( nr_seq_complex_p bigint, nr_sequencia_p bigint, nm_usuario_p text, ds_mensagem_p INOUT text, ds_detalhamento_p text default null) AS $body$
DECLARE


vl_hora_w		double precision;
qt_hora_w		integer;
nr_seq_orc_w		bigint;
nr_seq_cliente_w		bigint;
qt_existe_w		bigint;
ds_texto_padrao_w		man_ordem_serv_tecnico.ds_relat_tecnico%Type;
nm_pessoa_sol_w		pessoa_fisica.nm_pessoa_fisica%Type;
nr_seq_estagio_w man_estagio_processo.nr_sequencia%type := 2843;
nr_seq_tipo_hist_w man_tipo_hist.nr_sequencia%TYPE := 34;
ie_cliente_ok_w		varchar(1)	:= 'S';
ds_item_orc_w man_ord_serv_orc_item.ds_item%type;


BEGIN
if (nr_seq_complex_p > 0) and (nr_sequencia_p > 0) then

	select	nr_seq_cliente,
		substr(OBTER_NOME_PF(cd_pessoa_solicitante),1,60)
	into STRICT	nr_seq_cliente_w,
		nm_pessoa_sol_w
	from	man_ordem_servico
	where	nr_sequencia = nr_sequencia_p;
	
	if (des_obter_se_cliente_cobra_rel(nr_seq_cliente_w,'R') = 'N') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(257739);
	end if;

	ie_cliente_ok_w := des_consiste_dados_adm_cliente(nr_sequencia_p, nm_usuario_p, ie_cliente_ok_w);

	if (ie_cliente_ok_w = 'N') then
		nr_seq_estagio_w	:= 91;
		nr_seq_tipo_hist_w	:= 34;
		ds_mensagem_p		:= Wheb_mensagem_pck.get_texto(461047);
	end if;

	/*Foi removido o gestor pos venda como executor a pedido da OS - 933153*/

	update  man_ordem_servico_exec
	set 	dt_fim_execucao		= clock_timestamp()
	where	nr_seq_ordem 		= nr_sequencia_p
	and	nm_usuario_exec 		<> nm_usuario_p
	and	coalesce(dt_fim_execucao::text, '') = '';
	
	/*verifica se o analista tem ativida*/

	select	count(1)
	into STRICT	qt_existe_w
	from	man_ordem_servico_exec
	where	nr_seq_ordem 		= nr_sequencia_p
	and	nm_usuario_exec 		= nm_usuario_p
	and	coalesce(dt_fim_execucao::text, '') = ''  LIMIT 1;
	
	if (qt_existe_w = 0) then
		insert into man_ordem_servico_exec(nr_sequencia,
			nr_seq_ordem,
			dt_atualizacao,
			nm_usuario,
			nm_usuario_exec,
			qt_min_prev,
			nr_seq_tipo_exec,
			dt_atualizacao_nrec,
			nm_usuario_nrec)
		values (	nextval('man_ordem_servico_exec_seq'),
			nr_sequencia_p,
			clock_timestamp(),
			nm_usuario_p,
			nm_usuario_p,
			45,
			'3',
			clock_timestamp(),
			nm_usuario_p);
	end if;
	
	update	man_ordem_servico
	set	nr_seq_complex_relat 	= nr_seq_complex_p,
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp(),
		nr_seq_estagio		= nr_seq_estagio_w,
		ie_tipo_ordem 		= 23,
		nr_seq_tipo_ordem	= 190
	where	nr_sequencia		= nr_sequencia_p;
	
	select	des_obter_valor_hora_relat(nr_seq_cliente_w)
	into STRICT	vl_hora_w
	;
	
	select	qt_hora_padrao
	into STRICT	qt_hora_w
	from	des_complexidade_relat
	where	nr_sequencia = nr_seq_complex_p;
	
	select	substr(replace(obter_texto_tasy(270381, wheb_usuario_pck.get_nr_seq_idioma),'#@DS_SOLICITANTE#@',nm_pessoa_sol_w),1,4000)
	into STRICT	ds_texto_padrao_w
	;
	
	ds_texto_padrao_w := replace(ds_texto_padrao_w, '#@DS_DETALHAMENTO#@', coalesce(ds_detalhamento_p, ''));
	
	select	count(1)
	into STRICT	qt_existe_w
	from 	man_ordem_servico_orc
	where	coalesce(dt_aprovacao::text, '') = ''
	and	coalesce(dt_reprovacao::text, '') = ''
	and	nr_seq_ordem = nr_sequencia_p;
	
	if (qt_existe_w > 0) then
		update 	man_ordem_servico_orc
		set 	dt_reprovacao = clock_timestamp()
		where	coalesce(dt_aprovacao::text, '') = ''
		and	coalesce(dt_reprovacao::text, '') = ''
		and	nr_seq_ordem = nr_sequencia_p;
	end if;
	
	select	nextval('man_ordem_servico_orc_seq')
	into STRICT	nr_seq_orc_w
	;
	
	insert into man_ordem_servico_orc(nr_sequencia,
			nr_seq_ordem,
			dt_atualizacao,
			nm_usuario,
			dt_orcamento,
			nm_usuario_orc,
			cd_condicao_pagto,
			dt_validade,
			dt_aprovacao,
			nm_pessoa_aprovacao,
			nm_usuario_aprovacao,
			ds_conteudo_email_aprov,
			ds_observacao,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			qt_horas_prev_inicial,
			qt_horas_prev_interna,
			qt_horas_prev_revisao, 
			qt_horas_real,
			ie_tipo_orcamento)
		values (nr_seq_orc_w,
			nr_sequencia_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			'',
			clock_timestamp() + interval '30 days',
			null,
			'',
			'',
			'',
			'',
			clock_timestamp(),
			nm_usuario_p,
			qt_hora_w,
			qt_hora_w, 
			'', 
			qt_hora_w,
			'R');

    ds_item_orc_w := obter_texto_tasy(461079, wheb_usuario_pck.get_nr_seq_idioma);

	insert into man_ord_serv_orc_item(nr_sequencia,
			nr_seq_orc_ordem,
			dt_atualizacao,
			nm_usuario,
			nr_seq_apres,
			ds_item,
			qt_item,
			cd_unidade_medida,
			vl_unitario,
			vl_item,
			ds_observacao,
			cd_material,
			dt_atualizacao_nrec,
			nm_usuario_nrec)
		values (nextval('man_ord_serv_orc_item_seq'),
			nr_seq_orc_w,
			clock_timestamp(),
			nm_usuario_p,
			1,
			ds_item_orc_w,
			qt_hora_w,
			'h',
			vl_hora_w,
			(qt_hora_w * vl_hora_w),
			'',
			'',
			clock_timestamp(),
			nm_usuario_p);
	
	insert into man_ordem_serv_tecnico(nr_sequencia,
			nr_seq_ordem_serv,
			dt_atualizacao,
			nm_usuario,
			ds_relat_tecnico,
			cd_versao_tasy,
			dt_historico,
			ie_origem,
			nr_seq_tipo,
			dt_liberacao,
			nm_usuario_lib,
			ie_grau_satisfacao,
			dt_envio,
			ie_relevante_teste,
			nr_seq_motivo_desvio_prev)
		values (nextval('man_ordem_serv_tecnico_seq'),
			nr_sequencia_p,
			clock_timestamp(),
			nm_usuario_p,
			ds_texto_padrao_w,
			'',
			clock_timestamp(),
			'I',
			nr_seq_tipo_hist_w,
			clock_timestamp(),
			nm_usuario_p,
			'',
			'',
			'N',
			'');
	
	select	count(*)
	into STRICT	qt_existe_w
	from	man_ordem_serv_ativ
	where	trunc(dt_atividade)	= trunc(clock_timestamp())
	and	nr_seq_ordem_serv	= nr_sequencia_p
	and	nm_usuario_exec	= nm_usuario_p
	and	coalesce(dt_fim_atividade::text, '') = '';
	
	if (qt_existe_w = 0) then
		insert into man_ordem_serv_ativ(nr_sequencia,
			nr_seq_ordem_serv,
			dt_atualizacao,
			nm_usuario,
			dt_atividade,
			nr_seq_funcao,
			qt_minuto,
			nm_usuario_exec,
			ds_observacao,
			dt_fim_atividade,
			dt_atualizacao_nrec,
			nm_usuario_nrec)
		values (nextval('man_ordem_serv_ativ_seq'),
			nr_sequencia_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			31,
			5,
			nm_usuario_p,
			'',
			(clock_timestamp() + interval '5 days'/1440),
			clock_timestamp(),
			nm_usuario_p);
	end if;
	
	commit;
	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE des_definir_complex_relat_os ( nr_seq_complex_p bigint, nr_sequencia_p bigint, nm_usuario_p text, ds_mensagem_p INOUT text, ds_detalhamento_p text default null) FROM PUBLIC;

