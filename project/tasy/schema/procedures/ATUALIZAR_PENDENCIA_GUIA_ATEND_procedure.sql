-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_pendencia_guia_atend ( nr_atendimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, nm_usuario_p text) AS $body$
DECLARE

 
ie_proc_mat_w		smallint;
nr_sequencia_w		bigint;

C01 CURSOR FOR 
	SELECT ie_proc_mat, 
		 nr_sequencia 
	from conta_paciente_v 
	where nr_atendimento = nr_atendimento_p 
	 and cd_situacao_glosa <> 0 
	 and coalesce(cd_motivo_exc_conta::text, '') = '' 
	 and ie_status_acerto = 1 
	order by ie_proc_mat, ds_item;


BEGIN 
 
open C01;
loop 
	fetch C01 into 	ie_proc_mat_w, 
				nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
 
	if (ie_proc_mat_w = 1) then 
		update procedimento_paciente 
		set	nr_interno_conta	 = NULL, 
			dt_acerto_conta	 = NULL, 
			cd_situacao_glosa = 0, 
			cd_convenio		= cd_convenio_p, 
			cd_categoria	= cd_categoria_p 
		where nr_sequencia 	= nr_sequencia_w;
		CALL atualiza_preco_procedimento(nr_sequencia_w, cd_convenio_p, nm_usuario_p);
	else 
		update material_atend_paciente 
		set	nr_interno_conta	 = NULL, 
			dt_acerto_conta	 = NULL, 
			cd_situacao_glosa = 0, 
			cd_convenio		= cd_convenio_p, 
			cd_categoria	= cd_categoria_p 
		where nr_sequencia 	= nr_sequencia_w;
		CALL atualiza_preco_material(nr_sequencia_w, nm_usuario_p);
	end if;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_pendencia_guia_atend ( nr_atendimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, nm_usuario_p text) FROM PUBLIC;

