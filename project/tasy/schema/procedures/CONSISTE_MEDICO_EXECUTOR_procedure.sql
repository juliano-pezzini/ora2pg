-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_medico_executor ( cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_setor_atendimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, ie_tipo_atendimento_p bigint, nr_seq_exame_p bigint, nr_seq_proc_interno_p bigint, ie_medico_executor_p INOUT text, cd_cgc_p INOUT text, cd_medico_executor_p INOUT text, cd_pessoa_fisica_p INOUT text, cd_medico_exec_filtro_p text, dt_execucao_p timestamp, nr_seq_classificacao_p bigint, ie_origem_inf_p text, cd_cgc_laboratorio_p text, cd_setor_prescricao_p bigint, ie_execucao_p text default 'N') AS $body$
DECLARE


cd_convenio_w           		numeric(5,0);
cd_setor_atendimento_w		integer;
ie_tipo_atendimento_w		smallint;
cd_area_w			bigint;
cd_especialidade_w		bigint;
cd_grupo_w			bigint;
ie_medico_executor_w   		varchar(1);
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
nr_sequencia_w			smallint;
cd_cgc_w			varchar(14);
cd_cgc_retorno_w			varchar(14);
cd_medico_executor_w		varchar(10);
cd_medico_retorno_w		varchar(10);
nr_seq_exame_w			bigint;
cd_pessoa_fisica_w		varchar(10);
nr_seq_grupo_w			bigint;
nr_seq_subgrupo_w		bigint;
nr_seq_forma_org_w		bigint;
nr_seq_proc_interno_w		bigint;
cd_medico_exec_filtro_w		varchar(10);
cd_tipo_procedimento_w		smallint;
ie_credenciado_w		varchar(1) := 'T';
ie_origem_inf_w			varchar(1);

c01 CURSOR FOR
SELECT 	ie_medico_executor,
	cd_area_proced,
	cd_especial_proced,
	cd_grupo_proced,
	cd_procedimento,
	ie_origem_proced,
	cd_convenio,
	cd_setor_atendimento,
	ie_tipo_atendimento,
	cd_cgc,
	cd_medico_executor,
	nr_seq_exame,
	cd_pessoa_fisica
from 	consiste_setor_proc
where	cd_estabelecimento					= cd_estabelecimento_p
and	coalesce(cd_procedimento, cd_procedimento_p)		= cd_procedimento_p
and	coalesce(ie_origem_proced, ie_origem_proced_p)		= ie_origem_proced_p
and	coalesce(cd_grupo_proced, cd_grupo_w)			= cd_grupo_w
and	coalesce(cd_especial_proced, cd_especialidade_w)		= cd_especialidade_w
and	coalesce(cd_area_proced, cd_area_w)			= cd_area_w
and	coalesce(cd_convenio, cd_convenio_p) 			= cd_convenio_p
and	coalesce(ie_tipo_atendimento, ie_tipo_atendimento_p) 		= ie_tipo_atendimento_p
and	coalesce(cd_setor_atendimento, coalesce(cd_setor_atendimento_p,0)) 	= coalesce(cd_setor_atendimento_p,0)
and	coalesce(nr_seq_exame, coalesce(nr_seq_exame_p,0))		= coalesce(nr_seq_exame_p,0)
--and 	((cd_medico_exec_filtro is null) or (cd_medico_exec_filtro 	= coalesce(cd_medico_exec_filtro_p, cd_medico_exec_filtro)))
and	coalesce(cd_medico_exec_filtro,cd_medico_exec_filtro_w)	= cd_medico_exec_filtro_w
and	coalesce(nr_seq_grupo, coalesce(nr_seq_grupo_w,0))		= coalesce(nr_seq_grupo_w,0)
and	coalesce(nr_seq_subgrupo, coalesce(nr_seq_subgrupo_w,0))		= coalesce(nr_seq_subgrupo_w,0)
and	coalesce(nr_seq_forma_org, coalesce(nr_seq_forma_org_w,0))		= coalesce(nr_seq_forma_org_w,0)
and	coalesce(nr_seq_proc_interno,nr_seq_proc_interno_w)		= nr_seq_proc_interno_w
and	((coalesce(dt_execucao_p::text, '') = '') or (dt_execucao_p between coalesce(dt_inicio_vigencia, dt_execucao_p) and
	coalesce(dt_final_vigencia, dt_execucao_p) + 86399/89400))
and (((coalesce(hr_final::text, '') = '') or (coalesce(hr_inicial::text, '') = '')) or (coalesce(dt_execucao_p,clock_timestamp()) between 
	pkg_date_utils.get_DateTime(coalesce(dt_execucao_p,clock_timestamp()), coalesce(hr_inicial, pkg_date_utils.get_Time(00,00,01))) and
	pkg_date_utils.get_DateTime(coalesce(dt_execucao_p,clock_timestamp()),coalesce(hr_final, pkg_date_utils.get_Time(23,59,59)))))
and	coalesce(nr_seq_classificacao, coalesce(nr_seq_classificacao_p,0)) =  coalesce(nr_seq_classificacao_p,0)
and 	((coalesce(nr_seq_equipe::text, '') = '') or (obter_se_medico_equipe(nr_seq_equipe, cd_medico_exec_filtro_w) = 'S'))
and	coalesce(cd_tipo_procedimento,cd_tipo_procedimento_w,0) = coalesce(cd_tipo_procedimento_w,0)
and	((coalesce(ie_credenciado,'T') = ie_credenciado_w) or (coalesce(ie_credenciado,'T') = 'T'))
and	((coalesce(ie_origem_inf,'N') = 'N') or ((coalesce(ie_origem_inf,'N') = 'S') and (ie_origem_inf_w = 'S')))
and	coalesce(cd_cgc_laboratorio, cd_cgc_laboratorio_p,'0') = coalesce(cd_cgc_laboratorio_p,'0')
and	coalesce(cd_setor_prescricao, cd_setor_prescricao_p,0) = coalesce(cd_setor_prescricao_p,0)
order by 	
	coalesce(nr_seq_proc_interno,0),
	coalesce(nr_seq_exame, 0),
	coalesce(cd_procedimento, 0),
	coalesce(ie_origem_proced, 0),
	coalesce(nr_seq_forma_org, 0),
	coalesce(nr_seq_subgrupo, 0),
	coalesce(nr_seq_grupo, 0),	
	coalesce(cd_grupo_proced, 0),
	coalesce(cd_especial_proced, 0),
	coalesce(cd_area_proced, 0),
	coalesce(ie_tipo_atendimento, 0),
	coalesce(cd_setor_atendimento, 0),
	coalesce(cd_setor_prescricao,0),
	somente_numero(coalesce(cd_medico_exec_filtro, to_char(somente_numero(cd_medico_exec_filtro_p) + 1))) desc,
	coalesce(cd_convenio, 0),
	coalesce(nr_seq_equipe,0),
	coalesce(cd_tipo_procedimento,0),
	ie_credenciado desc,
	coalesce(ie_origem_inf,'A'),
	coalesce(cd_cgc_laboratorio,'0');


BEGIN
cd_cgc_retorno_w			:= null;
cd_medico_retorno_w			:= null;
nr_seq_proc_interno_w		:= coalesce(nr_seq_proc_interno_p,0);
cd_medico_exec_filtro_w		:= coalesce(cd_medico_exec_filtro_p,0);
begin

select	b.cd_grupo_proc,
		b.cd_especialidade,
		b.cd_area_procedimento,
		b.cd_tipo_procedimento
into STRICT	cd_grupo_w,
		cd_especialidade_w,
		cd_area_w,
		cd_tipo_procedimento_w
from 	estrutura_procedimento_v b
where	b.cd_procedimento		= cd_procedimento_p
and		b.ie_origem_proced	= ie_origem_proced_p;
exception
     when others then
        cd_grupo_w := 0;
		cd_especialidade_w := 0;
		cd_area_w := 0;
		cd_tipo_procedimento_w  := 0;
end;

/* felipe os 84456 - buscar a estrutura de procedimento sus */

if (ie_origem_proced_p = 7) then
	begin
	select	nr_seq_grupo,
			nr_seq_subgrupo,
			nr_seq_forma_org
	into STRICT	nr_seq_grupo_w,
			nr_seq_subgrupo_w,
			nr_seq_forma_org_w
	from	sus_estrutura_procedimento_v
	where	cd_procedimento		= cd_procedimento_p
	and		ie_origem_proced	= ie_origem_proced_p;
	exception
		when others then
			nr_seq_grupo_w		:= 0;
			nr_seq_subgrupo_w	:= 0;
			nr_seq_forma_org_w	:= 0;
	end;
end if;

if (cd_medico_exec_filtro_p IS NOT NULL AND cd_medico_exec_filtro_p::text <> '') then
	ie_credenciado_w	:= coalesce(obter_se_medico_credenciado(cd_estabelecimento_p, cd_medico_exec_filtro_p, cd_convenio_p, null, 0, null, cd_setor_atendimento_p, null, dt_execucao_p, ie_tipo_atendimento_p, null,null),'T');
end if;
	
if (coalesce(ie_origem_inf_p,'N') = 'L') then
	ie_origem_inf_w	:= 'S';
else
	ie_origem_inf_w	:= 'N';
end if;

open c01;
loop
fetch c01 into
		ie_medico_executor_w,
		cd_area_w,
		cd_especialidade_w,
		cd_grupo_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		cd_convenio_w,
		cd_setor_atendimento_w,
		ie_tipo_atendimento_w,
		cd_cgc_w,
		cd_medico_executor_w,
		nr_seq_exame_w,
		cd_pessoa_fisica_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		
		cd_medico_retorno_w			:= null;
		
		if (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') then
			cd_cgc_retorno_w		:= cd_cgc_w;	
		end if;
		
		if (ie_medico_executor_w = 'B') and (ie_execucao_p = 'N') then
			begin
			ie_medico_executor_w := 'F';
			end;
        elsif (ie_medico_executor_w = 'B') and (ie_execucao_p = 'S') then
            cd_medico_retorno_w		:= cd_medico_executor_w;
		end if;
		
		if (cd_medico_executor_w IS NOT NULL AND cd_medico_executor_w::text <> '') and (ie_medico_executor_w = 'F') then
			cd_medico_retorno_w		:= cd_medico_executor_w;
		end if;
		end;
end loop;
close c01;


if (ie_medico_executor_w = 'B') and (ie_execucao_p = 'S') then
	begin
	cd_cgc_retorno_w := null;
	end;
end if;
			

ie_medico_executor_p	:= coalesce(ie_medico_executor_w,'O');
cd_cgc_p				:= cd_cgc_retorno_w;
cd_medico_executor_p	:= cd_medico_retorno_w;
cd_pessoa_fisica_p		:= cd_pessoa_fisica_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_medico_executor ( cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_setor_atendimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, ie_tipo_atendimento_p bigint, nr_seq_exame_p bigint, nr_seq_proc_interno_p bigint, ie_medico_executor_p INOUT text, cd_cgc_p INOUT text, cd_medico_executor_p INOUT text, cd_pessoa_fisica_p INOUT text, cd_medico_exec_filtro_p text, dt_execucao_p timestamp, nr_seq_classificacao_p bigint, ie_origem_inf_p text, cd_cgc_laboratorio_p text, cd_setor_prescricao_p bigint, ie_execucao_p text default 'N') FROM PUBLIC;

