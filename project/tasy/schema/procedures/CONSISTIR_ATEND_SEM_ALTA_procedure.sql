-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_atend_sem_alta ( nr_atendimento_atual_p bigint, ie_tipo_atend_atual_p bigint, cd_pessoa_fisica_p text, cd_estabelecimento_p bigint, cd_setor_atual_p bigint, ie_tipo_atend_tiss_atual_p text, ie_clinica_atual_p text, ds_consistencia_p INOUT text, ie_tipo_convenio_atual_p text default null) AS $body$
DECLARE



ie_tipo_atend_ant_w		smallint;
ie_permite_w			varchar(1) := 'S';
ie_permite_horario_w		varchar(1);
cd_setor_atual_w		bigint;
cd_setor_atual_aux_w		bigint;
nr_atendimento_w                bigint;
cd_setor_anterior_w		bigint;
dt_entrada_w			timestamp;
qt_horas_regra_w		bigint;
ie_tipo_atend_tiss_ant_w	varchar(5);
ds_atendimento_w                varchar(30);
ie_clinica_ant_w		varchar(30);
ie_tipo_convenio_w		atendimento_paciente.ie_tipo_convenio%type;
ds_setor_atendimento_w 	varchar(100);
ds_data_entrada_w 	varchar(40);

c01 CURSOR FOR
	SELECT	ie_tipo_atendimento,
		obter_unidade_atendimento(nr_atendimento, 'A', 'CS'),
		dt_entrada,
		ie_tipo_atend_tiss,
		nr_atendimento,
		ie_clinica,
		ie_tipo_convenio
	from	atendimento_paciente
	where	cd_pessoa_fisica	= cd_pessoa_fisica_p
	and	cd_estabelecimento	= cd_estabelecimento_p
	and	nr_atendimento		<> nr_atendimento_atual_p
	and	coalesce(dt_alta::text, '') = ''
	and	coalesce(dt_cancelamento::text, '') = ''
	and	ie_permite_w 		= 'S';

c02 CURSOR FOR
	SELECT	coalesce(max('N'),'S'),
		coalesce(max(qt_horas_regra),0)
	from	regra_atend_sem_alta
	where	coalesce(ie_tipo_atend_atual,coalesce(ie_tipo_atend_atual_p, 0))		=	coalesce(ie_tipo_atend_atual_p,0)
	and	coalesce(ie_tipo_atend_ant,coalesce(ie_tipo_atend_ant_w,0))		=	coalesce(ie_tipo_atend_ant_w,0)
	and	coalesce(cd_setor_atual,coalesce(cd_setor_atual_w,0)) 			=	coalesce(cd_setor_atual_w,0)
	and	coalesce(cd_setor_anterior,coalesce(cd_setor_anterior_w,0))		=	coalesce(cd_setor_anterior_w,0)
	and	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0))		=	coalesce(cd_estabelecimento_p,0)
	and	coalesce(ie_tipo_atend_tiss_atual,coalesce(ie_tipo_atend_tiss_atual_p,0))	=	coalesce(ie_tipo_atend_tiss_atual_p,0)
	and	coalesce(ie_tipo_atend_tiss,coalesce(ie_tipo_atend_tiss_ant_w,0))		=	coalesce(ie_tipo_atend_tiss_ant_w,0)
	and	ie_permite_w = 'S'
	and	coalesce(ie_clinica_atual,coalesce(ie_clinica_atual_p ,0)) 		= 	coalesce(ie_clinica_atual_p ,0)
	and	coalesce(ie_clinica_ant, coalesce(ie_clinica_ant_w,0)) 			= 	coalesce(ie_clinica_ant_w,0)
	and	coalesce(ie_tipo_convenio, coalesce(ie_tipo_convenio_w,0)) 		= 	coalesce(ie_tipo_convenio_w,0)
	and	coalesce(ie_tipo_convenio_atual, coalesce(ie_tipo_convenio_atual_p, 0))	=	coalesce(ie_tipo_convenio_atual_p, 0);


BEGIN

select	coalesce(max(somente_numero(obter_unidade_atendimento(nr_atendimento_atual_p, 'A', 'S'))),0)
into STRICT	cd_setor_atual_aux_w
;
	
if (cd_setor_atual_aux_w = 0) then
	cd_setor_atual_w := cd_setor_atual_p;
else
	cd_setor_atual_w := cd_setor_atual_aux_w;
end if;

OPEN C01;
LOOP
FETCH C01 into
	ie_tipo_atend_ant_w,
	cd_setor_anterior_w,
	dt_entrada_w,
	ie_tipo_atend_tiss_ant_w,
	nr_atendimento_w,
	ie_clinica_ant_w,
	ie_tipo_convenio_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
	OPEN C02;
	LOOP
	FETCH C02 into
		ie_permite_w,
		qt_horas_regra_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		
		if (ie_permite_w = 'N') then		
			if (qt_horas_regra_w > 0) then
				
				if	((dt_entrada_w + (qt_horas_regra_w/24))	> clock_timestamp()) then				
					ie_permite_horario_w := 'S';					
				else						
					if (coalesce(ie_permite_horario_w::text, '') = '') then
						ie_permite_horario_w := 'N';
					end if;					
				end if;				
				ie_permite_w := 'S';
			else	
				exit;		
			end if;
		end if;
		end;
	END LOOP;
	CLOSE C02;
	if (ie_permite_w = 'N') then
		exit;
	end if;
	end;
END LOOP;
CLOSE C01;


if (ie_permite_w = 'N')	or (ie_permite_horario_w = 'N') then
	ds_setor_atendimento_w := substr(obter_unidade_atendimento(nr_atendimento_w, 'A', 'S'),1,100);
	ds_data_entrada_w := substr(obter_unidade_atendimento(nr_atendimento_w, 'A', 'DT'),1,40);
	
	if (ds_setor_atendimento_w IS NOT NULL AND ds_setor_atendimento_w::text <> '' AND ds_data_entrada_w IS NOT NULL AND ds_data_entrada_w::text <> '') then
		ds_consistencia_p := substr(obter_texto_dic_objeto(1008333, wheb_usuario_pck.get_nr_seq_idioma, 'VL_DOMINIO='||obter_valor_dominio(12,ie_tipo_atend_ant_w)||';NR_ATENDIMENTO='||nr_atendimento_w||
								';DS_SETOR_ATUAL='|| ds_setor_atendimento_w ||';DT_ENTRADA='|| ds_data_entrada_w  ),1,255);
	else
		ds_consistencia_p := substr(obter_texto_dic_objeto(292855, wheb_usuario_pck.get_nr_seq_idioma, 'VL_DOMINIO='||obter_valor_dominio(12,ie_tipo_atend_ant_w)||';NR_ATENDIMENTO='||nr_atendimento_w),1,255);
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_atend_sem_alta ( nr_atendimento_atual_p bigint, ie_tipo_atend_atual_p bigint, cd_pessoa_fisica_p text, cd_estabelecimento_p bigint, cd_setor_atual_p bigint, ie_tipo_atend_tiss_atual_p text, ie_clinica_atual_p text, ds_consistencia_p INOUT text, ie_tipo_convenio_atual_p text default null) FROM PUBLIC;

