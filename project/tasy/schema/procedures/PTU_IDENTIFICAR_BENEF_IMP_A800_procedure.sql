-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_identificar_benef_imp_a800 ( nr_seq_benef_fatura_p bigint, nm_usuario_p text) AS $body$
DECLARE


id_beneficiario_w		ptu_fatura_pre_cobranca.id_beneficiario%type;
cd_unimed_w			varchar(30);
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
cd_unimed_origem_w		varchar(10);
nr_seq_congenere_w		pls_congenere.nr_sequencia%type;
dt_competencia_w		timestamp;
nr_seq_repasse_w		pls_segurado_repasse.nr_sequencia%type;
nr_seq_plano_w			pls_plano.nr_sequencia%type	:= null;
ie_acomodacao_w			pls_plano.ie_acomodacao%type;
cd_plano_intercambio_w		ptu_fatura_pre_cobranca.cd_plano_intercambio%type;


BEGIN

select	b.id_beneficiario,
	b.cd_unimed,
	a.cd_unimed_origem,
	a.dt_competencia,
	rtrim(b.cd_plano_intercambio)
into STRICT	id_beneficiario_w,
	cd_unimed_w,
	cd_unimed_origem_w,
	dt_competencia_w,
	cd_plano_intercambio_w
from	ptu_fatura_pre_cobranca	b,
	ptu_fatura_pre		a
where	b.nr_seq_fatura	= a.nr_sequencia
and	b.nr_sequencia	= nr_seq_benef_fatura_p;

cd_unimed_w	:= lpad(cd_unimed_w,4,'0');

select	max(nr_seq_segurado)
into STRICT	nr_seq_segurado_w
from	pls_segurado_carteira
where	cd_usuario_plano	= cd_unimed_w||id_beneficiario_w;

if (nr_seq_segurado_w IS NOT NULL AND nr_seq_segurado_w::text <> '') then
	select	max(nr_sequencia)
	into STRICT	nr_seq_congenere_w
	from	pls_congenere
	where	(cd_cooperativa)::numeric 	= (cd_unimed_origem_w)::numeric;

	select	max(nr_sequencia),
		max(nr_seq_plano)
	into STRICT	nr_seq_repasse_w,
		nr_seq_plano_w
	from	pls_segurado_repasse
	where	nr_seq_segurado		= nr_seq_segurado_w
	and	nr_seq_congenere	= nr_seq_congenere_w
	and	((coalesce(dt_fim_repasse::text, '') = '') or (dt_fim_repasse	> dt_competencia_w));

	if (nr_seq_repasse_w IS NOT NULL AND nr_seq_repasse_w::text <> '') then
		if (coalesce(nr_seq_plano_w::text, '') = '') then
			select	max(b.ie_acomodacao)
			into STRICT	ie_acomodacao_w
			from	pls_segurado	a,
				pls_plano	b
			where	b.nr_sequencia	= a.nr_seq_plano
			and	a.nr_sequencia	= nr_seq_segurado_w;

			select	max(a.nr_sequencia)
			into STRICT	nr_seq_plano_w
			from	pls_plano	a
			where	a.cd_plano_intercambio	= cd_plano_intercambio_w
			and	a.ie_acomodacao		= ie_acomodacao_w;

			if (coalesce(nr_seq_plano_w::text, '') = '') then
				select	max(a.nr_sequencia)
				into STRICT	nr_seq_plano_w
				from	pls_plano	a
				where	a.cd_plano_intercambio	= cd_plano_intercambio_w;
			end if;
		end if;
	else
		nr_seq_segurado_w	:= null;
	end if;
end if;

update	ptu_fatura_pre_cobranca
set	nr_seq_segurado	= nr_seq_segurado_w,
	nr_seq_plano	= CASE WHEN nr_seq_plano_w = NULL THEN nr_seq_plano  ELSE nr_seq_plano_w END
where	nr_sequencia	= nr_seq_benef_fatura_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_identificar_benef_imp_a800 ( nr_seq_benef_fatura_p bigint, nm_usuario_p text) FROM PUBLIC;

