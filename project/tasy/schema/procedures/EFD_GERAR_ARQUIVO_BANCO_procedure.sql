-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE efd_gerar_arquivo_banco (nr_seq_controle_p bigint, nm_usuario_p text) AS $body$
DECLARE


arq_texto_w			 utl_file.file_type;
ds_arquivo_w			 fis_efd_arquivo.ds_arquivo%type;
ds_arquivo_compl_w		 fis_efd_arquivo.ds_arquivo_compl%type;
cd_estabelecimento_w		 fis_efd_controle.cd_estabelecimento%type;
ds_diretorio_w			 varchar(255);
nm_arquivo_w			 varchar(255);
dt_ref_inicial_w		 varchar(10);
qt_contador_w			 bigint	:= 0;
cd_registro_w			 fis_efd_arquivo.cd_registro%type;
nr_linha_w			 fis_efd_arquivo.nr_linha%type;
ds_erro_w			 varchar(2000);


C01 CURSOR FOR
SELECT	 a.cd_registro,
         a.ds_arquivo,
	 a.ds_arquivo_compl,
	 a.nr_linha
from	 fis_efd_arquivo a
where	 a.nr_seq_controle_efd	= nr_seq_controle_p
order by nr_linha;


BEGIN

select	max(cd_estabelecimento),
	max(to_char(dt_ref_inicial,'ddmmyyyy'))
into STRICT	cd_estabelecimento_w,
	dt_ref_inicial_w
from	fis_efd_controle
where	nr_sequencia = nr_seq_controle_p;


ds_diretorio_w		:= substr(coalesce(Obter_Valor_Param_Usuario(5500, 14, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w),''),1,255);
nm_arquivo_w 		:= ('ArquivoEFD' || dt_ref_inicial_w || '.txt');
CALL gravar_processo_longo('Carregando informações ' || nm_arquivo_w,'EFD_GERAR_ARQUIVO_BANCO',qt_contador_w);


begin
arq_texto_w := utl_file.fopen(ds_diretorio_w,nm_arquivo_w,'W');
exception when others then
	ds_erro_w	:= substr(sqlerrm(SQLSTATE),1,2000);
	CALL wheb_mensagem_pck.exibir_mensagem_abort(472074, 'DS_DIRETORIO=' || ds_diretorio_w || ';' ||
							'DS_ERRO=' || ds_erro_w);
end;

open C01;
loop
fetch C01 into
	cd_registro_w,
	ds_arquivo_w,
	ds_arquivo_compl_w,
	nr_linha_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	qt_contador_w	:= nr_linha_w;

	CALL gravar_processo_longo('Gerando arquivo' || cd_registro_w || '-' || nm_arquivo_w ,'EFD_GERAR_ARQUIVO_BANCO',qt_contador_w);

		utl_file.put_line(arq_texto_w,ds_arquivo_w || ds_arquivo_compl_w || chr(13));
		utl_file.fflush(arq_texto_w);

end loop;
close C01;

utl_file.fclose(arq_texto_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE efd_gerar_arquivo_banco (nr_seq_controle_p bigint, nm_usuario_p text) FROM PUBLIC;

