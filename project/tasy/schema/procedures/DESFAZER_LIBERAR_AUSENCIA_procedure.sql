-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_liberar_ausencia (nr_sequencia_p bigint, cd_pessoa_fisica_p text, dt_inicial_P timestamp, dt_final_p timestamp, ie_status_p text) AS $body$
DECLARE

				    
nr_seq_agenda_w			agenda_consulta.nr_sequencia%type;
dt_agenda_w				agenda_consulta.dt_agenda%type;
nr_seq_hora_w			agenda_consulta.nr_seq_hora%type;
cd_agenda_w				agenda_consulta.cd_agenda%type;

C01 CURSOR FOR
	SELECT	b.nr_sequencia,
			b.cd_agenda,
			b.dt_agenda
	FROM	agenda a,
		agenda_consulta b
	WHERE	a.cd_agenda = b.cd_agenda
	AND	a.cd_tipo_agenda = 5
	AND	b.cd_pessoa_fisica = coalesce(cd_pessoa_fisica_p,cd_pessoa_fisica_p)
	AND	b.dt_agenda BETWEEN TRUNC(dt_inicial_p) AND dt_final_p + 86399/86400
	AND	(
		(EXISTS (SELECT 1 FROM rp_pac_modelo_agend_item
			WHERE	nr_sequencia = b.nr_seq_rp_mod_item)) 
		OR (EXISTS (SELECT 1 FROM rp_pac_agend_individual 
			WHERE  nr_sequencia = b.nr_seq_rp_item_ind)))
	AND (b.ie_status_agenda = ie_status_p);
	


BEGIN


open C01;
loop
fetch C01 into	
	nr_seq_agenda_w,
	cd_agenda_w,
	dt_agenda_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	select 	coalesce(max(nr_seq_hora), 0) + 1
	into STRICT	nr_seq_hora_w
	from agenda_consulta
	where cd_agenda = cd_agenda_w
	and ie_status_agenda	= 'N'
	and dt_agenda = dt_agenda_w;

	update	agenda_consulta
	set	ie_status_agenda	= 'N',
		ds_motivo_status	 = NULL,
		cd_motivo_cancelamento	 = NULL,
		nr_seq_hora 		= nr_seq_hora_w
	where	nr_sequencia		= nr_seq_agenda_w;

				
	end;
end loop;
close C01;


if (coalesce(nr_sequencia_p,0) > 0) then
	update 	rp_licenca
	set 	dt_liberacao  = NULL,
		nm_usuario_lib  = NULL
	where 	nr_sequencia = nr_sequencia_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_liberar_ausencia (nr_sequencia_p bigint, cd_pessoa_fisica_p text, dt_inicial_P timestamp, dt_final_p timestamp, ie_status_p text) FROM PUBLIC;

