-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE remove_docto_fluxo_caixa (nr_documento_p bigint, nr_docto_compl_p bigint, ie_origem_info_p text, dt_referencia_p timestamp default null, ie_commit_p text default 'N') AS $body$
DECLARE


qt_registros_w		bigint := 0;

/* -------- Origem da Informação -------- */


/* -- Identifica de onde vem a informação que será gerada no fluxo de caixa -- 
 TP - Título a pagar
 TPB - Baixa do título a pagar
 TR - Título a receber
 TRB - Baixa do título a receber
 TRT - Tributos a pagar (gerados pelo título a receber)
 CR - Cheque a receber
 CP - Cheque a pagar
 CC - Cartão
 CCB - Baixa de cartão
 RC - Recebimento convênio
 CBT - Controle bancário e Tesouraria
 PR - Projeto recurso
 BP - Borderô a pagar - Entra pelo título
 PE - Pagamento escritural - Entra pelo título
 PC - Protocolo convênio
 GR - Glosas a recuperar - Entra pelo título
 GEF - Gestão de empréstimos e financiamentos
 OC - Ordem de compra
 CO - Contrato
 PAC - Conta paciente
 RT - Repasse terceiro
 AG - Agenda
*/
BEGIN

	if (ie_origem_info_p = 'TP') then
		select	count(*)
		into STRICT	qt_registros_w
		from	fluxo_caixa_docto
		where	nr_titulo_pagar = nr_documento_p
		and	ie_integracao in ('CP','PE','BP')
		and	coalesce(nr_docto_compl_p::text, '') = '';

		if (qt_registros_w > 0) then
			begin
			delete from fluxo_caixa_docto
			where	nr_titulo_pagar = nr_documento_p
			and	ie_integracao in ('CP','PE','BP')
			and	coalesce(nr_docto_compl_p::text, '') = ''
			and  ie_classif_fluxo = 'R'
			and	coalesce(nr_seq_tit_pag_baixa::text, '') = '';
			
			end;
		end if;
	elsif (ie_origem_info_p = 'TPBA') then
		select	count(*)
		into STRICT	qt_registros_w
		from	fluxo_caixa_docto
		where	nr_titulo_pagar = nr_documento_p
		and	nr_seq_tit_pag_adiant = nr_docto_compl_p
		and	ie_integracao in ('CP','PE','BP');

		if (qt_registros_w > 0) then
			begin
			delete from fluxo_caixa_docto
			where	nr_titulo_pagar = nr_documento_p
			and	nr_seq_tit_pag_adiant = nr_docto_compl_p
			and	ie_integracao in ('CP','PE','BP');
			
			end;
		end if;	
	elsif (ie_origem_info_p = 'TPB') then
		select	count(*)
		into STRICT	qt_registros_w
		from	fluxo_caixa_docto
		where	nr_titulo_pagar = nr_documento_p
		and	nr_seq_tit_pag_baixa = nr_docto_compl_p
		and	ie_integracao in ('CP','PE','BP');

		if (qt_registros_w > 0) then
			begin
			delete from fluxo_caixa_docto
			where	nr_titulo_pagar = nr_documento_p
			and	nr_seq_tit_pag_baixa = nr_docto_compl_p
			and	ie_integracao in ('CP','PE','BP');
			
			end;
		end if;
	elsif (ie_origem_info_p = 'TR') then
		select	count(*)
		into STRICT	qt_registros_w
		from	fluxo_caixa_docto
		where	nr_titulo_receber = nr_documento_p
		and	ie_integracao = 'CR'
		and	coalesce(nr_docto_compl_p::text, '') = '';
		
		if (qt_registros_w > 0) then
			begin
			delete from fluxo_caixa_docto
			where	nr_titulo_receber = nr_documento_p
			and	ie_integracao = 'CR'
			and	coalesce(nr_docto_compl_p::text, '') = ''
			and  ie_classif_fluxo = 'R'
			and	coalesce(nr_seq_tit_rec_baixa::text, '') = '';
			
			end;
		end if;
	elsif (ie_origem_info_p = 'TRB') then
		select	count(*)
		into STRICT	qt_registros_w
		from	fluxo_caixa_docto
		where	nr_titulo_receber = nr_documento_p
		and	nr_seq_tit_rec_baixa = nr_docto_compl_p
		and	ie_integracao = 'CR';
		
		if (qt_registros_w > 0) then
			begin
			delete from fluxo_caixa_docto
			where	nr_titulo_receber = nr_documento_p
			and	nr_seq_tit_rec_baixa = nr_docto_compl_p
			and	ie_integracao = 'CR';
			
			end;
		end if;
	elsif (ie_origem_info_p = 'TRT') then
		select	count(*)
		into STRICT	qt_registros_w
		from	fluxo_caixa_docto
		where	nr_titulo_receber = nr_documento_p
		and	ie_integracao = 'CP'
		and	coalesce(nr_docto_compl_p::text, '') = '';
		
		if (qt_registros_w > 0) then
			begin
			delete from fluxo_caixa_docto
			where	nr_titulo_receber = nr_documento_p
			and	ie_integracao = 'CP'
			and	coalesce(nr_docto_compl_p::text, '') = '';
			
			end;
		end if;
	elsif (ie_origem_info_p = 'CR') then
		select	count(*)
		into STRICT	qt_registros_w
		from	fluxo_caixa_docto
		where	nr_seq_cheque_cr = nr_documento_p;
		
		if (qt_registros_w > 0) then
			begin
			delete from fluxo_caixa_docto
			where	nr_seq_cheque_cr = nr_documento_p;
			
			end;
		end if;
	elsif (ie_origem_info_p = 'CP') then
		select	count(*)
		into STRICT	qt_registros_w
		from	fluxo_caixa_docto
		where	nr_seq_cheque_cp = nr_documento_p;
		
		if (qt_registros_w > 0) then
			begin
			delete from fluxo_caixa_docto
			where	nr_seq_cheque_cp = nr_documento_p;
			
			end;
		end if;
	elsif (ie_origem_info_p in ('CC','CCB')) then
		select	count(*)
		into STRICT	qt_registros_w
		from	fluxo_caixa_docto
		where	nr_seq_movto_cartao = nr_documento_p
		and (coalesce(nr_docto_compl_p::text, '') = '' or nr_seq_movto_parcela = nr_docto_compl_p);
		
		if (qt_registros_w > 0) then
			begin
			delete from fluxo_caixa_docto
			where	nr_seq_movto_cartao = nr_documento_p
			and (coalesce(nr_docto_compl_p::text, '') = '' or nr_seq_movto_parcela = nr_docto_compl_p);
			
			end;
		end if;
	elsif (ie_origem_info_p = 'RC') then
		select	count(*)
		into STRICT	qt_registros_w
		from	fluxo_caixa_docto
		where	nr_seq_conv_receb = nr_documento_p;
		
		if (qt_registros_w > 0) then
			begin
			delete from fluxo_caixa_docto
			where	nr_seq_conv_receb = nr_documento_p;
			
			end;
		end if;
	elsif (ie_origem_info_p = 'CBT') then
		select	count(*)
		into STRICT	qt_registros_w
		from	fluxo_caixa_docto
		where	nr_seq_movto_trans = nr_documento_p;
		
		if (qt_registros_w > 0) then
			begin
			delete from fluxo_caixa_docto
			where	nr_seq_movto_trans = nr_documento_p;
			
			end;
		end if;
	elsif (ie_origem_info_p = 'CBS') then
		select	count(*)
		into STRICT	qt_registros_w
		from	fluxo_caixa_docto
		where	nr_seq_conta_banco = nr_docto_compl_p
		and	coalesce(nr_seq_movto_trans::text, '') = ''
		and	pkg_date_utils.start_of(dt_referencia,'DD',0) = pkg_date_utils.start_of(dt_referencia_p,'DD',0)
		and 	ie_integracao = 'CB';
		
		if (qt_registros_w > 0) then
			begin
			delete from fluxo_caixa_docto
			where	nr_seq_conta_banco = nr_docto_compl_p
			and	coalesce(nr_seq_movto_trans::text, '') = ''
			and	pkg_date_utils.start_of(dt_referencia,'DD',0) = pkg_date_utils.start_of(dt_referencia_p,'DD',0)
			and 	ie_integracao = 'CB';
			
			end;
		end if;
	elsif (ie_origem_info_p = 'PR') then
		select	count(*)
		into STRICT	qt_registros_w
		from	fluxo_caixa_docto
		where	nr_seq_proj_recurso = nr_documento_p;
		
		if (qt_registros_w > 0) then
			begin
			delete from fluxo_caixa_docto
			where	nr_seq_proj_recurso = nr_documento_p;
			
			end;
		end if;
	elsif (ie_origem_info_p = 'PC') then
		select	count(*)
		into STRICT	qt_registros_w
		from	fluxo_caixa_docto
		where	nr_seq_protocolo = nr_documento_p;
		
		if (qt_registros_w > 0) then
			begin
			delete from fluxo_caixa_docto
			where	nr_seq_protocolo = nr_documento_p;
			
			end;
		end if;
	elsif (ie_origem_info_p = 'GEF') then
		select	count(*)
		into STRICT	qt_registros_w
		from	fluxo_caixa_docto
		where	nr_seq_contrato = nr_documento_p
		and	nr_seq_emprest_parc = nr_docto_compl_p;
		
		if (qt_registros_w > 0) then
			begin
			delete from fluxo_caixa_docto
			where	nr_seq_contrato = nr_documento_p
			and	nr_seq_emprest_parc = nr_docto_compl_p;
			
			end;
		end if;
	elsif (ie_origem_info_p = 'CO') then
		select	count(*)
		into STRICT	qt_registros_w
		from	fluxo_caixa_docto
		where	nr_seq_contrato = nr_documento_p;
		
		if (qt_registros_w > 0) then
			begin
			delete from fluxo_caixa_docto
			where	nr_seq_contrato = nr_documento_p;
			
			end;
		end if;
	elsif (ie_origem_info_p = 'OC') then
		select	count(*)
		into STRICT	qt_registros_w
		from	fluxo_caixa_docto
		where	nr_ordem_compra = nr_documento_p
		and 	nr_seq_oc_vencimento = nr_docto_compl_p;
		
		if (qt_registros_w > 0) then
			begin
			delete from fluxo_caixa_docto
			where	nr_ordem_compra = nr_documento_p
			and 	nr_seq_oc_vencimento = nr_docto_compl_p;
			
			end;
		end if;
	elsif (ie_origem_info_p = 'PAC') then
		select	count(*)
		into STRICT	qt_registros_w
		from	fluxo_caixa_docto
		where	nr_interno_conta = nr_documento_p;
		
		if (qt_registros_w > 0) then
			begin
			delete from fluxo_caixa_docto
			where	nr_interno_conta = nr_documento_p;
			
			end;
		end if;
	elsif (ie_origem_info_p = 'RT') then
		select	count(*)
		into STRICT	qt_registros_w
		from	fluxo_caixa_docto
		where	nr_repasse_terceiro = nr_documento_p;
		
		if (qt_registros_w > 0) then
			begin
			delete from fluxo_caixa_docto
			where	nr_repasse_terceiro = nr_documento_p;
			
			end;
		end if;
	elsif (ie_origem_info_p = 'AG') then
		select	count(*)
		into STRICT	qt_registros_w
		from	fluxo_caixa_docto
		where	cd_agenda = nr_documento_p;
		
		if (qt_registros_w > 0) then
			begin
			delete from fluxo_caixa_docto
			where	cd_agenda = nr_documento_p;
			
			end;
		end if;
	end if;
	
	if (ie_commit_p = 'S') then
		commit;
	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE remove_docto_fluxo_caixa (nr_documento_p bigint, nr_docto_compl_p bigint, ie_origem_info_p text, dt_referencia_p timestamp default null, ie_commit_p text default 'N') FROM PUBLIC;

