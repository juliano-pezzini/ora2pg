-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_senha_nao_respondida (nr_sequencia_p bigint) AS $body$
DECLARE

 
nm_usuario_chamada_w 	varchar(255);
cd_estabelecimento_w	bigint;	
nm_usuario_w		varchar(255);
ie_consiste_usuario_w	varchar(10);
dt_ultima_chamada_w	timestamp;
ie_rechamada_w		varchar(1);
dt_rechamada_w		timestamp;


BEGIN 
cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;
nm_usuario_w	   := wheb_usuario_pck.get_nm_usuario;
 
ie_consiste_usuario_w := Obter_Param_Usuario(10021, 61, Obter_perfil_Ativo, nm_usuario_w, cd_estabelecimento_w, ie_consiste_usuario_w);
 
select 	max(nm_usuario_chamada), 
	max(ie_rechamada), 
	max(dt_nova_chamada) 
into STRICT	nm_usuario_chamada_w, 
	ie_rechamada_w, 
	dt_rechamada_w 
from	paciente_senha_fila 
where	(dt_primeira_chamada IS NOT NULL AND dt_primeira_chamada::text <> '') 
and	nr_sequencia = nr_sequencia_p;
 
select	max(dt_atualizacao_nrec) 
into STRICT	dt_ultima_chamada_w 
from	paciente_senha_fila_hist 
where	nr_seq_senha = nr_sequencia_p;
 
if	((ie_consiste_usuario_w = 'S') or 
	((ie_consiste_usuario_w = 'M') and (obter_se_usuario_medico(nm_usuario_chamada_w) = 'S') and (obter_se_usuario_medico(nm_usuario_w) = 'S'))) and 
	((coalesce(dt_rechamada_w::text, '') = '') or (dt_ultima_chamada_w < dt_rechamada_w)) then 
	if (nm_usuario_chamada_w IS NOT NULL AND nm_usuario_chamada_w::text <> '') and (nm_usuario_chamada_w <> nm_usuario_w) then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(227548, 'NM_USUARIO_CHAMADA= ' || nm_usuario_chamada_w);
	elsif (coalesce(nm_usuario_chamada_w::text, '') = '') then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(227546, '');
	end if;
end if;
 
update	paciente_senha_fila 
set	ie_rechamada	= 'S', 
	dt_nova_chamada	= clock_timestamp(), 
	dt_inicio_atendimento  = NULL, 
	dt_fim_atendimento  = NULL 
where	nr_sequencia 	= nr_sequencia_p;
 
update	atendimento_paciente 
set	ie_chamado = 'X', 
	ie_status_pa = 'PN' 
where	nr_seq_pac_senha_fila = nr_sequencia_p;
 
delete from atendimentos_senha 
where  nr_seq_pac_senha_fila = nr_sequencia_p 
and 	coalesce(dt_fim_atendimento::text, '') = '';
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_senha_nao_respondida (nr_sequencia_p bigint) FROM PUBLIC;

