-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE excluir_atendimento ( nr_atendimento_p bigint, ie_consiste_p text, nm_usuario_p text, ds_justificativa_p text, ds_erro_p out text) IS ds_erro_w varchar(255) AS $body$
DECLARE

ds_erro_ww	varchar(4000);

BEGIN

if (ds_erro_pp IS NOT NULL AND ds_erro_pp::text <> '') then
	ds_erro_ww := ds_erro_pp || chr(10) || chr(13);
else
	ds_erro_ww := ds_erro_pp;
end if;

return;

end;


BEGIN
ds_sep_bv_w := obter_separador_bv;
ds_justificativa_w 	:= substr(ds_justificativa_p,1,100);
	
select	max(cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	atendimento_paciente
where	nr_atendimento = nr_atendimento_p;

ie_consiste_mat_exc_w := Obter_Param_Usuario(916, 406, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_consiste_mat_exc_w);
ie_verifica_prescr_w  := Obter_Param_Usuario(916, 545, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_verifica_prescr_w );

if (ie_consiste_mat_exc_w = 'S') then

	select	coalesce(count(1),0)
	into STRICT	qt_proc_w
	from	procedimento_paciente
	where	nr_atendimento = nr_atendimento_p;

	select	coalesce(count(1),0)
	into STRICT	qt_material_w
	from	Material_Atend_Paciente
	where	nr_atendimento = nr_atendimento_p;

	if (qt_proc_w > 0) then
		ds_erro_w	:= obter_ds_erro_format(ds_erro_w) || WHEB_MENSAGEM_PCK.get_texto(279926,'QT_PROC='||qt_proc_w);
	end if;	

	if (qt_Material_w > 0) then
		ds_erro_w	:= obter_ds_erro_format(ds_erro_w) || WHEB_MENSAGEM_PCK.get_texto(279924,'QT_MATERIAL='|| qt_material_w);
	end if;	

end if;

if (ie_consiste_p = 'S') then
	begin
	select	max(dt_alta),
			max(cd_estabelecimento)
	into STRICT	dt_alta_w, 
			cd_estabelecimento_w
	from	atendimento_paciente
	where	nr_atendimento = nr_atendimento_p;

	select	coalesce(count(1),0)
	into STRICT	qt_proc_w
	from	procedimento_paciente a,
		conta_paciente b
	where	a.nr_atendimento	= nr_atendimento_p
	and	b.nr_interno_conta = a.nr_interno_conta
	and	coalesce(b.ie_cancelamento::text, '') = ''
	and	coalesce(a.cd_motivo_exc_conta::text, '') = '' LIMIT 1;

	select	coalesce(count(1),0)
	into STRICT	qt_material_w
	from	material_atend_paciente a,
		conta_paciente b
	where	a.nr_atendimento	= nr_atendimento_p
	and	b.nr_interno_conta = a.nr_interno_conta
	and	coalesce(b.ie_cancelamento::text, '') = ''
	and	coalesce(a.cd_motivo_exc_conta::text, '') = '' LIMIT 1;
	
	select 	coalesce(count(1),0)
	into STRICT	qt_envdisprob_w
	from 	encounter_discharge_prob
	where 	nr_atendimento = nr_atendimento_p;

	if (dt_alta_w IS NOT NULL AND dt_alta_w::text <> '') then
		ds_erro_w	:= wheb_mensagem_pck.get_texto(278820,null);
	end if;		

	if (qt_proc_w > 0) then
		ds_erro_w	:= obter_ds_erro_format(ds_erro_w) || WHEB_MENSAGEM_PCK.get_texto(278823,'QT_PROC='|| qt_proc_w);
	end if;		

	if (qt_Material_w > 0) then
		ds_erro_w	:= obter_ds_erro_format(ds_erro_w) || WHEB_MENSAGEM_PCK.get_texto(278826,'QT_MATERIAL='|| qt_material_w);
	end if;	

	select	coalesce(max(nr_atendimento),0)
	into STRICT	nr_atend_origem_w
	from	atendimento_paciente
	where	nr_atend_original = nr_atendimento_p;
	
	if (nr_atend_origem_w > 0) then
		ds_erro_w	:= obter_ds_erro_format(ds_erro_w) || WHEB_MENSAGEM_PCK.get_texto(279921,'NR_ATEND_ORIGEM='|| nr_atend_origem_w);
	end if;
	
	if (qt_envdisprob_w > 0) then
		delete FROM encounter_discharge_prob where nr_atendimento = nr_atendimento_p;
	end if;
	
	end;
end if;

	select	coalesce(count(1),0)
	into STRICT	ie_existe_laudo_w
	from	laudo_paciente
	where	nr_atendimento = nr_atendimento_p;


	if (ie_existe_laudo_w > 0) then
		ds_erro_w	:= obter_ds_erro_format(ds_erro_w) || WHEB_MENSAGEM_PCK.get_texto(1095418);
	end if;	

	select	coalesce(count(1),0)
	into STRICT	ie_existe_laudo_hem_w
	from	hem_proc
	where	nr_atendimento = nr_atendimento_p;

	if (ie_existe_laudo_hem_w > 0) then
		ds_erro_w	:= obter_ds_erro_format(ds_erro_w) || WHEB_MENSAGEM_PCK.get_texto(1095418);
	end if;

   	select	coalesce(count(1),0)
	into STRICT	ie_existe_exame_hem_w
	from	hem_calc_hemodinamico
	where	nr_atendimento = nr_atendimento_p;

	if (ie_existe_exame_hem_w > 0) then
		ds_erro_w	:= obter_ds_erro_format(ds_erro_w) || WHEB_MENSAGEM_PCK.get_texto(1095418);
	end if;
	
	select	coalesce(count(1),0)
	into STRICT	ie_existe_kv_ind_clinica_w
	from	KV_INDICACAO_CLINICA
	where	nr_atendimento = nr_atendimento_p;

	select	coalesce(count(1),0)
	into STRICT	ie_existe_kv_atest_crianca_w
	from	KV_ATESTADO_CRIANCA
	where	nr_atendimento = nr_atendimento_p;
	
	select	coalesce(count(1),0)
	into STRICT	ie_existe_form_audicao_w
	from	FORMULARIO_AUDICAO
	where	nr_atendimento = nr_atendimento_p;
	
	select	coalesce(count(1),0)
	into STRICT	ie_existe_form_socioterapia_w
	from	FORMULARIO_SOCIOTERAPIA
	where	nr_atendimento = nr_atendimento_p;
	
	select	coalesce(count(1),0)
	into STRICT	ie_existe_oft_aux_visual_w
	from	OFT_AUXILIO_VISUAL_GER
	where	nr_atendimento = nr_atendimento_p;
	
	select	coalesce(count(1),0)
	into STRICT	ie_existe_carta_medica_w
	from	CARTA_MEDICA
	where	nr_atendimento = nr_atendimento_p;

	if	((ie_existe_kv_ind_clinica_w > 0)
		or (ie_existe_kv_atest_crianca_w > 0)
		or (ie_existe_form_audicao_w > 0)
		or (ie_existe_form_socioterapia_w > 0)
		or (ie_existe_oft_aux_visual_w > 0)
		or (ie_existe_carta_medica_w > 0)) then
		ds_erro_w	:= obter_ds_erro_format(ds_erro_w) || WHEB_MENSAGEM_PCK.get_texto(1098372);
	end if;

	select	count(1)
	into STRICT	qt_dialise_w
	from	HD_DIALISE
	where	nr_atendimento = nr_atendimento_p;
	
	if (qt_dialise_w < 0) then
		ds_erro_w	:= obter_ds_erro_format(ds_erro_w) || WHEB_MENSAGEM_PCK.get_texto(1103057);
	end if;

	select	count(1)
	into STRICT	qt_isolamento_w
	from	CIH_ATEND_ISOLAMENTO
	where	nr_atendimento = nr_atendimento_p;
	
	if (qt_isolamento_w < 0) then
		ds_erro_w	:= obter_ds_erro_format(ds_erro_w) || WHEB_MENSAGEM_PCK.get_texto(1103064);
	end if;
	
if ( ie_verifica_prescr_w = 'N') then

	select 	count(1)			
	into STRICT	qt_itens_prescr_w
	from	prescr_procedimento a,
		prescr_medica b
	where	a.nr_prescricao = b.nr_prescricao
	and	ie_suspenso <> 'S'
	and	b.nr_atendimento = nr_atendimento_p;

	if (qt_itens_prescr_w = 0) then

		select 	count(1)
		into STRICT	qt_itens_prescr_w
		from	prescr_material a,
			prescr_medica b
		where	a.nr_prescricao = b.nr_prescricao
		and	ie_suspenso <> 'S'
		and	b.nr_atendimento = nr_atendimento_p;

	end if;
	
	if (qt_itens_prescr_w > 0) then	
		ds_erro_w	:= obter_ds_erro_format(ds_erro_w) || WHEB_MENSAGEM_PCK.get_texto(174985,null);
	end if;		
end if;

if (coalesce(ds_erro_w::text, '') = '') then
	begin
	
	update diagnostico_doenca
	set	nr_seq_atepacu  = NULL
	where nr_seq_atepacu in (SELECT	x.nr_seq_interno
							from	atend_paciente_unidade x
							where	x.nr_atendimento = nr_atendimento_p);
	
	select  max(Obter_Prontuario_Paciente(cd_pessoa_fisica)) nr_prontuario,
			max(substr(obter_nome_pf(cd_pessoa_fisica),1,100)) nm_paciente,
			max(dt_entrada)
	into STRICT	nr_prontuario_w,
			nm_paciente_w,
			dt_entrada_w
	from	atendimento_paciente
	where	nr_atendimento = nr_atendimento_p;

	select count(1)
	into STRICT qt_worklist_w
	from wl_worklist
	where nr_atendimento = nr_atendimento_p;

	if (qt_worklist_w > 0) then
		update wl_worklist
		set nr_seq_diagnostico  = NULL
		where nr_atendimento = nr_atendimento_p;
	end if;

	update	transf_prontuario
	set	nr_atendimento  = NULL
	where	nr_atendimento = nr_atendimento_p;

	update	agenda_paciente
	set 	nr_atendimento	 = NULL,
		nr_cirurgia	 = NULL,
		ie_status_agenda	= 'N' /* Rafael em 09/09/06 OS39723 */
	where 	nr_atendimento	= nr_atendimento_p;
	
	update agenda_consulta
	set 	nr_atendimento	 = NULL,
		ie_status_agenda 	= 'N' /* Rafael em 09/09/06 OS39723 */
	where 	nr_atendimento	= nr_atendimento_p;

	update agenda_lista_espera
	set 	nr_atendimento	 = NULL
	where 	nr_atendimento	= nr_atendimento_p;

	delete from atend_cid_esp_pre_agend where nr_atendimento = nr_atendimento_p;

	update	movimento_estoque
	set	nr_atendimento	 = NULL
	where	nr_atendimento	= nr_atendimento_p; /*Edilson em 09/01/2007 OS 47576 Falei com Fabio*/
	update	movimento_estoque a
	set	a.nr_prescricao	 = NULL
	where	exists (	SELECT	1
				from	prescr_medica b
				where	a.nr_prescricao	= b.nr_prescricao
				and	b.nr_atendimento	= nr_atendimento_p); /*Edilson em 05/05/2007 OS 49847 Falei com Fabio*/
	delete from cirurgia_tempo a
	 	where a.nr_cirurgia in (SELECT b.nr_cirurgia from cirurgia b
				 	where  b.nr_atendimento = nr_atendimento_p);
	delete from cirurgia_participante a
	 	where a.nr_cirurgia in (SELECT b.nr_cirurgia from cirurgia b
				 	where  b.nr_atendimento = nr_atendimento_p);
					
	update	agenda_paciente a /*Felipe Martini em 24/03/2010 OS204689*/
	set 	a.nr_atendimento	 = NULL,
		a.nr_cirurgia	 = NULL,
		a.ie_status_agenda	= 'N'
	where 	a.nr_cirurgia	in (SELECT b.nr_cirurgia from cirurgia b 
				 	where  b.nr_atendimento = nr_atendimento_p);
					
	update	autorizacao_convenio
	set	nr_seq_agenda	 = NULL
	where	nr_atendimento	= nr_atendimento_p;
							
	delete from cirurgia_descricao a
	 	where a.nr_cirurgia in (SELECT b.nr_cirurgia from cirurgia b
				 	where  b.nr_atendimento = nr_atendimento_p);
	
	delete from parecer_medico_req where nr_atendimento = nr_atendimento_p;
	delete from diagnostico_medico where nr_atendimento = nr_atendimento_p;
	delete from nascimento where nr_atendimento = nr_atendimento_p;
	delete 	from	evolucao_paciente e
		where	e.nr_atendimento = nr_atendimento_p
		and	((coalesce(e.nr_cirurgia::text, '') = '') or (e.nr_cirurgia not in (SELECT c.nr_cirurgia from cirurgia c where c.nr_atendimento = nr_atendimento_p)));
	delete from evolucao_paciente where nr_atend_alta = nr_atendimento_p;
	delete from devolucao_material_pac where nr_atendimento = nr_atendimento_p;
	
	delete from material_atend_paciente where nr_atendimento = nr_atendimento_p;
	
	delete from material_atend_paciente where nr_cirurgia in (SELECT b.nr_cirurgia from cirurgia b
				 	where  b.nr_atendimento = nr_atendimento_p);
	update procedimento_paciente
		set nr_laudo  = NULL 
		where nr_atendimento = nr_atendimento_p;
	delete from procedimento_paciente where nr_atendimento = nr_atendimento_p;	
	delete from procedimento_paciente where nr_cirurgia in (SELECT b.nr_cirurgia from cirurgia b
	where  b.nr_atendimento = nr_atendimento_p);
	delete from cih_cirurgia where nr_seq_cirurgia_pac in (SELECT b.nr_cirurgia from cirurgia b
				 	where  b.nr_atendimento = nr_atendimento_p);
	delete from anestesia_descricao  where nr_cirurgia in (SELECT b.nr_cirurgia from cirurgia b
	where  b.nr_atendimento = nr_atendimento_p);
	delete from aval_pre_anestesica  where nr_cirurgia in (SELECT b.nr_cirurgia from cirurgia b
	where  b.nr_atendimento = nr_atendimento_p);
	delete from cirurgia_tec_anestesica  where nr_cirurgia in (SELECT b.nr_cirurgia from cirurgia b
	where  b.nr_atendimento = nr_atendimento_p);
	delete from aval_pre_anestesica  where nr_atendimento	= nr_atendimento_p;
	delete from evolucao_paciente where nr_atendimento = nr_atendimento_p;
	delete from evolucao_paciente where nr_cirurgia in (SELECT nr_cirurgia from cirurgia where nr_atendimento = nr_atendimento_p);
	update checkup set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	delete FROM atendimento_audit_medica where nr_atendimento = nr_atendimento_p;
	delete FROM parto_prog_esp where nr_atendimento = nr_atendimento_p;
	update checkup_dado_estat set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update cur_curativo_esp set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	delete FROM atend_indic_clinico where nr_atendimento = nr_atendimento_p;
	delete FROM checkup_diagnostico where nr_atendimento = nr_atendimento_p;
	delete FROM checkup_orientacao where nr_atendimento = nr_atendimento_p;
	delete FROM checkup_coment_adic where nr_atendimento = nr_atendimento_p;
	delete FROM med_receita where nr_atendimento_hosp = nr_atendimento_p;
	delete FROM nascimento_evento where nr_atendimento = nr_atendimento_p;
	delete FROM parto_eventos where nr_atendimento = nr_atendimento_p;
	delete FROM pre_natal where nr_atendimento = nr_atendimento_p;
	delete FROM pep_med_fatur where nr_atendimento = nr_atendimento_p;
	update pf_alerta set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	delete FROM nascimento_ef_alta where nr_atendimento = nr_atendimento_p;
	update w_result_check_etapa set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	delete FROM atend_tipo_acompanhante where nr_atendimento = nr_atendimento_p;
	update prontuario_emissao set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	delete FROM atend_prev_alta_just where nr_atendimento = nr_atendimento_p;
	delete FROM atend_previsao_alta where nr_atendimento = nr_atendimento_p;
	update atend_check_list set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	delete FROM orientacao_alta_enf where nr_atendimento = nr_atendimento_p;
	delete FROM atendimento_gravidez where nr_atendimento = nr_atendimento_p;
	delete FROM atend_diagnostico_pendente where nr_atendimento = nr_atendimento_p;
	update ehr_reg_elemento_item set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update paciente_imagem set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	delete FROM declaracao_morte_encef where nr_atendimento = nr_atendimento_p;
	update ged_atendimento set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update pep_orientacao_geral set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	delete FROM proc_pac_desc_partic a where a.nr_seq_procedimento_pep in (SELECT b.nr_sequencia from proc_pac_descricao b where b.nr_atendimento = nr_atendimento_p);
	delete FROM proc_pac_descricao where nr_atendimento = nr_atendimento_p;
	delete FROM nascimento_imagem where nr_atendimento = nr_atendimento_p;
	delete FROM rehu_dado_clinico a where a.nr_seq_ciclo in (SELECT b.nr_sequencia from rehu_ciclo b where b.nr_atendimento = nr_atendimento_p);
	delete FROM rehu_analise_semem a where a.nr_seq_ciclo in (SELECT b.nr_sequencia from rehu_ciclo b where b.nr_atendimento = nr_atendimento_p);
	delete FROM rehu_analise_dpi a where a.nr_seq_ciclo in (SELECT b.nr_sequencia from rehu_ciclo b where b.nr_atendimento = nr_atendimento_p);
	delete FROM rehu_anexo a where a.nr_seq_ciclo in (SELECT b.nr_sequencia from rehu_ciclo b where b.nr_atendimento = nr_atendimento_p);
	delete FROM rehu_criopreservacao a where a.nr_seq_ciclo in (SELECT b.nr_sequencia from rehu_ciclo b where b.nr_atendimento = nr_atendimento_p);
	delete FROM rehu_embriao a where a.nr_seq_ciclo in (SELECT b.nr_sequencia from rehu_ciclo b where b.nr_atendimento = nr_atendimento_p);
	delete FROM rehu_transf_embriao a where a.nr_seq_ciclo in (SELECT b.nr_sequencia from rehu_ciclo b where b.nr_atendimento = nr_atendimento_p);
	delete FROM rehu_ciclo_exame a where a.nr_seq_ciclo in (SELECT b.nr_sequencia from rehu_ciclo b where b.nr_atendimento = nr_atendimento_p);
	delete FROM rehu_ciclo_termo a where a.nr_seq_ciclo in (SELECT b.nr_sequencia from rehu_ciclo b where b.nr_atendimento = nr_atendimento_p);
	delete FROM rehu_aspiracao a where a.nr_seq_ciclo in (SELECT b.nr_sequencia from rehu_ciclo b where b.nr_atendimento = nr_atendimento_p);
	delete FROM rehu_ciclo where nr_atendimento = nr_atendimento_p;
	delete FROM tasy_assinatura_lote where nr_atendimento = nr_atendimento_p;
	delete FROM eis_reinternacao_uti where nr_atendimento = nr_atendimento_p;
	update rehu_anexo set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	delete FROM parto_sorologia where nr_atendimento = nr_atendimento_p;
	delete FROM nascimento_amamentacao where nr_atendimento = nr_atendimento_p;
	delete FROM pep_med_fatur_envio where nr_atendimento = nr_atendimento_p;
  delete from med_paciente_atend where nr_atendimento = nr_atendimento_p;
	update cur_evolucao set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update anamnese_paciente set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update atend_prob_alta_hist_cont set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update cur_ferida set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	delete FROM enf_tri_obstetrica where nr_atendimento = nr_atendimento_p;
	update atend_sumario_alta set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update atendimento_checklist set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update pedido_exame_externo set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	delete FROM medic_diagnostico_doenca where nr_atendimento = nr_atendimento_p;
	delete FROM partograma where nr_atendimento = nr_atendimento_p;
	delete from cirurgia where nr_atendimento = nr_atendimento_p;
	delete from atendimento_sinal_vital where nr_atendimento = nr_atendimento_p;
	delete from pep_pac_ci where nr_atendimento = nr_atendimento_p;
	delete from med_avaliacao_paciente where nr_atendimento = nr_atendimento_p;
	delete from atend_paciente_auxiliar where nr_atendimento = nr_atendimento_p;
	delete from atendimento_alerta where nr_atendimento = nr_atendimento_p;
	delete from ATENDIMENTO_MONIT_RESP			where nr_atendimento = nr_atendimento_p;
	delete from ATEND_TIMI_RISK_SUPRA           where nr_atendimento = nr_atendimento_p;
	delete from ATEND_ESCALA_BRADEN             where nr_atendimento = nr_atendimento_p;
	delete from ATEND_ESCALA_INDICE             where nr_atendimento = nr_atendimento_p;
	delete from GCA_ATENDIMENTO                 where nr_atendimento = nr_atendimento_p;
	delete from EUROSCORE                       where nr_atendimento = nr_atendimento_p;
	delete from ATEND_PSI                       where nr_atendimento = nr_atendimento_p;
	delete from ATEND_RISCC                     where nr_atendimento = nr_atendimento_p;
	delete from ATEND_TIMI_RISK                 where nr_atendimento = nr_atendimento_p;
	delete from ATEND_ANAL_BIOQ_PORT            where nr_atendimento = nr_atendimento_p;
	delete from CPIS_ATENDIMENTO                where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_FRAMINGHAM               where nr_atendimento = nr_atendimento_p;
	delete from ATEND_BIOIMPEDANCIA             where nr_atendimento = nr_atendimento_p;
	delete from HIST_SAUDE_RECONCILIACAO        where nr_atendimento = nr_atendimento_p;
	delete from ATEND_ESCALA_BRADEN_Q           where nr_atendimento = nr_atendimento_p;
	delete from ATEND_NIH                       where nr_atendimento = nr_atendimento_p;
	delete from ATEND_AVAL_ANALGESIA            where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_SOFA                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_MODS                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_SAPS                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_SNAPII_SNAPPEII          where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_CRIB                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_PRISM                    where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_NAS                      where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_NTISS                    where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_PELOD                    where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_PIM2                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_GRACE                    where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_KATZ                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_AKIN                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_CAPURRO                  where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_IPPS                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_FRAMINGHAM_FA            where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_MIF                      where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_SAPS3                    where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_GOLDMAN                  where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_FLEBITE_INS              where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_CHILD_PUGH               where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_RANSON                   where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_APACHE_IV                where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_MAN                      where nr_atendimento = nr_atendimento_p;
	delete from ATEND_UROCOLOR                  where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_POSSUM                   where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_ECOG                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_MUST                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_ANSIEDADE_DEPRESSAO      where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_RANKIN                   where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_HUNT_HESS                where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_BARTHEL                  where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_AVEI                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_DINI                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_KARNOFSKY                where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_NFCS                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_RISCO_PULMONAR           where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_PALLIATIVE_PROG          where nr_atendimento = nr_atendimento_p;
	delete from ATEND_UROANALISE                where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_QUALIDADE_VIDA           where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_NBS                      where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_IDV                      where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_CHILD_TURCOTTE           where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_LEE                      where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_ACEF                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_RISCO_DELIRIUM           where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_ROCKALL                  where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_MAN_LF                   where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_EORTC                    where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_CANDIDA                  where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_STRONG_KIDS              where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_STROKE                   where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_KENDALL                  where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_CAM_ICU                  where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_TORONTO                  where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_MORSE                    where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_CHARLSON                 where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_ODI                      where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_APGAR                    where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_YESAVAGE                 where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_RAMSAY                   where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_KILLIP                   where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_MST                      where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_STEWART                  where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_CORMACK                  where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_DOWNTON                  where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_MASCC                    where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_CINCINNATI               where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_ASIS                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_RICHMOND                 where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_NRS                      where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_ISS                      where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_DURIE_SALMON             where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_TEV                      where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_EDMONTON                 where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_FLEBITE                  where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_RISCO_INSUF_RENAL        where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_RISCO_CARDIO_CIRURG      where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_PPS                      where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_KATZ_ORGINAL             where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_PROT_GORDURA             where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_WELLS                    where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_AGF                      where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_ASHWORTH                 where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_BAYLOR                   where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_HOUSE_BRACKMANN          where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_APFEL                    where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_STRATIFY                 where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_PIPER                    where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_BAL_HIDROGENADO          where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_GORDURA_CORPORAL         where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_LATCH                    where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_PEWS                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_FIQ                      where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_GMFM                     where nr_atendimento = nr_atendimento_p;
	delete from AVAL_NUTRICAO                   where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_RIFLE                    where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_MIRELS                   where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_ALDRETE                  where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_MOCA                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_BARROS                   where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_MUCOSITE                 where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_ICDSC                    where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_TOXIDADE                 where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_TENETTI                  where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_ASIA                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_SARA                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_SIST_NUTRICIONAL         where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_ASG_PPP                  where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_CRIB_II                  where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_MINI_MENTAL              where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_DN4                      where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_ROTHMAN                  where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_ANN_ARBOR                where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_CRB65                    where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_PIM3                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_SHIM                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_RISCO_CARDIACO           where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_CRUSADE                  where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_WAT                      where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_PELOD_II                 where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_EIF_II                   where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_EAT                      where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_AHA_ACC                  where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_CPIS_MOD                 where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_DAST                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_CGI                      where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_CLAVIEN                  where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_SADD                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_JANKOVIC                 where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_CAPURRO_NEURO            where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_FUJINAGA                 where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_BERG                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_CIWAA                    where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_MORRIS                   where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_FRAT                     where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_SEPSE                    where nr_atendimento = nr_atendimento_p;
	delete from ESCALA_TUG                      where nr_atendimento = nr_atendimento_p;
	delete from ATEND_URO_CHOICE                where nr_atendimento = nr_atendimento_p;
	delete from W_PEP_APAP                      where nr_atendimento = nr_atendimento_p;
	delete from WSUITE_RELATORIO                where nr_atendimento = nr_atendimento_p;
	delete from ATEND_PERDA_GANHO_CONTROLE      where nr_atendimento = nr_atendimento_p;
	delete from ATEND_CONTROLE_SINAL_VITAL      where nr_atendimento = nr_atendimento_p;
	delete from DISPOSITIVO_INTERV_SAE_ALT      where nr_atendimento = nr_atendimento_p;
	delete from W_GESTAO_SEPSIS_LAB             where nr_atendimento = nr_atendimento_p;
	update PE_PRESCRICAO			set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update PACIENTE_ALERGIA         set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update PACIENTE_HABITO_VICIO    set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update PACIENTE_MEDIC_USO       set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update PACIENTE_ANTEC_CLINICO   set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update ESCALA_AUDIT             set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update ESCALA_FARGESTROM        set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update PACIENTE_OCORRENCIA      set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update CIH_PAC_FAT_RISCO        set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update HISTORICO_SAUDE_CIRURGIA set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update W_EIS_ESCALA_DOR         set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update ESCALA_EPWORTH           set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update ESCALA_CHA2DS2VASC       set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update ESCALA_CHADS2            set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update ESCALA_HAS_BLED          set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update ESCALA_EARQ              set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update ESCALA_EIF               set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update ATEND_NERVO_PRODUTO      set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update ATENDIMENTO_TOXINA       set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update PE_PRESCR_IMAGEM         set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update TISS_INTERV_TERAPEUTICA  set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update ATEND_HIST_CHECAGEM_PDA  set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update EQUIPAMENTO_CIRURGIA     set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update MED_PAC_PRE_NATAL        set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update PEPO_CIRURGIA       		set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	delete from OFT_CONSULTA_MEDICA         where nr_atendimento = nr_atendimento_p;
	delete from ATEND_AVAL_SRPA             where nr_atendimento = nr_atendimento_p;
	CALL excluir_atend_precaucao(nr_atendimento_p);
	
	update	movimento_estoque
	set	nr_atendimento	 = NULL
	where	nr_atendimento	= nr_atendimento_p; /*Edilson em 09/01/2007 OS 47576 Falei com Fabio*/
	update	movimento_estoque a
	set	a.nr_prescricao	 = NULL
	where	exists (	SELECT	1
				from	prescr_medica b
				where	a.nr_prescricao	= b.nr_prescricao
				and	b.nr_atendimento	= nr_atendimento_p); /*Anderson 24/07/2007 OS63585 Atualizar os movimentos de estorno*/


	/* Rafael em 26/10/2007 OS72514 */

	delete	from prescr_mat_alteracao
	where	nr_prescricao in (	SELECT	nr_prescricao
					from	prescr_medica
					where	nr_atendimento = nr_atendimento_p);
	delete	from prescr_dieta_hor
	where	nr_prescricao in (	SELECT	nr_prescricao
					from	prescr_medica
					where	nr_atendimento = nr_atendimento_p);									
	/* Fim Rafael em 26/10/2007 OS72514 */

	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_seq_same_w
	from	same_prontuario
	where	nr_atendimento = nr_atendimento_p;
	
	if (nr_seq_same_w > 0) then
	
		delete from same_prontuario_hist where nr_seq_same = nr_seq_same_w;		
		delete from same_prontuario where nr_atendimento = nr_atendimento_p;
	
	end if;

	update mapa_dieta a
  	set a.nr_prescricao  = NULL
  	where exists (SELECT 1
                	from prescr_medica x
               	 	where x.nr_prescricao = a.nr_prescricao
                	and x.nr_atendimento = nr_atendimento_p);

  	update nut_atend_serv_prescr_aval a
  	set a.nr_prescricao  = NULL
  	where exists (SELECT 1
                	from prescr_medica x
                	where x.nr_prescricao = a.nr_prescricao
                	and x.nr_atendimento = nr_atendimento_p);

  	delete from nut_atend_serv_dia_rep a
  	where exists (SELECT 1 from  prescr_medica c
                	where c.nr_atendimento = nr_atendimento_p and (a.nr_prescr_compl = c.nr_prescricao or
                	a.nr_prescr_enteral = c.nr_prescricao or 
                	a.nr_prescr_jejum = c.nr_prescricao or
                	a.nr_prescr_oral = c.nr_prescricao or 
                	a.nr_prescr_leite_deriv = c.nr_prescricao or 
                	a.nr_prescr_npt_neo = c.nr_prescricao or 
                	a.nr_prescr_npt_ped = c.nr_prescricao));
	
	delete from processo_atendimento where nr_atendimento = nr_atendimento_p;
	delete from orcamento_paciente where nr_atendimento = nr_atendimento_p;
	delete from adiantamento where nr_atendimento = nr_atendimento_p;	
	update	prescr_medica set nr_seq_atecaco  = NULL	where nr_atendimento = nr_atendimento_p;
	delete from atend_categ_conv_hist where nr_atendimento = nr_atendimento_p;
	delete from atend_categoria_convenio where nr_atendimento = nr_atendimento_p;
	delete from atend_caucao where nr_atendimento = nr_atendimento_p;
	delete from procedimento_autorizado where nr_atendimento = nr_atendimento_p;
	delete from material_autorizado where nr_atendimento = nr_atendimento_p;
	delete from autorizacao_convenio where nr_atendimento = nr_atendimento_p;
	delete from conta_paciente where nr_atendimento = nr_atendimento_p;			
	delete from prescr_medica where nr_atendimento = nr_atendimento_p;
	delete from sus_laudo_paciente where nr_atendimento = nr_atendimento_p;
	delete from sus_aih where nr_atendimento = nr_atendimento_p;
	delete from titulo_receber where nr_atendimento = nr_atendimento_p;	
	delete from atend_paciente_unidade where nr_atendimento = nr_atendimento_p;
	delete from ehr_registro where nr_atendimento = nr_atendimento_p;
	delete from triagem_pronto_atend where nr_atendimento = nr_atendimento_p;
	delete from atendimento_indicacao where nr_atendimento = nr_atendimento_p;
	delete from obs_alta_hist where nr_atendimento = nr_atendimento_p;
	delete from w_pep_regra_informacao where nr_atendimento = nr_atendimento_p; -- Richart
	update atendimento_paciente set nr_seq_oftalmo  = NULL where nr_atendimento = nr_atendimento_p;
	delete from oft_consulta where nr_atendimento = nr_atendimento_p; -- Hinckel - 687208
	delete from W_GESTAO_ASSISTENCIAL where nr_atendimento = nr_atendimento_p; -- 1233975
	delete from recent_patients_found where nr_atendimento = nr_atendimento_p;
	delete from vacina_lista_espera where nr_atendimento = nr_atendimento_p;
	delete from consulta_reg_mentor where nr_seq_pend_pac in (	SELECT nr_sequencia
																from gqa_pendencia_pac  																
																where nr_atendimento = nr_atendimento_p);
	delete from GQA_PENDENCIA_PAC where nr_atendimento = nr_atendimento_p;
	delete from escala_mews where nr_atendimento = nr_atendimento_p;
	
	update	gestao_vaga			/*Anderson/Dalcastagne 24/07/2007 - OS63585*/
	set	nr_atendimento  = NULL
	where	nr_atendimento = nr_atendimento_p;

	update paciente_espera
	set nr_atendimento  = NULL
	where nr_atendimento = nr_atendimento_p;


	select 	max(a.ds_senha_internet)
	into STRICT	ds_senha_w
	from	atendimento_paciente a,
		atend_senha_internet b
	where	a.nr_atendimento 	= nr_atendimento_p
	and	a.nr_atendimento	= b.nr_atendimento;
	
	if 	((ds_senha_w IS NOT NULL AND ds_senha_w::text <> '') or (ds_senha_w  > 0 ))then
		CALL gerar_senha_internet(nr_atendimento_p, null, null, clock_timestamp(), ds_senha_w, 'EA');
	end if;
	
	
	cd_pessoa_fisica_w := substr(obter_pessoa_atendimento(nr_atendimento_p, 'C'),1,10);	
	
	select count(1)
	into STRICT ie_possui_atendimento_w
	from atendimento_paciente
	where nr_atendimento <> nr_atendimento_p
	and cd_pessoa_fisica = cd_pessoa_fisica_w;
	
	if (ie_possui_atendimento_w = 0) then
		ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || cd_pessoa_fisica_w || ds_sep_bv_w;
		CALL gravar_agend_integracao(428, ds_param_integ_hl7_w);
	end if;
	
	update	pre_venda_item
	set	nr_atendimento  = NULL,
		nr_prescricao  = NULL,
		nr_seq_interno  = NULL
	where	nr_atendimento = nr_atendimento_p;
	
	update	nom_cronicas set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update	nom_cron_visita set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update	nom_padrao_geral_saude set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update	nom_rc_cabecalho set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	delete	FROM causa_morte_fetal where nr_atendimento = nr_atendimento_p;
	delete	FROM complemento_mexico where nr_atendimento = nr_atendimento_p;
	
	update	farm_devolucao_movimento set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update	w_dev_material_processo set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update	fa_log_conferencia set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update	sup_lanc_cartao set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update	fa_paciente_entrega set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update	fa_receita_farmacia set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	delete from	w_execucao_proc_mat where nr_atendimento = nr_atendimento_p;
	update	ap_lote_agrupamento set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update	ap_lote set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update	ap_lote_log_agrup set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	delete from	dankia_disp_atend_paciente where nr_atendimento = nr_atendimento_p;
	delete from	dankia_disp_mat_hor where nr_atendimento = nr_atendimento_p;
	delete from	dankia_disp_transacao where nr_atendimento = nr_atendimento_p;
	
	update	ORDEM_COMPRA set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update	COT_COMPRA set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update	CM_REQUISICAO set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update	ORDEM_COMPRA_ITEM set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update	CM_CONJUNTO_CONT set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update	W_DEV_MATERIAL_PROCESSO set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	
	/*OS 2009056 - Tabelas Manutencao Hospitalar*/

	update	PRIVACY_REASON_HISTORY set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update	QUESTIONARIO_PACIENTE set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update	SAC_BOLETIM_OCORRENCIA set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update	COMUNIC_INTERNA set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update	QUA_AUDIT_PRONTUARIO set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update	QUA_AUDITORIA set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
		
	/*Tabelas Laboratorio OS 2010109*/

	update LOTE_ENT_SEC_FICHA            set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update EXAME_LAB_RESULTADO           set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	delete from FRASCO_PATO_LOC 	where nr_atendimento = nr_atendimento_p;
	/*Fim laboratorio*/
	
	
	/*Tabelas Oncologia OS 2010107*/

	update rxt_agenda               set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update agenda_quimio            set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update rxt_tumor                set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update paciente_atendimento     set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update eventos_adversos_registro set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update can_ordem_prod			 set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update anamnese_oncologia		 set nr_atendimento  = NULL	where nr_atendimento = nr_atendimento_p;
	update can_loco_regional		 set nr_atendimento  = NULL	where nr_atendimento = nr_atendimento_p;
	/*Fim oncologia*/


	
	/* Tabelas cadastro de pessoas OS 2009061*/

	update MPREV_PROGRAMA_PARTIC		set nr_atendimento_baixa  = NULL where nr_atendimento_baixa = nr_atendimento_p;
	update MPREV_PARTIC_CICLO_ITEM		set nr_atend_origem  = NULL where nr_atend_origem = nr_atendimento_p;
	update MPREV_ATEND_PACIENTE			set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update HDM_POP_ALVO_ATEND			set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	delete FROM HDM_POP_ALVO_DIAGNOSTICO		where nr_atendimento = nr_atendimento_p;
	update PACIENTE_TRATAMENTO			set nr_atend_origem  = NULL where nr_atend_origem = nr_atendimento_p;
	delete FROM MOTIVO_ISOLAMENTO_ATEND		where nr_atendimento = nr_atendimento_p;
	delete FROM CIH_FICHA_OCORRENCIA_HIST	where nr_atendimento = nr_atendimento_p;
	delete FROM CIH_CONTROLE_ATEND			where nr_atendimento = nr_atendimento_p;
	delete FROM CIH_CONTATO					where nr_atendimento = nr_atendimento_p;
	update NOTIFICACAO_SINAN			set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update ATEND_PAC_FUTURO				set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	delete FROM ATEND_PAC_FUTURO				where nr_atend_origem = nr_atendimento_p;
	update PRONTUARIO_ESTAB				set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update SAME_SOLIC_PRONT				set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update PRONTUARIO_CONTROLE			set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	
	/*Fim Cadastro de pessoas*/


	

	/*OS 2009062 - Tabelas contas a receber*/

	update	cheque_cr 				set nr_seq_atend_adiant  = NULL where nr_seq_atend_adiant = nr_atendimento_p;
	update	movto_cartao_cr 		set nr_seq_atend_adiant  = NULL where nr_seq_atend_adiant = nr_atendimento_p;
	delete	FROM atend_paciente_cartao	where nr_atendimento		 = nr_atendimento_p;
	update	cobranca_paciente_conta	set nr_atendimento		 = NULL where nr_atendimento		 = nr_atendimento_p;
	/*FIM OS 2009062 - Tabelas contas a receber*/


	
	/*Billing tables SO 2008933*/

	delete	FROM atend_medico_ambulatorial	where nr_atendimento = nr_atendimento_p;
	delete	FROM sus_apac			where nr_atendimento = nr_atendimento_p;
	delete	FROM sus_apac_movto			where nr_atendimento = nr_atendimento_p;
	delete	FROM sus_laudo_pac_aih_ws		where nr_atendimento = nr_atendimento_p;
	delete	FROM sus_apac_unif			where nr_atendimento = nr_atendimento_p;
	delete	FROM sus_aih_unif			where nr_atendimento = nr_atendimento_p;
	delete	FROM sus_bpa_unif			where nr_atendimento = nr_atendimento_p;
	delete	FROM sus_registro_civil		where nr_atendimento = nr_atendimento_p;
	delete	FROM sismama_atendimento		where nr_atendimento = nr_atendimento_p;
	delete	FROM siscolo_atendimento		where nr_atendimento = nr_atendimento_p;
	delete	FROM sus_terapia_nut			where nr_atendimento = nr_atendimento_p;
	delete	FROM sus_banco_leite_humano		where nr_atendimento = nr_atendimento_p;
	delete	FROM sus_laudo_trat_domicilio	where nr_atendimento = nr_atendimento_p;
	delete	FROM sus_valor_porte_proced		where nr_atendimento = nr_atendimento_p;
	delete	FROM sus_erro_imp_colmeia		where nr_atendimento = nr_atendimento_p;
	delete	FROM sus_conta_inco_colmeia		where nr_atendimento = nr_atendimento_p;
	delete	FROM sus_hist_envio_laudo_pac	where nr_atendimento = nr_atendimento_p;
	delete	FROM w_esus_atend_odontolog		where nr_atendimento = nr_atendimento_p;
	delete	FROM w_esus_zica_microcefalia	where nr_atendimento = nr_atendimento_p;
	delete	FROM w_esus_atend_domiciliar		where nr_atendimento = nr_atendimento_p;
	delete	FROM w_esus_visita_domiciliar	where nr_atendimento = nr_atendimento_p;
	delete	FROM esus_zica_microcefalia		where nr_atendimento = nr_atendimento_p;
	delete	FROM esus_cad_domiciliar		where nr_atendimento = nr_atendimento_p;
	delete	FROM esus_cad_individual		where nr_atendimento = nr_atendimento_p;
	delete	FROM esus_atend_individual		where nr_atendimento = nr_atendimento_p;
	delete	FROM esus_atend_odontolog		where nr_atendimento = nr_atendimento_p;
	delete	FROM esus_ficha_procedimento		where nr_atendimento = nr_atendimento_p;
	delete	FROM esus_marc_cons_aliment		where nr_atendimento = nr_atendimento_p;
	delete	FROM esus_visita_domiciliar		where nr_atendimento = nr_atendimento_p;
	delete	FROM esus_atend_domiciliar		where nr_atendimento = nr_atendimento_p;
	delete	FROM tiss_conta_atend		where nr_atendimento = nr_atendimento_p;
	update	medico_plantao			set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	update	repasse_terceiro_item		set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	/*End of Billing tables*/


	
	/* Insurance Billing (Fat Convenio) */

	CALL clear_encounter_billing_insur(nr_atendimento_P,'N');
	
	/* Clinical Order */

	CALL clear_encounter_clinical_order(nr_atendimento_p, 'N');
	
	/*OS 2009062 - Fiscal*/

	update	nota_fiscal_item 		set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	
	update	tempo_senha_atend set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	
	if (coalesce(cd_pessoa_fisica_w,0) <> 0 ) then
		update atendimento_paciente_anexo set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	else
		delete FROM atendimento_paciente_anexo where nr_atendimento = nr_atendimento_p;
	end if;	
	
	select	max(cd_pessoa_fisica)
	into STRICT	cd_pessoa_fisica_ww
	from	ATEND_ACHADO_PERDIDO
	where	nr_atendimento = nr_Atendimento_p;
	
	if (cd_pessoa_fisica_ww IS NOT NULL AND cd_pessoa_fisica_ww::text <> '') then
		update	atend_achado_perdido
		set		nr_Atendimento  = NULL
		where	nr_Atendimento = nr_Atendimento_p
		and		(cd_pessoa_fisica IS NOT NULL AND cd_pessoa_fisica::text <> '');
	else
		update	atend_achado_perdido
		set		nr_atendimento  = NULL,
				cd_pessoa_fisica  = NULL		
		where	cd_pessoa_fisica = cd_pessoa_fisica_w;
	end if;
	
	delete FROM acompanhante_visita_lib 		where nr_atendimento = nr_atendimento_p;
	delete FROM atend_doacao 				where nr_atendimento = nr_atendimento_p;
	delete FROM atend_profissional 			where nr_atendimento = nr_atendimento_p;
	delete FROM atend_documentacao 			where nr_atendimento = nr_atendimento_p;
	delete FROM atend_pac_servico 			where nr_atendimento = nr_atendimento_p;
	delete FROM w_inconsistencia_censo 		where nr_atendimento = nr_atendimento_p;
	delete FROM atend_ajuste_visita 			where nr_atendimento = nr_atendimento_p;
	delete FROM atend_tempo_real 			where nr_atendimento = nr_atendimento_p;
	delete FROM atend_observacao_visita 		where nr_atendimento = nr_atendimento_p;
	delete FROM etiqueta_controle_atend 		where nr_atendimento = nr_atendimento_p;
	delete FROM atend_paciente_sac 			where nr_atendimento = nr_atendimento_p;
	delete FROM dados_funeraria_atend 		where nr_atendimento = nr_atendimento_p;
	delete FROM atendimento_visita_lib		where nr_atendimento = nr_atendimento_p;
	delete FROM atend_paciente_prob_alta 	where nr_atendimento = nr_atendimento_p;
	delete FROM w_inconsistencias_atend 		where nr_atendimento = nr_atendimento_p;
	delete FROM atendimento_visita_bloq 		where nr_atendimento = nr_atendimento_p;
	delete FROM w_gestao_vaga_proc 			where nr_atendimento = nr_atendimento_p;
	delete FROM atendimento_solic_transf 	where nr_atendimento = nr_atendimento_p;
	delete FROM deslocamento_paciente 		where nr_atendimento = nr_atendimento_p;
	delete FROM atend_dados_retirada 		where nr_atendimento = nr_atendimento_p;
	delete FROM probabilidade_alta_setor 	where nr_atendimento = nr_atendimento_p;
	delete FROM solic_transf_externa 		where nr_atendimento = nr_atendimento_p;
	delete FROM atendimento_hist_paciente 	where nr_atendimento = nr_atendimento_p;
	delete FROM atend_paciente_dado_obito 	where nr_atendimento = nr_atendimento_p;
	delete FROM atend_tipo_item_dado 		where nr_atendimento = nr_atendimento_p;
	delete FROM atendimento_acomp_bloq 		where nr_atendimento = nr_atendimento_p;
	delete FROM aghos_contigencia_mov 		where nr_atendimento = nr_atendimento_p;
	delete FROM atend_prob_alta_hist 		where nr_atendimento = nr_atendimento_p;
	delete FROM atend_pac_servico_conta 		where nr_atendimento = nr_atendimento_p;
	delete FROM w_imagem_dor_qep 			where nr_atendimento = nr_atendimento_p;
	delete FROM atend_regra_sms 				where nr_atendimento = nr_atendimento_p;
	delete FROM atendimento_psiquiatrico 	where nr_atendimento = nr_atendimento_p;
	delete FROM atend_paciente_sisreg 		where nr_atendimento = nr_atendimento_p;
	delete FROM entrega_laudo_atend			where nr_atend_origem = nr_atendimento_p or nr_atend_adicional = nr_atendimento_p;
	delete FROM movimentacao_assistida		where nr_atendimento = nr_atendimento_p;
	delete FROM atend_paciente_log_bio		where nr_atendimento = nr_atendimento_p;
	delete FROM atendimento_servico			where nr_atendimento = nr_atendimento_p;
	delete FROM paciente_lista_atendimento	where nr_atendimento = nr_atendimento_p;
	delete FROM atend_lanc_auto				where nr_atendimento = nr_atendimento_p;
	delete FROM que_atendimento				where nr_atendimento = nr_atendimento_p;
	delete FROM atend_alta_especial			where nr_atendimento = nr_atendimento_p;
	delete FROM atestado_paciente			where nr_atendimento = nr_atendimento_p;
	
	update unidade_atendimento set nr_atendimento  = NULL where nr_atendimento = nr_atendimento_p;
	
	select	count(1)
	into STRICT	qt_registros_w
	from	gerint_solic_internacao
	where	nr_atendimento = nr_atendimento_p;
	
	if (qt_registros_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1096776); -- Atendimento possui registro de integracao GERINT e por isso nao sera possivel exclui-lo
	end if;
	
	select	count(1)
	into STRICT	qt_registros_w
	from	gerint_evento_integracao
	where	nr_atendimento = nr_atendimento_p;
	
	if (qt_registros_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1096776); -- Atendimento possui registro de integracao GERINT e por isso nao sera possivel exclui-lo
	end if;
	
	select	count(1)
	into STRICT	qt_registros_w
	from	regulacao_atendimento
	where	nr_atendimento = nr_atendimento_p;
	
	if (qt_registros_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1096777); -- Atendimento possui registro de integracao com sistemas SUS e por isso nao sera possivel exclui-lo
	end if;
	
	select	count(1)
	into STRICT	qt_registros_w
	from	declaracao_obito
	where	nr_atendimento = nr_atendimento_p;
	
	if (qt_registros_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1096778); -- Atendimento possui uma declaracao de obito e por isso nao sera possivel exclui-lo
	end if;

  delete from SMART_ALERT_REGRA_ATEND where nr_atendimento = nr_atendimento_p;
  	delete from atendimento_paciente_aux where nr_atendimento = nr_atendimento_p;
	
	delete	from atendimento_paciente_inf
	where	nr_atendimento	= nr_atendimento_p;
		
	delete from atendimento_paciente where nr_atendimento = nr_atendimento_p;

	if (coalesce(wheb_usuario_pck.get_ie_commit,'S') = 'S') then
		commit;
	end if;

	select	count(1)
	into STRICT	qt_existe_w
	from	atendimento_paciente
	where	nr_atendimento	= nr_atendimento_p;
	
	if (qt_existe_w = 0) then
/*		insert into log_exclusao values('ATENDIMENTO_PACIENTE', sysdate, 
			nm_usuario_p, 'Atendimento : ' || nr_atendimento_p ||
			' prontuario: ' || nr_prontuario_w || ' paciente: ' || nm_paciente_w);*/
		if (ds_justificativa_w IS NOT NULL AND ds_justificativa_w::text <> '') then
			CALL gravar_log_exclusao('ATENDIMENTO_PACIENTE', nm_usuario_p,
					WHEB_MENSAGEM_PCK.get_texto(279918,'NR_ATENDIMENTO='|| nr_atendimento_p||';DT_ENTRADA='|| to_char(dt_entrada_w,'dd/mm/yyyy hh24:mi:ss')||';NR_PRONTUARIO='|| nr_prontuario_w||';NM_PACIENTE='|| nm_paciente_w||';DS_JUSTIFICATIVA='|| ds_justificativa_w),'N');
		else
			CALL gravar_log_exclusao('ATENDIMENTO_PACIENTE', nm_usuario_p,
					WHEB_MENSAGEM_PCK.get_texto(279918,'NR_ATENDIMENTO='|| nr_atendimento_p||';DT_ENTRADA='|| to_char(dt_entrada_w,'dd/mm/yyyy hh24:mi:ss')||';NR_PRONTUARIO='|| nr_prontuario_w||';NM_PACIENTE='|| nm_paciente_w||';DS_JUSTIFICATIVA='|| ds_justificativa_w) ,'N');
		end if;
		
		if (coalesce(wheb_usuario_pck.get_ie_commit,'S') = 'S') then
			commit;
		end if;
	end if;

	end;
end if;
ds_erro_p			:= ds_erro_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE excluir_atendimento ( nr_atendimento_p bigint, ie_consiste_p text, nm_usuario_p text, ds_justificativa_p text, ds_erro_p out text) IS ds_erro_w varchar(255) FROM PUBLIC;

