-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ageint_excluir_em_agendamento ( dt_agenda_p timestamp, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_ageint_w		bigint;
nr_seq_ageint_item_w	bigint;
cd_pessoa_fisica_w	varchar(10);
nr_seq_ageint_lib_w	bigint;
nm_tabela_w				INTEGRIDADE_REFERENCIAL.NM_TABELA%TYPE;
nm_integridade_ref_w	INTEGRIDADE_REFERENCIAL.NM_INTEGRIDADE_REFERENCIAL%TYPE;
ds_contraint_name_w		varchar(255);
ds_comando_w			varchar(4000);
ie_obrigatorio_W		varchar(3);
nm_Atributo_W			varchar(90);
dt_agenda_w			varchar(40);
			
C01 CURSOR FOR 
	SELECT	a.nr_sequencia, 
		a.cd_pessoa_fisica 
	from	agenda_integrada a 
	where	a.dt_inicio_agendamento between trunc(dt_agenda_p) and trunc(dt_agenda_p) + 86399/86400 
	and	coalesce(a.dt_fim_agendamento::text, '') = '' 
	and	a.nr_seq_status in (	SELECT 	b.nr_sequencia 
					from 	agenda_integrada_status b 
					where 	b.ie_status_tasy = 'EA' 
					and 	coalesce(b.ie_situacao,'A') = 'A') 
	and	not exists(select	1 
			  from 	agenda_integrada_item x 
			  where	x.nr_seq_agenda_int = a.nr_sequencia 
			  and		((x.nr_seq_agenda_cons IS NOT NULL AND x.nr_seq_agenda_cons::text <> '') or (x.nr_seq_agenda_exame IS NOT NULL AND x.nr_seq_agenda_exame::text <> ''))) 
	and	not exists (select 	1 
			  from		orcamento_paciente y 
			  where	y.nr_seq_ageint = a.nr_sequencia);

C02 CURSOR FOR 
	SELECT	nr_sequencia 
	from	agenda_integrada_item 
	where	nr_seq_agenda_int	= nr_seq_Ageint_w 
	order by 1;
	
C03 CURSOR FOR 
	SELECT	nr_sequencia 
	from	ageint_lib_usuario 
	where	nr_seq_Ageint_item	= nr_seq_ageint_item_w 
	order by 1;
	
C04 CURSOR FOR 
	SELECT	b.nm_tabela, 
		b.nm_integridade_referencial, 
		c.nm_Atributo, 
		coalesce(d.ie_obrigatorio,'N') 
	from	tabela_sistema a, 
		integridade_referencial b, 
		integridade_Atributo c, 
		tabela_Atributo d 
	where	a.nm_tabela = b.nm_tabela_referencia 
	and	b.nm_integridade_Referencial = c.nm_integridade_referencial 
	and	d.nm_tabela = b.nm_tabela 
	and	d.nm_Atributo = c.nm_Atributo 
	and	upper(b.nm_tabela) <> 'ORCAMENTO_PACIENTE' 
	and	upper(a.nm_tabela) = upper('AGENDA_INTEGRADA') 
	order by 1;	
			 

BEGIN 
 
dt_agenda_w	:= to_char(dt_Agenda_p,'dd/mm/yyyy');
 
open C01;
loop 
fetch C01 into	 
	nr_seq_ageint_w, 
	cd_pessoa_fisica_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	begin 
	open C02;
	loop 
	fetch C02 into	 
		nr_seq_ageint_item_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		delete	FROM AGEINT_EQUIP_ITEM 
		where	nr_seq_Agenda_item	= nr_seq_Ageint_item_w;
		 
		delete	FROM AGEINT_EXAME_ADIC_ITEM 
		where	nr_seq_item	= nr_seq_ageint_item_w;
		 
		delete	FROM AGEINT_EXAME_ASSOCIADO 
		where	nr_seq_ageint_item	= nr_seq_ageint_item_w;
		 
		delete	FROM AGEINT_ITENS_ADICIONAIS 
		where	nr_seq_ageint_item	= nr_seq_ageint_item_w;
		 
		open C03;
		loop 
		fetch C03 into	 
			nr_seq_ageint_lib_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin 
		 
			delete FROM AGEINT_HORARIOS_USUARIO 
			where	nr_seq_ageint_lib	= nr_seq_ageint_lib_w;
		 
			delete	FROM AGEINT_LIB_USUARIO 
			where	nr_sequencia		= nr_seq_ageint_lib_w;
		 
			end;
		end loop;
		close C03;
				 
		delete	FROM AGEINT_VALOR_HIST 
		where	nr_seq_Ageint_item	= nr_seq_ageint_item_w;
		 
		delete	FROM AGENDA_INTEGRADA_CONV_ITEM 
		where	nr_seq_Agenda_item	= nr_seq_Ageint_item_w;
		 
		delete	FROM AGENDA_PAC_DESC_MATERIAL 
		where	nr_seq_item	= nr_seq_ageint_item_w;
		 
		delete	FROM AGENDA_PAC_OPME 
		where	nr_seq_item	= nr_seq_Ageint_item_w;
				 
		delete	FROM AGENDA_PAC_SANGUE 
		where	nr_seq_item	= nr_seq_ageint_item_w;	
	 
		delete	FROM AGENDA_PAC_OPME 
		where	nr_seq_item	= nr_seq_ageint_item_w;
	 
		delete	FROM ageint_medico_item 
		where	nr_seq_item	= nr_seq_ageint_item_w;
		 
		delete	FROM agenda_integrada_prof_item 
		where	nr_seq_agenda_item	= nr_seq_ageint_item_w;
		 
		delete	FROM ageint_marcacao_usuario 
		where	nr_seq_ageint_item	= nr_seq_ageint_item_w;
		 
		delete	FROM agenda_integrada_item 
		where	nr_sequencia	= nr_seq_ageint_item_w;
		end;
	end loop;
	close C02;
	 
	open C04;
	loop 
	fetch C04 into	 
		nm_tabela_w, 
		nm_integridade_ref_w, 
		nm_Atributo_W, 
		ie_obrigatorio_W;		
	EXIT WHEN NOT FOUND; /* apply on C04 */
		begin 
		ds_comando_w := '';
		if (ie_obrigatorio_w	= 'N') then 
			ds_comando_w := ' 	update	' || nm_tabela_w || ' 
						set	' || nm_Atributo_W || ' = null 
						where	' || nm_Atributo_W || ' in (	select	a.nr_sequencia																					 
												from	agenda_integrada a 
												where	a.dt_inicio_agendamento between trunc(to_date('''|| dt_agenda_w ||''',''dd/mm/yyyy hh24:mi:ss'')) and trunc(to_date('''|| dt_agenda_w ||''',''dd/mm/yyyy hh24:mi:ss'')) + 86399/86400 
												and	a.dt_fim_agendamento is null 
												and	a.nr_seq_status in (	select 	b.nr_sequencia 
																from 	agenda_integrada_status b 
																where 	b.ie_status_tasy = ''EA'' 
																and 	nvl(b.ie_situacao,''A'') = ''A'') 
												and	not exists(	select	1 
															from 	agenda_integrada_item x 
															where	x.nr_seq_agenda_int = a.nr_sequencia 
															and	((x.nr_seq_agenda_cons is not null) or (x.nr_seq_agenda_exame is not null))) 
												and	not exists(	select 	1 
															from	orcamento_paciente y 
															where	y.nr_seq_ageint = a.nr_sequencia)) ';
		else 
			ds_comando_w := ' 	delete	' || nm_tabela_w || ' 
						where	' || nm_Atributo_W || ' in (	select	a.nr_sequencia																					 
												from	agenda_integrada a 
												where	a.dt_inicio_agendamento between trunc(to_date('''|| dt_agenda_w ||''',''dd/mm/yyyy hh24:mi:ss'')) and trunc(to_date('''|| dt_agenda_w ||''',''dd/mm/yyyy hh24:mi:ss'')) + 86399/86400 
												and	a.dt_fim_agendamento is null 
												and	a.nr_seq_status in (	select 	b.nr_sequencia 
																from 	agenda_integrada_status b 
																where 	b.ie_status_tasy = ''EA'' 
																and 	nvl(b.ie_situacao,''A'') = ''A'') 
												and	not exists(	select	1 
															from 	agenda_integrada_item x 
															where	x.nr_seq_agenda_int = a.nr_sequencia 
															and	((x.nr_seq_agenda_cons is not null) or (x.nr_seq_agenda_exame is not null))) 
												and	not exists(	select 	1 
															from	orcamento_paciente y 
															where	y.nr_seq_ageint = a.nr_sequencia)) ';															
		end if;
 
		--Ageint_Gravar_Log_Exclusao(substr(ds_comando_w,1,4000),nm_usuario_p); 
		 
		CALL Exec_sql_Dinamico('AGEINT_EXCLUIR_EM_AGENDAMENTO', ds_comando_w);				
						 
		 
		end;
	end loop;
	close C04;
	 
	delete	FROM pessoa_documentacao 
	where	nr_seq_ageint	= nr_seq_ageint_w;
 
	delete	FROM AGEINT_OBSERVACAO_FINAL 
	where	nr_seq_Ageint	= nr_Seq_Ageint_w;
	 
	delete	FROM AGEINT_CHECK_LIST_PACIENTE 
	where	nr_seq_Ageint	= nr_seq_ageint_w;
	 
	delete	FROM AGENDA_INTEGRADA_RESUMO 
	where	nr_seq_Ageint	= nr_seq_Ageint_w;
 
	delete	FROM ageint_proc_pacote 
	where	nr_seq_ageint	= nr_seq_ageint_w;
	 
	delete	FROM MED_AVALIACAO_PACIENTE 
	where	nr_seq_ageint	= nr_seq_ageint_w;
 
	delete	FROM ageint_arq_anexo_email 
	where	nr_seq_agenda_int = nr_seq_ageint_w;
	 
	delete	FROM agenda_integrada 
	where	nr_sequencia 	= nr_seq_ageint_w;
 
	delete FROM w_inconsistencia_ageint 
	where	nr_seq_ageint 	= nr_seq_ageint_w;
 
	 
	exception 
		when others then 
		CALL Ageint_Gravar_Log_Exclusao(wheb_mensagem_pck.get_texto(791308,'nr_seq_ageint='||nr_seq_ageint_w||';cd_pessoa_fisica='||cd_pessoa_fisica_w||';sqlerrm='||sqlerrm||';ds_comando='||ds_comando_w),nm_usuario_p);
	end;
	 
	end;
	 
	 
	 
end loop;
close C01;
 
delete	FROM agenda_controle_horario 
where	dt_agenda < clock_timestamp() - interval '1 days';
 
delete from ageint_medico_item a 
where not exists (	SELECT	1 
			from	agenda_integrada_item b 
			where	b.nr_sequencia	= a.nr_seq_item);
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageint_excluir_em_agendamento ( dt_agenda_p timestamp, nm_usuario_p text) FROM PUBLIC;

