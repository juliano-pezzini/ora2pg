-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_email_proc_executado ( nr_atendimento_p bigint, cd_estabelecimento_p bigint, cd_setor_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ds_titulo_w		varchar(255);
ds_mensagem_w		varchar(2500);
ds_email_origem_w	varchar(255);
cd_pessoa_fisica_w	varchar(15);
ds_email_destino_w	varchar(255);
ds_paciente_w		varchar(100);
qt_existe_w		bigint;
ie_tipo_atendimento_w	smallint;
qt_limite_w		smallint;
ie_fora_limite_w	varchar(1):= 'N';
qt_envio_atend_dia_w	bigint;
ds_convenio_w		convenio.ds_convenio%type;
ds_medico_atendimento_w		pessoa_fisica.nm_pessoa_fisica%type;
dt_nascimento_w		pessoa_fisica.dt_nascimento%type;

C01 CURSOR FOR	 
	SELECT	ds_titulo, 
      ds_mensagem, 
      coalesce(ds_email_origem,'X'), 
      coalesce(qt_limite,999) 
	from	texto_satisf_atend 
	where	cd_estabelecimento = cd_estabelecimento_p 
	and 	coalesce(cd_setor_atendimento, coalesce(cd_setor_atendimento_p,0)) = coalesce(cd_setor_atendimento_p,0) 
	and 	coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w,0)) = coalesce(ie_tipo_atendimento_w,0) 
	order by coalesce(cd_setor_atendimento,0), 
		coalesce(ie_tipo_atendimento,0);


BEGIN 
 
ie_fora_limite_w	:= 'N';
qt_envio_atend_dia_w	:= 0;
 
select	count(*) 
into STRICT	qt_existe_w 
from	texto_satisf_atend 
where	cd_estabelecimento = cd_estabelecimento_p;
 
if (qt_existe_w > 0) then 
 
	select	max(cd_pessoa_fisica), 
      max(ie_tipo_atendimento) 
	into STRICT	cd_pessoa_fisica_w, 
      ie_tipo_atendimento_w 
	from	atendimento_paciente 
	where	nr_atendimento = nr_atendimento_p;
 
 
	open C01;
	loop 
	fetch C01 into	 
		ds_titulo_w, 
		ds_mensagem_w, 
		ds_email_origem_w, 
		qt_limite_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		ds_titulo_w		  := ds_titulo_w;
		ds_mensagem_w		:= ds_mensagem_w;
		ds_email_origem_w	:= ds_email_origem_w;
		qt_limite_w		  := qt_limite_w;
		end;
	end loop;
	close C01;
	 
  /*  
	select 	count(*) 
	into	qt_envio_atend_dia_w 
	from 	w_envio_atend 
  where 	nr_atendimento = nr_atendimento_p   
	and 	trunc(dt_envio) = trunc(sysdate); 
  */
 
  select count(1) 
  into STRICT  qt_envio_atend_dia_w 
  from  w_envio_atend      b, 
      atendimento_paciente  c 
  where  b.nr_atendimento  = c.nr_atendimento 
  and 	trunc(dt_envio)   = trunc(clock_timestamp()) 
  and   c.cd_pessoa_fisica = cd_pessoa_fisica_w;
   
   
	if (qt_envio_atend_dia_w >= qt_limite_w) then 
		ie_fora_limite_w:= 'S';
	end if;
	 
	if (ds_email_origem_w = 'X') then 
		select	max(obter_dados_usuario_opcao(nm_usuario_p,'E')) 
		into STRICT	ds_email_origem_w 
		;
	end if;	
 
	select	max(obter_compl_pf(cd_pessoa_fisica_w, 1, 'M')), 
		max(substr(obter_nome_pf(cd_pessoa_fisica_w),1,100)) 
	into STRICT	ds_email_destino_w, 
		ds_paciente_w 
	;
 
	if (coalesce(ds_email_destino_w::text, '') = '') then 
	 
		select	max(obter_compl_pf(cd_pessoa_fisica_w, 3, 'M')) 
		into STRICT	ds_email_destino_w 
		;
		 
	end if;	
	 
	select 	substr(coalesce(ds_convenio,''),1,255) 
	into STRICT	ds_convenio_w 
	from 	convenio 
	where	cd_convenio = obter_convenio_atendimento(nr_atendimento_p);
	 
	select dt_nascimento 
	into STRICT dt_nascimento_w 
	from pessoa_fisica 
 where cd_pessoa_fisica = cd_pessoa_fisica_w;
	 
	select 	substr(coalesce(obter_nome_pf(cd_pessoa_fisica),''),1,60) 
	into STRICT	ds_medico_atendimento_w 
	from  	pessoa_fisica 
	where 	cd_pessoa_fisica = (	SELECT	cd_medico_resp 
					from	atendimento_paciente 
					where	nr_atendimento = nr_atendimento_p 
					);
	 
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w, '@NOME', ds_paciente_w),1,2500);
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w, '@CONVENIO', ds_convenio_w),1,2500);
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w, '@MEDICO_ATENDIMENTO', ds_medico_atendimento_w),1,2500);
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w, '@DT_NASCIMENTO', dt_nascimento_w ),1,2500);
	ds_mensagem_w := substr(replace_macro(ds_mensagem_w, '@NR_ATENDIMENTO', nr_atendimento_p ),1,2500);	
	 
   
	if (ds_email_destino_w IS NOT NULL AND ds_email_destino_w::text <> '') and (ie_fora_limite_w = 'N') then 
		 
   CALL enviar_email(ds_titulo_w, ds_mensagem_w, ds_email_origem_w, ds_email_destino_w, nm_usuario_p, 'M');
		insert into w_envio_atend(nr_sequencia, 
				dt_atualizacao, 
				nm_usuario, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				dt_envio, 
				nr_atendimento) 
			values (nextval('w_envio_atend_seq'), 
				clock_timestamp(), 
				nm_usuario_p, 
				clock_timestamp(), 
				nm_usuario_p, 
				clock_timestamp(), 
				nr_atendimento_p);
	end if;
	 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_email_proc_executado ( nr_atendimento_p bigint, cd_estabelecimento_p bigint, cd_setor_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

