-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--
-- dblink wrapper to call function ish_send_kv_insurance as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE PROCEDURE ish_send_kv_insurance (( nr_seq_interno_p atend_categoria_convenio.nr_seq_interno%type, reg_integracao_p INOUT gerar_int_padrao.reg_integracao, nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_prioridade_p atend_categoria_convenio.nr_prioridade%type, cd_convenio_p atend_categoria_convenio.cd_convenio%type) is reg_integracao_w gerar_int_padrao.reg_integracao) AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

	v_ret	ATEND_CATEGORIA_CONVENIO.NR_PRIORIDADE%TYPE;
BEGIN
	v_query := 'SELECT * FROM ish_send_kv_insurance_atx ( ' || quote_nullable(nr_seq_interno_p) || ',' || quote_nullable(reg_integracao_p) || ',' || quote_nullable(nr_atendimento_p) || ',' || quote_nullable(nr_prioridade_p) || ',' || quote_nullable(cd_convenio_p) || ' )';
	SELECT * INTO v_ret FROM dblink(v_conn_str, v_query) AS p (ret ATEND_CATEGORIA_CONVENIO.NR_PRIORIDADE%TYPE);
	RETURN v_ret;

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE PROCEDURE ish_send_kv_insurance_atx (( nr_seq_interno_p atend_categoria_convenio.nr_seq_interno%type, reg_integracao_p INOUT gerar_int_padrao.reg_integracao, nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_prioridade_p atend_categoria_convenio.nr_prioridade%type, cd_convenio_p atend_categoria_convenio.cd_convenio%type) is reg_integracao_w gerar_int_padrao.reg_integracao) AS $body$
DECLARE

nr_prioridade_w	atend_categoria_convenio.nr_prioridade%type;
BEGIN
	select  min(acc.nr_prioridade)
	into STRICT    nr_prioridade_w
	from    atend_categoria_convenio acc
	where   acc.nr_atendimento = nr_atendimento_p;

	return;
end;

begin

if (gerar_int_padrao.get_executando_recebimento = 'N') then
	begin
	
	select 	coalesce(max('S'),'N'),
			max(cd_pessoa_fisica),
			max(nr_seq_episodio)
	into STRICT	ie_kv_w,
			cd_pessoa_fisica_w,
			nr_seq_episodio_w
	from    atendimento_paciente ap,
			tipo_admissao_fat taf
	where   ap.nr_atendimento = nr_atendimento_p
	and     taf.nr_sequencia = ap.nr_seq_tipo_admissao_fat
	and     taf.ie_tipo_kv = 'S';

	nr_prioridade_w := get_min_priority_cat_convenio(nr_atendimento_p);

	if (ie_kv_w = 'S' and nr_prioridade_p <= nr_prioridade_w) then

		reg_integracao_w := reg_integracao_p;
		reg_integracao_w.ie_operacao := 'I';
		reg_integracao_w.cd_pessoa_fisica := cd_pessoa_fisica_w;
		
		reg_integracao_w.nr_seq_agrupador	:= nr_atendimento_p;
		reg_integracao_w.nr_atendimento		:= nr_atendimento_p;
		
		nr_seq_documento_w := nr_atendimento_p || ds_separador_w || nr_seq_interno_p || ds_separador_w || nr_seq_episodio_w;
				
		if (ish_rzv_insurance_pck.get_se_conv_integrado_case(nr_seq_episodio_w, cd_convenio_p) = 'S') then
			reg_integracao_w.ie_operacao	:= 'A';
		end if;

		reg_integracao_w.ie_trocar_convenio := 'S';
		reg_integracao_w := gerar_int_padrao.gravar_integracao('135', nr_seq_documento_w, obter_usuario_ativo, reg_integracao_w);
		reg_integracao_w.ie_trocar_convenio := 'N';
	end if;

	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ish_send_kv_insurance (( nr_seq_interno_p atend_categoria_convenio.nr_seq_interno%type, reg_integracao_p INOUT gerar_int_padrao.reg_integracao, nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_prioridade_p atend_categoria_convenio.nr_prioridade%type, cd_convenio_p atend_categoria_convenio.cd_convenio%type) is reg_integracao_w gerar_int_padrao.reg_integracao) FROM PUBLIC; -- REVOKE ALL ON PROCEDURE ish_send_kv_insurance_atx (( nr_seq_interno_p atend_categoria_convenio.nr_seq_interno%type, reg_integracao_p INOUT gerar_int_padrao.reg_integracao, nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_prioridade_p atend_categoria_convenio.nr_prioridade%type, cd_convenio_p atend_categoria_convenio.cd_convenio%type) is reg_integracao_w gerar_int_padrao.reg_integracao) FROM PUBLIC;

