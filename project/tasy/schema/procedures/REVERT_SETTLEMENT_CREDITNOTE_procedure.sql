-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE revert_settlement_creditnote ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


vl_value_w 		double precision;
nr_sequencia_w		bigint;
nr_titulo_w		bigint;
nr_sequencia_ww		bigint;
cd_tipo_recebimento_w 	bigint;
cd_moeda_padrao_w 	bigint;
nr_seq_trans_fin_baixa_w bigint;


BEGIN
	select	max(nr_sequencia)
	into STRICT	nr_sequencia_w
	from	nf_credito
	where	nr_seq_nf_gerada = nr_sequencia_p;
	
	if (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') then
	
		select	max(b.nr_titulo)
		into STRICT	nr_titulo_w
		from	nf_credito a,titulo_receber b
		where 	a.nr_seq_nf_gerada = nr_sequencia_p
		and 	b.nr_seq_nf_saida = a.nr_seq_nf_orig;
	
		select	sum(vl_aplicacao)
		into STRICT	vl_value_w
		from	nf_credito_item
		where 	nr_seq_nf_credito = nr_sequencia_w;
		
		select 	max(nr_sequencia)
		into STRICT 	nr_sequencia_ww
		from	titulo_receber_liq
		where	nr_titulo = nr_titulo_w;
		
		select	max(cd_tipo_recebimento)
		into STRICT 	cd_tipo_recebimento_w
		from 	tipo_recebimento
		where 	ie_tipo_consistencia  = 12
		and 	ie_situacao = 'A';

		select	max(cd_moeda_padrao),
			max(nr_seq_trans_fin_baixa)
		into STRICT 	cd_moeda_padrao_w,
			nr_seq_trans_fin_baixa_w
		from 	parametro_contas_receber
		where 	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

		if (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then
			insert into
			titulo_receber_liq( 	nr_titulo,
						nr_sequencia,
						dt_recebimento,
						vl_recebido,
						vl_descontos,
						vl_juros,
						vl_multa,
						cd_moeda,
						dt_atualizacao,
						nm_usuario,
						cd_tipo_recebimento,
						ie_acao,
						vl_rec_maior,
						vl_glosa,
						ie_lib_caixa,
						vl_nota_credito,
						nr_seq_trans_fin)
				values ( 	nr_titulo_w,
						nr_sequencia_ww+1,
						clock_timestamp(),
						0,
						0,
						0,
						0,
						cd_moeda_padrao_w,
						clock_timestamp(),
						nm_usuario_p,
						cd_tipo_recebimento_w,
						'E',
						0,
						0,
						'S',
						vl_value_w*-1,
						nr_seq_trans_fin_baixa_w);
						
			CALL Atualizar_Saldo_Tit_Rec(nr_titulo_w, nm_usuario_p);
		
		end if;
		
	end if;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE revert_settlement_creditnote ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

