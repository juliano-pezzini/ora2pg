-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_prot_medicamento ( cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_protocolo_p bigint, nr_seq_protocolo_p bigint, nr_seq_produto_p bigint, nr_atendimento_p bigint, cd_paciente_p text, cd_prescritor_p text, cd_setor_atendimento_p bigint, nr_seq_agrupamento_p bigint, qt_idade_dia_p bigint, qt_idade_mes_p bigint, qt_idade_ano_p bigint, qt_peso_p bigint, nr_seq_item_gerado_p INOUT cpoe_material.nr_sequencia%type, nr_seq_pend_pac_acao_p bigint default null, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, ie_oncologia_p text default 'N', nr_seq_conclusao_apae_p bigint default null, ie_forma_geracao_p text default null, dt_fim_presc_p timestamp default null, dt_inicio_presc_p timestamp default null, cd_unidade_medida_p cpoe_material.cd_unidade_medida%type default null, qt_dose_p cpoe_material.qt_dose%type default null, cd_intervalo_p cpoe_material.cd_intervalo%type default null, qt_dose_terapeutica_p cpoe_material.qt_dose_terapeutica%type default null, cd_unid_medic_terap_p cpoe_material.cd_unid_medic_terap%type default null, ie_futuro_p text default 'N', nr_seq_receita_amb_p bigint default null, qt_vig_p bigint default null, ie_prescription_type_p cpoe_material.ie_prescription_type%type default null, nr_seq_cpoe_rp_p cpoe_material.nr_seq_cpoe_rp%type default null, nr_seq_cpoe_order_unit_p cpoe_material.nr_seq_cpoe_order_unit%type default null, qt_total_dose_p bigint default null) AS $body$
DECLARE

_ora2pg_r RECORD;
ds_stack_w          log_cpoe.ds_stack%type;
ds_log_cpoe_w        log_cpoe.ds_log%type;
cd_material_w                protocolo_medic_material.cd_material%type;
cd_unidade_medida_w          protocolo_medic_material.cd_unidade_medida%type;
cd_unidade_medida_p_w        protocolo_medic_material.cd_unidade_medida%type;
qt_dose_w                    protocolo_medic_material.qt_dose%type;
qt_dose_p_w                  protocolo_medic_material.qt_dose%type;
qt_dose_limite_w             protocolo_medic_material.qt_dose%type;
qt_dose_peso_w               protocolo_medic_material.qt_dose_peso%type;
ie_via_aplicacao_w           protocolo_medic_material.ie_via_aplicacao%type;
ds_recomendacao_w            protocolo_medic_material.ds_recomendacao%type;
cd_intervalo_w               protocolo_medic_material.cd_intervalo%type;
cd_intervalo_p_w             protocolo_medic_material.cd_intervalo%type;
cd_intervalo_agora_w         protocolo_medic_material.cd_intervalo%type;
ds_horarios_w                protocolo_medic_material.ds_horarios%type;
qt_hora_aplicacao_w          protocolo_medic_material.qt_hora_aplicacao%type;
qt_minuto_aplicacao_w        protocolo_medic_material.qt_minuto_aplicacao%type;
qt_minuto_aplicacao_ww       protocolo_medic_material.qt_minuto_aplicacao%type;
ie_bomba_infusao_w           protocolo_medic_material.ie_bomba_infusao%type;
ie_aplic_bolus_w             protocolo_medic_material.ie_aplic_bolus%type;
ie_aplic_lenta_w             protocolo_medic_material.ie_aplic_lenta%type;
hr_prim_horario_w            protocolo_medic_material.hr_prim_horario%type;
ie_objetivo_w                protocolo_medic_material.ie_objetivo%type;
ie_lado_w                    protocolo_medic_material.ie_lado%type;
qt_dias_prev_util_w          protocolo_medic_material.qt_dias_prev_util%type;
ie_arredondar_w              protocolo_medic_material.ie_arredondar%type;
ds_justificativa_w           protocolo_medic_material.ds_justificativa%type;
cd_topografia_cih_w          protocolo_medic_material.cd_topografia_cih%type;
cd_microorganismo_cih_w      protocolo_medic_material.cd_microorganismo_cih%type;
cd_amostra_cih_w             protocolo_medic_material.cd_amostra_cih%type;
ie_origem_infeccao_w         protocolo_medic_material.ie_origem_infeccao%type;
ie_indicacao_w               protocolo_medic_material.ie_indicacao%type;
ie_uso_antimicrobiano_w      protocolo_medic_material.ie_uso_antimicrobiano%type;
ie_medicacao_paciente_w      protocolo_medic_material.ie_medicacao_paciente%type;
ie_fator_correcao_w          protocolo_medic_material.ie_fator_correcao%type;
ie_duracao_w                 protocolo_medic_material.ie_duracao%type;
nr_agrupamento_w             protocolo_medic_material.nr_agrupamento%type;
qt_dose_limite_comp_w        protocolo_medic_material.qt_dose%type;
qt_dose_peso_comp_w          protocolo_medic_material.qt_dose_peso%type;
ie_arredondar_comp_w         protocolo_medic_material.ie_arredondar%type;
qt_solucao_w         protocolo_medic_material.qt_solucao%type;
cd_mat_comp_w                cpoe_material.cd_mat_comp1%type;
cd_unid_med_dose_comp_w      cpoe_material.cd_unid_med_dose_comp1%type;
qt_dose_comp_w               cpoe_material.qt_dose_comp1%type;
ds_observacao_via_w          cpoe_material.ds_observacao%type;
ds_horarios_aux_w            cpoe_material.ds_horarios%type;
ie_administracao_w           cpoe_material.ie_administracao%type;
ds_observacao_w              cpoe_material.ds_observacao%type;
qt_solucao_dil_w             cpoe_material.qt_solucao_dil%type;
cd_mat_dil_w                 cpoe_material.cd_mat_dil%type;
qt_dose_dil_w                cpoe_material.qt_dose_dil%type;
cd_unid_med_dose_dil_w       cpoe_material.cd_unid_med_dose_dil%type;
qt_solucao_red_w             cpoe_material.qt_solucao_red%type;
qt_dose_red_w                cpoe_material.qt_dose_red%type;
cd_mat_red_w                 cpoe_material.cd_mat_red%type;
cd_unid_med_dose_red_w       cpoe_material.cd_unid_med_dose_red%type;
cd_mat_recons_w              cpoe_material.cd_mat_recons%type;
cd_unid_med_dose_recons_w    cpoe_material.cd_unid_med_dose_recons%type;
qt_dose_recons_w             cpoe_material.qt_dose_recons%type;
ds_dose_diferenciada_w       cpoe_material.ds_dose_diferenciada%type;
ie_antibiotico_w             cpoe_material.ie_antibiotico%type;
dt_fim_w                     cpoe_material.dt_fim%type;
hr_min_aplicacao_w           cpoe_material.hr_min_aplicacao%type;
ie_evento_unico_w            cpoe_material.ie_evento_unico%type := 'N';
ds_orientacao_preparo_w      cpoe_material.ds_orientacao_preparo%type;
ie_limpar_prim_horario_w     intervalo_prescricao.ie_limpa_prim_hor%type;
qt_min_intervalo_w           intervalo_prescricao.qt_min_intervalo%type;
ie_sem_aprazamento_w         intervalo_prescricao.ie_sem_aprazamento%type;
ie_dose_unica_cpoe_w         intervalo_prescricao.ie_dose_unica_cpoe%type;
ie_exibe_w                   intervalo_prescricao.cd_intervalo%type;
nr_seq_dil_w                 material_diluicao.nr_seq_interno%type;
nr_seq_red_w                 material_diluicao.nr_seq_interno%type;
nr_seq_recons_w              material_diluicao.nr_seq_interno%type;
qt_solucao_recons_w          material_diluicao.qt_volume%type;
ds_dose_diferenciada_dil_w   cpoe_material.ds_dose_diferenciada_dil%type;
ds_dose_diferenciada_red_w   cpoe_material.ds_dose_diferenciada_red%type;
ds_dose_diferenciada_rec_w   cpoe_material.ds_dose_diferenciada_rec%type;
ie_regra_diluicao_w          varchar(255);
nr_ocorrencia_w              prescr_material.nr_ocorrencia%type;
qt_unitaria_w                prescr_material.qt_unitaria%type;
qt_conversao_dose_w          material_conversao_unidade.qt_conversao%type;
nr_seq_comp_w                bigint;
dt_inicio_w                  timestamp;
dt_inicio_base_w             timestamp;
ie_urgencia_medic_w          char(1);
ie_urgencia_w                char(1);
ie_se_necessario_w           char(1);
ie_prescr_alta_agora_w       varchar(1);
ie_diluicao_recons_prot_w    varchar(2);
ie_acm_w                     char(1);
ie_sn_interv_w               intervalo_prescricao.ie_se_necessario%type;
ie_acm_interv_w              intervalo_prescricao.ie_acm%type;
cd_material_ret_w            material.cd_material%type;
ie_via_aplicacao_gen_w    protocolo_medic_material.ie_via_aplicacao%type;
cd_unidade_medida_gen_w   protocolo_medic_material.cd_unidade_medida%type;
cd_intervalo_gen_w        intervalo_prescricao.cd_intervalo%type;
ds_horarios_gen_w         cpoe_material.ds_horarios%type;
ds_observacao_gen_w       cpoe_material.ds_observacao%type;
ie_justificativa_w      regra_antimicrobiano.ie_justificativa%type;
ie_objetivo_proc_w      regra_antimicrobiano.ie_objetivo%type;
ie_dia_utilizacao_w     regra_antimicrobiano.ie_dia_utilizacao%type;
ie_topografia_w       regra_antimicrobiano.ie_topografia%type;
ie_amostra_w         regra_antimicrobiano.ie_amostra%type;
ie_microorganismo_w     regra_antimicrobiano.ie_microorganismo%type;
ie_origem_w         regra_antimicrobiano.ie_origem%type;
ie_exige_indicacao_w     regra_antimicrobiano.ie_indicacao%type;
qt_dias_prev_w        regra_antimicrobiano.qt_dias_prev%type;
ie_obj_regra_w        regra_antimicrobiano.ie_objetivo_filtro%type;
ie_lib_auto_w        regra_antimicrobiano.ie_lib_auto%type;
ie_possui_regra_w      varchar(5);
ie_regra_intervalo_w	cpoe_material.cd_intervalo%type;
qt_dias_liberado_w      cpoe_material.qt_dias_liberado%type;
dt_fim_cih_w        cpoe_material.dt_fim_cih%type;
ds_solucao_ww        varchar(255);
ie_possui_dil_ww      varchar(1);
ie_possui_red_ww      varchar(1);
nr_dia_util_aux_w      cpoe_material.nr_dia_util%type;
ie_tratamento_vig_w      varchar(10);
qt_dose_ataque_w        cpoe_material.qt_dose_ataque%type;
ie_dose_espec_agora_w   protocolo_medic_material.ie_dose_espec_agora%type;
qt_dose_especial_w      protocolo_medic_material.qt_dose_especial%type;
ie_dose_adicional_w     protocolo_medic_material.ie_dose_adicional%type;
qt_dose_adicional_w     protocolo_medic_material.qt_dose_adicional%type;
hr_dose_especial_w      protocolo_medic_material.hr_dose_especial%type;
ie_dose_ataque_w        cpoe_material.ie_dose_ataque%type;
dt_adm_adicional_w      cpoe_material.dt_adm_adicional%type;
tipo_material_w     bigint;
nr_seq_mat_protocolo_w  cpoe_material.nr_seq_mat_protocolo%type;
ie_regra_bolus_w        varchar(1);
ie_glicose_w  material.ie_glicose%type;
ie_possui_dil_cad_mat_w   varchar(1);
qt_hora_aplic_w       cpoe_material.qt_hora_aplicacao%type;
qt_min_aplic_w        cpoe_material.qt_min_aplicacao%type;
ie_substitui_tempo_aplic_w  varchar(1);
ie_use_item_types_w         varchar(1);
ie_drug_info_w        cpoe_order_unit.ie_drug_info%type := null;
ie_via_aplicacao_rp_w             cpoe_rp.ie_via_aplicacao%type := null;
nr_seq_grupo_interval_rp_w        cpoe_rp.nr_seq_grupo_interval%type := null;
nr_seq_subgrupo_interval_rp_w     cpoe_rp.nr_seq_subgrupo_interval%type := null;
cd_intervalo_rp_w                 cpoe_rp.cd_intervalo%type := null;
dt_inicio_rp_w                    cpoe_rp.dt_inicio%type := null;
dt_fim_rp_w                       cpoe_rp.dt_fim%type := null;
ds_horarios_rp_w                  cpoe_rp.ds_horarios%type := null;
ie_segunda_rp_w                   cpoe_rp.ie_segunda%type := null;
ie_terca_rp_w                     cpoe_rp.ie_terca%type := null;
ie_quarta_rp_w                    cpoe_rp.ie_quarta%type := null;
ie_quinta_rp_w                    cpoe_rp.ie_quinta%type := null;
ie_sexta_rp_w                     cpoe_rp.ie_sexta%type := null;
ie_sabado_rp_w                    cpoe_rp.ie_sabado%type := null;
ie_domingo_rp_w                   cpoe_rp.ie_domingo%type := null;
ie_duracao_rp_w                 protocolo_medic_material.ie_duracao%type := null;
ie_considerar_peso_w			varchar(1);
ie_exige_justificativa_out_w	material_prescr.ie_exige_justificativa%type;
ie_justificativa_padrao_out_w	material_prescr.ie_justificativa_padrao%type;
ds_justificativa_out_w			varchar(4000);
  qt_dose_ref_w            cpoe_material.qt_dose%type;
  qt_dose_dia_w            cpoe_material.qt_dose_dia%type;
qt_dias_lib_padrao_w			parametro_medico.qt_dias_lib_padrao%type;
qt_retorno_sem_ml_w				double precision;

c01 CURSOR FOR
    SELECT  a.cd_material,
      a.cd_unidade_medida,
      a.qt_dose,
      a.qt_dose_peso,
      a.ie_via_aplicacao,
      substr(a.ds_recomendacao, 1, 2000) ds_recomendacao,
      coalesce(a.cd_intervalo,
        cpoe_obter_padrao_param_prescr(nr_atendimento_p,
                        a.cd_material,
                        a.ie_via_aplicacao,
                        'N',
                        'I',
                        null,
                        cd_estabelecimento_p,
                        cd_perfil_p,
                        nm_usuario_p,
                        cd_paciente_p)) cd_intervalo,
      coalesce(a.ie_se_necessario, 'N') ie_se_necessario,
      a.qt_hora_aplicacao qt_hora_aplicacao,
      a.qt_minuto_aplicacao qt_minuto_aplicacao,
      coalesce(a.ie_bomba_infusao, 'N') ie_bomba_infusao,
      coalesce(a.ie_aplic_bolus, 'N') ie_aplic_bolus,
      coalesce(a.ie_aplic_lenta, 'N') ie_aplic_lenta,
      coalesce(a.ie_acm, 'N') ie_acm,
      a.hr_prim_horario,
      coalesce(a.ie_urgencia, 'N') ie_urgencia,
      substr(obter_dados_via_aplicacao(a.cd_material,
                       coalesce(a.ie_via_aplicacao, 'IV'),
                       cd_setor_atendimento_p,
                       'R'),1,255) ie_via_aplicacao,
      a.ie_lado,
      a.ie_objetivo,
      a.qt_dias_prev_util,
      coalesce(a.ie_arredondar, 'N') ie_arredondar,
      a.ds_justificativa,
      a.cd_topografia_cih,
      a.cd_microorganismo_cih,
      a.cd_amostra_cih,
      a.ie_origem_infeccao,
      a.ie_indicacao,
      a.ie_uso_antimicrobiano,
      coalesce(a.ie_medicacao_paciente, 'N') ie_medicacao_paciente,
      a.ie_fator_correcao,
      a.ds_dose_diferenciada,
      coalesce(a.ie_duracao, 'C'),
      a.nr_agrupamento,
      a.ie_dose_espec_agora,
      a.qt_dose_especial,
      a.ie_dose_adicional,
      a.qt_dose_adicional,
      a.Hr_Dose_Especial,
    a.qt_solucao,
    a.nr_seq_material
    from  protocolo_medic_material a
  where   a.cd_protocolo = cd_protocolo_p
    and   a.nr_sequencia = nr_seq_protocolo_p
    and   a.ie_agrupador = 1
    and   a.nr_seq_material = coalesce(nr_seq_produto_p, nr_seq_material)
    order by nr_seq_material;

c02 CURSOR FOR
    SELECT   cd_material,
      cd_unidade_medida,
      qt_dose,
      qt_dose_peso,
      coalesce(ie_arredondar, 'N'),
      row_number() OVER () AS rownum
    from   protocolo_medic_material
    where   cd_protocolo = cd_protocolo_p
    and   nr_sequencia = nr_seq_protocolo_p
    and   nr_seq_material <> coalesce(nr_seq_produto_p, nr_seq_material)
    and   nr_agrupamento = nr_agrupamento_w
    and   ie_agrupador = 1
    order by nr_seq_material LIMIT 7;


BEGIN

  cd_intervalo_p_w      := cd_intervalo_p;
  qt_dose_p_w           := qt_dose_p;
  cd_unidade_medida_p_w := cd_unidade_medida_p;

  ie_prescr_alta_agora_w := obter_param_usuario(924, 409, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_prescr_alta_agora_w);
  ie_diluicao_recons_prot_w := obter_param_usuario(924, 648, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_diluicao_recons_prot_w);
  ie_regra_bolus_w := obter_param_usuario(924, 327, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_regra_bolus_w);
  ie_considerar_peso_w := obter_param_usuario(924, 380, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_considerar_peso_w);

  if (dt_inicio_presc_p IS NOT NULL AND dt_inicio_presc_p::text <> '') then
    dt_inicio_base_w := dt_inicio_presc_p;
  else
    dt_inicio_base_w := trunc(clock_timestamp() + interval '1 days' / 24, 'hh24');
  end if;

  open c01;
  loop
    fetch c01
      into   cd_material_w,
        cd_unidade_medida_w,
      qt_dose_w,
      qt_dose_peso_w,
      ie_via_aplicacao_w,
      ds_recomendacao_w,
      cd_intervalo_w,
      ie_se_necessario_w,
      qt_hora_aplicacao_w,
      qt_minuto_aplicacao_w,
      ie_bomba_infusao_w,
      ie_aplic_bolus_w,
      ie_aplic_lenta_w,
      ie_acm_w,
      hr_prim_horario_w,
      ie_urgencia_medic_w,
      ds_observacao_via_w,
      ie_lado_w,
      ie_objetivo_w,
      qt_dias_prev_util_w,
      ie_arredondar_w,
      ds_justificativa_w,
      cd_topografia_cih_w,
      cd_microorganismo_cih_w,
      cd_amostra_cih_w,
      ie_origem_infeccao_w,
      ie_indicacao_w,
      ie_uso_antimicrobiano_w,
      ie_medicacao_paciente_w,
      ie_fator_correcao_w,
      ds_dose_diferenciada_w,
      ie_duracao_w,
      nr_agrupamento_w,
      ie_dose_espec_agora_w,
      qt_dose_especial_w,
      ie_dose_adicional_w,
      qt_dose_adicional_w,
      hr_dose_especial_w,
    qt_solucao_w,
    nr_seq_mat_protocolo_w;
    EXIT WHEN NOT FOUND; /* apply on c01 */
    begin

    dt_fim_w                 := null;
    dt_inicio_w              := dt_inicio_base_w;
    ds_horarios_w            := '';
    ds_horarios_aux_w        := '';
    nr_ocorrencia_w          := 0;
    ie_administracao_w       := 'P';
    ie_urgencia_w            := null;
    ie_sem_aprazamento_w     := 'N';
    ie_limpar_prim_horario_w := 'N';
    ie_dose_ataque_w         := ie_dose_espec_agora_w;
  dt_adm_adicional_w     := null;

    tipo_material_w := obter_tipo_material(cd_material_w, 'C');

  if (tipo_material_w = '3') then
    cd_material_ret_w := obter_regra_subst_gen(NULL, nr_atendimento_p, cd_material_w, wheb_usuario_pck.get_cd_estabelecimento);
  else
    cd_material_ret_w := obter_regra_subst_com(NULL,cd_material_w,nr_atendimento_p);
  end if;

  if (coalesce(cd_material_ret_w,0) = 0) then
    cd_material_ret_w := cpoe_substituir_medic_apres(cd_estabelecimento_p, obter_convenio_atendimento(nr_atendimento_p), cd_material_w);
  end if;

  if (hr_dose_especial_w IS NOT NULL AND hr_dose_especial_w::text <> '') then
    dt_adm_adicional_w := ESTABLISHMENT_TIMEZONE_UTILS.todayAtTime(hr_dose_especial_w);
  end if;

    if (coalesce(cd_material_ret_w, 0) > 0) then
      cd_material_w := cd_material_ret_w;
    end if;

    if (coalesce(ie_via_aplicacao_w::text, '') = '') then

      select   max(ie_via_aplicacao)
      into STRICT   ie_via_aplicacao_w
      from   material
      where   cd_material = cd_material_w;
    end if;

    if ((coalesce(dt_inicio_presc_p::text, '') = '') and (coalesce(obter_se_marca_agora(cpoe_obter_setor_atend_prescr(nr_atendimento_p,
                                                                    cd_estabelecimento_p,
                                                                    cd_perfil_p,
                                                                    nm_usuario_p)),'N') = 'S')) then

      cd_intervalo_agora_w := cpoe_busca_intervalo_agora(nr_atendimento_p,
                                                           'M',
                                                           cd_estabelecimento_p,
                                                           cd_perfil_p,
                                                           nm_usuario_p);
      if (cd_intervalo_agora_w IS NOT NULL AND cd_intervalo_agora_w::text <> '') then
        cd_intervalo_w      := cd_intervalo_agora_w;
        ie_urgencia_medic_w := 'S';
      end if;
    end if;

    if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') then
      select  max(ie_dose_unica_cpoe)
      into STRICT   ie_dose_unica_cpoe_w
      from   intervalo_prescricao
      where   cd_intervalo = cd_intervalo_w;

      if (coalesce(ie_dose_unica_cpoe_w, 'N') = 'S') then
        ie_duracao_w       := 'P';
        ie_evento_unico_w  := 'S';
        ie_se_necessario_w := 'N';
        ie_acm_w           := 'N';
      end if;
    end if;

    if (ie_urgencia_medic_w = 'S') then
      ie_urgencia_w := '0';
    elsif (ie_se_necessario_w = 'S') then
      ie_administracao_w := 'N';
    elsif (ie_acm_w = 'S') then
      ie_administracao_w := 'C';
    end if;

    if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') then

      select max(cd_intervalo)
      into STRICT cd_intervalo_w
      from intervalo_prescricao
      where ie_situacao = 'A'
      and cd_intervalo = cd_intervalo_w
      and obter_se_intervalo(cd_intervalo, '1') = 'S'
      and obter_se_intervalo_estab(cd_intervalo_w,
                      cd_estabelecimento_p) = 'S'
      and obter_se_intervalo_sugerido(cd_material_w, cd_intervalo) = 'S'
      and ((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_p))
      order by coalesce(nr_seq_apresent, 999), ds_intervalo;

      ie_limpar_prim_horario_w := coalesce(obter_se_limpa_prim_hor(cd_intervalo_w,cd_setor_atendimento_p),'N');
      ie_sem_aprazamento_w     := coalesce(obter_dados_apraz_interv(cd_intervalo_w,cd_setor_atendimento_p,'A'),'N');
    end if;

    if (coalesce(dt_inicio_presc_p::text, '') = '') and (cpoe_obter_hor_setor_ps(nm_usuario_p, cd_estabelecimento_p, nr_atendimento_p, cd_perfil_p, cd_intervalo_w) = 'S') then

    dt_inicio_w := clock_timestamp();
    ie_urgencia_w := '0';
        hr_prim_horario_w := to_char(dt_inicio_w,'hh24:mi');
    else

        if (coalesce(hr_prim_horario_w::text, '') = '') then

      if ((coalesce(hr_prim_horario_w::text, '') = '') or (hr_prim_horario_w = '  :  ')) then

        hr_prim_horario_w := coalesce(substr(cpoe_obter_primeiro_horario(nr_atendimento_p,
                      cd_intervalo_w,
                      cd_material_w,
                      cd_estabelecimento_p,
                      cd_perfil_p,
                      nm_usuario_p,
                      cd_paciente_p,
                      ie_via_aplicacao_w,
                      'S'), 1, 5), to_char(trunc(dt_inicio_base_w, 'hh24'), 'hh24:mi'));
      end if;
    end if;

    if (hr_prim_horario_w = 'AGORA') then

      dt_inicio_w := clock_timestamp();
      ie_urgencia_w := '0';
      hr_prim_horario_w := to_char(dt_inicio_w,'hh24:mi');
    elsif (coalesce(dt_inicio_presc_p::text, '') = '') and (dt_inicio_base_w IS NOT NULL AND dt_inicio_base_w::text <> '') and (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') then

      dt_inicio_w := ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_inicio_base_w, substr(hr_prim_horario_w, 1, 5));

      if (dt_inicio_w <= trunc(clock_timestamp(), 'mi')) then
        dt_inicio_w := dt_inicio_w + 1;
      end if;
    end if;
    end if;

    if (coalesce(dt_inicio_presc_p::text, '') = '') and (dt_inicio_base_w IS NOT NULL AND dt_inicio_base_w::text <> '') and (ie_urgencia_medic_w = 'S') then

      if (coalesce(nr_seq_pend_pac_acao_p::text, '') = '') then
        dt_inicio_w := clock_timestamp();
      else
        --mentor
        dt_inicio_w := ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp());
      end if;

      hr_prim_horario_w := to_char(clock_timestamp(), 'hh24:mi');
    end if;

    select  max(qt_min_intervalo)
    into STRICT   qt_min_intervalo_w
    from   intervalo_prescricao
    where   cd_intervalo = cd_intervalo_w;

    SELECT * FROM cpoe_calcular_horario_prescr(nr_atendimento_p, cd_intervalo_w, cd_material_w, dt_inicio_w, 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;

    ds_horarios_w := ds_horarios_w || ds_horarios_aux_w;

    if (ie_sem_aprazamento_w = 'S') or (ie_limpar_prim_horario_w = 'S') or (ie_acm_w = 'S') or (ie_se_necessario_w = 'S') then

      ds_horarios_w     := '';
      hr_prim_horario_w := '';
    else
      -- Clear out the text inside the line and adds the sufix of ":00" as needed, fitting it
      ds_horarios_w := replace(Padroniza_horario_prescr(ds_horarios_w, null), 'A', '');
    end if;

    if (qt_dose_peso_w > 0) and (qt_peso_p > 0) then

      qt_dose_w := qt_dose_peso_w * qt_peso_p;

      if (upper(cd_unidade_medida_w) = 'GTS') then
        qt_dose_w := round(qt_dose_w);
      elsif (ie_arredondar_w = 'S') then
        qt_dose_w := arredondamento(qt_dose_w, 1, 'R');
      end if;
    end if;

    qt_dose_limite_w := coalesce(cpoe_obter_dose_maxima(  cd_estabelecimento_p,
                            cd_material_w,
                            cd_unidade_medida_w,
                            qt_dose_w,
                            ie_via_aplicacao_w,
                            cd_setor_atendimento_p,
                            nr_seq_agrupamento_p,
                            cd_prescritor_p,
                            qt_idade_dia_p,
                            qt_idade_mes_p,
                            qt_idade_ano_p,
                            qt_peso_p), 0);
    if (qt_dose_limite_w > 0) then
      qt_dose_w := qt_dose_limite_w;
    end if;

    qt_conversao_dose_w := coalesce(obter_conversao_unid_med(cd_material_w,
                                                            cd_unidade_medida_w),1);

    qt_unitaria_w       := dividir(trunc(dividir(qt_dose_w * 1000, qt_conversao_dose_w)), 1000);
    ds_observacao_w     := substr(obter_orientacao_medic(cd_material_w), 1, 4000);

    if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
      ds_observacao_w := substr(ds_observacao_w || ' - ' ||
                                  cpoe_obter_padrao_param_prescr(nr_atendimento_p,
                                                                 cd_material_w,
                                                                 ie_via_aplicacao_w,
                                                                 'N',
                                                                 'O',
                                                                 null,
                                                                 cd_estabelecimento_p,
                                                                 cd_perfil_p,
                                                                 nm_usuario_p,
                                                                 cd_paciente_p), 1, 4000);
    else
      ds_observacao_w := substr(cpoe_obter_padrao_param_prescr(nr_atendimento_p,
                                   cd_material_w,
                                   ie_via_aplicacao_w,
                                   'N',
                                   'O',
                                   null,
                                   cd_estabelecimento_p,
                                   cd_perfil_p,
                                   nm_usuario_p,
                                   cd_paciente_p), 1, 4000);
    end if;

    if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
      ds_observacao_w := substr(ds_observacao_w || ' - ' ||
                  obter_dados_via_aplicacao(cd_material_w,
                                ie_via_aplicacao_w,
                                cd_setor_atendimento_p,
                                'R'), 1, 4000);
    else
      ds_observacao_w := substr(obter_dados_via_aplicacao(cd_material_w,
                                ie_via_aplicacao_w,
                                cd_setor_atendimento_p,
                                'R'), 1, 4000);
    end if;

    if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
      ds_observacao_w := substr(ds_observacao_w || ' - ' ||
                  ds_recomendacao_w, 1, 4000);
    else
      ds_observacao_w := substr(ds_recomendacao_w, 1, 4000);
    end if;

    SELECT * FROM cpoe_obter_recon_redil_prot(nr_seq_produto_p, cd_protocolo_p, nr_seq_protocolo_p, cd_estabelecimento_p, cd_material_w, cd_unidade_medida_w, qt_dose_w, qt_unitaria_w, ie_se_necessario_w, ie_acm_w, qt_solucao_dil_w, cd_mat_dil_w, qt_dose_dil_w, cd_unid_med_dose_dil_w, qt_solucao_red_w, qt_dose_red_w, cd_mat_red_w, cd_unid_med_dose_red_w, cd_mat_recons_w, cd_unid_med_dose_recons_w, qt_dose_recons_w, qt_minuto_aplicacao_ww, ds_dose_diferenciada_dil_w, ds_dose_diferenciada_rec_w, ds_dose_diferenciada_red_w) INTO STRICT qt_solucao_dil_w, cd_mat_dil_w, qt_dose_dil_w, cd_unid_med_dose_dil_w, qt_solucao_red_w, qt_dose_red_w, cd_mat_red_w, cd_unid_med_dose_red_w, cd_mat_recons_w, cd_unid_med_dose_recons_w, qt_dose_recons_w, qt_minuto_aplicacao_ww, ds_dose_diferenciada_dil_w, ds_dose_diferenciada_rec_w, ds_dose_diferenciada_red_w;

  qt_hora_aplic_w := null;
  qt_min_aplic_w := null;
  ie_substitui_tempo_aplic_w := 'N';

    if ((ie_diluicao_recons_prot_w = 'S') and (coalesce(cd_mat_dil_w, 0) = 0) and (coalesce(cd_mat_red_w, 0) = 0) and (coalesce(cd_mat_recons_w, 0) = 0)) then

      SELECT * FROM cpoe_gerar_reconst_diluicao(nr_atendimento_p, cd_material_w, ie_via_aplicacao_w, qt_dose_w, cd_unidade_medida_w, 0, NULL, nm_usuario_p, nr_seq_dil_w, cd_mat_dil_w, qt_dose_dil_w, cd_unid_med_dose_dil_w, qt_solucao_dil_w, ds_dose_diferenciada_dil_w, nr_seq_red_w, cd_mat_red_w, qt_dose_red_w, cd_unid_med_dose_red_w, qt_solucao_red_w, ds_dose_diferenciada_red_w, nr_seq_recons_w, cd_mat_recons_w, qt_dose_recons_w, cd_unid_med_dose_recons_w, qt_solucao_recons_w, ds_dose_diferenciada_rec_w, ie_regra_diluicao_w, NULL, cd_paciente_p, cd_estabelecimento_p, 0, cd_intervalo_w, ds_solucao_ww, ie_possui_dil_ww, ie_possui_red_ww, ie_possui_dil_cad_mat_w, qt_hora_aplic_w, qt_min_aplic_w, ie_substitui_tempo_aplic_w, qt_retorno_sem_ml_w) INTO STRICT nr_seq_dil_w, cd_mat_dil_w, qt_dose_dil_w, cd_unid_med_dose_dil_w, qt_solucao_dil_w, ds_dose_diferenciada_dil_w, nr_seq_red_w, cd_mat_red_w, qt_dose_red_w, cd_unid_med_dose_red_w, qt_solucao_red_w, ds_dose_diferenciada_red_w, nr_seq_recons_w, cd_mat_recons_w, qt_dose_recons_w, cd_unid_med_dose_recons_w, qt_solucao_recons_w, ds_dose_diferenciada_rec_w, ie_regra_diluicao_w, ds_solucao_ww, ie_possui_dil_ww, ie_possui_red_ww, ie_possui_dil_cad_mat_w, qt_hora_aplic_w, qt_min_aplic_w, ie_substitui_tempo_aplic_w, qt_retorno_sem_ml_w;
    end if;

    if (ie_regra_bolus_w = 'S' and ie_aplic_bolus_w = 'S') then
    ie_possui_dil_ww := 'N';
    ie_possui_red_ww := 'N';
    qt_dose_red_w := null;
    qt_dose_dil_w := null;
    qt_solucao_red_w := null;
    cd_unid_med_dose_dil_w := null;
    cd_unid_med_dose_red_w := null;
    nr_seq_red_w := null;
    cd_mat_red_w := null;
    nr_seq_dil_w := null;
    cd_mat_dil_w := null;
  end if;

    if (coalesce(ie_prescr_alta_agora_w, 'N') = 'S') and (coalesce(ie_item_alta_p, 'N') = 'S') then
      ie_urgencia_w     := 0;
      hr_prim_horario_w := obter_prim_dshorarios(ds_horarios_w);
      dt_inicio_w       := ESTABLISHMENT_TIMEZONE_UTILS.todayAtTime(hr_prim_horario_w);

      if (dt_inicio_w < clock_timestamp()) then
        dt_inicio_w := dt_inicio_w + 1;
      end if;
    end if;

    select nextval('cpoe_material_seq')
    into STRICT nr_seq_item_gerado_p
;

    ie_antibiotico_w := coalesce(obter_se_mat_ctrl_antibiotico(cd_material_w), 'N');

    if (coalesce(ie_antibiotico_w, 'N') = 'S') then
      ie_duracao_w := 'P';
    end if;

    if (ie_duracao_w = 'P') then
      dt_fim_w := (dt_inicio_w + coalesce(qt_dias_prev_util_w, 1)) - 1 / 1440;
    end if;

    if (ie_duracao_w = 'C') or (coalesce(ie_antibiotico_w, 'N') = 'N') then
      qt_dias_prev_util_w := null;
    end if;

    if (dt_fim_presc_p IS NOT NULL AND dt_fim_presc_p::text <> '') then
      dt_fim_w            := dt_fim_presc_p;
      ie_duracao_w        := 'P';
      qt_dias_prev_util_w := ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_fim_w) - ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_w);
    end if;

    if (qt_minuto_aplicacao_ww IS NOT NULL AND qt_minuto_aplicacao_ww::text <> '') then
      qt_hora_aplicacao_w   := trunc((qt_minuto_aplicacao_ww * 60) / 3600);
      qt_minuto_aplicacao_w := trunc(mod((qt_minuto_aplicacao_ww * 60), 3600) / 60);
    end if;

  if ((coalesce(ie_substitui_tempo_aplic_w, 'N') = 'S' or (coalesce(qt_hora_aplicacao_w::text, '') = '' and coalesce(qt_minuto_aplicacao_w::text, '') = '')) and (ie_aplic_bolus_w = 'N' and ie_aplic_lenta_w = 'N')) then
    qt_hora_aplicacao_w := qt_hora_aplic_w;
    qt_minuto_aplicacao_w := qt_min_aplic_w;
  end if;

    if ((qt_hora_aplicacao_w IS NOT NULL AND qt_hora_aplicacao_w::text <> '') or (qt_minuto_aplicacao_w IS NOT NULL AND qt_minuto_aplicacao_w::text <> '')) then

      if (coalesce(qt_hora_aplicacao_w::text, '') = '') then
        hr_min_aplicacao_w := '00:';
      else
        if (qt_hora_aplicacao_w > 9) then
          hr_min_aplicacao_w := qt_hora_aplicacao_w || ':';
        else
          hr_min_aplicacao_w := '0' || qt_hora_aplicacao_w || ':';
        end if;
      end if;

      if (coalesce(qt_minuto_aplicacao_w::text, '') = '') then
        hr_min_aplicacao_w := hr_min_aplicacao_w || '00';
      else
        if (qt_minuto_aplicacao_w > 9) then
          hr_min_aplicacao_w := hr_min_aplicacao_w ||
                    qt_minuto_aplicacao_w;
        else
          hr_min_aplicacao_w := hr_min_aplicacao_w || '0' ||
                    qt_minuto_aplicacao_w;
        end if;
      end if;
    end if;

    if (ie_retrogrado_p = 'S' or ie_futuro_p = 'S') then
      -- retrograde item
      dt_inicio_w := dt_inicio_p;
      dt_fim_w    := (dt_inicio_w + 1) - 1 / 1440;
      ie_duracao_w  := 'P';
      ie_urgencia_w  := null;
      qt_dias_prev_util_w  := ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_fim_w) - ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_w);

      select  max(qt_min_intervalo)
      into STRICT   qt_min_intervalo_w
      from   intervalo_prescricao
      where   cd_intervalo = cd_intervalo_w;

      SELECT * FROM cpoe_calcular_horario_prescr(nr_atendimento_p, cd_intervalo_w, cd_material_w, dt_inicio_w, 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;

      ds_horarios_w := ds_horarios_w || ds_horarios_aux_w;

      ds_horarios_w := replace(Padroniza_horario_prescr(ds_horarios_w, null), 'A', '');
      hr_prim_horario_w := obter_prim_dshorarios(ds_horarios_w);
    end if;

    if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') then

      select   coalesce(max(cd_intervalo), 'N'),
          coalesce(max(ie_se_necessario), 'N'),
          coalesce(max(ie_acm), 'N')
      into STRICT   ie_exibe_w,
          ie_sn_interv_w,
          ie_acm_interv_w
      from   intervalo_prescricao
      where   cd_intervalo = cd_intervalo_w
      and   ie_situacao = 'A'
      and   obter_se_intervalo(cd_intervalo_w, '1') = 'S'
      and   cpoe_obter_se_exibe_interv( nr_atendimento_p,
                        cd_estabelecimento_p,
                        cd_intervalo_w,
                        cd_perfil_p,
                        nm_usuario_p) = 'S'
      and   ((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_p))
      and   obter_se_intervalo_estab(cd_intervalo_w,cd_estabelecimento_p) = 'S'
      and   obter_se_intervalo_sugerido(cd_material_w, cd_intervalo_w) = 'S'
      and   ((coalesce(ie_so_retrograda, 'N') = 'N') or (coalesce(ie_retrogrado_p, 'N') = 'N'));

      if (ie_exibe_w = 'N' or (ie_administracao_w = 'N' and ie_sn_interv_w = 'N') or (ie_administracao_w = 'C' and ie_acm_interv_w = 'N')) then
        cd_intervalo_w := null;
      end if;
    end if;

    if (coalesce(cd_intervalo_w::text, '') = '') or (cd_intervalo_w = '') then
      ds_horarios_w := '';
    end if;

    if (cd_material_w = cd_material_ret_w) then

      ie_via_aplicacao_gen_w := cpoe_obter_padrao_param_prescr(nr_atendimento_p,
                                  cd_material_w,
                                  ie_via_aplicacao_w,
                                  'N',
                                  'V',
                                  NULL,
                                  cd_estabelecimento_p,
                                  cd_perfil_p,
                                  nm_usuario_p,
                                  cd_paciente_p);

      if (coalesce(ie_via_aplicacao_gen_w, 'XPTO') = 'XPTO') then

        select   max(ie_via_aplicacao)
        into STRICT   ie_via_aplicacao_w
        from   material
        where   cd_material = cd_material_w;
      else
        ie_via_aplicacao_w := ie_via_aplicacao_gen_w;
      end if;

      cd_unidade_medida_gen_w := cpoe_obter_padrao_param_prescr(nr_atendimento_p,
                                    cd_material_w,
                                    ie_via_aplicacao_w,
                                    'N',
                                    'U',
                                    NULL,
                                    cd_estabelecimento_p,
                                    cd_perfil_p,
                                    nm_usuario_p,
                                    cd_paciente_p);
      if (coalesce(cd_unidade_medida_gen_w, 'XPTO') = 'XPTO') then

        select  max(cd_unidade_medida_consumo)
        into STRICT   cd_unidade_medida_w
        from   material
        where   cd_material = cd_material_w;
      else
        cd_unidade_medida_w := cd_unidade_medida_gen_w;
      end if;

      cd_intervalo_gen_w := cpoe_obter_padrao_param_prescr(nr_atendimento_p,
                                 cd_material_w,
                                 ie_via_aplicacao_w,
                                 'N',
                                 'I',
                                 NULL,
                                 cd_estabelecimento_p,
                                 cd_perfil_p,
                                 nm_usuario_p,
                                 cd_paciente_p);
      if (coalesce(cd_intervalo_gen_w, 'XPTO') = 'XPTO') then

        select  max(CD_INTERVALO_PADRAO)
        into STRICT   cd_intervalo_w
        from   material
        where   cd_material = cd_material_w;
      else
        cd_intervalo_w := cd_intervalo_gen_w;
      end if;

      ds_horarios_gen_w := cpoe_obter_padrao_param_prescr(nr_atendimento_p,
                                cd_material_w,
                                ie_via_aplicacao_w,
                                'N',
                                'HP',
                                NULL,
                                cd_estabelecimento_p,
                                cd_perfil_p,
                                nm_usuario_p,
                                cd_paciente_p);

      ds_observacao_gen_w := cpoe_obter_padrao_param_prescr(nr_atendimento_p,
                                cd_material_w,
                                ie_via_aplicacao_w,
                                'N',
                                'O',
                                NULL,
                                cd_estabelecimento_p,
                                cd_perfil_p,
                                nm_usuario_p,
                                cd_paciente_p);
    end if;

  if ( coalesce(cd_unidade_medida_p_w, 'XPTO') <> 'XPTO') then
    cd_unidade_medida_w := cd_unidade_medida_p_w;
  end if;

    if ( coalesce(qt_dose_p_w, 0) > 0) then
    qt_dose_w := qt_dose_p_w;
    end if;

    if (coalesce(cd_intervalo_p_w, 'XPTO') <> 'XPTO') then
    cd_intervalo_w := cd_intervalo_p_w;
    end if;

	SELECT * FROM cpoe_get_justification_data(nr_atendimento_p, cd_material_w, cd_estabelecimento_p, cd_setor_atendimento_p, nm_usuario_p, coalesce(ie_via_aplicacao_rp_w,ie_via_aplicacao_w), cd_paciente_p, coalesce(cd_intervalo_rp_w,cd_intervalo_w), ie_se_necessario_w, 'N', ie_considerar_peso_w, qt_dose_w, ie_bomba_infusao_w, ie_administracao_w, ie_urgencia_w, ie_antibiotico_w, ie_objetivo_w, cd_protocolo_p, nr_seq_protocolo_p, nr_seq_mat_protocolo_w, null, ie_exige_justificativa_out_w, ie_justificativa_padrao_out_w, ds_justificativa_out_w) INTO STRICT ie_exige_justificativa_out_w, ie_justificativa_padrao_out_w, ds_justificativa_out_w;

	if ((coalesce(ds_justificativa_w, 'XPTO') = 'XPTO') and (coalesce(ds_justificativa_out_w, 'XPTO') <> 'XPTO')) then
		ds_justificativa_w := ds_justificativa_out_w;
	end if;

    qt_dias_prev_w     := null;
    qt_dias_liberado_w   := null;
    dt_fim_cih_w    := null;

    if (coalesce(ie_antibiotico_w,'N') = 'S') then

      SELECT * FROM cpoe_obter_dados_antimicrob(cd_material_w, cd_perfil_p, cd_estabelecimento_p, nm_usuario_p, ie_objetivo_w, cd_intervalo_w) INTO STRICT _ora2pg_r;
 ie_justificativa_w := _ora2pg_r.ie_justificativa_p; ie_objetivo_proc_w := _ora2pg_r.ie_objetivo_p; ie_dia_utilizacao_w := _ora2pg_r.ie_dia_utilizacao_p; ie_topografia_w := _ora2pg_r.ie_topografia_p; ie_amostra_w := _ora2pg_r.ie_amostra_p; ie_microorganismo_w := _ora2pg_r.ie_microorganismo_p; ie_origem_w := _ora2pg_r.ie_origem_p; ie_exige_indicacao_w := _ora2pg_r.ie_exige_indicacao_p; qt_dias_prev_w := _ora2pg_r.qt_dias_prev_p; ie_obj_regra_w := _ora2pg_r.ie_obj_regra_p; ie_lib_auto_w := _ora2pg_r.ie_lib_auto_p; ie_possui_regra_w := _ora2pg_r.ie_possui_regra_p; ie_regra_intervalo_w := _ora2pg_r.ie_regra_intervalo_p; qt_dias_lib_padrao_w := _ora2pg_r.qt_dias_lib_padrao_p;


		if (coalesce(ie_possui_regra_w,'N') = 'S') then
			if (coalesce(ie_lib_auto_w,'N') = 'S') and ((coalesce(qt_dias_prev_util_w,qt_dias_prev_w) IS NOT NULL AND (coalesce(qt_dias_prev_util_w,qt_dias_prev_w))::text <> '')) then
				qt_dias_liberado_w := coalesce(qt_dias_prev_util_w,qt_dias_prev_w);

				if (dt_inicio_w IS NOT NULL AND dt_inicio_w::text <> '') then
					dt_fim_cih_w := (dt_inicio_w + qt_dias_liberado_w) - 1/86400;
				end if;
			end if;
		end if;

		SELECT * FROM cpoe_obter_nr_dias_util_cih(nr_seq_item_gerado_p, nr_atendimento_p, cd_paciente_p, cd_material_w, dt_inicio_w, dt_fim_w, dt_fim_cih_w, null, /*dt_suspensao_w */
					  null, /*dt_lib_suspensao_w */
					  null, /*nr_seq_cpoe_anterior_w */
					  nr_dia_util_aux_w, ie_tratamento_vig_w, qt_dias_liberado_w) INTO STRICT 
					  nr_dia_util_aux_w, ie_tratamento_vig_w, qt_dias_liberado_w;

		/* Justificativa Novo ciclo iniciado */

		if (coalesce(ds_justificativa_w, 'XPTO') = 'XPTO') then
			ds_justificativa_w := wheb_mensagem_pck.get_texto(346895);
		end if;
    end if;

  select  coalesce(max(ie_glicose), 'N')
  into STRICT  ie_glicose_w
  from  material
  where cd_material = cd_material_w;

  if (ie_glicose_w = 'S' and coalesce(qt_vig_p::text, '') = '') then
    qt_dose_w := null;
  end if;

  ie_use_item_types_w := obter_param_usuario(2314, 46, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_use_item_types_w);
  if (coalesce(ie_use_item_types_w, 'N') = 'S') then
    select ie_drug_info
    into STRICT   ie_drug_info_w
    from   cpoe_order_unit
    where  nr_sequencia = nr_seq_cpoe_order_unit_p;

    select
      ie_via_aplicacao
      ,nr_seq_grupo_interval
      ,nr_seq_subgrupo_interval
      ,cd_intervalo
      ,dt_inicio
      ,dt_fim
      ,ds_horarios
      ,ie_segunda
      ,ie_terca
      ,ie_quarta
      ,ie_quinta
      ,ie_sexta
      ,ie_sabado
      ,ie_domingo
    into STRICT
      ie_via_aplicacao_rp_w
      ,nr_seq_grupo_interval_rp_w
      ,nr_seq_subgrupo_interval_rp_w
      ,cd_intervalo_rp_w
      ,dt_inicio_rp_w
      ,dt_fim_rp_w
      ,ds_horarios_rp_w
      ,ie_segunda_rp_w
      ,ie_terca_rp_w
      ,ie_quarta_rp_w
      ,ie_quinta_rp_w
      ,ie_sexta_rp_w
      ,ie_sabado_rp_w
      ,ie_domingo_rp_w
    from cpoe_rp
    where  nr_sequencia = nr_seq_cpoe_rp_p;

	ie_duracao_rp_w := 'P';

  end if;

  ds_orientacao_preparo_w := substr(CPOE_Obter_Diluicao_Medic(nr_atendimento_p, cd_paciente_p, cd_material_w, qt_dose_w, cd_unidade_medida_w, cd_intervalo_w,
                                          ie_via_aplicacao_w, null, hr_min_aplicacao_w, ie_se_necessario_w,
                                          ie_fator_correcao_w, ie_bomba_infusao_w, nr_seq_dil_w, cd_mat_dil_w, qt_dose_dil_w, cd_unid_med_dose_dil_w, qt_solucao_dil_w, nr_seq_red_w, cd_mat_red_w,
                                          qt_dose_red_w, cd_unid_med_dose_red_w, qt_solucao_red_w, nr_seq_recons_w, cd_mat_recons_w, qt_dose_recons_w,
                                          cd_unid_med_dose_recons_w, null, null, null, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p), 1, 2000);

    if (obtain_user_locale(nm_usuario_p) = 'ja_JP') then
      qt_dose_ref_w := qt_dose_w;
      SELECT * FROM cpoe_get_dose_or_daily_dose(coalesce(ie_via_aplicacao_rp_w,ie_via_aplicacao_w), coalesce(cd_intervalo_rp_w,cd_intervalo_w), qt_dose_ref_w, qt_dose_dia_w) INTO STRICT qt_dose_ref_w, qt_dose_dia_w;
    end if;

    insert into cpoe_material(nr_sequencia,
      cd_material,
      cd_unidade_medida,
      qt_dose,
      qt_dose_dia,
      qt_dose_total_periodo,
      dt_atualizacao,
      cd_intervalo,
      nm_usuario,
      ds_horarios,
      dt_atualizacao_nrec,
      nm_usuario_nrec,
      ie_via_aplicacao,
      ie_urgencia,
      ie_bomba_infusao,
      hr_prim_horario,
      ds_justificativa,
      qt_dias_solicitado,
      ie_se_necessario,
      ie_aplic_bolus,
      ie_aplic_lenta,
      ie_acm,
      nr_atendimento,
      cd_pessoa_fisica,
      qt_hora_aplicacao,
      qt_min_aplicacao,
      hr_min_aplicacao,
      ie_objetivo,
      ie_origem_infeccao,
      cd_topografia_cih,
      cd_amostra_cih,
      cd_microorganismo_cih,
      ie_uso_antimicrobiano,
      ie_indicacao,
      ie_lado,
      ie_medicacao_paciente,
      ie_duracao,
      dt_inicio,
      ds_observacao,
      ie_fator_correcao,
      ie_administracao,
      qt_solucao_dil,
      cd_mat_dil,
      qt_dose_dil,
      cd_unid_med_dose_dil,
      qt_solucao_red,
      qt_dose_red,
      cd_mat_red,
      cd_unid_med_dose_red,
      cd_mat_recons,
      cd_unid_med_dose_recons,
      qt_dose_recons,
      nr_ocorrencia,
      ie_controle_tempo,
      cd_perfil_ativo,
      qt_tempo_aplicacao,
      ds_dose_diferenciada,
      ie_material,
      cd_funcao_origem,
      cd_protocolo,
      nr_seq_protocolo,
      nr_seq_mat_protocolo,
      ie_antibiotico,
      nr_seq_pend_pac_acao,
      dt_fim,
      nr_seq_transcricao,
      ie_item_alta,
      ie_prescritor_aux,
      cd_medico,
      ie_retrogrado,
      ie_futuro,
      nr_seq_pepo,
      nr_cirurgia,
      nr_cirurgia_patologia,
      nr_seq_agenda,
      ie_oncologia,
      nr_seq_conclusao_apae,
      ie_forma_geracao,
      ie_evento_unico,
      ds_orientacao_preparo,
      qt_dose_terapeutica,
      cd_unid_medic_terap,
      qt_dias_liberado,
      dt_fim_cih,
      nr_dia_util,
      nr_seq_receita_amb,
      qt_dose_ataque,
      qt_dose_adicional,
      ie_dose_ataque,
      ie_dose_adicional,
      dt_adm_adicional,
	  nr_seq_mat_diluicao,
	  qt_solucao,
	  qt_vel_inf_glicose,
	  ie_prescription_type,
	  nr_seq_cpoe_rp,
	  nr_seq_cpoe_order_unit,
	  ie_drug_info,
	  ds_dose_diferenciada_dil,
	  ds_dose_diferenciada_red,
	  ds_dose_diferenciada_rec,
	  nr_seq_grupo_interval,
	  nr_seq_subgrupo_interval,
	  ie_segunda,
	  ie_terca,
	  ie_quarta,
	  ie_quinta,
	  ie_sexta ,
	  ie_sabado,
  	  ie_domingo
    )
    values (nr_seq_item_gerado_p,
      cd_material_w,
      cd_unidade_medida_w,
      qt_dose_w,
      qt_dose_dia_w,
      qt_total_dose_p,
      clock_timestamp(),
      coalesce(cd_intervalo_rp_w,cd_intervalo_w),
      nm_usuario_p,
      coalesce(ds_horarios_rp_w,ds_horarios_w),
      clock_timestamp(),
      nm_usuario_p,
      coalesce(ie_via_aplicacao_rp_w,ie_via_aplicacao_w),
      ie_urgencia_w,
      ie_bomba_infusao_w,
      hr_prim_horario_w,
      ds_justificativa_w,
      coalesce(qt_dias_prev_util_w,qt_dias_prev_w),
      ie_se_necessario_w,
      ie_aplic_bolus_w,
      ie_aplic_lenta_w,
      ie_acm_w,
      nr_atendimento_p,
      cd_paciente_p,
      qt_hora_aplicacao_w,
      qt_minuto_aplicacao_w,
      hr_min_aplicacao_w,
      ie_objetivo_w,
      ie_origem_infeccao_w,
      cd_topografia_cih_w,
      cd_amostra_cih_w,
      cd_microorganismo_cih_w,
      ie_uso_antimicrobiano_w,
      ie_indicacao_w,
      ie_lado_w,
      ie_medicacao_paciente_w,
      coalesce(ie_duracao_rp_w,ie_duracao_w),
      coalesce(dt_inicio_rp_w, dt_inicio_w),
      ds_observacao_w,
      ie_fator_correcao_w,
      ie_administracao_w,
      qt_solucao_dil_w,
      cd_mat_dil_w,
      qt_dose_dil_w,
      cd_unid_med_dose_dil_w,
      qt_solucao_red_w,
      qt_dose_red_w,
      cd_mat_red_w,
      cd_unid_med_dose_red_w,
      cd_mat_recons_w,
      cd_unid_med_dose_recons_w,
      qt_dose_recons_w,
      nr_ocorrencia_w,
      'N',
      cd_perfil_p,
      24,
      ds_dose_diferenciada_w,
      'N',
      2314,
      cd_protocolo_p,
      nr_seq_protocolo_p,
      coalesce(nr_seq_produto_p,nr_seq_mat_protocolo_w),
      ie_antibiotico_w,
      nr_seq_pend_pac_acao_p,
      coalesce(dt_fim_rp_w,dt_fim_w),
      nr_seq_transcricao_p,
      ie_item_alta_p,
      ie_prescritor_aux_p,
      cd_medico_p,
      ie_retrogrado_p,
      ie_futuro_p,
      nr_seq_pepo_p,
      nr_cirurgia_p,
      nr_cirurgia_patologia_p,
      nr_seq_agenda_p,
      ie_oncologia_p,
      nr_seq_conclusao_apae_p,
      ie_forma_geracao_p,
      ie_evento_unico_w,
      ds_orientacao_preparo_w,
      qt_dose_terapeutica_p,
      cd_unid_medic_terap_p,
      qt_dias_liberado_w,
      dt_fim_cih_w,
      nr_dia_util_aux_w,
      nr_seq_receita_amb_p,
      qt_dose_especial_w,
      qt_dose_adicional_w,
      ie_dose_ataque_w,
      ie_dose_adicional_w,
      dt_adm_adicional_w,
	  nr_seq_dil_w,
	  qt_solucao_w,
	  qt_vig_p,
	  ie_prescription_type_p,
	  nr_seq_cpoe_rp_p,
	  nr_seq_cpoe_order_unit_p,
	  ie_drug_info_w,
	  ds_dose_diferenciada_dil_w,
	  ds_dose_diferenciada_red_w,
	  ds_dose_diferenciada_rec_w,
	  nr_seq_grupo_interval_rp_w,
	  nr_seq_subgrupo_interval_rp_w,
	  ie_segunda_rp_w,
	  ie_terca_rp_w,
	  ie_quarta_rp_w,
	  ie_quinta_rp_w,
	  ie_sexta_rp_w,
	  ie_sabado_rp_w,
	  ie_domingo_rp_w);

     commit;
     CALL cpoe_consis_med_insert(nr_seq_item_gerado_p,nm_usuario_p);
    open C02;
    loop
        fetch C02 into
        cd_mat_comp_w,
          cd_unid_med_dose_comp_w,
        qt_dose_comp_w,
        qt_dose_peso_comp_w,
        ie_arredondar_comp_w,
        nr_seq_comp_w;
        EXIT WHEN NOT FOUND; /* apply on C02 */
        begin

      if (qt_dose_peso_comp_w > 0) and (qt_peso_p > 0) then

        qt_dose_comp_w := qt_dose_peso_comp_w * qt_peso_p;

        if (upper(cd_unid_med_dose_comp_w) = 'GTS') then
          qt_dose_comp_w := round(qt_dose_comp_w);
        elsif (ie_arredondar_comp_w = 'S') then
          qt_dose_comp_w := arredondamento(qt_dose_comp_w, 1, 'R');
        end if;
      end if;

      qt_dose_limite_comp_w := coalesce(cpoe_obter_dose_maxima(cd_estabelecimento_p,
                                cd_mat_comp_w,
                                cd_unid_med_dose_comp_w,
                                qt_dose_comp_w,
                                ie_via_aplicacao_w,
                                cd_setor_atendimento_p,
                                nr_seq_agrupamento_p,
                                cd_prescritor_p,
                                qt_idade_dia_p,
                                qt_idade_mes_p,
                                qt_idade_ano_p,
                                qt_peso_p), 0);

      if (qt_dose_limite_comp_w > 0) then
        qt_dose_comp_w := qt_dose_limite_comp_w;
      end if;

      CALL exec_sql_dinamico_bv('CPOE',
                ' update  cpoe_material ' ||
                ' set    cd_mat_comp' || nr_seq_comp_w ||
                ' = :cd_mat_comp_w, ' ||
                '       qt_dose_comp' || nr_seq_comp_w ||
                ' = :qt_dose_comp_w, ' ||
                '       cd_unid_med_dose_comp' ||
                nr_seq_comp_w ||
                ' = :cd_unid_med_dose_comp_w ' ||
                ' where    nr_sequencia = :nr_seq_item_gerado_p ',
                'cd_mat_comp_w=' || cd_mat_comp_w ||
                '#@#@qt_dose_comp_w=' || qt_dose_comp_w ||
                '#@#@cd_unid_med_dose_comp_w=' ||
                cd_unid_med_dose_comp_w ||
                '#@#@nr_seq_item_gerado_p=' ||
                nr_seq_item_gerado_p || '#@#@');
        end;
    end loop;
    close C02;

    CALL cpoe_gerar_plano_protocolo(nr_atendimento_p,
                   dt_fim_presc_p,
                   nr_seq_item_gerado_p,
                   nm_usuario_p,
                   'M');

    CALL cpoe_utils_pck.set_list_itens(nr_seq_item_gerado_p, 'M');
    end;
  end loop;
  close c01;

  commit;

exception
   when others then
  rollback;

  ds_stack_w  := substr(dbms_utility.format_call_stack,1,2000);
  ds_log_cpoe_w := substr('CPOE_GERAR_PROT_MEDICAMENTO '
    || chr(13) || ' - cd_estabelecimento_p: ' || cd_estabelecimento_p
    || chr(13) || ' - cd_perfil_p: ' || cd_perfil_p
    || chr(13) || ' - nm_usuario_p: ' || nm_usuario_p
    || chr(13) || ' - cd_protocolo_p: ' || cd_protocolo_p
    || chr(13) || ' - nr_seq_protocolo_p: ' || nr_seq_protocolo_p
    || chr(13) || ' - nr_seq_produto_p: ' || nr_seq_produto_p
    || chr(13) || ' - nr_atendimento_p: ' || nr_atendimento_p
    || chr(13) || ' - cd_paciente_p: ' || cd_paciente_p
    || chr(13) || ' - cd_prescritor_p: ' || cd_prescritor_p
    || chr(13) || ' - cd_setor_atendimento_p: ' || cd_setor_atendimento_p
    || chr(13) || ' - nr_seq_agrupamento_p: ' || nr_seq_agrupamento_p
    || chr(13) || ' - qt_idade_dia_p: ' || qt_idade_dia_p
    || chr(13) || ' - qt_idade_mes_p: ' || qt_idade_mes_p
    || chr(13) || ' - qt_idade_ano_p: ' || qt_idade_ano_p
    || chr(13) || ' - qt_peso_p: ' || qt_peso_p
    || chr(13) || ' - nr_seq_item_gerado_p: ' || nr_seq_item_gerado_p
    || chr(13) || ' - nr_seq_pend_pac_acao_p: ' || nr_seq_pend_pac_acao_p
    || chr(13) || ' - nr_seq_transcricao_p: ' || nr_seq_transcricao_p
    || chr(13) || ' - ie_item_alta_p: ' || ie_item_alta_p
    || chr(13) || ' - ie_prescritor_aux_p: ' || ie_prescritor_aux_p
    || chr(13) || ' - cd_medico_p: ' || cd_medico_p
    || chr(13) || ' - ie_retrogrado_p: ' || ie_retrogrado_p
    || chr(13) || ' - ie_futuro_p: ' || ie_futuro_p
    || chr(13) || ' - dt_inicio_p: ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_inicio_p,'timestamp',ESTABLISHMENT_TIMEZONE_UTILS.gettimezone)
    || chr(13) || ' - nr_seq_pepo_p: ' || nr_seq_pepo_p
    || chr(13) || ' - nr_cirurgia_p: ' || nr_cirurgia_p
    || chr(13) || ' - nr_cirurgia_patologia_p: ' || nr_cirurgia_patologia_p
    || chr(13) || ' - nr_seq_agenda_p: ' || nr_seq_agenda_p
    || chr(13) || ' - ie_oncologia_p: ' || ie_oncologia_p
    || chr(13) || ' - nr_seq_conclusao_apae_p: ' || nr_seq_conclusao_apae_p
    || chr(13) || ' - ie_forma_geracao_p: ' || ie_forma_geracao_p
    || chr(13) || ' - dt_fim_presc_p: ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_fim_presc_p,'timestamp',ESTABLISHMENT_TIMEZONE_UTILS.gettimezone)
    || chr(13) || ' - dt_inicio_presc_p: ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_inicio_presc_p,'timestamp',ESTABLISHMENT_TIMEZONE_UTILS.gettimezone)
    || chr(13) || ' - cd_unidade_medida_p: ' || cd_unidade_medida_p
    || chr(13) || ' - qt_dose_p: ' || qt_dose_p
    || chr(13) || ' - cd_intervalo_p: ' || cd_intervalo_p
    || chr(13) || ' - qt_dose_terapeutica_p: ' || qt_dose_terapeutica_p
    || chr(13) || ' - cd_unid_medic_terap_p: ' || cd_unid_medic_terap_p
    || chr(13) || ' - nr_seq_receita_amb: ' || nr_seq_receita_amb_p
    || chr(13) || ' - ie_prescription_type_p: ' || ie_prescription_type_p
    || chr(13) || ' - ERRO: ' || sqlerrm
    || chr(13) || ' - FUNCAO('||to_char(obter_funcao_ativa)||'); PERFIL('||to_char(obter_perfil_ativo)||')',1,2000);

  insert into log_cpoe(
    nr_sequencia,
    nr_atendimento,
    dt_atualizacao,
    nm_usuario,
    ds_log,
    ds_stack)
  values (
    nextval('log_cpoe_seq'),
    nr_atendimento_p,
    clock_timestamp(),
    nm_usuario_p,
    ds_log_cpoe_w,
    ds_stack_w);

  commit;

  CALL wheb_mensagem_pck.exibir_mensagem_abort(sqlerrm);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_prot_medicamento ( cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_protocolo_p bigint, nr_seq_protocolo_p bigint, nr_seq_produto_p bigint, nr_atendimento_p bigint, cd_paciente_p text, cd_prescritor_p text, cd_setor_atendimento_p bigint, nr_seq_agrupamento_p bigint, qt_idade_dia_p bigint, qt_idade_mes_p bigint, qt_idade_ano_p bigint, qt_peso_p bigint, nr_seq_item_gerado_p INOUT cpoe_material.nr_sequencia%type, nr_seq_pend_pac_acao_p bigint default null, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, ie_oncologia_p text default 'N', nr_seq_conclusao_apae_p bigint default null, ie_forma_geracao_p text default null, dt_fim_presc_p timestamp default null, dt_inicio_presc_p timestamp default null, cd_unidade_medida_p cpoe_material.cd_unidade_medida%type default null, qt_dose_p cpoe_material.qt_dose%type default null, cd_intervalo_p cpoe_material.cd_intervalo%type default null, qt_dose_terapeutica_p cpoe_material.qt_dose_terapeutica%type default null, cd_unid_medic_terap_p cpoe_material.cd_unid_medic_terap%type default null, ie_futuro_p text default 'N', nr_seq_receita_amb_p bigint default null, qt_vig_p bigint default null, ie_prescription_type_p cpoe_material.ie_prescription_type%type default null, nr_seq_cpoe_rp_p cpoe_material.nr_seq_cpoe_rp%type default null, nr_seq_cpoe_order_unit_p cpoe_material.nr_seq_cpoe_order_unit%type default null, qt_total_dose_p bigint default null) FROM PUBLIC;

