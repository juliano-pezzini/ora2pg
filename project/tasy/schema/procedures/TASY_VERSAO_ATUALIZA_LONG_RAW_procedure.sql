-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_versao_atualiza_long_raw (nm_tabela_p text, ds_condicao_p text) AS $body$
DECLARE


ds_cur_comando_w    varchar(4000);
v_rowcont_w         bigint;
ds_comando_w        varchar(2000);
QT_REG_ORIG_W       bigint;
ds_virgula_w        varchar(01);
ds_restricao_w		varchar(4000);
ds_update_w		    varchar(4000);
ds_update2_w		varchar(4000);
ds_select_w         varchar(2000);
retorno_w			integer;
c001			    integer;
c002			    integer;
c003			    integer;
nm_atrib_w          tabela_Atributo.nm_atributo%type;
nm_atrib_pk_w       tabela_Atributo.nm_atributo%type;
nr_seq_w            tasy_padrao_imagem.nr_sequencia%type;

/*TIPOS DE COLUNAS*/

dtab_w        dbms_sql.desc_tab;
col_cnt_w     integer;
l_date_w      timestamp;
l_long_raw_w bytea;
vl_parametro_w varchar(32764);


cur_w REFCURSOR;


BEGIN
    ds_comando_w	:= 'Select count(*) from TASY_VERSAO.'|| nm_tabela_p||' a ' ||ds_condicao_p;	
    qt_reg_orig_w := Obter_valor_Dinamico(ds_comando_w, qt_reg_orig_w);

    if (qt_reg_orig_w > 0) then	
        select a.nm_atributo into STRICT nm_atrib_w from tabela_atributo a
        where a.nm_tabela = nm_tabela_p and a.ie_atualizar_versao = 'S' and a.ie_tipo_atributo = 'LONG RAW';

        ds_cur_comando_w := 'SELECT nm_atributo FROM TASY_VERSAO.tabela_atributo '||
        'WHERE nm_tabela = :nm_tabela_p AND ie_tipo_atributo <> ''FUNCTION'' AND ie_atualizar_versao = ''S'' order by nr_sequencia_criacao';
        
        open cur_w for EXECUTE ds_cur_comando_w using nm_tabela_p;
        loop
            v_rowcont_w := cur_w%ROWCOUNT;
            fetch cur_w into nm_atrib_pk_w;
            EXIT WHEN NOT FOUND; /* apply on cur_w */

            if (obter_se_atrib_constraint(nm_tabela_p, nm_atrib_pk_w, 'PK') = 'S') then
                ds_restricao_w := ds_restricao_w || ' AND ' || nm_atrib_pk_w || ' = :' || nm_atrib_pk_w;
                ds_select_w	:= ds_select_w || ds_virgula_w || 'a.' || nm_atrib_pk_w;
                ds_virgula_w := ',';
            end if;
        end loop;
        ds_update_w := 'update '||nm_tabela_p||' set '||nm_atrib_w||' = :'||nm_atrib_w||' where 1=1 '||ds_restricao_w;
        ds_comando_w := 'select a.nr_sequencia, a.'||nm_atrib_w||' from TASY_VERSAO.'||nm_tabela_p||' a '||ds_condicao_p;

        c001 := dbms_SQL.open_cursor;
        DBMS_SQL.PARSE(C001, ds_comando_w, dbms_sql.Native);
        dbms_sql.define_column(c001,1,nr_seq_w);
        dbms_sql.define_column_raw(c001,2,l_long_raw_w,32767);
        retorno_w := DBMS_SQL.execute(c001);

        c002 := dbms_sql.open_cursor;
        DBMS_SQL.PARSE(C002, ds_update_w, dbms_sql.Native);

        while(dbms_sql.FETCH_ROWS(c001) > 0) loop
            DBMS_SQL.COLUMN_VALUE(c001, 1, nr_seq_w);
            dbms_sql.column_value_raw(c001, 2, l_long_raw_w);
            
            dbms_sql.bind_variable_raw(c002,nm_atrib_w,l_long_raw_w,32767);
            dbms_sql.bind_variable(c002,'nr_sequencia',nr_seq_w);
            retorno_w := DBMS_SQL.execute(c002);
        end loop;

        DBMS_SQL.close_cursor(c002);
        DBMS_SQL.close_cursor(c001);

        commit;
    end if;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_versao_atualiza_long_raw (nm_tabela_p text, ds_condicao_p text) FROM PUBLIC;

