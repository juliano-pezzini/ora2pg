-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE confirmar_item_cotacao_integr ( nr_ordem_compra_p bigint, nr_cot_compra_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_cot_compra_w			bigint;
nr_item_cot_compra_w		bigint;			
nr_ordem_compra_w			ordem_compra.nr_ordem_compra%type;
						
c01 CURSOR FOR 
SELECT	distinct 
		nr_cot_compra, 
		nr_item_cot_compra 
from	ordem_compra_item 
where	nr_ordem_compra = nr_ordem_compra_w;

c02 CURSOR FOR 
SELECT 	distinct 
		nr_ordem_compra 
from 	ordem_compra 
where 	obter_cot_compra_ordem(nr_ordem_compra,null) = nr_cot_compra_p 
and		(dt_aprovacao IS NOT NULL AND dt_aprovacao::text <> '');
						

BEGIN 
 
nr_ordem_compra_w := nr_ordem_compra_p;
 
if (coalesce(nr_ordem_compra_w,0) > 0) then 
	open C01;
	loop 
	fetch C01 into	 
		nr_cot_compra_w, 
		nr_item_cot_compra_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		update	cot_compra_item 
		set	ie_confirmado_integr = 'S' 
		where	nr_cot_compra = nr_cot_compra_w 
		and	nr_item_cot_compra = nr_item_cot_compra_w;
		end;
	end loop;
	close C01;
else 
	open C02;
	loop 
	fetch C02 into 
			nr_ordem_compra_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		 
		open C01;
		loop 
		fetch C01 into	 
			nr_cot_compra_w, 
			nr_item_cot_compra_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin 
			update	cot_compra_item 
			set	ie_confirmado_integr = 'S' 
			where	nr_cot_compra = nr_cot_compra_w 
			and	nr_item_cot_compra = nr_item_cot_compra_w;
			end;
		end loop;
		close C01;
		end;
	end loop;
	close C02;
	 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE confirmar_item_cotacao_integr ( nr_ordem_compra_p bigint, nr_cot_compra_p bigint, nm_usuario_p text) FROM PUBLIC;

