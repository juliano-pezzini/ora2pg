-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_necessidade_disp_kit ( cd_perfil_p bigint, cd_estabelecimento_p bigint, nr_seq_horario_p bigint, nr_seq_motivo_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
qt_total_dispensar_w	double precision;
qt_dispensar_hor_w	double precision;
nr_ocorrencia_w		double precision;
nr_prescricao_w		bigint;
nr_seq_classif_w	bigint;
nr_seq_evento_w		bigint;
nr_seq_lote_w		bigint;
nr_atendimento_w	bigint;
nr_seq_material_w	integer;
cd_material_w		integer;
dt_horario_w		timestamp;
ie_hr_dose_especial_w	varchar(1):= 'N';
	

BEGIN 
 
select	max(nr_prescricao), 
	max(nr_seq_material), 
	max(dt_horario), 
	max(cd_material) 
into STRICT	nr_prescricao_w, 
	nr_seq_material_w, 
	dt_horario_w, 
	cd_material_w 
from	prescr_mat_hor 
where	nr_sequencia = nr_seq_horario_p;
 
select	max(nr_atendimento) 
into STRICT	nr_atendimento_w 
from	prescr_medica 
where	nr_prescricao = nr_prescricao_w;
 
update	prescr_mat_hor 
set	ie_gerar_lote = 'S' 
where	nr_sequencia = nr_seq_horario_p;
 
select	coalesce(max(qt_total_dispensar),0), 
	coalesce(max(nr_ocorrencia),0), 
	CASE WHEN coalesce(max(hr_dose_especial),'N')='N' THEN 'N'  ELSE 'S' END  
into STRICT	qt_total_dispensar_w, 
	nr_ocorrencia_w, 
	ie_hr_dose_especial_w 
from	prescr_material 
where	nr_prescricao = nr_prescricao_w 
and	nr_sequencia = nr_seq_material_w;
 
if (qt_total_dispensar_w > 0) and (nr_ocorrencia_w IS NOT NULL AND nr_ocorrencia_w::text <> '') then	 
 
	if (ie_hr_dose_especial_w <> 'N') then 
		nr_ocorrencia_w := nr_ocorrencia_w + 1;
	end if;	
	 
	qt_dispensar_hor_w := coalesce(dividir(qt_total_dispensar_w, nr_ocorrencia_w),0);
	 
	if (qt_dispensar_hor_w > 0) then				 
		update	prescr_mat_hor 
		set	qt_dispensar_hor = qt_dispensar_hor_w 
		where	nr_sequencia = nr_seq_horario_p;
	end if;		
end if;
 
select	coalesce(max(nr_seq_lote),0) 
into STRICT	nr_seq_lote_w 
from	prescr_mat_hor 
where	nr_sequencia = nr_seq_horario_p;
 
if (nr_seq_lote_w > 0) then 
	select	coalesce(max(nr_seq_classif),0) 
	into STRICT	nr_seq_classif_w 
	from	ap_lote 
	where	nr_sequencia = nr_seq_lote_w;
	 
	if (nr_seq_classif_w > 0) then 
		update	prescr_mat_hor 
		set	nr_seq_classif = nr_seq_classif_w 
		where	nr_sequencia = nr_seq_horario_p;
	end if;		
end if;
	 
select	nextval('prescr_mat_alteracao_seq') 
into STRICT	nr_seq_evento_w
;
	 
INSERT INTO prescr_mat_alteracao(nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			nr_prescricao, 
			nr_seq_prescricao, 
			nr_seq_horario, 
			dt_alteracao, 
			cd_pessoa_fisica, 
			ie_alteracao, 
			ds_justificativa, 
			ds_observacao, 
			ie_tipo_item, 
			dt_horario, 
			nr_atendimento, 
			cd_item, 
			cd_medico_solic, 
			ie_mostra_adep, 
			nr_seq_assinatura, 
			nr_seq_lote, 
			cd_funcao, 
			nr_seq_mot_lote_gedipa) 
		VALUES (nr_seq_evento_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			nr_prescricao_w, 
			nr_seq_material_w, 
			nr_seq_horario_p, 
			clock_timestamp(), 
			obter_dados_usuario_opcao(nm_usuario_p,'C'), 
			51, 
			null, 
			null, 
			'M', 
			dt_horario_w, 
			nr_atendimento_w, 
			cd_material_w, 
			null, 
			'S', 
			null, 
			nr_seq_lote_w, 
			coalesce(obter_funcao_ativa,1113), 
			nr_seq_motivo_p);
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_necessidade_disp_kit ( cd_perfil_p bigint, cd_estabelecimento_p bigint, nr_seq_horario_p bigint, nr_seq_motivo_p bigint, nm_usuario_p text) FROM PUBLIC;

