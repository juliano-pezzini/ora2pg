-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_mat_exclui_proc_pacote ( nr_seq_autorizacao_p bigint, nr_seq_autor_conv_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ie_pacote_w		varchar(1);
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
cd_convenio_w		integer;
nr_seq_pacote_w		bigint;
cd_setor_atendimento_w	integer;
ie_tipo_atendimento_w	smallint;
cd_material_w		integer;
cd_material_ww		integer := 0;
cd_grupo_material_w	smallint;
cd_subgrupo_material_w	smallint;
cd_classe_material_w	smallint;
nr_seq_familia_w		bigint;
qt_idade_paciente_w	smallint;
cd_pessoa_fisica_w	varchar(10);
ie_sexo_w		varchar(1);
nr_seq_agenda_w		bigint;

C01 CURSOR FOR 
	SELECT	b.nr_seq_pacote 
	from 	pacote b, 
		pacote_material a 
	where	a.nr_seq_pacote = b.nr_seq_pacote 
	and	b.cd_proced_pacote = cd_procedimento_w 
	and 	b.ie_origem_proced = ie_origem_proced_w 
	and 	b.cd_convenio = cd_convenio_w 
	and 	b.cd_estabelecimento = cd_estabelecimento_p 
	and	((coalesce(a.cd_setor_atendimento::text, '') = '') or (cd_setor_atendimento_w = a.cd_setor_atendimento)) 
	and	((coalesce(a.ie_tipo_atendimento::text, '') = '') or (a.ie_tipo_atendimento = ie_tipo_atendimento_w)) 
	and	coalesce(a.cd_grupo_material, cd_grupo_material_w) = cd_grupo_material_w 
	and	coalesce(a.cd_subgrupo_material, cd_subgrupo_material_w) = cd_subgrupo_material_w 
	and	coalesce(a.cd_classe_material, cd_classe_material_w) = cd_classe_material_w 
	and	coalesce(a.cd_material, cd_material_w) = cd_material_w 
	and	coalesce(a.nr_seq_familia, nr_seq_familia_w) = nr_seq_familia_w 
	and	qt_idade_paciente_w between coalesce(a.qt_idade_min, 0) and coalesce(a.qt_idade_max, 999) 
	and	coalesce(a.ie_sexo, coalesce(ie_sexo_w,'A')) = coalesce(ie_sexo_w,'A') 
	and	a.ie_inclui_exclui = 'E' 
	and	b.ie_situacao = 'A';

C02 CURSOR FOR 
	SELECT	distinct 
		cd_material 
	from	material_autor_cirurgia 
	where	nr_seq_autorizacao = nr_seq_autorizacao_p;


BEGIN 
 
delete	from w_pacote_mat_autor_conv 
where	nm_usuario = nm_usuario_p;
 
select	max(cd_procedimento_principal), 
	max(ie_origem_proced), 
	max(cd_convenio), 
	max(obter_setor_atendimento(nr_atendimento)), 
	max(nr_seq_agenda) 
into STRICT	cd_procedimento_w, 
	ie_origem_proced_w, 
	cd_convenio_w, 
	cd_setor_atendimento_w, 
	nr_seq_agenda_w 
from	autorizacao_convenio 
where	nr_sequencia = nr_seq_autor_conv_p;
 
select	max(ie_tipo_atendimento), 
	max(cd_pessoa_fisica) 
into STRICT	ie_tipo_atendimento_w, 
	cd_pessoa_fisica_w 
from	agenda_paciente 
where	nr_sequencia = nr_seq_agenda_w;
 
if (coalesce(cd_pessoa_fisica_w::text, '') = '') then 
	 
	select	max(cd_pessoa_fisica) 
	into STRICT	cd_pessoa_fisica_w 
	from	autorizacao_cirurgia 
	where	nr_sequencia = nr_seq_autorizacao_p;
 
end if;
 
select	max(obter_idade(dt_nascimento, clock_timestamp(), 'A')), 
	coalesce(max(ie_sexo),'A') 
into STRICT	qt_idade_paciente_w, 
	ie_sexo_w 
from	pessoa_fisica 
where	cd_pessoa_fisica = cd_pessoa_fisica_w;
 
select	coalesce(max(substr(obter_se_pacote_convenio(cd_procedimento_w, ie_origem_proced_w, cd_convenio_w, cd_estabelecimento_p),1,3)),'N') 
into STRICT	ie_pacote_w
;
 
if (ie_pacote_w = 'S') then 
 
	open C02;
	loop 
	fetch C02 into	 
		cd_material_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		 
		select	max(cd_grupo_material), 
			max(cd_subgrupo_material), 
			max(cd_classe_material), 
			coalesce(max(nr_seq_familia),0) 
		into STRICT	cd_grupo_material_w, 
			cd_subgrupo_material_w, 
			cd_classe_material_w, 
			nr_seq_familia_w 
		from	estrutura_material_v 
		where	cd_material = cd_material_w;
		 
		open C01;
		loop 
		fetch C01 into	 
			nr_seq_pacote_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin 
			 
			if (cd_material_w <> cd_material_ww) then 
				 
				cd_material_ww := cd_material_w;
				 
				insert into w_pacote_mat_autor_conv(	 
					nr_sequencia, 
					dt_atualizacao, 
					nm_usuario, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec, 
					nr_seq_pacote, 
					cd_material, 
					ie_exclui_pacote) 
				values (	nextval('w_pacote_mat_autor_conv_seq'), 
					clock_timestamp(), 
					nm_usuario_p, 
					clock_timestamp(), 
					nm_usuario_p, 
					nr_seq_pacote_w, 
					cd_material_ww, 
					'S');
			end if;
			 
			end;
		end loop;
		close C01;
		 
		end;
	end loop;
	close C02;
 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_mat_exclui_proc_pacote ( nr_seq_autorizacao_p bigint, nr_seq_autor_conv_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

