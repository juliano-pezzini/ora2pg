-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baixa_aut_solic_compra_item (qt_dias_p bigint, cd_estabelecimento_p bigint, cd_motivo_baixa_p bigint, ds_observacao_p text, nm_usuario_p text) AS $body$
DECLARE


c01 CURSOR(qt_dias_c              bigint,
            cd_estabelecimento_c    bigint) FOR
SELECT  a.nr_solic_compra,
        a.cd_estabelecimento,
        b.nr_item_solic_compra
from    solic_compra a,
        solic_compra_item b
where   a.nr_solic_compra = b.nr_solic_compra
and     a.cd_estabelecimento = cd_estabelecimento_c
and     coalesce(a.dt_autorizacao::text, '') = ''
and     coalesce(a.dt_baixa::text, '') = ''
and     not exists (select 1 from ordem_compra_item where nr_solic_compra = a.nr_solic_compra)
and     coalesce(a.nr_seq_motivo_cancel::text, '') = ''
and     coalesce(a.cd_motivo_baixa::text, '') = ''
and     trunc(a.dt_solicitacao_compra) <= trunc(clock_timestamp()-qt_dias_c);


BEGIN

	For r01 in c01(qt_dias_p, cd_estabelecimento_p) loop
		begin
			CALL baixar_solic_compra_item(r01.nr_solic_compra,
								  r01.nr_item_solic_compra, 
								  nm_usuario_p, 
								  cd_motivo_baixa_p,
                                  ds_observacao_p);
            exception
                when others then
                CALL gerar_historico_solic_compra(r01.nr_solic_compra,
                                                Wheb_mensagem_pck.get_Texto(84871),         /* "Erro" */
                                                substr(WHEB_MENSAGEM_PCK.get_texto(306247) || /* "Erro ao processar a JOB. Favor verificar a tela de processos." */
                                                '. ' ||SQLERRM,1,4000),
                                                null,
                                                nm_usuario_p,
                                                'S');
		end;
	end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baixa_aut_solic_compra_item (qt_dias_p bigint, cd_estabelecimento_p bigint, cd_motivo_baixa_p bigint, ds_observacao_p text, nm_usuario_p text) FROM PUBLIC;

