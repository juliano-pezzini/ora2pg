-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ppm_so_returns ( nr_seq_metrica_p bigint, nr_seq_objetivo_metrica_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, dt_referencia_p timestamp) AS $body$
DECLARE


dt_ref_inicio_w 		timestamp;
dt_ref_fim_w 		timestamp;
vl_resultado_w		double precision;
qt_retornos_w		bigint;
qt_os_encerradas_w	bigint;
nm_usuario_exec_w	usuario.nm_usuario%type;
nr_seq_diretoria_w		ppm_objetivo.nr_seq_diretoria%type;
nr_seq_gerencia_w		ppm_objetivo.nr_seq_gerencia%type;
nr_seq_grupo_w		ppm_objetivo.nr_seq_grupo%type;


BEGIN

dt_ref_inicio_w 	:= pkg_date_utils.start_of(dt_referencia_p,'MONTH');
dt_ref_fim_w 	:= pkg_date_utils.end_of(last_day(dt_referencia_p),'DAY');

select	max(nr_seq_gerencia),
	max(nr_seq_grupo),
	max(nr_seq_diretoria)
into STRICT	nr_seq_gerencia_w,
	nr_seq_grupo_w,
	nr_seq_diretoria_w
from	ppm_objetivo_metrica a,
	ppm_objetivo_meta b,
	ppm_objetivo c
where	a.nr_sequencia	= nr_seq_objetivo_metrica_p
and	a.nr_seq_meta	= b.nr_sequencia
and	b.nr_seq_objetivo	= c.nr_sequencia;

select	max(nm_usuario)
into STRICT	nm_usuario_exec_w
from	usuario x
where	x.cd_pessoa_fisica = cd_pessoa_fisica_p
and		x.ie_situacao	= 'A';

qt_os_encerradas_w	:= 0;

if (nr_seq_grupo_w IS NOT NULL AND nr_seq_grupo_w::text <> '') then
	--busca as oss encerradas com base no indicador j치 utilizado
	select	count(distinct nr_sequencia)
	into STRICT	qt_os_encerradas_w
	from	os_encerrada_gerencia_v a
	where	nr_seq_grupo_des	= nr_seq_grupo_w
	and	dt_fim_real between dt_ref_inicio_w and dt_ref_fim_w;

	select	sum(obter_qt_voltas_os_dev(a.nr_sequencia, b.nr_sequencia, 'G', 3))
	into STRICT	qt_retornos_w
	from	os_encerrada_gerencia_v a,
		grupo_desenvolvimento b
	where	exists (	SELECT	1
			from	man_ordem_log_grupo_des x
			where	x.nr_seq_ordem_serv = a.nr_sequencia
			and	x.nr_seq_grupo_des = b.nr_sequencia)
	and	exists (	select	1
			from	man_ordem_serv_estagio x,
				man_estagio_processo y
			where	x.nr_seq_estagio = y.nr_sequencia
			and	x.nr_seq_ordem = a.nr_sequencia
			and	y.ie_desenv = 'S')
	and	b.nr_sequencia	= nr_seq_grupo_w
	and	a.dt_fim_real between dt_ref_inicio_w and dt_ref_fim_w;

elsif (nr_seq_gerencia_w IS NOT NULL AND nr_seq_gerencia_w::text <> '') then
	--busca as oss encerradas com base no indicador j치 utilizado
	select	count(distinct nr_sequencia)
	into STRICT	qt_os_encerradas_w
	from	os_encerrada_gerencia_v a
	where	nr_seq_gerencia	= nr_seq_gerencia_w
	and	dt_fim_real between dt_ref_inicio_w and dt_ref_fim_w;

	select	sum(obter_qt_voltas_os_dev(a.nr_sequencia, b.nr_sequencia, 'G', 3))
	into STRICT	qt_retornos_w
	from	os_encerrada_gerencia_v a,
		grupo_desenvolvimento b
	where	exists (	SELECT	1
			from	man_ordem_log_grupo_des x
			where	x.nr_seq_ordem_serv = a.nr_sequencia
			and	x.nr_seq_grupo_des = b.nr_sequencia)
	and	exists (	select	1
			from	man_ordem_serv_estagio x,
				man_estagio_processo y
			where	x.nr_seq_estagio = y.nr_sequencia
			and	x.nr_seq_ordem = a.nr_sequencia
			and	y.ie_desenv = 'S')
	and	b.nr_seq_gerencia	= nr_seq_gerencia_w
	and	a.dt_fim_real between dt_ref_inicio_w and dt_ref_fim_w;
elsif (nr_seq_diretoria_w IS NOT NULL AND nr_seq_diretoria_w::text <> '') then

	--busca as oss encerradas com base no indicador j치 utilizado
	select	count(distinct nr_sequencia)
	into STRICT	qt_os_encerradas_w
	from	os_encerrada_gerencia_v a
	where	nr_seq_gerencia in (	SELECT	x.nr_sequencia
					from	gerencia_wheb x
					where	x.nr_seq_diretoria	= nr_seq_diretoria_w)
	and	dt_fim_real between dt_ref_inicio_w and dt_ref_fim_w;	

	select	sum(obter_qt_voltas_os_dev(a.nr_sequencia, b.nr_sequencia, 'G', 3))
	into STRICT	qt_retornos_w
	from	os_encerrada_gerencia_v a,
		grupo_desenvolvimento b
	where	exists (	SELECT	1
			from	man_ordem_log_grupo_des x
			where	x.nr_seq_ordem_serv = a.nr_sequencia
			and	x.nr_seq_grupo_des = b.nr_sequencia)
	and	exists (	select	1
			from	man_ordem_serv_estagio x,
				man_estagio_processo y
			where	x.nr_seq_estagio = y.nr_sequencia
			and	x.nr_seq_ordem = a.nr_sequencia
			and	y.ie_desenv = 'S')
	and	b.nr_seq_gerencia in (	select	x.nr_sequencia
					from	gerencia_wheb x
					where	x.nr_seq_diretoria	= nr_seq_diretoria_w)
	and	a.dt_fim_real between dt_ref_inicio_w and dt_ref_fim_w;
elsif (nm_usuario_exec_w IS NOT NULL AND nm_usuario_exec_w::text <> '') then
	--busca as oss encerradas com base no indicador j치 utilizado
	select	count(distinct nr_seq_ordem_serv)
	into STRICT	qt_os_encerradas_w
	from	w_avaliacao_usuario a
	where	a.dt_referencia between dt_ref_inicio_w and dt_ref_fim_w
	and	a.ie_referencia = 'E'
	and	a.nm_usuario 	= nm_usuario_exec_w;	
	
	select	sum(obter_qt_voltas_os_dev(a.nr_sequencia, nm_usuario_exec_w, 'U', 3))
	into STRICT	qt_retornos_w
	from	os_encerrada_gerencia_v a
	where	a.dt_fim_real between dt_ref_inicio_w and dt_ref_fim_w
	and	exists (	SELECT	1
			from	man_ordem_serv_estagio x
			where	x.nr_seq_ordem = a.nr_sequencia
			and	x.nm_usuario = nm_usuario_exec_w)
	and	exists (	select	1
			from	man_ordem_serv_estagio x,
				man_estagio_processo y
			where	x.nr_seq_estagio = y.nr_sequencia
			and	x.nr_seq_ordem = a.nr_sequencia
			and	y.ie_desenv = 'S');
end if;

if (qt_os_encerradas_w > 0) then
	vl_resultado_w	:= round((dividir( qt_retornos_w, qt_os_encerradas_w ) * 100),2);
else
	vl_resultado_w := 0;
end if;

CALL ppm_gravar_resultado(nr_seq_objetivo_metrica_p, dt_referencia_p, vl_resultado_w, qt_os_encerradas_w, qt_retornos_w, nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ppm_so_returns ( nr_seq_metrica_p bigint, nr_seq_objetivo_metrica_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text, dt_referencia_p timestamp) FROM PUBLIC;

