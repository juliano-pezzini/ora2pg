-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_dados_escala_sepse (( nr_atendimento_p bigint, ie_opcao_p bigint, qt_retorno_p out bigint, ie_regra_p out text, qt_pontuacao_p out bigint, nm_usuario_p text, ie_atributo_p out text, ie_tipo_sepse_p text default 'A') is /*	ie_opcao_p 
SHIFT+F11 > Sepse variáveis deflagradoras
*/
 qt_temp_w real) AS $body$
DECLARE

		
		qt_reg_w		bigint;
		
		
BEGIN
		
		select	count(*)
		into STRICT	qt_reg_w
		from	sepse_atributo a,
				sepse_atributo_cliente b
		where	a.nr_sequencia = b.nr_seq_atributo;
		
		if (qt_reg_w = 0) then
		
			select	coalesce(max(qt_pontuacao),1)
			into STRICT	qt_pont_w
			from	sepse_atributo
			where	nr_sequencia = ie_opcao_p;
						
		else
		
			select	CASE WHEN count(*)=0 THEN 0  ELSE 1 END
			into STRICT	qt_pont_w
			from	sepse_atributo_cliente
			where	nr_seq_atributo = ie_opcao_p
			and	qt_valor_p between coalesce(qt_valor_min,0) and coalesce(qt_valor_max,99999);	
			
		end if;
		
		return;
		end;
	
	procedure obter_exame(nr_seq_exame_p    number,
						  qt_resultado_p    out number,
						  nr_seq_material_p out number,
						  nr_seq_metodo_p   out number) is
		begin
		select  coalesce(max(qt_resultado),-1), max(nr_seq_material), max(nr_seq_metodo)
		into STRICT	qt_resultado_p, nr_seq_material_p, nr_seq_metodo_p
		from
		(SELECT b.qt_resultado, coalesce(b.nr_seq_material,0) nr_seq_material, coalesce(b.nr_seq_metodo,0) nr_seq_metodo
		from 	exame_lab_result_item b,
				exame_lab_resultado a,
				prescr_procedimento x,
				prescr_medica c
		where	a.nr_seq_resultado	= b.nr_seq_resultado
		and		a.nr_prescricao		= c.nr_prescricao
		and		x.nr_sequencia		= b.nr_seq_prescr
		and		x.nr_prescricao		= c.nr_prescricao
		and		b.nr_seq_exame		= nr_seq_exame_p
		and		c.nr_atendimento	= nr_atendimento_p
		--and		x.ie_status_atend	>= 35
		and		((qt_hora_exame_w = 0) or (a.dt_resultado between (clock_timestamp()-(qt_hora_exame_w/24)) and clock_timestamp()))
		order by b.qt_resultado) alias14 LIMIT 1;
				
		if (qt_resultado_p = -1) then
		
			select  coalesce(max(qt_resultado),-1), max(nr_seq_material), max(nr_seq_metodo)
			into STRICT    qt_resultado_p, nr_seq_material_p, nr_seq_metodo_p
			from
			(SELECT b.qt_resultado, coalesce(b.nr_seq_material,0) nr_seq_material, coalesce(b.nr_seq_metodo,0) nr_seq_metodo
			from 	exame_lab_result_item b,
					exame_lab_resultado a
			where	a.nr_seq_resultado	= b.nr_seq_resultado
			and		coalesce(a.nr_prescricao::text, '') = ''
			and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			and		b.nr_seq_exame		= nr_seq_exame_p
			and		a.nr_atendimento	= nr_atendimento_p
			and		((qt_hora_exame_w = 0) or (a.dt_resultado between (clock_timestamp()-(qt_hora_exame_w/24)) and clock_timestamp()))
			order by b.qt_resultado desc) alias16 LIMIT 1;
			
		end if;
		end;
		
	procedure obter_max_data(nr_seq_resultado_p out number, dt_sae_p out date, qt_hora_sae_p out number) is

	dt_prescr_w date;

	begin

	dt_sae_p := null;

	for regras in C07 loop
	
		if (regras.nr_seq_result > 0) then
			if (ie_tipo_sepse_p = 'P') then
				select	max(a.dt_prescricao)
				into STRICT	dt_prescr_w
				from	pe_prescricao a,
						pe_prescr_item_result e
				where	a.nr_sequencia = e.nr_seq_prescr
				and		e.nr_seq_result = regras.nr_seq_result
				and		a.nr_atendimento = nr_atendimento_p
				and		coalesce(a.dt_inativacao::text, '') = ''
				and     (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
				and		((regras.qt_hora_sae = 0) or (a.dt_liberacao between (clock_timestamp()-(regras.qt_hora_sae/24)) and clock_timestamp()));
			else
				select	max(a.dt_prescricao)
				into STRICT	dt_prescr_w
				from	pe_prescricao a,
						pe_prescr_proc b,
						pe_procedimento c,
						pe_item_result_proc d,
						pe_item_resultado e
				where	a.nr_sequencia = b.nr_seq_prescr
				and		b.nr_seq_proc = c.nr_sequencia
				and		coalesce(a.dt_inativacao::text, '') = ''
				and		c.nr_sequencia = d.nr_seq_proc
				and		d.nr_seq_result = e.nr_sequencia
				and		e.nr_sequencia = regras.nr_seq_result
				and		a.nr_atendimento = nr_atendimento_p
				and		((regras.qt_hora_sae = 0) or (a.dt_liberacao between (clock_timestamp()-(regras.qt_hora_sae/24)) and clock_timestamp()));	
			end if;
			
			if (coalesce(dt_sae_p::text, '') = '') or (dt_sae_p < dt_prescr_w) then
				dt_sae_p := dt_prescr_w;
				nr_seq_resultado_p := regras.nr_seq_result;
				qt_hora_sae_p := regras.qt_hora_sae;
			end if;
		end if;

	end loop;

	end;

	procedure obter_max_gp(nr_seq_tipo_p out number, dt_medida_p out date) is

	dt_medida_w date;

	begin

	dt_medida_p := null;

	for regras in C07 loop
		if (regras.nr_seq_tipo > 0) then
			if (ie_opcao_p in (86,91)) then
				dt_medida_w := null;
			elsif (ie_opcao_p = 19) then
				select	max(dt_medida)
				into STRICT	dt_medida_w
				from	atendimento_perda_ganho
				where	nr_seq_tipo = regras.nr_seq_tipo
				and		nr_atendimento = nr_atendimento_p
				and     coalesce(dt_inativacao::text, '') = ''
				and		dt_referencia between clock_timestamp()-(2/24) and clock_timestamp();
			else
				select	max(dt_medida)
				into STRICT	dt_medida_w
				from	atendimento_perda_ganho
				where	nr_seq_tipo = regras.nr_seq_tipo
				and		nr_atendimento = nr_atendimento_p
				and     coalesce(dt_inativacao::text, '') = ''
				and		dt_referencia between clock_timestamp()-(1/24) and clock_timestamp();
			end if;

			if (coalesce(dt_medida_p::text, '') = '') or (dt_medida_p < dt_medida_w) then
				dt_medida_p := dt_medida_w;
				nr_seq_tipo_p := regras.nr_seq_tipo;
			end if;
		end if;

	end loop;

	end;
	
	function Obter_Pontuacao_ped(qt_valor_p	number) return;
		
		begin
		
		select	count(*)
		into STRICT	qt_reg_w
		from	sepse_atributo a,
				sepse_atributo_cliente b
		where	a.nr_sequencia = b.nr_seq_atributo
		and     a.ie_tipo_sepse = 'P';
		
		if (qt_reg_w > 0) then
			select 	count(*) -- Checa se há registro de idade dentro de uma regra de cliente, caso não tenha, usa a geral definida.
			into STRICT	qt_data_cliente_sepse_w
			from 	sepse_atrib_cliente_regra a,
					sepse_atributo_cliente b
			where	b.nr_seq_atributo = ie_opcao_p
			and		a.nr_seq_atrib_cliente = b.nr_sequencia;
			
			if (qt_data_cliente_sepse_w > 0) then
				select 	CASE WHEN count(*)=0 THEN 0  ELSE 1 END
				into STRICT	qt_pont_w
				from 	sepse_atrib_cliente_regra a,
						sepse_atributo_cliente b
				where	a.nr_seq_atrib_cliente = b.nr_sequencia
				and		b.nr_seq_atributo = ie_opcao_p
				and (qt_idade_dia_w between a.qt_idade_min_dias and  a.qt_idade_max_dias
				or (qt_idade_w between a.qt_idade_min and a.qt_idade_max ))
				and (qt_valor_p <= b.qt_valor_min or qt_valor_p >= b.qt_valor_max);
			else
				select CASE WHEN count(*)=0 THEN 0  ELSE 1 END
				into STRICT	qt_pont_w
				from 	sepse_atributo_cliente b,
						sepse_regra_liberacao c
				where 	c.ie_tipo_sepse = 'P'
				and (qt_idade_dia_w BETWEEN c.qt_dias_min and c.qt_dias_max
				or (qt_idade_w BETWEEN c.qt_idade_min and c.qt_idade_max))
				and (qt_valor_p <= b.qt_valor_min or qt_valor_p >= b.qt_valor_max);
			end if;
		end if;
		
		return;
		end;

begin
if (ie_tipo_sepse_p = 'P') then
	ie_regra_p := 'S';
	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_sepsis_cliente_w
	from	sepse_atributo_cliente a,
			sepse_atributo b
	where	a.nr_seq_atributo = b.nr_sequencia
	and		b.ie_tipo_sepse = 'P';
else
	ie_regra_p := 'S';
	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_sepsis_cliente_w
	from	sepse_atributo_cliente a,
			sepse_atributo b
	where	a.nr_seq_atributo = b.nr_sequencia
	and		coalesce(b.ie_tipo_sepse::text, '') = '';
end if;

if (ie_sepsis_cliente_w = 'S') then

	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_pepo_w
	from	sepse_atributo_cliente a,
			sepse_atributo b
	where	a.nr_seq_atributo = b.nr_sequencia
	and		b.nr_sequencia = ie_opcao_p
	and		coalesce(a.ie_pepo,'N') = 'S';

end if;

select	max(coalesce(ie_liberar_ganho_perda,'N'))
into STRICT	ie_liberar_ganho_perda_w
from	parametro_medico
where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

select coalesce(max(qt_hora_sv), 24) qt_hora_sv
into STRICT   qt_hora_sv_w
from   sepse_atributo_regra a,
	   sepse_atributo b
where  a.nr_seq_atributo = b.nr_sequencia
and	   b.nr_sequencia = ie_opcao_p;

  if regexp_like(ie_pepo_w, 'N', 'i')then
    sqlRestringeCirurgico_w := ' and nr_cirurgia is null and nr_seq_pepo is null ';
  end if;

if (ie_opcao_p in (8,51))then
  sqlMaxSinalVital_w :=          ' select nvl(max(a.dt_sinal_vital), sysdate) '                           ||
                                 ' from	atendimento_sinal_vital a '                                       ||
                                 ' where	a.nr_sequencia = (select max(x.nr_sequencia) '                ||
                                 '                          from   atendimento_sinal_vital x '            ||
                                 '                          where  x.nr_atendimento = :nr_atendimento '   ||
                                 '                          and    x.dt_liberacao is not null '           ||
                                 '                          and    x.dt_inativacao is null '              ||
                                                             sqlRestringeCirurgico_w                      ||
                                 '                          and     (:qt_horas_retroativa = 0 or dt_liberacao >= sysdate - (:qt_horas_retroativa/24)) ' ||
                                 '                         ) ';

  EXECUTE sqlMaxSinalVital_w
  into STRICT    dt_sinal_vital_w
  using   nr_atendimento_p, 
          qt_hora_sv_w, 
          qt_hora_sv_w;
end if;

if (ie_opcao_p in (4, 5, 6, 7, 8, 11, 17, 19, 30, 31, 32, 33, 35, --Versao 1
	47, 48, 49, 50, 51, 59, 61, 41, 42, 95, --Versao 2
	83, 84, 87, 90, 80, 88, 89))then --Pediátrica
  sqlUltimosvaloresSinalVital_w := ' select  max(qt_temp)              qt_temp, '                                                                    ||
                                   '         max(qt_freq_cardiaca)     qt_freq_cardiaca, '                                                           ||
								   '		 max(qt_spo2r)     qt_spo2r, '																			 ||
								   '         max(qt_saturacao_o2)     qt_saturacao_o2, '                                                             ||				
                                   '         max(qt_freq_resp)         qt_freq_resp, '                                                               ||
                                   '         max(ie_nivel_consciencia) ie_nivel_consciencia, '                                                       ||
                                   '         max(qt_glicemia_capilar)  qt_glicemia_capilar, '                                                        ||
                                   '         max(qt_pa_sistolica)      qt_pa_sistolica, '                                                            ||
                                   '         max(qt_peso)              qt_peso, '                                                                    ||
                                   '         max(qt_pam)               qt_pam, '                                                                     ||
								   '         max(ie_nivel_consciencia_ped) ie_nivel_consciencia_ped '												 ||																																								  
                                   ' from   ( '                                                                                                                 ||
                                   '          select last_value(qt_temp                    ignore nulls) over (order by dt_sinal_vital) qt_temp, '              ||
                                   '                 last_value(qt_freq_cardiaca           ignore nulls) over (order by dt_sinal_vital) qt_freq_cardiaca, '     ||
								   '                 last_value(qt_spo2r           		   ignore nulls) over (order by dt_sinal_vital) qt_spo2r, '     		||
								   '                 last_value(qt_saturacao_o2            ignore nulls) over (order by dt_sinal_vital) qt_saturacao_o2, '     	||
                                   '                 last_value(qt_freq_resp               ignore nulls) over (order by dt_sinal_vital) qt_freq_resp, '         ||
                                   '                 last_value(ie_nivel_consciencia       ignore nulls) over (order by dt_sinal_vital) ie_nivel_consciencia, ' ||
                                   '                 last_value(qt_glicemia_capilar        ignore nulls) over (order by dt_sinal_vital) qt_glicemia_capilar, '  ||
                                   '                 last_value(qt_pa_sistolica            ignore nulls) over (order by dt_sinal_vital) qt_pa_sistolica, '      ||
                                   '                 last_value(qt_peso                    ignore nulls) over (order by dt_sinal_vital) qt_peso, '              ||
                                   '                 last_value(qt_pam                     ignore nulls) over (order by dt_sinal_vital) qt_pam, '               ||
								   '                 last_value(ie_nivel_consciencia_ped ignore nulls) over (order by dt_sinal_vital) ie_nivel_consciencia_ped' ||
                                   '          from   atendimento_sinal_vital '                                                                                  ||
                                   '          where  nr_atendimento = :nr_atendimento '                                                                         ||
                                   '          and    dt_liberacao is not null  '                                                                                ||
                                   '          and    dt_inativacao is null  '                                                                                   ||
                                              sqlRestringeCirurgico_w                                                                                           ||
                                   '          and     (:qt_horas_retroativa = 0 or dt_liberacao >= sysdate - (:qt_horas_retroativa/24))  '                      ||
                                   '          order by dt_sinal_vital desc  '                                                                                   ||
                                   '          ) X  '                                                                                                            ||
                                   ' where rownum = 1';

    EXECUTE sqlUltimosvaloresSinalVital_w
    into STRICT	qt_temp_w,
            qt_freq_cardiaca_w,
			qt_spo2r_w,
            qt_saturacao_o2_w,
            qt_freq_resp_w,
            ie_nivel_consciencia_w,
            qt_glicemia_capilar_w,
            qt_pa_sistolica_w,
            qt_peso_w,
            qt_pam_w,
			ie_nivel_consciencia_ped_w			
    using   nr_atendimento_p, 
            qt_hora_sv_w,
            qt_hora_sv_w;

end if;
if (coalesce(qt_spo2r_w,0) > coalesce(qt_freq_cardiaca_w,0)) then
	qt_freq_cardiaca_w := qt_spo2r_w;
end if;

if (ie_pepo_w = 'N') then
	select	max(qt_rel_pao2_fio2)
	into STRICT	qt_rel_pao2_fio2_w
	from	atendimento_monit_resp a
	where	a.nr_sequencia = (	SELECT	max(x.nr_sequencia)
								from	atendimento_monit_resp x
								where	x.nr_atendimento = nr_atendimento_p
								and		(x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '')
								and 	coalesce(x.dt_inativacao::text, '') = ''
								and		x.dt_monitorizacao between clock_timestamp() - interval '1 days' and clock_timestamp()
								and		coalesce(x.nr_cirurgia::text, '') = ''
								and		coalesce(x.nr_seq_pepo::text, '') = '');
else
	select	max(qt_rel_pao2_fio2)
	into STRICT	qt_rel_pao2_fio2_w
	from	atendimento_monit_resp a
	where	a.nr_sequencia = (	SELECT	max(x.nr_sequencia)
								from	atendimento_monit_resp x
								where	x.nr_atendimento = nr_atendimento_p
								and		(x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> '')
								and 	coalesce(x.dt_inativacao::text, '') = ''
								and		x.dt_monitorizacao between clock_timestamp() - interval '1 days' and clock_timestamp());
end if;
							
select	max((obter_idade_pf(obter_pessoa_atendimento(nr_atendimento_p,'C'),clock_timestamp(),'A'))::numeric ),
		trunc(max((obter_idade_pf(obter_pessoa_atendimento(nr_atendimento_p,'C'),clock_timestamp(),'DIA'))::numeric )),
		trunc(max((obter_idade_pf(obter_pessoa_atendimento(nr_atendimento_p,'C'),clock_timestamp(),'M'))::numeric ))		
into STRICT	qt_idade_w,
		qt_idade_dia_w,
		qt_idade_mes_w
;

if (ie_opcao_p in (19,61,86, --Alteraçao de perfusao (em flush ou lentificada &#x2013; TEC>2 seg)
						 88, --Oligúria (débito urinário <= 0,5 mL/kg/h)
						 91)) then --Presença de febre nas últimas 4 horas
	
	obter_max_data(nr_seq_resultado_w, dt_prescr_sae_w, qt_hora_sae_w);
	obter_max_gp(nr_seq_tipo_w, dt_ganhos_perda_w);
	
	if (dt_prescr_sae_w < dt_ganhos_perda_w) or (coalesce(dt_ganhos_perda_w::text, '') = '') then
		
		if (ie_opcao_p in (19,61)) then
		
			select	count(*)
			into STRICT	qt_retorno_w
			from	pe_prescricao a,
					pe_prescr_proc b,
					pe_procedimento c,
					pe_item_result_proc d,
					pe_item_resultado e
			where	a.nr_sequencia = b.nr_seq_prescr
			and		b.nr_seq_proc = c.nr_sequencia
			and		coalesce(a.dt_inativacao::text, '') = ''
			and		c.nr_sequencia = d.nr_seq_proc
			and		d.nr_seq_result = e.nr_sequencia
			and		e.nr_sequencia = nr_seq_resultado_w
			and		a.nr_atendimento = nr_atendimento_p
			and		((qt_hora_sae_w = 0) or (a.dt_liberacao between (clock_timestamp()-(qt_hora_sae_w/24)) and clock_timestamp()));
		
			if (qt_retorno_w > 0) then
				qt_retorno_w 	:= 0;
				qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,0);
				ie_regra_p := 'N';
			end if;
			
		elsif (dt_prescr_sae_w IS NOT NULL AND dt_prescr_sae_w::text <> '') then
			
			qt_retorno_w := null;
			qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,0);
			ie_regra_p := 'N';
		
		else
			qt_retorno_w := null;		
		end if;
		
	else
		if (ie_opcao_p = 19) then
			select	sum(qt_volume)
			into STRICT	qt_volume_w
			from	atendimento_perda_ganho
			where	nr_seq_tipo = nr_seq_tipo_w
			and		nr_atendimento = nr_atendimento_p
			and		dt_referencia between clock_timestamp()-(2/24) and clock_timestamp();
		else
			select	sum(qt_volume)
			into STRICT	qt_volume_w
			from	atendimento_perda_ganho
			where	nr_seq_tipo = nr_seq_tipo_w
			and		nr_atendimento = nr_atendimento_p
			and		ie_situacao = 'A'
			and		dt_referencia between clock_timestamp()-(1/24) and clock_timestamp();
		end if;
		
		qt_volume_w := ((qt_volume_w/qt_peso_w)/2);
				
		if (ie_sepsis_cliente_w = 'S') then
			qt_retorno_w 	:= qt_volume_w;
			qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_volume_w);
			ie_regra_p := 'N';
		elsif (qt_volume_w < 0.5) or (ie_opcao_p = 88 AND qt_volume_w = 0.5) then	
			qt_retorno_w 	:= qt_volume_w;
			qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_volume_w);
			ie_regra_p := 'N';
		elsif (ie_opcao_p = 88) then
			qt_retorno_w := null;
		end if;
	end if;

else

	for cliente_busca in c07 loop
		if (ie_tipo_sepse_p = 'P') then
		begin
			if (ie_opcao_p = 80) then --Frequencia Cardíaca Alterada
				begin
				qt_retorno_w := qt_freq_cardiaca_w;
				qt_pontuacao_w := 0;
				ie_regra_p := 'N';
				if (ie_sepsis_cliente_w = 'S') then
					qt_pontuacao_w := Obter_Pontuacao_ped(qt_retorno_w);
				else
					if (qt_idade_mes_w < 3 and (qt_retorno_w > 205 or qt_retorno_w < 85)) then
						qt_pontuacao_w := 1;
					elsif (qt_idade_mes_w >= 3 and qt_idade_w < 1 and (qt_retorno_w > 190 or qt_retorno_w < 100)) then
						qt_pontuacao_w := 1;
					elsif (qt_idade_w >= 1 and qt_idade_w < 2 and qt_retorno_w > 190) then
						qt_pontuacao_w := 1;
					elsif (qt_idade_w >= 2 and qt_idade_w < 10 and qt_retorno_w > 140) then
						qt_pontuacao_w := 1;
					elsif (qt_idade_w >= 10 and qt_idade_w < 18 and qt_retorno_w > 100) then
						qt_pontuacao_w := 1;
					end if;
				end if;
				end;	
			elsif (ie_opcao_p = 81) then --Leucócitos Alterados
				begin
				qt_pontuacao_w := 0;
				qt_retorno_w := null;
				qt_hora_exame_w := cliente_busca.qt_hora_exame;
				obter_exame(cliente_busca.nr_seq_exame,qt_resultado_w, nr_seq_material_w, nr_seq_metodo_w);
				if (ie_sepsis_cliente_w = 'S') then
					qt_pontuacao_w := Obter_Pontuacao_ped(qt_retorno_w);
				else
					if (qt_resultado_w > -1) then
						qt_retorno_w := qt_resultado_w;
						ie_regra_p := 'N';
						if (qt_idade_mes_w < 1 and qt_retorno_w > 34000) then
							qt_pontuacao_w := 1;
						elsif (qt_idade_mes_w >= 1 and qt_idade_w < 1 and (qt_retorno_w > 19500 or qt_retorno_w < 5000)) then
							qt_pontuacao_w := 1;
						elsif (qt_idade_w >= 1 and qt_idade_w < 2 and (qt_retorno_w > 17500 or qt_retorno_w < 5000)) then
							qt_pontuacao_w := 1;
						elsif (qt_idade_w >= 2 and qt_idade_w < 4 and (qt_retorno_w > 15500 or qt_retorno_w < 6000)) then
							qt_pontuacao_w := 1;
						elsif (qt_idade_w >= 4 and qt_idade_w < 6 and (qt_retorno_w > 13500 or qt_retorno_w < 4500)) then
							qt_pontuacao_w := 1;
						elsif (qt_idade_w >= 6 and qt_idade_w < 18 and (qt_retorno_w > 11000 or qt_retorno_w < 4500)) then
							qt_pontuacao_w := 1;
						end if;
					end if;
				end if;	
				end;
			elsif (ie_opcao_p = 83) then --Frequencia Respiratória Alterada
				begin
				qt_retorno_w := qt_freq_resp_w;
				qt_pontuacao_w := 0;
				ie_regra_p := 'N';
				if (ie_sepsis_cliente_w = 'S') then
					qt_pontuacao_w := Obter_Pontuacao_ped(qt_retorno_w);
				else
					if (qt_idade_w < 1 and qt_retorno_w > 60) then
						qt_pontuacao_w := 1;
					elsif (	qt_idade_w >= 1 and qt_idade_w < 4 and qt_retorno_w > 40) then
						qt_pontuacao_w := 1;
					elsif (	qt_idade_w >= 4 and qt_idade_w < 6 and qt_retorno_w > 34) then
						qt_pontuacao_w := 1;
					elsif (	qt_idade_w >= 6 and qt_idade_w < 13 and qt_retorno_w > 30) then
						qt_pontuacao_w := 1;
					elsif (	qt_idade_w >= 13 and qt_idade_w < 18 and qt_retorno_w > 16) then
						qt_pontuacao_w := 1;
					end if;
				end if;
				end;	
			elsif (ie_opcao_p = 84) then --Temperatura Alterada
				begin
				qt_retorno_w := qt_temp_w;
				qt_pontuacao_w := 0;
				ie_regra_p := 'N';
				if (ie_sepsis_cliente_w = 'S') then
					qt_pontuacao_w := Obter_Pontuacao_ped(qt_retorno_w);
				else
					if (qt_idade_mes_w < 3 and (qt_retorno_w > 38 or qt_retorno_w < 36)) then
						qt_pontuacao_w := 1;
					elsif (qt_idade_mes_w >= 3 and qt_idade_w < 18 and (qt_retorno_w > 38.5 or qt_retorno_w < 36)) then
						qt_pontuacao_w := 1;
					end if;	
				end if;	
				end;
			elsif (ie_opcao_p = 87) then --Mudança aguda do estado neurológico
				begin
				qt_retorno_w := ie_nivel_consciencia_ped_w;
				qt_pontuacao_w := 0;
				ie_regra_p := 'N';
				if (ie_sepsis_cliente_w = 'S') then
					qt_pontuacao_w := Obter_Pontuacao(ie_opcao_p,qt_retorno_w);
				elsif (qt_retorno_w <> 0) then
					qt_pontuacao_w := 1;
				end if;
				end;
			elsif (ie_opcao_p = 89) then --Dessaturaçao (SpO2 <92%) em ar ambiente
				begin
				select max(qt_saturacao_o2)
				into STRICT   qt_retorno_w
				from   ( SELECT last_value(qt_saturacao_o2 ignore nulls) over (order by dt_sinal_vital) qt_saturacao_o2
						  from   atendimento_sinal_vital
						  where  nr_atendimento = nr_atendimento_p
						  and    ie_cond_sat_o2 = 'AA'
						  and    (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
						  and    coalesce(dt_inativacao::text, '') = ''
						  and     (qt_hora_sv_w = 0 or dt_liberacao >= clock_timestamp() - (qt_hora_sv_w/24))
						  order by dt_sinal_vital desc) X LIMIT 1;
				
				qt_pontuacao_w := 0;
				ie_regra_p := 'N';
				
				if (ie_sepsis_cliente_w = 'S') then
					qt_pontuacao_w := Obter_Pontuacao(ie_opcao_p,qt_retorno_w);
				elsif (qt_retorno_w < 92)  then
					qt_pontuacao_w := 1;
				end if;
				end;
			elsif (ie_opcao_p = 90) then --Hipotensao (Pressao Arterial Sistólica (mmHg) abaixo do normal)
				begin
				qt_retorno_w := qt_pa_sistolica_w;
				qt_pontuacao_w := 0;
				ie_regra_p := 'N';
				if (ie_sepsis_cliente_w = 'S') then
					qt_pontuacao_w := Obter_Pontuacao_ped(qt_retorno_w);
				else
					if (qt_idade_mes_w < 1 and qt_retorno_w < 60) then
						qt_pontuacao_w := 1;
					elsif (qt_idade_mes_w >= 1 and qt_idade_w < 1 and qt_retorno_w < 70) then
						qt_pontuacao_w := 1;
					elsif (qt_idade_w >= 1 and qt_idade_w < 10 and qt_retorno_w < 70 + (qt_idade_w * 2)) then
						qt_pontuacao_w := 1;
					elsif (qt_idade_w >= 10 and qt_idade_w < 18 and qt_retorno_w < 90) then
						qt_pontuacao_w := 1;	
					end if;
				end if;
				end;	
			end if;
		end;	
		else
		if (ie_opcao_p in (4,47)) then
		if (ie_sepsis_cliente_w = 'S') then
			qt_retorno_w 	:= qt_temp_w;
			qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_temp_w);	
		elsif(ie_opcao_p = 4 AND qt_temp_w >= 38.3) or
			(ie_opcao_p = 47 AND qt_temp_w >= 37.5)then
			qt_retorno_w 	:= qt_temp_w;
			qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_temp_w);
		end if;
		ie_regra_p := 'N';
		
		elsif (ie_opcao_p in (5,48)) then
		if (ie_sepsis_cliente_w = 'S') then

			qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_temp_w);
			qt_retorno_w	:= qt_temp_w;

		elsif (qt_temp_w < 36) then
			qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_temp_w);
			qt_retorno_w	:= qt_temp_w;
		end if;
		ie_regra_p := 'N';
	elsif (ie_opcao_p in (6,33,49)) then

		select	sum(coalesce(qt_freq_cardiaca,0)),
				sum(1)
		into STRICT	qt_sum_w,
				qt_total_w
		from	atendimento_sinal_vital
		where	nr_atendimento = nr_atendimento_p
		and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and 	coalesce(dt_inativacao::text, '') = ''
		and		dt_sinal_vital between clock_timestamp() - interval '1 days' and clock_timestamp();

		
		if (qt_total_w = 0) then
		
			qt_media_w := 0;
		
		else
		
			qt_media_w := (qt_sum_w/qt_total_w); -- Média
		
		end if;
		
		qt_vlr_total_w := 0;
		if (ie_pepo_w = 'N') then
			open C01;
			loop
			fetch C01 into	
				qt_valor_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				begin
				begin
				qt_valor_w := (qt_valor_w - qt_media_w); -- Valor de cada variável subtraindo pela média(Desvio médio)
				
				qt_valor_w := (qt_valor_w * qt_valor_w); -- Pega o desvio de cada desvio e eleva ao quadrado.
				
				qt_vlr_total_w := (qt_vlr_total_w + qt_valor_w); -- Soma todos os desvios.
				exception
				when others then
					qt_vlr_total_w := 0;
				end;
				end;
			end loop;
			close C01;
		else
			open C05;
			loop
			fetch C05 into	
				qt_valor_w;
			EXIT WHEN NOT FOUND; /* apply on C05 */
				begin
				begin
				qt_valor_w := (qt_valor_w - qt_media_w); -- Valor de cada variável subtraindo pela média(Desvio médio)
				
				qt_valor_w := (qt_valor_w * qt_valor_w); -- Pega o desvio de cada desvio e eleva ao quadrado.
				
				qt_vlr_total_w := (qt_vlr_total_w + qt_valor_w); -- Soma todos os desvios.
				exception
				when others then
					qt_vlr_total_w := 0;
				end;
				end;
			end loop;
			close C05;
		end if;
		
		if (qt_total_w = 0) then
		
			qt_vlr_total_w := 0;
		
		else
		
			qt_vlr_total_w := (qt_vlr_total_w/qt_total_w); -- Variância
		
		end if;
		
		/*	SQRT = Raiz quadrada */
		select	max(SQRT(qt_vlr_total_w)) -- Desvio padrao.
		into STRICT	qt_dp_w
		;
		
		if (ie_sepsis_cliente_w = 'S') then
		
			if (ie_opcao_p in (6,49)) then
			
				qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_freq_cardiaca_w);
				qt_retorno_w 	:= qt_freq_cardiaca_w;
				ie_regra_p := 'N';
				
			elsif (ie_opcao_p = 33) and (qt_total_w > 1) then
			
				qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_dp_w);
				qt_retorno_w 	:= qt_dp_w;
				ie_regra_p := 'N';
				
			
			end if;	
			
		else
		
			if (ie_opcao_p in (6,49)) then
			
				if (qt_idade_w < 2) then
					if (qt_freq_cardiaca_w > 180) then
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_freq_cardiaca_w);
						qt_retorno_w 	:= qt_freq_cardiaca_w;
						ie_regra_p := 'N';
					end if;
				elsif (qt_idade_w <= 5) then
					if (qt_freq_cardiaca_w > 140) then
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_freq_cardiaca_w);
						qt_retorno_w 	:= qt_freq_cardiaca_w;
						ie_regra_p := 'N';
					end if;
				elsif (qt_idade_w <= 12) then
					if (qt_freq_cardiaca_w > 130) then
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_freq_cardiaca_w);
						qt_retorno_w 	:= qt_freq_cardiaca_w;
						ie_regra_p := 'N';
					end if;
				elsif (qt_idade_w > 12) then
					if (qt_freq_cardiaca_w > 90) then
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_freq_cardiaca_w);
						qt_retorno_w 	:= qt_freq_cardiaca_w;
						ie_regra_p := 'N';
					end if;
				end if;				
			
			elsif (ie_opcao_p = 30) then		
				
				if (qt_dp_w > 2) then
				
					qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_dp_w);
					qt_retorno_w 	:= qt_dp_w;
					ie_regra_p := 'N';
				
				end if;	
				
				
			end if;
			
		end if;
		
	elsif (ie_opcao_p in (7,50)) then

		if (ie_sepsis_cliente_w = 'S') then
		
			qt_retorno_w 	:= qt_freq_resp_w;
			qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_freq_resp_w);
			ie_regra_p := 'N';	
				
			
		else

		
			if (qt_idade_dia_w <= 7) then
				if (qt_freq_resp_w > 60) then
					qt_retorno_w 	:= qt_freq_resp_w;
					qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_freq_resp_w);
					ie_regra_p := 'N';
				end if;
			elsif (qt_idade_dia_w <= 30)  then
				if (qt_freq_resp_w > 50) then
					qt_retorno_w 	:= qt_freq_resp_w;
					qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_freq_resp_w);
					ie_regra_p := 'N';
				end if;
			elsif (qt_idade_w < 2)  then
				if (qt_freq_resp_w > 35) then
					qt_retorno_w 	:= qt_freq_resp_w;
					qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_freq_resp_w);
					ie_regra_p := 'N';
				end if;
			elsif (qt_idade_w <= 5)  then
				if (qt_freq_resp_w > 30) then
					qt_retorno_w 	:= qt_freq_resp_w;
					qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_freq_resp_w);
					ie_regra_p := 'N';
				end if;
			elsif (qt_idade_w > 5)  then
				if (qt_freq_resp_w > 20) then
					qt_retorno_w 	:= qt_freq_resp_w;
					qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_freq_resp_w);
					ie_regra_p := 'N';
				end if;
			end if;
			
		end if;
		
	elsif (ie_opcao_p in (8,51)) then
		
		ie_regra_p := 'N';
			
		select	max(a.dt_prescricao)
		into STRICT	dt_prescr_sae_w
		from	pe_prescricao a,
				pe_prescr_proc b,
				pe_procedimento c,
				pe_item_result_proc d,
				pe_item_resultado e
		where	a.nr_sequencia = b.nr_seq_prescr
		and		b.nr_seq_proc = c.nr_sequencia
		and		coalesce(a.dt_inativacao::text, '') = ''
		and		c.nr_sequencia = d.nr_seq_proc
		and		d.nr_seq_result = e.nr_sequencia
		and		e.nr_sequencia = cliente_busca.nr_seq_result
		and		a.nr_atendimento = nr_atendimento_p
		and		((cliente_busca.qt_hora_sae = 0) or (a.dt_liberacao between (clock_timestamp()-(cliente_busca.qt_hora_sae/24)) and clock_timestamp()));
		
		if (ie_nivel_consciencia_w in (1,2,3)) or
			((ie_nivel_consciencia_w in (1,2,3)) and (dt_prescr_sae_w < dt_sinal_vital_w)) then
		
			qt_retorno_w 	:= ie_nivel_consciencia_w;
			qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,ie_nivel_consciencia_w);
			
		elsif (cliente_busca.nr_seq_result > 0)  then
				
				
			select	count(*)
			into STRICT	qt_retorno_w
			from	pe_prescricao a,
					pe_prescr_proc b,
					pe_procedimento c,
					pe_item_result_proc d,
					pe_item_resultado e
			where	a.nr_sequencia = b.nr_seq_prescr
			and		b.nr_seq_proc = c.nr_sequencia
			and		coalesce(a.dt_inativacao::text, '') = ''
			and		c.nr_sequencia = d.nr_seq_proc
			and		d.nr_seq_result = e.nr_sequencia
			and		e.nr_sequencia = cliente_busca.nr_seq_result
			and		a.nr_atendimento = nr_atendimento_p
			and		((cliente_busca.qt_hora_sae = 0) or (a.dt_liberacao between (clock_timestamp()-(cliente_busca.qt_hora_sae/24)) and clock_timestamp()));
			
			if (qt_retorno_w > 0) then
				
				qt_retorno_w 	:= 0;
				qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,0);
				
			end if;
		else
		
			ie_liberar_escala_w := obter_param_usuario(281, 858, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_liberar_escala_w);
		
			select coalesce(max(qt_glasgow),0)
			into STRICT   qt_glasgow_w
			from   atend_escala_indice a
			where  nr_sequencia = (SELECT max(nr_sequencia)
								   from   atend_escala_indice
								   where  nr_atendimento = nr_atendimento_p
								   and    coalesce(dt_inativacao::text, '') = ''
								   and	  obter_liberacao_registro(ie_liberar_escala_w,nm_usuario_p,dt_liberacao,nm_usuario) = 'S'
								   and    ((qt_hora_sv_w = 0) 
								   or (CASE WHEN ie_liberar_escala_w='S' THEN dt_liberacao  ELSE dt_avaliacao END  between (clock_timestamp() - (qt_hora_sv_w /24)) and clock_timestamp())));
								
			if (ie_sepsis_cliente_w = 'S') then
					
				qt_retorno_w 	:= qt_glasgow_w;
				qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_glasgow_w);
				ie_regra_p := 'N';
			
			elsif (qt_glasgow_w > 0) and (qt_glasgow_w < 15) then
			
				qt_retorno_w 	:= qt_glasgow_w;
				qt_pontuacao_w	:= 1;
				ie_atributo_p   := substr(obter_resultado_glasgow(qt_glasgow_w),1,60);
			end if;
		
		end if;
		
	elsif (ie_opcao_p = 9) then
		begin	
		
			select	count(*)
			into STRICT	qt_retorno_w
			from	pe_prescricao         a,
					pe_prescr_item_result b
			where	a.nr_sequencia = b.nr_seq_prescr
			and		coalesce(a.dt_inativacao::text, '') = ''
			and		b.nr_seq_result = cliente_busca.nr_seq_result
			and		a.nr_atendimento = nr_atendimento_p
			and		((cliente_busca.qt_hora_sae = 0) or (a.dt_liberacao between (clock_timestamp()-(cliente_busca.qt_hora_sae/24)) and clock_timestamp()));
			
			if (qt_retorno_w > 0) then
			
				ie_regra_p := 'N';
				qt_retorno_w 	:= 0;
				qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,0);
				
			end if;	
		end;
	elsif (ie_opcao_p = 35) then
		begin	
		
		select	sum(CASE WHEN a.ie_perda_ganho='G' THEN  c.qt_volume  ELSE 0 END  - CASE WHEN a.ie_perda_ganho='P' THEN  c.qt_volume  ELSE 0 END )
		into STRICT	qt_bh_w
		from	tipo_perda_ganho b,
				grupo_perda_ganho a,
				atendimento_perda_ganho c
		where	c.nr_atendimento = nr_atendimento_p
		and		b.nr_sequencia = c.nr_seq_tipo
		and		b.nr_seq_grupo = a.nr_sequencia
		and     coalesce(b.ie_soma_bh,'S') = 'S'
		and     ((ie_liberar_ganho_perda_w = 'N') or (c.dt_liberacao IS NOT NULL AND c.dt_liberacao::text <> ''))
		and     coalesce(c.ie_situacao,'A') = 'A'
		and		((cliente_busca.qt_hora_gp = 0) or (c.dt_liberacao between (clock_timestamp()-(cliente_busca.qt_hora_gp/24)) and clock_timestamp()));
		
		if ( qt_peso_w = 0) then
		
			qt_retorno_w	:= 0;
			qt_pontuacao_w 	:= 0;
		
		else
		
			qt_bh_w := (qt_bh_w/qt_peso_w);
		
			if (ie_sepsis_cliente_w = 'S') then

				qt_retorno_w 	:= qt_bh_w;
				qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_bh_w);	
			
			
			elsif (qt_bh_w >= 20) then
			
				qt_retorno_w	:= qt_bh_w;
				qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_bh_w);		
				
			end if;
		
		end if;
		
		ie_regra_p := 'N';	
		
		end;
	elsif (ie_opcao_p = 11) then

		if (ie_sepsis_cliente_w = 'S') then

			qt_retorno_w 	:= qt_glicemia_capilar_w;
			qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_glicemia_capilar_w);
			ie_regra_p := 'N';
					

		elsif (qt_glicemia_capilar_w > 140) then
			
			qt_retorno_w 	:= qt_glicemia_capilar_w;
			qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_glicemia_capilar_w);
			ie_regra_p := 'N';
			
		end if;
	elsif (ie_opcao_p in (12,13,15,16,20,21,23,24,25,34, 54,55,62,65,66,67,75,77)) then
		
					qt_hora_exame_w := cliente_busca.qt_hora_exame;
					obter_exame(cliente_busca.nr_seq_exame,qt_resultado_w, nr_seq_material_w, nr_seq_metodo_w);
		
		if (qt_resultado_w > -1) then
			
			if (ie_opcao_p in (12, 54)) then
				
				if (ie_sepsis_cliente_w = 'S') then
				
					qt_retorno_w 	:= qt_resultado_w;
					qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
					ie_regra_p := 'N';
				
				
				elsif (qt_resultado_w > 12000) then		
				
					qt_retorno_w 	:= qt_resultado_w;
					qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
					ie_regra_p := 'N';
				
				end if;
				
			elsif (ie_opcao_p in (13,55)) then
					
				if (ie_sepsis_cliente_w = 'S') then
				
					qt_retorno_w 	:= qt_resultado_w;
					qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
					ie_regra_p := 'N';

				elsif (qt_resultado_w < 4000)	then	
					
					qt_retorno_w 	:= qt_resultado_w;
					qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
					ie_regra_p := 'N';
				end if;
				
			elsif (ie_opcao_p in (15,16)) then
					begin
					
					select 	sum(b.qt_resultado),
							sum(1)
					into STRICT	qt_sum_w,
							qt_total_w
					from 	exame_lab_result_item b,
							exame_lab_resultado a,
							prescr_procedimento x,
							prescr_medica c
					where	a.nr_seq_resultado	= b.nr_seq_resultado
					and		a.nr_prescricao		= c.nr_prescricao
					and		x.nr_sequencia		= b.nr_seq_prescr
					and		x.nr_prescricao		= c.nr_prescricao
					and		b.nr_seq_exame		= cliente_busca.nr_seq_exame
					and		c.nr_atendimento	= nr_atendimento_p
					and		x.ie_status_atend	>= 35
					and		((cliente_busca.qt_hora_exame = 0) or (a.dt_resultado between (clock_timestamp()-(cliente_busca.qt_hora_exame/24)) and clock_timestamp()));
					
					if ( qt_total_w = 0) then
					
						qt_media_w := 0;
					
					else
					
						qt_media_w := (qt_sum_w/qt_total_w); -- Média
					
					end if;
					
					
					
					qt_vlr_total_w := 0;
					nr_seq_exame_w := cliente_busca.nr_seq_exame;
					qt_hora_exame_w := cliente_busca.qt_hora_exame;
					open C02;
					loop
					fetch C02 into	
						qt_valor_w;
					EXIT WHEN NOT FOUND; /* apply on C02 */
						begin
						qt_valor_w := (qt_valor_w - qt_media_w); -- Valor de cada variável subtraindo pela média(Desvio médio)
						
						qt_valor_w := (qt_valor_w * qt_valor_w); -- Pega o desvio de cada desvio e eleva ao quadrado.
						
						qt_vlr_total_w := (qt_vlr_total_w + qt_valor_w); -- Soma todos os desvios.
						end;
					end loop;
					close C02;
					
					if ( qt_total_w = 0) then
					
						qt_vlr_total_w := 0;
					
					else
					
					
						qt_vlr_total_w := (qt_vlr_total_w/qt_total_w); -- Variância
					
					end if;
					
					/*	SQRT = Raiz quadrada */
					select	max(SQRT(qt_vlr_total_w)) -- Desvio padrao.
					into STRICT	qt_dp_w
					;
					
					if (ie_sepsis_cliente_w = 'S') then
					
						qt_retorno_w 	:= qt_dp_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_dp_w);
						ie_regra_p := 'N';
							
					elsif (qt_dp_w > 2) then
					
						qt_retorno_w 	:= qt_dp_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_dp_w);
						ie_regra_p := 'N';
						
					end if;
					
					end;
			elsif (ie_opcao_p in (20,62)) then
					
					if (ie_sepsis_cliente_w = 'S') then
					
						qt_retorno_w 	:= qt_resultado_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
						ie_regra_p := 'N';
					
					
					elsif (ie_opcao_p = 20 AND qt_resultado_w > 0.5) or
							(ie_opcao_p = 62 AND qt_resultado_w > 2)then
					
						qt_retorno_w 	:= qt_resultado_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
						ie_regra_p := 'N';
					
					end if;
					
			elsif (ie_opcao_p = 21) then
					
					if (ie_sepsis_cliente_w = 'S') then
					
						qt_retorno_w 	:= qt_resultado_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
						ie_regra_p := 'N';
									
					
					elsif (qt_resultado_w > 1.5) then
					
						qt_retorno_w 	:= qt_resultado_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
						ie_regra_p := 'N';
						
					end if;
					
			elsif (ie_opcao_p = 102) then --Coagulopatia (INR> 1,5)
					
					if (ie_sepsis_cliente_w = 'S') then
					
						qt_retorno_w 	:= qt_resultado_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
						ie_regra_p := 'N';
									
					
					elsif (qt_resultado_w > 1.5) then
					
						qt_retorno_w 	:= qt_resultado_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
						ie_regra_p := 'N';
						
					end if;
					
			elsif (ie_opcao_p = 103) then --Coagulopatia (TTPA > 60 seg)
					
					if (ie_sepsis_cliente_w = 'S') then
					
						qt_retorno_w 	:= qt_resultado_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
						ie_regra_p := 'N';
									
					
					elsif (qt_resultado_w > 60) then
					
						qt_retorno_w 	:= qt_resultado_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
						ie_regra_p := 'N';
						
					end if;						
					
			elsif (ie_opcao_p = 34) then
					
					if (ie_sepsis_cliente_w = 'S') then
					
						qt_retorno_w 	:= qt_resultado_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
						ie_regra_p := 'N';
					
					
					elsif (qt_resultado_w > 60) then
					
						qt_retorno_w 	:= qt_resultado_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
						ie_regra_p := 'N';
					
					end if;
					
			elsif (ie_opcao_p in (23,65)) then
					
					if (ie_sepsis_cliente_w = 'S') then
					
						qt_retorno_w 	:= qt_resultado_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
						ie_regra_p := 'N';
					
					elsif (qt_resultado_w < 100000) then
					
						qt_retorno_w 	:= qt_resultado_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
						ie_regra_p := 'N';
						
					end if;
					
			elsif (ie_opcao_p = 24) then
					
					if (ie_sepsis_cliente_w = 'S') then
					
						qt_retorno_w 	:= qt_resultado_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
						ie_regra_p := 'N';
					
					elsif (qt_resultado_w > 4) then
					
						qt_retorno_w 	:= qt_resultado_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
						ie_regra_p := 'N';
					
					end if;
			
			elsif (ie_opcao_p in (66,77)) then
			
				if (ie_sepsis_cliente_w = 'S') then				
						qt_retorno_w 	:= qt_resultado_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
						ie_regra_p := 'N';
				elsif (qt_resultado_w > 0) then
				
					cd_pessoa_fisica_w := obter_pessoa_atendimento(nr_atendimento_p, 'C');
					qt_dias_w := obter_dias_entre_datas_lab(obter_data_nascto_pf(cd_pessoa_fisica_w),clock_timestamp());
					
					select	CASE WHEN coalesce(max(ie_idade_int_val_ref), 'N')='N' THEN  2  ELSE 0 END
					into STRICT	qt_casas_decimais_dias_w
					from	lab_parametro
					where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;
					
					select qt_valor
					into STRICT   qt_val_ref_w
					from (
						SELECT 	coalesce(qt_maxima,qt_percent_max) qt_valor
						from 	exame_lab_padrao
						where (ie_sexo = OBTER_SEXO_PF(cd_pessoa_fisica_w, 'C') or (ie_sexo = '0'))
						and 	nr_seq_exame = cliente_busca.nr_seq_exame
						and 	coalesce(nr_seq_material,nr_seq_material_w) = nr_seq_material_w
						and 	coalesce(nr_seq_metodo, nr_seq_metodo_w) = nr_seq_metodo_w
						and 	((((ie_periodo = 'A') and trunc((qt_dias_w / 365.25),qt_casas_decimais_dias_w) between coalesce(qt_idade_min,0) and coalesce(qt_idade_max,99999))) or
							((ie_periodo = 'M') and (trunc(((qt_dias_w / 365.25) * 12),qt_casas_decimais_dias_w) between coalesce(qt_idade_min,0) and coalesce(qt_idade_max,99999))) or
							((ie_periodo = 'D') and (qt_dias_w between coalesce(qt_idade_min,0) and coalesce(qt_idade_max,99999))) or
							((ie_periodo = 'H') and (Obter_Hora_Entre_datas(obter_data_nascto_pf(cd_pessoa_fisica_w),clock_timestamp()) between coalesce(qt_idade_min,0) and coalesce(qt_idade_max,99999))))
						and 	ie_tipo_valor in (0,3)
						and coalesce(ie_situacao,'A') = 'A'
						order by coalesce(nr_seq_material, 9999999999), coalesce(nr_seq_metodo, 9999999999), ie_sexo, CASE WHEN ie_periodo='D' THEN 1 WHEN ie_periodo='M' THEN 2  ELSE 3 END ) alias39 LIMIT 1;
					
					if ((ie_opcao_p = 66) and ((qt_resultado_w * 2) > qt_val_ref_w)) or
						(ie_opcao_p = 77 AND qt_resultado_w <= 5) then
						qt_retorno_w 	:= qt_resultado_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
						ie_regra_p := 'N';
					end if;
				end if;
					
			elsif (ie_opcao_p in (25,67)) then
					
					if (ie_sepsis_cliente_w = 'S') then
					
						qt_retorno_w 	:= qt_resultado_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
						ie_regra_p := 'N';
					
					
					elsif (qt_resultado_w > 1) then

						qt_retorno_w 	:= qt_resultado_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
						ie_regra_p := 'N';
					
					end if;
					
			elsif (ie_opcao_p not in (12,13,20,23,24,25, 54,55,62,65,66,67)) then
					
					qt_retorno_w 	:= qt_resultado_w;
					qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
					ie_regra_p := 'N';
				
			elsif (ie_opcao_p = 75) then
				if (ie_sepsis_cliente_w = 'S') then
					
						qt_retorno_w 	:= qt_resultado_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
						ie_regra_p := 'N';
					
					
					elsif (qt_resultado_w < 32) then

						qt_retorno_w 	:= qt_resultado_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_resultado_w);
						ie_regra_p := 'N';
					
					end if;
			end if;
		end if;	
	elsif (ie_opcao_p in (17,30,31,32, 59,41,42)) and
			((qt_pa_sistolica_w > 0) or (ie_opcao_p in (30,41))) and (qt_pam_w > 0) then
			begin
			select	sum(coalesce(qt_pa_sistolica,0)),
					sum(1)
			into STRICT	qt_sum_w,
					qt_total_w
			from	atendimento_sinal_vital
			where	nr_atendimento = nr_atendimento_p
			and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
			and 	coalesce(dt_inativacao::text, '') = ''
			and     (qt_pa_sistolica_w IS NOT NULL AND qt_pa_sistolica_w::text <> '')
			and		dt_sinal_vital between clock_timestamp() - interval '1 days' and clock_timestamp();
			
			if ( qt_total_w = 0 ) then
			
				qt_media_w := 0;
			
			else

				qt_media_w := (qt_sum_w/qt_total_w); -- Média
			
			end if;
			
			qt_vlr_total_w := 0;
			if (ie_pepo_w = 'S') then
				open C03;
				loop
				fetch C03 into	
					qt_valor_w;
				EXIT WHEN NOT FOUND; /* apply on C03 */
					begin
					begin
					qt_valor_w := (qt_valor_w - qt_media_w); -- Valor de cada variável subtraindo pela média(Desvio médio)
					
					qt_valor_w := (qt_valor_w * qt_valor_w); -- Pega o desvio de cada desvio e eleva ao quadrado.
					
					qt_vlr_total_w := (qt_vlr_total_w + qt_valor_w); -- Soma todos os desvios.
					exception
					when others then
						qt_vlr_total_w := 0;
					end;
					end;
				end loop;
				close C03;
			else
				open C06;
				loop
				fetch C06 into	
					qt_valor_w;
				EXIT WHEN NOT FOUND; /* apply on C06 */
					begin
					begin
					qt_valor_w := (qt_valor_w - qt_media_w); -- Valor de cada variável subtraindo pela média(Desvio médio)
					
					qt_valor_w := (qt_valor_w * qt_valor_w); -- Pega o desvio de cada desvio e eleva ao quadrado.
					
					qt_vlr_total_w := (qt_vlr_total_w + qt_valor_w); -- Soma todos os desvios.
					exception
					when others then
						qt_vlr_total_w := 0;
					end;
					end;
				end loop;
				close C06;
			end if;
			
			
			if ( qt_total_w = 0) then
			
				qt_vlr_total_w := 0;
			
			else
			
				qt_vlr_total_w := (qt_vlr_total_w/qt_total_w); -- Variância
			
			end if;
			
			/*	SQRT = Raiz quadrada */
			select	max(SQRT(qt_vlr_total_w)) -- Desvio padrao.
			into STRICT	qt_dp_w
			;
			
			select	max(b.qt_minimo)
			into STRICT	qt_minimo_w
			from	sinal_vital a,
					sinal_vital_regra b
			where	a.nr_sequencia = b.nr_seq_sinal
			and		18 between qt_idade_min and qt_idade_max;
			if (ie_opcao_p in (31,42)) then
				select 	count(*)
				into STRICT	qt_reg_w
				from    atendimento_sinal_vital
				where   nr_atendimento = nr_atendimento_p
				and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and     coalesce(dt_inativacao::text, '') = ''
				and     (qt_hora_sv_w = 0 or dt_liberacao >= clock_timestamp() - (qt_hora_sv_w/24))
				order by dt_sinal_vital desc;
				
				select 	coalesce(sum(diff),0)
				into STRICT	qt_queda_w
				from (
					SELECT 	qt_pa_sistolica, dt_sinal_vital, lag(qt_pa_sistolica,1,qt_pa_sistolica) over (order by dt_sinal_vital desc) - qt_pa_sistolica as diff
					from    atendimento_sinal_vital
					where   nr_atendimento = nr_atendimento_p
					and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
					and     coalesce(dt_inativacao::text, '') = ''
					and     (qt_hora_sv_w = 0 or dt_liberacao >= clock_timestamp() - (qt_hora_sv_w/24))
					order by dt_sinal_vital desc) alias9 LIMIT 2;
				
				if (qt_queda_w < 0) then
					qt_queda_w := qt_queda_w * -1;	
					
				else
					qt_queda_w := 0;
				
				end if;
			end if;
			if (ie_sepsis_cliente_w = 'S') then		
			
				if (ie_opcao_p in (17,59)) then		

					qt_retorno_w 	:= qt_pa_sistolica_w;
					qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_pa_sistolica_w);
					ie_regra_p := 'N';
			
				elsif (ie_opcao_p in (30,41)) then
				
					qt_retorno_w 	:= qt_pam_w;
					qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_pam_w);
					ie_regra_p := 'N';

				elsif (ie_opcao_p in (31,42)) and (qt_idade_w >= 18) and (qt_reg_w > 1) and (qt_queda_w > 40) then
					
					--qt_queda_w := (qt_minimo_w - qt_pa_sistolica_w);
				
					qt_retorno_w 	:= qt_queda_w;
					qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_queda_w);
					ie_regra_p := 'N';

				elsif (ie_opcao_p = 32) and (qt_total_w > 1) then
				
					qt_retorno_w 	:= qt_dp_w;
					qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_dp_w);
					ie_regra_p := 'N';		
									
				end if;
					
			
			else
			
				if (ie_opcao_p in (17,59)) then
				
					if (qt_idade_dia_w <= 7) then
						if (qt_pa_sistolica_w < 59) then
							qt_retorno_w 	:= qt_pa_sistolica_w;
							qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_pa_sistolica_w);
							ie_regra_p := 'N';
						end if;
					elsif (qt_idade_w <= 5) then
						if (qt_pa_sistolica_w < 75) then
							qt_retorno_w 	:= qt_pa_sistolica_w;
							qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_pa_sistolica_w);
							ie_regra_p := 'N';
						end if;
					elsif (qt_idade_w <= 12) then
						if (qt_pa_sistolica_w < 83) then
							qt_retorno_w 	:= qt_pa_sistolica_w;
							qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_pa_sistolica_w);
							ie_regra_p := 'N';
						end if;
					elsif (qt_idade_w > 12) then			
						if (qt_pa_sistolica_w < 90)then
							qt_retorno_w 	:= qt_pa_sistolica_w;
							qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_pa_sistolica_w);
							ie_regra_p := 'N';
						end if;
					end if;			
				
				elsif (qt_idade_w > 12) then	
				
					if	(ie_opcao_p = 30 AND qt_pam_w < 70) or
						(ie_opcao_p = 41 AND qt_pam_w < 65) then
				
						qt_retorno_w 	:= qt_pa_sistolica_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_pam_w);
						ie_regra_p := 'N';
				
					elsif (ie_opcao_p in (31,42)) and (qt_idade_w >= 18) and (qt_reg_w > 1) and (qt_queda_w > 40)   then
						
						select 	sum(diff)
						into STRICT	qt_queda_w
						from (
							SELECT 	qt_pa_sistolica, dt_sinal_vital, lag(qt_pa_sistolica,1,qt_pa_sistolica) over (order by dt_sinal_vital desc) - qt_pa_sistolica as diff
							from    atendimento_sinal_vital
							where   nr_atendimento = nr_atendimento_p
							and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
							and     coalesce(dt_inativacao::text, '') = ''
							and     (qt_hora_sv_w = 0 or dt_liberacao >= clock_timestamp() - (qt_hora_sv_w/24))
							order by dt_sinal_vital desc) alias13 LIMIT 2;
									
						--qt_queda_w := (qt_minimo_w - qt_pa_sistolica_w);
				
						qt_retorno_w 	:= qt_queda_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_queda_w);
						ie_regra_p := 'N';
						
					elsif (ie_opcao_p = 32) and (qt_total_w > 1) and (qt_dp_w > 0) and (qt_dp_w < 2) then
				
						qt_retorno_w 	:= qt_dp_w;
						qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_dp_w);
						ie_regra_p := 'N';		
										
					end if;	
							
							
				end if;		
		
			end if;
			
			end;
	elsif (ie_opcao_p in (18,60)) then
			
			if (ie_sepsis_cliente_w = 'S') then

				qt_retorno_w 	:= qt_rel_pao2_fio2_w;
				qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_rel_pao2_fio2_w);
				ie_regra_p := 'N';		
			
			elsif (qt_rel_pao2_fio2_w < 300) then
			
				qt_retorno_w 	:= qt_rel_pao2_fio2_w;
				qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_rel_pao2_fio2_w);
				ie_regra_p := 'N';
			end if;
			
	elsif (ie_opcao_p in (19,61)) then	
			
		select	max(a.dt_prescricao)
		into STRICT	dt_prescr_sae_w
		from	pe_prescricao a,
				pe_prescr_proc b,
				pe_procedimento c,
				pe_item_result_proc d,
				pe_item_resultado e
		where	a.nr_sequencia = b.nr_seq_prescr
		and		b.nr_seq_proc = c.nr_sequencia
		and		coalesce(a.dt_inativacao::text, '') = ''
		and		c.nr_sequencia = d.nr_seq_proc
		and		d.nr_seq_result = e.nr_sequencia
		and		e.nr_sequencia = cliente_busca.nr_seq_result
		and		a.nr_atendimento = nr_atendimento_p
		and		((cliente_busca.qt_hora_sae = 0) or (a.dt_liberacao between (clock_timestamp()-(cliente_busca.qt_hora_sae/24)) and clock_timestamp()));
		
		
		if (ie_opcao_p = 19) then
			select	max(dt_medida)
			into STRICT	dt_ganhos_perda_w
			from	atendimento_perda_ganho
			where	nr_seq_tipo = cliente_busca.nr_seq_tipo
			and		nr_atendimento = nr_atendimento_p
			and     coalesce(dt_inativacao::text, '') = ''
			and		dt_referencia between clock_timestamp()-(2/24) and clock_timestamp();
		else
			select	max(dt_medida)
			into STRICT	dt_ganhos_perda_w
			from	atendimento_perda_ganho
			where	nr_seq_tipo = cliente_busca.nr_seq_tipo
			and		nr_atendimento = nr_atendimento_p
			and     coalesce(dt_inativacao::text, '') = ''
			and		dt_referencia between clock_timestamp()-(1/24) and clock_timestamp();
		end if;
		

		if (dt_prescr_sae_w < dt_ganhos_perda_w) or (coalesce(dt_ganhos_perda_w::text, '') = '') then


			select	count(*)
			into STRICT	qt_retorno_w
			from	pe_prescricao a,
					pe_prescr_proc b,
					pe_procedimento c,
					pe_item_result_proc d,
					pe_item_resultado e
			where	a.nr_sequencia = b.nr_seq_prescr
			and		b.nr_seq_proc = c.nr_sequencia
			and		coalesce(a.dt_inativacao::text, '') = ''
			and		c.nr_sequencia = d.nr_seq_proc
			and		d.nr_seq_result = e.nr_sequencia
			and		e.nr_sequencia = cliente_busca.nr_seq_result
			and		a.nr_atendimento = nr_atendimento_p
			and		((cliente_busca.qt_hora_sae = 0) or (a.dt_liberacao between (clock_timestamp()-(cliente_busca.qt_hora_sae/24)) and clock_timestamp()));
		
			if (qt_retorno_w > 0) then
				
				qt_retorno_w 	:= 0;
				qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,0);
				ie_regra_p := 'N';
				
			end if;

		else
			if (ie_opcao_p = 19) then
				select	sum(qt_volume)
				into STRICT	qt_volume_w
				from	atendimento_perda_ganho
				where	nr_seq_tipo = cliente_busca.nr_seq_tipo
				and		nr_atendimento = nr_atendimento_p
				and     coalesce(dt_inativacao::text, '') = ''
				and		dt_referencia between clock_timestamp()-(2/24) and clock_timestamp();
			else
				select	sum(qt_volume)
				into STRICT	qt_volume_w
				from	atendimento_perda_ganho
				where	nr_seq_tipo = cliente_busca.nr_seq_tipo
				and		nr_atendimento = nr_atendimento_p
				and     coalesce(dt_inativacao::text, '') = ''
				and		dt_referencia between clock_timestamp()-(1/24) and clock_timestamp();
			end if;
			
			
			if ( qt_peso_w = 0 ) then
			
				qt_retorno_w := 0;
				qt_pontuacao_w := 0;
					
			else
		
				qt_volume_w := ((qt_volume_w/qt_peso_w)/2);
			
				if (ie_sepsis_cliente_w = 'S') then
				
					qt_retorno_w 	:= qt_volume_w;
					qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_volume_w);
					ie_regra_p := 'N';
				
				
				elsif (qt_volume_w < 0.5) then
				
					qt_retorno_w 	:= qt_volume_w;
					qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_volume_w);
					ie_regra_p := 'N';
					
				end if;
				
			
			end if;
			
			ie_regra_p := 'N';
			
		end if;
	elsif (ie_opcao_p in (22,26)) then
		select	count(*)
		into STRICT	qt_retorno_w
		from	pe_prescricao a,
				pe_prescr_proc b,
				pe_procedimento c,
				pe_item_result_proc d,
				pe_item_resultado e
		where	a.nr_sequencia = b.nr_seq_prescr
		and		b.nr_seq_proc = c.nr_sequencia
		and		coalesce(a.dt_inativacao::text, '') = ''
		and		c.nr_sequencia = d.nr_seq_proc
		and		d.nr_seq_result = e.nr_sequencia
		and		e.nr_sequencia = cliente_busca.nr_seq_result
		and		a.nr_atendimento = nr_atendimento_p
		and		((cliente_busca.qt_hora_sae = 0) or (a.dt_liberacao between (clock_timestamp()-(cliente_busca.qt_hora_sae/24)) and clock_timestamp()));
		
		if (qt_retorno_w > 0) then
		
			ie_regra_p := 'N';
			qt_retorno_w 	:= 0;
			qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,0);
		end if;
		
	elsif (ie_opcao_p = 95) then
			-- qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_saturacao_o2_w);

			-- qt_retorno_w 	:= qt_saturacao_o2_w;
		if (ie_sepsis_cliente_w = 'S') then
			qt_retorno_w 	:= qt_saturacao_o2_w;
			qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_saturacao_o2_w);	
		elsif (qt_saturacao_o2_w <= 90)then
			qt_retorno_w 	:= qt_saturacao_o2_w;
			qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_saturacao_o2_w);
		end if;
		
	ie_regra_p := 'N';
	elsif (ie_opcao_p = 72) then

		select 	coalesce(max(b.qt_resultado),-1)
		into STRICT	qt_resultado_w
		from 	exame_lab_result_item b,
				exame_lab_resultado a,
				prescr_procedimento x,
				prescr_medica c
		where	a.nr_seq_resultado	= b.nr_seq_resultado
		and		a.nr_prescricao		= c.nr_prescricao
		and		x.nr_sequencia		= b.nr_seq_prescr
		and		x.nr_prescricao		= c.nr_prescricao
		and		b.nr_seq_exame		= cliente_busca.nr_seq_exame
		and		c.nr_atendimento	= nr_atendimento_p
		and		x.ie_status_atend	>= 35
		and		a.dt_resultado between inicio_dia(clock_timestamp()) and clock_timestamp();
		
		if (qt_resultado_w = -1) then
		
			select 	coalesce(max(b.qt_resultado),-1)
			into STRICT	qt_resultado_w
			from 	exame_lab_result_item b,
					exame_lab_resultado a
			where	a.nr_seq_resultado	= b.nr_seq_resultado
			and		coalesce(a.nr_prescricao::text, '') = ''
			and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
			and		b.nr_seq_exame		= cliente_busca.nr_seq_exame
			and		a.nr_atendimento	= nr_atendimento_p
			and		a.dt_resultado between inicio_dia(clock_timestamp()) and clock_timestamp();

		end if;
		
		if (qt_resultado_w >= 0) then
			
			select 	coalesce(max(b.qt_resultado),-1)
			into STRICT	qt_resultado_d3_w
			from 	exame_lab_result_item b,
					exame_lab_resultado a,
					prescr_procedimento x,
					prescr_medica c
			where	a.nr_seq_resultado	= b.nr_seq_resultado
			and		a.nr_prescricao		= c.nr_prescricao
			and		x.nr_sequencia		= b.nr_seq_prescr
			and		x.nr_prescricao		= c.nr_prescricao
			and		b.nr_seq_exame		= cliente_busca.nr_seq_exame
			and		c.nr_atendimento	= nr_atendimento_p
			and		x.ie_status_atend	>= 35
			and     b.qt_resultado <> qt_resultado_w
			and (a.dt_resultado between inicio_dia(clock_timestamp() - interval '3 days') and clock_timestamp());
			
			if (qt_resultado_d3_w = -1) then
			
				select 	coalesce(max(b.qt_resultado),-1)
				into STRICT	qt_resultado_d3_w
				from 	exame_lab_result_item b,
						exame_lab_resultado a
				where	a.nr_seq_resultado	= b.nr_seq_resultado
				and		coalesce(a.nr_prescricao::text, '') = ''
				and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
				and		b.nr_seq_exame		= cliente_busca.nr_seq_exame
				and		a.nr_atendimento	= nr_atendimento_p
				and     b.qt_resultado <> qt_resultado_w
				and (a.dt_resultado between inicio_dia(clock_timestamp() - interval '3 days') and clock_timestamp());

			end if;
		
			if (qt_resultado_d3_w > 0) and (qt_resultado_d3_w > qt_resultado_w) then
				qt_porcent_w := (((qt_resultado_d3_w - qt_resultado_w) * 100) /  qt_resultado_d3_w);
				if (qt_porcent_w >= 50) then
					qt_retorno_w 	:= qt_porcent_w;
					qt_pontuacao_w	:= Obter_Pontuacao(ie_opcao_p,qt_porcent_w);
					ie_regra_p := 'N';
				end if;
			end if;
			
		end if;

	end if;
	end if;
		
if (qt_pontuacao_w > 0) then
	exit;
end if;

end loop;
end if;
qt_retorno_p 	:= qt_retorno_w;
qt_pontuacao_p	:= qt_pontuacao_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_dados_escala_sepse (( nr_atendimento_p bigint, ie_opcao_p bigint, qt_retorno_p out bigint, ie_regra_p out text, qt_pontuacao_p out bigint, nm_usuario_p text, ie_atributo_p out text, ie_tipo_sepse_p text default 'A') is  qt_temp_w real) FROM PUBLIC;

