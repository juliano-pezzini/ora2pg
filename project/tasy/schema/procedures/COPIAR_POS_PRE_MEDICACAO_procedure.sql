-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_pos_pre_medicacao ( nr_seq_paciente_p bigint, nr_seq_medic_p bigint) AS $body$
DECLARE


ie_existe_medic_w varchar(1);
nr_prox_agrupamento_w   paciente_protocolo_medic.nr_agrupamento%type;
nr_prox_seq_material_w  paciente_protocolo_medic.nr_seq_material%type;


BEGIN

if (nr_seq_paciente_p IS NOT NULL AND nr_seq_paciente_p::text <> '' AND nr_seq_medic_p IS NOT NULL AND nr_seq_medic_p::text <> '') then

  select  coalesce(max('S'),'N')
  into STRICT    ie_existe_medic_w
  from    protocolo_pos_pre_medic
  where   nr_sequencia = nr_seq_medic_p;

  if (ie_existe_medic_w = 'S') then
      select  coalesce(max(nr_agrupamento), 0) + 1
      into STRICT    nr_prox_agrupamento_w
      from    paciente_protocolo_medic
      where   nr_seq_paciente = nr_seq_paciente_p;

      select  coalesce(max(nr_seq_material), 0) + 1
      into STRICT    nr_prox_seq_material_w
      from    paciente_protocolo_medic
      where   nr_seq_paciente = nr_seq_paciente_p;

      insert into paciente_protocolo_medic(
              nr_seq_paciente,
              nr_seq_material,
              cd_material,
              ie_via_aplicacao,
              cd_unidade_medida,
              qt_dose,
              ds_dias_aplicacao,
              ds_ciclos_aplicacao,
              ie_pre_medicacao,
              nr_agrupamento,
              nm_usuario,
              dt_atualizacao,
              ie_bomba_infusao,
              nr_seq_interno)
      SELECT  nr_seq_paciente_p,
              nr_prox_seq_material_w,
              cd_material,
              ie_via_aplicacao,
              cd_unidade_medida,
              qt_dose,
              ds_dias_aplicacao,
              ds_ciclos_aplicacao,
              ie_pre_medicacao,
              nr_prox_agrupamento_w,
              wheb_usuario_pck.get_nm_usuario,
              clock_timestamp(),
              'N',
              nextval('paciente_protocolo_medic_seq')
      from    protocolo_pos_pre_medic m
      where   nr_sequencia = nr_seq_medic_p
      and     coalesce(m.ie_situacao,'A') = 'A';
  end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_pos_pre_medicacao ( nr_seq_paciente_p bigint, nr_seq_medic_p bigint) FROM PUBLIC;

