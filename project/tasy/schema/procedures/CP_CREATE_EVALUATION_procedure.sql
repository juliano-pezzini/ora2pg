-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cp_create_evaluation ( nr_seq_care_plan_p cp_evaluation.nr_seq_care_plan%type, ds_unique_value_p cp_goal.ds_unique_value%type, nm_usuario_p cp_evaluation.nm_usuario%type ) AS $body$
DECLARE


nr_seq_goal_w	cp_evaluation.nr_seq_goal%type;
nr_sequencia_w	cp_evaluation.nr_sequencia%type;


BEGIN

begin
	select	g.nr_sequencia,
		e.nr_sequencia
	into STRICT	nr_seq_goal_w,
		nr_sequencia_w
	from	cp_goal g
		left outer join cp_evaluation e on e.nr_seq_goal = g.nr_sequencia and e.nr_seq_care_plan = nr_seq_care_plan_p
	where	g.nr_sequencia = (
		SELECT	max(nr_sequencia)
		from	cp_goal
		where	ds_unique_value = ds_unique_value_p
			and (ie_situacao = 'I' and si_import_status = 'SP' or ie_situacao = 'A')
	);
exception
	when no_data_found then
	begin
		nr_seq_goal_w	:= null;
		nr_sequencia_w	:= null;
	end;
end;

if ((nr_seq_goal_w IS NOT NULL AND nr_seq_goal_w::text <> '') and coalesce(nr_sequencia_w::text, '') = '') then
	select	nextval('cp_evaluation_seq')
	into STRICT	nr_sequencia_w
	;
	
	insert into cp_evaluation(
		nr_sequencia,
		nr_seq_care_plan,
		nr_seq_goal,
		ie_origin,
		si_import_status,
		ie_situacao,
		nm_usuario,
		dt_atualizacao,
		nm_usuario_nrec,
		dt_atualizacao_nrec
	) values (
		nr_sequencia_w,
		nr_seq_care_plan_p,
		nr_seq_goal_w,
		'E', -- From Elsevier
		'SP',
		'I',
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp()
	);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cp_create_evaluation ( nr_seq_care_plan_p cp_evaluation.nr_seq_care_plan%type, ds_unique_value_p cp_goal.ds_unique_value%type, nm_usuario_p cp_evaluation.nm_usuario%type ) FROM PUBLIC;

