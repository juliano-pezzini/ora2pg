-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_ontologia ( nr_seq_conceito_elemento_p bigint, ie_ontologia_p text, nm_usuario_p text) AS $body$
DECLARE


ds_lista_w		varchar(2000);
nm_tabela_w		varchar(50);
nm_tabela_ref_w		varchar(50);
nm_atributo_w		varchar(50);
nm_atributo_pk_w		varchar(50);
ie_componente_w		varchar(5);
cd_exp_valores_w		bigint;
ds_valores_w		varchar(2000);
cd_dominio_w		integer;
nr_seq_localizador_w	bigint;
ds_informacao_w		varchar(255);

k			integer;
ds_lista_aux_w		varchar(2000) := '';
cd_valor_tasy_w		varchar(255);

posicao_cd_w		bigint;
posicao_ds_w		bigint;
nm_atributo_inf_w	varchar(255);

SQLConsulta   		varchar(2000)      := null;
CursorConsulta    	REFCURSOR;


BEGIN

if (nr_seq_conceito_elemento_p IS NOT NULL AND nr_seq_conceito_elemento_p::text <> '' AND ie_ontologia_p IS NOT NULL AND ie_ontologia_p::text <> '') then
	select	max(a.nm_tabela),
		max(a.nm_atributo)
	into STRICT	nm_tabela_w,
		nm_atributo_w
	from	conceito_elemento_attrib a
	where	nr_sequencia = nr_seq_conceito_elemento_p;

	if (nm_tabela_w IS NOT NULL AND nm_tabela_w::text <> '' AND nm_atributo_w IS NOT NULL AND nm_atributo_w::text <> '') then
		select	max(a.ie_componente),
			max(a.cd_exp_valores),
			max(REPLACE(trim(both ds_valores),chr(13)||chr(10),' ')),
			max(a.cd_dominio),
			max(a.nr_seq_localizador),
			substr(max(obter_desc_expressao(a.cd_exp_label)),1,255)
		into STRICT	ie_componente_w,
			cd_exp_valores_w,
			ds_valores_w,
			cd_dominio_w,
			nr_seq_localizador_w,
			ds_informacao_w
		from	tabela_atributo a
		where	upper(a.nm_tabela) = upper(nm_tabela_w)
		and	upper(a.nm_atributo) = upper(nm_atributo_w);

		if (ie_componente_w = 'cb') then
			if (cd_exp_valores_w IS NOT NULL AND cd_exp_valores_w::text <> '') then
				ds_lista_w := obter_desc_expressao(cd_exp_valores_w);
			elsif (ds_valores_w IS NOT NULL AND ds_valores_w::text <> '') then
				ds_lista_w := ds_valores_w;
			end if;
		elsif (ie_componente_w = 'lcb') then
			if (cd_dominio_w IS NOT NULL AND cd_dominio_w::text <> '') then
				select	obter_select_concatenado_bv(
					'select	a.vl_dominio
					from	valor_dominio a
					where	a.cd_dominio = :cd_dominio
					and	a.ie_situacao = ''A''
					order by	a.vl_dominio',
					'cd_dominio='||cd_dominio_w,
					',')
				into STRICT	ds_lista_w
				;
			elsif (ds_valores_w IS NOT NULL AND ds_valores_w::text <> '') then

				select	substr((select b.table_name from user_constraints b where b.constraint_name = a.r_constraint_name),1,30)
				into STRICT	nm_tabela_ref_w
				from	user_constraints a,
						user_cons_columns c
				where	a.constraint_name = c.constraint_name
				and		a.table_name = upper(nm_tabela_w)
				and		c.column_name = upper(nm_atributo_w)
				and		a.constraint_type in ('P','R');

				if (nm_tabela_ref_w IS NOT NULL AND nm_tabela_ref_w::text <> '') then
					select	substr(c.column_name,1,50)
					into STRICT	nm_atributo_pk_w
					from	user_constraints a,
							user_cons_columns c
					where	a.constraint_name = c.constraint_name
					and		a.table_name = upper(nm_tabela_ref_w)
					and		a.constraint_type in ('P');

					if (nm_atributo_pk_w IS NOT NULL AND nm_atributo_pk_w::text <> '') then


						ds_lista_w := ds_valores_w;

						Select  position('cd,' in replace(ds_lista_w,'cd ','cd')),
								position('ds ' in ds_lista_w)
						into STRICT	posicao_cd_w,
								posicao_ds_w
						;


						Select 	trim(substr(ds_lista_w,(posicao_cd_w + 4), (posicao_ds_w - (posicao_cd_w + 4))))
						into STRICT	nm_atributo_inf_w
						;

					end if;

				end if;
			end if;
		elsif (ie_componente_w = 'rg') then
			if (cd_exp_valores_w IS NOT NULL AND cd_exp_valores_w::text <> '') then
				ds_lista_w := obter_desc_expressao(cd_exp_valores_w);
				ds_lista_w := substr(ds_lista_w,position('(' in ds_lista_w)+1,position(')' in ds_lista_w)-2);
			elsif (ds_valores_w IS NOT NULL AND ds_valores_w::text <> '') then
				ds_lista_w := ds_valores_w;
				ds_lista_w := substr(ds_lista_w,position('(' in ds_lista_w)+1,position(')' in ds_lista_w)-2);
			end if;
		end if;


		if (nm_atributo_inf_w IS NOT NULL AND nm_atributo_inf_w::text <> '') then


		 SQLConsulta   :=
            ' select ' || nm_atributo_pk_w || ', '       ||
            ' 		 ' || nm_atributo_inf_w || ' '      ||
            ' from	 ' || nm_tabela_ref_w || '' 	||
            ' order by 2';



		open CursorConsulta for EXECUTE SQLConsulta;

		loop
		fetch CursorConsulta into
				cd_valor_tasy_w,
				ds_informacao_w;
		EXIT WHEN NOT FOUND; /* apply on CursorConsulta */
			begin

			insert into ehr_elemento_interop_terms(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_conceito_atributo,
					nm_tabela,
					nm_atributo,
					ie_ontologia,
					cd_valor_tasy,
					cd_valor_ontologia,
					ds_informacao,
					nm_tabela_atributo)
				values (	nextval('ehr_elemento_interop_terms_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_conceito_elemento_p,
					nm_tabela_w,
					nm_atributo_w,
					ie_ontologia_p,
					cd_valor_tasy_w,
					null,
					ds_informacao_w,
					nm_tabela_ref_w);



			end;
		end loop;
		close CursorConsulta;


		elsif (ds_lista_w IS NOT NULL AND ds_lista_w::text <> '') then
			if (substr(ds_lista_w,length(ds_lista_w)) <> ',') then
				ds_lista_w := ds_lista_w ||',';
			end if;

			while (ds_lista_w IS NOT NULL AND ds_lista_w::text <> '') loop
				begin
				select	position(',' in ds_lista_w)
				into STRICT	k
				;

				if (k > 1) and ((substr(ds_lista_w, 1, k -1) IS NOT NULL AND (substr(ds_lista_w, 1, k -1))::text <> '')) then
					ds_lista_aux_w := substr(ds_lista_w, 1, k-1);
					cd_valor_tasy_w := replace(ds_lista_aux_w, ',','');
					ds_lista_w := substr(ds_lista_w, k + 1, 2000);
				elsif (ds_lista_w IS NOT NULL AND ds_lista_w::text <> '') then
					cd_valor_tasy_w := replace(ds_lista_w,',','');
					ds_lista_w := '';
				end if;

				if (ie_componente_w = 'lcb') then

					If (cd_dominio_w IS NOT NULL AND cd_dominio_w::text <> '') then

						select	obter_desc_expressao(a.cd_exp_valor_dominio)
						into STRICT	ds_informacao_w
						from	valor_dominio a
						where	a.cd_dominio = cd_dominio_w
						and	a.vl_dominio = cd_valor_tasy_w;

					end if;

				elsif (ie_componente_w = 'rg') then
					select	obter_desc_radio_group(cd_exp_valores_w,cd_valor_tasy_w)
					into STRICT	ds_informacao_w
					;
				end if;

				insert into ehr_elemento_interop_terms(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_conceito_atributo,
					nm_tabela,
					nm_atributo,
					ie_ontologia,
					cd_valor_tasy,
					cd_valor_ontologia,
					ds_informacao)
				values (	nextval('ehr_elemento_interop_terms_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_conceito_elemento_p,
					nm_tabela_w,
					nm_atributo_w,
					ie_ontologia_p,
					cd_valor_tasy_w,
					null,
					ds_informacao_w);
				end;
			end loop;
		end if;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_ontologia ( nr_seq_conceito_elemento_p bigint, ie_ontologia_p text, nm_usuario_p text) FROM PUBLIC;

