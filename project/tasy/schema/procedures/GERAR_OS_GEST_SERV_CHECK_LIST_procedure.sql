-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_os_gest_serv_check_list ( nr_sequencia_p bigint, cd_setor_p bigint, ds_setor_p text, cd_pessoa_solic_p text, nm_usuario_p text) AS $body$
DECLARE



ds_item_padrao_w		varchar(255);
nr_seq_grupo_w 			bigint;
nr_seq_checklist_w		bigint;
nr_seq_item_checklist_w		bigint;
ie_resultado_w			varchar(1);
ds_item_w			varchar(255);
ds_grupo_w			varchar(255);
ds_observacao_w			varchar(500);

nr_ordem_servico_w 		bigint;
nr_seq_usu_w  			bigint;
nr_sequencia_w 			bigint;
cd_estabelecimento_w		bigint;
nr_seq_localizacao_w		bigint;
ie_classificacao_w		varchar(10);
ie_status_ordem_w		varchar(10);
nr_grupo_planej_w		bigint;
nr_grupo_trabalho_w		bigint;
nr_seq_tipo_solucao_w		bigint;
nr_seq_estagio_w		bigint;
nr_seq_equipamento_w		bigint;
IE_TIPO_ORDEM_w			bigint;
cd_pessoa_fisica_w		varchar(10);
nm_medico_solic_w		varchar(100);
nr_atendimento_w		bigint;
cd_medico_dest_w		varchar(10);
ie_desfecho_w			varchar(10);
cd_medico_dest_ww		varchar(10);
ie_medico_ciente_w		varchar(10);
qt_reg_w			bigint;
qt_regra_funcao_w		bigint;
nr_seq_regras_item_w		bigint;
nr_seq_item_check_w		bigint;
nr_seq_grupo_check_w		bigint;
ie_gerar_os_w			varchar(10);
C01 CURSOR FOR
	SELECT *
	from (	SELECT	distinct
				a.ds_grupo ds_item_padrao,
				a.nr_sequencia nr_seq_grupo,
				c.nr_seq_checklist nr_seq_checklist,
				null nr_seq_item_checklist,
				null ie_resultado,
				null ds_item,
				a.ds_grupo ds_grupo,
				null ds_observacao,
				null nr_seq_item_check_w,
				null nr_seq_grupo_check_w
			from	sl_check_list_unid_item c,
				sl_item_check_list b,
				sl_grupo_check_list a
			where	c.nr_seq_item_check_list = b.nr_sequencia
			and	b.nr_seq_grupo_check_list = a.nr_sequencia
			and	c.nr_seq_checklist = nr_sequencia_p
			and	coalesce(b.ie_situacao, 'A') = 'A'
			and	coalesce(a.ie_situacao, 'A') = 'A'
			
union

			select	distinct
				'       ' || b.ds_item ds_item_padrao,
				a.nr_sequencia nr_seq_grupo,
				c.nr_seq_checklist nr_seq_checklist,
				c.nr_sequencia nr_seq_item_checklist,
				ie_resultado ie_resultado,
				b.ds_item,
				a.ds_grupo ds_grupo,
				c.ds_observacao,
				b.nr_sequencia nr_seq_item_check_w,
				a.nr_sequencia nr_seq_grupo_check_w
			from	sl_check_list_unid_item c,
				sl_item_check_list b,
				sl_grupo_check_list a
			where	c.nr_seq_item_check_list = b.nr_sequencia
			and	b.nr_seq_grupo_check_list = a.nr_sequencia
			and	c.nr_seq_checklist = nr_sequencia_p
			and	coalesce(b.ie_situacao, 'A') = 'A'
			and	coalesce(a.ie_situacao, 'A') = 'A'
			) a
		WHERE 	coalesce(a.nr_seq_item_checklist,0) > 0;

C02 CURSOR FOR
	SELECT	a.nr_sequencia
	from	regra_padrao_ordem_servico a,
		sl_geracao_ordem_servico b
	where	a.nr_sequencia = b.nr_seq_regra
	and	a.ie_tipo = 'C'
	and (nr_item_check_list = nr_seq_item_check_w or nr_grupo_check_list = nr_seq_grupo_check_w)
	and	b.ie_situacao = 'A';



BEGIN
ie_gerar_os_w := Obter_param_Usuario(75, 83, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_gerar_os_w);
if (coalesce(ie_gerar_os_w,'N') = 'S') then
	select	count(*)
	into STRICT	qt_reg_w
	from	regra_padrao_ordem_servico
	where	cd_estabelecimento	= wheb_usuario_pck.get_cd_estabelecimento
	and	IE_TIPO = 'C';

	if (qt_reg_w = 0) then
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(209522);
	end if;

	select  count(*)
	into STRICT	qt_regra_funcao_w
	from	sl_geracao_ordem_servico;

	if (qt_regra_funcao_w = 0) then
		if (coalesce(nr_sequencia_p,0) > 0) and (coalesce(qt_reg_w,0) > 0) then
		select	coalesce(max(cd_estabelecimento)	,9999),
			coalesce(max(nr_seq_localizacao)	,9999),
			coalesce(max(ie_classificacao)	,'XxX'),
			coalesce(max(ie_status_ordem)	,'XxX'),
			coalesce(max(nr_grupo_planej)	,9999),
			coalesce(max(nr_grupo_trabalho)	,9999),
			coalesce(max(nr_seq_tipo_solucao)	,9999),
			coalesce(max(nr_seq_estagio)		,9999),
			coalesce(max(nr_seq_equipamento)	,9999),
			coalesce(max(IE_TIPO_ORDEM)		,9999)
		into STRICT	cd_estabelecimento_w,
			nr_seq_localizacao_w,
			ie_classificacao_w,
			ie_status_ordem_w,
			nr_grupo_planej_w,
			nr_grupo_trabalho_w,
			nr_seq_tipo_solucao_w,
			nr_seq_estagio_w,
			nr_seq_equipamento_w,
			IE_TIPO_ORDEM_w
		from	regra_padrao_ordem_servico
		where	cd_estabelecimento	= wheb_usuario_pck.get_cd_estabelecimento
		and	IE_TIPO = 'C';

		if (coalesce(cd_setor_p,0) > 0) and (coalesce(nr_seq_localizacao_w,9999) = 9999) then


		select 	coalesce(max(nr_sequencia),9999)
		into STRICT 	nr_seq_localizacao_w
		from	man_localizacao
		where	cd_setor = cd_setor_p;


		end if;

		if (cd_estabelecimento_w 	= 9999)  or (nr_seq_localizacao_w 	= 9999)  or (ie_classificacao_w 		= 'XxX') or (ie_status_ordem_w 		= 'XxX') or (nr_grupo_planej_w 		= 9999)  or (nr_grupo_trabalho_w 	= 9999)  or (nr_seq_tipo_solucao_w 	= 9999)  or (nr_seq_estagio_w 		= 9999)  or (nr_seq_equipamento_w 	= 9999)  or (IE_TIPO_ORDEM_w 		= 9999)  then
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(209525);
		end if;


			open C01;
			loop
			fetch C01 into
				ds_item_padrao_w,
				nr_seq_grupo_w,
				nr_seq_checklist_w,
				nr_seq_item_checklist_w,
				ie_resultado_w,
				ds_item_w,
				ds_grupo_w,
				ds_observacao_w,
				nr_seq_item_check_w,
				nr_seq_grupo_check_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
				begin
				if (upper(ie_resultado_w)  = 'N') then

				man_gerar_ordem_servico(coalesce(nr_seq_localizacao_w, 2427),       		-- Número da localização - código do hospital - Pode procurar no campo 'Localização' da OS.
							    coalesce(nr_seq_equipamento_w,2547),   					-- Número do equipamento - Procurar no campo 'Equipamento' da OS.   Ex: procurar 'Sistema Tasy' e copiar o código.
							    cd_pessoa_solic_p,
							    clock_timestamp(),
							    'M',    								--  'B' - Baixa, 'M' - Média, 'A' - Alta, 'E' - Emergência, 'S' - Sem prioridade, 'U' - urgente
							    'N',
							    substr(OBTER_DESC_EXPRESSAO(334827) || ' - ' || OBTER_DESC_EXPRESSAO(531312), 1, 4000),	--'Gestão de serviço de leito - Liberação de Check-list'
							     nm_usuario_p,
							    substr(OBTER_DESC_EXPRESSAO(334827) || ' - ' || OBTER_DESC_EXPRESSAO(531312), 1, 4000) ||chr(13) ||chr(10) ||	--'Gestão de serviço de leito - Liberação de Check-list'
							    SUBSTR(OBTER_DESC_EXPRESSAO(329934), 1, 4000)||' '||ds_item_w ||chr(13) ||chr(10) ||
							    ds_setor_p ||chr(13) || chr(10) ||
							    SUBSTR(OBTER_DESC_EXPRESSAO(294639) || OBTER_DESC_EXPRESSAO(516998)|| ': ', 1, 4000)|| ds_observacao_w,
							    coalesce(IE_TIPO_ORDEM_w,'3'), -- '0' - Cliente, '1' - Corretiva, '2' - Preventiva, '3' - Programada, '4' - Desenvolvimento, '5' - Calibração, '6' - Treinamento, '10' - Solicitação de versão extra
							    coalesce(ie_status_ordem_w, '1'), -- '1' - Aberta, '2' - Processo, '3' - Encerrado
							    coalesce(ie_classificacao_w, 'S'), -- 'D' - Dúvida, 'E' - Erro, 'T' - Sugestão, 'S' - Solicitação
							    coalesce(nr_seq_estagio_w, 21),
							    coalesce(nr_grupo_planej_w, 29),
							    coalesce(nr_grupo_trabalho_w, 42),
							    nr_ordem_servico_w);

				select  nextval('man_ordem_servico_exec_seq')
				into STRICT 	nr_seq_usu_w
				;

				insert  into man_ordem_servico_exec(
									nr_sequencia,
									nr_seq_ordem,
									dt_atualizacao,
									nm_usuario,
									nm_usuario_exec,
									qt_min_prev,
									nr_seq_funcao,
									nr_seq_tipo_exec)
				SELECT	nextval('man_ordem_servico_exec_seq'),
					nr_ordem_servico_w,
					clock_timestamp(),
					nm_usuario_p,
					a.nm_usuario_param,
					60,
					null, -- Informar o código da Função
					null  -- Informar o código do tipo de execução
				from	MAN_GRUPO_TRAB_USUARIO a
				where	a.NR_SEQ_GRUPO_TRAB	= nr_grupo_trabalho_w;

				select 	nextval('man_ordem_serv_tecnico_seq')
				into STRICT 	nr_sequencia_w
				;

				insert into man_ordem_serv_tecnico(
								  nr_sequencia,
								  nr_seq_ordem_serv,
								  dt_atualizacao,
								  nm_usuario,
								  ds_relat_tecnico,
								  dt_historico,
								  ie_origem,
								  dt_liberacao,
								  nm_usuario_lib)
							values (   nr_sequencia_w,
								  nr_ordem_servico_w,
								  clock_timestamp(),
								  nm_usuario_p,
								  ' ',
								  clock_timestamp(),
								  'I',
								  clock_timestamp(),
								  nm_usuario_p);

				end if;
				end;
			end loop;
			close C01;

		end if;

	else

		open C01;
		loop
		fetch C01 into
			ds_item_padrao_w,
			nr_seq_grupo_w,
			nr_seq_checklist_w,
			nr_seq_item_checklist_w,
			ie_resultado_w,
			ds_item_w,
			ds_grupo_w,
			ds_observacao_w,
			nr_seq_item_check_w,
			nr_seq_grupo_check_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin

			if (upper(ie_resultado_w)  = 'N') then

				if ((coalesce(nr_seq_grupo_w,0) > 0) or (coalesce(nr_seq_item_checklist_w,0) > 0)) then


					open C02;
					loop
					fetch C02 into
						nr_seq_regras_item_w;
					EXIT WHEN NOT FOUND; /* apply on C02 */
						begin

						select	coalesce(max(cd_estabelecimento)	,9999),
							coalesce(max(nr_seq_localizacao)	,9999),
							coalesce(max(ie_classificacao)	,'XxX'),
							coalesce(max(ie_status_ordem)	,'XxX'),
							coalesce(max(nr_grupo_planej)	,9999),
							coalesce(max(nr_grupo_trabalho)	,9999),
							coalesce(max(nr_seq_tipo_solucao)	,9999),
							coalesce(max(nr_seq_estagio)		,9999),
							coalesce(max(nr_seq_equipamento)	,9999),
							coalesce(max(IE_TIPO_ORDEM)		,9999)
						into STRICT	cd_estabelecimento_w,
							nr_seq_localizacao_w,
							ie_classificacao_w,
							ie_status_ordem_w,
							nr_grupo_planej_w,
							nr_grupo_trabalho_w,
							nr_seq_tipo_solucao_w,
							nr_seq_estagio_w,
							nr_seq_equipamento_w,
							IE_TIPO_ORDEM_w
						from	regra_padrao_ordem_servico
						where	nr_sequencia 		= nr_seq_regras_item_w;

						if (coalesce(cd_setor_p,0) > 0) and (coalesce(nr_seq_localizacao_w,9999) = 9999) then
							select 	coalesce(max(nr_sequencia),9999)
							into STRICT 	nr_seq_localizacao_w
							from	man_localizacao
							where	cd_setor = cd_setor_p;
						end if;

						if (cd_estabelecimento_w = 9999)  or (nr_seq_localizacao_w = 9999)  or (ie_classificacao_w = '')   or (ie_status_ordem_w = '')    or (nr_grupo_planej_w = 9999)     or (nr_grupo_trabalho_w = 9999)   or (nr_seq_tipo_solucao_w = 9999) or (nr_seq_estagio_w = 9999)      or (nr_seq_equipamento_w = 9999)  or (IE_TIPO_ORDEM_w = 9999)       then
							CALL Wheb_mensagem_pck.exibir_mensagem_abort(209525);
						end if;



						man_gerar_ordem_servico(coalesce(nr_seq_localizacao_w, 2427), -- Número da localização - código do hospital - Pode procurar no campo 'Localização' da OS.
									coalesce(nr_seq_equipamento_w,2547),  -- Número do equipamento - Procurar no campo 'Equipamento' da OS.   Ex: procurar 'Sistema Tasy' e copiar o código.
									cd_pessoa_solic_p,
									clock_timestamp(),
									'M',				--  'B' - Baixa, 'M' - Média, 'A' - Alta, 'E' - Emergência, 'S' - Sem prioridade, 'U' - urgente
									'N',
									substr(OBTER_DESC_EXPRESSAO(334827) || ' - ' || OBTER_DESC_EXPRESSAO(531312), 1, 4000),	--'Gestão de serviço de leito - Liberação de Check-list',
									nm_usuario_p,
									substr(OBTER_DESC_EXPRESSAO(334827) || ' - ' || OBTER_DESC_EXPRESSAO(531312), 1, 4000) ||chr(13) ||chr(10) || --'Gestão de serviço de leito - Liberação de Check-list'
									SUBSTR(OBTER_DESC_EXPRESSAO(329934), 1, 4000)||' '||ds_item_w ||chr(13) ||chr(10) ||
									ds_setor_p ||chr(13) || chr(10) ||
									SUBSTR(OBTER_DESC_EXPRESSAO(294639) || OBTER_DESC_EXPRESSAO(516998)|| ': ', 1, 4000)|| ds_observacao_w,
									coalesce(IE_TIPO_ORDEM_w,'3'), -- '0' - Cliente, '1' - Corretiva, '2' - Preventiva, '3' - Programada, '4' - Desenvolvimento, '5' - Calibração, '6' - Treinamento, '10' - Solicitação de versão extra
									coalesce(ie_status_ordem_w, '1'), -- '1' - Aberta, '2' - Processo, '3' - Encerrado
									coalesce(ie_classificacao_w, 'S'), -- 'D' - Dúvida, 'E' - Erro, 'T' - Sugestão, 'S' - Solicitação
									coalesce(nr_seq_estagio_w, 21),
									coalesce(nr_grupo_planej_w, 29),
									coalesce(nr_grupo_trabalho_w, 42),
									nr_ordem_servico_w);

						select  nextval('man_ordem_servico_exec_seq')
						into STRICT 	nr_seq_usu_w
						;

						insert  into man_ordem_servico_exec(
										nr_sequencia,
										nr_seq_ordem,
										dt_atualizacao,
										nm_usuario,
										nm_usuario_exec,
										qt_min_prev,
										nr_seq_funcao,
										nr_seq_tipo_exec)
									SELECT	nextval('man_ordem_servico_exec_seq'),
										nr_ordem_servico_w,
										clock_timestamp(),
										nm_usuario_p,
										a.nm_usuario_param,
										60,
										null, -- Informar o código da Função
										null  -- Informar o código do tipo de execução
									from	MAN_GRUPO_TRAB_USUARIO a
									where	a.NR_SEQ_GRUPO_TRAB	= nr_grupo_trabalho_w;

						select 	nextval('man_ordem_serv_tecnico_seq')
						into STRICT 	nr_sequencia_w
						;

						insert into man_ordem_serv_tecnico(
										nr_sequencia,
										nr_seq_ordem_serv,
										dt_atualizacao,
										nm_usuario,
										ds_relat_tecnico,
										dt_historico,
										ie_origem,
										dt_liberacao,
										nm_usuario_lib)
								values (   	nr_sequencia_w,
										nr_ordem_servico_w,
										clock_timestamp(),
										nm_usuario_p,
										' ',
										clock_timestamp(),
										'I',
										clock_timestamp(),
										nm_usuario_p);
						end;
					end loop;
					close C02;

				end if;

			end if;

			end;
		end loop;

		close C01;

	end if;
end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_os_gest_serv_check_list ( nr_sequencia_p bigint, cd_setor_p bigint, ds_setor_p text, cd_pessoa_solic_p text, nm_usuario_p text) FROM PUBLIC;

