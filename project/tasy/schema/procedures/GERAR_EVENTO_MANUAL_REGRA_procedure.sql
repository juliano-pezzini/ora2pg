-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_evento_manual_regra ( ie_evento_disp_p text, nm_usuario_p text, ds_mensagem_p text, ds_titulo_p text, cd_destinatario_p text, nr_atendimento_p bigint , ie_forma_ev_p text) AS $body$
DECLARE

 
nr_seq_regra_envio_sms_w	bigint;
nr_seq_evento_w			bigint := 0;
cd_pessoa_fisica_w		varchar(10);

nr_seq_ev_pac_w			bigint;
			

BEGIN 
 
nr_seq_evento_w := obter_evento_regra_envio(ie_evento_disp_p);
 
if not(nr_seq_evento_w > 0) then	 
	--(-20011,' Não existe evento informado para a ação '||ie_evento_disp_p||'#13'||'Favor cadastrar um evento para a ação no cadastro de Regra de envio de alertas e eventos' || '#@#@'); 
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(264469,'IE_EVENTO_DISP_P=' || IE_EVENTO_DISP_P);
end if;
 
if (nr_atendimento_p > 0) then 
	select	max(cd_pessoa_fisica) 
	into STRICT	cd_pessoa_fisica_w	 
	from	atendimento_paciente 
	where	nr_atendimento = nr_atendimento_p;
else	 
	cd_pessoa_fisica_w	:= cd_destinatario_p;
end if;
 
if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then 
	 
	select	nextval('ev_evento_paciente_seq') 
	into STRICT	nr_seq_ev_pac_w 
	;
	 
	insert into ev_evento_paciente( 
		nr_sequencia, 
		nr_seq_evento, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		cd_pessoa_fisica, 
		nr_atendimento, 
		ds_titulo, 
		ds_mensagem, 
		ie_status, 
		ds_maquina, 
		dt_evento, 
		dt_liberacao) 
	values (	nr_seq_ev_pac_w, 
		nr_seq_evento_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_pessoa_fisica_w, 
		CASE WHEN nr_atendimento_p=0 THEN null  ELSE nr_atendimento_p END , 
		ds_titulo_p, 
		ds_mensagem_p, 
		'G', 
		substr(obter_inf_sessao(0),1,80), 
		clock_timestamp(), 
		clock_timestamp());
 
	insert into ev_evento_pac_destino( 
		nr_sequencia, 
		nr_seq_ev_pac, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		cd_pessoa_fisica, 
		ie_forma_ev, 
		ie_status, 
		dt_ciencia, 
		dt_evento) 
	values (	nextval('ev_evento_pac_destino_seq'), 
		nr_seq_ev_pac_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_destinatario_p, 
		ie_forma_ev_p, 
		'G', 
		null, 
		clock_timestamp());	
	 
end if;
	 
	 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_evento_manual_regra ( ie_evento_disp_p text, nm_usuario_p text, ds_mensagem_p text, ds_titulo_p text, cd_destinatario_p text, nr_atendimento_p bigint , ie_forma_ev_p text) FROM PUBLIC;

