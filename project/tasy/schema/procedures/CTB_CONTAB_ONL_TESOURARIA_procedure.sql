-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_contab_onl_tesouraria ( doc_p INOUT ctb_documento, nm_usuario_p text) AS $body$
DECLARE

/*
===============================================================================
Purpose: Indentacao

Remarks: n/a

Who         When            What
----------  -----------     --------------------------------------------------

chjreinert  13/mai/2021     OS 2444975 - Indentacao

===============================================================================
*/
cd_agencia_cheque_w             cheque_cr_v.cd_agencia_bancaria%type;
cd_banco_cheque_w               cheque_cr_v.cd_banco%type;
cd_banco_ext_cheque_w           banco.cd_banco_externo%type;
cd_cnpj_cheque_w                varchar(14);
cd_conta_caixa_w                caixa.cd_conta_contabil%type;
cd_conta_contab_movto_w         movto_trans_financ.cd_conta_contabil%type;
cd_conta_transitoria_w          ctb_regra_estab_dif.cd_conta_contabil%type;
cd_empresa_w                    empresa.cd_empresa%type;
cd_estab_caixa_od_w             caixa.cd_estabelecimento%type;
cd_estabelecimento_w            estabelecimento.cd_estabelecimento%type;
cd_hist_caixa_movto_w           transacao_financeira.cd_historico_caixa%type;
cd_historico_ct_w               ctb_regra_estab_dif.cd_historico%type;
cd_historico_movto_w            movto_trans_financ.cd_historico%type;
cd_historico_w                  ctb_param_lote_tesouraria.cd_historico%type;
cd_pessoa_caixa_receb_w         caixa_receb.cd_cgc%type;
ctb_movimento_w                 ctb_movimento%rowtype;
ctb_movimento_doc_w             ctb_online_pck.ctb_movimento_doc;
ctb_movto_centro_custo_w        ctb_movto_centro_custo%rowtype;
ctb_param_lote_tesouraria_w     ctb_param_lote_tesouraria%rowtype;
dados_contab_w                  ctb_contab_onl_lote_fin_pck.dados_contab_tf;
ds_atributos_w                  varchar(4000);
ds_banco_cheque_w               cheque_cr_v.ds_banco%type;
ds_banco_od_w                   banco.ds_banco%type;
ds_bandeira_w                   bandeira_cartao_cr.ds_bandeira%type;
ds_caixa_od_w                   caixa.ds_caixa%type;
ds_caixa_w                      caixa.ds_caixa%type;
ds_classificacao_w              classif_caixa.ds_classificacao%type;
ds_cheque_cp_w                  varchar(180);
ds_cheque_deposito_w            varchar(255);
ds_cheques_caixa_rec_w          varchar(255);
ds_compl_pf_pj_movto_w          varchar(255);
ds_conta_banco_pend_w           banco_estabelecimento_v.ds_conta%type;
ds_conta_od_w                   banco_estabelecimento_v.ds_conta%type;
ds_estorno_w                    varchar(255);
ds_forma_pagto_w                forma_pagto_cartao_cr.ds_forma_pagto%type;
ds_hist_movto_w                 movto_trans_financ.ds_historico%type;
ds_hist_pf_pj_w                 varchar(255);
ds_historico_w                  movto_trans_financ.ds_historico%type;
ds_movto_cartao_w               varchar(255);
ds_obs_adiantamento_w           adiantamento.ds_observacao%type;
ds_obs_caixa_receb_w            varchar(254);
ds_obs_cartao_w                 movto_cartao_cr.ds_observacao%type;
ds_observacao_cp_w              titulo_pagar.ds_observacao_titulo%type;
ds_observacao_cr_w              titulo_receber.ds_observacao_titulo%type;
ds_observacao_movto_w           varchar(255);/* Foi colocado 255 porque quando e maior do que isto nao gera compl historico (Matheus)*/
ds_pessoa_nota_w                pessoa_juridica.ds_razao_social%type;
ds_pessoa_titulo_w              titulo_receber_v.nm_pessoa%type;
ds_razao_social_cheque_w        cheque_cr_v.ds_razao_social%type;
dt_transacao_w                  movto_trans_financ.dt_transacao%type;
dt_transacao_ww                 varchar(20);
dt_venc_cheque_atual_w          cheque_cr_v.dt_vencimento%type;
ie_caixa_w                      varchar(1) := 'D';
ie_cc_glosa_w                   ctb_param_lote_contas_rec.ie_cc_glosa%type;
ie_compl_hist_w                 varchar(1);
ie_contab_rec_classif_w         ctb_param_lote_contas_rec.ie_contab_rec_classif%type;
ie_contab_desp_cartao_w         ctb_param_lote_contas_rec.ie_contab_desp_cartao%type;
ie_contab_tesouraria_w          transacao_financeira.ie_contab_tesouraria%type;
ie_debito_credito_w             titulo_pagar_baixa_ops.ie_debito_credito%type;
ie_estorno_w                    movto_trans_financ.ie_estorno%type;
ie_nf_nfe_w                     varchar(15);
ie_permite_estab_dif_w          ctb_regra_estab_dif.ie_permite%type;
ie_regra_w                      varchar(1);
ie_saldo_caixa_w                Transacao_financeira.ie_saldo_caixa%type;
ie_union_w                      integer;
nm_agrupador_w                  agrupador_contabil.nm_atributo%type;
nm_estabelecimento_w            estabelecimento.nm_fantasia_estab%type;
nm_mae_pf_w                     pessoa_juridica.ds_razao_social%type;
nm_paciente_adiantamento_w      pessoa_fisica.nm_pessoa_fisica%type;
nm_paciente_atendimento_w       pessoa_juridica.ds_razao_social%type;
nm_paciente_cheque_w            pessoa_fisica.nm_pessoa_fisica%type;
nm_pessoa_caixa_receb_w         pessoa_juridica.ds_razao_social%type;
nm_pessoa_movto_w               pessoa_juridica.ds_razao_social%type;
nm_pf_cheque_w                  cheque_cr_v.nm_pessoa_fisica%type;
nm_pf_pj_cartao_w               pessoa_juridica.ds_razao_social%type;
nr_adiant_cheque_w              cheque_cr_v.nr_adiantamento%type;
nr_adiant_movto_w               adiantamento.nr_adiantamento%type;
nr_adiant_pago_w                movto_trans_financ.nr_adiant_pago%type;
nr_atendimento_w                conta_paciente.nr_atendimento%type;
nr_autorizacao_w                movto_cartao_cr.nr_autorizacao%type;
nr_bordero_w                    movto_trans_financ.nr_bordero%type;
nr_cheque_movto_w               cheque_cr.nr_cheque%type;
nr_cheque_pago_w                cheque.nr_cheque%type;
nr_conta_cheque_w               cheque_cr_v.nr_conta%type;
nr_cpf_cheque_w                 varchar(11);
nr_cpf_w                        pessoa_fisica.nr_cpf%type;
nr_doc_movto_w                  movto_trans_financ.nr_documento%type;
nr_doc_tit_receb_w              titulo_receber_liq.nr_documento%type;
nr_documento_caixa_rec_w        varchar(255);
nr_documento_ww                 movimento_contabil.nr_documento%type;
nr_interno_conta_movto_w        titulo_receber.nr_interno_conta%type;
nr_interno_conta_w              titulo_receber.nr_interno_conta%type;
nr_negociacao_w                 varchar(20);
nr_nfe_imp_w                    nota_fiscal.nr_nfe_imp%type;
nr_nota_fiscal_w                nota_fiscal.nr_nota_fiscal%type;
nr_recibo_caixa_receb_w         bigint;
nr_recibo_rec_w                 caixa_receb.nr_recibo%type;
nr_recibo_w                     adiantamento.nr_recibo%type;
nr_seq_baixa_w                  titulo_receber_liq.nr_sequencia%type;
nr_seq_caixa_rec_w              movto_trans_financ.nr_seq_caixa_rec%type;
nr_seq_caixa_receb_w            caixa_receb.nr_sequencia%type;
nr_seq_caixa_transf_w           movto_trans_financ.nr_seq_caixa%type;
nr_seq_cheque_cp_w              movto_trans_financ.nr_seq_cheque_cp%type;
nr_seq_cheque_w                 deposito_cheque.nr_seq_cheque%type;
nr_seq_cheque_ww                cheque_cr_perda.nr_seq_cheque%type;
nr_seq_cob_escritural_w         cobranca_escritural.nr_sequencia%type;
nr_seq_conv_receb_w             movto_trans_financ.nr_seq_conv_receb%type;
nr_seq_deposito_w               movto_trans_financ.nr_seq_deposito%type;
nr_seq_forma_pagto_w            movto_cartao_cr.nr_seq_forma_pagto%type;
nr_seq_liq_origem_w             titulo_receber_liq.nr_seq_liq_origem%type;
nr_seq_lote_orig_w              movto_trans_financ.nr_seq_lote%type;
nr_seq_lote_transf_w            movto_trans_financ.nr_seq_lote%type;
nr_seq_lote_w                   movto_trans_financ.nr_seq_lote%type;
nr_seq_movto_bco_pend_w         movto_banco_pend_baixa.nr_seq_movto_pend%type;
nr_seq_movto_cartao_w           movto_trans_financ.nr_seq_movto_cartao%type;
nr_seq_movto_orig_w             movto_trans_financ.nr_seq_movto_orig%type;
nr_seq_movto_pend_w             movto_banco_pend.nr_sequencia%type;
nr_seq_movto_trans_fin_w        movto_trans_financ.nr_sequencia%type;
nr_seq_movto_transf_estorno_w   movto_trans_financ.nr_seq_movto_transf%type;
nr_seq_movto_transf_w           movto_trans_financ.nr_seq_movto_transf%type;
nr_seq_movto_w                  bigint;
nr_seq_protocolo_w              titulo_receber.nr_seq_protocolo%type;
nr_seq_rpa_w                    titulo_pagar.nr_seq_rpa%type;
nr_seq_tab_compl_w              w_movimento_contabil.nr_seq_tab_compl%type;
nr_seq_tab_orig_w               w_movimento_contabil.nr_seq_tab_orig%type;
nr_seq_tit_rec_doc_w            titulo_receber.nr_titulo%type;
nr_seq_trans_fin_baixa_w        titulo_pagar.nr_seq_trans_fin_baixa%type;
nr_titulo_w                     titulo_pagar.nr_titulo%type;
qt_registro_w                   bigint;
qt_tit_caixa_rec_w              bigint;
vl_cartao_w                     movto_cartao_cr.vl_transacao%type;
vl_cheque_w                     cheque_cr.vl_cheque%type;
vl_especie_w                    caixa_receb.vl_especie%type;
nr_seq_proj_rec_w               titulo_pagar.nr_seq_proj_rec%type;
cd_serie_nf_w			nota_fiscal.cd_serie_nf%type;

C04 CURSOR FOR
    SELECT  ie_estorno,
            coalesce(nr_seq_lote, 0),
            substr(obter_nome_pf_pj(cd_pessoa_fisica, cd_cgc), 1, 255),
            coalesce(nr_seq_movto_orig, 0)
    from    movto_trans_financ
    where   nr_seq_caixa_rec = nr_seq_caixa_rec_w
    order   by coalesce(nr_seq_lote, 0),
            coalesce(nr_seq_movto_orig, 0);


BEGIN
dados_contab_w                  := null;
doc_p.ds_Inconsistencia         := null;
cd_estabelecimento_w            := doc_p.cd_estabelecimento;
cd_empresa_w                    := obter_empresa_estab( cd_estabelecimento_w );
--dados_contab_w.nr_lote_contabil := ctb_online_pck.get_lote_contabil( doc_p.cd_tipo_lote_contabil, doc_p.cd_estabelecimento, doc_p.dt_competencia, doc_p.nm_usuario );
dados_contab_w.nr_seq_trans_fin := doc_p.nr_seq_trans_financ;
dados_contab_w.dt_transacao     := doc_p.dt_competencia;
dados_contab_w.doc              := doc_p;

select  x.*
into STRICT    ctb_param_lote_tesouraria_w
from (
SELECT  a.*
from    ctb_param_lote_tesouraria a
where   a.cd_empresa    = cd_empresa_w
and     coalesce(a.cd_estab_exclusivo, cd_estabelecimento_w) = cd_estabelecimento_w
order by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1;

begin
select  x.*
into STRICT    ie_cc_glosa_w,
        ie_contab_desp_cartao_w,
        ie_contab_rec_classif_w
from (
SELECT  coalesce(ie_cc_glosa,'N'),
        coalesce(ie_contab_desp_cartao,'N'),
        coalesce(ie_contab_rec_classif,'N')
from    ctb_param_lote_contas_rec a
where   a.cd_empresa    = cd_empresa_w
and     coalesce(a.cd_estab_exclusivo, cd_estabelecimento_w) = cd_estabelecimento_w
order by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1;
exception
    when others then
        ie_cc_glosa_w := 'N';
        ie_contab_desp_cartao_w := 'N';
        ie_contab_rec_classif_w := 'N';
end;

CALL ctb_online_pck.definir_regra_lote_esta_dif(doc_p.cd_tipo_lote_contabil, doc_p.cd_estabelecimento);
ie_permite_estab_dif_w  := ctb_online_pck.get_permite_estab_dif(doc_p.cd_tipo_lote_contabil, doc_p.cd_estabelecimento);
cd_conta_transitoria_w  := ctb_online_pck.get_conta_transitoria_estab(doc_p.cd_tipo_lote_contabil, doc_p.cd_estabelecimento);
cd_historico_ct_w       := ctb_online_pck.get_historico_transit_estab(doc_p.cd_tipo_lote_contabil, doc_p.cd_estabelecimento);

select  max(nm_fantasia_estab)
into STRICT    nm_estabelecimento_w
from    estabelecimento
where   cd_estabelecimento      = cd_estabelecimento_w;

if (doc_p.nm_tabela = 'CAIXA_SALDO_DIARIO' and doc_p.nm_atributo = 'VL_TRANSACAO') then
    begin
    ie_union_w := 1;
    select  b.nr_sequencia, --1
            b.nr_seq_banco_od, --6
            substr(obter_compl_trans_fin(b.nr_sequencia, 'PJ'),1,255) cd_cgc, --7
            CASE WHEN d.ie_caixa='M' THEN  Obter_conta_caixa(c.nr_sequencia, doc_p.dt_competencia)  ELSE b.cd_conta_contabil END , --8
            coalesce(e.cd_centro_custo,b.cd_centro_custo) cd_centro_custo,    --9
            d.ie_caixa, --11
            d.ie_saldo_caixa, --12
            CASE WHEN ie_saldo_caixa='E' THEN 'D'  ELSE 'C' END  ie_debito_credito, --13
            ds_historico, --15
            substr(obter_compl_trans_fin(b.nr_sequencia, 'PF'),1,255) cd_pessoa_fisica, --16
            substr(obter_compl_trans_fin(b.nr_sequencia, 'N'),1,255) ds_compl_pf_pj, --17
            coalesce(d.cd_historico_caixa, CASE WHEN ie_saldo_caixa='E' THEN  ctb_param_lote_tesouraria_w.cd_historico  ELSE coalesce(ctb_param_lote_tesouraria_w.cd_historico_cred,ctb_param_lote_tesouraria_w.cd_historico) END ), --18
            b.cd_historico, --19
            b.nr_documento nr_doc_movto, --20
            b.nr_adiantamento nr_adiant_movto, --21
            b.nr_interno_conta nr_interno_conta_movto, --22
            substr(Obter_Dados_Cheque_CR(b.nr_seq_cheque, 'N'),1,255) nr_cheque_movto, --23
            b.ds_historico ds_hist_movto, --24
            substr(obter_compl_trans_fin(b.nr_sequencia, 'N'),1,255) ds_compl_pf_pj_movto, --25
            d.cd_historico_caixa cd_hist_caixa_movto, --26
            b.nr_bordero, --27
            b.nr_seq_titulo_pagar, --28
            b.nr_seq_titulo_receber,  --29
            b.nr_seq_nota_fiscal, --30
            b.nr_seq_conv_receb, --31
            b.nr_seq_deposito, --32
            b.nr_adiant_pago, --33
            B.nr_seq_cheque, --34
            Obter_conta_caixa(c.nr_sequencia, doc_p.dt_competencia), --35
            coalesce(obter_pessoa_titulo_pagar(b.nr_seq_titulo_pagar), obter_pessoa_titulo_receber(b.nr_seq_titulo_receber)), --36
            c.nr_sequencia nr_seq_caixa, --37
            b.dt_transacao, --38
            somente_numero(substr(coalesce(obter_dados_nota_fiscal(b.nr_seq_nota_fiscal,'0'),
                                    coalesce(obter_dados_titulo_receber(b.nr_seq_titulo_receber,'NFT'),
                                    obter_dados_tit_pagar(b.nr_seq_titulo_pagar,'NF'))),1,20)) nr_nota_fiscal, --39
            b.nr_seq_caixa_rec, --40
            substr(obter_dados_cartao_cr(b.nr_seq_movto_cartao,'B'),1,140) ds_bandeira, --41
            substr(obter_dados_cartao_cr(b.nr_seq_movto_cartao,'OBS'),1,255) ds_obs_cartao, --42
            b.nr_seq_caixa_od, --44
            substr(obter_dados_cartao_cr(b.nr_seq_movto_cartao,'AUT'),1,40) nr_autorizacao, --48
            b.nr_seq_movto_cartao, --49
            b.nr_seq_cheque_cp, --58
            b.nr_sequencia, --59
            r.nr_sequencia nr_seq_caixa_receb, --60
            r.cd_tipo_receb_caixa cd_tipo_recebimento, --63
            b.nr_sequencia nr_seq_tab_orig, --65
            e.nr_sequencia nr_seq_tab_compl, --66
            substr(b.ds_observacao,1,255) ds_observacao_movto, --68
            b.nr_seq_movto_transf, --69
			b.nr_seq_proj_rec
    into STRICT    nr_seq_movto_w, --1
            dados_contab_w.nr_seq_conta_banco, --6
            dados_contab_w.cd_cnpj, --7
            dados_contab_w.cd_conta_contabil, --8
            dados_contab_w.cd_centro_custo, --9
            ie_caixa_w, --11
            ie_saldo_caixa_w, --12
            ie_debito_credito_w, --13
            ds_historico_w, --15
            dados_contab_w.cd_pessoa_fisica, --16
            ds_hist_pf_pj_w, --17
            cd_historico_w, --18
            cd_historico_movto_w, --19
            nr_doc_movto_w, --20
            nr_adiant_movto_w, --21
            nr_interno_conta_movto_w, --22
            nr_cheque_movto_w, --23
            ds_hist_movto_w, --24
            ds_compl_pf_pj_movto_w, --25
            cd_hist_caixa_movto_w, --26
            nr_bordero_w, --27
            dados_contab_w.nr_titulo_pagar, --28
            dados_contab_w.nr_titulo_receber, --29
            dados_contab_w.nr_seq_nota_fiscal, --30
            nr_seq_conv_receb_w, --31
            nr_seq_deposito_w, --32
            nr_adiant_pago_w, --33
            nr_seq_cheque_W, --34
            cd_conta_caixa_w, --35
            ds_pessoa_titulo_w, --36
            dados_contab_w.nr_seq_caixa, --37
            dt_transacao_w, --38
            nr_nota_fiscal_w, --39
            nr_seq_caixa_rec_w, --40
            ds_bandeira_w, --41
            ds_obs_cartao_w, --42
            dados_contab_w.nr_seq_caixa_od, --44
            nr_autorizacao_w, --48
            nr_seq_movto_cartao_w, --49
            nr_seq_cheque_cp_w, --58
            nr_seq_movto_trans_fin_w, --59
            nr_seq_caixa_receb_w, --60
            dados_contab_w.cd_tipo_recebimento, --63
            nr_seq_tab_orig_w, --65
            nr_seq_tab_compl_w, --66
            ds_observacao_movto_w, --68
            nr_seq_movto_transf_w, --69
			nr_seq_proj_rec_w
    FROM transacao_financeira d, caixa c, movto_trans_financ b
LEFT OUTER JOIN movto_trans_financ_cc e ON (b.nr_sequencia = e.nr_seq_movto_trans)
, caixa_saldo_diario a
LEFT OUTER JOIN caixa_receb r ON (a.nr_sequencia = r.nr_sequencia)
WHERE b.nr_seq_saldo_caixa    = doc_p.nr_documento and b.nr_sequencia          = doc_p.nr_seq_doc_compl and a.nr_seq_caixa          = c.nr_sequencia  and a.nr_sequencia          = b.nr_seq_saldo_caixa and (b.nr_seq_trans_financ IS NOT NULL AND b.nr_seq_trans_financ::text <> '')  and b.nr_seq_trans_financ   = d.nr_sequencia;
    end;
elsif (doc_p.nm_tabela = 'TITULO_RECEBER_LIQ_CONTAB_V2' and ctb_param_lote_tesouraria_w.ie_contab_cr = 'S') then
    begin
    ie_union_w := 2;
    select  a.nr_seq_movto_trans_fin nr_sequencia, --1
            a.nr_seq_conta_banco, --6
            b.cd_cgc, --7
            'D' ie_debito_credito, --13
            b.cd_pessoa_fisica, --16
            obter_pessoa_titulo_receber(b.nr_titulo) ds_compl_pf_pj, --17
            b.nr_interno_conta nr_interno_conta_movto, --22
            b.nr_titulo nr_seq_titulo_receber, --29
            obter_pessoa_titulo_receber(b.nr_titulo), --36
            coalesce(a.dt_recebimento,clock_timestamp()), --38
            somente_numero(obter_dados_titulo_receber(b.nr_titulo,'NFT')), --39
            a.nr_seq_caixa_rec, --40
            b.cd_estabelecimento cd_estab_movto, --54
            a.nr_documento nr_doc_tit_receb, --56
            a.nr_seq_movto_trans_fin, --59
            b.nr_seq_protocolo, --62
            a.cd_tipo_recebimento, --63
            b.nr_titulo nr_seq_tab_orig, --65
            a.nr_seq_baixa nr_seq_tab_compl, --66
            a.nr_seq_liq_origem, --70
	    b.nr_seq_proj_rec
    into STRICT    nr_seq_movto_w, --1
            dados_contab_w.nr_seq_conta_banco, --6
            dados_contab_w.cd_cnpj, --7
            ie_debito_credito_w, --13
            dados_contab_w.cd_pessoa_fisica, --16
            ds_hist_pf_pj_w, --17
            nr_interno_conta_movto_w, --22
            dados_contab_w.nr_titulo_receber, --29
            ds_pessoa_titulo_w, --36
            dt_transacao_w, --38
            nr_nota_fiscal_w, --39
            nr_seq_caixa_rec_w, --40
            dados_contab_w.cd_estab_movto, --54
            nr_doc_tit_receb_w, --56
            nr_seq_movto_trans_fin_w, --59
            nr_seq_protocolo_w, --62
            dados_contab_w.cd_tipo_recebimento, --63
            nr_seq_tab_orig_w, --65
            nr_seq_tab_compl_w, --66
            nr_seq_liq_origem_w, --70
	    nr_seq_proj_rec_w
    from    titulo_receber b,
            titulo_receber_liq_contab_v2 a
    where   a.nr_titulo             = doc_p.nr_documento
    and     a.nr_seq_baixa          = doc_p.nr_seq_doc_compl
    and     a.ds_atributo           = doc_p.nm_atributo
    and     (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
    and     ((ie_contab_rec_classif_w = 'N') or (a.ds_atributo <> 'VL_RECEBIDO_TESOURARIA'))
    and     a.ds_atributo           not in ('VL_RECEBIDO','VL_RECEBIDO_CB', 'VL_GLOSA', 'VL_REC_MAIOR')
    and     a.nr_titulo             = b.nr_titulo
    and     coalesce(a.ie_lote_pro_rata::text, '') = ''
    and     ((a.nr_seq_caixa_rec IS NOT NULL AND a.nr_seq_caixa_rec::text <> '') or
            exists (SELECT 1
                    from    movto_trans_financ x
                    where   x.nr_sequencia          = a.nr_seq_movto_trans_fin
                    and     (x.nr_seq_saldo_caixa IS NOT NULL AND x.nr_seq_saldo_caixa::text <> '')) or (nr_seq_trans_caixa IS NOT NULL AND nr_seq_trans_caixa::text <> ''));
    end;

elsif (doc_p.nm_tabela = 'TITULO_PAGAR_BAIXA_CC_CONTAB_V' and ctb_param_lote_tesouraria_w.ie_contab_cp = 'S') then
    begin
    ie_union_w := 3; /* Francisco - OS 53121 - 20/04/07 - Contabilizar contas pagar */
    select  a.nr_seq_movto_trans_fin nr_sequencia, --1
            a.nr_seq_conta_banco, --6
            b.cd_cgc, --7
            a.cd_conta_contabil cd_conta_contab_caixa, --8
            CASE WHEN coalesce(t.ie_acao,0)=0 THEN  0 WHEN coalesce(t.ie_acao,0)=2 THEN  coalesce(a.cd_centro_custo,0)  ELSE 0 END  cd_centro_custo, --9
            'C' ie_debito_credito, --13
            b.cd_pessoa_fisica, --16
            obter_pessoa_titulo_pagar(b.nr_titulo) ds_compl_pf_pj, --17
            coalesce(to_char(b.nr_documento),'0') nr_doc_movto, --20
            a.nr_bordero, --27
            b.nr_titulo nr_seq_titulo_pagar, --28
            CASE WHEN coalesce(t.ie_acao,0)=0 THEN '' WHEN coalesce(t.ie_acao,0)=2 THEN coalesce(a.cd_conta_contabil,'')  ELSE '' END  cd_conta_contabil, --35
            obter_pessoa_titulo_pagar(b.nr_titulo), --36
            coalesce(a.dt_baixa,clock_timestamp()), --38
            somente_numero(obter_dados_tit_pagar(b.nr_titulo,'NF')) nr_nota_fiscal, --39
            b.cd_estabelecimento cd_estab_movto, --54
            a.nr_seq_movto_trans_fin, --59
            a.cd_tipo_baixa, --61
            b.nr_titulo nr_seq_tab_orig, --65
            a.nr_seq_baixa nr_seq_tab_compl, --66
			b.nr_seq_proj_rec
    into STRICT    nr_seq_movto_w, --1
            dados_contab_w.nr_seq_conta_banco, --6
            dados_contab_w.cd_cnpj, --7
            dados_contab_w.cd_conta_contabil, --8
            dados_contab_w.cd_centro_custo, --9
            ie_debito_credito_w, --13
            dados_contab_w.cd_pessoa_fisica, --16
            ds_hist_pf_pj_w, --17
            nr_doc_movto_w, --20
            nr_bordero_w, --27
            dados_contab_w.nr_titulo_pagar, --28
            cd_conta_caixa_w, --35
            ds_pessoa_titulo_w, --36
            dt_transacao_w, --38
            nr_nota_fiscal_w, --39
            dados_contab_w.cd_estab_movto, --54
            nr_seq_movto_trans_fin_w, --59
            dados_contab_w.cd_tipo_baixa, --61
            nr_seq_tab_orig_w, --65
            nr_seq_tab_compl_w, --66
			nr_seq_proj_rec_w
    FROM titulo_pagar b, titulo_pagar_baixa_cc_contab_v a
LEFT OUTER JOIN transacao_financeira t ON (a.nr_seq_trans_fin = t.nr_sequencia)
WHERE a.nr_titulo             = doc_p.nr_documento and a.nr_seq_baixa          = doc_p.nr_seq_doc_compl and a.nr_seq_baixa_cc       = doc_p.nr_doc_analitico and a.ds_atributo           = doc_p.nm_atributo and a.ds_atributo           <> 'VL_PAGO' and a.nr_titulo             = b.nr_titulo  and (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '') and exists (SELECT 1
            from    movto_trans_financ x
            where   x.nr_sequencia          = a.nr_seq_movto_trans_fin
            and     (x.nr_seq_saldo_caixa IS NOT NULL AND x.nr_seq_saldo_caixa::text <> ''));
    end;
elsif (doc_p.nm_tabela = 'TITULO_RECEBER_LIQ') then
    if (doc_p.nm_atributo = 'VL_GLOSA' and ctb_param_lote_tesouraria_w.ie_contab_cr = 'S' and ie_cc_glosa_w <> 'N') then
        begin
        ie_union_w := 4;
        select  e.nr_sequencia, --1
                c.nr_seq_conta_banco, --6
                b.cd_cgc, --7
                'D' ie_debito_credito, --13
                b.cd_pessoa_fisica, --16
                obter_pessoa_titulo_receber(b.nr_titulo) ds_compl_pf_pj, --17
                e.nr_documento nr_doc_movto, --20
                b.nr_interno_conta nr_interno_conta_movto, --22
                b.nr_titulo nr_seq_titulo_receber, --29
                obter_pessoa_titulo_receber(b.nr_titulo), --36
                coalesce(e.dt_transacao,clock_timestamp()), --38
                somente_numero(obter_dados_titulo_receber(b.nr_titulo,'NFT')) nr_nota_fiscal, --39
                e.nr_seq_caixa_rec, --40
                e.nr_seq_caixa_od, --44
                substr(obter_dados_cartao_cr(e.nr_seq_movto_cartao,'AUT'),1,40) nr_autorizacao, --48
                e.nr_seq_movto_cartao, --49
                b.cd_estabelecimento cd_estab_movto, --54
                c.nr_documento nr_doc_tit_receb, --56
                e.nr_seq_cheque_cp, --58
                e.nr_sequencia, --59
                b.nr_seq_protocolo, --62
                c.cd_tipo_recebimento, --63
                b.nr_titulo nr_seq_tab_orig, --65
                c.nr_sequencia nr_seq_tab_compl, --66
                substr(e.ds_observacao,1,255) ds_observacao_movto, --68
                c.nr_seq_liq_origem, --70
				b.nr_seq_proj_rec
        into STRICT    nr_seq_movto_w, --1
                dados_contab_w.nr_seq_conta_banco, --6
                dados_contab_w.cd_cnpj, --7
                ie_debito_credito_w, --13
                dados_contab_w.cd_pessoa_fisica, --16
                ds_hist_pf_pj_w, --17
                nr_doc_movto_w, --20
                nr_interno_conta_movto_w, --22
                dados_contab_w.nr_titulo_receber, --29
                ds_pessoa_titulo_w, --36
                dt_transacao_w, --38
                nr_nota_fiscal_w, --39
                nr_seq_caixa_rec_w, --40
                dados_contab_w.nr_seq_caixa_od, --44
                nr_autorizacao_w, --48
                nr_seq_movto_cartao_w, --49
                dados_contab_w.cd_estab_movto, --54
                nr_doc_tit_receb_w, --56
                nr_seq_cheque_cp_w, --58
                nr_seq_movto_trans_fin_w, --59
                nr_seq_protocolo_w, --62
                dados_contab_w.cd_tipo_recebimento, --63
                nr_seq_tab_orig_w, --65
                nr_seq_tab_compl_w, --66
                ds_observacao_movto_w, --68
                nr_seq_liq_origem_w, --70
				nr_seq_proj_rec_w
        from    movto_trans_financ e,
                titulo_receber_liq c,
                titulo_receber b
        where   b.nr_titulo                     = doc_p.nr_documento
        and     c.nr_sequencia                  = doc_p.nr_seq_doc_compl
        and     (c.nr_seq_trans_fin IS NOT NULL AND c.nr_seq_trans_fin::text <> '')
        and     c.nr_titulo                     = b.nr_titulo
        and     c.nr_seq_movto_trans_fin        = e.nr_sequencia
        and     c.vl_glosa                      <> 0;
        end;

    elsif (doc_p.nm_atributo = 'VL_REC_MAIOR' and ctb_param_lote_tesouraria_w.ie_contab_cr = 'S' and ie_cc_glosa_w <> 'N') then
        begin
        ie_union_w := 5;
        select  c.nr_seq_movto_trans_fin nr_sequencia, --1
                c.nr_seq_conta_banco, --6
                b.cd_cgc, --7
                'D' ie_debito_credito, --13
                b.cd_pessoa_fisica, --16
                obter_pessoa_titulo_receber(b.nr_titulo) ds_compl_pf_pj, --17
                b.nr_interno_conta nr_interno_conta_movto, --22
                b.nr_titulo nr_seq_titulo_receber, --29
                obter_pessoa_titulo_receber(b.nr_titulo), --36
                coalesce(c.dt_recebimento,clock_timestamp()), --38
                somente_numero(obter_dados_titulo_receber(b.nr_titulo,'NFT')) nr_nota_fiscal, --39
                b.cd_estabelecimento cd_estab_movto, --54
                c.nr_documento nr_doc_tit_receb, --56
                b.nr_seq_protocolo, --62
                c.cd_tipo_recebimento, --63
                b.nr_titulo nr_seq_tab_orig, --65
                c.nr_sequencia nr_seq_tab_compl, --66
                c.nr_seq_liq_origem, --70
				b.nr_seq_proj_rec
        into STRICT    nr_seq_movto_w, --1
                dados_contab_w.nr_seq_conta_banco, --6
                dados_contab_w.cd_cnpj, --7
                ie_debito_credito_w, --13
                dados_contab_w.cd_pessoa_fisica, --16
                ds_hist_pf_pj_w, --17
                nr_interno_conta_movto_w, --22
                dados_contab_w.nr_titulo_receber, --29
                ds_pessoa_titulo_w, --36
                dt_transacao_w, --38
                nr_nota_fiscal_w, --39
                dados_contab_w.cd_estab_movto, --54
                nr_doc_tit_receb_w, --56
                nr_seq_protocolo_w, --62
                dados_contab_w.cd_tipo_recebimento, --63
                nr_seq_tab_orig_w, --65
                nr_seq_tab_compl_w, --66
                nr_seq_liq_origem_w, --70
				nr_seq_proj_rec_w
        from    titulo_receber_liq c,
                titulo_receber b
        where   b.nr_titulo             = doc_p.nr_documento
        and     c.nr_sequencia          = doc_p.nr_seq_doc_compl
        and     (c.nr_seq_trans_fin IS NOT NULL AND c.nr_seq_trans_fin::text <> '')
        and     c.nr_titulo             = b.nr_titulo
        and     c.vl_rec_maior          <> 0
        and      ((c.nr_seq_caixa_rec IS NOT NULL AND c.nr_seq_caixa_rec::text <> '') or (nr_seq_trans_caixa IS NOT NULL AND nr_seq_trans_caixa::text <> '') or
                exists (SELECT 1
                        from    movto_trans_financ x
                        where   x.nr_sequencia          = c.nr_seq_movto_trans_fin
                        and (x.nr_seq_saldo_caixa IS NOT NULL AND x.nr_seq_saldo_caixa::text <> '')));
        end;

    elsif (doc_p.nm_atributo = 'VL_TITULO_RECEBER') then
        begin
        ie_union_w := 17;
        select  a.nr_seq_conta_banco, --6
                b.cd_cgc, --7
                coalesce(c.cd_centro_custo,0) cd_centro_custo, --9
                'D' ie_debito_credito, --13
                b.cd_pessoa_fisica, --16
                obter_pessoa_titulo_receber(b.nr_titulo) ds_compl_pf_pj, --17
                to_char(b.nr_documento) nr_doc_movto, --20
                b.nr_interno_conta nr_interno_conta_movto, --22
                b.nr_titulo nr_seq_titulo_receber, --29
                obter_pessoa_titulo_receber(b.nr_titulo), --36
                somente_numero(obter_dados_titulo_receber(b.nr_titulo,'NFT')) nr_nota_fiscal, --39
                a.nr_sequencia, --53
                b.cd_estabelecimento cd_estab_movto, --54
                a.nr_documento nr_doc_tit_receb, --56
                b.nr_seq_protocolo, --62
                a.cd_tipo_recebimento, --63
                b.nr_titulo nr_seq_tab_orig, --65
                c.nr_sequencia, --66
                a.nr_seq_liq_origem, --70
				b.nr_seq_proj_rec
        into STRICT    dados_contab_w.nr_seq_conta_banco, --6
                dados_contab_w.cd_cnpj, --7
                dados_contab_w.cd_centro_custo, --9
                ie_debito_credito_w, --13
                dados_contab_w.cd_pessoa_fisica, --16
                ds_hist_pf_pj_w, --17
                nr_doc_movto_w, --20
                nr_interno_conta_movto_w, --22
                dados_contab_w.nr_titulo_receber, --29
                ds_pessoa_titulo_w, --36
                nr_nota_fiscal_w, --39
                nr_seq_baixa_w, --53
                dados_contab_w.cd_estab_movto, --54
                nr_doc_tit_receb_w, --56
                nr_seq_protocolo_w, --62
                dados_contab_w.cd_tipo_recebimento, --63
                nr_seq_tab_orig_w, --65
                nr_seq_tab_compl_w, --66
                nr_seq_liq_origem_w, --70
				nr_seq_proj_rec_w
        from    titulo_receber b,
                titulo_receber_liq a,
                titulo_receber_classif c
        where   b.nr_titulo     = doc_p.nr_documento
        and     c.nr_sequencia  = doc_p.nr_seq_doc_compl
        and     b.nr_titulo     = c.nr_titulo
        and     c.nr_titulo     = a.nr_titulo
        and     a.nr_titulo     = b.nr_titulo;
        end;
    end if;

elsif (doc_p.nm_tabela = 'TITULO_RECEBER_LIQ_CC') then

    if (doc_p.nm_atributo = 'VL_GLOSA' and ctb_param_lote_tesouraria_w.ie_contab_cr = 'S' and ie_cc_glosa_w <> 'N') then
        begin
        ie_union_w := 4;
        select  e.nr_sequencia, --1
                c.nr_seq_conta_banco, --6
                b.cd_cgc, --7
                d.cd_centro_custo, --9
                'D' ie_debito_credito, --13
                b.cd_pessoa_fisica, --16
                obter_pessoa_titulo_receber(b.nr_titulo) ds_compl_pf_pj, --17
                e.nr_documento nr_doc_movto, --20
                b.nr_interno_conta nr_interno_conta_movto, --22
                b.nr_titulo nr_seq_titulo_receber, --29
                obter_pessoa_titulo_receber(b.nr_titulo), --36
                coalesce(e.dt_transacao,clock_timestamp()), --38
                somente_numero(obter_dados_titulo_receber(b.nr_titulo,'NFT')) nr_nota_fiscal, --39
                e.nr_seq_caixa_rec, --40
                d.nr_seq_produto, --43
                e.nr_seq_caixa_od, --44
                substr(obter_dados_cartao_cr(e.nr_seq_movto_cartao,'AUT'),1,40) nr_autorizacao, --48
                e.nr_seq_movto_cartao, --49
                b.cd_estabelecimento cd_estab_movto, --54
                c.nr_documento nr_doc_tit_receb, --56
                e.nr_seq_cheque_cp, --58
                e.nr_sequencia, --59
                b.nr_seq_protocolo, --62
                c.cd_tipo_recebimento, --63
                b.nr_titulo nr_seq_tab_orig, --65
                d.nr_sequencia nr_seq_tab_compl, --66
                substr(e.ds_observacao,1,255) ds_observacao_movto, --68
                c.nr_seq_liq_origem, --70
				b.nr_seq_proj_rec
        into STRICT    nr_seq_movto_w, --1
                dados_contab_w.nr_seq_conta_banco, --6
                dados_contab_w.cd_cnpj, --7
                dados_contab_w.cd_centro_custo, --9
                ie_debito_credito_w, --13
                dados_contab_w.cd_pessoa_fisica, --16
                ds_hist_pf_pj_w, --17
                nr_doc_movto_w, --20
                nr_interno_conta_movto_w, --22
                dados_contab_w.nr_titulo_receber, --29
                ds_pessoa_titulo_w, --36
                dt_transacao_w, --38
                nr_nota_fiscal_w, --39
                nr_seq_caixa_rec_w, --40
                dados_contab_w.nr_seq_produto, --43
                dados_contab_w.nr_seq_caixa_od, --44
                nr_autorizacao_w, --48
                nr_seq_movto_cartao_w, --49
                dados_contab_w.cd_estab_movto, --54
                nr_doc_tit_receb_w, --56
                nr_seq_cheque_cp_w, --58
                nr_seq_movto_trans_fin_w, --59
                nr_seq_protocolo_w, --62
                dados_contab_w.cd_tipo_recebimento, --63
                nr_seq_tab_orig_w, --65
                nr_seq_tab_compl_w, --66
                ds_observacao_movto_w, --68
                nr_seq_liq_origem_w, --70
				nr_seq_proj_rec_w
        FROM movto_trans_financ e, titulo_receber b, titulo_receber_liq c
LEFT OUTER JOIN titulo_rec_liq_cc d ON (c.nr_titulo = d.nr_titulo AND c.nr_sequencia = d.nr_seq_baixa)
WHERE b.nr_titulo                     = doc_p.nr_documento and d.nr_sequencia                  = doc_p.nr_seq_doc_compl and (c.nr_seq_trans_fin IS NOT NULL AND c.nr_seq_trans_fin::text <> '') and c.nr_titulo                     = b.nr_titulo   and c.nr_seq_movto_trans_fin        = e.nr_sequencia and coalesce(d.vl_baixa, c.vl_glosa)     <> 0;
        end;

    elsif (doc_p.nm_atributo = 'VL_REC_MAIOR' and ctb_param_lote_tesouraria_w.ie_contab_cr = 'S' and ie_cc_glosa_w <> 'N') then
        begin
        ie_union_w := 5;
        select  c.nr_seq_movto_trans_fin nr_sequencia, --1
                c.nr_seq_conta_banco, --6
                b.cd_cgc, --7
                d.cd_centro_custo, --9
                'D' ie_debito_credito, --13
                b.cd_pessoa_fisica, --16
                obter_pessoa_titulo_receber(b.nr_titulo) ds_compl_pf_pj, --17
                b.nr_interno_conta nr_interno_conta_movto, --22
                b.nr_titulo nr_seq_titulo_receber, --29
                obter_pessoa_titulo_receber(b.nr_titulo), --36
                coalesce(c.dt_recebimento,clock_timestamp()), --38
                somente_numero(obter_dados_titulo_receber(b.nr_titulo,'NFT')) nr_nota_fiscal, --39
                d.nr_seq_produto, --43
                b.cd_estabelecimento cd_estab_movto, --54
                c.nr_documento nr_doc_tit_receb, --56
                b.nr_seq_protocolo, --62
                c.cd_tipo_recebimento, --63
                b.nr_titulo nr_seq_tab_orig, --65
                d.nr_sequencia nr_seq_tab_compl, --66
                c.nr_seq_liq_origem, --70
				b.nr_seq_proj_rec
        into STRICT    nr_seq_movto_w, --1
                dados_contab_w.nr_seq_conta_banco, --6
                dados_contab_w.cd_cnpj, --7
                dados_contab_w.cd_centro_custo, --9
                ie_debito_credito_w, --13
                dados_contab_w.cd_pessoa_fisica, --16
                ds_hist_pf_pj_w, --17
                nr_interno_conta_movto_w, --22
                dados_contab_w.nr_titulo_receber, --29
                ds_pessoa_titulo_w, --36
                dt_transacao_w, --38
                nr_nota_fiscal_w, --39
                dados_contab_w.nr_seq_produto, --43
                dados_contab_w.cd_estab_movto, --54
                nr_doc_tit_receb_w, --56
                nr_seq_protocolo_w, --62
                dados_contab_w.cd_tipo_recebimento, --63
                nr_seq_tab_orig_w, --65
                nr_seq_tab_compl_w, --66
                nr_seq_liq_origem_w, --70
				nr_seq_proj_rec_w
        FROM titulo_receber b, titulo_receber_liq c
LEFT OUTER JOIN titulo_rec_liq_cc d ON (c.nr_titulo = d.nr_titulo AND c.nr_sequencia = d.nr_seq_baixa)
WHERE b.nr_titulo             = doc_p.nr_documento and d.nr_sequencia          = doc_p.nr_seq_doc_compl and (c.nr_seq_trans_fin IS NOT NULL AND c.nr_seq_trans_fin::text <> '') and c.nr_titulo             = b.nr_titulo   and d.vl_amaior             <> 0 and ((c.nr_seq_caixa_rec IS NOT NULL AND c.nr_seq_caixa_rec::text <> '') or (nr_seq_trans_caixa IS NOT NULL AND nr_seq_trans_caixa::text <> '') or
                exists (SELECT 1
                        from    movto_trans_financ x
                        where   x.nr_sequencia          = c.nr_seq_movto_trans_fin
                        and     (x.nr_seq_saldo_caixa IS NOT NULL AND x.nr_seq_saldo_caixa::text <> ''))
                );
        end;
    end if;

elsif (doc_p.nm_tabela = 'MOVTO_TRANS_FINANC') then

    if (doc_p.nm_atributo = 'VL_CHEQUE_DEPOSITO') then
        begin
        ie_union_w := 7;
        select  b.nr_sequencia, --2
                b.nr_seq_banco_od, --7
                substr(obter_compl_trans_fin(b.nr_sequencia, 'PJ'),1,255) cd_cgc, --8
                CASE WHEN d.ie_caixa='M' THEN  Obter_conta_caixa(c.nr_sequencia, doc_p.dt_competencia)  ELSE b.cd_conta_contabil END , --9
                coalesce(e.cd_centro_custo,b.cd_centro_custo) cd_centro_custo, --10
                d.ie_caixa, --12
                d.ie_saldo_caixa, --13
                CASE WHEN ie_saldo_caixa='E' THEN 'D'  ELSE 'C' END  ie_debito_credito, --14
                ds_historico, --16
                substr(obter_compl_trans_fin(b.nr_sequencia, 'PF'),1,255) cd_pessoa_fisica, --17
                substr(obter_compl_trans_fin(b.nr_sequencia, 'N'),1,255) ds_compl_pf_pj, --18
                coalesce(d.cd_historico_caixa, CASE WHEN ie_saldo_caixa='E' THEN  ctb_param_lote_tesouraria_w.cd_historico  ELSE coalesce(ctb_param_lote_tesouraria_w.cd_historico_cred,ctb_param_lote_tesouraria_w.cd_historico) END ), --19
                b.cd_historico, --20
                b.nr_documento nr_doc_movto, --21                       -- os campos abaixo sao para montagems do compl hitorico por atributo
                b.nr_adiantamento nr_adiant_movto, --22
                b.nr_interno_conta nr_interno_conta_movto, --23
                substr(Obter_Dados_Cheque_CR(f.nr_seq_cheque, 'N'),1,255) nr_cheque_movto, --24
                b.ds_historico ds_hist_movto, --25
                substr(obter_compl_trans_fin(b.nr_sequencia, 'N'),1,255) ds_compl_pf_pj_movto, --26
                d.cd_historico_caixa cd_hist_caixa_movto, --27
                b.nr_bordero, --28
                b.nr_seq_titulo_pagar, --29
                b.nr_seq_titulo_receber, --30
                b.nr_seq_nota_fiscal, --31
                b.nr_seq_conv_receb, --32
                b.nr_seq_deposito, --33
                b.nr_adiant_pago, --34
                f.nr_seq_cheque, --35
                Obter_conta_caixa(c.nr_sequencia, doc_p.dt_competencia), --36
                coalesce(obter_pessoa_titulo_pagar(b.nr_seq_titulo_pagar), obter_pessoa_titulo_receber(b.nr_seq_titulo_receber)), --37
                c.nr_sequencia nr_seq_caixa, --38
                b.dt_transacao, --39
                somente_numero(substr(coalesce(obter_dados_nota_fiscal(b.nr_seq_nota_fiscal,'0'),
                coalesce(obter_dados_titulo_receber(coalesce(g.nr_titulo, b.nr_seq_titulo_receber),'NFT'),
                obter_dados_tit_pagar(b.nr_seq_titulo_pagar,'NF'))),1,20)) nr_nota_fiscal, --40
                b.nr_seq_caixa_rec, --41
                substr(obter_dados_cartao_cr(b.nr_seq_movto_cartao,'AUT'),1,40) nr_autorizacao, --49
                b.nr_seq_movto_cartao, --50
                b.nr_seq_cheque_cp, --59
                b.nr_sequencia, --60
                b.cd_tipo_recebimento, --64
                b.nr_sequencia nr_seq_tab_orig, --66
                g.nr_seq_cheque nr_seq_tab_compl, --67
                substr(b.ds_observacao,1,255) ds_observacao_movto, --69
				b.nr_seq_proj_rec
        into STRICT    nr_seq_movto_w,  --2
                dados_contab_w.nr_seq_conta_banco,  --7
                dados_contab_w.cd_cnpj,  --8
                dados_contab_w.cd_conta_contabil,  --9
                dados_contab_w.cd_centro_custo, --10
                ie_caixa_w,  --12
                ie_saldo_caixa_w,  --13
                ie_debito_credito_w,  --14
                ds_historico_w,  --16
                dados_contab_w.cd_pessoa_fisica,  --17
                ds_hist_pf_pj_w , --18
                cd_historico_w,  --19
                cd_historico_movto_w,  --20
                nr_doc_movto_w,  --21
                nr_adiant_movto_w,  --22
                nr_interno_conta_movto_w, --23
                nr_cheque_movto_w, --24
                ds_hist_movto_w, --25
                ds_compl_pf_pj_movto_w, --26
                cd_hist_caixa_movto_w, --27
                nr_bordero_w, --28
                dados_contab_w.nr_titulo_pagar, --29
                dados_contab_w.nr_titulo_receber, --30
                dados_contab_w.nr_seq_nota_fiscal, --31
                nr_seq_conv_receb_w, --32
                nr_seq_deposito_w, --33
                nr_adiant_pago_w, --34
                nr_seq_cheque_W, --35
                cd_conta_caixa_w, --36
                ds_pessoa_titulo_w, --37
                dados_contab_w.nr_seq_caixa, --38
                dt_transacao_w, --39
                nr_nota_fiscal_w, --40
                nr_seq_caixa_rec_w, --41
                nr_autorizacao_w, --49
                nr_seq_movto_cartao_w, --50
                nr_seq_cheque_cp_w, --59
                nr_seq_movto_trans_fin_w, --60
                dados_contab_w.cd_tipo_recebimento, --64
                nr_seq_tab_orig_w, --66
                nr_seq_tab_compl_w, --67
                ds_observacao_movto_w, --69
				nr_seq_proj_rec_w
        FROM cheque_cr g, deposito_cheque f, transacao_financeira d, caixa c, caixa_saldo_diario a, movto_trans_financ b
LEFT OUTER JOIN movto_trans_financ_cc e ON (b.nr_sequencia = e.nr_seq_movto_trans)
WHERE b.nr_seq_saldo_caixa  = doc_p.nr_documento and b.nr_sequencia        = doc_p.nr_seq_doc_compl and f.nr_seq_cheque       = doc_p.nr_doc_analitico and a.nr_seq_caixa        = c.nr_sequencia and a.nr_sequencia        = b.nr_seq_saldo_caixa and (b.nr_seq_trans_financ IS NOT NULL AND b.nr_seq_trans_financ::text <> '')  and b.nr_seq_trans_financ = d.nr_sequencia and b.nr_seq_deposito     = f.nr_seq_deposito and f.nr_seq_cheque       = g.nr_seq_cheque;
        end;

    elsif (doc_p.nm_atributo = 'VL_ESPECIE_DEPOSITO') then
        begin
        ie_union_w := 7;
        select  b.nr_sequencia, --2
                b.nr_seq_banco_od, --7
                substr(obter_compl_trans_fin(b.nr_sequencia, 'PJ'),1,255) cd_cgc, --8
                CASE WHEN d.ie_caixa='M' THEN  Obter_conta_caixa(c.nr_sequencia, doc_p.dt_competencia)  ELSE b.cd_conta_contabil END , --9
                coalesce(e.cd_centro_custo,b.cd_centro_custo) cd_centro_custo, --10
                d.ie_caixa, --12
                d.ie_saldo_caixa, --13
                CASE WHEN ie_saldo_caixa='E' THEN 'D'  ELSE 'C' END  ie_debito_credito, --14
                ds_historico, --16
                substr(obter_compl_trans_fin(b.nr_sequencia, 'PF'),1,255) cd_pessoa_fisica, --17
                substr(obter_compl_trans_fin(b.nr_sequencia, 'N'),1,255) ds_compl_pf_pj, --18
                coalesce(d.cd_historico_caixa, CASE WHEN ie_saldo_caixa='E' THEN  ctb_param_lote_tesouraria_w.cd_historico  ELSE coalesce(ctb_param_lote_tesouraria_w.cd_historico_cred,ctb_param_lote_tesouraria_w.cd_historico) END ), --19
                b.cd_historico, --20
                b.nr_documento nr_doc_movto, --21                       -- os campos abaixo sao para montagems do compl hitorico por atributo
                b.nr_adiantamento nr_adiant_movto, --22
                b.nr_interno_conta nr_interno_conta_movto, --23
                substr(Obter_Dados_Cheque_CR(b.nr_seq_cheque, 'N'),1,255) nr_cheque_movto, --24
                b.ds_historico ds_hist_movto, --25
                substr(obter_compl_trans_fin(b.nr_sequencia, 'N'),1,255) ds_compl_pf_pj_movto, --26
                d.cd_historico_caixa cd_hist_caixa_movto, --27
                b.nr_bordero, --28
                b.nr_seq_titulo_pagar, --29
                b.nr_seq_titulo_receber, --30
                b.nr_seq_nota_fiscal, --31
                b.nr_seq_conv_receb, --32
                b.nr_seq_deposito, --33
                b.nr_adiant_pago, --34
                B.nr_seq_cheque, --35
                Obter_conta_caixa(c.nr_sequencia, doc_p.dt_competencia), --36
                coalesce(OBTER_PESSOA_TITULO_PAGAR(b.nr_seq_titulo_pagar), OBTER_PESSOA_TITULO_RECEBER(b.nr_seq_titulo_receber)), --37
                c.nr_sequencia nr_seq_caixa, --38
                b.dt_transacao, --39
                somente_numero(substr(coalesce(obter_dados_nota_fiscal(b.nr_seq_nota_fiscal,'0'),
                coalesce(obter_dados_titulo_receber(b.nr_seq_titulo_receber,'NFT'),
                obter_dados_tit_pagar(b.nr_seq_titulo_pagar,'NF'))),1,20)) nr_nota_fiscal, --40
                b.nr_seq_caixa_rec, --41
                b.nr_seq_caixa_od, --45
                substr(obter_dados_cartao_cr(b.nr_seq_movto_cartao,'AUT'),1,40) nr_autorizacao, --49
                b.nr_seq_movto_cartao, --50
                b.nr_seq_cheque_cp, --59
                b.nr_sequencia, --60
                b.cd_tipo_recebimento, --64
                b.nr_sequencia nr_seq_tab_orig, --66
                f.nr_sequencia nr_seq_tab_compl, --67
                substr(b.ds_observacao,1,255) ds_observacao_movto, --69
				b.nr_seq_proj_rec
        into STRICT    nr_seq_movto_w,  --2
                dados_contab_w.nr_seq_conta_banco,  --7
                dados_contab_w.cd_cnpj,  --8
                dados_contab_w.cd_conta_contabil,  --9
                dados_contab_w.cd_centro_custo, --10
                ie_caixa_w,  --12
                ie_saldo_caixa_w,  --13
                ie_debito_credito_w,  --14
                ds_historico_w,  --16
                dados_contab_w.cd_pessoa_fisica,  --17
                ds_hist_pf_pj_w , --18
                cd_historico_w,  --19
                cd_historico_movto_w,  --20
                nr_doc_movto_w,  --21
                nr_adiant_movto_w,  --22
                nr_interno_conta_movto_w, --23
                nr_cheque_movto_w, --24
                ds_hist_movto_w, --25
                ds_compl_pf_pj_movto_w, --26
                cd_hist_caixa_movto_w, --27
                nr_bordero_w, --28
                dados_contab_w.nr_titulo_pagar, --29
                dados_contab_w.nr_titulo_receber, --30
                dados_contab_w.nr_seq_nota_fiscal, --31
                nr_seq_conv_receb_w, --32
                nr_seq_deposito_w, --33
                nr_adiant_pago_w, --34
                nr_seq_cheque_W, --35
                cd_conta_caixa_w, --36
                ds_pessoa_titulo_w, --37
                dados_contab_w.nr_seq_caixa, --38
                dt_transacao_w, --39
                nr_nota_fiscal_w, --40
                nr_seq_caixa_rec_w, --41
                dados_contab_w.nr_seq_caixa_od, --45
                nr_autorizacao_w, --49
                nr_seq_movto_cartao_w, --50
                nr_seq_cheque_cp_w, --59
                nr_seq_movto_trans_fin_w, --60
                dados_contab_w.cd_tipo_recebimento, --64
                nr_seq_tab_orig_w, --66
                nr_seq_tab_compl_w, --67
                ds_observacao_movto_w, --69
				nr_seq_proj_rec_w
        FROM deposito f, transacao_financeira d, caixa c, caixa_saldo_diario a, movto_trans_financ b
LEFT OUTER JOIN movto_trans_financ_cc e ON (b.nr_sequencia = e.nr_seq_movto_trans)
WHERE b.nr_seq_saldo_caixa    = doc_p.nr_documento and b.nr_sequencia          = doc_p.nr_seq_doc_compl and b.nr_seq_deposito       = doc_p.nr_doc_analitico and a.nr_seq_caixa          = c.nr_sequencia and a.nr_sequencia          = b.nr_seq_saldo_caixa and (b.nr_seq_trans_financ IS NOT NULL AND b.nr_seq_trans_financ::text <> '')  and b.nr_seq_trans_financ   = d.nr_sequencia and b.nr_seq_deposito       = f.nr_sequencia and coalesce(f.vl_especie,0)     > 0;
        end;
    end if;

elsif (doc_p.nm_tabela = 'CHEQUE_CR_NEGOCIADO') then

    if (doc_p.nm_atributo = 'VL_DESC_NEG_CHEQUE') then
        begin
        ie_union_w := 27;
        select  CASE WHEN d.ie_caixa='M' THEN  Obter_conta_caixa(c.nr_sequencia, doc_p.dt_competencia)  ELSE '' END  cd_conta_contabil, --9
                d.ie_caixa, --12
                d.ie_saldo_caixa, --13
                CASE WHEN d.ie_saldo_caixa='E' THEN 'D'  ELSE 'C' END  ie_debito_credito, --14
                coalesce(d.cd_historico_caixa, CASE WHEN ie_saldo_caixa='E' THEN  ctb_param_lote_tesouraria_w.cd_historico  ELSE coalesce(ctb_param_lote_tesouraria_w.cd_historico_cred,ctb_param_lote_tesouraria_w.cd_historico) END ), --19
                substr(Obter_Dados_Cheque_CR(b.nr_seq_cheque, 'N'),1,255) nr_cheque_movto, --24
                d.cd_historico_caixa cd_hist_caixa_movto, --27
                b.nr_seq_cheque, --35
                Obter_conta_caixa(c.nr_sequencia, doc_p.dt_competencia), --36
                c.nr_sequencia nr_seq_caixa, --38
                b.dt_negociacao, --39
                b.nr_seq_caixa_rec, --41
                e.nr_sequencia nr_seq_caixa_receb, --61
                e.cd_tipo_receb_caixa cd_tipo_recebimento, --64
                b.nr_sequencia nr_seq_tab_orig, --66
                e.nr_sequencia nr_seq_tab_compl --67
        into STRICT    dados_contab_w.cd_conta_contabil,  --9
                ie_caixa_w,  --12
                ie_saldo_caixa_w,  --13
                ie_debito_credito_w,  --14
                cd_historico_w,  --19
                nr_cheque_movto_w, --24
                cd_hist_caixa_movto_w, --27
                nr_seq_cheque_W, --35
                cd_conta_caixa_w, --36
                dados_contab_w.nr_seq_caixa, --38
                dt_transacao_w, --39
                nr_seq_caixa_rec_w, --41
                nr_seq_caixa_receb_w, --61
                dados_contab_w.cd_tipo_recebimento, --64
                nr_seq_tab_orig_w, --66
                nr_seq_tab_compl_w --67
        from    Transacao_financeira d,
                Caixa c,
                caixa_receb e,
                cheque_cr_negociado b,
                caixa_saldo_diario a
        where   e.nr_sequencia          = doc_p.nr_documento
        and     a.nr_sequencia          = doc_p.nr_seq_doc_compl
        and     b.nr_sequencia          = doc_p.nr_doc_analitico
        and     a.nr_seq_caixa          = c.nr_sequencia
        and     e.nr_seq_saldo_caixa    = a.nr_sequencia
        and     b.nr_seq_caixa_rec      = e.nr_sequencia
        and     (b.nr_seq_trans_financ IS NOT NULL AND b.nr_seq_trans_financ::text <> '')
        and     b.nr_seq_trans_financ   = d.nr_sequencia
        and     coalesce(b.vl_desconto,0)    != 0;
        end;

    elsif (doc_p.nm_atributo = 'VL_JUROS_NEG_CHEQUE') then
        begin
        ie_union_w := 12;
        select  CASE WHEN d.ie_caixa='M' THEN  Obter_conta_caixa(c.nr_sequencia, doc_p.dt_competencia)  ELSE '' END  cd_conta_contabil, --9
                d.ie_caixa, --12
                d.ie_saldo_caixa, --13
                CASE WHEN d.ie_saldo_caixa='E' THEN 'D'  ELSE 'C' END  ie_debito_credito, --14
                coalesce(d.cd_historico_caixa, CASE WHEN ie_saldo_caixa='E' THEN  ctb_param_lote_tesouraria_w.cd_historico  ELSE coalesce(ctb_param_lote_tesouraria_w.cd_historico_cred,ctb_param_lote_tesouraria_w.cd_historico) END ), --19
                substr(Obter_Dados_Cheque_CR(b.nr_seq_cheque, 'N'),1,255) nr_cheque_movto, --24
                d.cd_historico_caixa cd_hist_caixa_movto, --27
                b.nr_seq_cheque, --35
                Obter_conta_caixa(c.nr_sequencia, doc_p.dt_competencia), --36
                c.nr_sequencia nr_seq_caixa, --38
                b.dt_negociacao, --39
                b.nr_seq_caixa_rec, --41
                e.nr_sequencia nr_seq_caixa_receb, --61
                e.cd_tipo_receb_caixa cd_tipo_recebimento, --64
                b.nr_sequencia nr_seq_tab_orig, --66
                e.nr_sequencia nr_seq_tab_compl --67
        into STRICT    dados_contab_w.cd_conta_contabil,  --9
                ie_caixa_w,  --12
                ie_saldo_caixa_w,  --13
                ie_debito_credito_w,  --14
                cd_historico_w,  --19
                nr_cheque_movto_w, --24
                cd_hist_caixa_movto_w, --27
                nr_seq_cheque_W, --35
                cd_conta_caixa_w, --36
                dados_contab_w.nr_seq_caixa, --38
                dt_transacao_w, --39
                nr_seq_caixa_rec_w, --41
                nr_seq_caixa_receb_w, --61
                dados_contab_w.cd_tipo_recebimento, --64
                nr_seq_tab_orig_w, --66
                nr_seq_tab_compl_w --67
        from    Transacao_financeira d,
                Caixa c,
                caixa_receb e,
                cheque_cr_negociado b,
                caixa_saldo_diario a
        where   e.nr_sequencia          = doc_p.nr_documento
        and     a.nr_sequencia          = doc_p.nr_seq_doc_compl
        and     b.nr_sequencia          = doc_p.nr_doc_analitico
        and     a.nr_seq_caixa          = c.nr_sequencia
        and     e.nr_seq_saldo_caixa        = a.nr_sequencia
        and     b.nr_seq_caixa_rec      = e.nr_sequencia
        and     (b.nr_seq_trans_financ IS NOT NULL AND b.nr_seq_trans_financ::text <> '')
        and     b.nr_seq_trans_financ   = d.nr_sequencia;
        end;

    elsif (doc_p.nm_atributo = 'VL_MULTA_NEG_CHEQUE') then
        begin
        ie_union_w := 13;
        select  CASE WHEN d.ie_caixa='M' THEN  Obter_conta_caixa(c.nr_sequencia, doc_p.dt_competencia)  ELSE '' END  cd_conta_contabil, --9
                d.ie_caixa, --12
                d.ie_saldo_caixa, --13
                CASE WHEN d.ie_saldo_caixa='E' THEN 'D'  ELSE 'C' END  ie_debito_credito, --14
                coalesce(d.cd_historico_caixa, CASE WHEN ie_saldo_caixa='E' THEN  ctb_param_lote_tesouraria_w.cd_historico  ELSE coalesce(ctb_param_lote_tesouraria_w.cd_historico_cred,ctb_param_lote_tesouraria_w.cd_historico) END ), --19
                substr(Obter_Dados_Cheque_CR(b.nr_seq_cheque, 'N'),1,255) nr_cheque_movto, --24
                d.cd_historico_caixa cd_hist_caixa_movto, --27
                b.nr_seq_cheque, --35
                Obter_conta_caixa(c.nr_sequencia, doc_p.dt_competencia), --36
                c.nr_sequencia nr_seq_caixa, --38
                b.dt_negociacao, --39
                b.nr_seq_caixa_rec, --41
                e.nr_sequencia nr_seq_caixa_receb, --61
                e.cd_tipo_receb_caixa cd_tipo_recebimento, --64
                b.nr_sequencia nr_seq_tab_orig, --66
                e.nr_sequencia nr_seq_tab_compl --67
        into STRICT    dados_contab_w.cd_conta_contabil,  --9
                ie_caixa_w,  --12
                ie_saldo_caixa_w,  --13
                ie_debito_credito_w,  --14
                cd_historico_w,  --19
                nr_cheque_movto_w, --24
                cd_hist_caixa_movto_w, --27
                nr_seq_cheque_W, --35
                cd_conta_caixa_w, --36
                dados_contab_w.nr_seq_caixa, --38
                dt_transacao_w, --39
                nr_seq_caixa_rec_w, --41
                nr_seq_caixa_receb_w, --61
                dados_contab_w.cd_tipo_recebimento, --64
                nr_seq_tab_orig_w, --66
                nr_seq_tab_compl_w --67
        from    Transacao_financeira d,
                Caixa c,
                caixa_receb e,
                cheque_cr_negociado b,
                caixa_saldo_diario a
        where   e.nr_sequencia          = doc_p.nr_documento
        and     a.nr_sequencia          = doc_p.nr_seq_doc_compl
        and     b.nr_sequencia          = doc_p.nr_doc_analitico
        and     a.nr_seq_caixa          = c.nr_sequencia
        and     e.nr_seq_saldo_caixa    = a.nr_sequencia
        and     b.nr_seq_caixa_rec      = e.nr_sequencia
        and     (b.nr_seq_trans_financ IS NOT NULL AND b.nr_seq_trans_financ::text <> '')
        and     b.nr_seq_trans_financ   = d.nr_sequencia;
        end;

    elsif (doc_p.nm_atributo = 'VL_NEGOCIADO_CHEQUE') then
        begin
        ie_union_w := 14;
        select  CASE WHEN d.ie_caixa='M' THEN  Obter_conta_caixa(c.nr_sequencia, doc_p.dt_competencia)  ELSE '' END  cd_conta_contabil, --9
                d.ie_caixa, --12
                d.ie_saldo_caixa, --13
                CASE WHEN d.ie_saldo_caixa='E' THEN 'D'  ELSE 'C' END  ie_debito_credito, --14
                coalesce(d.cd_historico_caixa, CASE WHEN ie_saldo_caixa='E' THEN  ctb_param_lote_tesouraria_w.cd_historico  ELSE coalesce(ctb_param_lote_tesouraria_w.cd_historico_cred,ctb_param_lote_tesouraria_w.cd_historico) END ), --19
                substr(Obter_Dados_Cheque_CR(b.nr_seq_cheque, 'N'),1,255) nr_cheque_movto, --24
                d.cd_historico_caixa cd_hist_caixa_movto, --27
                b.nr_seq_cheque, --35
                Obter_conta_caixa(c.nr_sequencia, doc_p.dt_competencia), --36
                c.nr_sequencia nr_seq_caixa, --38
                b.dt_negociacao, --39
                b.nr_seq_caixa_rec, --41
                e.nr_sequencia nr_seq_caixa_receb, --61
                e.cd_tipo_receb_caixa cd_tipo_recebimento, --64
                b.nr_sequencia nr_seq_tab_orig, --66
                e.nr_sequencia nr_seq_tab_compl --67
        into STRICT    dados_contab_w.cd_conta_contabil,  --9
                ie_caixa_w,  --12
                ie_saldo_caixa_w,  --13
                ie_debito_credito_w,  --14
                cd_historico_w,  --19
                nr_cheque_movto_w, --24
                cd_hist_caixa_movto_w, --27
                nr_seq_cheque_W, --35
                cd_conta_caixa_w, --36
                dados_contab_w.nr_seq_caixa, --38
                dt_transacao_w, --39
                nr_seq_caixa_rec_w, --41
                nr_seq_caixa_receb_w, --61
                dados_contab_w.cd_tipo_recebimento, --64
                nr_seq_tab_orig_w, --66
                nr_seq_tab_compl_w --67
        from    Transacao_financeira d,
                Caixa c,
                caixa_receb e,
                cheque_cr_negociado b,
                caixa_saldo_diario a
        where   e.nr_sequencia          = doc_p.nr_documento
        and     a.nr_sequencia          = doc_p.nr_seq_doc_compl
        and     b.nr_sequencia          = doc_p.nr_doc_analitico
        and     a.nr_seq_caixa          = c.nr_sequencia
        and     e.nr_seq_saldo_caixa    = a.nr_sequencia
        and     b.nr_seq_caixa_rec      = e.nr_sequencia
        and     (b.nr_seq_trans_financ IS NOT NULL AND b.nr_seq_trans_financ::text <> '')
        and     b.nr_seq_trans_financ   = d.nr_sequencia;
        end;

    elsif (doc_p.nm_atributo = 'VL_TERCEIRO') then
        begin
        ie_union_w := 11;
        select  CASE WHEN d.ie_caixa='M' THEN  Obter_conta_caixa(c.nr_sequencia, doc_p.dt_competencia)  ELSE '' END  cd_conta_contabil, --9
                d.ie_caixa, --12
                d.ie_saldo_caixa, --13
                CASE WHEN d.ie_saldo_caixa='E' THEN 'D'  ELSE 'C' END  ie_debito_credito, --14
                coalesce(d.cd_historico_caixa, CASE WHEN ie_saldo_caixa='E' THEN  ctb_param_lote_tesouraria_w.cd_historico  ELSE coalesce(ctb_param_lote_tesouraria_w.cd_historico_cred,ctb_param_lote_tesouraria_w.cd_historico) END ), --19
                substr(Obter_Dados_Cheque_CR(b.nr_seq_cheque, 'N'),1,255) nr_cheque_movto, --24
                d.cd_historico_caixa cd_hist_caixa_movto, --27
                b.nr_seq_cheque, --35
                Obter_conta_caixa(c.nr_sequencia, doc_p.dt_competencia), --36
                c.nr_sequencia nr_seq_caixa, --38
                b.dt_negociacao, --39
                b.nr_seq_caixa_rec, --41
                e.nr_sequencia nr_seq_caixa_receb, --61
                e.cd_tipo_receb_caixa cd_tipo_recebimento, --64
                b.nr_sequencia nr_seq_tab_orig, --66
                e.nr_sequencia nr_seq_tab_compl --67
        into STRICT    dados_contab_w.cd_conta_contabil,  --9
                ie_caixa_w,  --12
                ie_saldo_caixa_w,  --13
                ie_debito_credito_w,  --14
                cd_historico_w,  --19
                nr_cheque_movto_w, --24
                cd_hist_caixa_movto_w, --27
                nr_seq_cheque_W, --35
                cd_conta_caixa_w, --36
                dados_contab_w.nr_seq_caixa, --38
                dt_transacao_w, --39
                nr_seq_caixa_rec_w, --41
                nr_seq_caixa_receb_w, --61
                dados_contab_w.cd_tipo_recebimento, --64
                nr_seq_tab_orig_w, --66
                nr_seq_tab_compl_w --67
        from    Transacao_financeira d,
                Caixa c,
                caixa_receb e,
                cheque_cr_negociado b,
                caixa_saldo_diario a
        where   e.nr_sequencia          = doc_p.nr_documento
        and     a.nr_sequencia          = doc_p.nr_seq_doc_compl
        and     b.nr_sequencia          = doc_p.nr_doc_analitico
        and     a.nr_seq_caixa          = c.nr_sequencia
        and     e.nr_seq_saldo_caixa    = a.nr_sequencia
        and     b.nr_seq_caixa_rec      = e.nr_sequencia
        and     (b.nr_seq_trans_financ IS NOT NULL AND b.nr_seq_trans_financ::text <> '')
        and     b.nr_seq_trans_financ   = d.nr_sequencia;
        end;
    end if;

elsif (doc_p.nm_tabela = 'TITULO_RECEBER_TRIB_BAIXA') then

    if (doc_p.nm_atributo = 'VL_TRIB_TIT_REC') then
        begin
        ie_union_w := 15;
        select  a.nr_seq_movto_trans_fin, --1
                a.nr_seq_conta_banco, --6
                b.cd_cgc, --7
                'D' ie_debito_credito, --13
                b.cd_pessoa_fisica, --16
                obter_pessoa_titulo_receber(b.nr_titulo) ds_compl_pf_pj, --17
                to_char(b.nr_documento) nr_doc_movto, --20
                b.nr_interno_conta nr_interno_conta_movto, --22
                b.nr_titulo nr_seq_titulo_receber, --29
                obter_pessoa_titulo_receber(b.nr_titulo), --36
                somente_numero(obter_dados_titulo_receber(b.nr_titulo,'NFT')) nr_nota_fiscal, --39
                a.nr_sequencia, --53
                b.cd_estabelecimento cd_estab_movto, --54
                a.nr_documento nr_doc_tit_receb, --56
                b.nr_seq_protocolo, --62
                a.cd_tipo_recebimento, --63
                b.nr_titulo nr_seq_tab_orig, --65
                c.nr_sequencia nr_seq_tab_compl, --66
                a.nr_seq_liq_origem, --70
				b.nr_seq_proj_rec
        into STRICT    nr_seq_movto_w, --1
                dados_contab_w.nr_seq_conta_banco, --6
                dados_contab_w.cd_cnpj, --7
                ie_debito_credito_w, --13
                dados_contab_w.cd_pessoa_fisica, --16
                ds_hist_pf_pj_w, --17
                nr_doc_movto_w, --20
                nr_interno_conta_movto_w, --22
                dados_contab_w.nr_titulo_receber, --29
                ds_pessoa_titulo_w, --36
                nr_nota_fiscal_w, --39
                nr_seq_baixa_w, --53
                dados_contab_w.cd_estab_movto, --54
                nr_doc_tit_receb_w, --56
                nr_seq_protocolo_w, --62
                dados_contab_w.cd_tipo_recebimento, --63
                nr_seq_tab_orig_w, --65
                nr_seq_tab_compl_w, --66
                nr_seq_liq_origem_w, --70
				nr_seq_proj_rec_w
        from    titulo_receber_trib_baixa c,
                titulo_receber b,
                titulo_receber_liq a
        where   b.nr_titulo             = doc_p.nr_documento
        and     a.nr_sequencia          = doc_p.nr_seq_doc_compl
        and     c.nr_sequencia          = doc_p.nr_doc_analitico
        and     (c.nr_seq_trans_financ IS NOT NULL AND c.nr_seq_trans_financ::text <> '')
        and     a.nr_titulo             = b.nr_titulo
        and     a.nr_titulo             = c.nr_titulo
        and     a.nr_sequencia          = c.nr_seq_tit_liq
        and     ((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = doc_p.cd_estabelecimento))
        and     coalesce(a.ie_lib_caixa, 'S') = 'S';
        end;
    end if;

elsif (doc_p.nm_tabela = 'MOVTO_CARTAO_CR_PARCELA' and ie_contab_desp_cartao_w = 'S')  then

    if (doc_p.nm_atributo = 'VL_PARCELA_CARTAO' and doc_p.vl_movimento > 0) then
        begin
        ie_union_w := 18;
        select  a.nr_seq_movto, --1
                'D' ie_debito_credito, --13
                a.dt_parcela, --38
                b.nr_seq_caixa_rec, --40
                b.nr_sequencia nr_seq_movto_cartao, --49
                a.nr_sequencia nr_seq_tab_orig, --65
                b.nr_sequencia nr_seq_tab_compl --66
        into STRICT    nr_seq_movto_w, --1
                ie_debito_credito_w, --13
                dt_transacao_w, --38
                nr_seq_caixa_rec_w, --40
                nr_seq_movto_cartao_w, --49
                nr_seq_tab_orig_w, --65
                nr_seq_tab_compl_w --66
        from    movto_cartao_cr_parcela a,
                movto_cartao_cr b
        where   b.nr_sequencia          = doc_p.nr_documento
        and     a.nr_sequencia          = doc_p.nr_seq_doc_compl
        and     a.nr_seq_movto          = b.nr_sequencia
        and     (nr_seq_caixa_rec IS NOT NULL AND nr_seq_caixa_rec::text <> '');
        end;

    elsif (doc_p.nm_atributo = 'VL_PARCELA_CARTAO' and doc_p.vl_movimento < 0) then
        begin
        ie_union_w := 24;
        select  a.nr_seq_movto, --1
                'D' ie_debito_credito, --13
                a.dt_parcela, --38
                b.nr_seq_caixa_rec, --40
                b.nr_sequencia nr_seq_movto_cartao, --49
                a.nr_sequencia nr_seq_tab_orig, --65
                b.nr_sequencia nr_seq_tab_compl --66
        into STRICT    nr_seq_movto_w, --1
                ie_debito_credito_w, --13
                dt_transacao_w, --38
                nr_seq_caixa_rec_w, --40
                nr_seq_movto_cartao_w, --49
                nr_seq_tab_orig_w, --65
                nr_seq_tab_compl_w --66
        from    movto_cartao_cr_parcela a,
                movto_cartao_cr b
        where   b.nr_sequencia          = doc_p.nr_documento
        and     a.nr_sequencia          = doc_p.nr_seq_doc_compl
        and     a.nr_seq_movto          = b.nr_sequencia
        and     (nr_seq_caixa_rec IS NOT NULL AND nr_seq_caixa_rec::text <> '')
        and     (a.nr_lote_contabil IS NOT NULL AND a.nr_lote_contabil::text <> '')
        and     (b.dt_cancelamento IS NOT NULL AND b.dt_cancelamento::text <> '');
        end;

    elsif (doc_p.nm_atributo = 'VL_DESPESA_CARTAO' and doc_p.vl_movimento > 0) then
        begin
        ie_union_w := 19;
        select  a.nr_seq_movto, --1
                'D' ie_debito_credito, --13
                substr(obter_pf_pj_caixa(b.nr_seq_caixa_rec),1,255) ds_compl_pf_pj, --17
                substr(obter_pf_pj_caixa(b.nr_seq_caixa_rec),1,255) ds_compl_pf_pj_movto, --25
                a.dt_parcela, --38
                b.nr_seq_caixa_rec, --40
                b.nr_autorizacao nr_autorizacao, --48
                b.nr_sequencia nr_seq_movto_cartao, --49
                a.nr_sequencia nr_seq_tab_orig, --65
                b.nr_sequencia nr_seq_tab_compl --66
        into STRICT    nr_seq_movto_w, --1
                ie_debito_credito_w, --13
                ds_hist_pf_pj_w, --17
                ds_compl_pf_pj_movto_w, --25
                dt_transacao_w, --38
                nr_seq_caixa_rec_w, --40
                nr_autorizacao_w, --48
                nr_seq_movto_cartao_w, --49
                nr_seq_tab_orig_w, --65
                nr_seq_tab_compl_w --66
        from    movto_cartao_cr_parcela a,
                movto_cartao_cr b
        where   b.nr_sequencia          = doc_p.nr_documento
        and     a.nr_sequencia          = doc_p.nr_seq_doc_compl
        and     a.nr_seq_movto          = b.nr_sequencia
        and     (nr_seq_caixa_rec IS NOT NULL AND nr_seq_caixa_rec::text <> '')
        and     coalesce(b.dt_cancelamento::text, '') = '';
        end;

    elsif (doc_p.nm_atributo = 'VL_DESPESA_CARTAO' and doc_p.vl_movimento < 0) then
        begin
        ie_union_w := 25;
        select  a.nr_seq_movto, --1
                'D' ie_debito_credito, --13
                substr(obter_pf_pj_caixa(b.nr_seq_caixa_rec),1,255) ds_compl_pf_pj, --17
                substr(obter_pf_pj_caixa(b.nr_seq_caixa_rec),1,255) ds_compl_pf_pj_movto, --25
                a.dt_parcela, --38
                b.nr_seq_caixa_rec, --40
                b.nr_autorizacao nr_autorizacao, --48
                b.nr_sequencia nr_seq_movto_cartao, --49
                a.nr_sequencia nr_seq_tab_orig, --65
                b.nr_sequencia nr_seq_tab_compl --66
        into STRICT    nr_seq_movto_w, --1
                ie_debito_credito_w, --13
                ds_hist_pf_pj_w, --17
                ds_compl_pf_pj_movto_w, --25
                dt_transacao_w, --38
                nr_seq_caixa_rec_w, --40
                nr_autorizacao_w, --48
                nr_seq_movto_cartao_w, --49
                nr_seq_tab_orig_w, --65
                nr_seq_tab_compl_w --66
        from    movto_cartao_cr_parcela a,
                movto_cartao_cr b
        where   b.nr_sequencia          = doc_p.nr_documento
        and     a.nr_sequencia          = doc_p.nr_seq_doc_compl
        and     a.nr_seq_movto          = b.nr_sequencia
        and     (nr_seq_caixa_rec IS NOT NULL AND nr_seq_caixa_rec::text <> '')
        and     (a.nr_lote_contabil IS NOT NULL AND a.nr_lote_contabil::text <> '')
        and     (b.dt_cancelamento IS NOT NULL AND b.dt_cancelamento::text <> '');
        end;

    elsif (doc_p.nm_atributo = 'VL_LIQUIDO_CARTAO' and doc_p.vl_movimento > 0) then
        begin
        ie_union_w := 23;
        select  a.nr_seq_movto, --1
                'D' ie_debito_credito, --13
                substr(obter_pf_pj_caixa(b.nr_seq_caixa_rec),1,255) ds_compl_pf_pj, --17
                substr(obter_pf_pj_caixa(b.nr_seq_caixa_rec),1,255) ds_compl_pf_pj_movto, --25
                a.dt_parcela, --38
                b.nr_seq_caixa_rec, --40
                substr(obter_desc_bandeira_cartao(b.nr_seq_bandeira),1,255) ds_bandeira, --41
                substr(b.ds_observacao,1,255) ds_obs_cartao, --42
                b.nr_autorizacao, --48
                b.nr_sequencia nr_seq_movto_cartao, --49
                a.nr_sequencia nr_seq_tab_orig, --65
                b.nr_sequencia nr_seq_tab_compl --66
        into STRICT    nr_seq_movto_w, --1
                ie_debito_credito_w, --13
                ds_hist_pf_pj_w, --17
                ds_compl_pf_pj_movto_w, --25
                dt_transacao_w, --38
                nr_seq_caixa_rec_w, --40
                ds_bandeira_w, --41
                ds_obs_cartao_w, --42
                nr_autorizacao_w, --48
                nr_seq_movto_cartao_w, --49
                nr_seq_tab_orig_w, --65
                nr_seq_tab_compl_w --66
        from    movto_cartao_cr_parcela a,
                movto_cartao_cr b
        where   b.nr_sequencia          = doc_p.nr_documento
        and     a.nr_sequencia          = doc_p.nr_seq_doc_compl
        and     a.nr_seq_movto          = b.nr_sequencia
        and     (nr_seq_caixa_rec IS NOT NULL AND nr_seq_caixa_rec::text <> '')
        and     coalesce(b.dt_cancelamento::text, '') = '';
        end;

    elsif (doc_p.nm_atributo = 'VL_LIQUIDO_CARTAO' and doc_p.vl_movimento < 0) then
        begin
        ie_union_w := 26;
        select  a.nr_seq_movto, --1
                'D' ie_debito_credito, --13
                substr(obter_pf_pj_caixa(b.nr_seq_caixa_rec),1,255) ds_compl_pf_pj, --17
                substr(obter_pf_pj_caixa(b.nr_seq_caixa_rec),1,255) ds_compl_pf_pj_movto, --25
                a.dt_parcela, --38
                b.nr_seq_caixa_rec, --40
                substr(obter_desc_bandeira_cartao(b.nr_seq_bandeira),1,255) ds_bandeira, --41
                substr(b.ds_observacao,1,255) ds_obs_cartao, --42
                b.nr_autorizacao, --48
                b.nr_sequencia nr_seq_movto_cartao, --49
                a.nr_sequencia nr_seq_tab_orig, --65
                b.nr_sequencia nr_seq_tab_compl --66
        into STRICT    nr_seq_movto_w, --1
                ie_debito_credito_w, --13
                ds_hist_pf_pj_w, --17
                ds_compl_pf_pj_movto_w, --25
                dt_transacao_w, --38
                nr_seq_caixa_rec_w, --40
                ds_bandeira_w, --41
                ds_obs_cartao_w, --42
                nr_autorizacao_w, --48
                nr_seq_movto_cartao_w, --49
                nr_seq_tab_orig_w, --65
                nr_seq_tab_compl_w --66
        from    movto_cartao_cr_parcela a,
                movto_cartao_cr b
        where   b.nr_sequencia          = doc_p.nr_documento
        and     a.nr_sequencia          = doc_p.nr_seq_doc_compl
        and     a.nr_seq_movto          = b.nr_sequencia
        and     (nr_seq_caixa_rec IS NOT NULL AND nr_seq_caixa_rec::text <> '')
        and     (a.nr_lote_contabil IS NOT NULL AND a.nr_lote_contabil::text <> '')
        and     (b.dt_cancelamento IS NOT NULL AND b.dt_cancelamento::text <> '');
        end;
    end if;

elsif (doc_p.nm_tabela = 'TITULO_REC_LIQ_CC') then

    if (doc_p.nm_atributo = 'VL_RECEBIDO_TESOURARIA' and ie_contab_rec_classif_w = 'S') then
        begin
        ie_union_w := 20;
        select  c.nr_seq_movto_trans_fin nr_sequencia, --2
                c.nr_seq_conta_banco, --7
                b.cd_cgc, --8
                d.cd_conta_contabil cd_conta_contab_caixa, --9
                d.cd_centro_custo, --10
                b.cd_pessoa_fisica, --17
                obter_pessoa_titulo_receber(b.nr_titulo) ds_compl_pf_pj, --18
                b.nr_interno_conta nr_interno_conta_movto, --23
                b.nr_titulo nr_seq_titulo_receber, --30
                d.cd_conta_contabil, --36
                obter_pessoa_titulo_receber(b.nr_titulo), --37
                coalesce(c.dt_recebimento,clock_timestamp()), --39
                somente_numero(obter_dados_titulo_receber(b.nr_titulo,'NFT')) nr_nota_fiscal, --40
                d.nr_seq_produto, --44
                b.cd_estabelecimento cd_estab_movto, --55
                c.nr_documento nr_doc_tit_receb, --57
                b.nr_seq_protocolo, --63
                c.cd_tipo_recebimento, --64
                b.nr_titulo nr_seq_tab_orig, --66
                d.nr_sequencia nr_seq_tab_compl, --67
                c.nr_seq_liq_origem, --71
				b.nr_seq_proj_rec
        into STRICT    nr_seq_movto_w,  --2
                dados_contab_w.nr_seq_conta_banco,  --7
                dados_contab_w.cd_cnpj,  --8
                dados_contab_w.cd_conta_contabil,  --9
                dados_contab_w.cd_centro_custo, --10
                dados_contab_w.cd_pessoa_fisica,  --17
                ds_hist_pf_pj_w , --18
                nr_interno_conta_movto_w, --23
                dados_contab_w.nr_titulo_receber, --30
                cd_conta_caixa_w, --36
                ds_pessoa_titulo_w, --37
                dt_transacao_w, --39
                nr_nota_fiscal_w, --40
                dados_contab_w.nr_seq_produto, --44
                dados_contab_w.cd_estab_movto, --55
                nr_doc_tit_receb_w, --57
                nr_seq_protocolo_w, --63
                dados_contab_w.cd_tipo_recebimento, --64
                nr_seq_tab_orig_w, --66
                nr_seq_tab_compl_w, --67
                nr_seq_liq_origem_w, --71
				nr_seq_proj_rec_w
        from    titulo_rec_liq_cc d,
                titulo_receber_liq c,
                titulo_receber b
        where   d.nr_titulo             = doc_p.nr_documento
        and     d.nr_seq_baixa          = doc_p.nr_seq_doc_compl
        and     d.nr_sequencia          = doc_p.nr_doc_analitico
        and     c.nr_titulo             = d.nr_titulo
        and     c.nr_sequencia          = d.nr_seq_baixa
        and     c.nr_titulo             = b.nr_titulo
        and     c.vl_Recebido           <> 0
        and     (c.nr_seq_trans_fin IS NOT NULL AND c.nr_seq_trans_fin::text <> '')
        and     ((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = cd_estabelecimento_w))
        and     coalesce(ie_lib_caixa, 'S')      = 'S';
        end;
    end if;

end if;

nm_agrupador_w := coalesce(trim(both obter_agrupador_contabil(10)), 'NR_SEQ_MOVTO_TRANS_FIN');

if (dados_contab_w.cd_estab_movto = 0) then
        dados_contab_w.cd_estab_movto       := null;
end if;

if (coalesce(nr_seq_movto_trans_fin_w,0) > 0) then
    begin
    if (coalesce(nr_adiant_movto_w,0) = 0) then
            begin
            select  coalesce(nr_adiantamento, 0)
            into STRICT    nr_adiant_movto_w
            from    movto_trans_financ
            where   nr_sequencia = nr_seq_movto_trans_fin_w;
            exception when others then
                    nr_adiant_movto_w       := null;
            end;
    end if;

    if (coalesce(nr_adiant_movto_w,0) <> 0) then
            begin
            select  ds_observacao
            into STRICT    ds_obs_adiantamento_w
            from    adiantamento
            where   nr_adiantamento = nr_adiant_movto_w;
            exception when others then
                    ds_obs_adiantamento_w   := '';
            end;
            end if;
    end;
end if;

if (coalesce(dados_contab_w.cd_pessoa_fisica, '0') <> '0') then
    begin
    select  nr_cpf
    into STRICT    nr_cpf_w
    from    pessoa_fisica
    where   cd_pessoa_fisica = dados_contab_w.cd_pessoa_fisica;
    exception when others then
            nr_cpf_w := '';
    end;
end if;

if (coalesce(dados_contab_w.nr_seq_caixa_od,0) <> 0) then
    begin
    select  max(ds_caixa),
            max(cd_estabelecimento)
    into STRICT    ds_caixa_od_w,
            cd_estab_caixa_od_w
    from    caixa
    where   nr_sequencia = dados_contab_w.nr_seq_caixa_od;
    exception when others then
            ds_caixa_od_w           := null;
            cd_estab_caixa_od_w     := null;
    end;
end if;

if (coalesce(dados_contab_w.nr_seq_nota_fiscal, 0) = 0) and (coalesce(dados_contab_w.nr_titulo_pagar, 0) = 0) and (coalesce(dados_contab_w.nr_titulo_receber, 0) = 0) and (coalesce(nr_seq_caixa_rec_w, 0) <> 0) and (doc_p.nm_atributo  = 'VL_TRANSACAO') and (doc_p.nm_tabela  = 'CAIXA_SALDO_DIARIO') then
    begin
    select  count(nr_sequencia),
            max(nr_titulo)
    into STRICT    qt_tit_caixa_rec_w,
            dados_contab_w.nr_titulo_receber
    from    titulo_receber_liq
    where   nr_seq_caixa_rec = nr_seq_caixa_rec_w;

    if (qt_tit_caixa_rec_w > 1) then
            dados_contab_w.nr_titulo_receber := null;
    end if;
    end;
end if;

if ( coalesce(dados_contab_w.nr_titulo_receber,0) != 0) then
    begin
    if (coalesce(ds_pessoa_titulo_w, 'X') = 'X') then
            ds_pessoa_titulo_w := obter_pessoa_titulo_receber(dados_contab_w.nr_titulo_receber);
    end if;
    end;
end if;

if (coalesce(dados_contab_w.nr_seq_produto,0) = 0) then
    if (coalesce(dados_contab_w.nr_titulo_receber,0) <> 0) then
            select  max(nr_seq_produto)
            into STRICT    dados_contab_w.nr_seq_produto
            from    titulo_receber_classif
            where   nr_titulo = dados_contab_w.nr_titulo_receber;
    end if;

    if (coalesce(nr_adiant_movto_w,0) <> 0) then
            select  max(nr_seq_produto)
            into STRICT    dados_contab_w.nr_seq_produto
            from    adiantamento_classif
            where   nr_adiantamento = nr_adiant_movto_w;
    end if;

    begin
    if (coalesce(dados_contab_w.nr_seq_produto,0) = 0) and (coalesce(nr_seq_movto_cartao_w,0) <> 0) then
            dados_contab_w.nr_seq_produto   := (substr(obter_prod_financ(nr_seq_movto_cartao_w, 'AC','P'),1,10))::numeric;
    elsif (coalesce(dados_contab_w.nr_seq_produto,0) = 0) and (doc_p.nm_atributo = 'VL_TRANSACAO') then
            dados_contab_w.nr_seq_produto   := (substr(obter_prod_financ(nr_seq_movto_trans_fin_w, 'MV','P'),1,10))::numeric;
    elsif (coalesce(dados_contab_w.nr_seq_produto,0) = 0) and (coalesce(dados_contab_w.nr_titulo_pagar,0) <> 0) then
            dados_contab_w.nr_seq_produto   := (substr(obter_prod_financ(dados_contab_w.nr_titulo_pagar, 'TP','P'),1,10))::numeric;
    elsif (coalesce(dados_contab_w.nr_seq_produto,0) = 0) and (coalesce(dados_contab_w.nr_seq_nota_fiscal,0) <> 0) then
            dados_contab_w.nr_seq_produto   := (substr(obter_prod_financ(dados_contab_w.nr_seq_nota_fiscal, 'NF','P'),1,10))::numeric;
    end if;
    exception when others then
            dados_contab_w.nr_seq_produto   := null;
    end;
end if;

if (coalesce(nr_seq_cheque_cp_w,0) <> 0) then
        ds_cheque_cp_w  := substr(obter_dados_cheque_cp(nr_seq_cheque_cp_w, 'DS'), 1,180);
end if;

if (nr_seq_caixa_rec_w IS NOT NULL AND nr_seq_caixa_rec_w::text <> '') then
    nr_documento_caixa_rec_w        := substr(obter_dados_caixa_receb(nr_seq_caixa_rec_w, 'DOC'),1,255);
    ds_obs_caixa_receb_w            := substr(obter_dados_caixa_receb(nr_seq_caixa_rec_w, 'OBS'),1,254);

    if (coalesce(nr_nota_fiscal_w, '0') = '0') then
            nr_nota_fiscal_w := substr(obter_dados_caixa_receb(nr_seq_caixa_rec_w, 'NFT'),1,255);
    end if;

    nr_negociacao_w     := substr(obter_numero_negociacao_hist(null, null, nr_seq_caixa_rec_w),1,20);
end if;

if (coalesce(nr_seq_movto_w,0) <> 0 and ie_union_w not in (26, 25, 24, 23, 19, 18)) then
    begin

    begin
    select  ie_estorno,
            nr_seq_lote,
            substr(obter_nome_pf_pj(cd_pessoa_fisica, cd_cgc), 1, 255),
            nr_seq_movto_orig,
            CASE WHEN coalesce(nr_seq_caixa_rec_w,0)=0 THEN nr_seq_caixa_rec  ELSE nr_seq_caixa_rec_w END
    into STRICT    ie_estorno_w,
            nr_seq_lote_w,
            nm_pessoa_movto_w,
            nr_seq_movto_orig_w,
            nr_seq_caixa_rec_w
            from        movto_trans_financ
            where       nr_sequencia = nr_seq_movto_w;
    exception when others then
            ds_estorno_w            := '';
            nr_seq_lote_w           := null;
            nm_pessoa_movto_w       := '';
    end;

    select  max(nr_seq_movto_pend)
    into STRICT    nr_seq_movto_bco_pend_w
    from    movto_banco_pend_baixa
    where   nr_seq_movto_trans_fin  = nr_seq_movto_w;

    select  max(b.ds_conta)
    into STRICT    ds_conta_banco_pend_w
    from    banco_estabelecimento_v b,
            movto_banco_pend a
    where   a.nr_seq_conta_banco    = b.nr_sequencia
    and     a.nr_sequencia          = nr_seq_movto_bco_pend_w;

    if (ie_estorno_w = 'E') then
            ds_estorno_w := substr(wheb_mensagem_pck.get_texto(304692),1,255); --Estorno
    end if;
    end;

elsif (coalesce(nr_seq_caixa_rec_w,0) <> 0) and (coalesce(nr_seq_movto_w,0) = 0) then
    begin

    open C04;
    loop
    fetch C04 into
            ie_estorno_w,
            nr_seq_lote_w,
            nm_pessoa_movto_w,
            nr_seq_movto_orig_w;
    EXIT WHEN NOT FOUND; /* apply on C04 */
            begin
            /* Cursor Para pegar o maior numero de informacoes nescessarias*/

            ie_estorno_w:= ie_estorno_w;
            end;
            end loop;
    close C04;

    select  max(nr_seq_movto_pend)
    into STRICT    nr_seq_movto_bco_pend_w
    from    movto_banco_pend_baixa b,
            movto_trans_financ a
    where   b.nr_seq_movto_trans_fin        = a.nr_sequencia
    and     a.nr_seq_caixa_rec              = nr_seq_caixa_rec_w;

    select  max(b.ds_conta)
    into STRICT    ds_conta_banco_pend_w
    from    banco_estabelecimento_v b,
            movto_banco_pend a
    where   a.nr_seq_conta_banco    = b.nr_sequencia
    and     a.nr_sequencia          = nr_seq_movto_bco_pend_w;

    if (ie_estorno_w = 'E') then
            ds_estorno_w    := substr(wheb_mensagem_pck.get_texto(304692),1,255); --Estorno
    end if;

    end;
end if;

/*Busca adiantamento pelo movimento de origem */

if (coalesce(nr_adiant_movto_w, 0) = 0) and (coalesce(nr_seq_movto_orig_w, 0) <> 0) then
    select  max(b.nr_adiantamento)
    into STRICT    nr_adiant_movto_w
    from    adiantamento b,
            movto_trans_financ a
    where   a.nr_seq_caixa_rec      = b.nr_seq_caixa_rec
    and     a.nr_sequencia          = nr_seq_movto_orig_w;
end if;

if (coalesce(nr_adiant_movto_w,0) <> 0) then
    begin
    select  ds_observacao
    into STRICT    ds_obs_adiantamento_w
    from    adiantamento
    where   nr_adiantamento = nr_adiant_movto_w;
    exception when others then
            ds_obs_adiantamento_w   := '';
    end;
end if;

if (coalesce(nr_seq_caixa_rec_w,0) <> 0) then
    begin
    begin
    select  nr_recibo,
            coalesce(cd_pessoa_fisica, cd_cgc),
            substr(obter_nome_pf_pj(cd_pessoa_fisica, cd_cgc),1,240) nm_pessoa_caixa,
    CASE WHEN coalesce(dados_contab_w.nr_seq_caixa,0)=0 THEN null  ELSE dados_contab_w.nr_seq_caixa END
    into STRICT    nr_recibo_rec_w,
            cd_pessoa_caixa_receb_w,
            nm_pessoa_caixa_receb_w,
    dados_contab_w.nr_seq_caixa
    from    caixa_receb
    where   nr_sequencia = nr_seq_caixa_rec_w;
    exception when others then
            nr_recibo_rec_w         := '';
            cd_pessoa_caixa_receb_w := '';
            nm_pessoa_caixa_receb_w := '';
    end;

    begin
    select  vl_especie,
            obter_valores_caixa_rec(nr_sequencia,'VCH') vl_cheque,
            obter_valores_caixa_rec(nr_sequencia,'VCA') vl_cartao
    into STRICT    vl_especie_w,
            vl_cheque_w,
            vl_cartao_w
    from    caixa_receb
    where   nr_sequencia = nr_seq_caixa_rec_w;
    exception when others then
            vl_especie_w    := 0;
            vl_cheque_w     := 0;
            vl_cartao_w     := 0;
    end;

    if (doc_p.nm_atributo = 'VL_TRANSACAO') and (coalesce(nr_doc_tit_receb_w::text, '') = '') then
            select  substr(max(nr_documento),1,22)
            into STRICT    nr_doc_tit_receb_w
            from    titulo_receber_liq
            where   nr_seq_caixa_rec = nr_seq_caixa_rec_w;
            end if;
    end;
end if;

if (coalesce(nr_seq_caixa_rec_w,0) = 0) and (coalesce(nr_seq_movto_orig_w,0) <> 0) and (coalesce(nr_recibo_rec_w,'0') = '0') then
    begin
    select  b.nr_recibo
    into STRICT    nr_recibo_rec_w
    from    caixa_receb b,
            movto_trans_financ a
    where   a.nr_seq_caixa_rec      = b.nr_sequencia
    and     a.nr_sequencia          = nr_seq_movto_orig_w;
    exception when others then
            nr_recibo_rec_w := '';
    end;
end if;

if (coalesce(dados_contab_w.nr_seq_caixa,0) = 0) and (coalesce(nr_seq_movto_w, 0) > 0) then
    select  max(nr_seq_caixa)
    into STRICT    dados_contab_w.nr_seq_caixa
    from    movto_trans_financ
    where   nr_sequencia = nr_seq_movto_w;
end if;

if (coalesce(nr_seq_movto_cartao_w,0) = 0) and (coalesce(nr_seq_caixa_rec_w,0) <> 0) then
    begin
    select  max(nr_sequencia)
    into STRICT    nr_seq_movto_cartao_w
    from    movto_cartao_cr
    where   nr_seq_caixa_rec = nr_seq_caixa_rec_w;
    end;
end if;

if (coalesce(nr_seq_movto_cartao_w,0) <> 0) then
    select  max(nr_seq_bandeira),
            max(nr_seq_forma_pagto),
            substr(max(obter_nome_pf_pj(cd_pessoa_fisica,cd_cgc)),1,255),
            max(cd_estabelecimento)
    into STRICT    dados_contab_w.nr_seq_bandeira,
            nr_seq_forma_pagto_w,
            nm_pf_pj_cartao_w,
            dados_contab_w.cd_estab_inf_movto
    from    movto_cartao_cr
    where   nr_sequencia    = nr_seq_movto_cartao_w;

    if (coalesce(nr_autorizacao_w,'0') = '0') then
        begin
        select  coalesce(max(nr_autorizacao),nr_autorizacao_w)
        into STRICT    nr_autorizacao_w
        from    movto_cartao_cr
        where   nr_sequencia    = nr_seq_movto_cartao_w;
        end;
        end if;

    if (coalesce(ds_bandeira_w,'X') = 'X') then
            ds_bandeira_w   := substr(obter_desc_bandeira_cartao(dados_contab_w.nr_seq_bandeira), 1, 140);
    end if;

    if (coalesce(nr_seq_forma_pagto_w, 0) <> 0) then
        select  max(ds_forma_pagto)
        into STRICT    ds_forma_pagto_w
        from    forma_pagto_cartao_cr
        where   nr_sequencia    = nr_seq_forma_pagto_w;
    end if;
end if;

if (nm_agrupador_w = 'NR_SEQ_LOTE') then
    begin
    if (doc_p.nm_atributo like '%CARTAO%') then
        begin
        select  a.nr_seq_lote
        into STRICT    dados_contab_w.nr_seq_agrupamento
        from    movto_trans_financ a
        where   a.nr_seq_movto_cartao = nr_seq_movto_w
        and     a.nr_seq_trans_financ = doc_p.nr_seq_trans_financ
        and     (a.nr_seq_lote IS NOT NULL AND a.nr_seq_lote::text <> '')  LIMIT 1;
        exception
        when others then
            begin
            select  a.nr_seq_lote
            into STRICT    dados_contab_w.nr_seq_agrupamento
            from    movto_trans_financ a
            where   a.nr_seq_movto_cartao = nr_seq_movto_w
            and     (a.nr_seq_lote IS NOT NULL AND a.nr_seq_lote::text <> '')  LIMIT 1;
            exception
            when others then
                    dados_contab_w.nr_seq_agrupamento := nr_seq_lote_w;
            end;
        end;
    else
        begin
        dados_contab_w.nr_seq_agrupamento := nr_seq_lote_w;

        if (ie_estorno_w in ('E', 'S')) then
            begin
            select      nr_seq_lote
            into STRICT        nr_seq_lote_orig_w
            from        movto_trans_financ
            where       nr_sequencia = nr_seq_movto_orig_w;

            dados_contab_w.nr_seq_agrupamento := coalesce(nr_seq_lote_orig_w, nr_seq_lote_w);
            exception when others then
                    dados_contab_w.nr_seq_agrupamento := nr_seq_lote_w;
            end;
        end if;

        if (coalesce(nr_seq_movto_transf_w,0) <> 0) and (ie_caixa_w = 'T') then
            begin
            select  coalesce(max(nr_seq_lote), dados_contab_w.nr_seq_agrupamento)
            into STRICT    dados_contab_w.nr_seq_agrupamento
            from    movto_trans_financ
            where   nr_sequencia    = nr_seq_movto_transf_w;
            end;
        end if;
        end;
    end if;
    end;

elsif (nm_agrupador_w = 'NR_TITULO') then
        select  coalesce(max(CASE WHEN coalesce(dados_contab_w.nr_titulo_receber,0)=0 THEN dados_contab_w.nr_titulo_pagar  ELSE dados_contab_w.nr_titulo_receber END ),0)
        into STRICT    dados_contab_w.nr_seq_agrupamento
;

elsif (nm_agrupador_w = 'NR_SEQ_MOVTO_TRANS_FIN') then
        begin
        if (coalesce(nr_seq_movto_transf_w, 0) != 0) then
            begin
            dados_contab_w.nr_seq_agrupamento := nr_seq_movto_transf_w;
            end;
        else
                dados_contab_w.nr_seq_agrupamento := nr_seq_movto_w;
        end if;

        if (ie_estorno_w in ('E', 'S')) then
            begin
            dados_contab_w.nr_seq_agrupamento := nr_seq_movto_orig_w;

            if (coalesce(nr_seq_movto_orig_w,0 ) <> 0) then
                select  max(nr_seq_movto_transf)
                into STRICT    nr_seq_movto_transf_estorno_w
                from    movto_trans_financ
                where   nr_sequencia = nr_seq_movto_orig_w;

                if (coalesce(nr_seq_movto_transf_estorno_w, 0) != 0) then
                        dados_contab_w.nr_seq_agrupamento := nr_seq_movto_transf_estorno_w;
                end if;
            end if;
            end;
        end if;

        if (coalesce(nr_seq_liq_origem_w,0) <> 0) then
            begin
            select  a.nr_seq_movto_trans_fin
            into STRICT    nr_seq_movto_orig_w
            from    titulo_receber_liq a
            where   a.nr_titulo     = dados_contab_w.nr_titulo_receber
            and     a.nr_sequencia  = nr_seq_liq_origem_w;

            dados_contab_w.nr_seq_agrupamento := nr_seq_movto_orig_w;
            exception when others then
                    nr_seq_movto_orig_w     := null;
            end;
        end if;

        if (doc_p.nm_atributo like '%CARTAO%') and (coalesce(dados_contab_w.nr_seq_agrupamento,0) = 0) then

            dados_contab_w.nr_seq_agrupamento := nr_seq_movto_w;
        end if;

        end;

elsif (nm_agrupador_w = 'NR_SEQ_LOTE_CAIXA') then
    begin
    dados_contab_w.nr_seq_agrupamento := somente_numero(substr(nr_seq_lote_w || dados_contab_w.nr_seq_caixa,1,10));

    if (ie_estorno_w in ('E', 'S')) then
        begin
        select  nr_seq_lote
        into STRICT    nr_seq_lote_orig_w
        from    movto_trans_financ
        where   nr_sequencia = nr_seq_movto_orig_w;

        dados_contab_w.nr_seq_agrupamento       := somente_numero(substr(coalesce(nr_seq_lote_orig_w, nr_seq_lote_w) || dados_contab_w.nr_seq_caixa,1,10));
        exception when others then
                dados_contab_w.nr_seq_agrupamento       := somente_numero(substr(nr_seq_lote_w || dados_contab_w.nr_seq_caixa,1,10));
        end;
end if;

    if (coalesce(nr_seq_movto_transf_w, 0) <> 0) and (ie_caixa_w = 'T') then
        begin

        select  nr_seq_lote,
                nr_seq_caixa
        into STRICT    nr_seq_lote_transf_w,
                nr_seq_caixa_transf_w
        from    movto_trans_financ
        where   nr_sequencia    = nr_seq_movto_transf_w;

        if (coalesce(nr_seq_lote_transf_w, 0) <> 0) and (coalesce(nr_seq_caixa_transf_w, 0) <> 0) then
                dados_contab_w.nr_seq_agrupamento := somente_numero(substr(nr_seq_lote_transf_w || nr_seq_caixa_transf_w,1,10));
        end if;

        exception when others then
                nr_seq_lote_transf_w    := null;
                nr_seq_caixa_transf_w   := null;
        end;
    end if;

    exception when others then
            dados_contab_w.nr_seq_agrupamento := 0;
    end;

elsif (nm_agrupador_w = 'NR_SEQ_CAIXA')then
        begin
                dados_contab_w.nr_seq_agrupamento := substr(dados_contab_w.nr_seq_caixa,1,10);
        end;

else
        dados_contab_w.nr_seq_agrupamento := nr_seq_movto_w;
end if;

if (coalesce(dados_contab_w.nr_seq_agrupamento,0) = 0)  then
    begin
    dados_contab_w.nr_seq_agrupamento       := nr_seq_movto_w;

    if (ie_estorno_w in ('E', 'S')) then
            dados_contab_w.nr_seq_agrupamento       := nr_seq_movto_orig_w;
    end if;
    end;
end if;

if (dados_contab_w.nr_seq_conta_banco IS NOT NULL AND dados_contab_w.nr_seq_conta_banco::text <> '') then
    begin
    select  ds_conta
    into STRICT    ds_conta_od_w
    from    banco_estabelecimento_v
    where   nr_sequencia    = dados_contab_w.nr_seq_conta_banco;
    exception when others then
            ds_conta_od_w   := '';
    end;
end if;


if (ie_union_w in (1,6,7)) then
    select  substr(max(ds_banco),1,40)
    into STRICT    ds_banco_od_w
    from    banco_estabelecimento_v
    where   nr_sequencia    = dados_contab_w.nr_seq_conta_banco;
end if;

if (coalesce(nr_adiant_movto_w, 0) = 0) and (coalesce(nr_seq_caixa_rec_w,0) <> 0) then
    select  max(nr_adiantamento)
    into STRICT    nr_adiant_movto_w
    from    adiantamento
    where   nr_seq_caixa_rec = nr_seq_caixa_rec_w;
end if;

select  max(substr(obter_pessoa_atendimento(nr_atendimento,'N'),1,60)),
        max(nr_recibo)
into STRICT    nm_paciente_adiantamento_w,
        nr_recibo_w
from    adiantamento
where   nr_adiantamento = nr_adiant_movto_w;

if (coalesce(nr_adiant_movto_w, 0) <> 0) and (coalesce(nm_paciente_adiantamento_w, 'X') = 'X') then
        nm_paciente_adiantamento_w := substr(obter_paciente_adiantamento(nr_adiant_movto_w, 'N'), 1, 255);
end if;

if (coalesce(nr_seq_cheque_w,0) > 0) then
    select  a.cd_banco,
            a.ds_banco,
            a.cd_agencia_bancaria,
            a.nr_conta,
            a.nr_adiantamento,
            a.nm_pessoa_fisica,
            a.ds_razao_social,
            substr(obter_dados_cheque_cr(a.nr_seq_cheque,'NP'),1,255),
            coalesce(a.dt_vencimento_atual, a.dt_vencimento),
            b.cd_banco_externo,
            nr_cpf_cheque_w,
            cd_cnpj_cheque_w
    into STRICT    cd_banco_cheque_w,
            ds_banco_cheque_w,
            cd_agencia_cheque_w,
            nr_conta_cheque_w,
            nr_adiant_cheque_w,
            nm_pf_cheque_w,
            ds_razao_social_cheque_w,
            nm_paciente_cheque_w,
            dt_venc_cheque_atual_w,
            cd_banco_ext_cheque_w,
            nr_cpf_cheque_w,
            cd_cnpj_cheque_w
    from    banco b,
            cheque_cr_v a
    where   a.nr_seq_cheque = nr_seq_cheque_w
    and     a.cd_banco      = b.cd_banco;
end if;

if (coalesce(dados_contab_w.nr_seq_caixa,0) <> 0) then
        select  max(a.ds_caixa),
                max(b.ds_classificacao)
        into STRICT    ds_caixa_w,
                ds_classificacao_w
        FROM caixa a
LEFT OUTER JOIN classif_caixa b ON (a.nr_seq_classif = b.nr_sequencia)
WHERE a.nr_sequencia = dados_contab_w.nr_seq_caixa;
end if;

ds_cheque_deposito_w    := substr(fin_obter_cheques_deposito(nr_seq_deposito_w), 1, 255);
ds_cheques_caixa_rec_w  := substr(fin_obter_cheques_caixa_rec(nr_seq_caixa_rec_w), 1, 255);

if (coalesce(dados_contab_w.nr_seq_nota_fiscal, 0) = 0) then

    if (coalesce(dados_contab_w.nr_titulo_pagar, 0) <> 0) then
            dados_contab_w.nr_seq_nota_fiscal        := substr(obter_dados_tit_pagar(dados_contab_w.nr_titulo_pagar, 'NFSEQ'),1,10);
    elsif (coalesce(dados_contab_w.nr_titulo_receber, 0) <> 0) then

            dados_contab_w.nr_seq_nota_fiscal        := substr(obter_dados_titulo_receber(dados_contab_w.nr_titulo_receber, 'SN'),1,10);
    end if;
end if;

if (coalesce(dados_contab_w.nr_seq_nota_fiscal,0) <> 0) then
    begin
    ds_pessoa_nota_w        := substr(obter_dados_nota_fiscal(dados_contab_w.nr_seq_nota_fiscal,5),1,80);

		begin
			select  substr('NF' || CASE WHEN coalesce(b.ie_servico,'N')='S' THEN 'S' END  || CASE WHEN coalesce(a.ie_nf_eletronica,'N')='S' THEN 'E' END ,1,15),
				a.cd_serie_nf,
				a.nr_nfe_imp,
				a.nr_nota_fiscal
			into STRICT    ie_nf_nfe_w,
				cd_serie_nf_w,
				nr_nfe_imp_w,
				nr_nota_fiscal_w
			from    nota_fiscal a,
				operacao_nota b
			where   a.cd_operacao_nf        = b.cd_operacao_nf
			and     a.nr_sequencia          = dados_contab_w.nr_seq_nota_fiscal;
		exception when no_data_found or too_many_rows then				
				ie_nf_nfe_w	    := null;
				cd_serie_nf_w   := null;
				nr_nfe_imp_w	:= null;
				nr_nota_fiscal_w := null;				
		end;
    exception when others then
        ds_pessoa_nota_w    := '';
    end;
end if;

ds_cheques_caixa_rec_w  := substr(ds_cheques_caixa_rec_w,1,length(ds_cheques_caixa_rec_w)-2);
dt_transacao_ww         := to_char(dt_transacao_w, 'dd/mm/yyyy');
nr_seq_tit_rec_doc_w    := dados_contab_w.nr_titulo_receber;

if (coalesce(nr_seq_tit_rec_doc_w,0) = 0) and (ie_caixa_w = 'M') and (coalesce(nr_seq_lote_w, 0) <> 0)then
    begin

    select  max(a.nr_seq_titulo_receber)
    into STRICT    nr_seq_tit_rec_doc_w
    from    movto_trans_financ a,
            transacao_financeira b
    where   a.nr_seq_lote = nr_seq_lote_w
    and     a.nr_seq_trans_financ   = b.nr_sequencia
    and     ie_caixa                = 'D';
    exception when others then
            nr_seq_tit_rec_doc_w:= null;
        end;
end if;

if (coalesce(nr_interno_conta_movto_w,0) = 0) and (coalesce(nr_seq_tit_rec_doc_w,0) <> 0) then

    select  max(nr_interno_conta)
    into STRICT    nr_interno_conta_movto_w
    from    titulo_receber
    where   nr_titulo = nr_seq_tit_rec_doc_w;

end if;

if (nr_interno_conta_movto_w <> 0) then
    select  max(cd_convenio_parametro),
            max(nr_atendimento)
    into STRICT    dados_contab_w.cd_convenio,
            nr_atendimento_w
    from    conta_paciente
    where   nr_interno_conta        = nr_interno_conta_movto_w;

    nm_paciente_atendimento_w:= obter_pessoa_atendimento(nr_atendimento_w,'N');
end if;

if (coalesce(nr_seq_movto_w, 0) > 0) then
    select  max(nr_sequencia)
    into STRICT    nr_seq_movto_pend_w
    from    movto_banco_pend
    where   nr_seq_movto_trans_fin  = nr_seq_movto_w;
end if;

if (coalesce(nr_seq_cheque_cp_w,0) > 0) then
    select  max(nr_cheque)
    into STRICT    nr_cheque_pago_w
    from    cheque
    where   nr_sequencia    = nr_seq_cheque_cp_w;
end if;

if (coalesce(dados_contab_w.nr_seq_conta_banco,0) > 0) then
    select  max(nr_sequencia)
    into STRICT    nr_seq_cob_escritural_w
    from    cobranca_escritural
    where   nr_seq_conta_banco      = dados_contab_w.nr_seq_conta_banco;
end if;

if (coalesce(dados_contab_w.nr_titulo_pagar,0) > 0) then
    select  substr(ds_observacao_titulo,1,255),
            nr_seq_trans_fin_baixa,
            nr_seq_rpa
    into STRICT    ds_observacao_cp_w,
            nr_seq_trans_fin_baixa_w,
            nr_seq_rpa_w
    from    titulo_pagar
    where   nr_titulo = dados_contab_w.nr_titulo_pagar;

    if (ctb_param_lote_tesouraria_w.ie_contab_trans_fin_baixa = 'S') then
            dados_contab_w.nr_seq_trans_fin := coalesce(nr_seq_trans_fin_baixa_w, dados_contab_w.nr_seq_trans_fin);
        end if;

    if (coalesce(nr_seq_protocolo_w::text, '') = '') then
        select  max(nr_seq_prot_conta)
        into STRICT    nr_seq_protocolo_w
        from    titulo_pagar
        where   nr_titulo = dados_contab_w.nr_titulo_pagar;
    end if;

end if;

if (coalesce(dados_contab_w.nr_titulo_receber,0) > 0) then
    select  substr(ds_observacao_titulo,1,255)
    into STRICT    ds_observacao_cr_w
    from    titulo_receber
    where   nr_titulo       = dados_contab_w.nr_titulo_receber;

    if (coalesce(nr_seq_protocolo_w::text, '') = '') then
        select  max(nr_seq_protocolo)
        into STRICT    nr_seq_protocolo_w
        from    titulo_receber
        where   nr_titulo       = dados_contab_w.nr_titulo_receber;

        if (coalesce(nr_seq_protocolo_w,0) = 0) then
            select  max(nr_interno_conta)
            into STRICT    nr_interno_conta_w
            from    titulo_receber
            where   nr_titulo       = dados_contab_w.nr_titulo_receber;

            if (coalesce(nr_interno_conta_w,0) > 0) then
                select  max(nr_seq_protocolo)
                into STRICT    nr_seq_protocolo_w
                from    conta_paciente
                where   nr_interno_conta        = nr_interno_conta_w;
            end if;
        end if;
    end if;
end if;

if (coalesce(nr_seq_caixa_rec_w,0) <> 0) then
    select  count(*)
    into STRICT    qt_registro_w
    from    cheque_cr_perda a
    where   a.nr_seq_caixa_rec      = nr_seq_caixa_rec_w;

    if (qt_registro_w > 0) then
        select  max(nr_seq_cheque)
        into STRICT    nr_seq_cheque_ww
        from    cheque_cr_perda a
        where   a.nr_seq_caixa_rec      = nr_seq_caixa_rec_w;

        select  max(nr_recibo)
        into STRICT    nr_recibo_caixa_receb_w
        from (SELECT  (obter_descricao_padrao('CAIXA_RECEB','NR_RECIBO',a.nr_seq_caixa_rec))::numeric  nr_recibo
                from    caixa b,
                        movto_trans_financ_v a
                where   a.nr_seq_caixa  = b.nr_sequencia
                and     exists (       SELECT 1
                                        from    movto_trans_financ      x
                                        where   x.nr_seq_lote   = a.nr_seq_lote
                                        and     x.nr_seq_caixa  = a.nr_seq_caixa
                                        and     x.nr_seq_cheque = nr_seq_cheque_ww)
                and     not exists (    select      1
                                        from    titulo_receber_liq z,
                                                movto_trans_financ y
                                        where   y.nr_sequencia          = a.nr_sequencia
                                        and     y.nr_seq_titulo_receber = z.nr_titulo
                                        and     y.nr_seq_caixa_rec      = z.nr_seq_caixa_rec)

union all

                select  (obter_descricao_padrao('CAIXA_RECEB','NR_RECIBO',a.nr_seq_caixa_rec))::numeric  nr_recibo
                from    titulo_receber_liq      c,
                        caixa                   b,
                        movto_trans_financ_v    a
                where   b.nr_sequencia          = a.nr_seq_caixa
                and     c.nr_titulo             = a.nr_seq_titulo_receber
                and     a.nr_seq_caixa_rec      = c.nr_seq_caixa_rec
                and     exists (        select  1
                                        from    movto_trans_financ x
                                        where   x.nr_seq_lote   = a.nr_seq_lote
                                        and     x.nr_seq_caixa  = a.nr_seq_caixa
                                        and     x.nr_seq_cheque = nr_seq_cheque_ww)) alias8;
    end if;
end if;

select  count(cd_pessoa_fisica)  --OS 517971
into STRICT    qt_registro_w
from    pessoa_fisica
where   cd_pessoa_fisica = dados_contab_w.cd_pessoa_fisica;

if (qt_registro_w > 0) then
        nm_mae_pf_w :=  substr(obter_nome_mae_pf(dados_contab_w.cd_pessoa_fisica),1,255);
end if;

if (nr_seq_movto_cartao_w IS NOT NULL AND nr_seq_movto_cartao_w::text <> '') then
    begin
    ds_movto_cartao_w   := substr(obter_dados_cartao_cr( nr_seq_movto_cartao_w, 'DMT'),1,255);
    exception when others then
            ds_movto_cartao_w := '';
    end;
end if;

select  coalesce(max(ie_contab_tesouraria),'S')
into STRICT    ie_contab_tesouraria_w
from    transacao_financeira
where   nr_sequencia    = dados_contab_w.nr_seq_trans_fin;

select  CASE WHEN dados_contab_w.nr_titulo_receber=0 THEN null  ELSE dados_contab_w.nr_titulo_receber END ,
        CASE WHEN dados_contab_w.nr_titulo_pagar=0 THEN null  ELSE dados_contab_w.nr_titulo_pagar END ,
        CASE WHEN dados_contab_w.nr_seq_nota_fiscal='0' THEN null  ELSE dados_contab_w.nr_seq_nota_fiscal END ,
        CASE WHEN nr_seq_movto_trans_fin_w=0 THEN null  ELSE nr_seq_movto_trans_fin_w END ,
        CASE WHEN dados_contab_w.nr_seq_nota_fiscal=0 THEN null  ELSE dados_contab_w.nr_seq_nota_fiscal END ,
        CASE WHEN nr_doc_movto_w='0' THEN null  ELSE nr_doc_movto_w END
into STRICT    dados_contab_w.nr_titulo_receber,
        dados_contab_w.nr_titulo_pagar,
        dados_contab_w.nr_seq_nota_fiscal,
        nr_seq_movto_trans_fin_w,
        dados_contab_w.nr_seq_nota_fiscal,
        nr_doc_movto_w
;

if (coalesce(dados_contab_w.nr_seq_nota_fiscal, 0) = 0) then
    if (coalesce(dados_contab_w.nr_titulo_pagar, 0) <> 0) then
            dados_contab_w.nr_seq_nota_fiscal := substr(obter_dados_tit_pagar(dados_contab_w.nr_titulo_pagar, 'NFSEQ'),1,10);
    elsif (coalesce(dados_contab_w.nr_titulo_receber, 0) <> 0) then
            dados_contab_w.nr_seq_nota_fiscal := substr(obter_dados_titulo_receber(dados_contab_w.nr_titulo_receber, 'SN'),1,10);
    end if;
end if;

ds_atributos_w  :=      'NR_TITULO_RECEBER='        || dados_contab_w.nr_titulo_receber  || ';' ||
                        'NR_TITULO_PAGAR='          || dados_contab_w.nr_titulo_pagar    || ';' ||
                        'NR_NOTA_FISCAL='           || dados_contab_w.nr_seq_nota_fiscal || ';' ||
                        'NR_SEQ_MOVTO_TESOURARIA='  || nr_seq_movto_trans_fin_w          || ';' ||
                        'NR_SEQ_NOTA_FISCAL='       || dados_contab_w.nr_seq_nota_fiscal || ';' ||
                        'NR_DOCUMENTO='             || nr_doc_movto_w;

ctb_obter_doc_movto(    doc_p.cd_tipo_lote_contabil,
                        doc_p.nm_atributo,
                        'VR',
                        doc_p.dt_competencia,
                        null,
                        null,
                        ds_atributos_w,
                        nm_usuario_p,
                        ie_regra_w,
                        nr_documento_ww,
                        dados_contab_w.ie_origem_documento);

CALL ctb_online_pck.definir_atrib_compl(doc_p.cd_tipo_lote_contabil);
CALL ctb_online_pck.set_value_compl_hist('NR_DOCUMENTO', nr_doc_movto_w);
CALL ctb_online_pck.set_value_compl_hist('NR_ADIANTAMENTO', nr_adiant_movto_w);
CALL ctb_online_pck.set_value_compl_hist('NR_BORDERO', nr_bordero_w);
CALL ctb_online_pck.set_value_compl_hist('NR_INTERNO_CONTA', nr_interno_conta_movto_w);
CALL ctb_online_pck.set_value_compl_hist('NR_CHEQUE', nr_cheque_movto_w);
CALL ctb_online_pck.set_value_compl_hist('DS_HISTORICO', ds_hist_movto_w);
CALL ctb_online_pck.set_value_compl_hist('DS_COMPL_PF_PJ', substr(ds_compl_pf_pj_movto_w,1,240));
CALL ctb_online_pck.set_value_compl_hist('CD_HISTORICO_CAIXA', cd_hist_caixa_movto_w);
CALL ctb_online_pck.set_value_compl_hist('CD_HISTORICO', cd_historico_movto_w);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQUENCIA', nr_seq_movto_w);
CALL ctb_online_pck.set_value_compl_hist('DS_HIST_PF_PJ', ds_hist_pf_pj_w);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_TITULO_PAGAR', dados_contab_w.nr_titulo_pagar);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_TITULO_RECEBER', dados_contab_w.nr_titulo_receber);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_NOTA_FISCAL', dados_contab_w.nr_seq_nota_fiscal);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_CONV_RECEB', nr_seq_conv_receb_w);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_DEPOSITO', nr_seq_deposito_w);
CALL ctb_online_pck.set_value_compl_hist('NR_ADIANT_PAGO', nr_adiant_pago_w);
CALL ctb_online_pck.set_value_compl_hist('CD_BANCO_CHEQUE', cd_banco_cheque_w);
CALL ctb_online_pck.set_value_compl_hist('DS_BANCO_CHEQUE', ds_banco_cheque_w);
CALL ctb_online_pck.set_value_compl_hist('CD_AGENCIA_CHEQUE', cd_agencia_cheque_w);
CALL ctb_online_pck.set_value_compl_hist('NR_CONTA_CHEQUE', nr_conta_cheque_w);
CALL ctb_online_pck.set_value_compl_hist('NR_ADIANT_CHEQUE', nr_adiant_cheque_w);
CALL ctb_online_pck.set_value_compl_hist('NM_PF_CHEQUE', nm_pf_cheque_w);
CALL ctb_online_pck.set_value_compl_hist('DS_RAZAO_SOCIAL_CHEQUE', ds_razao_social_cheque_w);
CALL ctb_online_pck.set_value_compl_hist('DS_PESSOA_TITULO', ds_pessoa_titulo_w);
CALL ctb_online_pck.set_value_compl_hist('DT_TRANSACAO', dt_transacao_ww);
CALL ctb_online_pck.set_value_compl_hist('NR_NOTA_FISCAL', nr_nota_fiscal_w);
CALL ctb_online_pck.set_value_compl_hist('DS_CHEQUE_DEPOSITO', ds_cheque_deposito_w);
CALL ctb_online_pck.set_value_compl_hist('NM_PACIENTE_CHEQUE', nm_paciente_cheque_w);
CALL ctb_online_pck.set_value_compl_hist('NR_NFE', nr_nfe_imp_w);
CALL ctb_online_pck.set_value_compl_hist('NM_PACIENTE_ADIANT', nm_paciente_adiantamento_w);
CALL ctb_online_pck.set_value_compl_hist('DS_CONTA_OD', ds_conta_od_w);
CALL ctb_online_pck.set_value_compl_hist('NR_RECIBO_ADIANT', nr_recibo_w);
CALL ctb_online_pck.set_value_compl_hist('DT_VENC_ATUAL_CHEQUE', dt_venc_cheque_atual_w);
CALL ctb_online_pck.set_value_compl_hist('CD_BANCO_EXT_CHEQUE', cd_banco_ext_cheque_w);
CALL ctb_online_pck.set_value_compl_hist('NR_CHEQUE_CAIXA_REC', ds_cheques_caixa_rec_w);
CALL ctb_online_pck.set_value_compl_hist('DS_BANDEIRA_CARTAO', ds_bandeira_w);
CALL ctb_online_pck.set_value_compl_hist('DS_OBS_CARTAO', ds_obs_cartao_w);
CALL ctb_online_pck.set_value_compl_hist('DS_BANCO_OD', ds_banco_od_w);
CALL ctb_online_pck.set_value_compl_hist('DS_CAIXA', ds_caixa_w);
CALL ctb_online_pck.set_value_compl_hist('NR_RECIBO_REC', nr_recibo_rec_w);
CALL ctb_online_pck.set_value_compl_hist('DS_PESSOA_NOTA', ds_pessoa_nota_w);
CALL ctb_online_pck.set_value_compl_hist('NR_AUTORIZACAO', nr_autorizacao_w);
CALL ctb_online_pck.set_value_compl_hist('DS_ESTORNO', ds_estorno_w);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_LOTE', nr_seq_lote_w);
CALL ctb_online_pck.set_value_compl_hist('CD_PESSOA_CAIXA_RECEB', cd_pessoa_caixa_receb_w);
CALL ctb_online_pck.set_value_compl_hist('NM_PESSOA_CAIXA_RECEB', nm_pessoa_caixa_receb_w);
CALL ctb_online_pck.set_value_compl_hist('NM_PESSOA_MOVTO', nm_pessoa_movto_w);
CALL ctb_online_pck.set_value_compl_hist('DS_CAIXA_OD', ds_caixa_od_w);
CALL ctb_online_pck.set_value_compl_hist('DS_FORMA_PAGTO', ds_forma_pagto_w);
CALL ctb_online_pck.set_value_compl_hist('CD_PESSOA_FISICA', dados_contab_w.cd_pessoa_fisica);
CALL ctb_online_pck.set_value_compl_hist('NR_DOC_TIT_RECEB', nr_doc_tit_receb_w);
CALL ctb_online_pck.set_value_compl_hist('NR_DOCUMENTO_CAIXA_REC', nr_documento_caixa_rec_w);
CALL ctb_online_pck.set_value_compl_hist('NM_ESTABELECIMENTO', nm_estabelecimento_w);
CALL ctb_online_pck.set_value_compl_hist('DS_OBS_CAIXA_RECEB', ds_obs_caixa_receb_w);
CALL ctb_online_pck.set_value_compl_hist('DS_CHEQUE_CP', ds_cheque_cp_w);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_MOVTO_BCO_PEND', nr_seq_movto_bco_pend_w);
CALL ctb_online_pck.set_value_compl_hist('NR_CPF', nr_cpf_w  );
CALL ctb_online_pck.set_value_compl_hist('NR_ATENDIMENTO', nr_atendimento_w);
CALL ctb_online_pck.set_value_compl_hist('NR_NEGOCIACAO', nr_negociacao_w);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_MOVTO_PEND', nr_seq_movto_pend_w);
CALL ctb_online_pck.set_value_compl_hist('NR_CHEQUE_PAGO', nr_cheque_pago_w);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_COB_ESCRITURAL', nr_seq_cob_escritural_w);
CALL ctb_online_pck.set_value_compl_hist('DS_OBSERVACAO_CP', ds_observacao_cp_w);
CALL ctb_online_pck.set_value_compl_hist('DS_OBSERVACAO_CR', ds_observacao_cr_w);
CALL ctb_online_pck.set_value_compl_hist('NR_CPF_CHEQUE', nr_cpf_cheque_w);
CALL ctb_online_pck.set_value_compl_hist('CD_CNPJ_CHEQUE', cd_cnpj_cheque_w);
CALL ctb_online_pck.set_value_compl_hist('DS_OBS_ADIANTAMENTO', ds_obs_adiantamento_w);
CALL ctb_online_pck.set_value_compl_hist('NR_RECIBO_CHEQUE', nr_recibo_caixa_receb_w);
CALL ctb_online_pck.set_value_compl_hist('NM_MAE_PACIENTE', nm_mae_pf_w);
CALL ctb_online_pck.set_value_compl_hist('DS_MOVTO_CARTAO', ds_movto_cartao_w);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_PROTOCOLO', nr_seq_protocolo_w);
CALL ctb_online_pck.set_value_compl_hist('VL_ESPECIE', vl_especie_w);
CALL ctb_online_pck.set_value_compl_hist('VL_CHEQUE', vl_cheque_w);
CALL ctb_online_pck.set_value_compl_hist('VL_CARTAO', vl_cartao_w);
CALL ctb_online_pck.set_value_compl_hist('NM_PF_PJ_CARTAO', nm_pf_pj_cartao_w);
CALL ctb_online_pck.set_value_compl_hist('IE_NF_NFE', ie_nf_nfe_w);
CALL ctb_online_pck.set_value_compl_hist('DS_OBSERVACAO_MOVTO', ds_observacao_movto_w);
CALL ctb_online_pck.set_value_compl_hist('NM_PACIENTE', nm_paciente_atendimento_w);
CALL ctb_online_pck.set_value_compl_hist('DS_MOVTO_BANCO_PEND', ds_conta_banco_pend_w);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_RPA', nr_seq_rpa_w);
CALL ctb_online_pck.set_value_compl_hist('DS_CLASSIF_CAIXA', ds_classificacao_w);
CALL ctb_online_pck.set_value_compl_hist('CD_SERIE_NF', cd_serie_nf_w);

if (ie_contab_tesouraria_w = 'S') and (doc_p.nm_atributo not in ('VL_ESPECIE_DEPOSITO','VL_CHEQUE_DEPOSITO')) and
    ((ie_caixa_w = 'M' AND ctb_param_lote_tesouraria_w.ie_contab_monet_regra = 'N') or
    ((ie_caixa_w = 'A') and
    ((ctb_param_lote_tesouraria_w.ie_contab_monet_docto = 'S') or
    ((ctb_param_lote_tesouraria_w.ie_contab_monet_docto = 'D') and (coalesce(nr_seq_deposito_w::text, '') = '')))) or
    (ie_caixa_w = 'T' AND ctb_param_lote_tesouraria_w.ie_contab_transf_caixa = 'S')) then
    begin

    if (coalesce(cd_historico_w::text, '') = '') then
        null;
        CALL wheb_mensagem_pck.exibir_mensagem_abort(188207, substr( 'NR_SEQ_TRANS_FIN=' || dados_contab_w.nr_seq_trans_fin || ';' || 'VL_TRANSACAO=' || doc_p.vl_movimento,1,2000));
        /*'Erro Gerar_Contab Conta Caixa ' ||
                'Esta faltando o historico. Cadastre nos parametros Tesouraria ' ||
                nr_documento_w ||  vl_transacao_w);*/
    end if;

    cd_conta_contab_movto_w := dados_contab_w.cd_conta_contabil;

    if (ie_caixa_w in ('A', 'T')) then                                 -- Edgar 31/10/2006 os 43549 e 43684
        cd_conta_contab_movto_w := cd_conta_caixa_w;
    end if;

    if (coalesce(cd_conta_contab_movto_w::text, '') = '') then
        null;
        CALL wheb_mensagem_pck.exibir_mensagem_abort(188208,'nr_seq_caixa='||dados_contab_w.nr_seq_caixa);
        /*'Erro Gerar_Contab Conta Caixa ' ||
                'Esta faltando a conta contabil no cadastro do Caixa ' ||
                nr_documento_w ||  vl_transacao_w);*/
    end if;

    /*CRIAR VARIAVEL PARA CTB_MOVIMENTO*/

    ctb_movimento_doc_w.cd_estabelecimento          := doc_p.cd_estabelecimento;
    ctb_movimento_doc_w.cd_tipo_lote_contabil       := doc_p.cd_tipo_lote_contabil;
    --ctb_movimento_doc_w.nr_lote_contabil            := dados_contab_w.nr_lote_contabil;
    ctb_movimento_doc_w.cd_historico                := cd_historico_w;
    ctb_movimento_doc_w.dt_movimento                := doc_p.dt_competencia;
    ctb_movimento_doc_w.vl_movimento                := doc_p.vl_movimento;
    ctb_movimento_doc_w.nr_seq_agrupamento          := dados_contab_w.nr_seq_agrupamento;
    ctb_movimento_doc_w.cd_centro_custo             := null;
    ctb_movimento_doc_w.nr_seq_trans_fin            := dados_contab_w.nr_seq_trans_fin;
    ctb_movimento_doc_w.nr_documento                := nr_documento_ww;
    ctb_movimento_doc_w.cd_pessoa_fisica            := dados_contab_w.cd_pessoa_fisica;
    ctb_movimento_doc_w.cd_cnpj                     := dados_contab_w.cd_cnpj;
    ctb_movimento_doc_w.ie_transitorio              := 'N';
    ctb_movimento_doc_w.ie_origem_documento         := dados_contab_w.ie_origem_documento;
    ctb_movimento_doc_w.nm_tabela                   := doc_p.nm_tabela;
    ctb_movimento_doc_w.nr_seq_tab_orig             := nr_seq_tab_orig_w;
    ctb_movimento_doc_w.nr_seq_info                 := doc_p.nr_seq_info;
    ctb_movimento_doc_w.nm_atributo                 := doc_p.nm_atributo;

    if (ie_debito_credito_w = 'C') then
        ctb_movimento_doc_w.cd_conta_credito    := cd_conta_contab_movto_w;
    else
            ctb_movimento_doc_w.cd_conta_debito     := cd_conta_contab_movto_w;
    end if;

    /*geracao direta de movimentos na conta do caixa*/

    ctb_movimento_doc_w := ctb_online_pck.ctb_gravar_movto(ctb_movimento_doc_w, doc_p.nm_usuario);
    end;
end if;

if (ie_caixa_w = 'D') or (ie_caixa_w = 'A') or (ie_caixa_w = 'T') or           -- Edgar 31/10/2006 os 43549 e 43684
    (ie_caixa_w = 'M' AND ctb_param_lote_tesouraria_w.ie_contab_monet_regra = 'S') and (doc_p.nm_atributo <> 'VL_REC_PLS') then

    if (ie_permite_estab_dif_w <> 'PCCT') then
        dados_contab_w.cd_estab_movto   := null;
    end if;

    if (coalesce(dados_contab_w.nr_seq_conta_banco,0) = 0) then
        if (nr_seq_deposito_w IS NOT NULL AND nr_seq_deposito_w::text <> '') then
            select  max(nr_conta)
            into STRICT    dados_contab_w.nr_seq_conta_banco
            from    deposito
            where   nr_sequencia    = nr_seq_deposito_w;
        end if;
    end if;

    if (coalesce(dados_contab_w.nr_titulo_receber,0) <> 0) then
        select  max(ie_origem_titulo)
        into STRICT    dados_contab_w.ie_origem_tit_rec
        from    titulo_receber
        where   nr_titulo       = dados_contab_w.nr_titulo_receber;
    end if;

    dados_contab_w.ie_origem_documento      := null;
    nr_documento_ww                         := null;
    ds_atributos_w                          := null;

    select  CASE WHEN dados_contab_w.nr_titulo_receber=0 THEN null  ELSE dados_contab_w.nr_titulo_receber END ,
            CASE WHEN dados_contab_w.nr_titulo_pagar=0 THEN null  ELSE dados_contab_w.nr_titulo_pagar END ,
            CASE WHEN dados_contab_w.nr_seq_nota_fiscal='0' THEN null  ELSE dados_contab_w.nr_seq_nota_fiscal END ,
            CASE WHEN nr_seq_movto_trans_fin_w=0 THEN null  ELSE nr_seq_movto_trans_fin_w END ,
            CASE WHEN dados_contab_w.nr_seq_nota_fiscal=0 THEN null  ELSE dados_contab_w.nr_seq_nota_fiscal END ,
            CASE WHEN nr_doc_movto_w='0' THEN null  ELSE nr_doc_movto_w END
    into STRICT    dados_contab_w.nr_titulo_receber,
            dados_contab_w.nr_titulo_pagar,
            dados_contab_w.nr_seq_nota_fiscal,
            nr_seq_movto_trans_fin_w,
            dados_contab_w.nr_seq_nota_fiscal,
            nr_doc_movto_w
;

    if (coalesce(dados_contab_w.nr_seq_nota_fiscal, 0) = 0) then
        if (coalesce(dados_contab_w.nr_titulo_pagar, 0) <> 0) then
                dados_contab_w.nr_seq_nota_fiscal    := substr(obter_dados_tit_pagar(dados_contab_w.nr_titulo_pagar, 'NFSEQ'),1,10);

        elsif (coalesce(dados_contab_w.nr_titulo_receber, 0) <> 0) then
                dados_contab_w.nr_seq_nota_fiscal    := substr(obter_dados_titulo_receber(dados_contab_w.nr_titulo_receber, 'SN'),1,10);
        end if;
    end if;

    ds_atributos_w  :=      'NR_TITULO_RECEBER='        || dados_contab_w.nr_titulo_receber  || ';' ||
                            'NR_TITULO_PAGAR='          || dados_contab_w.nr_titulo_pagar    || ';' ||
                            'NR_NOTA_FISCAL='           || dados_contab_w.nr_seq_nota_fiscal || ';' ||
                            'NR_SEQ_MOVTO_TESOURARIA='  || nr_seq_movto_trans_fin_w          || ';' ||
                            'NR_SEQ_NOTA_FISCAL='       || dados_contab_w.nr_seq_nota_fiscal || ';' ||
                            'NR_DOCUMENTO='             || nr_doc_movto_w;

    ctb_obter_doc_movto(    doc_p.cd_tipo_lote_contabil,
                            doc_p.nm_atributo,
                            'VR',
                            doc_p.dt_competencia,
                            null,
                            null,
                            ds_atributos_w,
                            nm_usuario_p,
                            ie_regra_w,
                            nr_documento_ww,
                            dados_contab_w.ie_origem_documento);

    dados_contab_w.dt_transacao     := doc_p.dt_competencia;
    dados_contab_w.nr_seq_banco_od  := dados_contab_w.nr_seq_conta_banco;
    dados_contab_w.nr_doc_movto     := nr_documento_ww;
    dados_contab_w.nm_tabela        := doc_p.nm_tabela;
    dados_contab_w.nm_atributo      := doc_p.nm_atributo;

    ctb_contab_onl_lote_fin_pck.contabiliza_trans_financ(dados_contab_w, nm_usuario_p);
    select  coalesce(CASE WHEN coalesce(dados_contab_w.nr_titulo_pagar,0)=0 THEN null  ELSE dados_contab_w.nr_titulo_pagar END ,
            CASE WHEN coalesce(dados_contab_w.nr_titulo_receber,0)=0 THEN null  ELSE dados_contab_w.nr_titulo_receber END )
    into STRICT    nr_titulo_w
;

    ctb_movimento_w := null;

    --ctb_movimento_w.nr_lote_contabil    := dados_contab_w.nr_lote_contabil;
    ctb_movimento_w.cd_historico        := cd_historico_ct_w;
    ctb_movimento_w.nr_documento        := nr_titulo_w;
    ctb_movimento_w.dt_movimento        := doc_p.dt_competencia;
    ctb_movimento_w.vl_movimento        := doc_p.vl_movimento;
    ctb_movimento_w.ie_origem_documento := dados_contab_w.ie_origem_documento;
    ctb_movimento_w.nr_seq_agrupamento  := dados_contab_w.nr_seq_agrupamento;
	ctb_movimento_w.nr_seq_proj_rec     := nr_seq_proj_rec_w;

    if ((ctb_param_lote_tesouraria_w.ie_contab_cr = 'S') or (ctb_param_lote_tesouraria_w.ie_contab_cp = 'S')) and (ie_permite_estab_dif_w = 'PCCT') and (coalesce(dados_contab_w.cd_estab_movto,0) <> 0) and (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') and (cd_conta_transitoria_w IS NOT NULL AND cd_conta_transitoria_w::text <> '') and (dados_contab_w.cd_estab_movto <> cd_estabelecimento_w) then

        /* GRAVAR DEBITO */

        ctb_movimento_w.ds_compl_historico  := nr_titulo_w;
        ctb_movimento_w.cd_conta_debito     := cd_conta_transitoria_w;
        ctb_movimento_w.cd_estabelecimento  := cd_estabelecimento_w;
        ctb_movimento_w := ctb_online_pck.ctb_gerar_movto_conta_transit(ctb_movimento_w, nm_usuario_p);

        /* GRAVAR CREDITO */

        ctb_movimento_w.cd_conta_debito     := null;
        ctb_movimento_w.cd_conta_credito    := cd_conta_transitoria_w;
        ctb_movimento_w.cd_estabelecimento  := dados_contab_w.cd_estab_movto;
        ctb_movimento_w := ctb_online_pck.ctb_gerar_movto_conta_transit(ctb_movimento_w, nm_usuario_p);
    end if;

    if (doc_p.nm_atributo = 'VL_TRANSACAO') and (ie_permite_estab_dif_w = 'PCCT') and (cd_conta_transitoria_w IS NOT NULL AND cd_conta_transitoria_w::text <> '') and (dados_contab_w.nr_seq_caixa_od IS NOT NULL AND dados_contab_w.nr_seq_caixa_od::text <> '') and (cd_estab_caixa_od_w <> cd_estabelecimento_w) then

        ctb_movimento_w.cd_conta_debito     := null;
        ctb_movimento_w.cd_conta_credito    := null;
        ctb_movimento_w.cd_estabelecimento  := cd_estab_caixa_od_w;
        ctb_movimento_w.nr_documento        := null;

        if (ie_saldo_caixa_w = 'E') then /* Entrada do caixa credita transitoria e debita caixa*/
                ctb_movimento_w.cd_conta_credito := cd_conta_transitoria_w;
        elsif (ie_saldo_caixa_w = 'S') then /* Saida do caixa debita transitoria e credita caixa*/
                ctb_movimento_w.cd_conta_debito  := cd_conta_transitoria_w;
        end if;

            ctb_movimento_w := ctb_online_pck.ctb_gerar_movto_conta_transit(ctb_movimento_w, nm_usuario_p);
    end if;
else
     dados_contab_w.doc.ds_inconsistencia := coalesce(wheb_mensagem_pck.get_texto(1077757),'Documento nao contabilizado. Verifique o campo Caixa no cadastro da Transacao Financeira ou a opcao Contabiliza transacao monetaria pela Regra');

end if;

doc_p  := dados_contab_w.doc;

if (coalesce(doc_p.ds_inconsistencia, 'X') = 'X') then
    update  titulo_receber_liq
    set     nr_lote_contabil    = doc_p.nr_lote_contabil
    where   nr_titulo           = doc_p.nr_documento
    and     nr_sequencia        = doc_p.nr_seq_doc_compl
    and     doc_p.nm_tabela     = 'TITULO_RECEBER_LIQ';

    update  movto_cartao_cr_parcela
    set     nr_lote_contabil    = doc_p.nr_lote_contabil
    where   nr_seq_movto        = doc_p.nr_documento
    and     nr_sequencia        = doc_p.nr_seq_doc_compl
    and     doc_p.nm_tabela     = 'MOVTO_CARTAO_CR_PARCELA';

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_contab_onl_tesouraria ( doc_p INOUT ctb_documento, nm_usuario_p text) FROM PUBLIC;

