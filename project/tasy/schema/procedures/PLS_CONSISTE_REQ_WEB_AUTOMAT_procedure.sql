-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consiste_req_web_automat ( qt_hora_solicitacao_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade: 
Consistir dentro do período informado, todas as requisições solicitadas pelo Portal web que não foram finalizadas. 
É chamada pela job JOB PLS_CONSISTE_REQ_WEB_AUTOMAT_J. 
------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[ x ] Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [ ] Relatórios [ ] Outros: 
 ------------------------------------------------------------------------------------------------------------------ 
Pontos de atenção: 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 
 
dt_lim_solicitacao_w		timestamp;
ds_historico_w			varchar(4000);	
nr_seq_requisicao_w		pls_requisicao.nr_sequencia%type;

C01 CURSOR FOR 
	SELECT	a.nr_sequencia, 
		a.cd_estabelecimento 
	from	pls_requisicao a 
	where	a.ie_estagio	= 1	 	 
	and	coalesce(a.ie_req_web_finalizada, 'N')	= 'N' 
	and	a.ie_tipo_processo	= 'P' 
	and	a.dt_atualizacao_nrec 	< dt_lim_solicitacao_w 
	and	exists (	SELECT	1 qt_item 
			from	pls_requisicao_proc 
			where	nr_seq_requisicao	= a.nr_sequencia 
			
union all
 
			select	1 qt_item 
			from	pls_requisicao_mat 
			where	nr_seq_requisicao	= a.nr_sequencia) 
	order 	by 1;

 
BEGIN 
if (qt_hora_solicitacao_p > 0) then 
	dt_lim_solicitacao_w	:= (clock_timestamp() - (qt_hora_solicitacao_p/24));
	begin 
	for C01_w in C01 loop 
		begin 
		nr_seq_requisicao_w	:= C01_w.nr_sequencia;
		CALL pls_consistir_requisicao(nr_seq_requisicao_w, C01_w.cd_estabelecimento, nm_usuario_p);
		ds_historico_w	:= substr('Requisição '||C01_w.nr_sequencia||' consistida automaticamente pela JOB ''PLS_CONSISTE_REQ_WEB_AUTOMAT_J'' em '||to_char(clock_timestamp(),'dd/mm/yyyy hh24:mi:ss'),1,4000);
		CALL pls_requisicao_gravar_hist(nr_seq_requisicao_w,'L',ds_historico_w,'',nm_usuario_p);
		end;
	end loop;
	exception 
	when others then 
		ds_historico_w	:= substr('Não foi possível consistir automaticamente a requisição.'||chr(13)|| 
					'Erro: ' || sqlerrm,1,4000);		
		CALL pls_requisicao_gravar_hist(nr_seq_requisicao_w,'L',ds_historico_w,'',nm_usuario_p);
	end;	
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consiste_req_web_automat ( qt_hora_solicitacao_p bigint, nm_usuario_p text) FROM PUBLIC;

