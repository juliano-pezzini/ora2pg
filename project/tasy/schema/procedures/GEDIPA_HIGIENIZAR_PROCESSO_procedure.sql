-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gedipa_higienizar_processo ( cd_estabelecimento_p bigint, cd_perfil_p bigint, nr_processo_p bigint, nr_seq_area_p bigint, ie_higienizar_p text, nm_usuario_p text) AS $body$
DECLARE

				 
nr_sequencia_w				bigint;
ie_processo_sem_area_w		varchar(10);
ie_preparo_w				adep_area_prep.ie_preparo%type := 'S';
ie_conferencia_w			adep_area_prep.ie_conferencia%type := 'S';


BEGIN 
 
ie_processo_sem_area_w := obter_param_usuario(3112, 23, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_processo_sem_area_w);
 
if (nr_processo_p IS NOT NULL AND nr_processo_p::text <> '') and (nr_seq_area_p IS NOT NULL AND nr_seq_area_p::text <> '') and 
	((nr_seq_area_p	> 0) or (coalesce(ie_processo_sem_area_w,'N') = 'S')) and (ie_higienizar_p IS NOT NULL AND ie_higienizar_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then 
	 
	if (ie_higienizar_p = 'S') then 
	 
		if (coalesce(nr_seq_area_p,0) = 0) then 
			update	adep_processo_area 
			set	dt_higienizacao		= clock_timestamp(), 
				nm_usuario_higienizacao	= nm_usuario_p 
			where	nr_seq_processo		= nr_processo_p 
			and	coalesce(dt_higienizacao::text, '') = '' 
			and	coalesce(nm_usuario_higienizacao::text, '') = '';		
		else 
			update	adep_processo_area 
			set	dt_higienizacao		= clock_timestamp(), 
				nm_usuario_higienizacao	= nm_usuario_p 
			where	nr_seq_processo		= nr_processo_p 
			and	nr_seq_area_prep	= nr_seq_area_p 
			and	coalesce(dt_higienizacao::text, '') = '' 
			and	coalesce(nm_usuario_higienizacao::text, '') = '';
		end if;
 
		select	max(coalesce(ie_preparo,'S')), 
				max(coalesce(ie_conferencia,'S')) 
		into STRICT	ie_preparo_w, 
				ie_conferencia_w 
		from	adep_area_prep 
		where	nr_sequencia	= nr_seq_area_p;
						 
		if (ie_preparo_w = 'S') then		 
			CALL atualiza_status_processo_adep(nr_processo_p, nr_seq_area_p, 'G', 'H', clock_timestamp(), nm_usuario_p);
		else 
			update	adep_processo 
			set		ie_status_processo	= 'P', 
					dt_preparo			= clock_timestamp(), 
					nm_usuario_preparo	= nm_usuario_p, 
					ie_local_preparo	= 'GEDIPA'					 
			where	nr_sequencia		= nr_processo_p;
			 
			if (ie_conferencia_w = 'N') then 
				CALL atualiza_status_processo_adep(nr_processo_p, nr_seq_area_p, 'G', 'E', clock_timestamp(), nm_usuario_p);				
			end if;
		end if;
 
	else 
		if (coalesce(nr_seq_area_p,0) = 0) then 
			update	adep_processo_area 
			set	dt_higienizacao		 = NULL, 
				nm_usuario_higienizacao	 = NULL 
			where	nr_seq_processo		= nr_processo_p 
			and	(dt_higienizacao IS NOT NULL AND dt_higienizacao::text <> '') 
			and	(nm_usuario_higienizacao IS NOT NULL AND nm_usuario_higienizacao::text <> '');
		else		 
			update	adep_processo_area 
			set	dt_higienizacao		 = NULL, 
				nm_usuario_higienizacao	 = NULL 
			where	nr_seq_processo		= nr_processo_p 
			and	nr_seq_area_prep	= nr_seq_area_p 
			and	(dt_higienizacao IS NOT NULL AND dt_higienizacao::text <> '') 
			and	(nm_usuario_higienizacao IS NOT NULL AND nm_usuario_higienizacao::text <> '');
		end if;
		--atualiza_status_processo_adep(nr_processo_p, nr_seq_area_p, 'G', 'RH', sysdate, nm_usuario_p); 
	 
	end if;
	 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gedipa_higienizar_processo ( cd_estabelecimento_p bigint, cd_perfil_p bigint, nr_processo_p bigint, nr_seq_area_p bigint, ie_higienizar_p text, nm_usuario_p text) FROM PUBLIC;

