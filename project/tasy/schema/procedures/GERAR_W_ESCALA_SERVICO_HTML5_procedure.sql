-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_escala_servico_html5 ( nm_usuario_p text, ie_parametro_p text, cd_estabelecimento_p bigint, cd_mes_p bigint, cd_ano_p bigint, nr_seq_classif_p bigint, ie_controla_perfil_p text, ie_html5_p text default 'N') AS $body$
DECLARE

 
cd_pessoa_fisica_w		varchar(20);
ds_periodo_w			varchar(30);
nr_seq_escala_w			bigint;
ds_cor_padrao_w			varchar(20);
cd_dia_semana_w			smallint	:= 0;
ie_pertence_w			varchar(30);
nr_seq_classif_w		bigint;
qt_dia_w			bigint;
dt_escala_w			timestamp;
nr_sequencia_w			bigint;
ds_cor_w			varchar(10);
qt_count_w			bigint;
ds_comando_w			varchar(255);

nm_pessoa_fisica_W		varchar(255);
ds_setor_w			varchar(255);
ds_classif_w			varchar(255);
ds_cargo_w			varchar(255);
hr_inicio_w			timestamp;
hr_fim_w			timestamp;
qt_existe_w			bigint;

nr_seq_escala_temp_w		bigint	:=	0;
cd_pessoa_fisica_temp_w		varchar(20)	:=	'X';
last_day_w			bigint;

ie_mostra_escala_w		varchar(1) 	:= 	'S';

 
c01 CURSOR FOR 
	SELECT distinct f.cd_pessoa_fisica, 
		e.nr_sequencia nr_seq_escala, 
		c.nr_sequencia nr_seq_classif, 
		d.dt_inicio, 
		d.dt_fim 
	from	escala_diaria d, 
		escala_grupo g, 
		escala_classif c, 
		escala	e, 
		escala_diaria_adic f 
	where	c.nr_sequencia = g.nr_seq_classif 
	and	g.nr_sequencia = e.nr_seq_grupo 
	and	e.nr_sequencia = d.nr_seq_escala 
	and	f.nr_seq_escala_diaria = d.nr_sequencia 
	and   c.nr_sequencia = CASE WHEN nr_seq_classif_p=0 THEN c.nr_sequencia  ELSE nr_seq_classif_p END  
	and	((c.ie_tipo_escala  ('S','L')) or (coalesce(e.nr_sequencia::text, '') = '')) 
	and   pkg_date_utils.extract_field(d.dt_inicio, 'MONTH') = cd_mes_p 
	and   pkg_date_utils.extract_field(d.dt_inicio, 'YEAR') = cd_ano_p 
	order by e.nr_sequencia;


BEGIN 
 
if (ie_html5_p = 'S') then 
	select	'0' 
	into STRICT	ds_cor_padrao_w 
	;
else 
	select	max(ds_cor_fundo) 
	into STRICT	ds_cor_padrao_w 
	from	tasy_padrao_cor 
	where	nr_sequencia = 2072;
 
end if;
 
 
delete 	FROM w_escala_servico 
where	nm_usuario = nm_usuario_p;
 
open C01;
loop 
fetch C01 into 
	cd_pessoa_fisica_w, 
	nr_seq_escala_w, 
	nr_seq_classif_w, 
	hr_inicio_w, 
	hr_fim_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
 
	if (ie_controla_perfil_p = 'S') then 
		ie_mostra_escala_w := obter_se_mostra_escala(nm_usuario_p,nr_seq_escala_w);
	end if;
 
	if (ie_mostra_escala_w = 'S') then 
		qt_dia_w := 1;
		 
		last_day_w := pkg_date_utils.extract_field(pkg_date_utils.end_of(pkg_date_utils.get_DateTime(cd_ano_p, cd_mes_p, 1), 'MONTH'), 'DAY');
		 
		while(qt_dia_w <= last_day_w) loop 
		begin 
 
		ds_cor_w := '';
		-- montar uma data com o dia do while, + mês e ano do parâmetro 
		dt_escala_w := pkg_date_utils.get_DateTime(cd_ano_p, cd_mes_p, qt_dia_w);
 
		cd_dia_semana_w := pkg_date_utils.get_WeekDay(dt_escala_w);
		 
		if (ie_parametro_p = 'S') and 
			((pkg_date_utils.IS_BUSINESS_DAY(dt_escala_w) = 0) or (obter_se_feriado(cd_estabelecimento_p, dt_escala_w) > 0)) then 
			ds_cor_w := ds_cor_padrao_w;
		end if;
 
		select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'X' END  
		into STRICT	ie_pertence_w 
		from	escala_diaria d, 
			escala_grupo g, 
			escala_classif c, 
			escala	e, 
			escala_diaria_adic f 
		where	c.nr_sequencia = g.nr_seq_classif 
		and	g.nr_sequencia = e.nr_seq_grupo 
		and	e.nr_sequencia = d.nr_seq_escala 
		and	f.nr_seq_escala_diaria = d.nr_sequencia 
		and   obter_tipo_classif_escala(e.nr_sequencia) in ('S','L') 
		and	trunc(dt_inicio) = dt_escala_w 
		and	f.cd_pessoa_fisica = cd_pessoa_fisica_w 
		and	e.nr_sequencia = nr_seq_escala_w 
		and 	pkg_date_utils.get_Time(pkg_date_utils.extract_field(d.dt_inicio, 'HOUR'), pkg_date_utils.extract_field(d.dt_inicio, 'MINUTE')) = pkg_date_utils.get_Time(pkg_date_utils.extract_field(hr_inicio_w, 'HOUR'), pkg_date_utils.extract_field(hr_inicio_w, 'MINUTE')) 
		and 	pkg_date_utils.get_Time(pkg_date_utils.extract_field(d.dt_fim, 'HOUR'), pkg_date_utils.extract_field(d.dt_fim, 'MINUTE')) = pkg_date_utils.get_Time(pkg_date_utils.extract_field(hr_fim_w, 'HOUR'), pkg_date_utils.extract_field(hr_fim_w, 'MINUTE')) 
		and	not exists (SELECT 	1 
				  from	escala_afastamento_prof a, 
						motivo_afast_escala b 
				  where	a.nr_seq_motivo_afast = b.nr_sequencia 
				  and		a.cd_profissional = cd_pessoa_fisica_w 
				  and		((a.nr_seq_escala = nr_seq_escala_w) or (coalesce(a.nr_seq_escala::text, '') = '')) 
				  and		dt_escala_w between pkg_date_utils.start_of(a.dt_inicio, 'DD') and pkg_date_utils.end_of(a.dt_final, 'DAY'));
				  
 
		if (ie_pertence_w = 'N') then 
 
			if (ie_html5_p = 'S') then 
				begin 
					select	CASE WHEN count(*)=0 THEN ''  ELSE to_char(b.nr_sequencia) END  
					into STRICT	ds_cor_w 
					from	escala_afastamento_prof a, 
						motivo_afast_escala b 
					where	a.nr_seq_motivo_afast = b.nr_sequencia 
					and	a.cd_profissional = cd_pessoa_fisica_w 
					and	((a.nr_seq_escala = nr_seq_escala_w) or (coalesce(a.nr_seq_escala::text, '') = '')) 
					and	dt_escala_w between pkg_date_utils.start_of(a.dt_inicio, 'DD') and pkg_date_utils.end_of(a.dt_final, 'DAY') 
					group by b.nr_sequencia;
				exception 
					when others then 
					ie_pertence_w := '';
				end;
			else			 
				begin 
					select	CASE WHEN count(*)=0 THEN ''  ELSE b.ds_cor END  
					into STRICT	ds_cor_w 
					from	escala_afastamento_prof a, 
						motivo_afast_escala b 
					where	a.nr_seq_motivo_afast = b.nr_sequencia 
					and	a.cd_profissional = cd_pessoa_fisica_w 
					and	((a.nr_seq_escala = nr_seq_escala_w) or (coalesce(a.nr_seq_escala::text, '') = '')) 
					and	dt_escala_w between pkg_date_utils.start_of(a.dt_inicio, 'DD') and pkg_date_utils.end_of(a.dt_final, 'DAY') 
					group by b.ds_cor;
				exception 
					when others then 
					ie_pertence_w := '';
				end;
			end if;
		end if;
 
 
		if (nr_seq_escala_w <> nr_seq_escala_temp_w) then 
			ds_setor_w := substr(obter_setores_escala(nr_seq_escala_w),1,255);
 
			select	substr(CASE WHEN obter_tipo_classif_escala(nr_seq_escala_w)='S' THEN  PERFORM obter_desc_expressao(630808) WHEN obter_tipo_classif_escala(nr_seq_escala_w)='L' THEN  PERFORM obter_desc_expressao(736647) END ,1,50) 
			into STRICT	ds_classif_w 
			;
		end if;
 
		nr_seq_escala_temp_w := nr_seq_escala_w;
 
		if (cd_pessoa_fisica_w <> cd_pessoa_fisica_temp_w) then 
			select	substr(max(obter_nome_pf(cd_pessoa_fisica)),1,100) 
			into STRICT	nm_pessoa_fisica_W 
			from	PESSOA_FISICA 
			where	CD_PESSOA_FISICA = cd_pessoa_fisica_w;
			 
			ds_cargo_w := substr(obter_dados_pf(cd_pessoa_fisica_w,'CR'),1,90);
		end if;
 
		cd_pessoa_fisica_temp_w := cd_pessoa_fisica_w;
 
		select 	count(*) 
		into STRICT	qt_count_w 
		from 	w_escala_servico 
		where 	cd_pessoa_fisica = cd_pessoa_fisica_w 
		and	nr_seq_escala = nr_seq_escala_w 
		and	nr_seq_classif = nr_seq_classif_w		 
		and	hr_inicio_date = pkg_date_utils.get_Time(hr_inicio_date, pkg_date_utils.extract_field(hr_inicio_w, 'HOUR'), pkg_date_utils.extract_field(hr_inicio_w, 'MINUTE')) 
		and	hr_fim_date = pkg_date_utils.get_Time(hr_fim_date, pkg_date_utils.extract_field(hr_fim_w, 'HOUR'), pkg_date_utils.extract_field(hr_fim_w, 'MINUTE'))		 
		and	nm_usuario = nm_usuario_p;
 
		if (qt_count_w = 0) then 
				begin 
				insert into w_escala_servico( 
						nr_sequencia, 
						dt_mes, 
						dt_ano, 
						nr_seq_classif, 
						nr_seq_escala, 
						cd_pessoa_fisica, 
						NM_PROFISSIONAL, 
						DS_SETOR, 
						DS_TIPO_ESCALA, 
						DS_CARGO, 
						ds_periodo, 
						nm_usuario, 
						dia1, 
						dia2, 
						dia3, 
						dia4, 
						dia5, 
						dia6, 
						dia7, 
						dia8, 
						dia9, 
						dia10, 
						dia11, 
						dia12, 
						dia13, 
						dia14, 
						dia15, 
						dia16, 
						dia17, 
						dia18, 
						dia19, 
						dia20, 
						dia21, 
						dia22, 
						dia23, 
						dia24, 
						dia25, 
						dia26, 
						dia27, 
						dia28, 
						dia29, 
						dia30, 
						dia31, 
						cor1, 
						cor2, 
						cor3, 
						cor4, 
						cor5, 
						cor6, 
						cor7, 
						cor8, 
						cor9, 
						cor10, 
						cor11, 
						cor12, 
						cor13, 
						cor14, 
						cor15, 
						cor16, 
						cor17, 
						cor18, 
						cor19, 
						cor20, 
						cor21, 
						cor22, 
						cor23, 
						cor24, 
						cor25, 
						cor26, 
						cor27, 
						cor28, 
						cor29, 
						cor30, 
						cor31, 
						hr_inicio_date, 
						hr_fim_date) 
						values ( 
						nextval('w_escala_servico_seq'), 
--						nr_sequencia_w, 
						cd_mes_p, 
						cd_ano_p, 
						nr_seq_classif_w, 
						nr_seq_escala_w, 
						cd_pessoa_fisica_w, 
						nm_pessoa_fisica_W, 
						ds_setor_w, 
						ds_classif_w, 
						ds_cargo_w, 
						ds_periodo_w, 
						nm_usuario_p, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ie_pertence_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						ds_cor_w, 
						hr_inicio_w, 
						hr_fim_w);
				end;
			else 
				begin 
				 
				 
				ds_comando_w	:=	' update w_escala_servico ' || 
							' set dia' || qt_dia_w || ' = ' || chr(39)||ie_pertence_w||chr(39) || 
							'   ,cor' || qt_dia_w || ' = '|| chr(39)||ds_cor_w||chr(39)    || 
							' where cd_pessoa_fisica = '|| cd_pessoa_fisica_w || 
							' and nr_seq_escala = ' || nr_seq_escala_w || 
							' and nr_seq_classif = ' || nr_seq_classif_w || 
							' and hr_inicio_date = to_date(' || to_char(hr_inicio_w, 'yyyy-mm-dd hh24:mi:ss') || ', ''yyyy-mm-dd hh24:mi:ss)'' ' || 
							' and hr_fim_date  = to_date(' || to_char(hr_fim_w, 'yyyy-mm-dd hh24:mi:ss') || ', ''yyyy-mm-dd hh24:mi:ss)'' ';
 
				CALL exec_sql_dinamico('TASY', ds_comando_w);
				end;
			end if;
 
		qt_dia_w	:= qt_dia_w + 1;
		end;
		end loop;
	end if;
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_escala_servico_html5 ( nm_usuario_p text, ie_parametro_p text, cd_estabelecimento_p bigint, cd_mes_p bigint, cd_ano_p bigint, nr_seq_classif_p bigint, ie_controla_perfil_p text, ie_html5_p text default 'N') FROM PUBLIC;

