-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_prescricao_item ( nr_prescricao_p bigint, cd_setor_atendimento_p bigint, cd_perfil_p bigint, nm_usuario_p text) AS $body$
DECLARE


ie_tipo_item_w				varchar(15);
ie_momento_lote_w			varchar(15);
dt_lib_medico_w				timestamp;
dt_lib_enf_w				timestamp;
ie_lib_medico_w				varchar(1);
ie_lib_enfermagem_w			varchar(1);
ie_lib_farmacia_w			varchar(1);
ie_lib_farm_w				varchar(1);
qt_dieta_w					bigint;
nr_seq_regra_w				bigint;
cd_material_w				integer;
cont_w						bigint;
nr_sequencia_w				bigint;
ie_associado_w				varchar(1);
ie_acm_w					varchar(1);
ie_se_necessario_w			varchar(1);
ie_dose_espec_w				varchar(1);
ie_agora_w					varchar(1);
ie_precisa_liberacao_w		varchar(1);
cd_intervalo_w				varchar(7);
ie_checar_automatico_w		varchar(1);
ds_lista_liberados_w		varchar(255);
cd_setor_atendimento_w		integer;
nr_seq_kit_w				bigint;
cd_estabelecimento_w		smallint;
ie_lib_assoc_proc_w			varchar(1);
ie_motivo_prescricao_w		varchar(5);
ie_lote_pos_lib_w			varchar(1);
ie_quimio_w					varchar(1);
ie_precisa_lib_proc_item_w	varchar(1);
ie_entrou_w					boolean	:= false;
nr_seq_proc_interno_w		prescr_procedimento.nr_seq_proc_interno%type;

ie_info_rastre_prescr_w		varchar(1);
ds_alteracao_rastre_w		varchar(1800);
ds_alteracao_rastre_item_w	varchar(1800);

c01 CURSOR FOR
SELECT	ie_momento_lote,
	ie_tipo_item,
	nr_sequencia,
	cd_setor_atendimento,
	ie_associado
from	regra_disp_lote_farm
where	((ie_motivo_prescricao = ie_motivo_prescricao_w) or (coalesce(ie_motivo_prescricao::text, '') = ''))
and		((clock_timestamp() between pkg_date_utils.get_DateTime(clock_timestamp(), coalesce(dt_hora_inicio,clock_timestamp())) and
						  pkg_date_utils.get_DateTime(clock_timestamp(), coalesce(dt_hora_fim,clock_timestamp()))) or ((dt_hora_fim IS NOT NULL AND dt_hora_fim::text <> '') and
		  dt_hora_fim < coalesce(dt_hora_inicio,clock_timestamp()) and (clock_timestamp() between pkg_date_utils.get_DateTime(clock_timestamp(), coalesce(dt_hora_inicio,clock_timestamp())) and
						   pkg_date_utils.get_DateTime(clock_timestamp() + interval '1 days', coalesce(dt_hora_fim,clock_timestamp())))))
and	coalesce(cd_setor_atendimento,cd_setor_atendimento_p)	= cd_setor_atendimento_p
and	pkg_date_utils.start_of(clock_timestamp(),'DD',0) between pkg_date_utils.start_of(dt_inicio_vigencia,'DD',0) and pkg_date_utils.start_of(coalesce(dt_fim_vigencia,clock_timestamp()),'DD', 0)
and	(ie_tipo_item IS NOT NULL AND ie_tipo_item::text <> '')
and	cd_estabelecimento	= cd_estabelecimento_w
and	ie_situacao = 'A'
and 	((ie_quimio_w <> 'S' and coalesce(ie_quimioterapicas,'N') <> 'S') or (ie_quimio_w = 'S'))
order by 	CASE WHEN ie_quimioterapicas='S' THEN 'A'  ELSE CASE WHEN ie_quimioterapicas='N' THEN 'C'  ELSE 'B' END  END ,
		coalesce(cd_setor_atendimento,999999),
		coalesce(ie_motivo_prescricao,9999);

c02 CURSOR FOR
SELECT	nr_sequencia,
	cd_material,
	cd_intervalo,
	ie_acm,
	ie_se_necessario,
	ie_dose_espec_agora,
	ie_urgencia
from	prescr_material
where	nr_prescricao = nr_prescricao_p
and	ie_agrupador in (1,3,7,9)
and	coalesce(dt_suspensao::text, '') = '';

c03 CURSOR FOR
SELECT	nr_sequencia
from	prescr_material
where	nr_prescricao = nr_prescricao_p
and	ie_agrupador in (2)
and	coalesce(nr_seq_kit::text, '') = ''
and	coalesce(dt_suspensao::text, '') = '';

c04 CURSOR FOR
SELECT	nr_sequencia
from	prescr_material
where	nr_prescricao	= nr_prescricao_p
and	ie_agrupador	in (2)
and	nr_seq_kit	= nr_sequencia_w
and	coalesce(dt_suspensao::text, '') = '';

c05 CURSOR FOR
SELECT	nr_sequencia
from	prescr_material
where	nr_prescricao	= nr_prescricao_p
and	coalesce(ie_gerar_horario,'S') <> 'N'
and	coalesce(ie_acm,'N') <> 'S'
and	coalesce(ie_se_necessario,'N') <> 'S'
and	(nr_sequencia_solucao IS NOT NULL AND nr_sequencia_solucao::text <> '')
and	ie_agrupador in (4,13);

c06 CURSOR FOR
SELECT	a.nr_sequencia
from	regra_momento_lib_item c,
	prescr_procedimento b,
	prescr_material a
where	a.nr_prescricao		= b.nr_prescricao
and	a.nr_sequencia_proc	= b.nr_sequencia
and	c.nr_seq_proc_interno	= b.nr_seq_proc_interno
and	c.nr_seq_regra		= nr_seq_regra_w
and	a.nr_prescricao		= nr_prescricao_p
and	b.nr_prescricao		= nr_prescricao_p
and	a.ie_agrupador		in (5)
and	((coalesce(c.cd_setor_atendimento::text, '') = '') or (c.cd_setor_atendimento = cd_setor_atendimento_p))
and	coalesce(a.dt_suspensao::text, '') = '';

c07 CURSOR FOR
SELECT	nr_sequencia
from	prescr_material
where	nr_prescricao	= nr_prescricao_p
and	coalesce(ie_gerar_horario,'S') <> 'N'
and coalesce(ie_kit_gerado,'N') = 'S'
and	coalesce(ie_acm,'N') <> 'S'
and	coalesce(ie_se_necessario,'N') <> 'S'
and	ie_agrupador in (8);

c08 CURSOR FOR
SELECT	a.nr_sequencia
from	dieta b,
		prescr_dieta a,
		prescr_medica k
where	b.ie_situacao = 'A'
and		b.cd_dieta = a.cd_dieta
and		k.nr_prescricao = nr_prescricao_p
and		k.nr_prescricao	= a.nr_prescricao
and		coalesce(a.ie_suspenso,'N') <> 'S'
and		coalesce(k.dt_suspensao::text, '') = '';

c09 CURSOR FOR
SELECT	nr_sequencia
from	prescr_material
where	nr_prescricao	= nr_prescricao_p
and		ie_agrupador = 6
and		nr_sequencia_dieta = nr_sequencia_w
and		coalesce(dt_suspensao::text, '') = '';

c10 CURSOR FOR
SELECT	a.nr_sequencia,
		b.nr_seq_proc_interno
from	prescr_procedimento b,
		prescr_material a
where	a.nr_prescricao		= nr_prescricao_p
and		a.nr_prescricao		= b.nr_prescricao
and		a.nr_sequencia_proc	= b.nr_sequencia
and		a.ie_agrupador		= 5
and		coalesce(a.dt_suspensao::text, '') = '';

c11 CURSOR FOR
SELECT	ie_precisa_liberacao
from	regra_momento_lib_item
where	nr_seq_regra = nr_seq_regra_w
and	((coalesce(cd_material::text, '') = '') or (cd_material = cd_material_w))
and	((coalesce(cd_setor_atendimento::text, '') = '') or (cd_setor_atendimento = cd_setor_atendimento_p))
and	((coalesce(cd_intervalo::text, '') = '') or (cd_intervalo = cd_intervalo_w))
and	coalesce(ie_acm,'N') 			= coalesce(ie_acm_w,'N')
and	coalesce(ie_se_necessario,'N') 		= coalesce(ie_se_necessario_w,'N')
and	coalesce(ie_dose_espec,'N')			= coalesce(ie_dose_espec_w,'N')
and	coalesce(ie_agora,'N')			= coalesce(ie_agora_w,'N')
order by cd_material desc,
	cd_setor_atendimento desc,
	cd_intervalo desc,
	coalesce(ie_acm, 'N'),
	coalesce(ie_se_necessario, 'N'),
	coalesce(ie_dose_espec, 'N'),
	coalesce(ie_agora, 'N');

c12 CURSOR FOR
SELECT	a.nr_sequencia
from	prescr_material a
where	a.nr_prescricao = nr_prescricao_p
and		coalesce(a.ie_gerar_horario,'S') <> 'N'
and		coalesce(a.ie_kit_gerado,'N') = 'S'
and		coalesce(a.ie_acm,'N') <> 'S'
and		coalesce(a.ie_se_necessario,'N') <> 'S'
and		a.ie_agrupador in (12);

c13 CURSOR FOR
SELECT	a.nr_sequencia
from	prescr_material a,
		prescr_medica b
where	a.nr_prescricao = b.nr_prescricao
and a.nr_prescricao = nr_prescricao_p
and	a.ie_agrupador in (2)
and	(nr_seq_kit IS NOT NULL AND nr_seq_kit::text <> '')
and	coalesce(a.dt_suspensao::text, '') = ''
and	(nr_seq_recomendacao IS NOT NULL AND nr_seq_recomendacao::text <> '')
and b.cd_funcao_origem IN (924,950,2314);

BEGIN

select 	coalesce(max('S'),'N')
into STRICT	ie_quimio_w
from	paciente_atendimento
where	nr_prescricao = nr_prescricao_p;

select	coalesce(max(a.cd_estabelecimento),max(b.cd_estabelecimento))
into STRICT	cd_estabelecimento_w
FROM prescr_medica a
LEFT OUTER JOIN atendimento_paciente b ON (a.nr_atendimento = b.nr_atendimento)
WHERE a.nr_prescricao	= nr_prescricao_p;

select	coalesce(max(ie_lote_pos_lib),'N')
into STRICT	ie_lote_pos_lib_w
from	parametro_medico
where	cd_estabelecimento	= cd_estabelecimento_w;
select	CASE WHEN count(nr_sequencia)=0 THEN 'N'  ELSE 'S' END
into STRICT	ie_checar_automatico_w
from	adep_medic_checagem
where	coalesce(cd_perfil,cd_perfil_p)	= cd_perfil_p;

select	coalesce(max('S'),'N')
into STRICT	ie_lib_medico_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p
and	(dt_liberacao_medico IS NOT NULL AND dt_liberacao_medico::text <> '');

select	coalesce(max('S'),'N')
into STRICT	ie_lib_enfermagem_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

select	coalesce(max('S'),'N')
into STRICT	ie_lib_farmacia_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p
and	(dt_liberacao_farmacia IS NOT NULL AND dt_liberacao_farmacia::text <> '');

select	coalesce(max(ie_lib_farm),'N')
into STRICT	ie_lib_farm_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

select	max(dt_liberacao),
	max(dt_liberacao_medico),
	max(ie_motivo_prescricao)
into STRICT	dt_lib_enf_w,
	dt_lib_medico_w,
	ie_motivo_prescricao_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

select	count(*)
into STRICT	qt_dieta_w
from	dieta b,
	prescr_dieta a,
	prescr_medica k
where	b.ie_situacao = 'A'
and	b.cd_dieta = a.cd_dieta
and	k.nr_prescricao = nr_prescricao_p
and	k.nr_prescricao	= a.nr_prescricao
and	coalesce(a.ie_suspenso,'N') <> 'S'
and	coalesce(k.dt_suspensao::text, '') = '';

ie_info_rastre_prescr_w := obter_se_info_rastre_prescr( 'L', nm_usuario_p, cd_perfil_p, cd_estabelecimento_w );
CALL gravar_log_tasy(10007,
  substr('liberar_prescricao_item line 258 LOG:' || substr(to_char(sqlerrm),1,2000)
                 || '//nr_prescricao_p : '       || nr_prescricao_p
                 || ' ie_info_rastre_prescr_w: ' || ie_info_rastre_prescr_w
                 || ' nm_usuario_p: ' || nm_usuario_p
                 || ' cd_perfil_p: ' || cd_perfil_p
                 || ' cd_estabelecimento_w: ' || cd_estabelecimento_w
                 || ' 7010, 127: ' || obter_param_usuario_padrao(7010, 127, cd_perfil_p, nm_usuario_p, 0),1,2000),nm_usuario_p);
if (ie_info_rastre_prescr_w = 'S') then
CALL gravar_log_tasy(10007,
  substr('liberar_prescricao_item line 268 LOG:' || substr(to_char(sqlerrm),1,2000)
                 || '//ie_info_rastre_prescr_w : ' || ie_info_rastre_prescr_w
                 || ' ds_alteracao_rastre_w: ' || ds_alteracao_rastre_w
                 || ' pls_util_pck.enter_w: ' ||  pls_util_pck.enter_w
                 || ' cd_perfil_p: ' || cd_perfil_p
                 || ' cd_estabelecimento_w: ' || cd_estabelecimento_w
                 || ' 7010, 127: ' || obter_param_usuario_padrao(7010, 127, cd_perfil_p, nm_usuario_p, 0),1,2000),nm_usuario_p);
	ds_alteracao_rastre_w := substr(ds_alteracao_rastre_w || pls_util_pck.enter_w		
		|| 'params -'
		|| ' nr_prescricao_p:' || nr_prescricao_p
		|| ' cd_setor_atendimento_p:' || cd_setor_atendimento_p
		|| ' cd_perfil_p:' || cd_perfil_p
		|| ' nm_usuario_p:' || nm_usuario_p
		|| pls_util_pck.enter_w
		|| 'libs -'
		|| ' ie_lib_medico_w:' || ie_lib_medico_w
		|| ' ie_lib_enfermagem_w:' || ie_lib_enfermagem_w
		|| ' ie_lib_farmacia_w:' || ie_lib_farmacia_w
		|| pls_util_pck.enter_w
		|| 'c01 -'
		|| ' cd_estabelecimento_w:' || cd_estabelecimento_w
		|| ' cd_setor_atendimento_p:' || cd_setor_atendimento_p
		|| ' ie_motivo_prescricao_w:' || ie_motivo_prescricao_w
		|| ' ie_quimio_w:' || ie_quimio_w, 1, 1800);
end if;

open C01;
loop
fetch C01 into
	ie_momento_lote_w,
	ie_tipo_item_w,
	nr_seq_regra_w,
	cd_setor_atendimento_w,
	ie_associado_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

	if (ie_info_rastre_prescr_w = 'S') then
		ds_alteracao_rastre_w := substr(ds_alteracao_rastre_w || pls_util_pck.enter_w
			|| 'ie_momento_lote_w:' || ie_momento_lote_w
			|| ' ie_tipo_item_w:' || ie_tipo_item_w
			|| ' nr_seq_regra_w:' || nr_seq_regra_w
			|| ' cd_setor_atendimento_w:' || cd_setor_atendimento_w
			|| ' ie_associado_w:' || ie_associado_w
			|| ' ds_lista_liberados_w:' || ds_lista_liberados_w, 1, 1800);
	end if;
CALL gravar_log_tasy(10007,
  substr('line 314 LOG:' || substr(to_char(sqlerrm),1,2000)
                 || '//ie_info_rastre_prescr_w : ' || ie_info_rastre_prescr_w
                 || ' ds_alteracao_rastre_w: ' || ds_alteracao_rastre_w
                 || ' pls_util_pck.enter_w: ' ||  pls_util_pck.enter_w
                 || ' cd_perfil_p: ' || cd_perfil_p
                 || ' cd_estabelecimento_w: ' || cd_estabelecimento_w
                 || ' 7010, 127: ' || obter_param_usuario_padrao(7010, 127, cd_perfil_p, nm_usuario_p, 0),1,2000),nm_usuario_p);
	if (coalesce(position(','||ie_tipo_item_w||',' in ds_lista_liberados_w),0)	= 0) or (ie_tipo_item_w	= 'IA') then

		if (coalesce(ds_lista_liberados_w::text, '') = '') then
			ds_lista_liberados_w	:= ','||ie_tipo_item_w||',';
		else
			ds_lista_liberados_w	:= ds_lista_liberados_w||ie_tipo_item_w||',';
		end if;

		if	(ie_lib_enfermagem_w = 'S' AND ie_momento_lote_w = 'E') or
			(ie_momento_lote_w = 'M' AND ie_lib_medico_w = 'S') then

			if (ie_tipo_item_w = 'M') then

				open C02;
				loop
				fetch C02 into
					nr_sequencia_w,
					cd_material_w,
					cd_intervalo_w,
					ie_acm_w,
					ie_se_necessario_w,
					ie_dose_espec_w,
					ie_agora_w;
				EXIT WHEN NOT FOUND; /* apply on C02 */		
				
					ie_precisa_liberacao_w := null;			
					
					for r_c11_w in c11
					loop
						ie_precisa_liberacao_w := r_c11_w.ie_precisa_liberacao;
					end loop;
					CALL gravar_log_tasy(10007,
                    substr('liberar_presricao_item line 356 LOG:' || substr(to_char(sqlerrm),1,2000)
                            || ' nr_prescricao_p: ' || nr_prescricao_p
							|| 'c02 loop -'
							|| ' nr_sequencia_w:' || nr_sequencia_w
							|| ' cd_material_w:' || cd_material_w
							|| ' cd_intervalo_w:' || cd_intervalo_w
							|| ' ie_acm_w:' || ie_acm_w
							|| ' ie_se_necessario_w:' || ie_se_necessario_w
							|| ' ie_dose_espec_w:' || ie_dose_espec_w
							|| ' ie_agora_w:' || ie_agora_w
							|| ' ie_precisa_liberacao_w:' || ie_precisa_liberacao_w
                            || ' cd_estabelecimento_w: ' || cd_estabelecimento_w
                            || ' 7010, 127: ' || obter_param_usuario_padrao(7010, 127, cd_perfil_p, nm_usuario_p, 0),1,2000),nm_usuario_p);
					if (ie_info_rastre_prescr_w = 'S') then
						ds_alteracao_rastre_item_w := substr('Gerar log Rastreabilidade Alteracoes / liberar_prescricao_item ='
							|| ' nr_prescricao_p: ' || nr_prescricao_p
							|| 'c02 loop -'
							|| ' nr_sequencia_w:' || nr_sequencia_w
							|| ' cd_material_w:' || cd_material_w
							|| ' cd_intervalo_w:' || cd_intervalo_w
							|| ' ie_acm_w:' || ie_acm_w
							|| ' ie_se_necessario_w:' || ie_se_necessario_w
							|| ' ie_dose_espec_w:' || ie_dose_espec_w
							|| ' ie_agora_w:' || ie_agora_w
							|| ' ie_precisa_liberacao_w:' || ie_precisa_liberacao_w, 1, 1800);
							
						
						CALL gerar_log_prescr_mat(
							nr_prescricao_p		=> nr_prescricao_p,
							nr_seq_item_p		=> nr_sequencia_w,
							ie_agrupador_p		=> null,
							nr_seq_horario_p	=> null,
							ie_tipo_item_p		=> 'M',
							ds_log_p			=> ds_alteracao_rastre_item_w,
							nm_usuario_p		=> nm_usuario_p,
							ie_commit_p			=> 'N');
					end if;
 CALL gravar_log_tasy(10007,
                    substr('liberar_prescricao_item line 394 LOG:' || substr(to_char(sqlerrm),1,2000)
                            || ' ie_precisa_liberacao_w: ' || ie_precisa_liberacao_w
							|| ' ie_momento_lote_w:' || ie_momento_lote_w
                            || ' 7010, 127: ' || obter_param_usuario_padrao(7010, 127, cd_perfil_p, nm_usuario_p, 0),1,2000),nm_usuario_p);
						if (ie_precisa_liberacao_w = '') or (coalesce(ie_precisa_liberacao_w::text, '') = '') then
							if (ie_momento_lote_w = 'E') or (ie_momento_lote_w = 'M') then
								ie_precisa_liberacao_w := 'N';
							elsif (ie_momento_lote_w = 'F') then
								ie_precisa_liberacao_w := 'S';
							end if;
						end if;
						if	(ie_precisa_liberacao_w = 'S' AND ie_lib_farmacia_w = 'S') or (ie_precisa_liberacao_w = 'N') then

							CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_sequencia_w,cd_perfil_p, 'N' ,nm_usuario_p,null,'MAT');

							Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_sequencia_w,cd_perfil_p, 'S' ,nm_usuario_p,null,'M');

							if (ie_checar_automatico_w = 'S') then
								CALL adep_checagem_automatica(nr_prescricao_p, nm_usuario_p, cd_perfil_p);
							end if;

						else
 CALL gravar_log_tasy(10007,
                      substr('liberar_prescricao_item line 421 LOG:' || substr(to_char(sqlerrm),1,2000)
                            || ' nr_prescricao_p: ' || nr_prescricao_p
							|| ' nr_sequencia_w:' || nr_sequencia_w
                            || ' cd_perfil_p:' || cd_perfil_p
                            || ' ie_checar_automatico_w:' || ie_checar_automatico_w
                            || ' 7010, 127: ' || obter_param_usuario_padrao(7010, 127, cd_perfil_p, nm_usuario_p, 0),1,2000),nm_usuario_p);
							Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_sequencia_w,cd_perfil_p, 'N' ,nm_usuario_p,null,'M');
							if (ie_checar_automatico_w = 'S') then
								CALL adep_checagem_automatica(nr_prescricao_p, nm_usuario_p, cd_perfil_p);
							end if;

							open C04;
								loop
								fetch C04 into
									nr_seq_kit_w;
								EXIT WHEN NOT FOUND; /* apply on C04 */
									begin

									Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_seq_kit_w,cd_perfil_p, 'N' ,nm_usuario_p,null,'MAT');

									end;
								end loop;
							close C04;

						end if;
				end loop;
				close C02;
			elsif (ie_tipo_item_w = 'MAT') then
				open C03;
				loop
				fetch C03 into
					nr_sequencia_w;
				EXIT WHEN NOT FOUND; /* apply on C03 */
					CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_sequencia_w,cd_perfil_p, 'S' ,nm_usuario_p,null,'MAT');
				end loop;
				close C03;
			elsif (ie_tipo_item_w = 'IA') then

				select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END ,
						coalesce(max(ie_precisa_liberacao),'N')
				into STRICT	ie_lib_assoc_proc_w,
						ie_precisa_lib_proc_item_w
				from	regra_momento_lib_item
				where	nr_seq_regra 		= nr_seq_regra_w
				and		(nr_seq_proc_interno IS NOT NULL AND nr_seq_proc_interno::text <> '');
  CALL gravar_log_tasy(10007,
                      substr('liberar_prescricao_item line 468 LOG:' || substr(to_char(sqlerrm),1,2000)
                            || ' ie_lib_assoc_proc_w: ' || ie_lib_assoc_proc_w
                            || 'ie_tipo_item_w' || ie_tipo_item_w
                            || ' 7010, 127: ' || obter_param_usuario_padrao(7010, 127, cd_perfil_p, nm_usuario_p, 0),1,2000),nm_usuario_p);
				if (ie_lib_assoc_proc_w = 'S') then

					open c10;
					loop
					fetch c10 into
						nr_sequencia_w,
						nr_seq_proc_interno_w;
					EXIT WHEN NOT FOUND; /* apply on c10 */
						begin
							
							select	coalesce(max(c.ie_precisa_liberacao),'N')
							into STRICT	ie_precisa_lib_proc_item_w
							from	regra_momento_lib_item c,
									prescr_procedimento b,
									prescr_material a
							where	a.nr_prescricao		= b.nr_prescricao
							and		a.nr_sequencia_proc	= b.nr_sequencia
							and		c.nr_seq_proc_interno	= b.nr_seq_proc_interno
							and 	b.nr_seq_proc_interno = nr_seq_proc_interno_w
							and		c.nr_seq_regra		= nr_seq_regra_w
							and		a.nr_prescricao		= nr_prescricao_p
							and		a.ie_agrupador		= 5
							and		((coalesce(c.cd_setor_atendimento::text, '') = '') or (c.cd_setor_atendimento = cd_setor_atendimento_p))
							and		coalesce(a.dt_suspensao::text, '') = '';

							if (ie_precisa_lib_proc_item_w <> 'S') then
								CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_sequencia_w,cd_perfil_p, 'S' ,nm_usuario_p,null,'IA');
							else
								CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_sequencia_w,cd_perfil_p, 'N' ,nm_usuario_p,null,'IA');
							end if;
						end;
					end loop;
					close c10;
				else
					CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,null,cd_perfil_p, 'S' ,nm_usuario_p,null,'IA');
				end if;

			elsif (ie_tipo_item_w = 'S') then

				open C05;
				loop
				fetch C05 into
					nr_sequencia_w;
				EXIT WHEN NOT FOUND; /* apply on C05 */
					open C04;
					loop
					fetch C04 into
						nr_seq_kit_w;
					EXIT WHEN NOT FOUND; /* apply on C04 */
						CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_seq_kit_w,cd_perfil_p, 'N' ,nm_usuario_p,null,'MAT');
					end loop;
					close C04;
				end loop;
				close c05;

				CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,null,cd_perfil_p, 'S' ,nm_usuario_p,null,'S');
			elsif (ie_tipo_item_w = 'SNE') then
				CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,null,cd_perfil_p, 'S' ,nm_usuario_p,null,'SNE');

				open C07;
				loop
				fetch C07 into
					nr_sequencia_w;
				EXIT WHEN NOT FOUND; /* apply on C07 */
					open C04;
					loop
					fetch C04 into
						nr_seq_kit_w;
					EXIT WHEN NOT FOUND; /* apply on C04 */
						CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_seq_kit_w,cd_perfil_p, 'S' ,nm_usuario_p,null,'MAT');
					end loop;
					close C04;
				end loop;
				close c07;
			elsif (ie_tipo_item_w = 'SUP') then
				CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,null,cd_perfil_p, 'S' ,nm_usuario_p,null,'SUP');
				
				for r_c12 in c12 loop
					nr_sequencia_w := r_c12.nr_sequencia;
					for r_c04 in c04 loop
						nr_seq_kit_w := r_c04.nr_sequencia;
						CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p, nr_seq_kit_w, cd_perfil_p, 'S', nm_usuario_p, null, 'MAT');
					end loop;
				end loop;
			elsif (ie_tipo_item_w = 'L') then
				CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,null,cd_perfil_p, 'S' ,nm_usuario_p,null,'LD');
			elsif (ie_tipo_item_w = 'P') or (ie_tipo_item_w = 'G') or (ie_tipo_item_w = 'E') then
				if (ie_associado_w = 'S') then
					CALL gerar_prescr_proc_sem_dt_lib(nr_prescricao_p, NULL,cd_perfil_p, 'S' ,nm_usuario_p,ie_tipo_item_w);
					--gerar os mat/med assiciados
					CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,null,cd_perfil_p, 'S' ,nm_usuario_p,null,ie_tipo_item_w);
				else
					select	count(*)
					into STRICT	cont_w
					from	prescr_material
					where	nr_prescricao	= nr_prescricao_p
					and	ie_agrupador	= 5;
					if (cont_w = 0) then
						CALL gerar_prescr_proc_sem_dt_lib(nr_prescricao_p, NULL,cd_perfil_p, 'S' ,nm_usuario_p,ie_tipo_item_w);
						--gerar os mat/med assiciados
						CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,null,cd_perfil_p, 'S' ,nm_usuario_p,null,ie_tipo_item_w);
					end if;

				end if;
			elsif (ie_tipo_item_w = 'R') then
				CALL Gerar_prescr_hor_sem_lib(nr_prescricao_p, NULL,cd_perfil_p, 'S' ,nm_usuario_p,'R');
				open C13;
				loop
				fetch C13 into
					nr_sequencia_w;
				EXIT WHEN NOT FOUND; /* apply on C13 */
					CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_sequencia_w,cd_perfil_p, 'S' ,nm_usuario_p,null,'MAT');
				end loop;
				close C13;
			elsif (ie_tipo_item_w = 'D') and (qt_dieta_w > 0) then

					CALL gerar_prescr_dieta_hor_sem_lib(nr_prescricao_p,null, cd_perfil_p, 'S', null,'N',nm_usuario_p,'D');

					open C08;
					loop
					fetch C08 into
						nr_sequencia_w;
					EXIT WHEN NOT FOUND; /* apply on C08 */
						open C09;
						loop
						fetch C09 into
							nr_sequencia_w;
						EXIT WHEN NOT FOUND; /* apply on C09 */
							CALL gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_sequencia_w,cd_perfil_p, 'S' ,nm_usuario_p,null);
						end loop;
						close C09;
					end loop;
					close C08;
			elsif (ie_tipo_item_w = 'GAS') then
				CALL Gerar_prescr_gas_hor(nr_prescricao_p, nm_usuario_p, 'S');
				CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,null,cd_perfil_p,'S',nm_usuario_p,null,'GAS');

			end if;

		elsif (ie_lib_farmacia_w = 'S') and (ie_momento_lote_w = 'F') then

			if (ie_tipo_item_w = 'M') then

				open C02;
				loop
				fetch C02 into
					nr_sequencia_w,
					cd_material_w,
					cd_intervalo_w,
					ie_acm_w,
					ie_se_necessario_w,
					ie_dose_espec_w,
					ie_agora_w;
				EXIT WHEN NOT FOUND; /* apply on C02 */

					for r_c11_w in c11
					loop
						ie_precisa_liberacao_w := r_c11_w.ie_precisa_liberacao;
					end loop;

					if (ie_precisa_liberacao_w = '') or (coalesce(ie_precisa_liberacao_w::text, '') = '') then
						if (ie_momento_lote_w = 'E') or (ie_momento_lote_w = 'M') then
							ie_precisa_liberacao_w := 'N';
						elsif (ie_momento_lote_w = 'F') then
							ie_precisa_liberacao_w := 'S';
						end if;
					end if;

					if	(ie_precisa_liberacao_w = 'S' AND ie_lib_farmacia_w = 'S') or (ie_precisa_liberacao_w = 'N') then
						open C04;
						loop
						fetch C04 into
							nr_seq_kit_w;
						EXIT WHEN NOT FOUND; /* apply on C04 */
							begin

							Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_seq_kit_w,cd_perfil_p, 'S' ,nm_usuario_p,null,'MAT');

							end;
						end loop;
						close C04;

						if (ie_precisa_liberacao_w = 'S') and (ie_lib_farmacia_w = 'S') then

							CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_sequencia_w,cd_perfil_p, 'S' ,nm_usuario_p,null,'M');
							if (ie_checar_automatico_w = 'S') then
								CALL adep_checagem_automatica(nr_prescricao_p, nm_usuario_p, cd_perfil_p);
							end if;
						elsif (ie_precisa_liberacao_w = 'N') then

							CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_sequencia_w,cd_perfil_p, 'S' ,nm_usuario_p,null,'M');
							if (ie_checar_automatico_w = 'S') then
								CALL adep_checagem_automatica(nr_prescricao_p, nm_usuario_p, cd_perfil_p);
							end if;
						end if;
					else

						CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_sequencia_w,cd_perfil_p, 'N' ,nm_usuario_p,null,'M');
						if (ie_checar_automatico_w = 'S') then
							CALL adep_checagem_automatica(nr_prescricao_p, nm_usuario_p, cd_perfil_p);
						end if;

						open C04;
						loop
						fetch C04 into
							nr_seq_kit_w;
						EXIT WHEN NOT FOUND; /* apply on C04 */
							begin

							Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_seq_kit_w,cd_perfil_p, 'N' ,nm_usuario_p,null,'MAT');

							end;
						end loop;
						close C04;

					end if;
				end loop;
				close C02;
			elsif (ie_tipo_item_w = 'MAT') then
				open C03;
				loop
				fetch C03 into
					nr_sequencia_w;
				EXIT WHEN NOT FOUND; /* apply on C03 */
					CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_sequencia_w,cd_perfil_p, 'S' ,nm_usuario_p,null,'MAT');
				end loop;
				close C03;
			elsif (ie_tipo_item_w = 'IA') then

				select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
				into STRICT	ie_lib_assoc_proc_w
				from	regra_momento_lib_item
				where	nr_seq_regra 		= nr_seq_regra_w
				and	(nr_seq_proc_interno IS NOT NULL AND nr_seq_proc_interno::text <> '');

				if (ie_lib_assoc_proc_w	= 'S') then

					open C06;
					loop
					fetch C06 into
						nr_sequencia_w;
					EXIT WHEN NOT FOUND; /* apply on C06 */
						begin
						Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_sequencia_w,cd_perfil_p, 'S' ,nm_usuario_p,null,'IA');
						end;
					end loop;
					close C06;
				else
					CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,null,cd_perfil_p, 'S' ,nm_usuario_p,null,'IA');
				end if;
			elsif (ie_tipo_item_w = 'S') then

				open C05;
				loop
				fetch C05 into
					nr_sequencia_w;
				EXIT WHEN NOT FOUND; /* apply on C05 */
					open C04;
					loop
					fetch C04 into
						nr_seq_kit_w;
					EXIT WHEN NOT FOUND; /* apply on C04 */
						CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_seq_kit_w,cd_perfil_p, 'N' ,nm_usuario_p,null,'MAT');
					end loop;
					close C04;
				end loop;
				close c05;

				CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,NULL,cd_perfil_p, 'S' ,nm_usuario_p,null,'S');
			elsif (ie_tipo_item_w = 'SNE') then
				CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,NULL,cd_perfil_p, 'S' ,nm_usuario_p,null,'SNE');
			elsif (ie_tipo_item_w = 'SUP') then
				CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,NULL,cd_perfil_p, 'S' ,nm_usuario_p,null,'SUP');
			elsif (ie_tipo_item_w = 'L') then
				CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,NULL,cd_perfil_p, 'S' ,nm_usuario_p,null,'LD');
			elsif (ie_tipo_item_w = 'P') or (ie_tipo_item_w = 'G') or (ie_tipo_item_w = 'E') then
				if (ie_associado_w = 'S') then
					CALL gerar_prescr_proc_sem_dt_lib(nr_prescricao_p, NULL,cd_perfil_p, 'S' ,nm_usuario_p,ie_tipo_item_w);
					--gerar os mat/med assiciados
					CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,null,cd_perfil_p, 'S' ,nm_usuario_p,null,ie_tipo_item_w);
				else
					select	count(*)
					into STRICT	cont_w
					from	prescr_material
					where	nr_prescricao	= nr_prescricao_p
					and	ie_agrupador	= 5;
					if (cont_w = 0) then
						CALL gerar_prescr_proc_sem_dt_lib(nr_prescricao_p, NULL,cd_perfil_p, 'S' ,nm_usuario_p,ie_tipo_item_w);
						--gerar os mat/med assiciados
						CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,null,cd_perfil_p, 'S' ,nm_usuario_p,null,ie_tipo_item_w);
					end if;

				end if;
			elsif (ie_tipo_item_w = 'R') then
				CALL Gerar_prescr_hor_sem_lib(nr_prescricao_p,NULL,cd_perfil_p, 'S' ,nm_usuario_p,'R');
			elsif (ie_tipo_item_w = 'D') and (qt_dieta_w > 0) then

					CALL gerar_prescr_dieta_hor_sem_lib(nr_prescricao_p,null, cd_perfil_p, 'S',null, 'N',nm_usuario_p,'D');

					open C08;
					loop
					fetch C08 into
						nr_sequencia_w;
					EXIT WHEN NOT FOUND; /* apply on C08 */
						open C09;
						loop
						fetch C09 into
							nr_sequencia_w;
						EXIT WHEN NOT FOUND; /* apply on C09 */
							CALL gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_sequencia_w,cd_perfil_p, 'S' ,nm_usuario_p,null);
						end loop;
						close C09;
					end loop;
					close C08;
			elsif (ie_tipo_item_w = 'GAS') then
				CALL Gerar_prescr_gas_hor(nr_prescricao_p, nm_usuario_p, 'S');
				CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,null,cd_perfil_p,'S',nm_usuario_p,null,'GAS');

			end if;

		elsif (ie_lib_medico_w	= 'S') and (ie_lib_enfermagem_w	= 'N') and (ie_lib_farmacia_w	= 'N') then

			if (not ie_entrou_w) then
				CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,NULL,cd_perfil_p, 'N' ,nm_usuario_p,null);
				if (ie_checar_automatico_w = 'S') then
					CALL adep_checagem_automatica(nr_prescricao_p, nm_usuario_p, cd_perfil_p);
				end if;
				CALL gerar_prescr_proc_sem_dt_lib(nr_prescricao_p,NULL,cd_perfil_p, 'N' ,nm_usuario_p);
				CALL Gerar_prescr_gas_hor(nr_prescricao_p, nm_usuario_p, 'N');
				CALL Gerar_prescr_hor_sem_lib(nr_prescricao_p,null,cd_perfil_p, 'N' ,nm_usuario_p);
				IF (qt_dieta_w > 0) THEN
					CALL gerar_prescr_dieta_hor_sem_lib(nr_prescricao_p,null, cd_perfil_p, 'N',null, 'N',nm_usuario_p);
				END IF;
				CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,null,cd_perfil_p,'N',nm_usuario_p,null,'GAS');
				ie_entrou_w	:= true;
			end if;

		elsif (ie_lib_enfermagem_w	= 'S') and (ie_lib_farmacia_w	= 'N') and (ie_momento_lote_w	= 'F') then

			if (ie_tipo_item_w = 'M') then
				CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,NULL,cd_perfil_p, 'N' ,nm_usuario_p,null);
				if (ie_checar_automatico_w = 'S') then
					CALL adep_checagem_automatica(nr_prescricao_p, nm_usuario_p, cd_perfil_p);
				end if;
			elsif (ie_tipo_item_w = 'MAT') then
				CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,NULL,cd_perfil_p, 'N' ,nm_usuario_p,null);
			elsif (ie_tipo_item_w = 'IA') then
				CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,null,cd_perfil_p, 'N' ,nm_usuario_p,null,'IA');
			elsif (ie_tipo_item_w = 'S') then

				open C05;
				loop
				fetch C05 into
					nr_sequencia_w;
				EXIT WHEN NOT FOUND; /* apply on C05 */
					open C04;
					loop
					fetch C04 into
						nr_seq_kit_w;
					EXIT WHEN NOT FOUND; /* apply on C04 */
						CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p, nr_seq_kit_w, cd_perfil_p, 'N', nm_usuario_p, null, 'MAT');
					end loop;
					close C04;
				end loop;
				close c05;

				CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,NULL,cd_perfil_p, 'N' ,nm_usuario_p,null);
			elsif (ie_tipo_item_w = 'SNE') then
				CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,NULL,cd_perfil_p, 'N' ,nm_usuario_p,null);
			elsif (ie_tipo_item_w = 'SUP') then
				CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,NULL,cd_perfil_p, 'N' ,nm_usuario_p,null);
			elsif (ie_tipo_item_w = 'L') then
				CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,NULL,cd_perfil_p, 'N' ,nm_usuario_p,null);
			elsif (ie_tipo_item_w = 'P') or (ie_tipo_item_w = 'G') or (ie_tipo_item_w = 'E') then
				if (ie_associado_w = 'S') then
					CALL gerar_prescr_proc_sem_dt_lib(nr_prescricao_p,NULL,cd_perfil_p, 'S' ,nm_usuario_p,ie_tipo_item_w);
					--gerar os mat/med assiciados
					CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,NULL,cd_perfil_p, 'S' ,nm_usuario_p,null,ie_tipo_item_w);
				else
					select	count(*)
					into STRICT	cont_w
					from	prescr_material
					where	nr_prescricao	= nr_prescricao_p
					and	ie_agrupador	= 5;
					if (cont_w = 0) then
						CALL gerar_prescr_proc_sem_dt_lib(nr_prescricao_p,NULL,cd_perfil_p, 'S' ,nm_usuario_p,ie_tipo_item_w);
						--gerar os mat/med assiciados
						CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,NULL,cd_perfil_p, 'S' ,nm_usuario_p,null,ie_tipo_item_w);
					end if;

				end if;

			elsif (ie_tipo_item_w = 'R') then
				CALL Gerar_prescr_hor_sem_lib(nr_prescricao_p,NULL,cd_perfil_p, 'S' ,nm_usuario_p,'R');
			elsif (ie_tipo_item_w = 'D') and (qt_dieta_w > 0) then
					CALL gerar_prescr_dieta_hor_sem_lib(nr_prescricao_p,null, cd_perfil_p, 'S',null, 'N',nm_usuario_p,'D');

					open C08;
					loop
					fetch C08 into
						nr_sequencia_w;
					EXIT WHEN NOT FOUND; /* apply on C08 */
						open C09;
						loop
						fetch C09 into
							nr_sequencia_w;
						EXIT WHEN NOT FOUND; /* apply on C09 */
							CALL gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,nr_sequencia_w,cd_perfil_p, 'S' ,nm_usuario_p,null);
						end loop;
						close C09;
					end loop;
					close C08;
			elsif (ie_tipo_item_w = 'GAS') then
				CALL Gerar_prescr_gas_hor(nr_prescricao_p, nm_usuario_p, 'N');
				CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,null,cd_perfil_p,'N',nm_usuario_p,null,'GAS');

			end if;

		end if;
	end if;

end loop;
close C01;
CALL gravar_log_tasy(10007,
                      substr('liberar_prescricao_item line 908 LOG:' || substr(to_char(sqlerrm),1,2000)
                            || ' wheb_usuario_pck.get_ie_commit: ' || coalesce(wheb_usuario_pck.get_ie_commit, 'S')
                            || 'ie_lib_medico_w' || coalesce(ie_lib_medico_w,'N')
                            || 'ie_lib_enfermagem_w' || coalesce(ie_lib_enfermagem_w,'N')
                            || 'ie_lib_farmacia_w' || coalesce(ie_lib_farmacia_w,'N')
                            || ' 7010, 127: ' || obter_param_usuario_padrao(7010, 127, cd_perfil_p, nm_usuario_p, 0),1,2000),nm_usuario_p);
if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
if (coalesce(ie_lib_medico_w,'N') = 'S') and (coalesce(ie_lib_enfermagem_w,'N') = 'S') and (coalesce(ie_lib_farmacia_w,'N') = 'S') then
	CALL gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,NULL,cd_perfil_p, 'S' ,nm_usuario_p,null);
	CALL gerar_prescr_proc_sem_dt_lib(nr_prescricao_p,NULL,cd_perfil_p, 'S' ,nm_usuario_p);
	CALL Gerar_prescr_hor_sem_lib(nr_prescricao_p,NULL,cd_perfil_p, 'S' ,nm_usuario_p,'R');
	CALL gerar_prescr_dieta_hor_sem_lib(nr_prescricao_p,null, cd_perfil_p, 'S',null, 'N',nm_usuario_p,'D');
	CALL Gerar_prescr_gas_hor(nr_prescricao_p, nm_usuario_p, 'S');
else
	CALL gerar_prescr_mat_sem_dt_lib(nr_prescricao_p,NULL,cd_perfil_p, 'N' ,nm_usuario_p,null);
	CALL gerar_prescr_proc_sem_dt_lib(nr_prescricao_p,NULL,cd_perfil_p, 'N' ,nm_usuario_p);
	CALL Gerar_prescr_hor_sem_lib(nr_prescricao_p,NULL,cd_perfil_p, 'N' ,nm_usuario_p,'R');
	CALL gerar_prescr_dieta_hor_sem_lib(nr_prescricao_p,null, cd_perfil_p, 'N',null, 'N',nm_usuario_p,'D');
	CALL Gerar_prescr_gas_hor(nr_prescricao_p, nm_usuario_p, 'N');
end if;
 CALL gravar_log_tasy(10007,
                      substr('liberar_prescricao_item line 931 LOG: ' || substr(to_char(sqlerrm),1,2000)
                            || ' ie_info_rastre_prescr_w: ' || ie_info_rastre_prescr_w
                            || ' ie_lote_pos_lib_w: ' || ie_lote_pos_lib_w
                            || ' ds_alteracao_rastre_w: ' || ds_alteracao_rastre_w
                            || ' ie_lib_farmacia_w: ' || coalesce(ie_lib_farmacia_w,'N')
                            || ' 7010, 127: ' || obter_param_usuario_padrao(7010, 127, cd_perfil_p, nm_usuario_p, 0),1,2000),nm_usuario_p);
if (ie_info_rastre_prescr_w = 'S') then
	ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / liberar_prescricao_item = ' || 'NR_PRESCRICAO_P: ' || nr_prescricao_p
	|| ' IE_LOTE_POS_LIB_W: ' || ie_lote_pos_lib_w || ds_alteracao_rastre_w
	,1,1800);

	CALL Gerar_log_prescr_mat(nr_prescricao_p, null, null, null, null, ds_alteracao_rastre_w, nm_usuario_p, 'N');
end if;

if (ie_lote_pos_lib_w	= 'S') then
	CALL Gerar_Lote_Atend_Prescricao(nr_prescricao_p, 0, 0, 'N', nm_usuario_p, 'GPMH');
end if;
 CALL gravar_log_tasy(10007,
                      substr('liberar_prescricao_item line 931 LOG: ' || substr(to_char(sqlerrm),1,2000)
                            || ' wheb_usuario_pck.get_ie_commit: ' || coalesce(wheb_usuario_pck.get_ie_commit, 'S')
                            || ' 7010, 127: ' || obter_param_usuario_padrao(7010, 127, cd_perfil_p, nm_usuario_p, 0),1,2000),nm_usuario_p);
if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_prescricao_item ( nr_prescricao_p bigint, cd_setor_atendimento_p bigint, cd_perfil_p bigint, nm_usuario_p text) FROM PUBLIC;

