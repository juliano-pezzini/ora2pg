-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_regra_agenda_grupo (cd_agenda_p bigint, dt_agenda_p timestamp, nr_seq_proc_interno_p bigint, nr_seq_agenda_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_adicional_p bigint) AS $body$
DECLARE


nr_seq_grupo_w		bigint := 0;
qt_permitida_w		bigint;
qt_agendado_grupo_w	bigint;
qt_agendado_grupo_adic_w	bigint;
ie_dia_semana_w		smallint;
dt_inicio_agenda_w	timestamp;
dt_fim_agenda_w		timestamp;

qt_agendado_total_w	bigint;


BEGIN

ie_dia_semana_w	:= Obter_Cod_Dia_Semana(dt_agenda_p);

select	max(a.nr_sequencia)
into STRICT	nr_seq_grupo_w
from	regra_cons_agenda_grupo a,
	regra_cons_grupo_item b
where	b.nr_seq_grupo_consistencia 		= a.nr_sequencia
and	a.cd_agenda 				= cd_agenda_p
and	b.nr_seq_proc_interno 			= nr_seq_proc_interno_p
and	((coalesce(a.ie_dia_semana,ie_dia_semana_w) = ie_dia_semana_w) or ((a.ie_dia_semana = 9) and (ie_dia_semana_w not in (7,1))))
and	dt_agenda_p between to_date(to_char(dt_agenda_p,'dd/mm/yyyy') || ' ' || coalesce(to_char(a.dt_inicio_agenda,'hh24:mi:ss'),'00:00:00'),'dd/mm/yyyy hh24:mi:ss') and
			    to_date(to_char(dt_agenda_p,'dd/mm/yyyy') || ' ' || coalesce(to_char(a.dt_fim_agenda,'hh24:mi:ss'),'23:59:59'),'dd/mm/yyyy hh24:mi:ss')
and	coalesce(a.ie_situacao,'A')		= 'A';


if (nr_seq_grupo_w > 0) then

	select	max(qt_consistencia),
		max(dt_inicio_agenda),
		max(dt_fim_agenda)
	into STRICT	qt_permitida_w,
		dt_inicio_agenda_w,
		dt_fim_agenda_w
	from	regra_cons_agenda_grupo
	where	nr_sequencia = nr_seq_grupo_w;

	select	count(*)
	into STRICT	qt_agendado_grupo_w
	from	agenda_paciente a
	where	a.cd_agenda = cd_agenda_p
	and	((a.nr_sequencia <> nr_seq_agenda_p AND nr_seq_adicional_p = 0) or (nr_seq_adicional_p > 0))
	and	a.ie_status_agenda not in ('C','I','F')
	and	a.hr_inicio between to_date(to_char(dt_agenda_p,'dd/mm/yyyy') || ' ' || coalesce(to_char(dt_inicio_agenda_w,'hh24:mi:ss'),'00:00:00'),'dd/mm/yyyy hh24:mi:ss') and
			    to_date(to_char(dt_agenda_p,'dd/mm/yyyy') || ' ' || coalesce(to_char(dt_fim_agenda_w,'hh24:mi:ss'),'23:59:59'),'dd/mm/yyyy hh24:mi:ss')
	and	exists (SELECT	1
			from	regra_cons_grupo_item x
			where	x.nr_seq_grupo_consistencia 	= nr_seq_grupo_w
			and	x.nr_seq_proc_interno		= a.nr_seq_proc_interno);


	select	count(*)
	into STRICT	qt_agendado_grupo_adic_w
	from	agenda_paciente_proc b,
		agenda_paciente a
	where	a.nr_sequencia = b.nr_sequencia
	and	a.cd_agenda = cd_agenda_p
	and	a.ie_status_agenda not in ('C','I','F')
	and	a.hr_inicio between to_date(to_char(dt_agenda_p,'dd/mm/yyyy') || ' ' || coalesce(to_char(dt_inicio_agenda_w,'hh24:mi:ss'),'00:00:00'),'dd/mm/yyyy hh24:mi:ss') and
			    to_date(to_char(dt_agenda_p,'dd/mm/yyyy') || ' ' || coalesce(to_char(dt_fim_agenda_w,'hh24:mi:ss'),'23:59:59'),'dd/mm/yyyy hh24:mi:ss')
	and	b.nr_seq_proc_interno in (SELECT	x.nr_seq_proc_interno
					from	regra_cons_grupo_item x
					where	x.nr_seq_grupo_consistencia 	= nr_seq_grupo_w);

	qt_agendado_total_w :=	qt_agendado_grupo_adic_w + qt_agendado_grupo_w;

	--r(-20011,qt_agendado_total_w||'#@#@');
	if (qt_agendado_total_w >= qt_permitida_w) then
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(262530);
	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_regra_agenda_grupo (cd_agenda_p bigint, dt_agenda_p timestamp, nr_seq_proc_interno_p bigint, nr_seq_agenda_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_adicional_p bigint) FROM PUBLIC;

