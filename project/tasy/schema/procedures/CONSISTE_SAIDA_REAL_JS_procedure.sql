-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_saida_real_js ( nr_atendimento_p bigint, nr_atendimento_pac_p bigint, dt_alta_tesouraria_p timestamp, cd_setor_atendimento_p bigint, cd_perfil_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ds_consisitencia_p INOUT text, ie_abrir_wdlg_p INOUT text) AS $body$
DECLARE

 
ds_consistencia_w			varchar(255) 	:= '';
cd_motivo_alta_w			bigint;	
cd_conta_particular_aberta_w		varchar(255);
ds_saida_real_tesouraria_w		varchar(100);
ds_saida_real_conta_part_ab_w		varchar(100);
ie_abrir_wdlg_w				varchar(1)	:= 'N';
ie_lib_regra_w				varchar(1);
cd_setor_atual_w			varchar(100);
cd_unidade_basica_w			varchar(100);
cd_unidade_compl_w			varchar(100);
ie_permite_inicio_higien_w		varchar(100);
ie_permite_fim_higien_w			varchar(100);
ds_aguard_higien_w			varchar(100);
ds_inic_higienizacao_auto_w		varchar(100);
ds_permite_higienizar_w			varchar(100);
ds_permite_hig_inic_w			varchar(100);
ds_permite_hig_fim_w			varchar(100);
ds_inic_higienizacao_total_w		varchar(100);
ds_erro_w				varchar(200);
ds_retorno_w				varchar(10);
ie_controla_hig_w			varchar(10);
ie_considerar_hig_estr_w		varchar(10);
ie_aguar_hig_saida_real_w		varchar(10);
	

BEGIN 
 
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '')then 
	begin 
	 
	CALL consiste_evol_saida_real(nr_atendimento_p, nm_usuario_p);
	 
	ds_consistencia_w := consiste_regra_alta_saida_real(clock_timestamp(), nr_atendimento_p, cd_setor_atendimento_p, ds_consistencia_w, nm_usuario_p);
	 
	select 	cd_motivo_alta 
	into STRICT	cd_motivo_alta_w 
	from 	atendimento_paciente 
	where 	nr_atendimento = nr_atendimento_pac_p;
	 
	cd_conta_particular_aberta_w	:= obter_conta_particular_aberta(nr_atendimento_pac_p);
	 
	ds_retorno_w := obter_param_usuario(3111, 138, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ds_retorno_w);
	ds_saida_real_tesouraria_w		:= ds_retorno_w;
	 
	ds_retorno_w := obter_param_usuario(3111, 134, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ds_retorno_w);
	ds_saida_real_conta_part_ab_w		:= ds_retorno_w;
	 
	ds_retorno_w := obter_param_usuario(3111, 130, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ds_retorno_w);
	ds_aguard_higien_w			:= ds_retorno_w;
	 
	ds_retorno_w := obter_param_usuario(3111, 117, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ds_retorno_w);
	ds_inic_higienizacao_auto_w		:= ds_retorno_w;
	 
	ds_retorno_w := obter_param_usuario(3111, 118, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ds_retorno_w);
	ds_permite_higienizar_w			:= ds_retorno_w;
	 
	ds_retorno_w := obter_param_usuario(3111, 119, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ds_retorno_w);
	ds_permite_hig_inic_w			:= ds_retorno_w;
	 
	ds_retorno_w := obter_param_usuario(3111, 120, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ds_retorno_w);
	ds_inic_higienizacao_total_w		:= ds_retorno_w;
	 
	ds_retorno_w := obter_param_usuario(3111, 121, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ds_retorno_w);
	ds_permite_hig_fim_w			:= ds_retorno_w;
	 
	ds_retorno_w := obter_param_usuario(3111, 167, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ds_retorno_w);
	ie_considerar_hig_estr_w		:= ds_retorno_w;
	 
	ds_retorno_w := obter_param_usuario(3111, 204, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ds_retorno_w);
	ie_aguar_hig_saida_real_w		:= ds_retorno_w;
	 
	 
	ie_lib_regra_w				:= obter_se_lib_regra(cd_motivo_alta_w, clock_timestamp());
	 
	if (ds_consistencia_w IS NOT NULL AND ds_consistencia_w::text <> '') and (ds_saida_real_tesouraria_w = 'N') and (coalesce(dt_alta_tesouraria_p::text, '') = '')then 
		begin 
		 
		ie_abrir_wdlg_w	:= 'S';
		 
		end;
		 
	elsif (ds_saida_real_conta_part_ab_w = 'N') and (cd_conta_particular_aberta_w <> '')and (coalesce(dt_alta_tesouraria_p::text, '') = '')then 
		begin 
		--Não é permitido gerar saída real para pacientes com conta particular aberta! Parâmetro [134]. 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(214321);		
		end;
		 
	elsif (ds_saida_real_conta_part_ab_w = 'S') and (ds_saida_real_tesouraria_w = 'S') and (cd_conta_particular_aberta_w <> '') and (coalesce(dt_alta_tesouraria_p::text, '') = '')then 
		begin 
		 
		ie_abrir_wdlg_w	:= 'S';
		 
		end;
		 
	elsif (ds_saida_real_conta_part_ab_w = 'D') and (ie_lib_regra_w = 'N') and (cd_conta_particular_aberta_w <> '') and (coalesce(dt_alta_tesouraria_p::text, '') = '')then 
		begin		 
		--Não é permitido gerar saída real para pacientes com conta particular aberta! Parâmetro [134]. 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(214321);	
		 
		end;
	 
	else 
		begin 
		 
		CALL gerar_saida_real(nm_usuario_p, nr_atendimento_p, clock_timestamp(), '');
		 
		cd_setor_atual_w		:= obter_unidade_atendimento(nr_atendimento_p, 'IA', 'CS');
		cd_unidade_basica_w		:= obter_unidade_atendimento(nr_atendimento_p, 'A', 'UB');
		cd_unidade_compl_w		:= obter_unidade_atendimento(nr_atendimento_p, 'A', 'UC');
		ie_permite_inicio_higien_w	:= obter_se_regra_lib_setor_higie(cd_setor_atendimento_p, cd_perfil_p, nm_usuario_p, 0);
		ie_permite_fim_higien_w		:= obter_se_regra_lib_setor_higie(cd_setor_atendimento_p, cd_perfil_p, nm_usuario_p, 0);
		 
		CALL avisar_higienizacao_camareira(cd_setor_atual_w, cd_unidade_basica_w, cd_unidade_compl_w, 'S');
		 
		if (ds_aguard_higien_w = 'S')then 
			begin 
			 
			ie_controla_hig_w	:= obter_se_higieniza_leito(cd_setor_atual_w,cd_unidade_basica_w,cd_unidade_compl_w);
			 
			if	((ie_controla_hig_w = 'H') or 
				(ie_considerar_hig_estr_w <> 'N' AND ie_aguar_hig_saida_real_w = 'N') or 
				((ie_considerar_hig_estr_w <> 'N') and (ie_aguar_hig_saida_real_w = 'S') and (ie_controla_hig_w <> 'N'))) then 
				begin 
				 
				update  unidade_atendimento 
				set   ie_status_unidade  = 'G', 
					 nm_usuario = nm_usuario_p, 
					 dt_atualizacao = clock_timestamp() 
				where 	 cd_unidade_basica = cd_unidade_basica_w 
				and 	 cd_unidade_compl = cd_unidade_compl_w 
				and 	 cd_setor_atendimento = cd_setor_atual_w;
				 
				end;
			end if;
			 
			end;
		/*else 
			begin 
			 
			if	(ds_inic_higienizacao_auto_w = 'S') and 
				((ds_permite_higienizar_w = 'S') or (ds_permite_hig_inic_w = 'S') or ((ds_permite_hig_inic_w = 'D') and (ie_permite_inicio_higien_w = 'S')))then 
				begin 
				 
				--chamada para a procedure Higienizar. 
				--Higienizar(10, VarCd_Setor_atual, VarCD_unidade_basica, VarCD_unidade_compl, ''); 
				--higienizar_js(10, cd_setor_atual_w, cd_unidade_basica_w, cd_unidade_compl_w, '', cd_perfil_p, nm_usuario_p, cd_estabelecimento_p); 
				 
				end; 
			end if; 
			 
			if	(ds_inic_higienizacao_total_w = 'S') and 
				((ds_permite_higienizar_w = 'S') or (ds_permite_hig_fim_w = 'S') or ((ds_permite_hig_fim_w = 'D') and (ie_permite_fim_higien_w = 'S')))then 
				begin 
				 
				--chamada para a procedure Higienizar. 
				--Higienizar(11, VarCd_Setor_atual, VarCD_unidade_basica, VarCD_unidade_compl, ''); 
				--higienizar_js(11, cd_setor_atual_w, cd_unidade_basica_w, cd_unidade_compl_w, '', cd_perfil_p, nm_usuario_p, cd_estabelecimento_p); 
				 
				end; 
			end if; 
			 
			end;*/
 
		end if;
		 
		if (cd_setor_atual_w <> '')and (cd_setor_atual_w <> '0')then 
			begin 
			 
			ds_erro_w := atualizar_situacao_leito_agrup((cd_setor_atual_w)::numeric , cd_unidade_basica_w, cd_unidade_compl_w, nm_usuario_p, cd_estabelecimento_p, 'S', ds_erro_w);
			 
			if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '')then 
				begin 
				 
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(214322,'DS_ERRO=' || ds_erro_w);
				 
				end;
			end if;
			 
			end;
		end if;
		 
		end;
			 
	end if;
	 
	end;
end if;
 
ds_consisitencia_p	:= ds_consistencia_w;
ie_abrir_wdlg_p		:= ie_abrir_wdlg_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_saida_real_js ( nr_atendimento_p bigint, nr_atendimento_pac_p bigint, dt_alta_tesouraria_p timestamp, cd_setor_atendimento_p bigint, cd_perfil_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ds_consisitencia_p INOUT text, ie_abrir_wdlg_p INOUT text) FROM PUBLIC;

