-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_rateio_proc_interno ( nr_lote_contabil_p bigint, nr_seq_movto_p INOUT bigint, nr_seq_proc_interno_p bigint, cd_conta_contabil_p text, cd_historico_p bigint, dt_movimento_p timestamp, vl_material_p bigint, cd_centro_custo_p bigint, ds_compl_historico_p text, ds_doc_agrupamento_p text, nr_seq_agrupamento_p bigint) AS $body$
DECLARE


cd_centro_custo_w		bigint;
contador_w		bigint := 0;
nr_seq_movto_w 		bigint;
pr_rateio_total_w		double precision;
qt_registros_w		bigint;
vl_rateio_w		double precision;
vl_rateio_total_w		double precision := 0;

c01 CURSOR FOR
	SELECT	cd_centro_custo,
		round(sum(vl_material_p * (pr_rateio/100)),2) vl_rateio
	from	ctb_crit_rateio_proc
	where	nr_seq_proc_interno = nr_seq_proc_interno_p
	and	dt_movimento_p between dt_inicio_vigencia and coalesce(dt_fim_vigencia,dt_movimento_p)
	group by cd_centro_custo
	order by 2 desc;


BEGIN

nr_seq_movto_w	:= nr_seq_movto_p;

-- Verificar se a soma dos percentuais de rateio não é menor do que 100%. Caso seja, deve inserir no centro de custo que iria inseriri se não houvesse regra.
select	sum(pr_rateio)
into STRICT	pr_rateio_total_w
from	ctb_crit_rateio_proc
where	nr_seq_proc_interno = nr_seq_proc_interno_p
and	dt_movimento_p between dt_inicio_vigencia and coalesce(dt_fim_vigencia,dt_movimento_p);

if (pr_rateio_total_w < 100) then

	nr_seq_movto_w 	:= nr_seq_movto_w + 1;
	vl_rateio_w 	:= round(vl_material_p * ((100 - pr_rateio_total_w)/100),2);
	vl_rateio_total_w	:= vl_rateio_total_w + vl_rateio_w;

	insert into w_movimento_contabil(	nr_lote_contabil,
					nr_sequencia,
					cd_conta_contabil,
					ie_debito_credito,
					cd_historico,
					dt_movimento,
					vl_movimento,
					cd_centro_custo,
					ds_compl_historico,
					ds_doc_agrupamento,
					nr_seq_agrupamento,
					nr_seq_trans_fin,
					cd_cgc,
					cd_pessoa_fisica,
					nr_documento,
					ie_transitorio)
			values (		nr_lote_contabil_p,
					nr_seq_movto_w,
					cd_conta_contabil_p,
					'C',
					cd_historico_p,
					dt_movimento_p,
					vl_rateio_w,
					cd_centro_custo_p,
					ds_compl_historico_p,
					ds_doc_agrupamento_p,
					nr_seq_agrupamento_p,
					null,
					null,
					null,
					null,
					'N');

end if;

select	count(*)
into STRICT	qt_registros_w
from	ctb_crit_rateio_proc
where	nr_seq_proc_interno = nr_seq_proc_interno_p
and	dt_movimento_p between dt_inicio_vigencia and coalesce(dt_fim_vigencia,dt_movimento_p);

open c01;
loop
fetch c01 into
	cd_centro_custo_w,
	vl_rateio_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	contador_w 	:= contador_w + 1;
	nr_seq_movto_w 	:= nr_seq_movto_w + 1;
	vl_rateio_total_w	:= vl_rateio_total_w + vl_rateio_w;

	if (contador_w = qt_registros_w) then

		if (vl_rateio_total_w > vl_material_p) then
			vl_rateio_w := vl_rateio_w - (vl_rateio_total_w - vl_material_p);
		elsif (vl_rateio_total_w < vl_material_p) then
			vl_rateio_w := vl_rateio_w + (vl_material_p - vl_rateio_total_w);
		end if;

	end if;

	insert into w_movimento_contabil(	nr_lote_contabil,
					nr_sequencia,
					cd_conta_contabil,
					ie_debito_credito,
					cd_historico,
					dt_movimento,
					vl_movimento,
					cd_centro_custo,
					ds_compl_historico,
					ds_doc_agrupamento,
					nr_seq_agrupamento,
					nr_seq_trans_fin,
					cd_cgc,
					cd_pessoa_fisica,
					nr_documento,
					ie_transitorio)
				values (	nr_lote_contabil_p,
					nr_seq_movto_w,
					cd_conta_contabil_p,
					'C',
					cd_historico_p,
					dt_movimento_p,
					vl_rateio_w,
					cd_centro_custo_w,
					ds_compl_historico_p,
					ds_doc_agrupamento_p,
					nr_seq_agrupamento_p,
					null,
					null,
					null,
					null,
					'N');

	end;
end loop;
close c01;

commit;

nr_seq_movto_p := nr_seq_movto_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_rateio_proc_interno ( nr_lote_contabil_p bigint, nr_seq_movto_p INOUT bigint, nr_seq_proc_interno_p bigint, cd_conta_contabil_p text, cd_historico_p bigint, dt_movimento_p timestamp, vl_material_p bigint, cd_centro_custo_p bigint, ds_compl_historico_p text, ds_doc_agrupamento_p text, nr_seq_agrupamento_p bigint) FROM PUBLIC;

