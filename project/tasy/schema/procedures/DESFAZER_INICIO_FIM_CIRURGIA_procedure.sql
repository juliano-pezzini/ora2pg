-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_inicio_fim_cirurgia (nr_cirurgia_p bigint, nr_seq_evento_p bigint, nm_usuario_p text) AS $body$
DECLARE

				
ie_atual_Inicio_cirurgia_w	varchar(1);
ie_atual_fim_cirurgia_w		varchar(1);
ie_inicia_cirurgia_w		varchar(1);
ie_finaliza_cirurgia_w		varchar(1);
cd_estabelecimento_w		smallint;
dt_entrada_unidade_w		timestamp;
nr_atendimento_w			bigint;
ie_ExcluirItensLancAuto_w	varchar(1);
cd_setor_atendimento_w		integer;
nr_seq_interno_w			bigint;
cd_unidade_basica_w			varchar(10);
cd_unidade_compl_w			varchar(10);
ds_sep_bv_w					varchar(100)	:= obter_separador_bv;
ds_param_integ_hl7_w		varchar(4000);
ie_inicia_integracao_w		varchar(1);
ie_finaliza_integracao_w	varchar(1);
ie_momento_integracao_w		varchar(15);
										

BEGIN

select	cd_estabelecimento,
		dt_entrada_unidade,
		nr_atendimento		
into STRICT	cd_estabelecimento_w,
		dt_entrada_unidade_w,
		nr_atendimento_w
from	cirurgia
where	nr_cirurgia = nr_cirurgia_p;

SELECT	coalesce(MAX(ie_momento_integracao),'IF')
INTO STRICT	ie_momento_integracao_w
FROM	parametros_pepo
WHERE	cd_estabelecimento = cd_estabelecimento_w;

select	max(cd_setor_atendimento),
		max(nr_seq_interno),
		MAX(cd_unidade_basica),
		MAX(cd_unidade_compl)
into STRICT	cd_setor_atendimento_w,
		nr_seq_interno_w,
		cd_unidade_basica_w,
		cd_unidade_compl_w		
from	atend_paciente_unidade
where	nr_atendimento	 = nr_atendimento_w
and	dt_entrada_unidade	 = dt_entrada_unidade_w;

ie_atual_inicio_cirurgia_w := obter_param_usuario(872, 85, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_atual_inicio_cirurgia_w);
ie_atual_fim_cirurgia_w := obter_param_usuario(872, 86, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_atual_fim_cirurgia_w);
ie_ExcluirItensLancAuto_w := obter_param_usuario(872, 225, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_ExcluirItensLancAuto_w);

select	coalesce(max(ie_inicia_cirurgia),'N'),
	coalesce(max(ie_inicia_integracao),'N'),
	coalesce(max(ie_finaliza_integracao),'N')
into STRICT	ie_inicia_cirurgia_w,
	ie_inicia_integracao_w,
	ie_finaliza_integracao_w
from	evento_cirurgia
where	nr_sequencia = nr_seq_evento_p;

if (ie_momento_integracao_w = 'TM') then

	if (ie_inicia_integracao_w = 'S') then
		begin
		ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || obter_pessoa_atendimento(nr_atendimento_w,'C') || ds_sep_bv_w ||
								'cd_setor_atendimento=' || cd_setor_atendimento_w || ds_sep_bv_w ||
								'cd_unidade_basica=' || cd_unidade_basica_w || ds_sep_bv_w ||
								'cd_unidade_compl=' || cd_unidade_compl_w || ds_sep_bv_w ||
								'cd_estabelecimento=' || cd_estabelecimento_w || ds_sep_bv_w;
		CALL gravar_agend_integracao(21, ds_param_integ_hl7_w, cd_setor_atendimento_w);
		
		exception
		when others then
				null;
		end;
	end if;
	
	if (ie_finaliza_integracao_w = 'S') then
		begin
		select	coalesce(max(nr_seq_interno),0)
		into STRICT	nr_seq_interno_w
		from	atend_paciente_unidade
		where	nr_atendimento		= nr_atendimento_w
		and		dt_entrada_unidade	= dt_entrada_unidade_w;

		if (nr_seq_interno_w > 0) then
			ds_param_integ_hl7_w := 'nr_atendimento=' || nr_atendimento_w || ds_sep_bv_w ||
									'nr_seq_interno=' || nr_seq_interno_w || ds_sep_bv_w||
									'cd_pessoa_fisica=' || obter_pessoa_atendimento(nr_atendimento_w,'C') || ds_sep_bv_w;
			CALL gravar_agend_integracao(20, ds_param_integ_hl7_w, cd_setor_atendimento_w);
		end if;
		
		exception
		when others then
			null;
		end;
	end if;
end if;


if (ie_atual_Inicio_cirurgia_w = 'S') then
	
	
	if (ie_inicia_cirurgia_w = 'S') then
		
		update	cirurgia
		set	ie_status_cirurgia	= 1,
			dt_entrada_unidade	 = NULL,
			dt_inicio_real	 = NULL,
			dt_termino	 = NULL,
			cd_tipo_cirurgia	 = NULL,
			ie_anat_patol	 = NULL,
			ie_trauma		 = NULL,
			ie_ortese_protese	 = NULL,
			ie_sangue	 = NULL,
			ie_antibiotico	 = NULL,
			ds_antibiotico	 = NULL,
         nm_usuario_antibiotico  = NULL,
			nr_min_duracao_real  = NULL
		where	nr_cirurgia	= nr_cirurgia_p;

		if (dt_entrada_unidade_w IS NOT NULL AND dt_entrada_unidade_w::text <> '') and (nr_atendimento_w > 0) then			
				
			if (ie_momento_integracao_w = 'IF') then
					
				begin
				ds_param_integ_hl7_w :=	'cd_pessoa_fisica=' || obter_pessoa_atendimento(nr_atendimento_w,'C') || ds_sep_bv_w ||
										'cd_setor_atendimento=' || cd_setor_atendimento_w || ds_sep_bv_w ||
										'cd_unidade_basica=' || cd_unidade_basica_w || ds_sep_bv_w ||
										'cd_unidade_compl=' || cd_unidade_compl_w || ds_sep_bv_w ||
										'cd_estabelecimento=' || cd_estabelecimento_w || ds_sep_bv_w;
				CALL gravar_agend_integracao(21, ds_param_integ_hl7_w, cd_setor_atendimento_w);
				
				exception
				when others then
						null;
				end;
			end if;
			
			
			delete	FROM atend_paciente_unidade
			where	nr_atendimento	= nr_atendimento_w
			and		dt_entrada_unidade = dt_entrada_unidade_w;
					
			
		end if;
			
		if (coalesce(ie_ExcluirItensLancAuto_w,'N') = 'S') then
			CALL excluir_item_conta_rla_cirurg(nr_atendimento_w, nr_cirurgia_p, cd_estabelecimento_w, nm_usuario_p);
		end if;

	end if;
	
end if;	
		
if (ie_atual_fim_cirurgia_w = 'S') then

	select	coalesce(max(ie_finaliza_cirurgia),'N')
	into STRICT	ie_finaliza_cirurgia_w
	from	evento_cirurgia
	where	nr_sequencia = nr_seq_evento_p;

	if (ie_finaliza_cirurgia_w = 'S') then
		update	cirurgia
		set	dt_termino	 = NULL,
			cd_tipo_cirurgia	 = NULL,
			ie_anat_patol	 = NULL,
			ie_trauma		 = NULL,
			ie_ortese_protese	 = NULL,
			ie_sangue	 = NULL,
			ie_antibiotico	 = NULL,
			ds_antibiotico	 = NULL,
         nm_usuario_antibiotico  = NULL,
			nr_min_duracao_real	 = NULL
		where	nr_cirurgia	= nr_cirurgia_p;

		if (dt_entrada_unidade_w IS NOT NULL AND dt_entrada_unidade_w::text <> '') and (nr_atendimento_w > 0) then
		
			if (ie_momento_integracao_w = 'IF') then
				begin
				select	coalesce(max(nr_seq_interno),0)
				into STRICT	nr_seq_interno_w
				from	atend_paciente_unidade
				where	nr_atendimento		= nr_atendimento_w
				and		dt_entrada_unidade	= dt_entrada_unidade_w;

				if (nr_seq_interno_w > 0) then
					ds_param_integ_hl7_w := 'nr_atendimento=' || nr_atendimento_w || ds_sep_bv_w ||
											'nr_seq_interno=' || nr_seq_interno_w || ds_sep_bv_w||
											'cd_pessoa_fisica=' || obter_pessoa_atendimento(nr_atendimento_w,'C') || ds_sep_bv_w;
					CALL gravar_agend_integracao(20, ds_param_integ_hl7_w, cd_setor_atendimento_w);
				end if;
				
				exception
				when others then
					null;
				end;
			end if;
		
			update	atend_paciente_unidade
			set	dt_saida_unidade	 = NULL
			where	nr_atendimento	= nr_atendimento_w
			and	dt_entrada_unidade	= dt_entrada_unidade_w;
		end if;

	end if;
end if;	
commit;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_inicio_fim_cirurgia (nr_cirurgia_p bigint, nr_seq_evento_p bigint, nm_usuario_p text) FROM PUBLIC;

