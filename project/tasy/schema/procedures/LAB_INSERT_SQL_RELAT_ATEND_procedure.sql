-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_insert_sql_relat_atend (nm_usuario_p text, cd_estabelecimento_p text, ie_tipo_relatorio_p INOUT text) AS $body$
DECLARE

 
ie_registro_w varchar(2):= 'N';
ie_lab_perfil_w integer;
cd_estabelecimento_w	smallint;


BEGIN 
	if (cd_estabelecimento_p = '0' or coalesce(cd_estabelecimento_p::text, '') = '') then 
		cd_estabelecimento_w := 1;
	else 
		cd_estabelecimento_w := cd_estabelecimento_p;
	end if;
 
	ie_lab_perfil_w := obter_param_usuario(80, 04, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_lab_perfil_w);
 
	select CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END  
	into STRICT ie_registro_w 
	from LAB_SQL_PAG_RELAT_WEB 
	where ie_relatorio = 'LARP';
 
	if (ie_registro_w = 'N') then 
			insert into lab_sql_pag_relat_web( nr_sequencia, 
				 dt_atualizacao_nrec, 
				 nm_usuario_nrec, 
				 dt_atualizacao, 
				 nm_usuario, 
				 ds_sql_quebra, 
				 ds_sql_registro, 
				 cd_empresa, 
				 cd_estabelecimento, 
				 qt_altura_banda_assinatura, 
				 ie_relatorio ) 
			values (nextval('lab_sql_pag_relat_web_seq'),  
				clock_timestamp(), 
				'TASY',  
				clock_timestamp(), 
				'TASY', 
				'SELECT DISTINCT' || Chr(13) || Chr(10) || 
				'		c.nr_prescricao,' || Chr(13) || Chr(10) || 
				'		b.nr_atendimento,' || Chr(13) || Chr(10) || 
				'		a.dt_nascimento as dt_nascimento,' || Chr(13) || Chr(10) || 
				'		a.ds_convenio,' || Chr(13) || Chr(10) || 
				'		obter_nome_setor(b.cd_setor_atendimento) ds_setor_coleta,' || Chr(13) || Chr(10) || 
				'		obter_nome_setor(b.cd_setor_atendimento) ds_setor_atendimento,' || Chr(13) || Chr(10) || 
				'		a.nm_paciente nm_paciente,' || Chr(13) || Chr(10) || 
				'		substr(obter_nome_pf(g.cd_pessoa_fisica), 0, 60) nm_medico,' || Chr(13) || Chr(10) || 
				'		f.nr_sequencia || DECODE(e.nm_usuario_liberacao,NULL,e.nm_usuario_aprovacao,e.nm_usuario_liberacao) vl_quebra' || Chr(13) || Chr(10) || 
				'FROM  pessoa_fisica g,' || Chr(13) || Chr(10) || 
				'		exame_laboratorio d,' || Chr(13) || Chr(10) || 
				'		material_exame_lab f,' || Chr(13) || Chr(10) || 
				'		atendimento_paciente_v a,' || Chr(13) || Chr(10) || 
				'		prescr_procedimento c,' || Chr(13) || Chr(10) || 
				'		prescr_medica b,' || Chr(13) || Chr(10) || 
				'		exame_lab_result_item e,' || Chr(13) || Chr(10) || 
				'		exame_lab_resultado h' || Chr(13) || Chr(10) || 
				'WHERE	a.nr_atendimento	= b.nr_atendimento' || Chr(13) || Chr(10) || 
				'AND	b.nr_prescricao		= c.nr_prescricao' || Chr(13) || Chr(10) || 
				'AND	c.cd_material_exame = f.cd_material_exame' || Chr(13) || Chr(10) || 
				'AND	b.cd_medico 		= g.cd_pessoa_fisica' || Chr(13) || Chr(10) || 
				'AND	c.nr_seq_exame		= d.nr_seq_exame' || Chr(13) || Chr(10) || 
				'AND	f.cd_material_exame = c.cd_material_exame' || Chr(13) || Chr(10) || 
				'AND	b.nr_prescricao 	= h.nr_prescricao' || Chr(13) || Chr(10) || 
				'AND	h.nr_seq_resultado 	= e.nr_seq_resultado' || Chr(13) || Chr(10) || 
				'AND	c.nr_sequencia 		= e.nr_seq_prescr' || Chr(13) || Chr(10) || 
				'AND	c.nr_seq_exame 		= e.nr_seq_exame' || Chr(13) || Chr(10) || 
				'AND	b.nr_atendimento	= :nr_atendimento' || Chr(13) || Chr(10) || 
				'AND	obter_ds_status_result_exame(c.nr_prescricao, c.nr_sequencia, :nm_usuario_cor, :cd_estabelecimento_cor) <> wheb_mensagem_pck.get_texto(308934)' || Chr(13) || Chr(10) || 
				'ORDER BY c.nr_prescricao', 
				'SELECT	a.ds_resultado, ' || Chr(13) || Chr(10) || 
				'		a.nr_sequencia' || Chr(13) || Chr(10) || 
				'FROM 	result_laboratorio a,' || Chr(13) || Chr(10) || 
				'		prescr_procedimento b,' || Chr(13) || Chr(10) || 
				'		exame_lab_result_item c,' || Chr(13) || Chr(10) || 
				'		exame_lab_resultado d' || Chr(13) || Chr(10) || 
				'WHERE	a.nr_prescricao  	= :nr_prescricao' || Chr(13) || Chr(10) || 
				'AND	b.nr_prescricao  	= a.nr_prescricao' || Chr(13) || Chr(10) || 
				'AND	a.nr_seq_prescricao	= b.nr_sequencia' || Chr(13) || Chr(10) || 
				'AND	c.nr_seq_prescr 	= b.nr_sequencia' || Chr(13) || Chr(10) || 
				'AND	b.nr_prescricao 	= d.nr_prescricao' || Chr(13) || Chr(10) || 
				'AND	d.nr_seq_resultado 	= c.nr_seq_resultado' || Chr(13) || Chr(10) || 
				'AND	c.nr_seq_material || DECODE(c.nm_usuario_liberacao,NULL,c.nm_usuario_aprovacao,c.nm_usuario_liberacao) = :vl_quebra' || Chr(13) || Chr(10) || 
				'AND	obter_ds_status_result_exame(a.nr_prescricao,b.nr_sequencia,:nm_usuario_cor, :cd_estabelecimento_cor) <> wheb_mensagem_pck.get_texto(308934)', 
			 1, 
			 cd_estabelecimento_w, 
			 50, 
			 'LARP'); 	 		
 	end if;	
 
	select CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END  
	into STRICT ie_tipo_relatorio_p 
 	from RELATORIO_PERFIL a, 
 		 relatorio b 
	where cd_perfil = ie_lab_perfil_w 
	and  a.nr_seq_relatorio = b.nr_sequencia 
	and  b.CD_CLASSIF_RELAT = 'CLAB' 
	and  b.CD_RELATORIO_WHEB = 353 
	and  a.ie_imprimir = 'S'; 	
 
 	 
commit;	 	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_insert_sql_relat_atend (nm_usuario_p text, cd_estabelecimento_p text, ie_tipo_relatorio_p INOUT text) FROM PUBLIC;

