-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_ent_calendario_planej ( nr_solic_compra_p bigint, nr_item_solic_compra_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_estabelecimento_w			smallint;
nr_item_solic_compra_entr_w			integer;
dt_entrega_solicitada_w			timestamp;
dt_entrega_solicitada_ww			timestamp;
cd_dia_semana_w				bigint;
cd_dia_semana_regra_w			bigint;
ie_forma_ajuste_w				varchar(1);
ie_achou_dia_semana_w			boolean 		:= False;
nr_entrega_w				bigint 	:= 0;

c01 CURSOR FOR 
SELECT	b.nr_item_solic_compra_entr, 
	trunc(b.dt_entrega_solicitada,'dd'), 
	obter_cod_dia_semana(b.dt_entrega_solicitada) cd_dia_semana, 
	sup_obter_planej_calendario(cd_estabelecimento_w,a.cd_material,'D') cd_dia_semana_regra, 
	sup_obter_planej_calendario(cd_estabelecimento_w,a.cd_material,'A') ie_forma_ajuste 
from	solic_compra_item a, 
	solic_compra_item_entrega b 
where	a.nr_solic_compra = b.nr_solic_compra 
and	a.nr_item_solic_compra = b.nr_item_solic_compra 
and	a.nr_solic_compra = nr_solic_compra_p 
and	a.nr_item_solic_compra = nr_item_solic_compra_p 
and	(sup_obter_planej_calendario(cd_estabelecimento_w,a.cd_material,'D') IS NOT NULL AND (sup_obter_planej_calendario(cd_estabelecimento_w,a.cd_material,'D'))::text <> '') 
order by dt_entrega_solicitada;		
 

BEGIN 
 
select	cd_estabelecimento 
into STRICT	cd_estabelecimento_w 
from	solic_compra 
where	nr_solic_compra = nr_solic_compra_p;
 
open C01;
loop 
fetch C01 into	 
	nr_item_solic_compra_entr_w, 
	dt_entrega_solicitada_w, 
	cd_dia_semana_w, 
	cd_dia_semana_regra_w, 
	ie_forma_ajuste_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	ie_achou_dia_semana_w		:= false;	
	nr_entrega_w			:= nr_entrega_w + 1;
	 
	if (nr_entrega_w = 1) and (cd_dia_semana_w <> cd_dia_semana_regra_w) then /* na primeira entrega, posiciono no dia da semana conforme a regra*/
 
		dt_entrega_solicitada_ww 	:= dt_entrega_solicitada_w;		
		while(not ie_achou_dia_semana_w) loop /*para dia a dia até achar o dia da semana conforme a regra*/
 
			begin			 
			if (ie_forma_ajuste_w = 'A') then /*Se for A - Acrescenta um dia, para ir procurando o dia da semana para frente*/
 
				dt_entrega_solicitada_ww := dt_entrega_solicitada_ww + 1;
			else	/*Se não for A - Diminiu um dia, para ir procurando o dia da semana para trás*/
 
				dt_entrega_solicitada_ww := dt_entrega_solicitada_ww - 1;
			end if;
			 
			if (obter_cod_dia_semana(dt_entrega_solicitada_ww) = cd_dia_semana_regra_w) then /*Quando achou o dia, seta a variavel para Tru para cair fora do while*/
 
				ie_achou_dia_semana_w := true;
			end if;	
			end;
		end loop;
	else 
		if (nr_entrega_w = 1) then /*Se a primeira entrega ja for no dia da semana da regra, entrão grava ela mesmo*/
 
			dt_entrega_solicitada_ww := dt_entrega_solicitada_w;
		else 
			dt_entrega_solicitada_ww := dt_entrega_solicitada_ww + 7;
		end if;
	end if;
 
	update	solic_compra_item_entrega 
	set	dt_entrega_solicitada = dt_entrega_solicitada_ww 
	where	nr_solic_compra = nr_solic_compra_p 
	and	nr_item_solic_compra = nr_item_solic_compra_p 
	and	nr_item_solic_compra_entr = nr_item_solic_compra_entr_w;
 
	end;
end loop;
close C01;
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_ent_calendario_planej ( nr_solic_compra_p bigint, nr_item_solic_compra_p bigint, nm_usuario_p text) FROM PUBLIC;

