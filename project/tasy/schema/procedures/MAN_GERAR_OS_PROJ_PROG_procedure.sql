-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_os_proj_prog ( nr_seq_projeto_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
nr_sequencia_w		bigint;
nm_usuario_exec_w		varchar(15);
nr_seq_gerencia_w		bigint;
cd_estabelecimento_w	smallint;
nr_seq_grupo_des_w		bigint;
nr_seq_cliente_w		bigint;
nr_seq_localizacao_w	bigint;
nr_seq_equipamento_w	bigint;
nr_seq_proj_cron_etp_w	bigint;
cd_funcao_w		integer;
ds_etapa_w		varchar(4000);
ds_atividade_w		varchar(255);
cd_coordenador_w		varchar(10);
nr_seq_ordem_w		bigint;
nr_seq_projeto_w		bigint;

C01 CURSOR FOR 
	SELECT	nr_sequencia, 
		p.nr_seq_cliente, 
		p.cd_estabelecimento, 
		p.cd_funcao, 
		substr(obter_usuario_pessoa(p.cd_coordenador),1,15), 
		p.cd_coordenador, 
		p.nr_seq_grupo_des 
	from 	proj_projeto p 
	Where 	1 = 1 
	and 	ie_status = 'E' 
	and 	ie_origem = 'D' 
	and 	coalesce(ie_nivel_projeto,0) <> '3' 
	and	nr_sequencia = nr_seq_projeto_p 
	and	nr_seq_estagio <> 17 
	and	p.nr_seq_classif <> 14;

C02 CURSOR FOR 
	SELECT	e.nr_sequencia, 
		coalesce(e.ds_etapa,e.ds_atividade) ds_etapa, 
		e.ds_atividade 
	from	proj_projeto p, 
		proj_cronograma c, 
		proj_cron_etapa e 
	where	p.nr_sequencia = nr_seq_projeto_w 
	and	p.nr_sequencia = c.nr_seq_proj 
	and	c.nr_sequencia = e.nr_seq_cronograma 
	and	c.ie_tipo_cronograma = 'E' 
	and	c.ie_situacao = 'A' 
	and 	e.pr_etapa <> 100 
	and	(c.dt_aprovacao IS NOT NULL AND c.dt_aprovacao::text <> '') 
	and	trunc(e.dt_inicio_prev) = trunc(clock_timestamp()) 
	and    not exists (	SELECT	1 
				from	man_ordem_servico_v x 
				where	x.nr_seq_proj_cron_etapa = e.nr_sequencia) 
	and	not exists (	select	1 
			from	proj_cron_etapa x 
			where	x.nr_seq_superior = e.nr_sequencia) 
	and	coalesce(c.IE_GERA_ORDEM_AUTO,'A')	<> 'N';


BEGIN 
 
open C01;
loop 
fetch C01 into 
	nr_seq_projeto_w, 
	nr_seq_cliente_w, 
	cd_estabelecimento_w, 
	cd_funcao_w, 
	nm_usuario_exec_w, 
	cd_coordenador_w, 
	nr_seq_grupo_des_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	select	coalesce(max(a.nr_sequencia),1272) 
	into STRICT	nr_seq_localizacao_w 
	from	com_cliente b, 
		man_localizacao a 
	where	a.cd_cnpj = b.cd_cnpj 
	and	b.nr_sequencia = nr_seq_cliente_w;
 
	nr_seq_equipamento_w:= 5267;
 
	if (nr_seq_cliente_w = 5075) then 
 
		if (cd_estabelecimento_w = 22) then 
		 
			nr_seq_localizacao_w := 4976;
			select	max(nr_sequencia) 
			into STRICT	nr_seq_equipamento_w 
			from	man_equipamento 
			where	nr_seq_local = nr_seq_localizacao_w;
			 
		elsif (cd_estabelecimento_w = 1) then 
		 
			nr_seq_localizacao_w := 1272;
			nr_seq_equipamento_w := 1395;
			 
		else 
 
			nr_seq_localizacao_w := 4604;
			nr_seq_equipamento_w := 4758;	
			 
		end if;
	end if;
 
	open C02;
	loop 
	fetch C02 into	 
		nr_seq_proj_cron_etp_w, 
		ds_etapa_w, 
		ds_atividade_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		 
		nr_seq_ordem_w := man_gerar_os_proj_etapa(nr_seq_ordem_w, /*nr_sequencia_w*/
 
				cd_coordenador_w, /*cd_pessoa_solicitante_p*/
 
				nr_seq_localizacao_w, /*nr_seq_localizacao_p*/
 
				nr_seq_equipamento_w, /*nr_seq_equipamento_p*/
 
				'Proj. ' ||nr_seq_projeto_w|| ' - ' || ds_atividade_w, /*ds_dano_breve_p*/
 
				coalesce(ds_etapa_w,ds_atividade_w), /*ds_dano_p*/
 
				cd_funcao_w, /*cd_funcao_p*/
 
				'S', /*ie_classificacao_p*/
 
				'U', /*ie_forma_receb_p*/
 
				clock_timestamp() + interval '1 days', /*dt_inicio_previsto_p*/
 
				clock_timestamp() + interval '20 days', /*dt_fim_previsto_p*/
 
				4, /*nr_seq_estagio_p*/
 
				'1', /*ie_tipo_ordem_p*/
 
				'1', /*nr_grupo_planej_p*/
 
				'1', /*nr_grupo_trabalho_p*/
 
				'M', /*ie_prioridade_p*/
 
				'1', /*ie_status_ordem_p*/
 
				substr(obter_usuario_pessoa(cd_coordenador_w),1,15), /*nm_usuario_p*/
 
				nr_seq_proj_cron_etp_w, /*nr_seq_proj_cron_etapa_p*/
 
				nr_seq_grupo_des_w, /*nr_seq_grupo_des_p*/
 
				nr_seq_projeto_w, /*nr_seq_projeto_w*/
 
				10, null, null, cd_estabelecimento_w); 						/*nr_seq_ativ_exec_p*/
			 
		end;
	end loop;
	close C02;	
	 
	end;
end loop;
close C01;
 
commit;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_os_proj_prog ( nr_seq_projeto_p bigint, nm_usuario_p text) FROM PUBLIC;

