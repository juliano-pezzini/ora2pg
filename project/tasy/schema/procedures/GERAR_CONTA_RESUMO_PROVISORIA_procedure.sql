-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_conta_resumo_provisoria ( dt_referencia_p timestamp, ds_parametros_p text, nm_usuario_p text) AS $body$
DECLARE


C01					integer;
Ignore				integer;
nr_interno_conta_w		bigint;
dt_inicio_w				timestamp;
dt_final_w				timestamp;


BEGIN

dt_inicio_w	:= trunc(dt_referencia_p, 'month');
dt_final_w	:= trunc(last_day(dt_referencia_p),'dd') + 86399/86400;

delete from CONTA_PACIENTE_RESUMO_IMP imp
where imp.nr_interno_conta in (
    SELECT nr_interno_conta
    from conta_paciente
    where dt_mesano_referencia between dt_inicio_w and dt_final_w
    and ie_status_acerto = 1
    );
delete from conta_paciente_resumo
where nr_interno_conta in (	SELECT nr_interno_conta
					from conta_paciente
					where dt_mesano_referencia between dt_inicio_w and dt_final_w
					  and ie_status_acerto = 1);

C01 := DBMS_SQL.OPEN_CURSOR;
DBMS_SQL.PARSE(C01,	'select a.nr_interno_conta ' ||
				'from	atendimento_paciente c, conta_paciente a ' ||
				'where a.nr_atendimento = c.nr_atendimento ' ||
				'  and a.ie_status_acerto = 1 ' ||
	  			'  and a.dt_mesano_referencia between sysdate - 41 and sysdate - 10 ' ||
				ds_parametros_p, DBMS_SQL.Native);
RAISE NOTICE '%', ds_parametros_p;
DBMS_SQL.DEFINE_COLUMN(C01, 1, nr_interno_conta_w);
ignore := DBMS_SQL.EXECUTE(C01);

LOOP
	IF (DBMS_SQL.FETCH_ROWS(C01) > 0) THEN 
		DBMS_SQL.COLUMN_VALUE(C01, 1, nr_interno_conta_w);
		CALL Atualizar_Resumo_Conta(nr_interno_conta_w, 2);
	ELSE
		EXIT;
	END IF;
END LOOP;

COMMIT;
DBMS_SQL.CLOSE_CURSOR(C01);

EXCEPTION
	WHEN OTHERS THEN 
		IF DBMS_SQL.IS_OPEN(C01) THEN 
			DBMS_SQL.CLOSE_CURSOR(C01);
		END IF;
		RAISE;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_conta_resumo_provisoria ( dt_referencia_p timestamp, ds_parametros_p text, nm_usuario_p text) FROM PUBLIC;

