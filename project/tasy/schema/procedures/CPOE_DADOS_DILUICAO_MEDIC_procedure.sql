-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_dados_diluicao_medic ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, cd_material_p bigint, qt_dose_p bigint, cd_unid_med_dose_p text, cd_intervalo_p text, ie_via_aplicacao_p text, qt_solucao_p bigint, hr_min_aplicacao_p text, ie_se_necessario_p text, ie_fator_correcao_p text, ie_bomba_infusao_p text, nr_seq_mat_dil_p bigint, cd_mat_dil_p bigint, qt_dose_dil_p bigint, cd_unid_med_dose_dil_p text, qt_solucao_dil_p bigint, nr_seq_mat_red_p bigint, cd_mat_red_p bigint, qt_dose_red_p bigint, cd_unid_med_dose_red_p text, qt_solucao_red_p bigint, nr_seq_mat_recons_p bigint, cd_mat_recons_p bigint, qt_dose_recons_p bigint, cd_unid_med_dose_recons_p text, qt_solucao_recons_p bigint, ie_tipo_dosagem_p text, qt_dosagem_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, ds_retorno_p out text, qt_vel_infusao_p out bigint, ie_tipo_dosagem_out_p out text, qt_minutos_aplicacao_p out bigint, ds_dose_diferenciada_p text default null, ds_dose_diferenciada_dil_p text default null, ds_dose_diferenciada_red_p text default null, ds_dose_diferenciada_rec_p text default null, ds_horarios_p text default null, ie_change_vol_p text default null, ie_tipo_material_p text default null) is type v_base_ds_diluicao is record (ds_diluicao varchar(255)) AS $body$
BEGIN
		if (nr_casas_diluicao_w > 0) then
			return;
		end if;

		return;
	end;

BEGIN

cd_estabelecimento_w := coalesce(cd_estabelecimento_p,0);
cd_setor_prescr_w := cpoe_obter_setor_atend_prescr(nr_atendimento_p, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p);

/*  ATENCAO
* Cuidado ao alterar tratamento abaixo
* Calcula qt_minutos total para admisnitracao do item, conforme seu cadastro e dose do item prescrito.
* ie_tipo_material_p
*/
if (ie_tipo_material_p = 'MA' and (coalesce(hr_min_aplicacao_p::text, '') = '' or coalesce(ie_change_vol_p,'N') = 'S')) then

	qt_minutos_aplicacao_p := CPOE_obter_regra_padrao(cd_material_p, cd_perfil_p, nm_usuario_p, ie_via_aplicacao_p,
												  ie_se_necessario_p, cd_estabelecimento_p, nr_atendimento_p, cd_pessoa_fisica_p,
												  cd_intervalo_p, qt_dose_p, cd_unid_med_dose_p,1);

	if (qt_minutos_aplicacao_p <= 0) then
		qt_minutos_aplicacao_p	:= null;
		qt_hora_aplicacao_w := (substr(hr_min_aplicacao_p,1,2))::numeric;
		qt_min_aplicacao_w  := (substr(hr_min_aplicacao_p,4,2))::numeric;
	else
		if (qt_minutos_aplicacao_p > 0 ) then

			if (qt_minutos_aplicacao_p < 60) then
				qt_min_aplicacao_w 		:= qt_minutos_aplicacao_p;

			elsif (qt_minutos_aplicacao_p = 60) then
				qt_hora_aplicacao_w 	:= 1;
			else
				qt_hora_aplicacao_w		:= trunc(dividir(qt_minutos_aplicacao_p,60));
				qt_min_aplicacao_w 		:= (qt_minutos_aplicacao_p - (qt_hora_aplicacao_w * 60));
			end if;
		end if;
	end if;
else
	qt_hora_aplicacao_w := (substr(hr_min_aplicacao_p,1,2))::numeric;
	qt_min_aplicacao_w  := (substr(hr_min_aplicacao_p,4,2))::numeric;

end if;

/*Fim*/



/* Rotina desmembramento horarios */

ds_horario_w := substr(ds_horarios_p || ' ',1,4000);

while(ds_horario_w IS NOT NULL AND ds_horario_w::text <> '') loop
	ds_horario_ww := substr(ds_horario_w, 1, position(' ' in ds_horario_w) - 1);
	ds_horario_w := substr(ds_horario_w, position(' ' in ds_horario_w) + 1, length(ds_horario_w));

	nr_count_hor_w := nr_count_hor_w + 1;
	if (length(ds_horario_ww) = 2) then
	  ds_horario_ww := ds_horario_ww || ':00';
	end if;
	ds_horario_record_w[nr_count_hor_w].ds_horario := Wheb_mensagem_pck.get_texto(341494, 'HORA=' || ds_horario_ww) || ' ';
end loop;
/* Fim */

ds_diluicao_edit_w	:= '';
cd_mat_ww		:= cd_material_p;
qt_dose_medic_w		:= coalesce(obter_conversao_ml(cd_material_p, qt_dose_p, cd_unid_med_dose_p), qt_dose_p);

select	max(coalesce(b.ie_aplicar,'S'))
into STRICT	ie_aplicar_medic_w
from	material b
where	b.cd_material = cd_material_p;

if (cd_mat_dil_p IS NOT NULL AND cd_mat_dil_p::text <> '') then
	qt_dose_dil_w := coalesce(qt_dose_dil_p,0);
end if;

if (coalesce(ds_diluicao_edit_w::text, '') = '') then

	ie_possui_diluente_w	:= 'N';

	if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then
		qt_dose_mat_w			:= qt_dose_p;
		cd_unid_med_dose_mat_w		:= cd_unid_med_dose_p;
		qt_solucao_ww			:= qt_solucao_p;
		cd_unidade_medida_w		:= cd_unid_med_dose_p;
		cd_medic_w			:= cd_material_p;
		cd_intervalo_w			:= cd_intervalo_p;
		ie_via_aplicacao_w			:= ie_via_aplicacao_p;
		ds_dose_diferenciada_w		:= ds_dose_diferenciada_p;
		ie_indice_w			:= 1;
		ds_hora_w			:= null;
		ie_ordem_w			:= 1;
		qt_diluicao_aux_w			:= 0;
		cd_unid_med_diluente_aux_w	:= null;
		ie_agrupador_ww			:= 1;
		qt_volume_equipo_w		:= Obter_vol_Dispositivo_solucao(ie_bomba_infusao_p);
		ie_fator_Correcao_w		:= coalesce(ie_fator_correcao_p,'N');
		qt_dose_especial_w		:= 0;
		qt_min_aplic_dose_esp_w		:= 0;

		select	coalesce(max(qt_conversao),1)
		into STRICT	qt_conversao_w
		from	material_conversao_unidade
		where	cd_material		= cd_medic_w
		and	cd_unidade_medida	= cd_unid_med_dose_mat_w;

		qt_unit_medic_w := (qt_dose_mat_w / qt_conversao_w);

		if (coalesce(ie_fator_Correcao_w,'N') = 'S') and (coalesce(qt_volume_equipo_w,0) > 0) and (coalesce(qt_dose_medic_w,0) > 0) and (coalesce(qt_dose_dil_w,0) > 0) then
			qt_total_w	:= qt_dose_medic_w + qt_dose_dil_w;
			-- Regra de 3 - pegar o % que a dose do medicamento representa em relacao a dose total somada com o diluente
			qt_dose_aux_w	:= dividir((qt_dose_medic_w * 100), qt_total_w);
			-- Regra de 3 para ver quanto sera repassado a dose do medicamento, de acordo com o percentual que a dose representa */
			qt_conv_ml_w	:= dividir((qt_dose_aux_w * qt_volume_equipo_w), 100) + qt_dose_medic_w;
		else
			qt_conv_ml_w	:= obter_conversao_ml(cd_medic_w,qt_dose_mat_w,cd_unid_med_dose_mat_w);
		end if;

		if (coalesce(qt_conv_ml_w,0) = 0) then
			qt_conv_ml_w	:= obter_conversao_ml(cd_medic_w,qt_dose_mat_w,cd_unid_med_dose_mat_w);
		end if;

		select	coalesce(max(nr_casas_diluicao),0),
			coalesce(max(ie_separar),'S'),
			coalesce(max(ie_administrar_ui),'N'),
			coalesce(max(ie_aplicar),'N'),
			coalesce(max(ie_descr_redu_dil),'N'),
			coalesce(max(ie_mostrar_estabilidade),'N'),
			coalesce(max(ie_apres_vol_reconst),'N'),
			coalesce(max(ie_mostrar_aplic_ataque),'N'),
			coalesce(max(ie_mostrar_foto),'S'),
			coalesce(max(ie_mostrar_concentracao),'N')
		into STRICT	nr_casas_diluicao_w,
			ie_separar_w,
			ie_administrar_ui_w,
			ie_aplicar_w,
			ie_descr_redu_dil_w,
			ie_mostrar_estabilidade_w,
			ie_apres_vol_reconst_w,
			ie_mostrar_aplic_ataque_w,
			ie_mostrar_foto_w,
			ie_mostrar_concentracao_w
		from	parametro_medico
		where	cd_estabelecimento	= cd_estabelecimento_w;

		nr_casas_w	:= obter_casas_diluicao(cd_mat_ww, cd_setor_prescr_w);

		if (nr_casas_w > 0) then
			nr_casas_diluicao_w	:= nr_casas_w;
		end if;


		if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') then
			select	max(ds_prescricao)
			into STRICT	ds_intervalo_w
			from	intervalo_prescricao
			where	cd_intervalo	= cd_intervalo_w;

			if (ie_via_aplicacao_w IS NOT NULL AND ie_via_aplicacao_w::text <> '') then
				ds_intervalo_w	:= ds_intervalo_w ||' '||ie_via_aplicacao_w;
			end if;
		end if;

		select	coalesce(max(ie_um_prescrita),'N')
		into STRICT	ie_um_prescrita_w
		from	regra_unid_med_diluente
		where	cd_setor_atendimento 				= cd_setor_prescr_w
		and	coalesce(cd_unidade_medida,cd_unid_med_dose_mat_w)	= cd_unid_med_dose_mat_w;

		if (ie_um_prescrita_w = 'S') then
			qt_conv_ml_w	:= 0;
		end if;

		if (qt_conv_ml_w > 0) then
			qt_dose_diluido_w	:= obter_valor_round_decimais(qt_conv_ml_w);
			ds_conv_ml_w	:= to_char(qt_dose_diluido_w) || ' ml';

			if (qt_conv_ml_w < 1) then
				ds_conv_ml_w		:= '0' || ds_conv_ml_w;
			end if;
		end if;

		qt_dose_mat_str_w	:= qt_dose_mat_w;

		open c01;
		loop
		fetch c01 into
			cd_material_w,
			qt_dose_w,
			qt_vol_adic_reconst_w,
			cd_unid_med_dose_w,
			ie_agrupador_w,
			qt_solucao_w,
			qt_dose_ml_w,
			ds_material_ww,
			ds_reduzida_w,
			ie_ConsisteDoseConsumoMedic_w,
			qt_volume_cad_w,
			qt_concentracao_total_w,
			cd_unid_med_concetracao_w,
			cd_unid_med_base_conc_w,
			ie_proporcao_w,
			qt_volume_medic_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin

			if (ie_ConsisteDoseConsumoMedic_w = 'N') and (coalesce(ie_proporcao_w,'F') = 'F') and (coalesce(qt_volume_medic_w,0) > 0) then
			   qt_conv_ml_w := qt_volume_medic_w;
			end if;

			if (ie_agrupador_w = 3) and (coalesce(ie_fator_Correcao_w,'N') = 'S') and (coalesce(qt_volume_equipo_w,0) > 0) and (coalesce(qt_dose_medic_w,0) > 0) and (coalesce(qt_dose_ml_w,0) > 0) then
				qt_total_w	:= qt_dose_medic_w + qt_dose_ml_w;
				-- Regra de 3 - pegar o % que a dose do medicamento representa em relacao a dose total somada com o diluente
				qt_dose_aux_w	:= dividir((qt_dose_ml_w * 100), qt_total_w);
				-- Regra de 3 - para ver quanto sera repassado a dose do medicamento, de acordo com o percentual que a dose representa
				qt_dose_ml_w	:= dividir((qt_dose_aux_w * qt_volume_equipo_w), 100) + qt_dose_ml_w;
			end if;

			if (qt_unit_medic_w = 0) then
				qt_unit_medic_div_w	:= 1;
			else
				qt_unit_medic_div_w	:= qt_unit_medic_w;
			end if;

			if (ie_ConsisteDoseConsumoMedic_w = 'S') then

				qt_dose_mat_w	:= obter_dose_convertida(cd_medic_w, ceil(qt_unit_medic_w),
									cd_unidade_medida_w,cd_unid_med_dose_mat_w);

				qt_conv_ml_w	:= obter_conversao_ml(cd_medic_w,qt_dose_mat_w,cd_unid_med_dose_mat_w);

				select	coalesce(max(ie_um_prescrita),'N')
				into STRICT	ie_um_prescrita_w
				from	regra_unid_med_diluente
				where	cd_setor_atendimento 				= cd_setor_prescr_w
				and	coalesce(cd_unidade_medida,cd_unid_med_dose_mat_w)	= cd_unid_med_dose_mat_w;

				if (ie_um_prescrita_w = 'S') then
					qt_conv_ml_w	:= 0;
				end if;

				if (qt_conv_ml_w > 0) and (upper(cd_unid_med_dose_mat_w) <> 'ML') then
					qt_dose_diluido_w	:= obter_valor_round_decimais(qt_conv_ml_w);
					ds_conv_ml_w	:= to_char(qt_dose_diluido_w) || ' ml';

					if (qt_conv_ml_w < 1) then
						ds_conv_ml_w	:= '0' || ds_conv_ml_w;
					end if;
				end if;

				qt_dose_mat_str_w	:= qt_dose_mat_w;
			else
				--Dose do diluente sempre deve ser apresentando em ml.
				qt_dose_mat_str_w 	:= obter_conversao_ml(cd_medic_w,qt_dose_mat_w,cd_unid_med_dose_mat_w);
			end if;

			/* ***** Trocar pelo metodo do reconstituir ***** */


			/*ds_reconstituir_w := 'Reconstituir cada cp em 500 ml de Soro Fisiologico.' || chr(13) || chr(10);*/

			if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 9) and (coalesce(qt_registro_w,0) = 0) then
				begin
					qt_conv_ml_w	:= obter_conversao_ml(cd_material_w,qt_dose_w + qt_vol_adic_reconst_w,cd_unid_med_dose_w);

					select	coalesce(max(ie_um_prescrita),'N')
					into STRICT	ie_um_prescrita_w
					from	regra_unid_med_diluente
					where	cd_setor_atendimento 			= cd_setor_prescr_w
					and	coalesce(cd_unidade_medida,cd_unid_med_dose_w)	= cd_unid_med_dose_w;

					if (ie_um_prescrita_w = 'S') then
						qt_conv_ml_w	:= 0;
					end if;

					qt_conv_ml_aux_w	:= obter_conversao_ml(cd_medic_w,qt_dose_mat_w,cd_unid_med_dose_mat_w);

					if (qt_conv_ml_aux_w > 0) then
						begin
							qt_conv_ml_w	:= qt_conv_ml_aux_w;
						end;
					else
						begin
							if (upper(cd_unid_med_dose_mat_w) = 'ML') then
								begin
								qt_conv_ml_w		:= qt_dose_mat_w;
								end;
							else
								begin
								qt_dose_unid_med_cons_w	:= obter_conversao_unid_med_cons(cd_medic_w,cd_unid_med_dose_mat_w,qt_dose_mat_w);
								qt_conv_ml_w		:= qt_dose_unid_med_cons_w * qt_conv_ml_w;
								end;
							end if;
						end;
					end if;

					if (coalesce(ie_fator_Correcao_w,'N') = 'S') and (coalesce(qt_volume_equipo_w,0) > 0) and (coalesce(qt_dose_medic_w,0) > 0) and (coalesce(qt_dose_ml_w,0) > 0) then
						-- Regra de 3 para ver quanto sera repassado a dose do medicamento, de acordo com o percentual que a dose representa
						qt_conv_ml_w	:= dividir((qt_dose_aux_w * qt_volume_equipo_w), 100) + qt_conv_ml_w;
					end if;

					if (qt_conv_ml_w > 0) then
						qt_dose_diluido_w	:= obter_valor_round_decimais(qt_conv_ml_w);
						ds_conv_ml_w	:= to_char(qt_dose_diluido_w) || ' ml';

						if (qt_conv_ml_w < 1) then
							ds_conv_ml_w	:= '0' || ds_conv_ml_w;
						end if;
					end if;

					if (ie_descr_redu_dil_w = 'S') then
						ds_material_w	:= ds_reduzida_w;
					else
						ds_material_w	:= ds_material_ww;
					end if;

					if (qt_dose_w < 1) or (mod(qt_dose_w, trunc(qt_dose_w)) <> 0) then
						mascara_w	:= 0;
					else
						mascara_w	:= 1;
					end if;

					if (nr_casas_diluicao_w > 3) then
						nr_casas_diluicao_w := 3;
					end if;

					if (mascara_w = 0) then
						qt_dose_str_w	:= campo_mascara(qt_dose_w, nr_casas_diluicao_w);
					else
						qt_dose_str_w	:= campo_mascara(qt_dose_w, 0);
					end if;


					select	max(cd_unidade_medida_consumo),
								substr(max(ds_material),1,100) ds_material								
					into STRICT	cd_unidade_medida_consumo_w,
							ds_material_princ_w
					from	material
					where	cd_material	= cd_medic_w;

					if (ie_apres_vol_reconst_w = 'S') and (qt_vol_adic_reconst_w > 0) then

						qt_volume_adic_w	:= obter_conversao_ml(cd_material_w,qt_dose_w + qt_vol_adic_reconst_w,cd_unid_med_dose_w);

						ds_total_reconst_w := ' ' ||Wheb_mensagem_pck.get_texto(307022, 'QT_VOLUME_ADIC_W='||qt_volume_adic_w); --' (Volume total apos reconstituicao '|| qt_volume_adic_w ||' ml).';
					end if;

					/*	Atencao
					*
					* Tratamento abaixo tem objetivo de gerar orientacao de preparo do reconstituente.
					* Esta diferente da rotina original, pois nao precisa apresentar a conversao e apenas
					* a unidade de medida de consumo.
					*
					*/


					-- #@DS_RECONSTITUIR_W#@Reconstituir cada #@CD_UNIDADE_MEDIDA_W#@ em #@QT_DOSE_STR_W#@ #@CD_UNID_MED_DOSE_W#@ de #@DS_MATERIAL_W#@#@DS_TOTAL_RECONST_W#@
					ds_reconstituir_w :=	Wheb_mensagem_pck.get_texto(307055,
												'DS_RECONSTITUIR_W=' || ds_reconstituir_w ||
												';CD_UNIDADE_MEDIDA_W=' || cd_unidade_medida_consumo_w ||
												';DS_MAT_PRINC_W='|| ds_material_princ_w ||
												';QT_DOSE_STR_W=' || replace(qt_dose_str_w,'.',',') ||
												';CD_UNID_MED_DOSE_W=' || cd_unid_med_dose_w ||
												';DS_MATERIAL_W=' || ds_material_w ||
												';DS_TOTAL_RECONST_W=' || coalesce(ds_total_reconst_w,'.')
											) || chr(13) || chr(10);

				end;
			end if;

			/* ***** Trocar pelo metodo do reconstituir ***** */



			/* ***** Retirado rotina com indice 2 => nunca ira entrar ***** */

			if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 3) then
			   	begin

				select	coalesce(max(ie_um_prescrita),'N')
				into STRICT	ie_um_prescrita_w
				from	regra_unid_med_diluente
				where	cd_setor_atendimento 				= cd_setor_prescr_w
				and	coalesce(cd_unidade_medida,cd_unid_med_dose_mat_w)	= cd_unid_med_dose_mat_w;

				if (ie_um_prescrita_w = 'S') then
					qt_dose_ml_w	:= 0;
				end if;

				qt_ml_diluente_w	:= qt_dose_ml_w;

				if (ie_descr_redu_dil_w = 'S') then
					ds_material_w	:= ds_reduzida_w;
				else
					ds_material_w	:= ds_material_ww;
				end if;

				if (ie_agrupador_ww = 8) or (ie_agrupador_ww = 12) then
					-- do produto
					ds_aux_diluir_w	:= ' ' || Wheb_mensagem_pck.get_texto(307082);
				else
					-- do medicamento
					ds_aux_diluir_w	:= ' ' || Wheb_mensagem_pck.get_texto(307083);
				end if;

				if (ds_reconstituir_w IS NOT NULL AND ds_reconstituir_w::text <> '') then
					-- da reconstituicao
					ds_aux_diluir_w	:= ' ' || Wheb_mensagem_pck.get_texto(307085);
				end if;

				qt_dose_diluicao_w		:= replace(obter_valor_round_decimais(qt_dose_ml_w),'.',',');
				ds_dose_diluicao_w	:=  qt_dose_diluicao_w || ' ml';

				if (qt_dose_ml_w = 0) then
					ds_dose_diluicao_w	:= replace(qt_dose_w,'.',',') || ' ' || cd_unid_med_dose_w;
				end if;

				if (coalesce(qt_solucao_w,0) > 0) then
					if (qt_volume_cad_w > 0) then
						qt_dose_ml_teste_w	:= obter_conversao_ml(cd_material_w,qt_dose_w,cd_unid_med_dose_w);

						qt_dose_diluicao_w		:= obter_valor_round_decimais(qt_solucao_w);
						ds_dose_diluicao_w	:= qt_dose_diluicao_w || ' ml';
						ds_conv_ml_w	  	:= to_char(obter_valor_round_decimais(qt_dose_ml_teste_w)) || ' ml';

						if (qt_solucao_w < 1) then
							ds_dose_diluicao_w	:= '0' || ds_dose_diluicao_w;
							ds_conv_ml_w		:= '0' || ds_conv_ml_w;
						end if;

						qt_conv_ml_w		:= qt_dose_ml_teste_w;
					else
						ds_conv_ml_w	:= to_char(obter_valor_round_decimais(qt_solucao_w)) || ' ml';

						if (qt_solucao_w < 1) then
							ds_conv_ml_w	:= '0' || ds_conv_ml_w;
						end if;

						qt_conv_ml_w		:= qt_solucao_w;
					end if;

					qt_dose_diluido_w	:= qt_dose_ml_teste_w;
				end if;

				select	coalesce(max(ie_um_prescrita),'N')
				into STRICT	ie_um_prescrita_w
				from	regra_unid_med_diluente
				where	cd_setor_atendimento 				= cd_setor_prescr_w
				and	coalesce(cd_unidade_medida,cd_unid_med_dose_mat_w)	= cd_unid_med_dose_mat_w;

				if (ie_um_prescrita_w = 'S') then
					qt_conv_ml_w	:= 0;
					ds_conv_ml_w	:= '';
				end if;

				/* ***** Retirado if indice 2 => nunca ira entrar ***** */

				if (coalesce(ds_conv_ml_w::text, '') = '') and (coalesce(ds_diluir_w::text, '') = '') then
					begin

						if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '' AND ds_dose_diferenciada_dil_p IS NOT NULL AND ds_dose_diferenciada_dil_p::text <> '') then
							ds_dose_diferenciada_ww := ds_dose_diferenciada_w || '-';
							ds_dose_diferenciada_dil_w := ds_dose_diferenciada_dil_p || '-';
						else
							ds_dose_diferenciada_ww := ds_dose_diferenciada_w || '-';
						end if;

						while(ds_dose_diferenciada_ww IS NOT NULL AND ds_dose_diferenciada_ww::text <> '') loop
							ds_dose_dif_w := substr(ds_dose_diferenciada_ww, 1, position('-' in ds_dose_diferenciada_ww) - 1);
							ds_dose_diferenciada_ww := substr(ds_dose_diferenciada_ww, position('-' in ds_dose_diferenciada_ww) + 1, length(ds_dose_diferenciada_ww));

							ds_dose_dif_dil_w := substr(ds_dose_diferenciada_dil_w, 1, position('-' in ds_dose_diferenciada_dil_w) - 1);
							ds_dose_diferenciada_dil_w := substr(ds_dose_diferenciada_dil_w, position('-' in ds_dose_diferenciada_dil_w) + 1, length(ds_dose_diferenciada_dil_w));

							if (ie_ConsisteDoseConsumoMedic_w = 'N') and (coalesce(ie_proporcao_w,'F') = 'F') and (coalesce(qt_volume_medic_w,0) > 0) then
							   qt_dose_mat_str_w := qt_volume_medic_w;
							end if;

							if (ds_dose_dif_w IS NOT NULL AND ds_dose_dif_w::text <> '') then
								if (ie_agrupador_ww = 8) or (ie_agrupador_ww = 12) then
									-- do produto
									ds_aux_diluir_w	:= ' ' || Wheb_mensagem_pck.get_texto(307082);
								else
									-- do medicamento
									ds_aux_diluir_w	:= ' ' || Wheb_mensagem_pck.get_texto(307083);
								end if;
								if (ds_reconstituir_w IS NOT NULL AND ds_reconstituir_w::text <> '') then
									-- da reconstituicao
									ds_aux_diluir_w	:= ' '|| Wheb_mensagem_pck.get_texto(307085);
								end if;

								if (ie_separar_w = 'S') then
									-- Separar
									ds_diluir_w := 	ds_diluir_w ||  Wheb_mensagem_pck.get_texto(307089);
								else
									-- Diluir
									ds_diluir_w := 	ds_diluir_w || Wheb_mensagem_pck.get_texto(307092);
								end if;

								if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then
									qt_dil_ml_w         := obter_conversao_ml(cd_material_w,(ds_dose_dif_dil_w)::numeric ,cd_unid_med_dose_w);
									qt_dose_diluicao_w	:= replace(obter_valor_round_decimais(qt_dil_ml_w),'.',',');
									ds_dose_diluicao_w	:= qt_dose_diluicao_w || ' ml';
									qt_dose_mat_str_w   := obter_conversao_ml(cd_medic_w,(ds_dose_dif_w)::numeric ,cd_unid_med_dose_mat_w);

									ds_aplicar_w := Wheb_mensagem_pck.get_texto(307088) || ' ' || replace((qt_dose_mat_str_w + qt_dose_diluicao_w),'.',',') || 'ml ';

									ds_diluir_w := ds_diluir_w || ' ' || replace(qt_dose_mat_str_w,'.',',') || ' ml ' ||
									-- em
													Wheb_mensagem_pck.get_texto(307087) || ' ' || ds_dose_diluicao_w ||  ' ' ||
													-- de
													Wheb_mensagem_pck.get_texto(307090) || ' ' || ds_material_w || '. ' || ds_aplicar_w || chr(13) || chr(10);

									ds_aplicar_w := '';
								else
									ds_diluir_w := ds_diluir_w || ' ' || replace(qt_dose_mat_str_w,'.',',') || ' ' || cd_unid_med_dose_mat_w || ds_aux_diluir_w || ' ' ||
									-- em
													Wheb_mensagem_pck.get_texto(307087) || ' ' || ds_dose_diluicao_w ||  ' ' ||
													-- de
													Wheb_mensagem_pck.get_texto(307090) || ' ' || ds_material_w || chr(13) || chr(10);
								end if;
								/*ds_diluir_w := ds_diluir_w || ' ' || ds_aux_diluir_w || ' ' || */

							elsif (ie_separar_w = 'S') then
								--Dose do diluente sempre deve ser apresentando em ml.
								ds_diluir_w := ds_diluir_w ||
												-- Separar
												Wheb_mensagem_pck.get_texto(307089) || ' ' || replace(qt_dose_mat_str_w,'.',',') || ' ' || 'ml' || ds_aux_diluir_w || ' ' ||
												-- em
												Wheb_mensagem_pck.get_texto(307087) || ' ' || ds_dose_diluicao_w || ' ' ||
												-- de
												Wheb_mensagem_pck.get_texto(307090) || ' ' || ds_material_w || chr(13) || chr(10);
							else

								--Dose do diluente sempre deve ser apresentando em ml.
								ds_diluir_w := ds_diluir_w ||
												-- Diluir
												Wheb_mensagem_pck.get_texto(307092) || ' ' || replace(qt_dose_mat_str_w,'.',',') || ' ' || 'ml' || ds_aux_diluir_w || ' ' ||
												-- em
												Wheb_mensagem_pck.get_texto(307087) || ' ' || ds_dose_diluicao_w || ' ' ||
												-- de
												Wheb_mensagem_pck.get_texto(307090) || ' ' || ds_material_w || chr(13) || chr(10);
							end if;

						nr_count_dil_w := nr_count_dil_w + 1;

						ds_diluicao_record_w[nr_count_dil_w].ds_diluicao := ds_diluir_w;
						ds_diluir_w := '';
						end loop;
					end;
				elsif (coalesce(ds_diluir_w::text, '') = '') then
					begin

					if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '' AND ds_dose_diferenciada_dil_p IS NOT NULL AND ds_dose_diferenciada_dil_p::text <> '') then
						ds_dose_diferenciada_ww := ds_dose_diferenciada_w || '-';
						ds_dose_diferenciada_dil_w := ds_dose_diferenciada_dil_p || '-';
					else
						ds_dose_diferenciada_ww := ds_dose_diferenciada_w || '-';
					end if;

					while(ds_dose_diferenciada_ww IS NOT NULL AND ds_dose_diferenciada_ww::text <> '') loop
						ds_dose_dif_w := substr(ds_dose_diferenciada_ww, 1, position('-' in ds_dose_diferenciada_ww) - 1);
						ds_dose_diferenciada_ww := substr(ds_dose_diferenciada_ww, position('-' in ds_dose_diferenciada_ww) + 1, length(ds_dose_diferenciada_ww));

						ds_dose_dif_dil_w := substr(ds_dose_diferenciada_dil_w, 1, position('-' in ds_dose_diferenciada_dil_w) - 1);
						ds_dose_diferenciada_dil_w := substr(ds_dose_diferenciada_dil_w, position('-' in ds_dose_diferenciada_dil_w) + 1, length(ds_dose_diferenciada_dil_w));

						if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then
							qt_dil_ml_w	:= obter_conversao_ml(cd_material_w,(ds_dose_dif_dil_w)::numeric ,cd_unid_med_dose_w);
							qt_dose_diluicao_w		:= replace(obter_valor_round_decimais(qt_dil_ml_w),'.',',');
							ds_dose_diluicao_w	:=  qt_dose_diluicao_w || ' ml';
						end if;

						if (ie_ConsisteDoseConsumoMedic_w = 'N') and (coalesce(ie_proporcao_w,'F') = 'F') and (coalesce(qt_volume_medic_w,0) > 0) then
						   ds_conv_ml_w := qt_volume_medic_w||' ml';
						   --qt_dose_diluido_w := qt_volume_medic_w;
						end if;

						if (ds_dose_dif_w IS NOT NULL AND ds_dose_dif_w::text <> '') then
							if (ie_agrupador_ww = 8) or (ie_agrupador_ww = 12) then
								-- do produto
								ds_aux_diluir_w	:= ' ' || Wheb_mensagem_pck.get_texto(307082);
							else
								-- do medicamento
								ds_aux_diluir_w	:= ' ' || Wheb_mensagem_pck.get_texto(307083);
							end if;
							if (ds_reconstituir_w IS NOT NULL AND ds_reconstituir_w::text <> '') then
								-- da reconstituicao
								ds_aux_diluir_w	:= ' '|| Wheb_mensagem_pck.get_texto(307085);
							end if;

							if (ie_separar_w = 'S') then
								-- Separar
								ds_diluir_w := 	ds_diluir_w || Wheb_mensagem_pck.get_texto(307089);
							else
								-- Diluir
								ds_diluir_w := 	ds_diluir_w || Wheb_mensagem_pck.get_texto(307092);
							end if;

						ds_diluir_w := ds_diluir_w || ' ' || ds_conv_ml_w || ds_aux_diluir_w || ' ' ||
												-- conforme dose do horario
												Wheb_mensagem_pck.get_texto(307099) || ' (' || ds_dose_dif_w || ')';

						elsif (ie_separar_w = 'S') then
							-- Separar
							ds_diluir_w := ds_diluir_w || Wheb_mensagem_pck.get_texto(307089) || ' ' || ds_conv_ml_w || ds_aux_diluir_w;
						else
							-- Diluir
							ds_diluir_w := 	ds_diluir_w || Wheb_mensagem_pck.get_texto(307092) || ' ' || ds_conv_ml_w || ds_aux_diluir_w;
						end if;

						ds_diluir_w := ds_diluir_w || ' ' ||
											-- em
											Wheb_mensagem_pck.get_texto(307087) || ' ' || ds_dose_diluicao_w || ' ' ||
											-- de
											Wheb_mensagem_pck.get_texto(307090) || ' ' || ds_material_w || chr(13) || chr(10);

					nr_count_dil_w := nr_count_dil_w + 1;

					ds_diluicao_record_w[nr_count_dil_w].ds_diluicao := ds_diluir_w;
					ds_diluir_w := '';
					end loop;
					end;

				elsif (ie_separar_w = 'S') then
					ds_diluir_w :=	ds_diluir_w ||
										-- Separar
										Wheb_mensagem_pck.get_texto(307089) || ' ' ||
										-- a solucao em
										Wheb_mensagem_pck.get_texto(307104) || ' ' || ds_dose_diluicao_w || ' ' ||
										-- de
										Wheb_mensagem_pck.get_texto(307090) || ' ' || ds_material_w || chr(13) || chr(10);
				else
					ds_diluir_w :=	ds_diluir_w ||
										-- Diluir
										Wheb_mensagem_pck.get_texto(307092) || ' ' ||
										-- a solucao em
										Wheb_mensagem_pck.get_texto(307104) || ' ' || ds_dose_diluicao_w || ' ' ||
										-- de
										Wheb_mensagem_pck.get_texto(307090) || ' ' || ds_material_w || chr(13) || chr(10);
				end if;
			   	end;
			end if;

			if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') and (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '') and (cd_unid_med_dose_w IS NOT NULL AND cd_unid_med_dose_w::text <> '') and (ie_agrupador_w = 7) and (ie_indice_w <> 2) then
			   	begin

				if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '' AND ds_dose_diferenciada_red_p IS NOT NULL AND ds_dose_diferenciada_red_p::text <> '') then
					ds_dose_diferenciada_ww := ds_dose_diferenciada_w || '-';
					ds_dose_diferenciada_redil_w := ds_dose_diferenciada_red_p || '-';
				else
					ds_dose_diferenciada_ww := ds_dose_diferenciada_w || '-';
				end if;

				while(ds_dose_diferenciada_ww IS NOT NULL AND ds_dose_diferenciada_ww::text <> '') loop
					ds_dose_dif_w := substr(ds_dose_diferenciada_ww, 1, position('-' in ds_dose_diferenciada_ww) - 1);
					ds_dose_diferenciada_ww := substr(ds_dose_diferenciada_ww, position('-' in ds_dose_diferenciada_ww) + 1, length(ds_dose_diferenciada_ww));

					ds_dose_dif_redil_w := substr(ds_dose_diferenciada_redil_w, 1, position('-' in ds_dose_diferenciada_redil_w) - 1);
					ds_dose_diferenciada_redil_w := substr(ds_dose_diferenciada_redil_w, position('-' in ds_dose_diferenciada_redil_w) + 1, length(ds_dose_diferenciada_redil_w));

					if (ie_descr_redu_dil_w = 'S') then
						ds_material_w	:= ds_reduzida_w;
					else
						ds_material_w	:= ds_material_ww;
					end if;

					cd_volume_final_w := qt_dose_ml_w + qt_solucao_w;

					qt_solucao_w	:= obter_valor_round_decimais(qt_solucao_w);

				   qt_dose_ml_w		:= obter_valor_round_decimais(qt_dose_ml_w);

				   qt_dose_w		:= obter_valor_round_decimais(qt_dose_w);

					if (qt_solucao_w < 1) or (mod(qt_solucao_w, trunc(qt_solucao_w)) <> 0) then
						mascara_w	:= 0;
					else
						mascara_w	:= 1;
					end if;

					ds_dose_diluicao_w	:= replace(qt_dose_ml_w,'.',',') ||' ml';
					qt_dose_diluido_w := qt_dose_ml_w;
					if (qt_dose_ml_w = 0) then
						begin
						ds_dose_diluicao_w	:= replace(qt_dose_w,'.',',') ||' '||cd_unid_med_dose_w;
						qt_dose_diluido_w := qt_dose_w;
						end;
					end if;

					if (mascara_w = 0) then
						qt_solucao_str_w	:= campo_mascara(qt_solucao_w, 2);
					else
						qt_solucao_str_w	:= campo_mascara(qt_solucao_w, 0);
					end if;

					if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then
						qt_redil_ml_w		:= obter_conversao_ml(cd_material_w,(ds_dose_dif_redil_w)::numeric ,cd_unid_med_dose_w);
						qt_dose_diluicao_w	:= replace(obter_valor_round_decimais(qt_redil_ml_w),'.',',');
						ds_dose_diluicao_w	:=  qt_dose_diluicao_w || ' ml';
					end if;

					if (ie_separar_w = 'S') then
						-- Separar
						ds_rediluir_w := ds_rediluir_w|| Wheb_mensagem_pck.get_texto(307089);
					else
						-- Rediluir
						ds_rediluir_w := ds_rediluir_w || Wheb_mensagem_pck.get_texto(307184);
					end if;

					ds_rediluir_w := ds_rediluir_w || ' ' || replace(qt_solucao_str_w,'.',',') || ' ml' || ' ' ||
										-- desta solucao em
										Wheb_mensagem_pck.get_texto(307105) || ' ' || ds_dose_diluicao_w || ' ' ||
										-- de
										Wheb_mensagem_pck.get_texto(307090) || ' ' || ds_material_w || chr(13) || chr(10);

					nr_count_redil_w := nr_count_redil_w + 1;

					ds_rediluicao_record_w[nr_count_redil_w].ds_rediluicao := ds_rediluir_w;
          ds_rediluir_w := '';
				end loop;
				end;
			end if;

			end;
			ie_possui_diluente_w	:= 'S';
		end loop;
		close c01;

		qt_registro_w	:= qt_registro_w + 1;

		if (ie_mostrar_concentracao_w = 'S') then
			begin
			if (qt_concentracao_total_w IS NOT NULL AND qt_concentracao_total_w::text <> '') and (cd_unid_med_concetracao_w IS NOT NULL AND cd_unid_med_concetracao_w::text <> '') and (cd_unid_med_base_conc_w IS NOT NULL AND cd_unid_med_base_conc_w::text <> '') then
				ds_rediluir_w := ds_rediluir_w ||
									-- Concentracao ideal:
									Wheb_mensagem_pck.get_texto(307106) || ' ' || replace(qt_concentracao_total_w,'.',',') || ' ' ||
										cd_unid_med_concetracao_w || '/' || cd_unid_med_base_conc_w || chr(13) || chr(10);
			end if;
			end;
		end if;
	end if;

	ds_aplicar_w	:= '';

	if (cd_volume_final_w < 1) or (mod(cd_volume_final_w, trunc(cd_volume_final_w)) <> 0) then
		mascara_w	:= 0;
	else
		mascara_w	:= 1;
	end if;

	if (qt_min_aplicacao_w IS NOT NULL AND qt_min_aplicacao_w::text <> '') and (qt_hora_aplicacao_w IS NOT NULL AND qt_hora_aplicacao_w::text <> '') and
		((qt_min_aplicacao_w > 0) or (qt_hora_aplicacao_w > 0)) then
		-- em
		ds_tempo_w := ' ' || Wheb_mensagem_pck.get_texto(307087);

		if (qt_hora_aplicacao_w > 0) then
			if (qt_hora_aplicacao_w = 1) then
				-- #@QT_HORA_FASE_HOR#@ hora
				ds_tempo_w := substr(ds_tempo_w || ' ' || Wheb_mensagem_pck.get_texto(319882,'QT_HORA_FASE_HOR='||qt_hora_aplicacao_w),1,4000);
			else
				-- #@QT_HORA_FASE_HOR#@ horas
				ds_tempo_w := substr(ds_tempo_w || ' ' || Wheb_mensagem_pck.get_texto(326727,'QT_HORA_FASE_HOR='||qt_hora_aplicacao_w),1,4000);
			end if;
		end if;

		if (qt_min_aplicacao_w > 0) then
			if (qt_hora_aplicacao_w > 0) then
				-- e
				ds_tempo_w	:=	substr(ds_tempo_w || ' ' || Wheb_mensagem_pck.get_texto(309413),1,4000);
			end if;

			if (qt_min_aplicacao_w = 1) then
				-- #@QT_HORA_FASE_MIN#@ minuto
				ds_tempo_w	:=	substr(ds_tempo_w || ' ' || Wheb_mensagem_pck.get_texto(327445,'QT_HORA_FASE_MIN='||qt_min_aplicacao_w),1,4000);
			else
				-- #@QT_HORA_FASE_MIN#@ minutos
				ds_tempo_w	:=	substr(ds_tempo_w || ' ' || Wheb_mensagem_pck.get_texto(327446,'QT_HORA_FASE_MIN='||qt_min_aplicacao_w),1,4000);
			end if;
		end if;
	end if;

	if (coalesce(ie_fator_Correcao_w,'N') = 'S') and (coalesce(qt_volume_equipo_w,0) > 0) and (coalesce(qt_dose_medic_w,0) > 0) and (ie_um_prescrita_w <> 'S') and
		((coalesce(qt_dose_dil_w,0) > 0) or (coalesce(qt_dose_ml_w,0) > 0)) then
		 qt_ret_volume_equipo_w		:= qt_volume_equipo_w;
	end if;


	if (mascara_w = 0) then
		cd_volume_final_str_w	:= campo_mascara(cd_volume_final_w - qt_ret_volume_equipo_w, 2);
	else
		cd_volume_final_str_w	:= campo_mascara(cd_volume_final_w - qt_ret_volume_equipo_w, 0);
	end if;

	ds_volume_w := null;
	qt_dose_diluido_w := 0;

	if (qt_solucao_ww IS NOT NULL AND qt_solucao_ww::text <> '') and (qt_solucao_ww > 0) then

		qt_volume_ww		:= obter_valor_round_decimais(qt_solucao_ww);
		qt_dose_diluido_w	:= obter_valor_round_decimais((qt_solucao_ww - qt_ret_volume_equipo_w) - qt_conv_ml_calc_w);
		ds_volume_w			:= ' ' || to_char(qt_dose_diluido_w) || ' ml';

	elsif (ie_aplicar_w = 'S') then
		begin
			if (nr_count_redil_w > 0) then

				ds_volume_w			:= ' ' || to_char(cd_volume_final_str_w) || ' ml';
				qt_dose_diluido_w	:= (cd_volume_final_w - qt_ret_volume_equipo_w);

			elsif (nr_count_dil_w > 0) then
		
				qt_dose_diluido_w	:= obter_valor_round_decimais(qt_conv_ml_w + qt_ml_diluente_w - qt_ret_volume_equipo_w);
				ds_volume_w			:= ' ' || to_char(qt_dose_diluido_w) || ' ml';

				qt_volume_ww		:= obter_valor_round_decimais(qt_conv_ml_w + qt_ml_diluente_w);

				if (coalesce(qt_volume_medic_w,0) > 0) then
					qt_conversao_ww := Obter_dose_convertida(cd_medic_w, qt_conv_ml_w, obter_unid_med_usua('ml'), cd_unid_med_dose_mat_w);
					if (coalesce(qt_conversao_ww,0) > 0) then
						ds_volume_w	:= ' '  || to_char(round(((qt_conv_ml_w + qt_dose_ml_w ) * qt_dose_mat_w) / ceil(qt_conversao_ww), nr_casas_diluicao_w)) ||' '||obter_desc_unid_med(obter_unid_med_usua('ml'));
					end if;
				end if;

				if (ie_ConsisteDoseConsumoMedic_w = 'S') then
					qt_volume_ww		:= obter_valor_round_decimais(((qt_conv_ml_w + qt_dose_ml_w) * qt_unit_medic_w) / ceil(qt_unit_medic_div_w));
					qt_dose_diluido_w	:= qt_volume_ww;
					ds_volume_w			:= ' ' || to_char(qt_dose_diluido_w) || ' ml';
				end if;

			elsif (ds_conv_ml_w IS NOT NULL AND ds_conv_ml_w::text <> '') then
				ds_volume_w	:= ' '||ds_conv_ml_w;
			end if;
		end;
	end if;

	if (ie_indice_w <> 2) or (ie_possui_diluente_w = 'N') then

		if (ds_volume_w IS NOT NULL AND ds_volume_w::text <> '') then
			-- Administrar
			ds_aplicar_w	:= Wheb_mensagem_pck.get_texto(307088) || replace(ds_volume_w,'.',',');

			if (ds_intervalo_w IS NOT NULL AND ds_intervalo_w::text <> '') then
				ds_aplicar_w	:= ds_aplicar_w || ' (' || ds_intervalo_w || ')';
			end if;

			ds_aplicar_w	:= ds_aplicar_w || ' ' || ds_tempo_w;

			if	((coalesce(qt_min_aplicacao_w,0) > 0) or (coalesce(qt_hora_aplicacao_w,0) > 0)) then
				ds_retorno_inf_w := '';
				SELECT * FROM cpoe_gerar_vel_inf_medic( nr_atendimento_p, cd_material_p, qt_dose_diluido_w, qt_min_aplicacao_w, qt_hora_aplicacao_w, ie_via_aplicacao_p, ie_se_necessario_p, cd_intervalo_p, ie_bomba_infusao_p, ie_tipo_dosagem_p, qt_dosagem_p, cd_perfil_p, cd_estabelecimento_p, nm_usuario_p, cd_pessoa_fisica_p, ds_retorno_inf_w, qt_vel_infusao_w, ie_tipo_dosagem_w) INTO STRICT ds_retorno_inf_w, qt_vel_infusao_w, ie_tipo_dosagem_w;
				ds_aplicar_w	:= substr(ds_aplicar_w || ds_retorno_inf_w,1,2000);
			end if;

			if (ie_administrar_ui_w = 'S') then

				select	count(*)
				into STRICT	cont_ww
				from	material_conversao_unidade
				where	cd_material	= cd_mat_ww
				and	cd_unidade_medida = 'UI';

				if (cont_ww > 0) then

					select	count(*)
					into STRICT	cont_ww
					from	regra_setor_conv_unid
					where	cd_material	= cd_mat_ww
					and		cd_unidade_medida = 'UI'
					and		cd_setor_atendimento = cd_setor_prescr_w;

					if (cont_ww > 0) then
						ds_adm_ui_w	:= Wheb_mensagem_pck.get_texto(307088) || ' ' || to_char(Obter_dose_convertida(cd_mat_ww,qt_volume_ww, 'ml','UI')) ||' UI';

						if (ds_intervalo_w IS NOT NULL AND ds_intervalo_w::text <> '') then
							-- Administrar
							ds_adm_ui_w	:= ds_adm_ui_w || ' (' || ds_intervalo_w ||')';
						end if;

						ds_adm_ui_w	:= ds_adm_ui_w || ' ' || ds_tempo_w;

						ds_aplicar_w	:= ds_aplicar_w || chr(13) || chr(10) ||ds_adm_ui_w;
					end if;
				end if;
			end if;


		elsif (ds_tempo_w IS NOT NULL AND ds_tempo_w::text <> '') then
			-- Administrar
			ds_aplicar_w	:= Wheb_mensagem_pck.get_texto(307088) || ds_tempo_w;

			if	((coalesce(qt_min_aplicacao_w,0) > 0) or (coalesce(qt_hora_aplicacao_w,0) > 0))then
				ds_retorno_inf_w := '';
				SELECT * FROM cpoe_gerar_vel_inf_medic( nr_atendimento_p, cd_material_p, qt_dose_diluido_w, qt_min_aplicacao_w, qt_hora_aplicacao_w, ie_via_aplicacao_p, ie_se_necessario_p, cd_intervalo_p, ie_bomba_infusao_p, ie_tipo_dosagem_p, qt_dosagem_p, cd_perfil_p, cd_estabelecimento_p, nm_usuario_p, cd_pessoa_fisica_p, ds_retorno_inf_w, qt_vel_infusao_w, ie_tipo_dosagem_w) INTO STRICT ds_retorno_inf_w, qt_vel_infusao_w, ie_tipo_dosagem_w;
				ds_aplicar_w	:= substr(ds_aplicar_w ||ds_retorno_inf_w,1,2000);
			end if;
		end if;
	else
		ds_rediluir_w	:= '';
	end if;

	if (ie_mostrar_aplic_ataque_w = 'S') and (qt_dose_especial_w	> 0) then
		qt_dose_ml_ataque_w	:= obter_conversao_ml(cd_medic_w,qt_dose_especial_w,cd_unid_med_dose_mat_w);

		if (qt_dose_ml_ataque_w	> 0) then
			ds_ataque_w		:= to_char(obter_valor_round_decimais(qt_dose_ml_ataque_w));

			if (qt_dose_ml_ataque_w < 1) then
				ds_ataque_w		:= '0' || ds_ataque_w;
			end if;

			-- Administrar dose ataque
			ds_aplicar_w	:= ds_aplicar_w || chr(13)  || chr(10)|| ' ' || Wheb_mensagem_pck.get_texto(307111) || ' ' || replace(ds_ataque_w,'.',',') || ' ml';

			if (qt_min_aplic_dose_esp_w IS NOT NULL AND qt_min_aplic_dose_esp_w::text <> '') then
				ds_aplicar_w	:= ds_aplicar_w || ' ' ||
									-- em
									Wheb_mensagem_pck.get_texto(307087) || ' ' || qt_min_aplic_dose_esp_w || ' ' ||
									-- min
									Wheb_mensagem_pck.get_texto(309408);
			end if;
		end if;
	end if;

	if (ie_aplicar_medic_w = 'N') or (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then
		ds_aplicar_w	:= '';
	end if;

	if ((ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') and
		coalesce(ds_dose_diferenciada_dil_p::text, '') = '') then
		ds_dose_diferenciada_ww := ds_dose_diferenciada_w || '-';

		while(ds_dose_diferenciada_ww IS NOT NULL AND ds_dose_diferenciada_ww::text <> '') loop
			ds_dose_dif_w := substr(ds_dose_diferenciada_ww, 1, position('-' in ds_dose_diferenciada_ww) - 1);
			ds_dose_diferenciada_ww := substr(ds_dose_diferenciada_ww, position('-' in ds_dose_diferenciada_ww) + 1, length(ds_dose_diferenciada_ww));

			qt_dose_mat_str_w   := obter_conversao_ml(cd_medic_w,(ds_dose_dif_w)::numeric ,cd_unid_med_dose_mat_w);

			nr_count_aplic_w := nr_count_aplic_w + 1;

			ds_aplicar_record_w[nr_count_aplic_w].ds_aplicar := Wheb_mensagem_pck.get_texto(307088) || ' ' || replace((qt_dose_mat_str_w),'.',',') || 'ml. ' || chr(13) || chr(10);
		end loop;
	end if;

	ds_retorno_w := ds_reconstituir_w;

	if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then
		if (ds_diluicao_record_w.COUNT > 0) then
			for	i in 1.. ds_diluicao_record_w.last loop
			begin
				if (ds_horario_record_w.EXISTS(i)) then
					ds_retorno_w := ds_retorno_w || ds_horario_record_w[i].ds_horario;
				end if;
				if (ds_diluicao_record_w.EXISTS(i)) then
					ds_retorno_w := ds_retorno_w || ds_diluicao_record_w[i].ds_diluicao;
				end if;
				if (ds_rediluicao_record_w.EXISTS(i)) then
					ds_retorno_w := ds_retorno_w || ds_rediluicao_record_w[i].ds_rediluicao;
				end if;
			end;
			end loop;
		elsif (ds_aplicar_record_w.count > 0) then
			for	i in 1.. ds_aplicar_record_w.last loop
			begin
				if (ds_horario_record_w.EXISTS(i)) then
					ds_retorno_w := ds_retorno_w || ds_horario_record_w[i].ds_horario;
				end if;
				if (ds_aplicar_record_w.EXISTS(i)) then
					ds_retorno_w := ds_retorno_w || ds_aplicar_record_w[i].ds_aplicar;
				end if;
			end;
			end loop;
		end if;
	else
		if (ds_diluicao_record_w.EXISTS(1)) then
			ds_retorno_w := ds_retorno_w || ds_diluicao_record_w[1].ds_diluicao;
		end if;
		if (ds_rediluicao_record_w.EXISTS(1)) then
			ds_retorno_w := ds_retorno_w || ds_rediluicao_record_w[1].ds_rediluicao;
		end if;
	end if;

	ds_retorno_w 	:= ds_retorno_w || ds_aplicar_w;
	ds_retorno_w	:= replace(ds_retorno_w,' ,',' 0,');
	ds_retorno_w	:= replace(ds_retorno_w,' .',' 0,');

	cd_material_w := cd_material_p;

	if (ie_mostrar_estabilidade_w = 'S') then

		select  coalesce(max(nr_seq_estagio),0),
				max(substr(obter_estagio_armazenamento(nr_seq_estagio),1,255)),
				max(qt_estabilidade),
				max(substr(obter_valor_dominio(1246,ie_tempo_estab),1,255))
		into STRICT	qt_estagio_armazenamento_w,
				ds_estagio_armazenamento_w,
				qt_estabilidade_w,
				ds_tempo_estabilidade_w
		from 	mat_estagio_armaz b,
				material_armazenamento a
		where 	b.nr_sequencia	= a.nr_seq_estagio
		and		a.cd_material	= cd_material_w
		and		b.ie_estagio	= '1'
		and		coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w;

		if (ie_possui_diluente_w = 'S') then
			if (qt_estagio_armazenamento_w = 0) then
					select  coalesce(max(nr_seq_estagio),0),
							max(substr(obter_estagio_armazenamento(nr_seq_estagio),1,255)),
							max(qt_estabilidade),
							max(substr(obter_valor_dominio(1246,ie_tempo_estab),1,255))
					into STRICT	qt_estagio_armazenamento_w,
							ds_estagio_armazenamento_w,
							qt_estabilidade_w,
							ds_tempo_estabilidade_w
					from 	mat_estagio_armaz b,
							material_armazenamento a
					where 	b.nr_sequencia	= a.nr_seq_estagio
					and		a.cd_material	= cd_material_w
					and		b.ie_estagio	= '2'
					and		coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w;

			end if;

			if (qt_estagio_armazenamento_w > 0) then
				if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
					ds_retorno_w := ds_retorno_w || chr(13) || chr(10);
				end if;

				-- Estabilidade:
				ds_retorno_w := ds_retorno_w || Wheb_mensagem_pck.get_texto(307113) || ' ' || qt_estabilidade_w ||' '|| ds_tempo_estabilidade_w || ' ' || ds_estagio_armazenamento_w;
			end if;
		end if;
	end if;

	select  coalesce(max(ie_higroscopico),'N'),
			coalesce(max(ie_fotosensivel),'N'),
			coalesce(max(ie_termolabil),'N')
	into STRICT	ie_higroscopico_w,
			ie_fotosensivel_w,
			ie_termolabil_w
	from 	material
	where 	cd_material = cd_material_w;

	ds_inf_adic_w	:= '';

	if (ie_fotosensivel_w = 'S')	and (ie_mostrar_foto_w = 'S') then
		-- fotossensivel
		ds_inf_adic_w := ds_inf_adic_w || lower(Wheb_mensagem_pck.get_texto(307117));
	end if;

	if (ie_higroscopico_w = 'S') then
		if (ds_inf_adic_w IS NOT NULL AND ds_inf_adic_w::text <> '') then
			ds_inf_adic_w := ds_inf_adic_w || ', ';
		end if;

		-- higroscopico
		ds_inf_adic_w := ds_inf_adic_w || Wheb_mensagem_pck.get_texto(307119);
	end if;

	if (ie_termolabil_w = 'S') then
		if (ds_inf_adic_w IS NOT NULL AND ds_inf_adic_w::text <> '') then
			-- e termolabil
			ds_inf_adic_w := ds_inf_adic_w || ' ' || Wheb_mensagem_pck.get_texto(307120);
		else
			-- termolabil
			ds_inf_adic_w := ds_inf_adic_w || lower(Wheb_mensagem_pck.get_texto(307121));
		end if;
	end if;

	if (ds_inf_adic_w IS NOT NULL AND ds_inf_adic_w::text <> '') then
		-- Medicamento
		ds_inf_adic_w := Wheb_mensagem_pck.get_texto(307095) || ' ' || ds_inf_adic_w || '.';

		if (ds_retorno_w IS NOT NULL AND ds_retorno_w::text <> '') then
			ds_retorno_w := ds_retorno_w || chr(13) || chr(10);
		end if;

		ds_retorno_w := ds_retorno_w || ds_inf_adic_w;
	end if;
else
	ds_retorno_w	:= ds_diluicao_edit_w;
end if;

ds_retorno_p		:= substr(ds_retorno_w,1,2000);
qt_vel_infusao_p		:= coalesce(qt_vel_infusao_w,qt_dosagem_p);
ie_tipo_dosagem_out_p	:= coalesce(ie_tipo_dosagem_w,ie_tipo_dosagem_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_dados_diluicao_medic ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, cd_material_p bigint, qt_dose_p bigint, cd_unid_med_dose_p text, cd_intervalo_p text, ie_via_aplicacao_p text, qt_solucao_p bigint, hr_min_aplicacao_p text, ie_se_necessario_p text, ie_fator_correcao_p text, ie_bomba_infusao_p text, nr_seq_mat_dil_p bigint, cd_mat_dil_p bigint, qt_dose_dil_p bigint, cd_unid_med_dose_dil_p text, qt_solucao_dil_p bigint, nr_seq_mat_red_p bigint, cd_mat_red_p bigint, qt_dose_red_p bigint, cd_unid_med_dose_red_p text, qt_solucao_red_p bigint, nr_seq_mat_recons_p bigint, cd_mat_recons_p bigint, qt_dose_recons_p bigint, cd_unid_med_dose_recons_p text, qt_solucao_recons_p bigint, ie_tipo_dosagem_p text, qt_dosagem_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, ds_retorno_p out text, qt_vel_infusao_p out bigint, ie_tipo_dosagem_out_p out text, qt_minutos_aplicacao_p out bigint, ds_dose_diferenciada_p text default null, ds_dose_diferenciada_dil_p text default null, ds_dose_diferenciada_red_p text default null, ds_dose_diferenciada_rec_p text default null, ds_horarios_p text default null, ie_change_vol_p text default null, ie_tipo_material_p text default null) is type v_base_ds_diluicao is record (ds_diluicao varchar(255)) FROM PUBLIC;

