-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_nfse_mensagem ( cd_codigo_p text, ds_mensagem_p text, ds_correcao_p text, nm_usuario_p text, nr_sequencia_nf_p bigint) AS $body$
DECLARE


nr_seq_protocolo_w 	varchar(255);
nr_sequencia_w	   	bigint;
ds_historico_w		varchar(255);

c01 CURSOR FOR
SELECT 	nr_sequencia
from 	nota_fiscal
where	nr_nfe_imp_protocolo  = nr_seq_protocolo_w;


BEGIN

select 	coalesce(max(nr_nfe_imp_protocolo),'0') nr_protocolo
into STRICT	nr_seq_protocolo_w
from	nota_fiscal
where	(nr_seq_exportada IS NOT NULL AND nr_seq_exportada::text <> '');


if (nr_seq_protocolo_w > '0') and (nr_sequencia_nf_p = 0) then
	begin
	open C01;
	loop
	fetch C01 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		ds_historico_w	:= substr(obter_desc_expressao(327262)/*'Codigo: '*/
 || cd_codigo_p || obter_desc_expressao(293191) ||': '/*' Mensagem: '*/ || ds_mensagem_p ||obter_desc_expressao(303220) ||': '/*' Correcao: '*/|| ds_correcao_p ,1,255);

		insert into nota_fiscal_hist(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_nota,
				cd_evento,
				ds_historico)
			values (	nextval('nota_fiscal_hist_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_sequencia_w,
				'31',
				ds_historico_w);
		end;
		ds_historico_w	:=	'';
	end loop;
	close C01;
	end;
end if;

if (nr_sequencia_nf_p > 0) then
	begin
	ds_historico_w	:= substr(obter_desc_expressao(327262)/*'Codigo: '*/
 || cd_codigo_p || obter_desc_expressao(293191) ||': '/*' Mensagem: '*/ || ds_mensagem_p ||obter_desc_expressao(303220) ||': '/*' Correcao: '*/|| ds_correcao_p ,1,255);
	insert into nota_fiscal_hist(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_nota,
				cd_evento,
				ds_historico)
			values (	nextval('nota_fiscal_hist_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_sequencia_nf_p,
				'31',
				ds_historico_w);
	end;
end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_nfse_mensagem ( cd_codigo_p text, ds_mensagem_p text, ds_correcao_p text, nm_usuario_p text, nr_sequencia_nf_p bigint) FROM PUBLIC;

