-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pcs_cancelamento_email_parecer ( nr_seq_reclassif_item_p bigint, nr_seq_parecer_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_mensagem_w			varchar(4000);
ds_assunto_w			varchar(255);
nm_usuario_origem_w		varchar(255);
ds_email_origem_w		varchar(255);
ds_email_w				varchar(255);
ds_email_remetente_w	varchar(255);
ds_parecer_w			varchar(4000);
cd_pessoa_dest_w		varchar(10);
cd_pessoa_grupo_w		varchar(10);
nr_seq_parecer_w		bigint;
cd_material_w			bigint;
ds_material_w			varchar(255);
ds_tipo_parecer_w		varchar(255);
ds_destinatarios_w		varchar(255);
nr_seq_grupo_w			bigint;
ie_comunic_interna_w	varchar(1);
ie_email_w				varchar(1);
nr_seq_comunic_w		bigint;
nm_usuario_dest_w		varchar(255);
qt_selecionados_w		integer;
nm_destinatarios_w		varchar(4000);


C01 CURSOR FOR
	SELECT	cd_pessoa_grupo
	from  	pcs_pessoas_grupo_dest
	where 	nr_seq_grupo = nr_seq_grupo_w
	and		cd_pessoa_grupo <> cd_pessoa_dest_w
	and		(cd_pessoa_grupo IS NOT NULL AND cd_pessoa_grupo::text <> '')
	group by cd_pessoa_grupo;


BEGIN

select	max(ds_email)
into STRICT	ds_email_remetente_w
from	usuario
where	nm_usuario = nm_usuario_p;

select  b.cd_pessoa_dest,
		b.nr_seq_grupo_dest
into STRICT	cd_pessoa_dest_w,
		nr_seq_grupo_w
from	pcs_reclassif_curva_item a,
		pcs_parecer b
where	a.nr_sequencia = b.nr_seq_reclassif
and		a.nr_sequencia = nr_seq_reclassif_item_p
and		b.nr_sequencia = nr_seq_parecer_p
and 	(b.cd_pessoa_dest IS NOT NULL AND b.cd_pessoa_dest::text <> '')
and		((ie_comunic_interna = 'S') or (ie_email = 'S'));


select	max(ds_email) || ';',
		max(nm_usuario) || ','
into STRICT	ds_destinatarios_w,
		nm_usuario_dest_w
from	usuario
where	cd_pessoa_fisica = cd_pessoa_dest_w;

if (nm_usuario_dest_w <> '') then
	nm_destinatarios_w := nm_usuario_dest_w;
end if;

ds_mensagem_w := null;
ds_assunto_w := null;

open C01;
loop
fetch C01 into
	cd_pessoa_grupo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	max(ds_email),
			max(nm_usuario)
	into STRICT	ds_email_w,
			nm_usuario_dest_w
	from	usuario
	where	cd_pessoa_fisica = cd_pessoa_grupo_w;

	ds_destinatarios_w := ds_destinatarios_w || ds_email_w || ';';
	nm_destinatarios_w := nm_destinatarios_w || nm_usuario_dest_w || ';';
	--enviar_email(ds_assunto_w,ds_mensagem_w,ds_email_remetente_w,ds_email_w,'Maicon','M');
	end;
end loop;
close C01;


select  b.ds_parecer,
		a.cd_material,
		obter_desc_material(a.cd_material),
		b.nr_sequencia,
		substr(obter_descricao_padrao('PCS_TIPO_PARECER','DS_TIPO_PARECER',NR_SEQ_TIPO_PARECER),1,255),
		ie_comunic_interna,
		ie_email
into STRICT	ds_parecer_w,
		cd_material_w,
		ds_material_w,
		nr_seq_parecer_w,
		ds_tipo_parecer_w,
		ie_comunic_interna_w,
		ie_email_w
from	pcs_reclassif_curva_item a,
		pcs_parecer b
where	a.nr_sequencia = b.nr_seq_reclassif
and		a.nr_sequencia = nr_seq_reclassif_item_p
and		b.nr_sequencia = nr_seq_parecer_p
and		((ie_comunic_interna = 'S') or (ie_email = 'S'))
order by b.nr_sequencia;

ds_assunto_w := substr(wheb_mensagem_pck.get_Texto(296106) || ' ' || cd_material_w || ' - ' || ds_material_w,1,255);
ds_mensagem_w := ds_mensagem_w || chr(13) || chr(10) || nr_seq_parecer_w || ' - ' || ds_tipo_parecer_w;
ds_mensagem_w := substr(ds_mensagem_w || chr(13) || chr(10) || ds_parecer_w || chr(13) || chr(10),1,4000);
ds_email_w := null;

	-- Parecer do item :
if (coalesce(ie_email_w,'N') = 'S') then
	CALL enviar_email(ds_assunto_w,ds_mensagem_w,ds_email_remetente_w,ds_destinatarios_w,nm_usuario_p,'M'); --coloquei o usuario maicon só pra testar, por causa do SMTP
	--enviar_email(ds_assunto_w,ds_mensagem_w,ds_email_remetente_w,'maurici@wheb.com.br','Maicon','M'); --coloquei o usuario maicon só pra testar, por causa do SMTP
end if;

if (coalesce(ie_comunic_interna_w,'N') = 'S') then

		select	nextval('comunic_interna_seq')
		into STRICT	nr_seq_comunic_w
		;

		insert	into comunic_interna(
					dt_comunicado,
					ds_titulo,
					ds_comunicado,
					nm_usuario,
					dt_atualizacao,
					ie_geral,
					nm_usuario_destino,
					nr_sequencia,
					ie_gerencial,
					dt_liberacao)
			values (	clock_timestamp(),
					ds_assunto_w,
					ds_mensagem_w,
					nm_usuario_p,
					clock_timestamp(),
					'N',
					nm_destinatarios_w,
					nr_seq_comunic_w,
					'N',
					clock_timestamp());
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pcs_cancelamento_email_parecer ( nr_seq_reclassif_item_p bigint, nr_seq_parecer_p bigint, nm_usuario_p text) FROM PUBLIC;

