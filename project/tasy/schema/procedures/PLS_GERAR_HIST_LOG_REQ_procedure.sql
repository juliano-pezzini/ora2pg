-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_hist_log_req ( nr_seq_item_p bigint, ie_origem_historico_p bigint, nm_usuario_p text, cd_item_p bigint, qt_item_p bigint, ie_origem_proced_p bigint, vl_item_p bigint) AS $body$
DECLARE


nr_seq_auditoria_w		bigint;
nr_seq_requisicao_w		bigint;
nr_seq_segurado_w		bigint;
cd_procedimento_w		bigint;
nr_seq_material_w		bigint;
ie_origem_proced_w		integer;
ds_item_w			varchar(400);
nr_seq_grupo_w			bigint;
nm_grupo_auditor_w		varchar(255);
cd_item_w			bigint;
ds_historico_w			varchar(4000);
nr_seq_guia_w			bigint;
ds_item_original_w		varchar(255);
qt_ajuste_w			double precision;
vl_ajuste_w			double precision;
cd_material_w			varchar(50);
cd_material_origem_w		varchar(50);
nr_registro_anvisa_w		pls_auditoria_item.nr_registro_anvisa%type;
cd_ref_fabricante_imp_w		pls_auditoria_item.cd_ref_fabricante_imp%type;


BEGIN

select	a.nr_sequencia,
	coalesce(a.nr_seq_requisicao,0),
	coalesce(a.nr_seq_guia,0),
	a.nr_seq_segurado,
	coalesce(b.cd_procedimento,0),
	coalesce(b.ie_origem_proced,0),
	coalesce(b.nr_seq_material,0),
	coalesce(b.qt_ajuste,0),
	coalesce(b.vl_item,0),
	coalesce(b.nr_registro_anvisa,0),
	coalesce(b.cd_ref_fabricante_imp,'')
into STRICT	nr_seq_auditoria_w,
	nr_seq_requisicao_w,
	nr_seq_guia_w,
	nr_seq_segurado_w,
	cd_procedimento_w,
	ie_origem_proced_w,
	nr_seq_material_w,
	qt_ajuste_w,
	vl_ajuste_w,
	nr_registro_anvisa_w,
	cd_ref_fabricante_imp_w
from	pls_auditoria		a,
	pls_auditoria_item	b
where	b.nr_sequencia		= nr_seq_item_p
and	b.nr_seq_auditoria	= a.nr_sequencia;

select	nr_seq_grupo
into STRICT	nr_seq_grupo_w
from	pls_auditoria_grupo
where	nr_sequencia = pls_obter_grupo_analise_atual(nr_seq_auditoria_w);

select	pls_obter_nome_grupo_auditor(nr_seq_grupo_w)
into STRICT	nm_grupo_auditor_w
;

if (coalesce(cd_item_p,0) > 0) then
	if (coalesce(ie_origem_proced_p,0) > 0) then
		select	Obter_Descricao_Procedimento(cd_item_p,ie_origem_proced_p)
		into STRICT	ds_item_original_w
		;
	else
		select	pls_obter_desc_material(cd_item_p)
		into STRICT	ds_item_original_w
		;

		select	substr(pls_obter_dados_material(cd_item_p,'CO'),1,20)
		into STRICT	cd_material_origem_w
		;
	end if;
end if;

if (cd_procedimento_w <> 0) then
	select	Obter_Descricao_Procedimento(cd_procedimento_w,ie_origem_proced_w)
	into STRICT	ds_item_w
	;

	cd_item_w := cd_procedimento_w;

	if (ie_origem_historico_p = 1) then
		ds_historico_w	:= substr('O grupo ' || nm_grupo_auditor_w || ' incluiu o item ' || cd_item_w || ' - ' || ds_item_w,1,4000);
	elsif (ie_origem_historico_p = 2) then
		ds_historico_w	:= substr('O grupo ' || nm_grupo_auditor_w || ' excluiu o item ' || cd_item_w || ' - ' || ds_item_w,1,4000);
	elsif (ie_origem_historico_p = 3) then
		if (cd_item_p <> cd_item_w) then
			ds_historico_w	:= 	substr('O grupo ' || nm_grupo_auditor_w || ' alterou o item ' || cd_item_p ||  ' - "' || ds_item_original_w ||
						'" com quantidade original ' || qt_item_p || ' e valor R$'|| TO_CHAR(vl_item_p, '99990.00') ||', '
						||'para o item "' || cd_item_w || ' - ' || ds_item_w || '" com quantidade '|| qt_ajuste_w || ' e valor R$'|| TO_CHAR(vl_ajuste_w, '99990.00'),1,4000);
		else
			if (qt_item_p <> qt_ajuste_w and vl_item_p <> vl_ajuste_w) then
			ds_historico_w	:= 	substr('O grupo ' || nm_grupo_auditor_w || ' alterou a quantidade do item ' || cd_item_w || ' - "' || ds_item_w ||
						'" de ' || qt_item_p || ' para '||qt_ajuste_w || ' e o valor de R$'|| TO_CHAR(vl_item_p, '99990.00') ||' para R$'||TO_CHAR(vl_ajuste_w, '99990.00'),1,4000);

			elsif (qt_item_p <> qt_ajuste_w) then
			ds_historico_w	:= 	substr('O grupo ' || nm_grupo_auditor_w || ' alterou a quantidade do item ' || cd_item_w || ' - "' || ds_item_w ||
						'" de ' || qt_item_p || ' para '||qt_ajuste_w,1,4000);
			elsif (qt_item_p = qt_ajuste_w) then
				ds_historico_w	:= 	substr('O grupo ' || nm_grupo_auditor_w || ' voltou para a quantidade original o item ' || cd_item_w || ' - "' || ds_item_w,1,4000);
			elsif (vl_item_p <> vl_ajuste_w) then
			ds_historico_w	:= 	substr('O grupo ' || nm_grupo_auditor_w || ' alterou o valor do item ' || cd_item_w || ' - "' || ds_item_w ||
				'" de R$' || TO_CHAR(vl_item_p, '99990.00') || ' para R$'||TO_CHAR(vl_ajuste_w, '99990.00'),1,4000);
			end if;
		end if;
	elsif (ie_origem_historico_p = 4) then
		ds_historico_w	:= 	substr('O grupo ' || nm_grupo_auditor_w || ' alterou o fornecedor do item ' || cd_item_w || ' - "' || ds_item_w ||'" ',1,4000);
	end if;
elsif (nr_seq_material_w <> 0) then
	select	pls_obter_desc_material(nr_seq_material_w)
	into STRICT	ds_item_w
	;

	select	substr(pls_obter_dados_material(nr_seq_material_w,'CO'),1,20)
	into STRICT	cd_material_w
	;

	cd_item_w := nr_seq_material_w;

	if (ie_origem_historico_p = 1) then
		ds_historico_w	:= substr('O grupo ' || nm_grupo_auditor_w || ' incluiu o item ' || cd_material_w || ' / ' || cd_item_w || ' - ' || ds_item_w,1,4000);
	elsif (ie_origem_historico_p = 2) then
		ds_historico_w	:= substr('O grupo ' || nm_grupo_auditor_w || ' excluiu o item ' || cd_material_w || ' / ' || cd_item_w || ' - ' || ds_item_w,1,4000);
	elsif (ie_origem_historico_p = 3) then
		if (cd_item_p <> cd_item_w) then
			ds_historico_w	:= 	substr('O grupo ' || nm_grupo_auditor_w || ' alterou o item ' || cd_material_origem_w || ' / ' || cd_item_p ||  ' - "' || ds_item_original_w ||
						'" com quantidade original ' || qt_item_p || ' e valor R$'|| TO_CHAR(vl_item_p, '99990.00') ||', '
						||'para o item "' || cd_material_w || ' / ' || cd_item_w || ' - ' || ds_item_w || '" com quantidade '|| qt_ajuste_w || ' e valor R$'|| TO_CHAR(vl_ajuste_w, '99990.00'),1,4000);

		elsif (nr_registro_anvisa_w <> 0) or (cd_ref_fabricante_imp_w <> '') then
			ds_historico_w	:= 	substr('O grupo ' || nm_grupo_auditor_w || ' aleterou o Código Anvisa para ' || nr_registro_anvisa_w || ' e o Código de Referência do Fabricante para ' || cd_ref_fabricante_imp_w,1,4000);

		else
			if (qt_item_p <> qt_ajuste_w and vl_item_p <> vl_ajuste_w) then
			ds_historico_w	:= 	substr('O grupo ' || nm_grupo_auditor_w || ' alterou a quantidade do item ' || cd_material_w || ' / ' || cd_item_w || ' - "' || ds_item_w ||
						'" de ' || qt_item_p || ' para '||qt_ajuste_w || ' e o valor de R$'|| TO_CHAR(vl_item_p, '99990.00') ||' para R$'||TO_CHAR(vl_ajuste_w, '99990.00'),1,4000);

			elsif (qt_item_p <> qt_ajuste_w) then
			ds_historico_w	:= 	substr('O grupo ' || nm_grupo_auditor_w || ' alterou a quantidade do item ' || cd_material_w || ' / ' || cd_item_w || ' - "' || ds_item_w ||
						'" de ' || qt_item_p || ' para '||qt_ajuste_w,1,4000);
			elsif (qt_item_p = qt_ajuste_w) then
				ds_historico_w	:= 	substr('O grupo ' || nm_grupo_auditor_w || ' voltou para a quantidade original o item ' || cd_material_w || ' / ' || cd_item_w || ' - "' || ds_item_w,1,4000);
			elsif (vl_item_p <> vl_ajuste_w) then
			ds_historico_w	:= 	substr('O grupo ' || nm_grupo_auditor_w || ' alterou o valor do item ' || cd_material_w || ' / ' || cd_item_w || ' - "' || ds_item_w ||
				'" de R$' || TO_CHAR(vl_item_p, '99990.00') || ' para R$'||TO_CHAR(vl_ajuste_w, '99990.00'),1,4000);
			end if;
		end if;
	elsif (ie_origem_historico_p = 4) then
		ds_historico_w	:= 	substr('O grupo ' || nm_grupo_auditor_w || ' alterou o fornecedor do item ' || cd_material_w || ' / ' || cd_item_w || ' - "' || ds_item_w ||'" ',1,4000);
	end if;
end if;

if (nr_seq_requisicao_w > 0) then
	insert into pls_requisicao_historico(nr_sequencia, nr_seq_requisicao, ie_tipo_historico,
		ds_historico , dt_atualizacao, nm_usuario,
		dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_segurado,
		dt_historico, ie_origem_historico, nr_seq_item,
		ie_status_analise, nr_seq_grupo)
	values (nextval('pls_requisicao_historico_seq'), nr_seq_requisicao_w, 'L',
		ds_historico_w,clock_timestamp(),nm_usuario_p,
		clock_timestamp(),nm_usuario_p, nr_seq_segurado_w,
		clock_timestamp(), 'A', nr_seq_item_p,
		'', nr_seq_grupo_w);
elsif (nr_seq_guia_w > 0) then
	insert into pls_guia_plano_historico(nr_sequencia, nr_seq_guia, ie_tipo_log,
		dt_historico, dt_atualizacao, nm_usuario,
		ds_observacao, ie_origem_historico, ie_tipo_historico,
		nr_seq_item,nr_seq_grupo)
	values (	nextval('pls_guia_plano_historico_seq'), nr_seq_guia_w, null,
		clock_timestamp(), clock_timestamp(), nm_usuario_p,
		ds_historico_w,'A','L',
		nr_seq_item_p,nr_seq_grupo_w);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_hist_log_req ( nr_seq_item_p bigint, ie_origem_historico_p bigint, nm_usuario_p text, cd_item_p bigint, qt_item_p bigint, ie_origem_proced_p bigint, vl_item_p bigint) FROM PUBLIC;

