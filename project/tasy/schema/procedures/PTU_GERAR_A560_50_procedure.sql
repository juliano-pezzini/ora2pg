-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_gerar_a560_50 ( nr_seq_nota_deb_p bigint, nm_usuario_p text) AS $body$
DECLARE


/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Gerar o arquivo A560 V5.0
-------------------------------------------------------------------------------------------------------------------
OPS - Controle de Contestações
Locais de chamada direta:
[X]  Objetos do dicionário [ ]  Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/ds_conteudo_w			varchar(4000);
cd_unimed_origem_w		varchar(4);
cd_unimed_destino_w		varchar(4);
nr_fatura_w			varchar(11);
vl_total_fatura_w		varchar(14) := null;
nr_nota_debito_w		varchar(11);
dt_ven_nota_w			varchar(8);
nr_titulo_w			bigint;
nr_seq_conta_banco_w		bigint;
nr_bloqueto_w			varchar(44);
nr_seq_carteira_cobr_w		bigint;
cd_banco_w			varchar(5);
cd_agencia_bancaria_w		varchar(25);
cd_carteira_w			varchar(10);
nr_nosso_numero_w		varchar(20);
vl_titulo_w			varchar(14);
dt_documento_w			timestamp;
dt_processo_w			timestamp;
nr_seq_ptu_fatura_w		bigint;
nr_nota_credito_debito_a500_w	varchar(30);
vl_total_ndc_a500_w		varchar(14);
ie_conclusao_ndc_w		varchar(1);
ds_uso_banco_w			varchar(15);
ds_especie_w			varchar(4);
ds_especie_doc_w		varchar(5);
ds_aceite_w			varchar(2);
ds_local_pagto_w		varchar(60);
ds_obs_local_pagto_w		varchar(60);
nr_seq_nota_deb_bol_w		bigint;
ds_instrucao_w			varchar(60);
ds_observacao_w			varchar(60);
nr_linha_digitavel_w		varchar(60);
cd_barras_w			varchar(44);
qt_registro_w			bigint := 0;
tp_arquivo_w			varchar(1);
qt_linha_w			integer := 0;
tp_boleto_w			varchar(1);
nr_seq_nota_conclusao_w		bigint;

-- PTU_NOTA_DEB_CREDOR_DEVED
tp_cred_dev_w			varchar(1);
nm_cred_dev_w			varchar(60);
ds_endereco_w			varchar(40);
ds_end_cpl_w			varchar(20);
nr_end_w			varchar(6);
ds_bairro_w			varchar(30);
nr_cep_w			varchar(8);
ds_cidade_w			varchar(30);
cd_uf_w				varchar(2);
cd_cnpj_cpf_w			varchar(14);
nr_ddd_w			varchar(4);
nr_fone_w			varchar(9);
nr_fax_w			varchar(9);

-- PTU_NOTA_DEB_DADOS
dt_emissao_ndc_w		timestamp;
dt_ven_ndc_w			timestamp;
nr_linha_w			varchar(2);
ds_linha_w			varchar(74);
vl_ndc_w			varchar(14);
tp_doc_568_w			varchar(1);

-- PTU_NOTA_DEB_FAT_NDR
nr_fatura_orig_w		varchar(11);
dt_emissao_fatura_w		timestamp;
vl_tot_fat_w			varchar(14);
nr_ndr_w			varchar(11);
dt_emissao_ndr_w		timestamp;
vl_tot_ndr_w			varchar(14);

C01 CURSOR FOR
	SELECT	lpad(coalesce(nr_nota_debito,'0'),11,'0'),
		lpad(coalesce(trim(both to_char(dt_ven_nota,'YYYYMMDD')),' '),8,' '),
		coalesce(id_ndc_conclusao,0),
		nr_sequencia,
		nr_nota_debito
	from	ptu_nota_deb_conclusao
	where	nr_seq_nota_debito = nr_seq_nota_deb_p;

C02 CURSOR FOR
	SELECT	tp_cred_dev,
		nm_cred_dev,
		ds_endereco,
		ds_end_cpl,
		nr_end,
		ds_bairro,
		nr_cep,
		ds_cidade,
		cd_uf,
		cd_cnpj_cpf,
		nr_ddd,
		nr_fone,
		nr_fax
	from	ptu_nota_deb_credor_deved
	where	nr_seq_nota_debito 		= nr_seq_nota_deb_p
	and	nr_seq_nota_deb_conclusao	= nr_seq_nota_conclusao_w
	order by nr_sequencia;

C03 CURSOR FOR
	SELECT	dt_emissao_ndc,
		dt_ven_ndc,
		nr_linha,
		ds_linha,
		vl_ndc,
		tp_doc_568
	from	ptu_nota_deb_dados
	where	nr_seq_nota_debito		= nr_seq_nota_deb_p;


BEGIN
if (nr_seq_nota_deb_p IS NOT NULL AND nr_seq_nota_deb_p::text <> '') then
	delete from w_ptu_envio_arq
	where  nm_usuario = nm_usuario_p;

	begin
	select	nr_seq_ptu_fatura
	into STRICT	nr_seq_ptu_fatura_w
	from	pls_lote_contestacao	c,
		ptu_camara_contestacao	b,
		ptu_nota_debito	a
	where	b.nr_sequencia	= a.nr_seq_camara_contest
	and	c.nr_sequencia	= b.nr_seq_lote_contest
	and	a.nr_sequencia	= nr_seq_nota_deb_p;
	exception
	when others then
		nr_seq_ptu_fatura_w := null;
	end;

	if (nr_seq_ptu_fatura_w IS NOT NULL AND nr_seq_ptu_fatura_w::text <> '') then
		select	lpad(replace(replace(campo_mascara(pls_obter_dados_ptu_fatura(nr_seq_ptu_fatura_w,'VT'),2),',',''),'.',''),14,'0')
		into STRICT	vl_total_fatura_w
		;
	end if;

	-- HEADER
	begin
	select	lpad(a.cd_unimed_origem,4,'0'),
		lpad(a.cd_unimed_destino,4,'0'),
		lpad(a.nr_fatura,11,'0'),
		CASE WHEN coalesce(vl_total_fatura_w::text, '') = '' THEN lpad(replace(replace(campo_mascara(a.vl_total_fatura,2),',',''),'.',''),14,'0')  ELSE vl_total_fatura_w END ,
		lpad(coalesce(a.nr_nota_credito_debito_a500,0),11,'0'),
		CASE WHEN coalesce(a.vl_total_ndc_a500::text, '') = '' THEN lpad('0',14,'0')  ELSE lpad(replace(replace(campo_mascara(coalesce(a.vl_total_ndc_a500,0),2),',',''),'.',''),14,'0') END ,
		coalesce(tp_arquivo,'1')
	into STRICT	cd_unimed_origem_w,
		cd_unimed_destino_w,
		nr_fatura_w,
		vl_total_fatura_w,
		nr_nota_credito_debito_a500_w,
		vl_total_ndc_a500_w,
		tp_arquivo_w
	from	ptu_nota_debito a
	where	a.nr_sequencia = nr_seq_nota_deb_p;
	exception
	when others then
		null;
	end;

	qt_linha_w	:= qt_linha_w + 1;

	ds_conteudo_w 	:=	lpad(qt_linha_w,8,'0') ||
				'561' ||
				cd_unimed_destino_w ||
				cd_unimed_origem_w ||
				nr_fatura_w ||
				vl_total_fatura_w ||
				'05' ||
				nr_nota_credito_debito_a500_w ||
				vl_total_ndc_a500_w ||
				tp_arquivo_w;

	insert into w_ptu_envio_arq(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		ds_conteudo)
	values (nextval('w_ptu_envio_arq_seq'),
		clock_timestamp(),
		nm_usuario_p,
		ds_conteudo_w);
	ds_conteudo_w := null;

	open C01;
	loop
	fetch C01 into
		nr_nota_debito_w,
		dt_ven_nota_w,
		ie_conclusao_ndc_w,
		nr_seq_nota_conclusao_w,
		nr_titulo_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		-- DADOS DA NOTA DE DÉBITO DA CONCLUSÃO
		qt_linha_w	:= qt_linha_w + 1;

		ds_conteudo_w 	:=	lpad(qt_linha_w,8,'0') ||
					'562' ||
					nr_nota_debito_w ||
					dt_ven_nota_w ||
					ie_conclusao_ndc_w;

		insert into w_ptu_envio_arq(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			ds_conteudo)
		values (nextval('w_ptu_envio_arq_seq'),
			clock_timestamp(),
			nm_usuario_p,
			ds_conteudo_w);
		ds_conteudo_w := null;

		select	max(nr_bloqueto)
		into STRICT	nr_bloqueto_w
		from	titulo_receber
		where	nr_titulo	= nr_titulo_w;

		select	count(1)
		into STRICT	qt_registro_w
		from	ptu_nota_deb_bol	x
		where	x.nr_seq_nota_debito	= nr_seq_nota_deb_p;

		if (qt_registro_w > 0) then
			SELECT * FROM pls_obter_dados_arq_ndc( nr_seq_nota_deb_p, cd_banco_w, cd_agencia_bancaria_w, nr_nosso_numero_w, ds_uso_banco_w, cd_carteira_w, ds_especie_w, vl_titulo_w, dt_documento_w, ds_especie_doc_w, ds_aceite_w, dt_processo_w, ds_local_pagto_w, ds_obs_local_pagto_w, ds_instrucao_w, ds_observacao_w, nr_linha_digitavel_w, cd_barras_w, tp_boleto_w) INTO STRICT cd_banco_w, cd_agencia_bancaria_w, nr_nosso_numero_w, ds_uso_banco_w, cd_carteira_w, ds_especie_w, vl_titulo_w, dt_documento_w, ds_especie_doc_w, ds_aceite_w, dt_processo_w, ds_local_pagto_w, ds_obs_local_pagto_w, ds_instrucao_w, ds_observacao_w, nr_linha_digitavel_w, cd_barras_w, tp_boleto_w;
		else
			SELECT * FROM pls_obter_dados_arq_ndc_ant( nr_seq_nota_deb_p, cd_banco_w, cd_agencia_bancaria_w, nr_nosso_numero_w, ds_uso_banco_w, cd_carteira_w, ds_especie_w, vl_titulo_w, dt_documento_w, ds_especie_doc_w, ds_aceite_w, dt_processo_w, ds_local_pagto_w, ds_obs_local_pagto_w, ds_instrucao_w, ds_observacao_w, nr_linha_digitavel_w, cd_barras_w, tp_boleto_w) INTO STRICT cd_banco_w, cd_agencia_bancaria_w, nr_nosso_numero_w, ds_uso_banco_w, cd_carteira_w, ds_especie_w, vl_titulo_w, dt_documento_w, ds_especie_doc_w, ds_aceite_w, dt_processo_w, ds_local_pagto_w, ds_obs_local_pagto_w, ds_instrucao_w, ds_observacao_w, nr_linha_digitavel_w, cd_barras_w, tp_boleto_w;
		end if;

		-- BOLETO
		if (nr_bloqueto_w IS NOT NULL AND nr_bloqueto_w::text <> '') or (qt_registro_w > 0) then
			qt_linha_w	:= qt_linha_w + 1;

			ds_conteudo_w 	:=	lpad(qt_linha_w,8,'0') ||
						'563' ||
						rpad(coalesce(cd_banco_w,' '),5,' ') ||
						rpad(coalesce(cd_agencia_bancaria_w,' '),25,' ') ||
						rpad(coalesce(nr_nosso_numero_w,' '),20,' ') ||
						lpad(coalesce(ds_uso_banco_w,' '),15,' ') ||
						lpad(coalesce(cd_carteira_w,' '),10,' ') ||
						rpad(coalesce(ds_especie_w,' '),4,' ') ||
						lpad(replace(replace(campo_mascara_virgula(coalesce(vl_titulo_w,0)),'.',''),',',''),14,'0') ||
						rpad(coalesce(to_char(dt_documento_w,'YYYYMMDD'),' '),8,' ') ||
						rpad(coalesce(ds_especie_doc_w,' '),5,' ') ||
						rpad(coalesce(ds_aceite_w,' '),2,' ') ||
						rpad(coalesce(to_char(dt_processo_w,'YYYYMMDD'),' '),8,' ') ||
						rpad(ds_local_pagto_w,60,' ') ||
						rpad(ds_obs_local_pagto_w,60,' ') ||
						coalesce(tp_boleto_w,'1');

			insert into w_ptu_envio_arq(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				ds_conteudo)
			values (nextval('w_ptu_envio_arq_seq'),
				clock_timestamp(),
				nm_usuario_p,
				ds_conteudo_w);
			ds_conteudo_w := null;

			-- INSTRUÇÕES
			qt_linha_w	:= qt_linha_w + 1;

			ds_conteudo_w 	:= 	lpad(qt_linha_w,8,'0') ||
						'564' ||
						lpad(coalesce(ds_instrucao_w,' '),60,' ');

			insert into w_ptu_envio_arq(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				ds_conteudo)
			values (nextval('w_ptu_envio_arq_seq'),
				clock_timestamp(),
				nm_usuario_p,
				ds_conteudo_w);
			ds_conteudo_w := null;

			-- OBSERVAÇÕES
			qt_linha_w	:= qt_linha_w + 1;

			ds_conteudo_w 	:=	lpad(qt_linha_w,8,'0') ||
						'565' ||
						lpad(coalesce(ds_observacao_w,' '),60,' ');

			insert into w_ptu_envio_arq(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				ds_conteudo)
			values (nextval('w_ptu_envio_arq_seq'),
				clock_timestamp(),
				nm_usuario_p,
				ds_conteudo_w);
			ds_conteudo_w := null;

			-- LINHA DIGITAVEL
			qt_linha_w	:= qt_linha_w + 1;

			ds_conteudo_w 	:= 	lpad(qt_linha_w,8,'0') ||
						'566' ||
						rpad(coalesce(nr_linha_digitavel_w,' '),60,' ') ||
						rpad(coalesce(cd_barras_w,' '),44,' ');

			insert into w_ptu_envio_arq(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				ds_conteudo)
			values (nextval('w_ptu_envio_arq_seq'),
				clock_timestamp(),
				nm_usuario_p,
				ds_conteudo_w);
			ds_conteudo_w := null;
		end if;
		end;
	end loop;
	close C01;

	-- DADOS DA CREDORA E DA DEVEDORA PARA EMISSAO DA NOTA DE DÉBITO
	open C02;
	loop
	fetch C02 into
		tp_cred_dev_w,
		nm_cred_dev_w,
		ds_endereco_w,
		ds_end_cpl_w,
		nr_end_w,
		ds_bairro_w,
		nr_cep_w,
		ds_cidade_w,
		cd_uf_w,
		cd_cnpj_cpf_w,
		nr_ddd_w,
		nr_fone_w,
		nr_fax_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		nm_cred_dev_w	:= elimina_caractere_especial(elimina_acentuacao(nm_cred_dev_w));
		ds_endereco_w	:= elimina_caractere_especial(elimina_acentuacao(ds_endereco_w));
		ds_end_cpl_w	:= elimina_caractere_especial(elimina_acentuacao(ds_end_cpl_w));
		ds_bairro_w	:= elimina_caractere_especial(elimina_acentuacao(ds_bairro_w));
		ds_cidade_w	:= elimina_caractere_especial(elimina_acentuacao(ds_cidade_w));

		qt_linha_w	:= qt_linha_w + 1;

		ds_conteudo_w 	:= 	lpad(qt_linha_w,8,'0') ||
					'567' ||
					coalesce(tp_cred_dev_w,'2') ||
					rpad(coalesce(nm_cred_dev_w,' '),60,' ') ||
					rpad(coalesce(ds_endereco_w,' '),40,' ') ||
					rpad(coalesce(ds_end_cpl_w,' '),20,' ') ||
					rpad(coalesce(nr_end_w,' '),6,' ') ||
					rpad(coalesce(ds_bairro_w,' '),30,' ') ||
					rpad(coalesce(nr_cep_w,' '),8,' ') ||
					rpad(coalesce(ds_cidade_w,' '),30,' ') ||
					coalesce(cd_uf_w,'  ') ||
					rpad(coalesce(cd_cnpj_cpf_w,' '),14,' ') ||
					lpad(coalesce(nr_ddd_w,0),4,'0') ||
					lpad(coalesce(nr_fone_w,0),9,'0') ||
					lpad(coalesce(nr_fax_w,0),9,'0');

		insert into w_ptu_envio_arq(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			ds_conteudo)
		values (nextval('w_ptu_envio_arq_seq'),
			clock_timestamp(),
			nm_usuario_p,
			ds_conteudo_w);
		ds_conteudo_w := null;
		end;
	end loop;
	close C02;

	-- DADOS DA NOTA DE DÉBITO
	open C03;
	loop
	fetch C03 into
		dt_emissao_ndc_w,
		dt_ven_ndc_w,
		nr_linha_w,
		ds_linha_w,
		vl_ndc_w,
		tp_doc_568_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */
		begin
		tp_doc_568_w := coalesce(tp_doc_568_w,ie_conclusao_ndc_w);

		qt_linha_w	:= qt_linha_w + 1;

		ds_conteudo_w 	:= 	lpad(qt_linha_w,8,'0') ||
					'568' ||
					lpad(coalesce(to_char(dt_emissao_ndc_w,'yyyymmdd'),' '),8,' ') ||
					lpad(coalesce(to_char(dt_ven_ndc_w,'yyyymmdd'),' '),8,' ') ||
					lpad(coalesce(to_char(nr_linha_w),'1'),2,'0') ||
					rpad(coalesce(ds_linha_w,' '),74,' ') ||
					lpad(replace(replace(campo_mascara_virgula(coalesce(vl_ndc_w,0)),'.',''),',',''),14,'0') ||
					coalesce(tp_doc_568_w,'2');

		insert into w_ptu_envio_arq(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			ds_conteudo)
		values (nextval('w_ptu_envio_arq_seq'),
			clock_timestamp(),
			nm_usuario_p,
			ds_conteudo_w);
		ds_conteudo_w := null;
		tp_doc_568_w := null;
		end;
	end loop;
	close C03;

	-- DADOS DA FATURA/NDR ORIGINAL (A500)
	select	max(nr_fatura),
		max(dt_emissao_fatura),
		max(vl_tot_fat),
		max(nr_ndr),
		max(dt_emissao_ndr),
		max(vl_tot_ndr)
	into STRICT	nr_fatura_orig_w,
		dt_emissao_fatura_w,
		vl_tot_fat_w,
		nr_ndr_w,
		dt_emissao_ndr_w,
		vl_tot_ndr_w
	from	ptu_nota_deb_fat_ndr
	where	nr_seq_nota_debito = nr_seq_nota_deb_p;

	qt_linha_w	:= qt_linha_w + 1;

	ds_conteudo_w 	:= 	lpad(qt_linha_w,8,'0') ||
				'569' ||
				lpad(coalesce(nr_fatura_orig_w,0),11,'0') ||
				lpad(coalesce(to_char(dt_emissao_fatura_w,'yyyymmdd'),' '),8,' ') ||
				lpad(replace(replace(campo_mascara_virgula(coalesce(vl_tot_fat_w,0)),'.',''),',',''),14,'0') ||
				lpad(coalesce(nr_ndr_w,0),11,'0') ||
				lpad(coalesce(to_char(dt_emissao_ndr_w,'yyyymmdd'),' '),8,' ') ||
				lpad(replace(replace(campo_mascara_virgula(coalesce(vl_tot_ndr_w,0)),'.',''),',',''),14,'0');

	insert into w_ptu_envio_arq(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		ds_conteudo)
	values (nextval('w_ptu_envio_arq_seq'),
		clock_timestamp(),
		nm_usuario_p,
		ds_conteudo_w);

	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_gerar_a560_50 ( nr_seq_nota_deb_p bigint, nm_usuario_p text) FROM PUBLIC;

