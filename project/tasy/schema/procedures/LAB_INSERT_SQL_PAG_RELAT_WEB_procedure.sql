-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_insert_sql_pag_relat_web (nm_usuario_p text, cd_estabelecimento_p text, ie_tipo_relatorio_p INOUT text) AS $body$
DECLARE

 
ie_registro_w varchar(2):= 'N';
ie_lab_perfil_w integer;
cd_estabelecimento_w	smallint;


BEGIN 
	if (cd_estabelecimento_p = '0' or coalesce(cd_estabelecimento_p::text, '') = '') then 
		cd_estabelecimento_w := 1;
	else 
		cd_estabelecimento_w := cd_estabelecimento_p;
	end if;
 
	ie_lab_perfil_w := obter_param_usuario(80, 04, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_lab_perfil_w);
 
	SELECT CASE WHEN COUNT(1)=0 THEN 'N'  ELSE 'S' END  
	into STRICT ie_registro_w 
	FROM LAB_SQL_PAG_RELAT_WEB 
	WHERE ie_relatorio = 'LPRP';
 
	if (ie_registro_w = 'N') then 
		INSERT INTO LAB_SQL_PAG_RELAT_WEB( NR_SEQUENCIA, 
			 DT_ATUALIZACAO_NREC, 
			 NM_USUARIO_NREC, 
			 DT_ATUALIZACAO, 
			 NM_USUARIO, 
			 DS_SQL_QUEBRA, 
			 DS_SQL_REGISTRO, 
			 CD_EMPRESA, 
			 CD_ESTABELECIMENTO, 
			 QT_ALTURA_BANDA_ASSINATURA, 
			 IE_RELATORIO ) 
		VALUES (nextval('lab_sql_pag_relat_web_seq'),  
			 clock_timestamp(), 
			 'TASY',  
			 clock_timestamp(), 
			 'TASY', 
			 'SELECT 	DISTINCT c.cd_material_exame, 
		p.dt_nascimento dt_nascimento, 
		OBTER_CONVENIO_ATEND_AUTOR(b.nr_atendimento) ds_convenio, 
		obter_nome_setor(b.cd_setor_atendimento) ds_setor_coleta, 
		f.nr_sequencia nr_seq_material, 
		DECODE(e.nm_usuario_liberacao,NULL,e.nm_usuario_aprovacao,e.nm_usuario_liberacao)nm_usuario_liberacao, 
		f.ds_material_exame ds_material_exame, 
		obter_nome_setor(b.cd_setor_atendimento) ds_setor_atendimento, 
		p.nm_pessoa_fisica nm_paciente, 
		g.nm_pessoa_fisica nm_medico, 
		b.dt_prescricao, 
		c.nr_prescricao, 
		f.nr_sequencia || DECODE(e.nm_usuario_liberacao,NULL,e.nm_usuario_aprovacao,e.nm_usuario_liberacao) vl_quebra 
FROM  pessoa_fisica g, 
		pessoa_fisica p, 
		exame_laboratorio d, 
		material_exame_lab f, 
		prescr_procedimento c, 
		prescr_medica b, 
		result_laboratorio a, 
		exame_lab_result_item e, 
		exame_lab_resultado h 
WHERE  b.nr_prescricao	= c.nr_prescricao 
AND c.nr_seq_exame = d.nr_seq_exame 
AND c.cd_material_exame = f.cd_material_exame 
AND b.cd_medico = g.cd_pessoa_fisica 
AND b.cd_pessoa_fisica = p.cd_pessoa_fisica 
AND	 f.cd_material_exame = c.cd_material_exame 
AND a.nr_prescricao = b.nr_prescricao 
AND a.nr_seq_prescricao = c.nr_sequencia 
AND b.nr_prescricao = h.nr_prescricao 
AND h.nr_seq_resultado = e.nr_seq_resultado 
AND c.nr_sequencia = e.nr_seq_prescr 
AND c.nr_seq_exame = e.nr_seq_exame 
AND b.nr_prescricao	= :nr_prescricao 
AND c.nr_sequencia = DECODE(:nr_seq_prescricao,0,c.nr_sequencia,:nr_seq_prescricao) 
AND obter_ds_status_result_exame(c.nr_prescricao, c.nr_sequencia, :nm_usuario_cor, :cd_estabelecimento_cor) <> OBTER_DESC_EXPRESSAO(347424) 
ORDER BY f.ds_material_exame, nm_usuario_liberacao , obter_nome_setor(b.cd_setor_atendimento) ', 
			 'SELECT e.ds_resultado, 
	  e.nr_sequencia 
FROM exame_lab_result_item a, 
	 exame_lab_resultado b, 
	 prescr_procedimento c, 
	 result_laboratorio e 
WHERE c.nr_prescricao = b.nr_prescricao 
AND b.nr_seq_resultado = a.nr_seq_resultado 
AND c.nr_sequencia = a.nr_seq_prescr 
AND c.nr_prescricao = e.nr_prescricao 
AND c.nr_sequencia = e.NR_SEQ_PRESCRICAO 
AND obter_ds_status_result_exame(c.nr_prescricao,c.nr_sequencia,:nm_usuario_cor, :cd_estabelecimento_cor) <> OBTER_DESC_EXPRESSAO(347424) 
AND c.nr_prescricao = :nr_prescricao 
AND c.nr_sequencia = DECODE(:nr_seq_prescricao,0,c.nr_sequencia,:nr_seq_prescricao) 
and	a.nr_seq_material || DECODE(a.nm_usuario_liberacao,NULL,a.nm_usuario_aprovacao,a.nm_usuario_liberacao) = :vl_quebra 
ORDER BY e.nr_sequencia--c.cd_material_exame 
', 
			 1, 
			 cd_estabelecimento_w, 
			 0, 
			 'LPRP'); 	 		
 	end if;	
 
	SELECT CASE WHEN COUNT(1)=0 THEN 'N'  ELSE 'S' END  
	into STRICT ie_tipo_relatorio_p 
 	FROM RELATORIO_PERFIL a, 
 		 relatorio b 
	WHERE cd_perfil = ie_lab_perfil_w 
	AND  a.nr_seq_relatorio = b.nr_sequencia 
	AND  b.CD_CLASSIF_RELAT = 'CLAB' 
	AND  b.CD_RELATORIO_WHEB = 4071 
	AND  a.ie_imprimir = 'S'; 	
 
 	 
commit;	 	
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_insert_sql_pag_relat_web (nm_usuario_p text, cd_estabelecimento_p text, ie_tipo_relatorio_p INOUT text) FROM PUBLIC;

