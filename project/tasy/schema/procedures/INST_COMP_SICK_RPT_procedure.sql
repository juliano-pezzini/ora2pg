-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inst_comp_sick_rpt ( nr_atendimento_p sick_leave_report.nr_atendimento%TYPE, nm_usuario_p sick_leave_report.nm_usuario%TYPE, nm_usuario_nrec_p sick_leave_report.nm_usuario_nrec%TYPE ) AS $body$
DECLARE


    comp_flg_cnst_p   CONSTANT sick_leave_report.nm_pat_name%TYPE := 'Y';
    const_one         CONSTANT sick_leave_report.nr_atendimento%TYPE := 1;
    const_eighty      CONSTANT sick_leave_report.nr_atendimento%TYPE := 80;


BEGIN
 BEGIN
        INSERT INTO sick_leave_report(
            nr_sequencia,
            dt_atualizacao,
            nm_usuario,
            dt_atualizacao_nrec,
            nm_usuario_nrec,
            nr_atendimento,
            nm_companion_name,
            nm_company_name,
            nm_rel_type,
            nr_comp_id,
            ie_comp_flg
        )
            SELECT
                nextval('sick_leave_report_seq'),
                clock_timestamp(),
                nm_usuario_p,
                clock_timestamp(),
                nm_usuario_nrec_p,
                nr_atendimento_p,
                substr(obter_nome_pf(a.cd_pessoa_fisica), const_one, const_eighty),
                substr(obter_nome_empresa_ref(cpf.cd_empresa_refer), const_one, const_eighty),
                vd.ds_visitante,
                a.cd_pessoa_fisica,
                comp_flg_cnst_p
            FROM
                atendimento_acompanhante   a
                JOIN compl_pessoa_fisica        cpf ON cpf.CD_PESSOA_FISICA_REF = a.cd_pessoa_fisica
                JOIN visitante                  vd ON vd.nr_sequencia = a.nr_seq_tipo
            WHERE
                a.nr_atendimento = nr_atendimento_p;

    EXCEPTION
        WHEN unique_violation THEN
            NULL;
    END;
    COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inst_comp_sick_rpt ( nr_atendimento_p sick_leave_report.nr_atendimento%TYPE, nm_usuario_p sick_leave_report.nm_usuario%TYPE, nm_usuario_nrec_p sick_leave_report.nm_usuario_nrec%TYPE ) FROM PUBLIC;

