-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tra_exec_upd_tabelas_traducao (dt_ultima_exec_p timestamp, nm_atributo_p corp_tabelas_traducao.nm_tabela%type, nm_atributo_exp_p corp_tabelas_traducao.nm_atributo_exp%type, nm_tabela_p corp_tabelas_traducao.nm_atributo%type) AS $body$
DECLARE


cd_exp_retorno_w		dic_expressao.cd_expressao%type;
ds_exp_retorno_w		dic_expressao.ds_expressao_br%type;
vl_campo_ds_w			varchar(4000);
vl_campo_exp_w			varchar(4000);
nm_usuario_w			varchar(50);
retorno_w				bigint;


ds_sep_bv_w				varchar(50);
ds_comando_select_w		varchar(4000);
ds_comando_update_w		varchar(4000);
nm_user_w 				varchar(10);

ds_erro_w				varchar(4000);

cur_id					bigint;

C02 REFCURSOR;


BEGIN
ds_sep_bv_w	:= obter_separador_bv;

select	substr(user,1,4)
into STRICT 	nm_user_w
;

if (dt_ultima_exec_p IS NOT NULL AND dt_ultima_exec_p::text <> '') then
	ds_comando_select_w := 'select	' || nm_atributo_p 		|| ', ' ||
										 nm_atributo_exp_p 	|| ', ' ||
										 ' nm_usuario ' ||
							' from	' || nm_tabela_p ||
							' where	dt_atualizacao > ' || dt_ultima_exec_p ||
							' and ' || nm_atributo_p || ' is not null ';
else
	ds_comando_select_w := 'select	' || nm_atributo_p 		|| ', ' ||
										 nm_atributo_exp_p 	|| ', ' ||
										 ' nm_usuario ' ||
							' from	' || nm_tabela_p ||
							' where ' || nm_atributo_p || ' is not null ';
end if;

BEGIN
	cur_id := DBMS_SQL.OPEN_CURSOR;
	DBMS_SQL.PARSE(cur_id, ds_comando_select_w, DBMS_SQL.NATIVE);
	DBMS_SQL.DEFINE_COLUMN(cur_id, 1, vl_campo_ds_w, 4000);
	DBMS_SQL.DEFINE_COLUMN(cur_id, 2, vl_campo_exp_w, 4000);
	DBMS_SQL.DEFINE_COLUMN(cur_id, 3, nm_usuario_w, 50);

	retorno_w := DBMS_SQL.execute(cur_id);

	WHILE DBMS_SQL.FETCH_ROWS(cur_id) > 0 LOOP

		DBMS_SQL.COLUMN_VALUE(cur_id, 1, vl_campo_ds_w);
		DBMS_SQL.COLUMN_VALUE(cur_id, 2, vl_campo_exp_w);
		DBMS_SQL.COLUMN_VALUE(cur_id, 3, nm_usuario_w);



		if (nm_user_w = 'CORP' ) then
			SELECT * FROM man_traduzir_texto(substr(vl_campo_ds_w,1,4000), nm_usuario_w, cd_exp_retorno_w, ds_exp_retorno_w) INTO STRICT cd_exp_retorno_w, ds_exp_retorno_w;
		else
			select	max(a.cd_expressao)
			into STRICT	cd_exp_retorno_w
			from	dic_expressao	a
			where	a.ds_expressao_br = vl_campo_ds_w;
		end if;

		if (coalesce(cd_exp_retorno_w, 0) > 0) then


			ds_comando_update_w :=  ' update ' || nm_tabela_p || ' ' ||
									' set ' || nm_atributo_exp_p || ' = :cd_exp_p ' ||
									' where ' || nm_atributo_p || ' = :vl_campo_ds_p ';

			CALL Exec_Sql_Dinamico_bv('TRA_EXEC_UPD_TABELAS_TRADUCAO', ds_comando_update_w,  'cd_exp_p=' ||cd_exp_retorno_w ||  ds_sep_bv_w ||
																						'vl_campo_ds_p=' ||vl_campo_ds_w);

			--insert into LOG_CORP_TABELAS_TRADUCAO (nm_tabela, ds_log, dt_execucao) values (nm_tabela_p, 'ds_comando_update_w= ' || ds_comando_update_w ||
			--																						' cd_exp_retorno_w = ' || cd_exp_retorno_w ||
			--																							' vl_campo_ds_w = ' || vl_campo_ds_w, null);
		end if;

	END LOOP;
	DBMS_SQL.CLOSE_CURSOR(cur_id);

EXCEPTION
	WHEN OTHERS THEN
	ds_erro_w := SUBSTR(SQLERRM,1,4000);
	insert into LOG_CORP_TABELAS_TRADUCAO(nm_tabela, ds_log, dt_execucao) values (nm_tabela_p, ds_erro_w, null);
END;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tra_exec_upd_tabelas_traducao (dt_ultima_exec_p timestamp, nm_atributo_p corp_tabelas_traducao.nm_tabela%type, nm_atributo_exp_p corp_tabelas_traducao.nm_atributo_exp%type, nm_tabela_p corp_tabelas_traducao.nm_atributo%type) FROM PUBLIC;

