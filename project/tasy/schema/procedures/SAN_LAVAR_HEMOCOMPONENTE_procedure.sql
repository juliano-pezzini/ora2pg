-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_lavar_hemocomponente ( nm_usuario_p text, nr_seq_producao_p bigint) AS $body$
DECLARE



qt_volume_w			smallint;
cd_pessoa_fisica_w		varchar(10);
ie_alterar_inicio_lavagem_w	varchar(1);
ie_opcao_w			varchar(1);
ie_bloqueio_w			varchar(1);
nr_seq_doacao_w			bigint;
dt_vencimento_w			timestamp;
ie_alterar_dt_vencimento_w	varchar(1);


BEGIN

if (nr_seq_producao_p IS NOT NULL AND nr_seq_producao_p::text <> '') then
	begin
	ie_bloqueio_w 			:= 'N';
	ie_alterar_inicio_lavagem_w 	:= obter_valor_param_usuario(450,351,obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);
	ie_alterar_dt_vencimento_w  	:= obter_valor_param_usuario(450,449,obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);

	select	min(dt_vencimento)
	into STRICT	dt_vencimento_w
	from	san_producao_lavagem
	where	nr_seq_producao = nr_seq_producao_p;



	if (ie_alterar_inicio_lavagem_w = 'N' and ((ie_alterar_dt_vencimento_w = 'S' and (dt_vencimento_w IS NOT NULL AND dt_vencimento_w::text <> ''))
												or (ie_alterar_dt_vencimento_w <> 'S'))) then
		update	san_producao
		set	ie_lavado 		= 	'S',
			nm_usuario_lavado	=	nm_usuario_p,
			dt_vencimento		= CASE WHEN ie_alterar_dt_vencimento_w='S' THEN dt_vencimento_w  ELSE dt_vencimento END
		where	nr_sequencia		=	nr_seq_producao_p;
	end if;

	SELECT 	max(b.cd_pessoa_fisica),
		max(b.nr_sequencia)
	into STRICT	cd_pessoa_fisica_w,
		nr_seq_doacao_w
	FROM	san_producao a,
		san_doacao b,
		san_regra_trali c
	WHERE	a.nr_seq_doacao 	= b.nr_sequencia
	AND	c.nr_seq_derivado 	= a.nr_seq_derivado
	AND	a.nr_sequencia		= nr_seq_producao_p;

	SELECT 	coalesce(max(ie_opcao),'N')
	into STRICT	ie_opcao_w
	FROM   	san_producao a,
		san_regra_trali b
	WHERE  	a.nr_seq_derivado 	= b.nr_seq_derivado
	AND  	b.ie_lavado		= 'S'
	AND	(ie_tipo_bloqueio IS NOT NULL AND ie_tipo_bloqueio::text <> '')
	AND	a.nr_sequencia 		= nr_seq_producao_p;


	if (ie_opcao_w = 'M') then
		ie_bloqueio_w := obter_se_doadora_multigesta( nr_seq_doacao_w);
	elsif (ie_opcao_w = 'T') then
		ie_bloqueio_w := san_obter_se_doador_trali(cd_pessoa_fisica_w);
	elsif (ie_opcao_w = 'A') then
		ie_bloqueio_w := obter_se_doadora_multigesta( nr_seq_doacao_w);
		if (ie_bloqueio_w <> 'S') then
			ie_bloqueio_w := san_obter_se_doador_trali(cd_pessoa_fisica_w);
		end if;
	end if;

	if (ie_bloqueio_w = 'S') then --desfazer bloqueio
		CALL san_desbloquear_hemocomponente(nr_seq_producao_p);
	end if;

	/*select	qt_volume
	into	qt_volume_w
	from	san_producao
	where	nr_sequencia	= nr_seq_producao_p;

	select 	cd_pessoa_fisica
	into	cd_pessoa_fisica_w
	from	usuario
	where	nm_usuario = nm_usuario_p;

	insert into san_producao_lavagem(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			qt_volume_inicial,
			cd_pessoa_fisica,
			nr_seq_producao,
			dt_lavagem,
			dt_vencimento)
		values(
			san_producao_lavagem_seq.nextVal,
			sysdate,
			nm_usuario_p,
			sysdate,
			nm_usuario_p,
			qt_volume_w,
			cd_pessoa_fisica_w,
			nr_seq_producao_p,
			sysdate,
			sysdate + 1);*/
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_lavar_hemocomponente ( nm_usuario_p text, nr_seq_producao_p bigint) FROM PUBLIC;

