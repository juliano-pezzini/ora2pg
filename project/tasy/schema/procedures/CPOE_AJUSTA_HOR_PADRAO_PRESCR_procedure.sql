-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_ajusta_hor_padrao_prescr ( nr_atendimento_p bigint, ds_horarios_p text, ds_horarios2_p INOUT text, ds_horarios3_p INOUT text, nr_ocorrencia_p INOUT bigint) AS $body$
DECLARE

								 
dt_inicio_prescricao_w			prescr_medica.dt_validade_prescr%type;							
dt_validade_prescr_w			prescr_medica.dt_validade_prescr%type;
nr_hora_validade_w				prescr_medica.nr_horas_validade%type;
dt_primeiro_horario_w			prescr_medica.dt_primeiro_horario%type;

ds_horarios_w					intervalo_prescricao.ds_horarios%type;

cd_setor_atend_prescr_w			setor_atendimento.cd_setor_atendimento%type;

ds_caracter_espaco_w			varchar(255);
ds_hora_w						varchar(7);
ds_horarios_fixo_w				varchar(2000);
hr_horario_setor_w				varchar(10);

ie_controle_w					smallint	:= 0;
qt_pertence_w					bigint;
k								bigint;
nr_intervalo_w					bigint;
qt_dia_adic_w					bigint := 0;

dt_medic_w						timestamp;
dt_Hora_Inicio_w				timestamp;
dt_horario_w					timestamp;


BEGIN 
dt_inicio_prescricao_w := clock_timestamp();
 
/* Rotina para calcular a validade da prescricao */
 
nr_hora_validade_w	:= 24;
	 
dt_primeiro_horario_w	:= to_date(substr(to_char(clock_timestamp(),'dd/mm/yyyy'),1,10) || ' ' || to_char(trunc(clock_timestamp(),'hh') + 1/24,'hh24:mi') || ':00','dd/mm/yyyy hh24:mi:ss');
	 
	if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then 
 
		nr_hora_validade_w	:= coalesce(Obter_Horas_Validade_Prescr( to_date(substr(to_char(clock_timestamp(),'dd/mm/yyyy'),1,10) || ' ' || to_char(trunc(clock_timestamp(),'hh') + 1/24,'hh24:mi') || ':00','dd/mm/yyyy hh24:mi:ss'), 
									nr_atendimento_p, 
									'N', 
									'A', 
									trunc(clock_timestamp(),'mi'), null),24);
		 
		nr_hora_validade_w := nr_hora_validade_w + 24;
		 
		select	max(to_char(hr_inicio_prescricao,'hh24:mi')) 
		into STRICT	hr_horario_setor_w 
		from	setor_atendimento 
		where	cd_setor_atendimento = cd_setor_atend_prescr_w;
 
		if (hr_horario_setor_w IS NOT NULL AND hr_horario_setor_w::text <> '') and (hr_horario_setor_w <> to_char((dt_primeiro_horario_w + 1/nr_hora_validade_w),'hh24:mi')) then 
			nr_hora_validade_w	:= nr_hora_validade_w + 1;
		end if;
		 
		dt_validade_prescr_w := clock_timestamp() + coalesce(nr_hora_validade_w,24) / 24;
 
	end if;		
/* Fim Rotina para calcular a validade da prescricao */
 
 
if (position(':' in ds_horarios_p) > 0) then 
	dt_Hora_Inicio_w := to_date(to_char(dt_inicio_prescricao_w,'dd/mm/yyyy')||' '||substr(ds_horarios_p,1,5) || ':00','dd/mm/yyyy hh24:mi:ss');
else 
	dt_Hora_Inicio_w := to_date(to_char(dt_inicio_prescricao_w,'dd/mm/yyyy') ||' '||substr(ds_horarios_p,1,2) || ':00:00','dd/mm/yyyy hh24:mi:ss');
end if;
 
ds_caracter_espaco_w	:= ' ';
 
 
ds_horarios_w	:= padroniza_horario_prescr(reordenar_horarios(dt_Hora_Inicio_w,ds_horarios_p), to_char(dt_inicio_prescricao_w,'dd/mm/yyyy hh24:mi:ss')) || ds_caracter_espaco_w;
nr_intervalo_w	:= 0;
 
while	(ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') LOOP 
	begin 
	 
	select	position(ds_caracter_espaco_w in ds_horarios_w) 
	into STRICT	k 
	;		
	 
	if (k > 1) and ((substr(ds_horarios_w, 1, k -1) IS NOT NULL AND (substr(ds_horarios_w, 1, k -1))::text <> '')) then 
		begin 
		ds_hora_w		:= substr(ds_horarios_w, 1, k-1);
		ds_hora_w		:= replace(ds_hora_w, ds_caracter_espaco_w,'');
		ds_horarios_w		:= substr(ds_horarios_w, k + 1, 2000);
		 
		if (ie_controle_w = 0) and (ds_hora_w < to_char(dt_inicio_prescricao_w,'hh24:mi')) then 
			qt_dia_adic_w	:= 1;
		elsif (position('A' in ds_hora_w) > 0) and (qt_dia_adic_w = 0) then 
			qt_dia_adic_w	:= 1;
		elsif (position('AA' in ds_hora_w) > 0) then 
			qt_dia_adic_w	:= qt_dia_adic_w + 1;
		end if;
		ie_controle_w	:= 1;
		ds_hora_w	:= replace(ds_hora_w,'A','');
		ds_hora_w	:= replace(ds_hora_w,'A','');
		 
		dt_horario_w	:= to_date(to_char(dt_inicio_prescricao_w + qt_dia_adic_w,'dd/mm/yyyy')||' '||replace(ds_hora_w,'A','')||':00','dd/mm/yyyy hh24:mi:ss');
		 
		select	count(*) 
		into STRICT		qt_pertence_w 
		 
		where	dt_horario_w >= dt_inicio_prescricao_w 
		and 		dt_horario_w < dt_validade_prescr_w;
 
		if (qt_pertence_w > 0) then 
			begin 
			ds_horarios_fixo_w	:= ds_horarios_fixo_w || ds_hora_w ||ds_caracter_espaco_w;
			nr_intervalo_w		:= nr_intervalo_w + 1;
			end;
		end if;
 
		end;
	elsif (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then 
		begin 
		ds_horarios_w		:= '';
		end;
	end if;
	end;
END LOOP;
if (nr_intervalo_w < 0) then 
	nr_intervalo_w	:= 0;
end if;
if (nr_intervalo_w = 0) or (coalesce(nr_intervalo_w::text, '') = '') then 
	nr_intervalo_w := 1;
end if;
 
nr_ocorrencia_p	:= nr_intervalo_w;
ds_horarios2_p	:= substr(ds_horarios_fixo_w,1,254);
ds_horarios3_p	:= substr(ds_horarios_fixo_w,255,255);
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_ajusta_hor_padrao_prescr ( nr_atendimento_p bigint, ds_horarios_p text, ds_horarios2_p INOUT text, ds_horarios3_p INOUT text, nr_ocorrencia_p INOUT bigint) FROM PUBLIC;

