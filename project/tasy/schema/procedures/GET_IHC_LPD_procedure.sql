-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE get_ihc_lpd ( nr_seq_acs_p ihc_acs.nr_sequencia%type, nm_usuario_p ihc_acs.nm_usuario%type) AS $body$
DECLARE



nr_encounter_w  conta_paciente.nr_atendimento%type;	
nr_seq_claim_w  ihc_acs.nr_seq_claim%type;
nr_account_w	ihc_claim.nr_account%type;
nr_records_w	integer;
	
c01 CURSOR FOR
SELECT	dt_saida_temporaria,
		dt_retorno_saida_temporaria,
		qt_days,
		cd_setor_atendimento
from (  SELECT		apu.dt_saida_temporaria dt_saida_temporaria,
					apu.dt_retorno_saida_temporaria dt_retorno_saida_temporaria,
					CASE WHEN trunc(apu.dt_retorno_saida_temporaria - apu.dt_saida_temporaria)=0 THEN  1  ELSE trunc(apu.dt_retorno_saida_temporaria - apu.dt_saida_temporaria) END  qt_days,
					cd_setor_atendimento
		from		atend_paciente_unidade apu
		where		nr_atendimento = nr_encounter_w 
		and			(dt_retorno_saida_temporaria IS NOT NULL AND dt_retorno_saida_temporaria::text <> '') 
		and			(dt_saida_temporaria IS NOT NULL AND dt_saida_temporaria::text <> '') 				
		order by	dt_entrada_unidade desc) alias4 LIMIT 9;
		
	
BEGIN
	
		select	max(nr_seq_claim)
		into STRICT	nr_seq_claim_w
		from	ihc_acs
		where 	nr_sequencia = nr_seq_acs_p;	

		select	max(a.nr_atendimento),
				max(b.nr_account)
		into STRICT	nr_encounter_w,
				nr_account_w
		from	conta_paciente a,
				ihc_claim b
		where 	a.nr_interno_conta = b.nr_account
		and		b.nr_sequencia	=	nr_seq_claim_w;
				
		for encounter_patiente_w in c01 loop
			
			if (encounter_patiente_w.dt_retorno_saida_temporaria < encounter_patiente_w.dt_saida_temporaria) then
				CALL generate_inco_eclipse(nr_account_w, 1, 'Dep.: '||encounter_patiente_w.cd_setor_atendimento|| '. '|| obter_desc_expressao(840785), nm_usuario_p);
			end if;
			
			select  count(nr_sequencia)
			into STRICT    nr_records_w
			from    eclipse_inco_account
			where   nr_interno_conta = nr_account_w;
		
			if (BILLING_I18N_PCK.GET_VALIDATE_ECLIPSE() = 'N') and (nr_records_w = 0) then
			
				begin
					insert into ihc_acd(
						nr_sequencia,
						nm_usuario,
						dt_atualizacao,
						nm_usuario_nrec,
						dt_atualizacao_nrec,
						nr_seq_claim,
						nr_seq_acs,
						ie_type,
						dt_from,
						dt_end,
						qt_days
					) values (
						nextval('ihc_acd_seq'),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nr_seq_claim_w,
						nr_seq_acs_p,
						'LPD',
						encounter_patiente_w.dt_saida_temporaria,
						encounter_patiente_w.dt_retorno_saida_temporaria,
						encounter_patiente_w.qt_days
					);
				end;

				update ihc_acs
				set ie_situation = 'A'
				where nr_sequencia = nr_seq_acs_p;
			end if;
			
		end loop;
		
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE get_ihc_lpd ( nr_seq_acs_p ihc_acs.nr_sequencia%type, nm_usuario_p ihc_acs.nm_usuario%type) FROM PUBLIC;

