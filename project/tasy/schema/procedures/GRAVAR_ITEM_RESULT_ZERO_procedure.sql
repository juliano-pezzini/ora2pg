-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_item_result_zero ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text, ds_erro_p INOUT text ) AS $body$
DECLARE


    nr_prescricao_w                  bigint;
    ie_gerar_linha_result_integr_w   varchar(1);
    cd_exame_w                       varchar(20);
    ds_erro_w                        varchar(255);
    nr_seq_exame_w                   bigint;
    cd_material_exame_w              prescr_procedimento.cd_material_exame%TYPE;
    qt_itens_w                       bigint;

BEGIN
    nr_prescricao_w := nr_prescricao_p;
    SELECT
        MAX(nr_seq_exame),
        MAX(cd_material_exame)
    INTO STRICT
        nr_seq_exame_w,
        cd_material_exame_w

from
        prescr_procedimento
    WHERE
        nr_prescricao = nr_prescricao_w
        AND nr_sequencia = nr_seq_prescr_p;



select
        COUNT(*)
    INTO STRICT qt_itens_w
    FROM
        exame_lab_result_item   a,

	exame_lab_resultado     b
    WHERE
        a.nr_seq_resultado = b.nr_seq_resultado
        AND b.nr_prescricao = nr_prescricao_w
        AND a.nr_seq_prescr = nr_seq_prescr_p
        AND nr_seq_exame = nr_seq_exame_w
        AND ( a.qt_resultado > 0
              OR ( (a.ds_resultado IS NOT NULL AND a.ds_resultado::text <> '')
                   AND a.ds_resultado <> ' ' ) );

    SELECT
        MAX(coalesce(cd_exame_integracao, cd_exame)),
        MAX(ie_gerar_linha_result_integr)
    INTO STRICT
        cd_exame_w,
        ie_gerar_linha_result_integr_w
    FROM
        exame_laboratorio
    WHERE
        nr_seq_exame = nr_seq_exame_w;

    IF ( coalesce(nr_seq_exame_w, 0) > 0 ) AND ( qt_itens_w = 0 ) THEN
        IF ( ie_gerar_linha_result_integr_w = 'S' ) THEN
            ds_erro_w := atualizar_lab_result_item(nr_prescricao_w, nr_seq_prescr_p, cd_exame_w, 0, 0, ' ', '', cd_material_exame_w, 'N', nm_usuario_p, NULL, NULL, NULL, NULL, NULL, ds_erro_w);

        END IF;
    ELSE
        IF ( ie_gerar_linha_result_integr_w = 'S' ) THEN
            ds_erro_w := wheb_mensagem_pck.get_texto(281774, 'NR_PRESCRICAO='
                                                             || nr_prescricao_w
                                                             || ';NR_SEQ_PRESCR='
                                                             || nr_seq_prescr_p);

        END IF;
    END IF;

    ds_erro_p := ds_erro_w;
    COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_item_result_zero ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text, ds_erro_p INOUT text ) FROM PUBLIC;

