-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_dil_sobra_overfill (nr_seq_superior_p bigint, nr_seq_cabine_p bigint, cd_diluente_p bigint, cd_medicamento_p bigint, qt_vol_dil_ml_p bigint, qt_dose_medic_ml_p bigint, dt_estabilidade_p timestamp, nr_sequencia_p INOUT bigint, nr_seq_lote_fornec_p text default null) AS $body$
DECLARE


qt_saldo_sup_w 		double precision;
qt_saldo_w 			double precision;
cd_um_superior_w 	varchar(10);
ie_tipo_superior_w	varchar(2);
next_val_w			bigint;
nr_seq_lote_fornec_w bigint;


BEGIN
--qt_dose_dil_ml_p: dose em ml do medicamento a que foi diluido
select 	Obter_conversao_ml(cd_medicamento_p, qt_saldo, cd_unidade_medida),
		UPPER(cd_unidade_medida),
		coalesce(substr(ie_tipo,1,1),'S'),
		nr_seq_lote_fornec
into STRICT 	qt_saldo_sup_w,
		cd_um_superior_w,
		ie_tipo_superior_w,
		nr_seq_lote_fornec_w
from 	quimio_sobra_overfill
where	nr_sequencia = nr_seq_superior_p;

select nextval('quimio_sobra_overfill_seq')
into STRICT next_val_w
;


--inserir novo medicamento diluÃ­do
if (qt_saldo_sup_w >= qt_dose_medic_ml_p) then
	insert into quimio_sobra_overfill(nr_sequencia,
					nr_seq_superior,
					cd_estabelecimento,
					nr_seq_cabine,
					dt_atualizacao,
					dt_atualizacao_nrec,
					nm_usuario,
					nm_usuario_nrec,
					cd_material,
					qt_saldo,
					qt_inicial,
					cd_unidade_medida,
					ie_tipo,
					dt_estabilidade,
					nr_seq_lote_fornec)
	values (			next_val_w,
					nr_seq_superior_p,
					obter_estabelecimento_ativo,
					nr_seq_cabine_p,
					clock_timestamp(),
					clock_timestamp(),
					obter_usuario_ativo,
					obter_usuario_ativo,
					cd_medicamento_p,
					qt_dose_medic_ml_p,
					qt_dose_medic_ml_p,
					obter_unid_med_usua('ml'),
					ie_tipo_superior_w || 'D',
					dt_estabilidade_p,
					nr_seq_lote_fornec_w);

	--inserir diluente do medicamento
	insert into quimio_sobra_overfill(nr_sequencia,
					nr_seq_superior,
					cd_estabelecimento,
					nr_seq_cabine,
					dt_atualizacao,
					dt_atualizacao_nrec,
					nm_usuario,
					nm_usuario_nrec,
					cd_material,
					qt_saldo,
					qt_inicial,
					cd_unidade_medida,
					ie_tipo,
					nr_seq_lote_fornec)
	values (			nextval('quimio_sobra_overfill_seq'),
					next_val_w,
					obter_estabelecimento_ativo,
					nr_seq_cabine_p,
					clock_timestamp(),
					clock_timestamp(),
					obter_usuario_ativo,
					obter_usuario_ativo,
					cd_diluente_p,
					qt_vol_dil_ml_p,
					qt_vol_dil_ml_p,
					obter_unid_med_usua('ml'),
					'DI',
					nr_seq_lote_fornec_p);


	qt_saldo_w := obter_conversao_unid_med_cons(cd_medicamento_p, upper(obter_unid_med_usua('ML')) , qt_saldo_sup_w - qt_dose_medic_ml_p); --converter a sobra para UC
	qt_saldo_w := qt_saldo_w * obter_conversao_unid_med(cd_medicamento_p, cd_um_superior_w); --converter a sobra para UC do medicamento
	update  quimio_sobra_overfill
	set 	qt_saldo = round((qt_saldo_w)::numeric,3)
	where	nr_sequencia = nr_seq_superior_p;

	commit;
	nr_sequencia_p := next_val_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_dil_sobra_overfill (nr_seq_superior_p bigint, nr_seq_cabine_p bigint, cd_diluente_p bigint, cd_medicamento_p bigint, qt_vol_dil_ml_p bigint, qt_dose_medic_ml_p bigint, dt_estabilidade_p timestamp, nr_sequencia_p INOUT bigint, nr_seq_lote_fornec_p text default null) FROM PUBLIC;

