-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE intpd_recebe_titulo_rec_liq ( nr_sequencia_p bigint, xml_p xml) AS $body$
DECLARE


_ora2pg_r RECORD;
ie_conversao_w			intpd_eventos_sistema.ie_conversao%type;
nr_seq_sistema_w		intpd_eventos_sistema.nr_seq_sistema%type;	
nr_seq_projeto_xml_w		intpd_eventos_sistema.nr_seq_projeto_xml%type;
nr_seq_regra_w			conversao_meio_externo.nr_seq_regra%type;
ie_sistema_externo_w		varchar(15);
reg_integracao_w		gerar_int_padrao.reg_integracao_conv;
titulo_receber_liq_w		titulo_receber_liq%rowtype;
ds_erro_w			varchar(4000);
titulo_rec_liq_cc_w		titulo_rec_liq_cc%rowtype;

c01 CURSOR FOR
SELECT	*
from	xmltable('/STRUCTURE/ACCOUNT_RECEIVABLE_SETTLEMENT' passing xml_p columns
		cd_agencia_bancaria		varchar(8)	path	'CD_BANK_BRANCH',
		cd_banco			integer	path	'CD_BANK',
		cd_centro_custo			integer	path	'CD_COST_CENTER',
		cd_centro_custo_desc		integer	path	'CD_DISCOUNT_COST_CENTER',
		cd_cgc_emp_cred			varchar(14)	path	'CD_CREDIT_CARD_COMPANY',
		cd_moeda			integer	path	'CD_CURRENCY',
		cd_tipo_recebimento		integer	path	'CD_RECEIVING_TYPE',
		ds_observacao			varchar(255)	path	'DS_NOTE',			
		dt_autenticacao			varchar(14)	path	'DT_AUTHENTICATION',		
		dt_credito_banco		varchar(14)	path	'DT_BANK_CREDIT',
		dt_integracao_externa		varchar(14)	path	'DT_EXTERNAL_INTEGRATION',
		dt_real_recebimento		varchar(14)	path	'DT_REAL_RECEIPT',
		dt_recebimento			varchar(14)	path	'DT_PAYMENT',
		ie_origem_baixa			varchar(15)	path	'IE_SETTLEMENT_ORIGIN',
		ie_tipo_perda			varchar(1)	path	'IE_LOSS_TYPE',
		nm_usuario			varchar(15)	path	'NM_USER',
		nr_adiantamento			bigint	path	'NR_ADVANCED_PAYMENT',
		nr_bordero			bigint	path	'NR_BORDERO',
		nr_cartao_cred			varchar(20)	path	'NR_CREDIT_CARD',
		nr_documento			varchar(22)	path	'NR_DOCUMENT',
		nr_lote_contabil		bigint	path	'NR_ACCOUNTING_BATCH',
		nr_nota_fiscal_devol		bigint	path	'NR_RETURN_INVOICE',
		nr_repasse_terceiro		bigint	path	'NR_THIRD_PARTY_TRANSFER',
		nr_seq_caixa_rec		bigint	path	'NR_CHECKOUT',
		nr_seq_cobranca			bigint	path	'NR_COLLECTION',
		nr_seq_deposito_ident		bigint	path	'NR_IDENTIFIED_DEPOSIT',
		nr_seq_motivo_desc		bigint	path	'NR_DISCOUNT_REASON',
		nr_seq_reembolso		bigint	path	'NR_REIMBURSEMENT',
		nr_tit_pagar			bigint	path	'NR_PAYABLE_DOCUMENT',
		nr_titulo			bigint	path	'NR_RECEIVABLE_DOCUMENT',
		vl_cotacao			varchar(20)	path	'VL_EXCHANGE_RATE',
		vl_descontos			varchar(20)	path	'VL_DICOUNTS',
		vl_despesa_bancaria		varchar(20)	path	'VL_SERVICE_CHARGES',
		vl_glosa			varchar(20)	path	'VL_DENIAL',
		vl_juros			varchar(20)	path	'VL_FINE_INTEREST',			
		vl_multa			varchar(20)	path	'VL_PENALTY_FEE',
		vl_nota_credito			varchar(20)	path	'VL_CREDIT_MEMO',
		vl_outros_acrescimos		varchar(20)	path	'VL_ADDITIONAL',
		vl_perdas			varchar(20)	path	'VL_LOSS',
		vl_recebido			varchar(20)	path	'VL_RECEIVED',
		xml_titulo_rec_liq_cc		xml		path	'ACCOUNT_REC_SETTLEMENT_CCS');
c01_w	c01%rowtype;

c02 CURSOR FOR
SELECT	*
from	xmltable('/ACCOUNT_REC_SETTLEMENT_CCS/ACCOUNT_REC_SETTLEMENT_CC' passing c01_w.xml_titulo_rec_liq_cc columns
		cd_centro_custo			bigint	path	'CD_COST_CENTER',
		cd_conta_contabil		varchar(20)	path	'CD_GL_ACCOUNT',
		cd_estab_centro_custo		smallint	path	'CD_COST_CENTER_ESTABLISHMENT',
		cd_moeda			integer	path	'CD_CURRENCY',
		cd_pessoa_fisica		varchar(10)	path	'CD_NATURAL_PERSON',
		dt_atualizacao			varchar(14)	path	'DT_UPDATE',
		nm_usuario			varchar(15)	path	'NM_USER',
		nr_titulo			bigint	path	'NR_RECEIVABLE_ACCOUNT',
		vl_baixa			varchar(20)	path	'VL_SETTLEMENT',
		vl_cotacao			varchar(20)	path	'VL_EXCHANGE_RATE',
		vl_desconto			varchar(20)	path	'VL_DISCOUNT',
		vl_juros			varchar(20)	path	'VL_FINE_INTEREST',
		vl_multa			varchar(20)	path	'VL_PENALTY_FEE',
		vl_perdas			varchar(20)	path	'VL_LOSS',
		vl_recebido			varchar(20)	path	'VL_RECEIVED');
c02_w	c02%rowtype;		
	
					
BEGIN

/*'Atualiza o status da fila para Em processamento'*/

update	intpd_fila_transmissao
set		ie_status 		= 'R'
where	nr_sequencia 	= nr_sequencia_p;

/*'Realiza o commit para não permite o status de processamento em casa de rollback por existir consistência. Existe tratamento de exceção abaixo para colocar o status de erro em caso de falha'*/

commit;

begin

select	coalesce(max(b.ie_conversao),'I'),
	max(nr_seq_sistema),
	max(nr_seq_projeto_xml),
	max(nr_seq_regra_conv)
into STRICT	ie_conversao_w,
	nr_seq_sistema_w,
	nr_seq_projeto_xml_w,
	nr_seq_regra_w
from	intpd_fila_transmissao a,
	intpd_eventos_sistema b
where	a.nr_seq_evento_sistema = b.nr_sequencia
and	a.nr_sequencia 		= nr_sequencia_p;

ie_sistema_externo_w	:=	nr_seq_sistema_w;

/*'Alimenta as informações iniciais de controle e consistência de cada atributo do XML'*/

reg_integracao_w.nr_seq_fila_transmissao	:=	nr_sequencia_p;
reg_integracao_w.ie_envio_recebe		:=	'R';
reg_integracao_w.ie_sistema_externo		:=	ie_sistema_externo_w;
reg_integracao_w.ie_conversao			:=	ie_conversao_w;
reg_integracao_w.nr_seq_projeto_xml		:=	nr_seq_projeto_xml_w;
reg_integracao_w.nr_seq_regra_conversao		:=	nr_seq_regra_w;
reg_integracao_w.intpd_log_receb.delete;
reg_integracao_w.qt_reg_log			:=	0;

open C01;
loop
fetch C01 into	
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	reg_integracao_w.nm_tabela		:=	'TITULO_RECEBER_LIQ';
	reg_integracao_w.nm_elemento		:=	'ACCOUNT_RECEIVABLE_SETTLEMENT';
	reg_integracao_w.nr_seq_visao		:=	'';
	
	/*Tentar achar o título no Tasy para inserir a baixa.*/

	select 	max(a.nr_titulo)
	into STRICT	titulo_receber_liq_w.nr_titulo
	from	titulo_receber a
	where	a.nr_titulo = trim(both c01_w.nr_titulo);	
	
	if (coalesce(titulo_receber_liq_w.nr_titulo::text, '') = '') then
		select 	max(a.nr_titulo)
		into STRICT	titulo_receber_liq_w.nr_titulo
		from	titulo_receber a
		where	trim(both a.nr_titulo_externo) = trim(both c01_w.nr_titulo);
	end if;
	
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_AGENCIA_BANCARIA', c01_w.cd_agencia_bancaria, 'N', titulo_receber_liq_w.cd_agencia_bancaria) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.cd_agencia_bancaria := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_BANCO', c01_w.cd_banco, 'N', titulo_receber_liq_w.cd_banco) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.cd_banco := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CENTRO_CUSTO', c01_w.cd_centro_custo, 'S', titulo_receber_liq_w.cd_centro_custo) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.cd_centro_custo := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CENTRO_CUSTO_DESC', c01_w.cd_centro_custo_desc, 'S', titulo_receber_liq_w.cd_centro_custo_desc) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.cd_centro_custo_desc := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CGC_EMP_CRED', c01_w.cd_cgc_emp_cred, 'N', titulo_receber_liq_w.cd_cgc_emp_cred) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.cd_cgc_emp_cred := _ora2pg_r.ds_valor_retorno_p;	
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_MOEDA', c01_w.cd_moeda, 'S', titulo_receber_liq_w.cd_moeda) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.cd_moeda := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_TIPO_RECEBIMENTO', c01_w.cd_tipo_recebimento, 'S', titulo_receber_liq_w.cd_tipo_recebimento) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.cd_tipo_recebimento := _ora2pg_r.ds_valor_retorno_p;	
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DS_OBSERVACAO', c01_w.ds_observacao, 'N', titulo_receber_liq_w.ds_observacao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.ds_observacao := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_AUTENTICACAO', c01_w.dt_autenticacao, 'N', titulo_receber_liq_w.dt_autenticacao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.dt_autenticacao := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_CREDITO_BANCO', c01_w.dt_credito_banco, 'N', titulo_receber_liq_w.dt_credito_banco) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.dt_credito_banco := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_INTEGRACAO_EXTERNA', c01_w.dt_integracao_externa, 'N', titulo_receber_liq_w.dt_integracao_externa) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.dt_integracao_externa := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_REAL_RECEBIMENTO', c01_w.dt_real_recebimento, 'N', titulo_receber_liq_w.dt_real_recebimento) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.dt_real_recebimento := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_RECEBIMENTO', c01_w.dt_recebimento, 'N', titulo_receber_liq_w.dt_recebimento) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.dt_recebimento := _ora2pg_r.ds_valor_retorno_p;	
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_ORIGEM_BAIXA', c01_w.ie_origem_baixa, 'S', titulo_receber_liq_w.ie_origem_baixa) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.ie_origem_baixa := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'IE_TIPO_PERDA', c01_w.ie_tipo_perda, 'S', titulo_receber_liq_w.ie_tipo_perda) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.ie_tipo_perda := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NM_USUARIO', c01_w.nm_usuario, 'N', titulo_receber_liq_w.nm_usuario) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.nm_usuario := _ora2pg_r.ds_valor_retorno_p;	
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_ADIANTAMENTO', c01_w.nr_adiantamento, 'S', titulo_receber_liq_w.nr_adiantamento) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.nr_adiantamento := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_BORDERO', c01_w.nr_bordero, 'S', titulo_receber_liq_w.nr_bordero) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.nr_bordero := _ora2pg_r.ds_valor_retorno_p;	
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_CARTAO_CRED', c01_w.nr_cartao_cred, 'N', titulo_receber_liq_w.nr_cartao_cred) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.nr_cartao_cred := _ora2pg_r.ds_valor_retorno_p;	
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_DOCUMENTO', c01_w.nr_documento, 'N', titulo_receber_liq_w.nr_documento) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.nr_documento := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_LOTE_CONTABIL', c01_w.nr_lote_contabil, 'S', titulo_receber_liq_w.nr_lote_contabil) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.nr_lote_contabil := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_NOTA_FISCAL_DEVOL', c01_w.nr_nota_fiscal_devol, 'S', titulo_receber_liq_w.nr_nota_fiscal_devol) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.nr_nota_fiscal_devol := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_REPASSE_TERCEIRO', c01_w.nr_repasse_terceiro, 'S', titulo_receber_liq_w.nr_repasse_terceiro) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.nr_repasse_terceiro := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_CAIXA_REC', c01_w.nr_seq_caixa_rec, 'S', titulo_receber_liq_w.nr_seq_caixa_rec) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.nr_seq_caixa_rec := _ora2pg_r.ds_valor_retorno_p;	
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_COBRANCA', c01_w.nr_seq_cobranca, 'S', titulo_receber_liq_w.nr_seq_cobranca) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.nr_seq_cobranca := _ora2pg_r.ds_valor_retorno_p;	
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_DEPOSITO_IDENT', c01_w.nr_seq_deposito_ident, 'S', titulo_receber_liq_w.nr_seq_deposito_ident) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.nr_seq_deposito_ident := _ora2pg_r.ds_valor_retorno_p;	
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_MOTIVO_DESC', c01_w.nr_seq_motivo_desc, 'S', titulo_receber_liq_w.nr_seq_motivo_desc) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.nr_seq_motivo_desc := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_SEQ_REEMBOLSO', c01_w.nr_seq_reembolso, 'S', titulo_receber_liq_w.nr_seq_reembolso) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.nr_seq_reembolso := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NR_TIT_PAGAR', c01_w.nr_tit_pagar, 'S', titulo_receber_liq_w.nr_tit_pagar) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.nr_tit_pagar := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_COTACAO', c01_w.vl_cotacao, 'N', titulo_receber_liq_w.vl_cotacao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.vl_cotacao := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_DESCONTOS', c01_w.vl_descontos, 'N', titulo_receber_liq_w.vl_descontos) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.vl_descontos := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_DESPESA_BANCARIA', c01_w.vl_despesa_bancaria, 'N', titulo_receber_liq_w.vl_despesa_bancaria) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.vl_despesa_bancaria := _ora2pg_r.ds_valor_retorno_p;	
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_GLOSA', c01_w.vl_glosa, 'N', titulo_receber_liq_w.vl_glosa) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.vl_glosa := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_JUROS', c01_w.vl_juros, 'N', titulo_receber_liq_w.vl_juros) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.vl_juros := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_MULTA', c01_w.vl_multa, 'N', titulo_receber_liq_w.vl_multa) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.vl_multa := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_NOTA_CREDITO', c01_w.vl_nota_credito, 'N', titulo_receber_liq_w.vl_nota_credito) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.vl_nota_credito := _ora2pg_r.ds_valor_retorno_p;	
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_OUTROS_ACRESCIMOS', c01_w.vl_outros_acrescimos, 'N', titulo_receber_liq_w.vl_outros_acrescimos) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.vl_outros_acrescimos := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_PERDAS', c01_w.vl_perdas, 'N', titulo_receber_liq_w.vl_perdas) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.vl_perdas := _ora2pg_r.ds_valor_retorno_p;
	SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_RECEBIDO', c01_w.vl_recebido, 'N', titulo_receber_liq_w.vl_recebido) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_receber_liq_w.vl_recebido := _ora2pg_r.ds_valor_retorno_p;	
	
	if (reg_integracao_w.qt_reg_log = 0) then
	
		select	coalesce(max(nr_sequencia),0) + 1
		into STRICT	titulo_receber_liq_w.nr_sequencia
		from	titulo_receber_liq
		where	nr_titulo	= titulo_receber_liq_w.nr_titulo;
		
		titulo_receber_liq_w.ie_acao := 'I'; -- Ação sempre será inclusão, mesmo nos estornos...
		titulo_receber_liq_w.ie_lib_caixa := 'S';
		
		if (coalesce(titulo_receber_liq_w.nm_usuario::text, '') = '') then
			titulo_receber_liq_w.nm_usuario := 'TASY';
		end if;
		
		if (coalesce(titulo_receber_liq_w.dt_atualizacao::text, '') = '') then
			titulo_receber_liq_w.dt_atualizacao := clock_timestamp();
		end if;
		
		if (coalesce(titulo_receber_liq_w.vl_descontos::text, '') = '') then
			titulo_receber_liq_w.vl_descontos := 0;
		end if;
		
		if (coalesce(titulo_receber_liq_w.vl_glosa::text, '') = '') then
			titulo_receber_liq_w.vl_glosa := 0;
		end if;	

		if (coalesce(titulo_receber_liq_w.vl_juros::text, '') = '') then
			titulo_receber_liq_w.vl_juros := 0;
		end if;	

		if (coalesce(titulo_receber_liq_w.vl_multa::text, '') = '') then
			titulo_receber_liq_w.vl_multa := 0;
		end if;	

		if (coalesce(titulo_receber_liq_w.vl_rec_maior::text, '') = '') then
			titulo_receber_liq_w.vl_rec_maior := 0;
		end if;			
		
		insert into titulo_receber_liq values (titulo_receber_liq_w.*);
		
		CALL atualizar_saldo_tit_rec(titulo_receber_liq_w.nr_titulo, titulo_receber_liq_w.nm_usuario);
	
	end if;

	open C02;
	loop
	fetch C02 into	
		c02_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		reg_integracao_w.nm_tabela		:=	'TITULO_REC_LIQ_CC';
		reg_integracao_w.nm_elemento	:=	'ACCOUNT_REC_SETTLEMENT_CC';
		reg_integracao_w.nr_seq_visao	:=	'';
		
		titulo_rec_liq_cc_w.nr_titulo := titulo_receber_liq_w.nr_titulo;
		titulo_rec_liq_cc_w.nr_seq_baixa := titulo_receber_liq_w.nr_sequencia;
		
		
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CENTRO_CUSTO', c02_w.cd_centro_custo, 'S', titulo_rec_liq_cc_w.cd_centro_custo) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_rec_liq_cc_w.cd_centro_custo := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_CONTA_CONTABIL', c02_w.cd_conta_contabil, 'S', titulo_rec_liq_cc_w.cd_conta_contabil) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_rec_liq_cc_w.cd_conta_contabil := _ora2pg_r.ds_valor_retorno_p;	
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_ESTAB_CENTRO_CUSTO', c02_w.cd_estab_centro_custo, 'S', titulo_rec_liq_cc_w.cd_estab_centro_custo) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_rec_liq_cc_w.cd_estab_centro_custo := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_MOEDA', c02_w.cd_moeda, 'S', titulo_rec_liq_cc_w.cd_moeda) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_rec_liq_cc_w.cd_moeda := _ora2pg_r.ds_valor_retorno_p;	
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'CD_PESSOA_FISICA', c02_w.cd_pessoa_fisica, 'S', titulo_rec_liq_cc_w.cd_pessoa_fisica) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_rec_liq_cc_w.cd_pessoa_fisica := _ora2pg_r.ds_valor_retorno_p;	
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'DT_ATUALIZACAO', c02_w.dt_atualizacao, 'N', titulo_rec_liq_cc_w.dt_atualizacao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_rec_liq_cc_w.dt_atualizacao := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'NM_USUARIO', c02_w.nm_usuario, 'N', titulo_rec_liq_cc_w.nm_usuario) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_rec_liq_cc_w.nm_usuario := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_BAIXA', c02_w.vl_baixa, 'N', titulo_rec_liq_cc_w.vl_baixa) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_rec_liq_cc_w.vl_baixa := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_COTACAO', c02_w.vl_cotacao, 'N', titulo_rec_liq_cc_w.vl_cotacao) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_rec_liq_cc_w.vl_cotacao := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_DESCONTO', c02_w.vl_desconto, 'N', titulo_rec_liq_cc_w.vl_desconto) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_rec_liq_cc_w.vl_desconto := _ora2pg_r.ds_valor_retorno_p;	
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_JUROS', c02_w.vl_juros, 'N', titulo_rec_liq_cc_w.vl_juros) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_rec_liq_cc_w.vl_juros := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_MULTA', c02_w.vl_multa, 'N', titulo_rec_liq_cc_w.vl_multa) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_rec_liq_cc_w.vl_multa := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_PERDAS', c02_w.vl_perdas, 'N', titulo_rec_liq_cc_w.vl_perdas) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_rec_liq_cc_w.vl_perdas := _ora2pg_r.ds_valor_retorno_p;
		SELECT * FROM intpd_processar_atributo(reg_integracao_w, 'VL_RECEBIDO', c02_w.vl_recebido, 'N', titulo_rec_liq_cc_w.vl_recebido) INTO STRICT _ora2pg_r;
 reg_integracao_w := _ora2pg_r.reg_integracao_p; titulo_rec_liq_cc_w.vl_recebido := _ora2pg_r.ds_valor_retorno_p;		
		
		if (coalesce(titulo_rec_liq_cc_w.dt_atualizacao::text, '') = '') then
			titulo_rec_liq_cc_w.dt_atualizacao := clock_timestamp();
		end if;
		
		if (coalesce(titulo_rec_liq_cc_w.nm_usuario::text, '') = '') then
			titulo_rec_liq_cc_w.nm_usuario := 'TASY';
		end if;
		
		titulo_rec_liq_cc_w.vl_amaior := 0;
		
		if (reg_integracao_w.qt_reg_log = 0) then
		
			select	nextval('titulo_rec_liq_cc_seq')
			into STRICT	titulo_rec_liq_cc_w.nr_sequencia
			;
			
			insert into titulo_rec_liq_cc values (titulo_rec_liq_cc_w.*);
	
		end if;
			
		end;
	end loop;
	close C02;

	end;
end loop;
close C01;
exception
when others then
	begin
	/*'Em caso de qualquer falha o sistema captura a mensagem de erro, efetua o rollback, atualiza o status para Erro e registra a falha ocorrida'*/

	ds_erro_w	:=	substr(sqlerrm,1,4000);
	rollback;
	update	intpd_fila_transmissao
	set		ie_status 		= 'E',
			ds_log 			= ds_erro_w
	where	nr_sequencia 	= nr_sequencia_p;

	end;
end;

if (reg_integracao_w.qt_reg_log > 0) or (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
	begin
	/*'Em caso de qualquer consistência o sistema efetua rollback, atualiza o status para Erro e registra todos os logs de consistência'*/

	rollback;
	
	update	intpd_fila_transmissao
	set		ie_status 		= 'E',
			ds_log 			= ds_erro_w
	where	nr_sequencia 	= nr_sequencia_p;
	
	for i in 0..reg_integracao_w.qt_reg_log-1 loop
		intpd_gravar_log_recebimento(nr_sequencia_p,reg_integracao_w.intpd_log_receb[i].ds_log,'INTPDTASY');
	end loop;
	end;
else
	update	intpd_fila_transmissao
	set	ie_status = 'S',
		nr_seq_documento = titulo_receber_liq_w.nr_titulo,
		nr_seq_item_documento = titulo_receber_liq_w.nr_sequencia
	where	nr_sequencia = nr_sequencia_p;
end if;	

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE intpd_recebe_titulo_rec_liq ( nr_sequencia_p bigint, xml_p xml) FROM PUBLIC;

