-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE altera_conv_autor_oncologia (nr_seq_autorizacao_p bigint, cd_convenio_destino_p bigint, cd_categoria_destino_p text, cd_plano_p text, cd_usuario_conv_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_paciente_setor_w		bigint;
nr_seq_autorizacao_w		bigint;

c01 CURSOR FOR
	SELECT	a.nr_sequencia
	from	autorizacao_convenio a
	where	a.nr_seq_paciente_setor = nr_seq_paciente_setor_w
	and	a.nr_seq_estagio in (	SELECT	b.nr_sequencia
					from	estagio_autorizacao b
					where	b.ie_interno = 1
					and	b.ie_situacao = 'A'
					and	OBTER_EMPRESA_ESTAB(wheb_usuario_pck.get_cd_estabelecimento) = b.cd_empresa);


BEGIN

begin
select	coalesce(max(nr_seq_paciente_setor),0)
into STRICT	nr_seq_paciente_setor_w
from	autorizacao_convenio
where 	nr_sequencia = nr_seq_autorizacao_p;
exception
when others then
	nr_seq_paciente_setor_w := 0;
end;

if (nr_seq_paciente_setor_w > 0) then
	begin

	open c01;
	loop
	fetch c01 into
		nr_seq_autorizacao_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		begin
		update	autorizacao_convenio
		set	cd_convenio 	= cd_convenio_destino_p,
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp()
		where	nr_sequencia 	= nr_seq_autorizacao_w;
		exception
		when others then
			--r.aise_application_error(-20011,'Ocorreu um problema ao alterar o convênio da autorização.'||'#@#@');
			CALL wheb_mensagem_pck.exibir_mensagem_abort(263278);
		end;

		end;
	end loop;
	close c01;

	begin
	update	paciente_setor_convenio
	set	cd_convenio		= cd_convenio_destino_p,
		cd_categoria		= cd_categoria_destino_p,
		cd_plano			= coalesce(cd_plano_p,cd_plano),
		cd_usuario_convenio	= coalesce(cd_usuario_conv_p,cd_usuario_convenio),
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp()
	where	nr_seq_paciente		= nr_seq_paciente_setor_w;
	exception
	when others then
		--r.aise_application_error(-20011,'Ocorreu um problema ao alterar o convênio do tratamento oncológico.'||'#@#@');
		CALL wheb_mensagem_pck.exibir_mensagem_abort(263279);
	end;

	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE altera_conv_autor_oncologia (nr_seq_autorizacao_p bigint, cd_convenio_destino_p bigint, cd_categoria_destino_p text, cd_plano_p text, cd_usuario_conv_p text, nm_usuario_p text) FROM PUBLIC;

