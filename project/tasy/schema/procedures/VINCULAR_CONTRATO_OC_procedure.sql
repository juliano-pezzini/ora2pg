-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vincular_contrato_oc ( nr_ordem_compra_p bigint, cd_contrato_p bigint) AS $body$
DECLARE


nr_item_oci_w			integer;
cd_material_w			ordem_compra_item.cd_material%type;
nr_item_nf_w			integer;
nr_seq_nf_w			bigint;
qt_existe_ordem_w		bigint;
cd_cgc_contratado_w		varchar(14);
cd_pessoa_contratada_w		varchar(10);
qt_consiste_fornec_w		bigint;
qt_consiste_pf_w		bigint;
qt_material_fixa_w		contrato_regra_nf.qt_material_fixa%type;
qt_material_oc_w		ordem_compra_item.qt_material%type;
qt_material_usado_w		bigint;
ie_consistir_quantidade_w 	varchar(1);
dt_liberacao_oc_w 		ordem_compra.dt_liberacao%type;
nr_seq_regra_contrato_oci_w 	ordem_compra_item.nr_seq_regra_contrato%type;
ds_material_w			material.ds_material%type;
cd_estab_ativo_w		estabelecimento.cd_estabelecimento%type := obter_estabelecimento_ativo;

c01 CURSOR FOR
SELECT	b.nr_item_oci,
	b.cd_material,
	b.nr_seq_regra_contrato,
	a.dt_liberacao,
	c.ds_material
from	ordem_compra a,
	ordem_compra_item b,
	material c
where	a.nr_ordem_compra 	= b.nr_ordem_compra
and 	b.cd_material 		= c.cd_material
and	a.nr_ordem_compra 	= nr_ordem_compra_p;

c02 CURSOR FOR
SELECT	nr_item_nf,
	nr_sequencia
from	nota_fiscal_item
where	nr_ordem_compra = nr_ordem_compra_p
and	nr_item_oci = nr_item_oci_w;


BEGIN

select  count(1)
into STRICT	qt_existe_ordem_w
from	ordem_compra
where 	nr_ordem_compra = nr_ordem_compra_p;

if (coalesce(qt_existe_ordem_w,0) = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(245359);  --O numero da ordem compra nao existe
end if;	

select	cd_cgc_contratado,
	cd_pessoa_contratada
into STRICT	cd_cgc_contratado_w,
	cd_pessoa_contratada_w	   	
from	contrato 
where	nr_sequencia = cd_contrato_p;

if (cd_cgc_contratado_w IS NOT NULL AND cd_cgc_contratado_w::text <> '') then
	select	count(1)
	into STRICT	qt_consiste_fornec_w
	from	ordem_compra
	where	cd_cgc_contratado_w <> coalesce(cd_cgc_fornecedor,0)
	and	nr_ordem_compra = nr_ordem_compra_p;
end if;

if (cd_pessoa_contratada_w IS NOT NULL AND cd_pessoa_contratada_w::text <> '') then
	select	count(1)
	into STRICT	qt_consiste_pf_w
	from	ordem_compra
	where	cd_pessoa_contratada_w <> coalesce(cd_pessoa_fisica,0)
	and	nr_ordem_compra = nr_ordem_compra_p;
end if;	

if (coalesce(qt_consiste_fornec_w,0) > 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(245387);
elsif (coalesce(qt_consiste_pf_w,0) > 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(245384);	
end if;	

open c01;
loop
fetch c01 into
	nr_item_oci_w,
	cd_material_w,
	nr_seq_regra_contrato_oci_w,
	dt_liberacao_oc_w,
	ds_material_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
	begin
		select	coalesce(max(a.qt_material_fixa),0)
		into STRICT	qt_material_fixa_w
		from 	contrato_regra_nf a
		where	a.cd_material 			= cd_material_w
		and 	a.nr_seq_contrato 		= cd_contrato_p
		and     a.nr_sequencia    		= coalesce(nr_seq_regra_contrato_oci_w, nr_sequencia)
		and 	((coalesce(a.cd_estab_regra, cd_estab_ativo_w) = cd_estab_ativo_w) or (exists (	SELECT	1
													from	contrato_regra_nf_estab x
													where	x.cd_estab_regra = cd_estab_ativo_w
													and	x.nr_seq_regra_nf = a.nr_sequencia)))
		and 	trunc(clock_timestamp()) 			>= coalesce(a.dt_inicio_vigencia, trunc(clock_timestamp()))
		and 	trunc(clock_timestamp()) 			<= coalesce(a.dt_fim_vigencia, trunc(clock_timestamp()))
        and (coalesce(a.ie_situacao::text, '') = '' or a.ie_situacao = 'A');
	exception
		when others then
			qt_material_fixa_w := 0;
	end;
	
	ie_consistir_quantidade_w := obter_param_usuario(917, 233, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario(), obter_estabelecimento_ativo, ie_consistir_quantidade_w);

	if (ie_consistir_quantidade_w = 'S' and
	    (dt_liberacao_oc_w IS NOT NULL AND dt_liberacao_oc_w::text <> '') and
	    qt_material_fixa_w > 0) then

		begin
			select	coalesce(sum(oci.qt_material), 0)
			into STRICT	qt_material_usado_w
			from 	ordem_compra oc,
				ordem_compra_item oci
			where	oc.nr_ordem_compra 	= oci.nr_ordem_compra
			and 	oc.ie_situacao 		= 'A'
			and 	(oc.dt_liberacao IS NOT NULL AND oc.dt_liberacao::text <> '')
			and 	oci.cd_material 	= cd_material_w
			and 	oci.nr_contrato 	= cd_contrato_p
			and 	oc.nr_ordem_compra 	<> nr_ordem_compra_p;
		exception
			when others then
				qt_material_usado_w := 0;
		end;
		
		select 	coalesce(sum(qt_material), 0)
		into STRICT 	qt_material_oc_w
		from 	ordem_compra_item oci,
			ordem_compra oc
		where 	oc.nr_ordem_compra 	= oci.nr_ordem_compra
		and 	oci.nr_ordem_compra 	= nr_ordem_compra_p
		and 	cd_material 		= cd_material_w;
		
		qt_material_usado_w := qt_material_usado_w + qt_material_oc_w;
		
		if (qt_material_usado_w > qt_material_fixa_w) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(445243, 'DS_MATERIAL_W='|| ds_material_w);
		end if;

	end if;
	
	CALL vincular_contrato_item_oc(cd_contrato_p, nr_ordem_compra_p, nr_item_oci_w);
	open c02;
	loop
	fetch c02 into
		nr_item_nf_w,
		nr_seq_nf_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		update	nota_fiscal_item
		set	nr_contrato = cd_contrato_p
		where	nr_sequencia = nr_seq_nf_w
		and	nr_item_nf = nr_item_nf_w;
		end;
	end loop;
	close c02;
	
	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vincular_contrato_oc ( nr_ordem_compra_p bigint, cd_contrato_p bigint) FROM PUBLIC;

