-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE transmitir_manifesto_pre_nota (nr_seq_pre_nota_fiscal_p pre_nota_fiscal.nr_sequencia%type, ie_evento_p text, ds_justificativa_p text, nm_usuario_p text, ds_retorno_p INOUT text) AS $body$
DECLARE


ds_retorno_integracao_w 	text;
ds_erros_w                varchar(1000);
nr_seq_nota_fiscal_w      pre_nota_fiscal.nr_sequencia%type;


BEGIN

select max(a.nr_sequencia)
into STRICT nr_seq_nota_fiscal_w
from pre_nota_fiscal a
where a.nr_sequencia = nr_seq_pre_nota_fiscal_p;

if (coalesce(nr_seq_nota_fiscal_w::text, '') = '') then
   ds_erros_w := ds_erros_w || obter_desc_expressao(1081663) || ' (' || nr_seq_pre_nota_fiscal_p || ')' || chr(13) || chr(10);
end if;

if (ie_evento_p not in ('CO','CE','DO','NR')) then
   ds_erros_w := ds_erros_w || obter_desc_expressao(1081665) || chr(13) || chr(10);
end if;

if (coalesce(ds_erros_w::text, '') = '') then
   ds_retorno_integracao_w := bifrost.send_integration(nm_event => 'pre.invoice.manifest',
                                                       nm_javaclass => 'com.philips.tasy.integration.invoice.callback.PreInvoiceManifestCallback',
                                                       ds_arguments => '{"id": '||nr_seq_pre_nota_fiscal_p||', "eventType": "'||ie_evento_p||'", "justification": "'||ds_justificativa_p||'"}',
                                                       nm_user => nm_usuario_p);
   ds_retorno_p := ds_retorno_integracao_w;
else
   ds_retorno_p := ds_erros_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE transmitir_manifesto_pre_nota (nr_seq_pre_nota_fiscal_p pre_nota_fiscal.nr_sequencia%type, ie_evento_p text, ds_justificativa_p text, nm_usuario_p text, ds_retorno_p INOUT text) FROM PUBLIC;

