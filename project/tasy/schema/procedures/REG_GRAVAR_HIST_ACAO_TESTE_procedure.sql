-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reg_gravar_hist_acao_teste ( nr_seq_caso_teste_p bigint, nm_usuario_p text, ie_acoes_teste_alt_p INOUT text ) AS $body$
DECLARE


ie_at_lancado_w		varchar(1);
ie_tipo_alteracao_w	varchar(1);
ds_passo_w		reg_acao_teste.ds_passo%type;
ds_resultado_w		reg_acao_teste.ds_resultado%type;
ie_situacao_w		reg_acao_teste.ie_situacao%type;

c_acao_teste CURSOR FOR
SELECT	nr_sequencia,
	nr_ordenacao,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	ds_passo,
	ds_resultado,
	nr_seq_caso_teste,
	cd_versao,
	ds_funcionalidade,
	ie_situacao,
	dt_inativacao,
	nm_usuario_inativacao,
	ds_result_pass,
	ds_result_fail
from	reg_acao_teste
where	nr_seq_caso_teste = nr_seq_caso_teste_p;

BEGIN

for r_c_acao_teste in c_acao_teste loop

	ie_tipo_alteracao_w := null;
	ie_at_lancado_w := null;

	select	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
	into STRICT	ie_at_lancado_w -- Determinar se a acao de teste ja foi liberada em alguma revisao do documento de acoes dos casos de teste
	from	reg_acao_teste_hist
	where	nr_seq_acao_teste = r_c_acao_teste.nr_sequencia
	and	ie_tipo_alteracao = 'I'
	and	(nr_seq_reg_version_rev IS NOT NULL AND nr_seq_reg_version_rev::text <> '');

	delete	FROM reg_acao_teste_hist
	where	nr_seq_acao_teste = r_c_acao_teste.nr_sequencia
	and	coalesce(nr_seq_reg_version_rev::text, '') = '';

	if (ie_at_lancado_w = 'S') then

		select	ds_passo,
			ds_resultado,
			ie_situacao
		into STRICT	ds_passo_w,
			ds_resultado_w,
			ie_situacao_w
		from	reg_acao_teste_hist
		where	nr_sequencia = (	SELECT	max(nr_sequencia)
						from	reg_acao_teste_hist
						where	nr_seq_acao_teste = r_c_acao_teste.nr_sequencia
						and	(nr_seq_reg_version_rev IS NOT NULL AND nr_seq_reg_version_rev::text <> '')
					);

		if (coalesce(ie_situacao_w, 'A') = 'A') and (r_c_acao_teste.ie_situacao = 'I') then
			ie_tipo_alteracao_w := 'E';
		elsif (r_c_acao_teste.ds_passo <> ds_passo_w) or (r_c_acao_teste.ds_resultado <> ds_resultado_w) then
			ie_tipo_alteracao_w := 'A';
		end if;
	else
		if (coalesce(r_c_acao_teste.ie_situacao, 'A') = 'A') then
			ie_tipo_alteracao_w := 'I';
		end if;
	end if;

	if (ie_tipo_alteracao_w IS NOT NULL AND ie_tipo_alteracao_w::text <> '') then

		ie_acoes_teste_alt_p := 'S';

		insert into reg_acao_teste_hist(
			nr_sequencia,
			nr_ordenacao,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_passo,
			ds_resultado,
			nr_seq_caso_teste,
			cd_versao,
			nr_seq_reg_version_rev,
			ds_funcionalidade,
			nr_seq_acao_teste,
			ie_situacao,
			dt_inativacao,
			nm_usuario_inativacao,
			ie_tipo_alteracao,
			dt_inclusao_hist,
			ds_result_pass,
			ds_result_fail)
		values (
			nextval('reg_acao_teste_hist_seq'),
			r_c_acao_teste.nr_ordenacao,
			r_c_acao_teste.dt_atualizacao,
			r_c_acao_teste.nm_usuario,
			r_c_acao_teste.dt_atualizacao_nrec,
			r_c_acao_teste.nm_usuario_nrec,
			r_c_acao_teste.ds_passo,
			r_c_acao_teste.ds_resultado,
			r_c_acao_teste.nr_seq_caso_teste,
			r_c_acao_teste.cd_versao,
			null,
			r_c_acao_teste.ds_funcionalidade,
			r_c_acao_teste.nr_sequencia,
			coalesce(r_c_acao_teste.ie_situacao, 'A'),
			r_c_acao_teste.dt_inativacao,
			r_c_acao_teste.nm_usuario_inativacao,
			ie_tipo_alteracao_w,
			clock_timestamp(),
			r_c_acao_teste.ds_result_pass,
			r_c_acao_teste.ds_result_fail);
	end if;
end loop;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reg_gravar_hist_acao_teste ( nr_seq_caso_teste_p bigint, nm_usuario_p text, ie_acoes_teste_alt_p INOUT text ) FROM PUBLIC;

