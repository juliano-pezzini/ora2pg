-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_saldo_caixa_depos ( nr_seq_caixa_p bigint, ie_forma_consiste_p text, dt_movimento_p timestamp, nm_usuario_p text, ds_retorno_p INOUT text) AS $body$
DECLARE


nr_seq_saldo_caixa_w	bigint;
ds_retorno_w		varchar(255);
nr_seq_lote_w		bigint;
cont_w			bigint;
ds_caixa_w		varchar(50);
dt_fechamento_w	caixa_saldo_diario.dt_fechamento%type;
nr_sequencia_w	caixa_saldo_diario.nr_sequencia%type;


BEGIN

if (nr_seq_caixa_p IS NOT NULL AND nr_seq_caixa_p::text <> '') then

	select	max(nr_sequencia) --buscar seq saldo caixa (mesma consistencia que faz na rotina GERAR_DEPOSITO_CAIXA)
	into STRICT	nr_seq_saldo_caixa_w
	from	caixa_saldo_diario
	where	nr_seq_caixa	= nr_seq_caixa_p
	and	coalesce(dt_fechamento::text, '') = '';

	select  substr(ds_caixa,1,50)
	into STRICT	ds_caixa_w
	from    caixa
	where	nr_sequencia =  nr_seq_caixa_p;

end if;

if (coalesce(nr_seq_saldo_caixa_w::text, '') = '') then --se não encontrar caixa com saldo aberto
	--ds_retorno_w := substr('O caixa '|| ds_caixa_w ||' não possui saldo diário aberto.',1,254);
	ds_retorno_w := substr(wheb_mensagem_pck.get_texto(304650,'DS_CAIXA_W='||ds_caixa_w),1,254);

else

	if (ie_forma_consiste_p = 'S') then /*Se tiver S consiste como fazia antes, quando o parametro era boolean, somente consiste se tiver lote em aberto*/
		select	count(*) --se entrar saldo aberto, verificar se possui lotes abertos.
		into STRICT    cont_w
		from	movto_trans_financ
		where	nr_seq_caixa		=  	nr_seq_caixa_p
		and		(nr_seq_lote IS NOT NULL AND nr_seq_lote::text <> '')
		and     coalesce(dt_fechamento_lote::text, '') = ''
		and		nr_seq_saldo_caixa	=	nr_seq_saldo_caixa_w; /*tem que ser um lote do saldo de caixa indetificado acima.*/
		if (cont_w > 0) then
			--ds_retorno_w := substr('O caixa '|| ds_caixa_w ||' possui um lote aberto, não será possível realizar a movimentação.',1,254);
			ds_retorno_w := substr(wheb_mensagem_pck.get_texto(304651,'DS_CAIXA_W='||ds_caixa_w),1,254);
		end if;

	elsif (ie_forma_consiste_p = 'D') then /*Aqui consiste a nova opcao do parametro, se for D, verifica se tem um saldo aberto com mesma data da movimentacao.*/
		/*Verificar se o saldo da data do movimento está aberto ou fechado*/

		select	max(nr_sequencia),
				max(dt_fechamento)
		into STRICT	nr_sequencia_w,
				dt_fechamento_w
		from 	caixa_saldo_diario
		where  	dt_saldo   		= to_date(dt_movimento_p)
		and  	nr_seq_caixa  	= nr_seq_caixa_p;

		if (coalesce(nr_sequencia_w::text, '') = '') then /*Se não achar a sequencia, significa que não tem saldo para esse dia*/
			ds_retorno_w := substr(wheb_mensagem_pck.get_texto(445895,'DS_CAIXA_W='||ds_caixa_w||';DT_MOVIMENTO_P='||DT_MOVIMENTO_P),1,254);
							/*O caixa #@DS_CAIXA_W#@ não possui saldo diário para essa a data: #@DT_MOVIMENTO_P#@*/

		elsif (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') and (dt_fechamento_w IS NOT NULL AND dt_fechamento_w::text <> '') then /*Se achar a sequencia do saldo mas estiver fechado*/
			ds_retorno_w := substr(wheb_mensagem_pck.get_texto(445896,'DS_CAIXA_W='||ds_caixa_w||';DT_MOVIMENTO_P='||DT_MOVIMENTO_P),1,254);
							/*O caixa #@DS_CAIXA_W#@ possui saldo diário para essa data  #@DT_MOVIMENTO_P#@ , porém  está fechado!*/

		elsif (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') and (coalesce(dt_fechamento_w::text, '') = '') then

				/*Se tiver saldo aberto para essa data e nao tiver fechado, tem que ver se nao tem lote em aberto, se tiver, nao pode gerar a movimentacao.*/

				select	count(*)
				into STRICT    cont_w
				from	movto_trans_financ
				where	nr_seq_caixa		=  	nr_seq_caixa_p
				and		(nr_seq_lote IS NOT NULL AND nr_seq_lote::text <> '')
				and     coalesce(dt_fechamento_lote::text, '') = ''
				and		nr_seq_saldo_caixa	=	nr_sequencia_w;

				if (cont_w > 0) then
					--ds_retorno_w := substr('O caixa '|| ds_caixa_w ||' possui um lote aberto, não será possível realizar a movimentação.',1,254);
					ds_retorno_w := substr(wheb_mensagem_pck.get_texto(304651,'DS_CAIXA_W='||ds_caixa_w),1,254);
				end if;

		end if;

	end if;

end if;

ds_retorno_p := substr(ds_retorno_w,1,254);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_saldo_caixa_depos ( nr_seq_caixa_p bigint, ie_forma_consiste_p text, dt_movimento_p timestamp, nm_usuario_p text, ds_retorno_p INOUT text) FROM PUBLIC;

