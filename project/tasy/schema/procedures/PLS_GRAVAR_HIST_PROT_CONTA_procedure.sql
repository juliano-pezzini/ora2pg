-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gravar_hist_prot_conta ( nr_seq_protocolo_p bigint, dt_mes_competencia_p timestamp, dt_mes_competencia_atual_p timestamp, vl_cobrado_manual_p bigint, vl_cobrado_manual_atual_p bigint, dt_protocolo_p timestamp, dt_protocolo_atual_p timestamp, nr_seq_prestador_p bigint, nr_seq_prestador_atual_p bigint, ds_observacao_p text, ds_observacao_atual_p text, nr_seq_lote_p text, nr_seq_lote_atual_p text, qt_contas_informadas_p bigint, qt_contas_informadas_atual_p bigint, ie_guia_fisica_p text, ie_guia_fisica_atual_p text, dt_recebimento_p timestamp, dt_recebimento_atual_p timestamp, ie_apresentacao_p text, ie_apresentacao_atual_p text, dt_atualizacao_p timestamp, nm_usuario_p text, ie_altera_prestador_conta_p text ) AS $body$
DECLARE

 
qt_protocolo_w			smallint;
ds_alteracoes_w			varchar(4000) := '';
ds_historico_w			varchar(4000) := '';
ds_delimitador_alteracao_w	varchar(50) :=	'------------------------------------';
ds_tipo_apresentacao_ant_w	varchar(30);
ds_tipo_apresentacao_atual_w	varchar(30);
ds_guia_fisica_atual_w		varchar(30);
ds_guia_fisica_ant_w		varchar(30);
ie_tipo_historico_w		pls_prot_conta_hist.ie_tipo_historico%type;


BEGIN 
 
if (coalesce(nr_seq_protocolo_p,0) > 0) then 
	 
	begin 
		select	count(1) 
		into STRICT	qt_protocolo_w 
		from	pls_protocolo_conta 
		where	nr_sequencia = nr_seq_protocolo_p  LIMIT 1;
		 
	exception 
	when others then 
		 
		qt_protocolo_w := 0;	
		 
	end;
	 
	if (qt_protocolo_w > 0) then 
		ie_tipo_historico_w := null;
		/* verificar os campos que houveram alteração e incluir na descrição do histórico*/
 
		if (dt_mes_competencia_atual_p IS NOT NULL AND dt_mes_competencia_atual_p::text <> '') then 
			ds_alteracoes_w := ds_alteracoes_w||'Mês de competência alterado:'||chr(13)||'De: '||coalesce(to_char(dt_mes_competencia_p,'dd/mm/yyyy'),'Não informado')|| 
					chr(13)||'Para: '||to_char(dt_mes_competencia_atual_p,'dd/mm/yyyy')||chr(13)||ds_delimitador_alteracao_w||chr(13);
			ie_tipo_historico_w := '1';
		end if;
		 
		if (vl_cobrado_manual_atual_p IS NOT NULL AND vl_cobrado_manual_atual_p::text <> '') then 
			ds_alteracoes_w := ds_alteracoes_w||'Valor cobrado manual alterado:'||chr(13)||'De: '||coalesce(Campo_mascara_virgula_casas(to_char(vl_cobrado_manual_p),2),'Não informado')|| 
					chr(13)||'Para: '||Campo_mascara_virgula_casas(vl_cobrado_manual_atual_p,2)||chr(13)||ds_delimitador_alteracao_w||chr(13);
			ie_tipo_historico_w := '2';
		end if;
		 
		if (dt_protocolo_atual_p IS NOT NULL AND dt_protocolo_atual_p::text <> '') then 
			ds_alteracoes_w := ds_alteracoes_w||'Data do protocolo alterado:'||chr(13)||'De: '||coalesce(to_char(dt_protocolo_p,'dd/mm/yyyy'),'Não informado')|| 
					chr(13)||'Para: '||dt_protocolo_atual_p||chr(13)||ds_delimitador_alteracao_w||chr(13);
			ie_tipo_historico_w := '3';
		end if;
		 
		if (nr_seq_prestador_atual_p IS NOT NULL AND nr_seq_prestador_atual_p::text <> '') then 
			ds_alteracoes_w := ds_alteracoes_w||'Prestador alterado:'||chr(13)||'De: '||coalesce(pls_obter_dados_prestador(nr_seq_prestador_p,'N'), 
							  'Não encontrado')||chr(13)||'Para: '||coalesce(pls_obter_dados_prestador(nr_seq_prestador_atual_p,'N'), 
							  'Não encontrado')||chr(13)||ds_delimitador_alteracao_w||chr(13);
			ie_tipo_historico_w := '4';
		end if;
		 
		if (ds_observacao_atual_p IS NOT NULL AND ds_observacao_atual_p::text <> '') then 
			ds_alteracoes_w := ds_alteracoes_w||'Observação alterado:'||chr(13)||'De: '||coalesce(substr(ds_observacao_p,1,255),'Não informado')|| 
							chr(13)||'Para: '||substr(ds_observacao_atual_p,1,255)||chr(13)||ds_delimitador_alteracao_w||chr(13);
			ie_tipo_historico_w := '5';
		end if;
		 
		if (nr_seq_lote_atual_p IS NOT NULL AND nr_seq_lote_atual_p::text <> '') then 
			ds_alteracoes_w := ds_alteracoes_w||'Lote alterado:'||chr(13)||'De: '||coalesce(to_char(nr_seq_lote_p),'Não encontrado')|| 
					chr(13)||'Para: '||nr_seq_lote_atual_p||chr(13)||ds_delimitador_alteracao_w||chr(13);
			ie_tipo_historico_w := '6';
		end if;
		 
		if (qt_contas_informadas_atual_p IS NOT NULL AND qt_contas_informadas_atual_p::text <> '') then 
			ds_alteracoes_w := ds_alteracoes_w||'Quantidade de contas alterado:'||chr(13)||'De: '||coalesce(to_char(qt_contas_informadas_p),'Não informado')|| 
					chr(13)||'Para: '||qt_contas_informadas_atual_p||chr(13)||ds_delimitador_alteracao_w||chr(13);
			ie_tipo_historico_w := '7';
		end if;
		 
		if (ie_guia_fisica_atual_p IS NOT NULL AND ie_guia_fisica_atual_p::text <> '') then 
		 
			select	CASE WHEN ie_guia_fisica_atual_p='S' THEN 'Sim' WHEN ie_guia_fisica_atual_p='N' THEN 'Não'  ELSE 'Não informado' END , 
				CASE WHEN ie_guia_fisica_p='S' THEN 'Sim' WHEN ie_guia_fisica_p='N' THEN 'Não'  ELSE 'Não informado' END  
			into STRICT	ds_guia_fisica_atual_w, 
				ds_guia_fisica_ant_w 
			;
		 
			ds_alteracoes_w := ds_alteracoes_w||'Guia física alterado:'||chr(13)||'De: '||coalesce(to_char(ds_guia_fisica_ant_w),'Não informado')|| 
					chr(13)||'Para: '||ds_guia_fisica_atual_w||chr(13)||ds_delimitador_alteracao_w||chr(13);
			ie_tipo_historico_w := '8';
		end if;
		 
		if (dt_recebimento_atual_p IS NOT NULL AND dt_recebimento_atual_p::text <> '') then 
			ds_alteracoes_w := ds_alteracoes_w||'Data de recebimento alterado:'||chr(13)||'De: '||coalesce(to_char(dt_recebimento_p),'Não informado')|| 
					chr(13)||'Para: '||dt_recebimento_atual_p||chr(13)||ds_delimitador_alteracao_w||chr(13);
			ie_tipo_historico_w := '9';
		end if;
		 
		if (ie_apresentacao_atual_p IS NOT NULL AND ie_apresentacao_atual_p::text <> '') then 
			 
			select	CASE WHEN ie_apresentacao_atual_p='A' THEN 'Apresentação' WHEN ie_apresentacao_atual_p='R' THEN 'Reapresentação'  ELSE 'Não informado' END , 
				CASE WHEN ie_apresentacao_p='A' THEN 'Apresentação' WHEN ie_apresentacao_p='R' THEN 'Reapresentação'  ELSE 'Não informado' END  
			into STRICT	ds_tipo_apresentacao_atual_w, 
				ds_tipo_apresentacao_ant_w 
			;
			 
			ds_alteracoes_w := ds_alteracoes_w||'Tipo de apresentação alterado:'||chr(13)||'De: '||coalesce(ds_tipo_apresentacao_ant_w,'Não informado')|| 
					chr(13)||'Para: '||ds_tipo_apresentacao_atual_w||chr(13)||ds_delimitador_alteracao_w||chr(13);
			ie_tipo_historico_w := '10';
		end if;
		 
		ds_alteracoes_w := ds_alteracoes_w||' Atualizar contas do protocolo conforme prestador do protocolo : '||ie_altera_prestador_conta_p||' '||chr(13);
		if (ds_alteracoes_w IS NOT NULL AND ds_alteracoes_w::text <> '') then 
			-- gravar o histórico com todos as alterações e delegar o nome ao usuário que efetuou a alteração. 
			ds_historico_w := ds_alteracoes_w||chr(13)||'Alterações efetuadas por: '||nm_usuario_p||' em '|| 
					 to_char(dt_atualizacao_p,'dd/mm/yyyy hh24:mi:ss')||'.';
		 
			begin 
				insert	into pls_prot_conta_hist(nr_sequencia, nr_seq_protocolo, ds_historico, 
					dt_historico, nm_usuario_historico, dt_atualizacao, 
					nm_usuario, ie_tipo_historico) 
				values (nextval('pls_prot_conta_hist_seq'),nr_seq_protocolo_p, ds_historico_w, 
					clock_timestamp(), nm_usuario_p, clock_timestamp(), 
					nm_usuario_p, coalesce(ie_tipo_historico_w,'99'));
				commit;
					 
			exception 
			when others then 
 
				/* 
				Não foi possível gravar o histórico da alteração. 
				Um erro ocorreu, veja os detalhes para maiores informações. 
				*/
 
				CALL wheb_mensagem_pck.exibir_mensagem_abort(220283);	
			 
			end;
		end if;
		 
	else 
		/* 
		Não foi possível gravar o histórico da alteração. 
		Não foi possível identificar o protocolo na base. 
		*/
 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(220282);
	end if;
else 
	/* 
	Não foi possível gravar o histórico da alteração. 
	Não foi possível identificar o protocolo a ser procurado. 
	*/
 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(220282);
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gravar_hist_prot_conta ( nr_seq_protocolo_p bigint, dt_mes_competencia_p timestamp, dt_mes_competencia_atual_p timestamp, vl_cobrado_manual_p bigint, vl_cobrado_manual_atual_p bigint, dt_protocolo_p timestamp, dt_protocolo_atual_p timestamp, nr_seq_prestador_p bigint, nr_seq_prestador_atual_p bigint, ds_observacao_p text, ds_observacao_atual_p text, nr_seq_lote_p text, nr_seq_lote_atual_p text, qt_contas_informadas_p bigint, qt_contas_informadas_atual_p bigint, ie_guia_fisica_p text, ie_guia_fisica_atual_p text, dt_recebimento_p timestamp, dt_recebimento_atual_p timestamp, ie_apresentacao_p text, ie_apresentacao_atual_p text, dt_atualizacao_p timestamp, nm_usuario_p text, ie_altera_prestador_conta_p text ) FROM PUBLIC;

