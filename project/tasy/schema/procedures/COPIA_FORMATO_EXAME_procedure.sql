-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copia_formato_exame ( nr_seq_formato_p bigint, nr_seq_material_p bigint, nr_seq_exame_origem_p bigint, nr_seq_exame_destino_p bigint, ie_copia_estrut_p text, nm_usuario_p text, cd_exame_destino_p text default null) AS $body$
DECLARE

 
ds_texto_w			varchar(2000);
nm_exame_w			varchar(50);
cd_proced_w			bigint;
ie_origem_w			bigint;
ie_formato_w		varchar(3);
nr_seq_grupo_w		bigint;
ie_solicitacao_w		varchar(1);
ds_orientacao_w		varchar(2000);
nr_seq_apres_w		bigint;
ds_unid_med_w		varchar(15);
nivel_w			bigint;
nr_seq_material_w		bigint;
nr_seq_formato_w		bigint;
nr_sequencia_w		bigint;
nr_seq_exame_w		bigint;
nr_seq_exame_ant_w	bigint;
nr_linha_w			smallint;
nr_coluna_w			smallint;
nr_seq_sup_w		bigint := 0;
nr_seq1_w			bigint := 0;
nr_seq2_w			bigint := 0;
nr_seq3_w			bigint := 0;
nr_seq4_w			bigint := 0;
ie_mapa_laudo_w		varchar(1);
ie_campo_calculo_w		varchar(1);
ie_restricao_w		varchar(1);
nr_seq_exame_destino_w	exame_laboratorio.nr_seq_exame%type;WITH RECURSIVE cte AS (


C010 CURSOR FOR 
SELECT 1 as level,a.nr_seq_exame,a.nm_exame,a.cd_procedimento,a.ie_origem_proced,obter_formato_result_exame(a.nr_seq_exame, nr_seq_material_p),a.ie_solicitacao,a.ds_orientacao_usuario,a.nr_seq_apresent,a.ds_unidade_medida,a.ie_campo_calculo,a.ie_restricao 
from exame_laboratorio a WHERE a.nr_seq_superior = nr_seq_exame_origem_p
  UNION ALL

 
C010 CURSOR FOR 
SELECT (c.level+1),a.nr_seq_exame,a.nm_exame,a.cd_procedimento,a.ie_origem_proced,obter_formato_result_exame(a.nr_seq_exame, nr_seq_material_p),a.ie_solicitacao,a.ds_orientacao_usuario,a.nr_seq_apresent,a.ds_unidade_medida,a.ie_campo_calculo,a.ie_restricao 
from exame_laboratorio a JOIN cte c ON (c.prior nr_seq_exame = a.nr_seq_superior)

) SELECT * FROM cte;
;

C020 CURSOR FOR 
SELECT ds_texto, nr_linha, nr_coluna, row_number() OVER () AS rownum 
from exame_lab_format_item 
where nr_seq_formato = nr_seq_formato_p 
order by 3,4;


BEGIN 
nr_seq_exame_destino_w := null;
if (cd_exame_destino_p IS NOT NULL AND cd_exame_destino_p::text <> '') then 
	begin 
		select	max(nr_seq_exame) 
		into STRICT	nr_seq_exame_destino_w 
		from	exame_laboratorio 
		where	cd_exame = cd_exame_destino_p;
	exception 
		when 	others then 
			nr_seq_exame_destino_w := nr_seq_exame_destino_p;
	end;
else 
	nr_seq_exame_destino_w := nr_seq_exame_destino_p;
end if;
 
select nr_seq_grupo 
into STRICT nr_seq_grupo_w 
from exame_laboratorio 
where nr_seq_exame = nr_seq_exame_destino_w;
 
begin 
select nr_seq_material 
into STRICT nr_seq_material_w 
from exame_lab_material 
where nr_seq_exame = nr_seq_exame_destino_w 
 and nr_seq_material = nr_seq_material_p;
exception 
 	when no_data_found then 
		begin 
		select nr_seq_material 
		into STRICT nr_seq_material_w 
		from exame_lab_material 
		where nr_seq_exame = nr_seq_exame_destino_w 
		 and ie_prioridade = (SELECT min(ie_prioridade) 
					from exame_lab_material 
					where nr_seq_exame = nr_seq_exame_destino_w);
		exception 
			when others then 
				nr_seq_material_w := 0;
		end;		
end;
 
begin 
select count(*) 
into STRICT nr_seq_formato_w 
from exame_lab_format 
where nr_seq_exame = nr_seq_exame_destino_w 
 and nr_seq_material = nr_seq_material_w;
exception 
	when others then 
		nr_seq_formato_w := 0;
end;
 
if (nr_seq_formato_w = 0) then 
	begin 
	select nextval('exame_lab_format_seq') 
	into STRICT nr_seq_formato_w 
	;
 
	select	coalesce(max(ie_mapa_laudo),'L') 
	into STRICT	ie_mapa_laudo_w	 
	from	exame_lab_format 
	where	nr_seq_formato = nr_seq_formato_p;
	 
	insert into exame_lab_format(nr_seq_formato, nr_seq_exame, nr_seq_material, 
	 ds_cabecalho, ds_rodape, dt_atualizacao, nm_usuario, ie_padrao, ie_mapa_laudo) 
	values (nr_seq_formato_w, nr_seq_exame_destino_w, nr_seq_material_w, 
		 null, null, clock_timestamp(), nm_usuario_p, 'S', ie_mapa_laudo_w);
 
	insert into exame_lab_format_item 
	SELECT nr_seq_formato_w,row_number() OVER () AS rownum,nr_seq_exame,ds_texto,nr_linha,nr_coluna,clock_timestamp(), 
		nm_usuario_p, ds_regra 
	from exame_lab_format_item 
	where nr_seq_formato = nr_seq_formato_p;
	end;
end if;
 
if (ie_copia_estrut_p = 'S')then 
	begin 
	OPEN C010;
	LOOP 
		FETCH C010 into	nivel_w, 
					nr_seq_exame_ant_w, 
					nm_exame_w, 
					cd_proced_w, 
					ie_origem_w, 
					ie_formato_w, 
					ie_solicitacao_w, 
					ds_orientacao_w, 
					nr_seq_apres_w, 
					ds_unid_med_w, 
					ie_campo_calculo_w, 
					ie_restricao_w;
		if C010%FOUND then 
			begin 
			select max(coalesce(nr_seq_exame,0)) + 1 
			into STRICT nr_seq_exame_w 
			from exame_laboratorio;
 
			if (nivel_w = 1) then 
				begin 
				nr_seq_sup_w := nr_seq_exame_destino_w;
				nr_seq1_w := nr_seq_exame_w;
				end;
			elsif (nivel_w = 2) then 
				begin 
				nr_seq_sup_w := nr_seq1_w;
				nr_seq2_w := nr_seq_exame_w;
				end;
			elsif (nivel_w = 3) then 
				begin 
				nr_seq_sup_w := nr_seq2_w;
				nr_seq3_w := nr_seq_exame_w;
				end;
			elsif (nivel_w = 4) then 
				begin 
				nr_seq_sup_w := nr_seq3_w;
				nr_seq4_w := nr_seq_exame_w;
				end;
			elsif (nivel_w = 5) then 
				nr_seq_sup_w := nr_seq4_w;
			end if;
 
			insert into exame_laboratorio(nr_seq_exame,nm_exame,dt_atualizacao,nm_usuario,cd_procedimento,ie_origem_proced, 
			 nr_seq_superior,cd_exame,ie_formato_resultado,nr_seq_grupo,ie_solicitacao, 
			 ds_orientacao_usuario,nr_seq_apresent,ds_unidade_medida, ie_prescricao_rotina, ie_grid_pep, ie_campo_calculo, ie_restricao) 
			values (nr_seq_exame_w,nm_exame_w,clock_timestamp(),nm_usuario_p,cd_proced_w,ie_origem_w, 
			 nr_seq_sup_w,null,ie_formato_w,nr_seq_grupo_w,ie_solicitacao_w, 
			 ds_orientacao_w,nr_seq_apres_w,ds_unid_med_w,'S','S',ie_campo_calculo_w, ie_restricao_w);
 
			update exame_lab_format_item 
			set nr_seq_exame = nr_seq_exame_w 
			where nr_seq_formato = nr_seq_formato_w 
 			 and nr_seq_exame = nr_seq_exame_ant_w;
			end;
		else 
			exit;
		end if;
	END LOOP;
	CLOSE C010;
	end;
end if;
COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copia_formato_exame ( nr_seq_formato_p bigint, nr_seq_material_p bigint, nr_seq_exame_origem_p bigint, nr_seq_exame_destino_p bigint, ie_copia_estrut_p text, nm_usuario_p text, cd_exame_destino_p text default null) FROM PUBLIC;

