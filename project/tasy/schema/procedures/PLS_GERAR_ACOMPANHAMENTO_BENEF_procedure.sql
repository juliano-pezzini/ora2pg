-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_acompanhamento_benef ( dt_mes_competencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_usuario_plano_w		varchar(30);
nm_beneficiario_w		varchar(255);
dt_contratacao_w		timestamp;
nr_seq_vendedor_w		bigint;
nr_seq_vendedor_pf_w		bigint;
nr_seq_plano_w			bigint;
qt_idade_w			bigint;
nr_contrato_w			bigint;
nm_estipulante_w		varchar(255);
cd_pf_estipulante_w		varchar(10);
cd_cgc_estipulante_w		varchar(14);
nr_titulo_w			bigint;
vl_mensalidade_w		double precision;
dt_mes_competencia_w		timestamp;
nr_seq_equipe_w			bigint;
nr_seq_segurado_w		bigint;
nr_seq_mensalidade_seg_w	bigint;
nr_seq_acomp_benef_w		bigint;
ie_origem_w			varchar(15);
vl_sca_w			bigint;
nr_seq_vinculo_sca_w		bigint;
ie_gerar_sca_w			varchar(1);
ie_acao_contrato_w		varchar(2);
vl_preco_pre_w			double precision;

C01 CURSOR FOR 
	SELECT	b.nr_sequencia, 
		c.cd_usuario_plano, 
		a.nm_pessoa_fisica, 
		b.dt_contratacao, 
		b.nr_seq_vendedor_canal, 
		b.nr_seq_vendedor_pf, 
		b.nr_seq_plano, 
		trunc(months_between(clock_timestamp(), trunc(a.dt_nascimento,'month')) / 12), 
		d.nr_contrato, 
		substr(obter_nome_pf_pj(d.cd_pf_estipulante, d.cd_cgc_estipulante),1,200), 
		d.cd_pf_estipulante, 
		d.cd_cgc_estipulante, 
		'B', 
		null, 
		b.ie_acao_contrato 
	from	pessoa_fisica		a, 
		pls_segurado		b, 
		pls_segurado_carteira	c, 
		pls_contrato		d 
	where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica 
	and	c.nr_seq_segurado	= b.nr_sequencia 
	and	b.nr_seq_contrato	= d.nr_sequencia 
	and	trunc(b.dt_contratacao,'month')	= dt_mes_competencia_w 
	and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') 
	
union all
 
	SELECT	b.nr_sequencia, 
		c.cd_usuario_plano, 
		a.nm_pessoa_fisica, 
		f.dt_inicio_vigencia, 
		f.nr_seq_vendedor_canal, 
		f.nr_seq_vendedor_pf, 
		f.nr_seq_plano, 
		trunc(months_between(clock_timestamp(), trunc(a.dt_nascimento,'month')) / 12), 
		d.nr_contrato, 
		substr(obter_nome_pf_pj(d.cd_pf_estipulante, d.cd_cgc_estipulante),1,200), 
		d.cd_pf_estipulante, 
		d.cd_cgc_estipulante, 
		'S', 
		f.nr_sequencia nr_seq_vinculo_sca, 
		b.ie_acao_contrato 
	from	pessoa_fisica		a, 
		pls_segurado		b, 
		pls_segurado_carteira	c, 
		pls_sca_vinculo		f, 
		pls_contrato		d 
	where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica 
	and	c.nr_seq_segurado	= b.nr_sequencia 
	and	f.nr_seq_segurado	= b.nr_sequencia 
	and	b.nr_seq_contrato	= d.nr_sequencia 
	and	trunc(f.dt_inicio_vigencia,'month')	= dt_mes_competencia_w 
	and	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '') 
	and	ie_gerar_sca_w = 'S';


BEGIN 
 
ie_gerar_sca_w		:= coalesce(obter_valor_param_usuario(1237, 60, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_p),'S');
 
dt_mes_competencia_w	:= trunc(dt_mes_competencia_p,'month');
 
delete	FROM pls_acompanhamento_benef 
where	trunc(dt_contratacao,'month') = dt_mes_competencia_w;
 
open C01;
loop 
fetch C01 into 
	nr_seq_segurado_w, 
	cd_usuario_plano_w, 
	nm_beneficiario_w, 
	dt_contratacao_w, 
	nr_seq_vendedor_w, 
	nr_seq_vendedor_pf_w, 
	nr_seq_plano_w, 
	qt_idade_w, 
	nr_contrato_w, 
	nm_estipulante_w, 
	cd_pf_estipulante_w, 
	cd_cgc_estipulante_w, 
	ie_origem_w, 
	nr_seq_vinculo_sca_w, 
	ie_acao_contrato_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	nr_titulo_w		:= null;
	vl_mensalidade_w	:= 0;
	 
	select	max(a.nr_seq_equipe) 
	into STRICT	nr_seq_equipe_w 
	from	pls_vendedor		b, 
		pls_equipe_vend_vinculo	a 
	where	a.nr_seq_vendedor	= b.nr_sequencia 
	and	b.nr_sequencia		= nr_seq_vendedor_w 
	and	dt_mes_competencia_w between coalesce(a.dt_inicio_vigencia, dt_mes_competencia_w) and coalesce(a.dt_fim_vigencia, dt_mes_competencia_w);
	 
	select	max(a.nr_sequencia) 
	into STRICT	nr_seq_mensalidade_seg_w 
	from	pls_mensalidade_segurado a, 
		pls_mensalidade		b 
	where	a.nr_seq_mensalidade	= b.nr_sequencia 
	and	a.dt_mesano_referencia	= dt_mes_competencia_w 
	and	a.nr_seq_segurado	= nr_seq_segurado_w 
	and	coalesce(b.ie_cancelamento::text, '') = ''  LIMIT 1;
	 
	if (nr_seq_mensalidade_seg_w IS NOT NULL AND nr_seq_mensalidade_seg_w::text <> '') then 
		if (ie_origem_w	= 'B') then 
			select	vl_mensalidade 
			into STRICT	vl_mensalidade_w 
			from	pls_mensalidade_segurado 
			where	nr_sequencia	= nr_seq_mensalidade_seg_w;
		elsif (ie_origem_w	= 'S') then 
			select	sum(vl_item) 
			into STRICT	vl_mensalidade_w 
			from	pls_mensalidade_seg_item 
			where	nr_seq_mensalidade_seg	= nr_seq_mensalidade_seg_w 
			and	nr_seq_vinculo_sca	= nr_seq_vinculo_sca_w 
			and	ie_tipo_item		= '15';
		end if;
		nr_titulo_w	:= pls_obter_titulo_mensalidade(null,nr_seq_mensalidade_seg_w);
	end if;
	 
	/* Obter o valor pré estabelecido do beneficiário */
 
	select	max(vl_preco_atual) 
	into STRICT	vl_preco_pre_w 
	from	pls_segurado_preco 
	where	nr_seq_segurado	= nr_seq_segurado_w 
	and	cd_motivo_reajuste = 'C';
	 
	select	nextval('pls_acompanhamento_benef_seq') 
	into STRICT	nr_seq_acomp_benef_w 
	;
	 
	insert into pls_acompanhamento_benef(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec, 
			cd_usuario_plano,nm_beneficiario,dt_contratacao,nr_seq_vendedor,nr_seq_vendedor_pf, 
			nr_seq_plano,qt_idade,nr_contrato,nm_estipulante,cd_pf_estipulante, 
			cd_cgc_estipulante,nr_titulo,vl_mensalidade,nr_seq_equipe,nr_seq_segurado, 
			ie_acao_contrato, vl_preco_pre) 
	values (	nr_seq_acomp_benef_w,clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p, 
			cd_usuario_plano_w,nm_beneficiario_w,dt_contratacao_w,nr_seq_vendedor_w,nr_seq_vendedor_pf_w, 
			nr_seq_plano_w,qt_idade_w,nr_contrato_w,nm_estipulante_w,cd_pf_estipulante_w, 
			cd_cgc_estipulante_w,nr_titulo_w,vl_mensalidade_w,nr_seq_equipe_w,nr_seq_segurado_w, 
			ie_acao_contrato_w, vl_preco_pre_w);
	 
	end;
end loop;
close C01;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_acompanhamento_benef ( dt_mes_competencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

