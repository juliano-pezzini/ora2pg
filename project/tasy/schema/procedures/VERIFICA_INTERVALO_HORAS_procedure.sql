-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE verifica_intervalo_horas ( nr_prescricao_p bigint, nr_sequencia_p bigint, cd_setor_atendimento_p bigint, cd_material_p bigint, ie_via_aplicacao_p text, nr_ocorrencia_p bigint, ds_erro_p INOUT text, ie_agrupador_p bigint) AS $body$
DECLARE

				
qt_intervalo_min_horas_w	smallint;
qt_intervalo_max_horas_w	smallint;
cd_estabelecimento_w		prescr_medica.cd_estabelecimento%type;
nr_atendimento_w			prescr_medica.nr_atendimento%type;
qt_idade_w                 	double precision;
cd_pessoa_fisica_w			prescr_medica.cd_pessoa_fisica%type;

c01 CURSOR FOR
	SELECT	coalesce(a.qt_intervalo_horas,0),
			coalesce(a.qt_intervalo_max_horas,0)
	from	material_prescr a
	where	a.cd_material							= cd_material_p
	and		a.ie_tipo								= '2'
	and		coalesce(a.cd_setor_atendimento, coalesce(cd_setor_atendimento_p,0))	= coalesce(cd_setor_atendimento_p,0)
	and		coalesce(a.ie_via_aplicacao, coalesce(ie_via_aplicacao_p,'0'))			= coalesce(ie_via_aplicacao_p,'0')
	and		coalesce(a.cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w	
	and		(a.qt_intervalo_horas IS NOT NULL AND a.qt_intervalo_horas::text <> '')
	and		(((coalesce(a.ie_tipo_item,'TOD') = 'SOL') and (ie_agrupador_p = 4)) or
			 ((coalesce(a.ie_tipo_item,'TOD') = 'OUT') and (ie_agrupador_p <> 4)) or (coalesce(a.ie_tipo_item,'TOD') = 'TOD'))
	and    	coalesce(trunc(qt_idade_w),1) between coalesce(obter_idade_param_prescr2(coalesce(a.qt_idade_min,0),coalesce(a.qt_idade_min_mes,0),coalesce(a.qt_idade_min_dia,0),coalesce(a.qt_idade_max,0),coalesce(a.qt_idade_max_mes,0),coalesce(a.qt_idade_max_dia,0),'MIN'),0) and
			coalesce(obter_idade_param_prescr2(coalesce(a.qt_idade_min,0),coalesce(a.qt_idade_min_mes,0),coalesce(a.qt_idade_min_dia,0),coalesce(a.qt_idade_max,0),coalesce(a.qt_idade_max_mes,0),coalesce(a.qt_idade_max_dia,0),'MAX'),9999999)		
	order by coalesce(a.cd_setor_atendimento,999999),
		coalesce(a.ie_via_aplicacao,'zzzzz');
		


BEGIN

ds_erro_p	:= '';

if (nr_ocorrencia_p > 0) then

	cd_estabelecimento_w	:= coalesce(wheb_usuario_pck.get_cd_estabelecimento,1);
	
	select 	max(nr_atendimento)
	into STRICT	nr_atendimento_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;
	
	cd_pessoa_fisica_w		:= obter_pessoa_atendimento(nr_atendimento_w, 'C');
	
	select
        max(obter_idade(b.dt_nascimento, coalesce(b.dt_obito, clock_timestamp()), 'DIA'))
    into STRICT
        qt_idade_w        
    from
        pessoa_fisica b
    where
        b.cd_pessoa_fisica = cd_pessoa_fisica_w;
				
	open c01;
	loop
	fetch c01 into
		qt_intervalo_min_horas_w,
		qt_intervalo_max_horas_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
						
		if (nr_ocorrencia_p < 25) then /* Quando so tem um horario nao tem intervalo, retorna o numero de horas pela qual estou comparando neste caso 25 */
			if	(qt_intervalo_min_horas_w > 0 AND qt_intervalo_max_horas_w = 0) and (nr_ocorrencia_p < qt_intervalo_min_horas_w) then
				ds_erro_p	:= wheb_mensagem_pck.get_texto(278783, 'QT_INTERVALO_MIN_HORAS_P=' || qt_intervalo_min_horas_w);			
			elsif	(qt_intervalo_min_horas_w = 0 AND qt_intervalo_max_horas_w > 0) and (nr_ocorrencia_p > qt_intervalo_max_horas_w) then
				ds_erro_p	:= wheb_mensagem_pck.get_texto(278787, 'QT_INTERVALO_MAX_HORAS_P=' || qt_intervalo_max_horas_w);
			elsif	(qt_intervalo_min_horas_w > 0 AND qt_intervalo_max_horas_w > 0) then		
				if (nr_ocorrencia_p between qt_intervalo_min_horas_w and qt_intervalo_max_horas_w) then
					ds_erro_p	:= '';
				else
					ds_erro_p	:= wheb_mensagem_pck.get_texto(278788, 'QT_INTERVALO_MIN_HORAS_P=' || qt_intervalo_min_horas_w ||
												';QT_INTERVALO_MAX_HORAS_P=' || qt_intervalo_max_horas_w);											
				end if;
			end if;
		end if;
	end loop;	
	close c01;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE verifica_intervalo_horas ( nr_prescricao_p bigint, nr_sequencia_p bigint, cd_setor_atendimento_p bigint, cd_material_p bigint, ie_via_aplicacao_p text, nr_ocorrencia_p bigint, ds_erro_p INOUT text, ie_agrupador_p bigint) FROM PUBLIC;

