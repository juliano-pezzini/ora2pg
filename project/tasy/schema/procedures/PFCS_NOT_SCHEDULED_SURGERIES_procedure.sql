-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pfcs_not_scheduled_surgeries ( nr_seq_indicator_p bigint, cd_estabelecimento_p text, nm_usuario_p text) AS $body$
DECLARE


qt_total_above_rule_w		bigint := 0;
qt_total_below_rule_w		bigint := 0;
ie_over_threshold_w		varchar(1) := 'N';
pfcs_panel_detail_seq_w		pfcs_panel_detail.nr_sequencia%type;
nr_seq_operational_level_w	pfcs_operational_level.nr_sequencia%type;
nr_seq_panel_w			pfcs_panel.nr_sequencia%type;
qt_time_rule_w			pfcs_time_surgery_sched.qt_time%type;

c01 CURSOR FOR
SELECT	'PS' ie_origin, -- Patient schedule
	a.cd_pessoa_fisica id_patient,
	coalesce(get_formatted_person_name(a.cd_pessoa_fisica, 'list'), obter_nome_pf(a.cd_pessoa_fisica)) nm_patient,
	obter_desc_classif_pac(a.nr_seq_tipo_classif_pac) ds_classification,
	obter_sexo_pf(a.cd_pessoa_fisica, 'D') ds_gender,
	c.dt_nascimento dt_birthdate,
    obter_dados_pf(a.cd_pessoa_fisica, 'I') qt_idade_paciente,
	a.cd_procedimento cd_procedure,
  substr(obter_exame_agenda(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno),1,240) ds_procedure,
	(select	x.ds_sala_painel
	from	sala_cirurgia x
	where	x.nr_sequencia	= b.nr_seq_sala_cir) ds_room,
	a.dt_agenda dt_schedule,
	a.hr_inicio hr_start,
	a.nr_minuto_duracao qt_duration_minutes,
	coalesce(get_formatted_person_name(a.cd_medico, 'list'), obter_nome_pf(a.cd_medico)) nm_physician,
	a.ie_status_agenda ie_status_schedule,
	null dt_desired_waiting_list,
	null ie_status_waiting_list,
	null dt_schedule_waiting_list,
	(clock_timestamp() - a.dt_agendamento) qt_time_schedule
from	pessoa_fisica	c,
	agenda_paciente	a,
	agenda		b
where	a.cd_agenda		= b.cd_agenda
and	a.cd_pessoa_fisica	= c.cd_pessoa_fisica
and	b.cd_tipo_agenda	= 1
and	a.ie_status_agenda	= 'PA'
and	b.cd_estabelecimento	= (cd_estabelecimento_p)::numeric

union all

select	'WL' ie_origin, -- Waiting list
	a.cd_pessoa_fisica id_patient,
	coalesce(get_formatted_person_name(a.cd_pessoa_fisica, 'list'), obter_nome_pf(a.cd_pessoa_fisica)) nm_patient,
	obter_desc_classif_pac(a.nr_seq_tipo_classif_pac) ds_classification,
	obter_sexo_pf(a.cd_pessoa_fisica, 'D') ds_gender,
	c.dt_nascimento dt_birthdate,
    obter_dados_pf(a.cd_pessoa_fisica, 'I') qt_idade_paciente,
	a.cd_procedimento cd_procedure,
	substr(obter_exame_agenda(a.cd_procedimento, a.ie_origem_proced, a.nr_seq_proc_interno),1,240) ds_procedure,
	(select	x.ds_sala_painel
	from	sala_cirurgia x
	where	x.nr_sequencia	= b.nr_seq_sala_cir) ds_room,
	null dt_schedule,
	null hr_start,
	null qt_duration_minutes,
	coalesce(get_formatted_person_name(coalesce(a.cd_medico, a.cd_medico_exec), 'list'), obter_nome_pf(coalesce(a.cd_medico, a.cd_medico_exec))) nm_physician,
	null ie_status_schedule,
	a.dt_desejada dt_desired_waiting_list,
	a.ie_status_espera ie_status_waiting_list,
	a.dt_agendamento dt_schedule_waiting_list,
	(clock_timestamp() - a.dt_agendamento) qt_time_schedule
from	pessoa_fisica		c,
	agenda_lista_espera	a,
	agenda			b
where	a.cd_agenda		= b.cd_agenda
and	a.cd_pessoa_fisica	= c.cd_pessoa_fisica
and	b.cd_tipo_agenda	= 1
and	a.ie_status_espera	= 'A'
and	b.cd_estabelecimento	= (cd_estabelecimento_p)::numeric;

BEGIN

nr_seq_operational_level_w := pfcs_get_structure_level(
		cd_establishment_p => cd_estabelecimento_p,
		ie_level_p => 'O',
		ie_info_p => 'C');

select	max(qt_time)
into STRICT	qt_time_rule_w
from	pfcs_time_surgery_sched;

for c01_w in c01 loop
	begin
	if (qt_time_rule_w < c01_w.qt_time_schedule) then
		qt_total_above_rule_w := qt_total_above_rule_w + 1;
		ie_over_threshold_w := 'S';
	else
		qt_total_below_rule_w := qt_total_below_rule_w + 1;
		ie_over_threshold_w := 'N';
	end if;

	select	nextval('pfcs_panel_detail_seq')
	into STRICT	pfcs_panel_detail_seq_w
	;

	insert into pfcs_panel_detail(
		nr_sequencia,
		nm_usuario,
		dt_atualizacao,
		nm_usuario_nrec,
		dt_atualizacao_nrec,
		ie_situation,
		nr_seq_indicator,
		nr_seq_operational_level)
	values (
		pfcs_panel_detail_seq_w,
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		'T',
		nr_seq_indicator_p,
		nr_seq_operational_level_w);

	insert into pfcs_detail_patient(
		nr_sequencia,
		nm_usuario,
		dt_atualizacao,
		nm_usuario_nrec,
		dt_atualizacao_nrec,
		nr_seq_detail,
		id_patient,
		nm_patient,
		ds_gender,
		ds_classification,
		dt_birthdate,
        ds_age_range,
		qt_time_schedule,
		ie_over_threshold)
	values (
		nextval('pfcs_detail_patient_seq'),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		pfcs_panel_detail_seq_w,
		c01_w.id_patient,
		c01_w.nm_patient,
		c01_w.ds_gender,
		c01_w.ds_classification,
		c01_w.dt_birthdate,
        c01_w.qt_idade_paciente,
		round(c01_w.qt_time_schedule * 1440),
		ie_over_threshold_w);

	insert into pfcs_detail_schedule(
		nr_sequencia,
		nm_usuario,
		dt_atualizacao,
		nm_usuario_nrec,
		dt_atualizacao_nrec,
		nr_seq_detail,		
		cd_procedure,
		ds_procedure,
		ds_room,
		dt_schedule,
		hr_start,
		qt_duration_minutes,
		nm_physician,
		ie_status_schedule,
		dt_schedule_waiting_list,
		dt_desired_waiting_list,
		ie_status_waiting_list)
	values (
		nextval('pfcs_detail_schedule_seq'),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		pfcs_panel_detail_seq_w,
		c01_w.cd_procedure,
		c01_w.ds_procedure,
		c01_w.ds_room,
		c01_w.dt_schedule,
		c01_w.hr_start,
		c01_w.qt_duration_minutes,
		c01_w.nm_physician,
		c01_w.ie_status_schedule,
		c01_w.dt_schedule_waiting_list,
		c01_w.dt_desired_waiting_list,
		c01_w.ie_status_waiting_list);
	end;
end loop;

commit;

 := pfcs_pck.pfcs_generate_results(
		vl_indicator_p => qt_total_above_rule_w, vl_indicator_aux_p => qt_total_below_rule_w, nr_seq_indicator_p => nr_seq_indicator_p, nr_seq_operational_level_p => nr_seq_operational_level_w, nm_usuario_p => nm_usuario_p, nr_seq_panel_p => nr_seq_panel_w);

CALL pfcs_pck.pfcs_update_detail(
		nr_seq_indicator_p => nr_seq_indicator_p,
		nr_seq_panel_p => nr_seq_panel_w,
		nr_seq_operational_level_p => nr_seq_operational_level_w,
		nm_usuario_p => nm_usuario_p);

CALL pfcs_pck.pfcs_activate_records(
		nr_seq_indicator_p => nr_seq_indicator_p,
		nr_seq_operational_level_p => nr_seq_operational_level_w,
		nm_usuario_p => nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_not_scheduled_surgeries ( nr_seq_indicator_p bigint, cd_estabelecimento_p text, nm_usuario_p text) FROM PUBLIC;

