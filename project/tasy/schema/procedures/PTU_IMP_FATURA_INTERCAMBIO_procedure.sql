-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_imp_fatura_intercambio ( ds_conteudo_p text, nm_arquivo_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_tipo_registro_w	varchar(3);
nr_seq_fatura_w		bigint;
nr_versao_trans_imp_w	smallint;

--R801 - Header
cd_unimed_destino_w	varchar(3);
cd_unimed_origem_w	varchar(3);
dt_geracao_w		varchar(8);
dt_geracao_ww		timestamp;
nr_competencia_w	varchar(8);
dt_competencia_w	timestamp;
dt_inicio_periodo_w	varchar(8);
dt_inicio_periodo_ww	timestamp;
dt_fim_periodo_w	varchar(8);
dt_fim_periodo_ww	timestamp;
ie_tipo_documento_w	varchar(1);
nr_documento_w		bigint;
dt_vencimento_doc_w	varchar(8);
dt_vencimento_doc_ww	timestamp;
dt_emissao_doc_w	varchar(8);
dt_emissao_doc_ww	timestamp;
vl_tot_doc_w		double precision;
vl_tot_doc_liq_w	double precision;
vl_ajuste_doc_w		double precision;
nr_versao_transacao_w	varchar(2);
vl_imposto_renda_w	double precision;

--R802 - Cobrança Beneficiários
cd_unimed_w		varchar(3);
cd_carteira_benef_w	varchar(13);
cd_filial_w		varchar(3);
cd_familia_w		integer;
cd_dependencia_w	varchar(2);
nm_beneficiario_w	varchar(25);
dt_nascimento_w		varchar(8);
dt_nascimento_ww	timestamp;
cd_plano_intercambio_w	varchar(3);
vl_mens_original_w	double precision;
vl_insc_original_w	double precision;
vl_mens_cobranca_w	double precision;
vl_insc_cobranca_w	double precision;
vl_ajuste_w		double precision;
cd_empresa_origem_w	bigint;
nr_seq_plano_w		bigint;

--R809 - Trailer
qt_total_R802_w		bigint;
vl_tot_mens_original_w	double precision;
vl_tot_insc_original_w	double precision;
vl_tot_mens_w		double precision;
vl_tot_insc_w		double precision;
vl_tot_ajustes_w	double precision;

--R810 - Dados do Cedente e do Sacado para emissão na Fatura
ie_tipo_ced_sac_w	varchar(1);
cd_operadora_ans_w	varchar(10);
cd_operadora_ans_ww	bigint;
nm_cedente_sacado_w	varchar(60);
ds_endereco_w		varchar(40);
ds_endereco_compl_w	varchar(20);
ds_bairro_w		varchar(30);
nr_cep_w		varchar(8);
ds_cidade_w		varchar(30);
sg_uf_w			varchar(2);
cd_cnpj_cpf_w		varchar(14);
cd_inscricao_estadual_w	varchar(20);
nr_ddd_w		smallint;
nr_telefone_w		integer;
nr_fax_w		integer;
nr_endereco_w		varchar(6);

--R811 - Corpo da Fatura
nr_linha_w		smallint;
ds_linha_w		varchar(74);
vl_item_w		double precision;


BEGIN
cd_tipo_registro_w	:= substr(ds_conteudo_p, 9, 3);

if (cd_tipo_registro_w = '801') then
	select	substr(ds_conteudo_p, 13, 3),
			substr(ds_conteudo_p, 17, 3),
			substr(ds_conteudo_p, 48, 1),
			substr(ds_conteudo_p, 134, 20),
			substr(ds_conteudo_p, 118, 2)
	into STRICT	cd_unimed_destino_w,
			cd_unimed_origem_w,
			ie_tipo_documento_w,
			nr_documento_w,
			nr_versao_transacao_w
	;

	dt_geracao_w		:= substr(ds_conteudo_p, 26, 2) || substr(ds_conteudo_p, 24, 2) || substr(ds_conteudo_p, 20, 4);

	if (dt_geracao_w <> '        ') then
		dt_geracao_ww		:= to_date(dt_geracao_w, 'dd/mm/yyyy');
	end if;

	dt_inicio_periodo_w	:= substr(ds_conteudo_p, 38, 2) || substr(ds_conteudo_p, 36, 2) || substr(ds_conteudo_p, 32, 4);

	if (dt_inicio_periodo_w <> '        ') then
		dt_inicio_periodo_ww		:= to_Date(dt_inicio_periodo_w, 'dd/mm/yyyy');
	end if;

	dt_fim_periodo_w		:= substr(ds_conteudo_p, 46, 2) || substr(ds_conteudo_p, 44, 2) || substr(ds_conteudo_p, 40, 4);

	if (dt_fim_periodo_w  <> '        ') then
		dt_fim_periodo_ww	:= to_date(dt_fim_periodo_w, 'dd/mm/yyyy');
	end if;

	dt_vencimento_doc_w	:= substr(ds_conteudo_p, 66, 2) || substr(ds_conteudo_p, 64, 2) || substr(ds_conteudo_p, 60, 4);

	if (dt_vencimento_doc_w <> '        ') then
		dt_vencimento_doc_ww		:= to_Date(dt_vencimento_doc_w,'dd/mm/yyyy');
	end if;

	dt_emissao_doc_w		:= substr(ds_conteudo_p, 74, 2) || substr(ds_conteudo_p, 72, 2) || substr(ds_conteudo_p, 68, 4);

	if (dt_emissao_doc_w  <> '        ') then
		dt_emissao_doc_ww	:= to_date(dt_emissao_doc_w, 'dd/mm/yyyy');
	end if;

	nr_competencia_w	:= substr(ds_conteudo_p, 30, 2) || '/' || substr(ds_conteudo_p, 28, 2);

	if (nr_competencia_w <> '    ') then
		dt_competencia_w	:= to_date('01/' || nr_competencia_w, 'dd/mm/yy');
	end if;

	vl_tot_doc_w		:= (substr(ds_conteudo_p, 76, 12) || ',' || substr(ds_conteudo_p, 88, 2))::numeric;
	vl_tot_doc_liq_w	:= (substr(ds_conteudo_p, 90, 12) || ',' || substr(ds_conteudo_p, 102, 2))::numeric;
	vl_ajuste_doc_w		:= (substr(ds_conteudo_p, 104, 12) || ',' || substr(ds_conteudo_p, 116, 2) )::numeric;
	vl_imposto_renda_w	:= (substr(ds_conteudo_p, 120, 12) || ',' || substr(ds_conteudo_p, 132, 12))::numeric;

	select	nextval('ptu_fatura_pre_seq')
	into STRICT	nr_seq_fatura_w
	;

	ie_tipo_documento_w	:= trim(both ie_tipo_documento_w);

	insert into ptu_fatura_pre(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_estabelecimento,
		ie_envio_recebimento,
		cd_unimed_destino,
		cd_unimed_origem,
		dt_geracao,
		nr_versao_transacao,
		tp_registro,
		dt_competencia,
		dt_cobranca_inicial,
		dt_cobranca_final,
		tp_documento,
		nr_documento,
		dt_vencimento,
		dt_emissao,
		vl_total,
		vl_total_liq,
		vl_ajuste,
		vl_ir,
		nr_seq_geracao,
		nm_arquivo,
		dt_importacao_arquivo,
		ie_status_monitoramento)
	values (nr_seq_fatura_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_p,
		'R',
		cd_unimed_destino_w,
		cd_unimed_origem_w,
		dt_geracao_ww,
		nr_versao_transacao_w,
		cd_tipo_registro_w,
		dt_competencia_w,
		dt_inicio_periodo_ww,
		dt_fim_periodo_ww,
		ie_tipo_documento_w,
		nr_documento_w,
		dt_vencimento_doc_ww,
		dt_emissao_doc_ww,
		vl_tot_doc_w,
		vl_tot_doc_liq_w,
		vl_ajuste_doc_w,
		vl_imposto_renda_w,
		0,
		nm_arquivo_p,
		clock_timestamp(),
		'P');
elsif (cd_tipo_registro_w = '802') then
	select	max(nr_sequencia)
	into STRICT	nr_seq_fatura_w
	from	ptu_fatura_pre
	where	ie_envio_recebimento	= 'R';

	select	lpad(max(nr_versao_transacao), 2, '0')
	into STRICT	nr_versao_transacao_w
	from	ptu_fatura_pre
	where	nr_sequencia = nr_seq_fatura_w;

	select	substr(ds_conteudo_p, 13, 3),
		substr(ds_conteudo_p, 16, 13),
		substr(ds_conteudo_p, 33, 3),
		substr(ds_conteudo_p, 36, 6),
		substr(ds_conteudo_p, 42, 2),
		trim(both substr(ds_conteudo_p, 44, 25)),
		substr(ds_conteudo_p, 149, 10)
	into STRICT	cd_unimed_w,
		cd_carteira_benef_w,
		cd_filial_w,
		cd_familia_w,
		cd_dependencia_w,
		nm_beneficiario_w,
		cd_empresa_origem_w
	;

	if ((nr_versao_transacao_w)::numeric  >= 5) then -- Versão PTU 5.0
		cd_plano_intercambio_w	:= substr(ds_conteudo_p, 159, 3);
	else
		cd_plano_intercambio_w	:= substr(ds_conteudo_p, 77, 2);
	end if;

	dt_nascimento_w	:= substr(ds_conteudo_p, 75, 2) || substr(ds_conteudo_p, 73, 2) || substr(ds_conteudo_p, 69, 4);

	if (dt_nascimento_w <> '        ') then
		dt_nascimento_ww	:= to_Date(dt_nascimento_w,'dd/mm/yyyy');
	end if;

	vl_mens_original_w	:= (substr(ds_conteudo_p, 79, 12) || ',' || substr(ds_conteudo_p, 91, 2))::numeric;
	vl_insc_original_w	:= (substr(ds_conteudo_p, 93, 12))::numeric  || ',' || substr(ds_conteudo_p, 105, 2);
	vl_mens_cobranca_w	:= (substr(ds_conteudo_p, 107, 12) || ',' || substr(ds_conteudo_p, 119, 2))::numeric;
	vl_insc_cobranca_w	:= (substr(ds_conteudo_p, 121, 12) || ',' || substr(ds_conteudo_p, 133, 2))::numeric;
	vl_ajuste_w		:= (coalesce(substr(ds_conteudo_p, 135, 12),'0') || ',' || coalesce(substr(ds_conteudo_p, 147, 2),'0'))::numeric;

	begin
	select	max(a.nr_sequencia)
	into STRICT	nr_seq_plano_w
	from	pls_plano	a
	where	a.cd_plano_intercambio	= cd_plano_intercambio_w;
	exception
	when others then
		nr_seq_plano_w	:= null;
	end;

	insert into ptu_fatura_pre_cobranca(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		tp_registro,
		cd_unimed,
		id_beneficiario,
		cd_filial,
		cd_familia,
		cd_dependencia,
		nm_beneficiario,
		dt_nascimento,
		cd_plano_intercambio,
		vl_mensalidade_original,
		vl_inscricao_original,
		vl_mensalidade_cobrado,
		vl_inscricao_cobrado,
		vl_ajuste_cobrado,
		cd_empresa_origem,
		nr_seq_fatura,
		nr_seq_geracao,
		nr_seq_plano)
	values (nextval('ptu_fatura_pre_cobranca_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_tipo_registro_w,
		cd_unimed_w,
		cd_carteira_benef_w,
		cd_filial_w,
		cd_familia_w,
		cd_dependencia_w,
		nm_beneficiario_w,
		dt_nascimento_ww,
		cd_plano_intercambio_w,
		vl_mens_original_w,
		vl_insc_original_w,
		vl_mens_cobranca_w,
		vl_insc_cobranca_w,
		vl_ajuste_w,
		cd_empresa_origem_w,
		nr_seq_fatura_w,
		0,
		nr_seq_plano_w);
elsif (cd_tipo_registro_w	= '809') then
	select	CASE WHEN substr(ds_conteudo_p, 12, 5)=0 THEN  ''  ELSE substr(ds_conteudo_p, 12, 5) END
	into STRICT	qt_total_R802_w
	;

	vl_tot_mens_original_w	:= (substr(ds_conteudo_p, 17, 12)||','||substr(ds_conteudo_p, 29, 2))::numeric;
	vl_tot_insc_original_w	:= (substr(ds_conteudo_p, 31, 12)||','||substr(ds_conteudo_p, 43, 2))::numeric;
	vl_tot_mens_w		:= (substr(ds_conteudo_p, 45, 12)||','||substr(ds_conteudo_p, 57, 2))::numeric;
	vl_tot_insc_w		:= (substr(ds_conteudo_p, 59, 12)||','||substr(ds_conteudo_p, 71, 2))::numeric;
	vl_tot_ajustes_w	:= (substr(ds_conteudo_p, 73, 12)||','||substr(ds_conteudo_p, 85, 2))::numeric;

	select	max(nr_sequencia)
	into STRICT	nr_seq_fatura_w
	from	ptu_fatura_pre
	where	ie_envio_recebimento	= 'R';

	insert into ptu_fatura_pre_total(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		tp_registro,
		qt_total_r802,
		vl_tot_mens_original,
		vl_tot_insc_original,
		vl_total_mensalidade,
		vl_total_inscricao,
		vl_total_ajuste,
		nr_seq_fatura,
		nr_seq_geracao	)
	values (nextval('ptu_fatura_pre_total_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_tipo_registro_w,
		qt_total_R802_w,
		vl_tot_mens_original_w,
		vl_tot_insc_original_w,
		vl_tot_mens_w,
		vl_tot_insc_w,
		vl_tot_ajustes_w,
		nr_seq_fatura_w,
		0);
elsif (cd_tipo_registro_w = '810') then
	select	max(nr_sequencia)
	into STRICT	nr_seq_fatura_w
	from	ptu_fatura_pre
	where	ie_envio_recebimento	= 'R';

	select	max(nr_versao_transacao)
	into STRICT	nr_versao_trans_imp_w
	from	ptu_fatura_pre
	where	nr_sequencia	= nr_seq_fatura_w;

	ie_tipo_ced_sac_w	:= substr(ds_conteudo_p, 12, 1);
	cd_operadora_ans_w	:= trim(both substr(ds_conteudo_p, 13, 10));
	nm_cedente_sacado_w	:= trim(both substr(ds_conteudo_p, 23, 60));
	ds_endereco_w		:= trim(both substr(ds_conteudo_p, 83, 40));
	ds_endereco_compl_w	:= trim(both substr(ds_conteudo_p, 123, 20));
	ds_bairro_w		:= trim(both substr(ds_conteudo_p, 143, 30));
	nr_cep_w		:= substr(ds_conteudo_p, 173, 8);
	ds_cidade_w		:= trim(both substr(ds_conteudo_p, 181, 30));
	sg_uf_w			:= substr(ds_conteudo_p, 211, 2);
	cd_cnpj_cpf_w		:= substr(ds_conteudo_p, 214, 14);
	cd_inscricao_estadual_w	:= substr(ds_conteudo_p, 228, 20);
	nr_ddd_w		:= (substr(ds_conteudo_p, 248, 4))::numeric;

	if (nr_versao_trans_imp_w = 5) then
		nr_telefone_w		:= (substr(ds_conteudo_p, 268, 9))::numeric;
		nr_fax_w		:= (substr(ds_conteudo_p, 277, 9))::numeric;
		nr_endereco_w		:= substr(ds_conteudo_p, 286, 6);
	else
		nr_telefone_w		:= (substr(ds_conteudo_p, 252, 8))::numeric;
		nr_fax_w		:= (substr(ds_conteudo_p, 260, 8))::numeric;
		nr_endereco_w		:= null;
	end if;

	if (cd_operadora_ans_w <> '          ') then
		cd_operadora_ans_ww	:= (cd_operadora_ans_w)::numeric;
	end if;

	insert into ptu_fatura_pre_sacado(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_fatura,
		tp_registro,
		ie_cedente_sacado,
		cd_operadora_ans,
		nm_cedente_sacado,
		ds_endereco,
		ds_endereco_compl,
		ds_bairro,
		cd_cep,
		ds_cidade,
		sg_uf,
		cd_cnpj_cpf,
		cd_inscricao_estadual,
		nr_ddd,
		nr_telefone,
		nr_fax,
		nr_seq_geracao,
		nr_endereco)
	values (nextval('ptu_fatura_pre_sacado_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_fatura_w,
		cd_tipo_registro_w,
		ie_tipo_ced_sac_w,
		cd_operadora_ans_ww,
		nm_cedente_sacado_w,
		ds_endereco_w,
		ds_endereco_compl_w,
		ds_bairro_w,
		nr_cep_w,
		ds_cidade_w,
		sg_uf_w,
		cd_cnpj_cpf_w,
		cd_inscricao_estadual_w,
		nr_ddd_w,
		nr_telefone_w,
		nr_fax_w,
		0,
		nr_endereco_w);
elsif (cd_tipo_registro_w = '811') then
	select	substr(ds_conteudo_p, 12 ,2),
		trim(both substr(ds_conteudo_p, 14, 74))
	into STRICT	nr_linha_w,
		ds_linha_w
	;

	vl_item_w	:= (substr(ds_conteudo_p, 88, 12) || ',' || substr(ds_conteudo_p, 100, 2))::numeric;

	select	max(nr_sequencia)
	into STRICT	nr_seq_fatura_w
	from	ptu_fatura_pre
	where	ie_envio_recebimento	= 'R';

	insert into ptu_fatura_pre_corpo(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_fatura,
		tp_registro,
		nr_linha,
		ds_linha,
		vl_item,
		nr_seq_geracao)
	values (nextval('ptu_fatura_pre_corpo_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_fatura_w,
		cd_tipo_registro_w,
		nr_linha_w,
		ds_linha_w,
		vl_item_w,
		0);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_imp_fatura_intercambio ( ds_conteudo_p text, nm_arquivo_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

