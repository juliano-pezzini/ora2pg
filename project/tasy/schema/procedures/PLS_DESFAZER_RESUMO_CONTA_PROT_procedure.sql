-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_desfazer_resumo_conta_prot ( nr_seq_protocolo_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_contas_w			bigint	:= 0;
ie_status_prov_pagto_w		pls_parametro_contabil.ie_status_prov_pagto%type;
nr_lote_contabilizado_w		pls_conta_medica_resumo.nr_lote_contabil_prov%type;
cd_estabelecimento_w		pls_protocolo_conta.cd_estabelecimento%type;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_conta
	where	nr_seq_protocolo = nr_seq_protocolo_p;
BEGIN

select 	max(cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	pls_protocolo_conta
where 	nr_sequencia	= nr_seq_protocolo_p;

select	coalesce(ie_status_prov_pagto,'NC')
into STRICT	ie_status_prov_pagto_w
from	pls_parametro_contabil
where	cd_estabelecimento	= cd_estabelecimento_w;

for r_c01_w in C01() loop
	begin
	if (ie_status_prov_pagto_w = 'F') then
		select	max(coalesce(nr_lote_contabil_prov,0)) nr_lote_contabil
		into STRICT	nr_lote_contabilizado_w
		from	pls_conta_medica_resumo
		where	nr_seq_conta = r_c01_w.nr_sequencia
		and	coalesce(nr_lote_contabil_prov,0) <> 0;

		if (coalesce(nr_lote_contabilizado_w, 0) > 0) then
			/* A conta já foi contabilizada no lote #@NR_LOTE_CONTABILIZADO#@. */

			CALL wheb_mensagem_pck.exibir_mensagem_abort(324839, 'NR_LOTE_CONTABILIZADO=' || nr_lote_contabilizado_w);
		end if;
	end if;
	end;
end loop;

select	count(1)
into STRICT	qt_contas_w
from	pls_lote_protocolo	b,
	pls_prot_conta_titulo	a
where	a.nr_seq_lote		= b.nr_sequencia
and	a.nr_seq_protocolo	= nr_seq_protocolo_p
and	b.ie_status		= 'D';

if (qt_contas_w	> 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort( 267012, null); /* Existem resumos vinculados a um lote fechado, a operação não será concluída. */
end if;

update	pls_conta
set	nr_seq_prot_conta	 = NULL
where	nr_seq_protocolo	= nr_seq_protocolo_p;

delete	from pls_prot_conta_titulo
where	nr_seq_protocolo = nr_seq_protocolo_p;
--Desfeito demonstrativo do protocolo
CALL pls_inclui_prot_conta_hist(nr_seq_protocolo_p, wheb_mensagem_pck.get_texto(315920), nm_usuario_p, '15');

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_desfazer_resumo_conta_prot ( nr_seq_protocolo_p bigint, nm_usuario_p text) FROM PUBLIC;

