-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_prescricao_rep (( nr_atendimento_p atendimento_paciente.nr_atendimento%type, dt_referencia_p timestamp, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type, nm_usuario_p usuario.nm_usuario%type, itens_liberar_p text, nr_prescricao_out_p out prescr_medica.nr_prescricao%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type default null, ie_copia_diaria_p char default 'N', ie_interv_farmacia_p text default 'N', ie_prescricao_alta_p text default 'N', nr_seq_transcricao_p bigint default null, ie_motivo_prescr_p text default null, cd_medico_p prescr_medica.cd_medico%type default null, cd_prescritor_p prescr_medica.cd_prescritor%type default null, ie_prescr_emergencia_p text default 'N', nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, nr_seq_consulta_oft_p bigint default null, nr_seq_pend_pac_acao_p bigint default null, ie_copia_sem_lib_enf_farm_p text default 'N', ie_adep_p text default 'S', nm_usuario_lib_enf_p cpoe_material.nm_usuario_lib_enf%type default null, cd_farmac_lib_p cpoe_material.cd_farmac_lib%type default null, ie_disp_semanal_p text default 'N', nr_seq_atend_futuro_p bigint default null) is nr_prescricoes_w prescr_medica.nr_prescricoes%type) AS $body$
DECLARE

		nr_prescr_w varchar(255);
	
BEGIN
	
		if (ds_lista_prescr_salvas_p IS NOT NULL AND ds_lista_prescr_salvas_p::text <> '') then
			nr_prescr_w := ds_lista_prescr_salvas_p;			
			begin			
				
				for i in 1..length(nr_prescr_w) loop
					if (substr(nr_prescr_w, 1, position(';' in nr_prescr_w) - 1) = coalesce(ds_number_comp_p,0)) then
						return;
					end if;							
					nr_prescr_w := substr(nr_prescr_w, position(';' in nr_prescr_w ) + 1, length(nr_prescr_w));
				end loop;
			
				exception when others then					
					CALL gravar_log_cpoe(substr('GET_IE_PRESC_NAO_DUPLICADO EXCEPTION:' || substr(to_char(sqlerrm),1,2000)
							|| obter_desc_expressao(712423) || '// ds_lista_prescr_salvas_p: '   || ds_lista_prescr_salvas_p
							||' ds_number_comp_p: ' || ds_number_comp_p,1,2000),
							nr_atendimento_p);
				end;
			return;
		end if;		
		return;
	end;	
	
begin

if (cd_perfil_p 	> 0) then
	cd_perfil_w	:= cd_perfil_p;
end if;

dt_inicio_prescr_w := dt_referencia_p;

CALL wheb_usuario_pck.set_informacoes_usuario(2314,cd_perfil_w,cd_estabelecimento_p,cd_setor_atendimento_p,nm_usuario_p,0,'AtePac_OE');
CALL wheb_assist_pck.set_informacoes_usuario(2314,cd_perfil_w,cd_estabelecimento_p,cd_setor_atendimento_p,nm_usuario_p,0,'AtePac_OE');
nr_horas_prox_geracao_w	:= get_qt_hours_after_copy_cpoe(cd_perfil_w, nm_usuario_p, cd_estabelecimento_p);
ie_setor_entrega_w := Obter_Param_Usuario(924, 167, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_setor_entrega_w);

select 	max(a.cd_pessoa_fisica),
		max(a.ie_tipo_evolucao),
		max(a.cd_setor_atendimento)
into STRICT	cd_pf_usuario_w,
		ie_tipo_evol_w,
		cd_setor_usuario_w
from	usuario a
where	a.nm_usuario = nm_usuario_p;

cd_medico_ww := cd_medico_p;
ie_usuario_medico_w := 'N';
if (cd_pf_usuario_w IS NOT NULL AND cd_pf_usuario_w::text <> '') then
	select	coalesce(max('1'),'3'),
			max(cd_pessoa_fisica)
	into STRICT	ie_origem_inf_w,
			cd_medico_w
	from	medico
	where	cd_pessoa_fisica	= cd_pf_usuario_w
	and	coalesce(ie_situacao,'A') = 'A';
	
	if (coalesce(ie_copia_diaria_p,'N') = 'S') then
		cd_medico_ww := cd_medico_w;
	end if;	
	
	if (ie_origem_inf_w = '1') then
		ie_usuario_medico_w := 'S';
	end if;
else
	ie_origem_inf_w	:= '3';
end if;	

cd_setor_prescr_w := cd_setor_atendimento_p;
cd_estabelecimento_presc_w := cd_estabelecimento_p;

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
	select	max(cd_pessoa_fisica),
		max(cd_medico_resp)
	into STRICT	cd_pessoa_fisica_w,
		cd_medico_prescri_w
	from	atendimento_paciente
	where	nr_atendimento = nr_atendimento_p;

	ie_parametro42_w := obter_param_usuario(924, 42, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_parametro42_w);
	ie_lib_sem_interv_w := obter_param_usuario(924, 11, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_lib_sem_interv_w);

	if (ie_parametro42_w in ('P','A') and ie_copia_diaria_p = 'S') then
		cd_setor_prescr_w:= cpoe_obter_setor_atend_prescr(nr_atendimento_p,cd_estabelecimento_p,cd_perfil_w,nm_usuario_p);
	else
		cd_setor_prescr_w := coalesce(cd_setor_atendimento_p,cpoe_obter_setor_atend_prescr(nr_atendimento_p,cd_estabelecimento_p,cd_perfil_w,nm_usuario_p));
	end if;

	cd_estabelecimento_presc_w := obter_estabelecimento_setor(cd_setor_prescr_w);

	cd_convenio_w	:= obter_convenio_atendimento(nr_atendimento_p);
	qt_altura_cm_w		:= obter_sinal_vital(nr_atendimento_p, 'ALTURA');
	qt_peso_w		:= obter_sinal_vital(nr_atendimento_p, 'PESO');
else
	cd_pessoa_fisica_w	:= cd_pessoa_fisica_p;
	qt_altura_cm_w		:= obter_qt_altura_pf(cd_pessoa_fisica_w);
	qt_peso_w		:= obter_peso_pf(cd_pessoa_fisica_w);
end if;

if (ie_setor_entrega_w = 'S') then
	cd_setor_entrega_w := obter_setor_usuario(nm_usuario_p);
elsif (ie_setor_entrega_w = 'P') and (cd_setor_prescr_w IS NOT NULL AND cd_setor_prescr_w::text <> '') then
	cd_setor_entrega_w := cd_setor_prescr_w;
end if;

if (ie_copia_diaria_p = 'S') then

	if (nm_usuario_lib_enf_p IS NOT NULL AND nm_usuario_lib_enf_p::text <> '') then
		ie_liberou_enf_w := 'S';
	end if;

	if (cd_farmac_lib_p IS NOT NULL AND cd_farmac_lib_p::text <> '') then
		ie_liberou_far_w := 'S';
	end if;
		
	if (ie_liberou_enf_w = 'S' or ie_liberou_far_w = 'S') then
		SELECT * FROM cpoe_obter_inf_copia_prescr(nr_atendimento_p, itens_liberar_p, ie_liberou_enf_w, ie_liberou_far_w, cd_perfil_enf_w, cd_perfil_farm_w, cd_funcao_ativa_enf_w, cd_funcao_ativa_farm_w, nr_prescricoes_w) INTO STRICT cd_perfil_enf_w, cd_perfil_farm_w, cd_funcao_ativa_enf_w, cd_funcao_ativa_farm_w, nr_prescricoes_w;
	else
		nr_prescricoes_w := null;
	end if;

	if (coalesce(nm_usuario_lib_enf_p::text, '') = '') then
		ie_liberou_enf_w := 'N';
		cd_perfil_enf_w := null;
		cd_funcao_ativa_enf_w := null;
	end if;

	if (coalesce(cd_farmac_lib_p::text, '') = '') then
		ie_liberou_far_w := 'N';
		cd_perfil_farm_w := null;
		cd_funcao_ativa_farm_w := null;
	end if;
end if;

if (ie_copia_diaria_p = 'S' and ie_copia_sem_lib_enf_farm_p = 'S') then
	qt_hors_before_w := get_qt_hours_before_copy(cd_perfil_p, nm_usuario_p, cd_estabelecimento_p);
	dt_inicio_prescr_w := dt_inicio_prescr_w - qt_hors_before_w/24;
end if;

select	nextval('prescr_medica_seq')
into STRICT	nr_prescricao_w
;

if (ie_prescricao_alta_p = 'S') then
  ds_locale_user_w := pkg_i18n.get_user_locale;
  if (ds_locale_user_w = 'ja_JP') then
    ie_param_46_w := obter_param_usuario(2314, 46, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_param_46_w);
    if (ie_param_46_w = 'S') then
      ie_adep_w := 'N';
    end if;
  end if;
end if;

begin
	insert into	prescr_medica(
				nr_prescricao,
				nr_atendimento,
				cd_pessoa_fisica,
				cd_medico,
				cd_prescritor,
				dt_prescricao,
				dt_atualizacao,
				nm_usuario,
				nm_usuario_original,
				cd_estabelecimento,
				cd_setor_atendimento,
				ie_origem_inf,
				ie_adep,
				ie_emergencia,
				ie_recem_nato,
				ie_prescricao_alta,
				ie_prescr_emergencia,
				ie_prescr_farm,
				ie_ajusta_validade_atend,
				ie_prescritor_aux,
				ie_paciente_dialise,
				ie_funcao_prescritor,
				qt_altura_cm,
				qt_peso,
				dt_inicio_prescr,
				dt_primeiro_horario,
				nr_horas_validade,
				cd_funcao_origem,
				cd_perfil_ativo,
				ds_observacao_copia,
				nr_prescricoes, 
				nr_seq_transcricao,
				ie_motivo_prescricao,
				nr_seq_pepo,
				nr_cirurgia,
				nr_cirurgia_patologia,
				nr_seq_agenda,
				ie_tipo_prescr_cirur,
				nr_seq_pend_pac_acao,
				cd_setor_entrega,
				nr_seq_atend_futuro) 
			values (
				nr_prescricao_w,
				nr_atendimento_p,
				cd_pessoa_fisica_w,
				coalesce(cd_medico_ww, cd_medico_prescri_w),
				coalesce(cd_prescritor_p, cd_pf_usuario_w),
				dt_inicio_prescr_w,
				clock_timestamp(),
				nm_usuario_p,
				nm_usuario_p,
				cd_estabelecimento_presc_w,
				cd_setor_prescr_w,
				ie_origem_inf_w,
				ie_adep_w,
				'N',
				'N',
				ie_prescricao_alta_p,
				ie_prescr_emergencia_p,
				ie_interv_farmacia_p,
				'N',
				'N',
				'N',
				ie_tipo_evol_w,
				qt_altura_cm_w,
				qt_peso_w,
				dt_inicio_prescr_w,
				dt_inicio_prescr_w,
				24,
				2314,
				cd_perfil_w,
				itens_liberar_p,
				nr_prescricoes_w,
				nr_seq_transcricao_p,
				ie_motivo_prescr_p,
				nr_seq_pepo_p,
				nr_cirurgia_p,
				nr_cirurgia_patologia_p,
				nr_seq_agenda_p,
				CASE WHEN coalesce(nr_seq_pepo_p::text, '') = '' THEN  null  ELSE 2 END ,
				nr_seq_pend_pac_acao_p,
				cd_setor_entrega_w,
				nr_seq_atend_futuro_p);

	commit;
	
exception when others then	
	CALL gravar_log_cpoe(substr('CPOE_GERAR_PRESCRICAO_REP EXCEPTION INSERT:' || substr(to_char(sqlerrm),1,2000)
			||'//nr_prescricao_w:' || nr_prescricao_w
		   ||' itens_liberar_p : '  	  || itens_liberar_p	
		   ||' nr_atendimento_p : '  	  || nr_atendimento_p	
		   ||' cd_pessoa_fisica_w : '  	  || cd_pessoa_fisica_w	
		   ||' cd_medico_prescri_w : '    || cd_medico_prescri_w	
		   ||' cd_pf_usuario_w : '  	  || cd_pf_usuario_w	
		   ||' dt_inicio_prescr_w : '  	  || to_char(dt_inicio_prescr_w,'dd/mm/yyyy hh24:mi:ss')	
		   ||' nm_usuario_p : '  	  	  || nm_usuario_p	
		   ||' cd_estabelecimento_p : '   || cd_estabelecimento_p
		   ||' cd_estabelecimento_presc_w : '   || cd_estabelecimento_presc_w
		   ||' cd_setor_prescr_w : '  	  || cd_setor_prescr_w	
		   ||' ie_origem_inf_w : '  	  || ie_origem_inf_w	
		   ||' ie_tipo_evol_w : '  	 	  || ie_tipo_evol_w	
		   ||' qt_altura_cm_w : '  	  	  || qt_altura_cm_w	
		   ||' qt_peso_w : '  	  		  || qt_peso_w	
		   ||' dt_inicio_prescr_w : '  	  || to_char(dt_inicio_prescr_w,'dd/mm/yyyy hh24:mi:ss')	
		   ||' cd_perfil_w : '  	  	  || cd_perfil_w	
		   ||'itens_liberar_p : '		  || itens_liberar_p 
		   ||' nr_prescricoes_w : '	   || nr_prescricoes_w,1,2000),
			nr_atendimento_p);
end;	

if (itens_liberar_p IS NOT NULL AND itens_liberar_p::text <> '') and (coalesce(nr_prescricao_w,0) > 0) then
	nr_prescricao_out_p := cpoe_gerar_itens_prescricao(nr_atendimento_p, nr_prescricao_w, dt_referencia_p, cd_estabelecimento_presc_w, cd_perfil_p, cd_setor_atendimento_p, nm_usuario_p, itens_liberar_p, cd_pessoa_fisica_p, ie_interv_farmacia_p, ie_copia_diaria_p, nr_prescricao_out_p, ie_copia_sem_lib_enf_farm_p, ie_disp_semanal_p);	
end if;
	
if (coalesce(nr_seq_consulta_oft_p,0) > 0) and (coalesce(nr_prescricao_w,0) > 0) then
		CALL vincular_oftalmo_prescricao(nr_prescricao_w,nr_seq_consulta_oft_p,nm_usuario_p);
end if;
	
if (ie_copia_diaria_p = 'S') then

	if (obter_se_prescr_vazia(nr_prescricao_w) = 'N') then
		select 	max(dt_liberacao_medico),
			max(dt_liberacao),
			max(dt_liberacao_farmacia)
		into STRICT 	dt_liberacao_medico_w,
			dt_liberacao_enf_w,
			dt_liberacao_farmacia_w
		from	prescr_medica
		where	nr_prescricao = nr_prescricao_w;
		
		CALL gravar_log_cpoe(substr('CPOE_GERAR_PRESCRICAO_REP LOG BEFORE LIBERAR_PRESCRICAO 1:'
				|| '//nr_prescricao_w : ' || nr_prescricao_w	
				|| ' nr_atendimento_p: '|| nr_atendimento_p
				|| ' itens_liberar_p: ' || itens_liberar_p
				|| ' dt_liberacao_medico_w: ' || to_char(dt_liberacao_medico_w, 'dd/mm/yyyy hh24:mi:ss')
				|| ' ie_liberou_enf_w: ' || ie_liberou_enf_w
				|| ' ie_liberou_far_w: ' || ie_liberou_far_w
				|| ' dt_liberacao_enf_w: ' || to_char(dt_liberacao_enf_w, 'dd/mm/yyyy hh24:mi:ss')
				|| ' dt_liberacao_farmacia_w: ' || to_char(dt_liberacao_farmacia_w, 'dd/mm/yyyy hh24:mi:ss')
				|| ' ie_lib_sem_interv_w: ' || ie_lib_sem_interv_w
				|| ' cd_setor_prescr_w: ' || cd_setor_prescr_w,1,2000),
				nr_atendimento_p);
		begin

			if (ie_lib_sem_interv_w = 'D') then
			  ie_lib_sem_interv_w := Obter_se_medico_lib_tudo(nr_prescricao_w, cd_setor_prescr_w);
			end if;
			
			CALL gravar_log_cpoe(substr('CPOE_GERAR_PRESCRICAO_REP LOG BEFORE LIBERAR_PRESCRICAO 2:'
				|| '//nr_prescricao_w : ' || nr_prescricao_w	
				|| ' nr_atendimento_p: '|| nr_atendimento_p
				|| ' ie_lib_sem_interv_w: ' || ie_lib_sem_interv_w,1,2000),
				nr_atendimento_p);
			
			if ((coalesce(dt_liberacao_medico_w::text, '') = '')  and ((ie_usuario_medico_w = 'S') or (ie_lib_sem_interv_w = 'S')))  then
			
				if (ie_liberou_enf_w = 'N' or ie_lib_sem_interv_w = 'S') and (ie_liberou_far_w = 'N') then
					ds_erro_w := Liberar_prescricao(nr_prescricao_w, nr_atendimento_p, ie_usuario_medico_w, cd_perfil_w, nm_usuario_p, 'S', ds_erro_w, 'S');
				else
					ds_erro_w := Liberar_prescricao(nr_prescricao_w, nr_atendimento_p, ie_usuario_medico_w, cd_perfil_w, nm_usuario_p, 'S', ds_erro_w, 'N');
				end if;
			
			end if;
		exception when others then
			CALL gravar_log_cpoe(substr('CPOE_GERAR_PRESCRICAO_REP EXCEPTION LIBERAR_PRESCRICAO MEDICO:'|| substr(to_char(sqlerrm),1,2000)
						||'//nr_prescricao_w : ' || nr_prescricao_w	
						||'nr_atendimento_p: '|| nr_atendimento_p
						||'ds_erro_w: '|| ds_erro_w
						||'ie_usuario_medico_w: ' || ie_usuario_medico_w
						||'cd_perfil_p: ' || cd_perfil_w 	
						||'nm_usuario_p : ' || nm_usuario_p,1,2000), 
						nr_atendimento_p);
		end;	
			
		begin	
			if (coalesce(dt_liberacao_enf_w::text, '') = '') and (ie_liberou_enf_w <> 'N') then
				
				if (cd_funcao_ativa_enf_w = 7015) then
				  CALL wheb_usuario_pck.set_informacoes_usuario(7015,cd_perfil_enf_w,cd_estabelecimento_presc_w,cd_setor_atendimento_p,nm_usuario_p,0,'AtePac_GN');
				  CALL wheb_assist_pck.set_informacoes_usuario(7015,cd_perfil_enf_w,cd_estabelecimento_presc_w,cd_setor_atendimento_p,nm_usuario_p,0,'AtePac_GN');
				elsif (cd_funcao_ativa_enf_w = 252) then
				  CALL wheb_usuario_pck.set_informacoes_usuario(252,cd_perfil_enf_w,cd_estabelecimento_presc_w,cd_setor_atendimento_p,nm_usuario_p,0,'AtePac_T2');
				  CALL wheb_assist_pck.set_informacoes_usuario(252,cd_perfil_enf_w,cd_estabelecimento_presc_w,cd_setor_atendimento_p,nm_usuario_p,0,'AtePac_T2');
				end if;

				if (ie_liberou_far_w = 'S') then
					ds_erro_w := Liberar_prescricao(nr_prescricao_w, nr_atendimento_p, 'N', cd_perfil_w, coalesce(nm_usuario_lib_enf_p, nm_usuario_p), 'N', ds_erro_w, 'N');
				else
					ds_erro_w := Liberar_prescricao(nr_prescricao_w, nr_atendimento_p, 'N', cd_perfil_w, coalesce(nm_usuario_lib_enf_p, nm_usuario_p), 'N', ds_erro_w, 'S');
				end if;
				
			end if;
		exception when others then
			CALL gravar_log_cpoe(substr('CPOE_GERAR_PRESCRICAO_REP EXCEPTION LIBERAR_PRESCRICAO ENF:'|| substr(to_char(sqlerrm),1,2000)
						||'//nr_prescricao_w : '|| nr_prescricao_w	
						||'nr_atendimento_p:'|| nr_atendimento_p
						||'ds_erro_w:' || ds_erro_w
						||'nm_usuario_lib_enf_p:'|| nm_usuario_lib_enf_p
						||'cd_perfil_p: ' || cd_perfil_w,1,2000), 
						nr_atendimento_p);
		end;
		
		begin
			

			if (coalesce(dt_liberacao_farmacia_w::text, '') = '') and (ie_liberou_far_w <> 'N') then
				
				select	max(nm_usuario)
				into STRICT	nm_usuario_lib_farm_w
				from	usuario
				where	cd_pessoa_fisica = cd_farmac_lib_p;

				if (cd_funcao_ativa_farm_w = 7010) then
				  CALL wheb_usuario_pck.set_informacoes_usuario(7010,cd_perfil_farm_w,cd_estabelecimento_presc_w,cd_setor_atendimento_p,nm_usuario_p,0,'AtePac_GF');
				  CALL wheb_assist_pck.set_informacoes_usuario(7010,cd_perfil_farm_w,cd_estabelecimento_presc_w,cd_setor_atendimento_p,nm_usuario_p,0,'AtePac_GF');
				elsif (cd_funcao_ativa_farm_w = 252) then
				  CALL wheb_usuario_pck.set_informacoes_usuario(252,cd_perfil_farm_w,cd_estabelecimento_presc_w,cd_setor_atendimento_p,nm_usuario_p,0,'AtePac_T2');
				  CALL wheb_assist_pck.set_informacoes_usuario(252,cd_perfil_farm_w,cd_estabelecimento_presc_w,cd_setor_atendimento_p,nm_usuario_p,0,'AtePac_T2');
				end if;
				CALL Liberar_prescricao_farmacia(nr_prescricao_w, 0, coalesce(nm_usuario_lib_farm_w,nm_usuario_p) ,'N', ie_copia_diaria_p);
			end if;
			
			select 	max(dt_liberacao_medico),
			max(dt_liberacao),
			max(dt_liberacao_farmacia)
			into STRICT 	dt_liberacao_medico_w,
				dt_liberacao_enf_w,
				dt_liberacao_farmacia_w
			from	prescr_medica
			where	nr_prescricao = nr_prescricao_w;		
			
			
			select count(*)
			into STRICT qt_prescr_w
			from PRESCR_MEDICA_COMPL
			where NR_PRESCRICAO = nr_prescricao_w;		
			
			
			if (qt_prescr_w > 0)then
				update PRESCR_MEDICA_COMPL set
				DT_ATUALIZACAO = clock_timestamp(),
				NM_USUARIO = nm_usuario_p,
				IE_LIBERACAO_CPOE = 'S'
				where NR_PRESCRICAO = nr_prescricao_w;					
			else
				insert into PRESCR_MEDICA_COMPL(
					NR_PRESCRICAO,
					DT_ATUALIZACAO, 
					NM_USUARIO, 
					DT_ATUALIZACAO_NREC, 
					NM_USUARIO_NREC, 
					IE_LIBERACAO_CPOE
				)
				values (
					nr_prescricao_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					'S'
				);
			end if;
			commit;
			
		exception when others then
			CALL gravar_log_cpoe(substr('CPOE_GERAR_PRESCRICAO_REP EXCEPTION LIBERAR_PRESCRICAO FARM:'|| substr(to_char(sqlerrm),1,2000)
					||'//nr_prescricao_w : '    	 || nr_prescricao_w	
					||'nr_atendimento_p:'	 || nr_atendimento_p
					|| obter_desc_expressao(345973) || coalesce(nm_usuario_lib_farm_w,nm_usuario_p),1,2000), 
					nr_atendimento_p);
		end;

		begin		
			CALL cpoe_gerar_data_copia_item( nr_prescricao_w, nr_horas_prox_geracao_w, dt_inicio_prescr_w );
		exception when others then
			CALL gravar_log_cpoe(substr('CPOE_GERAR_PRESCRICAO_REP EXCEPTION CPOE_GERAR_DATA_COPIA_ITEM:'|| substr(to_char(sqlerrm),1,2000)
					||'//nr_prescricao_w : ' || nr_prescricao_w	
					||'nr_atendimento_p:' || to_char(dt_inicio_prescr_w,'dd/mm/yyyy hh24:mi:ss'),1,2000),
					nr_atendimento_p);
		end;
	else
		
		delete	FROM prescr_medica
		where  nr_prescricao = nr_prescricao_w;	
		commit;	
	end if;
	
end if;

select	coalesce(max('S'), 'N')
		into STRICT	ie_gqa_pend_regra_w
		from	gqa_pendencia_regra a
		where	a.ie_evento = '7'
		and		a.ie_situacao = 'A';

if (ie_gqa_pend_regra_w = 'S' and obter_se_prescr_vazia(nr_prescricao_w) = 'N') then
		
	for r_c02_w in c02
	loop
		$if dbms_db_version.version >= 11 $then
		   CALL gqa_gerar_protocolo_assist(
			ie_evento_p			 => '7', 
			nm_usuario_p		 => nm_usuario_p,
			nr_atendimento_p	 => r_c02_w.nr_atendimento,					
			nr_prescricao_p		 => r_c02_w.nr_prescricao,
			cd_material_p        => r_c02_w.cd_material,
			cd_protocolo_p       => r_c02_w.cd_protocolo,
			nr_seq_protocolo_p   => r_c02_w.nr_seq_protocolo,
			cd_classe_material_p => r_c02_w.cd_classe_material,
			nr_seq_familia_p     => r_c02_w.nr_seq_familia);				
		$else
		   CALL gqa_gerar_protocolo_assist(
			r_c02_w.nr_atendimento,	
			'7',
			nm_usuario_p,
			r_c02_w.cd_protocolo,
			r_c02_w.nr_seq_protocolo,
			r_c02_w.nr_prescricao,
			r_c02_w.cd_material,
			r_c02_w.cd_classe_material,
			r_c02_w.nr_seq_familia);
		$end

	end loop;
	
end if;


select
  coalesce(max(a.cd_protocolo), 0),
  coalesce(max(a.nr_seq_protocolo), 0)
into STRICT
  cd_protocolo_w,
  nr_seq_protocolo_w
from
  prescr_medica a
where	a.nr_prescricao = nr_prescricao_w;

if (cd_protocolo_w != 0 and nr_seq_protocolo_w != 0) then
  select  coalesce(max(NR_SEQ_INTERNA), 0)
  into STRICT  nr_seq_interno_w
  from  PROTOCOLO_MEDICACAO
  where cd_protocolo = cd_protocolo_w
    and nr_sequencia = nr_seq_protocolo_w;
end if;

CALL ATUALIZAR_EV_LINHA_CUIDADO('CP', 'PRESCR_MEDICA', nr_prescricao_w,
  'cd_protocolo_w='||cd_protocolo_w||';nr_seq_protocolo_w='||nr_seq_interno_w||';', cd_pessoa_fisica_p, nm_usuario_p);

select	coalesce(max(ie_agrupar_lote_copia),'N')
into STRICT	ie_agrupar_lote_copia_w
from	parametros_farmacia
where 	cd_estabelecimento = cd_estabelecimento_presc_w;

if (ie_copia_diaria_p = 'S') and (ie_agrupar_lote_copia_w = 'S') then
	select	coalesce(max(cd_pessoa_fisica),'0')
	into STRICT	cd_pf_prescr_w
	from	prescr_medica
	where 	nr_prescricao = nr_prescricao_w;
	
	if (cd_pf_prescr_w <> '0') then
		begin
		insert into ap_lote_agrupamento(nr_sequencia,
				cd_estabelecimento,
				nr_prescricao,
				dt_atualizacao,
				nm_usuario,
				dt_referencia,
				nr_atendimento,
				cd_perfil,
				dt_leitura,
				cd_pessoa_fisica)
			values (nextval('ap_lote_agrupamento_seq'),
				cd_estabelecimento_presc_w,
				nr_prescricao_w,
				clock_timestamp(),
				nm_usuario_p,
				null,
				nr_atendimento_p,
				cd_perfil_p,
				null,
				coalesce(cd_pessoa_fisica_p,cd_pf_prescr_w));
				
		exception
		when others then
			CALL gravar_log_lote_agrup(nr_atendimento_p,nr_prescricao_w,null,'Erro=' || SQLERRM(SQLSTATE) || DBMS_UTILITY.FORMAT_ERROR_BACKTRACE,nm_usuario_p);
		end;
	end if;
end if;

exception when others then
	ds_erro_w	:= substr(to_char(sqlerrm),1,2000);
	
	CALL gravar_log_cpoe(substr('CPOE_GERAR_PRESCRICAO_REP EXCEPTION CPOE_GERAR_DATA_COPIA_ITEM:' || ds_erro_w
				|| obter_desc_expressao(712423)||': nr_atendimento_p:'	 || nr_atendimento_p
				||' dt_referencia_p : '  	  	 || to_char(dt_referencia_p, 'dd/mm/yyyy hh24:mi:ss')	
				||' cd_estabelecimento_p : '	  	 || cd_estabelecimento_p
				||' cd_perfil_p : '			 || cd_perfil_p
				||' cd_setor_atendimento_p :'  	 || cd_setor_atendimento_p 
				||' nm_usuario_p : '			 || nm_usuario_p
				||' itens_liberar_p : '		 || itens_liberar_p	
				||' cd_pessoa_fisica_p :'	  	 || cd_pessoa_fisica_p	
				||' ie_copia_diaria_p :'		 || ie_copia_diaria_p,1,2000), 
				nr_atendimento_p);

	open C01;
	loop
	fetch C01 into	
		nr_seq_evento_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		CALL gerar_evento_paciente_trigger(	nr_seq_evento_w	,
						nr_atendimento_p,
						cd_pessoa_fisica_w,
						null,
						nm_usuario_p,
						ds_erro_w);
		commit;
		end;
	end loop;
	close C01;	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_prescricao_rep (( nr_atendimento_p atendimento_paciente.nr_atendimento%type, dt_referencia_p timestamp, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type, nm_usuario_p usuario.nm_usuario%type, itens_liberar_p text, nr_prescricao_out_p out prescr_medica.nr_prescricao%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type default null, ie_copia_diaria_p char default 'N', ie_interv_farmacia_p text default 'N', ie_prescricao_alta_p text default 'N', nr_seq_transcricao_p bigint default null, ie_motivo_prescr_p text default null, cd_medico_p prescr_medica.cd_medico%type default null, cd_prescritor_p prescr_medica.cd_prescritor%type default null, ie_prescr_emergencia_p text default 'N', nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, nr_seq_consulta_oft_p bigint default null, nr_seq_pend_pac_acao_p bigint default null, ie_copia_sem_lib_enf_farm_p text default 'N', ie_adep_p text default 'S', nm_usuario_lib_enf_p cpoe_material.nm_usuario_lib_enf%type default null, cd_farmac_lib_p cpoe_material.cd_farmac_lib%type default null, ie_disp_semanal_p text default 'N', nr_seq_atend_futuro_p bigint default null) is nr_prescricoes_w prescr_medica.nr_prescricoes%type) FROM PUBLIC;

