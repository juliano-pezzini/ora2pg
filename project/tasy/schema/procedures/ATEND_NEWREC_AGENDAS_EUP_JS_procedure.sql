-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atend_newrec_agendas_eup_js ( ie_medico_req_agenda_p text, cd_pessoa_fisica_p text, ie_atua_medico_gr_p text, ie_data_ag_exames_entrada_p text, ie_data_ag_cirur_entrada_p text, ie_data_ag_serv_entrada_p text, ie_data_ag_cons_entrada_p text, ie_obs_agenda_p text, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_agenda_p bigint, cd_tipo_agenda_p bigint, ie_atualiza_med_referido_p text, ie_utiliza_prof_agenda_resp_p text, cd_medico_chamada_p text, cd_medico_referido_p INOUT text, ie_tipo_atendimento_p INOUT bigint, cd_cgc_indicacao_p INOUT text, cd_pessoa_indicacao_p INOUT text, nr_seq_classificacao_p INOUT bigint, ds_observacao_atend_p INOUT text, ie_tipo_atend_tiss_p INOUT text, dt_entrada_p INOUT timestamp, cd_medico_resp_p INOUT text) AS $body$
DECLARE

cd_medico_referido_w	varchar(10);
cd_medico_ref_age_w	varchar(10);
cd_medico_resp_w	varchar(10);
cd_medico_resp_reab_w	varchar(10);
cd_medico_resp_agenda_w	varchar(10);
ie_tipo_atendimento_w	smallint;
cd_pessoa_indicacao_w	varchar(10);
cd_cgc_indicacao_w	varchar(14);
nr_seq_classificacao_w	bigint;
ds_observacao_atend_w	varchar(255);
ie_tipo_atend_tiss_w	varchar(2);
dt_agenda_consulta_w	timestamp;
dt_agenda_serv_w	timestamp;
dt_agenda_cirurgica_w	varchar(20);
dt_prev_agenda_cirur_w	timestamp;
dt_entrada_w		timestamp := clock_timestamp();
dt_agenda_exame_w	varchar(20);
ie_reabilitacao_w	varchar(1);
ie_medico_agenda_w	varchar(30);
ie_situacao_med_cham_w	varchar(1);
ie_situacao_med_ref_w	varchar(1);

					 

BEGIN 
if (coalesce(nr_seq_agenda_p,0) > 0) and (coalesce(cd_tipo_agenda_p,0) > 0) then 
	 
	if (cd_tipo_agenda_p = 3) then --- AGENDA DE CONSULTA 
	 
		select	max(cd_medico_req), 
			max(cd_pessoa_indicacao), 
			max(cd_cgc_indicacao), 
			substr(max(ds_observacao),1,255), 
			max(dt_agenda) 
		into STRICT	cd_medico_ref_age_w, 
			cd_pessoa_indicacao_w, 
			cd_cgc_indicacao_w, 
			ds_observacao_atend_w, 
			dt_agenda_consulta_w			 
		from	agenda_consulta 
		where	nr_sequencia = nr_seq_agenda_p;
		 
		cd_medico_resp_agenda_w := cd_medico_ref_age_w;
		 
	end if;
	 
	if (cd_tipo_agenda_p = 4) then -- AGENDA DE Consultas serviço médico  
		 
		select	substr(max(ds_observacao),1,255) 
		into STRICT	ds_observacao_atend_w 
		from	agenda_consulta 
		where	nr_sequencia = nr_seq_agenda_p;
	end if;
	 
	if (cd_tipo_agenda_p = 5) then -- AGENDA DE Serviços 
		 
		select	max(cd_medico_solic), 
			max(cd_pessoa_indicacao), 
			max(cd_cgc_indicacao), 
			substr(max(ds_observacao),1,255), 
			max(dt_agenda) 
		into STRICT	cd_medico_ref_age_w, 
			cd_pessoa_indicacao_w, 
			cd_cgc_indicacao_w, 
			ds_observacao_atend_w, 
			dt_agenda_serv_w 
		from	agenda_consulta 
		where	nr_sequencia = nr_seq_agenda_p;
		 
		select	a.ie_reabilitacao 
		into STRICT	ie_reabilitacao_w 
		from 	agenda a 
		where 	a.cd_agenda = (SELECT	b.cd_agenda 
					from	agenda_consulta b 
					where	b.nr_sequencia = nr_seq_agenda_p);
					 
		if (ie_reabilitacao_w = 'S') then 
			 
			select	max(cd_medico_resp) 
			into STRICT	cd_medico_resp_reab_w 
			from	rp_paciente_reabilitacao 
			where	cd_pessoa_fisica = cd_pessoa_fisica_p;
		end if;
	 
	end if;
	 
	if (cd_tipo_agenda_p = 1) then -- Agenda cirurgica 
		select	max(cd_medico), 
			max(ie_tipo_atendimento), 
			substr(max(ds_observacao),1,255), 
			max(dt_chegada_prev), 
			max(to_char(dt_agenda,'dd/mm/yyyy') ||' ' || to_char(hr_inicio,'hh24:mi:ss')) 
		into STRICT	cd_medico_ref_age_w, 
			ie_tipo_atendimento_w, 
			ds_observacao_atend_w, 
			dt_prev_agenda_cirur_w, 
			dt_agenda_cirurgica_w 
		from	agenda_paciente 
		where	nr_sequencia = nr_seq_agenda_p;
	end if;
 
	if (cd_tipo_agenda_p = 2) then -- AGenda de exames 
	 
		ie_medico_agenda_w := obter_ref_atend_agenda_param(cd_estabelecimento_p);
		 
		select	max(cd_medico), 
			max(ie_tipo_atendimento), 
			substr(max(ds_observacao),1,255), 
			max(to_char(dt_agenda,'dd/mm/yyyy') ||' '|| to_char(hr_inicio,'hh24:mi:ss')) 
		into STRICT	cd_medico_ref_age_w, 
			ie_tipo_atendimento_w, 
			ds_observacao_atend_w, 
			dt_agenda_exame_w 
		from	agenda_paciente 
		where	nr_sequencia = nr_seq_agenda_p;
		 
		if (ie_medico_agenda_w <> 'CD_MEDICO') then 
			cd_medico_ref_age_w := null;
		end if;
		 
	end if;
	if (ie_atualiza_med_referido_p = 'S') or (ie_atualiza_med_referido_p = 'A') or (ie_atualiza_med_referido_p = 'R') then 
		 
		cd_medico_referido_w := cd_medico_ref_age_w;
	end if;
	 
	if (cd_tipo_agenda_p = 11) then -- Agenda de quimio 
		 
		select	max(nr_seq_classif_atend) 
		into STRICT	nr_seq_classificacao_w 
        from 	agenda_quimio a, qt_local b 
        where  b.nr_sequencia = a.nr_seq_local 
        and   a.nr_sequencia = nr_seq_agenda_p;
	end if;
	 
	if (cd_tipo_agenda_p = 1) or (cd_tipo_agenda_p = 2) then 
	 
		select	max(b.nr_seq_classif_atend), 
			max(b.ie_tipo_atend_tiss) 
		into STRICT	nr_seq_classificacao_w, 
			ie_tipo_atend_tiss_w 
        from  agenda_paciente_classif b,        
            agenda_paciente a        
        where  a.nr_sequencia = nr_seq_agenda_p 
        and   a.nr_seq_classif_agenda = b.nr_sequencia;
		 
	end if;
	 
	if (cd_tipo_agenda_p = 3) or (cd_tipo_agenda_p = 4) or (cd_tipo_agenda_p = 5) then 
		 
		select max(b.nr_seq_classif_atend), 
			max(b.ie_tipo_atend_tiss) 
		into STRICT	nr_seq_classificacao_w, 
			ie_tipo_atend_tiss_w 
        from  agenda_classif b,             
            agenda_consulta a          
        where	a.nr_sequencia = nr_seq_agenda_p     
        and   a.ie_classif_agenda = b.cd_classificacao;
		 
	end if;
 
	if (ie_data_ag_cons_entrada_p = 'S') and (dt_agenda_consulta_w IS NOT NULL AND dt_agenda_consulta_w::text <> '') then 
		 
		dt_entrada_w := dt_agenda_consulta_w;
	elsif (ie_data_ag_serv_entrada_p = 'S') and (dt_agenda_serv_w IS NOT NULL AND dt_agenda_serv_w::text <> '') then 
		dt_entrada_w := dt_agenda_serv_w;
	elsif	((ie_data_ag_cirur_entrada_p = 'P') or (ie_data_ag_cirur_entrada_p = 'S')) and (dt_prev_agenda_cirur_w IS NOT NULL AND dt_prev_agenda_cirur_w::text <> '') then 
		dt_entrada_w := dt_prev_agenda_cirur_w;
	elsif	((ie_data_ag_cirur_entrada_p = 'P') or (ie_data_ag_cirur_entrada_p = 'S')) and (dt_agenda_cirurgica_w IS NOT NULL AND dt_agenda_cirurgica_w::text <> '') then 
		dt_entrada_w := to_date(dt_agenda_cirurgica_w, 'dd/mm/yyyy hh24:mi:ss');
	elsif (ie_data_ag_exames_entrada_p = 'S') and (dt_agenda_exame_w IS NOT NULL AND dt_agenda_exame_w::text <> '') then 
		dt_entrada_w := to_date(dt_agenda_exame_w,'dd/mm/yyyy hh24:mi:ss');
	end if;
	 
	if (cd_tipo_agenda_p = 5) and (ie_atua_medico_gr_p = 'S') then 
		cd_medico_resp_w := cd_medico_resp_reab_w;
	end if;
	if (cd_tipo_agenda_p = 3) and (ie_medico_req_agenda_p = 'S') then 
		cd_medico_resp_w := cd_medico_resp_agenda_w;
	end if;
	 
	if (ie_utiliza_prof_agenda_resp_p = 'S') and (cd_tipo_agenda_p <> 0) then 
		 
		select	coalesce(max(ie_situacao),'I') 
		into STRICT	ie_situacao_med_cham_w 
		from	medico 
		where	cd_pessoa_fisica = cd_medico_chamada_p;
		 
		select	coalesce(max(ie_situacao),'I') 
		into STRICT	ie_situacao_med_ref_w 
		from	medico 
		where	cd_pessoa_fisica = cd_medico_referido_w;
		 
		if (ie_situacao_med_cham_w = 'I' and ie_situacao_med_ref_w = 'A') then 
			cd_medico_resp_w	:= cd_medico_referido_w;
		end if;		
	end if;
	 
end if;
 
cd_medico_referido_p	:= cd_medico_referido_w;
ie_tipo_atendimento_p 	:= ie_tipo_atendimento_w;
cd_cgc_indicacao_p  	:= cd_cgc_indicacao_w;
cd_pessoa_indicacao_p 	:= cd_pessoa_indicacao_w;
nr_seq_classificacao_p	:= nr_seq_classificacao_w;
ie_tipo_atend_tiss_p 	:= ie_tipo_atend_tiss_w;
dt_entrada_p		:= dt_entrada_w;
cd_medico_resp_p	:= cd_medico_resp_w;
 
if (ie_obs_agenda_p = 'S') then 
	ds_observacao_atend_p	:= ds_observacao_atend_w;
end if;
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atend_newrec_agendas_eup_js ( ie_medico_req_agenda_p text, cd_pessoa_fisica_p text, ie_atua_medico_gr_p text, ie_data_ag_exames_entrada_p text, ie_data_ag_cirur_entrada_p text, ie_data_ag_serv_entrada_p text, ie_data_ag_cons_entrada_p text, ie_obs_agenda_p text, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_agenda_p bigint, cd_tipo_agenda_p bigint, ie_atualiza_med_referido_p text, ie_utiliza_prof_agenda_resp_p text, cd_medico_chamada_p text, cd_medico_referido_p INOUT text, ie_tipo_atendimento_p INOUT bigint, cd_cgc_indicacao_p INOUT text, cd_pessoa_indicacao_p INOUT text, nr_seq_classificacao_p INOUT bigint, ds_observacao_atend_p INOUT text, ie_tipo_atend_tiss_p INOUT text, dt_entrada_p INOUT timestamp, cd_medico_resp_p INOUT text) FROM PUBLIC;

