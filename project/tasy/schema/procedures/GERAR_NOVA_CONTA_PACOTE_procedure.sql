-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_nova_conta_pacote (nr_interno_conta_ant_p bigint, nr_seq_pacote_p bigint, nr_interno_conta_nova_p INOUT bigint) AS $body$
DECLARE

 
nr_interno_conta_nova_w		bigint := null;
dt_inicio_w				timestamp;
dt_final_w				timestamp;
cd_estabelecimento_w		bigint;
nr_atendimento_w			bigint;
cd_convenio_parametro_w		bigint;
cd_categoria_parametro_w	varchar(10);
dt_referencia_w			timestamp;
dt_acerto_conta_w			timestamp;
nr_seq_procedimento_w		bigint;

 

BEGIN 
 
/* define novo per√≠odo da conta */
 
select coalesce(b.dt_inicio_pacote,c.dt_periodo_inicial), 
	 coalesce(b.dt_final_pacote,c.dt_periodo_final), 
	 c.nr_atendimento, 
	 c.cd_convenio_parametro, 
	 c.cd_categoria_parametro, 
	 c.cd_estabelecimento, 
	 c.dt_mesano_referencia, 
	 c.dt_acerto_conta, 
	 b.nr_seq_procedimento 
into STRICT	 dt_inicio_w, 
	 dt_final_w, 
	 nr_atendimento_w, 
	 cd_convenio_parametro_w, 
	 cd_categoria_parametro_w, 
	 cd_estabelecimento_w, 
	 dt_referencia_w, 
	 dt_acerto_conta_w, 
	 nr_seq_procedimento_w 
from	 conta_paciente c, 
	 atendimento_pacote b 
where	 c.nr_atendimento		= b.nr_atendimento 
and	 b.nr_sequencia		= nr_seq_pacote_p 
and	 c.nr_interno_conta	= nr_interno_conta_ant_p;
 
/* montar nova conta */
 
select nextval('conta_paciente_seq') 
into STRICT	 nr_interno_conta_nova_w
;
	 
insert into conta_paciente(nr_atendimento, 
   	dt_acerto_conta, 
 		ie_status_acerto, 
 		dt_periodo_inicial, 
 		dt_periodo_final, 
 		dt_atualizacao, 
 		nm_usuario, 
 		cd_convenio_parametro, 
 		cd_categoria_parametro, 
 		dt_mesano_referencia, 
		dt_mesano_contabil, 
		cd_convenio_calculo, 
		cd_categoria_calculo, 
		nr_interno_conta, 
		cd_estabelecimento, 
		nr_protocolo, 
		vl_conta, 
		vl_desconto) 
  	Values (nr_atendimento_w, 
 		dt_acerto_conta_w, 
      1, 
      dt_inicio_w, 
      dt_final_w, 
      clock_timestamp(), 
      'Tasy', 
      cd_convenio_parametro_w, 
      cd_categoria_parametro_w, 
      dt_referencia_w, 
		dt_referencia_w, 
      cd_convenio_parametro_w, 
      cd_categoria_parametro_w, 
		nr_interno_conta_nova_w, 
		cd_estabelecimento_w, 
		'0', 0, 0);
	 
update procedimento_paciente 
set	 nr_interno_conta		= nr_interno_conta_nova_w 
where	 nr_interno_conta 	= nr_interno_conta_ant_p 
and	 nr_seq_proc_pacote	= nr_seq_procedimento_w;
 
update material_atend_paciente 
set	 nr_interno_conta		= nr_interno_conta_nova_w 
where	 nr_interno_conta 	= nr_interno_conta_ant_p 
and	 nr_seq_proc_pacote	= nr_seq_procedimento_w;
 
commit;
 
nr_interno_conta_nova_p	:= nr_interno_conta_nova_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_nova_conta_pacote (nr_interno_conta_ant_p bigint, nr_seq_pacote_p bigint, nr_interno_conta_nova_p INOUT bigint) FROM PUBLIC;

