-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copia_prescricao ( nr_prescricao_p bigint, nr_atendimento_p bigint, nm_usuario_p text, cd_medico_p text, dt_prescricao_p timestamp, ie_ajustar_qt_p text, ie_procedimento_p text, ie_exames_p text, ie_agrupamento_p bigint, ie_recalc_horario_p text, nr_prescricoes_p text, dt_primeiro_horario_p text, dt_procedimento_p timestamp, ds_ind_clinica_p text, ie_proced_agora_p text, hr_prescr_inicial_p text, hr_prescr_final_p text, nr_horas_validade_p bigint, cd_perfil_p bigint, nr_nova_prescricao_p INOUT bigint, nr_prescr_origem_fut_p bigint default null, cd_pessoa_fisica_p text default null, cd_estabelecimento_p bigint default null, ie_copia_suspensas_p text DEFAULT NULL, cd_medic_posicionar_p INOUT bigint DEFAULT NULL) AS $body$
DECLARE



c001 REFCURSOR;
							
dt_prescricao_w    			timestamp := dt_prescricao_p;
dt_inicio_prescr_tes_w		timestamp;
nr_prescricao_w    			bigint;
cd_setor_entrega_w			bigint;
qt_reg_banco_w				bigint;
VarCalcularEtapaSolucao_w			varchar(10);
VarCalculaVolumeVelocidade_w		varchar(10);
VarCalculaTempoSolucao_w			varchar(10);
ie_arredondar_etapa_w				varchar(1);
QT_TEMSOL_W							double precision;
qt_hora_fase_w					prescr_solucao.qt_hora_fase%type;
qt_volsolu_w						double precision;
nr_seq_solucao_mat_w   		bigint;
nr_seq_registro_w			bigint;
nr_seq_he_elem_w			bigint;
cd_setor_ant_w				bigint;
nr_seq_he_w					bigint;
nr_seq_rep_he_w				bigint;
nr_seq_topografia_w			bigint;
VarVincularAtendPaciente_w	varchar(2);
qt_prescr_w					bigint;
cont_w						bigint;
cd_setor_paciente_w			bigint;
nr_seq_w					bigint;
nr_atendimento_w			bigint;
nr_atendimento_ww			bigint;
cd_kit_w					bigint;
cd_recomendacao_w			bigint;
qt_nut_w					bigint;
nr_seq_recomendacao_wW		bigint;
nr_seq_ultra_w				bigint;
nr_seq_item_ww				bigint;
qt_peso_pos_w				double precision;
qt_peso_pos_ww				double precision;
qt_sodio_w					double precision;
qt_calcio_w					double precision;
qt_bicarbonato_w			double precision;
nr_seq_anterior_w			bigint;
ie_copia_obs_w				varchar(1);
VarExibeItensNaoCopiados_w	varchar(1);
ie_gerar_lote_w				varchar(1) := 'S';
VarGerarNiveisGlic_w		varchar(1);
VarAtualizaDiasAtend_w		varchar(1);
varKitMateAutomatico_w		varchar(5);
ie_urgencia_medic_w			varchar(5);
ie_tipo_item_ww				varchar(15);
Var_param_548_w				varchar(15);
ds_medic_nao_padr_w			varchar(255);
ie_copia_item_w				varchar(15);
VarPrimHorNPT_w				varchar(15);
ds_item_ww					varchar(255);
ie_so_setor_paciente_w		varchar(15);
ie_gerar_dil_setor_w		varchar(15);
ie_copia_pca_w				varchar(15);
varIecopiaOutroEstab_w		varchar(15);
ie_categoria_w				varchar(15);
Var_param1097_w				varchar(15);
VarSetorEntregaUsuario_w	varchar(2);
ie_copia_nenhum_w			varchar(15);
VarCalculaHorSolucaoACM_w	varchar(5);
VarCopiaCheckAgora_w		varchar(1);
VarDataCopiaPrescricao_w	varchar(1);
VarIeAjustarDispAssoc_w		varchar(1);
ie_recalc_total_w			varchar(5);
varie_copia_acm_w			varchar(1);
VarParam1062_W				varchar(1);
VarIe_copia_proced_w		varchar(1);
varcopia_retr_w				varchar(1);
varcopia_medicaEsten_w		varchar(1);
ie_param911_w				varchar(1);
varie_copia_sn_w			varchar(1);
ie_kit_automatico_w			varchar(10);
ie_prim_hor_sol_w			varchar(10);
ie_justificativa_novo_w		varchar(10);
cd_setor_copia_w			varchar(255);
ds_horarios_2w				varchar(255);
ie_lipar_w					varchar(1);
VarIePrimHorCopia_w			varchar(1);
ie_motivo_prescr_w			varchar(5);
ie_altera_validade_w		varchar(5);
VarcopiaKitRec_w			varchar(5);
ds_observacao_far_ww		varchar(2000);
nr_prescr_w					varchar(2000);
ds_classif_setor_w			varchar(2000);
ds_ind_clinica_w			varchar(255);	
ie_sem_aprazamento_w		varchar(10);
VarPermiteRealizarPrimPrescr_w varchar(10);
hr_prim_hor_w				varchar(10);
hr_prim_hor_2w				varchar(10);
VarIe_verifica_setor_w		varchar(1);
Var_ie_agrupa_Supl_w		varchar(10);
ie_data_prescr_w			varchar(10);
ie_receita_prescr_w			varchar(10);
ie_copia_motivo_w			varchar(10);
nr_prescricao_orig_w		bigint;
nr_prescricoes_ww			varchar(1000) := '';
nr_sequencia_orig_w			bigint;
nr_seq_prot_glic_w			bigint;
nr_seq_item_rotina_w		bigint;
nr_receita_w				bigint;
cd_pessoa_fisica_w			varchar(10);
ie_permite_prescr_w			varchar(10);
Var_ie_agrupa_SNE_w			varchar(10);
ie_dia_seguinte_w			varchar(10);
err_msg						varchar(2000);
ie_funcao_agrupar_w			varchar(2000);
ie_loop_w					varchar(10);
ie_copia_acm_w				varchar(10);
cd_pessoa_fisica_ww			varchar(10);
ie_copia_nao_liberadas_w	varchar(10);
ie_copiar_hemodialise_w		varchar(10);
ie_etapa_especial_w			varchar(1);
ie_relancar_assoc_proc_w	varchar(1);
var_copia_diluicao_w		varchar(1);
ie_copia_farm_clinica_w		varchar(1);
ie_copia_REP_motivo_w		varchar(1);
nr_seq_acum_w				bigint;
nr_seq_dieta_w				bigint;
nr_seq_Proc_w				bigint;
nr_seq_proc_ww				bigint;
nr_seq_Solucao_w			bigint;
nr_agrup_acum_w				bigint;
nr_seq_acum_gas_w			bigint;
ie_dias_util_medic_w		varchar(1);
nr_sequencia_w				bigint;
qt_unitaria_w				double precision;
qt_material_w				double precision;
qt_total_dispensar_w		double precision;
nr_seq_gasoterapia_w		bigint;
qt_itens_w					bigint;
ds_horarios_w				varchar(2000);
ds_horarios2_w				varchar(2000);
ds_horarios_acm_sn_w		varchar(2000);
nr_ocorrencia_w				double precision;
nr_sequencia_diluicao_w		integer;
hr_prim_horario_w			varchar(5);
nr_dia_util_w				bigint;
cd_material_w				integer;
ds_dose_diferenciada_w		varchar(50);
nr_horas_validade_w			integer;
ie_operacao_w				varchar(1);
qt_operacao_w				intervalo_prescricao.qt_operacao%type;
dt_prescricao_dia_w			varchar(10);
dt_prescricao_www			timestamp;
dt_prescricao_ww			timestamp;
dt_entrada_w				timestamp;
ie_origem_inf_w				varchar(10);
ie_origem_inf_filtro_w		varchar(10);
ie_exame_w					varchar(1);
dt_inicio_prescricao_w		timestamp;
nr_seq_nut_pac_w			bigint;
nr_seq_nut_pac_ww			bigint;
qt_hora_w					bigint;
qt_hora_ww					varchar(100);
qt_hor_fut_sem_atend_w		bigint;
nr_prescricoes_w			varchar(2000);
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
cd_estab_usuario_w			integer;
cd_estab_origem_w			integer;
ds_erro_w					varchar(2000);

nr_nut_pac_w				bigint;
nut_pac_elem_w				bigint;
nr_seq_pac_elem_w			bigint;
nr_seq_pac_elem_mat_w		bigint;
qt_dia_npt_w				bigint;
cd_intervalo_w				varchar(7);
cd_inte_aux_w				varchar(7);
cd_intervalo_param_w		varchar(7);
ie_via_aplicacao_w			varchar(50);
dt_primeiro_horario_w		timestamp;
dt_primeiro_horario_mae_w	timestamp;
dt_prim_horario_w			varchar(20);
cd_classif_setor_w			varchar(2);
ie_glicemia_w				varchar(2);
cd_prescritor_w				varchar(10);
VarConsisteDataFutura_w		varchar(1);
Prescr_dia_w				varchar(1) := 'S';
nr_seq_bco_w				bigint;
VarBancoSangue_w			varchar(1);
cd_unidade_medida_dose_w	varchar(30);
ie_copia_agora_w			varchar(1);
ie_calcula_validade_w		varchar(1);
ie_informa_validade_copia_w	varchar(1);
cd_intervalo_proc_w			varchar(7);
dt_prev_execucao_w			timestamp;
dt_prev_execucao_ww			timestamp;
dt_resultado_w				timestamp;
cd_setor_atend_w			varchar(255);
cd_setor_col_w				varchar(255);
qt_dia_entrega_w			numeric(20);
ie_emite_mapa_set_w			varchar(255);
ds_hora_fixa_w				varchar(255);
ie_dia_semana_final_w 		bigint;
ie_data_resultado_w			varchar(255);
qt_min_entrega_w			bigint;
ie_atualizar_recoleta_w		varchar(255);
ie_dia_semana_upd_w			smallint;
ie_urgencia_w				varchar(1);
ie_forma_atual_dt_result_w	exame_lab_regra_setor.ie_atul_data_result%type;
qt_min_atraso_w				bigint;
cd_setor_entrega_dt_aux_w	varchar(255):= null;
cd_procedimento_w			bigint;
ie_origem_proced_w			bigint;
nr_intervalo_w				bigint := 0;
nr_intervalo_ww				bigint := 0;
ie_agrupador_w				smallint;
ie_se_necessario_w			varchar(1);
ie_acm_w					varchar(1);
ie_nao_padronizado_w		varchar(1);
dt_prim_hora_int_w			timestamp;
hr_prim_hora_medic_w		varchar(10);
ie_copia_mat_w				varchar(1);
VarCopiaJust_w				varchar(1);
var_pac_usu_w				varchar(2);
var_setores_usuario_w		varchar(1);
qt_registro_w				bigint;
cd_setor_usuario_w			integer;
cd_setor_prescr_w			integer := null;
ie_hora_sne_w				varchar(255);
ie_copia_medic_w			varchar(255);
ie_adep_w					varchar(1)	:= 'N';
ie_controle_medico_w		bigint;
QT_DIAS_LIBERADO_w			bigint;
ds_dose_dif_w				varchar(255);

ie_aux_w					varchar(1);
i							bigint;
nr_etapas_w					smallint;
nr_etapas_www				protocolo_npt.nr_etapas%type;
qt_tempo_aplicacao_w		double precision;
ie_esquema_alternado_w		varchar(1);
dt_horario_w				timestamp;
dt_inicio_prescr_w			timestamp;
dt_validade_prescr_w		timestamp;
dt_validade_prescr_ww		timestamp;
dt_validade_prescr2_ww		timestamp;
dt_proxima_dose_w			timestamp;
dt_proxima_dose_orig_w		timestamp;
qt_dias_lib_atend_w			bigint;

ie_copia_direta_w			varchar(15);
ie_insere_w					varchar(1);
ie_regra_disp_w				varchar(1);/* Rafael em 15/3/8 OS86206 */
nr_seq_material_delete_w	integer;/* Ivan em 25/03/2008 OS84773 */
ie_horario_sem_apraso_w		varchar(1);
cd_perfil_w					integer;
qt_hora_intervalo_w			bigint;
qt_min_intervalo_w			integer;

cd_intervalo_proc_agora_w	varchar(7);
hr_prim_horario_interv_w	timestamp;
hr_inicio_prescr_w			varchar(10);
ie_agrupa_prescr_atend_w	varchar(1)	:= 'S';
ie_situacao_w				varchar(1);
ie_situacao_ww				varchar(1);
ie_apres_medic_nao_copia_w	varchar(1);
nr_seq_exame_w				bigint;
ie_regra_medic_w			varchar(15);
cd_especialidade_w			varchar(50);
qt_dia_prim_hor_w			bigint;
nr_seq_proc_int_w			bigint;
cd_setor_atendimento_w		bigint;
nr_horas_copia_w			bigint;
ie_ctrl_glic_w				varchar(3);
ie_estender_w				varchar(3);
ie_prescr_agora_pa_w		varchar(1);
ie_peso_prescr_org_w		varchar(1);
ie_copia_SN_solucao_w		varchar(1);
ie_copiar_altura_w			varchar(1) := 'S';
ie_copiar_peso_w			varchar(1) := 'S';

dt_inicio_prescr_aux_w		timestamp;
dt_validade_prescr_aux_w	timestamp;
nr_horas_validade_aux_w		bigint;
VarConsistePrescrMesmoDia_w	varchar(5);
ie_excluir_iguais_w			varchar(5);
qt_dosagem_w				double precision;
ie_recalcular_sol_w			varchar(1);
qt_dietas_orais_w			integer;
qt_dietas_prescr_w			integer;
qt_dietas_aux_w				integer := 0;
cd_dieta_w					bigint;
nm_usuario_w				varchar(15);
qt_parametro_w				double precision;
ds_observacao_w				varchar(4000);
ie_destino_dieta_w			varchar(2);
ie_refeicao_w				varchar(3);
cd_motivo_baixa_w			smallint;

nr_sequencia_old_w			bigint;
ie_inicio_w					varchar(15);
ie_respiracao_w				varchar(15);
cd_modalidade_vent_w		varchar(15);
ie_disp_resp_esp_w			varchar(15);
nr_seq_gas_w				bigint;
cd_unidade_medida_w			varchar(30);
qt_gasoterapia_w			double precision;
--cd_intervalo_w varchar2(7);
ie_fluxo_acm_w 				varchar(1);
qt_limite_gas_min_w			double precision;
qt_limite_gas_max_w			double precision;
ie_suspenso_w 				varchar(1);
ie_unidade_medida_w			varchar(15);
qt_freq_vent_w 				smallint;

qt_vc_prog_w				double precision;
qt_pip_w					double precision;
qt_peep_w					double precision;
qt_ps_w						double precision;
qt_fluxo_insp_w				double precision;
qt_tempo_insp_w				double precision;
qt_acima_peep_w				double precision;
qt_ti_te_w					double precision;
qt_sensib_resp_w			double precision;

ie_modo_adm_w				varchar(5);
ie_prescr_hor_sem_lib_w		varchar(255);

nr_prescricao_ww			bigint;
nr_sequencia_ww				integer;
ie_origem_inf_ww			varchar(1);
cd_material_ww				bigint;
cd_unidade_medida_ww		varchar(30);
qt_dose_ww					double precision;
qt_unitaria_ww				double precision;
qt_material_ww				double precision;
dt_atualizacao_ww			timestamp;
nm_usuario_ww				varchar(50);
cd_intervalo_ww				varchar(7);
ds_horarios_ww				varchar(2000);
ds_horarios_aux_w			varchar(2000);
ds_observacao_ww			varchar(4000);
ds_observacao_enf_ww		varchar(4000);
ie_via_aplicacao_ww			varchar(5);
nr_agrupamento_ww			double precision;
ie_cobra_paciente_ww		varchar(1);
cd_motivo_baixa_ww			smallint;
dt_baixa_ww					timestamp;
ie_utiliza_kit_ww			varchar(1);
cd_unidade_medida_dose_ww 	varchar(30);
nr_seq_via_acesso_ww		varchar(30);
qt_conversao_dose_ww		double precision;
ie_urgencia_ww				varchar(1);
nr_ocorrencia_ww			double precision;
qt_total_dispensar_ww		double precision;
cd_fornec_consignado_ww		varchar(15);
nr_sequencia_solucao_ww		integer;
nr_sequencia_proc_ww		integer;
qt_solucao_ww				double precision;
hr_dose_especial_ww			varchar(5);
qt_dose_especial_ww			double precision;
ds_dose_diferenciada_ww		varchar(50);
ie_medicacao_paciente_ww	varchar(1);
nr_sequencia_diluicao_ww	integer;
hr_prim_horario_ww			varchar(50);
nr_sequencia_dieta_ww		integer;
ie_agrupador_ww				integer;
nr_dia_util_ww				integer;
ie_suspenso_ww				varchar(5);
ie_se_necessario_ww			varchar(5);
qt_min_aplicacao_ww			integer;
ie_bomba_infusao_ww			varchar(5);
ie_aplic_bolus_ww			varchar(5);
ie_aplic_lenta_ww			varchar(5);
ie_acm_ww					varchar(5);
ie_objetivo_ww				varchar(5);
ie_objetivo_w				varchar(5);
cd_topografia_cih_ww		bigint;
ie_origem_infeccao_ww		varchar(5);
ie_origem_infeccao_w		varchar(5);
cd_amostra_cih_ww			bigint;
cd_microorganismo_cih_ww	bigint;
ie_uso_antimicrobiano_ww	varchar(5);
cd_protocolo_ww				bigint;
nr_seq_protocolo_ww			bigint;
nr_seq_protocolo_www		prescr_solucao.nr_seq_protocolo%type;
nr_seq_mat_protocolo_ww		bigint;
qt_hora_aplicacao_ww		bigint;
ie_recons_diluente_fixo_ww	varchar(1);
qt_vel_infusao_ww			double precision;
ds_justificativa_ww			varchar(4000);
ds_justificativa_w			varchar(4000);
ie_sem_aprazamento_ww		varchar(5);
ie_indicacao_ww				varchar(5);
dt_proxima_dose_ww			timestamp;
qt_total_dias_lib_ww		integer;
nr_seq_substituto_ww		bigint;
ie_lado_ww					varchar(5);
dt_inicio_medic_ww			timestamp;
qt_dia_prim_hor_ww			bigint;
ie_regra_disp_ww			varchar(5);
qt_vol_adic_reconst_ww		double precision;
qt_min_intervalo_ww			bigint;
ie_permite_substituir_ww	varchar(10);
NR_SEQUENCIA_DIL_W			bigint;
nr_seq_dialise_w			bigint;
nr_seq_sol_dialise_w		bigint;
ie_padronizado_w			varchar(15);
ie_prescritor_aux_w			varchar(1);
qt_dose_w					double precision;
VarRecalculaProcInterv_w	varchar(1);

qt_fluxo_sangue_w			double precision;
qt_sessao_sem_w				smallint;
qt_hora_sessao_w			smallint;
qt_min_sessao_w				smallint;
nr_seq_mod_dialisador_w		bigint;
ie_ultrafiltracao_w			varchar(15);
qt_ultrafiltracao_w			double precision;
ie_tipo_hemodialise_w		varchar(15);
ie_tipo_dialise_w			varchar(1);
ie_tipo_peritoneal_w		varchar(15);
nr_seq_maq_cicladora_w		bigint;
nr_seq_mat_diluicao_ww		bigint;
ie_altera_dt_proxima_dose_w	varchar(1);
cd_pessoa_atend_w			varchar(50);
ie_tipo_atendimento_w		integer;
ds_log_w					varchar(2000);
qt_peso_ideal_w				real;
nr_seq_diametro_agulha_w	bigint;
nr_seq_tipo_agulha_w		bigint;
nr_seq_tipo_agulha_art_w	bigint;
nr_seq_perfil_sodio_w		bigint;
qt_zero_um_w				bigint;
qt_um_dois_w				bigint;
qt_dois_tres_w				bigint;
qt_tres_quatro_w			bigint;
ie_ligar_prime_w			varchar(1);
qt_peso_seco_w				double precision;
ds_obs_dialise_w			varchar(2000);
nr_seq_proc_prescr_w		bigint;
nr_doc_convenio_w			varchar(255);
ie_guia_w					varchar(255);
cd_setor_atend_proc_w		bigint;
VarIdentPrescrADEP_w		varchar(15);
ie_rep_adep_w				varchar(1);
ie_adep_param_w				varchar(15);
ie_gerar_diluicao_w			varchar(1);
ie_recalc_hor_recomendacoes_w varchar(1);
ie_considera_tipo_mat_w		varchar(1);
nr_horas_validade_padrao_w	bigint;
nr_horas_validade_padrao_ww	bigint;
ie_mesmo_zerado_w			varchar(1);
ie_copiar_nutricao_w		varchar(1);
ie_copiar_solucao_w			varchar(1);
ie_copiar_medic_w			varchar(1);
ie_copiar_mat_w				varchar(1);
ie_copiar_proced_w			varchar(1);
ie_copiar_gas_w				varchar(1);
ie_copiar_hem_w				varchar(1);
ie_copiar_rec_w				varchar(1);
qt_qsp_diluente_w			double precision;
Varie_copia_prescr_w		varchar(1);
--- Guilherme Pereira 16/12/2011
ie_destino_rec_w			varchar(3);
ds_recomendacao_rec_w		varchar(4000);
qt_recomendacao_rec_w		double precision;
ie_suspenso_rec_w			varchar(1);
cd_intervalo_rec_w			varchar(7);
nr_seq_classif_rec_w		bigint;	
cd_recomendacao_rec_w		bigint;	
ds_horarios_rec_w			varchar(2000);
ds_observacao_rec_w			varchar(255);
ie_urgencia_rec_w			varchar(1);
hr_prim_horario_rec_w		varchar(5);	
nr_seq_topografia_rec_w 	bigint;
ie_faose_rec_w				varchar(15);
ie_acm_rec_w				varchar(1);
ie_se_necessario_rec_w  	varchar(1);
ie_alterar_horario_rec_w	varchar(1);
cd_kit_rec_w				bigint;
qt_gas_w					bigint;
qt_recomend_w				bigint;
ie_copia_albumina_w			varchar(1);
ie_copia_obs_prescr_w		varchar(2);
ie_setor_prescr_proc_w		varchar(1);
ie_controla_adm_w			varchar(2);
ie_espec_desconsiderar_w	varchar(255);
dt_prev_execucao_atual_w	timestamp;
dt_prox_prev_exec_w			timestamp;
nr_seq_anterior_proc_w		bigint;
nr_prescr_anterior_proc_w	bigint;
ie_administrar_proc_w		varchar(1);
qt_ocorrencia_int_proc_w	bigint;
cd_intervalo_proced_w		varchar(7);
ie_operacao_int_proc_w		varchar(1);
ie_24_h_proc_w				varchar(1);
dt_proxima_dose_proc_w		timestamp;
VarIe_Controla_Adm_w		varchar(1);
ie_data_prevista_w			varchar(1);
qt_peso_w					real;
nr_seq_mat_w				bigint:=0;
nr_sequencia_mat_w			bigint;
nr_agrupamento_w			double precision;
ie_executar_leito_w			varchar(1);
qt_procedimento_w			double precision;
ds_observacao_enf_w			varchar(2000);
cd_setor_proced_w			integer;
ds_dado_clinico_w			varchar(2000);
cd_material_exame_w			varchar(20);
ds_material_especial_w		varchar(255);
nr_seq_proc_interno_w		bigint;
qt_peca_ap_w				smallint;
ds_qualidade_peca_ap_w		varchar(2000);
ds_diag_provavel_ap_w		varchar(255);
ds_exame_anterior_ap_w		varchar(255);
nr_seq_derivado_w			bigint;
nr_seq_exame_sangue_w		bigint;
nr_seq_solic_sangue_w		bigint;
cd_unid_med_sangue_w		varchar(5);
cd_pessoa_coleta_w			varchar(10);
qt_vol_hemocomp_w			bigint;
cd_mod_vent_w				varchar(15);
qt_fluxo_oxigenio_w			double precision;
ds_rotina_w					varchar(80);
ie_lado_w					varchar(1);
cd_protocolo_w				bigint;
nr_seq_protocolo_w			integer;
cd_medico_exec_w			varchar(10);
ie_tipo_proced_w			varchar(15);
ie_forma_exame_w			varchar(1);
ie_restring_interv_lib_w	varchar(1);
ie_kit_gerado_w				varchar(1);
ie_copiar_def_infecto_w		varchar(1);
nr_seq_def_infect_w			bigint;
ie_vancomicina_w			varchar(1);
ie_param1128_w				varchar(3);
ie_em_protocolo_vanco_w		varchar(1);
cd_intervalo_soluc_w      	varchar(7);
vl_param1156_w				bigint;
dt_susp_agora_w				timestamp;
ie_fator_correcao_w			varchar(1);
ie_fator_correcao_med_w		varchar(1);
ds_sql_cursor_w				varchar(20000);
ds_sql_where_w				varchar(10000);
ds_agrupador_nao_copiar_w	varchar(30);
nr_seq_rotina_w				bigint; -- mjgoncalves OS 675145/712328
ie_aplicar_w				prescr_material.ie_aplicar%type;
ie_limp_prim_hor_acm_w		varchar(1);
qt_volume_corrigido_w		double precision;
ie_setor_paciente_w			varchar(1);
ie_param443_w				varchar(1);
ie_horas_fixas_npt_w		varchar(1);
ie_gera_disp_acm_sn_w		varchar(1);
qt_hora_inf_w			nut_pac.qt_hora_inf%type;
ie_seleciona_kit_rec_w		varchar(1);
cd_kit_rec_2_w			kit_mat_recomendacao.cd_kit%type;
nr_seq_agrupamento_w		setor_atendimento.nr_seq_agrupamento%type;	
cd_convenio_w				bigint;
ie_cateter_w			hd_prescricao.ie_cateter%type;
ie_copiar_proc_interv_w	intervalo_prescricao.ie_copiar%type;
ie_disponivel_mercado_w		varchar(1);
nm_maquina_w			computador.nm_computador%type;
cd_prescr_orig_w		prescr_medica.cd_setor_atendimento%type;
ie_gera_dil_comp_sol_w		varchar(5);

cont_peca_w					bigint;

qt_zero_um_bic_w   			bigint;
qt_um_dois_bic_w   			bigint;
qt_dois_tres_bic_w 			bigint;
qt_tres_quatro_bic_w		bigint;
qt_quatro_cinco_bic_w		bigint;
qt_cinco_seis_bic_w			bigint;
nr_seq_perfil_bic_w			bigint;
QT_FRASCO_ENV_w	prescr_procedimento.qt_frasco_env%type;
ie_tipo_dosagem_w	prescr_solucao.ie_tipo_dosagem%type;
ie_permite_alterar_w	prescr_material.ie_permite_alterar%type;
cd_protocolo_prescr_w		prescr_medica.cd_protocolo%type;
nr_seq_prot_prescr_w		prescr_medica.nr_seq_protocolo%type;
ie_atualizar_kit_rec_w 		varchar(1);
ie_gera_prim_hor_solucao_w	varchar(1);
ie_hemodialise_w			prescr_solucao.ie_hemodialise%type;
ie_tipo_solucao_w			prescr_solucao.ie_tipo_solucao%type;
cd_setor_coleta_w			prescr_procedimento.cd_setor_coleta%type;
nr_agrupamento_www			double precision;

C000 CURSOR FOR
SELECT	b.ie_dias_util_medic,
		a.cd_material,
		a.nr_sequencia,
		a.qt_unitaria,
		a.qt_material,
		a.ds_horarios,
		coalesce(a.nr_ocorrencia,1),
		a.qt_total_dispensar,
		a.nr_sequencia_diluicao,
		a.hr_prim_horario,
		a.ds_dose_diferenciada,
		c.nr_horas_validade,
		d.ie_operacao,
		d.qt_operacao,
		a.cd_intervalo,
		a.ie_via_aplicacao,
		a.cd_unidade_medida_dose,
		a.ie_agrupador,
		a.ie_se_necessario,
		a.ie_acm,
		a.qt_hora_intervalo,
		a.qt_min_intervalo,
		to_char(c.dt_primeiro_horario,'hh24:mi') hr_inicio_prescr,
		a.qt_dose,
		a.ds_justificativa,
		a.ie_origem_infeccao,
		a.ie_objetivo
FROM prescr_medica c, material b, prescr_material a
LEFT OUTER JOIN intervalo_prescricao d ON (a.cd_intervalo = d.cd_intervalo)
WHERE a.cd_material		= b.cd_material and ((ie_considera_tipo_mat_w = 'N') or (b.ie_tipo_material 	in (2,3))) and coalesce(a.nr_sequencia_solucao::text, '') = '' --and	a.nr_sequencia_proc 	is null
  and a.nr_prescricao		= c.nr_prescricao and a.ie_agrupador not in (3,7,9) and ((Varie_copia_prescr_w = 'S') or (coalesce(b.ie_disponivel_mercado,'N') <> 'N')) and a.nr_prescricao = nr_prescricao_w;

C002 CURSOR FOR
SELECT	cd_recomendacao,
		a.nr_sequencia,
		a.ds_horarios,
		coalesce(a.nr_ocorrencia,1),
		a.hr_prim_horario,
		b.nr_horas_validade,
		a.cd_intervalo,
		to_char(b.dt_primeiro_horario,'hh24:mi') hr_inicio_prescr,
		c.ie_operacao,
		c.qt_operacao
from	prescr_medica b,
		prescr_recomendacao a,
		intervalo_prescricao c
where	a.nr_prescricao = b.nr_prescricao
and		a.cd_intervalo = c.cd_intervalo
and		a.nr_prescricao = nr_prescricao_w;

C02 CURSOR FOR
SELECT	nr_sequencia
from	nut_paciente_elemento
where	nr_seq_nut_pac = (	Select	min(b.nr_sequencia)
							from	nut_paciente b
							where	b.nr_prescricao = nr_prescricao_orig_w)
order by nr_sequencia;

C03 CURSOR FOR
SELECT	nr_sequencia
from	nut_pac_elemento
where	nr_seq_nut_pac	= (	Select	min(b.nr_sequencia)
							from	nut_pac b
							where	b.nr_prescricao = nr_prescricao_orig_w
							and	b.ie_npt_adulta	= 'P')
order by nr_sequencia;

C031 CURSOR FOR
SELECT	nr_sequencia
from	nut_pac_elemento
where	nr_seq_nut_pac	= (	Select	min(b.nr_sequencia)
							from	nut_pac b
							where	b.nr_prescricao = nr_prescricao_orig_w
							and	b.ie_npt_adulta	= 'N')
order by nr_sequencia;

C04 CURSOR FOR
SELECT	nr_sequencia
from	nut_pac_elem_mat
where	nr_seq_pac_elem	= nut_pac_elem_w
order by nr_sequencia;

C05 CURSOR FOR
SELECT		nr_sequencia
from		prescr_material a
where		a.ie_agrupador	in (1,2,4,5,8,12,13,15)
and			a.nr_prescricao 	= nr_prescricao_w;

C06 CURSOR FOR
SELECT	a.nr_sequencia,
		a.cd_intervalo,
		a.dt_prev_execucao,
		a.cd_procedimento,
		a.ie_origem_proced,
		a.ds_horarios,
		coalesce(b.ie_situacao,'A'),
		a.nr_seq_exame,
		c.nr_horas_validade,
		a.qt_hora_intervalo,
		a.qt_min_intervalo,
		a.nr_seq_proc_interno,
		obter_ctrl_glic_proc(a.nr_seq_proc_interno),
		a.ie_urgencia
FROM prescr_medica c, prescr_procedimento a
LEFT OUTER JOIN intervalo_prescricao b ON (a.cd_intervalo = b.cd_intervalo)
WHERE c.nr_prescricao	= a.nr_prescricao  and (obter_se_exibe_proced(a.nr_prescricao,a.nr_sequencia,a.ie_tipo_proced,'O') = 'S' or
		((Obter_se_exibe_proced(a.nr_prescricao,a.nr_sequencia,a.ie_tipo_proced,'BS')= 'S') or (Obter_se_exibe_proced(a.nr_prescricao,a.nr_sequencia,a.ie_tipo_proced,'AT')= 'S'))) and c.nr_prescricao	= nr_prescricao_w;

C07 CURSOR FOR
SELECT	nr_sequencia
from	prescr_material
where	ie_agrupador	= 8
and		nr_prescricao	= nr_prescricao_w;

C08 CURSOR FOR
	SELECT	b.nr_seq_solucao,
			a.dt_primeiro_horario,
			coalesce(b.nr_etapas,1),
			b.qt_tempo_aplicacao,
			coalesce(b.ie_esquema_alternado,'N'),
			b.cd_intervalo,
			b.qt_dosagem,
			b.ie_tipo_dosagem
	from	prescr_solucao b,
			prescr_medica a
	where	a.nr_prescricao	= b.nr_prescricao
	and		coalesce(b.ie_se_necessario,'N') <> 'S'
	and		coalesce(b.ie_ACM,'N') <> 'S'
	and		a.nr_prescricao	= nr_prescricao_w;
	--and	nvl(b.ie_calc_aut,'S')	= 'S';                     Alan/Caldas OS 277705
/*Atualizacao da data para proxima dose, 1 horario e horarios*/

C09 CURSOR FOR
SELECT	b.nr_sequencia,
		obter_ocorrencia_intervalo(b.cd_intervalo,coalesce(a.nr_horas_validade,24),'H'),
		b.dt_proxima_dose,
		b.nr_sequencia_anterior,
		coalesce(b.nr_prescricao_anterior,b.nr_prescricao_original),
		b.cd_material,
		b.cd_intervalo,
		b.hr_prim_horario
from	prescr_material b,
		prescr_medica a
where	((b.ie_origem_inf	<> 'K') or (Var_param1097_w = 'S') or (VarcopiaKitRec_w = 'S' AND b.nr_seq_recomendacao IS NOT NULL AND b.nr_seq_recomendacao::text <> ''))
and		obter_se_interv_superior_24h(b.cd_intervalo,null) = 'S'
and		b.ie_agrupador	in (1, 2)
and		a.nr_prescricao	= b.nr_prescricao
and		a.nr_prescricao	= nr_prescricao_w;

c10 CURSOR FOR /* Ivan em 25/03/2008 OS */
	SELECT	nr_sequencia
	from	prescr_material
	where	ie_agrupador		= 1
	and		coalesce(nr_sequencia_solucao::text, '') = ''
	and		coalesce(nr_sequencia_proc::text, '') = ''
	and		coalesce(nr_sequencia_dieta::text, '') = ''
	and		coalesce(nr_sequencia_diluicao::text, '') = ''
	and		nr_prescricao		= nr_prescricao_w;
	
C012 CURSOR FOR
	SELECT	a.cd_material,
			a.nr_sequencia,
			a.cd_intervalo,
			a.ie_via_aplicacao,
			a.qt_unitaria,
			a.ds_dose_diferenciada,
			a.ie_origem_inf,
			coalesce(cd_unidade_medida_dose,cd_unidade_medida),
			qt_material,
			coalesce(a.ie_se_necessario,'N'),
			coalesce(a.ie_acm,'N')
	from	prescr_material a		
	where	a.nr_sequencia_solucao = nr_seq_Solucao_w
	and		a.nr_prescricao = nr_prescricao_w;
	
C013 CURSOR FOR
	SELECT	a.nr_seq_proc_interno,
			a.nr_sequencia,
			a.dt_proxima_dose,
			a.dt_prev_execucao,
			a.cd_intervalo
	from	Prescr_Procedimento a
	where	((coalesce(ie_suspenso,'N')	<> 'S') or (ie_copia_suspensas_p = 'S'))
	and		ie_origem_inf	<> 'L'
	and		coalesce(nr_seq_origem::text, '') = ''
	and		coalesce(OBTER_DADOS_EXAME_LAB_REP(cd_perfil_w, cd_especialidade_w, cd_setor_prescr_w, nr_seq_exame, cd_estabelecimento_w, 'C'), 'S') = 'S'
	and		((VarBancoSangue_w = 'S') or
			 (VarBancoSangue_w = 'T' AND ie_agrupamento_p	<> 2) or (coalesce(nr_seq_solic_sangue::text, '') = ''))
	and		consiste_copia_prescr_rotina(a.nr_seq_proc_interno, a.cd_procedimento, a.ie_origem_proced,
			a.nr_seq_exame, ie_procedimento_p, ie_exame_w) = 'S'
	and		nr_prescricao	= nr_prescricao_w;	

C014 CURSOR FOR
	SELECT	b.nr_seq_solucao,
			a.dt_primeiro_horario,
			coalesce(b.nr_etapas,1),
			b.qt_tempo_aplicacao,
			coalesce(b.ie_esquema_alternado,'N'),
			coalesce(b.ie_hemodialise,'N')
	from	prescr_solucao b,
			prescr_medica a
	where	a.nr_prescricao	= b.nr_prescricao
	and		a.nr_prescricao	= nr_prescricao_w;
	
C015 CURSOR FOR
	SELECT	a.nr_sequencia,
			a.cd_dieta,		
			a.nm_usuario,
			a.qt_parametro,
			a.ds_horarios,
			a.ds_observacao,
			a.ie_destino_dieta,
			a.ie_refeicao,
			a.cd_intervalo,
			a.IE_VIA_APLICACAO
	from	dieta b,
			prescr_dieta a
	where	((coalesce(a.ie_suspenso,'N')	<> 'S') or (ie_copia_suspensas_p = 'S'))
	and		a.cd_dieta = b.cd_dieta
	and		coalesce(b.ie_situacao,'A') = 'A'
	and		a.nr_prescricao = nr_prescricao_orig_w;

C16 CURSOR FOR
	SELECT	nr_sequencia,
			nextval('prescr_gasoterapia_seq'),
			ie_inicio,
			ie_respiracao,
			cd_modalidade_vent,
			ie_disp_resp_esp,
			nr_seq_gas,
			cd_unidade_medida,
			qt_gasoterapia,
			cd_intervalo,
			ie_fluxo_acm,
			qt_limite_gas_min,
			qt_limite_gas_max,
			ds_observacao,
			ie_suspenso,
			ie_unidade_medida,
			qt_freq_vent,
			ie_modo_adm,
			nr_seq_item_rotina,
			qt_vc_prog,
			qt_pip,	
			qt_peep,
			qt_ps,
			qt_fluxo_insp,
			qt_tempo_insp,
			qt_acima_peep,
			qt_ti_te,
			qt_sensib_resp
	from	prescr_gasoterapia
	where	((coalesce(ie_suspenso,'N')	<> 'S') or (ie_copia_suspensas_p = 'S'))
	and		nr_prescricao	= nr_prescricao_orig_w;
	
c17 CURSOR FOR
SELECT  nr_prescricao_w,
		a.nr_sequencia,
		a.ie_origem_inf,
		a.cd_material,
		a.cd_unidade_medida,
		a.qt_dose,
		a.qt_unitaria,
		a.qt_material,
		dt_prescricao_w,
		nm_usuario_p,
		a.cd_intervalo,
		CASE WHEN ie_recalc_horario_p='V' THEN  reordenar_horarios(dt_inicio_prescr_tes_w, reordenar_horarios_copia(a.DS_HORARIOS))  ELSE a.DS_HORARIOS END ,
		a.ds_observacao,
		CASE WHEN ie_copia_obs_w='S' THEN a.ds_observacao_enf  ELSE CASE WHEN  ie_copia_obs_w='E' THEN  a.ds_observacao_enf  ELSE null END  END ,
		a.ie_via_aplicacao,
		a.nr_agrupamento,
		coalesce(a.ie_cobra_paciente,'S'),
		a.cd_motivo_baixa,	-- Valor assumido sempre e tratado ao abrir o cursor c17
		clock_timestamp(),			-- Valor assumido sempre e tratado ao abrir o cursor c17
		a.ie_utiliza_kit,
		a.cd_unidade_medida_dose,
		a.nr_seq_via_acesso,
		a.qt_conversao_dose,
		CASE WHEN VarCopiaCheckAgora_w='S' THEN a.ie_urgencia  ELSE 'N' END ,
		a.nr_ocorrencia,
		a.qt_total_dispensar,
		a.cd_fornec_consignado,
		CASE WHEN coalesce(a.nr_sequencia_solucao::text, '') = '' THEN  null  ELSE a.nr_sequencia_solucao + nr_seq_solucao_w END ,
		CASE WHEN coalesce(a.nr_sequencia_proc::text, '') = '' THEN  null  ELSE a.nr_sequencia_proc + nr_seq_proc_w END ,
		a.qt_solucao,
		null,
		null,
		a.ds_dose_diferenciada,
		a.ie_medicacao_paciente,
		CASE WHEN coalesce(a.NR_SEQUENCIA_DILUICAO::text, '') = '' THEN  null  ELSE a.NR_SEQUENCIA_DILUICAO +a.nr_sequencia END ,
		CASE WHEN a.ie_se_necessario='S' THEN  null  ELSE CASE WHEN ie_recalc_horario_p='N' THEN  a.HR_PRIM_HORARIO WHEN ie_recalc_horario_p='V' THEN  a.HR_PRIM_HORARIO  ELSE to_char(to_date('30/12/1899'||substr(dt_primeiro_horario_p,1,5),'dd/mm/yyyy hh24:mi'),'hh24:mi') END  END ,
		CASE WHEN coalesce(a.NR_SEQUENCIA_DIETA::text, '') = '' THEN null  ELSE a.NR_SEQUENCIA_DIETA + nr_seq_dieta_w END ,
		a.IE_AGRUPADOR,
		a.nr_dia_util,
		coalesce(a.ie_suspenso, 'N'),
		a.ie_se_necessario,
		a.qt_min_aplicacao,
		a.ie_bomba_infusao,
		coalesce(a.IE_APLIC_BOLUS,'N'),
		coalesce(a.IE_APLIC_LENTA,'N'),
		CASE WHEN ie_copia_acm_w='S' THEN coalesce(a.ie_acm,'N')  ELSE 'N' END ,
		CASE WHEN coalesce(a.qt_total_dias_lib,0)=0 THEN  a.ie_objetivo  ELSE CASE WHEN obter_se_copia_justif(a.qt_total_dias_lib, a.nr_dia_util, b.ie_dias_util_medic)='N' THEN a.ie_objetivo END  END ,
		a.cd_topografia_cih,
		CASE WHEN coalesce(a.qt_total_dias_lib,0)=0 THEN  a.ie_origem_infeccao  ELSE CASE WHEN obter_se_copia_justif(a.qt_total_dias_lib, a.nr_dia_util, b.ie_dias_util_medic)='N' THEN a.ie_origem_infeccao END  END ,
		a.cd_amostra_cih,
		a.cd_microorganismo_cih,
		coalesce(a.ie_uso_antimicrobiano,'N'),
		a.cd_protocolo,
		a.nr_seq_protocolo,
		a.nr_seq_mat_protocolo,
		a.qt_hora_aplicacao,
		'N',
		A.QT_VEL_INFUSAO,
		CASE WHEN coalesce(qt_dias_liberado,1)=0 THEN ''  ELSE CASE WHEN VarCopiaJust_w='S' THEN CASE WHEN coalesce(a.qt_total_dias_lib,0)=0 THEN  a.ds_justificativa  ELSE CASE WHEN obter_se_copia_justif(a.qt_total_dias_lib, a.nr_dia_util, b.ie_dias_util_medic)='N' THEN a.ds_justificativa END  END   ELSE '' END  END ,
		a.ie_sem_aprazamento,
		a.ie_indicacao,
		a.dt_proxima_dose,
		a.qt_total_dias_lib,
		a.nr_seq_substituto,
		a.ie_lado,
		a.dt_inicio_medic,	
		a.qt_dia_prim_hor,
		a.ie_regra_disp,	-- Valor assumido sempre e tratado ao abrir o cursor c17
		a.qt_vol_adic_reconst,
		a.qt_hora_intervalo,
		a.qt_min_intervalo,
		ie_permite_substituir,
		CASE WHEN ie_copia_obs_w='S' THEN a.ds_observacao_far  ELSE CASE WHEN  ie_copia_obs_w='F' THEN  a.ds_observacao_far  ELSE null END  END ,
		b.ie_dias_util_medic,
		a.nr_seq_recomendacao,
		coalesce(b.ie_situacao, 'A'),
		a.cd_kit_material,
		a.ds_medic_nao_padrao,
		coalesce(b.ie_vancomicina, 'N'),
		coalesce(a.ie_em_protocolo_vanco, 'N'),
		a.ie_glicemia,
		a.dt_susp_agora,
		a.ie_fator_correcao,
		a.ie_aplicar,
		a.qt_volume_corrigido,
		a.ie_urgencia,
		b.ie_disponivel_mercado,
		coalesce(a.ie_permite_alterar, 'S')
From	Material b,
		Prescr_Material a
where	((coalesce(a.ie_suspenso,'N') <> 'S') or (ie_copia_suspensas_p = 'S') or (ie_apres_medic_nao_copia_w = 'S'))
and		((b.ie_situacao = 'A') or (ie_apres_medic_nao_copia_w = 'S'))
and		((coalesce(substr(obter_se_material_padronizado(cd_estabelecimento_w, b.cd_material),1,1) ,'S') = 'S') or (ie_nao_padronizado_w = 'S'))
and		verifica_medic_padronizado(a.nr_prescricao, a.cd_material, ie_padronizado_w) = 'S'	
--and		((Varie_copia_prescr_w = 'S') or (nvl(b.ie_disponivel_mercado,'N') <> 'N'))
and		a.cd_material 	= b.cd_material
and		((varie_copia_acm_w = 'S') or (coalesce(a.ie_acm,'N') = 'N') or (a.ie_agrupador = 4) or ((obter_se_copia_ACM(cd_setor_prescr_w) = 'S') and (varie_copia_acm_w = 'D')))
and		((varie_copia_sn_w = 'S') or (coalesce(a.ie_se_necessario,'N') = 'N'))
and		((ie_relancar_assoc_proc_w = 'N') or (coalesce(a.nr_sequencia_proc::text, '') = ''))
and		coalesce(a.nr_sequencia_dieta::text, '') = ''
and		obter_se_valor_contido(a.ie_agrupador,ds_agrupador_nao_copiar_w) = 'N'
and		((coalesce(a.nr_sequencia_diluicao::text, '') = '') or
		 (a.nr_sequencia_diluicao not in (
				SELECT	x.nr_sequencia
				from	material y,
						prescr_material x
				where	y.cd_material = x.cd_material
				and		((y.ie_situacao <> 'A') or
						 ((ie_nao_padronizado_w = 'N') and (coalesce(substr(obter_se_material_padronizado(cd_estabelecimento_w, y.cd_material),1,1) ,'S') = 'N')))
				and		x.nr_prescricao = nr_prescricao_orig_w)))
and	exists (	select 1
			
			where	coalesce(a.nr_sequencia_proc::text, '') = ''
			
union all

			select	1
			
			where	ie_procedimento_p = 'S'
			
union all

			select	1
			from	Prescr_procedimento b
			where	(a.nr_sequencia_proc IS NOT NULL AND a.nr_sequencia_proc::text <> '')
			and		b.nr_prescricao		= nr_prescricao_orig_w
			and		b.nr_sequencia		= a.nr_sequencia_proc
			and		consiste_copia_prescr_rotina(b.nr_seq_proc_interno, b.cd_procedimento, b.ie_origem_proced, b.nr_seq_exame, ie_procedimento_p, ie_exame_w) = 'S'
			and		ie_procedimento_p 	= 'C')
and	not exists (	select	nr_prescricao
				from	prescr_dieta b
				where	a.nr_prescricao	= b.nr_prescricao
				and		a.nr_sequencia_dieta = b.nr_sequencia
				and		coalesce(b.ie_suspenso,'N')	= 'S')
and not exists (	select	nr_prescricao
				from	prescr_solucao c
				where	a.nr_prescricao	= c.nr_prescricao
				and		a.nr_sequencia_solucao = c.nr_seq_solucao
				and		coalesce(c.ie_suspenso,'N') = 'S')
and not exists (	select	nr_prescricao
				from	prescr_procedimento d
				where	a.nr_prescricao	= d.nr_prescricao
				and		a.nr_sequencia_proc	= d.nr_sequencia
				and		coalesce(d.ie_suspenso,'N')	= 'S')
and ((exists (	select	nr_prescricao
				from	prescr_solucao c
				where	a.nr_sequencia_solucao + nr_seq_solucao_w = c.nr_seq_solucao
				and		nr_prescricao_w		= c.nr_prescricao)) or (coalesce(a.nr_sequencia_solucao::text, '') = ''))
and	not exists ( select	nr_prescricao
				from	prescr_material e
				where	a.nr_prescricao	= e.nr_prescricao
				and		a.nr_sequencia_diluicao = e.nr_sequencia
				and		coalesce(e.ie_suspenso,'N')	= 'S')
and		((a.ie_origem_inf	<> 'K') or (Var_param1097_w = 'S') or (VarcopiaKitRec_w = 'S' AND a.nr_seq_recomendacao IS NOT NULL AND a.nr_seq_recomendacao::text <> ''))
and		((ie_copia_agora_w = 'S') or (a.ie_urgencia = 'N'))
and		((ie_copia_mat_w = 'S') or (a.ie_agrupador <> 2))
and		((ie_copia_medic_w = 'S') or (a.ie_agrupador not in (1,3,7,9)))
and		((a.nr_sequencia <> a.nr_sequencia_diluicao) or (coalesce(a.nr_sequencia_diluicao::text, '') = ''))
and		a.ie_agrupador not in (10,11,15,16)
and		a.ie_agrupador not in (3,7,9)
and		coalesce(a.nr_sequencia_diluicao::text, '') = ''
and		((ie_agrupamento_p 	<> 2) or (Var_ie_agrupa_SNE_w	= 'S') or (a.ie_agrupador 	<> 8))
 and	((ie_agrupamento_p 	<> 2) or (Var_ie_agrupa_Supl_w	= 'S') or (a.ie_agrupador 	<> 12))
and		a.nr_prescricao 	= nr_prescricao_orig_w;
	
c18 CURSOR FOR  --diluentes
SELECT  nr_prescricao_w,
	a.nr_sequencia,
	a.ie_origem_inf,
	a.cd_material,
	a.cd_unidade_medida,
	a.qt_dose,
	a.qt_unitaria,
	a.qt_material,
	dt_prescricao_w,
	nm_usuario_p,
	a.cd_intervalo,
	CASE WHEN ie_recalc_horario_p='V' THEN  reordenar_horarios(dt_inicio_prescr_tes_w, reordenar_horarios_copia(a.DS_HORARIOS))  ELSE a.DS_HORARIOS END ,
	a.ds_observacao,
	a.ds_observacao_enf,
	a.ie_via_aplicacao,
	a.nr_agrupamento,
	coalesce(a.ie_cobra_paciente,'S'),
	CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.cd_motivo_baixa  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  0  ELSE a.cd_motivo_baixa END  END ,
	CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  clock_timestamp()  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  null  ELSE clock_timestamp() END  END ,
	a.ie_utiliza_kit,
	a.cd_unidade_medida_dose,
	a.nr_seq_via_acesso,
	a.qt_conversao_dose,
	CASE WHEN VarCopiaCheckAgora_w='S' THEN a.ie_urgencia  ELSE 'N' END ,
	a.nr_ocorrencia,
	a.qt_total_dispensar,
	a.cd_fornec_consignado,
	CASE WHEN coalesce(a.nr_sequencia_solucao::text, '') = '' THEN  null  ELSE a.nr_sequencia_solucao + nr_seq_solucao_w END ,
	CASE WHEN coalesce(a.nr_sequencia_proc::text, '') = '' THEN  null  ELSE a.nr_sequencia_proc + nr_seq_proc_w END ,
	a.qt_solucao,
	null,
	null,
	a.ds_dose_diferenciada,
	a.ie_medicacao_paciente,
	nr_sequencia_w,
	CASE WHEN a.ie_se_necessario='S' THEN  null  ELSE CASE WHEN ie_recalc_horario_p='N' THEN  a.HR_PRIM_HORARIO WHEN ie_recalc_horario_p='V' THEN  a.HR_PRIM_HORARIO  ELSE to_char(to_date('30/12/1899'||substr(dt_primeiro_horario_p,1,5),'dd/mm/yyyy hh24:mi'),'hh24:mi') END  END ,
	CASE WHEN coalesce(a.NR_SEQUENCIA_DIETA::text, '') = '' THEN null  ELSE a.NR_SEQUENCIA_DIETA + nr_seq_dieta_w END ,
	a.IE_AGRUPADOR,
	a.nr_dia_util,
	CASE WHEN b.ie_situacao='A' THEN  'N'  ELSE 'S' END ,
	a.ie_se_necessario,
	a.qt_min_aplicacao,
	a.ie_bomba_infusao,
	coalesce(a.IE_APLIC_BOLUS,'N'),
	coalesce(a.IE_APLIC_LENTA,'N'),
	CASE WHEN ie_copia_acm_w='S' THEN coalesce(a.ie_acm,'N')  ELSE 'N' END ,
	a.ie_objetivo,
	a.cd_topografia_cih,
	a.ie_origem_infeccao,
	a.cd_amostra_cih,
	a.cd_microorganismo_cih,
	coalesce(a.ie_uso_antimicrobiano,'N'),
	a.cd_protocolo,
	a.nr_seq_protocolo,
	a.nr_seq_mat_protocolo,
	a.qt_hora_aplicacao,
	'N',
	A.QT_VEL_INFUSAO,
	CASE WHEN VarCopiaJust_w='S' THEN a.ds_justificativa  ELSE '' END ,
	a.ie_sem_aprazamento,
	a.ie_indicacao,
	a.dt_proxima_dose,
	a.qt_total_dias_lib,
	a.nr_seq_substituto,
	a.ie_lado,
	a.dt_inicio_medic,	
	a.qt_dia_prim_hor,
	CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.ie_regra_disp  ELSE null END ,
	a.qt_vol_adic_reconst,
	a.qt_hora_intervalo,
	a.qt_min_intervalo,
	ie_permite_substituir,
	a.ds_observacao_far,
	nr_seq_mat_diluicao,
	b.ie_dias_util_medic,
	a.qt_qsp_diluente,
	a.ie_aplicar
From	Material b,
	Prescr_Material a
where	((coalesce(substr(obter_se_material_padronizado(cd_estabelecimento_w, b.cd_material),1,1) ,'S') = 'S') or (ie_nao_padronizado_w = 'S'))
  and	b.ie_situacao	= 'A'
  and	a.cd_material 	= b.cd_material
  and	((coalesce(a.nr_sequencia_diluicao::text, '') = '') or
		a.nr_sequencia_diluicao not in (
			SELECT	x.nr_sequencia
			from	material y,
				prescr_material x
			where	y.cd_material = x.cd_material
			and	((y.ie_situacao <> 'A') or
				 ((ie_nao_padronizado_w = 'N') and (coalesce(substr(obter_se_material_padronizado(cd_estabelecimento_w, y.cd_material),1,1) ,'S') = 'N')))
			and	((ie_copia_medic_w = 'S') or (x.ie_agrupador <> 1))
			and	x.nr_prescricao = nr_prescricao_orig_w))
  and	exists (select 1
	
	where	coalesce(a.nr_sequencia_proc::text, '') = ''
	
union all

	select 1
	
	where	ie_procedimento_p = 'S'
	
union all

	select 1
	from	Prescr_procedimento b
	where	ie_procedimento_p 	= 'C'
	and	(a.nr_sequencia_proc IS NOT NULL AND a.nr_sequencia_proc::text <> '')
	and	b.nr_prescricao		= nr_prescricao_orig_w
	and	b.nr_sequencia		= a.nr_sequencia_proc
	and	consiste_copia_prescr_rotina(b.nr_seq_proc_interno, b.cd_procedimento, b.ie_origem_proced,
			b.nr_seq_exame, ie_procedimento_p, ie_exame_w) = 'S')
  and	not exists (
	select	nr_prescricao
	from	prescr_dieta b
	where	a.nr_prescricao	= b.nr_prescricao
	and	a.nr_sequencia_dieta = b.nr_sequencia
	and	coalesce(b.ie_suspenso,'N')	= 'S')
and not exists (
	select nr_prescricao
	from	prescr_solucao c
	where	a.nr_prescricao	= c.nr_prescricao
	and	a.nr_sequencia_solucao = c.nr_seq_solucao
	and	coalesce(c.ie_suspenso,'N')	= 'S')
	and not exists (
	select	nr_prescricao
	from	prescr_procedimento d
	where	a.nr_prescricao	= d.nr_prescricao
	and	a.nr_sequencia_proc	= d.nr_sequencia
	and	coalesce(d.ie_suspenso,'N')	= 'S')
and not exists (
					select	nr_prescricao
					from	prescr_material e
					where	a.nr_prescricao	= e.nr_prescricao
					and	a.nr_sequencia_diluicao = e.nr_sequencia
					and	coalesce(e.ie_suspenso,'N')	= 'S'
				)
and	((Varie_copia_prescr_w = 'S') or (coalesce(b.ie_disponivel_mercado,'N') <> 'N'))
and	coalesce(a.nr_sequencia_dieta::text, '') = ''
and	((a.nr_sequencia <> a.nr_sequencia_diluicao) or (coalesce(a.nr_sequencia_diluicao::text, '') = ''))
and	((a.ie_origem_inf	<> 'K') or (VarcopiaKitRec_w	= 'S' AND a.nr_seq_recomendacao IS NOT NULL AND a.nr_seq_recomendacao::text <> ''))
and	((ie_copia_agora_w = 'S') or (a.ie_urgencia = 'N'))
and	((ie_copia_mat_w = 'S') or (a.ie_agrupador <> 2))
and	a.ie_agrupador in (3,7,9)
and	coalesce(a.nr_sequencia_proc::text, '') = ''
and	((varie_copia_acm_w = 'S') or (coalesce(ie_acm,'N') = 'N'))
and	((varie_copia_sn_w = 'S') or (coalesce(a.ie_se_necessario,'N') = 'N'))
and	((coalesce(a.ie_suspenso,'N')	<> 'S') or (ie_copia_suspensas_p = 'S'))
and	a.nr_sequencia_diluicao		= nr_sequencia_orig_w
and		a.nr_prescricao 	= nr_prescricao_orig_w
and	((var_copia_diluicao_w <> 'N') or ((ie_gerar_diluicao_w = 'P') and (obter_prioridade_diluente(nr_prescricao_ww, nr_sequencia_orig_w, cd_material_ww, CASE WHEN a.ie_agrupador=3 THEN  'N' WHEN a.ie_agrupador=7 THEN  'R' WHEN a.ie_agrupador=9 THEN  'S' END ) <> '0')))
and	((ie_gerar_dil_setor_w = 'S') or (var_copia_diluicao_w = 'T'));

c11 CURSOR FOR
SELECT	a.nr_sequencia + nr_seq_proc_w,
		coalesce(a.nr_agrupamento,1),
		a.ie_executar_leito,
		a.cd_procedimento,
		a.qt_procedimento,
		a.ds_horarios,
		a.ds_observacao,
		a.ds_observacao_enf,
		a.ie_origem_proced,
		a.cd_intervalo,
		a.cd_setor_atendimento,
		coalesce(ds_ind_clinica_w,a.ds_dado_clinico),
		CASE WHEN ie_data_prescr_w='S' THEN CASE WHEN coalesce(nr_seq_exame,0)=0 THEN obter_data_prev_exec(dt_prescricao_p,dt_procedimento_p,a.cd_setor_atendimento, nr_prescricao_w,'A')  ELSE dt_prescricao_p END   ELSE obter_data_prev_exec(dt_prescricao_p,dt_procedimento_p,a.cd_setor_atendimento, nr_prescricao_w,'A') END ,
		a.cd_material_exame,
		a.nr_seq_exame,
		a.ds_material_especial,
		a.ie_origem_inf,
		coalesce(a.ie_se_necessario,'N'),
		coalesce(a.ie_acm,'N'),
		a.nr_ocorrencia,
		a.nr_seq_proc_interno,
		a.qt_peca_ap,
		a.ds_qualidade_peca_ap,
		a.ds_diag_provavel_ap,
		a.ds_exame_anterior_ap,
		a.nr_seq_derivado,
		a.nr_seq_exame_sangue,
		CASE WHEN coalesce(a.nr_seq_solic_sangue::text, '') = '' THEN null  ELSE nr_seq_bco_w END ,
		a.cd_unid_med_sangue,
		a.cd_pessoa_coleta,
		a.qt_vol_hemocomp,
		a.nr_seq_prot_glic,
		a.ie_respiracao,
		a.cd_mod_vent,
		a.ie_disp_resp_esp,
		a.qt_fluxo_oxigenio,
		a.ds_rotina,
		a.qt_hora_intervalo,
		a.qt_min_intervalo,
		a.ie_lado,
		a.cd_protocolo,
		a.nr_seq_protocolo,
		a.cd_medico_exec,
		a.ie_tipo_proced,
		a.ie_forma_exame,
		a.nr_sequencia,
		a.dt_proxima_dose,
		a.nr_seq_topografia,
		a.nr_seq_rotina, -- mjgoncalves OS 675145/712328
		a.ie_urgencia,
		a.qt_frasco_env,
		a.cd_setor_coleta
from	prescr_procedimento a
where	coalesce(obter_dados_exame_lab_rep(cd_perfil_w, cd_especialidade_w, cd_setor_prescr_w, nr_seq_exame, cd_estabelecimento_w, 'C'), 'S') = 'S'
and		((VarBancoSangue_w = 'S') or (coalesce(nr_seq_solic_sangue::text, '') = ''))
and		consiste_se_copia_proc_int(a.nr_seq_proc_interno) = 'S'
and		(((ie_copia_nenhum_w = 'S') and (consiste_copia_prescr_rotina(a.nr_seq_proc_interno, a.cd_procedimento, a.ie_origem_proced, a.nr_seq_exame, ie_procedimento_p, ie_exame_w) = 'S')) or
		 (ie_copia_nenhum_w = 'N' AND ie_procedimento_p = 'N'))
and		coalesce(a.ie_em_protocolo_vanco, 'N') = 'N'
and		((coalesce(a.ie_suspenso,'N')	<> 'S') or (ie_copia_suspensas_p = 'S'))
and		ie_origem_inf	<> 'L'
and		coalesce(nr_seq_origem::text, '') = ''
and		nr_prescricao = nr_prescricao_orig_w
and		substr(Obter_Situacao_Proced_Prescr(cd_procedimento, ie_origem_proced, nr_seq_proc_interno),1,1) = 'A'
and             obter_se_exame_solicitado(a.nr_seq_exame) = 'S';

c19 CURSOR FOR
SELECT	nr_sequencia,
		nr_seq_prot_glic,
		nr_seq_anterior
From	Prescr_Procedimento a
where	((coalesce(a.ie_suspenso,'N')	<> 'S') or (ie_copia_suspensas_p = 'S'))
and		ie_origem_inf	<> 'L'
and		coalesce(nr_seq_origem::text, '') = ''
and		coalesce(Obter_dados_exame_lab_rep(cd_perfil_w, cd_especialidade_w, cd_setor_prescr_w, nr_seq_exame, cd_estabelecimento_w, 'C'), 'S') = 'S'
and		((VarBancoSangue_w = 'S') or
		 (VarBancoSangue_w = 'T' AND ie_agrupamento_p	<> 2) or (coalesce(nr_seq_solic_sangue::text, '') = ''))
and		consiste_copia_prescr_rotina(a.nr_seq_proc_interno, a.cd_procedimento, a.ie_origem_proced, a.nr_seq_exame, ie_procedimento_p, ie_exame_w) = 'S'
and		nr_prescricao	= nr_prescricao_w;
		
c20 CURSOR FOR
SELECT	qt_fluxo_sangue,
		qt_sessao_sem,
		qt_hora_sessao,
		qt_min_sessao,
		nr_seq_mod_dialisador,
		ie_ultrafiltracao,
		qt_ultrafiltracao,
		ie_tipo_hemodialise,
		ie_tipo_dialise,
		ie_tipo_peritoneal,
		nr_seq_maq_cicladora,
		qt_peso_ideal,
		nr_seq_diametro_agulha,
		nr_seq_tipo_agulha,
		nr_seq_tipo_agulha_art,
		nr_seq_perfil_sodio,
		qt_zero_um,
		qt_um_dois,
		qt_dois_tres,
		qt_tres_quatro,
		ie_ligar_prime,
		qt_peso_seco,
		ds_observacao,
		IE_CATEGORIA,
		nr_seq_ultra,
		qt_sodio,
		qt_calcio,
		qt_bicarbonato,
		ie_cateter,
		qt_zero_um_bic,
		qt_um_dois_bic,
		qt_dois_tres_bic,
		qt_tres_quatro_bic,
		qt_quatro_cinco_bic,
		qt_cinco_seis_bic,
		nr_seq_perfil_bic
from	hd_prescricao
where	nr_prescricao	= nr_prescricao_orig_w;

c0020 CURSOR FOR
SELECT	nr_seq_solucao,
		ie_tipo_solucao
from	prescr_solucao
where	nr_prescricao = nr_prescricao_w
and		nr_seq_dialise = nr_sequencia_w;

C21 CURSOR FOR
SELECT	nr_sequencia
from	nut_pac_elemento
where	nr_seq_nut_pac	= (	Select	min(b.nr_sequencia)
				from	nut_pac b
				where	b.nr_prescricao = nr_prescricao_orig_w
				and	b.ie_npt_adulta	= 'S')
order by nr_sequencia;

C22 CURSOR FOR
SELECT	nr_sequencia
from	nut_pac_elem_mat
where	nr_seq_nut_pac	= (	Select	min(b.nr_sequencia)
				from	nut_pac b
				where	b.nr_prescricao = nr_prescricao_orig_w
				and	b.ie_npt_adulta	= 'S')
order by nr_sequencia;	

c23 CURSOR FOR
SELECT	nr_sequencia,
	cd_procedimento,
	ie_origem_proced,
	cd_setor_atendimento
from 	prescr_procedimento
where	nr_prescricao	= nr_prescricao_w;

c24 CURSOR FOR
SELECT	a.ie_destino_rec,
		a.ds_recomendacao,
		a.qt_recomendacao,
		'N',
		a.cd_intervalo,
		a.nr_seq_classif,
		a.cd_recomendacao,
		CASE WHEN ie_recalc_horario_p='V' THEN  reordenar_horarios(dt_inicio_prescr_tes_w, reordenar_horarios_copia(a.DS_HORARIOS))  ELSE a.DS_HORARIOS END ,
		a.ds_observacao,
		a.ie_urgencia,
		CASE WHEN ie_recalc_horario_p='N' THEN  a.HR_PRIM_HORARIO WHEN ie_recalc_horario_p='V' THEN  a.HR_PRIM_HORARIO  ELSE to_char(to_date('30/12/1899'||substr(dt_primeiro_horario_p,1,5),'dd/mm/yyyy hh24:mi'),'hh24:mi') END ,
		a.nr_seq_topografia,
		a.ie_faose,
		a.ie_acm,
		a.ie_se_necessario,
		a.ie_alterar_horario,
		a.cd_kit
FROM prescr_recomendacao a
LEFT OUTER JOIN tipo_recomendacao b ON (a.cd_recomendacao = b.cd_tipo_recomendacao)
WHERE coalesce(b.ie_copia,'S')	= 'S' and a.nr_prescricao 	= nr_prescricao_orig_w and ((coalesce(a.ie_suspenso,'N')	<> 'S') or (ie_copia_suspensas_p = 'S')) order by a.nr_sequencia;

c25 CURSOR FOR
SELECT	a.nr_sequencia,
		obter_dispensacao_anterior(a.nr_prescricao_original, a.cd_material, a.qt_dose)
from	prescr_material a
where	a.nr_prescricao = nr_prescricao_w
and		a.ie_agrupador = 5
order by a.nr_sequencia;

c26 CURSOR FOR
SELECT	a.nr_sequencia,
		b.ds_material,
		'M' ie_tipo_item
from	material b,
		prescr_material a
where	a.cd_material 	= b.cd_material
and		a.nr_prescricao	= nr_prescricao_orig_w
and		(a.dt_suspensao IS NOT NULL AND a.dt_suspensao::text <> '')
and		coalesce(a.nr_seq_kit::text, '') = ''
and		coalesce(a.nr_sequencia_diluicao::text, '') = ''
and		coalesce(a.nr_sequencia_proc::text, '') = ''

union all

select	a.nr_sequencia,
		b.ds_procedimento,
		'P' ie_tipo_item
from	procedimento b,
		prescr_procedimento a
where	a.cd_procedimento	= b.cd_procedimento
and		a.ie_origem_proced	= b.ie_origem_proced
and		a.nr_prescricao		= nr_prescricao_orig_w
and		(a.dt_suspensao IS NOT NULL AND a.dt_suspensao::text <> '')

union all

select	a.nr_sequencia,
		b.ds_tipo_recomendacao,
		'R' ie_tipo_item
from	tipo_recomendacao b,
		prescr_recomendacao a
where	a.cd_recomendacao	= b.cd_tipo_recomendacao
and		a.nr_prescricao		= nr_prescricao_orig_w
and		(a.dt_suspensao IS NOT NULL AND a.dt_suspensao::text <> '');

C27 CURSOR FOR
	SELECT	nr_sequencia
	from	cih_def_infect
	where	nr_prescricao = nr_prescricao_orig_w
	and	nr_seq_prescr = nr_sequencia_orig_w;
	
c30 CURSOR FOR
SELECT	nr_seq_elemento        ,
		cd_unidade_medida      ,
		qt_elem_kg_dia         ,
		qt_diaria              ,
		qt_volume            ,
		qt_volume_corrigido,
		qt_volume_etapa,
		nr_sequencia nr_seq_ele_rep
from	prescr_rep_he_elem
where	nr_seq_rep_he = nr_seq_rep_he_w;

c30_w	c30%rowtype;

C31 CURSOR FOR
	SELECT  nr_seq_protocolo
	from	prescr_solucao
	where	((ie_copia_agora_w = 'S') or (ie_urgencia = 'N'))
	and		((coalesce(ie_suspenso,'N')	<> 'S') or (ie_copia_suspensas_p = 'S'))
	and		nr_prescricao = nr_prescricao_orig_w;
	
C32 CURSOR FOR
	SELECT	cd_kit
	from	kit_mat_recomendacao
	where	((coalesce(cd_perfil,0) = 0) or (cd_perfil = cd_perfil_w))
	and		((coalesce(cd_setor_atendimento,0) = 0) or (cd_setor_atendimento = cd_setor_prescr_w))
	and		((coalesce(cd_convenio::text, '') = '') or (cd_convenio = cd_convenio_w))
	and		((coalesce(nr_seq_agrupamento::text, '') = '') or (nr_seq_agrupamento = nr_seq_agrupamento_w))
	and		cd_recomendacao  	= cd_recomendacao_rec_w;	


C33 CURSOR FOR
	SELECT	a.cd_material,
			a.nr_sequencia,
			a.ie_agrupador
	From	Material b,
		Prescr_Material a
	where	a.nr_prescricao 	= nr_prescricao_orig_w
	and	((coalesce(a.ie_suspenso,'N')	<> 'S') or (ie_copia_suspensas_p = 'S'))
	and		b.ie_situacao	= 'A'
	and		a.ie_origem_inf	<> 'K'
	and		((ie_copia_agora_w = 'S') or (coalesce(a.ie_urgencia, 'N') = 'N'))				
	and		((ie_copia_mat_w = 'S') or (a.ie_agrupador <> 2))
	and		a.ie_agrupador not in (10,11, 15)
	and		((ie_copia_medic_w	= 'S') or (a.ie_agrupador not in (1,3,7,9)))
	and		((a.nr_sequencia	<> a.nr_sequencia_diluicao) or (coalesce(a.nr_sequencia_diluicao::text, '') = ''))
	and		((coalesce(substr(obter_se_material_padronizado(cd_estabelecimento_w, b.cd_material),1,1) ,'S') = 'S') or (ie_nao_padronizado_w	= 'S'))
	and		a.cd_material 		= b.cd_material
	and		a.nr_sequencia_dieta	= nr_sequencia_w
	and		((coalesce(a.nr_sequencia_diluicao::text, '') = '') or
			a.nr_sequencia_diluicao not in (
					SELECT	x.nr_sequencia
					from	material y,
							prescr_material x
					where	y.cd_material = x.cd_material
					and		((y.ie_situacao <> 'A') or
							((ie_nao_padronizado_w = 'N') and (coalesce(substr(obter_se_material_padronizado(cd_estabelecimento_w, y.cd_material),1,1) ,'S') = 'N')))
					and		x.nr_prescricao = nr_prescricao_orig_w))
					and		exists (select 1
							
							where	coalesce(a.nr_sequencia_proc::text, '') = ''
							
union all

							select 1
							
							where	ie_procedimento_p = 'S'
							
union all

							select 1
							from	Prescr_procedimento b
							where	ie_procedimento_p 	= 'C'
							and		(a.nr_sequencia_proc IS NOT NULL AND a.nr_sequencia_proc::text <> '')
							and		b.nr_prescricao		= nr_prescricao_orig_w
							and		b.nr_sequencia		= a.nr_sequencia_proc
							and		consiste_copia_prescr_rotina(b.nr_seq_proc_interno, b.cd_procedimento, b.ie_origem_proced,
									b.nr_seq_exame, ie_procedimento_p, ie_exame_w) = 'S'
							)
					and		not exists (
							select	nr_prescricao
							from	prescr_dieta b
							where	a.nr_prescricao	= b.nr_prescricao
							and		a.nr_sequencia_dieta = b.nr_sequencia
							and	coalesce(b.ie_suspenso,'N')	= 'S')
					and 	not exists (
							select	nr_prescricao
							from	prescr_solucao c
							where	a.nr_prescricao	= c.nr_prescricao
							and		a.nr_sequencia_solucao = c.nr_seq_solucao
							and	coalesce(c.ie_suspenso,'N')	= 'S')
					and 	not exists (
							select	nr_prescricao
							from	prescr_procedimento d
							where	a.nr_prescricao	= d.nr_prescricao
							and		a.nr_sequencia_proc	= d.nr_sequencia
							and	coalesce(d.ie_suspenso,'N')	= 'S')
					and 	not exists (
							select	nr_prescricao
							from	prescr_material e
							where	a.nr_prescricao	= e.nr_prescricao
							and	a.nr_sequencia_diluicao = e.nr_sequencia
							and	coalesce(e.ie_suspenso,'N')	= 'S');

c34 CURSOR FOR
	SELECT	a.nr_sequencia_proc,
			a.nr_sequencia,
			a.nr_prescricao
	from	prescr_material a
	where	a.nr_prescricao = nr_prescricao_w
	and		a.ie_agrupador = 5
	order by a.nr_sequencia;							
	
	

BEGIN
CALL gravar_processo_longo(obter_desc_expressao(781472)/*'Realizando a Copia da Prescricao'*/
,'COPIA_PRESCRICAO',2);
select	coalesce(max(cd_estabelecimento),1),
		max(cd_setor_atendimento),
		max(coalesce(ie_adep,obter_se_setor_adep(cd_setor_atendimento))),
		max(ie_adep),
		max(nr_atendimento),
		max(obter_convenio_atendimento(nr_atendimento)),
		max(dt_validade_prescr)
into STRICT	cd_estab_origem_w,
		cd_setor_atendimento_w,
		ie_rep_adep_w,
		ie_adep_param_w,
		nr_atendimento_w,
		cd_convenio_w,
		dt_validade_prescr_ww
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

cd_estabelecimento_w 	:= obter_estab_atend(nr_atendimento_p);

select	max(ie_copia_albumina)
into STRICT	ie_copia_albumina_w
from	parametro_medico
where	cd_estabelecimento	= cd_estabelecimento_w;

select	max(ie_gera_disp_acm_sn)
into STRICT	ie_gera_disp_acm_sn_w
from	parametros_farmacia
where	cd_estabelecimento	= cd_estabelecimento_w;

ds_ind_clinica_w	:= substr(ds_ind_clinica_p,1,255);

nr_prescricoes_w	:= ',' || nr_prescricoes_p || ',';
nr_prescricoes_w	:= replace(nr_prescricoes_w, ' ',',');
nr_prescricoes_w	:= replace(nr_prescricoes_w, ',,',',');

--cd_perfil_w	:= obter_perfil_ativo;
cd_perfil_w		:= cd_perfil_p;
cd_estab_usuario_w	:= Obter_estab_usuario(nm_usuario_p);

if (coalesce(cd_estabelecimento_p,0) > 0) then
	cd_estab_usuario_w	:= cd_estabelecimento_p;
end if;

VarExibeItensNaoCopiados_w := Obter_Param_Usuario(-16, 14, cd_perfil_p, nm_usuario_p, cd_estab_usuario_w, VarExibeItensNaoCopiados_w);
varcopia_medicaEsten_w := Obter_Param_Usuario(950, 115, cd_perfil_w, nm_usuario_p, cd_estab_usuario_w, varcopia_medicaEsten_w);
ie_copiar_def_infecto_w := Obter_Param_Usuario(7043, 28, cd_perfil_w, nm_usuario_p, cd_estab_usuario_w, ie_copiar_def_infecto_w);

CALL wheb_assist_pck.set_informacoes_usuario(cd_estabelecimento_p, cd_perfil_w, nm_usuario_p);
qt_hora_ww := wheb_assist_pck.obterValorParametroREP(22, qt_hora_ww);
cd_intervalo_param_w := wheb_assist_pck.obterValorParametroREP(35, cd_intervalo_param_w);
ie_copia_medic_w := wheb_assist_pck.obterValorParametroREP(39, ie_copia_medic_w);
var_pac_usu_w := wheb_assist_pck.obterValorParametroREP(42, var_pac_usu_w);
VarConsisteDataFutura_w := wheb_assist_pck.obterValorParametroREP(44, VarConsisteDataFutura_w);
Prescr_dia_w := wheb_assist_pck.obterValorParametroREP(52, Prescr_dia_w);
VarBancoSangue_w := wheb_assist_pck.obterValorParametroREP(60, VarBancoSangue_w);
ie_copia_agora_w := wheb_assist_pck.obterValorParametroREP(85, ie_copia_agora_w);
ie_calcula_validade_w := wheb_assist_pck.obterValorParametroREP(98, ie_calcula_validade_w);
ie_nao_padronizado_w := wheb_assist_pck.obterValorParametroREP(111, ie_nao_padronizado_w);
ie_copia_mat_w := wheb_assist_pck.obterValorParametroREP(121, ie_copia_mat_w);
VarCopiaJust_w := wheb_assist_pck.obterValorParametroREP(135, VarCopiaJust_w);
var_setores_usuario_w := wheb_assist_pck.obterValorParametroREP(136, var_setores_usuario_w);
ie_hora_sne_w := wheb_assist_pck.obterValorParametroREP(146, ie_hora_sne_w);
VarSetorEntregaUsuario_w := wheb_assist_pck.obterValorParametroREP(167, VarSetorEntregaUsuario_w);
ie_horario_sem_apraso_w := wheb_assist_pck.obterValorParametroREP(207, ie_horario_sem_apraso_w);
VarIdentPrescrADEP_w := wheb_assist_pck.obterValorParametroREP(246, VarIdentPrescrADEP_w);
ie_agrupa_prescr_atend_w := wheb_assist_pck.obterValorParametroREP(254, ie_agrupa_prescr_atend_w);
ie_regra_medic_w := wheb_assist_pck.obterValorParametroREP(259, ie_regra_medic_w);
qt_dietas_orais_w := wheb_assist_pck.obterValorParametroREP(298, qt_dietas_orais_w);
ie_peso_prescr_org_w := wheb_assist_pck.obterValorParametroREP(319, ie_peso_prescr_org_w);
nr_horas_copia_w := wheb_assist_pck.obterValorParametroREP(348, nr_horas_copia_w);
ie_copia_acm_w := wheb_assist_pck.obterValorParametroREP(369, ie_copia_acm_w);
ie_copia_nao_liberadas_w := wheb_assist_pck.obterValorParametroREP(370, ie_copia_nao_liberadas_w);
ie_copiar_peso_w := wheb_assist_pck.obterValorParametroREP(380, ie_copiar_peso_w);
ie_copiar_altura_w := wheb_assist_pck.obterValorParametroREP(381, ie_copiar_altura_w);
VarConsistePrescrMesmoDia_w := wheb_assist_pck.obterValorParametroREP(382, VarConsistePrescrMesmoDia_w);
ie_copia_farm_clinica_w := wheb_assist_pck.obterValorParametroREP(434, ie_copia_farm_clinica_w);
ie_recalcular_sol_w := wheb_assist_pck.obterValorParametroREP(448, ie_recalcular_sol_w);
ie_copiar_hemodialise_w := wheb_assist_pck.obterValorParametroREP(474, ie_copiar_hemodialise_w);
ie_receita_prescr_w := wheb_assist_pck.obterValorParametroREP(475, ie_receita_prescr_w);
ie_copia_REP_motivo_w := wheb_assist_pck.obterValorParametroREP(496, ie_copia_REP_motivo_w);
ie_funcao_agrupar_w := wheb_assist_pck.obterValorParametroREP(497, ie_funcao_agrupar_w);
ie_justificativa_novo_w := wheb_assist_pck.obterValorParametroREP(502, ie_justificativa_novo_w);
ie_informa_validade_copia_w := wheb_assist_pck.obterValorParametroREP(523, ie_informa_validade_copia_w);
ie_prescr_hor_sem_lib_w := wheb_assist_pck.obterValorParametroREP(530, ie_prescr_hor_sem_lib_w);
Var_param_548_w := wheb_assist_pck.obterValorParametroREP(548, Var_param_548_w);
VarPermiteRealizarPrimPrescr_w := wheb_assist_pck.obterValorParametroREP(563, VarPermiteRealizarPrimPrescr_w);
ie_prescritor_aux_w := wheb_assist_pck.obterValorParametroREP(580, ie_prescritor_aux_w);
ie_gera_dil_comp_sol_w := wheb_assist_pck.obterValorParametroREP(601, ie_gera_dil_comp_sol_w);
ie_relancar_assoc_proc_w := wheb_assist_pck.obterValorParametroREP(603, ie_relancar_assoc_proc_w);
Var_ie_agrupa_SNE_w := wheb_assist_pck.obterValorParametroREP(618, Var_ie_agrupa_SNE_w);
Var_ie_agrupa_Supl_w := wheb_assist_pck.obterValorParametroREP(619, Var_ie_agrupa_Supl_w);
VarRecalculaProcInterv_w := wheb_assist_pck.obterValorParametroREP(627, VarRecalculaProcInterv_w);
ie_data_prescr_w := wheb_assist_pck.obterValorParametroREP(638, ie_data_prescr_w);
ie_copia_motivo_w := wheb_assist_pck.obterValorParametroREP(656, ie_copia_motivo_w);
ds_classif_setor_w := wheb_assist_pck.obterValorParametroREP(699, ds_classif_setor_w);
VarAtualizaDiasAtend_w := wheb_assist_pck.obterValorParametroREP(720, VarAtualizaDiasAtend_w);
ie_motivo_prescr_w := wheb_assist_pck.obterValorParametroREP(724, ie_motivo_prescr_w);
VarIePrimHorCopia_w := wheb_assist_pck.obterValorParametroREP(790, VarIePrimHorCopia_w);
ie_kit_automatico_w := wheb_assist_pck.obterValorParametroREP(810, ie_kit_automatico_w);
cd_setor_copia_w := wheb_assist_pck.obterValorParametroREP(846, cd_setor_copia_w);
ie_considera_tipo_mat_w := wheb_assist_pck.obterValorParametroREP(849, ie_considera_tipo_mat_w);
nr_horas_validade_padrao_w := wheb_assist_pck.obterValorParametroREP(850, nr_horas_validade_padrao_w);
varie_copia_acm_w := wheb_assist_pck.obterValorParametroREP(859, varie_copia_acm_w);
varie_copia_sn_w := wheb_assist_pck.obterValorParametroREP(860, varie_copia_sn_w);
VarIe_copia_proced_w := wheb_assist_pck.obterValorParametroREP(862, VarIe_copia_proced_w);
ie_copia_nenhum_w := wheb_assist_pck.obterValorParametroREP(908, ie_copia_nenhum_w);
ie_param911_w := wheb_assist_pck.obterValorParametroREP(911, ie_param911_w);
VarPrimHorNPT_w := wheb_assist_pck.obterValorParametroREP(918, VarPrimHorNPT_w);
VarIeAjustarDispAssoc_w := wheb_assist_pck.obterValorParametroREP(922, VarIeAjustarDispAssoc_w);
VarCopiaCheckAgora_w := wheb_assist_pck.obterValorParametroREP(930, VarCopiaCheckAgora_w);
VarcopiaKitRec_w := wheb_assist_pck.obterValorParametroREP(933, VarcopiaKitRec_w);
Varie_copia_prescr_w := wheb_assist_pck.obterValorParametroREP(943, Varie_copia_prescr_w);
varcopia_retr_w := wheb_assist_pck.obterValorParametroREP(956, varcopia_retr_w);
ie_so_setor_paciente_w := wheb_assist_pck.obterValorParametroREP(975, ie_so_setor_paciente_w);
varIecopiaOutroEstab_w := wheb_assist_pck.obterValorParametroREP(996, varIecopiaOutroEstab_w);
ie_copia_obs_w := wheb_assist_pck.obterValorParametroREP(997, ie_copia_obs_w);
ie_copia_obs_prescr_w := wheb_assist_pck.obterValorParametroREP(1002, ie_copia_obs_prescr_w);
ie_copia_pca_w := wheb_assist_pck.obterValorParametroREP(1005, ie_copia_pca_w);
ie_espec_desconsiderar_w := wheb_assist_pck.obterValorParametroREP(1053, ie_espec_desconsiderar_w);
VarDataCopiaPrescricao_w := wheb_assist_pck.obterValorParametroREP(1059, VarDataCopiaPrescricao_w);
VarParam1062_W := wheb_assist_pck.obterValorParametroREP(1062, VarParam1062_W);
var_copia_diluicao_w := wheb_assist_pck.obterValorParametroREP(1077, var_copia_diluicao_w);
ie_fator_correcao_w := wheb_assist_pck.obterValorParametroREP(1082, ie_fator_correcao_w);
Var_param1097_w := wheb_assist_pck.obterValorParametroREP(1097, Var_param1097_w);
VarGerarNiveisGlic_w := wheb_assist_pck.obterValorParametroREP(1124, VarGerarNiveisGlic_w);
ie_limp_prim_hor_acm_w := wheb_assist_pck.obterValorParametroREP(445, ie_limp_prim_hor_acm_w);
ie_param443_w := wheb_assist_pck.obterValorParametroREP(443, ie_param443_w);
ie_horas_fixas_npt_w := wheb_assist_pck.obterValorParametroREP(1149, ie_horas_fixas_npt_w);
ie_seleciona_kit_rec_w := wheb_assist_pck.obterValorParametroREP(458, ie_seleciona_kit_rec_w);
ie_atualizar_kit_rec_w := wheb_assist_pck.obterValorParametroREP(1181, ie_atualizar_kit_rec_w);

VarCalcularEtapaSolucao_w := Obter_Param_Usuario(924, 461, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, VarCalcularEtapaSolucao_w);
VarCalculaVolumeVelocidade_w := Obter_Param_Usuario(924, 636, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, VarCalculaVolumeVelocidade_w);
VarCalculaTempoSolucao_w := Obter_Param_Usuario(924, 394, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, VarCalculaTempoSolucao_w);
ie_arredondar_etapa_w := Obter_Param_Usuario(924, 742, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_arredondar_etapa_w);


if (ie_agrupamento_p	<> 2) then
	nr_horas_copia_w	:= 0;
end if;

qt_hora_w	:= Campo_Numerico(qt_hora_ww);

if	((coalesce(nr_atendimento_p,0) > 0) or (VarConsisteDataFutura_w = 'S')) then
	qt_hor_fut_sem_atend_w := wheb_assist_pck.obterValorParametroREP(1091, qt_hor_fut_sem_atend_w);	
	if (coalesce(nr_atendimento_p,0) = 0) and (coalesce(qt_hor_fut_sem_atend_w,0) > 0) then
		qt_hora_w	:=	qt_hor_fut_sem_atend_w;
	end if;
	
	if (qt_hora_w > 0) and
		((clock_timestamp() + qt_hora_w / 24) < dt_prescricao_p) then
		--'A data da prescricao nao pode ser superior a ' ||qt_hora_w || ' horas a partir deste momento !');
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(178446,'QT_HORAS='||qt_hora_w);
	end if;
	
end if;

if (VarPermiteRealizarPrimPrescr_w = 'S') then
	select	count(*)
	into STRICT	qt_prescr_w
	from	prescr_medica where	nr_atendimento = nr_atendimento_p
	and	obter_classif_setor(cd_setor_atendimento) <> 1
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and	obter_tipo_atendimento(nr_atendimento) = 1 LIMIT 1;
	
	if (qt_prescr_w > 0) then
		--'O paciente ja possui uma prescricao. Parametro [563]. #@#@
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(178450);
	end if;
end if;

if (nr_atendimento_p > 0) and (ie_so_setor_paciente_w = 'S') then
	cd_setor_paciente_w	:= Obter_Setor_Atendimento(nr_atendimento_p);
end if;

if (var_pac_usu_w = 'U') then
	begin
	cd_setor_usuario_w := Wheb_usuario_pck.get_cd_setor_atendimento;

	if (coalesce(cd_setor_usuario_w::text, '') = '') or (cd_setor_usuario_w = 0) then
		cd_setor_usuario_w	:=	obter_setor_usuario(nm_usuario_p);
	end if;

	select	count(*)
	into STRICT	qt_registro_w
	from	setor_atendimento a where 	a.cd_setor_atendimento in (	SELECT	b.cd_setor_atendimento
						from	atend_paciente_unidade b
						where	b.nr_atendimento	= NR_ATENDIMENTO_P
						and	b.cd_setor_atendimento	= cd_setor_usuario_w ) LIMIT 1;
	exception
	when others then
		qt_registro_w	:= 0;
	end;
end if;

if (cd_setor_atendimento_w > 0) then
	cd_prescr_orig_w	:= cd_setor_atendimento_w;
end if;

if (var_pac_usu_w = 'C') then
    nm_maquina_w := substr(wheb_usuario_pck.get_machine,position('\' in wheb_usuario_pck.get_machine) /*'*/+ 1, 40);   --Colocado o /*'*/
 devido ao tratamento realizado no instr()
	Select 	max(cd_setor_atendimento)
	into	cd_setor_prescr_w
	from	computador
	where	nm_computador_pesquisa = padronizar_nome(upper(nm_maquina_w)); 
elsif	(((var_pac_usu_w = 'U') and (nr_atendimento_p > 0) and (qt_registro_w > 0)) or
	 ((var_pac_usu_w = 'U') and (var_setores_usuario_w = 'S'))) then
	cd_setor_prescr_w	:= cd_setor_usuario_w;
	cd_setor_atendimento_w	:= cd_setor_prescr_w;
elsif	(var_pac_usu_w = 'R') then
	cd_setor_prescr_w	:= Obter_setor_prescr_regra(cd_perfil_p);
	cd_setor_atendimento_w	:= cd_setor_prescr_w;
elsif	(var_pac_usu_w = 'A') then
	cd_setor_prescr_w		:= Obter_unidade_atendimento(nr_atendimento_p,'A','CS');
	cd_setor_atendimento_w	:= cd_setor_prescr_w;
elsif	(var_pac_usu_w = 'B') then
	cd_setor_prescr_w		:= null;
	cd_setor_atendimento_w	:= null;
elsif	(nr_atendimento_p > 0) then
	if	(nr_atendimento_w is not null) and
		(cd_estabelecimento_w <> cd_estab_origem_w) then
		select	nvl(max(a.cd_setor_atendimento),nvl(obter_unidade_atendimento(nr_atendimento_w,'IA','CS'), obter_unidade_atendimento(nr_atendimento_w,'A','CS')))
		into	cd_setor_prescr_w
		from	atend_paciente_unidade a
		where	a.nr_seq_interno = obter_atepacu_paciente(nr_atendimento_p, 'A');
	else
		cd_setor_prescr_w := nvl(obter_unidade_atendimento(nr_atendimento_p,'IA','CS'), obter_unidade_atendimento(nr_atendimento_p,'A','CS'));
	end if;
	cd_setor_atendimento_w	:= cd_setor_prescr_w;
end if;

if	(ie_calcula_validade_w	= 'R') then
	ie_calcula_validade_w	:= obter_se_calcula_validade(cd_setor_prescr_w);
end if;


select	max(nr_seq_agrupamento)
into	nr_seq_agrupamento_w
from	setor_atendimento
where	cd_setor_atendimento = cd_setor_prescr_w;

if	(cd_prescr_orig_w is null) then
	cd_prescr_orig_w	:= cd_setor_atendimento_w;
end if;

select	nvl(max(ie_copiar_nutricao),'S'),
		nvl(max(ie_copiar_solucao),'S'),    
		nvl(max(ie_copiar_medic),'S'),        
		nvl(max(ie_copiar_mat),'S'),
		nvl(max(ie_copiar_proced),'S'),
		nvl(max(ie_copiar_gas),'S'),          
		nvl(max(ie_copiar_hem),'S'),
		nvl(max(ie_copiar_rec),'S')
into	ie_copiar_nutricao_w,
		ie_copiar_solucao_w,    
		ie_copiar_medic_w,        
		ie_copiar_mat_w,          
		ie_copiar_proced_w,       
		ie_copiar_gas_w,          
		ie_copiar_hem_w,          
		ie_copiar_rec_w
from	rep_copia_itens
where	nvl(cd_classif_setor_orig,obter_classif_setor(cd_prescr_orig_w)) = obter_classif_setor(cd_prescr_orig_w)
and		nvl(cd_classif_setor_dest,obter_classif_setor(cd_setor_prescr_w)) = obter_classif_setor(cd_setor_prescr_w)
and	((cd_perfil is null) or (cd_perfil = cd_perfil_p));

wheb_assist_pck.obterValorParametroREP(23,qt_hora_ww);
qt_hora_w	:= Campo_Numerico(qt_hora_ww);

if	(to_char(dt_prescricao_p,'hh24') >= to_char(qt_hora_w)) and
	(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescricao_p) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(sysdate)) then
	--'Prescricoes para o mesmo dia so podem ser feitas ate as ' ||qt_hora_w || ' horas !');
	Wheb_mensagem_pck.exibir_mensagem_abort(178453, 'QT_HORAS='||qt_hora_w);
end if;

if	(NR_ATENDIMENTO_P > 0) then
	select	dt_entrada
	into	dt_entrada_w
	from	atendimento_paciente
	where	nr_atendimento = nr_atendimento_p;

	if	(dt_entrada_w > DT_PRESCRICAO_P) then
		--'A data da prescricao nao pode ser menor que a data do atendimento'||dt_entrada_w);
		Wheb_mensagem_pck.exibir_mensagem_abort(178455, 'DATA='||dt_entrada_w);
	end if;
end if;


ie_exame_w	:= nvl(ie_exames_p,ie_procedimento_p);

Select Prescr_medica_seq.nextval
into  nr_prescricao_w
from dual;

nr_nova_prescricao_p	:= nr_prescricao_w;

select 	nvl(max('1'),'3'),
	nvl(max(a.ie_tipo_evolucao),'3')
into	ie_origem_inf_w,
	ie_origem_inf_filtro_w
from	Medico b,
	Usuario a
where 	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
and	a.nm_usuario		= nm_usuario_p
and	b.ie_situacao		= 'A';

begin
select	cd_pessoa_fisica
into	cd_prescritor_w
from	usuario
where	nm_usuario = nm_usuario_p;
exception
when others then
	cd_prescritor_w	:= null;
end;


begin
Select	cd_pessoa_fisica,
	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescricao),
	dt_prescricao
into	cd_pessoa_fisica_ww,
	dt_prescricao_ww,
	dt_prescricao_www
from prescr_medica
where nr_prescricao = nr_prescricao_p;
exception
when others then
	--'Nao existe a prescricao informada ');
	Wheb_mensagem_pck.exibir_mensagem_abort(178456);
end;
if	(nr_atendimento_p > 0) then
	select	cd_pessoa_fisica
	into	cd_pessoa_fisica_w
	from	atendimento_paciente
	where	nr_atendimento	= nr_atendimento_p;
else
	cd_pessoa_fisica_w	:= nvl(cd_pessoa_fisica_p, cd_pessoa_fisica_ww);
end if;

dt_primeiro_horario_w	:= to_date('30/12/1899' || substr(dt_primeiro_horario_p,1,5),'dd/mm/yyyy hh24:mi');
/*
select	Obter_Prim_Horario_Prescricao(nvl(nr_atendimento_p,0),DT_PRESCRICAO_P,NM_USUARIO_P)
into	dt_primeiro_horario_w
from	dual;
*/
--if	(ie_recalc_horario_p = 'S') and --> Rafael em 27/8/8 OS : 95944 / 96333;
if	(ie_recalc_horario_p not in('N','V')) and
	(nr_atendimento_p > 0) then
	wheb_assist_pck.obterValorParametroREP(311,ie_prescr_agora_pa_w);
		if (ie_prescr_agora_pa_w = 'S') then
			Select	max(cd_classif_setor)
			into	cd_classif_setor_w
			from	setor_atendimento
			where	cd_setor_atendimento = (select Obter_Unidade_Atendimento(nr_atendimento_p,'A','CS') from dual);

			if	(cd_classif_setor_w	= '1') then
				dt_prim_horario_w	:= to_char(sysdate + 10/1440,'dd/mm/yyyy hh24:mi:ss');
				dt_primeiro_horario_w	:= to_date(substr(dt_prim_horario_w,1,15)||'0:00','dd/mm/yyyy hh24:mi:ss');
			end if;
		end if;
end if;

if	(cd_setor_prescr_w > 0) then
	select	nvl(max(ie_adep),'N')
	into	ie_rep_adep_w
	from	setor_atendimento
	where	cd_setor_atendimento = cd_setor_prescr_w;
end if;

if	(ie_calcula_validade_w not in ('N', 'V')) and
	(nr_prescr_origem_fut_p is null) then
	wheb_assist_pck.obterValorParametroREP(249,ie_estender_w);
	nr_horas_validade_w	:= obter_horas_validade_prescr(dt_primeiro_horario_w,NR_ATENDIMENTO_P, ie_estender_w,null, sysdate,null);
elsif	(ie_informa_validade_copia_w = 'S') and
	(nr_horas_validade_p is not null) then
	nr_horas_validade_w := nr_horas_validade_p;
elsif	(nvl(nr_horas_validade_padrao_w,0) > 0) then
	nr_horas_validade_w := nr_horas_validade_padrao_w;
end if;

select	max(ie_dia_seguinte),
		nvl(max(ie_gerar_diluicao),'S')
into	ie_dia_seguinte_w,
		ie_gerar_dil_setor_w
from	setor_atendimento
where	cd_setor_atendimento = cd_setor_prescr_w;

if (cd_setor_prescr_w is not null) and
   (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(sysdate) < ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescricao_P)) and
   (ie_dia_seguinte_w = 'N') then
   --'Neste setor nao e permitido fazer prescricoes para o dia seguinte! #@#@');
   Wheb_mensagem_pck.exibir_mensagem_abort(178457);
end if;


select	nvl(max(ie_permite_prescricao),'S')
into	ie_permite_prescr_w
from	setor_atendimento
where	cd_setor_atendimento = cd_setor_prescr_w;

if	(ie_permite_prescr_w = 'N') then
      --'Nao e permitido fazer prescricoes para este setor!');
      Wheb_mensagem_pck.exibir_mensagem_abort(178458);
end if;

if	(VarIdentPrescrADEP_w = 'DS') then
	ie_adep_w := ie_rep_adep_w;
elsif	(VarIdentPrescrADEP_w = 'NV') then
	ie_adep_w := 'N';
elsif	(VarIdentPrescrADEP_w = 'SV') then
	ie_adep_w := 'S';
elsif	(VarIdentPrescrADEP_w = 'PV') or
	(VarIdentPrescrADEP_w = 'PNV') then
	ie_adep_w := ie_adep_param_w;
end if;

nr_atendimento_ww := nr_atendimento_p;
if	(nvl(nr_atendimento_p,0) = 0) then
	wheb_assist_pck.obterValorParametroREP(729,VarVincularAtendPaciente_w);
	if (VarVincularAtendPaciente_w = 'S') then
		select	max(nr_atendimento)
		into		nr_atendimento_ww
		from		atendimento_paciente a
		where	cd_pessoa_fisica = cd_pessoa_fisica_w
		and		cd_estabelecimento = cd_estab_usuario_w
		and		ie_tipo_atendimento = 1
		and		dt_alta is null
		and		ie_fim_conta <> 'F';
	elsif (VarVincularAtendPaciente_w = 'T') then
		select	max(nr_atendimento)
		into		nr_atendimento_ww
		from		atendimento_paciente a
		where	cd_pessoa_fisica = cd_pessoa_fisica_w
		and		cd_estabelecimento = cd_estab_usuario_w
		and		dt_alta is null
		and		ie_fim_conta <> 'F';
	else
		nr_atendimento_ww := null;
	end if;
end if;

if (VarSetorEntregaUsuario_w = 'S') then
	cd_setor_entrega_w := obter_setor_usuario(nm_usuario_p);
elsif (VarSetorEntregaUsuario_w = 'P') and
	(cd_setor_prescr_w is not null) then
	cd_setor_entrega_w := cd_setor_prescr_w;
end if;

insert into prescr_medica (
		nr_prescricao,
		cd_pessoa_fisica,
		nr_atendimento,
		cd_medico,
		dt_prescricao,
		dt_atualizacao,
		nm_usuario,
		nm_usuario_original,
		ds_observacao,
		nr_horas_validade,
		cd_motivo_baixa,
		dt_baixa,
		dt_primeiro_horario,
		dt_liberacao,
		dt_emissao_setor,
		dt_emissao_farmacia,
		cd_setor_atendimento,
		dt_entrada_unidade,
		ie_recem_nato,
		ie_origem_inf,
		nr_prescricao_anterior,
		nr_prescricao_mae,
		cd_protocolo,
		nr_seq_protocolo,
		nr_seq_agenda,
		cd_estabelecimento,
		ds_medicacao_uso,
		cd_prescritor,
		qt_altura_cm,
		qt_peso,
		ie_adep,
		ie_prescr_emergencia,
		ie_prescricao_alta,
		ie_hemodialise,
		ie_motivo_prescricao,
		nr_prescricoes,
		ie_prescritor_aux,
		nr_doc_conv,
		nr_seq_pepo,
		nr_prescricao_original,
		cd_setor_entrega,
		nr_prescr_orig_fut,
		ie_tipo_prescr_cirur)
select	nr_prescricao_w,
		cd_pessoa_fisica_w,
		nr_atendimento_ww,
		cd_medico_p,
		dt_prescricao_w,
		dt_prescricao_w,
		nm_usuario_p,
		nm_usuario_p,
		decode(ie_copia_obs_prescr_w,'S',ds_observacao,null),
		nvl(nr_horas_validade_w,nr_horas_validade),
		null,
		null,
		dt_primeiro_horario_w,
		null,
		null,
		null,
		cd_setor_prescr_w,
		null,
		nvl(IE_RECEM_NATO,'N'),
		nvl(ie_origem_inf_w,'1'),
		nr_prescricao_p,
		nr_prescricao_mae,
		cd_protocolo,
		nr_seq_protocolo,
		null,
		decode(varIecopiaOutroEstab_w,'S',cd_estab_usuario_w,cd_estabelecimento),
		ds_medicacao_uso,
		cd_prescritor_w,
		decode(ie_copiar_altura_w, 'S', obter_sinal_vital(nr_atendimento_P,obter_desc_expressao(283402)/*'Altura'*/), 0),
		decode(ie_copiar_peso_w, 'S', decode(ie_peso_prescr_org_w, 'S', qt_peso, obter_ultimo_sinal_vital_pf(cd_pessoa_fisica,'Peso')), null),
		ie_adep_w,
		decode(varcopia_retr_w,'S', nvl(ie_prescr_emergencia,'N'),'N'),
		'N',
		decode(ie_copiar_hemodialise_w,'S',decode(ie_hemodialise,'P',null,ie_hemodialise)),
		decode(ie_motivo_prescr_w,'',decode(ie_copia_motivo_w, 'S' ,decode(Obter_Se_exibe_motivo_REP(ie_motivo_prescricao, cd_perfil_p), 'S' ,ie_motivo_prescricao)),Obter_Se_exibe_motivo_REP(ie_motivo_prescr_w, cd_perfil_p), 'S' , ie_motivo_prescr_w), -- Copia motivo da Prescr
		nr_prescricoes_p,
		decode(ie_prescritor_aux_w,'S', 'S',null),
		nr_doc_conv,
		nr_seq_pepo,
		nr_prescricao,
		nvl(cd_setor_entrega_w, cd_setor_entrega),
		nr_prescr_origem_fut_p,
		ie_tipo_prescr_cirur
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

select	max(dt_inicio_prescr),
		max(dt_validade_prescr)
into	dt_inicio_prescr_w,
		dt_validade_prescr_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_w;

if	(VarConsistePrescrMesmoDia_w = 'S') then
	select	max(dt_inicio_prescr),
		max(dt_validade_prescr),
		max(nr_horas_validade)
	into	dt_inicio_prescr_aux_w,
		dt_validade_prescr_aux_w,
		nr_horas_validade_aux_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_w;


	dt_validade_prescr_aux_w := dt_inicio_prescr_aux_w + nvl(nr_horas_validade_aux_w,24) / 24;
	dt_validade_prescr_aux_w := trunc(dt_validade_prescr_aux_w,'hh24') - 1/86400;


	if	(nr_horas_validade_aux_w = 24) and
		(Obter_Min_Entre_Datas(dt_inicio_prescr_aux_w, dt_validade_prescr_aux_w, 1) < 1440) then
		rollback;
		--'Esta prescricao possui menos de 24 horas de validade! Parametro [382].  #@#@');
		Wheb_mensagem_pck.exibir_mensagem_abort(178459);
	end if;

end if;

if	(ie_copiar_nutricao_w = 'S') then
	insert into prescr_nutricao(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_prescricao,
		ie_delegacao_total,
		ie_dieta_oral,
		ie_npt,
		ie_enteral,
		ie_suplemento,
		ds_observacao)
	select	prescr_nutricao_seq.nextval,
		sysdate,
		nm_usuario_p,
		sysdate,
		nm_usuario_p,
		nr_prescricao_w,
		ie_delegacao_total,
		ie_dieta_oral,
		ie_npt,
		ie_enteral,
		ie_suplemento,
		ds_observacao
	from	prescr_nutricao
	where	nr_prescricao	= NR_PRESCRICAO_P;
end if;

cd_especialidade_w	:= obter_especialidade_medico(cd_prescritor_w, 'C');

-- INICIO => CRIACAO C001
ds_sql_cursor_w	:= '';
-- Restricoes genericas do WHERE
ds_sql_where_w	:=	'';
ds_sql_where_w	:=	ds_sql_where_w || ' and coalesce(a.ie_emergencia,''N'') <> ''S'' ';
ds_sql_where_w	:=	ds_sql_where_w || ' and Obter_se_copia_rep(a.ie_motivo_prescricao, ''' || cd_perfil_p || ''', ''' || nm_usuario_p || ''', a.nr_prescricao) = ''S'' ';
ds_sql_where_w	:=	ds_sql_where_w || ' and not exists (SELECT 1 from cirurgia b where a.nr_prescricao = b.nr_prescricao) ';

if	(nvl(VarParam1062_W,'S') <> 'S') then
	ds_sql_where_w	:=	ds_sql_where_w || ' and	coalesce(a.nr_seq_atend::text, '') = '' ';
end if;

if	(nvl(varIecopiaOutroEstab_w,'S') <> 'S') then
	ds_sql_where_w	:=	ds_sql_where_w || ' and	a.cd_estabelecimento = ' || nvl(cd_estabelecimento_p,1) || ' ';
end if;

if	(nvl(ie_copia_suspensas_p,'S') <> 'S') then
	ds_sql_where_w	:=	ds_sql_where_w || ' and	coalesce(a.dt_suspensao::text, '') = '' ';
end if;

if	(nvl(ie_copia_farm_clinica_w,'S') <> 'S') then
	ds_sql_where_w	:=	ds_sql_where_w || ' and coalesce(a.ie_prescr_farm,''N'')	= ''N'' ';
end if;

if	(nvl(ie_copia_pca_w,'S') <> 'S') then
	ds_sql_where_w	:=	ds_sql_where_w || ' and not exists (select 1 from prescr_solucao x where x.nr_prescricao = a.nr_prescricao and coalesce(x.ie_solucao_pca,''N'') = ''S'') ';
end if;

if	(ie_espec_desconsiderar_w is not null) then
	ds_sql_where_w	:=	ds_sql_where_w || ' and obter_se_contido_char(obter_especialidade_medico(a.cd_prescritor,''XX''),''' || ie_espec_desconsiderar_w || ''') = ''N'' ';
end if;

if	(ds_classif_setor_w is not null) then
	ds_sql_where_w	:=	ds_sql_where_w || ' and obter_se_contido(obter_classif_setor(a.cd_setor_atendimento), ''' || ds_classif_setor_w || ''') = ''S'' ';
end if;

if	(nvl(ie_copia_nao_liberadas_w,'S') not in ('N','M')) then
	ds_sql_where_w	:=	ds_sql_where_w || ' and (coalesce(a.dt_liberacao,a.dt_liberacao_medico) IS NOT NULL AND (coalesce(a.dt_liberacao,a.dt_liberacao_medico))::text <> '') ';
end if;

if	(cd_setor_copia_w is not null) then
	ds_sql_where_w	:=	ds_sql_where_w || ' and obter_se_contido(a.cd_setor_atendimento, ''' || cd_setor_copia_w || ''') = ''S'' ';
end if;

-- 1 consulta das prescricoes
if	(nr_prescricoes_p is null) then
	if	(ds_sql_cursor_w is not null) then
		ds_sql_cursor_w	:= ds_sql_cursor_w || ' 
union
 ';
	end if;


	ds_sql_cursor_w		:=	ds_sql_cursor_w ||
							' select	a.nr_prescricao ' ||
							' from		prescr_medica a ' ||
							' where		a.nr_prescricao = ' || nvl(nr_prescricao_p,0) ||
							ds_sql_where_w;

	if	(ie_funcao_agrupar_w is not null) then
		ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and obter_se_contido_char(a.ie_funcao_prescritor, '''|| ie_funcao_agrupar_w || ''') = ''S'' ';
	end if;


	if	(hr_prescr_inicial_p is not null) then
		ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and a.dt_prescricao >= to_date(to_char(a.dt_prescricao, ''dd/mm/yyyy'') || ''' || hr_prescr_inicial_p || ''', ''dd/mm/yyyy hh24:mi'') ';
	end if;


	if	(hr_prescr_final_p is not null) then
		ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and a.dt_prescricao <= to_date(to_char(a.dt_prescricao, ''dd/mm/yyyy'') || ''' || hr_prescr_final_p || ''', ''dd/mm/yyyy hh24:mi'') ';
	end if;

	if	(nvl(nr_horas_copia_w,0) > 0) and
		(VarDataCopiaPrescricao_w in ('P', 'V', 'F')) then
		if	(VarDataCopiaPrescricao_w = 'P') then
			ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and a.dt_prescricao >= clock_timestamp() - ''' || nr_horas_copia_w/24 || ''' ';
		elsif	(VarDataCopiaPrescricao_w = 'V') then
			ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and a.dt_inicio_prescr >= clock_timestamp() - ''' || nr_horas_copia_w/24 || ''' ';
		elsif	(VarDataCopiaPrescricao_w = 'F') then
			ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and dt_validade_prescr	>= clock_timestamp() - ''' || nr_horas_copia_w/24 || ''' ';
		end if;
	elsif   (VarDataCopiaPrescricao_w = 'I') then 
		    ds_sql_cursor_w :=  ds_sql_cursor_w || ' and dt_validade_prescr = to_date('''||to_char(dt_validade_prescr_ww,'dd/mm/yyyy hh24:mi:ss')||''',''dd/mm/yyyy hh24:mi:ss'') ';
	end if;
	
end if;

-- Agrupa prescricoes filhas
if	(ie_agrupamento_p = 1) then
	if	(ds_sql_cursor_w is not null) then
		ds_sql_cursor_w	:= ds_sql_cursor_w || ' 
union
 ';
	end if;


	ds_sql_cursor_w	:=	ds_sql_cursor_w ||
						' select	a.nr_prescricao ' ||
						' from		prescr_medica a ' ||
						' where		a.nr_prescricao_mae = nr_prescricao_p ' ||
						' and		a.nr_prescricao not in (' || nvl(nr_prescricao_p,0) || ',' || nvl(nr_prescricao_w,0) || ') ' ||
						ds_sql_where_w;


	if	(nvl(ie_copia_nao_liberadas_w,'S') not in ('N','M')) then
		ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and (coalesce(a.dt_liberacao,a.dt_liberacao_medico) IS NOT NULL AND (coalesce(a.dt_liberacao,a.dt_liberacao_medico))::text <> '') ';
	end if;


-- Agrupa prescricoes do mesmo dia
elsif	(ie_agrupamento_p = 2) then
	if	(ds_sql_cursor_w is not null) then
		ds_sql_cursor_w	:= ds_sql_cursor_w || ' 
union
 ';
	end if;


	ds_sql_cursor_w	:=	ds_sql_cursor_w ||
						' select	a.nr_prescricao ' ||
						' from		prescr_medica a ' ||
						' where		a.cd_pessoa_fisica = ''' || cd_pessoa_fisica_ww || ''' ' ||
						' and		a.nr_prescricao not in (' || nvl(nr_prescricao_p,0) || ',' || nvl(nr_prescricao_w,0) || ') ' ||
						ds_sql_where_w;


	if	(ie_funcao_agrupar_w is not null) then
		ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and obter_se_contido_char(a.ie_funcao_prescritor, '''|| ie_funcao_agrupar_w || ''') = ''S'' ';
	end if;


	if	(hr_prescr_inicial_p is not null) then
		ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and a.dt_prescricao >= to_date(to_char(a.dt_prescricao, ''dd/mm/yyyy'') || ''' || hr_prescr_inicial_p || ''', ''dd/mm/yyyy hh24:mi'') ';
	end if;


	if	(hr_prescr_final_p is not null) then
		ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and a.dt_prescricao <= to_date(to_char(a.dt_prescricao, ''dd/mm/yyyy'') || ''' || hr_prescr_final_p || ''', ''dd/mm/yyyy hh24:mi'') ';
	end if;


	if	(nvl(ie_copia_REP_motivo_w,'S') <> 'S') then
		ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and coalesce(a.ie_motivo_prescricao::text, '') = '' ';
	end if;


	if	(nvl(ie_so_setor_paciente_w,'N') <> 'N') then
		ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and a.cd_setor_atendimento = ''' || cd_setor_paciente_w || ''' ';
	end if;


	if	(nvl(ie_agrupa_prescr_atend_w,'N') <> 'N') then
		if	(ie_agrupa_prescr_atend_w = 'S') then
			ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and nr_atendimento = ' || nvl(nr_atendimento_p,0) || ' ';
		end if;
	end if;


	if	(nvl(ie_copia_nao_liberadas_w,'N') <> 'N') then
		ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and (coalesce(a.dt_liberacao,a.dt_liberacao_medico) IS NOT NULL AND (coalesce(a.dt_liberacao,a.dt_liberacao_medico))::text <> '') ';
	end if;


	if	(nvl(nr_horas_copia_w,0) > 0) and
		(VarDataCopiaPrescricao_w in ('P', 'V', 'F')) then
			if	(VarDataCopiaPrescricao_w = 'P') then
				ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and a.dt_prescricao >= clock_timestamp() - ''' || nr_horas_copia_w/24 || ''' ';
			elsif	(VarDataCopiaPrescricao_w = 'V') then
				ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and a.dt_inicio_prescr >= clock_timestamp() - ''' || nr_horas_copia_w/24 || ''' ';
			elsif	(VarDataCopiaPrescricao_w = 'F') then
				ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and dt_validade_prescr	>= clock_timestamp() - ''' || nr_horas_copia_w/24 || ''' ';
			end if;
	elsif   (VarDataCopiaPrescricao_w = 'I') then 
		ds_sql_cursor_w :=  ds_sql_cursor_w || ' and dt_validade_prescr = to_date('''||to_char(dt_validade_prescr_ww,'dd/mm/yyyy hh24:mi:ss')||''',''dd/mm/yyyy hh24:mi:ss'') ';
	else
		ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_prescricao)	= ''' || dt_prescricao_ww ||''' ';
	end if;

	if	(nvl(Prescr_dia_w,'N') <> 'N') then
		if	(Prescr_dia_w = 'F') then
			ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and Obter_Dados_Usuario_Opcao(a.nm_usuario_original,''F'') = ''' || ie_origem_inf_filtro_w || ''' ';
		elsif	(Prescr_dia_w = 'A') then
			ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and ((Obter_Dados_Usuario_Opcao(a.nm_usuario_original,''F'') = ''' || ie_origem_inf_filtro_w || ''') or (a.ie_prescr_farm = ''S'')) ';
		elsif	(Prescr_dia_w = 'S') then
			ds_sql_cursor_w	:=	ds_sql_cursor_w || ' and a.ie_origem_inf = ''1'' ';
		end if;
	end if;
end if;

if	(ds_sql_cursor_w is not null) then
	ds_sql_cursor_w	:= ds_sql_cursor_w || ' 
union
 ';
end if;

ds_sql_cursor_w	:=	ds_sql_cursor_w ||
					' select	a.nr_prescricao ' ||
					' from		prescr_medica a ' ||
					' where		cd_pessoa_fisica = ''' || cd_pessoa_fisica_ww || ''' ' ||
					' and		obter_se_valor_contido(a.nr_prescricao,'''||nr_prescricoes_w||''') = ''S'' ' ||
					ds_sql_where_w;


if	(nvl(ie_copia_nao_liberadas_w,'S') not in ('N', 'E')) then
	ds_sql_cursor_w	:= ds_sql_cursor_w	|| ' and (coalesce(a.dt_liberacao,a.dt_liberacao_medico) IS NOT NULL AND (coalesce(a.dt_liberacao,a.dt_liberacao_medico))::text <> '') ';
elsif	(nvl(ie_copia_nao_liberadas_w,'E') not in ('N', 'M')) then 												
	ds_sql_cursor_w := ds_sql_cursor_w || ' and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')'; 		
end if;

-- FIM => CRIACAO C001
OPEN C001 for
	ds_sql_cursor_w;
LOOP
FETCH C001 INTO
	nr_prescricao_orig_w;
exit when c001%notfound;
begin
nr_prescr_w	:= nr_prescricao_orig_w || ',' || nr_prescr_w;

-- Dietas
if	(ie_copiar_nutricao_w = 'S') then
	gravar_processo_longo(obter_desc_expressao(781488)/*'Realizando a Copia das Dietas'*/
,'COPIA_PRESCRICAO',4);
	open C015;
	loop
	fetch C015 into
		nr_sequencia_w,
		cd_dieta_w,
		nm_usuario_w,
		qt_parametro_w,
		ds_horarios_w,
		ds_observacao_w,
		ie_destino_dieta_w,
		ie_refeicao_w,
		cd_intervalo_w,
		IE_VIA_APLICACAO_w;
	exit when C015%notfound;
		begin


		if	(nvl(qt_dietas_orais_w,0) > 0) then
			begin

			select 	count(*) + 1
			into	qt_dietas_prescr_w
			from 	prescr_dieta
			where 	nr_prescricao = nr_prescricao_w;


			end;
		end if;

		if	(nvl(qt_dietas_orais_w,0) = 0) or
			(qt_dietas_prescr_w <= qt_dietas_orais_w) then
			begin
			nr_seq_dieta_w	:= 0;
			ie_loop_w	:= 'S';
			while	(ie_loop_w = 'S') loop
				nr_seq_dieta_w	:= nr_seq_dieta_w + 1;
				select	count(*)
				into	qt_itens_w
				from	prescr_dieta
				where	rownum = 1
				and		nr_prescricao	= nr_prescricao_w
				and	nr_sequencia	= nr_seq_dieta_w;


				if	(qt_itens_w	= 0) then
					ie_loop_w	:= 'N';
				else
					nr_seq_dieta_w	:= nr_seq_dieta_w + 1;
				end if;
			end loop;

			select  nvl(max(a.nr_dia_util),0) + 1
			into	nr_dia_util_w
			from    prescr_dieta a,
				prescr_medica b
			where   a.nr_prescricao          = b.nr_prescricao
			and     ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_prescricao)   = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescricao_w - 1)
			and     b.nr_atendimento	 = nr_atendimento_p
			and     a.cd_dieta		 = cd_dieta_w
			and     b.nr_prescricao          <> nr_prescricao_w
			and	((b.dt_suspensao is null) or (ie_copia_suspensas_p = 'S'))
			and     a.dt_suspensao is null;


			Insert  into Prescr_Dieta (
				nr_prescricao     ,
				nr_sequencia      ,
				cd_dieta          ,
				dt_atualizacao    ,
				nm_usuario        ,
				qt_parametro      ,
				ds_horarios       ,
				ds_observacao     ,
				cd_motivo_baixa   ,
				dt_baixa          ,
				ie_destino_dieta  ,
				ie_refeicao,
				ie_suspenso,
				nr_prescricao_original,
				cd_intervalo,
				nr_dia_util,
				IE_VIA_APLICACAO)
			values( nr_prescricao_w,
				nr_seq_dieta_w,
				cd_dieta_w,
				dt_prescricao_w,
				nm_usuario_w,
				qt_parametro_w,
				substr(ds_horarios_w,1,255),
				ds_observacao_w,
				null,
				null,
				ie_destino_dieta_w,
				ie_refeicao_w,
				'N',
				nr_prescricao_orig_w,
				cd_intervalo_w,
				nr_dia_util_w,
				IE_VIA_APLICACAO_w);

			BEGIN


			select	nvl(max(nr_sequencia),0),
				nvl(max(nr_agrupamento),0)
			into	nr_seq_acum_w,
				nr_agrup_acum_w
			from	prescr_material
			where	nr_prescricao = nr_prescricao_w;

			select	max(dt_inicio_prescr)
			into	dt_inicio_prescr_tes_w
			from	prescr_medica
			where	nr_prescricao	= nr_prescricao_w;

			if      (ie_param911_w = 'C')  then
				cd_intervalo_ww := null;
				ds_horarios_ww	:= null;
			end if;




			open C33;
			loop
			fetch C33 into
				cd_material_w,
				nr_sequencia_mat_w,
				ie_agrupador_w;
			exit when C33%notfound;
				begin

				ie_loop_w	:= 'S';
				while	(ie_loop_w = 'S') loop
					--nr_seq_mat_w	:= nr_seq_mat_w + 1;
					select	count(*)
					into	qt_itens_w
					from	prescr_material
					where	rownum = 1
					and		nr_prescricao	= nr_prescricao_w
					and	nr_sequencia	= nr_seq_mat_w;


					if	(qt_itens_w	= 0) then
						ie_loop_w	:= 'N';
					else
						nr_seq_mat_w	:= nr_seq_mat_w + 1;
					end if;
				end loop;

				Insert  into Prescr_Material (
					nr_prescricao,
					nr_sequencia,
					ie_origem_inf,
					cd_material,
					cd_unidade_medida,
					qt_dose,
					qt_unitaria,
					qt_material,
					dt_atualizacao,
					nm_usuario,
					cd_intervalo,
					ds_horarios,
					ds_observacao,
					ds_observacao_enf,
					ie_via_aplicacao,
					nr_agrupamento,
					ie_cobra_paciente,
					cd_motivo_baixa,
					dt_baixa,
					ie_utiliza_kit,
					cd_unidade_medida_dose,
					qt_conversao_dose,
					ie_urgencia,
					nr_ocorrencia,
					qt_total_dispensar,
					cd_fornec_consignado,
					nr_sequencia_solucao,
					nr_sequencia_proc,
					qt_solucao,
					hr_dose_especial,
					qt_dose_especial,
					ds_dose_diferenciada,
					ie_medicacao_paciente,
					nr_sequencia_diluicao,
					hr_prim_horario,
					nr_sequencia_dieta,
					ie_agrupador,
					nr_dia_util,
					ie_suspenso,
					ie_se_necessario,
					qt_min_aplicacao,
					ie_bomba_infusao,
					ie_aplic_bolus,
					ie_aplic_lenta,
					ie_acm,
					ie_objetivo,
					cd_topografia_cih,
					ie_origem_infeccao,
					cd_amostra_cih,
					cd_microorganismo_cih,
					ie_uso_antimicrobiano,
					cd_protocolo,
					nr_seq_protocolo,
					nr_seq_mat_protocolo,
					qt_hora_aplicacao,
					ie_recons_diluente_fixo,
					qt_vel_infusao,
					ds_justificativa,
					ie_sem_aprazamento,
					ie_indicacao,
					dt_proxima_dose,
					qt_total_dias_lib,
					nr_seq_substituto,
					ie_lado,
					qt_dia_prim_hor,
					ie_regra_disp,
					qt_vol_adic_reconst,
					qt_hora_intervalo,
					qt_min_intervalo,
					ie_permite_substituir,
					nr_prescricao_original,
					ie_gerar_lote)
				select  nr_prescricao_w,
					nr_seq_mat_w,
					a.ie_origem_inf,
					a.cd_material,
					a.cd_unidade_medida,
					a.qt_dose,
					a.qt_unitaria,
					a.qt_material,
					dt_prescricao_w,
					nm_usuario_p,
					a.cd_intervalo,
					decode(ie_recalc_horario_p, 'V', reordenar_horarios(dt_inicio_prescr_tes_w, reordenar_horarios_copia(a.DS_HORARIOS)), a.DS_HORARIOS),
					a.ds_observacao,
					a.ds_observacao_enf,
					a.ie_via_aplicacao,
					a.nr_agrupamento + nr_agrup_acum_w ,
					nvl(a.ie_cobra_paciente,'S'),
					decode(nvl(a.ie_regra_disp,'X'), 'D', a.cd_motivo_baixa, decode(nvl(a.ie_cobra_paciente,'S'), 'S', 0, a.cd_motivo_baixa)),
					decode(nvl(a.ie_regra_disp,'X'), 'D', sysdate, decode(nvl(a.ie_cobra_paciente,'S'), 'S', null, sysdate)),
					a.IE_UTILIZA_KIT,
					a.CD_UNIDADE_MEDIDA_DOSE,
					a.QT_CONVERSAO_DOSE,
					'N',
					a.NR_OCORRENCIA,
					a.qt_total_dispensar,
					a.CD_FORNEC_CONSIGNADO,
					decode(a.NR_SEQUENCIA_SOLUCAO, null, null,a.NR_SEQUENCIA_SOLUCAO + nr_seq_solucao_w),
					decode(a.NR_SEQUENCIA_PROC, null, null,a.NR_SEQUENCIA_PROC + nr_seq_proc_w),
					a.qt_solucao,
					null,
					null,
					a.ds_dose_diferenciada,
					a.ie_medicacao_paciente,
					decode(a.NR_SEQUENCIA_DILUICAO, null, null,a.NR_SEQUENCIA_DILUICAO + nr_seq_acum_w),
					decode(a.ie_se_necessario, 'S', null, decode(ie_recalc_horario_p, 'N', a.HR_PRIM_HORARIO, 'V', a.HR_PRIM_HORARIO, to_char(to_date('30/12/1899'||substr(dt_primeiro_horario_p,1,5),'dd/mm/yyyy hh24:mi'),'hh24:mi'))),
					decode(a.NR_SEQUENCIA_DIETA, null,null,nr_seq_dieta_w),
					a.IE_AGRUPADOR,
					a.nr_dia_util,
					decode(b.ie_situacao, 'A', 'N', 'S'),
					a.ie_se_necessario,
					a.qt_min_aplicacao,
					a.ie_bomba_infusao,
					NVL(a.IE_APLIC_BOLUS,'N'),
					NVL(a.IE_APLIC_LENTA,'N'),
					decode(ie_copia_acm_w,'S',nvl(a.ie_acm,'N'),'N'),
					a.IE_OBJETIVO,
					a.CD_TOPOGRAFIA_CIH,
					a.IE_ORIGEM_INFECCAO,
					a.CD_AMOSTRA_CIH,
					a.CD_MICROORGANISMO_CIH,
					nvl(a.IE_USO_ANTIMICROBIANO,'N'),
					A.CD_PROTOCOLO,
					A.NR_SEQ_PROTOCOLO,
					A.NR_SEQ_MAT_PROTOCOLO,
					A.QT_HORA_APLICACAO,
					'N',
					A.QT_VEL_INFUSAO,
					decode(VarCopiaJust_w,'S',a.ds_justificativa,''),
					a.ie_sem_aprazamento,
					a.ie_indicacao,
					a.dt_proxima_dose,
					a.qt_total_dias_lib,
					a.nr_seq_substituto,
					a.ie_lado,
					--a.dt_inicio_medic,		/*David em  16/08/2008  OS 104390*/
					a.qt_dia_prim_hor,
					decode(nvl(a.ie_regra_disp,'X'), 'D', a.ie_regra_disp, null),
					a.qt_vol_adic_reconst,
					a.qt_hora_intervalo,
					a.qt_min_intervalo,
					ie_permite_substituir,
					nr_prescricao_orig_w,
					obter_se_disp_acm_sn(decode(ie_copia_acm_w,'S',nvl(a.ie_acm,'N'),'N'), a.ie_se_necessario,ie_gera_disp_acm_sn_w)
				From	Material b,
					Prescr_Material a
				where	a.cd_material 	= b.cd_material
				and		a.nr_prescricao = nr_prescricao_orig_w
				and		a.cd_material 	= cd_material_w
				and		a.nr_sequencia =  nr_sequencia_mat_w;
				
				if (ie_agrupador_w = 8) then
					gerar_elemento_mat_sne( nr_prescricao_p, nr_seq_mat_w, 'G', nm_usuario_p);
				end if;

				end;
			end loop;
			close C33;

			EXCEPTION WHEN OTHERS THEN
				nr_seq_material_delete_w	:= nr_seq_material_delete_w;
			END;
			commit;
			end;
		end if;
		end;
	end loop;
	close C015;
end if;

-- Jejum
if	(ie_copiar_nutricao_w = 'S') then
		gravar_processo_longo(obter_desc_expressao(781498)/*'Realizando a Copia do Jejum'*/
,'COPIA_PRESCRICAO',6);
        insert into rep_jejum
                (nr_sequencia,
                nr_prescricao,
                dt_atualizacao,
                nm_usuario,
                dt_atualizacao_nrec,
                nm_usuario_nrec,
                nr_seq_tipo,
                nr_seq_objetivo,
                ie_inicio,
                dt_inicio,
                qt_min_ant,
                qt_min_depois,
                dt_evento,
                ds_evento,
                ds_observacao,
                dt_fim,
                qt_hora_ant,
                qt_hora_depois,
                ie_repete_copia,
				ie_suspenso,
				nr_prescricao_original)
        select  rep_jejum_seq.nextval,
                nr_prescricao_w,
                sysdate,
                nm_usuario_p,
                sysdate,
                nm_usuario_p,
                nr_seq_tipo,
                nr_seq_objetivo,
                ie_inicio,
                dt_inicio,
                qt_min_ant,
                qt_min_depois,
                dt_evento,
                ds_evento,
                ds_observacao,
                dt_fim,
                qt_hora_ant,
                qt_hora_depois,
                ie_repete_copia,
				ie_suspenso,
				nr_prescricao
        from    rep_jejum
        where   ie_repete_copia	= 'S'
        and		((nvl(ie_suspenso,'N')	<> 'S') or
				 (ie_copia_suspensas_p = 'S'))
		and		nr_prescricao   = nr_prescricao_orig_w;
end if;
begin
select	prescr_rep_he_seq.nextval
into	nr_seq_he_w
from	dual;

insert into prescr_rep_he
			(nr_sequencia,
			nr_prescricao,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			qt_peso,
			qt_idade_dia,
			qt_idade_mes,
			qt_idade_ano,
			qt_altura_cm,
			qt_kcal_total,
			qt_kcal_kg,
			qt_etapa,
			qt_nec_hidrica_diaria,
			qt_aporte_hidrico_diario,
			qt_vel_inf_glicose,
			qt_nec_kcal_kg_dia,
			qt_nec_kcal_dia,
			qt_equipo,
			pr_conc_glic_solucao,
			ie_calculo_auto,
			ie_correcao,
			hr_prim_horario,
			qt_gotejo,
			ie_emissao,
			qt_be,
			qt_vol_desconto,
			qt_hora_validade,
			qt_hora_fase,
			ie_bomba_infusao,
			ie_magnesio,
			ie_peso_calorico)
select	nr_seq_he_w,
		nr_prescricao_w,
		sysdate,
		nm_usuario_p,
		sysdate,
		nm_usuario_p,
		qt_peso,
		qt_idade_dia,
		qt_idade_mes,
		qt_idade_ano,
		qt_altura_cm,
		qt_kcal_total,
		qt_kcal_kg,
		qt_etapa,
		qt_nec_hidrica_diaria,
		qt_aporte_hidrico_diario,
		qt_vel_inf_glicose,
		qt_nec_kcal_kg_dia,
		qt_nec_kcal_dia,
		qt_equipo,
		pr_conc_glic_solucao,
		ie_calculo_auto,
		ie_correcao,
		hr_prim_horario,
		qt_gotejo,
		ie_emissao,
		qt_be,
		qt_vol_desconto,
		qt_hora_validade,
		qt_hora_fase,
		ie_bomba_infusao,
		ie_magnesio,
		ie_peso_calorico
from	prescr_rep_he
where	nr_prescricao = nr_prescricao_orig_w;


select	max(nr_sequencia)
into	nr_seq_rep_he_w
from	prescr_rep_he
where	nr_prescricao = nr_prescricao_orig_w;

open c30;
loop
fetch c30 into
	c30_w;
exit when c30%notfound;
	select	prescr_rep_he_elem_seq.nextval
	into	nr_seq_he_elem_w
	from	dual;


	insert into prescr_rep_he_elem
			(nr_sequencia           ,
			dt_atualizacao         ,
			nm_usuario             ,
			dt_atualizacao_nrec,
			nm_usuario_nrec     ,
			nr_seq_rep_he          ,
			nr_seq_elemento        ,
			cd_unidade_medida      ,
			qt_elem_kg_dia         ,
			qt_diaria              ,
			qt_volume            ,
			qt_volume_corrigido,
			qt_volume_etapa
			)
	values	(nr_seq_he_elem_w,
			sysdate,
			nm_usuario_p,
			sysdate,
			nm_usuario_p,
			nr_seq_he_w,
			c30_w.nr_seq_elemento,
			c30_w.cd_unidade_medida,
			c30_w.qt_elem_kg_dia,
			c30_w.qt_diaria,
			c30_w.qt_volume,
			c30_w.qt_volume_corrigido,
			c30_w.qt_volume_etapa);


	insert into prescr_rep_he_elem_mat
		(nr_sequencia ,
		nr_seq_ele_rep  ,
		dt_atualizacao   ,
		nm_usuario        ,
		dt_atualizacao_nrec,
		nm_usuario_nrec     ,
		nr_seq_elem_mat    ,
		qt_volume           ,
		qt_vol_cor           ,
		qt_vol_etapa)
	select	prescr_rep_he_elem_mat_seq.nextval,
			nr_seq_he_elem_w,
			sysdate,
			nm_usuario_p,
			sysdate,
			nm_usuario_p,
			nr_seq_elem_mat    ,
			qt_volume           ,
			qt_vol_cor           ,
			qt_vol_etapa
	from	prescr_rep_he_elem_mat
	where	nr_seq_ele_rep = c30_w.nr_seq_ele_rep;


end loop;
close c30;
exception when others then
	null;
end;

-- Solucoes
if (ie_copiar_solucao_w = 'S') then
	gravar_processo_longo(obter_desc_expressao(781474)/*'Realizando a Copia das Solucoes'*/
,'COPIA_PRESCRICAO',8);


	wheb_assist_pck.obterValorParametroREP(338,VarCalculaHorSolucaoACM_w);
	wheb_assist_pck.obterValorParametroREP(372,ie_copia_SN_solucao_w);
	wheb_assist_pck.obterValorParametroREP(204,ie_gera_prim_hor_solucao_w);

	select nvl(max(nr_seq_solucao),0), nvl(max(nr_agrupamento),0)
	into nr_seq_solucao_w, nr_agrup_acum_w
	from prescr_solucao
	where nr_prescricao = nr_prescricao_w;

	Insert into Prescr_Solucao (
			nr_prescricao,
			nr_seq_solucao,
			ie_via_aplicacao,
			cd_intervalo,
			dt_atualizacao,
			nm_usuario,
			cd_unidade_medida,
			ie_tipo_dosagem,
			qt_dosagem,
			qt_solucao_total,
			qt_tempo_aplicacao,
			ds_solucao,
			qt_volume,
			nr_etapas,
			ds_horarios,
			ie_bomba_infusao,
			ie_suspenso,
			nr_agrupamento,
			ie_esquema_alternado,
			ie_calc_aut,
			ie_acm,
			hr_prim_horario,
			qt_hora_fase,
			ie_urgencia,
			ds_orientacao,
			ie_hemodialise,
			ie_tipo_solucao,
			ie_pos_dialisador,
			nr_seq_protocolo,
			ie_unid_vel_inf,
			qt_temp_solucao,
			ie_apap,
			qt_dose_ataque,
			ie_se_necessario,
			ie_solucao_pca,
			ie_tipo_analgesia,
			ie_pca_modo_prog,
			qt_vol_infusao_pca,
			qt_bolus_pca,
			qt_intervalo_bloqueio,
			qt_limite_quatro_hora,
			qt_dose_inicial_pca,
			ie_solucao_especial,
			ie_etapa_especial,
			nr_prescricao_original,
			ie_um_dose_inicio_pca,
			ie_um_fluxo_pca,
			ie_um_limite_pca,
			qt_limite_uma_hora,
			ie_um_bolus_pca,
			ie_um_limite_hora_pca,
			nr_prescricao_anterior,
			nr_sequencia_anterior,
			ie_fator_correcao,
			cd_protocolo)
	select	nr_prescricao_w,
			nr_seq_solucao + nr_seq_solucao_w,
			ie_via_aplicacao,
			cd_intervalo,
			dt_prescricao_w,
			nm_usuario_p,
			cd_unidade_medida,
			ie_tipo_dosagem,
			decode(ie_recalcular_sol_w, 'S', Calcular_Vol_Total_Solucao(ie_tipo_dosagem,qt_tempo_aplicacao, nvl(qt_solucao_total,0) - nvl(qt_dose_ataque,0), qt_dosagem, nr_prescricao, nr_seq_solucao, 1), qt_dosagem),
			qt_solucao_total,
			qt_tempo_aplicacao,
			ds_solucao,
			decode(nvl(ie_acm,'N'),'S',qt_volume,DIVIDIR(QT_SOLUCAO_TOTAL,NR_ETAPAS)),
			nr_etapas,
			decode(ie_gera_prim_hor_solucao_w,'B',null,ds_horarios),
			ie_bomba_infusao,
			'N',
			nr_agrupamento + nr_agrup_acum_w,
			nvl(ie_esquema_alternado,'N'),
			nvl(ie_calc_aut,'N'),
			nvl(ie_acm,'N'),
			decode(ie_gera_prim_hor_solucao_w,'B',null,nvl(hr_prim_hor_w, hr_prim_horario)),
			qt_hora_fase,
			'N',
			ds_orientacao,
			ie_hemodialise,
			ie_tipo_solucao,
			ie_pos_dialisador,
			nr_seq_protocolo,
			ie_unid_vel_inf,
			qt_temp_solucao,
			ie_apap,
			qt_dose_ataque,
			decode(ie_copia_SN_solucao_w,'S',nvl(ie_se_necessario,'N'),'N'),
			ie_solucao_pca,
			ie_tipo_analgesia,
			ie_pca_modo_prog,
			qt_vol_infusao_pca,
			qt_bolus_pca,
			qt_intervalo_bloqueio,
			qt_limite_quatro_hora,
			qt_dose_inicial_pca,
			ie_solucao_especial,
			'N',
			nr_prescricao,
			ie_um_dose_inicio_pca,
			ie_um_fluxo_pca,
			ie_um_limite_pca,
			qt_limite_uma_hora,
			ie_um_bolus_pca,
			ie_um_limite_hora_pca,
			nr_prescricao,
			nr_seq_solucao,
			nvl(ie_fator_correcao,ie_fator_correcao_w),
			cd_protocolo
	from	prescr_solucao
	where	((ie_copia_agora_w = 'S') or
			 (nvl(ie_urgencia,'N') = 'N'))
	and		((nvl(ie_suspenso,'N')	<> 'S') or
			 (ie_copia_suspensas_p = 'S'))
	and		nr_prescricao = nr_prescricao_orig_w;


	commit;


	if	(VarCalculaHorSolucaoACM_w = 'N') then
		update	prescr_solucao
		set	hr_prim_horario = null
		where	nr_prescricao	= nr_prescricao_w
		and	((ie_acm = 'S') or (ie_se_necessario = 'S'));
	end if;


	insert into prescr_solucao_esquema(
			nr_sequencia,
			nr_prescricao,
			nr_seq_solucao,
			dt_atualizacao,
			nm_usuario,
			qt_volume,
			qt_dosagem,
			ds_horario)
	Select	prescr_solucao_esquema_seq.nextval,
			nr_prescricao_w,
			b.nr_seq_solucao + nr_seq_solucao_w,
			sysdate,
			nm_usuario_p,
			b.qt_volume,
			b.qt_dosagem,
			b.ds_horario
	from	prescr_solucao_esquema b,
			prescr_solucao a
	where	a.nr_prescricao	= b.nr_prescricao
	and		a.nr_seq_solucao = b.nr_seq_solucao
	and		((ie_copia_agora_w = 'S') or
			 (a.ie_urgencia = 'N'))
	and		((nvl(a.ie_suspenso,'N') <> 'S') or
			 (ie_copia_suspensas_p = 'S'))
	and		a.nr_prescricao = nr_prescricao_orig_w;
end if;
-- Recomendacoes
if	(ie_copiar_rec_w = 'S') then
	gravar_processo_longo(obter_desc_expressao(781502)/*'Realizando a Copia das Recomendacoes'*/
,'COPIA_PRESCRICAO',10);


	wheb_assist_pck.obterValorParametroREP(968,varKitMateAutomatico_w);


	select	max(dt_inicio_prescr)
	into	dt_inicio_prescr_tes_w
	from	prescr_medica
	where	nr_prescricao	= nr_prescricao_w;
	
	if (ie_atualizar_kit_rec_w = 'S') then 
		
		select 	MAX(cd_protocolo),
				MAX(nr_seq_protocolo)
		into	cd_protocolo_prescr_w,
				nr_seq_prot_prescr_w
		from   	PRESCR_MEDICA
		where 	nr_prescricao = nr_prescricao_w;
		
	end if;	

    open c24;
	loop
	fetch c24 into	ie_destino_rec_w,
					ds_recomendacao_rec_w,
					qt_recomendacao_rec_w,
					ie_suspenso_rec_w,
					cd_intervalo_rec_w,
					nr_seq_classif_rec_w,
					cd_recomendacao_rec_w,
					ds_horarios_rec_w,
					ds_observacao_rec_w,
					ie_urgencia_rec_w,
					hr_prim_horario_rec_w,
					nr_seq_topografia_rec_w,
					ie_faose_rec_w,
					ie_acm_rec_w,
					ie_se_necessario_rec_w,
					ie_alterar_horario_rec_w,
					cd_kit_rec_w;
	exit when c24%notfound;
		begin
		
		
		if (ie_atualizar_kit_rec_w = 'S') then
		
			if (cd_protocolo_prescr_w is not null)
				and (nr_seq_prot_prescr_w is not null) then

					select	nvl(max(cd_kit),cd_kit_rec_w)
					into	cd_kit_rec_w
					from	protocolo_medic_rec
					where	cd_recomendacao = cd_recomendacao_rec_w
					and		cd_protocolo = cd_protocolo_prescr_w
					and		nr_sequencia = nr_seq_prot_prescr_w;
			
			end if;
		end if;	
		
		select count(*)
		into   qt_recomend_w
		from   prescr_recomendacao
		where  	rownum = 1
		and		nr_prescricao	 	= nr_prescricao_w
		and	nvl(ie_destino_rec,'XPTO')	= nvl(ie_destino_rec_w,'XPTO' )
		and	dt_atualizacao	 		= dt_prescricao_w
		and	nvl(nm_usuario,'XPTO')	 	= nvl(nm_usuario_p,'XPTO')
		and	nvl(ds_recomendacao,'XPTO')	= nvl(ds_recomendacao_rec_w,'XPTO')
		and	nvl(qt_recomendacao,0)	 	= nvl(qt_recomendacao_rec_w,0)
		and	nvl(ie_suspenso,'XPTO') 	= nvl(ie_suspenso_rec_w,'XPTO')
		and	nvl(cd_intervalo,'XPTO')	= nvl(cd_intervalo_rec_w,'XPTO')
		and	nvl(nr_seq_classif,0)   	= nvl(nr_seq_classif_rec_w,0)
		and	nvl(cd_recomendacao,0)   	= nvl(cd_recomendacao_rec_w,0)
		and	nvl(ds_horarios,'XPTO') 	= nvl(ds_horarios_rec_w,'XPTO')
		and	nvl(ds_observacao,'XPTO') 	= nvl(ds_observacao_rec_w,'XPTO')
		and	NVL(ie_urgencia,'XPTO') 	= NVL(ie_urgencia_rec_w,'XPTO')
		and	nvl(hr_prim_horario,0)  	= nvl(hr_prim_horario_rec_w,0)
		and	nvl(nr_prescricao_original,0)   = nvl(nr_prescricao_orig_w,0)
		and	nvl(nr_seq_topografia,0)    	= nvl(nr_seq_topografia_rec_w,0)
		and	nvl(ie_faose,'XPTO') 		= nvl(ie_faose_rec_w,'XPTO')
		and	nvl(ie_acm,'XPTO') 		= nvl(ie_acm_rec_w,'XPTO')
		and	nvl(ie_se_necessario,'XPTO')  	= nvl(ie_se_necessario_rec_w,'XPTO')
	        and	nvl(ie_alterar_horario,'XPTO')  = nvl(ie_alterar_horario_rec_w,'XPTO')
		and	nvl(cd_kit,0)    		= nvl(cd_kit_rec_w,0)
		and	nvl(ds_recomendacao, cd_recomendacao) is not null;


		if	(qt_recomend_w	= 0) then


			select	nvl(max(nr_sequencia),0) + 1
			into	nr_seq_acum_w
			from	prescr_Recomendacao
			where	nr_prescricao = nr_prescricao_w;

			Insert into Prescr_recomendacao (
					nr_prescricao,
					nr_sequencia,
					ie_destino_rec,
					dt_atualizacao,
					nm_usuario,
					ds_recomendacao,
					qt_recomendacao,
					cd_intervalo,
					nr_seq_classif,
					cd_recomendacao,
					ds_horarios,
					ds_observacao,
					ie_urgencia,
					hr_prim_horario,
					nr_prescricao_original,
					nr_seq_topografia,
					ie_faose,
					ie_acm,
					ie_se_necessario,
					ie_alterar_horario,
					cd_kit)
			values(
					nr_prescricao_w,
					nr_seq_acum_w,
					ie_destino_rec_w,
					dt_prescricao_w,
					nm_usuario_p,
					ds_recomendacao_rec_w,
					qt_recomendacao_rec_w,
					cd_intervalo_rec_w,
					nr_seq_classif_rec_w,
					cd_recomendacao_rec_w,
					ds_horarios_rec_w,
					ds_observacao_rec_w,
					ie_urgencia_rec_w,
					hr_prim_horario_rec_w,
					nr_prescricao_orig_w,
					nr_seq_topografia_rec_w,
					ie_faose_rec_w,
					ie_acm_rec_w,
					ie_se_necessario_rec_w,
					ie_alterar_horario_rec_w,
					cd_kit_rec_w);




			if	(ie_seleciona_kit_rec_w = 'N') then
				open C32;
				loop
				fetch C32 into
					cd_kit_rec_2_w;
				exit when C32%notfound;
					Inserir_kit_recomendacao(nm_usuario_p, nr_prescricao_w, nr_seq_acum_w, cd_recomendacao_rec_w, cd_kit_rec_2_w);
				end loop;
				close C32;
			end if;


			if   (varKitMateAutomatico_w = 'S') then
			     Gerar_Kit_rec_Prescricao(cd_estabelecimento_p,nr_prescricao_w,nr_seq_acum_w,nm_usuario_p,'N','N');
			end if;

		Consistir_prescr_recomendacao(nr_prescricao_w, nr_seq_acum_w, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, ds_erro_w);
		end if;


		end;
	end loop;
	close c24;
end if;

-- Solicitacao banco de sangue
if (ie_copiar_hem_w = 'S') then
	gravar_processo_longo(obter_desc_expressao(781476)/*'Realizando a Copia das Solicitacoes do banco de sangue'*/
,'COPIA_PRESCRICAO',12);
	if	(VarBancoSangue_w = 'S') or
		((VarBancoSangue_w = 'T') and (ie_agrupamento_p	<> 2)) then
		begin
		select	prescr_solic_bco_sangue_seq.nextval
		into	nr_seq_bco_w
		from	dual;

		insert into prescr_solic_bco_sangue(
				nr_sequencia,
				nr_prescricao,
				dt_atualizacao,
				nm_usuario,
				ds_diagnostico,
				qt_transf_anterior,
				nr_seq_reacao,
				ie_tipo_paciente,
				ie_porte_cirurgico,
				ie_tipo,
				dt_programada,
				qt_plaqueta,
				qt_hemoglobina,
				qt_hematocrito,
				qt_tap,
				qt_tap_inr,
				ds_coagulopatia,
				ie_trans_anterior,
				nr_prescricao_original,
				ie_gravidez)
		select	nr_seq_bco_w,
				nr_prescricao_w,
				sysdate,
				nm_usuario_p,
				ds_diagnostico,
				qt_transf_anterior,
				nr_seq_reacao,
				ie_tipo_paciente,
				ie_porte_cirurgico,
				ie_tipo,
				NULL,
				qt_plaqueta,
				qt_hemoglobina,
				qt_hematocrito,
				qt_tap,
				qt_tap_inr,
				ds_coagulopatia,
				ie_trans_anterior,
				nr_prescricao,
				ie_gravidez
		from	prescr_solic_bco_sangue
		where	nr_sequencia	= (	select	max(a.nr_sequencia)
									from	prescr_solic_bco_sangue a
									where	a.nr_prescricao = nr_prescricao_orig_w)
		and		not exists (	select	1
								from	prescr_solic_bco_sangue b
								where	b.nr_prescricao = nr_prescricao_w)
		and		nr_prescricao	= nr_prescricao_orig_w;


		insert into prescr_sol_bs_indicacao(
				nr_sequencia,
				nr_seq_solic_bs,
				dt_atualizacao,
				nm_usuario,
				nr_seq_indicacao,
				ds_indicacao_adic,
				ie_grupo_hemocom)
		select	prescr_sol_bs_indicacao_seq.nextval,
				nr_seq_bco_w,
				sysdate,
				nm_usuario_p,
				b.nr_seq_indicacao,
				b.ds_indicacao_adic,
				b.ie_grupo_hemocom
		from	prescr_sol_bs_indicacao b,
				prescr_solic_bco_sangue a
		where	b.nr_seq_solic_bs = a.nr_sequencia
		and		exists (	select	1
							from	prescr_solic_bco_sangue x
							where	x.nr_sequencia = nr_seq_bco_w)
		and		a.nr_prescricao	= nr_prescricao_orig_w;
		end;
	end if;
end if;
-- Inserir Gasoterapia
if	(ie_copiar_gas_w = 'S') then
	gravar_processo_longo(obter_desc_expressao(781484)/*'Realizando a Copia da Gasoterapia'*/
,'COPIA_PRESCRICAO',14);
/*	select
	into	nr_seq_gasoterapia_w
	from	dual;*/
	open c16;
	loop
	fetch c16 into
		nr_sequencia_old_w,
		nr_sequencia_w,
		ie_inicio_w,
		ie_respiracao_w,
		cd_modalidade_vent_w,
		ie_disp_resp_esp_w,
		nr_seq_gas_w,
		cd_unidade_medida_w,
		qt_gasoterapia_w,
		cd_intervalo_w,
		ie_fluxo_acm_w,
		qt_limite_gas_min_w,
		qt_limite_gas_max_w,
		ds_observacao_ww,
		ie_suspenso_w,
		ie_unidade_medida_w,
		qt_freq_vent_w,
		ie_modo_adm_w,
		nr_seq_item_rotina_w,
		qt_vc_prog_w,
		qt_pip_w,
		qt_peep_w,
		qt_ps_w,
		qt_fluxo_insp_w,
		qt_tempo_insp_w,
		qt_acima_peep_w,
		qt_ti_te_w,
		qt_sensib_resp_w;
	exit when c16%notfound;
		begin

		select  nvl(max(a.nr_dia_util),0) + 1
		into	nr_dia_util_w
		from    prescr_gasoterapia a,
				prescr_medica b
		where   a.nr_prescricao          = b.nr_prescricao
		and     b.nr_atendimento	 = nr_atendimento_p
		and     a.nr_seq_gas		 = nr_seq_gas_w
		and		((a.dt_suspensao is null) or (ie_copia_suspensas_p = 'S'))
		and		((b.dt_suspensao is null) or (ie_copia_suspensas_p = 'S'))
		and     b.nr_prescricao          <> nr_prescricao_w
		and     ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_prescricao)   = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescricao_w - 1);

		select	count(*)
		into	qt_gas_w
		from	prescr_gasoterapia
		where	rownum = 1
		and		nvl(ie_inicio,'XPTO')		= nvl(ie_inicio_w,'XPTO')
		and		nvl(ie_respiracao,'XPTO')	= nvl(ie_respiracao_w,'XPTO')

		and		nvl(cd_modalidade_vent,'XPTO')	= nvl(cd_modalidade_vent_w,'XPTO')
		and		nvl(ie_disp_resp_esp,'XPTO') 	= nvl(ie_disp_resp_esp_w,'XPTO')
		and		nvl(nr_seq_gas,0)		= nvl(nr_seq_gas_w,0)
		and		nvl(cd_unidade_medida,'XPTO')	= nvl(cd_unidade_medida_w,'XPTO')
		and		nvl(qt_gasoterapia,0)		= nvl(qt_gasoterapia_w,0)
		and		nvl(cd_intervalo,'XPTO')	= nvl(cd_intervalo_w,'XPTO')
		and		nvl(ie_fluxo_acm,'XPTO')	= nvl(ie_fluxo_acm_w,'XPTO')
		and		nvl(qt_limite_gas_min,0)	= nvl(qt_limite_gas_min_w,0)
		and		nvl(qt_limite_gas_max,0)	= nvl(qt_limite_gas_max_w,0)
		and		nvl(ds_observacao,'XPTO')	= nvl(ds_observacao_ww,'XPTO')
		--and		nvl(ie_suspenso,'XPTO')		= nvl(ie_suspenso_w,'XPTO')
		and		nvl(ie_unidade_medida,'XPTO')	= nvl(ie_unidade_medida_w,'XPTO')
		and		nvl(qt_freq_vent,0)		= nvl(qt_freq_vent_w,0)
		and		nvl(ie_modo_adm,'XPTO')		= nvl(ie_modo_adm_w,'XPTO')
		and		nvl(nr_seq_item_rotina,0)	= nvl(nr_seq_item_rotina_w,0)
		and		nvl(nr_dia_util,0)		= nvl(nr_dia_util_w,0)
		and		nvl(nr_prescricao,0)		= nvl(nr_prescricao_w,0)
		and		nvl(qt_vc_prog,0)		= nvl(qt_vc_prog_w,0)
		and		nvl(qt_pip,0)		= nvl(qt_pip_w,0)
		and		nvl(qt_peep,0)		= nvl(qt_peep_w,0)
		and		nvl(qt_ps,0)		= nvl(qt_ps_w,0)
		and		nvl(qt_fluxo_insp,0)		= nvl(qt_fluxo_insp_w,0)
		and		nvl(qt_tempo_insp,0)		= nvl(qt_tempo_insp_w,0)
		and		nvl(qt_acima_peep,0)		= nvl(qt_acima_peep_w,0)
		and		nvl(qt_ti_te,0)		= nvl(qt_ti_te_w,0)
		and		nvl(qt_sensib_resp,0)		= nvl(qt_sensib_resp_w,0);


		if	(qt_gas_w = 0) then


			if	(cd_intervalo_w is not null) then
				nr_intervalo_w := 0;
				Calcular_Horario_Prescricao(	nr_prescricao_w, cd_intervalo_w,dt_primeiro_horario_w, dt_inicio_prescr_w, nr_horas_validade_w, 0,0,0, nr_intervalo_w, ds_horarios_w, ds_horarios_ww, 'N', null);
				ds_horarios_w := ds_horarios_w||ds_horarios_ww;
			end if;


			insert into prescr_gasoterapia(
				nr_sequencia,
				nr_prescricao,
				dt_atualizacao,
				nm_usuario,
				dt_prev_execucao,
				ie_inicio,
				ie_respiracao,
				cd_modalidade_vent,
				ie_disp_resp_esp,
				nr_seq_gas,
				cd_unidade_medida,
				qt_gasoterapia,
				cd_intervalo,
				ie_fluxo_acm,
				qt_limite_gas_min,
				qt_limite_gas_max,
				ds_observacao,
				ie_unidade_medida,
				qt_freq_vent,
				ie_modo_adm,
				nr_seq_item_rotina,
				nr_dia_util,
				nr_prescricao_original,
				qt_vc_prog,
				qt_pip,
				qt_peep,
				qt_ps,
				qt_fluxo_insp,
				qt_tempo_insp,
				qt_acima_peep,
				qt_ti_te,
				qt_sensib_resp,
				ds_horarios)
			Values (
				nr_sequencia_w,
				nr_prescricao_w,
				sysdate,
				nm_usuario_p,
				dt_prescricao_w,
				ie_inicio_w,
				ie_respiracao_w,
				cd_modalidade_vent_w,
				ie_disp_resp_esp_w,
				nr_seq_gas_w,
				cd_unidade_medida_w,
				qt_gasoterapia_w,
				cd_intervalo_w,
				ie_fluxo_acm_w,
				qt_limite_gas_min_w,
				qt_limite_gas_max_w,
				ds_observacao_ww,
				ie_unidade_medida_w,
				qt_freq_vent_w,
				ie_modo_adm_w,
				nr_seq_item_rotina_w,
				nr_dia_util_w,
				nr_prescricao_orig_w,
				qt_vc_prog_w,
				qt_pip_w,
				qt_peep_w,
				qt_ps_w,
				qt_fluxo_insp_w,
				qt_tempo_insp_w,
				qt_acima_peep_w,
				qt_ti_te_w,
				qt_sensib_resp_w,
				ds_horarios_w);


			select	nvl(max(nr_sequencia),0)
			into	nr_seq_w
			from	prescr_material
			where	nr_prescricao	= nr_prescricao_w;


			REP_copia_item_gas( nr_prescricao_orig_w, nr_prescricao_w, nr_sequencia_old_w, nr_sequencia_w, nr_seq_w, nm_usuario_p, nr_dia_util_w);


		end if;


		end;
	end loop;
	close c16;
-- Inserir a avaliacao citopatologica
	insert into prescr_citopatologico(
			nr_sequencia,
			nr_prescricao,
			dt_atualizacao,
			nm_usuario,
			ie_exame_preventivo,
			dt_ultimo_exame,
			ie_usa_diu,
			ie_gravida,
			ie_pilula,
			ie_hormonio,
			ie_radioterapia,
			ie_ultima_menstruacao,
			dt_ultima_menstruacao,
			ie_sangramento,
			ie_sangr_apos_menop,
			ie_inspecao_colo,
			ie_dst,
			nr_prescricao_original)
	select	prescr_citopatologico_seq.nextval,
			nr_prescricao_w,
			sysdate,
			nm_usuario_p,
			ie_exame_preventivo,
			dt_ultimo_exame,
			ie_usa_diu,
			ie_gravida,
			ie_pilula,
			ie_hormonio,
			ie_radioterapia,
			ie_ultima_menstruacao,
			dt_ultima_menstruacao,
			ie_sangramento,
			ie_sangr_apos_menop,
			ie_inspecao_colo,
			ie_dst,
			nr_prescricao
	from	prescr_citopatologico
	where	nr_sequencia = (	select	max(a.nr_sequencia)
								from	prescr_citopatologico a
								where	a.nr_prescricao = nr_prescricao_orig_w)
	and 	not exists (	select	1
							from	prescr_citopatologico b
							where	b.nr_prescricao = nr_prescricao_w)
	and		nr_prescricao = nr_prescricao_orig_w;
-- Inserir a avaliacao Histopatologica
	insert into prescr_histopatologico(
			nr_sequencia,
			nr_prescricao,
			dt_atualizacao,
			nm_usuario,
			ie_result_hpv,
			ie_result_ascus,
			ie_colposcopia,
			ie_colposcopia_anormal,
			ie_procedimento,
			ie_caf,
			ds_inf_adic,
			ie_result_nici,
			ie_result_nicii,
			ie_result_niciii,
			ie_result_car_esc_inv,
			ie_result_aden_in_sito,
			ie_result_aden_invasivo,
			ie_result_outros,
			ie_result_nao_fornec,
			ds_result_exame_outro,
			nr_prescricao_original)
	select	prescr_histopatologico_seq.nextval,
			nr_prescricao_w,
			sysdate,
			nm_usuario_p,
			ie_result_hpv,
			ie_result_ascus,
			ie_colposcopia,
			ie_colposcopia_anormal,
			ie_procedimento,
			ie_caf,
			ds_inf_adic,
			ie_result_nici,
			ie_result_nicii,
			ie_result_niciii,
			ie_result_car_esc_inv,
			ie_result_aden_in_sito,
			ie_result_aden_invasivo,
			ie_result_outros,
			ie_result_nao_fornec,
			ds_result_exame_outro,
			nr_prescricao
	from	prescr_histopatologico
	where	nr_sequencia = (	select	max(a.nr_sequencia)
								from	prescr_histopatologico a
								where	a.nr_prescricao = nr_prescricao_orig_w)
	and 	not exists (	select	1
							from	prescr_histopatologico b
							where	b.nr_prescricao = nr_prescricao_w)
	and		nr_prescricao = nr_prescricao_orig_w;
end if;
-- Procedimentos
if (ie_copiar_proced_w = 'S') then
	gravar_processo_longo(obter_desc_expressao(781492)/*'Realizando a Copia dos Procedimentos'*/
,'COPIA_PRESCRICAO',16);
	/*Tratamento para a OS 156585, onde gerava erro!!!!*/

	if	(nr_seq_bco_w is not null) then
		select	count(*)
		into	qt_reg_banco_w
		from	prescr_solic_bco_sangue b
		where	rownum = 1
		and		b.nr_sequencia	= nr_seq_bco_w
		and		b.nr_prescricao = nr_prescricao_w;


		if	(qt_reg_banco_w = 0) then
			nr_seq_bco_w := null;
		end if;
	end if;


	if	((qt_reg_banco_w > 0) or
		 (nr_seq_bco_w is null)) and
		 (VarIe_copia_proced_w	= 'S') then

		wheb_assist_pck.obterValorParametroREP(493,ie_setor_prescr_proc_w);
		wheb_assist_pck.obterValorParametroREP(718,VarIe_verifica_setor_w);
		wheb_assist_pck.obterValorParametroREP(1078,VarIe_Controla_Adm_w);
		wheb_assist_pck.obterValorParametroREP(1120,ie_restring_interv_lib_w);
		wheb_assist_pck.obterValorParametroREP(417,ie_data_prevista_w);


		select	nvl(max(nr_sequencia),0)
		into	nr_seq_proc_w
		from	prescr_Procedimento
		where	nr_prescricao = nr_prescricao_w;
	
		open c11;
		loop
		fetch c11 into
			nr_sequencia_w,
			nr_agrupamento_w,
			ie_executar_leito_w,
			cd_procedimento_w,
			qt_procedimento_w,
			ds_horarios_w,
			ds_observacao_w,
			ds_observacao_enf_w,
			ie_origem_proced_w,
			cd_intervalo_w,
			cd_setor_proced_w,
			ds_dado_clinico_w,
			dt_prev_execucao_w,
			cd_material_exame_w,
			nr_seq_exame_w,
			ds_material_especial_w,
			ie_origem_inf_w,
			ie_se_necessario_w,
			ie_acm_w,
			nr_ocorrencia_w,
			nr_seq_proc_interno_w,
			qt_peca_ap_w,
			ds_qualidade_peca_ap_w,
			ds_diag_provavel_ap_w,
			ds_exame_anterior_ap_w,
			nr_seq_derivado_w,
			nr_seq_exame_sangue_w,
			nr_seq_solic_sangue_w,
			cd_unid_med_sangue_w,
			cd_pessoa_coleta_w,
			qt_vol_hemocomp_w,
			nr_seq_prot_glic_w,
			ie_respiracao_w,
			cd_mod_vent_w,
			ie_disp_resp_esp_w,
			qt_fluxo_oxigenio_w,
			ds_rotina_w,
			qt_hora_intervalo_w,
			qt_min_intervalo_w,
			ie_lado_w,
			cd_protocolo_w,
			nr_seq_protocolo_w,
			cd_medico_exec_w,
			ie_tipo_proced_w,
			ie_forma_exame_w,
			nr_sequencia_orig_w,
			dt_proxima_dose_w,
			nr_seq_topografia_w,
			nr_seq_rotina_w, -- mjgoncalves OS 675145/712328
			ie_urgencia_w,
			qt_frasco_env_w,
			cd_setor_coleta_w;
			exit when c11%notfound;
			begin

			ie_copiar_proc_interv_w := 'S';

			if	(cd_intervalo_w is not null) then
				select	nvl(max(ie_copiar),'S')
				into	ie_copiar_proc_interv_w
				from	intervalo_prescricao
				where	cd_intervalo	= cd_intervalo_w;
			end if;

			if 	(ie_copiar_proc_interv_w = 'S') then


				if	(ie_restring_interv_lib_w = 'S') and
					(cd_intervalo_w is not null) then
					cd_intervalo_w	:= Obter_interv_acm_sn_agora_lib( cd_estabelecimento_w, 0, 0, 'P', cd_procedimento_w, cd_intervalo_w, nr_prescricao_w, ie_origem_proced_w, nr_seq_proc_interno_w );
					ds_horarios_w	:= '';
				end if;


				if	(obter_se_intervalo_ativo(cd_intervalo_w) = 'I') then
					cd_intervalo_w := null;
					ds_horarios_w	:= '';
				end if;


				if	(VarIe_verifica_setor_w <> 'N') then
					if	(ie_setor_prescr_proc_w = 'S') then
						cd_setor_proced_w	:= cd_setor_prescr_w;
					else
						cd_setor_proced_w	:= nvl(obter_setor_atend_proc(cd_estabelecimento_w,cd_procedimento_w,ie_origem_proced_w,null,cd_setor_prescr_w,null,nr_seq_proc_interno_w, nr_atendimento_p), cd_setor_proced_w);
					end if;
				end if;


				if (nvl(nr_seq_proc_interno_w,0) > 0) then


					select	nvl(max(ie_setor_paciente),'N')
					into	ie_setor_paciente_w
					from	proc_interno
					where	nr_sequencia = nr_seq_proc_interno_w;


					if (ie_setor_paciente_w = 'S') then
						cd_setor_proced_w	:= cd_setor_prescr_w;
					end if;

				end if;

				dt_resultado_w := null;
				
					if	(dt_prev_execucao_w is not null) and
						(ie_recalc_horario_p = 'S') and
						((ie_data_prevista_w = 'S') and
						 (ie_operacao_w in ('F','V'))) or
						(ie_data_prevista_w = 'I') then
						
						dt_prev_execucao_w	:= Obter_Horario_Proced_interv(cd_intervalo_w,nr_prescricao_w,dt_procedimento_p,dt_prescricao_p);
											
						if	(dt_prev_execucao_w < dt_inicio_prescr_tes_w) then
							dt_prev_execucao_w := dt_prev_execucao_w + 1;
						end if;
						
					end if;
					

				if (Obter_Funcao_Ativa = 924) or (Obter_Funcao_Ativa = 281) then --Apenas prescricao eletronica
					obter_setor_exame_lab(nr_prescricao_w, nr_seq_exame_w, cd_setor_usuario_w,cd_material_exame_w, null,'S',
							cd_setor_atend_w, cd_setor_col_w, cd_setor_entrega_dt_aux_w, qt_dia_entrega_w,
							ie_emite_mapa_set_w, ds_hora_fixa_w, ie_data_resultado_w, qt_min_entrega_w, ie_atualizar_recoleta_w, ie_urgencia_w, ie_dia_semana_final_w, ie_forma_atual_dt_result_w, qt_min_atraso_w);

					dt_resultado_w	:= null;

					if	(ds_hora_fixa_w is not null) then
						select	(trunc(nvl(dt_entrada_unidade,dt_prescricao)) + (ds_hora_fixa_w/24)) + qt_dia_entrega_w + (decode(qt_min_entrega_w,0,0,qt_min_entrega_w/1440))
						into	dt_resultado_w
						from	prescr_medica
						where 	nr_prescricao = nr_prescricao_w;
					else
						select	nvl(dt_entrada_unidade,dt_prescricao) + qt_dia_entrega_w  + (decode(qt_min_entrega_w,0,0,qt_min_entrega_w/1440))
						into	dt_resultado_w
						from 	prescr_medica
						where 	nr_prescricao = nr_prescricao_w;
					end if;

					if (ie_dia_semana_final_w > 0) then
						select	pkg_date_utils.get_WeekDay(dt_resultado_w)
						into	ie_dia_semana_upd_w
						from	dual;

						while (ie_dia_semana_upd_w <> ie_dia_semana_final_w) loop
							dt_resultado_w := dt_resultado_w + 1;

							select	pkg_date_utils.get_WeekDay(dt_resultado_w)
							into	ie_dia_semana_upd_w
							from	dual;
						end loop;
					end if;

				end if;

				Insert  into Prescr_Procedimento (
						nr_prescricao,
						nr_sequencia,
						nr_agrupamento,
						ie_executar_leito,
						ie_amostra,
						cd_procedimento,
						qt_procedimento,
						dt_atualizacao,
						nm_usuario,
						ds_horarios,
						ds_observacao,
						ds_observacao_enf,
						cd_motivo_baixa,
						dt_baixa,
						cd_procedimento_aih,
						ie_origem_proced,
						cd_intervalo,
						ie_urgencia,
						cd_setor_atendimento,
						dt_emissao_setor_atend,
						ds_dado_clinico,
						dt_prev_execucao,
						ie_suspenso,
						cd_material_exame,
						nr_seq_exame,
						ds_material_especial,
						ie_status_atend,
						ie_origem_inf,
						ie_se_necessario,
						ie_acm,
						nr_ocorrencia,
						nr_seq_interno,
						nr_seq_proc_interno,
						qt_peca_ap,
						ds_qualidade_peca_ap,
						ds_diag_provavel_ap,
						ds_exame_anterior_ap,
						nr_seq_derivado,
						nr_seq_exame_sangue,
						nr_seq_solic_sangue,
						cd_unid_med_sangue,
						cd_pessoa_coleta,
						dt_coleta,
						ie_avisar_result,
						qt_vol_hemocomp,
						nr_seq_prot_glic,
						ie_respiracao,
						cd_mod_vent,
						ie_disp_resp_esp,
						qt_fluxo_oxigenio,
						ds_rotina,
						qt_hora_intervalo,
						qt_min_intervalo,
						ie_autorizacao,
						ie_lado,
						nr_prescricao_original,
						cd_protocolo,
						nr_seq_protocolo,
						cd_medico_exec,
						ie_tipo_proced,
						ie_forma_exame,
						nr_seq_anterior,
						dt_proxima_dose,
						nr_seq_topografia,
						nr_seq_rotina, -- mjgoncalves OS 675145/712328
            			dt_resultado,
						qt_frasco_env,
						cd_setor_coleta
					) values (
						nr_prescricao_w,
						nr_sequencia_w,
						nr_agrupamento_w,
						ie_executar_leito_w,
						'N',
						cd_procedimento_w,
						qt_procedimento_w,
						dt_prescricao_w,
						nm_usuario_p,
						ds_horarios_w,
						SubStr(ds_observacao_w,1,2000),
						SubStr(ds_observacao_enf_w,1,2000),
						0,
						null,
						null,
						ie_origem_proced_w,
						cd_intervalo_w,
						'N',
						cd_setor_proced_w,
						null,
						ds_dado_clinico_w,
						dt_prev_execucao_w,
						'N',
						cd_material_exame_w,
						nr_seq_exame_w,
						ds_material_especial_w,
						5,
						ie_origem_inf_w,
						ie_se_necessario_w,
						ie_acm_w,
						nr_ocorrencia_w,
						prescr_procedimento_seq.nextval,
						nr_seq_proc_interno_w,
						qt_peca_ap_w,
						ds_qualidade_peca_ap_w,
						ds_diag_provavel_ap_w,
						ds_exame_anterior_ap_w,
						nr_seq_derivado_w,
						nr_seq_exame_sangue_w,
						decode(nr_seq_solic_sangue_w,null,null,nr_seq_bco_w),
						cd_unid_med_sangue_w,
						cd_pessoa_coleta_w,
						null, /*bruna, OS70689, tirei o sysdate pois somente deve atualizar quando coletado*/
						'N',
						qt_vol_hemocomp_w,
						nr_seq_prot_glic_w,
						ie_respiracao_w,
						cd_mod_vent_w,
						ie_disp_resp_esp_w,
						qt_fluxo_oxigenio_w,
						ds_rotina_w,
						qt_hora_intervalo_w,
						qt_min_intervalo_w,
						'L',
						ie_lado_w,
						nr_prescricao_orig_w,
						cd_protocolo_w,
						nr_seq_protocolo_w,
						cd_medico_exec_w,
						ie_tipo_proced_w,
						ie_forma_exame_w,
						nr_sequencia_orig_w,
						dt_proxima_dose_w,
						nr_seq_topografia_w,
						nr_seq_rotina_w, -- mjgoncalves OS 675145/712328
            			dt_resultado_w,
						qt_frasco_env_w,
						cd_setor_coleta_w);
				commit;
				
				select	count(*)
				into	cont_peca_w
				from	prescr_procedimento a, prescr_proc_peca b
				where	rownum = 1
				and		a.nr_prescricao		= b.nr_prescricao
				and		a.nr_sequencia		= b.nr_seq_prescr
				and		b.nr_prescricao		= nr_prescricao_orig_w
				and		b.nr_seq_prescr		= nr_sequencia_orig_w;

				if	(cont_peca_w > 0) then
					--nova Prescricao, nova sequencia do proc,  Prescricao antiga, Sequencia  antiga do Proc, Usuario
					REP_copia_pecas_procedimento(nr_prescricao_w, nr_sequencia_w, nr_prescricao_orig_w, nr_sequencia_orig_w, nm_usuario_p);
				end if;

				open C013; --OS170986
				loop
				fetch C013 into
					nr_seq_proc_int_w,
					nr_sequencia_w,
					dt_proxima_dose_proc_w,
					dt_prev_execucao_atual_w,
					cd_intervalo_proced_w;
				exit when C013%notfound;
					begin
					ie_administrar_proc_w := null;
					cd_procedimento_w := null;
					ie_origem_proced_w := null;


					select	max(ie_operacao),
							nvl(max(ie_24_h),'N'),
							nvl(max(qt_operacao),0)
					into		ie_operacao_int_proc_w,
							ie_24_h_proc_w,
							qt_ocorrencia_int_proc_w
					from		intervalo_prescricao
					where	cd_intervalo = cd_intervalo_proced_w;


					if	(VarIe_Controla_Adm_w = 'S') and
						(ie_operacao_int_proc_w = 'H') and
						(ie_24_h_proc_w = 'S') and
						(obter_se_interv_superior_24h(cd_intervalo_proced_w,null) = 'S') and
						(qt_ocorrencia_int_proc_w > 24) then


						if	(dt_proxima_dose_proc_w > dt_prev_execucao_atual_w) then
							ie_administrar_proc_w := 'N';
						else
							dt_proxima_dose_proc_w := dt_prev_execucao_atual_w +(qt_ocorrencia_int_proc_w/24);
						end if;
					end if;


					if	(nr_seq_proc_int_w is not null)	then
						begin
						Obter_Proc_Tab_Interno(nr_seq_proc_int_w, nr_prescricao_w,nr_atendimento_p,null,cd_procedimento_w,ie_origem_proced_w,null,null);
						end;
					end if;


					if	((cd_procedimento_w is not null) and
						(ie_origem_proced_w is not null)) then
						begin


						update	prescr_procedimento
						set		cd_procedimento = cd_procedimento_w,
								ie_origem_proced = ie_origem_proced_w,
								ie_administrar = ie_administrar_proc_w,
								dt_proxima_dose = dt_proxima_dose_proc_w
						where	nr_prescricao = nr_prescricao_w
						and		nr_sequencia = nr_sequencia_w;


						end;
					end if;


					end;
				end loop;
				close C013;

				open c23; --OS282532
				loop
				fetch c23 into
					nr_seq_proc_prescr_w,
					cd_procedimento_w,
					ie_origem_proced_w,
					cd_setor_atend_proc_w;
				exit when c23%notfound;

					nr_doc_convenio_w	:= null;


					if	(nr_seq_proc_prescr_w is not null) then
						tiss_obter_guia('4',null,nr_doc_convenio_w,'N',	null,null,null,null,null,ie_guia_w,null,nr_prescricao_w,null,cd_setor_atend_proc_w,null,nr_prescricao_w,null,null,null,null,null,null,cd_procedimento_w,ie_origem_proced_w,null);


						if	(nr_doc_convenio_w is not null) then
							update	prescr_procedimento
							set		nr_doc_convenio 	= nr_doc_convenio_w
							where	nr_prescricao 		= nr_prescricao_w
							and		nr_sequencia 		= nr_seq_proc_prescr_w;
						end if;
					end if;

				end loop;
				close c23;

			end if;

			end;
		end loop;
		close c11;

		open c19;
		loop
		fetch c19 into
			nr_seq_proc_ww,
			nr_seq_prot_glic_w,
			nr_seq_anterior_w;
		exit when c19%notfound;
		
			if	(ie_relancar_assoc_proc_w = 'S') then
				Gerar_med_mat_assoc(nr_prescricao_w, nr_seq_proc_ww);
				
				if	(nr_seq_prot_glic_w is not null) then
					Gerar_Med_Mat_Assoc_Glic(nr_prescricao_w, nr_seq_proc_ww, nr_seq_prot_glic_w);
				end if;
			end if;	
			
			/* Rafael em 8/9/2007 OS67969 */

			if	(nr_seq_prot_glic_w is not null) then
				
				if	(VarGerarNiveisGlic_w = 'S') then
					gerar_prescr_proc_glic(nr_prescricao_w, nr_seq_proc_ww, nr_seq_prot_glic_w, nm_usuario_p);
				else
					insert into prescr_proc_glic(
						nr_sequencia,
						nr_prescricao,
						nr_seq_procedimento,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_seq_protocolo,
						qt_glic_inic,
						qt_glic_fim,
						qt_ui_insulina,
						ds_sugestao,
						qt_glicose,
						qt_ui_insulina_int)
					select	prescr_proc_glic_seq.nextval,
						nr_prescricao_w,
						nr_seq_proc_ww,
						sysdate,
						nm_usuario_p,
						sysdate,
						nm_usuario_p,
						a.nr_seq_protocolo,
						a.qt_glic_inic,
						a.qt_glic_fim,
						a.qt_ui_insulina,
						a.ds_sugestao,
						a.qt_glicose,
						a.qt_ui_insulina_int
					from	prescr_procedimento b,
						prescr_proc_glic a
					where	b.nr_prescricao = a.nr_prescricao
					and	b.nr_sequencia = a.nr_seq_procedimento
					and	((nvl(b.ie_suspenso,'N')	<> 'S') or (ie_copia_suspensas_p = 'S'))
					and	b.nr_sequencia	= nr_seq_anterior_w
					and	b.nr_prescricao = nr_prescricao_orig_w;
				end if;
			end if;
		end loop;
		close c19;

		if	(ie_kit_automatico_w = 'S') then
			Gerar_kit_procedimento(cd_estabelecimento_w, nr_prescricao_w, null, nm_usuario_p);
		end if;


	end if;
end if;

-- Suporte Nutricional
if	(ie_copiar_nutricao_w = 'S') then
	gravar_processo_longo(obter_desc_expressao(781490)/*'Realizando a Copia do Suporte Nutricional'*/
,'COPIA_PRESCRICAO',18);
	Select	Nut_Paciente_seq.nextval
	into	nr_seq_nut_pac_w
	from	dual;

	Select	min(b.nr_sequencia)
	into	nr_seq_w
	from	nut_paciente b
	where	b.nr_prescricao = nr_prescricao_orig_w;

	Insert	into Nut_Paciente(
			nr_sequencia,
			nr_atendimento,
			dt_atualizacao,
			nm_usuario,
			qt_peso,
			qt_idade_ano,
			qt_altura_cm,
			nr_seq_fator_ativ,
			nr_seq_fator_stress,
			pr_proteina,
			pr_lipidio,
			pr_carboidrato,
			qt_kcal_total,
			qt_kcal_prot,
			qt_kcal_lipidio,
			qt_kcal_carboidrato,
			qt_kcal_kg,
			qt_grama_prot_kg_dia,
			pr_npt,
			qt_fase_npt,
			qt_gotejamento_npt,
			nr_prescricao,
			ie_bomba_infusao,
			ie_npt_adulta,
			ie_suspenso,
			hr_prim_horario,
			nr_prescricao_original,
			ie_calc_automatico,
			qt_volume_total)
	Select	nr_seq_nut_pac_w,
			nr_atendimento,
			sysdate,
			nm_usuario_p,
			qt_peso,
			qt_idade_ano,
			qt_altura_cm,
			nr_seq_fator_ativ,
			nr_seq_fator_stress,
			pr_proteina,
			pr_lipidio,
			pr_carboidrato,
			qt_kcal_total,
			qt_kcal_prot,
			qt_kcal_lipidio,
			qt_kcal_carboidrato,
			qt_kcal_kg,
			qt_grama_prot_kg_dia,
			pr_npt,
			qt_fase_npt,
			qt_gotejamento_npt,
			nr_prescricao_w,
			ie_bomba_infusao,
			ie_npt_adulta,
			'N',
			hr_prim_horario,
			nr_prescricao,
			ie_calc_automatico,
			qt_volume_total
	from	nut_paciente
	where	nvl(ie_suspenso,'N') <> 'S'
	and		nr_sequencia = nr_seq_w
	and		nr_prescricao = nr_prescricao_orig_w;

	select	count(*)
	into	cont_w
	from 	nut_paciente
	where	rownum = 1
	and		nr_sequencia	= nr_seq_nut_pac_w;

	if	(cont_w > 0) then


		OPEN C02;
		LOOP
		FETCH C02 INTO
			nr_seq_pac_elem_w;
		exit when c02%notfound;
			begin

			select	Nut_paciente_elemento_seq.nextval
			into	nr_sequencia_w
			from	dual;


			-- Elementos da NUT_PACIENTE_ELEMENTO
			insert into nut_paciente_elemento(
								nr_sequencia,
								nr_seq_nut_pac,
								nr_seq_elemento,
								dt_atualizacao,
								nm_usuario,
								qt_kcal,
								qt_elemento,
								nr_seq_elem_unid_med,
								nr_seq_elem_mat,
								qt_volume,
								cd_unid_med_prescr,
								qt_prescricao,
								qt_dispensar,
								qt_vol_1_fase,
								qt_vol_2_fase,
								qt_vol_3_fase)
						select	nr_sequencia_w,
								nr_seq_nut_pac_w,
								nr_seq_elemento,
								sysdate,
								nm_usuario_p,
								qt_kcal,
								qt_elemento,
								nr_seq_elem_unid_med,
								nr_seq_elem_mat,
								qt_volume,
								cd_unid_med_prescr,
								qt_prescricao,
								qt_dispensar,
								qt_vol_1_fase,
								qt_vol_2_fase,
								qt_vol_3_fase
						from	nut_paciente_elemento
						where	nr_sequencia = nr_seq_pac_elem_w
						and		nr_seq_nut_pac = nr_seq_w;


			-- Produtos da NUT_PACIENTE_ELEM_MAT
			insert into nut_pac_elem_mat(
					nr_sequencia,
					nr_seq_nut_pac_ele,
					dt_atualizacao,
					nm_usuario,
					nr_seq_elem_mat,
					qt_volume,
					qt_vol_1_fase,
					qt_vol_2_fase,
					qt_vol_3_fase,
					qt_vol_4_fase,
					qt_vol_cor,
					nr_seq_nut_pac,
					cd_material,
					qt_protocolo,
					qt_dose,
					cd_unidade_medida)
			select	nut_pac_elem_mat_seq.nextval,
					nr_sequencia_w,
					sysdate,
					nm_usuario_p,
					nr_seq_elem_mat,
					qt_volume,
					qt_vol_1_fase,
					qt_vol_2_fase,
					qt_vol_3_fase,
					qt_vol_4_fase,
					qt_vol_cor,
					null,
					cd_material,
					qt_protocolo,
					qt_dose,
					cd_unidade_medida
			from	nut_pac_elem_mat
			where	nr_seq_nut_pac_ele	= nr_seq_pac_elem_w;

			end;
		END LOOP;
		CLOSE C02;
	end if;
end if;

-- NPT Neonatal
if	(ie_copiar_nutricao_w = 'S') then
	gravar_processo_longo(obter_desc_expressao(781478)/*'Realizando a Copia da NPT Neonatal'*/
,'COPIA_PRESCRICAO',20);
	select	count(*)
	into	qt_nut_w
	from	nut_pac
	where	rownum = 1
	and nr_prescricao	= nr_prescricao_w
	and	ie_npt_adulta	= 'N';

	if	(qt_nut_w = 0) then


		select	count(distinct(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescricao))) + 1
		into	qt_dia_npt_w
		from	prescr_medica b,
			nut_pac a
		where	a.nr_prescricao = b.nr_prescricao
		and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_prescricao) <> ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(sysdate)
		and	b.nr_atendimento = (select obter_atendimento_prescr(nr_prescricao_orig_w) from dual);

		Select	Nut_Pac_seq.nextval
		into	nr_nut_pac_w
		from	dual;


		Select	min(b.nr_sequencia)
		into	nr_seq_w
		from	nut_pac b
		where	b.nr_prescricao = nr_prescricao_orig_w
		and	b.ie_npt_adulta	= 'N';


		select	nvl(max(obter_ultimo_sinal_vital_pf(cd_pessoa_fisica,'Peso')),max(qt_peso))
		into	qt_peso_w
		from	prescr_medica
		where	nr_prescricao	= nr_prescricao_w;

		Insert into nut_pac(
				nr_sequencia,
				nr_prescricao,
				dt_atualizacao,
				nm_usuario,
				qt_peso,
				qt_idade_dia,
				qt_idade_mes,
				qt_idade_ano,
				qt_altura_cm,
				qt_dia_npt,
				qt_kcal_total,
				qt_kcal_kg,
				qt_fase_npt,
				qt_nec_hidrica_diaria,
				qt_aporte_hidrico_diario,
				qt_vel_inf_glicose,
				qt_nec_kcal_kg_dia,
				nr_seq_fator_ativ,
				nr_seq_fator_stress,
				pr_conc_glic_solucao,
				qt_rel_cal_nit,
				qt_equipo,
				ie_calculo_auto,
				qt_nec_kcal_dia,
				ie_correcao,
				hr_prim_horario,
				ie_ajustar_potassio,
				qt_gotejo_npt,
				ie_emissao,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ie_suspenso,
				qt_volume_adep,
				ie_forma_infusao,
				pr_carboidrato,
				pr_lipidio,
				pr_npt,
				pr_proteina,
				ie_bomba_infusao,
				qt_grama_nitrogenio,
				ie_npt_adulta,
				qt_hora_inf,
				qt_min_inf,
				ie_forma,
				qt_peso_ideal,
				qt_peso_ajustado,
				qt_tmb,
				nr_seq_protocolo,
				qt_kcal_proteina,
				pr_conc_proteina_solucao,
				qt_kcal_lipidio,
				pr_conc_lipidio_solucao,
				qt_kcal_carboidrato,
				ie_via_administracao,
				qt_grama_proteina_kg_dia,
				qt_kcal_proteico,
				qt_kcal_nao_proteico,
				qt_multiplicador,
				qt_volume_diario,
				qt_osmolaridade_total,
				ie_ajustar_sodio,
				ie_zinco,
				nr_sequencia_anterior,
				cd_intervalo,
				nr_prescricao_original,
				IE_EDITADO,
				QT_VOLUME_PRINC)
		select	nr_nut_pac_w,
				nr_prescricao_w,
				sysdate,
				nm_usuario_p,
				nvl(qt_peso_w,qt_peso),
				qt_idade_dia,
				qt_idade_mes,
				qt_idade_ano,
				qt_altura_cm,
				qt_dia_npt_w,
				qt_kcal_total,
				qt_kcal_kg,
				qt_fase_npt,
				qt_nec_hidrica_diaria,
				qt_aporte_hidrico_diario,
				qt_vel_inf_glicose,
				qt_nec_kcal_kg_dia,
				nr_seq_fator_ativ,
				nr_seq_fator_stress,
				pr_conc_glic_solucao,
				qt_rel_cal_nit,
				qt_equipo,
				ie_calculo_auto,
				qt_nec_kcal_dia,
				ie_correcao,
				nvl(VarPrimHorNPT_w, hr_prim_horario),
				ie_ajustar_potassio,
				qt_gotejo_npt,
				0,
				sysdate,
				nm_usuario_p,
				'N',
				qt_volume_adep,
				ie_forma_infusao,
				pr_carboidrato,
				pr_lipidio,
				pr_npt,
				pr_proteina,
				ie_bomba_infusao,
				qt_grama_nitrogenio,
				ie_npt_adulta,
				qt_hora_inf,
				qt_min_inf,
				ie_forma,
				qt_peso_ideal,
				qt_peso_ajustado,
				qt_tmb,
				nr_seq_protocolo,
				qt_kcal_proteina,
				pr_conc_proteina_solucao,
				qt_kcal_lipidio,
				pr_conc_lipidio_solucao,
				qt_kcal_carboidrato,
				ie_via_administracao,
				qt_grama_proteina_kg_dia,
				qt_kcal_proteico,
				qt_kcal_nao_proteico,
				qt_multiplicador,
				qt_volume_diario,
				qt_osmolaridade_total,
				ie_ajustar_sodio,
				ie_zinco,
				nr_sequencia,
				cd_intervalo,
				nr_prescricao,
				nvl(IE_EDITADO,'N'),
				QT_VOLUME_PRINC
		from	nut_pac
		where	nr_sequencia	= nr_seq_w
		and	nr_prescricao	= nr_prescricao_orig_w
		and	dt_suspensao is null;




		select	count(*)
		into	cont_w
		from	nut_pac
		where	rownum = 1
		and		nr_sequencia	= nr_nut_pac_w;


		if	(cont_w > 0) then


			OPEN C031;
			LOOP
			FETCH C031 INTO
				nut_pac_elem_w;
			exit when C031%notfound;
				begin
				select	nut_pac_elemento_seq.nextval
				into	nr_seq_pac_elem_w
				from	dual;

				Insert into nut_pac_elemento(
						nr_sequencia,
						nr_seq_nut_pac,
						nr_seq_elemento,
						dt_atualizacao,
						nm_usuario,
						cd_unidade_medida,
						qt_elem_kg_dia,
						qt_diaria,
						pr_total,
						qt_kcal,
						ie_prim_fase,
						ie_seg_fase,
						ie_terc_fase,
						ie_quar_fase,
						ie_npt,
						PR_CONCENTRACAO,
						QT_VOLUME_FINAL)
				select	nr_seq_pac_elem_w,
						nr_nut_pac_w,
						nr_seq_elemento,
						sysdate,
						nm_usuario_p,
						cd_unidade_medida,
						qt_elem_kg_dia,
						qt_diaria,
						pr_total,
						qt_kcal,
						ie_prim_fase,
						ie_seg_fase,
						ie_terc_fase,
						ie_quar_fase,
						ie_npt,
						nvl(PR_CONCENTRACAO,0),
						QT_VOLUME_FINAL
				from	nut_pac_elemento
				where	nr_sequencia = nut_pac_elem_w;

					OPEN C04;
					LOOP
					FETCH C04 INTO
						nr_seq_pac_elem_mat_w;
					exit when c04%notfound;
						begin
						insert into nut_pac_elem_mat(
								nr_sequencia,
								nr_seq_pac_elem,
								dt_atualizacao,
								nm_usuario,
								nr_seq_elem_mat,
								qt_volume,
								qt_vol_1_fase,
								qt_vol_2_fase,
								qt_vol_3_fase,
								qt_vol_4_fase,
								qt_vol_cor,
								nr_seq_nut_pac,
								cd_material,
								qt_protocolo,
								qt_dose,
								cd_unidade_medida)
						select	nut_pac_elem_mat_seq.nextval,
								nr_seq_pac_elem_w,
								sysdate,
								nm_usuario_p,
								nr_seq_elem_mat,
								qt_volume,
								qt_vol_1_fase,
								qt_vol_2_fase,
								qt_vol_3_fase,
								qt_vol_4_fase,
								qt_vol_cor,
								nr_nut_pac_w,
								cd_material,
								qt_protocolo,
								qt_dose,
								cd_unidade_medida
						from	nut_pac_elem_mat
						where	nr_sequencia	= nr_seq_pac_elem_mat_w;
						end;
					END LOOP;
					CLOSE C04;
				end;
			END LOOP;
			CLOSE C031;


			Calcular_nut_pac_ped(nr_nut_pac_w, nm_usuario_p, cd_estabelecimento_w);


		end if;
	end if;
end if;

--NPT Adulta
if	(ie_copiar_nutricao_w = 'S') then
	gravar_processo_longo(obter_desc_expressao(781496)/*'Realizando a Copia da NPT Adulta'*/
,'COPIA_PRESCRICAO',22);
	select	count(distinct(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescricao))) + 1
	into	qt_dia_npt_w
	from	prescr_medica b,
		nut_pac a
	where	a.nr_prescricao = b.nr_prescricao
	and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_prescricao) <> ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(sysdate)
	and	b.nr_atendimento = (select obter_atendimento_prescr(nr_prescricao_orig_w) from dual);

	select	count(*)
	into	qt_nut_w
	from	nut_pac
	where	rownum = 1
	and		nr_prescricao	= nr_prescricao_w
	and	ie_npt_adulta	= 'S';


	qt_hora_inf_w	:= nvl(nr_horas_validade_p,24);


	if	(qt_nut_w = 0) then


		Select	Nut_Pac_seq.nextval
		into	nr_nut_pac_w
		from	dual;

		Insert into nut_pac(
				nr_sequencia,
				nr_prescricao,
				dt_atualizacao,
				nm_usuario,
				qt_peso,
				qt_idade_dia,
				qt_idade_mes,
				qt_idade_ano,
				qt_altura_cm,
				qt_dia_npt,
				qt_kcal_total,
				qt_kcal_kg,
				qt_fase_npt,
				qt_nec_hidrica_diaria,
				qt_aporte_hidrico_diario,
				qt_vel_inf_glicose,
				qt_nec_kcal_kg_dia,
				nr_seq_fator_ativ,
				nr_seq_fator_stress,
				pr_conc_glic_solucao,
				qt_rel_cal_nit,
				qt_equipo,
				ie_calculo_auto,
				qt_nec_kcal_dia,
				ie_correcao,
				hr_prim_horario,
				ie_ajustar_potassio,
				qt_gotejo_npt,
				ie_emissao,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ie_suspenso,
				qt_volume_adep,
				ie_forma_infusao,
				pr_carboidrato,
				pr_lipidio,
				pr_npt,
				pr_proteina,
				ie_bomba_infusao,
				qt_grama_nitrogenio,
				ie_npt_adulta,
				qt_hora_inf,
				qt_min_inf,
				ie_forma,
				qt_peso_ideal,
				qt_peso_ajustado,
				qt_tmb,
				nr_seq_protocolo,
				qt_kcal_proteina,
				pr_conc_proteina_solucao,
				qt_kcal_lipidio,
				pr_conc_lipidio_solucao,
				qt_kcal_carboidrato,
				ie_via_administracao,
				qt_grama_proteina_kg_dia,
				qt_kcal_proteico,
				qt_kcal_nao_proteico,
				qt_multiplicador,
				qt_volume_diario,
				qt_osmolaridade_total,
				nr_sequencia_anterior,
				cd_intervalo,
				nr_prescricao_original,
				IE_EDITADO,
				QT_VOLUME_PRINC)
		select	nr_nut_pac_w,
				nr_prescricao_w,
				sysdate,
				nm_usuario_p,
				qt_peso,
				qt_idade_dia,
				qt_idade_mes,
				qt_idade_ano,
				qt_altura_cm,
				qt_dia_npt_w,
				qt_kcal_total,
				qt_kcal_kg,
				qt_fase_npt,
				qt_nec_hidrica_diaria,
				qt_aporte_hidrico_diario,
				qt_vel_inf_glicose,
				qt_nec_kcal_kg_dia,
				nr_seq_fator_ativ,
				nr_seq_fator_stress,
				pr_conc_glic_solucao,
				qt_rel_cal_nit,
				qt_equipo,
				ie_calculo_auto,
				qt_nec_kcal_dia,
				ie_correcao,
				nvl(VarPrimHorNPT_w, hr_prim_horario),
				ie_ajustar_potassio,
				qt_gotejo_npt,
				0,
				sysdate,
				nm_usuario_p,
				'N',
				qt_volume_adep,
				ie_forma_infusao,
				pr_carboidrato,
				pr_lipidio,
				pr_npt,
				pr_proteina,
				ie_bomba_infusao,
				qt_grama_nitrogenio,
				ie_npt_adulta,
				decode(ie_horas_fixas_npt_w,'S',qt_hora_inf_w,qt_hora_inf),
				qt_min_inf,
				ie_forma,
				qt_peso_ideal,
				qt_peso_ajustado,
				qt_tmb,
				nr_seq_protocolo,
				qt_kcal_proteina,
				pr_conc_proteina_solucao,
				qt_kcal_lipidio,
				pr_conc_lipidio_solucao,
				qt_kcal_carboidrato,
				ie_via_administracao,
				qt_grama_proteina_kg_dia,
				qt_kcal_proteico,
				qt_kcal_nao_proteico,
				qt_multiplicador,
				qt_volume_diario,
				qt_osmolaridade_total,
				nr_sequencia,
				cd_intervalo,
				nr_prescricao,
				nvl(IE_EDITADO,'N'),
				QT_VOLUME_PRINC
		from	nut_pac
		where	ie_npt_adulta	= 'S'
		and	nr_prescricao	= nr_prescricao_orig_w
		and	dt_suspensao is null;


		select	count(*)
		into	cont_w
		from	nut_pac
		where	rownum = 1
		and		nr_sequencia	= nr_nut_pac_w;


		if	(cont_w > 0) then


			OPEN C21;
			LOOP
			FETCH C21 INTO
				nut_pac_elem_w;
			exit when c21%notfound;
				begin
				select	nut_pac_elemento_seq.nextval
				into	nr_seq_pac_elem_w
				from	dual;

				Insert into nut_pac_elemento(
						nr_sequencia,
						nr_seq_nut_pac,
						nr_seq_elemento,
						dt_atualizacao,
						nm_usuario,
						cd_unidade_medida,
						qt_elem_kg_dia,
						qt_diaria,
						pr_total,
						qt_kcal,
						ie_prim_fase,
						ie_seg_fase,
						ie_terc_fase,
						ie_quar_fase,
						ie_npt,
						qt_protocolo,
						pr_concentracao,
						QT_VOLUME_FINAL)
				select	nr_seq_pac_elem_w,
						nr_nut_pac_w,
						nr_seq_elemento,
						sysdate,
						nm_usuario_p,
						cd_unidade_medida,
						qt_elem_kg_dia,
						qt_diaria,
						pr_total,
						qt_kcal,
						ie_prim_fase,
						ie_seg_fase,
						ie_terc_fase,
						ie_quar_fase,
						ie_npt,
						qt_protocolo,
						nvl(pr_concentracao,0),
						QT_VOLUME_FINAL
				from	nut_pac_elemento
				where	nr_sequencia = nut_pac_elem_w;
				end;
			END LOOP;
			CLOSE C21;

			OPEN C22;
			LOOP
			FETCH C22 INTO
				nr_seq_pac_elem_mat_w;
			exit when c22%notfound;
				begin
				insert into nut_pac_elem_mat(
						nr_sequencia,
						nr_seq_pac_elem,
						dt_atualizacao,
						nm_usuario,
						nr_seq_elem_mat,
						qt_volume,
						qt_vol_1_fase,
						qt_vol_2_fase,
						qt_vol_3_fase,
						qt_vol_4_fase,
						qt_vol_cor,
						nr_seq_nut_pac,
						cd_material,
						qt_protocolo,
						qt_dose,
						cd_unidade_medida)
				select	nut_pac_elem_mat_seq.nextval,
						nr_seq_pac_elem,
						sysdate,
						nm_usuario_p,
						nr_seq_elem_mat,
						qt_volume,
						qt_vol_1_fase,
						qt_vol_2_fase,
						qt_vol_3_fase,
						qt_vol_4_fase,
						qt_vol_cor,
						nr_nut_pac_w,
						cd_material,
						qt_protocolo,
						qt_dose,
						cd_unidade_medida
				from	nut_pac_elem_mat
				where	nr_sequencia = nr_seq_pac_elem_mat_w;
				end;
			END LOOP;
			CLOSE C22;


		end if;


	end if;


	select	count(*)
	into	qt_nut_w
	from	nut_pac
	where	rownum = 1
	and		nr_prescricao	= nr_prescricao_w
	and	ie_npt_adulta	= 'P';

	if	(qt_nut_w = 0) then


		select	count(distinct(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescricao))) + 1
		into	qt_dia_npt_w
		from	prescr_medica b,
			nut_pac a
		where	a.nr_prescricao = b.nr_prescricao
		and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_prescricao) <> ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(sysdate)
		and	b.nr_atendimento = (select obter_atendimento_prescr(nr_prescricao_orig_w) from dual);

		Select	Nut_Pac_seq.nextval
		into	nr_nut_pac_w
		from	dual;


		Select	min(b.nr_sequencia)
		into	nr_seq_w
		from	nut_pac b
		where	b.nr_prescricao = nr_prescricao_orig_w
		and	b.ie_npt_adulta	= 'P';

		Insert into nut_pac(
				nr_sequencia,
				nr_prescricao,
				dt_atualizacao,
				nm_usuario,
				qt_peso,
				qt_idade_dia,
				qt_idade_mes,
				qt_idade_ano,
				qt_altura_cm,
				qt_dia_npt,
				qt_kcal_total,
				qt_kcal_kg,
				qt_fase_npt,
				qt_nec_hidrica_diaria,
				qt_aporte_hidrico_diario,
				qt_vel_inf_glicose,
				qt_nec_kcal_kg_dia,
				nr_seq_fator_ativ,
				nr_seq_fator_stress,
				pr_conc_glic_solucao,
				qt_rel_cal_nit,
				qt_equipo,
				ie_calculo_auto,
				qt_nec_kcal_dia,
				ie_correcao,
				hr_prim_horario,
				ie_ajustar_potassio,
				qt_gotejo_npt,
				ie_emissao,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ie_suspenso,
				qt_volume_adep,
				ie_forma_infusao,
				pr_carboidrato,
				pr_lipidio,
				pr_npt,
				pr_proteina,
				ie_bomba_infusao,
				qt_grama_nitrogenio,
				ie_npt_adulta,
				qt_hora_inf,
				qt_min_inf,
				ie_forma,
				qt_peso_ideal,
				qt_peso_ajustado,
				qt_tmb,
				nr_seq_protocolo,
				qt_kcal_proteina,
				pr_conc_proteina_solucao,
				qt_kcal_lipidio,
				pr_conc_lipidio_solucao,
				qt_kcal_carboidrato,
				ie_via_administracao,
				qt_grama_proteina_kg_dia,
				qt_kcal_proteico,
				qt_kcal_nao_proteico,
				qt_multiplicador,
				qt_volume_diario,
				qt_osmolaridade_total,
				qt_peso_calorico,
				qt_nec_hidrica_diaria_ped,
				qt_kcal_kg_ped,
				nr_sequencia_anterior,
				cd_intervalo,
				nr_prescricao_original,
				QT_VOLUME_PRINC)
		select	nr_nut_pac_w,
				nr_prescricao_w,
				sysdate,
				nm_usuario_p,
				qt_peso,
				qt_idade_dia,
				qt_idade_mes,
				qt_idade_ano,
				qt_altura_cm,
				qt_dia_npt_w,
				qt_kcal_total,
				qt_kcal_kg,
				qt_fase_npt,
				qt_nec_hidrica_diaria,
				qt_aporte_hidrico_diario,
				qt_vel_inf_glicose,
				qt_nec_kcal_kg_dia,
				nr_seq_fator_ativ,
				nr_seq_fator_stress,
				pr_conc_glic_solucao,
				qt_rel_cal_nit,
				qt_equipo,
				ie_calculo_auto,
				qt_nec_kcal_dia,
				ie_correcao,
				nvl(VarPrimHorNPT_w, hr_prim_horario),
				ie_ajustar_potassio,
				qt_gotejo_npt,
				0,
				sysdate,
				nm_usuario_p,
				'N',
				qt_volume_adep,
				ie_forma_infusao,
				pr_carboidrato,
				pr_lipidio,
				pr_npt,
				pr_proteina,
				ie_bomba_infusao,
				qt_grama_nitrogenio,
				ie_npt_adulta,
				decode(ie_horas_fixas_npt_w,'S',qt_hora_inf_w,qt_hora_inf),
				qt_min_inf,
				ie_forma,
				qt_peso_ideal,
				qt_peso_ajustado,
				qt_tmb,
				nr_seq_protocolo,
				qt_kcal_proteina,
				pr_conc_proteina_solucao,
				qt_kcal_lipidio,
				pr_conc_lipidio_solucao,
				qt_kcal_carboidrato,
				ie_via_administracao,
				qt_grama_proteina_kg_dia,
				qt_kcal_proteico,
				qt_kcal_nao_proteico,
				qt_multiplicador,
				qt_volume_diario,
				qt_osmolaridade_total,
				qt_peso_calorico,
				qt_nec_hidrica_diaria_ped,
				qt_kcal_kg_ped,
				nr_sequencia,
				cd_intervalo,
				nr_prescricao,
				QT_VOLUME_PRINC
		from	nut_pac
		where	nr_sequencia	= nr_seq_w
		and	nr_prescricao	= nr_prescricao_orig_w
		and	dt_suspensao is null;


		select	count(*)
		into	cont_w
		from	nut_pac
		where	rownum = 1
		and		nr_sequencia	= nr_nut_pac_w;

		if	(cont_w > 0) then


			OPEN C03;
			LOOP
			FETCH C03 INTO
				nut_pac_elem_w;
			exit when c03%notfound;
				begin
				select	nut_pac_elemento_seq.nextval
				into	nr_seq_pac_elem_w
				from	dual;

				Insert into nut_pac_elemento(
						nr_sequencia,
						nr_seq_nut_pac,
						nr_seq_elemento,
						dt_atualizacao,
						nm_usuario,
						cd_unidade_medida,
						qt_elem_kg_dia,
						qt_diaria,
						pr_total,
						qt_kcal,
						ie_prim_fase,
						ie_seg_fase,
						ie_terc_fase,
						ie_quar_fase,
						ie_npt,
						PR_CONCENTRACAO,
						QT_VOLUME_FINAL)
				select	nr_seq_pac_elem_w,
						nr_nut_pac_w,
						nr_seq_elemento,
						sysdate,
						nm_usuario_p,
						cd_unidade_medida,
						qt_elem_kg_dia,
						qt_diaria,
						pr_total,
						qt_kcal,
						ie_prim_fase,
						ie_seg_fase,
						ie_terc_fase,
						ie_quar_fase,
						ie_npt,
						nvl(PR_CONCENTRACAO,0),
						QT_VOLUME_FINAL
				from	nut_pac_elemento
				where	nr_sequencia = nut_pac_elem_w;

					OPEN C04;
					LOOP
					FETCH C04 INTO
						nr_seq_pac_elem_mat_w;
					exit when c04%notfound;
						begin
						insert into nut_pac_elem_mat(
								nr_sequencia,
								nr_seq_pac_elem,
								dt_atualizacao,
								nm_usuario,
								nr_seq_elem_mat,
								qt_volume,
								qt_vol_1_fase,
								qt_vol_2_fase,
								qt_vol_3_fase,
								qt_vol_4_fase,
								qt_vol_cor,
								nr_seq_nut_pac,
								cd_material,
								qt_protocolo,
								qt_dose,
								cd_unidade_medida)
						select	nut_pac_elem_mat_seq.nextval,
								nr_seq_pac_elem_w,
								sysdate,
								nm_usuario_p,
								nr_seq_elem_mat,
								qt_volume,
								qt_vol_1_fase,
								qt_vol_2_fase,
								qt_vol_3_fase,
								qt_vol_4_fase,
								qt_vol_cor,
								nr_nut_pac_w,
								cd_material,
								qt_protocolo,
								qt_dose,
								cd_unidade_medida
						from	nut_pac_elem_mat
						where	nr_sequencia	= nr_seq_pac_elem_mat_w;
						end;
					END LOOP;
					CLOSE C04;
				end;
			END LOOP;
			CLOSE C03;
		end if;
	end if;
end if;

-- Materiais, Medicamentos, Itens da nutricao(SNE, Suplemento Oral, Itens da Dieta, da NPT)
ds_agrupador_nao_copiar_w	:= '';

if	(ie_copiar_nutricao_w <> 'S') then
	ds_agrupador_nao_copiar_w	:= '6,10,11,12,16,17,8';
end if;

if	((ie_copiar_mat_w = 'S') or
	 (ie_copiar_medic_w = 'S') or
	 (ie_copiar_nutricao_w = 'S')) then
	gravar_processo_longo(obter_desc_expressao(781486)/*'Realizando a Copia dos Materiais e Medicamentos'*/
,'COPIA_PRESCRICAO',24);
	delete from w_prescr_mat_nao_copia
	where nr_prescricao = nr_prescricao_orig_w;

	select	nvl(max(nr_sequencia),0),
			nvl(max(nr_agrupamento),0)
	into	nr_seq_acum_w,
			nr_agrup_acum_w
	from	prescr_material
	where	nr_prescricao = nr_prescricao_w;

	select	max(dt_inicio_prescr)
	into	dt_inicio_prescr_tes_w
	from	prescr_medica
	where	nr_prescricao	= nr_prescricao_w;


	nr_sequencia_w	:= 1;
	nr_seq_w	:= 1;


	wheb_assist_pck.obterValorParametroREP(18,ie_padronizado_w);
	wheb_assist_pck.obterValorParametroREP(148,ie_apres_medic_nao_copia_w);

	wheb_assist_pck.obterValorParametroREP(173,ie_copia_direta_w);
	wheb_assist_pck.obterValorParametroREP(813,ie_gerar_diluicao_w);
	wheb_assist_pck.obterValorParametroREP(1128,ie_param1128_w);
	if	(ie_param1128_w = 'S') then
		wheb_assist_pck.obterValorParametroREP(1156,vl_param1156_w);
		ie_param1128_w	:= Obter_se_em_protocolo_vanco(nr_atendimento_ww, 'N', nvl(vl_param1156_w,0));
	end if;

	open C17;
	loop
	fetch C17 into
		nr_prescricao_ww,
		nr_sequencia_orig_w,
		ie_origem_inf_ww,
		cd_material_ww,
		cd_unidade_medida_ww,
		qt_dose_ww,
		qt_unitaria_ww,
		qt_material_ww,
		dt_atualizacao_ww,
		nm_usuario_ww,
		cd_intervalo_ww,
		ds_horarios_ww,
		ds_observacao_ww,
		ds_observacao_enf_ww,
		ie_via_aplicacao_ww,
		nr_agrupamento_ww,
		ie_cobra_paciente_ww,
		cd_motivo_baixa_ww,
		dt_baixa_ww,
		ie_utiliza_kit_ww,
		cd_unidade_medida_dose_ww,
		nr_seq_via_acesso_ww,
		qt_conversao_dose_ww,
		ie_urgencia_ww,
		nr_ocorrencia_ww,
		qt_total_dispensar_ww,
		cd_fornec_consignado_ww,
		nr_sequencia_solucao_ww,
		nr_sequencia_proc_ww,
		qt_solucao_ww,
		hr_dose_especial_ww,
		qt_dose_especial_ww,
		ds_dose_diferenciada_ww,
		ie_medicacao_paciente_ww,
		nr_sequencia_diluicao_ww,
		hr_prim_horario_ww,
		nr_sequencia_dieta_ww,
		ie_agrupador_ww,
		nr_dia_util_ww,
		ie_suspenso_ww,
		ie_se_necessario_ww,
		qt_min_aplicacao_ww,
		ie_bomba_infusao_ww,
		ie_aplic_bolus_ww,
		ie_aplic_lenta_ww,
		ie_acm_ww,
		ie_objetivo_ww,
		cd_topografia_cih_ww,
		ie_origem_infeccao_ww,
		cd_amostra_cih_ww,
		cd_microorganismo_cih_ww,
		ie_uso_antimicrobiano_ww,
		cd_protocolo_ww,
		nr_seq_protocolo_ww,
		nr_seq_mat_protocolo_ww,
		qt_hora_aplicacao_ww,
		ie_recons_diluente_fixo_ww,
		qt_vel_infusao_ww,
		ds_justificativa_ww,
		ie_sem_aprazamento_ww,
		ie_indicacao_ww,
		dt_proxima_dose_ww,
		qt_total_dias_lib_ww,
		nr_seq_substituto_ww,
		ie_lado_ww,
		dt_inicio_medic_ww,
		qt_dia_prim_hor_ww,
		ie_regra_disp_ww,
		qt_vol_adic_reconst_ww,
		qt_hora_intervalo_w,
		qt_min_intervalo_ww,
		ie_permite_substituir_ww,
		ds_observacao_far_ww,
		ie_dias_util_medic_w,
		nr_seq_recomendacao_wW,
		ie_situacao_ww,
		cd_kit_w,
		ds_medic_nao_padr_w,
		ie_vancomicina_w,
		ie_em_protocolo_vanco_w,
		ie_glicemia_w,
		dt_susp_agora_w,
		ie_fator_correcao_med_w,
		ie_aplicar_w,
		qt_volume_corrigido_w,
		ie_urgencia_medic_w,
		ie_disponivel_mercado_w,
		ie_permite_alterar_w;
	exit when C17%notfound;

	if	(ie_situacao_ww	= 'A') and
		(((ie_suspenso_ww = 'N') and
		  (dt_susp_agora_w is null)) or
		 (ie_copia_suspensas_p = 'S')) and
                ((Varie_copia_prescr_w = 'S') or (nvl(ie_disponivel_mercado_w,'N') <> 'N')) then


		if 	(ie_param911_w in ('S', 'C')) and
			(ie_agrupador_ww = 1) then


			if	(ie_param911_w = 'C') then
				cd_intervalo_ww	:= null;
			else
				cd_intervalo_ww	:= Obter_interv_acm_sn_agora_lib(cd_estabelecimento_w,0,0,1,cd_material_ww,cd_intervalo_ww,nr_prescricao_ww,null,null);
			end if;

			if  (cd_intervalo_ww is null) then
				ds_horarios_ww	:= null;
			end if;
		end if;


		if	(cd_intervalo_ww is not null) and
			(ie_urgencia_medic_w	= 'S') and
			(VarCopiaCheckAgora_w	= 'N') and
			(Var_param_548_w = 'N') then
			cd_intervalo_ww	:= null;
			ds_horarios_ww	:= null;
		end if;

		ie_copia_item_w	:= 'S';


		if	(ie_copia_item_w = 'S') and
			(cd_intervalo_ww is not null) then
			select	nvl(max(ie_copiar),'S')
			into	ie_copia_item_w
			from	intervalo_prescricao
			where	cd_intervalo	= cd_intervalo_ww;
		end if;


		if	(ie_copia_item_w = 'S') and
			(nvl(nr_sequencia_proc_ww,0) > 0) then
			select	nvl(max('S'),'N')
			into	ie_copia_item_w
			from	prescr_procedimento
			where	nr_sequencia	= nr_sequencia_proc_ww
			and		nr_prescricao	= nr_prescricao_ww;
		end if;



		if	(ie_copia_item_w = 'S') and
			(ie_agrupador_ww = 5) and
			(nvl(nr_sequencia_proc_ww,0) = 0) then
			    ie_copia_item_w := 'N';
		end if;


		if	(ie_copia_item_w = 'S') and
			(not	((ie_agrupador_ww not in (1,2)) or
					 (((ie_copiar_mat_w = 'S') and (ie_agrupador_ww = 2)) or
					 ((ie_copiar_medic_w = 'S') and (ie_agrupador_ww = 1))))) then
			ie_copia_item_w := 'N';
		end if;

		if	(ie_copia_item_w = 'S') and
			(ie_param1128_w = 'S') and
			(ie_agrupador_ww = 1) then
			if	((ie_em_protocolo_vanco_w = 'S') and
				 ((ie_vancomicina_w = 'N') or
				  (ie_urgencia_ww = 'S'))) then
				ie_copia_item_w	:= 'N';
			elsif (ie_vancomicina_w = 'S') then
				cd_medic_posicionar_p	:= cd_material_ww;
			end if;
		end if;


		-- Sair do laco atual, pois o item nao sera copiado
		if	(ie_copia_item_w = 'S') then
			begin
			if	(nvl(ie_regra_disp_ww,'X') <> 'D') then
				-- Tratamento para verificacao do atributo IE_REGRA_DISP
				if	(ie_agrupador_ww = 13) and
					(nr_seq_protocolo_ww is null) and
					(nr_sequencia_solucao_ww is not null) then
					select	max(nr_seq_protocolo)
					into	nr_seq_protocolo_ww
					from	prescr_solucao
					where	nr_seq_solucao = nr_sequencia_solucao_ww
					and		nr_prescricao = nr_prescricao_ww;


					if	(nr_seq_protocolo_ww is null) then
						ie_regra_disp_ww	:= null;
					end if;
				else
					ie_regra_disp_ww	:= null;
				end if;


				-- Tratamento para verificacao dos atributos CD_MOTIVO_BAIXA e DT_BAIXA
				if	(ie_cobra_paciente_ww = 'S') then
					cd_motivo_baixa_ww	:= 0;
					dt_baixa_ww			:= null;
				end if;
			end if;

			ie_loop_w	:= 'S';
			while	(ie_loop_w = 'S') loop
				select	count(*)
				into	qt_itens_w
				from	prescr_material
				where	rownum = 1
				and		nr_prescricao	= nr_prescricao_ww
				and	nr_sequencia	= nr_sequencia_w;
				if	(qt_itens_w	= 0) then
					ie_loop_w	:= 'N';
				else
					nr_sequencia_w	:= nr_sequencia_w + 1;
				end if;
			end loop;


			select	max(ie_sem_aprazamento)
			into	ie_sem_aprazamento_w
			from	intervalo_prescricao
			where	cd_intervalo	= cd_intervalo_ww;


			if	(ie_sem_aprazamento_ww = 'S') and
				(ie_sem_aprazamento_w is null) then
				ie_sem_aprazamento_w	:= 'S';
			elsif	(ie_sem_aprazamento_w is null)  then
				ie_sem_aprazamento_w	:= ie_sem_aprazamento_ww;
			end if;


			if	(ie_receita_prescr_w = 'S') then
				nr_receita_w	:= nr_prescricao_ww;
			end if;


			ie_lipar_w	:= obter_se_limpa_prim_hor(cd_intervalo_ww,cd_setor_prescr_w);


			if	(ie_lipar_w = 'S') then
				hr_prim_horario_ww	:= '';
			end if;


			if	(ie_dias_util_medic_w <> 'N')then
				select  nvl(max(a.nr_dia_util),nvl(nr_dia_util_ww,0)) + 1
				into	nr_dia_util_ww
				from    prescr_material a,
					prescr_medica b
				where   a.nr_prescricao          = b.nr_prescricao
				and     ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_prescricao)   = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescricao_w - 1)
				and     b.nr_atendimento	 = nr_atendimento_p
				and     a.cd_material		 = cd_material_wW
				and     b.nr_prescricao          <> nr_prescricao_w
				and	((b.dt_suspensao is null) or (ie_copia_suspensas_p = 'S'))
				and	((a.dt_suspensao is null) or (ie_copia_suspensas_p = 'S'));
			end if;


			if	(ie_acm_ww = 'S') then
				ds_horarios_ww	:= 'ACM';
				if	(ie_limp_prim_hor_acm_w = 'S') then
					hr_prim_horario_ww := '';
				end if;
			end if;


			if	(ie_urgencia_ww = 'S') then
				ds_horarios_ww		:= to_Char(sysdate,'hh24:mi');
				hr_prim_horario_ww	:= to_Char(sysdate,'hh24:mi');
				nr_ocorrencia_ww	:= 1;
			end if;


			select	max(cd_setor_atendimento)
			into	cd_setor_ant_w
			from	prescr_medica
			where	nr_prescricao	= nr_prescricao_orig_w;


			if	(cd_setor_prescr_w <> cd_setor_ant_w) and
				(cd_setor_prescr_w is not null) and
				(cd_setor_ant_w is not null) then
				cd_protocolo_ww		:= null;
				nr_seq_protocolo_ww	:= null;
				nr_seq_mat_protocolo_ww	:= null;
			end if;


			select max(dt_validade_prescr)
			into   dt_validade_prescr2_ww
			from   prescr_medica
			where  nr_prescricao = nr_prescricao_ww;


			nr_sequencia_diluicao_ww	:= null;


			if	(nr_seq_recomendacao_wW is not null) then
				select	count(*)
				into	cont_w
				from	prescr_recomendacao
				where	rownum = 1
				and		nr_sequencia	= nr_seq_recomendacao_wW
				and	nr_prescricao	= nr_prescricao_ww;


				if	(cont_w = 0) then
					nr_seq_recomendacao_wW	:= null;
				else
					update	prescr_recomendacao
					set		ie_kit_gerado = 'S'
					where	nr_sequencia	= nr_seq_recomendacao_wW
					and		nr_prescricao	= nr_prescricao_ww;
					
				end if;

			end if;


			if	(Var_param1097_w = 'S') and
				(ie_origem_inf_ww <> 'K') and
				(ie_agrupador_ww = 1) then
				ie_kit_gerado_w := 'S';
			else
				ie_kit_gerado_w := 'N';
			end if;

			nr_agrupamento_www := nr_agrupamento_ww + nr_agrup_acum_w;

			if	(length(nr_agrupamento_www) >= 6) then
				select	max(nr_agrupamento) + 1
				into	nr_agrupamento_ww
				from	prescr_material
				where	nr_prescricao	= nr_prescricao_ww;
			else
				nr_agrupamento_ww := nr_agrupamento_www;
			end if;

			ie_gerar_lote_w := 'S';

			if ((ie_gera_disp_acm_sn_w = 'N') and (ie_acm_ww = 'S' or ie_se_necessario_ww = 'S' )) then
				ie_gerar_lote_w := 'N';
			end if;

			Insert  into Prescr_Material (
					nr_prescricao,
					nr_sequencia,
					ie_origem_inf,
					cd_material,
					cd_unidade_medida,
					qt_dose,
					qt_unitaria,
					qt_material,
					dt_atualizacao,
					nm_usuario,
					cd_intervalo,
					ds_horarios,
					ds_observacao,
					ds_observacao_enf,
					ie_via_aplicacao,
					nr_agrupamento,
					ie_cobra_paciente,
					cd_motivo_baixa,
					dt_baixa,
					ie_utiliza_kit,
					cd_unidade_medida_dose,
					nr_seq_via_acesso,
					qt_conversao_dose,
					ie_urgencia,
					nr_ocorrencia,
					qt_total_dispensar,
					cd_fornec_consignado,
					nr_sequencia_solucao,
					nr_sequencia_proc,
					qt_solucao,
					hr_dose_especial,
					qt_dose_especial,
					ds_dose_diferenciada,
					ie_medicacao_paciente,
					nr_sequencia_diluicao,
					hr_prim_horario,
					nr_sequencia_dieta,
					ie_agrupador,
					nr_dia_util,
					ie_se_necessario,
					qt_min_aplicacao,
					ie_bomba_infusao,
					ie_aplic_bolus,
					ie_aplic_lenta,
					ie_acm,
					ie_objetivo,
					cd_topografia_cih,
					ie_origem_infeccao,
					cd_amostra_cih,
					cd_microorganismo_cih,
					ie_uso_antimicrobiano,
					cd_protocolo,
					nr_seq_protocolo,
					nr_seq_mat_protocolo,
					qt_hora_aplicacao,
					ie_recons_diluente_fixo,
					qt_vel_infusao,
					ds_justificativa,
					ie_sem_aprazamento,
					ie_indicacao,
					dt_proxima_dose,
					qt_total_dias_lib,
					nr_seq_substituto,
					ie_lado,
					--dt_inicio_medic,
					qt_dia_prim_hor,
					ie_regra_disp,
					qt_vol_adic_reconst,
					qt_hora_intervalo,
					qt_min_intervalo,
					ie_permite_substituir,
					nr_receita,
					nr_prescricao_original,
					ds_observacao_far,
					nr_seq_recomendacao,
					nr_prescricao_anterior,
					nr_sequencia_anterior,
					cd_kit_material,
					ie_kit_gerado,
					ds_medic_nao_padrao,
					ie_em_protocolo_vanco,
					ie_glicemia,
					ie_fator_correcao,
					ie_aplicar,
					qt_volume_corrigido,
					ie_gerar_lote,
					ie_permite_alterar)
			values(	nr_prescricao_ww,
					nr_sequencia_w,
					ie_origem_inf_ww,
					cd_material_ww	,
					cd_unidade_medida_ww,
					qt_dose_ww,
					qt_unitaria_ww,
					qt_material_ww,
					dt_atualizacao_ww,
					nm_usuario_ww,
					cd_intervalo_ww,
					ds_horarios_ww,
					ds_observacao_ww,
					ds_observacao_enf_ww,
					ie_via_aplicacao_ww,
					nvl(nr_agrupamento_ww,0),
					ie_cobra_paciente_ww,
					cd_motivo_baixa_ww,
					dt_baixa_ww,
					ie_utiliza_kit_ww,
					cd_unidade_medida_dose_ww,
					nr_seq_via_acesso_ww,
					qt_conversao_dose_ww,
					ie_urgencia_ww,
					nr_ocorrencia_ww,
					qt_total_dispensar_ww,
					cd_fornec_consignado_ww,
					nr_sequencia_solucao_ww,
					nr_sequencia_proc_ww,
					qt_solucao_ww,
					hr_dose_especial_ww,
					qt_dose_especial_ww,
					ds_dose_diferenciada_ww,
					ie_medicacao_paciente_ww,
					nr_sequencia_diluicao_ww,
					hr_prim_horario_ww,
					nr_sequencia_dieta_ww,
					ie_agrupador_ww,
					nr_dia_util_ww,
					ie_se_necessario_ww,
					qt_min_aplicacao_ww,
					ie_bomba_infusao_ww,
					ie_aplic_bolus_ww,
					ie_aplic_lenta_ww,
					ie_acm_ww,
					ie_objetivo_ww,
					cd_topografia_cih_ww,
					ie_origem_infeccao_ww,
					cd_amostra_cih_ww,
					cd_microorganismo_cih_ww,
					ie_uso_antimicrobiano_ww,
					cd_protocolo_ww,
					nr_seq_protocolo_ww,
					nr_seq_mat_protocolo_ww,
					qt_hora_aplicacao_ww,
					ie_recons_diluente_fixo_ww,
					qt_vel_infusao_ww,
					ds_justificativa_ww,
					ie_sem_aprazamento_w,
					ie_indicacao_ww,
					dt_proxima_dose_ww,
					qt_total_dias_lib_ww,
					nr_seq_substituto_ww,
					ie_lado_ww,
					--dt_inicio_medic_ww,
					qt_dia_prim_hor_ww,
					ie_regra_disp_ww,
					qt_vol_adic_reconst_ww,
					qt_hora_intervalo_w,
					qt_min_intervalo_ww,
					ie_permite_substituir_ww,
					nr_receita_w,
					nr_prescricao_orig_w,
					ds_observacao_far_ww,
					nr_seq_recomendacao_wW,
					nr_prescricao_orig_w,
					nr_sequencia_orig_w,
					cd_kit_w,
					decode(ie_kit_gerado_w,'N',null,ie_kit_gerado_w),
					ds_medic_nao_padr_w,
					ie_em_protocolo_vanco_w,
					ie_glicemia_w,
					ie_fator_correcao_med_w,
					ie_aplicar_w,
					qt_volume_corrigido_w,
					ie_gerar_lote_w,
					ie_permite_alterar_w);

				if	(ie_regra_disp_ww is null ) then
					Ajustar_prescr_mat_solucao(nr_prescricao_ww, nr_sequencia_solucao_ww);
				end if;


				if 	(cd_kit_w > 0) and
					(Var_param1097_w = 'S') and
					(nr_sequencia_proc_ww > 0) then


					update 	prescr_procedimento
					set	ie_kit_gerado = 'S'
					where 	nr_prescricao = nr_prescricao_ww
					and	nr_sequencia = nr_sequencia_proc_ww
					and	nvl(ie_kit_gerado,'N') = 'N';


				end if;

			if	(ie_copia_albumina_w = 'S') and
				(ie_agrupador_ww = 1) then
				REP_copia_albumina(nr_prescricao_orig_w, nr_prescricao_ww, nr_sequencia_orig_w, nr_sequencia_w, nm_usuario_p);
			end if;

			if (ie_agrupador_ww = 8) then
				gerar_elemento_mat_sne( nr_prescricao_p, nr_sequencia_w, 'G', nm_usuario_p);
			end if;

			if	(nvl(Obter_Se_Solic_Mat(cd_material_ww),'N') = 'S')	then
				REP_copia_indicacao_solic(nr_prescricao_orig_w, nr_prescricao_ww, nr_sequencia_orig_w, nr_sequencia_w, nm_usuario_p);
			end if;
			
			if	(ie_dias_util_medic_w <> 'N')then
				 Gerar_subst_sug_cih(nr_prescricao_ww, nr_sequencia_w, nr_prescricao_orig_w, cd_material_ww);
			end if;

			begin
			insert into prescr_material_cid(
					nr_sequencia,
					cd_doenca_cid,
					nr_prescricao,
					nr_sequencia_medic,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec)
			select	prescr_material_cid_seq.nextval,
					cd_doenca_cid,
					nr_prescricao_w,
					nr_sequencia_w,
					sysdate,
					nm_usuario_p,
					sysdate,
					nm_usuario_p
			from	prescr_material_cid
			where	nr_sequencia_medic = nr_sequencia_orig_w
			and		nr_prescricao	= nr_prescricao_orig_w;
			exception
				when others then
				ie_aux_w := 'X';
			end;

			begin
			if	(ie_copiar_def_infecto_w = 'S') then
				open C27;
				loop
				fetch C27 into
					nr_seq_def_infect_w;
				exit when C27%notfound;
					begin
					insert into cih_def_infect (
						cd_material,
						cd_unidade_medida,
						nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_atendimento,
						cd_medicamento,
						qt_dia_lib,
						qt_dose,
						cd_intervalo,
						ie_via_aplicacao,
						ds_horarios,
						nr_seq_prescr,
						ds_observacao,
						ie_definicao,
						nr_prescricao,
						ie_gera_alerta,
						cd_topografia_cih,
						ie_origem_infeccao)
					select	cd_material,
						cd_unidade_medida,
						cih_def_infect_seq.NextVal,
						sysdate,
						nm_usuario_p,
						sysdate,
						nm_usuario_p,
						nr_atendimento,
						cd_medicamento,
						qt_dia_lib,
						qt_dose,
						cd_intervalo,
						ie_via_aplicacao,
						ds_horarios,
						nr_sequencia_w,
						ds_observacao,
						ie_definicao,
						nr_prescricao_ww,
						ie_gera_alerta,
						cd_topografia_cih,
						ie_origem_infeccao
					from	cih_def_infect
					where	nr_sequencia = nr_seq_def_infect_w;
					end;
				end loop;
				close C27;
			end if;
			exception
				when others then
				nr_seq_def_infect_w := 0;
			end;

			open C18;
			loop
			fetch C18 into
				nr_prescricao_ww,
				nr_sequencia_dil_w,
				ie_origem_inf_ww,
				cd_material_ww	,
				cd_unidade_medida_ww,
				qt_dose_ww,
				qt_unitaria_ww,
				qt_material_ww,
				dt_atualizacao_ww,
				nm_usuario_ww,
				cd_intervalo_ww,
				ds_horarios_ww,
				ds_observacao_ww,
				ds_observacao_enf_ww,
				ie_via_aplicacao_ww,
				nr_agrupamento_ww,
				ie_cobra_paciente_ww,
				cd_motivo_baixa_ww,
				dt_baixa_ww,
				ie_utiliza_kit_ww,
				cd_unidade_medida_dose_ww,
				nr_seq_via_acesso_ww,
				qt_conversao_dose_ww,
				ie_urgencia_ww,
				nr_ocorrencia_ww,
				qt_total_dispensar_ww,
				cd_fornec_consignado_ww,
				nr_sequencia_solucao_ww,
				nr_sequencia_proc_ww,
				qt_solucao_ww,
				hr_dose_especial_ww,
				qt_dose_especial_ww,
				ds_dose_diferenciada_ww,
				ie_medicacao_paciente_ww,
				nr_sequencia_diluicao_ww,
				hr_prim_horario_ww,
				nr_sequencia_dieta_ww,
				ie_agrupador_ww,
				nr_dia_util_ww,
				ie_suspenso_ww,
				ie_se_necessario_ww,
				qt_min_aplicacao_ww,
				ie_bomba_infusao_ww,
				ie_aplic_bolus_ww,
				ie_aplic_lenta_ww,
				ie_acm_ww,
				ie_objetivo_ww,
				cd_topografia_cih_ww,
				ie_origem_infeccao_ww,
				cd_amostra_cih_ww,
				cd_microorganismo_cih_ww,
				ie_uso_antimicrobiano_ww,
				cd_protocolo_ww,
				nr_seq_protocolo_ww,
				nr_seq_mat_protocolo_ww,
				qt_hora_aplicacao_ww,
				ie_recons_diluente_fixo_ww,
				qt_vel_infusao_ww,
				ds_justificativa_ww,
				ie_sem_aprazamento_ww,
				ie_indicacao_ww,
				dt_proxima_dose_ww,
				qt_total_dias_lib_ww,
				nr_seq_substituto_ww,
				ie_lado_ww,
				dt_inicio_medic_ww,
				qt_dia_prim_hor_ww,
				ie_regra_disp_ww,
				qt_vol_adic_reconst_ww,
				qt_hora_intervalo_w,
				qt_min_intervalo_ww,
				ie_permite_substituir_ww,
				ds_observacao_far_ww,
				nr_seq_mat_diluicao_ww,
				ie_dias_util_medic_w,
				qt_qsp_diluente_w,
				ie_aplicar_w;
			exit when C18%notfound;


				ie_loop_w	:= 'S';
				while	(ie_loop_w = 'S') loop
					select	count(*)
					into	qt_itens_w
					from	prescr_material
					where	rownum = 1
					and		nr_prescricao	= nr_prescricao_ww
					and	nr_sequencia	= nr_seq_w;
					if	(qt_itens_w	= 0) then
						ie_loop_w	:= 'N';
					else
						nr_seq_w	:= nr_seq_w + 1;
					end if;
				end loop;


				if	(ie_dias_util_medic_w <> 'N')then
					select  nvl(max(a.nr_dia_util),nvl(nr_dia_util_ww,0)) + 1
					into	nr_dia_util_ww
					from    prescr_material a,
						prescr_medica b
					where   a.nr_prescricao          = b.nr_prescricao
					and     ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_prescricao)   = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescricao_w - 1)
					and     b.nr_atendimento	 = nr_atendimento_p
					and     a.cd_material		 = cd_material_wW
					and     b.nr_prescricao          <> nr_prescricao_w
					and	((b.dt_suspensao is null) or (ie_copia_suspensas_p = 'S'))
					and	((a.dt_suspensao is null) or (ie_copia_suspensas_p = 'S'));
				end if;


				if	(ie_param911_w = 'C') then
					cd_intervalo_ww := null;
					ds_horarios_ww	:= null;
				end if;

				nr_agrupamento_www := nr_agrupamento_ww + nr_agrup_acum_w;

				if	(length(nr_agrupamento_www) >= 6) then
					select	max(nr_agrupamento) + 1
					into	nr_agrupamento_ww
					from	prescr_material
					where	nr_prescricao	= nr_prescricao_ww;
				else
					nr_agrupamento_ww := nr_agrupamento_www;
				end if;

				ie_gerar_lote_w := 'S';
				
				if ((ie_gera_disp_acm_sn_w = 'N') and (ie_acm_ww = 'S' or ie_se_necessario_ww = 'S' )) then
					ie_gerar_lote_w := 'N';
				end if;

				Insert  into Prescr_Material (
						nr_prescricao,
						nr_sequencia,
						ie_origem_inf,
						cd_material,
						cd_unidade_medida,
						qt_dose,
						qt_unitaria,
						qt_material,
						dt_atualizacao,
						nm_usuario,
						cd_intervalo,
						ds_horarios,
						ds_observacao,
						ds_observacao_enf,
						ie_via_aplicacao,
						nr_agrupamento,
						ie_cobra_paciente,
						cd_motivo_baixa,
						dt_baixa,
						ie_utiliza_kit,
						cd_unidade_medida_dose,
						nr_seq_via_acesso,
						qt_conversao_dose,
						ie_urgencia,
						nr_ocorrencia,
						qt_total_dispensar,
						cd_fornec_consignado,
						nr_sequencia_solucao,
						nr_sequencia_proc,
						qt_solucao,
						hr_dose_especial,
						qt_dose_especial,
						ds_dose_diferenciada,
						ie_medicacao_paciente,
						nr_sequencia_diluicao,
						hr_prim_horario,
						nr_sequencia_dieta,
						ie_agrupador,
						nr_dia_util,
						ie_se_necessario,
						qt_min_aplicacao,
						ie_bomba_infusao,
						ie_aplic_bolus,
						ie_aplic_lenta,
						ie_acm,
						ie_objetivo,
						cd_topografia_cih,
						ie_origem_infeccao,
						cd_amostra_cih,
						cd_microorganismo_cih,
						ie_uso_antimicrobiano,
						cd_protocolo,
						nr_seq_protocolo,
						nr_seq_mat_protocolo,
						qt_hora_aplicacao,
						ie_recons_diluente_fixo,
						qt_vel_infusao,
						ds_justificativa,
						ie_sem_aprazamento,
						ie_indicacao,
						dt_proxima_dose,
						qt_total_dias_lib,
						nr_seq_substituto,
						ie_lado,
						--dt_inicio_medic,
						qt_dia_prim_hor,
						ie_regra_disp,
						qt_vol_adic_reconst,
						qt_hora_intervalo,
						qt_min_intervalo,
						ie_permite_substituir,
						nr_prescricao_original,
						ds_observacao_far,
						nr_seq_mat_diluicao,
						qt_qsp_diluente,
						ie_gerar_lote,
						ie_aplicar)
				values(	nr_prescricao_ww,
						nr_seq_w,
						ie_origem_inf_ww,
						cd_material_ww	,
						cd_unidade_medida_ww,
						qt_dose_ww,
						qt_unitaria_ww,
						qt_material_ww,
						dt_atualizacao_ww,
						nm_usuario_ww,
						cd_intervalo_ww,
						ds_horarios_ww,
						ds_observacao_ww,
						ds_observacao_enf_ww,
						ie_via_aplicacao_ww,
						nr_agrupamento_ww,
						ie_cobra_paciente_ww,
						cd_motivo_baixa_ww,
						dt_baixa_ww,
						ie_utiliza_kit_ww,
						cd_unidade_medida_dose_ww,
						nr_seq_via_acesso_ww,
						qt_conversao_dose_ww,
						ie_urgencia_ww,
						nr_ocorrencia_ww,
						qt_total_dispensar_ww,
						cd_fornec_consignado_ww,
						nr_sequencia_solucao_ww,
						nr_sequencia_proc_ww,
						qt_solucao_ww,
						hr_dose_especial_ww,
						qt_dose_especial_ww,
						ds_dose_diferenciada_ww,
						ie_medicacao_paciente_ww,
						nr_sequencia_w,
						hr_prim_horario_ww,
						nr_sequencia_dieta_ww,
						ie_agrupador_ww,
						nr_dia_util_ww,
						ie_se_necessario_ww,
						qt_min_aplicacao_ww,
						ie_bomba_infusao_ww,
						ie_aplic_bolus_ww,
						ie_aplic_lenta_ww,
						ie_acm_ww,
						ie_objetivo_ww,
						cd_topografia_cih_ww,
						ie_origem_infeccao_ww,
						cd_amostra_cih_ww,
						cd_microorganismo_cih_ww,
						ie_uso_antimicrobiano_ww,
						cd_protocolo_ww,
						nr_seq_protocolo_ww,
						nr_seq_mat_protocolo_ww,
						qt_hora_aplicacao_ww,
						ie_recons_diluente_fixo_ww,
						qt_vel_infusao_ww,
						ds_justificativa_ww,
						ie_sem_aprazamento_ww,
						ie_indicacao_ww,
						dt_proxima_dose_ww,
						qt_total_dias_lib_ww,
						nr_seq_substituto_ww,
						ie_lado_ww,
						--dt_inicio_medic_ww,
						qt_dia_prim_hor_ww,
						ie_regra_disp_ww,
						qt_vol_adic_reconst_ww,
						qt_hora_intervalo_w,
						qt_min_intervalo_ww,
						ie_permite_substituir_ww,
						nr_prescricao_orig_w,
						ds_observacao_far_ww,
						nr_seq_mat_diluicao_ww,
						qt_qsp_diluente_w,
						ie_gerar_lote_w,
						ie_aplicar_w);


			end loop;
			close C18;


			select	count(*)
			into	cont_w
			from	prescr_material
			where 	rownum = 1
			and		nr_prescricao		= nr_prescricao_ww
			and	nr_sequencia_diluicao	= nr_sequencia_w
			and	ie_agrupador in(3,7,9);
			

			if	(ie_gerar_diluicao_w in ('S','P'))  and
				(ie_gerar_dil_setor_w = 'S') and
				(var_copia_diluicao_w <> 'S') and
				(((ie_gera_dil_comp_sol_w = 'S') and
				  (nr_sequencia_solucao_ww is not null)) or
				 (nr_sequencia_solucao_ww is null)) and
				((cont_w = 0) or (ie_gerar_diluicao_w = 'P'))then
				gerar_reconst_diluicao(nr_prescricao_ww,nr_sequencia_w,'A');
			end if;


			end;
		else
			grava_prescr_nao_copiados(nr_prescricao_ww, nr_prescricao_orig_w, nr_sequencia_orig_w, cd_material_ww, null, null, null, null, 'N');
		end if;
	elsif (ie_apres_medic_nao_copia_w = 'S') then
		grava_prescr_nao_copiados(nr_prescricao_ww, nr_prescricao_orig_w, nr_sequencia_orig_w, cd_material_ww, ie_situacao_ww, ie_suspenso_ww, null, ie_disponivel_mercado_w, null);
	end if;
	end loop;
	close C17;

	/* Exclui os medicamentos de acordo com o parametro 198 da prescricao - Ivan em 25/03/2008 OS84773 */

	open c10;
	loop
	fetch c10 into
		nr_seq_material_delete_w;
	exit when c10%notfound;
		begin

		if	(consiste_se_copia_medic(nr_prescricao_w, nr_seq_material_delete_w, cd_estabelecimento_w, nm_usuario_p) = 'N') then
			delete	from prescr_material
			where	nr_sequencia	= nr_seq_material_delete_w
			and		nr_prescricao	= nr_prescricao_w;
		end if;
		end;
	end loop;
	close c10;

	/* Remove as informacoes de substituicao apos copiar - Ivan em 25/03/2008 OS84773 */

	if	(ie_copia_direta_w = 'N') then
		update	prescr_material
		set		nr_seq_substituto	= null
		where	nr_seq_substituto	is not null
		and		nr_prescricao		= nr_prescricao_w;
	end if;
end if;

--Hemodialise
	gravar_processo_longo(obter_desc_expressao(781480)/*'Realizando a Copia da Hemodialise'*/
,'COPIA_PRESCRICAO',26);
	select	nvl(max(nr_sequencia),0)
	into	nr_seq_dialise_w
	from	hd_prescricao
	where	nr_prescricao = nr_prescricao_w;


	open C20;
	loop
	fetch C20 into
		qt_fluxo_sangue_w,
		qt_sessao_sem_w,
		qt_hora_sessao_w,
		qt_min_sessao_w,
		nr_seq_mod_dialisador_w,
		ie_ultrafiltracao_w,
		qt_ultrafiltracao_w,
		ie_tipo_hemodialise_w,
		ie_tipo_dialise_w,
		ie_tipo_peritoneal_w,
		nr_seq_maq_cicladora_w,
		qt_peso_ideal_w,
		nr_seq_diametro_agulha_w,
		nr_seq_tipo_agulha_w,
		nr_seq_tipo_agulha_art_w,
		nr_seq_perfil_sodio_w,
		qt_zero_um_w,
		qt_um_dois_w,
		qt_dois_tres_w,
		qt_tres_quatro_w,
		ie_ligar_prime_w,
		qt_peso_seco_w,
		ds_obs_dialise_w,
		ie_categoria_w,
		nr_seq_ultra_w,
		qt_sodio_w,
		qt_calcio_w,
		qt_bicarbonato_w,
		ie_cateter_w,
		qt_zero_um_bic_w,
		qt_um_dois_bic_w,
		qt_dois_tres_bic_w,
		qt_tres_quatro_bic_w,
		qt_quatro_cinco_bic_w,
		qt_cinco_seis_bic_w,
		nr_seq_perfil_bic_w;
	exit when C20%notfound;
		begin
		
		if	(ie_tipo_dialise_w = 'H') and 
			(ie_categoria_w = 'C') then 
			
			select	max(nr_horas_validade)
			into	qt_hora_sessao_w
			from	prescr_medica
			where	nr_prescricao = nr_prescricao_w;
			
			qt_min_sessao_w := 0;
			
		end if;

		Select	hd_prescricao_seq.nextval
		into	nr_sequencia_w
		from	dual;


		qt_peso_pos_w	:= Obter_Peso_Pos_dialise(cd_pessoa_fisica_w);


		qt_peso_pos_ww 	:= qt_peso_w;
		qt_peso_w	:= coalesce(Obter_Peso_pre_dialise(cd_pessoa_fisica_w),0);


		insert into hd_prescricao (
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_prescricao,
					qt_fluxo_sangue,
					qt_sessao_sem,
					qt_hora_sessao,
					qt_min_sessao,
					nr_seq_mod_dialisador,
					ie_ultrafiltracao,
					qt_ultrafiltracao,
					ie_tipo_hemodialise,
					ie_tipo_dialise,
					ie_tipo_peritoneal,
					nr_seq_maq_cicladora,
					qt_peso_ideal,
					nr_seq_diametro_agulha,
					nr_seq_tipo_agulha,
					nr_seq_tipo_agulha_art,
					nr_seq_perfil_sodio,
					qt_zero_um,
					qt_um_dois,
					qt_dois_tres,
					qt_tres_quatro,
					ie_ligar_prime,
					qt_peso_seco,
					ds_observacao,
					ie_categoria,
					nr_seq_ultra,
					qt_sodio,
					qt_calcio,
					qt_bicarbonato,
					nr_prescricao_original,
					qt_peso_pos,
					qt_peso_atual,
					ie_cateter,
					qt_zero_um_bic,
					qt_um_dois_bic,
					qt_dois_tres_bic,
					qt_tres_quatro_bic,
					qt_quatro_cinco_bic,
					qt_cinco_seis_bic,
					nr_seq_perfil_bic)
			values(	nr_sequencia_w,
					sysdate,
					nm_usuario_p,
					sysdate,
					nm_usuario_p,
					nr_prescricao_w,
					qt_fluxo_sangue_w,
					qt_sessao_sem_w,
					qt_hora_sessao_w,
					qt_min_sessao_w,
					nr_seq_mod_dialisador_w,
					ie_ultrafiltracao_w,
					qt_ultrafiltracao_w,
					ie_tipo_hemodialise_w,
					ie_tipo_dialise_w,
					ie_tipo_peritoneal_w,
					nr_seq_maq_cicladora_w,
					qt_peso_ideal_w,
					nr_seq_diametro_agulha_w,
					nr_seq_tipo_agulha_w,
					nr_seq_tipo_agulha_art_w,
					nr_seq_perfil_sodio_w,
					qt_zero_um_w,
					qt_um_dois_w,
					qt_dois_tres_w,
					qt_tres_quatro_w,
					ie_ligar_prime_w,
					qt_peso_seco_w,
					ds_obs_dialise_w,
					ie_categoria_w,
					nr_seq_ultra_w,
					qt_sodio_w,
					qt_calcio_w,
					qt_bicarbonato_w,
					nr_prescricao_orig_w,
					qt_peso_pos_w,
					qt_peso_w,
					ie_cateter_w,
					qt_zero_um_bic_w,
					qt_um_dois_bic_w,
					qt_dois_tres_bic_w,
					qt_tres_quatro_bic_w,
					qt_quatro_cinco_bic_w,
					qt_cinco_seis_bic_w,
					nr_seq_perfil_bic_w);


		update	prescr_solucao
		set		nr_seq_dialise = nr_Sequencia_w
		where	nr_prescricao = nr_prescricao_w
		and		(((ie_tipo_dialise_w = 'P') and
				  (ie_hemodialise = 'P')) or
				 ((ie_tipo_dialise_w = 'H') and
				  (ie_hemodialise = 'S')));
				  
		if (ie_tipo_dialise_w = 'H') then
			
			open c0020;
			loop
			fetch c0020 into	nr_seq_solucao_w,
								ie_tipo_solucao_w;
			exit when c0020%notfound;
				begin
				if (ie_categoria_w = 'C') then
					calc_etapa_sol_dialise(nr_prescricao_w, nr_sequencia_w, nr_seq_solucao_w,nm_usuario_p);
				end if;
				if (ie_tipo_solucao_w <> 'C') then
					calc_vol_total_sol_protocol(nr_prescricao_w, nr_sequencia_w, nr_seq_solucao_w);
				end if;
				end;
			end loop;
			close c0020;
			
		end if;


		end;
	end loop;
	close C20;




	open c31;
	loop
	fetch c31 into
		nr_seq_protocolo_www;
	exit when c31%notfound;


	select  nvl(max(nr_etapas),1)
	into 	nr_etapas_www
	from	protocolo_npt
	where	nr_sequencia	= nr_seq_protocolo_www;


	update	prescr_solucao
	set		nr_etapas        = nr_etapas_www
	where	nr_seq_dialise	 is not null
	and		nr_prescricao	 = nr_prescricao_w
	and		nr_seq_protocolo = nr_seq_protocolo_www
	and		((cd_protocolo is null) or (coalesce(nr_etapas,0) = 0));


	end loop;
	close c31;


	if	(VarExibeItensNaoCopiados_w = 'S') then
		open c26;
		loop
		fetch c26 into
			nr_seq_item_ww,
			ds_item_ww,
			ie_tipo_item_ww;
		exit when c26%notfound;


			select	rep_item_eliminado_seq.nextval
			into	nr_seq_registro_w
			from	dual;


			insert into REP_ITEM_ELIMINADO(
				nr_sequencia,
				nr_prescricao,
				nr_seq_item,
				ds_item,
				ie_tipo_item,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nm_usuario,
				nm_usuario_nrec,
				ie_forma_apresentacao
			) values (
				nr_seq_registro_w,
				nr_prescricao_w,
				nr_seq_item_ww,
				ds_item_ww,
				ie_tipo_item_ww,
				sysdate,
				sysdate,
				nm_usuario_p,
				nm_usuario_p,
				'S');


		end loop;
		close c26;
	end if;

	if (nvl(length(nr_prescricoes_ww),0) = 0) then
		nr_prescricoes_ww := nr_prescricao_orig_w;
	else
		nr_prescricoes_ww := nr_prescricoes_ww  || ',' ||  nr_prescricao_orig_w;
	end if;
	end;
END LOOP;
CLOSE C001;

if	(ie_proced_agora_p = 'S') then	/*	Oraci em 11/07/2008 OS96551	 */
	select	nvl(max(cd_intervalo),'XPTO')
	into	cd_intervalo_proc_agora_w
	from	intervalo_prescricao
	where	ie_agora	= 'S'
	and	ie_situacao	= 'A'
	and	Obter_se_intervalo(cd_intervalo, 'P') = 'S';


	if	(cd_intervalo_proc_agora_w <> 'XPTO') then


		update	prescr_procedimento
		set	ie_urgencia = 'S',
			cd_intervalo	= cd_intervalo_proc_agora_w,
			dt_prev_execucao = trunc(sysdate, 'mi'),
			ds_horarios	= to_char(sysdate, 'hh24:mi')
		where	nr_prescricao = nr_prescricao_w;


	end if;
end if;

commit;
--if	(ie_recalc_horario_p = 'S') then --> Rafael em 27/8/8 OS : 95944 / 96333;
if	(ie_recalc_horario_p not in('N')) then
	select	dt_primeiro_horario
	into	dt_primeiro_horario_mae_w
	from	prescr_medica
	where	nr_prescricao = NR_PRESCRICAO_P;
	if	(to_char(dt_primeiro_horario_w,'hh24:mi') <> to_char(dt_primeiro_horario_mae_w,'hh24:mi')) then
		Recalcular_hor_prescricao(nr_prescricao_w, nm_usuario_p);
	end if;
end if;

COMMIT;
nr_horas_validade_padrao_ww := nr_horas_validade_padrao_w;
if	(nvl(nr_horas_validade_padrao_ww,0) = 0) then
	nr_horas_validade_padrao_ww := 24;
end if;
OPEN C000;
LOOP
FETCH C000 INTO
	ie_dias_util_medic_w,
	cd_material_w,
	nr_sequencia_w,
	qt_unitaria_w,
	qt_material_w,
	ds_horarios_w,
	nr_ocorrencia_w,
	qt_total_dispensar_w,
	nr_sequencia_diluicao_w,
	hr_prim_horario_w,
	ds_dose_diferenciada_w,
	nr_horas_validade_w,
	ie_operacao_w,
	qt_operacao_w,
	cd_intervalo_w,
	ie_via_aplicacao_w,
	cd_unidade_medida_dose_w,
	ie_agrupador_w,
	ie_se_necessario_w,
	ie_acm_w,
	qt_hora_intervalo_w,
	qt_min_intervalo_w,
	hr_inicio_prescr_w,
	qt_dose_w,
	ds_justificativa_ww,
	ie_origem_infeccao_ww,
	ie_objetivo_ww;
exit when c000%notfound;
begin
	ie_lipar_w := nvl(obter_se_limpa_prim_hor(cd_intervalo_w,cd_setor_prescr_w),'N');

	if	(ie_lipar_w = 'N') then
		ds_horarios_ww		:= ds_horarios_w;
		hr_prim_horario_ww	:= hr_prim_horario_w;

	else
		hr_prim_horario_ww	:= null;
	end if;

	if	((ie_calcula_validade_w = 'S') or (ie_recalc_horario_p not in ('N','V'))) and
		(ie_se_necessario_w <> 'S') then


	

		--if	(ie_operacao_w in ('F','V')) then
			hr_prim_hora_medic_w	:= obter_primeiro_horario(cd_intervalo_w,nr_prescricao_w,cd_material_w,ie_via_aplicacao_w);
		--end if;
		if	(ie_recalc_horario_p in ('I','H')) and
			(ie_agrupador_w in (1,16)) then


			if	(somente_numero(nr_prescricoes_w) = 0) then
				nr_prescricoes_w	:= to_char(NR_PRESCRICAO_P);
			end if;

			if	(ie_agrupador_w = 1) then

				hr_prim_horario_interv_w	:= obter_prim_hor_medic_interv(nr_atendimento_p,
						nr_prescricoes_ww,dt_inicio_prescr_w, cd_material_w, cd_intervalo_w,
						ie_recalc_horario_p,null,ie_copia_agora_w, qt_dose_w);

			elsif	(ie_agrupador_w = 16) then


				hr_prim_horario_interv_w	:= obter_prim_hor_leite_interv(nr_atendimento_p,
						nr_prescricoes_ww,dt_inicio_prescr_w, cd_material_w, cd_intervalo_w,
						ie_recalc_horario_p,null,ie_copia_agora_w, qt_dose_w);

			end if;


			if	(hr_prim_horario_interv_w is null) or
				((ie_recalc_horario_p = 'I') and
				 (hr_prim_horario_interv_w < dt_inicio_prescr_w)) then
				hr_prim_hora_medic_w	:= hr_prim_hora_medic_w;
			else
				hr_prim_hora_medic_w	:= to_char(hr_prim_horario_interv_w,'hh24:mi');
			end if;

		end if;


		if	(ie_recalc_horario_p not in ('N','V')) and
			(ie_lipar_w <> 'S') and
			(hr_prim_hora_medic_w is not null) and
			(hr_prim_hora_medic_w <> '  :  ') and
			(ie_se_necessario_w <> 'S') and
			(ie_acm_w <> 'S') then
			hr_prim_horario_w	:= hr_prim_hora_medic_w;
			begin
			update	prescr_material
			set	hr_prim_horario	= hr_prim_hora_medic_w
			where	nr_prescricao 	= nr_prescricao_w
			and	nr_sequencia	= nr_sequencia_w;
			exception when others then
				null;
			end;
		end if;

		if	((ie_lipar_w = 'N') and
			 (ie_recalc_horario_p not in ('N','V'))) then
			 nr_ocorrencia_w	:= 0;
				
			if	(hr_prim_horario_w is not null) and
				(hr_prim_horario_w <> '  :  ') then
				dt_prim_hora_int_w 	:= to_date(to_char(dt_prescricao_w,'dd/mm/yyyy')||' '|| hr_prim_horario_w ||'$00','dd/mm/yyyy hh24:mi:ss');
			else
				dt_prim_hora_int_w	:= dt_inicio_prescr_w;
			end if;


			Calcular_Horario_Prescricao(nr_prescricao_w,cd_intervalo_w,dt_primeiro_horario_w,nvl(dt_prim_hora_int_w,dt_primeiro_horario_w),nr_horas_validade_w,
						cd_material_w,qt_hora_intervalo_w,qt_min_intervalo_w,nr_ocorrencia_w,ds_horarios_w,ds_horarios2_w,'N', ds_dose_diferenciada_w);

			ds_horarios_w	:= ds_horarios_w || ds_horarios2_w;
		end if;


		if	(ie_se_necessario_w = 'S') then
			select	nvl(max(b.qt_se_necessario),0),
					nvl(max(b.ie_mesmo_zerado),'N')
			into		nr_ocorrencia_w,
					ie_mesmo_zerado_w
			from		intervalo_prescricao a,
					intervalo_setor b
			where	a.cd_intervalo 		= b.cd_intervalo
			and		nvl(b.cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w
			and		nvl(b.cd_estab, cd_estabelecimento_w)			= cd_estabelecimento_w
			and		a.cd_intervalo 		= cd_intervalo_w
			and		((b.cd_material = cd_material_w) or
					 (b.cd_material is null))
			and		((b.ie_via_aplicacao = nvl(ie_via_aplicacao_w,b.ie_via_aplicacao)) or
					 (b.ie_via_aplicacao is null))
			and		((b.cd_unidade_basica = nvl(obter_unid_atend_setor_atual(nr_atendimento_p,cd_setor_atendimento_w,'UB'),b.cd_unidade_basica)) or
					 (b.cd_unidade_basica is null));


			if	(nvl(nr_ocorrencia_w,0) = 0) and
				(ie_mesmo_zerado_w = 'N') then


				select	nvl(max(qt_se_necessario),1)
				into	nr_ocorrencia_w
				from	intervalo_prescricao
				where	cd_intervalo	= cd_intervalo_w;
			end if;


			ds_horarios_w	:= 'SN';

		elsif	(ie_acm_w = 'S') then
			select	nvl(max(b.qt_se_necessario),0),
					nvl(max(b.ie_mesmo_zerado),'N')
			into		nr_ocorrencia_w,
					ie_mesmo_zerado_w
			from		intervalo_prescricao a,
					intervalo_setor b
			where	a.cd_intervalo 		= b.cd_intervalo
			and		nvl(b.cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w
			and		nvl(b.cd_estab, cd_estabelecimento_w)			= cd_estabelecimento_w
			and		a.cd_intervalo 		= cd_intervalo_w
			and		((b.cd_material = cd_material_w) or
					 (b.cd_material is null))
			and		((b.ie_via_aplicacao = nvl(ie_via_aplicacao_w,b.ie_via_aplicacao)) or
					 (b.ie_via_aplicacao is null))
			and		((b.cd_unidade_basica = nvl(obter_unid_atend_setor_atual(nr_atendimento_p,cd_setor_atendimento_w,'UB'),b.cd_unidade_basica)) or
					 (b.cd_unidade_basica is null));


			if	(nvl(nr_ocorrencia_w,0) = 0) and
				(ie_mesmo_zerado_w = 'N') then


				select	nvl(max(qt_se_necessario),1)
				into	nr_ocorrencia_w
				from	intervalo_prescricao
				where	cd_intervalo	= cd_intervalo_w;
			end if;

			ds_horarios_w	:= 'ACM';
		--	nr_ocorrencia_w	:= 1; Edilson em 08/01/08 OS 78593
		end if;

	end if;


	if	(ie_se_necessario_w = 'S') then
		select	nvl(max(b.qt_se_necessario),0),
				nvl(max(b.ie_mesmo_zerado),'N')
		into		nr_ocorrencia_w,
				ie_mesmo_zerado_w
		from		intervalo_prescricao a,
				intervalo_setor b
		where	a.cd_intervalo 		= b.cd_intervalo
		and		nvl(b.cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w
		and		nvl(b.cd_estab, cd_estabelecimento_w)			= cd_estabelecimento_w
		and		a.cd_intervalo 		= cd_intervalo_w
		and		((b.cd_material = cd_material_w) or
				 (b.cd_material is null))
		and		((b.ie_via_aplicacao = nvl(ie_via_aplicacao_w,b.ie_via_aplicacao)) or
				 (b.ie_via_aplicacao is null))
		and		((b.cd_unidade_basica = nvl(obter_unid_atend_setor_atual(nr_atendimento_p,cd_setor_atendimento_w,'UB'),b.cd_unidade_basica)) or
				 (b.cd_unidade_basica is null));


		if	(nvl(nr_ocorrencia_w,0) = 0) and
			(ie_mesmo_zerado_w = 'N') then
			select	nvl(max(qt_se_necessario),1)
			into	nr_ocorrencia_w
			from	intervalo_prescricao
			where	cd_intervalo	= cd_intervalo_w;
		end if;
		ds_horarios_w	:= 'SN';
	end if;


	if	(ds_dose_diferenciada_w is not null) then
		ds_dose_dif_w	:= ds_dose_diferenciada_w;
		qt_material_w	:= 0;
		while ds_dose_dif_w is not null LOOP
			begin
			i	:= instr(ds_dose_dif_w, '-');
			if	(i > 0) then
				qt_material_w		:= qt_material_w + to_number(substr(ds_dose_dif_w, 1, i-1));
				ds_dose_dif_w		:= substr(ds_dose_dif_w, i+1, 255);
			else
				qt_material_w		:= qt_material_w + to_number(ds_dose_dif_w);
				ds_dose_dif_w		:= '';
			end if;

			end;
		end loop;

		qt_material_w	:= obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida_dose_w,qt_material_w);
	end if;


	if	(nr_ocorrencia_w = 0) and
		(ds_horarios_w <> 'SN') and
		(ds_horarios_w <> 'ACM') then
		nr_ocorrencia_w	:= obter_ocorrencias_horarios_rep(ds_horarios_w);
	end if;


	Obter_Quant_Dispensar(	cd_estabelecimento_w, cd_material_w, nr_prescricao_w, nr_sequencia_w, cd_intervalo_w,
				ie_via_aplicacao_w, qt_unitaria_w, 0,nr_ocorrencia_w, ds_dose_diferenciada_w,
				ie_origem_inf_w, cd_unidade_medida_dose_w, 1, qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w,ie_se_necessario_w,ie_acm_w);


	if	(ie_lipar_w	= 'N') then
		if	(((hr_prim_horario_ww is null) and
			  (hr_prim_hora_medic_w is null)) or
			 (ie_recalc_horario_p in ('N'))) then
			ds_horarios_w	:= ds_horarios_ww;
		end if;


		qt_dia_prim_hor_w	:= 0;
		if	(hr_prim_horario_w <> '') and
			(hr_prim_horario_w <> '  :  ') and
			(hr_prim_horario_w < to_char(dt_inicio_prescr_w,'hh24:mi')) then
			qt_dia_prim_hor_w	:= 1;
		end if;

		if	(ie_recalc_horario_p = 'V') then
			ds_horarios_w	:= reordenar_horarios(dt_inicio_prescr_w, ds_horarios_w);
		end if;
	end if;


	if	(ie_se_necessario_w	= 'S') then	/*OS 155121 21/07/2009 - rfcaldas*/
		ds_horarios_w	:= 'SN';
	end if;


	if	(ie_param911_w = 'C') then
		 ds_horarios_w	:= null;
		end if;


	update	prescr_material
	set 	ds_horarios		= ds_horarios_w,
		qt_dia_prim_hor		= qt_dia_prim_hor_w
	where	nr_prescricao 		= nr_prescricao_w
	and	nr_sequencia		= nr_sequencia_w;


	update	prescr_material
	set 	nr_ocorrencia		= nr_ocorrencia_w,
		qt_total_dispensar	= qt_total_dispensar_w,
		qt_material		= qt_material_w,
		ie_regra_disp		= decode(nvl(ie_regra_disp,'X'), 'D', ie_regra_disp, ie_regra_disp_w)
	where	nr_prescricao 		= nr_prescricao_w
	and	nr_sequencia		= nr_sequencia_w
	and	((ie_agrupador	<> 5) or (VarIeAjustarDispAssoc_w = 'S'));




	if	(ie_se_necessario_w	= 'S') then	/*OS 155121 21/07/2009 - rfcaldas*/
		ds_horarios_w	:= 'SN';
		if	(ie_param911_w = 'C') then
		        ds_horarios_w	:= null;
		end if;


		update	prescr_material
		set 	nr_ocorrencia		= nr_ocorrencia_w,
			qt_total_dispensar	= qt_total_dispensar_w,
			qt_material		= qt_material_w,
			ds_horarios		= ds_horarios_w,
			ie_regra_disp		= decode(nvl(ie_regra_disp,'X'), 'D', ie_regra_disp, ie_regra_disp_w),
			qt_dia_prim_hor		= qt_dia_prim_hor_w
		where	nr_prescricao 		= nr_prescricao_w
		and	nr_sequencia		= nr_sequencia_w
		and	hr_prim_horario		is null
		and	((ie_agrupador	<> 5) or (VarIeAjustarDispAssoc_w = 'S'))
		and	ie_se_necessario	= 'S';
	end if;

	begin


	nr_atendimento_w	:= nr_atendimento_p;
	if	(VarAtualizaDiasAtend_w	= 'S') then
		select	max(a.nr_atendimento),
			max(a.cd_pessoa_fisica),
			max(b.ie_tipo_atendimento)
		into	nr_atendimento_w,
			cd_pessoa_atend_w,
			ie_tipo_atendimento_w
		from	atendimento_paciente b,
			prescr_medica a
		where	a.nr_atendimento	= b.nr_atendimento
		and	a.nr_prescricao		= nr_prescricao_p;


		if	--(ie_tipo_atendimento_w	<> 3) or
			(cd_pessoa_atend_w	<> cd_pessoa_fisica_w) then
			nr_atendimento_w	:= nr_atendimento_p;
		end if;
	end if;


	select	nvl(max(a.nr_dia_util),0)
	into	nr_dia_util_w
	from	prescr_material a,
		prescr_medica b
	where	a.nr_prescricao	= b.nr_prescricao
	  and	b.nr_atendimento= nr_atendimento_w
	  and	a.cd_material 	= cd_material_w
	  and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_prescricao) = (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescricao_p) - 1);

	exception
	when others then
		nr_dia_util_w := 0;
	end;

	if	(ie_dias_util_medic_w <> 'N')then


		Consiste_Util_Medic(nr_prescricao_w,nr_atendimento_w,dt_prescricao_p,cd_material_w,nr_dia_util_w,qt_dias_liberado_w,ie_controle_medico_w,qt_dias_lib_atend_w);

		if	(nvl(ie_justificativa_novo_w,'N') <> 'N') and
			(ie_controle_medico_w <> '0') and
			(nr_dia_util_w > qt_dias_lib_atend_w) and
			(nr_prescr_origem_fut_p is null) then


			if	(ie_justificativa_novo_w = 'C') then
				select	max(b.ds_justificativa),
						max(b.ie_origem_infeccao),
						max(b.ie_objetivo)
				into	ds_justificativa_w,
						ie_origem_infeccao_w,
						ie_objetivo_w
				from	prescr_material b,
						prescr_medica a
				where	b.cd_material = cd_material_w
				and		b.ie_agrupador = 1
				and		a.nr_prescricao = b.nr_prescricao
				and		a.dt_prescricao > (sysdate - 2)
				and		a.nr_atendimento = nr_atendimento_w;


				if	(ds_justificativa_ww is null) then
					ds_justificativa_ww := ds_justificativa_w;
				end if;


				if	(ie_origem_infeccao_ww is null) then
					ie_origem_infeccao_ww	:= ie_origem_infeccao_w;
				end if;

				if	(ie_objetivo_ww is null) then
					ie_objetivo_ww			:= ie_objetivo_w;
				end if;


			elsif	(ie_justificativa_novo_w in ('S', 'A') and ((instr(ds_justificativa_ww, /*'Novo ciclo iniciado'*/ obter_desc_expressao(507350)) = 0) or length(ds_justificativa_ww) is null)) then
				ds_justificativa_ww	:= substr(ds_justificativa_ww ||' '|| obter_desc_expressao(507350) /*' Novo ciclo iniciado'*/,1,2000);
			end if;
		end if;

		update	prescr_material
		set		nr_dia_util			= nr_dia_util_w,
				qt_total_dias_lib 	= qt_dias_lib_atend_w,
				ds_justificativa	= substr(ds_justificativa_ww,1,2000),
				ie_origem_infeccao	= ie_origem_infeccao_ww,
				ie_objetivo			= ie_objetivo_ww
		where	nr_sequencia		= nr_sequencia_w
		and		nr_prescricao 		= nr_prescricao_w;
	end if;


	if	(ds_dose_diferenciada_w is null) and
		(ie_operacao_w		in ('X', 'H')) and
  		(ie_ajustar_qt_p 		= 'S') and
	--	(nr_horas_validade_w 	<> 24) and
		(nr_horas_validade_w 	<> nr_horas_validade_padrao_ww) and
		(ie_calcula_validade_w = 'N') then
		begin
	/*vhkrausser - substritui o fixo 24 por uma variavel que respeita um parametro (Alemao usa fixo 30h validade) - OS 282776*/

		update	prescr_medica
	--	set	nr_horas_validade	= decode(ie_informa_validade_copia_w, 'S', nr_horas_validade, 24)
		set	nr_horas_validade	= decode(ie_informa_validade_copia_w, 'S', nr_horas_validade, nr_horas_validade_padrao_ww)
		where	nr_prescricao		= nr_prescricao_w;


		if	(ie_se_necessario_w	= 'S') then	/*OS 155121 21/07/2009 - rfcaldas*/
			ds_horarios_w	:= 'SN';
		end if;


		if	(ie_param911_w = 'C') then
		        ds_horarios_w	:= null;
		end if;


		update	prescr_material
		set 	hr_dose_especial	= null,
			qt_dose_especial	= null,
			NR_OCORRENCIA		= nr_ocorrencia_w,
			qt_total_dispensar	= qt_total_dispensar_w,
			qt_material		= qt_material_w,
			ds_horarios		= ds_horarios_w,
			--ie_regra_disp		= ie_regra_disp_w
			ie_regra_disp		= decode(nvl(ie_regra_disp,'X'), 'D', ie_regra_disp, ie_regra_disp_w)
		where 	nr_prescricao 		= nr_prescricao_w
	  	and 	nr_sequencia		= nr_sequencia_w
		and	((ie_agrupador	<> 5) or (VarIeAjustarDispAssoc_w = 'S'));
		end;
	end if;
	Ajustar_Prescr_Material(nr_prescricao_w,nr_sequencia_w);
	end;
END LOOP;
CLOSE C000;

if	(ie_recalc_horario_p not in('N','V')) then

	wheb_assist_pck.obterValorParametroREP(845,ie_recalc_hor_recomendacoes_w);

	open C002;
	loop
	fetch C002 into
		cd_recomendacao_w,
		nr_sequencia_w,
		ds_horarios_w,
		nr_ocorrencia_w,
		hr_prim_horario_w,
		nr_horas_validade_w,
		cd_intervalo_w,
		hr_inicio_prescr_w,
		ie_operacao_w,
		qt_operacao_w;
	exit when C002%notfound;


		if	((ie_calcula_validade_w = 'S') or (ie_recalc_horario_p not in ('N','V'))) then
			nr_ocorrencia_w	:= 0;


			if	(nvl(ie_recalc_hor_recomendacoes_w,'N') = 'N')	then
				dt_prim_hora_int_w	:= dt_inicio_prescr_w;
			else
				begin
				dt_prim_hora_int_w	:= to_date(to_char(dt_prescricao_w,'dd/mm/yyyy')||' '||substr(Obter_primeiro_horario(cd_intervalo_w,nr_prescricao_w,null,null),1,20),'dd/mm/yyyy hh24:mi:ss');
				exception when others then
				dt_prim_hora_int_w	:= dt_inicio_prescr_w;
				end;
			end if;
			Calcular_Horario_Prescricao(nr_prescricao_w,cd_intervalo_w,dt_primeiro_horario_w,nvl(dt_prim_hora_int_w,dt_primeiro_horario_w),nr_horas_validade_w,
						null,null,null,nr_ocorrencia_w,ds_horarios_w,ds_horarios2_w,'N', null);
			ds_horarios_w	:= ds_horarios_w || ds_horarios2_w;
		end if;


		update	prescr_recomendacao
		set 	hr_prim_horario		= to_char(dt_prim_hora_int_w,'hh24:mi'),
			ds_horarios		= ds_horarios_w
		where	nr_prescricao 		= nr_prescricao_w
		and	nr_sequencia		= nr_sequencia_w
		and	hr_prim_horario		is not null;


	end loop;
	close C002;


end if;
gravar_processo_longo(obter_desc_expressao(781472)/*'Realizando a Copia da Prescricao'*/
,'COPIA_PRESCRICAO',28);

OPEN C05;
LOOP
FETCH C05 INTO
		nr_sequencia_w;
	exit when c05%notfound;
		consistir_prescr_material(nr_prescricao_w, nr_sequencia_w, nm_usuario_p, cd_perfil_w, ds_erro_w);
END LOOP;
CLOSE C05;

select	nvl(max(nr_horas_validade),24)
into	nr_horas_validade_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_w;

COMMIT;

OPEN C06;
LOOP
FETCH C06 INTO
	nr_sequencia_w,
	cd_intervalo_proc_w,
	dt_prev_execucao_w,
	cd_procedimento_w,
	ie_origem_proced_w,
	ds_horarios_w,
	ie_situacao_w,
	nr_seq_exame_w,
	nr_horas_validade_w,
	qt_hora_intervalo_w,
	qt_min_intervalo_w,
	nr_seq_proc_int_w,
	ie_ctrl_glic_w,
	ie_urgencia_ww;
exit when c06%notfound;
		begin
		ds_horarios_acm_sn_w := ds_horarios_w;


		dt_prev_execucao_ww	:= null;
		if	(ie_situacao_w = 'I') then
			cd_intervalo_proc_w	:= cd_intervalo_param_w;
		end if;


		if	(ie_recalc_horario_p <> 'V') or
			(ds_horarios_w is null) then
			nr_ocorrencia_w		:= 0;
			if	(nr_seq_exame_w is null) and
				(ie_regra_medic_w = 'S') then
				begin
				if	(somente_numero(nr_prescricoes_w) = 0) then
					nr_prescricoes_w	:= to_char(nr_prescricao_p);
				end if;


				if	(ie_recalc_horario_p in ('I','H')) then
					dt_prev_execucao_ww	:= obter_prim_hor_proc_interv(nr_atendimento_p,
											nr_prescricoes_w,
											dt_inicio_prescr_w,
											cd_procedimento_w,
											ie_origem_proced_w,
											cd_intervalo_proc_w,
											ie_recalc_horario_p,
											null);
				elsif	(ie_recalc_horario_p	= 'S') and
					(cd_intervalo_proc_w is not null) and
					(VarRecalculaProcInterv_w	= 'S') then
					dt_prev_execucao_ww	:= Obter_Horario_Proced_interv	(cd_intervalo_proc_w,
												nr_prescricao_w,
												dt_prev_execucao_w,
												dt_prescricao_p);


				end if;
				if	(dt_prev_execucao_ww is not null) then
					dt_prev_execucao_w	:= dt_prev_execucao_ww;
				end if;
				end;
			elsif	(ie_data_prescr_w = 'S') then
				dt_prev_execucao_w	:= dt_prescricao_p;
				dt_prev_execucao_ww	:= dt_prescricao_p;
			end if;


			nr_intervalo_ww	:= nr_intervalo_w;
			ds_horarios_ww	:= ds_horarios_w;


			Calcular_Horario_Prescricao(nr_prescricao_w, cd_intervalo_proc_w, dt_inicio_prescr_w, dt_prev_execucao_w,nr_horas_validade_w,
						cd_procedimento_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w,'N', null);

		else
			ds_horarios_w 	:= reordenar_horarios(dt_inicio_prescr_tes_w, reordenar_horarios_copia(ds_horarios_w));
			nr_ocorrencia_w :=  obter_ocorrencias_horarios_rep(ds_horarios_w);
		end if;


		if	(ie_recalc_horario_p <> 'N') or
			((ie_data_prescr_w = 'S') and (nr_seq_exame_w is not null)) then


			ds_horarios_aux_w := ds_horarios_w||ds_horarios2_w;


			--Eliminar horarios fora da validade da precricao.
			if	(ie_param443_w = 'S') then
				ds_horarios_ww := Eliminar_hor_vigencia_proc(ds_horarios_aux_w, cd_intervalo_proc_w, dt_inicio_prescr_w, dt_inicio_prescr_w, qt_hora_intervalo_w,
										qt_min_intervalo_w, nr_prescricao_w, ie_urgencia_ww, dt_prev_execucao_w);

				--Caso ocorra algum problema na  Eliminar_hor_vigencia_proc.
				if	(trim(coalesce(ds_horarios_ww,'')) = '') then
					ds_horarios_ww := ds_horarios_aux_w;
				end if;
			else
				ds_horarios_ww := ds_horarios_aux_w;
			end if;


			--Se o procedimento for ACM/SN devera setar ACM/SN no ds_horarios da prescr_procedimento.
			if	((ds_horarios_acm_sn_w = 'ACM') or (ds_horarios_acm_sn_w = 'SN')) then
				ds_horarios_ww :=  ds_horarios_acm_sn_w;
			end if;


			if	(nvl(ie_ctrl_glic_w,'KK') <> 'CIG') then
				update	prescr_procedimento
				set	ds_horarios	= ds_horarios_ww,
					cd_intervalo	= cd_intervalo_proc_w,
					dt_prev_execucao= dt_prev_execucao_w,
					nr_ocorrencia	= nr_ocorrencia_w
				where	nr_sequencia	= nr_sequencia_w
				and	nr_prescricao	= nr_prescricao_w;
			elsif	(ie_ctrl_glic_w = 'CIG') then
				update	prescr_procedimento --Controle intensivo  glicemia
				set	ds_horarios	= to_char(dt_prev_execucao_w,'hh24:mi'),
					cd_intervalo	= cd_intervalo_proc_w,
					dt_prev_execucao= dt_prev_execucao_w,
					nr_ocorrencia	= nr_ocorrencia_w
				where	nr_sequencia	= nr_sequencia_w
				and	nr_prescricao	= nr_prescricao_w;
			end if;
		end if;

		consistir_prescr_procedimento(nr_prescricao_w, nr_sequencia_w, nm_usuario_p, cd_perfil_p, ds_erro_w);
		end;
END LOOP;
CLOSE C06;

if	(ie_hora_sne_w = 'S') then
	OPEN C07;
	LOOP
	FETCH C07 INTO
			nr_sequencia_w;
		exit when c07%notfound;
			update	prescr_material
			set		hr_prim_horario	= null,
					ds_horarios	= null
			where	nr_sequencia	= nr_sequencia_w
			and		nr_prescricao	= nr_prescricao_w;
	END LOOP;
	CLOSE C07;
end if;

update	prescr_material
set	hr_prim_horario	= null,
	ds_horarios	= null
where	nvl(ie_sem_aprazamento,'N')	= 'S'
and	ie_horario_sem_apraso_w		= 'S'
and	ie_agrupador	= 1
and	nr_prescricao	= nr_prescricao_w;

update	prescr_material
set	hr_prim_horario	= null,
	ds_horarios	= null
where	nvl(ie_sem_aprazamento,'N')	= 'N'
and	ie_acm		<> 'S'
and	ie_se_necessario <> 'S'
and	obter_dados_intervalo_prescr(cd_intervalo, 'L', nm_usuario) = 'S'
and	ie_agrupador	= 1
and	nr_prescricao	= nr_prescricao_w;

/* Edilson em 01/03/2008 OS 84565 */

--if	(ie_recalc_horario_p = 'S') then --> Rafael em 27/8/8 OS : 95944 / 96333;
if	(ie_recalc_horario_p not in('N','V')) then

	begin

	gravar_processo_longo(obter_desc_expressao(781494)/*'Recalculando Horarios'*/
,'COPIA_PRESCRICAO',30);
	wheb_assist_pck.obterValorParametroREP(322,ie_recalc_total_w);
	wheb_assist_pck.obterValorParametroREP(332,ie_prim_hor_sol_w);
	ds_horarios_w	:= '';

	open c08;
	loop
	fetch C08 into
		nr_seq_Solucao_w,
		dt_primeiro_horario_w,
		nr_etapas_w,
		qt_tempo_aplicacao_w,
		ie_esquema_alternado_w,
		cd_intervalo_soluc_w,
		qt_dosagem_w,
		ie_tipo_dosagem_w;
	exit when C08%notfound;
		begin
		
		if	(ie_recalc_total_w <> 'N') then
			qt_tempo_aplicacao_w	:= nvl(nr_horas_validade_w, 24);
		end if;
		
		if	(nvl(VarCalcularEtapaSolucao_w,'N') = 'S') then
					


			update 	prescr_solucao 
			set 	qt_tempo_aplicacao	= qt_tempo_aplicacao_w
			where	nr_seq_solucao		= nr_seq_Solucao_w
			and		nr_prescricao		= nr_prescricao_w;
			
			Calcular_Valores_Solucao(	nr_prescricao_w,
										nr_seq_solucao_w,
										qt_dosagem_w,
										upper(ie_tipo_dosagem_w),
										VarCalcularEtapaSolucao_w,
										VarCalculaVolumeVelocidade_w,
										VarCalculaTempoSolucao_w,
										ie_arredondar_etapa_w,
										nm_usuario_p,
										qt_tempo_aplicacao_w,
										qt_volsolu_w,
										nr_etapas_w,
										qt_temsol_w,
										'N');

			if	(nvl(nr_etapas_w,0)	> 0) then
				qt_hora_fase_w	:= dividir(qt_tempo_aplicacao_w,nr_etapas_w);
			end if;
			
			if	(cd_intervalo_soluc_w is not null) then
				
				Calcular_etapas_interv_solucao(	cd_intervalo_soluc_w,
								qt_tempo_aplicacao_w,
								ie_arredondar_etapa_w,
								qt_hora_fase_w,
								nr_etapas_w);
			end if;					
		end if;					
									


		if	(ie_prim_hor_sol_w = 'P') then
			hr_prim_hor_w			:= Obter_prim_horario_solucao(to_char(dt_inicio_prescr_w,'dd/mm/yyyy hh24:mi:ss'));
			if	(hr_prim_hor_w is not null) then
				dt_primeiro_horario_w	:= to_date(to_char(dt_inicio_prescr_w,'dd/mm/yyyy ') || hr_prim_hor_w,'dd/mm/yyyy hh24:mi:ss');
			end if;
		end if;


		if	(ie_prim_hor_sol_w <> 'C') and
			(ie_prim_hor_sol_w <> 'T') then

			if (ie_gera_prim_hor_solucao_w <> 'B') then
				if	(VarIePrimHorCopia_w = 'S') then
					select	max(to_date(to_char(dt_inicio_prescr,'dd/mm/yyyy') ||' ' || dt_primeiro_horario_p || '$00','dd/mm/yyyy hh24:mi:ss'))
					into	dt_primeiro_horario_w
					from	prescr_medica
					where	nr_prescricao = nr_prescricao_w;
	
	
				elsif	((ie_prim_hor_sol_w = 'I') and (cd_intervalo_soluc_w	is not null)) then
	
	
					select	substr(Obter_primeiro_horario(cd_intervalo_soluc_w,nr_prescricao,null,null),1,20)
					into	hr_prim_hor_2w
					from	prescr_medica
					where	nr_prescricao = nr_prescricao_w;
	
	
					if	(hr_prim_hor_2w <> '') then
	
	
						select	to_date(to_char(dt_inicio_prescr,'dd/mm/yyyy')||' '||substr(Obter_primeiro_horario(cd_intervalo_soluc_w,nr_prescricao,null,null),1,20),'dd/mm/yyyy hh24:mi:ss')
						into	dt_primeiro_horario_w
						from	prescr_medica
						where	nr_prescricao = nr_prescricao_w;
	
	
					end if;
	
	
	
				else
					select	max(dt_inicio_prescr)
					into	dt_primeiro_horario_w
					from	prescr_medica
					where	nr_prescricao = nr_prescricao_w;
				end if;
	
	
				Calcula_Horarios_Etapas(dt_primeiro_horario_w,nr_etapas_w,dividir(qt_tempo_aplicacao_w,nr_etapas_w),nm_usuario_p,'N',qt_tempo_aplicacao_w,ds_horarios_w,ds_horarios_2w,null,'N');
	
	
				update	prescr_solucao
				set		nr_etapas = nr_etapas_w,
						ds_horarios	= substr(ds_horarios_w,1,255),
						qt_tempo_aplicacao = qt_tempo_aplicacao_w,
						hr_prim_horario	= to_char(dt_primeiro_horario_w,'hh24:mi'),
						qt_hora_fase = nvl(qt_hora_fase_w, dividir(qt_tempo_aplicacao_w,nr_etapas_w)),					
						qt_dosagem = decode(ie_recalcular_sol_w, 'S', Calcular_Vol_Total_Solucao(ie_tipo_dosagem,qt_tempo_aplicacao_w, nvl(qt_solucao_total,0) - nvl(qt_dose_ataque,0), qt_dosagem, nr_prescricao, nr_seq_solucao, 1), qt_dosagem)
				where	nr_seq_solucao	= nr_seq_Solucao_w
				and		nr_prescricao	= nr_prescricao_w;
			else
				update	prescr_solucao
				set		ds_horarios	= null,
						hr_prim_horario	= null
				where	nr_seq_solucao	= nr_seq_Solucao_w
				and		nr_prescricao	= nr_prescricao_w;
			end if;
	
			open c012;
			loop
			fetch c012 into
				cd_material_w,
				nr_seq_solucao_mat_w,
				cd_intervalo_w,
				ie_via_aplicacao_w,
				qt_unitaria_w,
				ds_dose_diferenciada_w,
				ie_origem_inf_w,
				cd_unidade_medida_dose_w,
				qt_material_w,
				ie_se_necessario_w,
				ie_acm_w;
			exit when c012%notfound;
				begin
	
	
				Consiste_Util_Solucao(nr_prescricao_w,NR_ATENDIMENTO_P,dt_prescricao_p,cd_material_w,nr_dia_util_w,QT_DIAS_LIBERADO_w,ie_controle_medico_w,qt_dias_lib_atend_w);
	
				Ajustar_prescr_mat_solucao(nr_prescricao_w, nr_seq_solucao_mat_w);
				
/* 				Obter_Quant_Dispensar(	cd_estabelecimento_w, cd_material_w, nr_prescricao_w, nr_seq_solucao_mat_w, cd_intervalo_w,
							ie_via_aplicacao_w, qt_unitaria_w, 0, nr_etapas_w, ds_dose_diferenciada_w,
							ie_origem_inf_w, cd_unidade_medida_dose_w, 1, qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w,ie_se_necessario_w,ie_acm_w); */
	
	
				update 	prescr_material
				set		nr_dia_util		= nr_dia_util_w,
						qt_total_dias_lib 	= qt_dias_lib_atend_w
				where	nr_sequencia_solucao 	= nr_seq_Solucao_w
				and		nr_sequencia		= nr_seq_solucao_mat_w
				and		nr_prescricao 		= nr_prescricao_w;
	
				end;
			end loop;
			close c012;
	
			if	(ie_esquema_alternado_w = 'S') then
				Calcular_Etapas_Esquema(nr_prescricao_w,nr_seq_Solucao_w);
			end if;
		end if;


		Consistir_prescr_solucao(nr_prescricao_w,nr_seq_Solucao_w, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, ds_erro_w);
		end;
	end loop;
	close C08;
	end;
end if;

select	nvl(max(ie_etapa_especial),'N')
into	ie_etapa_especial_w
from	prescr_solucao
where	((ie_copia_agora_w	= 'S') or
		 (ie_urgencia		= 'N'))
and		((nvl(ie_suspenso,'N')	<> 'S') or
		 (ie_copia_suspensas_p = 'S'))
and		ie_etapa_especial	= 'S'
and		nr_prescricao		= nr_prescricao_orig_w;

if	(ie_etapa_especial_w	= 'S') then
	begin
	ds_horarios_w	:= '';
	open C014;
	loop
	fetch C014 into
		nr_seq_Solucao_w,
		dt_primeiro_horario_w,
		nr_etapas_w,
		qt_tempo_aplicacao_w,
		ie_esquema_alternado_w,
		ie_hemodialise_w;
	exit when C014%notfound;
		begin
		
		Calcula_Horarios_Etapas(dt_primeiro_horario_w,nr_etapas_w,dividir(qt_tempo_aplicacao_w,nr_etapas_w),nm_usuario_p,'N',qt_tempo_aplicacao_w,ds_horarios_w,ds_horarios_2w,'N',ie_hemodialise_w);

		update	prescr_solucao
		set		ds_horarios	= substr(ds_horarios_w,1,255),
				hr_prim_horario	= to_char(dt_primeiro_horario_w,'hh24:mi')
		where	nr_seq_solucao	= nr_seq_Solucao_w
		and		nr_prescricao	= nr_prescricao_w;


		open c012;
		loop
		fetch c012 into
			cd_material_w,
			nr_seq_solucao_mat_w,
			cd_intervalo_w,
			ie_via_aplicacao_w,
			qt_unitaria_w,
			ds_dose_diferenciada_w,
			ie_origem_inf_w,
			cd_unidade_medida_dose_w,
			qt_material_w,
			ie_se_necessario_w,
			ie_acm_w;
		exit when c012%notfound;
			begin


			Consiste_Util_Solucao(nr_prescricao_w,NR_ATENDIMENTO_P,dt_prescricao_p,cd_material_w,nr_dia_util_w,QT_DIAS_LIBERADO_w,ie_controle_medico_w,qt_dias_lib_atend_w);


			Obter_Quant_Dispensar(	cd_estabelecimento_w, cd_material_w, nr_prescricao_w, nr_seq_solucao_mat_w, cd_intervalo_w,
						ie_via_aplicacao_w, qt_unitaria_w, 0,nr_etapas_w, ds_dose_diferenciada_w,
						ie_origem_inf_w, cd_unidade_medida_dose_w, 1, qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w,ie_se_necessario_w,ie_acm_w);


			update 	prescr_material
			set		nr_dia_util		= nr_dia_util_w,
					qt_total_dias_lib 	= qt_dias_lib_atend_w,
					nr_ocorrencia		= nr_etapas_w,
					qt_total_dispensar	= qt_total_dispensar_w,
					qt_material		= nvl(qt_material_w,0),
					ie_regra_disp		= decode(nvl(ie_regra_disp,'X'), 'D', ie_regra_disp, ie_regra_disp_w)
			where	nr_sequencia		= nr_seq_solucao_mat_w
			and		nr_sequencia_solucao 	= nr_seq_Solucao_w
			and		nr_prescricao 		= nr_prescricao_w;


			end;
		end loop;
		close c012;


		if	(ie_esquema_alternado_w = 'S') then
			Calcular_Etapas_Esquema(nr_prescricao_w,nr_seq_Solucao_w);
		end if;
		end;
	end loop;
	close C014;
	end;
end if;

wheb_assist_pck.obterValorParametroREP(992,ie_controla_adm_w);
if	(nvl(ie_controla_adm_w,'S') <> 'N') then

	wheb_assist_pck.obterValorParametroREP(694,ie_altera_dt_proxima_dose_w);


	open C09;
	loop
	fetch C09 into
		nr_sequencia_w,
		qt_hora_intervalo_w,
		dt_proxima_dose_w,
		nr_sequencia_orig_w,
		nr_prescricao_orig_w,
		cd_material_w,
		cd_intervalo_w,
		hr_prim_horario_w;
	exit when C09%notfound;
		begin

		hr_prim_horario_w	:= nvl(hr_prim_horario_w, to_char(dt_inicio_prescr_w, 'hh24:mi'));
		if (qt_hora_intervalo_w > 24) then
			if	(dt_proxima_dose_w is not null) and
				(dt_proxima_dose_w not between dt_inicio_prescr_w and dt_validade_prescr_w) then
				begin
				qt_dia_prim_hor_w := ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_prescr_w) - ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_proxima_dose_w);


				if	(qt_dia_prim_hor_w not between 0 and 1) then
					qt_dia_prim_hor_w	:= 0;
				end if;


				update	prescr_material
				set		ie_administrar	= 'N',
						hr_prim_horario	= to_char(dt_proxima_dose_w,'hh24:mi'),
						ds_horarios	= to_char(dt_proxima_dose_w,'hh24:mi'),
						qt_dia_prim_hor = qt_dia_prim_hor_w
				where	nr_sequencia	= nr_sequencia_w
				and		nr_prescricao	= nr_prescricao_w;
				end;
			end if;

			dt_proxima_dose_orig_w	:= dt_proxima_dose_w;
			dt_horario_w			:= null;


			if	(nr_sequencia_orig_w is not null) then


				select	max(dt_proxima_dose),
						nvl(max(hr_prim_horario), hr_prim_horario_w)
				into	dt_proxima_dose_w,
						hr_prim_horario_w
				from	prescr_material
				where	((nvl(hr_prim_horario, hr_prim_horario_w) = hr_prim_horario_w) or (mod(qt_hora_intervalo_w,24) > 0))
				and		cd_intervalo = cd_intervalo_w
				and		cd_material = cd_material_w
				and		nr_sequencia = nr_sequencia_orig_w
				and		nr_prescricao = nr_prescricao_orig_w;





				if	(dt_proxima_dose_w is null) then
					dt_proxima_dose_w	:= dt_proxima_dose_orig_w;


					select	max(dt_horario)
					into	dt_horario_w
					from	prescr_mat_hor
					where	nr_seq_material	= nr_sequencia_w
					and		nvl(ie_horario_especial,'N') <> 'S'
					and		nr_prescricao	= nr_prescricao_w;
				else


					update	prescr_material
					set		dt_proxima_dose	= dt_proxima_dose_w,
							dt_administrar 	= dt_proxima_dose_w
					where	nr_sequencia	= nr_sequencia_w
					and		nr_prescricao	= nr_prescricao_w;
				end if;
			else


				select	max(dt_horario)
				into	dt_horario_w
				from	prescr_mat_hor
				where	nr_seq_material	= nr_sequencia_w
				and		nvl(ie_horario_especial,'N') <> 'S'
				and		nr_prescricao	= nr_prescricao_w;




				dt_proxima_dose_w	:= dt_horario_w;
			end if;

			if	((dt_proxima_dose_w is null) or
				 (dt_proxima_dose_w between dt_inicio_prescr_w and dt_validade_prescr_w)) then
				begin


					if	(dt_proxima_dose_w is not null) then
						if	(dt_inicio_prescr_w > dt_proxima_dose_w) then
							qt_dia_prim_hor_w := ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_prescr_w) - ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_proxima_dose_w);
						else
							qt_dia_prim_hor_w := ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_proxima_dose_w) - ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_prescr_w);
						end if;
					else

						if	(hr_prim_horario_w < to_char(dt_inicio_prescr_w,'hh24:mi')) then

							qt_dia_prim_hor_w	:= 1;
						else
							qt_dia_prim_hor_w	:= 0;
						end if;
					end if;



					if	(qt_dia_prim_hor_w not between 0 and 1) then
						qt_dia_prim_hor_w	:= 0;
					end if;



					if	(mod(qt_hora_intervalo_w,24) > 0) and
						(dt_proxima_dose_w is not null) then
						update	prescr_material
						set		hr_prim_horario	= to_char(dt_proxima_dose_w,'hh24:mi'),
								ds_horarios		= to_char(dt_proxima_dose_w,'hh24:mi '),
								dt_administrar 	= dt_proxima_dose_w
						where	nr_sequencia	= nr_sequencia_w
						and		nr_prescricao	= nr_prescricao_w;
					end if;


					dt_proxima_dose_w	:= nvl(dt_horario_w, dt_proxima_dose_w) + qt_hora_intervalo_w/24;


					if	((mod(qt_hora_intervalo_w,24) > 0)) then
						update	prescr_material
						set		dt_proxima_dose	= dt_proxima_dose_w,
								ie_administrar	= null,
								qt_dia_prim_hor	= qt_dia_prim_hor_w
						where	nr_sequencia	= nr_sequencia_w
						and		nr_prescricao	= nr_prescricao_w;
					else


						update	prescr_material
						set		hr_prim_horario	= to_char(dt_proxima_dose_w,'hh24:mi'),
								ds_horarios		= to_char(dt_proxima_dose_w,'hh24:mi '),
								dt_proxima_dose	= dt_proxima_dose_w,
								ie_administrar	= null,
								qt_dia_prim_hor	= qt_dia_prim_hor_w
						where	nr_sequencia	= nr_sequencia_w
						and		nr_prescricao	= nr_prescricao_w;
					end if;



				end;
			elsif	(ie_altera_dt_proxima_dose_w = 'S') and
					(dt_proxima_dose_w is not null) and
					(dt_proxima_dose_w < dt_inicio_prescr_w) then
				begin


				if	((dt_horario_w is not null) and
					 (dt_horario_w	>= dt_inicio_prescr_w) and
					 (dt_horario_w	< dt_validade_prescr_w)) then
					dt_proxima_dose_w	:= dt_horario_w + qt_hora_intervalo_w/24;
				else
					dt_proxima_dose_w	:= dt_inicio_prescr_w + qt_hora_intervalo_w/24;
				end if;


				qt_dia_prim_hor_w := ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_prescr_w)- ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_proxima_dose_w);
				if	(qt_dia_prim_hor_w not between 0 and 1) then
					qt_dia_prim_hor_w	:= 0;
				end if;


				update	prescr_material
				set		hr_prim_horario = to_char(dt_proxima_dose_w, 'hh24:mi'),
						dt_proxima_dose	= dt_proxima_dose_w,
						dt_administrar 	= dt_proxima_dose_w,
						ds_horarios		= to_char(dt_proxima_dose_w, 'hh24:mi'),
						qt_dia_prim_hor = qt_dia_prim_hor_w,
						ie_administrar	= null
				where	nr_sequencia	= nr_sequencia_w
				and		nr_prescricao	= nr_prescricao_w;


				end;
			elsif	(dt_proxima_dose_w is not null) then
				begin


				qt_dia_prim_hor_w := ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_prescr_w) - ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_proxima_dose_w);
				if	(qt_dia_prim_hor_w not between 0 and 1) then
					qt_dia_prim_hor_w	:= 0;
				end if;


				update	prescr_material
				set		ie_administrar	= 'N',
						ie_regra_disp	= 'N',
						qt_dia_prim_hor	= qt_dia_prim_hor_w
				where	nr_sequencia	= nr_sequencia_w
				and		nr_prescricao	= nr_prescricao_w;

				update	prescr_material
				set		ie_administrar		= 'N',
						ie_regra_disp		= 'N'
				where	nr_sequencia_diluicao	= nr_sequencia_w
				and		nr_prescricao		= nr_prescricao_w;

				update	prescr_mat_hor
				set		ie_situacao	= 'I'
				where	nr_seq_material	= nr_sequencia_w
				and		nr_prescricao	= nr_prescricao_w;


				update	prescr_mat_hor
				set		ie_situacao	= 'I'
				where	nr_seq_superior	= nr_sequencia_w
				and		nr_prescricao	= nr_prescricao_w;


				end;
			end if;
		elsif	(ie_altera_dt_proxima_dose_w = 'S') then
				dt_proxima_dose_orig_w	:= dt_proxima_dose_w;
				dt_horario_w			:= null;


				if	(nr_sequencia_orig_w is not null) then


					hr_prim_horario_w	:= nvl(hr_prim_horario_w, to_char(dt_inicio_prescr_w, 'hh24:mi'));


					select	max(dt_proxima_dose)
					into	dt_proxima_dose_w
					from	prescr_material
					where	nvl(hr_prim_horario, hr_prim_horario_w) = hr_prim_horario_w
					and		cd_intervalo = cd_intervalo_w
					and		cd_material = cd_material_w
					and		nr_sequencia = nr_sequencia_orig_w
					and		nr_prescricao = nr_prescricao_orig_w;


					if	(dt_proxima_dose_w is null) then
						dt_proxima_dose_w	:= dt_proxima_dose_orig_w;


						select	max(dt_horario)
						into	dt_horario_w
						from	prescr_mat_hor
						where	nr_seq_material	= nr_sequencia_w
						and		nr_prescricao	= nr_prescricao_w;
					else


						update	prescr_material
						set		dt_proxima_dose	= dt_proxima_dose_w,
								dt_administrar 	= dt_proxima_dose_w
						where	nr_sequencia	= nr_sequencia_w
						and		nr_prescricao	= nr_prescricao_w;
					end if;
				else


					select	max(dt_horario)
					into	dt_horario_w
					from	prescr_mat_hor
					where	nr_seq_material	= nr_sequencia_w
					and		nr_prescricao	= nr_prescricao_w;


					dt_proxima_dose_w	:= dt_horario_w;
				end if;


				if	(dt_proxima_dose_w is not null) and
					(dt_proxima_dose_w < dt_inicio_prescr_w) then
					begin


					if	((dt_horario_w is not null) and
						 (dt_horario_w	>= dt_inicio_prescr_w) and
						 (dt_horario_w	< dt_validade_prescr_w)) then
						dt_proxima_dose_w	:= dt_horario_w + qt_hora_intervalo_w/24;
					else
						dt_proxima_dose_w	:= dt_inicio_prescr_w + qt_hora_intervalo_w/24;
					end if;


					hr_prim_horario_w	:= to_char(dt_proxima_dose_w, 'hh24:mi');


					select	max(ie_via_aplicacao),
							max(qt_unitaria),
							max(nr_ocorrencia),
							max(ie_origem_inf),
							max(cd_unidade_medida_dose),
							max(qt_material),
							max(qt_total_dispensar),
							nvl(max(ie_se_necessario), 'N'),
							nvl(max(ie_acm), 'N')
					into	ie_via_aplicacao_w,
							qt_unitaria_w,
							nr_ocorrencia_w,
							ie_origem_inf_w,
							cd_unidade_medida_dose_w,
							qt_material_w,
							qt_total_dispensar_w,
							ie_se_necessario_w,
							ie_acm_w
					from	prescr_material
					where	nr_sequencia = nr_sequencia_w
					and		nr_prescricao = nr_prescricao_w;


					Obter_Quant_Dispensar(cd_estabelecimento_w, cd_material_w, nr_prescricao_w, nr_sequencia_w, cd_intervalo_w,ie_via_aplicacao_w, qt_unitaria_w, 0,nr_ocorrencia_w, '',ie_origem_inf_w, cd_unidade_medida_dose_w, 1, qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w);


					qt_dia_prim_hor_w	:= 0;
					if	(hr_prim_horario_w <> '') and
						(hr_prim_horario_w <> '  :  ') and
						(hr_prim_horario_w < to_char(dt_inicio_prescr_w,'hh24:mi')) then
						qt_dia_prim_hor_w	:= 1;
					end if;


					update	prescr_material
					set 	hr_prim_horario		= hr_prim_horario_w,
							dt_proxima_dose		= dt_proxima_dose_w,
							dt_administrar		= dt_proxima_dose_w,
							ds_horarios			= to_char(dt_proxima_dose_w, 'hh24:mi'),
							nr_ocorrencia		= nr_ocorrencia_w,
							qt_total_dispensar	= qt_total_dispensar_w,
							qt_material			= nvl(qt_material_w,1),
							ie_regra_disp		= decode(nvl(ie_regra_disp,'X'), 'D', ie_regra_disp, ie_regra_disp_w),
							qt_dia_prim_hor		= qt_dia_prim_hor_w
					where	nr_sequencia		= nr_sequencia_w
					and		nr_prescricao 		= nr_prescricao_w;


					end;
				end if;
		end if;
		end;
	end loop;
	close C09;
end if;




if	(instr(substr(nr_prescr_w,1,length(nr_prescr_w)-1),',') > 0) then
	wheb_assist_pck.obterValorParametroREP(429,ie_excluir_iguais_w);
	if	(ie_excluir_iguais_w	= 'S') then
		Excluir_item_prescr_duplic(nr_prescricao_w, nm_usuario_p);
	end if;
end if;

if	(ie_recalc_horario_p = 'V') then
	Gerar_prescr_mat_hor_pre(nr_nova_prescricao_p, Obter_Perfil_Ativo, NM_USUARIO_P);
	Consistir_horario_copia_prescr(nr_nova_prescricao_p, nm_usuario_p);
end if;

/* Chama a procedure de copia dos leites e derivados */

copia_leite_deriv(nr_prescricao_w,nr_prescricao_p,nm_usuario_p,null,ie_recalc_horario_p);

/*Update para chamar a trigger da prescr_solucao para ajustar caso o volume da etapa estiver zerada.*/

update	prescr_solucao
set		dt_atualizacao	= dt_atualizacao
where	nr_prescricao	= nr_prescricao_w;

if (ie_prescr_hor_sem_lib_w = 'S') then
	Gerar_horarios_sem_lib(nr_prescricao_w, nm_usuario_p);
end if;

Reordenar_Medicamento(nr_prescricao_w);
ds_log_w := ds_log_w||'Parametros da chamda:;'			||chr(13)||chr(10);
ds_log_w := ds_log_w||'nr_prescricao_p='	||to_char(nr_prescricao_p)	||chr(13)||chr(10);
ds_log_w := ds_log_w||'-nr_atendimento_p='	||to_char(nr_atendimento_p)	||chr(13)||chr(10);
ds_log_w := ds_log_w||'-nm_usuario_p='	||nm_usuario_p		||chr(13)||chr(10);
ds_log_w := ds_log_w||'-cd_medico_p='		||to_char(cd_medico_p)		||chr(13)||chr(10);
ds_log_w := ds_log_w||'-dt_prescricao_p='	||to_char(dt_prescricao_p,'dd/mm/yyyy hh24:mi:ss')	||chr(13)||chr(10);
ds_log_w := ds_log_w||'-ie_ajustar_qt_p='	||to_char(ie_ajustar_qt_p)	||chr(13)||chr(10);
ds_log_w := ds_log_w||'-ie_procedimento_p='	||to_char(ie_procedimento_p)	||chr(13)||chr(10);
ds_log_w := ds_log_w||'-ie_exames_p='		||to_char(ie_exames_p)		||chr(13)||chr(10);
ds_log_w := ds_log_w||'-ie_agrupamento_p='	||to_char(ie_agrupamento_p)	||chr(13)||chr(10);
ds_log_w := ds_log_w||'-ie_recalc_horario_p='	||to_char(ie_recalc_horario_p)	||chr(13)||chr(10);
ds_log_w := ds_log_w||'-nr_prescricoes_p='	||to_char(nr_prescricoes_p)	||chr(13)||chr(10);
ds_log_w := ds_log_w||'-dt_primeiro_horario_p=' ||dt_primeiro_horario_p||chr(13)||chr(10);
ds_log_w := ds_log_w||'-dt_procedimento_p='	||to_char(dt_procedimento_p,'dd/mm/yyyy hh24:mi:ss')	||chr(13)||chr(10);
ds_log_w := ds_log_w||'-ds_ind_clinica_p='	||substr(ds_ind_clinica_w,1,80)	||chr(13)||chr(10);
ds_log_w := ds_log_w||'-ie_proced_agora_p='	||to_char(ie_proced_agora_p)	||chr(13)||chr(10);
ds_log_w := ds_log_w||'-hr_prescr_inicial_p='	||to_char(hr_prescr_inicial_p)	||chr(13)||chr(10);
ds_log_w := ds_log_w||'-hr_prescr_final_p='	||to_char(hr_prescr_final_p)	||chr(13)||chr(10);
ds_log_w := ds_log_w||'-nr_horas_validade_p='	||to_char(nr_horas_validade_p)	||chr(13)||chr(10);
ds_log_w := ds_log_w||'-cd_perfil_p='		||to_char(cd_perfil_p)		||chr(13)||chr(10);
ds_log_w := ds_log_w||'-nr_nova_prescricao_p='	||to_char(nr_nova_prescricao_p);

ds_log_w := substr(	' Procedure origem: Copia_Prescricao;  '
 || chr(13) ||chr(10)||
					obter_desc_expressao(781482, 'DT_COPIA'|| to_char(sysdate,'dd/mm/yyyy hh24:mi:ss') ||';FUNCAO_ATIVA='||obter_desc_expressao(339327) || obter_funcao_ativa || ';NR_PRESCRICAO=' || nr_prescricoes_ww ||';DS_LOG='||ds_log_w||
					';DS_STACK='|| dbms_utility.format_call_stack),1,2000);					
					--data da copia: #@DT_COPIA#@ #@FUNCAO_ATIVA#@ Prescricoes agrupadas: #@NR_PRESCRICAO#@ #@DS_LOG#@ CallStack: #@DS_STACK#@					
					
update	prescr_medica
set		ds_observacao_copia = ds_log_w
where	nr_prescricao = nr_prescricao_w;

if	(VarIeAjustarDispAssoc_w = 'N') then
	open c25;
	loop
	fetch c25 into
		nr_sequencia_w,
		ie_regra_disp_w;
	exit when c25%notfound;
		begin

		update	prescr_material
		set 	ie_regra_disp	= nvl(ie_regra_disp_w, ie_regra_disp)
		where	nr_sequencia	= nr_sequencia_w
		and		nr_prescricao 	= nr_prescricao_w;


		end;
	end loop;
	close c25;
end if;

COMMIT;

--Ajustar os horarios dos itens associados aos procedimentos.
open c34;
loop
fetch c34 into	
	nr_sequencia_proc_ww,
	nr_seq_w,
	nr_prescricao_w;
exit when c34%notfound;
	begin
	ajustar_prescr_mat_proc(nr_prescricao_w, nr_sequencia_proc_ww, cd_perfil_p, nr_seq_w);	
	end;
end loop;
close c34;

select 	count(*)
into	qt_registro_w
from	adep_tipo_observacao
where  	nvl(ie_copia_prescr,'N') = 'S';

if (qt_registro_w > 0) then
	CALL copia_observacao_enf(nr_prescricao_w,nm_usuario_p);
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copia_prescricao ( nr_prescricao_p bigint, nr_atendimento_p bigint, nm_usuario_p text, cd_medico_p text, dt_prescricao_p timestamp, ie_ajustar_qt_p text, ie_procedimento_p text, ie_exames_p text, ie_agrupamento_p bigint, ie_recalc_horario_p text, nr_prescricoes_p text, dt_primeiro_horario_p text, dt_procedimento_p timestamp, ds_ind_clinica_p text, ie_proced_agora_p text, hr_prescr_inicial_p text, hr_prescr_final_p text, nr_horas_validade_p bigint, cd_perfil_p bigint, nr_nova_prescricao_p INOUT bigint, nr_prescr_origem_fut_p bigint default null, cd_pessoa_fisica_p text default null, cd_estabelecimento_p bigint default null, ie_copia_suspensas_p text DEFAULT NULL, cd_medic_posicionar_p INOUT bigint DEFAULT NULL) FROM PUBLIC;

