-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dar_criar_app (nr_sequencia_p INOUT dar_app.nr_sequencia%type, ds_app_p dar_app.ds_app%type, ds_descricao_p dar_app.ds_descricao%type, nr_seq_grupo_p dar_app.nr_seq_grupo%type, ds_itens_p text ) AS $body$
DECLARE

   nr_seq_datmodel_ww           varchar(4000);
   nr_seq_table_control_w       dar_app_datamodels.nr_seq_table_control%type;
   nr_sequencia_w               dar_app.nr_sequencia%type;
   table_control_w              dbms_sql.number_table;
BEGIN
   --
   nr_sequencia_w := nr_sequencia_p;
   -- se for novo registro
   if (coalesce(nr_sequencia_p, 0) = 0) then
      -- insert record
      insert into dar_app(nr_sequencia,
          ds_app,
          ds_descricao,
          nr_seq_grupo,
          dt_atualizacao,
          nm_usuario,
          dt_atualizacao_nrec,
          nm_usuario_nrec)
      values (nextval('dar_app_seq'),
          ds_app_p,
          ds_descricao_p,
          nr_seq_grupo_p,
          clock_timestamp(),
          wheb_usuario_pck.get_nm_usuario,
          clock_timestamp(),
          wheb_usuario_pck.get_nm_usuario)
       returning nr_sequencia INTO nr_sequencia_w;
   else
      -- Update record
      update dar_app
         set ds_app         = ds_app_p,
             ds_descricao   = ds_descricao_p,
             dt_atualizacao = clock_timestamp(),
             nm_usuario     = wheb_usuario_pck.get_nm_usuario
       where nr_sequencia = nr_sequencia_w;
   end if;

   table_control_w	:= string_to_table_number(ds_itens_p,',');

   if (table_control_w.Count > 0) then

         delete FROM dar_app_datamodels
         where  nr_seq_app	= nr_sequencia_w;

         for i in 1..table_control_w.Count loop
              insert into dar_app_datamodels(nr_sequencia,
                    dt_atualizacao,
                    nm_usuario,
                    dt_atualizacao_nrec,
                    nm_usuario_nrec,
                    nr_seq_table_control,
                    nr_seq_app)
              values (nextval('dar_app_datamodels_seq'),
                   clock_timestamp(),
                   wheb_usuario_pck.get_nm_usuario,
                   clock_timestamp(),
                   wheb_usuario_pck.get_nm_usuario,
                   table_control_w(i),
                   nr_sequencia_w);
         end loop;
   end if;
   --
   commit;

   --
   CALL dar_carrega_ligacao_datamodel(nr_sequencia_w);

   nr_sequencia_p := nr_sequencia_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dar_criar_app (nr_sequencia_p INOUT dar_app.nr_sequencia%type, ds_app_p dar_app.ds_app%type, ds_descricao_p dar_app.ds_descricao%type, nr_seq_grupo_p dar_app.nr_seq_grupo%type, ds_itens_p text ) FROM PUBLIC;

