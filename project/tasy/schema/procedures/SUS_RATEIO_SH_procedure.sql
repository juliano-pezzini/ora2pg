-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_rateio_sh ( nr_seq_protocolo_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
nr_interno_conta_w		bigint;
qt_registros_w			bigint;

 
c01 CURSOR FOR 
	SELECT	nr_interno_conta 
	from	conta_paciente 
	where	nr_seq_protocolo	= nr_seq_protocolo_p 
	and	coalesce(ie_cancelamento::text, '') = '';

 

BEGIN 
 
/* Eliminar registros anteriores */
 
delete	from w_conta_sus_sh;
 
/* Verificar se existe regras de rateio cadastradas */
 
select	count(*) 
into STRICT	qt_registros_w 
from	sus_regra_rateio_sh;
 
if	qt_registros_w	> 0	then 
	begin 
	/* Selecionar as contas do protocolo */
 
	OPEN C01;
	LOOP 
	FETCH 	C01 into 
		nr_interno_conta_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
 
		CALL SUS_RATEIO_SH_DIARIA(nr_interno_conta_w,nm_usuario_p);
		CALL SUS_RATEIO_SH_AUX(nr_interno_conta_w,nm_usuario_p);
		CALL SUS_RATEIO_SH_AUX_VALOR(nr_interno_conta_w,nm_usuario_p);
		CALL SUS_RATEIO_SH_ATUALIZA(nr_interno_conta_w,nm_usuario_p);
		/* Atualiza os procedimentos e os materiais da conta com o valor rateado */
 
		CALL SUS_RATEIO_SH_CONTA(nr_interno_conta_w, nm_usuario_p);
 
	END LOOP;
	CLOSE C01;
	end;
end if;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_rateio_sh ( nr_seq_protocolo_p bigint, nm_usuario_p text) FROM PUBLIC;

