-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_desdobramento_ordem (nr_seq_ordem_p bigint, nm_usuario_p text) AS $body$
DECLARE

nr_seq_ordem_w	 	bigint;
nr_seq_cabine_w		bigint;
nr_seq_etapa_prod_w	bigint;
nr_atendimento_w	bigint;
cd_material_w		integer;
cd_unidade_medida_w	varchar(30);
qt_material_w		double precision;
dt_prescricao_w		timestamp;
nr_prescricao_w		bigint;
cd_motivo_baixa_w	varchar(1);
nr_seq_lote_fornec_w	bigint;
ie_via_aplicacao_w	varchar(5);
nr_seq_item_prescr_w	bigint;
cd_local_estoque_w	smallint;
cd_oper_perda_etq_w	smallint;
nr_sequencia_w		bigint;
cd_setor_atendimento_w	integer;

C01 CURSOR FOR 
	SELECT	coalesce(a.nr_atendimento,h.nr_atendimento), 
		b.cd_material, 
		b.cd_unidade_medida_real, 
		b.qt_dose_real, 
		h.dt_prescricao, 
		a.nr_prescricao, 
		b.nr_seq_lote_fornec, 
		a.ie_via_aplicacao, 
		b.nr_seq_item_prescr, 
		nr_seq_etapa_prod, 
		h.cd_setor_atendimento 
	from	paciente_atend_medic i, 
		prescr_medica h, 
		prescr_material d, 
		can_ordem_item_prescr c, 
		can_ordem_prod_mat b, 
		can_ordem_prod a 
	where	i.nr_seq_atendimento = a.nr_seq_atendimento 
	and	i.nr_seq_material = d.nr_seq_material 
	and	a.nr_sequencia	= nr_seq_ordem_p 
	and	d.nr_prescricao	= h.nr_prescricao 
	and	a.nr_prescricao	= d.nr_prescricao 
	and	c.nr_seq_prescricao = d.nr_sequencia 
	and	a.nr_sequencia	= b.nr_seq_ordem 
	and 	c.nr_seq_ordem = b.nr_seq_ordem 
	and 	b.nr_seq_item_prescr = c.nr_sequencia 
	and 	coalesce(a.ie_medic_paciente,'N') = 'N' 
	and	ie_administracao = 'P' 
	and	coalesce(a.nr_seq_ordem_origem::text, '') = '';


BEGIN 
 
select 	nextval('can_ordem_prod_seq') 
into STRICT	nr_seq_ordem_w
;
	 
insert into can_ordem_prod( 
	nr_sequencia, 
	cd_auxiliar, 
	cd_estab_administracao, 
	cd_estabelecimento, 
	cd_farmaceutico, 
	cd_manipulador, 
	cd_medico_resp, 
	cd_pessoa_devol, 
	cd_pessoa_fisica, 
	cd_setor_paciente, 
	ds_orientacao_adm, 
	ds_precaucao, 
	dt_administracao, 
	dt_atualizacao, 
	dt_atualizacao_nrec, 
	dt_entregue, 
	dt_fim_preparo, 
	dt_geracao_ordem, 
	dt_inicio_preparo, 
	dt_prevista, 
	dt_solic_perda, 
	dt_suspensao, 
	dt_transferencia, 
	dt_validade_ordem, 
	dt_validade_rotulo, 
	ie_bomba_infusao, 
	ie_medic_paciente, 
	ie_pre_medicacao, 
	ie_suspensa, 
	ie_tipo_dosagem, 
	ie_via_aplicacao, 
	nm_usuario, 
	nm_usuario_adm, 
	nm_usuario_conf, 
	nm_usuario_disp, 
	nm_usuario_fim_prep, 
	nm_usuario_inic_prep, 
	nm_usuario_nrec, 
	nr_atendimento, 
	nr_prescricao, 
	nr_seq_atendimento, 
	nr_seq_etapa_prod, 
	nr_seq_motivo_dupl, 
	qt_dias_util, 
	qt_dosagem, 
	qt_hora_aplic, 
	qt_hora_validade, 
	qt_min_aplic, 
	qt_min_validade, 
	qt_peso, 
	qt_superf_corporea, 
	qt_temp, 
	qt_volume_aspirado, 
	ie_cancelada, 
	ie_conferido, 
	nr_seq_ordem_origem) 
SELECT 	nr_seq_ordem_w, 
	cd_auxiliar, 
	cd_estab_administracao, 
	cd_estabelecimento, 
	cd_farmaceutico, 
	cd_manipulador, 
	cd_medico_resp, 
	cd_pessoa_devol, 
	cd_pessoa_fisica, 
	cd_setor_paciente, 
	ds_orientacao_adm, 
	ds_precaucao, 
	dt_administracao, 
	clock_timestamp(), 
	clock_timestamp(), 
	dt_entregue, 
	dt_fim_preparo, 
	dt_geracao_ordem, 
	dt_inicio_preparo, 
	dt_prevista, 
	dt_solic_perda, 
	dt_suspensao, 
	dt_transferencia, 
	dt_validade_ordem, 
	dt_validade_rotulo, 
	ie_bomba_infusao, 
	ie_medic_paciente, 
	ie_pre_medicacao, 
	ie_suspensa, 
	ie_tipo_dosagem, 
	ie_via_aplicacao, 
	nm_usuario_p, 
	nm_usuario_adm, 
	nm_usuario_conf, 
	nm_usuario_disp, 
	nm_usuario_fim_prep, 
	nm_usuario_inic_prep, 
	nm_usuario_p, 
	nr_atendimento, 
	nr_prescricao, 
	nr_seq_atendimento, 
	nr_seq_etapa_prod, 
	nr_seq_motivo_dupl, 
	qt_dias_util, 
	qt_dosagem, 
	qt_hora_aplic, 
	qt_hora_validade, 
	qt_min_aplic, 
	qt_min_validade, 
	qt_peso, 
	qt_superf_corporea, 
	qt_temp, 
	qt_volume_aspirado, 
	ie_cancelada, 
	ie_conferido, 
	nr_seq_ordem_p 
from 	can_ordem_prod 
where	nr_sequencia = nr_seq_ordem_p 
and	coalesce(nr_seq_ordem_origem::text, '') = '';
 
commit;
 
insert into can_ordem_item_prescr( 
	nr_sequencia, 
	nr_seq_ordem, 
	cd_material, 
	cd_unidade_medida, 
	ds_observacao, 
	dt_atualizacao, 
	dt_atualizacao_nrec, 
	dt_solic_perda, 
	ie_agrupador, 
	nm_usuario, 
	nm_usuario_nrec, 
	nr_prescricao, 
	nr_seq_prescricao, 
	nr_sequencia_diluente, 
	qt_dose) 
SELECT	nextval('can_ordem_item_prescr_seq'), 
	nr_seq_ordem_w, 
	a.cd_material, 
	a.cd_unidade_medida, 
	a.ds_observacao, 
	a.dt_atualizacao, 
	a.dt_atualizacao_nrec, 
	a.dt_solic_perda, 
	a.ie_agrupador, 
	a.nm_usuario, 
	a.nm_usuario_nrec, 
	a.nr_prescricao, 
	a.nr_seq_prescricao, 
	a.nr_sequencia_diluente, 
	a.qt_dose 
from	paciente_atend_medic d, 
	prescr_material c, 
	can_ordem_prod b, 
	can_ordem_item_prescr a 
where	d.nr_seq_atendimento = b.nr_seq_atendimento 
and	d.nr_seq_material = c.nr_seq_material 
and	a.nr_prescricao = c.nr_prescricao 
and	a.nr_seq_prescricao = c.nr_sequencia 
and	b.nr_sequencia = a.nr_seq_ordem 
and 	ie_administracao = 'P' 
and	b.nr_sequencia = nr_seq_ordem_p 
and	coalesce(b.nr_seq_ordem_origem::text, '') = '';
 
insert into can_ordem_prod_mat( 
	nr_sequencia, 
	nr_seq_ordem, 
	dt_atualizacao, 
	nm_usuario, 
	cd_material, 
	qt_dose, 
	cd_unidade_medida, 
	ie_medic_diluente, 
	nr_seq_lote_fornec, 
	qt_dose_real, 
	qt_perda, 
	cd_unidade_medida_real, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	cd_motivo_baixa, 
	cd_unid_med_perda, 
	nr_seq_item_prescr, 
	ie_devolve_cabine, 
	nr_seq_ordem_origem, 
	cd_estabelecimento, 
	dt_solic_perda, 
	nr_prescricao, 
	nr_seq_kit, 
	ie_reaproveitado) 
SELECT nextval('can_ordem_prod_mat_seq'), 
	nr_seq_ordem_w, 
	clock_timestamp(), 
	nm_usuario_p, 
	b.cd_material, 
	b.qt_dose, 
	b.cd_unidade_medida, 
	b.ie_medic_diluente, 
	b.nr_seq_lote_fornec, 
	b.qt_dose_real, 
	b.qt_perda, 
	b.cd_unidade_medida_real, 
	b.dt_atualizacao_nrec, 
	b.nm_usuario_nrec, 
	b.cd_motivo_baixa, 
	b.cd_unid_med_perda, 
	b.nr_seq_item_prescr, 
	b.ie_devolve_cabine, 
	b.nr_seq_ordem_origem, 
	b.cd_estabelecimento, 
	b.dt_solic_perda, 
	b.nr_prescricao, 
	b.nr_seq_kit, 
	b.ie_reaproveitado 
from	paciente_atend_medic i, 
	prescr_medica h, 
	prescr_material d, 
	can_ordem_item_prescr c, 
	can_ordem_prod_mat b, 
	can_ordem_prod a 
where	i.nr_seq_atendimento = a.nr_seq_atendimento 
and	i.nr_seq_material = d.nr_seq_material 
and	a.nr_sequencia	= nr_seq_ordem_p 
and	d.nr_prescricao	= h.nr_prescricao 
and	a.nr_prescricao	= d.nr_prescricao 
and	c.nr_seq_prescricao = d.nr_sequencia 
and	a.nr_sequencia	= b.nr_seq_ordem 
and 	c.nr_seq_ordem = b.nr_seq_ordem 
and 	b.nr_seq_item_prescr = c.nr_sequencia 
and 	coalesce(a.ie_medic_paciente,'N') = 'N' 
and	ie_administracao = 'P' 
and	coalesce(a.nr_seq_ordem_origem::text, '') = '';
 
 
commit;
 
update	can_ordem_prod 
set	dt_devolucao		= clock_timestamp(), 
	nm_usuario_devol	= nm_usuario_p, 
	dt_entrega_setor	 = NULL, 
	nm_usuario_disp		 = NULL 
where	nr_sequencia		= nr_seq_ordem_w;
 
commit;
 
open C01;
loop 
fetch C01 into	 
	nr_atendimento_w, 
	cd_material_w, 
	cd_unidade_medida_w, 
	qt_material_w, 
	dt_prescricao_w, 
	nr_prescricao_w, 
	nr_seq_lote_fornec_w, 
	ie_via_aplicacao_w, 
	nr_seq_item_prescr_w, 
	nr_seq_etapa_prod_w, 
	cd_setor_atendimento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
 
	select	max(nr_sequencia) 
	into STRICT	nr_sequencia_w 
	from	material_atend_paciente 
	where 	nr_seq_ordem_prod = nr_seq_ordem_p 
	and	cd_material = cd_material_w;
 
	CALL voltar_item_pendente_prescr(nr_sequencia_w, nm_usuario_p);
	 
	CALL excluir_glosa_valor_mat(nr_sequencia_w, nm_usuario_p);		
 
	delete 	from can_ordem_prod_mat 
	where 	nr_seq_ordem = nr_seq_ordem_p 
	and	cd_material = cd_material_w;
 
	commit;
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_desdobramento_ordem (nr_seq_ordem_p bigint, nm_usuario_p text) FROM PUBLIC;

