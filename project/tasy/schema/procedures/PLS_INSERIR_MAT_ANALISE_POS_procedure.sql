-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inserir_mat_analise_pos ( nr_seq_material_p bigint, qt_material_p bigint, dt_material_p timestamp, ie_tipo_guia_p text, nr_seq_fornecedor_p bigint, nr_seq_analise_p bigint, nr_nota_fiscal_p text, nr_seq_conta_p bigint, nr_seq_conta_princ_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_comitar_p text, nr_seq_grupo_atual_p bigint, nr_seq_item_criado_p INOUT bigint) AS $body$
DECLARE


nr_seq_mat_w		bigint;
dt_material_w		timestamp;
nr_seq_conta_w		bigint;
nr_seq_item_criado_w	bigint;
cd_material_w		varchar(20);				
ds_observacao_w		varchar(500);
ie_origem_analise_w	bigint;
nr_seq_analise_w	bigint;

/*Diego 04/07/2011 - OS 330164
    Rotina que tem por objetivo criar na conta médica o material inserido pelo auditor durante o processo de auditoria.*/
BEGIN

select	nextval('pls_conta_mat_seq')
into STRICT	nr_seq_mat_w
;

if (coalesce(nr_seq_conta_p,0) <> 0) then
	/*Obtem a conta principal do tipo de guia passada*/
	
	nr_seq_conta_w := nr_seq_conta_p;
	
else	
	select	min(a.nr_sequencia)
	into STRICT	nr_seq_conta_w
	from	pls_conta			a,
		pls_conta_pos_estabelecido 	b
	where	b.nr_seq_analise 	= nr_seq_analise_p
	and	b.nr_seq_conta	= a.nr_sequencia
	and	((b.ie_situacao		= 'A') or (coalesce(b.ie_situacao::text, '') = ''))
	and	a.ie_tipo_guia 	= ie_tipo_guia_p;
	
end if;

select	coalesce(dt_material_p, dt_emissao)
into STRICT	dt_material_w
from	pls_conta
where	nr_sequencia = nr_seq_conta_w;

/*Criar o material na conta médica*/

insert into pls_conta_mat(nr_sequencia, nr_seq_material, qt_material,
	 qt_material_imp, vl_unitario_imp, vl_material_imp,
	 dt_atendimento, nr_seq_conta, nm_usuario, 
	 nm_usuario_nrec, dt_atualizacao, dt_atualizacao_nrec, 
	 ie_situacao, ie_status, nr_nota_fiscal,
	 nr_seq_prest_fornec, vl_unitario, vl_liberado, 
	 ie_lanc_manual_pos)
values (nr_seq_mat_w, nr_seq_material_p, 0,
	 qt_material_p, 0, 0,
	 dt_material_w, nr_seq_conta_w, nm_usuario_p, 
	 nm_usuario_p, clock_timestamp(), clock_timestamp(), 
	 'D', 'M', nr_nota_fiscal_p,
	 nr_seq_fornecedor_p, 0, 0,
	 'S');

CALL pls_cta_proc_mat_regra_pck.cria_registro_regra_mat(nr_seq_mat_w, nm_usuario_p);
CALL pls_cta_proc_mat_regra_pck.gera_seq_tiss_mat(nr_seq_mat_w, null, null, nr_seq_conta_w, nm_usuario_p);

select	nr_seq_analise
into STRICT	nr_seq_analise_w
from	pls_conta
where 	nr_sequencia = nr_seq_conta_w;

CALL pls_gerar_valor_pos_estab(nr_seq_conta_w, nm_usuario_p,'A',null,nr_seq_mat_w,'C');

CALL pls_atualizar_glosa_oc_analise(	null, nr_seq_mat_w, nr_seq_analise_w,
				cd_estabelecimento_p, nm_usuario_p);

select	max(ie_origem_analise)
into STRICT	ie_origem_analise_w
from	pls_analise_conta
where	nr_sequencia = 	nr_seq_analise_p;				

/*Gerar os dados do resumo para ser usado na função OPS - Análise de Produção Médica */

nr_seq_item_criado_w := pls_gerar_w_resumo_conta(	nr_seq_conta_w, null, nr_seq_mat_w, nr_seq_conta_princ_p, nr_seq_analise_w, nm_usuario_p, nr_seq_item_criado_w);
			
CALL pls_gerar_w_resumo_pos(	nr_seq_conta_w, 0, nr_seq_mat_w,
				nr_seq_analise_p, nm_usuario_p);

/*Atualizar o status da conta de pos estabelecido, levando em consideração os dados da análisede pos e análise da conta médica*/

CALL pls_atualizar_status_fat_pos(	nr_seq_conta_p,	nr_seq_mat_w, null,				
				nr_seq_analise_p, cd_estabelecimento_p,	nm_usuario_p	);
			
select	max(cd_material_ops)
into STRICT	cd_material_w
from 	pls_material
where 	nr_sequencia		= nr_seq_material_p
and	cd_estabelecimento	= cd_estabelecimento_p;

ds_observacao_w :=	'Material inserido: '||coalesce(cd_material_w,nr_seq_material_p)||'-'||pls_obter_desc_material(nr_seq_material_p)||chr(13)||chr(10)||
			'Quantidade inserida: '||qt_material_p;
/*Inserindo histórico*/

CALL pls_inserir_hist_analise(nr_seq_conta_w,  nr_seq_analise_p, 20,
			 nr_seq_mat_w, 'M', null,
			 null,ds_observacao_w, nr_seq_grupo_atual_p,
			 nm_usuario_p,cd_estabelecimento_p);
nr_seq_item_criado_p	:= nr_seq_item_criado_w;			
if (coalesce(ie_comitar_p,'S') = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inserir_mat_analise_pos ( nr_seq_material_p bigint, qt_material_p bigint, dt_material_p timestamp, ie_tipo_guia_p text, nr_seq_fornecedor_p bigint, nr_seq_analise_p bigint, nr_nota_fiscal_p text, nr_seq_conta_p bigint, nr_seq_conta_princ_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_comitar_p text, nr_seq_grupo_atual_p bigint, nr_seq_item_criado_p INOUT bigint) FROM PUBLIC;

