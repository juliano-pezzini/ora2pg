-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hd_encerrar_escala_tratamento (nr_seq_escala_p bigint) AS $body$
DECLARE


nr_seq_escala_dia_w		hd_escala_dialise_dia.nr_sequencia%type;
nr_seq_agenda_w			hd_agenda_dialise.nr_seq_agenda%type;
nr_seq_age_dial_w		hd_agenda_dialise.nr_sequencia%type;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	hd_escala_dialise_dia
	where	nr_seq_escala = nr_seq_escala_p
	and		coalesce(dt_fim_escala_dia::text, '') = '';
	
C02 CURSOR FOR
	SELECT	nr_sequencia,	
			nr_seq_agenda
	from	hd_agenda_dialise
	where	nr_seq_dialise_dia = nr_seq_escala_dia_w
	and		trunc(dt_agenda) >= trunc(clock_timestamp())+1;
	

BEGIN

if (nr_seq_escala_p <> 0) then

	update 	hd_escala_dialise
	set 	dt_fim = clock_timestamp()
	where	nr_sequencia = nr_seq_escala_p
	and		coalesce(dt_fim::text, '') = '';
	
	open C01;
	loop
	fetch C01 into	
		nr_seq_escala_dia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		
		open C02;
		loop
		fetch C02 into	
			nr_seq_age_dial_w,
			nr_seq_agenda_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			update	hd_agenda_dialise
			set		ie_situacao = 'C',
					nm_usuario = wheb_usuario_pck.get_nm_usuario,
					dt_atualizacao = clock_timestamp()
			where	nr_sequencia = nr_seq_age_dial_w;
			
			update	agenda_consulta
			SET 	ie_status_agenda = 'C',
					nm_usuario       = wheb_usuario_pck.get_nm_usuario,
					dt_atualizacao   = clock_timestamp()
            WHERE 	nr_sequencia = nr_seq_agenda_w;
			end;
		end loop;
		close C02;
		
		
		end;
	end loop;
	close C01;
	
end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hd_encerrar_escala_tratamento (nr_seq_escala_p bigint) FROM PUBLIC;

