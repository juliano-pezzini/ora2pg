-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consistir_cobertura_bonif ( nr_seq_bonificacao_p pls_bonificacao.nr_sequencia%type, nr_seq_segurado_p pls_segurado.nr_sequencia%type, dt_referencia_p pls_mensalidade_segurado.dt_mesano_referencia%type, nr_seq_vinculo_sca_p pls_sca_vinculo.nr_sequencia%type, nr_seq_vinculo_bonificacao_p pls_bonificacao_vinculo.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, ie_cobertura_p INOUT text, ds_observacao_p INOUT text, ie_aniversario_sca_p INOUT text) AS $body$
DECLARE


cd_grupo_proc_w			procedimento.cd_grupo_proc%type;
cd_especialidade_w		grupo_proc.cd_especialidade%type;
cd_area_procedimento_w		especialidade_proc.cd_area_procedimento%type;
qt_cobertura_w			integer;
qt_utilizacao_w			integer;
dt_inicio_w			timestamp;
dt_fim_w			timestamp;
ie_aniversario_sca_w		pls_bonificacao_regra.ie_aniversario_contrato%type;
dt_inicio_vigencia_w		pls_sca_vinculo.dt_inicio_vigencia%type;
dt_referencia_w			pls_mensalidade_segurado.dt_mesano_referencia%type;
qt_lancamento_bonificacao_w	integer;

ds_observacao_w		varchar(255);
ie_cobertura_w		varchar(1);

C01 CURSOR(	nr_seq_bonificacao_pc	pls_bonificacao.nr_sequencia%type) FOR
	SELECT	nr_seq_tipo_cobertura,
		qt_cobertura qt_cobertura_regra,
		qt_meses_intervalo,
		coalesce(ie_aniversario_contrato,'N') ie_aniversario_sca
	from	pls_bonificacao_regra
	where	nr_seq_bonificacao	= nr_seq_bonificacao_pc
	and	ie_tipo_regra		= 'C'
	and	(nr_seq_tipo_cobertura IS NOT NULL AND nr_seq_tipo_cobertura::text <> '');

C02 CURSOR(	nr_seq_segurado_pc	pls_segurado.nr_sequencia%type,
		dt_inicio_pc		timestamp,
		dt_fim_pc		timestamp) FOR
	SELECT	a.cd_procedimento,
		a.ie_origem_proced,
		coalesce(a.qt_procedimento,0) qt_procedimento
	from	pls_conta_proc		a,
		pls_conta		b,
		pls_protocolo_conta	d
	where	b.nr_sequencia		= a.nr_seq_conta
	and	d.nr_sequencia		= b.nr_seq_protocolo
	and	b.nr_seq_segurado	= nr_seq_segurado_pc
	and	b.ie_status		= 'F'
	and	(a.cd_procedimento IS NOT NULL AND a.cd_procedimento::text <> '')
	and	d.dt_mes_competencia between dt_inicio_pc and dt_fim_pc;
BEGIN
ds_observacao_w	:= '';
ie_cobertura_w	:= 'S';

for r_c01_w in C01(nr_seq_bonificacao_p) loop
	begin
	ie_aniversario_sca_w	:= r_c01_w.ie_aniversario_sca;

	--A tabela w_pls_segurado_compl é utilizada para o cliente armazenas a quantidade de utilização do sistema anterior ao Tasy
	select	max(qt_ocorrencias)
	into STRICT	qt_utilizacao_w
	from	w_pls_segurado_compl
	where	nr_seq_segurado		= nr_seq_segurado_p
	and	ie_tipo_complemento	= 'CB';
	qt_utilizacao_w	:= coalesce(qt_utilizacao_w,0);

	dt_inicio_w	:= trunc(add_months(dt_referencia_p,-r_c01_w.qt_meses_intervalo),'month');
	dt_fim_w	:= fim_dia(last_day(add_months(dt_referencia_p,-1)));

	for r_c02_w in C02(nr_seq_segurado_p, dt_inicio_w, dt_fim_w) loop
		begin

		begin
		select	cd_grupo_proc,
			cd_especialidade,
			cd_area_procedimento
		into STRICT	cd_grupo_proc_w,
			cd_especialidade_w,
			cd_area_procedimento_w
		from	estrutura_procedimento_v
		where	cd_procedimento		= r_c02_w.cd_procedimento
		and	ie_origem_proced	= r_c02_w.ie_origem_proced;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(267426,
								'CD_PROCEDIMENTO_W=' || r_c02_w.cd_procedimento||';'||
								'IE_ORIGEM_PROCED_W=' || r_c02_w.ie_origem_proced);
		end;

		select	count(1)
		into STRICT	qt_cobertura_w
		from	pls_cobertura_bonificacao a
		where	a.nr_seq_tipo_cobertura	= r_c01_w.nr_seq_tipo_cobertura
		and	coalesce(a.cd_procedimento, r_c02_w.cd_procedimento)		= r_c02_w.cd_procedimento
		and	coalesce(a.ie_origem_proced, r_c02_w.ie_origem_proced)	= r_c02_w.ie_origem_proced
		and	coalesce(a.cd_grupo_proc, cd_grupo_proc_w)			= cd_grupo_proc_w
		and	coalesce(a.cd_especialidade, cd_especialidade_w)		= cd_especialidade_w
		and	coalesce(a.cd_area_procedimento, cd_area_procedimento_w)	= cd_area_procedimento_w
		and	coalesce(a.ie_liberado,'N')	= 'S';

		if (qt_cobertura_w > 0) and (r_c02_w.qt_procedimento > 0) then
			qt_utilizacao_w	:= qt_utilizacao_w + r_c02_w.qt_procedimento;
		end if;
		end;
	end loop; --C03
	if (qt_utilizacao_w > r_c01_w.qt_cobertura_regra) then
		ds_observacao_w	:= 'Bonificação não gerada pois o beneficiário ultrapassou a utilização permitida('||r_c01_w.qt_cobertura_regra||') entre '||to_char(dt_inicio_w,'dd/mm/yyyy')||' e '||to_char(dt_fim_w,'dd/mm/yyyy')||'. Utilizado: '||qt_utilizacao_w;
		ie_cobertura_w	:= 'N';
	end if;

	end;
end loop; --C01
if (ie_aniversario_sca_w = 'S') and (nr_seq_vinculo_sca_p IS NOT NULL AND nr_seq_vinculo_sca_p::text <> '') then
	select	dt_inicio_vigencia
	into STRICT	dt_inicio_vigencia_w
	from	pls_sca_vinculo
	where	nr_sequencia = nr_seq_vinculo_sca_p;

	if (to_char(dt_inicio_vigencia_w,'mm') = to_char(dt_referencia_p,'mm')) then
		for i in 1..12 loop
			begin
			dt_referencia_w	:= add_months(dt_referencia_p,i);

			select	count(1)
			into STRICT	qt_lancamento_bonificacao_w
			from	pls_segurado_mensalidade
			where	nr_seq_segurado		= nr_seq_segurado_p
			and	dt_referencia		= dt_referencia_w
			and	nr_seq_bonificacao	= nr_seq_bonificacao_p;

			if (qt_lancamento_bonificacao_w = 0) then
				insert	into	pls_segurado_mensalidade(	nr_sequencia, nr_seq_segurado, cd_estabelecimento,
						dt_referencia, ie_tipo_item, dt_atualizacao,
						nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
						nr_seq_bonificacao, ie_situacao, vl_item,
						tx_desconto, nr_seq_vinculo_bonificacao, ie_tipo_lanc)
					values (	nextval('pls_segurado_mensalidade_seq'), nr_seq_segurado_p, cd_estabelecimento_p,
						dt_referencia_w, '14', clock_timestamp(),
						nm_usuario_p, clock_timestamp(), nm_usuario_p,
						nr_seq_bonificacao_p, 'A', 0,
						0, nr_seq_vinculo_bonificacao_p, 'B');
			end if;
			end;
		end loop;
	end if;
else
	ie_aniversario_sca_w	:= 'N'; --Se não for vinculado a um SCA, a opção é Não
end if;

ds_observacao_p		:= ds_observacao_w;
ie_cobertura_p		:= ie_cobertura_w;
ie_aniversario_sca_p	:= ie_aniversario_sca_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consistir_cobertura_bonif ( nr_seq_bonificacao_p pls_bonificacao.nr_sequencia%type, nr_seq_segurado_p pls_segurado.nr_sequencia%type, dt_referencia_p pls_mensalidade_segurado.dt_mesano_referencia%type, nr_seq_vinculo_sca_p pls_sca_vinculo.nr_sequencia%type, nr_seq_vinculo_bonificacao_p pls_bonificacao_vinculo.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type, ie_cobertura_p INOUT text, ds_observacao_p INOUT text, ie_aniversario_sca_p INOUT text) FROM PUBLIC;

