-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE contabiliza_receb_convenio ( nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text) AS $body$
DECLARE


cd_conta_contabil_w                     varchar(20);
cd_estabelecimento_w                    estabelecimento.cd_estabelecimento%type;
nr_documento_w                          varchar(255);
vl_transacao_w                          double precision;
cd_pessoa_fisica_w                      varchar(10);
cd_cgc_w                                varchar(14);
nr_seq_conta_banco_w                    bigint;
nr_seq_trans_fin_w                      bigint;
nr_seq_agrupamento_w                    bigint;
nm_atributo_w                           varchar(50);
dt_contabil_w                           timestamp;
dt_contabil_ww                          timestamp;
vl_retorno_w                            double precision;
cd_convenio_w                           integer;
dt_Movimento_w                          timestamp;
ie_devedor_hist_contab_w                varchar(01);
ds_convenio_w                           varchar(255) := '';
ds_observacao_w                         varchar(255);
ie_dt_contab_conv_receb_w               varchar(1);
dt_contabil_receb_w                     timestamp;
ie_compl_hist_w                         varchar(1);
ds_conta_banco_w                        varchar(255);
ds_conteudo_w                           varchar(4000) := '';
nr_seq_receb_w                          bigint;
ds_notas_fiscais_w                      varchar(255);
ds_nfe_convenio_w                       varchar(255);
ds_titulos_w                            varchar(255);
ie_contab_convenio_receb_w              varchar(1);
ds_banco_w                              banco_estabelecimento_v.ds_banco%type;
ie_contab_estorno_receb_w               varchar(15);
ie_agrup_receb_conv_w                   varchar(1);
ds_retorno_receb_w                      varchar(250);
ie_contab_vl_adic_estorno_w             varchar(1);
nr_seq_movto_w                          bigint;
ds_notas_protocolo_w                    varchar(255);
ie_tp_dt_contab_rec_conv_w              varchar(2);
cd_tributo_w                            tributo.cd_tributo%type;
nr_documento_ww                         movimento_contabil.nr_documento%Type;
ie_origem_documento_w                   movimento_contabil.ie_origem_documento%Type;
ie_regra_w                              varchar(255);
ds_atributos_w                          varchar(4000);
cd_tipo_lote_contabil_w                 lote_contabil.cd_tipo_lote_contabil%type;
nm_agrupador_w                          varchar(255);

/* Cursor para ler Movimento a Ser contabilizado */

c010 CURSOR FOR
        SELECT  b.cd_convenio,
                vl_recebimento,
                nr_seq_trans_fin,
                dt_recebimento,
                'VL_RECEBIMENTO',
                nr_seq_conta_banco,
                b.cd_cgc,
                0,
                a.ds_observacao,
                a.dt_recebimento,
                a.nr_sequencia,
                null cd_tributo
        from    Convenio b,
                Convenio_Receb a
        where   nr_Lote_contabil        = nr_lote_contabil_p
        and     a.cd_convenio           = b.cd_convenio
        and     (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
        and     dt_recebimento  between trunc(dt_contabil_w, 'month') and last_day(trunc(dt_contabil_w, 'month')) + 86399/86400
        and     ((ie_contab_estorno_receb_w = 'S') or not exists (SELECT 1
                                                                        from    convenio_receb_estorno  e
                                                                        where   e.nr_seq_receb  = a.nr_sequencia))

union all

        select  b.cd_convenio,
                vl_deposito,
                nr_seq_trans_fin,
                dt_recebimento,
                'VL_DEPOSITO',
                nr_seq_conta_banco,
                b.cd_cgc,
                0,
                a.ds_observacao,
                a.dt_recebimento,
                a.nr_sequencia,
                null cd_tributo
        from    Convenio b,
                Convenio_Receb a
        where   nr_Lote_contabil        = nr_lote_contabil_p
          and   a.cd_convenio           = b.cd_convenio
          and   (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
        
union all

        select  b.cd_convenio,
                vl_despesa_bancaria,
                nr_seq_trans_fin,
                dt_recebimento,
                'VL_DESPESA_BANCARIA',
                nr_seq_conta_banco,
                b.cd_cgc,
                0,
                a.ds_observacao,
                a.dt_recebimento,
                a.nr_sequencia,
                null cd_tributo
        from    Convenio b,
                Convenio_Receb a
        where   nr_Lote_contabil        = nr_lote_contabil_p
        and     a.cd_convenio           = b.cd_convenio
        and     (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
        and     ((ie_contab_estorno_receb_w = 'S') or not exists (select 1
                                                                        from    convenio_receb_estorno  e
                                                                        where   e.nr_seq_receb  = a.nr_sequencia))
        
union all

        select  b.cd_convenio,
                (vl_estorno * -1),
                coalesce(e.nr_seq_trans_fin,a.nr_seq_trans_fin),
                dt_estorno,
                'VL_RECEBIMENTO',
                nr_seq_conta_banco,
                b.cd_cgc,
                1,
                a.ds_observacao,
                dt_estorno,
                a.nr_sequencia,
                null cd_tributo
        from    Convenio b,
                Convenio_Receb a,
                Convenio_Receb_estorno e
        where   e.nr_Lote_contabil      = nr_lote_contabil_p
        and     a.cd_convenio           = b.cd_convenio
        and     a.nr_sequencia          = e.nr_seq_receb
        and     (coalesce(e.nr_seq_trans_fin,a.nr_seq_trans_fin) IS NOT NULL AND (coalesce(e.nr_seq_trans_fin,a.nr_seq_trans_fin))::text <> '')
        and (ie_contab_estorno_receb_w = 'S')
        
union all

        select  b.cd_convenio,
                (vl_estorno * -1),
                coalesce(e.nr_seq_trans_fin,a.nr_seq_trans_fin),
                dt_estorno,
                'VL_DEPOSITO',
                nr_seq_conta_banco,
                b.cd_cgc,
                1,
                a.ds_observacao,
                dt_estorno,
                a.nr_sequencia,
                null cd_tributo
        from    Convenio b,
                Convenio_Receb a,
                Convenio_Receb_estorno e
        where   e.nr_Lote_contabil      = nr_lote_contabil_p
        and     a.cd_convenio           = b.cd_convenio
        and     a.nr_sequencia          = e.nr_seq_receb
        and     (coalesce(e.nr_seq_trans_fin,a.nr_seq_trans_fin) IS NOT NULL AND (coalesce(e.nr_seq_trans_fin,a.nr_seq_trans_fin))::text <> '')
        and     ie_contab_estorno_receb_w = 'S'
        
union all

        select  b.cd_convenio,
                e.vl_adicional,
                e.nr_seq_trans_financ,
                e.dt_atualizacao,
                'VL_ADICIONAL',
                a.nr_seq_conta_banco,
                b.cd_cgc,
                1,
                a.ds_observacao,
                dt_recebimento,
                a.nr_sequencia,
                e.cd_tributo
        from    Convenio b,
                Convenio_Receb a,
                Convenio_Receb_adic e
        where   e.nr_Lote_contabil      = nr_lote_contabil_p
        and     a.cd_convenio           = b.cd_convenio
        and     a.nr_sequencia          = e.nr_seq_receb
        and     (e.nr_seq_trans_financ IS NOT NULL AND e.nr_seq_trans_financ::text <> '')
        
union all

        select  a.cd_convenio,
                a.vl_adicional,
                a.nr_seq_trans_financ,
                a.dt_atualizacao,
                a.nm_atributo,
                a.nr_seq_conta_banco,
                a.cd_cgc,
                a.nr_agrupamento,
                a.ds_observacao,
                a.dt_recebimento,
                a.nr_sequencia,
                null cd_tributo
        from    ctb_receb_convenio_cambial_v a
        where   a.nr_Lote_contabil      = nr_lote_contabil_p
        
union all

        select  b.cd_convenio,
                (vl_adic_estorno),
                coalesce(e.nr_seq_trans_fin,a.nr_seq_trans_fin),
                dt_estorno,
                'VL_ADICIONAL_ESTORNO',
                nr_seq_conta_banco,
                b.cd_cgc,
                1,
                a.ds_observacao,
                dt_estorno,
                a.nr_sequencia,
                null cd_tributo
        from    Convenio b,
                Convenio_Receb a,
                Convenio_Receb_estorno e
        where   e.nr_Lote_contabil      = nr_lote_contabil_p
        and     a.cd_convenio           = b.cd_convenio
        and     a.nr_sequencia          = e.nr_seq_receb
        and     (coalesce(e.nr_seq_trans_fin,a.nr_seq_trans_fin) IS NOT NULL AND (coalesce(e.nr_seq_trans_fin,a.nr_seq_trans_fin))::text <> '')
        and (ie_contab_vl_adic_estorno_w = 'S')     -- Marcio: Substituir por novo campo
        
union all

        /* Adiantamento de Convenio */

        select  b.cd_convenio,
                a.vl_adiantamento,
                coalesce(a.nr_seq_trans_fin, b.nr_seq_trans_fin),
                a.dt_adiantamento,
                'VL_ADIANTAMENTO',
                a.nr_seq_conta_banco,
                a.cd_cgc,
                0,
                a.ds_observacao,
                a.dt_contabil,
                b.nr_sequencia,
                null cd_tributo
        from    adiantamento a,
                convenio_receb b,
                convenio_receb_adiant c
        where   b.nr_Lote_contabil      = nr_lote_contabil_p
        and     b.nr_sequencia          = c.nr_seq_receb
        and     c.nr_adiantamento       = a.nr_adiantamento
        and     (coalesce(a.nr_seq_trans_fin, b.nr_seq_trans_fin) IS NOT NULL AND (coalesce(a.nr_seq_trans_fin, b.nr_seq_trans_fin))::text <> '');


BEGIN
/*Validacao para impedir a geracao em lotes incorretos */

if (ie_exclusao_p <> 'S') then
        select b.cd_tipo_lote_contabil
        into STRICT cd_tipo_lote_contabil_w
        from lote_contabil b
        where b.nr_lote_contabil = nr_lote_contabil_p;
        if (cd_tipo_lote_contabil_w <> 11) then
                CALL wheb_mensagem_pck.exibir_mensagem_abort(261346);
        end if;
end if;

delete
from    lote_contabil_log
where   nr_lote_contabil        = nr_lote_contabil_p
and     cd_log_lote in (9,10);

commit;

select  dt_referencia,
        dt_referencia,
        cd_estabelecimento,
        obter_se_compl_tipo_lote(cd_estabelecimento, cd_tipo_lote_contabil),
        cd_tipo_lote_contabil
into STRICT    dt_contabil_w,
        dt_contabil_ww,
        cd_estabelecimento_w,
        ie_compl_hist_w,
        cd_tipo_lote_contabil_w
from    lote_contabil
where   nr_lote_contabil        = nr_lote_contabil_p;

select  ie_devedor_hist_contab,
        ie_dt_contab_conv_receb,
        coalesce(ie_contab_convenio_receb,'N'),
        coalesce(ie_contab_estorno_receb,'N'),
        coalesce(ie_agrup_receb_conv,'N'),
        coalesce(ie_contab_vl_adic_estorno,'N'),
        coalesce(ie_tipo_data_contab_rec_conv,'RE')
into STRICT    ie_devedor_hist_contab_w,
        ie_dt_contab_conv_receb_w,
        ie_contab_convenio_receb_w,
        ie_contab_estorno_receb_w,
        ie_agrup_receb_conv_w,
        ie_contab_vl_adic_estorno_w,
        ie_tp_dt_contab_rec_conv_w
from    parametro_contas_receber
where   cd_estabelecimento      = cd_estabelecimento_w;

delete  from w_movimento_contabil
where   nr_Lote_contabil        = nr_lote_contabil_p;
commit;

if (ie_exclusao_p = 'S') then
        delete  from movimento_contabil
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  lote_contabil
        set     vl_credito      = 0,
                vl_debito       = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  convenio_receb
        set     nr_lote_contabil        = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  convenio_receb_estorno
        set     nr_lote_contabil        = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  convenio_receb_adic
        set     nr_lote_contabil        = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;
else
        delete  FROM w_movimento_contabil
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  convenio_receb
        set     nr_lote_contabil                = nr_lote_contabil_p
        where   coalesce(nr_lote_contabil,0)         = 0
        and     trunc(dt_recebimento,'month')   = trunc(dt_contabil_w, 'month')
        and     trunc(dt_recebimento,'dd')      <= trunc(dt_contabil_w, 'dd')
        and     cd_estabelecimento              = cd_estabelecimento_w;

        update  convenio_receb_estorno a
        set     nr_lote_contabil                = nr_lote_contabil_p
        where   coalesce(nr_lote_contabil,0)         = 0
        and     trunc(dt_estorno,'month')       = trunc(dt_contabil_w, 'month')
        and     trunc(dt_estorno,'dd')  <= trunc(dt_contabil_w, 'dd')
        and     exists (SELECT 1
                        from    convenio_receb b
                        where   a.nr_seq_receb          = b.nr_sequencia
                        and     b.cd_estabelecimento    = cd_estabelecimento_w);

        if (ie_tp_dt_contab_rec_conv_w = 'RE') then
                update  convenio_receb_adic
                set     nr_lote_contabil        = nr_lote_contabil_p
                where   nr_seq_receb in (SELECT nr_sequencia
                                                from    convenio_receb
                                                where   nr_lote_contabil        = nr_lote_contabil_p);

        elsif (ie_tp_dt_contab_rec_conv_w = 'AT') then
                update  convenio_receb_adic a
                set     a.nr_lote_contabil = nr_lote_contabil_p
                where   coalesce(a.nr_lote_contabil,0)       = 0
                and     trunc(a.dt_atualizacao,'month') = trunc(dt_contabil_w, 'month')
                and     trunc(a.dt_atualizacao,'dd') <= trunc(dt_contabil_w, 'dd')
                and     exists (SELECT         1
                                from    convenio_receb b
                                where   b.nr_sequencia  = a.nr_seq_receb
                                and     coalesce(b.nr_lote_contabil,0) <> 0);
        end if;

        nm_agrupador_w  := coalesce(trim(both obter_agrupador_contabil(11)), 'NR_SEQ_RECEBIMENTO');

        open c010;
        loop
        fetch c010 into
                cd_convenio_w,
                vl_transacao_w,
                nr_seq_trans_fin_w,
                dt_movimento_w,
                nm_atributo_w,
                nr_seq_conta_banco_w,
                cd_cgc_w,
                nr_seq_agrupamento_w,
                ds_observacao_w,
                dt_contabil_receb_w,
                nr_seq_receb_w,
                cd_tributo_w;
        EXIT WHEN NOT FOUND; /* apply on c010 */
                /* Francisco - OS 51027 - 22/02/07 - Trazer a data do recebimento no movimento contabil */

                if (coalesce(ie_dt_contab_conv_receb_w, 'L') = 'R') then
                        dt_contabil_w   := dt_contabil_receb_w;
                end if;

                if (ie_contab_convenio_receb_w = 'N') then
                        cd_convenio_w   := null;
                end if;

                ds_convenio_w   := '';

                if (ie_devedor_hist_contab_w = 'S') and (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') then
                        ds_convenio_w   := substr(obter_nome_pf_pj(null, cd_cgc_w),1,80);
                end if;

                nr_documento_w          := substr(to_char(dt_movimento_w,'dd/mm/yyyy') || ' ' || ds_convenio_w  || ' ' || ds_observacao_w,1,255);

                ds_conteudo_w           := '';

                if (ie_compl_hist_w = 'S') then
                        ds_conta_banco_w        := substr(obter_conta_banco(nr_seq_conta_banco_w),1,254);
                        ds_convenio_w           := substr(obter_nome_pf_pj(null, cd_cgc_w),1,80);

                        if (nr_seq_conta_banco_w IS NOT NULL AND nr_seq_conta_banco_w::text <> '') then
                                select  coalesce(max(ds_banco),'')
                                into STRICT    ds_banco_w
                                from    banco_estabelecimento_v
                                where   nr_sequencia    = nr_seq_conta_banco_w;
                        end if;

                        ds_retorno_receb_w      := substr(obter_dados_convenio_receb(nr_seq_receb_w,'rc'),1,250);
                        ds_notas_fiscais_w      := substr(obter_nf_convenio_receb(nr_seq_receb_w), 1,255);
                        ds_titulos_w            := substr(obter_titulos_convenio_receb(nr_seq_receb_w),1,255);
                        ds_notas_protocolo_w    := substr(obter_nf_titulos_convenio_rec(nr_seq_receb_w),1,255);
                        ds_nfe_convenio_w       := substr(obter_nfe_convenio_receb(nr_seq_receb_w),1,255);
                        ds_conteudo_w           := substr(      dt_contabil_ww          || '#@' ||
                                                                dt_contabil_receb_w     || '#@' ||
                                                                ds_conta_banco_w        || '#@' ||
                                                                ds_convenio_w           || '#@' ||
                                                                ds_observacao_w         || '#@' ||
                                                                ds_notas_fiscais_w      || '#@' ||
                                                                ds_titulos_w            || '#@' ||
                                                                ds_banco_w              || '#@' ||
                                                                nr_seq_receb_w          || '#@' ||
                                                                ds_retorno_receb_w      || '#@' ||
                                                                ''                      || '#@' ||
                                                                ds_notas_protocolo_w    || '#@' ||
                                                                ds_nfe_convenio_w,1,4000);
                end if;

                if (nm_agrupador_w = 'NR_SEQ_RECEBIMENTO')then
                        nr_seq_agrupamento_w    := nr_seq_receb_w;
                end if;

                if (coalesce(nr_seq_agrupamento_w,0) = 0)then
                        nr_seq_agrupamento_w    := nr_seq_receb_w;
                end if;

                ds_atributos_w  := null;

                ds_atributos_w  := 'NR_SEQ_RECEB_CONVENIO=' || nr_seq_receb_w;

                ctb_obter_doc_movto(    cd_tipo_lote_contabil_w,
                                        nm_atributo_w,
                                        'VR',
                                        dt_contabil_w,
                                        null,
                                        null,
                                        ds_atributos_w,
                                        nm_usuario_p,
                                        ie_regra_w,
                                        nr_documento_ww,
                                        ie_origem_documento_w);

                nr_seq_movto_w := gerar_contab_trans_financ(      cd_estabelecimento_w, null, nr_lote_contabil_p, nm_usuario_p, '', 0, nr_documento_w, nr_seq_agrupamento_w, dt_contabil_w, vl_transacao_w, nr_seq_trans_fin_w, nr_seq_conta_banco_w, nm_atributo_w, cd_pessoa_fisica_w, cd_cgc_w, 0, cd_convenio_w, nr_documento_ww, null, ds_conteudo_w, null, null, null, cd_tributo_w, null, null, cd_tributo_w, null, null, null, null, null, null, null, nr_seq_movto_w, null, null, null, ie_origem_documento_w);
        end loop;
        close c010;

        CALL agrupa_movimento_contabil(      nr_lote_contabil_p,
                                        nm_usuario_p);
end if;
commit;

if (coalesce(ds_retorno_p::text, '') = '') then
        update  lote_contabil
        set     ie_situacao             = 'A',
                dt_geracao_lote         = clock_timestamp()
        where   nr_lote_contabil        = nr_lote_contabil_p;

        if (ie_exclusao_p = 'S') then
                ds_retorno_p            := wheb_mensagem_pck.get_texto(299468);

                CALL ctb_gravar_log_lote(    nr_lote_contabil_p,
                                        2,
                                        '',
                                        nm_usuario_p);
        else
                ds_retorno_p            := wheb_mensagem_pck.get_texto(299469);

                CALL ctb_gravar_log_lote(    nr_lote_contabil_p,
                                        1,
                                        '',
                                        nm_usuario_p);
        end if;
        commit;
else
        rollback;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE contabiliza_receb_convenio ( nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text) FROM PUBLIC;

