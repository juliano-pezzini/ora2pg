-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_ordem_compra_consig (cd_estabelecimento_p bigint, nr_atendimento_p bigint, nr_prescricao_p bigint, cd_material_p bigint, qt_material_p bigint, cd_local_estoque_p bigint, cd_cgc_fornec_p text, nm_usuario_p text) AS $body$
DECLARE

 
cd_centro_custo_w			bigint;
cd_local_entrega_w			bigint;	
cd_operacao_devol_paciente_w		smallint;
cd_pessoa_solicitante_w			varchar(10);
ds_comunicado_w				varchar(2000);
ds_material_w				varchar(255);
dt_prevista_entrega_w			timestamp;
ie_gera_ordem_w				varchar(1);
nm_usuario_dest_w			varchar(255);
nm_usuario_w				varchar(255);
nr_item_oci_w				bigint;
nr_ordem_compra_w			bigint;
nr_seq_classif_w			bigint;
pr_desconto_w				bigint;
cd_perfil_comunic_w			varchar(10);
lista_usuario_w				varchar(2000);
tam_lista_w				bigint;
ie_pos_virgula_w			bigint;
ds_email_usuario_w			varchar(255);
ds_lista_email_usuario_w		varchar(2000);
nm_usuario_ww				varchar(2000);
ie_gera_oc_reposicao_w			varchar(1);


BEGIN 
 
select	substr(obter_desc_material(cd_material_p),1,255) 
into STRICT	ds_material_w
;
 
select	max(nr_ordem_compra) 
into STRICT	nr_ordem_compra_w 
from	ordem_compra 
where	nr_prescricao = nr_prescricao_p 
and	coalesce(dt_liberacao::text, '') = '';
 
select	coalesce(min(nr_item_oci),0) 
into STRICT	nr_item_oci_w 
from	ordem_compra_item 
where	nr_ordem_compra	= nr_ordem_compra_w 
and	qt_material >= qt_material_p 
and	cd_material in (SELECT	cd_material 
			from	material 
			where	cd_material_estoque = cd_material_p 
			
union
 
			SELECT	cd_material 
			from	material 
			where	cd_material = cd_material_p);
 
if (nr_ordem_compra_w > 0) and (nr_item_oci_w > 0) then 
 
	select	max(dt_prevista_entrega) 
	into STRICT	dt_prevista_entrega_w 
	from	ordem_compra_item_entrega 
	where	nr_ordem_compra	= nr_ordem_compra_w 
	and	nr_item_oci	= nr_item_oci_w 
	and	coalesce(dt_cancelamento::text, '') = '';
 
	update ordem_compra_item 
	set	qt_material	= qt_material - qt_material_p, 
		vl_total_item = round(((qt_material - qt_material_p) * vl_unitario_material),4) 
	where	nr_ordem_compra	= nr_ordem_compra_w 
	and	nr_item_oci	= nr_item_oci_w;
 
	update	ordem_compra_item_entrega 
	set	qt_prevista_entrega	= qt_prevista_entrega - qt_material_p 
	where	nr_ordem_compra	= nr_ordem_compra_w 
	and	nr_item_oci	= nr_item_oci_w 
	and	dt_prevista_entrega	= dt_prevista_entrega_w;
else 
	select	obter_classif_comunic('F') 
	into STRICT	nr_seq_classif_w 
	;
 
	select	max(b.nm_usuario) 
	into STRICT	nm_usuario_w 
	from	usuario b, 
		parametro_compras a 
	where	a.cd_estabelecimento	= cd_estabelecimento_p 
	and	a.cd_comprador_padrao	= b.cd_pessoa_fisica;
 
	select	cd_operacao_devol_paciente 
	into STRICT	cd_operacao_devol_paciente_w 
	from	parametro_estoque 
	where	cd_estabelecimento = cd_estabelecimento_p;
 
	SELECT * FROM obter_regra_ordem_consignado( 
			cd_estabelecimento_p, cd_local_estoque_p, cd_operacao_devol_paciente_w, cd_material_p, cd_cgc_fornec_p, 0, 0, ie_gera_ordem_w, cd_local_entrega_w, cd_centro_custo_w, pr_desconto_w, nm_usuario_dest_w, cd_perfil_comunic_w, cd_pessoa_solicitante_w, ie_gera_oc_reposicao_w) INTO STRICT ie_gera_ordem_w, cd_local_entrega_w, cd_centro_custo_w, pr_desconto_w, nm_usuario_dest_w, cd_perfil_comunic_w, cd_pessoa_solicitante_w, ie_gera_oc_reposicao_w;
 
	if	((ie_gera_ordem_w = 'C') or (ie_gera_ordem_w = 'A') or (ie_gera_ordem_w = 'E') or (ie_gera_ordem_w = 'O')) and (nm_usuario_dest_w IS NOT NULL AND nm_usuario_dest_w::text <> '') then 
		nm_usuario_w	:= nm_usuario_w || ',' || nm_usuario_dest_w;
	end if;
	 
	if (coalesce(cd_perfil_comunic_w,0) > 0) then 
		cd_perfil_comunic_w := substr(cd_perfil_comunic_w || ',',1,10);
	end if;
	 
	ds_comunicado_w	:= substr(WHEB_MENSAGEM_PCK.get_texto(297461, 
				';CD_MATERIAL_P='||cd_material_p|| 
				';DS_MATERIAL_W='||ds_material_w|| 
				';QT_MATERIAL_P='||qt_material_p|| 
				';NR_ATENDIMENTO_P='||nr_atendimento_p|| 
				';NR_PRESCRICAO_P='||nr_prescricao_p),1,200);
 
	CALL Gerar_Comunic_Padrao(	clock_timestamp(), 
				WHEB_MENSAGEM_PCK.get_texto(297463), 
				ds_comunicado_w, 
				nm_usuario_p, 
				'N', 
				nm_usuario_w, 
				'N', 
				nr_seq_classif_w, 
				cd_perfil_comunic_w, 
				cd_estabelecimento_p, 
				null, 
				clock_timestamp(), 
				null, 
				null);
	 
	lista_usuario_w	:= substr(nm_usuario_w,1,2000);
				 
	while(lista_usuario_w IS NOT NULL AND lista_usuario_w::text <> '') and (trim(both lista_usuario_w) <> ',') loop 
		tam_lista_w		:= length(lista_usuario_w);
		ie_pos_virgula_w	:= position(',' in lista_usuario_w);
		if (ie_pos_virgula_w <> 0) then 
			nm_usuario_ww	:= substr(lista_usuario_w,1,(ie_pos_virgula_w - 1));
			lista_usuario_w	:= substr(lista_usuario_w,(ie_pos_virgula_w + 2), tam_lista_w);
			 
			select	trim(both max(ds_email)) 
			into STRICT	ds_email_usuario_w 
			from	usuario 
			where	nm_usuario = nm_usuario_ww;
			 
			if (coalesce(ds_email_usuario_w,'X') <> 'X') then 
				begin 
				ds_lista_email_usuario_w := substr(ds_lista_email_usuario_w||ds_email_usuario_w||',',1,2000);
				end;
			end if;
		else 
			lista_usuario_w	:= null;
		end if;
	end loop;
	 
	if (coalesce(ds_lista_email_usuario_w,'X') <> 'X') then 
		begin 
		CALL Enviar_Email(WHEB_MENSAGEM_PCK.get_texto(297463),ds_comunicado_w, null, ds_lista_email_usuario_w, nm_usuario_p,'M');
		exception 
		when others then 
			null;
		end;
	end if;
end if;	
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_ordem_compra_consig (cd_estabelecimento_p bigint, nr_atendimento_p bigint, nr_prescricao_p bigint, cd_material_p bigint, qt_material_p bigint, cd_local_estoque_p bigint, cd_cgc_fornec_p text, nm_usuario_p text) FROM PUBLIC;

