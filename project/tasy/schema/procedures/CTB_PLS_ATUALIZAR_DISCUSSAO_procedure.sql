-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_pls_atualizar_discussao ( nr_seq_lote_disc_p pls_lote_discussao.nr_sequencia%type, nr_seq_atualizacao_p pls_movimento_contabil.nr_seq_atualizacao%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, qt_movimento_p INOUT integer, nr_seq_disc_proc_p pls_discussao_proc.nr_sequencia%type default null, nr_seq_disc_mat_p pls_discussao_mat.nr_sequencia%type default null) AS $body$
DECLARE

					
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[ X ]  Objetos do dicionario [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
-------------------------------------------------------------------------------------------------------------------

Referencias:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
cd_classificacao_credito_w	varchar(255);
cd_classificacao_debito_w	varchar(255);
nr_seq_grupo_ans_w		bigint;
ie_preco_w			varchar(2);
ie_tipo_relacao_w		varchar(2);
ie_tipo_ato_w			varchar(255)	:= '1';
ie_regulamentacao_w		varchar(2);
ie_tipo_contratacao_w		varchar(2);
ie_segmentacao_w		varchar(2);
nr_seq_grupo_superior_w		bigint;
nr_seq_grupo_ans_ww		bigint;

ie_classif_grupo_w		varchar(5);
ie_classif_grupo_ww		varchar(5);

dt_referencia_w			timestamp;
nr_seq_esquema_w		bigint;
cd_conta_credito_w		varchar(20);
cd_conta_debito_w		varchar(20);
cd_historico_padrao_w		bigint;
cd_historico_estorno_w		bigint;
cd_historico_baixa_w		bigint;

nr_seq_conta_w			bigint;
ie_tipo_contrato_w		varchar(2);
ie_tipo_segurado_w		varchar(3);
ie_tipo_item_w			smallint;
nr_seq_item_conta_w		bigint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
ie_tipo_despesa_w		varchar(1);
ds_erro_w			varchar(4000);
ie_tipo_guia_w			varchar(2);
nr_seq_tipo_atendimento_w	bigint;
cd_medico_executor_w		varchar(10);
ie_regime_internacao_w		varchar(1);
nr_seq_conselho_w		bigint;
ie_ato_cooperado_w		varchar(1);
nr_seq_prestador_w		bigint;

ie_codificacao_w		varchar(2);
vl_fixo_w			varchar(30);
cd_conta_contabil_w		varchar(20);
ie_debito_credito_w		varchar(1);
nr_seq_tipo_prestador_w		bigint;
ie_tipo_prestador_w		varchar(10);

nr_seq_discussao_w		bigint;
nr_seq_disc_item_w		bigint;

nr_seq_motivo_glosa_aceita_w	bigint;
ie_desconta_prestador_w		varchar(1);
cd_classificacao_item_w		varchar(30);
ds_mascara_w			varchar(30);
qt_movimento_w			bigint	:= 0;
nr_seq_disc_proc_w		pls_discussao_proc.nr_sequencia%type;
nr_seq_disc_mat_w		pls_discussao_mat.nr_sequencia%type;
ie_tipo_arquivo_w		pls_lote_discussao.ie_tipo_arquivo%type;
ie_envio_recebimento_w		pls_lote_contestacao.ie_envio_recebimento%type;
nr_seq_plano_seg_w		pls_segurado.nr_seq_plano%type;
nr_seq_plano_conta_w		pls_conta.nr_seq_plano%type;
nr_seq_plano_w			pls_plano.nr_sequencia%type;
nr_seq_classificacao_w		pls_plano.nr_seq_classificacao%type;
ie_tipo_movimentacao_w		pls_esquema_contabil.ie_tipo_movimentacao%type;
ie_processo_w			pls_esquema_contabil.ie_processo%type;
nr_seq_congenere_w		pls_congenere.nr_sequencia%type;
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
ie_tipo_repasse_w		pls_esquema_contabil.ie_tipo_repasse%type;
ie_tipo_compartilhamento_w	pls_esquema_contabil.ie_tipo_compartilhamento%type;
dt_ref_repasse_w		timestamp;
dt_repasse_w			timestamp;
dt_fim_repasse_w		timestamp;
ie_data_tipo_segurado_w		pls_parametros.ie_data_tipo_segurado%type;

c_discussao CURSOR FOR
	SELECT	b.nr_sequencia,
		d.nr_sequencia,
		a.dt_fechamento,
		coalesce(e.ie_tipo_segurado,'B'),
		f.ie_envio_recebimento,
		d.nr_seq_plano,
		e.nr_seq_plano,
		substr(pls_obter_dados_lote_contest(f.nr_sequencia,'PC'),1,1) ie_processo,
		a.ie_tipo_arquivo,
		p.nr_seq_congenere,
		e.nr_sequencia nr_seq_segurado
	FROM pls_protocolo_conta p, pls_lote_contestacao f, pls_contestacao c, pls_contestacao_discussao b, pls_lote_discussao a, pls_conta d
LEFT OUTER JOIN pls_segurado e ON (d.nr_seq_segurado = e.nr_sequencia)
WHERE a.nr_sequencia	= b.nr_seq_lote and c.nr_sequencia	= b.nr_seq_contestacao and d.nr_sequencia	= c.nr_seq_conta and p.nr_sequencia	= d.nr_seq_protocolo  and f.nr_sequencia	= c.nr_seq_lote and a.nr_sequencia	= nr_seq_lote_disc_p;

c_itens CURSOR FOR
	SELECT	1 ie_tipo_item,
		d.nr_sequencia,
		d.nr_seq_conta_proc,
		c.cd_procedimento,
		c.ie_origem_proced,
		null,
		c.nr_seq_grupo_ans,
		c.ie_ato_cooperado,
		d.nr_seq_motivo_glosa_aceita,
		16 ie_tipo_movimentacao,
		CASE WHEN ie_data_tipo_segurado_w='A' THEN  coalesce(c.dt_procedimento, dt_referencia_w)  ELSE a.dt_mes_competencia END  dt_ref_repasse
	from	pls_discussao_proc 	d,
		pls_conta_proc		c,
		pls_conta		b,
		pls_protocolo_conta	a
	where	a.nr_sequencia		= b.nr_seq_protocolo
	and	b.nr_sequencia		= c.nr_seq_conta
	and	c.nr_sequencia		= d.nr_seq_conta_proc
	and	d.nr_seq_discussao	= nr_seq_discussao_w
	and (nr_seq_disc_proc_p = d.nr_sequencia or coalesce(nr_seq_disc_proc_p::text, '') = '')
	
union all

	SELECT	1 ie_tipo_item,
		d.nr_sequencia,
		d.nr_seq_conta_proc,
		c.cd_procedimento,
		c.ie_origem_proced,
		null,
		c.nr_seq_grupo_ans,
		c.ie_ato_cooperado,
		d.nr_seq_motivo_glosa_aceita,
		17 ie_tipo_movimentacao,
		CASE WHEN ie_data_tipo_segurado_w='A' THEN  coalesce(c.dt_procedimento, dt_referencia_w)  ELSE a.dt_mes_competencia END  dt_ref_repasse
	from	pls_discussao_proc 	d,
		pls_conta_proc		c,
		pls_conta		b,
		pls_protocolo_conta	a
	where	a.nr_sequencia		= b.nr_seq_protocolo
	and	b.nr_sequencia		= c.nr_seq_conta
	and	c.nr_sequencia		= d.nr_seq_conta_proc
	and	d.nr_seq_discussao	= nr_seq_discussao_w
	and (nr_seq_disc_proc_p = d.nr_sequencia or coalesce(nr_seq_disc_proc_p::text, '') = '')
	
union all

	select	2 ie_tipo_item,
		d.nr_sequencia,
		d.nr_seq_conta_mat,
		null,
		null,
		c.ie_tipo_despesa,
		c.nr_seq_grupo_ans,
		c.ie_ato_cooperado,
		d.nr_seq_motivo_glosa_aceita,
		16 ie_tipo_movimentacao,
		CASE WHEN ie_data_tipo_segurado_w='A' THEN  coalesce(c.dt_atendimento, dt_referencia_w)  ELSE a.dt_mes_competencia END  dt_ref_repasse
	from	pls_discussao_mat	d,
		pls_conta_mat		c,
		pls_conta		b,
		pls_protocolo_conta	a
	where	a.nr_sequencia		= b.nr_seq_protocolo
	and	b.nr_sequencia		= c.nr_seq_conta
	and	c.nr_sequencia		= d.nr_seq_conta_mat
	and	d.nr_seq_discussao	= nr_seq_discussao_w
	and (nr_seq_disc_mat_p = d.nr_sequencia or coalesce(nr_seq_disc_mat_p::text, '') = '')
	
union all

	select	2 ie_tipo_item,
		d.nr_sequencia,
		d.nr_seq_conta_mat,
		null,
		null,
		c.ie_tipo_despesa,
		c.nr_seq_grupo_ans,
		c.ie_ato_cooperado,
		d.nr_seq_motivo_glosa_aceita,
		17 ie_tipo_movimentacao,
		CASE WHEN ie_data_tipo_segurado_w='A' THEN  coalesce(c.dt_atendimento, dt_referencia_w)  ELSE a.dt_mes_competencia END  dt_ref_repasse
	from	pls_discussao_mat	d,
		pls_conta_mat		c,
		pls_conta		b,
		pls_protocolo_conta	a
	where	a.nr_sequencia		= b.nr_seq_protocolo
	and	b.nr_sequencia		= c.nr_seq_conta
	and	c.nr_sequencia		= d.nr_seq_conta_mat
	and	d.nr_seq_discussao	= nr_seq_discussao_w
	and (nr_seq_disc_mat_p = d.nr_sequencia or coalesce(nr_seq_disc_mat_p::text, '') = '');
	
c_esquema CURSOR FOR
	SELECT	a.nr_sequencia,
		a.cd_conta_credito,
		a.cd_conta_debito,
		a.cd_historico_padrao,
		a.cd_historico_estorno,
		a.cd_historico_baixa
	from	pls_esquema_contabil	a
	where	a.cd_estabelecimento	= cd_estabelecimento_p
	and	a.ie_tipo_regra		= 'DC'
	and	dt_referencia_w between a.dt_inicio_vigencia and coalesce(a.dt_fim_vigencia,dt_referencia_w)
	and	((a.ie_tipo_segurado = ie_tipo_segurado_w) or (coalesce(a.ie_tipo_segurado::text, '') = ''))
	and	((a.ie_desconta_prestador = ie_desconta_prestador_w) or (coalesce(a.ie_desconta_prestador,'A') = 'A'))
	and	((a.ie_envio_recebimento = coalesce(ie_envio_recebimento_w, a.ie_envio_recebimento)) or (coalesce(a.ie_envio_recebimento::text, '') = ''))
	and	((a.nr_seq_classif_sca = coalesce(nr_seq_classificacao_w, a.nr_seq_classif_sca)) or (coalesce(a.nr_seq_classif_sca::text, '') = ''))
	and	((a.ie_tipo_movimentacao = coalesce(ie_tipo_movimentacao_w, a.ie_tipo_movimentacao)) or (coalesce(a.ie_tipo_movimentacao::text, '') = ''))
	and	((a.ie_processo = ie_processo_w) or (coalesce(a.ie_processo::text, '') = ''))
	and	((a.ie_tipo_arquivo = ie_tipo_arquivo_w) or (coalesce(a.ie_tipo_arquivo::text, '') = ''))
	and	((a.nr_seq_congenere = nr_seq_congenere_w) or (coalesce(a.nr_seq_congenere::text, '') = ''))
	and	((ie_tipo_repasse = ie_tipo_repasse_w) or (coalesce(ie_tipo_repasse::text, '') = ''))
	and	((ie_tipo_compartilhamento = ie_tipo_compartilhamento_w) or (coalesce(ie_tipo_compartilhamento::text, '') = ''))
	order by
		coalesce(a.ie_tipo_movimentacao, ' '),
		coalesce(a.ie_tipo_segurado,' '),
		coalesce(a.ie_envio_recebimento, ' '),
		coalesce(a.ie_processo, ' '),
		coalesce(a.ie_tipo_arquivo,0),
		coalesce(a.nr_seq_classif_sca, 0),
		coalesce(a.ie_desconta_prestador, ' '),
		coalesce(a.nr_seq_congenere,0),
		coalesce(ie_tipo_compartilhamento,0),
		coalesce(ie_tipo_repasse,' '),
		coalesce(a.dt_inicio_vigencia,clock_timestamp());

c_segmentacao CURSOR FOR
	SELECT	ie_codificacao,
		vl_fixo,
		cd_conta_contabil,
		ie_debito_credito,
		ds_mascara
	from	pls_esquema_contabil_seg
	where	nr_seq_regra_esquema = nr_seq_esquema_w
	order by
		ie_debito_credito,
		nr_seq_apresentacao;


BEGIN
qt_movimento_w	:= qt_movimento_p;

select	coalesce(max(a.ie_data_tipo_segurado),'A')
into STRICT	ie_data_tipo_segurado_w
from	pls_parametros a
where	a.cd_estabelecimento = cd_estabelecimento_p;

open c_discussao;
loop
fetch c_discussao into
	nr_seq_discussao_w,
	nr_seq_conta_w,
	dt_referencia_w,
	ie_tipo_segurado_w,
	ie_envio_recebimento_w,
	nr_seq_plano_seg_w,
	nr_seq_plano_conta_w,
	ie_processo_w,
	ie_tipo_arquivo_w,
	nr_seq_congenere_w,
	nr_seq_segurado_w;
EXIT WHEN NOT FOUND; /* apply on c_discussao */
	begin
	
	if (nr_seq_plano_conta_w IS NOT NULL AND nr_seq_plano_conta_w::text <> '') then
		nr_seq_plano_w	:= nr_seq_plano_conta_w;
	else
		nr_seq_plano_w	:= nr_seq_plano_seg_w;
	end if;
	
	if (nr_seq_plano_w IS NOT NULL AND nr_seq_plano_w::text <> '') then
		select	max(a.nr_seq_classificacao),
			max(ie_preco),
			max(ie_tipo_contratacao),
			max(ie_regulamentacao)
		into STRICT	nr_seq_classificacao_w,
			ie_preco_w,
			ie_tipo_contratacao_w,
			ie_regulamentacao_w
		from	pls_plano	a
		where	a.nr_sequencia	= nr_seq_plano_w;
	end if;
	
	open c_itens;
	loop
	fetch c_itens into
		ie_tipo_item_w,
		nr_seq_disc_item_w,
		nr_seq_item_conta_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		ie_tipo_despesa_w,
		nr_seq_grupo_ans_w,
		ie_ato_cooperado_w,
		nr_seq_motivo_glosa_aceita_w,
		ie_tipo_movimentacao_w,
		dt_ref_repasse_w;
	EXIT WHEN NOT FOUND; /* apply on c_itens */
		begin
		if (nr_seq_motivo_glosa_aceita_w IS NOT NULL AND nr_seq_motivo_glosa_aceita_w::text <> '') then
			select	max(ie_desconta_prestador)
			into STRICT	ie_desconta_prestador_w
			from	pls_motivo_glosa_aceita
			where	nr_sequencia	= nr_seq_motivo_glosa_aceita_w;
		end if;
		
		nr_seq_esquema_w	:= null;
		cd_conta_credito_w	:= null;
		cd_conta_debito_w	:= null;
		cd_historico_padrao_w	:= null;
		cd_historico_estorno_w	:= null;
		cd_historico_baixa_w	:= null;
		
		SELECT * FROM pls_obter_dados_repasse(	dt_ref_repasse_w, nr_seq_segurado_w, nr_seq_congenere_w, ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w) INTO STRICT ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w;
		
		open c_esquema;
		loop
		fetch c_esquema into
			nr_seq_esquema_w,
			cd_conta_credito_w,
			cd_conta_debito_w,
			cd_historico_padrao_w,
			cd_historico_estorno_w,
			cd_historico_baixa_w;
		EXIT WHEN NOT FOUND; /* apply on c_esquema */
		end loop;
		close c_esquema;
		
		cd_classificacao_credito_w	:= null;
		cd_classificacao_debito_w	:= null;
		
		/* GRUPO ANS */


		/*
		if	(nvl(nr_seq_grupo_ans_w,0) = 0) then
			select	ie_tipo_guia,
				nr_seq_tipo_atendimento,
				cd_medico_executor,
				ie_regime_internacao
			into	ie_tipo_guia_w,
				nr_seq_tipo_atendimento_w,
				cd_medico_executor_w,
				ie_regime_internacao_w
			from	pls_conta
			where	nr_sequencia = nr_seq_conta_w;
			
			select	max(nr_seq_conselho)
			into	nr_seq_conselho_w
			from	pessoa_fisica
			where	cd_pessoa_fisica	= cd_medico_executor_w;
			
			select	pls_obter_grupo_ans(cd_procedimento_w, ie_origem_proced_w, nr_seq_conselho_w, 
				nr_seq_tipo_atendimento_w, ie_tipo_guia_w, ie_regime_internacao_w, 
				ie_tipo_despesa_w, 'G', nvl(cd_estabelecimento_p,0))
			into	nr_seq_grupo_ans_w
			from	dual;
		end if;
		*/

		
		/* 5 - Grupo ANS com base nos valores do ITAMED */

		if (coalesce(nr_seq_grupo_ans_w,0) > 0) then
			select	max(nr_seq_grupo_superior)
			into STRICT	nr_seq_grupo_superior_w
			from	ans_grupo_despesa
			where	nr_sequencia	= nr_seq_grupo_ans_w;
		end if;
		
		if (coalesce(nr_seq_grupo_superior_w,0) = 0) then
			nr_seq_grupo_ans_ww	:= nr_seq_grupo_ans_w;
		else
			nr_seq_grupo_ans_ww	:= nr_seq_grupo_superior_w;
		end if;
		
		select	max(ie_tipo_grupo_ans)
		into STRICT	nr_seq_grupo_ans_ww
		from	ans_grupo_despesa
		where	nr_sequencia	= nr_seq_grupo_ans_ww;
		
		if (nr_seq_grupo_ans_ww = 10) then /* 1 - Consultas */
			ie_classif_grupo_w	:= '1';
			ie_classif_grupo_ww	:= '0';
		elsif (nr_seq_grupo_ans_ww = 20) then /* 49 - Exames */
			ie_classif_grupo_w	:= '2';
			ie_classif_grupo_ww	:= '0';
		elsif (nr_seq_grupo_ans_ww = 30) then /* 51 - Terapias */
			ie_classif_grupo_w	:= '3';
			ie_classif_grupo_ww	:= '0';
		elsif (nr_seq_grupo_ans_ww = 41) then /* 7 - Internacao - Honorario medico */
			ie_classif_grupo_w	:= '4';
			ie_classif_grupo_ww	:= '1';
		elsif (nr_seq_grupo_ans_ww = 42) then /* 8 - Internacao - Exames */
			ie_classif_grupo_w	:= '4';
			ie_classif_grupo_ww	:= '2';
		elsif (nr_seq_grupo_ans_ww = 43) then /* 9 - Internacao - Terapias*/
			ie_classif_grupo_w	:= '4';
			ie_classif_grupo_ww	:= '3';
		elsif (nr_seq_grupo_ans_ww = 44) then /* 10 - Internacao - Materiais medicos */
			ie_classif_grupo_w	:= '4';
			ie_classif_grupo_ww	:= '4';
		elsif (nr_seq_grupo_ans_ww = 45) then /* 11 - Internacao - Medicamentos */
			ie_classif_grupo_w	:= '4';
			ie_classif_grupo_ww	:= '5';
		elsif (nr_seq_grupo_ans_ww = 49) then /* 12 - Internacao - Outras despesas */
			ie_classif_grupo_w	:= '4';
			ie_classif_grupo_ww	:= '9';
		elsif (nr_seq_grupo_ans_ww = 50) then /* 6 - Outros atendimentos - Ambulatoriais */
			ie_classif_grupo_w	:= '5';
			ie_classif_grupo_ww	:= '0';
		elsif (nr_seq_grupo_ans_ww = 60) then /* 16 - Demais despesas assistenciais */
			ie_classif_grupo_w	:= '6';
			ie_classif_grupo_ww	:= '0';
		end if;
		/* FIM GRUPO ANS */

		
		cd_conta_debito_w	:= null;
		cd_conta_credito_w	:= null;
		
		open c_segmentacao;
		loop
		fetch c_segmentacao into	
			ie_codificacao_w,
			vl_fixo_w,
			cd_conta_contabil_w,
			ie_debito_credito_w,
			ds_mascara_w;
		EXIT WHEN NOT FOUND; /* apply on c_segmentacao */
			begin
			cd_classificacao_item_w	:= null;
			
			if (ie_debito_credito_w = 'C') then /* Classificacao CReDITO */
				if (ie_codificacao_w = 'CR') then /* Codigo reduzido */
					select	cd_classificacao
					into STRICT	cd_classificacao_credito_w
					from	conta_contabil
					where	cd_conta_contabil	= cd_conta_contabil_w;
					
					cd_conta_credito_w	:= cd_conta_contabil_w;
				elsif (ie_codificacao_w = 'FX') then /* Fixo */
					cd_classificacao_item_w	:= vl_fixo_w;
				elsif (ie_codificacao_w = 'FP') then /* Formacao de Preco */
					if (ie_preco_w in ('1','2','3')) then
						cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_formacao_preco(ie_preco_w);
					else
						cd_classificacao_item_w	:= 'FP';
					end if;
				elsif (ie_codificacao_w = 'TA') then /* Tipo de ato cooperado */
					if (ie_ato_cooperado_w in ('1','2','3')) then
						cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_ato_cooperado(ie_ato_cooperado_w);
					else
						cd_classificacao_item_w	:= 'TA';
					end if;
				elsif (ie_codificacao_w = 'GA') then /* Grupo ANS */
					if (ie_classif_grupo_w IS NOT NULL AND ie_classif_grupo_w::text <> '') then
						cd_classificacao_item_w	:= ie_classif_grupo_w;
					else
						cd_classificacao_item_w	:= 'GA';
					end if;
				elsif (ie_codificacao_w = 'CG') then /* Complemento grupo ANS */
					if (ie_classif_grupo_ww IS NOT NULL AND ie_classif_grupo_ww::text <> '') then
						cd_classificacao_item_w	:= ie_classif_grupo_ww;
					else
						cd_classificacao_item_w	:= 'CG';
					end if;
				elsif (ie_codificacao_w = 'RC') then /* Tipo de contratacao / Regulamentacao */
					cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_contratacao_regulamentacao(ie_tipo_contratacao_w,ie_regulamentacao_w);
				elsif (ie_codificacao_w = 'CD') then
					if (ie_tipo_item_w = 1) then
						if (coalesce(ie_tipo_movimentacao_w,16) = 16) then
							select	cd_classif_glosa_deb,
								cd_conta_glosa_deb
							into STRICT	cd_classificacao_credito_w,
								cd_conta_credito_w
							from	pls_conta_proc a
							where	a.nr_sequencia	= nr_seq_item_conta_w;
						elsif (coalesce(ie_tipo_movimentacao_w,16) = 17) then
							select	cd_classif_deb,
								cd_conta_deb
							into STRICT	cd_classificacao_credito_w,
								cd_conta_credito_w
							from	pls_conta_proc a
							where	a.nr_sequencia	= nr_seq_item_conta_w;						
						end if;
							
					elsif (ie_tipo_item_w = 2) then
						if (coalesce(ie_tipo_movimentacao_w,16) = 16) then
							select	cd_classif_glosa_deb,
								cd_conta_glosa_deb
							into STRICT	cd_classificacao_credito_w,
								cd_conta_credito_w
							from	pls_conta_mat a
							where	a.nr_sequencia	= nr_seq_item_conta_w;
						elsif (coalesce(ie_tipo_movimentacao_w,16) = 17) then
							select	cd_classif_deb,
								cd_conta_deb
							into STRICT	cd_classificacao_credito_w,
								cd_conta_credito_w
							from	pls_conta_mat a
							where	a.nr_sequencia	= nr_seq_item_conta_w;						
						end if;
					end if;
				elsif (ie_codificacao_w = 'CC') then
					if (ie_tipo_item_w = 1) then
						if (coalesce(ie_tipo_movimentacao_w,16) = 16) then
							select	cd_classif_glosa_cred,
								cd_conta_glosa_cred
							into STRICT	cd_classificacao_credito_w,
								cd_conta_credito_w
							from	pls_conta_proc a
							where	a.nr_sequencia	= nr_seq_item_conta_w;
						elsif (coalesce(ie_tipo_movimentacao_w,16) = 17) then
							select	cd_classif_cred,
								cd_conta_cred
							into STRICT	cd_classificacao_credito_w,
								cd_conta_credito_w
							from	pls_conta_proc a
							where	a.nr_sequencia	= nr_seq_item_conta_w;						
						end if;
						
					elsif (ie_tipo_item_w = 2) then
						if (coalesce(ie_tipo_movimentacao_w,16) = 16) then
							select	cd_classif_glosa_cred,
								cd_conta_glosa_cred
							into STRICT	cd_classificacao_credito_w,
								cd_conta_credito_w
							from	pls_conta_mat a
							where	a.nr_sequencia	= nr_seq_item_conta_w;
						elsif (coalesce(ie_tipo_movimentacao_w,16) = 17) then
							select	cd_classif_cred,
								cd_conta_cred
							into STRICT	cd_classificacao_credito_w,
								cd_conta_credito_w
							from	pls_conta_mat a
							where	a.nr_sequencia	= nr_seq_item_conta_w;						
						end if;
					end if;
				end if;
				
				if (cd_classificacao_item_w IS NOT NULL AND cd_classificacao_item_w::text <> '') then
					if (ds_mascara_w = '00') then
						cd_classificacao_item_w	:= lpad(cd_classificacao_item_w,2,'0') || '.';
					elsif (ds_mascara_w = '0.0') then
						cd_classificacao_item_w	:= substr(lpad(cd_classificacao_item_w,2,'0'),1,1) ||'.'||substr(lpad(cd_classificacao_item_w,2,'0'),2,1) || '.';
					elsif (ds_mascara_w = '0_') then
						cd_classificacao_item_w	:= cd_classificacao_item_w;
					else
						cd_classificacao_item_w	:= cd_classificacao_item_w || '.';
					end if;
					
					cd_classificacao_credito_w	:= cd_classificacao_credito_w || cd_classificacao_item_w;
				end if;
			elsif (ie_debito_credito_w = 'D') then /* Classificacao DeBITO */
				if (ie_codificacao_w = 'CR') then /* Codigo reduzido */
					select	cd_classificacao
					into STRICT	cd_classificacao_debito_w
					from	conta_contabil
					where	cd_conta_contabil	= cd_conta_contabil_w;
					
					cd_conta_debito_w	:= cd_conta_contabil_w;
				elsif (ie_codificacao_w = 'FX') then /* Fixo */
					cd_classificacao_item_w	:= vl_fixo_w;
				elsif (ie_codificacao_w = 'FP') then /* Formacao de Preco */
					if (ie_preco_w in ('1','2','3')) then
						cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_formacao_preco(ie_preco_w);
					else
						cd_classificacao_item_w	:= 'FP';
					end if;
				elsif (ie_codificacao_w = 'TA') then /* Tipo de ato cooperado */
					if (ie_ato_cooperado_w in ('1','2','3')) then
						cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_ato_cooperado(ie_ato_cooperado_w);
					else
						cd_classificacao_item_w	:= 'TA';
					end if;
				elsif (ie_codificacao_w = 'GA') then /* Grupo ANS */
					if (ie_classif_grupo_w IS NOT NULL AND ie_classif_grupo_w::text <> '') then
						cd_classificacao_item_w	:= ie_classif_grupo_w;
					else
						cd_classificacao_item_w	:= 'GA';
					end if;
				elsif (ie_codificacao_w = 'CG') then /* Complemento grupo ANS */
					if (ie_classif_grupo_ww IS NOT NULL AND ie_classif_grupo_ww::text <> '') then
						cd_classificacao_item_w	:= ie_classif_grupo_ww;
					else
						cd_classificacao_item_w	:= 'CG';
					end if;
				elsif (ie_codificacao_w = 'RC') then /* Tipo de contratacao / Regulamentacao */
					cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_contratacao_regulamentacao(ie_tipo_contratacao_w,ie_regulamentacao_w);
				elsif (ie_codificacao_w = 'CD') then
					if 	(cd_procedimento_w IS NOT NULL AND cd_procedimento_w::text <> '' AND ie_origem_proced_w IS NOT NULL AND ie_origem_proced_w::text <> '') then
						if (coalesce(ie_tipo_movimentacao_w,16) = 16) then
							select	cd_classif_glosa_deb,
								cd_conta_glosa_deb
							into STRICT	cd_classificacao_debito_w,
								cd_conta_debito_w
							from	pls_conta_proc a
							where	a.nr_sequencia	= nr_seq_item_conta_w;
						elsif (coalesce(ie_tipo_movimentacao_w,16) = 17) then
							select	cd_classif_deb,
								cd_conta_deb
							into STRICT	cd_classificacao_debito_w,
								cd_conta_debito_w
							from	pls_conta_proc a
							where	a.nr_sequencia	= nr_seq_item_conta_w;							
						end if;
							
					elsif (ie_tipo_despesa_w IS NOT NULL AND ie_tipo_despesa_w::text <> '') then
						if (coalesce(ie_tipo_movimentacao_w,16) = 16) then
							select	cd_classif_deb,
								cd_conta_deb
							into STRICT	cd_classificacao_debito_w,
								cd_conta_debito_w
							from	pls_conta_mat a
							where	a.nr_sequencia	= nr_seq_item_conta_w;
						elsif (coalesce(ie_tipo_movimentacao_w,16) = 17) then
							select	cd_classif_glosa_deb,
								cd_conta_glosa_deb
							into STRICT	cd_classificacao_debito_w,
								cd_conta_debito_w
							from	pls_conta_mat a
							where	a.nr_sequencia	= nr_seq_item_conta_w;
						end if;
					end if;
				elsif (ie_codificacao_w = 'CC') then
					if (ie_tipo_item_w = 1) then
						if (coalesce(ie_tipo_movimentacao_w,16) = 16) then
							select	cd_classif_glosa_cred,
								cd_conta_glosa_cred
							into STRICT	cd_classificacao_debito_w,
								cd_conta_debito_w
							from	pls_conta_proc a
							where	a.nr_sequencia	= nr_seq_item_conta_w;
						elsif (coalesce(ie_tipo_movimentacao_w,16) = 17) then
							select	cd_classif_cred,
								cd_conta_cred
							into STRICT	cd_classificacao_debito_w,
								cd_conta_debito_w
							from	pls_conta_proc a
							where	a.nr_sequencia	= nr_seq_item_conta_w;							
						end if;
					elsif (ie_tipo_despesa_w IS NOT NULL AND ie_tipo_despesa_w::text <> '') then
						if (coalesce(ie_tipo_movimentacao_w,16) = 16) then
							select	cd_classif_glosa_cred,
								cd_conta_glosa_cred
							into STRICT	cd_classificacao_debito_w,
								cd_conta_debito_w
							from	pls_conta_mat a
							where	a.nr_sequencia	= nr_seq_item_conta_w;
						elsif (coalesce(ie_tipo_movimentacao_w,16) = 17) then
							select	cd_classif_cred,
								cd_conta_cred
							into STRICT	cd_classificacao_debito_w,
								cd_conta_debito_w
							from	pls_conta_mat a
							where	a.nr_sequencia	= nr_seq_item_conta_w;
						end if;
					end if;
				end if;
				
				if (cd_classificacao_item_w IS NOT NULL AND cd_classificacao_item_w::text <> '') then
					if (ds_mascara_w = '00') then
						cd_classificacao_item_w	:= lpad(cd_classificacao_item_w,2,'0') || '.';
					elsif (ds_mascara_w = '0.0') then
						cd_classificacao_item_w	:= substr(lpad(cd_classificacao_item_w,2,'0'),1,1) ||'.'||substr(lpad(cd_classificacao_item_w,2,'0'),2,1) || '.';
					elsif (ds_mascara_w = '0_') then
						cd_classificacao_item_w	:= cd_classificacao_item_w;
					else
						cd_classificacao_item_w	:= cd_classificacao_item_w || '.';
					end if;
					
					cd_classificacao_debito_w	:= cd_classificacao_debito_w || cd_classificacao_item_w;
				end if;
			end if;
			end;
		end loop;
		close c_segmentacao;
		
		/* Remover o ultimo ponto da classificacao */

		if (substr(cd_classificacao_credito_w,length(cd_classificacao_credito_w),length(cd_classificacao_credito_w)) = '.') then
			cd_classificacao_credito_w	:= substr(cd_classificacao_credito_w,1,length(cd_classificacao_credito_w)-1);
		end if;
		
		if (substr(cd_classificacao_debito_w,length(cd_classificacao_debito_w),length(cd_classificacao_debito_w)) = '.') then
			cd_classificacao_debito_w	:= substr(cd_classificacao_debito_w,1,length(cd_classificacao_debito_w)-1);
		end if;

		if (coalesce(cd_conta_credito_w::text, '') = '') then
			cd_conta_credito_w	:= ctb_obter_conta_classif(cd_classificacao_credito_w,dt_referencia_w,cd_estabelecimento_p);
		end if;

		if (coalesce(cd_conta_debito_w::text, '') = '') then
			cd_conta_debito_w	:= ctb_obter_conta_classif(cd_classificacao_debito_w,dt_referencia_w,cd_estabelecimento_p);
		end if;
		
		nr_seq_disc_proc_w	:= null;
		nr_seq_disc_mat_w	:= null;
		
		if (ie_tipo_movimentacao_w = '16') then
			if (ie_tipo_item_w = 1) then
				update	pls_discussao_proc
				set	cd_conta_cred		= cd_conta_credito_w,
					cd_conta_deb		= cd_conta_debito_w,
					nr_seq_esquema		= nr_seq_esquema_w,
					cd_historico		= cd_historico_padrao_w,
					cd_classif_cred		= cd_classificacao_credito_w,
					cd_classif_deb		= cd_classificacao_debito_w
				where	nr_sequencia		= nr_seq_disc_item_w;
				
				nr_seq_disc_proc_w	:= nr_seq_disc_item_w;
			elsif (ie_tipo_item_w = 2) then
				begin
				update	pls_discussao_mat
				set	cd_conta_cred		= cd_conta_credito_w,
					cd_conta_deb		= cd_conta_debito_w,
					nr_seq_esquema		= nr_seq_esquema_w,
					cd_historico		= cd_historico_padrao_w,
					cd_classif_cred		= cd_classificacao_credito_w,
					cd_classif_deb		= cd_classificacao_debito_w
				where	nr_sequencia		= nr_seq_disc_item_w;
				exception
				when others then
					ds_erro_w	:= ds_erro_w || nr_seq_disc_item_w || ',';
				end;
				
				nr_seq_disc_mat_w	:= nr_seq_disc_item_w;
			end if;
		elsif (ie_tipo_movimentacao_w = '17') then
			if (ie_tipo_item_w = 1) then
				update	pls_discussao_proc
				set	cd_conta_negado_cred		= cd_conta_credito_w,
					cd_conta_negado_deb		= cd_conta_debito_w,
					nr_seq_esquema_negado		= nr_seq_esquema_w,
					cd_historico_negado		= cd_historico_padrao_w,
					cd_classif_negado_cred		= cd_classificacao_credito_w,
					cd_classif_negado_deb		= cd_classificacao_debito_w
				where	nr_sequencia			= nr_seq_disc_item_w;
				
				nr_seq_disc_proc_w	:= nr_seq_disc_item_w;
			elsif (ie_tipo_item_w = 2) then
				begin
				update	pls_discussao_mat
				set	cd_conta_negado_cred		= cd_conta_credito_w,
					cd_conta_negado_deb		= cd_conta_debito_w,
					nr_seq_esquema_negado		= nr_seq_esquema_w,
					cd_historico_negado		= cd_historico_padrao_w,
					cd_classif_negado_cred		= cd_classificacao_credito_w,
					cd_classif_negado_deb		= cd_classificacao_debito_w
				where	nr_sequencia			= nr_seq_disc_item_w;
				exception
				when others then
					ds_erro_w	:= ds_erro_w || nr_seq_disc_item_w || ',';
				end;
				
				nr_seq_disc_mat_w	:= nr_seq_disc_item_w;
			end if;
		end if;
		
		if (nr_seq_atualizacao_p IS NOT NULL AND nr_seq_atualizacao_p::text <> '') then
			if (coalesce(nr_seq_esquema_w::text, '') = '') then
				CALL pls_gravar_mov_contabil(nr_seq_atualizacao_p,
							1,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							nr_seq_disc_proc_w,
							nr_seq_disc_mat_w,
							null,
							nm_usuario_p,
							nr_seq_esquema_w);
			elsif	((coalesce(cd_conta_credito_w::text, '') = '') or (coalesce(cd_conta_debito_w::text, '') = '')) then
				CALL pls_gravar_mov_contabil(nr_seq_atualizacao_p,
							2,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							nr_seq_disc_proc_w,
							nr_seq_disc_mat_w,
							null,
							nm_usuario_p,
							nr_seq_esquema_w);
			end if;
		end if;
		
		qt_movimento_w	:= qt_movimento_w + 1;
		
		if (mod(qt_movimento_w,300) = 0) then
			commit;
		end if;
		end;
	end loop;
	close c_itens;
	end;
end loop;
close c_discussao;

qt_movimento_p	:= qt_movimento_w;
--commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_pls_atualizar_discussao ( nr_seq_lote_disc_p pls_lote_discussao.nr_sequencia%type, nr_seq_atualizacao_p pls_movimento_contabil.nr_seq_atualizacao%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, qt_movimento_p INOUT integer, nr_seq_disc_proc_p pls_discussao_proc.nr_sequencia%type default null, nr_seq_disc_mat_p pls_discussao_mat.nr_sequencia%type default null) FROM PUBLIC;

