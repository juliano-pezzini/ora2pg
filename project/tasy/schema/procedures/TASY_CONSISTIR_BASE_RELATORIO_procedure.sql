-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_consistir_base_relatorio () AS $body$
DECLARE


table_name_w		varchar(30);
column_name_w		varchar(30);
data_type_w		varchar(106);
data_precision_w	bigint;
data_scale_w		bigint;
qt_atributo_w		bigint;
ds_comando_w		varchar(1000);
nullable_w		varchar(10)   := '';
data_length_w		bigint;

c01 CURSOR FOR
	SELECT	distinct table_name
	from	user_tab_columns
	where	table_name in ('W_RELATORIO', 'W_BANDA_RELATORIO', 'W_BANDA_RELAT_CAMPO', 'W_RELATORIO_PARAMETRO', 'W_RELATORIO_FUNCAO', 'W_ETIQUETA', 'W_FUNCAO_REGRA_RELAT', 'W_RELATORIO_DOCUMENTACAO', 'W_USUARIO_RELATORIO', 'W_BANDA_RELAT_CAMPO_LONGO')
	order by table_name;

c02 CURSOR FOR
	SELECT	a.column_name,
		a.data_type,
		a.data_precision,
		coalesce(a.data_scale, 0),
		CASE WHEN a.nullable='N' THEN  ' NOT NULL ' END ,
		data_length
	from	user_tab_columns a
	where	not exists (
			SELECT	1
			from	user_tab_columns b
			where	b.column_name	= a.column_name
			and	b.table_name	= substr(table_name_w, 3, length(table_name_w)))
			and	a.table_name	= table_name_w;

BEGIN
open c01;
loop
fetch c01
	into table_name_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	select	count(*)
	into STRICT	qt_atributo_w
	from	user_tab_columns a
	where	not exists (
			SELECT	1
			from	user_tab_columns b
			where	b.column_name = a.column_name
			and	b.table_name = substr(table_name_w, 3, length(table_name_w)))
			and	a.table_name = table_name_w;
	if (qt_atributo_w > 0) then

		open c02;
            	loop
               	fetch c02
                	into	column_name_w,
				data_type_w,
				data_precision_w,
                     		data_scale_w,
				nullable_w,
				data_length_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin

			if (data_type_w = 'DATE') or (data_type_w = 'LONG') then
                     		ds_comando_w := ' alter table '
						|| substr(table_name_w, 3, length(table_name_w))
						|| ' add '
						|| column_name_w
						|| ' '
						|| data_type_w
						|| nullable_w;
			elsif (data_scale_w > 0) then
				ds_comando_w := ' alter table '
						|| substr(table_name_w, 3, length(table_name_w))
						|| ' add '
						|| column_name_w
						|| ' '
						|| data_type_w
						|| '('
						|| data_precision_w
						|| ','
						|| data_scale_w
						|| ')'
						|| nullable_w;
			elsif (data_scale_w = 0) and (data_precision_w > 0) then
				ds_comando_w := ' alter table '
						|| substr(table_name_w, 3, length(table_name_w))
						|| ' add '
						|| column_name_w
						|| ' '
						|| data_type_w
						|| '('
						|| data_precision_w
						|| ')'
						|| nullable_w;
			else
				ds_comando_w := ' alter table '
						|| substr(table_name_w, 3, length(table_name_w))
						|| ' add '
						|| column_name_w
						|| ' '
						|| data_type_w
						|| '('
						|| data_length_w
						|| ')'
						|| nullable_w;
			end if;
			CALL exec_sql_dinamico('TASY', ds_comando_w);
               		end;
		end loop;
		close c02;

	CALL valida_objetos_sistema();

	end if;
	end;
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_consistir_base_relatorio () FROM PUBLIC;

