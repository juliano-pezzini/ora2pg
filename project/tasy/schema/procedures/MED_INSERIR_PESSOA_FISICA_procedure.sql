-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE med_inserir_pessoa_fisica (cd_medico_p text, nr_ficha_p bigint, nm_paciente_p text, dt_nascimento_p timestamp, ds_profissao_p text, ds_convenio_p text, ds_sexo_p text, ds_estado_civil_p text, ds_endereco_p text, ds_municipio_p text, cd_cep_p text, ds_bairro_p text, ds_estado_p text, nr_telefone_p text, cd_carteira_convenio_p text, nr_rg_p text, ds_email_p text, ds_natural_p text, ds_plano_p text, dt_ultima_consulta_p timestamp, dt_cadastro_p timestamp, ds_observacao_p text, dt_validade_carteira_p text, nm_usuario_p text) AS $body$
DECLARE


cd_pessoa_fisica_w	varchar(10);
ie_sexo_w		varchar(01);
nr_seq_cliente_w	bigint;
nr_seq_compl_w		smallint;
ds_observacao_w		varchar(2000);
nm_paciente_w		varchar(60);
cd_pessoa_tasy_w	varchar(10);


BEGIN

ie_sexo_w	:= substr(ds_sexo_p, 1, 1);

if (ie_sexo_w	<> 'M') and (ie_sexo_w	<> 'F') then
	ie_sexo_w	:= null;
end if;

select	substr(Med_Ajustar_Nome_Pac(nm_paciente_p),1,60)
into STRICT	nm_paciente_w
;

select	coalesce(max(cd_pessoa_fisica),'0')
into STRICT	cd_pessoa_tasy_w
from	pessoa_fisica
where	nm_pessoa_fisica	= nm_paciente_w
and	dt_nascimento		= dt_nascimento_p;

select	nextval('pessoa_fisica_seq')
into STRICT	cd_pessoa_fisica_w
;

if (cd_pessoa_tasy_w = '0') then
	begin

	insert	into pessoa_fisica(cd_pessoa_fisica,
		ie_tipo_pessoa,
		nm_pessoa_fisica,
		dt_atualizacao,
		nm_usuario,
		dt_nascimento,
		ie_sexo,
		ie_estado_civil,
		nr_identidade,
		ie_tipo_sangue)
	values (cd_pessoa_fisica_w,
		2, nm_paciente_w,
		clock_timestamp(),
		nm_usuario_p,
		dt_nascimento_p,
		ie_sexo_w,
		null,
		substr(nr_rg_p,1,15),
		null);

	select	coalesce(max(nr_sequencia),0) + 1
	into STRICT	nr_seq_compl_w
	from	compl_pessoa_fisica
	where	cd_pessoa_fisica	= cd_pessoa_fisica_w;

	insert	into compl_pessoa_fisica(cd_pessoa_fisica,
		nr_sequencia,
		ie_tipo_complemento,
		dt_atualizacao,
		nm_usuario,
		ds_endereco,
		cd_cep,
		ds_bairro,
		ds_municipio,
		sg_estado,
		nr_telefone,
		ds_email)
	values (cd_pessoa_fisica_w,
		nr_seq_compl_w,
		1, clock_timestamp(),
		nm_usuario_p,
		substr(ds_endereco_p,1,100),
		substr(cd_cep_p,1,15),
		substr(ds_bairro_p,1,40),
		substr(ds_municipio_p,1,40),
		substr(ds_estado_p,1,2),
		substr(nr_telefone_p,1,15),
		substr(ds_email_p,1,60));

	end;
end if;

select	nextval('med_cliente_seq')
into STRICT	nr_seq_cliente_w
;

ds_observacao_w	:= 	wheb_mensagem_pck.get_texto(800105) || ': ' || ds_observacao_p || chr(10) || ' - ' ||
			wheb_mensagem_pck.get_texto(802056) || ': ' || ds_convenio_p || chr(10) || ' - ' ||
			wheb_mensagem_pck.get_texto(802573) || ': ' || ds_estado_civil_p || chr(10) || ' - ' ||
			wheb_mensagem_pck.get_texto(791347) || ': ' || ds_plano_p || chr(10) || ' - ' ||
			wheb_mensagem_pck.get_texto(802574) || ': ' || dt_validade_carteira_p;


if (cd_pessoa_tasy_w <> '0') then
	cd_pessoa_fisica_w	:= cd_pessoa_tasy_w;
end if;

insert	into med_cliente(nr_sequencia,
	cd_medico,
	cd_pessoa_fisica,
	dt_atualizacao,
	nm_usuario,
	ie_situacao,
	dt_primeira_consulta,
	dt_ultima_consulta,
	cd_pessoa_sist_orig,
	cd_convenio,
	cd_usuario_convenio,
	nr_seq_plano,
	ds_observacao,
	ie_gemelar,
	ie_pais_separados)
values (nr_seq_cliente_w,
	cd_medico_p,
	cd_pessoa_fisica_w,
	clock_timestamp(),
	nm_usuario_p,
	'A',
	dt_cadastro_p,
	dt_ultima_consulta_p,
	nr_ficha_p,
	null,
	cd_carteira_convenio_p,
	null,
	ds_observacao_w, 'N', 'N');


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE med_inserir_pessoa_fisica (cd_medico_p text, nr_ficha_p bigint, nm_paciente_p text, dt_nascimento_p timestamp, ds_profissao_p text, ds_convenio_p text, ds_sexo_p text, ds_estado_civil_p text, ds_endereco_p text, ds_municipio_p text, cd_cep_p text, ds_bairro_p text, ds_estado_p text, nr_telefone_p text, cd_carteira_convenio_p text, nr_rg_p text, ds_email_p text, ds_natural_p text, ds_plano_p text, dt_ultima_consulta_p timestamp, dt_cadastro_p timestamp, ds_observacao_p text, dt_validade_carteira_p text, nm_usuario_p text) FROM PUBLIC;

