-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baixar_horarios_cancel_exame ( nr_prescricao_p bigint, nr_seq_procedimento_p bigint, nm_usuario_p text, ds_justificativa_p text, ds_observacao_p text) AS $body$
DECLARE

 
nr_seq_horario_w		bigint;
dt_horario_w			timestamp;
cd_procedimento_w		procedimento.cd_procedimento%type;
nr_seq_proc_interno_w		bigint;
nr_seq_alteracao_w		bigint;
nr_atendimento_w		bigint;
ie_tipo_item_w			varchar(10);

c01 CURSOR FOR 
SELECT	nr_sequencia, 
	dt_horario, 
	cd_procedimento, 
	nr_seq_proc_interno 
from	prescr_proc_hor 
where	nr_prescricao		= nr_prescricao_p 
and	nr_seq_procedimento 	= nr_seq_procedimento_p 
and	coalesce(dt_fim_horario::text, '') = '' 
and	coalesce(dt_suspensao::text, '') = '';
			

BEGIN 
 
select	max(nr_atendimento) 
into STRICT	nr_atendimento_w 
from	prescr_medica 
where	nr_prescricao	= nr_prescricao_p;
 
open C01;
loop 
fetch C01 into	 
	nr_seq_horario_w, 
	dt_horario_w, 
	cd_procedimento_w, 
	nr_seq_proc_interno_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
 
	UPDATE	prescr_proc_hor 
	SET	dt_suspensao		= clock_timestamp(), 
		nm_usuario_susp		= nm_usuario_p 
	WHERE	nr_sequencia		= nr_seq_horario_w 
	AND	coalesce(dt_suspensao::text, '') = '' 
	AND	coalesce(dt_fim_horario::text, '') = '';
 
	SELECT	nextval('prescr_mat_alteracao_seq') 
	INTO STRICT	nr_seq_alteracao_w 
	;
 
	INSERT	INTO	prescr_mat_alteracao(nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_prescricao, 
		nr_seq_procedimento, 
		nr_seq_horario_proc, 
		dt_alteracao, 
		cd_pessoa_fisica, 
		ie_alteracao, 
		ie_tipo_item, 
		dt_horario, 
		nr_atendimento, 
		cd_item, 
		nr_seq_proc_interno, 
		ds_observacao, 
		ds_justificativa) 
	VALUES ( 
		nr_seq_alteracao_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_prescricao_p, 
		nr_seq_procedimento_p, 
		nr_seq_horario_w, 
		dt_horario_w, 
		obter_dados_usuario_opcao(nm_usuario_p,'C'), 
		39, 
		'P', 
		dt_horario_w, 
		nr_atendimento_w, 
		cd_procedimento_w, 
		nr_seq_proc_interno_w, 
		ds_observacao_p, 
		ds_justificativa_p);
 
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baixar_horarios_cancel_exame ( nr_prescricao_p bigint, nr_seq_procedimento_p bigint, nm_usuario_p text, ds_justificativa_p text, ds_observacao_p text) FROM PUBLIC;

