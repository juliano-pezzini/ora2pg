-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_nut_orientacao_list ( nr_seq_recomendacao_p bigint, nr_atendimento_p bigint, cd_pessoa_fisica_p text, cd_setor_atendimento_p bigint, nm_usuario_p text, cd_tipo_recomendacao_p bigint, dt_inicio_p timestamp, ie_status_p text default 'S') AS $body$
DECLARE


cd_medico_resp_w bigint;
ie_sexo_w varchar(2);
dt_inicio_w timestamp;
nr_sequencia_nut_w cpoe_nut_guidance.nr_seq_nut_guidance%TYPE;


BEGIN

select cd_medico_resp
    into STRICT cd_medico_resp_w 
from atendimento_paciente 
where nr_atendimento = nr_atendimento_p;

select ie_sexo
    into STRICT ie_sexo_w
from pessoa_fisica
where cd_pessoa_fisica = cd_pessoa_fisica_p;

if (nr_seq_recomendacao_P IS NOT NULL AND nr_seq_recomendacao_P::text <> '') then
    select max(dt_inicio)
    into STRICT dt_inicio_w
    from cpoe_recomendacao
    where nr_sequencia = nr_seq_recomendacao_P;

    select max(nr_seq_nut_guidance)
    into STRICT   nr_sequencia_nut_w
    from   cpoe_nut_guidance
    where  nr_seq_recomendacao = nr_seq_recomendacao_P;
end if;

insert into nut_orientacao_list( nr_sequencia,
                                  nr_seq_recomendacao,
                                  nr_atendimento,
                                  cd_pessoa_fisica,
                                  cd_setor_atendimento,
                                  dt_atualizacao,
                                  nm_usuario,
                                  cd_tipo_recomendacao,
                                  dt_atualizacao_nrec,
                                  dt_nut_guidance,
                                  cd_nut_location,
                                  cd_medico_resp,
                                  ie_sexo,
                                  dt_orient_nut,
                                  hr_orien_nut,
                                  ie_status,
								  nr_seq_nut_guidance
                                ) values (
                                  nextval('nut_orientacao_list_seq'),
                                  nr_seq_recomendacao_P,
                                  nr_atendimento_p,
                                  cd_pessoa_fisica_p,
                                  cd_setor_atendimento_p,
                                  clock_timestamp(),
                                  nm_usuario_p,
                                  cd_tipo_recomendacao_p,
                                  clock_timestamp(),
                                  dt_inicio_p,
                                  cd_setor_atendimento_p,
                                  cd_medico_resp_w,
                                  ie_sexo_w,
                                  dt_inicio_p,
                                  case when to_char(dt_inicio_w, 'HH24:MI') = '00:00' then null else dt_inicio_w end,
                                  ie_status_p,
								  nr_sequencia_nut_w
                                );

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_nut_orientacao_list ( nr_seq_recomendacao_p bigint, nr_atendimento_p bigint, cd_pessoa_fisica_p text, cd_setor_atendimento_p bigint, nm_usuario_p text, cd_tipo_recomendacao_p bigint, dt_inicio_p timestamp, ie_status_p text default 'S') FROM PUBLIC;

