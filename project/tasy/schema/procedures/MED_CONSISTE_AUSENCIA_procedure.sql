-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE med_consiste_ausencia (nm_usuario_ausente_p text, dt_inicio_p timestamp, dt_fim_p timestamp, ds_consistencia_p INOUT text) AS $body$
DECLARE

dt_inicio_w	timestamp;
dt_fim_w	timestamp;


BEGIN

ds_consistencia_p:= '';

select	max(a.dt_agenda),
	max(coalesce(a.dt_final,a.dt_agenda + (a.nr_minuto_duracao/ 1440)))
into STRICT	dt_inicio_w,
	dt_fim_w
from	agenda_tasy a
where	((a.dt_agenda between dt_inicio_p and dt_fim_p) or
	 (a.dt_agenda + (a.nr_minuto_duracao / 1440) - (1/86400) between dt_inicio_p and dt_fim_p) or
	 ((a.dt_agenda < dt_inicio_p) and (a.dt_agenda + (a.nr_minuto_duracao / 1440) - (1/86400) > dt_fim_p))
	)
and	a.nm_usuario_agenda 	=  nm_usuario_ausente_p
and	a.ie_status 		in ('M','E');

if (dt_inicio_w IS NOT NULL AND dt_inicio_w::text <> '') then
	ds_consistencia_p := obter_texto_dic_objeto(790750, wheb_usuario_pck.get_nr_seq_idioma, 'USUARIO='||Obter_Nome_Usuario(nm_usuario_ausente_p)||
						 ';DATA_AGENDAMENTO='||to_char(trunc(dt_inicio_w),'dd/mm/yyyy')||';HORA_INICIO='|| to_char(dt_inicio_w,'hh24:mi:ss') ||';HORA_FIM='|| to_char(dt_fim_w,'hh24:mi:ss'));
						 --'O usuário '||Obter_Nome_Usuario(nm_usuario_ausente_p)|| ' possui agendamento no dia '||to_char(trunc(dt_inicio_w),'dd/mm/yyyy')||' às '|| to_char(dt_inicio_w,'hh24:mi:ss') ||
						 --' até '|| to_char(dt_fim_w,'hh24:mi:ss') ||' horas!';
else
	select	max(a.dt_agenda),
		max(coalesce(a.dt_final,a.dt_agenda + (a.nr_minuto_duracao/ 1440)))
	into STRICT	dt_inicio_w,
		dt_fim_w
	from	agenda_tasy a,
		agenda_tasy_convite b
	where	a.nr_sequencia 		= b.nr_seq_agenda
	and	b.nm_usuario_convidado	= nm_usuario_ausente_p
	and	((a.dt_agenda between dt_inicio_p and dt_fim_p) or
		 (a.dt_agenda + (a.nr_minuto_duracao / 1440) - (1/86400) between dt_inicio_p and dt_fim_p) or
		 ((a.dt_agenda < dt_inicio_p) and (a.dt_agenda + (a.nr_minuto_duracao / 1440) - (1/86400) > dt_fim_p))
		)
	and	a.ie_status 		in ('M','E');
	if (dt_inicio_w IS NOT NULL AND dt_inicio_w::text <> '') then
		ds_consistencia_p := obter_texto_dic_objeto(790750, wheb_usuario_pck.get_nr_seq_idioma, 'USUARIO='||Obter_Nome_Usuario(nm_usuario_ausente_p)||
							';DATA_AGENDAMENTO='||to_char(trunc(dt_inicio_w),'dd/mm/yyyy')||';HORA_INICIO='|| to_char(dt_inicio_w,'hh24:mi:ss') ||';HORA_FIM='|| to_char(dt_fim_w,'hh24:mi:ss'));


	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE med_consiste_ausencia (nm_usuario_ausente_p text, dt_inicio_p timestamp, dt_fim_p timestamp, ds_consistencia_p INOUT text) FROM PUBLIC;

