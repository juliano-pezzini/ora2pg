-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_validate_clin_triage ( nr_seq_doacao_p san_doacao.nr_sequencia%type, ie_get_message_p text, ie_releasable_p INOUT text, ds_message_p INOUT text ) AS $body$
DECLARE


ie_resp_questionario_w san_doacao.ie_resp_questionario%type;
ie_impedido_w varchar(1);
dt_liberacao_w san_doacao_impedimento.dt_liberacao%type;
ie_definitivo_w san_doacao_impedimento.ie_definitivo%type;
ds_message_aux_w varchar(255);


BEGIN

select coalesce(ie_resp_questionario,'N')
into STRICT ie_resp_questionario_w
from san_doacao
where nr_sequencia = nr_seq_doacao_p;


ie_releasable_p := ie_resp_questionario_w;

select CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
into STRICT ie_impedido_w
from san_questionario
where nr_seq_doacao = nr_seq_doacao_p
and 'S' = ie_impede_doacao;

if ('S' =  ie_impedido_w) then


	ie_releasable_p := 'I';

	if ('S' = ie_get_message_p) then

	    select 	max(dt_liberacao),
				max(ie_definitivo)
		into STRICT	dt_liberacao_w,
				ie_definitivo_w
		from	san_doacao_impedimento
		where	nr_seq_doacao = nr_seq_doacao_p;

		if (ie_definitivo_w = 'N' AND dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '') then
			ds_message_aux_w := substr(obter_texto_dic_objeto(342052, wheb_usuario_pck.get_nr_seq_idioma, 'dt_liberacao='||trunc(dt_liberacao_w)),1,255);
		else
			ds_message_aux_w := substr(obter_texto_tasy(342053,wheb_usuario_pck.get_nr_seq_idioma),1,255);
		end if;
		ds_message_p := substr(obter_texto_dic_objeto(342051, wheb_usuario_pck.get_nr_seq_idioma, 'periodo='||ds_message_aux_w),1,255);


	end if;

elsif ('S' = ie_get_message_p) then
	ds_message_p := substr(obter_texto_tasy(342048,wheb_usuario_pck.get_nr_seq_idioma),1,255);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_validate_clin_triage ( nr_seq_doacao_p san_doacao.nr_sequencia%type, ie_get_message_p text, ie_releasable_p INOUT text, ds_message_p INOUT text ) FROM PUBLIC;

