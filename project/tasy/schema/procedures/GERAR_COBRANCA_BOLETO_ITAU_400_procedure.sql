-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cobranca_boleto_itau_400 ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
-- ESTA PROCEDURE ESTA SENDO UTILIZADA 
-- PELO Vera Cruz Associação de Saúde 
-- wcbernardino 
 
-- Abrir os arquvios de remessa - na nossa base 
--\\192.168.0.230\UTLFILE 
					 
ds_conteudo_w			varchar(400);
nr_seq_arquivo_w		varchar(7);
nr_seq_registro_w		bigint;

/*Header*/
 
nm_empresa_w			varchar(30);
dt_geracao_w			varchar(6);	
dt_geracao_flash_w		varchar(8);	
					 
/*Detalhe - Cursor 1*/
 
ds_endereco_w			varchar(255);
nm_pagador_w			varchar(80);
ds_bairro_w			varchar(40);
ds_municipio_w			varchar(40);
nr_nosso_numero_w		varchar(8);
cd_conta_w			varchar(15);
nr_digito_agencia_w		varchar(15);
ds_cgc_cpf_w			varchar(14);
cd_carteira_w			varchar(1);
cd_cep_w			varchar(10);
cd_agencia_bancaria_w		varchar(8);
ie_digito_conta_w		varchar(2);
sg_estado_w			varchar(2);
ie_dig_nosso_numero_w		varchar(2);
ie_tipo_pessoa_w		varchar(1);
vl_titulo_w			varchar(13);
vl_titulo_flash_w		varchar(15);
nr_documento_w			bigint;
nr_titulo_w			bigint;
dt_vencimento_w			varchar(6);
dt_vencimento_flash_w		varchar(10);
dt_emissao_w			varchar(6);	
ie_tipo_inscricao_w		varchar(2);
nr_inscricao_w			varchar(15);
ie_instrucao1_w			varchar(2);
ie_instrucao2_w			varchar(2);
cd_ocorrencia_w			varchar(2);
nr_carteira_w			varchar(3);
ie_especie_w			varchar(2);
ie_aceite_w			varchar(1);
vl_juros_diario_w		varchar(13);
dt_desconto_w			varchar(6);
vl_desconto_w			varchar(13);
vl_iof_w			varchar(13);
vl_abatimento_w			varchar(13);
nm_segurado_mens_w		varchar(30);
vl_consulta_w			varchar(13);
vl_exame_w			varchar(13);
vl_total_mens_w			varchar(13);
vl_tratamento_w 		varchar(13);
nr_seq_pagador_w		varchar(10);
vl_pre_estabelecido_w		varchar(13);
ds_plano_w			varchar(30);	
dt_vencimento_mens_w		varchar(11);
dt_pag_prev_w			varchar(8);
dt_30_dias_vencimento_w		varchar(11);
ds_mensagem_1_w			varchar(255);
ds_mensagem_2_w			varchar(255);
nr_seq_mensalidade_w		bigint;
nr_seq_carteira_cobr_w		bigint;
cd_banco_w			smallint;
ds_observacao_w			varchar(4000);

/*Flash*/
 
cd_flash_w			varchar(3);
dt_referencia_w			varchar(8);
ie_tipo_registro_w		varchar(1);
ds_conteudo_col_1_w		varchar(255);
ds_conteudo_col_2_w		varchar(255);
ds_conteudo_col_3_w		varchar(255);
ds_conteudo_col_dt_w		varchar(10);
nr_linha_col_1_w		smallint;
nr_linha_col_2_w		smallint;
nr_linha_col_3_w		smallint;
dt_emissao_flash_w		varchar(8);
dt_referencia_flash_w		varchar(11);
dt_mes_referencia_w		varchar(11);
ds_endereco_emp_w		varchar(255);

/*Brancos*/
 
ds_brancos_8_w			varchar(8);
ds_brancos_294_w		varchar(294);
ds_brancos_4_w			varchar(4);
ds_brancos_21_w			varchar(21);
ds_brancos_10_w			varchar(10);
ds_brancos_393_w		varchar(393);
ds_brancos_9_w			varchar(9);
ds_brancos_31_w			varchar(31);
ds_brancos_45_w			varchar(45);
ds_brancos_82_w			varchar(82);
ds_brancos_30_w			varchar(30);

/*Contadores*/
 
i				smallint;
x				bigint;
y				bigint;
nr_loop_w			smallint;
nr_linha_w			smallint;
nr_colunas_w			bigint;
nr_seq_apres_w			bigint	:= 1;
nr_ultimo_seq_w			bigint	:= 1;
nr_ultimo_seq_ant_w		bigint	:= 1;
nr_seq_reg_arquivo_w		bigint	:= 1;

vl_bonificacao_w		varchar(13);
ds_bonificacao_w		varchar(255);
nr_carteira_tit_w		varchar(3);

nm_arquivo_w			varchar(255);
arq_texto_w			utl_file.file_type;
arq_texto_log_w			utl_file.file_type;
ds_erro_w			varchar(255);
ds_local_w			varchar(255);
ds_mensagem_w			varchar(255);
ds_zeros_4_w			varchar(4);
vl_juros_w			varchar(13);
qt_moeda_w			varchar(13);
nr_inscricao_empresa_w		varchar(14);
cd_agencia_cobradora_w		varchar(5);
nm_sacador_avalista_w		varchar(30);
ie_digito_conta_ww		varchar(1);
ds_mensagem_boleto_w		varchar(255);
ie_mensagem_boleto_w		varchar(1) := 'S';
	
C01 CURSOR FOR 
	SELECT	lpad(coalesce(c.cd_agencia_bancaria,'0'),4,'0'), 
		lpad(coalesce(e.cd_conta,'0'),5,'0'), 
		coalesce(c.ie_digito_conta,'0'), 
		a.nr_seq_carteira_cobr nr_carteira, 
		substr(e.cd_banco,1,3) cd_banco, 
		lpad(substr(pls_obter_dados_segurado(pls_obter_segurado_pagador(d.nr_seq_pagador),'C'),1,10),10,'0') nr_documento, 
		lpad(coalesce(c.nr_titulo,'0'),10,'0') nr_titulo, 
		replace(to_char(b.vl_titulo, 'fm00000000000.00'),'.',''), 
		substr(campo_mascara_virgula(b.vl_titulo),1,15), 
		to_char(coalesce(b.dt_vencimento,clock_timestamp()),'ddmmyy'), 
		to_char(coalesce(b.dt_vencimento,clock_timestamp()),'dd/mm/yyyy'), 
		to_char(coalesce(b.dt_emissao,clock_timestamp()),'ddmmyy'), 
		rpad(substr(obter_nome_pf_pj(b.cd_pessoa_fisica,b.cd_cgc),1,255),30,' ') nm_pagador, 
		rpad(substr(upper(pls_obter_end_pagador(d.nr_seq_pagador,'EN')),1,120),40,' ') ds_endereco, 
		rpad(substr(upper(pls_obter_end_pagador(d.nr_seq_pagador,'B')),1,40),12,' ') ds_bairro, 
		rpad(substr(upper(pls_obter_end_pagador(d.nr_seq_pagador,'CEP')),1,120),8,' ') cd_cep, 
		rpad(substr(upper(pls_obter_end_pagador(d.nr_seq_pagador,'CI')),1,40),15,' ') ds_cidade, 
		rpad(substr(upper(pls_obter_end_pagador(d.nr_seq_pagador,'UF')),1,2),2, ' ') ds_uf,		 
		substr(substr(obter_nosso_numero_banco(341,c.nr_titulo),5,length(obter_nosso_numero_banco(341,c.nr_titulo)) - 6),1,8) nr_nosso_numero, 
		substr(obter_nosso_numero_banco(341,c.nr_titulo),length(obter_nosso_numero_banco(341,c.nr_titulo)),1) nr_digito, 
		CASE WHEN coalesce(b.cd_cgc::text, '') = '' THEN '01'  ELSE '02' END  ie_tipo_inscricao, 
		lpad(coalesce(b.cd_cgc_cpf,'0'),15, '0') nr_inscricao, 
		lpad(substr(pls_obter_dados_segurado(pls_obter_segurado_pagador(d.nr_seq_pagador),'C'),1,1),1,'0') cd_carteira, 
		'99' ie_especie, 
		'A' ie_aceite, 
		campo_mascara_virgula(b.vl_titulo*0.0302/30.2) vl_juros_diario, 
		d.nr_sequencia, 
		to_char(add_months(coalesce(d.dt_referencia,clock_timestamp()),-1),'mon/yyyy'), 
		to_char(coalesce(b.dt_emissao,clock_timestamp()),'dd/mm/yyyy'), 
		to_char(coalesce(b.dt_emissao,clock_timestamp()),'mm/yyyy'), 
		d.nr_seq_pagador, 
		to_char(coalesce(b.dt_vencimento,clock_timestamp()),'dd/mm/yyyy'), 
		to_char(add_months(coalesce(b.dt_pagamento_previsto ,clock_timestamp()),-1),'mon/yyyy'), 
		to_char(add_months(coalesce(b.dt_vencimento,clock_timestamp()),1),'dd/mm/yyyy'), 
		rpad(coalesce(obter_instrucao_boleto(b.nr_titulo,a.cd_banco,1),' '),80, ' ') ds_mensagem_1, 
		rpad(coalesce(obter_instrucao_boleto(b.nr_titulo,a.cd_banco,2),' '),80, ' ') ds_mensagem_2, 
		lpad(' ',30,' ') nm_sacador_avalista, 
		lpad('0',13,'0') vl_desconto, 
		lpad('0',13,'0') vl_iof, 
		lpad('0',13,'0') vl_abatimento, 
		lpad(coalesce(elimina_caracteres_especiais(x.tx_juros),0),13,'0') vl_juros_diario, 
		lpad('0',13,'0') qt_moeda, 
		substr(lpad(obter_cgc_estabelecimento(cd_estabelecimento_p),14,'0'),1,14) nr_inscricao_empresa, 
		lpad(coalesce(c.cd_agencia_bancaria,'0'),5,'0') cd_agencia, 
		replace(replace(d.ds_observacao,chr(13),' '),chr(10),' ') 
	FROM banco_estabelecimento e, titulo_receber_cobr c, titulo_receber_v b, cobranca_escritural a, titulo_receber x
LEFT OUTER JOIN pls_mensalidade d ON (x.nr_seq_mensalidade = d.nr_sequencia)
WHERE x.nr_titulo       = b.nr_titulo and c.nr_titulo       = b.nr_titulo and a.nr_sequencia     = c.nr_seq_cobranca and a.nr_seq_conta_banco  = e.nr_sequencia and a.nr_sequencia     = nr_seq_cobr_escrit_p;


BEGIN 
nm_arquivo_w	:= to_char(clock_timestamp(),'ddmmyyyy') || to_char(clock_timestamp(),'hh24') || to_char(clock_timestamp(),'mi') || to_char(clock_timestamp(),'ss') || nm_usuario_p || '.rem';
 
SELECT * FROM obter_evento_utl_file(1, null, ds_local_w, ds_erro_w) INTO STRICT ds_local_w, ds_erro_w;
 
begin 
arq_texto_w := utl_file.fopen(ds_local_w,nm_arquivo_w,'W'); --arq_texto_w := utl_file.fopen('/srvfs03/FINANCEIRO/TASY/',nm_arquivo_w,'W'); 
exception
when others then 
	if (SQLSTATE = -29289) then 
		ds_erro_w := 'O acesso ao arquivo foi negado pelo sistema operacional (access_denied).';
	elsif (SQLSTATE = -29298) then 
		ds_erro_w := 'O arquivo foi aberto usando FOPEN_NCHAR, mas efetuaram-se operações de I/O usando funções nonchar comos PUTF ou GET_LINE (charsetmismatch).';
	elsif (SQLSTATE = -29291) then 
		ds_erro_w := 'Não foi possível apagar o arquivo (delete_failed).';
	elsif (SQLSTATE = -29286) then 
		ds_erro_w := 'Erro interno desconhecido no package UTL_FILE (internal_error).';
	elsif (SQLSTATE = -29282) then 
		ds_erro_w := 'O handle do arquivo não existe (invalid_filehandle).';
	elsif (SQLSTATE = -29288) then 
		ds_erro_w := 'O arquivo com o nome especificado não foi encontrado neste local (invalid_filename).';
	elsif (SQLSTATE = -29287) then 
		ds_erro_w := 'O valor de MAX_LINESIZE para FOPEN() é inválido; deveria estar na faixa de 1 a 32767 (invalid_maxlinesize).';
	elsif (SQLSTATE = -29281) then 
		ds_erro_w := 'O parâmetro open_mode na chamda FOPEN é inválido (invalid_mode).';
	elsif (SQLSTATE = -29290) then 
		ds_erro_w := 'O parâmetro ABSOLUTE_OFFSET para a chamada FSEEK() é inválido; deveria ser maior do que 0 e menor do que o número total de bytes do arquivo (invalid_offset).';
	elsif (SQLSTATE = -29283) then 
		ds_erro_w := 'O arquivo não pôde ser aberto ou operado da forma desejada - ou o caminho não foi encontrado (invalid_operation).';
	elsif (SQLSTATE = -29280) then 
		ds_erro_w := 'O caminho especificado não existe ou não está visível ao Oracle (invalid_path).';
	elsif (SQLSTATE = -29284) then 
		ds_erro_w := 'Não é possível efetuar a leitura do arquivo (read_error).';
	elsif (SQLSTATE = -29292) then 
		ds_erro_w := 'Não é possível renomear o arquivo.';
	elsif (SQLSTATE = -29285) then 
		ds_erro_w := 'Não foi possível gravar no arquivo (write_error).';
	else 
		ds_erro_w := 'Erro desconhecido no package UTL_FILE.';
	end if;
	--R aise_application_error(-20011,ds_erro_w); 
end;
 
update	cobranca_escritural 
set	ds_arquivo	= ds_local_w || nm_arquivo_w 
where	nr_sequencia	= nr_seq_cobr_escrit_p;
 
/*Brancos*/
 
select	lpad(' ',8,' '), 
	lpad(' ',9,' '), 
	lpad(' ',294,' '), 
	lpad(' ',4,' '), 
	lpad(' ',21,' '), 
	lpad(' ',10,' '), 
	lpad(' ',393,' '), 
	lpad(' ',31,' '), 
	lpad(' ',45,' '), 
	lpad(' ',82,' '), 
	lpad(' ',30,' '), 
	lpad('0',4,'0') 
into STRICT	ds_brancos_8_w, 
	ds_brancos_9_w, 
	ds_brancos_294_w, 
	ds_brancos_4_w, 
	ds_brancos_21_w, 
	ds_brancos_10_w, 
	ds_brancos_393_w, 
	ds_brancos_31_w, 
	ds_brancos_45_w, 
	ds_brancos_82_w, 
	ds_brancos_30_w, 
	ds_zeros_4_w
;
 
/*Header*/
 
select	lpad(coalesce(b.cd_conta,'0'),5,'0'), 
	lpad(coalesce(b.cd_agencia_bancaria,'0'),4,'0'), 
	coalesce(b.ie_digito_conta,'0'), 
	rpad(obter_nome_estabelecimento(cd_estabelecimento_p),30,' ') nm_empresa, 
	to_char(clock_timestamp(), 'DDMMYY'), 
	to_char(clock_timestamp(), 'dd/mm/yy') 
into STRICT	cd_conta_w, 
	cd_agencia_bancaria_w, 
	ie_digito_conta_w, 
	nm_empresa_w, 
	dt_geracao_w, 
	dt_geracao_flash_w 
from	banco_estabelecimento b, 
	cobranca_escritural a 
where	a.nr_seq_conta_banco	= b.nr_sequencia 
and	a.nr_sequencia		= nr_seq_cobr_escrit_p;
 
ds_conteudo_w	:= 	'01' || 
			'REMESSA' || 
			'01' || 
			'COBRANCA    ' || 
			cd_agencia_bancaria_w || 
			'00' || 
			cd_conta_w || 
			ie_digito_conta_w || 
			ds_brancos_8_w || 
			nm_empresa_w || 
			'341' || 
			'BANCO ITAU SA ' || 
			dt_geracao_w || 
			ds_brancos_294_w || 
			lpad(nr_seq_reg_arquivo_w,6,'0');		
 
utl_file.put_line(arq_texto_w,ds_conteudo_w|| chr(13));
utl_file.fflush(arq_texto_w);
/*Fim - Header*/
	 
 
/*Registro Detalhe*/
 
open C01;
loop 
fetch C01 into	 
	cd_agencia_bancaria_w, 
	cd_conta_w, 
	ie_digito_conta_ww, 
	nr_seq_carteira_cobr_w, 
	cd_banco_w, 
	nr_documento_w, 
	nr_titulo_w, 
	vl_titulo_w, 
	vl_titulo_flash_w, 
	dt_vencimento_w, 
	dt_vencimento_flash_w, 
	dt_emissao_w, 
	nm_pagador_w, 
	ds_endereco_w, 
	ds_bairro_w, 
	cd_cep_w, 
	ds_municipio_w, 
	sg_estado_w, 
	nr_nosso_numero_w, 
	nr_digito_agencia_w, 
	ie_tipo_inscricao_w, 
	nr_inscricao_w, 
	cd_carteira_w, 
	ie_especie_w, 
	ie_aceite_w, 
	vl_juros_diario_w, 
	nr_seq_mensalidade_w, 
	dt_emissao_flash_w, 
	dt_referencia_flash_w, 
	dt_mes_referencia_w, 
	nr_seq_pagador_w, 
	dt_vencimento_mens_w, 
	dt_pag_prev_w, 
	dt_30_dias_vencimento_w, 
	ds_mensagem_1_w, 
	ds_mensagem_2_w, 
	nm_sacador_avalista_w, 
	vl_desconto_w, 
	vl_iof_w, 
	vl_abatimento_w, 
	vl_juros_w, 
	qt_moeda_w, 
	nr_inscricao_empresa_w, 
	cd_agencia_cobradora_w, 
	ds_observacao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;
	 
	-- Busca a carteira pelo título 
	/*select	substr(max(b.cd_carteira),1,3) 
	into	nr_carteira_tit_w 
	from	banco_carteira b, 
		titulo_receber a 
	where	b.nr_sequencia = a.nr_seq_carteira_cobr 
	and	a.nr_titulo 	= nr_titulo_w; 
	 
	-- Se houver carteira do título, efetuar a troca 
	if	(nr_carteira_tit_w is not null) then 
		nr_carteira_w := nr_carteira_tit_w; 
	end if;*/
 
	 
	select	max(cd_carteira) 
	into STRICT	nr_carteira_w 
	from	banco_carteira 
	where	nr_sequencia 	= nr_seq_carteira_cobr_w 
	and	cd_banco	= cd_banco_w;
	 
	ds_conteudo_w	:=	'1' || 
				'02' || 
				nr_inscricao_empresa_w || 
				substr(lpad(cd_agencia_bancaria_w,4,'0'),1,4) || 
				'00' || 
				substr(cd_conta_w,1,5) ||				 
				ie_digito_conta_ww || 
				ds_brancos_4_w || 
				ds_zeros_4_w || 
				lpad(coalesce(nr_titulo_w,'0'),25,'0') || 
				lpad('0',8,'0') || 
				qt_moeda_w || 
				lpad(coalesce(nr_carteira_w,0),3,'0') || 
				ds_brancos_21_w || 
				'I' || 
				'01' || 
				lpad(coalesce(to_char(nr_documento_w),'0'),10,'0') || 
				dt_vencimento_w || 
				vl_titulo_w || 
				'341' || 
				cd_agencia_cobradora_w || 
				ie_especie_w || 
				ie_aceite_w || 
				dt_emissao_w || 
				'3709' || 
				vl_juros_w || 
				to_char(clock_timestamp(),'ddmmyy') || 
				vl_desconto_w || 
				vl_iof_w || 
				vl_abatimento_w || 
				ie_tipo_inscricao_w || 
				substr(nr_inscricao_w,1,14)|| 
				nm_pagador_w || 
				ds_brancos_10_w || 
				rpad(coalesce(ds_endereco_w,' '),40,' ') || 
				rpad(coalesce(ds_bairro_w,' '),12,' ') || 
				lpad(coalesce(cd_cep_w,'0'),8,'0') || 
				rpad(coalesce(ds_municipio_w,' '),15,' ') || 
				rpad(coalesce(sg_estado_w,' '),2,' ') || 
				nm_sacador_avalista_w || 
				ds_brancos_4_w || 
				'000000' || 
				'00 ' || 
				lpad(nr_seq_reg_arquivo_w,6,'0');
				 
	utl_file.put_line(arq_texto_w,ds_conteudo_w|| chr(13));
	utl_file.fflush(arq_texto_w);
	 
	/*Flash*/
 
	i		:= 1;
	x		:= 1;
	y		:= 0;
	nr_linha_w	:= 0;
	ie_tipo_registro_w	:= '7';
	 
	select	obter_dados_pf_pj(null,nr_inscricao_empresa_w,'R')	|| ', ' || 
		obter_dados_pf_pj(null,nr_inscricao_empresa_w,'NR')	|| ' ' || 
		obter_dados_pf_pj(null,nr_inscricao_empresa_w,'B')	|| ' - '|| 
		obter_dados_pf_pj(null,nr_inscricao_empresa_w,'UF') ds_endereco_emp 
	into STRICT	ds_endereco_emp_w 
	;
 
	select	rpad(coalesce(substr(c.cd_flash,1,3),'0'),3,'0') 
	into STRICT	cd_flash_w 
	FROM banco_estabelecimento c, estabelecimento b, cobranca_escritural a
LEFT OUTER JOIN banco_carteira d ON (a.nr_seq_carteira_cobr = d.nr_sequencia)
WHERE a.cd_estabelecimento	= b.cd_estabelecimento and a.nr_seq_conta_banco	= c.nr_sequencia  and a.nr_sequencia		= nr_seq_cobr_escrit_p;
	 
	ie_mensagem_boleto_w := 'S';
	 
	select	coalesce(pls_obter_informacao_boleto(nr_titulo_w,0),' ') 
	into STRICT	ds_mensagem_boleto_w 
	;
		 
	while(i <= 17) loop 
		nr_linha_col_1_w	:= nr_linha_w + 1;
		nr_linha_col_2_w	:= nr_linha_w + 2;
		nr_linha_col_3_w	:= nr_linha_w + 3;
		 
			nr_linha_w	:= nr_linha_col_3_w;
			nr_seq_reg_arquivo_w	:=	nr_seq_reg_arquivo_w + 1;
			 
			/* Cada "i" é uma linha do arquivo (flash), assim vai gravando linha por linha */
 
			if (i = 1) then 
				ds_conteudo_col_1_w	:= 	rpad(upper(nm_empresa_w),60,' ') || rpad(nr_inscricao_empresa_w,21,' ') || 
								dt_vencimento_flash_w;
				ds_conteudo_col_2_w	:= 	' ';
				ds_conteudo_col_3_w	:= 	lpad(nr_carteira_w,21,' ') || lpad('R$',8,' ') || 
								lpad(cd_agencia_bancaria_w,53,' ') || '/' || cd_conta_w ||'-'|| ie_digito_conta_w;
				 
				ds_conteudo_w		:= 	ie_tipo_registro_w || cd_flash_w || 
								lpad(nr_linha_col_1_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_1_w,1,128),' '),128,' ') || 
								lpad(nr_linha_col_2_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_2_w,1,128),' '),128,' ') || 
								lpad(nr_linha_col_3_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_3_w,1,128),' '),128,' ') || 
								lpad(nr_seq_reg_arquivo_w,6,0);
			elsif (i = 2) then 
				ds_conteudo_col_1_w	:= 	' ';	
				ds_conteudo_col_2_w	:= 	lpad(dt_geracao_flash_w,10,' ') || lpad(nr_titulo_w,18,' ') || lpad('DV',14,' ') || 
								lpad('N',11,' ') || lpad(dt_geracao_flash_w,18,' ') || 
								lpad(vl_titulo_flash_w,20,' ');
				ds_conteudo_col_3_w	:= 	' ';
				 
				ds_conteudo_w		:= 	ie_tipo_registro_w || cd_flash_w || 
								lpad(nr_linha_col_1_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_1_w,1,128),' '),128,' ') || 
								lpad(nr_linha_col_2_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_2_w,1,128),' '),128,' ') || 
								lpad(nr_linha_col_3_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_3_w,1,128),' '),128,' ') || 
								lpad(nr_seq_reg_arquivo_w,6,0);
			elsif (i = 3) then 
				ds_conteudo_col_1_w	:= 	upper(ds_endereco_emp_w);
				ds_conteudo_col_2_w	:= 	rpad('MATRICULA',13,' ') || rpad('BENEFICIARIO',33,' ') || 
								rpad('REG ANS',10,' ') || rpad('PLANO/PROD',21,' ') || rpad('DT. INSC',12,' ') || 
								rpad('VALOR',39,' ');
								 
				select	coalesce(pls_obter_informacao_boleto(nr_titulo_w,1),ds_mensagem_boleto_w), 
					CASE WHEN trim(both pls_obter_informacao_boleto(nr_titulo_w,1)) IS NULL THEN 'N'  ELSE 'S' END  
				into STRICT	ds_conteudo_col_3_w, 
					ie_mensagem_boleto_w 
				;
				 
				ds_conteudo_w		:= 	ie_tipo_registro_w || cd_flash_w || 
								lpad(nr_linha_col_1_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_1_w,1,128),' '),128,' ') || 
								lpad(nr_linha_col_2_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_2_w,1,128),' '),128,' ') || 
								lpad(nr_linha_col_3_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_3_w,1,128),' '),128,' ') || 
								lpad(nr_seq_reg_arquivo_w,6,0);
		 
				ds_conteudo_col_1_w	:= 	' ';
				ds_conteudo_col_2_w	:= 	' ';
				ds_conteudo_col_3_w	:= 	' ';
			elsif (i = 4) then 
				select	CASE WHEN ie_mensagem_boleto_w='N' THEN coalesce(pls_obter_informacao_boleto(nr_titulo_w,2),' ')  ELSE coalesce(pls_obter_informacao_boleto(nr_titulo_w,2),ds_mensagem_boleto_w) END  
				into STRICT	ds_conteudo_col_1_w 
				;
				 
				if (ds_conteudo_col_1_w = ds_mensagem_boleto_w) then 
					ie_mensagem_boleto_w := 'N';
				end if;
			 
				select	CASE WHEN ie_mensagem_boleto_w='N' THEN coalesce(pls_obter_informacao_boleto(nr_titulo_w,3),' ')  ELSE coalesce(pls_obter_informacao_boleto(nr_titulo_w,3),ds_mensagem_boleto_w) END  
				into STRICT	ds_conteudo_col_2_w 
				;
				 
				if (ds_conteudo_col_2_w = ds_mensagem_boleto_w) then 
					ie_mensagem_boleto_w := 'N';
				end if;
				 
				select	CASE WHEN ie_mensagem_boleto_w='N' THEN coalesce(pls_obter_informacao_boleto(nr_titulo_w,4),' ')  ELSE coalesce(pls_obter_informacao_boleto(nr_titulo_w,4),ds_mensagem_boleto_w) END  
				into STRICT	ds_conteudo_col_3_w 
				;
				 
				if (ds_conteudo_col_3_w = ds_mensagem_boleto_w) then 
					ie_mensagem_boleto_w := 'N';
				end if;
 
				 
				ds_conteudo_w		:= 	ie_tipo_registro_w || cd_flash_w || 
								lpad(nr_linha_col_1_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_1_w,1,128),' '),128,' ') || 
								lpad(nr_linha_col_2_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_2_w,1,128),' '),128,' ') || 
								lpad(nr_linha_col_3_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_3_w,1,128),' '),128,' ') || 
								lpad(nr_seq_reg_arquivo_w,6,0);
								 
				ds_conteudo_col_1_w	:= 	' ';	
				ds_conteudo_col_2_w	:= 	' ';
				ds_conteudo_col_3_w	:= 	' ';
			elsif (i = 5) then 
				select	CASE WHEN ie_mensagem_boleto_w='N' THEN coalesce(pls_obter_informacao_boleto(nr_titulo_w,5),' ')  ELSE coalesce(pls_obter_informacao_boleto(nr_titulo_w,5),ds_mensagem_boleto_w) END  
				into STRICT	ds_conteudo_col_1_w 
				;
			 
				if (ds_conteudo_col_1_w = ds_mensagem_boleto_w) then 
					ie_mensagem_boleto_w := 'N';
				end if;
				 
				select	CASE WHEN ie_mensagem_boleto_w='N' THEN coalesce(pls_obter_informacao_boleto(nr_titulo_w,6),' ')  ELSE coalesce(pls_obter_informacao_boleto(nr_titulo_w,6),ds_mensagem_boleto_w) END  
				into STRICT	ds_conteudo_col_2_w 
				;
				 
				if (ds_conteudo_col_2_w = ds_mensagem_boleto_w) then 
					ie_mensagem_boleto_w := 'N';
				end if;
				 
				select	CASE WHEN ie_mensagem_boleto_w='N' THEN coalesce(pls_obter_informacao_boleto(nr_titulo_w,7),' ')  ELSE coalesce(pls_obter_informacao_boleto(nr_titulo_w,7),ds_mensagem_boleto_w) END  
				into STRICT	ds_conteudo_col_3_w 
				;
				 
				if (ds_conteudo_col_3_w = ds_mensagem_boleto_w) then 
					ie_mensagem_boleto_w := 'N';
				end if;
				 
				ds_conteudo_w		:= 	ie_tipo_registro_w || cd_flash_w || 
								lpad(nr_linha_col_1_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_1_w,1,128),' '),128,' ') || 
								lpad(nr_linha_col_2_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_2_w,1,128),' '),128,' ') || 
								lpad(nr_linha_col_3_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_3_w,1,128),' '),128,' ') || 
								lpad(nr_seq_reg_arquivo_w,6,0);
								 
				ds_conteudo_col_1_w	:= 	' ';	
				ds_conteudo_col_2_w	:= 	' ';
				ds_conteudo_col_3_w	:= 	' ';
			elsif (i = 6) then 
				select	CASE WHEN ie_mensagem_boleto_w='N' THEN coalesce(pls_obter_informacao_boleto(nr_titulo_w,8),' ')  ELSE coalesce(pls_obter_informacao_boleto(nr_titulo_w,8),ds_mensagem_boleto_w) END  
				into STRICT	ds_conteudo_col_1_w 
				;
			 
				if (ds_conteudo_col_1_w = ds_mensagem_boleto_w) then 
					ie_mensagem_boleto_w := 'N';
				end if;
				 
				select	CASE WHEN ie_mensagem_boleto_w='N' THEN coalesce(pls_obter_informacao_boleto(nr_titulo_w,9),' ')  ELSE coalesce(pls_obter_informacao_boleto(nr_titulo_w,9),ds_mensagem_boleto_w) END  
				into STRICT	ds_conteudo_col_2_w 
				;
				 
				if (ds_conteudo_col_2_w = ds_mensagem_boleto_w) then 
					ie_mensagem_boleto_w := 'N';
				end if;
				 
				select	CASE WHEN ie_mensagem_boleto_w='N' THEN coalesce(pls_obter_informacao_boleto(nr_titulo_w,10),' ')  ELSE coalesce(pls_obter_informacao_boleto(nr_titulo_w,10),ds_mensagem_boleto_w) END  
				into STRICT	ds_conteudo_col_3_w 
				;
				 
				if (ds_conteudo_col_3_w = ds_mensagem_boleto_w) then 
					ie_mensagem_boleto_w := 'N';
				end if;
				 
				ds_conteudo_w		:= 	ie_tipo_registro_w || cd_flash_w || 
								lpad(nr_linha_col_1_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_1_w,1,128),' '),128,' ') || 
								lpad(nr_linha_col_2_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_2_w,1,128),' '),128,' ') || 
								lpad(nr_linha_col_3_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_3_w,1,128),' '),128,' ') || 
								lpad(nr_seq_reg_arquivo_w,6,0);
 
				ds_conteudo_col_1_w	:= 	' ';	
				ds_conteudo_col_2_w	:= 	' ';
				ds_conteudo_col_3_w	:= 	' ';
			elsif (i = 7) then 
				select	CASE WHEN ie_mensagem_boleto_w='N' THEN coalesce(pls_obter_informacao_boleto(nr_titulo_w,11),' ')  ELSE coalesce(pls_obter_informacao_boleto(nr_titulo_w,11),ds_mensagem_boleto_w) END  
				into STRICT	ds_conteudo_col_1_w 
				;
			 
				if (ds_conteudo_col_1_w = ds_mensagem_boleto_w) then 
					ie_mensagem_boleto_w := 'N';
				end if;
				 
				select	CASE WHEN ie_mensagem_boleto_w='N' THEN coalesce(pls_obter_informacao_boleto(nr_titulo_w,12),' ')  ELSE coalesce(pls_obter_informacao_boleto(nr_titulo_w,12),ds_mensagem_boleto_w) END  
				into STRICT	ds_conteudo_col_2_w 
				;
				 
				if (ds_conteudo_col_2_w = ds_mensagem_boleto_w) then 
					ie_mensagem_boleto_w := 'N';
				end if;
				 
				select	CASE WHEN ie_mensagem_boleto_w='N' THEN coalesce(pls_obter_informacao_boleto(nr_titulo_w,13),' ')  ELSE coalesce(pls_obter_informacao_boleto(nr_titulo_w,13),ds_mensagem_boleto_w) END  
				into STRICT	ds_conteudo_col_3_w 
				;
				 
				if (ds_conteudo_col_3_w = ds_mensagem_boleto_w) then 
					ie_mensagem_boleto_w := 'N';
				end if;
				 
				ds_conteudo_w		:= 	ie_tipo_registro_w || cd_flash_w || 
								lpad(nr_linha_col_1_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_1_w,1,128),' '),128,' ') || 
								lpad(nr_linha_col_2_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_2_w,1,128),' '),128,' ') || 
								lpad(nr_linha_col_3_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_3_w,1,128),' '),128,' ') || 
								lpad(nr_seq_reg_arquivo_w,6,0);
								 
				ds_conteudo_col_1_w	:= 	' ';	
				ds_conteudo_col_2_w	:= 	' ';
				ds_conteudo_col_3_w	:= 	' ';
			elsif (i = 8) then 
				select	CASE WHEN ie_mensagem_boleto_w='N' THEN coalesce(pls_obter_informacao_boleto(nr_titulo_w,14),' ')  ELSE coalesce(pls_obter_informacao_boleto(nr_titulo_w,14),ds_mensagem_boleto_w) END  
				into STRICT	ds_conteudo_col_1_w 
				;
			 
				if (ds_conteudo_col_1_w = ds_mensagem_boleto_w) then 
					ie_mensagem_boleto_w := 'N';
				end if;
				 
				select	CASE WHEN ie_mensagem_boleto_w='N' THEN coalesce(pls_obter_informacao_boleto(nr_titulo_w,15),' ')  ELSE coalesce(pls_obter_informacao_boleto(nr_titulo_w,15),ds_mensagem_boleto_w) END  
				into STRICT	ds_conteudo_col_2_w 
				;
				 
				if (ds_conteudo_col_2_w = ds_mensagem_boleto_w) then 
					ie_mensagem_boleto_w := 'N';
				end if;
				 
				select	CASE WHEN ie_mensagem_boleto_w='N' THEN coalesce(pls_obter_informacao_boleto(nr_titulo_w,16),' ')  ELSE coalesce(pls_obter_informacao_boleto(nr_titulo_w,16),ds_mensagem_boleto_w) END  
				into STRICT	ds_conteudo_col_3_w 
				;
				 
				if (ds_conteudo_col_3_w = ds_mensagem_boleto_w) then 
					ie_mensagem_boleto_w := 'N';
				end if;
			 
				ds_conteudo_w		:= 	ie_tipo_registro_w || cd_flash_w || 
								lpad(nr_linha_col_1_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_1_w,1,128),' '),128,' ') || 
								lpad(nr_linha_col_2_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_2_w,1,128),' '),128,' ') || 
								lpad(nr_linha_col_3_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_3_w,1,128),' '),128,' ') || 
								lpad(nr_seq_reg_arquivo_w,6,0);
								 
				ds_conteudo_col_1_w	:= 	' ';	
				ds_conteudo_col_2_w	:= 	' ';
				ds_conteudo_col_3_w	:= 	' ';
			elsif (i = 9) then 
				select	CASE WHEN ie_mensagem_boleto_w='N' THEN coalesce(pls_obter_informacao_boleto(nr_titulo_w,17),' ')  ELSE coalesce(pls_obter_informacao_boleto(nr_titulo_w,17),ds_mensagem_boleto_w) END  
				into STRICT	ds_conteudo_col_1_w 
				;
			 
				if (ds_conteudo_col_1_w = ds_mensagem_boleto_w) then 
					ie_mensagem_boleto_w := 'N';
				end if;
				 
				select	CASE WHEN ie_mensagem_boleto_w='N' THEN coalesce(pls_obter_informacao_boleto(nr_titulo_w,18),' ')  ELSE coalesce(pls_obter_informacao_boleto(nr_titulo_w,18),ds_mensagem_boleto_w) END  
				into STRICT	ds_conteudo_col_2_w 
				;
				 
				if (ds_conteudo_col_2_w = ds_mensagem_boleto_w) then 
					ie_mensagem_boleto_w := 'N';
				end if;
				 
				select	CASE WHEN ie_mensagem_boleto_w='N' THEN coalesce(pls_obter_informacao_boleto(nr_titulo_w,19),' ')  ELSE coalesce(pls_obter_informacao_boleto(nr_titulo_w,19),ds_mensagem_boleto_w) END  
				into STRICT	ds_conteudo_col_3_w 
				;
				 
				if (ds_conteudo_col_3_w = ds_mensagem_boleto_w) then 
					ie_mensagem_boleto_w := 'N';
				end if;
			 
				ds_conteudo_w		:= 	ie_tipo_registro_w || cd_flash_w || 
								lpad(nr_linha_col_1_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_1_w,1,128),' '),128,' ') || 
								lpad(nr_linha_col_2_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_2_w,1,128),' '),128,' ') || 
								lpad(nr_linha_col_3_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_3_w,1,128),' '),128,' ') || 
								lpad(nr_seq_reg_arquivo_w,6,0);
								 
				ds_conteudo_col_1_w	:= 	' ';	
				ds_conteudo_col_2_w	:= 	' ';
				ds_conteudo_col_3_w	:= 	' ';
			elsif (i = 10) then 
				select	CASE WHEN ie_mensagem_boleto_w='N' THEN coalesce(pls_obter_informacao_boleto(nr_titulo_w,20),' ')  ELSE coalesce(pls_obter_informacao_boleto(nr_titulo_w,20),ds_mensagem_boleto_w) END  
				into STRICT	ds_conteudo_col_1_w 
				;
			 
				if (ds_conteudo_col_1_w = ds_mensagem_boleto_w) then 
					ie_mensagem_boleto_w := 'N';
				end if;
				 
				select	CASE WHEN ie_mensagem_boleto_w='N' THEN coalesce(pls_obter_informacao_boleto(nr_titulo_w,21),' ')  ELSE coalesce(pls_obter_informacao_boleto(nr_titulo_w,21),ds_mensagem_boleto_w) END  
				into STRICT	ds_conteudo_col_2_w 
				;
				 
				if (ds_conteudo_col_2_w = ds_mensagem_boleto_w) then 
					ie_mensagem_boleto_w := 'N';
				end if;
				 
				select	CASE WHEN ie_mensagem_boleto_w='N' THEN coalesce(pls_obter_informacao_boleto(nr_titulo_w,22),' ')  ELSE coalesce(pls_obter_informacao_boleto(nr_titulo_w,22),ds_mensagem_boleto_w) END  
				into STRICT	ds_conteudo_col_3_w 
				;
			 
				ds_conteudo_w		:=	ie_tipo_registro_w || cd_flash_w || 
								lpad(nr_linha_col_1_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_1_w,1,128),' '),128,' ') || 
								lpad(nr_linha_col_2_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_2_w,1,128),' '),128,' ') || 
								lpad(nr_linha_col_3_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_3_w,1,128),' '),128,' ') || 
								lpad(nr_seq_reg_arquivo_w,6,0);
								 
				ds_conteudo_col_1_w	:= 	' ';	
				ds_conteudo_col_2_w	:= 	' ';
				ds_conteudo_col_3_w	:= 	' ';
			elsif (i > 10 and i < 16) then			 
				ds_conteudo_col_1_w	:= 	' ';
				ds_conteudo_col_2_w	:= 	' ';
				ds_conteudo_col_3_w	:= 	' ';
				 
				ds_conteudo_w		:= 	ie_tipo_registro_w || cd_flash_w || 
								lpad(nr_linha_col_1_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_1_w,1,128),' '),128,' ') || 
								lpad(nr_linha_col_2_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_2_w,1,128),' '),128,' ') || 
								lpad(nr_linha_col_3_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_3_w,1,128),' '),128,' ') || 
								lpad(nr_seq_reg_arquivo_w,6,0);
			elsif (i =16) then 
			 
				ds_conteudo_col_1_w	:= 	' ';						
				ds_conteudo_col_2_w	:= 	substr(coalesce(ds_observacao_w,' '),1,128);
				ds_conteudo_col_3_w	:= 	substr(coalesce(ds_observacao_w,' '),129,255);
		 
		 
		 
				ds_conteudo_w		:= 	ie_tipo_registro_w || cd_flash_w || 
								lpad(nr_linha_col_1_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_1_w,1,128),' '),128,' ') || 
								lpad(nr_linha_col_2_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_2_w,1,128),' '),128,' ') || 
								lpad(nr_linha_col_3_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_3_w,1,128),' '),128,' ') || 
								lpad(nr_seq_reg_arquivo_w,6,0);
				ds_conteudo_col_1_w	:= 	' ';	
				ds_conteudo_col_2_w	:= 	' ';
				ds_conteudo_col_3_w	:= 	' ';
			elsif (i = 17) then	 
				ds_conteudo_col_1_w	:=	substr(coalesce(ds_observacao_w,' '),384,255);
				 
				ds_conteudo_w		:= 	ie_tipo_registro_w || cd_flash_w || 
								lpad(nr_linha_col_1_w,2,'0') || rpad(coalesce(substr(ds_conteudo_col_1_w,1,128),' '),128,' ') || 
								rpad(' ',130,' ') || 
								rpad(' ',130,' ') || 
								lpad(nr_seq_reg_arquivo_w,6,0);
			end if;					
			 
			utl_file.put_line(arq_texto_w,ds_conteudo_w|| chr(13));
			utl_file.fflush(arq_texto_w);
		--end if;				 
					 
		i		:= i + 1;
				 
	end loop;
	/*Fim - Flash*/
 
		 
	end;
end loop;
close C01;
/*Fim - Registro Detalhe*/
 
 
/*Trailer*/
 
nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;
 
ds_conteudo_w	:= '9' || 
 
		  ds_brancos_393_w || 
		  lpad(nr_seq_reg_arquivo_w,6,'0');	
 
utl_file.put_line(arq_texto_w,ds_conteudo_w|| chr(13));
utl_file.fflush(arq_texto_w);
/*Fim - Trailer*/
	 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cobranca_boleto_itau_400 ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

