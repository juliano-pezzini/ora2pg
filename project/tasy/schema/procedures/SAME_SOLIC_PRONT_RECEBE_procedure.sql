-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE same_solic_pront_recebe ( nr_seq_lote_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text) AS $body$
DECLARE

ie_atualiza_lote_w		varchar(1);
ie_param_atualiza_lote_w	varchar(1);
nr_seq_solic_pront_w		same_solic_pront.nr_sequencia%type;
cd_setor_solic_pront_w		same_solic_pront.cd_setor_solicitante%type;
ds_parametro_w			varchar(10) := obter_valor_param_usuario(941,103,obter_perfil_ativo,nm_usuario_p,obter_estabelecimento_ativo);
cd_pessoa_pront_w		varchar(10);
nr_atendimento_w		bigint;
nr_sequencia_same_w		same_prontuario.nr_sequencia%type;
cd_pessoa_solicitante_w		same_solic_pront.cd_pessoa_solicitante%type;
cd_setor_solicitante_w		same_solic_pront.cd_setor_solicitante%type;


c01 CURSOR FOR
	SELECT	nr_sequencia
	from	same_solic_pront
	where	nr_seq_lote		= nr_seq_lote_p
	and	cd_pessoa_fisica	= cd_pessoa_fisica_p
	and	ie_status		= 'E'
	and	coalesce(dt_recebimento::text, '') = '';

C02 CURSOR FOR
	SELECT	nr_sequencia
	from	same_prontuario
	where (nr_atendimento		= nr_atendimento_w )
	and	cd_pessoa_fisica	= cd_pessoa_pront_w
	and	((ds_parametro_w = 'N') or (cd_estabelecimento = obter_estabelecimento_ativo))
	order 	by nr_atendimento;


BEGIN
ie_param_atualiza_lote_w := obter_param_usuario(941, 202, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_param_atualiza_lote_w);

OPEN C01;
	LOOP
	FETCH C01 into
		nr_seq_solic_pront_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

	begin

	update	same_solic_pront
	set	dt_recebimento		= clock_timestamp(),
		ie_status		= 'R',
		dt_recebimento_setor	= clock_timestamp(),
		nm_usuario_receb	= nm_usuario_p
	where	nr_sequencia	= nr_seq_solic_pront_w;

	select	max(a.cd_pessoa_fisica),
		coalesce(max(a.nr_atendimento),0),
		max(a.cd_pessoa_solicitante),
		max(a.cd_setor_solicitante)
	into STRICT	cd_pessoa_pront_w,
		nr_atendimento_w,
		cd_pessoa_solicitante_w,
		cd_setor_solicitante_w
	from	same_solic_pront a
	where	a.nr_sequencia = nr_seq_solic_pront_w;
	open C02;
		loop
		fetch C02 into
			nr_sequencia_same_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
				CALL Same_Gerar_Historico(	nr_sequencia_same_w,
							38,
							cd_pessoa_solicitante_w ,
							cd_setor_solicitante_w,
							nm_usuario_p );
			end;
		end loop;
		close C02;
	end;
	END LOOP;
CLOSE C01;

select	CASE WHEN count(*)=0 THEN 'S'  ELSE 'N' END
into STRICT	ie_atualiza_lote_w
from	same_solic_pront
where	nr_seq_lote = nr_seq_lote_p
and	ie_status = 'E';

if (ie_atualiza_lote_w = 'S') or (ie_param_atualiza_lote_w = 'N')then

	update  same_solic_pront_lote
	set	ie_status = 'R'
	where	nr_sequencia = nr_seq_lote_p;

end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE same_solic_pront_recebe ( nr_seq_lote_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text) FROM PUBLIC;

