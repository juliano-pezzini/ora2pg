-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_solic_compra_proj_rec ( nr_seq_proj_rec_p bigint, cd_local_estoque_p bigint, cd_centro_custo_p bigint, cd_setor_atendimento_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_item_p bigint, nr_solic_compra_p INOUT bigint) AS $body$
DECLARE


dt_entrega_solic_w			timestamp;
nr_solic_compra_w			bigint := 0;
cd_pessoa_fisica_w		varchar(10);
qt_dias_entrega_padrao_w		bigint := 0;
cd_material_w			integer;
cd_unidade_medida_w		varchar(30);
qt_material_w			double precision;
vl_unitario_w			double precision;
nr_item_w			bigint;
cd_local_estoque_w		bigint;
cd_centro_custo_w			bigint;
qt_saldo_w			bigint;
qt_reg_saldo_w			bigint;
ds_observacao_w			projeto_recurso_item.ds_observacao%type;
nr_seq_item_proj_rec_w	projeto_recurso_item.nr_sequencia%type;

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.cd_material,
	b.cd_unidade_medida_compra,
	a.qt_material,
	a.vl_unitario,
	a.ds_observacao
from	projeto_recurso_item a,
	material b
where	a.cd_material = b.cd_material
and	((coalesce(nr_seq_item_p,0) = 0) or (a.nr_sequencia = nr_seq_item_p))
and	nr_seq_proj_rec = nr_seq_proj_rec_p;


BEGIN

select	CASE WHEN cd_local_estoque_p=0 THEN null  ELSE cd_local_estoque_p END ,
	CASE WHEN cd_centro_custo_p=0 THEN null  ELSE cd_centro_custo_p END
into STRICT	cd_local_estoque_w,
	cd_centro_custo_w
;

select	cd_pessoa_fisica
into STRICT	cd_pessoa_fisica_w
from	usuario
where	nm_usuario = nm_usuario_p;

select	coalesce(qt_dias_entrega_padrao,2)
into STRICT	qt_dias_entrega_padrao_w
from	parametro_compras
where	cd_estabelecimento = cd_estabelecimento_p;

dt_entrega_solic_w  := trunc(clock_timestamp(),'dd') + qt_dias_entrega_padrao_w;

if (coalesce(cd_pessoa_fisica_w::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(266031,'NM_USUARIO=' || nm_usuario_p);
	--'Erro ao gerar solicitação de compras. O usuário ' || nm_usuario_p || ' não possui nenhuma pessoa física vinculada.'
end if;

select	count(*)
into STRICT	qt_reg_saldo_w
from	projeto_recurso_item a,
	material b
where	a.cd_material = b.cd_material
and	((coalesce(nr_seq_item_p,0) = 0) or (a.nr_sequencia = nr_seq_item_p))
and	nr_seq_proj_rec = nr_seq_proj_rec_p
and	projeto_recurso_pck.obter_saldo_proj_rec_item(nr_seq_proj_rec_p, a.cd_material, a.nr_sequencia) > 0;

if (qt_reg_saldo_w > 0) then

	if (coalesce(nr_solic_compra_p,0) > 0) then
		nr_solic_compra_w	:= nr_solic_compra_p;
	else
		begin
		select	nextval('solic_compra_seq')
		into STRICT	nr_solic_compra_w
		;

		insert into solic_compra(
			nr_solic_compra,
			cd_estabelecimento,
			dt_solicitacao_compra,
			dt_atualizacao,
			nm_usuario,
			ie_situacao,
			cd_pessoa_solicitante,
			cd_centro_custo,
			cd_local_estoque,
			cd_setor_atendimento,
			ie_aviso_chegada,
			ie_aviso_aprov_oc,
			ie_urgente,
			ie_tipo_solicitacao,
			ie_comodato,
			ie_semanal,
			nm_usuario_nrec,
			dt_atualizacao_nrec)
		values (	nr_solic_compra_w,
			cd_estabelecimento_p,
			clock_timestamp(),
			clock_timestamp(),
			nm_usuario_p,
			'A',
			cd_pessoa_fisica_w,
			cd_centro_custo_w,
			cd_local_estoque_w,
			cd_setor_atendimento_p,
			'N',
			'N',
			'N',
			'9',
			'N',
			'N',
			nm_usuario_p,
			clock_timestamp());
		end;
	end if;

	open C01;
	loop
	fetch C01 into
		nr_seq_item_proj_rec_w,
		cd_material_w,
		cd_unidade_medida_w,
		qt_material_w,
		vl_unitario_w,
		ds_observacao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		qt_saldo_w := projeto_recurso_pck.obter_saldo_proj_rec_item(nr_seq_proj_rec_p, cd_material_w, nr_seq_item_proj_rec_w);

		if (qt_saldo_w > 0) then

			select	coalesce(max(nr_item_solic_compra),0) + 1
			into STRICT	nr_item_w
			from	solic_compra_item
			where	nr_solic_compra = nr_solic_compra_w;

			insert into solic_compra_item(
				nr_solic_compra,
				nr_item_solic_compra,
				cd_material,
				cd_unidade_medida_compra,
				qt_material,
				dt_atualizacao,
				nm_usuario,
				ie_situacao,
				ds_material_direto,
				ds_observacao,
				nr_cot_compra,
				nr_item_cot_compra,
				cd_motivo_baixa,
				dt_baixa,
				dt_solic_item,
				nr_seq_aprovacao,
				dt_autorizacao,
				vl_unit_previsto,
				ie_geracao,
				qt_conv_compra_est_orig,
				qt_saldo_disp_estoque,
				nr_seq_proj_rec,
				nr_seq_item_proj_rec)
			values (nr_solic_compra_w,
				nr_item_w,
				cd_material_w,
				cd_unidade_medida_w,
				qt_saldo_w,
				clock_timestamp(),
				nm_usuario_p,
				'A',
				null,
				ds_observacao_w,
				null,
				null,
				null,
				null,
				dt_entrega_solic_w,
				null,
				null,
				vl_unitario_w,
				'S',
				obter_dados_material(cd_material_w,'QCE'),
				obter_saldo_estoque_nuvem(cd_estabelecimento_p, cd_material_w, cd_local_estoque_w, trunc(clock_timestamp(),'mm')),
				nr_seq_proj_rec_p,
				nr_seq_item_proj_rec_w);

			insert into solic_compra_item_entrega(
				nr_solic_compra,
				nr_item_solic_compra,
				nr_item_solic_compra_entr,
				qt_entrega_solicitada,
				dt_entrega_solicitada,
				dt_atualizacao,
				nm_usuario,
				ds_observacao)
			values (nr_solic_compra_w,
				nr_item_w,
				1,
				qt_saldo_w,
				dt_entrega_solic_w,
				clock_timestamp(),
				nm_usuario_p,
				null);

		end if;
		end;
	end loop;
	close C01;
else
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(274403);
end if;

commit;

nr_solic_compra_p := nr_solic_compra_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_solic_compra_proj_rec ( nr_seq_proj_rec_p bigint, cd_local_estoque_p bigint, cd_centro_custo_p bigint, cd_setor_atendimento_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_seq_item_p bigint, nr_solic_compra_p INOUT bigint) FROM PUBLIC;

