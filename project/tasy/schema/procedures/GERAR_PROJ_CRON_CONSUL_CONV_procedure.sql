-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_proj_cron_consul_conv ( dt_referencia_p timestamp, cd_convenio_p bigint) AS $body$
DECLARE

 
cd_consultor_w	bigint;
nm_consultor_w	varchar(60);
dt_dia_atual_w	timestamp;
ie_dia_atual_w	smallint;
ie_dia_w		varchar(15);
ie_dia01_w		varchar(15) 	:= '';
ie_dia02_w		varchar(15) 	:= '';
ie_dia03_w		varchar(15) 	:= '';
ie_dia04_w		varchar(15)	:= '';
ie_dia05_w		varchar(15) 	:= '';
ie_dia06_w		varchar(15) 	:= '';
ie_dia07_w		varchar(15) 	:= '';
ie_dia08_w		varchar(15) 	:= '';
ie_dia09_w		varchar(15) 	:= '';
ie_dia10_w		varchar(15) 	:= '';
ie_dia11_w		varchar(15) 	:= '';
ie_dia12_w		varchar(15) 	:= '';
ie_dia13_w		varchar(15) 	:= '';
ie_dia14_w		varchar(15) 	:= '';
ie_dia15_w		varchar(15) 	:= '';
ie_dia16_w		varchar(15) 	:= '';
ie_dia17_w		varchar(15) 	:= '';
ie_dia18_w		varchar(15) 	:= '';
ie_dia19_w		varchar(15) 	:= '';
ie_dia20_w		varchar(15) 	:= '';
ie_dia21_w		varchar(15) 	:= '';
ie_dia22_w		varchar(15) 	:= '';
ie_dia23_w		varchar(15) 	:= '';
ie_dia24_w		varchar(15) 	:= '';
ie_dia25_w		varchar(15) 	:= '';
ie_dia26_w		varchar(15) 	:= '';
ie_dia27_w		varchar(15) 	:= '';
ie_dia28_w		varchar(15) 	:= '';
ie_dia29_w		varchar(15) 	:= '';
ie_dia30_w		varchar(15) 	:= '';
ie_dia31_w		varchar(15) 	:= '';
ie_total_w		smallint	:= 0;
nr_seq_apresent_w	bigint	:= 0;
ds_cliente_w		varchar(100);
cd_cliente_w		integer;

c01 CURSOR FOR 
SELECT	a.cd_agenda cd_consultor, 
	a.ds_agenda nm_consultor 
from	agenda a 
where	a.cd_tipo_agenda = 5 
and	a.ie_situacao = 'A' 
group by 
	a.cd_agenda, 
	a.ds_agenda, 
	a.ds_complemento 
order by 
	a.ds_complemento, 
	nm_consultor;


BEGIN 
if (dt_referencia_p IS NOT NULL AND dt_referencia_p::text <> '') then 
	delete from w_relat_proj_cron_cons;
	commit;
 
	dt_dia_atual_w := trunc(dt_referencia_p,'mm');
 
	open c01;
	loop 
	fetch c01 into	cd_consultor_w, 
				nm_consultor_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin 
		while(dt_dia_atual_w <= last_day(dt_referencia_p)) loop 
			begin 
			ie_dia_atual_w := (to_char(dt_dia_atual_w,'dd'))::numeric;
			 
			select	coalesce(max(Obter_Valor_Conv_Estab(b.cd_convenio, c.cd_estabelecimento, 'CD_INTERNO')),null), 
				max(b.cd_convenio), 
				max(b.ds_convenio) 
			into STRICT	ie_dia_w, 
				cd_cliente_w, 
				ds_cliente_w 
			from	agenda		c,	 
				convenio 	b, 
				agenda_consulta	a 
			where	b.cd_convenio 	= a.cd_convenio 
			and	a.cd_agenda	= c.cd_agenda 
			and	a.cd_agenda 	= cd_consultor_w 
			and	a.cd_convenio	= cd_convenio_p 
			and	trunc(a.dt_agenda,'dd') = trunc(dt_dia_atual_w,'dd');
 
			if (ie_dia_atual_w = 1) then 
				ie_dia01_w := ie_dia_w;
			elsif (ie_dia_atual_w = 2) then 
				ie_dia02_w := ie_dia_w;
			elsif (ie_dia_atual_w = 3) then 
				ie_dia03_w := ie_dia_w;
			elsif (ie_dia_atual_w = 4) then 
				ie_dia04_w := ie_dia_w;
			elsif (ie_dia_atual_w = 5) then 
				ie_dia05_w := ie_dia_w;
			elsif (ie_dia_atual_w = 6) then 
				ie_dia06_w := ie_dia_w;
			elsif (ie_dia_atual_w = 7) then 
				ie_dia07_w := ie_dia_w;
			elsif (ie_dia_atual_w = 8) then 
				ie_dia08_w := ie_dia_w;
			elsif (ie_dia_atual_w = 9) then 
				ie_dia09_w := ie_dia_w;
			elsif (ie_dia_atual_w = 10) then 
				ie_dia10_w := ie_dia_w;
			elsif (ie_dia_atual_w = 11) then 
				ie_dia11_w := ie_dia_w;
			elsif (ie_dia_atual_w = 12) then 
				ie_dia12_w := ie_dia_w;
			elsif (ie_dia_atual_w = 13) then 
				ie_dia13_w := ie_dia_w;
			elsif (ie_dia_atual_w = 14) then 
				ie_dia14_w := ie_dia_w;
			elsif (ie_dia_atual_w = 15) then 
				ie_dia15_w := ie_dia_w;
			elsif (ie_dia_atual_w = 16) then 
				ie_dia16_w := ie_dia_w;
			elsif (ie_dia_atual_w = 17) then 
				ie_dia17_w := ie_dia_w;
			elsif (ie_dia_atual_w = 18) then 
				ie_dia18_w := ie_dia_w;
			elsif (ie_dia_atual_w = 19) then 
				ie_dia19_w := ie_dia_w;
			elsif (ie_dia_atual_w = 20) then 
				ie_dia20_w := ie_dia_w;
			elsif (ie_dia_atual_w = 21) then 
				ie_dia21_w := ie_dia_w;
			elsif (ie_dia_atual_w = 22) then 
				ie_dia22_w := ie_dia_w;
			elsif (ie_dia_atual_w = 23) then 
				ie_dia23_w := ie_dia_w;
			elsif (ie_dia_atual_w = 24) then 
				ie_dia24_w := ie_dia_w;
			elsif (ie_dia_atual_w = 25) then 
				ie_dia25_w := ie_dia_w;
			elsif (ie_dia_atual_w = 26) then 
				ie_dia26_w := ie_dia_w;
			elsif (ie_dia_atual_w = 27) then 
				ie_dia27_w := ie_dia_w;
			elsif (ie_dia_atual_w = 28) then 
				ie_dia28_w := ie_dia_w;
			elsif (ie_dia_atual_w = 29) then 
				ie_dia29_w := ie_dia_w;
			elsif (ie_dia_atual_w = 30) then 
				ie_dia30_w := ie_dia_w;
			elsif (ie_dia_atual_w = 31) then 
				ie_dia31_w := ie_dia_w;
			end if;
			if (ie_dia_w IS NOT NULL AND ie_dia_w::text <> '') then 
				ie_total_w := ie_total_w + 1;
			end if;
			dt_dia_atual_w := dt_dia_atual_w + 1;
			end;
		end loop;
 
		insert into w_relat_proj_cron_cons( 
			cd_cliente, 
			ds_cliente, 
			cd_consultor, 
			nm_consultor, 
			ie_dia01, 
			ie_dia02, 
			ie_dia03, 
			ie_dia04, 
			ie_dia05, 
			ie_dia06, 
			ie_dia07, 
			ie_dia08, 
			ie_dia09, 
			ie_dia10, 
			ie_dia11, 
			ie_dia12, 
			ie_dia13, 
			ie_dia14, 
			ie_dia15, 
			ie_dia16, 
			ie_dia17, 
			ie_dia18, 
			ie_dia19, 
			ie_dia20, 
			ie_dia21, 
			ie_dia22, 
			ie_dia23, 
			ie_dia24, 
			ie_dia25, 
			ie_dia26, 
			ie_dia27, 
			ie_dia28, 
			ie_dia29, 
			ie_dia30, 
			ie_dia31, 
			ie_total, 
			nr_seq_apresent) 
		values ( 
			cd_cliente_w, 
			ds_cliente_w, 
			cd_consultor_w, 
			nm_consultor_w, 
			ie_dia01_w, 
			ie_dia02_w, 
			ie_dia03_w, 
			ie_dia04_w, 
			ie_dia05_w, 
			ie_dia06_w, 
			ie_dia07_w, 
			ie_dia08_w, 
			ie_dia09_w, 
			ie_dia10_w, 
			ie_dia11_w, 
			ie_dia12_w, 
			ie_dia13_w, 
			ie_dia14_w, 
			ie_dia15_w, 
			ie_dia16_w, 
			ie_dia17_w, 
			ie_dia18_w, 
			ie_dia19_w, 
			ie_dia20_w, 
			ie_dia21_w, 
			ie_dia22_w, 
			ie_dia23_w, 
			ie_dia24_w, 
			ie_dia25_w, 
			ie_dia26_w, 
			ie_dia27_w, 
			ie_dia28_w, 
			ie_dia29_w, 
			ie_dia30_w, 
			ie_dia31_w, 
			to_char(ie_total_w), 
			nr_seq_apresent_w);
		commit;
		dt_dia_atual_w := trunc(dt_referencia_p,'mm');
		ie_dia01_w := '';
		ie_dia02_w := '';
		ie_dia03_w := '';
		ie_dia04_w := '';
		ie_dia05_w := '';
		ie_dia06_w := '';
		ie_dia07_w := '';
		ie_dia08_w := '';
		ie_dia09_w := '';
		ie_dia10_w := '';
		ie_dia11_w := '';
		ie_dia12_w := '';
		ie_dia13_w := '';
		ie_dia14_w := '';
		ie_dia15_w := '';
		ie_dia16_w := '';
		ie_dia17_w := '';
		ie_dia18_w := '';
		ie_dia19_w := '';
		ie_dia20_w := '';
		ie_dia21_w := '';
		ie_dia22_w := '';
		ie_dia23_w := '';
		ie_dia24_w := '';
		ie_dia25_w := '';
		ie_dia26_w := '';
		ie_dia27_w := '';
		ie_dia28_w := '';
		ie_dia29_w := '';
		ie_dia30_w := '';
		ie_dia31_w := '';
		ie_total_w := 0;
		cd_cliente_w	:= null;
		ds_cliente_w	:= '';
		nr_seq_apresent_w := nr_seq_apresent_w + 1;
		end;
	end loop;
	close c01;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_proj_cron_consul_conv ( dt_referencia_p timestamp, cd_convenio_p bigint) FROM PUBLIC;

