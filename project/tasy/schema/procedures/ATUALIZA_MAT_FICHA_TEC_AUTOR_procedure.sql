-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_mat_ficha_tec_autor (nr_seq_mat_autor_p bigint, cd_material_ficha_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


ie_fornec_ult_compra_w		varchar(15);
cd_cgc_fabricante_w		varchar(14);
nr_seq_fabric_w			material.nr_seq_fabric%type;

BEGIN

ie_fornec_ult_compra_w := obter_param_usuario(3004, 31, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_fornec_ult_compra_w);

if (coalesce(ie_fornec_ult_compra_w,'N') = 'S') then
	cd_cgc_fabricante_w := substr(obter_fornecedor_ultima_compra(cd_material_ficha_p,cd_estabelecimento_p),1,14);
else
	cd_cgc_fabricante_w := null;
end if;



select	max(nr_seq_fabric)
into STRICT	nr_seq_fabric_w
from	material
where	cd_material = cd_material_ficha_p;

update	material_autorizado
set	nm_usuario 		= nm_usuario_p,
	dt_atualizacao  	= clock_timestamp(),
	cd_material		= cd_material_ficha_p,
	nr_seq_marca		 = NULL,
	nr_seq_fabricante 	= nr_seq_fabric_w,
	cd_cgc_fabricante	= cd_cgc_fabricante_w
where	nr_sequencia		= nr_seq_mat_autor_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_mat_ficha_tec_autor (nr_seq_mat_autor_p bigint, cd_material_ficha_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

