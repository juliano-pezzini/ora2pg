-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_conta_financeira ( IE_ENTRADA_SAIDA_P text, CD_ESTABELECIMENTO_P bigint, CD_MATERIAL_P bigint, CD_PROCEDIMENTO_P bigint, IE_ORIGEM_PROCED_P bigint, CD_SETOR_ATEND_P bigint, CD_CONVENIO_P bigint, CD_CGC_p text, CD_CENTRO_CUSTO_P bigint, NR_SEQ_CONTA_FINANC_P INOUT bigint, ie_clinica_p bigint, cd_operacao_nf_p bigint, ie_tipo_pessoa_p text, ie_tipo_atendimento_p bigint, cd_categoria_convenio_p text, nr_seq_proj_recurso_p bigint, nr_seq_produto_p bigint, cd_pessoa_fisica_p text, ie_origem_tit_rec_p text, ie_origem_tit_pag_p text, nr_seq_classe_tit_rec_p bigint, nr_seq_classe_tit_pag_p bigint, cd_local_estoque_p bigint, nr_seq_trans_fin_p bigint, ie_vago2_p text, ie_vago3_p text, ie_tipo_titulo_pagar_p text, ie_tipo_titulo_receber_p text, cd_moeda_p bigint) AS $body$
DECLARE


nr_seq_conta_financ_w		bigint		:= 0;
cd_grupo_proc_w			bigint		:= 0;
cd_espec_proc_w			bigint		:= 0;
cd_area_proc_w			bigint		:= 0;
cd_grupo_w			smallint		:= 0;
cd_subgrupo_w			smallint		:= 0;	
cd_empresa_w			bigint		:= 0;	
cd_classe_w			integer		:= 0;
nr_seq_familia_w 	bigint		:= 0;	
cd_tipo_pessoa_w		smallint		:= 0;
ie_complexidade_w		varchar(2);
ie_tipo_financiamento_w		varchar(4);
nr_seq_forma_org_w		bigint;
nr_seq_grupo_w			bigint;
nr_seq_subgrupo_w		bigint;
ie_tipo_convenio_w		smallint;

/* Edgar OS 9997 - inclui o cd_procedimento e cd_material  */

C01 CURSOR FOR
SELECT	a.nr_seq_conta_financ
from	conta_financeira b,
	conta_financ_regra a
where	a.nr_seq_conta_financ				= b.cd_conta_financ
and	coalesce(a.cd_local_estoque,coalesce(cd_local_estoque_p,0))	= coalesce(cd_local_estoque_p,0)
and	coalesce(a.ie_tipo_titulo_pagar,coalesce(ie_tipo_titulo_pagar_p,'0'))	= coalesce(ie_tipo_titulo_pagar_p,'0')
and	coalesce(a.ie_tipo_titulo_receber,coalesce(ie_tipo_titulo_receber_p,'0'))	= coalesce(ie_tipo_titulo_receber_p,'0')
and	coalesce(a.nr_seq_classe_tp,coalesce(nr_seq_classe_tit_pag_p,0)) = coalesce(nr_seq_classe_tit_pag_p,0)
and	coalesce(a.nr_seq_classe_tr,coalesce(nr_seq_classe_tit_rec_p,0)) = coalesce(nr_seq_classe_tit_rec_p,0)
and	coalesce(a.ie_origem_tit_rec,coalesce(ie_origem_tit_rec_p,'0'))	= coalesce(ie_origem_tit_rec_p,'0')
and	coalesce(a.ie_origem_tit_pagar,coalesce(ie_origem_tit_pag_p,'0'))	= coalesce(ie_origem_tit_pag_p,'0')
and	coalesce(a.ie_complexidade,coalesce(ie_complexidade_w,'0'))	= coalesce(ie_complexidade_w,'0')
and	coalesce(a.ie_tipo_financiamento, coalesce(ie_tipo_financiamento_w,'0'))	= coalesce(ie_tipo_financiamento_w,'0')
and	coalesce(a.nr_seq_forma_org,coalesce(nr_seq_forma_org_w,0))	= coalesce(nr_seq_forma_org_w,0)
and	coalesce(a.nr_seq_grupo,coalesce(nr_seq_grupo_w,0))		= coalesce(nr_seq_grupo_w,0)
and	coalesce(a.nr_seq_subgrupo,coalesce(nr_seq_subgrupo_w,0))	= coalesce(nr_seq_subgrupo_w,0)
and	coalesce(a.cd_estabelecimento, cd_estabelecimento_p)		= cd_estabelecimento_p
and	a.ie_entrada_saida					= ie_entrada_saida_p
and	coalesce(a.cd_area_procedimento,cd_area_proc_w)		= coalesce(cd_area_proc_w, 0)
and	coalesce(a.cd_especialidade,cd_espec_proc_w)		= coalesce(cd_espec_proc_w, 0)
and	coalesce(a.cd_grupo_proc,cd_grupo_proc_w)			= coalesce(cd_grupo_proc_w, 0)
and	coalesce(a.cd_procedimento, coalesce(cd_procedimento_p, 0))	= coalesce(cd_procedimento_p, 0)
and	coalesce(a.ie_origem_proced, coalesce(ie_origem_proced_p, 0))	= coalesce(ie_origem_proced_p, 0)
and	coalesce(a.cd_grupo_material,cd_grupo_w) 			= coalesce(cd_grupo_w, 0)
and	coalesce(a.cd_subgrupo_material,cd_subgrupo_w) 		= coalesce(cd_subgrupo_w, 0)
and	coalesce(a.cd_classe_material,cd_classe_w) 			= coalesce(cd_classe_w, 0)
and	coalesce(a.nr_seq_familia,coalesce(nr_seq_familia_w, 0)) 		= coalesce(nr_seq_familia_w, 0)
and	coalesce(a.cd_material, coalesce(cd_material_p, 0))			= coalesce(cd_material_p, 0)
and	coalesce(a.cd_convenio, coalesce(cd_convenio_p,0))		= coalesce(cd_convenio_p,0)
and	coalesce(a.cd_cgc, coalesce(cd_cgc_p,0))			= coalesce(cd_cgc_p,0)
and	coalesce(a.cd_tipo_pessoa, coalesce(cd_tipo_pessoa_w,0))		= coalesce(cd_tipo_pessoa_w,0)
and	coalesce(a.cd_setor_atendimento, coalesce(cd_setor_atend_p,0))	= coalesce(cd_setor_atend_p,0)
and	coalesce(a.cd_centro_custo,coalesce(cd_centro_custo_p,0))		= coalesce(cd_centro_custo_p,0)
and	coalesce(a.ie_clinica, coalesce(ie_clinica_p, 0)) 			= coalesce(ie_clinica_p, 0)
and	coalesce(a.cd_operacao_nf, coalesce(cd_operacao_nf_p, 0)) 		= coalesce(cd_operacao_nf_p, 0)
and	((a.ie_faturamento = 'N') or (cd_convenio_p IS NOT NULL AND cd_convenio_p::text <> ''))
and	coalesce(a.ie_tipo_atendimento, coalesce(ie_tipo_atendimento_p, 0)) 	= coalesce(ie_tipo_atendimento_p, 0)
and	b.ie_situacao					= 'A'
and	coalesce(a.cd_categoria, coalesce(cd_categoria_convenio_p, 0))	= coalesce(cd_categoria_convenio_p, 0)
and	coalesce(a.nr_seq_proj_rec,coalesce(nr_seq_proj_recurso_p,0))	= coalesce(nr_seq_proj_recurso_p,0)
and	coalesce(a.ie_tipo_convenio,ie_tipo_convenio_w) = ie_tipo_convenio_w /* OS 178098 - 13/11/09 */
and	b.cd_empresa					= coalesce(cd_empresa_w, b.cd_empresa)
and	coalesce(a.nr_seq_produto, coalesce(nr_seq_produto_p,0))		= coalesce(nr_seq_produto_p,0)
and	coalesce(a.cd_pessoa_fisica, coalesce(cd_pessoa_fisica_p, '0'))	= coalesce(cd_pessoa_fisica_p, '0')
and	coalesce(a.ie_tipo_pessoa,coalesce(ie_tipo_pessoa_p,'0'))	= coalesce(ie_tipo_pessoa_p,'0')
and	coalesce(a.nr_seq_trans_fin, coalesce(nr_seq_trans_fin_p, 0)) = coalesce(nr_seq_trans_fin_p,0)
and	coalesce(a.cd_moeda, coalesce(cd_moeda_p, 0)) 			= coalesce(cd_moeda_p,0)
order by
	coalesce(a.cd_procedimento, 0),
	coalesce(a.ie_origem_proced, 0),
	coalesce(a.cd_area_procedimento,0),
	coalesce(a.cd_especialidade,0),
	coalesce(a.cd_grupo_proc,0),
	coalesce(a.cd_material, 0),
	coalesce(a.nr_seq_familia,0),
	coalesce(a.cd_classe_material,0),
	coalesce(a.cd_subgrupo_material,0),
	coalesce(a.cd_grupo_material,0),
  	coalesce(a.cd_convenio, 0),
	coalesce(a.ie_tipo_convenio,0),
   	coalesce(a.cd_cgc, '0'),
   	coalesce(a.cd_tipo_pessoa, 0),
	coalesce(a.ie_tipo_pessoa,'0'),
	coalesce(a.cd_setor_atendimento,0),
	coalesce(a.cd_centro_custo,0),
	coalesce(a.ie_clinica,0),
	coalesce(a.cd_operacao_nf,0),
	coalesce(a.cd_categoria, 0),
	coalesce(a.nr_seq_proj_rec,0),
	coalesce(a.nr_seq_produto, 0),
	coalesce(a.cd_pessoa_fisica, 0),
	coalesce(a.nr_seq_trans_fin, 0),
	coalesce(a.ie_tipo_titulo_pagar, '0'),
	coalesce(a.ie_tipo_titulo_receber, '0');


BEGIN



select	max(cd_empresa)
into STRICT	cd_empresa_w
from	estabelecimento
where	cd_estabelecimento	= cd_estabelecimento_p;

/* Obter Estrutura do Material */

if (cd_material_p > 0) then
	begin
	select 	cd_grupo_material,
		cd_subgrupo_material,
		cd_classe_material,
    nr_seq_familia
	into STRICT	cd_grupo_w,
		cd_subgrupo_w,
		cd_classe_w,
    nr_seq_familia_w
	from 	estrutura_material_v
	where	cd_material		= cd_material_p;
	exception
     		when others then
			cd_grupo_w			:= 0;
	end;
end if;

/* Obter Estrutura do procedimento */

if (cd_procedimento_p > 0) then
	begin

		select 	cd_grupo_proc,
			cd_especialidade,
			cd_area_procedimento
		into STRICT	cd_grupo_proc_w,
			cd_espec_proc_w,
			cd_area_proc_w
		from	Estrutura_Procedimento_V
		where	cd_procedimento 	= cd_procedimento_p
		and	ie_origem_proced	= ie_origem_proced_p;

	exception

		when others then
			cd_grupo_proc_w			:= 0;
	end;

	if (ie_origem_proced_p = 7) then
		select	max(a.ie_complexidade),
			max(a.ie_tipo_financiamento),
			max(a.nr_seq_forma_org),
			max(a.nr_seq_grupo),
			max(a.nr_seq_subgrupo)
		into STRICT	ie_complexidade_w,
			ie_tipo_financiamento_w,
			nr_seq_forma_org_w,
			nr_seq_grupo_w,
			nr_seq_subgrupo_w
		from	sus_estrutura_procedimento_v a
		where	a.cd_procedimento	= cd_procedimento_p
		and	a.ie_origem_proced	= ie_origem_proced_p;
	end if;

end if;

/* Obter Tipo Pessoa Juridica */

if (cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '') then
	select	cd_tipo_pessoa
	into STRICT	cd_tipo_pessoa_w
	from	pessoa_juridica
	where	cd_cgc	= cd_cgc_p;
end if;

select	coalesce(max(a.ie_tipo_convenio),0)
into STRICT	ie_tipo_convenio_w
from	convenio a
where	a.cd_convenio	= cd_convenio_p;

OPEN C01;
LOOP
	FETCH C01 into
		nr_seq_conta_financ_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		nr_seq_conta_financ_w	:= nr_seq_conta_financ_w;
END LOOP;
CLOSE C01;

nr_seq_conta_financ_p			:= nr_seq_conta_financ_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_conta_financeira ( IE_ENTRADA_SAIDA_P text, CD_ESTABELECIMENTO_P bigint, CD_MATERIAL_P bigint, CD_PROCEDIMENTO_P bigint, IE_ORIGEM_PROCED_P bigint, CD_SETOR_ATEND_P bigint, CD_CONVENIO_P bigint, CD_CGC_p text, CD_CENTRO_CUSTO_P bigint, NR_SEQ_CONTA_FINANC_P INOUT bigint, ie_clinica_p bigint, cd_operacao_nf_p bigint, ie_tipo_pessoa_p text, ie_tipo_atendimento_p bigint, cd_categoria_convenio_p text, nr_seq_proj_recurso_p bigint, nr_seq_produto_p bigint, cd_pessoa_fisica_p text, ie_origem_tit_rec_p text, ie_origem_tit_pag_p text, nr_seq_classe_tit_rec_p bigint, nr_seq_classe_tit_pag_p bigint, cd_local_estoque_p bigint, nr_seq_trans_fin_p bigint, ie_vago2_p text, ie_vago3_p text, ie_tipo_titulo_pagar_p text, ie_tipo_titulo_receber_p text, cd_moeda_p bigint) FROM PUBLIC;

