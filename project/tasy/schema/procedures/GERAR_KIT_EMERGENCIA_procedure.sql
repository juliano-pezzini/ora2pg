-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_kit_emergencia (nr_prescricao_p bigint, nr_seq_kit_estoque_p bigint, ie_origem_inf_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_prescr_material_w	integer;
nr_agrupamento_w		double precision;
ie_objetivo_w			varchar(1);
ie_somente_consistidos_w	varchar(1)	:= 'N';
cd_estabelecimento_w		smallint;
cd_intervalo_w			varchar(7);
hr_prim_horario_w		varchar(05);
nr_seq_reg_kit_w		bigint;
nr_seq_apresentacao_w		bigint;
cd_material_w			integer;
qt_material_w			double precision;
cd_unidade_medida_w		varchar(30);
ie_via_aplicacao_w		varchar(05);
ie_dispensavel_w		varchar(01);
cd_kit_material_w		integer;
nr_seq_componente_w		integer;
cd_fornecedor_w			varchar(14);
ie_tipo_material_w		varchar(3);
cd_convenio_ww			integer;
cd_categoria_w			varchar(10);
ie_duplica_prescr_w		varchar(1);
nr_seq_lote_fornec_w		bigint;
ie_gerado_avulso_w		varchar(1) := 'N';
ie_vinc_conv_kit_w		varchar(1);
nr_atendimento_w		atendimento_paciente.nr_atendimento%type;
ie_gerou_kit_estoque_w		varchar(1) := 'N';

c01 CURSOR FOR
	SELECT	9999 nr_seq_apresentacao,
		a.cd_material,
		a.qt_material,
		substr(obter_dados_material_estab(a.cd_material,cd_estabelecimento_w,'UMS'),1,30) cd_unidade_medida_consumo,
		d.ie_via_aplicacao,
		'N' ie_dispensavel,
		null cd_kit_material,
		null nr_seq_componente,
		'' cd_fornecedor,
		d.ie_tipo_material,
		b.cd_convenio,
		b.cd_categoria,
		'S' ie_duplica_prescr,
		nr_seq_lote_fornec,
		'N'
	from	material d,
		kit_estoque b,
		kit_estoque_comp A
	where	b.nr_sequencia 		= a.nr_seq_kit_estoque
	and 	a.cd_material		= d.cd_material
	and 	a.nr_seq_kit_estoque 	= nr_seq_kit_estoque_p
	and 	coalesce(b.dt_utilizacao::text, '') = ''
	and	coalesce(a.nr_seq_motivo_exclusao::text, '') = ''
	and 	d.ie_situacao		= 'A'
	and	b.cd_estabelecimento	= cd_estabelecimento_w;


BEGIN

begin
select	cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	prescr_medica
where	nr_prescricao	=	nr_prescricao_p;
exception
	when others then
	begin
	cd_estabelecimento_w	:= 0;
	end;
end;

select	coalesce(max(nr_agrupamento),0) + 1
into STRICT	nr_agrupamento_w
from	prescr_material
where	nr_prescricao = nr_prescricao_p;


select	coalesce(max(cd_intervalo),1)
into STRICT	cd_intervalo_w
from	intervalo_prescricao
where	ie_agora = 'S';

select	to_char(dt_primeiro_horario,'HH24:MM')
into STRICT	hr_prim_horario_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

select 	coalesce(max(nr_seq_reg_kit),0)
into STRICT	nr_seq_reg_kit_w
from	kit_estoque
where	nr_sequencia = nr_seq_kit_estoque_p;


open C01;
loop
fetch C01 into
	nr_seq_apresentacao_w,
			cd_material_w,
			qt_material_w,
			cd_unidade_medida_w,
			ie_via_aplicacao_w,
			ie_dispensavel_w,
			cd_kit_material_w,
			nr_seq_componente_w,
			cd_fornecedor_w,
			ie_tipo_material_w,
			cd_convenio_ww,
			cd_categoria_w,
			ie_duplica_prescr_w,
			nr_seq_lote_fornec_w,
			ie_gerado_avulso_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	coalesce(max(nr_sequencia),0) + 1
	into STRICT	nr_seq_prescr_material_w
	from	prescr_material
	where	nr_prescricao = nr_prescricao_p;


	select	max('P')
	into STRICT	ie_objetivo_w
	from	material
	where	cd_material = cd_material_w
	and	coalesce(ie_controle_medico,'0') <> '0';

	insert into prescr_material(nr_prescricao,
			nr_sequencia,
			ie_origem_inf,
			cd_material,
			cd_unidade_medida,
			qt_dose,
			qt_unitaria,
			qt_material,
			dt_atualizacao,
			nm_usuario,
			cd_intervalo,
			ds_horarios,
			ds_observacao,
			ie_via_aplicacao,
			nr_agrupamento,
			cd_motivo_baixa,
			dt_baixa,
			ie_utiliza_kit,
			cd_unidade_medida_dose,
			qt_conversao_dose,
			ie_urgencia,
			nr_ocorrencia,
			qt_total_dispensar,
			cd_fornec_consignado,
			nr_sequencia_solucao,
			nr_sequencia_proc,
			qt_solucao,
			hr_dose_especial,
			qt_dose_especial,
			ds_dose_diferenciada,
			ie_medicacao_paciente,
			nr_sequencia_diluicao,
			hr_prim_horario,
			nr_dia_util,
			nr_sequencia_dieta,
			ie_agrupador,
			dt_emissao_setor_atend,
			ie_suspenso,
			ds_justificativa,
			qt_dias_solicitado,
			qt_dias_liberado,
			nm_usuario_liberacao,
			dt_liberacao,
			ie_se_necessario,
			qt_min_aplicacao,
			nr_seq_lote_fornec,
			ie_status_cirurgia,
			ie_bomba_infusao,
			ie_aplic_bolus,
			ie_aplic_lenta,
			ie_acm,
			cd_kit_material,
			ie_recons_diluente_fixo,
			nr_seq_kit_estoque,
			cd_convenio,
			cd_categoria,
			ie_sem_aprazamento,
			nr_doc_interno,
			cd_local_estoque,
			nr_seq_reg_kit,
			nr_doc_interno_aux,
			ie_tipo_doc_interno,
			ie_tipo_doc_interno_aux,
			nm_usuario_original,
			nr_seq_justif_kit,
			ie_objetivo)
		values (  nr_prescricao_p,
			nr_seq_prescr_material_w,
			ie_origem_inf_p,
			cd_material_w,
			cd_unidade_medida_w,
			qt_material_w,
			qt_material_w,
			qt_material_w,
			clock_timestamp(),
			nm_usuario_p,
			cd_intervalo_w,
			null,
			'',
			ie_via_aplicacao_w,
			nr_agrupamento_w,
			0,
			null,
			'N',
			null,
			null,
			'N',
			1,
			qt_material_w,
			cd_fornecedor_w,
			null,
			null,
			null,
			null,
			null,
			null,
			'N',
			null,
			hr_prim_horario_w,
			null,
			null,
			CASE WHEN ie_tipo_material_w='1' THEN  2 WHEN ie_tipo_material_w='2' THEN  1 WHEN ie_tipo_material_w='3' THEN  1  ELSE 2 END ,
			null,
			'N',
			null,
			null,
			null,
			null,
			null,
			ie_dispensavel_w,
			null,
			nr_seq_lote_fornec_w,
			'GI',
			'N',
			'N',
			'N',
			'N',
			cd_kit_material_w,
			'N',
			nr_seq_kit_estoque_p,
			CASE WHEN cd_convenio_ww=0 THEN null  ELSE cd_convenio_ww END ,
			cd_categoria_w,
			'N',
			null,
			null,
			CASE WHEN nr_seq_reg_kit_w=0 THEN null  ELSE nr_seq_reg_kit_w END ,
			null,
			null,
			null,
			nm_usuario_p,
			null,
			ie_objetivo_w);

	ie_gerou_kit_estoque_w	:= 'S';
	end;
end loop;
close C01;

if (ie_gerou_kit_estoque_w = 'S') then

	select	max(nr_atendimento)
	into STRICT	nr_atendimento_w
	from	prescr_medica
	where	nr_prescricao 	= nr_prescricao_p;

	update	kit_estoque
	set	dt_utilizacao = clock_timestamp(),
		nm_usuario_util 	= nm_usuario_p,
		nr_prescricao	= nr_prescricao_p,
		nr_atendimento	= nr_atendimento_w
	where	nr_sequencia 	= nr_seq_kit_estoque_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_kit_emergencia (nr_prescricao_p bigint, nr_seq_kit_estoque_p bigint, ie_origem_inf_p text, nm_usuario_p text) FROM PUBLIC;

