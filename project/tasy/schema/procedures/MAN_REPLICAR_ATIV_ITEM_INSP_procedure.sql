-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_replicar_ativ_item_insp ( nr_seq_item_p bigint, nm_usuario_p text) AS $body$
DECLARE



nr_seq_plano_w			bigint;
nr_seq_item_plano_w		bigint;
nr_seq_tipo_equip_w		bigint;


/*Variáveis da atividade*/

nr_seq_insp_item_ativ_w		bigint;
nr_seq_ativ_w			bigint;
ie_situacao_ativ_w			varchar(01);
nr_seq_item_ativ_novo_w		bigint;

/*Variáveis da ação*/

nr_seq_insp_item_acao_w		bigint;
nr_seq_acao_w			bigint;
ie_situacao_acao_w		varchar(01);
nr_seq_item_acao_novo_w		bigint;

/*Variáveis do resultado*/

nr_seq_insp_item_result_w		bigint;
nr_seq_result_w			bigint;
ie_situacao_result_w		varchar(01);
nr_seq_item_result_novo_w		bigint;

C00 CURSOR FOR		/*Itens a replicar*/
SELECT	a.nr_sequencia
from	man_equipamento b,
	man_plano_insp_item a
where	not exists (	select	1
			from	man_plano_insp_item_ativ b
			where	b.nr_seq_item = a.nr_sequencia)
and	a.nr_seq_plano_inspecao = nr_seq_plano_w
and	b.nr_sequencia = a.nr_seq_equipamento
and	b.nr_seq_tipo_equip = nr_seq_tipo_equip_w
and	a.nr_sequencia <> nr_seq_item_p;

c01 CURSOR FOR		/*Atividades do item*/
SELECT	nr_sequencia,
	nr_seq_atividade,
	ie_situacao
from	man_plano_insp_item_ativ
where	nr_seq_item = nr_seq_item_p
and	ie_situacao = 'A';

c02 CURSOR FOR		/*Ações da atividade*/
SELECT	nr_sequencia,
	nr_seq_acao,
	ie_situacao
from	man_plano_insp_item_acao
where	nr_seq_ativ = nr_seq_insp_item_ativ_w
and	ie_situacao = 'A';

c03 CURSOR FOR		/*Resultados da ação*/
SELECT	nr_sequencia,
	nr_seq_result,
	ie_situacao
from	man_plano_insp_item_result
where	nr_seq_acao = nr_seq_insp_item_acao_w
and	ie_situacao = 'A';


BEGIN
select	a.nr_seq_plano_inspecao,
	b.nr_seq_tipo_equip
into STRICT	nr_seq_plano_w,
	nr_seq_tipo_equip_w
from	man_equipamento b,
	man_plano_insp_item a
where	a.nr_sequencia = nr_seq_item_p
and	b.nr_sequencia = a.nr_seq_equipamento;

open C00;
loop
fetch C00 into
	nr_seq_item_plano_w;
EXIT WHEN NOT FOUND; /* apply on C00 */
	begin
	open C01;
	loop
	fetch C01 into
		nr_seq_insp_item_ativ_w,
		nr_seq_ativ_w,
		ie_situacao_ativ_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		select	nextval('man_plano_insp_item_ativ_seq')
		into STRICT	nr_seq_item_ativ_novo_w
		;

		insert into man_plano_insp_item_ativ(
					nr_sequencia,
					nr_seq_item,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_atividade,
					ie_situacao)
				values (	nr_seq_item_ativ_novo_w,
					nr_seq_item_plano_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_ativ_w,
					ie_situacao_ativ_w);

		open C02;
		loop
		fetch C02 into
			nr_seq_insp_item_acao_w,
			nr_seq_acao_w,
			ie_situacao_acao_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			select	nextval('man_plano_insp_item_acao_seq')
			into STRICT	nr_seq_item_acao_novo_w
			;

			insert into man_plano_insp_item_acao(
						nr_sequencia,
						nr_seq_item,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_seq_acao,
						ie_situacao,
						nr_seq_ativ)
					values (	nr_seq_item_acao_novo_w,
						nr_seq_item_plano_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_acao_w,
						ie_situacao_acao_w,
						nr_seq_item_ativ_novo_w);

			open C03;
			loop
			fetch C03 into
				nr_seq_insp_item_result_w,
				nr_seq_result_w,
				ie_situacao_result_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin
				select	nextval('man_plano_insp_item_result_seq')
				into STRICT	nr_seq_item_result_novo_w
				;

				insert into man_plano_insp_item_result(
							nr_sequencia,
							nr_seq_item,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_seq_result,
							ie_situacao,
							nr_seq_acao)
						values (	nr_seq_item_result_novo_w,
							nr_seq_item_plano_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							nr_seq_result_w,
							ie_situacao_result_w,
							nr_seq_item_acao_novo_w);
				end;
			end loop;
			close C03;
			end;
		end loop;
		close C02;
		end;
	end loop;
	close C01;
	end;
end loop;
close C00;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_replicar_ativ_item_insp ( nr_seq_item_p bigint, nm_usuario_p text) FROM PUBLIC;

