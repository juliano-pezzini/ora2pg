-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_w_analise_pos_cab ( nr_seq_analise_p bigint, nr_seq_grupo_p bigint, nm_usuario_p text, nr_id_transacao_p INOUT w_pls_analise_item.nr_id_transacao%type) AS $body$
DECLARE


nm_beneficiario_w		varchar(255);
cd_usuario_plano_w		varchar(255);
ds_idade_benef_w		varchar(255);
ds_tipo_guia_analise_w		varchar(255);
nm_prestador_solic_w		varchar(255);
ds_senha_w			varchar(255);
ds_mes_ref_lote_w		varchar(255);
ds_tipo_acomodacao_benef_w	varchar(255);
nm_profissional_solic_w		varchar(255);
ds_motivo_saida_w		varchar(255);
ds_origem_conta_w		varchar(255);
nm_profissional_w		varchar(255);
ds_formacao_preco_w		varchar(255);
ds_tipo_apres_guia_w		varchar(255);
nm_prestador_atend_w		varchar(255);
ds_carater_solicitacao_w	varchar(255);
ds_tipo_internacao_w		varchar(255);
ds_tipo_acomodacao_atend_w	varchar(255);
ds_tipo_saida_w			varchar(255);
ds_tipo_atendimento_w		varchar(255);
ds_regime_atendimento_w		varchar(255);
ds_saude_ocupacional_w		varchar(255);
nm_operadora_interc_w		varchar(255);
ds_origem_analise_w		varchar(255);
cd_operadora_interc_w		varchar(30);
nr_lote_prestador_w		varchar(30);
ds_cid_principal_w		varchar(30);
ds_data_atend_w			varchar(30);
ds_criacao_analise_w		varchar(30);
ds_entrada_internacao_w		varchar(30);
ds_saida_internacao_w		varchar(30);
nr_fatura_ptu_w			ptu_fatura.nr_fatura%type;
cd_guia_principal_w		varchar(30);
cd_guia_w			varchar(20);
ie_tipo_guia_w			varchar(2);
ie_pre_analise_w		varchar(1);
nr_seq_prestador_exec_w		bigint;
nr_seq_prestador_w		bigint;
nr_seq_segurado_w		bigint;
nr_seq_conta_w			bigint;
ie_origem_analise_w		bigint;
nr_seq_grupo_atual_w		bigint;
cd_estabelecimento_w		bigint;
cd_usuario_plano_aux_w		varchar(255);
qt_conta_cabecalho_w		integer;
nr_seq_pos_cabecalho_w		pls_conta_pos_cabecalho.nr_sequencia%type;
cd_guia_pos_estab_w		pls_conta.cd_guia_pos_estab%type;
nr_seq_conta_ref_pos_w		pls_conta.nr_sequencia%type;
ie_tipo_conta_w			pls_conta.ie_tipo_conta%type;
nr_seq_guia_w			pls_conta.nr_seq_guia%type;
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Gerar a visualizacao (tabela temporaria) do cabecalho da analise de pos-estabelecido
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[ X ]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
BEGIN

if (coalesce(nr_id_transacao_p,0) = 0) then
	select 	nextval('pls_id_analise_seq')
	into STRICT	nr_id_transacao_p 
	;
else
	delete	from w_pls_analise_cabecalho
	where 	nr_id_transacao	= nr_id_transacao_p;
	
	delete 	FROM w_pls_analise_total
	where	nr_id_transacao	= nr_id_transacao_p;
	
	delete 	FROM w_pls_analise_glosa_ocor
	where	nr_id_transacao	= nr_id_transacao_p;
	
end if;

select	pls_obter_conta_principal(a.cd_guia, a.nr_sequencia, a.nr_seq_segurado, a.nr_seq_prestador),
	a.ie_origem_analise,
	substr(obter_valor_dominio(4572, coalesce(a.ie_origem_analise,1)),1,255),
	coalesce(ie_pre_analise,'N'),
	a.cd_estabelecimento
into STRICT	nr_seq_conta_w,
	ie_origem_analise_w,
	ds_origem_analise_w,
	ie_pre_analise_w,
	cd_estabelecimento_w
from	pls_analise_conta	a
where	a.nr_sequencia	= nr_seq_analise_p;

select	max(a.ie_tipo_guia)
into STRICT	ie_tipo_guia_w
from	pls_conta	a
where	a.nr_sequencia	= nr_seq_conta_w;

select	count(1)
into STRICT	qt_conta_cabecalho_w
from	pls_conta_pos_cabecalho
where	nr_seq_conta	= nr_seq_conta_w;

if (qt_conta_cabecalho_w = 0) then
	/* Francisco - 21/06/2013 - OS 609623 */

	CALL pls_gerar_conta_pos_cabecalho(nr_seq_conta_w, null, nm_usuario_p);
end if;

--Verifica tem referencia a outra a guia de pos
select 	max(cd_guia_pos_estab)
into STRICT	cd_guia_pos_estab_w
from	pls_conta
where	nr_sequencia = nr_seq_conta_w;

if (cd_guia_pos_estab_w IS NOT NULL AND cd_guia_pos_estab_w::text <> '') then
	
	select	max(nr_sequencia)
	into STRICT	nr_seq_conta_ref_pos_w
	from	pls_conta
	where	cd_guia_ok = cd_guia_pos_estab_w;
	
	if (nr_seq_conta_ref_pos_w IS NOT NULL AND nr_seq_conta_ref_pos_w::text <> '') then
		nr_seq_conta_w := nr_seq_conta_ref_pos_w;
	end if;
end if;

select	max(c.nr_sequencia),
	max(a.ie_tipo_conta),
	max(a.nr_seq_guia)
into STRICT	nr_seq_pos_cabecalho_w,
	ie_tipo_conta_w,
	nr_seq_guia_w
from	pls_conta		a,
	pls_conta_pos_cabecalho c
where	a.nr_sequencia		= nr_seq_conta_w
and	a.nr_sequencia		= c.nr_seq_conta;
	
if (ie_tipo_guia_w = '3') then /* Consulta */
	select	substr('(' || CASE WHEN pls_obter_dados_segurado(a.nr_seq_segurado,'C')=0 THEN  cd_usuario_plano_imp  ELSE pls_obter_dados_segurado(a.nr_seq_segurado,'C') END  || ') ',1,255) ,
		substr(CASE WHEN coalesce(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),'X')='X' THEN  pls_desc_benef_intercambio(nr_seq_nota_cobranca)  ELSE pls_obter_dados_segurado(a.nr_seq_segurado,'N') END ,1,255),
		substr(pls_obter_idade_segurado(a.nr_seq_segurado, clock_timestamp(),'D'),1,30),
		substr('(' || trim(both pls_obter_dados_segurado(a.nr_seq_segurado, 'CON')) || ')  - ' ,1,30),
		substr(obter_valor_dominio(1746,a.ie_tipo_guia),1,255),
		substr(pls_obter_cod_prestador(a.nr_seq_prestador, null) || ' - ' || pls_obter_dados_prestador(a.nr_seq_prestador,'N'),1,255),
		substr(a.cd_senha || ' / ' || a.cd_senha_externa,1,30),
		to_char(dt_mes_competencia,'mm/yyyy'),
		substr(pls_obter_acomodacoes_plano(pls_obter_dados_segurado(a.nr_seq_segurado,'NRP')),1,255),
		substr(cd_medico_solicitante || ' - ' || obter_nome_medico(cd_medico_solicitante,'N'),1,255),  
		substr(a.nr_protocolo_prestador,1,30),
		(	select	substr(coalesce(max(x.ds_motivo_saida),''),1,255)
			from	pls_motivo_saida_consulta	x
			where	x.nr_sequencia	= a.nr_seq_saida_consulta),
		(	select	substr(max(coalesce(x.cd_doenca, x.cd_doenca_imp)),1,30)
			from	pls_diagnostico_conta	x
			where 	x.nr_seq_conta		= a.nr_seq_conta
			and	x.ie_classificacao	= 'P'),
		substr(obter_valor_dominio(3470, ie_origem_conta),1,255),
		to_char(a.dt_atendimento,'dd/mm/yyyy'),
		substr(a.cd_medico_executor || ' - ' || obter_nome_medico(a.cd_medico_executor,'N'),1,255),
		substr(pls_obter_formacao_plano_seg(a.nr_seq_segurado),1,255),
		to_char(dt_protocolo,'dd/mm/yy') dt_atualizacao,
		substr(pls_obter_se_conta_reapre(a.nr_seq_conta),1,255),
		substr(coalesce(a.cd_guia_referencia,a.cd_guia),1,30),
		substr(pls_obter_cod_prestador(a.nr_seq_prestador_exec, null) || ' - ' || pls_obter_dados_prestador(a.nr_seq_prestador_exec,'N'),1,255),
		substr(CASE WHEN coalesce(a.nr_seq_congenere::text, '') = '' THEN 			CASE WHEN a.ie_tipo_segurado='C' THEN (select x.nr_seq_intercambio from pls_segurado x where x.nr_sequencia = a.nr_seq_segurado)|| ' - ' || pls_obter_dados_segurado(a.nr_seq_segurado,'ES')  ELSE pls_obter_dados_segurado(a.nr_seq_segurado,'CC') || ' - ' || pls_obter_dados_segurado(a.nr_seq_segurado,'ES') END   ELSE pls_obter_seq_codigo_coop(a.nr_seq_congenere,'')||' - '||pls_obter_nome_congenere(a.nr_seq_congenere) END ,1,255),
		substr(pls_obter_dados_ptu_fatura(a.nr_seq_fatura,'F'),1,255),
		a.nr_seq_segurado
	into STRICT	cd_usuario_plano_w,
		nm_beneficiario_w,
		ds_idade_benef_w,
		cd_operadora_interc_w,
		ds_tipo_guia_analise_w,
		nm_prestador_solic_w,
		ds_senha_w,
		ds_mes_ref_lote_w,
		ds_tipo_acomodacao_benef_w,
		nm_profissional_solic_w,
		nr_lote_prestador_w,
		ds_motivo_saida_w,
		ds_cid_principal_w,
		ds_origem_conta_w,
		ds_data_atend_w,
		nm_profissional_w,
		ds_formacao_preco_w,
		ds_criacao_analise_w,
		ds_tipo_apres_guia_w,
		cd_guia_principal_w,
		nm_prestador_atend_w,
		nm_operadora_interc_w,
		nr_fatura_ptu_w,
		nr_seq_segurado_w
	from	pls_conta_pos_cabecalho	a
	where  	a.nr_sequencia	= nr_seq_pos_cabecalho_w;
elsif (ie_tipo_guia_w = '4') then /* SP/SADT */
	
	select	substr('(' || CASE WHEN pls_obter_dados_segurado(a.nr_seq_segurado,'C')='0' THEN  cd_usuario_plano_imp  ELSE pls_obter_dados_segurado(a.nr_seq_segurado,'C') END  || ') ',1,255) ,
		substr(CASE WHEN coalesce(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),'X')='X' THEN  pls_desc_benef_intercambio(nr_seq_nota_cobranca)  ELSE pls_obter_dados_segurado(a.nr_seq_segurado,'N') END ,1,255),
		substr(pls_obter_idade_segurado(a.nr_seq_segurado, clock_timestamp(),'D'),1,30),
		substr(trim(both pls_obter_dados_segurado(a.nr_seq_segurado, 'CON')),1,30),
		substr(obter_valor_dominio(1746,a.ie_tipo_guia),1,255), 
		substr(pls_obter_cod_prestador(a.nr_seq_prestador, null)||' - '||pls_obter_dados_prestador(a.nr_seq_prestador,'N'),1,255) nm_prestador,
		substr(coalesce(a.cd_guia_referencia,a.cd_guia),1,30) nr_guia, 
		substr(obter_valor_dominio(2819, ie_carater_internacao),1,255) ds_carater_internacao, 
		substr(a.cd_senha ||' / '|| a.cd_senha_externa,1,30) cd_senha_externa,      
		to_char(dt_mes_competencia,'mm/yyyy'),
		substr(pls_obter_acomodac_plano_ptu(pls_obter_dados_segurado(a.nr_seq_segurado,'NRP')),1,255),
		CASE WHEN ie_tipo_conta_w='I' THEN  CASE WHEN coalesce(a.ie_tipo_acomodacao_ptu::text, '') = '' THEN ptu_obter_ds_acomo_nota_hos(a.nr_seq_nota_cobranca) WHEN a.ie_tipo_acomodacao_ptu='A' THEN 'Enfermaria Intercambio - Plano A' WHEN a.ie_tipo_acomodacao_ptu='B' THEN 'Apartamento Intercambio - Plano B' END   ELSE CASE WHEN substr(pls_obter_desc_tipo_acomodacao(a.nr_seq_tipo_acomodacao),1,255)='' THEN substr(pls_obter_tp_acomodacao_guia(nr_seq_guia_w),1,50)  ELSE substr(pls_obter_desc_tipo_acomodacao(a.nr_seq_tipo_acomodacao),1,255) END  END ,
		substr(pls_obter_desc_tipo_atend(a.nr_seq_tipo_atendimento),1,255),
		substr(obter_valor_dominio(10631, coalesce(a.ie_regime_atendimento,1)),1,200),
		substr(obter_valor_dominio((10632), coalesce(a.ie_saude_ocupacional,1)),1,200),
		substr(pls_obter_cod_prestador(a.nr_seq_prestador_exec, null)||' - '||pls_obter_dados_prestador(a.nr_seq_prestador_exec,'N'),1,255),
		substr(cd_medico_solicitante||' - '||obter_nome_medico(cd_medico_solicitante,'N'),1,255), 
		substr(a.nr_protocolo_prestador,1,30),
		substr(pls_obter_desc_motivo_saida(a.nr_seq_saida_spsadt),1,255),
		substr(pls_obter_cid_conta(a.nr_seq_conta),1,30),
		substr(pls_obter_desc_tipo_internacao(a.nr_seq_clinica),1,255),
		substr(obter_valor_dominio(3470, ie_origem_conta),1,255),
		a.dt_atendimento,
		substr(CASE WHEN coalesce(a.nr_seq_congenere::text, '') = '' THEN 			CASE WHEN a.ie_tipo_segurado='C' THEN (select x.nr_seq_intercambio from pls_segurado x where x.nr_sequencia = a.nr_seq_segurado)|| ' - ' || pls_obter_dados_segurado(a.nr_seq_segurado,'ES')  ELSE pls_obter_dados_segurado(a.nr_seq_segurado,'CC') || ' - ' || pls_obter_dados_segurado(a.nr_seq_segurado,'ES') END   ELSE pls_obter_seq_codigo_coop(a.nr_seq_congenere,'')||' - '||pls_obter_nome_congenere(a.nr_seq_congenere) END ,1,255),
		substr(pls_obter_dados_ptu_fatura(a.nr_seq_fatura,'F'),1,30),
		substr(a.cd_medico_executor||' - '||obter_nome_medico(a.cd_medico_executor,'N'),1,255),
		substr(pls_obter_formacao_plano_seg(a.nr_seq_segurado),1,255),
		to_char(a.dt_protocolo, 'dd/mm/yyyy'),
		substr(pls_obter_se_conta_reapre(a.nr_seq_conta),1,255),
		a.nr_seq_segurado
	into STRICT	cd_usuario_plano_w,
		nm_beneficiario_w,
		ds_idade_benef_w,
		cd_operadora_interc_w,
		ds_tipo_guia_analise_w,
		nm_prestador_solic_w,
		cd_guia_principal_w,
		ds_carater_solicitacao_w,
		ds_senha_w,
		ds_mes_ref_lote_w,
		ds_tipo_acomodacao_benef_w,
		ds_tipo_acomodacao_atend_w,
		ds_tipo_atendimento_w,
		ds_regime_atendimento_w,	
		ds_saude_ocupacional_w,	
		nm_prestador_atend_w,
		nm_profissional_solic_w,
		nr_lote_prestador_w,
		ds_motivo_saida_w,
		ds_cid_principal_w,
		ds_tipo_internacao_w,
		ds_origem_conta_w,
		ds_data_atend_w,
		nm_operadora_interc_w,
		nr_fatura_ptu_w,
		nm_profissional_w,
		ds_formacao_preco_w,
		ds_criacao_analise_w,
		ds_tipo_apres_guia_w,
		nr_seq_segurado_w
	from	pls_conta_pos_cabecalho		a
	where  	a.nr_sequencia	= nr_seq_pos_cabecalho_w;
	null;
elsif (ie_tipo_guia_w = '6') then /* HI */
	select	substr('('||CASE WHEN pls_obter_dados_segurado(a.nr_seq_segurado,'C')='0' THEN  cd_usuario_plano_imp  ELSE pls_obter_dados_segurado(a.nr_seq_segurado,'C') END ||') ',1,255),
		substr(CASE WHEN coalesce(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),'X')='X' THEN  substr(pls_desc_benef_intercambio(nr_seq_nota_cobranca),1,255)  ELSE pls_obter_dados_segurado(a.nr_seq_segurado,'N') END ,1,255),
		substr(pls_obter_idade_segurado(a.nr_seq_segurado, clock_timestamp(),'D'),1,30),
		substr(trim(both pls_obter_dados_segurado(a.nr_seq_segurado, 'CON')),1,30),
		to_char(a.dt_entrada,'dd/mm/yyyy hh24:mi:ss'),
		to_char(a.dt_alta,'dd/mm/yyyy hh24:mi:ss'),
		substr(obter_valor_dominio(1746,a.ie_tipo_guia),1,255),
		substr(pls_obter_cod_prestador(a.nr_seq_prestador, null)||' - '||pls_obter_dados_prestador(a.nr_seq_prestador,'N'),1,255) nm_prestador,       
		substr(coalesce(a.cd_guia_referencia,a.cd_guia),1,30),  
		substr(obter_valor_dominio(2819, ie_carater_internacao),1,255),
		substr(a.cd_senha||' / '||a.cd_senha_externa,1,30),
		to_char(dt_mes_competencia,'mm/yyyy'),
		substr(pls_obter_acomodac_plano_ptu(pls_obter_dados_segurado(a.nr_seq_segurado,'NRP')),1,255),
		CASE WHEN ie_tipo_conta_w='I' THEN  CASE WHEN coalesce(a.ie_tipo_acomodacao_ptu::text, '') = '' THEN ptu_obter_ds_acomo_nota_hos(a.nr_seq_nota_cobranca) WHEN a.ie_tipo_acomodacao_ptu='A' THEN 'Enfermaria Intercambio - Plano A' WHEN a.ie_tipo_acomodacao_ptu='B' THEN 'Apartamento Intercambio - Plano B' END   ELSE CASE WHEN substr(pls_obter_desc_tipo_acomodacao(a.nr_seq_tipo_acomodacao),1,255)='' THEN substr(pls_obter_tp_acomodacao_guia(nr_seq_guia_w),1,50)  ELSE substr(pls_obter_desc_tipo_acomodacao(a.nr_seq_tipo_acomodacao),1,255) END  END ,
		substr(pls_obter_desc_tipo_atend(a.nr_seq_tipo_atendimento),1,255),
		substr(obter_valor_dominio(10631, coalesce(a.ie_regime_atendimento,1)),1,200),
		substr(obter_valor_dominio((10632), coalesce(a.ie_saude_ocupacional,1)),1,200),
		substr(pls_obter_cod_prestador(a.nr_seq_prestador_exec, null)||' - '||pls_obter_dados_prestador(a.nr_seq_prestador_exec,'N'),1,255),  
		substr(cd_medico_solicitante||' - '||obter_nome_medico(cd_medico_solicitante,'N'),1,255),  
		substr(a.nr_protocolo_prestador,1,30),
		substr(pls_obter_desc_mot_saida_int(a.nr_seq_saida_int),1,255),
		substr(pls_obter_cid_conta(a.nr_seq_conta),1,30),
		substr(pls_obter_desc_tipo_internacao(a.nr_seq_clinica),1,255),
		substr(obter_valor_dominio(3470, ie_origem_conta),1,255),
		to_char(a.dt_atendimento,'dd/mm/yyyy') dt_emissao,
		substr(CASE WHEN coalesce(a.nr_seq_congenere::text, '') = '' THEN 			CASE WHEN a.ie_tipo_segurado='C' THEN (select x.nr_seq_intercambio from pls_segurado x where x.nr_sequencia = a.nr_seq_segurado)|| ' - ' || pls_obter_dados_segurado(a.nr_seq_segurado,'ES')  ELSE pls_obter_dados_segurado(a.nr_seq_segurado,'CC') || ' - ' || pls_obter_dados_segurado(a.nr_seq_segurado,'ES') END   ELSE pls_obter_seq_codigo_coop(a.nr_seq_congenere,'')||' - '||pls_obter_nome_congenere(a.nr_seq_congenere) END ,1,255),
		substr(pls_obter_dados_ptu_fatura(a.nr_seq_fatura,'F'),1,255),
		substr(pls_obter_formacao_plano_seg(a.nr_seq_segurado),1,255),
		to_char(dt_protocolo) dt_atualizacao,
		pls_obter_se_conta_reapre(a.nr_seq_conta),
		a.nr_seq_segurado
	into STRICT	cd_usuario_plano_w,
		nm_beneficiario_w,
		ds_idade_benef_w,
		cd_operadora_interc_w,
		ds_entrada_internacao_w,
		ds_saida_internacao_w,
		ds_tipo_guia_analise_w,
		nm_prestador_solic_w,
		cd_guia_principal_w,
		ds_carater_solicitacao_w,
		ds_senha_w,
		ds_mes_ref_lote_w,
		ds_tipo_acomodacao_benef_w,
		ds_tipo_acomodacao_atend_w,
		ds_tipo_atendimento_w,
		ds_regime_atendimento_w,	
		ds_saude_ocupacional_w,	
		nm_prestador_atend_w,
		nm_profissional_solic_w,
		nr_lote_prestador_w,
		ds_motivo_saida_w,
		ds_cid_principal_w,
		ds_tipo_internacao_w,
		ds_origem_conta_w,
		ds_data_atend_w,
		nm_operadora_interc_w,
		nr_fatura_ptu_w,
		ds_formacao_preco_w,
		ds_criacao_analise_w,
		ds_tipo_apres_guia_w,
		nr_seq_segurado_w
	from	pls_conta_pos_cabecalho	a
	where  	a.nr_sequencia	= nr_seq_pos_cabecalho_w;
	
	if (ds_data_atend_w IS NOT NULL AND ds_data_atend_w::text <> '') then
		begin
			ds_data_atend_w	:= to_date(ds_data_atend_w,'dd/mm/yyyy');
		exception
		when others then
			ds_data_atend_w := null;
		end;
	end if;
elsif (ie_tipo_guia_w = '5') then /* Internacao */
		
	select	substr('('||CASE WHEN pls_obter_dados_segurado(a.nr_seq_segurado,'C')='0' THEN  cd_usuario_plano_imp  ELSE pls_obter_dados_segurado(a.nr_seq_segurado,'C') END ||') ',1,255),
		substr(CASE WHEN coalesce(pls_obter_dados_segurado(a.nr_seq_segurado,'N'),'X')='X' THEN  substr(pls_desc_benef_intercambio(nr_seq_nota_cobranca),1,255)  ELSE pls_obter_dados_segurado(a.nr_seq_segurado,'N') END ,1,255),
		substr(pls_obter_idade_segurado(a.nr_seq_segurado, clock_timestamp(),'D'),1,30),
		substr(trim(both pls_obter_dados_segurado(a.nr_seq_segurado, 'CON')),1,30),        
		to_char(a.dt_entrada,'dd/mm/yyyy hh24:mi:ss'),
		to_char(a.dt_alta,'dd/mm/yyyy hh24:mi:ss'),
		substr(obter_valor_dominio(1746,a.ie_tipo_guia),1,255),
		substr(pls_obter_cod_prestador(a.nr_seq_prestador, null)||' - '||pls_obter_dados_prestador(a.nr_seq_prestador,'N'),1,255) nm_prestador,       
		substr(coalesce(a.cd_guia_referencia,a.cd_guia),1,30),  
		substr(obter_valor_dominio(2819, ie_carater_internacao),1,255),
		substr(a.cd_senha||' / '||a.cd_senha_externa,1,30),
		to_char(dt_mes_competencia,'mm/yyyy'),
		substr(pls_obter_acomodac_plano_ptu(pls_obter_dados_segurado(a.nr_seq_segurado,'NRP')),1,255),
		CASE WHEN ie_tipo_conta_w='I' THEN  CASE WHEN coalesce(a.ie_tipo_acomodacao_ptu::text, '') = '' THEN ptu_obter_ds_acomo_nota_hos(a.nr_seq_nota_cobranca) WHEN a.ie_tipo_acomodacao_ptu='A' THEN 'Enfermaria Intercambio - Plano A' WHEN a.ie_tipo_acomodacao_ptu='B' THEN 'Apartamento Intercambio - Plano B' END   ELSE CASE WHEN substr(pls_obter_desc_tipo_acomodacao(a.nr_seq_tipo_acomodacao),1,255)='' THEN substr(pls_obter_tp_acomodacao_guia(nr_seq_guia_w),1,50)  ELSE substr(pls_obter_desc_tipo_acomodacao(a.nr_seq_tipo_acomodacao),1,255) END  END ,
		substr(pls_obter_desc_tipo_atend(a.nr_seq_tipo_atendimento),1,255),		
		substr(obter_valor_dominio(10631, coalesce(a.ie_regime_atendimento,1)),1,200),
		substr(obter_valor_dominio((10632), coalesce(a.ie_saude_ocupacional,1)),1,200),
		substr(pls_obter_cod_prestador(a.nr_seq_prestador_exec, null)||' - '||pls_obter_dados_prestador(a.nr_seq_prestador_exec,'N'),1,255),  
		substr(cd_medico_solicitante||' - '||obter_nome_medico(cd_medico_solicitante,'N'),1,255),  
		substr(a.nr_protocolo_prestador,1,30), 
		substr(pls_obter_desc_mot_saida_int(a.nr_seq_saida_int),1,255),
		substr(pls_obter_cid_conta(a.nr_seq_conta),1,30),
		substr(pls_obter_desc_tipo_internacao(a.nr_seq_clinica),1,255),
		substr(obter_valor_dominio(3470, ie_origem_conta),1,255),
		to_char(a.dt_atendimento,'dd/mm/yyyy') dt_emissao,
		substr(CASE WHEN coalesce(a.nr_seq_congenere::text, '') = '' THEN 			CASE WHEN a.ie_tipo_segurado='C' THEN (select x.nr_seq_intercambio from pls_segurado x where x.nr_sequencia = a.nr_seq_segurado)|| ' - ' || pls_obter_dados_segurado(a.nr_seq_segurado,'ES')  ELSE pls_obter_dados_segurado(a.nr_seq_segurado,'CC') || ' - ' || pls_obter_dados_segurado(a.nr_seq_segurado,'ES') END   ELSE pls_obter_seq_codigo_coop(a.nr_seq_congenere,'')||' - '||pls_obter_nome_congenere(a.nr_seq_congenere) END ,1,255),
		substr(pls_obter_dados_ptu_fatura(a.nr_seq_fatura,'F'),1,255),
		substr(pls_obter_formacao_plano_seg(a.nr_seq_segurado),1,255),
		to_char(dt_protocolo) dt_atualizacao,
		pls_obter_se_conta_reapre(a.nr_seq_conta), 
		a.nr_seq_segurado
	into STRICT	cd_usuario_plano_w,
		nm_beneficiario_w,
		ds_idade_benef_w,
		cd_operadora_interc_w,
		ds_entrada_internacao_w,
		ds_saida_internacao_w,
		ds_tipo_guia_analise_w,
		nm_prestador_solic_w,
		cd_guia_principal_w,
		ds_carater_solicitacao_w,
		ds_senha_w,
		ds_mes_ref_lote_w,
		ds_tipo_acomodacao_benef_w,
		ds_tipo_acomodacao_atend_w,
		ds_tipo_atendimento_w,
		ds_regime_atendimento_w,	
		ds_saude_ocupacional_w,	
		nm_prestador_atend_w,
		nm_profissional_solic_w,
		nr_lote_prestador_w,
		ds_motivo_saida_w,
		ds_cid_principal_w,
		ds_tipo_internacao_w,
		ds_origem_conta_w,
		ds_data_atend_w,
		nm_operadora_interc_w,
		nr_fatura_ptu_w,
		ds_formacao_preco_w,
		ds_criacao_analise_w,
		ds_tipo_apres_guia_w,
		nr_seq_segurado_w
	from	pls_conta_pos_cabecalho	a
	where  	a.nr_sequencia	= nr_seq_pos_cabecalho_w;

end if;

nr_seq_grupo_atual_w	:= nr_seq_grupo_p;

/*aaschlote 21/11/2012 OS - 510018*/

cd_usuario_plano_aux_w	:= replace(replace(cd_usuario_plano_w,')',''),'(','');
cd_usuario_plano_w	:= '(' || substr(pls_convert_masc_cart_usuario(cd_usuario_plano_aux_w,cd_estabelecimento_w),1,255) || ') ';

insert into w_pls_analise_cabecalho(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_seq_analise,
	nr_lote_prestador,
	nm_prestador_solic,
	nm_prestador_atend,
	ds_carater_solicitacao,
	ds_mes_ref_lote,
	ds_tipo_internacao,
	ds_cid_principal,
	ds_formacao_preco,
	ds_tipo_apres_guia,
	ds_origem_conta,
	ds_entrada_internacao,
	ds_saida_internacao,
	ds_tipo_acomodacao_benef,
	ie_tipo_cabecalho,
	ds_tipo_acomodacao_atend,
	ds_tipo_saida,
	ds_senha,
	ds_criacao_analise,
	nm_profissional_solic,
	nm_profissional,
	ds_data_atend,
	ds_motivo_saida,
	nm_beneficiario,
	cd_usuario_plano,
	ds_idade_benef,
	ds_tipo_atendimento,
	ds_regime_atendimento,
	ds_saude_ocupacional,
	cd_operadora_interc,
	nm_operadora_interc,
	nr_fatura_ptu,
	ie_origem_analise,
	ie_tipo_guia,
	ds_origem_analise,
	ds_tipo_guia_analise,
	cd_guia_principal,
	nr_seq_grupo_aud_atual,
	nr_seq_segurado,
	nr_id_transacao)
values (nextval('w_pls_analise_cabecalho_seq'),
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_analise_p,
	nr_lote_prestador_w,
	nm_prestador_solic_w,
	nm_prestador_atend_w,
	ds_carater_solicitacao_w,
	ds_mes_ref_lote_w,
	ds_tipo_internacao_w,
	ds_cid_principal_w,
	ds_formacao_preco_w,
	ds_tipo_apres_guia_w,
	ds_origem_conta_w,
	ds_entrada_internacao_w,
	ds_saida_internacao_w,
	ds_tipo_acomodacao_benef_w,
	CASE WHEN coalesce(nr_fatura_ptu_w::text, '') = '' THEN CASE WHEN ie_tipo_guia_w=3 THEN 'C' WHEN ie_tipo_guia_w=4 THEN 'S' WHEN ie_tipo_guia_w=5 THEN 'I' WHEN ie_tipo_guia_w=6 THEN 'HI' END   ELSE 'IN' END ,
	ds_tipo_acomodacao_atend_w,
	ds_tipo_saida_w,
	ds_senha_w,
	ds_criacao_analise_w,
	nm_profissional_solic_w,
	nm_profissional_w,
	ds_data_atend_w,
	ds_motivo_saida_w,
	nm_beneficiario_w,
	cd_usuario_plano_w,
	ds_idade_benef_w,
	ds_tipo_atendimento_w,
	ds_regime_atendimento_w,	
	ds_saude_ocupacional_w,	
	cd_operadora_interc_w,
	nm_operadora_interc_w,
	nr_fatura_ptu_w,
	ie_origem_analise_w,
	ie_tipo_guia_w,
	ds_origem_analise_w,
	ds_tipo_guia_analise_w,
	cd_guia_principal_w,
	nr_seq_grupo_atual_w,
	nr_seq_segurado_w,
	nr_id_transacao_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_w_analise_pos_cab ( nr_seq_analise_p bigint, nr_seq_grupo_p bigint, nm_usuario_p text, nr_id_transacao_p INOUT w_pls_analise_item.nr_id_transacao%type) FROM PUBLIC;

