-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hemolabor_san_gerar_codigo_int (nr_seq_doacao_p bigint) AS $body$
DECLARE


qt_doacoes_w			bigint;
cd_pessoa_fisica_w		varchar(10);

cd_regional_w			varchar(3);
cd_pessoa_fisica_int_w	varchar(7);
cd_doacao_w				varchar(7);
qt_doacao_w				varchar(3);
ds_valor_param_375_w	varchar(1);
ie_possui_barras_w		varchar(1);
ds_valor_param_331_w	varchar(255);
cd_barras_intergracao_w varchar(20);


BEGIN

if (nr_seq_doacao_p IS NOT NULL AND nr_seq_doacao_p::text <> '') then

	ds_valor_param_331_w :=  obter_valor_param_usuario(450, 331, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento);
	ds_valor_param_375_w :=  obter_valor_param_usuario(450, 375, wheb_usuario_pck.get_cd_perfil, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento);

	select  max(substr(lpad(cd_regional,3,0),1,3))
	into STRICT	cd_regional_w
	from    san_parametro
	where   cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

	select  max(cd_pessoa_fisica),
		max(lpad(cd_pessoa_fisica,7,0)),
		max(lpad(nr_sequencia,7,0))
	into STRICT	cd_pessoa_fisica_w,
		cd_pessoa_fisica_int_w,
		cd_doacao_w
        from    san_doacao
	where   nr_sequencia = nr_seq_doacao_p;

	select  lpad(count(*),3,0)
	into STRICT	qt_doacao_w
	from    san_doacao
	where   cd_pessoa_fisica = cd_pessoa_fisica_w
	and	nr_sequencia <= nr_seq_doacao_p;

	if (ds_valor_param_375_w = 'S') then
		qt_doacao_w	:= lpad(qt_doacao_w + 1,3,0);
	end if;

	qt_doacoes_w := obter_qtd_doacoes(cd_pessoa_fisica_w, nr_seq_doacao_p);

	select	CASE WHEN coalesce(cd_barras_integracao, '')='' THEN  'N'  ELSE 'S' END
	into STRICT	ie_possui_barras_w
	from	san_doacao
	where	nr_sequencia	= nr_seq_doacao_p;

	if (ie_possui_barras_w = 'N') then

		if (ds_valor_param_331_w = 'H') then
		begin
			cd_barras_intergracao_w	:= cd_regional_w || cd_pessoa_fisica_int_w || cd_doacao_w || qt_doacao_w;
		end;
		elsif (ds_valor_param_331_w = 'I') then
		begin
			cd_barras_intergracao_w	:= cd_regional_w || cd_doacao_w || qt_doacao_w;
		end;
		elsif (ds_valor_param_331_w = 'J') then
		begin
			cd_barras_intergracao_w	:= cd_regional_w || cd_pessoa_fisica_int_w || cd_doacao_w;
		end;
		end if;

		update	san_doacao
		set		cd_barras_integracao = cd_barras_intergracao_w
		where	nr_sequencia = nr_seq_doacao_p;
	end if;

	update	san_producao
	set	cd_barras = replace('5'||to_char(obter_somente_numero(cd_pessoa_fisica_w),'0000000')||to_char(nr_sequencia,'0000000')||to_char(qt_doacoes_w,'000'),' ','')||replace(to_char(nr_seq_derivado,'00'),' ','')
	where	nr_seq_doacao = nr_seq_doacao_p
	and	coalesce(cd_barras, ' ') = ' ';
end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hemolabor_san_gerar_codigo_int (nr_seq_doacao_p bigint) FROM PUBLIC;

