-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_itens_rep_ce ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_prescricao_p prescr_medica.nr_prescricao%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type, dt_inicio_prescr_p prescr_medica.dt_prescricao%type, nr_sequencia_p bigint) AS $body$
DECLARE

 
dt_prim_hor_ret_w		timestamp;
cd_convenio_w			convenio.cd_convenio%type;
ie_origem_inf_w			prescr_medica.ie_origem_inf%type;
cd_pf_usuario_w			pessoa_fisica.cd_pessoa_fisica%type;


BEGIN 
 
select 	max(a.cd_pessoa_fisica) 
into STRICT	cd_pf_usuario_w 
from	usuario a 
where	a.nm_usuario = nm_usuario_p;
 
if (cd_pf_usuario_w IS NOT NULL AND cd_pf_usuario_w::text <> '') then	 
	select	coalesce(max('1'),'3') 
	into STRICT	ie_origem_inf_w 
	from	medico 
	where	cd_pessoa_fisica	= cd_pf_usuario_w 
	and	coalesce(ie_situacao,'A') = 'A';	
else 
	ie_origem_inf_w	:= '3';
end if;	
 
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then 
	cd_convenio_w	:= obter_convenio_atendimento(nr_atendimento_p);
end if;
 
dt_prim_hor_ret_w := cpoe_insert_prescr_proced_reg(nr_atendimento_p, nr_prescricao_p, nr_sequencia_p, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, cd_setor_atendimento_p, ie_origem_inf_w, cd_convenio_w, dt_inicio_prescr_p, cd_pessoa_fisica_p);
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_itens_rep_ce ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_prescricao_p prescr_medica.nr_prescricao%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, cd_perfil_p perfil.cd_perfil%type, nm_usuario_p usuario.nm_usuario%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_setor_atendimento_p setor_atendimento.cd_setor_atendimento%type, dt_inicio_prescr_p prescr_medica.dt_prescricao%type, nr_sequencia_p bigint) FROM PUBLIC;

