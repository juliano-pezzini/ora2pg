-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_reajustar_tabelas_int ( nr_seq_tabela_p bigint, dt_inicio_vigencia_p timestamp, tx_reajuste_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text ) AS $body$
DECLARE


nr_seq_preco_w		bigint;
vl_base_apart_w		double precision := 0;
vl_preco_atual_apart_w	double precision;
vl_reajustado_apart_w	double precision := 0;
vl_base_enf_w		double precision := 0;
vl_preco_atual_enf_w	double precision;
vl_reajustado_enf_w	double precision := 0;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	ptu_tabela_inter_preco
	where	nr_seq_tabela	= nr_seq_tabela_p;


BEGIN

open C01;
loop
fetch C01 into
	nr_seq_preco_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	vl_reajustado_apart_w	:= 0;
	vl_base_apart_w		:= 0;
	vl_reajustado_enf_w	:= 0;
	vl_base_enf_w		:= 0;

	select	vl_preco_atual,
		vl_preco_atual_enf
	into STRICT	vl_preco_atual_apart_w,
		vl_preco_atual_enf_w
	from	ptu_tabela_inter_preco
	where	nr_sequencia	= nr_seq_preco_w;

	vl_reajustado_apart_w	:= dividir_sem_round((vl_preco_atual_apart_w * tx_reajuste_p)::numeric,100);
	vl_base_apart_w		:= vl_preco_atual_apart_w + vl_reajustado_apart_w;

	vl_reajustado_enf_w	:= dividir_sem_round((vl_preco_atual_enf_w * tx_reajuste_p)::numeric,100);
	vl_base_enf_w		:= vl_preco_atual_enf_w + vl_reajustado_enf_w;

	insert into ptu_tabela_inter_reajuste(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
			nr_seq_preco,cd_estabelecimento,dt_reajuste,tx_reajuste,vl_base,vl_reajuste,
			dt_inicio_vigencia,vl_reajuste_enf,vl_base_enf)
	values (	nextval('ptu_tabela_inter_reajuste_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p,
			nr_seq_preco_w,cd_estabelecimento_p,clock_timestamp(),tx_reajuste_p,vl_preco_atual_apart_w,vl_base_apart_w,
			dt_inicio_vigencia_p,vl_base_enf_w,vl_preco_atual_enf_w);

	update	ptu_tabela_inter_preco
	set	vl_preco_atual		= vl_base_apart_w,
		vl_preco_atual_enf	= vl_base_enf_w,
		nm_usuario	= nm_usuario_p
	where	nr_sequencia	= nr_seq_preco_w;

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_reajustar_tabelas_int ( nr_seq_tabela_p bigint, dt_inicio_vigencia_p timestamp, tx_reajuste_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text ) FROM PUBLIC;

