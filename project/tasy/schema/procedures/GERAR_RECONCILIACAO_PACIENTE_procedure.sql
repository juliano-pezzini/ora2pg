-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_reconciliacao_paciente ( nm_usuario_p text, nr_atendimento_p bigint, cd_perfil_p bigint, ie_momento_p text, ie_status_p text, ds_justificativa_p text default null, ie_commit_p text default 'S') AS $body$
DECLARE


nr_sequencia_w			reconciliacao_paciente.nr_sequencia%type;
cd_perfil_w				perfil.cd_perfil%type;


BEGIN

select 	max(nr_sequencia)
into STRICT	nr_sequencia_w
from	reconciliacao_paciente
where	nr_atendimento = nr_atendimento_p;

if (coalesce(nr_sequencia_w::text, '') = '') or (ie_status_p = 'N') then
	begin

		select 	max(cd_perfil)
		into STRICT	cd_perfil_w
		from	perfil
		where 	cd_perfil = cd_perfil_p;

		insert into reconciliacao_paciente(
				nr_sequencia,
				nr_atendimento,
				nm_usuario,
				nm_usuario_nrec,
				cd_perfil,
				dt_atualizacao_nrec,
				dt_status,
				ie_momento,
				ie_status)
		values (
				nextval('reconciliacao_paciente_seq'),
				nr_atendimento_p,
				nm_usuario_p,
				nm_usuario_p,
				cd_perfil_w,
				clock_timestamp(),
				null,
				ie_momento_p,
				ie_status_p);
	end;
else
	begin
		update	reconciliacao_paciente
		set		ie_status 			= ie_status_p,
				ie_momento			= ie_momento_p,
				dt_status 			= clock_timestamp(),
				ds_justificativa 		= ds_justificativa_p,
				nm_usuario_nrec 		= nm_usuario_p,
				dt_atualizacao_nrec 		= clock_timestamp()
		where	nr_atendimento 			= nr_atendimento_p
		and		nr_sequencia 			= nr_sequencia_w;
	end;
end if;

if (ie_commit_p = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_reconciliacao_paciente ( nm_usuario_p text, nr_atendimento_p bigint, cd_perfil_p bigint, ie_momento_p text, ie_status_p text, ds_justificativa_p text default null, ie_commit_p text default 'S') FROM PUBLIC;

