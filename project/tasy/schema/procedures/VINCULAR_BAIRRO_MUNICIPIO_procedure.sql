-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vincular_bairro_municipio ( nm_usuario_p text) AS $body$
DECLARE


cd_cep_w			varchar(8);
cd_municipio_ibge_w		varchar(6);
nr_seq_loc_w			bigint;
nr_seq_bairro_w			bigint;

C01 CURSOR FOR
	SELECT	/* +RULE */
		a.cd_cep,
		a.cd_municipio_ibge
	from	sus_cep		a
	where	exists (SELECT	1
			from	cep_bairro	y,
				cep_log		x
			where	x.cd_cep	= a.cd_cep
			and	y.nr_seq_loc	= x.nr_seq_loc
			and	coalesce(y.cd_municipio_ibge::text, '') = '');

C02 CURSOR FOR
	SELECT	/* +RULE */
		d.nr_seq_loc
	from	cep_log		d
	where	d.cd_cep	= cd_cep_w
	and	exists (SELECT	1
			from	cep_bairro	x
			where	x.nr_seq_loc	= d.nr_seq_loc
			and	coalesce(x.cd_municipio_ibge::text, '') = '');

C03 CURSOR FOR
	SELECT	c.nr_sequencia
	from	cep_bairro	c
	where	c.nr_seq_loc	= nr_seq_loc_w;


BEGIN
CALL gravar_processo_longo(obter_desc_expressao(775054),'VINCULAR_BAIRRO_MUNICIPIO',0);

open C01;
loop
fetch C01 into
	cd_cep_w,
	cd_municipio_ibge_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	CALL gravar_processo_longo(substr(obter_desc_municipio_ibge(cd_municipio_ibge_w),1,255),'VINCULAR_BAIRRO_MUNICIPIO',-1);

	open C02;
	loop
	fetch C02 into
		nr_seq_loc_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		CALL gravar_processo_longo(substr(obter_desc_cep_loc(nr_seq_loc_w),1,255),'VINCULAR_BAIRRO_MUNICIPIO',-1);

		open C03;
		loop
		fetch C03 into
			nr_seq_bairro_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			CALL gravar_processo_longo(substr(obter_desc_cep_bairro(nr_seq_bairro_w,nr_seq_loc_w),1,255),'VINCULAR_BAIRRO_MUNICIPIO',-1);

			update	cep_bairro
			set	cd_municipio_ibge	= cd_municipio_ibge_w,
				nm_usuario		= nm_usuario_p
			where	nr_sequencia		= nr_seq_bairro_w;
			end;
		end loop;
		close C03;
		end;
	end loop;
	close C02;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vincular_bairro_municipio ( nm_usuario_p text) FROM PUBLIC;

