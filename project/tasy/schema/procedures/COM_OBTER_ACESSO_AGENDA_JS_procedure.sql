-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE com_obter_acesso_agenda_js ( nm_usuario_p text, cd_pf_solicitante_p text, ds_msg_p INOUT text, nm_usu_perm_p INOUT text) AS $body$
DECLARE

 
nm_usuario_perm_w	varchar(15);
nm_usuario_solic_w	varchar(15);
ie_permite_acesso_w	varchar(1) := 'N';
nm_pessoa_fisica_w   varchar(60);
					
					 
C01 CURSOR FOR 
	SELECT	substr(a.nm_usuario,1,15) 
	FROM 	usuario a, 
		agenda_tasy_perm c 
	WHERE 	a.nm_usuario 	  = c.nm_usuario_agenda  
	AND 	c.nm_usuario_perm  = nm_usuario_p 
	AND 	c.nm_usuario_agenda <> nm_usuario_p 
	and	c.ie_agenda <> 'N' 
	AND 	a.ie_situacao = 'A';					
					 

BEGIN 
 
nm_usu_perm_p := nm_usuario_p;
 
if (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') and (cd_pf_solicitante_p IS NOT NULL AND cd_pf_solicitante_p::text <> '') then 
 
	nm_usuario_solic_w := obter_usuario_pf(cd_pf_solicitante_p);
	 
	select	substr(obter_nome_pf(cd_pf_solicitante_p),1,60) 
	into STRICT	nm_pessoa_fisica_w 
	from 	pessoa_fisica 
	where	cd_pessoa_fisica = cd_pf_solicitante_p;
	 
	if (nm_usuario_solic_w = nm_usuario_p) then 
		ie_permite_acesso_w := 'S';
	else 
		ie_permite_acesso_w := 'N';
		nm_usu_perm_p := nm_usuario_solic_w;
		 
		open C01;
		loop 
		fetch C01 into	 
			nm_usuario_perm_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin 
			if (nm_usuario_perm_w = nm_usuario_solic_w) then 
				ie_permite_acesso_w := 'S';
			end if;
			end;
		end loop;
		close C01;
	end if;
end if;
 
if (ie_permite_acesso_w = 'N') then 
	ds_msg_p := substr(obter_texto_dic_objeto(326734, wheb_usuario_pck.get_nr_seq_idioma, 'NM_PESSOA='||nm_pessoa_fisica_w),1,255);
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE com_obter_acesso_agenda_js ( nm_usuario_p text, cd_pf_solicitante_p text, ds_msg_p INOUT text, nm_usu_perm_p INOUT text) FROM PUBLIC;

