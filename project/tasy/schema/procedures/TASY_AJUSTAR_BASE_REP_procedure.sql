-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_ajustar_base_rep ( nm_usuario_p text) AS $body$
DECLARE


dt_versao_atual_cliente_w 	timestamp;
ie_nr_prescr_nullable_w		varchar(1);
qt_registros_w			bigint;
data_type_w			varchar(255);


BEGIN
/*FAVOR COLOCAR OS NOVOS AJUSTES SEMPRE NO FINAL DA PROCEDURE.*/

/*AJUSTES DE BASE DO GRUPO ASSISTENCIAL REP */

CALL abortar_se_base_wheb();

dt_versao_atual_cliente_w := coalesce(TO_DATE(TO_CHAR(obter_data_geracao_versao-1,'dd/mm/yyyy') ||' 23:59:59','dd/mm/yyyy hh24:mi:ss'),clock_timestamp() - interval '90 days');

if (dt_versao_atual_cliente_w < to_date('21/07/2009','dd/mm/yyyy')) then
	begin
	CALL exec_sql_dinamico('rfcaldas', 'alter table  prescr_recomendacao modify (DS_RECOMENDACAO varchar2(2000))');
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('10/06/2010','dd/mm/yyyy')) then
	CALL Exec_sql_Dinamico('rfcaldas',	' update tipo_recomendacao '||
					' set ie_situacao = ''A'' ' ||
					' where ie_situacao = ''S'' ');
	CALL Exec_sql_Dinamico('rfcaldas',	' update tipo_recomendacao '||
					' set ie_situacao = ''I'' ' ||
					' where ie_situacao = ''N'' ');

	CALL Exec_sql_Dinamico('vhkrausser',	' update TABELA_ATRIBUTO  ' ||
					' set DS_VALORES =    ''SELECT	CD_TIPO_RECOMENDACAO CD, '  ||
					' 				DS_TIPO_RECOMENDACAO DS  '  ||
					'			FROM	TIPO_RECOMENDACAO        '  ||
					'			WHERE	NR_SEQ_CLASSIF = :nr_seq_classif ' ||
					' 			and	ie_situacao = ''A''      '  ||
					'			ORDER BY 2 ''     ' ||
					' where	nm_atributo = ''CD_RECOMENDACAO'' ' ||
					' and	nm_tabela = ''PROTOCOLO_MEDIC_REC'' ');
	CALL Exec_sql_Dinamico('vhkrausser',	' update TABELA_VISAO_ATRIBUTO  ' ||
					' set DS_VALORES =    ''SELECT CD_TIPO_RECOMENDACAO CD, DS_TIPO_RECOMENDACAO DS FROM TIPO_RECOMENDACAO ' ||
					'			WHERE ((NR_SEQ_CLASSIF = :nr_seq_classif) or (:nr_seq_classif = -20)) ' ||
					'			and ie_situacao = ''A'' ' ||
					'			ORDER BY 2 ''     ' ||
					' where	nm_atributo = ''CD_RECOMENDACAO'' ' ||
					' AND	   NR_SEQUENCIA = 311		  ');
end if;

if (dt_versao_atual_cliente_w < to_date('10/06/2010','dd/mm/yyyy')) then
	CALL Exec_sql_Dinamico('rfcaldas',	' alter table CONTROLE_ACESSO_VISITA modify (CD_SETOR_ATENDIMENTO   null)');
end if;

if (dt_versao_atual_cliente_w < to_date('12/07/2010','dd/mm/yyyy')) then
	CALL Exec_sql_Dinamico('rfcaldas',	' update CONVENIO_SOLIC_EXAME_REL a set nr_seq_relatorio = (select max(nr_sequencia)  from relatorio x  where x.cd_relatorio = a.cd_relatorio) ');
	CALL Exec_sql_Dinamico('rfcaldas',	' alter table CONVENIO_SOLIC_EXAME_REL modify CD_RELATORIO null');
end if;

if (dt_versao_atual_cliente_w < to_date('20/07/2010','dd/mm/yyyy')) then
	CALL Exec_sql_Dinamico('rfcaldas',	' alter table PLT_REGRA_LIB_ITEM drop constraint PLTREGL_PLTREGO_FK ');
	CALL Exec_sql_Dinamico('rfcaldas',	' drop index PLTREGL_PLTREGO_FK_I');
end if;

if (dt_versao_atual_cliente_w < to_date('24/09/2010','dd/mm/yyyy')) then
	CALL Exec_sql_Dinamico('rfcaldas',	'delete	from VALOR_DOMINIO where	cd_dominio = 1269 and	vl_dominio = ''R'' ');
end if;

if (dt_versao_atual_cliente_w < to_date('10/01/2011','dd/mm/yyyy')) then
	CALL Exec_sql_Dinamico('rfcaldas',	'update valor_dominio set ds_valor_dominio = ''Liberação enfermagem'' where cd_dominio = 2132 and vl_dominio = ''E'' ');
end if;

if (dt_versao_atual_cliente_w < to_date('19/01/2011','dd/mm/yyyy')) then

	select  max(nullable)
	into STRICT 	ie_nr_prescr_nullable_w
	from 	user_tab_columns
	where 	table_name = 'W_ITEM_PRESCR'
	and 	column_name = 'NR_PRESCRICAO';

	if (ie_nr_prescr_nullable_w = 'N') then
		CALL Exec_sql_Dinamico('rfcaldas',	'alter table w_item_prescr modify nr_prescricao null');
	end if;
end if;

if (dt_versao_atual_cliente_w < to_date('02/03/2011','dd/mm/yyyy')) then

	select 	count(*)
	into STRICT	qt_registros_w
	from 	user_cons_columns
	where 	constraint_name = 'ADEPMAT_UK';

	if (qt_registros_w > 0) then
		CALL Exec_sql_Dinamico('rfcaldas','ALTER TABLE ADEP_MATERIAL DROP CONSTRAINT ADEPMAT_UK');
	end if;
end if;

if (dt_versao_atual_cliente_w < to_date('01/07/2011','dd/mm/yyyy')) then
	CALL tasy_posicionar_sequence('FORMA_LAUDO_HIST','NR_SEQUENCIA','N');
end if;

if (dt_versao_atual_cliente_w < to_date('21/07/2011','dd/mm/yyyy')) then
	CALL Exec_sql_Dinamico('rfcaldas','update TABELA_ATRIBUTO set	VL_DEFAULT	= ''A'' where	nm_atributo	= ''IE_RESERVADO'' and	nm_tabela	= ''SAN_INDICACAO'' ');
end if;

if (dt_versao_atual_cliente_w < to_date('15/05/2011','dd/mm/yyyy')) then
	CALL Exec_sql_Dinamico('rfcaldas','update	PE_PRESCR_PROC set	IE_PROFISSIONAL = null where	IE_PROFISSIONAL is not null');
end if;

if (dt_versao_atual_cliente_w < to_date('10/11/2011','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registros_w
	from	user_views
	where	upper(view_name) = upper('ADEP_PEND_PA_V2');

	if (qt_registros_w > 0) then
		CALL Exec_Sql_Dinamico('rfcaldas','drop view ADEP_PEND_PA_V2');
	end if;
end if;

if (dt_versao_atual_cliente_w < to_date('23/04/2012','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registros_w
	from	VALOR_DOMINIO
	where	cd_dominio	= 3598
	and	VL_DOMINIO	= 'N';

	if (qt_registros_w = 0) then
		CALL Exec_sql_Dinamico('pfsilva','update	PACIENTE_ATEND_MEDIC set	ie_pre_medicacao = ''N'' where	ie_pre_medicacao = ''M'' and	dt_atualizacao	> sysdate - 60');
		CALL Exec_sql_Dinamico('pfsilva','update	PACIENTE_ATEND_SOLUC set	ie_pre_medicacao = ''N'' where	ie_pre_medicacao = ''M'' and	dt_atualizacao	> sysdate - 60');
		CALL Exec_sql_Dinamico('pfsilva','update	PACIENTE_PROTOCOLO_SOLUC set	ie_pre_medicacao = ''N'' where	ie_pre_medicacao = ''M'' and	dt_atualizacao	> sysdate - 60');
		CALL Exec_sql_Dinamico('pfsilva','update	PRESCR_MATERIAL set	ie_pre_medicacao = ''N'' where	ie_pre_medicacao = ''M'' and	dt_atualizacao	> sysdate - 60');
		CALL Exec_sql_Dinamico('pfsilva','update	PRESCR_SOLUCAO set	ie_pre_medicacao = ''N'' where	ie_pre_medicacao = ''M'' and	dt_atualizacao	> sysdate - 60');
		CALL Exec_sql_Dinamico('pfsilva','update	PROTOCOLO_MEDIC_MATERIAL set	ie_pre_medicacao = ''N'' where	ie_pre_medicacao = ''M'' and	dt_atualizacao	> sysdate - 60');
		CALL Exec_sql_Dinamico('pfsilva','update	PROTOCOLO_MEDIC_SOLUCAO set	ie_pre_medicacao = ''N'' where	ie_pre_medicacao = ''M'' and	dt_atualizacao	> sysdate - 60');
	end if;
end if;

if (dt_versao_atual_cliente_w < to_date('15/05/2012','dd/mm/yyyy')) then
	CALL Exec_sql_Dinamico('rfcaldas','update	VALOR_DOMINIO set DS_VALOR_DOMINIO = ''Suplemento/Modul/Pediátrico'' where cd_dominio = 1942 and vl_dominio = ''SMP'' ');
end if;

if (dt_versao_atual_cliente_w < to_date('12/07/2012','dd/mm/yyyy')) then
	CALL Exec_sql_Dinamico('Edilson','Drop Index PRESMAT_PRESMAT_FK2_I');
	CALL Exec_sql_Dinamico('Edilson','Create Index PRESMAT_PRESMAT_FK2_I on PRESCR_MATERIAL(NR_PRESCRICAO,NR_SEQ_MEDIC_MATERIAL)');
end if;

if (dt_versao_atual_cliente_w < to_date('04/09/2012','dd/mm/yyyy')) then
	SELECT	count(*)
	into STRICT	qt_registros_w
	FROM	TABELA_VISAO_ATRIBUTO
	WHERE	NM_ATRIBUTO = 'IE_DISPOSITIVO_INFUSAO'
	AND	nr_sequencia = 5188;

	if (qt_registros_w = 0) then
		INSERT INTO TABELA_VISAO_ATRIBUTO( NR_SEQUENCIA, NM_ATRIBUTO, DT_ATUALIZACAO, NM_USUARIO, NR_SEQ_APRESENT, QT_TAM_DELPHI, QT_TAM_GRID, QT_DESLOC_DIREITA, NR_SEQ_GRID, NR_SEQ_TABSTOP, DS_LABEL, DS_LABEL_GRID, VL_PADRAO, DS_MASCARA, IE_READONLY, IE_TABSTOP, QT_ALTURA, CD_DOMINIO, NR_SEQ_LOCALIZADOR, DS_VALORES, NR_SEQ_ORDEM, QT_COLUNA, DS_FILTER, DS_LABEL_LONGO, IE_CRIAR_DESCRICAO, IE_OBRIGATORIO, DS_COR, IE_COMPONENTE, NM_ATRIBUTO_PAI, QT_TAM_FONTE, DS_ESTILO_FONTE, IE_APLICABILIDADE_ESTILO, IE_DBL_CLICK_READONLY, IE_TIPO_BOTAO, IE_TOTALIZAR, DS_COMANDO ) VALUES (
		5188, 'IE_DISPOSITIVO_INFUSAO',  TO_Date( '08/31/2012 03:47:10 TARDE', 'MM/DD/YYYY HH:MI:SS AM')
		, 'rfcaldas', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 'N', NULL, 'N', 'S'
		, NULL, 1537, NULL, NULL, NULL, NULL, NULL, NULL, 'N', NULL, NULL, 'lcb', NULL, NULL
		, NULL, NULL, NULL, NULL, NULL, NULL);
		commit;
	end if;
end if;

if (dt_versao_atual_cliente_w < to_date('21/09/2012','dd/mm/yyyy')) then
	CALL Exec_sql_Dinamico('rfcaldas','update	VALOR_DOMINIO set	DS_VALOR_DOMINIO = ''Alteração do item no ADEP'' where	VL_DOMINIO = ''ADAD'' and	cd_dominio = 3241 ');
end if;

if (dt_versao_atual_cliente_w < to_date('26/11/2012','dd/mm/yyyy')) then
	CALL Exec_sql_Dinamico('rfcaldas','update rep_regra_copia_crit set ie_regra_geral = ''H'' where ie_tipo_item = ''REC'' ');
	CALL tasy_posicionar_sequence('REP_ITEM_ELIMINADO','NR_SEQUENCIA','N');
end if;

if (dt_versao_atual_cliente_w < to_date('28/11/2012','dd/mm/yyyy')) then
	CALL Exec_sql_Dinamico('rfcaldas','update valor_dominio set ds_valor_dominio = ''Não, considerando a liberação do médico e médico auxiliar'' where cd_dominio = 4597 and vl_dominio = ''N'' ');
end if;

if (dt_versao_atual_cliente_w < to_date('26/01/2013','dd/mm/yyyy')) then
	CALL tasy_posicionar_sequence('REP_ITEM_ELIMINADO','NR_SEQUENCIA','N');
end if;

if (dt_versao_atual_cliente_w < to_date('05/02/2013','dd/mm/yyyy')) then
	CALL Exec_sql_Dinamico('rfcaldas','update setor_intervalo set ie_exibir = ''S'' ');
end if;

if (dt_versao_atual_cliente_w < to_date('17/05/2013','dd/mm/yyyy')) then
	select	count(*)
	into STRICT	qt_registros_w
	from	user_constraints
	where	constraint_name = 'PRESMAT_REGLODI_FK';
	if (qt_registros_w > 0) then
		CALL Exec_sql_Dinamico('rfcaldas','alter table prescr_material drop constraint PRESMAT_REGLODI_FK');
	end if;
end if;

if (dt_versao_atual_cliente_w < to_date('30/12/2013','dd/mm/yyyy')) then
	begin

	select	count(*)
	into STRICT	qt_registros_w
	from	user_tab_columns
	where	table_name		= 'REGRA_GERACAO_CONSENT'
	and	column_name		= 'DS_TEXTO'
	and	upper(data_type)	= 'LONG';
	if (qt_registros_w = 0) then
		CALL Exec_Sql_Dinamico('pfsilva','alter table REGRA_GERACAO_CONSENT add DS_TEXTO_long long');
		CALL Exec_Sql_Dinamico('pfsilva','update REGRA_GERACAO_CONSENT set DS_TEXTO_long = DS_TEXTO');
		CALL Exec_Sql_Dinamico('pfsilva','alter table REGRA_GERACAO_CONSENT drop column DS_TEXTO');
		CALL Exec_Sql_Dinamico('pfsilva','alter table REGRA_GERACAO_CONSENT rename column DS_TEXTO_long to DS_TEXTO');
	end if;
	exception
		when others then
		null;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('27/07/2015','dd/mm/yyyy')) then
	begin
	select	count(*)
	into STRICT	qt_registros_w
	from	user_tab_columns
	where	table_name		= 'CPOE_MATERIAL'
	and		column_name		= 'DS_HORARIOS'  LIMIT 1;

	if (qt_registros_w > 0) then
		CALL exec_sql_dinamico('hhlopes',' update cpoe_material set ds_horarios = replace(ds_horarios, ''__:__'', '''') where instr(ds_horarios,''__:__'') > 0 ');
		CALL exec_sql_dinamico('hhlopes',' update cpoe_material set ds_horarios = replace(replace(ds_horarios, ''  '','' ''),''  '','' '') where instr(ds_horarios,''  '') > 0 ');
		CALL exec_sql_dinamico('hhlopes',' update cpoe_material set ds_horarios = replace(ds_horarios, ''das  às'',null) where instr(ds_horarios,''das  às'') > 0 ');
		CALL exec_sql_dinamico('hhlopes',' update cpoe_material set ds_horarios = replace(replace(ds_horarios, ''  '','' ''),''  '','' '') where instr(ds_horarios,''  '') > 0 ');
		CALL exec_sql_dinamico('hhlopes',' update cpoe_material set ds_horarios = replace(padroniza_horario_prescr(ds_horarios,null),''A'',null) where instr(ds_horarios,''das'') > 0 ');
		CALL exec_sql_dinamico('hhlopes',' update cpoe_material set ds_horarios = replace(ds_horarios,'';'',null) where instr(ds_horarios,'';'') > 0 ');
	end if;

	exception
		when others then
		null;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('10/07/2015','dd/mm/yyyy')) then
	begin
	CALL exec_sql_dinamico('cpdias',' delete from regra_dose_terap where nr_sequencia = 73 ');
	exception
		when others then
		null;
	end;
end if;


if (dt_versao_atual_cliente_w < to_date('06/06/2016','dd/mm/yyyy')) then
	begin
	CALL exec_sql_dinamico('rzimmermann','UPDATE via_aplicacao a '+
									'SET    NR_SEQ_VIA_ANVISA = (SELECT MAX(nr_sequencia) FROM ANVISA_VIA_ADMINISTRACAO WHERE UPPER(IE_ABREVIACAO_VIA) = UPPER(a.ie_via_aplicacao)) '+
									'WHERE  EXISTS (SELECT 1 FROM ANVISA_VIA_ADMINISTRACAO WHERE UPPER(IE_ABREVIACAO_VIA) = UPPER(a.ie_via_aplicacao)) ');

	exception
		when others then
		null;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('30/06/2016','dd/mm/yyyy')) then
	begin
	CALL exec_sql_dinamico('rzimmermann','UPDATE UNIDADE_MEDIDA a  ' +
									'SET    IE_UNIDADE_MED_INTER = (SELECT VL_DOMINIO FROM VALOR_DOMINIO ' +
								    '	    		WHERE cd_dominio = 7978 ' +
									'    			  AND UPPER(VL_DOMINIO) = UPPER(a.cd_unidade_medida)) ' +
									'WHERE  EXISTS (SELECT 1 FROM VALOR_DOMINIO ' +
								    '	    		WHERE cd_dominio = 7978 ' +
									'    			  AND UPPER(VL_DOMINIO) = UPPER(a.cd_unidade_medida)) ');

	exception
		when others then
		null;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('12/07/2017','dd/mm/yyyy')) then
	begin
		CALL exec_sql_dinamico('ckroplin',' update valor_dominio set ie_situacao = ''I'' where cd_dominio = 7040 and vl_dominio = ''TE'' ');

	exception
		when others then
		null;
	end;
end if;


if (dt_versao_atual_cliente_w < to_date('25/08/2017','dd/mm/yyyy')) then
	begin


	select	max(data_type)
	into STRICT	data_type_w
	from	user_tab_columns
	where	table_name	= 'CARTA_MEDICA'
	and	column_name = 'DS_CARTA';


	if (data_type_w	= 'LONG') then

		CALL exec_sql_dinamico('pfsilva', 'alter table carta_medica modify DS_CARTA clob ');
	end if;

	exception
		when others then
		null;
	end;
end if;

if (dt_versao_atual_cliente_w < to_date('11/04/2018','dd/mm/yyyy')) then
	begin
		CALL exec_sql_dinamico('jlweigmann',' update valor_dominio set IE_HTML5 = ''A'' where cd_dominio = 4022 and vl_dominio = ''S'' ');
		CALL exec_sql_dinamico('jlweigmann',' update valor_dominio set IE_HTML5 = ''A'' where cd_dominio = 4022 and vl_dominio = ''N'' ');
		CALL exec_sql_dinamico('jlweigmann',' update valor_dominio set IE_HTML5 = ''I'' where cd_dominio = 4022 and vl_dominio = ''E'' ');
		CALL exec_sql_dinamico('jlweigmann',' update valor_dominio set IE_HTML5 = ''I'' where cd_dominio = 4022 and vl_dominio = ''C'' ');
		CALL exec_sql_dinamico('jlweigmann',' update valor_dominio set IE_HTML5 = ''I'' where cd_dominio = 4022 and vl_dominio = ''I'' ');
		CALL exec_sql_dinamico('jlweigmann',' update valor_dominio set IE_HTML5 = ''I'' where cd_dominio = 4022 and vl_dominio = ''T'' ');

	exception
		when others then
		null;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_ajustar_base_rep ( nm_usuario_p text) FROM PUBLIC;

