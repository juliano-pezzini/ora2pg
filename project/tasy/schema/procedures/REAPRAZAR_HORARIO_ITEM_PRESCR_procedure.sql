-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE colunas AS (  
			nr_prescricao_w    		bigint,
            nr_seq_item_w    		bigint,
            nr_seq_horario_w  		bigint,
            nr_seq_processo_w  		bigint,
            nr_agrupamento_w  		double precision,
            dt_horario_w    		timestamp,
            nr_etapa_w      		smallint,
            nr_seq_solucao_w  		bigint,
            ie_item_associado_w 	varchar(3),
            ie_acm_sn_ww    		varchar(1),
            cd_material_exame_w 	varchar(20),
            cd_material_w    		bigint,
            cd_intervalo_w    		varchar(7),
            qt_material_w       	double precision,
            nr_seq_cpoe_w    		bigint,
			nr_sequencia_proc_w		bigint,
			ds_item_w				varchar(255),
			ie_se_necessario_w		varchar(1),
			ie_acm_w				varchar(1),
			ie_urgente_w			varchar(1));


CREATE OR REPLACE PROCEDURE reaprazar_horario_item_prescr ( cd_estabelecimento_p bigint, nr_atendimento_p bigint, ie_tipo_item_p text, cd_item_p text, cd_intervalo_p text, qt_item_p bigint, dt_horario_p timestamp, dt_horario_desejado_p timestamp, ie_reaprazar_seguintes_p text, nr_prescricoes_p text, nr_prescricao_p bigint, nr_seq_item_p bigint, ie_laboratorio_p text, nr_seq_motivo_p bigint, ds_justificativa_p text, nm_usuario_p text, ds_lista_eliminados_p INOUT text, nr_seq_proc_interno_p bigint, ds_inconsist_lote_p INOUT text, nr_agrupamento_p bigint, ie_acm_sn_p text, nr_seq_assinatura_p bigint default null, ie_reaprazar_exame_mat_p text DEFAULT NULL, nr_ciclo_p bigint DEFAULT NULL, ie_reaprazar_item_ciclo_p text DEFAULT NULL, cd_unidade_medida_p text DEFAULT NULL, ds_componentes_p text DEFAULT NULL, ie_via_aplicacao_p text default null, nr_seq_prot_glic_p bigint default null, ds_item_p text default '', cd_funcao_p bigint default null, ds_observacao_p text default null, nr_seq_cpoe_p bigint default null, nr_seq_horario_p prescr_mat_hor.nr_sequencia%type default null) AS $body$
DECLARE


ora2pg_rowcount int;
/* vetor */

type vetor is table of colunas index by integer;
vetor_w      vetor;

dt_suspensao_cpoe_w			timestamp;
dt_fim_cpoe_w				timestamp;
cd_setor_atendimento_w  	integer;
cd_local_estoque_w      	integer;
nr_prescricao_w      		bigint;
nr_prescricao_ww    		bigint;
nr_prescricao_log_w  		bigint;
nr_seq_item_w      			bigint;
nr_seq_item_ww      		bigint;
qt_suspenso_w 				bigint;
nr_seq_horario_w    		bigint;
nr_seq_horario_ww   		bigint;
nr_etapa_sol_w      		smallint;
qt_minutos_w      			bigint;
nr_prescr_atual_w    		bigint := 0;
nr_seq_processo_w    		bigint;
nr_seq_processo_ww    		bigint;
nr_seq_solucao_w    		bigint;
nr_seq_processo_novo_w  	bigint;
nr_agrupamento_w    		double precision;
nr_agrupamento_ww   		double precision;
varsql_row_count_w    		bigint;
nr_seq_lote_w      			bigint;
cont_w          			bigint := 0;
qt_registros_vetor_w  		bigint;
qt_controle_ww      		bigint := 0;
x            				bigint := 0;
nr_sequencia_w      		bigint;
cd_setor_pac_w      		bigint;
cd_material_w      			bigint;
ie_item_associado_w 		varchar(3);
ds_lista_eliminados_w 		varchar(255);
ds_status_w        			varchar(255);
ds_item_w        			varchar(255);
ie_entrou_w        			varchar(2);
ds_param_proc_w      		varchar(2000);
cd_material_exame_w    		varchar(20);
ie_reaprazar_assoc_w  		varchar(1);
ie_proc_associados_w  		varchar(1);
ie_acm_w        			varchar(1);
ie_sn_w          			varchar(1);
ie_acm_sn_w        			varchar(1);
ie_acm_sn_ww      			varchar(1) := null;
ie_elimina_horario_w  		varchar(1)  := 'S';
ie_desagrupa_proced_w  		varchar(1);
ie_perm_ant_validade_w  	varchar(1);
ie_inativa_horario_ant_w 	varchar(1);
ie_data_proc_w      		varchar(15);
ie_data_lib_prescr_w  		varchar(15);
ie_exibe_suspenso_w			varchar(15);
ie_gera_lote_w      		varchar(1);
ie_consiste_lote_atendido_w varchar(2);
ie_status_lote_w    		varchar(255);
dt_horario_w      			timestamp;
dt_horario_ww      			timestamp;
dt_horario_desejado_w  		timestamp;
dt_horario_desejado_ww		timestamp;
ie_operacao_w      			varchar(3);
qt_operacao_w      			bigint;
ie_24_h_w        			varchar(1);
dt_proxima_dose_w    		timestamp;
dt_proxima_dose_new_w  		timestamp;
cd_estabelecimento_w  		estabelecimento.cd_estabelecimento%type;
cd_evolucao_w      			bigint;
nr_seq_item_cpoe_w      	bigint;
ie_tipo_dieta_cpoe_w    	varchar(10);
ie_tipo_item_w        		varchar(5);
ds_erro_w        			varchar(255);
ds_erro2_w       		 	varchar(255);
qt_max_prescricao_w    		double precision;
cd_unidade_medida_consumo_w varchar(30);
cd_unid_med_limite_w    	varchar(30);
qt_limite_pessoa_w      	double precision;
ie_dose_limite_w      		varchar(15);
cd_intervalo_w        		varchar(7);
cd_material_ww        		prescr_material.cd_material%type;
cd_intervalo_ww        		prescr_material.cd_intervalo%type;
qt_item_ww          		prescr_material.qt_material%type;
cd_item_w          			bigint;
cd_intervalo_www      		prescr_material.cd_intervalo%type;
qt_item_w          			prescr_material.qt_material%type;
nr_seq_cpoe_w        		cpoe_material.nr_sequencia%type;
nr_seq_mat_cpoe_w			cpoe_material.nr_sequencia%type;
nr_seq_mat_cpoe_w2    cpoe_material.nr_sequencia%type;
cd_funcao_origem_w			prescr_medica.cd_funcao_origem%type;
ie_tipo_cons_w        		varchar(1);
ds_msg_w					varchar(255);
qt_dose_limite_w			double precision;
cd_unidade_medida_limte_w	varchar(15);
cd_pessoa_fisica_w			atendimento_paciente.cd_pessoa_fisica%type;
ie_atualizou_medic_w		varchar(1) := 'N';
ie_gerou_lt_novo_proc_w		boolean := false;
nr_sequencia_proc_ww		prescr_material.nr_sequencia_proc%type;
nr_sequencia_proc_w			prescr_material.nr_sequencia_proc%type;
ie_validar_lote_w			boolean;
nr_prescricao_w2      prescr_medica.nr_prescricao%type := 0;
ie_gera_sem_certificado_w	varchar(1);
ie_apraz_regra_w			varchar(1);
exec_w         				varchar(32000);
nr_seq_turno_hor_ag_w		bigint;
hr_turno_agora_w			varchar(15);
hr_final_turno_agora_w		varchar(15);
qt_min_antes_atend_w		integer;
dt_limite_agora_w			timestamp;
dt_limite_especial_w		timestamp;
dt_inicio_prescr_w			prescr_medica.dt_inicio_prescr%type;
ie_agora_impressao_w 		parametros_farmacia.ie_forma_agora%type;
ie_classif_nao_padrao_w		parametros_farmacia.ie_classif_urgencia%type;
ie_classif_normal_acm_sn_w	parametros_farmacia.ie_classif_normal_acm_sn%type;
qt_min_agora_w				parametros_farmacia.qt_min_agora%type;
qt_min_especial_w			parametros_farmacia.qt_min_especial%type;
ie_classif_lote_w			parametros_farmacia.ie_classif_lote%type;
ie_se_necessario_w			prescr_material.ie_se_necessario%type;
ie_urgente_w				prescr_material.ie_urgencia%type;
ie_se_necessario_ww			prescr_material.ie_se_necessario%type;
ie_acm_ww					prescr_material.ie_acm%type;
ie_urgente_ww				prescr_material.ie_urgencia%type;
ie_define_agora_w			regra_tempo_disp.ie_define_agora%type;
ie_classif_urgente_w		varchar(3);
nr_seq_classif_w			bigint;
ie_controlado_w				varchar(1);
ie_padronizado_w			varchar(1);
dt_liberacao_w				timestamp;
nr_seq_turno_hor_esp_w		bigint;
hr_turno_especial_w			varchar(15);
ie_grava_log_rastr_w		varchar(1);

/* dietas orais */

c01 CURSOR FOR
SELECT  a.nr_prescricao nr_prescricao,
		null nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		null nr_seq_processo,
		null nr_agrupamento,
		c.dt_horario,
		null
from  	prescr_dieta_hor c,
		prescr_medica a
where	c.nr_prescricao = a.nr_prescricao
and    obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w, a.ie_lib_farm) = 'S'
and    obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and    coalesce(c.ie_situacao,'A') = 'A'
and    coalesce(c.dt_fim_horario::text, '') = ''
and    coalesce(c.dt_suspensao::text, '') = ''
and    a.nr_atendimento = nr_atendimento_p
and    c.cd_refeicao = cd_item_p
and    obter_se_contido(a.nr_prescricao, '(' || nr_prescricoes_p || ')') = 'S'
and    (((ie_reaprazar_seguintes_p = 'S' AND c.dt_horario >= dt_horario_p) or
		 (ie_reaprazar_seguintes_p = 'N' AND c.dt_horario = dt_horario_p and qt_minutos_w > 0)) or (c.dt_horario = dt_horario_p and qt_minutos_w < 0))
and    Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and    a.dt_validade_prescr > clock_timestamp()
and    ie_tipo_item_p = 'D'

union

select  a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		null nr_seq_processo,
		null nr_agrupamento,
		c.dt_horario,
		b.nr_seq_dieta_cpoe
from	prescr_medica a,
		prescr_dieta b,
		prescr_dieta_hor c
where	c.nr_prescricao = a.nr_prescricao
and		c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_dieta  = b.nr_sequencia
and     obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w, a.ie_lib_farm) = 'S'
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		a.nr_atendimento = nr_atendimento_p
and		obter_se_contido(a.nr_prescricao, '(' || nr_prescricoes_p || ')') = 'S'
and		a.dt_validade_prescr > clock_timestamp()
and		to_char(b.cd_dieta) = cd_item_p
and		coalesce(c.cd_refeicao::text, '') = ''
and		(((ie_reaprazar_seguintes_p = 'S' AND c.dt_horario >= dt_horario_p) or
		  (ie_reaprazar_seguintes_p = 'N' AND c.dt_horario = dt_horario_p and qt_minutos_w > 0)) or (c.dt_horario = dt_horario_p and qt_minutos_w < 0))
and    Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and    ie_tipo_item_p = 'D'
order by 1, 2, 3;

/* suplementos orais */

c02 CURSOR FOR
SELECT  a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		c.nr_seq_processo,
		b.nr_agrupamento,
		c.dt_horario,
		b.nr_seq_dieta_cpoe,
		c.cd_material,
		coalesce(b.ie_se_necessario,'N'),
		coalesce(b.ie_acm,'N'),
		coalesce(b.ie_urgencia,'N')
from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where  c.nr_prescricao = b.nr_prescricao
and    c.nr_seq_material = b.nr_sequencia
and    b.nr_prescricao = a.nr_prescricao
and    obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, coalesce(a.dt_liberacao_farmacia,a.dt_liberacao), ie_data_lib_prescr_w) = 'S'
and    obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and    b.ie_agrupador in (12)
and    coalesce(c.ie_situacao,'A') = 'A'
and    coalesce(c.ie_horario_especial,'N') = 'N'
and    coalesce(c.dt_fim_horario::text, '') = ''
and    coalesce(c.dt_suspensao::text, '') = ''
and    a.nr_atendimento = nr_atendimento_p
and    obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S'
and    a.dt_validade_prescr > clock_timestamp()
and    b.cd_material = cd_item_p
and    coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and    coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))
and    (((ie_reaprazar_seguintes_p = 'S' AND c.dt_horario >= dt_horario_p) or
		 (ie_reaprazar_seguintes_p = 'N' AND c.dt_horario = dt_horario_p and qt_minutos_w > 0)) or (c.dt_horario = dt_horario_p and qt_minutos_w < 0))
and    Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and    ie_tipo_item_p = 'S'
order by 1, 2, 3;

/* medicamentos */

c03 CURSOR FOR
SELECT  a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		c.nr_seq_processo,
		b.nr_agrupamento,
		c.dt_horario,
		coalesce(b.ie_acm,'N'),
		coalesce(b.ie_se_necessario,'N'),
		b.nr_seq_mat_cpoe,
		c.cd_material,
		coalesce(b.ie_se_necessario,'N'),
		coalesce(b.ie_acm,'N'),
		coalesce(b.ie_urgencia,'N')
from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_material = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		obter_se_prescr_lib_adep(coalesce(a.dt_liberacao_medico, b.dt_lib_material), coalesce(a.dt_liberacao,b.dt_lib_material), coalesce(a.dt_liberacao_farmacia, b.dt_lib_farmacia), ie_data_lib_prescr_w) = 'S'
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		b.ie_agrupador in (1)
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.ie_adep,'S') = 'S'
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		a.nr_atendimento = nr_atendimento_p
and		obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S'
and		a.dt_validade_prescr > clock_timestamp()
and		b.cd_material = cd_item_p
and		coalesce(cd_unidade_medida_p,'XPTO') in ('XPTO', c.cd_unidade_medida_dose)
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p
and		coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))
and		((coalesce(ie_medicacao_paciente,'N') = 'N') or ((coalesce(ds_medic_nao_padrao::text, '') = '') or (upper(replace(ds_item_p, chr(39),''))  =  upper(replace(ds_medic_nao_padrao,chr(39),'''') || ' '||wheb_mensagem_pck.get_texto(494867)||''))))
and		(((ie_reaprazar_seguintes_p = 'S' AND c.dt_horario >= dt_horario_p) or
		  (ie_reaprazar_seguintes_p = 'N' AND c.dt_horario = dt_horario_p and qt_minutos_w > 0)) or (c.dt_horario = dt_horario_p and qt_minutos_w < 0))
and		((nr_agrupamento_p IS NOT NULL AND nr_agrupamento_p::text <> '' AND b.nr_agrupamento = nr_agrupamento_p) or
		 ((coalesce(nr_agrupamento_p::text, '') = '') and (obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material) = 'N')))
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		((coalesce(ie_via_aplicacao_p::text, '') = '') or (coalesce(b.ie_via_aplicacao, coalesce(ie_via_aplicacao_p, 'XPTO')) = ie_via_aplicacao_p))
and		ie_tipo_item_p in ('M', 'IAH')
and   ((a.nr_seq_atend IS NOT NULL AND a.nr_seq_atend::text <> '') or
      ((coalesce(b.nr_seq_mat_cpoe::text, '') = '') or (obter_se_material_padronizado(a.cd_estabelecimento, b.cd_material) = 'S') or (substr(upper(coalesce(b.ds_observacao,'XPTO')),1,255) = substr(upper(coalesce(ds_observacao_p,'XPTO')),1,255))))
and		((b.nr_seq_mat_cpoe = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(b.nr_seq_mat_cpoe::text, '') = '') or (coalesce(nr_seq_cpoe_p,0) = 0))
order by 1, 2, 3 desc;

/* materiais */

c04 CURSOR FOR
SELECT  a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		c.nr_seq_processo,
		b.nr_agrupamento,
		c.dt_horario,
		b.nr_seq_mat_cpoe,
		c.cd_material,
		coalesce(b.ie_se_necessario,'N'),
		coalesce(b.ie_acm,'N'),
		coalesce(b.ie_urgencia,'N')
from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_material = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		b.ie_agrupador in (2)
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		a.nr_atendimento = nr_atendimento_p
and		obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S'
and		a.dt_validade_prescr > clock_timestamp()
and		b.cd_material = cd_item_p
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))
and		(((ie_reaprazar_seguintes_p = 'S' AND c.dt_horario >= dt_horario_p) or
		  (ie_reaprazar_seguintes_p = 'N' AND c.dt_horario = dt_horario_p and qt_minutos_w > 0)) or (c.dt_horario = dt_horario_p and qt_minutos_w < 0))
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		ie_tipo_item_p = 'MAT'
order by 1, 2, 3;

/* procedimentos e controles de glicemia */

c05 CURSOR FOR
SELECT	a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		null nr_seq_processo,
		null nr_agrupamento,
		c.dt_horario,
		b.cd_material_exame,
		b.nr_seq_proc_cpoe,
		coalesce(b.ie_se_necessario,'N'),
		coalesce(b.ie_acm,'N'),
		coalesce(b.ie_urgencia,'N')
from	prescr_proc_hor c,
		prescr_procedimento b,
		prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_procedimento = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		(obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '')
and		obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		((coalesce(b.nr_seq_exame::text, '') = '' and ie_laboratorio_p = 'N') or ((b.nr_seq_exame IS NOT NULL AND b.nr_seq_exame::text <> '') and ie_laboratorio_p = 'S') or (ie_tipo_item_p in ('G','C')))
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		a.nr_atendimento = nr_atendimento_p
and		((ie_proc_associados_w = 'N') or (obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S'))		
and		(((b.nr_sequencia  = nr_Seq_item_p) and (b.nr_prescricao  = nr_prescricao_p) and (ie_desagrupa_proced_w = 'S')) or (ie_desagrupa_proced_w   = 'N'))		 
and		coalesce(a.dt_validade_prescr,a.dt_inicio_prescr + 24) > clock_timestamp()
and		b.cd_procedimento = cd_item_p
and		coalesce(b.nr_seq_prot_glic, coalesce(nr_seq_prot_glic_p, 0)) = coalesce(nr_seq_prot_glic_p, coalesce(b.nr_seq_prot_glic, 0))
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		coalesce(b.qt_procedimento,1) = coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
and		(((ie_reaprazar_seguintes_p = 'S' AND c.dt_horario >= dt_horario_p) or
		  (ie_reaprazar_seguintes_p = 'N' AND c.dt_horario = dt_horario_p and qt_minutos_w > 0)) or (c.dt_horario = dt_horario_p and qt_minutos_w < 0))
and		coalesce(b.nr_seq_proc_interno,0) = coalesce(nr_seq_proc_interno_p, 0)
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		ie_tipo_item_p in ('P','G','C','I')
and		((coalesce(ds_componentes_p::text, '') = '') or (ds_componentes_p = substr(obter_mat_med_assoc_proc(b.nr_prescricao, b.nr_sequencia, 'S'),1,240)))
order by 1, 2, 3;

/* recomendacoes */

c06 CURSOR FOR
SELECT  a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		null nr_seq_processo,
		null nr_agrupamento,
		c.dt_horario,
		b.nr_seq_rec_cpoe
from	prescr_rec_hor c,
		prescr_recomendacao b,
		prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_recomendacao = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		((ie_data_lib_prescr_w = 'F') or (obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'))
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		a.nr_atendimento = nr_atendimento_p
and		obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S'
and		a.dt_validade_prescr > clock_timestamp()
and		coalesce(to_char(b.cd_recomendacao),b.ds_recomendacao) = cd_item_p
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		coalesce(b.qt_recomendacao,1) = coalesce(qt_item_p,coalesce(b.qt_recomendacao,1))
and		(((ie_reaprazar_seguintes_p = 'S' AND c.dt_horario >= dt_horario_p) or
		  (ie_reaprazar_seguintes_p = 'N' AND c.dt_horario = dt_horario_p and qt_minutos_w > 0)) or (c.dt_horario = dt_horario_p and qt_minutos_w < 0))
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		ie_tipo_item_p = 'R'
order by 1, 2, 3;

/* sae */

c07 CURSOR FOR
SELECT	a.nr_sequencia nr_prescricao,
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		null nr_seq_processo,
		null nr_agrupamento,
		c.dt_horario
from	pe_prescr_proc_hor c,
		pe_prescr_proc b,
		pe_prescricao a
where	c.nr_seq_pe_proc = b.nr_sequencia
and		b.nr_seq_prescr = a.nr_sequencia
and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and		coalesce(b.ie_adep,'N') in ('S','M')
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		a.nr_atendimento = nr_atendimento_p
and		obter_se_prescr_adep(a.nr_sequencia, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S'
and		a.dt_validade_prescr > clock_timestamp()
and		b.nr_seq_proc = cd_item_p
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		(((ie_reaprazar_seguintes_p = 'S' AND c.dt_horario >= dt_horario_p) or
		  (ie_reaprazar_seguintes_p = 'N' AND c.dt_horario = dt_horario_p and qt_minutos_w > 0)) or (c.dt_horario = dt_horario_p and qt_minutos_w < 0))
and		ie_tipo_item_p = 'E'
order by 1, 2, 3;

/* Itens associados */

c08 CURSOR FOR
SELECT  a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		c.nr_seq_processo,
		b.nr_agrupamento,
		c.dt_horario,
		c.cd_material,
		coalesce(b.ie_se_necessario,'N'),
		coalesce(b.ie_acm,'N'),
		coalesce(b.ie_urgencia,'N')
from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_material = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		b.ie_agrupador in (5)
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.ie_adep,'S') = 'S'
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		a.nr_atendimento = nr_atendimento_p
and		obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S'
and		a.dt_validade_prescr > clock_timestamp()
and		b.cd_material = cd_item_p
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))
and		(((ie_reaprazar_seguintes_p = 'S' AND c.dt_horario >= dt_horario_p) or
		  (ie_reaprazar_seguintes_p = 'N' AND c.dt_horario = dt_horario_p and qt_minutos_w > 0)) or (c.dt_horario = dt_horario_p and qt_minutos_w < 0))
and		coalesce(b.ie_checar_adep, 'N') = 'S'
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		ie_tipo_item_p = 'IA'
order by 1, 2, 3;

/* Itens da solucao */

c09 CURSOR FOR
SELECT  a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		c.nr_seq_processo,
		b.nr_agrupamento,
		c.dt_horario,
		c.nr_etapa_sol,
		c.nr_seq_solucao,
		b.nr_seq_mat_cpoe,
		c.cd_material,
		coalesce(b.ie_se_necessario,'N'),
		coalesce(b.ie_acm,'N'),
		coalesce(b.ie_urgencia,'N')
from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_material = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		b.ie_agrupador in (4)
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.ie_adep,'S') = 'S'
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		((ie_reaprazar_seguintes_p = 'N' AND c.nr_etapa_sol = cd_item_p) or
		 (ie_reaprazar_seguintes_p = 'S' AND c.nr_etapa_sol >= cd_item_p))
and		a.nr_atendimento = nr_atendimento_p
and		a.nr_prescricao = nr_prescricao_p
and		c.nr_seq_solucao = nr_seq_item_p
and		a.dt_validade_prescr > clock_timestamp()
and		(((ie_reaprazar_seguintes_p = 'S' AND c.dt_horario >= dt_horario_p) or
		  (ie_reaprazar_seguintes_p = 'N' AND c.dt_horario = dt_horario_p and qt_minutos_w > 0)) or (c.dt_horario = dt_horario_p and qt_minutos_w < 0))
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		ie_tipo_item_p = 'SOL';

/* Itens associados ao Procedimento X*/

c10 CURSOR FOR
SELECT  a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		c.nr_seq_processo,
		b.nr_agrupamento,
		c.dt_horario,
		b.cd_intervalo,
		b.cd_material,
		b.qt_material,
		b.nr_sequencia_proc,
		coalesce(b.ie_se_necessario,'N'),
		coalesce(b.ie_acm,'N'),
		coalesce(b.ie_urgencia,'N')
from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_material = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		b.ie_agrupador in (5)
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.ie_adep,'S') = 'S'
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		a.nr_atendimento = nr_atendimento_p
and		c.nr_prescricao   = nr_prescricao_w
and		b.nr_sequencia_proc  = nr_seq_item_w
and		c.dt_horario = dt_horario_w
and    Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
order by 1, 2, 3;

/* Itens associados CCG */

c11 CURSOR FOR
SELECT  a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		c.nr_seq_processo,
		b.nr_agrupamento,
		c.dt_horario,
		c.cd_material,
		coalesce(b.ie_se_necessario,'N'),
		coalesce(b.ie_acm,'N'),
		coalesce(b.ie_urgencia,'N')
from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_material = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		b.ie_agrupador in (5)
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.ie_adep,'S') = 'S'
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		a.nr_atendimento = nr_atendimento_p
and		obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S'
and		a.dt_validade_prescr > clock_timestamp()
and		b.cd_material = cd_item_p
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		(((ie_reaprazar_seguintes_p = 'S' AND c.dt_horario >= dt_horario_p) or
          (ie_reaprazar_seguintes_p = 'N' AND c.dt_horario = dt_horario_p and qt_minutos_w > 0)) or (c.dt_horario = dt_horario_p and qt_minutos_w < 0))
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		ie_tipo_item_p = 'IAG'
order by 1, 2, 3;

/* medicamentos por ciclo */

c12 CURSOR FOR
SELECT  a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		c.nr_seq_processo,
		b.nr_agrupamento,
		c.dt_horario,
		coalesce(b.ie_acm,'N'),
		coalesce(b.ie_se_necessario,'N'),
		b.cd_material
from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a,
		paciente_atendimento d
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_material = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		a.nr_seq_atend = d.nr_seq_atendimento
and		obter_se_prescr_lib_adep(coalesce(a.dt_liberacao_medico, b.dt_lib_material), coalesce(a.dt_liberacao,b.dt_lib_material), coalesce(a.dt_liberacao_farmacia, b.dt_lib_farmacia), ie_data_lib_prescr_w) = 'S'
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		b.ie_agrupador in (1)
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.ie_adep,'S') = 'S'
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		a.nr_atendimento = nr_atendimento_p
and		a.dt_validade_prescr > clock_timestamp()
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p
and		((nr_agrupamento_p IS NOT NULL AND nr_agrupamento_p::text <> '' AND b.nr_agrupamento = nr_agrupamento_p) or
		 ((coalesce(nr_agrupamento_p::text, '') = '') and (obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material) = 'N')))
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		d.nr_ciclo = nr_ciclo_p
and		ie_tipo_item_p in ('M', 'IAH')
order by 1, 2, 3 desc;

/* Itens da solucao por ciclo */

C13 CURSOR FOR
SELECT  a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		c.nr_seq_processo,
		b.nr_agrupamento,
		c.dt_horario,
		c.nr_etapa_sol,
		c.nr_seq_solucao,
		b.cd_material
from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a,
		paciente_atendimento d
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_material = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		a.nr_seq_atend  = d.nr_seq_atendimento
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		b.ie_agrupador in (4)
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.ie_adep,'S') = 'S'
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		a.nr_atendimento = nr_atendimento_p
and		a.dt_validade_prescr > clock_timestamp()
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		d.nr_ciclo = nr_ciclo_p
and		ie_tipo_item_p = 'SOL';

/* procedimentos e controles de glicemia por ciclo */

c14 CURSOR FOR
SELECT  a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		null nr_seq_processo,
		null nr_agrupamento,
		c.dt_horario,
		b.cd_material_exame
from	prescr_proc_hor c,
		prescr_procedimento b,
		prescr_medica a,
		paciente_atendimento d
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_procedimento = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		a.nr_seq_atend  = d.nr_seq_atendimento
and		(obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '')
and		obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		((coalesce(b.nr_seq_exame::text, '') = '' and ie_laboratorio_p = 'N') or ((b.nr_seq_exame IS NOT NULL AND b.nr_seq_exame::text <> '') and ie_laboratorio_p = 'S') or (ie_tipo_item_p in ('G','C')))
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		a.nr_atendimento = nr_atendimento_p
and		((ie_proc_associados_w = 'N') or (obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S'))
and		(((b.nr_sequencia  = nr_Seq_item_p) and (b.nr_prescricao  = nr_prescricao_p) and (ie_desagrupa_proced_w = 'S')) or (ie_desagrupa_proced_w   = 'N'))
and		coalesce(a.dt_validade_prescr,a.dt_inicio_prescr + 24) > clock_timestamp()
and    	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and    	coalesce(b.qt_procedimento,1) = coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
and    	coalesce(b.nr_seq_proc_interno,0) = coalesce(nr_seq_proc_interno_p, 0)
and    	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and    	d.nr_ciclo = nr_ciclo_p
and    	ie_tipo_item_p in ('P','G','C','I')
order by 1, 2, 3;

/* recomendacoes por ciclo  */

c15 CURSOR FOR
SELECT  a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		null nr_seq_processo,
		null nr_agrupamento,
		c.dt_horario
from	prescr_rec_hor c,
		prescr_recomendacao b,
		prescr_medica a,
		paciente_atendimento d
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_recomendacao = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		a.nr_seq_atend  = d.nr_seq_atendimento
and		((ie_data_lib_prescr_w = 'F') or (obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'))
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		a.nr_atendimento = nr_atendimento_p
and    	a.dt_validade_prescr > clock_timestamp()
and    	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and    	coalesce(b.qt_recomendacao,1) = coalesce(qt_item_p,coalesce(b.qt_recomendacao,1))
and    	ie_tipo_item_p = 'R'
and    	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and    	d.nr_ciclo = nr_ciclo_p
order by 1, 2, 3;

/* Leites e derivados */

c16 CURSOR FOR
SELECT  a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		c.nr_seq_processo,
		b.nr_agrupamento,
		c.dt_horario,
		coalesce(b.ie_acm,'N'),
		coalesce(b.ie_se_necessario,'N'),
		b.nr_seq_dieta_cpoe,
		substr(obter_desc_material(b.cd_material),1,255),
		c.cd_material,
		coalesce(b.ie_urgencia,'N')
from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_material = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		obter_se_prescr_lib_adep(coalesce(a.dt_liberacao_medico, b.dt_lib_material), coalesce(a.dt_liberacao,b.dt_lib_material), coalesce(a.dt_liberacao_farmacia, b.dt_lib_farmacia), ie_data_lib_prescr_w) = 'S'
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and		b.ie_agrupador = 16
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.ie_adep,'S') = 'S'
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		a.nr_atendimento = nr_atendimento_p
and		obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S'
and		a.dt_validade_prescr > clock_timestamp()
and		b.cd_material = cd_item_p
and		coalesce(cd_unidade_medida_p,'XPTO') in ('XPTO', c.cd_unidade_medida_dose)
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p
and		coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))
and		(((ie_reaprazar_seguintes_p = 'S' AND c.dt_horario >= dt_horario_p) or
		  (ie_reaprazar_seguintes_p = 'N' AND c.dt_horario = dt_horario_p and qt_minutos_w > 0)) or (c.dt_horario = dt_horario_p and qt_minutos_w < 0))
and		((nr_agrupamento_p IS NOT NULL AND nr_agrupamento_p::text <> '' AND b.nr_agrupamento = nr_agrupamento_p) or
		 ((coalesce(nr_agrupamento_p::text, '') = '') and (obter_se_agrupa_composto(a.nr_prescricao, b.nr_sequencia, b.nr_agrupamento, b.cd_material) = 'N')))
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		ie_tipo_item_p = 'LD'
and		((b.nr_seq_dieta_cpoe = coalesce(nr_seq_cpoe_p, 0)) or (coalesce(b.nr_seq_dieta_cpoe::text, '') = '') or (coalesce(nr_seq_cpoe_p,0) = 0))
order by 1, 2, 3 desc;

c17 CURSOR FOR
SELECT  g.nr_prescricao nr_prescricao,
		f.nr_sequencia nr_seq_item,
		g.nr_sequencia nr_seq_hor,
		g.nr_seq_processo,
		f.nr_agrupamento,
		g.dt_horario
from    pe_material_proced z,
		pe_procedimento d,
		pe_prescr_proc b,
		pe_prescricao c,
		prescr_medica e,
		prescr_material f,
		prescr_mat_hor g
where   b. nr_seq_prescr     = c.nr_sequencia
and		b.nr_seq_proc        = d.nr_sequencia
and		f.nr_seq_pe_proc     = b.nr_sequencia
and		c.nr_prescricao      = f.nr_prescricao
and		c.nr_prescricao      = e.nr_prescricao
and		e.nr_prescricao      = f.nr_prescricao
and		z.cd_material       = f.cd_material
and		g.nr_prescricao      =   f.nr_prescricao
and		g.nr_seq_material    = f.nr_sequencia
and		g.dt_horario     =     dt_horario_w
and     c.nr_sequencia       =  nr_prescricao_w
and     f.nr_seq_pe_proc     =  nr_seq_item_w
and		d.nr_sequencia       = z.nr_seq_proc
and		obter_se_prescr_lib_adep(e.dt_liberacao_medico, e.dt_liberacao, e.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and		obter_se_exibir_rep_adep_setor(cd_setor_pac_w,e.cd_setor_atendimento,coalesce(e.ie_adep,'S')) = 'S'
and		f.ie_agrupador in (1)
and		coalesce(g.ie_situacao,'A') = 'A'
and		coalesce(g.ie_horario_especial,'N') = 'N'
and		coalesce(g.dt_fim_horario::text, '') = ''
and		coalesce(g.dt_suspensao::text, '') = ''
and		e.nr_atendimento = nr_atendimento_p
and		Obter_se_horario_liberado(g.dt_lib_horario, g.dt_horario) = 'S'
order by 1, 2, 3;

c18 CURSOR FOR
SELECT  a.nr_prescricao, /*Gasoterapia */
		b.nr_sequencia,
		c.dt_horario,
		c.nr_sequencia,
		b.nr_seq_gas_cpoe
from	prescr_gasoterapia  b,
		prescr_medica    a,
		prescr_gasoterapia_hor c
where	b.nr_prescricao = a.nr_prescricao
and		c.nr_seq_gasoterapia = b.nr_sequencia
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		((c.nr_prescricao   = nr_prescricao_p AND b.nr_sequencia  = nr_seq_item_p) or
		 ((b.nr_seq_gas_cpoe IS NOT NULL AND b.nr_seq_gas_cpoe::text <> '') and (obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S') and
		   exists (	select  1
					from  	prescr_gasoterapia_hor x
					where  	x.nr_sequencia = x.nr_sequencia
					and		x.dt_horario = dt_horario_p)))
and		ie_tipo_item_p = 'O'
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		a.dt_validade_prescr > clock_timestamp()
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		(((ie_reaprazar_seguintes_p = 'S' AND c.dt_horario >= dt_horario_p) or
		  (ie_reaprazar_seguintes_p = 'N' AND c.dt_horario = dt_horario_p and qt_minutos_w > 0)) or (c.dt_horario = dt_horario_p and qt_minutos_w < 0))
order by a.nr_prescricao, c.dt_horario;

c19 CURSOR( nr_seq_kit_pc 	prescr_material.nr_seq_kit%type,
			dt_horario_pc	prescr_mat_hor.dt_horario%type) FOR /*Kits associados aos suplementos*/
	SELECT	c.nr_prescricao nr_prescricao,
			b.nr_sequencia nr_seq_item,
			a.nr_sequencia nr_seq_horario,
			a.nr_seq_processo nr_seq_processo,
			a.nr_agrupamento nr_agrupamento,
			a.dt_horario dt_horario,
			b.cd_material cd_material,
			b.qt_material qt_material,
			b.cd_intervalo
	from	prescr_mat_hor	a,
			prescr_material	b,
			prescr_medica	c
	where	b.nr_prescricao	= a.nr_prescricao
	and		b.nr_sequencia	= a.nr_seq_material
	and		c.nr_prescricao	= b.nr_prescricao
	and		c.nr_atendimento = nr_atendimento_p
	and		b.nr_seq_kit	= nr_seq_kit_pc
	and		b.ie_agrupador = 2
	and		a.dt_horario	= dt_horario_pc
	and		coalesce(a.ie_situacao,'A') = 'A'
	and		coalesce(a.ie_horario_especial,'N') = 'N'
	and		coalesce(a.ie_adep,'S') = 'S'
	and		coalesce(a.dt_fim_horario::text, '') = ''
	and		coalesce(a.dt_suspensao::text, '') = ''
	and		c.dt_validade_prescr > clock_timestamp()
	and		obter_se_prescr_lib_adep(c.dt_liberacao_medico, c.dt_liberacao, c.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S';

/* Itens da dieta */

c20 CURSOR( nr_prescricao_pc 	prescr_medica.nr_prescricao%type,
			dt_horario_pc		prescr_mat_hor.dt_horario%type ) FOR
SELECT  a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		c.nr_seq_processo,
		b.nr_agrupamento,
		c.dt_horario,
		c.nr_seq_material,
		b.nr_seq_mat_cpoe
from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_material = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		b.ie_agrupador = 6
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.ie_adep,'S') = 'S'
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		a.nr_atendimento = nr_atendimento_p
and		a.nr_prescricao = coalesce(nr_prescricao_p, nr_prescricao_pc)
and		c.dt_horario = dt_horario_pc
and		a.dt_validade_prescr > clock_timestamp()
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		ie_tipo_item_p = 'D';

C21 CURSOR FOR
	SELECT	nr_sequencia,
			ie_classif_urgente,
			ie_controlado,
			ie_padronizado
	from	classif_lote_disp_far
	where	cd_estabelecimento = cd_estabelecimento_p
	and		ie_situacao = 'A'
	order by
			ie_classif_urgente,
			ie_controlado desc,
			ie_padronizado desc;
BEGIN

CALL wheb_usuario_pck.set_ie_commit('N');

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then
  nr_prescricao_log_w := nr_prescricao_p;
elsif (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') then
  nr_prescricao_log_w := obter_prescricao_horario(nr_seq_horario_p, ie_tipo_item_p, 'P');
else
  nr_prescricao_log_w := substr(nr_prescricoes_p,instr(nr_prescricoes_p,',',-1) + 1);
end if;

ie_grava_log_rastr_w := obter_rastreabilidade_adep(nr_prescricao_log_w, 'REA');

if (ie_grava_log_rastr_w = 'S') then
  CALL adep_gerar_log_rastr('REAPRAZAR_HORARIO_ITEM_PRESCR log rastr');
end if;

ie_apraz_regra_w := obter_apraz_reapraz_regra(	ie_tipo_item_p => ie_tipo_item_p,
												nr_atendimento_p => nr_atendimento_p,
												ie_acao_p => 'R',
												nm_usuario_p => nm_usuario_p);
if (ie_apraz_regra_w <> 'S') then
	-- Voce nao tem permissao para efetuar essa acao. Cadastros gerais / ADEP - Regra permissao de aprazamento/reaprazamento
	CALL wheb_mensagem_pck.exibir_mensagem_abort(1134375);
end if;

ds_lista_eliminados_p	:= null;
if (ie_grava_log_rastr_w = 'S') then
  CALL adep_gerar_log_rastr('REAPRAZAR_HORARIO_ITEM_PRESCR ds_lista_eliminados_p atribuicao 1: ' || ds_lista_eliminados_p);
end if;

CALL wheb_assist_pck.set_informacoes_usuario(cd_estabelecimento_p, obter_perfil_ativo, nm_usuario_p);

ie_data_proc_w := wheb_assist_pck.obterValorParametroREP(223, ie_data_proc_w);

ie_data_lib_prescr_w    := wheb_assist_pck.obterParametroFuncao(1113,115);
ie_exibe_suspenso_w      := wheb_assist_pck.obterParametroFuncao(1113,117);
ie_proc_associados_w    := wheb_assist_pck.obterParametroFuncao(1113,139);
ie_gera_lote_w        := wheb_assist_pck.obterParametroFuncao(1113,145);
ie_consiste_lote_atendido_w  := wheb_assist_pck.obterParametroFuncao(1113,162);
ie_reaprazar_assoc_w    := wheb_assist_pck.obterParametroFuncao(1113,215);
ie_perm_ant_validade_w    := wheb_assist_pck.obterParametroFuncao(1113,396);
ie_desagrupa_proced_w    := wheb_assist_pck.obterParametroFuncao(1113,463);
ie_elimina_horario_w    := wheb_assist_pck.obterParametroFuncao(1113,467);
ie_inativa_horario_ant_w  := wheb_assist_pck.obterParametroFuncao(1113,576);

cd_setor_pac_w  := Obter_Unidade_Atendimento(nr_atendimento_p, 'IA', 'CS');

select	max(ie_classif_urgencia),
		coalesce(max(ie_forma_agora), 'N'),
		coalesce(max(ie_classif_normal_acm_sn),'N'),
		coalesce(max(qt_min_agora),0),
		coalesce(max(qt_min_especial),0),
		coalesce(max(ie_classif_lote), 'N')
into STRICT	ie_classif_nao_padrao_w,
		ie_agora_impressao_w,
		ie_classif_normal_acm_sn_w,
		qt_min_agora_w,
		qt_min_especial_w,
		ie_classif_lote_w
from	parametros_farmacia
where	cd_estabelecimento	= cd_estabelecimento_p;

if (ie_grava_log_rastr_w = 'S') then
  CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR Parametros da funcao ' || chr(10) ||
  '{' || chr(10) ||
  ' "nr_atendimento_p": "' || nr_atendimento_p || '"' || chr(10) ||
  ' "ie_tipo_item_p": "' || ie_tipo_item_p || '"' || chr(10) ||
  ' "cd_item_p": "' || cd_item_p || '"' || chr(10) ||
  ' "cd_intervalo_p": "' || cd_intervalo_p || '"' || chr(10) ||
  ' "qt_item_p": "' || qt_item_p || '"' || chr(10) ||
  ' "dt_horario_p": "' || dt_horario_p || '"' || chr(10) ||
  ' "dt_horario_desejado_p": "' || dt_horario_desejado_p || '"' || chr(10) ||
  ' "ie_reaprazar_seguintes_p": "' || ie_reaprazar_seguintes_p || '"' || chr(10) ||
  ' "nr_prescricoes_p": "' || nr_prescricoes_p || '"' || chr(10) ||
  ' "nr_prescricao_p": "' || nr_prescricao_p || '"' || chr(10) ||
  ' "nr_seq_item_p": "' || nr_seq_item_p || '"' || chr(10) ||
  ' "ie_laboratorio_p": "' || ie_laboratorio_p || '"' || chr(10) ||
  ' "nr_seq_motivo_p": "' || nr_seq_motivo_p || '"' || chr(10) ||
  ' "ds_justificativa_p": "' || ds_justificativa_p || '"' || chr(10) ||
  ' "nm_usuario_p": "' || nm_usuario_p || '"' || chr(10) ||
  ' "ds_lista_eliminados_p": "' || ds_lista_eliminados_p || '"' || chr(10) ||
  ' "nr_seq_proc_interno_p": "' || nr_seq_proc_interno_p || '"' || chr(10) ||
  ' "ds_inconsist_lote_p": "' || ds_inconsist_lote_p || '"' || chr(10) ||
  ' "nr_agrupamento_p": "' || nr_agrupamento_p || '"' || chr(10) ||
  ' "ie_acm_sn_p": "' || ie_acm_sn_p || '"' || chr(10) ||
  ' "nr_seq_assinatura_p": "' || nr_seq_assinatura_p || '"' || chr(10) ||
  ' "ie_reaprazar_exame_mat_p": "' || ie_reaprazar_exame_mat_p || '"' || chr(10) ||
  ' "nr_ciclo_p": "' || nr_ciclo_p || '"' || chr(10) ||
  ' "ie_reaprazar_item_ciclo_p": "' || ie_reaprazar_item_ciclo_p || '"' || chr(10) ||
  ' "cd_unidade_medida_p": "' || cd_unidade_medida_p || '"' || chr(10) ||
  ' "ds_componentes_p": "' || ds_componentes_p || '"' || chr(10) ||
  ' "ie_via_aplicacao_p": "' || ie_via_aplicacao_p || '"' || chr(10) ||
  ' "nr_seq_prot_glic_p": "' || nr_seq_prot_glic_p || '"' || chr(10) ||
  ' "ds_item_p": "' || ds_item_p || '"' || chr(10) ||
  ' "cd_funcao_p": "' || cd_funcao_p || '"' || chr(10) ||
  ' "ds_observacao_p": "' || ds_observacao_p || '"' || chr(10) ||
  ' "nr_seq_cpoe_p": "' || nr_seq_cpoe_p || '"' || chr(10) ||
  ' "nr_seq_horario_p": "' || nr_seq_horario_p || '"' || chr(10) ||
  '}',
  0, 4000));

  CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR Parametros farmacia e primeiro IF' || chr(10) ||
  '{' || chr(10) ||
  ' "ie_data_lib_prescr_w": "' || ie_data_lib_prescr_w || '"' || chr(10) ||
  ' "ie_exibe_suspenso_w": "' || ie_exibe_suspenso_w || '"' || chr(10) || 
  ' "ie_proc_associados_w": "' || ie_proc_associados_w || '"' || chr(10) || 
  ' "ie_gera_lote_w": "' || ie_gera_lote_w || '"' || chr(10) || 
  ' "ie_consiste_lote_atendido_w": "' || ie_consiste_lote_atendido_w || '"' || chr(10) || 
  ' "ie_reaprazar_assoc_w": "' || ie_reaprazar_assoc_w || '"' || chr(10) || 
  ' "ie_perm_ant_validade_w": "' || ie_perm_ant_validade_w || '"' || chr(10) || 
  ' "ie_desagrupa_proced_w": "' || ie_desagrupa_proced_w || '"' || chr(10) || 
  ' "ie_elimina_horario_w": "' || ie_elimina_horario_w || '"' || chr(10) || 
  ' "ie_inativa_horario_ant_w": "' || ie_inativa_horario_ant_w || '"' || chr(10) || 
  ' "ie_classif_nao_padrao_w": "' || ie_classif_nao_padrao_w || '"' || chr(10) || 
  ' "ie_agora_impressao_w": "' || ie_agora_impressao_w || '"' || chr(10) || 
  ' "ie_classif_normal_acm_sn_w": "' || ie_classif_normal_acm_sn_w || '"' || chr(10) || 
  ' "qt_min_agora_w": "' || qt_min_agora_w || '"' || chr(10) || 
  ' "qt_min_especial_w": "' || qt_min_especial_w || '"' || chr(10) || 
  ' "ie_classif_lote_w": "' || ie_classif_lote_w || '"' || chr(10) || 
  ' "nr_atendimento_p": "' || nr_atendimento_p || '"' || chr(10) ||
	' "ie_tipo_item_p": "' || ie_tipo_item_p || '"' || chr(10) ||
	' "dt_horario_p": "' || dt_horario_p || '"' || chr(10) ||
	' "dt_horario_desejado_p": "' || dt_horario_desejado_p || '"' || chr(10) ||
	' "nr_prescricoes_p": "' || nr_prescricoes_p || '"' || chr(10) ||
	' "ie_laboratorio_p": "' || ie_laboratorio_p || '"' || chr(10) ||
	' "nm_usuario_p": "' || nm_usuario_p || '"' || chr(10) ||
  '}',
  0, 4000));
end if;

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') and (dt_horario_p IS NOT NULL AND dt_horario_p::text <> '') and (dt_horario_desejado_p IS NOT NULL AND dt_horario_desejado_p::text <> '') and (nr_prescricoes_p IS NOT NULL AND nr_prescricoes_p::text <> '') and (ie_laboratorio_p IS NOT NULL AND ie_laboratorio_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	/* obter diferenca horario */

	qt_minutos_w     := (trunc(dt_horario_desejado_p,'mi') - trunc(dt_horario_p,'mi')) * 1440;
	dt_horario_desejado_w  := trunc(dt_horario_desejado_p,'mi');

  /* atualizar horarios */

	if (coalesce(qt_minutos_w,0) <> 0) then
		begin
    if (ie_tipo_item_p = 'D') then
      begin
      if (ie_grava_log_rastr_w = 'S') then
        CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR Parametros C01 ' || chr(10) ||
        '{'||chr(10)||
        '"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
        '"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
        '"dt_horario_desejado_p" : "'||to_char(dt_horario_desejado_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
        '"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
        '"ie_reaprazar_seguintes_p" : "'||ie_reaprazar_seguintes_p||'",'||chr(10)||
        '"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
        '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
        '"nr_prescricoes_p" : "'||nr_prescricoes_p||'",'||chr(10)||
        '"qt_minutos_w" : "'||qt_minutos_w||'",'||chr(10)||
        '"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}',
        0, 4000));
      end if;

      open c01;
      loop
      fetch c01 into
        nr_prescricao_w,
        nr_seq_item_w,
        nr_seq_horario_w,
        nr_seq_processo_w,
        nr_agrupamento_w,
        dt_horario_w,
        nr_seq_cpoe_w;
      EXIT WHEN NOT FOUND; /* apply on c01 */
        begin
        vetor_w[cont_w].nr_prescricao_w    := nr_prescricao_w;
        vetor_w[cont_w].nr_seq_item_w    := nr_seq_item_w;
        vetor_w[cont_w].nr_seq_horario_w  := nr_seq_horario_w;
        vetor_w[cont_w].nr_seq_processo_w  := nr_seq_processo_w;
        vetor_w[cont_w].nr_agrupamento_w  := nr_agrupamento_w;
        vetor_w[cont_w].dt_horario_w    := dt_horario_w;
        vetor_w[cont_w].nr_seq_cpoe_w    := nr_seq_cpoe_w;
        cont_w  := cont_w + 1;

      if (ie_grava_log_rastr_w = 'S') then
        CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR Parametros C20 ' || chr(10) ||
        '{'||chr(10)||
        '"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
        '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
        '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
        '"dt_horario_pc" : "' || to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss') || '",' || chr(10) ||
        '"nr_prescricao_pc" : "' || nr_prescricao_w || '",' || chr(10) ||
        '"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}',
        0, 4000));
      end if;

		for c20_w in c20( nr_prescricao_w,
						  dt_horario_w) loop
			begin

			vetor_w[cont_w].ie_item_associado_w	:= 'S';
			vetor_w[cont_w].nr_prescricao_w		:= c20_w.nr_prescricao;
			vetor_w[cont_w].nr_seq_item_w    	:= c20_w.nr_seq_item;
			vetor_w[cont_w].nr_seq_horario_w  	:= c20_w.nr_seq_hor;
			vetor_w[cont_w].nr_seq_processo_w  	:= c20_w.nr_seq_processo;
			vetor_w[cont_w].nr_agrupamento_w  	:= c20_w.nr_agrupamento;
			vetor_w[cont_w].dt_horario_w    	:= c20_w.dt_horario;
			cont_w  := cont_w + 1;

			end;
		end loop;
        end;
      end loop;
      close c01;
      end;
    elsif (ie_tipo_item_p = 'S') then
      begin
            if (ie_grava_log_rastr_w = 'S') then
        CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR Parametros C02 ' || chr(10) ||
        '{'||chr(10)||
        '"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
        '"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
        '"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
        '"dt_horario_desejado_p" : "'||to_char(dt_horario_desejado_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
        '"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
        '"ie_reaprazar_seguintes_p" : "'||ie_reaprazar_seguintes_p||'",'||chr(10)||
        '"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
        '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
        '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
        '"nr_prescricoes_p" : "'||nr_prescricoes_p||'",'||chr(10)||
        '"nr_seq_item_p" : "'||nr_seq_item_p||'",'||chr(10)||
        '"qt_item_p" : "'||qt_item_p||'",'||chr(10)||
        '"qt_minutos_w" : "'||qt_minutos_w||'",'||chr(10)||
        '"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}',
        0, 4000));
      end if;

      open c02;
      loop
      fetch c02 into
        nr_prescricao_w,
        nr_seq_item_w,
        nr_seq_horario_w,
        nr_seq_processo_w,
        nr_agrupamento_w,
        dt_horario_w,
        nr_seq_cpoe_w,
		cd_material_w,
		ie_se_necessario_w,
		ie_acm_w,
		ie_urgente_w;
      EXIT WHEN NOT FOUND; /* apply on c02 */
        begin

        vetor_w[cont_w].nr_prescricao_w    := nr_prescricao_w;
        vetor_w[cont_w].nr_seq_item_w    := nr_seq_item_w;
        vetor_w[cont_w].nr_seq_horario_w  := nr_seq_horario_w;
        vetor_w[cont_w].nr_seq_processo_w  := nr_seq_processo_w;
        vetor_w[cont_w].nr_agrupamento_w  := nr_agrupamento_w;
        vetor_w[cont_w].dt_horario_w    := dt_horario_w;
        vetor_w[cont_w].nr_seq_cpoe_w    := nr_seq_cpoe_w;
		vetor_w[cont_w].cd_material_w    := cd_material_w;
		vetor_w[cont_w].ie_se_necessario_w	:= ie_se_necessario_w;
		vetor_w[cont_w].ie_acm_w	:= ie_acm_w;
		vetor_w[cont_w].ie_urgente_w	:= ie_urgente_w;

        cont_w  := cont_w + 1;

    if (ie_grava_log_rastr_w = 'S') then
      CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR Parametros C19 ' || chr(10) ||
      '{'||chr(10)||
      '"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
      '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
      '"nr_seq_kit_pc" : "' || nr_seq_item_w || '",' || chr(10) ||
      '"dt_horario_pc" : "' || to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss') || '",' || chr(10) ||
      '"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss') ||'"}',
      0, 4000));
    end if;

		for c19_w in c19(	nr_seq_item_w,
							dt_horario_w) loop
			begin

			vetor_w[cont_w].ie_item_associado_w	:= 'S';
			vetor_w[cont_w].nr_prescricao_w		:= c19_w.nr_prescricao;
			vetor_w[cont_w].nr_seq_item_w    	:= c19_w.nr_seq_item;
			vetor_w[cont_w].nr_seq_horario_w  	:= c19_w.nr_seq_horario;
			vetor_w[cont_w].nr_seq_processo_w  	:= c19_w.nr_seq_processo;
			vetor_w[cont_w].nr_agrupamento_w  	:= c19_w.nr_agrupamento;
			vetor_w[cont_w].dt_horario_w    	:= c19_w.dt_horario;
			vetor_w[cont_w].cd_material_w		:= c19_w.cd_material;
			vetor_w[cont_w].qt_material_w		:= c19_w.qt_material;
			vetor_w[cont_w].cd_intervalo_w		:= c19_w.cd_intervalo;
			cont_w  := cont_w + 1;

			end;
		end loop;

        end;
      end loop;
      close c02;
      end;
    elsif (ie_tipo_item_p in ('M', 'IAH')) then
      begin

      if (coalesce(ie_reaprazar_item_ciclo_p,'N') = 'N') then
        begin
        if (ie_grava_log_rastr_w = 'S') then
          CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR Parametros C03 ' || chr(10) ||
          '{'||chr(10)||
          '"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
          '"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
          '"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
          '"cd_unidade_medida_p" : "'||cd_unidade_medida_p||'",'||chr(10)||
          '"ds_item_p" : "'||ds_item_p||'",'||chr(10)||
          '"ds_observacao_p" : "'||ds_observacao_p||'",'||chr(10)||
          '"dt_horario_desejado_p" : "'||to_char(dt_horario_desejado_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
          '"ie_acm_sn_p" : "'||ie_acm_sn_p||'",'||chr(10)||
          '"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
          '"ie_reaprazar_seguintes_p" : "'||ie_reaprazar_seguintes_p||'",'||chr(10)||
          '"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
          '"ie_via_aplicacao_p" : "'||ie_via_aplicacao_p||'",'||chr(10)||
          '"nr_agrupamento_p" : "'||nr_agrupamento_p||'",'||chr(10)||
          '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
          '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
          '"nr_prescricoes_p" : "'||nr_prescricoes_p||'",'||chr(10)||
          '"nr_seq_cpoe_p" : "'||nr_seq_cpoe_p||'",'||chr(10)||
          '"nr_seq_item_p" : "'||nr_seq_item_p||'",'||chr(10)||
          '"qt_item_p" : "'||qt_item_p||'",'||chr(10)||
          '"qt_minutos_w" : "'||qt_minutos_w||'",'||chr(10)||
          '"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}',
          0, 4000));
        end if;

        open c03;
        loop
        fetch c03 into
          nr_prescricao_w,
          nr_seq_item_w,
          nr_seq_horario_w,
          nr_seq_processo_w,
          nr_agrupamento_w,
          dt_horario_w,
          ie_acm_w,
          ie_sn_w,
          nr_seq_cpoe_w,
		  cd_material_w,
		  ie_se_necessario_w,
		  ie_acm_w,
		  ie_urgente_w;
        EXIT WHEN NOT FOUND; /* apply on c03 */
          begin
          if (ie_acm_w = 'S') or (ie_sn_w = 'S') then
            ie_acm_sn_w := 'S';
          else
            ie_acm_sn_w := 'N';
          end if;

          vetor_w[cont_w].nr_prescricao_w    := nr_prescricao_w;
          vetor_w[cont_w].nr_seq_item_w    := nr_seq_item_w;
          vetor_w[cont_w].nr_seq_horario_w  := nr_seq_horario_w;
          vetor_w[cont_w].nr_seq_processo_w  := nr_seq_processo_w;
          vetor_w[cont_w].nr_agrupamento_w  := nr_agrupamento_w;
          vetor_w[cont_w].dt_horario_w    := dt_horario_w;
          vetor_w[cont_w].ie_acm_sn_ww    := ie_acm_sn_w;
          vetor_w[cont_w].nr_seq_cpoe_w    := nr_seq_cpoe_w;
		  vetor_w[cont_w].cd_material_w    := cd_material_w;
		  vetor_w[cont_w].ie_se_necessario_w	:= ie_se_necessario_w;
		  vetor_w[cont_w].ie_acm_w	:= ie_acm_w;
		  vetor_w[cont_w].ie_urgente_w	:= ie_urgente_w;
          cont_w  := cont_w + 1;
          end;
        end loop;
        close c03;
        end;
      elsif (coalesce(ie_reaprazar_item_ciclo_p,'N') = 'S') then
        begin

        if (ie_grava_log_rastr_w = 'S') then
          CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR Parametros C12 ' || chr(10) ||
          '{'||chr(10)||
          '"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
          '"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
          '"ie_acm_sn_p" : "'||ie_acm_sn_p||'",'||chr(10)||
          '"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
          '"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
          '"nr_agrupamento_p" : "'||nr_agrupamento_p||'",'||chr(10)||
          '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
          '"nr_ciclo_p" : "'||nr_ciclo_p||'",'||chr(10)||
          '"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}',
          0, 4000));
        end if;

        open c12;
        loop
        fetch c12 into
          nr_prescricao_w,
          nr_seq_item_w,
          nr_seq_horario_w,
          nr_seq_processo_w,
          nr_agrupamento_w,
          dt_horario_w,
          ie_acm_w,
          ie_sn_w,
          cd_material_w;
        EXIT WHEN NOT FOUND; /* apply on c12 */
          begin
          if (ie_acm_w = 'S') or (ie_sn_w = 'S') then
            ie_acm_sn_w := 'S';
          else
            ie_acm_sn_w := 'N';
          end if;

          vetor_w[cont_w].nr_prescricao_w    := nr_prescricao_w;
          vetor_w[cont_w].nr_seq_item_w    := nr_seq_item_w;
          vetor_w[cont_w].nr_seq_horario_w  := nr_seq_horario_w;
          vetor_w[cont_w].nr_seq_processo_w  := nr_seq_processo_w;
          vetor_w[cont_w].nr_agrupamento_w  := nr_agrupamento_w;
          vetor_w[cont_w].dt_horario_w    := dt_horario_w;
          vetor_w[cont_w].ie_acm_sn_ww    := ie_acm_sn_w;
          vetor_w[cont_w].cd_material_w    := cd_material_w;
          cont_w  := cont_w + 1;
          end;
        end loop;
        close c12;
        end;
      end if;


      end;
    elsif (ie_tipo_item_p = 'MAT') then
      begin
      if (ie_grava_log_rastr_w = 'S') then
        CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR Parametros C04 ' || chr(10) ||
        '{'||chr(10)||
        '"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
        '"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
        '"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
        '"dt_horario_desejado_p" : "'||to_char(dt_horario_desejado_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
        '"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
        '"ie_reaprazar_seguintes_p" : "'||ie_reaprazar_seguintes_p||'",'||chr(10)||
        '"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
        '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
        '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
        '"nr_prescricoes_p" : "'||nr_prescricoes_p||'",'||chr(10)||
        '"nr_seq_item_p" : "'||nr_seq_item_p||'",'||chr(10)||
        '"qt_item_p" : "'||qt_item_p||'",'||chr(10)||
        '"qt_minutos_w" : "'||qt_minutos_w||'",'||chr(10)||
        '"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}',
        0, 4000));
      end if;

      open c04;
      loop
      fetch c04 into
        nr_prescricao_w,
        nr_seq_item_w,
        nr_seq_horario_w,
        nr_seq_processo_w,
        nr_agrupamento_w,
        dt_horario_w,
        nr_seq_cpoe_w,
		cd_material_w,
		ie_se_necessario_w,
		ie_acm_w,
		ie_urgente_w;
      EXIT WHEN NOT FOUND; /* apply on c04 */
        begin
        vetor_w[cont_w].nr_prescricao_w    := nr_prescricao_w;
        vetor_w[cont_w].nr_seq_item_w    := nr_seq_item_w;
        vetor_w[cont_w].nr_seq_horario_w  := nr_seq_horario_w;
        vetor_w[cont_w].nr_seq_processo_w  := nr_seq_processo_w;
        vetor_w[cont_w].nr_agrupamento_w  := nr_agrupamento_w;
        vetor_w[cont_w].dt_horario_w    := dt_horario_w;
        vetor_w[cont_w].nr_seq_cpoe_w    := nr_seq_cpoe_w;
		vetor_w[cont_w].cd_material_w    := cd_material_w;
		vetor_w[cont_w].ie_se_necessario_w	:= ie_se_necessario_w;
		vetor_w[cont_w].ie_acm_w	:= ie_acm_w;
		vetor_w[cont_w].ie_urgente_w	:= ie_urgente_w;

        cont_w  := cont_w + 1;
        end;
      end loop;
      close c04;
      end;
    elsif (ie_tipo_item_p = 'LD') then
      if (ie_grava_log_rastr_w = 'S') then
        CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR Parametros C16 ' || chr(10) ||
        '{'||chr(10)||
        '"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
        '"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
        '"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
        '"cd_unidade_medida_p" : "'||cd_unidade_medida_p||'",'||chr(10)||
        '"dt_horario_desejado_p" : "'||to_char(dt_horario_desejado_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
        '"ie_acm_sn_p" : "'||ie_acm_sn_p||'",'||chr(10)||
        '"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
        '"ie_reaprazar_seguintes_p" : "'||ie_reaprazar_seguintes_p||'",'||chr(10)||
        '"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
        '"nr_agrupamento_p" : "'||nr_agrupamento_p||'",'||chr(10)||
        '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
        '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
        '"nr_prescricoes_p" : "'||nr_prescricoes_p||'",'||chr(10)||
        '"nr_seq_cpoe_p" : "'||nr_seq_cpoe_p||'",'||chr(10)||
        '"nr_seq_item_p" : "'||nr_seq_item_p||'",'||chr(10)||
        '"qt_item_p" : "'||qt_item_p||'",'||chr(10)||
        '"qt_minutos_w" : "'||qt_minutos_w||'",'||chr(10)||
        '"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}',
        0, 4000));
      end if;

      open c16;
      loop
      fetch c16 into
        nr_prescricao_w,
        nr_seq_item_w,
        nr_seq_horario_w,
        nr_seq_processo_w,
        nr_agrupamento_w,
        dt_horario_w,
        ie_acm_w,
        ie_sn_w,
        nr_seq_cpoe_w,
        ds_item_w,
		cd_material_w,
		ie_urgente_w;
      EXIT WHEN NOT FOUND; /* apply on c16 */
        begin
        if (ie_acm_w = 'S') or (ie_sn_w = 'S') then
          ie_acm_sn_w := 'S';
        else
          ie_acm_sn_w := 'N';
        end if;

        vetor_w[cont_w].nr_prescricao_w    := nr_prescricao_w;
        vetor_w[cont_w].nr_seq_item_w    := nr_seq_item_w;
        vetor_w[cont_w].nr_seq_horario_w  := nr_seq_horario_w;
        vetor_w[cont_w].nr_seq_processo_w  := nr_seq_processo_w;
        vetor_w[cont_w].nr_agrupamento_w  := nr_agrupamento_w;
        vetor_w[cont_w].dt_horario_w    := dt_horario_w;
        vetor_w[cont_w].ie_acm_sn_ww    := ie_acm_sn_w;
        vetor_w[cont_w].nr_seq_cpoe_w    := nr_seq_cpoe_w;
        vetor_w[cont_w].ds_item_w	:= ds_item_w;
		vetor_w[cont_w].cd_material_w    := cd_material_w;
		vetor_w[cont_w].ie_se_necessario_w	:= ie_sn_w;
		vetor_w[cont_w].ie_acm_w	:= ie_acm_w;
		vetor_w[cont_w].ie_urgente_w	:= ie_urgente_w;

        cont_w  := cont_w + 1;
        end;
      end loop;
      close c16;

    elsif (ie_tipo_item_p in ('P','G','C','I')) then
      begin
      ie_entrou_w  := 'N';

      if (ie_reaprazar_item_ciclo_p = 'N') then
        begin
        if (ie_grava_log_rastr_w = 'S') then
          CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR Parametros C05 ' || chr(10) ||
          '{'||chr(10)||
          '"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
          '"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
          '"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
          '"ds_componentes_p" : "'||ds_componentes_p||'",'||chr(10)||
          '"dt_horario_desejado_p" : "'||to_char(dt_horario_desejado_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
          '"ie_data_proc_w" : "'||ie_data_proc_w||'",'||chr(10)||
          '"ie_desagrupa_proced_w" : "'||ie_desagrupa_proced_w||'",'||chr(10)||
          '"ie_exibe_suspenso_w" : "'||ie_exibe_suspenso_w||'",'||chr(10)||
          '"ie_laboratorio_p" : "'||ie_laboratorio_p||'",'||chr(10)||
          '"ie_proc_associados_w" : "'||ie_proc_associados_w||'",'||chr(10)||
          '"ie_reaprazar_seguintes_p" : "'||ie_reaprazar_seguintes_p||'",'||chr(10)||
          '"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
          '"nr_Seq_item_p" : "'||nr_Seq_item_p||'",'||chr(10)||
          '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
          '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
          '"nr_prescricoes_p" : "'||nr_prescricoes_p||'",'||chr(10)||
          '"nr_seq_item_p" : "'||nr_seq_item_p||'",'||chr(10)||
          '"nr_seq_proc_interno_p" : "'||nr_seq_proc_interno_p||'",'||chr(10)||
          '"nr_seq_prot_glic_p" : "'||nr_seq_prot_glic_p||'",'||chr(10)||
          '"qt_item_p" : "'||qt_item_p||'",'||chr(10)||
          '"qt_minutos_w" : "'||qt_minutos_w||'",'||chr(10)||
          '"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}',
          0, 4000));
        end if;

        open c05;
        loop
        fetch c05 into
          nr_prescricao_w,
          nr_seq_item_w,
          nr_seq_horario_w,
          nr_seq_processo_w,
          nr_agrupamento_w,
          dt_horario_w,
          cd_material_exame_w,
          nr_seq_cpoe_w,
		  ie_se_necessario_w,
		  ie_acm_w,
		  ie_urgente_w;
        EXIT WHEN NOT FOUND; /* apply on c05 */
          begin

          ie_entrou_w  := 'S';
          vetor_w[cont_w].nr_prescricao_w    := nr_prescricao_w;
          vetor_w[cont_w].nr_seq_item_w    := nr_seq_item_w;
          vetor_w[cont_w].nr_seq_horario_w  := nr_seq_horario_w;
          vetor_w[cont_w].nr_seq_processo_w  := nr_seq_processo_w;
          vetor_w[cont_w].nr_agrupamento_w  := nr_agrupamento_w;
          vetor_w[cont_w].dt_horario_w    := dt_horario_w;
          vetor_w[cont_w].cd_material_exame_w  := cd_material_exame_w;
          vetor_w[cont_w].nr_seq_cpoe_w    := nr_seq_cpoe_w;
		  vetor_w[cont_w].ie_se_necessario_w	:= ie_se_necessario_w;
		  vetor_w[cont_w].ie_acm_w	:= ie_acm_w;
		  vetor_w[cont_w].ie_urgente_w	:= ie_urgente_w;
          cont_w  := cont_w + 1;

          if (coalesce(ie_reaprazar_assoc_w,'N') = 'S') then
            if (ie_grava_log_rastr_w = 'S') then
              CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR Parametros C10 ' || chr(10) ||
              '{'||chr(10)||
              '"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
              '"dt_horario_w" : "'||to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
              '"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
              '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
              '"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
              '"nr_seq_item_w" : "'||nr_seq_item_w||'"}',
              0, 4000));
            end if;

            open C10;
            loop
            fetch C10 into
              nr_prescricao_ww,
              nr_seq_item_ww,
              nr_seq_horario_ww,
              nr_seq_processo_ww,
              nr_agrupamento_ww,
              dt_horario_ww,
              cd_intervalo_ww,
              cd_material_ww,
              qt_item_ww,
			  nr_sequencia_proc_ww,
			  ie_se_necessario_ww,
			  ie_acm_ww,
			  ie_urgente_ww;
            EXIT WHEN NOT FOUND; /* apply on C10 */
              begin

              vetor_w[cont_w].nr_prescricao_w    := nr_prescricao_ww;
              vetor_w[cont_w].nr_seq_item_w    := nr_seq_item_ww;
              vetor_w[cont_w].nr_seq_horario_w  := nr_seq_horario_ww;
              vetor_w[cont_w].nr_seq_processo_w  := nr_seq_processo_ww;
              vetor_w[cont_w].nr_agrupamento_w  := nr_agrupamento_ww;
              vetor_w[cont_w].dt_horario_w    := dt_horario_ww;
              vetor_w[cont_w].ie_item_associado_w  := 'S';
			  vetor_w[cont_w].nr_sequencia_proc_w	:= nr_sequencia_proc_ww;

              vetor_w[cont_w].cd_material_w    := cd_material_ww;
              vetor_w[cont_w].cd_intervalo_w    := cd_intervalo_ww;
              vetor_w[cont_w].qt_material_w    := qt_item_ww;
			
			  vetor_w[cont_w].ie_se_necessario_w    := ie_se_necessario_ww;
			  vetor_w[cont_w].ie_acm_w    := ie_acm_ww;
			  vetor_w[cont_w].ie_urgente_w    := ie_urgente_ww;
              cont_w  := cont_w + 1;
              end;
            end loop;
            close C10;

          end if;

          end;
        end loop;
        close c05;
        end;
      elsif (ie_reaprazar_item_ciclo_p = 'S') then
        begin
        if (ie_grava_log_rastr_w = 'S') then
          CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR Parametros C14 ' || chr(10) ||
          '{'||chr(10)||
          '"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
          '"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
          '"ie_data_proc_w" : "'||ie_data_proc_w||'",'||chr(10)||
          '"ie_desagrupa_proced_w" : "'||ie_desagrupa_proced_w||'",'||chr(10)||
          '"ie_exibe_suspenso_w" : "'||ie_exibe_suspenso_w||'",'||chr(10)||
          '"ie_laboratorio_p" : "'||ie_laboratorio_p||'",'||chr(10)||
          '"ie_proc_associados_w" : "'||ie_proc_associados_w||'",'||chr(10)||
          '"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
          '"nr_Seq_item_p" : "'||nr_Seq_item_p||'",'||chr(10)||
          '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
          '"nr_ciclo_p" : "'||nr_ciclo_p||'",'||chr(10)||
          '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
          '"nr_prescricoes_p" : "'||nr_prescricoes_p||'",'||chr(10)||
          '"nr_seq_item_p" : "'||nr_seq_item_p||'",'||chr(10)||
          '"nr_seq_proc_interno_p" : "'||nr_seq_proc_interno_p||'",'||chr(10)||
          '"qt_item_p" : "'||qt_item_p||'",'||chr(10)||
          '"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}',
          0, 4000));
        end if;

        open c14;
        loop
        fetch c14 into
          nr_prescricao_w,
          nr_seq_item_w,
          nr_seq_horario_w,
          nr_seq_processo_w,
          nr_agrupamento_w,
          dt_horario_w,
          cd_material_exame_w;
        EXIT WHEN NOT FOUND; /* apply on c14 */
          begin

          ie_entrou_w  := 'S';
          vetor_w[cont_w].nr_prescricao_w    := nr_prescricao_w;
          vetor_w[cont_w].nr_seq_item_w    := nr_seq_item_w;
          vetor_w[cont_w].nr_seq_horario_w  := nr_seq_horario_w;
          vetor_w[cont_w].nr_seq_processo_w  := nr_seq_processo_w;
          vetor_w[cont_w].nr_agrupamento_w  := nr_agrupamento_w;
          vetor_w[cont_w].dt_horario_w    := dt_horario_w;
          vetor_w[cont_w].cd_material_exame_w  := cd_material_exame_w;
          cont_w  := cont_w + 1;


          if (coalesce(ie_reaprazar_assoc_w,'N') = 'S') then
            open C10;
            loop
            fetch C10 into
              nr_prescricao_ww,
              nr_seq_item_ww,
              nr_seq_horario_ww,
              nr_seq_processo_ww,
              nr_agrupamento_ww,
              dt_horario_ww,
              cd_intervalo_ww,
              cd_material_ww,
              qt_item_ww,
			  nr_sequencia_proc_ww,
			  ie_se_necessario_ww,
			  ie_acm_ww,
			  ie_urgente_ww;
            EXIT WHEN NOT FOUND; /* apply on C10 */
              begin


              vetor_w[cont_w].nr_prescricao_w    := nr_prescricao_ww;
              vetor_w[cont_w].nr_seq_item_w    := nr_seq_item_ww;
              vetor_w[cont_w].nr_seq_horario_w  := nr_seq_horario_ww;
              vetor_w[cont_w].nr_seq_processo_w  := nr_seq_processo_ww;
              vetor_w[cont_w].nr_agrupamento_w  := nr_agrupamento_ww;
              vetor_w[cont_w].dt_horario_w    := dt_horario_ww;
              vetor_w[cont_w].ie_item_associado_w  := 'S';
			  vetor_w[cont_w].nr_sequencia_proc_w	:= nr_sequencia_proc_ww;

              vetor_w[cont_w].cd_material_w    := cd_material_ww;
              vetor_w[cont_w].cd_intervalo_w    := cd_intervalo_ww;
              vetor_w[cont_w].qt_material_w    := qt_item_ww;
			  vetor_w[cont_w].ie_se_necessario_w    := ie_se_necessario_ww;
			  vetor_w[cont_w].ie_acm_w    := ie_acm_ww;
			  vetor_w[cont_w].ie_urgente_w    := ie_urgente_ww;

              cont_w  := cont_w + 1;
              end;
            end loop;
            close C10;

          end if;

          end;
        end loop;
        close c14;


        end;
      end if;

      CALL envia_SMS_proc_reapraz(nr_prescricao_p, nr_prescricoes_p, nm_usuario_p);

      if (ie_entrou_w  = 'N') then
        --'Nao foi possivel aprazar o horario, verifique se as prescricoes deste item ainda estao vigentes!
        CALL Wheb_mensagem_pck.exibir_mensagem_abort(174602);
      end if;
      end;
    elsif (ie_tipo_item_p = 'R') then
      begin
      if (ie_reaprazar_item_ciclo_p = 'N') then
        begin
        if (ie_grava_log_rastr_w = 'S') then
          CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR Parametros C06 ' || chr(10) ||
          '{'||chr(10)||
          '"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
          '"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
          '"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
          '"ds_componentes_p" : "'||ds_componentes_p||'",'||chr(10)||
          '"dt_horario_desejado_p" : "'||to_char(dt_horario_desejado_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
          '"ie_data_proc_w" : "'||ie_data_proc_w||'",'||chr(10)||
          '"ie_desagrupa_proced_w" : "'||ie_desagrupa_proced_w||'",'||chr(10)||
          '"ie_exibe_suspenso_w" : "'||ie_exibe_suspenso_w||'",'||chr(10)||
          '"ie_laboratorio_p" : "'||ie_laboratorio_p||'",'||chr(10)||
          '"ie_proc_associados_w" : "'||ie_proc_associados_w||'",'||chr(10)||
          '"ie_reaprazar_seguintes_p" : "'||ie_reaprazar_seguintes_p||'",'||chr(10)||
          '"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
          ' "ie_data_lib_prescr_w": "' || ie_data_lib_prescr_w  || '",' || chr(10) ||
          '"nr_Seq_item_p" : "'||nr_Seq_item_p||'",'||chr(10)||
          '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
          '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
          '"nr_prescricoes_p" : "'||nr_prescricoes_p||'",'||chr(10)||
          '"nr_seq_item_p" : "'||nr_seq_item_p||'",'||chr(10)||
          '"nr_seq_proc_interno_p" : "'||nr_seq_proc_interno_p||'",'||chr(10)||
          '"nr_seq_prot_glic_p" : "'||nr_seq_prot_glic_p||'",'||chr(10)||
          '"qt_item_p" : "'||qt_item_p||'",'||chr(10)||
          '"qt_minutos_w" : "'||qt_minutos_w||'",'||chr(10)||
          '"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}',
          0, 4000));
        end if;

        open c06;
        loop
        fetch c06 into
          nr_prescricao_w,
          nr_seq_item_w,
          nr_seq_horario_w,
          nr_seq_processo_w,
          nr_agrupamento_w,
          dt_horario_w,
          nr_seq_cpoe_w;
        EXIT WHEN NOT FOUND; /* apply on c06 */
          begin
          vetor_w[cont_w].nr_prescricao_w    := nr_prescricao_w;
          vetor_w[cont_w].nr_seq_item_w    := nr_seq_item_w;
          vetor_w[cont_w].nr_seq_horario_w  := nr_seq_horario_w;
          vetor_w[cont_w].nr_seq_processo_w  := nr_seq_processo_w;
          vetor_w[cont_w].nr_agrupamento_w  := nr_agrupamento_w;
          vetor_w[cont_w].dt_horario_w    := dt_horario_w;
          vetor_w[cont_w].nr_seq_cpoe_w    := nr_seq_cpoe_w;
          cont_w  := cont_w + 1;
          end;
        end loop;
        close c06;
        end;
      elsif (ie_reaprazar_item_ciclo_p = 'S') then
        begin
        if (ie_grava_log_rastr_w = 'S') then
          CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR Parametros C15 ' || chr(10) ||
          '{'||chr(10)||
          '"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
          '"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
          '"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
          '"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
          '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
          '"nr_ciclo_p" : "'||nr_ciclo_p||'",'||chr(10)||
          '"qt_item_p" : "'||qt_item_p||'",'||chr(10)||
          '"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}',
          0, 4000));
        end if;

        open c15;
        loop
        fetch c15 into
          nr_prescricao_w,
          nr_seq_item_w,
          nr_seq_horario_w,
          nr_seq_processo_w,
          nr_agrupamento_w,
          dt_horario_w;
        EXIT WHEN NOT FOUND; /* apply on c15 */
          begin
          vetor_w[cont_w].nr_prescricao_w    := nr_prescricao_w;
          vetor_w[cont_w].nr_seq_item_w    := nr_seq_item_w;
          vetor_w[cont_w].nr_seq_horario_w  := nr_seq_horario_w;
          vetor_w[cont_w].nr_seq_processo_w  := nr_seq_processo_w;
          vetor_w[cont_w].nr_agrupamento_w  := nr_agrupamento_w;
          vetor_w[cont_w].dt_horario_w    := dt_horario_w;
          cont_w  := cont_w + 1;
          end;
        end loop;
        close c15;
        end;
      end if;

      end;
    elsif (ie_tipo_item_p = 'E') then
      begin
      if (ie_grava_log_rastr_w = 'S') then
        CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR Parametros C07 ' || chr(10) ||
        '{'||chr(10)||
        '"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
        '"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
        '"dt_horario_desejado_p" : "'||to_char(dt_horario_desejado_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
        '"ie_reaprazar_seguintes_p" : "'||ie_reaprazar_seguintes_p||'",'||chr(10)||
        '"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
        '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
        '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
        '"nr_prescricoes_p" : "'||nr_prescricoes_p||'",'||chr(10)||
        '"nr_seq_item_p" : "'||nr_seq_item_p||'",'||chr(10)||
        '"qt_minutos_w" : "'||qt_minutos_w||'",'||chr(10)||
        '"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}',
        0, 4000));
      end if;

      open c07;
      loop
      fetch c07 into
        nr_prescricao_w,
        nr_seq_item_w,
        nr_seq_horario_w,
        nr_seq_processo_w,
        nr_agrupamento_w,
        dt_horario_w;
      EXIT WHEN NOT FOUND; /* apply on c07 */
        begin
        vetor_w[cont_w].nr_prescricao_w    := nr_prescricao_w;
        vetor_w[cont_w].nr_seq_item_w    := nr_seq_item_w;
        vetor_w[cont_w].nr_seq_horario_w  := nr_seq_horario_w;
        vetor_w[cont_w].nr_seq_processo_w  := nr_seq_processo_w;
        vetor_w[cont_w].nr_agrupamento_w  := nr_agrupamento_w;
        vetor_w[cont_w].dt_horario_w    := dt_horario_w;
        cont_w  := cont_w + 1;

          if (ie_grava_log_rastr_w = 'S') then
            CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR Parametros C17 ' || chr(10) ||
            '{'||chr(10)||
            '"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
            '"dt_horario_w" : "'||to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
            '"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
            '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
            '"nr_prescricao_w" : "'||nr_prescricao_w||'",'||chr(10)||
            '"nr_seq_item_w" : "'||nr_seq_item_w||'"}',
            0, 4000));
          end if;

          open c17;
          loop
          fetch c17 into
            nr_prescricao_ww,
            nr_seq_item_ww,
            nr_seq_horario_ww,
            nr_seq_processo_ww,
            nr_agrupamento_ww,
            dt_horario_ww;
          EXIT WHEN NOT FOUND; /* apply on c17 */
            begin

            vetor_w[cont_w].nr_prescricao_w    := nr_prescricao_ww;
            vetor_w[cont_w].nr_seq_item_w    := nr_seq_item_ww;
            vetor_w[cont_w].nr_seq_horario_w  := nr_seq_horario_ww;
            vetor_w[cont_w].nr_seq_processo_w  := nr_seq_processo_ww;
            vetor_w[cont_w].nr_agrupamento_w  := nr_agrupamento_ww;
            vetor_w[cont_w].dt_horario_w    := dt_horario_ww;
            vetor_w[cont_w].ie_item_associado_w  := 'S';

            cont_w  := cont_w + 1;
            end;
          end loop;
          close c17;

        end;
      end loop;
      close c07;
      end;
    elsif (ie_tipo_item_p = 'IA') then
      begin
      if (ie_grava_log_rastr_w = 'S') then
        CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR Parametros C08 ' || chr(10) ||
        '{'||chr(10)||
        '"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
        '"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
        '"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
        '"dt_horario_desejado_p" : "'||to_char(dt_horario_desejado_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
        '"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
        '"ie_reaprazar_seguintes_p" : "'||ie_reaprazar_seguintes_p||'",'||chr(10)||
        '"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
        '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
        '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
        '"nr_prescricoes_p" : "'||nr_prescricoes_p||'",'||chr(10)||
        '"nr_seq_item_p" : "'||nr_seq_item_p||'",'||chr(10)||
        '"qt_item_p" : "'||qt_item_p||'",'||chr(10)||
        '"qt_minutos_w" : "'||qt_minutos_w||'",'||chr(10)||
        '"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}',
        0, 4000));
      end if;

      open c08;
      loop
      fetch c08 into
        nr_prescricao_w,
        nr_seq_item_w,
        nr_seq_horario_w,
        nr_seq_processo_w,
        nr_agrupamento_w,
        dt_horario_w,
		cd_material_w,
		ie_se_necessario_w,
		ie_acm_w,
		ie_urgente_w;
      EXIT WHEN NOT FOUND; /* apply on c08 */
        begin
        vetor_w[cont_w].nr_prescricao_w    := nr_prescricao_w;
        vetor_w[cont_w].nr_seq_item_w    := nr_seq_item_w;
        vetor_w[cont_w].nr_seq_horario_w  := nr_seq_horario_w;
        vetor_w[cont_w].nr_seq_processo_w  := nr_seq_processo_w;
        vetor_w[cont_w].nr_agrupamento_w  := nr_agrupamento_w;
        vetor_w[cont_w].dt_horario_w    := dt_horario_w;
		vetor_w[cont_w].cd_material_w    := cd_material_w;
		vetor_w[cont_w].ie_se_necessario_w	:= ie_se_necessario_w;
		vetor_w[cont_w].ie_acm_w	:= ie_acm_w;
		vetor_w[cont_w].ie_urgente_w	:= ie_urgente_w;

        cont_w  := cont_w + 1;
        end;
      end loop;
      close c08;
      end;
    elsif (ie_tipo_item_p = 'IAG') then
      begin
      if (ie_grava_log_rastr_w = 'S') then
        CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR Parametros C11 ' || chr(10) ||
        '{'||chr(10)||
        '"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
        '"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
        '"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
        '"dt_horario_desejado_p" : "'||to_char(dt_horario_desejado_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
        '"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
        '"ie_reaprazar_seguintes_p" : "'||ie_reaprazar_seguintes_p||'",'||chr(10)||
        '"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
        '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
        '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
        '"nr_prescricoes_p" : "'||nr_prescricoes_p||'",'||chr(10)||
        '"nr_seq_item_p" : "'||nr_seq_item_p||'",'||chr(10)||
        '"qt_minutos_w" : "'||qt_minutos_w||'",'||chr(10)||
        '"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}',
        0, 4000));
      end if;

      open c11;
      loop
      fetch c11 into
        nr_prescricao_w,
        nr_seq_item_w,
        nr_seq_horario_w,
        nr_seq_processo_w,
        nr_agrupamento_w,
        dt_horario_w,
		cd_material_w,
		ie_se_necessario_w,
		ie_acm_w,
		ie_urgente_w;
      EXIT WHEN NOT FOUND; /* apply on c11 */
        begin
        vetor_w[cont_w].nr_prescricao_w    := nr_prescricao_w;
        vetor_w[cont_w].nr_seq_item_w    := nr_seq_item_w;
        vetor_w[cont_w].nr_seq_horario_w  := nr_seq_horario_w;
        vetor_w[cont_w].nr_seq_processo_w  := nr_seq_processo_w;
        vetor_w[cont_w].nr_agrupamento_w  := nr_agrupamento_w;
        vetor_w[cont_w].dt_horario_w    := dt_horario_w;
		vetor_w[cont_w].cd_material_w    := cd_material_w;
		vetor_w[cont_w].ie_se_necessario_w	:= ie_se_necessario_w;
		vetor_w[cont_w].ie_acm_w	:= ie_acm_w;
		vetor_w[cont_w].ie_urgente_w	:= ie_urgente_w;

        cont_w  := cont_w + 1;
        end;
      end loop;
      close c11;
      end;
    elsif (ie_tipo_item_p = 'SOL') then
      begin
      if (ie_reaprazar_item_ciclo_p = 'N') then
        begin
        if (ie_grava_log_rastr_w = 'S') then
          CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR Parametros C09 ' || chr(10) ||
          '{'||chr(10)||
          '"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
          '"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
          '"dt_horario_desejado_p" : "'||to_char(dt_horario_desejado_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
          '"ie_reaprazar_seguintes_p" : "'||ie_reaprazar_seguintes_p||'",'||chr(10)||
          '"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
          '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
          '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
          '"nr_seq_item_p" : "'||nr_seq_item_p||'",'||chr(10)||
          '"qt_minutos_w" : "'||qt_minutos_w||'",'||chr(10)||
          '"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}',
          0, 4000));
        end if;

        open c09;
        loop
        fetch c09 into
          nr_prescricao_w,
          nr_seq_item_w,
          nr_seq_horario_w,
          nr_seq_processo_w,
          nr_agrupamento_w,
          dt_horario_w,
          nr_etapa_sol_w,
          nr_seq_solucao_w,
          nr_seq_cpoe_w,
		  cd_material_w,
		  ie_se_necessario_w,
		  ie_acm_w,
		  ie_urgente_w;
        EXIT WHEN NOT FOUND; /* apply on c09 */
          begin
          vetor_w[cont_w].nr_prescricao_w    := nr_prescricao_w;
          vetor_w[cont_w].nr_seq_item_w    := nr_seq_item_w;
          vetor_w[cont_w].nr_seq_horario_w  := nr_seq_horario_w;
          vetor_w[cont_w].nr_seq_processo_w  := nr_seq_processo_w;
          vetor_w[cont_w].nr_agrupamento_w  := nr_agrupamento_w;
          vetor_w[cont_w].dt_horario_w    := dt_horario_w;
          vetor_w[cont_w].nr_etapa_w    := nr_etapa_sol_w;
          vetor_w[cont_w].nr_seq_solucao_w  := nr_seq_solucao_w;
          vetor_w[cont_w].nr_seq_cpoe_w    := nr_seq_cpoe_w;
		  vetor_w[cont_w].cd_material_w    := cd_material_w;
		  vetor_w[cont_w].ie_se_necessario_w	:= ie_se_necessario_w;
		  vetor_w[cont_w].ie_acm_w	:= ie_acm_w;
		  vetor_w[cont_w].ie_urgente_w	:= ie_urgente_w;

          cont_w  := cont_w + 1;
          end;
        end loop;
        close c09;
        end;
      elsif (ie_reaprazar_item_ciclo_p = 'S') then
        begin
        if (ie_grava_log_rastr_w = 'S') then
          CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR Parametros C13 ' || chr(10) ||
          '{'||chr(10)||
          '"cd_setor_pac_w" : "'||cd_setor_pac_w||'",'||chr(10)||
          '"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
          '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
          '"nr_ciclo_p" : "'||nr_ciclo_p||'",'||chr(10)||
          '"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}',
          0, 4000));
        end if;

        open c13;
        loop
        fetch c13 into
          nr_prescricao_w,
          nr_seq_item_w,
          nr_seq_horario_w,
          nr_seq_processo_w,
          nr_agrupamento_w,
          dt_horario_w,
          nr_etapa_sol_w,
          nr_seq_solucao_w,
          cd_material_w;
        EXIT WHEN NOT FOUND; /* apply on c13 */
          begin

          vetor_w[cont_w].nr_prescricao_w    := nr_prescricao_w;
          vetor_w[cont_w].nr_seq_item_w    := nr_seq_item_w;
          vetor_w[cont_w].nr_seq_horario_w  := nr_seq_horario_w;
          vetor_w[cont_w].nr_seq_processo_w  := nr_seq_processo_w;
          vetor_w[cont_w].nr_agrupamento_w  := nr_agrupamento_w;
          vetor_w[cont_w].dt_horario_w    := dt_horario_w;
          vetor_w[cont_w].nr_etapa_w      := nr_etapa_sol_w;
          vetor_w[cont_w].nr_seq_solucao_w  := nr_seq_solucao_w;
          vetor_w[cont_w].cd_material_w    := cd_material_w;
          cont_w  := cont_w + 1;
          end;
        end loop;
        close c13;
        end;
      end if;
      end;
    elsif (ie_tipo_item_p = 'O') then
      begin
      if (ie_grava_log_rastr_w = 'S') then
        CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR Parametros C18 ' || chr(10) ||
        '{'||chr(10)||
        '"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
        '"dt_horario_desejado_p" : "'||to_char(dt_horario_desejado_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
        '"ie_reaprazar_seguintes_p" : "'||ie_reaprazar_seguintes_p||'",'||chr(10)||
        '"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
        '"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
        '"nr_prescricoes_p" : "'||nr_prescricoes_p||'",'||chr(10)||
        '"nr_seq_item_p" : "'||nr_seq_item_p||'",'||chr(10)||
        '"qt_minutos_w" : "'||qt_minutos_w||'",'||chr(10)||
        '"sysdate" : "'||to_char(clock_timestamp(), 'dd/mm/yyyy hh24:mi:ss')||'"}',
        0, 4000));
      end if;

      open c18;
      loop
      fetch c18 into
        nr_prescricao_w,
        nr_seq_item_w,
        dt_horario_w,
        nr_seq_horario_w,
        nr_seq_cpoe_w;
      EXIT WHEN NOT FOUND; /* apply on c18 */
        begin
        vetor_w[cont_w].nr_prescricao_w    := nr_prescricao_w;
        vetor_w[cont_w].nr_seq_item_w    := nr_seq_item_w;
        vetor_w[cont_w].nr_seq_horario_w  := nr_seq_horario_w;
        vetor_w[cont_w].dt_horario_w    := dt_horario_w;
        vetor_w[cont_w].nr_seq_cpoe_w    := nr_seq_cpoe_w;

        cont_w  := cont_w + 1;

        end;
      end loop;
      close c18;
      end;

    end if;

    qt_registros_vetor_w  := vetor_w.count - 1;
    qt_controle_ww    := 0;
    x      := -1;

    while(x < qt_registros_vetor_w) and (qt_controle_ww    < 1000) loop
      begin
      x := x + 1;
      qt_controle_ww  := qt_controle_ww + 1;

      varsql_row_count_w  := 0;

      if (ie_grava_log_rastr_w = 'S') then
        CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR Parametros funcao e farmacia ' || chr(10) ||
        '{' || chr(10) ||
			  ' "nr_prescricao_w": "' || vetor_w[x].nr_prescricao_w || '"' || chr(10) ||
        ' "nr_seq_item_w": "' || vetor_w[x].nr_seq_item_w || '"' || chr(10) ||
        ' "nr_seq_horario_w": "' || vetor_w[x].nr_seq_horario_w || '"' || chr(10) ||
        ' "nr_seq_processo_w": "' || vetor_w[x].nr_seq_processo_w || '"' || chr(10) ||
        ' "nr_agrupamento_w": "' || vetor_w[x].nr_agrupamento_w || '"' || chr(10) ||
        ' "dt_horario_w": "' || vetor_w[x].dt_horario_w || '"' || chr(10) ||
        ' "nr_etapa_w": "' || vetor_w[x].nr_etapa_w || '"' || chr(10) ||
        ' "nr_seq_solucao_w": "' || vetor_w[x].nr_seq_solucao_w || '"' || chr(10) ||
        ' "ie_item_associado_w": "' || vetor_w[x].ie_item_associado_w || '"' || chr(10) ||
        ' "ie_acm_sn_ww": "' || vetor_w[x].ie_acm_sn_ww || '"' || chr(10) ||
        ' "cd_material_exame_w": "' || vetor_w[x].cd_material_exame_w || '"' || chr(10) ||
        ' "cd_material_w": "' || vetor_w[x].cd_material_w || '"' || chr(10) ||
        ' "cd_intervalo_w": "' || vetor_w[x].cd_intervalo_w || '"' || chr(10) ||
        ' "qt_material_w": "' || vetor_w[x].qt_material_w || '"' || chr(10) ||
        ' "nr_seq_cpoe_w": "' || vetor_w[x].nr_seq_cpoe_w || '"' || chr(10) ||
        ' "nr_sequencia_proc_w": "' || vetor_w[x].nr_sequencia_proc_w || '"' || chr(10) ||
        ' "ds_item_w": "' || vetor_w[x].ds_item_w || '"' || chr(10) ||
        ' "ie_se_necessario_w": "' || vetor_w[x].ie_se_necessario_w || '"' || chr(10) ||
        ' "ie_acm_w": "' || vetor_w[x].ie_acm_w || '"' || chr(10) ||
        ' "ie_urgente_w": "' || vetor_w[x].ie_urgente_w || '"' || chr(10) ||
        '}',
        0, 4000));
      end if;

      if (ie_reaprazar_seguintes_p  = 'S') and (qt_minutos_w       < 0) then
        dt_horario_desejado_w    := vetor_w[x].dt_horario_w + (qt_minutos_w/1440);
      end if;

	  ie_validar_lote_w	:= (ie_tipo_item_p in ('M', 'S', 'IAH', 'MAT', 'IA', 'SOL', 'IAG', 'LD') or ((vetor_w[x](.ie_item_associado_w IS NOT NULL AND .ie_item_associado_w::text <> '')) and (ie_tipo_item_p in ('P','G','C','I'))));

      if  (ie_consiste_lote_atendido_w  <> 'N' AND ie_validar_lote_w) then

        select  max(ie_status_lote),
          max(b.nr_seq_lote),
          max(substr(obter_valor_dominio(2116,IE_STATUS_LOTE),1,255))
        into STRICT  ie_status_lote_w,
          nr_seq_lote_w,
          ds_status_w
        from  ap_lote a,
          prescr_mat_hor b
        where  a.nr_sequencia  = b.nr_seq_lote
        and  b.nr_sequencia  = vetor_w[x].nr_seq_horario_w;

        if (ie_consiste_lote_atendido_w = 'S') then
          if (coalesce(ie_status_lote_w,'11')  in ('A', 'D')) then
          --O item reaprazado nao ira alterar a dispensacao pois o mesmo ja foi atendido no lote #@LOTE#@ . O lote foi ' || ds_status_w;
            ds_inconsist_lote_p  := wheb_mensagem_pck.get_texto(294655, 'LOTE='||nr_seq_lote_w)||ds_status_w;
            if (ie_grava_log_rastr_w = 'S') then
              CALL adep_gerar_log_rastr('REAPRAZAR_HORARIO_ITEM_PRESCR ds_inconsist_lote_p atribuicao 1: ' || ds_inconsist_lote_p);
            end if;

          end if;
        else
          if (coalesce(ie_status_lote_w,'11')  = 'R') then
            CALL Wheb_mensagem_pck.exibir_mensagem_abort(215211);
          elsif (coalesce(ie_status_lote_w,'11') in ('A', 'D')) then
            CALL Wheb_mensagem_pck.exibir_mensagem_abort(215212);
          end if;
        end if;

      end if;

      /* consistir horario anterior */

      if  ((qt_minutos_w < 0 or ie_tipo_item_p in ('MAT','M','S','D')) and (coalesce(ds_inconsist_lote_p::text, '') = '') and (ie_perm_ant_validade_w <> 'S')) then

        if ((vetor_w[x](.ie_item_associado_w IS NOT NULL AND .ie_item_associado_w::text <> '')) and (ie_tipo_item_p in ('P','G','C','I','S'))) then
          ie_tipo_item_w    := 'MAT';
          cd_item_w      := vetor_w[x].cd_material_w;
          cd_intervalo_www  := vetor_w[x].cd_intervalo_w;
          qt_item_w      := vetor_w[x].qt_material_w;
        elsif (ie_tipo_item_p in ('D','R')) then
          ie_tipo_item_w    := ie_tipo_item_p;
          cd_intervalo_www  := cd_intervalo_p;
          qt_item_w      := qt_item_p;

          CALL consistir_reaprazar_horario(cd_estabelecimento_p, nm_usuario_p, nr_atendimento_p, ie_tipo_item_w, cd_item_p, cd_intervalo_www, qt_item_w, nr_prescricoes_p, vetor_w[x].nr_prescricao_w, nr_seq_item_p, vetor_w[x].nr_seq_horario_w, dt_horario_desejado_w, ie_laboratorio_p);
        else
          ie_tipo_item_w    := ie_tipo_item_p;
          cd_item_w      := (cd_item_p)::numeric;
          cd_intervalo_www  := cd_intervalo_p;
          qt_item_w      := qt_item_p;
        end if;

        if (ie_tipo_item_p <> 'D') and (ie_tipo_item_p <> 'R') then
            if (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') then
                CALL consistir_reaprazar_horario(cd_estabelecimento_p, nm_usuario_p, nr_atendimento_p, ie_tipo_item_w, cd_item_w, cd_intervalo_www, qt_item_w, nr_prescricoes_p, vetor_w[x].nr_prescricao_w, nr_seq_item_p, nr_seq_horario_p, dt_horario_desejado_w, ie_laboratorio_p);
            else
                CALL consistir_reaprazar_horario(cd_estabelecimento_p, nm_usuario_p, nr_atendimento_p, ie_tipo_item_w, cd_item_w, cd_intervalo_www, qt_item_w, nr_prescricoes_p, vetor_w[x].nr_prescricao_w, nr_seq_item_p, vetor_w[x].nr_seq_horario_w, dt_horario_desejado_w, ie_laboratorio_p);
            end if;
        end if;

      end if;

    if (ie_tipo_item_p = 'D') then /* dietas orais */
		if (vetor_w[x].nr_seq_cpoe_w > 0) and (vetor_w[x](.nr_seq_cpoe_w IS NOT NULL AND .nr_seq_cpoe_w::text <> '')) then

			select 	max(cpoe_obter_dt_suspensao(nr_sequencia, 'N')),
					max(dt_fim)
			into STRICT	dt_suspensao_cpoe_w,
					dt_fim_cpoe_w
			from 	cpoe_dieta
			where	nr_sequencia = vetor_w[x].nr_seq_cpoe_w
			and		dt_horario_desejado_p > coalesce(cpoe_obter_dt_suspensao(nr_sequencia, 'N'), dt_fim)
			and		(((cpoe_obter_dt_suspensao(nr_sequencia, 'N') IS NOT NULL AND (cpoe_obter_dt_suspensao(nr_sequencia, 'N'))::text <> '')) or (dt_fim IS NOT NULL AND dt_fim::text <> ''))
			and 	cd_funcao_origem = 2314;

			if (dt_suspensao_cpoe_w IS NOT NULL AND dt_suspensao_cpoe_w::text <> '') then
				ds_msg_w	:= wheb_mensagem_pck.get_Texto(820331, null) || ' ' || to_char(dt_suspensao_cpoe_w, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(cd_estabelecimento_w, nm_usuario_p)));
				CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_msg_w);
			elsif (dt_fim_cpoe_w IS NOT NULL AND dt_fim_cpoe_w::text <> '') then
				ds_msg_w	:= wheb_mensagem_pck.get_Texto(820333, null) || ' ' || to_char(dt_fim_cpoe_w, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(cd_estabelecimento_w, nm_usuario_p)));
				CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_msg_w);
			end if;
		end if;

        update	prescr_dieta_hor
        set		dt_horario = dt_horario + (qt_minutos_w/1440),
				nm_usuario = nm_usuario_p,
				qt_hor_reaprazamento = qt_minutos_w,
				nm_usuario_reaprazamento  = nm_usuario_p
        where	nr_sequencia = vetor_w[x].nr_seq_horario_w
		and		coalesce(dt_fim_horario::text, '') = '';

		GET DIAGNOSTICS varsql_row_count_w = ROW_COUNT;

		update 	prescr_mat_hor
		set		dt_horario = dt_horario + (qt_minutos_w/1440),
				nm_usuario = nm_usuario_p,
				qt_hor_reaprazamento = qt_minutos_w,
				nr_seq_turno 		 = Obter_turno_horario_prescr(coalesce(cd_estabelecimento_p, cd_estabelecimento_w),cd_setor_atendimento_w,to_char(dt_horario + (qt_minutos_w/1440),'hh24:mi'),cd_local_estoque_w),
				nm_usuario_reaprazamento  = nm_usuario_p
		where 	nr_sequencia = vetor_w[x].nr_seq_horario_w
		and		vetor_w[x].ie_item_associado_w = 'S'
		and		coalesce(dt_fim_horario::text, '') = '';

        GET DIAGNOSTICS ora2pg_rowcount = ROW_COUNT;


        varsql_row_count_w  := varsql_row_count_w +  ora2pg_rowcount;
    elsif (ie_tipo_item_p = 'O') then /* Gasoterapia */
		if (vetor_w[x].nr_seq_cpoe_w > 0) and (vetor_w[x](.nr_seq_cpoe_w IS NOT NULL AND .nr_seq_cpoe_w::text <> '')) then

			select 	max(cpoe_obter_dt_suspensao(nr_sequencia, 'G')),
					max(dt_fim)
			into STRICT	dt_suspensao_cpoe_w,
					dt_fim_cpoe_w
			from 	cpoe_gasoterapia
			where	nr_sequencia = vetor_w[x].nr_seq_cpoe_w
			and		dt_horario_desejado_p > coalesce(cpoe_obter_dt_suspensao(nr_sequencia, 'G'), dt_fim)
			and		(((cpoe_obter_dt_suspensao(nr_sequencia, 'G') IS NOT NULL AND (cpoe_obter_dt_suspensao(nr_sequencia, 'G'))::text <> '')) or (dt_fim IS NOT NULL AND dt_fim::text <> ''))
			and 	cd_funcao_origem = 2314;

			if (dt_suspensao_cpoe_w IS NOT NULL AND dt_suspensao_cpoe_w::text <> '') then
				ds_msg_w	:= wheb_mensagem_pck.get_Texto(820331, null) || ' ' || to_char(dt_suspensao_cpoe_w, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(cd_estabelecimento_w, nm_usuario_p)));
				CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_msg_w);
			elsif (dt_fim_cpoe_w IS NOT NULL AND dt_fim_cpoe_w::text <> '') then
				ds_msg_w	:= wheb_mensagem_pck.get_Texto(820333, null) || ' ' || to_char(dt_fim_cpoe_w, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(cd_estabelecimento_w, nm_usuario_p)));
				CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_msg_w);
			end if;
		end if;


        update	prescr_gasoterapia_hor
        set		dt_horario = dt_horario + (qt_minutos_w/1440),
				nm_usuario = nm_usuario_p,
				qt_hor_reaprazamento = qt_minutos_w
        where	nr_sequencia = vetor_w[x].nr_seq_horario_w;

        GET DIAGNOSTICS varsql_row_count_w = ROW_COUNT;

        if (ie_grava_log_rastr_w = 'S') then
          CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR chamada gerar_evento_reaprazamento IF 1' || chr(10) ||
          '{' || chr(10) ||
          ' "varsql_row_count_w" : "' || varsql_row_count_w || '"' || chr(10) ||
          ' "nr_atendimento_p" : "' || nr_atendimento_p || '"' || chr(10) ||
          ' "vetor_w(x).nr_prescricao_w" : "' || vetor_w[x].nr_prescricao_w || '"' || chr(10) ||
          ' "vetor_w(x).nr_seq_item_w" : "' || vetor_w[x].nr_seq_item_w || '"' || chr(10) ||
          ' "vetor_w(x).nr_seq_horario_w" : "' || vetor_w[x].nr_seq_horario_w || '"' || chr(10) ||
          ' "cd_item_p" : "' || cd_item_p || '"' || chr(10) ||
          ' "nr_seq_motivo_p" : "' || nr_seq_motivo_p || '"' || chr(10) ||
          ' "ds_justificativa_p" : "' || ds_justificativa_p || '"' || chr(10) ||
          ' "nm_usuario_p" : "' || nm_usuario_p || '"' || chr(10) ||
          ' "nr_seq_assinatura_p" : "' || nr_seq_assinatura_p || '"' || chr(10) ||
          ' "nr_seq_cpoe_p" : "' || nr_seq_cpoe_p || '"' || chr(10) ||
          '}', 0, 4000));
        end if;
        if (varsql_row_count_w > 0) then
          if (ie_grava_log_rastr_w = 'S') then
            CALL adep_gerar_log_rastr('REAPRAZAR_HORARIO_ITEM_PRESCR chamada gerar_evento_reaprazamento 1');
          end if;
          CALL gerar_evento_reaprazamento(nr_atendimento_p, vetor_w[x].nr_prescricao_w, vetor_w[x].nr_seq_item_w, vetor_w[x].nr_seq_horario_w, cd_item_p, 'O', 10, nr_Seq_motivo_p, ds_justificativa_p, nm_usuario_p, null, null, nr_seq_assinatura_p,  null, null, nr_seq_cpoe_p);

          --Reaprazar_horarios_seguintes(nr_atendimento_p, vetor_w(x).nr_seq_item_w, cd_intervalo_p, qt_item_p, dt_horario_p, ie_reaprazar_seguintes_p, vetor_w(x).nr_prescricao_w, nm_usuario_p, nr_agrupamento_p, ie_acm_sn_p, cd_unidade_medida_p, nr_prescricoes_p, qt_minutos_w);
        end if;

        CALL reaprazar_horario_dependentes(nr_atendimento_p, vetor_w[x].nr_prescricao_w, vetor_w[x].nr_seq_item_w, null, vetor_w[x].dt_horario_w, vetor_w[x].dt_horario_w + (qt_minutos_w/1440), qt_minutos_w, nm_usuario_p, null, ie_tipo_item_p);

	elsif (ie_tipo_item_p in ('S','M','LD', 'MAT','IA','IAG','SOL', 'IAH')) then /* suplementos orais, medicamentos, materiais e itens associados ao proc*/
		if	((ie_tipo_item_p = 'M') or (ie_tipo_item_p = 'SOL') or (ie_tipo_item_p = 'IAH')) and (vetor_w[x].nr_seq_cpoe_w > 0) and (vetor_w[x](.nr_seq_cpoe_w IS NOT NULL AND .nr_seq_cpoe_w::text <> '')) then

			select 	max(cpoe_obter_dt_suspensao(nr_sequencia, 'M')),
					max(coalesce(dt_fim_cih, dt_fim))
			into STRICT	dt_suspensao_cpoe_w,
					dt_fim_cpoe_w
			from 	cpoe_material
			where	nr_sequencia = vetor_w[x].nr_seq_cpoe_w
			and		dt_horario_desejado_P > coalesce(cpoe_obter_dt_suspensao(nr_sequencia, 'M'), coalesce(dt_fim_cih, dt_fim))
			and		(((cpoe_obter_dt_suspensao(nr_sequencia, 'M') IS NOT NULL AND (cpoe_obter_dt_suspensao(nr_sequencia, 'M'))::text <> '')) or ((coalesce(dt_fim_cih, dt_fim) IS NOT NULL AND (coalesce(dt_fim_cih, dt_fim))::text <> '')))
			and 	cd_funcao_origem = 2314;

			if (dt_suspensao_cpoe_w IS NOT NULL AND dt_suspensao_cpoe_w::text <> '') then
				ds_msg_w	:= wheb_mensagem_pck.get_Texto(820331, null) || ' ' || to_char(dt_suspensao_cpoe_w, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(cd_estabelecimento_w, nm_usuario_p)));
				CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_msg_w);
			elsif (dt_fim_cpoe_w IS NOT NULL AND dt_fim_cpoe_w::text <> '') then
				ds_msg_w	:= wheb_mensagem_pck.get_Texto(820333, null) || ' ' || to_char(dt_fim_cpoe_w, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(cd_estabelecimento_w, nm_usuario_p)));
				CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_msg_w);
			end if;

		elsif	((ie_tipo_item_p = 'S') or (ie_tipo_item_p = 'LD')) and (vetor_w[x].nr_seq_cpoe_w > 0) and (vetor_w[x](.nr_seq_cpoe_w IS NOT NULL AND .nr_seq_cpoe_w::text <> '')) then

			select 	max(cpoe_obter_dt_suspensao(nr_sequencia, 'N')),
					max(dt_fim)
			into STRICT	dt_suspensao_cpoe_w,
					dt_fim_cpoe_w
			from 	cpoe_dieta
			where	nr_sequencia = vetor_w[x].nr_seq_cpoe_w
			and		dt_horario_desejado_p > coalesce(cpoe_obter_dt_suspensao(nr_sequencia, 'N'), dt_fim)
			and		(((cpoe_obter_dt_suspensao(nr_sequencia, 'N') IS NOT NULL AND (cpoe_obter_dt_suspensao(nr_sequencia, 'N'))::text <> '')) or (dt_fim IS NOT NULL AND dt_fim::text <> ''))
			and 	cd_funcao_origem = 2314;

			if (dt_suspensao_cpoe_w IS NOT NULL AND dt_suspensao_cpoe_w::text <> '') then
				ds_msg_w	:= wheb_mensagem_pck.get_Texto(820331, null) || ' ' || to_char(dt_suspensao_cpoe_w, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(cd_estabelecimento_w, nm_usuario_p)));
				CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_msg_w);
			elsif (dt_fim_cpoe_w IS NOT NULL AND dt_fim_cpoe_w::text <> '') then
				ds_msg_w	:= wheb_mensagem_pck.get_Texto(820333, null) || ' ' || to_char(dt_fim_cpoe_w, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(cd_estabelecimento_w, nm_usuario_p)));
				CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_msg_w);
			end if;
			
			if (ie_tipo_item_p = 'LD') then
				cd_evolucao_p		=>	cd_evolucao_w := gerar_evolpaci_automa(	ie_tipo_item_p		=>	ie_tipo_item_p, nm_usuario_p		=>	nm_usuario_p, nr_atendimento_p	=>	nr_atendimento_p, ds_item_p			=>	vetor_w[x].ds_item_w, nr_seq_horario_p	=>	vetor_w[x].nr_seq_horario_w, ie_opcao_p			=>	'P', ds_hint_p			=>	'', dt_evento_p			=>	null, nr_prescricao_p		=>	null, qt_dose_p			=>	null, ds_unid_med_p		=>	null, ie_via_adm_p		=>	null, cd_evolucao_p		=>	cd_evolucao_w);
			end if;
			
		end if;

        if (ie_tipo_item_p in ('M', 'IAH')) and (wheb_assist_pck.Obter_Se_Consiste_REP(31,obter_perfil_ativo) = 'S') then

          SELECT * FROM Verifica_dose_maxima(nr_prescricao_p, nr_seq_item_p, 'S', ds_erro_w, ds_erro2_w, dt_horario_desejado_p, ie_tipo_cons_w, qt_dose_limite_w, cd_unidade_medida_limte_w) INTO STRICT ds_erro_w, ds_erro2_w, ie_tipo_cons_w, qt_dose_limite_w, cd_unidade_medida_limte_w;


          if (ds_erro2_w IS NOT NULL AND ds_erro2_w::text <> '') then
            -- A dose unitaria eh maior que a dose limite #@QT_LIMITE_PESSOA_P#@ #@CD_UNID_MED_LIMITE_P#@ por #@IE_DOSE_LIMITE_P#@
            --  #@DS_OBSERVACAO_P#@
            CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_erro2_w);
          end if;

        end if;
		
        select  max(cd_setor_atendimento),
				max(cd_local_estoque),
				max(cd_estabelecimento),
				max(cd_funcao_origem),
				max(dt_inicio_prescr)
        into STRICT  	cd_setor_atendimento_w,
				cd_local_estoque_w,
				cd_estabelecimento_w,
				cd_funcao_origem_w,
				dt_inicio_prescr_w
        from  	prescr_medica
        where	nr_prescricao = vetor_w[x].nr_prescricao_w;

        select	coalesce(b.cd_local_estoque,c.cd_local_estoque,cd_local_estoque_w)
        into STRICT	cd_local_estoque_w
        from  	prescr_mat_hor  b,
				prescr_material c
        where 	c.nr_sequencia  = b.nr_seq_material
        and  	c.nr_prescricao = b.nr_prescricao
        and  	b.nr_sequencia  = vetor_w[x].nr_seq_horario_w
        and  	c.nr_prescricao = vetor_w[x].nr_prescricao_w;

        if (ie_tipo_item_p in ('M', 'IAH', 'MAT','S')) then


			if (vetor_w[x](.nr_seq_cpoe_w IS NOT NULL AND .nr_seq_cpoe_w::text <> '')) and (ie_tipo_item_p in ('M', 'IAH', 'MAT')) then
				select	count(nr_sequencia)
				into STRICT	qt_suspenso_w
				from	cpoe_material
				where	nr_sequencia = vetor_w[x].nr_seq_cpoe_w
				and		(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
				and		(dt_lib_suspensao IS NOT NULL AND dt_lib_suspensao::text <> '')
				and		dt_horario_desejado_w > dt_suspensao  LIMIT 1;
			elsif (vetor_w[x](.nr_seq_cpoe_w IS NOT NULL AND .nr_seq_cpoe_w::text <> '')) then
				select	count(nr_sequencia)
				into STRICT	qt_suspenso_w
				from	cpoe_dieta
				where	nr_sequencia = vetor_w[x].nr_seq_cpoe_w
				and		(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
				and		(dt_lib_suspensao IS NOT NULL AND dt_lib_suspensao::text <> '')
				and		dt_horario_desejado_w > dt_suspensao  LIMIT 1;

            end if;

			if (qt_suspenso_w > 0 ) then					
				--O horario informado esta fora do periodo de validade do item na CPOE. Data de fim:
				ds_msg_w	:= wheb_mensagem_pck.get_Texto(820736, null);
				CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_msg_w);
			end if;
		end if;

		--Envia suspensao do item para Swisslog evento 437
		CALL swisslog_susp_horario_reap(vetor_w[x].nr_prescricao_w,null,vetor_w[x].nr_seq_horario_w,vetor_w[x].dt_horario_w,nm_usuario_p);

		/*atualiza classif urgente e nr_seq_classif*/

		select	max(coalesce(a.dt_lib_farmacia,b.dt_liberacao_medico))
		into STRICT	dt_liberacao_w
		from	prescr_material a,
				prescr_medica b
		where	a.nr_prescricao = b.nr_prescricao
		and 	a.nr_prescricao	= vetor_w[x].nr_prescricao_w
		and		a.nr_sequencia	= vetor_w[x].nr_seq_item_w;
		
		dt_horario_desejado_ww := (vetor_w[x].dt_horario_w + (qt_minutos_w/1440));
		
		dt_limite_agora_w		:= PKG_DATE_UTILS.get_DateTime(dt_liberacao_w + qt_min_agora_w/1440,dt_liberacao_w + qt_min_agora_w/1440);
		dt_limite_especial_w	:= PKG_DATE_UTILS.get_DateTime(dt_liberacao_w + qt_min_especial_w/1440,dt_liberacao_w + qt_min_especial_w/1440);
		nr_seq_turno_hor_ag_w 	:= Obter_turno_horario_prescr(coalesce(cd_estabelecimento_p, cd_estabelecimento_w),cd_setor_atendimento_w,to_char(dt_horario_desejado_ww,'hh24:mi'),cd_local_estoque_w);
		
		/*obter dt_limite_especial_w*/

		if (ie_classif_lote_w  = 'S' ) then
			nr_seq_turno_hor_esp_w 	:= Obter_turno_horario_prescr(coalesce(cd_estabelecimento_p, cd_estabelecimento_w),cd_setor_atendimento_w,to_char(dt_limite_especial_w,'hh24:mi'), cd_local_estoque_w);
			
			select	coalesce(to_char(max(b.hr_final),'hh24:mi'),'23:59')
			into STRICT	hr_turno_especial_w
			from	regra_turno_disp_param b,
					regra_turno_disp a
			where	a.nr_sequencia = b.nr_seq_turno
			and		a.cd_estabelecimento = coalesce(cd_estabelecimento_p, cd_estabelecimento_w)
			and		a.nr_sequencia = nr_seq_turno_hor_esp_w
			and (coalesce(b.cd_setor_atendimento,coalesce(cd_setor_atendimento_w,0))	= coalesce(cd_setor_atendimento_w,0))
			order by
					coalesce(b.cd_setor_atendimento,0),
					to_char(b.hr_final,'hh24:mi');

			if (dt_limite_especial_w IS NOT NULL AND dt_limite_especial_w::text <> '') then
				dt_limite_especial_w	:= pkg_date_utils.get_time(dt_limite_especial_w,hr_turno_especial_w||':00');
				if (hr_turno_especial_w = '00:00') then
					dt_limite_especial_w	:= pkg_date_utils.get_time(dt_limite_especial_w,'23:59:00');
				end if;
			end if;

			if (dt_liberacao_w > dt_limite_especial_w) then
				dt_limite_especial_w	:= dt_limite_especial_w + 1;
			end if;
		end if;	
		
		/*obter dt_limite_agora_w*/

		if (ie_agora_impressao_w = 'S') then		
			select	to_char(max(b.hr_inicial),'hh24:mi'),
					to_char(max(b.hr_final),'hh24:mi')
			into STRICT	hr_turno_agora_w,
					hr_final_turno_agora_w
			from	regra_turno_disp_param b,
					regra_turno_disp a
			where	a.nr_sequencia		= b.nr_seq_turno
			and		a.cd_estabelecimento = coalesce(cd_estabelecimento_p, cd_estabelecimento_w)
			and		a.nr_sequencia		= nr_seq_turno_hor_ag_w
			and (coalesce(b.cd_setor_atendimento,coalesce(cd_setor_atendimento_w,0))	= coalesce(cd_setor_atendimento_w,0));

			select	coalesce(max(qt_min_antes_atend), 0),
					coalesce(max(ie_define_agora), 'N')
			into STRICT	qt_min_antes_atend_w,
					ie_define_agora_w
			from	regra_tempo_disp
			where	cd_estabelecimento	= coalesce(cd_estabelecimento_p, cd_estabelecimento_w)
			and (coalesce(cd_setor_atendimento,coalesce(cd_setor_atendimento_w,0)) = coalesce(cd_setor_atendimento_w,0))
			and		nr_seq_turno = nr_seq_turno_hor_ag_w
			and		ie_situacao = 'A';
			
			begin
			exec_w := 'call ger_pres_mat_s_dt_lib_md_pck.calcular_dt_limite_agora_md(:1,:2,:3,:4,:5) into :result';

			EXECUTE exec_w using 	in hr_turno_agora_w,
											in hr_final_turno_agora_w,
											in dt_inicio_prescr_w,
											in qt_min_antes_atend_w,
											in dt_horario_desejado_ww,
											out dt_limite_agora_w;
			exception
				when others then
					dt_limite_agora_w := null;
			end;	
		end if;

		begin
		exec_w := 'call ger_pres_mat_s_dt_lib_md_pck.obter_classif_urgente_md(:1,:2,:3,:4,:5,:6,:7,:8,:9,:10,:11,:12,:13) into :result';

		EXECUTE exec_w using in 0,
									 in ie_classif_nao_padrao_w,
									 in obter_se_material_padronizado(coalesce(cd_estabelecimento_p, cd_estabelecimento_w), coalesce(vetor_w[x].cd_material_w, vetor_w[x].cd_material_exame_w)),
									 in ie_classif_normal_acm_sn_w,
									 in vetor_w[x].ie_se_necessario_w,
									 in vetor_w[x].ie_acm_w,
									 in dt_horario_desejado_ww,
									 in dt_limite_agora_w,
									 in vetor_w[x].ie_urgente_w,
									 in ie_agora_impressao_w,
									 in ie_define_agora_w, 
									 in qt_min_antes_atend_w,
									 in dt_limite_especial_w,
									 out ie_classif_urgente_w;

		exception
			when others then
			  ie_classif_urgente_w := null;
		end;

		update	prescr_mat_hor
        set		dt_horario      	 = dt_horario + (qt_minutos_w/1440),
				nm_usuario      	 = nm_usuario_p,
				qt_hor_reaprazamento = qt_minutos_w,
				nr_seq_turno 		 = Obter_turno_horario_prescr(coalesce(cd_estabelecimento_p, cd_estabelecimento_w),cd_setor_atendimento_w,to_char(dt_horario + (qt_minutos_w/1440),'hh24:mi'),cd_local_estoque_w),
				nm_usuario_reaprazamento  = nm_usuario_p,
				ie_classif_urgente 	= coalesce(ie_classif_urgente_w,ie_classif_urgente)
        where  nr_sequencia      = vetor_w[x].nr_seq_horario_w
		and		coalesce(dt_fim_horario::text, '') = '';

        GET DIAGNOSTICS varsql_row_count_w = ROW_COUNT;
		ie_atualizou_medic_w	:= 'S';

        if (ie_tipo_item_p in ('M', 'IAH')) then
          select 	max(ie_operacao),
					coalesce(max(qt_operacao),0)
          into STRICT  	ie_operacao_w,
					qt_operacao_w
          from  	intervalo_prescricao
          where  	cd_intervalo = cd_intervalo_p;

          select  max(dt_proxima_dose),
              max(cd_intervalo)
          into STRICT  dt_proxima_dose_w,
              cd_intervalo_w
          from  prescr_material
          where  nr_prescricao = vetor_w[x].nr_prescricao_w
          and    nr_sequencia = vetor_w[x].nr_seq_item_w;

          begin

          if (ie_operacao_w = 'H') and (qt_operacao_w > 24) and (dt_proxima_dose_w IS NOT NULL AND dt_proxima_dose_w::text <> '') then
            dt_proxima_dose_new_w := dt_horario_desejado_w + (obter_ocorrencia_intervalo(coalesce(cd_intervalo_p,cd_intervalo_w),24,'H') / 24);

            update  prescr_material
            set    dt_proxima_dose = dt_proxima_dose_new_w
            where  nr_prescricao   = vetor_w[x].nr_prescricao_w
            and    nr_sequencia   = vetor_w[x].nr_seq_item_w;
          end if;
          exception when others then
            null;
          end;
        end if;

		if (cd_funcao_origem_w = 2314) and (vetor_w[x].nr_seq_cpoe_w > 0) and (vetor_w[x](.nr_seq_cpoe_w IS NOT NULL AND .nr_seq_cpoe_w::text <> ''))then
			nr_seq_mat_cpoe_w := vetor_w[x].nr_seq_cpoe_w;
		else
			nr_seq_mat_cpoe_w := 0;
		end if;

        if (nr_prescricao_w2 <> vetor_w[x].nr_prescricao_w) or (nr_seq_mat_cpoe_w2 <> vetor_w[x].nr_seq_cpoe_w and vetor_w[x].nr_seq_cpoe_w > 0 and cd_funcao_origem_w = 2314) then

          CALL Reaprazar_horarios_seguintes(nr_atendimento_p, cd_item_p, cd_intervalo_p, qt_item_p, dt_horario_p, ie_reaprazar_seguintes_p, vetor_w[x].nr_prescricao_w, nm_usuario_p, nr_agrupamento_p, ie_acm_sn_p, cd_unidade_medida_p, nr_prescricoes_p, qt_minutos_w,nr_seq_mat_cpoe_w);

          nr_prescricao_w2 := vetor_w[x].nr_prescricao_w;

          if (cd_funcao_origem_w = 2314) and (vetor_w[x].nr_seq_cpoe_w > 0) and (vetor_w[x](.nr_seq_cpoe_w IS NOT NULL AND .nr_seq_cpoe_w::text <> ''))then

            nr_seq_mat_cpoe_w2 := vetor_w[x].nr_seq_cpoe_w;
          end if;
        end if;

        select  max(obter_desc_material(cd_material))
        into STRICT  	ds_item_w
        from  	prescr_mat_hor
        WHERE 	nr_sequencia  = vetor_w[x].nr_seq_horario_w;

        cd_evolucao_w := Gerar_evolPaci_automa('M', nm_usuario_p, nr_atendimento_p, ds_item_w, vetor_w[x].nr_seq_horario_w, 'P', '', null, null, null, null, null, cd_evolucao_w);

        if (ie_grava_log_rastr_w = 'S') then
            CALL adep_gerar_log_rastr('{'||chr(10)||
                '"'||$$plsql_unit||'" : "'||$$plsql_line||'",'||chr(10)||
                '"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
                '"nm_usuario_p" : "'||nm_usuario_p||'",'||chr(10)||
                '"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
                '"vetor_w(x).nr_seq_horario_w" : "'||vetor_w[x].nr_seq_horario_w||'",'||chr(10)||
                '"vetor_w(x).nr_seq_processo_w" : "'||vetor_w[x].nr_seq_processo_w||'",'||chr(10)||
                '"vetor_w(x).dt_horario_w" : "'||to_char(vetor_w[x].dt_horario_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
                '"vetor_w(x).nr_prescricao_w" : "'||vetor_w[x].nr_prescricao_w||'",'||chr(10)||
                '"vetor_w(x).nr_seq_item_w" : "'||vetor_w[x].nr_seq_item_w||'",'||chr(10)||
                '"vetor_w(x).nr_agrupamento_w" : "'||vetor_w[x].nr_agrupamento_w||'",'||chr(10)||
                '"qt_minutos_w" : "'||qt_minutos_w||'"}');
        end if;
        if (ie_tipo_item_p in ('M', 'IAH', 'SOL', 'LD', 'S')) then
            CALL reaprazar_processo_horario(nr_atendimento_p, vetor_w[x].nr_seq_horario_w, vetor_w[x].nr_seq_processo_w, vetor_w[x].dt_horario_w, vetor_w[x].dt_horario_w + (qt_minutos_w/1440), nm_usuario_p);
            if (ie_tipo_item_p not in ('LD', 'S')) then
                CALL reaprazar_horario_dependentes(nr_atendimento_p, vetor_w[x].nr_prescricao_w, vetor_w[x].nr_seq_item_w, vetor_w[x].nr_agrupamento_w, vetor_w[x].dt_horario_w, vetor_w[x].dt_horario_w + (qt_minutos_w/1440), qt_minutos_w, nm_usuario_p, null);
            end if;
        end if;

        if   ((ie_tipo_item_p = 'S') or (ie_tipo_item_p = 'SOL')) and (varsql_row_count_w > 0) then

          if (ie_tipo_item_p <> 'S') and (vetor_w[x].nr_etapa_w = 1) and (vetor_w[x](.nr_seq_solucao_w IS NOT NULL AND .nr_seq_solucao_w::text <> '')) then
            update  prescr_solucao
            set  dt_status  = dt_horario_desejado_p
            where  nr_prescricao  = nr_prescricao_p
            and  nr_seq_solucao  = vetor_w[x].nr_seq_solucao_w;
          end if;

          select  nextval('prescr_solucao_evento_seq')
          into STRICT  nr_sequencia_w
;

          insert into prescr_solucao_evento(
            nr_sequencia,
            dt_atualizacao,
            nm_usuario,
            dt_atualizacao_nrec,
            nm_usuario_nrec,
            nr_prescricao,
            nr_seq_solucao,
            nr_seq_material,
            nr_seq_procedimento,
            nr_seq_nut,
            nr_seq_nut_neo,
            ie_forma_infusao,
            ie_tipo_dosagem,
            qt_dosagem,
            qt_vol_infundido,
            qt_vol_desprezado,
            cd_pessoa_fisica,
            ie_alteracao,
            dt_alteracao,
            ie_evento_valido,
            nr_seq_motivo,
            ds_observacao,
            ie_tipo_solucao,
            nr_etapa_evento,
            nr_seq_assinatura,
            dt_horario,
            cd_funcao)
          values (
            nr_sequencia_w,
            clock_timestamp(),
            nm_usuario_p,
            clock_timestamp(),
            nm_usuario_p,
            nr_prescricao_p,
            nr_seq_item_p,
            null,
            null,
            null,
            null,
            null,
            null,
            null,
            null,
            null,
            obter_dados_usuario_opcao(nm_usuario_p, 'C'),
            17,
            clock_timestamp(),
            'S',
            nr_seq_motivo_p,
            ds_justificativa_p,
            1,
            vetor_w[x].nr_etapa_w,
            nr_seq_assinatura_p,
            dt_horario_w,
            cd_funcao_p);

			ie_gera_sem_certificado_w	:= 'N';

			if (wheb_assist_pck.get_gerar_sem_certificado = 'S') then
				ie_gera_sem_certificado_w := adep_obter_se_assin_perfil(35004, obter_perfil_ativo); --ADEP - ADL -  Reaprazamento
			end if;

			if	((wheb_assist_pck.get_cd_certificado IS NOT NULL AND wheb_assist_pck.get_cd_certificado::text <> '') OR (ie_gera_sem_certificado_w = 'S')) AND (coalesce(obter_data_assinatura_digital(nr_seq_assinatura_p)::text, '') = '') then

	            select	max(cd_pessoa_fisica)
				into STRICT	cd_pessoa_fisica_w
				from	atendimento_paciente
				where	nr_atendimento = nr_atendimento_p;

				CALL Gerar_registro_pendente_PEP('ADEP',nr_prescricao_p, cd_pessoa_fisica_w, nr_atendimento_p,nm_usuario_p, 'A', vetor_w[x].nr_seq_horario_w, ie_tipo_item_p,null,null,null,null,null,null,null,null,null,null,null,null,null,null,nr_sequencia_w);

			end if;	

        end if;
    if (ie_grava_log_rastr_w = 'S') then
      CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR Parametros C21 ' || chr(10) ||
      '{'||chr(10)||
      '"cd_estabelecimento_p" : "'||cd_estabelecimento_p||'"}',
      0, 4000));
    end if;

		open c21;
		loop
		fetch c21 into	
			nr_seq_classif_w,
			ie_classif_urgente_w,
			ie_controlado_w,
			ie_padronizado_w;
		EXIT WHEN NOT FOUND; /* apply on c21 */
			begin
			if (ie_controlado_w = 'A') and (ie_padronizado_w = 'A') then
				update	prescr_mat_hor
				set	nr_seq_classif		= nr_seq_classif_w
				where	nr_prescricao		= vetor_w[x].nr_prescricao_w
				and	ie_classif_urgente	= ie_classif_urgente_w;
			elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'S') then
				update	prescr_mat_hor
				set	nr_seq_classif		= nr_seq_classif_w
				where	nr_prescricao		= vetor_w[x].nr_prescricao_w
				and	ie_padronizado		= 'S'
				and	ie_classif_urgente	= ie_classif_urgente_w;
			elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'N') then
				update	prescr_mat_hor
				set	nr_seq_classif		= nr_seq_classif_w
				where	nr_prescricao		= vetor_w[x].nr_prescricao_w
				and	ie_padronizado		= 'N'
				and	ie_classif_urgente	= ie_classif_urgente_w;
			elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'A') then
				update	prescr_mat_hor
				set	nr_seq_classif		= nr_seq_classif_w
				where	nr_prescricao		= vetor_w[x].nr_prescricao_w
				and	ie_controlado		= 'N'
				and	ie_classif_urgente	= ie_classif_urgente_w;
			elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'N') then
				update	prescr_mat_hor
				set	nr_seq_classif		= nr_seq_classif_w
				where	nr_prescricao		= vetor_w[x].nr_prescricao_w
				and	ie_controlado		= 'N'
				and	ie_padronizado		= 'N'
				and	ie_classif_urgente	= ie_classif_urgente_w;
			elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'S') then
				update	prescr_mat_hor
				set	nr_seq_classif		= nr_seq_classif_w
				where	nr_prescricao		= vetor_w[x].nr_prescricao_w
				and	ie_controlado		= 'N'
				and	ie_padronizado		= 'S'
				and	ie_classif_urgente	= ie_classif_urgente_w;
			elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'A') then
				update	prescr_mat_hor
				set	nr_seq_classif		= nr_seq_classif_w
				where	nr_prescricao		= vetor_w[x].nr_prescricao_w
				and	ie_controlado		= 'S'
				and	ie_classif_urgente	= ie_classif_urgente_w;
			elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'N') then
				update	prescr_mat_hor
				set	nr_seq_classif		= nr_seq_classif_w
				where	nr_prescricao		= vetor_w[x].nr_prescricao_w
				and	ie_controlado		= 'S'
				and	ie_padronizado		= 'N'
				and	ie_classif_urgente	= ie_classif_urgente_w;
			elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'S') then
				update	prescr_mat_hor
				set	nr_seq_classif		= nr_seq_classif_w
				where	nr_prescricao	= vetor_w[x].nr_prescricao_w
				and	ie_controlado		= 'S'
				and	ie_padronizado		= 'S'
				and	ie_classif_urgente	= ie_classif_urgente_w;
			end if;
			end;
		end loop;
		close c21;

	elsif (ie_tipo_item_p in ('P','G','C','I')) then /* procedimentos e controles de glicemia */
		if (vetor_w[x].nr_seq_cpoe_w > 0) and (vetor_w[x](.nr_seq_cpoe_w IS NOT NULL AND .nr_seq_cpoe_w::text <> '')) then

			select 	max(cpoe_obter_dt_suspensao(nr_sequencia, 'P')),
					max(dt_fim)
			into STRICT	dt_suspensao_cpoe_w,
					dt_fim_cpoe_w
			from 	cpoe_procedimento
			where	nr_sequencia = vetor_w[x].nr_seq_cpoe_w
			and		dt_horario_desejado_p > coalesce(cpoe_obter_dt_suspensao(nr_sequencia, 'P'), dt_fim)
			and		(((cpoe_obter_dt_suspensao(nr_sequencia, 'P') IS NOT NULL AND (cpoe_obter_dt_suspensao(nr_sequencia, 'P'))::text <> '')) or (dt_fim IS NOT NULL AND dt_fim::text <> ''))
			and 	cd_funcao_origem = 2314;

			if (dt_suspensao_cpoe_w IS NOT NULL AND dt_suspensao_cpoe_w::text <> '') then
				ds_msg_w	:= wheb_mensagem_pck.get_Texto(820331, null) || ' ' || to_char(dt_suspensao_cpoe_w, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(cd_estabelecimento_w, nm_usuario_p)));
				CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_msg_w);
			elsif (dt_fim_cpoe_w IS NOT NULL AND dt_fim_cpoe_w::text <> '') then
				ds_msg_w	:= wheb_mensagem_pck.get_Texto(820333, null) || ' ' || to_char(dt_fim_cpoe_w, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(cd_estabelecimento_w, nm_usuario_p)));
				CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_msg_w);
			end if;
		end if;

        if (vetor_w[x]coalesce(.ie_item_associado_w::text, '') = '') then

          	update  prescr_proc_hor
          	set  	dt_horario      = dt_horario + (qt_minutos_w/1440),
           		 	nm_usuario      = nm_usuario_p,
          	  		qt_hor_reaprazamento    = qt_minutos_w,
          	  		nm_usuario_reaprazamento  = nm_usuario_p
          	where  	nr_sequencia      = vetor_w[x].nr_seq_horario_w
			and		coalesce(dt_fim_horario::text, '') = '';

          	GET DIAGNOSTICS varsql_row_count_w = ROW_COUNT;

            select  max(substr(Obter_Desc_Prescr_Proc(CD_PROCEDIMENTO,IE_ORIGEM_PROCED,nr_seq_proc_interno),1,240))
          	into STRICT  ds_item_w
          	from  prescr_proc_hor
          	WHERE  nr_sequencia  = vetor_w[x].nr_seq_horario_w;

          	cd_evolucao_w := Gerar_evolPaci_automa('M', nm_usuario_p, nr_atendimento_p, ds_item_w, vetor_w[x].nr_seq_horario_w, 'P', '', null, null, null, null, null, cd_evolucao_w);

            if  (ie_reaprazar_exame_mat_p = 'S'  AND ie_tipo_item_p = 'P') then

            	update  prescr_proc_hor
            	set 	dt_horario              = dt_horario + (qt_minutos_w/1440),
            	 	 	nm_usuario              = nm_usuario_p,
            	 		qt_hor_reaprazamento    = qt_minutos_w,
            	  		nm_usuario_reaprazamento  = nm_usuario_p
            	where 	cd_material_exame    = vetor_w[x].cd_material_exame_w
            	and 	dt_horario           = vetor_w[x].dt_horario_w
				and 	nr_prescricao 		 = vetor_w[x].nr_prescricao_w
				and		coalesce(dt_fim_horario::text, '') = '';
          	end if;

        else

          	update  prescr_mat_hor
          	set  	dt_horario      = dt_horario + (qt_minutos_w/1440),
          	  		nm_usuario      = nm_usuario_p,
          	  		qt_hor_reaprazamento    = qt_minutos_w,
		            nm_usuario_reaprazamento  = nm_usuario_p,
					nr_seq_turno 		 = Obter_turno_horario_prescr(coalesce(cd_estabelecimento_p, cd_estabelecimento_w),cd_setor_atendimento_w,to_char(dt_horario + (qt_minutos_w/1440),'hh24:mi'),cd_local_estoque_w)
          	where  	dt_horario = vetor_w[x].dt_horario_w
			and		nr_prescricao = vetor_w[x].nr_prescricao_w
			and		nr_seq_material in (	SELECT	nr_sequencia
											from	prescr_material
											where	nr_prescricao = vetor_w[x].nr_prescricao_w
											and		nr_sequencia_proc = vetor_w[x].nr_sequencia_proc_w)
			and		dt_horario <> dt_horario + (qt_minutos_w/1440)
			and		coalesce(dt_fim_horario::text, '') = '';

			CALL reaprazar_processo_horario(nr_atendimento_p, vetor_w[x].nr_seq_horario_w, vetor_w[x].nr_seq_processo_w, vetor_w[x].dt_horario_w, vetor_w[x].dt_horario_w + (qt_minutos_w/1440), nm_usuario_p);

      if (ie_grava_log_rastr_w = 'S') then
        CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR chamada GERAR_LOTE_REAPR_PRESCR ' || chr(10) ||
        '{' || chr(10) ||
        ' "vetor_w(x).nr_prescricao_w": ' || vetor_w[x].nr_prescricao_w || '"' || chr(10) ||
        ' "vetor_w(x).nr_sequencia_proc_w": ' || vetor_w[x].nr_sequencia_proc_w || '"' || chr(10) || 
        ' "vetor_w(x).nr_seq_horario_w": ' || vetor_w[x].nr_seq_horario_w || '"' || chr(10) || 
        ' "ie_gera_lote_w": ' || ie_gera_lote_w || '"' || chr(10) || 
        ' "qt_minutos_w": ' || qt_minutos_w || '"' || chr(10) || 
        ' "dt_horario_desejado_p": ' || dt_horario_desejado_p || '"' || chr(10) || 
        '}',
        0, 4000));
      end if;

            if (not ie_gerou_lt_novo_proc_w) and
				((coalesce(ie_gera_lote_w, 'N') = 'S') or
				((coalesce(ie_gera_lote_w, 'N') = 'A') and (qt_minutos_w < 0)) or
				((coalesce(ie_gera_lote_w, 'N') = 'T') and (qt_minutos_w > 0)) or
				((coalesce(ie_gera_lote_w, 'N') = 'U') and (dt_horario_desejado_p >= clock_timestamp()))) then

		        if  ((coalesce(ie_gera_lote_w, 'N') <> 'U') or (dt_horario_desejado_p >= clock_timestamp())) then
					ie_gerou_lt_novo_proc_w	:= true;
          if (ie_grava_log_rastr_w = 'S') then
            CALL adep_gerar_log_rastr('REAPRAZAR_HORARIO_ITEM_PRESCR chamada Gerar_Lote_Reapr_Prescr 1');
          end if;
					CALL Gerar_Lote_Reapr_Prescr(vetor_w[x].nr_prescricao_w, vetor_w[x].nr_sequencia_proc_w, vetor_w[x].nr_seq_horario_w, 'N', nm_usuario_p, 'RHP');
				end if;			
			end if;	


        end if;

    elsif (ie_tipo_item_p = 'R') then /* recomendacoes */
		if (vetor_w[x].nr_seq_cpoe_w > 0) and (vetor_w[x](.nr_seq_cpoe_w IS NOT NULL AND .nr_seq_cpoe_w::text <> '')) then

			select 	max(cpoe_obter_dt_suspensao(nr_sequencia, 'R')),
					max(dt_fim)
			into STRICT	dt_suspensao_cpoe_w,
					dt_fim_cpoe_w
			from 	cpoe_recomendacao
			where	nr_sequencia = vetor_w[x].nr_seq_cpoe_w
			and		dt_horario_desejado_p > coalesce(cpoe_obter_dt_suspensao(nr_sequencia, 'R'), dt_fim)
			and		(((cpoe_obter_dt_suspensao(nr_sequencia, 'R') IS NOT NULL AND (cpoe_obter_dt_suspensao(nr_sequencia, 'R'))::text <> '')) or (dt_fim IS NOT NULL AND dt_fim::text <> ''))
			and 	cd_funcao_origem = 2314;

			if (dt_suspensao_cpoe_w IS NOT NULL AND dt_suspensao_cpoe_w::text <> '') then
				ds_msg_w	:= wheb_mensagem_pck.get_Texto(820331, null) || ' ' || to_char(dt_suspensao_cpoe_w, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(cd_estabelecimento_w, nm_usuario_p)));
				CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_msg_w);
			elsif (dt_fim_cpoe_w IS NOT NULL AND dt_fim_cpoe_w::text <> '') then
				ds_msg_w	:= wheb_mensagem_pck.get_Texto(820333, null) || ' ' || to_char(dt_fim_cpoe_w, pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(cd_estabelecimento_w, nm_usuario_p)));
				CALL wheb_mensagem_pck.exibir_mensagem_abort(ds_msg_w);
			end if;

		end if;

        update  prescr_rec_hor
        set  dt_horario      = dt_horario + (qt_minutos_w/1440),
          nm_usuario      = nm_usuario_p,
          qt_hor_reaprazamento    = qt_minutos_w,
          nm_usuario_reaprazamento  = nm_usuario_p
        where  nr_sequencia      = vetor_w[x].nr_seq_horario_w
		and		coalesce(dt_fim_horario::text, '') = '';

        GET DIAGNOSTICS varsql_row_count_w = ROW_COUNT;

        select  max(coalesce(obter_desc_recomendacao(b.cd_recomendacao), b.DS_RECOMENDACAO))
        into STRICT  ds_item_w
        from  prescr_rec_hor a,
            prescr_recomendacao b
        WHERE  a.nr_sequencia  = vetor_w[x].nr_seq_horario_w
        and    a.nr_prescricao = b.nr_prescricao
        and    a.nr_seq_recomendacao = b.nr_sequencia;

        cd_evolucao_w := Gerar_evolPaci_automa('R', nm_usuario_p, nr_atendimento_p, ds_item_w, vetor_w[x].nr_seq_horario_w, 'P', '', null, null, null, null, null, cd_evolucao_w);

    elsif (ie_tipo_item_p = 'E') then /* sae */
		if (vetor_w[x]coalesce(.ie_item_associado_w::text, '') = '') then

			update  pe_prescr_proc_hor
			set		dt_horario = dt_horario + (qt_minutos_w/1440),
					nm_usuario = nm_usuario_p,
					qt_hor_reaprazamento = qt_minutos_w,
					nm_usuario_reaprazamento = nm_usuario_p
			where	nr_sequencia = vetor_w[x].nr_seq_horario_w;

			GET DIAGNOSTICS varsql_row_count_w = ROW_COUNT;

			select	max(substr(obter_desc_intervencoes(NR_SEQ_PROC),1,255))
			into STRICT	ds_item_w
			from	pe_prescr_proc_hor
			where	nr_sequencia  = vetor_w[x].nr_seq_horario_w;

			cd_evolucao_w := Gerar_evolPaci_automa('M', nm_usuario_p, nr_atendimento_p, ds_item_w, vetor_w[x].nr_seq_horario_w, 'P', '', null, null, null, null, null, cd_evolucao_w);

        else
			--Envia suspensao do item para Swisslog evento 437
			CALL swisslog_susp_horario_reap(vetor_w[x].nr_prescricao_w,null,vetor_w[x].nr_seq_horario_w,vetor_w[x].dt_horario_w,nm_usuario_p);

			update  prescr_mat_hor
			set		dt_horario = dt_horario + (qt_minutos_w/1440),	
					nm_usuario = nm_usuario_p,
					qt_hor_reaprazamento = qt_minutos_w,
					nm_usuario_reaprazamento  = nm_usuario_p,
					nr_seq_turno 		 = Obter_turno_horario_prescr(coalesce(cd_estabelecimento_p, cd_estabelecimento_w),cd_setor_atendimento_w,to_char(dt_horario + (qt_minutos_w/1440),'hh24:mi'),cd_local_estoque_w)
			where 	nr_sequencia = vetor_w[x].nr_seq_horario_w
			and		coalesce(dt_fim_horario::text, '') = '';

        end if;

    end if;

	if (ie_tipo_item_p in ('M', 'IAH'))  and (ie_inativa_horario_ant_w = 'S')  then
		CALL inat_medic_fora_ini_prescr(vetor_w[x].nr_prescricao_w,vetor_w[x].nr_seq_item_w,vetor_w[x].nr_seq_horario_w,dt_horario_desejado_p);
	end if;

    begin
	if  ((varsql_row_count_w > 0) or (ie_atualizou_medic_w = 'S')) and (qt_minutos_w > 0) and (ie_elimina_horario_w  = 'S') and
		((vetor_w[x]coalesce(.ie_item_associado_w::text, '') = '') or (ie_tipo_item_p <> 'E')) then
		ds_lista_eliminados_w := null;

		ds_lista_eliminados_w := eliminar_horarios_inv_prescr(cd_estabelecimento_p, nm_usuario_p, nr_atendimento_p, ie_tipo_item_p, cd_item_p, cd_intervalo_p, ie_laboratorio_p, vetor_w[x].nr_prescricao_w, vetor_w[x].nr_seq_item_w, ds_lista_eliminados_w);

		ds_lista_eliminados_p := ds_lista_eliminados_p || ds_lista_eliminados_w;
    if (ie_grava_log_rastr_w = 'S') then
      CALL adep_gerar_log_rastr('REAPRAZAR_HORARIO_ITEM_PRESCR ds_lista_eliminados_p atribuicao 2: ' || ds_lista_eliminados_p);
    end if;

	end if;

      /* atualizar prescricao cursor */

	nr_prescr_atual_w := vetor_w[x].nr_prescricao_w;

  if (ie_grava_log_rastr_w = 'S') then
    CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR chamada GERAR_LOTE_REAPR_PRESCR 2 ' || chr(10) ||
    '{' || chr(10) ||
    ' "vetor_w(x).nr_prescricao_w": ' || vetor_w[x].nr_prescricao_w || '"' || chr(10) ||
    ' "vetor_w(x).nr_seq_item_w": ' || vetor_w[x].nr_seq_item_w || '"' || chr(10) ||
    ' "vetor_w(x).nr_seq_horario_w": ' || vetor_w[x].nr_seq_horario_w || '"' || chr(10) ||
    ' "vetor_w(x).ie_item_associado_w": ' || vetor_w[x].ie_item_associado_w || '"' || chr(10) ||
    ' "ie_tipo_item_p": ' || ie_tipo_item_p || '"' || chr(10) ||
    ' "ie_gera_lote_w": ' || ie_gera_lote_w || '"' || chr(10) ||
    ' "qt_minutos_w": ' || qt_minutos_w || '"' || chr(10) ||
    ' "dt_horario_desejado_p": ' || dt_horario_desejado_p || '"' || chr(10) ||
    '}',
    0, 4000));
  end if;

	if  ((vetor_w[x].ie_item_associado_w <> 'S') or (ie_tipo_item_p <> 'P')) and
		((coalesce(ie_gera_lote_w, 'N') = 'S') or
		((coalesce(ie_gera_lote_w, 'N') = 'A') and (qt_minutos_w < 0)) or
		((coalesce(ie_gera_lote_w, 'N') = 'T') and (qt_minutos_w > 0)) or
		((coalesce(ie_gera_lote_w, 'N') = 'U') and (dt_horario_desejado_p >= clock_timestamp()))) then

		if  ((coalesce(ie_gera_lote_w, 'N') <> 'U') or (dt_horario_desejado_p >= clock_timestamp())) then
      if (ie_grava_log_rastr_w = 'S') then
        CALL adep_gerar_log_rastr('REAPRAZAR_HORARIO_ITEM_PRESCR chamada Gerar_Lote_Reapr_Prescr 2');
      end if;
			CALL Gerar_Lote_Reapr_Prescr(vetor_w[x].nr_prescricao_w, vetor_w[x].nr_seq_item_w, vetor_w[x].nr_seq_horario_w, 'N', nm_usuario_p, 'RHIP');
		else
			ds_inconsist_lote_p := wheb_mensagem_pck.get_texto(351818, null);
      if (ie_grava_log_rastr_w = 'S') then
        CALL adep_gerar_log_rastr('REAPRAZAR_HORARIO_ITEM_PRESCR ds_inconsist_lote_p atribuicao 2: ' || ds_inconsist_lote_p);
      end if;
		end if;

		if (ie_elimina_horario_w  = 'S') and
		  ((vetor_w[x]coalesce(.ie_item_associado_w::text, '') = '') or (ie_tipo_item_p <> 'E')) then
		  ds_lista_eliminados_w := null;

		  ds_lista_eliminados_w := eliminar_horarios_inv_prescr(cd_estabelecimento_p, nm_usuario_p, nr_atendimento_p, ie_tipo_item_p, cd_item_p, cd_intervalo_p, ie_laboratorio_p, vetor_w[x].nr_prescricao_w, vetor_w[x].nr_seq_item_w, ds_lista_eliminados_w);

		  ds_lista_eliminados_p := ds_lista_eliminados_p || ds_lista_eliminados_w;		
      if (ie_grava_log_rastr_w = 'S') then
        CALL adep_gerar_log_rastr('REAPRAZAR_HORARIO_ITEM_PRESCR ds_lista_eliminados_p atribuicao 3: ' || ds_lista_eliminados_p);
      end if;

		end if;

	elsif   ((coalesce(ie_gera_lote_w, 'N') = 'U') and (dt_horario_desejado_p < clock_timestamp())) then
		ds_inconsist_lote_p := wheb_mensagem_pck.get_texto(351818, null);
    if (ie_grava_log_rastr_w = 'S') then
      CALL adep_gerar_log_rastr('REAPRAZAR_HORARIO_ITEM_PRESCR ds_inconsist_lote_p atribuicao 3: ' || ds_inconsist_lote_p);
    end if;
	end if;

  if (ie_grava_log_rastr_w = 'S') then
    CALL adep_gerar_log_rastr(substr('REAPRAZAR_HORARIO_ITEM_PRESCR chamada gerar_evento_reaprazamento IF 2' || chr(10) ||
    '{' || chr(10) ||
    ' "varsql_row_count_w" : "' || varsql_row_count_w || '"' || chr(10) ||
    ' "ie_atualizou_medic_w" : "' || ie_atualizou_medic_w || '"' || chr(10) ||
    ' "ie_tipo_item_p" : "' || ie_tipo_item_p || '"' || chr(10) ||
    ' "vetor_w(x).ie_item_associado_w" : "' || vetor_w[x].ie_item_associado_w || '"' || chr(10) ||
    ' "nr_atendimento_p" : "' || nr_atendimento_p || '"' || chr(10) ||
    ' "vetor_w(x).nr_prescricao_w" : "' || vetor_w[x].nr_prescricao_w || '"' || chr(10) ||
    ' "vetor_w(x).nr_seq_item_w" : "' || vetor_w[x].nr_seq_item_w || '"' || chr(10) ||
    ' "vetor_w(x).nr_seq_horario_w" : "' || vetor_w[x].nr_seq_horario_w || '"' || chr(10) ||
    ' "cd_item_p" : "' || cd_item_p || '"' || chr(10) ||
    ' "vetor_w(x).cd_material_w" : "' || vetor_w[x].cd_material_w || '"' || chr(10) ||
    ' "nr_seq_motivo_p" : "' || nr_seq_motivo_p || '"' || chr(10) ||
    ' "ds_justificativa_p" : "' || ds_justificativa_p || '"' || chr(10) ||
    ' "nm_usuario_p" : "' || nm_usuario_p || '"' || chr(10) ||
    ' "nr_seq_proc_interno_p" : "' || nr_seq_proc_interno_p || '"' || chr(10) ||
    ' "vetor_w(x).ie_acm_sn_ww" : "' || vetor_w[x].ie_acm_sn_ww || '"' || chr(10) ||
    ' "nr_seq_assinatura_p" : "' || nr_seq_assinatura_p || '"' || chr(10) ||
    ' "qt_item_p" : "' || qt_item_p || '"' || chr(10) ||
    ' "cd_funcao_p" : "' || cd_funcao_p || '"' || chr(10) ||
    '}', 0, 4000));
  end if;
	if  ((varsql_row_count_w > 0) or (ie_atualizou_medic_w = 'S')) and (ie_tipo_item_p <> 'SOL') and (ie_tipo_item_p <> 'O') then

        if (ie_tipo_item_p = 'D' and coalesce(vetor_w[x].ie_item_associado_w, 'N') = 'N') then
            if (ie_grava_log_rastr_w = 'S') then
              CALL adep_gerar_log_rastr('REAPRAZAR_HORARIO_ITEM_PRESCR chamada gerar_evento_reaprazamento 2');
            end if;
           CALL gerar_evento_reaprazamento(nr_atendimento_p, vetor_w[x].nr_prescricao_w, vetor_w[x].nr_seq_item_w, vetor_w[x].nr_seq_horario_w, cd_item_p, ie_tipo_item_p, 10, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_proc_interno_p,vetor_w[x].ie_acm_sn_ww, nr_seq_assinatura_p, qt_item_p, cd_funcao_p);
        else
            if (ie_grava_log_rastr_w = 'S') then
              CALL adep_gerar_log_rastr('REAPRAZAR_HORARIO_ITEM_PRESCR chamada gerar_evento_reaprazamento 3');
            end if;
           CALL gerar_evento_reaprazamento(nr_atendimento_p, vetor_w[x].nr_prescricao_w, vetor_w[x].nr_seq_item_w, vetor_w[x].nr_seq_horario_w, coalesce(vetor_w[x].cd_material_w, cd_item_p), ie_tipo_item_p, 10, nr_seq_motivo_p, ds_justificativa_p, nm_usuario_p, nr_seq_proc_interno_p,vetor_w[x].ie_acm_sn_ww, nr_seq_assinatura_p, qt_item_p, cd_funcao_p);
        end if;

    end if;
    exception when others then
        null;
    end;
	
    commit;

      end;
    end loop;
    end;
elsif (coalesce(qt_minutos_w,0) = 0) then
	--'O horario atual do item e o horario desejado informado sao iguais!
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(174605);
end if;
end if;

commit;

CALL wheb_usuario_pck.set_ie_commit('S');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reaprazar_horario_item_prescr ( cd_estabelecimento_p bigint, nr_atendimento_p bigint, ie_tipo_item_p text, cd_item_p text, cd_intervalo_p text, qt_item_p bigint, dt_horario_p timestamp, dt_horario_desejado_p timestamp, ie_reaprazar_seguintes_p text, nr_prescricoes_p text, nr_prescricao_p bigint, nr_seq_item_p bigint, ie_laboratorio_p text, nr_seq_motivo_p bigint, ds_justificativa_p text, nm_usuario_p text, ds_lista_eliminados_p INOUT text, nr_seq_proc_interno_p bigint, ds_inconsist_lote_p INOUT text, nr_agrupamento_p bigint, ie_acm_sn_p text, nr_seq_assinatura_p bigint default null, ie_reaprazar_exame_mat_p text DEFAULT NULL, nr_ciclo_p bigint DEFAULT NULL, ie_reaprazar_item_ciclo_p text DEFAULT NULL, cd_unidade_medida_p text DEFAULT NULL, ds_componentes_p text DEFAULT NULL, ie_via_aplicacao_p text default null, nr_seq_prot_glic_p bigint default null, ds_item_p text default '', cd_funcao_p bigint default null, ds_observacao_p text default null, nr_seq_cpoe_p bigint default null, nr_seq_horario_p prescr_mat_hor.nr_sequencia%type default null) FROM PUBLIC;

