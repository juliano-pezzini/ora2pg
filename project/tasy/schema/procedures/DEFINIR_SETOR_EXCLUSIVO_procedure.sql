-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE definir_setor_exclusivo ( ie_estrutura_p text, cd_estrutura_p bigint, cd_setor_exclusivo_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
cd_setor_exclusivo_w		integer;
ds_setor_exclusivo_w		varchar(60);
ds_setor_exclusivo_destino_w	varchar(60);
ie_situacao_w			varchar(1);
nr_sequencia_w			bigint;
ie_limpa_relac_setor_w		varchar(1);

C01 CURSOR FOR
	SELECT	cd_procedimento,
		ie_origem_proced
	from	estrutura_procedimento_v
	where	((ie_estrutura_p = 'A' AND cd_area_procedimento = cd_estrutura_p) or
		 (ie_estrutura_p = 'E' AND cd_especialidade = cd_estrutura_p) or
		 (ie_estrutura_p = 'G' AND cd_grupo_proc = cd_estrutura_p))
	order by cd_procedimento,
		 ie_origem_proced;

C02 CURSOR FOR
	SELECT 	cd_procedimento,
		ie_origem_proced
	from 	sus_estrutura_procedimento_v
	where 	((ie_estrutura_p = 'P' AND nr_seq_grupo = cd_estrutura_p) or
		 (ie_estrutura_p = 'S' AND nr_seq_subgrupo = cd_estrutura_p) or
		 (ie_estrutura_p = 'F' AND nr_seq_forma_org = cd_estrutura_p))
	order by cd_procedimento,
		 ie_origem_proced;


BEGIN

ie_limpa_relac_setor_w:= coalesce(Obter_valor_param_usuario(25, 21, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento),'N');

if (ie_estrutura_p in ('A','E','G')) then

	open C01;
	loop
	fetch C01 into
		cd_procedimento_w,
		ie_origem_proced_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		select 	max(cd_setor_exclusivo),
			max(substr(obter_nome_setor(cd_setor_exclusivo),1,60)),
			max(substr(obter_nome_setor(cd_setor_exclusivo_p),1,60)),
			coalesce(max(ie_situacao),'I')
		into STRICT	cd_setor_exclusivo_w,
			ds_setor_exclusivo_w,
			ds_setor_exclusivo_destino_w,
			ie_situacao_w
		from 	procedimento
		where 	cd_procedimento  = cd_procedimento_w
		and 	ie_origem_proced = ie_origem_proced_w;

		if (ie_situacao_w = 'A') then

			update	procedimento
			set 	cd_setor_exclusivo = cd_setor_exclusivo_p,
				nm_usuario	   = nm_usuario_p,
				dt_atualizacao     = clock_timestamp()
			where 	cd_procedimento	   = cd_procedimento_w
			and 	ie_origem_proced   = ie_origem_proced_w;

			insert	into procedimento_hist(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					cd_procedimento,
					ie_origem_proced,
					ds_titulo,
					ds_historico)
				values (nextval('procedimento_hist_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					cd_procedimento_w,
					ie_origem_proced_w,
					upper(wheb_mensagem_pck.get_texto(802491)),
					wheb_mensagem_pck.get_texto(802493,'cd_setor_exclusivo_w=' || cd_setor_exclusivo_w || ';' ||
									   'ds_setor_exclusivo_w=' || ds_setor_exclusivo_w || ';' ||
									   'cd_setor_exclusivo_p=' || cd_setor_exclusivo_p || ';' ||
									   'ds_setor_exclusivo_destino_w=' || ds_setor_exclusivo_destino_w));


			if (ie_limpa_relac_setor_w = 'S') and (coalesce(cd_setor_exclusivo_p::text, '') = '') then
				delete from procedimento_setor_atend
				where 	    cd_procedimento = cd_procedimento_w
				and 	    ie_origem_proced = ie_origem_proced_w;
			end if;

		end if;

		end;
	end loop;
	close C01;

elsif (ie_estrutura_p in ('P','S','F')) then  -- Estrutura de Procedimentos SUS
	open C02;
	loop
	fetch C02 into
		cd_procedimento_w,
		ie_origem_proced_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		select 	max(cd_setor_exclusivo),
			max(substr(obter_nome_setor(cd_setor_exclusivo),1,60)),
			max(substr(obter_nome_setor(cd_setor_exclusivo_p),1,60)),
			coalesce(max(ie_situacao),'I')
		into STRICT	cd_setor_exclusivo_w,
			ds_setor_exclusivo_w,
			ds_setor_exclusivo_destino_w,
			ie_situacao_w
		from 	procedimento
		where 	cd_procedimento  = cd_procedimento_w
		and 	ie_origem_proced = ie_origem_proced_w;

		if (ie_situacao_w = 'A') then

			update	procedimento
			set 	cd_setor_exclusivo  = NULL,
				nm_usuario	   = nm_usuario_p,
				dt_atualizacao     = clock_timestamp()
			where 	cd_procedimento	   = cd_procedimento_w
			and 	ie_origem_proced   = ie_origem_proced_w;

			select	nextval('procedimento_setor_atend_seq')
			into STRICT	nr_sequencia_w
			;

			insert	into procedimento_setor_atend(nr_sequencia,
					cd_estabelecimento,
					cd_procedimento,
					ie_origem_proced,
					cd_setor_atendimento,
					ie_prioridade,
					cd_setor_origem,
					ie_banco_sangue_rep,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec)
				values (nr_sequencia_w,
					cd_estabelecimento_p,
					cd_procedimento_w,
					ie_origem_proced_w,
					cd_setor_exclusivo_p,
					100,
					null,
					'N',
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p);


			insert	into procedimento_hist(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					cd_procedimento,
					ie_origem_proced,
					ds_titulo,
					ds_historico)
				values (	nextval('procedimento_hist_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					cd_procedimento_w,
					ie_origem_proced_w,
					upper(wheb_mensagem_pck.get_texto(802491)),
					wheb_mensagem_pck.get_texto(802500,'cd_setor_exclusivo_w=' || cd_setor_exclusivo_w || ';' ||
									   'ds_setor_exclusivo_w=' || ds_setor_exclusivo_w || ';' ||
									   'cd_setor_exclusivo_p=' || cd_setor_exclusivo_p || ';' ||
									   'ds_setor_exclusivo_destino_w=' || ds_setor_exclusivo_destino_w));

		end if;

		end;
	end loop;
	close C02;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE definir_setor_exclusivo ( ie_estrutura_p text, cd_estrutura_p bigint, cd_setor_exclusivo_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

