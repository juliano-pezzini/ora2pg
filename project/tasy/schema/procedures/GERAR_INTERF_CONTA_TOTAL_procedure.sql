-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_interf_conta_total (nr_seq_protocolo_p bigint, nr_seq_envio_convenio_p bigint, cd_convenio_p bigint, nr_atendimento_p bigint, nr_interno_conta_p bigint, cd_cgc_hospital_p text, cd_cgc_convenio_p text, cd_interno_p text, ie_excluir_hon_med_p text, ie_excluir_hon_terc_p text) AS $body$
DECLARE

 
nr_sequencia_w				bigint		:= 0;

VL_MATERIAIS_W				double precision	:= 0;
VL_MAT_AUX_W				double precision	:= 0;
VL_MATMED_W					double precision	:= 0;
VL_MEDICAMENTOS_W				double precision	:= 0;

vl_proc_w					double precision	:= 0;
vl_medico_w					double precision	:= 0;
VL_PROCEDIMENTO_W				double precision	:= 0;
VL_DIARIAS_W				double precision	:= 0;
VL_SERVICO_W				double precision	:= 0;
VL_TAXAS_W					double precision	:= 0;
VL_SADT_W					double precision	:= 0;
VL_ORTESE_PROTESE_W			double precision	:= 0;
VL_ORTESE_W					double precision	:= 0;
VL_PROTESE_W				double precision	:= 0;
VL_HONORARIOS_W				double precision	:= 0;
VL_HONOR_CONV_W				double precision	:= 0;
VL_HONOR_NCONV_W				double precision	:= 0;
VL_EXTRA_W					double precision	:= 0;
VL_TOTAL_CONTA_W				double precision	:= 0;
VL_TOTAL_PACOTE_W				double precision	:= 0;
VL_TOTAL_FORA_PACOTE_W			double precision	:= 0;
QT_DIARIAS_W				bigint		:= 0;
QT_PARTICIPANTES_W			bigint		:= 0;
QT_PROCEDIMENTO_W				double precision		:= 0;
QT_ITEM_CONTA_W				integer		:= 0;
NR_SEQ_CONTA_CONVENIO_w       bigint;
ie_total_interf_w				smallint		:= 0;

 
C01 CURSOR FOR 
SELECT 	round((coalesce(sum(a.vl_material),0))::numeric,4), 
	 coalesce(b.ie_total_interf,0) 
from	 conta_paciente_estrutura b, 
	 material_atend_paciente a 
where	 a.nr_interno_conta	= nr_interno_conta_p 
and	 a.ie_emite_conta		= b.cd_estrutura 
and	 (b.ie_total_interf IS NOT NULL AND b.ie_total_interf::text <> '') 
and	 coalesce(a.cd_motivo_exc_conta::text, '') = '' 
group by coalesce(b.ie_total_interf,0);

C02 CURSOR FOR 
SELECT round((coalesce(sum(a.vl_procedimento),0))::numeric,4), 
	 round((coalesce(sum(a.vl_medico),0))::numeric,4), 
	 round((coalesce(sum(a.qt_procedimento),0))::numeric,4), 
	 coalesce(b.ie_total_interf,0) 
from	 conta_paciente_estrutura b, 
	 procedimento_paciente a	 
where	 a.nr_interno_conta	= nr_interno_conta_p 
 and 	 b.cd_estrutura 	= CASE WHEN a.ie_emite_conta='S' THEN 0 WHEN a.ie_emite_conta='N' THEN  0  ELSE a.ie_emite_conta END  
 and	 (b.ie_total_interf IS NOT NULL AND b.ie_total_interf::text <> '') 
 and	 coalesce(a.cd_motivo_exc_conta::text, '') = '' 
 and	 ((ie_excluir_hon_med_p		= 'N') 		 or (a.ie_responsavel_credito 	<> 'M')		 or (coalesce(a.ie_responsavel_credito::text, '') = '')) 
 and	 ((ie_excluir_hon_terc_p	= 'N') 		 or (a.ie_responsavel_credito 	in ('H','RM','M')) or (coalesce(a.ie_responsavel_credito::text, '') = '')) 
group by coalesce(b.ie_total_interf,0) 

union
 
SELECT 0, 
	 round((coalesce(sum(a.vl_medico),0))::numeric,4), 
	 0, 
	 coalesce(b.ie_total_interf,0) 
from	 conta_paciente_estrutura b, 
	 procedimento_paciente a	 
where	 a.nr_interno_conta	= nr_interno_conta_p 
 and 	 b.cd_estrutura 	= a.ie_emite_conta_honor 
 and (a.ie_emite_conta_honor IS NOT NULL AND a.ie_emite_conta_honor::text <> '') 
 and a.ie_emite_conta_honor <> a.ie_emite_conta 
 and coalesce(a.vl_medico,0) 	> 0 
 and	 (b.ie_total_interf IS NOT NULL AND b.ie_total_interf::text <> '') 
 and	 coalesce(a.cd_motivo_exc_conta::text, '') = '' 
 and	 ((ie_excluir_hon_med_p		= 'N') 		 or (a.ie_responsavel_credito 	<> 'M')		 or (coalesce(a.ie_responsavel_credito::text, '') = '')) 
 and	 ((ie_excluir_hon_terc_p	= 'N') 		 or (a.ie_responsavel_credito 	in ('H','RM','M')) or (coalesce(a.ie_responsavel_credito::text, '') = '')) 
group by coalesce(b.ie_total_interf,0) 

union
 
select 0, 
	 round((coalesce(sum(c.vl_participante),0))::numeric,4), 
	 0, 
	 coalesce(b.ie_total_interf,0) 
from	 conta_paciente_estrutura b, 
	 procedimento_participante c, 
	 procedimento_paciente a 
where	 a.nr_interno_conta	= nr_interno_conta_p 
 and	 a.nr_sequencia		= c.nr_sequencia 
 and	 coalesce(a.cd_motivo_exc_conta::text, '') = '' 
 and 	 b.cd_estrutura 		= CASE WHEN upper(c.ie_emite_conta)='S' THEN 0 WHEN upper(c.ie_emite_conta)='N' THEN  0  ELSE c.ie_emite_conta END  
 and	 (b.ie_total_interf IS NOT NULL AND b.ie_total_interf::text <> '') 
 and	 ((ie_excluir_hon_med_p		= 'N') 		 or (c.ie_responsavel_credito 	<> 'M')		 or (coalesce(c.ie_responsavel_credito::text, '') = '')) 
 and	 ((ie_excluir_hon_terc_p	= 'N') 		 or (c.ie_responsavel_credito 	in ('H','RM','M')) or (coalesce(c.ie_responsavel_credito::text, '') = '')) 
group by coalesce(b.ie_total_interf,0);


BEGIN 
 
select nextval('w_interf_conta_total_seq') 
into STRICT	 nr_sequencia_w
;
 
 
OPEN C01;
LOOP 
	FETCH C01 	into 
			vl_materiais_w, 
			ie_total_interf_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
   			BEGIN 
			if (ie_total_interf_w	= 1) then 
				vl_matmed_w		:= vl_materiais_w;
			elsif (ie_total_interf_w	= 2) then 
				VL_MAT_AUX_W		:= vl_materiais_w;
			elsif (ie_total_interf_w	= 3) then 
				vl_medicamentos_w	:= vl_materiais_w;
			else 
				VL_MAT_AUX_W		:= vl_materiais_w;
			end if;
			END;
END LOOP;
close C01;
 
OPEN C02;
LOOP 
	FETCH C02 	into 
			vl_proc_w, 
			vl_medico_w, 
			qt_procedimento_w, 
			ie_total_interf_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
   			BEGIN 
			if (ie_total_interf_w	= 4) then 
				vl_procedimento_w		:= vl_proc_w;
			elsif (ie_total_interf_w	= 5) then 
				vl_diarias_w		:= vl_proc_w;
			elsif (ie_total_interf_w	= 6) then 
				vl_servico_w		:= vl_proc_w;
			elsif (ie_total_interf_w	= 7) then 
				vl_taxas_w			:= vl_proc_w;
			elsif (ie_total_interf_w	= 8) then 
				vl_sadt_w			:= vl_proc_w;
			elsif (ie_total_interf_w	= 9) then 
				vl_ortese_protese_w 	:= vl_proc_w;
			elsif (ie_total_interf_w	= 10) then 
				vl_ortese_w 		:= vl_proc_w;
			elsif (ie_total_interf_w	= 11) then 
				vl_protese_w 		:= vl_proc_w;
			elsif (ie_total_interf_w	= 12) then 
				vl_honorarios_w 		:= vl_honorarios_w + vl_medico_w;
			elsif (ie_total_interf_w	= 13) then 
				vl_honor_conv_w 		:= vl_honor_conv_w + vl_medico_w;
			elsif (ie_total_interf_w	= 14) then 
				vl_honor_nconv_w 		:= vl_honor_nconv_w + vl_medico_w;
			elsif (ie_total_interf_w	= 15) then 
				vl_extra_w 			:= vl_proc_w;
			end if;
 
			if (ie_total_interf_w	= 5) then 
				qt_diarias_w		:= qt_procedimento_w;
			end if;
			END;
END LOOP;
close C02;
 
begin 
select coalesce(count(*),0) 
into STRICT	 qt_participantes_w 
FROM procedimento_paciente a
LEFT OUTER JOIN procedimento_participante b ON (a.nr_sequencia = b.nr_sequencia)
WHERE a.nr_interno_conta	= nr_interno_conta_p and (a.cd_medico_executor IS NOT NULL AND a.cd_medico_executor::text <> '') and coalesce(a.cd_motivo_exc_conta::text, '') = '';
exception 
	when others then 
		qt_participantes_w	:= 0;
end;
 
begin 
select coalesce(sum(vl_item),0) 
into STRICT	 vl_total_conta_w 
from	 conta_paciente_v 
where	 nr_interno_conta		= nr_interno_conta_p 
and 	 coalesce(cd_motivo_exc_conta::text, '') = '' 
and	 CASE WHEN coalesce(nr_seq_proc_pacote::text, '') = '' THEN nr_sequencia  ELSE nr_seq_proc_pacote END  = nr_sequencia 
and	 ((ie_excluir_hon_med_p		= 'N') 		 or (ie_responsavel_credito 	<> 'M')		 or (coalesce(ie_responsavel_credito::text, '') = '')) 
and	 ((ie_excluir_hon_terc_p	= 'N') 		 or (ie_responsavel_credito 	in ('H','RM','M')) or (coalesce(ie_responsavel_credito::text, '') = ''));
exception 
	when others then 
		vl_total_conta_w	:= 0;
end;
 
begin 
select coalesce(sum(vl_item),0) 
into STRICT	 vl_total_pacote_w 
from	 conta_paciente_v 
where	 nr_interno_conta		= nr_interno_conta_p 
 and	 coalesce(cd_motivo_exc_conta::text, '') = '' 
and	 nr_seq_proc_pacote	= nr_sequencia 
and	 ((ie_excluir_hon_med_p		= 'N') 		 or (ie_responsavel_credito 	<> 'M')		 or (coalesce(ie_responsavel_credito::text, '') = '')) 
and	 ((ie_excluir_hon_terc_p	= 'N') 		 or (ie_responsavel_credito 	in ('H','RM','M')) or (coalesce(ie_responsavel_credito::text, '') = ''));
exception 
	when others then 
		vl_total_pacote_w := 0;
end;
 
begin 
select coalesce(sum(vl_item),0) 
into STRICT	 vl_total_fora_pacote_w 
from	 conta_paciente_v 
where	 nr_interno_conta		= nr_interno_conta_p 
and	 coalesce(nr_seq_proc_pacote::text, '') = '' 
and	 coalesce(cd_motivo_exc_conta::text, '') = '' 
and	 ((ie_excluir_hon_med_p		= 'N') 		 or (ie_responsavel_credito 	<> 'M')		 or (coalesce(ie_responsavel_credito::text, '') = '')) 
and	 ((ie_excluir_hon_terc_p	= 'N') 		 or (ie_responsavel_credito 	in ('H','RM','M')) or (coalesce(ie_responsavel_credito::text, '') = ''));
exception 
	when others then 
		vl_total_pacote_w := 0;
end;
 
 
begin 
select 	count(*) 
into STRICT	qt_item_conta_w 
from	w_interf_conta_item 
where	nr_interno_conta = nr_interno_conta_p;
exception 
	when others then 
		qt_item_conta_w := 0;
end;
 
select max(nr_conta_convenio) 
into STRICT	 NR_SEQ_CONTA_CONVENIO_w 
from	 conta_paciente 
where	 nr_interno_conta	= nr_interno_conta_p;
 
 
insert into w_interf_conta_total( 
			nr_sequencia, 
			cd_tipo_registro, 
 			nr_seq_registro, 
 			nr_seq_interface, 
 			nr_remessa, 
			nr_atendimento, 
			nr_interno_conta, 
 			vl_total_conta, 
 			nr_seq_protocolo, 
			cd_convenio, 
			cd_cgc_hospital, 
			cd_cgc_convenio, 
			cd_interno, 
			vl_honorarios, 
			vl_diarias, 
			vl_taxas, 
			vl_medicamentos, 
			vl_materiais, 
			vl_sadt, 
			vl_pacote, 
			vl_ortese, 
			vl_protese, 
			qt_diarias, 
			qt_participantes, 
			vl_matmed, 
			vl_procedimento, 
			vl_servico, 
			vl_ortese_protese, 
			vl_honor_conv, 
			vl_honor_nconv, 
			vl_extra, 
			vl_fora_pacote, 
			qt_item_conta, 
			NR_SEQ_CONTA_CONVENIO) 
   	values (nr_sequencia_w, 
 			5, 
 			1, 
 			1, 
 			nr_seq_envio_convenio_p, 
			nr_atendimento_p, 
			nr_interno_conta_p, 
 			vl_total_conta_w, 
 			nr_seq_protocolo_p, 
			cd_convenio_p, 
			cd_cgc_hospital_p, 
			cd_cgc_convenio_p, 
			cd_interno_p, 
			vl_honorarios_w, 
			vl_diarias_w, 
			vl_taxas_w, 
			vl_medicamentos_w, 
			vl_mat_aux_w, 
			vl_sadt_w, 
			vl_total_pacote_w, 
			vl_ortese_w, 
			vl_protese_w, 
			qt_diarias_w, 
			qt_participantes_w, 
			vl_matmed_w, 
			vl_procedimento_w, 
			vl_servico_w, 
			vl_ortese_protese_w, 
			vl_honor_conv_w, 
			vl_honor_nconv_w, 
			vl_extra_w, 
			vl_total_fora_pacote_w, 
			qt_item_conta_w, 
			NR_SEQ_CONTA_CONVENIO_w);
commit;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_interf_conta_total (nr_seq_protocolo_p bigint, nr_seq_envio_convenio_p bigint, cd_convenio_p bigint, nr_atendimento_p bigint, nr_interno_conta_p bigint, cd_cgc_hospital_p text, cd_cgc_convenio_p text, cd_interno_p text, ie_excluir_hon_med_p text, ie_excluir_hon_terc_p text) FROM PUBLIC;

