-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_pre_fatur_tributo ( nm_usuario_p text, dt_referencia_p timestamp, cd_estab_p bigint) AS $body$
DECLARE


vl_pre_faturamento_w	pre_faturamento.vl_material%type;

c01 CURSOR FOR
	SELECT  nr_sequencia,
    	cd_conta_contabil,
    	cd_estabelecimento,
    	(coalesce(vl_material,0) + coalesce(vl_procedimento,0)) vl_pre_faturamento,
    	dt_referencia,
    	nr_interno_conta,
		obter_tipo_convenio(cd_convenio) ie_tipo_convenio
  	from  pre_faturamento
  	where dt_referencia = dt_referencia_p
	and (cd_estabelecimento = cd_estab_P or cd_estab_P = 0)
	order by 1;

c01_w		c01%rowtype;

c02 CURSOR FOR
	SELECT 	a.cd_tributo,
				a.pr_tributo,
				a.cd_conta_debito,
				a.cd_conta_credito
	from		ctb_regra_tributo_pre_fat a,
			  	tributo b
	where	a.cd_tributo = b.cd_tributo
  	and   	a.cd_empresa = obter_empresa_estab(c01_w.cd_estabelecimento)
	and 		coalesce(a.cd_estabelecimento, c01_w.cd_estabelecimento) = c01_w.cd_estabelecimento
	and 		coalesce(a.ie_tipo_convenio, c01_w.ie_tipo_convenio) = c01_w.ie_tipo_convenio
  	and 		b.ie_situacao = 'A'
	order by 1;

c02_w		c02%rowtype;


BEGIN

open c01;
loop
fetch c01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	open c02;
	loop
	fetch c02 into
		c02_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		
		vl_pre_faturamento_w := (c01_w.vl_pre_faturamento * c02_w.pr_tributo) / 100;

		insert into pre_fatur_tributo(
					nr_sequencia,
					nr_seq_pre_fatur,
					cd_tributo,
					pr_tributo,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					vl_tributo,
					cd_conta_debito,
					cd_conta_credito,
					dt_referencia,
					nr_interno_conta)
				values (	nextval('pre_fatur_tributo_seq'),
					c01_w.nr_sequencia,
					c02_w.cd_tributo,
					c02_w.pr_tributo,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					vl_pre_faturamento_w,
					c02_w.cd_conta_debito,
					c02_w.cd_conta_credito,
					c01_w.dt_referencia,
					c01_w.nr_interno_conta);
		end;
	end loop;
	close c02;

	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_pre_fatur_tributo ( nm_usuario_p text, dt_referencia_p timestamp, cd_estab_p bigint) FROM PUBLIC;

