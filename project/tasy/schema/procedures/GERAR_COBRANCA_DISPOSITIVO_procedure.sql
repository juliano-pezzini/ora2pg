-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cobranca_dispositivo (nm_usuario_p text) AS $body$
DECLARE


cd_setor_Atendimento_w	bigint;
nr_seq_proc_interno_w	bigint;
cd_procedimento_w	bigint;
ie_origem_proc_w	smallint;
cd_categoria_w		varchar(10);
cd_convenio_w		integer;
nr_atendimento_w	bigint;
qt_procedimento_w	bigint;
qt_min_frequencia_w	integer;
qt_minutos_w		bigint;
qt_frequencia_w		bigint;
nr_seq_dispositivo_w	bigint;
nr_seq_disp_proc_w	bigint;
cd_plano_w		varchar(10);
cd_tipo_acomodacao_w	smallint;

c01 CURSOR FOR
SELECT	b.nr_atendimento,
	b.nr_seq_dispositivo,
	a.nr_sequencia
from	atendimento_paciente c,
	atend_pac_disp_proc a,
	atend_pac_dispositivo b
where	b.nr_sequencia		= a.nr_seq_disp_pac
and	c.nr_atendimento	= b.nr_atendimento
and	exists (SELECT	1
		from	atend_paciente_unidade x
		where	x.nr_atendimento = c.nr_atendimento
		and	x.cd_setor_atendimento = a.cd_setor_Atendimento)
and	exists (select	1
		from	atend_categoria_convenio x
		where	x.nr_atendimento = c.nr_Atendimento)
and	coalesce(b.dt_retirada::text, '') = ''
and	coalesce(c.dt_alta::text, '') = ''
group by b.nr_atendimento,
	 b.nr_seq_dispositivo,
	 a.nr_sequencia;

c02 CURSOR FOR
SELECT	cd_procedimento,
	nr_seq_proc_interno,
	qt_procedimento,
	coalesce(qt_min_frequencia,0)
from	regra_cobranca_dispositivo
where	nr_seq_dispositivo 	= nr_seq_dispositivo_w
and	ie_acao 		= 'J';


BEGIN

open C01;
loop
fetch C01 into	
	nr_atendimento_w,
	nr_seq_dispositivo_w,
	nr_seq_disp_proc_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	select	cd_convenio,
		cd_categoria,
		cd_plano_convenio,
		cd_tipo_acomodacao
	into STRICT	cd_convenio_w,
		cd_categoria_w,
		cd_plano_w,
		cd_tipo_acomodacao_w
	from 	atend_categoria_convenio
	where	nr_seq_interno = obter_atecaco_atendimento(nr_atendimento_w)
	and 	nr_atendimento = nr_atendimento_w;
	exception
	when no_data_found then
		-- O atendimento #@NR_ATENDIMENTO#@ nao possui convenio definido na entrada unica!
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(193593,'NR_ATENDIMENTO=' || nr_atendimento_w);
	end;
	
	open C02;
	loop
	fetch C02 into	
		cd_procedimento_w,
		nr_seq_proc_interno_w,
		qt_procedimento_w,
		qt_min_frequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		
		select	coalesce(max(obter_min_entre_datas(dt_instalacao,dt_retirada,1)),0)
		into STRICT	qt_minutos_w
		from	atend_pac_dispositivo
		where	nr_seq_dispositivo 	= nr_seq_dispositivo_w
		and	(dt_instalacao IS NOT NULL AND dt_instalacao::text <> '')
		and	(dt_retirada IS NOT NULL AND dt_retirada::text <> '')
		and	nr_atendimento		= nr_atendimento_w;

		if (qt_minutos_w > 0) and (qt_min_frequencia_w > 0) then
			select	ceil(dividir(qt_minutos_w,qt_min_frequencia_w))
			into STRICT	qt_frequencia_w
			;
			
			qt_procedimento_w :=  coalesce(qt_frequencia_w,0) * qt_procedimento_w;
			
		end if;
		
		SELECT * FROM obter_proc_tab_interno_conv(nr_seq_proc_interno_w, wheb_usuario_pck.get_cd_estabelecimento, cd_convenio_w, cd_categoria_w, cd_plano_w, cd_setor_atendimento_w, cd_procedimento_w, ie_origem_proc_w, null, clock_timestamp(), cd_tipo_acomodacao_w, null, null, null, null, null, null, null) INTO STRICT cd_procedimento_w, ie_origem_proc_w;
		CALL adep_gerar_lancto_dispositivo(nr_seq_proc_interno_w, nr_seq_disp_proc_w, nr_atendimento_w, cd_procedimento_w, ie_origem_proc_w, qt_procedimento_w, nm_usuario_p, 'S');
		
		end;
	end loop;
	close C02;

end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cobranca_dispositivo (nm_usuario_p text) FROM PUBLIC;

