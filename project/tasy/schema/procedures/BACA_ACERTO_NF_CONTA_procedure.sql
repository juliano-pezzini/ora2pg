-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_acerto_nf_conta () AS $body$
DECLARE


nr_sequencia_w		bigint;
nr_interno_conta_w	bigint;
nr_titulo_w		bigint;

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	b.nr_interno_conta,
	b.nr_titulo
from	conta_paciente c,
	nota_fiscal a,
	titulo_receber b
where	a.nr_sequencia 		= b.nr_seq_nf_saida
and	(b.nr_interno_conta IS NOT NULL AND b.nr_interno_conta::text <> '')
and	c.nr_interno_conta	= b.nr_interno_conta
and	coalesce(a.nr_interno_conta::text, '') = ''
and	coalesce(a.nr_seq_protocolo::text, '') = ''
and	a.ie_situacao		= '9'
and	c.ie_cancelamento	= 'C'

union

select	a.nr_sequencia,
	b.nr_interno_conta,
	b.nr_titulo
from	conta_paciente c,
	nota_fiscal a,
	titulo_receber b
where	a.nr_nota_fiscal 	= b.nr_nota_fiscal
and	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
and	a.vl_mercadoria		= b.vl_titulo
and	c.nr_interno_conta	= b.nr_interno_conta
and	coalesce(b.nr_seq_nf_saida::text, '') = ''
and	coalesce(a.nr_interno_conta::text, '') = ''
and	coalesce(a.nr_seq_protocolo::text, '') = ''
and	a.ie_situacao		= '9'
and	(c.ie_cancelamento IS NOT NULL AND c.ie_cancelamento::text <> '')
and	c.ie_cancelamento	= 'C';


BEGIN

open c01;
loop
fetch c01 into
	nr_sequencia_w,
	nr_interno_conta_w,
	nr_titulo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	update	nota_fiscal
	set	nr_interno_conta	= nr_interno_conta_w
	where	nr_sequencia		= nr_sequencia_w
	and	coalesce(nr_interno_conta::text, '') = ''
	and	coalesce(nr_seq_protocolo::text, '') = '';

	/*insert into log__tasy (dt_atualizacao, nm_usuario, cd_log, ds_log)
	values			 (sysdate, 'TASY_OS71728', 55700, 'NR_INTERNO_CONTA=' || nr_interno_conta_w || ';NR_SEQUENCIA=' || nr_sequencia_w);*/
	update	titulo_receber
	set	nr_seq_nf_saida		= nr_sequencia_w
	where	nr_titulo		= nr_titulo_w
	and	coalesce(nr_seq_nf_saida::text, '') = '';

	/*insert into log__tasy (dt_atualizacao, nm_usuario, cd_log, ds_log)
	values			 (sysdate, 'TASY_OS71728', 55700, 'NR_SEQ_NF_SAIDA=' || nr_sequencia_w || ';NR_TITULO=' || nr_titulo_w);*/
	commit;

end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_acerto_nf_conta () FROM PUBLIC;

