-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_historico_aprov_compra ( nr_seq_aprovacao_p bigint, nr_seq_processo_p bigint, nm_usuario_p text) AS $body$
DECLARE


ie_origem_processo_w		varchar(15);
nr_documento_w			bigint;
ds_documento_w			varchar(255);
ie_aprov_reprov_w		processo_aprov_compra.ie_aprov_reprov%type;
nm_aprovador_w			pessoa_fisica.nm_pessoa_fisica%type;
ds_cargo_w			cargo.ds_cargo%type;


BEGIN

begin
select	ie_aprov_reprov
into STRICT	ie_aprov_reprov_w
from	processo_aprov_compra
where	nr_sequencia		= nr_seq_aprovacao_p
and	nr_seq_proc_aprov	= nr_seq_processo_p;

select	substr(obter_nome_usuario(nm_usuario_p),1,255),
	substr(obter_cargo_usuario(nm_usuario_p),1,255)
into STRICT	nm_aprovador_w,
	ds_cargo_w
;

exception
when others then
	ie_aprov_reprov_w := 'X';
end;

if (ie_aprov_reprov_w = 'A') then

	select	obter_origem_processo_aprov(nr_seq_aprovacao_p)
	into STRICT	ie_origem_processo_w
	;

	if (ie_origem_processo_w = 'O') then

		ds_documento_w := wheb_mensagem_pck.get_Texto(299883); /*Ordem de compra*/
		select	coalesce(max(nr_ordem_compra),0)
		into STRICT	nr_documento_w
		from	ordem_compra_item
		where	nr_seq_aprovacao = nr_seq_aprovacao_p;

		if (nr_documento_w > 0) then
			CALL inserir_historico_ordem_compra(
				nr_documento_w,
				null,
				wheb_mensagem_pck.get_Texto(398059), /*Aprovação de uma etapa do processo*/
				wheb_mensagem_pck.get_texto(398060,'NM_APROVADOR_W='|| NM_APROVADOR_W ||';DS_CARGO_W='|| DS_CARGO_W ||';DS_DOCUMENTO_W='|| DS_DOCUMENTO_W), /*O colaborador #@NM_APROVADOR_W#@, cujo o cargo é #@DS_CARGO_W#@, aprovou a sua etapa do processo de aprovação dessa #@DS_DOCUMENTO_W#@.*/
				nm_usuario_p);
		end if;

	elsif (ie_origem_processo_w = 'S') then

		ds_documento_w := wheb_mensagem_pck.get_Texto(320224); /*Solicitação de compras*/
		select	coalesce(max(nr_solic_compra),0)
		into STRICT	nr_documento_w
		from	solic_compra_item
		where	nr_seq_aprovacao = nr_seq_aprovacao_p;

		if (nr_documento_w > 0) then
			CALL gerar_hist_solic_sem_commit(
				nr_documento_w,
				wheb_mensagem_pck.get_Texto(398059), /*Aprovação de uma etapa do processo*/
				wheb_mensagem_pck.get_texto(398060,'NM_APROVADOR_W='|| NM_APROVADOR_W ||';DS_CARGO_W='|| DS_CARGO_W ||';DS_DOCUMENTO_W='|| DS_DOCUMENTO_W), /*O colaborador #@NM_APROVADOR_W#@, cujo o cargo é #@DS_CARGO_W#@, aprovou a sua etapa do processo de aprovação dessa #@DS_DOCUMENTO_W#@.*/
				'AEP',
				nm_usuario_p);
		end if;

	elsif (ie_origem_processo_w = 'N') then

		ds_documento_w := wheb_mensagem_pck.get_Texto(320227); /*Nota fiscal*/
		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_documento_w
		from	nota_fiscal_item
		where	nr_seq_aprovacao = nr_seq_aprovacao_p;

		if (nr_documento_w > 0) then
			CALL gerar_historico_nota_fiscal(
				nr_documento_w,
				nm_usuario_p,
				'61',
				wheb_mensagem_pck.get_texto(398060,'NM_APROVADOR_W='|| NM_APROVADOR_W ||';DS_CARGO_W='|| DS_CARGO_W ||';DS_DOCUMENTO_W='|| DS_DOCUMENTO_W)); /*O colaborador #@NM_APROVADOR_W#@, cujo o cargo é #@DS_CARGO_W#@, aprovou a sua etapa do processo de aprovação dessa #@DS_DOCUMENTO_W#@.*/
		end if;

	elsif (ie_origem_processo_w = 'R') then

		ds_documento_w := wheb_mensagem_pck.get_Texto(299885); /*Requisição*/
		select	coalesce(max(nr_requisicao),0)
		into STRICT	nr_documento_w
		from	item_requisicao_material
		where	nr_seq_aprovacao = nr_seq_aprovacao_p;

		if (nr_documento_w > 0) then
			CALL gerar_historico_req_sem_commit(
				nr_documento_w,
				wheb_mensagem_pck.get_Texto(398059), /*Aprovação de uma etapa do processo*/
				wheb_mensagem_pck.get_texto(398060,'NM_APROVADOR_W='|| NM_APROVADOR_W ||';DS_CARGO_W='|| DS_CARGO_W ||';DS_DOCUMENTO_W='|| DS_DOCUMENTO_W), /*O colaborador #@NM_APROVADOR_W#@, cujo o cargo é #@DS_CARGO_W#@, aprovou a sua etapa do processo de aprovação dessa #@DS_DOCUMENTO_W#@.*/
				'AE',
				nm_usuario_p);
		end if;

	elsif (ie_origem_processo_w = 'C') then

		ds_documento_w := wheb_mensagem_pck.get_Texto(320226); /*Cotação de compras*/
		select	coalesce(max(nr_cot_compra),0)
		into STRICT	nr_documento_w
		from	cot_compra_item
		where	nr_seq_aprovacao = nr_seq_aprovacao_p;

		if (nr_documento_w > 0) then
			CALL gerar_hist_cotacao_sem_commit(
				nr_documento_w,
				wheb_mensagem_pck.get_Texto(398059), /*Aprovação de uma etapa do processo*/
				wheb_mensagem_pck.get_texto(398060,'NM_APROVADOR_W='|| NM_APROVADOR_W ||';DS_CARGO_W='|| DS_CARGO_W ||';DS_DOCUMENTO_W='|| DS_DOCUMENTO_W), /*O colaborador #@NM_APROVADOR_W#@, cujo o cargo é #@DS_CARGO_W#@, aprovou a sua etapa do processo de aprovação dessa #@DS_DOCUMENTO_W#@.*/
				'S',
				nm_usuario_p);
		end if;

	elsif (ie_origem_processo_w = 'L') then

		ds_documento_w := wheb_mensagem_pck.get_Texto(388955); /*Licitação*/
		select	coalesce(max(nr_seq_licitacao),0)
		into STRICT	nr_documento_w
		from	reg_lic_item
		where	nr_seq_aprovacao = nr_seq_aprovacao_p;

		if (nr_documento_w > 0) then
			insert into reg_lic_historico(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				ie_tipo_historico,
				ds_observacao,
				nr_seq_licitacao)
			values (	nextval('reg_lic_historico_seq'),
				clock_timestamp(),
				nm_usuario_p,
				'AEP',
				wheb_mensagem_pck.get_texto(398060,'NM_APROVADOR_W='|| NM_APROVADOR_W ||';DS_CARGO_W='|| DS_CARGO_W ||';DS_DOCUMENTO_W='|| DS_DOCUMENTO_W), /*O colaborador #@NM_APROVADOR_W#@, cujo o cargo é #@DS_CARGO_W#@, aprovou a sua etapa do processo de aprovação dessa #@DS_DOCUMENTO_W#@.*/
				nr_documento_w);
		end if;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_historico_aprov_compra ( nr_seq_aprovacao_p bigint, nr_seq_processo_p bigint, nm_usuario_p text) FROM PUBLIC;

