-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_lib_titulo_pagar ( nm_usuario_p text, nr_titulo_p bigint) AS $body$
DECLARE


cd_estabelecimento_w	smallint;
ie_liberar_tit_pagar_imposto_w	parametros_contas_pagar.ie_liberar_tit_pagar_imposto%type;



BEGIN

select	max(a.cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	titulo_pagar a
where	a.nr_titulo	= nr_titulo_p;

select	coalesce(max(a.ie_liberar_tit_pagar_imposto),'N')
into STRICT	ie_liberar_tit_pagar_imposto_w
from	parametros_contas_pagar a
where	a.cd_estabelecimento	= cd_estabelecimento_w;

Update	Titulo_Pagar
set	dt_liberacao	 = NULL,
	dt_atualizacao	= clock_timestamp(),
	nm_usuario	= nm_usuario_p,
	nm_usuario_lib	 = NULL
where	nr_titulo	= nr_titulo_p;

	
update	conta_pagar_lib a
set	dt_liberacao	 = NULL,
	dt_atualizacao	= clock_timestamp(),
	nm_usuario	= nm_usuario_p
where	coalesce(a.ie_nivel,0)	= coalesce((SELECT   min(x.ie_nivel)
			   from     conta_pagar_lib x
			   where    x.nm_usuario_lib  = nm_usuario_p
			   and      x.nr_titulo       = nr_titulo_p),0)
and	nm_usuario_lib	= nm_usuario_p
and	nr_titulo	= nr_titulo_p;


if (coalesce(ie_liberar_tit_pagar_imposto_w,'N')	= 'S') then

	update	titulo_pagar a
	set	a.dt_liberacao		 = NULL,
		a.dt_atualizacao	= clock_timestamp(),
		a.nm_usuario		= nm_usuario_p,
		a.nm_usuario_lib	 = NULL
	where	exists (SELECT	1
		from	titulo_pagar_imposto x
		where	x.nr_sequencia	= a.nr_seq_tributo
		and	x.nr_titulo	= nr_titulo_p);

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_lib_titulo_pagar ( nm_usuario_p text, nr_titulo_p bigint) FROM PUBLIC;

