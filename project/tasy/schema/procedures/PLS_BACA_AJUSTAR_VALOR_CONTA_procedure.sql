-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_baca_ajustar_valor_conta ( nr_seq_conta_p bigint) AS $body$
DECLARE


nr_seq_segurado_w		bigint;
nr_seq_plano_w			bigint;
nr_seq_contrato_w		bigint;
ie_preco_plano_w		varchar(2);
vl_proc_beneciciario_w		double precision;
vl_mat_beneciciario_w		double precision;
vl_total_beneciciario_w		double precision;


BEGIN

select	nr_seq_segurado
into STRICT	nr_seq_segurado_w
from	pls_conta
where	nr_sequencia	= nr_seq_conta_p;

begin
select	coalesce(nr_seq_plano,0),
	coalesce(nr_seq_contrato,0)
into STRICT	nr_seq_plano_w,
	nr_seq_contrato_w
from	pls_segurado
where	nr_sequencia	= nr_seq_segurado_w;
exception
	when others then
	nr_seq_plano_w	:= null;
end;

/* Obter dados do plano */

begin
select	ie_preco
into STRICT	ie_preco_plano_w
from	pls_plano
where	nr_sequencia	= nr_seq_plano_w;
exception
	when others then
	ie_preco_plano_w	:= '0';
end;

if (ie_preco_plano_w in ('2','3')) then
	update	pls_conta_proc
	set	vl_beneficiario	= CASE WHEN ie_status='L' THEN vl_liberado  ELSE vl_procedimento END
	where	nr_seq_conta	= nr_seq_conta_p;

	update	pls_conta_mat
	set	vl_beneficiario	= CASE WHEN ie_status='L' THEN vl_liberado  ELSE vl_material END
	where	nr_seq_conta	= nr_seq_conta_p;

	select	coalesce(sum(vl_beneficiario),0)
	into STRICT	vl_proc_beneciciario_w
	from	pls_conta_proc
	where	nr_seq_conta	= nr_seq_conta_p;

	select	coalesce(sum(vl_beneficiario),0)
	into STRICT	vl_mat_beneciciario_w
	from	pls_conta_mat
	where	nr_seq_conta	= nr_seq_conta_p;

	vl_total_beneciciario_w	:= vl_proc_beneciciario_w + vl_mat_beneciciario_w;
	if (coalesce(vl_total_beneciciario_w,0) > 0) then
		update	pls_conta
		set	vl_total_beneficiario	= vl_total_beneciciario_w
		where	nr_sequencia		= nr_seq_conta_p;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_baca_ajustar_valor_conta ( nr_seq_conta_p bigint) FROM PUBLIC;

