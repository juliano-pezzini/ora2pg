-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_caixa_receb_classif (nr_seq_caixa_rec_p bigint, nm_usuario_p text) AS $body$
DECLARE


-- Edgar 06/11/2008, OS 92431, não dar commit nesta procedure
vl_especie_w			double precision;
vl_cheque_w			double precision;
vl_cartao_w			double precision;
vl_total_receb_w		double precision;
vl_transacao_w			double precision;
qt_regra_cartao_w		bigint;
nr_seq_trans_financ_w		bigint;
cd_conta_financ_cartao_w	bigint;
nr_seq_movto_cartao_w		bigint;
cd_conta_avista_w		bigint;
cd_conta_dep_w			bigint;
cd_conta_dev_w			bigint;
cd_conta_reap_w			bigint;
cd_conta_seg_dev_w		bigint;
cd_conta_seg_reap_w		bigint;
cd_conta_terc_dev_w		bigint;
cd_conta_dev_pac_w		bigint;
cd_conta_pre_w			bigint;
cd_conta_financ_cheque_w	bigint;
nr_seq_cheque_w			bigint;
NR_SEQ_PRODUTO_w		bigint;
nr_seq_especie_cr_w		bigint;
cd_estabelecimento_w		bigint;
CD_CONTA_FINANC_ESPECIE_W	bigint;
nr_seq_movto_especie_w		bigint;
IE_CHEQUE_AVISTA_w		varchar(100);
IE_CHEQUE_DEPOSITO_w		varchar(100);
IE_CHEQUE_DEV_w			varchar(100);
IE_CHEQUE_REAP_w		varchar(100);
IE_CHEQUE_SEG_DEV_w		varchar(100);
IE_CHEQUE_SEG_REAP_w		varchar(100);
IE_CHEQUE_TERC_DEV_w		varchar(100);
IE_CHEQUE_DEV_PAC_w		varchar(100);
IE_CHEQUE_PRE_w			varchar(100);
ie_tipo_cartao_w			varchar(100);
ie_origem_cheque_w			varchar(100);
cd_banco_w			bigint;

c01 CURSOR FOR
SELECT	a.nr_seq_trans_financ,
	sum(a.vl_transacao)
from	transacao_financeira b,
	movto_trans_financ a
where	a.nr_seq_trans_financ	= b.nr_sequencia
and	a.nr_seq_caixa_rec	= nr_seq_caixa_rec_p
and	b.ie_caixa		in ('D', 'A', 'T')
group	by a.nr_seq_trans_financ;

c03 CURSOR FOR
SELECT	nr_sequencia,
	vl_transacao,
	ie_tipo_cartao
from	movto_cartao_cr
where	nr_seq_caixa_rec		= nr_seq_caixa_rec_p;

c02 CURSOR FOR
SELECT	a.cd_conta_financ
from	conta_financ_regra_cartao a
where	a.nr_seq_trans_fin_doc		= nr_seq_trans_financ_w
and	((a.ie_tipo_cartao = 'A') or (a.ie_tipo_cartao = ie_tipo_cartao_w))
order 	by coalesce(a.nr_seq_bandeira,0);

c05 CURSOR FOR
SELECT	nr_seq_cheque,
	vl_cheque,
	cd_banco,
	coalesce(ie_origem_cheque, 'X'),
	NR_SEQ_PRODUTO
from	cheque_cr
where	nr_seq_caixa_rec	= nr_seq_caixa_rec_p;

c04 CURSOR FOR
SELECT 	a.CD_CONTA_FINANC,
	a.IE_CHEQUE_AVISTA,
	a.IE_CHEQUE_DEPOSITO,
	a.IE_CHEQUE_DEV,
	a.IE_CHEQUE_REAP,
	a.IE_CHEQUE_SEG_DEV,
	a.IE_CHEQUE_SEG_REAP,
	a.IE_CHEQUE_TERC_DEV,
	a.IE_CHEQUE_DEV_PAC,
	a.IE_CHEQUE_PRE
from	conta_financ_regra_cheque a
where	a.nr_seq_trans_fin_doc		= nr_seq_trans_financ_w
and	coalesce(a.cd_banco, cd_banco_w)	= cd_banco_w
and	coalesce(a.ie_origem_cheque, ie_origem_cheque_w)		= ie_origem_cheque_w
and	coalesce(a.nr_seq_produto, coalesce(nr_seq_produto_w, 0))		= coalesce(nr_seq_produto_w, 0)
order 	by coalesce(a.cd_banco, 0),
	coalesce(a.IE_ORIGEM_CHEQUE, 0),
	coalesce(a.nr_seq_produto, 0);

c07 CURSOR FOR
SELECT	nr_sequencia,
	vl_transacao
from	movto_trans_financ
where	nr_seq_trans_financ		= nr_seq_especie_cr_w
and	nr_seq_caixa_rec			= nr_seq_caixa_rec_p;

c06 CURSOR FOR
SELECT	cd_conta_financ
from	trans_financ_regra_especie
where	nr_seq_trans_fin_doc	= nr_seq_trans_financ_w;


BEGIN

/* Edgar 20/11/2008, OS 117295, comentada até  resolver esta OS

select	c.cd_estabelecimento
into	cd_estabelecimento_w
from	caixa c,
	caixa_saldo_diario b,
	caixa_receb a
where	a.nr_seq_saldo_caixa	= b.nr_sequencia
and	b.nr_seq_caixa		= c.nr_sequencia
and	a.nr_sequencia		= nr_seq_caixa_rec_p;

select	nr_seq_especie_cr
into	nr_seq_especie_cr_w
from	parametro_tesouraria
where	cd_estabelecimento	= cd_estabelecimento_w;

select	nvl(vl_especie,0)
into	vl_especie_w
from	caixa_receb
where	nr_sequencia		= nr_seq_caixa_rec_p;

select	nvl(sum(vl_cheque),0)
into	vl_cheque_w
from	cheque_cr
where	nr_seq_caixa_rec 	= nr_seq_caixa_rec_p;

select	nvl(sum(vl_transacao),0)
into	vl_cartao_w
from	movto_cartao_cr
where	nr_seq_caixa_rec	= nr_seq_caixa_rec_p;

vl_total_receb_w		:= vl_cartao_w + vl_cheque_w + vl_especie_w;

delete	from movto_cartao_cr_classif a
where	exists	(select	1
		from 	movto_cartao_cr x
		where	x.nr_sequencia	= a.nr_seq_movto
		and	x.nr_seq_caixa_rec	= nr_seq_caixa_rec_p);

delete	from 	cheque_cr_classif a
where	exists	(select	1
		from 	cheque_cr x
		where	x.nr_seq_cheque	= a.nr_seq_cheque
		and	x.nr_seq_caixa_rec	= nr_seq_caixa_rec_p);

delete	from	movto_trans_financ_cc a
where	exists	(select	1
		from	movto_trans_financ x
		where	x.nr_sequencia	= a.nr_seq_movto_trans
		and	x.nr_seq_caixa_rec	= nr_seq_caixa_rec_p);

open c01;
loop
fetch c01 into
	nr_seq_trans_financ_w,
	vl_transacao_w;
exit when c01%notfound;

	open c03;
	loop
	fetch c03 into
		nr_seq_movto_cartao_w,
		vl_cartao_w,
		ie_tipo_cartao_w;
	exit when c03%notfound;

		-- raise_application_error(-20011, 'nr_seq_trans_financ_w = ' || nr_seq_trans_financ_w);
		cd_conta_financ_cartao_w	:= null;
		open c02;
		loop
		fetch c02 into
			cd_conta_financ_cartao_w;
		exit when c02%notfound;
		end loop;
		close c02;

		if	(cd_conta_financ_cartao_w is not null) then
			insert	into movto_cartao_cr_classif
				(NR_SEQUENCIA,
				DT_ATUALIZACAO,
				NM_USUARIO,
				DT_ATUALIZACAO_NREC,
				NM_USUARIO_NREC,
				NR_SEQ_MOVTO,
				CD_CONTA_FINANC,
				VL_CLASSIFICACAO)
			select	movto_cartao_cr_classif_seq.nextval,
				sysdate,
				nm_usuario_p,
				sysdate,
				nm_usuario_p,
				nr_seq_movto_cartao_w,
				cd_conta_financ_cartao_w,
				dividir_sem_round(vl_cartao_w * vl_transacao_w, vl_total_receb_w)
			from	dual;
		end if;
	end loop;
	close c03;

	open c05;
	loop
	fetch c05 into
		nr_seq_cheque_w,
		vl_cheque_w,
		cd_banco_w,
		ie_origem_cheque_w,
		NR_SEQ_PRODUTO_w;
	exit when c05%notfound;

		cd_conta_avista_w	:= null;
		cd_conta_dep_w		:= null;
		cd_conta_dev_w		:= null;
		cd_conta_reap_w		:= null;
		cd_conta_seg_dev_w	:= null;
		cd_conta_seg_reap_w	:= null;
		cd_conta_terc_dev_w	:= null;
		cd_conta_dev_pac_w	:= null;
		cd_conta_pre_w		:= null;
		open c04;
		loop
		fetch c04 into
			cd_conta_financ_cheque_w,
			IE_CHEQUE_AVISTA_w,
			IE_CHEQUE_DEPOSITO_w,
			IE_CHEQUE_DEV_w,
			IE_CHEQUE_REAP_w,
			IE_CHEQUE_SEG_DEV_w,
			IE_CHEQUE_SEG_REAP_w,
			IE_CHEQUE_TERC_DEV_w,
			IE_CHEQUE_DEV_PAC_w,
			IE_CHEQUE_PRE_w;
		exit when c04%notfound;
			if	(IE_CHEQUE_AVISTA_w = 'S') then
				cd_conta_avista_w	:= cd_conta_financ_cheque_w;
			end if;
			if	(IE_CHEQUE_DEPOSITO_w = 'S') then
				cd_conta_dep_w		:= cd_conta_financ_cheque_w;
			end if;
			if	(IE_CHEQUE_DEV_w = 'S') then
				cd_conta_dev_w		:= cd_conta_financ_cheque_w;
			end if;
			if	(IE_CHEQUE_REAP_w = 'S') then
				cd_conta_reap_w		:= cd_conta_financ_cheque_w;
			end if;
			if	(IE_CHEQUE_SEG_DEV_w = 'S') then
				cd_conta_seg_dev_w	:= cd_conta_financ_cheque_w;
			end if;
			if	(IE_CHEQUE_SEG_REAP_w = 'S') then
				cd_conta_seg_reap_w	:= cd_conta_financ_cheque_w;
			end if;
			if	(IE_CHEQUE_TERC_DEV_w = 'S') then
				cd_conta_terc_dev_w	:= cd_conta_financ_cheque_w;
			end if;
			if	(IE_CHEQUE_DEV_PAC_w = 'S') then
				cd_conta_dev_pac_w	:= cd_conta_financ_cheque_w;
			end if;
			if	(IE_CHEQUE_PRE_w = 'S') then
				cd_conta_pre_w		:= cd_conta_financ_cheque_w;
			end if;
		end loop;
		close c04;

		insert	into cheque_cr_classif
			(NR_SEQUENCIA,
			DT_ATUALIZACAO,
			NM_USUARIO,
			DT_ATUALIZACAO_NREC,
			NM_USUARIO_NREC,
			NR_SEQ_CHEQUE,
			VL_CLASSIFICACAO,
			CD_CONTA_PRE,
			CD_CONTA_AVISTA,
			CD_CONTA_DEP,
			CD_CONTA_DEV,
			CD_CONTA_REAP,
			CD_CONTA_SEG_DEV,
			CD_CONTA_SEG_REAP,
			CD_CONTA_TERC_DEV,
			CD_CONTA_DEV_PAC)
		select	cheque_cr_classif_seq.nextval,
			sysdate,
			nm_usuario_p,
			sysdate,
			nm_usuario_p,
			nr_seq_cheque_w,
			dividir_sem_round(vl_cheque_w * vl_transacao_w, vl_total_receb_w),
			CD_CONTA_PRE_w,
			CD_CONTA_AVISTA_w,
			CD_CONTA_DEP_w,
			CD_CONTA_DEV_w,
			CD_CONTA_REAP_w,
			CD_CONTA_SEG_DEV_w,
			CD_CONTA_SEG_REAP_w,
			CD_CONTA_TERC_DEV_w,
			CD_CONTA_DEV_PAC_w
		from	dual;

	end loop;
	close c05;


	open c07;
	loop
	fetch c07 into
		nr_seq_movto_especie_w,
		vl_especie_w;
	exit when c07%notfound;

		open c06;
		loop
		fetch c06 into
			cd_conta_financ_especie_w;
		exit when c06%notfound;
		end loop;
		close c06;

		insert into movto_trans_financ_cc
			(NR_SEQUENCIA,
			NR_SEQ_MOVTO_TRANS,
			CD_CENTRO_CUSTO,
			VL_TRANSACAO,
			DT_ATUALIZACAO,
			NM_USUARIO,
			DT_ATUALIZACAO_NREC,
			NM_USUARIO_NREC,
			CD_CONTA_FINANC)
		select	movto_trans_financ_cc_seq.nextval,
			nr_seq_movto_especie_w,
			null,
			dividir_sem_round(vl_especie_w * vl_transacao_w, vl_total_receb_w),
			sysdate,
			nm_usuario_p,
			sysdate,
			nm_usuario_p,
			cd_conta_financ_especie_w
		from	dual;

	end loop;
	close c07;

end loop;
close c01;

*/
null;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_caixa_receb_classif (nr_seq_caixa_rec_p bigint, nm_usuario_p text) FROM PUBLIC;

