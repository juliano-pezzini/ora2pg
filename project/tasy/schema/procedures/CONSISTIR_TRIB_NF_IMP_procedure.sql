-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_trib_nf_imp ( nr_seq_nota_p nota_fiscal.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, ds_erro_p INOUT text ) AS $body$
DECLARE


nr_seq_nota_int_w	nota_fiscal_int_imp.nr_sequencia%type;
vl_icms_w		nota_fiscal_int_imp.vl_icms%type;
vl_ipi_w		nota_fiscal_int_imp.vl_ipi%type;
vl_pis_w		nota_fiscal_int_imp.vl_pis%type;
vl_cofins_w		nota_fiscal_int_imp.vl_cofins%type;
vl_iss_w		nota_fiscal_int_imp.vl_iss%type;
vl_irrf_w		nota_fiscal_int_imp.vl_irrf%type;
vl_inss_w		nota_fiscal_int_imp.vl_inss%type;
vl_csll_w		nota_fiscal_int_imp.vl_csll%type;
vl_outros_w		nota_fiscal_int_imp.vl_outros%type;
cd_estabelecimento_w	nota_fiscal.cd_estabelecimento%type;
cd_cgc_emitente_w	nota_fiscal.cd_cgc_emitente%type;
dt_emissao_w		nota_fiscal.dt_emissao%type;
cd_natureza_operacao_w	nota_fiscal.cd_natureza_operacao%type;
cd_operacao_nf_w	nota_fiscal.cd_operacao_nf%type;
vl_tributo_w		nota_fiscal_trib.vl_tributo%type;
cd_tributo_w		tributo.cd_tributo%type;


BEGIN
select	max(nr_sequencia),
	coalesce(max(vl_icms),0),
	coalesce(max(vl_ipi),0),
	coalesce(max(vl_pis),0),
	coalesce(max(vl_cofins),0),
	coalesce(max(vl_iss),0),
	coalesce(max(vl_irrf),0),
	coalesce(max(vl_inss),0),
	coalesce(max(vl_csll),0),
	coalesce(max(vl_outros),0)
into STRICT	nr_seq_nota_int_w,
	vl_icms_w,
	vl_ipi_w,
	vl_pis_w,
	vl_cofins_w,
	vl_iss_w,
	vl_irrf_w,
	vl_inss_w,
	vl_csll_w,
	vl_outros_w
from	nota_fiscal_int_imp
where	nr_seq_nota	= nr_seq_nota_p;

if (nr_seq_nota_int_w IS NOT NULL AND nr_seq_nota_int_w::text <> '') then
	select	max(cd_estabelecimento),
		max(cd_cgc_emitente),
		trunc(max(dt_emissao)),
		max(cd_natureza_operacao),
		max(cd_operacao_nf)
	into STRICT	cd_estabelecimento_w,
		cd_cgc_emitente_w,
		dt_emissao_w,
		cd_natureza_operacao_w,
		cd_operacao_nf_w
	from	nota_fiscal
	where	nr_sequencia	= nr_seq_nota_p;
	
	if (vl_icms_w > 0) then
		select	max(t.cd_tributo)
		into STRICT	cd_tributo_w
		from	tributo t,
			tributo_conta_pagar p
		where	t.cd_tributo	= p.cd_tributo
		and	t.ie_tipo_tributo = 'ICMS'
		and	t.ie_conta_pagar = 'S'
		and	t.ie_situacao = 'A'
		and (coalesce(t.ie_pf_pj,'A') = 'A' or (t.ie_pf_pj = 'J' and (cd_cgc_emitente_w IS NOT NULL AND cd_cgc_emitente_w::text <> '')))
		and (coalesce(p.ie_tipo_pessoa,'A') = 'A' or (p.ie_tipo_pessoa = 'J' and (cd_cgc_emitente_w IS NOT NULL AND cd_cgc_emitente_w::text <> '')))
		and	dt_emissao_w between coalesce(p.dt_inicio_vigencia,dt_emissao_w) and coalesce(p.dt_fim_vigencia,dt_emissao_w)
		and	((coalesce(p.cd_pessoa_juridica::text, '') = '' and coalesce(p.cd_pessoa_fisica::text, '') = '')
		or (p.cd_pessoa_juridica = cd_cgc_emitente_w and coalesce(p.cd_pessoa_fisica::text, '') = ''))
		and	coalesce(t.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
		and	coalesce(p.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
		and	coalesce(p.cd_natureza_operacao,cd_natureza_operacao_w) = cd_natureza_operacao_w
		and	coalesce(p.cd_operacao_nf,cd_operacao_nf_w) = cd_operacao_nf_w;
		
		if (coalesce(cd_tributo_w::text, '') = '') then
			ds_erro_p := substr(ds_erro_p || wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195182,VL_MACROS_P => 'TRIBUTO=ICMS') || chr(13) || chr(10),1,255);

			CALL gravar_nota_fiscal_consist(NR_SEQ_NOTA_P => nr_seq_nota_p,
						DS_CONSISTENCIA_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195182,VL_MACROS_P => 'TRIBUTO=ICMS'),
						IE_FORMA_CONSISTENCIA_P => 'S',
						IE_NOTA_ITEM_P => 'N',
						DS_OBSERVACAO_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195183,VL_MACROS_P => 'TRIBUTO=ICMS'),
						NM_USUARIO_P => nm_usuario_p,
						IE_COMMIT_P => 'S');
		end if;
		
	elsif (vl_ipi_w > 0) then
		select	max(t.cd_tributo)
		into STRICT	cd_tributo_w
		from	tributo t,
			tributo_conta_pagar p
		where	t.cd_tributo	= p.cd_tributo
		and	t.ie_tipo_tributo = 'IPI'
		and	t.ie_conta_pagar = 'S'
		and	t.ie_situacao = 'A'
		and (coalesce(t.ie_pf_pj,'A') = 'A' or (t.ie_pf_pj = 'J' and (cd_cgc_emitente_w IS NOT NULL AND cd_cgc_emitente_w::text <> '')))
		and (coalesce(p.ie_tipo_pessoa,'A') = 'A' or (p.ie_tipo_pessoa = 'J' and (cd_cgc_emitente_w IS NOT NULL AND cd_cgc_emitente_w::text <> '')))
		and	dt_emissao_w between coalesce(p.dt_inicio_vigencia,dt_emissao_w) and coalesce(p.dt_fim_vigencia,dt_emissao_w)
		and	((coalesce(p.cd_pessoa_juridica::text, '') = '' and coalesce(p.cd_pessoa_fisica::text, '') = '')
		or (p.cd_pessoa_juridica = cd_cgc_emitente_w and coalesce(p.cd_pessoa_fisica::text, '') = ''))
		and	coalesce(t.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
		and	coalesce(p.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
		and	coalesce(p.cd_natureza_operacao,cd_natureza_operacao_w) = cd_natureza_operacao_w
		and	coalesce(p.cd_operacao_nf,cd_operacao_nf_w) = cd_operacao_nf_w;
		
		if (coalesce(cd_tributo_w::text, '') = '') then
			ds_erro_p := substr(ds_erro_p || wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195182,VL_MACROS_P => 'TRIBUTO=IPI') || chr(13) || chr(10),1,255);

			CALL gravar_nota_fiscal_consist(NR_SEQ_NOTA_P => nr_seq_nota_p,
						DS_CONSISTENCIA_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195182,VL_MACROS_P => 'TRIBUTO=IPI'),
						IE_FORMA_CONSISTENCIA_P => 'S',
						IE_NOTA_ITEM_P => 'N',
						DS_OBSERVACAO_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195183,VL_MACROS_P => 'TRIBUTO=IPI'),
						NM_USUARIO_P => nm_usuario_p,
						IE_COMMIT_P => 'S');
		end if;
	
	elsif (vl_pis_w > 0) then
		select	max(t.cd_tributo)
		into STRICT	cd_tributo_w
		from	tributo t,
			tributo_conta_pagar p
		where	t.cd_tributo	= p.cd_tributo
		and	t.ie_tipo_tributo = 'PIS'
		and	t.ie_conta_pagar = 'S'
		and	t.ie_situacao = 'A'
		and (coalesce(t.ie_pf_pj,'A') = 'A' or (t.ie_pf_pj = 'J' and (cd_cgc_emitente_w IS NOT NULL AND cd_cgc_emitente_w::text <> '')))
		and (coalesce(p.ie_tipo_pessoa,'A') = 'A' or (p.ie_tipo_pessoa = 'J' and (cd_cgc_emitente_w IS NOT NULL AND cd_cgc_emitente_w::text <> '')))
		and	dt_emissao_w between coalesce(p.dt_inicio_vigencia,dt_emissao_w) and coalesce(p.dt_fim_vigencia,dt_emissao_w)
		and	((coalesce(p.cd_pessoa_juridica::text, '') = '' and coalesce(p.cd_pessoa_fisica::text, '') = '')
		or (p.cd_pessoa_juridica = cd_cgc_emitente_w and coalesce(p.cd_pessoa_fisica::text, '') = ''))
		and	coalesce(t.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
		and	coalesce(p.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
		and	coalesce(p.cd_natureza_operacao,cd_natureza_operacao_w) = cd_natureza_operacao_w
		and	coalesce(p.cd_operacao_nf,cd_operacao_nf_w) = cd_operacao_nf_w;
		
		if (coalesce(cd_tributo_w::text, '') = '') then
			ds_erro_p := substr(ds_erro_p || wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195182,VL_MACROS_P => 'TRIBUTO=PIS') || chr(13) || chr(10),1,255);

			CALL gravar_nota_fiscal_consist(NR_SEQ_NOTA_P => nr_seq_nota_p,
						DS_CONSISTENCIA_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195182,VL_MACROS_P => 'TRIBUTO=PIS'),
						IE_FORMA_CONSISTENCIA_P => 'S',
						IE_NOTA_ITEM_P => 'N',
						DS_OBSERVACAO_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195183,VL_MACROS_P => 'TRIBUTO=PIS'),
						NM_USUARIO_P => nm_usuario_p,
						IE_COMMIT_P => 'S');
		end if;
	
	elsif (vl_cofins_w > 0) then
		select	max(t.cd_tributo)
		into STRICT	cd_tributo_w
		from	tributo t,
			tributo_conta_pagar p
		where	t.cd_tributo	= p.cd_tributo
		and	t.ie_tipo_tributo = 'COFINS'
		and	t.ie_conta_pagar = 'S'
		and	t.ie_situacao = 'A'
		and (coalesce(t.ie_pf_pj,'A') = 'A' or (t.ie_pf_pj = 'J' and (cd_cgc_emitente_w IS NOT NULL AND cd_cgc_emitente_w::text <> '')))
		and (coalesce(p.ie_tipo_pessoa,'A') = 'A' or (p.ie_tipo_pessoa = 'J' and (cd_cgc_emitente_w IS NOT NULL AND cd_cgc_emitente_w::text <> '')))
		and	dt_emissao_w between coalesce(p.dt_inicio_vigencia,dt_emissao_w) and coalesce(p.dt_fim_vigencia,dt_emissao_w)
		and	((coalesce(p.cd_pessoa_juridica::text, '') = '' and coalesce(p.cd_pessoa_fisica::text, '') = '')
		or (p.cd_pessoa_juridica = cd_cgc_emitente_w and coalesce(p.cd_pessoa_fisica::text, '') = ''))
		and	coalesce(t.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
		and	coalesce(p.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
		and	coalesce(p.cd_natureza_operacao,cd_natureza_operacao_w) = cd_natureza_operacao_w
		and	coalesce(p.cd_operacao_nf,cd_operacao_nf_w) = cd_operacao_nf_w;
		
		if (coalesce(cd_tributo_w::text, '') = '') then
			ds_erro_p := substr(ds_erro_p || wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195182,VL_MACROS_P => 'TRIBUTO=COFINS') || chr(13) || chr(10),1,255);

			CALL gravar_nota_fiscal_consist(NR_SEQ_NOTA_P => nr_seq_nota_p,
						DS_CONSISTENCIA_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195182,VL_MACROS_P => 'TRIBUTO=COFINS'),
						IE_FORMA_CONSISTENCIA_P => 'S',
						IE_NOTA_ITEM_P => 'N',
						DS_OBSERVACAO_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195183,VL_MACROS_P => 'TRIBUTO=COFINS'),
						NM_USUARIO_P => nm_usuario_p,
						IE_COMMIT_P => 'S');
		end if;
	
	elsif (vl_iss_w > 0) then
		select	max(t.cd_tributo)
		into STRICT	cd_tributo_w
		from	tributo t,
			tributo_conta_pagar p
		where	t.cd_tributo	= p.cd_tributo
		and	t.ie_tipo_tributo = 'ISS'
		and	t.ie_conta_pagar = 'S'
		and	t.ie_situacao = 'A'
		and (coalesce(t.ie_pf_pj,'A') = 'A' or (t.ie_pf_pj = 'J' and (cd_cgc_emitente_w IS NOT NULL AND cd_cgc_emitente_w::text <> '')))
		and (coalesce(p.ie_tipo_pessoa,'A') = 'A' or (p.ie_tipo_pessoa = 'J' and (cd_cgc_emitente_w IS NOT NULL AND cd_cgc_emitente_w::text <> '')))
		and	dt_emissao_w between coalesce(p.dt_inicio_vigencia,dt_emissao_w) and coalesce(p.dt_fim_vigencia,dt_emissao_w)
		and	((coalesce(p.cd_pessoa_juridica::text, '') = '' and coalesce(p.cd_pessoa_fisica::text, '') = '')
		or (p.cd_pessoa_juridica = cd_cgc_emitente_w and coalesce(p.cd_pessoa_fisica::text, '') = ''))
		and	coalesce(t.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
		and	coalesce(p.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
		and	coalesce(p.cd_natureza_operacao,cd_natureza_operacao_w) = cd_natureza_operacao_w
		and	coalesce(p.cd_operacao_nf,cd_operacao_nf_w) = cd_operacao_nf_w;
		
		if (coalesce(cd_tributo_w::text, '') = '') then
			ds_erro_p := substr(ds_erro_p || wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195182,VL_MACROS_P => 'TRIBUTO=ISS') || chr(13) || chr(10),1,255);

			CALL gravar_nota_fiscal_consist(NR_SEQ_NOTA_P => nr_seq_nota_p,
						DS_CONSISTENCIA_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195182,VL_MACROS_P => 'TRIBUTO=ISS'),
						IE_FORMA_CONSISTENCIA_P => 'S',
						IE_NOTA_ITEM_P => 'N',
						DS_OBSERVACAO_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195183,VL_MACROS_P => 'TRIBUTO=ISS'),
						NM_USUARIO_P => nm_usuario_p,
						IE_COMMIT_P => 'S');
		end if;
	
	elsif (vl_irrf_w > 0) then
		select	max(t.cd_tributo)
		into STRICT	cd_tributo_w
		from	tributo t,
			tributo_conta_pagar p
		where	t.cd_tributo	= p.cd_tributo
		and	t.ie_tipo_tributo = 'IR'
		and	t.ie_conta_pagar = 'S'
		and	t.ie_situacao = 'A'
		and (coalesce(t.ie_pf_pj,'A') = 'A' or (t.ie_pf_pj = 'J' and (cd_cgc_emitente_w IS NOT NULL AND cd_cgc_emitente_w::text <> '')))
		and (coalesce(p.ie_tipo_pessoa,'A') = 'A' or (p.ie_tipo_pessoa = 'J' and (cd_cgc_emitente_w IS NOT NULL AND cd_cgc_emitente_w::text <> '')))
		and	dt_emissao_w between coalesce(p.dt_inicio_vigencia,dt_emissao_w) and coalesce(p.dt_fim_vigencia,dt_emissao_w)
		and	((coalesce(p.cd_pessoa_juridica::text, '') = '' and coalesce(p.cd_pessoa_fisica::text, '') = '')
		or (p.cd_pessoa_juridica = cd_cgc_emitente_w and coalesce(p.cd_pessoa_fisica::text, '') = ''))
		and	coalesce(t.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
		and	coalesce(p.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
		and	coalesce(p.cd_natureza_operacao,cd_natureza_operacao_w) = cd_natureza_operacao_w
		and	coalesce(p.cd_operacao_nf,cd_operacao_nf_w) = cd_operacao_nf_w;
		
		if (coalesce(cd_tributo_w::text, '') = '') then
			ds_erro_p := substr(ds_erro_p || wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195182,VL_MACROS_P => 'TRIBUTO=IR') || chr(13) || chr(10),1,255);

			CALL gravar_nota_fiscal_consist(NR_SEQ_NOTA_P => nr_seq_nota_p,
						DS_CONSISTENCIA_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195182,VL_MACROS_P => 'TRIBUTO=IR'),
						IE_FORMA_CONSISTENCIA_P => 'S',
						IE_NOTA_ITEM_P => 'N',
						DS_OBSERVACAO_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195183,VL_MACROS_P => 'TRIBUTO=IR'),
						NM_USUARIO_P => nm_usuario_p,
						IE_COMMIT_P => 'S');
		end if;
	
	elsif (vl_inss_w > 0) then
		select	max(t.cd_tributo)
		into STRICT	cd_tributo_w
		from	tributo t,
			tributo_conta_pagar p
		where	t.cd_tributo	= p.cd_tributo
		and	t.ie_tipo_tributo = 'INSS'
		and	t.ie_conta_pagar = 'S'
		and	t.ie_situacao = 'A'
		and (coalesce(t.ie_pf_pj,'A') = 'A' or (t.ie_pf_pj = 'J' and (cd_cgc_emitente_w IS NOT NULL AND cd_cgc_emitente_w::text <> '')))
		and (coalesce(p.ie_tipo_pessoa,'A') = 'A' or (p.ie_tipo_pessoa = 'J' and (cd_cgc_emitente_w IS NOT NULL AND cd_cgc_emitente_w::text <> '')))
		and	dt_emissao_w between coalesce(p.dt_inicio_vigencia,dt_emissao_w) and coalesce(p.dt_fim_vigencia,dt_emissao_w)
		and	((coalesce(p.cd_pessoa_juridica::text, '') = '' and coalesce(p.cd_pessoa_fisica::text, '') = '')
		or (p.cd_pessoa_juridica = cd_cgc_emitente_w and coalesce(p.cd_pessoa_fisica::text, '') = ''))
		and	coalesce(t.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
		and	coalesce(p.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
		and	coalesce(p.cd_natureza_operacao,cd_natureza_operacao_w) = cd_natureza_operacao_w
		and	coalesce(p.cd_operacao_nf,cd_operacao_nf_w) = cd_operacao_nf_w;
		
		if (coalesce(cd_tributo_w::text, '') = '') then
			ds_erro_p := substr(ds_erro_p || wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195182,VL_MACROS_P => 'TRIBUTO=INSS') || chr(13) || chr(10),1,255);

			CALL gravar_nota_fiscal_consist(NR_SEQ_NOTA_P => nr_seq_nota_p,
						DS_CONSISTENCIA_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195182,VL_MACROS_P => 'TRIBUTO=INSS'),
						IE_FORMA_CONSISTENCIA_P => 'S',
						IE_NOTA_ITEM_P => 'N',
						DS_OBSERVACAO_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195183,VL_MACROS_P => 'TRIBUTO=INSS'),
						NM_USUARIO_P => nm_usuario_p,
						IE_COMMIT_P => 'S');
		end if;
	
	elsif (vl_csll_w > 0) then
		select	max(t.cd_tributo)
		into STRICT	cd_tributo_w
		from	tributo t,
			tributo_conta_pagar p
		where	t.cd_tributo	= p.cd_tributo
		and	t.ie_tipo_tributo = 'CSLL'
		and	t.ie_conta_pagar = 'S'
		and	t.ie_situacao = 'A'
		and (coalesce(t.ie_pf_pj,'A') = 'A' or (t.ie_pf_pj = 'J' and (cd_cgc_emitente_w IS NOT NULL AND cd_cgc_emitente_w::text <> '')))
		and (coalesce(p.ie_tipo_pessoa,'A') = 'A' or (p.ie_tipo_pessoa = 'J' and (cd_cgc_emitente_w IS NOT NULL AND cd_cgc_emitente_w::text <> '')))
		and	dt_emissao_w between coalesce(p.dt_inicio_vigencia,dt_emissao_w) and coalesce(p.dt_fim_vigencia,dt_emissao_w)
		and	((coalesce(p.cd_pessoa_juridica::text, '') = '' and coalesce(p.cd_pessoa_fisica::text, '') = '')
		or (p.cd_pessoa_juridica = cd_cgc_emitente_w and coalesce(p.cd_pessoa_fisica::text, '') = ''))
		and	coalesce(t.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
		and	coalesce(p.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
		and	coalesce(p.cd_natureza_operacao,cd_natureza_operacao_w) = cd_natureza_operacao_w
		and	coalesce(p.cd_operacao_nf,cd_operacao_nf_w) = cd_operacao_nf_w;
		
		if (coalesce(cd_tributo_w::text, '') = '') then
			ds_erro_p := substr(ds_erro_p || wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195182,VL_MACROS_P => 'TRIBUTO=CSLL') || chr(13) || chr(10),1,255);

			CALL gravar_nota_fiscal_consist(NR_SEQ_NOTA_P => nr_seq_nota_p,
						DS_CONSISTENCIA_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195182,VL_MACROS_P => 'TRIBUTO=CSLL'),
						IE_FORMA_CONSISTENCIA_P => 'S',
						IE_NOTA_ITEM_P => 'N',
						DS_OBSERVACAO_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195183,VL_MACROS_P => 'TRIBUTO=CSLL'),
						NM_USUARIO_P => nm_usuario_p,
						IE_COMMIT_P => 'S');
		end if;
	
	elsif (vl_outros_w > 0) then
		select	max(t.cd_tributo)
		into STRICT	cd_tributo_w
		from	tributo t,
			tributo_conta_pagar p
		where	t.cd_tributo	= p.cd_tributo
		and	t.ie_tipo_tributo = 'O'
		and	t.ie_conta_pagar = 'S'
		and	t.ie_situacao = 'A'
		and (coalesce(t.ie_pf_pj,'A') = 'A' or (t.ie_pf_pj = 'J' and (cd_cgc_emitente_w IS NOT NULL AND cd_cgc_emitente_w::text <> '')))
		and (coalesce(p.ie_tipo_pessoa,'A') = 'A' or (p.ie_tipo_pessoa = 'J' and (cd_cgc_emitente_w IS NOT NULL AND cd_cgc_emitente_w::text <> '')))
		and	dt_emissao_w between coalesce(p.dt_inicio_vigencia,dt_emissao_w) and coalesce(p.dt_fim_vigencia,dt_emissao_w)
		and	((coalesce(p.cd_pessoa_juridica::text, '') = '' and coalesce(p.cd_pessoa_fisica::text, '') = '')
		or (p.cd_pessoa_juridica = cd_cgc_emitente_w and coalesce(p.cd_pessoa_fisica::text, '') = ''))
		and	coalesce(t.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
		and	coalesce(p.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
		and	coalesce(p.cd_natureza_operacao,cd_natureza_operacao_w) = cd_natureza_operacao_w
		and	coalesce(p.cd_operacao_nf,cd_operacao_nf_w) = cd_operacao_nf_w;
		
		if (coalesce(cd_tributo_w::text, '') = '') then
			ds_erro_p := substr(ds_erro_p || wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195182,VL_MACROS_P => 'TRIBUTO=OUTROS') || chr(13) || chr(10),1,255);

			CALL gravar_nota_fiscal_consist(NR_SEQ_NOTA_P => nr_seq_nota_p,
						DS_CONSISTENCIA_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195182,VL_MACROS_P => 'TRIBUTO=OUTROS'),
						IE_FORMA_CONSISTENCIA_P => 'S',
						IE_NOTA_ITEM_P => 'N',
						DS_OBSERVACAO_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195183,VL_MACROS_P => 'TRIBUTO=OUTROS'),
						NM_USUARIO_P => nm_usuario_p,
						IE_COMMIT_P => 'S');
		end if;
	end if;
	
	if (vl_icms_w = 0) then
		select	coalesce(max(n.vl_tributo),0)
		into STRICT	vl_tributo_w
		from	nota_fiscal_trib n,
			tributo t
		where	t.cd_tributo	= n.cd_tributo
		and	t.ie_tipo_tributo = 'ICMS';
		
		if (vl_tributo_w > 0) then
			ds_erro_p := substr(ds_erro_p || wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195197,VL_MACROS_P => 'TRIBUTO=ICMS') || chr(13) || chr(10),1,255);

			CALL gravar_nota_fiscal_consist(NR_SEQ_NOTA_P => nr_seq_nota_p,
						DS_CONSISTENCIA_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195197,VL_MACROS_P => 'TRIBUTO=ICMS'),
						IE_FORMA_CONSISTENCIA_P => 'S',
						IE_NOTA_ITEM_P => 'N',
						DS_OBSERVACAO_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195198,VL_MACROS_P => 'TRIBUTO=ICMS'),
						NM_USUARIO_P => nm_usuario_p,
						IE_COMMIT_P => 'S');
		end if;
		
	elsif (vl_ipi_w = 0) then
		select	coalesce(max(n.vl_tributo),0)
		into STRICT	vl_tributo_w
		from	nota_fiscal_trib n,
			tributo t
		where	t.cd_tributo	= n.cd_tributo
		and	t.ie_tipo_tributo = 'IPI';
		
		if (coalesce(cd_tributo_w::text, '') = '') then
			ds_erro_p := substr(ds_erro_p || wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195197,VL_MACROS_P => 'TRIBUTO=IPI') || chr(13) || chr(10),1,255);

			CALL gravar_nota_fiscal_consist(NR_SEQ_NOTA_P => nr_seq_nota_p,
						DS_CONSISTENCIA_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195197,VL_MACROS_P => 'TRIBUTO=IPI'),
						IE_FORMA_CONSISTENCIA_P => 'S',
						IE_NOTA_ITEM_P => 'N',
						DS_OBSERVACAO_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195198,VL_MACROS_P => 'TRIBUTO=IPI'),
						NM_USUARIO_P => nm_usuario_p,
						IE_COMMIT_P => 'S');
		end if;
	
	elsif (vl_pis_w = 0) then
		select	coalesce(max(n.vl_tributo),0)
		into STRICT	vl_tributo_w
		from	nota_fiscal_trib n,
			tributo t
		where	t.cd_tributo	= n.cd_tributo
		and	t.ie_tipo_tributo = 'PIS';
		
		if (coalesce(cd_tributo_w::text, '') = '') then
			ds_erro_p := substr(ds_erro_p || wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195197,VL_MACROS_P => 'TRIBUTO=PIS') || chr(13) || chr(10),1,255);

			CALL gravar_nota_fiscal_consist(NR_SEQ_NOTA_P => nr_seq_nota_p,
						DS_CONSISTENCIA_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195197,VL_MACROS_P => 'TRIBUTO=PIS'),
						IE_FORMA_CONSISTENCIA_P => 'S',
						IE_NOTA_ITEM_P => 'N',
						DS_OBSERVACAO_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195198,VL_MACROS_P => 'TRIBUTO=PIS'),
						NM_USUARIO_P => nm_usuario_p,
						IE_COMMIT_P => 'S');
		end if;
	
	elsif (vl_cofins_w = 0) then
		select	coalesce(max(n.vl_tributo),0)
		into STRICT	vl_tributo_w
		from	nota_fiscal_trib n,
			tributo t
		where	t.cd_tributo	= n.cd_tributo
		and	t.ie_tipo_tributo = 'COFINS';
		
		if (coalesce(cd_tributo_w::text, '') = '') then
			ds_erro_p := substr(ds_erro_p || wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195197,VL_MACROS_P => 'TRIBUTO=COFINS') || chr(13) || chr(10),1,255);

			CALL gravar_nota_fiscal_consist(NR_SEQ_NOTA_P => nr_seq_nota_p,
						DS_CONSISTENCIA_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195197,VL_MACROS_P => 'TRIBUTO=COFINS'),
						IE_FORMA_CONSISTENCIA_P => 'S',
						IE_NOTA_ITEM_P => 'N',
						DS_OBSERVACAO_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195198,VL_MACROS_P => 'TRIBUTO=COFINS'),
						NM_USUARIO_P => nm_usuario_p,
						IE_COMMIT_P => 'S');
		end if;
	
	elsif (vl_iss_w = 0) then
		select	coalesce(max(n.vl_tributo),0)
		into STRICT	vl_tributo_w
		from	nota_fiscal_trib n,
			tributo t
		where	t.cd_tributo	= n.cd_tributo
		and	t.ie_tipo_tributo = 'ISS';
		
		if (coalesce(cd_tributo_w::text, '') = '') then
			ds_erro_p := substr(ds_erro_p || wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195197,VL_MACROS_P => 'TRIBUTO=ISS') || chr(13) || chr(10),1,255);

			CALL gravar_nota_fiscal_consist(NR_SEQ_NOTA_P => nr_seq_nota_p,
						DS_CONSISTENCIA_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195197,VL_MACROS_P => 'TRIBUTO=ISS'),
						IE_FORMA_CONSISTENCIA_P => 'S',
						IE_NOTA_ITEM_P => 'N',
						DS_OBSERVACAO_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195198,VL_MACROS_P => 'TRIBUTO=ISS'),
						NM_USUARIO_P => nm_usuario_p,
						IE_COMMIT_P => 'S');
		end if;
	
	elsif (vl_irrf_w = 0) then
		select	coalesce(max(n.vl_tributo),0)
		into STRICT	vl_tributo_w
		from	nota_fiscal_trib n,
			tributo t
		where	t.cd_tributo	= n.cd_tributo
		and	t.ie_tipo_tributo = 'IR';
		
		if (coalesce(cd_tributo_w::text, '') = '') then
			ds_erro_p := substr(ds_erro_p || wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195197,VL_MACROS_P => 'TRIBUTO=IR') || chr(13) || chr(10),1,255);

			CALL gravar_nota_fiscal_consist(NR_SEQ_NOTA_P => nr_seq_nota_p,
						DS_CONSISTENCIA_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195197,VL_MACROS_P => 'TRIBUTO=IR'),
						IE_FORMA_CONSISTENCIA_P => 'S',
						IE_NOTA_ITEM_P => 'N',
						DS_OBSERVACAO_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195198,VL_MACROS_P => 'TRIBUTO=IR'),
						NM_USUARIO_P => nm_usuario_p,
						IE_COMMIT_P => 'S');
		end if;
	
	elsif (vl_inss_w = 0) then
		select	coalesce(max(n.vl_tributo),0)
		into STRICT	vl_tributo_w
		from	nota_fiscal_trib n,
			tributo t
		where	t.cd_tributo	= n.cd_tributo
		and	t.ie_tipo_tributo = 'INSS';
		
		if (coalesce(cd_tributo_w::text, '') = '') then
			ds_erro_p := substr(ds_erro_p || wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195197,VL_MACROS_P => 'TRIBUTO=INSS') || chr(13) || chr(10),1,255);

			CALL gravar_nota_fiscal_consist(NR_SEQ_NOTA_P => nr_seq_nota_p,
						DS_CONSISTENCIA_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195197,VL_MACROS_P => 'TRIBUTO=INSS'),
						IE_FORMA_CONSISTENCIA_P => 'S',
						IE_NOTA_ITEM_P => 'N',
						DS_OBSERVACAO_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195198,VL_MACROS_P => 'TRIBUTO=INSS'),
						NM_USUARIO_P => nm_usuario_p,
						IE_COMMIT_P => 'S');
		end if;
	
	elsif (vl_csll_w = 0) then
		select	coalesce(max(n.vl_tributo),0)
		into STRICT	vl_tributo_w
		from	nota_fiscal_trib n,
			tributo t
		where	t.cd_tributo	= n.cd_tributo
		and	t.ie_tipo_tributo = 'CSLL';
		
		if (coalesce(cd_tributo_w::text, '') = '') then
			ds_erro_p := substr(ds_erro_p || wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195197,VL_MACROS_P => 'TRIBUTO=CSLL') || chr(13) || chr(10),1,255);

			CALL gravar_nota_fiscal_consist(NR_SEQ_NOTA_P => nr_seq_nota_p,
						DS_CONSISTENCIA_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195197,VL_MACROS_P => 'TRIBUTO=CSLL'),
						IE_FORMA_CONSISTENCIA_P => 'S',
						IE_NOTA_ITEM_P => 'N',
						DS_OBSERVACAO_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195198,VL_MACROS_P => 'TRIBUTO=CSLL'),
						NM_USUARIO_P => nm_usuario_p,
						IE_COMMIT_P => 'S');
		end if;
	
	elsif (vl_outros_w = 0) then
		select	coalesce(max(n.vl_tributo),0)
		into STRICT	vl_tributo_w
		from	nota_fiscal_trib n,
			tributo t
		where	t.cd_tributo	= n.cd_tributo
		and	t.ie_tipo_tributo = 'O';
		
		if (coalesce(cd_tributo_w::text, '') = '') then
			ds_erro_p := substr(ds_erro_p || wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195197,VL_MACROS_P => 'TRIBUTO=OUTROS') || chr(13) || chr(10),1,255);

			CALL gravar_nota_fiscal_consist(NR_SEQ_NOTA_P => nr_seq_nota_p,
						DS_CONSISTENCIA_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195197,VL_MACROS_P => 'TRIBUTO=OUTROS'),
						IE_FORMA_CONSISTENCIA_P => 'S',
						IE_NOTA_ITEM_P => 'N',
						DS_OBSERVACAO_P => wheb_mensagem_pck.get_texto(NR_SEQ_MENSAGEM_P => 1195198,VL_MACROS_P => 'TRIBUTO=OUTROS'),
						NM_USUARIO_P => nm_usuario_p,
						IE_COMMIT_P => 'S');
		end if;
	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_trib_nf_imp ( nr_seq_nota_p nota_fiscal.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, ds_erro_p INOUT text ) FROM PUBLIC;

