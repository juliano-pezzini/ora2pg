-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_justif_doador_apto ( nr_seq_doacao_p bigint, ds_justificativa_p text, cd_pessoa_fisica_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_gerar_ocorrencia_p text default null) AS $body$
DECLARE


ie_alt_doacao_sel_w	varchar(1);


BEGIN
--Alterar apenas a doação selecionada ao utilizar a opção "Alterar doador para apto" na aba "Consulta de doadores inaptos"
ie_alt_doacao_sel_w := Obter_Valor_Param_Usuario(450, 498, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_p);

insert into san_pf_alt_pac_apto(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_justificativa,
				cd_pessoa_fisica)
			values (nextval('san_pf_alt_pac_apto_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				ds_justificativa_p,
				cd_pessoa_fisica_p);

update	san_doacao
set	ie_avaliacao_final = 'A'
where	ie_avaliacao_final <> 'A'
and 	cd_pessoa_fisica = cd_pessoa_fisica_p
and	((nr_sequencia = nr_seq_doacao_p and ie_alt_doacao_sel_w = 'S') or ie_alt_doacao_sel_w = 'N');



if (ie_gerar_ocorrencia_p	= 'S') then
	CALL SAN_OCORRENCIA_DOADOR_APTO(nr_seq_doacao_p,ds_justificativa_p,nm_usuario_p);
end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_justif_doador_apto ( nr_seq_doacao_p bigint, ds_justificativa_p text, cd_pessoa_fisica_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_gerar_ocorrencia_p text default null) FROM PUBLIC;

