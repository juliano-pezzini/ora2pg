-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_param_objeto_sistema ( nr_seq_objeto_p bigint, nm_usuario_p text, dt_atualizacao_p timestamp) AS $body$
DECLARE


nm_parametro_w		varchar(30);
ie_tipo_parametro_w	varchar(15);
ie_tipo_dado_param_w	varchar(15);
nm_objeto_w		varchar(50);
ie_tipo_objeto_w	varchar(20);
nr_seq_parametro_w	bigint;
qt_parametro_w		bigint := 0;
nr_seq_apresent_w	bigint := 1;
vl_default_w		varchar(15);
qt_param_criados_w	bigint := 0;
qt_param_objeto_w	bigint := 0;

C01 CURSOR FOR
SELECT	a.argument_name,
	a.in_out,
	a.data_type,
	b.nm_objeto,
	c.object_type,
	a.default_value
from	user_arguments a,
	user_objects c,
	objeto_sistema b
where	a.object_name	= b.nm_objeto
and	c.object_name	= b.nm_objeto
and	c.object_type	in ('PROCEDURE','FUNCTION')
and coalesce(a.package_name::text, '') = ''
and	b.nr_sequencia	= nr_seq_objeto_p;


BEGIN
if (nr_seq_objeto_p IS NOT NULL AND nr_seq_objeto_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin
	update	objeto_sistema_param
	set	nr_seq_apresentacao	= -1 * nr_seq_apresentacao
	where   nr_seq_objeto 		= nr_seq_objeto_p;

	open C01;
	loop
	fetch C01 into	nm_parametro_w,
			ie_tipo_parametro_w,
			ie_tipo_dado_param_w,
			nm_objeto_w,
			ie_tipo_objeto_w,
			vl_default_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (ie_tipo_objeto_w <> 'FUNCTION') or (ie_tipo_parametro_w <> 'OUT') then
			begin
			select	count(*)
			into STRICT	qt_parametro_w
			from	objeto_sistema_param
			where	nr_seq_objeto = nr_seq_objeto_p
			and	nm_parametro = nm_parametro_w;

			if (qt_parametro_w > 0) then
				begin
				update objeto_sistema_param
				set	nr_seq_apresentacao	= nr_seq_apresent_w,
					dt_atualizacao 		= clock_timestamp(),
					nm_usuario 		= nm_usuario_p,
					ie_tipo_parametro	= ie_tipo_parametro_w,
					ie_tipo_dado_param	= ie_tipo_dado_param_w,
					vl_default		= vl_default_w
				where	nr_seq_objeto 		= nr_seq_objeto_p
				and	nm_parametro 		= nm_parametro_w;
				end;
			else
				begin
				select	nextval('objeto_sistema_param_seq')
				into STRICT	nr_seq_parametro_w
				;
				/*Tratamento para utilização de parametro do tipo TYPE*/

				if (ie_tipo_parametro_w IS NOT NULL AND ie_tipo_parametro_w::text <> '') and (nm_parametro_w IS NOT NULL AND nm_parametro_w::text <> '') then

					insert into objeto_sistema_param(
						nr_sequencia,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						dt_atualizacao,
						nm_usuario,
						nr_seq_objeto,
						nm_parametro,
						ie_tipo_parametro,
						ie_tipo_dado_param,
						vl_default,
						nr_seq_apresentacao)
					values (
						nr_seq_parametro_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_seq_objeto_p,
						nm_parametro_w,
						ie_tipo_parametro_w,
						ie_tipo_dado_param_w,
						vl_default_w,
						nr_seq_apresent_w);
				end if;
				end;
			end if;

			nr_seq_apresent_w	:= nr_seq_apresent_w + 1;
			end;
		end if;
		end;
	end loop;
	close C01;

	delete	FROM objeto_sistema_param
	where   nr_seq_objeto 		= nr_seq_objeto_p
	and	nr_seq_apresentacao	< 0;
	end;
end if;

commit;

select	count(*)
into STRICT	qt_param_objeto_w
from	user_arguments a,
		user_objects c,
		objeto_sistema b
where	a.object_name	= b.nm_objeto
and	c.object_name	= b.nm_objeto
and	c.object_type	in ('PROCEDURE','FUNCTION')
and ((c.object_type <> 'FUNCTION')
   or (a.in_out <> 'OUT'))
and coalesce(a.package_name::text, '') = ''
and	b.nr_sequencia	= nr_seq_objeto_p;

select	count(*)
into STRICT	qt_param_criados_w
from	objeto_sistema_param
where	nr_seq_objeto = nr_seq_objeto_p;

if (qt_param_objeto_w > qt_param_criados_w) then
	begin
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(472013);
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_param_objeto_sistema ( nr_seq_objeto_p bigint, nm_usuario_p text, dt_atualizacao_p timestamp) FROM PUBLIC;

