-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copia_ajuste_proc (CD_CONVENIO_ORIGEM_P bigint, CD_CATEGORIA_ORIGEM_P text, CD_CONVENIO_DESTINO_P bigint, CD_CATEGORIA_DESTINO_P text, IE_COPIA_AREA_P text, IE_COPIA_ESPECIAL_P text, IE_COPIA_GRUPO_P text, IE_COPIA_PROCED_P text, IE_COPIA_PROC_INTERNO_P text, CD_ESTABELECIMENTO_ORIG_P bigint, CD_ESTABELECIMENTO_DEST_P bigint, NM_USUARIO_P text, cd_plano_origem_p text, cd_plano_destino_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
cd_estabelecimento_w	smallint;
dt_inicio_vigencia_w	timestamp;
cd_edicao_amb_w		integer;
cd_area_procedimento_w	bigint;
cd_especialidade_w	bigint;
cd_grupo_proc_w		bigint;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
ie_preco_informado_w	varchar(1);
vl_proc_ajustado_w	double precision;
ie_glosa_w		varchar(1);
cd_procedimento_esp_w	varchar(20);
tx_ajuste_w		double precision;
nr_seq_regra_preco_w	bigint;
DT_FINAL_VIGENCIA_w     timestamp;
CD_TIPO_ACOMODACAO_w    smallint;
IE_TIPO_ATENDIMENTO_w   smallint;
CD_SETOR_ATENDIMENTO_w  integer;
VL_MEDICO_W             double precision;
VL_CUSTO_OPERACIONAL_W  double precision;
QT_FILME_W              double precision;
NR_AUXILIARES_W         smallint;
QT_PORTE_ANESTESICO_W   smallint;
TX_AJUSTE_CUSTO_OPER_W	double precision;
TX_AJUSTE_MEDICO_W	double precision;
TX_AJUSTE_FILME_W	double precision;
IE_CREDENCIADO_W	varchar(01);
pr_glosa_w		double precision;
NR_SEQ_PROC_INTERNO_w	bigint;
NR_SEQ_EXAME_w		bigint;
CD_PLANO_w		varchar(20);
IE_CLINICA_w		bigint;
CD_EMPRESA_REF_w	bigint;
CD_MOTIVO_EXC_CONTA_w	bigint;
CD_MEDICO_w		varchar(10);
IE_ATEND_RETORNO_W	varchar(1);
ie_autor_particular_w	varchar(1)	:= 'N';
cd_equipamento_w	bigint;
ie_proc_qt_zero_sus_w	varchar(1);
ie_gerar_sem_proc_ref_sus_w	varchar(1);
cd_setor_atend_prescr_w		integer;

ie_ignora_ch_edicao_amb_w	varchar(1);
ie_consiste_prescr_w		varchar(1);
ie_utiliza_video_w		varchar(1);
ie_spect_w			varchar(1);
cd_usuario_convenio_w		varchar(30);
qt_pos_inicial_w		bigint;
qt_pos_final_w			bigint;
CD_TABELA_SERVICO_w	smallint;

NR_SEQ_AREA_INT_w                                    bigint;
NR_SEQ_ESPEC_INT_w                                   bigint;
NR_SEQ_GRUPO_INT_w                                   bigint;
cd_dependente_w		smallint;
NR_SEQ_ORIGEM_W		bigint;	
cd_convenio_glosa_w	convenio.cd_convenio%type;
cd_categoria_glosa_w	categoria_convenio.cd_categoria%type;
nr_seq_estrutura_w	regra_ajuste_proc.nr_seq_estrutura%type;

C001 CURSOR FOR
SELECT	cd_estabelecimento,
	dt_inicio_vigencia,
	cd_edicao_amb,
	cd_area_procedimento,
	cd_especialidade,
	cd_grupo_proc,
	cd_procedimento,
	ie_origem_proced,
	ie_preco_informado,
	vl_proc_ajustado,
	ie_glosa,
	cd_procedimento_esp,
	tx_ajuste,
	nr_seq_regra_preco,
	dt_final_vigencia,
	cd_tipo_acomodacao,
	ie_tipo_atendimento,
	cd_setor_atendimento,
	vl_medico,
	vl_custo_operacional,
	qt_filme,
	nr_auxiliares,
	qt_porte_anestesico,
	tx_ajuste_custo_oper,
	tx_ajuste_medico,
	tx_ajuste_filme,
	ie_credenciado,
	pr_glosa,
	NR_SEQ_PROC_INTERNO,
	NR_SEQ_EXAME,	
	CD_PLANO,
	IE_CLINICA,
	CD_EMPRESA_REF,
	CD_MOTIVO_EXC_CONTA,
	CD_MEDICO,
	IE_ATEND_RETORNO,
	ie_autor_particular,
	cd_equipamento,
	ie_proc_qt_zero_sus,
	ie_gerar_sem_proc_ref_sus,
	cd_setor_atend_prescr,
	ie_ignora_ch_edicao_amb,
	ie_consiste_prescr,
	ie_utiliza_video,
	ie_spect,
	cd_usuario_convenio,
	qt_pos_inicial,
	qt_pos_final,
	CD_TABELA_SERVICO,
	NR_SEQ_AREA_INT,
	NR_SEQ_ESPEC_INT,
	NR_SEQ_GRUPO_INT,
	cd_dependente,
	NR_SEQ_ORIGEM,
	cd_convenio_glosa,
	cd_categoria_glosa,
	nr_seq_estrutura
from	regra_ajuste_proc a
where	cd_convenio = cd_convenio_origem_p
  and (coalesce(cd_categoria,cd_categoria_origem_p) = cd_categoria_origem_p or coalesce(cd_categoria_origem_p::text, '') = '')
  and (coalesce(cd_plano,cd_plano_origem_p) = cd_plano_origem_p or coalesce(cd_plano_origem_p::text, '') = '')
  and   cd_estabelecimento = cd_estabelecimento_orig_p
  and	ie_situacao = 'A'
  and	((cd_area_procedimento IS NOT NULL AND cd_area_procedimento::text <> '' AND IE_COPIA_AREA_P = 'S') or
  	 (cd_especialidade IS NOT NULL AND cd_especialidade::text <> '' AND IE_COPIA_ESPECIAL_P = 'S') or 
  	 (cd_grupo_proc IS NOT NULL AND cd_grupo_proc::text <> '' AND IE_COPIA_GRUPO_P = 'S') or 
  	 (cd_procedimento IS NOT NULL AND cd_procedimento::text <> '' AND IE_COPIA_PROCED_P = 'S') or
	 (nr_seq_proc_interno IS NOT NULL AND nr_seq_proc_interno::text <> '' AND IE_COPIA_PROC_INTERNO_P = 'S'));


BEGIN

if (IE_COPIA_AREA_P = 'S') then
	delete FROM regra_ajuste_proc
	where cd_convenio = cd_convenio_destino_p
	  and cd_categoria = cd_categoria_destino_p
	  and cd_plano = cd_plano_destino_p
	  and (cd_area_procedimento IS NOT NULL AND cd_area_procedimento::text <> '')
	  and cd_estabelecimento = cd_estabelecimento_dest_p;
end if;

if (IE_COPIA_ESPECIAL_P = 'S') then
	delete FROM regra_ajuste_proc
	where cd_convenio = cd_convenio_destino_p
	  and cd_categoria = cd_categoria_destino_p
	  and cd_plano = cd_plano_destino_p
	  and (cd_especialidade IS NOT NULL AND cd_especialidade::text <> '')
	  and cd_estabelecimento = cd_estabelecimento_dest_p;
end if;

if (IE_COPIA_GRUPO_P = 'S') then
	delete FROM regra_ajuste_proc
	where cd_convenio = cd_convenio_destino_p
	  and cd_categoria = cd_categoria_destino_p
	  and cd_plano = cd_plano_destino_p
	  and (cd_grupo_proc IS NOT NULL AND cd_grupo_proc::text <> '')
	  and cd_estabelecimento = cd_estabelecimento_dest_p;
end if;

if (IE_COPIA_PROCED_P = 'S') then
	delete FROM regra_ajuste_proc
	where cd_convenio = cd_convenio_destino_p
	  and cd_categoria = cd_categoria_destino_p
	  and cd_plano = cd_plano_destino_p
	  and (cd_procedimento IS NOT NULL AND cd_procedimento::text <> '')
	  and cd_estabelecimento = cd_estabelecimento_dest_p;
end if;

if (IE_COPIA_PROC_INTERNO_P = 'S') then
	delete	FROM regra_ajuste_proc
	where	cd_convenio = cd_convenio_destino_p
	and	cd_categoria = cd_categoria_destino_p
	and	cd_plano = cd_plano_destino_p
	and	(nr_seq_proc_interno IS NOT NULL AND nr_seq_proc_interno::text <> '')
	and	cd_estabelecimento = cd_estabelecimento_dest_p;
end if;

open c001;
loop
fetch c001 into
	cd_estabelecimento_w,
	dt_inicio_vigencia_w,
	cd_edicao_amb_w,
	cd_area_procedimento_w,
	cd_especialidade_w,
	cd_grupo_proc_w,
	cd_procedimento_w,
	ie_origem_proced_w,
	ie_preco_informado_w,
	vl_proc_ajustado_w,
	ie_glosa_w,
	cd_procedimento_esp_w,
	tx_ajuste_w,
	nr_seq_regra_preco_w,
	dt_final_vigencia_w,
	cd_tipo_acomodacao_w,
	ie_tipo_atendimento_w,
	cd_setor_atendimento_w,
	vl_medico_w,
	vl_custo_operacional_w,
	qt_filme_w,
	nr_auxiliares_w,
	qt_porte_anestesico_w,
	tx_ajuste_custo_oper_w,
	tx_ajuste_medico_w,
	tx_ajuste_filme_w,
	ie_credenciado_w,
	pr_glosa_w,
	NR_SEQ_PROC_INTERNO_w,
	NR_SEQ_EXAME_w,	
	CD_PLANO_w,
	IE_CLINICA_w,
	CD_EMPRESA_REF_w,
	CD_MOTIVO_EXC_CONTA_w,
	CD_MEDICO_w,
	IE_ATEND_RETORNO_W,
	ie_autor_particular_w,
	cd_equipamento_w,
	ie_proc_qt_zero_sus_w,
	ie_gerar_sem_proc_ref_sus_w,
	cd_setor_atend_prescr_w,
	ie_ignora_ch_edicao_amb_w,
	ie_consiste_prescr_w,
	ie_utiliza_video_w,
	ie_spect_w,
	cd_usuario_convenio_w,
	qt_pos_inicial_w,
	qt_pos_final_w,
	CD_TABELA_SERVICO_w,
	NR_SEQ_AREA_INT_w,
	NR_SEQ_ESPEC_INT_w,
	NR_SEQ_GRUPO_INT_w,
	cd_dependente_w,
	NR_SEQ_ORIGEM_W,
	cd_convenio_glosa_w,
	cd_categoria_glosa_w,
	nr_seq_estrutura_w;
EXIT WHEN NOT FOUND; /* apply on c001 */
	begin
	select nextval('regra_ajuste_proc_seq')
	into STRICT  nr_sequencia_w
	;
	insert into regra_ajuste_proc(
		nr_sequencia,
		cd_estabelecimento,
		cd_convenio,
		dt_inicio_vigencia,
		ie_situacao,
		dt_atualizacao,
		nm_usuario,
		cd_categoria,
		cd_edicao_amb,
		cd_area_procedimento,
		cd_especialidade,
		cd_grupo_proc,
		cd_procedimento,
		ie_origem_proced,
		ie_preco_informado,
		vl_proc_ajustado,
		ie_glosa,
		cd_procedimento_esp,
		tx_ajuste,
		nr_seq_regra_preco,
		dt_final_vigencia,
		cd_tipo_acomodacao,
		ie_tipo_atendimento,
		cd_setor_atendimento,
		vl_medico,
		vl_custo_operacional,
		qt_filme,
		nr_auxiliares,
		qt_porte_anestesico,
		tx_ajuste_custo_oper,
		tx_ajuste_medico,
		tx_ajuste_filme,
		ie_credenciado,
		pr_glosa,
		NR_SEQ_PROC_INTERNO,
		NR_SEQ_EXAME,	
		CD_PLANO,
		IE_CLINICA,
		CD_EMPRESA_REF,
		CD_MOTIVO_EXC_CONTA,
		CD_MEDICO,
		IE_ATEND_RETORNO,
		ie_autor_particular,
		cd_equipamento,
		ie_proc_qt_zero_sus,
		ie_gerar_sem_proc_ref_sus,
		cd_setor_atend_prescr,
		ie_ignora_ch_edicao_amb,
		ie_consiste_prescr,
		ie_utiliza_video,
		ie_spect,
		cd_usuario_convenio,
		qt_pos_inicial,
		qt_pos_final,
		CD_TABELA_SERVICO,
		NR_SEQ_AREA_INT,
		NR_SEQ_ESPEC_INT,
		NR_SEQ_GRUPO_INT,
		cd_dependente,
		nr_seq_origem,
		cd_convenio_glosa,
		cd_categoria_glosa,
		nr_seq_estrutura)
	values ( nr_sequencia_w,
		cd_estabelecimento_dest_p,
		cd_convenio_destino_p,
		dt_inicio_vigencia_w,
		'A',
		clock_timestamp(),
		nm_usuario_p,
		cd_categoria_destino_p,
		cd_edicao_amb_w,
		cd_area_procedimento_w,
		cd_especialidade_w,
		cd_grupo_proc_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		ie_preco_informado_w,
		vl_proc_ajustado_w,
		ie_glosa_w,
		cd_procedimento_esp_w,
		tx_ajuste_w,
		nr_seq_regra_preco_w,
		dt_final_vigencia_w,
		cd_tipo_acomodacao_w,
		ie_tipo_atendimento_w,
		cd_setor_atendimento_w,
		vl_medico_w,
		vl_custo_operacional_w,
		qt_filme_w,
		nr_auxiliares_w,
		qt_porte_anestesico_w,
		tx_ajuste_custo_oper_w,
		tx_ajuste_medico_w,
		tx_ajuste_filme_w,
		ie_credenciado_w,
		pr_glosa_w,
		NR_SEQ_PROC_INTERNO_w,
		NR_SEQ_EXAME_w,	
		coalesce(cd_plano_destino_p, CD_PLANO_w),
		IE_CLINICA_w,
		CD_EMPRESA_REF_w,
		CD_MOTIVO_EXC_CONTA_w,
		CD_MEDICO_w,
		IE_ATEND_RETORNO_W,
		ie_autor_particular_w,
		cd_equipamento_w,
		ie_proc_qt_zero_sus_w,
		ie_gerar_sem_proc_ref_sus_w,
		cd_setor_atend_prescr_w,
		ie_ignora_ch_edicao_amb_w,
		ie_consiste_prescr_w,
		ie_utiliza_video_w,
		ie_spect_w,
		cd_usuario_convenio_w,
		qt_pos_inicial_w,
		qt_pos_final_w,
		CD_TABELA_SERVICO_w,
		NR_SEQ_AREA_INT_w,
		NR_SEQ_ESPEC_INT_w,
		NR_SEQ_GRUPO_INT_w,
		cd_dependente_w,
		nr_seq_origem_w,
		cd_convenio_glosa_w,
		cd_categoria_glosa_w,
		nr_seq_estrutura_w);
	end;
end loop;
close c001;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copia_ajuste_proc (CD_CONVENIO_ORIGEM_P bigint, CD_CATEGORIA_ORIGEM_P text, CD_CONVENIO_DESTINO_P bigint, CD_CATEGORIA_DESTINO_P text, IE_COPIA_AREA_P text, IE_COPIA_ESPECIAL_P text, IE_COPIA_GRUPO_P text, IE_COPIA_PROCED_P text, IE_COPIA_PROC_INTERNO_P text, CD_ESTABELECIMENTO_ORIG_P bigint, CD_ESTABELECIMENTO_DEST_P bigint, NM_USUARIO_P text, cd_plano_origem_p text, cd_plano_destino_p text) FROM PUBLIC;

