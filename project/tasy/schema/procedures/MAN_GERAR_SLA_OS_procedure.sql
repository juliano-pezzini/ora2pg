-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_sla_os ( cd_estabelecimento_p bigint, nr_sequencia_p bigint, nm_usuario_p text, ie_prioridade_p text, ie_classificacao_p text, nr_seq_localizacao_p bigint, nr_seq_grupo_trab_p bigint, dt_ordem_servico_p timestamp, dt_inicio_p timestamp, nr_seq_estagio_p bigint, nr_seq_equipamento_p bigint, nr_seq_classif_p bigint, ie_parado_p text) AS $body$
DECLARE


qt_min_inicio_w			    bigint;
qt_min_termino_w		                    bigint;
nr_seq_sla_w			    bigint;
nr_seq_sla_regra_w	    	                    bigint;
nr_sequencia_w			    bigint;
dt_inicio_prev_w		                    timestamp;
dt_termino_prev_w		                    timestamp;
qt_reg_w		                                    bigint;
ie_tempo_w			    varchar(15);
nr_seq_estagio_w		                    bigint;
nr_seq_tipo_equip_w	                    bigint;
nr_seq_tipo_equip_ww		    bigint;
nr_seq_equipamento_w		    bigint;
ie_tipo_sla_w		    	    man_sla_regra.ie_tipo_sla%type;
ie_utiliza_sla_w		    varchar(255) := obter_valor_param_usuario(299,57,wheb_usuario_pck.get_cd_perfil,coalesce(nm_usuario_p,wheb_usuario_pck.get_nm_usuario),wheb_usuario_pck.get_cd_estabelecimento);

C01 CURSOR FOR
SELECT	b.nr_seq_sla,
	b.qt_min_inicio,
	b.qt_min_termino,
	b.ie_tempo,
	b.nr_seq_estagio,
	b.nr_seq_equipamento,
	b.nr_seq_tipo_equipamento,
	b.nr_sequencia,
	b.ie_tipo_sla
FROM man_sla_regra b, man_sla a
LEFT OUTER JOIN man_sla_loc c ON (a.nr_sequencia = c.nr_seq_sla)
WHERE a.nr_sequencia					= b.nr_seq_sla  and a.dt_vigencia					<= clock_timestamp() and coalesce(c.nr_seq_local,nr_seq_localizacao_p)	= nr_seq_localizacao_p and coalesce(a.nr_seq_grupo_trab, coalesce(nr_seq_grupo_trab_p,0))	= coalesce(nr_seq_grupo_trab_p,0) and b.ie_classificacao					= ie_classificacao_p and coalesce(ie_prioridade,ie_prioridade_p)			= ie_prioridade_p and coalesce(nr_seq_estagio, coalesce(nr_seq_estagio_p,0))	 	= coalesce(nr_seq_estagio_p,0) and coalesce(nr_seq_classif, coalesce(nr_seq_classif_p,0))	 	= coalesce(nr_seq_classif_p,0) and coalesce(nr_seq_equipamento, coalesce(nr_seq_equipamento_p,0)) 	= coalesce(nr_seq_equipamento_p,0) and coalesce(nr_seq_tipo_equipamento, coalesce(nr_seq_tipo_equip_w,0))	= coalesce(nr_seq_tipo_equip_w,0) and coalesce(b.ie_parado, coalesce(ie_parado_p,'X'))			= coalesce(ie_parado_p,'X') and qt_reg_w						= 0 and a.ie_situacao				= 'A' and ((c.nr_seq_local IS NOT NULL AND c.nr_seq_local::text <> '') or ie_utiliza_sla_w = 'L') order by coalesce(ie_prioridade,' '),
        c.nr_seq_sla,
        CASE WHEN ie_utiliza_sla_w='l' THEN  ''  ELSE c.nr_seq_local END  desc,
        a.nr_seq_grupo_trab desc,
        b.nr_seq_equipamento desc,
        b.nr_seq_estagio desc,
        b.nr_seq_classif desc,
        b.nr_seq_tipo_equipamento desc,
        b.ie_parado desc,
        c.nr_seq_local desc;


BEGIN
select	count(*)
into STRICT	qt_reg_w
from	man_ordem_serv_sla
where	nr_seq_ordem		= nr_sequencia_p;

select	coalesce(max(nr_seq_tipo_equip),0)
into STRICT	nr_seq_tipo_equip_w
from	man_equipamento
where	nr_sequencia = nr_seq_equipamento_p;

nr_seq_sla_w			:= 0;
open C01;
loop
fetch C01 into	
	nr_seq_sla_w,
	qt_min_inicio_w,
	qt_min_termino_w,
	ie_tempo_w,
	nr_seq_estagio_w,
	nr_seq_equipamento_w,
	nr_seq_tipo_equip_ww,
	nr_seq_sla_regra_w,
	ie_tipo_sla_w;		
EXIT WHEN NOT FOUND; /* apply on C01 */
	nr_seq_sla_w		:= nr_seq_sla_w;
	nr_seq_sla_regra_w	:= nr_seq_sla_regra_w;
End loop;
close C01;
if (coalesce(nr_seq_sla_w,0) > 0) then
	select	nextval('man_ordem_serv_sla_seq')
	into STRICT	nr_sequencia_w	
	;
	if (ie_tempo_w = 'COR') then
		dt_inicio_prev_w	:= dt_ordem_servico_p + (qt_min_inicio_w / 1440);
		dt_termino_prev_w	:= dt_ordem_servico_p + (qt_min_termino_w / 1440);
	else
		dt_inicio_prev_w	:= man_obter_hor_com(cd_estabelecimento_p, dt_ordem_servico_p, qt_min_inicio_w);
		dt_termino_prev_w	:= man_obter_hor_com(cd_estabelecimento_p, dt_ordem_servico_p, qt_min_termino_w);
	end if;
	
	if (coalesce(nr_seq_estagio_w,0) > 0) then
		if (ie_tempo_w = 'COR') then
			dt_inicio_prev_w	:= clock_timestamp() + (qt_min_inicio_w / 1440);
			dt_termino_prev_w	:= clock_timestamp() + (qt_min_termino_w / 1440);
		else
			dt_inicio_prev_w	:= man_obter_hor_com(cd_estabelecimento_p, clock_timestamp(), qt_min_inicio_w);
			dt_termino_prev_w	:= man_obter_hor_com(cd_estabelecimento_p, clock_timestamp(), qt_min_termino_w);
		end if;
	end if;
	
	insert into man_ordem_serv_sla(
		nr_sequencia,
		nr_seq_ordem,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_sla,
		ie_prioridade,
		ie_classificacao,
		qt_min_inicio,
		qt_min_termino,
		dt_inicio_prev,
		dt_termino_prev,
		nr_seq_status,
		ie_tempo,
		cd_estabelecimento,
		dt_ordem,
		qt_desvio_inic,
		dt_inicio,
		nr_seq_estagio,
		nr_seq_equipamento,
		nr_seq_tipo_equipamento,
		nr_seq_sla_regra,
		ie_tipo_sla)
	values (	nr_sequencia_w,
		nr_sequencia_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_sla_w,
		ie_prioridade_p,
		ie_classificacao_p,
		qt_min_inicio_w,
		qt_min_termino_w,
		dt_inicio_prev_w,
		dt_termino_prev_w,
		415,
		ie_tempo_w,
		cd_estabelecimento_p,
		dt_ordem_servico_p,
		0,
		dt_inicio_p,
		nr_seq_estagio_w,
		nr_seq_equipamento_w,
		nr_seq_tipo_equip_ww,
		nr_seq_sla_regra_w,
		ie_tipo_sla_w);
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_sla_os ( cd_estabelecimento_p bigint, nr_sequencia_p bigint, nm_usuario_p text, ie_prioridade_p text, ie_classificacao_p text, nr_seq_localizacao_p bigint, nr_seq_grupo_trab_p bigint, dt_ordem_servico_p timestamp, dt_inicio_p timestamp, nr_seq_estagio_p bigint, nr_seq_equipamento_p bigint, nr_seq_classif_p bigint, ie_parado_p text) FROM PUBLIC;

