-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_kit_estoque_req ( nr_seq_kit_estoque_p bigint, nr_requisicao_p bigint, nm_usuario_p text) AS $body$
DECLARE



cd_estabelecimento_w			smallint;
nr_sequencia_w					integer;
nr_sequencia_ww					integer;
cd_material_w					integer;
cd_material_ww					integer;
qt_material_requisitada_w		double precision;
qt_material_requisitada_ww		double precision;
cd_unidade_medida_consumo_w		varchar(30);
cd_unidade_medida_estoque_w		varchar(30);
nr_seq_lote_fornec_w 			varchar(255);
qt_material_w					double precision;
qt_estoque_w					double precision;
cd_local_estoque_destino_w		smallint;

c01 CURSOR FOR
SELECT	a.cd_material,
	a.qt_material,
	substr(obter_dados_material_estab(a.cd_material,cd_estabelecimento_w,'UMS'),1,30) cd_unidade_medida_consumo,
	substr(obter_dados_material_estab(a.cd_material,cd_estabelecimento_w,'UME'),1,30) cd_unidade_medida_estoque,
	a.qt_material / obter_conversao_material(a.cd_material,'EC') qt_estoque,
	a.nr_seq_lote_fornec
from 	kit_estoque_comp a,
	material b
where 	a.cd_material = b.cd_material
and 	a.nr_seq_kit_estoque = nr_seq_kit_estoque_p;


BEGIN

select	cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	requisicao_material
where	nr_requisicao = nr_requisicao_p;


OPEN C01;
LOOP
FETCH C01 INTO
	cd_material_ww,
	qt_material_w,
	cd_unidade_medida_consumo_w,
	cd_unidade_medida_estoque_w,
	qt_estoque_w,
	nr_seq_lote_fornec_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	select	coalesce(max(nr_sequencia), 0) + 1
	into STRICT	nr_sequencia_ww
	from	item_requisicao_material
	where	nr_requisicao = nr_requisicao_p;

	insert into item_requisicao_material(
			nr_requisicao,
			nr_seq_kit_estoque,
			nr_sequencia,
			cd_estabelecimento,
			cd_material,
			qt_material_requisitada,
			vl_material,
			dt_atualizacao,
			nm_usuario,
			cd_unidade_medida,
			cd_motivo_baixa,
			qt_estoque,
			cd_unidade_medida_estoque,
			cd_material_req,
			ie_geracao,
			nr_seq_lote_fornec)
		values ( nr_requisicao_p,
			nr_seq_kit_estoque_p,
			nr_sequencia_ww,
			cd_estabelecimento_w,
			cd_material_ww,
			qt_material_w,
			0,
			clock_timestamp(),
			nm_usuario_p,
			cd_unidade_medida_consumo_w,
			0,
			qt_estoque_w,
			cd_unidade_medida_estoque_w,
			cd_material_ww,
			'S',
			nr_seq_lote_fornec_w);
	end;
end loop;
close c01;

/*Identifica que o item é um KIT e já foi desdobrado na liberação da requisição*/

update	item_requisicao_material
set	ie_geracao = 'D'
where	nr_requisicao = nr_requisicao_p
and	nr_sequencia = nr_sequencia_ww;

/*Realiza transferencia de local de estoque*/

select	max(cd_local_estoque_destino)
into STRICT	cd_local_estoque_destino_w
from	requisicao_material
where	nr_requisicao		= nr_requisicao_p;

if (cd_local_estoque_destino_w IS NOT NULL AND cd_local_estoque_destino_w::text <> '') then

	update	kit_estoque
	set		cd_local_estoque	= cd_local_estoque_destino_w
	where	nr_sequencia		= nr_seq_kit_estoque_p;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_kit_estoque_req ( nr_seq_kit_estoque_p bigint, nr_requisicao_p bigint, nm_usuario_p text) FROM PUBLIC;

