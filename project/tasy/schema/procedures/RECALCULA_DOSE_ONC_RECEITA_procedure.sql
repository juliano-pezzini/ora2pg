-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE recalcula_dose_onc_receita ( nr_seq_paciente_p bigint, nm_usuario_p text, nr_ciclo_p bigint default 0) AS $body$
DECLARE



nr_sequencia_w			fa_receita_farmacia_item.nr_sequencia%type;
nr_seq_receita_w		fa_receita_farmacia_item.nr_seq_receita%type;
cd_material_w			fa_receita_farmacia_item.cd_material%type;
nr_seq_atendimento_w	paciente_atendimento.nr_seq_atendimento%type;
qt_dose_prescricao_w	paciente_atend_medic.qt_dose_prescricao%type;

c01 CURSOR FOR
	SELECT	nr_sequencia, nr_seq_receita, cd_material
	from 	fa_receita_farmacia_item
	where 	nr_seq_receita in (	SELECT 	nr_sequencia 
								from 	fa_receita_farmacia 
								where 	nr_seq_atendimento( select	nr_seq_atendimento
																from	paciente_atendimento
																where	coalesce(nr_prescricao::text, '') = ''
																and		nr_seq_paciente = nr_seq_paciente_p )
								and     coalesce(dt_liberacao::text, '') = '' 
								and     coalesce(dt_liberacao_parcial::text, '') = '');

c02 CURSOR FOR
	SELECT 	b.qt_dose_prescricao
	from 	paciente_atendimento a,
			paciente_atend_medic b
	where 	a.nr_seq_paciente 	= nr_seq_paciente_p
	and   	b.cd_material 		= cd_material_w
	and		trunc(coalesce(a.dt_real,a.dt_prevista)) >= trunc(clock_timestamp())
	and		((coalesce(nr_ciclo_p,0) 	= 0) or (nr_ciclo_p = a.nr_ciclo))
	and   	a.nr_seq_atendimento 	= b.nr_seq_atendimento
	and   	a.nr_seq_atendimento 	in (	SELECT	nr_seq_atendimento
											from	paciente_atendimento
											where	coalesce(nr_prescricao::text, '') = ''
											and		nr_seq_paciente = nr_seq_paciente_p
											and		trunc(coalesce(dt_real,dt_prevista)) >= trunc(clock_timestamp())
											and		((coalesce(nr_ciclo_p,0) = 0) or (nr_ciclo_p = nr_ciclo)));
	

BEGIN

open c01;
loop
fetch c01 into
	nr_sequencia_w,
	nr_seq_receita_w,
	cd_material_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

		open c02;
		loop
		fetch c02 into	
			qt_dose_prescricao_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin

				update 	fa_receita_farmacia_item
				set		qt_dose 		= qt_dose_prescricao_w
				where	cd_material		= cd_material_w
				and		nr_seq_receita 	= nr_seq_receita_w
				and		nr_sequencia	= nr_sequencia_w;

			end;
		end loop;
		close c02;

	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE recalcula_dose_onc_receita ( nr_seq_paciente_p bigint, nm_usuario_p text, nr_ciclo_p bigint default 0) FROM PUBLIC;

