-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_alerta_precaucao ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


dt_registro_w		timestamp;
nr_seq_precaucao_w	bigint;
nr_seq_motivo_isol_w	bigint;
dt_inicio_w		timestamp;
dt_termino_w		timestamp;
DS_OBSERVACAO_w		varchar(32000);
ds_motivo_w		varchar(90);
nr_atendimento_w	bigint;
ds_precaucao_w		varchar(150);
ds_informacao_w		varchar(32000);
DS_CUIDADO_w		varchar(4000);
nr_seq_triagem_w	bigint;
cd_pessoa_fisica_w	pessoa_fisica.cd_pessoa_fisica%type;
nr_seq_alerta_atend_w	atendimento_alerta.nr_Sequencia%type;
nr_seq_alerta_paciente_w	alerta_paciente.nr_Sequencia%type;
ie_should_sign_w varchar(10);


BEGIN

begin

select 	dt_registro,
	nr_seq_precaucao,
	nr_seq_motivo_isol,
	dt_inicio,
	dt_termino,
	DS_OBSERVACAO,
	nr_atendimento,
	nr_seq_triagem
Into STRICT	DT_REGISTRO_w,
	nr_seq_precaucao_w,
	nr_seq_motivo_isol_w,
	dt_inicio_w,
	dt_termino_w,
	DS_OBSERVACAO_w,
	nr_atendimento_w,
	nr_seq_triagem_w
from	atendimento_precaucao
where	nr_sequencia = nr_sequencia_p;

select	max(DS_PRECAUCAO) ds
into STRICT	ds_precaucao_w
from	cih_precaucao
where	nr_sequencia = nr_seq_precaucao_w;

select	max(ds_cuidado)
into STRICT	ds_cuidado_w
from	cih_precaucao
where	nr_sequencia = nr_seq_precaucao_w
and	ie_gerar_alerta = 'C';

if (nr_seq_motivo_isol_w IS NOT NULL AND nr_seq_motivo_isol_w::text <> '') then

	select	ds_motivo
	into STRICT	ds_motivo_w
	from	motivo_isolamento
	where	nr_Sequencia = nr_seq_motivo_isol_w;

end if;

ds_informacao_w := 	OBTER_DESC_EXPRESSAO(691589) ||chr(13) || chr(10) ||chr(13) || chr(10) ||															-- 691589: 'Precaucao:'
			OBTER_DESC_EXPRESSAO(327202) || ' '||DT_REGISTRO_w || chr(13) || chr(10) ||																	-- 327202: 'Data:'
			OBTER_DESC_EXPRESSAO(691589) || ' ' ||ds_precaucao_w || chr(13) || chr(10);

if (ds_motivo_w IS NOT NULL AND ds_motivo_w::text <> '') then
	ds_informacao_w	:= 	ds_informacao_w || OBTER_DESC_EXPRESSAO(327458) || ' '||ds_motivo_w||chr(13) || chr(10);										-- 327458: 'Motivo:'
end if;

If (dt_inicio_w IS NOT NULL AND dt_inicio_w::text <> '') then
	ds_informacao_w	:= 	ds_informacao_w || OBTER_DESC_EXPRESSAO(648277) || ' '||PKG_DATE_FORMATERS.TO_VARCHAR(dt_inicio_w,'timestamp', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, nm_usuario_p)||chr(13) || chr(10);		-- 648277: 'Inicio:'
end if;

If (dt_termino_w IS NOT NULL AND dt_termino_w::text <> '') then
	ds_informacao_w	:= 	ds_informacao_w || OBTER_DESC_EXPRESSAO(729249) || ' '||PKG_DATE_FORMATERS.TO_VARCHAR(dt_termino_w,'timestamp', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, nm_usuario_p)||chr(13) || chr(10);		-- 729249: 'Fim:'
end if;

If (DS_OBSERVACAO_w IS NOT NULL AND DS_OBSERVACAO_w::text <> '') then
	ds_informacao_w	:= 	ds_informacao_w || chr(13) || chr(10)||OBTER_DESC_EXPRESSAO(329252) || ' '||chr(13) || chr(10)||DS_OBSERVACAO_w||chr(13) || chr(10);	-- 329252: 'Observacao:'
end if;

if (ds_cuidado_w IS NOT NULL AND ds_cuidado_w::text <> '') then
	ds_informacao_w :=	ds_informacao_w || OBTER_DESC_EXPRESSAO(729225) || ' ' || ds_cuidado_w ||chr(13) || chr(10);									-- 729225: 'Cuidado:'
end if;

if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then

	select nextval('atendimento_alerta_seq')
	into STRICT nr_seq_alerta_atend_w
	;

	insert into atendimento_alerta(
		nr_sequencia,
		nr_atendimento,
		dt_alerta,
		dt_atualizacao,
		nm_usuario,
		ds_alerta,
		ie_situacao,
		dt_fim_alerta,
		dt_liberacao,
		dt_inativacao,
		nm_usuario_inativacao,
		ds_justificativa,
		nr_seq_precaucao)
	values (
		nr_seq_alerta_atend_w,
		nr_atendimento_w,
		clock_timestamp(),
		clock_timestamp(),
		nm_usuario_p,
		substr(ds_informacao_w,1,2000),
		'A',
		null,
		clock_timestamp(),
		null,
		null,
		null,
		nr_sequencia_p);

	select  coalesce(max(ie_assinatura), 'N')
	into STRICT    ie_should_sign_w
	from    tasy_proj_assin_perfil
	where   nr_seq_proj = 53662
	and     coalesce(cd_perfil,obter_perfil_ativo) = obter_perfil_ativo;

	if ((ie_should_sign_w IS NOT NULL AND ie_should_sign_w::text <> '') and ie_should_sign_w <> 'N') then
		CALL perform_record_signature(nr_atendimento_w,
			OBTER_PESSOA_ATENDIMENTO(nr_atendimento_w,'C'),
			nm_usuario_p,
			53662,
			'ATENDIMENTO_ALERTA',
			nr_seq_alerta_atend_w,
			29259,
			obter_funcao_ativa,
			'L');
	end if;

elsif (nr_seq_triagem_w IS NOT NULL AND nr_seq_triagem_w::text <> '') then

	select	max(cd_pessoa_fisica)
	into STRICT	cd_pessoa_fisica_w
	from	triagem_pronto_atend
	where	nr_sequencia = nr_seq_triagem_w;
	
	select nextval('alerta_paciente_seq')
	into STRICT nr_seq_alerta_paciente_w
	;

	insert into alerta_paciente(
		nr_sequencia,
		cd_estabelecimento,
		cd_pessoa_fisica,
		dt_alerta,
		dt_atualizacao,
		nm_usuario,
		ds_alerta,
		ie_situacao,
		dt_fim_alerta,
		cd_funcao,
		dt_liberacao,
		dt_inativacao,
		nm_usuario_inativacao,
		ds_justificativa,
		nr_seq_precaucao)
	values (
		nr_seq_alerta_paciente_w,
		wheb_usuario_pck.get_cd_estabelecimento,
		cd_pessoa_fisica_w,
		clock_timestamp(),
		clock_timestamp(),
		nm_usuario_p,
		substr(ds_informacao_w,1,2000),
		'A',
		null,
		281, --PEP
		clock_timestamp(),
		null,
		null,
		null,
		nr_sequencia_p);

	select  coalesce(max(ie_assinatura), 'N')
	into STRICT    ie_should_sign_w
	from    tasy_proj_assin_perfil
	where   nr_seq_proj = 53658
	and     coalesce(cd_perfil,obter_perfil_ativo) = obter_perfil_ativo;

	if ((ie_should_sign_w IS NOT NULL AND ie_should_sign_w::text <> '') and ie_should_sign_w <> 'N') then
		CALL perform_record_signature(null,
			cd_pessoa_fisica_w,
			nm_usuario_p,
			53658,
			'ALERTA_PACIENTE',
			nr_seq_alerta_paciente_w,
			29254,
			obter_funcao_ativa,
			'L');
	end if;

end if;

commit;

exception
when others then
null;

end;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_alerta_precaucao ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

