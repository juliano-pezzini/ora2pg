-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consiste_regra_reemb_acao (nr_seq_regra_acao_p pls_regra_reemb_acao.nr_sequencia%type) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:  	consiste os registros pls_regra_reemb_aprop referente a pls_regra_reemb_acao
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[X]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:

Alterações:
------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
qt_geral_w		integer;
qt_ordem_dupli_w	integer;
qt_pr_w			integer;
qt_pr_df_w		integer;
qt_vl_fixo_w		integer;
qt_vl_limite_w		integer;
ie_ult_vl_fixo_limite_w	integer;
qt_perc_calc_apres_w	integer;

ie_acao_w		pls_regra_reemb_acao.ie_acao%type;
pr_distribuicao_ult_w	pls_regra_reemb_aprop.pr_distribuicao%type;
pr_distribuicao_total_w	pls_regra_reemb_aprop.pr_distribuicao%type;

BEGIN

-- Verifica ie_ordem duplicado
select (select 	count(1)
	from 	pls_regra_reemb_aprop a
	where	a.nr_seq_regra_acao = nr_seq_regra_acao_p) qt_geral, -- Quantidade geral
	(select	max(coalesce(qt_ordem,0))
	from (select 	count(1) qt_ordem
		from 	pls_regra_reemb_aprop a
		where	a.nr_seq_regra_acao = nr_seq_regra_acao_p
		group	by a.ie_ordem) alias5) qt_ordem_dupli, -- Quantidade duplicado
	(select	count(1)
	from 	pls_regra_reemb_aprop a
	where	a.nr_seq_regra_acao = nr_seq_regra_acao_p
	and	a.ie_tipo_distribuicao = 2) qt_pr, -- Percentual
	(select	count(1)
	from 	pls_regra_reemb_aprop a
	where	a.nr_seq_regra_acao = nr_seq_regra_acao_p
	and	a.ie_tipo_distribuicao = 3) qt_pr_df,-- Percentual sobre a diferença
	(select count(1)
	from 	pls_regra_reemb_aprop a
	where	a.nr_seq_regra_acao = nr_seq_regra_acao_p
	and	coalesce(a.vl_fixo,0) > 0) qt_vl_fixo,	-- Valor fixo
	(select	a.ie_acao
	from	pls_regra_reemb_acao a
	where	a.nr_sequencia		= nr_seq_regra_acao_p) ie_acao,	-- Le o tipo de acao
	(select count(1)
	from 	pls_regra_reemb_aprop a
	where	a.nr_seq_regra_acao = nr_seq_regra_acao_p
	and	coalesce(a.vl_limite,0) > 0) qt_vl_limite,	-- Valor limite
	(select 	count(1)
	from	(select	1
		from	pls_regra_reemb_aprop a
		where (coalesce(a.vl_limite,0) > 0 or coalesce(a.vl_fixo,0) > 0)
		and	a.nr_seq_regra_acao = nr_seq_regra_acao_p
		--Realizada a verificação segundo a ordem e não mais a sequencia. OS912808 - aedemuth
		and	a.ie_ordem = (select max(x.ie_ordem) from pls_regra_reemb_aprop x where x.nr_seq_regra_acao = nr_seq_regra_acao_p)) alias24) ie_ult_vl_fixo_limite,
	(select pr_distribuicao
	from 	pls_regra_reemb_aprop a
	where	a.ie_tipo_distribuicao = 3
	and	a.nr_sequencia = (select max(x.nr_sequencia) from pls_regra_reemb_aprop x where x.nr_seq_regra_acao = nr_seq_regra_acao_p)) pr_distribuicao_ult,
	(select sum(pr_distribuicao)
	from 	pls_regra_reemb_aprop a
	where	a.ie_tipo_distribuicao = 2
	and	a.nr_seq_regra_acao = nr_seq_regra_acao_p) pr_distribuicao_total,
	(select count(1)
	from 	pls_regra_reemb_aprop a
	where	a.nr_seq_regra_acao = nr_seq_regra_acao_p
	and	coalesce(ie_tipo_valor,'L') <> 'L') ie_perc_calc_apres -- Percentual sobre calculado ou apresentado
into STRICT	qt_geral_w,
	qt_ordem_dupli_w,
	qt_pr_w,
	qt_pr_df_w,
	qt_vl_fixo_w,
	ie_acao_w,
	qt_vl_limite_w,
	ie_ult_vl_fixo_limite_w,
	pr_distribuicao_ult_w,
	pr_distribuicao_total_w,
	qt_perc_calc_apres_w
;

if (qt_ordem_dupli_w > 1) then
	-- Campo ordem duplicado
	-- Impossível liberar a ação da regra. Existem registros com valor de campo Ordem duplicado.
	CALL wheb_mensagem_pck.exibir_mensagem_abort(310269);
end if;

if (ie_acao_w in ('N','RC') and qt_geral_w > 0) then
	-- Se ie_acao for 'N' (Não reembolsar) não deve haver registros em pls_regra_reemb_aprop
	-- Impossível liberar a ação da regra. Para ação do tipo Não reembolsar não deve haver registros de apropriação.
	CALL wheb_mensagem_pck.exibir_mensagem_abort(310270);
end if;

if (ie_ult_vl_fixo_limite_w > 0) then
	-- O último registro na ordem não pode possuir valor limite ou valor fixo.
	-- Impossível liberar a ação da regra. O último registro de apropriação não deve possuir valor limite ou valor fixo.
	CALL wheb_mensagem_pck.exibir_mensagem_abort(310283);
end if;
if (qt_vl_limite_w > 0 or qt_vl_fixo_w > 0) then
	-- Se tem alguma apropriação com valor informado (fixo) ou valor limite
	if (qt_pr_df_w = 0) then
		-- tem que ter ao menos uma de percentual sobre diferença
		-- Impossível liberar a ação da regra. Quando existe apropriação com valor fixo ou valor limite deve haver pelo menos uma de percentual sobre a diferença.
		CALL wheb_mensagem_pck.exibir_mensagem_abort(310285);
	end if;
	--if	(qt_pr_w > 0) then
		-- e não pode ter nenhuma de só percentual
		-- Impossível liberar a ação da regra. Quando existe apropriação com valor fixo ou valor limite não deve haver apropriação de percentual.
		--wheb_mensagem_pck.exibir_mensagem_abort(310287);
	--end if;
end if;
if (qt_pr_df_w > 0 and (ie_ult_vl_fixo_limite_w > 0 or pr_distribuicao_ult_w <> 100)) then
	-- Se tem alguma apropriação com % sobre diferença, a última ordem tem que ser 100% e do tipo percentual sobre a diferença
	-- Impossível liberar a ação da regra. Quando há apropriação de percentual sobre a diferença a última deve ser de 100% sem valor limite ou valor fixo.
	CALL wheb_mensagem_pck.exibir_mensagem_abort(310310);
end if;

if (qt_pr_df_w = 0 and qt_vl_fixo_w = 0 and qt_pr_w > 0 and pr_distribuicao_total_w <> 100) then
	-- Se tiver apenas regra de percentual (sobre valor geral), a soma deve bater 100%
	-- Impossível liberar a ação da regra. Para ação de percentual a soma dos percentuais deve ser 100%.
	CALL wheb_mensagem_pck.exibir_mensagem_abort(310311);
end if;

if (qt_perc_calc_apres_w > 0) and (qt_pr_df_w = 0) then
	-- Se tiver alguma regra calculando percentual sobre calculado ou apresentado, deve haver percentual sobre a diferença
	-- Impossível liberar a ação da regra. Deve haver ao menos uma apropriação com percentual sobre a diferença quando o percentual for sobre valor apresentado ou calculado
	CALL wheb_mensagem_pck.exibir_mensagem_abort(323442);
end if;

if (qt_geral_w = 0 and ie_acao_w not in ('N','RC')) then
	-- Se a quantidade de Apropriações da regra for igual a zero e a Ação da Regra estiver com o IE_ACAO diferente de 'N' (Não Reembolsar)
	-- Impossível liberar a ação da regra. Deve haver ao menos uma regra de apropriação quando a ação da regra for diferente de 'Não Reembolsar'.
	CALL wheb_mensagem_pck.exibir_mensagem_abort(333321);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consiste_regra_reemb_acao (nr_seq_regra_acao_p pls_regra_reemb_acao.nr_sequencia%type) FROM PUBLIC;

