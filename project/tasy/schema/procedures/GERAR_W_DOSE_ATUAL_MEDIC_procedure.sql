-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_dose_atual_medic ( nr_prescricao_p bigint, cd_estabelecimento_p bigint, cd_perfil_p text, nm_usuario_p text, ie_geracao_p INOUT text ) AS $body$
DECLARE

cd_estab_prescr_w		integer;
cd_intervalo_w			varchar(10);
cd_intervalo_padrao_w	varchar(10);
cd_material_w			bigint;
cd_pessoa_fisica_w		varchar(20);
cd_setor_atendimento_w	bigint;
cd_unid_med_dose_w		varchar(50);
cd_unid_med_padrao_w	varchar(50);
ds_dose_dif_w			varchar(50);
ds_dose_diferenciada_w	varchar(50);
ds_erro_w				varchar(4000);
ds_horarios_w			varchar(4000);
ds_horarios2_w			varchar(4000);
ds_forma_calculo_w 		varchar(100);
dt_inicio_medic_w		timestamp;
dt_inicio_prescr_w		timestamp;
dt_prescricao_w			timestamp;
hr_prim_horario_w		varchar(5);
i						numeric(30);
ie_acm_w				varchar(1);
ie_mesmo_zerado_w		varchar(3);
ie_origem_inf_w			varchar(1);
ie_prescr_mat_sem_lib_w	varchar(5);
ie_regra_disp_w			varchar(3);
ie_se_necessario_w		varchar(1);
ie_urgencia_w			varchar(1);
ie_via_aplicacao_w		varchar(5);
nr_atendimento_w		bigint;
nr_horas_validade_w		integer;
nr_ocorrencia_w			double precision;
nr_prescricao_orig_w	bigint;
nr_seq_material_w		bigint;
qt_altura_cm_w			double precision;
qt_conversao_dose_w		double precision;
qt_dia_prim_hor_w		bigint;
qt_dose_w				double precision;
qt_dose_padrao_w		double precision;
qt_espacos_horarios_w	bigint;
qt_hora_intervalo_w		integer;
qt_min_intervalo_w		integer;
qt_idade_w				double precision;
qt_material_w			double precision;
qt_peso_w				double precision;
qt_unitaria_w			double precision;
qt_total_dispensar_w	double precision;

C01 CURSOR FOR 
	SELECT	nr_sequencia, 
			qt_dose, 
			cd_unidade_medida_dose, 
			cd_intervalo, 
			Obter_padrao_param_prescr(nr_atendimento_w, cd_material, ie_via_aplicacao, cd_setor_atendimento_w, cd_pessoa_fisica_w, qt_idade_w, qt_peso_w, ie_se_necessario, 'D', cd_intervalo), 
			Obter_padrao_param_prescr(nr_atendimento_w, cd_material, ie_via_aplicacao, cd_setor_atendimento_w, cd_pessoa_fisica_w, qt_idade_w, qt_peso_w, ie_se_necessario, 'U', cd_intervalo), 
			Obter_padrao_param_prescr(nr_atendimento_w, cd_material, ie_via_aplicacao, cd_setor_atendimento_w, cd_pessoa_fisica_w, qt_idade_w, qt_peso_w, ie_se_necessario, 'I', cd_intervalo), 
			Obter_padrao_param_prescr(nr_atendimento_w, cd_material, ie_via_aplicacao, cd_setor_atendimento_w, cd_pessoa_fisica_w, qt_idade_w, qt_peso_w, ie_se_necessario, 'FC', cd_intervalo) 
	from	prescr_material 
	where	ie_agrupador = 1 
	and		nr_prescricao = nr_prescricao_p;
	
C02 CURSOR FOR 
	SELECT	nr_sequencia_anterior, 
			qt_nova_dose, 
			cd_unidade_med_nova, 
			cd_intervalo_novo 
	from	w_dose_atual_medic 
	where	ie_atualizar = 'S' 
	and		nm_usuario = nm_usuario_p 
	and		nr_prescricao_anterior = nr_prescricao_p 
	order by 1;
	

BEGIN 
 
select	max(nr_atendimento), 
		max(cd_pessoa_fisica), 
		coalesce(max(nr_prescricao_anterior), max(nr_prescricao_original)), 
		max(cd_setor_atendimento), 
		coalesce(max(nr_horas_validade),24), 
		max(dt_prescricao), 
		max(dt_inicio_prescr), 
		coalesce(max(cd_estabelecimento), cd_estabelecimento_p) 
into STRICT	nr_atendimento_w, 
		cd_pessoa_fisica_w, 
		nr_prescricao_orig_w, 
		cd_setor_atendimento_w, 
		nr_horas_validade_w, 
		dt_prescricao_w, 
		dt_inicio_prescr_w, 
		cd_estab_prescr_w 
from	prescr_medica 
where	nr_prescricao = nr_prescricao_p;
 
if (nr_prescricao_orig_w IS NOT NULL AND nr_prescricao_orig_w::text <> '') then 
	select	max(cd_pessoa_fisica) 
	into STRICT	cd_pessoa_fisica_w 
	from	prescr_medica 
	where	cd_pessoa_fisica = cd_pessoa_fisica_w 
	and		nr_prescricao = nr_prescricao_orig_w;
end if;
 
if (coalesce(cd_pessoa_fisica_w::text, '') = '') then 
	ie_geracao_p	:= 'N';
end if;
 
if (ie_geracao_p <> 'N') then 
	qt_peso_w		:= obter_dados_sv_atendimento('V', 'QT_PESO', nr_atendimento_w);
	qt_altura_cm_w	:= obter_dados_sv_atendimento('V', 'QT_ALTURA_CM', nr_atendimento_w);
 
	select	max(obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'DIA')) 
	into STRICT	qt_idade_w 
	from	pessoa_fisica b 
	where	b.cd_pessoa_fisica	= cd_pessoa_fisica_w;
 
	if (ie_geracao_p = 'S') then 
		delete	FROM w_dose_atual_medic 
		where	nm_usuario = nm_usuario_p 
		and		nr_prescricao_anterior = nr_prescricao_p;
		 
		ie_geracao_p	:= 'N';
		 
		open C01;
		loop 
		fetch C01 into	 
			nr_seq_material_w, 
			qt_dose_w, 
			cd_unid_med_dose_w, 
			cd_intervalo_w, 
			qt_dose_padrao_w, 
			cd_unid_med_padrao_w, 
			cd_intervalo_padrao_w, 
			ds_forma_calculo_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin 
			 
			if	((qt_dose_padrao_w IS NOT NULL AND qt_dose_padrao_w::text <> '') and (coalesce(qt_dose_w,0) <> coalesce(qt_dose_padrao_w,0))) or 
				((cd_unid_med_padrao_w IS NOT NULL AND cd_unid_med_padrao_w::text <> '') and (coalesce(cd_unid_med_dose_w,'XPTO') <> coalesce(cd_unid_med_padrao_w,'XPTO'))) or 
				((cd_intervalo_padrao_w IS NOT NULL AND cd_intervalo_padrao_w::text <> '') and (coalesce(cd_intervalo_w,'XPTO') <> coalesce(cd_intervalo_padrao_w,'XPTO'))) then 
				 
				ie_geracao_p	:= 'S';
				 
				insert into w_dose_atual_medic( 
								nr_sequencia, 
								dt_atualizacao, 
								nm_usuario, 
								qt_nova_dose, 
								cd_unidade_med_nova, 
								cd_intervalo_novo, 
								qt_dose_ant, 
								cd_unidade_med_ant, 
								cd_intervalo_ant, 
								ie_atualizar, 
								nr_prescricao_anterior, 
								nr_sequencia_anterior, 
								ds_forma_calculo 
							) values ( 
								nextval('w_dose_atual_medic_seq'), 
								clock_timestamp(), 
								nm_usuario_p, 
								qt_dose_padrao_w, 
								cd_unid_med_padrao_w, 
								cd_intervalo_padrao_w, 
								qt_dose_w, 
								cd_unid_med_dose_w, 
								cd_intervalo_w, 
								'N', 
								nr_prescricao_p, 
								nr_seq_material_w, 
								ds_forma_calculo_w);
			end if;
			 
			end;
		end loop;
		close C01;
	elsif (ie_geracao_p = 'A') then 
		ie_prescr_mat_sem_lib_w := Obter_Param_Usuario(924, 530, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_prescr_mat_sem_lib_w);
		qt_espacos_horarios_w := Obter_Param_Usuario(924, 1033, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, qt_espacos_horarios_w);
 
		open C02;
		loop 
		fetch C02 into	 
			nr_seq_material_w, 
			qt_dose_padrao_w, 
			cd_unid_med_padrao_w, 
			cd_intervalo_padrao_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin 
			 
			select	max(qt_dose), 
					max(cd_material), 
					max(nr_ocorrencia), 
					max(cd_unidade_medida_dose), 
					coalesce(max(ie_se_necessario),'N'), 
					coalesce(max(ie_acm),'N'), 
					max(ie_origem_inf), 
					max(ie_via_aplicacao), 
					max(cd_intervalo), 
					max(ds_dose_diferenciada), 
					max(qt_material), 
					max(qt_total_dispensar), 
					max(qt_conversao_dose), 
					max(ie_regra_disp), 
					max(hr_prim_horario), 
					coalesce(max(ie_urgencia),'N'), 
					max(ds_horarios), 
					coalesce(max(qt_hora_intervalo),0), 
					coalesce(max(qt_min_intervalo),0), 
					coalesce(max(qt_dia_prim_hor),0) 
			into STRICT	qt_dose_w, 
					cd_material_w, 
					nr_ocorrencia_w, 
					cd_unid_med_dose_w, 
					ie_se_necessario_w, 
					ie_acm_w, 
					ie_origem_inf_w, 
					ie_via_aplicacao_w, 
					cd_intervalo_w, 
					ds_dose_diferenciada_w, 
					qt_material_w, 
					qt_total_dispensar_w, 
					qt_conversao_dose_w, 
					ie_regra_disp_w, 
					hr_prim_horario_w, 
					ie_urgencia_w, 
					ds_horarios_w, 
					qt_hora_intervalo_w, 
					qt_min_intervalo_w, 
					qt_dia_prim_hor_w 
			from	prescr_material 
			where	nr_sequencia = nr_seq_material_w 
			and		nr_prescricao = nr_prescricao_p;
			 
			if (qt_dose_padrao_w IS NOT NULL AND qt_dose_padrao_w::text <> '') then 
				qt_dose_w			:= qt_dose_padrao_w;
			end if;
			 
			if (cd_unid_med_padrao_w IS NOT NULL AND cd_unid_med_padrao_w::text <> '') then 
				cd_unid_med_dose_w	:= cd_unid_med_dose_w;
			end if;
			 
			if (cd_intervalo_padrao_w IS NOT NULL AND cd_intervalo_padrao_w::text <> '') then 
				cd_intervalo_w		:= cd_intervalo_padrao_w;
				 
				if (ds_horarios_w not in ('ACM','SN')) then 
 
					select	max(obter_ocorrencia_intervalo(cd_intervalo_w, nr_horas_validade_w, 'O')) 
					into STRICT	nr_ocorrencia_w 
					;
					 
					if (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') and (hr_prim_horario_w <> ' : ') then 
						if (ie_urgencia_w = 'S') then 
							dt_inicio_medic_w 	:= to_date(to_char(dt_prescricao_w,'dd/mm/yyyy')||' '|| hr_prim_horario_w ||':00','dd/mm/yyyy hh24:mi:ss');
						else 
							dt_inicio_medic_w 	:= to_date(to_char(dt_inicio_prescr_w,'dd/mm/yyyy')||' '|| hr_prim_horario_w ||':00','dd/mm/yyyy hh24:mi:ss');
							 
							if (dt_inicio_medic_w < dt_inicio_prescr_w) then 
								dt_inicio_medic_w	:= dt_inicio_medic_w+1;
								qt_dia_prim_hor_w	:= 1;
							end if;
						end if;
					else 
						dt_inicio_medic_w	:= dt_inicio_prescr_w;
					end if;
					 
					update	prescr_material 
					set		cd_intervalo = cd_intervalo_w, 
							nr_ocorrencia = nr_ocorrencia_w, 
							qt_dia_prim_hor = qt_dia_prim_hor_w 
					where	nr_sequencia = nr_seq_material_w 
					and		nr_prescricao = nr_prescricao_p;
					commit;
					 
					SELECT * FROM Calcular_Horario_Prescricao(nr_prescricao_p, cd_intervalo_w, dt_inicio_prescr_w, dt_inicio_medic_w, nr_horas_validade_w, cd_material_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w, 'N', ds_dose_diferenciada_w) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w;
 
					ds_horarios_w	:= ds_horarios_w || ds_horarios2_w;
				end if;
			end if;
			 
			if (ie_se_necessario_w = 'S') then 
				select	coalesce(max(b.qt_se_necessario),0), 
						coalesce(max(b.ie_mesmo_zerado),'N') 
				into STRICT	nr_ocorrencia_w, 
						ie_mesmo_zerado_w 
				from	intervalo_prescricao a, 
						intervalo_setor b 
				where	a.cd_intervalo 		= b.cd_intervalo 
				and		coalesce(b.cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w 
				and		coalesce(b.cd_estab, cd_estab_prescr_w)			= cd_estab_prescr_w 
				and		a.cd_intervalo 		= cd_intervalo_w 
				and		((b.cd_material = cd_material_w) or (coalesce(b.cd_material::text, '') = '')) 
				and		((b.ie_via_aplicacao = coalesce(ie_via_aplicacao_w,b.ie_via_aplicacao)) or (coalesce(b.ie_via_aplicacao::text, '') = '')) 
				and		((b.cd_unidade_basica = coalesce(obter_unid_atend_setor_atual(nr_atendimento_w,cd_setor_atendimento_w,'UB'),b.cd_unidade_basica)) or (coalesce(b.cd_unidade_basica::text, '') = ''));
 
				if (coalesce(nr_ocorrencia_w,0) = 0) and (ie_mesmo_zerado_w = 'N') then 
					select	coalesce(max(qt_se_necessario),1) 
					into STRICT	nr_ocorrencia_w 
					from	intervalo_prescricao 
					where	cd_intervalo	= cd_intervalo_w;
				end if;
				 
				ds_horarios_w	:= 'SN';
 
			elsif (ie_acm_w = 'S') then 
				select	coalesce(max(b.qt_se_necessario),0), 
						coalesce(max(b.ie_mesmo_zerado),'N') 
				into STRICT	nr_ocorrencia_w, 
						ie_mesmo_zerado_w 
				from	intervalo_prescricao a, 
						intervalo_setor b 
				where	a.cd_intervalo 		= b.cd_intervalo 
				and		coalesce(b.cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w 
				and		coalesce(b.cd_estab, cd_estab_prescr_w)			= cd_estab_prescr_w 
				and		a.cd_intervalo 		= cd_intervalo_w 
				and		((b.cd_material = cd_material_w) or (coalesce(b.cd_material::text, '') = '')) 
				and		((b.ie_via_aplicacao = coalesce(ie_via_aplicacao_w,b.ie_via_aplicacao)) or (coalesce(b.ie_via_aplicacao::text, '') = '')) 
				and		((b.cd_unidade_basica = coalesce(obter_unid_atend_setor_atual(nr_atendimento_w,cd_setor_atendimento_w,'UB'),b.cd_unidade_basica)) or (coalesce(b.cd_unidade_basica::text, '') = ''));
				 
				if (coalesce(nr_ocorrencia_w,0) = 0) and (ie_mesmo_zerado_w = 'N') then 
			 
					select	coalesce(max(qt_se_necessario),1) 
					into STRICT	nr_ocorrencia_w 
					from	intervalo_prescricao 
					where	cd_intervalo	= cd_intervalo_w;
				end if;
 
				ds_horarios_w	:= 'ACM';
			end if;
			 
			if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then 
				ds_dose_dif_w	:= ds_dose_diferenciada_w;
				qt_material_w	:= 0;
				while (ds_dose_dif_w IS NOT NULL AND ds_dose_dif_w::text <> '') LOOP 
					begin 
					i	:= position('-' in ds_dose_dif_w);
					if (i > 0) then 
						qt_material_w		:= qt_material_w + (substr(ds_dose_dif_w, 1, i-1))::numeric;
						ds_dose_dif_w		:= substr(ds_dose_dif_w, i+1, 255);
					else 
						qt_material_w		:= qt_material_w + (ds_dose_dif_w)::numeric;
						ds_dose_dif_w		:= '';
					end if;
 
					end;
				end loop;
 
				qt_material_w	:= obter_conversao_unid_med_cons(cd_material_w,cd_unid_med_dose_w,qt_material_w);
			end if;
			 
			select	coalesce(max(qt_conversao),qt_conversao_dose_w) 
			into STRICT	qt_conversao_dose_w 
			from	unidade_medida_dose_v 
			where	cd_material			= cd_material_w 
			and		cd_unidade_medida	= cd_unid_med_dose_w;
			 
			begin 
			qt_unitaria_w	:= dividir(qt_dose_w, qt_conversao_dose_w);
			exception when others then 
			qt_unitaria_w	:= null;		
			end;
 
			ds_erro_w				:= null;
			 
			SELECT * FROM Obter_Quant_Dispensar(	cd_estabelecimento_p, cd_material_w, nr_prescricao_p, nr_seq_material_w, cd_intervalo_w, ie_via_aplicacao_w, qt_unitaria_w, 0, nr_ocorrencia_w, ds_dose_diferenciada_w, ie_origem_inf_w, cd_unid_med_dose_w, 1, qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w;
			 
			update	prescr_material 
			set 	ie_se_necessario	= ie_se_necessario_w, 
					ie_acm				= ie_acm_w, 
					ie_urgencia			= ie_urgencia_w, 
					ds_horarios			= ds_horarios_w, 
					cd_intervalo		= cd_intervalo_w, 
					qt_dose				= qt_dose_w, 
					nr_ocorrencia		= nr_ocorrencia_w, 
					qt_material			= coalesce(qt_material_w,1), 
					qt_total_dispensar	= qt_total_dispensar_w, 
					ie_regra_disp		= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END , 
					qt_unitaria			= coalesce(qt_unitaria_w, qt_unitaria), 
					qt_conversao_dose	= qt_conversao_dose_w 
			where	nr_sequencia		= nr_seq_material_w 
			and		nr_prescricao 		= nr_prescricao_p;
			end;
			 
			begin 
			CALL Ajustar_Prescr_Material(nr_prescricao_p, nr_seq_material_w);
			exception when others then 
				ds_erro_w	:= sqlerrm;
			end;
			 
			ds_erro_w := consistir_prescr_material( nr_prescricao_p, nr_seq_material_w, nm_usuario_p, cd_perfil_p, ds_erro_w);
		 
			commit;
			 
			if (ie_prescr_mat_sem_lib_w = 'S') then 
				CALL Gerar_prescr_mat_sem_dt_lib(nr_prescricao_p, nr_seq_material_w, cd_perfil_p, 'N', nm_usuario_p, null, null);
			end if;		
		end loop;
		close C02;
		 
		ie_geracao_p	:= 'N';
	end if;
end if;
 
if (ie_geracao_p = 'N') then 
	delete	FROM w_dose_atual_medic 
	where	nm_usuario = nm_usuario_p 
	and		nr_prescricao_anterior = nr_prescricao_p;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_dose_atual_medic ( nr_prescricao_p bigint, cd_estabelecimento_p bigint, cd_perfil_p text, nm_usuario_p text, ie_geracao_p INOUT text ) FROM PUBLIC;

