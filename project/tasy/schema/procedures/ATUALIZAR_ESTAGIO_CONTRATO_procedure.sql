-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_estagio_contrato ( nr_sequencia_p bigint, ie_estagio_p text, nm_usuario_p text) AS $body$
DECLARE


ds_estagio_anterior_w    varchar(255);
ds_estagio_atual_w    varchar(255);
nr_seq_historico_w    bigint;
ds_historico_w      varchar(4000);
ds_titulo_w      varchar(255);
ie_cancelar_titulo_w    varchar(1);
cd_estabelecimento_w    contrato.cd_estabelecimento%type;
nr_seq_aprovacao_w    contrato.nr_seq_aprovacao%type;
dt_aprovacao_w      contrato.dt_aprovacao%type;


BEGIN

select  coalesce(obter_valor_dominio(5200,ie_estagio),wheb_mensagem_pck.get_texto(303587)), -- Nao definido
  coalesce(obter_valor_dominio(5200,ie_estagio_p),wheb_mensagem_pck.get_texto(303587)), -- Nao definido
  cd_estabelecimento,
  nr_seq_aprovacao,
  dt_aprovacao
into STRICT  ds_estagio_anterior_w,
  ds_estagio_atual_w,
  cd_estabelecimento_w,
  nr_seq_aprovacao_w,
  dt_aprovacao_w
from  contrato
where  nr_sequencia = nr_sequencia_p;

-- Se estiver em processo de aprovacao, nao permitir mudar o estagio
if (nr_seq_aprovacao_w IS NOT NULL AND nr_seq_aprovacao_w::text <> '') and (coalesce(dt_aprovacao_w::text, '') = '') and (ie_estagio_p in ('C','E')) then
  CALL wheb_mensagem_pck.exibir_mensagem_abort(1170670);
end if;

if (ie_estagio_p = 'E') then
  begin

  update  contrato
  set  ie_estagio   = ie_estagio_p,
    dt_encerramento  = clock_timestamp(),
    nm_usuario_encer  = nm_usuario_p,
    ie_situacao  = 'I',
    dt_atualizacao  = clock_timestamp(),
    nm_usuario  = nm_usuario_p
  where  nr_sequencia  = nr_sequencia_p;

  ds_titulo_w :=  wheb_mensagem_pck.get_texto(303587); -- 303588
  /*Realizado o encerramento do contrato pelo usuario #@NM_USUARIO_P#@.
  Estagio anterior: #@DS_ESTAGIO_ANTERIOR_W#@.
  Estagio atual: #@DS_ESTAGIO_ATUAL_W#@.*/
  ds_historico_w :=  substr(wheb_mensagem_pck.get_texto(303594,   'NM_USUARIO_P=' || nm_usuario_p ||
                    ';DS_ESTAGIO_ANTERIOR_W=' || ds_estagio_anterior_w ||
                    ';DS_ESTAGIO_ATUAL_W=' || ds_estagio_atual_w),1,4000);

  ie_cancelar_titulo_w := obter_param_usuariO(1200, 143, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_cancelar_titulo_w);

  if (coalesce(ie_cancelar_titulo_w,'N')  = 'S') then

    CALL cancelar_titulo_contrato(nr_sequencia_p,nm_usuario_p);

  end if;

  end;
else
  begin

  update  contrato
  set  ie_estagio   = ie_estagio_p,
    nm_usuario  = nm_usuario_p,
    dt_atualizacao  = clock_timestamp()
  where  nr_sequencia  = nr_sequencia_p;

  ds_titulo_w :=  wheb_mensagem_pck.get_texto(303595); -- Alteracao de estagio do contrato
  /*Realizada a alteracao de estagio do contrato pelo usuario #@NM_USUARIO_P#@.
  Anterior: #@DS_ESTAGIO_ANTERIOR_W#@.
  Atual: #@DS_ESTAGIO_ATUAL_W#@.*/
  ds_historico_w :=  substr(wheb_mensagem_pck.get_texto(303596,  'NM_USUARIO_P=' || nm_usuario_p ||
                    ';DS_ESTAGIO_ANTERIOR_W=' || ds_estagio_anterior_w ||
                    ';DS_ESTAGIO_ATUAL_W=' || ds_estagio_atual_w),1,4000);

  end;
end if;

select  nextval('contrato_historico_seq')
into STRICT  nr_seq_historico_w
;

insert into contrato_historico(
  nr_sequencia,
  nr_seq_contrato,
  dt_historico,
  ds_historico,
  dt_atualizacao,
  nm_usuario,
  ds_titulo,
  dt_liberacao,
  nm_usuario_lib,
  ie_efetivado) values (
    nr_seq_historico_w,
    nr_sequencia_p,
    clock_timestamp(),
    ds_historico_w,
    clock_timestamp(),
    nm_usuario_p,
    ds_titulo_w,
    clock_timestamp(),
    nm_usuario_p,
      'N');

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_estagio_contrato ( nr_sequencia_p bigint, ie_estagio_p text, nm_usuario_p text) FROM PUBLIC;

