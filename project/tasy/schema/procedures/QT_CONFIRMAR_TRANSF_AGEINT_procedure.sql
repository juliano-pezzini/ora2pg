-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qt_confirmar_transf_ageint ( nr_seq_ageint_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_atendimento_w	bigint;
nr_seq_paciente_w	bigint;
cd_pessoa_fisica_w	varchar(10);
dt_agenda_w		timestamp;
nr_seq_local_w		bigint;
nr_duracao_w		bigint;
nr_seq_marcacao_w	bigint;
nr_seq_prof_w		bigint;
ie_tipo_agendamento_w	varchar(15);
qt_gerado_w		bigint;
nr_minuto_duracao_w     bigint;
nr_seq_ageint_item_w	bigint;
nr_seq_item_marc_w	bigint;
nr_seq_mot_transf_w	bigint;
nr_seq_atendimento_ww	bigint;
nr_seq_agenda_w         bigint;
qt_marcacao_w		bigint;
ie_consist_outro_agen_w		varchar(1);
ie_limpar_campo_quimio  varchar(1);
ds_bloq_trat_quimio_w	paciente_atendimento.ds_bloq_trat_quimio%type;
nr_seq_motivo_bloq_w	paciente_atendimento.nr_seq_motivo_bloq%type;

C01 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.dt_agenda,
		a.nr_seq_local,
		a.nr_duracao,
		a.nr_seq_prof,
		a.ie_tipo_agendamento,
		c.cd_pessoa_fisica,
		b.nr_sequencia,
		a.nr_seq_ageint_item
	from	agenda_quimio_marcacao a,
		agenda_integrada_item b,
		agenda_integrada c
	where	c.nr_sequencia		= nr_seq_ageint_p
	and	b.nr_sequencia		= a.nr_seq_ageint_item
	and	b.nr_seq_agenda_int	= c.nr_sequencia
	and	a.ie_gerado		= 'N'
	and	a.ie_transferencia	= 'S';

  C02 CURSOR FOR
	SELECT	a.nr_sequencia,
    a.dt_agenda,
		a.nr_seq_local,
		a.nr_duracao,
		a.nr_seq_atendimento,
    b.nr_minuto_duracao
  from	agenda_quimio_marcacao a,
    agenda_integrada_item b,
    agenda_integrada c
	where	c.nr_sequencia		= nr_seq_ageint_p
	and	b.nr_sequencia		= a.nr_seq_ageint_item
	and	b.nr_seq_agenda_int	= c.nr_sequencia
  and a.nm_usuario 	= nm_usuario_p
  order by dt_agenda;


BEGIN

ie_consist_outro_agen_w := obter_param_usuario(865, 237, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_consist_outro_agen_w);
ie_limpar_campo_quimio := obter_param_usuario(865, 245, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_limpar_campo_quimio);

select	max(nr_sequencia)
into STRICT	nr_seq_mot_transf_w
from	qt_motivo_reagendamento;

if (ie_consist_outro_agen_w = 'S') then
  open C02;
	loop
	fetch C02 into
    nr_seq_agenda_w,
		dt_agenda_w,
		nr_seq_local_w,
		nr_duracao_w,
		nr_seq_atendimento_ww,
    nr_minuto_duracao_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		select	count(*)
		into STRICT	qt_marcacao_w
		from	agenda_quimio_marcacao a
		where  ((dt_agenda_w between dt_agenda and dt_agenda + (nr_duracao - 1) / 1440)
		or	(dt_agenda_w + (nr_duracao_w - 1) / 1440 between dt_agenda and dt_agenda + (nr_duracao - 1) / 1440)
		or	(dt_agenda between dt_agenda_w and dt_agenda_w + (nr_duracao_w - 1) / 1440)
		or	(dt_agenda + (nr_duracao - 1) / 1440 between dt_agenda_w and dt_agenda_w + (nr_duracao_w - 1) / 1440)
		or      (dt_agenda_w between dt_agenda and dt_agenda + (nr_minuto_duracao_w - 1) / 1440)
		or	(dt_agenda_w + (nr_minuto_duracao_w - 1) / 1440 between dt_agenda and dt_agenda + (nr_minuto_duracao_w - 1) / 1440)
		or	(dt_agenda between dt_agenda_w and dt_agenda_w + (nr_minuto_duracao_w - 1) / 1440)
		or	(dt_agenda + (nr_minuto_duracao_w - 1) / 1440 between dt_agenda_w and dt_agenda_w + (nr_minuto_duracao_w - 1) / 1440))
		and 	nr_seq_agenda	<> nr_seq_agenda_w
		and	nr_seq_local	= nr_seq_local_w
		and (coalesce(ie_gerado, 'X')	= 'N'
		or (coalesce(ie_gerado, 'X')	= 'S'
		and	(a.nr_seq_pend_agenda IS NOT NULL AND a.nr_seq_pend_agenda::text <> '')
		and	not exists (	SELECT	1
					from 	agenda_quimio x
					where 	a.nr_seq_atendimento = x.nr_seq_atendimento
					and	a.nr_seq_pend_agenda = x.nr_seq_pend_agenda
					and	trunc(x.dt_agenda)   = trunc(a.dt_Agenda)
					and	x.ie_status_agenda in ('F','S','C')) ));


		if (coalesce(qt_marcacao_w,0) = 0) then

			select	count(*)
			into STRICT	qt_marcacao_w
			from	agenda_quimio
			where	((dt_agenda_w between dt_agenda and dt_agenda + (nr_minuto_duracao - 1) / 1440)
			or	(dt_agenda_w + (nr_duracao_w - 1) / 1440 between dt_agenda and dt_agenda + (nr_minuto_duracao - 1) / 1440)
			or	(dt_agenda between dt_agenda_w and dt_agenda_w + (nr_duracao_w - 1) / 1440)
			or	(dt_agenda + (nr_minuto_duracao - 1) / 1440 between dt_agenda_w and dt_agenda_w + (nr_duracao_w - 1) / 1440)
			or      (dt_agenda_w between dt_agenda and dt_agenda + (nr_minuto_duracao_w - 1) / 1440)
			or	(dt_agenda_w + (nr_minuto_duracao_w - 1) / 1440 between dt_agenda and dt_agenda + (nr_minuto_duracao_w - 1) / 1440)
			or	(dt_agenda between dt_agenda_w and dt_agenda_w + (nr_minuto_duracao_w - 1) / 1440)
			or	(dt_agenda + (nr_minuto_duracao_w - 1) / 1440 between dt_agenda_w and dt_agenda_w + (nr_minuto_duracao_w - 1) / 1440))
			and 	nr_sequencia	<> nr_seq_agenda_w
			and	nr_seq_local	= nr_seq_local_w
			and	ie_status_agenda	not in ('F','S','C');


		end if;

		if (coalesce(qt_marcacao_w,0) > 0) then

			CALL Wheb_mensagem_pck.exibir_mensagem_abort(243336,'DT_DIAS='||dt_agenda_w|| ';QT_TEMPO=' || to_char(nr_minuto_duracao_w));

			if (ie_limpar_campo_quimio = 'S')	then --OS 620565
				select	max(ds_bloq_trat_quimio),
						max(nr_seq_motivo_bloq)
				into STRICT	ds_bloq_trat_quimio_w,
						nr_seq_motivo_bloq_w
				from	paciente_atendimento
				where	nr_seq_atendimento = nr_seq_atendimento_ww;

				if (ds_bloq_trat_quimio_w IS NOT NULL AND ds_bloq_trat_quimio_w::text <> '') and (nr_seq_motivo_bloq_w IS NOT NULL AND nr_seq_motivo_bloq_w::text <> '')then

				update	paciente_atendimento
				set		ds_bloq_trat_quimio 	 = NULL,
						nr_seq_motivo_bloq 	 = NULL
				where	nr_seq_atendimento 		= nr_seq_atendimento_ww;
			end if;

		end if;

		end if;
		end;
	end loop;
	close C02;
else
  open C01;
  loop
  fetch C01 into
    nr_seq_marcacao_w,
    dt_agenda_w,
    nr_seq_local_w,
    nr_duracao_w,
    nr_seq_prof_w,
    ie_tipo_agendamento_w,
    cd_pessoa_fisica_w,
    nr_seq_ageint_item_w,
    nr_seq_item_marc_w;
  EXIT WHEN NOT FOUND; /* apply on C01 */
    begin
    /* excluir marcacao anterior */

    delete	FROM agenda_quimio_marcacao
    where	nr_seq_ageint_item	= nr_seq_ageint_item_w
    and	nr_seq_ageint_item	= nr_seq_item_marc_w
    and	ie_gerado		= 'S'
    and	ie_transferencia	= 'N';
    /* update novo horario */

    select	count(1)
    into STRICT	qt_gerado_w
    from	agenda_quimio
    where	nr_seq_ageint_item	= nr_seq_ageint_item_w;

    if (qt_gerado_w	> 0) then
      update	agenda_quimio
      set	dt_agenda		= dt_agenda_w,
        nr_seq_local		= nr_seq_local_w,
        nr_seq_prof		= nr_seq_prof_w,
        nm_usuario		= nm_usuario_p,
        dt_Atualizacao		= clock_timestamp(),
        nr_seq_mot_reagendamento	= nr_seq_mot_transf_w
      where	nr_seq_ageint_item	= nr_seq_ageint_item_w;
    else
      insert into agenda_quimio(nr_sequencia,
        dt_atualizacao,
        nm_usuario,
        dt_atualizacao_nrec,
        nm_usuario_nrec,
        cd_pessoa_fisica,
        nr_seq_prof,
        nr_seq_local,
        nr_minuto_duracao,
        dt_agenda,
        ie_tipo_pend_agenda,
        ie_status_agenda,
        ie_tipo_agendamento,
        nr_seq_ageint_item,
        nr_seq_mot_reagendamento)
      values (nextval('agenda_quimio_seq'),
        clock_timestamp(),
        nm_usuario_p,
        clock_timestamp(),
        nm_usuario_p,
        cd_pessoa_fisica_w,
        nr_seq_prof_w,
        nr_seq_local_w,
        nr_duracao_w,
        dt_agenda_w,
        'Q',
        'N',
        ie_tipo_agendamento_w,
        nr_seq_ageint_item_w,
        nr_seq_mot_transf_w);		
    end if;

    update	agenda_integrada_item
    set	dt_prevista_quimio = coalesce(dt_prev_transf_quimio,dt_prevista_quimio),
      dt_prev_transf_quimio  = NULL
    where	nr_sequencia = nr_seq_ageint_item_w;

    /* alterar marcacao horario transferencia = 'N' */

    update	agenda_quimio_marcacao
    set	ie_gerado		= 'S',
      ie_transferencia	= 'N',
      nr_seq_prof		= nr_seq_prof_w,
      nr_seq_local		= nr_seq_local_w
    where	nr_sequencia		= nr_seq_marcacao_w;
    end;
  end loop;
  close C01;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qt_confirmar_transf_ageint ( nr_seq_ageint_p bigint, nm_usuario_p text) FROM PUBLIC;

