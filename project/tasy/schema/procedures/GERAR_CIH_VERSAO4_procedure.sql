-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cih_versao4 (nr_seq_lote_p bigint, ie_consiste_municipio_ibge_p text, ie_gerar_atend_sem_alta_uti_p text, ie_restringer_estab_atend_p text, ie_gerar_pac_cronico_p text, ds_motivo_alta_p text, ie_gera_atend_lote_p text, ds_versao_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
IE_SOMENTE_INTERNADO_w		varchar(1);
IE_GERAR_CONSISTENTES_w		varchar(1);
IE_RETIRAR_DIA_UTI_w		varchar(1);
DT_INICIO_INTERNACAO_w		timestamp;
DT_FIM_INTERNACAO_w		timestamp;
CD_ESTABELECIMENTO_w		integer;
QT_HORAS_INTERNADOS_w		smallint;
IE_TIPO_REG_INTERFACE_w		smallint;
nm_paciente_w			varchar(60);
nm_logradouro_w			varchar(25);
nr_endereco_w			varchar(5);
ds_complemento_w		varchar(15);
cd_municipio_ibge_w		varchar(6);
sg_estado_paciente_w		compl_pessoa_fisica.sg_estado%type;
cd_cep_w			varchar(8);
dt_nascimento_w			timestamp;
ie_sexo_w			varchar(1);
cd_cns_w			varchar(20);
cd_procedimento_w		bigint;
cd_cid_primario_w		varchar(10);
cd_cid_secundario_w		varchar(10);
dt_entrada_w			timestamp;
dt_alta_w			timestamp;
cd_motivo_alta_w		bigint;
ie_fonte_remuner2_w		varchar(1);
ds_procedimento_w		varchar(40);
cd_ans_w			varchar(6);
cd_cnpj_conv_w			varchar(14);
cd_usuario_convenio_w		varchar(30);
nr_declaracao_obito_w		varchar(11);
qt_filhos_vivos_w		smallint;
doc_nasc1_w			varchar(11);
doc_nasc2_w			varchar(11);
doc_nasc3_w			varchar(11);
doc_nasc4_w			varchar(11);
doc_nasc5_w			varchar(11);
qt_dias_int_uti_w		smallint;
nr_prontuario_w			bigint;
nr_atendimento_w		bigint;
dt_competencia_w		timestamp;
CD_CNES_w			integer;
ie_opcao_cid_w			varchar(1);
var_ignorar_clinicas_w		varchar(255) := coalesce(obter_valor_param_usuario(8009, 16, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p),'0');
var_tipo_convenio_w		varchar(255) := coalesce(obter_valor_param_usuario(8009, 18, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p),'0');
ie_zeros_esq_cep_w		varchar(1);
ie_tipo_convenio_w		smallint;
ie_consistente_w		varchar(1);

c01 CURSOR FOR 
SELECT a.ie_tipo_reg_interface,  
	substr(nm_paciente,1,60), 
	substr(nm_logradouro,1,25), 
	substr(nr_endereco,1,5), 
	substr(ds_complemento,1,15), 
	substr(cd_municipio_ibge,1,6), 
	substr(sg_estado_paciente,1,2), 
	CASE WHEN ie_zeros_esq_cep_w='S' THEN  substr(lpad(replace(cd_cep,' ',''),8,'0'),1,8)  ELSE substr(cd_cep,1,8) END , 
	dt_nascimento, 
	substr(ie_sexo,1,1), 
	substr(cd_cns,1,15), 
	(substr(cd_procedimento,1,15))::numeric , 
	substr(cd_cid_primario,1,10), 
	substr(cd_cid_secundario,1,10), 
	dt_entrada, 
	dt_alta, 
	(substr(cd_motivo_alta,1,10))::numeric , 
	substr(ie_fonte_remuner2,1,1), 
	substr(ds_procedimento,1,40), 
	CASE WHEN ie_fonte_remuner2=1 THEN  substr(cd_ans,1,6)  ELSE null END , 
	CASE WHEN ie_fonte_remuner2=2 THEN  null WHEN ie_fonte_remuner2=3 THEN  null  ELSE CASE WHEN coalesce(a.cd_internacional::text, '') = '' THEN  CASE WHEN Obter_Valor_Conv_Estab(cd_convenio,cd_estabelecimento,'IE_CGC_CIH')='S' THEN a.cd_cnpj  ELSE null END   ELSE substr(obter_cgc_estabelecimento(cd_estabelecimento),1,14) END  END  cd_cnpj_conv, 
	CASE WHEN ie_fonte_remuner2=2 THEN  null WHEN ie_fonte_remuner2=3 THEN  null WHEN ie_fonte_remuner2=9 THEN  null  ELSE coalesce(substr(cd_usuario_convenio,1,30), '000000000000000000000000000000') END , 
	substr(nr_declaracao_obito,1,11), 
	(substr(qt_filhos_vivos,1,1))::numeric , 
	substr(doc_nasc1,1,11), 
	substr(doc_nasc2,1,11), 
	substr(doc_nasc3,1,11), 
	substr(doc_nasc4,1,11), 
	substr(doc_nasc5,1,11), 
	(substr(CASE WHEN ie_retirar_dia_uti_w='S' THEN cih_obter_dias_internacao_uti(dt_entrada, dt_alta, qt_dias_uti)  ELSE a.qt_dias_uti END ,1,3))::numeric  qt_dias_int_uti, 
	nr_prontuario, 
	dt_competencia, 
	a.nr_atendimento, 
	substr(cih_obter_se_cid_comp_opcao(a.cd_procedimento, a.ie_origem_proced, a.cd_cid_primario, ie_opcao_cid_w),1,1) 
from	sus_cih_2008_v a 
where (ie_tipo_atendimento = 1 or ie_somente_internado_w = 'N') 
and	dt_competencia between dt_inicio_internacao_w and fim_dia(dt_fim_internacao_w) 
and	(((cih_obter_horas_internacao(nr_atendimento) > qt_horas_internados_w) or (obter_se_motivo_alta_obito(cd_motivo_alta)= 'S')) or (qt_horas_internados_w = 0)) 
and 	(((dt_nascimento IS NOT NULL AND dt_nascimento::text <> '') and 
	(cd_procedimento IS NOT NULL AND cd_procedimento::text <> '') and 
	(cd_cid_primario IS NOT NULL AND cd_cid_primario::text <> '') and 
	(cd_municipio IS NOT NULL AND cd_municipio::text <> '') and 
	(nm_logradouro IS NOT NULL AND nm_logradouro::text <> '') and 
	(sg_estado_paciente IS NOT NULL AND sg_estado_paciente::text <> '') and 
	(ie_sexo IS NOT NULL AND ie_sexo::text <> '') and 
	(cd_cep IS NOT NULL AND cd_cep::text <> '') and (length(cd_cep) >= 8) and (cih_obter_se_cid_comp_opcao(a.cd_procedimento, a.ie_origem_proced, a.cd_cid_primario, ie_opcao_cid_w) = 'S') and 
	((coalesce(cd_cid_secundario::text, '') = '') or (cih_obter_se_cid_comp_opcao(a.cd_procedimento, a.ie_origem_proced, a.cd_cid_secundario, ie_opcao_cid_w) = 'S'))) or ( ie_gerar_consistentes_w = 'N')) 
and	ie_tipo_reg_interface = 2 
and	((a.cd_estabelecimento = cd_estabelecimento_p) or (ie_restringer_estab_atend_p = 'N'))		 
and	((ie_alta_uti = 'N') or (ie_gerar_atend_sem_alta_uti_p = 'N')) 
and	((cd_municipio_ibge IS NOT NULL AND cd_municipio_ibge::text <> '') or (ie_consiste_municipio_ibge_p = 'N')) 
and (obter_se_contido_char(cd_motivo_alta, ds_motivo_alta_p) ='N') 
and	((ie_gera_atend_lote_p = 'S') or (not exists (SELECT 1 from lote_cih_item x where x.nr_atendimento = a.nr_atendimento))) 
and	((var_ignorar_clinicas_w = '0') or (obter_se_contido_char(obter_clinica_atend(a.nr_atendimento,'C'), var_ignorar_clinicas_w) = 'N')) 
and	((var_tipo_convenio_w = '0') or (obter_se_contido_char(obter_tipo_convenio(a.cd_convenio), var_tipo_convenio_w) = 'N'))	 	 
and (cih_obter_se_atend_regra(a.nr_atendimento, a.cd_convenio) = 'S') 
and	((obter_tipo_convenio(a.cd_convenio)	= ie_tipo_convenio_w) or (ie_tipo_convenio_w	= 0)) 

union
 
select a.ie_tipo_reg_interface,  
	substr(nm_paciente,1,60), 
	substr(nm_logradouro,1,25), 
	substr(nr_endereco,1,5), 
	substr(ds_complemento,1,15), 
	substr(cd_municipio_ibge,1,6), 
	substr(sg_estado_paciente,1,2), 
	CASE WHEN ie_zeros_esq_cep_w='S' THEN  substr(lpad(replace(cd_cep,' ',''),8,'0'),1,8)  ELSE substr(cd_cep,1,8) END , 
	dt_nascimento, 
	ie_sexo, 
	substr(cd_cns,1,15), 
	cd_procedimento, 
	cd_cid_primario, 
	cd_cid_secundario, 
	dt_entrada, 
	coalesce(dt_alta, dt_fim_internacao_w) dt_alta, 
	coalesce(a.cd_motivo_alta, '21') cd_motivo_alta, 
	ie_fonte_remuner2, 
	substr(ds_procedimento,1,40), 
	CASE WHEN ie_fonte_remuner2=1 THEN  substr(cd_ans,1,6)  ELSE null END , 
	CASE WHEN ie_fonte_remuner2=2 THEN  null WHEN ie_fonte_remuner2=3 THEN  null  ELSE CASE WHEN coalesce(a.cd_internacional::text, '') = '' THEN  CASE WHEN Obter_Valor_Conv_Estab(cd_convenio,cd_estabelecimento,'IE_CGC_CIH')='S' THEN a.cd_cnpj  ELSE null END   ELSE substr(obter_cgc_estabelecimento(cd_estabelecimento),1,14) END  END  cd_cnpj_conv, 
	CASE WHEN ie_fonte_remuner2=2 THEN  null WHEN ie_fonte_remuner2=3 THEN  null WHEN ie_fonte_remuner2=9 THEN  null  ELSE coalesce(substr(cd_usuario_convenio,1,30), '000000000000000000000000000000') END , 
	nr_declaracao_obito, 
	qt_filhos_vivos, 
	doc_nasc1, 
	doc_nasc2, 
	doc_nasc3, 
	doc_nasc4, 
	doc_nasc5, 
	CASE WHEN  ie_retirar_dia_uti_w='S' THEN cih_obter_dias_internacao_uti(dt_entrada, dt_alta, qt_dias_uti)  ELSE a.qt_dias_uti END  qt_dias_int_uti, 
	nr_prontuario, 
	x.dt_inicio, 
	a.nr_atendimento, 
	cih_obter_se_cid_comp_opcao(a.cd_procedimento, a.ie_origem_proced, a.cd_cid_primario, ie_opcao_cid_w) 
from	atend_pac_cronico x, 
	sus_cih_2008_v a 
where	x.nr_atendimento	= a.nr_atendimento 
and (ie_tipo_atendimento	= 1 or 
	 ie_somente_internado_w = 'N') 
--and	x.dt_inicio between dt_inicio_internacao_w and fim_dia(dt_fim_internacao_w) 
and	coalesce(a.dt_alta::text, '') = '' 
and	(((cih_obter_horas_internacao(a.nr_atendimento) > qt_horas_internados_w) or (obter_se_motivo_alta_obito(cd_motivo_alta)= 'S')) or (qt_horas_internados_w = 0)) 
and 	(((dt_nascimento IS NOT NULL AND dt_nascimento::text <> '') and 
	(cd_procedimento IS NOT NULL AND cd_procedimento::text <> '') and 
	(cd_cid_primario IS NOT NULL AND cd_cid_primario::text <> '') and 
	(cd_municipio IS NOT NULL AND cd_municipio::text <> '') and 
	(nm_logradouro IS NOT NULL AND nm_logradouro::text <> '') and 
	(sg_estado_paciente IS NOT NULL AND sg_estado_paciente::text <> '') and 
	(ie_sexo IS NOT NULL AND ie_sexo::text <> '') and 
	(cd_cep IS NOT NULL AND cd_cep::text <> '') and (length(cd_cep)		>= 8) and (cih_obter_se_cid_comp_opcao(a.cd_procedimento, a.ie_origem_proced, a.cd_cid_primario, ie_opcao_cid_w) = 'S') and 
	((coalesce(cd_cid_secundario::text, '') = '') or (cih_obter_se_cid_comp_opcao(a.cd_procedimento, a.ie_origem_proced, a.cd_cid_secundario, ie_opcao_cid_w) = 'S'))) or ( ie_gerar_consistentes_w = 'N')) 
and	ie_tipo_reg_interface	= 2 
and	((a.cd_estabelecimento	= cd_estabelecimento_p) or (ie_restringer_estab_atend_p	= 'N'))		 
and	((ie_alta_uti		= 'N') or (ie_gerar_atend_sem_alta_uti_p	= 'N')) 
and	((cd_municipio_ibge IS NOT NULL AND cd_municipio_ibge::text <> '') or (ie_consiste_municipio_ibge_p	= 'N')) 
and (obter_se_contido_char(cd_motivo_alta, ds_motivo_alta_p) = 'N') 
and	ie_gerar_pac_cronico_p	= 'S' 
and	((ie_gera_atend_lote_p = 'S') or (not exists (select 1 from lote_cih_item x where x.nr_atendimento = a.nr_atendimento))) 
and	((var_ignorar_clinicas_w = '0') or (obter_se_contido_char(obter_clinica_atend(a.nr_atendimento,'C'), var_ignorar_clinicas_w) = 'N')) 
and	((var_tipo_convenio_w = '0') or (obter_se_contido_char(obter_tipo_convenio(a.cd_convenio), var_tipo_convenio_w) = 'N'))	 	 
and (cih_obter_se_atend_regra(a.nr_atendimento, a.cd_convenio) = 'S') 
and	((obter_tipo_convenio(a.cd_convenio)	= ie_tipo_convenio_w) or (ie_tipo_convenio_w	= 0));

BEGIN
 
delete FROM lote_cih_item 
where nr_seq_lote = nr_seq_lote_p;
 
ie_opcao_cid_w := Obter_param_Usuario(8009, 15, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_opcao_cid_w);
ie_zeros_esq_cep_w := Obter_param_Usuario(8009, 17, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_zeros_esq_cep_w);
 
select	max(IE_SOMENTE_INTERNADO), 
	max(IE_GERAR_CONSISTENTES), 
	max(IE_RETIRAR_DIA_UTI), 
	max(DT_INICIO_INTERNACAO), 
	max(DT_FIM_INTERNACAO), 
	max(CD_ESTABELECIMENTO), 
	max(QT_HORAS_INTERNADOS), 
	coalesce(max(ie_tipo_convenio),0) 
into STRICT	IE_SOMENTE_INTERNADO_w, 
	IE_GERAR_CONSISTENTES_w, 
	IE_RETIRAR_DIA_UTI_w, 
	DT_INICIO_INTERNACAO_w, 
	DT_FIM_INTERNACAO_w, 
	CD_ESTABELECIMENTO_w, 
	QT_HORAS_INTERNADOS_w, 
	ie_tipo_convenio_w 
from 	lote_cih 
where	nr_sequencia = nr_seq_lote_p;
 
select 	coalesce(max(somente_numero(CD_CNES)),0) 
into STRICT	CD_CNES_w 
from 	sus_cih_2008_v a 
where 	ie_tipo_reg_interface = 1 
and (a.cd_estabelecimento = cd_estabelecimento_p);
 
insert into LOTE_CIH_ITEM(nr_sequencia, 
		nr_seq_lote, 
		ie_tipo_reg_interface, 
		DS_VERSAO_INTERFACE, 
		DT_ATUALIZACAO, 
		NM_USUARIO, 
		DT_ATUALIZACAO_NREC, 
		NM_USUARIO_NREC, 
		CD_CNES) 
	values (nextval('lote_cih_item_seq'), 
		nr_seq_lote_p, 
		1, 
		'4.0.0.0', 
		clock_timestamp(), 
		NM_USUARIO_p, 
		clock_timestamp(), 
		NM_USUARIO_p, 
		CD_CNES_w);
 
OPEN C01;
LOOP 
FETCH C01 into 
	ie_tipo_reg_interface_w, 
	nm_paciente_w, 
	nm_logradouro_w, 
	nr_endereco_w, 
	ds_complemento_w, 
	cd_municipio_ibge_w, 
	sg_estado_paciente_w, 
	cd_cep_w, 
	dt_nascimento_w, 
	ie_sexo_w, 
	cd_cns_w, 
	cd_procedimento_w, 
	cd_cid_primario_w, 
	cd_cid_secundario_w, 
	dt_entrada_w, 
	dt_alta_w, 
	cd_motivo_alta_w, 
	ie_fonte_remuner2_w, 
	ds_procedimento_w, 
	cd_ans_w, 
	cd_cnpj_conv_w, 
	cd_usuario_convenio_w, 
	nr_declaracao_obito_w, 
	qt_filhos_vivos_w, 
	doc_nasc1_w, 
	doc_nasc2_w, 
	doc_nasc3_w, 
	doc_nasc4_w, 
	doc_nasc5_w, 
	qt_dias_int_uti_w, 
	nr_prontuario_w, 
	dt_competencia_w, 
	nr_atendimento_w, 
	ie_consistente_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	if (coalesce(ds_versao_p, '4.0.0.0') = '4.0.1.0') then 
		if (cd_procedimento_w not in ('0299999', '0399999', '0499999', '0599999')) then 
			ds_procedimento_w	:= null;
		end if;
	end if;
 
	begin 
 
	insert into LOTE_CIH_ITEM( 
		nr_sequencia, 
		nr_seq_lote, 
		IE_TIPO_REG_INTERFACE, 
		nm_paciente, 
		nm_logradouro, 
		nr_endereco, 
		ds_complemento, 
		cd_municipio_ibge, 
		sg_estado_paciente, 
		cd_cep, 
		dt_nascimento, 
		ie_sexo, 
		cd_cns, 
		cd_procedimento, 
		cd_cid_primario, 
		cd_cid_secundario, 
		dt_entrada, 
		dt_alta, 
		cd_motivo_alta, 
		ie_fonte_remuner2, 
		ds_procedimento, 
		cd_ans, 
		cd_cnpj_conv, 
		cd_usuario_convenio, 
		nr_declaracao_obito, 
		qt_filhos_vivos, 
		doc_nasc1, 
		doc_nasc2, 
		doc_nasc3, 
		doc_nasc4, 
		doc_nasc5, 
		qt_dias_int_uti, 
		nr_prontuario, 
		dt_competencia, 
		DT_ATUALIZACAO, 
		NM_USUARIO, 
		DT_ATUALIZACAO_NREC, 
		NM_USUARIO_NREC, 
		nr_atendimento, 
		ie_consistente) 
	values ( nextval('lote_cih_item_seq'), 
		nr_seq_lote_p, 
		ie_tipo_reg_interface_w, 
		nm_paciente_w, 
		nm_logradouro_w, 
		nr_endereco_w, 
		ds_complemento_w, 
		cd_municipio_ibge_w, 
		sg_estado_paciente_w, 
		cd_cep_w, 
		dt_nascimento_w, 
		ie_sexo_w, 
		cd_cns_w, 
		cd_procedimento_w, 
		cd_cid_primario_w, 
		cd_cid_secundario_w, 
		dt_entrada_w, 
		dt_alta_w, 
		cd_motivo_alta_w, 
		ie_fonte_remuner2_w, 
		ds_procedimento_w, 
		cd_ans_w, 
		cd_cnpj_conv_w, 
		cd_usuario_convenio_w, 
		nr_declaracao_obito_w, 
		qt_filhos_vivos_w, 
		elimina_caracteres_especiais(doc_nasc1_w), 
		elimina_caracteres_especiais(doc_nasc2_w), 
		elimina_caracteres_especiais(doc_nasc3_w), 
		elimina_caracteres_especiais(doc_nasc4_w), 
		elimina_caracteres_especiais(doc_nasc5_w), 
		qt_dias_int_uti_w, 
		nr_prontuario_w, 
		dt_competencia_w, 
		clock_timestamp(), 
		NM_USUARIO_p, 
		clock_timestamp(), 
		NM_USUARIO_p, 
		nr_atendimento_w, 
		ie_consistente_w);
	end;
END LOOP;
CLOSE C01;
 
update 	lote_cih 
set 	dt_geracao = clock_timestamp() 
where	nr_sequencia = nr_seq_lote_p;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cih_versao4 (nr_seq_lote_p bigint, ie_consiste_municipio_ibge_p text, ie_gerar_atend_sem_alta_uti_p text, ie_restringer_estab_atend_p text, ie_gerar_pac_cronico_p text, ds_motivo_alta_p text, ie_gera_atend_lote_p text, ds_versao_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

