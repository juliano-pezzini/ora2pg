-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE adep_checagem_automatica ( nr_prescricao_p bigint, nm_usuario_p text, cd_perfil_p bigint ) AS $body$
DECLARE


cd_material_w				    integer;
cd_grupo_material_w			smallint;
cd_subgrupo_material_w	smallint;
cd_classe_material_w		integer;
ie_via_aplicacao_w			varchar(5);
nr_sequencia_w				  integer;
nr_seq_horario_w			  bigint;
nr_atendimento_w			  bigint;
cd_setor_Atendimento_w  bigint;
dt_horario_w				    timestamp;
ds_texto_aux_w				  varchar(255);
nr_seq_mat_compl_w			bigint;
nr_seq_checar_w				  bigint;
ie_nao_registra_w			  varchar(1);
nr_seq_proc_w				    bigint;
ie_allow_execution_w    varchar(1);
nr_sequencia_presc_w		pe_prescricao.nr_prescricao%type;
nr_seq_item_w				    pe_prescr_proc.nr_sequencia%type;



c01 CURSOR FOR
SELECT  cd_material,
        coalesce(obter_estrutura_material(cd_material,'G'),0),
        coalesce(obter_estrutura_material(cd_material,'S'),0),
        coalesce(obter_estrutura_material(cd_material,'C'),0),
        ie_via_aplicacao,
        nr_sequencia
from    prescr_material
where   nr_prescricao	= nr_prescricao_p
        and	ie_agrupador = 1;



c02 CURSOR FOR
SELECT	nr_sequencia,
        dt_horario,
        nr_seq_mat_compl
from    prescr_mat_hor
where   nr_prescricao	= nr_prescricao_p
        and	nr_seq_material	= nr_sequencia_w
        and	cd_material	= cd_material_w
        and ie_allow_execution_w = 'N'

union

SELECT  nr_sequencia,
        dt_horario,
        nr_seq_mat_compl
from (
          select  h.nr_sequencia,
                  h.dt_horario,
                  h.nr_seq_mat_compl
          from    prescr_mat_hor h,
                  prescr_material p,
                  cpoe_material m,
                  cpoe_rp r
          where   h.nr_prescricao = nr_prescricao_p
                  and h.nr_seq_material = nr_sequencia_w
                  and h.cd_material = cd_material_w
                  and h.nr_prescricao = p.nr_prescricao
                  and h.nr_seq_material = p.nr_sequencia
                  and p.nr_seq_mat_cpoe = m.nr_sequencia
                  and m.nr_seq_cpoe_rp = r.nr_sequencia
                  and r.ie_allow_execution = 'Y'
                  and ie_allow_execution_w = 'Y'
          order by dt_horario asc
        ) alias0 LIMIT 1;



c03 CURSOR FOR
SELECT 	pp.nr_sequencia,
        pp.nr_seq_proc,
        pph.nr_sequencia
FROM    pe_prescr_proc pp
        INNER JOIN pe_prescr_proc_hor pph
                ON pph.nr_seq_proc = pp.nr_seq_proc
WHERE pp.nr_seq_prescr = nr_prescricao_p;




BEGIN
  select  max(nr_atendimento),
          max(cd_setor_Atendimento)
  into STRICT    nr_atendimento_w,
          cd_setor_Atendimento_w
  from    prescr_medica
  where   nr_prescricao	= nr_prescricao_p;

  ds_texto_aux_w	:= wheb_mensagem_pck.get_texto(300552);

  open C01;
  loop fetch C01 into
		cd_material_w,
		cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w,
		ie_via_aplicacao_w,
		nr_sequencia_w;
  EXIT WHEN NOT FOUND; /* apply on C01 */
    begin
      select	max(nr_sequencia)
      into STRICT    nr_seq_checar_w
      from    adep_medic_checagem
      where   coalesce(cd_material, cd_material_w) = cd_material_w
              and	coalesce(cd_grupo_material, cd_grupo_material_w) = cd_grupo_material_w
              and	coalesce(cd_subgrupo_material, cd_subgrupo_material_w) = cd_subgrupo_material_w
              and	coalesce(cd_classe_material, cd_classe_material_w) = cd_classe_material_w
              and	coalesce(ie_via_aplicacao, ie_via_aplicacao_w) = ie_via_aplicacao_w
              and	((coalesce(cd_setor_Atendimento::text, '') = '') or (cd_setor_Atendimento = cd_setor_Atendimento_w))
              and	coalesce(cd_perfil,cd_perfil_p)= cd_perfil_p;

      if (nr_seq_checar_w IS NOT NULL AND nr_seq_checar_w::text <> '') then
        select	coalesce(max(ie_nao_registra),'N'),
                coalesce(max(ie_allow_execution),'N')
        into STRICT    ie_nao_registra_w,
                ie_allow_execution_w
        from    adep_medic_checagem
        where   nr_sequencia = nr_seq_checar_w;

        open C02;
        loop fetch C02 into
          nr_seq_horario_w,
          dt_horario_w,
          nr_seq_mat_compl_w;
        EXIT WHEN NOT FOUND; /* apply on C02 */
          begin
            if (ie_nao_registra_w	= 'S') then
              if (nr_seq_mat_compl_w IS NOT NULL AND nr_seq_mat_compl_w::text <> '') then
                update	prescr_mat_hor_compl
                set     dt_atualizacao = clock_timestamp(),
                        nm_usuario = nm_usuario_p,
                        ie_nao_registra	= ie_nao_registra_w
                where   nr_sequencia	= nr_seq_mat_compl_w;
              else
                select	nextval('prescr_mat_hor_compl_seq')
                into STRICT    nr_seq_mat_compl_w
;

                insert into prescr_mat_hor_compl(
                  nr_sequencia,
                  dt_atualizacao,
                  nm_usuario,
                  dt_atualizacao_nrec,
                  nm_usuario_nrec,
                  ie_nao_registra
                ) values (
                  nr_seq_mat_compl_w,
                  clock_timestamp(),
                  nm_usuario_p,
                  clock_timestamp(),
                  nm_usuario_p,
                  ie_nao_registra_w
                );
              end if;
            end if;

            update	prescr_mat_hor
            set     dt_fim_horario = clock_timestamp(),
                    nm_usuario = nm_usuario_p,
                    nm_usuario_adm = nm_usuario_p,
                    dt_atualizacao = clock_timestamp(),
                    nr_seq_mat_compl = nr_seq_mat_compl_w
            where   nr_sequencia	= nr_seq_horario_w;

            CALL gerar_alter_hor_prescr_adep(	nr_atendimento_w, 'M', cd_material_w, nr_prescricao_p, nr_sequencia_w, nr_seq_horario_w, dt_horario_w, 3, null, ds_texto_aux_w, null, nm_usuario_p);
          end;
        end loop;
        close C02;
      end if;
    end;
  end loop;
  close C01;

  if obter_parametro_funcao_padrao(281, 1512, nm_usuario_p) = 'S' then
    select	max(nr_prescricao)
    into STRICT	nr_sequencia_presc_w
    from	pe_prescricao
    where	nr_sequencia = nr_prescricao_p;

    open C03;
    loop fetch C03 into
      nr_seq_item_w,
      nr_seq_proc_w,
      nr_seq_horario_w;
    EXIT WHEN NOT FOUND; /* apply on C03 */
      begin			
        CALL gerar_alter_hor_prescr_adep(obter_atendimento_prescr(nr_sequencia_presc_w), 'E', nr_seq_proc_w, nr_prescricao_p, nr_seq_item_w, nr_seq_horario_w, clock_timestamp(), 3, null, null, null, nm_usuario_p);
      end;
    end loop;
    close C03;

    update	pe_prescr_proc_hor
    set		dt_fim_horario 		= clock_timestamp(),
          nm_usuario			= nm_usuario_p,
          nm_usuario_adm	= nm_usuario_p,	
          dt_atualizacao		= clock_timestamp()
    where	nr_seq_pe_prescr	= nr_prescricao_p;
  end if;

  if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then
    commit;
  end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE adep_checagem_automatica ( nr_prescricao_p bigint, nm_usuario_p text, cd_perfil_p bigint ) FROM PUBLIC;

