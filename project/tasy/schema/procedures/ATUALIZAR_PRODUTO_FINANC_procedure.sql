-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_produto_financ ( nr_seq_produto_ant_p bigint, nr_seq_produto_novo_p bigint, nr_titulo_p bigint, ie_produto_p text, nm_usuario_p text, ie_selecionados_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
cd_estabelecimento_w	smallint;
nr_seq_produto_w	bigint;
cd_convenio_w		integer;
cd_cgc_w		varchar(14);
ie_tipo_convenio_w	varchar(255);
nr_seq_grupo_w		bigint;

c01 CURSOR FOR
SELECT	nr_sequencia
from	titulo_receber_classif
where	nr_titulo	= nr_titulo_p;


BEGIN

select	cd_estabelecimento,
	cd_convenio_conta,
	cd_cgc,
	obter_tipo_convenio(cd_convenio_conta)
into STRICT	cd_estabelecimento_w,
	cd_convenio_w,
	cd_cgc_w,
	ie_tipo_convenio_w
from	titulo_receber a
where	a.nr_titulo	= nr_titulo_p;


if (ie_produto_p = 'S') then

	/* Francisco - OS 163050 - 25/09/2009 - Tratei conforme solicitado pelo Fernando */

	if (ie_selecionados_p = 'S') then
		update	titulo_receber_classif
		set	nm_usuario		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp(),
			nr_seq_produto		= nr_seq_produto_novo_p
		where	nr_titulo		= nr_titulo_p;
	else

		update	titulo_receber_classif
		set	nm_usuario		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp(),
			nr_seq_produto		= nr_seq_produto_novo_p
		where	nr_titulo		= nr_titulo_p
		and	coalesce(nr_seq_produto,0)	= coalesce(nr_seq_produto_ant_p,0);
	end if;

elsif (ie_produto_p = 'R') then

	SELECT * FROM obter_produto_financeiro(cd_estabelecimento_w, cd_convenio_w, cd_cgc_w, nr_seq_produto_w, ie_tipo_convenio_w, null, nr_seq_grupo_w) INTO STRICT nr_seq_produto_w, nr_seq_grupo_w;

	if (ie_selecionados_p = 'S') then
		update	titulo_receber_classif
		set	nm_usuario		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp(),
			nr_seq_produto		= nr_seq_produto_w
		where	nr_titulo		= nr_titulo_p;
	else

		update	titulo_receber_classif
		set	nm_usuario		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp(),
			nr_seq_produto		= nr_seq_produto_w
		where	nr_titulo		= nr_titulo_p
		and	coalesce(nr_seq_produto,0)	= coalesce(nr_seq_produto_ant_p,0);
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_produto_financ ( nr_seq_produto_ant_p bigint, nr_seq_produto_novo_p bigint, nr_titulo_p bigint, ie_produto_p text, nm_usuario_p text, ie_selecionados_p text) FROM PUBLIC;

