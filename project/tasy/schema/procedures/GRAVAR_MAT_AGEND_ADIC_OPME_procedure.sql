-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_mat_agend_adic_opme ( cd_material_p bigint, qt_unitaria_p bigint, nr_seq_lote_fornec_p text, nr_seq_agenda_P bigint, nm_usuario_p text, cd_estabelecimento_p bigint, cd_cgc_fornec_p text, ie_integracao_util_p text, nr_seq_opme_p INOUT bigint) AS $body$
DECLARE

 
nr_sequencia_w		bigint;
cd_cgc_fornec_w		varchar(14);
cd_tabela_preco_w	varchar(80);
vl_preco_venda_w	double precision;
vl_unitario_item_w	double precision := '';
					

BEGIN 
 
if (coalesce(cd_cgc_fornec_p,0) = 0) then 
 
	if (coalesce(nr_seq_lote_fornec_p, 0) > 0) then                   
		select	cd_cgc_fornec                              
		into STRICT	cd_cgc_fornec_w                              
		from	material_lote_fornec                           
		where	nr_sequencia = nr_seq_lote_fornec_p;
	else                                      
		cd_cgc_fornec_w	:= obter_fornecedor_regra_consig(cd_estabelecimento_p, cd_material_p, '1');
	end if;
else 
	cd_cgc_fornec_w := cd_cgc_fornec_p;
end if;
begin 
	select	substr(coalesce(cd_tabela_preco,0),1,80) 
	into STRICT	cd_tabela_preco_w 
	from	parametros_opme 
	where	cd_estabelecimento = cd_estabelecimento_p;
exception 
when others then 
	cd_tabela_preco_w := '0';
end;
 
if (cd_tabela_preco_w <> '0') then 
 
	select	coalesce(max(b.vl_preco_venda),0) 
	into STRICT	vl_preco_venda_w 
	from	preco_material b, 
		tabela_preco_material a 
	where	a.cd_tab_preco_mat = b.cd_tab_preco_mat 
	and	a.ie_situacao = 'A' 
	and	b.ie_situacao = 'A' 
	and	trunc(b.dt_inicio_vigencia,'mm') = trunc(clock_timestamp(),'mm') 
	and	a.cd_tab_preco_mat = cd_tabela_preco_w 
	and	b.cd_material = cd_material_p 
	and	a.cd_estabelecimento = cd_estabelecimento_p;
	 
	if (vl_preco_venda_w > 0) then 
		vl_unitario_item_w := vl_preco_venda_w;
	end if;
	 
end if;
 
if (coalesce(nr_seq_agenda_p,0) <> 0) then 
	begin 
	select 	nextval('agenda_pac_opme_seq') 
	into STRICT	nr_sequencia_w 
	;
	 
	insert into agenda_pac_opme( 
		cd_cgc, 
		cd_cond_pagto, 
		cd_material, 
		ds_observacao, 
		dt_atualizacao, 
		dt_atualizacao_nrec, 
		dt_exclusao, 
		ie_autorizado, 
		ie_gerar_autor, 
		ie_integracao, 
		ie_integracao_util, 
		ie_origem_inf, 
		ie_padrao, 
		nm_usuario, 
		nm_usuario_exclusao, 
		nm_usuario_nrec, 
		nr_seq_agenda, 
		nr_seq_apres, 
		nr_seq_motivo_exclusao, 
		nr_seq_proc_interno, 
		nr_sequencia, 
		qt_material, 
		vl_desconto, 
		vl_unitario_item, 
		nr_seq_lote) 
	values (cd_cgc_fornec_w, 
		'', 
		cd_material_p, 
		'', 
		clock_timestamp(), 
		clock_timestamp(), 
		'', 
		'P', 
		'S', 
		'S', 
		ie_integracao_util_p, 
		'I', 
		'S', 
		nm_usuario_p, 
		'', 
		nm_usuario_P, 
		nr_seq_agenda_p, 
		500, 
		null, 
		null, 
		nr_sequencia_w, 
		qt_unitaria_p, 
		'', 
		vl_unitario_item_w, 
		nr_seq_lote_fornec_p);
	end;
end if;
 
nr_seq_opme_p := nr_sequencia_w;	
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_mat_agend_adic_opme ( cd_material_p bigint, qt_unitaria_p bigint, nr_seq_lote_fornec_p text, nr_seq_agenda_P bigint, nm_usuario_p text, cd_estabelecimento_p bigint, cd_cgc_fornec_p text, ie_integracao_util_p text, nr_seq_opme_p INOUT bigint) FROM PUBLIC;

