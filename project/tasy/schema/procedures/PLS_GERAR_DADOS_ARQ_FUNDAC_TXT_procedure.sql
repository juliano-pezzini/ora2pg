-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_dados_arq_fundac_txt ( nr_seq_fatura_p pls_fatura.nr_sequencia%type, nr_seq_lote_fat_p pls_lote_faturamento.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

						
vl_tributo_w		pls_fatura_trib.vl_tributo%type;
nr_seq_lote_w		pls_lote_arq_fundacao_txt.nr_sequencia%type;
ie_fatura_taxa_w		pls_fatura.ie_fatura_taxa%type;

c01 CURSOR(nr_seq_fatura_pc		pls_fatura.nr_sequencia%type,
		nr_seq_lote_fat_pc		pls_lote_faturamento.nr_sequencia%type) FOR
	SELECT	a.nr_sequencia,
		a.nr_seq_lote,
		coalesce(coalesce(a.nr_titulo,a.nr_titulo_ndc),a.nr_sequencia) nr_fatura,
		to_char(b.dt_mesano_referencia,'mm') dt_mes,
		to_char(b.dt_mesano_referencia,'yyyy') dt_ano,
		coalesce(vl_total_ndc,0) + coalesce(vl_fatura,0) vl_total,
		to_char(coalesce(a.dt_emissao,b.dt_emissao),'ddmmyyyy') dt_emissao,
		coalesce(a.ie_fatura_taxa,'N') ie_fatura_taxa
	from	pls_lote_faturamento	b,
		pls_fatura		a
	where	b.nr_sequencia	= a.nr_seq_lote
	and	a.nr_seq_lote	= nr_seq_lote_fat_pc
	and	coalesce(a.ie_cancelamento::text, '') = ''
	and	(nr_seq_lote_fat_pc IS NOT NULL AND nr_seq_lote_fat_pc::text <> '')
	and	coalesce(a.ie_impedimento_cobranca, 'F') <> 'NF'
	and	coalesce(a.ie_fatura_taxa, 'N')	= 'N'
	
union

	SELECT	a.nr_sequencia,
		a.nr_seq_lote,
		coalesce(coalesce(a.nr_titulo,a.nr_titulo_ndc),a.nr_sequencia) nr_fatura,
		to_char(b.dt_mesano_referencia,'mm') dt_mes,
		to_char(b.dt_mesano_referencia,'yyyy') dt_ano,
		coalesce(vl_total_ndc,0) + coalesce(vl_fatura,0) vl_total,
		to_char(coalesce(a.dt_emissao,b.dt_emissao),'ddmmyyyy') dt_emissao,
		coalesce(a.ie_fatura_taxa,'N') ie_fatura_taxa
	from	pls_lote_faturamento	b,
		pls_fatura		a
	where	b.nr_sequencia	= a.nr_seq_lote
	and	a.nr_sequencia	= nr_seq_fatura_pc
	and	coalesce(a.ie_cancelamento::text, '') = ''
	and	(nr_seq_fatura_pc IS NOT NULL AND nr_seq_fatura_pc::text <> '')
	and	coalesce(a.ie_impedimento_cobranca, 'F') <> 'NF';

BEGIN
CALL pls_desfazer_dados_fundac_txt( nr_seq_fatura_p, nr_seq_lote_fat_p, cd_estabelecimento_p, nm_usuario_p);

for r_C01_w in C01( nr_seq_fatura_p , nr_seq_lote_fat_p ) loop

	ie_fatura_taxa_w	:= r_c01_w.ie_fatura_taxa;
		
	select	coalesce(sum(coalesce(vl_tributo,0)),0)
	into STRICT	vl_tributo_w
	from	pls_fatura_trib
	where	nr_seq_fatura	= r_c01_w.nr_sequencia;

	insert into pls_lote_arq_fundacao_txt(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_pls_fatura,
		cd_unimed,
		nr_contrato,
		cd_usuario,
		cd_dependente,
		nr_fatura,
		dt_mes_fatura,
		dt_ano_fatura,
		vl_total_servico,
		vl_retencao_irrf,
		nr_seq_lote_fat,
		dt_emissao_fatura)
	values (nextval('pls_lote_arq_fundacao_txt_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		r_C01_w.nr_sequencia,
		'999',
		'9999',
		'999999',
		'99',
		r_C01_w.nr_fatura,
		r_C01_w.dt_mes,
		r_C01_w.dt_ano,
		elimina_caractere_especial(r_C01_w.vl_total),
		elimina_caractere_especial(vl_tributo_w),
		r_C01_w.nr_seq_lote,
		r_C01_w.dt_emissao) returning nr_sequencia into nr_seq_lote_w;
		
	CALL pls_gerar_dados_arq_fund_item( nr_seq_lote_w, r_C01_w.nr_sequencia, cd_estabelecimento_p, nm_usuario_p);
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_dados_arq_fundac_txt ( nr_seq_fatura_p pls_fatura.nr_sequencia%type, nr_seq_lote_fat_p pls_lote_faturamento.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

