-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_valida_hem_irradiado ( nr_seq_producao_p bigint) AS $body$
DECLARE


nr_seq_derivado_w  	san_derivado.nr_sequencia%Type;
ie_noenato_w       	bigint;
dt_doacao_w      	san_producao.dt_producao%Type;
ie_irradiado_w     	san_producao.ie_irradiado%Type;
dt_irradiacao_w    	san_producao.dt_irradiacao%Type;
ie_abreviacao_via_w	ANVISA_VIA_ADMINISTRACAO.ie_abreviacao_via%Type;
ds_sigla_w		san_derivado.ie_tipo_derivado%type;
dt_ini_infusao_w	san_producao.dt_inicio_infusao%type;
nr_prescricao_w		prescr_medica.nr_prescricao%type;
ie_transfusao_macica_w  san_transfusao.ie_transfusao_macica%type;


BEGIN

if ( nr_seq_producao_p > 0 ) then
	select	
		obter_idade(max(d.dt_nascimento), clock_timestamp(), 'DIA'),
		coalesce(max(e.dt_fim_coleta), max(a.dt_producao)),
		max(a.ie_irradiado),
		max(a.dt_irradiacao),
		max(c.nr_sequencia),
		max(c.ie_tipo_derivado),
		max(a.dt_inicio_infusao),
		max(b.nr_prescricao),
		max(b.ie_transfusao_macica)
	into STRICT 	ie_noenato_w,
		dt_doacao_w,
		ie_irradiado_w,
		dt_irradiacao_w,
		nr_seq_derivado_w,
		ds_sigla_w,
		dt_ini_infusao_w,
		nr_prescricao_w,
		ie_transfusao_macica_w
	FROM pessoa_fisica d, san_derivado c, san_transfusao b, san_producao a
LEFT OUTER JOIN san_doacao e ON (a.nr_seq_doacao = e.nr_sequencia)
WHERE a.nr_seq_transfusao = b.nr_sequencia and d.cd_pessoa_fisica = b.cd_pessoa_fisica and a.nr_seq_derivado = c.nr_sequencia  and a.nr_sequencia = nr_seq_producao_p;

end if;

if (nr_seq_derivado_w > 0 ) then	
	select 
		max(k.ie_abreviacao_via)
	into STRICT 
		ie_abreviacao_via_w
	from 	PRESCR_PROCEDIMENTO g,
		VIA_APLICACAO j,
		ANVISA_VIA_ADMINISTRACAO k
	where 	g.ie_via_aplicacao = j.ie_via_aplicacao
	and 	j.nr_seq_via_anvisa = k.nr_sequencia
	and	g.nr_prescricao = nr_prescricao_w
	and 	g.nr_seq_derivado = nr_seq_derivado_w;

	if (ds_sigla_w = 'CH' and ie_irradiado_w = 'S') and 	
		((ie_noenato_w <= 28 and ie_transfusao_macica_w = 'S') or ie_abreviacao_via_w = 'IU') and (PKG_DATE_UTILS.get_DiffDate(dt_doacao_w, clock_timestamp(), 'DAY') >= 5 or (PKG_DATE_UTILS.get_DiffDate(dt_irradiacao_w, clock_timestamp(), 'DAY') >= 1)) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1125773);
	end if;

	if (ds_sigla_w <> 'CP' and
		PKG_DATE_UTILS.get_DiffDate(dt_irradiacao_w, dt_doacao_w, 'DAY') >= 14 and
		PKG_DATE_UTILS.get_DiffDate(dt_ini_infusao_w, clock_timestamp(), 'DAY') >= 2 ) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1125774);
	end if;

	if (ds_sigla_w = 'G' and PKG_DATE_UTILS.get_DiffDate(dt_irradiacao_w, dt_ini_infusao_w, 'DAY') >= 1 ) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1023949);
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_valida_hem_irradiado ( nr_seq_producao_p bigint) FROM PUBLIC;

