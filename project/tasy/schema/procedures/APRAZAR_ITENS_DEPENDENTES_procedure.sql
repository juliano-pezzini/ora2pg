-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE aprazar_itens_dependentes ( cd_estabelecimento_p bigint, cd_setor_atendimento_p bigint, nr_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_superior_p bigint, nr_agrupamento_p bigint, dt_horario_aprazar_p timestamp, ie_gerar_disp_farm_p text, nm_usuario_p text, nr_seq_dialise_p bigint default null, nr_seq_hor_glic_p bigint default null, nr_seq_pergunta_p bigint default null, ie_horario_adep_p text DEFAULT NULL, ie_origem_p text DEFAULT NULL, nr_seq_gasoterapia_p prescr_gasoterapia.nr_sequencia%type default null) AS $body$
DECLARE


nr_sequencia_w			bigint;
cd_material_w			integer;
ie_agrupador_w			smallint;
cd_local_estoque_w		smallint;
nr_seq_min_hor_w		bigint;
cd_setor_atendimento_w		bigint;
qt_dose_w			double precision;
qt_dispensar_w			double precision;
qt_dispensar_hor_w		double precision;
cd_unidade_medida_w		varchar(30);
cd_unidade_medida_dose_w	varchar(30);
nr_seq_horario_w		bigint;
ie_classif_urgente_w		varchar(3);
ie_padronizado_w		varchar(1);
ie_controlado_w			varchar(1);
nr_sequencia_ww			bigint;
nr_seq_classif_w		bigint;
ie_classif_nao_padrao_w		varchar(15);
ie_local_estoque_mat_hor_w	varchar(20);
ie_local_estoque_w		varchar(15);
dt_limite_agora_w		timestamp;
dt_liberacao_w			timestamp;
dt_limite_especial_w		timestamp;
cd_estabelecimento_w		bigint;
qt_min_agora_w			bigint;
qt_min_especial_w		bigint;
qt_total_dispensar_w		double precision;
qt_dose_especial_w		double precision;
qt_conversao_w			double precision;
qt_dose_hor_w			double precision;
qt_horario_w			prescr_mat_hor.qt_horario%type;
cd_unid_med_dose_hor_w		varchar(30);
ie_liberado_w 			varchar(1);
ie_gerar_necessidade_disp_w	varchar(15);
ie_agrupador_ww			bigint;
ie_agora_impressao_w		varchar(15);
nr_seq_turno_hor_ag_w		bigint;
hr_turno_agora_w		varchar(15);
qt_min_antes_atend_w		integer;
ie_gerar_lote_ww		varchar(1);
nr_seq_classif_param_w		bigint;
dt_hora_atual_w			timestamp;
ie_gerar_classif_agora_w	varchar(1);
hr_final_turno_agora_w		varchar(15);
dt_inicio_prescr_w		timestamp;
ie_horario_adep_w		varchar(1);
ie_gera_integracao_w		varchar(1);
ie_gerar_proc_gedipa_job_w		varchar(1);
ie_define_agora_w		regra_tempo_disp.ie_define_agora%type;
nr_seq_superior_w		bigint;
nr_agrupamento_w		prescr_material.nr_agrupamento%type;
ie_gerar_log_kit_w  varchar(1);
dt_horario_w			prescr_mat_hor.dt_horario%type;

c02 CURSOR FOR
SELECT	nr_sequencia,
	cd_material,
	ie_agrupador,
	cd_local_estoque,
	qt_total_dispensar
from	prescr_material
where	nr_prescricao		= nr_prescricao_p
and	nr_sequencia_diluicao	= nr_seq_superior_p
and	ie_agrupador		in (3,7,9)
order by
	nr_sequencia;
	
c03 CURSOR FOR
SELECT	nr_sequencia,
	cd_material,
	ie_agrupador,
	cd_local_estoque	
from	prescr_material
where	nr_prescricao	= nr_prescricao_p
and	nr_sequencia	<> nr_seq_superior_p
and	nr_agrupamento	= nr_agrupamento_p
and	ie_agrupador	= 1
and	ie_agrupador_ww	= ie_agrupador
and 	coalesce(nr_seq_substituto::text, '') = ''
and	coalesce(nr_seq_gasoterapia::text, '') = ''

union all

SELECT	a.nr_sequencia,
	a.cd_material,
	a.ie_agrupador,
	a.cd_local_estoque	
from	prescr_material	a,
	intervalo_prescricao b
where	a.cd_intervalo	= b.cd_intervalo
and	a.nr_prescricao	= nr_prescricao_p
and	a.nr_seq_gasoterapia = nr_seq_gasoterapia_p
and (coalesce(b.ie_acm,'N') = 'S' or coalesce(b.ie_se_necessario,'N') = 'S')
and	a.ie_agrupador	= 15
order by
	nr_sequencia;
	
c04 CURSOR FOR
SELECT	nr_sequencia,
		cd_material,
		ie_agrupador,
		cd_local_estoque,
		cd_unidade_medida_dose,
		qt_total_dispensar,
		qt_dose_especial,
		qt_dose,
		cd_unidade_medida
from	prescr_material
where	nr_prescricao	= nr_prescricao_p
and		(((nr_seq_kit	= nr_seq_superior_p) and (nr_agrupamento_p not in (2222, 9999))) or
		(nr_seq_kit IS NOT NULL AND nr_seq_kit::text <> '' AND nr_sequencia_proc = nr_seq_superior_p))
and		coalesce(nr_seq_recomendacao::text, '') = ''
order by
		nr_sequencia;
	
C05 CURSOR FOR
	SELECT	nr_sequencia,
		ie_classif_urgente,
		ie_controlado,
		ie_padronizado
	from	classif_lote_disp_far
	where	cd_estabelecimento = cd_estabelecimento_p
	and	ie_situacao = 'A'
	order by ie_classif_urgente,
		ie_controlado desc,
		ie_padronizado desc;
		
c06 CURSOR FOR
SELECT	nr_sequencia,
	cd_material,
	ie_agrupador,
	cd_local_estoque,
	a.cd_unidade_medida
from	prescr_material a
where	nr_prescricao	= nr_prescricao_p
and		nr_sequencia_proc = nr_seq_superior_p
and		ie_agrupador	= 5
and		nr_agrupamento_p = 9999
and		((coalesce(nr_seq_pergunta_p,0) = 0) or (exists (SELECT 1
				from 	prot_glic_nivel_assoc x
				where	x.cd_material	= a.cd_material
				and		x.nr_seq_registro = nr_seq_pergunta_p)))
order by
	nr_sequencia;
	
c07 CURSOR FOR	
SELECT	nr_sequencia,
	cd_material,
	ie_agrupador,
	cd_local_estoque,
	cd_unidade_medida_dose,
	qt_total_dispensar,
	qt_dose_especial,
	qt_dose,
	cd_unidade_medida
from	prescr_material
where	nr_prescricao	= nr_prescricao_p
and	nr_seq_pe_proc = nr_seq_superior_p
and	nr_agrupamento_p = 1111
order by
	nr_sequencia;
	
C09 CURSOR FOR
SELECT	nr_sequencia,
		cd_material,
		ie_agrupador,
		cd_local_estoque,
		cd_unidade_medida_dose,
		qt_total_dispensar,
		qt_dose_especial,
		qt_dose,
		cd_unidade_medida,
		nr_agrupamento
from	prescr_material
where	nr_prescricao	= nr_prescricao_p
and		nr_seq_recomendacao	= nr_seq_superior_p
and 	nr_agrupamento_p = 2222
order by
		nr_sequencia;		
	

BEGIN

ie_gerar_log_kit_w := obter_rastreabilidade_adep(nr_prescricao_p, 'APR');
if (ie_gerar_log_kit_w = 'S') then
  CALL adep_gerar_log_rastr(substr('Log aprazar kit' || chr(10) ||
    '{ nr_prescricao_p: ' || nr_prescricao_p || ',' || chr(10) ||
    ' cd_setor_atendimento_p: ' || cd_setor_atendimento_p || ',' || chr(10) ||
    ' nr_agrupamento_p: ' || nr_agrupamento_p || ',' || chr(10) ||
    ' nm_usuario_p: ' || nm_usuario_p || ',' || chr(10) ||
    ' nr_seq_dialise_p: ' || nr_seq_dialise_p || ',' || chr(10) ||
    ' nr_atendimento_p: ' || nr_atendimento_p || ',' || chr(10) ||
    ' ie_gerar_disp_farm_p: ' || ie_gerar_disp_farm_p || ',' || chr(10) ||
    ' dt_horario_aprazar_p: ' || dt_horario_aprazar_p || ',' || chr(10) ||
    ' ie_local_estoque_mat_hor_w: ' || ie_local_estoque_mat_hor_w || ',' || chr(10) ||
    ' ie_local_estoque_w: ' || ie_local_estoque_w || ',' || chr(10) ||
    ' dt_liberacao_w: ' || dt_liberacao_w || ',' || chr(10) ||
    ' cd_estabelecimento_p: ' || cd_estabelecimento_p || ',' || chr(10) ||
    ' ie_gerar_necessidade_disp_w: ' || ie_gerar_necessidade_disp_w || ',' || chr(10) ||
    ' nr_seq_classif_param_w: ' || nr_seq_classif_param_w || ',' || chr(10) ||
    ' ie_gerar_classif_agora_w: ' || ie_gerar_classif_agora_w || ',' || chr(10) ||
    ' dt_inicio_prescr_w: ' || dt_inicio_prescr_w || ',' || chr(10) ||
    ' ie_horario_adep_w: ' || ie_horario_adep_w || ',' || chr(10) ||
    ' ie_gera_integracao_w: ' || ie_gera_integracao_w || ',' || chr(10) ||
    ' ie_gerar_proc_gedipa_job_w: ' || ie_gerar_proc_gedipa_job_w || ',' || chr(10) ||
    ' nr_sequencia_w: ' || nr_sequencia_w || ',' || chr(10) ||
    '}'
  , 1, 1500));
end if;

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and
	((nr_seq_superior_p IS NOT NULL AND nr_seq_superior_p::text <> '' AND nr_agrupamento_p IS NOT NULL AND nr_agrupamento_p::text <> '') or
	(nr_seq_gasoterapia_p IS NOT NULL AND nr_seq_gasoterapia_p::text <> '')) and (dt_horario_aprazar_p IS NOT NULL AND dt_horario_aprazar_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	
	ie_gerar_necessidade_disp_w := obter_param_usuario(1113, 70, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_gerar_necessidade_disp_w);
	ie_gerar_lote_ww := obter_param_usuario(1113, 342, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_gerar_lote_ww);	
	nr_seq_classif_param_w := obter_param_usuario(1113, 498, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, nr_seq_classif_param_w);
	ie_gerar_classif_agora_w := Obter_Param_Usuario(1113, 529, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_gerar_classif_agora_w);
	ie_local_estoque_w := obter_param_usuario(924, 799, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_local_estoque_w);
	ie_local_estoque_mat_hor_w := obter_param_usuario(924, 851, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_local_estoque_mat_hor_w);
	
	Select	coalesce(max(ie_agrupador),1)
	into STRICT	ie_agrupador_ww
	from	prescr_material
	where	nr_prescricao	= nr_prescricao_p
	and 	nr_sequencia	= nr_seq_superior_p;
	
	ie_horario_adep_w	:= coalesce(ie_horario_adep_p,'S');
	
	dt_horario_w := PKG_DATE_UTILS.start_of(dt_horario_aprazar_p, 'mi', 0);
	
	select	max(dt_liberacao),
			max(cd_estabelecimento),
			max(dt_inicio_prescr)
	into STRICT	dt_liberacao_w,
			cd_estabelecimento_w,
			dt_inicio_prescr_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;
	
	select	coalesce(max(qt_min_agora),0),
			coalesce(max(qt_min_especial),0),
			max(ie_classif_urgencia),
			coalesce(max(ie_forma_agora), 'N'),
			coalesce(max(ie_gera_integracao),'N'),
			coalesce(max(ie_gerar_proc_gedipa_job),'S')
	into STRICT	qt_min_agora_w,
			qt_min_especial_w,
			ie_classif_nao_padrao_w,
			ie_agora_impressao_w,
			ie_gera_integracao_w,
			ie_gerar_proc_gedipa_job_w
	from	parametros_farmacia
	where	cd_estabelecimento = cd_estabelecimento_w;	
	
	open c02;
	loop
	fetch c02 into	nr_sequencia_w,
			cd_material_w,
			ie_agrupador_w,
			cd_local_estoque_w,
			qt_total_dispensar_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		
		cd_setor_atendimento_w := cd_setor_atendimento_p;
		if (ie_local_estoque_w = 'S') then
			CALL define_local_disp_prescr(nr_prescricao_p, nr_sequencia_w, obter_perfil_ativo, nm_usuario_p);
			select	max(cd_local_estoque)
			into STRICT	cd_local_estoque_w
			from	prescr_material b
			where	nr_prescricao	= nr_prescricao_p
			and	nr_sequencia	= nr_sequencia_w;
			
			cd_setor_atendimento_w		:= Obter_Setor_Atendimento(nr_atendimento_p);
		elsif (ie_local_estoque_w = 'R') then
			CALL define_local_disp_prescr(nr_prescricao_p, nr_sequencia_w, obter_perfil_ativo, nm_usuario_p);
			select	max(cd_local_estoque)
			into STRICT	cd_local_estoque_w
			from	prescr_material b
			where	nr_prescricao	= nr_prescricao_p
			and	nr_sequencia	= nr_sequencia_w;
			
			cd_setor_atendimento_w		:= Obter_Setor_Atendimento_lib(nr_atendimento_p);
		end if;
		
		select	coalesce(min(nr_sequencia),0)
		into STRICT	nr_seq_min_hor_w
		from	prescr_mat_hor
		where	nr_prescricao 	= nr_prescricao_p
		and	nr_seq_material	= nr_sequencia_w
		and	coalesce(ie_situacao,'A') 	= 'A'
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

		if (nr_seq_min_hor_w > 0) then
			select	qt_dose,
				qt_dispensar,
				qt_dispensar_hor,
				cd_unidade_medida,
				cd_unidade_medida_dose
			into STRICT	qt_dose_w,
				qt_dispensar_w,
				qt_dispensar_hor_w,
				cd_unidade_medida_w,
				cd_unidade_medida_dose_w
			from	prescr_mat_hor
			where	nr_sequencia = nr_seq_min_hor_w
			and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
			
			qt_horario_w  := null;
			cd_unid_med_dose_hor_w := null;
			
			SELECT * FROM obter_dose_um_horario_pmh(cd_material_w, qt_dose_w, cd_unidade_medida_dose_w, qt_horario_w, cd_unid_med_dose_hor_w) INTO STRICT qt_horario_w, cd_unid_med_dose_hor_w;
		end if;	

		ie_liberado_w := 'N';
				
		select	coalesce(max('S'),'N')
		into STRICT	ie_liberado_w
		from	prescr_mat_hor	
		where	nr_prescricao = nr_prescricao_p
		and	(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '');		
		
		select	nextval('prescr_mat_hor_seq')
		into STRICT	nr_seq_horario_w
		;
		
		select	coalesce(max(substr(Obter_se_medic_controlado(cd_material_w),1,1)),'N'),
			coalesce(max(substr(obter_se_material_padronizado(cd_estabelecimento_w, cd_material_w),1,1)),'N')
		into STRICT	ie_controlado_w,
			ie_padronizado_w
		;
		
		dt_limite_agora_w	:= dt_liberacao_w + qt_min_agora_w/1440;
		dt_limite_especial_w	:= dt_liberacao_w + qt_min_especial_w/1440;
		
		if (coalesce(ie_gerar_classif_agora_w,'N') = 'S') then
			dt_hora_atual_w := clock_timestamp();
			dt_limite_agora_w	:=  dt_hora_atual_w + qt_min_agora_w/1440; 			
		end if;

		ie_classif_urgente_w := definir_ie_classif_urgente(dt_horario_w,
                                                      cd_local_estoque_w,
                                                      cd_estabelecimento_w,
                                                      cd_setor_atendimento_w,
                                                      dt_inicio_prescr_w,
                                                      ie_classif_nao_padrao_w,
                                                      ie_padronizado_w,
                                                      dt_limite_especial_w,
                                                      dt_limite_agora_w,
                                                      ie_agora_impressao_w);
		
		insert into prescr_mat_hor(
			nr_sequencia,
			nr_seq_digito,
			nr_prescricao,
			nr_seq_material,
			ie_agrupador,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_material,
			qt_dose,
			qt_dispensar_hor,
			ds_horario,
			dt_horario,
			cd_unidade_medida,
			cd_unidade_medida_dose,
			ie_urgente,
			dt_emissao_farmacia,
			dt_fim_horario,
			dt_suspensao,
			ie_horario_especial,
			qt_hor_reaprazamento,
			nm_usuario_reaprazamento,
			nr_seq_turno,
			dt_disp_farmacia,
			ie_aprazado,
			nr_seq_superior,
			ie_padronizado,
			ie_controlado,
			ie_classif_urgente,
			qt_horario,
			cd_unid_med_hor,
			dt_lib_horario,
			qt_dispensar,
			nr_seq_dialise,
			nr_atendimento,
			nr_agrupamento,
			ie_horario_adep)
		values (
			nr_seq_horario_w,
			calcula_digito('MODULO11',nr_seq_horario_w),
			nr_prescricao_p,
			nr_sequencia_w,
			ie_agrupador_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_material_w,
			qt_dose_w,
			qt_dispensar_hor_w,
			to_char(dt_horario_aprazar_p,'hh24:mi'),
			dt_horario_w,
			cd_unidade_medida_w,
			cd_unidade_medida_dose_w,
			'N',
			CASE WHEN ie_gerar_disp_farm_p='S' THEN null  ELSE clock_timestamp() END ,
			null,
			null,
			'N',
			null,
			null,
			obter_turno_horario_prescr(cd_estabelecimento_p,cd_setor_atendimento_w,to_char(dt_horario_aprazar_p,'hh24:mi'),cd_local_estoque_w),
			clock_timestamp(),
			'S',
			nr_seq_superior_p,
			ie_padronizado_w,
			ie_controlado_w,
			ie_classif_urgente_w,
			qt_horario_w,
			cd_unid_med_dose_hor_w,
			clock_timestamp(),
			qt_total_dispensar_w,
			nr_seq_dialise_p,
			nr_atendimento_p,
			nr_agrupamento_p,
			ie_horario_adep_w);
			
			if (ie_gerar_proc_gedipa_job_w = 'N') then
				CALL Gedipa_Gerar_Proc_Instantaneo(nr_prescricao_p,nr_sequencia_w,null,nr_seq_horario_w);
			end if;
			
			CALL Gerar_Gedi_Medic_atend(cd_estabelecimento_w, nr_prescricao_p, nr_sequencia_w, nr_seq_horario_w, nm_usuario_p);			
			
			if (coalesce(nr_seq_classif_param_w ,0) > 0)	then
				begin
				update	prescr_mat_hor
				set	nr_seq_classif		= nr_seq_classif_param_w
				where	nr_prescricao		= nr_prescricao_p	
				and	nr_sequencia		= nr_seq_horario_w;
				exception
				when others then					
					CALL Wheb_mensagem_pck.exibir_mensagem_abort(372995);
				end;
			else				
				open C05;
				loop
				fetch C05 into	
					nr_seq_classif_w,
					ie_classif_urgente_w,
					ie_controlado_w,
					ie_padronizado_w;
				EXIT WHEN NOT FOUND; /* apply on C05 */
					begin
	
					if (ie_controlado_w = 'A') and (ie_padronizado_w = 'A') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p	
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'S') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_padronizado		= 'S'
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'N') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_padronizado		= 'N'
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'A') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_controlado		= 'N'
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'N') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_controlado		= 'N'
						and	ie_padronizado		= 'N'
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'S') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_controlado		= 'N'
						and	ie_padronizado		= 'S'
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'A') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_controlado		= 'S'
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'N') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_controlado		= 'S'
						and	ie_padronizado		= 'N'						
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'S') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_controlado		= 'S'
						and	ie_padronizado		= 'S'						
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					end if;

					end;
				end loop;
				close C05;
			end if;	

			if (ie_local_estoque_mat_hor_w	= 'S') then
				CALL define_disp_prescr_mat_hor(nr_seq_horario_w, nr_prescricao_p, nr_sequencia_w, obter_perfil_ativo, nm_usuario_p);
			
				select	coalesce(max(cd_local_estoque),cd_local_estoque_w)
				into STRICT	cd_local_estoque_w
				from	prescr_mat_hor
				where	nr_sequencia	= nr_seq_horario_w;
				
				update	prescr_mat_hor
				set	nr_seq_turno	= coalesce(Obter_turno_horario_prescr(cd_estabelecimento_w, cd_setor_atendimento_w, to_char(dt_horario_aprazar_p,'hh24:mi'), cd_local_estoque_w),nr_seq_turno)
				where	nr_sequencia	= nr_seq_horario_w;
			end if;

        CALL aprazar_kit(nr_prescricao_p		=> nr_prescricao_p,
                    cd_setor_atendimento_p	=> cd_setor_atendimento_p,
                    nr_agrupamento_p	        => nr_agrupamento_p,
                    nm_usuario_p		=> nm_usuario_p,
                    nr_seq_dialise_p	        => nr_seq_dialise_p,
                    nr_atendimento_p	        => nr_atendimento_p,
                    ie_gerar_disp_farm_p	=> ie_gerar_disp_farm_p,
                    dt_horario_aprazar_p        => dt_horario_w,
                    ie_local_estoque_mat_hor_p  => ie_local_estoque_mat_hor_w,
                    ie_local_estoque_p          => ie_local_estoque_w,
                    dt_liberacao_p              => dt_liberacao_w,
                    cd_estabelecimento_p        => cd_estabelecimento_p,
                    ie_gerar_necessidade_disp_p => ie_gerar_necessidade_disp_w,
                    nr_seq_classif_param_p      => nr_seq_classif_param_w,
                    ie_gerar_classif_agora_p    => ie_gerar_classif_agora_w,
                    dt_inicio_prescr_p          => dt_inicio_prescr_w,
                    ie_horario_adep_p           => ie_horario_adep_w,
                    ie_gera_integracao_p        => ie_gera_integracao_w,
                    ie_gerar_proc_gedipa_job_p  => ie_gerar_proc_gedipa_job_w,
                    nr_seq_superior_p           => nr_sequencia_w);
		end;
	end loop;
	close c02;

	open c03;
	loop
	fetch c03 into	nr_sequencia_w,
			cd_material_w,
			ie_agrupador_w,
			cd_local_estoque_w;			
	EXIT WHEN NOT FOUND; /* apply on c03 */
		begin
		
		nr_seq_superior_w := nr_sequencia_w;

		select	coalesce(min(nr_sequencia),0)
		into STRICT	nr_seq_min_hor_w
		from	prescr_mat_hor
		where	nr_prescricao 	= nr_prescricao_p
		and	nr_seq_material	= nr_sequencia_w
		and	coalesce(ie_situacao,'A') 	= 'A'
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

		if (nr_seq_min_hor_w > 0) then
			select	qt_dose,
				qt_dispensar,
				qt_dispensar_hor,
				cd_unidade_medida,
				cd_unidade_medida_dose
			into STRICT	qt_dose_w,
				qt_dispensar_w,
				qt_dispensar_hor_w,
				cd_unidade_medida_w,
				cd_unidade_medida_dose_w
			from	prescr_mat_hor
			where	nr_sequencia = nr_seq_min_hor_w
			and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
			
			qt_horario_w  := null;
			cd_unid_med_dose_hor_w := null;
			
			SELECT * FROM obter_dose_um_horario_pmh(cd_material_w, qt_dose_w, cd_unidade_medida_dose_w, qt_horario_w, cd_unid_med_dose_hor_w) INTO STRICT qt_horario_w, cd_unid_med_dose_hor_w;
		end if;		
		
		select	nextval('prescr_mat_hor_seq')
		into STRICT	nr_seq_horario_w
		;
		
		select	coalesce(max(substr(Obter_se_medic_controlado(cd_material_w),1,1)),'N'),
			coalesce(max(substr(obter_se_material_padronizado(cd_estabelecimento_w, cd_material_w),1,1)),'N')
		into STRICT	ie_controlado_w,
			ie_padronizado_w
		;
		
		cd_setor_atendimento_w := cd_setor_atendimento_p;
		if (ie_local_estoque_w = 'S') then
			CALL define_local_disp_prescr(nr_prescricao_p, nr_sequencia_w, obter_perfil_ativo, nm_usuario_p);
			select	max(cd_local_estoque)
			into STRICT	cd_local_estoque_w
			from	prescr_material b
			where	nr_prescricao	= nr_prescricao_p
			and	nr_sequencia	= nr_sequencia_w;
			
			cd_setor_atendimento_w		:= Obter_Setor_Atendimento(nr_atendimento_p);
		elsif (ie_local_estoque_w = 'R') then
			CALL define_local_disp_prescr(nr_prescricao_p, nr_sequencia_w, obter_perfil_ativo, nm_usuario_p);
			select	max(cd_local_estoque)
			into STRICT	cd_local_estoque_w
			from	prescr_material b
			where	nr_prescricao	= nr_prescricao_p
			and	nr_sequencia	= nr_sequencia_w;
			
			cd_setor_atendimento_w		:= Obter_Setor_Atendimento_lib(nr_atendimento_p);
			
		end if;
		
		dt_limite_agora_w	:= dt_liberacao_w + qt_min_agora_w/1440;
		dt_limite_especial_w	:= dt_liberacao_w + qt_min_especial_w/1440;
		
		if (coalesce(ie_gerar_classif_agora_w,'N') = 'S') then
			dt_hora_atual_w := clock_timestamp();
			dt_limite_agora_w	:=  dt_hora_atual_w + qt_min_agora_w/1440; 			
		end if;
		
		ie_classif_urgente_w := definir_ie_classif_urgente(dt_horario_w,
                                                      cd_local_estoque_w,
                                                      cd_estabelecimento_w,
                                                      cd_setor_atendimento_w,
                                                      dt_inicio_prescr_w,
                                                      ie_classif_nao_padrao_w,
                                                      ie_padronizado_w,
                                                      dt_limite_especial_w,
                                                      dt_limite_agora_w,
                                                      ie_agora_impressao_w);
		
		ie_liberado_w := 'N';
				
		select	coalesce(max('S'),'N')
		into STRICT	ie_liberado_w
		from	prescr_mat_hor	
		where	nr_prescricao = nr_prescricao_p
		and	(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '');
		
		insert into prescr_mat_hor(
			nr_sequencia,
			nr_seq_digito,
			nr_prescricao,
			nr_seq_material,
			ie_agrupador,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_material,
			qt_dose,			
			ds_horario,
			dt_horario,
			cd_unidade_medida,
			cd_unidade_medida_dose,
			ie_urgente,
			dt_emissao_farmacia,
			dt_fim_horario,
			dt_suspensao,
			ie_horario_especial,
			qt_hor_reaprazamento,
			nm_usuario_reaprazamento,
			nr_seq_turno,
			dt_disp_farmacia,
			ie_aprazado,
			ie_padronizado,
			ie_controlado,
			ie_classif_urgente,
			qt_horario,
			dt_lib_horario,
			qt_dispensar_hor,
			nr_seq_dialise,
			nr_atendimento,
			nr_agrupamento,
			ie_horario_adep,
			nr_seq_superior
			)
		values (
			nr_seq_horario_w,
			calcula_digito('MODULO11',nr_seq_horario_w),
			nr_prescricao_p,
			nr_sequencia_w,
			ie_agrupador_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_material_w,
			qt_dose_w,			
			to_char(dt_horario_aprazar_p,'hh24:mi'),
			dt_horario_w,
			cd_unidade_medida_w,
			cd_unidade_medida_dose_w,
			'N',
			CASE WHEN ie_gerar_disp_farm_p='S' THEN null  ELSE clock_timestamp() END ,
			null,
			null,
			'N',
			null,
			null,
			obter_turno_horario_prescr(cd_estabelecimento_p,cd_setor_atendimento_w,to_char(dt_horario_aprazar_p,'hh24:mi'),cd_local_estoque_w),
			clock_timestamp(),
			'S',
			ie_padronizado_w,
			ie_controlado_w,
			ie_classif_urgente_w,
			qt_horario_w,
			clock_timestamp(),
			qt_dispensar_hor_w,
			nr_seq_dialise_p,
			nr_atendimento_p,
			nr_agrupamento_p,
			ie_horario_adep_w,
			nr_seq_superior_p);
			
			if (ie_gerar_proc_gedipa_job_w = 'N') then
				CALL Gedipa_Gerar_Proc_Instantaneo(nr_prescricao_p,nr_sequencia_w,null,nr_seq_horario_w);
			end if;			
			
			CALL Gerar_Gedi_Medic_atend(cd_estabelecimento_w, nr_prescricao_p, nr_sequencia_w, nr_seq_horario_w, nm_usuario_p);			
			
			if (coalesce(nr_seq_classif_param_w ,0) > 0)	then
				begin
				update	prescr_mat_hor
				set	nr_seq_classif		= nr_seq_classif_param_w
				where	nr_prescricao		= nr_prescricao_p	
				and	nr_sequencia		= nr_seq_horario_w;
				end;
			else			
				open C05;
				loop
				fetch C05 into	
					nr_seq_classif_w,
					ie_classif_urgente_w,
					ie_controlado_w,
					ie_padronizado_w;
				EXIT WHEN NOT FOUND; /* apply on C05 */
					begin

					
					if (ie_controlado_w = 'A') and (ie_padronizado_w = 'A') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p	
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'S') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_padronizado		= 'S'
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'N') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_padronizado		= 'N'
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'A') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_controlado		= 'N'
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'N') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_controlado		= 'N'
						and	ie_padronizado		= 'N'
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'S') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_controlado		= 'N'
						and	ie_padronizado		= 'S'
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'A') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_controlado		= 'S'
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'N') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_controlado		= 'S'
						and	ie_padronizado		= 'N'						
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'S') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_controlado		= 'S'
						and	ie_padronizado		= 'S'						
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					end if;



					end;
				end loop;
				close C05;

			end if;
			
			if (ie_local_estoque_mat_hor_w	= 'S') then
				CALL define_disp_prescr_mat_hor(nr_seq_horario_w, nr_prescricao_p, nr_sequencia_w, obter_perfil_ativo, nm_usuario_p);
			
				select	coalesce(max(cd_local_estoque),cd_local_estoque_w)
				into STRICT	cd_local_estoque_w
				from	prescr_mat_hor
				where	nr_sequencia	= nr_seq_horario_w;
				
				update	prescr_mat_hor
				set	nr_seq_turno	= coalesce(Obter_turno_horario_prescr(cd_estabelecimento_w, cd_setor_atendimento_w, to_char(dt_horario_aprazar_p,'hh24:mi'), cd_local_estoque_w),nr_seq_turno)
				where	nr_sequencia	= nr_seq_horario_w;

			end if;
			/* OS 1574160
			if	(nvl(ie_origem_p,'X') <> 'AIS') and (nvl(ie_origem_p,'X') <> 'AES') and
				((ie_gerar_lote_ww not in ('N','A')) or
				(PKG_DATE_UTILS.start_of(dt_horario_aprazar_p,'mi',0) >= PKG_DATE_UTILS.start_of(SYSDATE,'mi',0))) then
				Gerar_Lote_Atend_Prescricao(nr_prescricao_p, nr_sequencia_w, nr_seq_horario_w, 'S', nm_usuario_p, 'AIP');
			end if;
			*/

			/*if	(ie_gera_integracao_w = 'S') then
				disp_prescr_mat_hor(nr_prescricao_p,nr_seq_horario_w,nm_usuario_p);
			end if;*/


			--Gerar os kits do item agrupado
            CALL aprazar_kit(nr_prescricao_p			=> nr_prescricao_p,
                        cd_setor_atendimento_p		=> cd_setor_atendimento_p,
                        nr_agrupamento_p	        => nr_agrupamento_p,
                        nm_usuario_p		        => nm_usuario_p,
                        nr_seq_dialise_p	        => nr_seq_dialise_p,
                        nr_atendimento_p	        => nr_atendimento_p,
                        ie_gerar_disp_farm_p	    	=> ie_gerar_disp_farm_p,
                        dt_horario_aprazar_p        	=> dt_horario_w,
                        ie_local_estoque_mat_hor_p  	=> ie_local_estoque_mat_hor_w,
                        ie_local_estoque_p          	=> ie_local_estoque_w,
                        dt_liberacao_p              	=> dt_liberacao_w,
                        cd_estabelecimento_p        	=> cd_estabelecimento_p,
                        ie_gerar_necessidade_disp_p 	=> ie_gerar_necessidade_disp_w,
                        nr_seq_classif_param_p      	=> nr_seq_classif_param_w,
                        ie_gerar_classif_agora_p    	=> ie_gerar_classif_agora_w,
                        dt_inicio_prescr_p          	=> dt_inicio_prescr_w,
                        ie_horario_adep_p           	=> ie_horario_adep_w,
                        ie_gera_integracao_p        	=> ie_gera_integracao_w,
                        ie_gerar_proc_gedipa_job_p  	=> ie_gerar_proc_gedipa_job_w,
                        nr_seq_superior_p           	=> nr_sequencia_w);
			
		end;
	end loop;
	close c03;
		
	open c04;
	loop
	fetch c04 into	nr_sequencia_w,
			cd_material_w,
			ie_agrupador_w,
			cd_local_estoque_w,
			cd_unidade_medida_dose_w,
			qt_total_dispensar_w,
			qt_dose_especial_w,
			qt_dose_w,
			cd_unidade_medida_w;
	EXIT WHEN NOT FOUND; /* apply on c04 */
		begin
				
		select	coalesce(min(nr_sequencia),0)
		into STRICT	nr_seq_min_hor_w
		from	prescr_mat_hor
		where	nr_prescricao 	= nr_prescricao_p
		and	nr_seq_material	= nr_sequencia_w
		and	coalesce(ie_situacao,'A') 	= 'A'
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

		if (nr_seq_min_hor_w > 0) then
			select	qt_dose,
				qt_dispensar,
				qt_dispensar_hor,
				cd_unidade_medida,
				cd_unidade_medida_dose
			into STRICT	qt_dose_w,
				qt_dispensar_w,
				qt_dispensar_hor_w,
				cd_unidade_medida_w,
				cd_unidade_medida_dose_w
			from	prescr_mat_hor
			where	nr_sequencia = nr_seq_min_hor_w
			and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
			
			qt_horario_w  := null;
			cd_unid_med_dose_hor_w := null;
			
			SELECT * FROM obter_dose_um_horario_pmh(cd_material_w, qt_dose_w, cd_unidade_medida_dose_w, qt_horario_w, cd_unid_med_dose_hor_w) INTO STRICT qt_horario_w, cd_unid_med_dose_hor_w;
			
		else		
			cd_unid_med_dose_hor_w := null;
			qt_dose_hor_w	:= null;		
			
			SELECT * FROM obter_dose_um_horario_pmh(cd_material_w, qt_dose_w, cd_unidade_medida_dose_w, qt_dose_hor_w, cd_unid_med_dose_hor_w) INTO STRICT qt_dose_hor_w, cd_unid_med_dose_hor_w;	
			
		end if;		
		
		select	nextval('prescr_mat_hor_seq')
		into STRICT	nr_seq_horario_w
		;		
		
		select	coalesce(max(qt_min_agora),0),
			coalesce(max(qt_min_especial),0),
			max(ie_classif_urgencia),
			coalesce(max(ie_forma_agora), 'N')
		into STRICT	qt_min_agora_w,
			qt_min_especial_w,
			ie_classif_nao_padrao_w,
			ie_agora_impressao_w
		from	parametros_farmacia
		where	cd_estabelecimento = cd_estabelecimento_w;
		
		select	coalesce(max(substr(Obter_se_medic_controlado(cd_material_w),1,1)),'N'),
			coalesce(max(substr(obter_se_material_padronizado(cd_estabelecimento_w, cd_material_w),1,1)),'N')
		into STRICT	ie_controlado_w,
			ie_padronizado_w
		;
		
		dt_limite_agora_w	:= dt_liberacao_w + qt_min_agora_w/1440;
		dt_limite_especial_w	:= dt_liberacao_w + qt_min_especial_w/1440;
		
		if (coalesce(ie_gerar_classif_agora_w,'N') = 'S') then
			dt_hora_atual_w := clock_timestamp();
			dt_limite_agora_w	:=  dt_hora_atual_w + qt_min_agora_w/1440; 			
		end if;
		
		ie_classif_urgente_w := definir_ie_classif_urgente(dt_horario_w,
                                                      cd_local_estoque_w,
                                                      cd_estabelecimento_w,
                                                      cd_setor_atendimento_w,
                                                      dt_inicio_prescr_w,
                                                      ie_classif_nao_padrao_w,
                                                      ie_padronizado_w,
                                                      dt_limite_especial_w,
                                                      dt_limite_agora_w,
                                                      ie_agora_impressao_w);	
		
		cd_setor_atendimento_w := cd_setor_atendimento_p;
		if (ie_local_estoque_w = 'S') then
			CALL define_local_disp_prescr(nr_prescricao_p, nr_sequencia_w, obter_perfil_ativo, nm_usuario_p);
			select	max(cd_local_estoque)
			into STRICT	cd_local_estoque_w
			from	prescr_material b
			where	nr_prescricao	= nr_prescricao_p
			and	nr_sequencia	= nr_sequencia_w;
			
			cd_setor_atendimento_w		:= Obter_Setor_Atendimento(nr_atendimento_p);
		elsif (ie_local_estoque_w = 'R') then
			CALL define_local_disp_prescr(nr_prescricao_p, nr_sequencia_w, obter_perfil_ativo, nm_usuario_p);
			select	max(cd_local_estoque)
			into STRICT	cd_local_estoque_w
			from	prescr_material b
			where	nr_prescricao	= nr_prescricao_p
			and	nr_sequencia	= nr_sequencia_w;
			
			cd_setor_atendimento_w		:= Obter_Setor_Atendimento_lib(nr_atendimento_p);
		end if;
		
		ie_liberado_w := 'N';
				
		select	coalesce(max('S'),'N')
		into STRICT	ie_liberado_w
		from	prescr_mat_hor	
		where	nr_prescricao = nr_prescricao_p
		and	(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '');		
		
		insert into prescr_mat_hor(
			nr_sequencia,
			nr_seq_digito,
			nr_prescricao,
			nr_seq_material,
			ie_agrupador,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_material,
			qt_dose,
			qt_dispensar_hor,
			ds_horario,
			dt_horario,
			cd_unidade_medida,
			cd_unidade_medida_dose,
			ie_urgente,
			dt_emissao_farmacia,
			dt_fim_horario,
			dt_suspensao,
			ie_horario_especial,
			qt_hor_reaprazamento,
			nm_usuario_reaprazamento,
			nr_seq_turno,
			dt_disp_farmacia,
			ie_aprazado,
			ie_padronizado,
			ie_controlado,
			ie_classif_urgente,
			qt_horario,
			cd_unid_med_hor,
			qt_dispensar,
			nr_seq_superior,
			dt_lib_horario,
			nr_seq_dialise,
			nr_atendimento,
			nr_agrupamento,
			ie_horario_adep
			)
		values (
			nr_seq_horario_w,
			calcula_digito('MODULO11',nr_seq_horario_w),
			nr_prescricao_p,
			nr_sequencia_w,
			ie_agrupador_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_material_w,
			qt_dose_w,
			coalesce(qt_dispensar_hor_w,qt_dose_hor_w),
			to_char(dt_horario_aprazar_p,'hh24:mi'),
			dt_horario_w,
			cd_unidade_medida_w,
			cd_unidade_medida_dose_w,
			'N',
			CASE WHEN ie_gerar_disp_farm_p='S' THEN null  ELSE clock_timestamp() END ,
			null,
			null,
			'N',
			null,
			null,
			obter_turno_horario_prescr(cd_estabelecimento_p,cd_setor_atendimento_w,to_char(dt_horario_aprazar_p,'hh24:mi'),cd_local_estoque_w),
			clock_timestamp(),
			'S',
			ie_padronizado_w,
			ie_controlado_w,
			ie_classif_urgente_w,
			coalesce(qt_horario_w,qt_dose_hor_w),
			cd_unid_med_dose_hor_w,
			qt_total_dispensar_w,
			nr_seq_superior_p,
			clock_timestamp(),
			nr_seq_dialise_p,
			nr_atendimento_p,
			nr_agrupamento_p,
			ie_horario_adep_w);
			
		if (ie_gerar_proc_gedipa_job_w = 'N') then
			CALL Gedipa_Gerar_Proc_Instantaneo(nr_prescricao_p,nr_sequencia_w,null,nr_seq_horario_w);
		end if;			
			
		CALL Gerar_Gedi_Medic_atend(cd_estabelecimento_w, nr_prescricao_p, nr_sequencia_w, nr_seq_horario_w, nm_usuario_p);
		CALL calcular_dispensar_hor_kit(nr_prescricao_p, nr_seq_horario_w,null,null);
		
		if (coalesce(nr_seq_classif_param_w ,0) > 0)	then
			begin
			update	prescr_mat_hor
			set	nr_seq_classif		= nr_seq_classif_param_w
			where	nr_prescricao		= nr_prescricao_p	
			and	nr_sequencia		= nr_seq_horario_w;
			end;
		else				
			open C05;
			loop
			fetch C05 into	
				nr_seq_classif_w,
				ie_classif_urgente_w,
				ie_controlado_w,
				ie_padronizado_w;
			EXIT WHEN NOT FOUND; /* apply on C05 */
				begin

				
				if (ie_controlado_w = 'A') and (ie_padronizado_w = 'A') then
					update	prescr_mat_hor
					set	nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p	
					and	nr_sequencia		= nr_seq_horario_w
					and	ie_classif_urgente	= ie_classif_urgente_w;
				elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'S') then
					update	prescr_mat_hor
					set	nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p
					and	ie_padronizado		= 'S'
					and	nr_sequencia		= nr_seq_horario_w
					and	ie_classif_urgente	= ie_classif_urgente_w;
				elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'N') then
					update	prescr_mat_hor
					set	nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p
					and	ie_padronizado		= 'N'
					and	nr_sequencia		= nr_seq_horario_w
					and	ie_classif_urgente	= ie_classif_urgente_w;
				elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'A') then
					update	prescr_mat_hor
					set	nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p
					and	ie_controlado		= 'N'
					and	nr_sequencia		= nr_seq_horario_w
					and	ie_classif_urgente	= ie_classif_urgente_w;
				elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'N') then
					update	prescr_mat_hor
					set	nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p
					and	ie_controlado		= 'N'
					and	ie_padronizado		= 'N'
					and	nr_sequencia		= nr_seq_horario_w
					and	ie_classif_urgente	= ie_classif_urgente_w;
				elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'S') then
					update	prescr_mat_hor
					set	nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p
					and	ie_controlado		= 'N'
					and	ie_padronizado		= 'S'
					and	nr_sequencia		= nr_seq_horario_w
					and	ie_classif_urgente	= ie_classif_urgente_w;
				elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'A') then
					update	prescr_mat_hor
					set	nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p
					and	ie_controlado		= 'S'
					and	nr_sequencia		= nr_seq_horario_w
					and	ie_classif_urgente	= ie_classif_urgente_w;
				elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'N') then
					update	prescr_mat_hor
					set	nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p
					and	ie_controlado		= 'S'
					and	ie_padronizado		= 'N'						
					and	nr_sequencia		= nr_seq_horario_w
					and	ie_classif_urgente	= ie_classif_urgente_w;
				elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'S') then
					update	prescr_mat_hor
					set	nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p
					and	ie_controlado		= 'S'
					and	ie_padronizado		= 'S'						
					and	nr_sequencia		= nr_seq_horario_w
					and	ie_classif_urgente	= ie_classif_urgente_w;
				end if;



				end;
			end loop;
			close C05;
		end if;
		
		if (ie_local_estoque_mat_hor_w	= 'S') then
			CALL define_disp_prescr_mat_hor(nr_seq_horario_w, nr_prescricao_p, nr_sequencia_w, obter_perfil_ativo, nm_usuario_p);
		
			select	coalesce(max(cd_local_estoque),cd_local_estoque_w)
			into STRICT	cd_local_estoque_w
			from	prescr_mat_hor
			where	nr_sequencia	= nr_seq_horario_w;
			
			update	prescr_mat_hor
			set	nr_seq_turno	= coalesce(Obter_turno_horario_prescr(cd_estabelecimento_w, cd_setor_atendimento_w, to_char(dt_horario_aprazar_p,'hh24:mi'), cd_local_estoque_w),nr_seq_turno)
			where	nr_sequencia	= nr_seq_horario_w;
		end if;
		
		if (ie_gerar_necessidade_disp_w = 'S') then
			update	prescr_medica
			set	dt_emissao_farmacia	 = NULL,
				nm_usuario_imp_far	 = NULL
			where	nr_prescricao		= nr_prescricao_p;
				
			update	prescr_material
			set	cd_motivo_baixa	= 0,
				dt_baixa	 = NULL
			where	nr_prescricao	= nr_prescricao_p
			and	nr_sequencia	= nr_sequencia_w;						
		end if;	
	
		if (ie_gera_integracao_w = 'S') then
			CALL disp_prescr_mat_hor(nr_prescricao_p,nr_seq_horario_w,nm_usuario_p);
		end if;		
		end;
	end loop;
	close c04;
	
	open c06;
	loop
	fetch c06 into	nr_sequencia_w,
			cd_material_w,
			ie_agrupador_w,
			cd_local_estoque_w,
			cd_unidade_medida_w;
	EXIT WHEN NOT FOUND; /* apply on c06 */
		begin
		
		select	cd_setor_atendimento
		into STRICT	cd_setor_atendimento_w
		from	prescr_medica
		where	nr_prescricao = nr_prescricao_p;
		
		if (ie_local_estoque_w = 'S') then
			CALL define_local_disp_prescr(nr_prescricao_p, nr_sequencia_w, obter_perfil_ativo, nm_usuario_p);
			select	max(cd_local_estoque)
			into STRICT	cd_local_estoque_w
			from	prescr_material b
			where	nr_prescricao	= nr_prescricao_p
			and	nr_sequencia	= nr_sequencia_w;
			
			cd_setor_atendimento_w		:= Obter_Setor_Atendimento(nr_atendimento_p);
		elsif (ie_local_estoque_w = 'R') then
			CALL define_local_disp_prescr(nr_prescricao_p, nr_sequencia_w, obter_perfil_ativo, nm_usuario_p);
			select	max(cd_local_estoque)
			into STRICT	cd_local_estoque_w
			from	prescr_material b
			where	nr_prescricao	= nr_prescricao_p
			and	nr_sequencia	= nr_sequencia_w;
			
			cd_setor_atendimento_w		:= Obter_Setor_Atendimento_lib(nr_atendimento_p);
		end if;
		
		select	coalesce(min(nr_sequencia),0)
		into STRICT	nr_seq_min_hor_w
		from	prescr_mat_hor
		where	nr_prescricao 	= nr_prescricao_p
		and	nr_seq_material	= nr_sequencia_w
		and	coalesce(ie_situacao,'A') 	= 'A'
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

		if (nr_seq_min_hor_w > 0) then
			select	qt_dose,
				qt_dispensar,
				qt_dispensar_hor,
				cd_unidade_medida,
				cd_unidade_medida_dose
			into STRICT	qt_dose_w,
				qt_dispensar_w,
				qt_dispensar_hor_w,
				cd_unidade_medida_w,
				cd_unidade_medida_dose_w
			from	prescr_mat_hor
			where	nr_sequencia = nr_seq_min_hor_w
			and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
		end if;		
		
		select	nextval('prescr_mat_hor_seq')
		into STRICT	nr_seq_horario_w
		;
		
		select	coalesce(max(qt_min_agora),0),
			coalesce(max(qt_min_especial),0),
			max(ie_classif_urgencia),
			coalesce(max(ie_forma_agora), 'N')
		into STRICT	qt_min_agora_w,
			qt_min_especial_w,
			ie_classif_nao_padrao_w,
			ie_agora_impressao_w
		from	parametros_farmacia
		where	cd_estabelecimento = cd_estabelecimento_w;
		
		select	coalesce(max(substr(Obter_se_medic_controlado(cd_material_w),1,1)),'N'),
			coalesce(max(substr(obter_se_material_padronizado(cd_estabelecimento_w, cd_material_w),1,1)),'N')
		into STRICT	ie_controlado_w,
			ie_padronizado_w
		;
		
		dt_limite_agora_w	:= dt_liberacao_w + qt_min_agora_w/1440;
		dt_limite_especial_w	:= dt_liberacao_w + qt_min_especial_w/1440;
		
		if (coalesce(ie_gerar_classif_agora_w,'N') = 'S') then
			dt_hora_atual_w := clock_timestamp();
			dt_limite_agora_w	:=  dt_hora_atual_w + qt_min_agora_w/1440; 			
		end if;
		
		ie_classif_urgente_w := definir_ie_classif_urgente(dt_horario_w,
														  cd_local_estoque_w,
														  cd_estabelecimento_w,
														  cd_setor_atendimento_w,
														  dt_inicio_prescr_w,
														  ie_classif_nao_padrao_w,
														  ie_padronizado_w,
														  dt_limite_especial_w,
														  dt_limite_agora_w,
														  ie_agora_impressao_w);	
				
		ie_liberado_w := 'N';
				
		select	coalesce(max('S'),'N')
		into STRICT	ie_liberado_w
		from	prescr_mat_hor	
		where	nr_prescricao = nr_prescricao_p
		and	(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '');

		insert into prescr_mat_hor(
			nr_sequencia,
			nr_seq_digito,
			nr_prescricao,
			nr_seq_material,
			ie_agrupador,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_material,
			qt_dose,			
			ds_horario,
			dt_horario,
			cd_unidade_medida,
			cd_unidade_medida_dose,
			ie_urgente,
			dt_emissao_farmacia,
			dt_fim_horario,
			dt_suspensao,
			ie_horario_especial,
			qt_hor_reaprazamento,
			nm_usuario_reaprazamento,
			nr_seq_turno,
			dt_disp_farmacia,
			ie_aprazado,
			ie_padronizado,
			ie_controlado,
			ie_classif_urgente,
			dt_lib_horario,
			nr_seq_dialise,
			nr_seq_hor_glic,
			qt_dispensar_hor,
			nr_atendimento,
			nr_agrupamento,
			ie_horario_adep
			)
		values (
			nr_seq_horario_w,
			calcula_digito('MODULO11',nr_seq_horario_w),
			nr_prescricao_p,
			nr_sequencia_w,
			ie_agrupador_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_material_w,
			qt_dose_w,			
			to_char(dt_horario_aprazar_p,'hh24:mi'),
			dt_horario_w,
			cd_unidade_medida_w,
			cd_unidade_medida_dose_w,
			'N',
			CASE WHEN ie_gerar_disp_farm_p='S' THEN null  ELSE clock_timestamp() END ,
			null,
			null,
			'N',
			null,
			null,
			obter_turno_horario_prescr(coalesce(cd_estabelecimento_p,cd_estabelecimento_w),cd_setor_atendimento_w,to_char(dt_horario_aprazar_p,'hh24:mi'),cd_local_estoque_w),
			clock_timestamp(),
			'S',
			ie_padronizado_w,
			ie_controlado_w,
			ie_classif_urgente_w,
			clock_timestamp(),
			nr_seq_dialise_p,
			nr_seq_hor_glic_p,
			qt_dispensar_hor_w,
			nr_atendimento_p,
			nr_agrupamento_p,
			ie_horario_adep_w);
			
			if (ie_gerar_proc_gedipa_job_w = 'N') then
				CALL Gedipa_Gerar_Proc_Instantaneo(nr_prescricao_p,nr_sequencia_w,null,nr_seq_horario_w);
			end if;			
			
			CALL Gerar_Gedi_Medic_atend(cd_estabelecimento_w, nr_prescricao_p, nr_sequencia_w, nr_seq_horario_w, nm_usuario_p);
			
			if (coalesce(nr_seq_classif_param_w ,0) > 0)	then
				begin
				update	prescr_mat_hor
				set	nr_seq_classif		= nr_seq_classif_param_w
				where	nr_prescricao		= nr_prescricao_p	
				and	nr_sequencia		= nr_seq_horario_w;
				end;
			else
				open C05;
				loop
				fetch C05 into	
					nr_seq_classif_w,
					ie_classif_urgente_w,
					ie_controlado_w,
					ie_padronizado_w;
				EXIT WHEN NOT FOUND; /* apply on C05 */
					begin

					
					if (ie_controlado_w = 'A') and (ie_padronizado_w = 'A') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p	
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'S') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_padronizado		= 'S'
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'N') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_padronizado		= 'N'
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'A') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_controlado		= 'N'
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'N') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_controlado		= 'N'
						and	ie_padronizado		= 'N'
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'S') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_controlado		= 'N'
						and	ie_padronizado		= 'S'
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'A') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_controlado		= 'S'
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'N') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_controlado		= 'S'
						and	ie_padronizado		= 'N'						
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'S') then
						update	prescr_mat_hor
						set	nr_seq_classif		= nr_seq_classif_w
						where	nr_prescricao		= nr_prescricao_p
						and	ie_controlado		= 'S'
						and	ie_padronizado		= 'S'						
						and	nr_sequencia		= nr_seq_horario_w
						and	ie_classif_urgente	= ie_classif_urgente_w;
					end if;



					end;
				end loop;
				close C05;		
			end if;
			
			if (ie_gerar_necessidade_disp_w = 'S') then
				update	prescr_medica
				set	dt_emissao_farmacia	 = NULL,
					nm_usuario_imp_far	 = NULL
				where	nr_prescricao		= nr_prescricao_p;
					
				update	prescr_material
				set	cd_motivo_baixa	= 0,
					dt_baixa	 = NULL
				where	nr_prescricao	= nr_prescricao_p
				and	nr_sequencia	= nr_sequencia_w;						
			end if;	

			if (ie_gera_integracao_w = 'S') then
				CALL disp_prescr_mat_hor(nr_prescricao_p,nr_seq_horario_w,nm_usuario_p);
			end if;			
			end;
	end loop;
	close c06;
	
	-- A chamada da Gerar_Lote_Atend_Prescricao foi retirada de dentro do cursor c06 e gerou erros, 

	-- gerou lotes do itens principais.

	-- A chamada p/ geracao do lote deve ocorrer no aprazamento do item principal.

	/*
	if	(nvl(ie_origem_p,'X') = 'AID') and
		((ie_gerar_lote_ww not in ('N','A')) or
		 (trunc(dt_horario_aprazar_p,'mi') >= trunc(sysdate,'mi'))) then
		Gerar_Lote_Atend_Prescricao(nr_prescricao_p, 0, 0, 'S', nm_usuario_p, 'AIP');
	end if; */
		
	open c07;
	loop
	fetch c07 into	nr_sequencia_w,
			cd_material_w,
			ie_agrupador_w,
			cd_local_estoque_w,
			cd_unidade_medida_dose_w,
			qt_total_dispensar_w,
			qt_dose_especial_w,
			qt_dose_w,
			cd_unidade_medida_w;
	EXIT WHEN NOT FOUND; /* apply on c07 */
		begin
		
		select	coalesce(min(nr_sequencia),0)
		into STRICT	nr_seq_min_hor_w
		from	prescr_mat_hor
		where	nr_prescricao 	= nr_prescricao_p
		and	nr_seq_material	= nr_sequencia_w
		and	coalesce(ie_situacao,'A') 	= 'A'
		and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

		if (nr_seq_min_hor_w > 0) then
			select	qt_dose,
				qt_dispensar,
				qt_dispensar_hor,
				cd_unidade_medida,
				cd_unidade_medida_dose
			into STRICT	qt_dose_w,
				qt_dispensar_w,
				qt_dispensar_hor_w,
				cd_unidade_medida_w,
				cd_unidade_medida_dose_w
			from	prescr_mat_hor
			where	nr_sequencia = nr_seq_min_hor_w
			and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
		else		
			cd_unid_med_dose_hor_w := null;
			qt_dose_hor_w	:= null;		
			
			SELECT * FROM obter_dose_um_horario_pmh(cd_material_w, qt_dose_w, cd_unidade_medida_dose_w, qt_dose_hor_w, cd_unid_med_dose_hor_w) INTO STRICT qt_dose_hor_w, cd_unid_med_dose_hor_w;
		end if;		
		
		
		select	nextval('prescr_mat_hor_seq')
		into STRICT	nr_seq_horario_w
		;		
		
		select	coalesce(max(qt_min_agora),0),
			coalesce(max(qt_min_especial),0),
			max(ie_classif_urgencia),
			coalesce(max(ie_forma_agora), 'N')
		into STRICT	qt_min_agora_w,
			qt_min_especial_w,
			ie_classif_nao_padrao_w,
			ie_agora_impressao_w
		from	parametros_farmacia
		where	cd_estabelecimento = cd_estabelecimento_w;
		
		select	coalesce(max(substr(Obter_se_medic_controlado(cd_material_w),1,1)),'N'),
			coalesce(max(substr(obter_se_material_padronizado(cd_estabelecimento_w, cd_material_w),1,1)),'N')
		into STRICT	ie_controlado_w,
			ie_padronizado_w
		;
		
		dt_limite_agora_w	:= dt_liberacao_w + qt_min_agora_w/1440;
		dt_limite_especial_w	:= dt_liberacao_w + qt_min_especial_w/1440;
		
		if (coalesce(ie_gerar_classif_agora_w,'N') = 'S') then
			dt_hora_atual_w := clock_timestamp();
			dt_limite_agora_w	:=  dt_hora_atual_w + qt_min_agora_w/1440; 			
		end if;
		
		ie_classif_urgente_w := definir_ie_classif_urgente(dt_horario_w,
														  cd_local_estoque_w,
														  cd_estabelecimento_w,
														  cd_setor_atendimento_w,
														  dt_inicio_prescr_w,
														  ie_classif_nao_padrao_w,
														  ie_padronizado_w,
														  dt_limite_especial_w,
														  dt_limite_agora_w,
														  ie_agora_impressao_w);	
				
		ie_liberado_w := 'N';
				
		select	coalesce(max('S'),'N')
		into STRICT	ie_liberado_w
		from	prescr_mat_hor	
		where	nr_prescricao = nr_prescricao_p
		and	(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '');
		
		insert into prescr_mat_hor(
			nr_sequencia,
			nr_seq_digito,
			nr_prescricao,
			nr_seq_material,
			ie_agrupador,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_material,
			qt_dose,
			qt_dispensar_hor,
			ds_horario,
			dt_horario,
			cd_unidade_medida,
			cd_unidade_medida_dose,
			ie_urgente,
			dt_emissao_farmacia,
			dt_fim_horario,
			dt_suspensao,
			ie_horario_especial,
			qt_hor_reaprazamento,
			nm_usuario_reaprazamento,
			nr_seq_turno,
			dt_disp_farmacia,
			ie_aprazado,
			ie_padronizado,
			ie_controlado,
			ie_classif_urgente,
			qt_horario,
			cd_unid_med_hor,
			qt_dispensar,
			dt_lib_horario	,
			nr_seq_dialise,
			nr_atendimento,
			nr_agrupamento,
			ie_horario_adep
			)
		values (
			nr_seq_horario_w,
			calcula_digito('MODULO11',nr_seq_horario_w),
			nr_prescricao_p,
			nr_sequencia_w,
			ie_agrupador_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_material_w,
			qt_dose_w,
			qt_dispensar_hor_w,
			to_char(dt_horario_aprazar_p,'hh24:mi'),
			dt_horario_w,
			cd_unidade_medida_w,
			cd_unidade_medida_dose_w,
			'N',
			CASE WHEN ie_gerar_disp_farm_p='S' THEN null  ELSE clock_timestamp() END ,
			null,
			null,
			'N',
			null,
			null,
			obter_turno_horario_prescr(cd_estabelecimento_p,cd_setor_atendimento_p,to_char(dt_horario_aprazar_p,'hh24:mi'),cd_local_estoque_w),
			clock_timestamp(),
			'S',
			ie_padronizado_w,
			ie_controlado_w,
			ie_classif_urgente_w,
			qt_dose_hor_w,
			cd_unid_med_dose_hor_w,
			qt_total_dispensar_w,
			clock_timestamp(),
			nr_seq_dialise_p,
			nr_atendimento_p,
			nr_agrupamento_p,
			ie_horario_adep_w
			);
		if (ie_gerar_proc_gedipa_job_w = 'N') then
			CALL Gedipa_Gerar_Proc_Instantaneo(nr_prescricao_p,nr_sequencia_w,null,nr_seq_horario_w);
		end if;			
		CALL Gerar_Gedi_Medic_atend(cd_estabelecimento_w, nr_prescricao_p, nr_sequencia_w, nr_seq_horario_w, nm_usuario_p);
			
		update	prescr_material
		set	dt_baixa	 = NULL,
			cd_motivo_baixa	= 0
		where	nr_prescricao	= nr_prescricao_p
		and	nr_sequencia	= nr_sequencia_w;
			
			--calcular_dispensar_hor_kit(nr_prescricao_p, nr_seq_horario_w);
		if (coalesce(nr_seq_classif_param_w ,0) > 0)	then
				begin
				update	prescr_mat_hor
				set	nr_seq_classif		= nr_seq_classif_param_w
				where	nr_prescricao		= nr_prescricao_p	
				and	nr_sequencia		= nr_seq_horario_w;
				end;
		else			
			open C05;
			loop
			fetch C05 into	
				nr_seq_classif_w,
				ie_classif_urgente_w,
				ie_controlado_w,
				ie_padronizado_w;
			EXIT WHEN NOT FOUND; /* apply on C05 */
				begin

				
				if (ie_controlado_w = 'A') and (ie_padronizado_w = 'A') then
					update	prescr_mat_hor
					set	nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p	
					and	nr_sequencia		= nr_seq_horario_w
					and	ie_classif_urgente	= ie_classif_urgente_w;
				elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'S') then
					update	prescr_mat_hor
					set	nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p
					and	ie_padronizado		= 'S'
					and	nr_sequencia		= nr_seq_horario_w
					and	ie_classif_urgente	= ie_classif_urgente_w;
				elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'N') then
					update	prescr_mat_hor
					set	nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p
					and	ie_padronizado		= 'N'
					and	nr_sequencia		= nr_seq_horario_w
					and	ie_classif_urgente	= ie_classif_urgente_w;
				elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'A') then
					update	prescr_mat_hor
					set	nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p
					and	ie_controlado		= 'N'
					and	nr_sequencia		= nr_seq_horario_w
					and	ie_classif_urgente	= ie_classif_urgente_w;
				elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'N') then
					update	prescr_mat_hor
					set	nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p
					and	ie_controlado		= 'N'
					and	ie_padronizado		= 'N'
					and	nr_sequencia		= nr_seq_horario_w
					and	ie_classif_urgente	= ie_classif_urgente_w;
				elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'S') then
					update	prescr_mat_hor
					set	nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p
					and	ie_controlado		= 'N'
					and	ie_padronizado		= 'S'
					and	nr_sequencia		= nr_seq_horario_w
					and	ie_classif_urgente	= ie_classif_urgente_w;
				elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'A') then
					update	prescr_mat_hor
					set	nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p
					and	ie_controlado		= 'S'
					and	nr_sequencia		= nr_seq_horario_w
					and	ie_classif_urgente	= ie_classif_urgente_w;
				elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'N') then
					update	prescr_mat_hor
					set	nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p
					and	ie_controlado		= 'S'
					and	ie_padronizado		= 'N'						
					and	nr_sequencia		= nr_seq_horario_w
					and	ie_classif_urgente	= ie_classif_urgente_w;
				elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'S') then
					update	prescr_mat_hor
					set	nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p
					and	ie_controlado		= 'S'
					and	ie_padronizado		= 'S'						
					and	nr_sequencia		= nr_seq_horario_w
					and	ie_classif_urgente	= ie_classif_urgente_w;
				end if;

				end;
			end loop;
			close C05;
		end if;		
		end;
	end loop;
	close c07;
	
	-- Itens de kits da recomendacao
	
	open c09;
	loop
	fetch c09 into	nr_sequencia_w,
					cd_material_w,
					ie_agrupador_w,
					cd_local_estoque_w,
					cd_unidade_medida_dose_w,
					qt_total_dispensar_w,
					qt_dose_especial_w,
					qt_dose_w,
					cd_unidade_medida_w,
					nr_agrupamento_w;
	EXIT WHEN NOT FOUND; /* apply on c09 */
		begin
		
		select	coalesce(min(nr_sequencia),0)
		into STRICT	nr_seq_min_hor_w
		from	prescr_mat_hor
		where	nr_prescricao 	= nr_prescricao_p
		and		nr_seq_material	= nr_sequencia_w
		and		coalesce(ie_situacao,'A') 	= 'A'
		and		Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';

		if (nr_seq_min_hor_w > 0) then
			select	qt_dose,
					qt_dispensar,
					qt_dispensar_hor,
					cd_unidade_medida,
					cd_unidade_medida_dose
			into STRICT	qt_dose_w,
					qt_dispensar_w,
					qt_dispensar_hor_w,
					cd_unidade_medida_w,
					cd_unidade_medida_dose_w
			from	prescr_mat_hor
			where	nr_sequencia = nr_seq_min_hor_w
			and		Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
		else		
			cd_unid_med_dose_hor_w := null;
			qt_dose_hor_w	:= null;		
			
			SELECT * FROM obter_dose_um_horario_pmh(cd_material_w, qt_dose_w, cd_unidade_medida_dose_w, qt_dose_hor_w, cd_unid_med_dose_hor_w) INTO STRICT qt_dose_hor_w, cd_unid_med_dose_hor_w;
		end if;		
		
		
		select	nextval('prescr_mat_hor_seq')
		into STRICT	nr_seq_horario_w
		;		
		
		select	coalesce(max(qt_min_agora),0),
				coalesce(max(qt_min_especial),0),
				max(ie_classif_urgencia),
				coalesce(max(ie_forma_agora), 'N')
		into STRICT	qt_min_agora_w,
				qt_min_especial_w,
				ie_classif_nao_padrao_w,
				ie_agora_impressao_w
		from	parametros_farmacia
		where	cd_estabelecimento = cd_estabelecimento_w;
		
		select	coalesce(max(substr(Obter_se_medic_controlado(cd_material_w),1,1)),'N'),
				coalesce(max(substr(obter_se_material_padronizado(cd_estabelecimento_w, cd_material_w),1,1)),'N')
		into STRICT	ie_controlado_w,
				ie_padronizado_w
		;
		
		dt_limite_agora_w	:= dt_liberacao_w + qt_min_agora_w/1440;
		dt_limite_especial_w	:= dt_liberacao_w + qt_min_especial_w/1440;
		
		if (coalesce(ie_gerar_classif_agora_w,'N') = 'S') then
			dt_hora_atual_w := clock_timestamp();
			dt_limite_agora_w	:=  dt_hora_atual_w + qt_min_agora_w/1440; 			
		end if;
		
		ie_classif_urgente_w := definir_ie_classif_urgente(dt_horario_w,
														  cd_local_estoque_w,
														  cd_estabelecimento_w,
														  cd_setor_atendimento_w,
														  dt_inicio_prescr_w,
														  ie_classif_nao_padrao_w,
														  ie_padronizado_w,
														  dt_limite_especial_w,
														  dt_limite_agora_w,
														  ie_agora_impressao_w);	
				
		ie_liberado_w := 'N';
				
		select	coalesce(max('S'),'N')
		into STRICT	ie_liberado_w
		from	prescr_mat_hor	
		where	nr_prescricao = nr_prescricao_p
		and		(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '');
		
		insert into prescr_mat_hor(
			nr_sequencia,
			nr_seq_digito,
			nr_prescricao,
			nr_seq_material,
			ie_agrupador,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_material,
			qt_dose,
			qt_dispensar_hor,
			ds_horario,
			dt_horario,
			cd_unidade_medida,
			cd_unidade_medida_dose,
			ie_urgente,
			dt_emissao_farmacia,
			dt_fim_horario,
			dt_suspensao,
			ie_horario_especial,
			qt_hor_reaprazamento,
			nm_usuario_reaprazamento,
			nr_seq_turno,
			dt_disp_farmacia,
			ie_aprazado,
			ie_padronizado,
			ie_controlado,
			ie_classif_urgente,
			qt_horario,
			cd_unid_med_hor,
			qt_dispensar,
			dt_lib_horario	,
			nr_seq_dialise,
			nr_atendimento,
			nr_agrupamento,
			ie_horario_adep
			)
		values (
			nr_seq_horario_w,
			calcula_digito('MODULO11',nr_seq_horario_w),
			nr_prescricao_p,
			nr_sequencia_w,
			ie_agrupador_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_material_w,
			qt_dose_w,
			qt_dispensar_hor_w,
			to_char(dt_horario_aprazar_p,'hh24:mi'),
			dt_horario_w,
			cd_unidade_medida_w,
			cd_unidade_medida_dose_w,
			'N',
			CASE WHEN ie_gerar_disp_farm_p='S' THEN null  ELSE clock_timestamp() END ,
			null,
			null,
			'N',
			null,
			null,
			obter_turno_horario_prescr(cd_estabelecimento_p,cd_setor_atendimento_p,to_char(dt_horario_aprazar_p,'hh24:mi'),cd_local_estoque_w),
			clock_timestamp(),
			'S',
			ie_padronizado_w,
			ie_controlado_w,
			ie_classif_urgente_w,
			qt_dose_hor_w,
			cd_unid_med_dose_hor_w,
			qt_total_dispensar_w,
			clock_timestamp(),
			nr_seq_dialise_p,
			nr_atendimento_p,
			nr_agrupamento_w,
			ie_horario_adep_w
			);
			
		if (ie_gerar_proc_gedipa_job_w = 'N') then
			CALL Gedipa_Gerar_Proc_Instantaneo(nr_prescricao_p,nr_sequencia_w,null,nr_seq_horario_w);
		end if;			
		CALL Gerar_Gedi_Medic_atend(cd_estabelecimento_w, nr_prescricao_p, nr_sequencia_w, nr_seq_horario_w, nm_usuario_p);
			
		update	prescr_material
		set		dt_baixa	 = NULL,
				cd_motivo_baixa	= 0
		where	nr_prescricao	= nr_prescricao_p
		and		nr_sequencia	= nr_sequencia_w;
			
			--calcular_dispensar_hor_kit(nr_prescricao_p, nr_seq_horario_w);
		if (coalesce(nr_seq_classif_param_w ,0) > 0)	then
				begin
				update	prescr_mat_hor
				set		nr_seq_classif		= nr_seq_classif_param_w
				where	nr_prescricao		= nr_prescricao_p	
				and		nr_sequencia		= nr_seq_horario_w;
				end;
		else			
			open C05;
			loop
			fetch C05 into	
				nr_seq_classif_w,
				ie_classif_urgente_w,
				ie_controlado_w,
				ie_padronizado_w;
			EXIT WHEN NOT FOUND; /* apply on C05 */
				begin
					
				if (ie_controlado_w = 'A') and (ie_padronizado_w = 'A') then
					update	prescr_mat_hor
					set		nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p	
					and		nr_sequencia		= nr_seq_horario_w
					and		ie_classif_urgente	= ie_classif_urgente_w;
				elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'S') then
					update	prescr_mat_hor
					set		nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p
					and		ie_padronizado		= 'S'
					and		nr_sequencia		= nr_seq_horario_w
					and		ie_classif_urgente	= ie_classif_urgente_w;
				elsif (ie_controlado_w = 'A') and (ie_padronizado_w = 'N') then
					update	prescr_mat_hor
					set		nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p
					and		ie_padronizado		= 'N'
					and		nr_sequencia		= nr_seq_horario_w
					and		ie_classif_urgente	= ie_classif_urgente_w;
				elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'A') then
					update	prescr_mat_hor
					set		nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p
					and		ie_controlado		= 'N'
					and		nr_sequencia		= nr_seq_horario_w
					and		ie_classif_urgente	= ie_classif_urgente_w;
				elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'N') then
					update	prescr_mat_hor
					set		nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p
					and		ie_controlado		= 'N'
					and		ie_padronizado		= 'N'
					and		nr_sequencia		= nr_seq_horario_w
					and		ie_classif_urgente	= ie_classif_urgente_w;
				elsif (ie_controlado_w = 'N') and (ie_padronizado_w = 'S') then
					update	prescr_mat_hor
					set		nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p
					and		ie_controlado		= 'N'
					and		ie_padronizado		= 'S'
					and		nr_sequencia		= nr_seq_horario_w
					and		ie_classif_urgente	= ie_classif_urgente_w;
				elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'A') then
					update	prescr_mat_hor
					set		nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p
					and		ie_controlado		= 'S'
					and		nr_sequencia		= nr_seq_horario_w
					and		ie_classif_urgente	= ie_classif_urgente_w;
				elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'N') then
					update	prescr_mat_hor
					set		nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p
					and		ie_controlado		= 'S'
					and		ie_padronizado		= 'N'						
					and		nr_sequencia		= nr_seq_horario_w
					and		ie_classif_urgente	= ie_classif_urgente_w;
				elsif (ie_controlado_w = 'S') and (ie_padronizado_w = 'S') then
					update	prescr_mat_hor
					set		nr_seq_classif		= nr_seq_classif_w
					where	nr_prescricao		= nr_prescricao_p
					and		ie_controlado		= 'S'
					and		ie_padronizado		= 'S'						
					and		nr_sequencia		= nr_seq_horario_w
					and		ie_classif_urgente	= ie_classif_urgente_w;
				end if;

				end;
			end loop;
			close C05;
		end if;		
		end;
	end loop;
	close c09;
	
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE aprazar_itens_dependentes ( cd_estabelecimento_p bigint, cd_setor_atendimento_p bigint, nr_atendimento_p bigint, nr_prescricao_p bigint, nr_seq_superior_p bigint, nr_agrupamento_p bigint, dt_horario_aprazar_p timestamp, ie_gerar_disp_farm_p text, nm_usuario_p text, nr_seq_dialise_p bigint default null, nr_seq_hor_glic_p bigint default null, nr_seq_pergunta_p bigint default null, ie_horario_adep_p text DEFAULT NULL, ie_origem_p text DEFAULT NULL, nr_seq_gasoterapia_p prescr_gasoterapia.nr_sequencia%type default null) FROM PUBLIC;

