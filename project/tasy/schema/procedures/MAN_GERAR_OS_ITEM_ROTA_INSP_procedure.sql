-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_os_item_rota_insp ( nr_sequencia_p bigint, nr_ordem_servico_p INOUT bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_equipamento_w		bigint;
nr_seq_localizacao_w		bigint;
nr_seq_grupo_planej_w		bigint;
nr_seq_grupo_trabalho_w		bigint;
nr_seq_plano_inspecao_w		bigint;
nr_seq_rota_inspecao_w		bigint;
nr_seq_tipo_os_w			bigint;
cd_pessoa_solicitante_w		varchar(10);
cd_estabelecimento_w		smallint := wheb_usuario_pck.get_cd_estabelecimento;
nr_seq_regra_w			bigint;
ie_dia_semana_w			varchar(15);
dt_inicio_prev_w			timestamp := clock_timestamp();
dt_fim_previsto_w			timestamp := null;
dt_inicio_real_w			timestamp := null;
dt_inicio_desejado_w		timestamp := clock_timestamp();
dt_conclusao_desejada_w		timestamp := clock_timestamp() + interval '15 days';
nm_usuario_exec_w		varchar(15) := null;
ie_status_ordem_w			varchar(1) := '1';
nm_usuario_exec_prev_w		varchar(15);
ie_dt_inicio_real_w			varchar(1);
ie_gerar_os_proc_w		varchar(1);
ie_gerar_ativ_real_os_w		varchar(255);
dt_atividade_w			man_rota_insp_ativ_real.dt_atividade%type;
dt_fim_atividade_w			man_rota_insp_ativ_real.dt_fim_atividade%type;
nm_usuario_exec_ativ_w		man_rota_insp_ativ_real.nm_usuario_exec%type;
nr_seq_funcao_ativ_w		man_rota_insp_ativ_real.nr_seq_funcao%type;
qt_minuto_ativ_w			man_rota_insp_ativ_real.qt_minuto%type;
ds_atividade_w			man_rota_insp_ativ_real.ds_atividade%type;

C01 CURSOR FOR 
	SELECT	dt_atividade, 
		dt_fim_atividade, 
		nm_usuario_exec, 
		nr_seq_funcao, 
		qt_minuto, 
		ds_atividade 
	from	man_rota_insp_ativ_real 
	where	(nr_seq_funcao IS NOT NULL AND nr_seq_funcao::text <> '') 
	and	nr_seq_rota_inspecao = nr_seq_rota_inspecao_w;


BEGIN 
nr_seq_tipo_os_w := obter_param_usuario(294, 8, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, nr_seq_tipo_os_w);
ie_gerar_os_proc_w := obter_param_usuario(294, 23, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_gerar_os_proc_w);
ie_gerar_ativ_real_os_w := obter_param_usuario(294, 31, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_gerar_ativ_real_os_w);
ie_dt_inicio_real_w := obter_param_usuario(299, 61, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_dt_inicio_real_w);
 
select	a.nr_seq_equipamento, 
	b.nr_seq_plano_inspecao, 
	a.nr_seq_rota_inspecao 
into STRICT	nr_seq_equipamento_w, 
	nr_seq_plano_inspecao_w, 
	nr_seq_rota_inspecao_w 
from	man_rota_inspecao_item a, 
	man_rota_inspecao b 
where	a.nr_sequencia 		= nr_sequencia_p 
and	a.nr_seq_rota_inspecao 	= b.nr_sequencia;
 
select	nr_seq_local, 
	nr_seq_planej, 
	nr_seq_trab, 
	substr(obter_pessoa_fisica_usuario(nm_usuario_p,'C'),1,10) 
into STRICT	nr_seq_localizacao_w, 
	nr_seq_grupo_planej_w, 
	nr_seq_grupo_trabalho_w, 
	cd_pessoa_solicitante_w 
from	man_equipamento 
where	nr_sequencia = nr_seq_equipamento_w;
 
select	coalesce(max(nr_seq_grupo_planej),nr_seq_grupo_planej_w), 
	coalesce(max(nr_seq_grupo_trabalho),nr_seq_grupo_trabalho_w) 
into STRICT	nr_seq_grupo_planej_w, 
	nr_seq_grupo_trabalho_w 
from	man_plano_insp_exec 
where	nr_seq_plano_inspecao = nr_seq_plano_inspecao_w;
 
select	coalesce(max(nr_sequencia),0) 
into STRICT	nr_seq_regra_w 
from (	SELECT	nr_sequencia 
	from	man_plano_insp_regra 
	where	dt_inicial > clock_timestamp() 
	and	nr_seq_plano_inspecao = nr_seq_plano_inspecao_w 
	
union all
 
	SELECT	nr_sequencia 
	from	man_plano_insp_regra 
	where	coalesce(dt_inicial::text, '') = '' 
	and	nr_seq_plano_inspecao = nr_seq_plano_inspecao_w) alias4;
 
if (nr_seq_regra_w > 0) then 
	select	ie_dia_semana 
	into STRICT	ie_dia_semana_w 
	from	man_plano_insp_regra 
	where	nr_sequencia = nr_seq_regra_w;
 
	if (ie_dia_semana_w IS NOT NULL AND ie_dia_semana_w::text <> '') then 
		begin 
		/*calcular o pr√≥ximo dia de semana selecionado na regra*/
 
		if (pkg_date_utils.get_WeekDay(clock_timestamp()) < ie_dia_semana_w) then 
			select	clock_timestamp() + (ie_dia_semana_w - pkg_date_utils.get_WeekDay(clock_timestamp())) 
			into STRICT	dt_inicio_prev_w 
			;
		elsif (pkg_date_utils.get_WeekDay(clock_timestamp()) > ie_dia_semana_w) then 
			select	clock_timestamp() + (ie_dia_semana_w - pkg_date_utils.get_WeekDay(clock_timestamp())) + 7 
			into STRICT	dt_inicio_prev_w 
			;
		end if;
		end;
	end if;
end if;
 
 
if (coalesce(ie_gerar_os_proc_w,'N') = 'S') then 
	begin 
	ie_status_ordem_w := '2';
	nm_usuario_exec_w := nm_usuario_p;
	if (coalesce(dt_inicio_prev_w::text, '') = '') then 
		dt_inicio_prev_w := dt_inicio_desejado_w;
	end if;
	if (coalesce(dt_fim_previsto_w::text, '') = '') then 
		dt_fim_previsto_w := dt_conclusao_desejada_w;
	end if;
	if (coalesce(ie_dt_inicio_real_w,'N') = 'S') and (coalesce(dt_inicio_real_w::text, '') = '') then 
		dt_inicio_real_w := clock_timestamp();
	end if;
	end;
end if;
 
 
select	nextval('man_ordem_servico_seq') 
into STRICT	nr_ordem_servico_p
;
 
insert	into man_ordem_servico( 
	nr_sequencia, 
	nr_seq_localizacao, 
	nr_seq_equipamento, 
	cd_pessoa_solicitante, 
	dt_ordem_servico, 
	ie_prioridade, 
	ie_parado, 
	ds_dano_breve, 
	dt_atualizacao, 
	nm_usuario, 
	dt_inicio_desejado, 
	dt_conclusao_desejada, 
	ds_dano, 
	dt_inicio_previsto, 
	dt_fim_previsto, 
	dt_inicio_real, 
	dt_fim_real, 
	ie_tipo_ordem, 
	ie_status_ordem, 
	nr_grupo_planej, 
	nr_grupo_trabalho, 
	nr_seq_tipo_solucao, 
	ds_solucao, 
	nm_usuario_exec, 
	qt_contador, 
	nr_seq_planej, 
	nr_seq_tipo_contador, 
	nr_seq_estagio, 
	cd_projeto, 
	nr_seq_etapa_proj, 
	dt_reabertura, 
	cd_funcao, 
	nm_tabela, 
	ie_classificacao, 
	nr_seq_origem, 
	nr_seq_projeto, 
	ie_grau_satisfacao, 
	nr_seq_indicador, 
	nr_seq_causa_dano, 
	ie_forma_receb, 
	nr_seq_cliente, 
	nr_seq_grupo_des, 
	nr_seq_grupo_sup, 
	nr_seq_superior, 
	ie_eficacia, 
	dt_prev_eficacia, 
	cd_pf_eficacia, 
	nr_seq_nao_conform, 
	nr_seq_complex, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	ie_obriga_news, 
	nr_seq_meta_pe, 
	nr_seq_classif, 
	nr_seq_nivel_valor, 
	nm_usuario_lib_news, 
	dt_libera_news, 
	dt_envio_wheb, 
	ds_contato_solicitante, 
	ie_prioridade_desen, 
	ie_prioridade_sup, 
	ie_origem_os, 
	nr_seq_tipo_ordem) 
values (	nr_ordem_servico_p,			-- nr_sequencia, 
	nr_seq_localizacao_w,			-- nr_seq_localizacao, 
	nr_seq_equipamento_w,			-- nr_seq_equipamento, 
	cd_pessoa_solicitante_w,			-- cd_pessoa_solicitante, 
	clock_timestamp(),					-- dt_ordem_servico, 
	'M',					-- ie_prioridade, 
	'N',					-- ie_parado, 
	wheb_mensagem_pck.get_texto(305664,'NR_SEQ_ROTA_INSPECAO='||nr_seq_rota_inspecao_w),	-- ds_dano_breve, 
	clock_timestamp(),					-- dt_atualizacao, 
	nm_usuario_p,				-- nm_usuario, 
	dt_inicio_desejado_w,			-- dt_inicio_desejado, 
	dt_conclusao_desejada_w,			-- dt_conclusao_desejada, 
	wheb_mensagem_pck.get_texto(305664,'NR_SEQ_ROTA_INSPECAO='||nr_seq_rota_inspecao_w),	-- ds_dano, 
	dt_inicio_prev_w,				-- dt_inicio_previsto, 
	dt_fim_previsto_w,				-- dt_fim_previsto, 
	dt_inicio_real_w,				-- dt_inicio_real, 
	null,					-- dt_fim_real, 
	1,					-- ie_tipo_ordem, 
	ie_status_ordem_w,				-- ie_status_ordem, 
	nr_seq_grupo_planej_w,			-- nr_grupo_planej, 
	nr_seq_grupo_trabalho_w,			-- nr_grupo_trabalho, 
	null,					-- nr_seq_tipo_solucao, 
	null,					-- ds_solucao, 
	nm_usuario_exec_w, 			-- nm_usuario_exec, 
	null,					-- qt_contador, 
	null,					-- nr_seq_planej, 
	null,					-- nr_seq_tipo_contador, 
	null,					-- nr_seq_estagio, 
	null,					-- cd_projeto, 
	null,					-- nr_seq_etapa_proj, 
	null,					-- dt_reabertura, 
	null,					-- cd_funcao, 
	null,					-- nm_tabela, 
	'S',					-- ie_classificacao, 
	null,					-- nr_seq_origem, 
	null,					-- nr_seq_projeto, 
	null,					-- ie_grau_satisfacao, 
	null,					-- nr_seq_indicador, 
	null,					-- nr_seq_causa_dano, 
	null,					-- ie_forma_receb, 
	null,					-- nr_seq_cliente, 
	null,					-- nr_seq_grupo_des, 
	null,					-- nr_seq_grupo_sup, 
	null,					-- nr_seq_superior, 
	null,					-- ie_eficacia, 
	null,					-- dt_prev_eficacia, 
	null,					-- cd_pf_eficacia, 
	null,					-- nr_seq_nao_conform, 
	null,					-- nr_seq_complex, 
	null,					-- dt_atualizacao_nrec, 
	nm_usuario_p,				-- nm_usuario_nrec, 
	null,					-- ie_obriga_news, 
	null,					-- nr_seq_meta_pe, 
	null,					-- nr_seq_classif, 
	null,					-- nr_seq_nivel_valor, 
	null,					-- nm_usuario_lib_news, 
	null,					-- dt_libera_news, 
	null,					-- dt_envio_wheb, 
	null,					-- ds_contato_solicitante, 
	null,					-- ie_prioridade_desen, 
	null,					-- ie_prioridade_sup 
	'4',					-- ie_origem_os 
	nr_seq_tipo_os_w);				--nr_tipo_ordem 
	
if (coalesce(ie_gerar_os_proc_w,'N') = 'S') then 
	begin 
	select	max(b.nm_usuario_exec) 
	into STRICT	nm_usuario_exec_prev_w 
	from	man_rota_insp_exec b, 
		man_rota_inspecao_item a 
	where	a.nr_seq_rota_inspecao = b.nr_seq_rota_inspecao 
	and	a.nr_sequencia = nr_sequencia_p;
	 
	if (coalesce(nm_usuario_exec_prev_w,'X') <> 'X') then 
		CALL man_inserir_usuario_executor(nr_ordem_servico_p,nm_usuario_exec_prev_w,nm_usuario_p, null, null);
	end if;
	end;
end if;
 
if (coalesce(ie_gerar_ativ_real_os_w,'N') = 'S') then 
	begin 
	open C01;
	loop 
	fetch C01 into	 
		dt_atividade_w, 
		dt_fim_atividade_w, 
		nm_usuario_exec_ativ_w, 
		nr_seq_funcao_ativ_w, 
		qt_minuto_ativ_w, 
		ds_atividade_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		insert into man_ordem_serv_ativ( 
				nr_sequencia, 
				nr_seq_ordem_serv, 
				dt_atualizacao, 
				nm_usuario, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				dt_atividade, 
				dt_fim_atividade, 
				nm_usuario_exec, 
				nr_seq_funcao, 
				qt_minuto, 
				qt_minuto_cobr, 
				ds_atividade) 
			values (	nextval('man_ordem_serv_ativ_seq'), 
				nr_ordem_servico_p, 
				clock_timestamp(), 
				nm_usuario_p, 
				clock_timestamp(), 
				nm_usuario_p, 
				dt_atividade_w, 
				dt_fim_atividade_w, 
				nm_usuario_exec_ativ_w, 
				nr_seq_funcao_ativ_w, 
				qt_minuto_ativ_w, 
				qt_minuto_ativ_w, 
				ds_atividade_w);
		end;
	end loop;
	close C01;
	end;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_os_item_rota_insp ( nr_sequencia_p bigint, nr_ordem_servico_p INOUT bigint, nm_usuario_p text) FROM PUBLIC;

