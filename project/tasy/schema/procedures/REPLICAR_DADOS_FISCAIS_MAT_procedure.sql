-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE replicar_dados_fiscais_mat ( cd_material_orig_p text, cd_material_dest_p text default '', cd_grupo_p text default '', cd_sub_grupo_p text default '', cd_classe_p text default '', cd_familia_p text default '', ie_alterar_tipo_p text default '', nm_usuario_p text DEFAULT NULL) AS $body$
DECLARE

 
cd_material_w		varchar(20);
qt_registro_w		bigint;
ie_origem_mercadoria_w	varchar(50);
ie_tributacao_icms_w	varchar(50);
ie_tributacao_ipi_w		varchar(50);
ie_tributacao_pis_w		varchar(50);
ie_tributacao_cofins_w	varchar(50);
ie_tributacao_pis_saida_w	varchar(50);
ie_tribut_cofins_saida_w	varchar(50);
nr_seq_ncm_w		varchar(50);
ie_lista_w			varchar(50);
ie_tipo_material_w		varchar(50);
ie_duplicar_fiscal_w		varchar(10);
ie_tipo_fiscal_w		varchar(10);
qt_registros_w		bigint := 0;
nr_seq_mat_fiscal_w	bigint;
ie_alterado_w		varchar(1);
cd_tipo_cest_w		material_fiscal.cd_tipo_cest%type;
cd_enquadramento_ipi_w	material_fiscal.cd_enquadramento_ipi%type;

C01 CURSOR FOR 
	SELECT 	distinct m.cd_material 
	from	material m, 
		estrutura_material_v v 
	where	m.cd_material = v.cd_material 
	and	m.cd_material 			= coalesce(cd_material_dest_p,m.cd_material) 
	and	coalesce(m.cd_classe_material,0)	= coalesce(cd_classe_p,coalesce(m.cd_classe_material,0)) 
	and	coalesce(m.nr_seq_familia,0)		= coalesce(cd_familia_p,coalesce(m.nr_seq_familia,0)) 
	and	coalesce(v.cd_grupo_material,0)		= coalesce(cd_grupo_p,coalesce(v.cd_grupo_material,0)) 
	and	coalesce(v.cd_subgrupo_material,0)	= coalesce(cd_sub_grupo_p,coalesce(v.cd_subgrupo_material,0));

 

BEGIN 
ie_duplicar_fiscal_w := obter_param_usuario(132, 95, Obter_perfil_Ativo, nm_usuario_p, null, ie_duplicar_fiscal_w);
 
select 	nextval('material_fiscal_log_seq') 
into STRICT	nr_seq_mat_fiscal_w
;
 
insert into 	material_fiscal_log(	nr_sequencia, 
					 nm_usuario, 
					 nm_usuario_nrec, 
					 dt_atualizacao, 
					 dt_atualizacao_nrec, 
					 cd_classe_material, 
					 cd_familia_material, 
					 cd_material_dest, 
					 cd_material_orig, 
					 ie_alterar_tipo_medic, 
					 qt_alterado) 
values (nr_seq_mat_fiscal_w, 
					 nm_usuario_p, 
					 nm_usuario_p, 
					 clock_timestamp(), 
					 clock_timestamp(), 
					 cd_classe_p, 
					 cd_familia_p, 
					 cd_material_dest_p, 
					 cd_material_orig_p, 
					 ie_alterar_tipo_p, 
					 0);
 
open c01;
loop 
fetch c01 into 
	cd_material_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	ie_alterado_w := 'N';
	select	count(*) 
	into STRICT	qt_registro_w 
	from	material_fiscal 
	where	cd_material = cd_material_w;
 
	select 	f.ie_origem_mercadoria, 
		f.ie_tributacao_icms, 
		f.ie_tributacao_ipi, 
		f.ie_tributacao_pis, 
		f.ie_tributacao_cofins, 
		f.ie_tributacao_pis_saida, 
		f.ie_tribut_cofins_saida, 
		f.nr_seq_ncm, 
		f.ie_lista, 
		m.ie_tipo_material, 
		f.ie_tipo_fiscal, 
		f.cd_tipo_cest, 
		f.cd_enquadramento_ipi 
	into STRICT	ie_origem_mercadoria_w, 
		ie_tributacao_icms_w, 
		ie_tributacao_ipi_w, 
		ie_tributacao_pis_w, 
		ie_tributacao_cofins_w, 
		ie_tributacao_pis_saida_w, 
		ie_tribut_cofins_saida_w, 
		nr_seq_ncm_w, 
		ie_lista_w, 
		ie_tipo_material_w, 
		ie_tipo_fiscal_w, 
		cd_tipo_cest_w, 
		cd_enquadramento_ipi_w 
	from	material_fiscal f, 
		material m 
	where	f.cd_material = m.cd_material 
	and	m.cd_material = cd_material_orig_p;
 
	if (ie_alterar_tipo_p = 'S') then 
		update 	material set ie_tipo_material = ie_tipo_material_w 
		where	cd_material = cd_material_w;
	end if;
 
	if (qt_registro_w > 0) then 
		if (ie_duplicar_fiscal_w = 'SS') then 
			update material_fiscal	set ie_origem_mercadoria	= ie_origem_mercadoria_w, 
						ie_tributacao_icms		= ie_tributacao_icms_w, 
						ie_tributacao_ipi		= ie_tributacao_ipi_w, 
						ie_tributacao_pis		= ie_tributacao_pis_w, 
						ie_tributacao_cofins		= ie_tributacao_cofins_w, 
						ie_tributacao_pis_saida		= ie_tributacao_pis_saida_w, 
						ie_tribut_cofins_saida		= ie_tribut_cofins_saida_w, 
						nr_seq_ncm			= nr_seq_ncm_w, 
						ie_lista			= ie_lista_w, 
						dt_atualizacao			= clock_timestamp(), 
						nm_usuario			= nm_usuario_p, 
						ie_tipo_fiscal			= ie_tipo_fiscal_w, 
						cd_tipo_cest			= cd_tipo_cest_w, 
						cd_enquadramento_ipi		= cd_enquadramento_ipi_w 
			where	cd_material = cd_material_w;
			qt_registros_w := qt_registros_w + 1;
			ie_alterado_w := 'S';
		end if;
	else 
		insert into material_fiscal(nr_sequencia, 
					   cd_material, 
					   ie_origem_mercadoria, 
					   ie_tributacao_icms, 
					   ie_tributacao_ipi, 
					   ie_tributacao_pis, 
					   ie_tributacao_cofins, 
					   ie_tributacao_pis_saida, 
					   ie_tribut_cofins_saida, 
					   nr_seq_ncm, 
					   ie_lista, 
					   nm_usuario, 
					   nm_usuario_nrec, 
					   dt_atualizacao, 
					   dt_atualizacao_nrec, 
					   ie_tipo_fiscal, 
					   cd_tipo_cest, 
					   cd_enquadramento_ipi) 
		values (nextval('material_fiscal_seq'), 
					   cd_material_w, 
					   ie_origem_mercadoria_w, 
					   ie_tributacao_icms_w, 
					   ie_tributacao_ipi_w, 
					   ie_tributacao_pis_w, 
					   ie_tributacao_cofins_w, 
					   ie_tributacao_pis_saida_w, 
					  ie_tribut_cofins_saida_w, 
					   nr_seq_ncm_w, 
					   ie_lista_w, 
					   nm_usuario_p, 
					   nm_usuario_p, 
					   clock_timestamp(), 
					   clock_timestamp(), 
					   ie_tipo_fiscal_w, 
					   cd_tipo_cest_w, 
					   cd_enquadramento_ipi_w);
		qt_registros_w := qt_registros_w + 1;
		ie_alterado_w := 'S';
	end if;
	 
 
	insert into material_fiscal_item_log(nr_sequencia, 
					   nm_usuario, 
					   nm_usuario_nrec, 
					   dt_atualizacao, 
					   dt_atualizacao_nrec, 
					   cd_material, 
					   ie_alterado, 
					   nr_seq_mat_fiscal_log) 
	values (nextval('material_fiscal_item_log_seq'), 
					   nm_usuario_p, 
					   nm_usuario_p, 
					   clock_timestamp(), 
					   clock_timestamp(), 
					   cd_material_w, 
					   ie_alterado_w, 
					   nr_seq_mat_fiscal_w);
end loop;
close c01;
 
update 	material_fiscal_log 
set	qt_alterado = qt_registros_w 
where	nr_sequencia = nr_seq_mat_fiscal_w;
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE replicar_dados_fiscais_mat ( cd_material_orig_p text, cd_material_dest_p text default '', cd_grupo_p text default '', cd_sub_grupo_p text default '', cd_classe_p text default '', cd_familia_p text default '', ie_alterar_tipo_p text default '', nm_usuario_p text DEFAULT NULL) FROM PUBLIC;

