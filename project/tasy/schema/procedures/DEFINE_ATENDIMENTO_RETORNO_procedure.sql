-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE define_atendimento_retorno ( nr_atendimento_p bigint, nr_atend_retorno_p INOUT bigint, nr_seq_regra_msg_p INOUT bigint ) AS $body$
DECLARE


cd_estabelecimento_w				atendimento_paciente.cd_estabelecimento%TYPE;
cd_pessoa_fisica_w					atendimento_paciente.cd_pessoa_fisica%TYPE;
ie_tipo_atendimento_w				atendimento_paciente.ie_tipo_atendimento%TYPE;
ie_tipo_atend_tiss_w				atendimento_paciente.ie_tipo_atend_tiss%TYPE;
ie_clinica_w						atendimento_paciente.ie_clinica%TYPE;
cd_medico_resp_w					atendimento_paciente.cd_medico_resp%TYPE;
nr_seq_classificacao_w				atendimento_paciente.nr_seq_classificacao%TYPE;
nr_seq_queixa_origem_w				atendimento_paciente.nr_seq_queixa%TYPE;
ie_tipo_convenio_w		           	atendimento_paciente.ie_tipo_convenio%TYPE;
cd_medico_w							atendimento_paciente.cd_medico_resp%TYPE;
nr_seq_queixa_w						atendimento_paciente.nr_seq_queixa%TYPE;
cd_convenio_w						atend_categoria_convenio.cd_convenio%TYPE;
cd_categoria_w						atend_categoria_convenio.cd_categoria%TYPE;
nr_seq_origem_w						atend_categoria_convenio.nr_seq_origem%TYPE;
cd_plano_convenio_w					atend_categoria_convenio.cd_plano_convenio%TYPE;
cd_usuario_convenio_w				atend_categoria_convenio.cd_usuario_convenio%TYPE;
nr_atendimento_w					atend_categoria_convenio.nr_atendimento%TYPE;
ie_mesmo_estab_w		 			regra_atend_retorno.ie_mesmo_estab%TYPE;
ie_data_alta_w		 				regra_atend_retorno.ie_data_alta%TYPE;
ie_consiste_mot_alt_atend_w  		regra_atend_retorno.ie_consiste_mot_alt_atend%TYPE;
cd_motivo_alta_w                    regra_atend_retorno.cd_motivo_alta%TYPE;
ie_espec_medico_retorno_w			regra_atend_retorno.ie_espec_medico_retorno%TYPE;
ie_mesmo_tipo_tiss_w				regra_atend_retorno.ie_mesmo_tipo_tiss%TYPE;
ie_ignora_espec_medica_w			regra_atend_retorno.ie_ignora_espec_medica%TYPE;
ie_ignora_clinica_atend_w			regra_atend_retorno.ie_ignora_clinica_atend%TYPE;
qt_hora_w							regra_atend_retorno.qt_horas%TYPE;
ie_considera_atend_retorno_w		regra_atend_retorno.ie_considera_atend_retorno%TYPE;
nr_pos_inicial_w					regra_atend_retorno.nr_pos_inicial%TYPE;
nr_pos_final_w						regra_atend_retorno.nr_pos_final%TYPE;
cd_usuario_padrao_w					regra_atend_retorno.cd_usuario_padrao%TYPE;
nr_seq_regra_w						regra_atend_retorno.nr_sequencia%TYPE;
ie_atendimento_cancelado_w			regra_atend_retorno.ie_atendimento_cancelado%TYPE;
ie_consiste_classif_w				regra_atend_retorno.ie_consiste_classificacao%TYPE;
ds_mensagem_w						regra_atend_retorno.ds_mensagem%TYPE;		
ie_consiste_categ_w					regra_atend_retorno.ie_consiste_categoria%TYPE;
ie_consiste_plano_w					regra_atend_retorno.ie_consiste_plano%TYPE;
qt_retorno_w						regra_atend_retorno.qt_retorno%TYPE;
ie_regra_w							regra_atend_retorno.ie_regra%TYPE;
qt_dia_w							regra_atend_retorno.qt_dia%TYPE;
nr_seq_classificacao_regra_w		regra_atend_retorno.nr_seq_classificacao%TYPE;
ie_dentro_mes_w						regra_atend_retorno.ie_dentro_mes%TYPE := 'N';
ie_dentro_dia_w						regra_atend_retorno.ie_dentro_dia%TYPE := 'N';
ie_consiste_setor_w					regra_atend_retorno.ie_consiste_setor%TYPE;
ie_mesmo_tipo_atend_w				regra_atend_retorno.ie_mesmo_tipo_atend%TYPE;
ie_classif_agenda_pac_w				agenda_paciente.nr_seq_classif_agenda%TYPE;
ie_classif_agenda_con_w				agenda_consulta.ie_classif_agenda%TYPE;
cd_setor_atendimento_w				atend_paciente_unidade.cd_setor_atendimento%TYPE;
cd_categoria_cid_origem_w			cid_doenca.cd_categoria_cid%TYPE;
cd_categoria_cid_w					cid_doenca.cd_categoria_cid%TYPE;
cd_cid_principal_w					diagnostico_doenca.cd_doenca%TYPE;
cd_cid_principal_origem_w			diagnostico_doenca.cd_doenca%TYPE;
qt_existe_w							integer;
cd_espec_atend_w					integer;
cd_espec_atend_retorno_w			integer;
qt_reg_w							integer;
ie_ok_w								integer;
ie_ok_atual_w						integer;
dt_entrada_w						timestamp;
dt_atual_w							timestamp;
ds_retorno_proc_w					varchar(255);

C01 CURSOR FOR
	SELECT	ie_regra,
			qt_dia,
			COALESCE(qt_horas,0),
			COALESCE(qt_retorno,0),
			COALESCE(ie_dentro_mes,'N'),
			COALESCE(ie_dentro_dia,'N'),
			COALESCE(ie_consiste_setor,'S'),
			ie_mesmo_tipo_atend,
			COALESCE(ie_considera_atend_retorno,'N'),
			COALESCE(ie_atendimento_cancelado,'S'),
			nr_pos_inicial,
			nr_pos_final,
			cd_usuario_padrao,
			nr_sequencia,
			ie_consiste_classificacao,
			nr_seq_classificacao,
			ds_mensagem,
			COALESCE(ie_consiste_categoria,'S'),
			COALESCE(ie_consiste_plano,'S'),
			COALESCE(ie_mesmo_estab,'S'),
			COALESCE(ie_data_alta,'N'),
			cd_motivo_alta,
			COALESCE(ie_consiste_mot_alt_atend,'N'),
			COALESCE(ie_espec_medico_retorno, 'N'),
			COALESCE(ie_mesmo_tipo_tiss, 'N'),
			COALESCE(ie_ignora_espec_medica,'N'),
			COALESCE(ie_ignora_clinica_atend,'N')
	FROM	regra_atend_retorno
	WHERE	((coalesce(cd_convenio_w::text, '') = '' AND COALESCE(ie_validar_campo_vazio, 'N') = 'N') OR (COALESCE(cd_convenio, cd_convenio_w) = cd_convenio_w))
	AND		((coalesce(cd_categoria_w::text, '') = '' AND COALESCE(ie_validar_campo_vazio, 'N') = 'N') OR (COALESCE(cd_categoria,cd_categoria_w) = cd_categoria_w))
	AND		((COALESCE(ie_consiste_classificacao, 'N') = 'N') OR ((coalesce(nr_seq_classificacao_w::text, '') = '' AND COALESCE(ie_validar_campo_vazio, 'N') = 'N')
			OR (COALESCE(nr_seq_classificacao, nr_seq_classificacao_w) = nr_seq_classificacao_w)))
	AND		((coalesce(nr_seq_origem_w::text, '') = '' AND COALESCE(ie_validar_campo_vazio, 'N') = 'N') OR (COALESCE(nr_seq_origem, nr_seq_origem_w, -1) = COALESCE(nr_seq_origem_w, -1)))
	AND		((coalesce(cd_plano_convenio_w::text, '') = '' AND COALESCE(ie_validar_campo_vazio, 'N') = 'N') OR (COALESCE(cd_plano_convenio, cd_plano_convenio_w, 'xpto')  = COALESCE(cd_plano_convenio_w, 'xpto')))
	AND		((coalesce(cd_espec_atend_w::text, '') = '' AND COALESCE(ie_validar_campo_vazio, 'N') = 'N') OR (COALESCE(cd_especialidade_medica,cd_espec_atend_w) = cd_espec_atend_w))
	AND		((coalesce(cd_estabelecimento_w::text, '') = '' AND COALESCE(ie_validar_campo_vazio, 'N') = 'N') OR (COALESCE(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w))
	AND		((coalesce(cd_setor_atendimento_w::text, '') = '' AND COALESCE(ie_validar_campo_vazio, 'N') = 'N') OR (COALESCE(cd_setor_atendimento, cd_setor_atendimento_w) = cd_setor_atendimento_w))
	AND		((coalesce(ie_tipo_atendimento_w::text, '') = '' AND COALESCE(ie_validar_campo_vazio, 'N') = 'N') OR (COALESCE(ie_tipo_atendimento, ie_tipo_atendimento_w) = ie_tipo_atendimento_w))
	AND		((coalesce(ie_tipo_atend_tiss_w::text, '') = '' AND COALESCE(ie_validar_campo_vazio, 'N') = 'N') OR (COALESCE(ie_tipo_atend_tiss, ie_tipo_atend_tiss_w, 'xpto') = COALESCE(ie_tipo_atend_tiss_w, 'xpto')))
	AND 	((coalesce(ie_clinica_w::text, '') = '' AND COALESCE(ie_validar_campo_vazio, 'N') = 'N') OR (COALESCE(ie_clinica, ie_clinica_w) = ie_clinica_w))
	AND		((coalesce(ie_tipo_convenio_w::text, '') = '' AND COALESCE(ie_validar_campo_vazio, 'N') = 'N') OR (COALESCE(ie_tipo_convenio, ie_tipo_convenio_w, -1) = COALESCE(ie_tipo_convenio_w, -1)))
	AND		(((coalesce(cd_usuario_padrao::text, '') = '') AND (obter_se_uso_conv_reg_retorno(COALESCE(cd_convenio_w, -1), COALESCE(cd_usuario_convenio_w, 'xpto')) = 'N'))
			OR (COALESCE(SUBSTR(cd_usuario_convenio_w, nr_pos_inicial, (nr_pos_final - nr_pos_inicial) + 1), 'xpto') = COALESCE(cd_usuario_padrao, 'xpto')))
	AND 	COALESCE(ie_regra_agenda,'A') NOT IN ('G','O')
	AND 	((coalesce(ie_classif_agenda_pac_w::text, '') = '' AND COALESCE(ie_validar_campo_vazio, 'N') = 'N') OR (COALESCE(ie_classif_agenda_pac, ie_classif_agenda_pac_w) = ie_classif_agenda_pac_w))
	AND 	((coalesce(ie_classif_agenda_con_w::text, '') = '' AND COALESCE(ie_validar_campo_vazio, 'N') = 'N') OR (COALESCE(ie_classif_agenda_con, ie_classif_agenda_con_w) = ie_classif_agenda_con_w))
	AND 	clock_timestamp() BETWEEN COALESCE(dt_inicio_vigencia, clock_timestamp()) AND COALESCE(dt_fim_vigencia, clock_timestamp())
	AND 	ie_situacao = 'A'
	ORDER BY COALESCE(cd_convenio,0), COALESCE(cd_estabelecimento,0), COALESCE(ie_tipo_atendimento,0), COALESCE(cd_setor_atendimento,0),
	         COALESCE(nr_seq_classificacao,0), COALESCE(ie_tipo_atend_tiss,'0'), COALESCE(cd_especialidade_medica,0), COALESCE(ie_clinica,0), COALESCE(cd_categoria,'0'),
		     COALESCE(nr_seq_origem,0), COALESCE(cd_plano_convenio,'0'), COALESCE(ie_tipo_convenio,0), 
		     COALESCE(ie_classif_agenda_pac,0), COALESCE(ie_classif_agenda_con,'0'), qt_dia;

C02 CURSOR FOR
	SELECT	nr_atendimento,
			cd_medico_resp,
			nr_seq_queixa,
			cd_cid_principal
	FROM 	
		(
		SELECT	c.nr_atendimento,
				a.nr_atend_original,
				a.dt_entrada,
				a.cd_pessoa_fisica,
				a.ie_tipo_atendimento,
				a.cd_medico_resp,
				a.dt_alta,
				a.ie_clinica,
				a.cd_estabelecimento,
				a.ie_tipo_convenio,
				c.cd_convenio,
				c.cd_categoria,
				c.cd_usuario_convenio,
				c.nr_doc_convenio,
				c.nr_doc_convenio nr_guia_atend,
				c.dt_inicio_vigencia,
				c.dt_final_vigencia,
				c.cd_plano_convenio,
				(SELECT SUBSTR(obter_cid_atendimento(a.nr_atendimento,'P'),1,10) ) cd_cid_principal,
				a.ds_obs_alta,
				a.nr_seq_forma_chegada,
				c.ie_tipo_guia,
				a.nr_seq_classificacao,
				a.nr_seq_queixa,
				a.ie_tipo_atend_tiss,
				c.nr_seq_origem,
				a.dt_cancelamento,
				a.dt_saida_real,
				a.nm_usuario_saida,
				a.nr_seq_grau_parentesco,
				a.cd_motivo_alta,
				(SELECT obter_setor_atendimento(a.nr_atendimento) ) cd_setor_atendimento
		FROM	atend_categoria_convenio c,
				atendimento_paciente a
		WHERE	a.nr_atendimento = c.nr_atendimento
		AND 	a.cd_pessoa_fisica = COALESCE(cd_pessoa_fisica_w, 'xpto')
		AND 	a.nr_atendimento <> nr_atendimento_p
		AND		((ie_mesmo_estab_w = 'S') OR ((ie_mesmo_estab_w = 'N') AND (a.cd_estabelecimento = COALESCE(cd_estabelecimento_w, -1))))
		AND 	c.nr_seq_interno = (SELECT COALESCE(MAX(x.nr_seq_interno),0)
									FROM 	atend_categoria_convenio x
									WHERE	x.nr_atendimento = a.nr_atendimento
									AND 	x.dt_inicio_vigencia = 
											(SELECT	MAX(y.dt_inicio_vigencia)
											FROM 	atend_categoria_convenio y
											WHERE 	y.nr_atendimento = a.nr_atendimento))
		) a
	WHERE	((ie_mesmo_tipo_atend_w = 'N') OR (a.ie_tipo_atendimento = COALESCE(ie_tipo_atendimento_w, -1)))
	AND 	((qt_dia_w > 0  AND a.dt_entrada BETWEEN clock_timestamp() - qt_dia_w AND clock_timestamp()) 
			OR (qt_dia_w  = 0 AND qt_hora_w > 0  AND a.dt_entrada BETWEEN clock_timestamp() - (qt_hora_w/24) AND clock_timestamp()))
	AND		((ie_data_alta_w = 'S' AND ((qt_dia_w > 0  AND COALESCE(a.dt_alta,a.dt_entrada) BETWEEN clock_timestamp() - qt_dia_w AND clock_timestamp()) 
			OR (qt_dia_w  = 0 AND qt_hora_w > 0  AND COALESCE(a.dt_alta,a.dt_entrada) BETWEEN clock_timestamp() - (qt_hora_w/24) AND clock_timestamp()))) 
			OR (ie_data_alta_w = 'N' AND ((qt_dia_w > 0  AND a.dt_entrada BETWEEN clock_timestamp() - qt_dia_w AND clock_timestamp()) 
			OR (qt_dia_w  = 0 AND qt_hora_w > 0 AND a.dt_entrada BETWEEN clock_timestamp() - (qt_hora_w/24) AND clock_timestamp()))))
	AND (a.cd_convenio = COALESCE(cd_convenio_w, -1))
	AND 	((ie_ignora_clinica_atend_w = 'S') OR (COALESCE(a.ie_clinica, ie_clinica_w, -1) = COALESCE(ie_clinica_w, -1)))
	AND		((ie_consiste_setor_w = 'N') OR ((ie_consiste_setor_w = 'S') AND (COALESCE(a.cd_setor_atendimento, cd_setor_atendimento_w, -1) = COALESCE(cd_setor_atendimento_w, -1))))
	AND		((ie_consiste_classif_w = 'N') OR (COALESCE(a.nr_seq_classificacao, nr_seq_classificacao_w, -1)	= COALESCE(nr_seq_classificacao_w, -1)))
	AND (COALESCE(a.ie_tipo_atend_tiss, ie_tipo_atend_tiss_w, 'xpto') = COALESCE(ie_tipo_atend_tiss_w, 'xpto'))
	AND		((coalesce(cd_espec_atend_w::text, '') = '') OR ((ie_regra_w = 'Q') OR (ie_regra_w = 'R' AND ie_ignora_espec_medica_w = 'S') OR (COALESCE((Obter_Espec_medico_atend(a.nr_atendimento, a.cd_medico_resp, 'C'))::numeric , cd_espec_atend_w) = cd_espec_atend_w)))
	AND		((ie_consiste_categ_w = 'N') OR ((ie_consiste_categ_w = 'S') AND (a.cd_categoria = COALESCE(cd_categoria_w, 'xpto'))))
	AND (COALESCE(a.nr_seq_origem, nr_seq_origem_w, -1) = COALESCE(nr_seq_origem_w, -1))
	AND		((ie_consiste_plano_w = 'N') OR ((ie_consiste_plano_w = 'S') AND (COALESCE(a.cd_plano_convenio, cd_plano_convenio_w, 'xpto') = COALESCE(cd_plano_convenio_w, 'xpto'))))
	AND		((coalesce(a.nr_atend_original::text, '') = '') OR (ie_considera_atend_retorno_w = 'S'))
	AND		(((coalesce(cd_usuario_padrao_w::text, '') = '') AND (obter_se_uso_conv_reg_retorno(a.cd_Convenio, COALESCE(a.cd_usuario_convenio, 'xpto')) = 'N')) 
			OR ((COALESCE(SUBSTR(a.cd_usuario_convenio, nr_pos_inicial_w, (nr_pos_final_w - nr_pos_inicial_w) + 1), 'xpto')) = COALESCE(cd_usuario_padrao_w, 'xpto')))
	AND		(((coalesce(a.dt_cancelamento::text, '') = '') AND (ie_atendimento_cancelado_w = 'N')) OR (ie_atendimento_cancelado_w = 'S'))
	AND		((ie_consiste_mot_alt_atend_w = 'N') OR ((ie_consiste_mot_alt_atend_w = 'S') AND (COALESCE(cd_motivo_alta, -1) = COALESCE(cd_motivo_alta_w, -1))))
	ORDER BY a.nr_atendimento;


BEGIN
BEGIN

SELECT	a.cd_estabelecimento,
		a.cd_pessoa_fisica,
		a.ie_tipo_atendimento,
		c.cd_convenio,
		(SELECT obter_setor_atendimento(a.nr_atendimento) ) cd_setor_atendimento,
		a.cd_medico_resp,
		a.nr_seq_classificacao,
		a.nr_seq_queixa,
		(SELECT obter_cid_atendimento(a.nr_atendimento,'P') ) cd_cid_principal,
		(SELECT obter_categoria_cid(obter_cid_atendimento(a.nr_atendimento,'P')) ) categoria_cid,
		a.ie_tipo_atend_tiss,
		a.ie_clinica,
		c.cd_categoria,
		c.nr_seq_origem,
		c.cd_plano_convenio,
		c.cd_usuario_convenio,
		a.ie_tipo_convenio	
INTO STRICT	cd_estabelecimento_w,
		cd_pessoa_fisica_w,
		ie_tipo_atendimento_w,
		cd_convenio_w,
		cd_setor_atendimento_w,
		cd_medico_resp_w,
		nr_seq_classificacao_w,
		nr_seq_queixa_origem_w,
		cd_cid_principal_origem_w,
		cd_categoria_cid_origem_w,
		ie_tipo_atend_tiss_w,
		ie_clinica_w,
		cd_categoria_w,
		nr_seq_origem_w,
		cd_plano_convenio_w,
		cd_usuario_convenio_w,
		ie_tipo_convenio_w
FROM	atend_categoria_convenio c,
		atendimento_paciente a
WHERE	a.nr_atendimento = c.nr_atendimento
AND		a.nr_atendimento = nr_atendimento_p
AND 	c.nr_seq_interno = (SELECT	COALESCE(MAX(x.nr_seq_interno),0)
							FROM 	atend_categoria_convenio x
							WHERE	x.nr_atendimento = a.nr_atendimento
							AND 	x.dt_inicio_vigencia =
									(SELECT MAX(y.dt_inicio_vigencia)
									FROM atend_categoria_convenio y
									WHERE y.nr_atendimento = a.nr_atendimento));
EXCEPTION
WHEN no_data_found OR too_many_rows	THEN
	cd_estabelecimento_w		:= NULL;
	cd_pessoa_fisica_w			:= NULL;
	ie_tipo_atendimento_w		:= NULL;
	cd_convenio_w				:= NULL;
	cd_setor_atendimento_w		:= NULL;
	cd_medico_resp_w			:= NULL;
	nr_seq_classificacao_w		:= NULL;
	cd_cid_principal_origem_w	:= NULL;
	cd_categoria_cid_origem_w	:= NULL;
	ie_tipo_atend_tiss_w		:= NULL;
	ie_clinica_w				:= NULL;
	cd_categoria_w				:= NULL;
	nr_seq_origem_w				:= NULL;
	cd_plano_convenio_w			:= NULL;
	ie_tipo_convenio_w          := NULL;
END;

SELECT	MAX(ie_classif_agenda)
INTO STRICT 	ie_classif_agenda_con_w
FROM 	Agenda_consulta
WHERE 	nr_atendimento = nr_atendimento_p
AND		ie_status_agenda <> 'C';

SELECT	MAX(nr_seq_classif_agenda)
INTO STRICT 	ie_classif_agenda_pac_w
FROM 	Agenda_paciente
WHERE 	nr_atendimento = nr_atendimento_p
AND		ie_status_agenda <> 'C';

cd_espec_atend_w := Obter_Espec_medico_atend(nr_atendimento_p, COALESCE(cd_medico_resp_w, 'xpto'), 'C');

OPEN C01;
LOOP
	FETCH	C01
	INTO 	ie_regra_w,
			qt_dia_w,
			qt_hora_w,
			qt_retorno_w,
			ie_dentro_mes_w,
			ie_dentro_dia_w,
			ie_consiste_setor_w,
			ie_mesmo_tipo_atend_w,
			ie_considera_atend_retorno_w,
			ie_atendimento_cancelado_w,
			nr_pos_inicial_w,
			nr_pos_final_w,
			cd_usuario_padrao_w,
			nr_seq_regra_w,
			ie_consiste_classif_w,
			nr_seq_classificacao_regra_w,
			ds_mensagem_w,
			ie_consiste_categ_w,
			ie_consiste_plano_w,
			ie_mesmo_estab_w,
			ie_data_alta_w,
			cd_motivo_alta_w,
			ie_consiste_mot_alt_atend_w,
			ie_espec_medico_retorno_w,
			ie_mesmo_tipo_tiss_w,
			ie_ignora_espec_medica_w,
			ie_ignora_clinica_atend_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
END LOOP;
CLOSE C01;

IF (qt_dia_w > 0)  OR (qt_hora_w > 0) THEN

	BEGIN
	IF (qt_retorno_w > 0) THEN
		IF (ie_espec_medico_retorno_w = 'N') THEN
		
			SELECT	COUNT(1)
			INTO STRICT	qt_reg_w
			FROM 	
				(
				SELECT	c.nr_atendimento,
						a.nr_atend_original,
						a.dt_entrada,
						a.cd_pessoa_fisica,
						a.ie_tipo_atendimento,
						a.cd_medico_resp,
						a.dt_alta,
						a.ie_clinica,
						a.cd_estabelecimento,
						a.ie_tipo_convenio,
						c.cd_convenio,
						c.cd_categoria,
						c.cd_usuario_convenio,
						c.nr_doc_convenio,
						c.nr_doc_convenio nr_guia_atend,
						c.dt_inicio_vigencia,
						c.dt_final_vigencia,
						c.cd_plano_convenio,
						(SELECT SUBSTR(obter_cid_atendimento(a.nr_atendimento,'P'),1,10) ) cd_cid_principal,
						a.ds_obs_alta,
						a.nr_seq_forma_chegada,
						c.ie_tipo_guia,
						a.nr_seq_classificacao,
						a.nr_seq_queixa,
						a.ie_tipo_atend_tiss,
						c.nr_seq_origem,
						a.dt_cancelamento,
						a.dt_saida_real,
						a.nm_usuario_saida,
						a.nr_seq_grau_parentesco,
						a.cd_motivo_alta,
						(SELECT obter_setor_atendimento(a.nr_atendimento) ) cd_setor_atendimento
				FROM	atend_categoria_convenio c,
						atendimento_paciente a
				WHERE	a.nr_atendimento = c.nr_atendimento
				AND 	a.cd_pessoa_fisica = COALESCE(cd_pessoa_fisica_w, 'xpto')
				AND 	a.nr_atendimento <> nr_atendimento_p
				AND		((ie_mesmo_estab_w = 'S') OR (ie_mesmo_estab_w = 'N' AND (a.cd_estabelecimento = COALESCE(cd_estabelecimento_w, -1))))
				AND 	c.nr_seq_interno = (SELECT	COALESCE(MAX(x.nr_seq_interno),0)
											FROM 	atend_categoria_convenio x
											WHERE	x.nr_atendimento = a.nr_atendimento
											AND 	x.dt_inicio_vigencia = 
													(SELECT MAX(y.dt_inicio_vigencia)
													FROM 	atend_categoria_convenio y
													WHERE 	y.nr_atendimento = a.nr_atendimento))
				) a
			WHERE	((ie_mesmo_tipo_atend_w = 'N') OR (ie_tipo_atendimento = COALESCE(ie_tipo_atendimento_w, -1)))
			AND		((ie_mesmo_tipo_tiss_w = 'N') OR (COALESCE(a.ie_tipo_atend_tiss, ie_tipo_atend_tiss_w, 'xpto') = COALESCE(ie_tipo_atend_tiss_w, 'xpto')))
			AND (a.cd_convenio = COALESCE(cd_convenio_w, -1))
			AND (COALESCE(a.ie_clinica, ie_clinica_w, -1) = COALESCE(ie_clinica_w, -1))
			AND (cd_medico_resp = COALESCE(cd_medico_resp_w, 'xpto'))
			AND		((ie_data_alta_w = 'S' AND COALESCE(dt_alta,dt_entrada) >= clock_timestamp() - qt_dia_w) OR (ie_data_alta_w = 'N' AND dt_entrada >= clock_timestamp() - qt_dia_w))
			AND		((nr_atend_original IS NOT NULL AND nr_atend_original::text <> '') OR (ie_considera_atend_retorno_w = 'S'))
			AND		(((coalesce(dt_cancelamento::text, '') = '') AND (ie_atendimento_cancelado_w = 'N')) OR (ie_atendimento_cancelado_w = 'S'))
			AND		((ie_consiste_mot_alt_atend_w = 'N') OR ((ie_consiste_mot_alt_atend_w = 'S') AND (COALESCE(cd_motivo_alta, -1) = COALESCE(cd_motivo_alta_w, -1))));
			
		ELSE

			SELECT	COUNT(1)
			INTO STRICT	qt_reg_w
			FROM 	
				(
				SELECT	c.nr_atendimento,
						a.nr_atend_original,
						a.dt_entrada,
						a.cd_pessoa_fisica,
						a.ie_tipo_atendimento,
						a.cd_medico_resp,
						a.dt_alta,
						a.ie_clinica,
						a.cd_estabelecimento,
						a.ie_tipo_convenio,
						c.cd_convenio,
						c.cd_categoria,
						c.cd_usuario_convenio,
						c.nr_doc_convenio,
						c.nr_doc_convenio nr_guia_atend,
						c.dt_inicio_vigencia,
						c.dt_final_vigencia,
						c.cd_plano_convenio,
						(SELECT SUBSTR(obter_cid_atendimento(a.nr_atendimento,'P'),1,10) ) cd_cid_principal,
						a.ds_obs_alta,
						a.nr_seq_forma_chegada,
						c.ie_tipo_guia,
						a.nr_seq_classificacao,
						a.nr_seq_queixa,
						a.ie_tipo_atend_tiss,
						c.nr_seq_origem,
						a.dt_cancelamento,
						a.dt_saida_real,
						a.nm_usuario_saida,
						a.nr_seq_grau_parentesco,
						a.cd_motivo_alta,
						(SELECT obter_setor_atendimento(a.nr_atendimento) ) cd_setor_atendimento
				FROM	atend_categoria_convenio c,
						atendimento_paciente a
				WHERE	a.nr_atendimento = c.nr_atendimento
				AND 	a.cd_pessoa_fisica = COALESCE(cd_pessoa_fisica_w, 'xpto')
				AND 	a.nr_atendimento <> nr_atendimento_p
				AND		((ie_mesmo_estab_w = 'S') OR (ie_mesmo_estab_w = 'N' AND (a.cd_estabelecimento = COALESCE(cd_estabelecimento_w, -1))))
				AND 	c.nr_seq_interno = (SELECT	COALESCE(MAX(x.nr_seq_interno),0)
											FROM 	atend_categoria_convenio x
											WHERE	x.nr_atendimento = a.nr_atendimento
											AND 	x.dt_inicio_vigencia = 
													(SELECT MAX(y.dt_inicio_vigencia)
													FROM 	atend_categoria_convenio y
													WHERE 	y.nr_atendimento = a.nr_atendimento))
				) a
			WHERE	((ie_mesmo_tipo_atend_w = 'N') OR (ie_tipo_atendimento = COALESCE(ie_tipo_atendimento_w, -1)))
			AND		((ie_mesmo_tipo_tiss_w = 'N') OR (COALESCE(a.ie_tipo_atend_tiss, ie_tipo_atend_tiss_w, 'xpto') = COALESCE(ie_tipo_atend_tiss_w, 'xpto')))
			AND (a.cd_convenio = COALESCE(cd_convenio_w, -1))
			AND (COALESCE(a.ie_clinica, ie_clinica_w, -1) = COALESCE(ie_clinica_w, -1))
			AND		((ie_data_alta_w = 'S' AND COALESCE(dt_alta,dt_entrada) >= clock_timestamp() - qt_dia_w) OR (ie_data_alta_w = 'N' AND dt_entrada >= clock_timestamp() - qt_dia_w))
			AND		((nr_atend_original IS NOT NULL AND nr_atend_original::text <> '') OR (ie_considera_atend_retorno_w = 'S'))
			AND		(((coalesce(dt_cancelamento::text, '') = '') AND (ie_atendimento_cancelado_w = 'N')) OR (ie_atendimento_cancelado_w = 'S'))	
			AND		((ie_consiste_mot_alt_atend_w = 'N') OR ((ie_consiste_mot_alt_atend_w = 'S') AND (COALESCE(cd_motivo_alta, -1) = COALESCE(cd_motivo_alta_w, -1))))
			AND		((ie_ignora_espec_medica_w = 'S') OR (EXISTS (SELECT 1 FROM atendimento_troca_medico b WHERE b.nr_atendimento = a.nr_atendimento AND b.cd_medico_atual = a.cd_medico_resp AND b.cd_especialidade = cd_espec_atend_w  LIMIT 1)));

		END IF;
	ELSE
		qt_reg_w := 0;
	END IF;

	EXCEPTION
	WHEN no_data_found THEN
		qt_reg_w := 0;
	END;

	IF (qt_retorno_w > 0)	AND (qt_reg_w >= qt_retorno_w)	THEN
		nr_atend_retorno_p	:= 0;
		
	ELSIF (ie_regra_w = 'M') THEN
	
		SELECT	COALESCE(MAX(nr_atendimento),0)
		INTO STRICT 	nr_atend_retorno_p
		FROM 	
			(
			SELECT	c.nr_atendimento,
					a.nr_atend_original,
					a.dt_entrada,
					a.cd_pessoa_fisica,
					a.ie_tipo_atendimento,
					a.cd_medico_resp,
					a.dt_alta,
					a.ie_clinica,
					a.cd_estabelecimento,
					a.ie_tipo_convenio,
					c.cd_convenio,
					c.cd_categoria,
					c.cd_usuario_convenio,
					c.nr_doc_convenio,
					c.nr_doc_convenio nr_guia_atend,
					c.dt_inicio_vigencia,
					c.dt_final_vigencia,
					c.cd_plano_convenio,
					(SELECT SUBSTR(obter_cid_atendimento(a.nr_atendimento,'P'),1,10) ) cd_cid_principal,
					a.ds_obs_alta,
					a.nr_seq_forma_chegada,
					c.ie_tipo_guia,
					a.nr_seq_classificacao,
					a.nr_seq_queixa,
					a.ie_tipo_atend_tiss,
					c.nr_seq_origem,
					a.dt_cancelamento,
					a.dt_saida_real,
					a.nm_usuario_saida,
					a.nr_seq_grau_parentesco,
					a.cd_motivo_alta,
					(SELECT obter_setor_atendimento(a.nr_atendimento) ) cd_setor_atendimento
			FROM	atend_categoria_convenio c,
					atendimento_paciente a
			WHERE	a.nr_atendimento = c.nr_atendimento
			AND 	a.cd_pessoa_fisica = COALESCE(cd_pessoa_fisica_w, 'xpto')
			AND 	a.nr_atendimento <> nr_atendimento_p
			AND		((ie_mesmo_estab_w = 'S') OR (ie_mesmo_estab_w = 'N' AND (a.cd_estabelecimento = COALESCE(cd_estabelecimento_w, -1))))
			AND 	c.nr_seq_interno = (SELECT	COALESCE(MAX(x.nr_seq_interno),0)
										FROM 	atend_categoria_convenio x
										WHERE	x.nr_atendimento = a.nr_atendimento
										AND 	x.dt_inicio_vigencia = 
												(SELECT MAX(y.dt_inicio_vigencia)
												FROM 	atend_categoria_convenio y
												WHERE 	y.nr_atendimento = a.nr_atendimento))
			) a
		WHERE	((ie_mesmo_tipo_atend_w = 'N') OR (ie_tipo_atendimento = COALESCE(ie_tipo_atendimento_w, -1)))
		AND		((ie_mesmo_tipo_tiss_w = 'N') OR (COALESCE(a.ie_tipo_atend_tiss, ie_tipo_atend_tiss_w, 'xpto') = COALESCE(ie_tipo_atend_tiss_w, 'xpto')))
		AND (a.cd_convenio = COALESCE(cd_convenio_w, -1))
		AND (COALESCE(a.ie_clinica, ie_clinica_w, -1) = COALESCE(ie_clinica_w, -1))
		AND (cd_medico_resp = COALESCE(cd_medico_resp_w, 'xpto'))
		AND		((ie_consiste_classif_w = 'N') OR (COALESCE(nr_seq_classificacao, nr_seq_classificacao_regra_w, -1) = COALESCE(nr_seq_classificacao_regra_w, -1)))
		AND		((ie_data_alta_w = 'S' AND COALESCE(dt_alta,dt_entrada) >= clock_timestamp() - qt_dia_w) OR (ie_data_alta_w = 'N' AND dt_entrada >= clock_timestamp() - qt_dia_w))
		AND 	((coalesce(nr_atend_original::text, '') = '') OR (ie_considera_atend_retorno_w = 'S')) 
		AND		(((coalesce(dt_cancelamento::text, '') = '') AND (ie_atendimento_cancelado_w = 'N')) OR (ie_atendimento_cancelado_w = 'S'))
		AND		((ie_consiste_mot_alt_atend_w = 'N') OR ((ie_consiste_mot_alt_atend_w = 'S') AND (COALESCE(cd_motivo_alta, -1) = COALESCE(cd_motivo_alta_w, -1))))
		AND		((ie_consiste_categ_w = 'N') OR ((ie_consiste_categ_w = 'S') AND (cd_categoria = COALESCE(cd_categoria_w, 'xpto'))))
		AND		((ie_consiste_plano_w = 'N') OR ((ie_consiste_plano_w = 'S') AND (COALESCE(cd_plano_convenio, cd_plano_convenio_w,'xpto') = COALESCE(cd_plano_convenio_w,'xpto'))));

	ELSIF (ie_regra_w = 'F') THEN

		SELECT	COALESCE(MAX(nr_atendimento),0)
		INTO STRICT 	nr_atend_retorno_p
		FROM 	
			(
			SELECT	c.nr_atendimento,
					a.nr_atend_original,
					a.dt_entrada,
					a.cd_pessoa_fisica,
					a.ie_tipo_atendimento,
					a.cd_medico_resp,
					a.dt_alta,
					a.ie_clinica,
					a.cd_estabelecimento,
					a.ie_tipo_convenio,
					c.cd_convenio,
					c.cd_categoria,
					c.cd_usuario_convenio,
					c.nr_doc_convenio,
					c.nr_doc_convenio nr_guia_atend,
					c.dt_inicio_vigencia,
					c.dt_final_vigencia,
					c.cd_plano_convenio,
					(SELECT SUBSTR(obter_cid_atendimento(a.nr_atendimento,'P'),1,10) ) cd_cid_principal,
					a.ds_obs_alta,
					a.nr_seq_forma_chegada,
					c.ie_tipo_guia,
					a.nr_seq_classificacao,
					a.nr_seq_queixa, 
					a.ie_tipo_atend_tiss,
					c.nr_seq_origem,
					a.dt_cancelamento,
					a.dt_saida_real,
					a.nm_usuario_saida,
					a.nr_seq_grau_parentesco,
					a.cd_motivo_alta,
					(SELECT obter_setor_atendimento(a.nr_atendimento) ) cd_setor_atendimento
			FROM	atend_categoria_convenio c,
					atendimento_paciente a
			WHERE	a.nr_atendimento = c.nr_atendimento
			AND 	a.cd_pessoa_fisica = COALESCE(cd_pessoa_fisica_w, 'xpto')
			AND 	a.nr_atendimento <> nr_atendimento_p
			AND		((ie_mesmo_estab_w = 'S') OR (ie_mesmo_estab_w = 'N' AND (a.cd_estabelecimento = COALESCE(cd_estabelecimento_w, -1))))
			AND 	c.nr_seq_interno = (SELECT COALESCE(MAX(x.nr_seq_interno),0)
										FROM 	atend_categoria_convenio x
										WHERE	x.nr_atendimento = a.nr_atendimento
										AND 	x.dt_inicio_vigencia = 
												(SELECT MAX(y.dt_inicio_vigencia)
												FROM 	atend_categoria_convenio y
												WHERE 	y.nr_atendimento = a.nr_atendimento))
			) a
		WHERE	((ie_mesmo_tipo_atend_w = 'N') OR (ie_tipo_atendimento = COALESCE(ie_tipo_atendimento_w, -1)))
		AND		((ie_mesmo_tipo_tiss_w = 'N') OR (COALESCE(a.ie_tipo_atend_tiss, ie_tipo_atend_tiss_w, 'xpto') = COALESCE(ie_tipo_atend_tiss_w, 'xpto')))
		AND 	((ie_data_alta_w = 'S' AND ((qt_dia_w > 0  AND COALESCE(dt_alta,dt_entrada) BETWEEN clock_timestamp() - qt_dia_w AND clock_timestamp()) 
				OR (qt_dia_w  = 0 AND qt_hora_w > 0  AND COALESCE(dt_alta,dt_entrada) BETWEEN clock_timestamp() - (qt_hora_w/24) AND clock_timestamp()))) 
				OR (ie_data_alta_w = 'N' AND ((qt_dia_w > 0  AND dt_entrada BETWEEN clock_timestamp() - qt_dia_w AND clock_timestamp()) 
				OR (qt_dia_w  = 0 AND qt_hora_w > 0  AND dt_entrada BETWEEN clock_timestamp() - (qt_hora_w/24) AND clock_timestamp()))))
		AND		((coalesce(nr_atend_original::text, '') = '') OR (ie_considera_atend_retorno_w = 'S'))
		AND		(((coalesce(dt_cancelamento::text, '') = '') AND (ie_atendimento_cancelado_w = 'N')) OR (ie_atendimento_cancelado_w = 'S')) 
		AND		((ie_consiste_mot_alt_atend_w = 'N') OR ((ie_consiste_mot_alt_atend_w = 'S') AND (COALESCE(cd_motivo_alta, -1) = COALESCE(cd_motivo_alta_w, -1))));
		
	ELSIF (ie_regra_w = 'H') THEN

		SELECT	COALESCE(MAX(nr_atendimento),0)
		INTO STRICT 	nr_atend_retorno_p
		FROM 	
			(
			SELECT	c.nr_atendimento,
					a.nr_atend_original,
					a.dt_entrada,
					a.cd_pessoa_fisica,
					a.ie_tipo_atendimento,
					a.cd_medico_resp,
					a.dt_alta,
					a.ie_clinica,
					a.cd_estabelecimento,
					a.ie_tipo_convenio,
					c.cd_convenio,
					c.cd_categoria,
					c.cd_usuario_convenio,
					c.nr_doc_convenio,
					c.nr_doc_convenio nr_guia_atend,
					c.dt_inicio_vigencia,
					c.dt_final_vigencia,
					c.cd_plano_convenio,
					(SELECT SUBSTR(obter_cid_atendimento(a.nr_atendimento,'P'),1,10) ) cd_cid_principal,
					a.ds_obs_alta,
					a.nr_seq_forma_chegada,
					c.ie_tipo_guia,
					a.nr_seq_classificacao,
					a.nr_seq_queixa,
					a.ie_tipo_atend_tiss,
					c.nr_seq_origem,
					a.dt_cancelamento,
					a.dt_saida_real,
					a.nm_usuario_saida,
					a.nr_seq_grau_parentesco,
					a.cd_motivo_alta,
					(SELECT obter_setor_atendimento(a.nr_atendimento) ) cd_setor_atendimento
			FROM	atend_categoria_convenio c,
					atendimento_paciente a
			WHERE	a.nr_atendimento = c.nr_atendimento
			AND 	a.cd_pessoa_fisica = COALESCE(cd_pessoa_fisica_w, 'xpto')
			AND 	a.nr_atendimento <> nr_atendimento_p
			AND		((ie_mesmo_estab_w = 'S') OR (ie_mesmo_estab_w = 'N' AND (a.cd_estabelecimento = COALESCE(cd_estabelecimento_w, -1))))
			AND 	c.nr_seq_interno = (SELECT	COALESCE(MAX(x.nr_seq_interno),0)
										FROM 	atend_categoria_convenio x
										WHERE	x.nr_atendimento = a.nr_atendimento
										AND 	x.dt_inicio_vigencia = 
												(SELECT MAX(y.dt_inicio_vigencia)
												FROM 	atend_categoria_convenio y
												WHERE 	y.nr_atendimento = a.nr_atendimento))
			) a
		WHERE	((ie_mesmo_tipo_atend_w = 'N') OR (ie_tipo_atendimento = COALESCE(ie_tipo_atendimento_w, -1)))
		AND		((ie_mesmo_tipo_tiss_w = 'N') OR (COALESCE(a.ie_tipo_atend_tiss, ie_tipo_atend_tiss_w, 'xpto') = COALESCE(ie_tipo_atend_tiss_w, 'xpto')))
		AND (a.cd_convenio = COALESCE(cd_convenio_w, -1))
		AND 	((ie_data_alta_w = 'S' AND ((qt_dia_w > 0  AND COALESCE(dt_alta,dt_entrada) BETWEEN clock_timestamp() - qt_dia_w AND clock_timestamp())
				OR (qt_dia_w  = 0 AND qt_hora_w > 0  AND COALESCE(dt_alta,dt_entrada) BETWEEN clock_timestamp() - (qt_hora_w/24) AND clock_timestamp()))) 
				OR (ie_data_alta_w = 'N' AND ((qt_dia_w > 0  AND dt_entrada BETWEEN clock_timestamp() - qt_dia_w AND clock_timestamp()) 
				OR (qt_dia_w  = 0 AND qt_hora_w > 0  AND dt_entrada BETWEEN clock_timestamp() - (qt_hora_w/24) AND clock_timestamp()))))
		AND		((coalesce(nr_atend_original::text, '') = '') OR (ie_considera_atend_retorno_w = 'S'))
		AND		(((coalesce(dt_cancelamento::text, '') = '') AND (ie_atendimento_cancelado_w = 'N')) OR (ie_atendimento_cancelado_w = 'S')) 
		AND		((ie_consiste_mot_alt_atend_w = 'N') OR ((ie_consiste_mot_alt_atend_w = 'S') AND (COALESCE(cd_motivo_alta, -1) = COALESCE(cd_motivo_alta_w, -1))))
		AND		((ie_consiste_plano_w = 'N') OR ((ie_consiste_plano_w = 'S') AND (COALESCE(cd_plano_convenio, cd_plano_convenio_w, 'xpto') = COALESCE(cd_plano_convenio_w, 'xpto'))));

	ELSIF (ie_regra_w = 'E') THEN

		OPEN C02;
		LOOP
		FETCH	C02
		INTO	nr_atendimento_w,
				cd_medico_w,
				nr_seq_queixa_w,
				cd_cid_principal_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */

			SELECT COALESCE(MAX(1),0)
			INTO STRICT	ie_ok_w
			FROM	medico_especialidade a
			WHERE	a.cd_pessoa_fisica = cd_medico_w
			AND		EXISTS (SELECT	1
					FROM	medico_especialidade x
					WHERE	x.cd_pessoa_fisica = COALESCE(cd_medico_resp_w, 'xpto')
					AND 	x.cd_especialidade = a.cd_especialidade);

			IF (ie_ok_w > 0) THEN
				nr_atend_retorno_p := nr_atendimento_w;
			ELSE
				SELECT  COALESCE(MAX(1),0)
				INTO STRICT	ie_ok_w
				FROM	medico_especialidade a
				WHERE	a.cd_pessoa_fisica = cd_medico_w;

				SELECT  COALESCE(MAX(1),0)
				INTO STRICT	ie_ok_atual_w
				FROM	medico_especialidade a
				WHERE	a.cd_pessoa_fisica = COALESCE(cd_medico_resp_w, 'xpto');

				IF	((ie_ok_w + ie_ok_atual_w) = 0) THEN
					nr_atend_retorno_p := nr_atendimento_w;
				END IF;
			END IF;
		END LOOP;
		CLOSE C02;
		
	ELSIF (ie_regra_w = 'Y') THEN
		OPEN C02;
		LOOP
		FETCH	C02
		INTO	nr_atendimento_w,
				cd_medico_w,
				nr_seq_queixa_w,
				cd_cid_principal_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */

			cd_espec_atend_retorno_w := Obter_Espec_medico_atend(nr_atendimento_w,cd_medico_w,'C');

			IF (cd_espec_atend_w = cd_espec_atend_retorno_w) THEN
				nr_atend_retorno_p := nr_atendimento_w;
			END IF;
		END LOOP;
		CLOSE C02;
		
	ELSIF (ie_regra_w = 'U') THEN
		OPEN C02;
		LOOP
		FETCH 	C02
		INTO	nr_atendimento_w,
				cd_medico_w,
				nr_seq_queixa_w,
				cd_cid_principal_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			IF (nr_seq_queixa_w IS NOT NULL AND nr_seq_queixa_w::text <> '') AND (nr_seq_queixa_origem_w IS NOT NULL AND nr_seq_queixa_origem_w::text <> '') AND (nr_seq_queixa_origem_w = nr_seq_queixa_w) THEN
				nr_atend_retorno_p := nr_atendimento_w;
			END IF;
		END LOOP;
		CLOSE C02;
		
	ELSIF (ie_regra_w = 'C') THEN
		BEGIN
		OPEN C02;
		LOOP
		FETCH 	C02
		INTO	nr_atendimento_w,
				cd_medico_w,
				nr_seq_queixa_w,
				cd_cid_principal_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			IF (cd_cid_principal_w IS NOT NULL AND cd_cid_principal_w::text <> '') AND (cd_cid_principal_origem_w IS NOT NULL AND cd_cid_principal_origem_w::text <> '') AND
				((cd_cid_principal_origem_w = cd_cid_principal_w) OR (obter_se_cid_equivalente(cd_cid_principal_w,cd_cid_principal_origem_w) = 'S')) THEN
				nr_atend_retorno_p := nr_atendimento_w;
			END IF;
		END LOOP;
		CLOSE C02;
		END;
		
	ELSIF (ie_regra_w = 'T') THEN
		BEGIN
		OPEN C02;
		LOOP
		FETCH 	C02
		INTO	nr_atendimento_w,
				cd_medico_w,
				nr_seq_queixa_w,
				cd_cid_principal_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			SELECT	Obter_Categoria_Cid(cd_cid_principal_w)
			INTO STRICT	cd_categoria_cid_w
			;
			IF (cd_categoria_cid_w IS NOT NULL AND cd_categoria_cid_w::text <> '') AND (cd_categoria_cid_origem_w IS NOT NULL AND cd_categoria_cid_origem_w::text <> '') AND (cd_categoria_cid_origem_w = cd_categoria_cid_w) THEN
				nr_atend_retorno_p := nr_atendimento_w;
			END IF;
		END LOOP;
		CLOSE C02;
		END;
		
	ELSIF (ie_regra_w = 'K') THEN
		BEGIN
		OPEN C02;
		LOOP
		FETCH 	C02
		INTO	nr_atendimento_w,
				cd_medico_w,
				nr_seq_queixa_w,
				cd_cid_principal_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			IF (cd_cid_principal_w IS NOT NULL AND cd_cid_principal_w::text <> '') AND (cd_cid_principal_origem_w IS NOT NULL AND cd_cid_principal_origem_w::text <> '') AND
				((cd_cid_principal_origem_w = cd_cid_principal_w) OR (obter_se_cid_equivalente(cd_cid_principal_w,cd_cid_principal_origem_w) = 'S')) THEN
				BEGIN
				SELECT	COALESCE(MAX(1),0)
				INTO STRICT	qt_existe_w
				FROM 	
					(
					SELECT	c.nr_atendimento,
							a.nr_atend_original,
							a.dt_entrada,
							a.cd_pessoa_fisica,
							a.ie_tipo_atendimento,
							a.cd_medico_resp,
							a.dt_alta,
							a.ie_clinica,
							a.cd_estabelecimento,
							a.ie_tipo_convenio,
							c.cd_convenio,
							c.cd_categoria,
							c.cd_usuario_convenio,
							c.nr_doc_convenio,
							c.nr_doc_convenio nr_guia_atend,
							c.dt_inicio_vigencia,
							c.dt_final_vigencia,
							c.cd_plano_convenio,
							(SELECT SUBSTR(obter_cid_atendimento(a.nr_atendimento,'P'),1,10) ) cd_cid_principal,
							a.ds_obs_alta,
							a.nr_seq_forma_chegada,
							c.ie_tipo_guia,
							a.nr_seq_classificacao,
							a.nr_seq_queixa,
							a.ie_tipo_atend_tiss,
							c.nr_seq_origem,
							a.dt_cancelamento,
							a.dt_saida_real,
							a.nm_usuario_saida,
							a.nr_seq_grau_parentesco,
							a.cd_motivo_alta,
							(SELECT obter_setor_atendimento(a.nr_atendimento) ) cd_setor_atendimento
					FROM	atend_categoria_convenio c,
							atendimento_paciente a
					WHERE	a.nr_atendimento = c.nr_atendimento
					AND 	a.cd_pessoa_fisica = COALESCE(cd_pessoa_fisica_w, 'xpto')
					AND 	a.nr_atendimento <> nr_atendimento_p
					AND		((ie_mesmo_estab_w = 'S') OR (ie_mesmo_estab_w = 'N' AND (a.cd_estabelecimento = COALESCE(cd_estabelecimento_w, -1))))
					AND 	c.nr_seq_interno = (SELECT	COALESCE(MAX(x.nr_seq_interno),0)
												FROM 	atend_categoria_convenio x
												WHERE	x.nr_atendimento = a.nr_atendimento
												AND 	x.dt_inicio_vigencia = 
														(SELECT MAX(y.dt_inicio_vigencia)
														FROM 	atend_categoria_convenio y
														WHERE 	y.nr_atendimento = a.nr_atendimento))
					) a
				WHERE	nr_atendimento = nr_atendimento_w
				AND		((ie_mesmo_tipo_atend_w = 'N') OR (ie_tipo_atendimento = COALESCE(ie_tipo_atendimento_w, -1)))
				AND		((ie_mesmo_tipo_tiss_w = 'N') OR (COALESCE(a.ie_tipo_atend_tiss, ie_tipo_atend_tiss_w, 'xpto') = COALESCE(ie_tipo_atend_tiss_w, 'xpto')))
				AND (a.cd_convenio = COALESCE(cd_convenio_w, -1))
				AND (COALESCE(ie_clinica, ie_clinica_w, -1) = COALESCE(ie_clinica_w, -1))
				AND (cd_medico_resp = COALESCE(cd_medico_resp_w, 'xpto'))
				AND 	((ie_data_alta_w = 'S' AND COALESCE(dt_alta,dt_entrada) >= clock_timestamp() - qt_dia_w) OR (ie_data_alta_w = 'N' AND dt_entrada >= clock_timestamp() - qt_dia_w))
				AND 	((coalesce(nr_atend_original::text, '') = '') OR (ie_considera_atend_retorno_w = 'S'))
				AND		(((coalesce(dt_cancelamento::text, '') = '') AND (ie_atendimento_cancelado_w = 'N')) OR (ie_atendimento_cancelado_w = 'S'))
				AND		((ie_consiste_mot_alt_atend_w = 'N') OR ((ie_consiste_mot_alt_atend_w = 'S') AND (COALESCE(cd_motivo_alta, -1) = COALESCE(cd_motivo_alta_w, -1))));

				IF (qt_existe_w > 0) THEN
					nr_atend_retorno_p := nr_atendimento_w;
				END IF;
				END;
			END IF;
		END LOOP;
		CLOSE C02;
		END;
		
	ELSIF (ie_regra_w = 'R') THEN
		OPEN C02;
		LOOP
		FETCH 	C02
		INTO	nr_atendimento_w,
				cd_medico_w,
				nr_seq_queixa_w,
				cd_cid_principal_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */

			SELECT 	COALESCE(MAX(1),0)
			INTO STRICT 	ie_ok_w
			FROM	cirurgia
			WHERE	nr_atendimento = nr_atendimento_w;

			IF (ie_ok_w > 0) THEN
				nr_atend_retorno_p := nr_atendimento_w;
			END IF;
		END LOOP;
		CLOSE C02;
		
	ELSIF (ie_regra_w = 'G') THEN
		SELECT	COALESCE(MAX(nr_atendimento),0)
		INTO STRICT 	nr_atend_retorno_p
		FROM 	
			(
			SELECT	c.nr_atendimento,
					a.nr_atend_original,
					a.dt_entrada,
					a.cd_pessoa_fisica,
					a.ie_tipo_atendimento,
					a.cd_medico_resp,
					a.dt_alta,
					a.ie_clinica,
					a.cd_estabelecimento,
					a.ie_tipo_convenio,
					c.cd_convenio,
					c.cd_categoria,
					c.cd_usuario_convenio,
					c.nr_doc_convenio,
					c.nr_doc_convenio nr_guia_atend,
					c.dt_inicio_vigencia,
					c.dt_final_vigencia,
					c.cd_plano_convenio,
					(SELECT SUBSTR(obter_cid_atendimento(a.nr_atendimento,'P'),1,10) ) cd_cid_principal,
					a.ds_obs_alta,
					a.nr_seq_forma_chegada,
					c.ie_tipo_guia,
					a.nr_seq_classificacao,
					a.nr_seq_queixa,
					a.ie_tipo_atend_tiss,
					c.nr_seq_origem,
					a.dt_cancelamento,
					a.dt_saida_real,
					a.nm_usuario_saida,
					a.nr_seq_grau_parentesco,
					a.cd_motivo_alta,
					(SELECT obter_setor_atendimento(a.nr_atendimento) ) cd_setor_atendimento
			FROM	atend_categoria_convenio c,
					atendimento_paciente a
			WHERE	a.nr_atendimento = c.nr_atendimento
			AND 	a.cd_pessoa_fisica = COALESCE(cd_pessoa_fisica_w, 'xpto')
			AND 	a.nr_atendimento <> nr_atendimento_p
			AND		((ie_mesmo_estab_w = 'S') OR (ie_mesmo_estab_w = 'N' AND (a.cd_estabelecimento = COALESCE(cd_estabelecimento_w, -1))))
			AND 	c.nr_seq_interno = (SELECT COALESCE(MAX(x.nr_seq_interno),0)
										FROM 	atend_categoria_convenio x
										WHERE	x.nr_atendimento = a.nr_atendimento
										AND 	x.dt_inicio_vigencia = 
												(SELECT MAX(y.dt_inicio_vigencia)
												FROM 	atend_categoria_convenio y
												WHERE 	y.nr_atendimento = a.nr_atendimento))
			) a
		WHERE	((ie_mesmo_tipo_atend_w = 'N') OR (ie_tipo_atendimento = COALESCE(ie_tipo_atendimento_w, -1)))
		AND		((ie_mesmo_tipo_tiss_w = 'N') OR (COALESCE(a.ie_tipo_atend_tiss, ie_tipo_atend_tiss_w, 'xpto') = COALESCE(ie_tipo_atend_tiss_w, 'xpto')))
		AND (cd_medico_resp = COALESCE(cd_medico_resp_w, 'xpto'))
		AND 	((ie_data_alta_w = 'S' AND COALESCE(dt_alta,dt_entrada) >= clock_timestamp() - qt_dia_w) OR (ie_data_alta_w = 'N' AND dt_entrada >= clock_timestamp() - qt_dia_w))
		AND 	((coalesce(nr_atend_original::text, '') = '') OR (ie_considera_atend_retorno_w = 'S')) 
		AND 	(((coalesce(dt_cancelamento::text, '') = '') AND (ie_atendimento_cancelado_w = 'N')) OR (ie_atendimento_cancelado_w = 'S')) 
		AND		((ie_consiste_mot_alt_atend_w = 'N') OR ((ie_consiste_mot_alt_atend_w = 'S') AND (COALESCE(cd_motivo_alta, -1) = COALESCE(cd_motivo_alta_w, -1))));
		
	ELSIF (ie_regra_w = 'D') THEN
			OPEN C02;
			LOOP
			FETCH 	C02
			INTO	nr_atendimento_w,
					cd_medico_w,
					nr_seq_queixa_w,
					cd_cid_principal_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */

				IF (cd_cid_principal_w IS NOT NULL AND cd_cid_principal_w::text <> '') AND (cd_cid_principal_origem_w IS NOT NULL AND cd_cid_principal_origem_w::text <> '') AND
					((cd_cid_principal_origem_w = cd_cid_principal_w) OR (obter_se_cid_equivalente(cd_cid_principal_w,cd_cid_principal_origem_w) = 'S')) THEN
					BEGIN

					SELECT	COALESCE(MAX(1),0)
					INTO STRICT	qt_existe_w
					FROM 	
						(
						SELECT	c.nr_atendimento,
								a.nr_atend_original,
								a.dt_entrada,
								a.cd_pessoa_fisica,
								a.ie_tipo_atendimento,
								a.cd_medico_resp,
								a.dt_alta,
								a.ie_clinica,
								a.cd_estabelecimento,
								a.ie_tipo_convenio,
								c.cd_convenio,
								c.cd_categoria,
								c.cd_usuario_convenio,
								c.nr_doc_convenio,
								c.nr_doc_convenio nr_guia_atend,
								c.dt_inicio_vigencia,
								c.dt_final_vigencia,
								c.cd_plano_convenio,
								(SELECT SUBSTR(obter_cid_atendimento(a.nr_atendimento,'P'),1,10) ) cd_cid_principal,
								a.ds_obs_alta,
								a.nr_seq_forma_chegada,
								c.ie_tipo_guia,
								a.nr_seq_classificacao,
								a.nr_seq_queixa,
								a.ie_tipo_atend_tiss,
								c.nr_seq_origem,
								a.dt_cancelamento,
								a.dt_saida_real,
								a.nm_usuario_saida,
								a.nr_seq_grau_parentesco,
								a.cd_motivo_alta,
								(SELECT obter_setor_atendimento(a.nr_atendimento) ) cd_setor_atendimento
						FROM	atend_categoria_convenio c,
								atendimento_paciente a
						WHERE	a.nr_atendimento = c.nr_atendimento
						AND 	a.cd_pessoa_fisica = COALESCE(cd_pessoa_fisica_w, 'xpto')
						AND 	a.nr_atendimento <> nr_atendimento_p
						AND		((ie_mesmo_estab_w = 'S') OR (ie_mesmo_estab_w = 'N' AND (a.cd_estabelecimento = COALESCE(cd_estabelecimento_w, -1))))
				  		AND 	c.nr_seq_interno = (SELECT	COALESCE(MAX(x.nr_seq_interno),0)
													FROM 	atend_categoria_convenio x
													WHERE	x.nr_atendimento = a.nr_atendimento
													AND 	x.dt_inicio_vigencia = 
															(SELECT MAX(y.dt_inicio_vigencia)
															FROM 	atend_categoria_convenio y
															WHERE 	y.nr_atendimento = a.nr_atendimento))
						) a
					WHERE	nr_atendimento = nr_atendimento_w
					AND (COALESCE(ie_clinica, ie_clinica_w, -1) = COALESCE(ie_clinica_w, -1))
					AND		((ie_mesmo_tipo_atend_w = 'N') OR (ie_tipo_atendimento = COALESCE(ie_tipo_atendimento_w, -1)))
					AND		((ie_mesmo_tipo_tiss_w = 'N') OR (COALESCE(a.ie_tipo_atend_tiss, ie_tipo_atend_tiss_w, 'xpto') = COALESCE(ie_tipo_atend_tiss_w, 'xpto')))
					AND (a.cd_convenio = COALESCE(cd_convenio_w, -1))
					AND (cd_medico_resp = COALESCE(cd_medico_resp_w, 'xpto'))
					AND 	((ie_data_alta_w = 'S' AND ((qt_dia_w > 0  AND COALESCE(dt_alta,dt_entrada) BETWEEN clock_timestamp() - qt_dia_w AND clock_timestamp()) 
							OR (qt_dia_w  = 0 AND qt_hora_w > 0  AND COALESCE(dt_alta,dt_entrada) BETWEEN clock_timestamp() - (qt_hora_w/24) AND clock_timestamp()))) 
							OR (ie_data_alta_w = 'N' AND ((qt_dia_w > 0  AND dt_entrada BETWEEN clock_timestamp() - qt_dia_w AND clock_timestamp())
							OR (qt_dia_w  = 0 AND qt_hora_w > 0  AND dt_entrada BETWEEN clock_timestamp() - (qt_hora_w/24) AND clock_timestamp()))))
					AND 	((coalesce(nr_atend_original::text, '') = '') OR (ie_considera_atend_retorno_w = 'S'))
					AND		(((coalesce(dt_cancelamento::text, '') = '') AND (ie_atendimento_cancelado_w = 'N')) OR (ie_atendimento_cancelado_w = 'S'))
					AND		((ie_consiste_mot_alt_atend_w = 'N') OR ((ie_consiste_mot_alt_atend_w = 'S') AND (COALESCE(cd_motivo_alta, -1) = COALESCE(cd_motivo_alta_w, -1))));

					IF (qt_existe_w > 0) THEN
						nr_atend_retorno_p := nr_atendimento_w;
					END IF;

					END;
				END IF;
			END LOOP;
			CLOSE C02;

	ELSIF (ie_regra_w = 'N') THEN
		SELECT	COALESCE(MAX(nr_atendimento),0)
		INTO STRICT 	nr_atend_retorno_p
		FROM 	
			(
			SELECT	c.nr_atendimento,
					a.nr_atend_original,
					a.dt_entrada,
					a.cd_pessoa_fisica,
					a.ie_tipo_atendimento,
					a.cd_medico_resp,
					a.dt_alta,
					a.ie_clinica,
					a.cd_estabelecimento,
					a.ie_tipo_convenio,
					c.cd_convenio,
					c.cd_categoria,
					c.cd_usuario_convenio,
					c.nr_doc_convenio,
					c.nr_doc_convenio nr_guia_atend,
					c.dt_inicio_vigencia,
					c.dt_final_vigencia,
					c.cd_plano_convenio,
					(SELECT SUBSTR(obter_cid_atendimento(a.nr_atendimento,'P'),1,10) ) cd_cid_principal,
					a.ds_obs_alta,
					a.nr_seq_forma_chegada,
					c.ie_tipo_guia,
					a.nr_seq_classificacao,
					a.nr_seq_queixa,
					a.ie_tipo_atend_tiss,
					c.nr_seq_origem,
					a.dt_cancelamento,
					a.dt_saida_real,
					a.nm_usuario_saida,
					a.nr_seq_grau_parentesco,
					a.cd_motivo_alta,
					(SELECT obter_setor_atendimento(a.nr_atendimento) ) cd_setor_atendimento
			FROM	atend_categoria_convenio c,
					atendimento_paciente a
			WHERE	a.nr_atendimento = c.nr_atendimento
			AND 	a.cd_pessoa_fisica = COALESCE(cd_pessoa_fisica_w, 'xpto')
			AND 	a.nr_atendimento <> nr_atendimento_p
			AND		c.nr_seq_interno = (SELECT COALESCE(MAX(x.nr_seq_interno),0)
										FROM 	atend_categoria_convenio x
										WHERE	x.nr_atendimento = a.nr_atendimento
										AND 	x.dt_inicio_vigencia = 
												(SELECT MAX(y.dt_inicio_vigencia)
												FROM 	atend_categoria_convenio y
												WHERE 	y.nr_atendimento = a.nr_atendimento))
			) a
		WHERE (a.cd_convenio = COALESCE(cd_convenio_w, -1))
		AND (COALESCE(ie_clinica, ie_clinica_w, -1) = COALESCE(ie_clinica_w, -1))
		AND		((ie_mesmo_tipo_atend_w = 'N') OR (ie_tipo_atendimento = COALESCE(ie_tipo_atendimento_w, -1)))
		AND		((ie_mesmo_tipo_tiss_w = 'N') OR (COALESCE(a.ie_tipo_atend_tiss, ie_tipo_atend_tiss_w, 'xpto') = COALESCE(ie_tipo_atend_tiss_w, 'xpto')))
		AND		((ie_consiste_classif_w = 'N') OR (COALESCE(nr_seq_classificacao, nr_seq_classificacao_regra_w,-1)	= COALESCE(nr_seq_classificacao_regra_w,-1))) 
		AND 	((ie_data_alta_w = 'S' AND ((qt_dia_w > 0  AND COALESCE(dt_alta,dt_entrada) BETWEEN clock_timestamp() - qt_dia_w AND clock_timestamp())
				OR (qt_dia_w  = 0 AND qt_hora_w > 0  AND COALESCE(dt_alta,dt_entrada) BETWEEN clock_timestamp() - (qt_hora_w/24) AND clock_timestamp())))
				OR (ie_data_alta_w = 'N' AND ((qt_dia_w > 0  AND dt_entrada BETWEEN clock_timestamp() - qt_dia_w AND clock_timestamp())
				OR (qt_dia_w  = 0 AND qt_hora_w > 0  AND dt_entrada BETWEEN clock_timestamp() - (qt_hora_w/24) AND clock_timestamp()))))
		AND 	((coalesce(nr_atend_original::text, '') = '') OR (ie_considera_atend_retorno_w = 'S')) 
		AND		(((coalesce(dt_cancelamento::text, '') = '') AND (ie_atendimento_cancelado_w = 'N')) OR (ie_atendimento_cancelado_w = 'S')) 
		AND		((ie_consiste_mot_alt_atend_w = 'N') OR ((ie_consiste_mot_alt_atend_w = 'S') AND (COALESCE(cd_motivo_alta, -1) = COALESCE(cd_motivo_alta_w, -1))));

	ELSE
		OPEN C02;
		LOOP
		FETCH 	C02
		INTO	nr_atendimento_w,
				cd_medico_w,
				nr_seq_queixa_w,
				cd_cid_principal_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */

			nr_atend_retorno_p := nr_atendimento_w;
			
		END LOOP;
		CLOSE C02;

	END IF;

	IF (nr_atend_retorno_p > 0) THEN

		ds_retorno_proc_w := consiste_regra_retorno_proc(nr_seq_regra_w, nr_atend_retorno_p, ds_retorno_proc_w);

		IF (ds_retorno_proc_w = 'N') THEN	--A regra de retorno possuia regra por procedimento, porem nao encontrou o procedimento no atendimento anterior.
			nr_atend_retorno_p	:= 0;
		END IF;

	END IF;

	IF (nr_atend_retorno_p	> 0) AND (ie_dentro_mes_w	= 'S') THEN
		SELECT	TO_DATE('01/'||TO_CHAR(dt_entrada,'mm/yyyy')),
				TO_DATE('01/'||TO_CHAR(clock_timestamp(),'mm/yyyy'))
		INTO STRICT	dt_entrada_w,
				dt_atual_w
		FROM	atendimento_paciente
		WHERE	nr_atendimento	= nr_atend_retorno_p;


		IF (dt_atual_w > dt_entrada_w) THEN
			nr_atend_retorno_p	:= 0;
		END IF;
	END IF;


	IF (nr_atend_retorno_p	> 0) AND (ie_dentro_dia_w	= 'S') THEN
		SELECT	TO_DATE(dt_entrada,'dd/mm/yyyy'),
				TO_DATE(clock_timestamp(),'dd/mm/yyyy')
		INTO STRICT	dt_entrada_w,
				dt_atual_w
		FROM	atendimento_paciente
		WHERE	nr_atendimento	= nr_atend_retorno_p;


		IF (dt_atual_w > dt_entrada_w) THEN
			nr_atend_retorno_p	:= 0;
		END IF;
	END IF;

	IF (nr_atend_retorno_p > 0)
	AND (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') THEN
		nr_seq_regra_msg_p := nr_seq_regra_w;
	END IF;

	 IF (nr_atend_retorno_p	> 0) THEN
		INSERT
		INTO	log_retorno_atendimento(DT_ATUALIZACAO,
				NM_USUARIO,
				CD_LOG,
				DS_LOG)
		VALUES (clock_timestamp(),
				wheb_usuario_pck.get_nm_usuario,
				99999,
				Wheb_mensagem_pck.get_texto(445094) || nr_atendimento_p || Wheb_mensagem_pck.get_texto(445095) || nr_atend_retorno_p);
		COMMIT;
	END IF;

END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE define_atendimento_retorno ( nr_atendimento_p bigint, nr_atend_retorno_p INOUT bigint, nr_seq_regra_msg_p INOUT bigint ) FROM PUBLIC;

