-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cm_gerar_retorno_externo ( nr_seq_envio_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


ie_grava_codigo_w		varchar(1);
nr_seq_item_w		bigint;
cd_codigo_w		varchar(20);

c01 CURSOR FOR
SELECT	nr_seq_item,
	cd_codigo
from	cm_envio_externo_item
where	nr_sequencia = nr_seq_item
and	(cd_codigo IS NOT NULL AND cd_codigo::text <> '');


BEGIN

update	cm_envio_externo
set	dt_retorno = clock_timestamp(),
	dt_atualizacao = clock_timestamp(),
	nm_usuario = nm_usuario_p
where	nr_sequencia = nr_seq_envio_p;

ie_grava_codigo_w := obter_valor_param_usuario(406, 85, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p);

if (ie_grava_codigo_w = 'S') then
	begin

	open c01;
	loop
	fetch c01 into
		nr_seq_item_w,
		cd_codigo_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		update	cm_item
		set	cd_codigo = cd_codigo_w
		where	nr_sequencia = nr_seq_item_w;

		end;
	end loop;
	close c01;

	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cm_gerar_retorno_externo ( nr_seq_envio_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

