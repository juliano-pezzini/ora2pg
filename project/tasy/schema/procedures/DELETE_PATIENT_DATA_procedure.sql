-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE delete_patient_data ( cd_Patient_Id_p text, nm_usuario_p text, ie_commit_p text, ie_deleted_p INOUT text ) AS $body$
DECLARE


cd_pessoa_fisica_new_w    pessoa_fisica.cd_pessoa_fisica%type;
query_w varchar(4000)    := '';
qt_regs_w                 bigint    := 0;
ds_column_name_w          USER_CONS_COLUMNS.COLUMN_NAME%type;
ds_hash_w                 varchar(100);
ds_error_message_w        varchar(2000);
n_                                  varchar(10) := CHR(13)||CHR(10);

GET_CONSTRAINTS CURSOR( DS_STATUS_PC text) FOR
   SELECT  a.table_name TABLE_NAME,
          a.constraint_name CONSTRAINT_NAME,
           a.status,
           a.owner NM_OWNER
   from    all_constraints a
   where   1=1 
   and     a.constraint_type = 'R'
   and     exists ( 
     SELECT 1
     from    all_constraints b
     where   b.constraint_type in ('P', 'U') 
     and      b.constraint_name   = a.r_constraint_name
     and      b.table_name        = 'PESSOA_FISICA'
   ) 
   and a.status = DS_STATUS_PC
   order by table_name, constraint_name;

  col RECORD;

BEGIN
RAISE NOTICE 'PROCESSO INICIADO.  %', to_char(clock_timestamp(),'dd/MM/yyyy hh24:mi:ss');

select  nextval('pessoa_fisica_seq') cd_pessoa_fisica
into STRICT    cd_pessoa_fisica_new_w
;

insert into pessoa_fisica(cd_pessoa_fisica, ie_tipo_pessoa, nm_pessoa_fisica, dt_atualizacao, nm_usuario)
values (cd_pessoa_fisica_new_w, 2, 'DELETED RECORD', clock_timestamp(), nm_usuario_p);

CALL wheb_usuario_pck.set_ie_executar_trigger('N');
RAISE NOTICE 'VERIFICANDO E LIMPANDO REGISTROS FILHOS DE PESSOA_FISICA...';
for con in GET_CONSTRAINTS('ENABLED') loop
    for col in (  SELECT COLUMN_NAME
                  from   user_cons_columns
                  where  constraint_name  = con.CONSTRAINT_NAME
                  and    owner            = con.NM_OWNER
                  and    table_name       = con.TABLE_NAME ) loop
        query_w := ' select count(1) QT from '||con.NM_OWNER||'.'||con.TABLE_NAME||' where '||col.COLUMN_NAME||' = :CD_PESSOA_FISICA ';

        EXECUTE query_w
        into STRICT qt_regs_w
        USING cd_Patient_Id_p;

        
        if (qt_regs_w > 0) then
            /*tem registros de pessoa fisica em outras tabelas*/

            RAISE NOTICE '%; --qt_regs_w: %', query_w, qt_regs_w;

            query_w :=  ' UPDATE '||con.NM_OWNER||'.'||con.TABLE_NAME||
                        ' SET   '||col.COLUMN_NAME||' = :CD_PESSOA_FISICA_NEW '||
                        ' WHERE '||col.COLUMN_NAME||' = :CD_PESSOA_FISICA_OLD ';
            begin
                EXECUTE query_w using  cd_pessoa_fisica_new_w, cd_Patient_Id_p;
            exception
            when others then
                CALL wheb_usuario_pck.set_ie_executar_trigger('S');
                ds_error_message_w := 'DELETE_PATIENT_DATA ERROR='||SQLERRM||n_||' SQL='||query_w ||n_||' params= ('|| cd_pessoa_fisica_new_w||','|| cd_Patient_Id_p||')';
                CALL insert_pessoa_fisica_deleted(  nm_usuario_p,
                                                cd_Patient_Id_p,
                                                con.TABLE_NAME,
                                                'N',
                                                substr(ds_error_message_w,1,2000) );
                RAISE NOTICE '%', ds_error_message_w;
                RAISE NOTICE 'PROCESSO CONCLUIDO COM ERROS.  %', to_char(clock_timestamp(),'dd/MM/yyyy hh24:mi:ss');
                Raise;
            end;

            if (ie_commit_p = 'S') then
                COMMIT;
            end if;

        end if;

    end loop;
end loop;

RAISE NOTICE 'FIM DA VERIFICACAO...';

begin
    RAISE NOTICE 'APAGANDO COMPLEMENTO...';
    query_w := ' delete from compl_pessoa_fisica where  cd_pessoa_fisica = :CD_PESSOA_FISICA ';
    EXECUTE query_w using cd_Patient_Id_p;

    RAISE NOTICE 'GERANDO HASH DE EXCLUSAO...';
    SELECT GET_MD5_HASH_VALUE( UPPER(NM_PESSOA_FISICA) || DT_NASCIMENTO || UPPER(OBTER_NOME_PESSOA_FISICA( CD_PESSOA_MAE ,'')) ) DS_PATIENT_HASH
    INTO STRICT   ds_hash_w
    FROM   PESSOA_FISICA
    WHERE  CD_PESSOA_FISICA = cd_Patient_Id_p;

    RAISE NOTICE 'APAGANDO PESSOA_FISICA...';
    query_w := ' delete from pessoa_fisica where  cd_pessoa_fisica = :CD_PESSOA_FISICA ';
    EXECUTE query_w using cd_Patient_Id_p;

    RAISE NOTICE 'INSERINDO HASH DE EXCLUSAO...';
    query_w := ' INSERT INTO PESSOA_FISICA_EXC (  NR_SEQUENCIA, DT_ATUALIZACAO, NM_USUARIO, '||
                                    ' DT_ATUALIZACAO_NREC, NM_USUARIO_NREC, DS_HASH, IE_SITUACAO ) '|| 
                              ' VALUES ( PESSOA_FISICA_EXC_SEQ.NextVal, SYSDATE, :NM_USUARIO, '||
                                      ' SYSDATE, :NM_USUARIO,:DS_HASH, ''A'') ';
    EXECUTE query_w using nm_usuario_p, nm_usuario_p, ds_hash_w;
exception
when others then
    CALL wheb_usuario_pck.set_ie_executar_trigger('S');
    ds_error_message_w := 'DELETE_PATIENT_DATA ERROR='||SQLERRM||n_||' SQL='||query_w ||
    'params={cd_Patient_Id_p: '||cd_Patient_Id_p||', nm_usuario_p: '||nm_usuario_p||', hash: '||ds_hash_w||'}';
    CALL insert_pessoa_fisica_deleted(  nm_usuario_p,
                                    cd_Patient_Id_p,
                                    'PESSOA_FISICA',
                                    'N',
                                    substr(ds_error_message_w,1,2000) );
    RAISE NOTICE '%', ds_error_message_w;
    RAISE NOTICE 'PROCESSO CONCLUIDO COM ERROS.  %', to_char(clock_timestamp(),'dd/MM/yyyy hh24:mi:ss');
    Raise;
end;
CALL wheb_usuario_pck.set_ie_executar_trigger('S');

if (ie_commit_p = 'S') then
    COMMIT;
end if;

qt_regs_w := 1;
query_w := ' select count(1) from pessoa_fisica where  cd_pessoa_fisica = :CD_PESSOA_FISICA ';
EXECUTE query_w into STRICT qt_regs_w using cd_Patient_Id_p;
if (qt_regs_w = 0) then
  ie_deleted_p :='S';
end if;

RAISE NOTICE 'PROCESSO CONCLUIDO.  %', to_char(clock_timestamp(),'dd/MM/yyyy hh24:mi:ss');
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE delete_patient_data ( cd_Patient_Id_p text, nm_usuario_p text, ie_commit_p text, ie_deleted_p INOUT text ) FROM PUBLIC;

