-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qua_gerar_rnc_audit ( nr_sequencia_p bigint, nr_tipo_rnc_p bigint, nr_seq_classif_p bigint, ds_acao_imediata_p text, cd_pessoa_efic_p text, cd_setor_efic_p bigint, nr_dias_efic_p bigint, nr_seq_setor_resp_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_pessoa_fisica_w			varchar(10);
ds_observacao_w				varchar(4000);
nr_sequencia_rnc_w			bigint;
cd_usuario_w				bigint;
cd_estabelecimento_w			smallint := wheb_usuario_pck.get_cd_estabelecimento;
cd_setor_atendimento_w			integer := wheb_usuario_pck.get_cd_setor_atendimento;
cd_setor_resp_w				bigint;
cd_setor_eficacia_w			bigint := coalesce(cd_setor_efic_p,wheb_usuario_pck.get_cd_setor_atendimento);
cd_setor_tipo_audit_w			bigint;
ie_gerar_setor_recep_audit_w		varchar(15);
ie_gerar_setor_eficacia_w		varchar(15);
ie_acao_imediata_w			varchar(2);


BEGIN
ie_gerar_setor_recep_audit_w := obter_param_usuario(4000, 215, obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, ie_gerar_setor_recep_audit_w);	
ie_gerar_setor_eficacia_w := obter_param_usuario(4000, 222, obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, ie_gerar_setor_eficacia_w);	

select	ie_acao_imediata
into STRICT	ie_acao_imediata_w
from	qua_tipo_nao_conform
where	nr_sequencia = nr_tipo_rnc_p;

if (ie_acao_imediata_w = 'OB') and (coalesce(ds_acao_imediata_p::text, '') = '') then
	begin
		CALL wheb_mensagem_pck.exibir_mensagem_abort(187815);
	end;
end if;

select	cd_pessoa_fisica,
	ds_observacao
into STRICT	cd_pessoa_fisica_w,
	ds_observacao_w
from	qua_audit_result_resp
where	nr_sequencia	= nr_sequencia_p;

select	nextval('qua_nao_conformidade_seq'),
	substr(obter_pessoa_fisica_usuario(nm_usuario_p,'C'),1,10)
into STRICT	nr_sequencia_rnc_w,
	cd_usuario_w
;

if (coalesce(ie_gerar_setor_recep_audit_w,'N') = 'S') then
	select	max(a.cd_setor_atendimento)
	into STRICT	cd_setor_resp_w
	from	qua_auditoria a,
		qua_auditoria_result b,
		qua_audit_result_resp c
	where	a.nr_sequencia = b.nr_seq_auditoria
	and	b.nr_sequencia = c.nr_seq_result_audit
	and	c.nr_sequencia = nr_sequencia_p;
end if;

select	max(b.cd_setor_atendimento)
into STRICT	cd_setor_tipo_audit_w
from	qua_auditoria a,
	qua_auditoria_tipo b,
	qua_auditoria_result c,
	qua_audit_result_resp d
where	a.nr_seq_tipo = b.nr_sequencia
and	a.nr_sequencia = c.nr_seq_auditoria
and	c.nr_sequencia = d.nr_seq_result_audit
and	d.nr_sequencia = nr_sequencia_p;

insert into qua_nao_conformidade(nr_sequencia,
	cd_estabelecimento,
	dt_atualizacao,
	nm_usuario,
	dt_abertura,
	cd_pf_abertura,
	cd_pf_resp_ocorrencia,
	ds_nao_conformidade,
	cd_setor_atendimento,
	ie_status,
	nr_seq_tipo,
	cd_setor_resp,
	cd_setor_eficacia,
	ds_disposicao_imediata,
	nr_seq_classificacao,
	cd_pf_resp_eficacia,
	qr_dia_analise_eficacia)
values (nr_sequencia_rnc_w,
	cd_estabelecimento_w,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	cd_usuario_w,
	cd_pessoa_fisica_w,
	ds_observacao_w,
	coalesce(cd_setor_tipo_audit_w,cd_setor_atendimento_w),
	'Aberta', --Valor de dominio (1397)
	nr_tipo_rnc_p,
	coalesce(cd_setor_resp_w,nr_seq_setor_resp_p),
	CASE WHEN ie_gerar_setor_eficacia_w='S' THEN  cd_setor_eficacia_w  ELSE null END ,
	substr(ds_acao_imediata_p,1,4000),
	nr_seq_classif_p,
	cd_pessoa_efic_p,
	nr_dias_efic_p);

update	qua_audit_result_resp
set	nr_seq_nao_conform	= nr_sequencia_rnc_w
where	nr_sequencia		= nr_sequencia_p;

commit;

CALL qua_gerar_envio_comunicacao(	nr_sequencia_rnc_w,
				'',
				nm_usuario_p,
				'17',
				cd_estabelecimento_w,
				null,
				null,
				'N');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qua_gerar_rnc_audit ( nr_sequencia_p bigint, nr_tipo_rnc_p bigint, nr_seq_classif_p bigint, ds_acao_imediata_p text, cd_pessoa_efic_p text, cd_setor_efic_p bigint, nr_dias_efic_p bigint, nr_seq_setor_resp_p bigint, nm_usuario_p text) FROM PUBLIC;

