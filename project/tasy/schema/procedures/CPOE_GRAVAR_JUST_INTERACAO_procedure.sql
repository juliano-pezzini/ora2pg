-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gravar_just_interacao ( nr_atendimento_p bigint, nr_seq_main_p bigint, cd_material_int_p bigint, cd_material_p bigint, ds_severidade_p text, ds_justificativa_p text, ds_retorno_p INOUT text, cd_pessoa_fisica_p text, ds_integracao_ativa_p text, cd_api_p text default null, nr_seq_alerta_p bigint default null, ds_resultado_curto_p text default null, nr_seq_cpoe_just_inter_p bigint default null, ie_tipo_item_p text default null, ds_lista_mat_assoc_p text default null) AS $body$
DECLARE


	nr_seq_cpoe_princ_w		cpoe_justif_interacao.nr_seq_cpoe_princ%type;
	nr_seq_proc_princ_w		cpoe_justif_interacao.nr_seq_proc_princ%type;
	nr_seq_mat_cpoe_w		cpoe_justif_interacao.nr_seq_mat_cpoe%type;
	nr_seq_proc_cpoe_w		cpoe_justif_interacao.nr_seq_proc_cpoe%type;
	ds_justificativa_w		cpoe_justif_interacao.ds_justificativa%type;
	ds_justificativa_out_w	cpoe_justif_interacao.ds_justificativa%type;
	cd_material_w			cpoe_justif_interacao.cd_material%type;
	cd_material_interacao_w	cpoe_justif_interacao.cd_material_interacao%type;
	ie_severidade_just_w	cpoe_justif_interacao.ie_severidade_just%type;
	nr_seq_controle_w		alerta_api.nr_seq_controle%type;
	nr_agrupamento_w		alerta_api.nr_agrupamento%type;
	nr_gravidade_w			alerta_api.nr_gravidade%type;
	ds_sub_tipo_api_w		alerta_api.ds_sub_tipo_api%type;
	ds_resultado_curto_w	alerta_api.ds_resultado_curto%type;
	nr_seq_alerta_w			alerta_api.nr_sequencia%type;
	ds_material_w			material.ds_material%type;
	ds_mat_int_w			material.ds_material%type;
	cd_mat_assoc_w			material.cd_material%type;
	ie_existe_w				varchar(1);
	ds_severidade_w			varchar(255);
	ds_descricao_api_w		varchar(255);
	ds_sigla_api_w			varchar(255);
	ds_lista_mat_assoc_w	varchar(255);
	ie_cpoe_param_7_w		varchar(2);
	qt_caracteres_lista_w	smallint;
	nr_posicao_separador_w	smallint;

	c01 CURSOR FOR
		SELECT 	nr_sequencia nr_seq_cpoe_princ,
				nr_seq_main_p nr_seq_mat_cpoe,
				cd_material_int_p cd_material_interacao,
				cd_material_p cd_material,
				'1' ie_union
		from   	cpoe_material a
		where	((a.nr_atendimento = nr_atendimento_p) or (coalesce(nr_atendimento_p::text, '') = '' and cd_pessoa_fisica = cd_pessoa_fisica_p))
		and    	a.nr_sequencia <> nr_seq_main_p
		and 	coalesce(a.dt_suspensao::text, '') = '' 
		and 	a.cd_material = cd_material_int_p
		and    	((clock_timestamp() between trunc(a.dt_inicio) and a.dt_fim) or coalesce(a.dt_fim::text, '') = '') 
		and    	(obter_material_conversao_ext(a.cd_material,'C') IS NOT NULL AND (obter_material_conversao_ext(a.cd_material,'C'))::text <> '')
		and 	(cd_material_int_p IS NOT NULL AND cd_material_int_p::text <> '')
		
union all

		SELECT	nr_seq_main_p nr_seq_cpoe_princ,
				nr_sequencia nr_seq_mat_cpoe,
				cd_material_p cd_material_interacao,
				cd_material_int_p cd_material,
				'2' ie_union
		from   	cpoe_material a 
		where	((a.nr_atendimento = nr_atendimento_p) or (coalesce(nr_atendimento_p::text, '') = '' and cd_pessoa_fisica = cd_pessoa_fisica_p))
		and    	a.nr_sequencia <> nr_seq_main_p
		and 	coalesce(a.dt_suspensao::text, '') = '' 
		and 	a.cd_material = cd_material_int_p
		and    	((clock_timestamp() between trunc(a.dt_inicio) and a.dt_fim) or coalesce(a.dt_fim::text, '') = '') 
		and    	(obter_material_conversao_ext(a.cd_material,'C') IS NOT NULL AND (obter_material_conversao_ext(a.cd_material,'C'))::text <> '')
		and 	(cd_material_p IS NOT NULL AND cd_material_p::text <> '')
		and 	(nr_seq_main_p IS NOT NULL AND nr_seq_main_p::text <> '')
		
union all

		select 	nr_sequencia nr_seq_cpoe_princ,
				nr_seq_main_p nr_seq_mat_cpoe,
				cd_material_int_p cd_material_interacao,
				cd_material_p cd_material,
				'3' ie_union
		from   	cpoe_procedimento a
		where	((a.nr_atendimento = nr_atendimento_p) or (coalesce(nr_atendimento_p::text, '') = '' and cd_pessoa_fisica = cd_pessoa_fisica_p))
		and    	a.nr_sequencia <> nr_seq_main_p
		and 	coalesce(a.dt_suspensao::text, '') = ''
		and 	cd_material_int_p in (a.cd_mat_proc1, a.cd_mat_proc2, a.cd_mat_proc3, a.cd_mat_proc4, a.cd_mat_proc5, a.cd_mat_proc6, a.cd_mat_proc7)
		and    	((clock_timestamp() between trunc(a.dt_inicio) and a.dt_fim) or coalesce(a.dt_fim::text, '') = '')
		and    	(obter_material_conversao_ext(cd_material_int_p,'C') IS NOT NULL AND (obter_material_conversao_ext(cd_material_int_p,'C'))::text <> '')
		and 	(cd_material_int_p IS NOT NULL AND cd_material_int_p::text <> '')
		
union all

		select	nr_seq_main_p nr_seq_cpoe_princ,
				nr_sequencia nr_seq_mat_cpoe,
				cd_material_p cd_material_interacao,
				cd_material_int_p cd_material,
				'4' ie_union
		from   	cpoe_procedimento a
		where	((a.nr_atendimento = nr_atendimento_p) or (coalesce(nr_atendimento_p::text, '') = '' and cd_pessoa_fisica = cd_pessoa_fisica_p))
		and    	a.nr_sequencia <> nr_seq_main_p
		and 	coalesce(a.dt_suspensao::text, '') = ''
		and 	cd_material_int_p in (a.cd_mat_proc1, a.cd_mat_proc2, a.cd_mat_proc3, a.cd_mat_proc4, a.cd_mat_proc5, a.cd_mat_proc6, a.cd_mat_proc7)
		and    	((clock_timestamp() between trunc(a.dt_inicio) and a.dt_fim) or coalesce(a.dt_fim::text, '') = '')
		and    	(obter_material_conversao_ext(cd_material_int_p,'C') IS NOT NULL AND (obter_material_conversao_ext(cd_material_int_p,'C'))::text <> '')
		and 	(cd_material_p IS NOT NULL AND cd_material_p::text <> '')
		and 	(nr_seq_main_p IS NOT NULL AND nr_seq_main_p::text <> '');
		
	cAlertas CURSOR FOR
		SELECT a.nr_gravidade,
			   a.ds_sub_tipo_api,
			   a.ds_resultado_curto,
			   a.cd_material,
			   a.nr_seq_cpoe
		  from alerta_api a
		 where a.nr_seq_controle = nr_seq_controle_w
		   and a.nr_agrupamento = nr_agrupamento_w
		   and a.cd_api = ds_sigla_api_w
		   and a.ds_resultado_curto = ds_resultado_curto_p;

procedure set_severity is;
BEGIN
	<<case_just>>
	CASE
		WHEN ds_severidade_p = 'CONTRAINDICATED' THEN
			nr_gravidade_w := 1;
			ie_severidade_just_w := 'I';
			ds_severidade_w	:= substr(obter_desc_expressao(756072),1,255);
		WHEN ds_severidade_p = 'MINOR' THEN
			nr_gravidade_w := 0;
			ie_severidade_just_w := 'L';
			ds_severidade_w	:= substr(obter_desc_expressao(331099),1,255);
		WHEN ds_severidade_p = 'MODERATE' THEN
			nr_gravidade_w := 3;
			ie_severidade_just_w := 'M';
			ds_severidade_w	:= substr(obter_desc_expressao(331188),1,255);
		WHEN ds_severidade_p = 'MAJOR' THEN
			nr_gravidade_w := 2;
			ie_severidade_just_w := 'S';
			ds_severidade_w	:= substr(obter_desc_expressao(331635),1,255);
		WHEN ds_severidade_p = 'INFO' THEN	
			nr_gravidade_w := 5;
			ie_severidade_just_w := '';
			ds_severidade_w	:= substr(obter_desc_expressao(756060),1,255);
		WHEN ds_severidade_p = 'INFORMATIVE' THEN
			nr_gravidade_w := 5;
			ie_severidade_just_w := '';
			ds_severidade_w	:= substr(obter_desc_expressao(756060),1,255);
		WHEN ds_severidade_p = 'SUBTHERAPEUTIC' THEN
			nr_gravidade_w := 3;
			ie_severidade_just_w := 'M';
			ds_severidade_w	:= substr(obter_desc_expressao(943388),1,255);
		WHEN ds_severidade_p = 'OVERDOSE' THEN
			nr_gravidade_w := 2;
			ie_severidade_just_w := 'S';
			ds_severidade_w	:= substr(obter_desc_expressao(943386),1,255);
		ELSE
			nr_gravidade_w := 99;
			ie_severidade_just_w := '';
			ds_severidade_w := substr(obter_desc_expressao(756058),1,255);
	END CASE case_just;
end;

procedure insert_data is

	nr_sequencia_w	cpoe_justif_interacao.nr_sequencia%type;

begin

  if ((nr_seq_cpoe_just_inter_p IS NOT NULL AND nr_seq_cpoe_just_inter_p::text <> '') and nr_seq_mat_cpoe_w = nr_seq_cpoe_princ_w) then
    nr_sequencia_w := nr_seq_cpoe_just_inter_p;
  else
    $if dbms_db_version.version >= 11 $then
      nr_sequencia_w := nextval('cpoe_justif_interacao_seq');
    $else
      select nextval('cpoe_justif_interacao_seq') into STRICT nr_sequencia_w;
    $end
  end if;	

	insert into cpoe_justif_interacao(nr_sequencia,
			 dt_atualizacao,
			 dt_atualizacao_nrec,
			 nm_usuario,
			 nm_usuario_nrec,
			 nr_seq_mat_cpoe,
			 nr_seq_proc_cpoe,
			 ie_severidade_just,
			 cd_material,
			 cd_material_interacao,
			 ds_justificativa,
			 nr_seq_cpoe_princ,
			 nr_seq_proc_princ,
			 nr_gravidade,
			 ds_sub_tipo_api,
			 ds_resultado_curto,
			 cd_api,
			 ie_integracao)
	 values (nr_sequencia_w,
			 clock_timestamp(),
			 clock_timestamp(),
			 wheb_usuario_pck.get_nm_usuario,
			 wheb_usuario_pck.get_nm_usuario,
			 nr_seq_mat_cpoe_w,
			 nr_seq_proc_cpoe_w,
			 ie_severidade_just_w,
			 cd_material_w,
			 cd_material_interacao_w,
			 ds_justificativa_w,
			 nr_seq_cpoe_princ_w,
			 nr_seq_proc_princ_w,
			 nr_gravidade_w,
			 ds_sub_tipo_api_w,
			 ds_resultado_curto_w,
			 ds_sigla_api_w,
			 ds_integracao_ativa_p);
end;

begin
	nr_seq_cpoe_princ_w := nr_seq_main_p;

	/* Lexicomp - todas APIs */

	ie_cpoe_param_7_w := obter_param_usuario(2314, 7, Obter_perfil_Ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_cpoe_param_7_w);
	
	if (ie_cpoe_param_7_w = 'B') then
		if ((nr_seq_main_p IS NOT NULL AND nr_seq_main_p::text <> '') and (cd_material_p IS NOT NULL AND cd_material_p::text <> '') and (cd_api_p IS NOT NULL AND cd_api_p::text <> '') ) then
			
			nr_seq_alerta_w := nr_seq_alerta_p;
			set_severity();

			
			if (coalesce(nr_seq_alerta_w::text, '') = '') then
				select	max(nr_sequencia),
						max(ds_resultado_curto)
				into STRICT 	nr_seq_alerta_w,
						ds_resultado_curto_w
				from 	alerta_api
				where 	nr_seq_cpoe = nr_seq_main_p
				and 	ie_retorno_ativo = 'S'
				and		cd_material = cd_material_p;
			end if;
			
			ds_material_w := obter_desc_material(cd_material_p);
			ds_descricao_api_w := obter_desc_api_tie(cd_api_p);
			
			if (ds_material_w IS NOT NULL AND ds_material_w::text <> '' AND ds_descricao_api_w IS NOT NULL AND ds_descricao_api_w::text <> '') then
				ds_justificativa_out_w := substr(wheb_mensagem_pck.get_texto(1128882,'API='||ds_descricao_api_w||';SEVERIDADE='||ds_severidade_w||';DS_MATERIAL_1='||ds_material_w||';DS_JUSTIFICATIVA='||ds_justificativa_p),1,2000);
				
				ds_justificativa_w := 	ds_justificativa_out_w;
				nr_seq_mat_cpoe_w :=	nr_seq_main_p;
				cd_material_interacao_w := cd_material_p;

				
				select	coalesce(max('S'),'N')
				into STRICT	ie_existe_w
				from 	cpoe_justif_interacao a
				where	a.nr_seq_mat_cpoe = nr_seq_mat_cpoe_w
				and		a.cd_material_interacao = cd_material_interacao_w
				and		a.nr_seq_cpoe_princ = nr_seq_main_p					
				and		a.cd_api = ds_sigla_api_w
				and 	a.nr_gravidade = nr_gravidade_w;

				if (ie_existe_w = 'N') then
					insert_data();
				end if;

				/* Mesmo sequencial porem material adicional */

				if (nr_seq_main_p = nr_seq_mat_cpoe_w AND cd_material_p <> cd_material_interacao_w) then
					ds_justificativa_out_w := ds_justificativa_w;
				end if;

        update  alerta_api
				set     ie_justificado = 'S'
				where   nr_seq_cpoe = nr_seq_main_p
				and     ie_retorno_ativo = 'S'
				and     cd_material = cd_material_int_p;

				ds_retorno_p := ds_justificativa_out_w;
				
			end if;	
		end if;
			
	elsif (ds_integracao_ativa_p = 'LXC') then

		if ((nr_seq_main_p IS NOT NULL AND nr_seq_main_p::text <> '') and (cd_material_p IS NOT NULL AND cd_material_p::text <> '') and (cd_api_p IS NOT NULL AND cd_api_p::text <> '') and (nr_seq_alerta_p IS NOT NULL AND nr_seq_alerta_p::text <> '')) then

			set_severity();

			ds_material_w := obter_desc_material(cd_material_p);
			ds_sigla_api_w := obter_sigla_api_lexicomp(cd_api_p);
			ds_descricao_api_w := obter_nome_api_lexicomp(ds_sigla_api_w);		
						
			if (ds_material_w IS NOT NULL AND ds_material_w::text <> '' AND ds_descricao_api_w IS NOT NULL AND ds_descricao_api_w::text <> '') then
				/* Retorna a justificativa do item que esta atualmente em tela */

				ds_justificativa_out_w := substr(wheb_mensagem_pck.get_texto(1128882,'API='||ds_descricao_api_w||';SEVERIDADE='||ds_severidade_w||';DS_MATERIAL_1='||ds_material_w||';DS_JUSTIFICATIVA='||ds_justificativa_p),1,2000);
				
				select max(a.nr_seq_controle),
					   max(a.nr_agrupamento)
				  into STRICT nr_seq_controle_w,
					   nr_agrupamento_w
				  from alerta_api a
				 where a.nr_sequencia = nr_seq_alerta_p;
				

				for cAlertas_w in cAlertas
				loop
					nr_seq_mat_cpoe_w := cAlertas_w.nr_seq_cpoe;
					cd_material_interacao_w := cAlertas_w.cd_material;
					ds_resultado_curto_w := cAlertas_w.ds_resultado_curto;
					nr_gravidade_w := cAlertas_w.nr_gravidade;
					ds_sub_tipo_api_w := cAlertas_w.ds_sub_tipo_api;					
					ds_material_w := obter_desc_material(cAlertas_w.cd_material);
					/* Justificativa dos demais itens interagentes, incluindo o que esta em tela */

					ds_justificativa_w := substr(wheb_mensagem_pck.get_texto(1128882,'API='||ds_descricao_api_w||';SEVERIDADE='||ds_severidade_w||';DS_MATERIAL_1='||ds_material_w||';DS_JUSTIFICATIVA='||ds_justificativa_p),1,2000);

					select	coalesce(max('S'),'N')
					  into STRICT	ie_existe_w
					  from 	cpoe_justif_interacao a
					 where	a.nr_seq_mat_cpoe = nr_seq_mat_cpoe_w
					   and	a.cd_material_interacao = cd_material_interacao_w
					   and	a.nr_seq_cpoe_princ = nr_seq_main_p					
					   and	a.cd_api = ds_sigla_api_w
					   and	a.ds_sub_tipo_api = ds_sub_tipo_api
					   and 	a.nr_gravidade = nr_gravidade_w
					   and	a.ds_resultado_curto = ds_resultado_curto_w;

					if (ie_existe_w = 'N') then
						insert_data();
					end if;

					/* Mesmo sequencial porem material adicional */

					if (nr_seq_main_p = nr_seq_mat_cpoe_w AND cd_material_p <> cd_material_interacao_w) then
						ds_justificativa_out_w := ds_justificativa_w;
					end if;

					ds_retorno_p := ds_justificativa_out_w;
				end loop;
			end if;
		end if;
	
	/* Micromedex - API de dose */

	elsif (ds_integracao_ativa_p = 'MDX' AND cd_api_p <> 'DRUG') then

		if (nr_seq_main_p IS NOT NULL AND nr_seq_main_p::text <> '' AND cd_material_p IS NOT NULL AND cd_material_p::text <> '') then
		
			set_severity();
			
			ds_material_w := obter_desc_material(cd_material_p);
			ds_descricao_api_w := obter_desc_api_micromedex(cd_api_p);
			nr_gravidade_w := obter_cod_severidade_by_desc(ds_severidade_p);
			ds_sigla_api_w := cd_api_p;
			ds_resultado_curto_w := ds_resultado_curto_p;

			if (ds_material_w IS NOT NULL AND ds_material_w::text <> '' AND ds_descricao_api_w IS NOT NULL AND ds_descricao_api_w::text <> '') then

				ds_justificativa_w := substr(wheb_mensagem_pck.get_texto(1128882,'API='||ds_descricao_api_w||';SEVERIDADE='||ds_severidade_w||';DS_MATERIAL_1='||ds_material_w||';DS_JUSTIFICATIVA='||ds_justificativa_p),1,2000);
				cd_material_w := cd_material_p;
				cd_material_interacao_w := cd_material_p;

				if (coalesce(ie_tipo_item_p, 'M') = 'P') then

					nr_seq_mat_cpoe_w := null;
					nr_seq_proc_cpoe_w := nr_seq_main_p;
					nr_seq_cpoe_princ_w := null;
					nr_seq_proc_princ_w := nr_seq_main_p;

					select coalesce(max('S'),'N')
					  into STRICT ie_existe_w
					  from cpoe_justif_interacao a
					 where a.nr_seq_proc_cpoe = nr_seq_proc_cpoe_w
					   and a.nr_seq_proc_princ = nr_seq_proc_princ_w
					   and a.cd_api = cd_api_p
					   and a.nr_gravidade = nr_gravidade_w
					   and a.ds_resultado_curto = ds_resultado_curto_w;

				elsif (coalesce(ie_tipo_item_p, 'M') = 'M') then

					nr_seq_mat_cpoe_w := nr_seq_main_p;
					nr_seq_proc_cpoe_w := null;
					nr_seq_cpoe_princ_w := nr_seq_main_p;
					nr_seq_proc_princ_w := null;

					select coalesce(max('S'),'N')
					  into STRICT ie_existe_w
					  from cpoe_justif_interacao a
					 where a.nr_seq_mat_cpoe = nr_seq_mat_cpoe_w
					   and a.nr_seq_cpoe_princ = nr_seq_cpoe_princ_w
					   and a.cd_api = cd_api_p
					   and a.nr_gravidade = nr_gravidade_w
					   and a.ds_resultado_curto = ds_resultado_curto_w;
				end if;
				
				if (ie_existe_w = 'N') then
					insert_data();
				end if;
				
				ds_retorno_p := ds_justificativa_w;
			else
			  ds_retorno_p := 'ds_material_w: ' || ds_material_w || ' - ds_descricao_api_w: ' || ds_descricao_api_w;
			end if;
		end if;

	/* Micromedex - Interacao medicamentosa e tambem outras Integracoes */

	else

		if (nr_seq_main_p IS NOT NULL AND nr_seq_main_p::text <> '') and (cd_material_int_p IS NOT NULL AND cd_material_int_p::text <> '') and (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then

			set_severity();		

			ds_material_w := obter_desc_material(cd_material_p);
			ds_mat_int_w := obter_desc_material(cd_material_int_p);
			nr_gravidade_w := obter_cod_severidade_by_desc(ds_severidade_p);
			ds_sigla_api_w := cd_api_p;
			ds_resultado_curto_w := ds_resultado_curto_p;

			if (ds_material_w IS NOT NULL AND ds_material_w::text <> '' AND ds_mat_int_w IS NOT NULL AND ds_mat_int_w::text <> '') then
				
				ds_justificativa_w := substr(wheb_mensagem_pck.get_texto(1078462,'SEVERIDADE='||ds_severidade_w||';DS_MATERIAL_1='||ds_material_w||';DS_MATERIAL_2='||ds_mat_int_w||';DS_JUSTIFICATIVA='||ds_justificativa_p),1,2000);
				
				ds_lista_mat_assoc_w := ds_lista_mat_assoc_p;
				
				for c01_w in C01
				loop
					cd_material_w := c01_w.cd_material;
					cd_material_interacao_w := c01_w.cd_material_interacao;
					nr_seq_mat_cpoe_w := null;
					nr_seq_proc_cpoe_w := null;
					nr_seq_cpoe_princ_w := null;
					nr_seq_proc_princ_w := null;
					-- Limpar lista de materiais associados ao procedimento
					ds_lista_mat_assoc_w := null;

					if (coalesce(ie_tipo_item_p, 'M') = 'M') then

						if (c01_w.ie_union in ('1', '2')) then

							nr_seq_mat_cpoe_w := c01_w.nr_seq_mat_cpoe;
							nr_seq_cpoe_princ_w := c01_w.nr_seq_cpoe_princ;

							select	coalesce(max('S'),'N')
							into STRICT	ie_existe_w
							from 	cpoe_justif_interacao
							where	nr_seq_mat_cpoe = nr_seq_mat_cpoe_w
							and 	nr_seq_cpoe_princ = nr_seq_cpoe_princ_w
							and 	cd_api = cd_api_p
							and 	nr_gravidade = nr_gravidade_w
							and 	ds_resultado_curto = ds_resultado_curto_w;

						elsif (c01_w.ie_union = '3') then

							nr_seq_mat_cpoe_w := c01_w.nr_seq_mat_cpoe;
							nr_seq_proc_princ_w := c01_w.nr_seq_cpoe_princ;

							select	coalesce(max('S'),'N')
							into STRICT	ie_existe_w
							from 	cpoe_justif_interacao
							where	nr_seq_mat_cpoe = nr_seq_mat_cpoe_w
							and 	nr_seq_proc_princ = nr_seq_proc_princ_w
							and 	cd_api = cd_api_p
							and 	nr_gravidade = nr_gravidade_w
							and 	ds_resultado_curto = ds_resultado_curto_w;

						elsif (c01_w.ie_union = '4') then

							nr_seq_proc_cpoe_w := c01_w.nr_seq_mat_cpoe;
							nr_seq_cpoe_princ_w := c01_w.nr_seq_cpoe_princ;

							select	coalesce(max('S'),'N')
							into STRICT	ie_existe_w
							from 	cpoe_justif_interacao
							where	nr_seq_proc_cpoe = nr_seq_proc_cpoe_w
							and 	nr_seq_cpoe_princ = nr_seq_cpoe_princ_w
							and 	cd_api = cd_api_p
							and 	nr_gravidade = nr_gravidade_w
							and 	ds_resultado_curto = ds_resultado_curto_w;
						end if;

					elsif (coalesce(ie_tipo_item_p, 'M') = 'P') then

						if (c01_w.ie_union = '1') then

							nr_seq_proc_cpoe_w := c01_w.nr_seq_mat_cpoe;
							nr_seq_cpoe_princ_w := c01_w.nr_seq_cpoe_princ;

							select	coalesce(max('S'),'N')
							into STRICT	ie_existe_w
							from 	cpoe_justif_interacao
							where	nr_seq_proc_cpoe = nr_seq_proc_cpoe_w
							and 	nr_seq_cpoe_princ = nr_seq_cpoe_princ_w
							and 	cd_api = cd_api_p
							and 	nr_gravidade = nr_gravidade_w
							and 	ds_resultado_curto = ds_resultado_curto_w;

						elsif (c01_w.ie_union = '2') then

							nr_seq_mat_cpoe_w := c01_w.nr_seq_mat_cpoe;
							nr_seq_proc_princ_w := c01_w.nr_seq_cpoe_princ;

							select	coalesce(max('S'),'N')
							into STRICT	ie_existe_w
							from 	cpoe_justif_interacao
							where	nr_seq_mat_cpoe = nr_seq_mat_cpoe_w
							and 	nr_seq_proc_princ = nr_seq_proc_princ_w
							and 	cd_api = cd_api_p
							and 	nr_gravidade = nr_gravidade_w
							and 	ds_resultado_curto = ds_resultado_curto_w;

						elsif (c01_w.ie_union in ('3', '4')) then

							nr_seq_proc_cpoe_w := c01_w.nr_seq_mat_cpoe;
							nr_seq_proc_princ_w := c01_w.nr_seq_cpoe_princ;

							select	coalesce(max('S'),'N')
							into STRICT	ie_existe_w
							from 	cpoe_justif_interacao
							where	nr_seq_proc_cpoe = nr_seq_proc_cpoe_w
							and 	nr_seq_proc_princ = nr_seq_proc_princ_w
							and 	cd_api = cd_api_p
							and 	nr_gravidade = nr_gravidade_w
							and 	ds_resultado_curto = ds_resultado_curto_w;
						end if;
					end if;

					if (ie_existe_w = 'N') then
						insert_data();
					end if;

					ds_retorno_p := ds_justificativa_w;
				end loop;
				
				if (coalesce(ie_tipo_item_p, 'M') = 'P' and (ds_lista_mat_assoc_w IS NOT NULL AND ds_lista_mat_assoc_w::text <> '')) then
					while(ds_lista_mat_assoc_w IS NOT NULL AND ds_lista_mat_assoc_w::text <> '') loop
						qt_caracteres_lista_w := length(ds_lista_mat_assoc_w);
						nr_posicao_separador_w := position(';' in ds_lista_mat_assoc_w);

						if (nr_posicao_separador_w > 0) then
							cd_mat_assoc_w := (substr(ds_lista_mat_assoc_w, 1, nr_posicao_separador_w - 1))::numeric;
							ds_lista_mat_assoc_w := substr(ds_lista_mat_assoc_w, nr_posicao_separador_w + 1, qt_caracteres_lista_w);
						else
							cd_mat_assoc_w := (ds_lista_mat_assoc_w)::numeric;
							ds_lista_mat_assoc_w := null;
						end if;

						nr_seq_mat_cpoe_w := null;
						nr_seq_cpoe_princ_w := null;
						cd_material_w := cd_material_p;
						cd_material_interacao_w := cd_material_int_p;
						nr_seq_proc_cpoe_w := nr_seq_main_p;
						nr_seq_proc_princ_w := nr_seq_main_p;

						if (cd_mat_assoc_w = cd_material_int_p) then
							select	coalesce(max('S'),'N')
							into STRICT	ie_existe_w
							from 	cpoe_justif_interacao
							where	nr_seq_proc_cpoe = nr_seq_proc_cpoe_w
							and 	nr_seq_proc_princ = nr_seq_proc_princ_w
							and 	cd_api = cd_api_p
							and 	nr_gravidade = nr_gravidade_w
							and 	ds_resultado_curto = ds_resultado_curto_w;
						end if;

						if (ie_existe_w = 'N') then
							insert_data();
						end if;

						ds_retorno_p := ds_justificativa_w;
					end loop;
				end if;
				
			end if;
		end if;
	end if;

	commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gravar_just_interacao ( nr_atendimento_p bigint, nr_seq_main_p bigint, cd_material_int_p bigint, cd_material_p bigint, ds_severidade_p text, ds_justificativa_p text, ds_retorno_p INOUT text, cd_pessoa_fisica_p text, ds_integracao_ativa_p text, cd_api_p text default null, nr_seq_alerta_p bigint default null, ds_resultado_curto_p text default null, nr_seq_cpoe_just_inter_p bigint default null, ie_tipo_item_p text default null, ds_lista_mat_assoc_p text default null) FROM PUBLIC;

