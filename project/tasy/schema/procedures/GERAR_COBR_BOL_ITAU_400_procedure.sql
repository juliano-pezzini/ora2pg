-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cobr_bol_itau_400 ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
/* o arquivo é gravado em \\192.168.0.230\UTLFILE\ */
 
					 
ds_conteudo_w			varchar(400);
nr_remessa_w			varchar(8);
nr_seq_registro_w		varchar(255) := 1;
nm_empresa_w			varchar(30);
cd_cgc_w			varchar(15);
nm_banco_w			varchar(30);
dt_geracao_w			varchar(8);
nr_lote_w_w			varchar(4) := 0;
nr_lote_w			varchar(4);

/* Segmentos */
 
nr_nosso_numero_w		varchar(13);
--ie_documento_w			varchar2(1); 
dt_vencimento_w			varchar(8);
vl_titulo_w			varchar(15);
--ie_titulo_w			varchar2(2); 
dt_emissao_w			varchar(8);
--cd_juros_mora_w			varchar2(1); 
--dt_juros_mora_w			varchar2(8); 
--vl_juros_diario_w		varchar2(15); 
--cd_desconto_w			varchar2(1); 
--dt_desconto_w			varchar2(8); 
--vl_desconto_dia_w		varchar2(15); 
--vl_iof_w			varchar2(15); 
--vl_abatimento_w			varchar2(15); 
--ds_ident_titulo_emp_w		varchar2(25); 
--cd_protesto_w			varchar2(1); 
--qt_dias_protestos_w		varchar2(2); 
--cd_moeda_w			varchar2(2); 
--cd_agencia_w			varchar2(4); 
--ie_digito_agencia_w		varchar2(1); 
--nr_conta_w			varchar2(9); 
--ie_digito_conta_w		varchar2(1); 
--cd_conta_cobr_w			varchar2(9); 
--ie_conta_cobr_w			varchar2(1); 
--ie_tipo_cobranca_w		varchar2(1); 
--ie_forma_cad_w			varchar2(1); 
--nr_seu_numero_w			varchar2(15); 
--cd_agencia_cobr_w		varchar2(4); 
--ie_agencia_cobr_w		varchar2(1); 
--ie_ident_titulo_w		varchar2(1); 
--cd_baixa_w			varchar2(1); 
--nr_dias_baixa_w			varchar2(2); 
ie_tipo_inscricao_w		varchar(2);
nr_inscricao_w			varchar(15);
nm_sacado_w			varchar(40);
ds_endereco_sacado_w		varchar(40);
ds_bairro_sacado_w		varchar(15);
cd_cep_sacado_w			varchar(8);
ds_municipio_sacado_w		varchar(15);
ds_estado_sacado_w		varchar(2);
--ds_avalista_w			varchar2(40); 
--nr_avalista_w			varchar2(16); 
cd_mov_remessa_w		varchar(2);
--ie_carne_w			varchar2(3); 
--nr_parcela_w			varchar2(3); 
--qt_total_parcela_w		varchar2(3); 
--nr_plano_w			varchar2(3); 
cd_transmissao_w		varchar(15);
nm_cedente_w			varchar(30);

/* ds_brancos */
 
ds_brancos_8_w			varchar(8);
ds_brancos_25_w			varchar(25);
ds_brancos_10_w			varchar(10);
ds_brancos_6_w			varchar(6);
ds_brancos_74_w			varchar(74);
ds_brancos_2_w			varchar(2);
ds_brancos_1_w			varchar(1);
ds_brancos_3_w			varchar(3);
ds_brancos_20_w			varchar(20);
ds_brancos_5_w			varchar(5);
ds_brancos_41_w			varchar(41);
ds_brancos_9_w			varchar(9);
ds_brancos_217_w		varchar(217);
ds_brancos_211_w		varchar(211);
ds_brancos_19_w			varchar(19);
ds_brancos_11_w			varchar(11);
ds_brancos_15_w			varchar(15);
ds_brancos_119_w		varchar(119);
ds_brancos_16_w			varchar(30);
ds_brancos_27_w			varchar(30);
ds_brancos_30_w			varchar(30);
ds_brancos_42_w			varchar(42);
ds_brancos_43_w			varchar(43);
ds_brancos_44_w			varchar(44);
ds_brancos_62_w			varchar(62);
ds_brancos_63_w			varchar(63);
ds_brancos_94_w			varchar(94);
ds_brancos_374_w		varchar(374);

/* Mensagens */
 
ie_mensagem_w			varchar(1)	:= 'N';
ie_itens_adicionados_w		varchar(1)	:= 'N';
ds_mensagem_w			varchar(69);
ds_mensagem_1_w			varchar(69);
ds_mensagem_2_w			varchar(69);
ds_mensagem_3_w			varchar(69);
ds_mensagem_4_w			varchar(69);
ds_mensagem_5_w			varchar(69);
pr_juros_w			varchar(255);
pr_multa_w			varchar(255);
dt_mensalidade_w		varchar(255);
nr_contrato_w			varchar(255);
ds_plano_w			varchar(255);
nr_protocolo_ans_w		varchar(255);
dt_proximo_reajuste_w		varchar(255);
cd_usuario_plano_w		varchar(255);
dt_contratacao_w		varchar(255);
vl_mensalidade_w		varchar(255);
vl_coparticipacao_w		varchar(255);
--cd_pessoa_fisica_w		varchar2(255); 
--dt_solicitacao_w		varchar2(255); 
--dt_resposta_w			varchar2(255); 
vl_outros_n_w			double precision;
vl_outros_w			varchar(255)	:= null;
vl_total_w			varchar(255)	:= null;
nr_seq_plano_w			bigint;
nr_seq_segurado_w		bigint;
nr_seq_segurado_mens_w		bigint;
qt_itens_w			bigint	:= 0;
nr_seq_pagador_w		bigint;
qt_coparticipacao_w		bigint;
nr_seq_mensalidade_w		bigint;
nr_seq_contrato_w		bigint;
nr_linha_w			bigint	:= 0;
qt_msg_linha_w			smallint	:= 0;

/* UTL_FILE */
 
nm_arquivo_w			varchar(255);
arq_texto_w			utl_file.file_type;
arq_texto_log_w			utl_file.file_type;
ds_erro_w			varchar(255);
ds_local_w			varchar(255);
nr_seq_mensalidade_seg_w	bigint;
vl_item_w			double precision;
dt_reajuste_prox_w		timestamp;
dt_ref_mensalidade_w		timestamp;

dt_reajuste_w			timestamp;
dt_remessa_retorno_w		timestamp;
cd_cgc_estip_w			varchar(14);

nr_dia_w				varchar(2);
nr_mes_atual_w			varchar(2);
dt_ref_w				timestamp;

C01 CURSOR FOR 
	SELECT	lpad(coalesce(trim(both substr(obter_nosso_numero_interf(x.cd_banco,b.nr_titulo),1,12)),'0') || calcula_digito('Modulo11',(lpad(b.nr_titulo,8,'0'))),13,'0') nr_nosso_numero, 
		to_char(coalesce(b.dt_vencimento,clock_timestamp()),'ddmmyy') dt_vencimento, --to_char(nvl(b.dt_pagamento_previsto, b.dt_vencimento),'ddmmyy') 
		lpad(replace(to_char(coalesce(b.vl_titulo,0), 'fm00000000000.00'),'.',''),13,'0') vl_titulo, 
		to_char(w.dt_geracao_titulos,'ddmmyy') dt_emissao, --to_char(nvl(b.dt_emissao,sysdate),'ddmmyy') 
		CASE WHEN coalesce(b.cd_cgc::text, '') = '' THEN '01'  ELSE '02' END  ie_tipo_inscricao, 
		lpad(coalesce(b.cd_cgc_cpf,'0'),14, '0') nr_inscricao, 
		rpad(coalesce(upper(elimina_acentuacao(substr(b.nm_pessoa,1,40))),' '),40,' ') nm_sacado, 
		rpad(coalesce(upper(elimina_acentuacao(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'E')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'EN') END ,1,40))),' '),40,' ') ds_endereco_sacado, 
		rpad(coalesce(upper(elimina_acentuacao(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'B')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'B') END ,1,12))),' '),12,' ') ds_bairro_sacado, 
		lpad(coalesce(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CEP')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'CEP') END ,1,8),'0'),8,'0') cd_cep_sacado, 
		rpad(coalesce(upper(elimina_acentuacao(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CI')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'CI') END ,1,15))),' '),15,' ') ds_municipio_sacado, 
		rpad(coalesce(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'UF')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'UF') END ,1,2),' '),2,' ') ds_estado_sacado, 
		lpad(coalesce(substr(c.cd_ocorrencia,1,2),'01'),2,'0') cd_mov_remessa, 
		campo_mascara_virgula_casas(obter_dados_titulo_receber(b.nr_titulo,'PDJ'),3) pr_juros_diario, 
		campo_mascara_virgula(obter_dados_titulo_receber(b.nr_titulo,'TXM')) pr_multa_diario, 
		d.nr_sequencia, 
		f.nr_seq_contrato, 
		pls_obter_segurado_pagador(d.nr_seq_pagador) nr_seq_segurado, 
		d.nr_seq_pagador 
	FROM banco_estabelecimento x, titulo_receber_cobr c, cobranca_escritural a, titulo_receber_v b
LEFT OUTER JOIN pls_mensalidade d ON (b.nr_seq_mensalidade = d.nr_sequencia)
LEFT OUTER JOIN pls_contrato_pagador f ON (d.nr_seq_pagador = f.nr_sequencia)
LEFT OUTER JOIN pls_lote_mensalidade w ON (d.nr_seq_lote = w.nr_sequencia)
WHERE a.nr_sequencia		= c.nr_seq_cobranca and c.nr_titulo		= b.nr_titulo and a.nr_seq_conta_banco	= x.nr_sequencia --and	z.cd_agencia_bancaria	= x.cd_agencia_bancaria 
	--and	z.cd_banco		= x.cd_banco 
  --and	b.nr_seq_carteira_cobr	= e.nr_sequencia(+) 
   and a.nr_sequencia		= nr_seq_cobr_escrit_p;

C02 CURSOR FOR 
	SELECT	campo_mascara_virgula(coalesce(a.vl_mensalidade - a.vl_coparticipacao - a.vl_outros,0)) vl_mensalidade, 
		campo_mascara_virgula(coalesce(a.vl_coparticipacao,0)) vl_coparticipacao, 
		a.nr_seq_segurado 
	from	pls_mensalidade_segurado 	a 
	where	a.nr_seq_mensalidade 	= nr_seq_mensalidade_w  
	order by a.nr_sequencia LIMIT 9;
	

BEGIN 
nm_arquivo_w	:= to_char(clock_timestamp(),'ddmmyyyy') || to_char(clock_timestamp(),'hh24') || to_char(clock_timestamp(),'mi') || to_char(clock_timestamp(),'ss') || nm_usuario_p || '.rem';
SELECT * FROM obter_evento_utl_file(1, null, ds_local_w, ds_erro_w) INTO STRICT ds_local_w, ds_erro_w;
begin 
arq_texto_w := utl_file.fopen(ds_local_w,nm_arquivo_w,'W');
exception 
when others then 
	if (SQLSTATE = -29289) then 
		ds_erro_w := 'O acesso ao arquivo foi negado pelo sistema operacional (access_denied).';
	elsif (SQLSTATE = -29298) then 
		ds_erro_w := 'O arquivo foi aberto usando FOPEN_NCHAR, mas efetuaram-se operações de I/O usando funções nonchar comos PUTF ou GET_LINE (charsetmismatch).';
	elsif (SQLSTATE = -29291) then 
		ds_erro_w := 'Não foi possível apagar o arquivo (delete_failed).';
	elsif (SQLSTATE = -29286) then 
		ds_erro_w := 'Erro interno desconhecido no package UTL_FILE (internal_error).';
	elsif (SQLSTATE = -29282) then 
		ds_erro_w := 'O handle do arquivo não existe (invalid_filehandle).';
	elsif (SQLSTATE = -29288) then 
		ds_erro_w := 'O arquivo com o nome especificado não foi encontrado neste local (invalid_filename).';
	elsif (SQLSTATE = -29287) then 
		ds_erro_w := 'O valor de MAX_LINESIZE para FOPEN() é inválido; deveria estar na faixa de 1 a 32767 (invalid_maxlinesize).';
	elsif (SQLSTATE = -29281) then 
		ds_erro_w := 'O parâmetro open_mode na chamda FOPEN é inválido (invalid_mode).';
	elsif (SQLSTATE = -29290) then 
		ds_erro_w := 'O parâmetro ABSOLUTE_OFFSET para a chamada FSEEK() é inválido; deveria ser maior do que 0 e menor do que o número total de bytes do arquivo (invalid_offset).';
	elsif (SQLSTATE = -29283) then 
		ds_erro_w := 'O arquivo não pôde ser aberto ou operado da forma desejada - ou o caminho não foi encontrado (invalid_operation).';
	elsif (SQLSTATE = -29280) then 
		ds_erro_w := 'O caminho especificado não existe ou não está visível ao Oracle (invalid_path).';
	elsif (SQLSTATE = -29284) then 
		ds_erro_w := 'Não é possível efetuar a leitura do arquivo (read_error).';
	elsif (SQLSTATE = -29292) then 
		ds_erro_w := 'Não é possível renomear o arquivo.';
	elsif (SQLSTATE = -29285) then 
		ds_erro_w := 'Não foi possível gravar no arquivo (write_error).';
	else 
		ds_erro_w := 'Erro desconhecido no package UTL_FILE.';
	end if;
	 
end;
 
update	cobranca_escritural 
set	ds_arquivo	= ds_local_w || nm_arquivo_w 
where	nr_sequencia	= nr_seq_cobr_escrit_p;
 
select	rpad(' ',1,' '), 
	rpad(' ',3,' '), 
	rpad(' ',6,' '), 
	rpad(' ',8,' '), 
	rpad(' ',10,' '), 
	rpad(' ',15,' '), 
	rpad(' ',16,' '), 
	rpad(' ',27,' '), 
	rpad(' ',30,' '), 
	rpad(' ',42,' '), 
	rpad(' ',43,' '), 
	rpad(' ',44,' '), 
	rpad(' ',62,' '), 
	rpad(' ',63,' '), 
	rpad(' ',94,' '), 
	rpad(' ',374,' ') 
into STRICT	ds_brancos_1_w, 
	ds_brancos_3_w, 
	ds_brancos_6_w, 
	ds_brancos_8_w, 
	ds_brancos_10_w, 
	ds_brancos_15_w, 
	ds_brancos_16_w, 
	ds_brancos_27_w, 
	ds_brancos_30_w, 
	ds_brancos_42_w, 
	ds_brancos_43_w, 
	ds_brancos_44_w, 
	ds_brancos_62_w, 
	ds_brancos_63_w, 
	ds_brancos_94_w, 
	ds_brancos_374_w
;
 
ds_conteudo_w	:=	'0' || '1' || 'REMESSA' || '01' || 'COBRANCA    ' || lpad('0',10,'0') || ds_brancos_10_w || ds_brancos_30_w || '341' || 
			ds_brancos_15_w || lpad('0',8,'0') || lpad('0',5,'0') || lpad('0',3,'0') || lpad('0',6,'0') || lpad('0',4,'0') || '0' || 
			ds_brancos_1_w || '00' || '0' || '0' || '0' || ds_brancos_94_w || ds_brancos_42_w || ds_brancos_42_w || ds_brancos_42_w || 
			ds_brancos_3_w || ds_brancos_44_w || lpad(nr_seq_registro_w,6,'0');
			 
utl_file.put_line(arq_texto_w,ds_conteudo_w|| chr(13));
utl_file.fflush(arq_texto_w);
/* Fim Header Arquivo */
 
 
/* Inicio Detalhe */
 
open C01;
loop 
fetch C01 into	 
	/* Detalhe */
 
	nr_nosso_numero_w, 
	dt_vencimento_w, 
	vl_titulo_w, 
	dt_emissao_w, 
	ie_tipo_inscricao_w, 
	nr_inscricao_w, 
	nm_sacado_w, 
	ds_endereco_sacado_w, 
	ds_bairro_sacado_w, 
	cd_cep_sacado_w, 
	ds_municipio_sacado_w, 
	ds_estado_sacado_w, 
	/* Mensagem */
 
	cd_mov_remessa_w, 
	--cd_agencia_w, 
	--ie_digito_agencia_w, 
	--nr_conta_w, 
	--ie_digito_conta_w, 
	--cd_conta_cobr_w, 
	--ie_conta_cobr_w, 
	--ie_tipo_cobranca_w, 
	--ie_forma_cad_w, 
	--ie_documento_w, 
	--nr_seu_numero_w, 
	--cd_agencia_cobr_w, 
	--ie_agencia_cobr_w, 
	--ie_titulo_w, 
	--ie_ident_titulo_w, 
	--cd_juros_mora_w, 
	--dt_juros_mora_w, 
	--vl_juros_diario_w, 
	pr_juros_w, 
	pr_multa_w, 
	--cd_desconto_w, 
	--dt_desconto_w, 
	--vl_desconto_dia_w, 
	--vl_iof_w, 
	--vl_abatimento_w, 
	--ds_ident_titulo_emp_w, 
	--cd_protesto_w, 
	--qt_dias_protestos_w, 
	--cd_baixa_w, 
	--nr_dias_baixa_w, 
	--cd_moeda_w, 
	--ie_tipo_inscricao_w, 
	--nr_avalista_w, 
	--ds_avalista_w, 
	--ie_carne_w, 
	--nr_parcela_w, 
	--qt_total_parcela_w, 
	--nr_plano_w, 
	nr_seq_mensalidade_w, 
	nr_seq_contrato_w, 
	nr_seq_segurado_w, 
	nr_seq_pagador_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin	 
	nr_seq_registro_w:= nr_seq_registro_w + 1;
	 
	ds_conteudo_w	:=	'1' || ds_brancos_63_w || nr_nosso_numero_w || ds_brancos_43_w || dt_vencimento_w || vl_titulo_w || 
				'341' || ds_brancos_8_w || dt_emissao_w || ds_brancos_62_w || ie_tipo_inscricao_w || nr_inscricao_w || 
				nm_sacado_w || ds_endereco_sacado_w || ds_bairro_sacado_w || cd_cep_sacado_w || 
				ds_municipio_sacado_w || ds_estado_sacado_w || ds_brancos_43_w || lpad(nr_seq_registro_w,6,'0');
	 
	utl_file.put_line(arq_texto_w,ds_conteudo_w|| chr(13));
	utl_file.fflush(arq_texto_w);
	 
	/*Mensagem*/
 
	nr_contrato_w		:= null;
	ds_plano_w		:= null;
	nr_protocolo_ans_w	:= null;
	dt_mensalidade_w	:= null;
	dt_proximo_reajuste_w	:= null;
	qt_itens_w		:= 0;
	nr_linha_w		:= 1;
	 
	if (nr_seq_mensalidade_w IS NOT NULL AND nr_seq_mensalidade_w::text <> '') then 
		select	substr(trim(both to_char(dt_referencia,'MONTH')),1,3)||'/'||to_char(dt_referencia,'yyyy'), 
			dt_referencia 
		into STRICT	dt_mensalidade_w, 
			dt_ref_mensalidade_w 
		from	pls_mensalidade 
		where	nr_sequencia = nr_seq_mensalidade_w;
	end if;
	 
	if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then 
	 
		select 	to_char(coalesce(dt_reajuste,dt_contrato),'dd'), 
				'01/' || to_char(coalesce(dt_reajuste,dt_contrato),'mm') || '/' || pkg_date_utils.extract_field('YEAR', dt_ref_mensalidade_w, 0) 
		into STRICT 	nr_dia_w, 
				dt_ref_w 
		from	pls_contrato 
		where	nr_sequencia	= nr_seq_contrato_w;
 
		if (nr_dia_w > 28) then 
			 
			nr_mes_atual_w := to_char(dt_ref_w, 'mm');
		 
			if (nr_mes_atual_w in ('04','06','09','11')) and (nr_dia_w > 30) then 
				 
				nr_dia_w := 30;
		 
			elsif (nr_mes_atual_w = '02') and (nr_dia_w > 28) then 
			 
				if (obter_se_ano_bisexto(dt_ref_w) = 'S') then 
					nr_dia_w := 29;
				else 
					nr_dia_w := 28;
					 
				end if;
				 
			end if;
			 
		begin	 
		dt_reajuste_w := to_date(nr_dia_w || '/' || to_char(dt_ref_w, 'mm/yyyy'));
		exception when others then 
		nr_dia_w := 28; /*Se der qq excessão, pega 28, pois esse dia tem em todos os meses.*/
		dt_reajuste_w := to_date(nr_dia_w || '/' || to_char(dt_ref_w, 'mm/yyyy'));
		end;
		 
		end if;	
	 
		select	nr_contrato, 
				trim(both to_char(coalesce(dt_reajuste,dt_contrato),'MONTH'))||'/'|| 
				to_char(pls_obter_proximo_reajuste(nr_sequencia),'yyyy'), 
				pls_obter_proximo_reajuste(nr_sequencia), 
				/*to_date(to_char(nvl(dt_reajuste,dt_contrato),'dd/mm') || '/' || to_char(dt_ref_mensalidade_w, 'yyyy')),*/
 
				cd_cgc_estipulante 
		into STRICT	nr_contrato_w, 
				dt_proximo_reajuste_w, 
				dt_reajuste_prox_w, 
				/*dt_reajuste_w,*/
 
				cd_cgc_estip_w 
		from	pls_contrato 
		where	nr_sequencia	= nr_seq_contrato_w;
		 
		 
		if (to_char(dt_reajuste_prox_w,'mm/yyyy') = to_char(dt_ref_mensalidade_w,'mm/yyyy')) then 
			select	trim(both to_char(coalesce(dt_reajuste,dt_contrato),'MONTH'))||'/'|| 
				to_char(add_months(pls_obter_proximo_reajuste(nr_sequencia),12),'yyyy') 
			into STRICT	dt_proximo_reajuste_w 
			from	pls_contrato 
			where	nr_sequencia	= nr_seq_contrato_w;
		end if;
	end if;
	 
	if (coalesce(nr_seq_segurado_w::text, '') = '') then 
		select	max(a.nr_sequencia) 
		into STRICT	nr_seq_segurado_w 
		from	pls_segurado a 
		where	a.nr_seq_pagador 	= nr_seq_pagador_w;
	end if;
	 
	if (nr_seq_segurado_w IS NOT NULL AND nr_seq_segurado_w::text <> '') then 
		select	max(a.nr_seq_plano) 
		into STRICT	nr_seq_plano_w 
		from	pls_segurado_carteira	b, 
			pls_segurado		a 
		where	a.nr_sequencia	= b.nr_seq_segurado 
		and	a.nr_sequencia 	= nr_seq_segurado_w;
	 
		if (nr_seq_mensalidade_w IS NOT NULL AND nr_seq_mensalidade_w::text <> '') then 
			select sum(coalesce(a.vl_outros,0)) vl_outros, 
				campo_mascara_virgula(coalesce(sum(a.vl_mensalidade),0)) vl_total_mens, 
				max(a.nr_sequencia) 
			into STRICT	vl_outros_n_w, 
				vl_total_w, 
				nr_seq_mensalidade_seg_w 
			from 	pls_mensalidade_segurado 	a 
			where 	a.nr_seq_mensalidade  		= nr_seq_mensalidade_w  
			order by a.nr_sequencia LIMIT 9;
			 
			select	sum(coalesce(a.vl_item,0)) 
			into STRICT	vl_item_w 
			from	pls_mensalidade_seg_item a, 
				pls_mensalidade_segurado b 
			where	a.nr_seq_mensalidade_seg	= b.nr_sequencia 
			and	b.nr_seq_mensalidade  		= nr_seq_mensalidade_w 
			and	a.ie_tipo_item			= 4  
			order by a.nr_sequencia LIMIT 9;
 
			if (coalesce(vl_item_w,0) <= coalesce(vl_outros_n_w,0)) then 
				vl_outros_w := campo_mascara_virgula(coalesce(vl_outros_n_w,0) - coalesce(vl_item_w,0));
			end if;
		end if;
	end if;
	 
	if (nr_seq_plano_w IS NOT NULL AND nr_seq_plano_w::text <> '') then 
		select	ds_plano, 
			nr_protocolo_ans 
		into STRICT	ds_plano_w, 
			nr_protocolo_ans_w 
		from	pls_plano 
		where	nr_sequencia		= nr_seq_plano_w;
	end if;	
	 
	while(nr_linha_w <= 7) loop 
		 
		if (nr_linha_w = 1) then 
			-- Mensagem 1 -- 
			if (cd_cgc_estip_w IS NOT NULL AND cd_cgc_estip_w::text <> '') then 
				begin 
				select	coalesce(substr(ds_observacao,1,69),' ') 
				into STRICT	ds_mensagem_1_w 
				from	pls_reajuste 
				where	nr_contrato	= nr_contrato_w 
				and	dt_reajuste_aux	= to_char(dt_reajuste_w, 'mm/yyyy');								
				exception 
				when others then 
					ds_mensagem_1_w :=	'';
				end;
			else 
				ds_mensagem_1_w	:=	substr(pls_obter_mensagem_reajuste(nr_seq_mensalidade_w,1,'RA'),1,69);
			end if;
			 
			nr_seq_registro_w :=	nr_seq_registro_w + 1;
			ds_conteudo_w	:= 	'7' || ds_brancos_27_w || rpad(coalesce(ds_mensagem_1_w,' '),69,' ') || '1';
			 
			-- Mensagem 2 -- 
			if (cd_cgc_estip_w IS NOT NULL AND cd_cgc_estip_w::text <> '') then 
				begin 
				select	coalesce(substr(ds_observacao,101,69),' ') 
				into STRICT	ds_mensagem_2_w 
				from	pls_reajuste 
				where	nr_contrato	= nr_contrato_w 
				and	dt_reajuste_aux	= to_char(dt_reajuste_w, 'mm/yyyy');
				exception 
				when others then 
					ds_mensagem_1_w :=	'';
				end;
			else 
				ds_mensagem_2_w	:=	substr(pls_obter_mensagem_reajuste(nr_seq_mensalidade_w,2,'RA'),1,69);
			end if;
			 
			ds_conteudo_w	:= 	ds_conteudo_w || rpad(coalesce(ds_mensagem_2_w,' '),69,' ') || '1';
		 
			-- Mensagem 3 -- 
			ds_mensagem_3_w	:=	substr(pls_obter_mensagem_reajuste(nr_seq_mensalidade_w,3,'RA'),1,69);
			 
			ds_conteudo_w	:= 	ds_conteudo_w || rpad(coalesce(ds_mensagem_3_w,' '),69,' ') || '1';
			 
			-- Mensagem 4 -- 
			ds_mensagem_4_w	:=	'';
			 
			ds_conteudo_w	:= 	ds_conteudo_w || rpad(coalesce(ds_mensagem_4_w,' '),69,' ') || '1';
			 
			-- Mensagem 5 --			 
			ds_mensagem_5_w	:= 	substr('APOS VENC. MULTA DE '||pr_multa_w||'% E JUROS '||pr_juros_w||'% AO DIA. MES REF. '||dt_mensalidade_w, 1, 69);
			 
			ds_conteudo_w	:= 	ds_conteudo_w || rpad(coalesce(ds_mensagem_5_w,' '),69,' ') || '1' || 
						ds_brancos_16_w || lpad(nr_seq_registro_w,6,'0');
			nr_linha_w 	:= 	nr_linha_w + 1;				
			utl_file.put_line(arq_texto_w,ds_conteudo_w|| chr(13));
			utl_file.fflush(arq_texto_w);
			 
		elsif (nr_linha_w = 2) then 
			-- Mensagem 1 -- 
			if (nr_contrato_w IS NOT NULL AND nr_contrato_w::text <> '') then 
				ds_mensagem_1_w	:= 'Contrato :   '||lpad(nr_contrato_w,15,'0');
			else	 
				ds_mensagem_1_w	:= lpad(' ',30,' ');
			end if;
			 
			if (nr_protocolo_ans_w IS NOT NULL AND nr_protocolo_ans_w::text <> '') then 
				ds_mensagem_1_w	:= ds_mensagem_1_w || '     Reg. Produto ANS '|| nr_protocolo_ans_w;
			end if;
			nr_seq_registro_w :=	nr_seq_registro_w + 1;
			ds_conteudo_w	:= 	'7' || ds_brancos_27_w || rpad(coalesce(ds_mensagem_1_w,' '),69,' ') || '1';
			 
			-- Mensagem 2 -- 
			if (pls_obter_meses_entre_datas(dt_ref_mensalidade_w, dt_reajuste_w) = 1) then 
				ds_mensagem_2_w	:= 	'Portabilidade de Carencias: Periodo de ' || to_char(trunc(dt_reajuste_w,'month'),'dd/mm/yyyy') || ' a ' || 
								to_char(fim_mes(add_months(dt_reajuste_w,3)),'dd/mm/yyyy');
			else 
				ds_mensagem_2_w	:= '';
			end if;	
			ds_conteudo_w	:= 	ds_conteudo_w || rpad(coalesce(ds_mensagem_2_w,' '),69,' ') || '1';
			 
			-- Mensagem 3 -- 
			if (dt_proximo_reajuste_w IS NOT NULL AND dt_proximo_reajuste_w::text <> '') then 
				ds_mensagem_3_w	:= 'Proximo reajuste: '||dt_proximo_reajuste_w;
			else	 
				ds_mensagem_3_w	:= '';
			end if;			
			ds_conteudo_w	:= 	ds_conteudo_w || rpad(coalesce(ds_mensagem_3_w,' '),69,' ') || '1';
			 
			-- Mensagem 4 -- 
			if (ds_plano_w IS NOT NULL AND ds_plano_w::text <> '') then 
				ds_mensagem_4_w	:= 'Plano: ' || ds_plano_w;
			else 
				ds_mensagem_4_w 	:= '';
			end if;		
			ds_conteudo_w	:= 	ds_conteudo_w || rpad(coalesce(ds_mensagem_4_w,' '),69,' ') || '1';
			 
			-- Mensagem 5 -- 
			ds_mensagem_5_w	:=	'>>Resumo da Fatura. Detalhes Co-Part.: www.ativia.com.br<<';			
			ds_conteudo_w	:= 	ds_conteudo_w || rpad(coalesce(ds_mensagem_5_w,' '),69,' ') || '1' || 
						ds_brancos_16_w || lpad(nr_seq_registro_w,6,'0');
			nr_linha_w 	:= 	nr_linha_w + 1;				
			utl_file.put_line(arq_texto_w,ds_conteudo_w|| chr(13));
			utl_file.fflush(arq_texto_w);
			 
		elsif (nr_linha_w = 3) and (ie_mensagem_w = 'N') then 
			ds_mensagem_w	:= 	'Numero Cartao Id. Inicio Reg. Prod. Mensal. Co-Part. Qt.CP ';
			qt_msg_linha_w	:= 	1;
			ds_conteudo_w	:= 	'7' || ds_brancos_27_w || rpad(coalesce(ds_mensagem_w,' '),69,' ') || '1';
			 
			open C02;
			loop 
			fetch C02 into	 
				vl_mensalidade_w, 
				vl_coparticipacao_w, 
				nr_seq_segurado_mens_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin				 
				 
				select	b.cd_usuario_plano, 
					to_char(a.dt_contratacao,'dd/mm/yyyy') 
				into STRICT	cd_usuario_plano_w, 
					dt_contratacao_w 
				from	pls_segurado_carteira	b, 
					pls_segurado		a 
				where	a.nr_sequencia	= b.nr_seq_segurado 
				and	a.nr_sequencia 	= nr_seq_segurado_mens_w;
				 
				select	count(1) 
				into STRICT	qt_coparticipacao_w 
				from	pls_mensalidade_seg_item b, 
					pls_mensalidade_segurado a 
				where	b.nr_seq_mensalidade_seg = a.nr_sequencia 
				and	a.nr_seq_mensalidade	= nr_seq_mensalidade_w 
				and	a.nr_seq_segurado	= nr_seq_segurado_mens_w 
				and	b.ie_tipo_item 		= 3;
				 
				ds_mensagem_w	:= 	rpad(cd_usuario_plano_w,18,' ') || rpad(dt_contratacao_w,11,' ') || rpad(nr_protocolo_ans_w,11,' ') || 
							rpad(vl_mensalidade_w,11,' ') 	|| rpad(vl_coparticipacao_w,11,' ')|| rpad(qt_coparticipacao_w,7,' ');
				qt_msg_linha_w	:= 	qt_msg_linha_w + 1;
				 
				if (qt_msg_linha_w = 1) then 
					nr_seq_registro_w :=	nr_seq_registro_w + 1;					
					ds_conteudo_w	:=	'7' || ds_brancos_27_w;
				end if;
					 
				ds_conteudo_w	:= 	ds_conteudo_w || rpad(coalesce(ds_mensagem_w,' '),69,' ') || '1';
				 
				if (qt_msg_linha_w = 5) then 
					qt_msg_linha_w	:= 	0;
					ds_conteudo_w	:= 	ds_conteudo_w || ds_brancos_16_w || lpad(nr_seq_registro_w,6,'0');								
					nr_linha_w 	:= 	nr_linha_w + 1;
					 
					utl_file.put_line(arq_texto_w,ds_conteudo_w|| chr(13));
					utl_file.fflush(arq_texto_w);					
				end if;
				 
				ie_itens_adicionados_w	:= 'S';
				 
				end;
			end loop;
			close C02;			
			if (ie_itens_adicionados_w = 'N') then 
				ie_mensagem_w	:=	'A';
			else	 
				ie_mensagem_w	:=	'B';
			end if;			
			 
		elsif (nr_linha_w <= 7) then 
			qt_msg_linha_w	:= 	qt_msg_linha_w + 1;
			 
			if (ie_mensagem_w = 'A') then 
				ds_mensagem_w	:= 	'';
				ie_mensagem_w	:= 	'B';
			end if;
			 
			if (ie_mensagem_w = 'B') then 
				ds_mensagem_w	:= 	rpad('Outros eventos:',37,' ') || coalesce(vl_outros_w,'0,00');
				ie_mensagem_w	:= 	'C';
			end if;
			 
			if (ie_mensagem_w = 'C') then 
				if (vl_total_w IS NOT NULL AND vl_total_w::text <> '') then 
					ds_mensagem_w	:=	rpad('Totalizacao:',37,' ') || vl_total_w;
				else 
					ds_mensagem_w	:= '';
				end if;
				ie_mensagem_w	:= 	'D';
			end if;
			 
			if (ie_mensagem_w = 'D') then 
				ds_mensagem_w	:= 	'';
			end if;
			 
			if (qt_msg_linha_w = 1) then 
				nr_seq_registro_w :=	nr_seq_registro_w + 1;
				ds_conteudo_w	:=	'7' || ds_brancos_27_w;
			end if;
			 
			ds_conteudo_w	:= 	ds_conteudo_w || rpad(coalesce(ds_mensagem_w,' '),69,' ') || '1';
			 
			if (qt_msg_linha_w = 5) then 
				qt_msg_linha_w	:= 	0;
				ds_conteudo_w	:= 	ds_conteudo_w || ds_brancos_16_w || lpad(nr_seq_registro_w,6,'0');								
				nr_linha_w 	:= 	nr_linha_w + 1;				
				utl_file.put_line(arq_texto_w,ds_conteudo_w|| chr(13));
				utl_file.fflush(arq_texto_w);					
			end if;	
		 
		end if;
	 
	end loop;	
	/*Fim - Mensagem*/
 
	end;
				 
end loop;
close C01;
/*Fim Detalhe */
 
 
/* Trailler Arquivo*/
 
begin 
 
nr_seq_registro_w := nr_seq_registro_w + 1;
 
ds_conteudo_w	:= '9' || ds_brancos_6_w || lpad('0',13,'0') || ds_brancos_374_w || lpad(nr_seq_registro_w,6,'0');
 
utl_file.put_line(arq_texto_w,ds_conteudo_w|| chr(13));
utl_file.fflush(arq_texto_w);
end;
/* Fim Trailler Arquivo*/
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cobr_bol_itau_400 ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

