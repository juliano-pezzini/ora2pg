-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE receber_rat_barras ( nr_seq_rat_p bigint, nm_usuario_p text) AS $body$
DECLARE


dt_receb_rat_w	timestamp := null;
dt_lib_rat_w	timestamp := null;
ds_destino_w	proj_rat.nm_usuario%type;
ie_status_rat_w	proj_rat.ie_status_rat%type;
nr_sequencia_w	comunic_interna_classif.nr_sequencia%type;


BEGIN

select	max(dt_receb_rat)
into STRICT	dt_receb_rat_w
from	proj_rat
where 	nr_sequencia = nr_seq_rat_p;

if (dt_receb_rat_w IS NOT NULL AND dt_receb_rat_w::text <> '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(414066);
end if;

select	max(dt_liberacao)
into STRICT	dt_lib_rat_w
from	proj_rat
where 	nr_sequencia = nr_seq_rat_p;

if (coalesce(dt_lib_rat_w::text, '') = '') then

	select 	substr(obter_usuario_pessoa(cd_executor),1,15)
	into STRICT	ds_destino_w
	from    proj_rat
	where   nr_sequencia = nr_seq_rat_p;

	select	min(nr_sequencia)
	into STRICT	nr_sequencia_w
	from	comunic_interna_classif
	where	ie_tipo = 'F';

	CALL gerar_comunic_padrao(clock_timestamp(), wheb_mensagem_pck.get_texto(1052374, 'NR_SEQ_RAT=' || nr_seq_rat_p), wheb_mensagem_pck.get_texto(1052375, 'NR_SEQ_RAT=' || nr_seq_rat_p), nm_usuario_p, 'N', ds_destino_w, 'N', nr_sequencia_w, null,	null, null,	clock_timestamp(), null, null);
	commit;
	CALL wheb_mensagem_pck.exibir_mensagem_abort(414073);

end if;

select	ie_status_rat
into STRICT	ie_status_rat_w
from	proj_rat
where 	nr_sequencia = nr_seq_rat_p;

if (ie_status_rat_w <> 'LC') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(414088);
end if;

CALL proj_rat_update_dt_receb(nr_seq_rat_p, nm_usuario_p);

select 	substr(obter_usuario_pessoa(cd_executor),1,15)
into STRICT	ds_destino_w
from    proj_rat
where   nr_sequencia = nr_seq_rat_p;

select	min(nr_sequencia)
into STRICT	nr_sequencia_w
from	comunic_interna_classif
where	ie_tipo = 'F';

CALL gerar_comunic_padrao(clock_timestamp(), wheb_mensagem_pck.get_texto(1052376, 'NR_SEQ_RAT=' || nr_seq_rat_p), wheb_mensagem_pck.get_texto(1052377, 'NR_SEQ_RAT=' || nr_seq_rat_p), nm_usuario_p, 'N', ds_destino_w, 'N', nr_sequencia_w, null,	null, null,	clock_timestamp(), null, null);
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE receber_rat_barras ( nr_seq_rat_p bigint, nm_usuario_p text) FROM PUBLIC;

