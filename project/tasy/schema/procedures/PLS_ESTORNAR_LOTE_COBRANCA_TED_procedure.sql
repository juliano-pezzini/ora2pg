-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_estornar_lote_cobranca_ted (nr_seq_lote_cob_terc_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade: Estornar lote de cobrança TED. 
------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[ ] Objetos do dicionário [X] Tasy (Delphi/Java) [ ] Portal [ ] Relatórios [ ] Outros: 
 ------------------------------------------------------------------------------------------------------------------ 
Pontos de atenção: 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 	 
 
nr_titulo_w 		bigint;
nr_seq_baixa_w		bigint;

C01 CURSOR FOR 
	SELECT	max(a.nr_sequencia), 
		a.nr_titulo 
	from	titulo_receber_liq a 
	where	a.nr_seq_pls_lote_cob_terc = nr_seq_lote_cob_terc_p 
	and	exists (SELECT	1 
			from	pls_lote_cob_terceiro_item	x, 
				pls_lote_cob_terceiro		y 
			where	y.nr_sequencia 	= x.nr_seq_lote 
			and	y.nr_sequencia 	= a.nr_seq_pls_lote_cob_terc 
			and	x.nr_titulo	= a.nr_titulo) 
	group by a.nr_titulo;


BEGIN 
if (nr_seq_lote_cob_terc_p IS NOT NULL AND nr_seq_lote_cob_terc_p::text <> '') then 
	open C01;
	loop 
	fetch C01 into	 
		nr_seq_baixa_w, 
		nr_titulo_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		CALL Estornar_tit_receber_liq(nr_titulo_w, 
					nr_seq_baixa_w, 
					null, 
					nm_usuario_p, 
					'N', 
					'Estorno realizado pela Cobrança terceirizada, lote de cobrança ' || nr_seq_lote_cob_terc_p || ', ' || 
					'função OPS - Transferência Eletrônica de Dados (TED).', 
					null);
		end;
	end loop;
	close C01;
 
	update	pls_lote_cob_terceiro 
	set	dt_baixa 	 = NULL, 
		nm_usuario	= nm_usuario_p, 
		dt_atualizacao	= clock_timestamp() 
	where	nr_sequencia 	= nr_seq_lote_cob_terc_p;
				 
	commit;	
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_estornar_lote_cobranca_ted (nr_seq_lote_cob_terc_p bigint, nm_usuario_p text) FROM PUBLIC;

