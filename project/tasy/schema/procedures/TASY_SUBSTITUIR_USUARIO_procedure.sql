-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_substituir_usuario (nm_usuario_old_p text, nm_usuario_new_p text, nm_usuario_p text) AS $body$
DECLARE


nm_tabela_w	varchar(40);
nm_constraint_w	varchar(40);
nm_campo_w	varchar(40);
qt_registro_w	bigint;
qt_tamanho_w	bigint;
ds_comando_w	varchar(3000);
qt_inicial_w	bigint;
qt_final_w	bigint;


C01 CURSOR FOR
SELECT 	TABLE_NAME,
	CONSTRAINT_NAME,
	substr(COLUMN_NAME,1,40)
from user_cons_columns
where CONSTRAINT_NAME like '%USUARIO%'
and TABLE_NAME <> 'USUARIO';



BEGIN

qt_registro_w	:= 0;
qt_tamanho_w	:= 0;

/* Validar usuarios a serem substituidos */

if (coalesce(nm_usuario_old_p::text, '') = '')	or (nm_usuario_old_p = ' ')	or (coalesce(nm_usuario_new_p::text, '') = '')	or (nm_usuario_new_p = ' ')	then
	--Faltou informar Usuário de destino ou origem');
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(261601);
end if;

qt_tamanho_w	:= Length(nm_usuario_new_p);
if (qt_tamanho_w > 15) 	or (qt_tamanho_w < 3)	then
	--Usuário de destino deve ter entre 3 e 15 dígitos');
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(261602);
end if;

select 	count(*)
into STRICT	qt_registro_w
from	usuario
where	nm_usuario = nm_usuario_old_p;
if (qt_registro_w <> 1) then
	--Usuário original não existe ou esta duplicado');
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(261603);
end if;

select 	count(*)
into STRICT	qt_registro_w
from	usuario
where	nm_usuario = nm_usuario_new_p;
if (qt_registro_w > 0) then
	--Usuário de destino já existe');
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(261605);
end if;

/* Verificar quantidade de constraints desabilitadas - inicial */

select	count(*)
into STRICT	qt_inicial_w
from	user_constraints
where	constraint_name like '%USUARIO%'
and	status	= 'DISABLED';

/* Desabilitar constraints */

open C01;
loop
fetch c01 into
	nm_tabela_w,
	nm_constraint_w,
	nm_campo_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	BEGIN
	ds_comando_w  := ('ALTER TABLE '||nm_tabela_w||
				' DISABLE CONSTRAINT '||nm_constraint_w);
	CALL exec_sql_dinamico('TASY', ds_comando_w);
	END;
end loop;
close C01;

/* Alterar usuário */

open C01;
loop
fetch c01 into
	nm_tabela_w,
	nm_constraint_w,
	nm_campo_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	BEGIN
	ds_comando_w  := ('UPDATE '||nm_tabela_w||' SET '||nm_campo_w||' = '||
			chr(39)||nm_usuario_new_p||chr(39)||' WHERE '||
			nm_campo_w||' = '||chr(39)||nm_usuario_old_p||chr(39));
	CALL exec_sql_dinamico('TASY', ds_comando_w);
	commit;
	END;
end loop;
close C01;

begin
update 	usuario
set	nm_usuario 	= nm_usuario_new_p,
	nm_usuario_orig	= nm_usuario_old_p,
	nm_usuario_atual = nm_usuario_p,
	dt_atualizacao	= clock_timestamp()
where	nm_usuario = nm_usuario_old_p;
exception
	when others then
	--Erro ao alterar usuário original');
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(261606);
end;
commit;

/* Habilitar constraints */

open C01;
loop
fetch c01 into
	nm_tabela_w,
	nm_constraint_w,
	nm_campo_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	BEGIN
	ds_comando_w  := ('ALTER TABLE '||nm_tabela_w||
				' ENABLE CONSTRAINT '||nm_constraint_w);
	CALL exec_sql_dinamico('TASY', ds_comando_w);
	END;
end loop;
close C01;

/* Verificar quantidade de constraints desabilitadas - final */

select	count(*)
into STRICT	qt_final_w
from	user_constraints
where	constraint_name like '%USUARIO%'
and	status	= 'DISABLED';

if (qt_final_w > qt_inicial_w) then
	--Processo deixou constraints desabilitadas, verifique c/suporte');
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(261607);
end if;


END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_substituir_usuario (nm_usuario_old_p text, nm_usuario_new_p text, nm_usuario_p text) FROM PUBLIC;

