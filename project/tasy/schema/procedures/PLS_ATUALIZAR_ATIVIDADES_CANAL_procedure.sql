-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_atividades_canal ( nr_seq_solicitacao_p bigint, nr_seq_cliente_p bigint, ie_commit_p text, nm_usuario_p text) AS $body$
DECLARE


qt_dias_atividade_canal_w	bigint;
ie_origem_solicitacao_w		varchar(2);
ie_tipo_contratacao_w		pls_plano.ie_tipo_contratacao%type;
ie_aplicacao_comercial_w	varchar(1);

C01 CURSOR FOR
	SELECT	qt_dias_ativ_canal_com
	from	(SELECT	qt_dias_ativ_canal_com,
			ie_origem_solicitacao,
			ie_tipo_contratacao
		from	pls_comercial_regra_acao
		where	((ie_aplicacao_comercial_w = 'S' AND nr_seq_solicitacao = nr_seq_solicitacao_p) or
			 (ie_aplicacao_comercial_w = 'P' AND nr_seq_cliente = nr_seq_cliente_p))
		and	ie_situacao		= 'A'
		
union all

		select	qt_dias_ativ_canal_com,
			ie_origem_solicitacao,
			ie_tipo_contratacao
		from	pls_comercial_regra_acao
		where	coalesce(nr_seq_solicitacao::text, '') = ''
		and	coalesce(nr_seq_cliente::text, '') = ''
		and	not exists (	select	1
					from	pls_comercial_regra_acao
					where	nr_seq_solicitacao	= nr_seq_solicitacao_p
					and	ie_situacao		= 'A')
		and	((ie_aplicacao_comercial = ie_aplicacao_comercial_w) or (ie_aplicacao_comercial = 'T'))
		and	ie_situacao		= 'A'
		and	((ie_origem_solicitacao = ie_origem_solicitacao_w) or (coalesce(ie_origem_solicitacao::text, '') = ''))
		and	((ie_tipo_contratacao = ie_tipo_contratacao_w) or (coalesce(ie_tipo_contratacao::text, '') = ''))) alias17
	order by coalesce(ie_origem_solicitacao,' '),
		coalesce(ie_tipo_contratacao, ' ');


BEGIN

if (nr_seq_solicitacao_p IS NOT NULL AND nr_seq_solicitacao_p::text <> '') then
	ie_aplicacao_comercial_w	:= 'S';

	select	coalesce(ie_origem_solicitacao,'E'),
		coalesce(ie_tipo_contratacao,'I')
	into STRICT	ie_origem_solicitacao_w,
		ie_tipo_contratacao_w
	from	pls_solicitacao_comercial
	where	nr_sequencia = nr_seq_solicitacao_p;

	open C01;
	loop
	fetch C01 into
		qt_dias_atividade_canal_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	end loop;
	close C01;

	if (qt_dias_atividade_canal_w IS NOT NULL AND qt_dias_atividade_canal_w::text <> '') then
		update	pls_solicitacao_comercial
		set	dt_atividade_canal	= clock_timestamp() + qt_dias_atividade_canal_w,
			nm_usuario		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp()
		where	nr_sequencia		= nr_seq_solicitacao_p;
	end if;
elsif (nr_seq_cliente_p IS NOT NULL AND nr_seq_cliente_p::text <> '') then
	ie_aplicacao_comercial_w	:= 'P';

	begin
	select	coalesce(b.ie_origem_solicitacao,'E'),
		coalesce(ie_tipo_contratacao,'I')
	into STRICT	ie_origem_solicitacao_w,
		ie_tipo_contratacao_w
	from	pls_solicitacao_comercial	b,
		pls_comercial_cliente		a
	where	a.nr_seq_solicitacao = b.nr_sequencia
	and	a.nr_sequencia = nr_seq_cliente_p;
	exception
	when others then
		ie_origem_solicitacao_w := 'E';
		ie_tipo_contratacao_w	:= 'I';
	end;

	if (qt_dias_atividade_canal_w IS NOT NULL AND qt_dias_atividade_canal_w::text <> '') then
		update	pls_comercial_cliente
		set	dt_atividade_canal	= clock_timestamp() + qt_dias_atividade_canal_w,
			nm_usuario		= nm_usuario_p,
			dt_atualizacao		= clock_timestamp()
		where	nr_sequencia		= nr_seq_cliente_p;
	end if;
end if;

if (ie_commit_p	= 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_atividades_canal ( nr_seq_solicitacao_p bigint, nr_seq_cliente_p bigint, ie_commit_p text, nm_usuario_p text) FROM PUBLIC;

