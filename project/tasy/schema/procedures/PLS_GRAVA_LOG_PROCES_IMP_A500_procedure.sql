-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



--
-- dblink wrapper to call function pls_grava_log_proces_imp_a500 as an autonomous transaction
--
CREATE EXTENSION IF NOT EXISTS dblink;

CREATE OR REPLACE PROCEDURE pls_grava_log_proces_imp_a500 ( ds_p pls_log_execucao_temp.ds%type, ds_processo_p pls_log_execucao_temp.ds_processo%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE
	-- Change this to reflect the dblink connection string
	v_conn_str  text := format('port=%s dbname=%s user=%s', current_setting('port'), current_database(), current_user);
	v_query     text;

BEGIN
	v_query := 'CALL pls_grava_log_proces_imp_a500_atx ( ' || quote_nullable(ds_p) || ',' || quote_nullable(ds_processo_p) || ',' || quote_nullable(nm_usuario_p) || ' )';
	PERFORM * FROM dblink(v_conn_str, v_query) AS p (ret boolean);

END;
$body$ LANGUAGE plpgsql SECURITY DEFINER;




CREATE OR REPLACE PROCEDURE pls_grava_log_proces_imp_a500_atx ( ds_p pls_log_execucao_temp.ds%type, ds_processo_p pls_log_execucao_temp.ds_processo%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE
ds_sql_w	varchar(500);
nm_id_sid_w	pls_log_execucao_temp.nm_id_sid%type;
nm_id_serial_w	pls_log_execucao_temp.nm_id_serial%type;


BEGIN

begin
	ds_sql_w := 	'select	sid,' || pls_util_pck.enter_w ||
			'	serial#' || pls_util_pck.enter_w ||
			'	from	v$session' || pls_util_pck.enter_w ||
			'where	audsid = userenv(''SESSIONID'')';

	EXECUTE ds_sql_w into STRICT nm_id_sid_w, nm_id_serial_w;

exception
when others then
	nm_id_sid_w := null;
	nm_id_serial_w := null;
end;

insert into pls_log_execucao_temp(	nr_sequencia,				data,			nm_usuario,		nm_id_sid,
					nm_id_serial,				ds,			ds_processo,		ds_extra)
			values (	nextval('pls_log_execucao_temp_seq'),	clock_timestamp(),		nm_usuario_p,		nm_id_sid_w,
					nm_id_serial_w,				ds_p,			ds_processo_p,		dbms_utility.format_call_stack);
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_grava_log_proces_imp_a500 ( ds_p pls_log_execucao_temp.ds%type, ds_processo_p pls_log_execucao_temp.ds_processo%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC; -- REVOKE ALL ON PROCEDURE pls_grava_log_proces_imp_a500_atx ( ds_p pls_log_execucao_temp.ds%type, ds_processo_p pls_log_execucao_temp.ds_processo%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

