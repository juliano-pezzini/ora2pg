-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_inserir_exames_laudo ( nr_seq_laudo_p bigint, ds_lista_exames_p text, nm_usuario_p text) AS $body$
DECLARE

 
lista_informacao_w		varchar(1000);
ie_contador_w		bigint	:= 0;
tam_lista_w		bigint;
ie_pos_virgula_w		smallint;
ie_pos_traco_w		bigint;
lista_inf_w		varchar(100);
nr_seq_exame_w		bigint;
nr_prescricao_w		bigint;
qt_registro_null_w		smallint;	
ds_exame_resultado_w	varchar(2000);
ds_resultado_w		varchar(2000);
					

BEGIN 
 
lista_informacao_w	:= ds_lista_exames_p;
 
while (lista_informacao_w IS NOT NULL AND lista_informacao_w::text <> '') and 
	ie_contador_w < 4 loop 
	begin 
	 
	tam_lista_w			:= length(lista_informacao_w);
	ie_pos_virgula_w			:= position(',' in lista_informacao_w);
	ie_pos_traco_w			:= position('-' in lista_informacao_w);
	lista_inf_w			:= substr(lista_informacao_w,1,ie_pos_virgula_w - 1);
	 
	/* Obter a sequência lida */
 
	if (ie_pos_virgula_w <> 0) then 
		begin 
		nr_seq_exame_w		:= substr(lista_inf_w,1,(ie_pos_traco_w - 1));
		lista_inf_w		:= substr(lista_inf_w,ie_pos_traco_w + 1,100);
		nr_prescricao_w		:= lista_inf_w;
		lista_informacao_w	:= substr(lista_informacao_w,(ie_pos_virgula_w + 1),tam_lista_w);
		end;
	end if;
	 
	if (nr_seq_laudo_p > 0) then 
		begin 
		 
		select	count(*) 
		into STRICT	qt_registro_null_w		 
		FROM exame_laboratorio c, exame_lab_resultado b, exame_lab_result_item a, exame_lab_format d
LEFT OUTER JOIN exame_lab_material e ON (d.nr_seq_exame = e.nr_seq_exame AND d.nr_seq_material = e.nr_seq_material)
WHERE a.nr_seq_exame	= c.nr_seq_exame and a.nr_seq_formato = d.nr_seq_formato   and a.nr_seq_resultado = b.nr_seq_resultado and ((a.ds_resultado IS NOT NULL AND a.ds_resultado::text <> '') or (a.qt_resultado IS NOT NULL AND a.qt_resultado::text <> '') or (a.pr_resultado IS NOT NULL AND a.pr_resultado::text <> '')) and b.nr_prescricao = nr_prescricao_w and c.nr_seq_exame 	= nr_seq_exame_w;
		 
		if (qt_registro_null_w = 0) then 
			--R.aise_application_error(-20011,'Não foram encontrados resultados para o exame '||Lab_Obter_Dados_Exame(nr_seq_exame_w,'N')||' ! #@#@');	 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(263523,'ds_exame_w='||Lab_Obter_Dados_Exame(nr_seq_exame_w,'N'));
		end if;
		 
		select	substr(c.nm_exame||' '||a.ds_resultado||' '||coalesce(a.qt_resultado,a.pr_resultado)||' '||e.ds_unidade_medida,1,255) 
		into STRICT	ds_resultado_w 
		FROM exame_laboratorio c, exame_lab_resultado b, exame_lab_result_item a, exame_lab_format d
LEFT OUTER JOIN exame_lab_material e ON (d.nr_seq_exame = e.nr_seq_exame AND d.nr_seq_material = e.nr_seq_material)
WHERE a.nr_seq_exame	= c.nr_seq_exame and a.nr_seq_formato = d.nr_seq_formato   and a.nr_seq_resultado = b.nr_seq_resultado and ((a.ds_resultado IS NOT NULL AND a.ds_resultado::text <> '') or (a.qt_resultado IS NOT NULL AND a.qt_resultado::text <> '') or (a.pr_resultado IS NOT NULL AND a.pr_resultado::text <> '')) and b.nr_prescricao = nr_prescricao_w and c.nr_seq_exame 	= nr_seq_exame_w group by	substr(c.nm_exame||' '||a.ds_resultado||' '||coalesce(a.qt_resultado,a.pr_resultado)||' '||e.ds_unidade_medida,1,255);
		 
		if (ie_contador_w < 1) then 
			ds_exame_resultado_w := ds_resultado_w;
		else	 
			ds_exame_resultado_w := ds_exame_resultado_w||', '||ds_resultado_w;
		end if;
		 
		end;
	end if;
	 
	ie_contador_w := ie_contador_w +1;
	end;
end loop;
 
update	sus_laudo_paciente 
set	ds_exame_resultado = coalesce(substr(ds_exame_resultado_w,1,2000),'') 
where	nr_seq_interno 	= nr_seq_laudo_p;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_inserir_exames_laudo ( nr_seq_laudo_p bigint, ds_lista_exames_p text, nm_usuario_p text) FROM PUBLIC;

