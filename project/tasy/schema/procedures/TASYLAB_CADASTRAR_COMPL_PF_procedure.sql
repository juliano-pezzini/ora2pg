-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasylab_cadastrar_compl_pf ( cd_pessoa_fisica_p text, cd_cep_res_p text, ds_endereco_res_p text, nr_endereco_res_p bigint, ds_bairro_res_p text, ds_complemento_res_p text, ds_municipio_res_p text, sg_estado_res_p text, ds_email_res_p text, nm_contato_mae_p text, nr_seq_externo_p bigint, cd_erro_p INOUT bigint, ds_erro_p INOUT text) AS $body$
DECLARE


ie_existe_compl_w	varchar(2);
ie_existe_w			varchar(2);
nr_sequencia_w		bigint;


BEGIN

cd_erro_p	:= 0;

CALL tasy_atualizar_dados_sessao(nr_seq_externo_p);

/*if	(cd_cep_res_p is null) and
	(ds_endereco_res_p is null) and
	(ds_bairro_res_p is null) and
	(ds_complemento_res_p is null) and
	(ds_municipio_res_p is null) and
	(sg_estado_res_p is null) and
	(ds_email_res_p is null) then
	cd_erro_p := 4;
end if;*/
if (cd_erro_p IS NOT NULL AND cd_erro_p::text <> '') then

	select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_existe_w
	from	pessoa_fisica
	where	cd_pessoa_fisica = cd_pessoa_fisica_p;

	if (ie_existe_w = 'N') then
		cd_erro_p	:= 5;
	end if;

	if (cd_erro_p = 0) then

		/* verifica se ja existem dados residenciais */

		select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
		into STRICT 	ie_existe_compl_w
		from	compl_pessoa_fisica a
		where	a.cd_pessoa_fisica = cd_pessoa_fisica_p
		and	a.ie_tipo_complemento = 1;

		if (ie_existe_compl_w = 'N') and (cd_cep_res_p IS NOT NULL AND cd_cep_res_p::text <> '') and (ds_endereco_res_p IS NOT NULL AND ds_endereco_res_p::text <> '') and (ds_bairro_res_p IS NOT NULL AND ds_bairro_res_p::text <> '') and (ds_complemento_res_p IS NOT NULL AND ds_complemento_res_p::text <> '') and (ds_municipio_res_p IS NOT NULL AND ds_municipio_res_p::text <> '') and (sg_estado_res_p IS NOT NULL AND sg_estado_res_p::text <> '') and (ds_email_res_p IS NOT NULL AND ds_email_res_p::text <> '') then
			/* Cadastrando os dados residenciais */

			select	coalesce(max(nr_sequencia),0) + 1
			into STRICT	nr_sequencia_w
			from	compl_pessoa_fisica
			where	cd_pessoa_fisica = cd_pessoa_fisica_p;

			begin
			insert into compl_pessoa_fisica(nr_sequencia,
								cd_pessoa_fisica,
								ie_tipo_complemento,
								cd_cep,
								ds_endereco,
								nr_endereco,
								ds_bairro,
								ds_complemento,
								ds_municipio,
								sg_estado,
								ds_email,
								nm_usuario,
								nm_usuario_nrec,
								dt_atualizacao,
								dt_atualizacao_nrec)
						values (	nr_sequencia_w,
								cd_pessoa_fisica_p,
								1,
								cd_cep_res_p,
								ds_endereco_res_p,
								nr_endereco_res_p,
								ds_bairro_res_p,
								ds_complemento_res_p,
								ds_municipio_res_p,
								sg_estado_res_p,
								ds_email_res_p,
								'TasyLab-CompPF1',
								'TasyLab-CompPF1',
								clock_timestamp(),
								clock_timestamp());
			exception
			when others then
				cd_erro_p	:= 1;
				ds_erro_p	:= substr('Erro ao inserir o complemento residencial '||sqlerrm,1,2000);
			end;
		end if;

		if (cd_erro_p = 0) then

			/* verifica se ja existem dados residenciais */

			select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
			into STRICT 	ie_existe_compl_w
			from	compl_pessoa_fisica a
			where	a.cd_pessoa_fisica = cd_pessoa_fisica_p
			and	a.ie_tipo_complemento = 5;

			if (ie_existe_compl_w = 'N') then
				/* Cadastrando os dados da mãe */

				select	coalesce(max(nr_sequencia),0) + 1
				into STRICT	nr_sequencia_w
				from	compl_pessoa_fisica
				where	cd_pessoa_fisica = cd_pessoa_fisica_p;

				begin
				insert into compl_pessoa_fisica(nr_sequencia,
								cd_pessoa_fisica,
								ie_tipo_complemento,
								nm_contato,
								nm_usuario,
								nm_usuario_nrec,
								dt_atualizacao,
								dt_atualizacao_nrec)
						values (	nr_sequencia_w,
								cd_pessoa_fisica_p,
								5,
								nm_contato_mae_p,
								'TasyLab-CompPF5',
								'TasyLab-CompPF5',
								clock_timestamp(),
								clock_timestamp());
				exception
				when others then
					cd_erro_p	:= 1;
					ds_erro_p	:= substr('Erro ao inserir o complemento da mãe do paciente. '||sqlerrm,1,2000);
				end;
			end if;
		end if;

		-- OS727249 - Ivan
		--if (cd_erro_p = 0) then
		--	commit;
		--end if;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasylab_cadastrar_compl_pf ( cd_pessoa_fisica_p text, cd_cep_res_p text, ds_endereco_res_p text, nr_endereco_res_p bigint, ds_bairro_res_p text, ds_complemento_res_p text, ds_municipio_res_p text, sg_estado_res_p text, ds_email_res_p text, nm_contato_mae_p text, nr_seq_externo_p bigint, cd_erro_p INOUT bigint, ds_erro_p INOUT text) FROM PUBLIC;

