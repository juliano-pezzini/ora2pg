-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_gerar_receita_medica ( cd_pessoa_fisica_p text, cd_profissional_p text, dt_receita_p timestamp, ie_tipo_receita_p text, nr_seq_formatacao_p bigint, nm_usuario_p text, nr_atendimento_p bigint, nr_seq_interno_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE


ds_procedimento_w		varchar(1000);
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
qt_proced_1_mes_w	integer;
cd_cid_principal_w		varchar(10);
cd_cid_secundario_w	varchar(10);
cd_intervalo_prescr_w	varchar(7);
cd_material_w		bigint;
cd_unidade_medida_w	varchar(30);
ds_masc_receita_w		varchar(4000);
ds_masc_receita_html_w	varchar(4000);
qt_medicamento_w		integer;
ds_receita_parcial_w	varchar(2000);
ds_receita_final_w		varchar(4000)	:= '';
qt_dose_continuo_w	double precision;
qt_dose_continuo_2_w	double precision;
qt_padrao_dose_w		double precision;
qt_operacao_w		intervalo_prescricao.qt_operacao%type;
qt_frequencia_w		real;
ds_unidade_medida_w	varchar(50);
ds_enter_w		varchar(20)	:= ' \par\par ';
nr_atendimento_w		bigint;
cd_estabelecimento_w	integer;
ds_enter_padrao_w		varchar(20)	:= chr(13)||chr(10);
ds_cabecalho_w		varchar(1000);
ds_rodape_w		varchar(1);
ds_fonte_w		varchar(100);
ds_tam_fonte_w		varchar(10);
nr_tam_fonte_w		integer;
ds_observacao_w		varchar(255);
ie_via_aplicacao_w	varchar(5);
ds_receita_w        med_receita.ds_receita%type;

c01 CURSOR FOR
	SELECT	cd_procedimento,
		ie_origem_proced,
		cd_cid_principal,
		cd_cid_secundario,
		qt_proced_1_mes,
		cd_intervalo_prescr,
		substr(ds_posologia,1,255),
		ie_via_aplicacao
	from	sus_laudo_medicamento
	where	nr_seq_laudo_sus = nr_seq_interno_p
	order by 1;


BEGIN

if (nr_seq_formatacao_p = 0) then
	ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(277548);
elsif (coalesce(ie_tipo_receita_p::text, '') = '') then
	ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(277549);
elsif (coalesce(cd_profissional_p::text, '') = '') then
	ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(277550);
elsif (obter_se_medico(cd_profissional_p, 'M') = 'N') then
	ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(277551);
else
	begin

	/* seleciona a formatacao da receita medica */

	select	ds_receita,
            ds_receita_novo
	into STRICT	ds_masc_receita_w,
            ds_masc_receita_html_w
	from	medic_mascara_receita
	where	nr_sequencia	= nr_seq_formatacao_p;

    if (ds_masc_receita_html_w IS NOT NULL AND ds_masc_receita_html_w::text <> '') then
        ds_masc_receita_w := ds_masc_receita_html_w;
        ds_enter_w := ' <br> ';
    end if;

	qt_medicamento_w	:= 0;

	open c01;
	loop
	fetch c01 into
		cd_procedimento_w,
		ie_origem_proced_w,
		cd_cid_principal_w,
		cd_cid_secundario_w,
		qt_proced_1_mes_w,
		cd_intervalo_prescr_w,
		ds_observacao_w,
		ie_via_aplicacao_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		select	sus_obter_material_proc_opm(cd_procedimento_w)
		into STRICT	cd_material_w
		;

		if (coalesce(cd_material_w,0) <> 0) then
			begin

			begin
			select	max(cd_unidade_medida)
			into STRICT	cd_unidade_medida_w
			from 	unidade_medida_dose_v
			where 	cd_material 	= cd_material_w
			and 	ie_prioridade  not in (8,9);
			exception
			when others then
				ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(277554) ||cd_material_w||'.';
			end;

			insert into medic_uso_continuo(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				cd_pessoa_fisica,
				dt_inicio,
				cd_material,
				qt_dose,
				cd_unidade_medida,
				ie_uso_continuo,
				ie_laudo_lme,
				nr_dias_uso,
				cd_intervalo,
				cd_cid_principal,
				cd_cid_secundario,
				ie_via_aplicacao,
				ds_observacao)
			values (	nextval('medic_uso_continuo_seq'),
				clock_timestamp(),
				nm_usuario_p,
				cd_pessoa_fisica_p,
				clock_timestamp(),
				cd_material_w,
				1,
				cd_unidade_medida_w,
				'S',
				'S',
				qt_proced_1_mes_w,
				cd_intervalo_prescr_w,
				cd_cid_principal_w,
				cd_cid_secundario_w,
				ie_via_aplicacao_w,
				ds_observacao_w);

			qt_medicamento_w	:= qt_medicamento_w + 1;
			ds_receita_parcial_w	:= ds_masc_receita_w;
			qt_dose_continuo_w	:= null;
			qt_dose_continuo_2_w	:= null;

			begin
			select	coalesce(obter_ocorrencia_intervalo(cd_intervalo_prescr_w,24,'O'),0),
				coalesce(qt_frequencia_receita,1)
			into STRICT	qt_operacao_w,
				qt_frequencia_w
			from	intervalo_prescricao
			where	cd_intervalo = cd_intervalo_prescr_w;
			exception
				when others then
				qt_operacao_w 	:= 0;
				qt_frequencia_w	:= 1;
				end;

			qt_dose_continuo_w	:= ceil((1 * qt_operacao_w) * 90);
			qt_dose_continuo_2_w:= ceil((1 * qt_operacao_w) * 180);
			qt_padrao_dose_w	:= ceil((1 * qt_operacao_w) * qt_frequencia_w);
			ds_unidade_medida_w 	:= substr(obter_unidade_medida(cd_unidade_medida_w),1,40) || '(s)';
			cd_unidade_medida_w 	:= cd_unidade_medida_w || '(s)';

			select	retorna_medic_formatado(ds_receita_parcial_w,'@Medicamento',substr(obter_desc_material(cd_material_w),1,255))
			into STRICT	ds_receita_parcial_w
			;
			select	retorna_medic_formatado(ds_receita_parcial_w,'@DoseUsoCont',qt_dose_continuo_w)
			into STRICT	ds_receita_parcial_w
			;
            select	retorna_medic_formatado(ds_receita_parcial_w,'@DoisDoseUsoCont',qt_dose_continuo_2_w)
			into STRICT	ds_receita_parcial_w
			;
			select	retorna_medic_formatado(ds_receita_parcial_w,'@DosePadraoMedic',qt_padrao_dose_w)
			into STRICT	ds_receita_parcial_w
			;
			select	retorna_medic_formatado(ds_receita_parcial_w,'@Dose',1)
			into STRICT	ds_receita_parcial_w
			;
			select	retorna_medic_formatado(ds_receita_parcial_w,'@DsUnidMedDose',ds_unidade_medida_w)
			into STRICT	ds_receita_parcial_w
			;
			select	retorna_medic_formatado(ds_receita_parcial_w,'@UnidMedDose',cd_unidade_medida_w)
			into STRICT	ds_receita_parcial_w
			;
			select	retorna_medic_formatado(ds_receita_parcial_w,'@IntervaloAdm',cd_intervalo_prescr_w)
			into STRICT	ds_receita_parcial_w
			;
			select	retorna_medic_formatado(ds_receita_parcial_w,'@DscIntervaloAdm',substr(obter_desc_intervalo_prescr(cd_intervalo_prescr_w),1,80))
			into STRICT	ds_receita_parcial_w
			;
			select	retorna_medic_formatado(ds_receita_parcial_w,'@DiasUtil',qt_proced_1_mes_w)
			into STRICT	ds_receita_parcial_w
			;
			select	retorna_medic_formatado(ds_receita_parcial_w,'@NumMedic',qt_medicamento_w)
			into STRICT	ds_receita_parcial_w
			;
			select	retorna_medic_formatado(ds_receita_parcial_w,'@DsUsoContinuo','Uso continuo')
			into STRICT	ds_receita_parcial_w
			;
			select	retorna_medic_formatado(ds_receita_parcial_w,'@FimUtilizacao','Uso continuo')
			into STRICT	ds_receita_parcial_w
			;
			select	retorna_medic_formatado(ds_receita_parcial_w,'@Observacao',ds_observacao_w)
			into STRICT	ds_receita_parcial_w
			;
			select	retorna_medic_formatado(ds_receita_parcial_w,'@DsViaAplicacao',Obter_Desc_via(ie_via_aplicacao_w))
			into STRICT	ds_receita_parcial_w
			;

			ds_receita_final_w	:= ds_receita_final_w || ds_receita_parcial_w || ds_enter_w;

			end;
		else
			ds_erro_p	:= WHEB_MENSAGEM_PCK.get_texto(277555) ||cd_procedimento_w|| WHEB_MENSAGEM_PCK.get_texto(277556);
		end if;

		end;
	end loop;
	close c01;

	if (nr_atendimento_p > 0) then
		nr_atendimento_w := nr_atendimento_p;
	else
		select	max(nr_atendimento)
		into STRICT	nr_atendimento_w
		from   	atendimento_paciente
		where  	cd_pessoa_fisica	= cd_pessoa_fisica_p
		and	ie_fim_conta		<> 'F'
		and	coalesce(dt_alta::text, '') = '';
	end if;

	select	max(cd_estabelecimento)
	into STRICT	cd_estabelecimento_w
	from	atendimento_paciente
	where	nr_atendimento	= nr_atendimento_w;

	ds_fonte_w := Obter_Param_Usuario(281, 5, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ds_fonte_w);
	ds_tam_fonte_w := Obter_Param_Usuario(281, 6, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ds_tam_fonte_w);

 	nr_tam_fonte_w	:= somente_numero(ds_tam_fonte_w)*2;

	ds_cabecalho_w	:= '{\rtf1\ansi\ansicpg1252\deff0\deflang1046{\fonttbl{\f0\fswiss\fcharset0 '||ds_fonte_w||';}}'||
			   '{\*\generator Msftedit 5.41.15.1507;}\viewkind4\uc1\pard\f0\fs'||nr_tam_fonte_w||' ';

	ds_rodape_w	:= '}';

    if (ds_masc_receita_html_w IS NOT NULL AND ds_masc_receita_html_w::text <> '') then
        ds_receita_w := ds_receita_final_w;
    else
        ds_receita_final_w	:= replace(ds_receita_final_w, ds_enter_padrao_w, ' \par ');
        ds_receita_w := ds_cabecalho_w||ds_receita_final_w||ds_rodape_w;
    end if;

	insert into med_receita(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_receita,
		ds_receita,
		cd_pessoa_fisica,
		cd_medico,
		ie_tipo_receita,
		nr_atendimento_hosp,
		ie_situacao)
	values (	nextval('med_receita_seq'),
		clock_timestamp(),
		nm_usuario_p,
		dt_receita_p,
		ds_receita_w,
		cd_pessoa_fisica_p,
		cd_profissional_p,
		ie_tipo_receita_p,
		nr_atendimento_w,
		'A');
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_gerar_receita_medica ( cd_pessoa_fisica_p text, cd_profissional_p text, dt_receita_p timestamp, ie_tipo_receita_p text, nr_seq_formatacao_p bigint, nm_usuario_p text, nr_atendimento_p bigint, nr_seq_interno_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

