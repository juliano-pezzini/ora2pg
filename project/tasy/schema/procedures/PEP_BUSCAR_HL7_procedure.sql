-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pep_buscar_hl7 (nr_atendimento_p bigint, nr_intervalo_p integer, cd_tipo_intervalo_p text) AS $body$
DECLARE

 ConstanteMinuto_w varchar(3) := 'MIN';
 ConstanteDia_w   varchar(3) := 'DIA';
 msg_hl7_texto_w  varchar(2000);

 msg_hl7_long_w    text;
 cd_pessoa_fisica_w  bigint;
 w_log_integr_sv_seq_w bigint;

 dt_atualizacao_w  timestamp;
 dt_inicio_busca_w timestamp;

c01 CURSOR FOR 
 SELECT c.ds_hl7, 
     c.dt_atualizacao 
 from  informacao_integracao a, 
     log_integracao    b, 
     log_integracao_hl7  c 
 where a.nr_sequencia = 152 
 and  nr_seq_evento = 55 
 and  a.nr_sequencia = b.nr_seq_informacao 
 and  b.nr_sequencia = c.nr_seq_log 
 and  c.dt_atualizacao >= dt_inicio_busca_w;

 

BEGIN 
 CALL Exec_sql_Dinamico(wheb_usuario_pck.get_nm_usuario, 'truncate table w_log_integr_sv');
  
 if (ConstanteMinuto_w = cd_tipo_intervalo_p) then 
 
  dt_inicio_busca_w := clock_timestamp() - ((1/24/60)*nr_intervalo_p);
 
 elsif (ConstanteDia_w = cd_tipo_intervalo_p) then 
 
  dt_inicio_busca_w := clock_timestamp() - nr_intervalo_p;
 
 end if;
 
 select coalesce(max(cd_pessoa_fisica), 0) 
 into STRICT  cd_pessoa_fisica_w 
 from  atendimento_paciente 
 where nr_atendimento = nr_atendimento_p;
 
 open C01;
 loop 
 fetch C01 into 
   msg_hl7_long_w, 
   dt_atualizacao_w;
 EXIT WHEN NOT FOUND; /* apply on C01 */
 
  msg_hl7_texto_w := substr(TO_CHAR(msg_hl7_long_w), 1, 2000);
 
  if (position(cd_pessoa_fisica_w in msg_hl7_texto_w) > 0) then 
     
    select nextval('w_log_integr_sv_seq') 
    into STRICT  w_log_integr_sv_seq_w 
;
     
    insert into w_log_integr_sv(nr_sequencia     , dt_atualizacao  , nm_usuario           , ds_mensagem) 
               values (w_log_integr_sv_seq_w, dt_atualizacao_w , wheb_usuario_pck.get_nm_usuario, msg_hl7_texto_w);
    commit;
 
  end if;
 
 end loop;
 close C01;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pep_buscar_hl7 (nr_atendimento_p bigint, nr_intervalo_p integer, cd_tipo_intervalo_p text) FROM PUBLIC;

