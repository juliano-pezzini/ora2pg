-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_lente_contato_consulta ( nr_seq_cons_med_p bigint, nr_seq_consulta_p bigint, nr_seq_lente_p bigint, nm_usuario_p text, ie_lado_p text default null, nr_sequencia_p INOUT bigint DEFAULT NULL) AS $body$
DECLARE

			
qt_grau_w				double precision;
qt_grau_esferico_w		double precision;
qt_grau_cilindrico_w	double precision;
qt_grau_longe_w			double precision;
qt_eixo_w				double precision;
qt_adicao_w				double precision;
qt_diametro_w			oft_consulta_lente.QT_DIAMETRO%type;
qt_curva_base_w			oft_consulta_lente.qt_curva_base%type;
qt_curva_base_um_w		oft_consulta_lente.qt_curva_base_um%type;
qt_curva_base_dois_w	oft_consulta_lente.qt_curva_base_dois%type;



BEGIN

if 	((nr_seq_cons_med_p IS NOT NULL AND nr_seq_cons_med_p::text <> '') or (nr_seq_consulta_p IS NOT NULL AND nr_seq_consulta_p::text <> '')) and (nr_seq_lente_p > 0) then
	
	if (nr_seq_consulta_p IS NOT NULL AND nr_seq_consulta_p::text <> '') then
		select  a.qt_grau,
				a.qt_grau_esferico,
				a.qt_grau_cilindrico,
				a.qt_grau_longe,
				a.qt_eixo,
				a.qt_diametro,
				a.qt_curva_base,
				a.qt_curva_base_um,
				a.qt_curva_base_dois,
				a.qt_adicao
		into STRICT		
				qt_grau_w,
				qt_grau_esferico_w,
				qt_grau_cilindrico_w,
				qt_grau_longe_w,
				qt_eixo_w,
				qt_diametro_w,
				qt_curva_base_w,		
				qt_curva_base_um_w,	
				qt_curva_base_dois_w,				
				qt_adicao_w
		from	oft_lente_contato a
		where	a.nr_sequencia = nr_seq_lente_p;
	end if;	
	
	if ((coalesce(ie_lado_p,'XPTO') = 'E') or (coalesce(ie_lado_p,'XPTO') = 'D')) then
		
		select	nextval('oft_consulta_lente_seq')
		into STRICT	nr_sequencia_p
		;
		insert into oft_consulta_lente(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_cons_med,
					nr_seq_lente,
					nr_seq_consulta,
					qt_grau,
					qt_grau_esferico,
					qt_grau_cilindrico,
					qt_grau_longe,
					qt_eixo,
					qt_adicao,
					dt_registro,
					qt_diametro,
					qt_curva_base,		
					qt_curva_base_um,	
					qt_curva_base_dois,
					ie_lado)
		values (
					nr_sequencia_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_cons_med_p,
					nr_seq_lente_p,
					nr_seq_consulta_p,
					qt_grau_w,
					qt_grau_esferico_w,
					qt_grau_cilindrico_w,
					qt_grau_longe_w,
					qt_eixo_w,
					qt_adicao_w,
					clock_timestamp(),
					qt_diametro_w,
					qt_curva_base_w,		
					qt_curva_base_um_w,	
					qt_curva_base_dois_w,
					'D');
		commit;	

		
		select	nextval('oft_consulta_lente_seq')
		into STRICT	nr_sequencia_p
		;
					
		insert into oft_consulta_lente(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_cons_med,
					nr_seq_lente,
					nr_seq_consulta,
					qt_grau,
					qt_grau_esferico,
					qt_grau_cilindrico,
					qt_grau_longe,
					qt_eixo,
					qt_adicao,
					dt_registro,
					qt_diametro,
					qt_curva_base,		
					qt_curva_base_um,	
					qt_curva_base_dois,
					ie_lado)
		values (
					nr_sequencia_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_cons_med_p,
					nr_seq_lente_p,
					nr_seq_consulta_p,
					qt_grau_w,
					qt_grau_esferico_w,
					qt_grau_cilindrico_w,
					qt_grau_longe_w,
					qt_eixo_w,
					qt_adicao_w,
					clock_timestamp(),
					qt_diametro_w,
					qt_curva_base_w,		
					qt_curva_base_um_w,	
					qt_curva_base_dois_w,
					'E');
		commit;
	else
		
		select	nextval('oft_consulta_lente_seq')
		into STRICT	nr_sequencia_p
		;
		
		insert into oft_consulta_lente(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_cons_med,
					nr_seq_lente,
					nr_seq_consulta,
					qt_grau,
					qt_grau_esferico,
					qt_grau_cilindrico,
					qt_grau_longe,
					qt_eixo,
					qt_adicao,
					dt_registro)
		values (
					nr_sequencia_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_cons_med_p,
					nr_seq_lente_p,
					nr_seq_consulta_p,
					qt_grau_w,
					qt_grau_esferico_w,
					qt_grau_cilindrico_w,
					qt_grau_longe_w,
					qt_eixo_w,
					qt_adicao_w,
					clock_timestamp());					
	
		commit;
	end if;	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_lente_contato_consulta ( nr_seq_cons_med_p bigint, nr_seq_consulta_p bigint, nr_seq_lente_p bigint, nm_usuario_p text, ie_lado_p text default null, nr_sequencia_p INOUT bigint DEFAULT NULL) FROM PUBLIC;

