-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_ajustar_base ( nm_usuario_p text) AS $body$
DECLARE


qt_registro_w				bigint;
qt_estab_w				bigint;
ds_comando_w				varchar(255);
nr_max_sequencia_w			bigint;
nr_next_sequence_w			bigint;
nr_decimais_w				integer;
cd_empresa_w				smallint;
dt_versao_atual_cliente_w 			timestamp;
ds_status_proc_w			varchar(7);
nm_tablespace_w				varchar(40);
Nr_seq_log_w				bigint;

c01 CURSOR FOR
	SELECT	cd_empresa
	from	empresa;


BEGIN
CALL abortar_se_base_wheb();

dt_versao_atual_cliente_w := coalesce(TO_DATE(TO_CHAR(obter_data_geracao_versao-1,'dd/mm/yyyy') ||' 23:59:59','dd/mm/yyyy hh24:mi:ss'),clock_timestamp() - interval '90 days');

begin
	select  max(nr_sequencia)
	into STRICT	Nr_seq_log_w
	from 	log_atualizacao;
exception
	when others then
		null;
end;

/* Piccini - 10/07/2007 (Vai ter que existir sempre para ajuste dos parametros e dominios */

begin
	CALL Tasy_Alterar_Dominio();
exception
	when others then
		CALL Gravar_Log_Atualizacao_Erro(Nr_seq_log_w,'Tasy_Alterar_Dominio',substr(SQLERRM(SQLSTATE),1,1800), 'Tasy');
end;

/*Coelho 07/03/2008 - Criar ou remover jobs da base dos clientes*/

begin
	CALL tasy_criar_alterar_jobs(Nr_seq_log_w);
exception
	when others then
		CALL Gravar_Log_Atualizacao_Erro(Nr_seq_log_w,'tasy_criar_alterar_jobs',substr(SQLERRM(SQLSTATE),1,1800), 'Tasy');
end;	

/*Coelho 17/06/2008 - Criar trigger de log de update nos clientes*/

begin
	CALL TASY_CRIAR_TRIGGER_LOG_UPDATE();
exception
	when others then
		qt_registro_w:= qt_registro_w;
end;

/*Coelho - 30/10/2007 Ajusta o CACHE das sequences*/

begin
	CALL TASY_AJUSTAR_SEQUENCE(Nr_seq_log_w);
exception
	when others then
		CALL Gravar_Log_Atualizacao_Erro(Nr_seq_log_w,'TASY_AJUSTAR_SEQUENCE',substr(SQLERRM(SQLSTATE),1,1800), 'Tasy');
end;

/*Coelho 12/05/2007 Ajusta a tablespace das tabelas temporarias*/

begin
	CALL TASY_AJUSTAR_TABELA_TEMP();
exception
	when others then
		CALL Gravar_Log_Atualizacao_Erro(Nr_seq_log_w,'TASY_AJUSTAR_TABELA_TEMP',substr(SQLERRM(SQLSTATE),1,1800), 'Tasy');
end;

/* Piccini - 14/06/2010 */

begin
	CALL exec_sql_dinamico('','begin tasy_ajustar_base_tec('|| chr(39) || nm_usuario_p || chr(39) || ', ' || Nr_seq_log_w || ' ); end;');
exception
	when others then
		CALL Gravar_Log_Atualizacao_Erro(Nr_seq_log_w,'tasy_ajustar_base_tec',substr(SQLERRM(SQLSTATE),1,1800), 'Tasy');
end;
begin
	CALL exec_sql_dinamico('','begin tasy_ajustar_base_adm('|| chr(39) || nm_usuario_p || chr(39) || ', ' || Nr_seq_log_w || ' ); end;');
exception
	when others then
		CALL Gravar_Log_Atualizacao_Erro(Nr_seq_log_w,'tasy_ajustar_base_adm',substr(SQLERRM(SQLSTATE),1,1800), 'Tasy');
end;
begin
	CALL exec_sql_dinamico('','begin tasy_ajustar_base_assis('|| chr(39) || nm_usuario_p || chr(39) || ', ' || Nr_seq_log_w || ' ); end;');
exception
	when others then
		CALL Gravar_Log_Atualizacao_Erro(Nr_seq_log_w,'tasy_ajustar_base_assis',substr(SQLERRM(SQLSTATE),1,1800), 'Tasy');
end;
begin	
	CALL exec_sql_dinamico('','begin tasy_ajustar_base_pls('|| chr(39) || nm_usuario_p || chr(39) || ', ' || Nr_seq_log_w || ' ); end;');
exception
	when others then
		CALL Gravar_Log_Atualizacao_Erro(Nr_seq_log_w,'tasy_ajustar_base_pls',substr(SQLERRM(SQLSTATE),1,1800), 'Tasy');
end;
begin
	CALL exec_sql_dinamico('','begin tasy_ajustar_base_mmed('|| chr(39) || nm_usuario_p || chr(39) || '); end;');
exception
	when others then
		CALL Gravar_Log_Atualizacao_Erro(Nr_seq_log_w,'tasy_ajustar_base_mmed',substr(SQLERRM(SQLSTATE),1,1800), 'Tasy');
end;

begin
	CALL exec_sql_dinamico('','TASY_AJUSTAR_BASE_VEV_HTML5('|| chr(39) || nm_usuario_p || chr(39) || '); end;');
exception
	when others then
		CALL Gravar_Log_Atualizacao_Erro(Nr_seq_log_w,'TASY_AJUSTAR_BASE_VEV_HTML5',substr(SQLERRM(SQLSTATE),1,1800), 'Tasy');
end;

begin
if (dt_versao_atual_cliente_w < to_date('29/06/2015','dd/mm/yyyy')) then
	SELECT	COUNT(*)
	INTO STRICT	qt_registro_w
	FROM	user_constraints
	WHERE	constraint_name = 'BACKSBIS_TABSIST_FK';

	if (qt_registro_w > 0) then		
		CALL Exec_Sql_Dinamico('oicorrea', 'Alter Table backup_sbis drop constraint BACKSBIS_TABSIST_FK');
	end	if;

	select	count(*)
	into STRICT	qt_registro_w
	from	integridade_atributo
	where	nm_tabela	= 'BACKUP_SBIS'
	and		nm_integridade_referencial	= 'BACKSBIS_TABSIST_FK';

	if (qt_registro_w	> 0) then
		CALL exec_sql_dinamico('oicorrea', ' delete from integridade_atributo where nm_integridade_referencial = ' || chr(39) || 'BACKSBIS_TABSIST_FK' || chr(39) || ' and nm_tabela = ' || chr(39) || 'BACKUP_SBIS' || chr(39));
		commit;
	end if;
	
	select	count(*)
	into STRICT	qt_registro_w
	from	integridade_referencial
	where	nm_tabela	= 'BACKUP_SBIS'
	and		nm_integridade_referencial	= 'BACKSBIS_TABSIST_FK';	
	
	if (qt_registro_w	> 0) then
		CALL exec_sql_dinamico('oicorrea', ' delete from integridade_referencial where nm_integridade_referencial = ' || chr(39) || 'BACKSBIS_TABSIST_FK' || chr(39) || ' and nm_tabela = ' || chr(39) || 'BACKUP_SBIS' || chr(39));
		commit;
	end if;
	
	select	count(*)
	into STRICT	qt_registro_w
	from	indice_atributo
	where	nm_tabela	= 'BACKUP_SBIS'
	and		nm_indice	= 'BACKSBIS_TABSIST_FK_I';

	if (qt_registro_w	> 0) then
		CALL exec_sql_dinamico('oicorrea', ' delete from INDICE_ATRIBUTO where nm_indice = ' || chr(39) || 'BACKSBIS_TABSIST_FK_I' || chr(39) || ' and nm_tabela = ' || chr(39) || 'BACKUP_SBIS' || chr(39));
		commit;
	end if;

	select	count(*)
	into STRICT	qt_registro_w
	from	indice
	where	nm_tabela	= 'BACKUP_SBIS'
	and		nm_indice	= 'BACKSBIS_TABSIST_FK_I';

	if (qt_registro_w	> 0) then
		CALL exec_sql_dinamico('oicorrea', ' delete from INDICE where nm_indice = ' || chr(39) || 'BACKSBIS_TABSIST_FK_I' || chr(39) || ' and nm_tabela = ' || chr(39) || 'BACKUP_SBIS' || chr(39));
		commit;
	end if;
end if;
exception
when others then
	CALL gravar_log_atualizacao_erro(Nr_seq_log_w,'Tasy_Ajustar_Base',substr(sqlerrm(SQLSTATE), 1, 1800), 'Tasy');
end;

begin
if (dt_versao_atual_cliente_w > to_date('12/08/2015','dd/mm/yyyy')) then
	SELECT	count(*)
	INTO STRICT	qt_registro_w
	FROM	user_tables 
	where	upper(table_name) = 'MAN_OS_CTRL_BUILD_SOL';
		
	if (qt_registro_w > 0) then		
		CALL Exec_Sql_Dinamico('jpweiss', 'alter table  man_os_ctrl_build_sol modify IE_STATUS_SOLICIT VARCHAR2(1)');
	end	if;
end if;
exception
when others then
	CALL gravar_log_atualizacao_erro(Nr_seq_log_w,'Tasy_Ajustar_Base',substr(sqlerrm(SQLSTATE), 1, 1800), 'Tasy');
end;

begin
	CALL tasy_ajustar_funcao();
exception
when others then
	CALL gravar_log_atualizacao_erro(Nr_seq_log_w,'tasy_ajustar_funcao',substr(sqlerrm(SQLSTATE), 1, 1800), 'Tasy');
end;

/* Almir em 05/10/2011  - Manter esta linha no final deste arquivo */

CALL Tasy_ativar_Integridade('S');

if (dt_versao_atual_cliente_w < to_date('16/09/2016','dd/mm/yyyy')) then
	delete from integridade_atributo where nm_integridade_referencial in ('COHTML_PESFISI_FK_I',
	'COHTML_FUNCAO_FK',
	'COHTML_PESFISI_FK',
	'COHTML_PESFISI_FK1',
	'COHTML_PESFISI_FK2',
	'COHTML_PK',
	'COHTML_PESFISI_FK2_I',
	'COHTML_PESFISI_FK1_I',
	'COHTML_PK',
	'COHTML_FUNCAO_FK_I');

	delete from integridade_referencial where nm_integridade_referencial in ('COHTML_PESFISI_FK_I',
	'COHTML_FUNCAO_FK',
	'COHTML_PESFISI_FK',
	'COHTML_PESFISI_FK1',
	'COHTML_PESFISI_FK2',
	'COHTML_PK',
	'COHTML_PESFISI_FK2_I',
	'COHTML_PESFISI_FK1_I',
	'COHTML_PK',
	'COHTML_FUNCAO_FK_I');

	delete from indice_atributo where nm_indice in ('COHTML_PESFISI_FK_I',
	'COHTML_FUNCAO_FK',
	'COHTML_PESFISI_FK',
	'COHTML_PESFISI_FK1',
	'COHTML_PESFISI_FK2',
	'COHTML_PK',
	'COHTML_PESFISI_FK2_I',
	'COHTML_PESFISI_FK1_I',
	'COHTML_PK',
	'COHTML_FUNCAO_FK_I');

	delete from indice where nm_indice in ('COHTML_PESFISI_FK_I',
	'COHTML_FUNCAO_FK',
	'COHTML_PESFISI_FK',
	'COHTML_PESFISI_FK1',
	'COHTML_PESFISI_FK2',
	'COHTML_PK',
	'COHTML_PESFISI_FK2_I',
	'COHTML_PESFISI_FK1_I',
	'COHTML_PK',
	'COHTML_FUNCAO_FK_I');

	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_ajustar_base ( nm_usuario_p text) FROM PUBLIC;

