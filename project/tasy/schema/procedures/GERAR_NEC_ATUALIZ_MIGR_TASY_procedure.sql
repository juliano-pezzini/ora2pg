-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_nec_atualiz_migr_tasy ( cd_funcao_p bigint, nr_seq_os_p bigint, ds_documentacao_p text, nm_usuario_p text, ie_linguagem_p text default null) AS $body$
DECLARE


nr_seq_nec_atualiz_migr_w	bigint;
cd_funcao_w					integer;
ie_tipo_atualizacao_w		varchar(10);
sql_query_w					varchar(4000);


BEGIN

	if (cd_funcao_p IS NOT NULL AND cd_funcao_p::text <> '') and (nr_seq_os_p IS NOT NULL AND nr_seq_os_p::text <> '') and (ds_documentacao_p IS NOT NULL AND ds_documentacao_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
		begin
		if (cd_funcao_p = 10030) then
			begin
			cd_funcao_w := -1003;
			end;
		else
			begin
			cd_funcao_w := cd_funcao_p;
			end;
		end if;

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_nec_atualiz_migr_w
		from	w_migracao_ordem_servico
		where	nr_seq_os = nr_seq_os_p
		and	trunc(dt_atualizacao_nrec) = trunc(clock_timestamp())
		and	coalesce(nr_seq_os_migracao::text, '') = '';

		if (ie_linguagem_p	= 'H') then

			sql_query_w :=
				'select	decode(nvl(max(IE_STATUS_HTML),''I''),''W'',''C'',''R'')
				from	funcao@orcl
				where	cd_funcao = :cd_funcao';

			ie_tipo_atualizacao_w := obter_valor_dinamico_char_bv(sql_query_w, 'cd_funcao=' || cd_funcao_w, ie_tipo_atualizacao_w);

		else
			select	CASE WHEN obter_situacao_funcao_migracao(cd_funcao_w)='W' THEN 'C'  ELSE 'R' END
			into STRICT	ie_tipo_atualizacao_w
			;
		end if;


		if (nr_seq_nec_atualiz_migr_w = 0) then
			begin
			select	nextval('w_migracao_ordem_servico_seq')
			into STRICT	nr_seq_nec_atualiz_migr_w
			;


			insert into w_migracao_ordem_servico(
				nr_sequencia,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				dt_atualizacao,
				nm_usuario,
				cd_funcao,
				nr_seq_os,
				ds_documentacao,
				ie_tipo_atualizacao)
			values (
				nr_seq_nec_atualiz_migr_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				cd_funcao_w,
				nr_seq_os_p,
				ds_documentacao_p,
				coalesce(ie_tipo_atualizacao_w,CASE WHEN obter_situacao_funcao_migracao(cd_funcao_w)='W' THEN 'C'  ELSE 'R' END ));
			end;
		else
			begin
			update	w_migracao_ordem_servico
			set	ds_documentacao = ds_documentacao_p,
				ie_tipo_atualizacao = coalesce(ie_tipo_atualizacao_w,CASE WHEN obter_situacao_funcao_migracao(cd_funcao_w)='W' THEN 'C'  ELSE 'R' END ),
				dt_atualizacao = clock_timestamp(),
				nm_usuario = nm_usuario_p
			where	nr_sequencia = nr_seq_nec_atualiz_migr_w;
			end;
		end if;
		end;
	end if;

	commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_nec_atualiz_migr_tasy ( cd_funcao_p bigint, nr_seq_os_p bigint, ds_documentacao_p text, nm_usuario_p text, ie_linguagem_p text default null) FROM PUBLIC;

