-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE executar_acao_template ( NR_SEQ_TIPO_CONS_PEPA_P ATEND_CONSULTA_PEPA.NR_SEQUENCIA%TYPE, NR_SEQ_TIPO_TEMP_P EHR_TIPO_REG_ITEM.NR_SEQ_TEMPLATE%TYPE, IE_ACAO_P text, NM_USUARIO_P USUARIO.NM_USUARIO%TYPE, DS_JUSTIFICATIVA_P EHR_REGISTRO.DS_JUSTIFICATIVA%TYPE default null, NR_SEQUENCIA_EHR_P INOUT EHR_REGISTRO.NR_SEQUENCIA%TYPE DEFAULT NULL, NR_SEQUENCIA_REG_TEMPL_P EHR_REG_TEMPLATE.NR_SEQUENCIA%TYPE default 0) AS $body$
DECLARE


NR_SEQ_REG_TEMP_W	EHR_REGISTRO.NR_SEQUENCIA%TYPE;
NR_SEQ_REG_TEMPLATE_W	EHR_REG_TEMPLATE.NR_SEQ_TEMPLATE%TYPE;
NR_SEQUENCIA_REG_TEMPL_W EHR_REG_TEMPLATE.NR_SEQUENCIA%TYPE;

BEGIN
	
	if (coalesce(NR_SEQUENCIA_REG_TEMPL_P::text, '') = '' or NR_SEQUENCIA_REG_TEMPL_P = 0) then
			SELECT * FROM INSERIR_TEMPLATE_PEPA(NR_SEQ_TIPO_CONS_PEPA_P, NR_SEQ_TIPO_TEMP_P, WHEB_USUARIO_PCK.get_nm_usuario, 'SV', NR_SEQUENCIA_REG_TEMPL_W, NR_SEQ_REG_TEMPLATE_W) INTO STRICT NR_SEQUENCIA_REG_TEMPL_W, NR_SEQ_REG_TEMPLATE_W;
		else
			NR_SEQUENCIA_REG_TEMPL_W := NR_SEQUENCIA_REG_TEMPL_P;
		end if;
	select coalesce(max(nr_sequencia), 0)
	into STRICT NR_SEQ_REG_TEMP_W
	from (	SELECT a.nr_sequencia
		from EHR_REGISTRO a, EHR_REG_TEMPLATE b
		where b.nr_sequencia = NR_SEQUENCIA_REG_TEMPL_W
		and a.nr_sequencia = b.nr_seq_reg
		and a.NR_SEQ_ATEND_CONS_PEPA = NR_SEQ_TIPO_CONS_PEPA_P
		and a.NR_SEQ_TEMPL =  NR_SEQ_TIPO_TEMP_P
		order by a.dt_atualizacao desc) alias2 LIMIT 1;
	
	if (NR_SEQ_REG_TEMP_W IS NOT NULL AND NR_SEQ_REG_TEMP_W::text <> '') then
		if (IE_ACAO_P = 'L') then
			CALL LIBERAR_INFORMACAO('EHR_REGISTRO', 'NR_SEQUENCIA', NR_SEQ_REG_TEMP_W, NM_USUARIO_P);
		elsif (IE_ACAO_P = 'I') then
			CALL INATIVAR_INFORMACAO('EHR_REGISTRO', 'NR_SEQUENCIA', NR_SEQ_REG_TEMP_W, DS_JUSTIFICATIVA_P, NM_USUARIO_P);
		elsif (IE_ACAO_P = 'A') then
			SELECT * FROM INSERIR_TEMPLATE_PEPA(NR_SEQ_TIPO_CONS_PEPA_P, NR_SEQ_TIPO_TEMP_P, NM_USUARIO_P, 'I', NR_SEQUENCIA_EHR_P, NR_SEQ_REG_TEMPLATE_W) INTO STRICT NR_SEQUENCIA_EHR_P, NR_SEQ_REG_TEMPLATE_W;
		elsif (IE_ACAO_P = 'E') then
			delete from EHR_REG_TEMPLATE where nr_sequencia = NR_SEQUENCIA_REG_TEMPL_W;
			delete from EHR_REGISTRO where nr_sequencia = NR_SEQ_REG_TEMP_W;
			commit;
		end if;
	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE executar_acao_template ( NR_SEQ_TIPO_CONS_PEPA_P ATEND_CONSULTA_PEPA.NR_SEQUENCIA%TYPE, NR_SEQ_TIPO_TEMP_P EHR_TIPO_REG_ITEM.NR_SEQ_TEMPLATE%TYPE, IE_ACAO_P text, NM_USUARIO_P USUARIO.NM_USUARIO%TYPE, DS_JUSTIFICATIVA_P EHR_REGISTRO.DS_JUSTIFICATIVA%TYPE default null, NR_SEQUENCIA_EHR_P INOUT EHR_REGISTRO.NR_SEQUENCIA%TYPE DEFAULT NULL, NR_SEQUENCIA_REG_TEMPL_P EHR_REG_TEMPLATE.NR_SEQUENCIA%TYPE default 0) FROM PUBLIC;

