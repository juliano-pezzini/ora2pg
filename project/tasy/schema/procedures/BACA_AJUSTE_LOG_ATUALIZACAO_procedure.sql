-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_ajuste_log_atualizacao () AS $body$
DECLARE


nr_seq_atualizacao_w 	bigint;
dt_min_atualizacao_w	timestamp;
nr_sequencia_w			bigint;

C01 CURSOR FOR
	SELECT DISTINCT a.nr_seq_atualizacao
	FROM   log_atualizacao a
	WHERE  NOT EXISTS (SELECT 1
	   	   		   FROM	  log_atualizacao b
				   WHERE  a.nr_seq_atualizacao = b.nr_seq_atualizacao
				   AND	  ie_evento = '010')
	ORDER BY nr_Seq_atualizacao;


BEGIN

open C01;
loop
fetch C01 into
	nr_seq_atualizacao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
		select 	min(dt_evento)
		into STRICT	dt_min_atualizacao_w
		from	log_atualizacao
		where	nr_seq_atualizacao = nr_seq_atualizacao_w;

		select 	nextval('log_atualizacao_seq')
		into STRICT	nr_sequencia_w
		;

		insert into Log_Atualizacao(
			nr_sequencia,
			nr_seq_atualizacao,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ie_evento,
			dt_evento,
			dt_fim_evento)
		values (
			nr_sequencia_w,
			nr_seq_atualizacao_w,
			dt_min_atualizacao_w,
			'Tasy',
			dt_min_atualizacao_w,
			'Tasy',
			'010',
			dt_min_atualizacao_w - 10/86400,
			dt_min_atualizacao_w - 7/86400);

		select 	nextval('log_atualizacao_seq')
		into STRICT	nr_sequencia_w
		;

		insert into Log_Atualizacao(
			nr_sequencia,
			nr_seq_atualizacao,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ie_evento,
			dt_evento,
			dt_fim_evento)
		values (
			nr_sequencia_w,
			nr_seq_atualizacao_w,
			dt_min_atualizacao_w,
			'Tasy',
			dt_min_atualizacao_w,
			'Tasy',
			'020',
			dt_min_atualizacao_w -5/86400,
			dt_min_atualizacao_w -1/86400);

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_ajuste_log_atualizacao () FROM PUBLIC;

