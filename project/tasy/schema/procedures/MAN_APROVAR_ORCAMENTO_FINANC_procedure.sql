-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_aprovar_orcamento_financ ( nr_seq_orcamento_p bigint, nm_usuario_p text) AS $body$
DECLARE


/*Procedure criada para utilizacao no processo de aprovacao dos orcamentos na base corp
Funcao aprovacoes pendentes
Pasta "Customizacao com orcamento"
*/
qt_existe_w				bigint;
nr_seq_ordem_phi_w			man_ordem_servico.nr_sequencia%type;
nr_seq_ordem_orig_w			man_ordem_servico.nr_seq_origem%type;
nr_seq_cliente_w			man_ordem_servico.nr_seq_cliente%type;
ds_macro_comunicado_w			varchar(4000);

/*Gestao financeira Philips*/

sg_estado_cliente_w		pessoa_juridica.sg_estado%type;
nr_seq_regra_valor_w		bigint;
vl_item_orcamento_w		double precision;
ie_produto_w			com_cliente.ie_produto%type;


BEGIN
if (nr_seq_orcamento_p > 0) then
	begin
	select	b.nr_seq_ordem,
		a.nr_seq_origem,
		a.nr_seq_cliente
	into STRICT	nr_seq_ordem_phi_w,
		nr_seq_ordem_orig_w,
		nr_seq_cliente_w
	from	man_ordem_servico a,
		man_ordem_servico_orc b
	where	b.nr_seq_ordem		= a.nr_sequencia
	and	b.nr_sequencia		= nr_seq_orcamento_p;

	update	man_ordem_servico_orc
	set	dt_geracao_cobranca	= clock_timestamp(),
		nm_usuario_cobranca	= nm_usuario_p
	where	nr_sequencia		= nr_seq_orcamento_p;

	if (coalesce(nr_seq_cliente_w,0) > 0) then
		select	a.sg_estado,
			b.ie_produto
		into STRICT	sg_estado_cliente_w,
			ie_produto_w
		from	pessoa_juridica a,
			com_cliente b
		where	a.cd_cgc 	= b.cd_cnpj
		and	b.nr_sequencia	= nr_seq_cliente_w;

		select	count(1)
		into STRICT	qt_existe_w
		from	com_cliente_regra_valor
		where	nr_seq_ordem_serv 	= nr_seq_ordem_phi_w
		and	nr_seq_cliente 		= nr_seq_cliente_w;

		if (qt_existe_w = 0) then
			begin
			select	nextval('com_cliente_regra_valor_seq')
			into STRICT	nr_seq_regra_valor_w
			;

			insert into com_cliente_regra_valor(
						nr_sequencia,
						cd_estabelecimento,
						nr_seq_cliente,
						dt_atualizacao,
						nm_usuario,
						dt_inicio_vigencia,
						dt_fim_vigencia,
						ds_observacao,
						cd_operacao_nf,
						cd_condicao_pagamento,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						ie_atualizar,
						ie_situacao,
						cd_natureza_operacao,
						cd_cnpj_pessoa_nf,
						nr_seq_cliente_nf,
						nr_seq_ordem_serv)
					values (	nr_seq_regra_valor_w,
						CASE WHEN ie_produto_w='M' THEN  22  ELSE 1 END ,
						nr_seq_cliente_w,
						clock_timestamp(),
						nm_usuario_p,
						trunc(clock_timestamp(),'mm'),
						fim_mes(clock_timestamp()),
						'Regra gerada a partir do encerramento da OS ' || nr_seq_ordem_phi_w,
						24,
						15, --15 dias
						clock_timestamp(),
						nm_usuario_p,
						'N',
						'A',
						CASE WHEN sg_estado_cliente_w='SC' THEN  5949  ELSE 6949 END ,
						'',
						'',
						nr_seq_ordem_phi_w);

			select	coalesce(sum(coalesce(vl_item,0)),0)
			into STRICT	vl_item_orcamento_w
			from	man_ordem_servico_orc b,
				man_ord_serv_orc_item a
			where	b.nr_sequencia = a.nr_seq_orc_ordem
			and	(b.dt_aprovacao IS NOT NULL AND b.dt_aprovacao::text <> '')
			and	coalesce(b.dt_reprovacao::text, '') = ''
			and	b.nr_seq_ordem = nr_seq_ordem_phi_w;

			insert into com_cli_regra_valor_item(
					nr_sequencia,
					nr_seq_regra,
					dt_atualizacao,
					nm_usuario,
					ds_titulo,
					vl_cobrar,
					cd_procedimento,
					ie_origem_proced,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					cd_conta_contabil,
					cd_centro_custo,
					ie_rat,
					ds_compl_nf,
					ie_situacao,
					ds_observacao)
				values (	nextval('com_cli_regra_valor_item_seq'),
					nr_seq_regra_valor_w,
					clock_timestamp(),
					nm_usuario_p,
					substr(obter_desc_exp_idioma(1077099, 1, 'NR_OS_PHI=' || nr_seq_ordem_phi_w) ||
						CASE WHEN coalesce(nr_seq_ordem_orig_w::text, '') = '' THEN  null  ELSE ', ' ||	obter_desc_exp_idioma(1077101, 1, 'NR_OS_ORIG=' || nr_seq_ordem_orig_w) END , 1, 80),
					vl_item_orcamento_w,
					CASE WHEN ie_produto_w='I' THEN 21000680 WHEN ie_produto_w='MD' THEN 59000500 WHEN ie_produto_w='M' THEN 79000700 WHEN ie_produto_w='O' THEN 99000006  ELSE 69000700 END ,
					4,
					clock_timestamp(),
					nm_usuario_p,
					'2020',
					CASE WHEN ie_produto_w='P' THEN 87 WHEN ie_produto_w='O' THEN 88 WHEN ie_produto_w='I' THEN 242 WHEN ie_produto_w='MDC' THEN 97 WHEN ie_produto_w='M' THEN 148 WHEN ie_produto_w='MD' THEN 89 END ,
					'N',
					substr(obter_desc_exp_idioma(1077189, 1, 'NR_OS_PHI=' || nr_seq_ordem_phi_w) ||
						CASE WHEN coalesce(nr_seq_ordem_orig_w::text, '') = '' THEN  null  ELSE ', ' ||	obter_desc_exp_idioma(1077101, 1, 'NR_OS_ORIG=' || nr_seq_ordem_orig_w) END , 1, 80),
					'A',
					'');

			ds_macro_comunicado_w := substr('NR_SEQ_REGRA_VALOR=' || nr_seq_regra_valor_w ||
						';NR_SEQ_CLIENTE=' || nr_seq_cliente_w || ' (' || substr(obter_dados_com_cliente(nr_seq_cliente_w,'D'),1,255) || ')' ||
						';NR_SEQ_OS=' || nr_seq_ordem_phi_w, 1, 4000);

			CALL gerar_comunic_padrao(	clock_timestamp(),
						substr(obter_desc_exp_idioma(1077191, 1, 'NR_OS_PHI=' || nr_seq_ordem_phi_w), 1, 255),
						substr(obter_desc_exp_idioma(1077193, 1, ds_macro_comunicado_w), 1, 4000),
						nm_usuario_p,
						'N',
						'hermes, rcconceicao, jksilva,',
						'N',
						'',
						'',
						'',
						'',
						clock_timestamp(),
						'',
						'');
			end;
		end if;
	end if;
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_aprovar_orcamento_financ ( nr_seq_orcamento_p bigint, nm_usuario_p text) FROM PUBLIC;

