-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mprev_efetuar_transferencia (nr_sequencia_p bigint, cd_profissional_destino_p text, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_ww            	bigint;
nr_seq_programa_partic_w	mprev_programa_partic.nr_sequencia%type;
nr_seq_prog_prof_orig_w		mprev_prog_partic_prof.nr_sequencia%type;
nr_seq_cic_item_resp_w     	mprev_part_cic_item_resp.nr_sequencia%type;
nr_sequencia_w             	mprev_prog_partic_prof.nr_sequencia%type;


c01 CURSOR FOR
        SELECT  nr_sequencia,
                coalesce(nr_seq_prog_prof_orig,'')
        from    mprev_transf_resp_programa
        where   nr_seq_transf_resp = nr_sequencia_p;

c02 CURSOR FOR
        SELECT  nr_sequencia,
                coalesce(nr_seq_cic_item_resp,'')
        from    mprev_transf_part_cic_item
        where   nr_seq_transf_resp = nr_sequencia_p;


BEGIN

open c01;
loop
fetch c01 into nr_sequencia_ww,
                nr_seq_prog_prof_orig_w;
  EXIT WHEN NOT FOUND; /* apply on c01 */
    begin

        update  mprev_prog_partic_prof
        set     dt_fim_acomp = clock_timestamp()
        where   nr_sequencia = nr_seq_prog_prof_orig_w;

        select coalesce(nr_seq_programa_partic,'')
        into STRICT   nr_seq_programa_partic_w
        from   mprev_prog_partic_prof
        where  nr_sequencia = nr_seq_prog_prof_orig_w;

        select      nextval('mprev_prog_partic_prof_seq')
        into STRICT        nr_sequencia_w
;

        insert into mprev_prog_partic_prof(nr_sequencia, dt_inicio_acomp, cd_profissional,
                                           nr_seq_programa_partic, nm_usuario, dt_atualizacao,
                                        dt_atualizacao_nrec, nm_usuario_nrec)
        values (nr_sequencia_w, clock_timestamp(), cd_profissional_destino_p,
                        nr_seq_programa_partic_w, nm_usuario_p, clock_timestamp(),
                        clock_timestamp(), nm_usuario_p);

        update  mprev_transf_resp_programa
        set     nr_seq_prog_prof_dest = nr_sequencia_w,
                ie_status             = 'T'
        where   nr_seq_prog_prof_orig = nr_sequencia_ww;

    end;
end loop;
close c01;

open c02;
loop
fetch c02 into nr_sequencia_ww,
                nr_seq_cic_item_resp_w;
  EXIT WHEN NOT FOUND; /* apply on c02 */
    begin

        update  mprev_part_cic_item_resp
        set     cd_profissional = cd_profissional_destino_p
        where   nr_sequencia = nr_seq_cic_item_resp_w;

        update  mprev_transf_part_cic_item
        set     ie_status = 'T'
        where   nr_seq_cic_item_resp = nr_sequencia_ww;

    end;
end loop;
close c02;

update  mprev_transf_resp
set     ie_status = 'T',
        dt_confirmacao = clock_timestamp()
where   nr_sequencia = nr_sequencia_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mprev_efetuar_transferencia (nr_sequencia_p bigint, cd_profissional_destino_p text, nm_usuario_p text) FROM PUBLIC;

