-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_lib_material_paciente ( nr_prescricao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_pessoa_fisica_w	varchar(10);
cd_material_w		integer;
nr_prescricao_w		bigint;
nr_seq_material_w	integer;
nr_sequencia_w		bigint;
nr_atendimento_w	bigint;

ie_objetivo_uso_w		varchar(1);
ds_justificativa_w		varchar(4000);
qt_dias_tratamento_w	integer;
qt_dose_diaria_w		double precision;


C01 CURSOR FOR
	SELECT	cd_material,
			nr_prescricao,
			nr_sequencia,
			ie_objetivo,
			qt_dias_tratamento,
			qt_dose_diaria
	from	prescr_material
	where	substr(obter_se_material_padronizado(cd_estabelecimento_p,cd_material),1,2) = 'N'
	and		nr_prescricao = nr_prescricao_p
	and		coalesce(nr_seq_lib_mat_pac::text, '') = ''
	and 	(qt_dias_tratamento IS NOT NULL AND qt_dias_tratamento::text <> '');


BEGIN

select 	max(cd_pessoa_fisica),
		max(nr_atendimento)
into STRICT	cd_pessoa_fisica_w,
		nr_atendimento_w
from 	prescr_medica
where	nr_prescricao = nr_prescricao_p;

open c01;
	loop
	fetch c01 into
			cd_material_w,
			nr_prescricao_w,
			nr_seq_material_w,
			ds_justificativa_w,
			qt_dias_tratamento_w,
			qt_dose_diaria_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		select	nextval('lib_material_paciente_seq')
		into STRICT	nr_sequencia_w
		;

		insert	into lib_material_paciente(nr_sequencia,
			cd_pessoa_fisica,
			cd_material,
			dt_atualizacao,
			nm_usuario,
			dt_inicio_validade,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_prescricao,
			nr_seq_material,
			nr_atendimento,
			ds_justificativa,
			qt_dias_tratamento,
			qt_dose_diaria)
		values (nr_sequencia_w,
			cd_pessoa_fisica_w,
			cd_material_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			clock_timestamp(),
			nm_usuario_p,
			nr_prescricao_w,
			nr_seq_material_w,
			nr_atendimento_w,
			ds_justificativa_w,
			qt_dias_tratamento_w,
			qt_dose_diaria_w);

		update	prescr_material
		set	nr_seq_lib_mat_pac	= nr_sequencia_w
		where	nr_prescricao		= nr_prescricao_w
		and	nr_sequencia		= nr_seq_material_w;

		end;
	end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_lib_material_paciente ( nr_prescricao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

