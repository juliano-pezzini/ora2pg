-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_regra_qtde_proc_exec ( nr_atendimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, qt_procedimento_p bigint, dt_procedimento_p timestamp, cd_medico_executor_p text, ie_acao_excesso_p INOUT text, qt_excedida_p INOUT text, ds_erro_p INOUT text, cd_convenio_excesso_p INOUT bigint, cd_categoria_excesso_p INOUT text, nr_seq_proc_interno_p bigint, cd_categoria_p text, cd_plano_p text, nr_interno_conta_p bigint, nr_cirurgia_p bigint, nr_seq_exame_p bigint, cd_setor_atendimento_p bigint, nr_seq_proc_p bigint default null) AS $body$
DECLARE


cd_convenio_w			integer;
ie_tipo_atendimento_w	smallint;
qt_permitida_w			double precision;
ie_acao_excesso_w		varchar(10);
qt_horas_intervalo_w	integer;
qt_registros_w			integer;
dt_procedimento_w		timestamp;
qt_executada_w			double precision;
qt_executada_dia_w		double precision;
qt_executada_atend_w	double precision;
qt_executada_periodo_w	double precision;
qt_excedida_w			double precision	:= 0;
ds_erro_w				varchar(255);
ds_procedimento_w		varchar(254);
ie_tipo_qtde_w			varchar(1);
CD_AREA_PROCEDIMENTO_w	bigint;
CD_ESPECIALIDADE_w		bigint;
CD_GRUPO_PROC_w			bigint;
qt_procedimento_w		double precision;
qt_exec_conta_w			double precision;
cd_medico_executor_w	varchar(10);
nr_seq_proc_interno_w	bigint;
cd_pessoa_fisica_w		varchar(10);
qt_exec_paciente_w		bigint;
qt_exec_cirurgia_w		bigint;
nr_seq_exame_w			bigint;
cd_estabelecimento_w	smallint;
qt_dias_internacao_w	bigint;
cd_tipo_acomod_w		smallint;
ds_mensagem_w			varchar(255);
qt_exec_pac_mes_w		bigint;
cd_convenio_excesso_w	integer;
cd_categoria_excesso_w	varchar(10);
qt_idade_w				double precision;
qt_executada_setor_w	double precision;
qt_executada_aih_w		bigint;
ie_estrutura_proc_w	convenio_regra_qtde_proc.ie_estrutura_proc%type;
cd_procedimento_w	convenio_regra_qtde_proc.cd_procedimento%type;
nr_seq_grupo_w		sus_grupo.nr_sequencia%type;
nr_seq_subgrupo_w	sus_subgrupo.nr_sequencia%type;
nr_seq_forma_org_w	sus_forma_organizacao.nr_sequencia%type;

c02 CURSOR FOR
SELECT 	a.qt_permitida,
		a.ie_acao_excesso,
		a.qt_horas_intervalo,
		a.ie_tipo_qtde,
		a.nr_seq_proc_interno,
		a.nr_seq_exame,
		a.ds_mensagem,
		a.cd_convenio_excesso,
		a.cd_categoria_excesso,
		a.ie_estrutura_proc,
		a.cd_procedimento
from 	convenio_regra_qtde_proc a
where	coalesce(a.cd_procedimento, cd_procedimento_p)		= cd_procedimento_p
and		coalesce(a.ie_origem_proced, ie_origem_proced_p)		= ie_origem_proced_p
and		coalesce(cd_area_procedimento, cd_area_procedimento_w)	= cd_area_procedimento_w
and		coalesce(cd_especialidade, cd_especialidade_w)		= cd_especialidade_w
and		coalesce(cd_grupo_proc, cd_grupo_proc_w)			= cd_grupo_proc_w
and		coalesce(nr_seq_grupo, coalesce(nr_seq_grupo_w,0))		= coalesce(nr_seq_grupo_w,0)
and		coalesce(nr_seq_subgrupo, coalesce(nr_seq_subgrupo_w,0))		= coalesce(nr_seq_subgrupo_w,0)
and		coalesce(nr_seq_forma_org, coalesce(nr_seq_forma_org_w,0))	= coalesce(nr_seq_forma_org_w,0)
and		a.cd_convenio = cd_convenio_w
and		coalesce(a.ie_tipo_atendimento, ie_tipo_atendimento_w) = ie_tipo_atendimento_w
and		(((coalesce(ie_tipo_setor,'A') = 'A') and (a.cd_setor_atendimento = cd_setor_atendimento_p or coalesce(cd_setor_atendimento::text, '') = '')) or
		 ((coalesce(ie_tipo_setor,'A') = 'P') and (a.cd_setor_atendimento = obter_setor_atendimento(nr_atendimento_p) or coalesce(cd_setor_atendimento::text, '') = '')))
and		coalesce(a.nr_seq_proc_interno,coalesce(nr_seq_proc_interno_p,0)) = coalesce(nr_seq_proc_interno_p,0)
and		coalesce(a.cd_categoria,coalesce(cd_categoria_p,'0')) = coalesce(cd_categoria_p,'0')
and		coalesce(a.cd_plano,coalesce(cd_plano_p,'0')) = coalesce(cd_plano_p,'0')	
and		coalesce(a.nr_seq_exame,coalesce(nr_seq_exame_p,0)) = coalesce(nr_seq_exame_p,0)
and		coalesce(a.cd_estabelecimento, coalesce(cd_estabelecimento_w,0))	= coalesce(cd_estabelecimento_w,0)
and		qt_dias_internacao_w between coalesce(qt_dias_inter_inicio, qt_dias_internacao_w) and coalesce(qt_dias_inter_final, qt_dias_internacao_w)
and		coalesce(qt_idade_w,1) between coalesce(obter_idade_regra_uso(a.nr_sequencia,'MIN','P'),0) and coalesce(obter_idade_regra_uso(a.nr_sequencia,'MAX','P'),9999999)
and		coalesce(cd_tipo_acomodacao, coalesce(cd_tipo_acomod_w,0)) = coalesce(cd_tipo_acomod_w,0)
and		coalesce(a.ie_situacao,'A') = 'A'
and		coalesce(cd_perfil, coalesce(obter_perfil_ativo, 0)) = coalesce(obter_perfil_ativo, 0)
order by	coalesce(cd_procedimento,0),
			coalesce(cd_grupo_proc,0),
			coalesce(cd_especialidade,0),
			coalesce(cd_area_procedimento,0),
			coalesce(nr_seq_exame,0),
			coalesce(cd_setor_atendimento,0),
			coalesce(cd_estabelecimento,0),
			coalesce(cd_tipo_acomodacao,0);



BEGIN

ds_erro_w		:= '';
ds_erro_p		:= '';
ie_acao_excesso_w	:= '';
cd_convenio_excesso_w	:= null;
cd_categoria_excesso_w	:= '';
qt_procedimento_w	:= coalesce(qt_procedimento_p,0);
dt_procedimento_w	:= dt_procedimento_p;

begin
select	cd_area_procedimento,
		cd_especialidade,
		cd_grupo_proc
into STRICT	cd_area_procedimento_w,
		cd_especialidade_w,
		cd_grupo_proc_w
from	estrutura_procedimento_v
where	cd_procedimento		= cd_procedimento_p
and		ie_origem_proced	= ie_origem_proced_p;
exception when others then
	null;
	-- Problema no procedimento: #@CD_PROCEDIMENTO#@ - #@IE_ORIGEM_PROCED#@

	--Wheb_mensagem_pck.exibir_mensagem_abort(185344,'CD_PROCEDIMENTO=' || cd_procedimento_p || ';IE_ORIGEM_PROCED=' || ie_origem_proced_p);
end;

/* Obter a estrutura de procedimento SUS Unificado*/

begin
select	nr_seq_grupo,
	nr_seq_subgrupo,
	nr_seq_forma_org
into STRICT	nr_seq_grupo_w,
	nr_seq_subgrupo_w,
	nr_seq_forma_org_w
from	sus_estrutura_procedimento_v
where	cd_procedimento		= cd_procedimento_p
and	ie_origem_proced	= ie_origem_proced_p;
exception
	when others then
	nr_seq_grupo_w		:= 0;
	nr_seq_subgrupo_w	:= 0;
	nr_seq_forma_org_w	:= 0;
end;

select	count(*)
into STRICT	qt_registros_w
from	convenio_regra_qtde_proc where		coalesce(cd_procedimento, cd_procedimento_p)			= cd_procedimento_p
and		coalesce(cd_area_procedimento, cd_area_procedimento_w)	= cd_area_procedimento_w
and		coalesce(cd_especialidade, cd_especialidade_w)		= cd_especialidade_w
and		coalesce(cd_grupo_proc, cd_grupo_proc_w)			= cd_grupo_proc_w
and		coalesce(nr_seq_proc_interno,coalesce(nr_seq_proc_interno_p,0)) 	= coalesce(nr_seq_proc_interno_p,0)
and		coalesce(nr_seq_grupo, coalesce(nr_seq_grupo_w,0))		= coalesce(nr_seq_grupo_w,0)
and		coalesce(nr_seq_subgrupo, coalesce(nr_seq_subgrupo_w,0))		= coalesce(nr_seq_subgrupo_w,0)
and		coalesce(nr_seq_forma_org, coalesce(nr_seq_forma_org_w,0))	= coalesce(nr_seq_forma_org_w,0)
and		coalesce(cd_categoria,coalesce(cd_categoria_p,'0'))		= coalesce(cd_categoria_p,'0')
and		coalesce(cd_plano,coalesce(cd_plano_p,'0'))			= coalesce(cd_plano_p,'0')
and		coalesce(nr_seq_exame,coalesce(nr_seq_exame_p,0)) = coalesce(nr_seq_exame_p,0)
and		coalesce(ie_situacao,'A') = 'A' LIMIT 1;

if (qt_registros_w	> 0) then
	begin
	cd_convenio_w		:= coalesce(obter_convenio_atendimento(nr_atendimento_p),0);
	cd_tipo_acomod_w	:= coalesce((obter_tipo_acomod_atend(nr_atendimento_p,'C'))::numeric ,0);

	select 	coalesce(max(ie_tipo_atendimento),0),
			coalesce(max(cd_estabelecimento),0),
			coalesce(trunc(coalesce(max(dt_alta), clock_timestamp()) - max(dt_entrada)),0),
			max(cd_pessoa_fisica)
	into STRICT	ie_tipo_atendimento_w,
			cd_estabelecimento_w,
			qt_dias_internacao_w,
			cd_pessoa_fisica_w
	from	atendimento_paciente
	where	nr_atendimento	= nr_atendimento_p;
	
	begin
	select	max(obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'DIA'))	
	into STRICT	qt_idade_w	
	from	pessoa_fisica b
	where	b.cd_pessoa_fisica	= cd_pessoa_fisica_w;
	exception
	when others then
		qt_idade_w	:= 0;
	end;

	ie_tipo_qtde_w  :=  'X';

	open	c02;
	loop
	fetch	c02 into
		qt_permitida_w,
		ie_acao_excesso_w,
		qt_horas_intervalo_w,
		ie_tipo_qtde_w,
		nr_seq_proc_interno_w,
		nr_seq_exame_w,
		ds_mensagem_w,
		cd_convenio_excesso_w,
		cd_categoria_excesso_w,
		ie_estrutura_proc_w,
		cd_procedimento_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
	end loop;
	close c02;
	

	if (ie_estrutura_proc_w = 'N') then
		-- Dia
		if (ie_tipo_qtde_w = 'D') then

			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_executada_dia_w
			from	procedimento_paciente
			where	cd_procedimento		= cd_procedimento_p
			and	ie_origem_proced	= ie_origem_proced_p
			and	pkg_date_utils.get_time(dt_procedimento,0,0,0)	= pkg_date_utils.get_time(dt_procedimento_w,0,0,0)
			and	nr_atendimento		= nr_atendimento_p
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w))
			and 	nr_sequencia <> coalesce(nr_seq_proc_p,0);

			if	((qt_executada_dia_w + qt_procedimento_w) > qt_permitida_w) then
				qt_excedida_w	:= (qt_executada_dia_w + qt_procedimento_w) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280846);
			end if;
			
		-- Setor / Dia
		elsif (ie_tipo_qtde_w = 'F') then

			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_executada_dia_w
			from	procedimento_paciente
			where	cd_procedimento		= cd_procedimento_p
			and	ie_origem_proced	= ie_origem_proced_p
			and	pkg_date_utils.get_time(dt_procedimento,0,0,0)	= pkg_date_utils.get_time(dt_procedimento_w,0,0,0)
			and	cd_setor_atendimento	= cd_setor_atendimento_p
			and	nr_atendimento		= nr_atendimento_p
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w))
			and 	nr_sequencia <> coalesce(nr_seq_proc_p,0);

			if	((qt_executada_dia_w + qt_procedimento_w) > qt_permitida_w) then
				qt_excedida_w	:= (qt_executada_dia_w + qt_procedimento_w) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280847);
			end if;


		-- Atendimento
		elsif (ie_tipo_qtde_w = 'A') then

			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_executada_atend_w
			from	procedimento_paciente
			where	nr_atendimento		= nr_atendimento_p
			and	cd_procedimento		= cd_procedimento_p
			and	ie_origem_proced	= ie_origem_proced_p
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w))
			and 	nr_sequencia <> coalesce(nr_seq_proc_p,0);

			if	((qt_executada_atend_w + qt_procedimento_w) > qt_permitida_w ) then
				qt_excedida_w	:= (qt_executada_atend_w + qt_procedimento_w) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280848);

			end if;

		-- Atendimento/Medico
		elsif (ie_tipo_qtde_w = 'B') then

			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_executada_atend_w
			from	procedimento_paciente
			where	nr_atendimento		= nr_atendimento_p
			and	cd_procedimento		= cd_procedimento_p
			and	ie_origem_proced	= ie_origem_proced_p
			and 	cd_medico_executor	= cd_medico_executor_p
			and 	(cd_medico_executor IS NOT NULL AND cd_medico_executor::text <> '')
			and 	(cd_medico_executor_p IS NOT NULL AND cd_medico_executor_p::text <> '')
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w))
			and 	nr_sequencia <> coalesce(nr_seq_proc_p,0);

			if	((qt_executada_atend_w + qt_procedimento_w) > qt_permitida_w ) then

				qt_excedida_w	:= (qt_executada_atend_w + qt_procedimento_w) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280849);

			end if;

		-- Horas (periodo)
		elsif (ie_tipo_qtde_w = 'H') then

			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_executada_periodo_w
			from	procedimento_paciente
			where	nr_atendimento		= nr_atendimento_p
			and	cd_procedimento		= cd_procedimento_p
			and	ie_origem_proced	= ie_origem_proced_p
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and	dt_procedimento between
				(dt_procedimento_w - (qt_horas_intervalo_w * 60 /1440)) and dt_procedimento_w
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w))
			and 	nr_sequencia <> coalesce(nr_seq_proc_p,0);

			if	((qt_executada_periodo_w + qt_procedimento_w) > qt_permitida_w) then
				qt_excedida_w	:= (qt_executada_periodo_w + qt_procedimento_w) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280851);
			end if;

		-- Mes
		elsif (ie_tipo_qtde_w		= 'M') then
			select	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_executada_w
			from	procedimento_paciente
			where	nr_atendimento		= nr_atendimento_p
			and	cd_procedimento		= cd_procedimento_p
			and	ie_origem_proced	= ie_origem_proced_p
			and	PKG_DATE_UTILS.start_of(dt_procedimento,'Month',0)	= PKG_DATE_UTILS.start_of(dt_procedimento_w,'Month',0)
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w))
			and 	nr_sequencia <> coalesce(nr_seq_proc_p,0);

			if	((qt_executada_w + qt_procedimento_w) > qt_permitida_w) then
				qt_excedida_w	:= (qt_executada_w + qt_procedimento_w) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280852);
			end if;
			
		-- Ano
		elsif (ie_tipo_qtde_w		= 'Y') then
			select	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_executada_w
			from	procedimento_paciente
			where	nr_atendimento		= nr_atendimento_p
			and	cd_procedimento		= cd_procedimento_p
			and	ie_origem_proced	= ie_origem_proced_p	
			and	PKG_DATE_UTILS.start_of(dt_procedimento,'Year',0)	= PKG_DATE_UTILS.start_of(dt_procedimento_w,'Year',0)
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w))
			and 	nr_sequencia <> coalesce(nr_seq_proc_p,0);

			if	((qt_executada_w + qt_procedimento_w) > qt_permitida_w) then
				qt_excedida_w	:= (qt_executada_w + qt_procedimento_w) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280853);
			end if;	

		-- Setor
		elsif (ie_tipo_qtde_w = 'S') then

			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_executada_setor_w
			from	procedimento_paciente
			where	nr_atendimento		= nr_atendimento_p
			and	cd_procedimento		= cd_procedimento_p
			and	ie_origem_proced	= ie_origem_proced_p
			and	cd_setor_atendimento	= cd_setor_atendimento_p
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (nr_seq_exame = nr_seq_exame_w))
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and 	nr_sequencia <> coalesce(nr_seq_proc_p,0);

			if	((qt_executada_setor_w + qt_procedimento_w) > qt_permitida_w ) then
				qt_excedida_w	:= (qt_executada_setor_w + qt_procedimento_w) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280854);
			end if;
			
		-- Conta
		elsif (ie_tipo_qtde_w = 'C') then

			if (nr_interno_conta_p IS NOT NULL AND nr_interno_conta_p::text <> '') then
				
				select 	coalesce(sum(qt_procedimento),0)
				into STRICT	qt_exec_conta_w
				from	procedimento_paciente
				where	nr_interno_conta	= nr_interno_conta_p
				and	cd_procedimento		= cd_procedimento_p
				and	ie_origem_proced	= ie_origem_proced_p
				and	coalesce(cd_motivo_exc_conta::text, '') = ''
				and 	nr_sequencia <> coalesce(nr_seq_proc_p,0);

				if	((qt_exec_conta_w + qt_procedimento_p) > qt_permitida_w ) then
					qt_excedida_w	:= (qt_exec_conta_w + qt_procedimento_p) - qt_permitida_w;
					ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280855);

				end if;
				
			end if;
		
		-- Paciente
		elsif (ie_tipo_qtde_w = 'P') then

				select 	coalesce(max(cd_pessoa_fisica),'0')
				into STRICT	cd_pessoa_fisica_w
				from 	atendimento_paciente
				where 	nr_atendimento = nr_atendimento_p;
			
				select 	coalesce(sum(a.qt_procedimento),0)
				into STRICT	qt_exec_paciente_w
				from	procedimento_paciente 	a,
					conta_paciente		b,
					atendimento_paciente	c
				where	b.nr_interno_conta 	= a.nr_interno_conta
				and 	c.nr_atendimento	= b.nr_atendimento
				and 	c.cd_pessoa_fisica	= cd_pessoa_fisica_w
				and	a.cd_procedimento	= cd_procedimento_p
				and	a.ie_origem_proced	= ie_origem_proced_p
				and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
				and 	nr_sequencia <> coalesce(nr_seq_proc_p,0);			
		
				if	((qt_exec_paciente_w + qt_procedimento_p) > qt_permitida_w ) then
					qt_excedida_w	:= (qt_exec_paciente_w + qt_procedimento_p) - qt_permitida_w;
					ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280856);
		
				end if;		
		
		-- Cirurgia
		elsif (ie_tipo_qtde_w = 'G') then

			select 	coalesce(sum(qt_procedimento),0)
				into STRICT	qt_exec_cirurgia_w
				from	procedimento_paciente
				where	nr_cirurgia	= nr_cirurgia_p
				and	cd_procedimento		= cd_procedimento_p
				and	ie_origem_proced	= ie_origem_proced_p
				and	coalesce(cd_motivo_exc_conta::text, '') = ''
				and 	nr_sequencia <> coalesce(nr_seq_proc_p,0);

				if	((qt_exec_cirurgia_w + qt_procedimento_p) > qt_permitida_w ) then
					qt_excedida_w	:= (qt_exec_cirurgia_w + qt_procedimento_p) - qt_permitida_w;
					ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280858);

				end if;
				
		-- Lancamento
		elsif (ie_tipo_qtde_w = 'L') then
		
			if (qt_procedimento_p > qt_permitida_w) then
				qt_excedida_w	:= (qt_procedimento_p) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280859);
			end if;
			
		-- Mes/Paciente
		elsif (ie_tipo_qtde_w = 'N') then
		
			select 	coalesce(max(cd_pessoa_fisica),'0')
			into STRICT	cd_pessoa_fisica_w
			from 	atendimento_paciente
			where 	nr_atendimento = nr_atendimento_p;
		
			select 	coalesce(sum(a.qt_procedimento),0)
			into STRICT	qt_exec_pac_mes_w
			from	procedimento_paciente a,
				conta_paciente b,
				atendimento_paciente c
			where	b.nr_interno_conta = a.nr_interno_conta
			and 	c.nr_atendimento = b.nr_atendimento
			and	a.cd_procedimento = cd_procedimento_p
			and	a.ie_origem_proced = ie_origem_proced_p
			and 	c.cd_pessoa_fisica = cd_pessoa_fisica_w
			and	PKG_DATE_UTILS.start_of(a.dt_procedimento,'Month',0) = PKG_DATE_UTILS.start_of(dt_procedimento_w,'Month',0)
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (a.nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (a.nr_seq_exame = nr_seq_exame_w))
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
			and 	nr_sequencia <> coalesce(nr_seq_proc_p,0);		

			if	((qt_exec_pac_mes_w + qt_procedimento_p) > qt_permitida_w ) then
				qt_excedida_w	:= (qt_exec_pac_mes_w + qt_procedimento_p) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280860);
			end if;	

		-- AIH
		elsif (ie_tipo_qtde_w = 'I') then
		
			if	((obter_dados_atendimento(nr_atendimento_p, 'TA') = 1) and (obter_tipo_convenio_atend(nr_atendimento_p) = 3)) then
				begin
			
				select	coalesce(sum(p.qt_procedimento),0)
				into STRICT	qt_executada_aih_w		
				from	sus_aih_unif a,
						conta_paciente c,
						procedimento_paciente p
				where	c.nr_interno_conta = a.nr_interno_conta		
				and	p.nr_interno_conta = c.nr_interno_conta
				and	coalesce(p.cd_motivo_exc_conta::text, '') = ''
				and	c.nr_atendimento = nr_atendimento_p
				and	p.cd_procedimento = cd_procedimento_p
				and	p.ie_origem_proced = ie_origem_proced_p
				and	c.ie_status_acerto = 1
				and 	p.nr_sequencia <> coalesce(nr_seq_proc_p,0);			
			
				if (qt_executada_aih_w = 0) then
					select	coalesce(sum(p.qt_procedimento),0)
					into STRICT	qt_executada_aih_w		
					from	conta_paciente c,
							procedimento_paciente p
					where	p.nr_interno_conta = c.nr_interno_conta
					and	coalesce(p.cd_motivo_exc_conta::text, '') = ''
					and	c.nr_atendimento = nr_atendimento_p
					and	p.cd_procedimento = cd_procedimento_p
					and	p.ie_origem_proced = ie_origem_proced_p
					and	c.ie_status_acerto = 1
					and 	p.nr_sequencia <> coalesce(nr_seq_proc_p,0);
				end if;

				if	((qt_executada_aih_w + qt_procedimento_w) > qt_permitida_w ) then
					qt_excedida_w	:= (qt_executada_aih_w + qt_procedimento_w) - qt_permitida_w;
					ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280861);
				end if;
				
				end;
			end if;	
		
		-- Dia/Paciente
		elsif (ie_tipo_qtde_w = 'J') then
		
			select 	coalesce(max(cd_pessoa_fisica),'0')
			into STRICT	cd_pessoa_fisica_w
			from 	atendimento_paciente
			where 	nr_atendimento = nr_atendimento_p;
		
			select 	coalesce(sum(a.qt_procedimento),0)
			into STRICT	qt_exec_pac_mes_w
			from	procedimento_paciente a,
				conta_paciente b,
				atendimento_paciente c
			where	b.nr_interno_conta = a.nr_interno_conta
			and 	c.nr_atendimento = b.nr_atendimento
			and	a.cd_procedimento = cd_procedimento_p
			and	a.ie_origem_proced = ie_origem_proced_p
			and 	c.cd_pessoa_fisica = cd_pessoa_fisica_w
			and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_procedimento) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_procedimento_w)
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (a.nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (a.nr_seq_exame = nr_seq_exame_w))
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
			and 	nr_sequencia <> coalesce(nr_seq_proc_p,0);		

			if	((qt_exec_pac_mes_w + qt_procedimento_p) > qt_permitida_w ) then
				qt_excedida_w	:= (qt_exec_pac_mes_w + qt_procedimento_p) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(1018531);
			end if;
			
		end if;
		
		if (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') and (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '')then
			ds_erro_w := ds_mensagem_w;
		end if;
		
		if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
			ds_erro_p		:= ds_erro_w;
			qt_excedida_p		:= qt_excedida_w;
			ie_acao_excesso_p	:= ie_acao_excesso_w;
			cd_convenio_excesso_p	:= cd_convenio_excesso_w;
			cd_categoria_excesso_p	:= cd_categoria_excesso_w;
		end if;
	else
		-- Dia
		if (ie_tipo_qtde_w = 'D') then

			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_executada_dia_w
			from	procedimento_paciente a,
				estrutura_procedimento_v b
			where	a.cd_procedimento  = b.cd_procedimento
			and	a.ie_origem_proced  = b.ie_origem_proced
			and	a.ie_origem_proced	= ie_origem_proced_p
			and	pkg_date_utils.get_time(a.dt_procedimento,0,0,0)= pkg_date_utils.get_time(dt_procedimento_w,0,0,0)
			and	a.nr_atendimento	= nr_atendimento_p
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (a.nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (a.nr_seq_exame = nr_seq_exame_w))
			and 	a.nr_sequencia <> coalesce(nr_seq_proc_p,0)
			and	b.cd_procedimento	= coalesce(cd_procedimento_w,b.cd_procedimento)
			and	b.cd_area_procedimento  = coalesce(cd_area_procedimento_w,b.cd_area_procedimento)
			and	b.cd_especialidade	= coalesce(cd_especialidade_w, b.cd_especialidade)
			and	b.cd_grupo_proc		= coalesce(cd_grupo_proc_w, b.cd_grupo_proc);

			if	((qt_executada_dia_w + qt_procedimento_w) > qt_permitida_w) then
				qt_excedida_w	:= (qt_executada_dia_w + qt_procedimento_w) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280846);
			end if;
			
		-- Setor / Dia
		elsif (ie_tipo_qtde_w = 'F') then

			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_executada_dia_w
			from	procedimento_paciente a,
				estrutura_procedimento_v b
			where	a.cd_procedimento  = b.cd_procedimento
			and	a.ie_origem_proced  = b.ie_origem_proced
			and	a.ie_origem_proced	= ie_origem_proced_p
			and	pkg_date_utils.get_time(a.dt_procedimento,0,0,0)= pkg_date_utils.get_time(dt_procedimento_w,0,0,0)
			and	a.cd_setor_atendimento	= cd_setor_atendimento_p
			and	a.nr_atendimento	= nr_atendimento_p
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (a.nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (a.nr_seq_exame = nr_seq_exame_w))
			and 	a.nr_sequencia <> coalesce(nr_seq_proc_p,0)	
			and	b.cd_procedimento	= coalesce(cd_procedimento_w,b.cd_procedimento)
			and	b.cd_area_procedimento  = coalesce(cd_area_procedimento_w,b.cd_area_procedimento)
			and	b.cd_especialidade	= coalesce(cd_especialidade_w, b.cd_especialidade)
			and	b.cd_grupo_proc		= coalesce(cd_grupo_proc_w, b.cd_grupo_proc);

			if	((qt_executada_dia_w + qt_procedimento_w) > qt_permitida_w) then
				qt_excedida_w	:= (qt_executada_dia_w + qt_procedimento_w) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280847);
			end if;


		-- Atendimento
		elsif (ie_tipo_qtde_w = 'A') then

			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_executada_atend_w
			from	procedimento_paciente a,
				estrutura_procedimento_v b
			where	a.nr_atendimento	= nr_atendimento_p
			and	a.cd_procedimento  = b.cd_procedimento
			and	a.ie_origem_proced  = b.ie_origem_proced
			and	a.ie_origem_proced	= ie_origem_proced_p
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (a.nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (a.nr_seq_exame = nr_seq_exame_w))
			and 	a.nr_sequencia <> coalesce(nr_seq_proc_p,0)
			and	b.cd_procedimento	= coalesce(cd_procedimento_w,b.cd_procedimento)
			and	b.cd_area_procedimento  = coalesce(cd_area_procedimento_w,b.cd_area_procedimento)
			and	b.cd_especialidade	= coalesce(cd_especialidade_w, b.cd_especialidade)
			and	b.cd_grupo_proc		= coalesce(cd_grupo_proc_w, b.cd_grupo_proc);

			if	((qt_executada_atend_w + qt_procedimento_w) > qt_permitida_w ) then
				qt_excedida_w	:= (qt_executada_atend_w + qt_procedimento_w) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280848);

			end if;

		-- Atendimento/Medico
		elsif (ie_tipo_qtde_w = 'B') then

			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_executada_atend_w
			from	procedimento_paciente a,
				estrutura_procedimento_v b
			where	a.nr_atendimento	= nr_atendimento_p
			and	a.cd_procedimento  = b.cd_procedimento
			and	a.ie_origem_proced  = b.ie_origem_proced
			and	a.ie_origem_proced	= ie_origem_proced_p
			and 	a.cd_medico_executor	= cd_medico_executor_p
			and 	(a.cd_medico_executor IS NOT NULL AND a.cd_medico_executor::text <> '')
			and 	(cd_medico_executor_p IS NOT NULL AND cd_medico_executor_p::text <> '')
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (a.nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (a.nr_seq_exame = nr_seq_exame_w))
			and 	a.nr_sequencia <> coalesce(nr_seq_proc_p,0)
			and	b.cd_procedimento	= coalesce(cd_procedimento_w,b.cd_procedimento)
			and	b.cd_area_procedimento  = coalesce(cd_area_procedimento_w,b.cd_area_procedimento)
			and	b.cd_especialidade	= coalesce(cd_especialidade_w, b.cd_especialidade)
			and	b.cd_grupo_proc		= coalesce(cd_grupo_proc_w, b.cd_grupo_proc);

			if	((qt_executada_atend_w + qt_procedimento_w) > qt_permitida_w ) then

				qt_excedida_w	:= (qt_executada_atend_w + qt_procedimento_w) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280849);

			end if;

		-- Horas (periodo)
		elsif (ie_tipo_qtde_w = 'H') then

			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_executada_periodo_w
			from	procedimento_paciente a,
				estrutura_procedimento_v b
			where	a.nr_atendimento	= nr_atendimento_p
			and	a.cd_procedimento  	= b.cd_procedimento
			and	a.ie_origem_proced  	= b.ie_origem_proced
			and	a.ie_origem_proced	= ie_origem_proced_p
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
			and	a.dt_procedimento between
				(dt_procedimento_w - (qt_horas_intervalo_w * 60 /1440)) and dt_procedimento_w
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (a.nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (a.nr_seq_exame = nr_seq_exame_w))
			and 	a.nr_sequencia <> coalesce(nr_seq_proc_p,0)
			and	b.cd_procedimento	= coalesce(cd_procedimento_w,b.cd_procedimento)
			and	b.cd_area_procedimento  = coalesce(cd_area_procedimento_w,b.cd_area_procedimento)
			and	b.cd_especialidade	= coalesce(cd_especialidade_w, b.cd_especialidade)
			and	b.cd_grupo_proc		= coalesce(cd_grupo_proc_w, b.cd_grupo_proc);

			if	((qt_executada_periodo_w + qt_procedimento_w) > qt_permitida_w) then
				qt_excedida_w	:= (qt_executada_periodo_w + qt_procedimento_w) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280851);
			end if;

		-- Mes
		elsif (ie_tipo_qtde_w		= 'M') then
			select	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_executada_w
			from	procedimento_paciente a,
				estrutura_procedimento_v b
			where	a.nr_atendimento		= nr_atendimento_p
			and	a.cd_procedimento  = b.cd_procedimento
			and	a.ie_origem_proced  = b.ie_origem_proced
			and	a.ie_origem_proced		= ie_origem_proced_p
			and	PKG_DATE_UTILS.start_of(a.dt_procedimento,'Month',0)= PKG_DATE_UTILS.start_of(dt_procedimento_w,'Month',0)
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (a.nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (a.nr_seq_exame = nr_seq_exame_w))
			and 	a.nr_sequencia <> coalesce(nr_seq_proc_p,0)
			and	b.cd_procedimento	= coalesce(cd_procedimento_w,b.cd_procedimento)
			and	b.cd_area_procedimento  = coalesce(cd_area_procedimento_w,b.cd_area_procedimento)
			and	b.cd_especialidade	= coalesce(cd_especialidade_w, b.cd_especialidade)
			and	b.cd_grupo_proc		= coalesce(cd_grupo_proc_w, b.cd_grupo_proc);

			if	((qt_executada_w + qt_procedimento_w) > qt_permitida_w) then
				qt_excedida_w	:= (qt_executada_w + qt_procedimento_w) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280852);
			end if;
			
		-- Ano
		elsif (ie_tipo_qtde_w		= 'Y') then
			select	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_executada_w
			from	procedimento_paciente a,
				estrutura_procedimento_v b
			where	a.nr_atendimento		= nr_atendimento_p
			and	a.cd_procedimento  = b.cd_procedimento
			and	a.ie_origem_proced  = b.ie_origem_proced
			and	a.ie_origem_proced		= ie_origem_proced_p	
			and	PKG_DATE_UTILS.start_of(a.dt_procedimento,'Year',0)	= PKG_DATE_UTILS.start_of(dt_procedimento_w,'Year',0)
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (a.nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (a.nr_seq_exame = nr_seq_exame_w))
			and 	a.nr_sequencia <> coalesce(nr_seq_proc_p,0)
			and	b.cd_procedimento	= coalesce(cd_procedimento_w,b.cd_procedimento)
			and	b.cd_area_procedimento  = coalesce(cd_area_procedimento_w,b.cd_area_procedimento)
			and	b.cd_especialidade	= coalesce(cd_especialidade_w, b.cd_especialidade)
			and	b.cd_grupo_proc		= coalesce(cd_grupo_proc_w, b.cd_grupo_proc);

			if	((qt_executada_w + qt_procedimento_w) > qt_permitida_w) then
				qt_excedida_w	:= (qt_executada_w + qt_procedimento_w) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280853);
			end if;	

		-- Setor
		elsif (ie_tipo_qtde_w = 'S') then

			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_executada_setor_w
			from	procedimento_paciente a,
				estrutura_procedimento_v b
			where	a.nr_atendimento		= nr_atendimento_p
			and	a.cd_procedimento  = b.cd_procedimento
			and	a.ie_origem_proced  = b.ie_origem_proced
			and	a.ie_origem_proced	= ie_origem_proced_p
			and	a.cd_setor_atendimento	= cd_setor_atendimento_p
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (a.nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (a.nr_seq_exame = nr_seq_exame_w))
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and 	nr_sequencia <> coalesce(nr_seq_proc_p,0)
			and	b.cd_procedimento	= coalesce(cd_procedimento_w,b.cd_procedimento)
			and	b.cd_area_procedimento  = coalesce(cd_area_procedimento_w,b.cd_area_procedimento)
			and	b.cd_especialidade	= coalesce(cd_especialidade_w, b.cd_especialidade)
			and	b.cd_grupo_proc		= coalesce(cd_grupo_proc_w, b.cd_grupo_proc);

			if	((qt_executada_setor_w + qt_procedimento_w) > qt_permitida_w ) then
				qt_excedida_w	:= (qt_executada_setor_w + qt_procedimento_w) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280854);
			end if;
			
		-- Conta
		elsif (ie_tipo_qtde_w = 'C') then

			if (nr_interno_conta_p IS NOT NULL AND nr_interno_conta_p::text <> '') then
				
				select 	coalesce(sum(qt_procedimento),0)
				into STRICT	qt_exec_conta_w
				from	procedimento_paciente a,
					estrutura_procedimento_v b
				where	a.nr_interno_conta	= nr_interno_conta_p
				and	a.cd_procedimento  = b.cd_procedimento
				and	a.ie_origem_proced  = b.ie_origem_proced
				and	a.ie_origem_proced	= ie_origem_proced_p
				and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
				and 	a.nr_sequencia <> coalesce(nr_seq_proc_p,0)
				and	b.cd_procedimento	= coalesce(cd_procedimento_w,b.cd_procedimento)
				and	b.cd_area_procedimento  = coalesce(cd_area_procedimento_w,b.cd_area_procedimento)
				and	b.cd_especialidade	= coalesce(cd_especialidade_w, b.cd_especialidade)
				and	b.cd_grupo_proc		= coalesce(cd_grupo_proc_w, b.cd_grupo_proc);

				if	((qt_exec_conta_w + qt_procedimento_p) > qt_permitida_w ) then
					qt_excedida_w	:= (qt_exec_conta_w + qt_procedimento_p) - qt_permitida_w;
					ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280855);

				end if;
				
			end if;
		
		-- Paciente
		elsif (ie_tipo_qtde_w = 'P') then

				select 	coalesce(max(cd_pessoa_fisica),'0')
				into STRICT	cd_pessoa_fisica_w
				from 	atendimento_paciente
				where 	nr_atendimento = nr_atendimento_p;
			
				select 	coalesce(sum(a.qt_procedimento),0)
				into STRICT	qt_exec_paciente_w
				from	procedimento_paciente 	a,
					estrutura_procedimento_v b,
					conta_paciente		x,
					atendimento_paciente	c
				where	x.nr_interno_conta 	= a.nr_interno_conta
				and 	c.nr_atendimento	= x.nr_atendimento
				and 	c.cd_pessoa_fisica	= cd_pessoa_fisica_w
				and	a.cd_procedimento  = b.cd_procedimento
				and	a.ie_origem_proced  = b.ie_origem_proced
				and	a.ie_origem_proced	= ie_origem_proced_p
				and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
				and 	nr_sequencia <> coalesce(nr_seq_proc_p,0)
				and	b.cd_procedimento	= coalesce(cd_procedimento_w,b.cd_procedimento)
				and	b.cd_area_procedimento  = coalesce(cd_area_procedimento_w,b.cd_area_procedimento)
				and	b.cd_especialidade	= coalesce(cd_especialidade_w, b.cd_especialidade)
				and	b.cd_grupo_proc		= coalesce(cd_grupo_proc_w, b.cd_grupo_proc);			
		
				if	((qt_exec_paciente_w + qt_procedimento_p) > qt_permitida_w ) then
					qt_excedida_w	:= (qt_exec_paciente_w + qt_procedimento_p) - qt_permitida_w;
					ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280856);
		
				end if;		
		
		-- Cirurgia
		elsif (ie_tipo_qtde_w = 'G') then

			select 	coalesce(sum(qt_procedimento),0)
			into STRICT	qt_exec_cirurgia_w
			from	procedimento_paciente a,
				estrutura_procedimento_v b
			where	a.nr_cirurgia	= nr_cirurgia_p
			and	a.cd_procedimento  = b.cd_procedimento
			and	a.ie_origem_proced  = b.ie_origem_proced
			and	a.ie_origem_proced	= ie_origem_proced_p
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
			and 	a.nr_sequencia <> coalesce(nr_seq_proc_p,0)
			and	b.cd_procedimento	= coalesce(cd_procedimento_w,b.cd_procedimento)  
			and	b.cd_area_procedimento  = coalesce(cd_area_procedimento_w,b.cd_area_procedimento)
			and	b.cd_especialidade	= coalesce(cd_especialidade_w, b.cd_especialidade)
			and	b.cd_grupo_proc		= coalesce(cd_grupo_proc_w, b.cd_grupo_proc);

				if	((qt_exec_cirurgia_w + qt_procedimento_p) > qt_permitida_w ) then
					qt_excedida_w	:= (qt_exec_cirurgia_w + qt_procedimento_p) - qt_permitida_w;
					ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280858);

				end if;
				
		-- Lancamento
		elsif (ie_tipo_qtde_w = 'L') then
		
			if (qt_procedimento_p > qt_permitida_w) then
				qt_excedida_w	:= (qt_procedimento_p) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280859);
			end if;
			
		-- Mes/Paciente
		elsif (ie_tipo_qtde_w = 'N') then
		
			select 	coalesce(max(cd_pessoa_fisica),'0')
			into STRICT	cd_pessoa_fisica_w
			from 	atendimento_paciente
			where 	nr_atendimento = nr_atendimento_p;
		
			select 	coalesce(sum(a.qt_procedimento),0)
			into STRICT	qt_exec_pac_mes_w
			from	procedimento_paciente a,
				estrutura_procedimento_v b,
				conta_paciente x,
				atendimento_paciente c
			where	x.nr_interno_conta = a.nr_interno_conta
			and 	c.nr_atendimento = x.nr_atendimento
			and	a.cd_procedimento  = b.cd_procedimento
			and	a.ie_origem_proced  = b.ie_origem_proced
			and	a.ie_origem_proced = ie_origem_proced_p
			and 	c.cd_pessoa_fisica = cd_pessoa_fisica_w
			and	PKG_DATE_UTILS.start_of(a.dt_procedimento,'Month',0) = PKG_DATE_UTILS.start_of(dt_procedimento_w,'Month',0)
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (a.nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (a.nr_seq_exame = nr_seq_exame_w))
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
			and 	nr_sequencia <> coalesce(nr_seq_proc_p,0)
			and	b.cd_procedimento	= coalesce(cd_procedimento_w,b.cd_procedimento)
			and	b.cd_area_procedimento  = coalesce(cd_area_procedimento_w,b.cd_area_procedimento)
			and	b.cd_especialidade	= coalesce(cd_especialidade_w, b.cd_especialidade)
			and	b.cd_grupo_proc		= coalesce(cd_grupo_proc_w, b.cd_grupo_proc);		

			if	((qt_exec_pac_mes_w + qt_procedimento_p) > qt_permitida_w ) then
				qt_excedida_w	:= (qt_exec_pac_mes_w + qt_procedimento_p) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280860);
			end if;	

		-- AIH
		elsif (ie_tipo_qtde_w = 'I') then
		
			if	((obter_dados_atendimento(nr_atendimento_p, 'TA') = 1) and (obter_tipo_convenio_atend(nr_atendimento_p) = 3)) then
				begin
			
				select	coalesce(sum(p.qt_procedimento),0)
				into STRICT	qt_executada_aih_w		
				from	sus_aih_unif a,
						conta_paciente c,
						procedimento_paciente p,
						estrutura_procedimento_v b
				where	c.nr_interno_conta = a.nr_interno_conta		
				and	p.nr_interno_conta = c.nr_interno_conta
				and	coalesce(p.cd_motivo_exc_conta::text, '') = ''
				and	c.nr_atendimento = nr_atendimento_p
				and	p.cd_procedimento  = b.cd_procedimento
				and	p.ie_origem_proced  = b.ie_origem_proced
				and	p.ie_origem_proced = ie_origem_proced_p
				and	c.ie_status_acerto = 1
				and 	p.nr_sequencia <> coalesce(nr_seq_proc_p,0)
				and	b.cd_procedimento	= coalesce(cd_procedimento_w,b.cd_procedimento)
				and	b.cd_area_procedimento  = coalesce(cd_area_procedimento_w,b.cd_area_procedimento)
				and	b.cd_especialidade	= coalesce(cd_especialidade_w, b.cd_especialidade)
				and	b.cd_grupo_proc		= coalesce(cd_grupo_proc_w, b.cd_grupo_proc);			
			
				if (qt_executada_aih_w = 0) then
					select	coalesce(sum(p.qt_procedimento),0)
					into STRICT	qt_executada_aih_w		
					from	conta_paciente c,
						procedimento_paciente p,
						estrutura_procedimento_v b
					where	p.nr_interno_conta = c.nr_interno_conta
					and	coalesce(p.cd_motivo_exc_conta::text, '') = ''
					and	c.nr_atendimento = nr_atendimento_p
					and	p.cd_procedimento  = b.cd_procedimento
					and	p.ie_origem_proced  = b.ie_origem_proced
					and	p.ie_origem_proced = ie_origem_proced_p
					and	c.ie_status_acerto = 1
					and 	p.nr_sequencia <> coalesce(nr_seq_proc_p,0)
					and	b.cd_procedimento	= coalesce(cd_procedimento_w,b.cd_procedimento)
					and	b.cd_area_procedimento  = coalesce(cd_area_procedimento_w,b.cd_area_procedimento)
					and	b.cd_especialidade	= coalesce(cd_especialidade_w, b.cd_especialidade)
					and	b.cd_grupo_proc		= coalesce(cd_grupo_proc_w, b.cd_grupo_proc);
				end if;

				if	((qt_executada_aih_w + qt_procedimento_w) > qt_permitida_w ) then
					qt_excedida_w	:= (qt_executada_aih_w + qt_procedimento_w) - qt_permitida_w;
					ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(280861);
				end if;
				
				end;
			end if;
			
		-- Dia/Paciente
		elsif (ie_tipo_qtde_w = 'J') then
		
			select 	coalesce(max(cd_pessoa_fisica),'0')
			into STRICT	cd_pessoa_fisica_w
			from 	atendimento_paciente
			where 	nr_atendimento = nr_atendimento_p;
		
			select 	coalesce(sum(a.qt_procedimento),0)
			into STRICT	qt_exec_pac_mes_w
			from	procedimento_paciente a,
				estrutura_procedimento_v b,
				conta_paciente x,
				atendimento_paciente c
			where	x.nr_interno_conta = a.nr_interno_conta
			and 	c.nr_atendimento = x.nr_atendimento
			and	a.cd_procedimento  = b.cd_procedimento
			and	a.ie_origem_proced  = b.ie_origem_proced
			and	a.ie_origem_proced = ie_origem_proced_p
			and 	c.cd_pessoa_fisica = cd_pessoa_fisica_w
			and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_procedimento) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_procedimento_w)
			and	((coalesce(nr_seq_proc_interno_w::text, '') = '') or (a.nr_seq_proc_interno = nr_seq_proc_interno_w))
			and	((coalesce(nr_seq_exame_w::text, '') = '') or (a.nr_seq_exame = nr_seq_exame_w))
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
			and 	nr_sequencia <> coalesce(nr_seq_proc_p,0)
			and	b.cd_procedimento	= coalesce(cd_procedimento_w,b.cd_procedimento)
			and	b.cd_area_procedimento  = coalesce(cd_area_procedimento_w,b.cd_area_procedimento)
			and	b.cd_especialidade	= coalesce(cd_especialidade_w, b.cd_especialidade)
			and	b.cd_grupo_proc		= coalesce(cd_grupo_proc_w, b.cd_grupo_proc);		

			if	((qt_exec_pac_mes_w + qt_procedimento_p) > qt_permitida_w ) then
				qt_excedida_w	:= (qt_exec_pac_mes_w + qt_procedimento_p) - qt_permitida_w;
				ds_erro_w 	:= WHEB_MENSAGEM_PCK.get_texto(1018531);
			end if;
			
		end if;
		
		if (ds_mensagem_w IS NOT NULL AND ds_mensagem_w::text <> '') and (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '')then
			ds_erro_w := ds_mensagem_w;
		end if;
		
		if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
			ds_erro_p		:= ds_erro_w;
			qt_excedida_p		:= qt_excedida_w;
			ie_acao_excesso_p	:= ie_acao_excesso_w;
			cd_convenio_excesso_p	:= cd_convenio_excesso_w;
			cd_categoria_excesso_p	:= cd_categoria_excesso_w;
		end if;
	end if;
	end;
end if;
qt_excedida_p	:= coalesce(qt_excedida_p,qt_excedida_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_regra_qtde_proc_exec ( nr_atendimento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, qt_procedimento_p bigint, dt_procedimento_p timestamp, cd_medico_executor_p text, ie_acao_excesso_p INOUT text, qt_excedida_p INOUT text, ds_erro_p INOUT text, cd_convenio_excesso_p INOUT bigint, cd_categoria_excesso_p INOUT text, nr_seq_proc_interno_p bigint, cd_categoria_p text, cd_plano_p text, nr_interno_conta_p bigint, nr_cirurgia_p bigint, nr_seq_exame_p bigint, cd_setor_atendimento_p bigint, nr_seq_proc_p bigint default null) FROM PUBLIC;

