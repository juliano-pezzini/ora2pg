-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicar_regra_repace (cd_regra_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_regra_w			varchar(255);
ie_pagto_w			varchar(2);
ds_repasse_w			varchar(4000);
cd_regra_w			bigint;
ie_acao_glosa_w			varchar(1);
nr_seq_trans_fin_prod_w		bigint;
nr_seq_trans_fin_tit_w		bigint;
dt_limite_regra_w			timestamp;
DT_INICIO_VIGENCIA_w		timestamp;
NR_SEQ_TRANS_FIN_REP_MAIOR_w	bigint;
nr_seq_item_w              integer;
nr_seq_terceiro_w         bigint;
ie_beneficiario_w         varchar(1);
cd_conta_contabil_w       varchar(20);
ie_restricao_medico_w     smallint;
tx_repasse_w              double precision;
vl_repasse_w              double precision;
ie_perc_saldo_w           varchar(1);
ie_gravacao_medico_w      varchar(3);
ie_regra_saldo_w          varchar(1);
TX_MATERIAIS_w		  regra_repasse_terc_item.TX_MATERIAIS%type;
TX_MEDICO_w		  regra_repasse_terc_item.TX_MEDICO%type;
TX_CUSTO_OPERACIONAL_w	  regra_repasse_terc_item.TX_CUSTO_OPERACIONAL%type;
TX_AUXILIARES_w		  regra_repasse_terc_item.TX_AUXILIARES%type;
TX_ANESTESISTA_w	  regra_repasse_terc_item.TX_ANESTESISTA%type;
ds_repasse_longa_w	regra_repasse_terceiro.ds_repasse_longa%type;

c_regra_rep_terc_item CURSOR(	cd_regra_pc	regra_repasse_terceiro.cd_regra%type) FOR
	SELECT	tx_repasse,
		ie_beneficiario,
		nr_seq_terceiro,
		cd_conta_contabil,
		vl_repasse,
		ie_perc_saldo,
		ie_restricao_medico,
		ie_gravacao_medico,
		ie_regra_saldo,
		cd_pessoa_fisica,
		ds_observacao,
		coalesce(tx_anestesista,0) tx_anestesista,
		coalesce(tx_auxiliares,0) tx_auxiliares,
		coalesce(tx_custo_operacional,0) tx_custo_operacional,
		coalesce(tx_materiais,0) tx_materiais,
		coalesce(tx_medico,0) tx_medico,
		ie_por_unidade,
		ie_perc_executor,
		ie_funcao_medico,
		dt_inicio_vigencia,
		dt_fim_vigencia,
		nr_seq_categoria,
		ie_tipo_terceiro,
		ie_gera_item_zerado,
		ie_recebe_regra_pontuacao
	from	regra_repasse_terc_item
	where	cd_regra = cd_regra_pc;


BEGIN

select	ds_regra,
	ie_pagto,
	dt_limite_regra,
	ds_repasse,
	nr_seq_trans_fin_prod,
	nr_seq_trans_fin_tit,
	ie_acao_glosa,
	dt_inicio_vigencia,
	nr_seq_trans_fin_rep_maior,
	ds_repasse_longa
into STRICT	ds_regra_w,
	ie_pagto_w,
	dt_limite_regra_w,
	ds_repasse_w,
	nr_seq_trans_fin_prod_w,
	nr_seq_trans_fin_tit_w,
	ie_acao_glosa_w,
	dt_inicio_vigencia_w,
	nr_seq_trans_fin_rep_maior_w,
	ds_repasse_longa_w
from	regra_repasse_terceiro
where	cd_regra = cd_regra_p
and	cd_estabelecimento = cd_estabelecimento_p;

select	coalesce(max(cd_regra),0) + 1
into STRICT	cd_regra_w
from	regra_repasse_terceiro;

insert into regra_repasse_terceiro(cd_regra,
	ds_regra,
	cd_estabelecimento,
	dt_atualizacao,
	nm_usuario,
	ie_pagto,
	ds_repasse,
	nr_seq_trans_fin_prod,
	nr_seq_trans_fin_tit,
	dt_limite_regra,
	ie_acao_glosa,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	dt_inicio_vigencia,
	nr_seq_trans_fin_rep_maior,
	ds_repasse_longa)
values (cd_regra_w,
	substr(wheb_mensagem_pck.get_texto(302526,null) || ' - '||ds_regra_w,1,255), -- Copia 
	cd_estabelecimento_p,
	clock_timestamp(),
	nm_usuario_p,
	ie_pagto_w,
	ds_repasse_w,
	nr_seq_trans_fin_prod_w,
	nr_seq_trans_fin_tit_w,
	dt_limite_regra_w,
	ie_acao_glosa_w,
	clock_timestamp(),
	nm_usuario_p,
	dt_inicio_vigencia_w,
	nr_seq_trans_fin_rep_maior_w,
	ds_repasse_longa_w);

for	r_c_regra_rep_terc_item in c_regra_rep_terc_item(cd_regra_p) loop
	
	select  coalesce(max(nr_seq_item),0)
	into STRICT    nr_seq_item_w
	from    regra_repasse_terc_item;
	
	insert into regra_repasse_terc_item(cd_regra,
		nr_seq_item,
		tx_repasse,
		dt_atualizacao,
		nm_usuario,
		ie_beneficiario,
		nr_seq_terceiro,
		cd_conta_contabil,
		vl_repasse,
		ie_perc_saldo,
		ie_restricao_medico,
		ie_gravacao_medico,
		ie_regra_saldo,
		cd_pessoa_fisica,
		ds_observacao,
		tx_anestesista,
		tx_auxiliares,
		tx_custo_operacional,
		tx_materiais,
		tx_medico,
		ie_por_unidade,
		ie_perc_executor,
		ie_funcao_medico,
		dt_inicio_vigencia,
		dt_fim_vigencia,
		nr_seq_categoria,
		ie_tipo_terceiro,
		ie_gera_item_zerado,
		ie_recebe_regra_pontuacao)
	values (cd_regra_w,
		nr_seq_item_w + 1,
		r_c_regra_rep_terc_item.tx_repasse,
		clock_timestamp(),
		nm_usuario_p,
		r_c_regra_rep_terc_item.ie_beneficiario,
		r_c_regra_rep_terc_item.nr_seq_terceiro,
		r_c_regra_rep_terc_item.cd_conta_contabil,
		r_c_regra_rep_terc_item.vl_repasse,
		r_c_regra_rep_terc_item.ie_perc_saldo,
		r_c_regra_rep_terc_item.ie_restricao_medico,
		r_c_regra_rep_terc_item.ie_gravacao_medico,
		r_c_regra_rep_terc_item.ie_regra_saldo,
		r_c_regra_rep_terc_item.cd_pessoa_fisica,
		r_c_regra_rep_terc_item.ds_observacao,
		r_c_regra_rep_terc_item.tx_anestesista,
		r_c_regra_rep_terc_item.tx_auxiliares,
		r_c_regra_rep_terc_item.tx_custo_operacional,
		r_c_regra_rep_terc_item.tx_materiais,
		r_c_regra_rep_terc_item.tx_medico,
		r_c_regra_rep_terc_item.ie_por_unidade,
		r_c_regra_rep_terc_item.ie_perc_executor,
		r_c_regra_rep_terc_item.ie_funcao_medico,
		r_c_regra_rep_terc_item.dt_inicio_vigencia,
		r_c_regra_rep_terc_item.dt_fim_vigencia,
		r_c_regra_rep_terc_item.nr_seq_categoria,
		r_c_regra_rep_terc_item.ie_tipo_terceiro,
		r_c_regra_rep_terc_item.ie_gera_item_zerado,
		r_c_regra_rep_terc_item.ie_recebe_regra_pontuacao);
end loop;

insert into mat_criterio_repasse(nr_sequencia,
	cd_regra,
	dt_atualizacao,
	nm_usuario,
	cd_edicao_amb,
	cd_grupo_material,
	cd_subgrupo_material,
	cd_classe_material,
	cd_material,
	cd_convenio,
	cd_setor_atendimento,
	cd_medico,
	ie_forma_calculo,
	ie_pacote,
	tx_repasse,
	vl_repasse,
	cd_tabela_preco,
	cd_convenio_calc,
	cd_categoria_calc,
	ie_tipo_atendimento,
	ie_tipo_convenio,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	ie_regra_medico,
	cd_cgc_prestador,
	ie_carater_inter_sus,
	cd_municipio_ibge,
	ie_atend_retorno,
	dt_vigencia_inicial,
	dt_vigencia_final,
	cd_tab_preco_calc,
	ie_situacao,
	cd_med_exec_proc_princ,
	ie_repasse_calc,
	cd_cgc_fornecedor,
	cd_plano,
	cd_categoria,
	ie_perc_pacote,
	ie_medico_ind_corpo_cli,
	ie_medico_ind_proc_princ,
	ie_med_exec_pp_corpo_cli,
	ds_function,
	cd_tipo_pessoa,
	ie_rep_auto,
	ie_sexo,
	nr_seq_grupo_rec,
	cd_medico_aval,
	nr_seq_lote_fornec,
	ds_observacao,
	ie_prioridade,
	nr_seq_classificacao,
	ie_honorario,
	cd_especialidade,
	cd_setor_mat_prescr,
	nr_seq_terceiro,
	nr_seq_estagio_conta,
	cd_medico_referido,
	nr_seq_categoria,
	nr_seq_indicacao,
	cd_convenio_atend,
	ie_restrito,
	ie_tipo_terceiro,
	pr_desconto_val_fatur,
	ie_vinculo_medico)
SELECT	nextval('mat_criterio_repasse_seq'),
	cd_regra_w,
	clock_timestamp(),
	nm_usuario_p,
	cd_edicao_amb,
	cd_grupo_material,
	cd_subgrupo_material,
	cd_classe_material,
	cd_material,
	cd_convenio,
	cd_setor_atendimento,
	cd_medico,
	ie_forma_calculo,
	ie_pacote,
	tx_repasse,
	vl_repasse,
	cd_tabela_preco,
	cd_convenio_calc,
	cd_categoria_calc,
	ie_tipo_atendimento,
	ie_tipo_convenio,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	ie_regra_medico,
	cd_cgc_prestador,
	ie_carater_inter_sus,
	cd_municipio_ibge,
	ie_atend_retorno,
	dt_vigencia_inicial,
	dt_vigencia_final,
	cd_tab_preco_calc,
	ie_situacao,
	cd_med_exec_proc_princ,
	ie_repasse_calc,
	cd_cgc_fornecedor,
	cd_plano,
	cd_categoria,
	ie_perc_pacote,
	ie_medico_ind_corpo_cli,
	ie_medico_ind_proc_princ,
	ie_med_exec_pp_corpo_cli,
	ds_function,
	cd_tipo_pessoa,
	ie_rep_auto,
	ie_sexo,
	nr_seq_grupo_rec,
	cd_medico_aval,
	nr_seq_lote_fornec,
	ds_observacao,
	ie_prioridade,
	nr_seq_classificacao,
	ie_honorario,
	cd_especialidade,
	cd_setor_mat_prescr,
	nr_seq_terceiro,
	nr_seq_estagio_conta,
	cd_medico_referido,
	nr_seq_categoria,
	nr_seq_indicacao,
	cd_convenio_atend,
	ie_restrito,
	ie_tipo_terceiro,
	pr_desconto_val_fatur,
	ie_vinculo_medico
from	mat_criterio_repasse
where	cd_regra = cd_regra_p;


insert into proc_criterio_repasse(nr_sequencia,
	ie_funcao,
	cd_regra,
	dt_atualizacao,
	nm_usuario,
	cd_edicao_amb,
	cd_area_proced,
	cd_especial_proced,
	cd_grupo_proced,
	cd_procedimento,
	ie_origem_proced,
	cd_convenio,
	cd_setor_atendimento,
	cd_medico,
	ie_forma_calculo,
	ie_pacote,
	tx_medico,
	tx_anestesista,
	tx_materiais,
	tx_auxiliares,
	tx_custo_operacional,
	vl_repasse,
	cd_tabela_preco,
	cd_convenio_calc,
	cd_categoria_calc,
	ie_tipo_atendimento,
	cd_edicao_amb_calc,
	ie_honorario,
	vl_limite,
	cd_prestador,
	ie_tipo_convenio,
	cd_categoria,
	ie_tipo_servico_sus,
	ie_tipo_ato_sus,
	dt_vigencia_inicial,
	dt_vigencia_final,
	ie_regra_dia,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	cd_grupo_proc_aih,
	hr_inicial,
	hr_final,
	ie_honorario_restricao,
	ie_plantao,
	tx_procedimento,
	ie_perc_pacote,
	ie_carater_inter_sus,
	cd_municipio_ibge,
	nr_seq_grupo,
	nr_seq_subgrupo,
	nr_seq_forma_org,
	cd_registro,
	cd_especialidade,
	cd_medico_laudo,
	cd_situacao_glosa,
	ie_med_exec_socio,
	nr_seq_proc_interno,
	ie_cobra_pf_pj,
	qt_dia_inicial,
	qt_dia_final,
	ie_atend_retorno,
	ie_participou_sus,
	ie_clinica,
	ie_regra_medico,
	nr_seq_exame,
	ie_conveniado,
	cd_equipamento,
	ie_situacao,
	ie_repasse_calc,
	cd_med_exec_proc_princ,
	qt_porte_anestesico,
	cd_procedencia,
	cd_pessoa_func,
	ie_tipo_atend_calc,
	cd_medico_prescr,
	cd_medico_req,
	cd_plano,
	ie_med_plantonista,
	cd_tipo_acomodacao,
	nr_seq_classif_medico,
	ds_function,
	cd_tipo_pessoa,
	cd_tipo_anestesia,
	nr_seq_etapa_checkup,
	ie_rep_auto,
	ie_sexo,
	cd_tipo_pessoa_prest,
	cd_medico_aval,
	ie_via_acesso,
	ds_observacao,
	ie_carater_cirurgia,
	nr_seq_regra_prior_repasse,
	ie_prioridade,
	vl_minimo,
	nr_seq_classificacao,
	tx_proc_minima,
	tx_proc_maxima,
	cd_tipo_procedimento,
	nr_seq_detalhe_sus,
	nr_seq_categoria,
	cd_setor_proc_prescr,
	nr_seq_estagio_autor,
	qt_idade_min,
	qt_idade_max,
	cd_cbo_sus,
	ie_limite_qtdade,
	cd_setor_int_anterior,
	cd_tipo_acomod_atend,
	nr_seq_terceiro,
	nr_seq_estagio_conta,
	cd_medico_cirurgia,
	cd_medico_atend,
	ie_com_material,
	cd_medico_referido,
	nr_seq_indicacao,
	ie_complexidade,
	ie_tipo_financiamento,
	cd_convenio_atend,
	ie_tipo_terceiro,
	ie_considerar_custo_item,
	ie_campo_base_vl_repasse,
	ie_vinculo_medico,
	IE_LIB_LAUDO_PROC)
SELECT	nextval('proc_criterio_repasse_seq'),
	ie_funcao,
	cd_regra_w,
	clock_timestamp(),
	nm_usuario_p,
	cd_edicao_amb,
	cd_area_proced,
	cd_especial_proced,
	cd_grupo_proced,
	cd_procedimento,
	ie_origem_proced,
	cd_convenio,
	cd_setor_atendimento,
	cd_medico,
	ie_forma_calculo,
	ie_pacote,
	tx_medico,
	tx_anestesista,
	tx_materiais,
	tx_auxiliares,
	tx_custo_operacional,
	vl_repasse,
	cd_tabela_preco,
	cd_convenio_calc,
	cd_categoria_calc,
	ie_tipo_atendimento,
	cd_edicao_amb_calc,
	ie_honorario,
	vl_limite,
	cd_prestador,
	ie_tipo_convenio,
	cd_categoria,
	ie_tipo_servico_sus,
	ie_tipo_ato_sus,
	dt_vigencia_inicial,
	dt_vigencia_final,
	ie_regra_dia,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	cd_grupo_proc_aih,
	hr_inicial,
	hr_final,
	ie_honorario_restricao,
	ie_plantao,
	tx_procedimento,
	ie_perc_pacote,
	ie_carater_inter_sus,
	cd_municipio_ibge,
	nr_seq_grupo,
	nr_seq_subgrupo,
	nr_seq_forma_org,
	cd_registro,
	cd_especialidade,
	cd_medico_laudo,
	cd_situacao_glosa,
	ie_med_exec_socio,
	nr_seq_proc_interno,
	ie_cobra_pf_pj,
	qt_dia_inicial,
	qt_dia_final,
	ie_atend_retorno,
	ie_participou_sus,
	ie_clinica,
	ie_regra_medico,
	nr_seq_exame,
	ie_conveniado,
	cd_equipamento,
	ie_situacao,
	ie_repasse_calc,
	cd_med_exec_proc_princ,
	qt_porte_anestesico,
	cd_procedencia,
	cd_pessoa_func,
	ie_tipo_atend_calc,
	cd_medico_prescr,
	cd_medico_req,
	cd_plano,
	ie_med_plantonista,
	cd_tipo_acomodacao,
	nr_seq_classif_medico,
	ds_function,
	cd_tipo_pessoa,
	cd_tipo_anestesia,
	nr_seq_etapa_checkup,
	ie_rep_auto,
	ie_sexo,
	cd_tipo_pessoa_prest,
	cd_medico_aval,
	ie_via_acesso,
	ds_observacao,
	ie_carater_cirurgia,
	nr_seq_regra_prior_repasse,
	ie_prioridade,
	vl_minimo,
	nr_seq_classificacao,
	tx_proc_minima,
	tx_proc_maxima,
	cd_tipo_procedimento,
	nr_seq_detalhe_sus,
	nr_seq_categoria,
	cd_setor_proc_prescr,
	nr_seq_estagio_autor,
	qt_idade_min,
	qt_idade_max,
	cd_cbo_sus,
	ie_limite_qtdade,
	cd_setor_int_anterior,
	cd_tipo_acomod_atend,
	nr_seq_terceiro,
	nr_seq_estagio_conta,
	cd_medico_cirurgia,
	cd_medico_atend,
	ie_com_material,
	cd_medico_referido,
	nr_seq_indicacao,
	ie_complexidade,
	ie_tipo_financiamento,
	cd_convenio_atend,
	ie_tipo_terceiro,
	ie_considerar_custo_item,
	ie_campo_base_vl_repasse,
	ie_vinculo_medico,
	IE_LIB_LAUDO_PROC
from	proc_criterio_repasse
where	cd_regra = cd_regra_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_regra_repace (cd_regra_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

