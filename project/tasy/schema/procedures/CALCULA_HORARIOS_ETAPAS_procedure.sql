-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcula_horarios_etapas ( qt_hora_p timestamp, nr_horarios_p bigint, nr_horas_intervalo_p bigint, nm_usuario_p text, ie_horario_solucao_p text, qt_tempo_aplicacao_p bigint, ds_horarios_p INOUT text, ds_horarios_2p INOUT text, ie_etapa_esp_p text, ie_hemodialise_p text ) AS $body$
DECLARE


    i                      bigint := 1;
    ds_horario_w           varchar(2000) := '';
    qt_hora_w              timestamp;
    qt_hora_ww             double precision;
    mascara_w              varchar(10);
    ie_horario_continuo_w  varchar(1);
    ie_arredonda_etapa_w   varchar(1);
    sql_w                  varchar(300);
    ds_erro_w              varchar(4000);
    ds_parametros_w        varchar(4000);

BEGIN
    ie_horario_continuo_w := obter_param_usuario(924, 251, obter_perfil_ativo, nm_usuario_p, 0, ie_horario_continuo_w);
    ie_arredonda_etapa_w := obter_param_usuario(924, 866, obter_perfil_ativo, nm_usuario_p, 0, ie_arredonda_etapa_w);
    IF ( to_char(qt_hora_p, 'mi') <> '00' ) OR ( trunc(nr_horas_intervalo_p) <> nr_horas_intervalo_p ) THEN --Tratar quando o medico prescrver em minutos
        mascara_w := 'hh24:mi';
    ELSE
        mascara_w := 'hh24';
    END IF;

    IF (qt_hora_p IS NOT NULL AND qt_hora_p::text <> '')
        AND ( nr_horarios_p > 0 )
    THEN
        BEGIN
            qt_hora_w := qt_hora_p;

	--INICIO MD 1
    --CALCULAR_HORA_ETAPA_MD
            BEGIN
                sql_w := 'begin CALCULAR_HORA_ETAPA_MD(:1, :2, :3, :4, :5, :6, :7, :8,:9, :10); end;';
                EXECUTE sql_w
                    USING IN ie_horario_continuo_w, IN ie_hemodialise_p, IN nr_horarios_p, IN nr_horas_intervalo_p, IN mascara_w,
                    IN ie_horario_solucao_p, IN ie_etapa_esp_p, IN qt_tempo_aplicacao_p, IN OUT qt_hora_w, IN OUT ds_horario_w;

            EXCEPTION
                WHEN OTHERS THEN
                    ds_erro_w := sqlerrm;
                    ds_parametros_w := ( 'qt_hora_p: '
                                         || qt_hora_p
                                         || '-'
                                         || 'ds_horarios_p: '
                                         || ds_horarios_p
                                         || '-'
                                         || 'ds_horarios_2p: '
                                         || ds_horarios_2p
                                         || '-'
                                         || 'ie_horario_continuo_w: '
                                         || ie_horario_continuo_w
                                         || '-'
                                         || 'ie_hemodialise_p: '
                                         || ie_hemodialise_p
                                         || '-'
                                         || 'nr_horarios_p: '
                                         || nr_horarios_p
                                         || '-'
                                         || 'nr_horas_intervalo_p: '
                                         || nr_horas_intervalo_p
                                         || '-'
                                         || 'mascara_w: '
                                         || mascara_w
                                         || '-'
                                         || 'ie_horario_solucao_p: '
                                         || ie_horario_solucao_p
                                         || '-'
                                         || 'ie_etapa_esp_p: '
                                         || ie_etapa_esp_p
                                         || '-'
                                         || 'qt_tempo_aplicacao_p: '
                                         || qt_tempo_aplicacao_p
                                         || '-'
                                         || 'qt_hora_w: '
                                         || qt_hora_w
                                         || '-'
                                         || 'ds_horario_w: '
                                         || ds_horario_w );

                    CALL gravar_log_medical_device('calcula_horarios_etapas',
                                             'CALCULAR_HORA_ETAPA_MD',
                                             ds_parametros_w,
                                             ds_erro_w,
                                             wheb_usuario_pck.get_nm_usuario,
                                             'S');
                    ds_horario_w := NULL;
                    qt_hora_w := NULL;
            END;
  	
   -- FIM MD
        END;
    END IF;

    ds_horarios_p := substr(ds_horario_w, 1, 254);
    ds_horarios_2p := substr(ds_horario_w, 255, 255);
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcula_horarios_etapas ( qt_hora_p timestamp, nr_horarios_p bigint, nr_horas_intervalo_p bigint, nm_usuario_p text, ie_horario_solucao_p text, qt_tempo_aplicacao_p bigint, ds_horarios_p INOUT text, ds_horarios_2p INOUT text, ie_etapa_esp_p text, ie_hemodialise_p text ) FROM PUBLIC;

