-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE proj_liberar_rat ( nr_seq_rat_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
qt_min_ativ_w		bigint;
qt_exec_w		bigint;
qt_reg_w		bigint;
cd_executor_w		varchar(10);
nr_seq_proj_w		bigint;
dt_inicio_w		timestamp;
ie_altera_agenda_w	varchar(1);
cd_estabelecimento_w	smallint;
nr_seq_cliente_w	bigint;
ie_comunic_interna_w	varchar(1);
cd_coordenador_w	varchar(10);
nm_usuario_coord_w	varchar(15);
ds_titulo_w		varchar(80);
nr_sequencia_w		bigint;
ds_cliente_w		varchar(255);
dt_liberacao_w		timestamp;


BEGIN 
 
select	coalesce(sum(qt_min_ativ),0) 
into STRICT	qt_min_ativ_w 
from	proj_rat_ativ 
where	nr_seq_rat	= nr_seq_rat_p;
 
select 	count(distinct trunc(dt_inicio_ativ,'dd')) qt_exec, 
	count(distinct trunc(dt_atualizacao,'dd')) qt_reg 
into STRICT	qt_exec_w, 
	qt_reg_w 
from	proj_rat_ativ 
where	nr_seq_rat = nr_seq_rat_p;
 
update	proj_rat 
set	dt_liberacao		= clock_timestamp(), 
	nm_usuario_lib		= nm_usuario_p, 
	qt_total_hora		= dividir(qt_min_ativ_w, 60), 
	vl_hora_cobrar		= 0, 
	qt_hora_cobrar		= dividir(qt_min_ativ_w, 60), 
	vl_cobrar_cliente	= 0, 
	vl_hora_pagar		= 0, 
	vl_pagar		= 0, 
	qt_hora_pagar		= dividir(qt_min_ativ_w, 60), 
	dt_atualizacao		= clock_timestamp(), 
	nm_usuario		= nm_usuario_p, 
	qt_dia_exec		= qt_exec_w, 
	qt_dia_reg		= qt_reg_w 
where	nr_sequencia		= nr_seq_rat_p;
 
commit;
 
select	max(cd_estabelecimento) 
into STRICT	cd_estabelecimento_w 
from	usuario 
where	nm_usuario = nm_usuario_p;
 
ie_altera_agenda_w := Obter_Param_Usuario(993, 91, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_altera_agenda_w);
ie_comunic_interna_w := Obter_Param_Usuario(993, 137, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_comunic_interna_w);
 
if (ie_altera_agenda_w = 'S') then 
 
	select	cd_executor, 
		nr_seq_proj, 
		dt_inicio 
	into STRICT	cd_executor_w, 
		nr_seq_proj_w, 
		dt_inicio_w 
	from	proj_rat 
	where	nr_sequencia = nr_seq_rat_p;
 
	 
	update	proj_agenda 
	set	ie_status 	= 'Executada' 
	where	cd_consultor 	= cd_executor_w 
	and	nr_seq_proj	= nr_seq_proj_w 
	and	trunc(dt_agenda,'dd')	= trunc(dt_inicio_w,'dd');
 
	commit;
end if;
 
if (ie_comunic_interna_w = 'S') then	 
 
	select	max(nr_seq_cliente), 
		max(nr_seq_proj), 
		max(dt_liberacao) 
	into STRICT	nr_seq_cliente_w, 
		nr_seq_proj_w, 
		dt_liberacao_w 
	from	proj_rat 
	where	nr_sequencia = nr_seq_rat_p;
 
	select	max(cd_coordenador), 
		max(ds_titulo), 
		max(nr_sequencia), 
		max(substr(obter_desc_cliente(nr_seq_cliente,'F'),1,254)) 
	into STRICT	cd_coordenador_w, 
		ds_titulo_w, 
		nr_sequencia_w, 
		ds_cliente_w 
	from	proj_projeto 
	where	nr_seq_cliente = nr_seq_cliente_w 
	and	(cd_coordenador IS NOT NULL AND cd_coordenador::text <> '') 
	and	nr_sequencia = coalesce(nr_seq_proj_w,nr_sequencia);
 
	select	max(nm_usuario) 
	into STRICT	nm_usuario_coord_w 
	from	usuario 
	where	cd_pessoa_fisica = cd_coordenador_w 
	and	ie_situacao = 'A';
 
	if (nm_usuario_coord_w IS NOT NULL AND nm_usuario_coord_w::text <> '') then 
 
		CALL gerar_comunic_padrao(	clock_timestamp(), 
					'Liberação de RAT', 
					'Realizada a liberação do RAT '||nr_seq_rat_p||chr(13)||chr(10)||chr(13)||chr(10)|| 
					'Projeto: '|| nr_sequencia_w ||' - '||ds_titulo_w||chr(13)||chr(10)|| 
					'Cliente: '||ds_cliente_w ||chr(13)||chr(10)|| 
					'Data de liberação: ' || to_char(dt_liberacao_w,'dd/mm/yyyy hh24:mi:ss'), 
					nm_usuario_p, 
					'N', 
					nm_usuario_coord_w, 
					'N', 
					null, 
					'', 
					'', 
					'', 
					clock_timestamp(), 
					'', 
					'');
	end if;
 
end if;
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proj_liberar_rat ( nr_seq_rat_p bigint, nm_usuario_p text) FROM PUBLIC;

