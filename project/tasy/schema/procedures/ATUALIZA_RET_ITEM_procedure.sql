-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_ret_item (nm_usuario_p text, ie_analisada_p text, nr_seq_ret_item_p bigint, nr_seq_protocolo_p bigint, nr_seq_retorno_p bigint, permite_analizar_p text) AS $body$
DECLARE


restricao_w varchar(300);


BEGIN

if (permite_analizar_p = 'H')then
	begin

		restricao_w := 'and (nvl(a.vl_amenor,0) = 0 or a.ie_analisada = '|| chr(39) ||'S'|| chr(39) ||' or '||
                                             ' not exists  (select  1 ' ||
                                             '              from     convenio_retorno_glosa x '||
                                             '              where    x.nr_seq_conpaci_ret_hist  is null '||
                                             '              and      x.nr_seq_ret_item          = a.nr_sequencia))';

	end;
else
	begin
		restricao_w := '';
	end;
end if;

if (ie_analisada_p IS NOT NULL AND ie_analisada_p::text <> '')and (nr_seq_protocolo_p IS NOT NULL AND nr_seq_protocolo_p::text <> '')then
	begin
	CALL EXEC_SQL_DINAMICO(nm_usuario_p,	' update   convenio_retorno_item a ' ||
					' set      ' || chr(39) ||ie_analisada_p|| chr(39) ||
					' where    1  = 1  '|| chr(39) ||
					restricao_w|| chr(39) ||
					' and      nr_sequencia   in '||
					'           (select  b.nr_sequencia '||
					'           from     convenio_retorno_item b, '||
					'                    conta_paciente a '||
					'           where    b.nr_sequencia       <> '|| chr(39) ||nr_seq_ret_item_p|| chr(39) ||
					'           and      a.nr_interno_conta   = b.nr_interno_conta '||
					'           and      a.nr_seq_protocolo   = '|| chr(39) ||nr_seq_protocolo_p|| chr(39) ||') '||
					'  and      nr_seq_retorno = '|| chr(39) ||nr_seq_retorno_p|| chr(39));
	commit;
	end;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_ret_item (nm_usuario_p text, ie_analisada_p text, nr_seq_ret_item_p bigint, nr_seq_protocolo_p bigint, nr_seq_retorno_p bigint, permite_analizar_p text) FROM PUBLIC;

