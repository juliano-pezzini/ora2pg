-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cp_create_interv_plan_assoc ( nr_seq_interv_plan_p cp_interv_plan_assoc.nr_seq_interv_plan%type, ds_unique_value_p cp_intervention.ds_unique_value%type, nm_usuario_p cp_interv_plan_assoc.nm_usuario%type ) AS $body$
DECLARE


nr_seq_intervention_w		cp_interv_plan_assoc.nr_seq_intervention%type;
nr_sequencia_w			cp_interv_plan_assoc.nr_sequencia%type;
si_record_changed_w		cp_intervention.si_record_changed%type;
nr_seq_old_care_plan_w		care_plan.nr_sequencia%type;


BEGIN

begin
	select	i.nr_sequencia,
		ia.nr_sequencia,
		i.si_record_changed
	into STRICT	nr_seq_intervention_w,
		nr_sequencia_w,
		si_record_changed_w
	from	cp_intervention i
		left outer join cp_interv_plan_assoc ia on ia.nr_seq_interv_plan = nr_seq_interv_plan_p and ia.nr_seq_intervention = i.nr_sequencia
	where	i.nr_sequencia = (
		SELECT	max(nr_sequencia)
		from	cp_intervention
		where	ds_unique_value = ds_unique_value_p
	);
exception
	when no_data_found then
	begin
		nr_seq_intervention_w	:= null;
		nr_sequencia_w		:= null;
	end;
end;

if (nr_seq_intervention_w IS NOT NULL AND nr_seq_intervention_w::text <> '') then
	
	select	max(get_old_care_plan(nr_seq_care_plan))
	into STRICT	nr_seq_old_care_plan_w
	from	cp_possible_prob a,
		cp_interv_plan b
	where	a.nr_sequencia = b.nr_seq_possible_prob	
	and	b.nr_sequencia = nr_seq_interv_plan_p;
	
	if (nr_seq_old_care_plan_w IS NOT NULL AND nr_seq_old_care_plan_w::text <> '') and (si_record_changed_w = 'N') then
		
		select	CASE WHEN count(1)=0 THEN  'Y'  ELSE 'N' END
		into STRICT	si_record_changed_w
		from	cp_intervention a,
			cp_interv_plan_assoc b,
			cp_interv_plan c,
			cp_possible_prob d
		where	a.nr_sequencia = b.nr_seq_intervention
		and	c.nr_sequencia = b.nr_seq_interv_plan
		and	d.nr_sequencia = c.nr_seq_possible_prob
		and	a.ds_unique_value = ds_unique_value_p
		and	d.nr_seq_care_plan = nr_seq_old_care_plan_w;
	end if;	
	
	select	nextval('cp_interv_plan_assoc_seq')
	into STRICT	nr_sequencia_w
	;
	
	insert into cp_interv_plan_assoc(
		nr_sequencia,
		nr_seq_interv_plan,
		nr_seq_intervention,
		ie_origin,
		si_import_status,
		ie_situacao,
		nm_usuario,
		dt_atualizacao,
		nm_usuario_nrec,
		dt_atualizacao_nrec,
		si_record_changed
	) values (
		nr_sequencia_w,
		nr_seq_interv_plan_p,
		nr_seq_intervention_w,
		'E', -- From Elsevier
		'SP',
		'I',
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		coalesce(si_record_changed_w, 'N')
	);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cp_create_interv_plan_assoc ( nr_seq_interv_plan_p cp_interv_plan_assoc.nr_seq_interv_plan%type, ds_unique_value_p cp_intervention.ds_unique_value%type, nm_usuario_p cp_interv_plan_assoc.nm_usuario%type ) FROM PUBLIC;

