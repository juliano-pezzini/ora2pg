-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mx_cfdi_vincular_nf ( nr_seq_nf_imp_p bigint, nr_seq_nf_p bigint, ie_confirm_p text, ie_commit_p text, ds_msg_p INOUT text, ie_somente_consiste_p text) AS $body$
DECLARE


nr_uuid_w nf_imp_nota.nr_uuid%type;
vl_total_nota_w nf_imp_nota.vl_total%type	:= null;
cd_serie_nf_w nf_imp_nota.ds_serie%type;
nr_nota_fiscal_w nf_imp_nota.ds_numero%type;
dt_emissao_w nf_imp_nota.dt_emissao%type;
nr_seq_nf_imp_w nf_imp_nota.nr_sequencia%type;
nr_seq_anterior_w	bigint;

cd_cgc_w pessoa_juridica.cd_cgc%type;
cd_pessoa_fisica_w pessoa_fisica.cd_pessoa_fisica%type;
nr_seq_nf_w nota_fiscal.nr_sequencia%type;
cd_rfc_w		pessoa_juridica.cd_rfc%type;
nota_encontrada_w	nota_fiscal.nr_nota_fiscal%type;
nr_nota_importada_w	nota_fiscal.nr_nfe_imp%type;

qt_inconsistencia_w	bigint	:= 0;
qt_encontrada_w		bigint;
count_notas_w		bigint;

ds_erro_w varchar(2000) := 'XPTO';
qt_sem_nota_w		bigint;
count_nf_encontradas_w  bigint;
qtd_vinc_w        	bigint;
type tb_fields_ignore  is table of varchar(50);
tb_fields_ignore_w  tb_fields_ignore;


c_notas CURSOR FOR
	SELECT	'Tasy' ie_tipo,
			nr_sequencia,
			'PJ' ds_field_ignore
	from	nota_fiscal nf
	where	nf.vl_total_nota = vl_total_nota_w
	and	((cd_serie_nf = cd_serie_nf_w) or (CASE WHEN cd_serie_nf_w='' THEN '0'  ELSE cd_serie_nf_w END  = '0'))
	and		nf.nr_nota_fiscal = nr_nota_fiscal_w
	and		nf.dt_emissao between Trunc(dt_emissao_w,'dd') and fim_dia(dt_emissao_w)
	and		((nf.nr_sequencia = nr_seq_nf_p) or (coalesce(nr_seq_nf_p::text, '') = ''))
	and	nf.ie_situacao = '1'
	and		coalesce(nf.nr_nfe_imp::text, '') = ''
	and		nf.ie_tipo_nota = 'EN'
	and		nr_seq_nf_imp_p > 0
	
union all

	SELECT	'Tasy' ie_tipo,
			nr_sequencia,
			'VL' ds_field_ignore
	from	nota_fiscal nf
	where	cd_cgc_emitente in (select cd_cgc from pessoa_juridica where cd_rfc = cd_rfc_w)
	and		((cd_pessoa_fisica_w = cd_pessoa_fisica) or coalesce(cd_pessoa_fisica_w::text, '') = '')
	and ((cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') or (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> ''))
	and	((cd_serie_nf = cd_serie_nf_w) or (CASE WHEN cd_serie_nf_w='' THEN '0'  ELSE cd_serie_nf_w END  = '0'))
	and		nf.nr_nota_fiscal = nr_nota_fiscal_w
	and		nf.dt_emissao between Trunc(dt_emissao_w,'dd') and fim_dia(dt_emissao_w)
	and		((nf.nr_sequencia = nr_seq_nf_p) or (coalesce(nr_seq_nf_p::text, '') = ''))
	and		nf.ie_situacao = '1'
	and		coalesce(nf.nr_nfe_imp::text, '') = ''
	and		nf.ie_tipo_nota = 'EN'
	and		nr_seq_nf_imp_p > 0
	
union all

	select	'Tasy' ie_tipo,
			nr_sequencia,
			'SER' ds_field_ignore
	from	nota_fiscal nf
	where	cd_cgc_emitente in (select cd_cgc from pessoa_juridica where cd_rfc = cd_rfc_w)
	and		((cd_pessoa_fisica_w = cd_pessoa_fisica) or coalesce(cd_pessoa_fisica_w::text, '') = '')
	and ((cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') or (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> ''))
	and		nf.vl_total_nota = vl_total_nota_w
	and		nf.nr_nota_fiscal = nr_nota_fiscal_w
	and		nf.dt_emissao between Trunc(dt_emissao_w,'dd') and fim_dia(dt_emissao_w)
	and		((nf.nr_sequencia = nr_seq_nf_p) or (coalesce(nr_seq_nf_p::text, '') = ''))
	and		coalesce(nf.nr_nfe_imp::text, '') = ''
	and		nf.ie_situacao = '1'
	and		nf.ie_tipo_nota = 'EN'
	and		nr_seq_nf_imp_p > 0
	
union all

	select	'Tasy' ie_tipo,
			nr_sequencia,
			'NR' ds_field_ignore
	from	nota_fiscal nf
	where	cd_cgc_emitente in (select cd_cgc from pessoa_juridica where cd_rfc = cd_rfc_w)
	and		((cd_pessoa_fisica_w = cd_pessoa_fisica) or coalesce(cd_pessoa_fisica_w::text, '') = '')
	and ((cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') or (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> ''))
	and		nf.vl_total_nota = vl_total_nota_w
	and	((cd_serie_nf = cd_serie_nf_w) or (CASE WHEN cd_serie_nf_w='' THEN '0'  ELSE cd_serie_nf_w END  = '0'))
	and		nf.ie_situacao = '1'
	and		nf.dt_emissao between Trunc(dt_emissao_w,'dd') and fim_dia(dt_emissao_w)
	and		((nf.nr_sequencia = nr_seq_nf_p) or (coalesce(nr_seq_nf_p::text, '') = ''))
	and		coalesce(nf.nr_nfe_imp::text, '') = ''
	and		nf.ie_tipo_nota = 'EN'
	and		nr_seq_nf_imp_p > 0
	
union all

	select	'Tasy' ie_tipo,
			nr_sequencia,
			'DTE' ds_field_ignore
	from	nota_fiscal nf
	where	cd_cgc_emitente in (select cd_cgc from pessoa_juridica where cd_rfc = cd_rfc_w)
	and		((cd_pessoa_fisica_w = cd_pessoa_fisica) or coalesce(cd_pessoa_fisica_w::text, '') = '')
	and ((cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') or (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> ''))
	and		nf.vl_total_nota = vl_total_nota_w
	and	((cd_serie_nf = cd_serie_nf_w) or (CASE WHEN cd_serie_nf_w='' THEN '0'  ELSE cd_serie_nf_w END  = '0'))
	and		nf.nr_nota_fiscal = nr_nota_fiscal_w
	and		((nf.nr_sequencia = nr_seq_nf_p) or (coalesce(nr_seq_nf_p::text, '') = ''))
	and		coalesce(nf.nr_nfe_imp::text, '') = ''
	and		nf.ie_situacao = '1'
	and		nf.ie_tipo_nota = 'EN'
	and		nr_seq_nf_imp_p > 0
	
union all

	select	'Importada' ie_tipo,
			nr_sequencia,
			'PJ' ds_field_ignore
	from	nf_imp_nota nf
	where	nf.vl_total = vl_total_nota_w
	and		substr(nf.ds_serie,1,5) = cd_serie_nf_w
	and		nf.nr_numero = (nr_nota_fiscal_w)::numeric
	and		nf.dt_emissao between trunc(dt_emissao_w,'dd') and fim_dia(dt_emissao_w)
	and		((nf.nr_sequencia = nr_seq_nf_imp_p) or (coalesce(nr_seq_nf_imp_p::text, '') = ''))
	and		not exists (select	1
						from	nf_imp_nota_inc_vinculo x
						where	x.nr_seq_imp_nota = nf.nr_sequencia)
	and		nr_seq_nf_p > 0
	
union all

	select	'Importada' ie_tipo,
			nr_sequencia,
			'VL' ds_field_ignore
	from	nf_imp_nota nf
	where	nf.nr_ident_emissor = cd_rfc_w
	and		substr(nf.ds_serie,1,5) = cd_serie_nf_w
	and		nf.nr_numero = (nr_nota_fiscal_w)::numeric 
	and		nf.dt_emissao between trunc(dt_emissao_w,'dd') and fim_dia(dt_emissao_w)
	and		((nf.nr_sequencia = nr_seq_nf_imp_p) or (coalesce(nr_seq_nf_imp_p::text, '') = ''))
	and		not exists (select	1
						from	nf_imp_nota_inc_vinculo x
						where	x.nr_seq_imp_nota = nf.nr_sequencia)
	and		nr_seq_nf_p > 0
	
union all

	select	'Importada' ie_tipo,
			nr_sequencia,
			'SER' ds_field_ignore
	from	nf_imp_nota nf
	where	nf.nr_ident_emissor = cd_rfc_w
	and		nf.vl_total = vl_total_nota_w
	and		nf.nr_numero = (nr_nota_fiscal_w)::numeric 
	and		nf.dt_emissao between trunc(dt_emissao_w,'dd') and fim_dia(dt_emissao_w)
	and		((nf.nr_sequencia = nr_seq_nf_imp_p) or (coalesce(nr_seq_nf_imp_p::text, '') = ''))
	and		not exists (select	1
						from	nf_imp_nota_inc_vinculo x
						where	x.nr_seq_imp_nota = nf.nr_sequencia)
	and		nr_seq_nf_p > 0
	
union all

	select	'Importada' ie_tipo,
			nr_sequencia,
			'NR' ds_field_ignore
	from	nf_imp_nota nf
	where	nf.nr_ident_emissor = cd_rfc_w
	and		nf.vl_total = vl_total_nota_w
	and		substr(nf.ds_serie,1,5) = cd_serie_nf_w
	and		nf.dt_emissao between trunc(dt_emissao_w,'dd') and fim_dia(dt_emissao_w)
	and		((nf.nr_sequencia = nr_seq_nf_imp_p) or (coalesce(nr_seq_nf_imp_p::text, '') = ''))
	and		not exists (select	1
						from	nf_imp_nota_inc_vinculo x
						where	x.nr_seq_imp_nota = nf.nr_sequencia)
	and		nr_seq_nf_p > 0
	
union all

	select	'Importada' ie_tipo,
			nr_sequencia,
			'DTE' ds_field_ignore
	from	nf_imp_nota nf
	where	nf.nr_ident_emissor = cd_rfc_w
	and		nf.vl_total = vl_total_nota_w
	and		substr(nf.ds_serie,1,5) = cd_serie_nf_w
	and		nf.nr_numero = (nr_nota_fiscal_w)::numeric 
	and		((nf.nr_sequencia = nr_seq_nf_imp_p) or (coalesce(nr_seq_nf_imp_p::text, '') = ''))
	and		not exists (select	1
						from	nf_imp_nota_inc_vinculo x
						where	x.nr_seq_imp_nota = nf.nr_sequencia)
	and		nr_seq_nf_p > 0;


procedure insert_inconsistencia(	nr_seq_nf_imp_pp		bigint,
									nr_seq_nf_pp 		bigint,
									ie_inconsistencia_p text) IS

count_w bigint := 0;

BEGIN

	if (ie_somente_consiste_p = 'N') then

		select count(1)
		into STRICT  count_w
		from  nf_imp_nota_inc_vinculo
		where nr_seq_imp_nota = nr_seq_nf_imp_pp
		and  nr_seq_nota_fiscal = nr_seq_nf_pp
		and  ie_inconsistencia = ie_inconsistencia_p;
		
		if (count_w = 0 and (nr_seq_nf_imp_pp IS NOT NULL AND nr_seq_nf_imp_pp::text <> '')) then

			insert into nf_imp_nota_inc_vinculo(nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_seq_imp_nota,
							nr_seq_nota_fiscal,
							ie_inconsistencia)
			values (nextval('nf_imp_nota_inc_vinculo_seq'),
							clock_timestamp(),
							coalesce(wheb_usuario_pck.get_nm_usuario(), 'tasy'),
							clock_timestamp(),
							coalesce(wheb_usuario_pck.get_nm_usuario(), 'tasy'),
							nr_seq_nf_imp_pp,
							nr_seq_nf_pp,
							ie_inconsistencia_p);

		end if;
		qt_inconsistencia_w	:= qt_inconsistencia_w + 1;

	end if;
end;

procedure realizar_vinculo_nf(	nr_seq_imp_nota_p	 number,
								nr_seq_nota_fiscal_p number,
								ds_msg_pp			 varchar2,
								ie_confirm_pp		 varchar2) IS
begin


if (coalesce(ds_msg_pp, 'XPTO') = 'XPTO') then


	update	nf_imp_nota
	set		nr_seq_nf_interno = nr_seq_nota_fiscal_p
	where	nr_sequencia = nr_seq_imp_nota_p;

	select	max(nr_uuid)
	into STRICT	nr_uuid_w
	from	nf_imp_nota
	where	nr_sequencia = nr_seq_imp_nota_p;


	if (coalesce(nr_uuid_w, 'XPTO') <> 'XPTO') then
		update	nota_fiscal
		set		nr_nfe_imp = nr_uuid_w
		where	nr_sequencia = nr_seq_nota_fiscal_p;
	end if;

	if (coalesce(ie_confirm_pp, 'N') = 'S') then
		update	nf_imp_nota_inc_vinculo
		set		ie_vinculacao_forcada = ie_confirm_pp
		where	nr_seq_imp_nota = nr_seq_imp_nota_p
		and		nr_seq_nota_fiscal = nr_seq_nota_fiscal_p;
	end if;
end if;

end;

begin
if	((nr_seq_nf_imp_p > 0) or (nr_seq_nf_p > 0)) then
	if (nr_seq_nf_imp_p > 0) then
	
				select	vl_total,
				substr(ds_serie,1,5),
				obter_somente_numero(ds_numero),
				dt_emissao,
				(select	max(x.cd_cgc)
				from	pessoa_juridica x
				where	x.cd_rfc = n.nr_ident_emissor) cd_cgc,
				(select	max(x.cd_pessoa_fisica)
				from	pessoa_fisica x
				where	x.cd_rfc = n.nr_ident_emissor) cd_pessoa_fisica
		into STRICT	vl_total_nota_w,
				cd_serie_nf_w,
				nr_nota_fiscal_w,
				dt_emissao_w,
				cd_cgc_w,
				cd_pessoa_fisica_w
		from	nf_imp_nota n
		where	n.nr_sequencia = nr_seq_nf_imp_p;

		if (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') then
			select	a.cd_rfc
			into STRICT	cd_rfc_w
			from	pessoa_juridica a
			where	a.cd_cgc	= cd_cgc_w;
		elsif (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
			select	a.cd_rfc
			into STRICT	cd_rfc_w
			from	pessoa_fisica a
			where	a.cd_pessoa_fisica	= cd_pessoa_fisica_w;
		end if;

		select	max(nf.nr_sequencia),
				count(1)
		into STRICT	nr_seq_nf_w,
				qt_encontrada_w
		from	nota_fiscal nf
		where	cd_cgc_emitente in (SELECT cd_cgc from pessoa_juridica where cd_rfc = cd_rfc_w)
		and		((cd_pessoa_fisica_w = cd_pessoa_fisica) or coalesce(cd_pessoa_fisica_w::text, '') = '')
		and		nf.vl_total_nota = vl_total_nota_w
		and	((cd_serie_nf = cd_serie_nf_w) or (CASE WHEN cd_serie_nf_w='' THEN '0'  ELSE cd_serie_nf_w END  = '0'))
		and		nf.nr_nota_fiscal = nr_nota_fiscal_w
		and		nf.dt_emissao between Trunc(dt_emissao_w,'dd') and fim_dia(dt_emissao_w)
		and		((nf.nr_sequencia = nr_seq_nf_p) or (coalesce(nr_seq_nf_p::text, '') = ''))
		and		coalesce(nf.nr_nfe_imp::text, '') = ''
		and		nf.ie_tipo_nota = 'EN';


		if (qt_encontrada_w = 1) then
			nr_seq_nf_imp_w := nr_seq_nf_imp_p;
		end if;
	elsif (nr_seq_nf_p > 0) then

		select	vl_total_nota,
				substr(cd_serie_nf,1,5),
				nr_nota_fiscal,
				dt_emissao,
				cd_cgc_emitente,
				cd_pessoa_fisica
		into STRICT	vl_total_nota_w,
				cd_serie_nf_w,
				nr_nota_fiscal_w,
				dt_emissao_w,
				cd_cgc_w,
				cd_pessoa_fisica_w
		from	nota_fiscal n
		where	n.nr_sequencia = nr_seq_nf_p;


		if (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') then
			select	a.cd_rfc
			into STRICT	cd_rfc_w
			from	pessoa_juridica a
			where	a.cd_cgc	= cd_cgc_w;
		elsif (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
			select	a.cd_rfc
			into STRICT	cd_rfc_w
			from	pessoa_fisica a
			where	a.cd_pessoa_fisica	= cd_pessoa_fisica_w;
		end if;

		select	max(nf.nr_sequencia),
				count(1)
		into STRICT	nr_seq_nf_imp_w,
				qt_encontrada_w
		from	nf_imp_nota nf
		where	nf.nr_ident_emissor = cd_rfc_w
		and		nf.vl_total = vl_total_nota_w
		and		substr(nf.ds_serie,1,5) = cd_serie_nf_w
		and		nf.nr_numero = (nr_nota_fiscal_w)::numeric
		and		nf.dt_emissao between trunc(dt_emissao_w,'dd') and fim_dia(dt_emissao_w)
		and		((nf.nr_sequencia = nr_seq_nf_imp_p) or (coalesce(nr_seq_nf_imp_p::text, '') = ''))
		and		not exists (SELECT	1
							from	nf_imp_nota_inc_vinculo x
							where	x.nr_seq_imp_nota = nf.nr_sequencia);

		if (qt_encontrada_w = 1) then
			nr_seq_nf_w := nr_seq_nf_p;
		end if;

	end if;

	ds_erro_w := 'XPTO';
	ds_msg_p	:= null;
	if (vl_total_nota_w >= 0) and (qt_encontrada_w <> 1) then
		nr_seq_anterior_w	:= 0;
		qt_inconsistencia_w	:= 0;
		count_notas_w := 0;

		nr_seq_nf_imp_w := nr_seq_nf_imp_p;
		nr_seq_nf_w	:= nr_seq_nf_p;

		for r_c_notas in c_notas loop
			ds_erro_w := 'XPTO';
			count_notas_w := c_notas%ROWCOUNT;

			if (nr_seq_nf_imp_p > 0) then
				nr_seq_nf_w	:= r_c_notas.nr_sequencia;
			elsif (nr_seq_nf_p > 0) then
				nr_seq_nf_imp_w := r_c_notas.nr_sequencia;
			end if;


			if (nr_seq_anterior_w <> r_c_notas.nr_sequencia) and (nr_seq_anterior_w > 0)then
				ds_erro_w := ds_erro_w || obter_descricao_dominio(8930, 'MNC') || r_c_notas.nr_sequencia;
				insert_inconsistencia(nr_seq_nf_imp_w, nr_seq_nf_w, 'MNC');
			elsif ('PJ' = r_c_notas.ds_field_ignore) then
				ds_erro_w := obter_desc_expressao(873863);
				insert_inconsistencia(nr_seq_nf_imp_w, nr_seq_nf_w, 'PJ');
			elsif ('VL' = r_c_notas.ds_field_ignore) then
				ds_erro_w := obter_desc_expressao(873861);
				insert_inconsistencia(nr_seq_nf_imp_w, nr_seq_nf_w, 'VL');
			elsif ('DTE' = r_c_notas.ds_field_ignore) then
				ds_erro_w := obter_desc_expressao(873859);
				insert_inconsistencia(nr_seq_nf_imp_w, nr_seq_nf_w, 'DTE');
			elsif ('NR' = r_c_notas.ds_field_ignore) then
				ds_erro_w := obter_desc_expressao(873857);
				insert_inconsistencia(nr_seq_nf_imp_w, nr_seq_nf_w, 'NR');
			elsif ('SER' = r_c_notas.ds_field_ignore) then
				ds_erro_w := obter_desc_expressao(873853);
				insert_inconsistencia(nr_seq_nf_imp_w, nr_seq_nf_w, 'SER');
			end if;


			if (coalesce(ds_erro_w, 'XPTO') <> 'XPTO') then
				ds_msg_p := substr(ds_erro_w || ';' || ds_msg_p,1,2000);
			end if;


			nr_seq_anterior_w	:= r_c_notas.nr_sequencia;
		end loop;


		if (qt_inconsistencia_w = 0) then
			ds_msg_p := obter_descricao_dominio(8930, 'SNC') || ';' || ds_msg_p;
			insert_inconsistencia(nr_seq_nf_imp_w, nr_seq_nf_w, 'SNC');
			commit;
		end if;


		if (count_notas_w = 0) and (nr_seq_nf_imp_p > 0) then
		
				select	max(nr_uuid)
				into STRICT	nr_uuid_w
				from	nf_imp_nota
				where	nr_sequencia = nr_seq_nf_imp_w;

				if (nr_uuid_w IS NOT NULL AND nr_uuid_w::text <> '') then
				
					select count(*)
					into STRICT   qtd_vinc_w
					from   nota_fiscal
					where  (nr_nfe_imp IS NOT NULL AND nr_nfe_imp::text <> '')
					and    ie_situacao = '1'
					and    nr_nfe_imp = nr_uuid_w;					
					
					if (qtd_vinc_w > 0) then
						
						select 	max(nr_sequencia)
						into STRICT	nr_seq_nf_w
						from 	nota_fiscal
						where   ie_situacao = '1'
						and   	nr_nfe_imp = nr_uuid_w;
						
						ds_msg_p := obter_desc_expressao(931027) || ';' || ds_msg_p;
						insert_inconsistencia(nr_seq_nf_imp_p, nr_seq_nf_w, 'NI');
							
					end if;
					
				end if;	



			select  count(*)
			into STRICT 	count_nf_encontradas_w
			from	nota_fiscal nf
			where	cd_cgc_emitente in (SELECT cd_cgc from pessoa_juridica where cd_rfc = cd_rfc_w)
			and	((cd_pessoa_fisica_w = cd_pessoa_fisica) or coalesce(cd_pessoa_fisica_w::text, '') = '')
			and ((cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') or (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> ''))
			and	nf.vl_total_nota = vl_total_nota_w
			and	((cd_serie_nf = cd_serie_nf_w) or (CASE WHEN cd_serie_nf_w='' THEN '0'  ELSE cd_serie_nf_w END  = '0'))
			and	nf.nr_nota_fiscal = nr_nota_fiscal_w
			and	((nf.nr_sequencia = nr_seq_nf_p) or (coalesce(nr_seq_nf_p::text, '') = ''))
			and	nf.ie_situacao = '1'
			and	nf.ie_tipo_nota = 'EN';
			
			
			if (count_nf_encontradas_w > 0) then
				select  nf.nr_nota_fiscal,
					nf.nr_nfe_imp
				into STRICT 	nota_encontrada_w,
					nr_nota_importada_w
				from	nota_fiscal nf
				where	cd_cgc_emitente in (SELECT cd_cgc from pessoa_juridica where cd_rfc = cd_rfc_w)
				and	((cd_pessoa_fisica_w = cd_pessoa_fisica) or coalesce(cd_pessoa_fisica_w::text, '') = '')
				and ((cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') or (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> ''))
				and	nf.vl_total_nota = vl_total_nota_w
				and	((cd_serie_nf = cd_serie_nf_w) or (CASE WHEN cd_serie_nf_w='' THEN '0'  ELSE cd_serie_nf_w END  = '0'))
				and	nf.nr_nota_fiscal = nr_nota_fiscal_w
				and	((nf.nr_sequencia = nr_seq_nf_p) or (coalesce(nr_seq_nf_p::text, '') = ''))
				and	nf.ie_situacao = '1'
				and	nf.ie_tipo_nota = 'EN';
			
				if (coalesce(length(trim(both nota_encontrada_w)),0) > 0) then
					ds_msg_p := obter_desc_expressao(873859) || ';' || ds_msg_p;
					insert_inconsistencia(nr_seq_nf_imp_p, nr_seq_nf_w, 'DTE');
				end if;
	
				if (coalesce(length(trim(both nr_nota_importada_w)),0) > 0) then
					ds_msg_p := obter_desc_expressao(931027) || ';' || ds_msg_p;
					insert_inconsistencia(nr_seq_nf_imp_p, nr_seq_nf_w, 'NI');
				end if;
			end if;

			select  count(*)
			into STRICT	qt_sem_nota_w
			from 	pessoa_juridica
			where	cd_rfc = cd_rfc_w;

			if (qt_sem_nota_w = 0)then
				insert_inconsistencia(nr_seq_nf_imp_w, nr_seq_nf_w, 'SNC');
			end if;

			if (qt_sem_nota_w > 0)then
				select  count(*)
				into STRICT    qt_sem_nota_w
				from	nota_fiscal nf
				where   nf.nr_nota_fiscal = nr_nota_fiscal_w
				and	nf.cd_cgc_emitente in (	SELECT cd_cgc
								from pessoa_juridica 
								where cd_rfc = cd_rfc_w)
				and	nf.dt_emissao between Trunc(dt_emissao_w,'dd') and fim_dia(dt_emissao_w);

				if (qt_sem_nota_w = 0)then
					insert_inconsistencia(nr_seq_nf_imp_w, nr_seq_nf_w, 'SNC');
				end if;
			end if;
		else
				

				select	max(nr_uuid)
				into STRICT	nr_uuid_w
				from	nf_imp_nota
				where	nr_sequencia = nr_seq_nf_imp_w;

				if (nr_uuid_w IS NOT NULL AND nr_uuid_w::text <> '') then
				
					select count(*)
					into STRICT   qtd_vinc_w
					from   nota_fiscal
					where  (nr_nfe_imp IS NOT NULL AND nr_nfe_imp::text <> '')
					and    ie_situacao = '1'
					and    nr_nfe_imp = nr_uuid_w;
					
					if (qtd_vinc_w > 0) then
						
						ds_msg_p := obter_desc_expressao(931027) || ';' || ds_msg_p;
						insert_inconsistencia(nr_seq_nf_imp_p, nr_seq_nf_w, 'NI');
							
					end if;
					
				end if;	
		
		end if;

	end if;

	/* Realiza o vinculo */

	if (ie_somente_consiste_p = 'N') then
		if ((coalesce(ds_msg_p, 'XPTO') <> 'XPTO') and (ie_confirm_p = 'S')) then
			ds_msg_p := '';
		end if;

		realizar_vinculo_nf(nr_seq_nf_imp_w, nr_seq_nf_w, ds_msg_p, ie_confirm_p);
	end if;


end if;

if (ie_commit_p = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mx_cfdi_vincular_nf ( nr_seq_nf_imp_p bigint, nr_seq_nf_p bigint, ie_confirm_p text, ie_commit_p text, ds_msg_p INOUT text, ie_somente_consiste_p text) FROM PUBLIC;

