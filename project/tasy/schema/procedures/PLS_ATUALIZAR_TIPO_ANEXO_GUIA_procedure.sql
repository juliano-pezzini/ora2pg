-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_tipo_anexo_guia ( nr_seq_guia_plano_p pls_guia_plano.nr_sequencia%type, nr_seq_requisicao_p pls_requisicao.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Atualizar o cabeçalho da Requisição e da Autorização, informando que a guia
possui anexo
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [ x  ] Tasy (Delphi/Java) [   x ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
C01 CURSOR( nr_seq_guia_plano_pc 	pls_guia_plano.nr_sequencia%type  ) FOR
	SELECT	ie_tipo_anexo
	from	pls_guia_plano_proc
	where	nr_seq_guia = nr_seq_guia_plano_pc
	and	(ie_tipo_anexo IS NOT NULL AND ie_tipo_anexo::text <> '')
	
union

	SELECT	ie_tipo_anexo
	from	pls_guia_plano_mat
	where	nr_seq_guia = nr_seq_guia_plano_pc
	and	(ie_tipo_anexo IS NOT NULL AND ie_tipo_anexo::text <> '');


C02 CURSOR( nr_seq_requisicao_pc	pls_requisicao.nr_sequencia%type ) FOR
	SELECT	ie_tipo_anexo
	from	pls_requisicao_proc
	where	nr_seq_requisicao = nr_seq_requisicao_pc
	and	(ie_tipo_anexo IS NOT NULL AND ie_tipo_anexo::text <> '')
	
union

	SELECT	ie_tipo_anexo
	from	pls_requisicao_mat
	where	nr_seq_requisicao = nr_seq_requisicao_pc
	and	(ie_tipo_anexo IS NOT NULL AND ie_tipo_anexo::text <> '');



ie_anexo_guia_w			pls_guia_plano.ie_anexo_guia%type		:= 'N';
ie_anexo_opme_w			pls_guia_plano.ie_anexo_opme%type		:= 'N';
ie_anexo_quimioterapia_w	pls_guia_plano.ie_anexo_quimioterapia%type 	:= 'N';
ie_anexo_radioterapia_w		pls_guia_plano.ie_anexo_radioterapia%type 	:= 'N';
BEGIN


--Verifica se a atualização é na Guia ou na Requisição
if (nr_seq_guia_plano_p IS NOT NULL AND nr_seq_guia_plano_p::text <> '') then
	for	r_C01_w in C01( nr_seq_guia_plano_p ) loop
		ie_anexo_guia_w := 'S';

		--Verifica se existe anexo de OPME
		if ( r_C01_w.ie_tipo_anexo = 'OP' ) then
			ie_anexo_opme_w := 'S';
		end if;

		--Verifica se existe anexo de Quimioterapia
		if ( r_C01_w.ie_tipo_anexo = 'QU' ) then
			ie_anexo_quimioterapia_w := 'S';
		end if;

		--Verifica se existe anexo de Radioterapia
		if ( r_C01_w.ie_tipo_anexo = 'RA' ) then
			ie_anexo_radioterapia_w := 'S';
		end if;
	end loop;

	update	pls_guia_plano
	set	dt_atualizacao 		= clock_timestamp(),
		nm_usuario		= nm_usuario_p,
		ie_anexo_guia  		= ie_anexo_guia_w,
		ie_anexo_opme          	= ie_anexo_opme_w,
		ie_anexo_quimioterapia 	= ie_anexo_quimioterapia_w,
		ie_anexo_radioterapia	= ie_anexo_radioterapia_w
	where	nr_sequencia 		= nr_seq_guia_plano_p;

elsif (nr_seq_requisicao_p IS NOT NULL AND nr_seq_requisicao_p::text <> '') then

	for	r_C02_w in C02( nr_seq_requisicao_p ) loop
		ie_anexo_guia_w := 'S';

		--Verifica se existe anexo de OPME
		if ( r_C02_w.ie_tipo_anexo = 'OP' ) then
			ie_anexo_opme_w := 'S';
		end if;

		--Verifica se existe anexo de Quimioterapia
		if ( r_C02_w.ie_tipo_anexo = 'QU' ) then
			ie_anexo_quimioterapia_w := 'S';
		end if;

		--Verifica se existe anexo de Radioterapia
		if ( r_C02_w.ie_tipo_anexo = 'RA' ) then
			ie_anexo_radioterapia_w := 'S';
		end if;
	end loop;

	update	pls_requisicao
	set	dt_atualizacao 		= clock_timestamp(),
		nm_usuario		= nm_usuario_p,
		ie_anexo_guia  		= ie_anexo_guia_w,
		ie_anexo_opme          	= ie_anexo_opme_w,
		ie_anexo_quimioterapia 	= ie_anexo_quimioterapia_w,
		ie_anexo_radioterapia	= ie_anexo_radioterapia_w
	where	nr_sequencia 		= nr_seq_requisicao_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_tipo_anexo_guia ( nr_seq_guia_plano_p pls_guia_plano.nr_sequencia%type, nr_seq_requisicao_p pls_requisicao.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

