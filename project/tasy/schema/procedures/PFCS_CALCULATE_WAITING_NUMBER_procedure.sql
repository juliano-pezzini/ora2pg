-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pfcs_calculate_waiting_number ( nr_seq_indicator_p bigint, cd_estabelecimento_p text, nm_usuario_p text) AS $body$
DECLARE


	c01 CURSOR FOR
	SELECT 	a.nr_sequencia nr_seq_queue,
		a.cd_senha_gerada ds_waiting_number,
		a.dt_geracao_senha dt_waiting_number,
		b.ds_fila ds_queue,
		b.nr_sequencia id_queue,
		a.cd_pessoa_fisica id_patient,
		coalesce(get_formatted_person_name(a.cd_pessoa_fisica, 'list'), obter_nome_pf(a.cd_pessoa_fisica)) nm_patient,
		pfcs_obter_lista_dados_classif(a.cd_pessoa_fisica) ds_classification,
		obter_sexo_pf(a.cd_pessoa_fisica, 'D') ds_gender,
		pf.dt_nascimento dt_birthdate,
        obter_dados_pf(pf.cd_pessoa_fisica, 'I') qt_idade_paciente
	FROM fila_espera_senha b, paciente_senha_fila a
LEFT OUTER JOIN pessoa_fisica pf ON (a.cd_pessoa_fisica = pf.cd_pessoa_fisica)
WHERE coalesce(a.dt_primeira_chamada::text, '') = '' and coalesce(a.dt_utilizacao::text, '') = '' and coalesce(a.dt_inutilizacao::text, '') = '' and a.cd_estabelecimento = (cd_estabelecimento_p)::numeric and a.nr_seq_fila_senha = b.nr_sequencia;

	qt_total_waiting_number_w			bigint := 0;
	pfcs_panel_detail_seq_w				pfcs_panel_detail.nr_sequencia%type;
	pfcs_panel_seq_w				pfcs_panel.nr_sequencia%type;
	nr_seq_operational_level_w			pfcs_operational_level.nr_sequencia%type;

	
BEGIN
		nr_seq_operational_level_w := pfcs_get_structure_level(
				cd_establishment_p => cd_estabelecimento_p,
				ie_level_p => 'O',
				ie_info_p => 'C');

		for c01_w in c01 loop
			begin

				qt_total_waiting_number_w := qt_total_waiting_number_w + 1;

				select nextval('pfcs_panel_detail_seq')
				into STRICT pfcs_panel_detail_seq_w
				;

				insert into pfcs_panel_detail(
					nr_sequencia,
					nm_usuario,
					dt_atualizacao,
					nm_usuario_nrec,
					dt_atualizacao_nrec,
					ie_situation,
					nr_seq_indicator,
					nr_seq_operational_level)
				values (
					pfcs_panel_detail_seq_w,
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					'T',
					nr_seq_indicator_p,
					nr_seq_operational_level_w);

				insert into pfcs_detail_queue(
					nr_sequencia,
					nm_usuario,
					dt_atualizacao,
					nm_usuario_nrec,
					dt_atualizacao_nrec,
					nr_seq_detail,
					nr_seq_queue,
					ds_waiting_number,
					ds_queue,
					id_queue,
					dt_waiting_number)
				values (
					nextval('pfcs_detail_queue_seq'),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					pfcs_panel_detail_seq_w,
					c01_w.nr_seq_queue,
					c01_w.ds_waiting_number,
					c01_w.ds_queue,
					c01_w.id_queue,
					c01_w.dt_waiting_number);

				if (c01_w.id_patient IS NOT NULL AND c01_w.id_patient::text <> '') then

					insert into pfcs_detail_patient(
						nr_sequencia,
						nm_usuario,
						dt_atualizacao,
						nm_usuario_nrec,
						dt_atualizacao_nrec,
						nr_seq_detail,
						id_patient,
						nm_patient,
						ds_gender,
						ds_classification,
						dt_birthdate,
                        ds_age_range
						)
					values (
						nextval('pfcs_detail_patient_seq'),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						pfcs_panel_detail_seq_w,
						c01_w.id_patient,
						c01_w.nm_patient,
						c01_w.ds_gender,
						c01_w.ds_classification,
						c01_w.dt_birthdate,
                        c01_w.qt_idade_paciente);

				end if;

			end;
		end loop;

		commit;

		 := pfcs_pck.pfcs_generate_results(
				vl_indicator_p => qt_total_waiting_number_w, ds_reference_value_p => '', nr_seq_indicator_p => nr_seq_indicator_p, nr_seq_operational_level_p => nr_seq_operational_level_w, nm_usuario_p => nm_usuario_p, nr_seq_panel_p => pfcs_panel_seq_w);

		CALL pfcs_pck.pfcs_update_detail(
				nr_seq_indicator_p => nr_seq_indicator_p,
				nr_seq_panel_p => pfcs_panel_seq_w,
				nr_seq_operational_level_p => nr_seq_operational_level_w,
				nm_usuario_p => nm_usuario_p);

		CALL pfcs_pck.pfcs_activate_records(
				nr_seq_indicator_p => nr_seq_indicator_p,
				nr_seq_operational_level_p => nr_seq_operational_level_w,
				nm_usuario_p => nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pfcs_calculate_waiting_number ( nr_seq_indicator_p bigint, cd_estabelecimento_p text, nm_usuario_p text) FROM PUBLIC;

