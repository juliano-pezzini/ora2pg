-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_ajustar_div_fatura ( nr_seq_fatura_p ptu_fatura.nr_sequencia%type) AS $body$
DECLARE


vl_dif_w double precision;
ie_ajustou_w  varchar(1) := 'N';

C01 CURSOR FOR
  SELECT  a.nr_sequencia,
    a.nr_seq_conta,
    a.vl_glosa_taxa_servico, a.vl_glosa_taxa_co, a.vl_glosa_taxa_material,
    a.vl_glosa_hi, vl_glosa_co, vl_glosa_material,
    a.vl_liberado_hi,
    a.vl_liberado_co,
    a.vl_liberado_material,
    a.vl_lib_taxa_servico,
    a.vl_lib_taxa_co,
    a.vl_lib_taxa_material,
    a.vl_liberado,
    (coalesce(a.vl_liberado_hi,0) + coalesce(a.vl_liberado_co,0) + coalesce(a.vl_liberado_material,0) +
    coalesce(a.vl_lib_taxa_servico,0) + coalesce(a.vl_lib_taxa_co,0) + coalesce(a.vl_lib_taxa_material,0)) vl_totais_sub
  from    pls_conta_proc    a,
    pls_conta    b,
    ptu_fatura c
  where  b.nr_seq_fatura  = nr_seq_fatura_p
  and   b.nr_seq_fatura = c.nr_sequencia
  and    a.nr_seq_conta = b.nr_sequencia
  and    a.ie_status <> 'M'
  and (coalesce(a.vl_liberado_hi,0) + coalesce(a.vl_liberado_co,0) + coalesce(a.vl_liberado_material,0) +
    coalesce(a.vl_lib_taxa_servico,0) + coalesce(a.vl_lib_taxa_co,0) + coalesce(a.vl_lib_taxa_material,0)) != a.vl_liberado;

BEGIN

  for r_c01_w in C01 loop

    ie_ajustou_w := 'N';

    vl_dif_w := r_c01_w.vl_liberado - r_c01_w.vl_totais_sub;

    --como aqui e tratativa para divergencia que pode ocorrer por arredondamento, considera-se a diferenca maxima de 2 centavos. Divergencias maiores nao
    --serao ajustadas pois caso ocorrerem, seria alguma falha que precisara ser verificada.
    if ( abs(vl_dif_w) < 0.03) then


      if ( r_c01_w.vl_liberado_hi > r_c01_w.vl_liberado_material and r_c01_w.vl_liberado_hi > r_c01_w.vl_liberado_co) then
        if ( r_c01_w.vl_liberado_hi >= abs(vl_dif_w)) then

          update   pls_conta_proc
          set   vl_liberado_hi = vl_liberado_hi + vl_dif_w
          where   nr_sequencia = r_c01_w.nr_sequencia;

          ie_ajustou_w := 'S';

        end if;

      elsif (r_c01_w.vl_liberado_material > r_c01_w.vl_liberado_co) then
        if (r_c01_w.vl_liberado_material > abs(vl_dif_w)) then

          update   pls_conta_proc
          set   vl_liberado_material = vl_liberado_material + vl_dif_w
          where   nr_sequencia = r_c01_w.nr_sequencia;

          ie_ajustou_w := 'S';
        end if;

      else
        if ( r_c01_w.vl_liberado_co > abs(vl_dif_w)) then

          update   pls_conta_proc
          set   vl_liberado_co = vl_liberado_co + vl_dif_w
          where   nr_sequencia = r_c01_w.nr_sequencia;

          ie_ajustou_w := 'S';
        end if;
      end if;

      if (ie_ajustou_w = 'S') then

        insert  into  plsprco_cta(   nr_sequencia, dt_atualizacao, nm_usuario,
            dt_atualizacao_nrec, nm_usuario_nrec, nm_tabela,
            ds_log, ds_log_call, ds_funcao_ativa,
            ie_aplicacao_tasy, nm_maquina, ie_opcao,
            nr_seq_conta, pls_conta_proc)
        values (   nextval('plsprco_cta_seq'), clock_timestamp(), substr(coalesce(wheb_usuario_pck.get_nm_usuario,'Usuario nao identificado '),1,14),
            clock_timestamp(), substr(coalesce(wheb_usuario_pck.get_nm_usuario,'Usuario nao identificado '),1,14), 'PLS_CONTA',
            'Realizado ajuste de '||vl_dif_w, 'pls_ajustar_div_fatura', obter_funcao_ativa,
            pls_se_aplicacao_tasy, wheb_usuario_pck.get_machine, '1',
            r_c01_w.nr_seq_conta, r_c01_w.nr_sequencia);

      end if;

      commit;
    end if;
  end loop;

  CALL pls_consistir_div_fatura(nr_seq_fatura_p);


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ajustar_div_fatura ( nr_seq_fatura_p ptu_fatura.nr_sequencia%type) FROM PUBLIC;

