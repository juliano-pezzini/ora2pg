-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sup_desdobrar_lote_emprestimo ( nr_emprestimo_p bigint, nr_item_emprestimo_p bigint, qt_gerar_p bigint, nm_usuario_p text, ds_retorno_p INOUT text) AS $body$
DECLARE


cd_cgc_emitente_w		varchar(14);
cd_estabelecimento_w		smallint;
cd_lote_fabricacao_w		varchar(20);
cd_material_w			integer;
dt_validade_w			timestamp;
i				bigint;
nr_sequencia_w			bigint;
qt_gerar_w			bigint;
ds_retorno_w			varchar(255);


BEGIN

qt_gerar_w	:= round((qt_gerar_p)::numeric,0);

select	a.cd_material,
	a.ds_lote_fornec,
	a.dt_validade_material
into STRICT	cd_material_w,
	cd_lote_fabricacao_w,
	dt_validade_w
from	emprestimo_material a
where	nr_emprestimo	= nr_emprestimo_p
and	nr_sequencia	= nr_item_emprestimo_p
and	(ds_lote_fornec IS NOT NULL AND ds_lote_fornec::text <> '');

select	max(cd_estabelecimento),
	max(cd_pessoa_juridica)
into STRICT	cd_estabelecimento_w,
	cd_cgc_emitente_w
from	emprestimo
where	nr_emprestimo = nr_emprestimo_p;

for i in 1..qt_gerar_w loop
	begin

	select	nextval('material_lote_fornec_seq')
	into STRICT	nr_sequencia_w
	;

	insert into material_lote_fornec(
		nr_sequencia,
		cd_material,
		nr_digito_verif,
		dt_atualizacao,
		nm_usuario,
		ds_lote_fornec,
		dt_validade,
		cd_cgc_fornec,
		qt_material,
		cd_estabelecimento,
		ie_origem_lote,
		ie_validade_indeterminada,
		ie_situacao,
		nr_emprestimo)
	values (	nr_sequencia_w,
		cd_material_w,
		calcula_digito('Modulo11', nr_sequencia_w),
		clock_timestamp(),
		nm_usuario_p,
		cd_lote_fabricacao_w,
		dt_validade_w,
		cd_cgc_emitente_w,
		1,
		cd_estabelecimento_w,
		'N',
		CASE WHEN coalesce(dt_validade_w::text, '') = '' THEN  'S'  ELSE 'N' END ,
		'A',
		nr_emprestimo_p);

	ds_retorno_w := substr(ds_retorno_w || nr_sequencia_w || ',',1,255);

	end;
end loop;

ds_retorno_p := ds_retorno_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_desdobrar_lote_emprestimo ( nr_emprestimo_p bigint, nr_item_emprestimo_p bigint, qt_gerar_p bigint, nm_usuario_p text, ds_retorno_p INOUT text) FROM PUBLIC;

