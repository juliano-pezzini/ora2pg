-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_dados_proc_req_web ( cd_procedimento_p bigint, ie_origem_p bigint, ie_carrega_anexo_p text, nr_seq_guia_p pls_guia_plano.nr_sequencia%type default null, nr_seq_requisicao_p pls_requisicao.nr_sequencia%type default null, ie_obter_se_dut_pac_p text default 'N', ie_dut_pac_p INOUT text DEFAULT NULL, ie_anexo_p INOUT text DEFAULT NULL, ds_procedimento_p INOUT text DEFAULT NULL) AS $body$
DECLARE


ds_procedimento_w		procedimento.ds_procedimento%type;			
ie_anexo_w				pls_regra_anexo_guia.ie_tipo_anexo%type;
ie_dut_pac_w 			pls_rol_grupo_proc.ie_complexidade%type;
dt_inicio_vigencia_w	pls_rol.dt_inicio_vigencia%type;
		

BEGIN

ie_dut_pac_w := 'N';

begin
	select  max(a.ds_procedimento)
	into STRICT	ds_procedimento_w
	FROM procedimento a
LEFT OUTER JOIN pls_procedimento_vigencia b ON (a.ie_origem_proced = b.ie_origem_proced AND a.cd_procedimento = b.cd_procedimento)
WHERE ie_situacao = 'A'   and a.cd_procedimento = cd_procedimento_p and a.ie_origem_proced = ie_origem_p and (coalesce(b.dt_fim_vigencia::text, '') = '' 
	or		clock_timestamp()	between b.dt_inicio_vigencia and b.dt_fim_vigencia);
exception
when others then
	ds_procedimento_w  := null;
end;

if (ie_obter_se_dut_pac_p = 'S') then

	select	max(dt_inicio_vigencia)
	into STRICT	dt_inicio_vigencia_w
	from	pls_rol
	where  	trunc(dt_inicio_vigencia) <= trunc(clock_timestamp());

	select  CASE WHEN coalesce(max(a.cd_procedimento)::text, '') = '' THEN  'N'  ELSE 'S' END
	into STRICT    ie_dut_pac_w
	from    pls_rol_procedimento        a,
			pls_rol_grupo_proc        	b,
			pls_rol_subgrupo        	c,
			pls_rol_grupo            	d,
			pls_rol_capitulo        	e,
			pls_rol                		f
	where   f.nr_sequencia            	= e.nr_seq_rol
	and     e.nr_sequencia            	= d.nr_seq_capitulo
	and     d.nr_sequencia            	= c.nr_seq_grupo
	and     c.nr_sequencia            	= b.nr_seq_subgrupo
	and     b.nr_sequencia            	= a.nr_seq_rol_grupo
	and     a.cd_procedimento        	= cd_procedimento_p
	and     a.ie_origem_proced        	= ie_origem_p
	and (b.ie_complexidade      	= 'S' or b.ie_diretriz_utilizacao = 'S')
	and     b.ie_situacao            	= 'A'
	and     c.ie_situacao            	= 'A'
	and     d.ie_situacao            	= 'A'
	and     e.ie_situacao            	= 'A'       
	and     f.dt_inicio_vigencia        = dt_inicio_vigencia_w
	and     trunc(f.dt_inicio_vigencia) <= trunc(clock_timestamp());

end if;

if (ie_carrega_anexo_p = 'S') then
	ie_anexo_w := pls_obter_tipo_anexo_item(cd_procedimento_p, ie_origem_p, null, nr_seq_guia_p, nr_seq_requisicao_p, null);

end if;

ie_dut_pac_p := ie_dut_pac_w;
ie_anexo_p := ie_anexo_w;
ds_procedimento_p := ds_procedimento_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_dados_proc_req_web ( cd_procedimento_p bigint, ie_origem_p bigint, ie_carrega_anexo_p text, nr_seq_guia_p pls_guia_plano.nr_sequencia%type default null, nr_seq_requisicao_p pls_requisicao.nr_sequencia%type default null, ie_obter_se_dut_pac_p text default 'N', ie_dut_pac_p INOUT text DEFAULT NULL, ie_anexo_p INOUT text DEFAULT NULL, ds_procedimento_p INOUT text DEFAULT NULL) FROM PUBLIC;

