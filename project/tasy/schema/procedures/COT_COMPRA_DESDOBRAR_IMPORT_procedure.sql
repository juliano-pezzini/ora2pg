-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cot_compra_desdobrar_import ( nr_cot_compra_origem_p bigint, nr_cot_compra_p bigint, cd_material_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_existe_w		integer;
qt_existe_forn_item_w	integer;
nr_item_cotacao_w		bigint;


BEGIN

select	count(*)
into STRICT	qt_existe_w
from	cot_compra
where	nr_cot_compra = nr_cot_compra_p;
if (qt_existe_w = 0) then
	insert into cot_compra(
		nr_cot_compra,
		dt_cot_compra,
		dt_atualizacao,
		cd_comprador,
		nm_usuario,
		ds_observacao,
		cd_pessoa_solicitante,
		cd_estabelecimento,
		dt_retorno_prev,
		ie_finalidade_cotacao)
	SELECT	nr_cot_compra_p,
		dt_cot_compra,
		clock_timestamp(),
		cd_comprador,
		nm_usuario_p,
		ds_observacao,
		cd_pessoa_solicitante,
		cd_estabelecimento,
		dt_retorno_prev,
		coalesce(ie_finalidade_cotacao,'C')
	from	cot_compra
	where	nr_cot_compra = nr_cot_compra_origem_p;
end if;

select	coalesce(min(nr_item_cot_compra),0)
into STRICT	nr_item_cotacao_w
from	cot_compra_item
where	nr_cot_compra	= nr_cot_compra_origem_p
and	cd_material	= cd_material_p;
if (nr_item_cotacao_w = 0) then
	insert into cot_compra_hist(
		nr_sequencia,
		nr_cot_compra,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		dt_historico,
		ie_origem,
		ds_titulo,
		ds_historico,
		ie_tipo)
	values ( nextval('cot_compra_hist_seq'),
		nr_cot_compra_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		'S',
		Wheb_mensagem_pck.get_Texto(299054),
		WHEB_MENSAGEM_PCK.get_texto(299055,'CD_MATERIAL_P='||CD_MATERIAL_P||';NR_COT_COMPRA_ORIGEM_P='||NR_COT_COMPRA_ORIGEM_P),
		'H');
end if;

if (nr_item_cotacao_w > 0) then
	begin
	select	count(*)
	into STRICT	qt_existe_forn_item_w
	from	cot_compra_forn_item
	where	nr_cot_compra = nr_cot_compra_origem_p
	and	nr_item_cot_compra = nr_item_cotacao_w;
	if (qt_existe_forn_item_w > 0) then
		insert into cot_compra_hist(
			nr_sequencia,
			nr_cot_compra,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_historico,
			ie_origem,
			ds_titulo,
			ds_historico)
		values ( nextval('cot_compra_hist_seq'),
			nr_cot_compra_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			'S',
			Wheb_mensagem_pck.get_Texto(299054),
			WHEB_MENSAGEM_PCK.get_texto(299057,'NR_ITEM_COTACAO_W='||NR_ITEM_COTACAO_W||';NR_COT_COMPRA_ORIGEM_P='||NR_COT_COMPRA_ORIGEM_P));
		end if;

	if (qt_existe_forn_item_w = 0) then
		insert into cot_compra_item(
			nr_cot_compra,
			nr_item_cot_compra,
			cd_material,
			qt_material,
			cd_unidade_medida_compra,
			dt_atualizacao,
			dt_limite_entrega,
			nm_usuario,
			ie_situacao,
			ds_material_direto_w,
			ie_regra_preco,
			nr_solic_compra,
			nr_item_solic_compra,
			cd_estab_item,
			nr_item_solic_compra_entr)
		SELECT	nr_cot_compra_p,
			nr_item_cot_compra,
			cd_material,
			qt_material,
			cd_unidade_medida_compra,
			clock_timestamp(),
			dt_limite_entrega,
			nm_usuario_p,
			ie_situacao,
			ds_material_direto_w,
			ie_regra_preco,
			nr_solic_compra,
			nr_item_solic_compra,
			cd_estab_item,
			nr_item_solic_compra_entr
		from	cot_compra_item
		where	nr_cot_compra	= nr_cot_compra_origem_p
		and	nr_item_cot_compra = nr_item_cotacao_w;

		delete
		from	cot_compra_item
		where	nr_cot_compra	= nr_cot_compra_origem_p
		and	nr_item_cot_compra = nr_item_cotacao_w;
	end if;
	end;
end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cot_compra_desdobrar_import ( nr_cot_compra_origem_p bigint, nr_cot_compra_p bigint, cd_material_p bigint, nm_usuario_p text) FROM PUBLIC;

