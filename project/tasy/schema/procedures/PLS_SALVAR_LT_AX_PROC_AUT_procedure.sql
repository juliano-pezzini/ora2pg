-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_salvar_lt_ax_proc_aut ( nr_seq_lote_anexo_guia_p bigint, dt_prev_realizacao_p timestamp, cd_tipo_tabela_p text, cd_procedimento_p text, ds_procedimento_p text, qt_solicitado_p bigint, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p text) AS $body$
DECLARE



/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Salvar os procedimentos  nas guias no lote de anexo.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [  ] Tasy (Delphi/Java) [  x] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ie_origem_proced_w		bigint;
cd_procedimento_w		varchar(10);
nr_seq_plano_proc_w		pls_guia_plano_proc.nr_sequencia%type;
nr_seq_req_proc_w		pls_requisicao_proc.nr_sequencia%type;


BEGIN

--Retorna o código do procedimento e a origem já convertidos
SELECT * FROM pls_gerar_dados_guia_proc_imp( cd_procedimento_p, cd_tipo_tabela_p, null, cd_estabelecimento_p, cd_procedimento_w, ie_origem_proced_w) INTO STRICT cd_procedimento_w, ie_origem_proced_w;

--Obter a sequencia do procedimento da guia
select	max(a.nr_sequencia)
into STRICT	nr_seq_plano_proc_w
from	pls_guia_plano_proc a,
	pls_lote_anexo_guias_imp b
where	a.nr_seq_guia 		= b.nr_seq_guia
and	b.nr_sequencia 		= nr_seq_lote_anexo_guia_p
and	a.cd_procedimento	= cd_procedimento_w
and	a.ie_origem_proced	= ie_origem_proced_w;

--Obter a sequencia do procedimento da requisição
select	max(a.nr_sequencia)
into STRICT	nr_seq_req_proc_w
from	pls_requisicao_proc a,
	pls_lote_anexo_guias_imp b
where	a.nr_seq_requisicao	= b.nr_seq_requisicao
and	b.nr_sequencia 		= nr_seq_lote_anexo_guia_p
and	a.cd_procedimento	= cd_procedimento_w
and	a.ie_origem_proced	= ie_origem_proced_w
and	(b.nr_seq_requisicao IS NOT NULL AND b.nr_seq_requisicao::text <> '');


insert into pls_lote_anexo_proc_imp(
	nr_sequencia, nr_seq_lote_guia_imp, dt_atualizacao,
	nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
	dt_prev_realizacao, cd_tipo_tabela, cd_procedimento,
	ds_procedimento, qt_solicitado, ie_origem_proced,
	nr_seq_plano_proc, nr_seq_req_proc)
values (nextval('pls_lote_anexo_proc_imp_seq'), nr_seq_lote_anexo_guia_p, clock_timestamp(),
	nm_usuario_p, clock_timestamp(), nm_usuario_p,
	dt_prev_realizacao_p, cd_tipo_tabela_p, cd_procedimento_w,
	ds_procedimento_p, qt_solicitado_p, ie_origem_proced_w,
	nr_seq_plano_proc_w, nr_seq_req_proc_w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_salvar_lt_ax_proc_aut ( nr_seq_lote_anexo_guia_p bigint, dt_prev_realizacao_p timestamp, cd_tipo_tabela_p text, cd_procedimento_p text, ds_procedimento_p text, qt_solicitado_p bigint, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p text) FROM PUBLIC;

