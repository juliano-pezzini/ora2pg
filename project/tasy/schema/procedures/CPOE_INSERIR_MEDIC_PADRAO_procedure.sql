-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_inserir_medic_padrao ( cd_pessoa_fisica_p text, nm_usuario_p text, ie_opcao_p text, ds_lista_medic_p text default null, nr_seq_cpoe_new_p bigint default null, nr_seq_cpoe_old_p bigint default null, nr_seq_motivo_p bigint default null) AS $body$
DECLARE


lista_informacao_w		varchar(1000);
ie_contador_w			bigint	:= 0;
tam_lista_w			bigint;
ie_pos_virgula_w		smallint;
nr_seq_material_w			bigint;


BEGIN

if ie_opcao_p = 'I' then
    lista_informacao_w	:= ds_lista_medic_p;

    while((lista_informacao_w IS NOT NULL AND lista_informacao_w::text <> '') or ie_contador_w > 200) loop
        begin

        tam_lista_w			:= length(lista_informacao_w);
        ie_pos_virgula_w		:= position(',' in lista_informacao_w);

        /* Obter a sequencia lida */

        if (ie_pos_virgula_w <> 0) then
            nr_seq_material_w		:= substr(lista_informacao_w,1,(ie_pos_virgula_w - 1));
            lista_informacao_w	:= substr(lista_informacao_w,(ie_pos_virgula_w + 1),tam_lista_w);
        end if;

        insert into medic_uso_continuo(
            nr_sequencia,
            dt_atualizacao,
            nm_usuario,
            dt_atualizacao_nrec,
            nm_usuario_nrec,
            cd_pessoa_fisica,
            dt_inicio,
            cd_material,
            qt_dose,
            cd_unidade_medida,
            cd_intervalo,
            ie_via_aplicacao,
            ds_justificativa,
            ds_observacao,
            ie_uso_continuo,
            ie_laudo_lme,
            nr_seq_mat_cpoe
        )
        SELECT 	nextval('medic_uso_continuo_seq'), -- nr_sequencia
            ESTABLISHMENT_TIMEZONE_UTILS.todayAtTime(clock_timestamp()), -- dt_atualizacao
            nm_usuario_p, -- nm_usuario
            ESTABLISHMENT_TIMEZONE_UTILS.todayAtTime(clock_timestamp()), -- dt_atualizacao_nrec
            nm_usuario_p, -- nm_usuario_nrec
            cd_pessoa_fisica_p,
            dt_inicio,
            cd_material,
            qt_dose,
            cd_unidade_medida,
            cd_intervalo,										
            ie_via_aplicacao,
            ds_justificativa,
            substr((CASE WHEN coalesce(ds_observacao::text, '') = '' OR ds_observacao = '' THEN '' else ds_observacao || ' - ' END) ||
            regexp_replace(replace(cpoe_obter_dias_semana(nr_seq_material_w, 'M'), '<br>', ' '), '<.*?>', ''), 1, 255),
            'S',
            'N',
            nr_sequencia
        from 	cpoe_material
        where 	nr_sequencia = nr_seq_material_w;

        ie_contador_w	:= ie_contador_w + 1;

        end;
    end loop;
elsif ( ie_opcao_p = 'M' ) then
    insert into medic_uso_continuo(
            nr_sequencia,
            dt_atualizacao,
            nm_usuario,
            dt_atualizacao_nrec,
            nm_usuario_nrec,
            cd_pessoa_fisica,
            dt_inicio,
            cd_material,
            qt_dose,
            cd_unidade_medida,
            cd_intervalo,
            ie_via_aplicacao,
            ds_justificativa,
            ds_observacao,
            ie_uso_continuo,
            ie_laudo_lme,
            nr_seq_mat_cpoe
        )
        SELECT 	nextval('medic_uso_continuo_seq'), -- nr_sequencia
            ESTABLISHMENT_TIMEZONE_UTILS.todayAtTime(clock_timestamp()), -- dt_atualizacao
            nm_usuario_p, -- nm_usuario
            ESTABLISHMENT_TIMEZONE_UTILS.todayAtTime(clock_timestamp()), -- dt_atualizacao_nrec
            nm_usuario_p, -- nm_usuario_nrec
            cd_pessoa_fisica_p,
            dt_inicio,
            cd_material,
            qt_dose,
            cd_unidade_medida,
            cd_intervalo,										
            ie_via_aplicacao,
            ds_justificativa,
            substr((CASE WHEN coalesce(ds_observacao::text, '') = '' OR ds_observacao = '' THEN '' else ds_observacao || ' - ' END) ||
            regexp_replace(replace(cpoe_obter_dias_semana(nr_seq_material_w, 'M'), '<br>', ' '), '<.*?>', ''), 1, 255),
            'S',
            'N',
            nr_sequencia
        from 	cpoe_material
        where 	nr_sequencia = nr_seq_cpoe_new_p;

        update	medic_uso_continuo
        set	dt_suspensao		= ESTABLISHMENT_TIMEZONE_UTILS.todayAtTime(clock_timestamp()),
            nm_usuario_susp 	= nm_usuario_p,
            nr_seq_motivo_susp	= nr_seq_motivo_p,
            dt_atualizacao		= ESTABLISHMENT_TIMEZONE_UTILS.todayAtTime(clock_timestamp())
        where	nr_seq_mat_cpoe		= nr_seq_cpoe_old_p;
elsif (ie_opcao_p = 'S') then
    update	medic_uso_continuo
    set	dt_suspensao		= ESTABLISHMENT_TIMEZONE_UTILS.todayAtTime(clock_timestamp()),
        nm_usuario_susp 	= nm_usuario_p,
        nr_seq_motivo_susp	= nr_seq_motivo_p,
        dt_atualizacao		= ESTABLISHMENT_TIMEZONE_UTILS.todayAtTime(clock_timestamp())
    where	nr_seq_mat_cpoe		= nr_seq_cpoe_old_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_inserir_medic_padrao ( cd_pessoa_fisica_p text, nm_usuario_p text, ie_opcao_p text, ds_lista_medic_p text default null, nr_seq_cpoe_new_p bigint default null, nr_seq_cpoe_old_p bigint default null, nr_seq_motivo_p bigint default null) FROM PUBLIC;

