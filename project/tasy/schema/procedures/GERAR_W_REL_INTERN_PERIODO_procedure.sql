-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_rel_intern_periodo (dt_inicial_p timestamp, dt_final_p timestamp, cd_setor_atendimento_p bigint) AS $body$
DECLARE

 
dt_atual_w			timestamp;
nr_atendimento_w		bigint;
nm_paciente_w			varchar(200);
DT_ENTRADA_UNIDADE_w		timestamp;
DT_SAIDA_UNIDADE_w		timestamp;
DS_SETOR_ATENDIMENTO_w		varchar(200);
DS_UNIDADE_w			varchar(200);
DS_CONVENIO_w			varchar(255);
DS_CATEGORIA_w			varchar(200);
qt_idade_w			varchar(20);

c01 CURSOR FOR 
	SELECT	a.nr_atendimento, 
		a.nm_paciente, 
		a.dt_entrada_unidade, 
		a.dt_saida_unidade, 
		a.ds_setor_atendimento, 
		a.cd_unidade, 
		a.ds_convenio, 
		a.ds_categoria, 
		obter_idade(a.dt_nascimento, clock_timestamp(), 'A') qt_idade 
	from	paciente_internado_v2 a 
	where	a.dt_entrada_unidade < trunc(dt_atual_w, 'dd') 
	and	a.dt_saida_interno >= trunc(dt_atual_w, 'dd') 
	and	((coalesce(cd_setor_atendimento_p::text, '') = '') or (cd_setor_atendimento = cd_setor_atendimento_p)) 
	group by 	a.nr_atendimento, a.nm_paciente, 
		a.dt_entrada_unidade, 
		a.dt_saida_unidade, 
		a.ds_setor_atendimento, 
		a.cd_unidade, 
		a.ds_convenio, 
		a.ds_categoria, 
		obter_idade(a.dt_nascimento, clock_timestamp(), 'A');


BEGIN 
 
CALL exec_sql_dinamico('TASY', ' drop table W_REL_INTERN_PERIODO ');
 
CALL exec_sql_dinamico('TASY', ' create table W_REL_INTERN_PERIODO (' || 
			 ' nr_atendimento		number(10,0), ' || 
			 ' nm_paciente			varchar2(200), ' || 
			 ' dt_entrada_unidade		date,	    ' || 
			 ' dt_saida_unidade  	date,     ' || 
			 ' ds_setor_atendimento	varchar2(200), ' || 
			 ' ds_unidade			varchar2(200), ' || 
			 ' ds_convenio			varchar2(200), ' || 
			 ' ds_categoria		varchar2(200), ' ||	 
			 ' dt_atual			date,	    ' || 
			 ' qt_idade			varchar2(20)) ');
 
 
dt_atual_w	:= trunc(dt_inicial_p, 'dd');
 
while(dt_atual_w <= dt_final_p) loop 
	begin 
 
	open	c01;
	loop 
	fetch	c01 into 
		nr_atendimento_w, 
		nm_paciente_w, 
		dt_entrada_unidade_w, 
		dt_saida_unidade_w, 
		DS_SETOR_ATENDIMENTO_w, 
		DS_UNIDADE_w, 
		DS_CONVENIO_w, 
		DS_CATEGORIA_w, 
		qt_idade_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin 
 
		nr_atendimento_w	:= nr_atendimento_w;
 
		CALL exec_sql_dinamico('TASY', ' insert into W_REL_INTERN_PERIODO values ( ' || nr_atendimento_w || ',' || 
					 chr(39) || nm_paciente_w || chr(39) || ',' ||	 
					 ' to_date(' || chr(39) || to_char(dt_entrada_unidade_w, 'dd/mm/yyyy hh24:mi:ss') || chr(39) || ',' || 
					 chr(39) || 'dd/mm/yyyy hh24:mi:ss' || chr(39) || '),' || 
					 ' to_date(' || chr(39) || to_char(dt_saida_unidade_w, 'dd/mm/yyyy hh24:mi:ss') || chr(39) || ',' || 
					 chr(39) || 'dd/mm/yyyy hh24:mi:ss' || chr(39) || '),' || 
					 chr(39) || DS_SETOR_ATENDIMENTO_w || chr(39) || ',' ||	 
					 chr(39) || DS_UNIDADE_w || chr(39) || ',' ||	 
					 chr(39) || DS_CONVENIO_w || chr(39) || ',' ||	 
					 chr(39) || DS_CATEGORIA_w || chr(39) || ',' ||	 
					 ' to_date(' || chr(39) || to_char(dt_atual_w, 'dd/mm/yyyy hh24:mi:ss') || chr(39) || ',' || 
					 chr(39) || 'dd/mm/yyyy hh24:mi:ss' || chr(39) || ') ' || ',' || chr(39) || qt_idade_w || chr(39) || ')');	
 
		end;
	end loop;
	close c01;
 
	dt_atual_w	:= trunc(dt_atual_w + 1, 'dd');
	end;
end loop;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_rel_intern_periodo (dt_inicial_p timestamp, dt_final_p timestamp, cd_setor_atendimento_p bigint) FROM PUBLIC;

