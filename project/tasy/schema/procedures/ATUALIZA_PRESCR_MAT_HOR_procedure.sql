-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_prescr_mat_hor ( nr_prescricao_p bigint, nr_seq_item_p bigint, cd_perfil_p bigint, nm_usuario_p text, ie_lib_parc_p text default null, ie_tipo_item_p text default null, nr_seq_horario_p bigint default null) AS $body$
DECLARE


ajustar_disp_hor_farm_w	varchar(1);
sqlerrm_w 				varchar(2000);
ie_gera_nutricao_w		varchar(1);
ie_adep_param_w			varchar(2);
ie_adep_w				varchar(2)	:= 'X';
cd_setor_atendimento_w  bigint;
cd_estabelecimento_w    smallint;
VarIdentPrescrADEP_w	varchar(5);
ie_atualiza_adep_w		varchar(1);
nr_sequencia_mat_kit_w	bigint;
ie_lote_pos_lib_w		varchar(1);
dt_lib_horario_w		timestamp;
ie_param768_w			varchar(1);
nr_sequencia_w			prescr_material.nr_sequencia%type;
nr_seq_kit_w			prescr_material.nr_sequencia%type;
/* Somente para liberar os Kits do medicamento principal */
ie_info_rastre_prescr_w	varchar(1);
ds_alteracao_rastre_w	varchar(1800);

c01 CURSOR FOR
	SELECT	nr_sequencia
	from	prescr_material
	where	nr_prescricao = nr_prescricao_p
	and	nr_seq_kit = nr_seq_item_p
	and coalesce(nr_seq_recomendacao::text, '') = ''
	and	ie_agrupador = 2;
	
C02 CURSOR FOR
	SELECT	a.nr_sequencia
	from	prescr_material a
	where	a.nr_prescricao = nr_prescricao_p
	and		(((coalesce(nr_seq_item_p::text, '') = '') and (a.nr_sequencia_solucao IS NOT NULL AND a.nr_sequencia_solucao::text <> '')) or (a.nr_sequencia_solucao = nr_seq_item_p))
	and		coalesce(a.dt_suspensao::text, '') = ''
	and		coalesce(a.ie_suspenso,'N') = 'N'
	and		coalesce(a.ie_acm,'N') = 'N'
	and		coalesce(a.ie_se_necessario,'N') = 'N'
	and		coalesce(a.ie_gerar_horario,'S') <> 'N'
	and	exists (	SELECT	1
					from	prescr_material b
					where	coalesce(b.nr_seq_inconsistencia::text, '') = ''
					and	b.nr_sequencia		=	a.nr_sequencia
					and	b.nr_prescricao		=	a.nr_prescricao )
	and	not exists (	select 	1
					from	prescr_material_incon_farm c
					where	coalesce(c.ie_situacao,'A')  = 'A'
					and		c.nr_seq_material 	= a.nr_sequencia
					and		c.nr_prescricao 	= a.nr_prescricao );
					
C03 CURSOR FOR
	SELECT	nr_sequencia
	from	prescr_material
	where	nr_prescricao = nr_prescricao_p
	and		nr_seq_kit = nr_sequencia_w;


BEGIN	

ie_info_rastre_prescr_w := 'N';
ie_param768_w := obter_param_usuario(924, 768, cd_perfil_p, nm_usuario_p, cd_estabelecimento_w, ie_param768_w);

begin

	Select	max(ie_adep),
		max(cd_estabelecimento),
		max(cd_setor_atendimento)
	into STRICT	ie_adep_param_w,
		cd_estabelecimento_w,
		cd_setor_atendimento_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;

	select	coalesce(max(ie_lote_pos_lib),'N')
	into STRICT	ie_lote_pos_lib_w
	from	parametro_medico
	where	cd_estabelecimento	= cd_estabelecimento_w;

	select	CASE WHEN count(nr_sequencia)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_atualiza_adep_w
	from	prescr_mat_hor
	where	coalesce(dt_lib_horario::text, '') = ''
	and	(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '')
	and	((nr_seq_material = nr_seq_item_p) or (coalesce(nr_seq_item_p,0) = 0) or (nr_seq_superior = nr_seq_item_p) )
	and	nr_sequencia	= coalesce(nr_seq_horario_p,nr_sequencia)
	and	nr_prescricao = nr_prescricao_p;
	
exception when others then
	sqlerrm_w	:= substr(sqlerrm,1,1500);
	CALL gerar_log_prescricao(nr_prescricao_p, null, null, null, null, sqlerrm_w, nm_usuario_p, 4404, 'S');
end;

if (ie_atualiza_adep_w	= 'S') then

	VarIdentPrescrADEP_w := obter_param_usuario(924, 246, cd_perfil_p, nm_usuario_p, cd_estabelecimento_w, VarIdentPrescrADEP_w);

	if (VarIdentPrescrADEP_w = 'NV') then
		ie_adep_w := 'N';
	elsif (VarIdentPrescrADEP_w = 'SV') then
		ie_adep_w := 'S';
	elsif (VarIdentPrescrADEP_w = 'PV') or (VarIdentPrescrADEP_w = 'PNV') then
		ie_adep_w := ie_adep_param_w;
	elsif (VarIdentPrescrADEP_w = 'DS') then
		ie_adep_w := coalesce(ie_adep_param_w,obter_se_setor_adep(cd_setor_atendimento_w));
	end if;

	if (ie_adep_w <> 'X') then

		begin
	
			update	prescr_mat_hor
			set	ie_adep = ie_adep_w
			where	nr_prescricao = nr_prescricao_p
			and	ie_adep <> ie_adep_w
			and	coalesce(dt_lib_horario::text, '') = ''
			and	((nr_seq_material = nr_seq_item_p) or (coalesce(nr_seq_item_p,0) = 0) or (nr_seq_superior = nr_seq_item_p) )
			and	nr_sequencia	= coalesce(nr_seq_horario_p,nr_sequencia)
			and	(dt_suspensao IS NOT NULL AND dt_suspensao::text <> '');
			
		exception when others then
			sqlerrm_w	:= substr(sqlerrm,1,2000);
			CALL gerar_log_prescricao(nr_prescricao_p, null, null, null, null, sqlerrm_w, nm_usuario_p, 4404, 'S');
		end;

	end if;

end if;

CALL adep_gerar_area_prep(nr_prescricao_p, nr_seq_item_p, nm_usuario_p);

begin

	if (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') then
		
		if (ie_tipo_item_p = 'M') then
			
			dt_lib_horario_w := clock_timestamp();
			
			update	prescr_mat_hor
			set	dt_lib_horario	= dt_lib_horario_w
			where	coalesce(dt_lib_horario::text, '') = ''
			and	((nr_seq_material = nr_seq_item_p) or (coalesce(nr_seq_item_p,0) = 0) or (nr_seq_superior = nr_seq_item_p) )
			and 	ie_agrupador in (1,3,7,9)
			and	nr_sequencia	= coalesce(nr_seq_horario_p,nr_sequencia)
			and	nr_prescricao = nr_prescricao_p;
			
			if (coalesce(nr_seq_item_p,0) > 0) and (coalesce(nr_seq_horario_p::text, '') = '') then
				open c01;
				loop
				fetch c01 into nr_sequencia_mat_kit_w;
				EXIT WHEN NOT FOUND; /* apply on c01 */
					update	prescr_mat_hor
					set	dt_lib_horario	= dt_lib_horario_w
					where	coalesce(dt_lib_horario::text, '') = ''
					and	nr_seq_material = nr_sequencia_mat_kit_w
					and	ie_agrupador	= 2
					and	nr_prescricao = nr_prescricao_p;
				end loop;
				close c01;
			end if;
		elsif (ie_tipo_item_p = 'MAT') then
			update	prescr_mat_hor
			set	dt_lib_horario	= clock_timestamp()
			where	coalesce(dt_lib_horario::text, '') = ''
			and	((nr_seq_material = nr_seq_item_p) or (coalesce(nr_seq_item_p,0) = 0) or (nr_seq_superior = nr_seq_item_p))
			and	ie_agrupador	= 2
			and	nr_sequencia	= coalesce(nr_seq_horario_p,nr_sequencia)
			and	nr_prescricao = nr_prescricao_p;

		elsif (ie_tipo_item_p IN ('P', 'IA')) then
			update	prescr_mat_hor
			set	dt_lib_horario	= clock_timestamp()
			where	coalesce(dt_lib_horario::text, '') = ''
			and	((nr_seq_material = nr_seq_item_p) or (coalesce(nr_seq_item_p,0) = 0))
			and	ie_agrupador	= 5
			and	nr_sequencia	= coalesce(nr_seq_horario_p,nr_sequencia)
			and	nr_prescricao = nr_prescricao_p;
			
		elsif (ie_tipo_item_p = 'S') then
		
			update	prescr_mat_hor a
			set	a.dt_lib_horario	= clock_timestamp()
			where	coalesce(a.dt_lib_horario::text, '') = ''
			and	((a.nr_seq_material = nr_seq_item_p) or (coalesce(nr_seq_item_p,0) = 0))	
			and	a.ie_agrupador in (4,13)
			and	a.nr_sequencia	= coalesce(nr_seq_horario_p,a.nr_sequencia)
			and	exists (	SELECT	1
							from	prescr_material b
							where	coalesce(b.nr_seq_inconsistencia::text, '') = ''
							and	b.nr_sequencia		=	a.nr_seq_material
							and	b.nr_prescricao		=	a.nr_prescricao )
			and	not exists (	select 	1
							from	prescr_material_incon_farm c
							where	coalesce(c.ie_situacao,'A')  = 'A'
							and		c.nr_seq_material 	= a.nr_seq_material
							and		c.nr_prescricao 	= a.nr_prescricao )
			and	a.nr_prescricao = nr_prescricao_p;
			
			if (coalesce(ie_param768_w,'N') = 'S' or ie_lib_parc_p = 'S') then
			
				open C02;
				loop
				fetch C02 into	
					nr_sequencia_w;
				EXIT WHEN NOT FOUND; /* apply on C02 */
					begin
					
						update	prescr_mat_hor
						set		dt_lib_horario	= clock_timestamp()
						where	coalesce(dt_lib_horario::text, '') = ''
						and 	nr_prescricao = nr_prescricao_p
						and 	nr_seq_material = nr_sequencia_w;
						
						open C03;
						loop
						fetch C03 into	
							nr_seq_kit_w;
						EXIT WHEN NOT FOUND; /* apply on C03 */
							begin

								update	prescr_mat_hor
								set		dt_lib_horario	= clock_timestamp()
								where	coalesce(dt_lib_horario::text, '') = ''
								and 	nr_prescricao = nr_prescricao_p
								and 	nr_seq_material = nr_seq_kit_w;
							end;
						end loop;
						close C03;
					end;
				end loop;
				close C02;
			
			end if;
			
		elsif (ie_tipo_item_p = 'SNE') then
			update	prescr_mat_hor
			set	dt_lib_horario	= clock_timestamp()
			where	coalesce(dt_lib_horario::text, '') = ''
			and	((nr_seq_material = nr_seq_item_p) or (coalesce(nr_seq_item_p,0) = 0))
			and	ie_agrupador	= 8
			and	nr_sequencia	= coalesce(nr_seq_horario_p,nr_sequencia)
			and	nr_prescricao = nr_prescricao_p;

            if (coalesce(nr_seq_item_p,0) > 0) and (coalesce(nr_seq_horario_p::text, '') = '') then
                update  prescr_mat_hor a
                set     a.dt_lib_horario = clock_timestamp()
                where   coalesce(a.dt_lib_horario::text, '') = ''
                and     a.nr_seq_superior = nr_seq_item_p
                and     a.nr_prescricao = nr_prescricao_p;
            end if;
		elsif (ie_tipo_item_p = 'SUP') then
			update	prescr_mat_hor
			set	dt_lib_horario	= clock_timestamp()
			where	coalesce(dt_lib_horario::text, '') = ''
			and	((nr_seq_material = nr_seq_item_p) or (coalesce(nr_seq_item_p,0) = 0))
			and	ie_agrupador	= 12
			and	nr_sequencia	= coalesce(nr_seq_horario_p,nr_sequencia)
			and	nr_prescricao = nr_prescricao_p;

            if (coalesce(nr_seq_item_p,0) > 0) and (coalesce(nr_seq_horario_p::text, '') = '') then
                update  prescr_mat_hor a
                set     a.dt_lib_horario = clock_timestamp()
                where   coalesce(a.dt_lib_horario::text, '') = ''
                and     a.nr_seq_superior = nr_seq_item_p
                and     a.nr_prescricao = nr_prescricao_p;
            end if;
		elsif (ie_tipo_item_p = 'LD') then
			update	prescr_mat_hor
			set	dt_lib_horario	= clock_timestamp()
			where	coalesce(dt_lib_horario::text, '') = ''
			and	((nr_seq_material = nr_seq_item_p) or (coalesce(nr_seq_item_p,0) = 0))
			and	ie_agrupador	in (16,17)
			and	nr_sequencia	= coalesce(nr_seq_horario_p,nr_sequencia)
			and	nr_prescricao = nr_prescricao_p;
		
		elsif (ie_tipo_item_p = 'GAS') then
			update	prescr_mat_hor
			set	dt_lib_horario	= clock_timestamp()
			where	coalesce(dt_lib_horario::text, '') = ''
			and	((nr_seq_material = nr_seq_item_p) or (coalesce(nr_seq_item_p,0) = 0))
			and	ie_agrupador	= 15
			and	nr_sequencia	= coalesce(nr_seq_horario_p,nr_sequencia)
			and	nr_prescricao = nr_prescricao_p;
		
		end if;
		
	elsif (coalesce(ie_lib_parc_p,'N') = 'N') then
		update	prescr_mat_hor
		set	dt_lib_horario	= clock_timestamp()
		where	coalesce(dt_lib_horario::text, '') = ''
		and	((nr_seq_material = nr_seq_item_p) or (coalesce(nr_seq_item_p,0) = 0))
		and	nr_sequencia	= coalesce(nr_seq_horario_p,nr_sequencia)
		and	nr_prescricao 	= nr_prescricao_p;
	else
		
		update	prescr_mat_hor a
		set		a.dt_lib_horario	= clock_timestamp()
		where	coalesce(a.dt_lib_horario::text, '') = ''
		and		exists (	SELECT	1
							from	prescr_material b
							where	coalesce(b.nr_seq_inconsistencia::text, '') = ''
							and	b.nr_sequencia				=	a.nr_seq_material
							and	b.nr_prescricao				=	a.nr_prescricao )
		and		not exists(	select 	1
							from	prescr_material_incon_farm c
							where	coalesce(c.ie_situacao,'A')  = 'A'
							--and		c.nr_seq_material 	= a.nr_seq_material
							and		((c.nr_seq_material 	= a.nr_seq_material) or (c.nr_seq_material = a.nr_seq_superior))
							and		c.nr_prescricao 	= a.nr_prescricao )
		and		((coalesce(a.nr_seq_solucao::text, '') = '') or (not exists ( 	SELECT 	1
								from	prescr_material_incon_farm y
								where	y.nr_prescricao 	= a.nr_prescricao
								and		y.nr_seq_solucao 	= a.nr_seq_solucao
								and		coalesce(y.ie_situacao,'A') 	= 'A' ) ) )
		and		((nr_seq_material = nr_seq_item_p) or (coalesce(nr_seq_item_p,0) = 0))
		and		nr_sequencia		= coalesce(nr_seq_horario_p,nr_sequencia)
		and		a.nr_prescricao 	= nr_prescricao_p;
		
	end if;

	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;	
	
exception when others then
	sqlerrm_w	:= substr(sqlerrm,1,2000);
	CALL gerar_log_prescricao(nr_prescricao_p, null, null, null, null, sqlerrm_w, nm_usuario_p, 4404, 'S');
end;

begin

ajustar_disp_hor_farm_w := obter_param_usuario(924, 179, cd_perfil_p, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ajustar_disp_hor_farm_w);
ajustar_disp_hor_farm_w	:= coalesce(ajustar_disp_hor_farm_w, 'N');

begin
if (ajustar_disp_hor_farm_w <> 'N') then
	CALL calcular_dispensar_horario(nr_prescricao_p,0);
end if;

exception when others then
	ajustar_disp_hor_farm_w := 'N';
end;

begin
	ie_gera_nutricao_w := obter_param_usuario(924, 545, cd_perfil_p, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_gera_nutricao_w);
	if (ie_gera_nutricao_w = 'S') then
		CALL gerar_servico_nut_pep(nr_prescricao_p,nm_usuario_p,cd_perfil_p);
	end if;
exception when others then
	ie_gera_nutricao_w	:= 'N';
end;

ie_info_rastre_prescr_w := obter_se_info_rastre_prescr( 'L', nm_usuario_p, cd_perfil_p, cd_estabelecimento_w);

if (ie_info_rastre_prescr_w = 'S') then
	ds_alteracao_rastre_w := substr('Gerar log Rastreabilidade Alteracoes / Atualiza_prescr_mat_hor = ' || 'NR_PRESCRICAO_P: ' || nr_prescricao_p || ' IE_LOTE_POS_LIB_W: ' ||  ie_lote_pos_lib_w || ' NR_SEQ_ITEM_P: ' || coalesce(nr_seq_item_p,0),1,1800);
	CALL Gerar_log_prescr_mat(nr_prescricao_p, nr_seq_item_p, null, null, null, ds_alteracao_rastre_w, nm_usuario_p, 'N');
end if;

if (ie_lote_pos_lib_w	= 'N') then
	if (coalesce(nr_seq_item_p,0) = 0) then
		CALL Gerar_Lote_Atend_Prescricao(nr_prescricao_p, 0, 0, 'N', nm_usuario_p, 'GPMH');
	else
		CALL Gerar_Lote_Atend_Prescricao(nr_prescricao_p, nr_seq_item_p, 0, 'N', nm_usuario_p, 'GPMH');
	end if;
end if;

exception
	when others then
	sqlerrm_w	:= substr(sqlerrm,1,2000);
	CALL gerar_log_prescricao(nr_prescricao_p, null, null, null, null, sqlerrm_w, nm_usuario_p, 4404, 'S');
end;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_prescr_mat_hor ( nr_prescricao_p bigint, nr_seq_item_p bigint, cd_perfil_p bigint, nm_usuario_p text, ie_lib_parc_p text default null, ie_tipo_item_p text default null, nr_seq_horario_p bigint default null) FROM PUBLIC;

