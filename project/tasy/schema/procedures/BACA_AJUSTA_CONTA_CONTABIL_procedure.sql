-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_ajusta_conta_contabil ( cd_empresa_p bigint) AS $body$
DECLARE



qt_existe_w				integer;
nm_tabela_w				varchar(50);
nm_atributo_w				varchar(50);
nm_integridade_referencial_w	varchar(50);
ds_comando_w				varchar(255);


c01 CURSOR FOR
SELECT	a.nm_tabela,
	b.nm_atributo,
	a.nm_integridade_referencial
from	integridade_referencial a,
	integridade_atributo b
where	a.nm_tabela_referencia = 'CONTA_CONTABIL'
and	a.nm_tabela = b.nm_tabela
and	a.nm_integridade_referencial = b.nm_integridade_referencial
order by
	a.nm_tabela,
	b.nm_atributo,
	a.nm_integridade_referencial;


BEGIN

/*Consiste se ja existe conta com a nova conta contabil a ser alterada*/

select	count(*)
into STRICT	qt_existe_w
from	conta_contabil
where	position('-' in cd_conta_contabil) > 0
and	cd_conta_contabil = replace(cd_conta_contabil, '-', '_');
if (qt_existe_w > 0) then
	RAISE EXCEPTION '%', 'Este processo não pode ser executado. Ja existe conta com o novo codigo' USING ERRCODE = '45011';
end if;


/*Desabilita todas as constraints*/

OPEN c01;
LOOP
FETCH c01 into
	nm_tabela_w,
	nm_atributo_w,
	nm_integridade_referencial_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	ds_comando_w	:= 'Alter table ' || nm_tabela_w || ' Disable constraint ' || nm_integridade_referencial_w;
	CALL Exec_Sql_Dinamico(nm_tabela_w || ' Disable constraint', ds_comando_w);
end loop;
close c01;


/*Altera o codigo da conta*/

update	conta_contabil
set	cd_conta_contabil = replace(cd_conta_contabil, '-', '_')
where	position('-' in cd_conta_contabil) > 0;


/*Altera a mesma conta para todas as constraints*/

OPEN c01;
LOOP
FETCH c01 into
	nm_tabela_w,
	nm_atributo_w,
	nm_integridade_referencial_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	ds_comando_w	:= ' update ' || nm_tabela_w ||
			   ' set ' || nm_atributo_w || ' = replace( ' || nm_atributo_w || ',' || chr(39) || '-' || chr(39) || ',' || chr(39) || '_' || chr(39) || ')' ||
			   ' where instr( ' || nm_atributo_w || ',' || chr(39) || '-' || chr(39) || ') > 0';
	CALL Exec_Sql_Dinamico(' Alteração das contas -/_' , ds_comando_w);
	end;
end loop;
close c01;


/*Habilita todas as constraints*/

OPEN c01;
LOOP
FETCH c01 into
	nm_tabela_w,
	nm_atributo_w,
	nm_integridade_referencial_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	ds_comando_w	:= 'Alter table ' || nm_tabela_w || ' enable constraint ' || nm_integridade_referencial_w;
	CALL Exec_Sql_Dinamico(nm_tabela_w || ' Enable constraint', ds_comando_w);
end loop;
close c01;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_ajusta_conta_contabil ( cd_empresa_p bigint) FROM PUBLIC;

