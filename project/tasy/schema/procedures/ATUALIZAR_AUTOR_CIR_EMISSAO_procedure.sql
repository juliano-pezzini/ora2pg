-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_autor_cir_emissao ( nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_tipo_preco_p text) AS $body$
DECLARE

 
/* 
ie_tipo_preco_p = 
N - Não obtem preço 
M - Obtem o preço do material 
C - Obtem o preço do convênio 
G - Obtem o preço negociado 
*/
 
 
qt_sem_preco_w		smallint;
nr_seq_material_w		bigint;
cd_estabelecimento_w	smallint;
ds_retorno_w		varchar(255);

c01 CURSOR FOR 
	SELECT	nr_sequencia 
	from	material_autor_cirurgia 
	where	nr_seq_autorizacao = nr_sequencia_p;


BEGIN 
 
open c01;
loop 
	fetch c01 into 
		nr_seq_material_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	if (ie_tipo_preco_p = 'M') then 
		ds_retorno_w := atualizar_preco_material_autor(	nr_seq_material_w, cd_estabelecimento_p, nm_usuario_p, ds_retorno_w);
	elsif (ie_tipo_preco_p = 'C') then 
		ds_retorno_w := atualizar_preco_mat_aut_conv(	nr_seq_material_w, null, cd_estabelecimento_p, nm_usuario_p, ds_retorno_w);
	elsif (ie_tipo_preco_p = 'G') then 
		ds_retorno_w := atualizar_preco_mat_autor_neg(	nr_seq_material_w, cd_estabelecimento_p, nm_usuario_p, ds_retorno_w);
	end if;
	end;
end loop;
close c01;
 
update	autorizacao_cirurgia 
set	dt_liberacao	= clock_timestamp(), 
	nm_usuario	= nm_usuario_p, 
	nm_usuario_lib	= nm_usuario_p 
where	nr_sequencia	= nr_sequencia_p;
 
insert into autor_cirurgia_emissao( 
	nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	nr_seq_autor, 
	cd_setor_atendimento, 
	ie_status, 
	dt_emissao, 
	nr_seq_estagio) 
SELECT	nextval('autor_cirurgia_emissao_seq'), 
	clock_timestamp(), 
	nm_usuario_p, 
	nr_sequencia_p, 
	cd_setor_atendimento, 
	ie_status, 
	null, 
	nr_seq_estagio 
from	regra_emissao_autor_cir;
 
select	count(*) 
into STRICT	qt_sem_preco_w 
from	material_autor_cirurgia 
where	coalesce(vl_material,0) 		= 0 
and	coalesce(vl_unitario_material,0) 	= 0 
and	nr_seq_autorizacao 	= nr_sequencia_p;
 
if (qt_sem_preco_w = 0) then 
	update	autorizacao_cirurgia 
	set	dt_fim_cotacao	= clock_timestamp(), 
		nm_usuario	= nm_usuario_p 
	where	nr_sequencia	= nr_sequencia_p;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_autor_cir_emissao ( nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_tipo_preco_p text) FROM PUBLIC;

