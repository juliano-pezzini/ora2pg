-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_contab_onl_receb_convenio (doc_p INOUT ctb_documento, nm_usuario_p text) AS $body$
DECLARE

/*
===============================================================================
Purpose: Indentacao

Remarks: n/a

Who         When            What
----------  -----------     --------------------------------------------------
chjreinert  13/mai/2021     OS 2444975 - Indentacao

===============================================================================
*/
dt_contabil_w                   timestamp;
dt_contabil_ww                  timestamp;
nr_seq_agrupamento_w            bigint;
nr_seq_conta_banco_w            bigint;
cd_convenio_w                   integer;
ds_nfe_convenio_w               varchar(255);
ds_notas_protocolo_w            varchar(255);
ds_titulos_w                    varchar(255);
ds_notas_fiscais_w              varchar(255);
ie_regra_w                      varchar(255);
ds_retorno_receb_w              varchar(250);
ds_observacao_w                 varchar(255);
ds_conta_banco_w                varchar(255);
ds_convenio_w                   varchar(255)  := '';
ds_atributos_w                  varchar(4000);
cd_pessoa_fisica_w              varchar(10);
cd_cgc_w                        varchar(14);
cd_tributo_w                    tributo.cd_tributo%type;
cd_empresa_w                    empresa.cd_empresa%type;
nr_lote_contabil_w              lote_contabil.nr_lote_contabil%type;
nm_agrupador_w                  agrupador_contabil.nm_atributo%type;
dados_contab_w                  ctb_contab_onl_lote_fin_pck.dados_contab_tf;
cd_tipo_lote_contabil_w         lote_contabil.cd_tipo_lote_contabil%type;
ds_banco_w                      banco_estabelecimento_v.ds_banco%type;
nr_documento_ww                 movimento_contabil.nr_documento%Type;
ie_origem_documento_w           movimento_contabil.ie_origem_documento%Type;
ctb_param_lote_receb_conv_w     ctb_param_lote_receb_conv%rowtype;


BEGIN
dados_contab_w.doc    := doc_p;
cd_tipo_lote_contabil_w := 11;
nr_lote_contabil_w    := ctb_online_pck.get_lote_contabil(  cd_tipo_lote_contabil_w,
                doc_p.cd_estabelecimento,
                doc_p.dt_competencia,
                nm_usuario_p);

cd_empresa_w := obter_empresa_estab(doc_p.cd_estabelecimento);

select  x.*
into STRICT    ctb_param_lote_receb_conv_w
from (SELECT  a.*
        from    ctb_param_lote_receb_conv a
        where   a.cd_empresa    = cd_empresa_w
        and     coalesce(a.cd_estab_exclusivo, doc_p.cd_estabelecimento) = doc_p.cd_estabelecimento
        order   by coalesce(a.cd_estab_exclusivo, 0) desc
        ) x LIMIT 1;

if (doc_p.nm_tabela = 'CONVENIO_RECEB') then
    if (doc_p.nm_atributo = 'VL_RECEBIMENTO') then
        begin
        select  b.cd_convenio,
                nr_seq_conta_banco,
                b.cd_cgc,
                a.ds_observacao
        into STRICT    cd_convenio_w,
                nr_seq_conta_banco_w,
                cd_cgc_w,
                ds_observacao_w
        from    Convenio b,
                Convenio_Receb a
        where   a.nr_sequencia    = doc_p.nr_documento
        and     a.cd_convenio    = b.cd_convenio
        and     (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
        and     ((ctb_param_lote_receb_conv_w.ie_contab_estorno_receb = 'S') or not exists (SELECT  1
                    from  convenio_receb_estorno  e
                    where  e.nr_seq_receb  = a.nr_sequencia));
        end;

elsif (doc_p.nm_atributo = 'VL_DEPOSITO') then
    begin
    select  b.cd_convenio,
            nr_seq_conta_banco,
            b.cd_cgc,
            a.ds_observacao
    into STRICT    cd_convenio_w,
            nr_seq_conta_banco_w,
            cd_cgc_w,
            ds_observacao_w
    from    convenio b,
            convenio_Receb a
    where   a.nr_sequencia  = doc_p.nr_documento
    and     a.cd_convenio  = b.cd_convenio
    and     (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '');
    end;

elsif (doc_p.nm_atributo = 'VL_DESPESA_BANCARIA') then
    begin
    select  b.cd_convenio,
            nr_seq_conta_banco,
            b.cd_cgc,
            a.ds_observacao
    into STRICT    cd_convenio_w,
            nr_seq_conta_banco_w,
            cd_cgc_w,
            ds_observacao_w
    from    convenio b,
            convenio_Receb a
    where   a.nr_sequencia  = doc_p.nr_documento
    and     a.cd_convenio  = b.cd_convenio
    and     (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '');
    end;

  end if;

elsif (doc_p.nm_tabela = 'CONVENIO_RECEB_ADIC') then
    if (doc_p.nm_atributo = 'VL_ADICIONAL') then
        begin
        select  b.cd_convenio,
                a.nr_seq_conta_banco,
                b.cd_cgc,
                1,
                a.ds_observacao,
                e.cd_tributo
        into STRICT    cd_convenio_w,
                nr_seq_conta_banco_w,
                cd_cgc_w,
                nr_seq_agrupamento_w,
                ds_observacao_w,
                cd_tributo_w
        from    convenio b,
                convenio_Receb a,
                convenio_Receb_adic e
        where   e.nr_seq_receb  = doc_p.nr_documento
        and     e.nr_sequencia  = doc_p.nr_seq_doc_compl
        and     a.cd_convenio  = b.cd_convenio
        and     a.nr_sequencia  = e.nr_seq_receb
        and     (e.nr_seq_trans_financ IS NOT NULL AND e.nr_seq_trans_financ::text <> '');
        end;

elsif (doc_p.nm_atributo = 'VL_CAMBIAL_ATIVO' or doc_p.nm_atributo = 'VL_CAMBIAL_PASSIVO') then
    begin
    select  a.cd_convenio,
            a.nr_seq_conta_banco,
            a.cd_cgc,
            a.nr_agrupamento,
            a.ds_observacao
     into STRICT   cd_convenio_w,
            nr_seq_conta_banco_w,
            cd_cgc_w,
            nr_seq_agrupamento_w,
            ds_observacao_w
    from    ctb_receb_convenio_cambial_v a
    where   a.nr_sequencia     = doc_p.nr_documento
    and     a.nr_seq_receb    = doc_p.nr_seq_doc_compl
    and     a.nm_atributo    = doc_p.nm_atributo;
    end;

end if;

elsif (doc_p.nm_tabela = 'CONVENIO_RECEB_ESTORNO') then
  if (doc_p.nm_atributo = 'VL_RECEBIMENTO' and ctb_param_lote_receb_conv_w.ie_contab_estorno_receb = 'S') then
    begin
      select  b.cd_convenio,
              nr_seq_conta_banco,
              b.cd_cgc,
              1,
              a.ds_observacao
      into STRICT   cd_convenio_w,
              nr_seq_conta_banco_w,
              cd_cgc_w,
              nr_seq_agrupamento_w,
              ds_observacao_w
      from   Convenio b,
              Convenio_Receb a,
              Convenio_Receb_estorno e
      where  e.nr_seq_receb  = doc_p.nr_documento
      and    e.nr_sequencia  = doc_p.nr_seq_doc_compl
      and    a.cd_convenio  = b.cd_convenio
      and    a.nr_sequencia  = e.nr_seq_receb
      and    (coalesce(e.nr_seq_trans_fin,a.nr_seq_trans_fin) IS NOT NULL AND (coalesce(e.nr_seq_trans_fin,a.nr_seq_trans_fin))::text <> '');
    end;

elsif (doc_p.nm_atributo = 'VL_DEPOSITO' and ctb_param_lote_receb_conv_w.ie_contab_estorno_receb = 'S') then
    begin
      select  b.cd_convenio,
              nr_seq_conta_banco,
              b.cd_cgc,
              1,
              a.ds_observacao
      into STRICT  cd_convenio_w,
              nr_seq_conta_banco_w,
              cd_cgc_w,
              nr_seq_agrupamento_w,
              ds_observacao_w
      from   Convenio b,
              Convenio_Receb a,
              Convenio_Receb_estorno e
      where  e.nr_seq_receb  = doc_p.nr_documento
      and    e.nr_sequencia  = doc_p.nr_seq_doc_compl
      and    a.cd_convenio  = b.cd_convenio
      and    a.nr_sequencia  = e.nr_seq_receb
      and    (coalesce(e.nr_seq_trans_fin,a.nr_seq_trans_fin) IS NOT NULL AND (coalesce(e.nr_seq_trans_fin,a.nr_seq_trans_fin))::text <> '');
    end;

elsif (doc_p.nm_atributo = 'VL_ADICIONAL_ESTORNO' and ctb_param_lote_receb_conv_w.ie_contab_vl_adic_estorno = 'S') then
    begin
    select  b.cd_convenio,
            nr_seq_conta_banco,
            b.cd_cgc,
            1,
            a.ds_observacao
    into STRICT    cd_convenio_w,
            nr_seq_conta_banco_w,
            cd_cgc_w,
            nr_seq_agrupamento_w,
            ds_observacao_w
    from    convenio b,
            convenio_Receb a,
            convenio_Receb_estorno e
    where   e.nr_seq_receb  = doc_p.nr_documento
    and     e.nr_sequencia  = doc_p.nr_seq_doc_compl
    and     a.cd_convenio  = b.cd_convenio
    and     a.nr_sequencia  = e.nr_seq_receb
    and     (a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '');
    end;

end if;
elsif (doc_p.nm_tabela = 'CONVENIO_RECEB_ADIANT') then
  if (doc_p.nm_atributo = 'VL_ADIANTAMENTO') then
    begin
      select    b.cd_convenio,
        a.nr_seq_conta_banco,
        a.cd_cgc,
        0,
        a.ds_observacao
    into STRICT    cd_convenio_w,
        nr_seq_conta_banco_w,
        cd_cgc_w,
        nr_seq_agrupamento_w,
        ds_observacao_w
    from    adiantamento a,
        convenio_receb b,
        convenio_receb_adiant c
    where   c.nr_sequencia      = doc_p.nr_documento
    and c.nr_seq_receb      = doc_p.nr_documento
    and b.nr_sequencia      = c.nr_seq_receb
    and c.nr_adiantamento   = a.nr_adiantamento
    and (coalesce(a.nr_seq_trans_fin, b.nr_seq_trans_fin) IS NOT NULL AND (coalesce(a.nr_seq_trans_fin, b.nr_seq_trans_fin))::text <> '');
    end;
  end if;
end if;

select  dt_referencia,
        dt_referencia
into STRICT    dt_contabil_w,
        dt_contabil_ww
from    lote_contabil
where   nr_lote_contabil = nr_lote_contabil_w;

nm_agrupador_w  := coalesce(trim(both obter_agrupador_contabil(11)), 'NR_SEQ_RECEBIMENTO');

if (coalesce(ctb_param_lote_receb_conv_w.ie_dt_contab_conv_receb, 'L') = 'R') then
    dt_contabil_w  := doc_p.dt_competencia;
end if;

ds_conta_banco_w    := substr(obter_conta_banco(nr_seq_conta_banco_w),1,254);
ds_convenio_w       := substr(obter_nome_pf_pj(null, cd_cgc_w),1,80);

if (nr_seq_conta_banco_w IS NOT NULL AND nr_seq_conta_banco_w::text <> '') then
  select    coalesce(max(ds_banco),'')
  into STRICT      ds_banco_w
  from      banco_estabelecimento_v
  where     nr_sequencia  = nr_seq_conta_banco_w;
end if;

ds_retorno_receb_w  := substr(obter_dados_convenio_receb(doc_p.nr_documento,'rc'),1,250);
ds_notas_fiscais_w  := substr(obter_nf_convenio_receb(doc_p.nr_documento), 1,255);
ds_titulos_w        := substr(obter_titulos_convenio_receb(doc_p.nr_documento),1,255);
ds_notas_protocolo_w:= substr(obter_nf_titulos_convenio_rec(doc_p.nr_documento),1,255);
ds_nfe_convenio_w   := substr(obter_nfe_convenio_receb(doc_p.nr_documento),1,255);

CALL ctb_online_pck.definir_atrib_compl(doc_p.cd_tipo_lote_contabil);
CALL ctb_online_pck.set_value_compl_hist('DS_BANCO', ds_banco_w);
CALL ctb_online_pck.set_value_compl_hist('DS_CONTA_BANCO', ds_conta_banco_w);
CALL ctb_online_pck.set_value_compl_hist('DS_CONVENIO', ds_convenio_w);
CALL ctb_online_pck.set_value_compl_hist('DS_NOTAS_FISCAIS', ds_notas_fiscais_w);
CALL ctb_online_pck.set_value_compl_hist('DS_NOTAS_PROTOCOLO', ds_notas_protocolo_w);
CALL ctb_online_pck.set_value_compl_hist('DS_OBSERVACAO', ds_observacao_w);
CALL ctb_online_pck.set_value_compl_hist('DS_RETORNO_RECEB', ds_retorno_receb_w);
CALL ctb_online_pck.set_value_compl_hist('DS_TITULOS', ds_titulos_w);
CALL ctb_online_pck.set_value_compl_hist('DT_CONTABIL', dt_contabil_ww);
CALL ctb_online_pck.set_value_compl_hist('DT_RECEBIMENTO', doc_p.dt_competencia);
CALL ctb_online_pck.set_value_compl_hist('NR_NFE_IMP', ds_nfe_convenio_w);
CALL ctb_online_pck.set_value_compl_hist('NR_SEQ_RECEB', doc_p.nr_documento);

if (nm_agrupador_w = 'NR_SEQ_RECEBIMENTO')then
    nr_seq_agrupamento_w  := doc_p.nr_documento;
end if;

if (coalesce(nr_seq_agrupamento_w,0) = 0)then
    nr_seq_agrupamento_w  := doc_p.nr_documento;
end if;

ds_atributos_w  := 'NR_SEQ_RECEB_CONVENIO=' || doc_p.nr_documento;

ctb_obter_doc_movto(cd_tipo_lote_contabil_w,
          doc_p.nm_atributo,
          'VR',
          dt_contabil_w,
          null,
          null,
          ds_atributos_w,
          nm_usuario_p,
          ie_regra_w,
          nr_documento_ww,
          ie_origem_documento_w);

dados_contab_w.cd_estab_movto       := doc_p.cd_estabelecimento;
dados_contab_w.nr_lote_contabil     := nr_lote_contabil_w;
dados_contab_w.nr_seq_agrupamento   := nr_seq_agrupamento_w;
dados_contab_w.dt_transacao         := dt_contabil_w;
dados_contab_w.nr_seq_trans_fin     := doc_p.nr_seq_trans_financ;
dados_contab_w.nr_seq_conta_banco   := nr_seq_conta_banco_w;
dados_contab_w.nm_atributo          := doc_p.nm_atributo;
dados_contab_w.cd_pessoa_fisica     := cd_pessoa_fisica_w;
dados_contab_w.cd_cnpj              := cd_cgc_w;
dados_contab_w.cd_convenio          := cd_convenio_w;
dados_contab_w.nr_doc_movto         := nr_documento_ww;
dados_contab_w.cd_tributo           := cd_tributo_w;
dados_contab_w.cd_tributo_regra     := cd_tributo_w;
dados_contab_w.ie_origem_documento  := ie_origem_documento_w;

ctb_contab_onl_lote_fin_pck.contabiliza_trans_financ(dados_contab_w,doc_p.nm_usuario);

doc_p  := dados_contab_w.doc;

if (coalesce(doc_p.ds_inconsistencia, 'X') = 'X') then

    update    lote_contabil
    set       dt_integracao   = clock_timestamp(),
              dt_geracao_lote = clock_timestamp()
    where    nr_lote_contabil = nr_lote_contabil_w;

    update    convenio_receb
    set       nr_lote_contabil    = nr_lote_contabil_w
    where     nr_sequencia        = doc_p.nr_documento
    and       doc_p.nm_tabela     = 'CONVENIO_RECEB';

    update    convenio_receb_estorno
    set       nr_lote_contabil    = nr_lote_contabil_w
    where     nr_seq_receb        = doc_p.nr_documento
    and       nr_sequencia        = doc_p.nr_seq_doc_compl
    and       doc_p.nm_tabela     = 'CONVENIO_RECEB_ESTORNO';

    update    convenio_receb_adic
    set       nr_lote_contabil    = nr_lote_contabil_w
    where     nr_seq_receb        = doc_p.nr_documento
    and       nr_sequencia        = doc_p.nr_seq_doc_compl
    and       doc_p.nm_tabela     = 'CONVENIO_RECEB_ADIC';

    update    convenio_receb_adic
    set       nr_lote_contabil    = nr_lote_contabil_w
    where     nr_seq_receb        = doc_p.nr_documento
    and       nr_sequencia        = doc_p.nr_seq_doc_compl
    and       doc_p.nm_tabela     = 'CONVENIO_RECEB_ADIANT';
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_contab_onl_receb_convenio (doc_p INOUT ctb_documento, nm_usuario_p text) FROM PUBLIC;

