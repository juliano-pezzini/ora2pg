-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_info_censo ( nr_dimensao_p bigint, nr_informacao_p bigint, ds_filtros_p text, dt_inicial_p timestamp, dt_final_p timestamp, ie_periodo_p text, ds_comando_p INOUT text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


ds_comando_w			varchar(4000);
nm_tablespace_w			varchar(400);
nm_atributo_dim_w		varchar(4000);
nm_atributo_dim_drill_w	varchar(4000);
nm_atributo_inf_w		varchar(4000);
ds_informacao_w			varchar(4000);
ds_where_w				varchar(4000);
ds_group_by_w			varchar(4000);
ds_dimensao_w			varchar(4000);
ie_tipo_ordem_classif_w	varchar(1);
ie_classificacao_ordem_w	varchar(2);
ds_orderby_w			varchar(4000);
ds_tipo_orderby_w		varchar(100);
ds_filtros_w			varchar(4000);


BEGIN

ds_filtros_w	:= ds_filtros_p;

select	' TABLESPACE '||obter_tablespace_tab_temp
into STRICT	nm_tablespace_w
;

CALL exec_sql_dinamico('TASY', ' drop table w_censo_' || replace(replace(Elimina_Caracteres_Especiais(nm_usuario_p),' ',''),'.',''));

select 	max(a.nm_Atributo),
		max(a.nm_atributo_drill),
		max(a.ie_tipo_ordem_classif),
		max(a.ie_classificacao_ordem)
into STRICT	nm_atributo_dim_w,
		nm_atributo_dim_drill_w,
		ie_tipo_ordem_classif_w,
		ie_classificacao_ordem_w
from  	indicador_gestao_atrib a,
		indicador_gestao b
where 	a.nr_seq_ind_gestao = b.nr_sequencia
and		b.nr_seq_wheb = 1180
and   	(ds_dimensao IS NOT NULL AND ds_dimensao::text <> '')
and   	coalesce(a.ie_situacao,'A') = 'A'
and		a.nr_sequencia	= nr_dimensao_p;


if (nm_atributo_dim_drill_w	= 'IE_TIPO_CONVENIO') then
	nm_atributo_dim_drill_w	:= ' substr(obter_tipo_convenio(cd_convenio),1,200) ';
elsif (nm_atributo_dim_drill_w	= 'CD_ESPECIALIDADE') then
	nm_atributo_dim_drill_w	:= ' substr(nvl(obter_especialidade_medico(cd_medico, ''C''), wheb_mensagem_pck.get_texto(246341)),1,120) ';
elsif (nm_atributo_dim_drill_w	= 'DS_FAIXA_ETARIA') then
	nm_atributo_dim_drill_w	:= ' SUBSTR(OBTER_FAIXA_ETARIA_CENSO(A.CD_PESSOA_FISICA),1,50) ';
elsif (nm_atributo_dim_drill_w	= 'CD_IDADE') then
	nm_atributo_dim_drill_w	:= ' SUBSTR(LPAD(OBTER_IDADE_PF(A.CD_PESSOA_FISICA, SYSDATE, ''A''),3,''0''),1,50) ';
elsif (nm_atributo_dim_drill_w	= 'IE_SEXO') then
	nm_atributo_dim_drill_w	:= ' obter_sexo_pf(a.cd_pessoa_fisica,''C'') ';
elsif (nm_atributo_dim_drill_w	= 'CD_CLASSIF_ETARIA') then
	nm_atributo_dim_drill_w	:= ' SUBSTR(Obter_classif_etaria(A.CD_ESTABELECIMENTO,A.CD_PESSOA_FISICA,''C''),1,200) ';
elsif (nm_atributo_dim_drill_w	= 'CD_MUNICIPIO_IBGE') then
	nm_atributo_dim_drill_w	:= ' substr(nvl(obter_compl_pf(a.cd_pessoa_fisica,1,''CDM''),null),1,100) ';
elsif (nm_atributo_dim_drill_w	= 'CD_COORD_MUN_IBGE') then
	nm_atributo_dim_drill_w	:= ' substr(nvl(obter_coord_munic_censo(substr(nvl(obter_compl_pf(a.cd_pessoa_fisica,1,''CDM''),null),1,100)),null),1,100) ';
end if;

--ds_filtros_w	:= replace(ds_filtros_w,'DS_ESTADO_CIVIL','');
ds_filtros_w	:= replace(upper(ds_filtros_w),'IE_TIPO_CONVENIO','substr(obter_tipo_convenio(cd_convenio),1,200)');
ds_filtros_w	:= replace(upper(ds_filtros_w),'CD_COORD_MUN_IBGE','substr(nvl(obter_coord_munic_censo(substr(nvl(obter_compl_pf(a.cd_pessoa_fisica,1,''CDM''),null),1,100)),null),1,100)');
ds_filtros_w	:= replace(upper(ds_filtros_w),'CD_IDADE','SUBSTR(LPAD(OBTER_IDADE_PF(A.CD_PESSOA_FISICA, SYSDATE, ''A''),3,''0''),1,50)');
ds_filtros_w	:= replace(upper(ds_filtros_w),'CD_ESPECIALIDADE','substr(nvl(obter_especialidade_medico(cd_medico, ''C''), 0),1,120)');
ds_filtros_w	:= replace(upper(ds_filtros_w),'IE_SEXO',' obter_sexo_pf(a.cd_pessoa_fisica,''C'')');
ds_filtros_w	:= replace(upper(ds_filtros_w),'CD_CLASSIF_ETARIA','SUBSTR(OBTER_CLASSIF_ETARIA_CENSO(A.CD_ESTABELECIMENTO,A.CD_PESSOA_FISICA,''C''),1,200)');
ds_filtros_w	:= replace(upper(ds_filtros_w),'CD_MUNICIPIO_IBGE','substr(nvl(obter_compl_pf(a.cd_pessoa_fisica,1,''CDM''),null),1,100)');
ds_filtros_w	:= replace(upper(ds_filtros_w),'DS_FAIXA_ETARIA','SUBSTR(OBTER_FAIXA_ETARIA_CENSO(A.CD_PESSOA_FISICA),1,50)');

/*
criação do select da dimensão
*/
ds_dimensao_w	:= nm_atributo_dim_w || ' ds_base, ' || nm_atributo_dim_drill_w || ' cd_base, ' || chr(32);

ds_group_by_w	:= ' group by '||nm_atributo_dim_w || ', ' || nm_atributo_dim_drill_w|| chr(32);



select	max(a.nm_atributo)
into STRICT	nm_atributo_inf_w
from	indicador_gestao_atrib a,
		indicador_gestao b
where	a.nr_seq_ind_gestao	= b.nr_sequencia
and		b.nr_seq_wheb = 1180
and		a.nr_sequencia		= nr_informacao_p;

nm_atributo_inf_w	:= replace(nm_atributo_inf_w,':CD_DIMENSAO',nm_atributo_dim_drill_w);
if (ie_periodo_p	= 'D') then
	nm_atributo_inf_w	:= replace(nm_atributo_inf_w,':NR_DIAS_CENSO',1);
else
	nm_atributo_inf_w	:= replace(nm_atributo_inf_w,':NR_DIAS_CENSO',trunc(trunc(dt_final_p) - trunc(dt_inicial_p)) + 1);
end if;

/*
criação do select da informação
*/
if (position('SUM' in nm_atributo_inf_w) = 0) then
	ds_informacao_w	:= ' sum('||nm_atributo_inf_w||') nr_acum '|| chr(32);
else
	ds_informacao_w	:= nm_atributo_inf_w||' nr_acum '|| chr(32);
end if;

ds_where_w	:=	' where cd_estabelecimento = ' || cd_estabelecimento_p || chr(32) ||
			' and '||nm_atributo_dim_w||' is not null '||chr(32)||
			ds_filtros_w;

/*
criação do filtro de data
*/
if (nm_atributo_inf_w	= 'NR_PAC') or/* internados  */
	(nm_atributo_inf_w	= 'NR_PACIENTES') then
	if (dt_final_p > clock_timestamp()) then
		ds_where_w	:= ds_where_w || chr(32)||
				' and ie_periodo = ''D'' ' || chr(32)||
				' and trunc(DT_REFERENCIA,''dd'') = TO_DATE('''||to_char(trunc(clock_timestamp()),'dd/mm/yyyy')||''',''dd/mm/yyyy'') ';
	else
		ds_where_w	:= ds_where_w || chr(32)||
				' and ie_periodo = ''D'' ' || chr(32)||
				' and trunc(DT_REFERENCIA,''dd'') = TO_DATE('''||to_char(trunc(dt_final_p),'dd/mm/yyyy')||''',''dd/mm/yyyy'') ';
	end if;
elsif (ie_periodo_p	= 'D') then
	ds_where_w	:= ds_where_w || chr(32)||
				' and ie_periodo = ''D'' ' || chr(32)||
				' and trunc(DT_REFERENCIA,''dd'') = TO_DATE('''||to_char(trunc(dt_inicial_p),'dd/mm/yyyy')||''',''dd/mm/yyyy'') ';
elsif (ie_periodo_p	= 'MP') or (ie_periodo_p	= 'M') then
	ds_where_w	:= ds_where_w ||
			' and ie_periodo = ''M'' ' || chr(32) ||
			' and DT_REFERENCIA between TO_DATE('''||to_char(trunc(dt_inicial_p),'dd/mm/yyyy')||''',''dd/mm/yyyy'') and to_date('''||to_char(trunc(dt_final_p),'dd/mm/yyyy')||''',''dd/mm/yyyy'') ';
elsif (ie_periodo_p	= 'DP') then
	ds_where_w	:= ds_where_w ||
			' and ie_periodo = ''D'' ' ||chr(32) ||
			' and DT_REFERENCIA between TO_DATE('''||to_char(trunc(dt_inicial_p),'dd/mm/yyyy')||''',''dd/mm/yyyy'') and to_date('''||to_char(trunc(dt_final_p),'dd/mm/yyyy')||''',''dd/mm/yyyy'') + 86399/86400 ';
end if;


/*
criação do order by
*/
if (ie_tipo_ordem_classif_w	= 'D') then
	ds_tipo_orderby_w	:= ' desc ';
else
	ds_tipo_orderby_w	:= ' asc ';
end if;

if (ie_classificacao_ordem_w	= 'D') then
	ds_orderby_w	:= ' order by 1 '||ds_tipo_orderby_w;
elsif (ie_classificacao_ordem_w = 'C') and (nm_atributo_dim_drill_w IS NOT NULL AND nm_atributo_dim_drill_w::text <> '') then
	ds_orderby_w	:= ' order by 3 '||ds_tipo_orderby_w;
else
	ds_orderby_w	:= ' order by 2 '||ds_tipo_orderby_w;
end if;

/*
comando para geração da tabela w
*/
ds_comando_w	:= 	' select ' || chr(32)||
			ds_dimensao_w || chr(32)||
			ds_informacao_w || chr(32)||
			' from	eis_censo_diario_v3 a' || chr(32)||
			ds_where_w || chr(32)||
			ds_group_by_w|| chr(32)||
			ds_orderby_w;

CALL exec_sql_dinamico('TASY', ' create table w_censo_' || replace(replace(Elimina_Caracteres_Especiais(nm_usuario_p),' ',''),'.','') || nm_tablespace_w ||' as ' || ds_comando_w);

ds_comando_p	:= ' select ds_base, nr_acum, cd_base from w_censo_'||replace(replace(Elimina_Caracteres_Especiais(nm_usuario_p),' ',''),'.','')||' '||ds_orderby_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_info_censo ( nr_dimensao_p bigint, nr_informacao_p bigint, ds_filtros_p text, dt_inicial_p timestamp, dt_final_p timestamp, ie_periodo_p text, ds_comando_p INOUT text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

