-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE proj_comunicar_atual_consult ( ie_evento_p text, nr_seq_consultor_p bigint, nr_seq_canal_p bigint, nm_usuario_p text ) AS $body$
DECLARE

 
nr_seq_regra_w			bigint;
ie_comunic_interna_w		varchar(1);
ie_email_w			varchar(1);
ds_titulo_w			varchar(255);
ds_comunicado_w			varchar(4000);
ie_existe_usuario_w		varchar(1);
ie_responsavel_w		varchar(5);
nm_usuario_destino_w		varchar(15);
ds_email_usuario_w		varchar(255);
nm_consultor_w			varchar(60);
nm_guerra_w			varchar(60);

c01 CURSOR FOR 
SELECT	nr_sequencia nr_seq_regra, 
	ie_comunic_interna, 
	ie_email, 
	ds_titulo, 
	ds_comunicado 
from	proj_regra_comunicado 
where	ie_situacao = 'A' 
and	ie_evento = ie_evento_p;

c02 CURSOR FOR 
SELECT	ie_responsavel, 
	nm_usuario_destino 
from	proj_usuario_comunicado 
where	nr_seq_regra = nr_seq_regra_w;


BEGIN 
 
	open c01;
	loop 
	fetch c01 into 
		nr_seq_regra_w, 
		ie_comunic_interna_w, 
		ie_email_w, 
		ds_titulo_w, 
		ds_comunicado_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
 
		select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  
		into STRICT	ie_existe_usuario_w 
		from	proj_usuario_comunicado 
		where	nr_seq_regra = nr_seq_regra_w 
		and	(nm_usuario_destino IS NOT NULL AND nm_usuario_destino::text <> '');
 
		if (ie_existe_usuario_w = 'S') then 
		 
			select	substr(obter_nome_pf(cd_pessoa_fisica), 1, 60) 
			into STRICT	nm_consultor_w 
			from	com_canal_consultor 
			where	nr_sequencia = nr_seq_consultor_p;
 
			select	nm_guerra 
			into STRICT	nm_guerra_w 
			from	com_canal 
			where	nr_sequencia = nr_seq_canal_p;
 
			ds_comunicado_w := replace_macro(ds_comunicado_w, '@NM_CONSULTOR', nm_consultor_w);
			ds_comunicado_w := replace_macro(ds_comunicado_w, '@NM_CANAL', nm_guerra_w);
 
			open c02;
			loop 
			fetch c02 into 
				ie_responsavel_w, 
				nm_usuario_destino_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
			begin 
			 
				if (ie_comunic_interna_w = 'S') then 
 
					CALL gerar_comunic_padrao( 
						clock_timestamp(), 
						ds_titulo_w, 
						ds_comunicado_w, 
						nm_usuario_p, 
						'N', 
						nm_usuario_destino_w, 
						'N', 
						null, 
						null, 
						null, 
						null, 
						clock_timestamp(), 
						null, 
						null);
 
					commit;
 
				end if;
 
				if (ie_email_w = 'S') then 
 
					if (ie_responsavel_w = 'C') then 
 
						select	obter_dados_pf_pj(null, max(cd_cnpj), 'M') 
						into STRICT	ds_email_usuario_w 
						from	com_canal 
						where	nr_sequencia = nr_seq_canal_p;
 
					else 
						ds_email_usuario_w := obter_dados_usuario_opcao(nm_usuario_destino_w, 'E');
					end if;
 
					if (ds_email_usuario_w IS NOT NULL AND ds_email_usuario_w::text <> '') then 
						CALL enviar_email(	ds_titulo_w, 
								ds_comunicado_w, 
								'support.informatics@philips.com', 
								ds_email_usuario_w, 
								'Tasy', 
								'M' );
					end if;
 
				end if;
 
			end;
			end loop;
			close c02;
			 
		end if;
 
	end;
	end loop;
	close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proj_comunicar_atual_consult ( ie_evento_p text, nr_seq_consultor_p bigint, nr_seq_canal_p bigint, nm_usuario_p text ) FROM PUBLIC;

