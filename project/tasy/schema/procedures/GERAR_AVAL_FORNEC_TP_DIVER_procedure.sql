-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_aval_fornec_tp_diver ( dt_referencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE
	

dt_referencia_w				inspecao_recebimento.dt_recebimento%type;
dt_fim_mes_w				inspecao_recebimento.dt_recebimento%type;
cd_cgc_w				inspecao_recebimento.cd_cgc%type;
qt_real_inspecao_w			bigint;
ie_tipo_divergencia_w			inspecao_tipo_divergencia.ie_tipo_divergencia%type;
ie_criterio_avaliacao_w			inspecao_tipo_divergencia.ie_criterio_avaliacao%type;
qt_eficiencia_w				bigint := 0;
qt_integridade_w			bigint := 0;
qt_pontualidade_w			bigint := 0;
qt_divergencias_w			bigint := 0;
nr_seq_avaliacao_w			avaliacao_fornecedor.nr_sequencia%type;
qt_real_entrega_w			bigint;
ie_avaliar_mes_ref_w			parametro_compras.ie_avaliar_mes_ref%type;
qt_dias_consulta_w			parametro_compras.qt_dias_considera_avaliacao%type;
ie_pontualidade_entrega_w		varchar(1);
ie_eficiencia_atendimento_w		varchar(1);
ie_integridade_produto_w		varchar(1);
ie_conceito_insp_real_w			parametro_compras.ie_conceito_insp_real%type;
qt_div_conceito_geral_w			bigint;
qt_conceito_geral_w			bigint;
qt_peso_pontualidade_w			parametro_compras.qt_peso_aval_pontualidade%type;
qt_peso_eficiencia_w			parametro_compras.qt_peso_aval_eficiencia%type;
qt_peso_integridade_w			parametro_compras.qt_peso_aval_integridade%type;
ie_conceito_geral_w			varchar(1);
qt_devolucao_w				bigint;
qt_nao_conform_w			bigint;
qt_nota_devolucao_w			bigint;
qt_nota_devol_rnc_w			bigint;
nr_documento_w				inspecao_recebimento.nr_sequencia%type;
					
c01 CURSOR FOR
SELECT	cd_cgc,
	count(*)
from	inspecao_recebimento
where	dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
and	ie_avaliar_mes_ref_w = 'N'
and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
group by cd_cgc

union

SELECT	cd_cgc,
	count(*)
from	inspecao_recebimento
where	dt_recebimento between dt_referencia_w and dt_fim_mes_w
and	ie_avaliar_mes_ref_w = 'S'
and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
group by cd_cgc;

c02 CURSOR FOR
SELECT	ie_tipo_divergencia,
	ie_criterio_avaliacao
from	inspecao_tipo_divergencia
where	ie_situacao = 'A'
and	cd_estabelecimento = cd_estabelecimento_p
and	(ie_tipo_divergencia IS NOT NULL AND ie_tipo_divergencia::text <> '')
and	(ie_criterio_avaliacao IS NOT NULL AND ie_criterio_avaliacao::text <> '');

c03 CURSOR FOR
SELECT	i.nr_sequencia
from	inspecao_recebimento i,
	inspecao_recebimento_lote l
where	i.nr_sequencia = l.nr_seq_inspecao
and	i.dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
and	ie_avaliar_mes_ref_w = 'N'
and	(i.cd_cgc IS NOT NULL AND i.cd_cgc::text <> '')
and	(i.dt_liberacao IS NOT NULL AND i.dt_liberacao::text <> '')
and	i.cd_cgc = cd_cgc_w
and	l.dt_validade < (i.dt_recebimento + (	SELECT	coalesce(max(r.qt_dias_validade),0)
						from 	inspecao_regra_material r
						where 	r.cd_estabelecimento = cd_estabelecimento_p
						and 	r.cd_material = i.cd_material
						and 	r.ie_validade = 'S'))

union all

select	i.nr_sequencia
from	inspecao_recebimento i,
	inspecao_recebimento_lote l
where	i.nr_sequencia = l.nr_seq_inspecao
and	i.dt_recebimento between dt_referencia_w and dt_fim_mes_w
and	ie_avaliar_mes_ref_w = 'S'
and	(i.cd_cgc IS NOT NULL AND i.cd_cgc::text <> '')
and	(i.dt_liberacao IS NOT NULL AND i.dt_liberacao::text <> '')
and	i.cd_cgc = cd_cgc_w
and	l.dt_validade < (i.dt_recebimento + (	select	coalesce(max(r.qt_dias_validade),0)
						from 	inspecao_regra_material r
						where 	r.cd_estabelecimento = cd_estabelecimento_p
						and 	r.cd_material = i.cd_material
						and 	r.ie_validade = 'S'));

c04 CURSOR FOR							
SELECT distinct i.nr_sequencia
from	inspecao_recebimento i,
	nota_fiscal_item nfi
where i.nr_seq_nota_fiscal = nfi.nr_sequencia
and	i.nr_seq_item_nf = nfi.nr_item_nf
and ((ie_avaliar_mes_ref_w = 'S' and
	i.dt_recebimento between dt_referencia_w and dt_fim_mes_w) or
	(ie_avaliar_mes_ref_w = 'N' and i.dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)))
and	(i.dt_liberacao IS NOT NULL AND i.dt_liberacao::text <> '')
and	i.cd_cgc = cd_cgc_w
and	i.cd_material <> nfi.cd_material;

c05 CURSOR FOR	
SELECT	nr_sequencia
from	inspecao_recebimento
where	dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
and	ie_avaliar_mes_ref_w = 'N'
and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	cd_cgc = cd_cgc_w
and	cd_condicao_pagamento <> obter_dados_ordem_compra(nr_ordem_compra,'CP')

union all

SELECT	nr_sequencia
from	inspecao_recebimento
where	dt_recebimento between dt_referencia_w and dt_fim_mes_w
and	ie_avaliar_mes_ref_w = 'S'
and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	cd_cgc = cd_cgc_w
and	cd_condicao_pagamento <> obter_dados_ordem_compra(nr_ordem_compra,'CP');

c06 CURSOR FOR	
SELECT	nr_sequencia
from	inspecao_recebimento
where	dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
and	ie_avaliar_mes_ref_w = 'N'
and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	cd_cgc = cd_cgc_w
and	dt_entrega_real < obter_dt_prev_oci_inspecao(nr_sequencia)

union all

SELECT	nr_sequencia
from	inspecao_recebimento
where	dt_recebimento between dt_referencia_w and dt_fim_mes_w
and	ie_avaliar_mes_ref_w = 'S'
and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	cd_cgc = cd_cgc_w
and	dt_entrega_real < obter_dt_prev_oci_inspecao(nr_sequencia);

c07 CURSOR FOR	
SELECT	nr_sequencia
from	inspecao_recebimento
where	dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
and	ie_avaliar_mes_ref_w = 'N'
and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	cd_cgc = cd_cgc_w
and	dt_entrega_real <> obter_dt_prev_oci_inspecao(nr_sequencia)

union all

SELECT	nr_sequencia
from	inspecao_recebimento
where	dt_recebimento between dt_referencia_w and dt_fim_mes_w
and	ie_avaliar_mes_ref_w = 'S'
and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	cd_cgc = cd_cgc_w
and	dt_entrega_real <> obter_dt_prev_oci_inspecao(nr_sequencia);

c08 CURSOR FOR	
SELECT	nr_sequencia
from	inspecao_recebimento
where	dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
and	ie_avaliar_mes_ref_w = 'N'
and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	cd_cgc = cd_cgc_w
and	dt_entrega_real > obter_dt_prev_oci_inspecao(nr_sequencia)

union all

SELECT	nr_sequencia
from	inspecao_recebimento
where	dt_recebimento between dt_referencia_w and dt_fim_mes_w
and	ie_avaliar_mes_ref_w = 'S'
and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	cd_cgc = cd_cgc_w
and	dt_entrega_real > obter_dt_prev_oci_inspecao(nr_sequencia);

c09 CURSOR FOR	
SELECT	nr_sequencia
from	inspecao_recebimento
where	dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
and	ie_avaliar_mes_ref_w = 'N'
and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	cd_cgc = cd_cgc_w
and	obter_qt_prev_oci_inspecao(nr_sequencia) <> qt_inspecao

union all

SELECT	nr_sequencia
from	inspecao_recebimento
where	dt_recebimento between dt_referencia_w and dt_fim_mes_w
and	ie_avaliar_mes_ref_w = 'S'
and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	cd_cgc = cd_cgc_w
and	obter_qt_prev_oci_inspecao(nr_sequencia) <> qt_inspecao;

c10 CURSOR FOR	
SELECT	i.nr_sequencia
from	inspecao_recebimento i
where	i.dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
and	ie_avaliar_mes_ref_w = 'N'
and	(i.cd_cgc IS NOT NULL AND i.cd_cgc::text <> '')
and	(i.dt_liberacao IS NOT NULL AND i.dt_liberacao::text <> '')
and	i.cd_cgc = cd_cgc_w
and	i.vl_unitario_material <> (SELECT	coalesce(max(o.vl_unitario_material),0)
				from	ordem_compra_item o
				where	o.nr_ordem_compra = i.nr_ordem_compra
				and	o.nr_item_oci = i.nr_item_oci)

union all

select	i.nr_sequencia
from	inspecao_recebimento i
where	i.dt_recebimento between dt_referencia_w and dt_fim_mes_w
and	ie_avaliar_mes_ref_w = 'S'
and	(i.cd_cgc IS NOT NULL AND i.cd_cgc::text <> '')
and	(i.dt_liberacao IS NOT NULL AND i.dt_liberacao::text <> '')
and	i.cd_cgc = cd_cgc_w
and	i.vl_unitario_material <> (select	coalesce(max(o.vl_unitario_material),0)
				from	ordem_compra_item o
				where	o.nr_ordem_compra = i.nr_ordem_compra
				and	o.nr_item_oci = i.nr_item_oci);

c11 CURSOR FOR					
SELECT	nr_sequencia
from	inspecao_recebimento
where	dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
and	ie_avaliar_mes_ref_w = 'N'
and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	cd_cgc = cd_cgc_w
and	ie_motivo_devolucao = 'F'

union all

SELECT	nr_sequencia
from	inspecao_recebimento
where	dt_recebimento between dt_referencia_w and dt_fim_mes_w
and	ie_avaliar_mes_ref_w = 'S'
and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	cd_cgc = cd_cgc_w
and	ie_motivo_devolucao = 'F';

c12 CURSOR FOR	
SELECT	nr_sequencia
from	inspecao_recebimento
where	dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
and	ie_avaliar_mes_ref_w = 'N'
and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	cd_cgc = cd_cgc_w
and	ie_motivo_devolucao = 'D'

union all

SELECT	nr_sequencia
from	inspecao_recebimento
where	dt_recebimento between dt_referencia_w and dt_fim_mes_w
and	ie_avaliar_mes_ref_w = 'S'
and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	cd_cgc = cd_cgc_w
and	ie_motivo_devolucao = 'D';

c13 CURSOR FOR	
SELECT	i.nr_sequencia
from	inspecao_recebimento i,
	inspecao_recebimento_lote l
where	i.nr_sequencia = l.nr_seq_inspecao
and	i.dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
and	ie_avaliar_mes_ref_w = 'N'
and	(i.cd_cgc IS NOT NULL AND i.cd_cgc::text <> '')
and	(i.dt_liberacao IS NOT NULL AND i.dt_liberacao::text <> '')
and	i.cd_cgc = cd_cgc_w
and	l.nr_seq_marca <> (SELECT	coalesce(max(o.nr_seq_marca),0)
			from	ordem_compra_item o
			where	o.nr_ordem_compra = i.nr_ordem_compra
			and	o.nr_item_oci = i.nr_item_oci)

union all

select	i.nr_sequencia
from	inspecao_recebimento i,
	inspecao_recebimento_lote l
where	i.nr_sequencia = l.nr_seq_inspecao
and	i.dt_recebimento between dt_referencia_w and dt_fim_mes_w
and	ie_avaliar_mes_ref_w = 'S'
and	(i.cd_cgc IS NOT NULL AND i.cd_cgc::text <> '')
and	(i.dt_liberacao IS NOT NULL AND i.dt_liberacao::text <> '')
and	i.cd_cgc = cd_cgc_w
and	l.nr_seq_marca <> (select	coalesce(max(o.nr_seq_marca),0)
			from	ordem_compra_item o
			where	o.nr_ordem_compra = i.nr_ordem_compra
			and	o.nr_item_oci = i.nr_item_oci);

c14 CURSOR FOR				
SELECT	i.nr_sequencia
from	inspecao_recebimento i,
	inspecao_recebimento_lote l
where	i.nr_sequencia = l.nr_seq_inspecao
and	i.dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
and	ie_avaliar_mes_ref_w = 'N'
and	(i.cd_cgc IS NOT NULL AND i.cd_cgc::text <> '')
and	(i.dt_liberacao IS NOT NULL AND i.dt_liberacao::text <> '')
and	i.cd_cgc = cd_cgc_w
and	l.nr_seq_marca not in (SELECT	nr_sequencia
				from	material_marca
				where	cd_material = i.cd_material
				and	((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_p)))

union all

select	i.nr_sequencia
from	inspecao_recebimento i,
	inspecao_recebimento_lote l
where	i.nr_sequencia = l.nr_seq_inspecao
and	i.dt_recebimento between dt_referencia_w and dt_fim_mes_w
and	ie_avaliar_mes_ref_w = 'S'
and	(i.cd_cgc IS NOT NULL AND i.cd_cgc::text <> '')
and	(i.dt_liberacao IS NOT NULL AND i.dt_liberacao::text <> '')
and	i.cd_cgc = cd_cgc_w
and	l.nr_seq_marca not in (select	nr_sequencia
				from	material_marca
				where	cd_material = i.cd_material
				and	((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_p)));

c15 CURSOR FOR					
SELECT	nr_sequencia
from	inspecao_recebimento
where	dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
and	ie_avaliar_mes_ref_w = 'N'
and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	cd_cgc = cd_cgc_w
and	obter_qt_prev_oci_inspecao(nr_sequencia) < qt_inspecao

union all

SELECT	nr_sequencia
from	inspecao_recebimento
where	dt_recebimento between dt_referencia_w and dt_fim_mes_w
and	ie_avaliar_mes_ref_w = 'S'
and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	cd_cgc = cd_cgc_w
and	obter_qt_prev_oci_inspecao(nr_sequencia) < qt_inspecao;

c16 CURSOR FOR	
SELECT	i.nr_sequencia
from	inspecao_recebimento i,
	inspecao_regra_material x
where	i.dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
and	ie_avaliar_mes_ref_w = 'N'
and	(i.cd_cgc IS NOT NULL AND i.cd_cgc::text <> '')
and	(i.dt_liberacao IS NOT NULL AND i.dt_liberacao::text <> '')
and	i.cd_cgc = cd_cgc_w
and	x.cd_material = i.cd_material
and	x.cd_estabelecimento	= cd_estabelecimento_p
and	x.ie_temperatura	= 'S'
and ((regexp_replace(replace(i.ie_temperatura, '.', ','), '[^0-9|,|-]', ''))::numeric  > x.qt_temp_max_transp
or	(regexp_replace(replace(i.ie_temperatura, '.', ','), '[^0-9|,|-]', ''))::numeric  < x.qt_temp_min_transp)

union all

SELECT	i.nr_sequencia
from	inspecao_recebimento i,
	inspecao_regra_material x
where	i.dt_recebimento between dt_referencia_w and dt_fim_mes_w
and	ie_avaliar_mes_ref_w = 'S'
and	(i.cd_cgc IS NOT NULL AND i.cd_cgc::text <> '')
and	(i.dt_liberacao IS NOT NULL AND i.dt_liberacao::text <> '')
and	i.cd_cgc = cd_cgc_w
and	x.cd_material = i.cd_material
and	x.cd_estabelecimento	= cd_estabelecimento_p
and	x.ie_temperatura	= 'S'
and ((regexp_replace(replace(i.ie_temperatura, '.', ','), '[^0-9|,|-]', ''))::numeric  > x.qt_temp_max_transp
or	(regexp_replace(replace(i.ie_temperatura, '.', ','), '[^0-9|,|-]', ''))::numeric  < x.qt_temp_min_transp);

c17 CURSOR FOR	
SELECT	nr_sequencia
from	inspecao_recebimento
where	dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
and	ie_avaliar_mes_ref_w = 'N'
and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	cd_cgc = cd_cgc_w
and	ie_motivo_devolucao = 'V'

union all

SELECT	nr_sequencia
from	inspecao_recebimento
where	dt_recebimento between dt_referencia_w and dt_fim_mes_w
and	ie_avaliar_mes_ref_w = 'S'
and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
and	cd_cgc = cd_cgc_w
and	ie_motivo_devolucao = 'V';

c18 CURSOR FOR
SELECT distinct i.nr_sequencia
from	inspecao_rec_contagem b,
		inspecao_recebimento i
where	i.nr_seq_registro = b.nr_seq_registro
and	i.cd_material = b.cd_material
and ((ie_avaliar_mes_ref_w = 'S' and
	i.dt_recebimento between dt_referencia_w and dt_fim_mes_w) or
	(ie_avaliar_mes_ref_w = 'N' and i.dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)))
and	(i.dt_liberacao IS NOT NULL AND i.dt_liberacao::text <> '')
and	i.cd_cgc = cd_cgc_w
and (i.nr_seq_nota_fiscal IS NOT NULL AND i.nr_seq_nota_fiscal::text <> '')
and	(i.nr_seq_item_nf IS NOT NULL AND i.nr_seq_item_nf::text <> '')
and not exists (SELECT	1
				from	nota_fiscal_item_lote a
				where	a.nr_seq_nota = i.nr_seq_nota_fiscal
				and	a.nr_item_nf = i.nr_seq_item_nf
				and coalesce(b.cd_lote_fabricacao, 'X') = coalesce(a.cd_lote_fabricacao, 'X')
				
union all

				select 1
				from	nota_fiscal_item a
				where	a.nr_sequencia = i.nr_seq_nota_fiscal
				and	a.nr_item_nf = i.nr_seq_item_nf
			    and coalesce(b.cd_lote_fabricacao, 'X') = coalesce(a.cd_lote_fabricacao, 'X'));

c19 CURSOR FOR
SELECT distinct i.nr_sequencia
from	inspecao_rec_contagem b,
		inspecao_recebimento i
where	i.nr_seq_registro = b.nr_seq_registro
and	i.cd_material = b.cd_material
and ((ie_avaliar_mes_ref_w = 'S' and
	i.dt_recebimento between dt_referencia_w and dt_fim_mes_w) or
	(ie_avaliar_mes_ref_w = 'N' and i.dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)))
and	(i.dt_liberacao IS NOT NULL AND i.dt_liberacao::text <> '')
and	i.cd_cgc = cd_cgc_w
and (i.nr_seq_nota_fiscal IS NOT NULL AND i.nr_seq_nota_fiscal::text <> '')
and	(i.nr_seq_item_nf IS NOT NULL AND i.nr_seq_item_nf::text <> '')
and not exists (SELECT	1
				from	nota_fiscal_item_lote a
				where	a.nr_seq_nota = i.nr_seq_nota_fiscal
				and	a.nr_item_nf = i.nr_seq_item_nf
				and	coalesce(trunc(a.dt_validade,'dd'),clock_timestamp()) = coalesce(trunc(b.dt_validade,'dd'),clock_timestamp())
                and coalesce(a.ie_indeterminado,'N') = coalesce(b.ie_indeterminada, 'N')
				
union all

				select 1	
				from	nota_fiscal_item a
				where	a.nr_sequencia = i.nr_seq_nota_fiscal
				and	a.nr_item_nf = i.nr_seq_item_nf
				and	coalesce(trunc(a.dt_validade,'dd'),clock_timestamp()) = coalesce(trunc(b.dt_validade,'dd'),clock_timestamp())
                and coalesce(a.ie_indeterminado,'N') = coalesce(b.ie_indeterminada, 'N'));


BEGIN

select	coalesce(max(qt_dias_considera_avaliacao), 90),
	coalesce(max(ie_avaliar_mes_ref),'N'),
	coalesce(max(qt_peso_aval_pontualidade), 40),
	coalesce(max(qt_peso_aval_eficiencia), 25),
	coalesce(max(qt_peso_aval_integridade), 35),
	coalesce(max(ie_conceito_insp_real),'N')
into STRICT	qt_dias_consulta_w,
	ie_avaliar_mes_ref_w,
	qt_peso_pontualidade_w,
	qt_peso_eficiencia_w,
	qt_peso_integridade_w,
	ie_conceito_insp_real_w
from	parametro_compras
where	cd_estabelecimento = cd_estabelecimento_p;

dt_referencia_w := pkg_date_utils.start_of(dt_referencia_p,'MONTH', 0);

if (ie_avaliar_mes_ref_w = 'S') and (pkg_date_utils.start_of(dt_referencia_p,'dd',0) = dt_referencia_w) then
	dt_referencia_w	:= pkg_date_utils.add_month(dt_referencia_w,-1,0);
end if;
	
dt_fim_mes_w := pkg_date_utils.end_of(dt_referencia_w, 'MONTH', 0);

delete
from	avaliacao_fornecedor
where	dt_mesano_referencia = dt_referencia_w;

open c01;
loop
fetch c01 into
	cd_cgc_w,
	qt_real_inspecao_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
	select	nextval('avaliacao_fornecedor_seq')
	into STRICT	nr_seq_avaliacao_w
	;
	
	/*Identifica a quantidade real de entregas do fornecedor*/

	select	count(*)
	into STRICT	qt_real_entrega_w
	from	nota_fiscal b,
		nota_fiscal_item a
	where	a.nr_sequencia = b.nr_sequencia
	and	(b.dt_atualizacao_estoque IS NOT NULL AND b.dt_atualizacao_estoque::text <> '')
	and	(((ie_avaliar_mes_ref_w = 'N') and
		(b.dt_entrada_saida > (dt_referencia_p - qt_dias_consulta_w))) or
		(ie_avaliar_mes_ref_w = 'S' AND b.dt_entrada_saida between dt_referencia_w and dt_fim_mes_w))
	and	b.cd_estabelecimento = cd_estabelecimento_p
	and	b.ie_situacao = '1'
	and (obter_se_nota_entrada_saida(b.nr_sequencia) = 'E')
	and	cd_cgc = cd_cgc_w;
	
	select	count(*)
	into STRICT	qt_devolucao_w
	from	inspecao_recebimento
	where	cd_cgc	= cd_cgc_w
	and	(((ie_avaliar_mes_ref_w = 'N') and
		(dt_recebimento > (dt_referencia_p - qt_dias_consulta_w))) or
		(ie_avaliar_mes_ref_w = 'S' AND dt_recebimento between dt_referencia_w and dt_fim_mes_w))
	and	(ie_motivo_devolucao IS NOT NULL AND ie_motivo_devolucao::text <> '')
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');
	
	select	count(*)
	into STRICT	qt_nota_devolucao_w
	from 	nota_fiscal_v a
	where	a.cd_cgc = cd_cgc_w
	and	(((ie_avaliar_mes_ref_w = 'N') and 
		(a.dt_entrada_saida > (dt_referencia_p - qt_dias_consulta_w))) or
		(ie_avaliar_mes_ref_w = 'S' AND a.dt_entrada_saida between dt_referencia_w and dt_fim_mes_w))
	and	coalesce(a.ie_situacao,'1') = '1'
	and	exists (	SELECT	1
			from	operacao_nota x
			where	x.cd_operacao_nf = a.cd_operacao_nf 
			and	x.ie_devolucao = 'S');
			
	qt_devolucao_w	:= qt_devolucao_w + qt_nota_devolucao_w;
	
	select	count(*)
	into STRICT	qt_nao_conform_w
	from	inspecao_recebimento
	where	cd_cgc	= cd_cgc_w
	and	(((ie_avaliar_mes_ref_w = 'N') and
		(dt_recebimento > (dt_referencia_p - qt_dias_consulta_w))) or
		(ie_avaliar_mes_ref_w = 'S' AND dt_recebimento between dt_referencia_w and dt_fim_mes_w))
	and	(nr_seq_tipo_nao_conf IS NOT NULL AND nr_seq_tipo_nao_conf::text <> '')
	and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');
	
	select	count(*)
	into STRICT	qt_nota_devol_rnc_w
	from	qua_nao_conformidade a
	where	a.cd_fornecedor = cd_cgc_w
	and	(((ie_avaliar_mes_ref_w = 'N') and
		(a.dt_abertura > (dt_referencia_p - qt_dias_consulta_w))) or
		(ie_avaliar_mes_ref_w = 'S' AND a.dt_abertura between dt_referencia_w and dt_fim_mes_w));
	
	qt_nao_conform_w  := qt_nao_conform_w + qt_nota_devol_rnc_w;
	
	insert into avaliacao_fornecedor(
		nr_sequencia,
		cd_estabelecimento,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_fornecedor,
		dt_mesano_referencia,
		qt_dias_consulta,
		qt_real_entrega,
		qt_real_inspecao,
		qt_pontualidade_entrega,
		ie_pontualidade_entrega,
		qt_eficiencia_atendimento,
		ie_eficiencia_atendimento,
		qt_integridade_produto,
		ie_integridade_produto,
		qt_conceito_geral,
		ie_conceito_geral,
		qt_devolucao,
		qt_nao_conformidade)
	values (nr_seq_avaliacao_w,
		cd_estabelecimento_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_cgc_w,
		dt_referencia_w,
		qt_dias_consulta_w,
		qt_real_entrega_w,
		qt_real_inspecao_w,
		0,
		0,
		0,
		0,
		0,
		0,
		0,
		0,
		qt_devolucao_w,
		qt_nao_conform_w);
	
	open c02;
	loop
	fetch c02 into
		ie_tipo_divergencia_w,
		ie_criterio_avaliacao_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		qt_divergencias_w := 0;
		if (ie_tipo_divergencia_w = 'DVI') then /*Data de validade inferior ao minimo permitido*/
		
			select	sum(qt)
			into STRICT	qt_divergencias_w
			from (	SELECT	count(*) qt
				from	inspecao_recebimento i,
					inspecao_recebimento_lote l
				where	i.nr_sequencia = l.nr_seq_inspecao
				and	i.dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
				and	ie_avaliar_mes_ref_w = 'N'
				and	(i.cd_cgc IS NOT NULL AND i.cd_cgc::text <> '')
				and	(i.dt_liberacao IS NOT NULL AND i.dt_liberacao::text <> '')
				and	i.cd_cgc = cd_cgc_w
				and	l.dt_validade < (i.dt_recebimento + (	select	coalesce(max(r.qt_dias_validade),0)
										from 	inspecao_regra_material r
										where 	r.cd_estabelecimento = cd_estabelecimento_p
										and 	r.cd_material = i.cd_material
										and 	r.ie_validade = 'S'))
				
union all

				SELECT	count(*) qt
				from	inspecao_recebimento i,
					inspecao_recebimento_lote l
				where	i.nr_sequencia = l.nr_seq_inspecao
				and	i.dt_recebimento between dt_referencia_w and dt_fim_mes_w
				and	ie_avaliar_mes_ref_w = 'S'
				and	(i.cd_cgc IS NOT NULL AND i.cd_cgc::text <> '')
				and	(i.dt_liberacao IS NOT NULL AND i.dt_liberacao::text <> '')
				and	i.cd_cgc = cd_cgc_w
				and	l.dt_validade < (i.dt_recebimento + (	select	coalesce(max(r.qt_dias_validade),0)
										from 	inspecao_regra_material r
										where 	r.cd_estabelecimento = cd_estabelecimento_p
										and 	r.cd_material = i.cd_material
										and 	r.ie_validade = 'S'))) alias17;
										
			open c03;
			loop
			fetch c03 into
				nr_documento_w;
			EXIT WHEN NOT FOUND; /* apply on c03 */
				begin
	
				insert into aval_fornec_inspecao(
					nr_sequencia,
					nr_seq_avaliacao,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_documento,
					ie_origem_documento,
					ie_tipo_avaliacao) values (
						nextval('aval_fornec_inspecao_seq'),
						nr_seq_avaliacao_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_documento_w,
						'I',
						ie_criterio_avaliacao_w);
	
				end;
			end loop;
			close c03;

		elsif (ie_tipo_divergencia_w = 'MD') then /*Diferenca do item inspecionado com o item da nota*/
		
			open c04;
			loop
			fetch c04 into
				nr_documento_w;
			EXIT WHEN NOT FOUND; /* apply on c04 */
				begin
                qt_divergencias_w := qt_divergencias_w + 1;
				insert into aval_fornec_inspecao(
					nr_sequencia,
					nr_seq_avaliacao,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_documento,
					ie_origem_documento,
					ie_tipo_avaliacao) values (
						nextval('aval_fornec_inspecao_seq'),
						nr_seq_avaliacao_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_documento_w,
						'I',
						ie_criterio_avaliacao_w);
	
				end;
			end loop;
			close c04;
		
		elsif (ie_tipo_divergencia_w = 'PG') then /*Diferenca na condicao pagamento*/
			select	sum(qt)
			into STRICT	qt_divergencias_w
			from (	SELECT	count(*) qt
				from	inspecao_recebimento
				where	dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
				and	ie_avaliar_mes_ref_w = 'N'
				and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and	cd_cgc = cd_cgc_w
				and	cd_condicao_pagamento <> obter_dados_ordem_compra(nr_ordem_compra,'CP')
				
union all

				SELECT	count(*) qt
				from	inspecao_recebimento
				where	dt_recebimento between dt_referencia_w and dt_fim_mes_w
				and	ie_avaliar_mes_ref_w = 'S'
				and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and	cd_cgc = cd_cgc_w
				and	cd_condicao_pagamento <> obter_dados_ordem_compra(nr_ordem_compra,'CP')) alias11;

			open c05;
			loop
			fetch c05 into
				nr_documento_w;
			EXIT WHEN NOT FOUND; /* apply on c05 */
				begin
	
				insert into aval_fornec_inspecao(
					nr_sequencia,
					nr_seq_avaliacao,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_documento,
					ie_origem_documento,
					ie_tipo_avaliacao) values (
						nextval('aval_fornec_inspecao_seq'),
						nr_seq_avaliacao_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_documento_w,
						'I',
						ie_criterio_avaliacao_w);
	
				end;
			end loop;
			close c05;
		
		elsif (ie_tipo_divergencia_w = 'PA') then /*Diferenca no prazo entrega (Entregou antes do previsto)*/
		
			select	sum(qt)
			into STRICT	qt_divergencias_w
			from (	SELECT	count(*) qt
				from	inspecao_recebimento
				where	dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
				and	ie_avaliar_mes_ref_w = 'N'
				and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and	cd_cgc = cd_cgc_w
				and	dt_entrega_real < obter_dt_prev_oci_inspecao(nr_sequencia)
				
union all

				SELECT	count(*) qt
				from	inspecao_recebimento
				where	dt_recebimento between dt_referencia_w and dt_fim_mes_w
				and	ie_avaliar_mes_ref_w = 'S'
				and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and	cd_cgc = cd_cgc_w
				and	dt_entrega_real < obter_dt_prev_oci_inspecao(nr_sequencia)) alias11;
				
			open c06;
			loop
			fetch c06 into
				nr_documento_w;
			EXIT WHEN NOT FOUND; /* apply on c06 */
				begin
	
				insert into aval_fornec_inspecao(
					nr_sequencia,
					nr_seq_avaliacao,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_documento,
					ie_origem_documento,
					ie_tipo_avaliacao) values (
						nextval('aval_fornec_inspecao_seq'),
						nr_seq_avaliacao_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_documento_w,
						'I',
						ie_criterio_avaliacao_w);
	
				end;
			end loop;
			close c06;
		
		elsif (ie_tipo_divergencia_w = 'PE') then /*Diferenca no prazo entrega (Entregou antes ou depois do previsto)*/
		
			select	sum(qt)
			into STRICT	qt_divergencias_w
			from (	SELECT	count(*) qt
				from	inspecao_recebimento
				where	dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
				and	ie_avaliar_mes_ref_w = 'N'
				and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and	cd_cgc = cd_cgc_w
				and	dt_entrega_real <> obter_dt_prev_oci_inspecao(nr_sequencia)
				
union all

				SELECT	count(*) qt
				from	inspecao_recebimento
				where	dt_recebimento between dt_referencia_w and dt_fim_mes_w
				and	ie_avaliar_mes_ref_w = 'S'
				and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and	cd_cgc = cd_cgc_w
				and	dt_entrega_real <> obter_dt_prev_oci_inspecao(nr_sequencia)) alias11;
				
			open c07;
			loop
			fetch c07 into
				nr_documento_w;
			EXIT WHEN NOT FOUND; /* apply on c07 */
				begin
	
				insert into aval_fornec_inspecao(
					nr_sequencia,
					nr_seq_avaliacao,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_documento,
					ie_origem_documento,
					ie_tipo_avaliacao) values (
						nextval('aval_fornec_inspecao_seq'),
						nr_seq_avaliacao_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_documento_w,
						'I',
						ie_criterio_avaliacao_w);
	
				end;
			end loop;
			close c07;
		
		elsif (ie_tipo_divergencia_w = 'PD') then /*Diferenca no prazo entrega (Entregou depois do previsto)*/
		
			select	sum(qt)
			into STRICT	qt_divergencias_w
			from (	SELECT	count(*) qt
				from	inspecao_recebimento
				where	dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
				and	ie_avaliar_mes_ref_w = 'N'
				and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and	cd_cgc = cd_cgc_w
				and	dt_entrega_real > obter_dt_prev_oci_inspecao(nr_sequencia)
				
union all

				SELECT	count(*) qt
				from	inspecao_recebimento
				where	dt_recebimento between dt_referencia_w and dt_fim_mes_w
				and	ie_avaliar_mes_ref_w = 'S'
				and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and	cd_cgc = cd_cgc_w
				and	dt_entrega_real > obter_dt_prev_oci_inspecao(nr_sequencia)) alias11;
				
			open c08;
			loop
			fetch c08 into
				nr_documento_w;
			EXIT WHEN NOT FOUND; /* apply on c08 */
				begin
	
				insert into aval_fornec_inspecao(
					nr_sequencia,
					nr_seq_avaliacao,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_documento,
					ie_origem_documento,
					ie_tipo_avaliacao) values (
						nextval('aval_fornec_inspecao_seq'),
						nr_seq_avaliacao_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_documento_w,
						'I',
						ie_criterio_avaliacao_w);
	
				end;
			end loop;
			close c08;
		
		elsif (ie_tipo_divergencia_w = 'QT') then /*Diferencas de quantidade*/
		
			select	sum(qt)
			into STRICT	qt_divergencias_w
			from (	SELECT	count(*) qt
				from	inspecao_recebimento
				where	dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
				and	ie_avaliar_mes_ref_w = 'N'
				and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and	cd_cgc = cd_cgc_w
				and	obter_qt_prev_oci_inspecao(nr_sequencia) <> qt_inspecao
				
union all

				SELECT	count(*) qt
				from	inspecao_recebimento
				where	dt_recebimento between dt_referencia_w and dt_fim_mes_w
				and	ie_avaliar_mes_ref_w = 'S'
				and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and	cd_cgc = cd_cgc_w
				and	obter_qt_prev_oci_inspecao(nr_sequencia) <> qt_inspecao) alias11;
				
			open c09;
			loop
			fetch c09 into
				nr_documento_w;
			EXIT WHEN NOT FOUND; /* apply on c09 */
				begin
	
				insert into aval_fornec_inspecao(
					nr_sequencia,
					nr_seq_avaliacao,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_documento,
					ie_origem_documento,
					ie_tipo_avaliacao) values (
						nextval('aval_fornec_inspecao_seq'),
						nr_seq_avaliacao_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_documento_w,
						'I',
						ie_criterio_avaliacao_w);
	
				end;
			end loop;
			close c09;
		
		elsif (ie_tipo_divergencia_w = 'VL') then /*Diferencas de valores*/
			select	sum(qt)
			into STRICT	qt_divergencias_w
			from (	SELECT	count(*) qt
				from	inspecao_recebimento i
				where	i.dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
				and	ie_avaliar_mes_ref_w = 'N'
				and	(i.cd_cgc IS NOT NULL AND i.cd_cgc::text <> '')
				and	(i.dt_liberacao IS NOT NULL AND i.dt_liberacao::text <> '')
				and	i.cd_cgc = cd_cgc_w
				and	i.vl_unitario_material <> (select	coalesce(max(o.vl_unitario_material),0)
								from	ordem_compra_item o
								where	o.nr_ordem_compra = i.nr_ordem_compra
								and	o.nr_item_oci = i.nr_item_oci)
				
union all

				SELECT	count(*) qt
				from	inspecao_recebimento i
				where	i.dt_recebimento between dt_referencia_w and dt_fim_mes_w
				and	ie_avaliar_mes_ref_w = 'S'
				and	(i.cd_cgc IS NOT NULL AND i.cd_cgc::text <> '')
				and	(i.dt_liberacao IS NOT NULL AND i.dt_liberacao::text <> '')
				and	i.cd_cgc = cd_cgc_w
				and	i.vl_unitario_material <> (select	coalesce(max(o.vl_unitario_material),0)
								from	ordem_compra_item o
								where	o.nr_ordem_compra = i.nr_ordem_compra
								and	o.nr_item_oci = i.nr_item_oci)) alias15;
								
			open c10;
			loop
			fetch c10 into
				nr_documento_w;
			EXIT WHEN NOT FOUND; /* apply on c10 */
				begin
	
				insert into aval_fornec_inspecao(
					nr_sequencia,
					nr_seq_avaliacao,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_documento,
					ie_origem_documento,
					ie_tipo_avaliacao) values (
						nextval('aval_fornec_inspecao_seq'),
						nr_seq_avaliacao_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_documento_w,
						'I',
						ie_criterio_avaliacao_w);
	
				end;
			end loop;
			close c10;
		
		elsif (ie_tipo_divergencia_w = 'IP') then /*Integridade dos produtos*/
		
			select	sum(qt)
			into STRICT	qt_divergencias_w
			from (	SELECT	count(*) qt
				from	inspecao_recebimento
				where	dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
				and	ie_avaliar_mes_ref_w = 'N'
				and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and	cd_cgc = cd_cgc_w
				and	ie_motivo_devolucao = 'F'
				
union all

				SELECT	count(*) qt
				from	inspecao_recebimento
				where	dt_recebimento between dt_referencia_w and dt_fim_mes_w
				and	ie_avaliar_mes_ref_w = 'S'
				and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and	cd_cgc = cd_cgc_w
				and	ie_motivo_devolucao = 'F') alias9;
				
			open c11;
			loop
			fetch c11 into
				nr_documento_w;
			EXIT WHEN NOT FOUND; /* apply on c11 */
				begin
	
				insert into aval_fornec_inspecao(
					nr_sequencia,
					nr_seq_avaliacao,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_documento,
					ie_origem_documento,
					ie_tipo_avaliacao) values (
						nextval('aval_fornec_inspecao_seq'),
						nr_seq_avaliacao_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_documento_w,
						'I',
						ie_criterio_avaliacao_w);
	
				end;
			end loop;
			close c11;
		
		elsif (ie_tipo_divergencia_w = 'ID') then /*Itens da inspecao diferente da OC*/
		
			select	sum(qt)
			into STRICT	qt_divergencias_w
			from (	SELECT	count(*) qt
				from	inspecao_recebimento
				where	dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
				and	ie_avaliar_mes_ref_w = 'N'
				and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and	cd_cgc = cd_cgc_w
				and	ie_motivo_devolucao = 'D'
				
union all

				SELECT	count(*) qt
				from	inspecao_recebimento
				where	dt_recebimento between dt_referencia_w and dt_fim_mes_w
				and	ie_avaliar_mes_ref_w = 'S'
				and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and	cd_cgc = cd_cgc_w
				and	ie_motivo_devolucao = 'D') alias9;
				
			open c12;
			loop
			fetch c12 into
				nr_documento_w;
			EXIT WHEN NOT FOUND; /* apply on c12 */
				begin
	
				insert into aval_fornec_inspecao(
					nr_sequencia,
					nr_seq_avaliacao,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_documento,
					ie_origem_documento,
					ie_tipo_avaliacao) values (
						nextval('aval_fornec_inspecao_seq'),
						nr_seq_avaliacao_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_documento_w,
						'I',
						ie_criterio_avaliacao_w);
	
				end;
			end loop;
			close c12;
		
		elsif (ie_tipo_divergencia_w = 'ML') then /*Marca do lote diferente da marca da ordem compra*/
		
			select	sum(qt)
			into STRICT	qt_divergencias_w
			from (	SELECT	count(*) qt
				from	inspecao_recebimento i,
					inspecao_recebimento_lote l
				where	i.nr_sequencia = l.nr_seq_inspecao
				and	i.dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
				and	ie_avaliar_mes_ref_w = 'N'
				and	(i.cd_cgc IS NOT NULL AND i.cd_cgc::text <> '')
				and	(i.dt_liberacao IS NOT NULL AND i.dt_liberacao::text <> '')
				and	i.cd_cgc = cd_cgc_w
				and	l.nr_seq_marca <> (select	coalesce(max(o.nr_seq_marca),0)
							from	ordem_compra_item o
							where	o.nr_ordem_compra = i.nr_ordem_compra
							and	o.nr_item_oci = i.nr_item_oci)
				
union all

				SELECT	count(*) qt
				from	inspecao_recebimento i,
					inspecao_recebimento_lote l
				where	i.nr_sequencia = l.nr_seq_inspecao
				and	i.dt_recebimento between dt_referencia_w and dt_fim_mes_w
				and	ie_avaliar_mes_ref_w = 'S'
				and	(i.cd_cgc IS NOT NULL AND i.cd_cgc::text <> '')
				and	(i.dt_liberacao IS NOT NULL AND i.dt_liberacao::text <> '')
				and	i.cd_cgc = cd_cgc_w
				and	l.nr_seq_marca <> (select	coalesce(max(o.nr_seq_marca),0)
							from	ordem_compra_item o
							where	o.nr_ordem_compra = i.nr_ordem_compra
							and	o.nr_item_oci = i.nr_item_oci)) alias15;
							
			open c13;
			loop
			fetch c13 into
				nr_documento_w;
			EXIT WHEN NOT FOUND; /* apply on c13 */
				begin
	
				insert into aval_fornec_inspecao(
					nr_sequencia,
					nr_seq_avaliacao,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_documento,
					ie_origem_documento,
					ie_tipo_avaliacao) values (
						nextval('aval_fornec_inspecao_seq'),
						nr_seq_avaliacao_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_documento_w,
						'I',
						ie_criterio_avaliacao_w);
	
				end;
			end loop;
			close c13;
		
		elsif (ie_tipo_divergencia_w = 'MA') then /*Marcas nao vinculadas com material*/
		
			select	sum(qt)
			into STRICT	qt_divergencias_w
			from (	SELECT	count(*) qt
				from	inspecao_recebimento i,
					inspecao_recebimento_lote l
				where	i.nr_sequencia = l.nr_seq_inspecao
				and	i.dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
				and	ie_avaliar_mes_ref_w = 'N'
				and	(i.cd_cgc IS NOT NULL AND i.cd_cgc::text <> '')
				and	(i.dt_liberacao IS NOT NULL AND i.dt_liberacao::text <> '')
				and	i.cd_cgc = cd_cgc_w
				and	l.nr_seq_marca not in (select	nr_sequencia
								from	material_marca
								where	cd_material = i.cd_material
								and	((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_p)))
				
union all

				SELECT	count(*) qt
				from	inspecao_recebimento i,
					inspecao_recebimento_lote l
				where	i.nr_sequencia = l.nr_seq_inspecao
				and	i.dt_recebimento between dt_referencia_w and dt_fim_mes_w
				and	ie_avaliar_mes_ref_w = 'S'
				and	(i.cd_cgc IS NOT NULL AND i.cd_cgc::text <> '')
				and	(i.dt_liberacao IS NOT NULL AND i.dt_liberacao::text <> '')
				and	i.cd_cgc = cd_cgc_w
				and	l.nr_seq_marca not in (select	nr_sequencia
								from	material_marca
								where	cd_material = i.cd_material
								and	((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_p)))) alias19;
								
			open c14;
			loop
			fetch c14 into
				nr_documento_w;
			EXIT WHEN NOT FOUND; /* apply on c14 */
				begin
	
				insert into aval_fornec_inspecao(
					nr_sequencia,
					nr_seq_avaliacao,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_documento,
					ie_origem_documento,
					ie_tipo_avaliacao) values (
						nextval('aval_fornec_inspecao_seq'),
						nr_seq_avaliacao_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_documento_w,
						'I',
						ie_criterio_avaliacao_w);
	
				end;
			end loop;
			close c14;
		
		elsif (ie_tipo_divergencia_w = 'QTT') then /*Quantidade das inspecoes maior item da ordem*/
		
			select	sum(qt)
			into STRICT	qt_divergencias_w
			from (	SELECT	count(*) qt
				from	inspecao_recebimento
				where	dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
				and	ie_avaliar_mes_ref_w = 'N'
				and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and	cd_cgc = cd_cgc_w
				and	obter_qt_prev_oci_inspecao(nr_sequencia) < qt_inspecao
				
union all

				SELECT	count(*) qt
				from	inspecao_recebimento
				where	dt_recebimento between dt_referencia_w and dt_fim_mes_w
				and	ie_avaliar_mes_ref_w = 'S'
				and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and	cd_cgc = cd_cgc_w
				and	obter_qt_prev_oci_inspecao(nr_sequencia) < qt_inspecao) alias11;
				
			open c15;
			loop
			fetch c15 into
				nr_documento_w;
			EXIT WHEN NOT FOUND; /* apply on c15 */
				begin
	
				insert into aval_fornec_inspecao(
					nr_sequencia,
					nr_seq_avaliacao,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_documento,
					ie_origem_documento,
					ie_tipo_avaliacao) values (
						nextval('aval_fornec_inspecao_seq'),
						nr_seq_avaliacao_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_documento_w,
						'I',
						ie_criterio_avaliacao_w);
	
				end;
			end loop;
			close c15;
		
		elsif (ie_tipo_divergencia_w = 'TE') then /*Temperatura fora padrao*/
		
			select	sum(qt)
			into STRICT	qt_divergencias_w
			from (	SELECT	count(*) qt
				from	inspecao_recebimento i,
					inspecao_regra_material x
				where	i.dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
				and	ie_avaliar_mes_ref_w = 'N'
				and	(i.cd_cgc IS NOT NULL AND i.cd_cgc::text <> '')
				and	(i.dt_liberacao IS NOT NULL AND i.dt_liberacao::text <> '')
				and	i.cd_cgc = cd_cgc_w
				and	x.cd_material = i.cd_material
				and	x.cd_estabelecimento	= cd_estabelecimento_p
				and	x.ie_temperatura	= 'S'
				and ((regexp_replace(replace(i.ie_temperatura, '.', ','), '[^0-9|,|-]', ''))::numeric  > x.qt_temp_max_transp
				or	(regexp_replace(replace(i.ie_temperatura, '.', ','), '[^0-9|,|-]', ''))::numeric  < x.qt_temp_min_transp)
				
union all

				SELECT	count(*) qt
				from	inspecao_recebimento i,
					inspecao_regra_material x
				where	i.dt_recebimento between dt_referencia_w and dt_fim_mes_w
				and	ie_avaliar_mes_ref_w = 'S'
				and	(i.cd_cgc IS NOT NULL AND i.cd_cgc::text <> '')
				and	(i.dt_liberacao IS NOT NULL AND i.dt_liberacao::text <> '')
				and	i.cd_cgc = cd_cgc_w
				and	x.cd_material = i.cd_material
				and	x.cd_estabelecimento	= cd_estabelecimento_p
				and	x.ie_temperatura	= 'S'
				and ((regexp_replace(replace(i.ie_temperatura, '.', ','), '[^0-9|,|-]', ''))::numeric  > x.qt_temp_max_transp
				or	(regexp_replace(replace(i.ie_temperatura, '.', ','), '[^0-9|,|-]', ''))::numeric  < x.qt_temp_min_transp)) alias23;
				
			open c16;
			loop
			fetch c16 into
				nr_documento_w;
			EXIT WHEN NOT FOUND; /* apply on c16 */
				begin
	
				insert into aval_fornec_inspecao(
					nr_sequencia,
					nr_seq_avaliacao,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_documento,
					ie_origem_documento,
					ie_tipo_avaliacao) values (
						nextval('aval_fornec_inspecao_seq'),
						nr_seq_avaliacao_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_documento_w,
						'I',
						ie_criterio_avaliacao_w);
	
				end;
			end loop;
			close c16;
		
		elsif (ie_tipo_divergencia_w = 'VE') then /*Validade expirada*/
		
			select	sum(qt)
			into STRICT	qt_divergencias_w
			from (	SELECT	count(*) qt
				from	inspecao_recebimento
				where	dt_recebimento > (dt_referencia_p - qt_dias_consulta_w)
				and	ie_avaliar_mes_ref_w = 'N'
				and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and	cd_cgc = cd_cgc_w
				and	ie_motivo_devolucao = 'V'
				
union all

				SELECT	count(*) qt
				from	inspecao_recebimento
				where	dt_recebimento between dt_referencia_w and dt_fim_mes_w
				and	ie_avaliar_mes_ref_w = 'S'
				and	(cd_cgc IS NOT NULL AND cd_cgc::text <> '')
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and	cd_cgc = cd_cgc_w
				and	ie_motivo_devolucao = 'V') alias9;
				
			open c17;
			loop
			fetch c17 into
				nr_documento_w;
			EXIT WHEN NOT FOUND; /* apply on c17 */
				begin
	
				insert into aval_fornec_inspecao(
					nr_sequencia,
					nr_seq_avaliacao,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_documento,
					ie_origem_documento,
					ie_tipo_avaliacao) values (
						nextval('aval_fornec_inspecao_seq'),
						nr_seq_avaliacao_w,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						nr_documento_w,
						'I',
						ie_criterio_avaliacao_w);
	
				end;
			end loop;
			close c17;
		
        elsif (ie_tipo_divergencia_w = 'DL') then
			open c18;
            loop
            fetch c18 into
            	nr_documento_w;
            EXIT WHEN NOT FOUND; /* apply on c18 */
            	begin
             		qt_divergencias_w := qt_divergencias_w + 1;
            		insert into aval_fornec_inspecao(
						nr_sequencia,
						nr_seq_avaliacao,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_documento,
						ie_origem_documento,
						ie_tipo_avaliacao) values (
         				nextval('aval_fornec_inspecao_seq'),
          				nr_seq_avaliacao_w,
           				clock_timestamp(),
            			nm_usuario_p,
           				clock_timestamp(),
            			nm_usuario_p,
            			nr_documento_w,
             			'I',
            			ie_criterio_avaliacao_w);
                end;
            end loop;
            close c18;

        elsif (ie_tipo_divergencia_w = 'DT') then
			open c19;
            loop
            fetch c19 into
            	nr_documento_w;
            EXIT WHEN NOT FOUND; /* apply on c19 */
            	begin
             		qt_divergencias_w := qt_divergencias_w + 1;
            		insert into aval_fornec_inspecao(
						nr_sequencia,
						nr_seq_avaliacao,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_documento,
						ie_origem_documento,
						ie_tipo_avaliacao) values (
         				nextval('aval_fornec_inspecao_seq'),
          				nr_seq_avaliacao_w,
           				clock_timestamp(),
            			nm_usuario_p,
           				clock_timestamp(),
            			nm_usuario_p,
            			nr_documento_w,
             			'I',
            			ie_criterio_avaliacao_w);
                end;
            end loop;
            close c19;

		end if;

		if (ie_criterio_avaliacao_w = 'E') then /*Eficiencia*/
			qt_eficiencia_w := qt_eficiencia_w + coalesce(qt_divergencias_w,0);
		elsif (ie_criterio_avaliacao_w = 'I') then /*Integridade*/
			qt_integridade_w := qt_integridade_w + coalesce(qt_divergencias_w,0);
		elsif (ie_criterio_avaliacao_w = 'P') then /*Pontualidade*/
			qt_pontualidade_w := qt_pontualidade_w + coalesce(qt_divergencias_w,0);
		end if;
	
		end;
	end loop;
	close c02;
	
	select	substr(obter_conceito_aval_fornec(cd_estabelecimento_p, (round(dividir(((qt_real_inspecao_w - qt_pontualidade_w) * 100), qt_real_inspecao_w)))),1,1)
	into STRICT	ie_pontualidade_entrega_w
	;
	
	select	substr(obter_conceito_aval_fornec(cd_estabelecimento_p, (round(dividir(((qt_real_inspecao_w - qt_eficiencia_w) * 100), qt_real_inspecao_w)))),1,1)
	into STRICT	ie_eficiencia_atendimento_w
	;
	
	select	substr(obter_conceito_aval_fornec(cd_estabelecimento_p, (round(dividir(((qt_real_inspecao_w - qt_integridade_w) * 100), qt_real_inspecao_w)))),1,1)
	into STRICT	ie_integridade_produto_w
	;
	
	if (ie_conceito_insp_real_w = 'S') then
		qt_div_conceito_geral_w	:= qt_real_inspecao_w;
	else
		qt_div_conceito_geral_w	:= (qt_pontualidade_w + qt_eficiencia_w + qt_integridade_w);
	end if;
	
	qt_conceito_geral_w	:= 100 - (
				dividir(((qt_pontualidade_w * qt_peso_pontualidade_w) +
					 (qt_eficiencia_w * qt_peso_eficiencia_w) +
					 (qt_integridade_w * qt_peso_integridade_w)),
				(qt_div_conceito_geral_w)));

	select	substr(obter_conceito_aval_fornec(cd_estabelecimento_p, qt_conceito_geral_w),1,1)
	into STRICT	ie_conceito_geral_w
	;
	
	update	avaliacao_fornecedor
	set	qt_pontualidade_entrega = qt_pontualidade_w,
		ie_pontualidade_entrega = ie_pontualidade_entrega_w,
		qt_eficiencia_atendimento = qt_eficiencia_w,
		ie_eficiencia_atendimento = ie_eficiencia_atendimento_w,
		qt_integridade_produto = qt_integridade_w,
		ie_integridade_produto = ie_integridade_produto_w,
		qt_conceito_geral = qt_conceito_geral_w,
		ie_conceito_geral = ie_conceito_geral_w
	where	nr_sequencia = nr_seq_avaliacao_w;
	
	qt_eficiencia_w		:= 0;
	qt_integridade_w	:= 0;
	qt_pontualidade_w	:= 0;
	qt_divergencias_w	:= 0;
	
	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_aval_fornec_tp_diver ( dt_referencia_p timestamp, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

