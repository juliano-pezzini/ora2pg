-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desaprovar_laudo_anatomia_pat ( nr_sequencia_p bigint, ds_justificativa_p text, ds_laudo_p text, nm_usuario_p text) AS $body$
DECLARE

		
ie_limpa_tumor_w	varchar(1);

BEGIN
if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin
	ie_limpa_tumor_w := obter_param_usuario(945, 83, obter_perfil_ativo, nm_usuario_p, 0, ie_limpa_tumor_w);
	
	update 	laudo_paciente
	set	dt_aprovacao 		 = NULL,
		dt_liberacao 		 = NULL,
		dt_envelopado		 = NULL,
		nm_usuario_aprovacao 	 = NULL,
		nm_usuario_liberacao 	 = NULL,
		dt_seg_aprovacao	 = NULL,
		nm_usuario_seg_aprov	 = NULL,
		ie_tumor		= CASE WHEN ie_limpa_tumor_w='S' THEN null  ELSE ie_tumor END ,
		nm_usuario		= nm_usuario_p
	where	nr_sequencia 		= nr_sequencia_p;

	CALL gerar_copia_laudo(nr_sequencia_p, nm_usuario_p, ds_justificativa_p);

	update 	laudo_paciente_copia
	set	ds_laudo	= ds_laudo_p,
		nm_usuario	= nm_usuario_p
	where	nr_seq_laudo 	= nr_sequencia_p;	
	end;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desaprovar_laudo_anatomia_pat ( nr_sequencia_p bigint, ds_justificativa_p text, ds_laudo_p text, nm_usuario_p text) FROM PUBLIC;

