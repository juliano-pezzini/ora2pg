-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE autorizacao_agenda_pls_js ( nr_sequencia_p bigint, cd_pessoa_fisica_p text, nr_seq_estagio_p bigint, nr_sequencia_autor_p bigint, nr_seq_guia_plano_p bigint, cd_convenio_p bigint, cd_estabelecimento_p bigint, ds_status_p INOUT text, nm_pessoa_fisica_p INOUT text, dt_validade_p INOUT timestamp, nm_usuario_p text) AS $body$
DECLARE


cd_estab_pls_w		smallint;
ie_exibe_estag_aut_pls_w	varchar(255);
ds_status_w		varchar(255);
nm_pessoa_fisica_w	varchar(60);
dt_validade_w		timestamp;

BEGIN
if (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin

	select	max(cd_estab_pls)
	into STRICT	cd_estab_pls_w
	from	convenio_estabelecimento
	where	cd_estabelecimento = cd_estabelecimento_p
	and	cd_convenio = cd_convenio_p;

	CALL gerar_glosa_autor_pls(cd_estabelecimento_p, nm_usuario_p, cd_estab_pls_w, nr_sequencia_autor_p, nr_seq_guia_plano_p);

	ie_exibe_estag_aut_pls_w := Obter_Param_Usuario(821, 378, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_exibe_estag_aut_pls_w);

	if (ie_exibe_estag_aut_pls_w = 'S') then
		begin
		ds_status_w := Obter_Estagio_Guia_Plano(nr_sequencia_p);
		end;
	else
		begin
		select	ds_estagio
		into STRICT	ds_status_w
		from	estagio_autorizacao
		where	nr_sequencia = nr_seq_estagio_p
		and	OBTER_EMPRESA_ESTAB(wheb_usuario_pck.get_cd_estabelecimento) = cd_empresa;
		end;
	end if;

	select	coalesce(substr(obter_nome_pf(max(cd_pessoa_fisica)),1,60),wheb_mensagem_pck.get_texto(796667))
	into STRICT	nm_pessoa_fisica_w
	from	pessoa_fisica
	where	cd_pessoa_fisica = cd_pessoa_fisica_p;

	select	to_char(max(dt_validade_senha), 'dd/MM/yyyy')
	into STRICT	dt_validade_w
	from	pls_guia_plano
	where	nr_sequencia = nr_seq_guia_plano_p;

	end;
end if;

ds_status_p		:= ds_status_w;
nm_pessoa_fisica_p	:= nm_pessoa_fisica_w;
dt_validade_p		:= dt_validade_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE autorizacao_agenda_pls_js ( nr_sequencia_p bigint, cd_pessoa_fisica_p text, nr_seq_estagio_p bigint, nr_sequencia_autor_p bigint, nr_seq_guia_plano_p bigint, cd_convenio_p bigint, cd_estabelecimento_p bigint, ds_status_p INOUT text, nm_pessoa_fisica_p INOUT text, dt_validade_p INOUT timestamp, nm_usuario_p text) FROM PUBLIC;

