-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE eup_focuslost_cod_usu_conv_js (nr_atendimento_p bigint, nr_seq_segurado_p bigint, ds_prim_digito_p text, ie_tipo_atendimento_p bigint, ie_clinica_p bigint, dt_entrada_p timestamp, nr_seq_consist_dig_p bigint, ie_conta_consiste_digito_p text, cd_categoria_p text, nm_usuario_p text, cd_convenio_p bigint, cd_estabelecimento_p bigint, cd_pessoa_fisica_p text, cd_usuario_convenio_p text, ie_barras_usuario_p text, ds_msg_inf_usu_incorreto_p INOUT text, ds_msg_inf_inapto_p INOUT text, ds_msg_foca_campo_aborta_p INOUT text, ds_msg_conf_p INOUT text, ie_abrir_cons_usu_conv_p INOUT text, cd_empresa_p INOUT bigint, nr_seq_conv_usu_p INOUT bigint, ie_enviar_email_p INOUT text, ds_email_p INOUT text, cd_plano_convenio_p INOUT text, ds_msg_consiste_debito_p INOUT text, ds_msg_primi_dig_cod_usu_p INOUT text, ds_msg_cod_usu_p INOUT text, ie_abortar_p INOUT text, ds_rotina_digito_p INOUT text) AS $body$
DECLARE


ie_consiste_benef_ops_w		varchar(1);
ie_obter_sit_benef_w		varchar(5);	
ie_atender_plano_sit_benef_w	varchar(2);
ie_consiste_cod_usu_w		varchar(1);	
ie_exige_conf_cod_usua_w	varchar(2);
ie_exige_cart_atend_w		varchar(1) := 'N';
nr_digitos_codigo_w		varchar(15);
ie_tamanho_cod_usu_w		varchar(1);
ds_rotina_digito_w		varchar(50);	
ie_aborta_dig_incorreto_w	varchar(1);	
cd_plano_padrao_w		varchar(10);
cd_plano_conv_w			varchar(10);
ie_atual_plano_usu_conv_w	varchar(1);
ie_aplica_dig_padrao_w		varchar(1);
ie_obriga_perm_dig_padrao_w 	varchar(1);
cd_digito_cod_usu_w		varchar(30);
ie_consiste_plano_benef_w	varchar(1);
cd_usuario_convenio_w		varchar(30);
					

BEGIN
ie_abrir_cons_usu_conv_p := 'N';

ie_exige_conf_cod_usua_w := Obter_param_Usuario(916, 139, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_exige_conf_cod_usua_w);
ie_aborta_dig_incorreto_w := Obter_param_Usuario(916, 255, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_aborta_dig_incorreto_w);
ie_atual_plano_usu_conv_w := Obter_param_Usuario(916, 306, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_atual_plano_usu_conv_w);
ie_consiste_cod_usu_w := Obter_param_Usuario(916, 639, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_consiste_cod_usu_w);
ie_aplica_dig_padrao_w := Obter_param_Usuario(916, 716, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_aplica_dig_padrao_w);
ie_obriga_perm_dig_padrao_w  := Obter_param_Usuario(916, 780, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_obriga_perm_dig_padrao_w );
ie_atender_plano_sit_benef_w := Obter_param_Usuario(916, 1078, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_atender_plano_sit_benef_w);
ie_consiste_plano_benef_w := Obter_param_Usuario(916, 1129, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_consiste_plano_benef_w);

if (coalesce(cd_convenio_p,0) > 0) then
	begin
		select	coalesce(ie_consiste_benef_ops,'N')
		into STRICT	ie_consiste_benef_ops_w
		from  	convenio_estabelecimento
		where  cd_convenio = cd_convenio_p                           
		and    cd_estabelecimento = cd_estabelecimento_p;	
	exception
	when others then
		ie_consiste_benef_ops_w := 'N';
	end;

	if (ie_consiste_benef_ops_w = 'S') then
		
		ie_obter_sit_benef_w := eup_obter_situacao_benef(cd_pessoa_fisica_p, cd_usuario_convenio_p, cd_estabelecimento_p, nr_atendimento_p);
		
		if (ie_obter_sit_benef_w = 'ERRO') then
			ds_msg_inf_usu_incorreto_p := substr(obter_texto_tasy(88313, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		end if;
		
		if (ie_atender_plano_sit_benef_w = 'S') and (ie_obter_sit_benef_w <> 'A') then
			ds_msg_inf_inapto_p := substr(obter_texto_tasy(248678, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		elsif (ie_atender_plano_sit_benef_w = 'N') and (ie_obter_sit_benef_w <> 'A') then
			ds_msg_foca_campo_aborta_p := substr(obter_texto_tasy(248678, wheb_usuario_pck.get_nr_seq_idioma),1,255);
			goto final;
		elsif (ie_atender_plano_sit_benef_w = 'Q') and (ie_obter_sit_benef_w <> 'A') then
			ds_msg_conf_p := substr(obter_texto_tasy(88314, wheb_usuario_pck.get_nr_seq_idioma),1,255);
		end if;
	end if;
	
	if (ie_consiste_cod_usu_w = 'S') then
		if (ie_exige_conf_cod_usua_w = 'C') then
			
			select	obter_valor_conv_estab(cd_convenio, cd_estabelecimento_p, 'IE_EXIGE_CARTEIRA_ATEND')
			into STRICT	ie_exige_cart_atend_w
                        from	convenio
			where	cd_convenio	= cd_convenio_p;
		end if;
		if	((ie_exige_conf_cod_usua_w = 'S') or (ie_exige_cart_atend_w = 'S')) then
			ie_abrir_cons_usu_conv_p := 'S';
		end if;
		
	end if;
	
	if (cd_usuario_convenio_p IS NOT NULL AND cd_usuario_convenio_p::text <> '') then
		SELECT * FROM gerar_empresa_cod_usuario(cd_convenio_p, cd_usuario_convenio_p, nm_usuario_p, cd_empresa_p, nr_seq_conv_usu_p, ie_enviar_email_p, ds_email_p) INTO STRICT cd_empresa_p, nr_seq_conv_usu_p, ie_enviar_email_p, ds_email_p;
			
		ds_rotina_digito_p   :=	 OBTER_ROTINA_DIGITO_USUARIO(cd_convenio_p, cd_categoria_p);			
		if (coalesce(ds_rotina_digito_p::text, '') = '') then
			select ds_rotina_digito
			into STRICT ds_rotina_digito_p
			from convenio
			where cd_convenio = cd_convenio_p;
		end if;		
		
		select	max(cd_plano_padrao)
		into STRICT	cd_plano_padrao_w
		from	categoria_convenio
		where	cd_convenio = cd_convenio_p 
		and	cd_categoria = cd_categoria_p;
		
		if (coalesce(nr_seq_segurado_p,0) = 0) or
		   ((coalesce(nr_seq_segurado_p,0) > 0) and (coalesce(ie_consiste_plano_benef_w,'S') = 'S')) then
		
			if (coalesce(cd_plano_padrao_w::text, '') = '') then
				cd_plano_conv_w := obter_plano_cod_usuario_conv(cd_convenio_p, cd_usuario_convenio_p);
				if (cd_plano_conv_w IS NOT NULL AND cd_plano_conv_w::text <> '') then
					cd_plano_convenio_p := cd_plano_conv_w;
				end if;
			end if;
			if (ie_atual_plano_usu_conv_w = 'S') then
				cd_plano_conv_w := Obter_Plano_Conv_Usu(cd_usuario_convenio_p, cd_convenio_p, cd_categoria_p, cd_estabelecimento_p, dt_entrada_p);
				if (cd_plano_conv_w IS NOT NULL AND cd_plano_conv_w::text <> '') then
					cd_plano_convenio_p := cd_plano_conv_w;
				end if;
			end if;
		
		end if;
		
		ds_msg_consiste_debito_p := Consiste_Debito_Paciente(cd_pessoa_fisica_p, cd_convenio_p, cd_usuario_convenio_p, ie_tipo_atendimento_p, ie_clinica_p, null, cd_categoria_p, dt_entrada_p, ds_msg_consiste_debito_p);
		
		if (ds_prim_digito_p IS NOT NULL AND ds_prim_digito_p::text <> '') and (ie_aplica_dig_padrao_w = 'S') and (ie_obriga_perm_dig_padrao_w = 'S') then
			select	substr(cd_usuario_convenio_p,1,length(ds_prim_digito_p))
			into STRICT	cd_digito_cod_usu_w
			;
			
			if (cd_digito_cod_usu_w IS NOT NULL AND cd_digito_cod_usu_w::text <> '') and (cd_digito_cod_usu_w <> ds_prim_digito_p) then
				ds_msg_primi_dig_cod_usu_p := substr(obter_texto_tasy(304940, wheb_usuario_pck.get_nr_seq_idioma),1,255);
			end if;
		end if;
	end if;

end if;

<<final>>

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE eup_focuslost_cod_usu_conv_js (nr_atendimento_p bigint, nr_seq_segurado_p bigint, ds_prim_digito_p text, ie_tipo_atendimento_p bigint, ie_clinica_p bigint, dt_entrada_p timestamp, nr_seq_consist_dig_p bigint, ie_conta_consiste_digito_p text, cd_categoria_p text, nm_usuario_p text, cd_convenio_p bigint, cd_estabelecimento_p bigint, cd_pessoa_fisica_p text, cd_usuario_convenio_p text, ie_barras_usuario_p text, ds_msg_inf_usu_incorreto_p INOUT text, ds_msg_inf_inapto_p INOUT text, ds_msg_foca_campo_aborta_p INOUT text, ds_msg_conf_p INOUT text, ie_abrir_cons_usu_conv_p INOUT text, cd_empresa_p INOUT bigint, nr_seq_conv_usu_p INOUT bigint, ie_enviar_email_p INOUT text, ds_email_p INOUT text, cd_plano_convenio_p INOUT text, ds_msg_consiste_debito_p INOUT text, ds_msg_primi_dig_cod_usu_p INOUT text, ds_msg_cod_usu_p INOUT text, ie_abortar_p INOUT text, ds_rotina_digito_p INOUT text) FROM PUBLIC;

