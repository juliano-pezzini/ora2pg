-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_fluxo_caixa_repasse (cd_estabelecimento_p bigint, cd_conta_financ_p bigint, ie_regra_data_p text, nr_dia_fixo_p bigint, qt_mes_anterior_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, IE_ACUMULAR_FLUXO_P text, nm_usuario_p text, cd_empresa_p bigint) AS $body$
DECLARE


/*--------------------------------------------------------------- ATENÇÃO ----------------------------------------------------------------*/

/* Cuidado ao realizar alterações no fluxo de caixa. Toda e qualquer alteração realizada em qualquer uma das       */

/* procedures do fluxo de caixa deve ser cuidadosamente verificada e realizada no fluxo de caixa em lote.           */

/* Devemos garantir que os dois fluxos de caixa tragam os mesmos valores no resultado, evitando assim que           */

/* existam diferenças entre os fluxos de caixa.                                                                                                                */

/*--------------- AO ALTERAR O FLUXO DE CAIXA ALTERAR TAMBÉM O FLUXO DE CAIXA EM LOTE ---------------*/

vl_fluxo_w		double precision;
dt_mes_w		timestamp;
dt_referencia_w		timestamp;
ie_tratar_fim_semana_w	varchar(2);
cd_moeda_empresa_w	integer;

c01 CURSOR FOR
SELECT	sum(a.vl_repasse),
	PKG_DATE_UTILS.ADD_MONTH(PKG_DATE_UTILS.start_of(a.dt_item, 'DD', 0), qt_mes_anterior_p,0)
from	terceiro b,
	REPASSE_TERCEIRO_ITEM_V a
where	b.cd_estabelecimento	= cd_estabelecimento_p
and	a.nr_seq_terceiro	= b.nr_sequencia
and	pkg_date_utils.start_of(a.dt_item, 'DD',0) between	PKG_DATE_UTILS.ADD_MONTH(dt_inicial_p, qt_mes_anterior_p * -1,0) and
						PKG_DATE_UTILS.ADD_MONTH(dt_final_p, qt_mes_anterior_p * -1,0)
group	by PKG_DATE_UTILS.ADD_MONTH(pkg_date_utils.start_of(a.dt_item, 'DD',0), qt_mes_anterior_p,0);


BEGIN

select	ie_tratar_fim_semana
into STRICT	ie_tratar_fim_semana_w
from	parametro_fluxo_caixa
where	cd_estabelecimento	= cd_estabelecimento_p;

/* Projeto Multimoeda - Busca a moeda padrão da empresa para gravar no fluxo. */

select	obter_moeda_padrao_empresa(cd_estabelecimento_p,'E')
into STRICT	cd_moeda_empresa_w
;

if (ie_regra_data_p = 'F') then

	dt_mes_w	:= pkg_date_utils.start_of(dt_inicial_p,'MONTH',0);

	while(dt_mes_w <= pkg_date_utils.start_of(dt_final_p, 'MONTH',0)) loop

		if (nr_dia_fixo_p > (pkg_date_utils.extract_field('DAY', pkg_date_utils.end_of(dt_mes_w,'MONTH',0), 0))::numeric ) then
			dt_referencia_w		:= pkg_date_utils.end_of(dt_mes_w,'MONTH',0);
		else
			dt_referencia_w		:= pkg_date_utils.get_date(nr_dia_fixo_p,dt_mes_w,0);
		end if;

		if (dt_referencia_w between dt_inicial_p and dt_final_p) then

			if (ie_tratar_fim_semana_w = 'S') then
				dt_referencia_w			:= obter_proximo_dia_util(cd_estabelecimento_p, dt_referencia_w);
			end if;

			select	sum(a.vl_repasse)
			into STRICT	vl_fluxo_w
			from	terceiro b,
				REPASSE_TERCEIRO_ITEM_V a
			where	b.cd_estabelecimento	= cd_estabelecimento_p
			and	a.nr_seq_terceiro	= b.nr_sequencia
			and	pkg_date_utils.start_of(a.dt_item, 'DD',0) between	PKG_DATE_UTILS.ADD_MONTH(dt_inicial_p, qt_mes_anterior_p * -1,0) and
									PKG_DATE_UTILS.ADD_MONTH(dt_final_p, qt_mes_anterior_p * -1,0);

			begin
			insert into fluxo_caixa(cd_estabelecimento,
				dt_referencia,
				cd_conta_financ,
				ie_classif_fluxo,
				dt_atualizacao,
				nm_usuario,
				vl_fluxo,
				ie_origem,
				ie_periodo,
				ie_integracao,
				cd_empresa,
				cd_moeda)
			values (cd_estabelecimento_p,
				dt_referencia_w,
				cd_conta_financ_p,
				'R',
				clock_timestamp(),
				nm_usuario_p,
				coalesce(vl_fluxo_w,0),
				'I',
				'D',
				'RE',
				cd_empresa_p,
				cd_moeda_empresa_w);
			exception
				when unique_violation then
					update	fluxo_caixa
					set	vl_fluxo		= CASE WHEN IE_ACUMULAR_FLUXO_p='S' THEN  coalesce(vl_fluxo_w,0) + vl_fluxo  ELSE coalesce(vl_fluxo_w,0) END
					where	cd_estabelecimento	= cd_estabelecimento_p
					and	cd_conta_financ	= cd_conta_financ_p
					and	dt_referencia		= dt_referencia_w
					and	ie_periodo		= 'D'
					and	ie_classif_fluxo	= 'R'
					and	ie_integracao		= 'RE'
					and	cd_empresa		= cd_empresa_p;
			end;

		end if;
		dt_mes_w	:= PKG_DATE_UTILS.ADD_MONTH(dt_mes_w, 1,0);
	end loop;

elsif (ie_regra_data_p = 'MA') then

	open c01;
	loop
	fetch c01 into
		vl_fluxo_w,
		dt_referencia_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		begin

		if (ie_tratar_fim_semana_w = 'S') then
			dt_referencia_w			:= obter_proximo_dia_util(cd_estabelecimento_p, dt_referencia_w);
		end if;

		insert into fluxo_caixa(cd_estabelecimento,
			dt_referencia,
			cd_conta_financ,
			ie_classif_fluxo,
			dt_atualizacao,
			nm_usuario,
			vl_fluxo,
			ie_origem,
			ie_periodo,
			ie_integracao,
			cd_empresa,
			cd_moeda)
		values (cd_estabelecimento_p,
			dt_referencia_w,
			cd_conta_financ_p,
			'R',
			clock_timestamp(),
			nm_usuario_p,
			coalesce(vl_fluxo_w,0),
			'I',
			'D',
			'RE',
			cd_empresa_p,
			cd_moeda_empresa_w);
		exception
			when unique_violation then
				update	fluxo_caixa
				set	vl_fluxo		= CASE WHEN IE_ACUMULAR_FLUXO_p='S' THEN  coalesce(vl_fluxo_w,0) + vl_fluxo  ELSE coalesce(vl_fluxo_w,0) END
				where	cd_estabelecimento	= cd_estabelecimento_p
				and	cd_conta_financ	= cd_conta_financ_p
				and	dt_referencia		= dt_referencia_w
				and	ie_periodo		= 'D'
				and	ie_classif_fluxo	= 'R'
				and	ie_integracao		= 'RE'
				and	cd_empresa		= cd_empresa_p;
		end;

	end loop;
	close c01;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_fluxo_caixa_repasse (cd_estabelecimento_p bigint, cd_conta_financ_p bigint, ie_regra_data_p text, nr_dia_fixo_p bigint, qt_mes_anterior_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, IE_ACUMULAR_FLUXO_P text, nm_usuario_p text, cd_empresa_p bigint) FROM PUBLIC;

