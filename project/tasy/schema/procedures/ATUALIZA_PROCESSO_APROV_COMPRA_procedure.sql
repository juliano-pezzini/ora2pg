-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_processo_aprov_compra () AS $body$
DECLARE


nr_seq_aprovacao_w		bigint;
nr_ordem_compra_w		bigint;
ie_urgente_w			varchar(1);
cd_estabelecimento_w		bigint;
nr_solic_compra_w		bigint;
nr_cot_compra_w			bigint;
nr_seq_nf_w			bigint;
nr_requisicao_w			bigint;
nr_seq_licitacao_w		bigint;
dt_documento_w			timestamp;
qt_registros_w			bigint;

c01 CURSOR FOR
SELECT	nr_sequencia
from (
	SELECT	nr_sequencia
	from	processo_aprov_compra
	where	ie_aprov_reprov = 'P'
	and	coalesce(nr_documento,0) = 0
	
union

	select	nr_sequencia
	from	processo_aprov_compra
	where	ie_aprov_reprov <> 'P'
	and	coalesce(nr_documento,0) = 0) alias2
group by nr_sequencia;



BEGIN

open C01;
loop
fetch C01 into
	nr_seq_aprovacao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	nr_ordem_compra_w	:= 0;
	nr_solic_compra_w	:= 0;
	nr_cot_compra_w		:= 0;
	nr_seq_nf_w		:= 0;
	nr_requisicao_w		:= 0;
	nr_seq_licitacao_w	:= 0;

	select	coalesce(max(nr_ordem_compra),0)
	into STRICT	nr_ordem_compra_w
	from	ordem_compra_item
	where	nr_seq_aprovacao = nr_seq_aprovacao_w;

	if (nr_ordem_compra_w > 0) then

		select	coalesce(ie_urgente,'N'),
			cd_estabelecimento,
			dt_ordem_compra
		into STRICT	ie_urgente_w,
			cd_estabelecimento_w,
			dt_documento_w
		from	ordem_compra
		where	nr_ordem_compra = nr_ordem_compra_w;

		update	processo_aprov_compra
		set	cd_estabelecimento = cd_estabelecimento_w,
			ie_urgente = ie_urgente_w,
			ie_tipo = 'O',
			nr_documento = nr_ordem_compra_w,
			dt_documento = dt_documento_w
		where	nr_sequencia = nr_seq_aprovacao_w;

	else

		select	coalesce(max(nr_solic_compra),0)
		into STRICT	nr_solic_compra_w
		from	solic_compra_item
		where	nr_seq_aprovacao = nr_seq_aprovacao_w;

		if (nr_solic_compra_w > 0) then

			select	coalesce(ie_urgente,'N'),
				cd_estabelecimento,
				dt_solicitacao_compra
			into STRICT	ie_urgente_w,
				cd_estabelecimento_w,
				dt_documento_w
			from	solic_compra
			where	nr_solic_compra = nr_solic_compra_w;

			update	processo_aprov_compra
			set	cd_estabelecimento = cd_estabelecimento_w,
				ie_urgente = ie_urgente_w,
				ie_tipo = 'S',
				nr_documento = nr_solic_compra_w,
				dt_documento = dt_documento_w
			where	nr_sequencia = nr_seq_aprovacao_w;

		else
			select	coalesce(max(nr_cot_compra),0)
			into STRICT	nr_cot_compra_w
			from	cot_compra_item
			where	nr_seq_aprovacao = nr_seq_aprovacao_w;

			if (nr_cot_compra_w > 0) then

				select	a.cd_estabelecimento,
					a.dt_cot_compra
				into STRICT	cd_estabelecimento_w,
					dt_documento_w
				from	cot_compra a
				where	a.nr_cot_compra = nr_cot_compra_w;

				select	max(substr(coalesce(obter_dados_solic_item_cot(a.nr_cot_compra, b.nr_item_cot_compra, 'U'),'N'),1,1)) ie_urgente
				into STRICT	ie_urgente_w
				from	cot_compra a,
					cot_compra_item b
				where	a.nr_cot_compra = b.nr_cot_compra
				and	a.nr_cot_compra = nr_cot_compra_w;

				update	processo_aprov_compra
				set	cd_estabelecimento = cd_estabelecimento_w,
					ie_urgente = ie_urgente_w,
					ie_tipo = 'C',
					nr_documento = nr_cot_compra_w,
					dt_documento = dt_documento_w
				where	nr_sequencia = nr_seq_aprovacao_w;

			else

				select	coalesce(max(nr_sequencia),0)
				into STRICT	nr_seq_nf_w
				from	nota_fiscal_item
				where	nr_seq_aprovacao = nr_seq_aprovacao_w;

				if (nr_seq_nf_w > 0) then

					select	cd_estabelecimento,
						dt_emissao
					into STRICT	cd_estabelecimento_w,
						dt_documento_w
					from	nota_fiscal
					where	nr_sequencia = nr_seq_nf_w;

					update	processo_aprov_compra
					set	cd_estabelecimento = cd_estabelecimento_w,
						ie_urgente = 'N',
						ie_tipo = 'N',
						nr_documento = nr_seq_nf_w,
						dt_documento = dt_documento_w
					where	nr_sequencia = nr_seq_aprovacao_w;
				else

					select	coalesce(max(nr_requisicao),0)
					into STRICT	nr_requisicao_w
					from	item_requisicao_material
					where	nr_seq_aprovacao = nr_seq_aprovacao_w;

					if (nr_requisicao_w > 0) then

						select	coalesce(ie_urgente,'N'),
							cd_estabelecimento,
							dt_solicitacao_requisicao
						into STRICT	ie_urgente_w,
							cd_estabelecimento_w,
							dt_documento_w
						from	requisicao_material
						where	nr_requisicao = nr_requisicao_w;

						update	processo_aprov_compra
						set	cd_estabelecimento = cd_estabelecimento_w,
							ie_urgente = ie_urgente_w,
							ie_tipo = 'R',
							nr_documento = nr_requisicao_w,
							dt_documento = dt_documento_w
						where	nr_sequencia = nr_seq_aprovacao_w;

					else
						select	coalesce(max(nr_seq_licitacao),0)
						into STRICT	nr_seq_licitacao_w
						from	reg_lic_item
						where	nr_seq_aprovacao = nr_seq_aprovacao_w;

						if (nr_seq_licitacao_w > 0) then

							select	cd_estabelecimento	,
								dt_emissao
							into STRICT	cd_estabelecimento_w,
								dt_documento_w
							from	reg_licitacao
							where	nr_sequencia = nr_seq_licitacao_w;

							update	processo_aprov_compra
							set	cd_estabelecimento = cd_estabelecimento_w,
								ie_urgente = 'N',
								ie_tipo = 'L',
								nr_documento = nr_seq_licitacao_w,
								dt_documento = dt_documento_w
							where	nr_sequencia = nr_seq_aprovacao_w;
						else
							delete from processo_aprov_compra where nr_sequencia = nr_seq_aprovacao_w;
						end if;
					end if;
				end if;
			end if;
		end if;
	end if;
	commit;
	end;
end loop;
close C01;

update	EMAIL_COMPRA_AGRUP_DEST
set	ie_enviado = 'S'
where	(dt_envio IS NOT NULL AND dt_envio::text <> '')
and	coalesce(ie_enviado,'X') = 'X';

update	EMAIL_COMPRA_AGRUP_DEST
set	ie_enviado = 'N'
where	coalesce(dt_envio::text, '') = ''
and	coalesce(ie_enviado,'X') = 'X';

UPDATE	ENVIO_EMAIL_COMPRA_AGRUP
SET	IE_CANCELADO = 'S'
where	(dt_cancelamento IS NOT NULL AND dt_cancelamento::text <> '')
and	coalesce(IE_CANCELADO,'X') = 'X';

UPDATE	ENVIO_EMAIL_COMPRA_AGRUP
SET	IE_CANCELADO = 'N'
where	coalesce(dt_cancelamento::text, '') = ''
and	coalesce(IE_CANCELADO,'X') = 'X';

select	count(*)
into STRICT	qt_registros_w
from	sup_dados_ultima_compra
where	upper(nm_usuario) = 'TASY01';

if (qt_registros_w = 0) then
	CALL Exec_Sql_Dinamico('Tasy', 'truncate table sup_dados_ultima_compra');
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_processo_aprov_compra () FROM PUBLIC;

