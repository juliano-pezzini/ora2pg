-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_req_material_consumo ( cd_estabelecimento_p bigint, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, nr_seq_familia_mat_p bigint, cd_local_atend_p bigint, cd_local_estoque_p bigint, cd_centro_custo_p bigint, cd_pessoa_requisitante_p text, cd_setor_atendimento_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text, ds_material_p text default null, ds_grupo_p text default null, ds_subgrupo_p text default null, ds_classe_p text default null, ds_familia_p text default null, ds_localizacao_p text default null, ds_local_estoque_p text default null, ds_unidade_medida_p text default null, nr_requisicao_p INOUT bigint  DEFAULT NULL) AS $body$
DECLARE



cd_operacao_transf_setor_w	smallint;
ie_situacao_op_w		varchar(1);
ds_operacao_w			varchar(40);
qt_movimento_w			double precision;
qt_estoque_w			double precision;
qt_conv_estoque_consumo_w	double precision;
nr_sequencia_w              	integer := 0;
nr_requisicao_w			bigint;
cd_material_w               	integer;
cd_unidade_medida_consumo_w 	varchar(30);
cd_unidade_medida_estoque_w 	varchar(30);
qt_itens_desdobra_req_w		bigint := 0;
qt_itens_gerados_w		bigint := 0;
ds_requisicoes_geradas_w	varchar(4000);
	
ie_gerar_material_w		varchar(1) := 'S';
qt_dif_material_w		bigint;		
ds_material_w			varchar(2000);
	
cd_grupo_w			grupo_material.cd_grupo_material%type;
ie_gerar_grupo_w		varchar(1) := 'S';
qt_dif_grupo_w			bigint;
ds_grupo_w			varchar(2000);
		
cd_subgrupo_w			subgrupo_material.cd_subgrupo_material%type;
ie_gerar_subgrupo_w		varchar(1) := 'S';
qt_dif_subgrupo_w		bigint;
ds_subgrupo_w			varchar(2000);
		
cd_classe_w			classe_material.cd_classe_material%type;
ie_gerar_classe_w		varchar(1) := 'S';
qt_dif_classe_w			bigint;
ds_classe_w			varchar(2000);
	
nr_seq_familia_w		material.nr_seq_familia%type;
ie_gerar_familia_w		varchar(1) := 'S';
qt_dif_familia_w		bigint;
ds_familia_w			varchar(2000);
	
nr_seq_localizacao_w		material.nr_seq_localizacao%type;
ie_gerar_localizacao_w		varchar(1) := 'S';
qt_dif_localizacao_w		bigint;
ds_localizacao_w		varchar(2000);
	
nr_seq_local_estoque_w		localizacao_estoque_local.nr_sequencia%type;
ie_gerar_local_estoque_w	varchar(1) := 'S';
qt_dif_local_estoque_w		bigint;
ds_local_estoque_w		varchar(2000);
	
ie_gerar_unidade_medida_w	varchar(1) := 'S';
qt_dif_unidade_medida_w		bigint;
ds_unidade_medida_w		varchar(2000);

c01 CURSOR FOR
SELECT	a.cd_material_estoque,
	c.cd_grupo_material,
	c.cd_subgrupo_material,
	c.cd_classe_material,
	m.nr_seq_familia,
	m.nr_seq_localizacao,
	substr(obter_dados_material_estab(a.cd_material,cd_estabelecimento_p,'UMS'),1,30) cd_unidade_medida_consumo,
	substr(obter_dados_material_estab(a.cd_material,cd_estabelecimento_p,'UME'),1,30) cd_unidade_medida_estoque,
	sum(a.qt_consumo)
from	material m,
	estrutura_material_v c,
	movimento_estoque_v a
where	a.cd_estabelecimento = cd_estabelecimento_p
and	a.cd_material = c.cd_material
and	a.cd_material = m.cd_material
and (c.cd_grupo_material = cd_grupo_material_p or coalesce(cd_grupo_material_p, 0) = 0)
and (c.cd_subgrupo_material	= cd_subgrupo_material_p or coalesce(cd_subgrupo_material_p, 0) = 0)
and (c.cd_classe_material = cd_classe_material_p or coalesce(cd_classe_material_p, 0) = 0)
and (c.nr_seq_familia = nr_seq_familia_mat_p or coalesce(nr_seq_familia_mat_p, 0) = 0)
and (a.cd_centro_custo = cd_centro_custo_p or coalesce(cd_centro_custo_p, 0) = 0)
and (a.cd_local_estoque	= cd_local_estoque_p)
and (substr(obter_se_mat_consignado(a.cd_material),1,1) = '0')
and	a.dt_movimento_estoque between dt_inicial_p and dt_final_p
group by a.cd_material_estoque,
	c.cd_grupo_material,
	c.cd_subgrupo_material,
	c.cd_classe_material,
	m.nr_seq_familia,
	m.nr_seq_localizacao,
	substr(obter_dados_material_estab(a.cd_material,cd_estabelecimento_p,'UMS'),1,30),
	substr(obter_dados_material_estab(a.cd_material,cd_estabelecimento_p,'UME'),1,30);


BEGIN

select	coalesce(max(cd_operacao_transf_setor), 0),
	coalesce(max(qt_itens_requisicao),0)
into STRICT 	cd_operacao_transf_setor_w,
	qt_itens_desdobra_req_w
from 	parametro_estoque
where	cd_estabelecimento = cd_estabelecimento_p;

if (cd_operacao_transf_setor_w = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(266049);
end if;

select	nextval('requisicao_seq')
into STRICT	nr_requisicao_w
;

begin
insert into requisicao_material(
		nr_requisicao,
		cd_estabelecimento,
		cd_local_estoque,
		cd_local_estoque_destino,
		dt_solicitacao_requisicao,
		dt_atualizacao,
		nm_usuario,
		cd_operacao_estoque,
		cd_pessoa_requisitante,
		cd_setor_atendimento,
		cd_estabelecimento_destino,
		ie_urgente,
		ie_geracao)
values (	nr_requisicao_w,
	cd_estabelecimento_p,
	cd_local_atend_p,
	cd_local_estoque_p,
	clock_timestamp(),
	clock_timestamp(),
	nm_usuario_p,
	cd_operacao_transf_setor_w,
	cd_pessoa_requisitante_p,
	cd_setor_atendimento_p,
	cd_estabelecimento_p,
	'N',
	'AC');
exception when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(266050);
end;

ds_requisicoes_geradas_w := nr_requisicao_w;

qt_dif_material_w := position('NOT' in upper(ds_material_p));
ds_material_w := substr(ds_material_p,position('(' in ds_material_p),2000);
ds_material_w := replace(ds_material_w,', ',',');

qt_dif_grupo_w := position('NOT' in upper(ds_grupo_p));
ds_grupo_w := substr(ds_grupo_p,position('(' in ds_grupo_p),2000);
ds_grupo_w := replace(ds_grupo_w,', ',',');

qt_dif_subgrupo_w := position('NOT' in upper(ds_subgrupo_p));
ds_subgrupo_w := substr(ds_subgrupo_p,position('(' in ds_subgrupo_p),2000);
ds_subgrupo_w := replace(ds_subgrupo_w,', ',',');

qt_dif_classe_w := position('NOT' in upper(ds_classe_p));
ds_classe_w := substr(ds_classe_p,position('(' in ds_classe_p),2000);
ds_classe_w := replace(ds_classe_w,', ',',');

qt_dif_familia_w := position('NOT' in upper(ds_familia_p));
ds_familia_w := substr(ds_familia_p,position('(' in ds_familia_p),2000);
ds_familia_w := replace(ds_familia_w,', ',',');

qt_dif_localizacao_w := position('NOT' in upper(ds_localizacao_p));
ds_localizacao_w := substr(ds_localizacao_p,position('(' in ds_localizacao_p),2000);
ds_localizacao_w := replace(ds_localizacao_w,', ',',');

qt_dif_local_estoque_w := position('NOT' in upper(ds_local_estoque_p));
ds_local_estoque_w := substr(ds_local_estoque_p,position('(' in ds_local_estoque_p),2000);
ds_local_estoque_w := replace(ds_local_estoque_w,', ',',');

qt_dif_unidade_medida_w := position('NOT' in upper(ds_unidade_medida_p));
ds_unidade_medida_w := substr(ds_unidade_medida_p,position('(' in ds_unidade_medida_p),2000);
ds_unidade_medida_w := replace(ds_unidade_medida_w,', ',',');

open c01;
loop
fetch c01 into
	cd_material_w,
	cd_grupo_w,
	cd_subgrupo_w,
	cd_classe_w,
	nr_seq_familia_w,
	nr_seq_localizacao_w,
	cd_unidade_medida_consumo_w,
	cd_unidade_medida_estoque_w,
	qt_movimento_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	if (ds_material_w IS NOT NULL AND ds_material_w::text <> '') then
		if (qt_dif_material_w = 0) then
			ie_gerar_material_w := substr(obter_se_contido(cd_material_w, ds_material_w),1,1);
		else
			select	CASE WHEN substr(obter_se_contido(cd_material_w, ds_material_w),1,1)='N' THEN 'S' WHEN substr(obter_se_contido(cd_material_w, ds_material_w),1,1)='S' THEN 'N' END
			into STRICT	ie_gerar_material_w
			;
		end if;
	end if;

	if (ds_grupo_w IS NOT NULL AND ds_grupo_w::text <> '') then
		if (qt_dif_grupo_w = 0) then
			ie_gerar_grupo_w := substr(obter_se_contido(cd_grupo_w, ds_grupo_w),1,1);
		else
			select	CASE WHEN substr(obter_se_contido(cd_grupo_w, ds_grupo_w),1,1)='N' THEN 'S' WHEN substr(obter_se_contido(cd_grupo_w, ds_grupo_w),1,1)='S' THEN 'N' END
			into STRICT	ie_gerar_grupo_w
			;
		end if;
	end if;

	if (ds_subgrupo_w IS NOT NULL AND ds_subgrupo_w::text <> '') then
		if (qt_dif_subgrupo_w = 0) then
			ie_gerar_subgrupo_w := substr(obter_se_contido(cd_subgrupo_w, ds_subgrupo_w),1,1);
		else
			select	CASE WHEN substr(obter_se_contido(cd_subgrupo_w, ds_subgrupo_w),1,1)='N' THEN 'S' WHEN substr(obter_se_contido(cd_subgrupo_w, ds_subgrupo_w),1,1)='S' THEN 'N' END
			into STRICT	ie_gerar_subgrupo_w
			;
		end if;
	end if;

	if (ds_classe_w IS NOT NULL AND ds_classe_w::text <> '') then
		if (qt_dif_classe_w = 0) then
			ie_gerar_classe_w := substr(obter_se_contido(cd_classe_w, ds_classe_w),1,1);
		else
			select	CASE WHEN substr(obter_se_contido(cd_classe_w, ds_classe_w),1,1)='N' THEN 'S' WHEN substr(obter_se_contido(cd_classe_w, ds_classe_w),1,1)='S' THEN 'N' END
			into STRICT	ie_gerar_classe_w
			;
		end if;
	end if;
	
	if (ds_familia_w IS NOT NULL AND ds_familia_w::text <> '') then
		if (qt_dif_familia_w = 0) then
			ie_gerar_familia_w	:= substr(obter_se_contido(nr_seq_familia_w, ds_familia_w),1,1);
		else
			select	CASE WHEN substr(obter_se_contido(nr_seq_familia_w, ds_familia_w),1,1)='N' THEN 'S' WHEN substr(obter_se_contido(nr_seq_familia_w, ds_familia_w),1,1)='S' THEN 'N' END
			into STRICT	ie_gerar_familia_w
			;
		end if;
	end if;

	if (ds_localizacao_w IS NOT NULL AND ds_localizacao_w::text <> '') then
		if (qt_dif_localizacao_w = 0) then
			ie_gerar_localizacao_w := substr(obter_se_contido(nr_seq_localizacao_w, ds_localizacao_w),1,1);
		else
			select	CASE WHEN substr(obter_se_contido(nr_seq_localizacao_w, ds_localizacao_w),1,1)='N' THEN 'S' WHEN substr(obter_se_contido(nr_seq_localizacao_w, ds_localizacao_w),1,1)='S' THEN 'N' END
			into STRICT	ie_gerar_localizacao_w
			;
		end if;
	end if;

	if (ds_local_estoque_w IS NOT NULL AND ds_local_estoque_w::text <> '') then

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_local_estoque_w
		from	localizacao_estoque_local
		where	cd_local_estoque = cd_local_estoque_p
		and	cd_material = cd_material_w;

		if (qt_dif_local_estoque_w = 0) then
			ie_gerar_local_estoque_w := substr(obter_se_contido(nr_seq_local_estoque_w, ds_local_estoque_w),1,1);
		else
			select	CASE WHEN substr(obter_se_contido(nr_seq_local_estoque_w, ds_local_estoque_w),1,1)='N' THEN 'S' WHEN substr(obter_se_contido(nr_seq_local_estoque_w, ds_local_estoque_w),1,1)='S' THEN 'N' END
			into STRICT	ie_gerar_local_estoque_w
			;
		end if;

	end if;

	if (ds_unidade_medida_w IS NOT NULL AND ds_unidade_medida_w::text <> '') then
		if (qt_dif_unidade_medida_w = 0) then
			ie_gerar_unidade_medida_w := substr(obter_se_contido_char(cd_unidade_medida_estoque_w, ds_unidade_medida_w),1,1);
		else
			select	CASE WHEN substr(obter_se_contido_char(cd_unidade_medida_estoque_w, ds_unidade_medida_w),1,1)='N' THEN 'S' WHEN substr(obter_se_contido_char(cd_unidade_medida_estoque_w, ds_unidade_medida_w),1,1)='S' THEN 'N' END
			into STRICT	ie_gerar_unidade_medida_w
			;
		end if;
	end if;
	
	if (ie_gerar_material_w = 'S') and (ie_gerar_grupo_w = 'S') and (ie_gerar_subgrupo_w = 'S') and (ie_gerar_classe_w = 'S') and (ie_gerar_familia_w = 'S') and (ie_gerar_localizacao_w = 'S') and (ie_gerar_local_estoque_w = 'S') and (ie_gerar_unidade_medida_w = 'S') then
		
		if (qt_itens_desdobra_req_w > 0) and (qt_itens_gerados_w = qt_itens_desdobra_req_w) then

			select	nextval('requisicao_seq')
			into STRICT	nr_requisicao_w
			;

			begin
			insert into requisicao_material(
				nr_requisicao,
				cd_estabelecimento,
				cd_local_estoque,
				cd_local_estoque_destino,
				dt_solicitacao_requisicao,
				dt_atualizacao,
				nm_usuario,
				cd_operacao_estoque,
				cd_pessoa_requisitante,
				cd_setor_atendimento,
				cd_estabelecimento_destino,
				ie_urgente,
				ie_geracao)
			values (	nr_requisicao_w,
				cd_estabelecimento_p,
				cd_local_atend_p,
				cd_local_estoque_p,
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_p,
				cd_operacao_transf_setor_w,
				cd_pessoa_requisitante_p,
				cd_setor_atendimento_p,
				cd_estabelecimento_p,
				'N',
				'AC');
			exception when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(266050);
			end;

			ds_requisicoes_geradas_w := substr(ds_requisicoes_geradas_w || ', ' || nr_requisicao_w,1,4000);
			nr_sequencia_w := 0;
			qt_itens_gerados_w := 0;

		end if;
		
		select	qt_conv_estoque_consumo
		into STRICT	qt_conv_estoque_consumo_w
		from	material
		where	cd_material = cd_material_w;

		qt_estoque_w := Dividir(qt_movimento_w, qt_conv_estoque_consumo_w);
		nr_sequencia_w := (nr_sequencia_w + 1);

		insert into item_requisicao_material(
			nr_requisicao,
			nr_sequencia,
			cd_estabelecimento,
			cd_material,
			qt_material_requisitada,
			qt_material_atendida,
			qt_material_req_auto,
			vl_material,
			dt_atualizacao,
			nm_usuario,
			cd_unidade_medida,
			qt_estoque,
			cd_unidade_medida_estoque,
			ie_acao,
			cd_motivo_baixa)
			values (	nr_requisicao_w,
			nr_sequencia_w,
			cd_estabelecimento_p,
			cd_material_w,
			qt_movimento_w,
			0,
			qt_movimento_w,
			0,
			clock_timestamp(),
			nm_usuario_p,
			cd_unidade_medida_consumo_w,
			qt_estoque_w,
			cd_unidade_medida_estoque_w,
			'1',
			0);

		qt_itens_gerados_w := coalesce(qt_itens_gerados_w,0) + 1;

	end if;

end loop;
close c01;

if (coalesce(qt_itens_desdobra_req_w,0) > 0) then
	update requisicao_material
	set ds_observacao = substr(wheb_mensagem_pck.get_texto(302766,'DS_REQUISICOES_GERADAS_W='||ds_requisicoes_geradas_w),1,255)
	where substr(obter_se_contido(nr_requisicao,ds_requisicoes_geradas_w),1,1) = 'S';
end if;

if (coalesce(qt_itens_gerados_w,0) = 0) then
	delete from requisicao_material
	where nr_requisicao = nr_requisicao_w;
	nr_requisicao_w := 0;
else
	CALL gravar_estoque_requisicao_lib(nr_requisicao_w, nm_usuario_p);
end if;

commit;

nr_requisicao_p := nr_requisicao_w;
												
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_req_material_consumo ( cd_estabelecimento_p bigint, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, nr_seq_familia_mat_p bigint, cd_local_atend_p bigint, cd_local_estoque_p bigint, cd_centro_custo_p bigint, cd_pessoa_requisitante_p text, cd_setor_atendimento_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text, ds_material_p text default null, ds_grupo_p text default null, ds_subgrupo_p text default null, ds_classe_p text default null, ds_familia_p text default null, ds_localizacao_p text default null, ds_local_estoque_p text default null, ds_unidade_medida_p text default null, nr_requisicao_p INOUT bigint  DEFAULT NULL) FROM PUBLIC;

