-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consite_npt_osmolaridade ( nr_prescricao_p prescr_medica.nr_prescricao%type) AS $body$
DECLARE


qt_npt_w					bigint;
qt_regra_osm_w				bigint;
ie_via_administracao_w		nut_pac.ie_via_administracao%type;

BEGIN

select	count(nr_sequencia)
into STRICT	qt_npt_w
from	nut_pac
where	nr_prescricao = nr_prescricao_p
and		ie_npt_adulta in ('S','P');

if (qt_npt_w > 0) then

	select	max(a.ie_via_administracao)
	into STRICT	ie_via_administracao_w
	from	nut_pac a,
			rep_consiste_osmolaridade b
	where	a.ie_via_administracao = b.ie_via_administracao
	and		a.qt_osmolaridade_total > coalesce(b.qt_final,0)
	and		a.nr_prescricao = nr_prescricao_p
	and		coalesce(ie_permite_liberar,'S') = 'N';

	if (ie_via_administracao_w IS NOT NULL AND ie_via_administracao_w::text <> '') then
		--Conforme definido pela Instituição, a administração da NPT pela via selecionada não é recomendada e a prescrição não poderá ser liberada. Favor verificar.
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(284800,'',-20012);
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consite_npt_osmolaridade ( nr_prescricao_p prescr_medica.nr_prescricao%type) FROM PUBLIC;

