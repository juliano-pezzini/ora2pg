-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inativa_paciente_obito (nr_sequencia_p bigint, ds_justificativa_p text, nm_usuario_p text) AS $body$
DECLARE

 
dt_obito_pf_w		timestamp;
dt_obito_do_w		timestamp;
cd_pessoa_fisica_w	pessoa_fisica.CD_PESSOA_FISICA%type;

BEGIN
	begin 
		select	a.dt_obito, 
			y.dt_obito, 
			a.cd_pessoa_fisica 
		into STRICT	dt_obito_pf_w, 
			dt_obito_do_w, 
			cd_pessoa_fisica_w 
		from	pessoa_fisica a, 
			atendimento_paciente x, 
			declaracao_obito y 
		where 	a.cd_pessoa_fisica = x.cd_pessoa_fisica 
		and	x.nr_atendimento = y.nr_atendimento 
		and 	y.nr_sequencia = nr_sequencia_p 
		and	not exists (	SELECT 	1 
					from 	declaracao_obito z 
					where	z.nr_atendimento = x.nr_atendimento 
					and	z.nr_sequencia <> y.nr_sequencia 
					and	z.dt_obito = y.dt_obito);
		 
	exception 
	when others then 
		dt_obito_pf_w 		:= null;
		cd_pessoa_fisica_w	:= null;
	end;
					 
					 
	update 	declaracao_obito 
    set 	dt_inativacao = clock_timestamp(), 
		nm_usuario_inativacao = nm_usuario_p, 
		ds_justificativa = ds_justificativa_p, 
        ie_situacao = 'I' 
	where 	nr_sequencia = nr_sequencia_p;
	 
	if (dt_obito_pf_w IS NOT NULL AND dt_obito_pf_w::text <> '') and (dt_obito_do_w IS NOT NULL AND dt_obito_do_w::text <> '') and (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') and (coalesce(nr_sequencia_p,0) > 0) then 
			 
			update	pessoa_fisica 
			set	dt_obito  = NULL 
			where	cd_pessoa_fisica = cd_pessoa_fisica_w 
			and	dt_obito 	 = dt_obito_do_w;
			 
	end if;
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inativa_paciente_obito (nr_sequencia_p bigint, ds_justificativa_p text, nm_usuario_p text) FROM PUBLIC;

