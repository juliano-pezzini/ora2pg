-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_email_lote_avaliacao ( nr_seq_lote_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ds_retorno_p INOUT text) AS $body$
DECLARE

 
mens_aval_lote_w	varchar(255);		
ds_texto_email_w	varchar(255);
ds_erros_w		varchar(4000);
nr_sequencia_w		bigint;
cd_pessoa_fisica_w	varchar(10);
			
C01 CURSOR FOR 
	SELECT	nr_sequencia, 
		cd_pessoa_fisica 
	from	med_avaliacao_paciente 
	where	nr_seq_lote	= nr_seq_lote_p;
			

BEGIN 
 
ds_retorno_p	:= null;	
ds_erros_w	:= null;	
 
open C01;
loop 
fetch C01 into	 
	nr_sequencia_w, 
	cd_pessoa_fisica_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin	 
 
	begin	 
	mens_aval_lote_w	:= substr(obter_mensagem_aval_lote(cd_pessoa_fisica_w),1,255);
	 
	if (mens_aval_lote_w <> '') then 
		ds_texto_email_w	:= obter_mensagem_aval_lote(cd_pessoa_fisica_w);	
	else 
		ds_texto_email_w := Obter_Param_Usuario(944, 9, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ds_texto_email_w);
	end if;
		 
	CALL enviar_email_avaliacao( nr_sequencia_w, ds_texto_email_w, nm_usuario_p);
	 
	exception 
	when others then 
		ds_erros_w := ds_erros_w || ',' || nr_sequencia_w;
	end;	
		 
	end;
end loop;
close C01;
 
if (ds_erros_w IS NOT NULL AND ds_erros_w::text <> '') then 
	ds_retorno_p	:= substr(obter_texto_dic_objeto(75150, wheb_usuario_pck.get_nr_seq_idioma, 'DS_ERRO='||ds_erros_w),1,255);
else 
	ds_retorno_p	:= substr(obter_texto_tasy(75124,wheb_usuario_pck.get_nr_seq_idioma),1,255);
end if;	
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_email_lote_avaliacao ( nr_seq_lote_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ds_retorno_p INOUT text) FROM PUBLIC;

