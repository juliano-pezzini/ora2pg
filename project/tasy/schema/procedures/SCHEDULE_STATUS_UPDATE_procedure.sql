-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE schedule_status_update (nr_sequencia_p text, type_of_schd_p bigint, current_status_p text) AS $body$
DECLARE


current_status_w    varchar(2);


BEGIN
-- A    - Visited
-- AC   - Arrived
-- C    - Canceled
-- AE   - Awaiting Next Consultation
-- type_of_schd_p = 1 - Surgical Schedule
-- type_of_schd_p = 2 - Exam Schedule
-- type_of_schd_p = 3 - Consultation Schedule
-- type_of_schd_p = 5 - Service Schedule
   select  CASE WHEN current_status_p='A' THEN  'AC' WHEN current_status_p='C' THEN  'AE' END
    into STRICT   current_status_w
;

    if (current_status_w in ('AC', 'AE')) then
        if (type_of_schd_p in (3, 5)) then
            update agenda_consulta
            set ie_status_agenda    = current_status_w,
                nm_usuario          = wheb_usuario_pck.get_nm_usuario,
                dt_atualizacao      = clock_timestamp()
            where nr_sequencia      = nr_sequencia_p;
        elsif (type_of_schd_p in (1, 2)) then
            update agenda_paciente
            set ie_status_agenda    = current_status_w,
                nm_usuario          = wheb_usuario_pck.get_nm_usuario,
                dt_atualizacao      = clock_timestamp()
            where nr_sequencia      = nr_sequencia_p;
        end if;
        commit;
    end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE schedule_status_update (nr_sequencia_p text, type_of_schd_p bigint, current_status_p text) FROM PUBLIC;

