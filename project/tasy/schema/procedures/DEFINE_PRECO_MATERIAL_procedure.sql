-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE define_preco_material (cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, dt_vigencia_p timestamp, cd_material_p bigint, cd_tipo_acomodacao_p bigint, ie_tipo_atendimento_p bigint, cd_setor_atendimento_p bigint, cd_cgc_fornecedor_p text, qt_idade_p bigint, nr_sequencia_p bigint, cd_plano_p text, cd_proc_referencia_p bigint, ie_origem_proc_p bigint, nr_seq_marca_p bigint, ie_clinica_p bigint, nr_seq_classif_atend_p bigint, nr_atendimento_p bigint, ie_vago_4_p text, vl_material_p INOUT bigint, dt_ult_vigencia_p INOUT timestamp, cd_tab_preco_mat_p INOUT bigint, ie_origem_preco_p INOUT bigint, nr_seq_bras_preco_p INOUT bigint, nr_seq_mat_bras_p INOUT bigint, nr_seq_conv_bras_p INOUT bigint, nr_seq_conv_simpro_p INOUT bigint, nr_seq_mat_simpro_p INOUT bigint, nr_seq_simpro_preco_p INOUT bigint, nr_seq_ajuste_mat_p INOUT bigint) AS $body$
DECLARE


nr_dec_unitario_w			smallint;
ie_origem_preco_w			smallint;
ie_origem_preco_maior_w		smallint;
ie_origem_preco_menor_w		smallint;
ie_origem_preco_ww		smallint;
ie_tipo_rounded_w			varchar(1);
tx_ajuste_mat_w			double precision	:= 0;
tx_afaturar_w			double precision	:= 0;
cd_tab_preco_material_w		smallint	:= 0;
dt_base_fixo_w			timestamp;
dt_base_bras_w			timestamp;
dt_vigencia_w			timestamp	:= clock_timestamp() - interval '1000 days';
dt_vigencia_maior_w		timestamp	:= clock_timestamp() - interval '1000 days';
dt_vigencia_menor_w		timestamp	:= clock_timestamp() - interval '1000 days';
dt_vigencia_orig_w			timestamp	:= clock_timestamp();

vl_material_w			double precision 	:= 0;
vl_material_orig_w			double precision 	:= 0;

ie_preco_informado_w		varchar(1)	:= 'N';
ie_glosa_w			varchar(1)	:= '';
cd_cgc_fornecedor_w		varchar(14);
tx_brasindice_pfb_w		REGRA_AJUSTE_MATERIAL.TX_BRASINDICE_PFB%type    := 0;--number(15,4)	:= 0;
tx_brasindice_pmc_w		CONVENIO_BRASINDICE.TX_BRASINDICE_PMC%type      := 0;--number(15,4)	:= 0;
tx_pmc_neg_w			CONVENIO_BRASINDICE.TX_PMC_NEG%type             := 0;--number(15,4)	:= 0;
tx_pmc_pos_w			CONVENIO_BRASINDICE.TX_PMC_POS%type             := 0;--number(15,4)	:= 0;
qt_dia_fixo_w			integer	:= 0;
tx_simpro_pfb_w			double precision;
tx_simpro_pmc_w			double precision;
ie_precedencia_w			varchar(01);
ie_origem_w			varchar(05);
ie_origem_ww			varchar(01);
ie_preced_conv_w			varchar(01);
ie_atend_retorno_w		varchar(01);
ie_origem_conv_w			varchar(05);

ie_preced_conv_estab_w		varchar(01);
ie_origem_conv_estab_w		varchar(05);

pr_glosa_w			double precision 	:= 0;
vl_glosa_w			double precision 	:= 0;
vl_material_inf_w			double precision;
cd_tabela_preco_w			bigint;
cd_tabela_preco_ww			bigint;
cd_motivo_exc_conta_w		bigint;
cd_moeda_w			smallint;
cd_moeda_padrao_w		smallint;
vl_cotacao_w			cotacao_moeda.vl_cotacao%type;
tx_ajuste_periodo_w		double precision;
nr_seq_regra_w			bigint;
ie_tipo_preco_conv_w		varchar(03);
cd_tiss_w				varchar(40);
vl_maior_preco_w			double precision;
vl_menor_preco_w			double precision;
vl_mat_orig_taxa_ajuste			double precision;
qt_conversao_w			double precision;
ie_autor_particular_w		varchar(1);
cd_convenio_glosa_ww		integer:= 0;
cd_categoria_glosa_ww		varchar(10):= ' ';
nr_atendimento_w	bigint;

ie_preco_custo_w	  		varchar(01);
cd_tabela_custo_w			bigint;
dt_ref_custo_w			timestamp;
vl_custo_w			double precision;
ie_apuracao_custo_w		varchar(10);
vl_custo_unitario_w			double precision;
pr_imposto_w			double precision	:= 0;
ds_criterio_w			varchar(20);

tx_pfb_neg_w			CONVENIO_BRASINDICE.TX_PFB_NEG%type;--number(15,4);
tx_pfb_pos_w			CONVENIO_BRASINDICE.TX_PFB_POS%type;--number(15,4);
tx_ajuste_mat_orig_w		double precision	:= 0;

ds_origem_w			varchar(100):='';
ds_precedencia_w			varchar(100):='';
ds_valor_w			varchar(2000):='';
ds_valor_vig_w			varchar(2000):=null;

ie_gravar_log_w			varchar(1):= 'N';
qt_material_w			double precision;
cd_material_w			bigint;
ie_valor_mat_estoque_w		varchar(2);
cd_material_estoque_w		integer;
cd_grupo_material_w		smallint;
ie_fora_vig_w			varchar(1);

qt_conv_estoque_consumo_w	double precision;

dt_entrada_w			timestamp;

tx_brasindice_pmc_neg_w		double precision	:= 0;
tx_brasindice_pmc_pos_w		double precision	:= 0;

ie_fixar_vig_brasindice_w	varchar(1)	:= 'N';
ie_fixar_vig_simpro_w		convenio_estabelecimento.ie_fixar_vig_simpro%type := 'N';

cd_classe_material_w		integer;
cd_subgrupo_material_w		smallint;
ds_tipo_preco_w			varchar(2000)	:= null;
cd_tab_mat_atualizacao_w	smallint 	:= 0;
cd_tab_mat_praticado_w		smallint 	:= 0;
vl_mat_tab_atualizacao_w	double precision 	:= 0;
ie_tipo_material_w		varchar(3);
ie_regra_preco_tab_mat_w	 varchar(1) := 'N';
ie_ignora_preco_venda_w		varchar(1) := 'N';
vl_indice_w			double precision;
ie_tab_preco_mat_interna_w	varchar(1):= 'N';
ie_entrou_simpro_w		varchar(1);
nr_seq_origem_w			bigint;
tx_ajuste_mat_ww		double precision	:= 0;
nr_seq_cobertura_w		bigint;

vl_mat_aux1_w			double precision 	:= 0;
vl_mat_aux2_w			double precision 	:= 0;
vl_mat_aux3_w			double precision 	:= 0;
tx_simpro_pmc_neg_w		double precision	:= 0;
tx_simpro_pmc_pos_w		double precision	:= 0;
tx_simpro_pfb_neg_w		double precision;
tx_simpro_pfb_pos_w		double precision;
ie_dividir_indice_pmc_w		varchar(1);
ie_dividir_indice_pfb_w		varchar(1);

cd_grupo_material_ww		smallint;
cd_classe_material_ww		integer;
cd_subgrupo_material_ww		smallint;
tx_simpro_pos_pfb_w		double precision;
tx_simpro_neg_pfb_w		double precision;
tx_simpro_pos_pmc_w		double precision;
tx_simpro_neg_pmc_w		double precision;
qt_dias_internacao_w		bigint;
ie_data_mat_dias_int_w		varchar(1);
nr_seq_lote_fornec_w		bigint;
nr_seq_marca_w			bigint;
nr_seq_regra_lanc_w		bigint;
nr_seq_lib_dieta_conv_w		bigint;
ie_clinica_w			integer;
ie_data_fixa_w			varchar(1);
ie_prioridade_brasindice_w	varchar(1);
ie_restrito_w			varchar(1);
ie_solucao_w			varchar(1);
nr_seq_bras_preco_w		bigint;
nr_seq_mat_bras_w		bigint;
nr_seq_conv_bras_w		bigint;
nr_seq_conv_simpro_w		bigint;
nr_seq_mat_simpro_w		bigint;
nr_seq_simpro_preco_w		bigint;
cd_usuario_convenio_w		varchar(30);
tx_ajuste_regra_w		regra_ajuste_material.tx_ajuste%type;

vl_material_tab_w		double precision;
vl_maior_preco_tab_w	double precision;
vl_menor_preco_tab_w	double precision;
ds_nls_territory_w		varchar(64);
nm_usuario_logado_w		usuario.nm_usuario%type;

ie_prioridade_simpro_w		parametro_faturamento.ie_prioridade_simpro%type;
ie_prostheses_price_w		convenio_estabelecimento.ie_prostheses_price%type;
dt_cycle_start_w		prostheses_item_price.dt_cycle_start%type;
dt_cycle_end_w			prostheses_item_price.dt_cycle_end%type;
vl_minimum_benefit_w		prostheses_item_price.vl_minimum_benefit%type;
vl_maximum_benefit_w		prostheses_item_price.vl_maximum_benefit%type;
ie_action_flag_w		prostheses_item_price.ie_action_flag%type;
cd_material_glo_w 		preco_material_global.cd_material_glo%type;
check_material_global_w integer;

ie_precedencia_c01  	integer;
ie_origem_c01			varchar(10);
cd_cgc_fornecedor_c01 preco_material.cd_cgc_fornecedor%type;

c01 CURSOR FOR
/*SO-2220426*/

SELECT	/*+index (a prcmate_pk) */	a.vl_preco_venda,
	a.dt_inicio_vigencia,
	b.cd_tab_preco_mat,
	a.cd_moeda,
	coalesce(a.qt_conversao,1),
	CASE WHEN ie_precedencia_w='D' THEN 0  ELSE coalesce(b.nr_prioridade,1) END  ie_precedencia,
	CASE WHEN ie_origem_ww='T' THEN coalesce(b.nr_prioridade,1)  ELSE 0 END  ie_origem,
	CASE WHEN coalesce(cd_cgc_fornecedor_w::text, '') = '' THEN  '0'  ELSE coalesce(a.cd_cgc_fornecedor,'0') END  cd_cgc_fornecedor
from	preco_material 		a,
	convenio_preco_mat	b
where	a.cd_tab_preco_mat	= b.cd_tab_preco_mat
and	b.cd_convenio		= cd_convenio_p
and	b.cd_categoria		= cd_categoria_p
and	a.cd_estabelecimento 	= cd_estabelecimento_p
and	a.cd_estabelecimento 	= b.cd_estabelecimento
and	a.cd_material        	= cd_material_w
and	coalesce(cd_tabela_preco_w, a.cd_tab_preco_mat) = a.cd_tab_preco_mat
and	coalesce(a.ie_situacao,'A')	= 'A'
and	coalesce(b.ie_situacao,'A')	= 'A'
and	coalesce(b.ie_tab_adicional,'N')	= 'N'
and	((coalesce(cd_cgc_fornecedor_w::text, '') = '') or (coalesce(a.cd_cgc_fornecedor,cd_cgc_fornecedor_w) = cd_cgc_fornecedor_w))
and	dt_vigencia_w between coalesce(b.dt_inicio_vigencia, dt_vigencia_w)	and coalesce(b.dt_final_vigencia, dt_vigencia_w)
--and	a.dt_inicio_vigencia	<= dt_vigencia_p     -- Subsituido a linha pela linha abaixo, OS 454541
and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_vigencia_p) between coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_inicio_vigencia), clock_timestamp() - interval '3650 days') and coalesce(a.dt_final_vigencia, dt_vigencia_p)
and	((coalesce(a.ie_preco_venda, 'S') = 'S') or (ie_ignora_preco_venda_w = 'S'))
and	exists (	select	1
		from	tabela_preco_material x
		where	x.cd_tab_preco_mat = a.cd_tab_preco_mat
		and	coalesce(x.ie_situacao,'A') = 'A'
		and	x.cd_estabelecimento = cd_estabelecimento_p
		and coalesce(x.ie_tabela_global,'N') = 'N')

union all

select	/*+index (a prcmate_pk) */	a.vl_preco vl_preco_venda,
	a.dt_inicio_vigencia,
	b.cd_tab_preco_mat,
	0 cd_moeda, --verificar com o Ambrosio
	0 qt_conversao, --verificar com o Ambrosio
	CASE WHEN ie_precedencia_w='D' THEN 0  ELSE coalesce(b.nr_prioridade,1) END  ie_precedencia,
	CASE WHEN ie_origem_ww='T' THEN coalesce(b.nr_prioridade,1)  ELSE 0 END  ie_origem,
	'' cd_cgc_fornecedor  --verificar com o Ambrosio
from	preco_material_global	a,
	convenio_preco_mat	b
where	a.cd_tab_preco_mat	= b.cd_tab_preco_mat
and	b.cd_convenio		= cd_convenio_p
and	b.cd_categoria		= cd_categoria_p
and	a.cd_estabelecimento 	= cd_estabelecimento_p
and	a.cd_estabelecimento 	= b.cd_estabelecimento
and	a.cd_material_glo        	= cd_material_glo_w
and	coalesce(cd_tabela_preco_w, a.cd_tab_preco_mat) = a.cd_tab_preco_mat
and	coalesce(a.ie_situacao,'A')	= 'A'
and	coalesce(b.ie_situacao,'A')	= 'A'
and	coalesce(b.ie_tab_adicional,'N')	= 'N'
and	dt_vigencia_w between coalesce(b.dt_inicio_vigencia, dt_vigencia_w)	and coalesce(b.dt_final_vigencia, dt_vigencia_w)
and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_vigencia_p) between coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_inicio_vigencia), clock_timestamp() - interval '3650 days') and coalesce(a.dt_final_vigencia, dt_vigencia_p)
and	exists (	select	1
		from	tabela_preco_material x
		where	x.cd_tab_preco_mat = a.cd_tab_preco_mat
		and	coalesce(x.ie_situacao,'A') = 'A'
		and	x.cd_estabelecimento = cd_estabelecimento_p
		and coalesce(x.ie_tabela_global,'N') = 'S')
order by
	ie_precedencia desc,
	ie_origem desc,
	cd_cgc_fornecedor,
	dt_inicio_vigencia,
	vl_preco_venda;

/*SO-2220426*/

C02 CURSOR FOR
	SELECT	coalesce(coalesce(tx_brasindice_pfb_w,tx_preco_fabrica),1),
		coalesce(coalesce(tx_brasindice_pmc_w,tx_brasindice_pmc),1),
		coalesce(tx_pmc_neg_w,tx_pmc_neg),
		coalesce(tx_pmc_pos_w,tx_pmc_pos),
		coalesce(qt_dia_fixo,0),
		coalesce(dt_base_fixo, dt_vigencia_p),
		coalesce(tx_brasindice_pmc_neg_w, tx_pfb_neg),
		coalesce(tx_brasindice_pmc_pos_w, tx_pfb_pos),
		coalesce(ie_data_fixa,'N'),
		nr_sequencia
	from	convenio_brasindice
	where	cd_convenio		= cd_convenio_p
	and	((coalesce(cd_categoria::text, '') = '')	or (cd_categoria = cd_categoria_p))
	and 	((coalesce(cd_grupo_material::text, '') = '') or (cd_grupo_material = cd_grupo_material_w))
	and 	((coalesce(cd_subgrupo_material::text, '') = '') or (cd_subgrupo_material = cd_subgrupo_material_w))
	and 	((coalesce(cd_classe_material::text, '') = '') or (cd_classe_material = cd_classe_material_w))
	and	((coalesce(nr_seq_estrutura::text, '') = '') or (consistir_se_mat_estrut_vig(nr_seq_estrutura,cd_material_p, dt_vigencia_p) = 'S'))		
	and 	((coalesce(ie_tipo_material::text, '') = '') or (ie_tipo_material = ie_tipo_material_w))
	and	((coalesce(ie_tipo_atendimento::text, '') = '') or (ie_tipo_atendimento = coalesce(ie_tipo_atendimento_p,0)))
	and	coalesce(cd_plano, coalesce(cd_plano_p, 0)) = coalesce(cd_plano_p, 0)
	and	cd_estabelecimento	= cd_estabelecimento_p
	and	coalesce(ie_situacao,'A')	= 'A'
	and	dt_inicio_vigencia	= (
		SELECT max(a.dt_inicio_vigencia)
		from	convenio_brasindice a
		where	a.cd_convenio		= cd_convenio_p
		and	((coalesce(cd_categoria::text, '') = '')	or (cd_categoria = cd_categoria_p))
		and 	((coalesce(cd_grupo_material::text, '') = '') or (cd_grupo_material = cd_grupo_material_w))
		and 	((coalesce(cd_subgrupo_material::text, '') = '') or (cd_subgrupo_material = cd_subgrupo_material_w))
		and 	((coalesce(cd_classe_material::text, '') = '') or (cd_classe_material = cd_classe_material_w))
		and	((coalesce(nr_seq_estrutura::text, '') = '') or (consistir_se_mat_estrut_vig(nr_seq_estrutura,cd_material_p, dt_vigencia_p) = 'S'))
		and 	((coalesce(a.ie_tipo_material::text, '') = '') or (a.ie_tipo_material = ie_tipo_material_w))
		and	((coalesce(a.ie_tipo_atendimento::text, '') = '') or (ie_tipo_atendimento = coalesce(ie_tipo_atendimento_p,0)))
		and	coalesce(cd_plano, coalesce(cd_plano_p, 0)) = coalesce(cd_plano_p, 0)
		and	cd_estabelecimento	= cd_estabelecimento_p
		and	coalesce(a.ie_situacao,'A')= 'A'
		and	dt_vigencia_p between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_inicio_vigencia) and ESTABLISHMENT_TIMEZONE_UTILS.endOfDay(coalesce(a.dt_final_vigencia, dt_vigencia_p)))
		--and	a.dt_inicio_vigencia <= dt_vigencia_p)
	order by coalesce(cd_categoria,'0'),
		coalesce(nr_seq_estrutura,0),
		coalesce(cd_classe_material,0),
		coalesce(cd_subgrupo_material,0),
		coalesce(cd_grupo_material,0),
		coalesce(ie_tipo_material,'0'),
		coalesce(ie_tipo_atendimento,0),
		coalesce(dt_base_fixo, dt_vigencia_p),
		coalesce(cd_plano, 0);
/*SO-2220426*/
		
c03 CURSOR FOR
SELECT	/*+index (a prcmate_pk) */	a.vl_preco_venda,
	a.dt_inicio_vigencia,
	b.cd_tab_preco_mat,
	a.cd_moeda,
	coalesce(a.qt_conversao,1),
	tx_ajuste_tabela_mat
from	preco_material 		a,
	convenio_preco_mat	b
where	a.cd_tab_preco_mat	= b.cd_tab_preco_mat
and	b.cd_convenio		= cd_convenio_p
and	b.cd_categoria		= cd_categoria_p
and	a.cd_estabelecimento 	= cd_estabelecimento_p
and	a.cd_estabelecimento 	= b.cd_estabelecimento
and	a.cd_material        	= cd_material_w
and 	((coalesce(cd_grupo_material::text, '') = '') or (cd_grupo_material = cd_grupo_material_ww))
and 	((coalesce(cd_subgrupo_material::text, '') = '') or (cd_subgrupo_material = cd_subgrupo_material_ww))
and 	((coalesce(cd_classe_material::text, '') = '') or (cd_classe_material = cd_classe_material_ww))
and	coalesce(cd_tabela_preco_ww, a.cd_tab_preco_mat) = a.cd_tab_preco_mat
and	coalesce(a.ie_situacao,'A')	= 'A'
and	coalesce(b.ie_situacao,'A')	= 'A'
and	coalesce(b.ie_tab_adicional,'N')	= 'S'
and	((coalesce(cd_cgc_fornecedor_w::text, '') = '') or (coalesce(a.cd_cgc_fornecedor,cd_cgc_fornecedor_w) = cd_cgc_fornecedor_w))
and	dt_vigencia_w between coalesce(b.dt_inicio_vigencia, dt_vigencia_w)	and coalesce(b.dt_final_vigencia, dt_vigencia_w)
--and	a.dt_inicio_vigencia	<= dt_vigencia_p  -- Subsituido a linha pela linha abaixo, OS 454541
and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_vigencia_p) between coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_inicio_vigencia), clock_timestamp() - interval '3650 days') and coalesce(a.dt_final_vigencia, dt_vigencia_p)
and	coalesce(a.ie_preco_venda,'S') = 'S'
and	exists (	select	1
		from	tabela_preco_material x
		where	x.cd_tab_preco_mat = a.cd_tab_preco_mat
		and	coalesce(x.ie_situacao,'A') = 'A'
		and	x.cd_estabelecimento = cd_estabelecimento_p)
order by
	CASE WHEN ie_precedencia_w='D' THEN 0  ELSE coalesce(b.nr_prioridade,1) END  desc,
	CASE WHEN ie_origem_ww='T' THEN coalesce(b.nr_prioridade,1)  ELSE 0 END  desc,
	CASE WHEN coalesce(cd_cgc_fornecedor_w::text, '') = '' THEN  '0'  ELSE coalesce(a.cd_cgc_fornecedor,'0') END ,
	coalesce(cd_classe_material,0),
	coalesce(cd_subgrupo_material,0),
	coalesce(cd_grupo_material,0),	
	a.dt_inicio_vigencia,
	a.vl_preco_venda;

/*SO-2220426*/
			
C04 CURSOR FOR
	SELECT	CASE WHEN coalesce(tx_simpro_pfb_w::text, '') = '' THEN tx_preco_fabrica  ELSE tx_simpro_pfb_w END ,
		CASE WHEN coalesce(tx_simpro_pmc_w::text, '') = '' THEN coalesce(tx_pmc,1)  ELSE tx_simpro_pmc_w END ,
		coalesce(qt_dia_fixo,0),
		dt_base_fixo,
		ie_tipo_preco,
		coalesce(tx_simpro_neg_pmc_w, coalesce(tx_pmc_neg,1)), --Se criar regra de ajuste para os indices do Simpro, ira mexer nos proximos 4 atributos, conforme o cusor c02
		coalesce(tx_simpro_pos_pmc_w, coalesce(tx_pmc_pos,1)),
		coalesce(tx_simpro_neg_pfb_w, coalesce(tx_pfb_neg,1)),
		coalesce(tx_simpro_pos_pfb_w, coalesce(tx_pfb_pos,1)),
		coalesce(ie_dividir_indice_pmc,'N'),
		coalesce(ie_dividir_indice_pfb,'N'),
		nr_sequencia
	from	convenio_simpro
	where	cd_convenio		= cd_convenio_p
	and	cd_categoria		= cd_categoria_p
	and	coalesce(ie_situacao,'A')	= 'A'
	and	coalesce(cd_estabelecimento, cd_estabelecimento_p)	= cd_estabelecimento_p
	and 	((coalesce(cd_grupo_material::text, '') = '') or (cd_grupo_material = cd_grupo_material_w))
	and 	((coalesce(cd_subgrupo_material::text, '') = '') or (cd_subgrupo_material = cd_subgrupo_material_w))
	and 	((coalesce(cd_classe_material::text, '') = '') or (cd_classe_material = cd_classe_material_w))
	and	dt_inicio_vigencia	= (
		SELECT max(a.dt_inicio_vigencia)
		from	convenio_simpro a
		where	a.cd_convenio         = cd_convenio_p
		and	a.cd_categoria        = cd_categoria_p
		and	coalesce(a.ie_situacao,'A')= 'A'
		and	coalesce(a.cd_estabelecimento, cd_estabelecimento_p)	= cd_estabelecimento_p
		and 	((coalesce(cd_grupo_material::text, '') = '') or (cd_grupo_material = cd_grupo_material_w))
		and 	((coalesce(cd_subgrupo_material::text, '') = '') or (cd_subgrupo_material = cd_subgrupo_material_w))
		and 	((coalesce(cd_classe_material::text, '') = '') or (cd_classe_material = cd_classe_material_w))
		and	dt_vigencia_p between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_inicio_vigencia) and ESTABLISHMENT_TIMEZONE_UTILS.endOfDay(coalesce(a.dt_final_vigencia, dt_vigencia_p)))
	order by	coalesce(cd_classe_material,0),
		coalesce(cd_subgrupo_material,0),
		coalesce(cd_grupo_material,0);
		
/*SO-2220426*/
		
C05 CURSOR FOR
	SELECT	coalesce(coalesce(tx_brasindice_pfb_w,tx_preco_fabrica),1),
		coalesce(coalesce(tx_brasindice_pmc_w,tx_brasindice_pmc),1),
		coalesce(tx_pmc_neg_w,tx_pmc_neg),
		coalesce(tx_pmc_pos_w,tx_pmc_pos),
		coalesce(qt_dia_fixo,0),
		coalesce(dt_base_fixo, dt_vigencia_p),
		coalesce(tx_brasindice_pmc_neg_w, tx_pfb_neg),
		coalesce(tx_brasindice_pmc_pos_w, tx_pfb_pos),
		coalesce(ie_data_fixa,'N'),
		coalesce(ie_restrito,'A'),
		coalesce(ie_solucao,'A'),
		nr_sequencia
	from	convenio_brasindice
	where	cd_convenio		= cd_convenio_p
	and	((coalesce(cd_categoria::text, '') = '')	or (cd_categoria = cd_categoria_p))
	and 	((coalesce(cd_grupo_material::text, '') = '') or (cd_grupo_material = cd_grupo_material_w))
	and 	((coalesce(cd_subgrupo_material::text, '') = '') or (cd_subgrupo_material = cd_subgrupo_material_w))
	and 	((coalesce(cd_classe_material::text, '') = '') or (cd_classe_material = cd_classe_material_w))
	and	((coalesce(nr_seq_estrutura::text, '') = '') or (consistir_se_mat_estrut_vig(nr_seq_estrutura,cd_material_p, dt_vigencia_p) = 'S'))		
	and 	((coalesce(ie_tipo_material::text, '') = '') or (ie_tipo_material = ie_tipo_material_w))
	and	((coalesce(ie_tipo_atendimento::text, '') = '') or (ie_tipo_atendimento = coalesce(ie_tipo_atendimento_p,0)))
	and	coalesce(cd_plano, coalesce(cd_plano_p, 0)) = coalesce(cd_plano_p, 0)
	and	cd_estabelecimento	= cd_estabelecimento_p
	and	coalesce(ie_situacao,'A')	= 'A'
	and	dt_inicio_vigencia	= (
		SELECT max(a.dt_inicio_vigencia)
		from	convenio_brasindice a
		where	a.cd_convenio		= cd_convenio_p
		and	((coalesce(cd_categoria::text, '') = '')	or (cd_categoria = cd_categoria_p))
		and 	((coalesce(cd_grupo_material::text, '') = '') or (cd_grupo_material = cd_grupo_material_w))
		and 	((coalesce(cd_subgrupo_material::text, '') = '') or (cd_subgrupo_material = cd_subgrupo_material_w))
		and 	((coalesce(cd_classe_material::text, '') = '') or (cd_classe_material = cd_classe_material_w))
		and	((coalesce(nr_seq_estrutura::text, '') = '') or (consistir_se_mat_estrut_vig(nr_seq_estrutura,cd_material_p, dt_vigencia_p) = 'S'))
		and 	((coalesce(a.ie_tipo_material::text, '') = '') or (a.ie_tipo_material = ie_tipo_material_w))
		and	((coalesce(a.ie_tipo_atendimento::text, '') = '') or (ie_tipo_atendimento = coalesce(ie_tipo_atendimento_p,0)))
		and	coalesce(cd_plano, coalesce(cd_plano_p, 0)) = coalesce(cd_plano_p, 0)
		and	cd_estabelecimento	= cd_estabelecimento_p
		and	coalesce(a.ie_situacao,'A')= 'A'
		and	dt_vigencia_p between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_inicio_vigencia) and ESTABLISHMENT_TIMEZONE_UTILS.endOfDay(coalesce(a.dt_final_vigencia, dt_vigencia_p)))
		--and	a.dt_inicio_vigencia <= dt_vigencia_p)
	order by coalesce(ie_prioridade,0),
		coalesce(cd_categoria,'0'),
		coalesce(nr_seq_estrutura,0),
		coalesce(cd_classe_material,0),
		coalesce(cd_subgrupo_material,0),
		coalesce(cd_grupo_material,0),
		coalesce(ie_tipo_material,'0'),
		coalesce(ie_tipo_atendimento,0),
		coalesce(dt_base_fixo, dt_vigencia_p),
		coalesce(cd_plano, 0);
		
/*SO-2220426*/

C06 CURSOR FOR
	SELECT	CASE WHEN coalesce(tx_simpro_pfb_w::text, '') = '' THEN tx_preco_fabrica  ELSE tx_simpro_pfb_w END ,
		CASE WHEN coalesce(tx_simpro_pmc_w::text, '') = '' THEN coalesce(tx_pmc,1)  ELSE tx_simpro_pmc_w END ,
		coalesce(qt_dia_fixo,0),
		dt_base_fixo,
		ie_tipo_preco,
		coalesce(tx_simpro_neg_pmc_w, coalesce(tx_pmc_neg,1)), --Se criar regra de ajuste para os indices do Simpro, ira mexer nos proximos 4 atributos, conforme o cusor c02
		coalesce(tx_simpro_pos_pmc_w, coalesce(tx_pmc_pos,1)),
		coalesce(tx_simpro_neg_pfb_w, coalesce(tx_pfb_neg,1)),
		coalesce(tx_simpro_pos_pfb_w, coalesce(tx_pfb_pos,1)),
		coalesce(ie_dividir_indice_pmc,'N'),
		coalesce(ie_dividir_indice_pfb,'N'),
		nr_sequencia
	from	convenio_simpro
	where	cd_convenio		= cd_convenio_p
	and	cd_categoria		= cd_categoria_p
	and	coalesce(ie_situacao,'A')	= 'A'
	and	coalesce(cd_estabelecimento, cd_estabelecimento_p)	= cd_estabelecimento_p
	and 	((coalesce(cd_grupo_material::text, '') = '') or (cd_grupo_material = cd_grupo_material_w))
	and 	((coalesce(cd_subgrupo_material::text, '') = '') or (cd_subgrupo_material = cd_subgrupo_material_w))
	and 	((coalesce(cd_classe_material::text, '') = '') or (cd_classe_material = cd_classe_material_w))
	and	dt_inicio_vigencia	= (
		SELECT max(a.dt_inicio_vigencia)
		from	convenio_simpro a
		where	a.cd_convenio         = cd_convenio_p
		and	a.cd_categoria        = cd_categoria_p
		and	coalesce(a.ie_situacao,'A')= 'A'
		and	coalesce(a.cd_estabelecimento, cd_estabelecimento_p)	= cd_estabelecimento_p
		and 	((coalesce(cd_grupo_material::text, '') = '') or (cd_grupo_material = cd_grupo_material_w))
		and 	((coalesce(cd_subgrupo_material::text, '') = '') or (cd_subgrupo_material = cd_subgrupo_material_w))
		and 	((coalesce(cd_classe_material::text, '') = '') or (cd_classe_material = cd_classe_material_w))
		and	dt_vigencia_p between ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_inicio_vigencia) and ESTABLISHMENT_TIMEZONE_UTILS.endOfDay(coalesce(a.dt_final_vigencia, dt_vigencia_p)))
	order by	coalesce(ie_prioridade,999),
		coalesce(cd_classe_material,0),
		coalesce(cd_subgrupo_material,0),
		coalesce(cd_grupo_material,0);
		
C07 CURSOR FOR
	SELECT	b.dt_cycle_start,
		b.dt_cycle_end,
		b.vl_minimum_benefit,
		b.vl_maximum_benefit,
		b.ie_action_flag
	from	prostheses_item_material a,
		prostheses_item_price b
	where	a.cd_billing = b.cd_billing
	and     a.ie_situacao = 'A'
	and     a.cd_material = cd_material_w
	--and	dt_vigencia_w between nvl(b.dt_cycle_start, dt_vigencia_w) and nvl(b.dt_cycle_end, dt_vigencia_w)
	order by b.dt_importation desc;
/*
Cursor C04 is
	select	nvl(b.cd_tab_mat_atualizacao,0),
		b.cd_tab_preco_mat
	from	convenio_preco_mat	b
	where	b.cd_convenio		= cd_convenio_p
	and	b.cd_categoria		= cd_categoria_p
	and	dt_vigencia_p between nvl(b.dt_inicio_vigencia, dt_vigencia_w)	and nvl(b.dt_final_vigencia, dt_vigencia_p)
	and	nvl(b.ie_situacao,'A')	= 'A';
*/
	
	
BEGIN

cd_material_w		:= cd_material_p;
nr_seq_marca_w		:= nr_seq_marca_p;
cd_material_estoque_w	:= Obter_Dados_Material(cd_material_w,'EST');

if (coalesce(ie_clinica_p,0) <> 0) then
	ie_clinica_w		:= ie_clinica_p;
end if;

select	coalesce(max(ie_valor_mat_estoque),'N'),
	coalesce(max(ie_regra_preco_tab_mat),'N'),
	coalesce(max(ie_tab_preco_mat_interna),'N'),
	coalesce(max(ie_data_mat_dias_int),'N'),
	coalesce(max(ie_prioridade_brasindice),'N'),
	coalesce(max(ie_prioridade_simpro),'N')
into STRICT	ie_valor_mat_estoque_w,
	ie_regra_preco_tab_mat_w,
	ie_tab_preco_mat_interna_w,
	ie_data_mat_dias_int_w,
	ie_prioridade_brasindice_w,
	ie_prioridade_simpro_w
from	parametro_faturamento
where	cd_estabelecimento	= cd_estabelecimento_p;

if (ie_prioridade_brasindice_w = 'R') then
	select 	coalesce(max(ie_prioridade_brasindice),'N')
	into STRICT	ie_prioridade_brasindice_w
	from 	convenio_estabelecimento
	where 	cd_convenio = cd_convenio_p
	and 	cd_estabelecimento = cd_estabelecimento_p;
end if;

if (ie_prioridade_simpro_w = 'R') then
	select 	coalesce(max(ie_prioridade_simpro),'N')
	into STRICT	ie_prioridade_simpro_w
	from 	convenio_estabelecimento
	where 	cd_convenio = cd_convenio_p
	and 	cd_estabelecimento = cd_estabelecimento_p;
end if;

<<Inicio>>

select 	max(coalesce(Grava_log_calculo_pck.get_ie_gravar_log,'N'))
into STRICT	ie_gravar_log_w
;

if (ie_gravar_log_w = 'S') and (coalesce(nr_sequencia_p,0) > 0) then
	select	coalesce(max(qt_material),1)
	into STRICT	qt_material_w
	from 	material_atend_paciente
	where	nr_sequencia = nr_sequencia_p;
	
	delete  from material_log_calculo
	where nr_seq_matpaci = nr_sequencia_p;

end if;

if (coalesce(nr_sequencia_p,0) > 0) or (coalesce(nr_atendimento_p,0) > 0) then

	if (coalesce(nr_sequencia_p,0) > 0) then
		select	coalesce(max(nr_atendimento),0),
				coalesce(max(nr_seq_lote_fornec),0),
				coalesce(max(nr_seq_regra_lanc),0)
		into STRICT	nr_atendimento_w,
				nr_seq_lote_fornec_w,
				nr_seq_regra_lanc_w
		from 	material_atend_paciente
		where	nr_sequencia = nr_sequencia_p;
	elsif (coalesce(nr_atendimento_p,0) > 0) then
		nr_atendimento_w := nr_atendimento_p;
	end if;
	
	if (nr_atendimento_w > 0) then
		select	CASE WHEN coalesce(nr_atend_original::text, '') = '' THEN  'N'  ELSE 'S' END ,
			dt_entrada,
			coalesce((obter_dados_categ_conv(nr_atendimento, 'OC'))::numeric ,0),
			coalesce((obter_dados_categ_conv(nr_atendimento, 'COB'))::numeric ,0),
			coalesce((obter_dados_categ_conv(nr_atendimento,'LDC'))::numeric ,0),
			coalesce(trunc(coalesce(dt_alta, clock_timestamp()) - dt_entrada),0),
			ie_clinica,
			obter_dados_categ_conv(nr_atendimento,'U')
		into STRICT	ie_atend_retorno_w,
			dt_entrada_w,
			nr_seq_origem_w,
			nr_seq_cobertura_w,
			nr_seq_lib_dieta_conv_w,
			qt_dias_internacao_w,
			ie_clinica_w,
			cd_usuario_convenio_w
		from	atendimento_paciente
		where	nr_atendimento = nr_atendimento_w;
	end if;
	
	if (coalesce(nr_seq_marca_w,0) = 0) and (coalesce(nr_seq_lote_fornec_w,0) > 0) then
		select	max(nr_seq_marca)
		into STRICT	nr_seq_marca_w
		from	material_lote_fornec
		where	nr_sequencia = nr_seq_lote_fornec_w;
	end if;
end if;

vl_maior_preco_w	:= 0;
vl_menor_preco_w	:= 0;
vl_mat_orig_taxa_ajuste := 0;
/*SO-2220426*/

dt_vigencia_w		:= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_vigencia_p);

cd_cgc_fornecedor_w	:= cd_cgc_fornecedor_p;

select	coalesce(max(ie_preco_custo), 'N')
into STRICT	ie_preco_custo_w
from	categoria_convenio
where	cd_convenio		= cd_convenio_p
and	cd_categoria		= cd_categoria_p;


select	max(ie_origem_preco),
	max(ie_precedencia_preco),
	coalesce(max(ie_fixar_vig_brasindice),'N'),
	coalesce(max(ie_fixar_vig_simpro),'N'),
	coalesce(max(ie_prostheses_price), 'N')		
into STRICT	ie_origem_conv_estab_w,
	ie_preced_conv_estab_w,
	ie_fixar_vig_brasindice_w,
	ie_fixar_vig_simpro_w,
	ie_prostheses_price_w
from	convenio_estabelecimento
where	cd_convenio		= cd_convenio_p
and	cd_estabelecimento	= cd_estabelecimento_p;

select	coalesce(max(ie_origem_preco),'BT'),
	coalesce(max(ie_precedencia_preco),'D')
into STRICT	ie_origem_conv_w,
	ie_preced_conv_w
from	convenio
where	cd_convenio	= cd_convenio_p;

if (ie_origem_conv_estab_w IS NOT NULL AND ie_origem_conv_estab_w::text <> '') then
	ie_origem_conv_w := ie_origem_conv_estab_w;
end if;

if (ie_preced_conv_estab_w IS NOT NULL AND ie_preced_conv_estab_w::text <> '') then
	ie_preced_conv_w := ie_preced_conv_estab_w;
end if;

if (ie_data_mat_dias_int_w = 'S') then
	qt_dias_internacao_w	:= coalesce(trunc(coalesce(dt_vigencia_p, clock_timestamp()) - dt_entrada_w),0);
end if;

SELECT * FROM obter_regra_ajuste_mat(
	cd_estabelecimento_p, cd_convenio_p, cd_categoria_p, cd_material_w, dt_vigencia_p, cd_tipo_acomodacao_p, ie_tipo_atendimento_p, cd_setor_atendimento_p, qt_idade_p, nr_sequencia_p, cd_plano_p, cd_proc_referencia_p, ie_origem_proc_p, null, dt_entrada_w, tx_ajuste_mat_w, vl_material_w, ie_preco_informado_w, ie_glosa_w, tx_brasindice_pfb_w, tx_brasindice_pmc_w, tx_pmc_neg_w, tx_pmc_pos_w, tx_afaturar_w, tx_simpro_pfb_w, tx_simpro_pmc_w, ie_origem_w, ie_precedencia_w, pr_glosa_w, vl_glosa_w, cd_tabela_preco_w, cd_motivo_exc_conta_w, nr_seq_regra_w, ie_autor_particular_w, cd_convenio_glosa_ww, cd_categoria_glosa_ww, ie_atend_retorno_w, tx_brasindice_pmc_neg_w, tx_brasindice_pmc_pos_w, ie_ignora_preco_venda_w, tx_simpro_pos_pfb_w, tx_simpro_neg_pfb_w, tx_simpro_pos_pmc_w, tx_simpro_neg_pmc_w, nr_seq_origem_w, nr_seq_cobertura_w, qt_dias_internacao_w, nr_seq_regra_lanc_w, nr_seq_lib_dieta_conv_w, ie_clinica_w, cd_usuario_convenio_w, nr_seq_classif_atend_p) INTO STRICT tx_ajuste_mat_w, vl_material_w, ie_preco_informado_w, ie_glosa_w, tx_brasindice_pfb_w, tx_brasindice_pmc_w, tx_pmc_neg_w, tx_pmc_pos_w, tx_afaturar_w, tx_simpro_pfb_w, tx_simpro_pmc_w, ie_origem_w, ie_precedencia_w, pr_glosa_w, vl_glosa_w, cd_tabela_preco_w, cd_motivo_exc_conta_w, nr_seq_regra_w, ie_autor_particular_w, cd_convenio_glosa_ww, cd_categoria_glosa_ww, tx_brasindice_pmc_neg_w, tx_brasindice_pmc_pos_w, ie_ignora_preco_venda_w, tx_simpro_pos_pfb_w, tx_simpro_neg_pfb_w, tx_simpro_pos_pmc_w, tx_simpro_neg_pmc_w;

cd_tabela_preco_ww		:= cd_tabela_preco_w;
vl_material_inf_w		:= vl_material_w;
ie_origem_w			:= coalesce(ie_origem_w,ie_origem_conv_w);
ie_precedencia_w		:= coalesce(ie_precedencia_w,ie_preced_conv_w);
ie_origem_preco_w 		:= 0;
ie_origem_preco_ww		:= 0;
cd_tab_preco_material_w		:= 0;
ie_origem_preco_maior_w		:= 0;
ie_origem_preco_menor_w := 0;

select 	obter_valor_dominio(1152,ie_origem_w),
	obter_valor_dominio(1153,ie_precedencia_w)
into STRICT	ds_origem_w,
	ds_precedencia_w
;

if (coalesce(nr_seq_regra_w,0) > 0) then
	CALL Gravar_log_calculo_mat(cd_material_w, nr_sequencia_p, cd_convenio_p, cd_categoria_p, wheb_mensagem_pck.get_texto(299773,'NR_SEQ_REGRA='||nr_seq_regra_w), ie_gravar_log_w);
	CALL Gravar_log_calculo_mat(cd_material_w, nr_sequencia_p, cd_convenio_p, cd_categoria_p, wheb_mensagem_pck.get_texto(299776,'DS_ORIGEM='||ds_origem_w||';DS_PRECEDENCIA='||ds_precedencia_w), ie_gravar_log_w);
else
	CALL Gravar_log_calculo_mat(cd_material_w, nr_sequencia_p, cd_convenio_p, cd_categoria_p, wheb_mensagem_pck.get_texto(299777), ie_gravar_log_w);
	CALL Gravar_log_calculo_mat(cd_material_w, nr_sequencia_p, cd_convenio_p, cd_categoria_p, wheb_mensagem_pck.get_texto(299778,'DS_ORIGEM='||ds_origem_w||';DS_PRECEDENCIA='||ds_precedencia_w), ie_gravar_log_w);
end if;

if (ie_preco_informado_w = 'N') then
	vl_material_w		:= 0;
else
	ie_precedencia_w	:= 'O';
end if;

if (ie_prostheses_price_w <> 'N') then

	open C07;
	loop
	fetch C07
	into	dt_cycle_start_w,
		dt_cycle_end_w,
		vl_minimum_benefit_w,
		vl_maximum_benefit_w,
		ie_action_flag_w;
	EXIT WHEN NOT FOUND; /* apply on C07 */	
		if	((ie_action_flag_w <> 'D') or (ie_action_flag_w = 'D' and dt_vigencia_w <= dt_cycle_end_w)) then
			ie_origem_preco_w	:= 7;
			dt_vigencia_w		:= dt_cycle_start_w;
			if (ie_prostheses_price_w = 'S') then			
				vl_material_w	:= vl_minimum_benefit_w;
			else
				vl_material_w	:= vl_maximum_benefit_w;
			end if;
		end if;
		exit;
	end loop;
	close C07;
end if;

select count(1)
into STRICT 	check_material_global_w
from 	preco_material_global LIMIT 1;

if (check_material_global_w > 0) then
	cd_material_glo_w := OBTER_MATERIAL_GLOBAL(cd_material_p, dt_vigencia_p, cd_estabelecimento_p, cd_setor_atendimento_p, cd_convenio_p, cd_categoria_p, cd_plano_p);
end if;

FOR i IN 1 .. 4 LOOP
	BEGIN
	vl_material_orig_w		:= 0;
	dt_vigencia_orig_w		:= clock_timestamp() - interval '2000 days';
	if	((vl_material_w = 0) or (ie_precedencia_w in ('D','P','V','M'))) and (substr(ie_origem_w,i,1) = 'T')	then
	     	begin
		ie_origem_ww	:= 'T';
		open c01;
		loop
		fetch c01 	into
       		vl_material_orig_w,
            		dt_vigencia_orig_w,
			cd_tab_preco_material_w,
			cd_moeda_w,	
			qt_conversao_w,
			ie_precedencia_c01,
			ie_origem_c01,
			cd_cgc_fornecedor_c01;
		EXIT WHEN NOT FOUND; /* apply on c01 */
       		vl_material_orig_w	:= vl_material_orig_w;
		
		if (coalesce(qt_conversao_w::text, '') = '') or (qt_conversao_w = 0) then
			qt_conversao_w := 1;
		end if;
		
		vl_material_orig_w	:= (vl_material_orig_w / qt_conversao_w);		
		
		end loop;
		close c01;
		
		if (ie_regra_preco_tab_mat_w = 'S') and (coalesce(cd_tabela_preco_w,0) > 0) then
	
			select	coalesce(max(a.vl_preco_venda),0),
				coalesce(max(a.dt_inicio_vigencia),clock_timestamp() - interval '2000 days'),
				coalesce(max(a.cd_tab_preco_mat),0),
				max(a.cd_moeda),
				coalesce(max(a.qt_conversao),1)
			into STRICT	vl_material_orig_w,
				dt_vigencia_orig_w,
				cd_tab_preco_material_w,
				cd_moeda_w,	
				qt_conversao_w
			from	preco_material 		a,
				tabela_preco_material b
			where	a.cd_tab_preco_mat 	= b.cd_tab_preco_mat
			and	coalesce(b.ie_situacao,'A') 	= 'A'
			and	coalesce(a.ie_situacao,'A') 	= 'A'
			and	a.cd_estabelecimento 	= cd_estabelecimento_p
			and	a.cd_material        	= cd_material_w
			and	coalesce(cd_tabela_preco_w, a.cd_tab_preco_mat) = a.cd_tab_preco_mat
			and	((coalesce(cd_cgc_fornecedor_w::text, '') = '') or (coalesce(a.cd_cgc_fornecedor,cd_cgc_fornecedor_w) = cd_cgc_fornecedor_w))
			and	a.dt_inicio_vigencia	<= dt_vigencia_p
			and	((coalesce(a.ie_preco_venda, 'S') = 'S') or (ie_ignora_preco_venda_w = 'S'))
			and	a.dt_inicio_vigencia = (SELECT 	max(a.dt_inicio_vigencia)
											from	preco_material 		a,
												tabela_preco_material b
											where	a.cd_estabelecimento 	= cd_estabelecimento_p
											and	a.cd_tab_preco_mat	= b.cd_tab_preco_mat
											and	coalesce(b.ie_situacao,'A') 	= 'A'
											and	coalesce(a.ie_situacao,'A') 	= 'A'
											and	a.cd_material        	= cd_material_w
											and	coalesce(cd_tabela_preco_w, a.cd_tab_preco_mat) = a.cd_tab_preco_mat
											and	((coalesce(cd_cgc_fornecedor_w::text, '') = '') or (coalesce(a.cd_cgc_fornecedor,cd_cgc_fornecedor_w) = cd_cgc_fornecedor_w))
											and	a.dt_inicio_vigencia	<= dt_vigencia_p
											and	coalesce(a.ie_preco_venda, 'S') = 'S')
			order by coalesce(a.cd_cgc_fornecedor,'0'),
					a.dt_inicio_vigencia,
					a.vl_preco_venda;
				
			if (coalesce(qt_conversao_w::text, '') = '') or (qt_conversao_w = 0) then
				qt_conversao_w := 1;
			end if;
				
			vl_material_orig_w	:= (vl_material_orig_w / qt_conversao_w);
		end if;
		

		select	coalesce(max(cd_moeda_padrao),0)
		into STRICT	cd_moeda_padrao_w
		from	parametro_compras
		where	cd_estabelecimento = cd_estabelecimento_p;

		if (cd_moeda_padrao_w <> 0) and (cd_moeda_w <> cd_moeda_padrao_w) then
			select	coalesce(max(vl_cotacao),1)
			into STRICT	vl_cotacao_w
			from 	cotacao_moeda
			where	cd_moeda	= cd_moeda_w
			and 	dt_cotacao	= (	SELECT	max(dt_cotacao)
							from 	cotacao_moeda
							where 	cd_moeda = cd_moeda_w
							and 	dt_cotacao <= dt_vigencia_p);
			vl_material_orig_w	:= vl_material_orig_w * vl_cotacao_w;
		end if;
		ie_origem_preco_ww		:= 2;
		
		ds_valor_w:= ds_valor_w || ' ' || wheb_mensagem_pck.get_texto(299782,'VL_MATERIAL_ORIG='||vl_material_orig_w);
		
		if (vl_maior_preco_w < vl_material_orig_w) then
			vl_maior_preco_w	:= vl_material_orig_w;
			vl_maior_preco_tab_w	:= vl_material_orig_w;
			ie_origem_preco_maior_w	:= ie_origem_preco_ww;
			dt_vigencia_maior_w	:= dt_vigencia_orig_w;
		end if;
		
		if	(vl_maior_preco_w < (vl_material_orig_w * tx_ajuste_mat_w)) and (ie_precedencia_w = 'V') then  /*  Coloquei esse if "tratamento" para considerar a taxa a Tabela Interna quando for Maior Vigencia entre as origens  OS 103054*/
			vl_maior_preco_w 	:= vl_material_orig_w * tx_ajuste_mat_w;
			vl_maior_preco_tab_w	:= vl_material_orig_w;
			ie_origem_preco_maior_w	:= ie_origem_preco_ww;
			dt_vigencia_maior_w	:= dt_vigencia_orig_w;
		end if;

		vl_mat_orig_taxa_ajuste := vl_material_orig_w * tx_ajuste_mat_w;

		if (vl_menor_preco_w = 0 or (vl_mat_orig_taxa_ajuste > 0 and vl_menor_preco_w > vl_mat_orig_taxa_ajuste) and (ie_precedencia_w = 'M')) then
			vl_menor_preco_w 	:= vl_mat_orig_taxa_ajuste;
			vl_menor_preco_tab_w	:= vl_material_orig_w;
			ie_origem_preco_menor_w	:= ie_origem_preco_ww;
			dt_vigencia_menor_w	:= dt_vigencia_orig_w;
		end if;

     		end;
	elsif	((vl_material_w = 0) or (ie_precedencia_w in ('D','P','V','M'))) and (substr(ie_origem_w,i,1) = 'A') and (length(ie_origem_w) > 1) then
	     	begin
		ie_origem_ww	:= 'A';
		
		if (ie_tab_preco_mat_interna_w = 'S') and (cd_tabela_preco_ww IS NOT NULL AND cd_tabela_preco_ww::text <> '') then
			cd_tabela_preco_ww:= null;
		end if;
		
		select 	max(cd_grupo_material),
			max(cd_classe_material),
			max(cd_subgrupo_material)			
		into STRICT	cd_grupo_material_ww,
			cd_classe_material_ww,
			cd_subgrupo_material_ww
		from 	estrutura_material_v
		where 	cd_material = cd_material_w;
		
		open c03;
		loop
		fetch c03 into
			vl_material_orig_w,
            		dt_vigencia_orig_w,
			cd_tab_preco_material_w,
			cd_moeda_w,	
			qt_conversao_w,
			tx_ajuste_mat_ww;
		EXIT WHEN NOT FOUND; /* apply on c03 */	
		
			if (coalesce(nr_seq_regra_w,0) > 0) then -- Colocado esse tratamento na OS 684774, para aplicar o indice da tabela adicional, porem respeitando a prioridade da regra de ajuste, caso tenha.
				
				select 	max(tx_ajuste)
				into STRICT	tx_ajuste_regra_w
				from 	regra_ajuste_material
				where 	nr_sequencia = nr_seq_regra_w;
				
				if (ie_tab_preco_mat_interna_w = 'S') and (coalesce(tx_ajuste_regra_w::text, '') = '') and (coalesce(tx_ajuste_mat_ww,0) > 0) then
					tx_ajuste_mat_w:= tx_ajuste_mat_ww;
				end if;
				
			end if;
			
			vl_material_orig_w	:= vl_material_orig_w;
			
			if (coalesce(qt_conversao_w::text, '') = '') or (qt_conversao_w = 0) then
				qt_conversao_w := 1;
			end if; 			
			
			vl_material_orig_w	:= (vl_material_orig_w / qt_conversao_w);		
		end loop;
		close c03;

		select	coalesce(max(cd_moeda_padrao),0)
		into STRICT	cd_moeda_padrao_w
		from	parametro_compras
		where	cd_estabelecimento = cd_estabelecimento_p;

		if (cd_moeda_padrao_w <> 0) and (cd_moeda_w <> cd_moeda_padrao_w) then
			select	coalesce(max(vl_cotacao),1)
			into STRICT	vl_cotacao_w
			from 	cotacao_moeda
			where	cd_moeda	= cd_moeda_w
			and 	dt_cotacao	= (	SELECT	max(dt_cotacao)
							from 	cotacao_moeda
							where 	cd_moeda = cd_moeda_w
							and 	dt_cotacao <= dt_vigencia_p);
			vl_material_orig_w	:= vl_material_orig_w * vl_cotacao_w;
		end if;
		ie_origem_preco_ww		:= 2;
		
		ds_valor_w:= ds_valor_w || ' ' || wheb_mensagem_pck.get_texto(299783,'VL_MATERIAL_ORIG='||vl_material_orig_w);

		if (vl_maior_preco_w < vl_material_orig_w) then
			vl_maior_preco_w	:= vl_material_orig_w;
			vl_maior_preco_tab_w	:= vl_material_orig_w;
			ie_origem_preco_maior_w	:= ie_origem_preco_ww;
			dt_vigencia_maior_w	:= dt_vigencia_orig_w;
		end if;
		
		if	(vl_maior_preco_w < (vl_material_orig_w * tx_ajuste_mat_w)) and (ie_precedencia_w = 'V') then  /*  Coloquei esse if "tratamento" para considerar a taxa a Tabela Interna quando for Maior Vigencia entre as origens  OS 103054*/
			vl_maior_preco_w 	:= vl_material_orig_w * tx_ajuste_mat_w;
			vl_maior_preco_tab_w	:= vl_material_orig_w;
			ie_origem_preco_maior_w	:= ie_origem_preco_ww;
			dt_vigencia_maior_w	:= dt_vigencia_orig_w;
		end if;

		vl_mat_orig_taxa_ajuste := vl_material_orig_w * tx_ajuste_mat_w;

		if (vl_menor_preco_w = 0 or (vl_mat_orig_taxa_ajuste > 0 and vl_menor_preco_w > vl_mat_orig_taxa_ajuste) and (ie_precedencia_w = 'M')) then
			vl_menor_preco_w 	:= vl_mat_orig_taxa_ajuste;
			vl_menor_preco_tab_w	:= vl_material_orig_w;
			ie_origem_preco_menor_w	:= ie_origem_preco_ww;
			dt_vigencia_menor_w	:= dt_vigencia_orig_w;
		end if;


		end;
	elsif	((vl_material_w = 0) or (ie_precedencia_w in ('D','P','V','M'))) and (substr(ie_origem_w,i,1) = 'B')	then
		begin
		ie_origem_ww	:= 'B';
		
		select 	max(cd_grupo_material),
			max(cd_classe_material),
			max(cd_subgrupo_material),
			max(ie_tipo_material)
		into STRICT	cd_grupo_material_w,
			cd_classe_material_w,
			cd_subgrupo_material_w,
			ie_tipo_material_w
		from 	estrutura_material_v
		where 	cd_material = cd_material_w;		

		
		if (ie_prioridade_brasindice_w = 'N') then
		
			open C02;
			loop
			fetch C02 into	
				tx_brasindice_pfb_w,
				tx_brasindice_pmc_w,
				tx_pmc_neg_w,
				tx_pmc_pos_w,
				qt_dia_fixo_w,
				dt_base_fixo_w,
				tx_pfb_neg_w,
				tx_pfb_pos_w,
				ie_data_fixa_w,
				nr_seq_conv_bras_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin			
				
				tx_brasindice_pfb_w	:=	tx_brasindice_pfb_w;
				tx_brasindice_pmc_w	:=	tx_brasindice_pmc_w;
				tx_pmc_neg_w		:=	tx_pmc_neg_w;
				tx_pmc_pos_w		:=	tx_pmc_pos_w;
				qt_dia_fixo_w		:=	qt_dia_fixo_w;
				dt_base_fixo_w		:=	dt_base_fixo_w;
				tx_pfb_neg_w		:=	tx_pfb_neg_w;
				tx_pfb_pos_w		:=	tx_pfb_pos_w;
				ie_data_fixa_w		:=	ie_data_fixa_w;
				nr_seq_conv_bras_w	:=	nr_seq_conv_bras_w;
				end;
			end loop;
			close C02;
			
			/*SO-2220426*/

			if (coalesce(nr_seq_conv_bras_w,0) > 0)  then

				tx_pmc_neg_w	:= coalesce(tx_pmc_neg_w, tx_brasindice_pmc_w);
				tx_pmc_pos_w	:= coalesce(tx_pmc_pos_w, tx_brasindice_pmc_w);
				dt_base_bras_w		:= dt_vigencia_p;
				if (qt_dia_fixo_w	<> 0) then
					begin
					dt_base_fixo_w		:= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_base_fixo_w);
					while(dt_base_fixo_w + qt_dia_fixo_w < dt_base_bras_w) loop
						dt_base_fixo_w	:= dt_base_fixo_w + qt_dia_fixo_w;
					end loop;
					dt_base_bras_w		:= dt_base_fixo_w;
					end;
				end if;
				
				if (qt_dia_fixo_w	= 0) and (ie_fixar_vig_brasindice_w = 'S') and (dt_base_fixo_w IS NOT NULL AND dt_base_fixo_w::text <> '') then
					begin
					dt_base_bras_w		:= dt_base_fixo_w;
					end;
				end if;

				SELECT * FROM obter_preco_brasindice(
					cd_estabelecimento_p, cd_convenio_p, cd_categoria_p, cd_material_w, dt_base_bras_w, tx_brasindice_pmc_w, tx_brasindice_pfb_w, tx_pfb_pos_w, tx_pfb_neg_w, tx_pmc_neg_w, tx_pmc_pos_w, ie_tipo_atendimento_p, nr_seq_marca_w, vl_material_orig_w, dt_vigencia_orig_w, cd_tiss_w, nr_seq_regra_w, ie_data_fixa_w, cd_plano_p, null, null, nr_seq_bras_preco_w, nr_seq_mat_bras_w, nr_seq_conv_bras_w) INTO STRICT vl_material_orig_w, dt_vigencia_orig_w, cd_tiss_w, nr_seq_bras_preco_w, nr_seq_mat_bras_w;
					
			end if;
				
		elsif (ie_prioridade_brasindice_w = 'S') then -- OS 445935
				
			/*SO-2220426*/

			open C05;
			loop
			fetch C05 into	
				tx_brasindice_pfb_w,
				tx_brasindice_pmc_w,
				tx_pmc_neg_w,
				tx_pmc_pos_w,
				qt_dia_fixo_w,
				dt_base_fixo_w,
				tx_pfb_neg_w,
				tx_pfb_pos_w,
				ie_data_fixa_w,
				ie_restrito_w,
				ie_solucao_w,
				nr_seq_conv_bras_w;
			EXIT WHEN NOT FOUND; /* apply on C05 */
				begin			
								
				tx_brasindice_pfb_w	:=	tx_brasindice_pfb_w;
				tx_brasindice_pmc_w	:=	tx_brasindice_pmc_w;
				tx_pmc_neg_w		:=	tx_pmc_neg_w;
				tx_pmc_pos_w		:=	tx_pmc_pos_w;
				qt_dia_fixo_w		:=	qt_dia_fixo_w;
				dt_base_fixo_w		:=	dt_base_fixo_w;
				tx_pfb_neg_w		:=	tx_pfb_neg_w;
				tx_pfb_pos_w		:=	tx_pfb_pos_w;
				ie_data_fixa_w		:=	ie_data_fixa_w;
				nr_seq_conv_bras_w	:=	nr_seq_conv_bras_w;
								
				tx_pmc_neg_w		:= coalesce(tx_pmc_neg_w, tx_brasindice_pmc_w);
				tx_pmc_pos_w		:= coalesce(tx_pmc_pos_w, tx_brasindice_pmc_w);
				dt_base_bras_w		:= dt_vigencia_p;
				if (qt_dia_fixo_w	<> 0) then
					begin
					dt_base_fixo_w		:= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_base_fixo_w);
					while(dt_base_fixo_w + qt_dia_fixo_w < dt_base_bras_w) loop
						dt_base_fixo_w	:= dt_base_fixo_w + qt_dia_fixo_w;
					end loop;
					dt_base_bras_w		:= dt_base_fixo_w;
					end;
				end if;
				
				if (qt_dia_fixo_w	= 0) and (ie_fixar_vig_brasindice_w = 'S') and (dt_base_fixo_w IS NOT NULL AND dt_base_fixo_w::text <> '') then
					begin
					dt_base_bras_w		:= dt_base_fixo_w;
					end;
				end if;

				SELECT * FROM obter_preco_brasindice(
					cd_estabelecimento_p, cd_convenio_p, cd_categoria_p, cd_material_w, dt_base_bras_w, tx_brasindice_pmc_w, tx_brasindice_pfb_w, tx_pfb_pos_w, tx_pfb_neg_w, tx_pmc_neg_w, tx_pmc_pos_w, ie_tipo_atendimento_p, nr_seq_marca_w, vl_material_orig_w, dt_vigencia_orig_w, cd_tiss_w, nr_seq_regra_w, ie_data_fixa_w, cd_plano_p, ie_restrito_w, ie_solucao_w, nr_seq_bras_preco_w, nr_seq_mat_bras_w, nr_seq_conv_bras_w) INTO STRICT vl_material_orig_w, dt_vigencia_orig_w, cd_tiss_w, nr_seq_bras_preco_w, nr_seq_mat_bras_w;
					
				if (vl_material_orig_w > 0) then
					exit;
				end if;
				
				end;
			end loop;
			close C05;			
			
		end if;
			
		ds_valor_w:= ds_valor_w || ' ' || wheb_mensagem_pck.get_texto(299785,'VL_MATERIAL_ORIG='||vl_material_orig_w);
		ds_valor_vig_w:= ds_valor_vig_w || ' ' || wheb_mensagem_pck.get_texto(299787,'VL_MATERIAL_ORIG='||dt_vigencia_orig_w);
		
		if (ie_gravar_log_w = 'S') then
		
			select	Obter_Dados_Brasindice2(cd_estabelecimento_p,
							cd_material_w,
							dt_base_bras_w,
							cd_convenio_p,
							'PREC',
							cd_categoria_p,
							ie_tipo_atendimento_p,
							nr_seq_marca_w)
			into STRICT	ds_tipo_preco_w
			;
			
		end if;

		ie_origem_preco_ww		:= 1;

		if (vl_maior_preco_w < vl_material_orig_w) then
			vl_maior_preco_w	:= vl_material_orig_w;
			vl_maior_preco_tab_w	:= vl_material_orig_w;
			ie_origem_preco_maior_w	:= ie_origem_preco_ww;
			dt_vigencia_maior_w	:= dt_vigencia_orig_w;
		end if;

		vl_mat_orig_taxa_ajuste := vl_material_orig_w;

		if (vl_menor_preco_w = 0 or (vl_mat_orig_taxa_ajuste > 0 and vl_menor_preco_w > vl_mat_orig_taxa_ajuste)) then
			vl_menor_preco_w	:= vl_mat_orig_taxa_ajuste;
			vl_menor_preco_tab_w	:= vl_mat_orig_taxa_ajuste;
			ie_origem_preco_menor_w	:= ie_origem_preco_ww;
			dt_vigencia_menor_w	:= dt_vigencia_orig_w;
		end if;

		end;
	elsif	((vl_material_w = 0) or (ie_precedencia_w in ('D','P','V','M'))) and (substr(ie_origem_w,i,1) = 'S')	then
		begin
		ie_origem_ww	:= 'S';
		ie_fora_vig_w	:= 'N';
		
		select 	max(cd_grupo_material),
			max(cd_classe_material),
			max(cd_subgrupo_material),
			max(ie_tipo_material)
		into STRICT	cd_grupo_material_w,
			cd_classe_material_w,
			cd_subgrupo_material_w,
			ie_tipo_material_w
		from 	estrutura_material_v
		where 	cd_material = cd_material_w;
		
		ie_entrou_simpro_w	:= 'N';
		
		if (ie_prioridade_simpro_w = 'N') then
		
			open C04;
			loop
			fetch C04 into	
				tx_simpro_pfb_w,
				tx_simpro_pmc_w,
				qt_dia_fixo_w,
				dt_base_fixo_w,
				ie_tipo_preco_conv_w,
				tx_simpro_pmc_neg_w,
				tx_simpro_pmc_pos_w,
				tx_simpro_pfb_neg_w,
				tx_simpro_pfb_pos_w,
				ie_dividir_indice_pmc_w,
				ie_dividir_indice_pfb_w,
				nr_seq_conv_simpro_w;
			EXIT WHEN NOT FOUND; /* apply on C04 */
				begin
				ie_entrou_simpro_w	:= 'S';
				tx_simpro_pfb_w		:= tx_simpro_pfb_w;
				tx_simpro_pmc_w		:= tx_simpro_pmc_w;
				qt_dia_fixo_w		:= qt_dia_fixo_w;
				dt_base_fixo_w		:= dt_base_fixo_w;
				ie_tipo_preco_conv_w	:= ie_tipo_preco_conv_w;
				tx_simpro_pmc_neg_w	:= tx_simpro_pmc_neg_w;
				tx_simpro_pmc_pos_w	:= tx_simpro_pmc_pos_w;
				tx_simpro_pfb_neg_w	:= tx_simpro_pfb_neg_w;
				tx_simpro_pfb_pos_w	:= tx_simpro_pfb_pos_w;
				ie_dividir_indice_pmc_w	:= ie_dividir_indice_pmc_w;
				ie_dividir_indice_pfb_w	:= ie_dividir_indice_pfb_w;
				nr_seq_conv_simpro_w	:= nr_seq_conv_simpro_w;
				end;
			end loop;
			close C04;
			
			if (ie_entrou_simpro_w = 'N') then
			
				tx_simpro_pfb_w		:= 1;
				tx_simpro_pmc_w		:= 1;
				qt_dia_fixo_w		:= 0;
				dt_base_fixo_w		:= clock_timestamp();
				ie_tipo_preco_conv_w	:= 'C';
				ie_fora_vig_w		:= 'S';
				tx_simpro_pmc_neg_w	:= 1;
				tx_simpro_pmc_pos_w	:= 1;
				tx_simpro_pfb_neg_w	:= 1;
				tx_simpro_pfb_pos_w	:= 1;
				ie_dividir_indice_pmc_w	:= 'N';
				ie_dividir_indice_pfb_w	:= 'N';
			
			end if;
			/*SO-2220426*/

			dt_base_bras_w		:= dt_vigencia_p;
			if (qt_dia_fixo_w	<> 0) then
				begin
				dt_base_fixo_w		:= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_base_fixo_w);
				while(dt_base_fixo_w + qt_dia_fixo_w < dt_base_bras_w) loop
					dt_base_fixo_w	:= dt_base_fixo_w + qt_dia_fixo_w;
				end loop;
				dt_base_bras_w		:= dt_base_fixo_w;
				end;
			end if;
				
			if (qt_dia_fixo_w	= 0) and (ie_fixar_vig_simpro_w = 'S') and (dt_base_fixo_w IS NOT NULL AND dt_base_fixo_w::text <> '') then
				begin
				dt_base_bras_w		:= dt_base_fixo_w;
				end;
			end if;	
			
			if (ie_fora_vig_w = 'N') then
				SELECT * FROM calcular_preco_simpro(
					cd_estabelecimento_p, cd_convenio_p, cd_material_w, tx_simpro_pfb_w, tx_simpro_pmc_w, dt_base_bras_w, ie_tipo_preco_conv_w, vl_material_orig_w, dt_vigencia_orig_w, tx_simpro_pmc_neg_w, tx_simpro_pmc_pos_w, tx_simpro_pfb_neg_w, tx_simpro_pfb_pos_w, ie_dividir_indice_pmc_w, ie_dividir_indice_pfb_w, nr_seq_marca_w, nr_seq_mat_simpro_w, nr_seq_simpro_preco_w, nr_seq_conv_simpro_w) INTO STRICT vl_material_orig_w, dt_vigencia_orig_w, nr_seq_mat_simpro_w, nr_seq_simpro_preco_w;
			end if;
			
		elsif (ie_prioridade_simpro_w = 'S') then
		
			open C06;
			loop
			fetch C06 into	
				tx_simpro_pfb_w,
				tx_simpro_pmc_w,
				qt_dia_fixo_w,
				dt_base_fixo_w,
				ie_tipo_preco_conv_w,
				tx_simpro_pmc_neg_w,
				tx_simpro_pmc_pos_w,
				tx_simpro_pfb_neg_w,
				tx_simpro_pfb_pos_w,
				ie_dividir_indice_pmc_w,
				ie_dividir_indice_pfb_w,
				nr_seq_conv_simpro_w;
			EXIT WHEN NOT FOUND; /* apply on C06 */
				begin
				/*SO-2220426*/

				dt_base_bras_w		:= dt_vigencia_p;
				if (qt_dia_fixo_w	<> 0) then
					begin
					dt_base_fixo_w		:= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_base_fixo_w);
					while(dt_base_fixo_w + qt_dia_fixo_w < dt_base_bras_w) loop
						dt_base_fixo_w	:= dt_base_fixo_w + qt_dia_fixo_w;
					end loop;
					dt_base_bras_w		:= dt_base_fixo_w;
					end;
				end if;
					
				if (qt_dia_fixo_w	= 0) and (ie_fixar_vig_simpro_w = 'S') and (dt_base_fixo_w IS NOT NULL AND dt_base_fixo_w::text <> '') then
					begin
					dt_base_bras_w		:= dt_base_fixo_w;
					end;
				end if;	
				
				if (ie_fora_vig_w = 'N') then
					SELECT * FROM calcular_preco_simpro(
						cd_estabelecimento_p, cd_convenio_p, cd_material_w, tx_simpro_pfb_w, tx_simpro_pmc_w, dt_base_bras_w, ie_tipo_preco_conv_w, vl_material_orig_w, dt_vigencia_orig_w, tx_simpro_pmc_neg_w, tx_simpro_pmc_pos_w, tx_simpro_pfb_neg_w, tx_simpro_pfb_pos_w, ie_dividir_indice_pmc_w, ie_dividir_indice_pfb_w, nr_seq_marca_w, nr_seq_mat_simpro_w, nr_seq_simpro_preco_w, nr_seq_conv_simpro_w) INTO STRICT vl_material_orig_w, dt_vigencia_orig_w, nr_seq_mat_simpro_w, nr_seq_simpro_preco_w;
				end if;

				if (vl_material_orig_w > 0) then
					exit;
				end if;
				
				end;
			end loop;
			close C06;
		
		end if;
		
		ie_origem_preco_ww		:= 4;

		ds_valor_w:= ds_valor_w || ' ' || wheb_mensagem_pck.get_texto(299790,'VL_MATERIAL_ORIG='||vl_material_orig_w);
		ds_valor_vig_w:= ds_valor_vig_w || ' ' || wheb_mensagem_pck.get_texto(299792,'VL_MATERIAL_ORIG='||dt_vigencia_orig_w);
		
		if (vl_maior_preco_w < vl_material_orig_w) then
			vl_maior_preco_w	:= vl_material_orig_w;
			vl_maior_preco_tab_w	:= vl_material_orig_w;
			ie_origem_preco_maior_w	:= ie_origem_preco_ww;
			dt_vigencia_maior_w	:= dt_vigencia_orig_w;
		end if;

		vl_mat_orig_taxa_ajuste := vl_material_orig_w;

		if (vl_menor_preco_w = 0 or (vl_mat_orig_taxa_ajuste > 0 and vl_menor_preco_w > vl_mat_orig_taxa_ajuste)) then
			vl_menor_preco_w	:= vl_mat_orig_taxa_ajuste;
			vl_menor_preco_tab_w	:= vl_mat_orig_taxa_ajuste;
			ie_origem_preco_menor_w	:= ie_origem_preco_ww;
			dt_vigencia_menor_w	:= dt_vigencia_orig_w;
		end if;

		end;
	elsif	((vl_material_w = 0) or (ie_precedencia_w in ('D','P','V','M'))) and (substr(ie_origem_w,i,1) = 'C')	then
		
		select	coalesce(max(qt_conv_estoque_consumo),1)
		into STRICT	qt_conv_estoque_consumo_w
		from 	material
		where 	cd_material = cd_material_w;
		
		vl_material_orig_w:= obter_custo_medio_material(cd_estabelecimento_p, dt_vigencia_p, cd_material_w) / qt_conv_estoque_consumo_w;
		
		ie_origem_preco_ww:= 5;
		ds_valor_w:= ds_valor_w || ' ' || wheb_mensagem_pck.get_texto(299795,'VL_MATERIAL_ORIG='||vl_material_orig_w);
		
	elsif	((vl_material_w = 0) or (ie_precedencia_w in ('D','P','V','M'))) and (substr(ie_origem_w,i,1) = 'M')	then
		
		select	coalesce(max(qt_conv_estoque_consumo),1)
		into STRICT	qt_conv_estoque_consumo_w
		from 	material
		where 	cd_material = cd_material_w;
		
		vl_mat_aux1_w:= dividir(obter_custo_medio_material(cd_estabelecimento_p, dt_vigencia_p, cd_material_w) , qt_conv_estoque_consumo_w);
		vl_mat_aux2_w:= dividir(obter_custo_medio_material(cd_estabelecimento_p, dt_vigencia_p - 30, cd_material_w) , qt_conv_estoque_consumo_w);
		vl_mat_aux3_w:= dividir(obter_custo_medio_material(cd_estabelecimento_p, dt_vigencia_p - 60, cd_material_w) , qt_conv_estoque_consumo_w);
		
		vl_material_orig_w:= dividir((vl_mat_aux1_w + vl_mat_aux2_w + vl_mat_aux3_w),3);		
		
		ie_origem_preco_ww:= 5;
		ds_valor_w:= ds_valor_w || ' ' || wheb_mensagem_pck.get_texto(299798,'VL_MATERIAL_ORIG='||vl_material_orig_w);
		
	elsif	((vl_material_w = 0) or (ie_precedencia_w in ('D','P','V','M'))) and (substr(ie_origem_w,i,1) = 'O')	then
		
		vl_material_orig_w := OBTER_VL_MAT_AUTOR(coalesce(nr_sequencia_p,0));
		
		ie_origem_preco_ww := 6;
		ds_valor_w := ds_valor_w || ' ' || wheb_mensagem_pck.get_texto(299816,'VL_MATERIAL_ORIG='||vl_material_orig_w);
		
	elsif	((vl_material_w = 0) or (ie_precedencia_w in ('D','P','V','M'))) and (substr(ie_origem_w,i,1) = 'A')	and (length(ie_origem_w) = 1) then
		vl_material_orig_w := obter_preco_conv_mat_fornec(	cd_convenio_p, cd_cgc_fornecedor_p, cd_material_w, dt_vigencia_p, vl_material_orig_w);				
						
		ds_valor_w:= ds_valor_w || ' ' || wheb_mensagem_pck.get_texto(299821,'VL_MATERIAL_ORIG='||vl_material_orig_w);
		ds_valor_w:= ds_valor_w || ' ' || wheb_mensagem_pck.get_texto(299822,'CD_CONVENIO='||cd_convenio_p||';CD_CGC_FORNECEDOR='||cd_cgc_fornecedor_p||';CD_MATERIAL='||cd_material_w||';DT_VIGENCIA='||dt_vigencia_p);
		
	end if;

	if (vl_material_orig_w > 0) and
		((ie_precedencia_w = 'O') or (vl_material_w = 0) or (dt_vigencia_orig_w	> dt_vigencia_w)) then
		begin
		dt_vigencia_w		:= dt_vigencia_orig_w;
		vl_material_w		:= vl_material_orig_w;
		ie_origem_preco_w	:= ie_origem_preco_ww;
		end;
	end if;

	END;
END LOOP;

CALL Gravar_log_calculo_mat(cd_material_w, nr_sequencia_p, cd_convenio_p, cd_categoria_p, '3 -' || ds_valor_w, ie_gravar_log_w);
if (ds_valor_vig_w IS NOT NULL AND ds_valor_vig_w::text <> '') then
	CALL Gravar_log_calculo_mat(cd_material_w, nr_sequencia_p, cd_convenio_p, cd_categoria_p, '3.1 -' || ds_valor_vig_w, ie_gravar_log_w);
end if;

if (ds_tipo_preco_w IS NOT NULL AND ds_tipo_preco_w::text <> '') then
	CALL Gravar_log_calculo_mat(cd_material_w, nr_sequencia_p, cd_convenio_p, cd_categoria_p, wheb_mensagem_pck.get_texto(299832,'DS_TIPO_PRECO='||ds_tipo_preco_w), ie_gravar_log_w);
end if;

--Retirado, porque nao estava aplicando a taxa de ajuste da regra sobre a tabela adicional
/*if	(nvl(tx_ajuste_mat_ww,0) > 0) and
	(ie_origem_ww =  'A') then
	tx_ajuste_mat_w:= tx_ajuste_mat_ww;
end if;*/
if 	((ie_origem_preco_maior_w = 2 or ie_origem_preco_menor_w = 2) and (ie_precedencia_w in ('V', 'M'))) then  /* Fabricio em 02/08/2008  OS 103054*/
	tx_ajuste_mat_w	:= tx_ajuste_mat_w;
elsif (ie_origem_preco_w <> 2) then
	tx_ajuste_mat_w		:= 1;
end if;

if (vl_material_w > 0) then
	begin
	
	if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') and (ie_origem_ww <> 'A') and (ie_gravar_log_w = 'S') then
		vl_indice_w:= Obter_indice_preco_material_2(nr_sequencia_p);
		if (vl_indice_w IS NOT NULL AND vl_indice_w::text <> '') then
			CALL Gravar_log_calculo_mat(cd_material_w, nr_sequencia_p, cd_convenio_p, cd_categoria_p, wheb_mensagem_pck.get_texto(299838,'VL_INDICE='||vl_indice_w), ie_gravar_log_w);
		end if;
	end if;
	
	CALL Gravar_log_calculo_mat(cd_material_w, nr_sequencia_p, cd_convenio_p, cd_categoria_p, wheb_mensagem_pck.get_texto(299842,'TX_AJUSTE_MAT='||tx_ajuste_mat_w), ie_gravar_log_w);
	
	if (ie_glosa_w	= 'I') then
	
		if (ie_origem_preco_w	= 1) then
			ie_origem_ww	:= 'B';
		elsif (ie_origem_preco_w	= 2) and (ie_origem_ww <> 'A') then
			ie_origem_ww	:= 'T';
		elsif (ie_origem_preco_w	= 4) then
			ie_origem_ww	:= 'S';
		elsif (ie_origem_preco_w	= 5) then
			ie_origem_ww	:= 'C';
		end if;
		tx_ajuste_mat_orig_w 	:= tx_ajuste_mat_w;
		tx_ajuste_periodo_w := obter_ajuste_mat_periodo(nr_seq_regra_w, vl_material_w, tx_ajuste_mat_w, ie_origem_ww, tx_ajuste_periodo_w);
		tx_ajuste_mat_w		:= tx_ajuste_periodo_w;
		CALL Gravar_log_calculo_mat(cd_material_w, nr_sequencia_p, cd_convenio_p, cd_categoria_p, wheb_mensagem_pck.get_texto(299833,'TX_AJUSTE_MAT='||tx_ajuste_mat_w), ie_gravar_log_w);
	end if;
	

	-- Edgar 31/07/2007, OS 61450, inclui selecat abaixo
	select	max(nr_dec_unitario),
		max(ie_arredondamento)
	into STRICT	nr_dec_unitario_w,
		ie_tipo_rounded_w
	from	convenio_estabelecimento
	where	cd_convenio		= cd_convenio_p
	and	cd_estabelecimento	= cd_estabelecimento_p;
	
	
	-- Conforme 'Regra de arredondamento',  Fabricio em 15/06/2009 OS 133672
	if (ie_tipo_rounded_w = 'R') then
	
		select 	obter_regra_arredondamento(cd_convenio_p, cd_categoria_p, cd_material_p, null, cd_estabelecimento_p, dt_vigencia_p, 'M', 1),
			obter_regra_arredondamento(cd_convenio_p, cd_categoria_p, cd_material_p, null, cd_estabelecimento_p, dt_vigencia_p, 'M', 2)
		into STRICT	ie_tipo_rounded_w,
			nr_dec_unitario_w
		;
		
	end if;
	

	if (coalesce(nr_dec_unitario_w::text, '') = '') then
		/* obter parametros de arredondamento */

		select	coalesce(max(coalesce(vl_parametro, vl_parametro_padrao)),4)
		into STRICT 	nr_dec_unitario_w
		from 	funcao_parametro
		where 	cd_funcao = 81
		and 	nr_sequencia = 1;
	end if;

	if (coalesce(ie_tipo_rounded_w::text, '') = '') then
		select	coalesce(max(coalesce(vl_parametro, vl_parametro_padrao)), 'P')
		into STRICT	ie_tipo_rounded_w
		from 	funcao_parametro
		where 	cd_funcao = 81
		and 	nr_sequencia = 3;
	end if;

	vl_material_orig_w:=  vl_material_w;
	
	vl_material_w := (vl_material_w * tx_ajuste_mat_w * tx_afaturar_w);	
	vl_material_w := arredondamento(vl_material_w, nr_dec_unitario_w, ie_tipo_rounded_w);
	
	if (ie_precedencia_w <> 'V' and ie_precedencia_w <> 'M') then
		CALL Gravar_log_calculo_mat(cd_material_w, nr_sequencia_p, cd_convenio_p, cd_categoria_p, wheb_mensagem_pck.get_texto(299846,'VL_MATERIAL_ORIG='||vl_material_orig_w||';TX_AJUSTE_MAT='||tx_ajuste_mat_w||';VL_MATERIAL='||vl_material_w), ie_gravar_log_w);
	end if;

	
	if (ie_glosa_w		= 'I') and (ie_precedencia_w 	in ('V','M')) and (tx_ajuste_mat_w	<> tx_ajuste_mat_orig_w) then /*Felipe Martini em 04/09/2008 OS106608*/
		if (ie_precedencia_w = 'M') then
		      vl_menor_preco_w := (vl_menor_preco_w * tx_afaturar_w);
		      vl_menor_preco_w := arredondamento(vl_menor_preco_w, nr_dec_unitario_w, ie_tipo_rounded_w);
		      CALL Gravar_log_calculo_mat(cd_material_w, nr_sequencia_p, cd_convenio_p, cd_categoria_p, wheb_mensagem_pck.get_texto(299846,'VL_MATERIAL_ORIG='||vl_menor_preco_tab_w||';TX_AJUSTE_MAT='||tx_ajuste_mat_w||';VL_MATERIAL='||vl_menor_preco_w), ie_gravar_log_w);
		else
		      vl_maior_preco_w := (vl_maior_preco_w * tx_afaturar_w);
		      vl_maior_preco_w := arredondamento(vl_maior_preco_w, nr_dec_unitario_w, ie_tipo_rounded_w);
		      CALL Gravar_log_calculo_mat(cd_material_w, nr_sequencia_p, cd_convenio_p, cd_categoria_p, wheb_mensagem_pck.get_texto(299846,'VL_MATERIAL_ORIG='||vl_maior_preco_tab_w||';TX_AJUSTE_MAT='||tx_ajuste_mat_w||';VL_MATERIAL='||vl_maior_preco_w), ie_gravar_log_w);
		end if;

	elsif (ie_precedencia_w 	in ('V','M')) and (tx_ajuste_mat_w	<> tx_ajuste_mat_orig_w) then

		if (ie_precedencia_w = 'M') then
		      vl_menor_preco_w := (vl_menor_preco_w * tx_afaturar_w);
		      vl_menor_preco_w := arredondamento(vl_menor_preco_w, nr_dec_unitario_w, ie_tipo_rounded_w);
		      CALL Gravar_log_calculo_mat(cd_material_w, nr_sequencia_p, cd_convenio_p, cd_categoria_p, wheb_mensagem_pck.get_texto(299846,'VL_MATERIAL_ORIG='||vl_menor_preco_tab_w||';TX_AJUSTE_MAT='||tx_ajuste_mat_w||';VL_MATERIAL='||vl_menor_preco_w), ie_gravar_log_w);
		else
		      vl_maior_preco_w := (vl_maior_preco_w * tx_afaturar_w);
		      vl_maior_preco_w := arredondamento(vl_maior_preco_w, nr_dec_unitario_w, ie_tipo_rounded_w);
		      CALL Gravar_log_calculo_mat(cd_material_w, nr_sequencia_p, cd_convenio_p, cd_categoria_p, wheb_mensagem_pck.get_texto(299846,'VL_MATERIAL_ORIG='||vl_maior_preco_tab_w||';TX_AJUSTE_MAT='||tx_ajuste_mat_w||';VL_MATERIAL='||vl_maior_preco_w), ie_gravar_log_w);
		end if;

	elsif (ie_precedencia_w 	in ('V','M')) then
		if (ie_precedencia_w = 'M') then
			vl_menor_preco_w := arredondamento(vl_menor_preco_w, nr_dec_unitario_w, ie_tipo_rounded_w);
		else
			vl_maior_preco_w := arredondamento(vl_maior_preco_w, nr_dec_unitario_w, ie_tipo_rounded_w);
		end if;
	end if;
	
	end;
end if;

if (ie_preco_informado_w = 'S') then
	ie_origem_preco_p	:= 3;
	vl_material_p		:= vl_material_inf_w;
	vl_material_tab_w	:= vl_material_inf_w;
else
	begin	

	if (ie_precedencia_w = 'V') then
		vl_material_w		:= vl_maior_preco_w;
		vl_material_p		:= vl_maior_preco_w;
		vl_material_tab_w	:= vl_maior_preco_tab_w;
		ie_origem_preco_p	:= ie_origem_preco_maior_w;
		dt_ult_vigencia_p	:= dt_vigencia_maior_w;
	elsif (ie_precedencia_w = 'M') then
		vl_material_w		:= vl_menor_preco_w;
		vl_material_p		:= vl_menor_preco_w;
		vl_material_tab_w	:= vl_menor_preco_tab_w;
		ie_origem_preco_p	:= ie_origem_preco_menor_w;
		dt_ult_vigencia_p	:= dt_vigencia_menor_w;
	else
		ie_origem_preco_p	:= ie_origem_preco_w;
		vl_material_p		:= vl_material_w;
		vl_material_tab_w	:= vl_material_orig_w;
		dt_ult_vigencia_p	:= dt_vigencia_w;
	end if;

	cd_tab_preco_mat_p	:= 0;
	if (ie_origem_preco_p = 2) then
		cd_tab_preco_mat_p	:= cd_tab_preco_material_w;
	end if;
	end;
end if;

/* Valor original */

begin
	select	substr(value,1,64)
	into STRICT	ds_nls_territory_w
	from	v$nls_parameters
	where	parameter = 'NLS_TERRITORY';
exception
when others then
	ds_nls_territory_w:=null;	
end;

if (philips_param_pck.get_cd_pais = 2) or (upper(ds_nls_territory_w) = 'MEXICO')then
	SELECT 	MAX(coalesce(Grava_log_preco_pck.get_ie_gravar_log,'N'))
	INTO STRICT	ie_gravar_log_w
	;
	
	if (ie_gravar_log_w = 'S') then
		begin
			nm_usuario_logado_w := wheb_usuario_pck.get_nm_usuario;
		exception
			when others then
			nm_usuario_logado_w := '';
		end;
	
		CALL gravar_matpaci_log_preco(nr_sequencia_p,'ORIG',
					tx_ajuste_mat_w,
					vl_material_tab_w, -- vl_unitario com 4 casas decimais
					vl_material_tab_w,
					ie_preco_informado_w,nm_usuario_logado_w,'S');
	end if;
end if;

CALL Gravar_log_calculo_mat(cd_material_w, nr_sequencia_p, cd_convenio_p, cd_categoria_p, wheb_mensagem_pck.get_texto(299850,'VL_MATERIAL='||vl_material_w||';QT_MATERIAL='||qt_material_w) || vl_material_w * qt_material_w, ie_gravar_log_w);

if (ie_preco_custo_w	= 'S') and (coalesce(nr_seq_regra_w, 0) = 0) then
	begin

	select	max(cd_tabela_venda),
		max(dt_referencia),
		coalesce(max(ds_criterio_aloc_mat),'ERT')
	into STRICT	cd_tabela_custo_w,
		dt_ref_custo_w,
		ds_criterio_w
	from	parametro_custo a
	where	cd_estabelecimento 	= cd_estabelecimento_p;


	SELECT * FROM Obter_Custo_material(cd_estabelecimento_p, cd_material_w, cd_estabelecimento_p, cd_tabela_custo_w, cd_setor_Atendimento_p, cd_convenio_p, vl_material_w, 'TER', null, dt_ref_custo_w, ie_apuracao_custo_w, vl_custo_unitario_w, pr_imposto_w, null, null, null, 'N', null, 0, 0, null) INTO STRICT ie_apuracao_custo_w, vl_custo_unitario_w, pr_imposto_w;

	vl_custo_w	:=	vl_custo_unitario_w;

	if (coalesce(pr_imposto_w, 0) > 0) then
		vl_custo_w	:= vl_custo_w  + (vl_custo_w * pr_imposto_w);
	end if;

	vl_material_p		:= vl_custo_w;
	cd_tab_preco_mat_p	:= null;
	ie_preco_informado_w	:= 'N';

	end;
end if;

if (ie_valor_mat_estoque_w		='S') and (vl_material_p			= 0) and (cd_material_w <> cd_material_estoque_w) then
	ie_valor_mat_estoque_w	:= 'N';
	cd_material_w		:= cd_material_estoque_w;
	goto	Inicio;
end if;

if (nr_seq_conv_bras_w IS NOT NULL AND nr_seq_conv_bras_w::text <> '') and (nr_seq_bras_preco_w IS NOT NULL AND nr_seq_bras_preco_w::text <> '') and (nr_seq_mat_bras_w IS NOT NULL AND nr_seq_mat_bras_w::text <> '') then
	CALL Gravar_log_calculo_mat(cd_material_w, nr_sequencia_p, cd_convenio_p, cd_categoria_p,
		wheb_mensagem_pck.get_texto(299857,'NR_SEQ_CONV_BRAS='||nr_seq_conv_bras_w), ie_gravar_log_w);
	CALL Gravar_log_calculo_mat(cd_material_w, nr_sequencia_p, cd_convenio_p, cd_categoria_p,
		wheb_mensagem_pck.get_texto(299858,'NR_SEQ_BRAS_PRECO='||nr_seq_bras_preco_w), ie_gravar_log_w);
	CALL Gravar_log_calculo_mat(cd_material_w, nr_sequencia_p, cd_convenio_p, cd_categoria_p,
		wheb_mensagem_pck.get_texto(299859,'NR_SEQ_MAT_BRAS='||nr_seq_mat_bras_w), ie_gravar_log_w);
end if;

if (nr_seq_conv_simpro_w IS NOT NULL AND nr_seq_conv_simpro_w::text <> '')  and (nr_seq_simpro_preco_w IS NOT NULL AND nr_seq_simpro_preco_w::text <> '') and (nr_seq_mat_simpro_w IS NOT NULL AND nr_seq_mat_simpro_w::text <> '') then
	CALL Gravar_log_calculo_mat(cd_material_w, nr_sequencia_p, cd_convenio_p, cd_categoria_p,
		wheb_mensagem_pck.get_texto(299860,'NR_SEQ_CONV_SIMPRO='||nr_seq_conv_simpro_w), ie_gravar_log_w);
	CALL Gravar_log_calculo_mat(cd_material_w, nr_sequencia_p, cd_convenio_p, cd_categoria_p,
		wheb_mensagem_pck.get_texto(299861,'NR_SEQ_SIMPRO_PRECO='||nr_seq_simpro_preco_w), ie_gravar_log_w);
	CALL Gravar_log_calculo_mat(cd_material_w, nr_sequencia_p, cd_convenio_p, cd_categoria_p,
		wheb_mensagem_pck.get_texto(299862,'NR_SEQ_MAT_SIMPRO='||nr_seq_mat_simpro_w), ie_gravar_log_w);
end if;

nr_seq_bras_preco_p	:= nr_seq_bras_preco_w;
nr_seq_mat_bras_p	:= nr_seq_mat_bras_w;
nr_seq_conv_bras_p	:= nr_seq_conv_bras_w;
nr_seq_conv_simpro_p	:= nr_seq_conv_simpro_w;
nr_seq_mat_simpro_p	:= nr_seq_mat_simpro_w;
nr_seq_simpro_preco_p	:= nr_seq_simpro_preco_w;
nr_seq_ajuste_mat_p	:= nr_seq_regra_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE define_preco_material (cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_categoria_p text, dt_vigencia_p timestamp, cd_material_p bigint, cd_tipo_acomodacao_p bigint, ie_tipo_atendimento_p bigint, cd_setor_atendimento_p bigint, cd_cgc_fornecedor_p text, qt_idade_p bigint, nr_sequencia_p bigint, cd_plano_p text, cd_proc_referencia_p bigint, ie_origem_proc_p bigint, nr_seq_marca_p bigint, ie_clinica_p bigint, nr_seq_classif_atend_p bigint, nr_atendimento_p bigint, ie_vago_4_p text, vl_material_p INOUT bigint, dt_ult_vigencia_p INOUT timestamp, cd_tab_preco_mat_p INOUT bigint, ie_origem_preco_p INOUT bigint, nr_seq_bras_preco_p INOUT bigint, nr_seq_mat_bras_p INOUT bigint, nr_seq_conv_bras_p INOUT bigint, nr_seq_conv_simpro_p INOUT bigint, nr_seq_mat_simpro_p INOUT bigint, nr_seq_simpro_preco_p INOUT bigint, nr_seq_ajuste_mat_p INOUT bigint) FROM PUBLIC;

