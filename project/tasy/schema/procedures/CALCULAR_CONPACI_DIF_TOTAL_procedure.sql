-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_conpaci_dif_total (nr_interno_conta_p bigint, nr_seq_desconto_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
vl_liquido_w 		double precision;
vl_conta_w		double precision;
vl_diferenca_w 		double precision;
vl_desconto_w		double precision;
vl_total_desc_proc_w	double precision;
vl_total_desc_mat_w	double precision;
vl_procedimento_w	double precision;
vl_medico_w		double precision;
vl_custo_operacional_w	double precision;
vl_material_w		double precision;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;

vl_item_w			double precision;
nr_seq_item_w		bigint;
tp_item_w		varchar(01);

vl_proc_w		double precision;
vl_mat_w			double precision;

qt_proc_desc_w		bigint;
nr_proc_desc_w		bigint;

vl_pacote_mat_w		double precision;
vl_pacote_proc_w		double precision;
vl_desc_original_w		double precision;
ie_tipo_desconto_w		bigint;

nr_seq_proc_pacote_w	bigint;
vl_proc_pacote_w		double precision;
vl_itens_pacote_w		double precision;
qt_fora_pacote_w	bigint;

vl_pacote_w		double precision;
vl_mat_pacote_w		double precision;
vl_dif_pacote_w		double precision;
vl_resumo_w		double precision;

nr_seq_desc_item_w	bigint;
vl_desc_item_w		double precision;
ie_desc_varios_pcts_w	varchar(1);

cd_estabelecimento_w	bigint;
IE_CALCULO_TAXA_REGRA_w	varchar(01);

ie_status_acerto_w	integer;
ie_pacote_w		varchar(1);
ie_ajuste_desc_proc_w	varchar(1);
vl_medico_dif_w		double precision;
vl_custo_oper_dif_w	double precision;
vl_medico_desc_w	double precision;
vl_custo_oper_desc_w	double precision;
ie_valor_inf_w		conta_paciente_desconto.ie_valor_inf%type;

C01 CURSOR FOR
	SELECT 	a.nr_sequencia,
		a.nr_seq_proc_pacote,
		a.vl_desconto
	from 	conta_paciente_desc_item 	a,
		conta_paciente_desconto		b
	where 	nr_seq_desconto = nr_seq_desconto_p
	and 	b.nr_sequencia = a.nr_seq_desconto
	and 	b.ie_tipo_desconto = 7
	and 	a.ie_calcula = 'S'
	order by a.nr_seq_proc_pacote;


c02 CURSOR FOR
	SELECT	cd_procedimento,
		ie_origem_proced
	from 	proc_paciente_valor b,
		procedimento_paciente a
	where	a.nr_interno_conta	= nr_interno_conta_p
	and	a.nr_sequencia		= b.nr_seq_procedimento
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and	a.ie_valor_informado	= 'S'
	and 	b.nr_seq_desconto	= nr_seq_desconto_p
	group by cd_procedimento,
		 ie_origem_proced
	having	count(*) = 1;


c03 CURSOR FOR
	SELECT	sum(vl_procedimento),
		nr_seq_proc_pacote
	from	procedimento_paciente
	where	nr_interno_conta	= nr_interno_conta_p
	and	nr_seq_proc_pacote	= nr_sequencia
	and	coalesce(cd_motivo_exc_conta::text, '') = ''
	group by nr_seq_proc_pacote;



BEGIN

ie_desc_varios_pcts_w:= obter_valor_param_usuario(67,265,Obter_Perfil_ativo,nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);
ie_ajuste_desc_proc_w:= obter_valor_param_usuario(67,614,Obter_Perfil_ativo,nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);

select	max(a.vl_liquido),
	max(a.vl_conta),
	max(a.vl_desconto),
	max(a.ie_tipo_desconto),
	max(a.ie_pacote),
	coalesce(max(a.ie_valor_inf),'A')
into STRICT	vl_liquido_w,
	vl_conta_w,
	vl_desc_original_w,
	ie_tipo_desconto_w,
	ie_pacote_w,
	ie_valor_inf_w
from	conta_paciente_desconto a
where	a.nr_sequencia = nr_seq_desconto_p;


/* Inicio Alteração Fabrício OS 227631*/

select 	coalesce(max(ie_status_acerto),1)
into STRICT	ie_status_acerto_w
from 	conta_paciente
where 	nr_interno_conta = nr_interno_conta_p;

if (ie_status_acerto_w = 2) then
	select 	coalesce(sum(vl_item),0)
	into STRICT	vl_conta_w
	from 	conta_paciente_valor_v
	where 	nr_interno_conta = nr_interno_conta_p
	and 	ie_status_acerto_w = 2
	and 	coalesce(cd_motivo_exc_conta::text, '') = ''
	and	coalesce(nr_seq_proc_pacote,0) <> nr_sequencia;
else
	vl_conta_w := coalesce(obter_valor_conta(nr_interno_conta_p, 0),0);
end if;
/* Final Alteração Fabrício OS 227631*/

if (vl_conta_w <> vl_liquido_w) and ((ie_desc_varios_pcts_w = 'N') or (ie_tipo_desconto_w <> 7)) then
	vl_diferenca_w	:= vl_liquido_w - vl_conta_w;


	/* Fabrício em 06/11/2007 -> coloquei o select abaixo e o tratamento if (nr_sequencia_w = 0),  OS 73571*/

	select	coalesce(max(a.nr_sequencia),0)
	into STRICT	nr_sequencia_w
	from 	procedimento_paciente a,
		proc_paciente_valor   b
	where	a.nr_sequencia 		= b.nr_seq_procedimento
	and 	a.nr_interno_conta	= nr_interno_conta_p
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and 	b.nr_seq_desconto	= nr_seq_desconto_p
	and 	b.ie_tipo_valor		= 3
	and	a.ie_valor_informado	= 'S'
	and 	(((coalesce(ie_pacote_w,'A') = 'F') and (coalesce(a.nr_seq_proc_pacote::text, '') = '')) or (coalesce(ie_pacote_w,'A') <> 'F'))
	and 	a.vl_procedimento >= abs(vl_diferenca_w) -- Incluí essa linha, Fabrício em 15/10/2008 OS 99776
	and 	((ie_valor_inf_w = 'A') or (ie_valor_inf_w = 'S'));

	if (nr_sequencia_w = 0) then
		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_sequencia_w
		from 	procedimento_paciente
		where	nr_interno_conta	= nr_interno_conta_p
		and	coalesce(cd_motivo_exc_conta::text, '') = ''
		and 	(((coalesce(ie_pacote_w,'A') = 'F') and (coalesce(nr_seq_proc_pacote::text, '') = '')) or (coalesce(ie_pacote_w,'A') <> 'F'))
		and	ie_valor_informado	= 'S'
		and 	((ie_valor_inf_w = 'A') or (ie_valor_inf_w = 'S'));
	end if;

	if (nr_sequencia_w <> 0) then

		/* Fabrício em 06/11/2007 -> inclui o sum(vl_medico) no select abaixo (OS 73571)*/

		select	sum(vl_procedimento),
			sum(vl_medico),
			sum(vl_custo_operacional)
		into STRICT	vl_procedimento_w,
			vl_medico_w,
			vl_custo_operacional_w
		from	procedimento_paciente
		where	nr_sequencia	= nr_sequencia_w;

		update	procedimento_paciente
		set	vl_procedimento	= vl_procedimento + vl_diferenca_w
		where	nr_sequencia	= nr_sequencia_w;

		/* Fabrício em 06/11/2007 -> coloquei o tratamento para fazer update no vl_medico caso não seja 0 (Zero) */

		/* OS 73571 */

		select 	coalesce(max(vl_medico),0),
			coalesce(max(vl_custo_operacional),0)
		into STRICT	vl_medico_desc_w,
			vl_custo_oper_desc_w
		from 	proc_paciente_valor
		where 	nr_seq_procedimento = nr_sequencia_w
		and 	ie_tipo_valor = 3;

		if (coalesce(vl_medico_w,0) <> 0) and (vl_medico_desc_w <> 0) then
			update	procedimento_paciente
			set 	vl_medico    = vl_medico + vl_diferenca_w
			where 	nr_sequencia = nr_sequencia_w;

			update  proc_paciente_valor
			set	vl_medico    	    = vl_medico - vl_diferenca_w
			where 	nr_seq_procedimento = nr_sequencia_w
			and 	nr_seq_desconto    = nr_seq_desconto_p
			and 	ie_tipo_valor	    = 3;

		elsif (coalesce(vl_custo_operacional_w,0) <> 0) and (vl_custo_oper_desc_w <> 0) then
			update	procedimento_paciente
			set 	vl_custo_operacional    = vl_custo_operacional + vl_diferenca_w
			where 	nr_sequencia = nr_sequencia_w;

			update  proc_paciente_valor
			set	vl_custo_operacional = vl_custo_operacional - vl_diferenca_w
			where 	nr_seq_procedimento = nr_sequencia_w
			and 	nr_seq_desconto    = nr_seq_desconto_p
			and 	ie_tipo_valor	    = 3;
		end if;

		update	proc_paciente_valor
		set	vl_procedimento		= vl_procedimento - vl_diferenca_w
		where	nr_seq_procedimento	= nr_sequencia_w
		and 	nr_seq_desconto    = nr_seq_desconto_p
		and	ie_tipo_valor		= 3;

	else

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_sequencia_w
		from	material_atend_paciente
		where	nr_interno_conta	= nr_interno_conta_p
		and	coalesce(cd_motivo_exc_conta::text, '') = ''
		and	ie_valor_informado	= 'S';
		if (nr_sequencia_w <> 0) then
			update	material_atend_paciente
			set	vl_material	= vl_material + vl_diferenca_w
			where	nr_sequencia	= nr_sequencia_w;
		end if;

	end if;
end if;


begin
select	coalesce(sum(a.vl_desconto),0)
into STRICT	vl_desconto_w
from	conta_paciente_desc_item a,
	conta_paciente_desconto b
where	a.nr_seq_desconto	= b.nr_sequencia
and 	b.nr_sequencia		= nr_seq_desconto_p
and	b.nr_interno_conta	= nr_interno_conta_p;
exception
	when others then
		vl_desconto_w	:= 0;
end;


/* Inclui esse bloco OS  163673 */

if (vl_desconto_w <> vl_desc_original_w) then
	vl_desconto_w:= vl_desc_original_w;
end if;


begin
select	coalesce(sum(a.vl_procedimento),0)
into STRICT	vl_total_desc_proc_w
from	proc_paciente_valor a,
	procedimento_paciente b
where	a.nr_seq_procedimento 	= b.nr_sequencia
and	a.ie_tipo_valor		= 3
and	b.nr_interno_conta	= nr_interno_conta_p
and 	a.nr_seq_desconto	= nr_seq_desconto_p
and	coalesce(b.cd_motivo_exc_conta::text, '') = '';
exception
	when others then
		vl_total_desc_proc_w := 0;
end;

begin
select	coalesce(sum(a.vl_material),0)
into STRICT	vl_total_desc_mat_w
from	mat_atend_paciente_valor a,
	material_atend_paciente b
where	a.nr_seq_material 	= b.nr_sequencia
and	a.ie_tipo_valor		= 3
and 	a.nr_seq_desconto	= nr_seq_desconto_p
and	coalesce(b.cd_motivo_exc_conta::text, '') = ''
and	b.nr_interno_conta	= nr_interno_conta_p;
exception
	when others then
		vl_total_desc_mat_w := 0;
end;

if	((vl_total_desc_proc_w + vl_total_desc_mat_w) <> vl_desconto_w) and
	((ie_desc_varios_pcts_w = 'N') or (ie_tipo_desconto_w <> 7)) then
	begin

	open	c02;
	loop
	fetch	c02 into
		cd_procedimento_w,
		ie_origem_proced_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin

		cd_procedimento_w	:= cd_procedimento_w;

		end;
	end loop;
	close c02;

	select 	max(a.nr_sequencia)
	into STRICT	nr_sequencia_w
	from 	Proc_Paciente_valor d,
		Procedimento b,
		Procedimento_paciente a
	where	a.nr_interno_conta 	= nr_interno_conta_p
	and	coalesce(a.nr_seq_proc_pacote,0) <> a.nr_sequencia
	and 	a.ie_valor_informado	= 'S'
	and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
	and 	(((coalesce(ie_pacote_w,'A') = 'F') and (coalesce(a.nr_seq_proc_pacote::text, '') = '')) or (coalesce(ie_pacote_w,'A') <> 'F'))
	and	a.cd_procedimento  	= b.cd_procedimento
	and	a.ie_origem_proced 	= b.ie_origem_proced
	and	a.nr_sequencia		= d.nr_seq_Procedimento
	and	1			= d.ie_tipo_valor
	and 	((ie_valor_inf_w = 'A') or (ie_valor_inf_w = 'S'));

	if (coalesce(nr_sequencia_w::text, '') = '') then
		select 	max(a.nr_sequencia)
		into STRICT	nr_sequencia_w
		from 	Procedimento b,
			Procedimento_paciente a
		where	a.nr_interno_conta 	= nr_interno_conta_p
		and	coalesce(nr_seq_proc_pacote,0) <> nr_sequencia
		and 	(((coalesce(ie_pacote_w,'A') = 'F') and (coalesce(a.nr_seq_proc_pacote::text, '') = '')) or (coalesce(ie_pacote_w,'A') <> 'F'))
		and 	a.ie_valor_informado	= 'S'
		and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
		and	a.cd_procedimento  	= b.cd_procedimento
		and	a.ie_origem_proced 	= b.ie_origem_proced
		and 	((ie_valor_inf_w = 'A') or (ie_valor_inf_w = 'S'));

	end if;

	if	((vl_total_desc_proc_w + vl_total_desc_mat_w) > vl_desconto_w) then

		select	coalesce(sum(vl_procedimento), 0)
		into STRICT	vl_proc_w
		from	procedimento_paciente
		where 	nr_interno_conta      = nr_interno_conta_p
		and	coalesce(cd_motivo_exc_conta::text, '') = ''
		and 	coalesce(nr_seq_proc_pacote, nr_sequencia) <> nr_sequencia;

		if (vl_proc_w = 0) then

			select	coalesce(sum(vl_procedimento), 0)
			into STRICT	vl_proc_w
			from	procedimento_paciente
			where 	nr_interno_conta      = nr_interno_conta_p
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and 	coalesce(nr_seq_proc_pacote, 0) <> nr_sequencia;

		end if;

		select	coalesce(sum(vl_material), 0)
		into STRICT	vl_mat_w
		from	material_atend_paciente
		where 	nr_interno_conta      = nr_interno_conta_p
		and	coalesce(cd_motivo_exc_conta::text, '') = '';


		if	((vl_proc_w + vl_mat_w) <> 0) then
			begin

			update	procedimento_paciente
			set	vl_procedimento		= vl_procedimento + (vl_liquido_w - (vl_proc_w + vl_mat_w))
			where	nr_sequencia		= nr_sequencia_w;

			update	proc_paciente_valor
			set	vl_procedimento		= vl_procedimento - (vl_liquido_w - (vl_proc_w + vl_mat_w))
			where	nr_seq_procedimento	= nr_sequencia_w
			and 	nr_seq_desconto    = nr_seq_desconto_p
			and	ie_tipo_valor		= 3;

			if (coalesce(ie_ajuste_desc_proc_w,'N') = 'S') then

				select	sum(vl_medico),
					sum(vl_custo_operacional)
				into STRICT	vl_medico_w,
					vl_custo_operacional_w
				from	procedimento_paciente
				where	nr_sequencia	= nr_sequencia_w;

				if (coalesce(vl_medico_w,0) <> 0) then
					update	procedimento_paciente
					set 	vl_medico    = vl_medico + (vl_liquido_w - (vl_proc_w + vl_mat_w))
					where 	nr_sequencia = nr_sequencia_w;

					update  proc_paciente_valor
					set	vl_medico    	    = vl_medico - (vl_liquido_w - (vl_proc_w + vl_mat_w))
					where 	nr_seq_procedimento = nr_sequencia_w
					and 	nr_seq_desconto    = nr_seq_desconto_p
					and 	ie_tipo_valor	    = 3;
				elsif (coalesce(vl_custo_operacional_w,0) <> 0) then
					update	procedimento_paciente
					set 	vl_custo_operacional    = vl_custo_operacional + (vl_liquido_w - (vl_proc_w + vl_mat_w))
					where 	nr_sequencia = nr_sequencia_w;

					update  proc_paciente_valor
					set	vl_custo_operacional = vl_custo_operacional - (vl_liquido_w - (vl_proc_w + vl_mat_w))
					where 	nr_seq_procedimento = nr_sequencia_w
					and 	nr_seq_desconto    = nr_seq_desconto_p
					and 	ie_tipo_valor	    = 3;
				end if;

			end if;


			begin
			select	coalesce(sum(a.vl_procedimento),0)
			into STRICT	vl_total_desc_proc_w
			from	proc_paciente_valor a,
				procedimento_paciente b
			where	a.nr_seq_procedimento 	= b.nr_sequencia
			and	a.ie_tipo_valor		= 3
			and 	nr_seq_desconto    = nr_seq_desconto_p
			and	b.nr_interno_conta	= nr_interno_conta_p
			and	coalesce(b.cd_motivo_exc_conta::text, '') = '';
			exception
				when others then
				vl_total_desc_proc_w := 0;
			end;

			begin
			select	coalesce(sum(a.vl_material),0)
			into STRICT	vl_total_desc_mat_w
			from	mat_atend_paciente_valor a,
				material_atend_paciente b
			where	a.nr_seq_material 	= b.nr_sequencia
			and	a.ie_tipo_valor		= 3
			and 	a.nr_seq_desconto	= nr_seq_desconto_p
			and	coalesce(b.cd_motivo_exc_conta::text, '') = ''
			and	b.nr_interno_conta	= nr_interno_conta_p;
			exception
				when others then
					vl_total_desc_mat_w := 0;
			end;


			if	(vl_liquido_w  <> (vl_total_desc_proc_w + vl_total_desc_mat_w)) then

				select	count(*)
				into STRICT	qt_proc_desc_w
				from	proc_paciente_valor
				where	nr_seq_procedimento   = nr_sequencia_w
				and 	nr_seq_desconto       = nr_seq_desconto_p
				and	ie_tipo_valor		= 3;

				if (qt_proc_desc_w <> 0) then

					update	procedimento_paciente
					set	vl_procedimento		= vl_procedimento - (vl_desconto_w - (vl_total_desc_proc_w + vl_total_desc_mat_w))
					where	nr_sequencia		= nr_sequencia_w;


					update	proc_paciente_valor
					set	vl_procedimento		= vl_procedimento + (vl_desconto_w - (vl_total_desc_proc_w + vl_total_desc_mat_w))
					where	nr_seq_procedimento	= nr_sequencia_w
					and 	nr_seq_desconto    = nr_seq_desconto_p
					and	ie_tipo_valor		= 3;

					if (coalesce(ie_ajuste_desc_proc_w,'N') = 'S') then

						select	sum(vl_medico),
							sum(vl_custo_operacional)
						into STRICT	vl_medico_w,
							vl_custo_operacional_w
						from	procedimento_paciente
						where	nr_sequencia	= nr_sequencia_w;

						if (coalesce(vl_medico_w,0) <> 0) then
							update	procedimento_paciente
							set 	vl_medico    = vl_medico - (vl_desconto_w - (vl_total_desc_proc_w + vl_total_desc_mat_w))
							where 	nr_sequencia = nr_sequencia_w;

							update  proc_paciente_valor
							set	vl_medico    	    = vl_medico + (vl_desconto_w - (vl_total_desc_proc_w + vl_total_desc_mat_w))
							where 	nr_seq_procedimento = nr_sequencia_w
							and 	nr_seq_desconto    = nr_seq_desconto_p
							and 	ie_tipo_valor	    = 3;
						elsif (coalesce(vl_custo_operacional_w,0) <> 0) then
							update	procedimento_paciente
							set 	vl_custo_operacional    = vl_custo_operacional - (vl_desconto_w - (vl_total_desc_proc_w + vl_total_desc_mat_w))
							where 	nr_sequencia = nr_sequencia_w;

							update  proc_paciente_valor
							set	vl_custo_operacional = vl_custo_operacional + (vl_desconto_w - (vl_total_desc_proc_w + vl_total_desc_mat_w))
							where 	nr_seq_procedimento = nr_sequencia_w
							and 	nr_seq_desconto    = nr_seq_desconto_p
							and 	ie_tipo_valor	    = 3;
						end if;

					end if;

				else
					begin

					select	max(b.nr_sequencia)
					into STRICT	nr_proc_desc_w
					from	proc_paciente_valor  a,
						procedimento_paciente b
					where	a.nr_seq_procedimento	= b.nr_sequencia
					and	coalesce(b.cd_motivo_exc_conta::text, '') = ''
					and	a.ie_tipo_valor		= 3
					and 	(((coalesce(ie_pacote_w,'A') = 'F') and (coalesce(b.nr_seq_proc_pacote::text, '') = '')) or (coalesce(ie_pacote_w,'A') <> 'F'))
					and 	a.nr_seq_desconto	= nr_seq_desconto_p
					and	b.nr_interno_conta	= nr_interno_conta_p
					and 	((ie_valor_inf_w = 'A') or (ie_valor_inf_w = coalesce(b.ie_valor_informado,'N')));


					update	proc_paciente_valor
					set	vl_procedimento		= vl_procedimento + (vl_desconto_w - (vl_total_desc_proc_w + vl_total_desc_mat_w))
					where	nr_seq_procedimento	= nr_proc_desc_w
					and 	nr_seq_desconto    = nr_seq_desconto_p
					and	ie_tipo_valor		= 3;

					if (coalesce(ie_ajuste_desc_proc_w,'N') = 'S') then

						select	sum(vl_medico),
							sum(vl_custo_operacional)
						into STRICT	vl_medico_w,
							vl_custo_operacional_w
						from	procedimento_paciente
						where	nr_sequencia	= nr_proc_desc_w;

						if (coalesce(vl_medico_w,0) <> 0) then
							update  proc_paciente_valor
							set	vl_medico    	    = vl_medico + (vl_desconto_w - (vl_total_desc_proc_w + vl_total_desc_mat_w))
							where 	nr_seq_procedimento = nr_proc_desc_w
							and 	nr_seq_desconto    = nr_seq_desconto_p
							and 	ie_tipo_valor	    = 3;
						elsif (coalesce(vl_custo_operacional_w,0) <> 0) then
							update  proc_paciente_valor
							set	vl_custo_operacional = vl_custo_operacional + (vl_desconto_w - (vl_total_desc_proc_w + vl_total_desc_mat_w))
							where 	nr_seq_procedimento = nr_proc_desc_w
							and 	nr_seq_desconto    = nr_seq_desconto_p
							and 	ie_tipo_valor	    = 3;
						end if;

					end if;

					end;
				end if;

			end if;

			end;
		end if;

	else
		begin

		select	coalesce(sum(vl_procedimento),0)
		into STRICT	vl_proc_w
		from	procedimento_paciente
		where 	nr_interno_conta      = nr_interno_conta_p
		and	coalesce(cd_motivo_exc_conta::text, '') = ''
		and 	coalesce(nr_seq_proc_pacote, nr_sequencia) <> nr_sequencia;


		select	coalesce(sum(vl_material),0)
		into STRICT	vl_mat_w
		from	material_atend_paciente
		where 	nr_interno_conta      = nr_interno_conta_p
		and	coalesce(cd_motivo_exc_conta::text, '') = ''
		and 	coalesce(nr_seq_proc_pacote, nr_sequencia) <> nr_sequencia;



		if	(vl_liquido_w <> (vl_proc_w + vl_mat_w)) then
			begin

			update	procedimento_paciente
			set	vl_procedimento		= vl_procedimento - (vl_desconto_w - (vl_total_desc_proc_w + vl_total_desc_mat_w))
			where	nr_sequencia		= nr_sequencia_w;

			update	proc_paciente_valor
			set	vl_procedimento		= vl_procedimento + (vl_desconto_w - (vl_total_desc_proc_w + vl_total_desc_mat_w))
			where	nr_seq_procedimento	= nr_sequencia_w
			and 	nr_seq_desconto    = nr_seq_desconto_p
			and	ie_tipo_valor		= 3;

			if (coalesce(ie_ajuste_desc_proc_w,'N') = 'S') then

				select	sum(vl_medico),
					sum(vl_custo_operacional)
				into STRICT	vl_medico_dif_w,
					vl_custo_oper_dif_w
				from	procedimento_paciente
				where	nr_sequencia = nr_sequencia_w;

				if (coalesce(vl_medico_dif_w,0) <> 0) then
					update	procedimento_paciente
					set 	vl_medico    = vl_medico - (vl_desconto_w - (vl_total_desc_proc_w + vl_total_desc_mat_w))
					where 	nr_sequencia = nr_sequencia_w;

					update  proc_paciente_valor
					set	vl_medico    	    = vl_medico + (vl_desconto_w - (vl_total_desc_proc_w + vl_total_desc_mat_w))
					where 	nr_seq_procedimento = nr_sequencia_w
					and 	nr_seq_desconto    = nr_seq_desconto_p
					and 	ie_tipo_valor	    = 3;
				elsif (coalesce(vl_custo_oper_dif_w,0) <> 0) then
					update	procedimento_paciente
					set 	vl_custo_operacional    = vl_custo_operacional - (vl_desconto_w - (vl_total_desc_proc_w + vl_total_desc_mat_w))
					where 	nr_sequencia = nr_sequencia_w;

					update  proc_paciente_valor
					set	vl_custo_operacional = vl_custo_operacional + (vl_desconto_w - (vl_total_desc_proc_w + vl_total_desc_mat_w))
					where 	nr_seq_procedimento = nr_sequencia_w
					and 	nr_seq_desconto    = nr_seq_desconto_p
					and 	ie_tipo_valor	    = 3;
				end if;

			end if;

			end;
		end if;

		end;
	end if;



	end;
end if;


begin
select	coalesce(sum(b.vl_procedimento),0)
into STRICT	vl_pacote_proc_w
from	procedimento_paciente b
where	b.nr_interno_conta	= nr_interno_conta_p
and	coalesce(b.cd_motivo_exc_conta::text, '') = ''
and	coalesce(nr_seq_proc_pacote,0) <> nr_sequencia;
exception
	when others then
		vl_pacote_proc_w := 0;
end;

begin
select	coalesce(sum(b.vl_material),0)
into STRICT	vl_pacote_mat_w
from	material_atend_paciente b
where	b.nr_interno_conta	= nr_interno_conta_p
and	coalesce(b.cd_motivo_exc_conta::text, '') = '';
exception
	when others then
		vl_pacote_mat_w := 0;
end;

select	coalesce(max(a.nr_sequencia),0)
into STRICT	nr_sequencia_w
from 	procedimento_paciente a
where	a.nr_interno_conta	= nr_interno_conta_p
and	a.ie_valor_informado	= 'S'
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and 	(((coalesce(ie_pacote_w,'A') = 'F') and (coalesce(a.nr_seq_proc_pacote::text, '') = '')) or (coalesce(ie_pacote_w,'A') <> 'F'))
and	coalesce(a.nr_seq_proc_pacote,0) <> a.nr_sequencia
and 	((ie_valor_inf_w = 'A') or (ie_valor_inf_w = 'S'));


if	(vl_liquido_w  <> (vl_pacote_proc_w + vl_pacote_mat_w)) and
	((ie_desc_varios_pcts_w = 'N') or (ie_tipo_desconto_w <> 7)) then

	update	procedimento_paciente
	set	vl_procedimento	= vl_procedimento + (vl_liquido_w - (vl_pacote_proc_w + vl_pacote_mat_w))
	where	nr_sequencia	= nr_sequencia_w;

	update	proc_paciente_valor
	set	vl_procedimento		= vl_procedimento - (vl_liquido_w - (vl_pacote_proc_w + vl_pacote_mat_w))
	where	nr_seq_procedimento	= nr_sequencia_w
	and 	nr_seq_desconto    	= nr_seq_desconto_p
	and	ie_tipo_valor		= 3;

	if (coalesce(ie_ajuste_desc_proc_w,'N') = 'S') then
		vl_medico_dif_w		:= 0;
		vl_custo_oper_dif_w	:= 0;

		select	sum(vl_medico),
			sum(vl_custo_operacional)
		into STRICT	vl_medico_dif_w,
			vl_custo_oper_dif_w
		from	procedimento_paciente
		where	nr_sequencia = nr_sequencia_w;

		if (coalesce(vl_medico_dif_w,0) <> 0) then
			update	procedimento_paciente
			set 	vl_medico    = vl_medico + (vl_liquido_w - (vl_pacote_proc_w + vl_pacote_mat_w))
			where 	nr_sequencia = nr_sequencia_w;

			update  proc_paciente_valor
			set	vl_medico    	    = vl_medico - (vl_liquido_w - (vl_pacote_proc_w + vl_pacote_mat_w))
			where 	nr_seq_procedimento = nr_sequencia_w
			and 	nr_seq_desconto    = nr_seq_desconto_p
			and 	ie_tipo_valor	    = 3;
		elsif (coalesce(vl_custo_oper_dif_w,0) <> 0) then
			update	procedimento_paciente
			set 	vl_custo_operacional    = vl_custo_operacional + (vl_liquido_w - (vl_pacote_proc_w + vl_pacote_mat_w))
			where 	nr_sequencia = nr_sequencia_w;

			update  proc_paciente_valor
			set	vl_custo_operacional = vl_custo_operacional - (vl_liquido_w - (vl_pacote_proc_w + vl_pacote_mat_w))
			where 	nr_seq_procedimento = nr_sequencia_w
			and 	nr_seq_desconto    = nr_seq_desconto_p
			and 	ie_tipo_valor	    = 3;
		end if;

	end if;

end if;

if (ie_tipo_desconto_w = 7) then
	begin

	if (ie_desc_varios_pcts_w = 'S') then

		open C01;
		loop
		fetch C01 into
			nr_seq_desc_item_w,
			nr_seq_proc_pacote_w,
			vl_desc_item_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin

			select	sum(CASE WHEN nr_seq_proc_pacote=nr_sequencia THEN vl_item  ELSE 0 END ) vl_proc_pacote
			into STRICT	vl_proc_pacote_w
			from 	conta_paciente_v
			where 	nr_interno_conta 	= nr_interno_conta_p
			and 	nr_seq_proc_pacote 	= nr_seq_proc_pacote_w;

			select	coalesce(max(a.nr_sequencia),0)
			into STRICT	nr_sequencia_w
			from 	procedimento_paciente a
			where	a.nr_interno_conta	= nr_interno_conta_p
			and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
			and 	a.vl_procedimento >= abs(vl_desc_item_w)
			and 	a.nr_seq_proc_pacote = nr_seq_proc_pacote_w
			and 	a.nr_sequencia <> a.nr_seq_proc_pacote;

			if (nr_sequencia_w = 0) then

				select	coalesce(max(a.nr_sequencia),0)
				into STRICT	nr_sequencia_w
				from 	procedimento_paciente a
				where	a.nr_interno_conta	= nr_interno_conta_p
				and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
				and 	a.nr_seq_proc_pacote = nr_seq_proc_pacote_w
				and 	a.nr_sequencia <> a.nr_seq_proc_pacote;

			end if;

			update	procedimento_paciente
			set 	vl_procedimento = vl_proc_pacote_w - vl_desc_item_w
			where 	nr_sequencia = nr_seq_proc_pacote_w;

			if (nr_sequencia_w <> 0) then

				update	procedimento_paciente
				set 	vl_procedimento = vl_procedimento - vl_desc_item_w
				where 	nr_sequencia = nr_sequencia_w;
			else

				select	coalesce(max(nr_sequencia),0)
				into STRICT	nr_sequencia_w
				from	material_atend_paciente a
				where	a.nr_interno_conta	= nr_interno_conta_p
				and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
				and 	a.nr_seq_proc_pacote = nr_seq_proc_pacote_w;

				if (nr_sequencia_w <> 0) then
					update	material_atend_paciente
					set	vl_material	= vl_material - vl_desc_item_w
					where	nr_sequencia	= nr_sequencia_w;
				end if;

			end if;

			end;
		end loop;
		close C01;

	else

		select	coalesce(max(nr_seq_proc_pacote),0),
			sum(CASE WHEN nr_seq_proc_pacote=nr_sequencia THEN vl_item  ELSE 0 END ) vl_proc_pacote,
			sum(CASE WHEN nr_seq_proc_pacote=nr_sequencia THEN 0  ELSE vl_item END ) vl_itens_pacote
		into STRICT	nr_seq_proc_pacote_w,
			vl_proc_pacote_w,
			vl_itens_pacote_w
		from 	conta_paciente_v
		where 	nr_interno_conta 	= nr_interno_conta_p
		and 	(nr_seq_proc_pacote IS NOT NULL AND nr_seq_proc_pacote::text <> '');

		if (nr_seq_proc_pacote_w <> 0) then

			begin

			if (vl_proc_pacote_w <> vl_itens_pacote_w) then

				begin

				if (vl_proc_pacote_w = vl_liquido_w) then

					select	max(b.nr_sequencia)
					into STRICT	nr_proc_desc_w
					from	procedimento_paciente b
					where	coalesce(b.cd_motivo_exc_conta::text, '') = ''
					and	b.nr_interno_conta	= nr_interno_conta_p
					and 	nr_seq_proc_pacote 	= nr_seq_proc_pacote_w
					and	nr_seq_proc_pacote 	<> nr_sequencia;

					vl_diferenca_w	:= vl_proc_pacote_w - vl_itens_pacote_w;

					if (nr_proc_desc_w IS NOT NULL AND nr_proc_desc_w::text <> '') then

						update	procedimento_paciente
						set	vl_procedimento		= vl_procedimento + vl_diferenca_w
						where	nr_sequencia		= nr_proc_desc_w;

					end if;
				else

					update	procedimento_paciente
					set	vl_procedimento		= vl_liquido_w
					where	nr_sequencia		= nr_seq_proc_pacote_w;

				end if;

				end;
			else

				begin

				select	count(*)
				into STRICT	qt_fora_pacote_w
				from	procedimento_paciente
				where	nr_interno_conta	= nr_interno_conta_p
				and 	nr_seq_proc_pacote 	<> nr_sequencia
				and	nr_seq_proc_pacote	= nr_seq_proc_pacote_w;

				if (qt_fora_pacote_w = 1) then

					begin

					update	procedimento_paciente
					set	vl_procedimento		= vl_liquido_w
					where	nr_seq_proc_pacote	= nr_seq_proc_pacote_w;

					end;
				end if;

				end;

			end if;

			end;

		end if;

	end if;

	end;
end if;

select	obter_valor_conta(nr_interno_conta_p, 0)
into STRICT	vl_conta_w
;

/* Inicio Alteração Fabrício OS 227631*/

select 	coalesce(max(ie_status_acerto),1)
into STRICT	ie_status_acerto_w
from 	conta_paciente
where 	nr_interno_conta = nr_interno_conta_p;

if (ie_status_acerto_w = 2) then
	select 	coalesce(sum(vl_item),0)
	into STRICT	vl_conta_w
	from 	conta_paciente_valor_v
	where 	nr_interno_conta = nr_interno_conta_p
	and 	ie_status_acerto_w = 2
	and 	coalesce(cd_motivo_exc_conta::text, '') = ''
	and	coalesce(nr_seq_proc_pacote,0) <> nr_sequencia;
end if;
/* Final Alteração Fabrício OS 227631*/

if (vl_conta_w <> vl_liquido_w) then
	begin

	select	max(b.nr_sequencia)
	into STRICT	nr_proc_desc_w
	from	procedimento_paciente b
	where	coalesce(b.cd_motivo_exc_conta::text, '') = ''
	and	b.nr_interno_conta	= nr_interno_conta_p
	and 	(((coalesce(ie_pacote_w,'A') = 'F') and (coalesce(b.nr_seq_proc_pacote::text, '') = '')) or (coalesce(ie_pacote_w,'A') <> 'F'))
	and	coalesce(nr_seq_proc_pacote, 0) <> nr_sequencia
	and 	((ie_valor_inf_w = 'A') or (ie_valor_inf_w = coalesce(b.ie_valor_informado,'N')));

	update	procedimento_paciente
	set	vl_procedimento		= vl_procedimento - (vl_conta_w - vl_liquido_w)
	where	nr_sequencia		= nr_proc_desc_w;

	if (coalesce(ie_ajuste_desc_proc_w,'N') = 'S') then

		select	sum(vl_medico),
			sum(vl_custo_operacional)
		into STRICT	vl_medico_w,
			vl_custo_operacional_w
		from	procedimento_paciente
		where	nr_sequencia	= nr_proc_desc_w;

		if (coalesce(vl_medico_w,0) <> 0) then
			update	procedimento_paciente
			set 	vl_medico    = vl_medico - (vl_conta_w - vl_liquido_w)
			where 	nr_sequencia = nr_proc_desc_w;
		elsif (coalesce(vl_custo_operacional_w,0) <> 0) then
			update	procedimento_paciente
			set 	vl_custo_operacional    = vl_custo_operacional - (vl_conta_w - vl_liquido_w)
			where 	nr_sequencia = nr_proc_desc_w;
		end if;

	end if;

	end;
end if;


open	c03;
loop
fetch	c03 into
	vl_pacote_w,
	nr_seq_proc_pacote_w;
EXIT WHEN NOT FOUND; /* apply on c03 */
	begin


	select	coalesce(sum(vl_procedimento),0)
	into STRICT	vl_proc_pacote_w
	from	procedimento_paciente
	where	nr_seq_proc_pacote	= nr_seq_proc_pacote_w
	and	nr_sequencia		<> nr_seq_proc_pacote_w;

	select	coalesce(sum(vl_material),0)
	into STRICT	vl_mat_pacote_w
	from	material_atend_paciente
	where	nr_seq_proc_pacote	= nr_seq_proc_pacote_w;

	vl_dif_pacote_w	:= (vl_proc_pacote_w + vl_mat_pacote_w) - vl_pacote_w;

	if (vl_dif_pacote_w <> 0) then
		update	procedimento_paciente
		set	vl_procedimento	= vl_procedimento + vl_dif_pacote_w
		where	nr_sequencia	= nr_seq_proc_pacote_w;

	end if;

	end;
end loop;
close c03;

select	sum(vl_desconto)
into STRICT	vl_resumo_w
from	conta_paciente_resumo
where	nr_interno_conta	= nr_interno_conta_p;


if (vl_resumo_w	<> vl_desc_original_w) then
	select	max(nr_sequencia)
	into STRICT	nr_sequencia_w
	from	conta_paciente_resumo
	where	nr_interno_conta	= nr_interno_conta_p;

	update	conta_paciente_resumo
	set	vl_desconto		= vl_desconto + (vl_desc_original_w - vl_resumo_w)
	where	nr_interno_conta	= nr_interno_conta_p
	and	nr_sequencia		= nr_sequencia_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_conpaci_dif_total (nr_interno_conta_p bigint, nr_seq_desconto_p bigint, nm_usuario_p text) FROM PUBLIC;

