-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE carrega_conversao_mat_conv ( cd_convenio_p bigint, cd_material_convenio_p text, cd_material_p text, ds_material_convenio_p text, cd_grupo_p text, tx_conversao_qtde_p bigint, cd_unidade_convenio_p text, cd_setor_atendimento_p bigint, cd_cgc_p text, nr_seq_marca_p bigint, ie_tipo_atendimento_p bigint, dt_inicio_vigencia_p timestamp, cd_categoria_p text, cd_estabelecimento_p bigint, nm_usuario_p text, ie_tipo_preco_autor_p text) AS $body$
DECLARE


qt_mat_conv_w		bigint;
qt_mat_w		bigint;
ie_check_estab_to_import_mat varchar(1) := 'N';
ds_log_convers_material		 convers_material_conv_log.ds_log%type;

procedure p_insert_log_conv_mat_conv(cd_convenio_p in conversao_material_convenio.cd_convenio%type,
                                     cd_estabelecimento_p in conversao_material_convenio.cd_estabelecimento%type,
                                     cd_material_p in conversao_material_convenio.cd_material%type, 
				     cd_material_convenio_p in conversao_material_convenio.cd_material_convenio%type, 
				     nm_usuario_p in conversao_material_convenio.nm_usuario%type,
				     ds_log_p in convers_material_conv_log.ds_log%type) is

;
BEGIN

insert into convers_material_conv_log(nr_sequencia,
				     dt_atualizacao,
				     nm_usuario,
				     dt_atualizacao_nrec,
				     nm_usuario_nrec,
				     cd_estabelecimento,
				     cd_convenio,
				     cd_material_convenio,
				     cd_material,
				     ds_log)
		              values (nextval('convers_material_conv_log_seq'),
				     clock_timestamp(),
				     nm_usuario_p,
				     clock_timestamp(),
				     nm_usuario_p,
				     cd_estabelecimento_p,
				     cd_convenio_p,
				     cd_material_convenio_p,
				     cd_material_p,
				     ds_log_p);

end;

begin

ie_check_estab_to_import_mat := obter_valor_param_usuario(921, 146, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p);

if (cd_convenio_p IS NOT NULL AND cd_convenio_p::text <> '') and (cd_material_convenio_p IS NOT NULL AND cd_material_convenio_p::text <> '') and (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then
	begin



	if (ie_check_estab_to_import_mat = 'S')then
		select 	count(*)
		into STRICT	qt_mat_conv_w 
		from 	conversao_material_convenio 
		where  	cd_convenio		= cd_convenio_p 
		and  	cd_material_convenio	= substr(cd_material_convenio_p,1,20)
		and	cd_material		= cd_material_p
		and	ds_material_convenio	= substr(ds_material_convenio_p,1,200)
		and	cd_estabelecimento = cd_estabelecimento_p;
	else
		select 	count(*)
		into STRICT	qt_mat_conv_w 
		from 	conversao_material_convenio 
		where  	cd_convenio		= cd_convenio_p 
		and  	cd_material_convenio	= substr(cd_material_convenio_p,1,20)
		and	cd_material		= cd_material_p
		and	ds_material_convenio	= substr(ds_material_convenio_p,1,200);
	end if;

	select	count(*)
	into STRICT	qt_mat_w
	from	material
	where	cd_material	= cd_material_p;

	if (qt_mat_conv_w = 0) and (qt_mat_w <> 0) then

		insert into conversao_material_convenio(
			nr_sequencia,
			cd_convenio,
			cd_material_convenio,
			dt_atualizacao,
			nm_usuario,
			cd_grupo_material,
			cd_subgrupo_material,
			cd_classe_material,
			cd_material,
			ds_material_convenio,
			cd_grupo,
			tx_conversao_qtde,
			cd_unidade_convenio,
			cd_setor_atendimento,
			cd_cgc,
			ie_situacao,
			nr_seq_marca,
			ie_tipo_atendimento,
			dt_inicio_vigencia,
			cd_categoria,
			cd_estabelecimento,
			ie_tipo_preco_autor)
		values (   
			nextval('conversao_mat_convenio_seq'),
			cd_convenio_p,
			substr(cd_material_convenio_p,1,20),
			clock_timestamp(),
			nm_usuario_p,                
			null,		
			null,
			null,
			cd_material_p,
			substr(ds_material_convenio_p,1,200),
			substr(cd_grupo_p,1,10),
			CASE WHEN tx_conversao_qtde_p=0 THEN  null  ELSE tx_conversao_qtde_p END ,
			substr(cd_unidade_convenio_p,1,5),
			CASE WHEN cd_setor_atendimento_p=0 THEN  null  ELSE cd_setor_atendimento_p END ,
			substr(cd_cgc_p,1,14),
			'A',
			CASE WHEN nr_seq_marca_p=0 THEN null  ELSE nr_seq_marca_p END ,
			CASE WHEN coalesce(ie_tipo_atendimento_p,0)=0 THEN null  ELSE ie_tipo_atendimento_p END ,
			dt_inicio_vigencia_p,
			CASE WHEN coalesce(cd_categoria_p,'0')='0' THEN  null  ELSE cd_categoria_p END ,
			CASE WHEN coalesce(cd_estabelecimento_p,0)=0 THEN null  ELSE cd_estabelecimento_p END ,
			ie_tipo_preco_autor_p);
	else
		if (qt_mat_conv_w > 0)then
			if (ie_check_estab_to_import_mat = 'S')then
				ds_log_convers_material := substr(wheb_mensagem_pck.get_texto(1200584), 1, 255);
			else
				ds_log_convers_material := substr(wheb_mensagem_pck.get_texto(1200585), 1, 255);
			end if;
			p_insert_log_conv_mat_conv(cd_convenio_p => cd_convenio_p, cd_estabelecimento_p => cd_estabelecimento_p,
									   cd_material_p => cd_material_p, cd_material_convenio_p => cd_material_convenio_p,
									   nm_usuario_p => nm_usuario_p, ds_log_p => ds_log_convers_material);
		end if;

		if (qt_mat_w = 0)then
			ds_log_convers_material := substr(wheb_mensagem_pck.get_texto(1200586), 1, 255);
			p_insert_log_conv_mat_conv(cd_convenio_p => cd_convenio_p, cd_estabelecimento_p => cd_estabelecimento_p,
									   cd_material_p => cd_material_p, cd_material_convenio_p => cd_material_convenio_p,
									   nm_usuario_p => nm_usuario_p, ds_log_p => ds_log_convers_material);
		end if;


	end if;
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE carrega_conversao_mat_conv ( cd_convenio_p bigint, cd_material_convenio_p text, cd_material_p text, ds_material_convenio_p text, cd_grupo_p text, tx_conversao_qtde_p bigint, cd_unidade_convenio_p text, cd_setor_atendimento_p bigint, cd_cgc_p text, nr_seq_marca_p bigint, ie_tipo_atendimento_p bigint, dt_inicio_vigencia_p timestamp, cd_categoria_p text, cd_estabelecimento_p bigint, nm_usuario_p text, ie_tipo_preco_autor_p text) FROM PUBLIC;

