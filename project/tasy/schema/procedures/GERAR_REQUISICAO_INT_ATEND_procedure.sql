-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_requisicao_int_atend ( nr_cpf_p text, cd_nacionalidade_p text, dt_nascimento_p text, ie_sexo_p text, nm_pessoa_fisica_p text, nm_mae_p text, cd_usuario_convenio_p text, cd_convenio_p text, nm_convenio_p text, cd_cnpj_p text, cd_procedimento_envio_p text, cd_profissional_dest_p text, ie_tipo_p pls_requisicao.ie_tipo%type default null, nr_seq_prioridade_p text DEFAULT NULL, ie_status_p text DEFAULT NULL, nr_seq_regulacao_p text DEFAULT NULL, ds_parecer_p text DEFAULT NULL, cd_cpf_medico_p text DEFAULT NULL, ie_origem_proced_p text DEFAULT NULL, qt_solicitado_p text  DEFAULT NULL) AS $body$
DECLARE



nr_seq_requisicao_w		bigint;
cd_pessoa_fisica_w		varchar(10);
nr_seq_segurado_w		bigint;
nr_seq_plano_w			bigint;
cd_medico_w				varchar(10);
nr_seq_cbo_w			tiss_cbo_saude.nr_seq_cbo_saude%type;
nr_seq_prestador_w		bigint;
ie_tipo_segurado_w		varchar(255);
ie_tipo_intercambio_w	varchar(255);
nm_usuario_w			varchar(10) := 'BIFROST';
ds_erro_w 				varchar(4000);


BEGIN

select	nextval('pls_requisicao_seq')
into STRICT	nr_seq_requisicao_w
;

select max(cd_pessoa_fisica)
into STRICT cd_pessoa_fisica_w
from pessoa_fisica
where nr_cpf = nr_cpf_p;

select	max(a.nr_sequencia)
into STRICT	nr_seq_segurado_w
from	pls_segurado a
where	a.cd_pessoa_fisica = cd_pessoa_fisica_w;

select	max(nr_seq_plano)
into STRICT	nr_seq_plano_w
from	pls_segurado
where	nr_sequencia = nr_seq_segurado_w;

if (cd_cpf_medico_p IS NOT NULL AND cd_cpf_medico_p::text <> '') then
		begin
			select	max(cd_pessoa_fisica)
			into STRICT	cd_medico_w
			from	pessoa_fisica
			where	NR_CPF = cd_cpf_medico_p;

			select	max(substr(PLS_OBTER_CBO_MEDICO(cd_medico_w),1,255))
			into STRICT	nr_seq_cbo_w
			;

			exception
			when others then
				nr_seq_cbo_w	:= null;
		end;
end if;

select	max(nr_sequencia)
into STRICT	nr_seq_prestador_w
from	pls_prestador
where	cd_cgc = cd_cnpj_p
and 	coalesce(dt_exclusao::text, '') = '';

ie_tipo_segurado_w	:= pls_obter_dados_segurado(nr_seq_segurado_w, 'TP');

if (coalesce(ie_tipo_segurado_w,'X')	= 'I') then
	ie_tipo_intercambio_w	:= 'I';
end if;



insert into pls_requisicao(	nr_sequencia,
									dt_requisicao,
									dt_atualizacao,
									nm_usuario,
									dt_atualizacao_nrec,
									nm_usuario_nrec,
									nr_seq_segurado,
									cd_medico_solicitante,
									nr_seq_plano,
									cd_estabelecimento,
									ie_tipo_guia,
									ie_estagio,
									ie_tipo_requisicao,
									nm_usuario_solic,
									ie_origem_solic,
									nr_seq_prestador,
									ie_tipo_processo,
									ie_tipo_intercambio,
									ie_tipo_gat,
									nr_seq_cbo_saude,
									nr_seq_regulacao,
									ie_integracao,
									ie_estagio_regulacao,
									nr_seq_prioridade,
									ds_observacao,
									ds_indicacao_clinica,
									ie_tipo)
						values (	nr_seq_requisicao_w,
									clock_timestamp(),
									clock_timestamp(),
									nm_usuario_w,
									clock_timestamp(),
									nm_usuario_w,
									nr_seq_segurado_w,
									cd_medico_w,
									nr_seq_plano_w,
									obter_estabelecimento_ativo,
									null,
									1,
									'M', -- ie_tipo_requisicao
									nm_usuario_w,
									'R',  -- ie_origem_solic
									nr_seq_prestador_w,
									'E', --ie_tipo_processo
									ie_tipo_intercambio_w,
									'N',
									nr_seq_cbo_w,
									nr_seq_regulacao_p,
									'S',
									'AG',
									coalesce(nr_seq_prioridade_p,1),
									ds_parecer_p,
									ds_parecer_p,
									ie_tipo_p);

commit;

CALL gerar_requisicao_int_proc(nr_seq_requisicao_w, cd_procedimento_envio_p, ie_origem_proced_p, qt_solicitado_p, nm_usuario_w, nr_seq_prioridade_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_requisicao_int_atend ( nr_cpf_p text, cd_nacionalidade_p text, dt_nascimento_p text, ie_sexo_p text, nm_pessoa_fisica_p text, nm_mae_p text, cd_usuario_convenio_p text, cd_convenio_p text, nm_convenio_p text, cd_cnpj_p text, cd_procedimento_envio_p text, cd_profissional_dest_p text, ie_tipo_p pls_requisicao.ie_tipo%type default null, nr_seq_prioridade_p text DEFAULT NULL, ie_status_p text DEFAULT NULL, nr_seq_regulacao_p text DEFAULT NULL, ds_parecer_p text DEFAULT NULL, cd_cpf_medico_p text DEFAULT NULL, ie_origem_proced_p text DEFAULT NULL, qt_solicitado_p text  DEFAULT NULL) FROM PUBLIC;

