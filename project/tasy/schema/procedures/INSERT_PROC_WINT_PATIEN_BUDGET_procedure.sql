-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_proc_wint_patien_budget (nr_atendimento_p procedimento_guia_wint.nr_atendimento%type, ie_origem_informacao_p procedimento_guia_wint.ie_origem_informacao%type, nr_sequencia_orcamento_p procedimento_guia_wint.nr_sequencia_orcamento%type, nm_usuario_p procedimento_guia_wint.nm_usuario%type) AS $body$
DECLARE


cd_procedimento_tuss_w orcamento_paciente_proc.cd_proced_tuss%type;
nr_sequencia_w orcamento_paciente_proc.nr_sequencia%type;
cd_procedimento_w orcamento_paciente_proc.cd_procedimento%type;
nr_seq_proc_interno_w orcamento_paciente_proc.nr_seq_proc_interno%type;
ds_observacao_w orcamento_paciente_proc.ds_observacao%type;
ie_lado_w orcamento_paciente_proc.ie_lado%type;
nr_crm_w crm_estado.nr_crm%type;
qt_procedimento_w orcamento_paciente_proc.qt_procedimento%type;
nr_prescricao_w orcamento_paciente.nr_prescricao%type;

c_proced_orcamento CURSOR FOR
SELECT  a.cd_procedimento,
        a.nr_seq_proc_interno,
        a.ds_observacao,
        a.ie_lado,
        coalesce(obter_crm_medico(coalesce(a.cd_medico, b.cd_medico)), '999') nr_crm,
        a.qt_procedimento,
        b.nr_prescricao,
        a.nr_sequencia,
        coalesce(a.cd_proced_tuss, obter_codigo_tuss(a.nr_seq_proc_interno), obter_codigo_tuss_exame(a.nr_seq_exame)) cd_procedimento_tuss
from    orcamento_paciente_proc a,
        orcamento_paciente b
where   a.nr_sequencia_orcamento = b.nr_sequencia_orcamento
and     b.nr_sequencia_orcamento = nr_sequencia_orcamento_p;


BEGIN

delete from procedimento_guia_wint a where a.nr_sequencia_orcamento = nr_sequencia_orcamento_p;

open c_proced_orcamento;
loop
        fetch c_proced_orcamento into
                cd_procedimento_w,
                nr_seq_proc_interno_w,
                ds_observacao_w,
                ie_lado_w,
                nr_crm_w,
                qt_procedimento_w,
                nr_prescricao_w,
                nr_sequencia_w,
                cd_procedimento_tuss_w;
        EXIT WHEN NOT FOUND; /* apply on c_proced_orcamento */

        CALL insert_proc_guia_wint(cd_procedimento_w,
                              cd_procedimento_tuss_w,
                              ds_observacao_w,
                              Obter_Desc_Proc_Interno(nr_seq_proc_interno_w),
                              ie_lado_w,
                              nm_usuario_p,
                              nr_atendimento_p,
                              nr_crm_w,
                              nr_seq_proc_interno_w,
                              coalesce(qt_procedimento_w, 1),
                              nr_prescricao_w,
                              ie_origem_informacao_p,
                              null,
                              null,
                              null,
                              null,
                              nr_sequencia_orcamento_p,
                              nr_sequencia_w);
end loop;

close c_proced_orcamento;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_proc_wint_patien_budget (nr_atendimento_p procedimento_guia_wint.nr_atendimento%type, ie_origem_informacao_p procedimento_guia_wint.ie_origem_informacao%type, nr_sequencia_orcamento_p procedimento_guia_wint.nr_sequencia_orcamento%type, nm_usuario_p procedimento_guia_wint.nm_usuario%type) FROM PUBLIC;

