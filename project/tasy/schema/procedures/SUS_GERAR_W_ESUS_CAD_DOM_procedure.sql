-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_gerar_w_esus_cad_dom ( nr_seq_lote_p esus_lote_envio.nr_sequencia%type, ie_tipo_lote_esus_p esus_lote_envio.ie_tipo_lote_esus%type, cd_cnes_estab_p estabelecimento.cd_cns%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

 
 
cd_cns_profissional_w		w_esus_cad_domiciliar.cd_cns_profissional%type;
nr_seq_exp_w			w_esus_cad_domiciliar.nr_sequencia%type;
cd_uuid_original_w		w_esus_cad_domiciliar.cd_uuid_original%type;

cd_pessoa_fisica_w		w_esus_cad_dom_familia.cd_pessoa_fis_respon%type;
cd_cns_pes_fis_respon_w		w_esus_cad_dom_familia.cd_cns_pes_fis_respon%type;
dt_nasc_pes_fis_resp_w		w_esus_cad_dom_familia.dt_nasc_pes_fis_resp%type;
ie_sexo_pes_fis_respon_w	w_esus_cad_dom_familia.ie_sexo_pes_fis_respon%type;
nr_data_reside_desde_w		w_esus_cad_dom_familia.nr_data_reside_desde%type;
nr_dt_nas_pes_fis_res_w		w_esus_cad_dom_familia.nr_dt_nas_pes_fis_res%type;

nr_sequencia_w			esus_cad_domiciliar.nr_sequencia%type;
cd_estabelecimento_w		esus_cad_domiciliar.cd_estabelecimento%type;
dt_atualizacao_w		esus_cad_domiciliar.dt_atualizacao%type;
nm_usuario_w			esus_cad_domiciliar.nm_usuario%type;
dt_atualizacao_nrec_w		esus_cad_domiciliar.dt_atualizacao_nrec%type;
nm_usuario_nrec_w		esus_cad_domiciliar.nm_usuario_nrec%type;
dt_liberacao_w			esus_cad_domiciliar.dt_liberacao%type;
cd_profissional_w		w_esus_cad_domiciliar.cd_profissional%type;
cd_cbo_w			w_esus_cad_domiciliar.cd_cbo%type;
cd_cnes_unidade_w		w_esus_cad_domiciliar.cd_cnes_unidade%type;
cd_cnes_unidade_ww		w_esus_cad_domiciliar.cd_cnes_unidade%type;
nr_seq_sus_equipe_w		w_esus_cad_domiciliar.nr_seq_sus_equipe%type;
ds_micro_area_w			w_esus_cad_domiciliar.ds_micro_area%type;
dt_atendimento_w		w_esus_cad_domiciliar.dt_atendimento%type;
cd_tipo_logradouro_w		w_esus_cad_domiciliar.cd_tipo_logradouro%type;
ds_logradouro_w			w_esus_cad_domiciliar.ds_logradouro%type;
nr_logradouro_w			w_esus_cad_domiciliar.nr_logradouro%type;
ie_sem_numero_w			w_esus_cad_domiciliar.ie_sem_numero%type;
ds_complemento_w		w_esus_cad_domiciliar.ds_complemento%type;
ds_bairro_w			w_esus_cad_domiciliar.ds_bairro%type;
cd_municipio_ibge_w		w_esus_cad_domiciliar.cd_municipio_ibge%type;
cd_cep_w			w_esus_cad_domiciliar.cd_cep%type;
nr_telefone_residenc_w		w_esus_cad_domiciliar.nr_telefone_residenc%type;
sg_estado_w			w_esus_cad_domiciliar.sg_estado%type;
nr_telefone_referenc_w		w_esus_cad_domiciliar.nr_telefone_referenc%type;
ie_situacao_moradia_w		w_esus_cad_domiciliar.ie_situacao_moradia%type;
ie_localizacao_w		w_esus_cad_domiciliar.ie_localizacao%type;
ie_tipo_domicilio_w		w_esus_cad_domiciliar.ie_tipo_domicilio%type;	
qt_moradores_w			w_esus_cad_domiciliar.qt_moradores%type;
qt_comodos_w			w_esus_cad_domiciliar.qt_comodos%type;
ie_condicao_terra_w		w_esus_cad_domiciliar.ie_condicao_terra%type;
ie_tipo_acesso_domic_w		w_esus_cad_domiciliar.ie_tipo_acesso_domic%type;
ie_disp_energ_eletri_w		w_esus_cad_domiciliar.ie_disp_energ_eletri%type;
ie_mat_pred_domicili_w		w_esus_cad_domiciliar.ie_mat_pred_domicili%type;
ie_abastecim_agua_w		w_esus_cad_domiciliar.ie_abastecim_agua%type;
ie_trat_agua_domicil_w		w_esus_cad_domiciliar.ie_trat_agua_domicil%type;
ie_forma_esc_sanitar_w		w_esus_cad_domiciliar.ie_forma_esc_sanitar%type;
ie_destino_lixo_w		w_esus_cad_domiciliar.ie_destino_lixo%type;
ie_animais_domicilio_w		w_esus_cad_domiciliar.ie_animais_domicilio%type;
ie_tipo_animal_domic_w		w_esus_cad_domiciliar.ie_tipo_animal_domic%type;
qt_animais_domicilio_w		w_esus_cad_domiciliar.qt_animais_domicilio%type;
ie_termo_recusa_w		w_esus_cad_domiciliar.ie_termo_recusa%type;
nr_seq_lote_envio_w		w_esus_cad_domiciliar.nr_seq_lote_envio%type;
ie_cachorro_w			w_esus_cad_domiciliar.ie_cachorro%type;
ie_passaro_w			w_esus_cad_domiciliar.ie_passaro%type;
ie_animal_de_criacao_w		w_esus_cad_domiciliar.ie_animal_de_criacao%type;
ie_outro_animal_w		w_esus_cad_domiciliar.ie_outro_animal%type;
ie_fora_area_w			w_esus_cad_domiciliar.ie_fora_area%type;
ds_ponto_referencia_w		w_esus_cad_domiciliar.ds_ponto_referencia%type;
ie_tipo_imovel_w		w_esus_cad_domiciliar.ie_tipo_imovel%type;
nm_instit_perman_w		w_esus_cad_domiciliar.nm_instit_perman%type;
ie_exist_outros_prof_w		w_esus_cad_domiciliar.ie_exist_outros_prof%type;
nm_resp_tec_inst_w		w_esus_cad_domiciliar.nm_resp_tec_inst%type;
cd_cns_resp_tec_w		w_esus_cad_domiciliar.cd_cns_resp_tec%type;
nm_cargo_resp_tec_w		w_esus_cad_domiciliar.nm_cargo_resp_tec%type;
nr_telefone_resp_tec_w		w_esus_cad_domiciliar.nr_telefone_resp_tec%type;
nr_data_atendimento_w		w_esus_cad_domiciliar.nr_data_atendimento%type;
cd_uuid_atualiza_w		w_esus_cad_domiciliar.cd_uuid_atualiza%type;
ie_atualizada_w			varchar(5);
ie_mudou_se_w			varchar(5);
qt_reg_animal_w			bigint := 0;

cd_contra_chave_rem_w		w_esus_header_footer.cd_contra_chave_rem%type;
cd_uuid_instal_rem_w		w_esus_header_footer.cd_uuid_instal_rem%type;
cd_contra_chave_ori_w		w_esus_header_footer.cd_contra_chave_ori%type;
cd_uuid_instal_orig_w		w_esus_header_footer.cd_uuid_instal_orig%type;
cd_municipio_ibge_ww		w_esus_header_footer.cd_municipio_ibge%type;

CadDom CURSOR FOR 
	SELECT 	nr_sequencia, 
		cd_estabelecimento, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		dt_liberacao, 
		cd_profissional, 
		cd_cbo, 
		cd_cnes_unidade, 
		nr_seq_sus_equipe, 
		ds_micro_area, 
		dt_atendimento, 
		cd_tipo_logradouro, 
		ds_logradouro, 
		nr_logradouro, 
		ie_sem_numero, 
		ds_complemento, 
		ds_bairro, 
		cd_municipio_ibge, 
		cd_cep, 
		nr_telefone_residenc, 
		sg_estado, 
		nr_telefone_referenc, 
		ie_situacao_moradia, 
		ie_localizacao, 
		ie_tipo_domicilio, 
		qt_moradores, 
		qt_comodos, 
		ie_condicao_terra, 
		ie_tipo_acesso_domic, 
		ie_disp_energ_eletri, 
		ie_mat_pred_domicili, 
		ie_abastecim_agua, 
		ie_trat_agua_domicil, 
		ie_forma_esc_sanitar, 
		ie_destino_lixo, 
		ie_animais_domicilio, 
		ie_tipo_animal_domic, 
		qt_animais_domicilio, 
		ie_termo_recusa, 
		nr_seq_lote_envio, 
		ie_cachorro, 
		ie_passaro, 
		ie_animal_de_criacao, 
		ie_outro_animal, 
		ie_fora_area,      
		ds_ponto_referencia, 
		ie_tipo_imovel, 
		nm_instit_perman, 
		ie_exist_outros_prof, 
		nm_resp_tec_inst, 
		cd_cns_resp_tec, 
		nm_cargo_resp_tec, 
		nr_telefone_resp_tec, 
		cd_uuid_original 
	from	esus_cad_domiciliar 
	where	nr_seq_lote_envio =	nr_seq_lote_p 
	order by nr_sequencia;

CadDomFa CURSOR FOR 
	SELECT nr_sequencia, 
		dt_atualizacao,     
		nm_usuario,     
		dt_atualizacao_nrec, 
		nm_usuario_nrec,  
		nr_seq_cad_dom,    
		nr_prontuario_famili, 
		cd_pessoa_fis_respon, 
		ie_renda_familiar,  
		qt_membros,   
		dt_reside_desde, 
		ie_mudou_se 
	from	esus_cad_dom_familia 
	where	nr_seq_cad_dom = nr_sequencia_w;

CadDomFa_w				CadDomFa%rowtype;

 
type 		fetch_array is table of CadDom%rowtype;
s_array 	fetch_array;
i		integer := 1;
type vetor is table of fetch_array index by integer;
vetor_CadDom_w			vetor;

 
	 
BEGIN 
delete 	from w_esus_cad_dom_familia 
where	nr_seq_lote_envio = nr_seq_lote_p;
 
delete 	from w_esus_cad_domiciliar 
where	nr_seq_lote_envio = nr_seq_lote_p;
 
 
open CadDom;
loop 
fetch CadDom bulk collect into s_array limit 1000;
	vetor_CadDom_w(i) := s_array;
	i := i + 1;
EXIT WHEN NOT FOUND; /* apply on CadDom */
end loop;
close CadDom;
 
 
for i in 1..vetor_CadDom_w.count loop 
	begin 
	s_array := vetor_CadDom_w(i);
	for z in 1..s_array.count loop 
		begin 
		 
		nr_sequencia_w			:= s_array[z].nr_sequencia;
		cd_estabelecimento_w		:= s_array[z].cd_estabelecimento;
		dt_atualizacao_w		:= s_array[z].dt_atualizacao;
		nm_usuario_w			:= s_array[z].nm_usuario;
		dt_atualizacao_nrec_w		:= s_array[z].dt_atualizacao_nrec;
		nm_usuario_nrec_w		:= s_array[z].nm_usuario_nrec;
		dt_liberacao_w			:= s_array[z].dt_liberacao;
		cd_profissional_w		:= s_array[z].cd_profissional;
		cd_cbo_w			:= s_array[z].cd_cbo;
		cd_cnes_unidade_w		:= s_array[z].cd_cnes_unidade;
		nr_seq_sus_equipe_w		:= s_array[z].nr_seq_sus_equipe;
		ds_micro_area_w			:= s_array[z].ds_micro_area;
		dt_atendimento_w		:= s_array[z].dt_atendimento;
		cd_tipo_logradouro_w		:= s_array[z].cd_tipo_logradouro;
		ds_logradouro_w			:= s_array[z].ds_logradouro;
		nr_logradouro_w			:= s_array[z].nr_logradouro;
		ie_sem_numero_w			:= s_array[z].ie_sem_numero;
		ds_complemento_w		:= s_array[z].ds_complemento;
		ds_bairro_w			:= s_array[z].ds_bairro;
		cd_municipio_ibge_w		:= s_array[z].cd_municipio_ibge;
		cd_cep_w			:= s_array[z].cd_cep;
		nr_telefone_residenc_w		:= s_array[z].nr_telefone_residenc;
		sg_estado_w			:= s_array[z].sg_estado;
		nr_telefone_referenc_w		:= s_array[z].nr_telefone_referenc;
		ie_situacao_moradia_w		:= s_array[z].ie_situacao_moradia;
		ie_localizacao_w		:= s_array[z].ie_localizacao;
		ie_tipo_domicilio_w		:= s_array[z].ie_tipo_domicilio;
		qt_moradores_w			:= s_array[z].qt_moradores;
		qt_comodos_w			:= s_array[z].qt_comodos;
		ie_condicao_terra_w		:= s_array[z].ie_condicao_terra;
		ie_tipo_acesso_domic_w		:= s_array[z].ie_tipo_acesso_domic;
		ie_disp_energ_eletri_w		:= s_array[z].ie_disp_energ_eletri;
		ie_mat_pred_domicili_w		:= s_array[z].ie_mat_pred_domicili;
		ie_abastecim_agua_w		:= s_array[z].ie_abastecim_agua;
		ie_trat_agua_domicil_w		:= s_array[z].ie_trat_agua_domicil;
		ie_forma_esc_sanitar_w		:= s_array[z].ie_forma_esc_sanitar;
		ie_destino_lixo_w		:= s_array[z].ie_destino_lixo;
		ie_animais_domicilio_w		:= s_array[z].ie_animais_domicilio;
		ie_tipo_animal_domic_w		:= s_array[z].ie_tipo_animal_domic;
		qt_animais_domicilio_w		:= s_array[z].qt_animais_domicilio;
		ie_termo_recusa_w		:= s_array[z].ie_termo_recusa;
		nr_seq_lote_envio_w		:= s_array[z].nr_seq_lote_envio;
		ie_cachorro_w			:= s_array[z].ie_cachorro;
		ie_passaro_w			:= s_array[z].ie_passaro;
		ie_animal_de_criacao_w		:= s_array[z].ie_animal_de_criacao;
		ie_outro_animal_w		:= s_array[z].ie_outro_animal;
		ie_fora_area_w			:= s_array[z].ie_fora_area;
		ds_ponto_referencia_w		:= s_array[z].ds_ponto_referencia;
		ie_tipo_imovel_w		:= s_array[z].ie_tipo_imovel;
		nm_instit_perman_w		:= s_array[z].nm_instit_perman;
		ie_exist_outros_prof_w		:= s_array[z].ie_exist_outros_prof;
		nm_resp_tec_inst_w		:= s_array[z].nm_resp_tec_inst;
		cd_cns_resp_tec_w		:= s_array[z].cd_cns_resp_tec;
		nm_cargo_resp_tec_w		:= s_array[z].nm_cargo_resp_tec;
		nr_telefone_resp_tec_w		:= s_array[z].nr_telefone_resp_tec;
		cd_uuid_original_w		:= s_array[z].cd_uuid_original;
		 
		begin 
			cd_cns_profissional_w := substr(obter_dados_pf(cd_profissional_w,'CNS'),1,20);		
		exception 
		when others then 
			cd_cns_profissional_w := '';
		end;
			 
		select	nextval('w_esus_cad_domiciliar_seq') 
		into STRICT	nr_seq_exp_w 
		;
		 
		if (ie_termo_recusa_w = 'S') then 
			ie_termo_recusa_w := 'true';
		else 
			ie_termo_recusa_w := 'false';
		end if;	
		 
		if (ie_tipo_imovel_w <> '1') then 
			begin 
			ie_animais_domicilio_w	:= '';
			ie_cachorro_w		:= '';
			ie_passaro_w		:= '';
			ie_animal_de_criacao_w	:= '';
			ie_tipo_animal_domic_w	:= '';
			ie_outro_animal_w	:= '';
			qt_animais_domicilio_w	:= null;
			nr_telefone_referenc_w	:= nr_telefone_residenc_w;
			nr_telefone_residenc_w	:= '';
			end;
		end if;
			 
		if (ie_tipo_imovel_w in ('2','3','4','5','6','12','99')) then 
			begin 
			ie_abastecim_agua_w	:= '';
			ie_condicao_terra_w	:= '';
			ie_destino_lixo_w	:= '';
			ie_forma_esc_sanitar_w	:= '';
			ie_localizacao_w	:= '';
			ie_mat_pred_domicili_w	:= '';
			qt_comodos_w		:= null;
			qt_moradores_w		:= '';
			ie_situacao_moradia_w	:= '';
			ie_disp_energ_eletri_w	:= '';
			ie_tipo_acesso_domic_w	:= '';
			ie_tipo_domicilio_w	:= '';
			ie_trat_agua_domicil_w	:= '';
			end;
		end if;	
 
		if (ie_tipo_imovel_w = '1') then 
			begin 
			if (ie_animais_domicilio_w = 'N') then 
				qt_animais_domicilio_w	:= null;			
			elsif (coalesce(qt_animais_domicilio_w,0) = 0) then	 
				begin 
				if (ie_cachorro_w = 'S') then 
					qt_animais_domicilio_w := coalesce(qt_animais_domicilio_w,0) + 1;				
				end if;
				if (ie_passaro_w = 'S') then 
					qt_animais_domicilio_w := coalesce(qt_animais_domicilio_w,0) + 1;				
				end if;
				if (ie_tipo_animal_domic_w = 'S') then 
					qt_animais_domicilio_w := coalesce(qt_animais_domicilio_w,0) + 1;		
				end if;
				if (ie_outro_animal_w = 'S') then 
					qt_animais_domicilio_w := coalesce(qt_animais_domicilio_w,0) + 1;				
				end if;
				end;
			elsif (coalesce(qt_animais_domicilio_w,0) > 0) then 
				begin 
				qt_reg_animal_w := 0;
				if (ie_cachorro_w = 'S') then				 
					qt_reg_animal_w := qt_reg_animal_w + 1;
				end if;
				if (ie_passaro_w = 'S') then				 
					qt_reg_animal_w := qt_reg_animal_w + 1;
				end if;
				if (ie_tipo_animal_domic_w = 'S') then				 
					qt_reg_animal_w := qt_reg_animal_w + 1;
				end if;
				if (ie_outro_animal_w = 'S') then				 
					qt_reg_animal_w := qt_reg_animal_w + 1;
				end if;
				if (coalesce(qt_animais_domicilio_w,0) < qt_reg_animal_w) then 
					qt_animais_domicilio_w := qt_reg_animal_w;
				end if;
				end;
			end if;	
			if (coalesce(qt_animais_domicilio_w,0) = 0) and (coalesce(ie_animais_domicilio_w,'X') <> 'N') then 
				qt_animais_domicilio_w := null;
				ie_animais_domicilio_w := 'N';
			end if;	
			end;
		end if;
				 
		if (ie_tipo_imovel_w not in ('7','8','9','10','11')) then 
			begin 
			nm_instit_perman_w	:= '';
			ie_exist_outros_prof_w	:= '';
			nm_resp_tec_inst_w	:= '';
			cd_cns_resp_tec_w	:= '';
			nm_cargo_resp_tec_w	:= '';
			nr_telefone_resp_tec_w	:= '';	
			end;
		end if;
		 
		if (ie_tipo_imovel_w in ('7','8','9','10','11')) then			 
			ie_condicao_terra_w 	:= '';
			ie_mat_pred_domicili_w	:= '';
			qt_comodos_w		:= null;
			ie_situacao_moradia_w	:= '';
			ie_tipo_acesso_domic_w	:= '';
			ie_tipo_domicilio_w	:= '';
		end if;	
		 
		if (ie_localizacao_w = 'U') then 
			ie_condicao_terra_w 	:= '';			
		end if;
		 
		cd_municipio_ibge_w := substr(cd_municipio_ibge_w||Calcula_Digito('MODULO10',cd_municipio_ibge_w),1,7);
		 
		if (dt_atendimento_w IS NOT NULL AND dt_atendimento_w::text <> '') then 
			nr_data_atendimento_w := rpad(((dt_atendimento_w - to_date('01/01/1970 00:00:00','dd/mm/yyyy hh24:mi:ss')) * 86400),13,0);
		else 
			nr_data_atendimento_w := null;
		end if;
		 
		select	coalesce(max(cd_cnes_unidade),'0') 
		into STRICT	cd_cnes_unidade_ww 
		from	w_esus_header_footer 
		where	nr_seq_lote_envio = nr_seq_lote_p;
		 
		if (cd_cnes_unidade_w <> cd_cnes_unidade_ww) then 
			begin 
			cd_contra_chave_rem_w	:= substr(sus_gerar_uuid_esus(cd_cnes_unidade_w,'C'),1,50);
			cd_uuid_instal_rem_w	:= substr(sus_gerar_uuid_esus(cd_cnes_unidade_w,'U'),1,50);
			cd_contra_chave_ori_w	:= cd_contra_chave_rem_w;
			cd_uuid_instal_orig_w	:= cd_uuid_instal_rem_w;			
			cd_municipio_ibge_ww	:= sus_obter_dados_equipe(nr_seq_sus_equipe_w,'CM');
			cd_municipio_ibge_ww	:= substr(cd_municipio_ibge_ww||Calcula_Digito('MODULO10',cd_municipio_ibge_ww),1,7);
			 
			update 	w_esus_header_footer 
			set 	cd_cnes_unidade = cd_cnes_unidade_w, 
				cd_cnes_serealizado = cd_cnes_unidade_w, 
				cd_contra_chave_rem = cd_contra_chave_rem_w, 
				cd_uuid_instal_rem = cd_uuid_instal_rem_w, 
				cd_contra_chave_ori = cd_contra_chave_ori_w, 
				cd_uuid_instal_orig = cd_uuid_instal_orig_w, 
				cd_municipio_ibge = cd_municipio_ibge_ww 
			where	nr_seq_lote_envio = nr_seq_lote_p;
			 
			end;
		end if;
		 
		if (coalesce(cd_uuid_original_w,'X') = 'X') then 
			cd_uuid_atualiza_w	:= coalesce(sus_gerar_uuid_esus(cd_cnes_unidade_w,'U'),'0');
			update esus_cad_domiciliar set cd_uuid_original = cd_uuid_atualiza_w where nr_sequencia = nr_sequencia_w;
			cd_uuid_original_w	:= cd_uuid_atualiza_w;
		else 
			cd_uuid_atualiza_w	:= coalesce(sus_gerar_uuid_esus(cd_cnes_unidade_w,'U'),'0');			
		end if;	
		 
		ie_atualizada_w	:= 'false';
		 
		if (coalesce(cd_uuid_original_w,'X') <> coalesce(cd_uuid_atualiza_w,'X')) and (coalesce(cd_uuid_original_w,'X') <> 'X') then 
			ie_atualizada_w	:= 'true';
		end if;
		 
		insert into w_esus_cad_domiciliar( nr_sequencia, 
						cd_estabelecimento, 
						dt_atualizacao, 
						nm_usuario, 
						dt_atualizacao_nrec, 
						nm_usuario_nrec, 
						cd_profissional, 
						cd_cbo, 
						nr_seq_sus_equipe, 
						ds_micro_area, 
						dt_atendimento, 
						cd_tipo_logradouro, 
						ds_logradouro, 
						nr_logradouro, 
						ie_sem_numero, 
						ds_complemento, 
						ds_bairro, 
						cd_municipio_ibge, 
						cd_cep, 
						nr_telefone_residenc, 
						sg_estado, 
						nr_telefone_referenc, 
						ie_situacao_moradia, 
						ie_localizacao, 
						ie_tipo_domicilio, 
						qt_moradores, 
						qt_comodos, 
						ie_condicao_terra, 
						ie_tipo_acesso_domic, 
						ie_disp_energ_eletri, 
						ie_mat_pred_domicili, 
						ie_abastecim_agua, 
						ie_trat_agua_domicil, 
						ie_forma_esc_sanitar, 
						ie_destino_lixo, 
						ie_animais_domicilio, 
						ie_tipo_animal_domic, 
						qt_animais_domicilio, 
						ie_termo_recusa, 
						cd_uuid_original, 
						nr_seq_lote_envio, 
						nr_seq_ficha, 
						cd_cns_profissional, 
						ie_atualizada, 
						ie_cachorro, 
						ie_passaro, 
						ie_animal_de_criacao, 
						ie_outro_animal, 
						cd_cnes_unidade, 
						ie_fora_area, 
						ds_ponto_referencia, 
						ie_tipo_imovel, 
						nm_instit_perman, 
						ie_exist_outros_prof, 
						nm_resp_tec_inst, 
						cd_cns_resp_tec, 
						nm_cargo_resp_tec, 
						nr_telefone_resp_tec, 
						nr_data_atendimento, 
						cd_uuid_atualiza) 
				values (	nr_seq_exp_w, 
						cd_estabelecimento_w, 
						dt_atualizacao_w, 
						nm_usuario_w, 
						dt_atualizacao_nrec_w, 
						nm_usuario_nrec_w, 
						cd_profissional_w, 
						cd_cbo_w, 
						nr_seq_sus_equipe_w, 
						CASE WHEN ie_fora_area_w='S' THEN ''  ELSE substr(lpad(ds_micro_area_w,2,'0'),1,2) END , 
						dt_atendimento_w, 
						lpad(cd_tipo_logradouro_w,3,'0'), 
						substr(ds_logradouro_w,1,72), 
						CASE WHEN ie_sem_numero_w='S' THEN ''  ELSE nr_logradouro_w END , 
						CASE WHEN ie_sem_numero_w='S' THEN 'true' WHEN ie_sem_numero_w='N' THEN 'false'  ELSE '' END , 
						substr(ds_complemento_w,1,30), 
						substr(ds_bairro_w,1,72), 
						cd_municipio_ibge_w, 
						substr(somente_numero(cd_cep_w),1,8), 
						substr(nr_telefone_residenc_w,1,11), 
						substr(esus_obter_codigo_uf(sg_estado_w),1,2), 
						substr(nr_telefone_referenc_w,1,11), 
						CASE WHEN ie_situacao_moradia_w='1' THEN '75' WHEN ie_situacao_moradia_w='2' THEN '76' WHEN ie_situacao_moradia_w='3' THEN '77' WHEN ie_situacao_moradia_w='4' THEN '78' WHEN ie_situacao_moradia_w='5' THEN '79' WHEN ie_situacao_moradia_w='6' THEN '80' WHEN ie_situacao_moradia_w='7' THEN '81' WHEN ie_situacao_moradia_w='8' THEN '82'  ELSE '' END , 
						CASE WHEN ie_localizacao_w='U' THEN '83' WHEN ie_localizacao_w='R' THEN '84'  ELSE '' END , 
						CASE WHEN ie_tipo_domicilio_w='C' THEN '85' WHEN ie_tipo_domicilio_w='A' THEN '86' WHEN ie_tipo_domicilio_w='D' THEN '87' WHEN ie_tipo_domicilio_w='O' THEN '88'  ELSE '' END , 
						qt_moradores_w, 
						qt_comodos_w, 
						CASE WHEN ie_condicao_terra_w='1' THEN '101' WHEN ie_condicao_terra_w='2' THEN '102' WHEN ie_condicao_terra_w='3' THEN '103' WHEN ie_condicao_terra_w='4' THEN '104' WHEN ie_condicao_terra_w='5' THEN '105' WHEN ie_condicao_terra_w='6' THEN '106' WHEN ie_condicao_terra_w='7' THEN '107' WHEN ie_condicao_terra_w='8' THEN '108'  ELSE '' END , 
						CASE WHEN ie_tipo_acesso_domic_w='P' THEN '89' WHEN ie_tipo_acesso_domic_w='C' THEN '90' WHEN ie_tipo_acesso_domic_w='F' THEN '91' WHEN ie_tipo_acesso_domic_w='O' THEN '82'  ELSE '' END , 
						CASE WHEN ie_disp_energ_eletri_w='S' THEN 'true' WHEN ie_disp_energ_eletri_w='N' THEN 'false'  ELSE '' END , 
						CASE WHEN ie_mat_pred_domicili_w='1' THEN '109' WHEN ie_mat_pred_domicili_w='2' THEN '110' WHEN ie_mat_pred_domicili_w='3' THEN '111' WHEN ie_mat_pred_domicili_w='4' THEN '112' WHEN ie_mat_pred_domicili_w='5' THEN '113' WHEN ie_mat_pred_domicili_w='6' THEN '114' WHEN ie_mat_pred_domicili_w='7' THEN '115' WHEN ie_mat_pred_domicili_w='8' THEN '116'  ELSE '' END , 
						CASE WHEN ie_abastecim_agua_w='R' THEN '117' WHEN ie_abastecim_agua_w='P' THEN '118' WHEN ie_abastecim_agua_w='T' THEN '119' WHEN ie_abastecim_agua_w='C' THEN '120' WHEN ie_abastecim_agua_w='O' THEN '121'  ELSE '' END , 
						CASE WHEN ie_trat_agua_domicil_w='F' THEN '97' WHEN ie_trat_agua_domicil_w='V' THEN '98' WHEN ie_trat_agua_domicil_w='C' THEN '99' WHEN ie_trat_agua_domicil_w='M' THEN '152' WHEN ie_trat_agua_domicil_w='S' THEN '100'  ELSE '' END , 
						CASE WHEN ie_forma_esc_sanitar_w='P' THEN '122' WHEN ie_forma_esc_sanitar_w='F' THEN '123' WHEN ie_forma_esc_sanitar_w='R' THEN '124' WHEN ie_forma_esc_sanitar_w='D' THEN '125' WHEN ie_forma_esc_sanitar_w='C' THEN '126' WHEN ie_forma_esc_sanitar_w='O' THEN '127'  ELSE '' END , 
						CASE WHEN ie_destino_lixo_w='C' THEN '93' WHEN ie_destino_lixo_w='Q' THEN '94' WHEN ie_destino_lixo_w='A' THEN '95' WHEN ie_destino_lixo_w='O' THEN '96'  ELSE '' END ,					 
						CASE WHEN ie_animais_domicilio_w='S' THEN 'true' WHEN ie_animais_domicilio_w='N' THEN 'false'  ELSE '' END , 
						CASE WHEN ie_tipo_animal_domic_w='S' THEN '128'  ELSE '' END , 
						qt_animais_domicilio_w, 
						CASE WHEN ie_termo_recusa_w='S' THEN 'true' WHEN ie_termo_recusa_w='N' THEN 'false'  ELSE '' END , 
						cd_uuid_original_w, 
						nr_seq_lote_envio_w, 
						nr_sequencia_w, 
						substr(cd_cns_profissional_w,1,15), 
						ie_atualizada_w, 
						CASE WHEN ie_cachorro_w='S' THEN '129'  ELSE '' END , 
						CASE WHEN ie_passaro_w='S' THEN '130'  ELSE '' END , 
						ie_animal_de_criacao_w, 
						CASE WHEN ie_outro_animal_w='S' THEN '132'  ELSE '' END , 
						cd_cnes_unidade_w, 
						CASE WHEN ds_micro_area_w='' THEN 'true'  ELSE CASE WHEN ie_fora_area_w='S' THEN 'true' WHEN ie_fora_area_w='N' THEN 'false'  ELSE '' END  END , 
						substr(ds_ponto_referencia_w,1,40), 
						ie_tipo_imovel_w, 
						substr(elimina_acentos(nm_instit_perman_w,'S'),1,100), 
						CASE WHEN ie_exist_outros_prof_w='S' THEN 'true' WHEN ie_exist_outros_prof_w='N' THEN 'false'  ELSE '' END , 
						substr(elimina_acentos(nm_resp_tec_inst_w,'S'),1,70), 
						substr(cd_cns_resp_tec_w,1,15), 
						substr(elimina_acentos(nm_cargo_resp_tec_w,'S'),1,100), 
						substr(nr_telefone_resp_tec_w,1,11), 
						nr_data_atendimento_w, 
						cd_uuid_atualiza_w);
				 
			open CadDomFa;
			loop 
			fetch CadDomFa into CadDomFa_w;
			EXIT WHEN NOT FOUND; /* apply on CadDomFa */
			 
				cd_pessoa_fisica_w	:= CadDomFa_w.cd_pessoa_fis_respon;
				 
				if (coalesce(cd_pessoa_fisica_w,'X') <> 'X') then 
					begin 
					cd_cns_pes_fis_respon_w		:= substr(obter_dados_pf(cd_pessoa_fisica_w,'CNS'),1,20);
					dt_nasc_pes_fis_resp_w		:= to_date(substr(obter_dados_pf(cd_pessoa_fisica_w,'DN'),1,10),'dd/mm/yyyy');
					ie_sexo_pes_fis_respon_w	:= substr(sus_gerar_depara_esus(obter_dados_pf(cd_pessoa_fisica_w,'SE'),'SEXO'),1,20);
					end;
				end if;	
				 
				if (caddomfa_w.dt_reside_desde IS NOT NULL AND caddomfa_w.dt_reside_desde::text <> '') then 
					nr_data_reside_desde_w := ((caddomfa_w.dt_reside_desde - to_date('01/01/1970 00:00:00','dd/mm/yyyy hh24:mi:ss')) * 86400);
				else 
					nr_data_reside_desde_w := null;
				end if;
				 
				if (dt_nasc_pes_fis_resp_w IS NOT NULL AND dt_nasc_pes_fis_resp_w::text <> '') then 
					nr_dt_nas_pes_fis_res_w := ((dt_nasc_pes_fis_resp_w - to_date('01/01/1970 00:00:00','dd/mm/yyyy hh24:mi:ss')) * 86400);
				else 
					nr_dt_nas_pes_fis_res_w := null;
				end if;			
				 
				ie_mudou_se_w := 'false';
				 
				if (CadDomFa_w.ie_mudou_se = 'S') or (ie_tipo_imovel_w <> '1') then 
					ie_mudou_se_w := 'true';
				end if;
					 
				insert into w_esus_cad_dom_familia(nr_sequencia, 
								dt_atualizacao, 
								nm_usuario, 
								dt_atualizacao_nrec, 
								nm_usuario_nrec, 
								nr_seq_cad_dom, 
								nr_seq_w_cad_dom, 
								nr_seq_lote_envio, 
								nr_prontuario_famili, 
								cd_pessoa_fis_respon, 
								ie_renda_familiar, 
								qt_membros, 
								dt_reside_desde, 
								ie_mudou_se, 
								cd_cns_pes_fis_respon, 
								dt_nasc_pes_fis_resp, 
								ie_sexo_pes_fis_respon, 
								nr_data_reside_desde, 
								nr_dt_nas_pes_fis_res) 
							values (nextval('w_esus_cad_dom_familia_seq'), 
								caddomfa_w.dt_atualizacao, 
								caddomfa_w.nm_usuario, 
								caddomfa_w.dt_atualizacao_nrec, 
								caddomfa_w.nm_usuario_nrec, 
								nr_sequencia_w, 
								nr_seq_exp_w, 
								nr_seq_lote_envio_w, 
								substr(caddomfa_w.nr_prontuario_famili,1,30), 
								caddomfa_w.cd_pessoa_fis_respon, 
								CASE WHEN caddomfa_w.ie_renda_familiar='1' THEN '1' WHEN caddomfa_w.ie_renda_familiar='2' THEN '2' WHEN caddomfa_w.ie_renda_familiar='3' THEN '3' WHEN caddomfa_w.ie_renda_familiar='4' THEN '4' WHEN caddomfa_w.ie_renda_familiar='5' THEN '7' WHEN caddomfa_w.ie_renda_familiar='6' THEN '5' WHEN caddomfa_w.ie_renda_familiar='7' THEN '6'  ELSE '' END , 
								caddomfa_w.qt_membros, 
								caddomfa_w.dt_reside_desde, 
								ie_mudou_se_w, 
								substr(cd_cns_pes_fis_respon_w,1,15), 
								dt_nasc_pes_fis_resp_w, 
								ie_sexo_pes_fis_respon_w, 
								nr_data_reside_desde_w, 
								nr_dt_nas_pes_fis_res_w);
			end loop;
			close CadDomFa;
		end;
	end loop;
	end;
end loop;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_gerar_w_esus_cad_dom ( nr_seq_lote_p esus_lote_envio.nr_sequencia%type, ie_tipo_lote_esus_p esus_lote_envio.ie_tipo_lote_esus%type, cd_cnes_estab_p estabelecimento.cd_cns%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

