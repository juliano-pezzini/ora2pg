-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_cen_metrica ( nr_seq_cenario_p bigint, nr_sequencia_p bigint, cd_centro_custo_p bigint, dt_mes_inic_p timestamp, dt_mes_fim_p timestamp, ie_sobrepor_p text, cd_estabelecimento_p bigint, cd_empresa_p bigint, ds_observacao_p text, nm_usuario_p text) AS $body$
DECLARE



qt_metrica_w			double precision;
vl_orcado_w			double precision;
vl_ticket_w			double precision;
nr_seq_metrica_w			double precision;
nr_seq_mes_ref_w			bigint;
cd_conta_contabil_w		varchar(20);
cd_centro_custo_w			bigint;
qt_reg_w				bigint;
nr_sequencia_w			bigint;

c01 CURSOR FOR
SELECT	nr_seq_metrica,
	cd_conta_contabil,
	cd_centro_custo,
	nr_seq_mes_ref,
	vl_medio
from 	ctb_cen_ticket_medio
where 	nr_seq_cenario				= nr_seq_cenario_p
and	coalesce(cd_centro_custo_p, cd_centro_custo)	= cd_centro_custo
and	cd_estabelecimento				= cd_estabelecimento_p
and	nr_seq_mes_ref	in (
	SELECT	distinct
		nr_sequencia
	from	ctb_mes_ref
	where	cd_empresa 			= cd_empresa_p
	and	dt_referencia between trunc(dt_mes_inic_p,'month') and trunc(dt_mes_fim_p,'month'));


BEGIN

open c01;
loop
fetch c01 into
	nr_seq_metrica_w,
	cd_conta_contabil_w,
	cd_centro_custo_w,
	nr_seq_mes_ref_w,
	vl_ticket_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	select	coalesce(max(qt_metrica),0)
	into STRICT	qt_metrica_w
	from	ctb_cen_metrica
	where	nr_seq_cenario	= nr_seq_cenario_p
	and	nr_seq_metrica	= nr_seq_metrica_w
	and	nr_seq_mes_ref	= nr_seq_mes_ref_w
	and	cd_centro_custo	= cd_centro_custo_w
	and	cd_estabelecimento	= cd_estabelecimento_p;

	vl_orcado_w	:= vl_ticket_w * qt_metrica_w;

	select	count(*)
	into STRICT	qt_reg_w
	from 	ctb_orc_cen_valor
	where 	nr_seq_cenario	= nr_seq_cenario_p
	and	nr_seq_mes_ref	= nr_seq_mes_ref_w
	and	cd_conta_contabil	= cd_conta_contabil_w
	and	cd_centro_custo	= cd_centro_custo_w;

	if (qt_reg_w = 0)	then
		select	nextval('ctb_orc_cen_valor_seq')
		into STRICT	nr_sequencia_w
		;
		insert into ctb_orc_cen_valor(
			nr_sequencia,
			nr_seq_cenario,
			cd_estabelecimento,
			nr_seq_mes_ref,
			dt_atualizacao,
			nm_usuario,
			cd_conta_contabil,
			cd_centro_custo,
			vl_orcado,
			ds_observacao,
			qt_metrica,
			vl_ticket_medio,
			nr_seq_metrica)
		values (nr_sequencia_w,
			nr_seq_cenario_p,
			cd_estabelecimento_p,
			nr_seq_mes_ref_w,
			clock_timestamp(),
			nm_usuario_p,
			cd_conta_contabil_w,
			cd_centro_custo_w,
			vl_orcado_w,
			ds_observacao_p,
			qt_metrica_w,
			vl_ticket_w,
			nr_seq_metrica_w);
	elsif (ie_sobrepor_p = 'S') then
		update	ctb_orc_cen_valor
		set	dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p,
			vl_orcado		= vl_orcado_w,
			ds_observacao	= ds_observacao_p,
			qt_metrica	= qt_metrica_w,
			vl_ticket_medio	= vl_ticket_w
		where 	nr_seq_cenario	= nr_seq_cenario_p
		and	nr_seq_mes_ref 	= nr_seq_mes_ref_w
		and	cd_conta_contabil 	= cd_conta_contabil_w
		and	cd_centro_custo 	= cd_centro_custo_w;
	elsif (ie_sobrepor_p = 'N') and (qt_reg_w > 0) then
		update	ctb_orc_cen_valor
		set	dt_atualizacao	= clock_timestamp(),
			nm_usuario	= nm_usuario_p,
			vl_orcado		= coalesce(vl_orcado,0) + vl_orcado_w,
			qt_metrica	= qt_metrica_w,
			vl_ticket_medio	= vl_ticket_w
		where 	nr_seq_cenario	= nr_seq_cenario_p
		and	nr_seq_mes_ref 	= nr_seq_mes_ref_w
		and	cd_conta_contabil 	= cd_conta_contabil_w
		and	cd_centro_custo 	= cd_centro_custo_w;
	end if;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_cen_metrica ( nr_seq_cenario_p bigint, nr_sequencia_p bigint, cd_centro_custo_p bigint, dt_mes_inic_p timestamp, dt_mes_fim_p timestamp, ie_sobrepor_p text, cd_estabelecimento_p bigint, cd_empresa_p bigint, ds_observacao_p text, nm_usuario_p text) FROM PUBLIC;

