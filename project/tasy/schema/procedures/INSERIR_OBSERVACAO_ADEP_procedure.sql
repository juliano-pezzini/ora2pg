-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_observacao_adep ( cd_estabelecimento_p bigint, nr_atendimento_p bigint, ie_tipo_item_p text, cd_item_p text, cd_intervalo_p text, qt_item_p bigint, qt_hora_prescricao_p bigint, nr_prescricoes_p text, ie_laboratorio_p text, ds_observacao_p text, nm_usuario_p text, nr_seq_proc_interno_p bigint, ie_pend_liberacao_p text, nr_seq_horario_p bigint, ie_acm_sn_p text, nr_prescricao_p bigint, nr_seq_item_p bigint, ds_componentes_p text, nr_seq_tipo_obs_p bigint, nr_seq_prot_glic_p bigint) AS $body$
DECLARE


cd_setor_pac_w			setor_atendimento.cd_setor_atendimento%type;
nr_prescricao_w			prescr_medica.nr_prescricao%type;
nr_prescr_hor_w			prescr_medica.nr_prescricao%type;
nr_seq_item_w			bigint;
nr_seq_horario_w		bigint;
nr_seq_alteracao_w		bigint;
dt_atualizacao_w		timestamp := clock_timestamp();
nr_prescricoes_w		varchar(2000);
ds_observacao_w			varchar(2000);
ie_data_proc_w			char(1);
ie_data_lib_prescr_w	char(1);
ie_exibe_suspenso_w		char(1);
ie_desagrupa_proced_w	char(1);
nr_seq_gas_cpoe_w		prescr_gasoterapia.nr_seq_gas_cpoe%type;

/* obter item x atendimento x observacao */

c01 CURSOR FOR
SELECT	a.nr_prescricao nr_prescricao,
	null nr_seq_item
from	prescr_dieta_hor c,
	prescr_medica a
where	c.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and	a.nr_atendimento = nr_atendimento_p
and	obter_se_valor_contido(a.nr_prescricao, nr_prescricoes_w) = 'S'
and	a.dt_validade_prescr > clock_timestamp() - qt_hora_prescricao_p / 24
and	c.cd_refeicao = cd_item_p
and	ie_tipo_item_p = 'D'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

SELECT	a.nr_prescricao nr_prescricao,
	null nr_seq_item
from	prescr_dieta_hor c,
	prescr_dieta	b,
	prescr_medica a
where	c.nr_prescricao = a.nr_prescricao
and	b.nr_prescricao = a.nr_prescricao
and	b.nr_sequencia	= c.nr_seq_dieta
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and	a.nr_atendimento = nr_atendimento_p
and	obter_se_valor_contido(a.nr_prescricao, nr_prescricoes_w) = 'S'
and	a.dt_validade_prescr > clock_timestamp() - qt_hora_prescricao_p / 24
AND	to_char(b.cd_dieta) = cd_item_p
and	((coalesce(c.cd_refeicao::text, '') = '') or (c.cd_refeicao = 'X'))
and	ie_tipo_item_p = 'D'
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'

union

select	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item
from	prescr_material b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
and	((obter_se_prescr_lib_adep(coalesce(a.dt_liberacao_medico, b.dt_lib_material), coalesce(a.dt_liberacao,b.dt_lib_material), coalesce(a.dt_liberacao_farmacia, b.dt_lib_farmacia), ie_data_lib_prescr_w) = 'S') or (coalesce(ie_pend_liberacao_p, 'X') in ('E', 'F')))
and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and	b.ie_agrupador in (1,16)
and	a.nr_atendimento = nr_atendimento_p
and	((coalesce(nr_prescr_hor_w,0) = 0) or (a.nr_prescricao = nr_prescr_hor_w))
and	obter_se_valor_contido(a.nr_prescricao, nr_prescricoes_w) = 'S'
and	a.dt_validade_prescr > clock_timestamp() - qt_hora_prescricao_p / 24
and	b.cd_material = cd_item_p
and	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and	coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))
and	ie_tipo_item_p in ('M', 'LD')
and	obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p

union

select	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item
from	prescr_material b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and	b.ie_agrupador in (12)
and	a.nr_atendimento = nr_atendimento_p
and	((coalesce(nr_prescr_hor_w,0) = 0) or (a.nr_prescricao = nr_prescr_hor_w))
and	obter_se_valor_contido(a.nr_prescricao, nr_prescricoes_w) = 'S'
and	a.dt_validade_prescr > clock_timestamp() - qt_hora_prescricao_p / 24
and	b.cd_material = cd_item_p
and	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
--and	nvl(b.qt_dose,1) = nvl(qt_item_p,1)
and	coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))
and	ie_tipo_item_p = 'S'

union

select	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item
from	prescr_material b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and	b.ie_agrupador in (2)
and	a.nr_atendimento = nr_atendimento_p
and	obter_se_valor_contido(a.nr_prescricao, nr_prescricoes_w) = 'S'
and	a.dt_validade_prescr > clock_timestamp() - qt_hora_prescricao_p / 24
and	((coalesce(nr_prescr_hor_w,0) = 0) or (a.nr_prescricao = nr_prescr_hor_w))
and	b.cd_material = cd_item_p
and	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
--and	nvl(b.qt_dose,1) = nvl(qt_item_p,1)
and	coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))
and	ie_tipo_item_p = 'MAT'

union

select	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item
from	prescr_procedimento b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	(((obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '')) or (coalesce(ie_pend_liberacao_p, 'X') in ('E', 'F')))
and	obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'
and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and	(((coalesce(b.nr_seq_exame::text, '') = '' and ie_laboratorio_p = 'N') or ((b.nr_seq_exame IS NOT NULL AND b.nr_seq_exame::text <> '') and ie_laboratorio_p = 'S')) or (ie_tipo_item_p in ('G','C')))
and	a.nr_atendimento = nr_atendimento_p
and	obter_se_valor_contido(a.nr_prescricao, nr_prescricoes_w) = 'S'
and	a.dt_validade_prescr > clock_timestamp() - qt_hora_prescricao_p / 24
and	b.cd_procedimento = cd_item_p
and	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and	(((b.nr_sequencia	= nr_Seq_item_p) and (b.nr_prescricao	= nr_prescricao_p) and (ie_desagrupa_proced_w = 'S')) or (ie_desagrupa_proced_w  = 'N'))
--and	nvl(b.qt_procedimento,1) = nvl(qt_item_p,1)
and	coalesce(b.qt_procedimento,1) = coalesce(qt_item_p,coalesce(b.qt_procedimento,1))
and	coalesce(nr_seq_prot_glic, 0) = coalesce(nr_seq_prot_glic_p ,0)
and	ie_tipo_item_p in ('P','G','C','I','HM')
and	((coalesce(nr_prescr_hor_w,0) = 0) or (a.nr_prescricao = nr_prescr_hor_w))
and	coalesce(b.nr_seq_proc_interno, coalesce(nr_seq_proc_interno_p, coalesce(b.nr_seq_proc_interno,1)))  = coalesce(nr_seq_proc_interno_p, coalesce(b.nr_seq_proc_interno,1))
and	((coalesce(ds_componentes_p::text, '') = '') or (ds_componentes_p = obter_mat_med_assoc_proc(b.nr_prescricao, b.nr_sequencia, 'S')))

union

select	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item
from	prescr_recomendacao b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
--and	a.dt_liberacao is not null
and	((ie_data_lib_prescr_w = 'F') or (obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'))
and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and	a.nr_atendimento = nr_atendimento_p
and	((coalesce(nr_prescr_hor_w,0) = 0) or (a.nr_prescricao = nr_prescr_hor_w))
and	obter_se_valor_contido(a.nr_prescricao, nr_prescricoes_w) = 'S'
and	a.dt_validade_prescr > clock_timestamp() - qt_hora_prescricao_p / 24
--and	((b.cd_recomendacao = cd_item_p) or (b.cd_recomendacao is null and b.ds_recomendacao = cd_item_p))
and	coalesce(to_char(b.cd_recomendacao),b.ds_recomendacao) = cd_item_p
and	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
--and	nvl(b.qt_recomendacao,1) = nvl(qt_item_p,1)
and	coalesce(b.qt_recomendacao,1) = coalesce(qt_item_p,coalesce(b.qt_recomendacao,1))
and	ie_tipo_item_p = 'R'

union

select	a.nr_sequencia nr_prescricao,
	b.nr_sequencia nr_seq_item
from	pe_prescr_proc b,
	pe_prescricao a
where	b.nr_seq_prescr = a.nr_sequencia
and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and	coalesce(b.ie_adep,'N') = 'S'
and	a.nr_atendimento = nr_atendimento_p
and	obter_se_valor_contido(a.nr_sequencia, nr_prescricoes_w) = 'S'
and	a.dt_validade_prescr > clock_timestamp() - qt_hora_prescricao_p / 24
and	b.nr_seq_proc = cd_item_p
and	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and	ie_tipo_item_p = 'E'

union

select	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item
from	prescr_material b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and	b.ie_agrupador in (5)
and	a.nr_atendimento = nr_atendimento_p
and	obter_se_valor_contido(a.nr_prescricao, nr_prescricoes_w) = 'S'
and	a.dt_validade_prescr > clock_timestamp() - qt_hora_prescricao_p / 24
and	b.cd_material = cd_item_p
and	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and	coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))
and	coalesce(b.ie_checar_adep,'N') = 'S'
and	ie_tipo_item_p = 'IA'

union

select	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item
from	prescr_material b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
and	obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and	b.ie_agrupador in (5)
and	obter_se_valor_contido(a.nr_prescricao, nr_prescricoes_w) = 'S'
and	a.dt_validade_prescr > clock_timestamp() - qt_hora_prescricao_p / 24
and	b.cd_material = cd_item_p
and	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
--and	nvl(b.qt_dose,1) = nvl(qt_item_p,nvl(b.qt_dose,1))
and	a.nr_atendimento = nr_atendimento_p
and	ie_tipo_item_p = 'IAG'

union

select	a.nr_prescricao nr_prescricao,
	b.nr_sequencia nr_seq_item
from	prescr_gasoterapia b,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and	a.nr_atendimento = nr_atendimento_p
and	obter_se_valor_contido(a.nr_prescricao, nr_prescricoes_w) = 'S'
--and	a.dt_validade_prescr > sysdate - qt_hora_prescricao_p / 24
and	b.nr_seq_gas = cd_item_p
and	ie_tipo_item_p in ('GAS','O')

union

select	a.nr_prescricao nr_prescricao,
	c.nr_sequencia nr_seq_item
from	prescr_medica_ordem b,
	prescr_ordem_hor c,
	prescr_medica a
where	b.nr_prescricao = a.nr_prescricao
and	c.nr_seq_ordem	= b.nr_sequencia
and	obter_se_exibir_rep_adep_setor(cd_setor_pac_w,a.cd_setor_atendimento,coalesce(a.ie_adep,'S')) = 'S'
and	a.nr_atendimento = nr_atendimento_p
and	obter_se_valor_contido(a.nr_prescricao, nr_prescricoes_w) = 'S'
and	c.nr_sequencia = cd_item_p
and	ie_tipo_item_p = 'B'
and c.ie_horario_especial = 'N';


BEGIN


nr_prescricoes_w := nr_prescricoes_p;
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') and (cd_item_p IS NOT NULL AND cd_item_p::text <> '') and (qt_hora_prescricao_p IS NOT NULL AND qt_hora_prescricao_p::text <> '') and (nr_prescricoes_w IS NOT NULL AND nr_prescricoes_w::text <> '') and (ie_laboratorio_p IS NOT NULL AND ie_laboratorio_p::text <> '') and (ds_observacao_p IS NOT NULL AND ds_observacao_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then

	CALL Wheb_assist_pck.set_informacoes_usuario(cd_estabelecimento_p, obter_perfil_ativo, nm_usuario_p);
	ie_data_proc_w			:= Wheb_assist_pck.obterParametroFuncao(924,223);
	ie_data_lib_prescr_w	:= Wheb_assist_pck.obterParametroFuncao(1113,115);
	ie_exibe_suspenso_w		:= Wheb_assist_pck.obterParametroFuncao(1113,117);
	ie_desagrupa_proced_w	:= Wheb_assist_pck.obterParametroFuncao(1113,463);
	
	ds_observacao_w	:= substr(ds_observacao_p,1,2000);
	
	cd_setor_pac_w	:= Obter_Unidade_Atendimento(nr_atendimento_p, 'IA', 'CS');
	
	if (coalesce(nr_seq_horario_p,0) > 0) then
		if (ie_tipo_item_p in ('M','S','MAT','LD')) then
			select	max(nr_prescricao)
			into STRICT	nr_prescr_hor_w
			from	prescr_mat_hor
			where	nr_sequencia = 	nr_seq_horario_p;
		elsif (ie_tipo_item_p in ('P','G','C','I','HM')) then
			select	max(nr_prescricao)
			into STRICT	nr_prescr_hor_w
			from	prescr_proc_hor
			where	nr_sequencia = 	nr_seq_horario_p;
		elsif (ie_tipo_item_p in ('R')) then
			select	max(nr_prescricao)
			into STRICT	nr_prescr_hor_w
			from	prescr_rec_hor
			where	nr_sequencia = 	nr_seq_horario_p;
		end if;
		
		nr_prescricoes_w	:= nr_prescricoes_w || ',' || nr_prescr_hor_w;
	end if;
		
	/* gerar evento observacao conforme tipo item */

	open c01;
	loop
	fetch c01 into
		nr_prescricao_w,
		nr_seq_item_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		if (ie_tipo_item_p = 'D') then
			select	nextval('prescr_mat_alteracao_seq')
			into STRICT	nr_seq_alteracao_w
			;

			insert	into	prescr_mat_alteracao(
								nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								nr_prescricao,
								dt_alteracao,
								cd_pessoa_fisica,
								ie_alteracao,
								ds_observacao,
								ie_tipo_item,
								nr_atendimento,
								cd_item,
								nr_seq_tipo_obs
								)
							values (
								nr_seq_alteracao_w,
								dt_atualizacao_w,
								nm_usuario_p,
								dt_atualizacao_w,
								nm_usuario_p,
								nr_prescricao_w,
								dt_atualizacao_w,
								obter_dados_usuario_opcao(nm_usuario_p,'C'),
								11,
								ds_observacao_w,
								ie_tipo_item_p,
								nr_atendimento_p,
								cd_item_p,
								nr_seq_tipo_obs_p
								);

		elsif (ie_tipo_item_p in ('S','M','MAT','IA','IAG','LD')) then
							
			select	nextval('prescr_mat_alteracao_seq')
			into STRICT	nr_seq_alteracao_w
			;

			insert into prescr_mat_alteracao(
								nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								nr_prescricao,
								nr_seq_prescricao,
								dt_alteracao,
								cd_pessoa_fisica,
								ie_alteracao,
								ds_observacao,
								ie_tipo_item,
								nr_atendimento,
								cd_item,
								ie_acm_sn,
								nr_seq_tipo_obs
								)
							values (
								nr_seq_alteracao_w,
								dt_atualizacao_w,
								nm_usuario_p,
								dt_atualizacao_w,
								nm_usuario_p,
								nr_prescricao_w,
								nr_seq_item_w,
								dt_atualizacao_w,
								obter_dados_usuario_opcao(nm_usuario_p,'C'),
								11,
								ds_observacao_w,
								ie_tipo_item_p,
								nr_atendimento_p,
								cd_item_p,
								ie_acm_sn_p,
								nr_seq_tipo_obs_p
								);
								
		elsif (ie_tipo_item_p = 'B') then
			select	nextval('prescr_mat_alteracao_seq')
			into STRICT	nr_seq_alteracao_w
			;

			insert into prescr_mat_alteracao(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_prescricao,
					nr_seq_horario_ordem,
					dt_alteracao,
					cd_pessoa_fisica,
					ie_alteracao,
					ds_observacao,
					ie_tipo_item,
					nr_atendimento,
					cd_item,
					nr_seq_tipo_obs
					)
				values (
					nr_seq_alteracao_w,
					dt_atualizacao_w,
					nm_usuario_p,
					dt_atualizacao_w,
					nm_usuario_p,
					nr_prescricao_w,
					nr_seq_item_w,
					dt_atualizacao_w,
					obter_dados_usuario_opcao(nm_usuario_p,'C'),
					11,
					ds_observacao_w,
					ie_tipo_item_p,
					nr_atendimento_p,
					cd_item_p,
					nr_seq_tipo_obs_p
					);

		elsif (ie_tipo_item_p in ('P','G','C','I','HM')) then
			select	nextval('prescr_mat_alteracao_seq')
			into STRICT	nr_seq_alteracao_w
			;
			
			insert into prescr_mat_alteracao(
								nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								nr_prescricao,
								nr_seq_procedimento,
								dt_alteracao,
								cd_pessoa_fisica,
								ie_alteracao,
								ds_observacao,
								ie_tipo_item,
								nr_atendimento,
								cd_item,
								nr_seq_proc_interno,
								nr_seq_tipo_obs,
								nr_seq_prot_glic
								)
							values (
								nr_seq_alteracao_w,
								dt_atualizacao_w,
								nm_usuario_p,
								dt_atualizacao_w,
								nm_usuario_p,
								nr_prescricao_w,
								nr_seq_item_w,
								dt_atualizacao_w,
								obter_dados_usuario_opcao(nm_usuario_p,'C'),
								11,
								ds_observacao_w,
								ie_tipo_item_p,
								nr_atendimento_p,
								cd_item_p,
								nr_seq_proc_interno_p,
								nr_seq_tipo_obs_p,
								nr_seq_prot_glic_p
								);

		elsif (ie_tipo_item_p = 'R') then
			select	nextval('prescr_mat_alteracao_seq')
			into STRICT	nr_seq_alteracao_w
			;

			insert into prescr_mat_alteracao(
								nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								nr_prescricao,
								nr_seq_recomendacao,
								dt_alteracao,
								cd_pessoa_fisica,
								ie_alteracao,
								ds_observacao,
								ie_tipo_item,
								nr_atendimento,
								cd_item,
								nr_seq_tipo_obs
								)
							values (
								nr_seq_alteracao_w,
								dt_atualizacao_w,
								nm_usuario_p,
								dt_atualizacao_w,
								nm_usuario_p,
								nr_prescricao_w,
								nr_seq_item_w,
								dt_atualizacao_w,
								obter_dados_usuario_opcao(nm_usuario_p,'C'),
								11,
								ds_observacao_w,
								ie_tipo_item_p,
								nr_atendimento_p,
								cd_item_p,
								nr_seq_tipo_obs_p
								);

		elsif (ie_tipo_item_p = 'E') then
			select	nextval('prescr_mat_alteracao_seq')
			into STRICT	nr_seq_alteracao_w
			;

			insert	into	prescr_mat_alteracao(
								nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								nr_prescricao,
								nr_seq_item_sae,
								dt_alteracao,
								cd_pessoa_fisica,
								ie_alteracao,
								ds_observacao,
								ie_tipo_item,
								nr_atendimento,
								cd_item,
								nr_seq_tipo_obs
								)
							values (
								nr_seq_alteracao_w,
								dt_atualizacao_w,
								nm_usuario_p,
								dt_atualizacao_w,
								nm_usuario_p,
								nr_prescricao_w,
								nr_seq_item_w,
								dt_atualizacao_w,
								obter_dados_usuario_opcao(nm_usuario_p,'C'),
								11,
								ds_observacao_w,
								ie_tipo_item_p,
								nr_atendimento_p,
								cd_item_p,
								nr_seq_tipo_obs_p
								);
		elsif (ie_tipo_item_p = 'GAS') or (ie_tipo_item_p = 'O') then
			select	nextval('prescr_gasoterapia_evento_seq')
			into STRICT	nr_seq_alteracao_w
			;
			
			select	max(a.nr_seq_gas_cpoe)
			into STRICT	nr_seq_gas_cpoe_w
			from	prescr_gasoterapia a
			where	a.nr_sequencia = nr_seq_item_w;
			
			insert	into	prescr_gasoterapia_evento(
									nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									dt_atualizacao_nrec,
									nm_usuario_nrec,									
									dt_evento,									
									ie_evento,
									ds_observacao,									
									nr_seq_gasoterapia,
									nr_seq_tipo_obs,
									nr_seq_gas_cpoe
									)
								values	(
									nr_seq_alteracao_w,
									dt_atualizacao_w,
									nm_usuario_p,
									dt_atualizacao_w,
									nm_usuario_p,									
									dt_atualizacao_w,									
									'O', --'GAS' (Havia sido alterado em 02/04/2011 por rfcaldas para 'GAS' quando o correto e 'O' p/evento de "Inserir observacao" na pasta gasoterapia)
									ds_observacao_w,									
									nr_seq_item_w,
									nr_seq_tipo_obs_p,
									nr_seq_gas_cpoe_w
									);	
		
		end if;
		end;
	end loop;
	close c01;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_observacao_adep ( cd_estabelecimento_p bigint, nr_atendimento_p bigint, ie_tipo_item_p text, cd_item_p text, cd_intervalo_p text, qt_item_p bigint, qt_hora_prescricao_p bigint, nr_prescricoes_p text, ie_laboratorio_p text, ds_observacao_p text, nm_usuario_p text, nr_seq_proc_interno_p bigint, ie_pend_liberacao_p text, nr_seq_horario_p bigint, ie_acm_sn_p text, nr_prescricao_p bigint, nr_seq_item_p bigint, ds_componentes_p text, nr_seq_tipo_obs_p bigint, nr_seq_prot_glic_p bigint) FROM PUBLIC;

