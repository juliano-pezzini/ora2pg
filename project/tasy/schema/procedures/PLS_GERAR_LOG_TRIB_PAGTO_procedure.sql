-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_log_trib_pagto ( nr_seq_lote_pagto_p pls_lote_pagamento.nr_sequencia%type, nr_seq_pp_lote_p pls_pp_lote.nr_sequencia%type default null) AS $body$
DECLARE


-- ESTÁ ROTINA POSSUI COMMIT, CHAMAR ELA APENAS NO ÍNICIO DE ALGUM PROCESSO
nr_seq_tributo_log_w		pls_tributo_log.nr_sequencia%type;

c01 CURSOR FOR
	SELECT	cd_conta_financ,		cd_estabelecimento,		cd_retencao,			cd_tipo_valor,			cd_tributo,
		ds_tributo,			dt_atualizacao,			dt_atualizacao_nrec,		ie_acumular_trib_liq,		ie_apuracao_piso,
		ie_atualizar_trib_liq,		ie_atualizar_venc_trib,		ie_baixa_titulo,		ie_ccm,				ie_centro_custo,
		ie_cnpj,			ie_considera_valor_pf,		ie_contab_prov_cp,		ie_conta_pagar,			ie_corpo_item,
		ie_data_irpf,			ie_desc_nf,			ie_dt_contab_tit_trib,		ie_forma_arred_nf,		ie_forma_arred_ops,
		ie_gera_nf_devolucao,		ie_gerar_titulo_pagar,		ie_gerar_trib_nf,		ie_gerar_trib_nfse,		ie_grupo_tributo,
		ie_incide_conta,		ie_isento,			ie_nf_tit_rec,			ie_pf_pj,			ie_rateio,
		ie_rateio_classif,		ie_regra_pf_sobre_cp,		ie_repasse_titulo,		ie_restringe_empresa,		ie_restringe_estab,
		ie_saldo_tit_pagar,		ie_situacao,			ie_soma_diminui,		ie_somente_nf,			ie_super_simples,
		ie_tipo_tributo,		ie_valor_base_titulo_nf,	ie_vencimento,			ie_venc_nf,			ie_venc_pls_pag_prod,
		ie_venc_repasse,		nm_usuario,			nm_usuario_nrec,		nr_seq_trans_conv_rec,		nr_seq_trans_imp,
		nr_seq_trans_prov_trib_rec,	nr_seq_trans_rec,		nr_seq_trans_tit_rec,		nr_tributacao_municipio,	nr_seq_termo_cred_deb,
		ie_desc_desp_cartao
	from	tributo
	order by cd_tributo;

C02 CURSOR(cd_tributo_pc	tributo.cd_tributo%type) FOR
	SELECT	cd_beneficiario,		cd_classe_material,		cd_cond_pagto,			cd_conta_financ,		cd_darf,
		cd_empresa,			cd_estabelecimento,		cd_grupo_material,		cd_material,			cd_municipio_ibge,
		cd_natureza_operacao,		cd_operacao_nf,			cd_pessoa_fisica,		cd_pessoa_juridica,		cd_subgrupo_material,
		cd_tipo_baixa_neg,		cd_tipo_pessoa_jur,		cd_tipo_servico,		cd_tributo,			ds_observacao,
		dt_atualizacao,			dt_atualizacao_nrec,		dt_fim_vigencia,		dt_inicio_vigencia,		ie_acumulativo,
		ie_contab_valor_trib,		ie_estrut_mat_nf,		ie_filantropia,			ie_mat_repasse,			ie_origem_titulo,
		ie_producao_medica,		ie_tipo_contratacao,		ie_tipo_pessoa,			ie_tipo_trib_municipal,		ie_tipo_tributacao,
		ie_titulo_sem_material,		ie_trib_pago,			nm_usuario,			nm_usuario_nrec,		nr_seq_classe,
		nr_seq_classe_tp,		nr_seq_cnae,			nr_seq_nat_juridica,		nr_seq_tipo_repasse,		nr_seq_trans_baixa,
		nr_seq_trans_baixa_rep,		nr_seq_trans_reg,		nr_seq_trans_reg_rep,		nr_sequencia,			pr_aliquota,
		pr_base_calculo,		pr_reducao_base,		sg_estado,			vl_base_final,			vl_base_inicial,
		vl_desc_dependente,		vl_minimo,			vl_minimo_tributo,		vl_teto_base_calculo,		nr_seq_tipo_prestador,
		nr_seq_class_prestador
	from	tributo_conta_pagar
	where	cd_tributo = cd_tributo_pc;

C03 CURSOR FOR
	SELECT	dt_atualizacao,			dt_atualizacao_nrec,		dt_fim_vigencia,		dt_inicio_vigencia,		nm_usuario,
		nm_usuario_nrec,		nr_sequencia,			tx_aliquota,			vl_base_calculo,		vl_reducao
	from	regra_calculo_irpf;

BEGIN
-- um dos dois parâmetros precisa ser informado
if (nr_seq_lote_pagto_p IS NOT NULL AND nr_seq_lote_pagto_p::text <> '') or (nr_seq_pp_lote_p IS NOT NULL AND nr_seq_pp_lote_p::text <> '') then
	
	CALL pls_desfazer_log_trib_pagto(nr_seq_lote_pagto_p, nr_seq_pp_lote_p);
	
	for	r_c01_w in c01 loop
		insert into pls_tributo_log(	
			cd_conta_financ,			cd_estabelecimento,		cd_retencao,				cd_tipo_valor,
			cd_tributo,				ds_tributo,			dt_atualizacao,				dt_atualizacao_nrec,
			ie_acumular_trib_liq,			ie_apuracao_piso,		ie_atualizar_trib_liq,			ie_atualizar_venc_trib,
			ie_baixa_titulo,			ie_ccm,				ie_centro_custo,			ie_cnpj,
			ie_considera_valor_pf,			ie_contab_prov_cp,		ie_conta_pagar,				ie_corpo_item,
			ie_data_irpf,				ie_desc_nf,			ie_dt_contab_tit_trib,			ie_forma_arred_nf,
			ie_forma_arred_ops,			ie_gera_nf_devolucao,		ie_gerar_titulo_pagar,			ie_gerar_trib_nf,
			ie_gerar_trib_nfse,			ie_grupo_tributo,		ie_incide_conta,			ie_isento,
			ie_nf_tit_rec,				ie_pf_pj,			ie_rateio,				ie_rateio_classif,
			ie_regra_pf_sobre_cp,			ie_repasse_titulo,		ie_restringe_empresa,			ie_restringe_estab,
			ie_saldo_tit_pagar,			ie_situacao,			ie_soma_diminui,			ie_somente_nf,
			ie_super_simples,			ie_tipo_tributo,		ie_valor_base_titulo_nf,		ie_vencimento,
			ie_venc_nf,				ie_venc_pls_pag_prod,		ie_venc_repasse,			nm_usuario,
			nm_usuario_nrec,			nr_seq_lote_pgto,		nr_seq_trans_conv_rec,			nr_seq_trans_imp,
			nr_seq_trans_prov_trib_rec,		nr_seq_trans_rec,		nr_seq_trans_tit_rec,			nr_sequencia,
			nr_tributacao_municipio,		nr_seq_pp_lote,			nr_seq_termo_cred_deb,			ie_desc_desp_cartao
		) values (
			r_c01_w.cd_conta_financ,		r_c01_w.cd_estabelecimento,	r_c01_w.cd_retencao,			r_c01_w.cd_tipo_valor,
			r_c01_w.cd_tributo,			r_c01_w.ds_tributo,		r_c01_w.dt_atualizacao,			r_c01_w.dt_atualizacao_nrec,
			r_c01_w.ie_acumular_trib_liq,		r_c01_w.ie_apuracao_piso,	r_c01_w.ie_atualizar_trib_liq,		r_c01_w.ie_atualizar_venc_trib,
			r_c01_w.ie_baixa_titulo,		r_c01_w.ie_ccm,			r_c01_w.ie_centro_custo,		r_c01_w.ie_cnpj,
			r_c01_w.ie_considera_valor_pf,		r_c01_w.ie_contab_prov_cp,	r_c01_w.ie_conta_pagar,			r_c01_w.ie_corpo_item,
			r_c01_w.ie_data_irpf,			r_c01_w.ie_desc_nf,		r_c01_w.ie_dt_contab_tit_trib,		r_c01_w.ie_forma_arred_nf,
			r_c01_w.ie_forma_arred_ops,		r_c01_w.ie_gera_nf_devolucao,	r_c01_w.ie_gerar_titulo_pagar,		r_c01_w.ie_gerar_trib_nf,
			r_c01_w.ie_gerar_trib_nfse,		r_c01_w.ie_grupo_tributo,	r_c01_w.ie_incide_conta,		r_c01_w.ie_isento,
			r_c01_w.ie_nf_tit_rec,			r_c01_w.ie_pf_pj,		r_c01_w.ie_rateio,			r_c01_w.ie_rateio_classif,
			r_c01_w.ie_regra_pf_sobre_cp,		r_c01_w.ie_repasse_titulo,	r_c01_w.ie_restringe_empresa,		r_c01_w.ie_restringe_estab,
			r_c01_w.ie_saldo_tit_pagar,		r_c01_w.ie_situacao,		r_c01_w.ie_soma_diminui,		r_c01_w.ie_somente_nf,
			r_c01_w.ie_super_simples,		r_c01_w.ie_tipo_tributo,	r_c01_w.ie_valor_base_titulo_nf,	r_c01_w.ie_vencimento,
			r_c01_w.ie_venc_nf,			r_c01_w.ie_venc_pls_pag_prod,	r_c01_w.ie_venc_repasse,		r_c01_w.nm_usuario,
			r_c01_w.nm_usuario_nrec,		nr_seq_lote_pagto_p,		r_c01_w.nr_seq_trans_conv_rec,		r_c01_w.nr_seq_trans_imp,
			r_c01_w.nr_seq_trans_prov_trib_rec,	r_c01_w.nr_seq_trans_rec,	r_c01_w.nr_seq_trans_tit_rec,		nextval('pls_tributo_log_seq'),
			r_c01_w.nr_tributacao_municipio,	nr_seq_pp_lote_p,		r_c01_w.nr_seq_termo_cred_deb,		r_c01_w.ie_desc_desp_cartao
		) returning nr_sequencia into nr_seq_tributo_log_w;

		for	r_c02_w in c02(r_c01_w.cd_tributo) loop
		
			insert into pls_trib_conta_pagar_log(	
				cd_beneficiario,		cd_classe_material,		cd_cond_pagto,				cd_conta_financ,
				cd_darf,			cd_empresa,			cd_estabelecimento,			cd_grupo_material,
				cd_material,			cd_municipio_ibge,		cd_natureza_operacao,			cd_operacao_nf,
				cd_pessoa_fisica,		cd_pessoa_juridica,		cd_subgrupo_material,			cd_tipo_baixa_neg,
				cd_tipo_pessoa_jur,		cd_tipo_servico,		cd_tributo,				ds_observacao,
				dt_atualizacao,			dt_atualizacao_nrec,		dt_fim_vigencia,			dt_inicio_vigencia,
				ie_acumulativo,			ie_contab_valor_trib,		ie_estrut_mat_nf,			ie_filantropia,
				ie_mat_repasse,			ie_origem_titulo,		ie_producao_medica,			ie_tipo_contratacao,
				ie_tipo_pessoa,			ie_tipo_trib_municipal,		ie_tipo_tributacao,			ie_titulo_sem_material,
				ie_trib_pago,			nm_usuario,			nm_usuario_nrec,			nr_seq_classe,
				nr_seq_classe_tp,		nr_seq_cnae,			nr_seq_nat_juridica,			nr_seq_origem,
				nr_seq_tipo_repasse,		nr_seq_trans_baixa,		nr_seq_trans_baixa_rep,			nr_seq_trans_reg,
				nr_seq_trans_reg_rep,		nr_seq_tributo_log,		nr_sequencia,				pr_aliquota,
				pr_base_calculo,		pr_reducao_base,		sg_estado,				vl_base_final,
				vl_base_inicial,		vl_desc_dependente,		vl_minimo,				vl_minimo_tributo,
				vl_teto_base_calculo,		nr_seq_tipo_prestador,		nr_seq_pp_lote,				nr_seq_class_prestador
			) values (
				r_c02_w.cd_beneficiario,	r_c02_w.cd_classe_material,	r_c02_w.cd_cond_pagto,			r_c02_w.cd_conta_financ,
				r_c02_w.cd_darf,		r_c02_w.cd_empresa,		r_c02_w.cd_estabelecimento,		r_c02_w.cd_grupo_material,
				r_c02_w.cd_material,		r_c02_w.cd_municipio_ibge,	r_c02_w.cd_natureza_operacao,		r_c02_w.cd_operacao_nf,
				r_c02_w.cd_pessoa_fisica,	r_c02_w.cd_pessoa_juridica,	r_c02_w.cd_subgrupo_material,		r_c02_w.cd_tipo_baixa_neg,
				r_c02_w.cd_tipo_pessoa_jur,	r_c02_w.cd_tipo_servico,	r_c02_w.cd_tributo,			r_c02_w.ds_observacao,
				r_c02_w.dt_atualizacao,		r_c02_w.dt_atualizacao_nrec,	r_c02_w.dt_fim_vigencia,		r_c02_w.dt_inicio_vigencia,
				r_c02_w.ie_acumulativo,		r_c02_w.ie_contab_valor_trib,	r_c02_w.ie_estrut_mat_nf,		r_c02_w.ie_filantropia,
				r_c02_w.ie_mat_repasse,		r_c02_w.ie_origem_titulo,	r_c02_w.ie_producao_medica,		r_c02_w.ie_tipo_contratacao,
				r_c02_w.ie_tipo_pessoa,		r_c02_w.ie_tipo_trib_municipal,	r_c02_w.ie_tipo_tributacao,		r_c02_w.ie_titulo_sem_material,
				r_c02_w.ie_trib_pago,		r_c02_w.nm_usuario,		r_c02_w.nm_usuario_nrec,		r_c02_w.nr_seq_classe,
				r_c02_w.nr_seq_classe_tp,	r_c02_w.nr_seq_cnae,		r_c02_w.nr_seq_nat_juridica,		r_c02_w.nr_sequencia,
				r_c02_w.nr_seq_tipo_repasse,	r_c02_w.nr_seq_trans_baixa,	r_c02_w.nr_seq_trans_baixa_rep,		r_c02_w.nr_seq_trans_reg,
				r_c02_w.nr_seq_trans_reg_rep,	nr_seq_tributo_log_w,		nextval('pls_trib_conta_pagar_log_seq'),	r_c02_w.pr_aliquota,
				r_c02_w.pr_base_calculo,	r_c02_w.pr_reducao_base,	r_c02_w.sg_estado,			r_c02_w.vl_base_final,
				r_c02_w.vl_base_inicial,	r_c02_w.vl_desc_dependente,	r_c02_w.vl_minimo,			r_c02_w.vl_minimo_tributo,
				r_c02_w.vl_teto_base_calculo,	r_c02_w.nr_seq_tipo_prestador,	nr_seq_pp_lote_p,			r_c02_w.nr_seq_class_prestador
			);
		end loop;
		
		commit;
	end loop;

	for	r_c03_w in c03 loop
		
		insert into pls_regra_calculo_irpf_log(	
			dt_atualizacao,				dt_atualizacao_nrec,		dt_fim_vigencia,		dt_inicio_vigencia,
			nm_usuario,				nm_usuario_nrec,		nr_seq_lote_pgto,		nr_seq_origem,
			nr_sequencia,				tx_aliquota,			vl_base_calculo,		vl_reducao,
			nr_seq_pp_lote
		) values (
			r_c03_w.dt_atualizacao,			r_c03_w.dt_atualizacao_nrec,	r_c03_w.dt_fim_vigencia,	r_c03_w.dt_inicio_vigencia,
			r_c03_w.nm_usuario,			r_c03_w.nm_usuario_nrec,	nr_seq_lote_pagto_p,		r_c03_w.nr_sequencia,
			nextval('pls_regra_calculo_irpf_log_seq'),	r_c03_w.tx_aliquota,		r_c03_w.vl_base_calculo,	r_c03_w.vl_reducao,
			nr_seq_pp_lote_p
		);
	end loop;

	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_log_trib_pagto ( nr_seq_lote_pagto_p pls_lote_pagamento.nr_sequencia%type, nr_seq_pp_lote_p pls_pp_lote.nr_sequencia%type default null) FROM PUBLIC;

