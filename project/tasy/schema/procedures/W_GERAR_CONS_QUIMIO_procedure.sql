-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE w_gerar_cons_quimio ( nr_seq_pend_agenda_p bigint, ds_dias_selec_p text, dt_min_agenda_p INOUT timestamp, nm_usuario_p text ) AS $body$
DECLARE


nr_sequencia_w		bigint;
nr_seq_atendimento_w	bigint;
dt_agenda_w		timestamp;
nr_seq_pend_agenda_w	bigint;
dt_prevista_w		timestamp;
nr_ciclo_w		smallint;
ds_dia_ciclo_w		varchar(5);
dt_real_w      		timestamp;
ie_gerar_encaixe_w	varchar(1) := 'N';

C01 CURSOR FOR
	SELECT	a.nr_seq_atendimento,
		b.dt_agenda,
		a.nr_seq_pend_agenda,
		a.dt_prevista,
		a.nr_ciclo,
		a.ds_dia_ciclo,
		a.dt_real
	from    paciente_atendimento a,
		agenda_quimio b
	where   b.nr_seq_atendimento = a.nr_seq_atendimento
	and	a.nr_seq_pend_Agenda   = nr_seq_pend_agenda_p
	and (obter_se_contido(a.nr_Seq_atendimento, ds_dias_Selec_p)	= 'S' or coalesce(ds_dias_selec_p::text, '') = '')
	and	b.ie_status_agenda <> 'C'
	order by 2;


BEGIN

delete	FROM W_GERAR_CONSULTA_QUIMIO
where	nr_seq_pend_agenda = nr_seq_pend_agenda_p;

commit;

select coalesce(max(IE_ENCAIXE_CONSULTA),'N')
  into STRICT ie_gerar_encaixe_w
  from PARAMETRO_AGENDA_QUIMIO
 where cd_estabelecimento = obter_estabelecimento_ativo;

if (nr_seq_pend_agenda_p IS NOT NULL AND nr_seq_pend_agenda_p::text <> '')then
	open C01;
	loop
	fetch C01 into	
		nr_seq_atendimento_w,
		dt_agenda_w,
		nr_seq_pend_agenda_w,
		dt_prevista_w,
		nr_ciclo_w,
		ds_dia_ciclo_w,
		dt_real_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		
		if (coalesce(dt_min_agenda_p::text, '') = '') and (dt_agenda_w IS NOT NULL AND dt_agenda_w::text <> '') then
			dt_min_agenda_p	:= dt_agenda_w;
		elsif (dt_prevista_w IS NOT NULL AND dt_prevista_w::text <> '') then
			dt_min_agenda_p	:= dt_prevista_w;
		else
			dt_min_agenda_p	:= clock_timestamp();
		end if;
		
		select	nextval('w_gerar_consulta_quimio_seq')
		into STRICT	nr_sequencia_w
		;
		
		insert into W_GERAR_CONSULTA_QUIMIO(	
					dt_agenda,
					dt_atualizacao,
					dt_atualizacao_nrec,
					hr_prevista,
					ie_gerar_consulta,
					nm_usuario,
					nm_usuario_nrec,
					nr_seq_atendimento,
					nr_seq_pend_agenda,
					nr_sequencia,
					nr_ciclo,
					dt_agenda_real,
					ds_dia_ciclo,
					ie_encaixe
					)
		values (	
					dt_agenda_w,
					clock_timestamp(),
					clock_timestamp(),
					dt_agenda_w,
					'S',
					nm_usuario_p,
					nm_usuario_p,
					nr_seq_atendimento_w,
					nr_seq_pend_agenda_w,
					nr_sequencia_w,
					nr_ciclo_w,
					dt_real_w,
					ds_dia_ciclo_w,
					ie_gerar_encaixe_w
					);

		end;
	end loop;
	close C01;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE w_gerar_cons_quimio ( nr_seq_pend_agenda_p bigint, ds_dias_selec_p text, dt_min_agenda_p INOUT timestamp, nm_usuario_p text ) FROM PUBLIC;

