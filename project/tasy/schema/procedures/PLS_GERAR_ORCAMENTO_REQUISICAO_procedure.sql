-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_orcamento_requisicao ( nr_seq_requisicao_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_reg_w			bigint;
nr_seq_segurado_w		bigint;

nr_seq_requisicao_w		bigint;
ie_tipo_guia_w			bigint;
dt_requisicao_w			timestamp;
cd_medico_solicitante_w		varchar(10);
nr_seq_proc_req_w		bigint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
nr_seq_material_w		bigint;
qt_solicitado_w			bigint;
nr_seq_mat_req_w		bigint;
nr_seq_prestador_w		bigint;
nr_seq_orcamento_w		bigint;

C01 CURSOR FOR
	SELECT	nr_sequencia,
		cd_procedimento,
		ie_origem_proced,
		qt_solicitado
	from	pls_requisicao_proc
	where	nr_seq_requisicao	= nr_seq_requisicao_p
	and	ie_status in ('G','N');

C02 CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_material,
		qt_solicitado
	from	pls_requisicao_mat
	where	nr_seq_requisicao	= nr_seq_requisicao_p
	and	ie_status in ('G','N');


BEGIN

select	nr_seq_segurado
into STRICT	nr_seq_segurado_w
from	pls_requisicao
where	nr_sequencia = nr_seq_requisicao_p;

select	nextval('pls_orcamento_seq')
into STRICT	nr_seq_orcamento_w
;

insert into pls_orcamento(nr_sequencia, nr_seq_requisicao, nr_seq_guia,
	ie_situacao, dt_atualizacao, nm_usuario,
	dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_segurado,
	dt_orcamento)
values (nr_seq_orcamento_w, nr_seq_requisicao_p ,null,
	'U', clock_timestamp(), nm_usuario_p,
	clock_timestamp(), nm_usuario_p, nr_seq_segurado_w,
	clock_timestamp());

open C01;
loop
fetch C01 into
	nr_seq_proc_req_w,
	cd_procedimento_w,
	ie_origem_proced_w,
	qt_solicitado_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	insert into pls_orcamento_proc(nr_sequencia, nr_seq_req_proc, nr_seq_guia_proc,
		cd_procedimento, ie_origem_proced, nr_seq_orcamento,
		vl_procedimento, dt_atualizacao, nm_usuario,
		dt_atualizacao_nrec, nm_usuario_nrec, qt_procedimento)
	values (nextval('pls_orcamento_proc_seq'), nr_seq_proc_req_w ,null,
		cd_procedimento_w, ie_origem_proced_w, nr_seq_orcamento_w,
		0, clock_timestamp(), nm_usuario_p,
		clock_timestamp(),nm_usuario_p, qt_solicitado_w);
	end;
end loop;
close C01;

open C02;
loop
fetch C02 into
	nr_seq_mat_req_w,
	nr_seq_material_w,
	qt_solicitado_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin
	insert into pls_orcamento_mat(nr_sequencia, nr_seq_req_mat, nr_seq_guia_mat,
		nr_seq_material, nr_seq_orcamento, vl_material,
		dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
		nm_usuario_nrec, qt_material)
	values (nextval('pls_orcamento_mat_seq'), nr_seq_mat_req_w ,null,
		nr_seq_material_w, nr_seq_orcamento_w, 0,
		clock_timestamp(), nm_usuario_p, clock_timestamp(),
		nm_usuario_p, qt_solicitado_w);
	end;
end loop;
close C02;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_orcamento_requisicao ( nr_seq_requisicao_p bigint, nm_usuario_p text) FROM PUBLIC;

