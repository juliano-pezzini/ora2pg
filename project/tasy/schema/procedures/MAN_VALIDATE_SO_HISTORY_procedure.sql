-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_validate_so_history ( nr_seq_order_p bigint, ds_history_p text, nm_usuario_p text, ds_error_p INOUT text ) AS $body$
DECLARE


ie_webservice_w			varchar(1);
ds_xml_w				text;
xml_w 					xml;


BEGIN

	select	coalesce(max(l.ie_webservice), 'N')
	into STRICT	ie_webservice_w
	from	man_localizacao l,
			man_ordem_servico o
	where	l.nr_sequencia = o.nr_seq_localizacao
	and		o.nr_sequencia = nr_seq_order_p;

	if (ie_webservice_w = 'S') and (ds_history_p IS NOT NULL AND ds_history_p::text <> '') then

		ds_xml_w := '<?xml version="1.0" encoding="ISO-8859-1" ?><DS_RELAT_TECNICO><![CDATA[' || ds_history_p || ']]></DS_RELAT_TECNICO>';

		begin
			xml_w := xmlparse(DOCUMENT, convert_from(, 'utf-8'));
		exception
			when others then
				if (SQLSTATE = -31011) then
					ds_error_p := wheb_mensagem_pck.get_texto(883603);
				end if;
		end;
	end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_validate_so_history ( nr_seq_order_p bigint, ds_history_p text, nm_usuario_p text, ds_error_p INOUT text ) FROM PUBLIC;

