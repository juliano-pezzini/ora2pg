-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_status_proced_exec (nr_sequencia_prescricao_p bigint, nr_prescricao_p bigint, nr_seq_exame_p bigint, nm_usuario_p text) AS $body$
DECLARE

			
ie_TasyLab_w		varchar(1);
ie_lab_patologia_w	varchar(01):='S';
ie_status_baixa_lab_w	bigint;
ie_status_atend_w       bigint;


BEGIN

	select max(coalesce(CASE WHEN coalesce(vl_parametro::text, '') = '' THEN  vl_parametro_padrao  ELSE vl_parametro END ,'N'))
	into STRICT ie_TasyLab_w
	from funcao_parametro
	where cd_funcao    = 0
	and nr_sequencia = 26;

	if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_sequencia_prescricao_p IS NOT NULL AND nr_sequencia_prescricao_p::text <> '') then

		if (nr_seq_exame_p > 0) then
			select 	coalesce(max(ie_anatomia_patologica),'N')
			into STRICT	ie_lab_patologia_w
			from 	exame_laboratorio
			where 	nr_seq_exame = nr_seq_exame_p;
		end if;
		
		select 	obter_status_atend_seq_prescr(nr_prescricao_p,nr_sequencia_prescricao_p)
		into STRICT	ie_status_atend_w
		;

		select 	coalesce(max(ie_status_baixa),35)
		into STRICT	ie_status_baixa_lab_w
		from 	lab_parametro;
		
		CALL gravar_log_tasy(10011, 'atualiza_status_proced_exec ln ' || $$plsql_line
				|| ' - nr_prescricao_p: ' || nr_prescricao_p					
				|| ' nr_sequencia_prescricao_p: ' || nr_sequencia_prescricao_p
				|| ' nr_seq_exame_p: ' || nr_seq_exame_p
				|| ' ie_lab_patologia_w: ' || ie_lab_patologia_w
				|| ' ie_tasylab_w: ' || ie_tasylab_w
				|| ' ie_status_atend_w: ' || ie_status_atend_w
				|| ' ie_status_baixa_lab_w: ' || ie_status_baixa_lab_w
				, nm_usuario_p);

		if	((ie_tasylab_w = 'N') or (ie_lab_patologia_w = 'S') or (nr_seq_exame_p = 0) or (ie_status_atend_w  >= ie_status_baixa_lab_w)) then

			update prescr_procedimento a
			set 	a.dt_baixa 		= clock_timestamp(),
				a.cd_motivo_baixa       = 1,
				a.dt_atualizacao	= clock_timestamp(),
				a.nm_usuario	        = nm_usuario_p,
				a.ie_status_execucao    = '20'
			where 	a.nr_prescricao  	= nr_prescricao_p
			and 	a.nr_sequencia   	= nr_sequencia_prescricao_p
			and 	coalesce(a.cd_motivo_baixa,0)	= 0
			and 	((ie_TasyLab_w = 'N') or (ie_lab_patologia_w = 'S') or (coalesce(a.nr_seq_exame::text, '') = '') or
				(a.ie_status_atend >= (SELECT coalesce(max(ie_status_baixa),35)
						from lab_parametro)));
		end if;
	end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_status_proced_exec (nr_sequencia_prescricao_p bigint, nr_prescricao_p bigint, nr_seq_exame_p bigint, nm_usuario_p text) FROM PUBLIC;

