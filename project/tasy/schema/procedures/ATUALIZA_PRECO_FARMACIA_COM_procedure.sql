-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_preco_farmacia_com (ie_tabela_p text, cd_tab_preco_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


dt_vigencia_w		timestamp;
vl_preco_w		double precision;
cd_codigo_w		varchar(255);
cd_material_w		integer;
cd_moeda_w		integer;
cd_unidade_venda_w	varchar(30);

c01 CURSOR FOR
SELECT	a.dt_vigencia,
	a.vl_preco,
	a.cd_codigo,
	b.cd_material
from	w_preco_farmacia_com a,
	material_sistema_externo b
where	a.cd_codigo = b.cd_codigo
and	a.ie_tabela = ie_tabela_p
and	a.ie_tabela = b.ie_sistema
and	(b.cd_material IS NOT NULL AND b.cd_material::text <> '');


BEGIN

select	cd_moeda_padrao
into STRICT	cd_moeda_w
from	parametro_contas_receber
where	cd_estabelecimento 	= cd_estabelecimento_p;

open c01;
loop
fetch c01 into
	dt_vigencia_w,
	vl_preco_w,
	cd_codigo_w,
	cd_material_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	begin
	select	cd_unidade_venda
	into STRICT	cd_unidade_venda_w
	from	material_estab
	where	cd_material		= cd_material_w
	and	cd_estabelecimento 	= cd_estabelecimento_p;
	exception
	when no_data_found then
		select	max(cd_unidade_venda)
		into STRICT	cd_unidade_venda_w
		from	material_estab
		where	cd_material		= cd_material_w;
	end;

	insert into	preco_material(
		cd_estabelecimento,
		cd_tab_preco_mat,
		cd_material,
		dt_inicio_vigencia,
		vl_preco_venda,
		cd_moeda,
		ie_brasindice,
		dt_atualizacao,
		nm_usuario,
		cd_unidade_medida,
		ie_situacao,
		nr_sequencia_nf,
		nr_item_nf,
		cd_cgc_fornecedor,
		qt_conversao,
		dt_atualizacao_nrec,
		nm_usuario_nrec) values (
				cd_estabelecimento_p,
				cd_tab_preco_p,
				cd_material_w,
				dt_vigencia_w,
				vl_preco_w,
				cd_moeda_w,
				'N',
				clock_timestamp(),
				nm_usuario_p,
				cd_unidade_venda_w,
				'A',
				null,
				null,
				'',
				null,
				clock_timestamp(),
				nm_usuario_p);

	delete	from w_preco_farmacia_com
	where	cd_codigo = cd_codigo_w
	and	ie_tabela = ie_tabela_p;

	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_preco_farmacia_com (ie_tabela_p text, cd_tab_preco_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

