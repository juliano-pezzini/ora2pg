-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE incluir_oc_nf_transf ( nr_seq_nf_p bigint, nr_ordem_compra_p bigint, cd_estabelecimento_p bigint, cd_local_estoque_p bigint, nm_usuario_p text, ie_item_nf bigint) AS $body$
DECLARE


cd_cgc_estab_w			varchar(14);
vl_frete_w			double precision;
nr_item_oci_w			integer;
cd_material_w			integer;
cd_unidade_medida_compra_w	varchar(30);
vl_unitario_item_nf_w		double precision;
pr_descontos_w			double precision;
cd_centro_custo_w			integer;
cd_conta_contabil_w		varchar(20);
pr_desc_financ_w			double precision;
dt_prevista_entrega_w		timestamp;
vl_desconto_oci_w			double precision;
vl_desconto_w			double precision;
nr_item_nf_w			integer;
cd_unidade_medida_estoque_w	varchar(30);
qt_prevista_entrega_w		double precision;
qt_item_estoque_w			double precision;
vl_total_item_nf_w			double precision;
vl_liquido_w			double precision;
qt_conv_compra_estoque_w		double precision;
cd_material_estoque_w		integer;
ie_tipo_conta_w			integer;
cd_centro_conta_w			integer;
cd_natureza_operacao_w		smallint;
cd_serie_nf_w			nota_fiscal.cd_serie_nf%type;
nr_sequencia_nf_w			bigint;
ds_material_direto_w		varchar(255);
ds_observacao_item_w		varchar(255);
nr_nota_fiscal_w			varchar(255);

nr_seq_lote_w			bigint;
ie_indeterminado_w			varchar(2) := 'N';
dt_validade_w			timestamp;
ds_lote_fornec_w			varchar(20);
nr_seq_conta_financeira_w		bigint;


c01 CURSOR FOR
SELECT	a.nr_item_oci,
	a.cd_material,
	a.cd_unidade_medida_compra,
	a.vl_unitario_material,
	coalesce(a.pr_descontos,0),
	substr(a.ds_material_direto,1,255),
	a.ds_observacao,
--	a.cd_centro_custo,
	coalesce(a.pr_desc_financ,0),
	b.dt_prevista_entrega,
	coalesce(a.vl_desconto,0),
	o.vl_frete
from	ordem_compra o,
	ordem_compra_item a,
	ordem_compra_item_entrega b
where	a.nr_ordem_compra = b.nr_ordem_compra
and	a.nr_item_oci = b.nr_item_oci
and	a.nr_ordem_compra = nr_ordem_compra_p
and	a.nr_ordem_compra = o.nr_ordem_compra
and	coalesce(a.qt_material,0) > coalesce(a.qt_material_entregue,0)
and (coalesce(qt_prevista_entrega,0) - coalesce(qt_real_entrega,0)) > 0
and	coalesce(a.dt_reprovacao::text, '') = ''
and	coalesce(b.dt_cancelamento::text, '') = ''
and	a.nr_item_oci not in (
		SELECT	i.nr_item_oci
		from	nota_fiscal n,
			nota_fiscal_item i
		where	n.nr_sequencia 	= i.nr_sequencia
		and	i.nr_ordem_compra 	= a.nr_ordem_compra
		and	n.ie_situacao = '1');

c00 CURSOR FOR
SELECT  distinct
	cd_material,
	cd_unidade_medida_compra,
	nr_item_oci,
	nr_seq_lote,
	qt_material
from	ordem_compra_item_cb
where	nr_ordem_compra 	= nr_ordem_compra_p
and	ie_atende_recebe	= 'A';		
		

BEGIN



select	cd_natureza_operacao,
	cd_serie_nf,
	nr_sequencia_nf,
	nr_nota_fiscal,
	substr(obter_cgc_estabelecimento(cd_estabelecimento_p),1,14)
into STRICT	cd_natureza_operacao_w,
	cd_serie_nf_w,
	nr_sequencia_nf_w,
	nr_nota_fiscal_w,
	cd_cgc_estab_w
from	nota_fiscal
where	nr_sequencia = nr_seq_nf_p;

if (ie_item_nf	= 0) then
	begin

	OPEN C01;
	LOOP
	FETCH C01 into
		nr_item_oci_w,
		cd_material_w,
		cd_unidade_medida_compra_w,
		vl_unitario_item_nf_w,
		pr_descontos_w,
		ds_material_direto_w,
		ds_observacao_item_w,
	--	cd_centro_custo_w,
		pr_desc_financ_w,
		dt_prevista_entrega_w,
		vl_desconto_oci_w,
		vl_frete_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		select	coalesce(max(nr_item_nf), 0) + 1
		into STRICT	nr_item_nf_w
		from	nota_fiscal_item
		where	nr_sequencia = nr_seq_nf_p;

		select	substr(obter_dados_material_estab(cd_material,cd_estabelecimento_p,'UME'),1,30) cd_unidade_medida_estoque,
			qt_conv_compra_estoque,
			cd_material_estoque
		into STRICT	cd_unidade_medida_estoque_w,
			qt_conv_compra_estoque_w,
			cd_material_estoque_w
		from	material
		where	cd_material = cd_material_w;

		select	coalesce(max(coalesce(qt_prevista_entrega,0) - coalesce(qt_real_entrega,0)),0)
		into STRICT	qt_prevista_entrega_w
		from	ordem_compra_item_entrega
		where	nr_ordem_compra		= nr_ordem_compra_p
		and	nr_item_oci		= nr_item_oci_w
		and	dt_prevista_entrega		= dt_prevista_entrega_w
		and	coalesce(dt_cancelamento::text, '') = '';

		qt_item_estoque_w		:= qt_prevista_entrega_w * qt_conv_compra_estoque_w;
		if (cd_unidade_medida_compra_w = cd_unidade_medida_estoque_w) then
			qt_item_estoque_w	:= qt_prevista_entrega_w;
		end if;

		select	obter_dados_ult_compra_data(cd_estabelecimento_p, cd_material_w, null, clock_timestamp(), 0, 'VU')
		into STRICT	vl_unitario_item_nf_w
		;

		vl_total_item_nf_w		:= (qt_prevista_entrega_w * vl_unitario_item_nf_w);
		vl_desconto_w		:= dividir((vl_total_item_nf_w * pr_descontos_w), 100) + coalesce(vl_desconto_oci_w,0);
		vl_liquido_w		:=  vl_total_item_nf_w - vl_desconto_w;

		ie_tipo_conta_w		:= 3;
		if (coalesce(cd_centro_custo_w::text, '') = '') then
			ie_tipo_conta_w	:= 2;
		end if;
		SELECT * FROM define_conta_material(
			cd_estabelecimento_p, cd_material_w, ie_tipo_conta_w, 0, 0, 0, 0, 0, 0, 0, cd_local_estoque_p, cd_natureza_operacao_w, trunc(clock_timestamp()), cd_conta_contabil_w, cd_centro_conta_w, null) INTO STRICT cd_conta_contabil_w, cd_centro_conta_w;

		insert into nota_fiscal_item(
			nr_sequencia,			cd_estabelecimento,
			cd_cgc_emitente,			cd_serie_nf,
			nr_nota_fiscal,			nr_sequencia_nf,
			nr_item_nf,			cd_natureza_operacao,
			qt_item_nf,			vl_unitario_item_nf,
			vl_total_item_nf,			dt_atualizacao,
			nm_usuario,			vl_frete,
			vl_desconto,			vl_despesa_acessoria,
			cd_material,			cd_local_estoque,
			ds_observacao,			ds_complemento,
			cd_unidade_medida_compra,		qt_item_estoque,
			cd_unidade_medida_estoque,		cd_conta_contabil,
			vl_desconto_rateio,			vl_seguro,
			cd_material_estoque,
			nr_ordem_compra,			vl_liquido,
			pr_desconto,			nr_item_oci,
			dt_entrega_ordem,			nr_seq_conta_financ,
			pr_desc_financ, cd_sequencia_parametro)
		values (	nr_seq_nf_p,			cd_estabelecimento_p,
			cd_cgc_estab_w,			cd_serie_nf_w,
			nr_nota_fiscal_w,			nr_sequencia_nf_w,
			nr_item_nf_w,			cd_natureza_operacao_w,
			qt_prevista_entrega_w,		vl_unitario_item_nf_w,
			vl_total_item_nf_w,			clock_timestamp(),
			nm_usuario_p, 			vl_frete_w,
			coalesce(vl_desconto_w,0),		0,
			cd_material_w, 			cd_local_estoque_p,
			ds_observacao_item_w,		ds_material_direto_w,
			cd_unidade_medida_compra_w,	qt_item_estoque_w,
			cd_unidade_medida_estoque_w,	cd_conta_contabil_w,
			0,				0,
			cd_material_estoque_w,
			nr_ordem_compra_p,		vl_liquido_w,
			pr_descontos_w,			nr_item_oci_w,
			dt_prevista_entrega_w,		null,
			pr_desc_financ_w, philips_contabil_pck.get_parametro_conta_contabil);
		end;
	end loop;
	close c01;
	end;
end if;	

if (ie_item_nf = 1) then
	OPEN C00;
		LOOP
		FETCH C00 into
		cd_material_w,
		cd_unidade_medida_compra_w,
		nr_item_oci_w,
		nr_seq_lote_w,
		qt_prevista_entrega_w;
	EXIT WHEN NOT FOUND; /* apply on c00 */
		
		begin

		
			if (nr_seq_lote_w IS NOT NULL AND nr_seq_lote_w::text <> '') then			
				select	dt_validade,
					coalesce(max(ds_lote_fornec),'')
				into STRICT	dt_validade_w,
					ds_lote_fornec_w
				from 	material_lote_fornec
				where	nr_sequencia = nr_seq_lote_w
				group by dt_validade;
				
				if (coalesce(dt_validade_w::text, '') = '') then
					ie_indeterminado_w := 'S';
				end if;	
			else
				dt_validade_w 		:= '';
				ds_lote_fornec_w	:= '';
			end if;
				
			select	dt_entrega
			into STRICT	dt_prevista_entrega_w
			from	ordem_compra
			where	nr_ordem_compra = nr_ordem_compra_p;


			select	coalesce(max(nr_item_nf), 0) + 1
			into STRICT	nr_item_nf_w
			from	nota_fiscal_item
			where	nr_sequencia = nr_seq_nf_p;

			select	substr(obter_dados_material_estab(cd_material,cd_estabelecimento_p,'UME'),1,30) cd_unidade_medida_estoque,
					qt_conv_compra_estoque,
					cd_material_estoque
			into STRICT	cd_unidade_medida_estoque_w,
					qt_conv_compra_estoque_w,
					cd_material_estoque_w
			from	material
			where	cd_material = cd_material_w;

			qt_item_estoque_w	:= qt_prevista_entrega_w * qt_conv_compra_estoque_w;
			if (cd_unidade_medida_compra_w = cd_unidade_medida_estoque_w) then
				qt_item_estoque_w	:= qt_prevista_entrega_w;
			end if;

			select	obter_valor_ultima_compra(cd_estabelecimento_p, 999, cd_material_w, null, 'N')
			into STRICT	vl_unitario_item_nf_w
			;

			vl_total_item_nf_w	:= (qt_prevista_entrega_w * vl_unitario_item_nf_w);
			vl_liquido_w	:=  vl_total_item_nf_w;

			ie_tipo_conta_w	:= 3;
			if (coalesce(cd_centro_custo_w::text, '') = '') then
				ie_tipo_conta_w	:= 2;
			end if;


			SELECT * FROM define_conta_material(
				cd_estabelecimento_p, cd_material_w, ie_tipo_conta_w, 0, 0, 0, 0, 0, 0, 0, cd_local_estoque_p, cd_natureza_operacao_w, trunc(clock_timestamp()), cd_conta_contabil_w, cd_centro_conta_w, null) INTO STRICT cd_conta_contabil_w, cd_centro_conta_w;

			insert into nota_fiscal_item(
				nr_sequencia,			cd_estabelecimento,
				cd_cgc_emitente,		cd_serie_nf,
				nr_nota_fiscal,			nr_sequencia_nf,
				nr_item_nf,			cd_natureza_operacao,
				qt_item_nf,			vl_unitario_item_nf,
				vl_total_item_nf,		dt_atualizacao,
				nm_usuario,			vl_frete,
				vl_desconto,			vl_despesa_acessoria,
				cd_material,			cd_local_estoque,
				ds_observacao,			ds_complemento,
				cd_unidade_medida_compra,	qt_item_estoque,
				cd_unidade_medida_estoque,	cd_conta_contabil,
				vl_desconto_rateio,		vl_seguro,
				cd_material_estoque,
				nr_ordem_compra,		vl_liquido,
				pr_desconto,			nr_item_oci,
				dt_entrega_ordem,		nr_seq_conta_financ,
				pr_desc_financ,			cd_lote_fabricacao,
				ie_indeterminado,		dt_validade,
				cd_sequencia_parametro)
			values (	nr_seq_nf_p,			cd_estabelecimento_p,
				cd_cgc_estab_w,			cd_serie_nf_w,
				nr_nota_fiscal_w,		nr_sequencia_nf_w,
				nr_item_nf_w,			cd_natureza_operacao_w,
				qt_prevista_entrega_w,		vl_unitario_item_nf_w,
				vl_total_item_nf_w,			clock_timestamp(),
				nm_usuario_p, 			coalesce(vl_frete_w,0),
				coalesce(vl_desconto_w,0),		0,
				cd_material_w, 			cd_local_estoque_p,
				'',				ds_material_direto_w,
				cd_unidade_medida_compra_w,	qt_item_estoque_w,
				cd_unidade_medida_estoque_w,	cd_conta_contabil_w,
				0,				0,
				cd_material_estoque_w,
				nr_ordem_compra_p,		vl_liquido_w,		
				0,				nr_item_oci_w,
				dt_prevista_entrega_w,		nr_seq_conta_financeira_w,
				0,				ds_lote_fornec_w,
				ie_indeterminado_w,		dt_validade_w,
				philips_contabil_pck.get_parametro_conta_contabil);

		end;
		end loop;
		close c00;

end if;

delete FROM ordem_compra_item_cb
where nr_ordem_compra = nr_ordem_compra_p;
	
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE incluir_oc_nf_transf ( nr_seq_nf_p bigint, nr_ordem_compra_p bigint, cd_estabelecimento_p bigint, cd_local_estoque_p bigint, nm_usuario_p text, ie_item_nf bigint) FROM PUBLIC;

