-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_gerar_nota_servico_serv ( nr_seq_cobranca_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nm_prestador_w			varchar(40);
nm_profissional_prestador_w	varchar(40);
nm_medico_req_w			varchar(40);
nr_cons_prof_prest_w		varchar(15);
nr_cons_prof_req_w		varchar(15);
nr_cnpj_cpf_w			varchar(14);
cd_prestador_w			varchar(14);
sg_cons_prof_prest_w		varchar(12);
cd_medico_solic_w		varchar(10);
sg_cons_prof_req_w		varchar(10);
nr_cpf_pessoa_ficia_w		varchar(10);
cd_cnes_w			varchar(7);
cd_estabelecimento_w		varchar(4);
sg_uf_cons_prest_w		valor_dominio.vl_dominio%type;
sg_uf_cons_req_w		valor_dominio.vl_dominio%type;
ie_tipo_vinculo_w		varchar(1);
ie_tipo_pessoa_pres_w		varchar(1);
ie_tipo_participacao_w		varchar(2);
ie_pacote_w			varchar(1);
ie_reembolso_w			varchar(1);
ie_tipo_prestador_w		varchar(1);
ie_rede_propria_w		varchar(1);
cd_porte_anest_w		varchar(1);
cd_ato_w			varchar(1);
ie_tipo_conta_w			varchar(1);
vl_procedimento_w		double precision;
vl_custo_operacional_w		double precision;
vl_filme_w			double precision;
vl_procedimento_imp_w		double precision;
tx_ajuste_filme_w		double precision;
tx_ajuste_custo_oper_w		double precision;
tx_procedimento_w		double precision;
cd_procedimento_w		bigint;
nr_nota_w			ptu_nota_servico.nr_nota%type;
nr_seq_conta_w			bigint;
ie_origem_proced_w		bigint;
nr_nota_fiscal_w		bigint;
nr_seq_lote_w			bigint;
cd_guia_w			varchar(20);
nr_seq_protocolo_w		bigint;
nr_nr_seq_fatura_w		bigint;
nr_seq_prest_exec_w		bigint;
nr_seq_grau_part_w		bigint;
nr_seq_grau_part_ww		bigint;
nr_seq_tipo_prest_w		bigint;
nr_seq_conta_proc_w		bigint;
nr_seq_cbo_saude_w		bigint;
nr_seq_servico_w		bigint;
nr_seq_prestador_w		bigint;
qt_procedimento_w		integer;
cd_especialidade_med_w		integer;
cd_unim_prestador_w		smallint;
cd_tipo_prestador_w		smallint;
ie_via_acesso_w			smallint;
cd_especialidade_w		smallint;
ie_tipo_despesa_w		smallint;
ie_tipo_tabela_w		smallint;
dt_procedimento_w		timestamp;
dt_inicio_proc_w		timestamp;

 
C01 CURSOR FOR 
	SELECT	'P', 
		b.nr_sequencia, 
		a.nr_sequencia, 
		c.dt_inicio_proc, 
		coalesce(d.nr_seq_cbo_saude,b.nr_seq_cbo_saude), 
		CASE WHEN c.ie_via_acesso='U' THEN 0 WHEN c.ie_via_acesso='M' THEN 1 WHEN c.ie_via_acesso='D' THEN 2  ELSE '' END , 
		substr(c.cd_porte_anestesico,1,1), 
		b.cd_medico_solicitante, 
		coalesce(d.nr_seq_grau_partic,b.nr_seq_grau_partic), 
		b.nr_seq_prestador_exec, 
		coalesce(c.dt_procedimento,clock_timestamp()), 
		substr(c.ie_tipo_despesa,1,1), 
		c.cd_procedimento, 
		substr(c.ie_origem_proced,1,10), 
		coalesce(c.qt_procedimento,0), 
		substr(c.vl_procedimento,1,14), 
		substr(c.vl_custo_operacional,1,14), 
		substr(b.cd_cnes,1,7), 
		CASE WHEN c.nr_sequencia='' THEN 'N'  ELSE 'S' END , 
		b.cd_guia, 
		c.tx_item, 
		c.ie_ato_cooperado 
	FROM pls_conta b, pls_protocolo_conta a, pls_conta_proc c
LEFT OUTER JOIN pls_proc_participante d ON (c.nr_sequencia = d.nr_seq_conta_proc)
WHERE c.nr_seq_conta		= b.nr_sequencia and b.nr_seq_protocolo	= a.nr_sequencia  and b.nr_seq_serv_pre_pagto	= nr_seq_servico_w 
	 
UNION
 
	SELECT	'M', 
		b.nr_sequencia, 
		a.nr_sequencia, 
		c.dt_inicio_atend, 
		null, 
		null, 
		null, 
		b.cd_medico_solicitante, 
		b.nr_seq_grau_partic, 
		b.nr_seq_prestador_exec, 
		coalesce(c.dt_atendimento,clock_timestamp()), 
		substr(c.ie_tipo_despesa,1,1), 
		c.nr_seq_material, 
		substr(c.ie_origem_preco,1,10), 
		c.qt_material, 
		substr(c.vl_material,1,14), 
		null, 
		substr(b.cd_cnes,1,7), 
		CASE WHEN c.nr_sequencia='' THEN 'N'  ELSE 'S' END , 
		b.cd_guia, 
		c.tx_participacao, 
		c.ie_ato_cooperado 
	from	pls_conta_mat		c, 
		pls_conta		b, 
		pls_protocolo_conta	a 
	where	c.nr_seq_conta		= b.nr_sequencia 
	and	b.nr_seq_protocolo	= a.nr_sequencia 
	and	b.nr_seq_serv_pre_pagto	= nr_seq_servico_w;
	

BEGIN 
 
select	nr_seq_serv_pre_pagto 
into STRICT	nr_seq_servico_w 
from	ptu_nota_cobranca 
where	nr_sequencia	= nr_seq_cobranca_p;
 
select	cd_estabelecimento 
into STRICT	cd_estabelecimento_w 
from	ptu_servico_pre_pagto 
where	nr_sequencia	= nr_seq_servico_w;
 
cd_unim_prestador_w	:= pls_obter_unimed_estab(cd_estabelecimento_w);
open C01;
loop 
fetch C01 into 
	ie_tipo_conta_w, 
	nr_seq_conta_w, 
	nr_seq_protocolo_w, 
	dt_inicio_proc_w, 
	nr_seq_cbo_saude_w, 
	ie_via_acesso_w, 
	cd_porte_anest_w, 
	cd_medico_solic_w, 
	nr_seq_grau_part_w, 
	nr_seq_prest_exec_w, 
	dt_procedimento_w, 
	ie_tipo_despesa_w, 
	cd_procedimento_w, 
	ie_origem_proced_w, 
	qt_procedimento_w, 
	vl_procedimento_w, 
	vl_custo_operacional_w, 
	cd_cnes_w, 
	ie_reembolso_w, 
	cd_guia_w, 
	tx_procedimento_w, 
	cd_ato_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	begin 
	select	nr_sequencia, 
		CASE WHEN coalesce(cd_pessoa_fisica::text, '') = '' THEN cd_cgc  ELSE cd_pessoa_fisica END , 
		substr(CASE WHEN coalesce(cd_cgc::text, '') = '' THEN  'F'  ELSE 'J' END ,1,2), 
		substr(obter_nome_pf_pj(cd_pessoa_fisica, cd_cgc),1,40), 
		substr(pls_obter_se_cooperado(cd_pessoa_fisica, cd_cgc),1,1) 
	into STRICT	nr_seq_prestador_w, 
		nr_cnpj_cpf_w, 
		ie_tipo_pessoa_pres_w, 
		nm_prestador_w, 
		ie_rede_propria_w 
	from	pls_prestador 
	where	nr_sequencia	= nr_seq_prest_exec_w;
	exception 
	when others then 
		nr_seq_prestador_w	:= null;
		nr_cnpj_cpf_w		:= null;
		ie_tipo_pessoa_pres_w	:= null;
		ie_rede_propria_w	:= null;
		ie_rede_propria_w	:= null;
	end;
	 
	begin 
	select	substr(obter_nome_medico(cd_medico,'N'),1,40), 
		substr(obter_dados_medico(cd_medico,'SGCRM'),1,12), 
		substr(obter_dados_medico(cd_medico,'CRM'),1,15), 
		substr(obter_dados_medico(cd_medico,'UFCRM'),1,2) 
	into STRICT	nm_profissional_prestador_w, 
		sg_cons_prof_prest_w, 
		nr_cons_prof_prest_w, 
		sg_uf_cons_prest_w 
	from	pls_prestador_medico 
	where	nr_sequencia	= (	SELECT	max(nr_sequencia) 
					from	pls_prestador_medico 
					where	nr_seq_prestador = nr_seq_prestador_w 
					and	ie_situacao		= 'A' 
					and	trunc(coalesce(dt_procedimento_w,clock_timestamp()),'dd') 
									between trunc(coalesce(dt_inclusao,coalesce(dt_procedimento_w,clock_timestamp())),'dd') 
									and fim_dia(coalesce(dt_exclusao,coalesce(dt_procedimento_w,clock_timestamp()))));
	exception 
	when others then 
		nm_profissional_prestador_w	:= null;
		sg_cons_prof_prest_w		:= null;
		nr_cons_prof_prest_w		:= null;
		sg_uf_cons_prest_w		:= null;
	end;
	 
	begin 
	select	max(nr_seq_tipo) 
	into STRICT	nr_seq_tipo_prest_w 
	from	pls_prestador_tipo 
	where	nr_seq_prestador	= nr_seq_prestador_w 
	and	clock_timestamp() between coalesce(dt_inicio_vigencia, clock_timestamp() - interval '1 days') and coalesce(dt_fim_vigencia, clock_timestamp() + interval '1 days');
	exception 
	when others then 
		nr_seq_tipo_prest_w	:= null;
	end;
	 
	begin 
	select	coalesce(max(ie_tipo_ptu),'1') 
	into STRICT	ie_tipo_prestador_w 
	from	pls_tipo_prestador 
	where	nr_sequencia	= nr_seq_tipo_prest_w;
	exception 
	when others then 
		ie_tipo_prestador_w	:= null;
	end;
	 
	begin 
	select	substr(vl_filme,1,14) 
	into STRICT	vl_filme_w 
	from	pls_regra_preco_proc 
	where	nr_sequencia	= (SELECT max(nr_sequencia) from pls_regra_preco_proc where nr_seq_prestador = nr_seq_prestador_w);
	exception 
	when others then 
		vl_filme_w := 0;	
	end;
	select	coalesce(max(cd_ptu),'1') 
	into STRICT	ie_tipo_participacao_w 
	from	pls_grau_participacao 
	where	nr_sequencia	= nr_seq_grau_part_w;
	 
	begin 
	select	coalesce(b.uf_crm,'SC'), 
		a.nr_seq_conselho, 
		c.sg_conselho 
	into STRICT	sg_uf_cons_req_w, 
		nr_cons_prof_req_w, 
		sg_cons_prof_req_w 
	from	conselho_profissional	c, 
		medico			b, 
		pessoa_fisica		a 
	where	b.cd_pessoa_fisica	= a.cd_pessoa_fisica 
	and	a.nr_seq_conselho	= c.nr_sequencia 
	and	a.cd_pessoa_fisica	= cd_medico_solic_w;
	exception 
	when others then 
		sg_uf_cons_req_w	:= 'SC';
		nr_cons_prof_req_w	:= 1;
		sg_cons_prof_req_w	:= 'CRM';
	end;
	 
	select	max(cd_especialidade) 
	into STRICT	cd_especialidade_med_w 
	from	medico_especialidade 
	where	nr_seq_cbo_saude	= nr_seq_cbo_saude_w;
	 
	select	coalesce(max(cd_ptu),1) 
	into STRICT	cd_especialidade_w 
	from	especialidade_medica 
	where	cd_especialidade	= cd_especialidade_med_w;
	 
	if (ie_tipo_conta_w = 'P') then 
		if (ie_tipo_despesa_w 	= 1) then 
			ie_tipo_tabela_w	:= 0;
		elsif (ie_tipo_despesa_w	= 2) then 
			ie_tipo_tabela_w	:= 1;
		elsif (ie_tipo_despesa_w	= 3) then 
			ie_tipo_tabela_w	:= 1;
		elsif (ie_tipo_despesa_w	= 4) then 
			ie_tipo_tabela_w	:= 2;
		end if;
	elsif (ie_tipo_conta_w = 'M') then 
		if (ie_tipo_despesa_w 	= 1) then 
			ie_tipo_tabela_w	:= 2;
		elsif (ie_tipo_despesa_w 	= 2) then 
			ie_tipo_tabela_w	:= 3;
		elsif (ie_tipo_despesa_w 	= 3) then 
			ie_tipo_tabela_w	:= 2;
		elsif (ie_tipo_despesa_w 	= 7) then 
			ie_tipo_tabela_w	:= 2;
		end if;
	end if;
	 
	nr_seq_lote_w	:= nr_seq_conta_w+nr_seq_protocolo_w;
	 
	insert into ptu_nota_servico(nr_sequencia, dt_atualizacao, nm_usuario, 
		dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_nota_cobr, 
		nr_lote, cd_unimed_prestador, cd_prestador, 
		nm_prestador, ie_tipo_participacao, dt_procedimento, 
		cd_procedimento, ie_origem_proced, qt_procedimento, 
		ie_tipo_prestador, ie_rede_propria, ie_tipo_pessoa_prestador, 
		nr_cgc_cpf, tx_procedimento, ie_pacote, 
		cd_ato, ie_tipo_tabela, nr_cgc_cpf_req, 
		nm_prestador_requisitante, sg_cons_prof_req, nr_cons_prof_req, 
		sg_uf_cons_req, ie_reembolso, nr_autorizacao, 
		nr_nota, vl_procedimento, vl_custo_operacional, 
		vl_filme, cd_porte_anestesico, cd_unimed_autorizadora, 
		cd_unimed_pre_req, cd_prestador_req, ie_via_acesso, 
		vl_adic_procedimento, vl_adic_co, vl_adic_filme, 
		cd_especialidade, nr_seq_nota, ds_hora_procedimento, 
		cd_cnes_prest, nm_profissional_prestador, sg_cons_prof_prest, 
		nr_cons_prof_prest, sg_uf_cons_prest) 
	values (nextval('ptu_nota_servico_seq'), clock_timestamp(), nm_usuario_p, 
		clock_timestamp(), nm_usuario_p, nr_seq_cobranca_p, 
		nr_seq_lote_w, cd_unim_prestador_w, substr(nr_seq_prestador_w,1,8), 
		nm_prestador_w, ie_tipo_participacao_w, dt_procedimento_w, 
		cd_procedimento_w, ie_origem_proced_w, qt_procedimento_w, 
		ie_tipo_prestador_w, ie_rede_propria_w, ie_tipo_pessoa_pres_w, 
		nr_cnpj_cpf_w, coalesce(tx_procedimento_w,1), 'N', 
		coalesce(cd_ato_w,'1'), ie_tipo_tabela_w, cd_medico_solic_w, 
		nm_profissional_prestador_w, sg_cons_prof_req_w, nr_cons_prof_req_w, 
		sg_uf_cons_req_w, ie_reembolso_w, cd_guia_w, 
		nr_seq_conta_w, vl_procedimento_w, vl_custo_operacional_w, 
		vl_filme_w, cd_porte_anest_w, 1, 
		cd_unim_prestador_w, 1, ie_via_acesso_w, 
		1, 1, 1, 
		cd_especialidade_w, nr_seq_conta_w, to_char(dt_procedimento_w,'hh24:mi:ss'), 
		cd_cnes_w, nm_profissional_prestador_w, sg_cons_prof_prest_w, 
		nr_cons_prof_prest_w, sg_uf_cons_prest_w);
		 
	end;
end loop;
close C01;
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_gerar_nota_servico_serv ( nr_seq_cobranca_p bigint, nm_usuario_p text) FROM PUBLIC;

