-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baixar_item_solic_bionexo ( nr_ordem_compra_p bigint, nr_solic_compra_p bigint, nr_item_solic_compra_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_solic_compra_w				bigint;
nr_cot_compra_w				bigint;
nr_item_cot_compra_w			integer;
dt_baixa_w				timestamp;


BEGIN 
 
update	solic_compra_item 
set 	dt_baixa 	= clock_timestamp(),		 
	ds_observacao		= substr(WHEB_MENSAGEM_PCK.get_texto(297887,'DS_OBSERVACAO_W=' || ds_observacao || ';' || 'NR_ORDEM_COMPRA_P=' || nr_ordem_compra_p),1,2000) 
where	nr_solic_compra 		= nr_solic_compra_p 
and	nr_item_solic_compra	= nr_item_solic_compra_p 
and	coalesce(dt_baixa::text, '') = '';
 
CALL gerar_hist_solic_sem_commit( 
			nr_solic_compra_p, 
			WHEB_MENSAGEM_PCK.get_texto(297888), 
			WHEB_MENSAGEM_PCK.get_texto(297890,'NR_ITEM_SOLIC_COMPRA_P=' || nr_item_solic_compra_p || ';' || 'NR_ORDEM_COMPRA_P=' || nr_ordem_compra_p), 
			'B', 
			nm_usuario_p);
 
update	solic_compra 
set	dt_baixa		= clock_timestamp() 
where	nr_solic_compra	= nr_solic_compra_p 
and	not exists ( 
	SELECT 1 
	from	solic_compra_item 
	where	nr_solic_compra = nr_solic_compra_p 
	and	coalesce(dt_baixa::text, '') = '');
 
select	dt_baixa 
into STRICT	dt_baixa_w 
from	solic_compra 
where	nr_solic_compra	= nr_solic_compra_p;
 
if (dt_baixa_w IS NOT NULL AND dt_baixa_w::text <> '') then 
	CALL gerar_hist_solic_sem_commit( 
			nr_solic_compra_p, 
			WHEB_MENSAGEM_PCK.get_texto(297891), 
			WHEB_MENSAGEM_PCK.get_texto(297892,'NR_ORDEM_COMPRA_P=' || nr_ordem_compra_p), 
			'B', 
			nm_usuario_p);	
end if;
	 
update	processo_aprov_compra a 
set	a.ie_aprov_reprov = 'B', 
	a.ds_observacao = substr(WHEB_MENSAGEM_PCK.get_texto(297893,'DS_OBSERVACAO_W=' || a.ds_observacao || ';' || 'NR_ORDEM_COMPRA_P=' || nr_ordem_compra_p),1,2000) 
where	a.nr_sequencia in ( 
	SELECT	distinct(nr_seq_aprovacao) 
	from	solic_compra_item 
	where	nr_solic_compra = nr_solic_compra_p) 
and	ie_aprov_reprov = 'P' 
and	not exists ( 
	SELECT	1 
	from	solic_compra_item x 
	where	x.nr_seq_aprovacao = a.nr_sequencia 
	and	coalesce(dt_baixa::text, '') = '');
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baixar_item_solic_bionexo ( nr_ordem_compra_p bigint, nr_solic_compra_p bigint, nr_item_solic_compra_p bigint, nm_usuario_p text) FROM PUBLIC;

