-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_valores_dif_diaria ( nr_atendimento_p bigint, cd_estabelecimento_p bigint, cd_tipo_acomodacao_p bigint, dt_referencia_p timestamp, qt_dia_int_p bigint, ie_cancelar_dif_diaria_p INOUT text, ds_procedimento_p INOUT text, ie_origem_proced_p INOUT bigint, vl_categoria_p INOUT bigint, vl_diferenca_p INOUT bigint, ie_calculo_diferenca_p INOUT text, nm_usuario_p text) AS $body$
DECLARE

 
cd_convenio_w			integer;
cd_categoria_w			bigint;
cd_tipo_acomod_convenio_w		smallint;
cd_procedimento_w		bigint;
ds_procedimento_w			procedimento.ds_procedimento%TYPE := '';
ie_origem_proced_w		bigint;
vl_categoria_w			double precision;
vl_diferenca_w			double precision;
ie_calculo_diferenca_w		varchar(1);
ie_cancelar_dif_diaria_w		varchar(1);
ie_paciente_isolado_w		varchar(1);
cd_plano_w			varchar(10);


BEGIN 
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then 
	begin 
	 
	cd_convenio_w			:=	obter_convenio_atendimento(nr_atendimento_p);
	cd_categoria_w			:=	obter_categoria_atendimento(nr_atendimento_p);
	cd_plano_w			:=	obter_plano_atendimento(nr_atendimento_p,'C');
	cd_tipo_acomod_convenio_w	:=	obter_tipo_acomod_atend(nr_atendimento_p,'C');
	 
	select 	coalesce(max(ie_paciente_isolado),'A') 
	into STRICT	ie_paciente_isolado_w 
	from 	atendimento_paciente 
	where 	nr_atendimento = nr_atendimento_p;
	 
	SELECT * FROM calcular_diferenca_diaria( 
		cd_estabelecimento_p, cd_convenio_w, cd_categoria_w, cd_plano_w, cd_tipo_acomod_convenio_w, cd_tipo_acomodacao_p, dt_referencia_p, qt_dia_int_p, ie_paciente_isolado_w, cd_procedimento_w, ie_origem_proced_w, vl_categoria_w, vl_diferenca_w, ie_calculo_diferenca_w) INTO STRICT cd_procedimento_w, ie_origem_proced_w, vl_categoria_w, vl_diferenca_w, ie_calculo_diferenca_w;
 
	if (coalesce(cd_procedimento_w,0) > 0) then 
		begin 
		select	ds_procedimento 
		into STRICT	ds_procedimento_w 
		from	procedimento 
		where	cd_procedimento		= cd_procedimento_w 
		and	ie_origem_proced	= ie_origem_proced_w;
		end;
	end if;
	 
	select	ie_cancelar_dif_diaria 
	into STRICT	ie_cancelar_dif_diaria_w 
	from	parametro_faturamento 
	where	cd_estabelecimento	=	cd_estabelecimento_p;
	end;
end if;
ie_origem_proced_p	:=	ie_origem_proced_w;
vl_categoria_p		:=	vl_categoria_w;
vl_diferenca_p		:=	vl_diferenca_w;
ie_calculo_diferenca_p	:=	ie_calculo_diferenca_w;
ds_procedimento_p	:=	ds_procedimento_w;
ie_cancelar_dif_diaria_p:=	ie_cancelar_dif_diaria_w;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_valores_dif_diaria ( nr_atendimento_p bigint, cd_estabelecimento_p bigint, cd_tipo_acomodacao_p bigint, dt_referencia_p timestamp, qt_dia_int_p bigint, ie_cancelar_dif_diaria_p INOUT text, ds_procedimento_p INOUT text, ie_origem_proced_p INOUT bigint, vl_categoria_p INOUT bigint, vl_diferenca_p INOUT bigint, ie_calculo_diferenca_p INOUT text, nm_usuario_p text) FROM PUBLIC;

