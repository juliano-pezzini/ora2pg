-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_nota_fiscal_conta ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
nr_sequencia_w			nota_fiscal.nr_sequencia%type;
cd_estabelecimento_w		nota_fiscal.cd_estabelecimento%type;	
cd_cgc_emitente_w		nota_fiscal.cd_cgc_emitente%type;
cd_cgc_w			nota_fiscal.cd_cgc%type;
cd_pessoa_fisica_w		nota_fiscal.cd_pessoa_fisica%type;
ie_operacao_fiscal_w		operacao_nota.ie_operacao_fiscal%type;
ie_conta_dif_nf_w		varchar(1);
ie_param_469_w			varchar(1);
nr_count_w			bigint;


BEGIN 
 
ie_conta_dif_nf_w := 'N';
 
select	count(1), 
	max(cd_estabelecimento), 
	max(cd_cgc_emitente), 
	max(cd_cgc), 
	max(cd_pessoa_fisica) 
into STRICT	nr_count_w, 
	cd_estabelecimento_w, 
	cd_cgc_emitente_w, 
	cd_cgc_w, 
	cd_pessoa_fisica_w 
from	nota_fiscal 
where	nr_sequencia = nr_sequencia_p;
 
ie_param_469_w := substr(coalesce(obter_valor_param_usuario(40, 469, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w), 'N'),1,1);
 
if (nr_count_w > 0) then 
	begin 
	 
	select max(o.ie_operacao_fiscal) 
	into STRICT	ie_operacao_fiscal_w 
	from 	nota_fiscal n, 
		operacao_nota o 
	where	n.nr_sequencia = nr_sequencia_p 
    and 	n.cd_operacao_nf = o.cd_operacao_nf;
	 
	if (ie_operacao_fiscal_w = 'E') then 
		 
		select	substr(coalesce(obter_dados_pf_pj_estab(cd_estabelecimento_w, null, cd_cgc_emitente_w,'ECD'),'N'),1,1) 
		into STRICT	ie_conta_dif_nf_w		 
		;
		 
	elsif (ie_operacao_fiscal_w = 'S') then             			 
		 
		if	((coalesce(cd_cgc_w::text, '') = '') and (cd_cgc_emitente_w IS NOT NULL AND cd_cgc_emitente_w::text <> '')) then 
			begin 
			 
			select	substr(coalesce(obter_dados_pf_pj_estab(cd_estabelecimento_w, null, cd_cgc_emitente_w,'ECD'),'N'),1,1) 
			into STRICT	ie_conta_dif_nf_w 
			;
			 
			end;
		else 
			begin 
			 
			if (ie_param_469_w = 'S') then 
				select	substr(coalesce(obter_dados_pf_pj_estab(cd_estabelecimento_w, null, cd_cgc_emitente_w,'ECD'),'N'),1,1) 
				into STRICT	ie_conta_dif_nf_w 
				;
			else 
				select	substr(coalesce(obter_dados_pf_pj_estab(cd_estabelecimento_w, null, cd_cgc_w,'ECD'),'N'),1,1) 
				into STRICT	ie_conta_dif_nf_w 
				;
			end if;
			 
			end;
		end if;
		 
	end if;
	 
	if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then 
		begin 
		 
		select	CASE WHEN count(1)=0 THEN 'N'  ELSE 'S' END  
		into STRICT	ie_conta_dif_nf_w 
		from	pessoa_fis_conta_nf 
		where	cd_pessoa_fisica = cd_pessoa_fisica_w;
		 
		end;
	end if;
	 
	if	((ie_conta_dif_nf_w = 'S') or 
		(ie_conta_dif_nf_w = 'E' AND ie_operacao_fiscal_w = 'E') or 
		(ie_conta_dif_nf_w = 'A' AND ie_operacao_fiscal_w = 'S')) then 
		begin 
			CALL gerar_conta_contabil_nf(nr_sequencia_p,nm_usuario_p);
		exception when others then 
			nr_sequencia_w	:= nr_sequencia_p;
		end;
	end if;
	 
	 
	 
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_nota_fiscal_conta ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

