-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ajustar_prescricao_sae ( nr_prescricao_p bigint, nr_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


ie_gerar_prescricao_w		varchar(10);
cd_funcao_origem_w			prescr_medica.cd_funcao_origem%type;
nr_seq_material_w           bigint;
nr_intervencao_w            bigint;
nr_intervalo_w              bigint;
cd_material_w               bigint;
nr_seq_presc_mat_hora_w     bigint;

--Materiais prescritos com mais de 24 horas de intervalo, que sejam de origem da SAE
c01 CURSOR FOR
    SELECT  a.cd_funcao_origem,
            b.nr_seq_pe_proc,
            b.cd_material,
            obter_ocorrencia_intervalo(b.cd_intervalo, coalesce(a.nr_horas_validade, 24), 'H') intervalo
    from    prescr_medica      a,
            prescr_material    b
    where   a.nr_prescricao = nr_prescricao_p
    and     b.nr_prescricao = a.nr_prescricao
    and     obter_se_interv_superior_24h(b.cd_intervalo, null) = 'S'
    and     (b.nr_seq_pe_proc IS NOT NULL AND b.nr_seq_pe_proc::text <> '');


c02 CURSOR FOR
    SELECT  a.nr_sequencia,
            a.nr_seq_material
    from    prescr_mat_hor a
    where   a.nr_atendimento = nr_atendimento_p
    and     a.nr_prescricao  = nr_prescricao_p
    and     coalesce(a.dt_suspensao::text, '') = ''
    --and     coalesce(a.ie_horario_especial,'N') <> 'S'
	and     exists  (
            SELECT  x.nr_sequencia
            from    prescr_mat_hor  x,
                    prescr_material z
            where   z.nr_prescricao  = x.nr_prescricao
            and     z.nr_sequencia   = x.nr_seq_material
            and     x.nr_atendimento = a.nr_atendimento
            and     x.nr_prescricao <> a.nr_prescricao
			and     x.nr_seq_material = a.nr_seq_material
            and     coalesce(x.dt_suspensao::text, '') = ''
			and		a.cd_material = x.cd_material
            and     coalesce(z.ie_administrar, 'S') <> 'N'
            and     x.dt_horario > (a.dt_horario - nr_intervalo_w/24) LIMIT 1);



BEGIN
    ie_gerar_prescricao_w := Obter_Param_Usuario(281, 806, obter_perfil_ativo, nm_usuario_p, coalesce(obter_estab_atend(nr_atendimento_p),0), ie_gerar_prescricao_w);

    if (ie_gerar_prescricao_w = 'C') then

        open c01;
        loop
        fetch c01 into
            cd_funcao_origem_w,
            nr_intervencao_w,
            cd_material_w,
            nr_intervalo_w;
        EXIT WHEN NOT FOUND; /* apply on c01 */
        begin

            open c02;
            loop
            fetch c02 into
                nr_seq_presc_mat_hora_w,
                nr_seq_material_w;
            EXIT WHEN NOT FOUND; /* apply on c02 */
            begin
                update  prescr_material
                set     ie_administrar  = 'N'
                where   nr_prescricao   = nr_prescricao_p
                and     nr_sequencia    = nr_seq_material_w;

                update  prescr_mat_hor
                set     ie_administrar  = 'N'
                where   nr_prescricao   = nr_prescricao_p
                and     nr_sequencia    = nr_seq_presc_mat_hora_w;

                commit;

            end;
            end loop;
            close c02;

        end;
        end loop;
        close c01;

    end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ajustar_prescricao_sae ( nr_prescricao_p bigint, nr_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

