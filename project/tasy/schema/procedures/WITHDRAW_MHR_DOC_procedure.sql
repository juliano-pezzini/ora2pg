-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE withdraw_mhr_doc ( nr_seq_mhr_doc_meta_p mhr_doc_meta.nr_sequencia%type , ds_justificativa_p mhr_doc_meta.ds_justificativa%type , ie_consent_withdrawn_p mhr_doc_meta.ie_consent_withdrawn%type ) AS $body$
DECLARE


ie_status_w			mhr_doc_meta.ie_status%type;
ie_origin_mhr_w		mhr_doc_meta.ie_origin_mhr%type;
ie_doc_type_w		mhr_doc_meta.ie_doc_type%type;


BEGIN

	-- nr_sequencia and justification cannot be null.
	if (nr_seq_mhr_doc_meta_p IS NOT NULL AND nr_seq_mhr_doc_meta_p::text <> '') and (ds_justificativa_p IS NOT NULL AND ds_justificativa_p::text <> '') then


		select 	ie_status,
		ie_origin_mhr,
		ie_doc_type
		into STRICT  	ie_status_w,
		ie_origin_mhr_w,
		ie_doc_type_w
		from 		mhr_doc_meta
		where		nr_sequencia = nr_seq_mhr_doc_meta_p;

		-- cannot withdraw a document: doc type is not discharge summary or event summary, or if doc is from mhr, or if status is not ready.
		if (ie_origin_mhr_w = 'N') and (ie_doc_type_w = 'DS' or ie_doc_type_w = 'ES') and (ie_status_w = 'RU') then

			-- change the status of the doc to either 'withdrawn' or 'withdrawn by patient'
			if (ie_consent_withdrawn_p = 'S') then
				ie_status_w := 'WP';
			else
				ie_status_w := 'WD';
			end if;

			update 		mhr_doc_meta
			set  		ds_justificativa 	 = ds_justificativa_p,
						ie_consent_withdrawn = ie_consent_withdrawn_p,
						ie_status 			 = ie_status_w
			where		nr_sequencia 		 = nr_seq_mhr_doc_meta_p;

			commit;
			return;

		end if;

	end if;

	CALL Wheb_mensagem_pck.exibir_mensagem_abort(1092252);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE withdraw_mhr_doc ( nr_seq_mhr_doc_meta_p mhr_doc_meta.nr_sequencia%type , ds_justificativa_p mhr_doc_meta.ds_justificativa%type , ie_consent_withdrawn_p mhr_doc_meta.ie_consent_withdrawn%type ) FROM PUBLIC;

