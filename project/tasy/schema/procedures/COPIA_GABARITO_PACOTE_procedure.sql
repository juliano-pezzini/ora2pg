-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copia_gabarito_pacote ( nr_seq_pacote_p bigint, nr_seq_acomod_orig_p bigint, nr_seq_acomod_dest_p bigint, ie_apagar_todos_p text, ie_regra_p bigint, nm_usuario_p text) AS $body$
DECLARE



nr_seq_regra_w			bigint;
ie_inclui_exclui_w		varchar(01);
ie_excedente_w			smallint;
cd_grupo_material_w		smallint;
cd_subgrupo_material_w		smallint;
cd_classe_material_w		integer;
cd_material_w			integer;
qt_limite_w			double precision;
ie_tipo_atendimento_w		smallint;
cd_setor_atendimento_w		integer;
cd_area_proced_w		bigint;
cd_especial_proced_w		bigint;
cd_grupo_proced_w		bigint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
ie_considera_honorario_w	varchar(01);
ie_calcula_honorario_w		varchar(01);
ie_calcula_custo_oper_w		varchar(01);
ie_valor_w			varchar(01);
vl_minimo_w			double precision;
vl_maximo_w			double precision;
pr_desconto_w			double precision;
ie_tipo_setor_w			varchar(3);
nr_seq_familia_w		bigint;
cd_centro_custo_w		integer;
ie_ratear_item_w		varchar(1);
vl_negociado_w			double precision;
nr_seq_classif_w		bigint;
nr_seq_estrutura_w		bigint;
cd_local_estoque_w		pacote_material.cd_local_estoque%type;
ie_valida_limite_proc_w		pacote_procedimento.ie_valida_limite_proc%type;
nr_seq_estrutura_proc_w		pacote_procedimento.nr_seq_estrutura%type;

/* 	0 Material
  	1 Procedimento
	2 Ambos
*/
c01 CURSOR FOR
SELECT 	ie_inclui_exclui,
	ie_excedente,
	cd_grupo_material,
	cd_subgrupo_material,
	cd_classe_material,
	cd_material,
	qt_limite,
	ie_tipo_atendimento,
	cd_setor_atendimento,
	ie_valor,
	vl_minimo,
	vl_maximo,
	pr_desconto,
	ie_tipo_setor,
	nr_seq_familia,
	cd_centro_custo,
	ie_ratear_item,
	vl_negociado,
	nr_seq_estrutura,
	cd_local_estoque
from 	pacote_material
where 	nr_seq_pac_acomod = nr_seq_acomod_orig_p
and 	nr_seq_pacote = nr_seq_pacote_p;

c02 CURSOR FOR
SELECT 	ie_inclui_exclui,
	ie_excedente,
	cd_area_proced,
	cd_especial_proced,
	cd_grupo_proced,
	cd_procedimento,
	ie_origem_proced,
	qt_limite,
	ie_considera_honorario,
	cd_setor_atendimento,
	ie_tipo_atendimento,
	ie_calcula_honorario,
	ie_calcula_custo_oper,
	pr_desconto,
	cd_centro_custo,
	nr_seq_classif,
	ie_ratear_item,
	ie_valida_limite_proc,
	nr_seq_estrutura
from 	pacote_procedimento
where 	nr_seq_pac_acomod = nr_seq_acomod_orig_p
and 	nr_seq_pacote = nr_seq_pacote_p;


BEGIN

if (ie_regra_p  (0,2)) then
	
	if (ie_apagar_todos_p = 'S') then
		delete from pacote_material
		where 	nr_seq_pacote = nr_seq_pacote_p
		and 	nr_seq_pac_acomod = nr_seq_acomod_dest_p;		
	end if;

	open	c01;
	loop
	fetch	c01 into	
		ie_inclui_exclui_w,
		ie_excedente_w,
		cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w,
		cd_material_w,
		qt_limite_w,
		ie_tipo_atendimento_w,
		cd_setor_atendimento_w,
		ie_valor_w,
		vl_minimo_w,
		vl_maximo_w,
		pr_desconto_w,
		ie_tipo_setor_w,
		nr_seq_familia_w,
		cd_centro_custo_w,
		ie_ratear_item_w,
		vl_negociado_w,
		nr_seq_estrutura_w,
		cd_local_estoque_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		select	nextval('pacote_material_seq')
		into STRICT	nr_seq_regra_w
		;
		

		insert into pacote_material(nr_seq_pacote,
			nr_sequencia,
			ie_inclui_exclui,
			dt_atualizacao,
			nm_usuario,
			ie_excedente,
			cd_grupo_material,
			cd_subgrupo_material,
			cd_classe_material,
			cd_material,
			qt_limite,
			ie_tipo_atendimento,
			cd_setor_atendimento,
			nr_seq_pac_acomod,
			ie_valor,
			vl_minimo,
			vl_maximo,
			pr_desconto,
			ie_tipo_setor,
			nr_seq_familia,
			cd_centro_custo,
			ie_ratear_item,
			vl_negociado,
			nr_seq_estrutura,
			cd_local_estoque)
		values (nr_seq_pacote_p,
			nr_seq_regra_w,
			ie_inclui_exclui_w,
			clock_timestamp(),
			nm_usuario_p,
			ie_excedente_w,
			cd_grupo_material_w,
			cd_subgrupo_material_w,
			cd_classe_material_w,
			cd_material_w,
			qt_limite_w,
			ie_tipo_atendimento_w,
			cd_setor_atendimento_w,
			nr_seq_acomod_dest_p,
			ie_valor_w,
			vl_minimo_w,
			vl_maximo_w,
			pr_desconto_w,
			ie_tipo_setor_w,
			nr_seq_familia_w,
			cd_centro_custo_w,
			ie_ratear_item_w,
			vl_negociado_w,
			nr_seq_estrutura_w,
			cd_local_estoque_w);
		end;
	end loop;
	close c01;

end if;

if (ie_regra_p in (1,2)) then

	if (ie_apagar_todos_p = 'S') then
		delete from pacote_procedimento
		where 	nr_seq_pacote = nr_seq_pacote_p
		and 	nr_seq_pac_acomod = nr_seq_acomod_dest_p;		
	end if;
	
	open	c02;
	loop
	fetch	c02 into
		ie_inclui_exclui_w,
		ie_excedente_w,
		cd_area_proced_w,
		cd_especial_proced_w,
		cd_grupo_proced_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		qt_limite_w,
		ie_considera_honorario_w,
		cd_setor_atendimento_w,
		ie_tipo_atendimento_w,
		ie_calcula_honorario_w,
		ie_calcula_custo_oper_w,
		pr_desconto_w,
		cd_centro_custo_w,
		nr_seq_classif_w,
		ie_ratear_item_w,
		ie_valida_limite_proc_w,
		nr_seq_estrutura_proc_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin

		select	nextval('pacote_procedimento_seq')
		into STRICT	nr_seq_regra_w
		;
		
		insert into pacote_procedimento(nr_seq_pacote,
			nr_sequencia,
			ie_inclui_exclui,
			dt_atualizacao,
			nm_usuario,
			ie_excedente,
			cd_area_proced,
			cd_especial_proced,
			cd_grupo_proced,
			cd_procedimento,
			ie_origem_proced,
			qt_limite,
			ie_considera_honorario,
			cd_setor_atendimento,
			ie_tipo_atendimento,
			ie_calcula_honorario,
			ie_calcula_custo_oper,
			nr_seq_pac_acomod,
			pr_desconto,
			cd_centro_custo,
			nr_seq_classif,
			ie_ratear_item,
			ie_valida_limite_proc,
			nr_seq_estrutura)
		values (nr_seq_pacote_p,
			nr_seq_regra_w,
			ie_inclui_exclui_w,
			clock_timestamp(),
			nm_usuario_p,
			ie_excedente_w,
			cd_area_proced_w,
			cd_especial_proced_w,
			cd_grupo_proced_w,
			cd_procedimento_w,
			ie_origem_proced_w,
			qt_limite_w,
			ie_considera_honorario_w,
			cd_setor_atendimento_w,
			ie_tipo_atendimento_w,
			ie_calcula_honorario_w,
			ie_calcula_custo_oper_w,
			nr_seq_acomod_dest_p,
			pr_desconto_w,
			cd_centro_custo_w,
			nr_seq_classif_w,
			ie_ratear_item_w,
			ie_valida_limite_proc_w,
			nr_seq_estrutura_proc_w);
		end;
	end loop;
	close c02;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copia_gabarito_pacote ( nr_seq_pacote_p bigint, nr_seq_acomod_orig_p bigint, nr_seq_acomod_dest_p bigint, ie_apagar_todos_p text, ie_regra_p bigint, nm_usuario_p text) FROM PUBLIC;

