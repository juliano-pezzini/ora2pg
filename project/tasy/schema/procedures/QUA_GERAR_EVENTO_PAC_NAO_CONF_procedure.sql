-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qua_gerar_evento_pac_nao_conf ( nm_usuario_p text, nr_seq_evento_p bigint, ie_classificacao_p text, nr_seq_classif_evento_p bigint, nr_nao_conformidade_p bigint, nr_seq_tipo_p bigint, ie_gerar_data_evento_p text, ie_gerar_setor_evento_p text, nr_atendimento_p bigint) AS $body$
DECLARE


nr_sequencia_w			bigint;
cd_estabelecimento_w     	smallint := wheb_usuario_pck.get_cd_estabelecimento;
cd_setor_atendimento_w  	integer;
cd_pessoa_fisica_w		varchar(10);
cd_profissional_w		varchar(10);
cd_perfil_ativo_w		integer := obter_perfil_ativo;
dt_abertura_w			qua_nao_conformidade.dt_abertura%type;
cd_setor_atendimento_nc_w	qua_nao_conformidade.cd_setor_atendimento%type;
ds_nao_conformidade_w		qua_nao_conformidade.ds_nao_conformidade%type;
ds_disposicao_imediata_w	qua_nao_conformidade.ds_disposicao_imediata%type;


BEGIN

select	nextval('qua_evento_paciente_seq')
into STRICT	nr_sequencia_w
;

select	cd_setor_atendimento,
	cd_pessoa_fisica
into STRICT	cd_setor_atendimento_w,
	cd_profissional_w
from	usuario
where	nm_usuario = nm_usuario_p;

begin
select	cd_pessoa_fisica
into STRICT	cd_pessoa_fisica_w
from	atendimento_paciente
where	nr_atendimento = nr_atendimento_p;
exception
when others then
	cd_pessoa_fisica_w := cd_profissional_w;
end;

select	CASE WHEN coalesce(ie_gerar_data_evento_p, 'N')='N' THEN  clock_timestamp() WHEN coalesce(ie_gerar_data_evento_p, 'N')='S' THEN  dt_abertura END ,
	CASE WHEN coalesce(ie_gerar_setor_evento_p, 'N')='N' THEN  cd_setor_atendimento_w WHEN coalesce(ie_gerar_setor_evento_p, 'N')='S' THEN  cd_setor_atendimento END ,
	substr(obter_desc_expressao(cd_exp_nao_conformidade, ds_nao_conformidade), 1, 4000) ds_nao_conformidade,
	ds_disposicao_imediata
into STRICT	dt_abertura_w,
	cd_setor_atendimento_nc_w,
	ds_nao_conformidade_w,
	ds_disposicao_imediata_w
from	qua_nao_conformidade
where	nr_sequencia = nr_nao_conformidade_p;

insert into qua_evento_paciente(
	nr_sequencia,
	cd_estabelecimento,
	dt_atualizacao,
	nm_usuario,
	nr_seq_evento,
	dt_evento,
	ds_evento,
	cd_setor_atendimento,
	dt_cadastro,
	nm_usuario_reg,
	ie_situacao,
	ie_origem,
	ie_tipo_evento,
	nm_usuario_origem,
	ie_status,
	ie_classificacao,
	nr_seq_classif_evento,
	cd_perfil_ativo,
	nm_usuario_nrec,
	dt_atualizacao_nrec,
	cd_pessoa_fisica,
	cd_profissional,
	ds_disposicao_imediata,
	nr_atendimento,
	dt_liberacao,
	cd_funcao_ativa)
values (	nr_sequencia_w,
	cd_estabelecimento_w,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_evento_p,
	dt_abertura_w,
	ds_nao_conformidade_w,
	cd_setor_atendimento_nc_w,
	clock_timestamp(),
	nm_usuario_p,
	'A',
	'U',
	'E',
	nm_usuario_p,
	1,
	ie_classificacao_p,
	nr_seq_classif_evento_p,
	cd_perfil_ativo_w,
	nm_usuario_p,
	clock_timestamp(),
	cd_pessoa_fisica_w,
	cd_profissional_w,
	ds_disposicao_imediata_w,
	nr_atendimento_p,
	clock_timestamp(),
	obter_funcao_ativa);

if (nr_nao_conformidade_p IS NOT NULL AND nr_nao_conformidade_p::text <> '') and (nr_nao_conformidade_p > 0) then
	update	qua_nao_conformidade
	set	dt_atualizacao	= clock_timestamp(),
		nm_usuario	= nm_usuario_p,
		nr_seq_evento	= nr_sequencia_w,
		nr_seq_tipo	= nr_seq_tipo_p
	where	nr_sequencia	= nr_nao_conformidade_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qua_gerar_evento_pac_nao_conf ( nm_usuario_p text, nr_seq_evento_p bigint, ie_classificacao_p text, nr_seq_classif_evento_p bigint, nr_nao_conformidade_p bigint, nr_seq_tipo_p bigint, ie_gerar_data_evento_p text, ie_gerar_setor_evento_p text, nr_atendimento_p bigint) FROM PUBLIC;

