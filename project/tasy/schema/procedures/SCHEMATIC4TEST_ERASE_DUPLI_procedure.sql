-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE schematic4test_erase_dupli (NR_SEQUENCIA_P bigint, IE_STATUS_P text) AS $body$
DECLARE

NR_SEQ_SCHEDULE_W bigint;
NR_SEQ_SCRIPT_W bigint;
NR_SEQUENCIA_W bigint;
QTD_W bigint;

C01 CURSOR FOR  --loop log script with fail
  SELECT log.NR_SEQ_SCHEDULE NR_SEQ_SCHEDULE, log.NR_SEQ_SCRIPT NR_SEQ_SCRIPT
      INTO STRICT NR_SEQ_SCHEDULE_W, NR_SEQ_SCRIPT_W
  FROM SCHEM_TEST_LOG log      
	WHERE log.NR_SEQ_SCHEDULE = NR_SEQUENCIA_P 
  AND log.IE_STATUS = IE_STATUS_P
	GROUP BY log.NR_SEQ_SCHEDULE, log.NR_SEQ_SCRIPT HAVING COUNT(*) > 1;

BEGIN
    --procedure that delete script duplicated
    OPEN C01;
    LOOP
      FETCH C01 INTO
        NR_SEQ_SCHEDULE_W,
        NR_SEQ_SCRIPT_W;
      EXIT WHEN NOT FOUND; /* apply on C01 */
      BEGIN	
        SELECT COUNT(log.NR_SEQUENCIA) NR_SEQUENCIA
            INTO STRICT QTD_W
        FROM SCHEM_TEST_LOG log
        WHERE log.NR_SEQ_SCHEDULE = NR_SEQ_SCHEDULE_W
        AND log.NR_SEQ_SCRIPT = NR_SEQ_SCRIPT_W
        AND log.IE_STATUS  = IE_STATUS_P;				

        IF (QTD_W <> 0) THEN
            SELECT MAX(log.NR_SEQUENCIA) NR_SEQUENCIA
                INTO STRICT NR_SEQUENCIA_W
            FROM SCHEM_TEST_LOG log
            WHERE log.NR_SEQ_SCHEDULE = NR_SEQ_SCHEDULE_W
            AND log.NR_SEQ_SCRIPT = NR_SEQ_SCRIPT_W
            AND log.IE_STATUS  = IE_STATUS_P;	

            DELETE FROM SCHEM_TEST_LOG WHERE NR_SEQUENCIA = NR_SEQUENCIA_W;
            COMMIT;
        END IF;
      END;
    END LOOP;
    CLOSE C01;
    EXCEPTION
    WHEN no_data_found THEN
      RAISE NOTICE 'Erro: Data not found';
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE schematic4test_erase_dupli (NR_SEQUENCIA_P bigint, IE_STATUS_P text) FROM PUBLIC;

