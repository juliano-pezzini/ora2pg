-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ageint_transf_recorrencia_serv (nr_seq_agenda_int_p bigint, nm_usuario_p text, ie_diario_p text, ie_semanal_p text, ds_dias_p text, dt_inicio_recorrencia_p timestamp, dt_fim_recorrencia_p timestamp, ie_final_semana_p text, nr_seq_ageint_item_p bigint) AS $body$
DECLARE


nr_seq_item_w				bigint;
ds_dias_w					varchar(255);
dt_dia_semana_w				smallint;
qt_dia_w					smallint;
ie_gerar_dia_w				varchar(1) := 'N';
ie_fim_sab_chec_w			varchar(1);
ie_fim_dom_chec_w			varchar(1);
dt_atual_w					timestamp;
cd_dia_semana_w				varchar(1);
dt_inicial_w				timestamp;
dt_final_w					timestamp;
nr_seq_item_princ_w			bigint;
dt_prevista_w				timestamp;
nr_seq_proc_interno_w		bigint;
nr_sequencia_w			agenda_integrada_item.nr_sequencia%type;

C01 CURSOR FOR
	SELECT	b.nr_sequencia
	from	agenda_consulta a,
		agenda_integrada_item b
	where	a.nr_sequencia = b.nr_seq_agenda_cons
	and	b.nr_seq_agenda_int = nr_seq_agenda_int_p
	and	a.ie_status_agenda <> 'C'
	--and	a.dt_agenda >= dt_agenda_w
	and	b.nr_sequencia <> nr_seq_ageint_item_p
	and (b.nr_sequencia > nr_seq_ageint_item_p)
	
union all

	SELECT	b.nr_sequencia
	from	agenda_consulta a,
		agenda_integrada_item b
	where	a.nr_sequencia = b.nr_seq_Agenda_cons
	and	b.nr_seq_agenda_int = nr_seq_agenda_int_p
	and	a.ie_status_agenda <> 'C'
	and	b.nr_sequencia = nr_seq_ageint_item_p
	order by 1;


BEGIN

ds_dias_w 		:= '';
dt_inicial_w	:= dt_inicio_recorrencia_p;
dt_final_w		:= dt_fim_recorrencia_p;
dt_Atual_w		:= dt_inicial_w;

if (nr_seq_agenda_int_p IS NOT NULL AND nr_seq_agenda_int_p::text <> '') then

	if (ie_diario_p  = 'S') then
		qt_dia_w	:= 1;
	elsif (ie_semanal_p = 'S') then
		qt_dia_w	:= 7;
	end if;

	open C01;
	loop
	fetch C01 into
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		while(ie_gerar_dia_w = 'N') loop
			begin
			select	obter_cod_dia_semana(dt_Atual_w)
			into STRICT	dt_dia_semana_w
			;


			ie_gerar_dia_w	:= 'S';

			if (ds_dias_p IS NOT NULL AND ds_dias_p::text <> '') then
				select	substr(ds_dias_p,1,length(ds_dias_p) -2)
				into STRICT	ds_dias_w
				;
				ie_gerar_dia_w	:=  obter_se_contido(dt_dia_semana_w,ds_dias_w);
			end if;

			select	obter_se_contido(7,ds_dias_w)
			into STRICT	ie_fim_sab_chec_w
			;

			select	obter_se_contido(1,ds_dias_w)
			into STRICT	ie_fim_dom_chec_w
			;

			if (coalesce(ds_dias_p::text, '') = '') then
				if (dt_dia_semana_w = 1) and (ie_final_semana_p = 'N') then
					ie_Gerar_dia_w	:= 'N';
				elsif (dt_dia_semana_w = 7) and (ie_final_semana_p = 'N') then
					ie_Gerar_dia_w	:= 'N';
				end if;
			end if;

			if ( ie_gerar_dia_w = 'S') then
				update	agenda_integrada_item
				set	dt_prev_transf_item 	= dt_atual_w
				where	nr_sequencia = nr_sequencia_w;
			end if;

			dt_atual_w  	:= dt_atual_w + qt_dia_w;
			dt_inicial_w 	:= dt_inicial_w + 1;
			end;
			end loop;
			ie_gerar_dia_w := 'N';
		end;
	end loop;
	close C01;


end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageint_transf_recorrencia_serv (nr_seq_agenda_int_p bigint, nm_usuario_p text, ie_diario_p text, ie_semanal_p text, ds_dias_p text, dt_inicio_recorrencia_p timestamp, dt_fim_recorrencia_p timestamp, ie_final_semana_p text, nr_seq_ageint_item_p bigint) FROM PUBLIC;

