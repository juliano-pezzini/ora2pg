-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_med_atendimento (nr_seq_agenda_p bigint, cd_pessoa_fisica_p text, cd_medico_p text, nm_usuario_p text, ie_chegada_consulta_p text, ds_erro_p INOUT text) AS $body$
DECLARE



/*	C - Consulta
	E - Entrada/Chegada */
nr_seq_cliente_w			bigint	:= Null;
nr_atendimento_w			bigint	:= Null;
cd_convenio_w			integer	:= Null;
nr_seq_plano_w			bigint	:= Null;
cd_usuario_convenio_w		varchar(30);
ie_classif_agenda_w		varchar(05);
dt_validade_carteira_w		timestamp;
ie_tipo_consulta_w		smallint;


BEGIN

select	ie_classif_agenda
into STRICT		ie_classif_agenda_w
from		agenda_consulta
where		nr_sequencia	= nr_seq_agenda_p;


if (ie_classif_agenda_w <> 'M') then
	begin
	select		coalesce(max(a.nr_sequencia),0),
			max(a.cd_convenio),
			max(a.nr_seq_plano),
			max(a.cd_usuario_convenio),
			max(a.dt_validade_carteira)
	into STRICT		nr_seq_cliente_w,
			cd_convenio_w,
			nr_seq_plano_w,
			cd_usuario_convenio_w,
			dt_validade_carteira_w
	from		med_cliente a
	where		a.cd_pessoa_fisica	= cd_pessoa_fisica_p
	and		a.cd_medico		= cd_medico_p
	and             a.nr_sequencia          in (SELECT x.nr_sequencia
	        	   from    med_cliente x
	        	   where   x.cd_pessoa_fisica      = a.cd_pessoa_fisica
        		   and     x.cd_medico             = a.cd_medico
		           and     (x.cd_pessoa_sist_orig IS NOT NULL AND x.cd_pessoa_sist_orig::text <> '')
		
union

		           SELECT  max(x.nr_sequencia)
		           from    med_cliente x
		           where   x.cd_pessoa_fisica      = a.cd_pessoa_fisica
		           and     x.cd_medico             = a.cd_medico
		           and     coalesce(x.cd_pessoa_sist_orig::text, '') = ''
		           and     not exists (select 1
		           from    med_cliente y
		           where   y.cd_pessoa_fisica      = a.cd_pessoa_fisica
                	   and     y.cd_medico             = a.cd_medico
	                   and     (y.cd_pessoa_sist_orig IS NOT NULL AND y.cd_pessoa_sist_orig::text <> '')));

	select	coalesce(max(nr_atendimento),0)
	into STRICT		nr_atendimento_w
	from		med_atendimento
	where		nr_seq_agenda		= nr_seq_agenda_p;

	if (nr_atendimento_w > 0) then
		begin
		if (ie_chegada_consulta_p = 'E') then
			update	med_atendimento
			set		dt_entrada	= clock_timestamp()
			where		nr_atendimento	= nr_atendimento_w;
		elsif (ie_chegada_consulta_p = 'C') then
			update	med_atendimento
			set		dt_inicio_consulta = clock_timestamp()
			where		nr_atendimento	   = nr_atendimento_w
			and		coalesce(dt_inicio_consulta::text, '') = '';
		end if;
		end;
	else
		begin

		if (nr_seq_cliente_w <> 0) then
			begin

			if (coalesce(cd_convenio_w::text, '') = '') then
				select	cd_convenio
				into STRICT		cd_convenio_w
				from		agenda_consulta
				where		nr_sequencia	= nr_seq_agenda_p;
			end if;

			if (coalesce(nr_seq_plano_w::text, '') = '') then
				select	nr_seq_plano
				into STRICT		nr_seq_plano_w
				from		agenda_consulta
				where		nr_sequencia	= nr_seq_agenda_p;
			end if;

			/* Rafael em 12/04/2007 classificacao TISS 2007 */

			select	obter_classif_tiss_agenda(nr_seq_agenda_p, 'C')
			into STRICT	ie_tipo_consulta_w
			;

			select	nextval('med_atendimento_seq')
			into STRICT		nr_atendimento_w
			;

			insert into med_atendimento(nr_atendimento,
					nr_seq_cliente,
					dt_atualizacao,
					nm_usuario,
					dt_entrada,
					cd_convenio,
					dt_saida,
					nr_atend_original,
					cd_usuario_convenio,
					dt_validade_carteira,
					nr_seq_agenda,
					dt_inicio_consulta,
					ie_grau_satisfacao,
					nr_seq_plano,
					ie_tipo_consulta)
			values (nr_atendimento_w,
					nr_seq_cliente_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					cd_convenio_w,
					null,
					null,
					cd_usuario_convenio_w,
					dt_validade_carteira_w,
					nr_seq_agenda_p,
					null,
					null,
					nr_seq_plano_w,
					ie_tipo_consulta_w);

			CALL Atualizar_Convenio_Med_Cliente(nr_seq_cliente_w,
				cd_convenio_w,
				cd_usuario_convenio_w,
				'S', nr_seq_plano_w);

			end;
		end if;

		end;

	end if;
	end;
end if;

if (ie_chegada_consulta_p = 'E') then
	update		agenda_consulta a
	set		a.ie_status_agenda	= 'A'
	where		a.nr_sequencia		= nr_seq_agenda_p
/*	and		a.ie_status_agenda	in ('N', 'LF') Linha comentada e trocada pela abaixo por Oraci em 05/11/2007 OS72299 */

	and		a.ie_status_agenda	not in ('B', 'C', 'E', 'L')
	and (exists (	SELECT 1
					from	med_atendimento x
					where	x.nr_seq_agenda	= a.nr_sequencia) or (a.ie_classif_agenda	= 'M') or (a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> ''));

elsif (ie_chegada_consulta_p = 'C') then
	update		agenda_consulta a
	set		a.ie_status_agenda	= 'O'
	where		a.nr_sequencia		= nr_seq_agenda_p
	and		a.ie_status_agenda	= 'A'
	and (exists (SELECT 1
				from	med_atendimento x
				where	x.nr_seq_agenda	= a.nr_sequencia) or (a.ie_classif_agenda	= 'M'));
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_med_atendimento (nr_seq_agenda_p bigint, cd_pessoa_fisica_p text, cd_medico_p text, nm_usuario_p text, ie_chegada_consulta_p text, ds_erro_p INOUT text) FROM PUBLIC;

