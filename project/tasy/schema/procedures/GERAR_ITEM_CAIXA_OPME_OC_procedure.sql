-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_item_caixa_opme_oc ( nr_ordem_compra_p bigint, nr_seq_caixa_p bigint, cd_local_estoque_p bigint, ie_vl_ultima_compra_p text, nm_usuario_p text) AS $body$
DECLARE


cd_material_w				integer;
cd_material_estoque_w			integer;
cd_conta_contabil_w			varchar(20);
cd_centro_custo_w			integer;
nr_seq_conta_financ_w			bigint;
ds_observacao_w				varchar(255);
cd_cgc_emitente_w			varchar(14);
cd_natureza_operacao_w			smallint;
cd_unid_med_estoque_w			varchar(30);
cd_unid_med_compra_w			varchar(30);
ds_erro_w				varchar(2000);
cd_operacao_nf_w			bigint;
ie_tipo_conta_w				smallint;
qt_item_estoque_w			double precision;
qt_conv_compra_estoque_w		double precision;
qt_saldo_w				bigint;
vl_item_w				double precision;
vl_total_item_oci_w			double precision := 0;
vl_liquido_w				double precision := 0;
ds_caixa_opme_w				varchar(255);

dt_validade_anvisa_w			timestamp;
nr_registro_anvisa_w			varchar(60);
nr_seq_marca_w				bigint;
ie_origem_titulo_w			varchar(10);
nr_seq_classe_tit_rec_w			bigint;

--Ordem
cd_estabelecimento_w			smallint;
nr_ordem_compra_w			bigint;
cd_condicao_pagamento_w			bigint;
nr_item_oci_w				integer;
cd_cgc_fornecedor_w			varchar(14);


c01 CURSOR FOR
SELECT	cd_material,
	qt_saldo
from	opme_caixa_item
where	nr_seq_caixa = nr_seq_caixa_p;


BEGIN

select	cd_estabelecimento,
	cd_cgc_fornecedor,
	nr_ordem_compra,
	cd_condicao_pagamento
into STRICT	cd_estabelecimento_w,
	cd_cgc_fornecedor_w,
	nr_ordem_compra_w,
	cd_condicao_pagamento_w
from	ordem_compra
where	nr_ordem_compra = nr_ordem_compra_p;

open C01;
loop
fetch C01 into
	cd_material_w,
	qt_saldo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	select	substr(obter_dados_material_estab(cd_material,cd_estabelecimento_w,'UME'),1,30) cd_unidade_medida_estoque,
		substr(obter_dados_material_estab(cd_material,cd_estabelecimento_w,'UMC'),1,30) cd_unidade_medida_compra,
		cd_material_estoque,
		qt_conv_compra_estoque,
		coalesce(obter_reg_anvisa_mat(cd_estabelecimento_w, cd_material, obter_marca_material(cd_material,'C'),'DV'),obter_dados_material_estab(cd_material, cd_estabelecimento_w, 'VA')) dt_validade_anvisa,
		coalesce(obter_reg_anvisa_mat(cd_estabelecimento_w, cd_material, obter_marca_material(cd_material,'C'),'RA'),obter_dados_material_estab(cd_material, cd_estabelecimento_w, 'RA')) nr_registro_anvisa,
		obter_marca_material(cd_material, 'C') nr_seq_marca
	into STRICT  	cd_unid_med_estoque_w,
		cd_unid_med_compra_w,
		cd_material_estoque_w,
		qt_conv_compra_estoque_w,
		dt_validade_anvisa_w,
		nr_registro_anvisa_w,
		nr_seq_marca_w
	from	material
	where	cd_material = cd_material_w;

	qt_item_estoque_w := qt_saldo_w;

	if (cd_unid_med_estoque_w <> cd_unid_med_compra_w) then
		qt_item_estoque_w := qt_saldo_w * qt_conv_compra_estoque_w;
	end if;

	if (coalesce(cd_conta_contabil_w, 'X') = 'X') then
		begin
		ie_tipo_conta_w	:= 3;
		if (coalesce(cd_centro_custo_w::text, '') = '') then
			ie_tipo_conta_w	:= 2;
		end if;

		SELECT * FROM define_conta_material(
			cd_estabelecimento_w, cd_material_w, ie_tipo_conta_w, 0, 0, 0, 0, 0, 0, 0, cd_local_estoque_p, null, trunc(clock_timestamp()), cd_conta_contabil_w, cd_centro_custo_w, null) INTO STRICT cd_conta_contabil_w, cd_centro_custo_w;
		end;
	end if;

	nr_seq_conta_financ_w := obter_conta_financeira(
			'S', cd_estabelecimento_w, cd_material_w, null, null, null, null, cd_cgc_fornecedor_w, cd_centro_custo_w, nr_seq_conta_financ_w, null, cd_operacao_nf_w, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null);

	select (coalesce(max(nr_item_oci),0)+1)
	into STRICT	nr_item_oci_w
	from	ordem_compra_item
	where	nr_ordem_compra = nr_ordem_compra_p;

	vl_item_w		:= 0;

	if (ie_vl_ultima_compra_p = 'S') then
		begin
		vl_item_w := obter_vl_ultima_compra_forn(
						cd_estabelecimento_w,
						90,
						cd_material_w,
						cd_local_estoque_p,
						cd_cgc_fornecedor_w,
						'N');
		vl_liquido_w		:= coalesce(vl_item_w,0) * coalesce(qt_saldo_w,0);
		vl_total_item_oci_w	:= vl_liquido_w;
		vl_item_w		:= dividir(vl_liquido_w,qt_saldo_w);
		end;
	end if;

	begin

	select	substr(obter_descricao_caixa_opme(nr_seq_caixa_p,'D'),1,255) ds_tipo_caixa
	into STRICT	ds_caixa_opme_w
	;

	insert into ordem_compra_item(
		nr_ordem_compra,
		nr_item_oci,
		qt_material,
		qt_original,
		vl_unitario_material,
		vl_total_item,
		dt_atualizacao,
		nm_usuario,
		nm_usuario_lib,
		vl_desconto,
		cd_material,
		cd_conta_contabil,
		cd_centro_custo,
		vl_item_liquido,
		ds_observacao,
		pr_descontos,
		cd_unidade_medida_compra,
		nr_seq_conta_financ,
		cd_local_estoque,
		nr_seq_marca,
		ie_situacao)
	values (	nr_ordem_compra_p,
		nr_item_oci_w,
		qt_saldo_w,
		qt_saldo_w,
		vl_item_w,
		vl_total_item_oci_w,
		clock_timestamp(),
		nm_usuario_p,
		nm_usuario_p,
		0,
		cd_material_w,
		cd_conta_contabil_w,
		cd_centro_custo_w,
		VL_LIQUIDO_w,
		substr(wheb_mensagem_pck.get_texto(301608,'NR_SEQ_CAIXA_P='||nr_seq_caixa_p||';DS_CAIXA_OPME_W='||ds_caixa_opme_w||';NR_REGISTRO_ANVISA_W='||nr_registro_anvisa_w)||';DT_VALIDADE_ANVISA_W='||dt_validade_anvisa_w,1,255),
		0,
		cd_unid_med_compra_w,
		CASE WHEN nr_seq_conta_financ_w=0 THEN null  ELSE nr_seq_conta_financ_w END ,
		cd_local_estoque_p,
		nr_seq_marca_w,
		'A');
	exception
	when others then
		ds_erro_w	:= sqlerrm(SQLSTATE);
		--(-20011,'Erro Inclus√£o ' || chr(10) || ds_erro_w);
		CALL wheb_mensagem_pck.exibir_mensagem_abort(223743,'DS_ERRO=' || ds_erro_w);
	end;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_item_caixa_opme_oc ( nr_ordem_compra_p bigint, nr_seq_caixa_p bigint, cd_local_estoque_p bigint, ie_vl_ultima_compra_p text, nm_usuario_p text) FROM PUBLIC;

