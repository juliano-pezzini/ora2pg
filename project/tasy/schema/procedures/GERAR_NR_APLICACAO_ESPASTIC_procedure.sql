-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_nr_aplicacao_espastic ( cd_pessoa_fisica_p text, nr_aplicacao_p INOUT bigint, dt_aplicacao_p INOUT timestamp) AS $body$
DECLARE

 
ie_tipo_avaliacao_w	varchar(10);
nr_aplicao_result_w		double precision:= 1;
nr_seq_tipo_avaliacao_w	bigint;
dt_aplicacao_w		timestamp;


BEGIN 
 
select	max(nr_seq_tipo_avaliacao) 
into STRICT	nr_seq_tipo_avaliacao_w 
from	med_avaliacao_paciente a 
where	a.nr_sequencia	= (	SELECT	max(x.nr_sequencia) 
				from	med_avaliacao_paciente x 
				where	x.cd_pessoa_fisica = cd_pessoa_fisica_p 
				and	x.ie_situacao = 'A' 
				and	(x.dt_liberacao IS NOT NULL AND x.dt_liberacao::text <> ''));
	 
 
 select coalesce(max(ie_tipo_avaliacao),'R') 
 into STRICT	ie_tipo_avaliacao_w	 
 from	espasticidade_avaliacao 
 where	nr_seq_tipo_avaliacao = nr_seq_tipo_avaliacao_w;
 
 
if (ie_tipo_avaliacao_w IS NOT NULL AND ie_tipo_avaliacao_w::text <> '') and (ie_tipo_avaliacao_w = 'P')then 
	begin 
 
	nr_aplicao_result_w	:= 1;
	 
	end;
elsif (ie_tipo_avaliacao_w IS NOT NULL AND ie_tipo_avaliacao_w::text <> '') and (ie_tipo_avaliacao_w = 'R') then 
	begin 
	select	coalesce(max(b.nr_aplicacao),0) + 1 
	into STRICT	nr_aplicao_result_w 
	from	atendimento_toxina b 
	where	b.nr_sequencia = ( SELECT 	max(a.nr_sequencia) 
				  from 	atendimento_toxina a 
				  where 	a.cd_pessoa_fisica = cd_pessoa_fisica_p 
				  and		coalesce(a.dt_inativacao::text, '') = '' 
				  and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> ''));
 
	end;
end if;
 
select 	MAX(dt_aplicacao) 
into STRICT	dt_aplicacao_w 
from  	ATENDIMENTO_TOXINA 
where 	cd_pessoa_fisica = cd_pessoa_fisica_p 
and  	(dt_aplicacao IS NOT NULL AND dt_aplicacao::text <> '') 
and  	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') 
and  	coalesce(dt_inativacao::text, '') = '';
 
dt_aplicacao_p	:= dt_aplicacao_w;
 
nr_aplicacao_p	:= nr_aplicao_result_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_nr_aplicacao_espastic ( cd_pessoa_fisica_p text, nr_aplicacao_p INOUT bigint, dt_aplicacao_p INOUT timestamp) FROM PUBLIC;

