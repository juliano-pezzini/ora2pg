-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE plt_gerar_prescr_leite_deriv (nr_prescricao_p bigint, nm_usuario_p text, cd_intervalo_p text, ie_via_aplicacao_p text, ie_se_necessario_p text, nr_seq_disp_succao_p bigint, qt_vel_infusao_p bigint, qt_volume_oral_p bigint, qt_volume_sonda_p bigint, qt_volume_total_p bigint) AS $body$
DECLARE

 
									  
ds_horarios_w	 		varchar(2000);
ds_horarios_ww			varchar(2000);
nr_seq_leite_deriv_w	bigint;
dt_inicio_prescr_w		timestamp;
nr_horas_validade_w		integer;
hr_prim_hor_prescr_w	varchar(5);
dt_prim_hor_prescr_w	timestamp;
nr_ocorrencia_w			bigint;	
 
 

BEGIN 
 
if (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then 
	 
	select	dt_inicio_prescr, 
			coalesce(nr_horas_validade,24), 
			to_char(dt_primeiro_horario,'hh24:mi') 
	into STRICT	dt_inicio_prescr_w, 
			nr_horas_validade_w, 
			hr_prim_hor_prescr_w 
	from	prescr_medica 
	where	nr_prescricao	= nr_prescricao_p;
	 
	if (cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') then 
		dt_prim_hor_prescr_w	:= to_date(to_char(dt_inicio_prescr_w,'dd/mm/yyyy')||' '||hr_prim_hor_prescr_w||':00','dd/mm/yyyy hh24:mi:ss');
 
		if (dt_inicio_prescr_w	> dt_prim_hor_prescr_w) then 
			dt_prim_hor_prescr_w	:= dt_prim_hor_prescr_w + 1;
		end if;	
 
		SELECT * FROM Calcular_Horario_Prescricao(nr_prescricao_p, cd_intervalo_p, dt_prim_hor_prescr_w, dt_prim_hor_prescr_w, nr_horas_validade_w, null, 0, 0, nr_ocorrencia_w, ds_horarios_w, ds_horarios_ww, 'N', null, null, null, null, null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_ww;
 
		ds_horarios_w	:= eliminar_horarios_vigencia(ds_horarios_w, cd_intervalo_p, dt_prim_hor_prescr_w, dt_inicio_prescr_w, 0, 0, nr_prescricao_p);			
					   
		select	nextval('prescr_leite_deriv_seq') 
		into STRICT	nr_seq_leite_deriv_w 
		;
		 
		insert into	prescr_leite_deriv(nr_sequencia, 
							dt_atualizacao, 
							nm_usuario, 
							dt_atualizacao_nrec, 
							nm_usuario_nrec, 
							nr_prescricao, 
							cd_intervalo, 
							ie_via_aplicacao, 
							qt_volume_oral, 
							qt_volume_sonda, 
							qt_volume_total, 
							qt_vel_infusao, 
							nr_seq_disp_succao, 
							ie_se_necessario, 
							ds_horarios, 
							hr_prim_horario) 
		values (nr_seq_leite_deriv_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			nr_prescricao_p, 
			cd_intervalo_p, 
			ie_via_aplicacao_p, 
			qt_volume_oral_p, 
			qt_volume_sonda_p, 
			qt_volume_total_p, 
			qt_vel_infusao_p, 
			nr_seq_disp_succao_p, 
			ie_se_necessario_p, 
			ds_horarios_w, 
			hr_prim_hor_prescr_w);	
	end if;
end if;
commit;
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE plt_gerar_prescr_leite_deriv (nr_prescricao_p bigint, nm_usuario_p text, cd_intervalo_p text, ie_via_aplicacao_p text, ie_se_necessario_p text, nr_seq_disp_succao_p bigint, qt_vel_infusao_p bigint, qt_volume_oral_p bigint, qt_volume_sonda_p bigint, qt_volume_total_p bigint) FROM PUBLIC;

