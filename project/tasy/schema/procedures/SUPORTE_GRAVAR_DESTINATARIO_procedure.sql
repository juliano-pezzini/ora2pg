-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE suporte_gravar_destinatario ( nr_seq_comunicado_p bigint, nr_seq_localizacao_p bigint, cd_pessoa_fisica_p text, cd_cnpj_p text, nm_usuario_p text) AS $body$
DECLARE

 
ds_email_w			varchar(255);
nr_seq_localizacao_w		bigint;
nr_sequencia_w			bigint;
cd_pessoa_fisica_w		varchar(10);
nr_seq_tipo_comunic_w		bigint;
nr_seq_tipo_comunic_ww		bigint;
qt_pessoa_w			bigint := 0;
qt_envio_w			bigint := 0;

c01 CURSOR FOR 
	SELECT	a.nr_sequencia nr_sequencia, 
		a.cd_pessoa_fisica cd_pessoa_fisica, 
		substr(obter_compl_pf(a.cd_pessoa_fisica,1,'M'),1,255) ds_email 
	from	man_pessoa_localizacao a 
	where	a.cd_pessoa_fisica		= coalesce(cd_pessoa_fisica_p, a.cd_pessoa_fisica) 
	and	a.nr_seq_localizacao		= coalesce(nr_seq_localizacao_w,a.nr_seq_localizacao) 
	and	coalesce(a.ie_comunicado,'N')	= 'S' 
	and	(obter_compl_pf(a.cd_pessoa_fisica,1,'M') IS NOT NULL AND (obter_compl_pf(a.cd_pessoa_fisica,1,'M'))::text <> '');

c02 CURSOR FOR 
	SELECT 	a.nr_seq_tipo_comunicado 
	from	man_pessoa_localiz_comunic a 
	where	a.nr_seq_pessoa = nr_sequencia_w;
	
c03 CURSOR FOR 
	SELECT 	a.nr_seq_tipo_comunicado 
	from	suporte_comunicado a 
	where	a.nr_sequencia = nr_seq_comunicado_p;	
 

BEGIN 
 
if (coalesce(nr_seq_localizacao_p,0) = 0) then 
	nr_seq_localizacao_w	:= null;
else 
	nr_seq_localizacao_w	:= nr_seq_localizacao_p;
end if;
 
 
if (coalesce(cd_cnpj_p,'0') = '0') then 
	open c01;
	loop 
	fetch c01 into 
		nr_sequencia_w, 
		cd_pessoa_fisica_w, 
		ds_email_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin 
		 
		begin 
		select 	count(*) 
		into STRICT	qt_pessoa_w 
		from	man_pessoa_localiz_comunic a 
		where	a.nr_seq_pessoa = nr_sequencia_w;
		exception 
			when others then 
			qt_pessoa_w	:= 0;
			end;
 
		if (qt_pessoa_w > 0) then 
			begin 
			 
			open c02;
			loop 
			fetch c02 into 
				nr_seq_tipo_comunic_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				begin 
				open c03;
				loop 
				fetch c03 into 
					nr_seq_tipo_comunic_ww;
				EXIT WHEN NOT FOUND; /* apply on c03 */
					begin				 
					if (nr_seq_tipo_comunic_w = nr_seq_tipo_comunic_ww) then 
						begin 
						 
						select	count(nr_sequencia) 
						into STRICT	qt_envio_w 
						from	suporte_comunicado_dest 
						where	cd_pessoa_fisica = cd_pessoa_fisica_w 
						and	nr_seq_comunicado = nr_seq_comunicado_p  LIMIT 1;					
						 
						if (qt_envio_w < 1) then 
						 
							insert into suporte_comunicado_dest( 
								nr_sequencia, 
								nr_seq_comunicado, 
								dt_atualizacao_nrec, 
								nm_usuario_nrec, 
								dt_atualizacao, 
								nm_usuario, 
								cd_pessoa_fisica, 
								cd_cnpj, 
								ds_email, 
								ie_enviar_email) 
							values (	nextval('suporte_comunicado_dest_seq'), 
								nr_seq_comunicado_p, 
								clock_timestamp(), 
								nm_usuario_p, 
								clock_timestamp(), 
								nm_usuario_p, 
								cd_pessoa_fisica_w, 
								'', 
								ds_email_w, 
								'S');
						end if;
						 
						end;
					end if;					
					end;
				end loop;
				close c03;
					 
				end;
			end loop;
			close c02;
			 
			end;
		else -- Retirado a perdido da Simone OS258018 
			begin 
			 
			select	count(nr_sequencia) 
						into STRICT	qt_envio_w 
						from	suporte_comunicado_dest 
						where	cd_pessoa_fisica = cd_pessoa_fisica_w 
						and	nr_seq_comunicado = nr_seq_comunicado_p  LIMIT 1;					
						 
			if (qt_envio_w < 1) then 
			 
				insert into suporte_comunicado_dest( 
					nr_sequencia, 
					nr_seq_comunicado, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec, 
					dt_atualizacao, 
					nm_usuario, 
					cd_pessoa_fisica, 
					cd_cnpj, 
					ds_email, 
					ie_enviar_email) 
				values (	nextval('suporte_comunicado_dest_seq'), 
					nr_seq_comunicado_p, 
					clock_timestamp(), 
					nm_usuario_p, 
					clock_timestamp(), 
					nm_usuario_p, 
					cd_pessoa_fisica_w, 
					'', 
					ds_email_w, 
					'S');
			end if;		
			end;
		end if;
		 
		end;
	end loop;
	close c01;
else 
	select	coalesce(max(b.ds_email),max(a.ds_email)) 
	into STRICT	ds_email_w 
	from	pessoa_juridica a, 
		pessoa_juridica_estab b 
	where	a.cd_cgc	= b.cd_cgc 
	and	a.cd_cgc	= cd_cnpj_p;
 
	if (ds_email_w IS NOT NULL AND ds_email_w::text <> '') then 
		insert into suporte_comunicado_dest( 
			nr_sequencia, 
			nr_seq_comunicado, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			dt_atualizacao, 
			nm_usuario, 
			cd_pessoa_fisica, 
			cd_cnpj, 
			ds_email, 
			ie_enviar_email) 
		values (	nextval('suporte_comunicado_dest_seq'), 
			nr_seq_comunicado_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			'', 
			cd_cnpj_p, 
			ds_email_w, 
			'S');
 
	end if;
end if;
commit;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE suporte_gravar_destinatario ( nr_seq_comunicado_p bigint, nr_seq_localizacao_p bigint, cd_pessoa_fisica_p text, cd_cnpj_p text, nm_usuario_p text) FROM PUBLIC;

