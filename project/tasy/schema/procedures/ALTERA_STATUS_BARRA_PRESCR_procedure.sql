-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE altera_status_barra_prescr ( nr_controle_p bigint, nr_seq_etiqueta_p bigint, nm_usuario_p text, ie_status_atend_p bigint, Ds_justificativa_alt_p text, cd_perfil_p bigint default null, ds_lista_status_perm_p text default null, ds_consiste_recoleta_p text default null, cd_barras_etiqueta_p text default null) AS $body$
DECLARE


nr_seq_prescr_w		bigint;
nr_prescricao_w		bigint;
qt_prescr_proc_w	bigint;
nr_sequencia_w		bigint;
nr_seq_horario_w	bigint;
nr_seq_proc_interno_w	bigint;
cd_procedimento_w	bigint;
qt_procedimento_w	bigint;
cd_estabelecimento_w	bigint;
nr_atendimento_w	bigint;
cd_intervalo_w		varchar(255);
ie_acm_sn_w		varchar(255);
cd_evolucao_w	bigint;
ie_status_atend_w	prescr_procedimento.ie_status_atend%type;
ie_recoleta_w		varchar(1);
ds_msg_w			varchar(255);


c01 CURSOR FOR	
	SELECT	nr_seq_prescr,
		nr_prescricao,
		nr_sequencia
	from	prescr_proc_controle_etiq a
	where	((coalesce(a.cd_barras::text, '') = '' and a.nr_controle	= nr_controle_p	and	a.nr_seq_etiqueta = nr_seq_etiqueta_p) or ((a.cd_barras IS NOT NULL AND a.cd_barras::text <> '') and a.cd_barras = cd_barras_etiqueta_p));

c02 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.nr_seq_proc_interno,
		a.cd_procedimento,
		b.qt_procedimento,
		b.cd_intervalo,
		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario)
	from	prescr_proc_hor a,
		prescr_procedimento b
	where	a.nr_seq_procedimento	= nr_seq_prescr_w
	and	a.nr_prescricao		= nr_prescricao_w
	and	a.nr_prescricao		= b.nr_prescricao
	and	a.nr_seq_procedimento	= b.nr_sequencia;

BEGIN

ie_status_atend_w := ie_status_atend_p;

open C01;
loop
fetch C01 into	
	nr_seq_prescr_w,
	nr_prescricao_w,
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	if (ds_consiste_recoleta_p = 'S') then
		select  CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_recoleta_w
		from 	prescr_proc_etapa a,
				prescr_proc_recoleta b
		where 	a.nr_prescricao = b.nr_prescricao
		and	  	a.nr_seq_prescricao = b.nr_seq_prescr
		and	  	a.nr_prescricao = nr_prescricao_w
		and   	a.nr_seq_prescricao = nr_seq_prescr_w
		and   	a.ie_etapa = 11;
		
		if (ie_recoleta_w = 'S') then
			ie_status_atend_w := 11;
		end if;
	end if;
	
	update 	prescr_proc_controle_etiq
	set	ie_status_atend = ie_status_atend_w,
		nm_usuario = nm_usuario_p,
		dt_atualizacao = clock_timestamp()
	where	nr_sequencia	= nr_sequencia_w;
	
	select	count(*)
	into STRICT	qt_prescr_proc_w
	from	prescr_proc_controle_etiq
	where	((ie_status_atend	<> ie_status_atend_w) or (coalesce(ie_status_atend::text, '') = ''))
	and	nr_seq_prescr	=  nr_seq_prescr_w
	and	nr_prescricao	=  nr_prescricao_w;
	
	if (qt_prescr_proc_w = 0) then
	
		update	prescr_procedimento
		set	ie_status_atend	= ie_status_atend_w,
			Ds_justificativa_alt = Ds_justificativa_alt_p,
			nm_usuario = nm_usuario_p,
			dt_atualizacao = clock_timestamp()
		where	nr_sequencia	= nr_seq_prescr_w
		and	nr_prescricao	= nr_prescricao_w
		and	((ie_status_atend	< ie_status_atend_w) 		
		or	(((ds_lista_status_perm_p IS NOT NULL AND ds_lista_status_perm_p::text <> '')
		and	((ie_status_atend_w = 10) or (ie_status_atend_w = 11))
		and (obter_se_contido_char(ie_status_atend, ds_lista_status_perm_p) = 'S'))));
		
		select	max(cd_estabelecimento),
			max(nr_atendimento)
		into STRICT	cd_estabelecimento_w,
			nr_atendimento_w
		from	prescr_medica
		where	nr_prescricao	= nr_prescricao_w;
		
		open C02;
		loop
		fetch C02 into	
			nr_seq_horario_w,
			nr_seq_proc_interno_w,
			cd_procedimento_w,
			qt_procedimento_w,
			cd_intervalo_w,
			ie_acm_sn_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			if (ie_status_atend_w = 20) then
				SELECT * FROM Gerar_Alteracao_Horario_Prescr(cd_estabelecimento_w, nr_atendimento_w, 'P', cd_procedimento_w, cd_intervalo_w, qt_procedimento_w, 24, clock_timestamp(), nr_seq_horario_w, null, nr_prescricao_w, nr_prescricao_w, nr_seq_prescr_w, 'S', 8, null, null, null, null, null, null /*ds_observacao*/
, nm_usuario_p, 'N', nr_seq_proc_interno_w, null, null, ie_acm_sn_w, null, 'N', null, null, cd_perfil_p, 1113, null, null, null, null, null, null, null, null, null, null, null, '', '', cd_evolucao_w, null, null, ds_msg_w) INTO STRICT cd_evolucao_w, ds_msg_w;
			elsif (ie_status_atend_w < 20) then
				SELECT * FROM Gerar_Alteracao_Horario_Prescr(cd_estabelecimento_w, nr_atendimento_w, 'P', cd_procedimento_w, cd_intervalo_w, qt_procedimento_w, null, clock_timestamp(), nr_seq_horario_w, null, nr_prescricao_w, nr_prescricao_w, nr_seq_prescr_w, 'S', 4, null, null, null, null, null, null /*ds_observacao*/
, nm_usuario_p, 'N', nr_seq_proc_interno_w, null, null, ie_acm_sn_w, null, 'N', null, null, cd_perfil_p, 1113, null, null, null, null, null, null, null, null, null, null, null, '', '', cd_evolucao_w, null, null, ds_msg_w) INTO STRICT cd_evolucao_w, ds_msg_w;
			end if;
			exception when others then
				null;
			end;
		end loop;
		close C02;
		
	end if;

	ie_status_atend_w := ie_status_atend_p;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE altera_status_barra_prescr ( nr_controle_p bigint, nr_seq_etiqueta_p bigint, nm_usuario_p text, ie_status_atend_p bigint, Ds_justificativa_alt_p text, cd_perfil_p bigint default null, ds_lista_status_perm_p text default null, ds_consiste_recoleta_p text default null, cd_barras_etiqueta_p text default null) FROM PUBLIC;

