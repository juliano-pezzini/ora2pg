-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_reorg_movto_doc_uuid (dt_inicio_p timestamp, dt_fim_p timestamp ) AS $body$
DECLARE


		
c00 CURSOR FOR
SELECT distinct	a.nr_lote_contabil
from 	movimento_contabil a,
	lote_contabil b
where  	a.nr_lote_contabil = b.nr_lote_contabil
and    	b.cd_tipo_lote_contabil in (5, 7) 	
and   	a.dt_movimento between trunc(dt_inicio_p, 'dd') and  fim_dia(dt_fim_p);

type t_c00 is table of c00%rowtype index by integer;
l_c00 t_c00;
	
					
c01 CURSOR(
		nr_lote_contabil_pc  movimento_contabil_doc.nr_lote_contabil%type
	)FOR
	SELECT  c.nr_sequencia,
		c.nr_documento,
		c.nr_seq_doc_compl,
		c.nr_lote_contabil,
		c.nr_seq_info,
		b.cd_estabelecimento,
		b.cd_tipo_lote_contabil,
		c.nm_usuario
	from 	movimento_contabil_doc c,
		lote_contabil b
	where 	c.nr_lote_contabil = b.nr_lote_contabil
	and	c.nr_seq_info  in (13, 14)
	and	c.nr_lote_contabil = nr_lote_contabil_pc;
			
			
type t_c01 is table of c01%rowtype index by integer;
l_c01 t_c01;	


type seq_movto_contabil_doc is table of movimento_contabil_doc.nr_sequencia%type index by integer;
l_seq_movto_contabil_doc_w   seq_movto_contabil_doc;

type nr_seq_info is table of movimento_contabil_doc.nr_seq_info%type index by integer;
l_nr_seq_info_w   nr_seq_info;

type movto_nr_nfe_imp is table of movimento_contabil_doc.nr_nfe_imp%type index by integer;
l_movto_nr_nfe_imp_w   movto_nr_nfe_imp;


nr_nfe_imp_w nota_fiscal.nr_nfe_imp%type;	
BEGIN
/*

Objetivo:
		Atualizar coluna NR_NFE_IMP na MOVIMENTO_CONTABIL_DOC.

Lotes contabeis:
		Contas a pagar
		Contas a receber

*/
open c00;
    loop fetch c00 bulk collect into l_c00 limit 1000;
        for y in 1..l_c00.count loop
		begin
		open c01(l_c00[y].nr_lote_contabil);
		loop fetch c01 bulk collect into l_c01 limit 1000;
			for i in 1..l_c01.count loop
			begin	
			case 	l_c01[i].cd_tipo_lote_contabil
			when 5 then
				nr_nfe_imp_w := ctb_uuid_pck.get_uuid_contas_receber(l_c01[i].nr_documento,l_c01[i].nr_seq_doc_compl);
				if (nr_nfe_imp_w IS NOT NULL AND nr_nfe_imp_w::text <> '') then
					l_movto_nr_nfe_imp_w(l_movto_nr_nfe_imp_w.count + 1) := nr_nfe_imp_w;
					l_seq_movto_contabil_doc_w(l_seq_movto_contabil_doc_w.count + 1) :=   l_c01[i].nr_sequencia;
					l_nr_seq_info_w(l_nr_seq_info_w.count + 1) :=   l_c01[i].nr_seq_info;
				end if;
			when 7 then
				nr_nfe_imp_w := ctb_uuid_pck.get_uuid_contas_pagar(l_c01[i].nr_documento,l_c01[i].nr_seq_doc_compl);
				if (nr_nfe_imp_w IS NOT NULL AND nr_nfe_imp_w::text <> '') then
					l_movto_nr_nfe_imp_w(l_movto_nr_nfe_imp_w.count + 1) := nr_nfe_imp_w;
					l_seq_movto_contabil_doc_w(l_seq_movto_contabil_doc_w.count + 1) :=   l_c01[i].nr_sequencia;
					l_nr_seq_info_w(l_nr_seq_info_w.count + 1) :=   l_c01[i].nr_seq_info;

				end if;
			else
				nr_nfe_imp_w:= null;
			end case;
			end;
			begin
			forall i in 1 .. l_movto_nr_nfe_imp_w.count
				update movimento_contabil_doc
				set nr_nfe_imp = l_movto_nr_nfe_imp_w(i)
				where nr_sequencia  = l_seq_movto_contabil_doc_w(i)
				and nr_seq_info = l_nr_seq_info_w(i);
			commit;

			l_movto_nr_nfe_imp_w.delete;
			l_seq_movto_contabil_doc_w.delete;
			l_nr_seq_info_w.delete;
			end;
			end loop;
		EXIT WHEN NOT FOUND; /* apply on c01 */
		end loop;
		close c01;
		end;
         end loop;
    EXIT WHEN NOT FOUND; /* apply on c00 */
    end loop;
close c00;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_reorg_movto_doc_uuid (dt_inicio_p timestamp, dt_fim_p timestamp ) FROM PUBLIC;

