-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ageint_gerar_wpanel_angular ( /*PARaMETROS LIBERAcaO DE AGENDAS*/
 nr_seq_ageint_p bigint, cd_estabelecimento_p bigint, cd_estab_agenda_p bigint, nr_seq_regiao_p bigint, cd_estab_multimed_p bigint, cd_empresa_multimed_p bigint, nm_usuario_p text, ie_transferencia_p text, ds_itens_selec_p text, cd_medico_exec_p text, dt_agenda_p timestamp, /*PARaMETROS GERAcaO DE HORaRIOS*/

 ds_agendas_montadas_p text default null, ds_erro_p INOUT text DEFAULT NULL, cd_regiao_p bigint default null, ie_prazo_maximo_p text default 'N', ie_genero_prof_p text default 'A', ie_limitrofes_p text default 'N') AS $body$
DECLARE

qt_agenda_lib_w		bigint := 0;
ds_erro_w			varchar(1);
ds_hor_min_w		bigint;
ds_hor_max_w		bigint;
ds_hor_min_livre_w	bigint;
ds_hor_max_livre_w	bigint;
dt_agenda_w			timestamp;
qt_agendamento_quimio_w	bigint := 0;


BEGIN
dt_agenda_w := to_date(to_char(coalesce(dt_agenda_p,clock_timestamp()), 'dd/mm/yyyy'), 'dd/mm/yyyy');

if (nr_seq_ageint_p IS NOT NULL AND nr_seq_ageint_p::text <> '') then

	CALL Gerar_AgeInt_lib_Usuario(
							nr_seq_ageint_p,
							cd_estabelecimento_p,
							cd_estab_agenda_p,
							nr_seq_regiao_p,
							cd_estab_multimed_p,
							cd_empresa_multimed_p,
							nm_usuario_p,
							ie_transferencia_p,
							ds_itens_selec_p,
							cd_medico_exec_p,
							dt_agenda_p,
              cd_regiao_p,
			  ie_genero_prof_p,
              ie_limitrofes_p);
end if;

select	count(1)
into STRICT	qt_agenda_lib_w
from 	ageint_lib_usuario
where 	nr_seq_ageint = nr_seq_ageint_p
and 	nm_usuario = nm_usuario_p;

if (qt_agenda_lib_w > 0) then

	SELECT * FROM gerar_horarios_ageint(
							dt_agenda_w, nm_usuario_p, nr_seq_ageint_p, cd_estabelecimento_p, ds_agendas_montadas_p, ds_hor_min_w, ds_hor_max_w, ds_hor_min_livre_w, ds_hor_max_livre_w, ie_prazo_maximo_p) INTO STRICT ds_hor_min_w, ds_hor_max_w, ds_hor_min_livre_w, ds_hor_max_livre_w;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageint_gerar_wpanel_angular (  nr_seq_ageint_p bigint, cd_estabelecimento_p bigint, cd_estab_agenda_p bigint, nr_seq_regiao_p bigint, cd_estab_multimed_p bigint, cd_empresa_multimed_p bigint, nm_usuario_p text, ie_transferencia_p text, ds_itens_selec_p text, cd_medico_exec_p text, dt_agenda_p timestamp,  ds_agendas_montadas_p text default null, ds_erro_p INOUT text DEFAULT NULL, cd_regiao_p bigint default null, ie_prazo_maximo_p text default 'N', ie_genero_prof_p text default 'A', ie_limitrofes_p text default 'N') FROM PUBLIC;

