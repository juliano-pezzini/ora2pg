-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hem_inserir_frase_padrao ( nr_seq_frase_padrao_p bigint, nr_seq_proc_p bigint, nm_usuario_p text, nr_Seq_obs_lesao_p bigint) AS $body$
DECLARE


ds_observacao_laudo_w	varchar(2000);
ds_frase_w		varchar(255);
nr_seq_observacao_w	bigint;


BEGIN
if (coalesce(nr_seq_frase_padrao_p,0) > 0) then

	select	max(ds_frase)
	into STRICT	ds_frase_w
	from	hem_frase_padrao
	where	nr_sequencia = nr_seq_frase_padrao_p;

	select	max(nr_sequencia)
	into STRICT	nr_seq_observacao_w
	from	hem_observacao_laudo
	where	nr_seq_proc	= nr_seq_proc_p;

	if (coalesce(nr_Seq_obs_lesao_p, 0) = 0) then

		if (coalesce(nr_seq_observacao_w,0) > 0) then

			select	max(ds_observacao_laudo)
			into STRICT	ds_observacao_laudo_w
			from	hem_observacao_laudo
			where	nr_seq_proc	= nr_seq_proc_p;

			if (coalesce(ds_observacao_laudo_w::text, '') = '') then
				ds_observacao_laudo_w := ds_frase_w;
			else
				ds_observacao_laudo_w := substr(ds_observacao_laudo_w || chr(13) || chr(10) || ds_frase_w,1,2000);
			end if;

			update	hem_observacao_laudo
			set	DS_OBSERVACAO_LAUDO	= ds_observacao_laudo_w,
				nm_usuario		= nm_usuario_p,
				dt_atualizacao		= clock_timestamp()
			where	nr_seq_proc		= nr_seq_proc_p;
		else

			insert	into hem_observacao_laudo(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_proc,
				ds_observacao_laudo
			) values (
				nextval('hem_observacao_laudo_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_proc_p,
				ds_frase_w);
		end if;
	end if;

	if (coalesce(nr_Seq_obs_lesao_p, 0) > 0) then

		select 	max(ds_observacao)
		into STRICT 	ds_observacao_laudo_w
		from	hem_lesao
		where	nr_sequencia = nr_Seq_obs_lesao_p;

		if (coalesce(ds_observacao_laudo_w::text, '') = '') then
			ds_observacao_laudo_w := ds_frase_w;
		else
			ds_observacao_laudo_w := substr(ds_observacao_laudo_w || chr(13) || chr(10) || ds_frase_w,1,2000);
		end if;

		update 	hem_lesao
		set	ds_observacao 	= ds_observacao_laudo_w,
			nm_usuario		= nm_usuario_p,
			dt_atualizacao	= clock_timestamp()
		where	nr_sequencia	= nr_Seq_obs_lesao_p;
	end if;
end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hem_inserir_frase_padrao ( nr_seq_frase_padrao_p bigint, nr_seq_proc_p bigint, nm_usuario_p text, nr_Seq_obs_lesao_p bigint) FROM PUBLIC;

