-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_terceiro_oper_reserv ( cd_estabelecimento_p bigint, nr_seq_operacao_p bigint, dt_operacao_p timestamp, cd_material_p bigint, ie_origem_proced_p bigint, cd_procedimento_p bigint, qt_operacao_p bigint, vl_operacao_p bigint, nm_usuario_p text, cd_pessoa_fisica_p text, nr_seq_nut_reserva_p bigint, ie_origem_chamada_p text ) AS $body$
DECLARE

 
				 
nr_seq_terceiro_w		bigint  := 0;
nr_seq_operacao_terceiro_w	bigint;
cd_pessoa_fisica_w		varchar(10);
qt_itens_w			bigint;
ie_permite_terc_multi_w		varchar(1);
cd_local_estoque_padrao_w	terceiro_operacao.cd_local_estoque%type;
				

BEGIN 
ie_permite_terc_multi_w	:= obter_valor_param_usuario(7026, 6, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, cd_estabelecimento_p);
cd_local_estoque_padrao_w := somente_numero(obter_valor_param_usuario(7026, 39, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, cd_estabelecimento_p));
 
 
select 	coalesce(max(b.nr_sequencia),0) 
into STRICT	nr_seq_terceiro_w 
from 	terceiro b 
where 	b.cd_pessoa_fisica  	= cd_pessoa_fisica_p 
and	coalesce(b.ie_situacao,'A')	= 'A' 
and 	b.cd_estabelecimento 	= cd_estabelecimento_p;
 
if not(nr_seq_terceiro_w > 0) then 
 
	select 	coalesce(max(a.nr_seq_terceiro),0) 
	into STRICT	nr_seq_terceiro_w 
	from 	terceiro_pessoa_fisica a, 
		terceiro b 
	where 	a.cd_pessoa_fisica  	= cd_pessoa_fisica_p 
	and 	b.cd_estabelecimento 	= cd_estabelecimento_p 
	and	a.nr_seq_terceiro 	= b.nr_sequencia;
 
end if;
 
 
if not(nr_seq_terceiro_w > 0) then 
	CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(249292); --'A pessoa física da reserva não possui terceiro informado!' 
end if;	
 
select 	count(*) 
into STRICT	qt_itens_w 
from	nut_reserva_pf 
where	nr_sequencia = nr_seq_nut_reserva_p 
and	(nr_seq_terceiro_operacao IS NOT NULL AND nr_seq_terceiro_operacao::text <> '');
 
 
IF (qt_itens_w > 0) AND (ie_permite_terc_multi_w <> 'R') and (ie_origem_chamada_p = 'D') THEN 
 
	CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(249293); --,'Já foi gerado operação no controle de terceiros para esta reserva #@#@' 
end if;
 
 
select 	nextval('terceiro_operacao_seq') 
into STRICT 	nr_seq_operacao_terceiro_w
;
	 
 
insert 	into terceiro_operacao( 
	nr_sequencia, 
	cd_estabelecimento, 
	nr_seq_terceiro, 
	nr_seq_operacao, 
	tx_operacao, 
	dt_atualizacao, 
	nm_usuario, 
	nr_doc, 
	nr_seq_doc, 
	dt_operacao, 
	cd_material, 
	ie_origem_proced, 
	cd_procedimento, 
	qt_operacao, 
	vl_operacao, 
	nr_lote_contabil, 
	nr_seq_conta, 
	cd_pessoa_fisica, 
	cd_local_estoque 
	) 
values ( 
	nr_seq_operacao_terceiro_w, 
	cd_estabelecimento_p, 
	nr_seq_terceiro_w, 
	nr_seq_operacao_p, 
	0, 
	clock_timestamp(), 
	nm_usuario_p, 
	nextval('terceiro_doc_seq'), 
	1, 
	dt_operacao_p, 
	CASE WHEN cd_material_p=0 THEN null  ELSE cd_material_p END , 
	CASE WHEN ie_origem_proced_p=0 THEN null  ELSE ie_origem_proced_p END , 
	CASE WHEN cd_procedimento_p=0 THEN null  ELSE cd_procedimento_p END , 
	qt_operacao_p, 
	vl_operacao_p, 
	0, 
	null, 
	cd_pessoa_fisica_p, 
	CASE WHEN cd_local_estoque_padrao_w=0 THEN  null  ELSE cd_local_estoque_padrao_w END  
	);
 
	 
CALL atualizar_operacao_terceiro(nr_seq_operacao_terceiro_w,nm_usuario_p);
 
if (ie_permite_terc_multi_w = 'R' or ie_origem_chamada_p = 'M') then 
	begin 
	update	terceiro_operacao 
	set	nr_seq_reserva_pf	= nr_seq_nut_reserva_p 
	where	nr_sequencia		= nr_seq_operacao_terceiro_w;
	end;
elsif (ie_permite_terc_multi_w <> 'R') then 
	begin 
	update	nut_reserva_pf 
	set	nr_seq_terceiro_operacao = nr_seq_operacao_terceiro_w 
	where	nr_sequencia = nr_seq_nut_reserva_p;
	end;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_terceiro_oper_reserv ( cd_estabelecimento_p bigint, nr_seq_operacao_p bigint, dt_operacao_p timestamp, cd_material_p bigint, ie_origem_proced_p bigint, cd_procedimento_p bigint, qt_operacao_p bigint, vl_operacao_p bigint, nm_usuario_p text, cd_pessoa_fisica_p text, nr_seq_nut_reserva_p bigint, ie_origem_chamada_p text ) FROM PUBLIC;

