-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_ci_alta_prevista ( nr_atendimento_p bigint, nm_usuario_p text, dt_previsto_alta_p text) AS $body$
DECLARE

 
ds_titulo_w					varchar(255);
nm_paciente_w				varchar(255);
ds_comunicado_w				varchar(4000);
cd_perfil_w					bigint;
nr_sequencia_w				bigint;
nr_Seq_regra_w				bigint;
ds_perfil_adicional_w		varchar(4000) := '';
nm_usuario_dest_w			varchar(15);
nm_usuario_dest_ww			varchar(4000)	:= '';
ds_setor_w					varchar(255);
ds_unidade_w				varchar(255);
	
ie_probabilidade_alta_w		varchar(255);
ds_obs_prev_alta_w			varchar(255);
	
cd_pessoa_fisica_w			bigint;
cd_especialidade_w			varchar(255);

c02 CURSOR FOR 
SELECT	ds_titulo, 
	ds_comunicado, 
	nr_sequencia, 
	substr(obter_unidade_atendimento(nr_atendimento_p,'A','S'),1,255) ds_setor, 
	substr(obter_unidade_atendimento(nr_atendimento_p,'A','U'),1,255) ds_unidade 
from	regra_envio_ci_prev_alta;

c03 CURSOR FOR 
SELECT	distinct cd_perfil, 
		nm_usuario_dest 
from	regra_envio_prev_alta_perf 
where	nr_seq_regra	= nr_seq_regra_w;


BEGIN 
 
select	min(nr_sequencia) 
into STRICT	nr_sequencia_w 
from	comunic_interna_classif 
where	ie_tipo	= 'F';
 
select	max(a.cd_pessoa_fisica) 
into STRICT	cd_pessoa_fisica_w 
from	pessoa_fisica a 
where	a.nm_usuario = nm_usuario_p;
 
SELECT	max(substr(obter_nome_pf(b.cd_pessoa_fisica),0,255)), 
	max(SUBSTR(obter_valor_dominio(1267,a.ie_probabilidade_alta)||Obter_Desc_Dias_Prev_Alta(a.ie_probabilidade_alta,coalesce(obter_especialidade_pf(cd_pessoa_fisica_w),0)),1,255)), 
	max(a.ds_obs_prev_alta) 
INTO STRICT	nm_paciente_w, 
	ie_probabilidade_alta_w, 
	ds_obs_prev_alta_w 
FROM	atendimento_paciente a, 
	pessoa_fisica b 
WHERE	a.nr_atendimento = nr_atendimento_p 
AND	a.cd_pessoa_fisica = b.cd_pessoa_fisica;
 
if (dt_previsto_alta_p IS NOT NULL AND dt_previsto_alta_p::text <> '') then 
 
	open C02;
	loop 
	fetch C02 into	 
		ds_titulo_w, 
		ds_comunicado_w, 
		nr_seq_regra_w, 
		ds_setor_w, 
		ds_unidade_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
			 
		ds_comunicado_w := 	ds_comunicado_w || chr(13) || 
					obter_desc_expressao(343877)/*'Paciente: '*/
 || nm_paciente_w || chr(13) || 
					obter_desc_expressao(775048)/*'Atendimento: '*/
 || nr_atendimento_p || chr(13) || 
					obter_desc_expressao(491974)||': '/*'Data alta prevista: '*/ || dt_previsto_alta_p || chr(13) || 
					obter_desc_expressao(296347)||': '/*'Probabilidade de alta'*/ || ie_probabilidade_alta_w || chr(13) || 
					obter_desc_expressao(329821)/*'Setor: ' */
|| ds_setor_w	|| chr(13) || 
					obter_desc_expressao(328005)/*'Unidade: '*/
 || ds_unidade_w || chr(13) || 
					obter_desc_expressao(329252)/*'Observação: '*/
 || ds_obs_prev_alta_w;
		open C03;
		loop 
		fetch C03 into	 
			cd_perfil_w, 
			nm_usuario_dest_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin 
			nm_usuario_dest_ww	:=	nm_usuario_dest_ww || nm_usuario_dest_w || ',';
			ds_perfil_adicional_w 	:=	ds_perfil_adicional_w || cd_perfil_w ||',';
			end;
		end loop;
		close C03;
 
		if (ds_perfil_adicional_w IS NOT NULL AND ds_perfil_adicional_w::text <> '') then 
 
			insert	into comunic_interna(	 
					dt_comunicado, 
					ds_titulo, 
					ds_comunicado, 
					nm_usuario, 
					dt_atualizacao, 
					ie_geral, 
					ie_gerencial, 
					ds_perfil_adicional, 
					nr_sequencia, 
					nr_seq_classif, 
					dt_liberacao, 
					nm_usuario_destino) 
				values ( 
					clock_timestamp(), 
					ds_titulo_w, 
					ds_comunicado_w, 
					nm_usuario_p, 
					clock_timestamp(), 
					'N', 
					'N', 
					ds_perfil_adicional_w, 
					nextval('comunic_interna_seq'), 
					nr_sequencia_w, 
					clock_timestamp(), 
					nm_usuario_dest_ww);	
		end if;	
		 
		end;
	end loop;
	close C02;
 
end if;	
	 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_ci_alta_prevista ( nr_atendimento_p bigint, nm_usuario_p text, dt_previsto_alta_p text) FROM PUBLIC;

