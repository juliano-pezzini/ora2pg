-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_envio_comunicacao ( nr_sequencia_p bigint, ie_evento_p text, ds_valor_ant_p text, ds_valor_atual_p text, nm_usuario_p text, ds_valor_atual_aux_p text default null) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Gerar comunicacao interna de acao sobre a ordem de servico
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[ X ]  Objetos do dicionario [ X ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
-------------------------------------------------------------------------------------------------------------------

Referencias:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


/*campos regra*/

nr_seq_regra_w			bigint;
ds_titulo_w			varchar(255);
ds_comunicacao_w			varchar(32000);
ie_comunicacao_interna_w		varchar(01);
ie_email_w			varchar(01);
ds_valor_ant_w			varchar(20);
ds_valor_atual_w			varchar(20);
nr_seq_equip_os_w			bigint;
nr_seq_localizacao_os_w		man_ordem_servico.nr_seq_localizacao%type;
nr_seq_equip_regra_w		bigint;
ds_equipamento_w			varchar(80);
qt_existe_w			bigint;
nr_seq_classif_w			bigint;
ie_usuario_w			varchar(15);
cd_cargo_w			cargo.cd_cargo%type;
nm_usuario_resp_local_w		usuario.nm_usuario%type;
ds_usuario_destino_w		varchar(2000);
ds_lista_email_destino_w		varchar(2000);
ds_lista_email_oculta_w		varchar(2000);
ds_email_origem_w			varchar(255);
cd_perfil_w			integer	:= obter_perfil_ativo;
ds_usuario_desconsid_regra_w	varchar(2000);
ie_classificacao_regra_w		varchar(15);
nr_seq_estagio_regra_w		bigint;
ie_prioridade_regra_w		varchar(15);
ie_fora_horario_manut_w		varchar(15);
dt_hr_inicio_w			timestamp;
dt_hr_fim_w			timestamp;
ie_solic_vip_w			varchar(15);
ds_usuario_email_w			varchar(15);
ds_endereco_ordem_wheb_w		varchar(255);

/*campos OS*/

ds_dano_breve_w			varchar(255);
ds_dano_w			varchar(4000);
ds_localizacao_w			varchar(255);
cd_pessoa_solicitante_w		varchar(10);
nm_usuario_solic_w			varchar(15);
nm_pessoa_solic_w			varchar(150);
usuario_resp_setor_solic_w		varchar(15);
nm_usuario_exec_ordem_w		varchar(15);
ds_estagio_ant_w			varchar(255);
ds_estagio_atual_w			varchar(255);
ds_estagio_os_w			varchar(255);
ds_situacao_ant_w			varchar(255);
ds_situacao_atual_w		varchar(255);
ds_situacao_os_w			varchar(255);
nr_seq_grupo_planej_w		bigint;
nr_seq_grupo_trabalho_w		bigint;
ds_grau_satisf_ant_w		varchar(255);
ds_grau_satisf_atual_w		varchar(255);
ds_grau_satisf_os_w		varchar(255);
nr_seq_ordem_w			bigint;
ds_usu_exec_ativ_atual_w		varchar(40);
ds_funcao_ativ_atual_w		varchar(80);
ds_atividade_w			varchar(2000);
ds_observacao_ativ_w		varchar(4000);
ie_classificacao_os_w		varchar(15);
nr_seq_estagio_os_w		bigint;
ie_prioridade_os_w			varchar(15);
nm_usuario_origem_w		varchar(100);
ds_solucao_w			varchar(255);
ds_justif_grau_satisf_w	varchar(255);
ie_solic_vip_os_w			varchar(15);

/*Campos CI*/

nm_usuario_w			varchar(2000);

/*Campos EMAIL*/

lista_usuario_w			varchar(2000);
tam_lista_w			bigint;
ie_pos_virgula_w			smallint;
ds_email_usuario_w			varchar(255);
ds_lista_email_usuario_w		varchar(2000);

/* Todos executores da OS */

nm_usuario_exec_w		varchar(15);
nm_usuario_todos_exec_w		varchar(255);
nm_pessoa_fisica_exec_w		varchar(60);
nm_pessoa_todos_exec_w		varchar(255);

/* Usuarios do grupo de planejamento da regra */

nm_usuario_grupo_planej_w		varchar(255);
ds_grupo_planej_ant_w		varchar(50);
ds_grupo_planej_atual_w		varchar(50);
ds_grupo_planej_os_w		varchar(50);

/* Usuarios do grupo de trabalho da regra */

nm_usuario_grupo_trab_w		varchar(15);
ds_grupo_trab_ant_w		varchar(50);
ds_grupo_trab_atual_w		varchar(50);
ds_grupo_trab_os_w		varchar(50);

/*Campos do historico*/

ds_historico_w			varchar(32000);
nr_seq_rtf_srtring_w			bigint;
ds_mensagem_historico_w		varchar(32000);
nr_seq_ult_hist_w			bigint;
ds_pos_inicio_rtf_w			bigint;

ie_gerar_w			varchar(01) := 'S';

ie_tipo_ordem_w			man_regra_envio_comunic.ie_tipo_ordem%type;
ie_marcar_ci_lida_remetente_w	man_regra_envio_comunic.ie_marcar_ci_lida_remetente%type;
ie_tipo_ordem_os_w		man_ordem_servico.ie_tipo_ordem%type;
nr_seq_comunic_w			comunic_interna.nr_sequencia%type;
ie_lista_destino_oculta_w		man_regra_envio_comunic.ie_lista_destino_oculta%type;

ds_pos_inicio_rtf_java_w	bigint;
ds_pos_inicio_html_w    bigint;

c01 CURSOR FOR
	SELECT	nr_sequencia,
		ds_titulo,
		ds_comunicacao,
		ie_comunicacao_interna,
		ie_email,
		ds_valor_ant,
		ds_valor_atual,
		nr_seq_equipamento,
		ds_lista_email_destino,
		ds_email_origem,
		ds_usuario_desconsid_regra,
		ie_classificacao,
		ie_prioridade,
		ie_fora_horario_manut,
		ie_solic_vip,
		CASE WHEN coalesce(ie_param_cliente_email_origem,'N')='S' THEN null  ELSE nm_usuario_p END ,
		ie_tipo_ordem,
		coalesce(ie_marcar_ci_lida_remetente, 'N'),
		coalesce(ie_lista_destino_oculta,'N'),
		nr_seq_estagio
	from	man_regra_envio_comunic
	where	ie_evento = ie_evento_p
	and	coalesce(ie_situacao,'A') = 'A';

c02 CURSOR FOR
	SELECT	ie_usuario,
		ds_usuario_destino,
		cd_cargo
	from	man_usuarios_comunicacao
	where	nr_seq_regra = nr_seq_regra_w;

/* Todos executores da OS */

c03 CURSOR FOR
	SELECT	nm_usuario_exec,
		substr(obter_pessoa_fisica_usuario(nm_usuario_exec,'N'),1,255)
	from	man_ordem_servico_exec
	where	nr_seq_ordem = nr_seq_ordem_w;

/* Todos usuarios do grupo de trabalho da regra. */

c04 CURSOR FOR
	SELECT	nm_usuario_param
	from	man_grupo_trab_usuario
	where	nr_seq_grupo_trab = ds_valor_atual_p;

/* Usuarios do grupo de trabalho atual da OS */

C05 CURSOR FOR
	SELECT	nm_usuario_param
	from	man_grupo_trab_usuario
	where	nr_seq_grupo_trab = coalesce(ds_valor_atual_aux_p,nr_seq_grupo_trabalho_w);

c06 CURSOR FOR
	SELECT	b.nm_usuario
	from 	usuario b,
		man_resp_localizacao a
	where	b.cd_pessoa_fisica = a.cd_pessoa_resp_localizacao
	and	b.ie_situacao = 'A'
	and	a.nr_seq_localizacao = nr_seq_localizacao_os_w
	and	coalesce(a.ie_tipo_cargo,0) = coalesce(cd_cargo_w,coalesce(a.ie_tipo_cargo,0));


BEGIN
if (ie_evento_p = '11') then
	select	nr_seq_ordem_serv
	into STRICT	nr_seq_ordem_w
	from	man_ordem_serv_ativ
	where	nr_sequencia = nr_sequencia_p;
else
	nr_seq_ordem_w := nr_sequencia_p;
end if;	

select	count(*)
into STRICT	qt_existe_w
from	man_regra_envio_comunic
where	ie_evento = ie_evento_p
and	coalesce(ie_situacao,'A') = 'A';

ds_endereco_ordem_wheb_w := substr(obter_valor_param_usuario(9043, 23, null, null, null), 1, 255);
if (ds_endereco_ordem_wheb_w = '') then
	ds_endereco_ordem_wheb_w := substr(obter_valor_param_usuario(0, 69, null, null, null), 1, 255);
end if;

begin
select	nr_seq_equipamento,
	nr_seq_localizacao,
	nr_grupo_planej,
	nr_grupo_trabalho,
	ie_classificacao,
	ie_prioridade,
	coalesce(ie_solic_vip,'N'),
	ie_tipo_ordem,
	nr_seq_estagio
into STRICT	nr_seq_equip_os_w,
	nr_seq_localizacao_os_w,
	nr_seq_grupo_planej_w,
	nr_seq_grupo_trabalho_w,
	ie_classificacao_os_w,
	ie_prioridade_os_w,
	ie_solic_vip_os_w,
	ie_tipo_ordem_os_w,
	nr_seq_estagio_os_w
from	man_ordem_servico
where	nr_sequencia = nr_seq_ordem_w;
exception
when others then
	nr_seq_ordem_w := 0;
end;

if (qt_existe_w > 0) and (nr_seq_ordem_w > 0) then
	begin
	open C01;
	loop
	fetch C01 into
		nr_seq_regra_w,
		ds_titulo_w,
		ds_comunicacao_w,
		ie_comunicacao_interna_w,
		ie_email_w,
		ds_valor_ant_w,
		ds_valor_atual_w,
		nr_seq_equip_regra_w,
		ds_lista_email_destino_w,
		ds_email_origem_w,
		ds_usuario_desconsid_regra_w,
		ie_classificacao_regra_w,
		ie_prioridade_regra_w,
		ie_fora_horario_manut_w,
		ie_solic_vip_w,
		ds_usuario_email_w,
		ie_tipo_ordem_w,
		ie_marcar_ci_lida_remetente_w,
		ie_lista_destino_oculta_w,
		nr_seq_estagio_regra_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ie_gerar_w			:= 'S';
		nm_usuario_w			:= null;
		nm_pessoa_todos_exec_w		:= null;
		nm_usuario_todos_exec_w		:= null;
		ds_lista_email_usuario_w	:= null;
		ds_lista_email_oculta_w		:= null;

		select	count(*)
		into STRICT	qt_existe_w
		from	man_regra_envio_comun_lib
		where	nr_seq_regra = nr_seq_regra_w;

		if (qt_existe_w > 0) then
			begin
			select	count(*)
			into STRICT	qt_existe_w
			from	man_regra_envio_comun_lib
			where	nr_seq_regra = nr_seq_regra_w
			and	((coalesce(cd_perfil::text, '') = '') and (coalesce(nr_seq_grupo_planej::text, '') = '') and (coalesce(nr_seq_grupo_trabalho::text, '') = ''));
			
			if (qt_existe_w = 0) then
				select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
				into STRICT	ie_gerar_w
				from	man_regra_envio_comun_lib
				where	nr_seq_regra = nr_seq_regra_w
				and	((cd_perfil = cd_perfil_w) or (nr_seq_grupo_planej = coalesce(nr_seq_grupo_planej_w,0)) or (nr_seq_grupo_trabalho = coalesce(nr_seq_grupo_trabalho_w,0)));
			end if;
			end;
		end if;

		if (coalesce(ds_valor_ant_w,'0') <> '0') and (coalesce(ds_valor_ant_w,'0') <> coalesce(ds_valor_ant_p,'0')) then
			ie_gerar_w := 'N';
		elsif (coalesce(ds_valor_atual_w,'0') <> '0') and (coalesce(ds_valor_atual_w,'0') <> coalesce(ds_valor_atual_p,'0')) then
			ie_gerar_w := 'N';
		elsif (coalesce(nr_seq_equip_regra_w,'0') <> '0') and (coalesce(nr_seq_equip_regra_w,'0') <> coalesce(nr_seq_equip_os_w,'0')) then
			ie_gerar_w := 'N';		
		elsif (coalesce(ie_classificacao_regra_w,'X') <> 'X') and (coalesce(ie_classificacao_regra_w,'X') <> coalesce(ie_classificacao_os_w,'X')) then
			ie_gerar_w := 'N';
		elsif (coalesce(nr_seq_estagio_regra_w,'0') <> '0') and (coalesce(nr_seq_estagio_regra_w,'0') <> coalesce(nr_seq_estagio_os_w,'0')) then
			ie_gerar_w := 'N';
		elsif (coalesce(ie_prioridade_regra_w,'X') <> 'X') and (coalesce(ie_prioridade_regra_w,'X') <> coalesce(ie_prioridade_os_w,'X')) then
			ie_gerar_w := 'N';
		elsif (coalesce(ie_solic_vip_w,'T') <> 'T') and (ie_solic_vip_w <> ie_solic_vip_os_w) then
			ie_gerar_w := 'N';
		elsif (ie_tipo_ordem_w IS NOT NULL AND ie_tipo_ordem_w::text <> '') and (ie_tipo_ordem_w <> ie_tipo_ordem_os_w) then
			ie_gerar_w	:= 'N';
		end if;
		
		if (coalesce(ie_gerar_w,'S') = 'S') and (coalesce(ie_fora_horario_manut_w,'N') = 'S') then
			begin
			select	max(to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || substr(hr_inicio,1,2) || ':' ||substr(hr_inicio,3,4),'dd/mm/yy hh24:mi')),
				max(to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || substr(hr_fim,1,2) || ':' ||substr(hr_fim,3,4),'dd/mm/yy hh24:mi'))
			into STRICT	dt_hr_inicio_w,
				dt_hr_fim_w
			from	man_horario_trabalho
			where	ie_dia_semana = to_char(PKG_DATE_UTILS.get_WeekDay(clock_timestamp()))
			and	man_obter_se_hor_trab_lib(nr_sequencia,nr_seq_grupo_planej_w,nr_seq_grupo_trabalho_w,nm_usuario_p) = 'S';
			
			if (clock_timestamp() >= coalesce(dt_hr_inicio_w,clock_timestamp() + interval '1 days'/1440)) and (clock_timestamp() <= coalesce(dt_hr_fim_w,clock_timestamp() - interval '1 days'/1440)) then
				ie_gerar_w := 'N';
			end if;
			end;
		end if;

		if (coalesce(ie_gerar_w,'S') = 'S') then
			begin			
			select	ds_dano_breve,
				substr(ds_dano,1,4000) ds_dano,
				substr(obter_usuario_pessoa(cd_pessoa_solicitante),1,15) nm_usuario_solic,
				substr(obter_nome_pf(cd_pessoa_solicitante),1,150) nm_pessoa_solic,
				substr(obter_dados_setor(obter_setor_usuario(obter_usuario_pessoa(cd_pessoa_solicitante)),'UR'),1,15) usuario_resp_setor_solic,
				substr(man_obter_desc_equipamento(nr_seq_equip_os_w),1,80) ds_equip,
				substr(man_obter_dados_estagio(nr_seq_estagio,'D'),1,255) ds_estagio,
				CASE WHEN ie_status_ordem='1' THEN obter_desc_expressao(283054) WHEN ie_status_ordem='2' THEN obter_desc_expressao(296477) WHEN ie_status_ordem='3' THEN obter_desc_expressao(310386)  ELSE obter_desc_expressao(327119) END  ds_situacao_os,
				substr(obter_desc_grupo_planej(nr_grupo_planej),1,80) ds_grupo_planej,
				substr(obter_desc_grupo_trab(nr_grupo_trabalho),1,80) ds_grupo_trabalho,
				substr(obter_valor_dominio(1197,ie_grau_satisfacao),1,255) ds_grau_satisf_os,
				substr(obter_nome_usuario(nm_usuario_nrec),1,100) nm_usuario_origem,
				ds_solucao,
				ds_justif_grau_satisf,
				substr(Obter_desc_man_localizacao(nr_seq_localizacao),1,80) ds_localizacao
			into STRICT	ds_dano_breve_w,
				ds_dano_w,
				nm_usuario_solic_w,
				nm_pessoa_solic_w,
				usuario_resp_setor_solic_w,
				ds_equipamento_w,
				ds_estagio_os_w,
				ds_situacao_os_w,
				ds_grupo_planej_os_w,
				ds_grupo_trab_os_w,
				ds_grau_satisf_os_w,
				nm_usuario_origem_w,
				ds_solucao_w,
				ds_justif_grau_satisf_w,
				ds_localizacao_w
			from	man_ordem_servico
			where	nr_sequencia = nr_seq_ordem_w;

			open C02;
			loop
			fetch C02 into
				ie_usuario_w,
				ds_usuario_destino_w,
				cd_cargo_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin

				if (ie_usuario_w = 'E') then -- Inclusao de novo executor na OS / Enviar para executor.
					open C03;
					loop
					fetch C03 into
						nm_usuario_exec_w,
						nm_pessoa_fisica_exec_w;
						EXIT WHEN NOT FOUND; /* apply on C03 */
						begin
						if (coalesce(nm_usuario_exec_w,'X') <> 'X') then
							nm_usuario_w := substr(nm_usuario_exec_w || ', ' ||nm_usuario_w,1,2000);
						end if;
						end;
					end loop;
					close C03;
				
					nm_pessoa_todos_exec_w	:=substr(nm_pessoa_todos_exec_w,1,length(nm_pessoa_todos_exec_w)-2);	
				end if;

				if (ie_usuario_w = 'S') and (coalesce(nm_usuario_solic_w,'X') <> 'X') then
					nm_usuario_w		:= substr(nm_usuario_solic_w || ', ' || nm_usuario_w,1,2000);
				end if;

				if (ie_usuario_w = 'R') and (coalesce(usuario_resp_setor_solic_w,'X') <> 'X') then
					nm_usuario_w		:= substr(usuario_resp_setor_solic_w || ', ' || nm_usuario_w,1,2000);
				end if;

				if (ie_usuario_w = 'U') and (coalesce(ds_usuario_destino_w,'X') <> 'X') then
					nm_usuario_w		:= substr(ds_usuario_destino_w || ', ' || nm_usuario_w,1,2000);
				end if;

				if (ie_usuario_w = 'L') then
					open C06;
					loop
					fetch C06 into	
						nm_usuario_resp_local_w;
					EXIT WHEN NOT FOUND; /* apply on C06 */
						nm_usuario_w	:= substr(nm_usuario_resp_local_w || ', ' || nm_usuario_w,1,2000);
					end loop;
					close C06;
				end if;
				
				if (ie_usuario_w = 'UGT') and
					((ie_evento_p <> '5') or
					((ie_evento_p = '5') and (coalesce(ds_valor_atual_p,'0') <> coalesce(ds_valor_atual_w,'0')))) then
					open C05;
					loop
					fetch C05 into	
						nm_usuario_grupo_trab_w;
					EXIT WHEN NOT FOUND; /* apply on C05 */
						begin
						nm_usuario_w := substr(nm_usuario_grupo_trab_w || ', ' || nm_usuario_w,1,2000);
						end;
					end loop;
					close C05;
				end if;
				end;
			end loop;
			close C02;

			if (position('@todos_usuarios_exec' in ds_comunicacao_w) > 0) or -- Verifica se a macro esta sendo usada na comunicacao.
				(position('@todos_usuarios_exec' in ds_titulo_w) > 0) then
				open C03;
				loop
				fetch C03 into
					nm_usuario_exec_w,
					nm_pessoa_fisica_exec_w;
					EXIT WHEN NOT FOUND; /* apply on C03 */
					begin
					if (coalesce(nm_pessoa_fisica_exec_w,'X') <> 'X') then
						nm_pessoa_todos_exec_w	:=	substr(nm_pessoa_fisica_exec_w || ', ' || nm_pessoa_todos_exec_w,1,255);
					end if;
					end;
				end loop;
				close C03;
			end if;

			if (coalesce(nm_pessoa_todos_exec_w,'X') <> 'X') then
				/* A linha abaixo remove os dois ultimos espacos da variavel, que corresponde a ultima virgula e um espaco*/

				nm_pessoa_todos_exec_w	:= substr(nm_pessoa_todos_exec_w,1,length(nm_pessoa_todos_exec_w)-2);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@todos_usuarios_exec', nm_pessoa_todos_exec_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@todos_usuarios_exec', nm_pessoa_todos_exec_w),1,255);
			end if;

			if (ds_dano_breve_w IS NOT NULL AND ds_dano_breve_w::text <> '') then
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_dano_breve', ds_dano_breve_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_dano_breve', ds_dano_breve_w),1,255);
			end if;
	
			if (coalesce(ds_dano_w,'X') <> 'X') then
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_dano', ds_dano_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_dano', ds_dano_w),1,255);
			end if;

			if (coalesce(ds_localizacao_w,'X') <> 'X') then
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_localizacao', ds_localizacao_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_localizacao', ds_localizacao_w),1,255);
			end if;
			
			if (coalesce(ds_equipamento_w,'X') <> 'X') then
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_equipamento', ds_equipamento_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_equipamento', ds_equipamento_w),1,255);
			end if;

			if (coalesce(nm_pessoa_solic_w,'X') <> 'X') then
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_solicitante', nm_pessoa_solic_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@ds_solicitante', nm_pessoa_solic_w),1,255);
			end if;
			
			if (coalesce(nm_usuario_origem_w,'X') <> 'X') then
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@nm_usuario_origem', nm_usuario_origem_w),1,32000);
				ds_titulo_w	:= substr(replace_macro(ds_titulo_w, '@nm_usuario_origem', nm_usuario_origem_w),1,255);
			end if;
			
			ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_solucao', ds_solucao_w),1,32000);
			ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_solucao', ds_solucao_w),1,255);
			
			ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@justificativa_satisfacao', ds_justif_grau_satisf_w),1,32000);
			ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@justificativa_satisfacao', ds_justif_grau_satisf_w),1,255);

			ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@nr_ordem_servico', nr_seq_ordem_w),1,32000);
			ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@nr_ordem_servico', nr_seq_ordem_w),1,255);

			if (ie_evento_p <> '1') then
				begin
				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_estagio_atual', ds_estagio_os_w),1,255);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_estagio_atual', ds_estagio_os_w),1,32000);
				end;
			end if;
			
			if (ie_evento_p <> '2') then
				begin
				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_situacao_atual', ds_situacao_os_w),1,255);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_situacao_atual', ds_situacao_os_w),1,32000);
				end;
			end if;
			
			if (ie_evento_p <> '5') then
				begin
				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_grupo_trab_atual', ds_grupo_trab_os_w),1,255);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_grupo_trab_atual', ds_grupo_trab_os_w),1,32000);
				end;
			end if;
			
			if (ie_evento_p <> '9') then
				begin
				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_grau_satisf_atual', ds_grau_satisf_os_w),1,255);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_grau_satisf_atual', ds_grau_satisf_os_w),1,32000);
				end;
			end if;
			
			if (ie_evento_p <> '12') then
				begin
				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_grupo_planej_atual', ds_grupo_planej_os_w),1,255);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_grupo_planej_atual', ds_grupo_planej_os_w),1,32000);
				end;
			end if;
		
			if (ie_evento_p = '1') then	/* Alteracao estagio */
				begin
				select	max(ds_estagio_ant),
					max(ds_estagio_atual)
				into STRICT	ds_estagio_ant_w,
					ds_estagio_atual_w
				from (SELECT	ds_estagio ds_estagio_ant,
						'' ds_estagio_atual
					from	man_estagio_processo
					where	nr_sequencia	= ds_valor_ant_p
					
union all

					SELECT	'',
						ds_estagio ds_estagio_atual
					from	man_estagio_processo
					where	nr_sequencia	= ds_valor_atual_p) alias3;

				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_estagio_ant', ds_estagio_ant_w),1,32000);
				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_estagio_ant', ds_estagio_ant_w),1,255);

				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_estagio_atual', ds_estagio_atual_w),1,32000);
				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_estagio_atual', ds_estagio_atual_w),1,255);
								
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@justificativa_satisfacao', ds_justif_grau_satisf_w),1,32000);
				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@justificativa_satisfacao', ds_justif_grau_satisf_w),1,255);
				end;
			elsif (ie_evento_p = '2') then	/* Alteracao situacao */
				begin

				select	CASE WHEN ds_valor_ant_p='1' THEN obter_desc_expressao(283054) WHEN ds_valor_ant_p='2' THEN obter_desc_expressao(296477) WHEN ds_valor_ant_p='3' THEN obter_desc_expressao(310386)  ELSE obter_desc_expressao(327119) END ,
					CASE WHEN ds_valor_atual_p='1' THEN obter_desc_expressao(283054) WHEN ds_valor_atual_p='2' THEN obter_desc_expressao(296477) WHEN ds_valor_atual_p='3' THEN obter_desc_expressao(310386)  ELSE obter_desc_expressao(327119) END
				into STRICT	ds_situacao_ant_w,
					ds_situacao_atual_w
				;

				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_situacao_ant', ds_situacao_ant_w),1,32000);
				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_situacao_ant', ds_situacao_ant_w),1,255);

				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_situacao_atual', ds_situacao_atual_w),1,32000);
				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_situacao_atual', ds_situacao_atual_w),1,255);
				
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@justificativa_satisfacao', ds_justif_grau_satisf_w),1,32000);
				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@justificativa_satisfacao', ds_justif_grau_satisf_w),1,255);
				end;
			elsif (ie_evento_p = '5') then	/* Inclusao do grupo de trabalho */
				begin
				select	count(*)
				into STRICT	qt_existe_w
				from	man_grupo_trabalho
				where	nr_sequencia	= ds_valor_ant_p;

				if (qt_existe_w > 0) then
					begin
					select	substr(obter_desc_expressao(cd_exp_grupo_trabalho,ds_grupo_trabalho),1,255)
					into STRICT	ds_grupo_trab_ant_w
					from	man_grupo_trabalho
					where	nr_sequencia	= ds_valor_ant_p;
					end;
				end if;
				
				select	count(*)
				into STRICT	qt_existe_w
				from	man_grupo_trabalho
				where	nr_sequencia	= ds_valor_atual_p;

				if (qt_existe_w > 0) then
					begin
					select	substr(obter_desc_expressao(cd_exp_grupo_trabalho,ds_grupo_trabalho),1,255)
					into STRICT	ds_grupo_trab_atual_w
					from	man_grupo_trabalho
					where	nr_sequencia	= ds_valor_atual_p;
					end;
				end if;

				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_grupo_trab_ant', ds_grupo_trab_ant_w),1,32000);
				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_grupo_trab_ant', ds_grupo_trab_ant_w),1,255);

				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_grupo_trab_atual', ds_grupo_trab_atual_w),1,32000);
				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_grupo_trab_atual', ds_grupo_trab_atual_w),1,255);
				end;
			elsif (ie_evento_p = '7') then	/* Encerramento da OS */
				begin
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_link_grau_satisfacao', ds_endereco_ordem_wheb_w || 'OrdemServicoWeb/montaTelaLogin.action?nrSeqOrdem=' || nr_seq_ordem_w),1,32000);
				end;
			elsif (ie_evento_p = '9') then	/* Alteracao do grau de satisfacao da OS */
				begin
				select	substr(obter_valor_dominio(1197,ds_valor_ant_p),1,255),
					substr(obter_valor_dominio(1197,ds_valor_atual_p),1,255)
				into STRICT	ds_grau_satisf_ant_w,
					ds_grau_satisf_atual_w
				;
				
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_grau_satisf_ant', ds_grau_satisf_ant_w),1,32000);
				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_grau_satisf_ant', ds_grau_satisf_ant_w),1,255);

				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_grau_satisf_atual', ds_grau_satisf_atual_w),1,32000);
				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_grau_satisf_atual', ds_grau_satisf_atual_w),1,255);
				end;
			elsif (ie_evento_p = '11') then	/* Criacao de atividade realizada */
				begin
				select	substr(obter_nome_usuario(nm_usuario_exec),1,40) ds_usuario_exec,
					substr(obter_desc_tipo_funcao(nr_seq_funcao),1,80) ds_funcao,
					ds_atividade,
					ds_observacao
				into STRICT	ds_usu_exec_ativ_atual_w,
					ds_funcao_ativ_atual_w,
					ds_atividade_w,
					ds_observacao_ativ_w
				from	man_ordem_serv_ativ
				where	nr_sequencia	= nr_sequencia_p;
				
				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_usu_exec_ativ_atual', ds_usu_exec_ativ_atual_w),1,255);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_usu_exec_ativ_atual', ds_usu_exec_ativ_atual_w),1,32000);

				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_funcao_ativ_atual', ds_funcao_ativ_atual_w),1,255);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_funcao_ativ_atual', ds_funcao_ativ_atual_w),1,32000);
				
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_atividade_atual', ds_atividade_w),1,32000);				
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_obs_ativ_atual', ds_observacao_ativ_w),1,32000);
				
				end;
			elsif (ie_evento_p = '12') then	/* OS - Inclusao do grupo de planejamento */
				begin
				select	count(*)
				into STRICT	qt_existe_w
				from	man_grupo_planejamento
				where	nr_sequencia = ds_valor_ant_p;

				if (qt_existe_w > 0) then
					begin
					select	ds_grupo_planej
					into STRICT	ds_grupo_planej_ant_w
					from	man_grupo_planejamento
					where	nr_sequencia	= ds_valor_ant_p;
					end;
				end if;
				
				select	count(*)
				into STRICT	qt_existe_w
				from	man_grupo_planejamento
				where	nr_sequencia	= ds_valor_atual_p;

				if (qt_existe_w > 0) then
					begin
					select	ds_grupo_planej
					into STRICT	ds_grupo_planej_atual_w
					from	man_grupo_planejamento
					where	nr_sequencia	= ds_valor_atual_p;
					end;
				end if;

				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_grupo_planej_ant', ds_grupo_planej_ant_w),1,255);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_grupo_planej_ant', ds_grupo_planej_ant_w),1,32000);

				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_grupo_planej_atual', ds_grupo_planej_atual_w),1,255);
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_grupo_planej_atual', ds_grupo_planej_atual_w),1,32000);
				end;
			end if;

			select	count(*)
			into STRICT	qt_existe_w
			from	man_ordem_serv_tecnico
			where	nr_seq_ordem_serv = nr_seq_ordem_w;

			if (qt_existe_w > 0) then
				begin	/* Pega o ultimo historico da ordem de servico*/
				select	max(nr_sequencia)
				into STRICT	nr_seq_ult_hist_w
				from	man_ordem_serv_tecnico
				where	nr_seq_ordem_serv = nr_seq_ordem_w;

				ds_mensagem_historico_w := convert_long_to_string('ds_relat_tecnico','man_ordem_serv_tecnico','nr_sequencia	= ' || nr_seq_ult_hist_w);
				
				ds_pos_inicio_rtf_w	:= position('lang1046' in ds_mensagem_historico_w) +8;
				
				ds_pos_inicio_rtf_java_w	:= position('JWord2' in ds_mensagem_historico_w)+8;
				
				ds_pos_inicio_html_w    := position('<html' in ds_mensagem_historico_w)+8;
				
				if (ds_pos_inicio_rtf_w <> 8) then
					begin
					nr_seq_rtf_srtring_w := converte_rtf_string(
						'select	a.ds_relat_tecnico
						 from	man_ordem_serv_tecnico a
						 where	a.nr_sequencia = :nr_sequencia_p', nr_seq_ult_hist_w, nm_usuario_p, nr_seq_rtf_srtring_w);
					select	ds_texto
					into STRICT	ds_mensagem_historico_w
					from	tasy_conversao_rtf
					where	nr_sequencia	= nr_seq_rtf_srtring_w;
					exception
					when others then
						ds_mensagem_historico_w	:= '';
					end;
				elsif (ds_pos_inicio_rtf_java_w <> 8) then
					begin
					nr_seq_rtf_srtring_w := converte_rtf_string(
						'select	a.ds_relat_tecnico
						 from	man_ordem_serv_tecnico a
						 where	a.nr_sequencia = :nr_sequencia_p', nr_seq_ult_hist_w, nm_usuario_p, nr_seq_rtf_srtring_w);
					select	ds_texto
					into STRICT	ds_mensagem_historico_w
					from	tasy_conversao_rtf
					where	nr_sequencia	= nr_seq_rtf_srtring_w;
					exception
					when others then
						ds_mensagem_historico_w	:= '';
					end;
				elsif (ds_pos_inicio_html_w <> 8) then
					begin
						ds_comunicacao_w := CONVERT_TEXT_TO_HTML(ds_comunicacao_w);
					exception
					when others then
						ds_mensagem_historico_w := '';
					end;
				end if;
				end;
			end if;

			if (coalesce(ds_mensagem_historico_w,'X') <> 'X') then
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_ultimo_historico',ds_mensagem_historico_w),1,32000);
				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_ultimo_historico', ds_mensagem_historico_w),1,255);
			else
				ds_comunicacao_w	:= substr(replace_macro(ds_comunicacao_w, '@ds_ultimo_historico', obter_desc_expressao(685809)),1,32000);
				ds_titulo_w		:= substr(replace_macro(ds_titulo_w, '@ds_ultimo_historico', obter_desc_expressao(685809)),1,255);
			end if;

			if (ie_evento_p = '5') and (ds_valor_atual_p = ds_valor_atual_w)  then	/*Inclusao do grupo de trabalho*/
 /*Envia comunicacao para todos usuarios do grupo de trabalho atual*/
				begin
				open C04;
				loop
				fetch C04 into
					nm_usuario_grupo_trab_w;
					EXIT WHEN NOT FOUND; /* apply on C04 */
					begin
					if (coalesce(nm_usuario_grupo_trab_w,'X') <> 'X') then
						nm_usuario_w	:= substr(nm_usuario_grupo_trab_w || ', ' || nm_usuario_w,1,2000);
					end if;
					end;
				end loop;
				close C04;
				end;
			end if;
			
			/*Desconsiderar executores*/

			if (coalesce(ds_usuario_desconsid_regra_w,'X') <> 'X') then
				begin
				nm_usuario_todos_exec_w := '';
				open C03;
				loop
				fetch C03 into
					nm_usuario_exec_w,
					nm_pessoa_fisica_exec_w;
					EXIT WHEN NOT FOUND; /* apply on C03 */
					begin
					if (coalesce(nm_usuario_exec_w,'X') <> 'X') then
						nm_usuario_todos_exec_w	:= substr(nm_usuario_exec_w || ', ' || nm_usuario_todos_exec_w,1,2000);
					end if;
					end;
				end loop;
				close C03;
				
				lista_usuario_w := substr(nm_usuario_todos_exec_w,1,2000);
				
				while(lista_usuario_w IS NOT NULL AND lista_usuario_w::text <> '') and (trim(both lista_usuario_w) <> ',') loop
					tam_lista_w	:= length(lista_usuario_w);
					ie_pos_virgula_w	:= position(',' in lista_usuario_w);

					if (ie_pos_virgula_w <> 0) then
						nm_usuario_todos_exec_w	:= substr(lista_usuario_w,1,(ie_pos_virgula_w - 1));
						lista_usuario_w		:= trim(both substr(lista_usuario_w,(ie_pos_virgula_w + 1), tam_lista_w));
					else
						lista_usuario_w		:= null;
					end if;
					
					if (position(nm_usuario_todos_exec_w in ds_usuario_desconsid_regra_w) > 0) then
						lista_usuario_w			:= null;
						ie_comunicacao_interna_w	:= 'N';
						ie_email_w			:= 'N';
					end if;					
				end loop;
				end;
			end if;

			if (ie_comunicacao_interna_w = 'S') then
				begin
				if (coalesce(nm_usuario_w,'X') <> 'X') then
					begin
					select	obter_classif_comunic('F')
					into STRICT	nr_seq_classif_w
					;
					
					select	nextval('comunic_interna_seq')
					into STRICT	nr_seq_comunic_w
					;
					
					insert into comunic_interna(dt_comunicado,
						ds_titulo,
						ds_comunicado,
						nm_usuario,
						dt_atualizacao,
						ie_geral,
						nm_usuario_destino,
						cd_perfil,
						nr_sequencia,
						ie_gerencial,
						nr_seq_classif,
						ds_perfil_adicional,
						cd_setor_destino,
						cd_estab_destino,
						ds_setor_adicional,
						dt_liberacao,
						ds_grupo,
						nm_usuario_oculto)
					values (clock_timestamp(),
						ds_titulo_w,
						ds_comunicacao_w,
						nm_usuario_p,
						clock_timestamp(),
						'N',
						nm_usuario_w,
						null,
						nr_seq_comunic_w,
						'N',
						nr_seq_classif_w,
						'',
						null,
						'',
						'',
						clock_timestamp(),
						'',
						'');
							
					if (ie_marcar_ci_lida_remetente_w = 'S') then
						insert into comunic_interna_lida(nr_sequencia,
							nm_usuario,
							dt_atualizacao)
						values (nr_seq_comunic_w,
							nm_usuario_p,
							clock_timestamp());
					end if;
					end;
				end if;
				end;
			end if;

			if (ie_email_w = 'S') then
				begin
				if (coalesce(ds_usuario_email_w,'X') = 'X') and (coalesce(ds_email_origem_w,'X') = 'X') then
					begin
					CALL wheb_mensagem_pck.exibir_mensagem_abort(249815,'DS_REGRA=' || substr('(' || nr_seq_regra_w || ') - ' || obter_valor_dominio(3420,ie_evento_p),1,255));
					end;
				end if;
				
				lista_usuario_w := substr(nm_usuario_w,1,2000);

				while(lista_usuario_w IS NOT NULL AND lista_usuario_w::text <> '') and (trim(both lista_usuario_w) <> ',') loop
					tam_lista_w	:= length(lista_usuario_w);
					ie_pos_virgula_w	:= position(',' in lista_usuario_w);

					if (ie_pos_virgula_w <> 0) then
						nm_usuario_w	:= substr(lista_usuario_w,1,(ie_pos_virgula_w - 1));
						lista_usuario_w	:= trim(both substr(lista_usuario_w,(ie_pos_virgula_w + 1), tam_lista_w));

						select	max(ds_email)
						into STRICT	ds_email_usuario_w
						from	usuario
						where	nm_usuario = nm_usuario_w;

						if (coalesce(ds_email_usuario_w,'X') <> 'X') then
							begin
							ds_lista_email_usuario_w	:= substr(ds_lista_email_usuario_w||ds_email_usuario_w||',',1,2000);
							end;
						end if;
					else
						lista_usuario_w	:= null;
					end if;
				end loop;

				if (coalesce(ds_lista_email_destino_w,'X') <> 'X') then
					begin
					if (coalesce(ie_lista_destino_oculta_w,'N') = 'N') then
						ds_lista_email_usuario_w	:= substr(ds_lista_email_destino_w || ',' || ds_lista_email_usuario_w,1,2000);
					else
						ds_lista_email_oculta_w		:= substr(ds_lista_email_destino_w,1,2000);
					end if;
					end;
				end if;
				
				if (coalesce(ds_lista_email_usuario_w,'X') <> 'X') then
					ds_lista_email_usuario_w 	:= replace(ds_lista_email_usuario_w,',',';');
					ds_lista_email_oculta_w 	:= replace(ds_lista_email_oculta_w,',',';');
					CALL enviar_email(	ds_titulo_w,
							ds_comunicacao_w,
							ds_email_origem_w, -- E-mail cadastrado na regra.
							ds_lista_email_usuario_w,
							ds_usuario_email_w,
							'M',
							ds_lista_email_oculta_w);
				end if;
				end;
			end if;
			end;
		end if;
		end;
	end loop;
	close C01;
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_envio_comunicacao ( nr_sequencia_p bigint, ie_evento_p text, ds_valor_ant_p text, ds_valor_atual_p text, nm_usuario_p text, ds_valor_atual_aux_p text default null) FROM PUBLIC;

