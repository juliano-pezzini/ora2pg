-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_texto_regra_ocorrencia ( nr_seq_regra_p bigint, ds_lista_atend_p text, ie_tipo_ocorrencia_p text, cd_pessoa_fisica_p text, cd_setor_atendimento_p bigint, nr_seq_ocorrencia_p bigint, nm_usuario_p text, ie_html5_p text default 'N') AS $body$
DECLARE


ds_texto_w			varchar(32764);
ds_texto_convert_w	varchar(32764);
ds_texto_atend_w	text;
ds_texto_saida_w	text;
ds_texto_macro_w	text;
ds_conteudo_1_w		varchar(32764);
ds_conteudo_2_w		varchar(32764);
nr_pos_atend_w		bigint;
nr_atend_atual_w	varchar(50);
i					bigint;
nr_seq_conversao_w	bigint;
nr_sequencia_w		bigint;
ds_texto_regra_w	varchar(32000);
ds_lista_atend_w	varchar(4000);
ds_campo_clob_w		text;
ds_texto_campo_w	text;
nm_paciente_w		varchar(255);
cd_pessoa_fisica_w	varchar(255);	
cd_profissional_w	varchar(255);
ds_auxiliar_w		varchar(32764);
ds_auxiliar_asd_w	varchar(32764);
nr_seq_ocorrencia_w	bigint;
ds_sql_w			varchar(2000);
retorno_w			integer;
c001				integer;
ds_ocorrencia_w		varchar(32764);
qt_reg_rtf_w        integer;


C10 CURSOR FOR
	SELECT	ds_texto
	from	w_ocorrencia_texto
	where	nm_usuario = nm_usuario_p
	order by nr_sequencia;

procedure insere(ds_texto_p text) is
	;
BEGIN
	select	nextval('w_ocorrencia_texto_seq')
	into STRICT	nr_seq_ocorrencia_w
	;
	
	insert into w_ocorrencia_texto(
				  nr_sequencia,
				  dt_atualizacao,
				  dt_atualizacao_nrec,
				  nm_usuario,
				  nm_usuario_nrec,
				  ds_texto)
		values (  nr_seq_ocorrencia_w,
				  clock_timestamp(),
				  clock_timestamp(),
				  nm_usuario_p,
				  nm_usuario_p,
				  ds_texto_p);
	commit;
	end;

begin
if ((trim(both ds_lista_atend_p) IS NOT NULL AND (trim(both ds_lista_atend_p))::text <> '')) and (coalesce(nr_seq_regra_p,0) > 0) then
	
	delete from w_ocorrencia_texto where nm_usuario = nm_usuario_p;
	commit;
	
	ds_lista_atend_w := replace(ds_lista_atend_p,',',';');
	
	if (substr(ds_lista_atend_w,length(ds_lista_atend_w))	<> ';') then
		ds_lista_atend_w	:= ds_lista_atend_w ||';';
		
	end if;

   if (ie_html5_p = 'S') then
        select	ds_ocorrencia
        into STRICT	ds_texto_regra_w
        from	ocorrencia
        where	nr_ocorrencia = nr_seq_ocorrencia_p;
    else
        nr_seq_conversao_w := converte_rtf_string('select ds_ocorrencia from ocorrencia where nr_ocorrencia = :nr_seq_ocorrencia_p', nr_seq_ocorrencia_p, 'Tasy', nr_seq_conversao_w);
		
      select	ds_texto
      into STRICT	ds_texto_regra_w
    	from	tasy_conversao_rtf
    	where	nr_sequencia = nr_seq_conversao_w;	
	
        if (coalesce(ds_texto_regra_w::text, '') = '' and ie_html5_p = 'N') then
            select 	ds_ocorrencia
            into STRICT 	ds_texto_regra_w
            from 	ocorrencia 
            where 	nr_ocorrencia = nr_seq_ocorrencia_p;
        end if;
    end if;

	insere(ds_texto_regra_w);
	
    if (ie_html5_p = 'S') then
        if (position('<HTML TASY="HTML5">' in upper(convert_long_to_string('DS_TEXTO', 'REGRA_OCORRENCIA_TURNO', 'nr_sequencia = ' || nr_seq_regra_p))) > 0) then
            select ds_texto
            into STRICT	ds_texto_regra_w
            from regra_ocorrencia_turno 
            where nr_sequencia = nr_seq_regra_p;
        else
            nr_seq_conversao_w := converte_rtf_html2( 'select ds_texto from regra_ocorrencia_turno where nr_sequencia = :nr_sequencia_p', nr_seq_regra_p, 'Tasy', nr_seq_conversao_w);

            select	ds_texto
            into STRICT	ds_texto_regra_w
            from	tasy_conversao_rtf
            where	nr_sequencia = nr_seq_conversao_w;
        end if;
    else
        nr_seq_conversao_w := converte_rtf_string( 'select ds_texto from regra_ocorrencia_turno where nr_sequencia = :nr_sequencia_p', nr_seq_regra_p, 'Tasy', nr_seq_conversao_w);

        select	ds_texto
        into STRICT	ds_texto_regra_w
        from	tasy_conversao_rtf
        where	nr_sequencia = nr_seq_conversao_w;

    end if;
	
	nr_pos_atend_w := position(';' in ds_lista_atend_w);
	
	i := 1;
	
	select	substr(ds_lista_atend_w,i,nr_pos_atend_w-1)
	into STRICT	nr_atend_atual_w
	;
	
	select	max(cd_pessoa_fisica)
	into STRICT	cd_profissional_w
	from	usuario
	where	nm_usuario = nm_usuario_p;
		
	while((trim(both nr_atend_atual_w) IS NOT NULL AND (trim(both nr_atend_atual_w))::text <> '')) loop
		begin
		select	max(substr(obter_nome_pf(cd_pessoa_fisica),1,255)),
			max(cd_pessoa_fisica)
		into STRICT	nm_paciente_w,
			cd_pessoa_fisica_w
		from	atendimento_paciente
		where	nr_atendimento = nr_atend_atual_w;
		
		--if	(Trim(ds_texto_w) is null) then
			ds_texto_w := obter_desc_expressao(283863) || ': ' || nr_atend_atual_w || ' - ' || nm_paciente_w || chr(10) || ds_texto_regra_w;
		--else

		--	ds_texto_w := chr(10) || chr(10) || 'Atendimento: ' || nr_atend_atual_w || ' - ' || nm_paciente_w || chr(10) || ds_texto_regra_w;

		--end if;
		
		ds_texto_saida_w := Substituir_Macros_Tasy(ds_texto_w, cd_pessoa_fisica_w, cd_profissional_w, nr_atend_atual_w, ds_texto_saida_w);
	
		--ds_texto_atend_w := ds_texto_atend_w || ds_texto_saida_w;
		
		insere(ds_texto_saida_w);
		
		i := i + nr_pos_atend_w;
		
		nr_pos_atend_w := position(';' in substr(ds_lista_atend_w,i,length(ds_lista_atend_w)));
		
		select	substr(ds_lista_atend_w,i,nr_pos_atend_w-1)
		into STRICT	nr_atend_atual_w
		;
		
		end;
	end loop;
			
	
	open C10;
	loop
	fetch C10 into
		ds_auxiliar_w;
	EXIT WHEN NOT FOUND; /* apply on C10 */
		begin
		ds_campo_clob_w := ds_campo_clob_w || ds_auxiliar_w;
		ds_campo_clob_w := ds_campo_clob_w || chr(10);
		end;
	end loop;
	close C10;
	
	ds_conteudo_1_w := substr(ds_campo_clob_w,32764,1);
	ds_conteudo_2_w := substr(ds_campo_clob_w,32764,32765);
	
	
		
	
	--ds_texto_campo_w := ds_conteudo_1_w||ds_conteudo_2_w;

	
	/*select	ocorrencia_seq.nextval
	into	nr_sequencia_w
	from	dual;
	
	insert into ocorrencia (	nr_ocorrencia,
					dt_ocorrencia,
					ie_tipo_ocorrencia,
					dt_atualizacao,
					nm_usuario,
					cd_estabelecimento,
					ie_situacao,
					cd_pessoa_fisica,
					cd_setor_atendimento)
			values(		nr_sequencia_w,
					sysdate,
					ie_tipo_ocorrencia_p,
					sysdate,
					nm_usuario_p,
					obter_estabelecimento_ativo,
					'A',
					cd_pessoa_fisica_p,
					cd_setor_atendimento_p);
					
	commit;*/
	
	
	
	ds_sql_w	:= ' update ocorrencia set ds_ocorrencia = :ds_texto  where nr_ocorrencia = '||nr_seq_ocorrencia_p;
	C001 := DBMS_SQL.OPEN_CURSOR;
	DBMS_SQL.PARSE(C001, ds_sql_w, dbms_sql.Native);
	DBMS_SQL.BIND_VARIABLE(C001, 'DS_TEXTO', ds_conteudo_1_w || ds_conteudo_2_w);
	retorno_w := DBMS_SQL.EXECUTE(c001);
	DBMS_SQL.CLOSE_CURSOR(C001);
	
	
	/*update	ocorrencia
	set	ds_ocorrencia = ds_conteudo_1_w||ds_conteudo_2_w
	where	nr_ocorrencia = nr_seq_ocorrencia_p;

	commit;*/
	
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_texto_regra_ocorrencia ( nr_seq_regra_p bigint, ds_lista_atend_p text, ie_tipo_ocorrencia_p text, cd_pessoa_fisica_p text, cd_setor_atendimento_p bigint, nr_seq_ocorrencia_p bigint, nm_usuario_p text, ie_html5_p text default 'N') FROM PUBLIC;

