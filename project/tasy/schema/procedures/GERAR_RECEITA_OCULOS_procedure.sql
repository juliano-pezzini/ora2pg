-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_receita_oculos ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
 
nr_sequencia_w		bigint;
ds_receita_w		varchar(20000);
nr_atendimento_w	bigint;
nm_pessoa_fisica_w	varchar(60);
cd_pessoa_fisica_w	varchar(10);
cd_perfil_ativo_w	bigint;
cd_estabelecimento_w	smallint;
ds_fonte_w		varchar(100);
nm_medico_w		varchar(60);
cd_medico_w		varchar(10);
ie_dinamica_w		varchar(1);
ie_estatica_w		varchar(1);
ie_receita_w		varchar(1);
ie_adicao_w		varchar(1);
vl_de_rd_od_w		varchar(10);
vl_dc_rd_od_w		varchar(10);
vl_eixo_rd_od_w		varchar(10);
ds_visao_rd_od_w	varchar(40);
vl_de_rd_oe_w		varchar(10);
vl_dc_rd_oe_w		varchar(10);
vl_eixo_rd_oe_w		varchar(10);
ds_visao_rd_oe_w	varchar(40);
vl_de_re_od_w		varchar(10);
vl_dc_re_od_w		varchar(10);
vl_eixo_re_od_w		varchar(10);
ds_visao_re_od_w	varchar(40);
vl_de_re_oe_w		varchar(10);
vl_dc_re_oe_w		varchar(10);
vl_eixo_re_oe_w		varchar(10);
ds_visao_re_oe_w	varchar(40);
vl_de_receita_od_w	varchar(10);
vl_dc_receita_od_w	varchar(10);
vl_eixo_receita_od_w	varchar(10);
ds_visao_receita_od_w	varchar(40);
vl_de_receita_oe_w	varchar(10);
vl_dc_receita_oe_w	varchar(10);
vl_eixo_receita_oe_w	varchar(10);
ds_visao_receita_oe_w	varchar(40);
vl_adicao_od_w		varchar(10);
vl_adicao_oe_w		varchar(10);

vl_soma_de_rd_od_w	varchar(10);
vl_soma_de_rd_oe_w	varchar(10);
vl_soma_dc_rd_od_w	varchar(10);
vl_soma_dc_rd_oe_w	varchar(10);

ds_esferica_w		varchar(60) := Lpad('Esférica',60,' ');
vl_esf_od_w		varchar(20);
vl_esf_oe_w		varchar(20);
ds_cilindrica_w		varchar(20) := Lpad('Cilíndrica',20,' ');
vl_cil_od_w		varchar(20);
vl_cil_oe_w		varchar(20);
ds_eixo_w		varchar(20);
vl_eixo_od_w		varchar(20);
vl_eixo_oe_w		varchar(20);
ds_dnp_w		varchar(20) := Lpad('D.N.P.',20,' ');
vl_dnp_w		varchar(20) := Lpad('Medir',20,' ');
ds_olho_direito_w	varchar(40) := Rpad('Olho Direito',40,' ');
ds_olho_esquerdo_w	varchar(40) := Rpad('Olho Esquerdo',36,' ');

vl_soma_eixo_oe_w	varchar(20);
vl_soma_eixo_od_w	varchar(20);

ds_tabela_w		varchar(10000);
ds_grauc_od_w		varchar(30);
ds_grauc_oe_w		varchar(30);	
ds_graue_od_w		varchar(30);	
ds_graue_oe_w		varchar(30);	
ds_eixo_od_w		varchar(30);
ds_eixo_oe_w		varchar(30);
ie_gerar_observacao_padrao_w	varchar(1);
ds_obs_receita_w	varchar(255);


BEGIN 
 
ds_eixo_w := Lpad(substr(obter_desc_expressao(289084),1,20),20,' ');
 
	cd_perfil_ativo_w := obter_perfil_ativo;
	ds_fonte_w := Obter_Param_Usuario(281, 5, cd_perfil_ativo_w, nm_usuario_p, cd_estabelecimento_w, ds_fonte_w);
 
select	substr(obter_pessoa_atendimento(nr_atendimento,'N'),1,60), 
	obter_pessoa_atendimento(nr_atendimento,'C'), 
	cd_profissional, 
	substr(obter_nome_medico(cd_profissional,'P'),1,60), 
	nr_atendimento, 
	ie_dinamica, 
	ie_estatica, 
	ie_receita, 
	ie_adicao, 
	CASE WHEN obter_se_negativo(vl_de_rd_od)='S' THEN  campo_mascara_virgula(vl_de_rd_od)  ELSE '+'||campo_mascara_virgula(vl_de_rd_od) END , 
	'-'||campo_mascara_virgula(abs(vl_dc_rd_od)), 
	abs(vl_eixo_rd_od), 
	ds_visao_rd_od, 
	CASE WHEN obter_se_negativo(vl_de_rd_oe)='S' THEN  campo_mascara_virgula(vl_de_rd_oe)  ELSE '+'||campo_mascara_virgula(vl_de_rd_oe) END , 
	'-'||campo_mascara_virgula(abs(vl_dc_rd_oe)), 
	abs(vl_eixo_rd_oe), 
	ds_visao_rd_oe, 
	CASE WHEN obter_se_negativo(vl_de_re_od)='S' THEN  campo_mascara_virgula(vl_de_re_od)  ELSE '+'||campo_mascara_virgula(vl_de_re_od) END , 
	'-'||campo_mascara_virgula(abs(vl_dc_re_od)), 
	abs(vl_eixo_re_od), 
	ds_visao_re_od, 
	CASE WHEN obter_se_negativo(vl_de_re_oe)='S' THEN  campo_mascara_virgula(vl_de_re_oe)  ELSE '+'||campo_mascara_virgula(vl_de_re_oe) END , 
	'-'||campo_mascara_virgula(abs(vl_dc_re_oe)), 
	abs(vl_eixo_re_oe), 
	ds_visao_re_oe, 
	CASE WHEN obter_se_negativo(vl_de_receita_od)='S' THEN  campo_mascara_virgula(vl_de_receita_od)  ELSE '+'||campo_mascara_virgula(vl_de_receita_od) END , 
	'-'||campo_mascara_virgula(abs(vl_dc_receita_od)), 
	abs(vl_eixo_receita_od), 
	ds_visao_receita_od, 
	CASE WHEN obter_se_negativo(vl_de_receita_oe)='S' THEN  campo_mascara_virgula(vl_de_receita_oe)  ELSE '+'||campo_mascara_virgula(vl_de_receita_oe) END , 
	'-'||campo_mascara_virgula(abs(vl_dc_receita_oe)), 
	abs(vl_eixo_receita_oe), 
	ds_visao_receita_oe, 
	'+'||campo_mascara_virgula(abs(vl_adicao_od)), 
	'+'||campo_mascara_virgula(abs(vl_adicao_oe)), 
	CASE WHEN obter_se_negativo(coalesce(vl_adicao_od,0) + CASE WHEN ie_base_adicao='O' THEN coalesce(vl_de_rd_od,0)  ELSE coalesce(vl_de_re_od,0) END )='S' THEN campo_mascara_virgula(coalesce(vl_adicao_od,0) + CASE WHEN ie_base_adicao='O' THEN coalesce(vl_de_rd_od,0)  ELSE coalesce(vl_de_re_od,0) END )  ELSE '+'||campo_mascara_virgula(coalesce(vl_adicao_od,0) + CASE WHEN ie_base_adicao='O' THEN coalesce(vl_de_rd_od,0)  ELSE coalesce(vl_de_re_od,0) END ) END , 
	CASE WHEN obter_se_negativo(coalesce(vl_adicao_oe,0) + CASE WHEN ie_base_adicao='O' THEN coalesce(vl_de_rd_oe,0)  ELSE coalesce(vl_de_re_oe,0) END )='S' THEN campo_mascara_virgula(coalesce(vl_adicao_oe,0) + CASE WHEN ie_base_adicao='O' THEN coalesce(vl_de_rd_oe,0)  ELSE coalesce(vl_de_re_oe,0) END )  ELSE '+'||campo_mascara_virgula(coalesce(vl_adicao_oe,0) + CASE WHEN ie_base_adicao='O' THEN coalesce(vl_de_rd_oe,0)  ELSE coalesce(vl_de_re_oe,0) END ) END , 
	'-'||campo_mascara_virgula(abs(CASE WHEN ie_base_adicao='O' THEN vl_dc_rd_od  ELSE vl_dc_re_od END )), 
	'-'||campo_mascara_virgula(abs(CASE WHEN ie_base_adicao='O' THEN vl_dc_rd_oe  ELSE vl_dc_re_oe END )), 
	abs(CASE WHEN ie_base_adicao='O' THEN vl_eixo_rd_od  ELSE vl_eixo_re_od END ), 
	abs(CASE WHEN ie_base_adicao='O' THEN vl_eixo_rd_oe  ELSE vl_eixo_re_oe END ), 
	ds_obs_receita 
into STRICT	nm_pessoa_fisica_w, 
	cd_pessoa_fisica_w, 
	cd_medico_w, 
	nm_medico_w, 
	nr_atendimento_w, 
	ie_dinamica_w, 
	ie_estatica_w, 
	ie_receita_w, 
	ie_adicao_w, 
	vl_de_rd_od_w, 
	vl_dc_rd_od_w, 
	vl_eixo_rd_od_w, 
	ds_visao_rd_od_w, 
	vl_de_rd_oe_w, 
	vl_dc_rd_oe_w, 
	vl_eixo_rd_oe_w, 
	ds_visao_rd_oe_w, 
	vl_de_re_od_w, 
	vl_dc_re_od_w, 
	vl_eixo_re_od_w, 
	ds_visao_re_od_w, 
	vl_de_re_oe_w, 
	vl_dc_re_oe_w, 
	vl_eixo_re_oe_w, 
	ds_visao_re_oe_w, 
	vl_de_receita_od_w, 
	vl_dc_receita_od_w, 
	vl_eixo_receita_od_w, 
	ds_visao_receita_od_w, 
	vl_de_receita_oe_w, 
	vl_dc_receita_oe_w, 
	vl_eixo_receita_oe_w, 
	ds_visao_receita_oe_w, 
	vl_adicao_od_w, 
	vl_adicao_oe_w, 
	vl_soma_de_rd_od_w, 
	vl_soma_de_rd_oe_w, 
	vl_soma_dc_rd_od_w, 
	vl_soma_dc_rd_oe_w, 
	vl_soma_eixo_od_w, 
	vl_soma_eixo_oe_w, 
	ds_obs_receita_w 
from	oft_consulta_medica 
where	nr_sequencia	= nr_sequencia_p;
 
ie_gerar_observacao_padrao_w	:= coalesce(Obter_Valor_Param_Usuario(281, 456, Obter_perfil_Ativo, nm_usuario_p, 0),'S');
 
ds_receita_w	:= '{\rtf1\ansi\ansicpg1252\deff0\deflang1046{\fonttbl{\f0\fswiss\fprq2\fcharset0 ' || ds_fonte_w || ';}}{\*\generator Msftedit 
 
5.41.21.2507;}\viewkind4\uc1\pard\q' || 'j' || '\cf1\lang1046\f0\fs20';
--ds_receita_w	:= ds_receita_w || Lpad('RECEITA DE ÓCULOS',80,' ');  
ds_receita_w	:= ds_receita_w || Obter_richtext_base('RECEITA DE ÓCULOS', 'C', ds_fonte_w, '10');
 
if	((ie_receita_w = 'N') and (ie_estatica_w = 'N') and (ie_dinamica_w = 'N') and (ie_adicao_w = 'S')) then 
	ds_receita_w	:= ds_receita_w || '\par\par PERTO';
else 
	ds_receita_w 	:= ds_receita_w || '\par\par LONGE';
end if;
 
if (ie_receita_w = 'S') then 
	begin 
	ds_graue_od_w	:= vl_de_receita_od_w;
	ds_grauc_od_w	:= vl_dc_receita_od_w;
	ds_eixo_od_w	:= vl_eixo_receita_od_w;
	ds_graue_oe_w	:= vl_de_receita_oe_w;
	ds_grauc_oe_w	:= vl_dc_receita_oe_w;
	ds_eixo_oe_w	:= vl_eixo_receita_oe_w;
	end;
elsif (ie_estatica_w = 'S') then 
	begin 
	ds_graue_od_w	:= vl_de_re_od_w;
	ds_grauc_od_w	:= vl_dc_re_od_w;
	ds_eixo_od_w	:= vl_eixo_re_od_w;
	ds_graue_oe_w	:= vl_de_re_oe_w;
	ds_grauc_oe_w	:= vl_dc_re_oe_w;
	ds_eixo_oe_w	:= vl_eixo_re_oe_w;
	end;
elsif (ie_dinamica_w = 'S') then 
	begin 
	ds_graue_od_w	:= vl_de_rd_od_w;
	ds_grauc_od_w	:= vl_dc_rd_od_w;
	ds_eixo_od_w	:= vl_eixo_rd_od_w;
	ds_graue_oe_w	:= vl_de_rd_oe_w;
	ds_grauc_oe_w	:= vl_dc_rd_oe_w;
	ds_eixo_oe_w	:= vl_eixo_rd_oe_w;
	end;
elsif (ie_dinamica_w = 'N') then 
	begin 
	ds_graue_od_w	:= vl_soma_de_rd_od_w;
	ds_grauc_od_w	:= vl_soma_dc_rd_od_w;
	ds_eixo_od_w	:= vl_soma_eixo_od_w;
	ds_graue_oe_w	:= vl_soma_de_rd_oe_w;
	ds_grauc_oe_w	:= vl_soma_dc_rd_oe_w;
	ds_eixo_oe_w	:= vl_soma_eixo_oe_w;
	end;
end if;
 
/* Verifica se o campo não foi preenchido com valor numérico válido */
 
if	((ds_graue_od_w = '-') or (ds_graue_od_w = '+')) then 
	ds_graue_od_w	:= ' ';
end if;
if	((ds_grauc_od_w = '-') or (ds_grauc_od_w = '+')) then 
	ds_grauc_od_w	:= ' ';
end if;
if	((ds_graue_oe_w = '-') or (ds_graue_oe_w = '+')) then 
	ds_graue_oe_w	:= ' ';
end if;
if	((ds_grauc_oe_w = '-') or (ds_grauc_oe_w = '+')) then 
	ds_grauc_oe_w	:= ' ';
end if;
 
	 
ds_tabela_w	:= '\par\trowd\trgaph70\trleft-108\trbrdrl\brdrs\brdrw10 \trbrdrt\brdrs\brdrw10 \trbrdrr\brdrs\brdrw10 \trbrdrb\brdrs\brdrw10 
 
\trpaddl70\trpaddr70\trpaddfl3\trpaddfr3'|| 
          '\clbrdrl\brdrw10\brdrs\clbrdrt\brdrw10\brdrs\clbrdrr\brdrw10\brdrs\clbrdrb\brdrw10\brdrs 
 
\cellx1636\clbrdrl\brdrw10\brdrs\clbrdrt\brdrw10\brdrs\clbrdrr\brdrw10\brdrs\clbrdrb\brdrw10\brdrs 
 
\cellx3054\clbrdrl\brdrw10\brdrs\clbrdrt\brdrw10\brdrs\clbrdrr\brdrw10\brdrs\clbrdrb\brdrw10\brdrs 
 
\cellx4472\clbrdrl\brdrw10\brdrs\clbrdrt\brdrw10\brdrs\clbrdrr\brdrw10\brdrs\clbrdrb\brdrw10\brdrs 
 
\cellx5890\clbrdrl\brdrw10\brdrs\clbrdrt\brdrw10\brdrs\clbrdrr\brdrw10\brdrs\clbrdrb\brdrw10\brdrs \cellx7308\pard\intbl\cell\b Esférica\b0\cell\b 
 
Cilíndrica\b0\cell\b Eixo\b0\cell\pard\intbl\ri120\b D.N.P.\b0\cell\row\trowd\trgaph70\trleft-108\trbrdrl\brdrs\brdrw10 \trbrdrt\brdrs\brdrw10 
 
\trbrdrr\brdrs\brdrw10 \trbrdrb\brdrs\brdrw10 \trpaddl70\trpaddr70\trpaddfl3\trpaddfr3'|| 
          '\clbrdrl\brdrw10\brdrs\clbrdrt\brdrw10\brdrs\clbrdrr\brdrw10\brdrs\clbrdrb\brdrw10\brdrs 
 
\cellx1636\clbrdrl\brdrw10\brdrs\clbrdrt\brdrw10\brdrs\clbrdrr\brdrw10\brdrs\clbrdrb\brdrw10\brdrs 
 
\cellx3054\clbrdrl\brdrw10\brdrs\clbrdrt\brdrw10\brdrs\clbrdrr\brdrw10\brdrs\clbrdrb\brdrw10\brdrs 
 
\cellx4472\clbrdrl\brdrw10\brdrs\clbrdrt\brdrw10\brdrs\clbrdrr\brdrw10\brdrs\clbrdrb\brdrw10\brdrs 
 
\cellx5890\clbrdrl\brdrw10\brdrs\clbrdrt\brdrw10\brdrs\clbrdrr\brdrw10\brdrs\clbrdrb\brdrw10\brdrs \cellx7308\pard\intbl\b Olho direito\b0\cell 
 
'||ds_graue_od_w||'\cell '||ds_grauc_od_w||'\cell '||ds_eixo_od_w||'\cell Medir\cell\row\trowd\trgaph70\trleft-108\trbrdrl\brdrs\brdrw10 
 
\trbrdrt\brdrs\brdrw10 \trbrdrr\brdrs\brdrw10 \trbrdrb\brdrs\brdrw10 \trpaddl70\trpaddr70\trpaddfl3\trpaddfr3'|| 
          '\clbrdrl\brdrw10\brdrs\clbrdrt\brdrw10\brdrs\clbrdrr\brdrw10\brdrs\clbrdrb\brdrw10\brdrs 
 
\cellx1636\clbrdrl\brdrw10\brdrs\clbrdrt\brdrw10\brdrs\clbrdrr\brdrw10\brdrs\clbrdrb\brdrw10\brdrs 
 
\cellx3054\clbrdrl\brdrw10\brdrs\clbrdrt\brdrw10\brdrs\clbrdrr\brdrw10\brdrs\clbrdrb\brdrw10\brdrs 
 
\cellx4472\clbrdrl\brdrw10\brdrs\clbrdrt\brdrw10\brdrs\clbrdrr\brdrw10\brdrs\clbrdrb\brdrw10\brdrs 
 
\cellx5890\clbrdrl\brdrw10\brdrs\clbrdrt\brdrw10\brdrs\clbrdrr\brdrw10\brdrs\clbrdrb\brdrw10\brdrs \cellx7308\pard\intbl\b Olho esquerdo\b0\cell 
 
'||ds_graue_oe_w||'\cell '||ds_grauc_oe_w||'\cell '||ds_eixo_oe_w||'\cell Medir\cell\row\pard';
 
ds_receita_w	:= ds_receita_w || ds_tabela_w;
 
 
ds_receita_w	:= ds_receita_w;
 
if	((ie_adicao_w = 'S') and not((ie_receita_w = 'N') and (ie_estatica_w = 'N') and (ie_dinamica_w = 'N'))) then 
	begin 
	ds_receita_w	:= ds_receita_w || '\par ADIÇÃO';
	ds_tabela_w	:= '\par 
	 
\trowd\trgaph70\trleft-108\trbrdrl\brdrs\brdrw10 \trbrdrt\brdrs\brdrw10 \trbrdrr\brdrs\brdrw10 \trbrdrb\brdrs\brdrw10 
 
\trpaddl70\trpaddr70\trpaddfl3\trpaddfr3\clbrdrl\brdrw15\brdrs\clbrdrt\brdrw15\brdrs\clbrdrr\brdrw15\brdrs\clbrdrb\brdrw15\brdrs 
 
\cellx1736\clbrdrl\brdrw15\brdrs\clbrdrt\brdrw15\brdrs\clbrdrr\brdrw15\brdrs\clbrdrb\brdrw15\brdrs \cellx3054\pard\intbl\b\f1\fs22 Olho direito\b0\cell 
 
'||lpad(vl_adicao_od_w,14,' ')||'\cell\row 
 
\trowd\trgaph70\trleft-108\trbrdrl\brdrs\brdrw10 \trbrdrt\brdrs\brdrw10 \trbrdrr\brdrs\brdrw10 \trbrdrb\brdrs\brdrw10 
 
\trpaddl70\trpaddr70\trpaddfl3\trpaddfr3\clbrdrl\brdrw15\brdrs\clbrdrt\brdrw15\brdrs\clbrdrr\brdrw15\brdrs\clbrdrb\brdrw15\brdrs 
 
\cellx1736\clbrdrl\brdrw15\brdrs\clbrdrt\brdrw15\brdrs\clbrdrr\brdrw15\brdrs\clbrdrb\brdrw15\brdrs \cellx3054\pard\intbl\b\f1\fs22 Olho esquerdo\b0\cell 
 
'||lpad(vl_adicao_oe_w,14,' ')||'\cell\row\pard\f2\fs20';
 
	ds_receita_w	:= ds_receita_w || ds_tabela_w;
	end;
 
end if;
 
if (ds_obs_receita_w IS NOT NULL AND ds_obs_receita_w::text <> '') then 
	ds_receita_w	:= ds_receita_w || '\fs20\par ' || Obter_richtext_base(obter_desc_expressao(753406) || ' ', 'J', ds_fonte_w, '10') || 
	Obter_richtext_base(ds_obs_receita_w , 'J', ds_fonte_w, '10')	|| ' ';
end if;
 
ds_tabela_w	:= '\par\par Favor conferir seus óculos antes de usá-los. '|| 
		  'Ao usar óculos pela primeira vez ou nas alterações de lentes é normal haver certo desconforto com náuseas, tonturas leves, percepção de curvas e algumas dificuldades de orientação quanto ao solo. '|| 
		  'Trata-se de um período de adaptação que é passageiro. '|| 
		  'Se esses sintomas persistirem por duas ou três semanas, volte a procurar seu médico. '|| 
		  'Não nos responsabilizamos por conferências de óculos feitas por outros profissionais.';
 
ds_tabela_w	:= Obter_richtext_base(ds_tabela_w, 'J', ds_fonte_w, '10');
 
if (ie_gerar_observacao_padrao_w	= 'S') then 
	  
	ds_receita_w	:= ds_receita_w || ds_tabela_w;
 
end if;
				 
ds_receita_w	:= ds_receita_w || '}';
 
select 	nextval('med_receita_seq') 
into STRICT	nr_sequencia_w
;
 
insert into med_receita( 
	nr_sequencia, 
	dt_atualizacao, 
	ds_receita, 
	nm_usuario, 
	dt_receita, 
	nr_atendimento_hosp, 
	cd_pessoa_fisica, 
	cd_medico, 
	ie_tipo_receita, 
	ie_situacao) 
values (	nr_sequencia_w, 
	clock_timestamp(), 
	ds_receita_w, 
	nm_usuario_p, 
	clock_timestamp(), 
	nr_atendimento_w, 
	cd_pessoa_fisica_w, 
	cd_medico_w, 
	'C', 
	'A');
	 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_receita_oculos ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

