-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE envia_alerta_mat_execucao ( cd_material_p bigint, nr_atendimento_p bigint, nr_interno_conta_p bigint, nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, dt_atendimento_p timestamp, qt_material_p bigint, nr_seq_lote_fornec_p bigint, nr_serie_material_p text, nr_prescricao_p bigint, nr_seq_atepacu_p bigint ) AS $body$
DECLARE


cd_grupo_material_w		bigint;
cd_subgrupo_material_w 		bigint;
cd_classe_material_w		bigint;
ds_grupo_material_w		varchar(255);
ds_subgrupo_material_w 		varchar(255);
ds_classe_material_w		varchar(255);
ds_comunic_solic_w		varchar(2000);
nr_seq_classif_w			bigint;
cd_setor_dest_w			bigint;
nm_usuario_dest_w			varchar(255);
cd_grupo_mat_w			bigint;
cd_subgrupo_mat_w	  	bigint;
cd_classe_mat_w			bigint;
cd_mat_w			bigint;
nr_regras_w			bigint;
cd_setor_w			varchar(100);
dt_atendimento_w			varchar(50);
nm_pessoa_fisica_w		varchar(100);
qt_material_w			double precision;
ds_fornecedor_w			varchar(80);
cd_perfil_w			integer;
ie_ci_lida_w			varchar(1);
nr_seq_comunic_w		bigint;

ds_validade_lote_w		timestamp;
ds_acao_w			varchar(50);
cd_convenio_w			integer;
ds_convenio_w			varchar(255);
nr_prescricao_w			material_atend_paciente.nr_prescricao%type;
dt_nascimento_w			timestamp;
ds_localizacao_pac_w		varchar(255);

c01 CURSOR FOR
	SELECT	cd_grupo_material,
		cd_subgrupo_material,
		cd_classe_material,
		cd_material,
		cd_setor_atendimento,
		cd_perfil,
		ds_usuario_destino,
		coalesce(ie_ci_lida,'N')
	from 	regra_aviso_exec_mat
	where	coalesce(cd_grupo_material, cd_grupo_material_w)		= cd_grupo_material_w
	and	coalesce(cd_subgrupo_material, cd_subgrupo_material_w)	= cd_subgrupo_material_w
	and	coalesce(cd_classe_material, cd_classe_material_w)		= cd_classe_material_w
	and	coalesce(cd_material, cd_material_p)				= cd_material_p
	and	coalesce(cd_estabelecimento,cd_estabelecimento_p) 		= cd_estabelecimento_p
	and	((coalesce(ie_execucao_material,'N') = 'S') or ((coalesce(ie_execucao_material,'N') = 'T') and (qt_material_p < 0)))
	and 	coalesce(cd_funcao, coalesce(obter_funcao_ativa,0)) = coalesce(obter_funcao_ativa,0)
	order by
		coalesce(cd_grupo_material, 0),
		coalesce(cd_subgrupo_material, 0),
		coalesce(cd_classe_material, 0),
		coalesce(cd_material, 0),
		coalesce(cd_funcao,0);


BEGIN



if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') and (cd_material_p > 0) then
	begin

	select	max(cd_grupo_material),
		max(cd_subgrupo_material),
		max(cd_classe_material),
		substr(max(ds_grupo_material),1,255),
		substr(max(ds_subgrupo_material),1,255),
		substr(max(ds_classe_material),1,255)
	into STRICT	cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w,
		ds_grupo_material_w,
		ds_subgrupo_material_w,
		ds_classe_material_w
	from	estrutura_material_v
	where 	cd_material = cd_material_p;

			/*Material: */
							/*Descricao: */

	select	max(wheb_mensagem_pck.get_Texto(313057) || cd_material || chr(13) || wheb_mensagem_pck.get_Texto(313058) || substr(obter_desc_material(cd_material),1,120))
	into STRICT	ds_comunic_solic_w
	from 	material
	where 	cd_material	=	cd_material_p;

	select	max(obter_classif_comunic('F'))
	into STRICT	nr_seq_classif_w
	;
	
	select  coalesce(max(obter_convenio_atendimento(nr_atendimento_p)),0)
	into STRICT	cd_convenio_w
	;
	
	ds_convenio_w:= wheb_mensagem_pck.get_Texto(313059); /*'Nao informado';*/
	if (cd_convenio_w <> 0) then
		select 	max(ds_convenio)
		into STRICT	ds_convenio_w
		from 	convenio
		where 	cd_convenio = cd_convenio_w;
	end if;
	
	select 	to_date(substr(obter_dados_lote_fornec(nr_seq_lote_fornec_p,'V'),1,100),'DD/MM/YYYY')
	into STRICT	ds_validade_lote_w
	;	
		
	ds_acao_w:= wheb_mensagem_pck.get_Texto(313060); /*'Lancamento/Execucao';*/
	if (qt_material_p < 0) then
		ds_acao_w:= wheb_mensagem_pck.get_Texto(313061); /*'Devolucao';*/
	end if;

    select substr(Obter_Setor_AtePacu(nr_seq_atepacu_p,1),1,100)
	into STRICT	ds_localizacao_pac_w
	;

	begin
	select	max(substr(obter_dados_atendimento(a.nr_atendimento, 'NP'),1,100)),
			max(to_date(obter_dados_pf(a.cd_pessoa_fisica,'DN'),'dd/mm/yyyy'))
	into STRICT	nm_pessoa_fisica_w,
			dt_nascimento_w
	from	atendimento_paciente a
	where	a.nr_atendimento = nr_atendimento_p;
	exception when no_data_found then
		nm_pessoa_fisica_w	:= '';
		dt_nascimento_w := null; 		
	end;
		
	ds_comunic_solic_w	:=	substr(wheb_mensagem_pck.get_texto(313063,
					'CD_MATERIAL_P='|| CD_MATERIAL_P ||
					';NR_ATENDIMENTO_P='|| NR_ATENDIMENTO_P ||
					';NR_PRESCRICAO_P='|| NR_PRESCRICAO_P ||
					';DS_COMUNIC_SOLIC_W='|| DS_COMUNIC_SOLIC_W ||
					';DT_ATENDIMENTO_P='|| DT_ATENDIMENTO_P ||
					';NM_PESSOA_FISICA_W='|| NM_PESSOA_FISICA_W ||
					';DT_NASCIMENTO_W='|| DT_NASCIMENTO_W ||
					';DS_LOCALIZACAO_PAC_W='|| DS_LOCALIZACAO_PAC_W ||
					';QT_MATERIAL_P='|| QT_MATERIAL_P ||
					';NR_SERIE_MATERIAL_P='|| NR_SERIE_MATERIAL_P ||
					';NR_SEQ_LOTE_FORNEC_P='|| NR_SEQ_LOTE_FORNEC_P ||
					';DS_VALIDADE_LOTE_W='|| DS_VALIDADE_LOTE_W ||
					';DS_ACAO_W='|| DS_ACAO_W ||
					';DS_GRUPO_MATERIAL_W='|| DS_GRUPO_MATERIAL_W ||
					';DS_GRUPO_MATERIAL_W='|| DS_GRUPO_MATERIAL_W ||
					';DS_CLASSE_MATERIAL_W='|| DS_CLASSE_MATERIAL_W ||
					';DS_CONVENIO_W='|| DS_CONVENIO_W ||
					';CD_FUNCAO_W='|| obter_funcao_ativa ||
					';DS_FUNCAO_W='|| substr(obter_nome_funcao(obter_funcao_ativa),1,200)),1,500);
					/*Codigo: #@CD_MATERIAL_P#@
					Execucao de material: 
					Atendimento: #@NR_ATENDIMENTO_P#@
					Prescricao: #@NR_PRESCRICAO_P#@
					#@DS_COMUNIC_SOLIC_W#@
					Data lancamento: #@DT_ATENDIMENTO_P#@
					Paciente: #@NM_PESSOA_FISICA_W#@
					Nascimento: #@DT_NASCIMENTO_W#@
					Setor paciente: #@DS_LOCALIZACAO_PAC_W#@
					Quantidade: #@QT_MATERIAL_P#@
					Serie: #@NR_SERIE_MATERIAL_P#@
					Lote Fornec: #@NR_SEQ_LOTE_FORNEC_P#@
					Validade Lote: #@DS_VALIDADE_LOTE_W#@
					Acao: #@DS_ACAO_W#@
					Grupo: #@DS_GRUPO_MATERIAL_W#@
					Subgrupo: #@DS_SUBGRUPO_MATERIAL_W#@
					Classe: #@DS_CLASSE_MATERIAL_W#@
					Convenio: #@DS_CONVENIO_W#@
					Fucao: #@CD_FUNCAO_W#@ - #@DS_FUNCAO_W#@.*/
					
	select	count(*)
	into STRICT	nr_regras_w
	from 	regra_aviso_exec_mat;

	if (nr_regras_w > 0) then
		open	c01;
		loop
		fetch	c01 into
			cd_grupo_mat_w,
			cd_subgrupo_mat_w,
			cd_classe_mat_w,
			cd_mat_w,
			cd_setor_dest_w,
			cd_perfil_w,
			nm_usuario_dest_w,
			ie_ci_lida_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
		end loop;
		close 	c01;	
	
		if (coalesce(cd_setor_dest_w::text, '') = '') then
			cd_setor_w:= null;
		else	
			cd_setor_w:= to_char(cd_setor_dest_w) || ',';
		end if;	
	
		if	not ((coalesce(cd_setor_w::text, '') = '') and (coalesce(nm_usuario_dest_w::text, '') = '') and (coalesce(cd_perfil_w::text, '') = '')) then
			begin

			select	nextval('comunic_interna_seq')
			into STRICT	nr_seq_comunic_w
			;

			insert	into comunic_interna(
					dt_comunicado,	
					ds_titulo,	
					ds_comunicado,	
					nm_usuario,
					dt_atualizacao,	
					ie_geral,			
					nm_usuario_destino,	
					nr_sequencia,
					ie_gerencial,
					nr_seq_classif,				
					ds_setor_adicional,
					cd_estab_destino,
					dt_liberacao,
					ds_perfil_adicional)
				values (	clock_timestamp(),	
					wheb_mensagem_pck.get_Texto(313066), /*'Execucao de material(Alerta)',*/
					ds_comunic_solic_w,	
					nm_usuario_p,
					clock_timestamp(),	
					'N',				
					nm_usuario_dest_w,		
					nr_seq_comunic_w,
					'N',
					nr_seq_classif_w,
					cd_setor_w,
					cd_estabelecimento_p,			
					clock_timestamp(),
					cd_perfil_w || ',');

			if (ie_ci_lida_w = 'S') then
				insert into comunic_interna_lida(
					nr_sequencia,
					nm_usuario,
					dt_atualizacao) values (
						nr_seq_comunic_w,
						nm_usuario_p,
						clock_timestamp());
			end if;

			end;
		end if;
	end if;
	end;
end if;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE envia_alerta_mat_execucao ( cd_material_p bigint, nr_atendimento_p bigint, nr_interno_conta_p bigint, nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, dt_atendimento_p timestamp, qt_material_p bigint, nr_seq_lote_fornec_p bigint, nr_serie_material_p text, nr_prescricao_p bigint, nr_seq_atepacu_p bigint ) FROM PUBLIC;

