-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_desfazer_diops ( nr_seq_periodo_p bigint, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Desfazer as informacoes geradas para o periodo do DIOPS selecionado
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[ X ]  Objetos do dicionario [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatarios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
-------------------------------------------------------------------------------------------------------------------

Referencias:

ie_opcao_p:	T - Todos os quadros
	G - Gerados pelo sistema
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ie_fluxo_caixa_w			pls_parametros.ie_fluxo_caixa%type;
ie_idade_saldo_w			pls_parametros.ie_idade_saldo%type;
ie_lucro_prejuizo_w			pls_parametros.ie_lucro_prejuizo%type;
ie_solvencia_w				pls_parametros.ie_solvencia%type := '';
ie_balancete_ativo_w		pls_parametros.ie_balancete_ativo%type;
ie_balancete_passivo_w		pls_parametros.ie_balancete_passivo%type;
ie_balancete_receita_w		pls_parametros.ie_balancete_receita%type;
ie_balancete_despesa_w		pls_parametros.ie_balancete_despesa%type;
ie_corresponsabilidade_w	pls_parametros.ie_corresponsabilidade%type;
ie_evento_sinistro_w		pls_parametros.ie_eventos_sinistros%type;
ie_agrup_contratos_w		pls_parametros.ie_agrup_contratos%type;
ie_cobertura_assistencial_w	pls_parametros.ie_cobertura_assistencial%type;
ie_movto_pel_w				pls_parametros.ie_movto_pel%type;
ie_tipo_periodo_diops_w		diops_periodo.ie_tipo_periodo_diops%type;
cd_estabelecimento_w		diops_periodo.cd_estabelecimento%type;
ie_pasta_corresp_w			varchar(1);
dt_periodo_final_w			timestamp;
ie_interc_eventual_w		pls_parametros.ie_interc_eventual%type;
ie_ativo_garantidor_w		pls_parametros.ie_ativo_garantidor%type;
ie_corresp_diops_w		pls_parametros.ie_corresp_diops%type;
ie_fundos_comuns_w		pls_parametros.ie_fundos_comuns%type;
ie_contrap_pecun_w		pls_parametros.ie_contrap_pecun%type;
ie_corresp_cedida_w		pls_parametros.ie_corresp_cedida%type;


BEGIN

cd_estabelecimento_w	:= wheb_usuario_pck.get_cd_estabelecimento;

pls_obter_pls_parametros(cd_estabelecimento_w,'ie_fluxo_caixa','G',ie_fluxo_caixa_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_idade_saldo','G',ie_idade_saldo_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_lucro_prejuizo','G',ie_lucro_prejuizo_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_balancete_ativo','G',ie_balancete_ativo_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_balancete_passivo','G',ie_balancete_passivo_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_balancete_receita','G',ie_balancete_receita_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_balancete_despesa','G',ie_balancete_despesa_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_corresponsabilidade','G',ie_corresponsabilidade_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_eventos_sinistros','G',ie_evento_sinistro_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_agrup_contratos','GI',ie_agrup_contratos_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_cobertura_assistencial','G',ie_cobertura_assistencial_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_movto_pel','G',ie_movto_pel_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_interc_eventual','G',ie_interc_eventual_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_ativo_garantidor','G',ie_ativo_garantidor_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_corresp_diops','G',ie_corresp_diops_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_fundos_comuns','G',ie_fundos_comuns_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_contrap_pecun','G',ie_contrap_pecun_w);
pls_obter_pls_parametros(cd_estabelecimento_w,'ie_corresp_cedida','G',ie_corresp_cedida_w);

ie_pasta_corresp_w	:= obter_valor_param_usuario(1227, 8, Obter_Perfil_Ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);

select	coalesce(dt_periodo_final, ''),
	coalesce(ie_tipo_periodo_diops,'T')
into STRICT	dt_periodo_final_w,
	ie_tipo_periodo_diops_w
from	diops_periodo
where	nr_sequencia	= nr_seq_periodo_p;

if (dt_periodo_final_w <  to_date( '01/01/2016','dd/mm/yyyy')) then
	ie_solvencia_w := 'GI';
end if;

/* Tabelas gerais */

delete	FROM diops_periodo_inconsist
where	nr_seq_periodo	= nr_seq_periodo_p;

delete	from w_diops_identificador
where	nr_seq_periodo	= nr_seq_periodo_p;

/* DIOPS Cadastral */

delete	from w_diops_cad_telfax
where	nr_seq_periodo		= nr_seq_periodo_p;

delete	from w_diops_cad_endereco
where	nr_seq_periodo		= nr_seq_periodo_p;

delete	from w_diops_cad_mun_atuacao
where	nr_seq_periodo		= nr_seq_periodo_p;

delete	from w_diops_cad_responsavel
where	nr_seq_periodo		= nr_seq_periodo_p;

delete	from w_diops_cad_administrador
where	nr_seq_periodo		= nr_seq_periodo_p;

delete	from w_diops_cad_resp_tecnico
where	nr_seq_periodo		= nr_seq_periodo_p;

delete	from w_diops_cad_acion_pf_pj
where	nr_seq_periodo		= nr_seq_periodo_p;

delete	from w_diops_cad_acionquotista
where	nr_seq_periodo		= nr_seq_periodo_p;

delete	from w_diops_cad_coligadas
where	nr_seq_periodo		= nr_seq_periodo_p;

delete	from w_diops_cad_emp_depend
where	nr_seq_periodo		= nr_seq_periodo_p;

delete	from w_diops_cad_identif
where	nr_seq_periodo		= nr_seq_periodo_p;

/* DIOPS financeiro */

delete	from w_diops_fin_balancete
where	nr_seq_periodo		= nr_seq_periodo_p;

if (ie_opcao_p = 'T') or (ie_fluxo_caixa_w in ('G','GI')) then

	delete	from w_diops_fin_fluxo_caixa
	where	nr_seq_periodo		= nr_seq_periodo_p;

	delete	from diops_fin_fluxo_caixa
	where	nr_seq_periodo		= nr_seq_periodo_p;

end if;

if (ie_tipo_periodo_diops_w in ('T','F')) then

	if (ie_opcao_p = 'T') or (ie_ativo_garantidor_w in ('G','GI')) then
		begin
		
		delete	from w_diops_fin_ativo_imob
		where	nr_seq_periodo		= nr_seq_periodo_p;

		delete	from w_diops_fin_ativo_invest
		where	nr_seq_periodo		= nr_seq_periodo_p;

		delete	from w_diops_endereco_ativo
		where	nr_seq_periodo		= nr_seq_periodo_p;
		
		end;
	end if;

	if (ie_opcao_p = 'T') or (ie_idade_saldo_w in ('G','GI')) then

		delete	FROM diops_idadesaldo_contab
		where	nr_seq_periodo		= nr_seq_periodo_p;

		delete	from w_diops_fin_idadesaldo_pas
		where	nr_seq_periodo		= nr_seq_periodo_p;

		delete	from diops_fin_idadesaldo_pas
		where	nr_seq_periodo		= nr_seq_periodo_p;

		delete	from w_diops_fin_idadesaldo_ati
		where	nr_seq_periodo		= nr_seq_periodo_p;

		delete	from diops_fin_idadesaldo_ati
		where	nr_seq_periodo		= nr_seq_periodo_p;

		delete	from diops_idadesaldo_contab
		where	nr_seq_periodo		= nr_seq_periodo_p;

	end if;

	if (ie_opcao_p = 'T') or (ie_lucro_prejuizo_w in ('G','GI')) then
		
		delete	from w_diops_fin_lucro_prej
		where	nr_seq_periodo		= nr_seq_periodo_p;

		delete	from diops_fin_lucro_prej
		where	nr_seq_periodo		= nr_seq_periodo_p;

	end if;

	if (ie_opcao_p = 'T') or (ie_solvencia_w in ('G','GI')) then
		
		delete	from w_diops_fin_solvencia
		where	nr_seq_periodo		= nr_seq_periodo_p;

		delete	from diops_fin_solvencia
		where	nr_seq_periodo		= nr_seq_periodo_p;
	end if;

	if (ie_opcao_p = 'T') or (ie_evento_sinistro_w in ('G','GI')) then
		
		delete	from w_diops_fin_sinistro
		where	nr_seq_periodo 		= nr_seq_periodo_p;

		delete	from diops_fin_sinistro
		where	nr_seq_periodo 		= nr_seq_periodo_p;
		
		delete	from diops_fin_event_liq
		where	nr_seq_periodo 		= nr_seq_periodo_p;
	end if;

	if (ie_opcao_p = 'T') or (ie_balancete_ativo_w in ('G','GI')) then
		
		delete	from w_diops_fin_mov_ativo
		where	nr_seq_periodo		= nr_seq_periodo_p;

		delete	from diops_fin_mov_ativo
		where	nr_seq_periodo		= nr_seq_periodo_p;
	end if;

	if (ie_opcao_p = 'T') or (ie_balancete_passivo_w in ('G','GI')) then
		
		delete	from w_diops_fin_mov_passivo
		where	nr_seq_periodo		= nr_seq_periodo_p;

		delete	from diops_fin_mov_passivo
		where	nr_seq_periodo		= nr_seq_periodo_p;
	end if;

	if (ie_opcao_p = 'T') or (ie_balancete_receita_w in ('G','GI')) then

		delete	from w_diops_fin_mov_receita
		where	nr_seq_periodo		= nr_seq_periodo_p;

		delete	from diops_fin_mov_receita
		where	nr_seq_periodo		= nr_seq_periodo_p;
	end if;

	if (ie_opcao_p = 'T') or (ie_balancete_despesa_w in ('G','GI')) then
		
		delete	from w_diops_fin_mov_despesa
		where	nr_seq_periodo		= nr_seq_periodo_p;

		delete	from diops_fin_mov_despesa
		where	nr_seq_periodo		= nr_seq_periodo_p;
	end if;

	if (ie_opcao_p = 'T') or (dt_periodo_final_w < to_date('01/01/2016','dd/mm/yyyy')) then	
		
		delete	from w_diops_fin_intercambio
		where	nr_seq_periodo		= nr_seq_periodo_p;

		delete	from diops_fin_intercambio
		where	nr_seq_periodo		= nr_seq_periodo_p;
	end if;

	if (ie_opcao_p = 'T') or (ie_cobertura_assistencial_w in ('G','GI')) then
		
		delete	from w_diops_fin_cob_assist
		where	nr_seq_periodo		= nr_seq_periodo_p;

		delete	from diops_fin_cob_assist
		where	nr_seq_periodo		= nr_seq_periodo_p;
	end if;
	
	if (ie_opcao_p = 'T') or (ie_corresponsabilidade_w in ('G','GI')) and (ie_pasta_corresp_w = 'S') then	

		delete	from w_diops_fin_corresp
		where	nr_seq_periodo		= nr_seq_periodo_p;

		delete	from diops_fin_corresp
		where	nr_seq_periodo		= nr_seq_periodo_p;
	end if;

	if (ie_opcao_p = 'T') or (ie_interc_eventual_w in ('G','GI')) then
		begin
		
		delete	from diops_fin_interc_eventual
		where	nr_seq_periodo		= nr_seq_periodo_p;
		
		end;
	end if;

	if (ie_opcao_p = 'T') or (ie_movto_pel_w in ('G','GI')) then
		
		delete	from diops_movto_pel
		where	nr_seq_periodo 		= nr_seq_periodo_p;

		delete	FROM w_diops_movto_pel
		where	nr_seq_periodo			= nr_seq_periodo_p
		and	coalesce(ie_tipo_segurado, 'X') 	<> 'R';
	end if;
	
	/*delete	from diops_movto_rec
	where	nr_seq_periodo 		= nr_seq_periodo_p;*/
	if (ie_opcao_p = 'T') or (ie_agrup_contratos_w in ('G','GI')) then

		delete	from diops_movto_agrup_contrat
		where	nr_seq_periodo 		= nr_seq_periodo_p;
	end if;

	if (ie_opcao_p = 'T') then
		
		delete	from diops_fin_trib_coop a
		where	a.nr_seq_diops_coop_res in (	SELECT	x.nr_sequencia
							from	diops_fin_trib_coop_resumo x
							where	x.nr_seq_periodo	= nr_seq_periodo_p);
		
		delete	from diops_fin_trib_coop_resumo
		where	nr_seq_periodo 		= nr_seq_periodo_p;
		
	end if;
	
	if (ie_opcao_p = 'T') or (ie_corresp_diops_w in ('G','A')) then

		delete	from diops_fin_mov_corresp
		where	nr_seq_periodo 		= nr_seq_periodo_p;
	end if;
	
	if (ie_opcao_p = 'T') or (ie_fundos_comuns_w in ('G','A')) then

		delete	from diops_fin_fundos_comuns
		where	nr_seq_periodo 		= nr_seq_periodo_p;
	end if;

	if (ie_opcao_p = 'T' or ie_corresp_cedida_w in ('G', 'GI')) then
		delete from diops_movto_corresp_cedida
		where nr_seq_periodo = nr_seq_periodo_p;

		delete	FROM w_diops_movto_pel
		where	nr_seq_periodo		= nr_seq_periodo_p
		and	ie_tipo_segurado 	= 'R';
	end if;
	
	if (ie_opcao_p = 'T' or ie_contrap_pecun_w in ('G', 'GI')) then
		delete 	from diops_contrap_pecuniarias
		where 	nr_seq_periodo = nr_seq_periodo_p;

		delete 	from w_diops_contrap_pecun
		where 	nr_seq_periodo = nr_seq_periodo_p;
	end if;
	
	if (ie_opcao_p = 'T') then
		delete 	from diops_teste_tap
		where 	nr_seq_periodo = nr_seq_periodo_p;

		delete 	from diops_mod_padrao_capital
		where 	nr_seq_periodo = nr_seq_periodo_p;

		delete	FROM diops_contrap_ev_corresp
		where	nr_seq_periodo	= nr_seq_periodo_p;

		delete	FROM diops_contr_ev_corresp_en
		where	nr_seq_periodo = nr_seq_periodo_p;

		delete	FROM diops_cred_deb_apur_capit
		where	nr_seq_periodo = nr_seq_periodo_p;

		delete	FROM diops_apur_capital_det
		where	nr_seq_periodo = nr_seq_periodo_p;
	end if;
end if;

update	diops_periodo
set	dt_inicio_geracao	 = NULL,
	dt_fim_geracao		 = NULL,
	dt_atualizacao		= clock_timestamp(),
	nm_usuario		= nm_usuario_p
where	nr_sequencia		= nr_seq_periodo_p;

CALL pls_diops_gravar_historico(	nr_seq_periodo_p,
				2,
				'',
				'',
				nm_usuario_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_desfazer_diops ( nr_seq_periodo_p bigint, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

