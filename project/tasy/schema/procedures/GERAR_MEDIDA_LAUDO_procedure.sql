-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_medida_laudo ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
nr_seq_w		bigint;
nr_seq_proc_w		bigint;
nr_prescricao_w		bigint;
nr_seq_prescr_w		bigint;
dt_laudo_w		timestamp;

qt_anos_w		integer;
qt_peso_prescr_w	integer;
ie_sexo_w		varchar(10);
nr_atendimento_w	bigint;

cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;

qt_valor_minimo_w	double precision;
qt_valor_maximo_w	double precision;

vl_padrao_w		varchar(255);
ds_valor_medida_w	varchar(255);
ie_tipo_valor_w	varchar(5);
qt_peso_w		double precision;
qt_altura_cm_w	double precision;
qt_medida_w		double precision;
nr_Seq_interno_w	bigint;
nr_seq_apresent_w	bigint;
nr_seq_apresentacao_w	bigint;
cd_protocolo_w		bigint;
cd_especialidade_w	bigint;
cd_grupo_proc_w		bigint;
cd_area_procedimento_w	bigint;
ie_tipo_medida_w	varchar(15);

 
C01 CURSOR FOR 
SELECT	c.nr_sequencia, 
	upper(c.vl_padrao), 
	c.ie_tipo_valor, 
	coalesce(a.nr_seq_apresent,0), 
	c.nr_seq_apresentacao 
from	medida_exame_laudo c, 
	tipo_medida_laudo b, 
	tipo_medida_laudo_proc a 
where	a.nr_seq_tipo		= b.nr_sequencia 
and 	b.nr_sequencia		= c.nr_seq_tipo_medida 
and (a.nr_seq_proc_interno = nr_seq_interno_w) 
and	Obter_Se_mostra_medida(cd_protocolo_w, b.nr_sequencia) = 'S' 
and	c.ie_situacao		= 'A' 
and coalesce(b.ie_situacao,'A')		= 'A' 
 
 

union
 
SELECT	c.nr_sequencia, 
	upper(c.vl_padrao), 
	c.ie_tipo_valor, 
	coalesce(a.nr_seq_apresent,0), 
	c.nr_seq_apresentacao 
from	medida_exame_laudo c, 
	tipo_medida_laudo b, 
	tipo_medida_laudo_proc a 
where	a.nr_seq_tipo		= b.nr_sequencia 
and 	b.nr_sequencia		= c.nr_seq_tipo_medida 
and	coalesce(a.cd_procedimento,cd_procedimento_w)	= cd_procedimento_w 
and	coalesce(a.ie_origem_proced,ie_origem_proced_w)	= ie_origem_proced_w 
and	cd_especialidade_w	= coalesce(a.cd_especialidade,cd_especialidade_w) 
and	cd_grupo_proc_w		= coalesce(a.cd_grupo_proc,cd_grupo_proc_w) 
and	cd_area_procedimento_w	= coalesce(a.cd_area_procedimento,cd_area_procedimento_w) 
and	coalesce(a.nr_seq_proc_interno::text, '') = '' 
and	Obter_Se_mostra_medida(cd_protocolo_w, b.nr_sequencia) = 'S' 
and	c.ie_situacao		= 'A' 
and coalesce(b.ie_situacao,'A')		= 'A' 
order by 4,5;

C02 CURSOR FOR 
SELECT	QT_VALOR_MINIMO, 
	QT_VALOR_MAXIMO 
FROM	MEDIDA_EXAME_REFER 
WHERE	NR_SEQ_MEDIDA = nr_seq_w 
and (ie_sexo = ie_sexo_w or ie_sexo = 'A') 
and	qt_anos_w between qt_idade_minima and qt_idade_maxima 
and	qt_peso_prescr_w between coalesce(qt_peso_minimo,qt_peso_prescr_w) and coalesce(qt_peso_maximo,qt_peso_prescr_w) 
and (coalesce(ie_tipo_medida,1) = coalesce(coalesce(ie_tipo_medida_w, ie_tipo_medida) ,1)) 
order	by ie_sexo;


BEGIN 
 
select	nr_seq_proc, 
	nr_prescricao, 
	nr_seq_prescricao, 
	dt_laudo, 
	ie_tipo_medida, 
	cd_protocolo 
into STRICT	nr_seq_proc_w, 
	nr_prescricao_w, 
	nr_seq_prescr_w, 
	dt_laudo_w, 
	ie_tipo_medida_w, 
	cd_protocolo_w 
from	laudo_paciente 
where	nr_sequencia = nr_sequencia_p;
 
select	max((obter_idade(b.dt_nascimento, dt_laudo_w, 'A'))::numeric ), 
	max(coalesce(b.ie_sexo,'A')) 
into STRICT	qt_anos_w, 
	ie_sexo_w 
from	pessoa_fisica b, 
	prescr_medica a 
where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica 
and	a.nr_prescricao 	= nr_prescricao_w;
 
select	coalesce(obter_peso_prescr_sinal(nr_prescricao_w),0) 
into STRICT	qt_peso_prescr_w
;
 
if (nr_seq_proc_w IS NOT NULL AND nr_seq_proc_w::text <> '') then 
	begin 
	select	cd_procedimento, 
		ie_origem_proced, 
		nr_Seq_proc_interno 
	into STRICT	cd_procedimento_w, 
		ie_origem_proced_w, 
		nr_Seq_interno_w 
	from	procedimento_paciente 
	where	nr_sequencia = nr_seq_proc_w;
	exception 
	when others then 
		cd_procedimento_w	:= null;
		ie_origem_proced_w	:= null;
	end;
else 
	begin 
	select	cd_procedimento, 
		ie_origem_proced, 
		nr_Seq_proc_interno 
	into STRICT	cd_procedimento_w, 
		ie_origem_proced_w, 
		nr_Seq_interno_w 
	from	prescr_procedimento 
	where	nr_prescricao	= nr_prescricao_w 
	and	nr_sequencia	= nr_seq_prescr_w;
	exception 
	when others then 
		cd_procedimento_w	:= null;
		ie_origem_proced_w	:= null;
	end;
end if;
 
select	max(cd_especialidade), 
	max(cd_grupo_proc), 
	max(cd_area_procedimento) 
into STRICT	cd_especialidade_w, 
	cd_grupo_proc_w, 
	cd_area_procedimento_w 
from	estrutura_procedimento_v 
where	cd_procedimento = cd_procedimento_w 
and	ie_origem_proced = ie_origem_proced_w;
 
OPEN C01;
LOOP 
FETCH C01 into 
	nr_seq_w, 
	vl_padrao_w, 
	ie_tipo_valor_w, 
	nr_seq_apresent_w, 
	nr_seq_apresentacao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
		 
	qt_valor_minimo_w	:= null;
	qt_valor_maximo_w	:= null;
 
	open c02;
	loop 
	fetch c02 into	 
		qt_valor_minimo_w, 
		qt_valor_maximo_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
	end loop;
	close c02;
 
	ds_valor_medida_w	:= '';
	qt_medida_w		:= null;
	if (vl_padrao_w = '@PESO') then 
 
		select	QT_PESO 
		into STRICT	qt_peso_w 
		from	prescr_medica 
		where	nr_prescricao	= nr_prescricao_w;
		if (ie_tipo_valor_w = 'N') then 
			qt_medida_w		:= qt_peso_w;
		else 
			ds_valor_medida_w	:= qt_peso_w;
		end if;
 
	elsif (vl_padrao_w = '@ALTURA') then 
 
		select	QT_ALTURA_CM 
		into STRICT	qt_altura_cm_w 
		from	prescr_medica 
		where	nr_prescricao	= nr_prescricao_w;
		if (ie_tipo_valor_w = 'N') then 
			qt_medida_w		:= qt_altura_cm_w;
		else 
			ds_valor_medida_w	:= qt_altura_cm_w;
		end if;
	else 
		if (ie_tipo_valor_w = 'N') then 
			qt_medida_w		:= substr(vl_padrao_w,1,15);
		else 
			ds_valor_medida_w	:= vl_padrao_w;
		end if;
	end if;
 
	insert into laudo_paciente_medida(nr_sequencia, 
			nr_seq_laudo, 
			nr_seq_medida, 
			dt_atualizacao, 
			nm_usuario, 
			qt_minimo, 
			qt_maximo, 
			ds_valor_medida, 
			qt_medida) 
	values (nextval('laudo_paciente_medida_seq'), 
			nr_sequencia_p, 
			nr_seq_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			qt_valor_minimo_w, 
			qt_valor_maximo_w, 
			ds_valor_medida_w, 
			qt_medida_w);
 
END LOOP;
close C01;
 
commit;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_medida_laudo ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

