-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alterar_data_validade_req ( nr_seq_requisicao_p bigint, dt_nova_validade_p timestamp, nm_usuario_p text) AS $body$
DECLARE


dt_validade_senha_w		timestamp;
dt_rescisao_w			timestamp;
dt_limite_utilizacao_w		timestamp;
qt_dias_limite_prorrogacao_w	bigint;
ie_tipo_processo_w		pls_requisicao.ie_tipo_processo%type;
ie_tipo_intercambio_w		pls_requisicao.ie_tipo_intercambio%type;
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
cd_perfil_w			perfil.cd_perfil%type;
ie_param_27_w			varchar(2);


BEGIN

select	dt_validade_senha,
	ie_tipo_processo,
	ie_tipo_intercambio,
	nr_seq_segurado
into STRICT	dt_validade_senha_w,
	ie_tipo_processo_w,
	ie_tipo_intercambio_w,
	nr_seq_segurado_w
from	pls_requisicao
where	nr_sequencia = nr_seq_requisicao_p;

cd_perfil_w		:= somente_numero(wheb_usuario_pck.get_cd_perfil);
cd_estabelecimento_w	:= wheb_usuario_pck.get_cd_estabelecimento;
ie_param_27_w := obter_param_usuario(1271, 27, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w, ie_param_27_w);

if (coalesce(ie_param_27_w,'N') = 'N') then
	begin
		select	trunc(dt_rescisao),
			trunc(dt_limite_utilizacao)
		into STRICT	dt_rescisao_w,
			dt_limite_utilizacao_w
		from	pls_segurado
		where	nr_sequencia	= nr_seq_segurado_w;
	exception
	when others then
		dt_rescisao_w		:= null;
		dt_limite_utilizacao_w	:= null;
	end;

	if (trunc(dt_nova_validade_p) > dt_limite_utilizacao_w) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1023622,'DT_LIMITE=' || dt_limite_utilizacao_w);
		--Data informada não pode ser superior a data de limite de utilização(#@DT_LIMITE#@) do beneficiário!
	elsif (trunc(dt_nova_validade_p) > dt_rescisao_w and coalesce(dt_limite_utilizacao_w::text, '') = '') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1023623,'DT_RESCISAO=' || dt_rescisao_w);
		--Data informada não pode ser superior a data de rescisão(#@DT_RESCISAO#@) do beneficiário!
	end if;
end if;

/* -- OS 1685183 - Retirado tratamento devido a regra existente no Manual de Intercambio Nacional(MIN)
if	(ie_tipo_processo_w = 'I' and ie_tipo_intercambio_w = 'I') then
	wheb_mensagem_pck.exibir_mensagem_abort(1023487,''); --Não pode ser alterada a validade de uma requisição solicitada através do processo de intercâmbio.
end if;
*/
if (trunc(dt_validade_senha_w) > trunc(dt_nova_validade_p)) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(178162,'');
	--'Data informada não pode ser menor que a data de validade atual!'||'#@#@');
else
	qt_dias_limite_prorrogacao_w := pls_obter_qt_dia_data_validade(nr_seq_requisicao_p,nm_usuario_p);
	if (trunc(dt_nova_validade_p) > trunc(dt_validade_senha_w + qt_dias_limite_prorrogacao_w)) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(179785,'QT_DIAS_LIMITE_PRORROGACAO='||qt_dias_limite_prorrogacao_w);
		--'Data maior que o limite de '||qt_dias_limite_prorrogacao_w||' dias de prorrogação da validade!'||'#@#@');
	end if;
end if;

update 	pls_requisicao
set	dt_validade_senha = dt_nova_validade_p,
	nm_usuario = nm_usuario_p,
	dt_atualizacao = clock_timestamp()
where	nr_sequencia = nr_seq_requisicao_p;

CALL pls_requisicao_gravar_hist(	nr_seq_requisicao_p, 'L',
				'O usuário '||obter_nome_usuario(nm_usuario_p) ||' alterou a data de validade da requisição de '||
				dt_validade_senha_w || ' para '||dt_nova_validade_p||'.',
				null, nm_usuario_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alterar_data_validade_req ( nr_seq_requisicao_p bigint, dt_nova_validade_p timestamp, nm_usuario_p text) FROM PUBLIC;

