-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE verifica_avisos_usuario ( nm_usuario_p text, ds_retorno_p INOUT text) AS $body$
DECLARE

				 
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade: Verificar a quantidade de comunicações internas pendentes para o usuário logado. 
------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[ ] Objetos do dicionário [ X ] Tasy (Delphi/Java) [ ] Portal [ ] Relatórios [ ] Outros: 
 ------------------------------------------------------------------------------------------------------------------ 
Pontos de atenção: 
------------------------------------------------------------------------------------------------------------------- 
Referências: 
	Gestão de ordens de Serviço - Executada a cada 5 minutos mediante o parâmetro [7]. 
	Gestão do Suporte Wheb - Executada a cada minuto 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 
 
qt_reg_w		integer;
ie_gerencial_w		varchar(1);
ie_liberadas_w		varchar(1);
ds_comando_w		varchar(2000);
ds_parametros_w		varchar(2000);
ds_sep_bv_w		varchar(20);


BEGIN 
--ds_sep_bv_w	:= obter_separador_bv; 
 
ie_gerencial_w := OBTER_VALOR_PARAM_USUARIO(87,6,0,nm_usuario_p,1);
ie_liberadas_w := OBTER_VALOR_PARAM_USUARIO(87,9,0,nm_usuario_p,1);
 
/*ds_comando_w := ''|| 
	'select	count(*) ' || 
	'from		comunic_interna ' || 
	'where	obter_se_mostra_comunicacao(nr_sequencia, :nm_usuario, ''S'',:ie_gerencial,null,nm_usuario,substr(nm_usuario_destino,1,2000),substr(nm_usuario_destino,2001,2000),ie_geral,ie_gerencial,cd_perfil,nr_seq_classif,substr(ds_perfil_adicional,1,2000),substr(ds_perfil_adicional,2001,2000),ds_setor_adicional,cd_setor_destino,cd_estab_destino,ds_grupo,nm_usuario_oculto,substr(ds_grupo_perfil,1,2000),ds_usuarios_ocultos,''S'',ds_estab_adicional,cd_especialidade, cd_cargo, cd_perfil_origem, ie_envio_terceiro, ie_funcionario) = '||chr(39) ||'S'||chr(39) || ' ' || 
	'and 		dt_comunicado > (sysdate - 7)'; 
	 
ds_parametros_w := 'nm_usuario='||nm_usuario_p|| ds_sep_bv_w || 'ie_gerencial='||ie_gerencial_w;*/
 
 
if (ie_liberadas_w = 'S') then 
	/*ds_comando_w := ds_comando_w || ' and ((dt_liberacao is not null) or (nm_usuario = :nm_usuario))'; 
	ds_parametros_w := ds_parametros_w || ds_sep_bv_w || 'nm_usuario='||nm_usuario_p;*/
 
	select	count(*) 
	into STRICT	qt_reg_w 
	from	comunic_interna 
	where	obter_se_mostra_comunicacao(	nr_sequencia, 
						nm_usuario_p, 
						'S', 
						ie_gerencial_w, 
						null, 
						nm_usuario, 
						substr(nm_usuario_destino,1,2000), 
						substr(nm_usuario_destino,2001,2000), 
						ie_geral, 
						ie_gerencial, 
						cd_perfil, 
						nr_seq_classif, 
						substr(ds_perfil_adicional,1,2000), 
						substr(ds_perfil_adicional,2001,2000), 
						ds_setor_adicional, 
						cd_setor_destino, 
						cd_estab_destino, 
						ds_grupo, 
						nm_usuario_oculto, 
						substr(ds_grupo_perfil,1,2000), 
						ds_usuarios_ocultos, 
						'S', 
						ds_estab_adicional, 
						cd_especialidade, 
						cd_cargo, 
						cd_perfil_origem, 
						ie_envio_terceiro, 
						ie_funcionario) = 'S' 
	and 	dt_comunicado > (clock_timestamp() - interval '7 days') 
	and	((dt_liberacao IS NOT NULL AND dt_liberacao::text <> '') or (nm_usuario = nm_usuario_p));
else 
	select	count(*) 
	into STRICT	qt_reg_w 
	from	comunic_interna 
	where	obter_se_mostra_comunicacao(	nr_sequencia, 
						nm_usuario_p, 
						'S', 
						ie_gerencial_w, 
						null, 
						nm_usuario, 
						substr(nm_usuario_destino,1,2000), 
						substr(nm_usuario_destino,2001,2000), 
						ie_geral, 
						ie_gerencial, 
						cd_perfil, 
						nr_seq_classif, 
						substr(ds_perfil_adicional,1,2000), 
						substr(ds_perfil_adicional,2001,2000), 
						ds_setor_adicional, 
						cd_setor_destino, 
						cd_estab_destino, 
						ds_grupo, 
						nm_usuario_oculto, 
						substr(ds_grupo_perfil,1,2000), 
						ds_usuarios_ocultos, 
						'S', 
						ds_estab_adicional, 
						cd_especialidade, 
						cd_cargo, 
						cd_perfil_origem, 
						ie_envio_terceiro, 
						ie_funcionario) = 'S' 
	and 	dt_comunicado > (clock_timestamp() - interval '7 days');
end if;
 
--obter_valor_dinamico_bv(ds_comando_w,ds_parametros_w,qt_reg_w); 
 
ds_retorno_p	:= qt_reg_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE verifica_avisos_usuario ( nm_usuario_p text, ds_retorno_p INOUT text) FROM PUBLIC;

