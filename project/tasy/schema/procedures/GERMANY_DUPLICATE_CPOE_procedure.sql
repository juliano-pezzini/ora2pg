-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE germany_duplicate_cpoe ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nr_seq_exame_p prescr_procedimento.nr_seq_interno%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


cpoe_procedimento_w		cpoe_procedimento%rowtype;

nr_seq_cpoe_w			cpoe_procedimento.nr_sequencia%type;
cd_departamento_w		cpoe_procedimento.cd_departamento%type;

nr_prescricao_out_w		prescr_medica.nr_prescricao%type;
cd_estabelecimento_w		prescr_medica.cd_estabelecimento%type;
cd_setor_atendimento_w		prescr_medica.cd_setor_atendimento%type;
cd_perfil_w			prescr_medica.cd_perfil_ativo%type;
nm_usuario_w			prescr_medica.nm_usuario_original%type;
cd_pessoa_fisica_w		prescr_medica.cd_pessoa_fisica%type;
ie_motivo_prescricao_w		prescr_medica.ie_motivo_prescricao%type;
cd_medico_w			prescr_medica.cd_medico%type;
ie_adep_w			prescr_medica.ie_adep%type;

ds_erro_w			varchar(4000);
ds_itens_liberar_w			varchar(4000);
ds_inconsist_lib_out_w		varchar(4000);
ds_itens_liberados_w		varchar(4000);
ds_lista_proc_susp_w		varchar(4000);
ds_prescr_geradas_full_w		varchar(4000);
ie_inconsistencia_out_w		varchar(1);

pending_prescr_procs CURSOR FOR
	SELECT	nr_seq_proc_cpoe
	from	prescr_procedimento
	where	nr_prescricao	= nr_prescricao_p
	and	(nr_seq_proc_cpoe IS NOT NULL AND nr_seq_proc_cpoe::text <> '')
	and	coalesce(nr_seq_origem::text, '') = ''
	order by	nr_sequencia;
	
BEGIN

	select	cd_estabelecimento,
		cd_setor_atendimento,
		cd_perfil_ativo,
		nm_usuario_original,
		cd_pessoa_fisica,
		ie_motivo_prescricao,
		cd_medico,
		ie_adep
	into STRICT	cd_estabelecimento_w,
		cd_setor_atendimento_w,
		cd_perfil_w,
		nm_usuario_w,
		cd_pessoa_fisica_w,
		ie_motivo_prescricao_w,
		cd_medico_w,
		ie_adep_w
	from	prescr_medica
	where	nr_prescricao	= nr_prescricao_p;

	-- Duplicar porcedimentos da prescricao para o novo atendimento
	<<duplicate_cpoe_items>>
	for item_copy_w in pending_prescr_procs loop
		begin
		
		select	*
		into STRICT	cpoe_procedimento_w
		from	cpoe_procedimento
		where	nr_sequencia = item_copy_w.nr_seq_proc_cpoe;
		
		select	nextval('cpoe_procedimento_seq')
		into STRICT	nr_seq_cpoe_w
		;
		
		cpoe_procedimento_w.nr_sequencia		:= nr_seq_cpoe_w;
		cpoe_procedimento_w.nr_atendimento		:= nr_atendimento_p;
		cpoe_procedimento_w.dt_atualizacao		:= clock_timestamp();
		cpoe_procedimento_w.dt_atualizacao_nrec	:= clock_timestamp();
		cpoe_procedimento_w.ie_duracao		:= 'P';
		cpoe_procedimento_w.dt_inicio		:= clock_timestamp();
		cpoe_procedimento_w.dt_fim			:= clock_timestamp() + interval '1 days';
		cpoe_procedimento_w.dt_prim_horario		:= clock_timestamp();
		cpoe_procedimento_w.dt_liberacao		:= null;
		cpoe_procedimento_w.nr_seq_cpoe_anterior	:= item_copy_w.nr_seq_proc_cpoe;
		cpoe_procedimento_w.dt_prox_geracao		:= null;
		cpoe_procedimento_w.ds_stack		:= null;
		cpoe_procedimento_w.dt_suspensao		:= null;
		cpoe_procedimento_w.nm_usuario_susp	:= null;
		cpoe_procedimento_w.dt_lib_suspensao	:= null;
		cpoe_procedimento_w.nr_seq_motivo_susp	:= null;
		cpoe_procedimento_w.nm_usuario_lib_enf	:= null;
		cpoe_procedimento_w.cd_farmac_lib		:= null;
		cpoe_procedimento_w.dt_liberacao_enf		:= null;
		cpoe_procedimento_w.dt_liberacao_farm	:= null;
		cpoe_procedimento_w.nm_usuario_lib_farm	:= null;
		cpoe_procedimento_w.nr_seq_agenda		:= null;
		cpoe_procedimento_w.nr_seq_lista_espera	:= null;
		cpoe_procedimento_w.ie_forma_geracao	:= null;
		cpoe_procedimento_w.ie_forma_suspensao	:= null;
		
		insert into cpoe_procedimento values (cpoe_procedimento_w.*);
		
		CALL cpoe_atualizar_data_agora(	nr_atendimento_p			=>	nr_atendimento_p,
					nr_seq_cpoe_p			=>	nr_seq_cpoe_w,
					ie_tipo_item_p			=>	'P',
					dt_referencia_p			=>	clock_timestamp(),
					cd_estabelecimento_p		=>	cd_estabelecimento_w,
					cd_perfil_p			=>	cpoe_procedimento_w.cd_perfil_ativo,
					nm_usuario_p			=>	cpoe_procedimento_w.nm_usuario,
					cd_pessoa_fisica_p			=>	cpoe_procedimento_w.cd_pessoa_fisica,
					ie_reprogramar_inicio_p		=>	'S');
				
		-- Lista de itens a serem liberados no padrao esperado pela procedure de liberacao
		ds_itens_liberar_w		:=	ds_itens_liberar_w || 'P,' || nr_seq_cpoe_w || ';';	
		
		cd_departamento_w	:=	cpoe_procedimento_w.cd_departamento;	
		
		end;
	end loop duplicate_cpoe_items;
	
	-- Liberar itens para gerar nova prescricao

	-- A suspensão dos itens de origem é realizada pela CPOE_SUSPENDER_ITEM_PRESCR chamada dentro da CPOE_LIBERACAO
	SELECT * FROM CPOE_Liberacao(	cd_estabelecimento_p	=>	cd_estabelecimento_w, cd_setor_atendimento_p	=>	cd_setor_atendimento_w, cd_perfil_p		=>	cd_perfil_w, nr_atendimento_p		=>	nr_atendimento_p, itens_liberar_p		=>	ds_itens_liberar_w, nm_usuario_p		=>	nm_usuario_w, ds_itens_liberados_p    	=>	ds_itens_liberados_w, ie_inconsistencia_out_p	=>	ie_inconsistencia_out_w, cd_pessoa_fisica_p		=>	cd_pessoa_fisica_w, ie_interv_farmacia_p	=>	'N', ie_liberacao_ang_p		=>	'S', ie_motivo_prescr_p		=>	ie_motivo_prescricao_w, cd_medico_p		=>	cd_medico_w, nr_prescricao_out_p	=>	nr_prescricao_out_w, ds_lista_proc_susp_out_p	=>	ds_lista_proc_susp_w, ds_inconsist_lib_out_p	=>	ds_inconsist_lib_out_w, ie_adep_p		=>	ie_adep_w, cd_departamento_p		=>	cd_departamento_w, ds_prescr_geradas_full_p	=>	ds_prescr_geradas_full_w) INTO STRICT ds_itens_liberados_p    	=>	ds_itens_liberados_w, ie_inconsistencia_out_p	=>	ie_inconsistencia_out_w, ds_lista_proc_susp_out_p	=>	ds_lista_proc_susp_w, ds_inconsist_lib_out_p	=>	ds_inconsist_lib_out_w, ie_adep_p		=>	ie_adep_w,;
					
	if (coalesce(ie_inconsistencia_out_w,'A') <> 'N') then
	
		ds_erro_p			=>	ds_erro_w := Liberar_prescricao(	nr_prescricao_p		=>	nr_prescricao_out_w, nr_atendimento_p		=>	nr_atendimento_p, ie_tipo_pessoa_p		=>	'S', cd_perfil_p		=>	cd_perfil_w, nm_usuario_p		=>	nm_usuario_w, ie_prescricao_p		=>	'S', ds_erro_p			=>	ds_erro_w, ie_gera_hor_copia_cpoe_p	=>	'S');
							
	end if;
	
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE germany_duplicate_cpoe ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_prescricao_p prescr_medica.nr_prescricao%type, nr_seq_exame_p prescr_procedimento.nr_seq_interno%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

