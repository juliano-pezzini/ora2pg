-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_contabiliza_baixa_mens ( nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text) AS $body$
DECLARE


ds_conteudo_w				varchar(4000);
ds_observacao_titulo_w			varchar(4000);
cd_conta_contabil_w			varchar(200);
nr_documento_w				varchar(255);
nr_nota_fiscal_w			varchar(255);
ds_compl_historico_w			varchar(255);
ds_erro_w				varchar(255);
ds_observacao_liq_w			varchar(255);
ds_nota_credito_w			varchar(255);
ds_recebimentos_w			varchar(120);
nr_titulo_doc_w				varchar(100);
cd_conta_deb_pls_w			varchar(100);
cd_conta_rec_pls_w			varchar(100);
ds_devedor_w				varchar(80);
ds_acao_w				varchar(60);
nm_atributo_w				varchar(50);
ie_contab_tit_cancelado_w		varchar(20);
ie_contab_rec_classif_w			varchar(20);
cd_conta_transitoria_w			varchar(20);
ie_cc_glosa_w				varchar(15);
ie_acao_w				varchar(15);
ie_permite_estab_dif_w			varchar(15)	:= 'N';
cd_cgc_w				varchar(14);
cd_pessoa_fisica_w			varchar(10);
ie_origem_tit_rec_w			varchar(10);
ie_compl_hist_w				varchar(5);
ie_contab_cr_no_cb_w			varchar(3);
ie_lote_pro_rata_w			varchar(3);
ie_tipo_lote_baixa_mens_w		varchar(3);
ie_contab_analitico_w			varchar(1);
ie_devedor_hist_contab_w		varchar(1);
ie_nf_hist_contab_w			varchar(1);
ie_dt_contab_cr_w			varchar(1);
ie_contab_classif_tit_rec_w		varchar(1);
ie_dt_contab_glosa_w			varchar(1);
ie_contab_vl_estorno_w			varchar(1);
ie_contab_baixas_pro_rata_w		varchar(1);
ie_tipo_lote_pls_w			varchar(1);
ie_tipo_conta_glosa_w			varchar(1);
ie_recebimento_antec_passivo_w		varchar(1);
vl_transacao_w				double precision;
vl_retorno_w				double precision;
vl_antecipacao_mens_w			double precision;
cd_centro_custo_w			bigint;
nr_seq_cobr_escrit_w			bigint;
nr_seq_negociacao_w			bigint;
nr_titulo_w				bigint;
nr_seq_conta_banco_w			bigint;
nr_seq_trans_fin_w			bigint;
nr_seq_protocolo_w			bigint;
nr_interno_conta_w			bigint;
nr_atendimento_w			bigint;
cd_tipo_lote_contabil_w			bigint;
nr_seq_retorno_w			bigint;
cd_historico_pls_w			bigint;
nr_sequencia_w				bigint	:= 0;
nr_seq_movto_trans_fin_w		bigint;
nr_seq_caixa_w				bigint;
nr_seq_receb_w				bigint;
nr_seq_ret_item_w			bigint;
nr_seq_produto_w			bigint;
nr_seq_caixa_od_w			bigint;
qt_estorno_contab_w			bigint;
nr_adiantamento_w			bigint;
nr_seq_bandeira_cartao_w		bigint;
nr_bordero_rec_w			bigint;
cd_estab_titulo_w			bigint;
cd_historico_ct_w			bigint;
nr_seq_nota_credito_w			bigint;
nr_seq_liq_cc_w				bigint;
nr_seq_movto_bco_pend_w			bigint;
qt_glosa_terceiro_w			bigint;
nr_titulo_ant_w				bigint	:= null;
cd_convenio_w				integer;
nr_seq_baixa_w				integer;
cd_estabelecimento_w			smallint;
dt_contabil_w				timestamp;
dt_movimento_w				timestamp;
dt_contabil_tit_w			timestamp;
dt_contab_lote_w			timestamp;
dt_referencia_pls_mens_w		timestamp;
cd_tipo_recebimento_w			integer;
ie_contab_mens_tesouraria_w		varchar(1);
ie_contab_classif_mens_w		varchar(1);
ie_tipo_conta_w				varchar(1);
dt_contabil_m_w				timestamp;
dt_contabil_fm_w			timestamp;
dt_contabil_fd_w			timestamp;
nr_nfe_imp_w				nota_fiscal.nr_nfe_imp%type;
nm_agrupador_w				agrupador_contabil.nm_atributo%type;
nr_seq_agrupamento_w			w_movimento_contabil.nr_seq_agrupamento%type;
nr_documento_ww				movimento_contabil.nr_documento%type;
ie_origem_documento_w			movimento_contabil.ie_origem_documento%type;
nr_seq_info_ctb_w			informacao_contabil.nr_sequencia%type;
nm_tabela_w				w_movimento_contabil.nm_tabela%type;
nm_atributo_ww				w_movimento_contabil.nm_atributo%type;
nr_seq_tab_orig_w			w_movimento_contabil.nr_seq_tab_orig%type;
nr_seq_tab_compl_w			w_movimento_contabil.nr_seq_tab_compl%type;
ie_segmentacao_w			pls_plano.ie_segmentacao%type;
cd_conta_codificacao_w			conta_contabil.cd_conta_contabil%type;
qt_conta_contabil_w			bigint;
nr_contador_w				bigint := 0;
nr_doc_analitico_w			ctb_documento.nr_doc_analitico%type;
nr_seq_proj_rec_w           bigint;

C01 CURSOR FOR
	SELECT	a.nr_titulo,
		CASE WHEN a.ie_acao='I' THEN  a.vl_recebido  ELSE a.vl_recebido * -1 END  vl_transacao,
		a.nr_seq_trans_fin,
		a.dt_recebimento,
		a.nr_seq_conta_banco,
		'VL_RECEBIDO',
		0 cd_centro_custo,
		a.dt_recebimento,
		'' cd_conta_contabil,
		a.nr_seq_retorno,
		a.nr_seq_ret_item,
		'' cd_conta_deb_pls,
		'' cd_conta_rec_pls,
		(null)::numeric  cd_historico_pls,
		a.nr_seq_movto_trans_fin,
		b.ds_observacao_titulo,
		(null)::numeric  nr_seq_produto,
		a.ds_observacao,
		a.ie_acao,
		a.nr_adiantamento,
		(null)::numeric  vl_antecipacao_mens,
		to_char(null) ie_lote_antecip_pls,
		to_date(null) dt_referencia_pls_mens,
		a.nr_sequencia nr_seq_baixa,
		null nr_seq_nota_credito,
		null nr_seq_liq_cc,
		null ie_lote_pro_rata,
		b.ie_origem_titulo,
		a.cd_tipo_recebimento,
		a.nr_seq_cobranca,
		'TITULO_RECEBER_LIQ' nm_tabela,
		'VL_RECEBIDO' nm_atrib,
		a.nr_titulo nr_seq_tab_orig,
		a.nr_sequencia nr_seq_tab_compl,
		0 nr_doc_analitico,
		14 nr_seq_info_ctb,
		a.nr_bordero,
        b.nr_seq_proj_rec
	from	titulo_receber_liq	a,
		titulo_receber		b
	where	a.nr_titulo		= b.nr_titulo
	and	a.nr_lote_contabil	= nr_lote_contabil_p
	and	a.vl_recebido		<> 0
	and	(a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
	and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = cd_estabelecimento_w))
	and	coalesce(ie_lib_caixa, 'S') 	= 'S'
	and	ie_contab_rec_classif_w		= 'N'
	
union all

	SELECT	a.nr_titulo,
		CASE WHEN a.ie_acao='I' THEN  c.vl_recebido  ELSE c.vl_recebido * -1 END  vl_transacao,
		a.nr_seq_trans_fin,
		a.dt_recebimento,
		a.nr_seq_conta_banco,
		'VL_RECEBIDO',
		c.cd_centro_custo,
		a.dt_recebimento,
		c.cd_conta_contabil,
		a.nr_seq_retorno,
		a.nr_seq_ret_item,
		'' cd_conta_deb_pls,
		'' cd_conta_rec_pls,
		(null)::numeric  cd_historico_pls,
		a.nr_seq_movto_trans_fin,
		b.ds_observacao_titulo,
		c.nr_seq_produto,
		a.ds_observacao,
		a.ie_acao,
		a.nr_adiantamento,
		(null)::numeric  vl_antecipacao_mens,
		to_char(null) ie_lote_antecip_pls,
		to_date(null) dt_referencia_pls_mens,
		a.nr_sequencia nr_seq_baixa,
		null nr_seq_nota_credito,
		null nr_seq_liq_cc,
		null ie_lote_pro_rata,
		b.ie_origem_titulo,
		a.cd_tipo_recebimento,
		a.nr_seq_cobranca,
		'TITULO_REC_LIQ_CC' nm_tabela,
		'VL_RECEBIDO' nm_atrib,
		c.nr_titulo nr_seq_tab_orig,
		a.nr_sequencia nr_seq_tab_compl,
		c.nr_sequencia nr_doc_analitico,
		14 nr_seq_info_ctb,
		a.nr_bordero,
        b.nr_seq_proj_rec
	from	titulo_rec_liq_cc	c,
		titulo_receber_liq	a,
		titulo_receber		b
	where	a.nr_sequencia		= c.nr_seq_baixa
	and	a.nr_titulo		= c.nr_titulo
	and	a.nr_titulo		= b.nr_titulo
	and	a.nr_lote_contabil	= nr_lote_contabil_p
	and	a.vl_Recebido		<> 0
	and	(a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
	and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = cd_estabelecimento_w))
	and	coalesce(ie_lib_caixa, 'S') 	= 'S'
	and	ie_contab_rec_classif_w	= 'S'
	
union all

	select	a.nr_titulo,
		CASE WHEN a.ie_acao='I' THEN  a.vl_descontos  ELSE a.vl_descontos * -1 END  vl_transacao,
		a.nr_seq_trans_fin,
		a.dt_recebimento,
		a.nr_seq_conta_banco,
		'VL_DESCONTOS',
		a.cd_centro_custo_desc cd_centro_custo,
		a.dt_recebimento,
		'' cd_conta_contabil,
		a.nr_seq_retorno,
		a.nr_seq_ret_item,
		'' cd_conta_deb_pls,
		'' cd_conta_rec_pls,
		(null)::numeric  cd_historico_pls,
		a.nr_seq_movto_trans_fin,
		b.ds_observacao_titulo,
		(null)::numeric  nr_seq_produto,
		a.ds_observacao,
		a.ie_acao,
		a.nr_adiantamento,
		(null)::numeric  vl_antecipacao_mens,
		to_char(null) ie_lote_antecip_pls,
		to_date(null) dt_referencia_pls_mens,
		a.nr_sequencia nr_seq_baixa,
		null nr_seq_nota_credito,
		null nr_seq_liq_cc,
		null ie_lote_pro_rata,
		b.ie_origem_titulo,
		a.cd_tipo_recebimento,
		a.nr_seq_cobranca,
		'TITULO_RECEBER_LIQ' nm_tabela,
		'VL_DESCONTOS' nm_atrib,
		a.nr_titulo nr_seq_tab_orig,
		a.nr_sequencia nr_seq_tab_compl,
		0 nr_doc_analitico,
		14 nr_seq_info_ctb,
		a.nr_bordero,
        b.nr_seq_proj_rec
	from	titulo_receber_liq	a,
		titulo_receber		b
	where	a.nr_titulo		= b.nr_titulo
	and	a.nr_lote_contabil	= nr_lote_contabil_p
	and	a.vl_descontos		<> 0
	and	(a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
	and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = cd_estabelecimento_w))
	and	coalesce(ie_lib_caixa, 'S')	= 'S'
	
union all

	select	a.nr_titulo,
		CASE WHEN a.ie_acao='I' THEN  a.vl_Juros  ELSE a.vl_Juros * -1 END  vl_transacao,
		a.nr_seq_trans_fin,
		a.dt_recebimento,
		a.nr_seq_conta_banco,
		'VL_JUROS',
		0 cd_centro_custo,
		a.dt_recebimento,
		'' cd_conta_contabil,
		a.nr_seq_retorno,
		a.nr_seq_ret_item,
		'' cd_conta_deb_pls,
		'' cd_conta_rec_pls,
		(null)::numeric  cd_historico_pls,
		a.nr_seq_movto_trans_fin,
		b.ds_observacao_titulo,
		(null)::numeric  nr_seq_produto,
		a.ds_observacao,
		a.ie_acao,
		a.nr_adiantamento,
		(null)::numeric  vl_antecipacao_mens,
		to_char(null) ie_lote_antecip_pls,
		to_date(null) dt_referencia_pls_mens,
		a.nr_sequencia nr_seq_baixa,
		null nr_seq_nota_credito,
		null nr_seq_liq_cc,
		null ie_lote_pro_rata,
		b.ie_origem_titulo,
		a.cd_tipo_recebimento,
		a.nr_seq_cobranca,
		'TITULO_RECEBER_LIQ' nm_tabela,
		'VL_JUROS' nm_atrib,
		a.nr_titulo nr_seq_tab_orig,
		a.nr_sequencia nr_seq_tab_compl,
		0 nr_doc_analitico,
		14 nr_seq_info_ctb,
		a.nr_bordero,
        b.nr_seq_proj_rec
	from	titulo_receber_liq	a,
		titulo_receber		b
	where	a.nr_titulo		= b.nr_titulo
	and	a.nr_lote_contabil	= nr_lote_contabil_p
	and	a.vl_juros		<> 0
	and	(a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
	and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = cd_estabelecimento_w))
	and	coalesce(ie_lib_caixa, 'S')	= 'S'
	
union all

	select	a.nr_titulo,
		CASE WHEN a.ie_acao='I' THEN  a.vl_multa  ELSE a.vl_Multa * -1 END  vl_transacao,
		a.nr_seq_trans_fin,
		a.dt_recebimento,
		a.nr_seq_conta_banco,
		'VL_MULTA',
		0 cd_centro_custo,
		a.dt_recebimento,
		'' cd_conta_contabil,
		a.nr_seq_retorno,
		a.nr_seq_ret_item,
		'' cd_conta_deb_pls,
		'' cd_conta_rec_pls,
		(null)::numeric  cd_historico_pls,
		a.nr_seq_movto_trans_fin,
		b.ds_observacao_titulo,
		(null)::numeric  nr_seq_produto,
		a.ds_observacao,
		a.ie_acao,
		a.nr_adiantamento,
		(null)::numeric  vl_antecipacao_mens,
		to_char(null) ie_lote_antecip_pls,
		to_date(null) dt_referencia_pls_mens,
		a.nr_sequencia nr_seq_baixa,
		null nr_seq_nota_credito,
		null nr_seq_liq_cc,
		null ie_lote_pro_rata,
		b.ie_origem_titulo,
		a.cd_tipo_recebimento,
		a.nr_seq_cobranca,
		'TITULO_RECEBER_LIQ' nm_tabela,
		'VL_MULTA' nm_atrib,
		a.nr_titulo nr_seq_tab_orig,
		a.nr_sequencia nr_seq_tab_compl,
		0 nr_doc_analitico,
		14 nr_seq_info_ctb,
		a.nr_bordero,
        b.nr_seq_proj_rec
	from	titulo_receber_liq	a,
		titulo_receber		b
	where	a.nr_titulo		= b.nr_titulo
	and	a.nr_lote_contabil	= nr_lote_contabil_p
	and	a.vl_multa		<> 0
	and	(a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
	and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = cd_estabelecimento_w))
	and	coalesce(ie_lib_caixa, 'S')	= 'S'
	
union all

	select	a.nr_titulo,
		CASE WHEN a.ie_acao='I' THEN  a.vl_despesa_bancaria  ELSE a.vl_despesa_bancaria * -1 END  vl_transacao,
		a.nr_seq_trans_fin,
		a.dt_recebimento,
		a.nr_seq_conta_banco,
		'VL_DESPESA_BANCARIA',
		0 cd_centro_custo,
		a.dt_recebimento,
		'' cd_conta_contabil,
		a.nr_seq_retorno,
		a.nr_seq_ret_item,
		'' cd_conta_deb_pls,
		'' cd_conta_rec_pls,
		(null)::numeric  cd_historico_pls,
		a.nr_seq_movto_trans_fin,
		b.ds_observacao_titulo,
		(null)::numeric  nr_seq_produto,
		a.ds_observacao,
		a.ie_acao,
		a.nr_adiantamento,
		(null)::numeric  vl_antecipacao_mens,
		to_char(null) ie_lote_antecip_pls,
		to_date(null) dt_referencia_pls_mens,
		a.nr_sequencia nr_seq_baixa,
		null nr_seq_nota_credito,
		null nr_seq_liq_cc,
		null ie_lote_pro_rata,
		b.ie_origem_titulo,
		a.cd_tipo_recebimento,
		a.nr_seq_cobranca,
		'TITULO_RECEBER_LIQ' nm_tabela,
		'VL_DESPESA_BANCARIA' nm_atrib,
		a.nr_titulo nr_seq_tab_orig,
		a.nr_sequencia nr_seq_tab_compl,
		0 nr_doc_analitico,
		14 nr_seq_info_ctb,
		a.nr_bordero,
        b.nr_seq_proj_rec
	from	titulo_receber_liq	a,
		titulo_receber		b
	where	a.nr_titulo		= b.nr_titulo
	and	a.nr_lote_contabil	= nr_lote_contabil_p
	and	a.vl_despesa_bancaria	<> 0
	and	(a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
	and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = cd_estabelecimento_w))
	and	coalesce(ie_lib_caixa, 'S')	= 'S'
	
union all

	select	a.nr_titulo,
		a.vl_transacao,
		a.nr_seq_trans_fin,
		a.dt_recebimento,
		a.nr_seq_conta_banco,
		a.ds_atributo,
		0 cd_centro_custo,
		a.dt_recebimento,
		'' cd_conta_contabil,
		a.nr_seq_retorno,
		a.nr_seq_ret_item,
		'' cd_conta_deb_pls,
		'' cd_conta_rec_pls,
		(null)::numeric  cd_historico_pls,
		a.nr_seq_movto_trans_fin,
		b.ds_observacao_titulo,
		(null)::numeric  nr_seq_produto,
		a.ds_observacao,
		a.ie_acao,
		a.nr_adiantamento,
		(null)::numeric  vl_antecipacao_mens,
		to_char(null) ie_lote_antecip_pls,
		to_date(null) dt_referencia_pls_mens,
		(null)::numeric  nr_seq_baixa,
		null nr_seq_nota_credito,
		null nr_seq_liq_cc,
		null ie_lote_pro_rata,
		b.ie_origem_titulo,
		null cd_tipo_recebimento,
		null nr_seq_cobranca,
		'TITULO_RECEBER_LIQ_CTB_CAMB_V' nm_tabela,
		ds_atributo nm_atrib,
		b.nr_titulo nr_seq_tab_orig,
		a.nr_seq_baixa nr_seq_tab_compl,
		0 nr_doc_analitico,
		14 nr_seq_info_ctb,
		a.nr_bordero,
        b.nr_seq_proj_rec
	from	titulo_receber			b,
		titulo_receber_liq_ctb_camb_v	a
	where	a.nr_lote_contabil		= nr_lote_contabil_p
	and	a.vl_transacao			<> 0
	and	(a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
	and	a.nr_titulo			= b.nr_titulo
	and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = cd_estabelecimento_w))
	
union all

	select	a.nr_titulo,
		CASE WHEN a.ie_acao='I' THEN  a.vl_glosa  ELSE a.vl_glosa * -1 END  vl_transacao,
		a.nr_seq_trans_fin,
		a.dt_recebimento,
		a.nr_seq_conta_banco,
		'VL_GLOSA',
		0 cd_centro_custo,
		a.dt_recebimento,
		'' cd_conta_contabil,
		a.nr_seq_retorno,
		a.nr_seq_ret_item,
		'' cd_conta_deb_pls,
		'' cd_conta_rec_pls,
		(null)::numeric  cd_historico_pls,
		a.nr_seq_movto_trans_fin,
		b.ds_observacao_titulo,
		(null)::numeric  nr_seq_produto,
		a.ds_observacao,
		a.ie_acao,
		a.nr_adiantamento,
		(null)::numeric  vl_antecipacao_mens,
		to_char(null) ie_lote_antecip_pls,
		to_date(null) dt_referencia_pls_mens,
		a.nr_sequencia nr_seq_baixa,
		null nr_seq_nota_credito,
		null nr_seq_liq_cc,
		null ie_lote_pro_rata,
		b.ie_origem_titulo,
		a.cd_tipo_recebimento,
		a.nr_seq_cobranca,
		'TITULO_RECEBER' nm_tabela,
		'VL_GLOSA' nm_atrib,
		b.nr_titulo nr_seq_tab_orig,
		a.nr_sequencia nr_seq_tab_compl,
		0 nr_doc_analitico,
		14 nr_seq_info_ctb,
		a.nr_bordero,
        b.nr_seq_proj_rec
	from	titulo_receber_liq	a,
		titulo_receber		b
	where	a.nr_titulo		= b.nr_titulo
	and	a.nr_lote_contabil	= nr_lote_contabil_p
	and	a.vl_glosa		<> 0
	and	ie_cc_glosa_w		= 'N'
	and	(a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
	and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = cd_estabelecimento_w))
	and	coalesce(ie_lib_caixa, 'S')	= 'S'
	and	coalesce(b.nr_seq_mensalidade::text, '') = ''
	
union	all

	select	a.nr_titulo,
		CASE WHEN a.ie_acao='I' THEN  x.vl_baixa WHEN a.ie_acao='E' THEN  x.vl_baixa  ELSE x.vl_baixa * -1 END  vl_transacao,
		a.nr_seq_trans_fin,
		a.dt_recebimento,
		a.nr_seq_conta_banco,
		'VL_GLOSA',
		x.cd_centro_custo,
		a.dt_recebimento,
		x.cd_conta_contabil,
		a.nr_seq_retorno,
		a.nr_seq_ret_item,
		'' cd_conta_deb_pls,
		'' cd_conta_rec_pls,
		(null)::numeric  cd_historico_pls,
		a.nr_seq_movto_trans_fin,
		b.ds_observacao_titulo,
		x.nr_seq_produto,
		a.ds_observacao,
		a.ie_acao,
		a.nr_adiantamento,
		(null)::numeric  vl_antecipacao_mens,
		to_char(null) ie_lote_antecip_pls,
		to_date(null) dt_referencia_pls_mens,
		a.nr_sequencia nr_seq_baixa,
		null nr_seq_nota_credito,
		null nr_seq_liq_cc,
		null ie_lote_pro_rata,
		b.ie_origem_titulo,
		a.cd_tipo_recebimento,
		a.nr_seq_cobranca,
		'TITULO_REC_LIQ_CC' nm_tabela,
		'VL_BAIXA' nm_atrib,
		b.nr_titulo nr_seq_tab_orig,
		a.nr_sequencia nr_seq_tab_compl,
		x.nr_sequencia nr_doc_analitico,
		14 nr_seq_info_ctb,
		a.nr_bordero,
        b.nr_seq_proj_rec
	from	titulo_rec_liq_cc	x,
		titulo_receber_liq	a,
		titulo_receber		b
	where	a.nr_sequencia		= x.nr_seq_baixa
	and	a.nr_titulo		= x.nr_titulo
	and	a.nr_lote_contabil	= nr_lote_contabil_p
	and	a.vl_glosa 		<> 0
	and	ie_cc_glosa_w		<> 'N'
	and	(a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
	and	a.nr_titulo		= b.nr_titulo
	and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = cd_estabelecimento_w))
	and	coalesce(ie_lib_caixa, 'S')	= 'S'
	and	coalesce(b.nr_seq_mensalidade::text, '') = ''
	
union all

	select	a.nr_titulo,
		CASE WHEN a.ie_acao='I' THEN  a.vl_rec_maior  ELSE a.vl_rec_maior * -1 END  vl_transacao,
		a.nr_seq_trans_fin,
		a.dt_recebimento,
		a.nr_seq_conta_banco,
		'VL_REC_MAIOR',
		0 cd_centro_custo,
		a.dt_recebimento,
		'' cd_conta_contabil,
		a.nr_seq_retorno,
		a.nr_seq_ret_item,
		'' cd_conta_deb_pls,
		'' cd_conta_rec_pls,
		(null)::numeric  cd_historico_pls,
		a.nr_seq_movto_trans_fin,
		b.ds_observacao_titulo,
		(null)::numeric  nr_seq_produto,
		a.ds_observacao,
		a.ie_acao,
		a.nr_adiantamento,
		(null)::numeric  vl_antecipacao_mens,
		to_char(null) ie_lote_antecip_pls,
		to_date(null) dt_referencia_pls_mens,
		a.nr_sequencia nr_seq_baixa,
		null nr_seq_nota_credito,
		null nr_seq_liq_cc,
		null ie_lote_pro_rata,
		b.ie_origem_titulo,
		a.cd_tipo_recebimento,
		a.nr_seq_cobranca,
		'TITULO_RECEBER_LIQ' nm_tabela,
		'VL_REC_MAIOR' nm_atrib,
		b.nr_titulo nr_seq_tab_orig,
		a.nr_sequencia nr_seq_tab_compl,
		0 nr_doc_analitico,
		14 nr_seq_info_ctb,
		a.nr_bordero,
        b.nr_seq_proj_rec
	from	titulo_receber b,
		titulo_receber_liq a
	where	a.nr_titulo		= b.nr_titulo
	and	a.nr_lote_contabil	= nr_lote_contabil_p
	and	a.vl_rec_maior		<> 0
	and	(a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
	--and	ie_cc_glosa_w		= 'N'
	and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = cd_estabelecimento_w))
	and	coalesce(ie_lib_caixa, 'S')	= 'S'/*
	union all
	select	a.nr_titulo,
		decode(a.ie_acao, 'I', x.vl_amaior, x.vl_amaior * -1) vl_transacao,
		a.nr_seq_trans_fin,
		a.dt_recebimento,
		a.nr_seq_conta_banco,
		'VL_REC_MAIOR',
		x.cd_centro_custo,
		a.dt_recebimento,
		x.cd_conta_contabil,
		a.nr_seq_retorno,
		a.nr_seq_ret_item,
		'' cd_conta_deb_pls,
		'' cd_conta_rec_pls,
		to_number(null) cd_historico_pls,
		a.nr_seq_movto_trans_fin,
		b.ds_observacao_titulo,
		x.nr_seq_produto,
		a.ds_observacao,
		a.ie_acao,
		a.nr_adiantamento,
		to_number(null) vl_antecipacao_mens,
		to_char(null) ie_lote_antecip_pls,
		to_date(null) dt_referencia_pls_mens,
		a.nr_sequencia nr_seq_baixa,
		null nr_seq_nota_credito,
		null nr_seq_liq_cc,
		null ie_lote_pro_rata,
		b.ie_origem_titulo,
		a.cd_tipo_recebimento,
		a.nr_seq_cobranca,
		'TITULO_REC_LIQ_CC' nm_tabela,
		'VL_REC_MAIOR' nm_atrib,
		x.nr_sequencia nr_seq_tab_orig,
		x.nr_titulo nr_seq_tab_compl,
		14 nr_seq_info_ctb
	from	titulo_rec_liq_cc	x,
		titulo_receber_liq	a,
		titulo_receber		b
	where	a.nr_sequencia		= x.nr_seq_baixa
	and	a.nr_titulo		= x.nr_titulo
	and	a.nr_titulo		= b.nr_titulo
	and	a.nr_lote_contabil	= nr_lote_contabil_p
	and	a.vl_rec_maior		<> 0
	and	a.nr_seq_trans_fin	is not null
	and	ie_cc_glosa_w		<> 'N'
	and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = cd_estabelecimento_w))
	and	nvl(ie_lib_caixa, 'S')	= 'S'
	and	b.nr_seq_mensalidade is null*/
	
union all

	select	a.nr_titulo,
		CASE WHEN a.ie_acao='I' THEN  a.vl_perdas  ELSE a.vl_perdas * -1 END ,
		a.nr_seq_trans_fin,
		a.dt_recebimento,
		a.nr_seq_conta_banco,
		'VL_PERDAS',
		0 cd_centro_custo,
		a.dt_recebimento,
		'' cd_conta_contabil,
		a.nr_seq_retorno,
		a.nr_seq_ret_item,
		'' cd_conta_deb_pls,
		'' cd_conta_rec_pls,
		(null)::numeric  cd_historico_pls,
		a.nr_seq_movto_trans_fin,
		b.ds_observacao_titulo,
		(null)::numeric  nr_seq_produto,
		a.ds_observacao,
		a.ie_acao,
		a.nr_adiantamento,
		(null)::numeric  vl_antecipacao_mens,
		to_char(null) ie_lote_antecip_pls,
		to_date(null) dt_referencia_pls_mens,
		a.nr_sequencia nr_seq_baixa,
		null nr_seq_nota_credito,
		null nr_seq_liq_cc,
		null ie_lote_pro_rata,
		b.ie_origem_titulo,
		a.cd_tipo_recebimento,
		a.nr_seq_cobranca,
		'TITULO_RECEBER_LIQ' nm_tabela,
		'VL_PERDAS' nm_atrib,
		b.nr_titulo nr_seq_tab_orig,
		a.nr_sequencia nr_seq_tab_compl,
		0 nr_doc_analitico,
		14 nr_seq_info_ctb,
		a.nr_bordero,
        b.nr_seq_proj_rec
	from	titulo_receber_liq	a,
		titulo_receber		b
	where	a.nr_titulo		= b.nr_titulo
	and	a.nr_lote_contabil	= nr_lote_contabil_p
	and	a.vl_perdas		<> 0
	and	(a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
	and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = cd_estabelecimento_w))
	and	coalesce(ie_lib_caixa, 'S')	= 'S'
	and	not exists (	select	1
			from	titulo_rec_liq_cc x
			where	x.nr_titulo		= a.nr_titulo
			and	x.nr_seq_baixa		= a.nr_sequencia
			and	coalesce(x.vl_perdas,0) <> 0)
	
union all

	select	a.nr_titulo,
		CASE WHEN a.ie_acao='I' THEN  c.vl_nota_credito  ELSE c.vl_nota_credito * -1 END  vl_transacao,
		a.nr_seq_trans_fin,
		a.dt_recebimento,
		a.nr_seq_conta_banco,
		'VL_NOTA_CREDITO',
		0 cd_centro_custo,
		a.dt_recebimento,
		'' cd_conta_contabil,
		a.nr_seq_retorno,
		a.nr_seq_ret_item,
		'' cd_conta_deb_pls,
		'' cd_conta_rec_pls,
		(null)::numeric  cd_historico_pls,
		a.nr_seq_movto_trans_fin,
		b.ds_observacao_titulo,
		(null)::numeric  nr_seq_produto,
		a.ds_observacao,
		a.ie_acao,
		a.nr_adiantamento,
		(null)::numeric  vl_antecipacao_mens,
		to_char(null) ie_lote_antecip_pls,
		to_date(null) dt_referencia_pls_mens,
		a.nr_sequencia nr_seq_baixa,
		c.nr_seq_nota_credito,
		null nr_seq_liq_cc,
		null ie_lote_pro_rata,
		b.ie_origem_titulo,
		a.cd_tipo_recebimento,
		a.nr_seq_cobranca,
		'TITULO_RECEBER_NC' nm_tabela,
		'VL_NOTA_CREDITO' nm_atrib,
		b.nr_titulo nr_seq_tab_orig,
		a.nr_sequencia nr_seq_tab_compl,
		c.nr_sequencia nr_doc_analitico,
		14 nr_seq_info_ctb,
		a.nr_bordero,
        b.nr_seq_proj_rec
	from	titulo_receber_liq	a,
		titulo_receber_nc	c,
		titulo_receber		b
	where	a.nr_titulo			= c.nr_titulo_rec
	and	a.nr_sequencia			= c.nr_seq_liq
	and	a.nr_titulo			= b.nr_titulo
	and	a.nr_lote_contabil		= nr_lote_contabil_p
	and	coalesce(ie_lib_caixa, 'S')		= 'S'
	and	a.vl_nota_credito		<> 0
	and	(a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
	and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = cd_estabelecimento_w))
	
union all

	select	a.nr_titulo,
		c.vl_baixa vl_transacao,
		c.nr_seq_trans_financ,
		a.dt_recebimento,
		a.nr_seq_conta_banco,
		'VL_TRIB_TIT_REC',
		0 cd_centro_custo,
		a.dt_recebimento,
		'' cd_conta_contabil,
		a.nr_seq_retorno,
		a.nr_seq_ret_item,
		'' cd_conta_deb_pls,
		'' cd_conta_rec_pls,
		(null)::numeric  cd_historico_pls,
		a.nr_seq_movto_trans_fin,
		b.ds_observacao_titulo,
		(null)::numeric  nr_seq_produto,
		a.ds_observacao,
		a.ie_acao,
		a.nr_adiantamento,
		(null)::numeric  vl_antecipacao_mens,
		to_char(null) ie_lote_antecip_pls,
		to_date(null) dt_referencia_pls_mens,
		a.nr_sequencia nr_seq_baixa,
		null nr_seq_nota_credito,
		null nr_seq_liq_cc,
		null ie_lote_pro_rata,
		b.ie_origem_titulo,
		a.cd_tipo_recebimento,
		a.nr_seq_cobranca,
		'TITULO_RECEBER_TRIB_BAIXA' nm_tabela,
		'VL_BAIXA' nm_atrib,
		b.nr_titulo nr_seq_tab_orig,
		a.nr_sequencia nr_seq_tab_compl,
		c.nr_sequencia nr_doc_analitico,
		14 nr_seq_info_ctb,
		a.nr_bordero,
        b.nr_seq_proj_rec
	from	titulo_receber_liq		a,
		titulo_receber_trib_baixa	c,
		titulo_receber			b
	where	a.nr_sequencia			= c.nr_seq_tit_liq
	and	a.nr_titulo			= c.nr_titulo
	and	a.nr_titulo			= b.nr_titulo
	and	a.nr_lote_contabil		= nr_lote_contabil_p
	and	(c.nr_seq_trans_financ IS NOT NULL AND c.nr_seq_trans_financ::text <> '')
	and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = cd_estabelecimento_w))
	and	coalesce(a.ie_lib_caixa, 'S')	= 'S'
	
union all

	select	a.nr_titulo,
		CASE WHEN a.ie_acao='I' THEN  x.vl_recebido  ELSE x.vl_recebido * -1 END  vl_transacao,
		a.nr_seq_trans_fin,
		a.dt_recebimento,
		a.nr_seq_conta_banco,
		'VL_REC_PLS',
		x.cd_centro_custo,
		a.dt_recebimento,
		'' cd_conta_contabil,
		a.nr_seq_retorno,
		a.nr_seq_ret_item,
		x.cd_conta_deb_pls,
		x.cd_conta_rec_pls,
		x.cd_historico_pls,
		a.nr_seq_movto_trans_fin,
		b.ds_observacao_titulo,
		x.nr_seq_produto,
		a.ds_observacao,
		a.ie_acao,
		a.nr_adiantamento,
		x.vl_antecipacao_mens,
		'B' ie_lote_antecip_pls,
		a.dt_referencia_pls_mens,
		a.nr_sequencia,
		null nr_seq_nota_credito,
		x.nr_sequencia nr_seq_liq_cc,
		CASE WHEN x.ie_lote_pro_rata='BA' THEN x.ie_lote_pro_rata  ELSE null END ,
		b.ie_origem_titulo,
		a.cd_tipo_recebimento,
		a.nr_seq_cobranca,
		'TITULO_REC_LIQ_CC' nm_tabela,
		'VL_RECEBIDO' nm_atrib,
		b.nr_titulo nr_seq_tab_orig,
		a.nr_sequencia nr_seq_tab_compl,
		x.nr_sequencia nr_doc_analitico,
		14 nr_seq_info_ctb,
		a.nr_bordero,
        b.nr_seq_proj_rec
	from	titulo_rec_liq_cc	x,
		titulo_receber_liq	a,
		titulo_receber		b
	where	a.nr_sequencia		= x.nr_seq_baixa
	and	a.nr_titulo		= x.nr_titulo
	and	a.nr_titulo		= b.nr_titulo
	and	a.nr_lote_contabil	= nr_lote_contabil_p
	and	b.ie_pls		= 'S'
	and	coalesce(a.ie_lib_caixa, 'S')	= 'S'
	and	a.vl_recebido		<> 0
	and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = cd_estabelecimento_w))
	and (x.ie_lote_pro_rata IS NOT NULL AND x.ie_lote_pro_rata::text <> '')
	AND (ie_contab_classif_mens_w = 'N' OR
	NOT EXISTS (SELECT	1
			FROM	pls_titulo_rec_liq_mens x
			WHERE	x.nr_titulo	= b.nr_titulo
			AND	x.nr_seq_baixa	= a.nr_sequencia))
	
union all

	select	a.nr_titulo,
		CASE WHEN a.ie_acao='I' THEN  x.vl_recebido  ELSE x.vl_recebido * -1 END  vl_transacao,
		a.nr_seq_trans_fin,
		a.dt_recebimento,
		a.nr_seq_conta_banco,
		'VL_REC_PLS',
		x.cd_centro_custo,
		a.dt_recebimento,
		'' cd_conta_contabil,
		a.nr_seq_retorno,
		a.nr_seq_ret_item,
		x.cd_conta_deb_pls,
		x.cd_conta_rec_pls,
		x.cd_historico_pls,
		a.nr_seq_movto_trans_fin,
		b.ds_observacao_titulo,
		x.nr_seq_produto,
		a.ds_observacao,
		a.ie_acao,
		a.nr_adiantamento,
		x.vl_antecipacao_mens,
		'A' ie_lote_antecip_pls,
		a.dt_referencia_pls_mens,
		a.nr_sequencia,
		null nr_seq_nota_credito,
		x.nr_sequencia nr_seq_liq_cc,
		CASE WHEN x.ie_lote_pro_rata='AN' THEN x.ie_lote_pro_rata  ELSE null END ,
		b.ie_origem_titulo,
		a.cd_tipo_recebimento,
		a.nr_seq_cobranca,
		'TITULO_REC_LIQ_CC' nm_tabela,
		'VL_RECEBIDO' nm_atrib,
		b.nr_titulo nr_seq_tab_orig,
		a.nr_sequencia nr_seq_tab_compl,
		x.nr_sequencia nr_doc_analitico,
		14 nr_seq_info_ctb,
		a.nr_bordero,
        b.nr_seq_proj_rec
	from	titulo_rec_liq_cc	x,
		titulo_receber_liq	a,
		titulo_receber		b
	where	a.nr_sequencia			= x.nr_seq_baixa
	and	a.nr_titulo			= x.nr_titulo
	and	a.nr_titulo			= b.nr_titulo
	and	a.nr_lote_contab_antecip	= nr_lote_contabil_p
	and	b.ie_pls			= 'S'
	and	coalesce(a.ie_lib_caixa, 'S')	= 'S'
	and	a.vl_recebido			<> 0
	and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento= cd_estabelecimento_w))
	and (x.ie_lote_pro_rata IS NOT NULL AND x.ie_lote_pro_rata::text <> '')
	AND (ie_contab_classif_mens_w = 'N' OR
	NOT EXISTS (SELECT	1
			FROM	pls_titulo_rec_liq_mens x
			WHERE	x.nr_titulo	= b.nr_titulo
			AND	x.nr_seq_baixa	= a.nr_sequencia))
	
union all

	select	a.nr_titulo,
		CASE WHEN a.ie_acao='I' THEN  x.vl_recebido  ELSE x.vl_recebido * -1 END  vl_transacao,
		a.nr_seq_trans_fin,
		a.dt_recebimento,
		a.nr_seq_conta_banco,
		'VL_REC_PLS',
		x.cd_centro_custo,
		a.dt_recebimento,
		'' cd_conta_contabil,
		a.nr_seq_retorno,
		a.nr_seq_ret_item,
		x.cd_conta_deb_pls,
		x.cd_conta_rec_pls,
		x.cd_historico_pls,
		a.nr_seq_movto_trans_fin,
		b.ds_observacao_titulo,
		x.nr_seq_produto,
		a.ds_observacao,
		a.ie_acao,
		a.nr_adiantamento,
		x.vl_antecipacao_mens,
		'P' ie_lote_antecip_pls,
		a.dt_referencia_pls_mens,
		a.nr_sequencia,
		null nr_seq_nota_credito,
		x.nr_sequencia nr_seq_liq_cc,
		CASE WHEN x.ie_lote_pro_rata='PR' THEN x.ie_lote_pro_rata  ELSE null END ,
		b.ie_origem_titulo,
		a.cd_tipo_recebimento,
		a.nr_seq_cobranca,
		'TITULO_REC_LIQ_CC' nm_tabela,
		'VL_RECEBIDO' nm_atrib,
		b.nr_titulo nr_seq_tab_orig,
		a.nr_sequencia nr_seq_tab_compl,
		x.nr_sequencia nr_doc_analitico,
		14 nr_seq_info_ctb,
		a.nr_bordero,
        b.nr_seq_proj_rec
	from	titulo_rec_liq_cc	x,
		titulo_receber_liq	a,
		titulo_receber		b
	where	a.nr_sequencia			= x.nr_seq_baixa
	and	a.nr_titulo			= x.nr_titulo
	and	a.nr_titulo			= b.nr_titulo
	and	a.nr_lote_contab_pro_rata	= nr_lote_contabil_p
	and	b.ie_pls			= 'S'
	and	coalesce(a.ie_lib_caixa, 'S')	= 'S'
	and	a.vl_recebido			<> 0
	and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = cd_estabelecimento_w))
	and (x.ie_lote_pro_rata IS NOT NULL AND x.ie_lote_pro_rata::text <> '')
	AND (ie_contab_classif_mens_w = 'N' OR
	NOT EXISTS (SELECT	1
			FROM	pls_titulo_rec_liq_mens x
			WHERE	x.nr_titulo	= b.nr_titulo
			AND	x.nr_seq_baixa	= a.nr_sequencia))
	
union all

	select	a.nr_titulo,
		CASE WHEN a.ie_acao='I' THEN  x.vl_recebido  ELSE x.vl_recebido * -1 END ,
		a.nr_seq_trans_fin,
		a.dt_recebimento,
		a.nr_seq_conta_banco,
		'VL_REC_ANTECIP',
		x.cd_centro_custo,
		a.dt_recebimento,
		x.cd_conta_rec_antecip cd_conta_contabil,
		a.nr_seq_retorno,
		a.nr_seq_ret_item,
		x.cd_conta_deb_pls,
		x.cd_conta_rec_pls,
		x.cd_historico_pls,
		a.nr_seq_movto_trans_fin,
		b.ds_observacao_titulo,
		x.nr_seq_produto,
		a.ds_observacao,
		a.ie_acao,
		a.nr_adiantamento,
		x.vl_antecipacao_mens,
		'B' ie_lote_antecip_pls,
		a.dt_referencia_pls_mens,
		a.nr_sequencia,
		null nr_seq_nota_credito,
		x.nr_sequencia nr_seq_liq_cc,
		CASE WHEN x.ie_lote_pro_rata='BA' THEN x.ie_lote_pro_rata  ELSE null END ,
		b.ie_origem_titulo,
		a.cd_tipo_recebimento,
		a.nr_seq_cobranca,
		'TITULO_REC_LIQ_CC' nm_tabela,
		'VL_RECEBIDO' nm_atrib,
		b.nr_titulo nr_seq_tab_orig,
		a.nr_sequencia nr_seq_tab_compl,
		x.nr_sequencia nr_doc_analitico,
		14 nr_seq_info_ctb,
		a.nr_bordero,
        b.nr_seq_proj_rec
	from	Titulo_rec_liq_cc x,
		titulo_receber b,
		titulo_receber_liq a
	where	a.nr_lote_contabil	= nr_lote_contabil_p
	and	a.vl_recebido		<> 0
	and	a.nr_titulo		= b.nr_titulo
	and	a.nr_titulo		= x.nr_titulo
	and	a.nr_sequencia		= x.nr_seq_baixa
	and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = cd_estabelecimento_w))
	and	b.ie_pls	= 'S'
	and	coalesce(a.ie_lib_caixa, 'S')	= 'S'
	and	ie_contab_baixas_pro_rata_w = 'A'
	and	ie_recebimento_antec_passivo_w = 'S'
	and	exists (select	1
			from	pls_mensalidade	w,
				pls_lote_mensalidade	k
			where	w.nr_seq_lote	= k.nr_sequencia
			and	w.nr_sequencia	= b.nr_seq_mensalidade
			and	(k.dt_contabilizacao IS NOT NULL AND k.dt_contabilizacao::text <> ''))
	
union all

	select	a.nr_titulo,
		CASE WHEN a.ie_acao='I' THEN  x.vl_recebido  ELSE x.vl_recebido * -1 END ,
		a.nr_seq_trans_fin,
		a.dt_recebimento,
		a.nr_seq_conta_banco,
		'VL_DEB_ANTECIP',
		x.cd_centro_custo,
		a.dt_recebimento,
		x.cd_conta_deb_antecip cd_conta_contabil,
		a.nr_seq_retorno,
		a.nr_seq_ret_item,
		x.cd_conta_deb_pls,
		x.cd_conta_rec_pls,
		x.cd_historico_pls,
		a.nr_seq_movto_trans_fin,
		b.ds_observacao_titulo,
		x.nr_seq_produto,
		a.ds_observacao,
		a.ie_acao,
		a.nr_adiantamento,
		x.vl_antecipacao_mens,
		'B' ie_lote_antecip_pls,
		a.dt_referencia_pls_mens,
		a.nr_sequencia,
		null nr_seq_nota_credito,
		x.nr_sequencia nr_seq_liq_cc,
		CASE WHEN x.ie_lote_pro_rata='BA' THEN x.ie_lote_pro_rata  ELSE null END ,
		b.ie_origem_titulo,
		a.cd_tipo_recebimento,
		a.nr_seq_cobranca,
		'TITULO_REC_LIQ_CC' nm_tabela,
		'VL_RECEBIDO' nm_atrib,
		b.nr_titulo nr_seq_tab_orig,
		a.nr_sequencia nr_seq_tab_compl,
		x.nr_sequencia nr_doc_analitico,
		14 nr_seq_info_ctb,
		a.nr_bordero,
        b.nr_seq_proj_rec
	from	Titulo_rec_liq_cc x,
		titulo_receber b,
		titulo_receber_liq a
	where	a.nr_lote_contabil	= nr_lote_contabil_p
	and	a.vl_recebido		<> 0
	and	a.nr_titulo		= b.nr_titulo
	and	a.nr_titulo		= x.nr_titulo
	and	a.nr_sequencia		= x.nr_seq_baixa
	and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento = cd_estabelecimento_w))
	and	b.ie_pls	= 'S'
	and	coalesce(a.ie_lib_caixa, 'S') = 'S'
	and	ie_contab_baixas_pro_rata_w = 'A'
	and	ie_recebimento_antec_passivo_w = 'S'
	and	exists (select	1
			from	pls_mensalidade	w,
				pls_lote_mensalidade	k
			where	w.nr_seq_lote	= k.nr_sequencia
			and	w.nr_sequencia	= b.nr_seq_mensalidade
			and	(k.dt_contabilizacao IS NOT NULL AND k.dt_contabilizacao::text <> ''))
	
UNION ALL

	SELECT	b.nr_titulo,
		c.vl_lancamento,
		a.nr_seq_trans_fin,
		c.dt_contabil,
		a.nr_seq_conta_banco,
		'VL_REC_PLS_MENS',
		c.cd_centro_custo,
		coalesce(c.dt_contabil,dt_contabil_w),
		'' cd_conta_contabil,
		0 nr_seq_retorno,
		0 nr_seq_ret_item,
		c.cd_conta_debito cd_conta_deb_pls,
		c.cd_conta_credito cd_conta_rec_pls,
		c.cd_historico cd_historico_pls,
		0 NR_SEQ_MOVTO_TRANS_FIN,
		b.ds_observacao_titulo,
		(NULL)::numeric  nr_seq_produto,
		'',
		'' ie_acao,
		0 nr_adiantamento,
		(NULL)::numeric  vl_antecipacao_mens,
		TO_CHAR(NULL) ie_lote_antecip_pls,
		CASE WHEN c.ie_tipo_lancamento='EA' THEN  c.dt_contabil  ELSE to_date(null) END  dt_referencia_pls_mens,
		a.nr_sequencia,
		NULL nr_seq_nota_credito,
		NULL nr_seq_liq_cc,
		CASE WHEN c.ie_tipo_lancamento='PR' THEN 'AN'  ELSE null END  ie_lote_pro_rata,
		b.ie_origem_titulo,
		a.cd_tipo_recebimento,
		a.nr_seq_cobranca,
		'PLS_TITULO_REC_LIQ_MENS' nm_tabela,
		'VL_LANCAMENTO' nm_atrib,
		b.nr_titulo nr_seq_tab_orig,
		a.nr_sequencia nr_seq_tab_compl,
		c.nr_sequencia nr_doc_analitico,
		14 nr_seq_info_ctb,
		a.nr_bordero,
        b.nr_seq_proj_rec
	FROM	pls_titulo_rec_liq_mens		c,
		titulo_receber			b,
		titulo_receber_liq		a
	WHERE	a.nr_titulo			= b.nr_titulo
	AND	a.nr_titulo			= c.nr_titulo
	AND	a.nr_sequencia			= c.nr_seq_baixa
	AND	c.nr_lote_contabil		= nr_lote_contabil_p
	AND	ie_contab_classif_mens_w 	= 'S'
	and	coalesce(a.ie_lib_caixa, 'S')	= 'S'
	
union all

	select	a.nr_titulo,
		CASE WHEN a.ie_acao='I' THEN  a.vl_perdas  ELSE a.vl_perdas * -1 END ,
		a.nr_seq_trans_fin,
		a.dt_recebimento,
		a.nr_seq_conta_banco,
		'VL_PERDAS',
		coalesce(c.cd_centro_custo,0),
		a.dt_recebimento,
		coalesce(c.cd_conta_contabil,''),
		a.nr_seq_retorno,
		a.nr_seq_ret_item,
		'' cd_conta_deb_pls,
		'' cd_conta_rec_pls,
		(null)::numeric  cd_historico_pls,
		a.nr_seq_movto_trans_fin,
		b.ds_observacao_titulo,
		coalesce(c.nr_seq_produto,(NULL)::numeric ),
		a.ds_observacao,
		a.ie_acao,
		a.nr_adiantamento,
		(null)::numeric  vl_antecipacao_mens,
		to_char(null) ie_lote_antecip_pls,
		to_date(null) dt_referencia_pls_mens,
		a.nr_sequencia nr_seq_baixa,
		null nr_seq_nota_credito,
		null nr_seq_liq_cc,
		null ie_lote_pro_rata,
		b.ie_origem_titulo,
		a.cd_tipo_recebimento,
		a.nr_seq_cobranca,
		'TITULO_REC_LIQ_CC' nm_tabela,
		'VL_PERDAS' nm_atrib,
		c.nr_sequencia nr_seq_tab_orig,
		a.nr_titulo nr_seq_tab_compl,
		c.nr_sequencia nr_doc_analitico,
		14 nr_seq_info_ctb,
		a.nr_bordero,
        b.nr_seq_proj_rec
	from	titulo_rec_liq_cc c,
		titulo_receber b,
		titulo_receber_liq a
	where	a.nr_lote_contabil	= nr_lote_contabil_p
	and	coalesce(c.vl_perdas,0) 	<> 0
	and	(a.nr_seq_trans_fin IS NOT NULL AND a.nr_seq_trans_fin::text <> '')
	and	a.nr_titulo		= b.nr_titulo
	and	a.nr_titulo		= c.nr_titulo
	and	a.nr_sequencia		= c.nr_seq_baixa
	and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento	= cd_estabelecimento_w))
	and	coalesce(ie_lib_caixa, 'S') = 'S'
	order by
		nr_titulo;


BEGIN
/*Validacao para impedir a geracao em lotes incorretos */

if (ie_exclusao_p <> 'S') then
        select b.cd_tipo_lote_contabil
        into STRICT cd_tipo_lote_contabil_w
        from lote_contabil b
        where b.nr_lote_contabil = nr_lote_contabil_p;
        if (cd_tipo_lote_contabil_w <> 39) then
                CALL wheb_mensagem_pck.exibir_mensagem_abort(261346);
        end if;
end if;
if (ie_exclusao_p 	= 'S') then
	CALL wheb_usuario_pck.set_ie_lote_contabil('S');

	delete	from movimento_contabil
	where	nr_lote_contabil	= nr_lote_contabil_p;
	
	update	lote_contabil
	set	vl_credito		= 0,
		vl_debito		= 0
	where	nr_lote_contabil	= nr_lote_contabil_p;
	
	commit;
	
	update	titulo_receber_liq
	set	nr_lote_contabil	= 0
	where	nr_lote_contabil	= nr_lote_contabil_p;
	
	commit;
	
	update	titulo_receber_liq
	set	nr_lote_contab_antecip	= 0
	where	nr_lote_contab_antecip	= nr_lote_contabil_p;
	
	commit;
	
	update	titulo_receber_liq a
	set	nr_lote_contab_pro_rata	= 0
	where	nr_lote_contab_pro_rata	= nr_lote_contabil_p;
	
	commit;
	
	update	pls_titulo_rec_liq_mens
	set	nr_lote_contabil	= 0
	where	nr_lote_contabil	= nr_lote_contabil_p;
	
	commit;
	
	CALL wheb_usuario_pck.set_ie_lote_contabil('N');
else
	select	dt_referencia,
		cd_estabelecimento,
		cd_tipo_lote_contabil
	into STRICT	dt_contabil_w,
		cd_estabelecimento_w,
		cd_tipo_lote_contabil_w
	from	lote_contabil
	where	nr_lote_contabil	= nr_lote_contabil_p;

	select	max(a.ie_recebimento_antec_passivo),
		max(a.ie_contab_mens_tesouraria)
	into STRICT	ie_recebimento_antec_passivo_w,
		ie_contab_mens_tesouraria_w
	from	pls_parametro_contabil a
	where	a.cd_estabelecimento	= cd_estabelecimento_w;
	
	ie_recebimento_antec_passivo_w	:= coalesce(ie_recebimento_antec_passivo_w,'N');
	ie_contab_mens_tesouraria_w	:= coalesce(ie_contab_mens_tesouraria_w, 'N');

	dt_contab_lote_w	:= dt_contabil_w;

	select	max(ie_contab_classif_mens)
	into STRICT	ie_contab_classif_mens_w
	from	pls_parametro_contabil
	where	cd_estabelecimento 	= cd_estabelecimento_w;
	
	ie_contab_classif_mens_w	:= coalesce(ie_contab_classif_mens_w,'N');

	select	max(ds_valor_parametro)
	into STRICT	ie_tipo_conta_w
	from	lote_contabil_parametro
	where	nr_lote_contabil 	= nr_lote_contabil_p
	and	nr_seq_parametro	= 1;
	
	ie_tipo_conta_w	:= coalesce(ie_tipo_conta_w,'A');

	begin
	select	ie_contab_analitico,
		ie_devedor_hist_contab,
		ie_nf_hist_contab,
		coalesce(ie_cc_glosa,'N'),
		coalesce(ie_dt_contab_cr,'L'),
		coalesce(ie_contab_tit_cancelado, 'S'),
		coalesce(ie_contab_rec_classif,'N'),
		coalesce(ie_contab_classif_tit_rec,'N'),
		coalesce(ie_dt_contab_glosa,'R'),
		coalesce(ie_contab_vl_estorno,'N')
	into STRICT	ie_contab_analitico_w,
		ie_devedor_hist_contab_w,
		ie_nf_hist_contab_w,
		ie_cc_glosa_w,
		ie_dt_contab_cr_w,
		ie_contab_tit_cancelado_w,
		ie_contab_rec_classif_w,
		ie_contab_classif_tit_rec_w,
		ie_dt_contab_glosa_w,
		ie_contab_vl_estorno_w
	from	parametro_contas_receber
	where	cd_estabelecimento	= cd_estabelecimento_w;
	exception
		when no_data_found then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(185991);
	end;

	begin
	select	ie_contab_cr_no_cb
	into STRICT	ie_contab_cr_no_cb_w
	from	parametro_controle_banc
	where	cd_estabelecimento	= cd_estabelecimento_w;
	exception
	when no_data_found then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(185992);
	end;

	select	coalesce(max(a.ie_contab_baixas_pro_rata),'N')
	into STRICT	ie_contab_baixas_pro_rata_w
	from	pls_parametros_cr a
	where	a.cd_estabelecimento	= cd_estabelecimento_w;

	select	coalesce(max(ie_tipo_lote_baixa_mens),'CR')
	into STRICT	ie_tipo_lote_baixa_mens_w
	from	pls_parametro_contabil
	where	cd_estabelecimento	= cd_estabelecimento_w;

	SELECT * FROM ctb_obter_regra_estab_dif(cd_estabelecimento_w, cd_tipo_lote_contabil_w, null, ie_permite_estab_dif_w, cd_conta_transitoria_w, cd_historico_ct_w) INTO STRICT ie_permite_estab_dif_w, cd_conta_transitoria_w, cd_historico_ct_w;
	
	
	--obter_valor_dinamico('Truncate Table W_Movimento_Contabil', vl_retorno_w);
	delete	FROM w_movimento_contabil
	where	nr_lote_contabil = nr_lote_contabil_p;
	commit;
	
	dt_contabil_m_w		:= trunc(dt_contabil_w, 'month');
	dt_contabil_fm_w	:= fim_mes(dt_contabil_w);
	dt_contabil_fd_w	:= fim_dia(dt_contabil_w);
	dt_contabil_w		:= dt_contabil_fm_w;
	
	CALL wheb_usuario_pck.set_ie_lote_contabil('S');
	
	update	titulo_receber_liq a
	set	nr_lote_contabil	= nr_lote_contabil_p
	where	coalesce(nr_lote_contabil,0)	= 0
	and	coalesce(ie_lib_caixa, 'S')	= 'S'
	and	dt_recebimento between dt_contabil_m_w and dt_contabil_fm_w
	and	dt_recebimento	<= dt_contabil_fd_w
	and	coalesce(nr_seq_lote_enc_contas::text, '') = '' /* Francisco - 30/10/2010 - Vai entrar em outro lote */
	and	coalesce(nr_seq_pls_lote_camara::text, '') = '' /* Francisco - 30/10/2010 - Vai entrar em outro lote */
	and	exists	(SELECT	1
			from	titulo_receber x
			where	x.nr_titulo	= a.nr_titulo
			and	x.ie_pls	= 'S'
			and	x.ie_origem_titulo = '3'
			and	((ie_permite_estab_dif_w <> 'N') or (x.cd_estabelecimento	= cd_estabelecimento_w))
			and	((x.ie_situacao	<> '3' or ie_contab_tit_cancelado_w = 'S')
			or (x.ie_situacao = '3' and a.vl_rec_maior <> 0)));
			
	commit;
	
	if (ie_contab_baixas_pro_rata_w = 'S') or (ie_contab_baixas_pro_rata_w = 'A') then
		update	titulo_receber_liq a
		set	nr_lote_contab_antecip		= nr_lote_contabil_p
		where	coalesce(nr_lote_contab_antecip,0)	= 0
		and	coalesce(ie_lib_caixa,'S')		= 'S'
		and	(a.dt_antecipacao_pls_mens IS NOT NULL AND a.dt_antecipacao_pls_mens::text <> '')
		and	a.dt_antecipacao_pls_mens between dt_contabil_m_w and dt_contabil_fm_w
		and	a.dt_antecipacao_pls_mens <= dt_contabil_fd_w
		and	coalesce(nr_seq_lote_enc_contas::text, '') = ''
		and	coalesce(nr_seq_pls_lote_camara::text, '') = ''
		and	exists	(SELECT	1
				from	titulo_receber x
				where	x.nr_titulo	= a.nr_titulo
				and	x.ie_pls	= 'S'
				and	x.ie_origem_titulo = '3'
				and	((ie_permite_estab_dif_w <> 'N') or (x.cd_estabelecimento = cd_estabelecimento_w))
				and (x.ie_situacao		<> '3' or ie_contab_tit_cancelado_w = 'S'));
				
		commit;
		
		update	titulo_receber_liq a
		set	nr_lote_contab_pro_rata		= nr_lote_contabil_p
		where	coalesce(nr_lote_contab_pro_rata,0)	= 0
		and	coalesce(ie_lib_caixa,'S')		= 'S'
		and	(a.dt_referencia_pls_mens IS NOT NULL AND a.dt_referencia_pls_mens::text <> '')
		and	a.dt_referencia_pls_mens between dt_contabil_m_w and dt_contabil_fm_w
		and	a.dt_referencia_pls_mens	<= dt_contabil_fd_w
		and	coalesce(nr_seq_lote_enc_contas::text, '') = ''
		and	coalesce(nr_seq_pls_lote_camara::text, '') = ''
		and	exists	(SELECT	1
				from	titulo_receber x
				where	x.nr_titulo	= a.nr_titulo
				and	x.ie_pls	= 'S'
				and	x.ie_origem_titulo = '3'
				and	((ie_permite_estab_dif_w <> 'N') or (x.cd_estabelecimento	= cd_estabelecimento_w))
				and (x.ie_situacao		<> '3' or ie_contab_tit_cancelado_w = 'S'));
				
		commit;
	end if;
	
	if (ie_contab_classif_mens_w = 'S') then
		update	pls_titulo_rec_liq_mens a
		set	nr_lote_contabil	= nr_lote_contabil_p
		where	a.nr_lote_contabil	= 0
		and	a.dt_contabil between dt_contabil_m_w and dt_contabil_fm_w
		and	a.dt_contabil	<= dt_contabil_fd_w
		and	(exists (SELECT	1
				from	titulo_receber_liq x
				where	x.nr_titulo		= a.nr_titulo
				and	x.nr_sequencia		= a.nr_seq_baixa
				and	x.nr_lote_contabil	= nr_lote_contabil_p
				and	coalesce(x.ie_lib_caixa, 'S')	= 'S') or
			exists 	(select	1
				from	pls_titulo_rec_liq_mens x,
					titulo_receber_liq	y
				where	((x.ie_tipo_lancamento	= 'EA' and
					x.nr_lote_contabil	= 0) or (x.nr_lote_contabil	<> a.nr_lote_contabil and
					x.nr_lote_contabil	<> 0))
				and	x.nr_seq_baixa		= y.nr_sequencia
				and	x.nr_seq_baixa		= a.nr_seq_baixa
				and	x.nr_titulo		= y.nr_titulo
				and	x.nr_titulo		= a.nr_titulo
				and	coalesce(y.ie_lib_caixa, 'S')	= 'S') or
			exists (	select	1
					from	titulo_receber_liq x
					where	x.nr_titulo			= a.nr_titulo
					and	x.nr_sequencia			= a.nr_seq_baixa
					and	x.nr_lote_contabil		= 0
					and	trunc(dt_recebimento,'month')	<= dt_contabil_m_w
					and	coalesce(x.ie_lib_caixa, 'S')	= 'S'))
		and	exists 	(select	1
				from	titulo_receber_liq	z
				where	z.nr_titulo	= a.nr_titulo
				and	z.nr_sequencia	= a.nr_seq_baixa
				--and 	z.dt_recebimento between trunc(dt_contabil_w, 'month') and Fim_Mes(dt_contabil_w)
				and	z.dt_recebimento <= dt_contabil_fd_w
				and (ie_tipo_conta_w in ('B','A'))
				and	coalesce(z.nr_seq_lote_enc_contas::text, '') = '' /* Francisco - 30/10/2010 - Vai entrar em outro lote */
				and	coalesce(z.nr_seq_pls_lote_camara::text, '') = '' /* Francisco - 30/10/2010 - Vai entrar em outro lote */
				and	coalesce(z.ie_lib_caixa, 'S')	= 'S'
				and	not exists (select	1
							from	titulo_receber	x
							where	z.nr_titulo		= x.nr_titulo
							and	x.ie_origem_titulo	= '8'
							and	(x.nr_seq_ptu_fatura IS NOT NULL AND x.nr_seq_ptu_fatura::text <> ''))
				and	not exists	(select	1
							from	titulo_receber	x
							where	z.nr_titulo		= x.nr_titulo
							and	x.ie_origem_titulo	= '11'
							and	((x.nr_seq_pls_lote_contest IS NOT NULL AND x.nr_seq_pls_lote_contest::text <> '') or (x.nr_seq_pls_lote_disc IS NOT NULL AND x.nr_seq_pls_lote_disc::text <> '')))
				and	exists	(select	1
						from	titulo_receber b
						where	z.nr_titulo		= b.nr_titulo
						and	((ie_permite_estab_dif_w <> 'N') or (b.cd_estabelecimento	= cd_estabelecimento_w))
						and (b.ie_situacao		<> '3' or ie_contab_tit_cancelado_w = 'S')
						and	coalesce(b.ie_pls,'N') = 'S'));
						
		commit;
	end if;
	
	if (ie_contab_cr_no_cb_w = 'S') then
		update	titulo_receber_liq a
		set	nr_lote_contabil	= 0
		where	nr_lote_contabil	= nr_lote_contabil_p
		and	exists (SELECT	1
				from	titulo_receber x
				where	x.nr_titulo	= a.nr_titulo
				and	x.ie_pls	= 'S'
				and	x.ie_origem_titulo = '3')
		and	(nr_seq_conta_banco IS NOT NULL AND nr_seq_conta_banco::text <> '')
		and	coalesce(nr_seq_lote_enc_contas::text, '') = ''
		and	coalesce(nr_seq_pls_lote_camara::text, '') = '';
		
		commit;
		
		if (ie_contab_baixas_pro_rata_w = 'S') then
			update	titulo_receber_liq a
			set	nr_lote_contab_antecip	= 0
			where	nr_lote_contab_antecip	= nr_lote_contabil_p
			and	exists (SELECT	1
					from	titulo_receber x
					where	x.nr_titulo	= a.nr_titulo
					and	x.ie_pls	= 'S'
					and	x.ie_origem_titulo = '3')
			and	(nr_seq_conta_banco IS NOT NULL AND nr_seq_conta_banco::text <> '')
			and	coalesce(nr_seq_lote_enc_contas::text, '') = ''
			and	coalesce(nr_seq_pls_lote_camara::text, '') = '';
			
			commit;
			
			update	titulo_receber_liq a
			set	nr_lote_contab_pro_rata	= 0
			where	nr_lote_contab_pro_rata	= nr_lote_contabil_p
			and	exists (SELECT	1
					from	titulo_receber x
					where	x.nr_titulo	= a.nr_titulo
					and	x.ie_pls	= 'S'
					and	x.ie_origem_titulo = '3')
			and	(nr_seq_conta_banco IS NOT NULL AND nr_seq_conta_banco::text <> '')
			and	coalesce(nr_seq_lote_enc_contas::text, '') = ''
			and	coalesce(nr_seq_pls_lote_camara::text, '') = '';
			
			commit;
		end if;
		
		if (ie_contab_classif_mens_w = 'S') then
			update	pls_titulo_rec_liq_mens a
			set	nr_lote_contabil	= 0
			where	nr_lote_contabil	= nr_lote_contabil_p
			and (ie_tipo_conta_w in ('B','A'))
			and	exists (SELECT	1
					from	titulo_receber_liq z
					where	z.nr_titulo	= a.nr_titulo
					and	z.nr_sequencia	= a.nr_seq_baixa
					and	(z.nr_seq_conta_banco IS NOT NULL AND z.nr_seq_conta_banco::text <> '')
					and	coalesce(z.nr_seq_lote_enc_contas::text, '') = ''
					and	coalesce(z.nr_seq_pls_lote_camara::text, '') = ''
					and	not exists (select	1
								from	titulo_receber	x
								where	z.nr_titulo		= x.nr_titulo
								and	x.ie_origem_titulo	= '8'
								and	(x.nr_seq_ptu_fatura IS NOT NULL AND x.nr_seq_ptu_fatura::text <> ''))
					and	not exists	(select	1
								from	titulo_receber	x
								where	z.nr_titulo		= x.nr_titulo
								and	x.ie_origem_titulo	= '11'
								and	((x.nr_seq_pls_lote_contest IS NOT NULL AND x.nr_seq_pls_lote_contest::text <> '') or (x.nr_seq_pls_lote_disc IS NOT NULL AND x.nr_seq_pls_lote_disc::text <> ''))));
								
			commit;
		end if;
	end if;
	
	if (ie_contab_mens_tesouraria_w = 'S') then
		update	pls_titulo_rec_liq_mens a
		set	a.nr_lote_contabil	= 0
		where	a.nr_lote_contabil	= nr_lote_contabil_p
		and	exists (SELECT	1
				from	titulo_receber_liq x
				where	a.nr_titulo = x.nr_titulo
				and	x.nr_sequencia = a.nr_seq_baixa
				and	(x.nr_seq_caixa_rec IS NOT NULL AND x.nr_seq_caixa_rec::text <> '')
				and	x.nr_lote_contabil	= nr_lote_contabil_p);
				
		commit;
				
		update	titulo_receber_liq a
		set	nr_lote_contabil	= 0
		where	nr_lote_contabil	= nr_lote_contabil_p
		and	(nr_seq_caixa_rec IS NOT NULL AND nr_seq_caixa_rec::text <> '');
		
		commit;
		
		if (ie_contab_baixas_pro_rata_w in ('A','S')) then
			update	titulo_receber_liq a
			set	nr_lote_contab_antecip	= 0
			where	nr_lote_contab_antecip	= nr_lote_contabil_p
			and	(nr_seq_caixa_rec IS NOT NULL AND nr_seq_caixa_rec::text <> '');
			
			commit;
			
			update	titulo_receber_liq a
			set	nr_lote_contab_pro_rata	= 0
			where	nr_lote_contab_pro_rata	= nr_lote_contabil_p
			and	(nr_seq_caixa_rec IS NOT NULL AND nr_seq_caixa_rec::text <> '');
			
			commit;
		end if;
	end if;
	
	CALL wheb_usuario_pck.set_ie_lote_contabil('N');
	
	begin
	ie_compl_hist_w	:= obter_se_compl_tipo_lote(cd_estabelecimento_w, cd_tipo_lote_contabil_w);
	exception
	when others then
		ie_compl_hist_w	:= null;
	end;
	nm_agrupador_w := coalesce(trim(both obter_agrupador_contabil(39)), 'NR_TITULO');
	open C01;
	loop
	fetch C01 into
		nr_titulo_w,
		vl_transacao_w,
		nr_seq_trans_fin_w,
		dt_movimento_w,
		nr_seq_conta_banco_w,
		nm_atributo_w,
		cd_centro_custo_w,
		dt_contabil_tit_w,
		cd_conta_contabil_w,
		nr_seq_retorno_w,
		nr_seq_ret_item_w,
		cd_conta_deb_pls_w,
		cd_conta_rec_pls_w,
		cd_historico_pls_w,
		nr_seq_movto_trans_fin_w,
		ds_observacao_titulo_w,
		nr_seq_produto_w,
		ds_observacao_liq_w,
		ie_acao_w,
		nr_adiantamento_w,
		vl_antecipacao_mens_w,
		ie_tipo_lote_pls_w,
		dt_referencia_pls_mens_w,
		nr_seq_baixa_w,
		nr_seq_nota_credito_w,
		nr_seq_liq_cc_w,
		ie_lote_pro_rata_w,
		ie_origem_tit_rec_w,
		cd_tipo_recebimento_w,
		nr_seq_cobr_escrit_w,
		nm_tabela_w,
		nm_atributo_ww,
		nr_seq_tab_orig_w,
		nr_seq_tab_compl_w,
		nr_doc_analitico_w,
		nr_seq_info_ctb_w,
		nr_bordero_rec_w,
        nr_seq_proj_rec_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ie_tipo_conta_glosa_w	:= 'G';
		
		select	max(nr_seq_caixa),
			max(nr_seq_caixa_od)
		into STRICT	nr_seq_caixa_w,
			nr_seq_caixa_od_w
		from	movto_trans_financ
		where	nr_sequencia	= nr_seq_movto_trans_fin_w;
		
		if (ie_dt_contab_cr_w = 'T') then
			dt_contabil_w	:= dt_contabil_tit_w;
		end if;
		
		if (nm_atributo_w = 'VL_GLOSA') then
			ie_tipo_conta_glosa_w	:= 'G';
			
			if (ie_dt_contab_glosa_w = 'F') then
				select	max(dt_fechamento)--nvl( dt_fechamento, dt_contabil_w)
				into STRICT	dt_contabil_w
				from	convenio_retorno
				where	nr_sequencia	= nr_seq_retorno_w;
			end if;
		end if;
		
		nr_titulo_doc_w		:= nr_titulo_w;
		--cd_convenio_w		:= 0;

		--cd_cgc_w		:= '';
		ds_acao_w		:= '';
		qt_estorno_contab_w	:= 0;
		ds_nota_credito_w	:= '';
		nr_seq_receb_w		:= null;
		ds_recebimentos_w	:= '';
		nr_seq_movto_bco_pend_w	:= null;
		
		if (ie_contab_vl_estorno_w = 'S') and
			((ie_acao_w = 'E') or (vl_transacao_w < 0)) then
			select	count(1)
			into STRICT	qt_estorno_contab_w
			from	titulo_receber_liq	a,
				lote_contabil		b
			where	a.nr_lote_contabil	= b.nr_lote_contabil
			and	a.nr_lote_contabil	<> 0
			and	a.vl_recebido		= abs(vl_transacao_w)
			and	a.nr_lote_contabil	<> nr_lote_contabil_p
			and	a.nr_titulo		= nr_titulo_w  LIMIT 1;
			
			if (qt_estorno_contab_w > 0) then
				ds_acao_w	:= 'Estorno';
			end if;
		end if;
		if (nr_titulo_w <> coalesce(nr_titulo_ant_w,0)) then
			select	max(a.cd_cgc),
				max(coalesce(a.nr_documento,0)),
				max(nr_interno_conta),
				max(nr_seq_protocolo),
				max(somente_numero(a.nr_nota_fiscal)),
				max(a.cd_pessoa_fisica),
				max(a.cd_estabelecimento),
				max(a.nr_seq_negociacao_origem)
			into STRICT	cd_cgc_w,
				nr_documento_w,
				nr_interno_conta_w,
				nr_seq_protocolo_w,
				nr_nota_fiscal_w,
				cd_pessoa_fisica_w,
				cd_estab_titulo_w,
				nr_seq_negociacao_w
			from	titulo_receber a
			where	nr_titulo	= nr_titulo_w;
			
			begin
			ds_devedor_w	:= substr(obter_nome_pf_pj(cd_pessoa_fisica_w, cd_cgc_w),1,80);
			exception
			when others then
				ds_devedor_w	:= null;
			end;
			
			if (coalesce(nr_interno_conta_w,0) > 0) then
				select	max(cd_cgc),
					max(b.cd_convenio),
					max(nr_atendimento)
				into STRICT	cd_cgc_w,
					cd_convenio_w,
					nr_atendimento_w
				from	convenio b,
					Conta_paciente a
				where	a.nr_interno_conta	= nr_interno_conta_w
				and	a.cd_convenio_parametro	= b.cd_convenio;
			elsif (coalesce(nr_seq_protocolo_w,0) > 0) then
				select	max(cd_cgc),
					max(b.cd_convenio)
				into STRICT	cd_cgc_w,
					cd_convenio_w
				from	convenio b,
					Protocolo_convenio a
				where	a.nr_seq_protocolo	= nr_seq_protocolo_w
				and	a.cd_convenio		= b.cd_convenio;
			end if;
			/*
			if	(nr_seq_cobr_escrit_w is null) then
				select	max(a.nr_seq_cobranca)
				into	nr_seq_cobr_escrit_w
				from	titulo_receber_cobr a
				where	a.nr_titulo = nr_titulo_w;
			end if;
			*/
		end if;
		
		if (ie_contab_analitico_w = 'S') then
			nr_documento_w		:= nr_titulo_w;
		else
			nr_titulo_doc_w		:= '';
			nr_documento_w		:= to_char(dt_movimento_w,'dd/mm/yyyy');
		end if;
		
		
		
		nr_documento_w	:= nr_documento_w || ' ' || ds_acao_w;
		
		if (ie_devedor_hist_contab_w = 'S') then
			nr_documento_w	:= substr(nr_documento_w || ' ' ||ds_devedor_w,1,255);
		end if;
		
		if (ie_nf_hist_contab_w	= 'S') then
			if (nr_nota_fiscal_w IS NOT NULL AND nr_nota_fiscal_w::text <> '') then
				nr_documento_w	:= substr(nr_documento_w || ' NF: ' || nr_nota_fiscal_w,1,255);
			end if;
			
			nr_documento_w		:= substr(nr_documento_w || ' Atend.:' || nr_atendimento_w,1,255);
		end if;
		
		if (coalesce(nr_seq_ret_item_w,0) <> 0) then
			select	max(nr_seq_receb)
			into STRICT	nr_seq_receb_w
			from	convenio_ret_receb
			where	nr_seq_retorno	= nr_seq_retorno_w;
			
			ds_recebimentos_w	:= substr(obter_retorno_receb_dados(nr_seq_retorno_w, 1),1,100);
			
			select	count(1)
			into STRICT	qt_glosa_terceiro_w
			from	trans_financ_contab	b,
				transacao_financeira	a
			where	a.nr_sequencia		= b.nr_seq_trans_financ
			and	b.ie_regra_conta	= 'CVT'
			and	a.nr_sequencia		= nr_seq_trans_fin_w  LIMIT 1;
			
			if (qt_glosa_terceiro_w > 0) then
				select	count(1)
				into STRICT	qt_glosa_terceiro_w
				from	procedimento_repasse d,
					procedimento_paciente c,
					convenio_retorno_glosa b,
					convenio_retorno_item a
				where	a.nr_sequencia		= nr_seq_ret_item_w
				and	a.nr_sequencia		= b.nr_seq_ret_item
				and	b.nr_seq_propaci_partic	= c.nr_sequencia
				and	c.nr_sequencia		= d.nr_seq_procedimento  LIMIT 1;
				
				if (qt_glosa_terceiro_w > 0) then
					ie_tipo_conta_glosa_w	:= 'GT';
				end if;
			end if;
		end if;
		
		if (nr_adiantamento_w = 0) then
			nr_adiantamento_w	:= null;
		end if;
		
		nr_seq_bandeira_cartao_w	:= null;
		
		select	max(a.nr_seq_movto_pend)
		into STRICT	nr_seq_movto_bco_pend_w
		from	movto_banco_pend_baixa a
		where	a.nr_titulo	= nr_titulo_w
		and	a.nr_seq_baixa	= nr_seq_baixa_w;
		
		if (coalesce(nr_seq_movto_bco_pend_w::text, '') = '') then
			if (coalesce(nr_bordero_rec_w,0) <> 0) then
				select	max(a.nr_seq_movto_pend)
				into STRICT	nr_seq_movto_bco_pend_w
				from	movto_banco_pend_baixa a
				where	a.nr_bordero_rec	= nr_bordero_rec_w;
			end if;
			
			if (coalesce(nr_seq_movto_bco_pend_w::text, '') = '') then
				select	max(a.nr_seq_movto_pend)
				into STRICT	nr_seq_movto_bco_pend_w
				from	movto_banco_pend_baixa a
				where	a.nr_seq_conv_receb	= nr_seq_receb_w;
			end if;
		end if;
		
		if (nr_titulo_w <> coalesce(nr_titulo_ant_w,nr_titulo_w)) then
			if (nm_atributo_w = 'VL_NOTA_CREDITO') then
				ds_nota_credito_w	:= substr(obter_nota_credito_tit_rec(nr_titulo_w),1,255);
			end if;
		end if;
		
		ds_conteudo_w	:= '';
		
		if (ie_compl_hist_w = 'S') then
			nr_nfe_imp_w	:= substr(obter_dados_titulo_receber(nr_titulo_w,'NE'),1,100);
			
			ds_conteudo_w	:= substr(	cd_cgc_w			||'#@'||
							ds_devedor_w			||'#@'||
							cd_estab_titulo_w		||'#@'||
							ds_recebimentos_w		||'#@'||
							nr_seq_receb_w			||'#@'||
							nr_bordero_rec_w		||'#@'||
							dt_movimento_w			||'#@'||
							nr_nota_fiscal_w		||'#@'||
							nr_titulo_w			||'#@'||
							ds_observacao_titulo_w		||'#@'||
							nr_seq_cobr_escrit_w		||'#@'||
							nr_seq_negociacao_w		||'#@'||
							nr_seq_movto_bco_pend_w		||'#@'||
							nr_seq_nota_credito_w		||'#@'||
							nr_nfe_imp_w,1, 4000);
		end if;
		
		nr_documento_ww	:= nr_nota_fiscal_w;
		ie_origem_documento_w	:= 1;	
		
		if (nm_agrupador_w = 'NR_TITULO') then
			nr_seq_agrupamento_w	:= nr_titulo_w;
		end if;
		
		if (nm_atributo_w = 'VL_REC_PLS') then
			if (ie_contab_baixas_pro_rata_w = 'A') then
				nr_sequencia_w := pls_contabiliza_pro_rata(	nr_lote_contabil_p, cd_tipo_lote_contabil_w, ie_lote_pro_rata_w, dt_contab_lote_w, cd_pessoa_fisica_w, cd_cgc_w, ds_conteudo_w, nr_seq_trans_fin_w, ie_compl_hist_w, nr_titulo_w, nr_seq_baixa_w, nr_seq_liq_cc_w, nm_usuario_p, nr_seq_agrupamento_w, nr_sequencia_w);
			elsif (ie_contab_baixas_pro_rata_w = 'S') then
				nr_sequencia_w := pls_contabiliza_baixa_pro_rata(	nr_lote_contabil_p, ie_tipo_lote_pls_w, vl_antecipacao_mens_w, dt_movimento_w, vl_transacao_w, nr_titulo_w, dt_contab_lote_w, cd_conta_rec_pls_w, cd_conta_deb_pls_w, cd_historico_pls_w, nr_seq_trans_fin_w, cd_pessoa_fisica_w, cd_cgc_w, nm_usuario_p, dt_referencia_pls_mens_w, ie_compl_hist_w, ds_conteudo_w, cd_tipo_lote_contabil_w, nr_seq_baixa_w, nr_seq_liq_cc_w, nr_sequencia_w);
			else
				if (ie_compl_hist_w = 'S') then
					select	substr(obter_compl_historico(cd_tipo_lote_contabil_w, cd_historico_pls_w, ds_conteudo_w),1,255)
					into STRICT	ds_compl_historico_w
					;
				end if;
				
				if (cd_conta_deb_pls_w IS NOT NULL AND cd_conta_deb_pls_w::text <> '') and (cd_historico_pls_w IS NOT NULL AND cd_historico_pls_w::text <> '') then
					nr_sequencia_w	:= nr_sequencia_w + 1;
					begin
					insert	into w_movimento_contabil(nr_lote_contabil,
						nr_sequencia,
						cd_conta_contabil,
						ie_debito_credito,
						cd_historico,
						dt_movimento,
						vl_movimento,
						ds_doc_agrupamento,
						nr_seq_agrupamento,
						cd_centro_custo,
						ds_compl_historico,
						nr_seq_trans_fin,
						nr_documento,
						cd_pessoa_fisica,
						cd_cgc,
						ie_transitorio,
						ie_origem_documento,
						nr_seq_info,
						nm_tabela,
						nm_atributo,
						nr_seq_tab_orig,
						nr_seq_tab_compl,
						nr_doc_analitico,
                        nr_seq_proj_rec
                        )
					values (nr_lote_contabil_p,
						nr_sequencia_w,
						cd_conta_deb_pls_w,
						'C',
						cd_historico_pls_w,
						dt_movimento_w,
						vl_transacao_w,
						null,
						null,
						null,
						ds_compl_historico_w,
						nr_seq_trans_fin_w,
						nr_documento_ww,
						cd_pessoa_fisica_w,
						cd_cgc_w,
						'N',
						ie_origem_documento_w,
						nr_seq_info_ctb_w,
						nm_tabela_w,
						nm_atributo_ww,
						nr_seq_tab_orig_w,
						nr_seq_tab_compl_w,
						nr_doc_analitico_w,
                        nr_seq_proj_rec_w);
					exception
					when OTHERS then
						ds_erro_w	:= sqlerrm(SQLSTATE);
						CALL wheb_mensagem_pck.exibir_mensagem_abort(185971,
										'CD_CONTA='	|| cd_conta_deb_pls_w		||';'||
										'NR_TITULO='	|| nr_titulo_w			||';'||
										'NR_SEQ_MOVTO='	|| nr_sequencia_w		||';'||
										'NR_SEQ_TRANS='	|| nr_seq_movto_trans_fin_w	||';'||
										'VL_MOVIMENTO='	|| vl_transacao_w		||';'||
										'DS_ERRO='	|| ds_erro_w);
					end;
				end if;
			end if;	
		elsif (nm_atributo_w = 'VL_REC_PLS_MENS') then
			
			if	((cd_conta_deb_pls_w IS NOT NULL AND cd_conta_deb_pls_w::text <> '') or (cd_conta_rec_pls_w IS NOT NULL AND cd_conta_rec_pls_w::text <> '')) and (cd_historico_pls_w IS NOT NULL AND cd_historico_pls_w::text <> '') then
				if (ie_compl_hist_w = 'S') then
					select	substr(obter_compl_historico(cd_tipo_lote_contabil_w, cd_Historico_pls_w, ds_conteudo_w),1,255)
					into STRICT	ds_compl_historico_w
					;
				end if;
				
				if	((coalesce(dt_referencia_pls_mens_w::text, '') = '') or
					((dt_referencia_pls_mens_w IS NOT NULL AND dt_referencia_pls_mens_w::text <> '') and (trunc(dt_contab_lote_w, 'month') = trunc(dt_referencia_pls_mens_w, 'month')))) then
					nr_sequencia_w	:= nr_sequencia_w + 1;
					
					begin
					insert	into w_movimento_contabil(nr_lote_contabil,
						nr_sequencia,
						cd_conta_contabil,
						ie_debito_credito,
						cd_historico,
						dt_movimento,
						vl_movimento,
						ds_doc_agrupamento,
						nr_seq_agrupamento,
						cd_centro_custo,
						ds_compl_historico,
						nr_seq_trans_fin,
						nr_documento,
						cd_pessoa_fisica,
						cd_cgc,
						ie_transitorio,
						ie_origem_documento,
						nr_seq_info,
						nm_tabela,
						nm_atributo,
						nr_seq_tab_orig,
						nr_seq_tab_compl,
						nr_doc_analitico,
                        nr_seq_proj_rec)
					values (nr_lote_contabil_p,
						nr_sequencia_w,
						coalesce(cd_conta_deb_pls_w,cd_conta_rec_pls_w),
						CASE WHEN coalesce(cd_conta_deb_pls_w::text, '') = '' THEN  'C'  ELSE 'D' END ,
						cd_historico_pls_w,
						dt_movimento_w,
						vl_transacao_w,
						null,
						nr_seq_agrupamento_w,
						null,
						ds_compl_historico_w,
						nr_seq_trans_fin_w,
						null,
						cd_pessoa_fisica_w,
						cd_cgc_w,
						'N',
						ie_origem_documento_w,
						nr_seq_info_ctb_w,
						nm_tabela_w,
						nm_atributo_ww,
						nr_seq_tab_orig_w,
						nr_seq_tab_compl_w,
						nr_doc_analitico_w,
                        nr_seq_proj_rec_w);
					exception
					when OTHERS then
						ds_erro_w	:= sqlerrm(SQLSTATE);
						CALL wheb_mensagem_pck.exibir_mensagem_abort(185971,
										'CD_CONTA='	|| cd_conta_deb_pls_w		||';'||
										'NR_TITULO='	|| nr_titulo_w			||';'||
										'NR_SEQ_MOVTO='	|| nr_sequencia_w		||';'||
										'NR_SEQ_TRANS='	|| nr_seq_movto_trans_fin_w	||';'||
										'VL_MOVIMENTO='	|| vl_transacao_w		||';'||
										'DS_ERRO='	|| ds_erro_w);
					end;
				else
				
					nr_contador_w := nr_contador_w + 1;
				
					update	pls_titulo_rec_liq_mens
					set	nr_lote_contabil 	= 0
					where	nr_sequencia 		= nr_seq_liq_cc_w
					and	nr_titulo		= nr_titulo_w
					and	nr_seq_baixa		= nr_seq_baixa_w;
					
					if (mod(nr_contador_w,1000) = 0) then
						commit;
					end if;	
					
				end if;	
			end if;
		else
			if (ie_permite_estab_dif_w <> 'PCCT') then
				cd_estab_titulo_w	:= null;
			end if;
			
			if (nm_atributo_w = 'VL_DESCONTOS') and (ie_origem_tit_rec_w = 3) then
				
				select	max(a.ie_segmentacao)
				into STRICT	ie_segmentacao_w
				from	pls_plano a,
					pls_segurado b,
					pls_mensalidade_segurado c,
					pls_mensalidade d,
					titulo_receber e
				where	a.nr_sequencia	= b.nr_seq_plano
				and	b.nr_sequencia	= c.nr_seq_segurado
				and	d.nr_sequencia	= c.nr_seq_mensalidade
				and	d.nr_sequencia	= e.nr_seq_mensalidade
				and	e.nr_titulo	= nr_titulo_w;
				
				select	max(c.cd_conta_contabil)
				into STRICT	cd_conta_codificacao_w
				from	pls_contab_versao a,
					pls_contab_codificacao b,
					pls_contab_codific_item c
				where	a.nr_sequencia		= b.nr_seq_versao_contab
				and	b.nr_sequencia		= c.nr_seq_codificacao
				and	dt_contabil_w between a.dt_inicio_vigencia and coalesce(a.dt_fim_vigencia,dt_contabil_w)
				and	b.ie_codificacao	= 'PO'
				and	c.ie_tipo_produto	= CASE WHEN ie_segmentacao_w='4' THEN 'OD'  ELSE 'PS' END;
				
				select	count(*)
				into STRICT	qt_conta_contabil_w
				from	conta_contabil
				where	cd_conta_contabil	= cd_conta_codificacao_w;
				
				if (qt_conta_contabil_w > 0) then
					cd_conta_contabil_w	:= cd_conta_codificacao_w;
				end if;
			end if;
			
			nr_sequencia_w := gerar_contab_trans_financ(	cd_estabelecimento_w, cd_estab_titulo_w, nr_lote_contabil_p, nm_usuario_p, cd_conta_contabil_w, cd_centro_custo_w, null, nr_seq_agrupamento_w, dt_movimento_w, vl_transacao_w, nr_seq_trans_fin_w, nr_seq_conta_banco_w, nm_atributo_w, cd_pessoa_fisica_w, cd_cgc_w, 0, cd_convenio_w, nr_documento_ww, null, ds_conteudo_w, nr_seq_caixa_w, nr_seq_produto_w, nr_seq_caixa_od_w, null, null, nr_seq_bandeira_cartao_w, null, ie_origem_tit_rec_w, null, ie_tipo_conta_glosa_w, null, null, null, cd_tipo_recebimento_w, nr_sequencia_w, nm_tabela_w, nr_titulo_w, null, ie_origem_documento_w, nr_seq_tab_orig_w, nr_seq_tab_compl_w, nr_seq_info_ctb_w, null, nr_doc_analitico_w);
			
			if (ie_permite_estab_dif_w = 'PCCT') and (coalesce(cd_estab_titulo_w,0) <> 0) and (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') and (cd_conta_transitoria_w IS NOT NULL AND cd_conta_transitoria_w::text <> '') and (cd_estab_titulo_w <> cd_estabelecimento_w) then
					nr_lote_contabil_p := ctb_gerar_movto_conta_transit(	nr_lote_contabil_p, cd_estabelecimento_w, cd_conta_transitoria_w, cd_historico_ct_w);

				
					nr_lote_contabil_p := ctb_gerar_movto_conta_transit(	nr_lote_contabil_p, cd_estab_titulo_w, cd_conta_transitoria_w, cd_historico_ct_w);

			end if;
		end if;
		
		nr_titulo_ant_w	:= nr_titulo_w;
		end;
	end loop;
	close C01;
	
	CALL agrupa_movimento_contabil(nr_lote_contabil_p, nm_usuario_p);
end if;

if (coalesce(ds_retorno_p::text, '') = '') then
	update lote_contabil
	set	ie_situacao		= 'A',
		dt_geracao_lote		= CASE WHEN ie_exclusao_p='N' THEN clock_timestamp() WHEN ie_exclusao_p='S' THEN null END
	where	nr_lote_contabil	= nr_lote_contabil_p;
	
	if (ie_exclusao_p = 'S') then
		ds_retorno_p	:= wheb_mensagem_pck.get_texto(165188);
		
		CALL ctb_gravar_log_lote(	nr_lote_contabil_p,
					2,
					'',
					nm_usuario_p);
	else
		ds_retorno_p	:= wheb_mensagem_pck.get_texto(165187);

		CALL ctb_gravar_log_lote(	nr_lote_contabil_p,
					1,
					wheb_mensagem_pck.get_texto(1097175),
					nm_usuario_p);
	end if;
	
	commit;
else
	rollback;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_contabiliza_baixa_mens ( nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text) FROM PUBLIC;

