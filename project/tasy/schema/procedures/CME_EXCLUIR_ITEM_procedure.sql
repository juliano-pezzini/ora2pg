-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cme_excluir_item ( ds_item_p text, ds_lista_p INOUT text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_item_w	bigint;
qt_apelido_w	bigint;
qt_fabric_w		bigint;
qt_conj_item_w	bigint;
nr_seq_cme_w	bigint;
nm_item_w		varchar(255);
qt_existe_w		bigint;
ds_conjunto_w	varchar(2000);
ds_lista_cme_w	varchar(2000);
ds_conj_cme_w	varchar(2000);
ds_conj_cme_ww	varchar(2000);
nr_sequencia_conjunto_w cm_conjunto_cont.nr_sequencia%type;
ds_mensagem_w   log_exclusao.ds_chave_longo%type;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	cm_item
	where	' ' || ds_item_p || ' ' like '% ' || nr_sequencia || ' %'
	order by	nr_sequencia;
	
C02 CURSOR FOR
	SELECT	b.nr_sequencia
	from	cm_conjunto_cont b,
		cm_item_cont a
	where	a.nr_seq_conjunto	= b.nr_sequencia
	and	a.nr_seq_item	= nr_seq_item_w
	and	coalesce(b.ie_situacao,'A') = 'A'
	order by	b.nr_sequencia;

C03 CURSOR FOR
	SELECT (substr(WHEB_MENSAGEM_PCK.get_texto(1205585) || ' ' || nr_seq_conjunto || ' - ' ||
		    cme_obter_nome_conjunto(nr_seq_conjunto) || ' - ' || WHEB_MENSAGEM_PCK.get_texto(1205584) || nr_seq_controle,1,200))
	from	cm_conjunto_cont
	where	' ' || ds_lista_cme_w || ' ' like '% ' || nr_sequencia || ' %'
	and	coalesce(ie_situacao,'A') = 'A'
	order by	nr_sequencia;

C04 CURSOR FOR
    SELECT  nr_sequencia
    from    cm_conjunto_cont
    where   nr_seq_item = nr_seq_item_w
    order   by nr_sequencia;


BEGIN

ds_conjunto_w	:= '';
ds_lista_cme_w	:= '';
ds_conj_cme_w	:= '';
ds_conj_cme_ww	:= '';

open C01;
loop
fetch C01 into
	nr_seq_item_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	/* Verificar os conjuntos que o item esta vinculado e que ja foram gerados no CME */

	open C02;
	loop
	fetch C02 into
		nr_seq_cme_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		/* Se o item possuir vinculo com o conjunto no cme entrara na lista de consistancias nao sendo excluido */

		if (nr_seq_cme_w IS NOT NULL AND nr_seq_cme_w::text <> '') then
			begin
			ds_lista_cme_w	:= nr_seq_cme_w || ' ' || ds_lista_cme_w;
			end;
		end if;
		end;
	end loop;
	close C02;

    open C04;
    loop
    fetch C04 into
        nr_sequencia_conjunto_w;
    EXIT WHEN NOT FOUND; /* apply on C04 */
        begin
        if (nr_sequencia_conjunto_w IS NOT NULL AND nr_sequencia_conjunto_w::text <> '') then
            begin
            ds_lista_cme_w := substr(nr_sequencia_conjunto_w || ' ' || ds_lista_cme_w,1,2000);
            end;
        end if;
        end;
    end loop;
    close C04;

	select	nm_item
	into STRICT	nm_item_w
	from	cm_item
	where	nr_sequencia = nr_seq_item_w;
	
	/* Verifica se possui vinculo */

	if (coalesce(ds_lista_cme_w::text, '') = '') then
		begin

        delete from cm_item_anexo           where nr_seq_item = nr_seq_item_w;
        delete from cm_item_especialidade   where nr_seq_item = nr_seq_item_w;
        delete from cm_imagem_item          where nr_seq_item = nr_seq_item_w;

		/* Obter se o item possui algum apelido */

		select	count(*)
		into STRICT	qt_apelido_w
		from	cm_item_apelido
		where	nr_seq_item = nr_seq_item_w;
	
		/* Se o item possuir algum apelido - excluimos */

		if (qt_apelido_w > 0) then
			delete from cm_item_apelido where nr_seq_item = nr_seq_item_w;
		end if;
	
		/* Obter se o item possui algum fabricante */

		select	count(*)
		into STRICT	qt_fabric_w
		from	cm_item_fabric
		where	nr_seq_item = nr_seq_item_w;
	
		/* Se o item possuir algum fabricante - excluimos */

		if (qt_fabric_w > 0) then
			delete from cm_item_fabric where nr_seq_item = nr_seq_item_w;
		end if;
	
		/* Obter se o item possui vinculo com algum conjunto */

		select	count(*)
		into STRICT	qt_conj_item_w
		from	cm_conjunto_item
		where	nr_seq_item = nr_seq_item_w;
	
		/* Se o item possui vinculo com algum conjunto - excluimos */

		if (qt_conj_item_w > 0) then
			delete from cm_conjunto_item where nr_seq_item = nr_seq_item_w;
		end if;

		/* Se o item nao possuir mais nenhum vinculo e excluido */

		delete from cm_item where nr_sequencia = nr_seq_item_w;

		select	count(*)
		into STRICT	qt_existe_w
		from	cm_item
		where	nr_sequencia = nr_seq_item_w;

        ds_mensagem_w := substr(WHEB_MENSAGEM_PCK.get_texto(nr_seq_mensagem_p => 1205624,
                                                    Vl_Macros_P        => 'NR_SEQ_ITEM= ' || nr_seq_item_w || ';NM_ITEM= '|| nm_item_w),1,255);

        if (qt_existe_w = 0) then
            CALL gravar_log_exclusao(nm_tabela_p     		=> 'CM_ITEM',
                                nm_usuario_p     		=> nm_usuario_p,
                                ds_chave_p       		=> ds_mensagem_w,
                                ie_executar_commit_p 	=> 'S');
        end if;
		end;
	elsif (ds_lista_cme_w IS NOT NULL AND ds_lista_cme_w::text <> '') then
		begin

		/* Obter o conjunto que esta vinculado o item no CME */

		open C03;
		loop
		fetch C03 into
			ds_conjunto_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			ds_conj_cme_w	:= substr(ds_conjunto_w || ', ' || ds_conj_cme_w,1,2000);
			end;
		end loop;
		close C03;
		
		select	substr(ds_conj_cme_w, 1, length(ds_conj_cme_w) -2)
		into STRICT	ds_conj_cme_ww
		;
        ds_lista_p	:= substr(WHEB_MENSAGEM_PCK.get_texto(nr_seq_mensagem_p => 1205625,
												Vl_Macros_P => 'NR_SEQ_ITEM= ' || nr_seq_item_w || ';NM_ITEM=  '|| nm_item_w  ||
												';NR_SEQ_CONJ_CONT= ' || ds_conj_cme_ww),1,255);
		end;
	end if;
	
	ds_conjunto_w	:= '';
	ds_lista_cme_w	:= '';
	ds_conj_cme_w	:= '';
	ds_conj_cme_ww	:= '';
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cme_excluir_item ( ds_item_p text, ds_lista_p INOUT text, nm_usuario_p text) FROM PUBLIC;

