-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_evento_diag_sae (nr_seq_prescr_p bigint, nm_usuario_p text) AS $body$
DECLARE


c01 CURSOR FOR
	SELECT b.nr_seq_evento
	from   pe_prescr_diag a, pe_diagnostico_evento b
	where  nr_seq_prescr = nr_seq_prescr_p
	and    a.nr_seq_diag = b.nr_seq_diag
	and    coalesce(b.ie_gera_evento,'N') = 'S';
	
cd_setor_atendimento_w integer;
nr_sequencia_w     bigint;
nr_atendimento_w   bigint;
cd_pessoa_fisica_w varchar(10);
cd_prescritor_w    varchar(10);
ds_evento_w		   varchar(4000);
nr_seq_texto_w     bigint;
ds_texto_w         text;
cd_estab_w         bigint;

BEGIN

if (nr_seq_prescr_p > 0) then

	select max(nr_atendimento), max(cd_prescritor), max(cd_setor_atendimento)
	into STRICT   nr_atendimento_w, cd_prescritor_w, cd_setor_atendimento_w
	from   pe_prescricao
	where  nr_sequencia = nr_seq_prescr_p;
	
	cd_pessoa_fisica_w := obter_pessoa_atendimento(nr_atendimento_w, 'C');
	cd_estab_w := obter_estabelecimento_ativo;

	for evento in c01 loop
	
		ds_evento_w := substr(obter_texto_tasy(263704, wheb_usuario_pck.get_nr_seq_idioma),1,4000);
		
		ds_evento_w := ds_evento_w || chr(10) || chr(13) || obter_desc_expressao(287694) ||': '||substr(Obter_Desc_Quali_Evento(evento.nr_seq_evento),1,255);
				
		Select  nextval('qua_evento_paciente_seq')
		into STRICT	nr_sequencia_w
		;

		insert into qua_evento_paciente(	nr_sequencia,
						nr_seq_evento,
						ds_evento,
						nr_atendimento,
						cd_pessoa_fisica,
						cd_profissional,
						nm_usuario,
						nm_usuario_origem,
						nm_usuario_nrec,
						nm_usuario_reg,
						cd_estabelecimento,
						cd_setor_atendimento,
						dt_atualizacao,
						dt_atualizacao_nrec,
						dt_cadastro,
						dt_evento,
						ie_situacao,
						dt_liberacao,
						nr_seq_sae,
						ie_status,
						ie_origem,
						cd_funcao_ativa)
			values (	nr_sequencia_w,
						evento.nr_seq_evento,
						ds_evento_w,
						nr_atendimento_w,
						cd_pessoa_fisica_w,
						cd_prescritor_w,
						nm_usuario_p,
						nm_usuario_p,
						nm_usuario_p,
						nm_usuario_p,
						cd_estab_w,
						cd_setor_atendimento_w,
						clock_timestamp(),
						clock_timestamp(),
						clock_timestamp(),
						clock_timestamp(),
						'A',
						clock_timestamp(),
						nr_seq_prescr_p,
						1,
						'S',
						obter_funcao_ativa);

		commit;
		
	end loop;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_evento_diag_sae (nr_seq_prescr_p bigint, nm_usuario_p text) FROM PUBLIC;

