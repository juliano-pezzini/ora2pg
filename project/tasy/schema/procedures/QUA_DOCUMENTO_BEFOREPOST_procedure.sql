-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qua_documento_beforepost ( nm_usuario_p text, nr_seq_tipo_p text, cd_documento_p text, nr_sequencia_p bigint, cd_estabelecimento_p text, cd_setor_atendimento_p bigint, nr_seq_loc_p bigint, ie_novo_registro_p text, ie_modo_edicao_p text, ie_status_old_p text, ie_status_p text, dt_solic_treinamento_p text, dt_elaboracao_p text, dt_elaboracao_old_p text, dt_validacao_p text, dt_validacao_old_p text, ie_situacao_p text, ie_situacao_old_p text, cd_pessoa_fisica_p text, cd_doc_p INOUT text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [ X ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
-------------------------------------------------------------------------------------------------------------------
Referências:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ie_gera_cod_doc_w	 	varchar(255);
ie_format_cod_doc_w	 	varchar(255);
ie_alterar_status_w		varchar(255);
qtd_w			 	integer;
qt_reg_w			integer;
ie_situacao_w			varchar(50);
qt_doc_treinamento_w		integer;
qt_tipo_doc_inat_w		integer;
qt_inat_pessoa_w		integer;


BEGIN
ie_gera_cod_doc_w := obter_param_usuario(4000, 240, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_gera_cod_doc_w);
ie_format_cod_doc_w := obter_param_usuario(4000, 241, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_format_cod_doc_w);
ie_alterar_status_w := obter_param_usuario(4000, 80, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_alterar_status_w);

select	count(*) qtd
into STRICT    qtd_w
from	qua_documento
where	nr_sequencia <> nr_sequencia_p
and	cd_documento = cd_documento_p
and	cd_estabelecimento = cd_estabelecimento_p;

if (upper(ie_gera_cod_doc_w) <> 'N'
	And upper(ie_gera_cod_doc_w) <> 'D'
	and (ie_gera_cod_doc_w IS NOT NULL AND ie_gera_cod_doc_w::text <> '')
	and (nr_seq_tipo_p IS NOT NULL AND nr_seq_tipo_p::text <> '')
	and (cd_documento_p IS NOT NULL AND cd_documento_p::text <> '')
	and qtd_w > 0) then

	select	qua_obter_codigo_doc_param(nr_seq_tipo_p, cd_estabelecimento_p, nm_usuario_p, nr_sequencia_p, cd_setor_atendimento_p, nr_seq_loc_p)
	into STRICT	cd_doc_p
	;
end if;

select (select	count(*)
	from	qua_documento
	where	cd_estabelecimento = cd_estabelecimento_p
	and	cd_documento = cd_documento_p) qt_reg,
	(select ie_situacao
	from 	qua_tipo_doc
	where 	nr_sequencia = nr_seq_tipo_p) ie_situacao
	into STRICT    qt_reg_w,
		ie_situacao_w
	;

if (ie_novo_registro_p = '1'
	and qt_reg_w > 0) then
	--já existe um documento com este código para este estabelecimento.
	CALL wheb_mensagem_pck.exibir_mensagem_abort(189864,null);
	goto final;
end if;

if (ie_status_p = 'T'
	and (ie_novo_registro_p = '1'
	or ie_modo_edicao_p = '1'
	and ie_status_p <> ie_status_old_p)) then
	-- não é permitido informar este status, deve ser utilizada a opção ''solicitar treinamento''!
	CALL wheb_mensagem_pck.exibir_mensagem_abort(269230,null);
	goto final;
end if;

if (ie_modo_edicao_p = '1'
	and ie_status_old_p = 'T'
	and ie_status_p <> ie_status_old_p) then

	select	count(*) qt_doc_treinamento
	into STRICT    qt_doc_treinamento_w
	from	qua_doc_treinamento
	where 	dt_liberacao >= to_char(dt_solic_treinamento_p, 'DD/MM/YYYY HH:MI:SS')
	and	nr_seq_documento = nr_seq_loc_p;

	if (qt_doc_treinamento_w = 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(269234,null);
	end if;

	goto final;
end if;

if (ie_situacao_w = 'I') then
	--tipo de documento inativo
	CALL wheb_mensagem_pck.exibir_mensagem_abort(189865,null);
	goto final;
end if;

if (ie_modo_edicao_p = '1'
	and (dt_elaboracao_p IS NOT NULL AND dt_elaboracao_p::text <> '')
	and coalesce(dt_elaboracao_old_p::text, '') = '') then
	CALL qua_gerar_envio_comunicacao(	nr_sequencia_p,
					'0',
					nm_usuario_p,
					'8',
					cd_estabelecimento_p,
					0,
					0,
					'N');
end if;

if (ie_modo_edicao_p = '1'
	and (dt_validacao_p IS NOT NULL AND dt_validacao_p::text <> '')
	and coalesce(dt_validacao_old_p::text, '') = '') then
	CALL qua_gerar_envio_comunicacao(	nr_sequencia_p,
					'0',
					nm_usuario_p,
					'9',
					cd_estabelecimento_p,
					0,
					0,
					'N');
end if;

if (ie_modo_edicao_p = '1'
	and ie_situacao_p = 'I'
	and ie_situacao_p <> ie_situacao_old_p) then
	select (select count(*)
		from	qua_tipo_doc_inativ
		where	nr_seq_tipo_doc = nr_seq_tipo_p) qt_tipo_doc_inat,
		(select count(*)
		from	qua_tipo_doc_inativ
		where	nr_seq_tipo_doc	= nr_seq_tipo_p
		and	cd_pessoa_fisica = cd_pessoa_fisica_p) qt_inat_pessoa
	into STRICT	qt_tipo_doc_inat_w,
		qt_inat_pessoa_w
	;

	if (qt_tipo_doc_inat_w > 0
		and qt_inat_pessoa_w = 0) then
		--usuário sem permissão para inativar um documento deste tipo. verifique o cadastro do tipo de documento (pasta inativação).
		CALL wheb_mensagem_pck.exibir_mensagem_abort(189880,null);
		goto final;
	end if;

	CALL qua_gerar_envio_comunicacao(	nr_sequencia_p,
					'0',
					nm_usuario_p,
					'14',
					cd_estabelecimento_p,
					0,
					0,
					'N');
end if;

if (ie_modo_edicao_p = '1'
	and ie_status_p = 'D'
	and ie_situacao_p <> ie_situacao_old_p) then
	CALL qua_gerar_envio_comunicacao(	nr_sequencia_p,
					'0',
					nm_usuario_p,
					'19',
					cd_estabelecimento_p,
					0,
					0,
					'N');
end if;

if (upper(ie_alterar_status_w) = 'S'
	and ie_status_p = 'I'
	and ie_status_p <> ie_status_old_p) then
	CALL qua_gerar_envio_comunicacao(	nr_sequencia_p,
					'0',
					nm_usuario_p,
					'29',
					cd_estabelecimento_p,
					0,
					0,
					'N');
end if;

<<final>>

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qua_documento_beforepost ( nm_usuario_p text, nr_seq_tipo_p text, cd_documento_p text, nr_sequencia_p bigint, cd_estabelecimento_p text, cd_setor_atendimento_p bigint, nr_seq_loc_p bigint, ie_novo_registro_p text, ie_modo_edicao_p text, ie_status_old_p text, ie_status_p text, dt_solic_treinamento_p text, dt_elaboracao_p text, dt_elaboracao_old_p text, dt_validacao_p text, dt_validacao_old_p text, ie_situacao_p text, ie_situacao_old_p text, cd_pessoa_fisica_p text, cd_doc_p INOUT text) FROM PUBLIC;

