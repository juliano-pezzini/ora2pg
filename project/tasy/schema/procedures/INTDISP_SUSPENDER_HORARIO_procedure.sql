-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE intdisp_suspender_horario (nr_atendimento_p bigint, nr_prescricao_p bigint, ie_tipo_evento_p text, nm_usuario_p text) AS $body$
DECLARE


cd_setor_atendimento_w	setor_atendimento.cd_setor_atendimento%type;
ie_gerar_kit_w			setor_atendimento.ie_gerar_kit%type;
qt_existe_regra_w		bigint;


BEGIN

if (ie_tipo_evento_p = 'M') then

	cd_setor_atendimento_w := obter_setor_atendimento(nr_atendimento_p);

	select	coalesce(max(ie_gerar_kit), 'S')
	into STRICT	ie_gerar_kit_w
	from	setor_atendimento
	where	cd_setor_atendimento = cd_setor_atendimento_w;
	
	if (ie_gerar_kit_w = 'N') then
		
		update	prescr_mat_hor a
		set		dt_suspensao = clock_timestamp(),
			nm_usuario_susp = nm_usuario_p
		where	(a.nr_seq_superior IS NOT NULL AND a.nr_seq_superior::text <> '')
		and		a.nr_prescricao = nr_prescricao_p
		and	((coalesce(a.nr_seq_processo::text, '') = '') or exists (	SELECT	1
											from	adep_processo x
											where	x.nr_sequencia = a.nr_seq_processo
											and		x.ie_status_processo = 'G'))
		and	not exists (select	1
						from	prescr_material y
						where	y.nr_prescricao = a.nr_prescricao
						and		y.nr_sequencia = a.nr_seq_material
						and		y.nr_prescricao = nr_prescricao_p
						and		(y.nr_sequencia_diluicao IS NOT NULL AND y.nr_sequencia_diluicao::text <> ''))
		and	not exists (select	1 
						from	ap_lote b
						where	b.nr_prescricao = a.nr_prescricao
						and 	b.nr_sequencia = a.nr_seq_lote
						and		b.nr_prescricao = nr_prescricao_p
						and		b.ie_status_lote = 'G');
	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE intdisp_suspender_horario (nr_atendimento_p bigint, nr_prescricao_p bigint, ie_tipo_evento_p text, nm_usuario_p text) FROM PUBLIC;

