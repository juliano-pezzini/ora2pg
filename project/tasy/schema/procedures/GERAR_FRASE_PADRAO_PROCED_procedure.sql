-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_frase_padrao_proced ( nr_sequencia_p bigint, nr_prescricao_p bigint, cd_perfil_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_medico_w		varchar(10);		
cd_procedimento_w	bigint;
nr_seq_proc_interno_w	bigint;
ie_origem_proced_w	bigint;
ds_texto_w		varchar(2000);
					
c01 CURSOR FOR 
SELECT	substr(ds_texto, 1, 2000) 
from	frase_padrao_prescr 
where	cd_estabelecimento		= cd_estabelecimento_p 
and	coalesce(cd_perfil,cd_perfil_p)	= cd_perfil_p 
and (coalesce(cd_especialidade::text, '') = '' or 
	obter_se_especialidade_medico(cd_especialidade, cd_medico_w) = 'S') 
and	coalesce(cd_procedimento,cd_procedimento_w) 		= cd_procedimento_w 
and	coalesce(nr_seq_proc_interno,nr_seq_proc_interno_w)	= nr_seq_proc_interno_w 
and	coalesce(ie_origem_proced, ie_origem_proced_w)	= ie_origem_proced_w 
and	coalesce(ie_situacao,'A')		= 'A' 
order by coalesce(cd_perfil,99999) desc, 
	 coalesce(nr_seq_proc_interno, 9999999999) desc,		 
	 coalesce(cd_procedimento,999999999999999) desc, 
	 coalesce(ie_origem_proced,9) desc, 
	 coalesce(cd_especialidade, 99999999) desc;
			

BEGIN 
 
select	max(cd_pessoa_fisica) 
into STRICT	cd_medico_w 
from	usuario 
where	nm_usuario = nm_usuario_p 
and	ie_situacao = 'A';
 
select	coalesce(max(cd_procedimento),0), 
	coalesce(max(nr_seq_proc_interno),0), 
	coalesce(max(ie_origem_proced),0) 
into STRICT	cd_procedimento_w, 
	nr_seq_proc_interno_w, 
	ie_origem_proced_w 
from	prescr_procedimento 
where	nr_prescricao = nr_prescricao_p 
and	nr_sequencia = nr_sequencia_p;
 
open C01;
loop 
fetch C01 into	 
	ds_texto_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	ds_texto_w := ds_texto_w;
end loop;
close C01;
 
if (ds_texto_w IS NOT NULL AND ds_texto_w::text <> '') then 
	update	prescr_procedimento 
	set	ds_dado_clinico = ds_texto_w 
	where	nr_sequencia = nr_sequencia_p 
	and	nr_prescricao = nr_prescricao_p 
	and 	coalesce(ds_dado_clinico::text, '') = '';
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_frase_padrao_proced ( nr_sequencia_p bigint, nr_prescricao_p bigint, cd_perfil_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

