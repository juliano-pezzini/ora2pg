-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE valida_estoque ( cd_material_p bigint, qt_material_p bigint, qt_cabine_p bigint, cd_local_estoque_p bigint, ie_cons_lote_fornec_p boolean, nr_seq_lote_p bigint, cd_unid_medida_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


qt_conv_estoque_consumo_w	double precision;
qt_saldo_disp_estoque_w		double precision;
cd_unidade_medida_consumo_w	varchar(30);
qt_cabine_w			bigint;


BEGIN

select	qt_conv_estoque_consumo
into STRICT	qt_conv_estoque_consumo_w
from	material
where	cd_material	= cd_material_p;

select	substr(obter_dados_material_estab(cd_material_p,cd_estabelecimento_p,'UMS'),1,30)
into STRICT	cd_unidade_medida_consumo_w
;

qt_cabine_w	:= qt_cabine_p;

if (not ie_cons_lote_fornec_p) then
	select	coalesce(obter_saldo_disp_estoque(
		cd_estabelecimento_p,
		cd_material_p,
		cd_local_estoque_p,
		trunc(clock_timestamp(), 'mm')),0)
	into STRICT	qt_saldo_disp_estoque_w
	;

elsif (ie_cons_lote_fornec_p) then
	begin

	select 	coalesce(obter_saldo_estoque_lote(
		cd_estabelecimento_p,
		cd_material_p,
		cd_local_estoque_p,
		trunc(clock_timestamp(), 'mm'),
		nr_seq_lote_p),0)
	into STRICT	qt_saldo_disp_estoque_w
	;

	select	obter_quantidade_convertida(
		cd_material_p,
		(qt_cabine_p + qt_material_p),
		cd_unid_medida_p,
		'UME')
	into STRICT	qt_cabine_w
	;

	end;
end if;


if	(((cd_unidade_medida_consumo_w <> cd_unid_medida_p) and
	 (qt_saldo_disp_estoque_w - (coalesce(qt_cabine_w,qt_cabine_p) / qt_conv_estoque_consumo_w)) < (qt_material_p / qt_conv_estoque_consumo_w)) or
	((cd_unidade_medida_consumo_w = cd_unid_medida_p) and (qt_saldo_disp_estoque_w < coalesce(qt_cabine_w,qt_cabine_p)) and (ie_cons_lote_fornec_p))) then
	---Quantidade solicitada Ã© menor que a quantidade em estoque!
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(58577);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE valida_estoque ( cd_material_p bigint, qt_material_p bigint, qt_cabine_p bigint, cd_local_estoque_p bigint, ie_cons_lote_fornec_p boolean, nr_seq_lote_p bigint, cd_unid_medida_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

