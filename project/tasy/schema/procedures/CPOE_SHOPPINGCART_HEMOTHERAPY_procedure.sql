-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_shoppingcart_hemotherapy (nr_sequencia_p bigint, ie_retrogrado_p text, ds_retorno_p INOUT text) AS $body$
DECLARE


ie_return_value_w varchar(1) := 'N';
nr_return_value_w	bigint;
qt_count_w	bigint;
active_ingred_consist_w varchar(255);

ie_continuo_w	varchar(1) := 'N';
ds_alergia_w	varchar(4000);
ie_severidade_w	paciente_alergia.ie_intensidade%type;
nr_seq_reacao_w	paciente_alergia.nr_seq_reacao%type;
nr_seq_ficha_tecnica_w	paciente_alergia.nr_seq_ficha_tecnica%type;

ie_obriga_hemoglobina_w	san_derivado.ie_hemoglobina%type;
ie_obriga_hematocrito_w	san_derivado.ie_hematocrito%type;
ie_obriga_plaquetas_w	san_derivado.ie_plaquetas%type;
ie_obriga_tap_w	san_derivado.ie_tap%type;
ie_obriga_inr_w	san_derivado.ie_inr%type;
ie_obriga_fibrinogenio_w	san_derivado.ie_fibrinogenio%type;
ie_obriga_ambos_w	san_derivado.ie_obriga_ambos%type;
ie_obriga_albumina_w	san_derivado.ie_obriga_albumina%type;
ie_obriga_calcio_w	san_derivado.ie_obriga_calcio%type;
ie_obriga_magnesio_w	san_derivado.ie_obriga_magnesio%type;
ie_obriga_bili_dir_w	san_derivado.ie_obriga_bili_dir%type;
ie_obriga_bili_ind_w	san_derivado.ie_obriga_bili_ind%type;
ie_obriga_hemoglobina_s_w	san_derivado.ie_obriga_hemoglobina_s%type;
ie_obriga_coombs_w	san_derivado.ie_obriga_coombs%type;
ie_obriga_coagulopatia_w	san_derivado.ie_obriga_coagulopatia%type;
ie_obriga_ttpa_w	san_derivado.ie_obriga_ttpa%type;

ie_visible_hemoglobina_w	san_derivado_dados_lab.ie_hemoglobina%type;
ie_visible_hematocrito_w	san_derivado_dados_lab.ie_hematocrito%type;
ie_visible_plaqueta_w	san_derivado_dados_lab.ie_plaqueta%type;
ie_visible_tap_w	san_derivado_dados_lab.ie_tap%type;
ie_visible_tap_inr_w	san_derivado_dados_lab.ie_tap_inr%type;
ie_visible_ttpa_w	san_derivado_dados_lab.ie_ttpa%type;
ie_visible_ttpa_rel_w	san_derivado_dados_lab.ie_ttpa_rel%type;
ie_visible_fibrinogenio_w	san_derivado_dados_lab.ie_fibrinogenio%type;
ie_visible_albumina_w	san_derivado_dados_lab.ie_albumina%type;
ie_visible_calcio_w	san_derivado_dados_lab.ie_calcio%type;
ie_visible_magnesio_w	san_derivado_dados_lab.ie_magnesio%type;
ie_visible_bilirrubina_dir_w	san_derivado_dados_lab.ie_bilirrubina_dir%type;
ie_visible_bilirrubina_ind_w	san_derivado_dados_lab.ie_bilirrubina_ind%type;
ie_visible_hemoglobina_s_w	san_derivado_dados_lab.ie_hemoglobina_s%type;
ie_visible_leucocitos_w	san_derivado_dados_lab.ie_leucocitos%type;
ie_visible_coombs_direto_w	san_derivado_dados_lab.ie_coombs_direto%type;
ie_visible_coagulopatia_w	san_derivado_dados_lab.ie_coagulopatia%type;

c01 CURSOR FOR
SELECT  a.*,  obter_setor_atendimento(nr_atendimento) cd_setor_atend
from 	cpoe_hemoterapia a
where	nr_sequencia = nr_sequencia_p;

BEGIN
ds_retorno_p := 'S';
if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then
	for r_c01_w in C01
	loop	
		--FIM CAMPOS OBRIGATORIOS
		if (coalesce(r_c01_w.cd_doenca_cid::text, '') = '' or coalesce(r_c01_w.ie_tipo_paciente::text, '') = '' or coalesce(r_c01_w.ie_tipo::text, '') = '' or  coalesce(r_c01_w.dt_programada::text, '') = ''
			or coalesce(r_c01_w.ie_trans_anterior::text, '') = '') then
			ds_retorno_p := 'N';
			goto return_value;
		end if;

		if (r_c01_w.ie_tipo_hemoterap = 0) then
			if (coalesce(r_c01_w.nr_seq_derivado::text, '') = '' or coalesce(r_c01_w.ie_via_aplicacao::text, '') = '' or coalesce(r_c01_w.nr_seq_indicacao1::text, '') = '' or coalesce(r_c01_w.ie_reserva::text, '') = '') then
				ds_retorno_p := 'N';
				goto return_value;
			end if;

			if (r_c01_w.nr_seq_derivado IS NOT NULL AND r_c01_w.nr_seq_derivado::text <> '') then
				select	count(*)
				into STRICT	qt_count_w
				from	intervalo_san_derivado
				where	nr_seq_derivado = r_c01_w.nr_seq_derivado;

				if (qt_count_w > 0 and coalesce(r_c01_w.cd_intervalo::text, '') = '') then
					ds_retorno_p := 'N';
					goto return_value;
				end if;
			end if;
		elsif (r_c01_w.ie_tipo_hemoterap = 1) then
			if (coalesce(r_c01_w.nr_seq_proc_interno::text, '') = '' or coalesce(r_c01_w.cd_intervalo::text, '') = '') then
				ds_retorno_p := 'N';
				goto return_value;
			end if;
		end if;
		--FIM CAMPOS OBRIGATORIOS

		--OPEN DETAIL
		if (obter_sexo_pf(r_c01_w.cd_pessoa_fisica, 'C') = 'F' and coalesce(r_c01_w.ie_gravidez::text, '') = '') then
			ds_retorno_p := 'N';
			goto return_value;
		end if;

		if ((coalesce(cpoe_obter_se_obriga_campo_hm(r_c01_w.nr_atendimento, r_c01_w.cd_pessoa_fisica), 'N') in ('N', 'Q') and coalesce(r_c01_w.qt_procedimento::text, '') = '')
			or (coalesce(cpoe_obter_se_obriga_campo_hm(r_c01_w.nr_atendimento, r_c01_w.cd_pessoa_fisica), 'N') = 'V' and coalesce(r_c01_w.qt_vol_hemocomp::text, '') = '')) then
			ds_retorno_p := 'N';
			goto return_value;
		end if;

		select	coalesce(max(ie_hemoglobina),'N') ie_obriga_hemoglobina,
			coalesce(max(ie_hematocrito),'N') ie_obriga_hematocrito,
			coalesce(max(ie_plaquetas),'N') ie_obriga_plaquetas,
			coalesce(max(ie_tap),'N') ie_obriga_tap,
			coalesce(max(ie_inr),'N') ie_obriga_inr,
			coalesce(max(ie_fibrinogenio),'N') ie_obriga_fibrinogenio,
			coalesce(max(ie_obriga_ambos),'N') ie_obriga_ambos,
			coalesce(max(ie_obriga_albumina),'N') ie_obriga_albumina,
			coalesce(max(ie_obriga_calcio),'N') ie_obriga_calcio,
			coalesce(max(ie_obriga_magnesio),'N') ie_obriga_magnesio,
			coalesce(max(ie_obriga_bili_dir),'N') ie_obriga_bili_dir,
			coalesce(max(ie_obriga_bili_ind),'N') ie_obriga_bili_ind,
			coalesce(max(ie_obriga_hemoglobina_s),'N') ie_obriga_hemoglobina_s,
			coalesce(max(ie_obriga_coombs),'N') ie_obriga_coombs,
			coalesce(max(ie_obriga_coagulopatia),'N') ie_obriga_coagulopatia,
			coalesce(max(ie_obriga_ttpa),'N') ie_obriga_ttpa
		into STRICT	ie_obriga_hemoglobina_w,
			ie_obriga_hematocrito_w,
			ie_obriga_plaquetas_w,
			ie_obriga_tap_w,
			ie_obriga_inr_w,
			ie_obriga_fibrinogenio_w,
			ie_obriga_ambos_w,
			ie_obriga_albumina_w,
			ie_obriga_calcio_w,
			ie_obriga_magnesio_w,
			ie_obriga_bili_dir_w,
			ie_obriga_bili_ind_w,
			ie_obriga_hemoglobina_s_w,
			ie_obriga_coombs_w,
			ie_obriga_coagulopatia_w,
			ie_obriga_ttpa_w
		from	san_derivado
		where	nr_sequencia = r_c01_w.nr_seq_derivado;

		select	count(nr_seq_derivado) qt_regra
		into STRICT	nr_return_value_w
		from	san_derivado_dados_lab
		where	nr_seq_derivado = r_c01_w.nr_seq_derivado;

		if (nr_return_value_w > 0) then
			select 	count(nr_seq_derivado) qt_regra
			into STRICT	qt_count_w
			from 	san_derivado_dados_lab
			where 	nr_seq_derivado = r_c01_w.nr_seq_derivado
			and		coalesce(ie_hemoglobina,'N') = 'N'
			and		coalesce(ie_hematocrito,'N') = 'N'
			and		coalesce(ie_plaqueta,'N') = 'N'
			and		coalesce(ie_tap,'N') = 'N'
			and		coalesce(ie_tap_inr,'N') = 'N'
			and		coalesce(ie_ttpa,'N') = 'N'
			and		coalesce(ie_ttpa_rel,'N') = 'N'
			and		coalesce(ie_fibrinogenio,'N') = 'N'
			and		coalesce(ie_albumina,'N') = 'N'
			and		coalesce(ie_calcio,'N') = 'N'
			and		coalesce(ie_magnesio,'N') = 'N'
			and		coalesce(ie_bilirrubina_dir,'N') = 'N'
			and		coalesce(ie_bilirrubina_ind,'N') = 'N'
			and		coalesce(ie_hemoglobina_s,'N') = 'N'
			and		coalesce(ie_leucocitos,'N') = 'N'
			and		coalesce(ie_coombs_direto,'N') = 'N'
			and		coalesce(ie_coagulopatia,'N') = 'N';

			if (qt_count_w > 0) then
				ie_visible_hemoglobina_w := 'N';
				ie_visible_hematocrito_w := 'N';
				ie_visible_plaqueta_w := 'N';
				ie_visible_tap_w := 'N';
				ie_visible_tap_inr_w := 'N';
				ie_visible_ttpa_w := 'N';
				ie_visible_ttpa_rel_w := 'N';
				ie_visible_fibrinogenio_w := 'N';
				ie_visible_albumina_w := 'N';
				ie_visible_calcio_w := 'N';
				ie_visible_magnesio_w := 'N';
				ie_visible_bilirrubina_dir_w := 'N';
				ie_visible_bilirrubina_ind_w := 'N';
				ie_visible_hemoglobina_s_w := 'N';
				ie_visible_leucocitos_w := 'N';
				ie_visible_coombs_direto_w := 'N';
				ie_visible_coagulopatia_w := 'N';
			else
				select 	coalesce(ie_hemoglobina,'N') ie_visible_hemoglobina,
					coalesce(ie_hematocrito,'N') ie_visible_hematocrito,
					coalesce(ie_plaqueta,'N') ie_visible_plaqueta,
					coalesce(ie_tap,'N') ie_visible_tap,
					coalesce(ie_tap_inr,'N') ie_visible_tap_inr,
					coalesce(ie_ttpa,'N') ie_visible_ttpa,
					coalesce(ie_ttpa_rel,'N') ie_visible_ttpa_rel,
					coalesce(ie_fibrinogenio,'N') ie_visible_fibrinogenio,
					coalesce(ie_albumina,'N') ie_visible_albumina,
					coalesce(ie_calcio,'N') ie_visible_calcio,
					coalesce(ie_magnesio,'N') ie_visible_magnesio,
					coalesce(ie_bilirrubina_dir,'N') ie_visible_bilirrubina_dir,
					coalesce(ie_bilirrubina_ind,'N') ie_visible_bilirrubina_ind,
					coalesce(ie_hemoglobina_s,'N') ie_visible_hemoglobina_s,
					coalesce(ie_leucocitos,'N') ie_visible_leucocitos,
					coalesce(ie_coombs_direto,'N') ie_visible_coombs_direto,
					coalesce(ie_coagulopatia,'N') ie_visible_coagulopatia
				into STRICT	ie_visible_hemoglobina_w,
					ie_visible_hematocrito_w,
					ie_visible_plaqueta_w,
					ie_visible_tap_w,
					ie_visible_tap_inr_w,
					ie_visible_ttpa_w,
					ie_visible_ttpa_rel_w,
					ie_visible_fibrinogenio_w,
					ie_visible_albumina_w,
					ie_visible_calcio_w,
					ie_visible_magnesio_w,
					ie_visible_bilirrubina_dir_w,
					ie_visible_bilirrubina_ind_w,
					ie_visible_hemoglobina_s_w,
					ie_visible_leucocitos_w,
					ie_visible_coombs_direto_w,
					ie_visible_coagulopatia_w
				from 	san_derivado_dados_lab
				where 	nr_seq_derivado = r_c01_w.nr_seq_derivado;
			end if;

			if ((coalesce(r_c01_w.qt_hemoglobina::text, '') = '' and (ie_obriga_hemoglobina_w = 'S' or (ie_obriga_ambos_w = 'S' and coalesce(r_c01_w.qt_hematocrito::text, '') = '')) and ie_visible_hemoglobina_w = 'S')
				or (coalesce(r_c01_w.qt_hematocrito::text, '') = '' and (ie_obriga_hematocrito_w = 'S' or (ie_obriga_ambos_w = 'S' and coalesce(r_c01_w.qt_hemoglobina::text, '') = '')) and ie_visible_hematocrito_w = 'S')
				or (coalesce(r_c01_w.qt_plaqueta::text, '') = '' and ie_obriga_plaquetas_w = 'S' and ie_visible_plaqueta_w = 'S')
				or (coalesce(r_c01_w.qt_tap::text, '') = '' and ie_obriga_tap_w = 'S' and ie_visible_tap_w = 'S')
				or (coalesce(r_c01_w.qt_tap_inr::text, '') = '' and ie_obriga_inr_w = 'S' and ie_visible_tap_inr_w = 'S')
				or (coalesce(r_c01_w.qt_fibrinogenio::text, '') = '' and ie_obriga_fibrinogenio_w = 'S' and ie_visible_fibrinogenio_w = 'S')
				or (coalesce(r_c01_w.qt_albumina::text, '') = '' and ie_obriga_albumina_w = 'S' and ie_visible_albumina_w = 'S')
				or (coalesce(r_c01_w.qt_calcio::text, '') = '' and ie_obriga_calcio_w = 'S' and ie_visible_calcio_w = 'S')
				or (coalesce(r_c01_w.qt_magnesio::text, '') = '' and ie_obriga_magnesio_w = 'S' and ie_visible_magnesio_w = 'S')
				or (coalesce(r_c01_w.qt_bilirrubina_dir::text, '') = '' and ie_obriga_bili_dir_w = 'S' and ie_visible_bilirrubina_dir_w = 'S')
				or (coalesce(r_c01_w.qt_bilirrubina_ind::text, '') = '' and ie_obriga_bili_ind_w = 'S' and ie_visible_bilirrubina_ind_w = 'S')
				or (coalesce(r_c01_w.qt_hemoglobina_s::text, '') = '' and ie_obriga_hemoglobina_s_w = 'S' and ie_visible_hemoglobina_s_w = 'S')
				or (coalesce(r_c01_w.ie_coombs_direto::text, '') = '' and ie_obriga_coombs_w = 'S' and ie_visible_coombs_direto_w = 'S')
				or (coalesce(r_c01_w.ds_coagulopatia::text, '') = '' and ie_obriga_coagulopatia_w = 'S' and ie_visible_coagulopatia_w = 'S')
				or (coalesce(r_c01_w.qt_ttpa::text, '') = '' and ie_obriga_ttpa_w = 'S' and ie_visible_ttpa_w = 'S')
				or (coalesce(r_c01_w.qt_ttpa_rel::text, '') = '' and ie_obriga_ttpa_w = 'S' and ie_visible_ttpa_rel_w = 'S'))then
				ds_retorno_p := 'N';
				goto return_value;
			end if;
		end if;
		--FIM OPEN DETAIL 

		--CUSTOM VALIDATOR 
		if (((r_c01_w.nr_seq_derivado IS NOT NULL AND r_c01_w.nr_seq_derivado::text <> '') and coalesce(r_c01_w.qt_procedimento,0) = 0)
				or ((r_c01_w.cd_mat_hem1 IS NOT NULL AND r_c01_w.cd_mat_hem1::text <> '') and coalesce(r_c01_w.qt_dose_hem1,0) = 0)
				or ((r_c01_w.cd_mat_hem2 IS NOT NULL AND r_c01_w.cd_mat_hem2::text <> '') and coalesce(r_c01_w.qt_dose_hem2,0) = 0)
				or ((r_c01_w.cd_mat_hem3 IS NOT NULL AND r_c01_w.cd_mat_hem3::text <> '') and coalesce(r_c01_w.qt_dose_hem3,0) = 0)
				or ((r_c01_w.cd_mat_hem4 IS NOT NULL AND r_c01_w.cd_mat_hem4::text <> '') and coalesce(r_c01_w.qt_dose_hem4,0) = 0)
				or ((r_c01_w.cd_mat_hem5 IS NOT NULL AND r_c01_w.cd_mat_hem5::text <> '') and coalesce(r_c01_w.qt_dose_hem5,0) = 0)
				or ((r_c01_w.cd_mat_recons1 IS NOT NULL AND r_c01_w.cd_mat_recons1::text <> '') and coalesce(r_c01_w.qt_dose_rec1,0) = 0)
				or ((r_c01_w.cd_mat_recons2 IS NOT NULL AND r_c01_w.cd_mat_recons2::text <> '') and coalesce(r_c01_w.qt_dose_rec2,0) = 0)
				or ((r_c01_w.cd_mat_recons3 IS NOT NULL AND r_c01_w.cd_mat_recons3::text <> '') and coalesce(r_c01_w.qt_dose_rec3,0) = 0)
				or ((r_c01_w.cd_mat_recons4 IS NOT NULL AND r_c01_w.cd_mat_recons4::text <> '') and coalesce(r_c01_w.qt_dose_rec4,0) = 0)
				or ((r_c01_w.cd_mat_recons5 IS NOT NULL AND r_c01_w.cd_mat_recons5::text <> '') and coalesce(r_c01_w.qt_dose_rec5,0) = 0)
				or ((r_c01_w.cd_mat_dil1 IS NOT NULL AND r_c01_w.cd_mat_dil1::text <> '') and coalesce(r_c01_w.qt_dose_dil1,0) = 0)
				or ((r_c01_w.cd_mat_dil2 IS NOT NULL AND r_c01_w.cd_mat_dil2::text <> '') and coalesce(r_c01_w.qt_dose_dil2,0) = 0)
				or ((r_c01_w.cd_mat_dil3 IS NOT NULL AND r_c01_w.cd_mat_dil3::text <> '') and coalesce(r_c01_w.qt_dose_dil3,0) = 0)
				or ((r_c01_w.cd_mat_dil4 IS NOT NULL AND r_c01_w.cd_mat_dil4::text <> '') and coalesce(r_c01_w.qt_dose_dil4,0) = 0)
				or ((r_c01_w.cd_mat_dil5 IS NOT NULL AND r_c01_w.cd_mat_dil5::text <> '') and coalesce(r_c01_w.qt_dose_dil5,0) = 0)) then
			ds_retorno_p := 'N';
			goto return_value;
		end if;
		--FIM CUSTOM VALIDATOR 

		--INCONSISTENCIA DA CPOE (BARRA VERMELHA) 

		--DUPLICIDADE
		if (r_c01_w.dt_fim IS NOT NULL AND r_c01_w.dt_fim::text <> '') then
			ie_continuo_w := 'S';
		end if;

		select 	CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END  ie_duplicado
		into STRICT	ie_return_value_w
		from	cpoe_hemoterapia a
		where	a.nr_sequencia <> coalesce(r_c01_w.nr_sequencia,0)
		and		obter_se_cpoe_regra_duplic('HBC', wheb_usuario_pck.get_cd_perfil, r_c01_w.cd_setor_atend) = 'S'
		and		((a.ie_tipo_hemoterap = 0 AND a.nr_seq_derivado = r_c01_w.nr_seq_derivado)  or (ie_tipo_hemoterap = 1 AND a.cd_procedimento = r_c01_w.cd_procedimento))
		and		((a.nr_atendimento = r_c01_w.nr_atendimento) or (a.cd_pessoa_fisica = r_c01_w.cd_pessoa_fisica and coalesce(a.nr_atendimento::text, '') = ''))
		and		(((a.dt_lib_suspensao IS NOT NULL AND a.dt_lib_suspensao::text <> '') and (a.dt_suspensao > clock_timestamp())) or (coalesce(a.dt_lib_suspensao::text, '') = ''))
		and 	((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') or (a.nm_usuario = wheb_usuario_pck.get_nm_usuario))		
		and 	((a.dt_inicio between r_c01_w.dt_inicio and r_c01_w.dt_fim) or (a.dt_fim between r_c01_w.dt_inicio and r_c01_w.dt_fim) or (coalesce(a.dt_fim::text, '') = '' and a.dt_inicio < r_c01_w.dt_inicio) or (a.dt_fim > r_c01_w.dt_fim and a.dt_inicio < r_c01_w.dt_inicio) or	
				 (((a.dt_inicio >  r_c01_w.dt_inicio) and (coalesce(ie_continuo_w,'N') = 'S')) or ((coalesce(ie_continuo_w,'N') = 'N') and (r_c01_w.dt_inicio <= a.dt_inicio)  and r_c01_w.dt_fim > a.dt_inicio)) or (a.ie_retrogrado = 'S' and coalesce(a.dt_liberacao::text, '') = ''));

		if (ie_return_value_w = 'S') then
			ds_retorno_p := 'N';
			goto return_value;
		end if;
		--DUPLICIDADE MEDICAMENTO
		if (cpoe_shoppingcart_medic_duplic(r_c01_w.nr_sequencia, r_c01_w.cd_setor_atend, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_mat_hem1, coalesce(r_c01_w.dt_inicio_hem1,r_c01_w.dt_inicio), r_c01_w.dt_fim) = 'S'
			or cpoe_shoppingcart_medic_duplic(r_c01_w.nr_sequencia, r_c01_w.cd_setor_atend, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_mat_hem2, coalesce(r_c01_w.dt_inicio_hem2,r_c01_w.dt_inicio), r_c01_w.dt_fim) = 'S'
			or cpoe_shoppingcart_medic_duplic(r_c01_w.nr_sequencia, r_c01_w.cd_setor_atend, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_mat_hem3, coalesce(r_c01_w.dt_inicio_hem3,r_c01_w.dt_inicio), r_c01_w.dt_fim) = 'S'
			or cpoe_shoppingcart_medic_duplic(r_c01_w.nr_sequencia, r_c01_w.cd_setor_atend, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_mat_hem4, coalesce(r_c01_w.dt_inicio_hem4,r_c01_w.dt_inicio), r_c01_w.dt_fim) = 'S'
			or cpoe_shoppingcart_medic_duplic(r_c01_w.nr_sequencia, r_c01_w.cd_setor_atend, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_mat_hem5, coalesce(r_c01_w.dt_inicio_hem5,r_c01_w.dt_inicio), r_c01_w.dt_fim) = 'S') then
			ds_retorno_p := 'N';
			goto return_value;
		end if;
		--NAO PADRONIZADO MEDICAMENTO
		if (cpoe_obter_se_mat_padronizado(wheb_usuario_pck.get_cd_estabelecimento, r_c01_w.cd_mat_hem1, 'N') = 'N'
			or cpoe_obter_se_mat_padronizado(wheb_usuario_pck.get_cd_estabelecimento, r_c01_w.cd_mat_hem2, 'N') = 'N'
			or cpoe_obter_se_mat_padronizado(wheb_usuario_pck.get_cd_estabelecimento, r_c01_w.cd_mat_hem3, 'N') = 'N'
			or cpoe_obter_se_mat_padronizado(wheb_usuario_pck.get_cd_estabelecimento, r_c01_w.cd_mat_hem4, 'N') = 'N'
			or cpoe_obter_se_mat_padronizado(wheb_usuario_pck.get_cd_estabelecimento, r_c01_w.cd_mat_hem5, 'N') = 'N') then
			ds_retorno_p := 'N';
			goto return_value;
		end if;
		--ALERGIA
		SELECT * FROM cpoe_verifica_se_pac_alergico(r_c01_w.cd_pessoa_fisica, r_c01_w.cd_mat_hem1, ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, 'N', nr_seq_ficha_tecnica_w) INTO STRICT ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, nr_seq_ficha_tecnica_w;
		
		if (ie_return_value_w = 'N') then
			SELECT * FROM cpoe_verifica_se_pac_alergico(r_c01_w.cd_pessoa_fisica, r_c01_w.cd_mat_hem2, ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, 'N', nr_seq_ficha_tecnica_w) INTO STRICT ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, nr_seq_ficha_tecnica_w;
		end if;	

		if (ie_return_value_w = 'N') then
			SELECT * FROM cpoe_verifica_se_pac_alergico(r_c01_w.cd_pessoa_fisica, r_c01_w.cd_mat_hem3, ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, 'N', nr_seq_ficha_tecnica_w) INTO STRICT ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, nr_seq_ficha_tecnica_w;
		end if;	

		if (ie_return_value_w = 'N') then
			SELECT * FROM cpoe_verifica_se_pac_alergico(r_c01_w.cd_pessoa_fisica, r_c01_w.cd_mat_hem4, ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, 'N', nr_seq_ficha_tecnica_w) INTO STRICT ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, nr_seq_ficha_tecnica_w;
		end if;		

		if (ie_return_value_w = 'N') then
			SELECT * FROM cpoe_verifica_se_pac_alergico(r_c01_w.cd_pessoa_fisica, r_c01_w.cd_mat_hem5, ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, 'N', nr_seq_ficha_tecnica_w) INTO STRICT ie_return_value_w, ds_alergia_w, ie_severidade_w, nr_seq_reacao_w, nr_seq_ficha_tecnica_w;
		end if;	

		if (ie_return_value_w = 'S') then
			ds_retorno_p := 'N';
			goto return_value;
		end if;
		--DOSE MIN E MAX 
		SELECT * FROM cpoe_shoppingcart_dose_max_min(r_c01_w.nr_atendimento, r_c01_w.nr_sequencia, 'HMAT1', r_c01_w.cd_mat_hem1, r_c01_w.qt_dose_hem1, null, r_c01_w.cd_unid_medida_dose_hem1, r_c01_w.ie_via_mat_hem1, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_interv_hem1, null, null, null, null, null, null, null, null, r_c01_w.dt_inicio_hem1, r_c01_w.dt_fim, 'P', r_c01_w.ds_hor_hem1, r_c01_w.ie_urgencia_mat_hem1, 'A') INTO STRICT nr_return_value_w, active_ingred_consist_w;

		if (coalesce(nr_return_value_w::text, '') = '' or nr_return_value_w = 0) then
			SELECT * FROM cpoe_shoppingcart_dose_max_min(r_c01_w.nr_atendimento, r_c01_w.nr_sequencia, 'HMAT2', r_c01_w.cd_mat_hem2, r_c01_w.qt_dose_hem2, null, r_c01_w.cd_unid_medida_dose_hem2, r_c01_w.ie_via_mat_hem2, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_interv_hem2, null, null, null, null, null, null, null, null, r_c01_w.dt_inicio_hem2, r_c01_w.dt_fim, 'P', r_c01_w.ds_hor_hem2, r_c01_w.ie_urgencia_mat_hem2, 'A') INTO STRICT nr_return_value_w, active_ingred_consist_w;
		end if;
		
		if (coalesce(nr_return_value_w::text, '') = '' or nr_return_value_w = 0) then
			SELECT * FROM cpoe_shoppingcart_dose_max_min(r_c01_w.nr_atendimento, r_c01_w.nr_sequencia, 'HMAT3', r_c01_w.cd_mat_hem3, r_c01_w.qt_dose_hem3, null, r_c01_w.cd_unid_medida_dose_hem3, r_c01_w.ie_via_mat_hem3, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_interv_hem3, null, null, null, null, null, null, null, null, r_c01_w.dt_inicio_hem3, r_c01_w.dt_fim, 'P', r_c01_w.ds_hor_hem3, r_c01_w.ie_urgencia_mat_hem3, 'A') INTO STRICT nr_return_value_w, active_ingred_consist_w;
		end if;

		if (coalesce(nr_return_value_w::text, '') = '' or nr_return_value_w = 0) then
			SELECT * FROM cpoe_shoppingcart_dose_max_min(r_c01_w.nr_atendimento, r_c01_w.nr_sequencia, 'HMAT4', r_c01_w.cd_mat_hem3, r_c01_w.qt_dose_hem4, null, r_c01_w.cd_unid_medida_dose_hem4, r_c01_w.ie_via_mat_hem4, r_c01_w.cd_pessoa_fisica, r_c01_w.cd_interv_hem4, null, null, null, null, null, null, null, null, r_c01_w.dt_inicio_hem4, r_c01_w.dt_fim, 'P', r_c01_w.ds_hor_hem4, r_c01_w.ie_urgencia_mat_hem4, 'A') INTO STRICT nr_return_value_w, active_ingred_consist_w;
		end if;

		if ((nr_return_value_w IS NOT NULL AND nr_return_value_w::text <> '') and nr_return_value_w > 0) then
			ds_retorno_p := 'N';
			goto return_value;
		end if;
		--LATEX MEDICAMENTO
		if (cpoe_shoppingcart_se_latex(r_c01_w.cd_mat_hem1, r_c01_w.cd_pessoa_fisica) = 'S'
			or cpoe_shoppingcart_se_latex(r_c01_w.cd_mat_hem2, r_c01_w.cd_pessoa_fisica) = 'S'
			or cpoe_shoppingcart_se_latex(r_c01_w.cd_mat_hem3, r_c01_w.cd_pessoa_fisica) = 'S'
			or cpoe_shoppingcart_se_latex(r_c01_w.cd_mat_hem4, r_c01_w.cd_pessoa_fisica) = 'S'
			or cpoe_shoppingcart_se_latex(r_c01_w.cd_mat_hem5, r_c01_w.cd_pessoa_fisica) = 'S') then
			ds_retorno_p := 'N';
			goto return_value;
		end if;
		--INTERACAO FARMACO X FARMACO
		if (cpoe_obter_se_interacao_medic(r_c01_w.cd_mat_hem1, r_c01_w.nr_atendimento, r_c01_w.cd_pessoa_fisica, r_c01_w.nr_sequencia) = 'S'
			or cpoe_obter_se_interacao_medic(r_c01_w.cd_mat_hem2, r_c01_w.nr_atendimento, r_c01_w.cd_pessoa_fisica, r_c01_w.nr_sequencia) = 'S'
			or cpoe_obter_se_interacao_medic(r_c01_w.cd_mat_hem3, r_c01_w.nr_atendimento, r_c01_w.cd_pessoa_fisica, r_c01_w.nr_sequencia) = 'S'
			or cpoe_obter_se_interacao_medic(r_c01_w.cd_mat_hem4, r_c01_w.nr_atendimento, r_c01_w.cd_pessoa_fisica, r_c01_w.nr_sequencia) = 'S'
			or cpoe_obter_se_interacao_medic(r_c01_w.cd_mat_hem5, r_c01_w.nr_atendimento, r_c01_w.cd_pessoa_fisica, r_c01_w.nr_sequencia) = 'S') then
			ds_retorno_p := 'N';
			goto return_value;
		end if;
		--FIM INCONSISTENCIA DA CPOE (BARRA VERMELHA) 
	end loop;
end if;
<<return_value>>
 null;
exception when others then
	CALL gravar_log_cpoe(substr('CPOE_SHOPPINGCART_HEMOTHERAPY EXCEPTION:'|| substr(to_char(sqlerrm),1,2000) || '//nr_sequencia_p: '|| nr_sequencia_p,1,40000));
	ds_retorno_p := 'N';
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_shoppingcart_hemotherapy (nr_sequencia_p bigint, ie_retrogrado_p text, ds_retorno_p INOUT text) FROM PUBLIC;

