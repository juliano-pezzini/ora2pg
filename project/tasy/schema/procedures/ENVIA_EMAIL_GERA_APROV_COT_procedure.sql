-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE envia_email_gera_aprov_cot ( nr_cot_compra_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
/* Dados da regra */
 
nr_seq_regra_w			bigint;
ds_email_adicional_w		varchar(2000);
cd_perfil_dispara_w		integer;
ie_momento_envio_w		varchar(1);
ie_usuario_w			varchar(1);
ie_envia_pessoa_deleg_w		varchar(1);
ds_email_remetente_w		varchar(255);

/*Dados do e-mail*/
 
ds_titulo_w			varchar(255);
dt_cot_compra_w			timestamp;
nm_pessoa_solic_w		varchar(255);
cd_comprador_w			varchar(10);
nr_seq_aprovacao_w		bigint;
nr_seq_proc_aprov_w		bigint;
ds_mensagem_w			varchar(4000);
ds_assunto_w			varchar(255);

/*Dados para envio */
 
ds_email_origem_w			varchar(255);
nm_usuario_origem_w		varchar(255);
ds_destinatarios_w			varchar(4000);
ds_email_w			varchar(255);

 
c00 CURSOR FOR 
SELECT	a.nr_sequencia, 
	a.nr_seq_proc_aprov 
from	processo_aprov_compra a, 
	cot_compra_item b 
where	b.nr_cot_compra = nr_cot_compra_p 
and	a.nr_sequencia = b.nr_seq_aprovacao 
group by	a.nr_sequencia, 
	a.nr_seq_proc_aprov 
order by	a.nr_sequencia;

c01 CURSOR FOR 
SELECT	b.ds_email 
from	pessoas_processo_aprovacao_v a, 
	usuario b 
where	a.nm_usuario = b.nm_usuario 
and	a.nr_sequencia = nr_seq_aprovacao_w 
and	a.nr_seq_proc_aprov = nr_seq_proc_aprov_w 
and	a.ie_aprov_reprov = 'P' 
group by	ds_email;

c02 CURSOR FOR 
SELECT	ds_email 
from	(SELECT	b.ds_email 
	from	pessoas_processo_aprovacao_v a, 
		usuario b 
	where	a.nm_usuario = b.nm_usuario 
	and	a.nr_sequencia = nr_seq_aprovacao_w 
	and	a.nr_seq_proc_aprov = nr_seq_proc_aprov_w 
	and	a.ie_aprov_reprov = 'P' 
	and	not exists (select	1 
			from	pessoa_fisica_delegacao x 
			where	x.cd_pessoa_fisica = a.cd_pessoa_fisica 
			and	((coalesce(trunc(x.dt_inicio_limite),trunc(clock_timestamp())) <= trunc(clock_timestamp())) and (trunc(x.dt_limite) >= trunc(clock_timestamp())))) 
	
union all
 
	select	b.ds_email 
	from	usuario b, 
		pessoa_fisica_delegacao c, 
		pessoas_processo_aprovacao_v a 
	where	a.cd_pessoa_fisica = c.cd_pessoa_fisica 
	and	c.cd_pessoa_substituta = b.cd_pessoa_fisica 
	and	((coalesce(trunc(c.dt_inicio_limite),trunc(clock_timestamp())) <= trunc(clock_timestamp())) and (trunc(c.dt_limite) >= trunc(clock_timestamp()))) 
	and	a.nr_sequencia = nr_seq_aprovacao_w 
	and	a.nr_seq_proc_aprov = nr_seq_proc_aprov_w 
	and	a.ie_aprov_reprov = 'P') alias25 
group by	ds_email;


BEGIN 
 
select	coalesce(max(nr_sequencia),0), 
	coalesce(max(ds_email_remetente),'X'), 
	max(replace(ds_email_adicional,',',';')), 
	max(cd_perfil_disparar), 
	coalesce(max(ie_momento_envio),'I'), 
	coalesce(max(ie_envia_pessoa_deleg),'N') 
into STRICT	nr_seq_regra_w, 
	ds_email_remetente_w, 
	ds_email_adicional_w, 
	cd_perfil_dispara_w, 
	ie_momento_envio_w, 
	ie_envia_pessoa_deleg_w 
from	regra_envio_email_compra 
where	ie_tipo_mensagem = 68 
and	ie_situacao = 'A' 
and	cd_estabelecimento = cd_estabelecimento_p 
and	obter_se_envia_email_regra(nr_cot_compra_p, 'CC', ie_tipo_mensagem, cd_estabelecimento) = 'S';
 
if (nr_seq_regra_w > 0) and 
	((coalesce(cd_perfil_dispara_w::text, '') = '') or 
	(cd_perfil_dispara_w IS NOT NULL AND cd_perfil_dispara_w::text <> '' AND cd_perfil_dispara_w = obter_perfil_ativo)) then 
	begin 
 
	select	ds_titulo, 
		dt_cot_compra, 
		substr(obter_nome_pf(cd_pessoa_solicitante),1,255), 
		coalesce(cd_comprador,0) 
	into STRICT	ds_titulo_w, 
		dt_cot_compra_w, 
		nm_pessoa_solic_w, 
		cd_comprador_w 
	from	cot_compra 
	where	nr_cot_compra = nr_cot_compra_p;
 
	select	ds_assunto, 
		ds_mensagem_padrao 
	into STRICT	ds_assunto_w, 
		ds_mensagem_w 
	from	regra_envio_email_compra 
	where	nr_sequencia = nr_seq_regra_w;
 
	ds_assunto_w	:= replace_macro(ds_assunto_w, '@ds_titulo', ds_titulo_w);
	ds_assunto_w	:= replace_macro(ds_assunto_w, '@nr_cotacao', to_char(nr_cot_compra_p));
	ds_assunto_w	:= replace_macro(ds_assunto_w, '@dt_cotacao', to_char(dt_cot_compra_w,'dd/mm/yyyy'));
	ds_assunto_w	:= replace_macro(ds_assunto_w, '@nm_solicitante', nm_pessoa_solic_w);
	ds_assunto_w	:= substr(ds_assunto_w, 1, 255);
 
	ds_mensagem_w	:= substr(replace_macro(ds_mensagem_w, '@ds_titulo', ds_titulo_w), 1, 4000);
	ds_mensagem_w	:= substr(replace_macro(ds_mensagem_w, '@nr_cotacao', to_char(nr_cot_compra_p)), 1, 4000);
	ds_mensagem_w	:= substr(replace_macro(ds_mensagem_w, '@dt_cotacao', to_char(dt_cot_compra_w,'dd/mm/yyyy')), 1, 4000);
	ds_mensagem_w	:= substr(replace_macro(ds_mensagem_w, '@nm_solicitante', nm_pessoa_solic_w), 1, 4000);
	ds_mensagem_w	:= substr(ds_mensagem_w, 1, 4000);
 
	select	coalesce(max(ie_usuario),'U') 
	into STRICT	ie_usuario_w 
	from	regra_envio_email_compra 
	where	nr_sequencia = nr_seq_regra_w;
 
	if (ie_usuario_w = 'U') or 
		((coalesce(cd_comprador_w,'0') <> 0) and (ie_usuario_w = 'O')) then --Usuario 
		begin 
 
		select	ds_email, 
			nm_usuario 
		into STRICT	ds_email_origem_w, 
			nm_usuario_origem_w 
		from	usuario 
		where	nm_usuario = nm_usuario_p;
 
		end;
	elsif (ie_usuario_w = 'C') then --Setor compras 
		begin 
 
		select	ds_email 
		into STRICT	ds_email_origem_w 
		from	parametro_compras 
		where	cd_estabelecimento = cd_estabelecimento_p;
 
		select	coalesce(ds_fantasia,ds_razao_social) 
		into STRICT	nm_usuario_origem_w 
		from	estabelecimento_v 
		where	cd_estabelecimento = cd_estabelecimento_p;
 
		end;
	elsif (ie_usuario_w = 'O') then --Comprador 
		begin 
 
		select	max(ds_email), 
			max(nm_guerra) 
		into STRICT	ds_email_origem_w, 
			nm_usuario_origem_w 
		from	comprador 
		where	cd_pessoa_fisica = cd_comprador_w 
		and	cd_estabelecimento = cd_estabelecimento_p;
 
		end;
	end if;
 
	if (ds_email_remetente_w <> 'X') then 
		ds_email_origem_w	:= ds_email_remetente_w;
	end if;
 
	open c00;
	loop 
	fetch c00 into 
		nr_seq_aprovacao_w, 
		nr_seq_proc_aprov_w;
	EXIT WHEN NOT FOUND; /* apply on c00 */
		begin 
 
		ds_destinatarios_w		:= '';
		 
		if (ie_envia_pessoa_deleg_w = 'S') then 
			begin 
 
			open c02;
			loop 
			fetch c02 into 
				ds_email_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				begin 
	 
				ds_destinatarios_w	:= ds_destinatarios_w || ds_email_w || ';';
	 
				end;
			end loop;
			close c02;
 
			end;
		else 
			begin 
 
			open c01;
			loop 
			fetch c01 into 
				ds_email_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
				begin 
	 
				ds_destinatarios_w	:= ds_destinatarios_w || ds_email_w || ';';
	 
				end;
			end loop;
			close c01;
 
			end;
		end if;
 
		if (ds_email_adicional_w IS NOT NULL AND ds_email_adicional_w::text <> '') then 
			ds_destinatarios_w	:= ds_destinatarios_w || ds_email_adicional_w;
		end if;
	 
		if (ie_momento_envio_w = 'A') then 
			begin 
 
			CALL sup_grava_envio_email( 
				'CC', 
				'68', 
				nr_cot_compra_p, 
				nr_seq_aprovacao_w, 
				nr_seq_proc_aprov_w, 
				ds_destinatarios_w, 
				nm_usuario_origem_w, 
				ds_email_origem_w, 
				ds_assunto_w, 
				ds_mensagem_w, 
				cd_estabelecimento_p, 
				nm_usuario_p);
 
			end;
		else 
			begin 
			CALL enviar_email(ds_assunto_w,ds_mensagem_w,ds_email_origem_w,ds_destinatarios_w,nm_usuario_origem_w,'M');
			exception 
			when others then 
				/*gravar__log__tasy(91301,'Falha ao enviar e-mail compras - Evento: 68 - Seq. Regra: ' || nr_seq_regra_w,nm_usuario_p);*/
 
				CALL gerar_historico_cotacao( 
					nr_cot_compra_p, 
					wheb_mensagem_pck.get_texto(299745) , 
					wheb_mensagem_pck.get_texto(300011, 'NR_SEQ_REGRA=' || nr_seq_regra_w), 
					'S', 
					nm_usuario_p);
			end;
		end if;
 
		end;
	end loop;
	close c00;
 
	end;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE envia_email_gera_aprov_cot ( nr_cot_compra_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

