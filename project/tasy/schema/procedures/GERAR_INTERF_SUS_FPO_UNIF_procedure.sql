-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_interf_sus_fpo_unif ( nr_seq_protocolo_p bigint , nm_usuario_p text ) AS $body$
DECLARE

 
dt_competencia_w			timestamp;
cd_cnes_w			varchar(7);
cd_procedimento_w		varchar(9);
ie_tipo_financiamento_w		varchar(1);
ie_nivel_apuracao_w		varchar(1);
qt_orcada_w			integer;
vl_unitario_w			double precision;
vl_total_w			double precision;					
 
c01 CURSOR FOR 
	SELECT	a.dt_mesano_referencia dt_competencia, 
		obter_cnes_estab_cnpj(obter_cgc_estabelecimento(a.cd_estabelecimento)) cd_cnes, 
		substr(b.cd_procedimento,1,9) cd_procedimento, 
		CASE WHEN obter_tipo_financ_proc(b.cd_procedimento,b.ie_origem_proced,1)='01' THEN 1 WHEN obter_tipo_financ_proc(b.cd_procedimento,b.ie_origem_proced,1)='04' THEN 3  ELSE 2 END  ie_tipo_financiamento, 
		sus_obter_nivel_apur_fpo(b.cd_procedimento,b.ie_origem_proced) ie_nivel_apuracao, 
		sum(b.qt_procedimento) qt_orcada, 
		(sum(b.vl_procedimento)/sum(b.qt_procedimento)) vl_unitario, 
		sum(b.vl_procedimento) vl_total 
	from	procedimento_paciente b, 
		conta_paciente a 
	where	a.nr_interno_conta = b.nr_interno_conta 
	and	a.nr_seq_protocolo = nr_seq_protocolo_p 
	group by	a.dt_mesano_referencia, 
		obter_cnes_estab_cnpj(obter_cgc_estabelecimento(a.cd_estabelecimento)), 
		substr(b.cd_procedimento,1,9), 
		CASE WHEN obter_tipo_financ_proc(b.cd_procedimento,b.ie_origem_proced,1)='01' THEN 1 WHEN obter_tipo_financ_proc(b.cd_procedimento,b.ie_origem_proced,1)='04' THEN 3  ELSE 2 END , 
		sus_obter_nivel_apur_fpo(b.cd_procedimento,b.ie_origem_proced);
					

BEGIN 
 
delete from w_interf_sus_fpo_unif 
where	nr_seq_protocolo = nr_seq_protocolo_p;
 
open c01;
loop 
fetch c01 into	 
	dt_competencia_w, 
	cd_cnes_w, 
	cd_procedimento_w, 
	ie_tipo_financiamento_w, 
	ie_nivel_apuracao_w, 
	qt_orcada_w, 
	vl_unitario_w, 
	vl_total_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	 
	insert into w_interf_sus_fpo_unif( 
			nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			dt_competencia, 
			cd_cnes, 
			cd_procedimento, 
			ie_tipo_financiamento, 
			ie_nivel_apuracao, 
			qt_orcada, 
			vl_unitario, 
			vl_total, 
			nr_seq_protocolo) 
		values (	nextval('w_interf_sus_fpo_unif_seq'), 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			dt_competencia_w, 
			cd_cnes_w, 
			cd_procedimento_w, 
			ie_tipo_financiamento_w, 
			ie_nivel_apuracao_w, 
			qt_orcada_w, 
			vl_unitario_w, 
			vl_total_w, 
			nr_seq_protocolo_p);
	 
	end;
end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_interf_sus_fpo_unif ( nr_seq_protocolo_p bigint , nm_usuario_p text ) FROM PUBLIC;

