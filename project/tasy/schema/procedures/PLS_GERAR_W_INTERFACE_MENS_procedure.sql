-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_w_interface_mens ( cd_cgc_p text, ie_pessoa_juridica_p text, dt_inicial_p timestamp, dt_final_p timestamp, nr_seq_lotes_p text, ie_tipo_data_p bigint, ie_agrupa_valor_p text, ie_valor_subsidiado_p text, ie_tipo_item_p text, nr_titulo_p bigint, nr_contrato_p pls_contrato.nr_contrato%type, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


/* ie_tipo_data_p
	0: Nenhum
	1: Mes referencia lote mensalidade
*/
dt_geracao_w			timestamp;
nr_seq_vinculo_est_w		bigint;
cd_matricula_estipulante_w	varchar(30);
nr_seq_lote_w			bigint;
nr_seq_contrato_w		bigint;
ds_lotes_w			varchar(255);
pos_virgula_w			integer;
nr_seq_lote_ww			bigint;
ie_gravar_tabela_w		varchar(2);
nr_seq_mensalidade_w		bigint;
nr_seq_mensalidade_seg_w	bigint;
nr_seq_usuario_w		bigint;
nr_seq_segurado_w		bigint;
vl_agrupado_w			double precision;
ds_lista_item_w			varchar(50);
ie_tipo_item_w			varchar(3);
vl_item_w			double precision;
qt_virgula_w			integer;
ie_gravar_item_w		varchar(5);
ie_pos_item_w			integer := 0;
nr_seq_vinculo_est_tit_w	bigint;
nr_seq_contrato_ww		bigint;

C01 CURSOR FOR
	SELECT	distinct trunc(a.dt_mesano_referencia,'month') dt_geracao,
		d.nr_seq_vinculo_est,
		d.cd_matricula_estipulante,
		a.nr_sequencia,
		d.nr_seq_contrato,
		b.nr_sequencia,
		c.nr_sequencia,
		d.nr_sequencia,
		(	SELECT	max(nr_seq_vinculo_est)
			from	pls_segurado	x
			where	x.nr_sequencia	= d.nr_seq_titular) nr_seq_vinculo_est_tit
	FROM pls_contrato_pagador e, pls_mensalidade_segurado c, pls_mensalidade b, pls_lote_mensalidade a, pls_segurado d
LEFT OUTER JOIN pls_vinculo_estipulante f ON (d.nr_seq_vinculo_est = f.nr_sequencia)
WHERE a.nr_sequencia       = b.nr_seq_lote and b.nr_sequencia       = c.nr_seq_mensalidade and c.nr_seq_segurado    = d.nr_sequencia and b.nr_seq_pagador     = e.nr_sequencia  and (d.nr_seq_contrato = nr_seq_contrato_ww or nr_contrato_p = 0) and ((coalesce(ie_pessoa_juridica_p,'P') = 'P' and e.cd_cgc = cd_cgc_p) or
		 (coalesce(ie_pessoa_juridica_p,'P') = 'E' and (((	select	max(x.cd_cgc)
								from	pls_desc_empresa	x
								where	x.nr_sequencia = a.nr_seq_empresa) = cd_cgc_p) or
							   ((	select	max(y.cd_cgc)
								from	pls_desc_empresa		y,
									pls_contrato_pagador_fin	x
								where	x.nr_seq_empresa = y.nr_sequencia
								and	coalesce(a.nr_seq_empresa::text, '') = ''
								and	x.nr_seq_pagador = e.nr_sequencia) = cd_cgc_p)))) and ie_agrupa_valor_p = 'N' and ((nr_titulo_p = 0) or (exists (	select	1
							from	titulo_receber x
							where	x.nr_seq_mensalidade	= b.nr_sequencia
							and	x.nr_titulo		= nr_titulo_p))) and ((ie_tipo_data_p = 1 and (trunc(a.dt_mesano_referencia,'month') between trunc(dt_inicial_p,'month') and trunc(dt_final_p,'month'))) or (ie_tipo_data_p = 0))
	 
union all

	select	distinct trunc(a.dt_mesano_referencia,'month') dt_geracao,
		d.nr_seq_vinculo_est,
		d.cd_matricula_estipulante,
		a.nr_sequencia,
		c.nr_seq_contrato,
		b.nr_sequencia,
		null,
		d.nr_sequencia,
		(	select	max(nr_seq_vinculo_est)
			from	pls_segurado	x
			where	x.nr_sequencia	= d.nr_seq_titular) nr_seq_vinculo_est_tit
	FROM pls_contrato_pagador c, pls_mensalidade b, pls_lote_mensalidade a, pls_segurado d
LEFT OUTER JOIN pls_vinculo_estipulante e ON (d.nr_seq_vinculo_est = e.nr_sequencia)
WHERE a.nr_sequencia		= b.nr_seq_lote and b.nr_seq_pagador	= c.nr_sequencia and c.nr_sequencia		= d.nr_seq_pagador  and (d.nr_seq_contrato = nr_seq_contrato_ww or nr_contrato_p = 0) and coalesce(d.nr_seq_titular::text, '') = '' and ((coalesce(ie_pessoa_juridica_p,'P') = 'P' and c.cd_cgc = cd_cgc_p) or
		 (coalesce(ie_pessoa_juridica_p,'P') = 'E' and (((	select	max(x.cd_cgc)
								from	pls_desc_empresa	x
								where	x.nr_sequencia = a.nr_seq_empresa) = cd_cgc_p) or 
							   ((	select	max(y.cd_cgc)
								from	pls_desc_empresa		y,
									pls_contrato_pagador_fin	x
								where	x.nr_seq_empresa = y.nr_sequencia
								and	coalesce(a.nr_seq_empresa::text, '') = ''
								and	x.nr_seq_pagador = c.nr_sequencia) = cd_cgc_p)))) and ie_agrupa_valor_p	= 'S' and ((nr_titulo_p = 0) or (exists (	select	1
							from	titulo_receber x
							where	x.nr_seq_mensalidade	= b.nr_sequencia
							and	x.nr_titulo		= nr_titulo_p))) and ((ie_tipo_data_p = 1 and (trunc(a.dt_mesano_referencia,'month') between trunc(dt_inicial_p,'month') and trunc(dt_final_p,'month'))) or (ie_tipo_data_p = 0));


BEGIN

delete	from w_pls_interface_mens
where	nm_usuario = nm_usuario_p;

if (nr_contrato_p IS NOT NULL AND nr_contrato_p::text <> '') then
	select	max(nr_sequencia)
	into STRICT	nr_seq_contrato_ww
	from	pls_contrato
	where	nr_contrato = nr_contrato_p;
end if;

open C01;
loop
fetch C01 into	
	dt_geracao_w,
	nr_seq_vinculo_est_w,
	cd_matricula_estipulante_w,
	nr_seq_lote_w,
	nr_seq_contrato_w,
	nr_seq_mensalidade_w,
	nr_seq_mensalidade_seg_w,
	nr_seq_segurado_w,
	nr_seq_vinculo_est_tit_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	vl_agrupado_w		:= 0;
	ie_gravar_tabela_w	:= 'S';
	ds_lotes_w := replace(nr_seq_lotes_p,' ','');
	ds_lista_item_w	:= ie_tipo_item_p || ',';
	vl_item_w	:= 0;
	ie_pos_item_w	:= 0;
	
	if (coalesce(nr_seq_vinculo_est_tit_w::text, '') = '') then
		nr_seq_vinculo_est_tit_w	:= nr_seq_vinculo_est_w;
	end if;
	
	if (coalesce(nr_seq_lotes_p,'0') <> '0') then
		ie_gravar_tabela_w	:= 'N';
		while(ds_lotes_w IS NOT NULL AND ds_lotes_w::text <> '') loop
			begin
			
			select  position(',' in ds_lotes_w)
			into STRICT    pos_virgula_w
			;
			
			if (pos_virgula_w > 0) then
				
				select	(substr(ds_lotes_w,1,pos_virgula_w - 1))::numeric
				into STRICT	nr_seq_lote_ww
				;
				
				select	substr(ds_lotes_w,pos_virgula_w+1,length(ds_lotes_w))
				into STRICT	ds_lotes_w
				;
			else
				nr_seq_lote_ww := (ds_lotes_w)::numeric;
				ds_lotes_w	:= '';
			end if;
			
			if (nr_seq_lote_w = nr_seq_lote_ww) then
				ie_gravar_tabela_w	:= 'S';
			end if;
			
			end;
		end loop;
	end if;
	
	if (ie_gravar_tabela_w = 'S') then
		while(ds_lista_item_w IS NOT NULL AND ds_lista_item_w::text <> '') loop
			begin
			
			select	position(',' in ds_lista_item_w)
			into STRICT	qt_virgula_w
			;
			
			select	substr(ds_lista_item_w,1,qt_virgula_w-1)
			into STRICT	ie_gravar_item_w
			;
			
			if (ie_gravar_item_w	= 'S') then
				select	CASE WHEN ie_pos_item_w=0 THEN 3 WHEN ie_pos_item_w=1 THEN 8 WHEN ie_pos_item_w=2 THEN 6 WHEN ie_pos_item_w=3 THEN 7 WHEN ie_pos_item_w=4 THEN 1 WHEN ie_pos_item_w=5 THEN 12 WHEN ie_pos_item_w=6 THEN 5 WHEN ie_pos_item_w=7 THEN 25 WHEN ie_pos_item_w=8 THEN 9 WHEN ie_pos_item_w=9 THEN 10 WHEN ie_pos_item_w=10 THEN 13 WHEN ie_pos_item_w=11 THEN 11 WHEN ie_pos_item_w=12 THEN 2 WHEN ie_pos_item_w=13 THEN 4 WHEN ie_pos_item_w=14 THEN 20 WHEN ie_pos_item_w=15 THEN 45 END
				into STRICT	ie_tipo_item_w
				;

				if (ie_agrupa_valor_p = 'S') then /* Agrupar os valores das mensalidades do titular + dependentes apenas no titular */
					select	sum(c.vl_item)
					into STRICT	vl_item_w
					from	pls_mensalidade_segurado a,
						pls_segurado b,
						pls_mensalidade_seg_item c
					where	a.nr_seq_segurado	= b.nr_sequencia
					and	a.nr_sequencia		= c.nr_seq_mensalidade_seg
					and (b.nr_sequencia	= nr_seq_segurado_w or b.nr_seq_titular = nr_seq_segurado_w)
					and	a.nr_seq_mensalidade	= nr_seq_mensalidade_w
					and	c.ie_tipo_item		= ie_tipo_item_w;
				else
					select	sum(b.vl_item)
					into STRICT	vl_item_w
					from	pls_mensalidade_segurado a,
						pls_mensalidade_seg_item b
					where	a.nr_sequencia		= b.nr_seq_mensalidade_seg
					and	a.nr_seq_mensalidade	= nr_seq_mensalidade_w
					and	a.nr_seq_segurado	= nr_seq_segurado_w
					and	b.ie_tipo_item		= ie_tipo_item_w;
				end if;
				
				vl_agrupado_w	:= coalesce(vl_agrupado_w,0) + coalesce(vl_item_w,0);
			end if;
			
			select	substr(ds_lista_item_w,qt_virgula_w+1,length(ds_lista_item_w))
			into STRICT	ds_lista_item_w
			;
			
			begin
			ie_pos_item_w	:= ie_pos_item_w + 1;
			exception
			when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(196915, 'DS_LISTA_ITEM=' || ds_lista_item_w);
			end;
			end;
		end loop;
			/*	
			if	(ie_valor_subsidiado_p	= 'S') then /* Somente pegar os valores nao subsidiados + co-participacao */

				/*select	sum(nvl(pls_obter_valor_item_mens(a.nr_sequencia,'3'),0) + nvl(pls_obter_valor_item_mens(a.nr_sequencia,'12'),0))
				into	vl_agrupado_w
				from	pls_mensalidade_segurado a,
					pls_segurado b
				where	a.nr_seq_segurado	= b.nr_sequencia
				and	(b.nr_sequencia	= nr_seq_segurado_w or b.nr_seq_titular = nr_seq_segurado_w)
				and	a.nr_seq_mensalidade	= nr_seq_mensalidade_w;
			else
				select	sum(nvl(a.vl_mensalidade,0))
				into	vl_agrupado_w
				from	pls_mensalidade_segurado a,
					pls_segurado b
				where	a.nr_seq_segurado	= b.nr_sequencia
				and	(b.nr_sequencia	= nr_seq_segurado_w or b.nr_seq_titular = nr_seq_segurado_w)
				and	a.nr_seq_mensalidade	= nr_seq_mensalidade_w;
			end if;
		else
			if	(ie_valor_subsidiado_p	= 'S') then /* Somente pegar os valores nao subsidiados + co-participacao */

				/*select	sum(nvl(pls_obter_valor_item_mens(a.nr_sequencia,'3'),0) + nvl(pls_obter_valor_item_mens(a.nr_sequencia,'12'),0))
				into	vl_agrupado_w
				from	pls_mensalidade_segurado a
				where	a.nr_seq_mensalidade	= nr_seq_mensalidade_w
				and	a.nr_seq_segurado	= nr_seq_segurado_w;
			else
				select	nvl(vl_mensalidade,0)
				into	vl_agrupado_w
				from	pls_mensalidade_segurado
				where	nr_seq_segurado	= nr_seq_segurado_w
				and	nr_seq_mensalidade	= nr_seq_mensalidade_w;
			end if;
		end if;*/
		
		if (coalesce(vl_agrupado_w,0) > 0) then
			select	coalesce(max(nr_seq_usuario),0) + 1
			into STRICT	nr_seq_usuario_w
			from	w_pls_interface_mens
			where	nm_usuario	= nm_usuario_p;
			
			insert into w_pls_interface_mens(	nr_seq_usuario,
								nm_usuario,
								cd_estabelecimento,
								dt_atualizacao,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								dt_mesano_referencia,
								nr_seq_vinculo_est,
								nr_seq_lote,
								nr_seq_contrato,
								nr_seq_mensalidade,
								nr_seq_mensalidade_seg,
								nr_seq_segurado,
								vl_agrupado,
								nr_seq_vinculo_est_tit)
							values (	nr_seq_usuario_w,
								nm_usuario_p,
								cd_estabelecimento_p,
								clock_timestamp(),
								clock_timestamp(),
								nm_usuario_p,
								dt_geracao_w,
								nr_seq_vinculo_est_w,
								nr_seq_lote_w,
								nr_seq_contrato_w,
								nr_seq_mensalidade_w,
								nr_seq_mensalidade_seg_w,
								nr_seq_segurado_w,
								vl_agrupado_w,
								nr_seq_vinculo_est_tit_w);
		end if;
	end if;
	
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_w_interface_mens ( cd_cgc_p text, ie_pessoa_juridica_p text, dt_inicial_p timestamp, dt_final_p timestamp, nr_seq_lotes_p text, ie_tipo_data_p bigint, ie_agrupa_valor_p text, ie_valor_subsidiado_p text, ie_tipo_item_p text, nr_titulo_p bigint, nr_contrato_p pls_contrato.nr_contrato%type, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

