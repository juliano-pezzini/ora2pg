-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_parecer_medico (nr_sequencia_p bigint, nm_usuario_dest_p text, ds_parecer_p text) AS $body$
DECLARE
				
 
ds_parecer_w	varchar(4000);
ds_pronome_w	varchar(10);
nm_medico_w	varchar(60);
nm_paciente_w	varchar(60);
nm_usuario_w	varchar(15);
nm_usuario_dest_w	varchar(255);
nm_usuario_dest_w2	varchar(15);
qt_reg_w		integer	:= 0;
vl_pos_w		smallint;


BEGIN 
 
SELECT	SUBSTR(obter_nome_pf(a.cd_pessoa_fisica),1,60), 
	SUBSTR(obter_nome_medico(b.cd_medico,'N'),1,60), 
	obter_pronome_pf(a.cd_pessoa_fisica,'N'), 
	ds_parecer, 
	b.nm_usuario 
INTO STRICT	nm_paciente_w, 
	nm_medico_w, 
	ds_pronome_w, 
	ds_parecer_w, 
	nm_usuario_w 
FROM	med_parecer_medico b, 
	med_Cliente a 
WHERE	a.nr_sequencia = b.nr_seq_cliente 
AND	b.nr_sequencia = nr_sequencia_p;
 
 
  nm_usuario_dest_w   := substr(nm_usuario_dest_p,1,255);
  while(length(nm_usuario_dest_w) > 0) loop 
      begin 
      vl_pos_w    := position(',' in nm_usuario_dest_w);
      if (vl_pos_w > 0) then 
          nm_usuario_dest_w2   := substr(nm_usuario_dest_w, 1,        (vl_pos_w - 1));
          nm_usuario_dest_w   := substr(nm_usuario_dest_w, (vl_pos_w + 1),  length(nm_usuario_dest_w));
      else 
          nm_usuario_dest_w2   := nm_usuario_dest_w;
          nm_usuario_dest_w   := '';
      end   if;
 	  ds_parecer_w	:= 	wheb_mensagem_pck.get_texto(307456, 'DS_PRONOME_W=' || ds_pronome_w || ';' || 
															'NM_PACIENTE_W=' || nm_paciente_w || ';' || 
															'NM_MEDICO_W=' || nm_medico_w || ';' || 
															'DT_ATUAL_DIA=' || to_char(clock_timestamp(),'dd') || ';' || 
															'DT_ATUAL_MES=' || to_char(clock_timestamp(),'mm') || ';' || 
															'DT_ATUAL_ANO=' || to_char(clock_timestamp(),'yyyy') || ';' || 
															'DS_PARECER_P=' || ds_parecer_p);
					/* 
						Parecer Médico #@DS_PRONOME_W#@ #@NM_PACIENTE_W#@ 
						Dr(a). #@NM_MEDICO_W#@ 
						Data: #@DT_ATUAL_DIA#@ de #@DT_ATUAL_MES#@ de #@DT_ATUAL_ANO#@ 
 
						#@DS_PARECER_P#@ 
					*/
 
	  insert	into comunic_interna( 
			DT_COMUNICADO,      
			DS_TITULO,      
			DS_COMUNICADO,      
			NM_USUARIO,      
			DT_ATUALIZACAO,     
			IE_GERAL,     
			NM_USUARIO_DESTINO,       
			NR_SEQUENCIA,      
			IE_GERENCIAL, 
			DT_LIBERACAO) 
		values (clock_timestamp(), 
			wheb_mensagem_pck.get_texto(307446), -- Parecer médico 
			ds_parecer_w, 
			nm_usuario_w, 
			clock_timestamp(), 
			'N', 
			nm_usuario_dest_w2, 
			nextval('comunic_interna_seq'), 
			'N', 
			clock_timestamp());
      end;
  end loop;
	 
 
commit;
 
end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_parecer_medico (nr_sequencia_p bigint, nm_usuario_dest_p text, ds_parecer_p text) FROM PUBLIC;

