-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_contrato_cotacao ( nr_cot_compra_p bigint, nr_seq_tipo_contrato_p bigint, nr_seq_subtipo_contrato_p bigint, dt_inicio_vigencia_p timestamp, dt_fim_vigencia_p timestamp, ie_preco_p bigint, ie_quantidade_p bigint, nm_usuario_p text, ie_pagar_receber_p text default null) AS $body$
DECLARE


nr_seq_contrato_w			bigint;
cd_pessoa_solicitante_w		varchar(10);
cd_cond_pagto_w			bigint;
nr_item_cot_compra_w		bigint;
cd_estabelecimento_w		integer;
cd_material_w			integer;
nr_seq_fornecedor_w		bigint	:= 0;
nr_seq_fornecedor_w2		bigint	:= 0;
vl_unitario_w			double precision	:= 0;
ds_observacao_w			varchar(255);
ds_marca_w			varchar(30)	:= '';
cd_cgc_fornecedor_w		varchar(14);
cd_pessoa_fisica_w		varchar(10);
nr_seq_marca_w			bigint;
nr_seq_tipo_contrato_w		bigint;
nr_seq_subtipo_contrato_w		bigint;
ie_preco_w			varchar(1);
ie_quantidade_w			varchar(1);
cd_unidade_medida_compra_w	varchar(30);
nr_seq_proj_rec_w                projeto_recurso.nr_sequencia%type;
vl_desconto_w			contrato_regra_nf.vl_desconto%type;
pr_desconto_w			contrato_regra_nf.pr_desconto%type;
cd_local_estoque_w			solic_compra.cd_local_estoque%type;
cd_conta_contabil_w			solic_compra.cd_conta_contabil%type;
cd_centro_custo_w			solic_compra.cd_centro_custo%type;

c01 CURSOR FOR
SELECT	a.cd_pessoa_solicitante,
	c.cd_estabelecimento,
	c.nr_seq_cot_forn,
	c.nr_item_cot_compra,
	c.cd_material,
	c.ds_observacao,
	substr(coalesce(c.ds_marca_fornec,CASE WHEN position('('  c.ds_marca)=0 THEN c.ds_marca  ELSE substr(c.ds_marca,1,position('(' in c.ds_marca)-1) END ),1,30),
	coalesce(c.vl_unitario_material,0),
	coalesce(c.cd_cgc_fornecedor, c.cd_pessoa_fisica),
	c.cd_condicao_pagamento,
	c.cd_unidade_medida_compra,
	c.nr_seq_proj_rec,
	c.vl_desconto,
	c.pr_desconto_forn_item,
	(select max(s.cd_local_estoque) from solic_compra s where s.nr_solic_compra = c.nr_solic_compra) cd_local_estoque,
	(select max(s.cd_conta_contabil) from solic_compra s where s.nr_solic_compra = c.nr_solic_compra) cd_conta_contabil,
	obter_dados_solic_compra(c.nr_solic_compra,7) cd_centro_custo
from	cot_compra a,
	cot_compra_resumo_v c
where	c.nr_cot_compra      = nr_cot_compra_p
and	c.nr_cot_compra      = a.nr_cot_compra
and (substr(obter_se_existe_cot_resumo(c.nr_cot_compra),1,1) = 'S')
order by
	cd_cgc_fornecedor,
	nr_item_cot_compra;


BEGIN

select	CASE WHEN ie_preco_p=0 THEN 'F'  ELSE 'V' END ,
	CASE WHEN ie_quantidade_p=0 THEN 'F'  ELSE 'V' END
into STRICT	ie_preco_w,
	ie_quantidade_w
;

nr_seq_tipo_contrato_w		:= nr_seq_tipo_contrato_p;

if (nr_seq_subtipo_contrato_p = 0) then
	nr_seq_subtipo_contrato_w := null;
else
	nr_seq_subtipo_contrato_w := nr_seq_subtipo_contrato_p;
end if;

open C01;
loop
fetch C01 into
	cd_pessoa_solicitante_w,
	cd_estabelecimento_w,
	nr_seq_fornecedor_w,
	nr_item_cot_compra_w,
	cd_material_w,
	ds_observacao_w,
	ds_marca_w,
	vl_unitario_w,
	cd_cgc_fornecedor_w,
	cd_cond_pagto_w,
	cd_unidade_medida_compra_w,
	nr_seq_proj_rec_w,
	vl_desconto_w,
	pr_desconto_w,
	cd_local_estoque_w,
	cd_conta_contabil_w,
	cd_centro_custo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (coalesce(cd_local_estoque_w::text, '') = '') then
		select	max(a.cd_local_estoque)
		into STRICT	cd_local_estoque_w
		from	solic_compra a
		where	nr_solic_compra = (
			SELECT	max(x.nr_solic_compra)
			from	cot_compra_solic_agrup x
			where	nr_cot_compra = nr_cot_compra_p
			and		nr_item_cot_compra = nr_item_cot_compra_w);
	end if;

	nr_seq_marca_w := null;
	if (ds_marca_w IS NOT NULL AND ds_marca_w::text <> '') then
		select	max(nr_sequencia)
		into STRICT	nr_seq_marca_w
		from	marca
		where	elimina_acentuacao(upper(ds_marca)) = elimina_acentuacao(upper(ds_marca_w));
	end if;

	if (nr_seq_fornecedor_w2 <> nr_seq_fornecedor_w) then

		nr_seq_fornecedor_w2 	:= nr_seq_fornecedor_w;

		if (length(cd_cgc_fornecedor_w) = 14) then
			cd_cgc_fornecedor_w	:= cd_cgc_fornecedor_w;
			cd_pessoa_fisica_w	:= '';
		else
			cd_pessoa_fisica_w	:= cd_cgc_fornecedor_w;
			cd_cgc_fornecedor_w	:= '';
		end if;

		select	nextval('contrato_seq')
		into STRICT	nr_seq_contrato_w
		;

		insert into contrato(
			nr_sequencia,
			nr_seq_tipo_contrato,
			nr_seq_subtipo_contrato,
			cd_pessoa_resp,
			ds_objeto_contrato,
			dt_atualizacao,
			nm_usuario,
			cd_estabelecimento,
			ie_avisa_vencimento,
			ie_avisa_venc_setor,
			ie_classificacao,
			ie_avisa_reajuste,
			ie_prazo_contrato,
			ie_renovacao,
			ie_situacao,
			qt_dias_rescisao,
			cd_cgc_contratado,
			cd_pessoa_contratada,
			cd_condicao_pagamento,
			dt_inicio,
			ie_periodo_nf,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ie_pagar_receber)
		values (	nr_seq_contrato_w,
			nr_seq_tipo_contrato_w,
			nr_seq_subtipo_contrato_w,
			cd_pessoa_solicitante_w,
			Wheb_mensagem_pck.get_Texto(301314, 'NR_COT_COMPRA_P='||nr_cot_compra_p),
			clock_timestamp(),
			nm_usuario_p,
			cd_estabelecimento_w,
			'N',
			'S',
			'AT',
			'N',
			'D',
			'A',
			'A',
			90,
			cd_cgc_fornecedor_w,
			cd_pessoa_fisica_w,
			cd_cond_pagto_w,
			clock_timestamp(),
			'N',
			clock_timestamp(),
			nm_usuario_p,
			ie_pagar_receber_p);

		insert into contrato_regra_nf(
			nr_sequencia,
			nr_seq_contrato,
			dt_atualizacao,
			nm_usuario,
			cd_material,
			cd_estab_regra,
			ie_tipo_regra,
			nr_cot_compra,
			nr_item_cot_compra,
			vl_pagto,
			nr_seq_marca,
			ie_preco,
			ie_quantidade,
			dt_inicio_vigencia,
			dt_fim_vigencia,
			cd_unidade_medida_compra,
			ie_gera_sc_automatico,
			ie_libera_solic,
			nr_seq_proj_rec,
			vl_desconto,
			pr_desconto,
			cd_local_estoque,
			cd_conta_contabil,
			cd_centro_custo,
			dt_atualizacao_nrec,
			nm_usuario_nrec)
		values (	nextval('contrato_regra_nf_seq'),
			nr_seq_contrato_w,
			clock_timestamp(),
			nm_usuario_p,
			cd_material_w,
			cd_estabelecimento_w,
			'NF',
			nr_cot_compra_p,
			nr_item_cot_compra_w,
			vl_unitario_w,
			nr_seq_marca_w,
			ie_preco_w,
			ie_quantidade_w,
			dt_inicio_vigencia_p,
			dt_fim_vigencia_p,
			cd_unidade_medida_compra_w,
			'N',
			'S',
			nr_seq_proj_rec_w,
			vl_desconto_w,
			pr_desconto_w,
			cd_local_estoque_w,
			cd_conta_contabil_w,
			cd_centro_custo_w,
			clock_timestamp(),
			nm_usuario_p);


	else

		insert into contrato_regra_nf(
			nr_sequencia,
			nr_seq_contrato,
			dt_atualizacao,
			nm_usuario,
			cd_material,
			cd_estab_regra,
			ie_tipo_regra,
			nr_cot_compra,
			nr_item_cot_compra,
			vl_pagto,
			nr_seq_marca,
			ie_preco,
			ie_quantidade,
			dt_inicio_vigencia,
			dt_fim_vigencia,
			cd_unidade_medida_compra,
			ie_gera_sc_automatico,
			ie_libera_solic,
			nr_seq_proj_rec,
			vl_desconto,
			pr_desconto,
			cd_local_estoque,
			cd_conta_contabil,
			cd_centro_custo,
			dt_atualizacao_nrec,
			nm_usuario_nrec)
		values (	nextval('contrato_regra_nf_seq'),
			nr_seq_contrato_w,
			clock_timestamp(),
			nm_usuario_p,
			cd_material_w,
			cd_estabelecimento_w,
			'NF',
			nr_cot_compra_p,
			nr_item_cot_compra_w,
			vl_unitario_w,
			nr_seq_marca_w,
			ie_preco_w,
			ie_quantidade_w,
			dt_inicio_vigencia_p,
			dt_fim_vigencia_p,
			cd_unidade_medida_compra_w,
			'N',
			'S',
			nr_seq_proj_rec_w,
			vl_desconto_w,
			pr_desconto_w,
			cd_local_estoque_w,
			cd_conta_contabil_w,
			cd_centro_custo_w,
			clock_timestamp(),
			nm_usuario_p);


	end if;

	update	cot_compra_forn_item
	set	nr_seq_contrato		= nr_seq_contrato_w
	where	nr_cot_compra		= nr_cot_compra_p
	and	nr_item_cot_compra	= nr_item_cot_compra_w
	and	nr_seq_cot_forn		= nr_seq_fornecedor_w
	and	coalesce(nr_seq_contrato::text, '') = '';

	update	cot_compra_forn
	set	ie_status = 'FH'
	where	nr_sequencia = nr_seq_fornecedor_w;

	end;

end loop;
close c01;

CALL baixar_sc_com_contrato(nr_cot_compra_p, nm_usuario_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_contrato_cotacao ( nr_cot_compra_p bigint, nr_seq_tipo_contrato_p bigint, nr_seq_subtipo_contrato_p bigint, dt_inicio_vigencia_p timestamp, dt_fim_vigencia_p timestamp, ie_preco_p bigint, ie_quantidade_p bigint, nm_usuario_p text, ie_pagar_receber_p text default null) FROM PUBLIC;

