-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_fornec_mat_aut_cirurgia ( nr_seq_autorizacao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_sequencia_w		bigint;
cd_fornecedor_w		varchar(14);
ds_razao_social_w	varchar(80);
cd_material_w		integer;
cd_convenio_w		integer;
vl_material_w		double precision;

C00 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.cd_material,
		c.cd_convenio
	from	agenda_paciente c,
		material_autor_cirurgia a,
		autorizacao_cirurgia b
	where	a.nr_seq_autorizacao 	= b.nr_sequencia
	and	b.nr_seq_agenda		= c.nr_sequencia
	and	a.nr_seq_autorizacao 	= nr_seq_autorizacao_p;

C01 CURSOR FOR
	SELECT	distinct a.cd_cgc_fornec,
		0
	from	convenio_preco_fornec a,
		convenio_preco_mat_fornec b
	where 	b.nr_seq_conv_preco = a.nr_sequencia
	and	b.cd_material = cd_material_w
	and	a.cd_convenio = cd_convenio_w
	and	clock_timestamp() between a.dt_inicio_vigencia and dt_fim_vigencia
	and	not exists (	SELECT	1
				from	material_autor_cirurgia y,
					material_autor_cir_cot x
				where	x.nr_sequencia		= y.nr_sequencia
				and	x.cd_cgc 		= a.cd_cgc_fornec
				and	y.cd_material 		= b.cd_material
				and	y.nr_seq_autorizacao 	= nr_sequencia_w);

BEGIN

open C00;
loop
fetch c00 into
		nr_sequencia_w,
		cd_material_w,
		cd_convenio_w;
EXIT WHEN NOT FOUND; /* apply on C00 */
	open C01;
	loop
	fetch c01 into
			cd_fornecedor_w,
			vl_material_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */

			insert into	material_autor_cir_cot(
							nr_sequencia,
							cd_cgc,
							dt_atualizacao,
							nm_usuario,
							vl_cotado,
							cd_condicao_pagamento,
							vl_unitario_cotado,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							ie_aprovacao,
							nr_seq_marca
							)
			values (
							nr_sequencia_w,
							cd_fornecedor_w,
							clock_timestamp(),
							nm_usuario_p,
							vl_material_w,
							null,
							vl_material_w,
							clock_timestamp(),
							nm_usuario_p,
							'N',
							null
							);
	end loop;
	close C01;
end loop;
close C00;

commit;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_fornec_mat_aut_cirurgia ( nr_seq_autorizacao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

