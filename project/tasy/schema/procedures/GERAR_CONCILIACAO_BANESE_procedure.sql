-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_conciliacao_banese (nr_seq_extrato_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_agencia_w    	varchar(15);
cd_historico_w    	varchar(10);
ds_historico_w    	varchar(255);
nr_documento_w    	varchar(50);
dt_movto_w    		timestamp;
vl_extrato_w    	double precision;
ie_deb_cred_w    	varchar(5);
ie_natureza_w    	varchar(10);
cd_categoria_w    	varchar(10);
nr_seq_conta_w    	bigint;
vl_saldo_inicial_w  	double precision;
vl_saldo_final_w  	double precision;
dt_saldo_inicial_w  	timestamp;
dt_saldo_final_w  	timestamp;
ie_digito_conta_w  	varchar(1);
cd_conta_w    		varchar(12);
cd_agencia_bancaria_w  	varchar(5);
cd_banco_w    		smallint;

c01 CURSOR FOR
SELECT  substr(ds_conteudo,53,5),
  	substr(ds_conteudo,170,3),
	substr(ds_conteudo,173,4),
	substr(ds_conteudo,177,25),
	substr(ds_conteudo,202,39),
	substr(ds_conteudo,143,8),
	somente_numero(substr(ds_conteudo,151,16)) || ',' || LPAD(somente_numero(substr(ds_conteudo,167,2)),2,0),
	substr(ds_conteudo,169,1),
  	CASE WHEN substr(ds_conteudo,109,3)='DPV' THEN 'D' WHEN substr(ds_conteudo,109,3)='SCR' THEN 'V'  ELSE 'B' END
from  	w_interf_concil
where  	substr(ds_conteudo,8,1)      		= '3'
and  	somente_numero(substr(ds_conteudo,1,3)) = cd_banco_w
and  	substr(ds_conteudo,53,5)     		= lpad(cd_agencia_bancaria_w,5,0)
and  	substr(ds_conteudo,59,12)     		= cd_conta_w
and  	substr(ds_conteudo,71,1)     		= ie_digito_conta_w
and  	nr_seq_conta   				= nr_seq_conta_w;


BEGIN

select	e.nr_seq_conta,
  	lpad(b.cd_agencia_bancaria,5,'0'),
  	lpad(b.cd_conta,12,'0'),
  	b.ie_digito_conta,
  	b.cd_banco
into STRICT  	nr_seq_conta_w,
  	cd_agencia_bancaria_w,
  	cd_conta_w,
  	ie_digito_conta_w,
  	cd_banco_w
from  	banco_extrato e,
  	banco_estabelecimento b
where  	e.nr_sequencia    = nr_seq_extrato_p
and  	e.nr_seq_conta    = b.nr_sequencia;

begin
select	CASE WHEN substr(ds_conteudo,169,1)='D' THEN             -1*somente_numero(substr(ds_conteudo,151,16)) || ',' || LPAD(somente_numero(substr(ds_conteudo,167,2)),2,0)  ELSE somente_numero(substr(ds_conteudo,151,16)) || ',' || LPAD(somente_numero(substr(ds_conteudo,167,2)),2,0) END ,
  	substr(ds_conteudo,143,8)
into STRICT  	vl_saldo_inicial_w,
  	dt_saldo_inicial_w
from  	w_interf_concil
where  	substr(ds_conteudo,8,1)       		= '1'
and  	somente_numero(substr(ds_conteudo,1,3)) = cd_banco_w
and  	substr(ds_conteudo,53,5)       		= cd_agencia_bancaria_w
and  	substr(ds_conteudo,59,12)       	= cd_conta_w
and  	substr(ds_conteudo,71,1)       		= ie_digito_conta_w
and  	nr_seq_conta          			= nr_seq_conta_w;
exception
  when no_data_found then
  /*r.aise_application_error(-20011,'Os dados do arquivo n√£o conferem com os dados da conta! ' || chr(13) ||
        'cd_banco_w = ' || cd_banco_w ||chr(13) ||
        'cd_agencia_w= ' || cd_agencia_bancaria_w || chr(13) ||
        'cd_conta_w= ' || cd_conta_w || chr(13) ||
        'ie_digito_conta_w= ' || ie_digito_conta_w);*/
		CALL wheb_mensagem_pck.exibir_mensagem_abort(267410,	'cd_banco_w=' || cd_banco_w || ';' ||
								'cd_agencia_w=' || cd_agencia_w || ';' ||
								'cd_conta_w=' || cd_conta_w || ';' ||
								'ie_digito_conta_w=' || ie_digito_conta_w);
end;

select  CASE WHEN substr(ds_conteudo,169,1)='D' THEN             -1*somente_numero(substr(ds_conteudo,151,16)) || ',' || LPAD(somente_numero(substr(ds_conteudo,167,2)),2,0)  ELSE somente_numero(substr(ds_conteudo,151,16)) || ',' || LPAD(somente_numero(substr(ds_conteudo,167,2)),2,0) END ,
  	substr(ds_conteudo,143,8)
into STRICT  	vl_saldo_final_w,
  	dt_saldo_final_w
from  	w_interf_concil
where  	substr(ds_conteudo,8,1)       		= '5'
and  	somente_numero(substr(ds_conteudo,1,3)) = cd_banco_w
and  	substr(ds_conteudo,53,5)       		= cd_agencia_bancaria_w
and  	substr(ds_conteudo,59,12)       	= cd_conta_w
and  	substr(ds_conteudo,71,1)       		= ie_digito_conta_w
and  	nr_seq_conta          			= nr_seq_conta_w;

open c01;
loop
fetch c01 into
  cd_agencia_w,
  cd_categoria_w,
  cd_historico_w,
  ds_historico_w,
  nr_documento_w,
  dt_movto_w,
  vl_extrato_w,
  ie_deb_cred_w,
  ie_natureza_w;
EXIT WHEN NOT FOUND; /* apply on c01 */



insert into banco_extrato_lanc(cd_agencia_origem,
    cd_categoria,
    cd_historico,
    ds_historico,
    dt_atualizacao,
    dt_atualizacao_nrec,
    dt_movimento,
    ie_conciliacao,
    ie_deb_cred,
    ie_natureza,
    nm_usuario,
    nm_usuario_nrec,
    nr_documento,
    nr_seq_extrato,
    nr_sequencia,
    vl_lancamento)
values (cd_agencia_w,
    cd_categoria_w,
    cd_historico_w,
    ds_historico_w,
    clock_timestamp(),
    clock_timestamp(),
    dt_movto_w,
    'N',
    ie_deb_cred_w,
    ie_natureza_w,
    nm_usuario_p,
    nm_usuario_p,
    nr_documento_w,
    nr_seq_extrato_p,
    nextval('banco_extrato_lanc_seq'),
    vl_extrato_w);
end loop;
close c01;

update  banco_extrato
set	vl_saldo_inicial   	= vl_saldo_inicial_w,
  	vl_saldo_final    	= vl_saldo_final_w,
  	dt_inicio    		= dt_saldo_inicial_w,
  	dt_final    		= dt_saldo_final_w
where  nr_sequencia    		= nr_seq_extrato_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_conciliacao_banese (nr_seq_extrato_p bigint, nm_usuario_p text) FROM PUBLIC;

