-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE json_insert_elements_sql (nr_seq_elemento_p bigint, nm_usuario_p text) AS $body$
DECLARE


    c001               integer;
    ds_sql_w           json_elemento.ds_sql%type;
    nm_atributo_w      varchar(255);
    qt_column_w        bigint;
    nm_column_w        dbms_sql.desc_tab2;
    nr_seq_projeto_w   json_elemento.nr_seq_projeto%type;
    qt_pos_w           bigint;
    qt_registros_w     bigint;
    nr_sequencia_rem_w bigint;

BEGIN
    begin
        select max(ds_sql),
               max(nr_seq_projeto)
          into STRICT ds_sql_w,
               nr_seq_projeto_w
          from json_elemento
         where nr_sequencia = nr_seq_elemento_p;

        c001 := dbms_sql.open_cursor;
        dbms_sql.parse(c001, ds_sql_w, dbms_sql.native);

        dbms_sql.describe_columns2(c001, qt_column_w, nm_column_w);

        if (qt_column_w < 1000) then
        
            for i in 1 .. qt_column_w loop
                nm_atributo_w := nm_column_w[i].col_name;
                qt_pos_w      := i;

                select count(*)
                  into STRICT qt_registros_w
                  from json_elemento
                 where nm_atributo = nm_atributo_w
                   and nr_seq_elemento_sup = nr_seq_elemento_p;

                if (qt_registros_w = 0) then
                
                    $if $$tasy_local_dict=true $then
                    nr_sequencia_rem_w := get_remote_sequence('seq:json_elemento_seq');
                    $else
                    select nextval('json_elemento_seq') into STRICT nr_sequencia_rem_w;
                    $end

                    insert into json_elemento(nr_sequencia,
                         dt_atualizacao,
                         nm_usuario,
                         dt_atualizacao_nrec,
                         nm_usuario_nrec,
                         nr_seq_projeto,
                         nr_seq_apresentacao,
                         nr_seq_elemento_sup,
                         nm_elemento,
                         nm_atributo,
                         ie_array,
                         ie_criar_nulo)
                    values (nr_sequencia_rem_w, --json_elemento_seq.nextval,
                         clock_timestamp(),
                         nm_usuario_p,
                         clock_timestamp(),
                         nm_usuario_p,
                         nr_seq_projeto_w,
                         qt_pos_w,
                         nr_seq_elemento_p,
                         lower(nm_atributo_w),
                         nm_atributo_w,
                         'N',
                         'S');
                end if;
            end loop;
        end if;
        dbms_sql.close_cursor(c001);

    exception
        when others then
            dbms_sql.close_cursor(c001);
            rollback;
    end;

    commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE json_insert_elements_sql (nr_seq_elemento_p bigint, nm_usuario_p text) FROM PUBLIC;

