-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_insert_interface (cd_interface_p bigint, nm_usuario_p text) AS $body$
DECLARE


nm_tabela_w	varchar(255);
nm_atributo_w	varchar(255);
ds_colunas_w	varchar(4000)	:= null;
ds_valores_w	varchar(4000)	:= null;
ds_consulta_w	varchar(2000);
vl_atributo_w	varchar(255);
ie_ordem_w	bigint;
cd_interface_w	bigint;
cd_reg_interface_w	smallint;
nr_seq_atributo_w	integer;
ds_comando_w	varchar(4000);

c01 CURSOR FOR
SELECT	1 ie_ordem,
	'INTERFACE',
	a.cd_interface,
	null,
	null
from	interface a
where	a.cd_interface = cd_interface_p

union all

select	2 ie_ordem,
	'INTERFACE_REG',
	a.cd_interface,
	a.cd_reg_interface,
	null
from	interface_reg a
where	a.cd_interface = cd_interface_p

union all

select	3 ie_ordem,
	'INTERFACE_ATRIBUTO',
	a.cd_interface,
	a.cd_reg_interface,
	a.nr_seq_atributo
from	interface_atributo a
where	a.cd_interface = cd_interface_p
order by
	ie_ordem;


c02 CURSOR FOR
SELECT	a.column_name
from	user_tab_columns a
where	a.table_name = nm_tabela_w
order by
	a.column_name;


BEGIN

delete from w_retorno_banco;

open c01;
loop
fetch c01 into
	ie_ordem_w,
	nm_tabela_w,
	cd_interface_w,
	cd_reg_interface_w,
	nr_seq_atributo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	ds_colunas_w	:= null;
	ds_valores_w	:= null;

	open c02;
	loop
	fetch c02 into
		nm_atributo_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		if (coalesce(ds_colunas_w::text, '') = '') then
			ds_colunas_w	:= nm_atributo_w;
		else
			ds_colunas_w	:= ds_colunas_w || ',' || nm_atributo_w;
		end if;

		if (nm_tabela_w = 'INTERFACE') then
			ds_consulta_w	:= 'select ' || nm_atributo_w || ' from interface where cd_interface = :cd_interface';
			vl_atributo_w := obter_valor_dinamico_char_bv(ds_consulta_w, 'cd_interface=' || cd_interface_w, vl_atributo_w);
		elsif (nm_tabela_w = 'INTERFACE_REG') then
			ds_consulta_w	:= 'select ' || nm_atributo_w || ' from interface_reg where cd_interface = :cd_interface' ||
						' and cd_reg_interface = :cd_reg_interface';
			vl_atributo_w := obter_valor_dinamico_char_bv(ds_consulta_w, 'cd_interface=' || cd_interface_w || ';' ||
								'cd_reg_interface=' || cd_reg_interface_w || ';', vl_atributo_w);
		elsif (nm_tabela_w = 'INTERFACE_ATRIBUTO') then
			ds_consulta_w	:= 'select ' || nm_atributo_w || ' from interface_atributo where cd_interface = :cd_interface' ||
						' and cd_reg_interface = :cd_reg_interface and nr_seq_atributo = :nr_seq_atributo';
			vl_atributo_w := obter_valor_dinamico_char_bv(ds_consulta_w, 'cd_interface=' || cd_interface_w || ';' ||
								'cd_reg_interface=' || cd_reg_interface_w || ';' ||
								'nr_seq_atributo=' || nr_seq_atributo_w || ';', vl_atributo_w);
		end if;

		if (coalesce(ds_valores_w::text, '') = '') then
			ds_valores_w	:= chr(39) || vl_atributo_w || chr(39);
		else
			ds_valores_w	:= ds_valores_w || ',' || chr(39) || vl_atributo_w || chr(39);
		end if;

		end;
	end loop;
	close c02;

	ds_comando_w	:= 'insert into ' || nm_tabela_w || '(' || ds_colunas_w || ') values (' || ds_valores_w || ');';

	insert into w_retorno_banco(nr_sequencia,
		nm_usuario,
		dt_atualizacao,
		ds_string)
	values (nextval('w_retorno_banco_seq'),
		nm_usuario_p,
		clock_timestamp(),
		ds_comando_w);

	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_insert_interface (cd_interface_p bigint, nm_usuario_p text) FROM PUBLIC;

