-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_cancelar_repasse_mens ( nr_seq_repasse_mens_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
Cancelar a comissão do lote de repasse.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [ X] Tasy (Delphi/Java) [   ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_repasse_mens_w		pls_repasse_mens.nr_sequencia%type;
nr_seq_repasse_w		pls_repasse_vend.nr_sequencia%type;

C01 CURSOR FOR
	SELECT	nr_sequencia,
		ie_tipo_item,
		pr_repasse,
		vl_repasse,
		nr_seq_mensalidade_seg_item,
		nr_seq_plano_sca,
		vl_item,
		ie_sca_embutido,
		vl_premio,
		vl_incremento,
		tx_divisao_repasse,
		nr_seq_plano,
		nr_seq_bonificacao,
		vl_origem
	from	pls_repasse_mens_item
	where	nr_seq_repasse = nr_seq_repasse_mens_p;

BEGIN

if (nr_seq_repasse_mens_p IS NOT NULL AND nr_seq_repasse_mens_p::text <> '') then
	select	nr_seq_repasse
	into STRICT	nr_seq_repasse_w
	from	pls_repasse_mens
	where	nr_sequencia	= nr_seq_repasse_mens_p;

	select	nextval('pls_repasse_mens_seq')
	into STRICT	nr_seq_repasse_mens_w
	;

	insert	into pls_repasse_mens(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_vendedor,
		nr_seq_repasse,
		nr_seq_mens_seg,
		vl_repasse,
		vl_origem,
		pr_comissao,
		ie_acao_contrato,
		nr_seq_vendedor_resp,
		nr_seq_segurado,
		nr_seq_plano,
		nr_seq_plano_sca,
		nr_parcela_benef,
		ie_comissao_repasse,
		ie_cancelamento,
		dt_cancelamento,
		nr_seq_repasse_cancel,
		vl_item_comissao,
		ie_status,
		dt_adesao_contrato,
		dt_liberacao_beneficiario,
		nr_seq_regra_mensal,
		cd_conta_deb,
		cd_conta_cred,
		nm_usuario_cancelamento,
		nr_seq_proposta)
	(SELECT	nr_seq_repasse_mens_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_vendedor,
		nr_seq_repasse,
		nr_seq_mens_seg,
		(vl_repasse * -1),
		(vl_origem * -1),
		pr_comissao,
		ie_acao_contrato,
		nr_seq_vendedor_resp,
		nr_seq_segurado,
		nr_seq_plano,
		nr_seq_plano_sca,
		nr_parcela_benef,
		ie_comissao_repasse,
		'E',
		clock_timestamp(),
		nr_seq_repasse_mens_p,
		(vl_item_comissao * -1),
		'AU',
		dt_adesao_contrato,
		dt_liberacao_beneficiario,
		nr_seq_regra_mensal,
		cd_conta_deb,
		cd_conta_cred,
		nm_usuario_p,
		nr_seq_proposta
	from	pls_repasse_mens
	where	nr_sequencia = nr_seq_repasse_mens_p);

	for r_c01_w in c01 loop
		insert	into pls_repasse_mens_item(nr_sequencia, nr_seq_repasse, ie_tipo_item,
			dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
			nm_usuario_nrec, pr_repasse, vl_repasse, vl_origem,
			nr_seq_mensalidade_seg_item, nr_seq_plano_sca, vl_item,
			ie_sca_embutido, vl_premio, vl_incremento,
			tx_divisao_repasse, nr_seq_plano, nr_seq_bonificacao)
		values (nextval('pls_repasse_mens_item_seq'), nr_seq_repasse_mens_w, r_c01_w.ie_tipo_item,
			clock_timestamp(), nm_usuario_p, clock_timestamp(),
			nm_usuario_p, r_c01_w.pr_repasse, (r_c01_w.vl_repasse * -1), (r_c01_w.vl_origem * -1),
			r_c01_w.nr_seq_mensalidade_seg_item, r_c01_w.nr_seq_plano_sca, (r_c01_w.vl_item * -1),
			r_c01_w.ie_sca_embutido, (r_c01_w.vl_premio * -1), (r_c01_w.vl_incremento * -1),
			r_c01_w.tx_divisao_repasse, r_c01_w.nr_seq_plano, r_c01_w.nr_seq_bonificacao);
	end loop;

	update	pls_repasse_mens
	set	ie_cancelamento		= 'C',
		dt_cancelamento		= clock_timestamp(),
		nm_usuario_cancelamento = nm_usuario_p
	where	nr_sequencia = nr_seq_repasse_mens_p;


	delete	from	pls_repasse_vend_venc
	where	nr_seq_repasse	= nr_seq_repasse_w;

	CALL pls_gerar_venc_repasse(nr_seq_repasse_w, 'S', nm_usuario_p);

	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_cancelar_repasse_mens ( nr_seq_repasse_mens_p bigint, nm_usuario_p text) FROM PUBLIC;

