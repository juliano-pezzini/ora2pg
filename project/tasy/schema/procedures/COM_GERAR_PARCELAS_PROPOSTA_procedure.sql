-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE com_gerar_parcelas_proposta ( dt_inicio_parcela_p timestamp, qt_parcela_p bigint, nr_seq_proposta_item_p bigint, nm_usuario_p text) AS $body$
DECLARE


vl_total_w		double precision;
qt_parcela_atual_W	bigint;
dt_vencimento_w		timestamp;
vl_parcela_w		double precision;

BEGIN
select	max(vl_item)
into STRICT	vl_total_w
from	COM_CLIENTE_PROP_ITEM
where 	nr_sequencia = nr_seq_proposta_item_p;

vl_parcela_w := round((vl_total_w / qt_parcela_p)::numeric,4);

qt_parcela_atual_W := 1;

dt_vencimento_w := dt_inicio_parcela_p;

while(qt_parcela_atual_w <= qt_parcela_p) loop
	begin
	insert into com_cliente_prop_parc(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		nr_seq_prop_item,
		dt_vencimento,
		vl_parcela,
		dt_atualizacao_nrec,
		nm_usuario_nrec)
	values (	nextval('com_cliente_prop_parc_seq'),
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_proposta_item_p,
		dt_vencimento_w,
		vl_parcela_w,
		clock_timestamp(),
		nm_usuario_p);

	dt_vencimento_w := PKG_DATE_UTILS.ADD_MONTH(dt_inicio_parcela_p,qt_parcela_atual_w,0);
	qt_parcela_atual_w := qt_parcela_atual_w + 1;
	end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE com_gerar_parcelas_proposta ( dt_inicio_parcela_p timestamp, qt_parcela_p bigint, nr_seq_proposta_item_p bigint, nm_usuario_p text) FROM PUBLIC;

