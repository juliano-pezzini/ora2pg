-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_solic_compra_prescricao ( nr_prescricao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_material_w			integer;
cd_unidade_medida_w		varchar(30);
qt_material_w			double precision;
cd_setor_atendimento_w		integer;
nr_solic_compra_w			bigint := 0;
qt_dias_entrega_padrao_w		bigint := 0;
cd_pessoa_fisica_w		varchar(10);
cd_centro_custo_w			bigint;
nm_paciente_w			varchar(100);
nr_atendimento_w			bigint;
dt_entrega_solic_w			timestamp;
nr_item_w			integer;
vl_ultima_compra_w		double precision;
nr_seq_nf_w			bigint;
qt_conv_estoque_consumo_w	double precision;
qt_conv_compra_estoque_w		double precision;
cd_unidade_medida_compra_w	varchar(30);
cd_unidade_medida_consumo_w	varchar(30);
qt_comprar_w			double precision := 0;
qt_conversao_w			double precision;
VarDataLiberacaoSeConsig_w	varchar(1);
VarDtLiberacaoNaoPadro_w		varchar(1);
qt_existe_w			bigint;
ie_incluir_NTP_w		varchar(1);
						
c01 CURSOR FOR			
SELECT	a.cd_material,
	a.cd_unidade_medida,
	sum(a.qt_material) qt_material,
	obter_setor_prescricao(nr_prescricao_p, 'C') cd_setor_atendimento
from	prescr_material a
where 	a.nr_prescricao = nr_prescricao_p
and	coalesce(a.nr_sequencia_solucao::text, '') = ''
and	coalesce(a.nr_sequencia_dieta::text, '') = ''  
and	coalesce(a.nr_sequencia_diluicao::text, '') = ''  
and   	coalesce(a.dt_suspensao::text, '') = ''  
and	coalesce(a.ie_administrar,'S') = 'S' 
and	a.ie_agrupador in (1,5)  
and	obter_tipo_material(a.cd_material, 'C') in (0,2,3)
and	a.ie_regra_disp = 'S'
and	a.qt_material > 0
and	obter_se_material_padronizado(cd_estabelecimento_p, a.cd_material) = 'N'
group by	a.cd_material,
	a.cd_unidade_medida

union

SELECT	a.cd_material,
	a.cd_unidade_medida,
	sum(a.qt_solucao) qt_solucao,
	obter_setor_prescricao(nr_prescricao_p, 'C') cd_setor_atendimento
from 	prescr_material a
where 	nr_prescricao = nr_prescricao_p
and 	a.ie_agrupador = 4
and	a.ie_regra_disp = 'S'
and	a.qt_solucao > 0
and	obter_se_material_padronizado(cd_estabelecimento_p, a.cd_material) = 'N'
and 	a.nr_sequencia_solucao in ( 
 	select	x.nr_seq_solucao
	from    prescr_solucao x
	where   x.nr_prescricao = nr_prescricao_p)
group by	a.cd_material,
	a.cd_unidade_medida

union

select	a.cd_material,
	a.cd_unidade_medida,
	sum(a.qt_dose) qt_material,
	obter_setor_prescricao(nr_prescricao_p, 'C') cd_setor_atendimento
from	prescr_material a
where	a.nr_prescricao = nr_prescricao_p
and	a.ie_agrupador = 12		
and	a.ie_regra_disp = 'S'
and	a.qt_dose > 0
and	obter_se_material_padronizado(cd_estabelecimento_p, a.cd_material) = 'N'	
group by	a.cd_material,
	a.cd_unidade_medida

union

select	b.cd_material,
	b.cd_unidade_medida,
	sum(b.qt_dose),
	obter_setor_prescricao(nr_prescricao_p, 'C') cd_setor_atendimento
from	nut_pac_elem_mat b,
	nut_pac a
where	b.nr_seq_nut_pac  = a.nr_sequencia
and	a.nr_prescricao = nr_prescricao_p
and	obter_se_material_padronizado(cd_estabelecimento_p, b.cd_material) = 'N'
and	b.qt_dose > 0
and	ie_incluir_NTP_w = 'S'
group by b.cd_material,
	b.cd_unidade_medida;


BEGIN


if (obter_funcao_ativa = 252) then
	VarDataLiberacaoSeConsig_w := Obter_Valor_Param_Usuario(252, 42, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p);
	VarDtLiberacaoNaoPadro_w := Obter_Valor_Param_Usuario(252, 43, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p);
	ie_incluir_NTP_w 		 := Obter_Valor_Param_Usuario(252, 53, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p);
else
	select (max(Obter_Valor_Param_Usuario(7010, 68, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p))),
		(max(Obter_Valor_Param_Usuario(7010, 69, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p))),
		(max(Obter_Valor_Param_Usuario(7010, 138, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)))
	into STRICT	VarDataLiberacaoSeConsig_w,
		VarDtLiberacaoNaoPadro_w,
		ie_incluir_NTP_w
	;
end if;

open C01;
loop
fetch C01 into	
	cd_material_w,
	cd_unidade_medida_w,
	qt_material_w,
	cd_setor_atendimento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin	
	
	if (nr_solic_compra_w = 0) then
	
		select	nr_atendimento,
			substr(obter_nome_pf_pj(cd_pessoa_fisica,null),1,100)
		into STRICT	nr_atendimento_w,
			nm_paciente_w
		from	prescr_medica
		where	nr_prescricao = nr_prescricao_p;
		
		select	coalesce(qt_dias_entrega_padrao,2)
		into STRICT	qt_dias_entrega_padrao_w
		from	parametro_compras
		where	cd_estabelecimento = cd_estabelecimento_p;

		select	cd_pessoa_fisica
		into STRICT	cd_pessoa_fisica_w
		from	usuario
		where	nm_usuario = nm_usuario_p;
		
		select	obter_centro_custo_setor(cd_setor_atendimento_w, 'C')
		into STRICT	cd_centro_custo_w
		;

		dt_entrega_solic_w  := trunc(clock_timestamp(),'dd') + qt_dias_entrega_padrao_w;
		
		if (coalesce(cd_pessoa_fisica_w::text, '') = '') then
			/*(-20011,'Erro ao gerar solicitacao de compras. O usuario ' || NM_USUARIO_P || ' nao possui nenhuma pessoa fisica vinculada.');*/

			CALL wheb_mensagem_pck.exibir_mensagem_abort(201268,'NM_USUARIO_P='||NM_USUARIO_P);
		end if;
		
		select	nextval('solic_compra_seq')
		into STRICT	nr_solic_compra_w
		;
		
		insert into solic_compra(
			nr_solic_compra,
			cd_estabelecimento,
			dt_solicitacao_compra,
			dt_atualizacao,
			nm_usuario,
			ie_situacao,
			cd_pessoa_solicitante,
			cd_centro_custo,
			cd_setor_atendimento,
			ds_observacao,
			ie_aviso_chegada,
			ie_aviso_aprov_oc,
			ie_urgente,
			ie_tipo_solicitacao,
			ie_comodato,
			ie_semanal,
			nr_prescricao,
			nm_usuario_nrec,
			dt_atualizacao_nrec)
		values (	nr_solic_compra_w,
			cd_estabelecimento_p,
			clock_timestamp(),
			clock_timestamp(),
			nm_usuario_p,
			'A',
			cd_pessoa_fisica_w,
			cd_centro_custo_w,
			cd_setor_atendimento_w,
			substr(WHEB_MENSAGEM_PCK.get_texto(302218,'NM_PACIENTE_W='|| NM_PACIENTE_W ||';NR_ATENDIMENTO_W='|| NR_ATENDIMENTO_W ||';NR_PRESCRICAO_P='|| NR_PRESCRICAO_P),1,2000), /*Paciente: #@NM_PACIENTE_W#@ - Atend: #@NR_ATENDIMENTO_W#@ - Prescr: #@NR_PRESCRICAO_P#@*/
			'N',
			'N',
			'N',
			'7',
			'N',
			'N',
			nr_prescricao_p,
			nm_usuario_p,
			clock_timestamp());
	end if;

	SELECT * FROM Obter_ultima_compra_material(
				cd_estabelecimento_p, cd_material_w, cd_unidade_medida_w, 'C', clock_timestamp() - interval '365 days', nr_seq_nf_w, vl_ultima_compra_w) INTO STRICT nr_seq_nf_w, vl_ultima_compra_w;
				
				
	select	qt_conv_estoque_consumo,
		qt_conv_compra_estoque,
		substr(obter_dados_material_estab(cd_material,cd_estabelecimento_p,'UMC'),1,255) cd_unidade_medida_compra,
		substr(obter_dados_material_estab(cd_material,cd_estabelecimento_p,'UMS'),1,255) cd_unidade_medida_consumo
	into STRICT	qt_conv_estoque_consumo_w,
		qt_conv_compra_estoque_w,
		cd_unidade_medida_compra_w,
		cd_unidade_medida_consumo_w
	from	material
	where	cd_material = cd_material_w;
	
	qt_comprar_w := qt_material_w;
	
	if (cd_unidade_medida_w <> cd_unidade_medida_consumo_w) then
		select	coalesce(max(qt_conversao) ,1)
		into STRICT	qt_conversao_w
		from	material_conversao_unidade
		where	cd_material = cd_material_w
		and	cd_unidade_medida = cd_unidade_medida_w;
		qt_comprar_w := dividir(qt_comprar_w, qt_conversao_w);
	end if;
	
	qt_comprar_w := dividir(qt_comprar_w, qt_conv_estoque_consumo_w);	
	qt_comprar_w := dividir(qt_comprar_w, qt_conv_compra_estoque_w);
	
	if	((qt_comprar_w mod 1) > 0) then
		qt_comprar_w := round(qt_comprar_w) + 1;	
	end if;
	
	if (qt_comprar_w = 0) then
		qt_comprar_w := 1;
	end if;	
	
	CALL Gerar_Solic_Compra_Item(
				nr_solic_compra_w,
				cd_material_w,
				'C',
				qt_comprar_w,
				dt_entrega_solic_w,
				nm_usuario_p,
				'S',
				365,
				'');
				
	if (VarDataLiberacaoSeConsig_w = 'N') then
		
		select count(*)
		into STRICT	qt_existe_w
		from	solic_compra_item
		where	obter_se_mat_consignado(cd_material) = '1'
		and 	nr_solic_compra = nr_solic_compra_w;
		
		if (qt_existe_w = 0 ) and (VarDtLiberacaoNaoPadro_w = 'S')then
			
			update 	solic_compra
			set	dt_liberacao 		= clock_timestamp(),
				nm_usuario_lib		= nm_usuario_p,
				dt_autorizacao		= clock_timestamp(),
				cd_pessoa_autoriza		= cd_pessoa_fisica_w
			where	nr_solic_compra		= nr_solic_compra_w;
		end if;
	else	
		if (VarDtLiberacaoNaoPadro_w = 'S') then
		
		update 	solic_compra
		set	dt_liberacao 		= clock_timestamp(),
			nm_usuario_lib		= nm_usuario_p,
			dt_autorizacao		= clock_timestamp(),
			cd_pessoa_autoriza		= cd_pessoa_fisica_w
		where	nr_solic_compra		= nr_solic_compra_w;
		
		end if;
	end if;
				
				
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_solic_compra_prescricao ( nr_prescricao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

