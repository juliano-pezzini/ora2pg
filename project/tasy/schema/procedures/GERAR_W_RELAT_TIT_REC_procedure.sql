-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_relat_tit_rec ( dt_inicial_p timestamp, dt_final_p timestamp, ds_lista_procedimento_p text, ds_situacao_titulo_p text, ie_dados_p text, ie_data_p bigint, cd_pessoa_fisica_p text, cd_cgc_p text, ie_tipo_titulo_p text, cd_estabelecimento_p text, cd_estrutura_p text, nm_usuario_p text, dt_pc_p timestamp) AS $body$
DECLARE

/*
dt_pc_p = Data Posição Contábil
*/
CD_CGC_W 		varchar(14);
CD_GRUPO_PROC_W    	bigint;
CD_PESSOA_FISICA_W	varchar(10);
CD_PROCEDIMENTO_W 	bigint;
DT_EMISSAO_W      	timestamp;
DT_INCLUSAO_W     	timestamp;
DT_VENCIMENTO_W   	timestamp;
NM_USUARIO_W      	varchar(15);
NR_SEQ_NOTA_W     	bigint;
NR_TITULO_W       	bigint;
VL_PAGO_W         	double precision;
VL_SALDO_W        	double precision;
VL_TITULO_W       	double precision;
DT_LIQUIDACAO_W		timestamp;
IE_ORIGEM_PROCED_W	bigint;
DT_PAGAMENTO_PREVISTO_W timestamp;

C01 CURSOR FOR
SELECT  distinct a.nr_titulo,
	a.cd_pessoa_fisica,
	a.cd_cgc,
	a.nr_seq_nf_saida,
	a.dt_emissao,
	a.dt_vencimento,
	a.dt_liquidacao,
	a.vl_titulo,
        coalesce((select sum(b.vl_recebido)
	 from   titulo_receber_liq b
	 where  a.nr_titulo = b.nr_titulo),0) vl_pago,
	a.vl_saldo_titulo,
	d.cd_grupo_proc,
	d.cd_procedimento,
	d.IE_ORIGEM_PROCED,
	a.dt_pagamento_previsto
FROM titulo_receber a
LEFT OUTER JOIN nota_fiscal b ON (a.nr_seq_nf_saida = b.nr_sequencia)
LEFT OUTER JOIN nota_fiscal_item c ON (b.nr_sequencia = c.nr_sequencia)
LEFT OUTER JOIN procedimento d ON (c.cd_procedimento = d.cd_procedimento)
WHERE ( (coalesce(cd_estrutura_p::text, '') = '') 		or (obter_se_contido(d.cd_grupo_proc, cd_estrutura_p) = 'S')) and ( (coalesce(ds_lista_procedimento_p::text, '') = '') 	or (obter_se_contido(d.cd_procedimento, ds_lista_procedimento_p) = 'S')) and ( ((ie_data_p = 0) and (a.dt_vencimento	between dt_inicial_p and fim_dia(dt_final_p))) or
	  ((ie_data_p = 1) and (a.dt_emissao	between dt_inicial_p and fim_dia(dt_final_p))) or
	  ((ie_data_p = 2) and (a.dt_liquidacao	between dt_inicial_p and fim_dia(dt_final_p))) or
	  ((ie_data_p = 3) and ( (coalesce(a.dt_liquidacao, clock_timestamp() + interval '1000 days') >= dt_pc_p ) and (a.dt_contabil <= dt_pc_p) and
				( (coalesce(a.dt_liquidacao::text, '') = '') OR (a.dt_liquidacao > dt_pc_p))  )) or (ie_data_p = 4) and (a.dt_contabil	between dt_inicial_p and fim_dia(dt_final_p)) or (ie_data_p = 5) or (ie_data_p = 6) and (a.dt_pagamento_previsto	between dt_inicial_p and fim_dia(dt_final_p))) and ( (coalesce(ds_situacao_titulo_p::text, '') = '')	or (obter_se_contido(a.ie_situacao, ds_situacao_titulo_p) = 'S') ) and ( (coalesce(cd_cgc_p::text, '') = '') 			or (Obter_Se_Contido_char(a.cd_cgc, REPLACE(cd_cgc_p,' ','')) = 'S') ) and ( (coalesce(cd_pessoa_fisica_p::text, '') = '')		or (Obter_Se_Contido_char(a.cd_pessoa_fisica, REPLACE(cd_pessoa_fisica_p,' ','')) = 'S') ) and ( (coalesce(ie_tipo_titulo_p::text, '') = '') 		or (obter_se_contido(a.ie_tipo_titulo, ie_tipo_titulo_p) = 'S') ) and ( (coalesce(cd_estabelecimento_p::text, '') = '') 	or (obter_se_contido(a.cd_estabelecimento, cd_estabelecimento_p) = 'S'));


BEGIN

if ( ie_data_p = 3 ) and ( coalesce(dt_pc_p::text, '') = '' ) then
	--Quando a data de referência for Posíção Contábil, é necessário informar a data de posição contábil nos filtros do relatório
	CALL wheb_mensagem_pck.exibir_mensagem_abort(237837);

end if;

delete	from W_REL_TITULO_RECEBER
where 	nm_usuario = nm_usuario_p;

open C01;
loop
fetch C01 into
	NR_TITULO_W,
	CD_PESSOA_FISICA_W,
	CD_CGC_W,
	NR_SEQ_NOTA_W,
	DT_EMISSAO_W,
	DT_VENCIMENTO_W,
	DT_LIQUIDACAO_W,
	VL_TITULO_W,
	VL_PAGO_W,
	VL_SALDO_W,
	CD_GRUPO_PROC_W,
	CD_PROCEDIMENTO_W,
	IE_ORIGEM_PROCED_W,
	DT_PAGAMENTO_PREVISTO_W;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	insert into W_REL_TITULO_RECEBER(	CD_CGC,
				CD_GRUPO_PROC,
				CD_PESSOA_FISICA,
				CD_PROCEDIMENTO,
				DT_EMISSAO,
				DT_INCLUSAO,
				DT_VENCIMENTO,
				DT_LIQUIDACAO,
				NM_USUARIO,
				NR_SEQ_NOTA,
				NR_TITULO,
				VL_PAGO,
				VL_SALDO,
				VL_TITULO,
				IE_ORIGEM_PROCED,
				dt_atualizacao,
				DT_PAGAMENTO_PREVISTO)
			values ( CD_CGC_W,
				CD_GRUPO_PROC_W,
				CD_PESSOA_FISICA_W,
				CD_PROCEDIMENTO_W,
				DT_EMISSAO_W,
				clock_timestamp(),
				DT_VENCIMENTO_W,
				DT_LIQUIDACAO_W,
				NM_USUARIO_P,
				NR_SEQ_NOTA_W,
				NR_TITULO_W,
				VL_PAGO_W,
				VL_SALDO_W,
				VL_TITULO_W,
				IE_ORIGEM_PROCED_W,
				clock_timestamp(),
				DT_PAGAMENTO_PREVISTO_W);

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_relat_tit_rec ( dt_inicial_p timestamp, dt_final_p timestamp, ds_lista_procedimento_p text, ds_situacao_titulo_p text, ie_dados_p text, ie_data_p bigint, cd_pessoa_fisica_p text, cd_cgc_p text, ie_tipo_titulo_p text, cd_estabelecimento_p text, cd_estrutura_p text, nm_usuario_p text, dt_pc_p timestamp) FROM PUBLIC;

