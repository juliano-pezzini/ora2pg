-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baixar_deposito_cheque (nr_seq_deposito_p bigint, dt_deposito_p timestamp, nm_usuario_p text) AS $body$
DECLARE

 
nr_cheque_w		varchar(20);
dt_deposito_w		timestamp;
dt_reapresentacao_w	timestamp;
nr_seq_cheque_w		bigint;
dt_seg_reapresentacao_w	timestamp;
dt_terc_devolucao_w	timestamp;
nr_seq_motivo_dev_w	bigint;
ie_tipo_devolucao_w	varchar(5);
dt_referencia_w		timestamp;
ds_historico_w		varchar(4000);

c02 CURSOR FOR 
SELECT	a.nr_seq_cheque, 
	b.nr_cheque, 
	b.dt_deposito, 
	b.dt_reapresentacao, 
	b.dt_seg_reapresentacao, 
	b.dt_terc_devolucao, 
	b.nr_seq_motivo_dev 
from	deposito_cheque a, 
	cheque_cr b 
where	a.nr_seq_cheque		= b.nr_seq_cheque 
and	a.nr_seq_deposito	= nr_seq_deposito_p;


BEGIN 
 
open	c02;
loop 
fetch	c02 into 
	nr_seq_cheque_w, 
	nr_cheque_w, 
	dt_deposito_w, 
	dt_reapresentacao_w, 
	dt_seg_reapresentacao_w, 
	dt_terc_devolucao_w, 
	nr_seq_motivo_dev_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
 
	select	coalesce(max(ie_tipo_devolucao),'N') 
	into STRICT	ie_tipo_devolucao_w 
	from	motivo_dev_cheque 
	where	nr_sequencia		= nr_seq_motivo_dev_w;
 
	if (dt_deposito_w IS NOT NULL AND dt_deposito_w::text <> '') and (dt_reapresentacao_w IS NOT NULL AND dt_reapresentacao_w::text <> '') and (ie_tipo_devolucao_w <> 'B') then 
		/* O cheque nr_cheque_w j√° foi devolvido e reapresentado! */
 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(241598,'NR_CHEQUE_W='||nr_cheque_w);
	end if;
 
	if (coalesce(dt_deposito_w::text, '') = '') then 
		select	max(a.dt_deposito) 
		into STRICT	dt_referencia_w 
		from	cheque_cr a 
		where	a.nr_seq_cheque	= nr_seq_cheque_w;
 
		update	cheque_cr 
		set	dt_deposito 		= dt_deposito_p, 
			nm_usuario		= nm_usuario_p, 
			dt_atualizacao		= clock_timestamp() 
		where	nr_seq_cheque		= nr_seq_cheque_w;
 
		ds_historico_w	:=	substr(wheb_mensagem_pck.get_texto(304478,'DT_REFERENCIA=' || PKG_DATE_FORMATERS.TO_VARCHAR(dt_referencia_w,'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, nm_usuario_p) || 
											';DT_DEPOSITO=' || PKG_DATE_FORMATERS.TO_VARCHAR(dt_deposito_p,'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, nm_usuario_p)),1,4000);
 
		CALL gerar_cheque_cr_hist(	nr_seq_cheque_w, 
					ds_historico_w, 
					'N', 
					nm_usuario_p);
 
	end if;
 
	if (dt_deposito_w IS NOT NULL AND dt_deposito_w::text <> '') and (coalesce(dt_reapresentacao_w::text, '') = '') then 
		select	max(a.dt_reapresentacao) 
		into STRICT	dt_referencia_w 
		from	cheque_cr a 
		where	a.nr_seq_cheque	= nr_seq_cheque_w;
 
		update	cheque_cr 
		set	dt_reapresentacao 	= dt_deposito_p, 
			nm_usuario		= nm_usuario_p, 
			dt_atualizacao		= clock_timestamp() 
		where	nr_seq_cheque		= nr_seq_cheque_w;
 
		ds_historico_w	:=	substr(wheb_mensagem_pck.get_texto(304483,'DT_REFERENCIA=' || PKG_DATE_FORMATERS.TO_VARCHAR(dt_referencia_w,'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, nm_usuario_p) || 
											';DT_DEPOSITO=' || PKG_DATE_FORMATERS.TO_VARCHAR(dt_deposito_p,'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, nm_usuario_p)),1,4000);
 
		CALL gerar_cheque_cr_hist(	nr_seq_cheque_w, 
					ds_historico_w, 
					'N', 
					nm_usuario_p);
	end if;
 
	if (dt_reapresentacao_w IS NOT NULL AND dt_reapresentacao_w::text <> '') and (coalesce(dt_seg_reapresentacao_w::text, '') = '') then 
		select	max(a.dt_seg_reapresentacao) 
		into STRICT	dt_referencia_w 
		from	cheque_cr a 
		where	a.nr_seq_cheque	= nr_seq_cheque_w;
 
		update	cheque_cr 
		set	dt_seg_reapresentacao	= dt_deposito_p, 
			nm_usuario		= nm_usuario_p, 
			dt_atualizacao		= clock_timestamp() 
		where	nr_seq_cheque		= nr_seq_cheque_w;
 
		ds_historico_w	:=	substr(wheb_mensagem_pck.get_texto(304484,'DT_REFERENCIA=' || PKG_DATE_FORMATERS.TO_VARCHAR(dt_referencia_w,'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, nm_usuario_p) || 
											';DT_DEPOSITO=' || PKG_DATE_FORMATERS.TO_VARCHAR(dt_deposito_p,'shortDate', WHEB_USUARIO_PCK.GET_CD_ESTABELECIMENTO, nm_usuario_p)),1,4000);
 
		CALL gerar_cheque_cr_hist(	nr_seq_cheque_w, 
					ds_historico_w, 
					'N', 
					nm_usuario_p);
	end if;
 
	CALL ATUALIZAR_DESBLOQUEIO_CHEQUE(nr_seq_cheque_w, nm_usuario_p);
 
	CALL atualizar_saldo_neg_cheque_cr(nr_seq_cheque_w,nm_usuario_p);
 
	CALL atualizar_cobranca_cheque(nr_seq_cheque_w, nm_usuario_p);
	 
	CALL liberar_cheque_orgao_cobr(nr_seq_cheque_w,nm_usuario_p);
 
end	loop;
close	c02;
 
update	deposito 
set	dt_deposito 		= dt_deposito_p, 
	nm_usuario		= nm_usuario_p, 
	dt_atualizacao		= clock_timestamp() 
where	nr_sequencia		= nr_seq_deposito_p;
 
CALL GERAR_MOVTO_DEPOSITO(nr_seq_deposito_p, dt_deposito_p, nm_usuario_p);
 
--commit; Edgar 01/10/2004 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baixar_deposito_cheque (nr_seq_deposito_p bigint, dt_deposito_p timestamp, nm_usuario_p text) FROM PUBLIC;

