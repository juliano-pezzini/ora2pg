-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mp_insere_objeto ( nr_seq_processo_p bigint, nr_seq_objeto_p bigint, qt_topo_p bigint, qt_esquerda_p bigint, qt_altura_p bigint, qt_largura_p bigint, nr_seq_obj_origem_p bigint, nr_seq_obj_destino_p bigint, ds_lista_pontos_p text, nm_usuario_p text, nr_sequencia_p INOUT bigint, cd_estabelecimento_p bigint, nr_seq_projeto_p bigint, ie_tipo_mapeamento_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
ds_objeto_w		varchar(80);
ds_cor_w		varchar(15);
nr_seq_grupo_w		bigint;
qt_largura_w		bigint;
qt_altura_w		bigint;
ie_estilo_objeto_w	bigint;

qt_objeto_w		bigint;
ie_tipo_grupo_w		varchar(2);
nr_seq_processo_ref_w	bigint;
ie_proc_raiz_w		varchar(1)	:= 'N';
ie_orientacao_w		varchar(1)	:= 'P';


BEGIN

if (nr_seq_processo_p IS NOT NULL AND nr_seq_processo_p::text <> '') and (nr_seq_objeto_p IS NOT NULL AND nr_seq_objeto_p::text <> '') then

	select	ds_objeto,
		ds_cor,
		nr_seq_grupo,
		qt_largura,
		qt_altura,
		ie_estilo_objeto,
		ie_proc_raiz
	into STRICT	ds_objeto_w,
		ds_cor_w,
		nr_seq_grupo_w,
		qt_largura_w,
		qt_altura_w,
		ie_estilo_objeto_w,
		ie_proc_raiz_w
	from	mp_objeto
	where	nr_sequencia	= nr_seq_objeto_p;

	select	count(*) + 1
	into STRICT	qt_objeto_w
	from	mp_processo_objeto
	where	nr_seq_processo		= nr_seq_processo_p
	and	nr_seq_objeto		= nr_seq_objeto_p;

	select	ie_tipo_grupo
	into STRICT	ie_tipo_grupo_w
	from	mp_grupo_objeto
	where	nr_sequencia	= nr_seq_grupo_w;

	/*ds_objeto_w	:= ds_objeto_w || '_' || qt_objeto_w; */

	if (ie_proc_raiz_w	= 'N') then

		select	nextval('mp_processo_objeto_seq')
		into STRICT	nr_sequencia_w
		;

		insert	into	mp_processo_objeto(nr_sequencia,
			nm_usuario,
			dt_atualizacao,
			nm_usuario_nrec,
			dt_atualizacao_nrec,
			nr_seq_processo,
			nr_seq_objeto,
			qt_topo,
			qt_esquerda,
			qt_altura,
			qt_largura,
			ds_cor,
			nm_objeto,
			ds_objeto,
			nr_seq_apres,
			nr_seq_obj_origem,
			nr_seq_obj_destino,
			ds_lista_pontos,
			pr_aderencia,
			pr_aderencia_es)
		values (nr_sequencia_w,
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nr_seq_processo_p,
			nr_seq_objeto_p,
			qt_topo_p,
			qt_esquerda_p,
			coalesce(qt_altura_p,qt_altura_w),
			coalesce(qt_largura_p,qt_largura_w),
			ds_cor_w,
			null,
			null,
			null,
			nr_seq_obj_origem_p,
			nr_seq_obj_destino_p,
			ds_lista_pontos_p,
			0,
			0);

		CALL mp_atualizar_unid_org(nr_sequencia_w,nm_usuario_p);
	end if;

	if (ie_tipo_grupo_w = 'P') then
		select	max(ie_orientacao_diagrama)
		into STRICT	ie_orientacao_w
		from	mp_configuracao
		where	cd_estabelecimento	= cd_estabelecimento_p
		and	nm_usuario_param	= nm_usuario_p;

		if (coalesce(ie_orientacao_w::text, '') = '') then
			select	max(ie_orientacao_diagrama)
			into STRICT	ie_orientacao_w
			from	mp_configuracao
			where	cd_estabelecimento	= cd_estabelecimento_p
			and	coalesce(nm_usuario_param::text, '') = '';
		end if;

		select	nextval('mp_processo_seq')
		into STRICT	nr_seq_processo_ref_w
		;

		insert	into	mp_processo(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nm_processo,
			cd_estabelecimento,
			nr_seq_superior,
			nr_seq_objeto,
			nr_seq_projeto,
			ie_tipo_mapeamento,
			cd_empresa,
			ie_status_versao,
			ie_orientacao_diagrama)
		values (nr_seq_processo_ref_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			' ',
			cd_estabelecimento_p,
			nr_seq_processo_p,/*decode(ie_proc_raiz_w,'N',nr_seq_processo_p,null),*/
			nr_seq_objeto_p,
			nr_seq_projeto_p,
			ie_tipo_mapeamento_p,
			obter_empresa_estab(cd_estabelecimento_p),
			'R',
			ie_orientacao_w);

		update	mp_processo_objeto
		set	nr_seq_processo_ref	= nr_seq_processo_ref_w
		where	nr_sequencia		= nr_sequencia_w;
	end if;
end if;

nr_sequencia_p	:= nr_sequencia_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mp_insere_objeto ( nr_seq_processo_p bigint, nr_seq_objeto_p bigint, qt_topo_p bigint, qt_esquerda_p bigint, qt_altura_p bigint, qt_largura_p bigint, nr_seq_obj_origem_p bigint, nr_seq_obj_destino_p bigint, ds_lista_pontos_p text, nm_usuario_p text, nr_sequencia_p INOUT bigint, cd_estabelecimento_p bigint, nr_seq_projeto_p bigint, ie_tipo_mapeamento_p text) FROM PUBLIC;

