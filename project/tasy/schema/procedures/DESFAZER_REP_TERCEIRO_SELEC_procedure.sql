-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_rep_terceiro_selec (nr_repasse_terceiro_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_acao_p bigint) AS $body$
DECLARE

 
/*	ie_acao_p 
 
0	Sem ação 
1	Excluir vencimentos 
2	Mudar status e excluir vencimentos 
3	Desfazer aprovação, mudar status e excluir vencimentos 
4	Desvincular título, desfazer aprovação, mudar status e excluir vencimentos 
 
*/
 
 
nr_seq_terceiro_w		bigint;
ie_desvinv_contabil_w		varchar(1);
qt_titulo_w			bigint;
nr_repasse_terceiro_w		bigint;
qt_contabilizado_w		bigint;
nr_titulo_w			bigint;
qt_titulo_nf_w			bigint;
ie_reabrir_contabil_w		varchar(1);
dt_aprovacao_terceiro_w		timestamp;
ie_status_w			varchar(1);
nm_terceiro_w			varchar(255);
ie_excluir_rep_desfazer_w	varchar(3);

C01 CURSOR FOR 
	SELECT	b.nr_sequencia, 
		a.nr_repasse_terceiro, 
		a.dt_aprovacao_terceiro, 
		a.ie_status, 
		substr(obter_nome_terceiro(b.nr_sequencia),1,255) nm_terceiro 
	from	terceiro b, 
		repasse_terceiro a 
	where (ie_acao_p = 4 or (ie_acao_p = 3 and not exists (SELECT	1 
						from	titulo_pagar x 
						where	x.nr_repasse_terceiro	= a.nr_repasse_terceiro)) or (ie_acao_p = 2 and coalesce(a.dt_aprovacao_terceiro::text, '') = '') or (ie_acao_p = 1 and a.ie_status = 'A') or (ie_acao_p = 0 and not exists (select	1 
						from	repasse_terceiro_venc x 
						where	x.nr_repasse_terceiro	= a.nr_repasse_terceiro))) 
	and	b.ie_situacao		= 'A' 
	and	b.cd_estabelecimento	= cd_estabelecimento_p 
	and	coalesce(b.ie_utilizacao, 'A') in ('A','R') 
	and	a.nr_seq_terceiro	= b.nr_sequencia 
	and	a.nr_repasse_terceiro	= nr_repasse_terceiro_p;


BEGIN 
 
ie_desvinv_contabil_w := obter_param_usuario(89, 63, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_desvinv_contabil_w);
ie_reabrir_contabil_w := obter_param_usuario(89, 64, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_reabrir_contabil_w);
 
select	coalesce(max(a.ie_excluir_rep_desfazer),'N') 
into STRICT	ie_excluir_rep_desfazer_w 
from	parametro_faturamento a 
where	a.cd_estabelecimento	= cd_estabelecimento_p;
 
open C01;
loop 
fetch C01 into	 
	nr_seq_terceiro_w, 
	nr_repasse_terceiro_w, 
	dt_aprovacao_terceiro_w, 
	ie_status_w, 
	nm_terceiro_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin	 
 
	select	count(*) 
	into STRICT	qt_titulo_w 
	from	titulo_pagar a 
	where	a.nr_repasse_terceiro	= nr_repasse_terceiro_w;
	 
	select	count(*) 
	into STRICT	qt_contabilizado_w 
	from	repasse_terceiro_item a 
	where	coalesce(a.nr_lote_contabil,0)	> 0 
	and	a.nr_repasse_terceiro		= nr_repasse_terceiro_w;
	 
	if (qt_titulo_w		> 0) then 
		 
		if (ie_desvinv_contabil_w	<> 'S') and (qt_contabilizado_w	> 0) then			 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(185427);
		end if;
	 
		select	count(*) 
		into STRICT	qt_titulo_nf_w 
		from	nota_fiscal b, 
			titulo_pagar a 
		where	coalesce(b.ie_situacao,1)	= 1 
		and	a.nr_seq_nota_fiscal	= b.nr_sequencia 
		and	a.nr_repasse_terceiro	= nr_repasse_terceiro_w;
	 
		if (qt_titulo_nf_w	> 0) then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(185428);
		end if;
	 
		CALL desvincular_titulo_repasse(nr_repasse_terceiro_w,nm_usuario_p,'N');
	 
	end if;
	 
	if (dt_aprovacao_terceiro_w IS NOT NULL AND dt_aprovacao_terceiro_w::text <> '') then 
		CALL desfazer_aprovacao_repasse(nr_repasse_terceiro_w,nm_usuario_p,'N');
	end if;
	 
	if (ie_status_w	= 'F') then 
	 
		if (ie_reabrir_contabil_w	<> 'S') and (qt_contabilizado_w	> 0) then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort(185429);
		end if;
	 
		CALL altera_status_repasse_terceiro(nr_repasse_terceiro_w,nm_usuario_p,'N');
	 
	end if;
	 
	delete	from repasse_terc_venc_trib 
	where	nr_seq_rep_venc	in (SELECT	a.nr_sequencia 
		from	repasse_terceiro_venc a 
		where	a.nr_repasse_terceiro	= nr_repasse_terceiro_w);
	 
	delete	from repasse_terceiro_venc 
	where	nr_repasse_terceiro	= nr_repasse_terceiro_w;
	 
	delete	from repasse_terceiro_item 
	where	nr_repasse_terceiro	= nr_repasse_terceiro_w;
	 
	update	material_repasse 
	set	nr_repasse_terceiro	 = NULL 
	where	nr_repasse_terceiro	= nr_repasse_terceiro_w;
	 
	update	procedimento_repasse 
	set	nr_repasse_terceiro	 = NULL 
	where	nr_repasse_terceiro	= nr_repasse_terceiro_w;
	 
	if (coalesce(ie_excluir_rep_desfazer_w,'N')	= 'S') then 
		delete	from repasse_terceiro 
		where	nr_repasse_terceiro	= nr_repasse_terceiro_w;
	end if;
 
end;
end loop;
close C01;
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_rep_terceiro_selec (nr_repasse_terceiro_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_acao_p bigint) FROM PUBLIC;

