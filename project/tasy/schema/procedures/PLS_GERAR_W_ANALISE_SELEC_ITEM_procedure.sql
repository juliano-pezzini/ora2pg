-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_w_analise_selec_item ( nr_seq_analise_p bigint, nr_seq_w_item_p bigint, qt_liberar_p bigint, ie_opcao_p text, nm_usuario_p text, ie_commit_p text, nr_id_transacao_p w_pls_analise_item.nr_id_transacao%type default null, ie_html_p text default 'N') AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  ]  Objetos do dicionário [ X ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ie_tipo_item_w		varchar(255);
ie_tipo_despesa_w	varchar(255);
nr_seq_w_item_w		bigint;
nr_id_transacao_w  w_pls_analise_item.nr_id_transacao%type;

C01 CURSOR FOR
	SELECT	a.nr_sequencia
	from	w_pls_analise_item	a
	where	((a.ie_tipo_item	= ie_tipo_item_w) or (a.ie_tipo_item = 'R' and ie_tipo_item_w = 'P'))
	and		a.ie_tipo_despesa		= ie_tipo_despesa_w
	and		a.nr_sequencia	<> nr_seq_w_item_p
	and 	a.nr_id_transacao = nr_id_transacao_w;

C02 CURSOR FOR	
	SELECT	a.nr_sequencia
	from	w_pls_analise_item	a
	where	nr_seq_analise = nr_seq_analise_p
	and		a.nr_id_transacao = nr_id_transacao_w;
	


BEGIN

if ( coalesce(nr_id_transacao_p::text, '') = '' ) then
	select max(nr_id_transacao)
	into STRICT   nr_id_transacao_w
	from  w_pls_analise_item
	where  nr_seq_analise = nr_seq_analise_p;
else
	nr_id_transacao_w := nr_id_transacao_p;
end if;

if (ie_opcao_p = 'M') then
	begin
	insert into w_pls_analise_selecao_item(dt_atualizacao,
		nm_usuario,
		nr_seq_w_item,
		nr_seq_analise,
		qt_liberar)
	values (clock_timestamp(),
		nm_usuario_p,
		nr_seq_w_item_p,
		nr_seq_analise_p,
		qt_liberar_p);
		
	update	w_pls_analise_item
	set	ie_selecionado	= 'S',
		qt_liberar	= qt_liberar_p
	where	nr_sequencia	= nr_seq_w_item_p
	and		nr_seq_analise	= nr_seq_analise_p
	and		nr_id_transacao = nr_id_transacao_w;
	
	update	w_pls_analise_item	a
	set	qt_liberar	=	(SELECT	x.qt_liberar
					from	w_pls_analise_selecao_item	x
					where	x.nr_seq_analise	= a.nr_seq_analise
					and	x.nr_seq_w_item		= a.nr_sequencia)
	where	a.nr_seq_analise	= nr_seq_analise_p
	and		a.nr_id_transacao = nr_id_transacao_w;
	exception
	when others then
		null;
	end;
elsif (ie_opcao_p = 'A') then
	begin
	update	w_pls_analise_selecao_item
	set		qt_liberar = qt_liberar_p
	where	nr_seq_analise = nr_seq_analise_p
	and		nr_seq_w_item = nr_seq_w_item_p;
	exception
	when others then
		null;
	end;
elsif (ie_opcao_p = 'T') then
	delete	from w_pls_analise_selecao_item
	where	nr_seq_analise	= nr_seq_analise_p;
elsif (ie_opcao_p = 'CM') then
	begin
	insert into w_pls_analise_selecao_item(dt_atualizacao,
		nm_usuario,
		nr_seq_w_item,
		nr_seq_analise,
		qt_liberar)
	values (clock_timestamp(),
		nm_usuario_p,
		nr_seq_w_item_p,
		nr_seq_analise_p,
		qt_liberar_p);
		
	update	w_pls_analise_item
	set	ie_selecionado	= 'S',
		qt_liberar	= qt_liberar_p
	where	nr_sequencia	= nr_seq_w_item_p
	and		nr_seq_analise	= nr_seq_analise_p
	and		nr_id_transacao = nr_id_transacao_w;
	
	select	max(a.ie_tipo_item),
			max(a.ie_tipo_despesa)
	into STRICT	ie_tipo_item_w,
			ie_tipo_despesa_w
	from	w_pls_analise_item	a
	where	a.nr_sequencia	= nr_seq_w_item_p
	and		a.nr_id_transacao = nr_id_transacao_w;
	
	open C01;
	loop
	fetch C01 into	
		nr_seq_w_item_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		CALL pls_gerar_w_analise_selec_item(nr_seq_analise_p, nr_seq_w_item_w, qt_liberar_p, 'M', nm_usuario_p, ie_commit_p, nr_id_transacao_w);
		end;
	end loop;
	close C01;
	exception
		when others then
		null;
	end;
elsif (ie_opcao_p = 'CD') then
	begin
	delete	from w_pls_analise_selecao_item
	where	nr_seq_analise	= nr_seq_analise_p
	and	nr_seq_w_item	= nr_seq_w_item_p;
		
	update	w_pls_analise_item
	set	ie_selecionado	= 'N',
		qt_liberar	 = NULL
	where	nr_sequencia	= nr_seq_w_item_p
	and	nr_seq_analise	= nr_seq_analise_p
	and	nr_id_transacao = nr_id_transacao_w;
	
	select	max(a.ie_tipo_item),
		max(a.ie_tipo_despesa)
	into STRICT	ie_tipo_item_w,
		ie_tipo_despesa_w
	from	w_pls_analise_item	a
	where	a.nr_sequencia	= nr_seq_w_item_p
	and		a.nr_id_transacao = nr_id_transacao_w;
	
	open C01;
	loop
	fetch C01 into	
		nr_seq_w_item_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		CALL pls_gerar_w_analise_selec_item(nr_seq_analise_p, nr_seq_w_item_w, qt_liberar_p, 'D', nm_usuario_p, ie_commit_p, nr_id_transacao_w);
		end;
	end loop;
	close C01;
	exception
		when others then
		null;
	end;
elsif (ie_opcao_p = 'S') then
	begin
	
	delete	from w_pls_analise_selecao_item
	where	nr_seq_analise	= nr_seq_analise_p;
	
	open C02;
	loop
	fetch C02 into	
		nr_seq_w_item_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		
		insert into w_pls_analise_selecao_item(dt_atualizacao,
				nm_usuario,
				nr_seq_w_item,
				nr_seq_analise,
				qt_liberar)
			values (clock_timestamp(),
				nm_usuario_p,
				nr_seq_w_item_w,
				nr_seq_analise_p,
				qt_liberar_p);
		
		end;
	end loop;
	close C02;

	update	w_pls_analise_item a
	set	ie_selecionado	= 'S',
		qt_liberar	= (	SELECT	x.qt_liberar
					from	w_pls_analise_selecao_item	x
					where	x.nr_seq_analise	= a.nr_seq_analise
					and	x.nr_seq_w_item		= a.nr_sequencia)
	where	nr_seq_analise	= nr_seq_analise_p
	and		a.nr_id_transacao = nr_id_transacao_w;
	
	exception
		when others then
		null;
	end;
elsif (ie_opcao_p = 'E') then
	
	delete	from w_pls_analise_selecao_item
	where	nr_seq_analise	= nr_seq_analise_p;
	
	update	w_pls_analise_item
	set	ie_selecionado	= 'N',
		qt_liberar	 = NULL
	where	nr_seq_analise	= nr_seq_analise_p
	and	nr_id_transacao = nr_id_transacao_w;

else
	select	max(a.ie_tipo_item),
		max(a.ie_tipo_despesa)
	into STRICT	ie_tipo_item_w,
		ie_tipo_despesa_w
	from	w_pls_analise_item	a
	where	a.nr_sequencia	= nr_seq_w_item_p
	and		a.nr_id_transacao = nr_id_transacao_w;
	
	delete	from w_pls_analise_selecao_item
	where	nr_seq_analise	= nr_seq_analise_p
	and		nr_seq_w_item	= nr_seq_w_item_p;
	
	delete	from w_pls_analise_selecao_item
	where	nr_seq_analise	= nr_seq_analise_p
	and	nr_seq_w_item 	in (	SELECT 	x.nr_sequencia
					from	w_pls_analise_item x
					where	x.nr_seq_analise = nr_seq_analise_p
					and		ie_tipo_linha	= 'T'
					and	ie_tipo_despesa	= ie_tipo_despesa_w
					and	x.nr_id_transacao = nr_id_transacao_w);	
	
	
	update	w_pls_analise_item
	set	ie_selecionado	= 'N',
		qt_liberar	 = NULL
	where	nr_sequencia	= nr_seq_w_item_p
	and	nr_seq_analise	= nr_seq_analise_p
	and	nr_id_transacao = nr_id_transacao_w;

	update	w_pls_analise_item
	set	ie_selecionado 	= 'N',
		qt_liberar	 = NULL
	where	nr_seq_analise	= nr_seq_analise_p
	and	ie_tipo_linha	= 'T'
	and	ie_tipo_despesa	= ie_tipo_despesa_w
	and	nr_id_transacao = nr_id_transacao_w;	
	
	if (coalesce(ie_html_p,'N')	= 'N') then
		update	w_pls_analise_item	a
		set	qt_liberar	=	(SELECT	x.qt_liberar
						from	w_pls_analise_selecao_item	x
						where	x.nr_seq_analise	= a.nr_seq_analise
						and	x.nr_seq_w_item		= a.nr_sequencia)
		where	a.nr_seq_analise	= nr_seq_analise_p
		and		a.nr_id_transacao = nr_id_transacao_w;
	end if;
	
end if;

if (coalesce(ie_commit_p,'S') = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_w_analise_selec_item ( nr_seq_analise_p bigint, nr_seq_w_item_p bigint, qt_liberar_p bigint, ie_opcao_p text, nm_usuario_p text, ie_commit_p text, nr_id_transacao_p w_pls_analise_item.nr_id_transacao%type default null, ie_html_p text default 'N') FROM PUBLIC;

