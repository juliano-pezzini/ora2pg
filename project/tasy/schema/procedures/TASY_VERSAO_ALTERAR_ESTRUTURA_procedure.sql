-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_versao_alterar_estrutura ( nm_tabela_p text, ie_enterprise_p text, nr_ordem_p bigint, ie_paralelism_p boolean default false) AS $body$
DECLARE


nm_atributo_w          		varchar(50)      := '';
nm_sequence_w          		varchar(50)      := '';
ds_virgula_w			varchar(01)	  := '';
ds_tablespace_tab_w    		varchar(50)      := '';
ds_tablespace_temp_tab_w    	varchar(50)      := '';
ds_comando_w			varchar(15000);
ds_atributo_w			varchar(6000);
vl_retorno_w			varchar(255);
vl_default_w			varchar(050);
qt_byte_reg_w			bigint;
qt_Initial_w			numeric(020);
qt_next_w			numeric(020);
qt_registro_w			bigint;
qt_seq_inicio_w			bigint;
qt_seq_incremento_w		bigint;
qt_seq_max_w			bigint;

qt_seq_ini_Atr_w			bigint;
qt_seq_incr_Atr_w			bigint;

ie_obrigatorio_w			varchar(001);
ie_tipo_atributo_w		varchar(010);
qt_tamanho_w			bigint;
qt_decimais_w			bigint;
data_type_w 		 	varchar(30)    := null;
data_precision_w		bigint      := 0;
data_length_w			bigint      := 0;
length_semantic     varchar(10);
data_scale_w			bigint      := 0;
nullable_w			varchar(1)	:= 'N';
criar_Seq_w			varchar(1)	:= 'N';
qt_reg_nulo_w			varchar(15);
qt_retorno_w			bigint	:= 0;
c001				integer;
ie_temporaria_w			varchar(2);
ie_cadastro_geral_w		varchar(1);
nm_fase_w       cloud_upgrade_log.nm_fase_atualizacao%type := 'TASY_VERSAO_ALTERAR_ESTRUTURA';
nm_paralelism_w         varchar(1000);

C010 CURSOR FOR
SELECT 	nm_atributo,
		ie_obrigatorio,
		ie_tipo_atributo,
		qt_tamanho,
		coalesce(qt_decimais,0),
		coalesce(qt_seq_inicio,0),
		coalesce(qt_seq_incremento,0),
		vl_default
FROM	tasy_versao.tabela_atributo
WHERE	nm_tabela	= nm_tabela_p
  and	ie_tipo_atributo not in ('FUNCTION','VISUAL')
order by nr_sequencia_criacao;


BEGIN

select case when value = 'AL32UTF8' then 'CHAR' else 'BYTE' end into STRICT length_semantic from nls_database_parameters where parameter='NLS_CHARACTERSET';

ds_tablespace_temp_tab_w := obter_tablespace_tab_temp;

SELECT 	coalesce(qt_registros_previsto,100),
	coalesce(qt_media_bytes,200),
	ie_temporaria,
	ie_cadastro_geral
INTO STRICT	qt_registro_w,
	qt_byte_reg_w,
	ie_temporaria_w,
	ie_cadastro_geral_w
FROM 	tasy_versao.tabela_sistema
WHERE 	nm_tabela = nm_tabela_p;

select	default_tablespace
into STRICT	ds_tablespace_tab_w
from	user_users;

ds_virgula_w		:= '';
criar_Seq_w			:= 'N';
qt_seq_inicio_w		:= 0;
qt_seq_incremento_w	:= 0;
if ( ie_temporaria_w in ('G','GD')) then
	ds_comando_w		:= 'Create global temporary Table ' || nm_tabela_p || ' (';
else
	ds_comando_w		:= 'Create Table ' || nm_tabela_p || ' (';
end if;

OPEN C010;
LOOP
	FETCH C010 INTO 	nm_atributo_w,
				ie_obrigatorio_w,
				ie_tipo_atributo_w,
				qt_tamanho_w,
				qt_decimais_w,
				qt_seq_ini_atr_w,
				qt_seq_incr_atr_w,
				vl_default_w;
	EXIT WHEN NOT FOUND; /* apply on C010 */

/*    Identifica se o Atributo está criado */

	begin
	select
		data_type,
		data_precision,
		char_length,
		data_scale,
		CASE WHEN nullable='Y' THEN 'N'  ELSE 'S' END
	into STRICT
		data_type_w,
		data_precision_w,
		data_length_w,
		data_scale_w,
		nullable_w
	from 	user_tab_columns
	where	table_name 	= nm_tabela_p
	and	column_name	= nm_atributo_w;
	exception
		when others then
			begin
			data_type_w		:= 'Novo';
			data_precision_w	:= 0;
			data_length_w	:= 0;
			data_scale_w	:= 0;
			end;
	end;

/*    Define o comando para criação ou Alteração do Atributo */

	ds_atributo_w	:= nm_atributo_w  || ' ' || ie_tipo_atributo_w;
	if (ie_tipo_atributo_w = 'NUMBER') then
		begin
		ds_atributo_w:= ds_atributo_w  || '(' || qt_tamanho_w;
		ds_atributo_w:= ds_atributo_w  || ',' || qt_decimais_w || ')';
		end;
	elsif (ie_tipo_atributo_w = 'VARCHAR2') then
		ds_atributo_w:= ds_atributo_w  || '(' || qt_tamanho_w || ' ' || length_semantic || ')';
	end if;

/*    Gera Script para criação */

	if (length(ds_comando_w) > 10000) then
		ds_comando_w	:= ds_comando_w;
	elsif (ie_tipo_atributo_w = 'VARCHAR2' AND qt_tamanho_w	<> data_length_w) or
		((ie_tipo_atributo_w = 'NUMBER') and
		 ((qt_tamanho_w	<> data_precision_w) or (qt_decimais_w	<> data_scale_w ))) or
		 ((ie_tipo_atributo_w	<> data_type_w) and (data_type_w <> 'Novo') and (ie_tipo_atributo_w not in ('VISUAL','TIMESTAMP','FUNCTION')) )  then
		begin
		ds_comando_w	:= 'Alter Table ' || nm_tabela_p || ' MODIFY(';
		ds_comando_w	:= ds_comando_w  || ds_atributo_w || ')';

		if (ie_enterprise_p = 'S') then
			if (ie_paralelism_p) then
                nm_paralelism_w := ' parallel ';
            end if;
            ds_comando_w := ds_comando_w || nm_paralelism_w;
		end if;

		insert into TABELA_VERSAO_OFFLINE_W(nr_sequencia, nr_ordem, ds_comando, ds_log) values (nextval('tabela_versao_offline_w_seq'),nr_ordem_p,ds_comando_w,'A');
		commit;
        CALL insert_log_cloud(null,null, 'atualizacao', nm_fase_w||'_LOG', null, nm_fase_w);
		end;
/*    Identifica se existe diferença (NULL) entre a criação e Base */

	elsif ( (ie_obrigatorio_w IS NOT NULL AND ie_obrigatorio_w::text <> '')able_w ) then
		begin
		/* Atualizar os valores somente para tabelas do SHIFT+F11*/

		/* ALterar para NULL se campo obrigatório na base e não obrigatório no dicionário*/

		if ( ie_cadastro_geral_w in ('S','W') ) and ( ie_obrigatorio_w = 'S' ) and ( nullable_w = 'N') then
			CALL TASY_VERSAO_ALTERAR_COLUNA(nm_tabela_p,nm_atributo_w,ie_tipo_atributo_w,qt_tamanho_w,qt_decimais_w,ie_obrigatorio_w,vl_default_w,ie_enterprise_p,nr_ordem_p, ie_paralelism_p);
		elsif ( ie_obrigatorio_w = 'N' ) and ( nullable_w = 'S') then
			vl_default_w := null;
			CALL TASY_VERSAO_ALTERAR_COLUNA(nm_tabela_p,nm_atributo_w,ie_tipo_atributo_w,qt_tamanho_w,qt_decimais_w,ie_obrigatorio_w,vl_default_w,ie_enterprise_p,nr_ordem_p, ie_paralelism_p);
		end if;
		end;
	end if;
END LOOP;
CLOSE C010;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_versao_alterar_estrutura ( nm_tabela_p text, ie_enterprise_p text, nr_ordem_p bigint, ie_paralelism_p boolean default false) FROM PUBLIC;

