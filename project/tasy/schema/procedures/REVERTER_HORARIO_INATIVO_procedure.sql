-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reverter_horario_inativo ( cd_tipo_agenda_p bigint, cd_agenda_p bigint, nr_seq_agenda_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
hr_inicio_w	timestamp;
qt_hor_cancel_w	bigint;
ds_mascara_w	varchar(100);
				

BEGIN 
 
ds_mascara_w := pkg_date_formaters.localize_mask('timestamp', pkg_date_formaters.getUserLanguageTag(wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario));
 
if (cd_agenda_p IS NOT NULL AND cd_agenda_p::text <> '') and (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then -- agenda de exames 
	/* inativar horário */
 
 
	if (cd_tipo_agenda_p = 2) then 
	 
		select	max(hr_inicio) 
		into STRICT	hr_inicio_w 
		from	agenda_paciente 
		where	nr_sequencia = nr_seq_agenda_p;
		 
		select	coalesce(max((to_char(hr_inicio,'ss'))::numeric ),0)+1 
		into STRICT	qt_hor_cancel_w 
		from	agenda_paciente 
		where	cd_agenda = cd_agenda_p 
		and	to_date(to_char(hr_inicio,'dd/mm/yyyy hh24:mi') || ':00', 'dd/mm/yyyy hh24:mi:ss') = to_date(to_char(hr_inicio_w,'dd/mm/yyyy hh24:mi') || ':00', 'dd/mm/yyyy hh24:mi:ss') 
		and	ie_status_agenda = 'C';
 
		update	agenda_paciente 
		set	hr_inicio		= hr_inicio + qt_hor_cancel_w / 86400, 
			ie_status_agenda	= 'C', 
			nm_usuario_status	= nm_usuario_p, 
			dt_status		= clock_timestamp(), 
			ds_motivo_status	= wheb_mensagem_pck.get_texto(803002), 
			nm_usuario_cancel	= nm_usuario_p, 
			dt_cancelamento		= clock_timestamp(), 
			--cd_motivo_cancelamento	= cd_motivo_p, 
			nm_usuario		= nm_usuario_p 
		where	nr_sequencia		= nr_seq_agenda_p;
			 
		/* gerar histórico */
 
		CALL gerar_agenda_paciente_hist(cd_agenda_p,nr_seq_agenda_p,'I',nm_usuario_p, wheb_mensagem_pck.get_texto(803007) || ' ' || to_char(hr_inicio_w, ds_mascara_w),null,null,hr_inicio_w, obter_perfil_ativo);
		 
	elsif (cd_tipo_agenda_p = 3) then 
		 
		select	max(dt_agenda) 
		into STRICT	hr_inicio_w 
		from	agenda_consulta 
		where	nr_sequencia = nr_seq_agenda_p;
		 
		select	coalesce(max((to_char(dt_agenda,'ss'))::numeric ),0)+1 
		into STRICT	qt_hor_cancel_w 
		from	agenda_consulta 
		where	cd_agenda = cd_agenda_p 
		and	to_date(to_char(dt_agenda,'dd/mm/yyyy hh24:mi') || ':00', 'dd/mm/yyyy hh24:mi:ss') = to_date(to_char(hr_inicio_w,'dd/mm/yyyy hh24:mi') || ':00', 'dd/mm/yyyy hh24:mi:ss') 
		and	ie_status_agenda = 'C';
		 
		update	agenda_consulta 
		set	ie_status_agenda		= 'C', 
			dt_Agenda			= dt_agenda + qt_hor_cancel_w / 86400, 
			nm_usuario_status		= nm_usuario_p, 
			dt_status			= clock_timestamp(), 
			ds_motivo_status		= wheb_mensagem_pck.get_texto(803002), 
			--cd_motivo_cancelamento		= cd_motivo_p, 
			nm_usuario			= nm_usuario_p, 
			nm_usuario_cancelamento		= nm_usuario_p, 
			dt_cancelamento			= clock_timestamp() 
		where	nr_sequencia			= nr_seq_agenda_p;
			 
		/* gerar histórico */
 
		CALL gerar_agenda_paciente_hist(cd_agenda_p,nr_seq_agenda_p,'I',nm_usuario_p, wheb_mensagem_pck.get_texto(803007) || ' ' || to_char(hr_inicio_w, ds_mascara_w),null,null,hr_inicio_w, obter_perfil_ativo);
		 
	end if;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reverter_horario_inativo ( cd_tipo_agenda_p bigint, cd_agenda_p bigint, nr_seq_agenda_p bigint, nm_usuario_p text) FROM PUBLIC;

