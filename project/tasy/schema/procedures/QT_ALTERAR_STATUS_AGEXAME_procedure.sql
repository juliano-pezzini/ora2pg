-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qt_alterar_status_agexame ( cd_agenda_p text, ie_status_agenda_p text, nr_seq_paciente_p text, dt_agenda_p timestamp, nm_usuario_p text) AS $body$
DECLARE

					 
qt_agendamentos_pac_w	bigint;
cd_pessoa_fisica_w	varchar(10);
nr_sequencia_w		bigint;
ds_lista_w		varchar(1000);
tam_lista_w		bigint;
ie_pos_virgula_w	smallint;
cd_agenda_w		bigint;

 
 
 
C01 CURSOR FOR 
	SELECT	a.nr_sequencia 
	from	agenda_paciente a, 
		agenda b 
	where	a.cd_agenda					= b.cd_agenda 
	and	a.cd_pessoa_fisica				= (	SELECT	max(a.cd_pessoa_fisica)		 
									from	paciente_setor a 
									where	a.nr_seq_paciente	= nr_seq_paciente_p) 
	and	a.ie_status_agenda				not in ('L','C','B','F','I','II') 
	and	a.dt_agenda					between	trunc(dt_agenda_p) and trunc(dt_agenda_p) + 86399/86400 
	and	obter_se_contido(a.cd_agenda,cd_agenda_p)	= 'S' 
	and	b.cd_tipo_agenda				= 2 
	and	b.ie_situacao					= 'A';

 

BEGIN	 
open C01;
loop 
fetch C01 into	 
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin		 
	 
	if (nr_sequencia_w 	> 0) and (ie_status_agenda_p 	= 'O') then 
		 
		update 	agenda_paciente a 
		set	a.ie_status_agenda	= ie_status_agenda_p,			 
			a.dt_atendimento	= clock_timestamp(), 
			a.nm_usuario		= nm_usuario_p 
		where	a.nr_sequencia		= nr_sequencia_w;				
		 
	end if;
	 
	if (nr_sequencia_w 	> 0) and (ie_status_agenda_p 	= 'E') then 
		update 	agenda_paciente a 
		set	a.ie_status_agenda	= ie_status_agenda_p,			 
			dt_executada		= clock_timestamp(), 
			a.nm_usuario		= nm_usuario_p 
		where	a.nr_sequencia		= nr_sequencia_w;					
	end if;	
	 
	 
	end;
end loop;
close C01;		
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qt_alterar_status_agexame ( cd_agenda_p text, ie_status_agenda_p text, nr_seq_paciente_p text, dt_agenda_p timestamp, nm_usuario_p text) FROM PUBLIC;

