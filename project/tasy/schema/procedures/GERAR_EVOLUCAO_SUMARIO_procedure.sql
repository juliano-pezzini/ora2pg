-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_evolucao_sumario ( nr_seq_sumario_p bigint, ds_texto_p text, nm_usuario_p text) AS $body$
DECLARE

									
ie_gera_evolucao_w		varchar(1);
cd_medico_w				varchar(10);
nr_atendimento_w		bigint;
cd_pessoa_fisica_w		varchar(10);
cd_evolucao_w			bigint;


BEGIN
ie_gera_evolucao_w := obter_param_usuario(281, 1444, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_gera_evolucao_w);

if (ie_gera_evolucao_w = 'S') then
	select	max(nr_atendimento),
			max(cd_medico_resp_alta)
	into STRICT	nr_atendimento_w,
			cd_medico_w
	from	atend_sumario_alta
	where	nr_sequencia = nr_seq_sumario_p;
	
	select	max(cd_pessoa_fisica)
	into STRICT	cd_pessoa_fisica_w
	from	atendimento_paciente
	where	nr_atendimento = nr_atendimento_w;
	
	select	nextval('evolucao_paciente_seq')
	into STRICT	cd_evolucao_w
	;
	
	insert into evolucao_paciente(	cd_evolucao,
					dt_evolucao,
					ie_tipo_evolucao,
					cd_pessoa_fisica,
					dt_atualizacao,
					nm_usuario,
					nr_atendimento,
					cd_medico,
					ie_evolucao_clinica,
					ie_situacao)
			values (	cd_evolucao_w,
					clock_timestamp(),
					'1',
					cd_pessoa_fisica_w,
					clock_timestamp(),
					nm_usuario_p,
					nr_atendimento_w,
					cd_medico_w,
					'ESA',
					'A');
	
	commit;

	CALL copia_campo_long_de_para_novo('ATEND_SUMARIO_ALTA_RESUMO',
				 'DS_RESUMO',
				 'where nr_seq_atend_sumario = :nr_sequencia',
				 'nr_sequencia='||nr_seq_sumario_p,
				 'EVOLUCAO_PACIENTE',
				 'DS_EVOLUCAO',
				 'where cd_evolucao = :cd_evolucao',
				 'cd_evolucao='||cd_evolucao_w,
				 'L');
				

	commit;
	
	CALL liberar_evolucao(cd_evolucao_w,nm_usuario_p);
	
	CALL gerar_evolucao_vinculo(nr_seq_sumario_p,cd_evolucao_w,'SU');
	
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_evolucao_sumario ( nr_seq_sumario_p bigint, ds_texto_p text, nm_usuario_p text) FROM PUBLIC;

