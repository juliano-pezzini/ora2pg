-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mp_exclui_objeto ( nr_seq_proc_objeto_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_processo_ref_w	bigint;
ie_status_versao_w	varchar(2);
qt_registro_w		bigint;


BEGIN

if (nr_seq_proc_objeto_p IS NOT NULL AND nr_seq_proc_objeto_p::text <> '') then

	select	nr_seq_processo_ref
	into STRICT	nr_seq_processo_ref_w
	from	mp_processo_objeto
	where	nr_sequencia	= nr_seq_proc_objeto_p;

	if (nr_seq_processo_ref_w IS NOT NULL AND nr_seq_processo_ref_w::text <> '') then
		select	count(*)
		into STRICT	qt_registro_w
		from	mp_processo a
		where	a.nr_seq_superior	= nr_seq_processo_ref_w;

		if (qt_registro_w > 0) then
			/* O processo que está sendo excluído possui processos filhos.
			É necessário excluir primeiro os processos  descendentes!*/
			CALL wheb_mensagem_pck.exibir_mensagem_abort(267097);
		end if;

		select	count(*)
		into STRICT	qt_registro_w
		from	mp_processo_objeto a
		where	a.nr_seq_processo	= nr_seq_processo_ref_w;

		if (qt_registro_w > 0) then
			/* O processo que está sendo excluído possui atividades.
			É necessário excluir primeiro as atividades! */
			CALL wheb_mensagem_pck.exibir_mensagem_abort(267098);
		end if;

		select	ie_status_versao
		into STRICT	ie_status_versao_w
		from	mp_processo
		where	nr_sequencia	= nr_seq_processo_ref_w;

		if (ie_status_versao_w = 'P') then
			-- Este processo está publicado, é necessário criar uma revisão para excluir o mesmo.
			CALL wheb_mensagem_pck.exibir_mensagem_abort(267099);
		end if;
	end if;

	delete	from	mp_processo_objeto
	where	nr_sequencia	= nr_seq_proc_objeto_p;

	delete	from	mp_processo a
	where	nr_sequencia	= nr_seq_processo_ref_w
	and	not exists (SELECT	1
				from	mp_processo_objeto x
				where	x.nr_seq_processo_ref = a.nr_sequencia);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mp_exclui_objeto ( nr_seq_proc_objeto_p bigint, nm_usuario_p text) FROM PUBLIC;

