-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cancelar_exame ( nr_prescricao_p bigint, nr_sequencia_p bigint, nr_seq_interno_prescr_p bigint, nr_acess_dicom_p text, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE

 nr_prescricao_w bigint := nr_prescricao_p;
 nr_sequencia_w bigint := nr_sequencia_p;
 nr_seq_interno_prescr_w bigint := nr_seq_interno_prescr_p;
 nr_acess_dicom_w varchar(20) := nr_acess_dicom_p;
 nm_usuario_w varchar(80) := nm_usuario_p;

BEGIN
 
 --IF NULL GET NR_PRESCRICAO AND NR_SEQUENCIA 
 IF (coalesce(nr_prescricao_p::text, '') = '' OR coalesce(nr_sequencia_p::text, '') = '') THEN 
  IF (nr_seq_interno_prescr_p IS NOT NULL AND nr_seq_interno_prescr_p::text <> '') THEN 
   SELECT nr_prescricao, nr_sequencia 
   INTO STRICT nr_prescricao_w, nr_sequencia_w 
   FROM prescr_procedimento 
   WHERE nr_seq_interno = nr_seq_interno_prescr_p;
  ELSIF (nr_acess_dicom_p IS NOT NULL AND nr_acess_dicom_p::text <> '') THEN 
   SELECT nr_prescricao, nr_sequencia 
   INTO STRICT nr_prescricao_w, nr_sequencia_w 
   FROM prescr_procedimento 
   WHERE nr_acesso_dicom = nr_seq_interno_prescr_p;
  END IF;
 END IF;
 
 CALL Desfazer_Execucao_Procedimento(nr_prescricao_w, nr_sequencia_w, 'PACS');
  
 UPDATE prescr_procedimento 
  SET 
   dt_atualizacao   = clock_timestamp(), 
   dt_cancelamento  = clock_timestamp(), 
   nm_usuario     = 'PACS', 
   ds_observacao_canc_exame = 'PACS' 
 WHERE (nr_prescricao = nr_prescricao_w 
 AND nr_sequencia   = nr_sequencia_w);
  
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cancelar_exame ( nr_prescricao_p bigint, nr_sequencia_p bigint, nr_seq_interno_prescr_p bigint, nr_acess_dicom_p text, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

