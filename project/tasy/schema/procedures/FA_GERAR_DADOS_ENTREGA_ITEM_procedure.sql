-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fa_gerar_dados_entrega_item ( nr_seq_fa_entrega_p bigint, cd_material_p text, qt_gerado_p text, nr_seq_entrega_item_p INOUT text, ds_erro_p INOUT text, nm_usuario_p text, cd_material_genrico_p text default null) AS $body$
DECLARE


qt_soma_disp_w		integer;
qt_diferenca_w		integer;
nr_sequencia_w		bigint;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	fa_entrega_medicacao_item
	where	nr_seq_fa_entrega	= nr_seq_fa_entrega_p
	and	cd_material		= cd_material_p
	order by 1;


BEGIN

if (nr_seq_fa_entrega_p IS NOT NULL AND nr_seq_fa_entrega_p::text <> '') then

	select	sum(qt_dispensar)
	into STRICT	qt_soma_disp_w
	from	fa_entrega_medicacao_item
	where	nr_seq_fa_entrega	= nr_seq_fa_entrega_p
	and	cd_material		= cd_material_p;

	qt_diferenca_w	:= (qt_soma_disp_w - (qt_gerado_p)::numeric );
	
	if (qt_diferenca_w = 0) then
	
		open C01;
		loop
		fetch C01 into	
			nr_sequencia_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			nr_seq_entrega_item_p := nr_seq_entrega_item_p || nr_sequencia_w|| ',';

            update fa_entrega_medicacao_item
            set cd_material_generico = cd_material_genrico_p
            where nr_sequencia = nr_sequencia_w
            and nr_seq_fa_entrega = nr_seq_fa_entrega_p
            and cd_material = cd_material_p;
			
			end;
		end loop;
		close C01;
	end if;	
	
	if (qt_diferenca_w > 0) then
		-- A quantidade gerada e menor que a quantidade a dispensar
		ds_erro_p := WHEB_MENSAGEM_PCK.get_texto(701675,null);	
	end if;
	
	if (qt_diferenca_w < 0) then
		-- A quantidade gerada e maior que a quantidade a dispensar		
		ds_erro_p := WHEB_MENSAGEM_PCK.get_texto(701674,null);	
	end if;
	
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fa_gerar_dados_entrega_item ( nr_seq_fa_entrega_p bigint, cd_material_p text, qt_gerado_p text, nr_seq_entrega_item_p INOUT text, ds_erro_p INOUT text, nm_usuario_p text, cd_material_genrico_p text default null) FROM PUBLIC;

