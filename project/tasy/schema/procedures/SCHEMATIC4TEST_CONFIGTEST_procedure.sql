-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE schematic4test_configtest (NR_SEQUENCIA_P bigint, NM_USUARIO_P text) AS $body$
DECLARE

NR_SEQUENCIA_W bigint;
NR_SEQ_PRESET_W bigint;
NR_SEQ_URL_W bigint;
NR_SEQ_BROWSER_W bigint;
NR_SEQ_SERVICE_W bigint;
NR_SEQ_ROBOT_W bigint;
NR_SEQ_GRID_W bigint;
IE_RUNTYPE_W smallint;
NR_SEQ_SCRIPT_W bigint;
NR_SEQ_PRESET_W1 bigint;
QTD_W bigint;
W_QTD bigint;
NR_SEQ_PRESET_W2 bigint;
NR_SEQ_GRID_W2 bigint;

--loop scripts with preset
C01 CURSOR FOR
    SELECT test1.NR_SEQ_SCRIPT NR_SEQ_SCRIPT, script.NR_SEQ_PRESET NR_SEQ_PRESET
       INTO STRICT NR_SEQ_SCRIPT_W, NR_SEQ_PRESET_W1
    FROM SCHEM_TEST_TEST test1, SCHEM_TEST_SCRIPT script    
    WHERE test1.NR_SEQ_SUITE = NR_SEQUENCIA_W
    AND script.NR_SEQUENCIA = test1.NR_SEQ_SCRIPT;


BEGIN
    --procedure that change preset to suite of tests
	INSERT INTO SCHEM_TEST_BEHOLDER(nr_sequencia, nm_usuario, dt_atualizacao, nm_usuario_nrec, dt_atualizacao_nrec, ds_interaction, ds_param_a)
	VALUES (nextval('schem_test_beholder_seq'), NM_USUARIO_P, clock_timestamp(), 'Robot', clock_timestamp(), 'SCHEMATIC4TEST_CONFIGTEST',
	'NR_SEQUENCIA_P as '||NR_SEQUENCIA_P);

    SELECT COUNT(DISTINCT test1.NR_SEQ_ROBOT) QTD
      INTO STRICT QTD_W
   FROM SCHEM_TEST_TEST test1
   WHERE test1.NR_SEQ_SUITE = NR_SEQUENCIA_P;

   IF (QTD_W = 1) THEN
  SELECT suite.NR_SEQUENCIA NR_SEQUENCIA, suite.NR_SEQ_PRESET NR_SEQ_PRESET
      INTO STRICT NR_SEQUENCIA_W, NR_SEQ_PRESET_W
  FROM SCHEM_TEST_SUITE suite 
  WHERE suite.NR_SEQUENCIA = NR_SEQUENCIA_P;

  IF (NR_SEQUENCIA_W IS NOT NULL AND NR_SEQUENCIA_W::text <> '') THEN
    UPDATE SCHEM_TEST_SUITE SET IE_JOBS = '0', DT_ATUALIZACAO = clock_timestamp(), NM_USUARIO = NM_USUARIO_P WHERE NR_SEQUENCIA = NR_SEQUENCIA_W;

    SELECT preset.NR_SEQ_URL NR_SEQ_URL, preset.NR_SEQ_BROWSER NR_SEQ_BROWSER, preset.NR_SEQ_SERVICE NR_SEQ_SERVICE, preset.NR_SEQ_ROBOT NR_SEQ_ROBOT, preset.NR_SEQ_GRID NR_SEQ_GRID, preset.IE_RUNTYPE IE_RUNTYPE
        INTO STRICT NR_SEQ_URL_W, NR_SEQ_BROWSER_W, NR_SEQ_SERVICE_W, NR_SEQ_ROBOT_W, NR_SEQ_GRID_W, IE_RUNTYPE_W
	FROM SCHEM_TEST_PRESET preset WHERE preset.NR_SEQUENCIA = NR_SEQ_PRESET_W;

    UPDATE SCHEM_TEST_TEST SET NR_SEQ_GRID = NR_SEQ_GRID_W, NR_SEQ_ROBOT = NR_SEQ_ROBOT_W, DT_ATUALIZACAO = clock_timestamp(), NM_USUARIO = NM_USUARIO_P WHERE NR_SEQ_SUITE = NR_SEQUENCIA_W;
    UPDATE SCHEM_TEST_PRESET SET DT_LAST = clock_timestamp() WHERE NR_SEQUENCIA = NR_SEQ_PRESET_W;

    OPEN C01;
    LOOP
    FETCH C01 INTO	
        NR_SEQ_SCRIPT_W, 
        NR_SEQ_PRESET_W1;
    EXIT WHEN NOT FOUND; /* apply on C01 */
    BEGIN	
        UPDATE SCHEM_TEST_SCRIPT SET NR_SEQ_PRESET = NR_SEQ_PRESET_W WHERE NR_SEQUENCIA = NR_SEQ_SCRIPT_W;
        COMMIT;

        CALL SCHEMATIC4TEST_CONFIGVALUE(NR_SEQ_SCRIPT_W, NM_USUARIO_P);

        UPDATE SCHEM_TEST_SCRIPT SET NR_SEQ_PRESET = NR_SEQ_PRESET_W1 WHERE NR_SEQUENCIA = NR_SEQ_SCRIPT_W;
        COMMIT;
    END;
    END LOOP;
    CLOSE C01;
  END IF;
  END IF;

  SELECT COUNT(DISTINCT grid.ie_type) QTD2
    INTO STRICT W_QTD
  FROM SCHEM_TEST_TEST test2, SCHEM_TEST_SUITE suite, SCHEM_TEST_PRESET preset, schem_test_grid grid
  WHERE preset.NR_SEQUENCIA = suite.NR_SEQ_PRESET 
  AND grid.NR_SEQUENCIA = PRESET.NR_SEQ_GRID
  AND test2.NR_SEQ_SUITE = NR_SEQUENCIA_P;

  IF (W_QTD > 1) THEN
     SELECT suite.NR_SEQ_PRESET NR_SEQ_PRESET
       INTO STRICT  NR_SEQ_PRESET_W2
     FROM SCHEM_TEST_SUITE suite 
     WHERE suite.NR_SEQUENCIA = NR_SEQUENCIA_P;

     SELECT preset.NR_SEQ_GRID NR_SEQ_GRID
       INTO STRICT  NR_SEQ_GRID_W2
     FROM SCHEM_TEST_PRESET preset 
     WHERE preset.NR_SEQUENCIA = NR_SEQ_PRESET_W2;

     UPDATE SCHEM_TEST_TEST SET NR_SEQ_GRID = NR_SEQ_GRID_W2, DT_ATUALIZACAO = clock_timestamp(), NM_USUARIO = NM_USUARIO_P WHERE NR_SEQ_SUITE = NR_SEQUENCIA_P;
     COMMIT;
  END IF;
  EXCEPTION
  WHEN no_data_found THEN
    RAISE NOTICE 'Erro: Data not found';
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE schematic4test_configtest (NR_SEQUENCIA_P bigint, NM_USUARIO_P text) FROM PUBLIC;

