-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gqa_classificacao_risco ( nr_seq_triagem_p bigint, nr_atendimento_p bigint, nm_usuario_p text, nr_regras_atendidas_p INOUT text, nr_discriminador_p bigint default 0, nr_restrigir_regras_p text default null, qt_horas_retroativa_p bigint default 0) AS $body$
DECLARE

                                    
nr_seq_pend_regra_w         bigint;	
nr_sequencia_w              bigint;
nr_seq_fluxograma_w         bigint;
cd_pessoa_fisica_w          varchar(10);
qt_idade_w                  bigint;
cd_setor_atendimento_w      bigint;
qt_idade_dias_w             integer;				
qt_peso_gramas_w            double precision;
nr_seq_triagem_w            bigint;
ie_restricao_complementar_w varchar(80);
ie_protocolo_assistencial_w boolean;
ds_triagem_w				varchar(255);

C01 CURSOR FOR
	SELECT  a.nr_sequencia
	from    gqa_pendencia_regra a,
            gqa_pendencia       b
    where   b.nr_sequencia	    = a.nr_seq_pendencia
    and     b.ie_tipo_pendencia	= 8
    and     b.ie_situacao 		= 'A'
    and     a.ie_situacao		= 'A'
    and     obter_se_gqa_regra_liberada(a.nr_sequencia) = 'S'
    and     coalesce(a.nr_seq_triagem, nr_seq_triagem_w) 	= nr_seq_triagem_w
    and     coalesce(a.nr_seq_manchester_fluxo, nr_seq_fluxograma_w)  = nr_seq_fluxograma_w
    and     qt_idade_w       between coalesce(a.qt_idade_min,0) and coalesce(a.qt_idade_max,999)
    and     qt_idade_dias_w  between coalesce(a.qt_dias_min,0) and coalesce(a.qt_dias_max,99999)
    and     qt_peso_gramas_w between coalesce(a.qt_peso_gramas_min,0) and coalesce(a.qt_peso_gramas_max,999999999)
    and     coalesce(a.cd_setor_atendimento,coalesce(cd_setor_atendimento_w,0))	= coalesce(cd_setor_atendimento_w,0)
    and     coalesce(a.nr_discriminador,coalesce(nr_discriminador_p,0)) = coalesce(nr_discriminador_p,0)
    and (coalesce(nr_restrigir_regras_p::text, '') = '' or position(a.nr_sequencia in nr_restrigir_regras_p) > 0);



BEGIN

select coalesce(max(a.nr_seq_manchester_fluxo),0)
into STRICT   nr_seq_fluxograma_w
from   triagem_pronto_atend a
where  a.nr_atendimento = nr_atendimento_p
and    not exists (
         SELECT x.nr_sequencia
         from   triagem_pronto_atend x
         where  x.nr_atendimento = a.nr_atendimento 
         and    x.nr_sequencia > a.nr_sequencia
       );

ie_protocolo_assistencial_w := (nr_restrigir_regras_p IS NOT NULL AND nr_restrigir_regras_p::text <> '');

if ie_protocolo_assistencial_w then

    select coalesce(nr_seq_triagem, nr_seq_triagem_p)
    into STRICT   nr_seq_triagem_w
    from   atendimento_paciente 
    where  nr_atendimento = nr_atendimento_p;

else
    nr_seq_triagem_w := nr_seq_triagem_p;
end if;


cd_pessoa_fisica_w	    := obter_pessoa_atendimento(nr_atendimento_p,'C');
cd_setor_atendimento_w	:= obter_setor_atendimento(nr_atendimento_p);
qt_idade_w		        := obter_idade_pf(cd_pessoa_fisica_w,clock_timestamp(),'A');
qt_idade_dias_w		    := obter_idade_pf(cd_pessoa_fisica_w, clock_timestamp(), 'DIA');
qt_peso_gramas_w	    := (coalesce(obter_peso_pf(cd_pessoa_fisica_w),0) * 1000);

if (nr_seq_triagem_w > 0) then
		
	open C01;
	loop
	fetch C01 into	
		nr_seq_pend_regra_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		
        select GQA_regra_complementar(nm_usuario_p, nr_atendimento_p, nr_seq_pend_regra_w)
        into STRICT ie_restricao_complementar_w
;

        if ie_restricao_complementar_w = 'X' then
        
            if ie_protocolo_assistencial_w then 
                
                    if (nr_regras_atendidas_p IS NOT NULL AND nr_regras_atendidas_p::text <> '') then
                        nr_regras_atendidas_p := nr_regras_atendidas_p || ',';
                    end if;

                    nr_regras_atendidas_p := nr_regras_atendidas_p || nr_seq_pend_regra_w;

            else
                select	nextval('gqa_pendencia_pac_seq')
                into STRICT	nr_sequencia_w
;
				

                insert into gqa_pendencia_pac(	nr_sequencia,
                                dt_atualizacao,
                                nm_usuario,
                                dt_atualizacao_nrec,
                                nm_usuario_nrec,
                                cd_pessoa_fisica,
                                nr_atendimento,
                                nr_seq_triagem,
                                NR_SEQ_PEND_REGRA)
                values (	nr_sequencia_w,
                                clock_timestamp(),
                                nm_usuario_p,
                                clock_timestamp(),
                                nm_usuario_p,
                                cd_pessoa_fisica_w,
                                nr_atendimento_p,
                                nr_seq_triagem_w,
                                nr_seq_pend_regra_w);
                commit;
				
				ds_triagem_w := substr(obter_desc_triagem( nr_seq_triagem_w ),1,255);
				
				CALL gerar_consulta_reg_mentor(nm_usuario_p, 'MAN_CLASSIF_RISCO' , nr_seq_pend_regra_w, nr_seq_triagem_w, nr_sequencia_w,null,ds_triagem_w);
                CALL GQA_GERAR_ACAO_REGRA(nr_seq_pend_regra_w,nr_sequencia_w,nr_atendimento_p,cd_pessoa_fisica_w,nm_usuario_p);
		
            end if;
          end if;
        end;


        
	end loop;
	close C01;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gqa_classificacao_risco ( nr_seq_triagem_p bigint, nr_atendimento_p bigint, nm_usuario_p text, nr_regras_atendidas_p INOUT text, nr_discriminador_p bigint default 0, nr_restrigir_regras_p text default null, qt_horas_retroativa_p bigint default 0) FROM PUBLIC;

