-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inativar_inconsistencia_farm ( nr_sequencia_p bigint, ds_justificativa_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_prescricao_w 			prescr_material.nr_prescricao%type;
nr_seq_material_w			prescr_material.nr_sequencia%type;
nr_seq_mat_cpoe_w			prescr_material.nr_seq_mat_cpoe%type;
nr_sequencia_diluicao_w		prescr_material.nr_sequencia_diluicao%type;

nr_seq_solucao_w			prescr_solucao.nr_seq_solucao%type;
nr_seq_dialise_cpoe_w		prescr_solucao.nr_seq_dialise_cpoe%type;

nr_seq_Inconsistencia_w 	prescr_material_incon_farm.nr_Seq_Inconsistencia%type;
nr_prescricao_vigente_w		prescr_medica.nr_prescricao%type;
ie_lib_prot_onc_w			gpt_presentation_rule.ie_lib_prot_onc%type;
nr_seq_atend_w				prescr_medica.nr_seq_atend%type;

c01 CURSOR FOR
SELECT
	a.nr_prescricao,
	c.nr_seq_inconsistencia,
	c.nr_seq_material,
	c.nr_sequencia as nr_seq_mat_incon_farm
from	prescr_medica a,
		prescr_material b,
		prescr_material_incon_farm c
where 	a.nr_prescricao 			= b.nr_prescricao
and		b.nr_prescricao 			= c.nr_prescricao
and		b.nr_sequencia  			= c.nr_seq_material
and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and 	coalesce(a.dt_liberacao_farmacia::text, '') = ''
and		((obter_funcao_ativa <> 252) or ((a.dt_inicio_analise_farm IS NOT NULL AND a.dt_inicio_analise_farm::text <> '') and a.nm_usuario_analise_farm = nm_usuario_p))
and		c.nr_seq_inconsistencia 	= nr_seq_Inconsistencia_w
and		b.nr_seq_mat_cpoe 			= nr_seq_mat_cpoe_w;

c02 CURSOR FOR
SELECT
	a.nr_prescricao,
	c.nr_seq_inconsistencia,
	c.nr_seq_solucao,	
	c.nr_sequencia as nr_seq_mat_incon_farm
from	prescr_medica a,
		prescr_material b,
		prescr_material_incon_farm c
where 	a.nr_prescricao 			= b.nr_prescricao
and		b.nr_prescricao 			= c.nr_prescricao
and		b.nr_sequencia_solucao		= c.nr_seq_solucao
and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and 	coalesce(a.dt_liberacao_farmacia::text, '') = ''
and		((obter_funcao_ativa <> 252) or ((a.dt_inicio_analise_farm IS NOT NULL AND a.dt_inicio_analise_farm::text <> '') and a.nm_usuario_analise_farm = nm_usuario_p))
and		c.nr_seq_inconsistencia 	= nr_seq_Inconsistencia_w
and		b.nr_seq_mat_cpoe 			= nr_seq_mat_cpoe_w;

c03 CURSOR FOR
SELECT  a.nr_sequencia as nr_sequencia_incon_farm
from    prescr_material_incon_farm a,
        prescr_solucao b
where   a.nr_prescricao = b.nr_prescricao
and     b.nr_seq_solucao = a.nr_seq_solucao
and     b.nr_prescricao >= nr_prescricao_vigente_w
and		a.nr_seq_inconsistencia = nr_seq_inconsistencia_w
and     b.nr_seq_dialise_cpoe = nr_seq_dialise_cpoe_w;

procedure inativar(	nr_seq_mat_incon_farm_p			prescr_material_incon_farm.nr_sequencia%type,
					nr_prescricao_p					prescr_medica.nr_prescricao%type := null,
					nr_seq_atend_p					prescr_medica.nr_seq_atend%type := null,
					ie_lib_prot_onc_p				gpt_presentation_rule.ie_lib_prot_onc%type := 'N') is;
BEGIN

	update	prescr_material_incon_farm
	set		ie_situacao				= 'I',
			dt_inativacao			= clock_timestamp(),
			nm_usuario_inativacao	= nm_usuario_p,
			ds_justificativa 		= substr(ds_justificativa_p,1,250)
	where	nr_sequencia 			= nr_seq_mat_incon_farm_p;

	if (nr_seq_atend_p IS NOT NULL AND nr_seq_atend_p::text <> '') and (ie_lib_prot_onc_p = 'S') then

		update	prescr_medica_compl a
		set		a.ie_consiste_prot_onc = 'N'
		where	a.nr_prescricao = nr_prescricao_p
		and		not exists (SELECT	1
							from	prescr_material_incon_farm b
							where	b.nr_prescricao = a.nr_prescricao
							and		b.ie_situacao = 'A');

	end if;

end;

procedure inativar_diluicoes(nr_seq_inconsistencia_p	prescr_material_incon_farm.nr_seq_inconsistencia%type,
							nr_prescricao_p				prescr_medica.nr_prescricao%type,
							nr_seq_material_p			prescr_material_incon_farm.nr_seq_material%type) is
begin
	if (nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') then
		update	prescr_material_incon_farm
		set		ie_situacao				= 'I',
				dt_inativacao			= clock_timestamp(),
				nm_usuario_inativacao	= nm_usuario_p,
				ds_justificativa		= substr(ds_justificativa_p,1,250)
		where	nr_sequencia			in (
			SELECT	b.nr_sequencia
			from
				prescr_material a,
				prescr_material_incon_farm b
			where	a.nr_prescricao			= nr_prescricao_p
			and		a.nr_sequencia_diluicao = nr_seq_material_p
			and		b.nr_prescricao			= a.nr_prescricao
			and		b.nr_seq_material 		= a.nr_sequencia
			and		b.nr_seq_inconsistencia	= nr_seq_inconsistencia_p
		);
	end if;
end;

begin

select	max(a.nr_seq_inconsistencia),
		max(a.nr_prescricao),
		max(a.nr_seq_material),
		max(b.nr_seq_atend)
into STRICT	nr_seq_inconsistencia_w,
		nr_prescricao_w,
		nr_seq_material_w,
		nr_seq_atend_w
from	prescr_material_incon_farm a,
		prescr_medica b
where	a.nr_sequencia = nr_sequencia_p;

select	coalesce(max(ie_lib_prot_onc), 'N')
into STRICT	ie_lib_prot_onc_w
from	gpt_presentation_rule
where	cd_perfil = wheb_usuario_pck.get_cd_perfil;

inativar(nr_seq_mat_incon_farm_p => nr_sequencia_p,
		nr_prescricao_p => nr_prescricao_w,
		nr_seq_atend_p => nr_seq_atend_w,
		ie_lib_prot_onc_p => ie_lib_prot_onc_w);

inativar_diluicoes(nr_seq_inconsistencia_w, nr_prescricao_w, nr_seq_material_w);

select 	max(a.nr_prescricao),
		max(a.nr_seq_material),
		max(a.nr_Seq_Inconsistencia),
		max(b.nr_seq_mat_cpoe),
		max(c.nr_seq_atend)
into STRICT	nr_prescricao_w,
		nr_seq_material_w,
		nr_seq_Inconsistencia_w,
		nr_seq_mat_cpoe_w,
		nr_seq_atend_w
from	prescr_material_incon_farm a,
		prescr_material b,
		prescr_medica c
where	c.nr_prescricao = b.nr_prescricao
and		b.nr_prescricao = a.nr_prescricao
and		b.nr_sequencia  = a.nr_seq_material
and		ie_agrupador in (1,4)
and		coalesce(b.ie_suspenso,'N') <> 'S'
and		c.cd_funcao_origem not in (924,950)
and		a.nr_sequencia  = nr_sequencia_p;

if (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') then
	
    for c01_w in c01
		loop
		inativar(nr_seq_mat_incon_farm_p => c01_w.nr_seq_mat_incon_farm,
				nr_prescricao_p => nr_prescricao_w,
				nr_seq_atend_p => nr_seq_atend_w,
				ie_lib_prot_onc_p => ie_lib_prot_onc_w);
		end loop;
	
elsif (coalesce(nr_seq_material_w::text, '') = '') then
	
	select	max(a.nr_prescricao),
			max(a.nr_seq_solucao),
			max(a.nr_Seq_Inconsistencia),
			max(b.nr_seq_mat_cpoe),
			max(c.nr_seq_atend)
	into STRICT	nr_prescricao_w,
			nr_seq_solucao_w,
			nr_seq_Inconsistencia_w,
			nr_seq_mat_cpoe_w,
			nr_seq_atend_w
	from	prescr_material_incon_farm a,
			prescr_material b,
			prescr_medica c
	where	c.nr_prescricao 		= b.nr_prescricao
	and		b.nr_prescricao			= a.nr_prescricao
	and		b.nr_sequencia_solucao 	= a.nr_seq_solucao
	and		ie_agrupador 			in (1,4)
	and		coalesce(b.ie_suspenso,'N') 	<> 'S'
	and		c.cd_funcao_origem 		not in (924,950)
	and		a.nr_sequencia  		= nr_sequencia_p;
		
	for c02_w in c02
		loop
		inativar(nr_seq_mat_incon_farm_p => c02_w.nr_seq_mat_incon_farm,
				nr_prescricao_p => nr_prescricao_w,
				nr_seq_atend_p => nr_seq_atend_w,
				ie_lib_prot_onc_p => ie_lib_prot_onc_w);
		end loop;
		
end if;

select	max(b.nr_seq_dialise_cpoe),
		max(a.nr_seq_inconsistencia)
into STRICT	nr_seq_dialise_cpoe_w,
		nr_seq_inconsistencia_w
from	prescr_material_incon_farm a,
		prescr_solucao b
where	a.nr_prescricao = b.nr_prescricao
and		a.nr_seq_solucao = b.nr_seq_solucao
and		a.nr_sequencia = nr_sequencia_p;

if (nr_seq_dialise_cpoe_w IS NOT NULL AND nr_seq_dialise_cpoe_w::text <> '') then

	nr_prescricao_vigente_w := gpt_obter_prescricao_vigente(nr_seq_dialise_cpoe_w, 'DI');

	for c03_w in c03
	loop
		inativar(nr_seq_mat_incon_farm_p => c03_w.nr_sequencia_incon_farm);
	end loop;
end if;

commit;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inativar_inconsistencia_farm ( nr_sequencia_p bigint, ds_justificativa_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

