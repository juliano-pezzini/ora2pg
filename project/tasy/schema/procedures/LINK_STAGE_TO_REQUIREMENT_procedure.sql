-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE link_stage_to_requirement ( in_nr_seq_proj_cron_etapa_p LATAM_REQUISITO_ETAPA.NR_SEQ_PROJ_CRON_ETAPA%TYPE DEFAULT 0, in_nr_seq_requisito_p LATAM_REQUISITO_ETAPA.NR_SEQ_REQUISITO%TYPE DEFAULT NULL, in_nm_usuario_p LATAM_REQUISITO_ETAPA.NM_USUARIO%TYPE DEFAULT NULL, in_link_flag_p text  DEFAULT NULL) AS $body$
DECLARE

    ie_liberar_desenv_old_w latam_requisito.ie_liberar_desenv%TYPE;
    nr_sequencia_w          LATAM_REQUISITO_ETAPA.NR_SEQ_REQUISITO%TYPE;

BEGIN
    SELECT latam_requisito.ie_liberar_desenv
    INTO STRICT ie_liberar_desenv_old_w
    FROM latam_requisito
    WHERE latam_requisito.nr_sequencia = in_nr_seq_requisito_p;

    IF ( in_link_flag_p = 'LINK' ) THEN
        SELECT MAX(nr_sequencia)
        INTO STRICT nr_sequencia_w
        FROM latam_requisito_etapa
        WHERE latam_requisito_etapa.nr_seq_requisito = in_nr_seq_requisito_p
        AND latam_requisito_etapa.nr_seq_proj_cron_etapa = in_nr_seq_proj_cron_etapa_p;

        IF (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') THEN
            CALL wheb_mensagem_pck.exibir_mensagem_abort(obter_desc_expressao(1067544));
        ELSE
            INSERT INTO latam_requisito_etapa(
                nr_sequencia,
                dt_atualizacao,
                nm_usuario,
                dt_atualizacao_nrec,
                nm_usuario_nrec,
                nr_seq_requisito,
                ie_situacao,
                nr_seq_proj_cron_etapa
            ) VALUES (
                nextval('latam_requisito_etapa_seq'),
                clock_timestamp(),
                in_nm_usuario_p,
                clock_timestamp(),
                in_nm_usuario_p,
                in_nr_seq_requisito_p,
                'A',
                in_nr_seq_proj_cron_etapa_p
            );
        END IF;
    ELSE
        DELETE FROM latam_requisito_etapa
        WHERE nr_seq_proj_cron_etapa = in_nr_seq_proj_cron_etapa_p
        AND nr_seq_requisito = in_nr_seq_requisito_p;

    END IF;

    CALL generate_latam_log(in_nr_seq_requisito_p, ie_liberar_desenv_old_w, CASE WHEN in_link_flag_p = 'LINK' THEN 1032157 ELSE 1032159 END);
    COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE link_stage_to_requirement ( in_nr_seq_proj_cron_etapa_p LATAM_REQUISITO_ETAPA.NR_SEQ_PROJ_CRON_ETAPA%TYPE DEFAULT 0, in_nr_seq_requisito_p LATAM_REQUISITO_ETAPA.NR_SEQ_REQUISITO%TYPE DEFAULT NULL, in_nm_usuario_p LATAM_REQUISITO_ETAPA.NM_USUARIO%TYPE DEFAULT NULL, in_link_flag_p text  DEFAULT NULL) FROM PUBLIC;

