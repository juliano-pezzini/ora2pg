-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_categoria_conv_agenda ( cd_convenio_p bigint, cd_plano_p text, cd_senha_p text, cd_guia_p text, dt_validade_carteira_p timestamp, cd_usuario_convenio_p text, ds_erro_p INOUT text, ds_consistencia_p INOUT text, cd_categoria_p text, ie_tipo_atendimento_p bigint, cd_funcao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ie_exige_senha_atend_w		varchar(1);
ie_exige_plano_w		varchar(1);
ie_exige_carteira_atend_w	varchar(1);
ie_exige_validade_atend_W	varchar(1);
ie_senha_w			varchar(1);
ie_guia_w			varchar(1);
ie_exige_fim_vigencia_w		varchar(1);
ds_erro_w			varchar(255) := '';
ie_exige_origem_w		varchar(1);/* Rafael em 01/03/2007 OS51372 */
IE_EXIGE_GUIA_PRINC_W		varchar(01);
ie_consiste_guia_atend_w	varchar(01);
ie_exige_compl_usuario_w	varchar(01);
ds_erro_ww			varchar(4000);
ie_exige_senha_w		varchar(1);
ie_exige_guia_w   		varchar(1);


BEGIN 
 
if (cd_convenio_p IS NOT NULL AND cd_convenio_p::text <> '') then 
 
	select	max(Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_p, 'IE_EXIGE_SENHA_ATEND')) ie_exige_senha_atend, /*regra especial = 'E' regra especial*/ 
		max(Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_p, 'IE_EXIGE_PLANO')) ie_exige_plano, 
		max(Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_p, 'IE_EXIGE_CARTEIRA_ATEND')) ie_exige_carteira_atend, 
		max(Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_p, 'IE_EXIGE_VALIDADE_ATEND')) ie_exige_validade_atend, 
		max(Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_p, 'IE_EXIGE_ORIGEM')) ie_exige_origem, 
		max(Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_p, 'IE_EXIGE_GUIA_PRINC')) IE_EXIGE_GUIA_PRINC, 
		max(Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_p, 'IE_EXIGE_FIM_VIGENCIA')), 
		max(Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_p, 'IE_CONSISTE_GUIA_ATEND')), 
		max(Obter_Valor_Conv_Estab(cd_convenio, cd_estabelecimento_p, 'IE_EXIGE_COMPL_USUARIO'))	 
	into STRICT	ie_exige_senha_atend_w, 
		ie_exige_plano_w, 
		ie_exige_carteira_atend_w, 
		ie_exige_validade_atend_W, 
		ie_exige_origem_w, 
		IE_EXIGE_GUIA_PRINC_w, 
		ie_exige_fim_vigencia_w, 
		ie_consiste_guia_atend_w, 
		ie_exige_compl_usuario_w 
	from	convenio 
	where	cd_convenio	= cd_convenio_p;
 
	if (ie_exige_senha_atend_w = 'E') then 
		select	obter_se_exige_guia_senha(cd_convenio_p, ie_tipo_atendimento_p, 1,'S', cd_estabelecimento_p, null, null, null, null,null,null,cd_categoria_p,cd_plano_p, null) 
		into STRICT	ie_exige_senha_w 
		;
	end if;
 
	if (cd_funcao_p <> 820) and (coalesce(cd_senha_p::text, '') = '') and (ie_exige_senha_w = 'S') then 
		ds_erro_ww	:= WHEB_MENSAGEM_PCK.get_texto(281427) || chr(13) || chr(10);
	end if;
 
	if (ie_exige_senha_atend_w = 'E') and (ie_exige_guia_princ_w <> 'G') then 
		select	obter_se_exige_guia_senha(cd_convenio_p, ie_tipo_atendimento_p, 1,'G', cd_estabelecimento_p, null, null, null, null,null,null,cd_categoria_p,cd_plano_p, null) 
		into STRICT	ie_exige_guia_w 
		;
	end if;
 
	if (coalesce(cd_guia_p::text, '') = '') and 
		((IE_EXIGE_GUIA_PRINC_w	= 'S') or (ie_exige_guia_w = 'S')) then 
		ds_erro_ww	:= ds_erro_ww || WHEB_MENSAGEM_PCK.get_texto(281428) || chr(13) || chr(10);
	elsif (coalesce(cd_guia_p::text, '') = '') and (IE_EXIGE_GUIA_PRINC_w	= 'G') then 
		ds_erro_ww	:= ds_erro_ww || WHEB_MENSAGEM_PCK.get_texto(281428) || chr(13) || chr(10);	
	end if;
 
	if (ie_exige_senha_atend_w = 'E') then 
		select	obter_se_exige_guia_senha(cd_convenio_p, ie_tipo_atendimento_p, 1,'P', cd_estabelecimento_p, null, null, null, null,null,null,cd_categoria_p,cd_plano_p, null) 
		into STRICT	ie_exige_plano_w 
		;
	end if;
 
	if (coalesce(cd_plano_p::text, '') = '') and (ie_exige_plano_w = 'S') then 
		ds_erro_ww	:= ds_erro_ww || WHEB_MENSAGEM_PCK.get_texto(281429) || chr(13) || chr(10);
	end if;
 
	if (ie_exige_senha_atend_w = 'E') then 
		select	obter_se_exige_guia_senha(cd_convenio_p, ie_tipo_atendimento_p, 1,'C', cd_estabelecimento_p, null, null, null, null,null,null,cd_categoria_p,cd_plano_p, null) 
		into STRICT	ie_exige_carteira_atend_w 
		;
	end if;
 
	if (coalesce(cd_usuario_convenio_p::text, '') = '') and (ie_exige_carteira_atend_w = 'S') then 
		ds_erro_ww	:= ds_erro_ww || WHEB_MENSAGEM_PCK.get_texto(281430) || chr(13) || chr(10);
	end if;
 
	if (ie_exige_senha_atend_w in ('S','E')) then 
		select	obter_se_exige_guia_senha(cd_convenio_p, ie_tipo_atendimento_p, 1,'V', cd_estabelecimento_p, null, null, null, null,null,null,cd_categoria_p,cd_plano_p, null) 
		into STRICT	ie_exige_validade_atend_W 
		;
	end if;
 
	if (coalesce(dt_validade_carteira_p::text, '') = '') and (ie_exige_validade_atend_W = 'S') then 
		ds_erro_ww	:= ds_erro_ww || WHEB_MENSAGEM_PCK.get_texto(281431) || chr(13) || chr(10);
	end if;
 
	if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then 
		ds_erro_ww	:= ds_erro_ww || ds_erro_w;
	end if;
end if;
ds_erro_p	:= substr(ds_erro_ww, 1, 255);
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_categoria_conv_agenda ( cd_convenio_p bigint, cd_plano_p text, cd_senha_p text, cd_guia_p text, dt_validade_carteira_p timestamp, cd_usuario_convenio_p text, ds_erro_p INOUT text, ds_consistencia_p INOUT text, cd_categoria_p text, ie_tipo_atendimento_p bigint, cd_funcao_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

