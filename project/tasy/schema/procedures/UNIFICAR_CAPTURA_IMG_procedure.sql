-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE unificar_captura_img ( nr_seq_laudo_p bigint, nm_usuario_p text) AS $body$
DECLARE


cursor_captura CURSOR(nr_seq_interno_atual bigint)
FOR
  SELECT distinct img.nr_seq_captura
  from prescr_procedimento pp
  join procedimento_paciente proc on (pp.nr_prescricao = proc.nr_prescricao
                                  and pp.nr_sequencia = proc.nr_sequencia_prescricao)
  join  prescr_proc_captura_img img ON (pp.nr_prescricao = img.nr_prescricao
                                    and img.nr_sequencia_prescricao = pp.nr_sequencia)
  where proc.nr_laudo = nr_seq_laudo_p
  and img.nr_seq_captura not in (SELECT img.nr_seq_captura from prescr_procedimento pp
                                 join  prescr_proc_captura_img img ON (pp.nr_prescricao = img.nr_prescricao
                                                                   and img.nr_sequencia_prescricao = pp.nr_sequencia)
                                 where pp.nr_seq_interno = nr_seq_interno_atual);

cursor_laudo CURSOR FOR
	SELECT pp.nr_seq_interno
	from prescr_procedimento pp
	join procedimento_paciente proc ON (pp.nr_prescricao = proc.nr_prescricao
                                  and pp.nr_sequencia = proc.nr_sequencia_prescricao)
	where proc.nr_laudo = nr_seq_laudo_p;

linha_cursor_laudo cursor_laudo%rowtype;
linha_cursor_captura cursor_captura%rowtype;
nr_prescricao_atual_w bigint;
nr_seq_prescricao_atual_w integer;


BEGIN
  open cursor_laudo;
  loop
    fetch cursor_laudo into linha_cursor_laudo;
    EXIT WHEN NOT FOUND; /* apply on cursor_laudo */
    begin
      open cursor_captura(linha_cursor_laudo.nr_seq_interno);
      loop
        fetch cursor_captura into linha_cursor_captura;
        EXIT WHEN NOT FOUND; /* apply on cursor_captura */
        begin
          select nr_prescricao, nr_sequencia
          into STRICT nr_prescricao_atual_w, nr_seq_prescricao_atual_w
          from prescr_procedimento
          where nr_seq_interno = linha_cursor_laudo.nr_seq_interno;

          insert into prescr_proc_captura_img values (nextval('prescr_proc_captura_img_seq'),
                                clock_timestamp(),
                                nm_usuario_p,
                                clock_timestamp(),
                                nm_usuario_p,
                                nr_prescricao_atual_w,
                                nr_seq_prescricao_atual_w,
                                linha_cursor_captura.nr_seq_captura);
        end;
      end loop;
      close cursor_captura;
    end;
  end loop;
  close cursor_laudo;
  commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE unificar_captura_img ( nr_seq_laudo_p bigint, nm_usuario_p text) FROM PUBLIC;

