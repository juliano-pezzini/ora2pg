-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_juros_multa_bordero (nr_bordero_p bigint, vl_juros_p bigint, vl_multa_p bigint, ie_perc_valor_p text) AS $body$
DECLARE

 
vl_total_juros_w	double precision;
vl_total_multa_w	double precision;
nr_titulo_w		bigint;
cont_w			bigint;
ie_titulo_bordero_w	varchar(10);


BEGIN 
 
select	coalesce(ie_titulo_bordero, 'N') 
into STRICT	ie_titulo_bordero_w 
from	bordero_pagamento 
where	nr_bordero	= nr_bordero_p;
 
if (ie_perc_valor_p = 'P') then 
	if (ie_titulo_bordero_w = 'N') then 
		update	titulo_pagar 
		set	vl_juros_bordero 	= CASE WHEN vl_juros_p = NULL THEN vl_juros_bordero  ELSE vl_bordero * vl_juros_p / 100 END , 
			vl_multa_bordero	= CASE WHEN vl_multa_p = NULL THEN vl_multa_bordero  ELSE vl_bordero * vl_multa_p / 100 END  
		where	nr_bordero 		= nr_bordero_p;
	else 
		update	bordero_tit_pagar 
		set	vl_juros_bordero 	= CASE WHEN vl_juros_p = NULL THEN vl_juros_bordero  ELSE vl_bordero * vl_juros_p / 100 END , 
			vl_multa_bordero	= CASE WHEN vl_multa_p = NULL THEN vl_multa_bordero  ELSE vl_bordero * vl_multa_p / 100 END  
		where	nr_bordero 		= nr_bordero_p;
	end if;
else 
	select	count(*) 
	into STRICT	cont_w 
	from	titulo_pagar_bordero_v 
	where	nr_bordero = nr_bordero_p;
 
	if (ie_titulo_bordero_w = 'N') then 
		update	titulo_pagar	 
		set	vl_juros_bordero = CASE WHEN vl_juros_p = NULL THEN vl_juros_bordero  ELSE dividir_sem_round(vl_juros_p, cont_w) END , 
			vl_multa_bordero = CASE WHEN vl_multa_p = NULL THEN vl_multa_bordero  ELSE dividir_sem_round(vl_multa_p, cont_w) END  
		where	nr_bordero = nr_bordero_p;
	else 
		update	bordero_tit_pagar 
		set	vl_juros_bordero = CASE WHEN vl_juros_p = NULL THEN vl_juros_bordero  ELSE dividir_sem_round(vl_juros_p, cont_w) END , 
			vl_multa_bordero = CASE WHEN vl_multa_p = NULL THEN vl_multa_bordero  ELSE dividir_sem_round(vl_multa_p, cont_w) END  
		where	nr_bordero = nr_bordero_p;
	end if;
 
	select	sum(vl_juros_bordero) 
	into STRICT	vl_total_juros_w 
	from	titulo_pagar_bordero_v 
	where	nr_bordero = nr_bordero_p;
 
	select	sum(vl_multa_bordero) 
	into STRICT	vl_total_multa_w 
	from	titulo_pagar_bordero_v 
	where	nr_bordero = nr_bordero_p;
 
	select	max(nr_titulo) 
	into STRICT	nr_titulo_w 
	from	titulo_pagar_bordero_v 
	where	nr_bordero = nr_bordero_p 
	and	vl_bordero = (SELECT	max(vl_bordero) 
			   from	titulo_pagar_bordero_v 
			   where	nr_bordero = nr_bordero_p);
 
	if (vl_total_juros_w <> vl_juros_p) then 
		if (ie_titulo_bordero_w = 'N') then 
			update	titulo_pagar 
			set	vl_juros_bordero	= CASE WHEN vl_juros_p = NULL THEN vl_juros_bordero  ELSE vl_juros_bordero + (vl_juros_p - vl_total_juros_w) END  
			where	nr_titulo 		= nr_titulo_w;
		else	 
			update	bordero_tit_pagar 
			set	vl_juros_bordero	= CASE WHEN vl_juros_p = NULL THEN vl_juros_bordero  ELSE vl_juros_bordero + (vl_juros_p - vl_total_juros_w) END  
			where	nr_titulo 		= nr_titulo_w;
		end if;
	end if;
 
	if (vl_total_multa_w <> vl_multa_p) then 
		if (ie_titulo_bordero_w = 'N') then 
			update	titulo_pagar 
			set	vl_multa_bordero	= CASE WHEN vl_multa_p = NULL THEN vl_multa_bordero  ELSE vl_multa_bordero + (vl_multa_p - vl_total_multa_w) END  
			where	nr_titulo 		= nr_titulo_w;
		else	 
			update	bordero_tit_pagar 
			set	vl_multa_bordero	= CASE WHEN vl_multa_p = NULL THEN vl_multa_bordero  ELSE vl_multa_bordero + (vl_multa_p - vl_total_multa_w) END  
			where	nr_titulo 		= nr_titulo_w;
		end if;
	end if;
	 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_juros_multa_bordero (nr_bordero_p bigint, vl_juros_p bigint, vl_multa_p bigint, ie_perc_valor_p text) FROM PUBLIC;

