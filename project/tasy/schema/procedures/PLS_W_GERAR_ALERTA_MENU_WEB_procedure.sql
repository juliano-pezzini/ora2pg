-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_w_gerar_alerta_menu_web () AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Carregar todos os menus que deverão ficar piscando no acesso do prestador
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  ]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  x  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atenção: 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_usu_prest_w		pls_usuario_web.nr_sequencia%type;
nr_seq_prestador_w		pls_prestador.nr_sequencia%type;

ie_gera_alerta_compl_conta_w	varchar(1) := 'N';
ie_hab_complemento_guia_w	varchar(1) := 'N';
ie_hab_comunicado_externo_w	varchar(1) := 'N';
ie_hab_justifica_prestador_w	varchar(1) := 'N';
ie_hab_compl_opme_w		varchar(1) := 'N';
ie_hab_complemento_conta_w	varchar(1) := 'N';
dt_regra_compl_guia_w		varchar(20);

/* Variáveis utilizadas para inserir os valores S ou N  na tabela */

ie_comunicado_externo_w		varchar(1) := 'N';
ie_justifica_prestador_w 	varchar(1) := 'N';
ie_complemento_guia_w		varchar(1) := 'N';
ie_complemento_conta_w		varchar(1) := 'N';
ie_continua_ver_compl_w		boolean := false;

qt_registros_w			bigint := 0;
nr_seq_alerta_menu_w		w_pls_alerta_menu_web.nr_sequencia%type := 0;



C01 CURSOR FOR
	SELECT 	nr_sequencia,
		nr_seq_perfil_web,
		nm_usuario_web,
		coalesce(cd_estabelecimento,1) cd_estabelecimento
	from	pls_usuario_web
	where	ie_situacao = 'A'
	order by 1;
		
C02 CURSOR FOR
	SELECT 	nr_seq_prestador
	from  	pls_prestador_usuario_web p
	where 	p.nr_seq_usuario = nr_seq_usu_prest_w	
	and	p.ie_situacao = 'A';
			
C03 CURSOR FOR
	SELECT 	nr_sequencia,
		ie_tipo_saida
	from   	pls_guia_plano a
	where  	a.nr_seq_prestador = nr_seq_prestador_w	
	and	a.dt_autorizacao >= dt_regra_compl_guia_w	
	and	a.ie_tipo_guia 		= '3'                        
	and 	a.ie_status 		= '1'         							
	and	coalesce(a.nr_seq_prestador_web::text, '') = ''			
	and	a.ie_estagio_complemento <> '1';

BEGIN
/*exec_sql_dinamico('JOB','truncate table w_pls_alerta_menu_web');

delete from w_pls_alerta_menu_web;*/
for	R_C01 in C01 loop
	begin
		qt_registros_w	:= 0;
		
		nr_seq_usu_prest_w := R_C01.NR_SEQUENCIA;
		
		ie_hab_complemento_guia_w       :=	pls_obter_param_web(1246,54, R_C01.cd_estabelecimento,
									    nr_seq_usu_prest_w, R_C01.nr_seq_perfil_web, null,
									    null, 'P', R_C01.nm_usuario_web,
									    null);
									
		ie_hab_comunicado_externo_w     :=	pls_obter_param_web(1246,28, R_C01.cd_estabelecimento,
									    nr_seq_usu_prest_w, R_C01.nr_seq_perfil_web, null,
									    null, 'P', R_C01.nm_usuario_web,
									    null);
									
		ie_hab_justifica_prestador_w    :=	pls_obter_param_web(1246,20, R_C01.cd_estabelecimento,
									    nr_seq_usu_prest_w, R_C01.nr_seq_perfil_web, null,
									    null, 'P', R_C01.nm_usuario_web,
									    null);
									
		ie_hab_compl_opme_w		:= 	pls_obter_param_web(1295,8, R_C01.cd_estabelecimento,
									    nr_seq_usu_prest_w, R_C01.nr_seq_perfil_web, null,
									    null, 'P', R_C01.nm_usuario_web,
									    null);							
		
		ie_hab_complemento_conta_w	:= 	pls_obter_param_web(1249,4, R_C01.cd_estabelecimento,
									    nr_seq_usu_prest_w, R_C01.nr_seq_perfil_web, null,
									    null, 'P', R_C01.nm_usuario_web,
									    null);	

		ie_gera_alerta_compl_conta_w	:=	pls_obter_param_web(1249,57, R_C01.cd_estabelecimento,
									    nr_seq_usu_prest_w, R_C01.nr_seq_perfil_web, null,
									    null, 'P', R_C01.nm_usuario_web,
									    null);							
		
		/* Verifica se existe comunicados externos para o prestador  */

		if (ie_hab_comunicado_externo_w = 'S') then
			ie_comunicado_externo_w := pls_obter_cominc_externo_web(R_C01.nr_seq_perfil_web,  nr_seq_usu_prest_w, R_C01.nm_usuario_web, 'P', null, null);
		end if;
				
		/* Verifica se existe justificativa pendente para o prestador  */
	
		if (ie_hab_justifica_prestador_w = 'S') then
			select 	count(1)
			into STRICT    qt_registros_w
			from 	pls_auditoria a
			where	(((a.nr_seq_guia IS NOT NULL AND a.nr_seq_guia::text <> '')  
			and 	exists( SELECT  1  
					from   pls_guia_plano x 
					where  x.nr_sequencia = a.nr_seq_guia 
					and   (x.nr_seq_prestador_web = nr_seq_usu_prest_w
					or    ((coalesce(x.nr_seq_prestador_web::text, '') = ''  or a.ie_permite_just_prestadores = 'S')
					and     exists ( select 1 
							from 	pls_prestador_usuario_web y 
							where	y.nr_seq_usuario = nr_seq_usu_prest_w
							and	y.ie_situacao = 'A' 
							and	y.nr_seq_prestador = a.nr_seq_prestador)))))
				or    ((a.nr_seq_requisicao IS NOT NULL AND a.nr_seq_requisicao::text <> '') 
					and   exists( select   1 
						       from	pls_requisicao x 
						       where    x.nr_sequencia = a.nr_seq_requisicao 
						       and     (x.nr_seq_prestador_web = nr_seq_usu_prest_w 
						       or      ((coalesce(x.nr_seq_prestador_web::text, '') = ''  or a.ie_permite_just_prestadores = 'S')
						       and	exists ( select 1 
									from 	pls_prestador_usuario_web y 
									where	y.nr_seq_usuario = nr_seq_usu_prest_w
									and	y.ie_situacao = 'A' 
									and	y.nr_seq_prestador = a.nr_seq_prestador))))))
			and    ie_status = 'AJ';
			
			if (qt_registros_w > 0) then
				ie_justifica_prestador_w := 'S';
			end if;
						
			--Verifica se existe complemento de OPME pendente para requisição na análise
			if ( ie_hab_compl_opme_w = 'S' and qt_registros_w = 0 ) then			
				select 	count(1)
				into STRICT	qt_registros_w
				from   	pls_requisicao a,
					pls_auditoria b
				where  	b.nr_seq_requisicao = a.nr_sequencia
				and    	b.ie_status = 'ACO'
				and    	exists (SELECT	1
						from  	pls_prestador_usuario_web y 
						where  	y.nr_seq_prestador 	= a.nr_seq_prestador_exec
						and	y.nr_seq_usuario 	= nr_seq_usu_prest_w  
						and	y.ie_situacao 		= 'A' );
				
				if (qt_registros_w > 0) then
					ie_justifica_prestador_w := 'S';
				end if;				
			end if;	

			if (ie_justifica_prestador_w = 'N') then				
				select	count(1)
				into STRICT	qt_registros_w
				from	pls_notificacao_tws a,
					pls_prestador_usuario_web b
				where   b.nr_seq_prestador	= a.nr_seq_prestador
				and	b.nr_seq_usuario	= nr_seq_usu_prest_w
				and    	b.ie_situacao		= 'A'
				and    	a.ie_tipo_processo	= 'JC'
				and    	a.ie_status		= 'P'
				and    	a.dt_notificacao	>= (clock_timestamp() - interval '90 days');

				if (qt_registros_w > 0) then
					ie_justifica_prestador_w := 'S';
				end if;	
			end if;
		end if;
		
		/* Verifica se existe transação complementar pendente para o prestador  */

		if (ie_hab_complemento_guia_w = 'S') then
			dt_regra_compl_guia_w := pls_obter_regra_compl_guia;					
			select 	count(1)
			into STRICT   	qt_registros_w
			from   	pls_guia_plano a                    
			where  	a.nr_seq_prestador_web  = nr_seq_usu_prest_w
			and	a.ie_tipo_guia 		= '3'                        
			and 	a.ie_status 		= '1'	
			and	a.dt_autorizacao >= dt_regra_compl_guia_w		
			and	((0 = (SELECT count(1) from pls_diagnostico b where b.nr_seq_guia = a.nr_sequencia and (b.cd_doenca IS NOT NULL AND b.cd_doenca::text <> ''))) or (coalesce(a.ie_tipo_saida::text, '') = ''))
			and	a.ie_estagio_complemento <> '1'
			and not exists (select 1  
					from pls_conta c 
					where c.nr_seq_guia = a.nr_sequencia);
										
			if (qt_registros_w = 0 ) then
			
				for R_C02 in C02 loop
					begin					
					nr_seq_prestador_w := R_C02.nr_seq_prestador;
					
					for	R_C03 in C03 loop
						begin	
						ie_continua_ver_compl_w := false;

						 if (coalesce(R_C03.ie_tipo_saida::text, '') = '') then
							ie_continua_ver_compl_w := true;
						 else
							select count(1)
							into STRICT   qt_registros_w
							from   pls_diagnostico b
							where  b.nr_seq_guia = R_C03.nr_sequencia
							and    (b.cd_doenca IS NOT NULL AND b.cd_doenca::text <> '');
							
							if (qt_registros_w = 0) then
								ie_continua_ver_compl_w := true;
							end if;
						 end if;						
						 if (ie_continua_ver_compl_w) then
							select	count(1)
							into STRICT	qt_registros_w
							from	pls_conta
							where	nr_seq_guia = R_C03.nr_sequencia;
							
							if (qt_registros_w = 0) then
								ie_complemento_guia_w := 'S';
								exit;
							end if;
						 end if;						
						end;
					end loop;					
					if (ie_complemento_guia_w = 'S') then
						exit;
					end if;					
					end;
				end loop;				
			else	
				ie_complemento_guia_w := 'S';		
			end if;
		end if;
		
		/* Verifica se existe conta pendente para complemento para o prestador  */

		if (ie_gera_alerta_compl_conta_w = 'S') and (ie_hab_complemento_conta_w = 'S') then
			select 	count(1)
			into STRICT	qt_registros_w
			from	pls_guia_plano a
			where  	a.ie_status   = '1'
			and	a.ie_estagio   <> 8   
			and	a.ie_estagio_complemento = 1   
			and	coalesce(a.nr_seq_guia_principal::text, '') = ''  
			and	a.dt_autorizacao >= clock_timestamp() - interval '90 days' --Verifica se há conta pendente de complemento somente nos ultimos 60 dias
			and	not exists (	SELECT 	1       
						from	pls_conta y      
						where 	y.cd_guia  = a.cd_guia     
						and	y.nr_seq_segurado = a.nr_seq_segurado) 
			and    	exists (	select	1 
					from  	pls_prestador_usuario_web y 
					where  	y.nr_seq_prestador 	= a.nr_seq_prestador
					and	y.nr_seq_usuario 	= nr_seq_usu_prest_w  
					and	y.ie_situacao 		= 'A' );	

			if (qt_registros_w > 0) then
				ie_complemento_conta_w	:= 'S';
			end if;				
		end if;
		
		select 	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_alerta_menu_w
		from	w_pls_alerta_menu_web
		where	nr_seq_usu_prest_web = nr_seq_usu_prest_w;
		
		if ( nr_seq_alerta_menu_w = 0 ) then
			insert into w_pls_alerta_menu_web(
					nr_sequencia, nr_seq_usu_prest_web, ie_solicitacao_pendente_estip,
					ie_justificativa_prestador, ie_transacao_compl, ie_comunicado_externo,
					ie_complemento_conta, dt_atualizacao, nm_usuario, 
					dt_atualizacao_nrec, nm_usuario_nrec)
				values (	nextval('w_pls_alerta_menu_web_seq'), nr_seq_usu_prest_w, 'N', 
					ie_justifica_prestador_w, ie_complemento_guia_w, ie_comunicado_externo_w,
					ie_complemento_conta_w, clock_timestamp(), 'JOB', 
					clock_timestamp(), 'JOB');
		else
			update 	w_pls_alerta_menu_web
			set	ie_justificativa_prestador	= ie_justifica_prestador_w,
				ie_transacao_compl 		= ie_complemento_guia_w,
				ie_comunicado_externo 		= ie_comunicado_externo_w,
				ie_complemento_conta		= ie_complemento_conta_w,
				dt_atualizacao 			= clock_timestamp()
			where	nr_sequencia 			= nr_seq_alerta_menu_w;			
		end if;
		
		nr_seq_alerta_menu_w 		:= 0;
		ie_comunicado_externo_w		:= 'N';
		ie_justifica_prestador_w 	:= 'N';
		ie_complemento_guia_w 		:= 'N';
		ie_complemento_conta_w 		:= 'N';
	end;
end loop;	

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_w_gerar_alerta_menu_web () FROM PUBLIC;

