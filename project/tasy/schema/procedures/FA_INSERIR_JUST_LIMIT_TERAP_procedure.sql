-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fa_inserir_just_limit_terap ( nr_seq_receita_p bigint, ds_justificativa_p text) AS $body$
DECLARE



nr_seq_receita_item_w		bigint;
qt_idade_w			bigint;
cd_pessoa_fisica_w		varchar(10);


BEGIN

if (nr_seq_receita_p IS NOT NULL AND nr_seq_receita_p::text <> '') then

	select	max(cd_pessoa_fisica)
	into STRICT	cd_pessoa_fisica_w
	from	fa_receita_farmacia
	where	nr_sequencia = nr_seq_receita_p;

	select	max(obter_idade(dt_nascimento,coalesce(dt_obito,clock_timestamp()),'DIA'))
	into STRICT	qt_idade_w
	from	pessoa_fisica
	where	cd_pessoa_fisica = cd_pessoa_fisica_w;

	update	fa_receita_farmacia_item c
	set	ds_justificativa	= ds_justificativa_p
	where	c.nr_seq_receita	= nr_seq_receita_p
	and (coalesce(c.ds_justificativa::text, '') = '' or c.ds_justificativa = '')
	and exists (
		SELECT	1
		from	fa_regra_limite_terap a,
			fa_medic_farmacia_amb b
		where	a.nr_seq_medic	= b.nr_sequencia
		and	b.cd_material	= c.cd_material
		and	coalesce(a.cd_intervalo,c.cd_intervalo)	= c.cd_intervalo
		and	coalesce(a.nr_dias_utilizacao,c.nr_dias_receita) = c.nr_dias_receita
		and	coalesce(qt_idade_w,1) between coalesce(obter_idade_conversao(a.qt_idade_min,a.qt_idade_min_mes,a.qt_idade_min_dia,0,0,0,'MIN'),0) and
			coalesce(obter_idade_conversao(0,0,0,a.qt_idade_max,a.qt_idade_max_mes,a.qt_idade_max_dia,'MAX'),9999999)
		and	a.ie_justificativa = 'S');
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fa_inserir_just_limit_terap ( nr_seq_receita_p bigint, ds_justificativa_p text) FROM PUBLIC;

