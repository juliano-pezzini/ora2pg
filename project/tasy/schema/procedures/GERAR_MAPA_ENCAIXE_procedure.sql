-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_mapa_encaixe ( cd_pessoa_Fisica_p text, dt_inicial_p timestamp, dt_final_p timestamp, nr_seq_local_p bigint, nm_usuario_p text, qt_dt_trunc_p bigint, ds_mensagem_p INOUT text) AS $body$
DECLARE

 
nr_sequencia_w 	bigint;
nr_seq_atendimento_w	bigint;

BEGIN
 
select nextval('mapa_ocupacao_quimio_seq') 
into STRICT nr_sequencia_w
;
 
select 	max(a.nr_seq_atendimento) 
into STRICT	nr_seq_atendimento_w 
from  	paciente_atendimento a 
where 	trunc(a.dt_prevista) = trunc(dt_inicial_p) 
and 	not exists (SELECT 1 from mapa_ocupacao_quimio b where b.nr_seq_atendimento = a.nr_seq_atendimento) 
and  	obter_pessoa_atendimento(a.nr_atendimento,'C') = cd_pessoa_Fisica_p; --4580607 
ds_mensagem_p := '';
 
insert into mapa_ocupacao_quimio(nr_sequencia, 
	nr_seq_local, 
	dt_atualizacao, 
	dt_mapa, 
	nr_duracao, 
	cd_pessoa_fisica, 
	nm_usuario, 
	nr_seq_atendimento) 
values (nr_sequencia_w, 
	nr_seq_local_p, 
	clock_timestamp(), 
	truncar_hora_parametro(dt_inicial_p,qt_dt_trunc_p), 
	trunc((truncar_hora_parametro(dt_final_p,qt_dt_trunc_p) - truncar_hora_parametro(dt_inicial_p,qt_dt_trunc_p)) * 1440), 
	cd_pessoa_fisica_p, 
	nm_usuario_p, 
	nr_seq_atendimento_w);
 
commit;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_mapa_encaixe ( cd_pessoa_Fisica_p text, dt_inicial_p timestamp, dt_final_p timestamp, nr_seq_local_p bigint, nm_usuario_p text, qt_dt_trunc_p bigint, ds_mensagem_p INOUT text) FROM PUBLIC;

