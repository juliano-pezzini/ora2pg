-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alterar_plano_intercambio ( nr_seq_segurado_p bigint, nr_seq_plano_p bigint, nr_seq_motivo_alt_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, dt_inicio_vigencia_p timestamp) AS $body$
DECLARE


qt_plano_intercambio_w		bigint;
nr_seq_plano_ant_w		bigint;
nr_seq_intercambio_w		bigint;
ie_tipo_segurado_w		varchar(3);
qt_registros_plano_w		bigint;
ds_plano_ant_w			varchar(255);
dt_inicio_vigencia_w		timestamp;
nr_seq_alteracao_produto_w	pls_segurado_alt_plano.nr_sequencia%type;


BEGIN

dt_inicio_vigencia_w	:= coalesce(dt_inicio_vigencia_p,clock_timestamp());

if (coalesce(nr_seq_motivo_alt_p,0) = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort( 215584, null); /* Informe o motivo de alteracao do produto! */
end if;

if (coalesce(nr_seq_plano_p::text, '') = '') or (coalesce(nr_seq_plano_p,0) = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort( 215585, null); /* Produto nao informado. Verifique! */
end if;

select	max(nr_seq_plano)
into STRICT	nr_seq_plano_ant_w
from	pls_segurado
where	nr_sequencia	= nr_seq_segurado_p;

select	count(*)
into STRICT	qt_plano_intercambio_w
from	pls_plano
where	nr_sequencia		= nr_seq_plano_p
and	ie_tipo_operacao	= 'T';

if (qt_plano_intercambio_w > 0) then
	update	pls_segurado
	set	nr_seq_plano	= nr_seq_plano_p,
		nm_usuario	= nm_usuario_p
	where	nr_sequencia	= nr_seq_segurado_p;
	
	select	CASE WHEN coalesce(nr_seq_plano_ant_w::text, '') = '' THEN 'NENHUM'  ELSE nr_seq_plano_ant_w END
	into STRICT	ds_plano_ant_w
	;

	/* Gerar o historico da alteracao*/

	CALL pls_gerar_segurado_historico(	nr_seq_segurado_p, '4', clock_timestamp(),
					wheb_mensagem_pck.get_texto(1108462),
					wheb_mensagem_pck.get_texto(1108466, 'DS_PLANO_ANT='||ds_plano_ant_w||';'||'DS_PLANO='||nr_seq_plano_p||';'||'DT_INICIO_VIGENCIA='||to_char(dt_inicio_vigencia_w,'dd/mm/yyyy')),
					null, null, null,
					null, null, null,
					null, null, null,
					null, null, nm_usuario_p, 'N');
	
	if (nr_seq_plano_ant_w IS NOT NULL AND nr_seq_plano_ant_w::text <> '') then
		select	nextval('pls_segurado_alt_plano_seq')
		into STRICT	nr_seq_alteracao_produto_w
		;
	
		insert into pls_segurado_alt_plano(	nr_sequencia, nm_usuario, dt_atualizacao,
				nr_seq_segurado, nr_seq_plano_ant, nr_seq_plano_atual,
				dt_alteracao,nr_seq_motivo_alt, ds_observacao,
				ie_situacao)
		values (	nr_seq_alteracao_produto_w, nm_usuario_p, clock_timestamp(),
				nr_seq_segurado_p, nr_seq_plano_ant_w, nr_seq_plano_p,
				dt_inicio_vigencia_w,nr_seq_motivo_alt_p, wheb_mensagem_pck.get_texto(1108494),
				'A');
				
		CALL pls_inativar_alteracao_produto(nr_seq_segurado_p, nr_seq_alteracao_produto_w, dt_inicio_vigencia_w, 'N', nm_usuario_p);
	end if;
elsif (qt_plano_intercambio_w = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort( 215586, 'NM_PLANO='||substr(pls_obter_dados_produto(nr_seq_plano_p,'N'),1,255) );
	/* O plano '|| substr(pls_obter_dados_produto(nr_seq_plano_p,'N'),1,255)|| ' nao e do tipo de operacao de intercambio! */

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alterar_plano_intercambio ( nr_seq_segurado_p bigint, nr_seq_plano_p bigint, nr_seq_motivo_alt_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, dt_inicio_vigencia_p timestamp) FROM PUBLIC;

