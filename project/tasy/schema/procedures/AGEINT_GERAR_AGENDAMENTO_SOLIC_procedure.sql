-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ageint_gerar_agendamento_solic ( nr_seq_pendencia_p bigint, ds_itens_solic_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_ageint_w			bigint;
cd_pessoa_fisica_w		varchar(10);				
cd_profissional_w		varchar(10);
nr_seq_status_w			bigint;
nr_seq_ageint_item_w bigint;
nr_seq_proc_interno_w	bigint;
cd_especialidade_w bigint;
cd_medico_w varchar(15);
ie_tipo_agenda_w varchar(2);

C01 CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_proc_interno,
    cd_especialidade,
    cd_pessoa_fisica
	from	ageint_pend_exame_item
	where	nr_seq_pendencia	= nr_seq_pendencia_p
	and	obter_se_contido(nr_sequencia, ds_itens_solic_p) 	= 'S'
	order by 1;
				
BEGIN

select	max(cd_pessoa_fisica)
into STRICT	cd_pessoa_fisica_w
from	ageint_pendencia_exame
where	nr_sequencia	= nr_seq_pendencia_p;

if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
	
	select	nextval('agenda_integrada_seq')
	into STRICT	nr_seq_ageint_w
	;
	
	select	max(cd_pessoa_Fisica)
	into STRICT	cd_profissional_w
	from	usuario
	where	nm_usuario	= nm_usuario_p;
	
	select	min(nr_sequencia)
	into STRICT	nr_seq_status_w
	from	agenda_integrada_status
	where	ie_status_Tasy = 'EA';
	
	insert into agenda_integrada(nr_sequencia,
			cd_pessoa_fisica,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_inicio_agendamento,
			cd_profissional,
			nr_seq_status,
			cd_estabelecimento,
			nm_paciente,
			ie_turno)
	values (nr_seq_ageint_w,
			cd_pessoa_fisica_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			cd_profissional_w,
			nr_seq_status_w,
			cd_estabelecimento_p,
			substr(obter_nome_pf(cd_pessoa_fisica_w),1,60),
			'2');

      for c_01 in C01 loop

        select nextval('agenda_integrada_item_seq')
        into STRICT nr_seq_ageint_item_w
;

        nr_seq_proc_interno_w := c_01.nr_seq_proc_interno;
        ie_tipo_agenda_w := 'E';
        if ((c_01.cd_especialidade IS NOT NULL AND c_01.cd_especialidade::text <> '') or (c_01.cd_pessoa_fisica IS NOT NULL AND c_01.cd_pessoa_fisica::text <> '')) then
          nr_seq_proc_interno_w := null;
          cd_medico_w := c_01.cd_pessoa_fisica;
          cd_especialidade_w := c_01.cd_especialidade;
          ie_tipo_agenda_w := 'C';
        end if;

        insert into agenda_integrada_item(nr_sequencia,
            dt_atualizacao,
            nm_usuario,
            dt_atualizacao_nrec,
            nm_usuario_nrec,
            nr_seq_proc_interno,
            nr_seq_agenda_int,
            ie_tipo_agendamento,
            cd_especialidade,
            cd_medico)
        values (nr_seq_ageint_item_w,
            clock_timestamp(),
            nm_usuario_p,
            clock_timestamp(),
            nm_usuario_p,
            nr_seq_proc_interno_w,
            nr_seq_ageint_w,
            ie_tipo_agenda_w,
            cd_especialidade_w,
            cd_medico_w);

        if (ie_tipo_agenda_w = 'C') then
        
          insert into ageint_exame_adic_item(
            nr_sequencia,
            dt_atualizacao,
            nm_usuario,
            nr_seq_proc_interno,
            nr_seq_item
          ) values (
            nextval('ageint_exame_adic_item_seq'),
            clock_timestamp(),
            nm_usuario_p,
            c_01.nr_seq_proc_interno,
            nr_seq_ageint_item_w
          );
        end if;

      end loop;
	
	update	ageint_pendencia_exame
	set		dt_agendado	= clock_timestamp(),
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_seq_pendencia_p;
	
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageint_gerar_agendamento_solic ( nr_seq_pendencia_p bigint, ds_itens_solic_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

