-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_pls_atualizar_faturamento ( nr_seq_fatura_p pls_fatura.nr_sequencia%type, nr_seq_fatura_proc_p pls_fatura_proc.nr_sequencia%type, nr_seq_fatura_mat_p pls_fatura_mat.nr_sequencia%type, nr_seq_atualizacao_p pls_movimento_contabil.nr_seq_atualizacao%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE

						
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  ]  Objetos do dicionario [  ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
	NR_SEQ_GRUPO_ANS_WW
		Dominio 3579
		
	IE_OPCAO_CONTA_W
		Dominio 5870
		
	IE_TIPO_REGRA
		Dominio 3576
		
	IE_CODIFICACAO_W
		Dominio 3977
		
	IE_TIPO - CONTA_CONTABIL
		( A,T ) ( Analitica,Titulo )
-------------------------------------------------------------------------------------------------------------------

Referencias:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
cd_classificacao_credito_w	varchar(255);
cd_classificacao_debito_w	varchar(255);
cd_conta_credito_w		varchar(20);
cd_conta_debito_w		varchar(20);
ie_preco_w			varchar(2);
ie_tipo_segurado_w		varchar(2);
ie_regulamentacao_w		varchar(2);
ie_tipo_contratacao_w		varchar(2);
ie_segmentacao_w		varchar(2);
nr_seq_plano_w			bigint;
dt_referencia_w			timestamp;
cd_historico_baixa_w		bigint;
cd_historico_estorno_w		bigint;
ds_erro_w			varchar(4000);
nr_seq_contrato_w		bigint;
nr_seq_conta_w			bigint;
nr_seq_conta_fat_w		bigint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
nr_seq_grupo_ans_w		bigint;
nr_seq_grupo_ans_ww		bigint;
nr_seq_grupo_superior_w		bigint;
ie_classif_grupo_w		varchar(5);
ie_classif_grupo_ww		varchar(5);
nr_seq_tipo_atendimento_w	bigint;
cd_medico_executor_w		varchar(10);
ie_regime_internacao_w		varchar(1);
nr_seq_conselho_w		bigint;
ie_tipo_guia_w			varchar(2);
ie_ato_cooperado_w		varchar(5);
ie_tipo_contrato_w		varchar(2);
ie_codificacao_w		varchar(2);
vl_fixo_w			varchar(30);
cd_conta_contabil_w		varchar(20);
ie_debito_credito_w		varchar(1);
ie_tipo_outorgante_w		varchar(3);
ie_tipo_operacao_w		varchar(3);
ds_mascara_w			varchar(30);
ie_proc_mat_w			varchar(1);
ie_tipo_vinculo_operadora_w	varchar(2);
ie_tipo_cobranca_w		varchar(3);
nr_seq_intercambio_w		bigint;
nr_seq_classificacao_sca_w	bigint;
ie_opcao_conta_w		varchar(5);
ie_tipo_despesa_w		pls_conta_medica_resumo.ie_tipo_despesa%type;

cd_classif_credito_ndr_w	varchar(255);
cd_conta_credito_ndr_w		varchar(20);
cd_classif_debito_ndr_w		varchar(255);
cd_conta_debito_ndr_w		varchar(20);
cd_classificacao_item_w		varchar(30);
nr_seq_proc_w			bigint;
nr_seq_mat_w			bigint;
vl_diferenca_w			double precision;
ie_tipo_diferenca_w		pls_esquema_contabil.ie_tipo_diferenca%type;
nr_seq_pagador_w		pls_fatura.nr_seq_pagador%type;
cd_cgc_w			pls_contrato_pagador.cd_cgc%type;
cd_pessoa_fisica_w		pls_contrato_pagador.cd_pessoa_fisica%type;
nr_seq_pos_estab_w		pls_conta_pos_estab_contab.nr_sequencia%type;
vl_ajuste_w			pls_conta_pos_estab_contab.vl_administracao%type;
ie_prestador_codificacao_w	pls_esquema_contabil.ie_prestador_codificacao%type;
nr_seq_prestador_w		pls_prestador.nr_sequencia%type;
nr_seq_prestador_ww		pls_prestador.nr_sequencia%type;
nr_seq_prestador_atend_w	pls_protocolo_conta.nr_seq_prestador%type;
nr_seq_prestador_exec_w		pls_conta.nr_seq_prestador_exec%type;
nr_seq_prestador_solic_w	pls_conta.nr_seq_prestador%type;
nr_seq_tipo_prestador_w		pls_prestador.nr_seq_tipo_prestador%type;
nr_seq_tipo_prestador_ww	pls_prestador.nr_seq_tipo_prestador%type;
nr_seq_tipo_prestador_atend_w	pls_prestador.nr_seq_tipo_prestador%type;
nr_seq_tipo_prestador_exec_w	pls_prestador.nr_seq_tipo_prestador%type;
nr_seq_tipo_prestador_solic_w	pls_prestador.nr_seq_tipo_prestador%type;
ie_tipo_prestador_w		pls_tipo_prestador.ie_tipo_ptu%type;
ie_tipo_prestador_ww		pls_tipo_prestador.ie_tipo_ptu%type;
ie_tipo_prestador_atend_w	pls_tipo_prestador.ie_tipo_ptu%type;
ie_tipo_prestador_exec_w	pls_tipo_prestador.ie_tipo_ptu%type;
ie_tipo_prestador_solic_w	pls_tipo_prestador.ie_tipo_ptu%type;
ie_tipo_relacao_w		pls_prestador.ie_tipo_relacao%type;
ie_tipo_relacao_ww		pls_prestador.ie_tipo_relacao%type;
ie_tipo_relacao_atend_w		pls_prestador.ie_tipo_relacao%type;
ie_tipo_relacao_exec_w		pls_prestador.ie_tipo_relacao%type;
ie_tipo_relacao_solic_w		pls_prestador.ie_tipo_relacao%type;
nr_seq_esquema_w		pls_esquema_contabil.nr_sequencia%type;
nr_seq_esquema_ww		pls_esquema_contabil.nr_sequencia%type;
cd_historico_padrao_w		pls_esquema_contabil.cd_historico_padrao%type;
cd_historico_padrao_ww		pls_esquema_contabil.cd_historico_padrao%type;
dt_mesano_ref_w			pls_lote_faturamento.dt_mesano_referencia%type;
nr_seq_conta_resumo_w		pls_conta_medica_resumo.nr_sequencia%type;
ie_lote_ajuste_fat_w		pls_parametro_contabil.ie_lote_ajuste_fat%type;
ie_lote_reembolso_fat_w		pls_parametro_contabil.ie_lote_reembolso_fat%type;	
ie_lote_taxa_fat_w		pls_parametro_contabil.ie_lote_taxa_fat%type;
ie_lote_dif_fat_w		pls_parametro_contabil.ie_lote_dif_fat%type;
ie_status_w			pls_conta_proc.ie_status%type;
nr_id_w				oid;
nr_id_tx_contab_w		oid;
qt_registros_w			pls_ajuste_fatura_conta.nr_sequencia%type;
nr_seq_conta_proc_w		pls_conta_proc.nr_sequencia%type;
nr_seq_conta_mat_w		pls_conta_mat.nr_sequencia%type;
ie_tipo_protocolo_w		pls_protocolo_conta.ie_tipo_protocolo%type;
ie_tipo_repasse_w		pls_esquema_contabil.ie_tipo_repasse%type;
ie_tipo_compartilhamento_w	pls_esquema_contabil.ie_tipo_compartilhamento%type;
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
ie_benef_remido_w		pls_esquema_contabil.ie_benef_remido%type;
nr_seq_congenere_w		pls_protocolo_conta.nr_seq_congenere%type;
ie_lote_taxa_adm_w		pls_parametro_contabil.ie_lote_taxa_adm%type;
dt_ref_repasse_w		timestamp;
dt_repasse_w			timestamp;
dt_fim_repasse_w		timestamp;
ie_data_tipo_segurado_w		pls_parametros.ie_data_tipo_segurado%type;

c_itens_faturamento CURSOR FOR
	SELECT	'P', --ie_proc_mat
		e.nr_sequencia,
		i.ie_tipo_contratacao,
		i.ie_preco,
		i.ie_segmentacao,
		i.ie_regulamentacao,
		coalesce(a.ie_tipo_segurado,j.ie_tipo_segurado) ie_tipo_segurado,
		h.dt_mesano_referencia,
		CASE WHEN ie_data_tipo_segurado_w='P' THEN  k.dt_mes_competencia  ELSE (coalesce((	SELECT	p.dt_procedimento											from    pls_conta_proc p											where   p.nr_sequencia	= b.nr_seq_conta_proc), h.dt_mesano_referencia)) END  dt_ref_repasse,
		j.nr_seq_contrato,
		a.nr_sequencia nr_seq_conta,
		i.ie_tipo_operacao,
		i.nr_sequencia nr_seq_plano_seg,
		b.cd_procedimento,
		b.ie_origem_proced,
		null, --c.ie_ato_cooperado
		a.ie_tipo_guia,
		a.nr_seq_tipo_atendimento,
		a.cd_medico_executor,
		a.ie_regime_internacao,
		j.ie_tipo_vinculo_operadora,
		coalesce(e.ie_tipo_cobranca, f.ie_tipo_cobranca),
		j.nr_seq_intercambio,
		i.nr_seq_classificacao,
		coalesce((pls_obter_vl_pag_fat_pos(c.nr_sequencia,'T'))::numeric ,0) vl_diferenca,
		d.nr_seq_pagador,
		c.nr_sequencia,
		coalesce(c.vl_custo_operacional,0) - coalesce(c.vl_provisao,0) vl_ajuste,
		CASE WHEN ie_prestador_codificacao_w='E' THEN a.nr_seq_prestador_exec WHEN ie_prestador_codificacao_w='S' THEN a.nr_seq_prestador  ELSE k.nr_seq_prestador END  nr_seq_prestador,
		c.nr_seq_conta_resumo,
		c.oid nr_id,
		x.oid nr_id_tx_contab,
		(select	p.ie_status
		from	pls_conta_proc p
		where	b.nr_seq_conta_proc	= p.nr_sequencia) ie_status,
		b.nr_seq_conta_proc,
		null nr_seq_conta_mat,
		k.ie_tipo_protocolo,
		j.nr_sequencia nr_seq_segurado,
		pls_obter_se_benef_remido(j.nr_sequencia,h.dt_mesano_referencia) ie_benef_remido,
		k.nr_seq_congenere
	FROM pls_protocolo_conta k, pls_segurado j, pls_plano i, pls_lote_faturamento h, pls_fatura_evento g, pls_fatura_conta f, pls_fatura_proc e, pls_fatura d, pls_conta_pos_estab_contab c, pls_conta a, pls_conta_pos_estabelecido b
LEFT OUTER JOIN pls_conta_pos_estab_taxa t ON (b.nr_sequencia = t.nr_seq_conta_pos_estab)
LEFT OUTER JOIN pls_conta_pos_taxa_contab x ON (t.nr_sequencia = x.nr_seq_pos_estab_taxa)
WHERE a.nr_sequencia 		= b.nr_seq_conta and b.nr_sequencia 		= c.nr_seq_conta_pos and b.nr_sequencia 		= e.nr_seq_conta_pos_estab and d.nr_sequencia 		= g.nr_seq_fatura and f.nr_sequencia 		= e.nr_seq_fatura_conta and g.nr_sequencia 		= f.nr_seq_fatura_evento and h.nr_sequencia 		= d.nr_seq_lote and i.nr_sequencia 		= a.nr_seq_plano and j.nr_sequencia		= a.nr_seq_segurado and k.nr_sequencia		= a.nr_seq_protocolo   and d.nr_sequencia	= nr_seq_fatura_p and ((e.nr_sequencia = nr_seq_fatura_proc_p)
	or (coalesce(nr_seq_fatura_proc_p::text, '') = '')) and coalesce(d.nr_seq_cancel_fat::text, '') = '' and coalesce(b.ie_status_faturamento, 'A') <> 'A'
	
union all

	select	'M', --ie_proc_mat
		e.nr_sequencia,
		i.ie_tipo_contratacao,
		i.ie_preco,
		i.ie_segmentacao,
		i.ie_regulamentacao,
		coalesce(a.ie_tipo_segurado,j.ie_tipo_segurado) ie_tipo_segurado,
		h.dt_mesano_referencia,
		CASE WHEN ie_data_tipo_segurado_w='P' THEN  k.dt_mes_competencia  ELSE (coalesce((	select  m.dt_atendimento											from    pls_conta_mat m											where   m.nr_sequencia	= b.nr_seq_conta_mat), h.dt_mesano_referencia)) END  dt_ref_repasse,	
		j.nr_seq_contrato,
		a.nr_sequencia nr_seq_conta,
		i.ie_tipo_operacao,
		i.nr_sequencia nr_seq_plano_seg,
		0,
		0,
		null, --c.ie_ato_cooperado,
		a.ie_tipo_guia,
		a.nr_seq_tipo_atendimento,
		a.cd_medico_executor,
		a.ie_regime_internacao,
		j.ie_tipo_vinculo_operadora,
		coalesce(e.ie_tipo_cobranca, f.ie_tipo_cobranca),
		j.nr_seq_intercambio,
		i.nr_seq_classificacao,
		coalesce((pls_obter_vl_pag_fat_pos(c.nr_sequencia,'T'))::numeric ,0) vl_diferenca,
		d.nr_seq_pagador,
		c.nr_sequencia,
		coalesce(c.vl_custo_operacional,0) - coalesce(c.vl_provisao,0) vl_ajuste,
		CASE WHEN ie_prestador_codificacao_w='E' THEN a.nr_seq_prestador_exec WHEN ie_prestador_codificacao_w='S' THEN a.nr_seq_prestador  ELSE k.nr_seq_prestador END  nr_seq_prestador,
		c.nr_seq_conta_resumo,
		c.oid nr_id,
		x.oid nr_id_tx_contab,
		(select	m.ie_status
		from	pls_conta_mat m
		where	b.nr_seq_conta_mat	= m.nr_sequencia) ie_status,
		null nr_seq_conta_proc,
		b.nr_seq_conta_mat,
		k.ie_tipo_protocolo,
		j.nr_sequencia nr_seq_segurado,
		pls_obter_se_benef_remido(j.nr_sequencia,h.dt_mesano_referencia) ie_benef_remido,
		k.nr_seq_congenere
	FROM pls_protocolo_conta k, pls_segurado j, pls_plano i, pls_lote_faturamento h, pls_fatura_evento g, pls_fatura_conta f, pls_fatura_mat e, pls_fatura d, pls_conta_pos_estab_contab c, pls_conta a, pls_conta_pos_estabelecido b
LEFT OUTER JOIN pls_conta_pos_estab_taxa t ON (b.nr_sequencia = t.nr_seq_conta_pos_estab)
LEFT OUTER JOIN pls_conta_pos_taxa_contab x ON (t.nr_sequencia = x.nr_seq_pos_estab_taxa)
WHERE a.nr_sequencia 		= b.nr_seq_conta and b.nr_sequencia 		= c.nr_seq_conta_pos and b.nr_sequencia 		= e.nr_seq_conta_pos_estab and d.nr_sequencia 		= g.nr_seq_fatura and f.nr_sequencia 		= e.nr_seq_fatura_conta and g.nr_sequencia 		= f.nr_seq_fatura_evento and h.nr_sequencia 		= d.nr_seq_lote and i.nr_sequencia 		= a.nr_seq_plano and j.nr_sequencia		= a.nr_seq_segurado and k.nr_sequencia		= a.nr_seq_protocolo   and d.nr_sequencia	= nr_seq_fatura_p and ((e.nr_sequencia = nr_seq_fatura_mat_p)
	or (coalesce(nr_seq_fatura_mat_p::text, '') = '')) and coalesce(d.nr_seq_cancel_fat::text, '') = '' and coalesce(b.ie_status_faturamento, 'A') <> 'A';

c_tipo_fat CURSOR FOR	
	SELECT	'VTX'
	
	where	ie_lote_taxa_fat_w in ('R','A')
	and	coalesce(ie_tipo_cobranca_w,'X') not in ('3','4')
	
union

	SELECT	'VLA'
	
	where	ie_lote_ajuste_fat_w = 'R'
	and	coalesce(ie_tipo_cobranca_w,'X') not in ('3','4')
	
union

	select	'NDR'
	
	where	ie_lote_reembolso_fat_w in ('R','A')
	and	coalesce(ie_tipo_cobranca_w,'X') not in ('3','4')
	
union

	select	'DIF'
	
	where (ie_lote_dif_fat_w = 'R'
	or (coalesce(ie_lote_dif_fat_w,'X') = 'X'
	and	ie_lote_ajuste_fat_w	= 'R'))
	and	coalesce(ie_tipo_cobranca_w,'X') not in ('3','4')
	
union

	select	'VTA'
	
	where	coalesce(ie_tipo_cobranca_w,'X') in ('3','4')
	and	ie_lote_taxa_adm_w	= 'R';

c_esquema CURSOR FOR
	SELECT	a.nr_sequencia,
		a.cd_historico_padrao,
		a.cd_historico_baixa,
		a.cd_historico_estorno,
		a.ie_prestador_codificacao,
		a.nr_seq_prestador,
		a.ie_tipo_relacao,
		a.ie_tipo_ptu,
		a.nr_seq_tipo_prestador
	from	pls_esquema_contabil	a
	where	a.ie_tipo_regra		= 'FA'
	and	a.cd_estabelecimento	= cd_estabelecimento_p
	and	dt_referencia_w between a.dt_inicio_vigencia and coalesce(a.dt_fim_vigencia,dt_referencia_w)
	and	((exists (SELECT	1
				from	pls_grupo_seg_item	l,
					pls_grupo_segmentacao	k
				where	l.nr_seq_grupo		= k.nr_sequencia
				and	k.nr_sequencia		= a.nr_seq_grupo_segmentacao
				and	l.ie_segmentacao	= ie_segmentacao_w)) or (coalesce(a.nr_seq_grupo_segmentacao::text, '') = ''))
	and	((exists (select	1
			from	pls_contab_tipo_cobranca y,
				pls_contab_grupo_cobranca x
			where	y.nr_seq_grupo	= x.nr_sequencia
			and	x.nr_sequencia	= a.nr_seq_grupo_cobranca
			and	y.ie_tipo_cobranca = ie_tipo_cobranca_w)) or (coalesce(a.nr_seq_grupo_cobranca::text, '') = ''))
	and	((a.nr_seq_plano = nr_seq_plano_w) or (coalesce(a.nr_seq_plano::text, '') = ''))
	and	((a.ie_tipo_outorgante = ie_tipo_outorgante_w) or (coalesce(a.ie_tipo_outorgante::text, '') = ''))
	and	((a.ie_tipo_segurado = ie_tipo_segurado_w) or (coalesce(a.ie_tipo_segurado::text, '') = ''))
	and	((a.ie_tipo_repasse = ie_tipo_repasse_w) or (coalesce(a.ie_tipo_repasse::text, '') = ''))
	and	((a.ie_tipo_compartilhamento = ie_tipo_compartilhamento_w) or (coalesce(a.ie_tipo_compartilhamento::text, '') = ''))
	and	((a.ie_tipo_plano = ie_tipo_operacao_w) or (coalesce(a.ie_tipo_plano::text, '') = ''))
	and	((a.ie_tipo_vinculo_operadora = ie_tipo_vinculo_operadora_w) or (coalesce(a.ie_tipo_vinculo_operadora::text, '') = ''))
	and	((a.nr_seq_contrato = nr_seq_contrato_w) or (coalesce(a.nr_seq_contrato::text, '') = ''))
	and	((a.nr_seq_intercambio = nr_seq_intercambio_w) or (coalesce(a.nr_seq_intercambio::text, '') = ''))
	and	((a.ie_tipo_contratacao = ie_tipo_contratacao_w) or (coalesce(a.ie_tipo_contratacao::text, '') = ''))
	and	((a.nr_seq_classif_sca = nr_seq_classificacao_sca_w) or (coalesce(a.nr_seq_classif_sca::text, '') = ''))
	and	((a.ie_tipo_valor_rec_fatur = ie_opcao_conta_w) or (coalesce(ie_tipo_valor_rec_fatur::text, '') = '') or ((ie_opcao_conta_w = 'VTA') and (coalesce(ie_tipo_cobranca_w,'X') in ('3','4'))))
	and	((a.ie_tipo_relacao = ie_tipo_relacao_w) or (coalesce(ie_tipo_relacao::text, '') = ''))
	and	((a.ie_tipo_diferenca = ie_tipo_diferenca_w) or (coalesce(ie_tipo_diferenca::text, '') = ''))
	and	((a.ie_tipo_protocolo = ie_tipo_protocolo_w) or (coalesce(a.ie_tipo_protocolo::text, '') = ''))
	and	((coalesce(a.ie_origem_pos_estab,'A') = 'A')
	or	((coalesce(a.ie_origem_pos_estab,'A') = 'N') and (coalesce(ie_status_w,'X') not in ('M','R')))
	or	((coalesce(a.ie_origem_pos_estab,'A') = 'R') and (coalesce(ie_status_w,'X') = 'R'))
	or	((coalesce(a.ie_origem_pos_estab,'A') = 'M') and (coalesce(ie_status_w,'X') = 'M')))
	and	((a.ie_benef_remido = ie_benef_remido_w) or (coalesce(a.ie_benef_remido::text, '') = ''))
	order by
		coalesce(a.nr_seq_grupo_cobranca,0),
		coalesce(a.ie_tipo_compartilhamento,0),
		coalesce(a.ie_tipo_repasse,' '),
		coalesce(a.ie_tipo_segurado, ' '),
		coalesce(a.nr_seq_contrato, 0),
		coalesce(a.nr_seq_intercambio, 0),
		coalesce(a.ie_tipo_plano, ' '),
		coalesce(a.nr_seq_plano, 0),
		coalesce(a.nr_seq_classif_sca, 0),
		coalesce(a.ie_tipo_vinculo_operadora, 0),
		coalesce(a.ie_tipo_contratacao, ' '),
		coalesce(a.ie_tipo_outorgante, ' '),
		coalesce(a.ie_prestador_codificacao, ' '),
		coalesce(a.ie_origem_pos_estab,' '),
		coalesce(a.ie_tipo_diferenca,' '),
		coalesce(a.ie_tipo_relacao,' '),
		coalesce(a.ie_benef_remido,' '),
		coalesce(a.nr_seq_grupo_segmentacao, 0),
		coalesce(a.ie_tipo_valor_rec_fatur,' '),
		coalesce(a.ie_tipo_protocolo,' '),
		coalesce(a.dt_inicio_vigencia, clock_timestamp());
		
c_segmentacao CURSOR FOR
	SELECT	ie_codificacao,
		vl_fixo,
		cd_conta_contabil,
		ie_debito_credito,
		ds_mascara
	from	pls_esquema_contabil_seg
	where	nr_seq_regra_esquema	= nr_seq_esquema_w
	order by
		ie_debito_credito,
		nr_seq_apresentacao;


BEGIN

select	max(ie_tipo_outorgante)
into STRICT	ie_tipo_outorgante_w
from	pls_outorgante
where	cd_estabelecimento	= cd_estabelecimento_p;

CALL wheb_usuario_pck.set_ie_atualizacao_contabil('S');

select	max(a.dt_mesano_referencia)
into STRICT	dt_mesano_ref_w
from	pls_lote_faturamento a,
	pls_fatura b
where	a.nr_sequencia = b.nr_seq_lote
and	b.nr_sequencia = nr_seq_fatura_p;
	
select	max(a.ie_prestador_codificacao)
into STRICT	ie_prestador_codificacao_w
from	pls_esquema_contabil	a
where	a.ie_tipo_regra		= 'FA'
and	a.cd_estabelecimento	= cd_estabelecimento_p
and	dt_mesano_ref_w between a.dt_inicio_vigencia and coalesce(a.dt_fim_vigencia,dt_mesano_ref_w);

select	max(coalesce(ie_lote_ajuste_fat,'R')),
	max(coalesce(ie_lote_reembolso_fat,'R')),
	max(coalesce(ie_lote_taxa_fat,'R')),
	max(ie_lote_dif_fat),
	max(coalesce(ie_lote_taxa_adm,'R'))
into STRICT	ie_lote_ajuste_fat_w,
	ie_lote_reembolso_fat_w,
	ie_lote_taxa_fat_w,
	ie_lote_dif_fat_w,
	ie_lote_taxa_adm_w
from	pls_parametro_contabil
where	cd_estabelecimento	= cd_estabelecimento_p;

select	coalesce(max(a.ie_data_tipo_segurado),'A')
into STRICT	ie_data_tipo_segurado_w
from	pls_parametros a
where	a.cd_estabelecimento = cd_estabelecimento_p;

open c_itens_faturamento;
loop
fetch c_itens_faturamento into
	ie_proc_mat_w,
	nr_seq_conta_fat_w,
	ie_tipo_contratacao_w,
	ie_preco_w,
	ie_segmentacao_w,
	ie_regulamentacao_w,
	ie_tipo_segurado_w,
	dt_referencia_w,
	dt_ref_repasse_w,
	nr_seq_contrato_w,
	nr_seq_conta_w,
	ie_tipo_operacao_w,
	nr_seq_plano_w,
	cd_procedimento_w,
	ie_origem_proced_w,
	ie_ato_cooperado_w,
	ie_tipo_guia_w,
	nr_seq_tipo_atendimento_w,
	cd_medico_executor_w,
	ie_regime_internacao_w,
	ie_tipo_vinculo_operadora_w,
	ie_tipo_cobranca_w,
	nr_seq_intercambio_w,
	nr_seq_classificacao_sca_w,
	vl_diferenca_w,
	nr_seq_pagador_w,
	nr_seq_pos_estab_w,
	vl_ajuste_w,
	nr_seq_prestador_w,
	nr_seq_conta_resumo_w,
	nr_id_w,
	nr_id_tx_contab_w,
	ie_status_w,	
	nr_seq_conta_proc_w,
	nr_seq_conta_mat_w,
	ie_tipo_protocolo_w,
	nr_seq_segurado_w,
	ie_benef_remido_w,
	nr_seq_congenere_w;
EXIT WHEN NOT FOUND; /* apply on c_itens_faturamento */
	begin
	
	SELECT * FROM pls_obter_dados_repasse(	dt_ref_repasse_w, nr_seq_segurado_w, nr_seq_congenere_w, ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w) INTO STRICT ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w;
	
	if (ie_prestador_codificacao_w = 'P') then
		select	max(nr_seq_prestador_pgto)
		into STRICT	nr_seq_prestador_w
		from	pls_conta_medica_resumo
		where	nr_sequencia = nr_seq_conta_resumo_w
		and	nr_seq_conta = nr_seq_conta_w;
	end if;
	
	if (nr_seq_prestador_w IS NOT NULL AND nr_seq_prestador_w::text <> '') then
		select	ie_tipo_relacao,
			nr_seq_tipo_prestador
		into STRICT	ie_tipo_relacao_w,
			nr_seq_tipo_prestador_w
		from	pls_prestador
		where	nr_sequencia	= nr_seq_prestador_w  LIMIT 1;
		
		if (nr_seq_tipo_prestador_w IS NOT NULL AND nr_seq_tipo_prestador_w::text <> '') then
			select	ie_tipo_ptu
			into STRICT	ie_tipo_prestador_w
			from	pls_tipo_prestador
			where	nr_sequencia	= nr_seq_tipo_prestador_w  LIMIT 1;
		end if;
	end if;
	
	if (coalesce(nr_seq_conta_resumo_w,0) <> 0) then
		select	max(a.ie_ato_cooperado),
			max(a.ie_tipo_despesa),
			max(a.nr_seq_grupo_ans)
		into STRICT	ie_ato_cooperado_w,
			ie_tipo_despesa_w,
			nr_seq_grupo_ans_w
		from	pls_conta_medica_resumo a
		where	a.nr_sequencia		= nr_seq_conta_resumo_w
		and	a.nr_seq_conta		= nr_seq_conta_w;
		
		if (coalesce(nr_seq_grupo_ans_w,0) = 0) then
			
			if (ie_proc_mat_w = 'P') then
			
				select	max(p.nr_seq_grupo_ans)
				into STRICT	nr_seq_grupo_ans_w
				from	pls_conta_proc p,
					pls_conta_pos_estab_contab x
				where	p.nr_seq_conta = nr_seq_conta_w
				and	x.nr_sequencia = nr_seq_pos_estab_w
				and	x.nr_seq_conta = nr_seq_conta_w
				and	p.nr_sequencia = x.nr_seq_conta_proc;

			elsif (ie_proc_mat_w = 'M') then

				select	max(m.nr_seq_grupo_ans)
				into STRICT	nr_seq_grupo_ans_w
				from	pls_conta_mat m,
					pls_conta_pos_estab_contab x
				where	m.nr_seq_conta = nr_seq_conta_w
				and	x.nr_sequencia = nr_seq_pos_estab_w
				and	x.nr_seq_conta = nr_seq_conta_w
				and	m.nr_sequencia = x.nr_seq_conta_mat;
			end if;
		end if;
	else
		select	coalesce(max(p.ie_ato_cooperado),'0'),
			max(p.ie_tipo_despesa),
			max(p.nr_seq_grupo_ans)
		into STRICT	ie_ato_cooperado_w,
			ie_tipo_despesa_w,
			nr_seq_grupo_ans_w
		from	pls_conta_pos_estabelecido e,
			pls_conta_pos_estab_contab c,
			pls_conta_proc p
		where	e.nr_seq_conta_proc = p.nr_sequencia
		and	c.nr_seq_conta_pos = e.nr_sequencia
		and	c.nr_sequencia = nr_seq_pos_estab_w;
	
		if (coalesce(ie_ato_cooperado_w,'0') = '0') then
			select	coalesce(max(m.ie_ato_cooperado),0),
				max(m.ie_tipo_despesa),
				max(m.nr_seq_grupo_ans)
			into STRICT	ie_ato_cooperado_w,
				ie_tipo_despesa_w,
				nr_seq_grupo_ans_w
			from	pls_conta_pos_estabelecido e,
				pls_conta_pos_estab_contab c,
				pls_conta_mat m
			where	e.nr_seq_conta_mat = m.nr_sequencia
			and	c.nr_seq_conta_pos = e.nr_sequencia
			and	c.nr_sequencia = nr_seq_pos_estab_w;
		end if;
	end if;

	select	max(a.cd_cgc),
		max(a.cd_pessoa_fisica)
	into STRICT	cd_cgc_w,
		cd_pessoa_fisica_w
	from	pls_contrato_pagador	a
	where	a.nr_sequencia	= nr_seq_pagador_w;
	
	if (vl_diferenca_w > 0) then
		ie_tipo_diferenca_w	:= '1';
	else
		ie_tipo_diferenca_w	:= '2';
	end if;
	
	if (nr_seq_intercambio_w IS NOT NULL AND nr_seq_intercambio_w::text <> '') then
		begin
		select	CASE WHEN coalesce(cd_cgc::text, '') = '' THEN 'PF'  ELSE 'PJ' END
		into STRICT	ie_tipo_contrato_w
		from	pls_intercambio
		where	nr_sequencia	= nr_seq_intercambio_w;
		exception
		when others then
			ie_tipo_contrato_w	:= null;
		end;
	else
		begin
		select	CASE WHEN coalesce(cd_cgc_estipulante::text, '') = '' THEN 'PF'  ELSE 'PJ' END
		into STRICT	ie_tipo_contrato_w
		from	pls_contrato
		where	nr_sequencia	= nr_seq_contrato_w;
		exception
		when others then
			ie_tipo_contrato_w	:= null;
		end;
	end if;

	if (coalesce(ie_status_w,'X') = 'M') then
		qt_registros_w := 0;
		
		select	sum(x.qt_registros)
		into STRICT	qt_registros_w
		from (SELECT count(*) qt_registros
			from	pls_ajuste_fatura_conta	a,
				pls_conta		b,
				pls_conta_mat		c
			where	a.nr_sequencia	= b.nr_seq_ajuste_fat
			and	b.nr_sequencia 	= c.nr_seq_conta
			and	c.nr_sequencia	= nr_seq_conta_mat_w
			and	c.ie_status = 'M'
			
union all

			SELECT	count(*) qt_registros
			from	pls_ajuste_fatura_conta	a,
				pls_conta		b,
				pls_conta_proc		c
			where	a.nr_sequencia	= b.nr_seq_ajuste_fat
			and	b.nr_sequencia 	= c.nr_seq_conta
			and	c.nr_sequencia	= nr_seq_conta_proc_w
			and	c.ie_status = 'M') x;
	
		if (qt_registros_w > 0) then
			ie_status_w := 'R';
		end if;
		
	end if;
	
	open c_tipo_fat;
	loop
	fetch c_tipo_fat into
		ie_opcao_conta_w;
	EXIT WHEN NOT FOUND; /* apply on c_tipo_fat */
		begin
		nr_seq_esquema_w	:= null;
		cd_historico_padrao_w	:= null;
		cd_historico_baixa_w	:= null;
		cd_historico_estorno_w	:= null;

		open c_esquema;
		loop
		fetch c_esquema into
			nr_seq_esquema_ww,
			cd_historico_padrao_ww,
			cd_historico_baixa_w,
			cd_historico_estorno_w,
			ie_prestador_codificacao_w,
			nr_seq_prestador_ww,
			ie_tipo_relacao_ww,
			ie_tipo_prestador_ww,
			nr_seq_tipo_prestador_ww;
		EXIT WHEN NOT FOUND; /* apply on c_esquema */
			begin
			if (coalesce(ie_tipo_relacao_ww,coalesce(ie_tipo_relacao_w,'X')) = coalesce(ie_tipo_relacao_w,'X')) then
				
				nr_seq_esquema_w	:= nr_seq_esquema_ww;
				cd_historico_padrao_w	:= cd_historico_padrao_ww;
			end if;
			end;
		end loop;
		close c_esquema;

		cd_conta_credito_w		:= null;
		cd_conta_debito_w		:= null;
		cd_classificacao_credito_w	:= null;
		cd_classificacao_debito_w	:= null;

		/* 5 - Grupo ANS */

		select	max(nr_seq_conselho)
		into STRICT	nr_seq_conselho_w
		from	pessoa_fisica
		where	cd_pessoa_fisica	= cd_medico_executor_w;

		/*
		nr_seq_grupo_ans_w	:= pls_obter_grupo_ans(	cd_procedimento_w,
								ie_origem_proced_w,
								nr_seq_conselho_w,
								nr_seq_tipo_atendimento_w,
								ie_tipo_guia_w,
								ie_regime_internacao_w,
								null,
								'G',
								nvl(cd_estabelecimento_p,0),
								nr_seq_conta_w);
		*/
		
		if (coalesce(nr_seq_grupo_ans_w,0) > 0) then
			select	max(nr_seq_grupo_superior)
			into STRICT	nr_seq_grupo_superior_w
			from	ans_grupo_despesa
			where	nr_sequencia	= nr_seq_grupo_ans_w;

			select	max(ie_tipo_grupo_ans)
			into STRICT	nr_seq_grupo_superior_w
			from	ans_grupo_despesa
			where	nr_sequencia	= nr_seq_grupo_superior_w;
		end if;

		if (coalesce(nr_seq_grupo_superior_w,0) = 0) then
			select	max(ie_tipo_grupo_ans)
			into STRICT	nr_seq_grupo_ans_ww
			from	ans_grupo_despesa
			where	nr_sequencia	= nr_seq_grupo_ans_w;
		else
			nr_seq_grupo_ans_ww	:= nr_seq_grupo_superior_w;
		end if;

		if (nr_seq_grupo_ans_ww = 10) then /* 1 - Consultas */
			ie_classif_grupo_w	:= '1';
			ie_classif_grupo_ww	:= '0';
		elsif (nr_seq_grupo_ans_ww = 20) then /* 49 - Exames */
			ie_classif_grupo_w	:= '2';
			ie_classif_grupo_ww	:= '0';
		elsif (nr_seq_grupo_ans_ww = 30) then /* 51 - Terapias */
			ie_classif_grupo_w	:= '3';
			ie_classif_grupo_ww	:= '0';
		elsif (nr_seq_grupo_ans_ww = 41) then /* 7 - Internacao - Honorario medico */
			ie_classif_grupo_w	:= '4';
			ie_classif_grupo_ww	:= '1';
		elsif (nr_seq_grupo_ans_ww = 42) then /* 8 - Internacao - Exames */
			ie_classif_grupo_w	:= '4';
			ie_classif_grupo_ww	:= '2';
		elsif (nr_seq_grupo_ans_ww = 43) then /* 9 - Internacao - Terapias*/
			ie_classif_grupo_w	:= '4';
			ie_classif_grupo_ww	:= '3';
		elsif (nr_seq_grupo_ans_ww = 44) then /* 10 - Internacao - Materiais medicos */
			ie_classif_grupo_w	:= '4';
			ie_classif_grupo_ww	:= '4';
		elsif (nr_seq_grupo_ans_ww = 45) then /* 11 - Internacao - Medicamentos */
			ie_classif_grupo_w	:= '4';
			ie_classif_grupo_ww	:= '5';
		elsif (nr_seq_grupo_ans_ww = 49) then /* 12 - Internacao - Outras despesas */
			ie_classif_grupo_w	:= '4';
			ie_classif_grupo_ww	:= '9';
		elsif (nr_seq_grupo_ans_ww = 50) then /* 6 - Outros atendimentos - Ambulatoriais */
			ie_classif_grupo_w	:= '5';
			ie_classif_grupo_ww	:= '0';
		elsif (nr_seq_grupo_ans_ww = 60) then /* 16 - Demais despesas assistenciais */
			ie_classif_grupo_w	:= '6';
			ie_classif_grupo_ww	:= '0';
		end if;

		open c_segmentacao;
		loop
		fetch c_segmentacao into
			ie_codificacao_w,
			vl_fixo_w,
			cd_conta_contabil_w,
			ie_debito_credito_w,
			ds_mascara_w;
		EXIT WHEN NOT FOUND; /* apply on c_segmentacao */
			begin
			cd_classificacao_item_w	:= null;
			
			if (ie_debito_credito_w = 'C') then /* Classificacao CReDITO */
				if (ie_codificacao_w = 'CR') then /* Codigo reduzido */
					select	cd_classificacao_atual
					into STRICT	cd_classificacao_credito_w
					from	conta_contabil
					where	cd_conta_contabil	= cd_conta_contabil_w;

					cd_conta_credito_w	:= cd_conta_contabil_w;
				elsif (ie_codificacao_w = 'FX') then /* Fixo */
					cd_classificacao_item_w	:= vl_fixo_w;
				elsif (ie_codificacao_w = 'GA') then /* Grupo ANS */
					if (ie_classif_grupo_w IS NOT NULL AND ie_classif_grupo_w::text <> '') then
						cd_classificacao_item_w	:= ie_classif_grupo_w;
					else
						cd_classificacao_item_w	:= 'GA';
					end if;
				elsif (ie_codificacao_w = 'FP') then /* Formacao de Preco */
					if (ie_tipo_segurado_w = 'A') then
						cd_classificacao_item_w	:= '9';
					else
						cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_formacao_preco(ie_preco_w);
					end if;
				elsif (ie_codificacao_w = 'R') then /* Regulamentacao */
					cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_regulamentacao(ie_regulamentacao_w);
				elsif (ie_codificacao_w = 'TC') then /* Tipo de contratacao */
					if (ie_tipo_contratacao_w in ('I','CE','CA')) then
						cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_tipo_contratacao(ie_tipo_contratacao_w);
					else
						cd_classificacao_item_w	:= 'TC';
					end if;
				elsif (ie_codificacao_w = 'TP') then /* Tipo de Contrato (Pessoa fisica ou Juridica) */
					if (ie_tipo_contrato_w in ('PF','PJ')) then
						cd_classificacao_item_w	:=  pls_atualizar_codificacao_pck.get_tipo_pessoa_contrato(ie_tipo_contrato_w);
					else
						cd_classificacao_item_w	:= 'TP';
					end if;
				elsif (ie_codificacao_w = 'S') then /* Segmentacao */
					cd_classificacao_item_w	:= lpad(ie_segmentacao_w,2,'0');
				elsif (ie_codificacao_w = 'TR') then /* Tipo de relacao com a OPS */
					cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_tipo_relacao(ie_tipo_relacao_w);
				elsif (ie_codificacao_w = 'TA') then /* Tipo de ato cooperado */
					if (ie_ato_cooperado_w in ('1','2','3')) then
						cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_ato_cooperado(ie_ato_cooperado_w);
					else
						cd_classificacao_item_w	:= 'A';
					end if;
				elsif (ie_codificacao_w = 'CG') then /* Complemento grupo ANS */
					if (ie_classif_grupo_ww IS NOT NULL AND ie_classif_grupo_ww::text <> '') then
						cd_classificacao_item_w	:= ie_classif_grupo_ww;
					else
						cd_classificacao_item_w	:= 'CG';
					end if;
				elsif (ie_codificacao_w = 'TD') then /* Tipo de Despesa */
						if (ie_proc_mat_w = 'P') then
							if (ie_tipo_despesa_w IS NOT NULL AND ie_tipo_despesa_w::text <> '') then
								cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_tipo_despesa(ie_tipo_despesa_w);
							else
								cd_classificacao_item_w := 'TD';
							end if;
						else
							cd_classificacao_item_w := 1;
						end if;
				elsif (ie_codificacao_w = 'RC') then /* Tipo de contratacao / Regulamentacao */
					cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_contratacao_regulamentacao(ie_tipo_contratacao_w,ie_regulamentacao_w);
				elsif (ie_codificacao_w = 'CF') then /* Conta de recebimento do pagador da fatura */
					if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
						select	max(cd_conta_contabil)
						into STRICT	cd_conta_contabil_w
						from	pessoa_fisica_conta_ctb	a
						where	a.cd_pessoa_fisica 	= cd_pessoa_fisica_w
						and	coalesce(a.cd_estabelecimento,cd_estabelecimento_p)	= cd_estabelecimento_p
						and	a.ie_tipo_conta		= 'R'
						and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
					elsif (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') then
						select	max(cd_conta_contabil)
						into STRICT	cd_conta_contabil_w
						from	pessoa_jur_conta_cont a
						where	a.cd_cgc	= cd_cgc_w
						and	a.ie_tipo_conta	= 'R'
						and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
					end if;
					
					select	max(cd_classificacao_atual)
					into STRICT	cd_classificacao_credito_w
					from	conta_contabil
					where	cd_conta_contabil = cd_conta_contabil_w;
					
					cd_conta_credito_w	:= cd_conta_contabil_w;
				end if;
				
				if (cd_classificacao_item_w IS NOT NULL AND cd_classificacao_item_w::text <> '') then
					if (ds_mascara_w = '00') then
						cd_classificacao_item_w	:= lpad(cd_classificacao_item_w,2,'0') || '.';
					elsif (ds_mascara_w = '0.0') then
						cd_classificacao_item_w	:= substr(lpad(cd_classificacao_item_w,2,'0'),1,1) ||'.'||substr(lpad(cd_classificacao_item_w,2,'0'),2,1) || '.';
					elsif (ds_mascara_w = '0_') then
						cd_classificacao_item_w	:= cd_classificacao_item_w;
					else
						cd_classificacao_item_w	:= cd_classificacao_item_w || '.';
					end if;
					
					cd_classificacao_credito_w	:= cd_classificacao_credito_w || cd_classificacao_item_w;
				end if;
			elsif (ie_debito_credito_w = 'D') then /* Classificacao DeBITO */
				if (ie_codificacao_w = 'CR') then /* Codigo reduzido */
					select	cd_classificacao_atual
					into STRICT	cd_classificacao_debito_w
					from	conta_contabil
					where	cd_conta_contabil	= cd_conta_contabil_w;

					cd_conta_debito_w	:= cd_conta_contabil_w;
				elsif (ie_codificacao_w = 'FX') then /* Fixo */
					cd_classificacao_item_w	:= vl_fixo_w;
				elsif (ie_codificacao_w = 'GA') then /* Grupo ANS */
					if (ie_classif_grupo_w IS NOT NULL AND ie_classif_grupo_w::text <> '') then
						cd_classificacao_item_w	:= ie_classif_grupo_w;
					else
						cd_classificacao_item_w	:= 'GA';
					end if;
				elsif (ie_codificacao_w = 'FP') then /* Formacao de Preco */
					if (ie_tipo_segurado_w = 'A') then
						cd_classificacao_item_w	:= '9';
					else
						cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_formacao_preco(ie_preco_w);
					end if;
				elsif (ie_codificacao_w = 'R') then /* Regulamentacao */
					cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_regulamentacao(ie_regulamentacao_w);
				elsif (ie_codificacao_w = 'TC') then /* Tipo de contratacao */
					if (ie_tipo_contratacao_w in ('I','CE','CA')) then
						cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_tipo_contratacao(ie_tipo_contratacao_w);
					else
						cd_classificacao_item_w	:= 'TC';
					end if;
				elsif (ie_codificacao_w = 'S') then /* Segmentacao */
					cd_classificacao_item_w	:= lpad(ie_segmentacao_w,2,'0');
				elsif (ie_codificacao_w = 'TP') then /* Tipo de Contrato (Pessoa fisica ou Juridica) */
					if (ie_tipo_contrato_w in ('PF','PJ')) then
						cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_tipo_pessoa_contrato(ie_tipo_contrato_w);
					else
						cd_classificacao_item_w	:= 'TP';
					end if;
				elsif (ie_codificacao_w = 'TR') then /* Tipo de relacao com a OPS */
					cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_tipo_relacao(ie_tipo_relacao_w);
				elsif (ie_codificacao_w = 'TA') then /* Tipo de ato cooperado */
					if (ie_ato_cooperado_w in ('1','2','3')) then
						cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_ato_cooperado(ie_ato_cooperado_w);
					else
						cd_classificacao_item_w	:= 'A';
					end if;
				elsif (ie_codificacao_w = 'CG') then /* Complemento grupo ANS */
					if (ie_classif_grupo_ww IS NOT NULL AND ie_classif_grupo_ww::text <> '') then
						cd_classificacao_item_w	:= ie_classif_grupo_ww;
					else
						cd_classificacao_item_w	:= 'CG';
					end if;
				elsif (ie_codificacao_w = 'TD') then /* Tipo de Despesa */
						if (ie_tipo_despesa_w IS NOT NULL AND ie_tipo_despesa_w::text <> '') then
							cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_tipo_despesa(ie_tipo_despesa_w);
						else
							cd_classificacao_item_w := 'TD';
						end if;
				elsif (ie_codificacao_w = 'RC') then /* Tipo de contratacao / Regulamentacao */
					cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_contratacao_regulamentacao(ie_tipo_contratacao_w,ie_regulamentacao_w);
				elsif (ie_codificacao_w = 'CF') then /* Conta de recebimento do pagador da fatura */
					if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
						select	max(cd_conta_contabil)
						into STRICT	cd_conta_contabil_w
						from	pessoa_fisica_conta_ctb	a
						where	a.cd_pessoa_fisica 	= cd_pessoa_fisica_w
						and	coalesce(a.cd_estabelecimento,cd_estabelecimento_p)	= cd_estabelecimento_p
						and	a.ie_tipo_conta		= 'R'
						and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
					elsif (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') then
						select	max(cd_conta_contabil)
						into STRICT	cd_conta_contabil_w
						from	pessoa_jur_conta_cont a
						where	a.cd_cgc	= cd_cgc_w
						and	a.ie_tipo_conta	= 'R'
						and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
					end if;
					
					select	max(cd_classificacao_atual)
					into STRICT	cd_classificacao_debito_w
					from	conta_contabil
					where	cd_conta_contabil = cd_conta_contabil_w;
					
					cd_conta_debito_w	:= cd_conta_contabil_w;
				end if;
				
				if (cd_classificacao_item_w IS NOT NULL AND cd_classificacao_item_w::text <> '') then
					if (ds_mascara_w = '00') then
						cd_classificacao_item_w	:= lpad(cd_classificacao_item_w,2,'0') || '.';
					elsif (ds_mascara_w = '0.0') then
						cd_classificacao_item_w	:= substr(lpad(cd_classificacao_item_w,2,'0'),1,1) ||'.'||substr(lpad(cd_classificacao_item_w,2,'0'),2,1) || '.';
					elsif (ds_mascara_w = '0_') then
						cd_classificacao_item_w	:= cd_classificacao_item_w;
					else
						cd_classificacao_item_w	:= cd_classificacao_item_w || '.';
					end if;
					
					cd_classificacao_debito_w	:= cd_classificacao_debito_w || cd_classificacao_item_w;
				end if;
			end if;
			end;
		end loop;
		close c_segmentacao;

		/* Remover o ultimo ponto da classificacao */

		if (substr(cd_classificacao_credito_w,length(cd_classificacao_credito_w),length(cd_classificacao_credito_w)) = '.') then
			cd_classificacao_credito_w	:= substr(cd_classificacao_credito_w,1,length(cd_classificacao_credito_w)-1);
		end if;

		if (substr(cd_classificacao_debito_w,length(cd_classificacao_debito_w),length(cd_classificacao_debito_w)) = '.') then
			cd_classificacao_debito_w	:= substr(cd_classificacao_debito_w,1,length(cd_classificacao_debito_w)-1);
		end if;

		if (coalesce(cd_conta_credito_w::text, '') = '') then
			cd_conta_credito_w	:= ctb_obter_conta_classif(cd_classificacao_credito_w,dt_referencia_w,cd_estabelecimento_p);
		end if;

		if (coalesce(cd_conta_debito_w::text, '') = '') then
			cd_conta_debito_w	:= ctb_obter_conta_classif(cd_classificacao_debito_w,dt_referencia_w,cd_estabelecimento_p);
		end if;
		
		nr_seq_proc_w	:= null;
		nr_seq_mat_w	:= null;

		if (ie_proc_mat_w = 'P') then
			nr_seq_proc_w	:= nr_seq_conta_fat_w;
			
		elsif (ie_proc_mat_w = 'M') then
			nr_seq_mat_w	:= nr_seq_conta_fat_w;
		end if;
		
		if (ie_opcao_conta_w = 'NDR') then
			update	pls_conta_pos_estab_contab
			set	nr_seq_esquema_ndc		= nr_seq_esquema_w,
				cd_classif_cred_ndc 		= cd_classificacao_credito_w,
				cd_classif_deb_ndc  		= cd_classificacao_debito_w,
				cd_conta_cred_ndc 		= cd_conta_credito_w,
				cd_conta_deb_ndc		= cd_conta_debito_w,
				cd_historico_ndc		= cd_historico_padrao_w
			where	rowid				= nr_id_w;
		elsif (ie_opcao_conta_w = 'DIF') then
			update	pls_conta_pos_estab_contab
			set	cd_historico_dif		= cd_historico_padrao_w,
				nr_seq_esquema_dif		= nr_seq_esquema_w,
				cd_classif_cred_dif 		= cd_classificacao_credito_w,
				cd_classif_deb_dif  		= cd_classificacao_debito_w,
				cd_conta_cred_dif 		= cd_conta_credito_w,
				cd_conta_deb_dif		= cd_conta_debito_w
			where	rowid				= nr_id_w;
		elsif (ie_opcao_conta_w = 'VLA') and (vl_ajuste_w <> 0) then
			update	pls_conta_pos_estab_contab
			set	cd_historico_ajuste		= cd_historico_padrao_w
			where	rowid				= nr_id_w;
			
		elsif (ie_opcao_conta_w = 'VTX') then
			update	pls_conta_pos_estab_contab
			set	cd_historico_taxa		= cd_historico_padrao_w,
				nr_seq_esquema_taxa		= nr_seq_esquema_w,
				cd_classif_cred_taxa		= cd_classificacao_credito_w,
				cd_classif_deb_taxa		= cd_classificacao_debito_w,
				cd_conta_cred_taxa		= cd_conta_credito_w,
				cd_conta_deb_taxa		= cd_conta_debito_w
			where	rowid				= nr_id_w;			
		elsif (ie_opcao_conta_w = 'VTA') then
			update	pls_conta_pos_taxa_contab
			set	cd_conta_cred			= cd_conta_credito_w,
				cd_conta_deb			= cd_conta_debito_w,
				cd_historico			= cd_historico_padrao_w,
				cd_classif_cred			= cd_classificacao_credito_w,
				cd_classif_deb			= cd_classificacao_debito_w,
				nr_seq_esquema			= nr_seq_esquema_w
			where	rowid				= nr_id_tx_contab_w;
		end if;
		
		if (nr_seq_atualizacao_p IS NOT NULL AND nr_seq_atualizacao_p::text <> '') then
			if (coalesce(nr_seq_esquema_w::text, '') = '') then
				CALL pls_gravar_mov_contabil(nr_seq_atualizacao_p,
							1,
							null,
							null,
							null,
							null,
							null,
							null,
							nr_seq_proc_w,
							nr_seq_mat_w,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							nm_usuario_p,
							nr_seq_esquema_w,
							null,
							nr_seq_pos_estab_w);
			elsif	((coalesce(cd_conta_credito_w::text, '') = '') or (coalesce(cd_conta_debito_w::text, '') = '')) then
				CALL pls_gravar_mov_contabil(nr_seq_atualizacao_p,
							2,
							null,
							null,
							null,
							null,
							null,
							null,
							nr_seq_proc_w,
							nr_seq_mat_w,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							nm_usuario_p,
							nr_seq_esquema_w,
							null,
							nr_seq_pos_estab_w);
			end if;
		end if;
		end;
	end loop;
	close c_tipo_fat;
	end;
end loop;
close c_itens_faturamento;

CALL wheb_usuario_pck.set_ie_atualizacao_contabil('S');

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_pls_atualizar_faturamento ( nr_seq_fatura_p pls_fatura.nr_sequencia%type, nr_seq_fatura_proc_p pls_fatura_proc.nr_sequencia%type, nr_seq_fatura_mat_p pls_fatura_mat.nr_sequencia%type, nr_seq_atualizacao_p pls_movimento_contabil.nr_seq_atualizacao%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

