-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tie_hl7_his_insere_laudo_pdf ( NR_SEQ_LAUDO_P laudo_paciente_pdf_serial.nr_seq_laudo%TYPE, NR_ACESSO_DICOM_P laudo_paciente_pdf_serial.nr_acesso_dicom%TYPE, DS_LAUDO_PDF_P laudo_paciente_pdf_serial.ds_pdf_serial%TYPE, NM_USUARIO_P laudo_paciente_pdf_serial.nm_usuario%TYPE, DS_ERRO_P INOUT text, NR_SEQ_LAUDO_PDF_P INOUT bigint) AS $body$
DECLARE


nr_seq_laudo_pdf_w		laudo_paciente_pdf_serial.nr_sequencia%TYPE;
nr_prescricao_w         prescr_procedimento.nr_prescricao%TYPE;
nr_seq_prescr_w         prescr_procedimento.nr_sequencia%TYPE;


BEGIN

IF (nr_seq_laudo_p IS NOT NULL AND nr_seq_laudo_p::text <> '')	THEN

	SELECT 	nextval('laudo_paciente_pdf_serial_seq')
	INTO STRICT	nr_seq_laudo_pdf_w
	;

	BEGIN
        INSERT INTO laudo_paciente_pdf_serial(nr_sequencia,
                                        dt_atualizacao,
                                        nm_usuario,
                                        dt_atualizacao_nrec,
                                        nm_usuario_nrec,
                                        nr_acesso_dicom,
                                        nr_seq_laudo,
                                        ds_pdf_serial)
                                VALUES (nr_seq_laudo_pdf_w,
                                        clock_timestamp(),
                                        nm_usuario_p,
                                        clock_timestamp(),
                                        nm_usuario_p,
                                        nr_acesso_dicom_p,
                                        nr_seq_laudo_p,
                                        ds_laudo_pdf_p);

    
        --Atualizando o formato do resultado do laudo para buscar o laudo  em pdf serializado.									
        UPDATE	laudo_paciente
        SET		ie_formato = 4
        WHERE	nr_sequencia = nr_seq_laudo_p;

        SELECT nr_prescricao, nr_sequencia
        INTO STRICT nr_prescricao_w, nr_seq_prescr_w
        FROM prescr_procedimento
        WHERE nr_acesso_dicom = nr_acesso_dicom_p;

        CALL gravar_auditoria_mmed(nr_prescricao_w,nr_seq_prescr_w,'VUEPACS',30,ds_laudo_pdf_p);
	EXCEPTION
		WHEN no_data_found THEN
			ds_erro_p := substr(sqlerrm,1,4000);
        WHEN too_many_rows THEN RAISE;
	END;

END IF;

COMMIT;								

nr_seq_laudo_pdf_p := nr_seq_laudo_pdf_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tie_hl7_his_insere_laudo_pdf ( NR_SEQ_LAUDO_P laudo_paciente_pdf_serial.nr_seq_laudo%TYPE, NR_ACESSO_DICOM_P laudo_paciente_pdf_serial.nr_acesso_dicom%TYPE, DS_LAUDO_PDF_P laudo_paciente_pdf_serial.ds_pdf_serial%TYPE, NM_USUARIO_P laudo_paciente_pdf_serial.nm_usuario%TYPE, DS_ERRO_P INOUT text, NR_SEQ_LAUDO_PDF_P INOUT bigint) FROM PUBLIC;

