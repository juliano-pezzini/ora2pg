-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ajustar_valores_item_sol ( nr_etapas_p bigint, nr_prescricao_p bigint, nr_sequencia_solucao_p bigint, cd_intervalo_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_material_w		bigint;
cd_material_w			bigint;
ie_via_aplicacao_w		varchar(50);
qt_unitaria_w			double precision;
qt_dose_especial_w		double precision;
ds_dose_diferenciada_w		varchar(255);
cd_unidade_medida_w		varchar(55);
qt_material_w			double precision;
qt_dispensar_w			double precision;
ie_regra_disp_w			varchar(5);
ds_erro_w			varchar(2000);
cd_intervalo_w			varchar(200);
ie_se_necessario_w		varchar(1);
ie_acm_w			varchar(1);

c01 CURSOR FOR
SELECT	cd_material,
	nr_sequencia,
	ie_via_aplicacao,
	qt_unitaria,
	qt_dose_especial,
	ds_dose_diferenciada,
	cd_unidade_medida,
	coalesce(ie_se_necessario,'N'),
	coalesce(ie_acm,'N')
from	prescr_material
where	ie_agrupador		= 4
and	nr_prescricao		= nr_prescricao_p
and	nr_sequencia_solucao	= nr_sequencia_solucao_p;


BEGIN

select	max(cd_intervalo)
into STRICT	cd_intervalo_w
from	prescr_solucao
where	nr_prescricao	= nr_prescricao_p
and	nr_seq_solucao	= nr_sequencia_solucao_p;

if (cd_intervalo_w <> cd_intervalo_p) and (cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') then

	open C01;
	loop
	fetch C01 into
		cd_material_w,
		nr_seq_material_w,
		ie_via_aplicacao_w,
		qt_unitaria_w,
		qt_dose_especial_w,
		ds_dose_diferenciada_w,
		cd_unidade_medida_w,
		ie_se_necessario_w,
		ie_acm_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */

		SELECT * FROM Obter_Quant_Dispensar(1, cd_material_w, nr_prescricao_p, nr_seq_material_w, cd_intervalo_p, ie_via_aplicacao_w, qt_unitaria_w, coalesce(qt_dose_especial_w,0), nr_etapas_p, ds_dose_diferenciada_w, 'P', cd_unidade_medida_w, 1, qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w;

		update	prescr_material
		set	cd_intervalo		= cd_intervalo_p,
			qt_material		= qt_material_w,
			qt_total_dispensar	= qt_dispensar_w,
			ie_regra_disp		= ie_regra_disp_w
		where	nr_prescricao		= nr_prescricao_p
		and	nr_sequencia		= nr_seq_material_w;

		commit;

	end loop;
	close C01;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ajustar_valores_item_sol ( nr_etapas_p bigint, nr_prescricao_p bigint, nr_sequencia_solucao_p bigint, cd_intervalo_p text, nm_usuario_p text) FROM PUBLIC;

