-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_lib_titulo_pagar ( nr_titulo_p bigint, nm_usuario_p text, ie_opcao_p text) AS $body$
DECLARE


/*	ie_opcao_p

L	liberar

*/
cd_estabelecimento_w	smallint;
nr_seq_regra_w		bigint;
nm_usuario_lib_w	varchar(255);
vl_titulo_w		double precision;
ie_nivel_w		bigint;
nr_seq_nota_fiscal_w	bigint;
cd_cgc_w		varchar(14);
dt_emissao_w		timestamp;
cd_perfil_w		integer;
ie_liberar_w		varchar(1);
ie_tipo_titulo_w	varchar(2);
nr_seq_classe_w		bigint;
ie_origem_titulo_w	varchar(10);
nr_seq_proj_rec_w   bigint;
ds_resultado_w		varchar(1);

   
c02 CURSOR FOR
SELECT	a.nm_usuario_lib,
	a.ie_nivel
from	regra_lib_tit_usuario a
where	(a.ie_nivel IS NOT NULL AND a.ie_nivel::text <> '')
and	not exists (SELECT	1
	from	conta_pagar_lib x
	where	coalesce(x.ie_nivel,0)	= coalesce(a.ie_nivel,0)
	and	x.nm_usuario_lib	= a.nm_usuario_lib
	and	x.nr_titulo		= nr_titulo_p)
and	a.nr_seq_regra		= nr_seq_regra_w
and	(a.nm_usuario_lib IS NOT NULL AND a.nm_usuario_lib::text <> '');

c03 CURSOR FOR
SELECT	a.cd_perfil,
	a.ie_nivel
from	regra_lib_tit_perfil a
where	(a.ie_nivel IS NOT NULL AND a.ie_nivel::text <> '')
and	not exists (SELECT	1
	from	conta_pagar_lib x
	where	coalesce(x.ie_nivel,0)	= coalesce(a.ie_nivel,0)
	and	x.cd_perfil		= a.cd_perfil
	and	x.nr_titulo		= nr_titulo_p)
and	(a.cd_perfil IS NOT NULL AND a.cd_perfil::text <> '')
and	a.nr_seq_regra		= nr_seq_regra_w;


BEGIN

if (coalesce(ie_opcao_p,'L') = 'L' ) then
	ie_liberar_w := 'S';
else
	ie_liberar_w := 'N';
end if;

select	max(a.vl_titulo),
	max(a.nr_seq_nota_fiscal),
	max(a.cd_estabelecimento),
	max(a.cd_cgc),
	coalesce(max(a.dt_emissao),clock_timestamp()),
	max(a.ie_tipo_titulo),
	max(a.nr_seq_classe),
	max(a.ie_origem_titulo),
    max(a.nr_seq_proj_rec)
into STRICT	vl_titulo_w,
	nr_seq_nota_fiscal_w,
	cd_estabelecimento_w,
	cd_cgc_w,
	dt_emissao_w,
	ie_tipo_titulo_w,
	nr_seq_classe_w,
	ie_origem_titulo_w,
    nr_seq_proj_rec_w
FROM titulo_pagar a
LEFT OUTER JOIN pessoa_juridica b ON (a.cd_cgc = b.cd_cgc)
WHERE a.nr_titulo		= nr_titulo_p;

SELECT * FROM obter_regra_lib_tit_pagar(	nr_seq_nota_fiscal_w, vl_titulo_w, cd_cgc_w, cd_estabelecimento_w, nm_usuario_p, nr_seq_regra_w, ie_liberar_w, ds_resultado_w, dt_emissao_w, nr_seq_proj_rec_w, ie_tipo_titulo_w, nr_seq_classe_w, ie_origem_titulo_w) INTO STRICT nr_seq_regra_w, ie_liberar_w, ds_resultado_w;

if (ie_liberar_w = 'S') then
    update	titulo_pagar
    set		dt_liberacao = clock_timestamp(),
            nm_usuario_lib	= nm_usuario_p
    where	nr_titulo = nr_titulo_p;
end if;


if (ie_opcao_p	= 'L') then


		open c02;
		loop
		fetch c02 into
			nm_usuario_lib_w,
			ie_nivel_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */

			insert into conta_pagar_lib(
				dt_atualizacao,
				dt_atualizacao_nrec,
				dt_liberacao,
				ie_nivel,
				nm_usuario,
				nm_usuario_lib,
				nm_usuario_nrec,
				nr_seq_regra_tit_pagar,
				nr_titulo,
				nr_sequencia)
			values (clock_timestamp(),
				clock_timestamp(),
				null,
				ie_nivel_w,
				nm_usuario_p,
				nm_usuario_lib_w,
				nm_usuario_p,
				nr_seq_regra_w,
				nr_titulo_p,
				nextval('conta_pagar_lib_seq'));

		end loop;
		close c02;

		open	c03;
		loop
		fetch	c03 into
			cd_perfil_w,
			ie_nivel_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */

			insert into conta_pagar_lib(
				cd_perfil,
				dt_atualizacao,
				dt_atualizacao_nrec,
				dt_liberacao,
				ie_nivel,
				nm_usuario,
				nm_usuario_nrec,
				nr_seq_regra_tit_pagar,
				nr_titulo,
				nr_sequencia)
			values (cd_perfil_w,
				clock_timestamp(),
				clock_timestamp(),
				null,
				ie_nivel_w,
				nm_usuario_p,
				nm_usuario_p,
				nr_seq_regra_w,
				nr_titulo_p,
				nextval('conta_pagar_lib_seq'));

		end	loop;
		close	c03;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_lib_titulo_pagar ( nr_titulo_p bigint, nm_usuario_p text, ie_opcao_p text) FROM PUBLIC;

