-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE adep_consistir_alter_horario ( nr_seq_horario_p bigint, ie_tipo_horario_p text) AS $body$
DECLARE


nr_prescricao_w		prescr_medica.nr_prescricao%type;
nr_sequencia_w		bigint;
dt_horario_w		timestamp;
ie_ok_w				char(1) := 'S';
ie_gas_separada_w	varchar(2);
nr_seq_gas_cpoe_w	cpoe_gasoterapia.nr_sequencia%type;


BEGIN
if (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') and (ie_tipo_horario_p IS NOT NULL AND ie_tipo_horario_p::text <> '') then

	if (ie_tipo_horario_p = 'D') then

		select	max(nr_prescricao),
				max(dt_horario),
				max(nr_seq_dieta)
		into STRICT	nr_prescricao_w,
				dt_horario_w,
				nr_sequencia_w
		from	prescr_dieta_hor
		where	nr_sequencia = nr_seq_horario_p
		and		(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '');

		select	coalesce(max('N'),'S')
		into STRICT	ie_ok_w
		from	prescr_dieta_hor where		nr_prescricao 	= nr_prescricao_w
		and		nr_seq_dieta	= nr_sequencia_w
		and		coalesce(coalesce(dt_fim_horario, dt_suspensao)::text, '') = ''
		and		coalesce(ie_situacao,'A') = 'A'
		and		dt_horario < dt_horario_w
		and		(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '') LIMIT 1;


	elsif (ie_tipo_horario_p in ('M','S', 'LD', 'IAH')) then

		select	max(nr_prescricao),
				max(nr_seq_material),
				max(dt_horario)
		into STRICT	nr_prescricao_w,
				nr_sequencia_w,
				dt_horario_w
		from	prescr_mat_hor
		where	nr_sequencia = nr_seq_horario_p
		and		(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '');

		select	coalesce(max('N'),'S')
		into STRICT	ie_ok_w
		from	prescr_mat_hor where		nr_prescricao 		= nr_prescricao_w
		and		nr_seq_material		= nr_sequencia_w
		and		coalesce(dt_fim_horario, coalesce(dt_suspensao, dt_recusa)) is null
		and		coalesce(ie_adep,'S')	= 'S'
		and		coalesce(ie_horario_especial,'N') = 'N'
		and		dt_horario < dt_horario_w
		and		(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '') LIMIT 1;


	elsif (ie_tipo_horario_p in ('P','G','C')) then

		select	max(nr_prescricao),
				max(nr_seq_procedimento),
				max(dt_horario)
		into STRICT	nr_prescricao_w,
				nr_sequencia_w,
				dt_horario_w
		from	prescr_proc_hor
		where	nr_sequencia = nr_seq_horario_p
		and		(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '');

		select	coalesce(max('N'),'S')
		into STRICT	ie_ok_w
		from	prescr_proc_hor where		nr_prescricao 		= nr_prescricao_w
		and		nr_seq_procedimento	= nr_sequencia_w
		and		coalesce(coalesce(dt_fim_horario, dt_suspensao)::text, '') = ''
		and		coalesce(ie_situacao,'A')		= 'A'
		and		coalesce(ie_horario_especial,'N') <> 'S'
		and		dt_horario < dt_horario_w
		and		(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '') LIMIT 1;


	elsif (ie_tipo_horario_p = 'R') then

		select	max(nr_prescricao),
				max(nr_seq_recomendacao),
				max(dt_horario)
		into STRICT	nr_prescricao_w,
				nr_sequencia_w,
				dt_horario_w
		from	prescr_rec_hor
		where	nr_sequencia = nr_seq_horario_p
		and		(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '');

		select	coalesce(max('N'),'S')
		into STRICT	ie_ok_w
		from	prescr_rec_hor where		nr_prescricao 		= nr_prescricao_w
		and		coalesce(ie_horario_especial,'N') <> 'S'
		and		nr_seq_recomendacao	= nr_sequencia_w
		and		coalesce(coalesce(dt_fim_horario, dt_suspensao)::text, '') = ''
		and		dt_horario < dt_horario_w
		and		(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '') LIMIT 1;

	elsif (ie_tipo_horario_p = 'E') then

		select	max(nr_seq_pe_prescr),
				max(nr_seq_pe_proc),
				max(dt_horario)
		into STRICT	nr_prescricao_w,
				nr_sequencia_w,
				dt_horario_w
		from	pe_prescr_proc_hor
		where	nr_sequencia = nr_seq_horario_p;

		select	coalesce(max('N'),'S')
		into STRICT	ie_ok_w
		from	pe_prescr_proc_hor where		nr_seq_pe_prescr	= nr_prescricao_w
		and		nr_seq_pe_proc		= nr_sequencia_w
		and		coalesce(coalesce(dt_fim_horario, dt_suspensao)::text, '') = ''
		and		dt_horario < dt_horario_w LIMIT 1;

	elsif (ie_tipo_horario_p = 'O') then

		ie_gas_separada_w := wheb_assist_pck.obterParametroFuncao(1113,704);

		select	max(a.nr_prescricao),
				max(a.nr_seq_gasoterapia),
				max(a.dt_horario),
				max(b.nr_seq_gas_cpoe)
		into STRICT	nr_prescricao_w,
				nr_sequencia_w,
				dt_horario_w,
				nr_seq_gas_cpoe_w
		from	prescr_gasoterapia_hor		a,
				prescr_gasoterapia			b
		where	b.nr_sequencia		= a.nr_seq_gasoterapia
		and		a.nr_sequencia 		= nr_seq_horario_p
		and		(a.dt_lib_horario IS NOT NULL AND a.dt_lib_horario::text <> '');

		if (ie_gas_separada_w = 'S' or coalesce(nr_seq_gas_cpoe_w::text, '') = '') then
			select	coalesce(max('N'),'S')
			into STRICT	ie_ok_w
			from	prescr_gasoterapia_hor where		nr_prescricao	= nr_prescricao_w
			and		coalesce(ie_horario_especial,'N') <> 'S'
			and		nr_seq_gasoterapia = nr_sequencia_w
			and		coalesce(coalesce(dt_fim_horario, dt_suspensao)::text, '') = ''
			and		dt_horario < dt_horario_w
			and		(dt_lib_horario IS NOT NULL AND dt_lib_horario::text <> '') LIMIT 1;
		else
			select	coalesce(max('N'),'S')
			into STRICT	ie_ok_w
			from	prescr_gasoterapia_hor	a,
					prescr_gasoterapia		b
			where	b.nr_sequencia		= a.nr_seq_gasoterapia
			and		b.nr_seq_gas_cpoe 	= nr_seq_gas_cpoe_w
			and		a.dt_horario < dt_horario_w
			and		(a.dt_lib_horario IS NOT NULL AND a.dt_lib_horario::text <> '')
			and		coalesce(coalesce(a.dt_fim_horario, a.dt_suspensao)::text, '') = ''
			and		coalesce(a.ie_horario_especial,'N') <> 'S'  LIMIT 1;
		end if;
	end if;

	if (ie_ok_w = 'N') then
		-- Existem hor√°rios pendentes anteriores ao atual, favor verificar os mesmos primeiramente!
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(224908);
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE adep_consistir_alter_horario ( nr_seq_horario_p bigint, ie_tipo_horario_p text) FROM PUBLIC;

