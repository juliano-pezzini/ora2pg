-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_tipo_ato_coop_a520 ( nr_seq_ptu_aviso_conta_p ptu_aviso_conta.nr_sequencia%type, ie_proc_mat_p text, cd_procedimento_p ptu_aviso_procedimento.cd_procedimento%type, cd_mat_envio_p ptu_aviso_material.cd_mat_envio%type, cd_tabela_p ptu_aviso_material.cd_tabela%type, nr_seq_regra_p INOUT pls_ato_cooperado.nr_sequencia%type, ie_ato_cooperado_p INOUT pls_ato_cooperado.ie_ato_cooperado%type) AS $body$
DECLARE

						
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
cd_cpf_executante_w		ptu_aviso_conta.cd_cpf_executante%type;
cd_cnpj_executante_w		ptu_aviso_conta.cd_cnpj_executante%type;
nr_seq_prestador_exec_w		pls_prestador_intercambio.nr_sequencia%type;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
cd_cpf_solicitante_w		ptu_aviso_conta.cd_cpf_solicitante%type;
cd_cnpj_solicitante_w		ptu_aviso_conta.cd_cnpj_solicitante%type;
dt_atendimento_ref_w		ptu_aviso_conta.dt_atendimento_ref%type;
ie_tipo_guia_w			ptu_aviso_protocolo.ie_tipo_guia%type;
nr_seq_prestador_solic_w	pls_prestador_intercambio.nr_sequencia%type;
cd_medico_solicitante_w		varchar(20);
ie_medico_solic_coope_w		varchar(10) := 'N';
cd_medico_conta_w		varchar(20);
ie_medico_exec_coope_w		varchar(10) := 'N';
ie_cooperado_exec_w		pls_ato_cooperado.ie_prestador_exec%type;
ie_cooperado_solic_w		pls_ato_cooperado.ie_prestador_solic%type;
nr_seq_grupo_rec_w		bigint;
ie_tipo_segurado_w		pls_segurado.ie_tipo_segurado%type;
ie_tipo_contrato_w		pls_intercambio.ie_tipo_contrato%type;
cd_area_procedimento_w		bigint;
cd_especialidade_w		bigint;
cd_grupo_proc_w			bigint;
ie_origem_proced_w		bigint;
nr_seq_material_w		pls_material.nr_sequencia%type;
ie_tipo_desp_proc_w		varchar(10);
ie_tipo_desp_mat_w		pls_material.ie_tipo_despesa%type;
ie_estrut_mat_w			varchar(1);
nr_seq_regra_w			bigint;
ie_ato_cooperado_w		bigint;

C01 CURSOR(	cd_procedimento_pc		pls_ato_cooperado.cd_procedimento%type,
		ie_origem_proced_pc		pls_ato_cooperado.ie_origem_proced%type,
		cd_grupo_proc_pc		pls_ato_cooperado.cd_grupo_proc%type,
		cd_especialidade_pc		pls_ato_cooperado.cd_especialidade%type,
		cd_area_procedimento_pc		pls_ato_cooperado.cd_area_procedimento%type,
		ie_cooperado_solic_pc		pls_ato_cooperado.ie_prestador_solic%type,
		ie_cooperado_exec_pc		pls_ato_cooperado.ie_prestador_exec%type,
		nr_seq_grupo_rec_pc		pls_ato_cooperado.nr_seq_grupo_rec%type,
		nr_seq_material_pc		pls_ato_cooperado.nr_seq_material%type,
		ie_tipo_guia_pc			pls_ato_cooperado.ie_tipo_guia%type,
		ie_tipo_desp_proc_pc		pls_ato_cooperado.ie_tipo_desp_proc%type,
		ie_tipo_desp_mat_pc		pls_ato_cooperado.ie_tipo_desp_mat%type,
		ie_medico_solic_coope_pc	pls_ato_cooperado.ie_medico_solic%type,
		ie_medico_exec_coope_pc		pls_ato_cooperado.ie_medico_executor%type,
		ie_tipo_segurado_pc		pls_ato_cooperado.ie_tipo_segurado%type,
		ie_tipo_contrato_pc		pls_ato_cooperado.ie_tipo_contrato%type) FOR
	SELECT	nr_sequencia nr_seq_regra,
		ie_ato_cooperado,
		nr_seq_estrutura_mat,
		coalesce(ie_rede_nao_contratualizada,'N') ie_rede_nao_contratualizada
	from	pls_ato_cooperado
	where	((coalesce(cd_procedimento::text, '') = '') or (cd_procedimento		= cd_procedimento_pc AND ie_origem_proced = ie_origem_proced_pc))
	and	((coalesce(cd_grupo_proc::text, '') = '') or (cd_grupo_proc		= cd_grupo_proc_pc))
	and	((coalesce(cd_especialidade::text, '') = '') or (cd_especialidade		= cd_especialidade_pc))
	and	((coalesce(cd_area_procedimento::text, '') = '') or (cd_area_procedimento	= cd_area_procedimento_pc))
	and	((coalesce(ie_prestador_solic::text, '') = '') or (ie_prestador_solic		= ie_cooperado_solic_pc))
	and	((coalesce(ie_prestador_exec::text, '') = '') or (ie_prestador_exec		= ie_cooperado_exec_pc))
	and	((coalesce(nr_seq_grupo_rec::text, '') = '') or (nr_seq_grupo_rec		= nr_seq_grupo_rec_pc))
	and	((coalesce(nr_seq_material::text, '') = '') or (nr_seq_material		= nr_seq_material_pc))
	and	ie_tipo_protocolo 		= 'A'
	and	((coalesce(ie_tipo_guia::text, '') = '') or (ie_tipo_guia		= ie_tipo_guia_pc))
	and	(((coalesce(ie_tipo_desp_proc::text, '') = '') or (ie_tipo_desp_proc		= ie_tipo_desp_proc_pc))
	or	((coalesce(ie_tipo_desp_mat::text, '') = '') or (ie_tipo_desp_mat		= ie_tipo_desp_mat_pc)))
	and	ie_situacao			= 'A'
	and (coalesce(ie_medico_solic,'A')	= coalesce(ie_medico_solic_coope_pc,'A') 	or coalesce(ie_medico_solic,'A')	= 'A')
	and (coalesce(ie_medico_executor,'A')	= coalesce(ie_medico_exec_coope_pc,'A')	or coalesce(ie_medico_executor,'A')	= 'A')
	and	((coalesce(ie_tipo_segurado::text, '') = '') or (ie_tipo_segurado		= ie_tipo_segurado_pc))
	and	((coalesce(ie_tipo_contrato::text, '') = '') or (ie_tipo_contrato		= ie_tipo_contrato_pc))
	and	coalesce(ie_faturamento_manual,'N')	= 'N'
	and	ie_origem_ato			= 'D'
	order	by coalesce(nr_seq_material,0),
		coalesce(nr_seq_estrutura_mat,0),
		coalesce(ie_prestador_pgto,0),
		coalesce(ie_prestador_exec,0),
		coalesce(cd_procedimento,0),
		coalesce(cd_grupo_proc,0),
		coalesce(cd_especialidade,0),
		coalesce(cd_area_procedimento,0),
		coalesce(nr_seq_tipo_prest_pgto,0),
		coalesce(nr_seq_tipo_prest_exec,0),
		coalesce(nr_seq_tipo_prest_prot,0),
		coalesce(ie_prestador_solic,0),
		coalesce(ie_prestador_atend,0),
		coalesce(nr_seq_grupo_rec,0),
		coalesce(ie_tipo_protocolo,'A'),
		coalesce(ie_tipo_guia,0),
		coalesce(ie_tipo_desp_proc,'0'),
		coalesce(ie_tipo_desp_mat,'0'),
		coalesce(nr_seq_prestador_pgto,0),
		coalesce(ie_medico_solic,'A'),
		coalesce(ie_medico_executor,'A'),
		coalesce(ie_tipo_segurado,'A'),
		coalesce(ie_tipo_contrato,'A'),
		coalesce(ie_faturamento_manual,'N');
		
BEGIN

select	pls_obter_dados_segurado_imp(b.nr_carteira_benef, 'SS', 'G'),
	b.cd_cpf_executante,
	b.cd_cnpj_executante,
	b.cd_cpf_solicitante,
	b.cd_cnpj_solicitante,
	b.dt_atendimento_ref,
	a.ie_tipo_guia
into STRICT	nr_seq_segurado_w,
	cd_cpf_executante_w,
	cd_cnpj_executante_w,
	cd_cpf_solicitante_w,
	cd_cnpj_solicitante_w,
	dt_atendimento_ref_w,
	ie_tipo_guia_w
from	ptu_aviso_conta		b,
	ptu_aviso_protocolo	a
where	a.nr_sequencia		= b.nr_seq_aviso_protocolo
and	b.nr_sequencia		= nr_seq_ptu_aviso_conta_p;

cd_pessoa_fisica_w	:= null;

if (coalesce(nr_seq_prestador_exec_w::text, '') = '') and (cd_cpf_executante_w IS NOT NULL AND cd_cpf_executante_w::text <> '') then
	select 	max(nr_sequencia),
		max(cd_pessoa_fisica)
	into STRICT	nr_seq_prestador_exec_w,
		cd_pessoa_fisica_w
	from	pls_prestador_intercambio
	where	nr_cpf = cd_cpf_executante_w;
end if;

if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
	select	max(cd_pessoa_fisica)
	into STRICT	cd_medico_conta_w
	from	medico
	where	cd_pessoa_fisica = cd_pessoa_fisica_w;
	
	if (cd_medico_conta_w IS NOT NULL AND cd_medico_conta_w::text <> '') then
		select	CASE WHEN pls_obter_se_cooperado_ativo(cd_medico_conta_w, dt_atendimento_ref_w, null)='S' THEN  'C'  ELSE 'N' END
		into STRICT	ie_medico_exec_coope_w
		;
	end if;
end if;

if (coalesce(nr_seq_prestador_exec_w::text, '') = '') and (cd_cnpj_executante_w IS NOT NULL AND cd_cnpj_executante_w::text <> '') then
	select 	max(nr_sequencia),
		max(CASE WHEN ie_relacao_operadora='C' THEN  3 WHEN ie_relacao_operadora='P' THEN  2 END )
	into STRICT	nr_seq_prestador_exec_w,
		ie_cooperado_exec_w
	from 	pls_prestador_intercambio
	where	cd_cgc_intercambio = cd_cnpj_executante_w;
end if;

cd_pessoa_fisica_w	:= null;

if (coalesce(nr_seq_prestador_solic_w::text, '') = '') and (cd_cpf_solicitante_w IS NOT NULL AND cd_cpf_solicitante_w::text <> '') then
	select 	max(nr_sequencia),
		max(cd_pessoa_fisica)
	into STRICT	nr_seq_prestador_solic_w,
		cd_pessoa_fisica_w
	from	pls_prestador_intercambio
	where	nr_cpf = cd_cpf_solicitante_w;
end if;

if (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
	select	max(cd_pessoa_fisica)
	into STRICT	cd_medico_solicitante_w
	from	medico
	where	cd_pessoa_fisica = cd_pessoa_fisica_w;
	
	if (cd_medico_solicitante_w IS NOT NULL AND cd_medico_solicitante_w::text <> '') then
		select	CASE WHEN pls_obter_se_cooperado_ativo(cd_medico_solicitante_w, dt_atendimento_ref_w, null)='S' THEN  'C'  ELSE 'N' END
		into STRICT	ie_medico_solic_coope_w
		;
	end if;
end if;

if (coalesce(nr_seq_prestador_solic_w::text, '') = '') and (cd_cnpj_solicitante_w IS NOT NULL AND cd_cnpj_solicitante_w::text <> '') then
	select 	max(nr_sequencia),
		max(CASE WHEN ie_relacao_operadora='C' THEN  3 WHEN ie_relacao_operadora='P' THEN  2 END )
	into STRICT	nr_seq_prestador_solic_w,
		ie_cooperado_solic_w
	from 	pls_prestador_intercambio
	where	cd_cgc_intercambio = cd_cnpj_solicitante_w;
end if;

if (ie_proc_mat_p = 'P') then
	select	CASE WHEN cd_tabela_p='22', 8, null) -- '00' (Tabela propria das operadoras) THEN  4(Proprio) WHEN cd_tabela_p='22' (TUSS procedimentos e eventos em saude) THEN  8(TUSS)	into STRICT	ie_origem_proced_w	;		SELECT * FROM pls_obter_estrut_proc(cd_procedimento_p, ie_origem_proced_w, cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, ie_origem_proced_w) INTO STRICT cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w, ie_origem_proced_w;		begin		select	nr_seq_grupo_rec WHEN cd_tabela_p=CASE WHEN ie_classificacao='4' THEN  '2' WHEN ie_classificacao='6' THEN  '2' WHEN ie_classificacao='5' THEN  '3'  ELSE '1' END 		into STRICT	nr_seq_grupo_rec_w THEN 			ie_tipo_desp_proc_w		from	procedimento		where	cd_procedimento	= cd_procedimento_p		and	ie_origem_proced = ie_origem_proced_w;	exception	when others then		nr_seq_grupo_rec_w	:= '';		ie_tipo_desp_proc_w	:= '';	end;elsif (ie_proc_mat_p = 'M') and (cd_mat_envio_p IS NOT NULL AND cd_mat_envio_p::text <> '') and (cd_tabela_p IS NOT NULL AND cd_tabela_p::text <> '') then	select	max(nr_sequencia)	into STRICT	nr_seq_material_w	from	pls_material	where	cd_material_ops = cd_mat_envio_p	and	CASE WHEN ie_tipo_despesa='1' THEN '18' WHEN ie_tipo_despesa='2' THEN '20' WHEN ie_tipo_despesa='3' THEN '19' WHEN ie_tipo_despesa='7' THEN '19'  ELSE '00' END  = cd_tabela_p;	-- 1 (Gases medicinais), 18 (TUSS - diarias, taxas e gases medicinais), 2 (Medicamentos), 20 (TUSS - medicamentos), 3 (Materiais), 19 (TUSS - materiais e OPME), 7 (OPM), 19 (TUSS - materiais e OPME), 00 (Tabela propria das operadoras)
		if (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') then		select	ie_tipo_despesa		into STRICT	ie_tipo_desp_mat_w		from	pls_material		where	nr_sequencia = nr_seq_material_w;	end if;end if;if (nr_seq_segurado_w IS NOT NULL AND nr_seq_segurado_w::text <> '') then	select	ie_tipo_segurado	into STRICT	ie_tipo_segurado_w	from	pls_segurado	where	nr_sequencia = nr_seq_segurado_w;		select	max(i.ie_tipo_contrato)	into STRICT	ie_tipo_contrato_w	from	pls_intercambio		i WHEN cd_tabela_p=pls_contrato_pagador	p THEN 		pls_segurado		s	where	i.nr_sequencia		= p.nr_seq_pagador_intercambio	and	p.nr_sequencia		= s.nr_seq_pagador	and	s.nr_sequencia		= nr_seq_segurado_w;end if;for r_c01_w in c01(	cd_procedimento_p,		ie_origem_proced_w,		cd_grupo_proc_w,			cd_especialidade_w,		cd_area_procedimento_w,		ie_cooperado_solic_w,			ie_cooperado_exec_w,		nr_seq_grupo_rec_w,		nr_seq_material_w,			ie_tipo_guia_w,			ie_tipo_desp_proc_w,		ie_tipo_desp_mat_w,			ie_medico_solic_coope_w,	ie_medico_exec_coope_w,		ie_tipo_segurado_w,			ie_tipo_contrato_w) loop	if (r_c01_w.ie_rede_nao_contratualizada = 'N') then		ie_estrut_mat_w	:= 'S';		if (r_c01_w.nr_seq_estrutura_mat IS NOT NULL AND r_c01_w.nr_seq_estrutura_mat::text <> '') then			ie_estrut_mat_w	:= pls_obter_se_mat_estrutura(nr_seq_material_w, r_c01_w.nr_seq_estrutura_mat);		end if;				if (ie_estrut_mat_w = 'S') then			nr_seq_regra_w		:= r_c01_w.nr_seq_regra;			ie_ato_cooperado_w	:= r_c01_w.ie_ato_cooperado;		end if;	end if;end loop;nr_seq_regra_p		:= nr_seq_regra_w;ie_ato_cooperado_p	:= ie_ato_cooperado_w;end; END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_tipo_ato_coop_a520 ( nr_seq_ptu_aviso_conta_p ptu_aviso_conta.nr_sequencia%type, ie_proc_mat_p text, cd_procedimento_p ptu_aviso_procedimento.cd_procedimento%type, cd_mat_envio_p ptu_aviso_material.cd_mat_envio%type, cd_tabela_p ptu_aviso_material.cd_tabela%type, nr_seq_regra_p INOUT pls_ato_cooperado.nr_sequencia%type, ie_ato_cooperado_p INOUT pls_ato_cooperado.ie_ato_cooperado%type) FROM PUBLIC;

