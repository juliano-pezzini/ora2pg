-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_gerar_decurso_prazo_v60 ( nr_seq_guia_p pls_guia_plano.nr_sequencia%type, nr_seq_requisicao_p pls_requisicao.nr_sequencia%type, nm_usuario_p text, nr_seq_decurso_p INOUT ptu_decurso_prazo.nr_sequencia%type) AS $body$
DECLARE

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Atualizar os itens da guia conforme a geração de ocorr~encia combinada.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:Performance.
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
nr_seq_execucao_w		ptu_decurso_prazo.nr_seq_execucao%type;
ie_tipo_cliente_w		ptu_decurso_prazo.ie_tipo_cliente%type;
cd_unimed_executora_w		ptu_decurso_prazo.cd_unimed_executora%type;
cd_unimed_beneficiario_w	ptu_decurso_prazo.cd_unimed_beneficiario%type;
ie_estagio_guia_w		pls_guia_plano.ie_estagio%type;
ie_estagio_req_w		pls_requisicao.ie_estagio%type;
qt_opme_w			integer;
dt_atualizacao_w		ptu_resposta_autorizacao.dt_atualizacao%type;
qt_dias_uteis			integer;


BEGIN

if (nr_seq_guia_p IS NOT NULL AND nr_seq_guia_p::text <> '') then
	select	ie_estagio
	into STRICT	ie_estagio_guia_w
	from	pls_guia_plano
	where	nr_sequencia	= nr_seq_guia_p;

	if (ie_estagio_guia_w	<> 11) then
		--Esta transação deve ser enviada somente quando o pedido estiver em auditoria na operadora de origem!
		CALL wheb_mensagem_pck.exibir_mensagem_abort(288462);
	end if;

	begin
		select	nr_seq_execucao,
			ie_tipo_cliente,
			cd_unimed_executora,
			cd_unimed_beneficiario
		into STRICT	nr_seq_execucao_w,
			ie_tipo_cliente_w,
			cd_unimed_executora_w,
			cd_unimed_beneficiario_w
		from	ptu_pedido_autorizacao
		where	nr_seq_guia	= nr_seq_guia_p;
	exception
	when others then
		begin
			select	nr_seq_execucao,
				ie_tipo_cliente,
				cd_unimed_executora,
				cd_unimed_beneficiario
			into STRICT	nr_seq_execucao_w,
				ie_tipo_cliente_w,
				cd_unimed_executora_w,
				cd_unimed_beneficiario_w
			from	ptu_pedido_compl_aut
			where	nr_seq_guia	= nr_seq_guia_p;
		exception
		when others then
			--Não é possível enviar um decurso de prazo sem pedido de autorização ou pedido de complemento de autorização!
			CALL wheb_mensagem_pck.exibir_mensagem_abort(288450);
		end;
	end;


	select	max(dt_atualizacao)
	into STRICT	dt_atualizacao_w
	from	ptu_resposta_autorizacao
	where	nr_seq_guia	= nr_seq_guia_p;

	if (coalesce(dt_atualizacao_w::text, '') = '') then
		--Não é possível enviar um decurso de prazo sem a resposta de pedido de autorização ou pedido de complemento de autorização!
		CALL wheb_mensagem_pck.exibir_mensagem_abort(288506);
	end if;

	select	count(1)
	into STRICT	qt_opme_w
	from	pls_guia_plano_mat	a,
		pls_material		b
	where	a.nr_seq_material	= b.nr_sequencia
	and	b.ie_tipo_despesa	= '7'
	and	nr_seq_guia		= nr_seq_guia_p;

	select	pls_obter_dias_uteis_periodo(dt_atualizacao_w, clock_timestamp())
	into STRICT	qt_dias_uteis
	;

	if (qt_opme_w	= 0) and (qt_dias_uteis	< 2) then
		--Esta transação não pode ser enviada, o tempo máximo de espera ainda não foi ultrapassado conforme MIN(Manual de Intercâmbio Nacional)!
		CALL wheb_mensagem_pck.exibir_mensagem_abort(288503);
	elsif (qt_opme_w	> 0) and (qt_dias_uteis	< 5) then
		--Esta transação não pode ser enviada, o tempo máximo de espera ainda não foi ultrapassado conforme MIN(Manual de Intercâmbio Nacional)!
		CALL wheb_mensagem_pck.exibir_mensagem_abort(288503);
	end if;

	CALL pls_guia_gravar_historico(nr_seq_guia_p, 2, 'Enviado pedido de decurso de prazo para a Unimed '||cd_unimed_beneficiario_w, '', nm_usuario_p);

elsif (nr_seq_requisicao_p IS NOT NULL AND nr_seq_requisicao_p::text <> '') then
	select	ie_estagio
	into STRICT	ie_estagio_req_w
	from	pls_requisicao
	where	nr_sequencia	= nr_seq_requisicao_p;

	if (ie_estagio_guia_w	<> 5) then
		--Esta transação deve ser enviada somente quando o pedido estiver em auditoria na operadora de origem!
		CALL wheb_mensagem_pck.exibir_mensagem_abort(288462);
	end if;

	begin
		select	nr_seq_execucao,
			ie_tipo_cliente,
			cd_unimed_executora,
			cd_unimed_beneficiario
		into STRICT	nr_seq_execucao_w,
			ie_tipo_cliente_w,
			cd_unimed_executora_w,
			cd_unimed_beneficiario_w
		from	ptu_pedido_autorizacao
		where	nr_seq_requisicao	= nr_seq_requisicao_p;
	exception
	when others then
		begin
			select	nr_seq_execucao,
				ie_tipo_cliente,
				cd_unimed_executora,
				cd_unimed_beneficiario
			into STRICT	nr_seq_execucao_w,
				ie_tipo_cliente_w,
				cd_unimed_executora_w,
				cd_unimed_beneficiario_w
			from	ptu_pedido_compl_aut
			where	nr_seq_requisicao	= nr_seq_requisicao_p;
		exception
		when others then
			--Não é possível enviar um decurso de prazo sem pedido de autorização ou pedido de complemento de autorização!
			CALL wheb_mensagem_pck.exibir_mensagem_abort(288450);
		end;
	end;

	select	max(dt_atualizacao)
	into STRICT	dt_atualizacao_w
	from	ptu_resposta_autorizacao
	where	nr_seq_requisicao	= nr_seq_requisicao_p;

	if (coalesce(dt_atualizacao_w::text, '') = '') then
	--Não é possível enviar um decurso de prazo sem a resposta de pedido de autorização ou complemento de autorização!
		CALL wheb_mensagem_pck.exibir_mensagem_abort(288506);
	end if;

	select	count(1)
	into STRICT	qt_opme_w
	from	pls_requisicao_mat	a,
		pls_material		b
	where	a.nr_seq_material	= b.nr_sequencia
	and	b.ie_tipo_despesa	= '7'
	and	nr_seq_requisicao	= nr_seq_requisicao_p;

	select	pls_obter_dias_uteis_periodo(dt_atualizacao_w, clock_timestamp())
	into STRICT	qt_dias_uteis
	;

	if (qt_opme_w	= 0) and (qt_dias_uteis	< 2) then
		--Esta transação não pode ser enviada, o tempo máximo de espera ainda não foi ultrapassado conforme MIN(Manual de Intercâmbio Nacional)!
		CALL wheb_mensagem_pck.exibir_mensagem_abort(288503);
	elsif (qt_opme_w	> 0) and (qt_dias_uteis	< 5) then
		--Esta transação não pode ser enviada, o tempo máximo de espera ainda não foi ultrapassado conforme MIN(Manual de Intercâmbio Nacional)!
		CALL wheb_mensagem_pck.exibir_mensagem_abort(288503);
	end if;

	CALL pls_requisicao_gravar_hist(nr_seq_requisicao_p, 'L', 'Enviado pedido de decurso de prazo para a Unimed '||cd_unimed_beneficiario_w, null, nm_usuario_p);
end if;

if	((nr_seq_guia_p IS NOT NULL AND nr_seq_guia_p::text <> '') or (nr_seq_requisicao_p IS NOT NULL AND nr_seq_requisicao_p::text <> '')) then
	select	nextval('ptu_decurso_prazo_seq')
	into STRICT	nr_seq_decurso_p
	;

	insert	into ptu_decurso_prazo(nr_sequencia, cd_transacao, ie_tipo_cliente,
		 cd_unimed_executora, cd_unimed_beneficiario, nr_seq_execucao,
		 dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
		 nm_usuario_nrec, nr_versao, nr_seq_requisicao,
		 nr_seq_guia)
	values (nr_seq_decurso_p, '00700',ie_tipo_cliente_w,
		 cd_unimed_executora_w, cd_unimed_beneficiario_w, nr_seq_execucao_w,
		 clock_timestamp(), nm_usuario_p, clock_timestamp(),
		 nm_usuario_p, '050', nr_seq_requisicao_p,
		 nr_seq_guia_p);

	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_gerar_decurso_prazo_v60 ( nr_seq_guia_p pls_guia_plano.nr_sequencia%type, nr_seq_requisicao_p pls_requisicao.nr_sequencia%type, nm_usuario_p text, nr_seq_decurso_p INOUT ptu_decurso_prazo.nr_sequencia%type) FROM PUBLIC;

