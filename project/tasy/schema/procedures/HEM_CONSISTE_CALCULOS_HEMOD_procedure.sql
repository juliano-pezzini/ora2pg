-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hem_consiste_calculos_hemod ( nr_seq_hem_calc_p bigint, nm_usuario_p text, ds_consistencias_p INOUT text) AS $body$
DECLARE


C01 CURSOR FOR
	SELECT	qt_saturacao_o2,
		qt_po2,
		qt_pam,
		ie_tipo
	FROM	hem_manometria_completa
	WHERE	nr_seq_hem_calc	= nr_seq_hem_calc_p;

qt_saturacao_w		hem_manometria_completa.qt_saturacao_o2%TYPE;
qt_po2_w		hem_manometria_completa.qt_po2%TYPE;
qt_pam_w		hem_manometria_completa.qt_pam%TYPE;
ie_tipo_w		hem_manometria_completa.ie_tipo%TYPE;
qt_po2_AO_w		hem_manometria_completa.qt_po2%TYPE;
qt_saturacao_o2_AO_w	hem_manometria_completa.qt_saturacao_o2%TYPE;
qt_po2_TP_w		hem_manometria_completa.qt_po2%TYPE;
qt_saturacao_o2_TP_w	hem_manometria_completa.qt_saturacao_o2%TYPE;
qt_po2_AE_w		hem_manometria_completa.qt_po2%TYPE;
qt_saturacao_o2_AE_w	hem_manometria_completa.qt_saturacao_o2%TYPE;
qt_po2_VC_w		hem_manometria_completa.qt_po2%TYPE;
qt_saturacao_o2_VC_w	hem_manometria_completa.qt_saturacao_o2%TYPE;
qt_pam_TP_w		hem_manometria_completa.qt_pam%TYPE;
qt_pam_AD_w		hem_manometria_completa.qt_pam%TYPE;
qt_pam_AO_w		hem_manometria_completa.qt_pam%TYPE;
qt_pam_CP_w		hem_manometria_completa.qt_pam%TYPE;
qt_cons_est_o2_w	hem_calc_hemodinamico.qt_cons_est_o2%TYPE;
qt_superf_corporia_w	hem_calc_hemodinamico.qt_superf_corporia%TYPE;
qt_hb_w			hem_calc_hemodinamico.qt_hb%TYPE;
ie_avaliacao_w		hem_calc_hemodinamico.ie_avaliacao%TYPE;
ie_calculo_w		hem_calc_hemodinamico.ie_calculo%TYPE;
qt_fluxo_w		hem_calc_hem_result.qt_fluxo_pulmonar%TYPE;

ds_inconsistencia_w	varchar(2000);


BEGIN
IF (coalesce(nr_seq_hem_calc_p, 0) > 0) THEN

	OPEN C01;
	LOOP
	FETCH C01 INTO
		qt_saturacao_w,
		qt_po2_w,
		qt_pam_w,
		ie_tipo_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		BEGIN
		IF (ie_tipo_w = 'AO') THEN
			qt_saturacao_o2_AO_w	:= qt_saturacao_w;
			qt_po2_AO_w		:= coalesce(qt_po2_w,0);
			qt_pam_AO_w		:= qt_pam_w;
		END IF;
		IF (ie_tipo_w = 'TP') THEN
			qt_saturacao_o2_TP_w	:= qt_saturacao_w;
			qt_po2_TP_w		:= coalesce(qt_po2_w,0);
			qt_pam_TP_w		:= qt_pam_w;
		END IF;
		IF (ie_tipo_w = 'AE') THEN
			qt_saturacao_o2_AE_w	:= qt_saturacao_w;
			qt_po2_AE_w		:= coalesce(qt_po2_w,0);
		END IF;
		IF (ie_tipo_w = 'VC') THEN
			qt_saturacao_o2_VC_w	:= qt_saturacao_w;
			qt_po2_VC_w		:= coalesce(qt_po2_w,0);
		END IF;
		IF (ie_tipo_w = 'AD') THEN
			qt_pam_AD_w		:= qt_pam_w;
		END IF;
		IF (ie_tipo_w = 'CP') THEN
			qt_pam_CP_w		:= qt_pam_w;
		END IF;
		END;
	END LOOP;
	CLOSE C01;

	SELECT	MAX(qt_cons_est_o2),
		MAX(qt_hb),
		MAX(qt_superf_corporia),
		MAX(ie_avaliacao),
		MAX(ie_calculo)
	INTO STRICT	qt_cons_est_o2_w,
		qt_hb_w,
		qt_superf_corporia_w,
		ie_avaliacao_w,
		ie_calculo_w
	FROM	hem_calc_hemodinamico
	WHERE	nr_sequencia = nr_seq_hem_calc_p;

	IF (ie_calculo_w = 'SG') THEN

		SELECT	MAX(coalesce(qt_fluxo_sist,qt_fluxo_pulmonar))
		INTO STRICT	qt_fluxo_w
		FROM	hem_calc_hem_result
		WHERE	nr_seq_calc_hemo = nr_seq_hem_calc_p;

		IF (coalesce( qt_fluxo_w ,0) = 0) THEN
			ds_inconsistencia_w	:= ds_inconsistencia_w||obter_desc_expressao(643064)||';';
		END IF;
	END IF;
	IF (coalesce( qt_cons_est_o2_w ,0) = 0) THEN
		ds_inconsistencia_w	:= ds_inconsistencia_w||obter_desc_expressao(643033)||';';
	END IF;
	IF (coalesce( qt_hb_w ,0) = 0) THEN
		ds_inconsistencia_w	:= ds_inconsistencia_w||obter_desc_expressao(291251)||';';
	END IF;
	IF (coalesce( qt_superf_corporia_w ,0) = 0) THEN
		ds_inconsistencia_w	:= ds_inconsistencia_w||obter_desc_expressao(298955)||';';
	END IF;

	IF (coalesce( qt_saturacao_o2_AO_w ,0) = 0) THEN
		ds_inconsistencia_w	:= ds_inconsistencia_w||obter_desc_expressao(347205)||' - '||obter_desc_expressao(298049)||';';
	END IF;
	IF (coalesce( qt_pam_AO_w ,0) = 0) THEN
		ds_inconsistencia_w	:= ds_inconsistencia_w||obter_desc_expressao(347205)||' - '||obter_desc_expressao(295239)||';';
	END IF;
	IF (coalesce( qt_saturacao_o2_TP_w ,0) = 0) THEN
		ds_inconsistencia_w	:= ds_inconsistencia_w||obter_desc_expressao(339631)||' - '||obter_desc_expressao(298049)||';';
	END IF;
	IF (coalesce( qt_pam_TP_w ,0) = 0) THEN
		ds_inconsistencia_w	:= ds_inconsistencia_w||obter_desc_expressao(339631)||' - '||obter_desc_expressao(295239)||';';
	END IF;
	IF (coalesce( qt_saturacao_o2_AE_w ,0) = 0) THEN
		ds_inconsistencia_w	:= ds_inconsistencia_w||obter_desc_expressao(313290)||' - '||obter_desc_expressao(298049)||';';
	END IF;
	IF (coalesce( qt_saturacao_o2_VC_w ,0) = 0) THEN
		ds_inconsistencia_w	:= ds_inconsistencia_w||obter_desc_expressao(643344)||' - '||obter_desc_expressao(298049)||';';
	END IF;
	IF (coalesce( qt_pam_AD_w ,0) = 0) THEN
		ds_inconsistencia_w	:= ds_inconsistencia_w||obter_desc_expressao(339629)||' - '||obter_desc_expressao(295239)||';';
	END IF;
	IF (coalesce( qt_pam_CP_w ,0) = 0) THEN
		ds_inconsistencia_w	:= ds_inconsistencia_w||obter_desc_expressao(339630)||' - '||obter_desc_expressao(295239)||';';
	END IF;

END IF;
ds_consistencias_p := SUBSTR(ds_inconsistencia_w,1,255);
COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hem_consiste_calculos_hemod ( nr_seq_hem_calc_p bigint, nm_usuario_p text, ds_consistencias_p INOUT text) FROM PUBLIC;

