-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_nom_rc_patologico (nr_seq_cabecalho_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_atendimento_w			atendimento_paciente.nr_atendimento%type;
nr_seq_episodio_w			episodio_paciente.nr_sequencia%type;
nm_usuario_w				usuario.nm_usuario%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;


dt_diabetes_w				nom_rc_patologico.dt_diabetes%type;			/*id_279*/
dt_hipertensao_w			nom_rc_patologico.dt_hipertensao%type;			/*id_280*/
dt_hipertiroidismo_w		nom_rc_patologico.dt_hipertiroidismo%type;		/*id_281*/
ds_outro_ant_patologico_w	nom_rc_patologico.ds_outro_ant_patologico%type := null;	/*id_282*/
dt_outro_ant_pat_w			nom_rc_patologico.dt_outro_ant_pat%type := null;		/*id_283*/
cd_doenca_cid_w				varchar(32000);			/*id_284*/
tempo_diabetes_w			varchar(255);
tempo_hipertensao_w			varchar(255);
tempo_hipertiroidismo_w		varchar(255);

ds_html_w			varchar(32000)	:= null;/*id_278*/
cd_doenca_hipertensao_w		cid_doenca.cd_doenca%type;
cd_doenca_diabete_w			cid_doenca.cd_doenca%type;
cd_doenca_hipertiroidismo_w	cid_doenca.cd_doenca%type;

ds_outras_w			varchar(255);
dt_outras_w			timestamp;

r_patol CURSOR FOR
SELECT	a.cd_doenca,
			coalesce(dt_inicio, dt_registro) dt_outras,
			coalesce(obter_valor_dominio(9217,a.ie_doenca_cronica),coalesce(a.ds_doenca,b.ds_doenca_cid)) ds_outras,
			b.ie_doenca_cronica_mx
FROM paciente_antec_clinico a
LEFT OUTER JOIN cid_doenca b ON (a.cd_doenca = b.cd_doenca_cid)
WHERE (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') and (a.dt_inicio IS NOT NULL AND a.dt_inicio::text <> '') and coalesce(a.dt_fim::text, '') = '' and coalesce(a.dt_inativacao::text, '') = ''  and a.cd_pessoa_fisica = cd_pessoa_fisica_w and a.ie_paciente = 'S';

BEGIN

delete FROM nom_rc_patologico where nr_seq_cabecalho = nr_seq_cabecalho_p;

select	a.nr_atendimento,
			a.nr_seq_episodio,
			a.cd_estabelecimento,
			a.nm_usuario nm_usuario
into STRICT		nr_atendimento_w,
			nr_seq_episodio_w,
			cd_estabelecimento_w,
			nm_usuario_w
from		nom_rc_cabecalho a
where		a.nr_sequencia	= nr_seq_cabecalho_p;

if	((coalesce(nr_atendimento_w::text, '') = '') and (nr_seq_episodio_w IS NOT NULL AND nr_seq_episodio_w::text <> '')) then
	select	min(nr_atendimento)
	into STRICT		nr_atendimento_w
	from		atendimento_paciente a
	where		a.nr_seq_episodio = nr_seq_episodio_w;
end if;

if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
	select	cd_pessoa_fisica
	into STRICT		cd_pessoa_fisica_w
	from		atendimento_paciente
	where		nr_atendimento = nr_atendimento_w;


	select (select 	min(coalesce(dt_inicio, dt_registro))
			 from 	cid_doenca c,
						paciente_antec_clinico b
			 where 	b.cd_pessoa_fisica = cd_pessoa_fisica_w
			 and 		coalesce(ie_paciente, 'N') = 'S'
			 and 		(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
			 and 		coalesce(b.dt_inativacao::text, '') = ''
			 and		coalesce(b.dt_fim::text, '') = ''
			 and 		b.cd_doenca = c.cd_doenca_cid
			 and 		c.ie_doenca_cronica_mx = 'HIPAS') dt_hipas, /*id_280*/
			(select 	min(coalesce(dt_inicio, dt_registro))
			 from 	cid_doenca c,
						paciente_antec_clinico b
			 where	b.cd_pessoa_fisica = cd_pessoa_fisica_w
			 and 		coalesce(ie_paciente, 'N') = 'S'
			 and 		(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
			 and		coalesce(b.dt_inativacao::text, '') = ''
			 and		coalesce(b.dt_fim::text, '') = ''
			 and		b.cd_doenca = c.cd_doenca_cid
			 and		c.ie_doenca_cronica_mx = 'DIABT') dt_diabt,	/*id_279*/
			(select 	min(coalesce(dt_inicio, dt_registro))
			 from 	cid_doenca c,
						paciente_antec_clinico b
			 where 	b.cd_pessoa_fisica = cd_pessoa_fisica_w
			 and 		coalesce(ie_paciente, 'N') = 'S'
			 and 		(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
			 and 		coalesce(b.dt_inativacao::text, '') = ''
			 and		coalesce(b.dt_fim::text, '') = ''
			 and 		b.cd_doenca = c.cd_doenca_cid
			 and 		c.ie_doenca_cronica_mx = 'LIPDM') dt_lipdm	/*id_281*/
	into STRICT
			dt_hipertensao_w,
			dt_diabetes_w,
			dt_hipertiroidismo_w
	;

	ds_html_w	:= '<table class="wrichedit-table" width="100%" xmlns="urn:hl7-org:v3">';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || '<thead>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '<tr>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Diabetes</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Hipertension</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Hipertiroidismo</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '</tr>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) ||  '</thead>';

	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || '<tbody>';

	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '<tr>';

	if (pkg_date_utils.get_DiffDate(coalesce(dt_diabetes_w, clock_timestamp()), clock_timestamp(), 'DAY') > 0) then
	tempo_diabetes_w := Obter_Idade(dt_diabetes_w,clock_timestamp(),'C');
	else
	tempo_diabetes_w := UPPER(obter_desc_expressao(298123));/*SIN INFORMACIÓN*/
	end if;

	if (pkg_date_utils.get_DiffDate(coalesce(dt_hipertensao_w, clock_timestamp()), clock_timestamp(), 'DAY') > 0) then
	tempo_hipertensao_w := Obter_Idade(dt_hipertensao_w,clock_timestamp(),'C');
	else
	tempo_hipertensao_w := UPPER(obter_desc_expressao(298123));/*SIN INFORMACIÓN*/
	end if;

	if (pkg_date_utils.get_DiffDate(coalesce(dt_hipertiroidismo_w, clock_timestamp()), clock_timestamp(), 'DAY') > 0) then
	tempo_hipertiroidismo_w := Obter_Idade(dt_hipertiroidismo_w,clock_timestamp(), 'C');
	else
	tempo_hipertiroidismo_w := UPPER(obter_desc_expressao(298123));/*SIN INFORMACIÓN*/
	end if;

	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || tempo_diabetes_w || '</td>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || tempo_hipertensao_w || '</td>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || tempo_hipertiroidismo_w || '</td>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '</tr>';

	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || '</tbody>';

	ds_html_w	:= ds_html_w || chr(13) || chr(10) || '</table>'; /*id_278*/


	/* HTML */

   insert into nom_rc_patologico(
			  nr_sequencia,
			  dt_atualizacao,
			  nm_usuario,
			  dt_atualizacao_nrec,
			  nm_usuario_nrec,
			  nr_seq_cabecalho,
			  dt_diabetes,
			  dt_hipertensao,
			  dt_hipertiroidismo,
			  ds_outro_ant_patologico,
			  dt_outro_ant_pat,
			  cd_doenca_cid,
			  ds_html
			) values (
			  nextval('nom_rc_patologico_seq'),
			  clock_timestamp(),
			  nm_usuario_p,
			  clock_timestamp(),
			  nm_usuario_p,
			  nr_seq_cabecalho_p,
			  null,
			  null,
			  null,
			  null,
			  null,
			  null,
			  ds_html_w
			);

	/* Main diseases */


	/* HTML */

   insert into nom_rc_patologico(
			  nr_sequencia,
			  dt_atualizacao,
			  nm_usuario,
			  dt_atualizacao_nrec,
			  nm_usuario_nrec,
			  nr_seq_cabecalho,
			  dt_diabetes,
			  dt_hipertensao,
			  dt_hipertiroidismo,
			  ds_outro_ant_patologico,
			  dt_outro_ant_pat,
			  cd_doenca_cid,
			  ds_html
			) values (
			  nextval('nom_rc_patologico_seq'),
			  clock_timestamp(),
			  nm_usuario_p,
			  clock_timestamp(),
			  nm_usuario_p,
			  nr_seq_cabecalho_p,
			  dt_diabetes_w,
			  dt_hipertensao_w,
			  dt_hipertiroidismo_w,
			  null,
			  null,
			  null,
			  null
			);

	for rc_patol in r_patol loop

		ds_outras_w	:= null;
		dt_outras_w	:= null;
		if (coalesce(rc_patol.ie_doenca_cronica_mx,'X') not in ('HIPAS','DIABT','LIPDM')) then
			ds_outras_w	:= rc_patol.ds_outras;
			dt_outras_w	:= rc_patol.dt_outras;
		end if;
	
		insert into nom_rc_patologico(
				  nr_sequencia,
				  dt_atualizacao,
				  nm_usuario,
				  dt_atualizacao_nrec,
				  nm_usuario_nrec,
				  nr_seq_cabecalho,
				  dt_diabetes,
				  dt_hipertensao,
				  dt_hipertiroidismo,
				  ds_outro_ant_patologico,
				  dt_outro_ant_pat,
				  cd_doenca_cid,
				  ds_html
				) values (
				  nextval('nom_rc_patologico_seq'),
				  clock_timestamp(),
				  nm_usuario_p,
				  clock_timestamp(),
				  nm_usuario_p,
				  nr_seq_cabecalho_p,
				  null,
				  null,
				  null,
				  ds_outras_w,
				  dt_outras_w,
				  rc_patol.cd_doenca,
				  null
				);

	end loop;

end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_nom_rc_patologico (nr_seq_cabecalho_p bigint, nm_usuario_p text) FROM PUBLIC;

