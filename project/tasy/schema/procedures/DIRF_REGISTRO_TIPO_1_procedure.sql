-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dirf_registro_tipo_1 ( nr_seq_lote_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ds_arquivo_w	varchar(2000);				
 

BEGIN 
 
delete 
from	w_dirf_arquivo 
where	nm_usuario = nm_usuario_p;
 
select 	--lpad(to_char(0 + 1),8,'0') || --nr_seq_arquivo 
	'1' || --tipo 
	lpad(b.cd_cgc,14,'0') || --cpf/cnpj 
	'Dirf' || --nome arquivo 
	lpad(to_char(a.dt_lote,'yyyy'),4,' ') || --ano calendario 
	lpad(coalesce(substr(upper(a.ie_retificadora),1,1),' '),1,' ') || --O/R 
	lpad(coalesce(substr(a.ie_situacao_declaracao,1,1),' '),1,' ') || --situacao da declaracao 
	'2' || --tipo declarante 
	lpad(coalesce(substr(a.ie_natureza_declarante,1,1),' '),1,' ') || --natureza do declarante 
	lpad(coalesce(a.ie_tipo_rendimento,' '),1,' ') || --identificacao do tipo do rendimento 
	lpad(to_char(clock_timestamp(),'yyyy'),4,' ') || --ana referencia 
	lpad(a.ie_declarante_depositario,1,' ') || --declarante deposit√°rio 
	lpad(coalesce(a.ie_indicador_socio,' '),1,' ') || --indicasdor de de socio 
	rpad(coalesce(substr(e.nm_razao_social,1,60),' '),60,' ') || -- 
	lpad(coalesce(substr(obter_dados_pf(e.cd_contabilista,'CPF'),1,11),' '),11,' ') || 
	lpad(CASE WHEN a.ie_situacao_declaracao=2 THEN to_char(clock_timestamp(),'DDMMYYYY')  ELSE ' ' END ,8,' ') || 
	' ' || 
	lpad(' ',42,' ') || 
	lpad(coalesce(substr(a.nr_recibo_retificada,1,12),' '),12,' ') || 
	lpad(' ',229,' ') || 
	lpad(coalesce(substr(obter_dados_pf(e.cd_contabilista,'CPF'),1,11),'0'),11,'0') || 
	rpad(coalesce(substr(obter_nome_pf_pj(e.cd_contabilista,null),1,60),' '),60,' ') || 
	lpad(coalesce(obter_compl_pf(e.cd_contabilista,1,'DDT'),'0'),4,'0') || 
	lpad(coalesce(substr(obter_dados_pf_pj(e.cd_contabilista,null,'T'),1,8),'0'),8,'0') || 
	lpad(coalesce(substr(obter_compl_pf(e.cd_contabilista,1,'RAM'),1,6),'0'),6,'0') || 
	lpad(coalesce(substr(obter_dados_pf_pj(e.cd_contabilista,null,'FAX'),1,8),'0'),8,'0') || 
	rpad(coalesce(substr(obter_dados_pf_pj(e.cd_contabilista,null,'M'),1,50),' '),50,' ') || 
	lPad(' ',165,' ') || 
	lPad(' ',12,' ') || 
	'9' 
into	ds_arquivo_w	 
from	dirf_lote a, 
	estabelecimento b, 
	empresa e 
where	a.cd_estabelecimento	= b.cd_estabelecimento 
and	b.cd_empresa = e.cd_empresa	 
and	a.nr_sequencia = nr_seq_lote_p;
 
insert 	into w_dirf_arquivo(nr_sequencia, 
			   nm_usuario, 
			   nm_usuario_nrec, 
			   dt_atualizacao, 
			   dt_atualizacao_nrec, 
			   ds_arquivo, 
			   nr_seq_apresentacao, 
			   nr_seq_registro) 
values (nextval('w_dirf_arquivo_seq'), 
			   nm_usuario_p, 
			   nm_usuario_p, 
			   clock_timestamp(), 
			   clock_timestamp(), 
			   ds_arquivo_w, 
			   '1', 
			   0);
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dirf_registro_tipo_1 ( nr_seq_lote_p bigint, nm_usuario_p text) FROM PUBLIC;

