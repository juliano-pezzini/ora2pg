-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_registros_tabela (USUARIO_P text) AS $body$
DECLARE


nm_tabela_w		varchar(30);
vl_retorno_w	varchar(20);
ds_comando_w	varchar(2000);
qt_media_bytes_w	bigint;

sofar_w bigint := 0;
n_cleanupdb_pck_w bigint := 0;
nm_fase_atualizacao_w varchar(20) := 'DATABASE_CLEANUP';

C010 CURSOR FOR
SELECT nm_tabela
FROM tabela_sistema;


BEGIN

SELECT COUNT(1)
INTO STRICT n_cleanupdb_pck_w
FROM USER_OBJECTS
WHERE OBJECT_NAME = 'CLEANUPDB_PCK'
AND STATUS = 'VALID';

OPEN C010;
LOOP
    FETCH C010 into	nm_tabela_w;
    EXIT WHEN NOT FOUND; /* apply on C010 */
    ds_comando_w := 'select count(*) from ' || nm_tabela_w;
	vl_retorno_w := Obter_Valor_Dinamico(ds_comando_w, vl_retorno_w);
	update tabela_sistema
	set qt_registros_atual = vl_retorno_w
	where nm_tabela 	 = nm_tabela_w;
	if (n_cleanupdb_pck_w > 1) then
      EXECUTE 'begin cleanupdb_pck.add_progress(:nm_fase_atualizacao_w, 1); end;' using nm_fase_atualizacao_w;
	end if;
END LOOP;
CLOSE C010;
COMMIT;

if (n_cleanupdb_pck_w > 1) then
	EXECUTE 'begin cleanupdb_pck.RELEASE_CLEANUP_PROGRESS; end;';
end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_registros_tabela (USUARIO_P text) FROM PUBLIC;

