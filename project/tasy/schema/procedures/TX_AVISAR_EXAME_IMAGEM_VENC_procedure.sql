-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tx_avisar_exame_imagem_venc (nm_usuario_p text) AS $body$
DECLARE

 
cd_pessoa_fisica_w		varchar(10);
nm_pessoa_fisica_w		varchar(255);
ie_forma_solic_w		varchar(15);
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
nr_seq_proc_interno_w		bigint;
nr_seq_imagem_prot_ext_w	bigint;
dt_prev_exec_w			timestamp;
dt_laudo_w			timestamp;
cd_perfil_w			integer;
ds_mensgaem_gerada_w		varchar(255);
ds_enter_w			varchar(20)	:= chr(10)||chr(13);
ds_procedimento_w		varchar(255);

c01 CURSOR FOR /* pacientes que tem prescrições a ser geradas */
 
	SELECT	a.cd_pessoa_fisica, 
		substr(obter_nome_pf(a.cd_pessoa_fisica),1,80) 
	from	tx_pac_prot_exame_laudo a, 
		tx_receptor b 
	where	tx_obter_se_paciente_ativo(b.nr_sequencia) = 'S' 
	and	a.cd_pessoa_fisica = b.cd_pessoa_fisica 
	group by a.cd_pessoa_fisica 
	order by a.cd_pessoa_fisica;
	
c02 CURSOR FOR 
	SELECT	a.nr_seq_imagem_prot_ext, 
		ie_forma_solic, 
		cd_procedimento, 
		ie_origem_proced, 
		nr_seq_proc_interno, 
		substr(obter_descricao_procedimento(cd_procedimento,ie_origem_proced),1,255) 
	from	tx_pac_prot_exame_laudo a, 
		imagem_protocolo_ext_item b 
	where	a.nr_seq_imagem_prot_ext = b.nr_seq_imagem_prot_ext 
	and	cd_pessoa_fisica	= cd_pessoa_fisica_w;
	

BEGIN 
open c01;
	loop 
	fetch c01 into 
		cd_pessoa_fisica_w, 
		nm_pessoa_fisica_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	 
	ds_mensgaem_gerada_w := null;
	 
	open c02;
		loop 
		fetch c02 into nr_seq_imagem_prot_ext_w, 
				ie_forma_solic_w, 
				cd_procedimento_w, 
				ie_origem_proced_w, 
				nr_seq_proc_interno_w, 
				ds_procedimento_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
		 
		select 	max(dt_laudo) 
		into STRICT	dt_laudo_w 
		from( 
			SELECT 	dt_laudo dt_laudo 
			from 	laudo_paciente a, 
				prescr_medica b, 
				prescr_procedimento c 
			where	a.nr_prescricao = b.nr_prescricao 
			and	b.nr_prescricao = c.nr_prescricao 
			and	b.cd_pessoa_fisica = cd_pessoa_fisica_w 
			and	((c.cd_procedimento = cd_procedimento_w 	and	c.ie_origem_proced = ie_origem_proced_w) or (c.nr_seq_proc_interno = nr_seq_proc_interno_w)) 
			
union
	 
			SELECT	dt_exame dt_laudo 
			from	imagem_pac_prot_externo a, 
				atendimento_paciente b 
			where	a.nr_atendimento = b.nr_atendimento 
			and	nr_seq_imagem_prot_ext = nr_seq_imagem_prot_ext_w 
			and	b.cd_pessoa_fisica = cd_pessoa_fisica_w);
			 
			dt_prev_exec_w	:= null;
			if (dt_laudo_w IS NOT NULL AND dt_laudo_w::text <> '') then 
				dt_prev_exec_w := obter_prox_data_solic(ie_forma_solic_w,dt_laudo_w,'');
			end if;
			 
			if (dt_prev_exec_w < clock_timestamp()) or (coalesce(dt_prev_exec_w::text, '') = '') then 
				ds_mensgaem_gerada_w := ds_mensgaem_gerada_w || '-> ' || wheb_mensagem_pck.get_texto(798800) || ' ' || ds_procedimento_w || ds_enter_w;
			end if;
			 
		 
		end loop;
	close c02;
	 
	begin 
	select	cd_perfil_exame_vencido 
	into STRICT	cd_perfil_w 
	from	tx_parametros;
	exception 
		when others then 
		cd_perfil_w	:= 0;
	end;			
	 
	if (cd_perfil_w > 0) and (ds_mensgaem_gerada_w IS NOT NULL AND ds_mensgaem_gerada_w::text <> '') then 
 
		insert into comunic_interna( 
			dt_comunicado, 
			ds_titulo, 
			ds_comunicado, 
			nm_usuario, 
			dt_atualizacao, 
			ie_geral, 
			nm_usuario_destino, 
			ds_perfil_adicional, 
			nr_sequencia, 
			ie_gerencial, 
			dt_liberacao, 
			cd_estab_destino 
		) values ( 
			clock_timestamp(), 
			wheb_mensagem_pck.get_texto(798797, 
					'CD_PESSOA_FISICA='||cd_pessoa_fisica_w|| 
					';NM_PESSOA_FISICA='||nm_pessoa_fisica_w), 
			wheb_mensagem_pck.get_texto(798799, 'NM_PESSOA_FISICA='||nm_pessoa_fisica_w) || ': ',		 
			nm_usuario_p, 
			clock_timestamp(), 
			'N', 
			'', 
			cd_perfil_w||', ', 
			nextval('comunic_interna_seq'), 
			'N', 
			clock_timestamp(), 
			null 
		);
	end if;
 
	end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tx_avisar_exame_imagem_venc (nm_usuario_p text) FROM PUBLIC;

