-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_senha_benef_web ( nr_seq_usuario_p bigint, ds_senha_p text, ds_senha_hash_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) AS $body$
DECLARE


ds_salt_w				pls_segurado_web.ds_tec%type;	
ds_senha_sha256_w		pls_segurado_web.ds_senha%type;			
qt_senha_diferente_w	bigint := 0;
					

BEGIN
	
if (nr_seq_usuario_p IS NOT NULL AND nr_seq_usuario_p::text <> '') then
	
	select 	replace(replace(dbms_random.string('P', 15), chr(39), ''), ';', '')
	into STRICT	ds_salt_w
	;
	
	ds_senha_sha256_w := obter_sha2(upper(ds_senha_p) || ds_salt_w, 256);

	update	pls_segurado_web
	set		ds_tec			= ds_salt_w,
			ds_senha     	= ds_senha_sha256_w,
			ds_hash	      	= ds_senha_hash_p,
			ie_origem_login = 'AB'	
	where	nr_sequencia 	= nr_seq_usuario_p;
	
	qt_senha_diferente_w := pls_gerencia_senha_web_pck.obter_regra_senha_diferente(cd_estabelecimento_p);
	
	if (qt_senha_diferente_w > 0) then
		CALL pls_gerencia_senha_web_pck.pls_controla_registros_usuario(ds_senha_sha256_w, ds_salt_w, nr_seq_usuario_p, 'B', qt_senha_diferente_w, nm_usuario_p, cd_estabelecimento_p);
	end if;	
	
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_senha_benef_web ( nr_seq_usuario_p bigint, ds_senha_p text, ds_senha_hash_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type) FROM PUBLIC;

