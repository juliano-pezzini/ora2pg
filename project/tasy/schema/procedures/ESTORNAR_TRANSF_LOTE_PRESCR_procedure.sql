-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE estornar_transf_lote_prescr ( nr_sequencia_p movimento_estoque.nr_movimento_estoque%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE



nr_sequencia_w		movimento_estoque.nr_movimento_estoque%type;
nr_seq_lote_w		ap_lote.nr_sequencia%type;
ie_status_lote_w	ap_lote.ie_status_lote%type;
nr_prescricao_w		prescr_medica.nr_prescricao%type;
ie_data_conta_lote_w	parametros_farmacia.ie_data_conta_lote%type;
nr_seq_material_w	prescr_material.nr_sequencia%type;
cd_material_w		material.cd_material%type;
nr_movimento_estoque_w	movimento_estoque.nr_movimento_estoque%type;
cd_operacao_entrada_w	operacao_estoque.cd_operacao_estoque%type;
cd_operacao_saida_w	operacao_estoque.cd_operacao_estoque%type;
cd_motivo_baixa_w	bigint;
dt_prescricao_w		timestamp;
dt_inicio_prescr_w	timestamp;
dt_horario_w		timestamp;


BEGIN

cd_motivo_baixa_w := Obter_Param_Usuario(7029, 54, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, cd_motivo_baixa_w);

select	max(nr_lote_ap),
	max(nr_sequencia_item_docto),
	max(cd_material),
	max(cd_operacao_estoque),
	max(nr_prescricao)
into STRICT	nr_seq_lote_w,
	nr_seq_material_w,
	cd_material_w,
	cd_operacao_saida_w,
	nr_prescricao_w
from	movimento_estoque
where	nr_movimento_estoque = nr_sequencia_p;

select 	max(ie_status_lote)
into STRICT	ie_status_lote_w
from 	ap_lote
where 	nr_sequencia = nr_seq_lote_w;

if (ie_status_lote_w not in ('A','G')) then
	-- (-20011, 'O Lote desse item já foi dispensado.' || '#@#@');
	CALL wheb_mensagem_pck.exibir_mensagem_abort(182587);
end if;

select	max(nr_movimento_estoque)
into STRICT	nr_movimento_estoque_w
from	movimento_estoque
where	nr_movimento_estoque <> nr_sequencia_p
and	cd_material = cd_material_w
and	nr_prescricao = nr_prescricao_w
and	nr_sequencia_item_docto = nr_seq_material_w
and	cd_acao = '1';

select	max(cd_operacao_estoque)
into STRICT	cd_operacao_entrada_w
from	movimento_estoque
where	nr_movimento_estoque = nr_movimento_estoque_w;

select 	max(dt_prescricao),
	max(dt_inicio_prescr)
into STRICT	dt_prescricao_w,
	dt_inicio_prescr_w
from 	prescr_medica
where 	nr_prescricao = nr_prescricao_w;

select	coalesce(max(ie_data_conta_lote), 'P')
into STRICT	ie_data_conta_lote_w
from	parametros_farmacia
where	cd_estabelecimento = cd_estabelecimento_p;

if (ie_data_conta_lote_w = 'A') then
	dt_prescricao_w := clock_timestamp();
elsif (ie_data_conta_lote_w = 'I') then
	dt_prescricao_w	:= dt_inicio_prescr_w;
elsif (ie_data_conta_lote_w = 'D') then
	select	max(dt_horario)
	into STRICT	dt_horario_w
	from	prescr_mat_hor
	where	nr_seq_material = nr_seq_material_w
	and	nr_seq_lote = nr_seq_lote_w;
	dt_prescricao_w	:= dt_horario_w;
end if;

/*Gerando movimento de estorno( SAÍDA )*/

select	nextval('movimento_estoque_seq')
into STRICT	nr_sequencia_w
;

insert into movimento_estoque(
 	nr_movimento_estoque,
 	cd_estabelecimento,
 	cd_local_estoque,
 	dt_movimento_estoque,
 	cd_operacao_estoque,
 	cd_acao,
 	cd_material,
 	dt_mesano_referencia,
 	qt_movimento,
 	dt_atualizacao,
 	nm_usuario,
 	ie_origem_documento,
 	nr_documento,
 	nr_sequencia_item_docto,
 	cd_unidade_medida_estoque,
 	cd_setor_atendimento,
 	qt_estoque,
	cd_centro_custo,
 	cd_unidade_med_mov,
	cd_fornecedor,
	ds_observacao,
	nr_seq_tab_orig,
	nr_seq_lote_fornec,
	cd_lote_fabricacao,
	dt_validade,
	nr_atendimento,
	nr_prescricao,
	nr_receita,
	cd_conta_contabil,
	nr_ordem_compra,
	nr_item_oci,
	nr_lote_ap,
	nr_lote_producao,
	nr_movimento_estoque_corresp)
SELECT	nr_sequencia_w,
 	cd_estabelecimento,
 	cd_local_estoque,
 	dt_prescricao_w,
 	cd_operacao_saida_w,
 	2,
 	cd_material,
 	dt_prescricao_w,
 	qt_movimento,
 	clock_timestamp(),
 	nm_usuario_p,
 	3,
 	nr_documento,
 	nr_sequencia_item_docto,
 	cd_unidade_medida_estoque,
 	cd_setor_atendimento,
 	qt_estoque,
	cd_centro_custo,
 	cd_unidade_med_mov,
	cd_fornecedor,
	wheb_mensagem_pck.get_Texto(313411), /*'Estorno do movimento de estoque',*/
	nr_seq_tab_orig,
	nr_seq_lote_fornec,
	cd_lote_fabricacao,
	dt_validade,
	nr_atendimento,
	nr_prescricao,
	nr_receita,
	cd_conta_contabil,
	nr_ordem_compra,
	nr_item_oci,
	nr_lote_ap,
	nr_lote_producao,
	nr_movimento_estoque_w
from	movimento_estoque
where	nr_movimento_estoque = nr_movimento_estoque_w;

/*Gerando movimento de estorno( ENTRADA )*/

select	nextval('movimento_estoque_seq')
into STRICT	nr_sequencia_w
;

insert into movimento_estoque(
 	nr_movimento_estoque,
 	cd_estabelecimento,
 	cd_local_estoque,
 	dt_movimento_estoque,
 	cd_operacao_estoque,
 	cd_acao,
 	cd_material,
 	dt_mesano_referencia,
 	qt_movimento,
 	dt_atualizacao,
 	nm_usuario,
 	ie_origem_documento,
 	nr_documento,
 	nr_sequencia_item_docto,
 	cd_unidade_medida_estoque,
 	cd_setor_atendimento,
 	qt_estoque,
	cd_centro_custo,
 	cd_unidade_med_mov,
	cd_fornecedor,
	ds_observacao,
	nr_seq_tab_orig,
	nr_seq_lote_fornec,
	cd_lote_fabricacao,
	dt_validade,
	nr_atendimento,
	nr_prescricao,
	nr_receita,
	cd_conta_contabil,
	nr_ordem_compra,
	nr_item_oci,
	nr_lote_ap,
	nr_lote_producao,
	nr_movimento_estoque_corresp)
SELECT	nr_sequencia_w,
 	cd_estabelecimento,
 	cd_local_estoque,
 	dt_prescricao_w,
 	cd_operacao_entrada_w,
 	2,
 	cd_material,
 	dt_prescricao_w,
 	qt_movimento,
 	clock_timestamp(),
 	nm_usuario_p,
 	3,
 	nr_documento,
 	nr_sequencia_item_docto,
 	cd_unidade_medida_estoque,
 	cd_setor_atendimento,
 	qt_estoque,
	cd_centro_custo,
 	cd_unidade_med_mov,
	cd_fornecedor,
	wheb_mensagem_pck.get_Texto(313411), /*'Estorno do movimento de estoque',*/
	nr_seq_tab_orig,
	nr_seq_lote_fornec,
	cd_lote_fabricacao,
	dt_validade,
	nr_atendimento,
	nr_prescricao,
	nr_receita,
	cd_conta_contabil,
	nr_ordem_compra,
	nr_item_oci,
	nr_lote_ap,
	nr_lote_producao,
	nr_sequencia_p
from	movimento_estoque
where	nr_movimento_estoque = nr_sequencia_p;

if (cd_motivo_baixa_w > 0) then
	update	prescr_mat_hor
	set	cd_motivo_baixa = 0
	where	nr_seq_lote = nr_seq_lote_w;
end if;

update	ap_lote
set	dt_atend_farmacia 	 = NULL,
	nm_usuario_atend 	 = NULL,
	ds_maquina_atend 	 = NULL,
	cd_perfil_atend		 = NULL,
	dt_inicio_dispensacao 	 = NULL,
	nm_usuario_ini_disp 	 = NULL,
	ds_maquina_ini_disp 	 = NULL,
	cd_perfil_ini_disp	 = NULL,
	ie_status_lote   	= 'G'
where 	nr_sequencia = nr_seq_lote_w;

CALL grava_log_ap_lote_hist(
	nr_seq_lote_w,
	wheb_mensagem_pck.get_Texto(313411), /*'Estorno do movimento de estoque',*/
	'Procedure: estornar_transf_lote_prescr(Atendimento do lote) ', nm_usuario_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE estornar_transf_lote_prescr ( nr_sequencia_p movimento_estoque.nr_movimento_estoque%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

