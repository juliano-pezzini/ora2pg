-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE germany_generate_report_ilara ( nr_atendimento_p text, dt_orig_p text, dt_trans_p text, dt_edit_p text, exam_name_p text, nr_laudo_p INOUT bigint) AS $body$
DECLARE


dt_inicio_w			timestamp;
dt_fim_w			timestamp;
nr_seq_item_w		wl_item.nr_sequencia%type;
qt_tempo_tarefa_w	tipo_evolucao.qt_tempo_tarefa%type;
nm_medico_w			varchar(255);
cd_medico_resp_w	atendimento_paciente.cd_medico_resp%type;
nr_laudo_w			laudo_paciente.nr_laudo%type;
nr_laudo_ww			laudo_paciente.nr_laudo%type;


BEGIN



SELECT	coalesce(MAX(nr_laudo),0) + 1
INTO STRICT	nr_laudo_w
FROM	laudo_paciente
WHERE	nr_atendimento = nr_atendimento_p;

SELECT 	MAX(SUBSTR(obter_nome_pf(cd_medico_resp),1,255)) nm_medico,
		MAX(cd_medico_resp)
INTO STRICT 	nm_medico_w,
		cd_medico_resp_w
FROM 	atendimento_paciente
WHERE 	nr_atendimento = nr_atendimento_p;

select	nextval('laudo_paciente_seq')
into STRICT	nr_laudo_ww
;

INSERT INTO laudo_paciente(nr_sequencia,
	nr_prescricao,
	nr_seq_prescricao,
	nr_seq_proc,
	nm_usuario_digitacao,
	nr_atendimento,
	nr_laudo,
	nm_usuario,
	dt_atualizacao,
	cd_medico_resp,
	qt_imagem,
	ds_titulo_laudo,
	ds_laudo,
	dt_laudo,
	dt_entrada_unidade,
	dt_liberacao,
	dt_exame,
	dt_aprovacao,
	nm_medico_solicitante)
VALUES (nr_laudo_ww,--store in a variable to use as out parameter
	NULL,
	NULL,
	NULL,
	'ILARA',
	nr_atendimento_p,
	nr_laudo_w,
	'ILARA',
	clock_timestamp(),
	cd_medico_resp_w,
	1,
	'iLara report',
	exam_name_p || ' '|| obter_desc_expressao(746911)||' ' || to_char(to_date(dt_edit_p, 'yyyymmddhh24miss'),'dd.MM.yyyy' ) || ' '||obter_desc_expressao(325811)||' ' || obter_nome_pf_atend(nr_atendimento_p),
	clock_timestamp(),
	clock_timestamp(),
	clock_timestamp(),
	clock_timestamp(),
	clock_timestamp(),
	nm_medico_w);

nr_laudo_p	:= nr_laudo_ww;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE germany_generate_report_ilara ( nr_atendimento_p text, dt_orig_p text, dt_trans_p text, dt_edit_p text, exam_name_p text, nr_laudo_p INOUT bigint) FROM PUBLIC;

