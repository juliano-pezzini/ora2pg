-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_regra_sae_prescr ( cd_perfil_p bigint, nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


dt_prescricao_w		timestamp;
qt_registro_w		bigint;
nr_seq_proc_w		bigint;
nr_atendimento_w	 bigint;
ie_liberar_w		varchar(10);
nr_seq_sae_w		bigint;
nr_seq_erro_w		bigint;
nr_seq_modelo_w		bigint;
cd_setor_pac_w		bigint;
nr_seq_item_w		bigint;
ds_justificativa_w	varchar(2000);
qt_caracteres_w		bigint;
nr_prescricao_w		numeric(20);
nr_seq_material_w	bigint;
cd_material_w		bigint;
C01 CURSOR FOR
	SELECT	a.cd_material,
		a.nr_prescricao,
		a.nr_sequencia,
		a.ds_justificativa
	from	Prescr_Material a,
		PE_PRESCR_PROC b
	where	b.nr_sequencia	= a.NR_SEQ_PE_PROC
	and	b.NR_SEQ_PRESCR	= nr_sequencia_p;



BEGIN

delete	FROM pe_prescricao_erro
where	nr_seq_prescr	= nr_sequencia_p
and	(nr_prescricao IS NOT NULL AND nr_prescricao::text <> '');



if (obter_se_consistir_regra_sae(4,cd_perfil_p)	<> 'X') then


	ie_liberar_w	:= obter_se_consistir_regra_sae(4,cd_perfil_p);


	select	coalesce(max(NR_CARACTER_SAE),0)
	into STRICT	qt_caracteres_w
	from	parametro_medico
	where	cd_estabelecimento	= wheb_usuario_pck.get_cd_estabelecimento;

	open C01;
	loop
	fetch C01 into
		cd_material_w,
		nr_prescricao_w,
		nr_seq_material_w,
		ds_justificativa_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		if (obter_se_material_padronizado(wheb_usuario_pck.get_cd_estabelecimento,cd_material_w)	= 'N') and (coalesce(length(ds_justificativa_w),0)	< qt_caracteres_w) and (qt_caracteres_w	> 0)then
			nr_seq_erro_w := gerar_erro_interv_sae(nr_sequencia_p, null, 4, ie_liberar_w, null, null, nm_usuario_p, nr_seq_erro_w, null, null, nr_prescricao_w, nr_seq_material_w);
		end if;

		end;
	end loop;
	close C01;



end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_regra_sae_prescr ( cd_perfil_p bigint, nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

