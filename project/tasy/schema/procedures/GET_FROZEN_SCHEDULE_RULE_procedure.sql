-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE get_frozen_schedule_rule ( ie_frozen_status_p INOUT text, ie_user_allowed_p INOUT text, ie_freeze_enabled_p INOUT text, ie_freeze_process_enable_p INOUT text) AS $body$
DECLARE


ie_user_allowed_w	varchar(4000);
ie_frozen_status_w 	varchar(4000);
ie_freeze_enabled_w	varchar(1);
ie_user_allowed_aux_w	varchar(1);
ie_freeze_process_enable_w varchar(1);

statuses CURSOR FOR
SELECT 	*
from 	regra_agenda_fechada;

BEGIN

select coalesce(obter_regra_popup(1075217, 'E', 'V'), 'N')
into STRICT ie_freeze_enabled_w
;

for status in statuses loop

	select 	coalesce(max('S'), 'N')
	into STRICT 	ie_user_allowed_aux_w
	from 	regra_agenda_fechada_lib
	where 	nr_seq_regra = status.nr_sequencia
	and 	wheb_usuario_pck.get_nm_usuario	= coalesce(nm_usuario_regra, wheb_usuario_pck.get_nm_usuario)
	and 	wheb_usuario_pck.get_cd_perfil	= coalesce(cd_perfil, wheb_usuario_pck.get_cd_perfil)
	and ((nm_usuario_regra IS NOT NULL AND nm_usuario_regra::text <> '') or (cd_perfil IS NOT NULL AND cd_perfil::text <> ''));

	if (coalesce(ie_user_allowed_w::text, '') = '') then
		ie_user_allowed_w := status.ie_status_agenda || '-' || ie_user_allowed_aux_w;
	else
		ie_user_allowed_w := ie_user_allowed_w || ';' || status.ie_status_agenda || '-' || ie_user_allowed_aux_w;
	end if;
	
	if (coalesce(ie_frozen_status_w::text, '') = '') then
		ie_frozen_status_w := status.ie_status_agenda;
	else
		ie_frozen_status_w := ie_frozen_status_w || ',' || status.ie_status_agenda;
	end if;
end loop;

select	coalesce(max('S'), 'N')
into STRICT	ie_freeze_process_enable_w
from	funcao_popup_regra
where	nr_seq_objeto = 1075217
and		ie_tipo_regra = 'E'
and   	ie_visible = 'S'
and 	coalesce(ie_enable, 'S') = 'S';

if ( ie_freeze_enabled_w = 'S') then

	select coalesce(max('S'), 'N')
	into STRICT ie_freeze_enabled_w
	from regra_agenda_fechada;

end if;

ie_frozen_status_p	:= ie_frozen_status_w;
ie_user_allowed_p	:= ie_user_allowed_w;
ie_freeze_enabled_p	:= ie_freeze_enabled_w;
ie_freeze_process_enable_p := ie_freeze_process_enable_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE get_frozen_schedule_rule ( ie_frozen_status_p INOUT text, ie_user_allowed_p INOUT text, ie_freeze_enabled_p INOUT text, ie_freeze_process_enable_p INOUT text) FROM PUBLIC;

