-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_fechar_controle_op_aberto ( nr_seq_operador_p bigint, ds_horas_p text, nr_seq_motivo_p bigint, nm_usuario_p text) AS $body$
DECLARE


dt_entrada_w			timestamp;
dt_saida_w			timestamp;
nr_seq_ausencia_w		bigint;



BEGIN

select	dt_entrada
into STRICT	dt_entrada_w
from	pls_operador_controle
where	nr_sequencia = (SELECT	max(nr_sequencia)
			from	pls_operador_controle
			where	nr_seq_operador = nr_seq_operador_p);

dt_saida_w := to_date(to_char(dt_entrada_w,'dd/mm/yyyy')||' '||ds_horas_p||':00','dd/mm/yyyy hh24:mi:ss');

if (nr_seq_motivo_p IS NOT NULL AND nr_seq_motivo_p::text <> '') then

	select	nextval('pls_atendimento_ausencia_seq')
	into STRICT	nr_seq_ausencia_w
	;

	insert	into pls_atendimento_ausencia(nr_sequencia, nr_seq_motivo, dt_inicio,
		dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
		nm_usuario_nrec, nr_seq_operador,
		cd_estabelecimento)
	values (nr_seq_ausencia_w, nr_seq_motivo_p, dt_saida_w,
		clock_timestamp(),nm_usuario_p, clock_timestamp(),
		nm_usuario_p,nr_seq_operador_p,
		wheb_usuario_pck.get_cd_estabelecimento);
end if;

update	pls_operador_controle
set	dt_saida		= dt_saida_w,
	dt_atualizacao		= clock_timestamp(),
	nm_usuario		= nm_usuario_p,
	ie_pausa_central 	= 'N',
	nr_seq_ausencia		= nr_seq_ausencia_w
where	nr_sequencia 		= (	SELECT	max(nr_sequencia)
					from	pls_operador_controle
					where	nr_seq_operador = nr_seq_operador_p
					and	coalesce(dt_saida::text, '') = '');

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_fechar_controle_op_aberto ( nr_seq_operador_p bigint, ds_horas_p text, nr_seq_motivo_p bigint, nm_usuario_p text) FROM PUBLIC;

