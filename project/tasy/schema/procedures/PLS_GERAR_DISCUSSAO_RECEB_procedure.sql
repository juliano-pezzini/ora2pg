-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_discussao_receb ( nr_seq_lote_contest_p bigint, nr_seq_lote_discussao_p INOUT bigint, nm_usuario_p text) AS $body$
DECLARE


ie_tipo_w			varchar(1);
nr_seq_lote_discussao_w		bigint;
nr_seq_contestacao_w		bigint;
nr_seq_discussao_w		bigint;
nr_seq_itens_w			bigint;
nr_seq_conta_proc_w		bigint;
nr_seq_conta_mat_w		bigint;
qt_contestada_w			double precision;
vl_contestado_w			double precision;
vl_material_w			double precision;
vl_atual_w			double precision;
vl_conta_contest_w		double precision;
ie_primeira_discussao_w		varchar(1) := 'N';
ie_envio_recebimento_w		varchar(1);
qt_registros_w			bigint := 0;
nr_nota_credito_debito_w	varchar(30);
nr_seq_fatura_conta_w		bigint;
nr_seq_fatura_proc_w		bigint;
nr_seq_fatura_mat_w		bigint;
vl_ndc_w			double precision:= 0;
qt_ndc_w			double precision:= 0;
vl_reconh_orig_w		double precision:= 0;
qt_reconh_orig_w		double precision:= 0;
qt_reg_camara_contest_w		bigint;
vl_apresentado_w		double precision:= 0;
qt_apresentado_w		double precision;

C01 CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_fatura_conta,
		vl_original
	from	pls_contestacao
	where	nr_seq_lote = nr_seq_lote_contest_p
	order by nr_sequencia;

C02 CURSOR FOR
	SELECT	'P' ie_tipo,
		a.nr_sequencia,
		a.nr_seq_fatura_proc,
		null
	from	pls_contestacao_proc a
	where	a.nr_seq_contestacao	= nr_seq_contestacao_w
	
union

	SELECT	'M' ie_tipo,
		b.nr_sequencia,
		null,
		b.nr_seq_fatura_mat
	from	pls_contestacao_mat b
	where	b.nr_seq_contestacao	= nr_seq_contestacao_w
	order by 1;


BEGIN
select	max(ie_envio_recebimento),
	max(nr_nota_credito_debito)
into STRICT	ie_envio_recebimento_w,
	nr_nota_credito_debito_w
from	pls_lote_contestacao
where	nr_sequencia = nr_seq_lote_contest_p;

select	count(1)
into STRICT	qt_registros_w
from	pls_lote_discussao
where	nr_seq_lote_contest = nr_seq_lote_contest_p;

select	count(1)
into STRICT	qt_reg_camara_contest_w
from	ptu_camara_contestacao
where	nr_seq_lote_contest = nr_seq_lote_contest_p;

if (qt_registros_w = 0) and (ie_envio_recebimento_w = 'R') then
	ie_primeira_discussao_w	:= 'S';
else
	ie_primeira_discussao_w	:= 'N';
end if;

select	nextval('pls_lote_discussao_seq')
into STRICT	nr_seq_lote_discussao_w
;

insert into pls_lote_discussao(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_seq_lote_contest,
	dt_referencia,
	ie_status,
	dt_fechamento,
	nr_seq_lote_conta,
	nr_lote_contabil,
	ie_primeira_discussao,
	nr_nota_credito_debito)
values (nr_seq_lote_discussao_w,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_lote_contest_p,
	clock_timestamp(),
	'A',
	null,
	null,
	0,
	ie_primeira_discussao_w,
	nr_nota_credito_debito_w);

open C01;
loop
fetch C01 into
	nr_seq_contestacao_w,
	nr_seq_fatura_conta_w,
	vl_conta_contest_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	select	nextval('pls_contestacao_discussao_seq')
	into STRICT	nr_seq_discussao_w
	;

	insert into pls_contestacao_discussao(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_contestacao,
		ie_status,
		vl_recurso,
		vl_negado,
		vl_aceito,
		nr_seq_lote,
		nr_seq_analise,
		nr_seq_fatura_conta)
	values (	nr_seq_discussao_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_contestacao_w,
		'A',
		vl_conta_contest_w,
		0,
		0,
		nr_seq_lote_discussao_w,
		null,
		nr_seq_fatura_conta_w);

	open C02;
	loop
	fetch C02 into
		ie_tipo_w,
		nr_seq_itens_w,
		nr_seq_fatura_proc_w,
		nr_seq_fatura_mat_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		if (ie_tipo_w = 'P') then
			select	nr_seq_conta_proc,
				coalesce(qt_contestada,0),
				coalesce(vl_contestado,0),
				coalesce(vl_procedimento,0),
				coalesce(qt_procedimento,0)
			into STRICT	nr_seq_conta_proc_w,
				qt_contestada_w,
				vl_contestado_w,
				vl_apresentado_w,
				qt_apresentado_w
			from	pls_contestacao_proc
			where	nr_seq_contestacao	= nr_seq_contestacao_w
			and	nr_sequencia		= nr_seq_itens_w;

			if (qt_reg_camara_contest_w > 0) then
				vl_apresentado_w := vl_contestado_w;
				qt_apresentado_w := qt_contestada_w;
			end if;

			insert into pls_discussao_proc(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_discussao,
				qt_recurso,
				vl_recurso,
				qt_negada,
				vl_negado,
				nr_seq_conta_proc,
				qt_contestada,
				vl_contestado,
				qt_aceita,
				vl_aceito,
				nr_seq_motivo_glosa_aceita,
				nr_seq_motivo_glosa_neg,
				nr_lote_contabil,
				nr_seq_fatura_proc,
				vl_ndc,
				qt_ndc,
				vl_reconh_orig,
				qt_reconh_orig,
				nr_seq_contestacao_proc)
			values (nextval('pls_discussao_proc_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_discussao_w,
				qt_apresentado_w,
				vl_apresentado_w,
				0,
				0,
				nr_seq_conta_proc_w,
				qt_contestada_w,
				vl_contestado_w,
				0,
				0,
				null,
				null,
				0,
				nr_seq_fatura_proc_w,
				vl_ndc_w,
				qt_ndc_w,
				vl_reconh_orig_w,
				qt_reconh_orig_w,
				nr_seq_itens_w);
		end if;

		if (ie_tipo_w = 'M') then
			select	nr_seq_conta_mat,
				coalesce(qt_contestada,0),
				coalesce(vl_contestado,0),
				coalesce(vl_material,0),
				coalesce(vl_atual,0),
				coalesce(vl_material,0),
				coalesce(qt_material,0)
			into STRICT	nr_seq_conta_mat_w,
				qt_contestada_w,
				vl_contestado_w,
				vl_material_w,
				vl_atual_w,
				vl_apresentado_w,
				qt_apresentado_w
			from	pls_contestacao_mat
			where	nr_seq_contestacao 	= nr_seq_contestacao_w
			and	nr_sequencia		= nr_seq_itens_w;

			if (qt_reg_camara_contest_w > 0) then
				vl_apresentado_w := vl_contestado_w;
				qt_apresentado_w := qt_contestada_w;
			end if;

			insert into pls_discussao_mat(nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_discussao,
				qt_recurso,
				vl_recurso,
				qt_negada,
				vl_negado,
				nr_seq_conta_mat,
				qt_contestada,
				vl_contestado,
				qt_aceita,
				vl_aceito,
				nr_seq_motivo_glosa_aceita,
				nr_seq_motivo_glosa_neg,
				vl_original,
				vl_material,
				vl_atual,
				nr_lote_contabil,
				nr_seq_fatura_mat,
				vl_ndc,
				qt_ndc,
				vl_reconh_orig,
				qt_reconh_orig,
				nr_seq_contestacao_mat)
			values (nextval('pls_discussao_mat_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_discussao_w,
				qt_apresentado_w,
				vl_apresentado_w,
				0,
				0,
				nr_seq_conta_mat_w,
				qt_contestada_w,
				vl_contestado_w,
				0,
				0,
				null,
				null,
				vl_material_w,
				vl_material_w,
				vl_atual_w,
				0,
				nr_seq_fatura_mat_w,
				vl_ndc_w,
				qt_ndc_w,
				vl_reconh_orig_w,
				qt_reconh_orig_w,
				nr_seq_itens_w);
		end if;

		end;
	end loop;
	close C02;

	end;
end loop;
close C01;

nr_seq_lote_discussao_p := nr_seq_lote_discussao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_discussao_receb ( nr_seq_lote_contest_p bigint, nr_seq_lote_discussao_p INOUT bigint, nm_usuario_p text) FROM PUBLIC;

