-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_dose_esp_dieta ( nr_prescricao_p bigint, cd_perfil_p bigint, nm_usuario_p text) AS $body$
DECLARE

			 
hr_dose_jejum_w			timestamp;


BEGIN 
 
select	max(a.dt_fim + 1/1440) 
into STRICT	hr_dose_jejum_w 
from 	rep_jejum a, 
	prescr_medica b 
where 	a.nr_prescricao = b.nr_prescricao 
and	a.nr_prescricao	= nr_prescricao_p 
and	coalesce(b.dt_suspensao::text, '') = '' 
and  	dt_fim > clock_timestamp();
 
if (hr_dose_jejum_w IS NOT NULL AND hr_dose_jejum_w::text <> '') then 
	 
	update	prescr_dieta 
	set	hr_dose_especial	= to_char(hr_dose_jejum_w,'hh24:mi') 
	where	nr_prescricao		= nr_prescricao_p 
	and	(hr_dose_especial IS NOT NULL AND hr_dose_especial::text <> '');
	 
	update	prescr_material 
	set	hr_dose_especial	= to_char(hr_dose_jejum_w,'hh24:mi') 
	where	nr_prescricao		= nr_prescricao_p 
	and	ie_agrupador in (8,12) 
	and	(hr_dose_especial IS NOT NULL AND hr_dose_especial::text <> '');
	 
	commit;
	 
	CALL Gerar_prescr_hor_sem_lib(nr_prescricao_p, null, cd_perfil_p, 'N', nm_usuario_p);
	CALL gerar_prescr_dieta_hor_sem_lib(nr_prescricao_p, null, cd_perfil_p, 'N', null,'N',nm_usuario_p);
end if;	
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_dose_esp_dieta ( nr_prescricao_p bigint, cd_perfil_p bigint, nm_usuario_p text) FROM PUBLIC;

