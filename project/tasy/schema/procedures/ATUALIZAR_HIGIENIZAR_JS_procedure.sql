-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_higienizar_js ( ie_tipo_p bigint, cd_setor_atual_p text, cd_unidade_basica_p text, cd_unidade_compl_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_executar_commit_p text default 'S') AS $body$
DECLARE


ie_hig_se_setor_sem_acomod_w	varchar(1);
ie_hig_setor_sem_acomod_w	varchar(1);
ie_aguard_higienizar_transf_w	varchar(1);
ie_considera_estr_atend_w	varchar(1);
ie_considerar_hig_estr_w	varchar(1);
ie_exige_senha_transf_alta_w	varchar(1);
ie_inativa_leito_w		varchar(1);
ie_ativa_leito_agrup_w	varchar(1);
ie_continua_processo_w	varchar(1)	:= 'S';
ds_sql_w			varchar(4000);
ie_sem_acomod_w		varchar(1);
ie_higieniza_leito_w		varchar(1);
nm_usuario_higienizacao_w	varchar(100);
ie_status_unidade_w		varchar(100);
dt_inicio_w		varchar(100);
dt_fim_w			varchar(100);
ds_sep_bv_w		varchar(50);
ie_unid_bloq_w	varchar(1);


BEGIN

ds_sep_bv_w	:= obter_separador_bv;

nm_usuario_higienizacao_w	:= ', nm_usuario_higienizacao = :nm_usuario_p ';

IF (ie_tipo_p = 10)THEN
	BEGIN
	ie_status_unidade_w	:= 'H';
	dt_inicio_w		:= ', dt_inicio_higienizacao = sysdate ';
	dt_fim_w		:= ', dt_higienizacao = null ';
	END;
ELSIF (ie_tipo_p = 9)THEN
	BEGIN
	ie_status_unidade_w	:= 'A';
	dt_inicio_w		:= ', dt_inicio_higienizacao = null ';
	dt_fim_w		:= ', dt_higienizacao = null ';
	END;
ELSIF (ie_tipo_p = 8)THEN
	BEGIN
	ie_status_unidade_w	:= 'G';
	dt_inicio_w		:= ', dt_inicio_higienizacao = null ';
	dt_fim_w		:= ', dt_higienizacao = null ';
	END;
ELSE
	BEGIN
	ie_status_unidade_w		:= 'L';
	nm_usuario_higienizacao_w	:= ', nm_usuario_fim_higienizacao = :nm_usuario_p ';
	dt_inicio_w			:= '';
	dt_fim_w			:= ', dt_higienizacao = sysdate ';
	END;
END IF;

/* Se a opção Bloquear unidade anterior(IE_BLOQ_UNID_ANT) estiver marcada, quando o paciente for transferido do leito para outro
	ele deverá ser bloqueado e não poderá entrar em higienização.*/
SELECT	CASE WHEN COUNT(nr_seq_unid_bloq)=0 THEN 'S'  ELSE 'N' END
INTO STRICT	ie_unid_bloq_w
FROM 	unidade_atendimento
WHERE	cd_unidade_basica		= cd_unidade_basica_p
AND		cd_unidade_compl		= cd_unidade_compl_p
AND		cd_setor_atendimento	= cd_setor_atual_p;

IF (cd_setor_atual_p IS NOT NULL AND cd_setor_atual_p::text <> '') AND (cd_setor_atual_p > '0') AND
	((ie_unid_bloq_w = 'S') or (ie_status_unidade_w = 'L')) THEN
	BEGIN
	ds_sql_w	:=
		' update	unidade_atendimento ' ||
		' set		ie_status_unidade = :ie_status_unidade' ||
		nm_usuario_higienizacao_w || dt_inicio_w || dt_fim_w ||
		', 		nm_usuario	  = :nm_usuario_p '||
		', 		dt_atualizacao	  = sysdate ' ||
		' where cd_unidade_basica	= :cd_unidade_basica_p '||
		' and 	cd_unidade_compl	= :cd_unidade_compl_p '||
		' and 	cd_setor_atendimento	= :cd_setor_atual_p'||
		' and 	ie_status_unidade	<> ''P'' ';


	CALL exec_sql_dinamico_bv('PROCEDURE_25328', ds_sql_w, 'ie_status_unidade=' || ie_status_unidade_w || ds_sep_bv_w ||
							  'nm_usuario_p=' || nm_usuario_p || ds_sep_bv_w ||
							  'cd_unidade_basica_p=' || cd_unidade_basica_p || ds_sep_bv_w ||
							  'cd_unidade_compl_p=' || cd_unidade_compl_p || ds_sep_bv_w ||
							  'cd_setor_atual_p=' || cd_setor_atual_p || ds_sep_bv_w);
	if (coalesce(ie_executar_commit_p,'S') = 'S') then
		if (coalesce(wheb_usuario_pck.get_ie_commit, 's') = 's') then commit; end if;
	end if;
	END;
END IF;

IF (ie_tipo_p = 11)THEN
	BEGIN
	/* Movimentação de Pacientes - Parâmetro [122] - Inativar leito temporário ao terminar a higienização */

	ie_inativa_leito_w := obter_param_usuario(3111, 122, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_inativa_leito_w);

	IF (ie_inativa_leito_w = 'S')THEN
		CALL desativa_unidade_temp(cd_setor_atual_p, cd_unidade_basica_p, cd_unidade_compl_p, nm_usuario_p);
	END IF;

	/* Movimentação de Pacientes - Parâmetro [123] - Ao finalizar a higienização do leito temporário e inativá-lo automaticamente, ativar os leitos do agrupamento */

	ie_ativa_leito_agrup_w := obter_param_usuario(3111, 123, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_ativa_leito_agrup_w);

	IF (ie_ativa_leito_agrup_w = 'S')THEN
		CALL ativar_leitos_agrupamento(cd_setor_atual_p, cd_unidade_basica_p, cd_unidade_compl_p, nm_usuario_p);
	END IF;
	END;
END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_higienizar_js ( ie_tipo_p bigint, cd_setor_atual_p text, cd_unidade_basica_p text, cd_unidade_compl_p text, nm_usuario_p text, cd_estabelecimento_p bigint, ie_executar_commit_p text default 'S') FROM PUBLIC;

