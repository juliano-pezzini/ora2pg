-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_hist_proc_odontologia (nr_atendimento_p bigint, nr_seq_consulta_p bigint, nr_seq_local_p text, nr_seq_dente_p text, nr_seq_face_p text, ie_raiz_p text, nr_seq_sextante_p text, nr_seq_arcada_p text, nr_seq_tratamento_p text, ie_status_area_hist_p text, ds_obs_hist_p text, nr_seq_proc_int_evol_p bigint, qt_procedimento_evol_p bigint, cd_profissional_evol_p text, cd_especialidade_evol_p bigint, ds_obs_evol_p text, nr_seq_atend_cons_pepa_p bigint, nr_seq_proc_out_p INOUT bigint, nr_seq_faces_p text default null, nr_seq_historico_p INOUT bigint  DEFAULT NULL) AS $body$
DECLARE

							
ds_titulo_w		varchar(80);
cd_pessoa_fisica_w	varchar(10);
nr_seq_faces_w		varchar(255);
nr_seq_odontHist_w 	odont_historico.nr_sequencia%type;
nr_seq_proc_w		odont_procedimento.nr_sequencia%type;


BEGIN

	if (nr_seq_consulta_p IS NOT NULL AND nr_seq_consulta_p::text <> '' AND nr_seq_local_p IS NOT NULL AND nr_seq_local_p::text <> '') then

		select	substr(obter_descricao_dominio(8753,nr_seq_local_p),0,80),
				obter_pessoa_atendimento(nr_atendimento_p,'C')
		into STRICT	ds_titulo_w,
				cd_pessoa_fisica_w
		;		

        select nextval('odont_historico_seq')
        into STRICT nr_seq_odontHist_w
;
		nr_seq_historico_p := nr_seq_odontHist_w;
		insert	into odont_historico(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_titulo,
				nr_atendimento,
				ie_tipo,
				dt_historico,
				cd_pessoa_fisica,
				nr_seq_consulta,
				nr_seq_local,
				nr_seq_dente,
				nr_seq_sextante,
				nr_seq_arcada,
				nr_seq_tratamento,
				ie_status_area,
				nr_seq_face,
				ie_raiz,
				ie_protese_total_sup,
				ie_protese_total_inf,
				ds_observacao,
				ds_historico
				) values (
				nr_seq_odontHist_w,
				clock_timestamp(),
				wheb_usuario_pck.get_nm_usuario(),
				clock_timestamp(),
				wheb_usuario_pck.get_nm_usuario(),
				ds_titulo_w,
				nr_atendimento_p,
				'U',
				clock_timestamp(),
				cd_pessoa_fisica_w,
				nr_seq_consulta_p,
				nr_seq_local_p,
				nr_seq_dente_p,
				nr_seq_sextante_p,
				nr_seq_arcada_p,
				nr_seq_tratamento_p,
				ie_status_area_hist_p,
				nr_seq_face_p,
				ie_raiz_p,
				null,
				null,
				ds_obs_hist_p,
				' ');

		nr_seq_faces_w := nr_seq_faces_p;


		if ( (nr_seq_proc_int_evol_p IS NOT NULL AND nr_seq_proc_int_evol_p::text <> '') and
				(qt_procedimento_evol_p IS NOT NULL AND qt_procedimento_evol_p::text <> '') and 
				(cd_profissional_evol_p IS NOT NULL AND cd_profissional_evol_p::text <> '') ) then

			select	nextval('odont_procedimento_seq')
			into STRICT	nr_seq_proc_w
			;

			insert into odont_procedimento(
					nr_sequencia,
					cd_estabelecimento, 
					dt_atualizacao, 
					nm_usuario, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec, 
					qt_procedimento, 
					cd_especialidade, 
					nr_seq_proc_interno, 
					ie_status, 
					cd_profissional, 
					dt_procedimento, 
					nr_atendimento, 
					cd_pessoa_fisica, 
					nr_seq_consulta, 
					nr_seq_local, 
					nr_seq_dente, 
					nr_seq_sextante, 
					nr_seq_arcada, 
					nr_seq_tratamento, 
					nr_seq_face, 
					ie_raiz,
					ds_observacao,
					nr_seq_atend_cons_pepa
					) values (
					nr_seq_proc_w,
					wheb_usuario_pck.get_cd_estabelecimento(),
					clock_timestamp(),
					wheb_usuario_pck.get_nm_usuario(),
					clock_timestamp(),
					wheb_usuario_pck.get_nm_usuario(),
					qt_procedimento_evol_p,
					cd_especialidade_evol_p,
					nr_seq_proc_int_evol_p,
					'P',
					cd_profissional_evol_p,
					clock_timestamp(),
					nr_atendimento_p,
					cd_pessoa_fisica_w,
					nr_seq_consulta_p,
					nr_seq_local_p,
					nr_seq_dente_p,
					nr_seq_sextante_p,
					nr_seq_arcada_p,
					nr_seq_tratamento_p,
					nr_seq_face_p,
					ie_raiz_p,
					ds_obs_evol_p,
					nr_seq_atend_cons_pepa_p
					);

			nr_seq_proc_out_p := nr_seq_proc_w;

		end if;

		commit;

	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_hist_proc_odontologia (nr_atendimento_p bigint, nr_seq_consulta_p bigint, nr_seq_local_p text, nr_seq_dente_p text, nr_seq_face_p text, ie_raiz_p text, nr_seq_sextante_p text, nr_seq_arcada_p text, nr_seq_tratamento_p text, ie_status_area_hist_p text, ds_obs_hist_p text, nr_seq_proc_int_evol_p bigint, qt_procedimento_evol_p bigint, cd_profissional_evol_p text, cd_especialidade_evol_p bigint, ds_obs_evol_p text, nr_seq_atend_cons_pepa_p bigint, nr_seq_proc_out_p INOUT bigint, nr_seq_faces_p text default null, nr_seq_historico_p INOUT bigint  DEFAULT NULL) FROM PUBLIC;

