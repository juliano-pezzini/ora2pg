-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_calc_graf_cirur_ocor (nr_seq_cirur_agente_p bigint, nr_etapas_p INOUT bigint, ds_dose_diferenciada_p INOUT text, ds_horarios_p INOUT text, qt_dose_total_p INOUT bigint, qt_tempo_total_p INOUT bigint) AS $body$
DECLARE


qt_dose_w 	double precision;

c01 CURSOR FOR
SELECT	b.*, CASE WHEN a.ie_modo_adm='CO' THEN  'N'  ELSE 'S' END  ie_medicamento
from 	cirurgia_agente_anestesico a,
	cirurgia_agente_anest_ocor b
where	a.nr_sequencia = nr_seq_cirur_agente_p
and	a.nr_sequencia = b.nr_seq_cirur_agente
order by b.dt_inicio_adm;

BEGIN

for c01_w in c01 loop

	if (c01_w.ie_medicamento = 'S') then
		qt_dose_w := coalesce(c01_w.qt_dose, coalesce(c01_w.qt_dose_total, coalesce(c01_w.qt_utilizada, c01_w.qt_dose_ataque)));

		if (coalesce(ds_dose_diferenciada_p::text, '') = '') then
			ds_dose_diferenciada_p := substr(coalesce(qt_dose_w, 0),1,50);
		else
			ds_dose_diferenciada_p := substr(ds_dose_diferenciada_p || '-' ||coalesce(qt_dose_w, 0),1,50);
		end if;
		qt_dose_total_p := coalesce(qt_dose_total_p, 0 ) + qt_dose_w;
	else
		 if (c01_w.dt_final_adm IS NOT NULL AND c01_w.dt_final_adm::text <> '') then
			if (c01_w.ie_modo_registro = 'V') then
				qt_tempo_total_p :=  round(coalesce(qt_tempo_total_p,0) + ((c01_w.dt_final_adm - c01_w.dt_inicio_adm) * 1440) / 60, 3);
			else
				qt_dose_w := coalesce(c01_w.qt_utilizada, c01_w.qt_dose_ataque);
				
				if (coalesce(ds_dose_diferenciada_p::text, '') = '') then
					ds_dose_diferenciada_p := substr(coalesce(qt_dose_w, 0),1,50);
				else
					ds_dose_diferenciada_p := substr(ds_dose_diferenciada_p || '-' ||coalesce(qt_dose_w, 0),1,50);
				end if;
			
				qt_dose_total_p := coalesce(qt_dose_total_p, 0) + qt_dose_w;
			end if;
		end if;		
	end if;

	ds_horarios_p := substr(ds_horarios_p || to_char(c01_w.dt_inicio_adm,'hh24:mi') || ' ',1,200);
	nr_etapas_p := coalesce(nr_etapas_p, 0) + 1;
end loop;


ds_horarios_p := replace(padroniza_horario_prescr(ds_horarios_p,null),'A','');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_calc_graf_cirur_ocor (nr_seq_cirur_agente_p bigint, nr_etapas_p INOUT bigint, ds_dose_diferenciada_p INOUT text, ds_horarios_p INOUT text, qt_dose_total_p INOUT bigint, qt_tempo_total_p INOUT bigint) FROM PUBLIC;

