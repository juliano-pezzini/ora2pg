-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_valoror_insulina ( qt_diferencao_p bigint, nr_prescricao_p bigint, nr_seq_procedimento_p bigint, nr_sequencia_p bigint) AS $body$
DECLARE


nr_sequencia_w			bigint;
qt_antigo_ui_insulina_w	double precision;
qt_novo_ui_insulina_w	double precision;
nr_seq_inical_w			bigint;

c01 CURSOR FOR
SELECT	nr_sequencia,
		qt_ui_insulina
from 	prescr_proc_glic
where 	nr_prescricao = nr_prescricao_p
and 	nr_seq_procedimento = nr_seq_procedimento_p
and		nr_sequencia <> nr_seq_inical_w;



BEGIN

SELECT  max(nr_sequencia)
into STRICT	nr_seq_inical_w
FROM    prescr_proc_glic
where   nr_prescricao = nr_prescricao_p
and     nr_seq_procedimento = nr_seq_procedimento_p
and     qt_glic_inic = (  SELECT MIN(qt_glic_inic)
                          FROM prescr_proc_glic
                          where   nr_prescricao = nr_prescricao_p
                          and     nr_seq_procedimento = nr_seq_procedimento_p);

if (nr_sequencia_p = nr_seq_inical_w) then
	open c01;
	loop
	fetch c01 into
		nr_sequencia_w,
		qt_antigo_ui_insulina_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		qt_novo_ui_insulina_w := (qt_antigo_ui_insulina_w + qt_diferencao_p);

		if (qt_novo_ui_insulina_w < 0) then
			qt_novo_ui_insulina_w := 0;
		end if;

		update	prescr_proc_glic
		set		QT_UI_INSULINA 	= qt_novo_ui_insulina_w
		where 	nr_prescricao = nr_prescricao_p
		and 	nr_seq_procedimento = nr_seq_procedimento_p
		and		nr_sequencia = nr_sequencia_w;


		end;
	end loop;
	close c01;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_valoror_insulina ( qt_diferencao_p bigint, nr_prescricao_p bigint, nr_seq_procedimento_p bigint, nr_sequencia_p bigint) FROM PUBLIC;

