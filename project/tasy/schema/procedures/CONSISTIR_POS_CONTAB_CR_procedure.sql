-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_pos_contab_cr (cd_estabelecimento_p bigint, nm_usuario_p text, ie_opcao_p text, dt_inicial_p timestamp, dt_final_p timestamp, ie_cancelados_p text, ie_desdobrados_p text, ie_alteracao_p text, cd_conta_financ_p text) AS $body$
DECLARE

 
dt_referencia_w		timestamp;
vl_saldo_anterior_w	double precision;
vl_entradas_w		double precision;
vl_baixas_w		double precision;
vl_descontos_w		double precision;
vl_glosa_w		double precision;
vl_alterado_w		double precision;
vl_saldo_final_w	double precision;
vl_saldo_calc_w		double precision;
vl_diferenca_w		double precision;
ds_lista_conta_financ_w	varchar(4000);


BEGIN 
 
ds_lista_conta_financ_w	:= ' ' || replace(replace(replace(cd_conta_financ_p,'(',''),')',''),',',' ') || ' ';
 
delete	from w_posicao_contabil_cr 
where	nm_usuario	= nm_usuario_p;
 
dt_referencia_w	:= trunc(dt_inicial_p,'dd');
 
if (ie_opcao_p	= 'A') then 
 
	while(dt_referencia_w <= dt_final_p) loop 
		 
		select	coalesce(sum(obter_saldo_titulo_receber(a.nr_titulo,fim_dia(trunc(dt_referencia_w,'dd') - 1))),0) vl_saldo 
		into STRICT	vl_saldo_anterior_w 
		from 	titulo_receber a 
		where (a.cd_estabelecimento 	= cd_estabelecimento_p or 
			 a.cd_estab_financeiro 	= cd_estabelecimento_p) 
		and (a.ie_situacao 		<> '3' or ie_cancelados_p = 'S') 
		and (a.ie_situacao 		<> '5' or ie_desdobrados_p = 'S') 
		and	coalesce(a.dt_liquidacao, clock_timestamp() + interval '1000 days') >= fim_dia(trunc(dt_referencia_w,'dd') - 1) 
		and	a.dt_contabil 		<= fim_dia(trunc(dt_referencia_w,'dd') - 1) 
		and (coalesce(a.dt_liquidacao::text, '') = '' or 
			a.dt_liquidacao 	> fim_dia(trunc(dt_referencia_w,'dd') - 1)) 
		and	dt_emissao		< fim_dia(trunc(dt_referencia_w,'dd') - 1) 
		and	((coalesce(cd_conta_financ_p::text, '') = '') or (exists (SELECT	1 
								from	titulo_receber_classif x 
								where	x.nr_titulo	= a.nr_titulo 
								and	ds_lista_conta_financ_w like '% ' || x.cd_conta_financ || ' %'))) 
		and (not exists (select 1 
				from 	alteracao_valor y 
				where 	y.nr_titulo = a.nr_titulo) or ie_alteracao_p = 'S');
 
 
		select	coalesce(sum(CASE WHEN ie_situacao='5' THEN obter_valor_tit_rec_desdobrado(a.nr_titulo)  ELSE vl_titulo END ),0) 
		into STRICT	vl_entradas_w 
		from 	titulo_receber a 
		where (a.cd_estabelecimento = cd_estabelecimento_p or 
			 a.cd_estab_financeiro = cd_estabelecimento_p) 
		and (a.ie_situacao 		<> '3' or ie_cancelados_p = 'S') 
		and (a.ie_situacao 		<> '5' or ie_desdobrados_p = 'S') 
		and	trunc(a.dt_emissao,'dd') = dt_referencia_w 
		and	((coalesce(cd_conta_financ_p::text, '') = '') or (exists (SELECT	1 
								from	titulo_receber_classif x 
								where	x.nr_titulo	= a.nr_titulo 
								and	ds_lista_conta_financ_w like '% ' || x.cd_conta_financ || ' %'))) 
		and (not exists (select 1 
				from 	alteracao_valor y 
				where 	y.nr_titulo = a.nr_titulo) or ie_alteracao_p = 'S');
	 
		select	coalesce(sum(b.vl_recebido),0), 
			coalesce(sum(b.vl_descontos),0), 
			coalesce(sum(b.vl_glosa),0) 
		into STRICT	vl_baixas_w, 
			vl_descontos_w, 
			vl_glosa_w 
		from 	titulo_receber_liq b, 
			titulo_receber a 
		where 	a.nr_titulo	= b.nr_titulo 
		and (a.cd_estabelecimento = cd_estabelecimento_p or 
			 a.cd_estab_financeiro = cd_estabelecimento_p) 
		and (a.ie_situacao 		<> '3' or ie_cancelados_p = 'S') 
		and (a.ie_situacao 		<> '5' or ie_desdobrados_p = 'S') 
		and	coalesce(ie_lib_caixa,'S') = 'S' 
		and 	trunc(b.dt_recebimento,'dd') = dt_referencia_w 
		and	((coalesce(cd_conta_financ_p::text, '') = '') or (exists (SELECT	1 
							from	titulo_receber_classif x 
							where	x.nr_titulo	= a.nr_titulo 
							and	ds_lista_conta_financ_w like '% ' || x.cd_conta_financ || ' %'))) 
		and (not exists (select 1 
				from 	alteracao_valor y 
				where 	y.nr_titulo = a.nr_titulo) or ie_alteracao_p = 'S');
 
		select	coalesce(sum(CASE WHEN ie_aumenta_diminui='A' THEN  vl_alteracao  ELSE vl_alteracao * -1 END ),0) 
		into STRICT	vl_alterado_w 
		from	alteracao_valor b, 
			titulo_receber a 
		where	a.nr_titulo	= b.nr_titulo 
		and (a.cd_estabelecimento = cd_estabelecimento_p or 
			 a.cd_estab_financeiro = cd_estabelecimento_p) 
		and (a.ie_situacao 		<> '3' or ie_cancelados_p = 'S') 
		and (a.ie_situacao 		<> '5' or ie_desdobrados_p = 'S') 
		and 	trunc(b.dt_alteracao,'dd') = dt_referencia_w 
		and	((coalesce(cd_conta_financ_p::text, '') = '') or (exists (SELECT	1 
								from	titulo_receber_classif x 
								where	x.nr_titulo	= a.nr_titulo 
								and	ds_lista_conta_financ_w like '% ' || x.cd_conta_financ || ' %'))) 
		and (not exists (select 1 
				from 	alteracao_valor y 
				where 	y.nr_titulo = a.nr_titulo) or ie_alteracao_p = 'S');
 
		select	coalesce(sum(obter_saldo_titulo_receber(a.nr_titulo, fim_dia(dt_referencia_w))),0) vl_saldo 
		into STRICT	vl_saldo_final_w 
		from 	titulo_receber a 
		where (a.cd_estabelecimento 	= cd_estabelecimento_p or 
			 a.cd_estab_financeiro 	= cd_estabelecimento_p) 
		and (a.ie_situacao 		<> '3' or ie_cancelados_p = 'S') 
		and (a.ie_situacao 		<> '5' or ie_desdobrados_p = 'S') 
		and	coalesce(a.dt_liquidacao, clock_timestamp() + interval '1000 days') >= fim_dia(dt_referencia_w) 
		and	a.dt_contabil 		<= fim_dia(dt_referencia_w) 
		and (coalesce(a.dt_liquidacao::text, '') = '' or 
			a.dt_liquidacao 	> fim_dia(dt_referencia_w)) 
		and	dt_emissao		< fim_dia(dt_referencia_w) 
		and	((coalesce(cd_conta_financ_p::text, '') = '') or (exists (SELECT	1 
								from	titulo_receber_classif x 
								where	x.nr_titulo	= a.nr_titulo 
								and	ds_lista_conta_financ_w like '% ' || x.cd_conta_financ || ' %'))) 
		and (not exists (select 1 
				from 	alteracao_valor y 
				where 	y.nr_titulo = a.nr_titulo) or ie_alteracao_p = 'S');
 
		vl_saldo_calc_w	:= vl_saldo_anterior_w + vl_entradas_w - vl_baixas_w - vl_descontos_w;
	 
		vl_diferenca_w	:= vl_saldo_calc_w - vl_saldo_final_w;	
 
		insert	into	w_posicao_contabil_cr(nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			dt_referencia, 
			vl_saldo_anterior, 
			vl_entradas, 
			vl_baixas, 
			vl_descontos, 
			vl_glosa, 
			vl_alterado, 
			vl_saldo_final, 
			vl_diferenca) 
		values (nextval('w_posicao_contabil_cr_seq'), 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			dt_referencia_w, 
			vl_saldo_anterior_w, 
			vl_entradas_w, 
			vl_baixas_w, 
			vl_descontos_w, 
			vl_glosa_w, 
			vl_alterado_w, 
			vl_saldo_final_w, 
			vl_diferenca_w);
	 
		commit;
	 
		dt_referencia_w	:= trunc(dt_referencia_w + 1,'dd');	
	end loop;
 
elsif (ie_opcao_p	= 'S') then 
 
		select	coalesce(sum(obter_saldo_titulo_receber(a.nr_titulo,fim_dia(trunc(dt_inicial_p,'dd') - 1))),0) vl_saldo 
		into STRICT	vl_saldo_anterior_w 
		from 	titulo_receber a 
		where (a.cd_estabelecimento 	= cd_estabelecimento_p or 
			 a.cd_estab_financeiro 	= cd_estabelecimento_p) 
		and (a.ie_situacao 		<> '3' or ie_cancelados_p = 'S') 
		and (a.ie_situacao 		<> '5' or ie_desdobrados_p = 'S') 
		and	coalesce(a.dt_liquidacao, clock_timestamp() + interval '1000 days') >= fim_dia(trunc(dt_inicial_p,'dd') - 1) 
		and	a.dt_contabil 		<= fim_dia(trunc(dt_inicial_p,'dd') - 1) 
		and (coalesce(a.dt_liquidacao::text, '') = '' or 
			a.dt_liquidacao 	> fim_dia(trunc(dt_inicial_p,'dd') - 1)) 
		and	dt_emissao		< fim_dia(trunc(dt_inicial_p,'dd') - 1) 
		and	((coalesce(cd_conta_financ_p::text, '') = '') or (exists (SELECT	1 
								from	titulo_receber_classif x 
								where	x.nr_titulo	= a.nr_titulo 
								and	ds_lista_conta_financ_w like '% ' || x.cd_conta_financ || ' %'))) 
		and (not exists (select 1 
				from 	alteracao_valor y 
				where 	y.nr_titulo = a.nr_titulo) or ie_alteracao_p = 'S');
 
 
		select	coalesce(sum(CASE WHEN ie_situacao='5' THEN obter_valor_tit_rec_desdobrado(a.nr_titulo)  ELSE vl_titulo END ),0) 
		into STRICT	vl_entradas_w 
		from 	titulo_receber a 
		where (a.cd_estabelecimento = cd_estabelecimento_p or 
			 a.cd_estab_financeiro = cd_estabelecimento_p) 
		and (a.ie_situacao 		<> '3' or ie_cancelados_p = 'S') 
		and (a.ie_situacao 		<> '5' or ie_desdobrados_p = 'S') 
		and	trunc(a.dt_emissao,'dd') between dt_inicial_p and fim_dia(dt_final_p) 
		and	((coalesce(cd_conta_financ_p::text, '') = '') or (exists (SELECT	1 
								from	titulo_receber_classif x 
								where	x.nr_titulo	= a.nr_titulo 
								and	ds_lista_conta_financ_w like '% ' || x.cd_conta_financ || ' %'))) 
		and (not exists (select 1 
				from 	alteracao_valor y 
				where 	y.nr_titulo = a.nr_titulo) or ie_alteracao_p = 'S');
	 
		select	coalesce(sum(b.vl_recebido),0), 
			coalesce(sum(b.vl_descontos),0), 
			coalesce(sum(b.vl_glosa),0) 
		into STRICT	vl_baixas_w, 
			vl_descontos_w, 
			vl_glosa_w 
		from 	titulo_receber_liq b, 
			titulo_receber a 
		where 	a.nr_titulo	= b.nr_titulo 
		and (a.cd_estabelecimento = cd_estabelecimento_p or 
			 a.cd_estab_financeiro = cd_estabelecimento_p) 
		and (a.ie_situacao 		<> '3' or ie_cancelados_p = 'S') 
		and (a.ie_situacao 		<> '5' or ie_desdobrados_p = 'S') 
		and	coalesce(ie_lib_caixa,'S') = 'S' 
		and 	trunc(b.dt_recebimento,'dd') between dt_inicial_p and fim_dia(dt_final_p) 
		and	((coalesce(cd_conta_financ_p::text, '') = '') or (exists (SELECT	1 
							from	titulo_receber_classif x 
							where	x.nr_titulo	= a.nr_titulo 
							and	ds_lista_conta_financ_w like '% ' || x.cd_conta_financ || ' %'))) 
		and (not exists (select 1 
				from 	alteracao_valor y 
				where 	y.nr_titulo = a.nr_titulo) or ie_alteracao_p = 'S');
 
		select	coalesce(sum(CASE WHEN ie_aumenta_diminui='A' THEN  vl_alteracao  ELSE vl_alteracao * -1 END ),0) 
		into STRICT	vl_alterado_w 
		from	alteracao_valor b, 
			titulo_receber a 
		where	a.nr_titulo	= b.nr_titulo 
		and (a.cd_estabelecimento = cd_estabelecimento_p or 
			 a.cd_estab_financeiro = cd_estabelecimento_p) 
		and (a.ie_situacao 		<> '3' or ie_cancelados_p = 'S') 
		and (a.ie_situacao 		<> '5' or ie_desdobrados_p = 'S') 
		and 	trunc(b.dt_alteracao,'dd') between dt_inicial_p and fim_dia(dt_final_p) 
		and	((coalesce(cd_conta_financ_p::text, '') = '') or (exists (SELECT	1 
								from	titulo_receber_classif x 
								where	x.nr_titulo	= a.nr_titulo 
								and	ds_lista_conta_financ_w like '% ' || x.cd_conta_financ || ' %'))) 
		and (not exists (select 1 
				from 	alteracao_valor y 
				where 	y.nr_titulo = a.nr_titulo) or ie_alteracao_p = 'S');
 
		select	coalesce(sum(obter_saldo_titulo_receber(a.nr_titulo, fim_dia(dt_final_p))),0) vl_saldo 
		into STRICT	vl_saldo_final_w 
		from 	titulo_receber a 
		where (a.cd_estabelecimento 	= cd_estabelecimento_p or 
			 a.cd_estab_financeiro 	= cd_estabelecimento_p) 
		and (a.ie_situacao 		<> '3' or ie_cancelados_p = 'S') 
		and (a.ie_situacao 		<> '5' or ie_desdobrados_p = 'S') 
		and	coalesce(a.dt_liquidacao, clock_timestamp() + interval '1000 days') >= fim_dia(dt_final_p) 
		and	a.dt_contabil 		<= fim_dia(dt_final_p) 
		and (coalesce(a.dt_liquidacao::text, '') = '' or 
			a.dt_liquidacao 	> fim_dia(dt_final_p)) 
		and	dt_emissao		< fim_dia(dt_final_p) 
		and	((coalesce(cd_conta_financ_p::text, '') = '') or (exists (SELECT	1 
								from	titulo_receber_classif x 
								where	x.nr_titulo	= a.nr_titulo 
								and	ds_lista_conta_financ_w like '% ' || x.cd_conta_financ || ' %'))) 
		and (not exists (select 1 
				from 	alteracao_valor y 
				where 	y.nr_titulo = a.nr_titulo) or ie_alteracao_p = 'S');
 
		vl_saldo_calc_w	:= vl_saldo_anterior_w + vl_entradas_w - vl_baixas_w - vl_descontos_w;
	 
		vl_diferenca_w	:= vl_saldo_calc_w - vl_saldo_final_w;	
 
		insert	into	w_posicao_contabil_cr(nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			dt_referencia, 
			vl_saldo_anterior, 
			vl_entradas, 
			vl_baixas, 
			vl_descontos, 
			vl_glosa, 
			vl_alterado, 
			vl_saldo_final, 
			vl_diferenca) 
		values (nextval('w_posicao_contabil_cr_seq'), 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			dt_referencia_w, 
			vl_saldo_anterior_w, 
			vl_entradas_w, 
			vl_baixas_w, 
			vl_descontos_w, 
			vl_glosa_w, 
			vl_alterado_w, 
			vl_saldo_final_w, 
			vl_diferenca_w);
	 
		commit;	
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_pos_contab_cr (cd_estabelecimento_p bigint, nm_usuario_p text, ie_opcao_p text, dt_inicial_p timestamp, dt_final_p timestamp, ie_cancelados_p text, ie_desdobrados_p text, ie_alteracao_p text, cd_conta_financ_p text) FROM PUBLIC;

