-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copia_param_conv_regra ( cd_convenio_orig_p bigint, cd_convenio_dest_p bigint, nm_tabela_p text, nm_usuario_p text, ie_excluir_p text, cd_estabelecimento_p bigint ) AS $body$
DECLARE


nr_seq_w				bigint;
nr_sequencia_w			bigint;
nr_seq_proc_interno_w		bigint;
cd_estabelecimento_w		smallint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;

c001 CURSOR FOR
SELECT 	nr_sequencia
from	convenio_regra_conta
where 	cd_convenio		= cd_convenio_orig_p;

c002 CURSOR FOR
SELECT 	nr_sequencia
from	regra_convenio_plano
where 	cd_convenio		= cd_convenio_orig_p;

c003 CURSOR FOR
SELECT 	nr_sequencia
from	convenio_proced_padrao
where 	cd_convenio		= cd_convenio_orig_p;


BEGIN

if (nm_tabela_p = 'CONVENIO_REGRA_PROC_PRINC') then
	if (ie_excluir_p = 'S') then
		delete from convenio_regra_proc_princ
		where cd_convenio = cd_convenio_dest_p;
	end if;
	insert into convenio_regra_proc_princ(
		nr_sequencia, cd_convenio, cd_regra,
		dt_atualizacao, nm_usuario, ie_tipo_atendimento, ie_clinica, cd_estabelecimento, cd_prim_setor_atend)
	SELECT nextval('convenio_regra_proc_princ_seq'), cd_convenio_dest_p, cd_regra,
		 clock_timestamp(), nm_usuario_p, ie_tipo_atendimento, ie_clinica, cd_estabelecimento, cd_prim_setor_atend
	from convenio_regra_proc_princ
	where cd_convenio = cd_convenio_orig_p;
elsif (nm_tabela_p = 'CONV_REGRA_TAXA_REPOUSO') then
	if (ie_excluir_p = 'S') then
		delete from conv_regra_taxa_repouso
		where cd_convenio = cd_convenio_dest_p;
	end if;
	insert into CONV_REGRA_TAXA_REPOUSO(
					NR_SEQUENCIA,  CD_CONVENIO, DT_ATUALIZACAO, NM_USUARIO, DT_ATUALIZACAO_NREC, NM_USUARIO_NREC, NR_SEQ_PROC_INTERNO, 
					CD_UNIDADE_BASICA, CD_UNIDADE_COMPL, QT_TEMPO_MIN, QT_TEMPO_MAX, CD_PROCEDIMENTO, IE_ORIGEM_PROCED, CD_SETOR_ATENDIMENTO,
					IE_SITUACAO, QT_ITEM)
	SELECT nextval('conv_regra_taxa_repouso_seq'), cd_convenio_dest_p, clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p, NR_SEQ_PROC_INTERNO, 
					CD_UNIDADE_BASICA, CD_UNIDADE_COMPL, QT_TEMPO_MIN, QT_TEMPO_MAX, CD_PROCEDIMENTO, IE_ORIGEM_PROCED, CD_SETOR_ATENDIMENTO,
					IE_SITUACAO, QT_ITEM
	from 	CONV_REGRA_TAXA_REPOUSO
	where cd_convenio = cd_convenio_orig_p;
elsif (nm_tabela_p = 'REGRA_DIETA_ACOMP') then
	if (ie_excluir_p = 'S') then
		delete from REGRA_DIETA_ACOMP
		where cd_convenio = cd_convenio_dest_p;
	end if;
	insert into REGRA_DIETA_ACOMP(
					NR_SEQUENCIA, CD_ESTABELECIMENTO, DT_ATUALIZACAO, NM_USUARIO, DT_ATUALIZACAO_NREC, NM_USUARIO_NREC,
					CD_CONVENIO, CD_CATEGORIA, CD_PLANO, QT_DIETA_ACOMP, IE_LIB_DIETA, QT_IDADE_MENORES, QT_IDADE_MAIORES,
					QT_ACOMPANHANTES, NR_SEQ_REGRA_ACOMP, QT_IDADE_DE, QT_IDADE_ATE, NR_SEQ_CLASSIFICACAO, IE_TIPO_ATENDIMENTO)
		SELECT 			nextval('regra_dieta_acomp_seq'), CD_ESTABELECIMENTO, clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p, 
					cd_convenio_dest_p, null, null, QT_DIETA_ACOMP, IE_LIB_DIETA, QT_IDADE_MENORES, QT_IDADE_MAIORES,
					QT_ACOMPANHANTES, NR_SEQ_REGRA_ACOMP, QT_IDADE_DE, QT_IDADE_ATE, NR_SEQ_CLASSIFICACAO, IE_TIPO_ATENDIMENTO 
		from 	REGRA_DIETA_ACOMP
		where cd_convenio = cd_convenio_orig_p;
elsif (nm_tabela_p = 'CONVENIO_PROCED_PADRAO') then
	if (ie_excluir_p = 'S') then
		delete 	from 	conv_proced_padrao_perfil
		where 	nr_seq_proc_padrao in ( SELECT nr_sequencia from convenio_proced_padrao
						where cd_convenio = cd_convenio_dest_p);

		delete 	from 	convenio_proced_padrao
		where 	cd_convenio = cd_convenio_dest_p;
	end if;

	begin
	open c003;
		loop
		fetch c003 into
				nr_seq_w;
		EXIT WHEN NOT FOUND; /* apply on c003 */
			begin
			select  nextval('convenio_proced_padrao_seq')
			into STRICT	nr_sequencia_w
			;

			insert into convenio_proced_padrao(
				nr_sequencia, cd_estabelecimento, dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
				nm_usuario_nrec, cd_convenio, cd_procedimento, ie_origem_proced, ie_situacao, nr_seq_proc_interno,
				ds_proced_padrao, nr_seq_apresent, ds_cor, ie_define_qtde, ie_define_medico, ie_define_data, nr_seq_classificacao)
			SELECT  nr_sequencia_w, cd_estabelecimento, clock_timestamp(), nm_usuario_p, clock_timestamp(),
				nm_usuario_p, cd_convenio_dest_p, cd_procedimento, ie_origem_proced, ie_situacao, nr_seq_proc_interno,
				ds_proced_padrao, nr_seq_apresent, ds_cor, ie_define_qtde, ie_define_medico, ie_define_data, nr_seq_classificacao
			from	convenio_proced_padrao
			where 	cd_convenio = cd_convenio_orig_p
			and 	nr_sequencia = nr_seq_w;
			
			select	nr_seq_proc_interno,
				cd_estabelecimento
			into STRICT	nr_seq_proc_interno_w,
				cd_estabelecimento_w
			from	convenio_proced_padrao
			where 	cd_convenio = cd_convenio_orig_p
			and 	nr_sequencia = nr_seq_w;			
			
			if (coalesce(nr_seq_proc_interno_w,0) > 0) then
			
				SELECT * FROM Obter_Proc_Tab_Interno_Conv(nr_seq_proc_interno_w, cd_estabelecimento_w, cd_convenio_dest_p, null, null, null, cd_procedimento_w, ie_origem_proced_w, null, clock_timestamp(), null, null, null, null, null, null, null, null) INTO STRICT cd_procedimento_w, ie_origem_proced_w;
			
				update	convenio_proced_padrao
				set	cd_procedimento 	= cd_procedimento_w,
					ie_origem_proced	= ie_origem_proced_w
				where 	cd_convenio 		= cd_convenio_dest_p
				and 	nr_sequencia 		= nr_sequencia_w;
			
			end if;

			insert into conv_proced_padrao_perfil(
				nr_sequencia, cd_estabelecimento, nr_seq_proc_padrao, dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
				nm_usuario_nrec, cd_perfil,ie_restringe_perfil)
			SELECT 	nextval('conv_proced_padrao_perfil_seq'), cd_estabelecimento, nr_sequencia_w, clock_timestamp(), nm_usuario_p, clock_timestamp(),
				nm_usuario_p, cd_perfil, ie_restringe_perfil
			from 	conv_proced_padrao_perfil
			where 	nr_seq_proc_padrao = nr_seq_w;
			end;
		end loop;
	close c003;
	end;
elsif (nm_tabela_p = 'CONVENIO_REGRA_QTDE_PROC') then
	if (ie_excluir_p = 'S') then
		delete from convenio_regra_qtde_proc
		where cd_convenio = cd_convenio_dest_p;
	end if;
	insert into convenio_regra_qtde_proc(
		nr_sequencia, cd_procedimento, ie_origem_proced,
		ie_tipo_qtde, qt_permitida, ie_acao_excesso,
		dt_atualizacao, nm_usuario, cd_convenio,
		ie_tipo_atendimento, qt_horas_intervalo,
		cd_setor_atendimento, cd_medico, ie_tipo_uso, cd_proced_referencia,
		ie_origem_proc_ref, pr_permitida, cd_area_procedimento, cd_especialidade,
		cd_grupo_proc, ie_via_acesso, nr_seq_grupo, nr_seq_subgrupo, nr_seq_forma_org, ie_complexidade, ie_tipo_financiamento, ie_tipo_setor,
		nr_seq_proc_interno, cd_categoria, cd_plano, ds_observacao, nr_seq_exame, ie_situacao, cd_estabelecimento, 
		qt_dias_inter_inicio, qt_dias_inter_final, cd_tipo_acomodacao, ds_mensagem, cd_convenio_excesso, cd_categoria_excesso, qt_ano_min, qt_ano_max,
		qt_ano_min_mes, qt_ano_min_dia, qt_ano_max_mes, qt_ano_max_dia, cd_perfil)
	SELECT  nextval('convenio_regra_qtde_proc_seq'),
		cd_procedimento, ie_origem_proced,
		ie_tipo_qtde, qt_permitida, ie_acao_excesso,
		clock_timestamp(), nm_usuario_p, cd_convenio_dest_p,
		ie_tipo_atendimento, qt_horas_intervalo,
		cd_setor_atendimento, cd_medico, ie_tipo_uso, cd_proced_referencia,
		ie_origem_proc_ref, pr_permitida, cd_area_procedimento, cd_especialidade,
		cd_grupo_proc, ie_via_acesso, nr_seq_grupo, nr_seq_subgrupo, nr_seq_forma_org, ie_complexidade, ie_tipo_financiamento, ie_tipo_setor,
		nr_seq_proc_interno, cd_categoria, cd_plano, ds_observacao, nr_seq_exame, ie_situacao, cd_estabelecimento, 
		qt_dias_inter_inicio, qt_dias_inter_final, cd_tipo_acomodacao, ds_mensagem, cd_convenio_excesso, cd_categoria_excesso, qt_ano_min, qt_ano_max,
		qt_ano_min_mes, qt_ano_min_dia, qt_ano_max_mes, qt_ano_max_dia, cd_perfil
	from	convenio_regra_qtde_proc
	where 	cd_convenio = cd_convenio_orig_p;
elsif (nm_tabela_p = 'CONVENIO_REGRA_QTDE_MAT') then
	if (ie_excluir_p = 'S') then
		delete	from convenio_regra_qtde_mat
		where	cd_convenio = cd_convenio_dest_p;
	end if;
	insert into convenio_regra_qtde_mat(
		nr_sequencia, cd_material,
		ie_tipo_qtde, qt_permitida, ie_acao_excesso,
		dt_atualizacao, nm_usuario, cd_convenio,
		ie_tipo_atendimento, qt_horas_intervalo,
		cd_setor_atendimento, cd_grupo_material, cd_subgrupo_material, cd_classe_material, cd_categoria, cd_plano, ds_observacao, ie_situacao, cd_estabelecimento,
		qt_minutos_intervalo, cd_tipo_acomodacao, ds_mensagem, qt_ano_min, qt_ano_max, qt_ano_min_mes, qt_ano_min_dia, qt_ano_max_mes, qt_ano_max_dia,
		cd_perfil, cd_cgc_fornecedor, cd_cgc_prestador, ie_paciente_isolado)
	SELECT  nextval('convenio_regra_qtde_mat_seq'), cd_material,
		ie_tipo_qtde, qt_permitida, ie_acao_excesso,
		clock_timestamp(), nm_usuario_p, cd_convenio_dest_p,
		ie_tipo_atendimento, qt_horas_intervalo,
		cd_setor_atendimento, cd_grupo_material, cd_subgrupo_material, cd_classe_material, cd_categoria, cd_plano, ds_observacao, ie_situacao, cd_estabelecimento,
		qt_minutos_intervalo, cd_tipo_acomodacao, ds_mensagem, qt_ano_min, qt_ano_max, qt_ano_min_mes, qt_ano_min_dia, qt_ano_max_mes, qt_ano_max_dia, cd_perfil,
		cd_cgc_fornecedor, cd_cgc_prestador, ie_paciente_isolado
	from	convenio_regra_qtde_mat
	where 	cd_convenio = cd_convenio_orig_p;
elsif (nm_tabela_p = 'CONVENIO_FECHAMENTO') then
	if (ie_excluir_p = 'S') then
		delete from convenio_fechamento
		where cd_convenio = cd_convenio_dest_p;
	end if;
	insert into convenio_fechamento(
		cd_convenio, nr_sequencia, qt_dia,
		dt_fechamento, dt_atualizacao, nm_usuario,
		ie_tipo_protocolo, ie_regra_dia, cd_estabelecimento)
	SELECT cd_convenio_dest_p, row_number() OVER () AS rownum, qt_dia,
		 dt_fechamento, clock_timestamp(), nm_usuario_p,
		ie_tipo_protocolo, ie_regra_dia, cd_estabelecimento
	from convenio_fechamento
	where cd_convenio = cd_convenio_orig_p;
elsif (nm_tabela_p = 'CONV_FECHAMENTO_TIPO_PROT') then
	if (ie_excluir_p = 'S') then
		delete from conv_fechamento_tipo_prot
		where cd_convenio = cd_convenio_dest_p;
	end if;

	insert into conv_fechamento_tipo_prot(
			nr_sequencia, cd_convenio, ie_tipo_protocolo, dt_ref_valida, dt_atualizacao,
			nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec)
	SELECT nextval('conv_fechamento_tipo_prot_seq'), cd_convenio_dest_p, ie_tipo_protocolo, dt_ref_valida, clock_timestamp(),
			nm_usuario_p, clock_timestamp(), nm_usuario_p
	from  conv_fechamento_tipo_prot
	where cd_convenio = cd_convenio_orig_p;
elsif (nm_tabela_p = 'PARAMETRO_NFS') then
	if (ie_excluir_p = 'S') then
		delete	from parametro_nfs_lista
		where	cd_convenio	= cd_convenio_dest_p;
		delete	from parametro_nfs
		where	cd_convenio	= cd_convenio_dest_p;
	end if;
	insert	into parametro_nfs(cd_estabelecimento, cd_convenio, dt_atualizacao, nm_usuario,
		cd_serie_nf, cd_natureza_operacao,   cd_operacao_nf,
		cd_condicao_pagamento, ie_opcao, qt_item_maximo, ie_origem_proced,
		cd_procedimento, cd_proced_acrescimo, ie_origem_proc_acres, NR_SEQ_CLASSIF_PREST)
	SELECT	cd_estabelecimento, cd_convenio_dest_p, clock_timestamp(), nm_usuario_p,
		cd_serie_nf, cd_natureza_operacao,    cd_operacao_nf,
		cd_condicao_pagamento, 	ie_opcao, qt_item_maximo, ie_origem_proced,
		cd_procedimento, cd_proced_acrescimo, ie_origem_proc_acres, NR_SEQ_CLASSIF_PREST
	from	parametro_nfs
	where	cd_convenio = cd_convenio_orig_p;

	insert	into parametro_nfs_lista(nr_sequencia, cd_estabelecimento, cd_convenio, dt_atualizacao,
		nm_usuario, ds_sql, cd_material, cd_procedimento, ie_origem_proced, ie_ordenacao, ie_lista_itens)
	SELECT	nextval('parametro_nfs_lista_seq'), cd_estabelecimento, cd_convenio_dest_p,
		clock_timestamp(), nm_usuario_p, ds_sql, cd_material, cd_procedimento,
		ie_origem_proced, ie_ordenacao, ie_lista_itens
	from	parametro_nfs_lista
	where	cd_convenio = cd_convenio_orig_p;
elsif (nm_tabela_p = 'COTACAO_MOEDA_CONVENIO') then
	
	if (ie_excluir_p = 'S') then
		delete 	from 	cotacao_moeda_convenio
		where 	cd_convenio = cd_convenio_dest_p
		and	cd_estabelecimento = cd_estabelecimento_p;
	end if;

	insert into cotacao_moeda_convenio(
		nr_sequencia, cd_estabelecimento,  cd_convenio,  cd_moeda,
		ie_previsto_realizado, 	dt_referencia, vl_honorarios, vl_custo_oper, vl_filme,
		dt_atualizacao, nm_usuario, cd_categoria, cd_area_proced, cd_especial_proced,
		cd_grupo_proced, cd_procedimento, ie_origem_proced, cd_setor_atendimento,
		ie_tipo_atendimento, ie_credenciado, cd_plano, 	ie_clinica, cd_empresa_ref,
		ds_regra_codigo, cd_edicao_amb, ie_situacao, nr_seq_proc_interno, nr_seq_grupo_lab,
		cd_tipo_acomodacao, dt_referencia_final)
	SELECT	nextval('cotacao_moeda_convenio_seq'), cd_estabelecimento_p, cd_convenio_dest_p,
		cd_moeda, ie_previsto_realizado, dt_referencia, vl_honorarios, vl_custo_oper,
		vl_filme, clock_timestamp(), nm_usuario_p, cd_categoria, 	cd_area_proced, cd_especial_proced,
		cd_grupo_proced, cd_procedimento, ie_origem_proced, cd_setor_atendimento, ie_tipo_atendimento,
		ie_credenciado, cd_plano, ie_clinica, cd_empresa_ref, ds_regra_codigo, 	cd_edicao_amb,
		ie_situacao, nr_seq_proc_interno, nr_seq_grupo_lab, cd_tipo_acomodacao, dt_referencia_final
	from 	cotacao_moeda_convenio
	where 	cd_convenio = cd_convenio_orig_p
	and	cd_estabelecimento = cd_estabelecimento_p;
	
elsif (nm_tabela_p = 'PARAM_INTERFACE') then
	if (ie_excluir_p = 'S') then
		delete from param_interface
		where cd_convenio = cd_convenio_dest_p;
	end if;
	insert into param_interface(
		cd_convenio, nr_sequencia,
		dt_atualizacao, nm_usuario,
		ie_tipo_atendimento, cd_cgc,
		cd_interno, cd_regional,
		ie_excluir_hon_med, ie_excluir_hon_terc)
	SELECT cd_convenio_dest_p, row_number() OVER () AS rownum,
		dt_atualizacao, nm_usuario,
		ie_tipo_atendimento, cd_cgc,
		cd_interno, cd_regional,
		ie_excluir_hon_med, ie_excluir_hon_terc
	from param_interface
	where cd_convenio = cd_convenio_orig_p;
elsif (nm_tabela_p = 'CONVENIO_CONTA_CONTABIL') then
	if (ie_excluir_p = 'S') then
		delete 	from 	convenio_conta_contabil
		where 	cd_convenio = cd_convenio_dest_p
		and	cd_estabelecimento = cd_estabelecimento_p;
	end if;

	insert into convenio_conta_contabil(
			nr_sequencia, cd_convenio,  cd_conta_contabil, dt_atualizacao, nm_usuario,
			ie_tipo_atendimento, cd_estabelecimento, dt_atualizacao_nrec, nm_usuario_nrec,
			ie_tipo_conta, dt_inicio_vigencia, dt_fim_vigencia, ie_tipo_protocolo, cd_setor_atendimento)
		SELECT	nextval('convenio_conta_contabil_seq'), cd_convenio_dest_p, cd_conta_contabil,
			clock_timestamp(), nm_usuario_p, ie_tipo_atendimento, cd_estabelecimento_p,  clock_timestamp(), nm_usuario_p,
			ie_tipo_conta, dt_inicio_vigencia, dt_fim_vigencia,
			ie_tipo_protocolo,
			cd_setor_atendimento
		from 	convenio_conta_contabil
		where 	cd_convenio = cd_convenio_orig_p
		and	cd_estabelecimento = cd_estabelecimento_p;
elsif (nm_tabela_p = 'CONVENIO_REGRA_ATEND') then
	if (ie_excluir_p = 'S') then
		delete 	from 	convenio_regra_atend
		where 	cd_convenio = cd_convenio_dest_p
		and	cd_estabelecimento = cd_estabelecimento_p;
	end if;

	insert into convenio_regra_atend(
			nr_sequencia, cd_estabelecimento,  cd_convenio, dt_atualizacao, nm_usuario, ie_regra,
			ie_tipo_atendimento, qt_regra, dt_atualizacao_nrec, nm_usuario_nrec, cd_plano, ie_ignorar_estab)
		SELECT	nextval('convenio_regra_atend_seq'), cd_estabelecimento_p, cd_convenio_dest_p,
			clock_timestamp(), nm_usuario_p, ie_regra, ie_tipo_atendimento, qt_regra, clock_timestamp(),
			nm_usuario_p, cd_plano, ie_ignorar_estab
		from 	convenio_regra_atend
		where 	cd_convenio = cd_convenio_orig_p
		and	cd_estabelecimento = cd_estabelecimento_p;
elsif (nm_tabela_p = 'CONV_REGRA_ENVIO_PROTOCOLO') then
	if (ie_excluir_p = 'S') then
		delete 	from 	conv_regra_envio_protocolo
		where 	cd_convenio = cd_convenio_dest_p;
	end if;

	insert into conv_regra_envio_protocolo(
		nr_sequencia, cd_convenio, ie_tipo_regra, dt_atualizacao, nm_usuario, ie_tipo_protocolo,
		cd_convenio_princ, ds_diretorio_padrao, ie_regra_arquivo, ie_tipo_arquivo, dt_atualizacao_nrec,
		nm_usuario_nrec, nr_seq_envio_prot, cd_interface)
	SELECT  nextval('conv_regra_envio_protocolo_seq'), cd_convenio_dest_p, ie_tipo_regra, clock_timestamp(), nm_usuario_p,
		ie_tipo_protocolo, cd_convenio_princ, ds_diretorio_padrao, ie_regra_arquivo, ie_tipo_arquivo,
		clock_timestamp(), nm_usuario_p, nr_seq_envio_prot, cd_interface
	from	conv_regra_envio_protocolo
	where 	cd_convenio = cd_convenio_orig_p;
elsif (nm_tabela_p = 'CONVENIO_REGRA_MEDICO') then
	if (ie_excluir_p = 'S') then
		delete 	from 	convenio_regra_medico
		where 	cd_convenio = cd_convenio_dest_p
		and 	cd_estabelecimento = cd_estabelecimento_p;
	end if;

	insert into convenio_regra_medico(
		nr_sequencia, cd_estabelecimento, cd_convenio, dt_atualizacao, nm_usuario, ie_tipo_atendimento,
		ie_atendimento, ie_execucao, dt_atualizacao_nrec, nm_usuario_nrec)
	SELECT  nextval('convenio_regra_medico_seq'), cd_estabelecimento_p, cd_convenio_dest_p, clock_timestamp(), nm_usuario_p,
		ie_tipo_atendimento, ie_atendimento, ie_execucao, clock_timestamp(), nm_usuario_p
	from	convenio_regra_medico
	where 	cd_convenio = cd_convenio_orig_p
	and 	cd_estabelecimento = cd_estabelecimento_p;
elsif (nm_tabela_p = 'REGRA_SENHA_CONVENIO') then
	if (ie_excluir_p = 'S') then
		delete 	from 	regra_senha_convenio
		where 	cd_convenio = cd_convenio_dest_p;
	end if;

	insert into regra_senha_convenio(
		nr_sequencia, cd_convenio, ie_tipo_atendimento, ie_exige_guia, ie_exige_senha, dt_atualizacao,
		nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, cd_carater_internacao, ie_clinica, nr_seq_classificacao,
		nr_seq_proc_interno, cd_estabelecimento, cd_procedencia)
	SELECT  nextval('regra_senha_convenio_seq'), cd_convenio_dest_p, ie_tipo_atendimento, ie_exige_guia, ie_exige_senha,
		clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p, cd_carater_internacao, ie_clinica, nr_seq_classificacao,
		nr_seq_proc_interno, cd_estabelecimento, cd_procedencia
	from	regra_senha_convenio
	where 	cd_convenio = cd_convenio_orig_p;
elsif (nm_tabela_p = 'CONVENIO_REGRA_CONTA') then
	if (ie_excluir_p = 'S') then
		delete 	from 	conv_regra_conta_proc
		where 	nr_seq_regra in (SELECT nr_sequencia from convenio_regra_conta
					 where cd_convenio = cd_convenio_dest_p);

		delete 	from 	conv_regra_conta_mat
		where 	nr_seq_regra in (SELECT nr_sequencia from convenio_regra_conta
					 where cd_convenio = cd_convenio_dest_p);

		delete 	from 	convenio_regra_conta
		where 	cd_convenio = cd_convenio_dest_p;
	end if;

	begin
	open c001;
		loop
		fetch c001 into
				nr_seq_w;
		EXIT WHEN NOT FOUND; /* apply on c001 */
			begin
			select  nextval('convenio_regra_conta_seq')
			into STRICT	nr_sequencia_w
			;

			insert into convenio_regra_conta(
				nr_sequencia, dt_atualizacao, nm_usuario, cd_convenio, ds_informacao, nr_seq_inf,
				cd_informacao, ds_regra_obtencao, ie_diaria, dt_atualizacao_nrec, nm_usuario_nrec)
			SELECT  nr_sequencia_w, clock_timestamp(), nm_usuario_p, cd_convenio_dest_p, ds_informacao,
				nr_seq_inf,  cd_informacao, ds_regra_obtencao, ie_diaria, clock_timestamp(), nm_usuario_p
			from	convenio_regra_conta
			where 	cd_convenio = cd_convenio_orig_p
			and 	nr_sequencia = nr_seq_w;

			insert into conv_regra_conta_proc(
				nr_sequencia, nr_seq_regra, dt_atualizacao, nm_usuario, cd_area_proced, cd_especial_proced,
				cd_grupo_proced, cd_procedimento, ie_origem_proced, ie_pacote, cd_setor_atendimento,
				dt_atualizacao_nrec, nm_usuario_nrec)
			SELECT 	nextval('conv_regra_conta_proc_seq'), nr_sequencia_w, clock_timestamp(), nm_usuario_p, cd_area_proced,
				cd_especial_proced, cd_grupo_proced, cd_procedimento, ie_origem_proced, ie_pacote,
				cd_setor_atendimento, clock_timestamp(), nm_usuario_p
			from 	conv_regra_conta_proc
			where 	nr_seq_regra = nr_seq_w;

			insert into conv_regra_conta_mat(
				nr_sequencia,  nr_seq_regra, dt_atualizacao, nm_usuario, cd_grupo_material,
				cd_subgrupo_material, cd_classe_material, cd_material, cd_setor_atendimento,
				ie_pacote, dt_atualizacao_nrec, nm_usuario_nrec)
			SELECT 	nextval('conv_regra_conta_mat_seq'), nr_sequencia_w, clock_timestamp(), nm_usuario_p, cd_grupo_material,
				cd_subgrupo_material, cd_classe_material, cd_material, cd_setor_atendimento,
				ie_pacote, clock_timestamp(), nm_usuario_p
			from 	conv_regra_conta_mat
			where 	nr_seq_regra = nr_seq_w;
			end;
		end loop;
	close c001;
	end;
elsif (nm_tabela_p = 'REGRA_GERAR_AUTORIZACAO') then
	if (ie_excluir_p = 'S') then
		delete 	from 	regra_gerar_autorizacao
		where 	cd_convenio = cd_convenio_dest_p
		and	cd_estabelecimento = cd_estabelecimento_p;
	end if;

	insert into regra_gerar_autorizacao(
			nr_sequencia, cd_estabelecimento, dt_atualizacao, nm_usuario, ie_tipo_autorizacao,
			ie_evento, ie_exige_just_medica, qt_hora_antecedencia, hr_execucao,  ie_tipo_atendimento,
			cd_edicao_convenio, cd_convenio, ie_internado, cd_classif_setor, cd_tipo_acomodacao,
			dt_atualizacao_nrec, nm_usuario_nrec, ie_tipo_regra,cd_categoria, ie_situacao, cd_procedimento,
			ie_origem_proced, cd_proc_internacao, ie_origem_proc_int, ie_tipo_guia,	ie_carater_inter_sus,
			nr_seq_estagio, ie_tipo_util, qt_dias_prazo, ie_proc_diaria_acomod,cd_setor_atendimento,
			dt_vigencia_inicial, dt_vigencia_final, ie_tipo_acomod_atual,nr_seq_classif,ie_clinica,cd_especialidade,
			ie_carater_cirurgia,ie_classif_agenda_consulta,qt_idade_min,qt_idade_max,qt_dia_autor_rn,
			nr_seq_tipo_avaliacao,ie_carater_int_tiss_regra,qt_dias_geracao_vigencia,ie_equip_agenda,
			ie_autor_exame_adic_integ,ie_gerar_proc_princ_agenda, ie_gerar_observacao, ie_gerar_indic_clinica, ie_gerar_inicio_vigencia, ie_unic_intern_transf_rn, qt_sessao_agenda,
			ie_autor_vaga_atend, hr_inicial, hr_final, ie_dia_util, ie_data_fim_vigencia, ie_feriado, dt_dia_semana, qt_dias_solic_padrao, nr_seq_proc_interno_int)
		SELECT	nextval('regra_gerar_autorizacao_seq'), cd_estabelecimento_p, clock_timestamp(), nm_usuario_p,
			ie_tipo_autorizacao, ie_evento, ie_exige_just_medica, qt_hora_antecedencia, hr_execucao,
			ie_tipo_atendimento, cd_edicao_convenio, cd_convenio_dest_p, ie_internado, cd_classif_setor,
			cd_tipo_acomodacao, clock_timestamp(), nm_usuario_p, ie_tipo_regra,cd_categoria, ie_situacao, cd_procedimento,
			ie_origem_proced, cd_proc_internacao, ie_origem_proc_int, ie_tipo_guia,	ie_carater_inter_sus,
			nr_seq_estagio, ie_tipo_util, qt_dias_prazo, ie_proc_diaria_acomod,cd_setor_atendimento,
			dt_vigencia_inicial, dt_vigencia_final, ie_tipo_acomod_atual,nr_seq_classif,ie_clinica,cd_especialidade,
			ie_carater_cirurgia,ie_classif_agenda_consulta,qt_idade_min,qt_idade_max,qt_dia_autor_rn,
			nr_seq_tipo_avaliacao,ie_carater_int_tiss_regra,qt_dias_geracao_vigencia,ie_equip_agenda,
			ie_autor_exame_adic_integ,ie_gerar_proc_princ_agenda, ie_gerar_observacao, ie_gerar_indic_clinica, ie_gerar_inicio_vigencia, ie_unic_intern_transf_rn, qt_sessao_agenda,
			ie_autor_vaga_atend, hr_inicial, hr_final, ie_dia_util, ie_data_fim_vigencia, ie_feriado, dt_dia_semana, qt_dias_solic_padrao, nr_seq_proc_interno_int
		from 	regra_gerar_autorizacao
		where 	cd_convenio = cd_convenio_orig_p
		and	cd_estabelecimento = cd_estabelecimento_p;
elsif (nm_tabela_p = 'REGRA_CONVENIO_PLANO') then
	if (ie_excluir_p = 'S') then
		delete from regra_conv_plano_item
		where nr_seq_regra in (SELECT nr_sequencia from regra_convenio_plano
				       where cd_convenio = cd_convenio_dest_p
					   and	cd_estabelecimento = cd_estabelecimento_p);
		delete from regra_convenio_plano
		where cd_convenio = cd_convenio_dest_p
		and	cd_estabelecimento = cd_estabelecimento_p;
	end if;
	begin
	open c002;
		loop
		fetch c002 into
				nr_seq_w;
		EXIT WHEN NOT FOUND; /* apply on c002 */
			begin
			select 	nextval('regra_convenio_plano_seq')
			into STRICT	nr_sequencia_w
			;

			insert into regra_convenio_plano(
				nr_sequencia,
				cd_convenio,
				--cd_plano,
				ie_regra,
				dt_atualizacao,
				nm_usuario,
				ie_tipo_atendimento,
				cd_setor_atendimento,
				cd_area_procedimento,
				cd_especialidade_proc,
				cd_grupo_proc,
				cd_procedimento,
				ie_origem_proced,
				cd_tipo_acomodacao,
				ie_valor,
				qt_ponto_min,
				qt_ponto_max,
				ie_nova_autorizacao,
				nr_seq_proc_interno,
				ie_regra_valor,
				dt_inicio_vigencia,
				dt_fim_vigencia,
				nr_seq_grupo,
				nr_seq_subgrupo,
				nr_seq_forma_org,
				nr_seq_exame,
				cd_classif_setor,
				ie_clinica,
				ie_resp_autor,
				ie_autor_kit,
				ie_prioridade,
				ie_situacao,
				cd_doenca,
				nr_seq_classif_atend,
				cd_setor_entrega_prescr,
				cd_setor_atual,
				ie_carater_inter_sus,
				cd_empresa_conv,
				qt_minimo,
				qt_maximo,
				nr_seq_classif,
				ds_observacao,
				ds_mascara_carteira,
				cd_estabelecimento,
				cd_medico_executor,
				cd_especialidade_medic,
				ie_autor_particular,
				ie_qt_total_autor,
				ie_somente_item,
				ds_inconsist_prescr,
				qt_idade_min,
				qt_idade_max,
				nr_seq_cobertura,
				cd_perfil,
				cd_edicao_amb,
				nr_seq_classif_proc_int,
                cd_empresa)
			SELECT 	nr_sequencia_w,
				cd_convenio_dest_p,
				--cd_plano,
				ie_regra,
				clock_timestamp(),
				nm_usuario_p,
				ie_tipo_atendimento,
				cd_setor_atendimento,
				cd_area_procedimento,
				cd_especialidade_proc,
				cd_grupo_proc,
				cd_procedimento,
				ie_origem_proced,
				cd_tipo_acomodacao,
				ie_valor,
				qt_ponto_min,
				qt_ponto_max,
				ie_nova_autorizacao,
				nr_seq_proc_interno,
				ie_regra_valor,
				dt_inicio_vigencia,
				dt_fim_vigencia,
				nr_seq_grupo,
				nr_seq_subgrupo,
				nr_seq_forma_org,
				nr_seq_exame,
				cd_classif_setor,
				ie_clinica,
				 ie_resp_autor,
				ie_autor_kit,
				coalesce(ie_prioridade,'N'),
				coalesce(ie_situacao,'A'),
				cd_doenca,
				nr_seq_classif_atend,
				cd_setor_entrega_prescr,
				cd_setor_atual,
				ie_carater_inter_sus,
				cd_empresa_conv,
				qt_minimo,
				qt_maximo,
				nr_seq_classif,
				ds_observacao,
				ds_mascara_carteira,
				cd_estabelecimento_p,
				cd_medico_executor,
				cd_especialidade_medic,
				ie_autor_particular,
				ie_qt_total_autor,
				ie_somente_item,
				ds_inconsist_prescr,
				qt_idade_min,
				qt_idade_max,
				nr_seq_cobertura,
				cd_perfil,
				cd_edicao_amb,
				nr_seq_classif_proc_int,
                cd_empresa
			from regra_convenio_plano
			where cd_convenio = cd_convenio_orig_p
			and   nr_sequencia = nr_seq_w
			and	  cd_estabelecimento = cd_estabelecimento_p
			and	((coalesce(cd_plano,'X') = 'X') or (coalesce(cd_convenio_orig_p,0) = coalesce(cd_convenio_dest_p,0)));

			insert into regra_conv_plano_item(
				nr_sequencia, dt_atualizacao, nm_usuario,
				dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_regra,
				cd_procedimento, ie_origem_proced, cd_material,
				qt_solicitada, ie_situacao,nr_seq_proc_interno)
			SELECT 	nextval('regra_conv_plano_item_seq'), clock_timestamp(),
				nm_usuario_p, clock_timestamp(), nm_usuario_p, nr_sequencia_w,
				cd_procedimento, ie_origem_proced, cd_material,
				qt_solicitada, coalesce(ie_situacao,'A'),nr_seq_proc_interno
			from	regra_conv_plano_item
			where	nr_seq_regra = nr_seq_w;
			end;
		end loop;
	close c002;
	end;

elsif (nm_tabela_p = 'REGRA_CONVENIO_PLANO_MAT') then
	if (ie_excluir_p = 'S') then
		delete from regra_convenio_plano_mat
		where cd_convenio = cd_convenio_dest_p
		and	cd_estabelecimento = cd_estabelecimento_p;
	end if;

	insert into regra_convenio_plano_mat(
		nr_sequencia, 			cd_convenio,			cd_plano,
		dt_atualizacao, 		nm_usuario,			ie_tipo_atendimento, 
		cd_setor_atendimento,		cd_grupo_material, 		cd_subgrupo_material,
		cd_classe_material, 		cd_material,			ie_valor, 
		vl_material_min, 		vl_material_max, 		cd_tipo_acomodacao,
		ie_autor_particular,		dt_inicio_vigencia, 		dt_fim_vigencia, 
		ie_nova_autorizacao, 		ds_mascara_carteira, 		cd_estabelecimento,
		cd_doenca, 			qt_minima, 			qt_maxima, 
		cd_empresa_conv, 		ie_gerar_mat_esp, 		ie_mat_conta, 
		ie_autor_kit,			ie_consignado, 			nr_seq_cobertura, 
		ie_clinica, 			ie_carater_inter_sus, 		cd_classif_setor, 
		ds_observacao,			ie_regra,			nr_seq_familia,
		ie_gerar_vl_zerado,		cd_categoria,			ie_valor_dia,
		ie_valor_unitario,		nr_seq_classif,			ie_resp_autor,
		cd_perfil,			ie_tipo_material,		ie_classificacao,
		nr_seq_estrutura,		ie_regra_quantidade_solic,  cd_material_estoque,
		ie_final_vig_dose_dia_prescr, ie_exige_just_medica, ie_tiss_tipo_anexo,
		ie_tiss_tipo_etapa_autor, cd_empresa)
	SELECT nextval('regra_convenio_plano_mat_seq'), cd_convenio_dest_p,	check_if_plan_conv_compatible(cd_plano, cd_convenio_dest_p), 
		clock_timestamp(), 			nm_usuario_p,			ie_tipo_atendimento, 
		cd_setor_atendimento,		cd_grupo_material, 		cd_subgrupo_material,
		cd_classe_material, 		cd_material,			ie_valor, 
		vl_material_min, 		vl_material_max, 		cd_tipo_acomodacao, 
		ie_autor_particular,		dt_inicio_vigencia, 		dt_fim_vigencia, 
		ie_nova_autorizacao, 		ds_mascara_carteira, 		cd_estabelecimento_p,
		cd_doenca, 			qt_minima, 			qt_maxima, 
		cd_empresa_conv, 		ie_gerar_mat_esp, 		ie_mat_conta, 	
		ie_autor_kit,			ie_consignado, 			nr_seq_cobertura, 
		ie_clinica, 			ie_carater_inter_sus, 		cd_classif_setor, 
		ds_observacao,			ie_regra,			nr_seq_familia,
		ie_gerar_vl_zerado,		check_if_categ_conv_compatible(cd_categoria, cd_convenio_dest_p), ie_valor_dia,
		ie_valor_unitario,		nr_seq_classif,			ie_resp_autor,
		cd_perfil,			ie_tipo_material,		ie_classificacao,
		nr_seq_estrutura,		ie_regra_quantidade_solic,  cd_material_estoque,
		ie_final_vig_dose_dia_prescr, ie_exige_just_medica, ie_tiss_tipo_anexo,
		ie_tiss_tipo_etapa_autor, cd_empresa
	from 	regra_convenio_plano_mat
	where 	cd_convenio = cd_convenio_orig_p
	and		cd_estabelecimento = cd_estabelecimento_p;

elsif (nm_tabela_p = 'CONV_REGRA_ESTRUT_DESC') then
	if (ie_excluir_p = 'S') then
		delete from conv_regra_estrut_desc
		where cd_convenio = cd_convenio_dest_p;
	end if;

	insert into conv_regra_estrut_desc(
		nr_sequencia, dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
		nm_usuario_nrec, cd_convenio, cd_estrutura, pr_max_desc, cd_estabelecimento)
	SELECT nextval('conv_regra_estrut_desc_seq'), clock_timestamp(), nm_usuario_p, clock_timestamp(),
		nm_usuario_p, cd_convenio_dest_p, cd_estrutura, pr_max_desc, cd_estabelecimento
	from 	conv_regra_estrut_desc
	where 	cd_convenio = cd_convenio_orig_p;

elsif (nm_tabela_p = 'CONVENIO_REGRA_ENTREGA') then
	if (ie_excluir_p = 'S') then
		delete from convenio_regra_entrega
		where cd_convenio = cd_convenio_dest_p;
	end if;

	insert into convenio_regra_entrega(
		nr_sequencia, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
		cd_convenio, cd_estabelecimento, dt_entrega, ie_regra_dia, qt_dia)
	SELECT	nextval('convenio_regra_entrega_seq'), clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p,
		cd_convenio_dest_p, cd_estabelecimento, dt_entrega, ie_regra_dia, qt_dia
	from	convenio_regra_entrega
	where	cd_convenio = cd_convenio_orig_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copia_param_conv_regra ( cd_convenio_orig_p bigint, cd_convenio_dest_p bigint, nm_tabela_p text, nm_usuario_p text, ie_excluir_p text, cd_estabelecimento_p bigint ) FROM PUBLIC;

