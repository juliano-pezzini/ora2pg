-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_gerar_arq_mov_prestador_81 (nr_seq_lote_p bigint, cd_interface_p text, nm_usuario_p text, ds_local_p text, nm_arquivo_p text) AS $body$
DECLARE

 
/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade: Gerar arquivo A400 de acordo com a versão PTU 8.1 
----------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[X] Objetos do dicionário [ ] Tasy (Delphi/Java) [ ] Portal [ ] Relatórios [ ] Outros: 
 ---------------------------------------------------------------------------------------------------------------------- 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/ 
 
ds_conteudo_w			varchar(4000);
nm_arquivo_w			varchar(255);
ds_local_w			varchar(255) := null;
ds_erro_w			varchar(255);
arq_texto_w			utl_file.file_type;
nr_seq_registro_w		integer := 0;
nr_seq_ptu_prestador_w		bigint;
nr_seq_ptu_endereco_w		bigint;
ds_arquivo_w			text;
ds_hash_a400_w			ptu_movimento_prestador.ds_hash_a400%type;

-- 401 
cd_unimed_destino_w		varchar(4);
cd_unimed_origem_w		varchar(4);
dt_geracao_w			varchar(8);
id_ope_prest_w			varchar(1);
nr_registro_ans_w		varchar(6);

-- 402 
tp_prest_w			varchar(2);
cd_prest_w			varchar(8);
cd_cgc_cpf_w			varchar(15);
cd_insc_est_w			varchar(20);
nr_conselho_w			varchar(15);
cd_uf_conselho_w		varchar(2);
nm_fantasia_w			varchar(60);
tp_vinculo_w			varchar(1);
cd_espec_1_w			varchar(2);
cd_atua_1_w			varchar(2);
cd_espec_2_w			varchar(2);
cd_atua_2_w			varchar(2);
dt_incl_uni_w			varchar(8);
dt_excl_uni_w			varchar(8);
tp_contratualizacao_w		varchar(1);
tp_class_estabelec_w		varchar(1);
id_cat_dif_w			varchar(1);
id_acid_trab_w			varchar(1);
id_urg_emer_w			varchar(1);
id_rce_espec_1_w		varchar(1);
id_rce_atua_1_w			varchar(1);
id_rce_espec_2_w		varchar(1);
id_rce_atua_2_w			varchar(1);
dt_ini_servico_w		varchar(8);
dt_ini_contrato_w		varchar(8);
nm_diretor_tecnico_w		varchar(70);
tp_disponibilidade_w		varchar(1);
id_tab_propria_w		varchar(1);
cd_perfil_assist_w		varchar(2);
id_tp_prod_w			varchar(1);
id_guia_medico_w		varchar(1);
sg_cons_diretor_tecnico_w	varchar(12);
cd_cons_diretor_tecnico_w	varchar(15);
sg_uf_cons_diretor_tecnico_w	varchar(2);
tipo_rede_min_w			varchar(1);
id_guia_medico_espec_1_w	varchar(1);
id_guia_medico_espec_2_w	varchar(1);
id_guia_medico_atua_1_w		varchar(1);
id_guia_medico_atua_2_w		varchar(1);
prest_acred_w			varchar(1);
particip_notivisa_w		varchar(1);
particip_qualiss_ans_w		varchar(1);
nr_rce_espec_1_w		varchar(10);
nr_rce_espec_2_w		varchar(10);
nr_rce_2_espec_1_w		varchar(10);
nr_rce_2_espec_2_w		varchar(10);
nr_rce_atua_1_w			varchar(10);
nr_rce_atua_2_w			varchar(10);
nr_rce_2_atua_1_w		varchar(10);
nr_rce_2_atua_2_w		varchar(10);
indic_pos_grad_w		varchar(1);
nm_prest_w			varchar(70);
id_publica_ans_w		varchar(1);
nr_cbo_w			varchar(6);
indic_residencia_w		varchar(1);
indic_resid_espec_1_w		varchar(1);
indic_resid_area_1_w		varchar(1);
indic_resid_espec_2_w		varchar(1);
indic_resid_area_2_w		varchar(1);
cd_uni_prestadora_w		varchar(4);
id_login_wsd_tiss_w		varchar(1);
id_cadu_w			varchar(1);
id_inativo_w			varchar(1);
sg_conselho_w			varchar(12);
ie_sexo_w			varchar(1);
nr_seq_prestador_w		ptu_prestador.nr_seq_prestador%type;
cd_pessoa_fisica_w		pls_prestador.cd_pessoa_fisica%type;
ie_ind_ginec_obst_w		ptu_prestador.ie_ind_ginec_obst%type;
dt_atualizacao_cad_w		varchar(8);
cod_titulacao_1_w		varchar(3);
cod_titulacao_2_w		varchar(3);
ie_doutorado_pos_w		varchar(5);
id_iso9001_w			varchar(1);
indic_mestrado_w		varchar(1);

-- 403 
tp_end_w			varchar(1);
ds_end_w			varchar(40);
nr_end_w			varchar(6);
ds_bairro_w			varchar(30);
cd_munic_w			varchar(7);
nr_cep_w			varchar(8);
nr_ddd_w			varchar(4);
nr_fone_1_w			varchar(12);
nr_fone_2_w			varchar(12);
nr_fax_w			varchar(12);
ds_email_w			varchar(80);
ds_endereco_web_w		varchar(80);
ds_email_sec_w			varchar(80);
cd_cnes_w			varchar(7);
nr_leitos_totais_w		varchar(6);
nr_leitos_contrat_w		varchar(6);
nr_leitos_psiquiat_w		varchar(6);
nr_uti_adulto_w			varchar(6);
nr_uti_neonatal_w		varchar(6);
nr_uti_pediatria_w		varchar(6);
nr_leitos_intermed_neo_w	varchar(6);
id_filial_w			varchar(1);
ds_compl_w			varchar(30);
nr_leitos_hosp_dia_w		varchar(6);
nr_leitos_tot_clinic_w		varchar(6);
nr_leitos_tot_cirur_w		varchar(6);
nr_leitos_tot_obstr_w		varchar(6);
nr_leitos_tot_pediat_w		varchar(6);
nr_leitos_tot_psiqu_w		varchar(6);
nr_latitude_w			varchar(20);
nr_longitude_w			varchar(20);
nr_leitos_intermed_w		varchar(6);
nr_referencia_end_w		varchar(2);

-- 404 
cd_gr_serv_w			varchar(3);

-- 405 
cd_rede_w			varchar(4);
nm_rede_w			varchar(40);

--406 
ie_nivel_exclusao_ptu_w		varchar(2);
cd_exclusao_rede_w		varchar(4);
cd_exclusao_pla_prod_w		varchar(20);
nr_exclusao_end_w		varchar(2);
dt_termino_prest_w		varchar(8);
ie_substituicao_w		varchar(1);
cd_cnpj_cpf_substit_w		varchar(15);
dt_inicio_prest_w		varchar(8);
cd_motivo_exclusao_w		varchar(10);

-- 407 
cd_imposto_w			varchar(2);
vl_aliquota_w			varchar(5);

-- 408 
inst_acred_w			varchar(5);
nivel_acred_w			varchar(1);
nr_referencia_end_qualif_w	varchar(2);

-- 410 
ds_divulga_obs_w		varchar(250);

-- 499 
qt_tot_r402_w			varchar(7);
qt_tot_r403_w			varchar(7);
qt_tot_r404_w			varchar(7);
qt_tot_r405_w			varchar(7);
qt_tot_r406_w			varchar(7);
qt_tot_r407_w			varchar(7);
qt_tot_r408_w			varchar(7);
qt_tot_r410_w			varchar(7);
	
c01 CURSOR FOR 
	SELECT	nr_sequencia, 
		lpad(coalesce(ie_tipo_prestador,'0'),2,'0'), 
		lpad(coalesce(cd_prestador,'0'),8,'0'), 
		lpad(coalesce(cd_cgc_cpf,'0'),15,'0'), 
		lpad(coalesce(nr_insc_estadual,'0'),20,'0'), 
		lpad(coalesce(nr_crm,'0'),15,'0'), 
		rpad(coalesce(uf_crm,' '),2,' '), 
		rpad(coalesce(nm_fantasia,' '),60,' '), 
		coalesce(ie_tipo_vinculo,'0'), 
		lpad(coalesce(cd_espec_1,'0'),2,'0'), 
		lpad(coalesce(cd_atua_1,'0'),2,'0'), 
		lpad(coalesce(cd_espec_2,'0'),2,'0'), 
		lpad(coalesce(cd_atua_2,'0'),2,'0'), 
		to_char(dt_inclusao,'YYYYMMDD'), 
		rpad(coalesce(to_char(dt_exclusao,'YYYYMMDD'),' '),8,' '), 
		coalesce(ie_tipo_contratualizacao,' '), 
		coalesce(ie_tipo_classif_estab,' '), 
		coalesce(ie_categoria_dif,' '), 
		coalesce(ie_acidente_trabalho,' '), 
		coalesce(ie_urgencia_emerg,' '), 
		coalesce(id_rce_espec_1,' '), 
		coalesce(id_rce_atua_1,' '), 
		coalesce(id_rce_espec_2,' '), 
		coalesce(id_rce_atua_2,' '), 
		rpad(coalesce(to_char(dt_inicio_servico,'YYYYMMDD'),' '),8,' '), 
		rpad(coalesce(to_char(dt_inicio_contrato,'YYYYMMDD'),' '),8,' '), 
		lpad(coalesce(to_char(nr_registro_ans),' '),6,' '), 
		rpad(coalesce(nm_diretor_tecnico,' '),70,' '), 
		coalesce(ie_tipo_disponibilidade,'0'), 
		coalesce(ie_tabela_propria,' '), 
		lpad(coalesce(ie_perfil_assistencial,'0'),2,'0'), 
		coalesce(ie_tipo_produto,'0'), 
		CASE WHEN ie_tipo_prestador=1 THEN ' '  ELSE ie_guia_medico END , 
		rpad(coalesce(substr(obter_conselho_profissional(nr_seq_conselho,'S'),1,255),' '),12,' '), 
		rpad(coalesce(nr_cons_diretor_tecnico,' '),15,' '), 
		lpad(coalesce(sg_uf_cons_diretor_tecnico,' '),2,' '), 
		coalesce(ie_tipo_rede_min,'0'), 
		coalesce(id_guia_medico_espec_1,' '), 
		coalesce(id_guia_medico_espec_2,' '), 
		coalesce(id_guia_medico_atua_1,' '), 
		coalesce(id_guia_medico_atua_2,' '), 
		coalesce(ie_notivisa,'N'), 
		coalesce(ie_particip_qualiss_ans,'N'), 
		lpad(coalesce(nr_rce_espec_1,'0'),10,'0'), 
		lpad(coalesce(nr_rce_espec_2,'0'),10,'0'), 
		lpad(coalesce(nr_rce_2_espec_1,'0'),10,'0'), 
		lpad(coalesce(nr_rce_2_espec_2,'0'),10,'0'), 
		lpad(coalesce(nr_rce_atua_1,'0'),10,'0'), 
		lpad(coalesce(nr_rce_atua_2,'0'),10,'0'), 
		lpad(coalesce(nr_rce_2_atua_1,'0'),10,'0'), 
		lpad(coalesce(nr_rce_2_atua_2,'0'),10,'0'), 
		coalesce(indic_pos_grad,' '), 
		rpad(coalesce(nm_prestador,' '),70,' '), 
		coalesce(id_publica_ans,' '), 
		lpad(coalesce(nr_cbo,'0'),6,'0'), 
		coalesce(indic_residencia,' '), 
		lpad(coalesce(cd_uni_prestadora,'0'),4,'0'), 
		coalesce(id_login_wsd_tiss,' '), 
		coalesce(id_cadu,' '), 
		coalesce(id_inativo,' '), 
		rpad(coalesce(sg_conselho,' '),12,' '), 
		nr_seq_prestador, 
		ie_ind_ginec_obst, 
		ie_sexo, 
		to_char(dt_atualizacao_cad,'YYYYMMDD'), 
		lpad(coalesce(cod_titulacao_1,'0'),3,'0'), 
		lpad(coalesce(cod_titulacao_2,'0'),3,'0'), 
		coalesce(indic_resid_espec_1,' '), 
		coalesce(indic_resid_espec_2,' '), 
		coalesce(indic_resid_atua_1,' '), 
		coalesce(indic_resid_atua_2,' '), 
		coalesce(ie_doutorado_pos,' '), 
		coalesce(id_iso9001,'N'), 
		coalesce(indic_mestrado,' ') 
	from	ptu_prestador 
	where	nr_seq_movimento = nr_seq_lote_p 
	order by 1;
	
C02 CURSOR FOR 
	SELECT	z.nr_sequencia, 
		coalesce(z.ie_tipo_endereco,'0'), 
		rpad(coalesce(z.ds_endereco,' '),40,' '), 
		rpad(coalesce(z.nr_endereco,' '),6,' '), 
		rpad(coalesce(z.ds_bairro,' '),30,' '), 
		lpad(coalesce(z.cd_municipio_ibge,'0'),6,'0') || coalesce(calcula_digito('MODULO10',lpad(z.cd_municipio_ibge,6,'0')),'0'), 
		lpad(coalesce(z.cd_cep,'0'),8,'0'), 
		lpad(coalesce(z.nr_ddd,'0'),4,'0'), 
		lpad(coalesce(z.nr_telefone,'0'),12,'0'), 
		lpad(coalesce(z.nr_telefone_dois,'0'),12,'0'), 
		lpad(coalesce(z.nr_fax,'0'),12,'0'), 
		rpad(coalesce(z.ds_email,' '),80,' '), 
		rpad(coalesce(z.ds_endereco_web,' '),80,' '), 
		lpad(coalesce(z.cd_cnes,'9999999'),7,'0'), 
		lpad(coalesce(z.nr_leitos_totais,'0'),6,'0'), 
		lpad(coalesce(z.nr_leitos_contrat,'0'),6,'0'), 
		lpad(coalesce(z.nr_leitos_psiquiatria,'0'),6,'0'), 
		lpad(coalesce(z.nr_uti_adulto,'0'),6,'0'), 
		lpad(coalesce(z.nr_uti_neonatal,'0'),6,'0'), 
		lpad(coalesce(z.nr_uti_pediatria,'0'),6,'0'), 
		lpad(coalesce(z.cd_cgc_cpf,'0'),15,'0'), 
		lpad(coalesce(z.nr_leitos_intermed_neo,'0'),6,'0'), 
		coalesce(substr(pls_obter_dados_prestador(x.nr_seq_prestador,'F'),1,1),'N'), 
		rpad(coalesce(z.ds_complemento,' '),30,' '), 
		lpad(coalesce(z.nr_leitos_hosp_dia,'0'),6,'0'), 
		lpad(coalesce(z.nr_leitos_tot_clinic,'0'),6,'0'), 
		lpad(coalesce(z.nr_leitos_tot_cirurgico,'0'),6,'0'), 
		lpad(coalesce(z.nr_leitos_tot_obstr,'0'),6,'0'), 
		lpad(coalesce(z.nr_leitos_tot_pediat,'0'),6,'0'), 
		lpad(coalesce(z.nr_leitos_tot_psiqu,'0'),6,'0'), 
		rpad(coalesce(z.nr_latitude,' '),20,' ') nr_latitude, 
		rpad(coalesce(z.nr_longitude,' '),20,' ') nr_longitude, 
		lpad(coalesce(z.nr_leitos_intermed,'0'),6,'0'), 
		coalesce(ie_prest_acred,'N'), 
		lpad(coalesce(z.nr_referencia_end,'0'),2,'0'), 
		rpad(coalesce(z.ds_email_sec,' '),80,' ') 
	from	ptu_prestador_endereco z, 
		ptu_prestador	x		 
	where	x.nr_sequencia		= z.nr_seq_prestador 
	and	x.nr_sequencia		= nr_seq_ptu_prestador_w 
	order by 1;
	
C03 CURSOR FOR 
	SELECT	lpad(coalesce(cd_grupo_servico,'0'),3,'0') 
	from	ptu_prestador_grupo_serv 
	where	nr_seq_endereco	= nr_seq_ptu_endereco_w 
	order by cd_grupo_servico;

C04 CURSOR FOR 
	SELECT	rpad(coalesce(cd_rede,' '),4,' '), 
		rpad(coalesce(nm_rede,' '),40,' ') 
	from	ptu_prestador_rede_ref 
	where	nr_seq_prestador	= nr_seq_ptu_prestador_w 
	order by cd_rede;
	
C05 CURSOR FOR 
	SELECT	lpad(coalesce(ie_nivel_exclusao_ptu,'0'),2,'0'), 
		rpad(coalesce(cd_exclusao_rede,' '),4,' '), 
		rpad(coalesce(cd_exclusao_pla_prod,' '),20,' '), 
		lpad(coalesce(nr_exclusao_end,'0'),2,'0'), 
		lpad(coalesce(to_char(dt_termino_prest,'YYYYMMDD'),' '),8,' '), 
		coalesce(ie_substituicao,'N'), 
		lpad(coalesce(cd_cnpj_cpf_substit,'0'),15,'0'), 
		lpad(coalesce(to_char(dt_inicio_prest,'YYYYMMDD'),' '),8,' '), 
		lpad(coalesce(cd_motivo_exclusao,'0'),2,'0') 
	from	ptu_prestador_excl_subst 
	where	nr_seq_prestador	= nr_seq_ptu_prestador_w;
	
C06 CURSOR FOR 
	SELECT	lpad(coalesce(cd_imposto,'0'),2,'0'), 
		lpad(replace(replace(campo_mascara(coalesce(vl_aliquota,0),2),',',''),'.',''),5,'0') 
	from	ptu_prestador_imposto 
	where	nr_seq_prestador	= nr_seq_ptu_prestador_w;
	
C07 CURSOR FOR 
	SELECT	lpad(coalesce(cd_cnpj_cpf,'0'),15,'0'), 
		lpad(CASE WHEN coalesce(trim(both cd_instituicao_acred)::text, '') = '' THEN 	'000' WHEN trim(both cd_instituicao_acred)='BSI' THEN '001' WHEN trim(both cd_instituicao_acred)='CBA' THEN '002' WHEN trim(both cd_instituicao_acred)='CBRM' THEN '003' WHEN trim(both cd_instituicao_acred)='CBRR' THEN '004' WHEN trim(both cd_instituicao_acred)='CBRT' THEN '005' WHEN trim(both cd_instituicao_acred)='CBRU' THEN '006' WHEN trim(both cd_instituicao_acred)='CQH' THEN '007' WHEN trim(both cd_instituicao_acred)='DICQ' THEN '008' WHEN trim(both cd_instituicao_acred)='DNS' THEN '009' WHEN trim(both cd_instituicao_acred)='FCAV' THEN '010' WHEN trim(both cd_instituicao_acred)='GL' THEN '011' WHEN trim(both cd_instituicao_acred)='IAHC' THEN '012' WHEN trim(both cd_instituicao_acred)='IPAS' THEN '013' WHEN trim(both cd_instituicao_acred)='IQG' THEN '014' WHEN trim(both cd_instituicao_acred)='JOINT' THEN '015' WHEN trim(both cd_instituicao_acred)='ONA' THEN '016' WHEN trim(both cd_instituicao_acred)='OUT' THEN '017' WHEN trim(both cd_instituicao_acred)='PALC' THEN '018' WHEN trim(both cd_instituicao_acred)='PEM' THEN '019' WHEN trim(both cd_instituicao_acred)='SIG' THEN '020' WHEN trim(both cd_instituicao_acred)='APCE' THEN '021' WHEN trim(both cd_instituicao_acred)='AQSA' THEN '022' WHEN trim(both cd_instituicao_acred)='EGOPQ' THEN '023' WHEN trim(both cd_instituicao_acred)='ISO' THEN '000' WHEN trim(both cd_instituicao_acred)='EASSI' THEN '024'  ELSE trim(both cd_instituicao_acred) END ,3,'0'), 
		coalesce(ie_nivel_acreditacao,'0'), 
		lpad(coalesce(nr_referencia_end,'0'),2,'0') 
	from	ptu_prestador_qualific 
	where	nr_seq_prestador	= nr_seq_ptu_prestador_w;
	
C08 CURSOR FOR 
	SELECT	rpad(ds_divulgacao_obs,250,' ') ds_divulgacao_obs 
	from	ptu_prestador_observacao 
	where	nr_seq_prestador	= nr_seq_ptu_prestador_w;


BEGIN 
 
nm_arquivo_w	:= nm_arquivo_p;
ds_local_w	:= ds_local_p;
 
begin 
arq_texto_w := utl_file.fopen(ds_local_w,nm_arquivo_w,'W');
exception 
when others then 
	if (SQLSTATE = -29289) then 
		ds_erro_w := 'O acesso ao arquivo foi negado pelo sistema operacional (access_denied).';
	elsif (SQLSTATE = -29298) then 
		ds_erro_w := 'O arquivo foi aberto usando FOPEN_NCHAR, mas efetuaram-se operações de I/O usando funções nonchar comos PUTF ou GET_LINE (charsetmismatch).';
	elsif (SQLSTATE = -29291) then 
		ds_erro_w := 'Não foi possível apagar o arquivo (delete_failed).';
	elsif (SQLSTATE = -29286) then 
		ds_erro_w := 'Erro interno desconhecido no package UTL_FILE (internal_error).';
	elsif (SQLSTATE = -29282) then 
		ds_erro_w := 'O handle do arquivo não existe (invalid_filehandle).';
	elsif (SQLSTATE = -29288) then 
		ds_erro_w := 'O arquivo com o nome especificado não foi encontrado neste local (invalid_filename).';
	elsif (SQLSTATE = -29287) then 
		ds_erro_w := 'O valor de MAX_LINESIZE para FOPEN() é inválido; deveria estar na faixa de 1 a 32767 (invalid_maxlinesize).';
	elsif (SQLSTATE = -29281) then 
		ds_erro_w := 'O parâmetro open_mode na chamda FOPEN é inválido (invalid_mode).';
	elsif (SQLSTATE = -29290) then 
		ds_erro_w := 'O parâmetro ABSOLUTE_OFFSET para a chamada FSEEK() é inválido; deveria ser maior do que 0 e menor do que o número total de bytes do arquivo (invalid_offset).';
	elsif (SQLSTATE = -29283) then 
		ds_erro_w := 'O arquivo não pôde ser aberto ou operado da forma desejada - ou o caminho não foi encontrado (invalid_operation).';
	elsif (SQLSTATE = -29280) then 
		ds_erro_w := 'O caminho especificado não existe ou não está visível ao Oracle (invalid_path).';
	elsif (SQLSTATE = -29284) then 
		ds_erro_w := 'Não é possível efetuar a leitura do arquivo (read_error).';
	elsif (SQLSTATE = -29292) then 
		ds_erro_w := 'Não é possível renomear o arquivo.';
	elsif (SQLSTATE = -29285) then 
		ds_erro_w := 'Não foi possível gravar no arquivo (write_error).';
	else 
		ds_erro_w := 'Erro desconhecido no package UTL_FILE.';
	end if;
end;
 
-- 401 HEADER (OBRIGATÓRIO) 
select	lpad(coalesce(cd_unimed_destino,'0'),4,'0'), 
	lpad(coalesce(cd_unimed_origem,'0'),4,'0'), 
	to_char(coalesce(dt_geracao,clock_timestamp()),'yyyymmdd'), 
	coalesce(id_ope_prest,'2'), 
	lpad(coalesce(nr_registro_ans,'0'),6,'0') 
into STRICT	cd_unimed_destino_w, 
	cd_unimed_origem_w, 
	dt_geracao_w, 
	id_ope_prest_w, 
	nr_registro_ans_w 
from	ptu_movimento_prestador 
where	nr_sequencia = nr_seq_lote_p;
 
nr_seq_registro_w := nr_seq_registro_w + 1;
 
ds_conteudo_w	:=	lpad(nr_seq_registro_w,8,'0') || '401' || cd_unimed_destino_w || cd_unimed_origem_w || dt_geracao_w || '26' || id_ope_prest_w || 
			nr_registro_ans_w;
ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;
 
utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
utl_file.fflush(arq_texto_w);
ds_conteudo_w := null;
nr_registro_ans_w := null;
 
-- 402 PRESTADOR (OBRIGATÓRIO) 
open C01;
loop 
fetch C01 into	 
	nr_seq_ptu_prestador_w, 
	tp_prest_w, 
	cd_prest_w, 
	cd_cgc_cpf_w, 
	cd_insc_est_w, 
	nr_conselho_w, 
	cd_uf_conselho_w, 
	nm_fantasia_w, 
	tp_vinculo_w, 
	cd_espec_1_w, 
	cd_atua_1_w, 
	cd_espec_2_w, 
	cd_atua_2_w, 
	dt_incl_uni_w, 
	dt_excl_uni_w, 
	tp_contratualizacao_w, 
	tp_class_estabelec_w, 
	id_cat_dif_w, 
	id_acid_trab_w, 
	id_urg_emer_w, 
	id_rce_espec_1_w, 
	id_rce_atua_1_w, 
	id_rce_espec_2_w, 
	id_rce_atua_2_w, 
	dt_ini_servico_w, 
	dt_ini_contrato_w, 
	nr_registro_ans_w, 
	nm_diretor_tecnico_w, 
	tp_disponibilidade_w, 
	id_tab_propria_w, 
	cd_perfil_assist_w, 
	id_tp_prod_w, 
	id_guia_medico_w, 
	sg_cons_diretor_tecnico_w, 
	cd_cons_diretor_tecnico_w, 
	sg_uf_cons_diretor_tecnico_w, 
	tipo_rede_min_w, 
	id_guia_medico_espec_1_w, 
	id_guia_medico_espec_2_w, 
	id_guia_medico_atua_1_w, 
	id_guia_medico_atua_2_w, 
	particip_notivisa_w, 
	particip_qualiss_ans_w, 
	nr_rce_espec_1_w, 
	nr_rce_espec_2_w, 
	nr_rce_2_espec_1_w, 
	nr_rce_2_espec_2_w, 
	nr_rce_atua_1_w, 
	nr_rce_atua_2_w, 
	nr_rce_2_atua_1_w, 
	nr_rce_2_atua_2_w, 
	indic_pos_grad_w, 
	nm_prest_w, 
	id_publica_ans_w, 
	nr_cbo_w, 
	indic_residencia_w, 
	cd_uni_prestadora_w, 
	id_login_wsd_tiss_w, 
	id_cadu_w, 
	id_inativo_w, 
	sg_conselho_w, 
	nr_seq_prestador_w, 
	ie_ind_ginec_obst_w, 
	ie_sexo_w, 
	dt_atualizacao_cad_w, 
	cod_titulacao_1_w, 
	cod_titulacao_2_w, 
	indic_resid_espec_1_w, 
	indic_resid_espec_2_w, 
	indic_resid_area_1_w, 
	indic_resid_area_2_w, 
	ie_doutorado_pos_w, 
	id_iso9001_w, 
	indic_mestrado_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	nr_seq_registro_w := nr_seq_registro_w + 1;
	 
	ds_conteudo_w	:=	lpad(nr_seq_registro_w,8,'0') || '402' || tp_prest_w || cd_prest_w || cd_cgc_cpf_w || cd_insc_est_w || lpad(' ',8,' ') || 		 
				cd_uf_conselho_w || lpad(' ',40,' ') || lpad(' ',40,' ') || tp_vinculo_w || cd_espec_1_w || cd_atua_1_w || cd_espec_2_w || cd_atua_2_w || 
				lpad(' ',12,' ') || dt_incl_uni_w || dt_excl_uni_w || tp_contratualizacao_w || tp_class_estabelec_w || id_cat_dif_w || id_acid_trab_w || 
				' ' || id_urg_emer_w || id_rce_espec_1_w || id_rce_atua_1_w || id_rce_espec_2_w || id_rce_atua_2_w || '  ' || dt_ini_servico_w || 
				dt_ini_contrato_w || nr_registro_ans_w || lpad(' ',40,' ') || lpad(' ',8,' ') || tp_disponibilidade_w || id_tab_propria_w || 
				cd_perfil_assist_w || id_tp_prod_w || id_guia_medico_w || sg_cons_diretor_tecnico_w || cd_cons_diretor_tecnico_w || 
				sg_uf_cons_diretor_tecnico_w || tipo_rede_min_w || id_guia_medico_espec_1_w || id_guia_medico_espec_2_w || id_guia_medico_atua_1_w || 
				id_guia_medico_atua_2_w || ' ' || particip_notivisa_w || particip_qualiss_ans_w || nr_rce_espec_1_w || nr_rce_espec_2_w || 
				nr_rce_2_espec_1_w || nr_rce_2_espec_2_w || nr_rce_atua_1_w || nr_rce_atua_2_w || nr_rce_2_atua_1_w || nr_rce_2_atua_2_w || 
				indic_pos_grad_w || ' ' || nm_prest_w || id_publica_ans_w || nr_cbo_w || ' ' || cd_uni_prestadora_w || 
				id_login_wsd_tiss_w || id_cadu_w || id_inativo_w || sg_conselho_w || coalesce(ie_ind_ginec_obst_w, '0') || coalesce(ie_sexo_w,' ') || 
				dt_atualizacao_cad_w || cod_titulacao_1_w || cod_titulacao_2_w || indic_resid_espec_1_w || indic_resid_espec_2_w || 
				indic_resid_area_1_w || indic_resid_area_2_w || nm_fantasia_w || ie_doutorado_pos_w || nr_conselho_w || id_iso9001_w || nm_diretor_tecnico_w || indic_mestrado_w;
	pls_hash_ptu_pck.elimina_carac_linha_clob(ds_conteudo_w);
	ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;
	 
	utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
	utl_file.fflush(arq_texto_w);
	ds_conteudo_w := null;
	cd_cgc_cpf_w := null;
	 
	-- 403 ENDEREÇO (OBRIGATÓRIO) 
	open C02;
	loop 
	fetch C02 into	 
		nr_seq_ptu_endereco_w, 
		tp_end_w, 
		ds_end_w, 
		nr_end_w, 
		ds_bairro_w, 
		cd_munic_w, 
		nr_cep_w, 
		nr_ddd_w, 
		nr_fone_1_w, 
		nr_fone_2_w, 
		nr_fax_w, 
		ds_email_w, 
		ds_endereco_web_w, 
		cd_cnes_w, 
		nr_leitos_totais_w, 
		nr_leitos_contrat_w, 
		nr_leitos_psiquiat_w, 
		nr_uti_adulto_w, 
		nr_uti_neonatal_w, 
		nr_uti_pediatria_w, 
		cd_cgc_cpf_w, 
		nr_leitos_intermed_neo_w, 
		id_filial_w, 
		ds_compl_w, 
		nr_leitos_hosp_dia_w, 
		nr_leitos_tot_clinic_w, 
		nr_leitos_tot_cirur_w, 
		nr_leitos_tot_obstr_w, 
		nr_leitos_tot_pediat_w, 
		nr_leitos_tot_psiqu_w, 
		nr_latitude_w, 
		nr_longitude_w, 
		nr_leitos_intermed_w, 
		prest_acred_w, 
		nr_referencia_end_w, 
		ds_email_sec_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
		nr_seq_registro_w := nr_seq_registro_w + 1;
		 
		ds_conteudo_w	:=	lpad(nr_seq_registro_w,8,'0') || '403' || tp_end_w || ds_end_w || nr_end_w || lpad(' ',15,' ') || ds_bairro_w || cd_munic_w || 
					nr_cep_w || nr_ddd_w || nr_fone_1_w || nr_fone_2_w || nr_fax_w || lpad(' ',90,' ') || cd_cnes_w || 
					nr_leitos_totais_w || nr_leitos_contrat_w || nr_leitos_psiquiat_w || nr_uti_adulto_w || nr_uti_neonatal_w || 
					nr_uti_pediatria_w || cd_cgc_cpf_w || nr_leitos_intermed_neo_w || id_filial_w || ds_compl_w || nr_leitos_hosp_dia_w || 
					nr_leitos_tot_clinic_w || nr_leitos_tot_cirur_w || nr_leitos_tot_obstr_w || nr_leitos_tot_pediat_w || nr_leitos_tot_psiqu_w || 
					nr_latitude_w || nr_longitude_w || nr_leitos_intermed_w || prest_acred_w || nr_referencia_end_w || ds_email_w || ds_email_sec_w || 
					ds_endereco_web_w;
		pls_hash_ptu_pck.elimina_carac_linha_clob(ds_conteudo_w);
		ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;
		 
		utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
		utl_file.fflush(arq_texto_w);
		ds_conteudo_w := null;
		 
		-- 404 GRUPO DE SERVIÇO (OBRIGATÓRIO) 
		open C03;
		loop 
		fetch C03 into	 
			cd_gr_serv_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin 
			nr_seq_registro_w := nr_seq_registro_w + 1;
			 
			ds_conteudo_w	:=	lpad(nr_seq_registro_w,8,'0') || '404' || cd_gr_serv_w;
			pls_hash_ptu_pck.elimina_carac_linha_clob(ds_conteudo_w);
			ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;
			 
			utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
			utl_file.fflush(arq_texto_w);
			ds_conteudo_w := null;
			 
			end;
		end loop;
		close C03;
		 
		end;
	end loop;
	close C02;
	 
	-- 405 REDE REFERENCIADA (OBRIGATÓRIO) 
	open C04;
	loop 
	fetch C04 into	 
		cd_rede_w, 
		nm_rede_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
		begin 
		nr_seq_registro_w := nr_seq_registro_w + 1;
		 
		ds_conteudo_w	:=	lpad(nr_seq_registro_w,8,'0') || '405' || cd_rede_w || ' ' || nm_rede_w;
		pls_hash_ptu_pck.elimina_carac_linha_clob(ds_conteudo_w);
		ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;
		 
		utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
		utl_file.fflush(arq_texto_w);
		ds_conteudo_w := null;
		 
		end;
	end loop;
	close C04;
	 
	-- 406 EXCLUSÃO / SUBSTITUIÇÃO (OPCIONAL) 
	open C05;
	loop 
	fetch C05 into	 
		ie_nivel_exclusao_ptu_w, 
		cd_exclusao_rede_w, 
		cd_exclusao_pla_prod_w, 
		nr_exclusao_end_w, 
		dt_termino_prest_w, 
		ie_substituicao_w, 
		cd_cnpj_cpf_substit_w, 
		dt_inicio_prest_w, 
		cd_motivo_exclusao_w;
	EXIT WHEN NOT FOUND; /* apply on C05 */
		begin 
		nr_seq_registro_w := nr_seq_registro_w + 1;
		 
		ds_conteudo_w	:=	lpad(nr_seq_registro_w,8,'0') || '406' || ie_nivel_exclusao_ptu_w || cd_exclusao_rede_w || cd_exclusao_pla_prod_w || nr_exclusao_end_w || 
					dt_termino_prest_w || ie_substituicao_w || cd_cnpj_cpf_substit_w || dt_inicio_prest_w || cd_motivo_exclusao_w;
		pls_hash_ptu_pck.elimina_carac_linha_clob(ds_conteudo_w);
		ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;
		 
		utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
		utl_file.fflush(arq_texto_w);
		ds_conteudo_w := null;
		end;
	end loop;
	close C05;
	 
	-- 407 IMPOSTOS (OPCIONAL) 
	open C06;
	loop 
	fetch C06 into	 
		cd_imposto_w, 
		vl_aliquota_w;
	EXIT WHEN NOT FOUND; /* apply on C06 */
		begin 
		nr_seq_registro_w := nr_seq_registro_w + 1;
		 
		ds_conteudo_w	:=	lpad(nr_seq_registro_w,8,'0') || '407' || cd_imposto_w || vl_aliquota_w;
		pls_hash_ptu_pck.elimina_carac_linha_clob(ds_conteudo_w);
		ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;
		 
		utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
		utl_file.fflush(arq_texto_w);
		ds_conteudo_w := null;
		end;
	end loop;
	close C06;
	 
	-- 408 QUALIFICAÇÃO DOS PRESTADORES DE SERVIÇO (OPCIONAL) (Continuação) 
	open C07;
	loop 
	fetch C07 into	 
		cd_cgc_cpf_w, 
		inst_acred_w, 
		nivel_acred_w, 
		nr_referencia_end_qualif_w;
	EXIT WHEN NOT FOUND; /* apply on C07 */
		begin 
		nr_seq_registro_w := nr_seq_registro_w + 1;
		 
		ds_conteudo_w	:=	lpad(nr_seq_registro_w,8,'0') || '408' || cd_cgc_cpf_w || inst_acred_w || ' ' || nivel_acred_w || nr_referencia_end_qualif_w;
		pls_hash_ptu_pck.elimina_carac_linha_clob(ds_conteudo_w);
		ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;
		 
		utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
		utl_file.fflush(arq_texto_w);
		ds_conteudo_w := null;
		end;
	end loop;
	close C07;
	 
	-- 410 OBSERVAÇÕES (OPCIONAL) 
	open C08;
	loop 
	fetch C08 into	 
		ds_divulga_obs_w;
	EXIT WHEN NOT FOUND; /* apply on C08 */
		begin 
		nr_seq_registro_w := nr_seq_registro_w + 1;
		 
		ds_conteudo_w	:=	lpad(nr_seq_registro_w,8,'0') || '410' || ds_divulga_obs_w;
		pls_hash_ptu_pck.elimina_carac_linha_clob(ds_conteudo_w);
		ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;
		 
		utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
		utl_file.fflush(arq_texto_w);
		ds_conteudo_w := null;
		end;
	end loop;
	close C08;
	 
	end;
end loop;
close C01;
 
-- 499 TRAILER (OBRIGATÓRIO) 
select	lpad(coalesce(substr(obter_qt_registro_ptu_a400(nr_seq_lote_p,'402'),1,7),'0'),7,'0'), 
	lpad(coalesce(substr(obter_qt_registro_ptu_a400(nr_seq_lote_p,'403'),1,7),'0'),7,'0'), 
	lpad(coalesce(substr(obter_qt_registro_ptu_a400(nr_seq_lote_p,'404'),1,7),'0'),7,'0'), 
	lpad(coalesce(substr(obter_qt_registro_ptu_a400(nr_seq_lote_p,'405'),1,7),'0'),7,'0'), 
	lpad(coalesce(substr(obter_qt_registro_ptu_a400(nr_seq_lote_p,'406'),1,7),'0'),7,'0'), 
	lpad(coalesce(substr(obter_qt_registro_ptu_a400(nr_seq_lote_p,'407'),1,7),'0'),7,'0'), 
	lpad(coalesce(substr(obter_qt_registro_ptu_a400(nr_seq_lote_p,'408'),1,7),'0'),7,'0'), 
	lpad(coalesce(substr(obter_qt_registro_ptu_a400(nr_seq_lote_p,'410'),1,7),'0'),7,'0') 
into STRICT	qt_tot_r402_w, 
	qt_tot_r403_w, 
	qt_tot_r404_w, 
	qt_tot_r405_w, 
	qt_tot_r406_w, 
	qt_tot_r407_w, 
	qt_tot_r408_w, 
	qt_tot_r410_w
;
 
nr_seq_registro_w := nr_seq_registro_w + 1;
 
ds_conteudo_w	:=	lpad(nr_seq_registro_w,8,'0') || '499' || qt_tot_r402_w || qt_tot_r403_w || qt_tot_r404_w || qt_tot_r405_w || qt_tot_r407_w || qt_tot_r408_w || 
			qt_tot_r410_w || qt_tot_r406_w;
ds_arquivo_w	:=	ds_arquivo_w || ds_conteudo_w;
 
utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
utl_file.fflush(arq_texto_w);
ds_conteudo_w := null;
 
-- 998 - HASH (OBRIGATÓRIO) 
nr_seq_registro_w :=	nr_seq_registro_w + 1;
ds_arquivo_w := pls_hash_ptu_pck.obter_hash_txt(ds_arquivo_w); -- Gerar HASH 
ds_conteudo_w 	:= 	lpad(nr_seq_registro_w,8,'0') ||
			'998' || 
			ds_hash_a400_w;
			 
 
utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
utl_file.fflush(arq_texto_w);
ds_conteudo_w := null;
			 
update	ptu_movimento_prestador 
set	ds_hash_a400	= ds_hash_a400_w 
where	nr_sequencia	= nr_seq_lote_p;
 
-- A Unimed Origem do arquivo não deve gerar o Registro 999. Ele será gerado exclusivamente pela Central de Movimentações Batch (CMB). 
-- 999 REGISTRO GERADO PELA CMB (OBRIGATÓRIO) 
/*nr_seq_registro_w := nr_seq_registro_w + 1; 
 
ds_conteudo_w :=	lpad(nr_seq_registro_w,8,'0') || '999' || 
 
utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13)); 
utl_file.fflush(arq_texto_w); 
ds_conteudo_w := null;*/
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_gerar_arq_mov_prestador_81 (nr_seq_lote_p bigint, cd_interface_p text, nm_usuario_p text, ds_local_p text, nm_arquivo_p text) FROM PUBLIC;

