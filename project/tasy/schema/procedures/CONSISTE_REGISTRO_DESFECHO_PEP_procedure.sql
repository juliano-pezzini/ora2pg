-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_registro_desfecho_pep ( nr_atendimento_p bigint, cd_pessoa_usuario_p text, nm_usuario_p text) AS $body$
DECLARE


qt_consulta_w				integer;
cd_medico_resp_w			varchar(10);
cd_medico_aux_w				varchar(10);
qt_prescricao_w				varchar(255);
qt_prescr_lib_w				integer;
qt_alta_w					bigint;
ie_gera_desfecho_medic_w	varchar(5);
ie_assumir_aux_w			varchar(5);
ie_desfecho_w				varchar(5);
ie_desfecho_proc_w			varchar(5);
ie_refazer_desfecho_w		varchar(5);
ie_desf_w					varchar(5);
ds_mensagem_w				varchar(2000);


BEGIN

ie_gera_desfecho_medic_w := obter_param_usuario(935, 124, Obter_perfil_Ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_gera_desfecho_medic_w);
ie_assumir_aux_w := obter_param_usuario(935, 64, Obter_perfil_Ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_assumir_aux_w);
ie_desfecho_w := obter_param_usuario(935, 9, Obter_perfil_Ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_desfecho_w);
ie_desfecho_proc_w := obter_param_usuario(935, 80, Obter_perfil_Ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_desfecho_proc_w);
ie_refazer_desfecho_w := obter_param_usuario(935, 113, Obter_perfil_Ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_refazer_desfecho_w);

select 	count(*)
into STRICT	qt_consulta_w
from 	atendimento_ps_v
where 	(hr_inicio_consulta IS NOT NULL AND hr_inicio_consulta::text <> '')
and 	nr_atendimento = nr_atendimento_p;

if (qt_consulta_w = 0) then
	ds_mensagem_w := obter_desc_expressao(956430)||chr(10);
end if;

SELECT 	max(cd_medico_resp)
into STRICT	cd_medico_resp_w
FROM 	atendimento_ps_v
WHERE 	nr_atendimento = nr_atendimento_p;

SELECT 	max(cd_medico_aux)
into STRICT	cd_medico_aux_w
FROM 	atendimento_ps_v
WHERE 	nr_atendimento = nr_atendimento_p;

if not(((coalesce(cd_medico_resp_w,0) = cd_pessoa_usuario_p) or (ie_gera_desfecho_medic_w = 'S')) or
	((coalesce(cd_medico_aux_w,0) = cd_pessoa_usuario_p) and (ie_assumir_aux_w = 'S'))) then

	ds_mensagem_w := ds_mensagem_w||obter_desc_expressao(956432)||chr(10);

end if;

SELECT 	max(qt_prescricao)
into STRICT	qt_prescricao_w
FROM 	atendimento_ps_v
where 	nr_atendimento = nr_atendimento_p;

if((ie_desfecho_w <> 'S') and (coalesce(position('Med' in qt_prescricao_w),0) > 0 )) then

	ds_mensagem_w := ds_mensagem_w||obter_desc_expressao(956434)||chr(10);

end if;

SELECT 	max(Obter_qt_prescr_sem_lib(nr_atendimento))
into STRICT	qt_prescr_lib_w
FROM  	atendimento_ps_v
where 	nr_atendimento = nr_atendimento_p;

if	(ie_desfecho_proc_w <> 'S' AND qt_prescr_lib_w > 0) then

	ds_mensagem_w := ds_mensagem_w||obter_desc_expressao(956436)||chr(10);

end if;

select 	count(*)
into STRICT	qt_alta_w
from 	ATENDIMENTO_ALTA a, parametro_medico p
where 	a.nr_atendimento = nr_atendimento_p
and     p.cd_estabelecimento = obter_estabelecimento_ativo
and     ((ie_tipo_orientacao <> 'P')
or      ((a.ie_tipo_orientacao = 'P') and (coalesce(p.ie_liberar_desfecho,'N') = 'N') or ((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') and (coalesce(a.dt_inativacao::text, '') = ''))));

if(ie_refazer_desfecho_w <> 'S' AND qt_alta_w > 0 ) then
	ds_mensagem_w := ds_mensagem_w||obter_desc_expressao(956438);
end if;

if (qt_consulta_w <> 0) and
	(((cd_medico_resp_w = cd_pessoa_usuario_p) or (ie_gera_desfecho_medic_w = 'S')) or
	(cd_medico_aux_w = cd_pessoa_usuario_p AND ie_assumir_aux_w = 'S')) and
	((ie_desfecho_w <> 'N') or (coalesce(position('Med' in qt_prescricao_w),0) = 0 )) and
	((ie_desfecho_proc_w = 'S') or (qt_prescr_lib_w = 0)) and
	((ie_refazer_desfecho_w = 'S') or (qt_alta_w = 0))then
		ie_desf_w	:= 'I';
	else
		CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(obter_desc_expressao(956440)||chr(10)||ds_mensagem_w);

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_registro_desfecho_pep ( nr_atendimento_p bigint, cd_pessoa_usuario_p text, nm_usuario_p text) FROM PUBLIC;

