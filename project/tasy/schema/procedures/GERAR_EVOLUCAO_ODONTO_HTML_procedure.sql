-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_evolucao_odonto_html ( nr_seq_consulta_p bigint, nr_seq_origem_p bigint, cd_evolucao_origem_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_medico_w			varchar(10);
ie_nivel_atencao_w	varchar(1);
cd_evolucao_w		bigint;
nr_atendimento_w	bigint;
cd_pessoa_fisica_w	bigint;

cd_tipo_evolucao_w 	tipo_evolucao.cd_tipo_evolucao%type := Obter_Param_Usuario_padrao(281,226, obter_perfil_ativo, nm_usuario_p ,obter_estabelecimento_ativo);


BEGIN

if (cd_evolucao_origem_p IS NOT NULL AND cd_evolucao_origem_p::text <> '') then


	Select  max(ie_tipo_evolucao),
			max(nr_atendimento),
			max(cd_pessoa_fisica)
	into STRICT	cd_tipo_evolucao_w,
			nr_atendimento_w,
			cd_pessoa_fisica_w
	from	W_EVOLUCAO_GRUPO_FAMILIAR
	where	NR_SEQUENCIA = cd_evolucao_origem_p;


	cd_medico_w	:= Obter_Pf_Usuario(nm_usuario_p,'C');
	ie_nivel_atencao_w	:= wheb_assist_pck.get_nivel_atencao_perfil;

	Select 	nextval('evolucao_paciente_seq')
	into STRICT	cd_evolucao_w
	;

	insert into evolucao_paciente(
		cd_evolucao,
		dt_evolucao,
		ie_evolucao_clinica,
		ie_tipo_evolucao,
		cd_pessoa_fisica,
		dt_atualizacao,
		nm_usuario,
		nr_atendimento,
		cd_medico,
		ie_situacao,
		ie_nivel_atencao)
	values (	cd_evolucao_w,
		clock_timestamp(),
		cd_tipo_evolucao_w,
		'ODT',
		cd_pessoa_fisica_w,
		clock_timestamp(),
		nm_usuario_p,
		nr_atendimento_w,
		cd_medico_w,
		'A',
		ie_nivel_atencao_w);


		copia_campo_long_de_para_java('W_EVOLUCAO_GRUPO_FAMILIAR',
				 'DS_EVOLUCAO',
				 'where nr_sequencia = :cd_evolucao_origem',
				 'cd_evolucao_origem='||cd_evolucao_origem_p,
				 'EVOLUCAO_PACIENTE',
				 'DS_EVOLUCAO',
				 'where cd_evolucao = :cd_evolucao',
				 'cd_evolucao='||cd_evolucao_w,
				 'L');


		commit;


		CALL gerar_evolucao_vinculo(nr_seq_consulta_p,cd_evolucao_w,'OD',nr_seq_origem_p);


		commit;


end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_evolucao_odonto_html ( nr_seq_consulta_p bigint, nr_seq_origem_p bigint, cd_evolucao_origem_p bigint, nm_usuario_p text) FROM PUBLIC;

