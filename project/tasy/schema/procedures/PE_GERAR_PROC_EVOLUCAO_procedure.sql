-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pe_gerar_proc_evolucao ( nr_seq_evolucao_p bigint, qt_hora_inicio_p bigint, qt_min_inicio_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_proc_w			bigint;
cd_intervalo_w			varchar(7);
ds_horario_w			varchar(80);

C01 CURSOR FOR 
	SELECT	b.nr_seq_proc, 
       	p.cd_intervalo 
 	from pe_procedimento p, 
    	pe_item_result_proc b, 
      	pe_evolucao_resultado e 
 where   e.nr_seq_evolucao = nr_seq_evolucao_p 
  and   e.nr_seq_resultado = b.nr_seq_Result 
  and   b.nr_seq_proc = p.nr_sequencia;


BEGIN 
 
delete from pe_evolucao_proc 
where nr_seq_evolucao 	= nr_seq_evolucao_p;
 
OPEN C01;
LOOP 
   FETCH C01 into 	 
		nr_seq_proc_w, 
		cd_intervalo_w;
    EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		insert into pe_evolucao_proc( 
			NR_SEQ_EVOLUCAO, NR_SEQ_PROC, DT_ATUALIZACAO, 
			NM_USUARIO, CD_INTERVALO, DS_HORARIO) 
		values ( 
			nr_seq_evolucao_p, nr_seq_proc_w, clock_timestamp(), 
			nm_usuario_p, cd_intervalo_w, ds_horario_w);
		exception 
			when others then 
			nr_seq_proc_w := nr_seq_proc_w;
		end;
END LOOP;
CLOSE C01;
commit;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pe_gerar_proc_evolucao ( nr_seq_evolucao_p bigint, qt_hora_inicio_p bigint, qt_min_inicio_p bigint, nm_usuario_p text) FROM PUBLIC;

