-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pathox_laudo_acesso_dicom (nr_atendimento_p bigint, dt_exame_p timestamp, dt_liberacao_p timestamp, cd_medico_p text, ds_titulo_p text, ds_dir_laudo_pdf_p text, nr_acesso_dicom_p text, ds_patologia_ext_p text default null, nr_seq_conselho_p bigint default 0) AS $body$
DECLARE


cd_pessoa_fisica_w      pessoa_fisica.cd_pessoa_fisica%type;
nr_laudo_w              laudo_paciente.nr_laudo%type;
nr_seq_laudo_w          laudo_paciente.nr_sequencia%type;
nr_seq_imagem_w         laudo_paciente_imagem.nr_sequencia%type;
nr_prescricao_w         laudo_paciente.nr_prescricao%type;
nr_seq_prescricao_w     laudo_paciente.nr_seq_prescricao%type;
nr_seq_imagem_pac_ext_w IMAGEM_PAC_PROT_EXTERNO.nr_sequencia%type;
nr_sequencia_ww         laudo_paciente.nr_sequencia%type;
ie_alterar_medico_conta_w 	    varchar(2);
ie_alterar_medico_exec_conta_w	varchar(2);
ie_status_execucao_w	 varchar(3);
nr_crm_w		           varchar(20);
uf_crm_w		           varchar(2);
pos_inicio_uf_w		     bigint;
cd_medico_w            varchar(15);
ie_lado_w		           varchar(15);
cd_medico_exec_w	     varchar(10);
cd_estabelecimento_w	smallint;
nr_seq_proc_interno_w	 bigint;
cd_procedimento_w	     bigint;
ie_origem_proced_w	   bigint;
qt_procedimento_w	     bigint;
cd_setor_atendimento_w bigint;
nr_seq_exame_w		     bigint;
nr_seq_propaci_w	     bigint;
nr_atendimento_w	     bigint;
dt_prev_execucao_w	   timestamp;
dt_entrada_unidade_w	 timestamp;
dt_procedimento_w	     timestamp;
ie_cancelar_laudo_w   varchar(2);

BEGIN
  select  max(a.cd_pessoa_fisica)
  into STRICT    cd_pessoa_fisica_w
  from    atendimento_paciente a
  where   a.nr_atendimento = nr_atendimento_p;

  select  nextval('imagem_pac_prot_externo_seq')
  into STRICT    nr_seq_imagem_pac_ext_w
;

  select  coalesce(max(nr_laudo),0)
  into STRICT    nr_laudo_w
  from    laudo_paciente
  where   nr_atendimento = nr_atendimento_p;

  pos_inicio_uf_w := length(cd_medico_p) - 2;
  nr_crm_w := substr(cd_medico_p,1,pos_inicio_uf_w);
  uf_crm_w := substr(cd_medico_p,pos_inicio_uf_w + 1,2);

BEGIN
    if coalesce(nr_seq_conselho_p,0) > 0 then
        select  m.cd_pessoa_fisica
        into STRICT    cd_medico_w
        from    medico m
        inner join pessoa_fisica pf on pf.cd_pessoa_fisica = m.cd_pessoa_fisica
        inner join conselho_profissional cp on cp.nr_sequencia = pf.nr_seq_conselho and pf.nr_seq_conselho = nr_seq_conselho_p
        where   m.nr_crm = nr_crm_w
        and     m.uf_crm = uf_crm_w;
    else
        select  m.cd_pessoa_fisica
        into STRICT    cd_medico_w
        from    medico m
        inner join pessoa_fisica pf on pf.cd_pessoa_fisica = m.cd_pessoa_fisica
        inner join conselho_profissional cp on cp.nr_sequencia = pf.nr_seq_conselho and cp.sg_conselho = 'CRM'
        where   m.nr_crm = nr_crm_w
        and     m.uf_crm = uf_crm_w;
    end if;
EXCEPTION
    WHEN no_data_found or too_many_rows THEN
        cd_medico_w := null;
END;

  select nr_prescricao, 
         nr_sequencia
  into STRICT   nr_prescricao_w,
         nr_seq_prescricao_w
  from   prescr_procedimento b 
  where  nr_acesso_dicom = nr_acesso_dicom_p;

  if (coalesce(nr_prescricao_w,0) > 0) and (coalesce(nr_seq_prescricao_w,0) > 0) then
    select coalesce(max(nr_sequencia),0),
           max(nr_atendimento),
           max(dt_entrada_unidade),
           max(dt_procedimento)
      into STRICT nr_seq_propaci_w,
           nr_atendimento_w,
           dt_entrada_unidade_w,
           dt_procedimento_w
     from procedimento_paciente
    where nr_prescricao = nr_prescricao_w
      and nr_sequencia_prescricao	= nr_seq_prescricao_w
      and coalesce(nr_seq_proc_princ::text, '') = '';

    select nr_prescricao,
          nr_sequencia,
          nr_seq_proc_interno,
          cd_procedimento,
          ie_origem_proced,
          qt_procedimento,
          cd_setor_atendimento,
          cd_medico_exec,
          nr_seq_exame,
          coalesce(ie_lado,'A'),
          dt_prev_execucao
    into STRICT  nr_prescricao_w,
          nr_seq_prescricao_w,
          nr_seq_proc_interno_w,
          cd_procedimento_w,
          ie_origem_proced_w,
          qt_procedimento_w,
          cd_setor_atendimento_w,
          cd_medico_exec_w,
          nr_seq_exame_w,
          ie_lado_w,
          dt_prev_execucao_w
     from prescr_procedimento
    where nr_acesso_dicom = nr_acesso_dicom_p;

      if (nr_seq_propaci_w = 0) then
        CALL Gerar_Proc_Pac_item_Prescr(	nr_prescricao_w,
                                    nr_seq_prescricao_w, 
                                    null, 
                                    null,
                                    nr_seq_proc_interno_w,
                                    cd_procedimento_w, 
                                    ie_origem_proced_w,
                                    qt_procedimento_w, 
                                    cd_setor_atendimento_w,
                                    9, 
                                    dt_prev_execucao_w,
                                    'Pathox', 
                                    cd_medico_exec_w, 
                                    null,
                                    ie_lado_w, 
                                    null);

        select max(nr_sequencia),
               max(nr_atendimento),
               max(dt_entrada_unidade),
               max(dt_procedimento)
          into STRICT nr_seq_propaci_w,
               nr_atendimento_w,
               dt_entrada_unidade_w,
               dt_procedimento_w
          from procedimento_paciente
         where nr_prescricao = nr_prescricao_w
           and nr_sequencia_prescricao	= nr_seq_prescricao_w
           and coalesce(nr_seq_proc_princ::text, '') = '';
      end if;
   end if;

 select max(cd_estabelecimento)
   into STRICT	cd_estabelecimento_w
	 from	prescr_medica
	where	nr_prescricao = nr_prescricao_w;

   select coalesce(max(ie_cancelar_laudo),'N')
      	into STRICT ie_cancelar_laudo_w
		from PARAMETRO_INTEGRACAO_PACS
	where cd_estabelecimento = cd_estabelecimento_w;	

			if (ie_cancelar_laudo_w = 'S') then
				begin
				select  MAX(nr_sequencia)
				  into STRICT	nr_sequencia_ww
				  from 	laudo_paciente
				where   nr_prescricao = nr_prescricao_w
				 and	nr_seq_prescricao = nr_seq_prescricao_w;

				if (coalesce(nr_sequencia_ww,0)<>0) then
					begin
						CALL cancelar_laudo_paciente(nr_sequencia_ww,'C','Pathox','');
					end;
				end if;
			 end;
			end if;

  insert into  IMAGEM_PAC_PROT_EXTERNO(
      nr_sequencia,
      nr_atendimento,
      cd_pessoa_fisica,
      DT_EXAME,
      DT_LIBERACAO,
      cd_medico,
      dt_atualizacao,
      dt_atualizacao_nrec,
      nm_usuario,
      nm_usuario_nrec)
  values (
      nr_seq_imagem_pac_ext_w,
      nr_atendimento_p,
      cd_pessoa_fisica_w,
      dt_exame_p,
      coalesce(dt_liberacao_p,clock_timestamp()),
      cd_medico_w,
      clock_timestamp(),
      clock_timestamp(),
      'Pathox',
      'Pathox');

  select  nextval('laudo_paciente_seq')
  into STRICT    nr_seq_laudo_w
;

 insert into laudo_paciente(nr_sequencia,
                            nr_atendimento,
                            dt_entrada_unidade,
                            nr_laudo,
                            nm_usuario,
                            dt_atualizacao,
                            cd_medico_resp,
                            ds_titulo_laudo,
                            dt_laudo,
                            nr_prescricao,
                          --	ds_laudo,
                            nr_seq_proc,
                            nr_seq_prescricao,
                            dt_liberacao,
                            qt_imagem,
                            nm_medico_solicitante,
                            ie_status_laudo,
                            cd_laudo_externo,
                            dt_exame,
							ds_arquivo,
							ie_formato,
							dt_aprovacao)
                			values (nr_seq_laudo_w,
                             nr_atendimento_w,
                             dt_entrada_unidade_w,
                             nr_laudo_w,
                             'Pathox',
                             clock_timestamp(),
                             cd_medico_w,
                             ds_titulo_p,
                             coalesce(dt_liberacao_p,clock_timestamp()),
                             nr_prescricao_w,
                            --	ds_laudo_w,
                             nr_seq_propaci_w,
                             nr_seq_prescricao_w,
                             coalesce(dt_liberacao_p,clock_timestamp()),
                             0,
                             cd_medico_w,
                             'LL',
                             null,
                             dt_procedimento_w,
							 ds_dir_laudo_pdf_p,
							 '3',
							  coalesce(dt_liberacao_p,clock_timestamp()));



  ie_alterar_medico_conta_w 	:= Obter_Valor_Param_Usuario(28 ,101 , obter_perfil_ativo ,null,cd_estabelecimento_w);
	ie_alterar_medico_exec_conta_w 	:= Obter_Valor_Param_Usuario(28 ,112 , obter_perfil_ativo ,null,cd_estabelecimento_w);

  if (ie_alterar_medico_conta_w = 'S') then
		CALL Atualizar_Propaci_Medico_Laudo(nr_seq_laudo_w,'EX','Pathox');
	end if;

	if (ie_alterar_medico_exec_conta_w = 'S') then
		CALL Atualizar_Propaci_Medico_Laudo(nr_seq_laudo_w,'EXC','Pathox');
	end if;


  select (coalesce(max(nr_seq_imagem),0) + 1)
  into STRICT	nr_seq_imagem_w
  from	laudo_paciente_imagem
  where	nr_sequencia = nr_seq_laudo_w;

  update	procedimento_paciente
	 set	nr_laudo	= nr_seq_laudo_w
	where	nr_sequencia	= nr_seq_propaci_w;

	update	prescr_procedimento a
		set	a.ie_status_execucao 	= '40',
	  		a.nm_usuario 	= 'Pathox'
	where	a.nr_prescricao = nr_prescricao_w
		and	a.nr_sequencia  in (SELECT	b.nr_sequencia_prescricao
                  					  from	procedimento_paciente b
                             where	b.nr_prescricao 	= a.nr_prescricao
                               and	b.nr_sequencia_prescricao = a.nr_sequencia
                               and	b.nr_laudo 		= nr_seq_prescricao_w);

  select max(ie_status_execucao)
    into STRICT	ie_status_execucao_w
	 from	prescr_procedimento a
	where	a.nr_prescricao = nr_prescricao_w
		and	a.nr_sequencia  = nr_seq_prescricao_w;

	if (ie_status_execucao_w <> '40') then
   update	prescr_procedimento a
			set	a.ie_status_execucao = '40',
	  			a.nm_usuario 	= 'Pathox'
		where	a.nr_prescricao = nr_prescricao_w
			and	a.nr_sequencia  in (	SELECT	b.nr_sequencia_prescricao
                    							from	procedimento_paciente b
                                 where	b.nr_prescricao = a.nr_prescricao
                                   and 	b.nr_prescricao = nr_prescricao_w
                                   and	b.nr_sequencia_prescricao = a.nr_sequencia
                                   and	b.nr_sequencia_prescricao = nr_seq_prescricao_w);
	end if;

  insert into laudo_paciente_imagem(
      nr_sequencia,
      nr_seq_imagem,
      DS_ARQUIVO_IMAGEM,
      nm_usuario,    
      dt_atualizacao,
	  ds_patologia_ext
      )
  values (
      nr_seq_laudo_w,
      nr_seq_imagem_w,
      ds_dir_laudo_pdf_p,
      'Pathox',      
      clock_timestamp(),
	  ds_patologia_ext_p
  );

commit;

end;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pathox_laudo_acesso_dicom (nr_atendimento_p bigint, dt_exame_p timestamp, dt_liberacao_p timestamp, cd_medico_p text, ds_titulo_p text, ds_dir_laudo_pdf_p text, nr_acesso_dicom_p text, ds_patologia_ext_p text default null, nr_seq_conselho_p bigint default 0) FROM PUBLIC;

