-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE com_desvincular_os_sd_js ( nm_usuario_p text, nr_seq_solic_p bigint, nr_ordem_servico_p bigint) AS $body$
DECLARE


ds_historico_w		varchar(255);

nr_seq_localizacao_w	man_localizacao.nr_sequencia%type;
cd_cnpj_w				man_localizacao.cd_cnpj%type;
nr_seq_idioma_w			pessoa_juridica.nr_seq_idioma%type;


BEGIN

if (coalesce(nr_seq_solic_p,0) > 0) then

	update	com_solic_sd
	set	nr_ordem_servico  = NULL,
		ie_status = 'A',
		nm_usuario = nm_usuario_p,
		dt_atualizacao = clock_timestamp()
	where	nr_sequencia = nr_seq_solic_p;

	delete	FROM man_ordem_serv_sd
	where	nr_seq_solic_sd = nr_seq_solic_p;

	ds_historico_w := substr(obter_texto_dic_objeto(326349, wheb_usuario_pck.get_nr_seq_idioma, 'NR_SOLICITACAO='||nr_seq_solic_p),1,255);

	select	nr_seq_localizacao
	into STRICT	nr_seq_localizacao_w
	from	man_ordem_servico
	where	nr_sequencia = nr_ordem_servico_p;

	if (nr_seq_localizacao_w IS NOT NULL AND nr_seq_localizacao_w::text <> '') then
		select	max(a.cd_cnpj)
		into STRICT	cd_cnpj_w
		from	man_localizacao	a
		where	a.nr_sequencia	= nr_seq_localizacao_w;

		if (cd_cnpj_w IS NOT NULL AND cd_cnpj_w::text <> '') then
			select	max(a.nr_seq_idioma)
			into STRICT	nr_seq_idioma_w
			from	pessoa_juridica	a
			where	a.cd_cgc	= cd_cnpj_w;

			if (nr_seq_idioma_w IS NOT NULL AND nr_seq_idioma_w::text <> '') then
				-- Retorna com o idioma do cliente que abriu a OS.
				ds_historico_w := substr(obter_desc_expressao_idioma(326349, ds_historico_w, nr_seq_idioma_w), 1, 255);

			end if;
		end if;
	end if;

	insert into man_ordem_serv_tecnico(
						nr_sequencia,
						nr_seq_ordem_serv,
						dt_atualizacao,
						nm_usuario,
						ds_relat_tecnico,
						cd_versao_tasy,
						dt_historico,
						ie_origem,
						nr_seq_tipo,
						nm_usuario_lib,
						dt_liberacao,
						ie_grau_satisfacao)
	values (
		nextval('man_ordem_serv_tecnico_seq'),
		nr_ordem_servico_p,
		clock_timestamp(),
		nm_usuario_p,
		ds_historico_w,
		null,
		clock_timestamp(),
		'I',
		1,
		nm_usuario_p,
		clock_timestamp(),
		null);

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE com_desvincular_os_sd_js ( nm_usuario_p text, nr_seq_solic_p bigint, nr_ordem_servico_p bigint) FROM PUBLIC;

