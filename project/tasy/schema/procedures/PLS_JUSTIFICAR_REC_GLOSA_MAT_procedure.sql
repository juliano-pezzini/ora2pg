-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_justificar_rec_glosa_mat (nr_seq_rec_glosa_mat_p pls_rec_glosa_mat.nr_sequencia%type, ds_justificativa_oper_p pls_rec_glosa_proc.ds_justificativa_oper%type, vl_acatado_p pls_rec_glosa_proc.vl_acatado%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_mot_lib_glosa_p pls_mot_rec_glosa.nr_sequencia%type) AS $body$
DECLARE


nr_seq_mat_imp_w	pls_rec_glosa_mat.nr_seq_conta_mat_imp%type;
vl_recursado_w		pls_rec_glosa_mat.vl_recursado%type;
ie_status_w		pls_rec_glosa_mat.ie_status%type := '1';
nr_seq_conta_rec_w	pls_rec_glosa_conta.nr_sequencia%type;
nr_seq_conta_mat_w	pls_rec_glosa_mat.nr_seq_conta_mat%type;
vl_saldo_w		double precision;


BEGIN

begin

select	vl_recursado,
	nr_seq_conta_rec,
	nr_seq_conta_mat
into STRICT	vl_recursado_w,
	nr_seq_conta_rec_w,
	nr_seq_conta_mat_w
from	pls_rec_glosa_mat
where	nr_sequencia	= nr_seq_rec_glosa_mat_p;
exception
when others then
	vl_recursado_w	:= 0;
end;

vl_saldo_w		:= pls_obter_saldo_rec_glosa_mat(nr_seq_conta_mat_w, nr_seq_rec_glosa_mat_p);

if (vl_acatado_p > vl_recursado_w) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(288538); -- O valor acatado não pode ser superior ao valor recursado!
elsif (vl_acatado_p < 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(288539); --O valor acatado não pode ser negativo!
elsif (vl_acatado_p > vl_saldo_w) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(330213); --O valor acatado não pode ser maior que o valor do saldo do item!
elsif (vl_acatado_p = 0) then
	ie_status_w		:= '4'; -- Negado
	CALL pls_gerar_log_rec_glosa( 'NIM', vl_recursado_w, nr_seq_rec_glosa_mat_p, nm_usuario_p, 'M', null, nr_seq_mot_lib_glosa_p);
elsif (vl_acatado_p < vl_saldo_w) then
	ie_status_w		:= '2'; -- Parcialmente acatado
	CALL pls_gerar_log_rec_glosa( 'APIM', vl_recursado_w, nr_seq_rec_glosa_mat_p, nm_usuario_p, 'M', null, nr_seq_mot_lib_glosa_p);
elsif (vl_acatado_p = vl_saldo_w) then
	ie_status_w		:= '3'; -- Acatado
	CALL pls_gerar_log_rec_glosa( 'AIM', vl_recursado_w, nr_seq_rec_glosa_mat_p, nm_usuario_p, 'M', null, nr_seq_mot_lib_glosa_p);
end if;

update	pls_rec_glosa_mat
set	ds_justificativa_oper		= ds_justificativa_oper_p,
	vl_acatado			= vl_acatado_p,
	nm_usuario			= nm_usuario_p,
	dt_atualizacao			= clock_timestamp(),
	ie_status				= ie_status_w
where	nr_sequencia			= nr_seq_rec_glosa_MAT_p;

CALL pls_atualizar_valor_recurso(nr_seq_conta_rec_w,'C',nm_usuario_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_justificar_rec_glosa_mat (nr_seq_rec_glosa_mat_p pls_rec_glosa_mat.nr_sequencia%type, ds_justificativa_oper_p pls_rec_glosa_proc.ds_justificativa_oper%type, vl_acatado_p pls_rec_glosa_proc.vl_acatado%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_mot_lib_glosa_p pls_mot_rec_glosa.nr_sequencia%type) FROM PUBLIC;

