-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_solic_exame_agendamento ( nr_seq_pedido_exame_p bigint, nr_atendimento_p bigint, cd_profissional_p bigint, cd_pessoa_fisica_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_sequencia_p INOUT bigint) AS $body$
DECLARE


C01 CURSOR FOR
  SELECT nr_proc_interno
  from pedido_exame_externo_item
  where nr_seq_pedido  = nr_seq_pedido_exame_p;

ds_valor_w		varchar(1);
nr_sequencia_w bigint;

BEGIN

select coalesce(max(ie_gerar_solic_ext_aut), 'N')
into STRICT  ds_valor_w
from parametro_agenda_integrada
where cd_estabelecimento = cd_estabelecimento_p;

if (ds_valor_w = 'N') then
  return;
end if;

select max(nr_sequencia)
into STRICT nr_sequencia_w
from ageint_pendencia_exame
where nr_seq_pedido_ext = nr_seq_pedido_exame_p;

if (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') then
  nr_sequencia_p := nr_sequencia_w;
  return;
end if;

select nextval('ageint_pendencia_exame_seq')
into STRICT nr_sequencia_w
;

insert into ageint_pendencia_exame(
  nr_sequencia,
  dt_atualizacao,
  nm_usuario,
  dt_atualizacao_nrec,
  nm_usuario_nrec,
  cd_pessoa_fisica,
  dt_pendencia,
  cd_profissional,
  nr_seq_pedido_ext,
  cd_setor_atendimento
) values (
  nr_sequencia_w,
  clock_timestamp(),
  nm_usuario_p,
  clock_timestamp(),
  nm_usuario_p,
  cd_pessoa_fisica_p,
  clock_timestamp(),
  cd_profissional_p,
  nr_seq_pedido_exame_p,
  obter_setor_atendimento(nr_atendimento_p)
);

for c_01 in C01 loop

  insert into ageint_pend_exame_item(
    nr_sequencia,
    dt_atualizacao,
    nm_usuario,
    dt_atualizacao_nrec,
    nm_usuario_nrec,
    nr_seq_proc_interno,
    nr_seq_pendencia
  ) values (
    nextval('ageint_pend_exame_item_seq'),
    clock_timestamp(),
    nm_usuario_p,
    clock_timestamp(),
    nm_usuario_p,
    c_01.nr_proc_interno,
    nr_sequencia_w
  );

end loop;

nr_sequencia_p := nr_sequencia_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_solic_exame_agendamento ( nr_seq_pedido_exame_p bigint, nr_atendimento_p bigint, cd_profissional_p bigint, cd_pessoa_fisica_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, nr_sequencia_p INOUT bigint) FROM PUBLIC;

