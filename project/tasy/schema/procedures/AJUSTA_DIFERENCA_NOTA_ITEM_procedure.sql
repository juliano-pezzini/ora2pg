-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ajusta_diferenca_nota_item ( nr_sequencia_p bigint) AS $body$
DECLARE


cd_cgc_emitente_w		varchar(14);
cd_serie_nf_w			nota_fiscal.cd_serie_nf%type;
nr_nota_fiscal_w			varchar(255);
cd_natureza_operacao_w		smallint;
cd_cgc_emitente_ww		varchar(14);
cd_serie_nf_ww			nota_fiscal.cd_serie_nf%type;
nr_nota_fiscal_ww			varchar(255);
cd_natureza_operacao_ww		smallint;
qt_registro_w			integer;

c01 CURSOR FOR
SELECT	a.cd_cgc_emitente,
	a.cd_serie_nf,
	a.nr_nota_fiscal,
	a.cd_natureza_operacao
from	nota_fiscal_item a
where	a.nr_sequencia = nr_sequencia_p;


BEGIN

select	count(*)
into STRICT	qt_registro_w
from	nota_fiscal a,
	nota_fiscal_item b
where	a.nr_sequencia = b.nr_sequencia
and (a.cd_cgc_emitente <> b.cd_cgc_emitente or
	a.cd_serie_nf <> b.cd_serie_nf or
	a.nr_nota_fiscal <> b.nr_nota_fiscal or
	a.cd_natureza_operacao <> b.cd_natureza_operacao)
and	a.nr_sequencia = nr_sequencia_p;

if (qt_registro_w > 0) then

	select	a.cd_cgc_emitente,
		a.cd_serie_nf,
		a.nr_nota_fiscal,
		a.cd_natureza_operacao
	into STRICT	cd_cgc_emitente_w,
		cd_serie_nf_w,
		nr_nota_fiscal_w,
		cd_natureza_operacao_w
	from	nota_fiscal a
	where	a.nr_sequencia = nr_sequencia_p;

	open c01;
	loop
 		fetch c01 into
			cd_cgc_emitente_ww,
			cd_serie_nf_ww,
			nr_nota_fiscal_ww,
			cd_natureza_operacao_ww;
    		EXIT WHEN NOT FOUND; /* apply on C01 */

		if (cd_cgc_emitente_w <> cd_cgc_emitente_ww) then
			update	nota_fiscal_item
			set	cd_cgc_emitente 		= cd_cgc_emitente_w
			where	nr_sequencia		= nr_sequencia_p;
		end if;

		if (cd_serie_nf_w <> cd_serie_nf_ww) then
			update	nota_fiscal_item
			set	cd_serie_nf 		= cd_serie_nf_w
			where	nr_sequencia		= nr_sequencia_p;
		end if;

		if (nr_nota_fiscal_w <> nr_nota_fiscal_ww) then
			update	nota_fiscal_item
			set	nr_nota_fiscal 		= nr_nota_fiscal_w
			where	nr_sequencia		= nr_sequencia_p;
		end if;

		if (cd_natureza_operacao_w <> cd_natureza_operacao_ww) then
			update	nota_fiscal_item
			set	cd_natureza_operacao	= cd_natureza_operacao_w
			where	nr_sequencia		= nr_sequencia_p;
		end if;

	end loop;
	close C01;
end if;

commit;
end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ajusta_diferenca_nota_item ( nr_sequencia_p bigint) FROM PUBLIC;

