-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_adep_order_interface ( nr_atendimento_p bigint, id_sessao_p text, nm_usuario_p text) AS $body$
DECLARE

							
descricao_w         varchar(200);
dt_inicio_w         varchar(10);

ds_exp_inicio_w			varchar(100);
ds_date_mask_w  		varchar(30);
ds_dt_inicio_w 			varchar(50);
ds_material_w			  varchar(4000);

rule_quantity_w			smallint;

nr_seq_material_w		cpoe_integracao.nr_seq_mat_cpoe%type;
nr_seq_dialysis_w		cpoe_integracao.nr_seq_dial_cpoe%type;
nr_seq_diet_w			  cpoe_integracao.nr_seq_diet_cpoe%type;
nr_seq_hemotherapy_w	cpoe_integracao.nr_seq_hemo_cpoe%type;
nr_seq_recomendation_w	cpoe_integracao.nr_seq_rec_cpoe%type;
nr_seq_gastherapy_w	cpoe_integracao.nr_seq_gaso_cpoe%type;
nr_seq_procedure_w	cpoe_integracao.nr_seq_proc_cpoe%type;

nr_episode_w			  bigint;
ds_prescrition_w		varchar(255);
dt_begin_w				  timestamp;
nr_sequence_w			  bigint;
ie_item_type_w			varchar(5);
nr_sequence_order_w bigint;
dt_retrogrado_w     timestamp;
ie_atrasado_w       varchar(2);

c02 CURSOR FOR
SELECT  i.nr_seq_mat_cpoe,
		i.nr_seq_dial_cpoe,
		i.nr_seq_diet_cpoe,
		i.nr_seq_hemo_cpoe,
		i.nr_seq_rec_cpoe,
		i.nr_seq_gaso_cpoe,
		i.nr_seq_proc_cpoe
from	cpoe_integracao i
where	coalesce(i.dt_ack_interface::text, '') = ''
and		coalesce(i.nm_ack_interface::text, '') = ''
and (exists ( 	SELECT	m.nr_sequencia
				from	cpoe_material m
				where	m.nr_sequencia = i.nr_seq_mat_cpoe
				and		m.nr_atendimento = nr_atendimento_p)
	or exists (	select	di.nr_sequencia
				from	cpoe_dialise di
				where	di.nr_sequencia = i.nr_seq_dial_cpoe
				and		di.nr_atendimento = nr_atendimento_p)
	or exists (	select	d.nr_sequencia
				from	cpoe_dieta d
				where	d.nr_sequencia = i.nr_seq_diet_cpoe
				and		d.nr_atendimento = nr_atendimento_p)
	or exists (	select	h.nr_sequencia
				from	cpoe_hemoterapia h
				where	h.nr_sequencia = i.nr_seq_hemo_cpoe
				and		h.nr_atendimento = nr_atendimento_p)
	or exists (	select	r.nr_sequencia
				from	cpoe_recomendacao r
				where	r.nr_sequencia = i.nr_seq_rec_cpoe
				and		r.nr_atendimento = nr_atendimento_p)
	or exists (	select	g.nr_sequencia
				from	cpoe_gasoterapia g
				where	g.nr_sequencia = i.nr_seq_gaso_cpoe
				and		g.nr_atendimento = nr_atendimento_p)
	or exists (	select	p.nr_sequencia
				from	cpoe_procedimento p
				where	p.nr_sequencia = i.nr_seq_proc_cpoe
				and		p.nr_atendimento = nr_atendimento_p));




BEGIN

select	count(*)
into STRICT	  rule_quantity_w
from	  cpoe_regra_ator LIMIT 1;

if (rule_quantity_w > 0) then

	open c02;
	loop
	fetch c02 into 	
		nr_seq_material_w,
		nr_seq_dialysis_w,
		nr_seq_diet_w,
		nr_seq_hemotherapy_w,
		nr_seq_recomendation_w,
		nr_seq_gastherapy_w,
		nr_seq_procedure_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		
		if (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') then
			
			select	medicines.nr_atendimento,
					obter_desc_material(coalesce(medicines.cd_material,0)),
					medicines.dt_inicio,
					coalesce(medicines.nr_sequencia,1),
					'M',
					60000
			into STRICT 	nr_episode_w,
					ds_prescrition_w,
					dt_begin_w,
					nr_sequence_w,
					ie_item_type_w,
					nr_sequence_order_w
			from 	cpoe_material medicines
			where 	medicines.nr_sequencia = nr_seq_material_w;
			
		elsif (nr_seq_dialysis_w IS NOT NULL AND nr_seq_dialysis_w::text <> '') then
			
			select	dialysis.nr_atendimento,
					CPOE_obter_desc_dialise_simp(	ie_tipo_dialise, ie_hemodialise, ie_tipo_peritoneal),
					dialysis.dt_inicio,
					dialysis.nr_sequencia,
					'DI',
					40000
			into STRICT 	nr_episode_w,
					ds_prescrition_w,
					dt_begin_w,
					nr_sequence_w,
					ie_item_type_w,
					nr_sequence_order_w
			from	cpoe_dialise dialysis
			where 	dialysis.nr_sequencia = nr_seq_dialysis_w;
			
		elsif (nr_seq_diet_w IS NOT NULL AND nr_seq_diet_w::text <> '') then
			
			select	diet.nr_atendimento,
					obter_desc_dieta(coalesce(diet.cd_dieta,0)),
					diet.dt_inicio,
					diet.nr_sequencia,
					'D',
					2000
			into STRICT 	nr_episode_w,
					ds_prescrition_w,
					dt_begin_w,
					nr_sequence_w,
					ie_item_type_w,
					nr_sequence_order_w
			from	cpoe_dieta diet
			where 	diet.nr_sequencia = nr_seq_diet_w;
		
		elsif (nr_seq_hemotherapy_w IS NOT NULL AND nr_seq_hemotherapy_w::text <> '') then
		
			select	hemotherapy.nr_atendimento,
					substr(obter_desc_san_derivado(hemotherapy.nr_seq_derivado),1,60),
					hemotherapy.dt_inicio,
					hemotherapy.nr_sequencia,
					'HM',
					175000
			into STRICT 	nr_episode_w,
					ds_prescrition_w,
					dt_begin_w,
					nr_sequence_w,
					ie_item_type_w,
					nr_sequence_order_w
			from 	cpoe_hemoterapia hemotherapy
			where 	hemotherapy.nr_sequencia = nr_seq_hemotherapy_w;
		
		elsif (nr_seq_recomendation_w IS NOT NULL AND nr_seq_recomendation_w::text <> '') then
		
			select  recomendation.nr_atendimento,
					obter_desc_recomendacao(coalesce(recomendation.cd_recomendacao,0)),
					recomendation.dt_inicio,
					recomendation.nr_sequencia,
					'R',
					140000
			into STRICT 	nr_episode_w,
					ds_prescrition_w,
					dt_begin_w,
					nr_sequence_w,
					ie_item_type_w,
					nr_sequence_order_w
			from	cpoe_recomendacao recomendation
			where 	recomendation.nr_sequencia = nr_seq_recomendation_w;			
		
		elsif (nr_seq_gastherapy_w IS NOT NULL AND nr_seq_gastherapy_w::text <> '') then
		
			select  gastherapy.nr_atendimento,
					obter_desc_gas(coalesce(gastherapy.nr_seq_gas,0)),
					gastherapy.dt_inicio,
					gastherapy.nr_sequencia,
					'O',
					220000
			into STRICT 	nr_episode_w,
					ds_prescrition_w,
					dt_begin_w,
					nr_sequence_w,
					ie_item_type_w,
					nr_sequence_order_w
			from 	cpoe_gasoterapia gastherapy
			where 	gastherapy.nr_sequencia = nr_seq_gastherapy_w;
		
		elsif (nr_seq_procedure_w IS NOT NULL AND nr_seq_procedure_w::text <> '') then
		
			SELECT	proc.nr_atendimento,
					substr(obter_desc_proc_interno(proc.nr_seq_proc_interno),1,60),
					proc.dt_inicio,
					proc.nr_sequencia,
					'P',
					260000
			into STRICT 	nr_episode_w,
					ds_prescrition_w,
					dt_begin_w,
					nr_sequence_w,
					ie_item_type_w,
					nr_sequence_order_w
			from 	cpoe_procedimento proc
			where 	proc.nr_sequencia = nr_seq_procedure_w;
		
		end if;

    dt_retrogrado_w := clock_timestamp() - interval '72' hour;

    if (dt_begin_w < dt_retrogrado_w) then
      ie_atrasado_w := 'S';
    else
      ie_atrasado_w := 'N';
    end if;
			
		ds_material_w := adep_obter_desc_pending_order(nr_sequence_w, ie_item_type_w, clock_timestamp(), 'N', 'N');

		insert into adep_horarios_web(
				id_sessao_web,
				nm_usuario,
				dt_atualizacao_nrec,
				ie_saegrupo,
				ie_ordem,
				nr_seq_ordem,
				nr_sequencia,
				ie_tipo_item,
				nr_prescricao,
				nr_seq_item,
				cd_item,
				cd_intervalo,
				qt_item,
				ie_acm_sn,
				ie_status_item,
				ds_prescrito,
				ds_prescrito_cpoe,
				ds_prescricao,
				nr_prescricoes,
				ds_diluicao,
				ds_inf_dil,
				nr_dia_util,
				ie_diferenciado,
				nr_seq_proc_interno,
				dt_prev_term,
				ie_pendente_liberacao,
				ie_medic_controlado,
				ie_medicacao_paciente,
				nr_agrupamento,
				ie_prescricao_alta,
				nr_seq_prot_glic,
				ie_horario,
				ie_via_aplicacao,
				nr_seq_apres_inf,
				nr_etapa_sol,
				ds_observacao_proc,
				ie_obs_medico,
				ie_diluido,
				cd_motivo_baixa,
				ie_composto,
				nr_seq_registro,
				ie_alto_risco,
				ds_componentes,
				ie_ciencia,
				ie_quimio,
				nr_seq_grupo_interv,
				ie_padronizado,
				ie_util_hemocomponente,
				ie_vencida,
				nr_agrup_prot,
				cd_unidade_medida,
				hora1,
				hora2,
				hora3,
				hora4,
				hora5,
				hora6,
				hora7,
				hora8,
				hora9,
				hora10,
				hora11,
				hora12,
				hora13,
				hora14,
				hora15,
				hora16,
				hora17,
				hora18,
				hora19,
				hora20,
				hora21,
				hora22,
				hora23,
				hora24,
				hora25,
				hora26,
				hora27,
				hora28,
				hora29,
				hora30,
				hora31,
				hora32,
				hora33,
				hora34,
				hora35,
				hora36,
				hora37,
				hora38,
				hora39,
				hora40,
				ie_sol_custo,
				ie_hemodialise,
				ie_item_ordem,
				ie_atrasado,
				ie_regra_disp,
				nr_seq_cpoe,
				nr_atendimento,
				ie_classif_adep,
				ie_risco_queda)
			values (
				id_sessao_p,
				nm_usuario_p,
				clock_timestamp(),
				null,
				null,
				nr_sequence_order_w,
				nr_sequence_w,
				ie_item_type_w,
				null,
				null,
				null,
				null,
				null,
				'N',
				null,
				ds_prescrition_w,
				ds_material_w,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				ie_atrasado_w,
				null,
				nr_sequence_w,
				nr_atendimento_p,
				null,
				null);
		
		
		end;
	end loop;
	close c02;

end if;


commit;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_adep_order_interface ( nr_atendimento_p bigint, id_sessao_p text, nm_usuario_p text) FROM PUBLIC;

