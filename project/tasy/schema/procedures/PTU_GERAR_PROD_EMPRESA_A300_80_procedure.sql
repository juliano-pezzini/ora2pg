-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_gerar_prod_empresa_a300_80 (( nr_seq_mov_plano_p bigint, nm_usuario_p text) is dt_mov_inicio_w timestamp) RETURNS varchar AS $body$
DECLARE

ds_retorno_w	varchar(255);
C01 CURSOR FOR
	SELECT	cd_intercambio
	from	pls_interc_tipo_logradouro
	where (nr_seq_tipo_logradouro = nr_seq_tipo_logradouro_p or (coalesce(nr_seq_tipo_logradouro::text, '') = '' and coalesce(cd_tipo_logradouro::text, '') = ''))
	order by coalesce(nr_seq_tipo_logradouro,0);
BEGIN
ds_retorno_w	:= null;
for r_c01_w in C01 loop
	begin
	ds_retorno_w	:= r_c01_w.cd_intercambio;
	end;
end loop;
return	ds_retorno_w;
end;

begin

select	dt_mov_inicio,
	dt_mov_fim,
	ie_tipo_mov,
	cd_unimed_destino,
	nr_seq_lote
into STRICT	dt_mov_inicio_w,
	dt_mov_fim_w,
	ie_tipo_mov_w,
	cd_operadora_destino_w,
	nr_seq_lote_w
from	ptu_movimentacao_produto
where	nr_sequencia	= nr_seq_mov_plano_p;

select	cd_estabelecimento,
	ie_tipo_movimento,
	nr_seq_classificacao,
	nr_seq_contrato
into STRICT	cd_estabelecimento_w,
	ie_tipo_movimentacao_w,
	nr_seq_classificacao_w,
	nr_seq_contrato_lote_w
from	ptu_mov_produto_lote
where	nr_sequencia	= nr_seq_lote_w;

select	coalesce(max(ie_gerar_sca_nao_liberado), 'N')
into STRICT	ie_gerar_sca_nao_liberado_w
from	pls_parametros
where	cd_estabelecimento = cd_estabelecimento_w;

select	nr_seq_sub_classificacao
into STRICT	nr_seq_sub_classificacao_w
from	pls_sca_classificacao
where	nr_sequencia	= nr_seq_classificacao_w;

select	max(cd_cgc_outorgante)
into STRICT	cd_cgc_outorgante_w
from	pls_outorgante
where	cd_estabelecimento = cd_estabelecimento_w;

select	substr(ds_razao_social,1,40),
	substr(nm_fantasia,1,18),
	somente_numero(nr_inscricao_estadual),
	substr(ds_endereco,1,40),
	substr(somente_numero_char(cd_cep),1,8),
	substr(ds_complemento,1,20),
	substr(ds_bairro,1,30),
	substr(ds_municipio,1,30),
	sg_estado,
	nr_ddd_telefone,
	substr(somente_numero(nr_telefone),1,8),
	substr(somente_numero(nr_fax),1,8),
	cd_municipio_ibge || Calcula_Digito('MODULO10',substr(cd_municipio_ibge,1,10)),
	nr_endereco,
	nr_seq_tipo_logradouro
into STRICT	ds_razao_social_oper_w,
	nm_fantasia_oper_w,
	nr_inscricao_estadual_oper_w,
	ds_endereco_oper_w,
	cd_cep_oper_w,
	ds_complemento_oper_w,
	ds_bairro_oper_w,
	ds_municipio_oper_w,
	sg_estado_oper_w,
	nr_ddd_telefone_oper_w,
	nr_telefone_oper_w,
	nr_fax_oper_w,
	cd_municipio_ibge_oper_w,
	nr_endereco_oper_w,
	nr_seq_tipo_logradouro_oper_w
from	pessoa_juridica
where	cd_cgc	= cd_cgc_outorgante_w;

select	count(1)
into STRICT	qt_regras_exececoes_w
from	ptu_regra_excessao_a300
where	nr_seq_classificacao	= nr_seq_classificacao_w
and	ie_situacao		= 'A';

open C01;
loop
fetch C01 into
	nr_seq_prestador_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	select	max(CASE WHEN ie_tipo_contratacao='CA' THEN 4 WHEN ie_tipo_contratacao='CE' THEN 3  ELSE 2 END )
	into STRICT	ie_tipo_natureza_w
	from	pls_plano_fornecedor	b,
		pls_plano		a
	where	b.nr_seq_plano		= a.nr_sequencia
	and	b.nr_seq_prestador	= nr_seq_prestador_w;

	open C02;
	loop
	fetch C02 into
		nr_contrato_w,
		cd_cgc_w,
		cd_pessoa_fisica_w,
		dt_cadastro_w,
		dt_exclusao_w,
		nr_seq_contrato_w,
		cd_empresa_origem_w,
		cd_caepf_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		nr_inscricao_estadual_w	:= '';
		ie_inseri_reg_w		:= 'S';
		
		if (coalesce(cd_empresa_origem_w::text, '') = '') then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(388900, 'NR_CONTRATO='||nr_contrato_w);
		end if;
		
		select	CASE WHEN max(ie_tipo_contratacao)='CA' THEN 4 WHEN max(ie_tipo_contratacao)='CE' THEN 3  ELSE 2 END
		into STRICT	ie_tipo_natureza_w
		from	pls_contrato_plano	b,
			pls_plano		a
		where	b.nr_seq_contrato 	= nr_seq_contrato_w
		and	a.nr_sequencia 		= b.nr_seq_plano;
		
		if (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') then
			select	1,
				substr(ds_razao_social,1,40),
				substr(nm_fantasia,1,18),
				somente_numero(nr_inscricao_estadual),
				substr(ds_endereco,1,40),
				substr(somente_numero_char(cd_cep),1,8),
				substr(ds_complemento,1,20),
				substr(ds_bairro,1,30),
				substr(ds_municipio,1,30),
				sg_estado,
				nr_ddd_telefone,
				substr(somente_numero(nr_telefone),1,8),
				substr(somente_numero(nr_fax),1,8),
				cd_municipio_ibge || Calcula_Digito('MODULO10',substr(cd_municipio_ibge,1,10)),
				substr(somente_numero(nr_endereco),1,6),
				nr_seq_tipo_logradouro
			into STRICT	ie_tipo_pessoa_w,
				ds_razao_social_w,
				nm_fantasia_w,
				nr_inscricao_estadual_w,
				ds_endereco_w,
				cd_cep_w,
				ds_complemento_w,
				ds_bairro_w,
				ds_municipio_w,
				sg_estado_w,
				nr_ddd_telefone_w,
				nr_telefone_w,
				nr_fax_w,
				cd_municipio_ibge_w,
				nr_endereco_w,
				nr_seq_tipo_logradouro_w
			from	pessoa_juridica
			where	cd_cgc	= cd_cgc_w;
			
			cd_cgc_cpf_w	:= cd_cgc_w;
		elsif (cd_pessoa_fisica_w IS NOT NULL AND cd_pessoa_fisica_w::text <> '') then
			ie_tipo_pessoa_w		:= 1;
			ds_razao_social_w		:= ds_razao_social_oper_w;
			nm_fantasia_w			:= nm_fantasia_oper_w;
			nr_inscricao_estadual_w		:= nr_inscricao_estadual_oper_w;
			ds_endereco_w			:= ds_endereco_oper_w;
			cd_cep_w			:= cd_cep_oper_w;
			ds_complemento_w		:= ds_complemento_oper_w;
			ds_bairro_w			:= ds_bairro_oper_w;
			ds_municipio_w			:= ds_municipio_oper_w;
			sg_estado_w			:= sg_estado_oper_w;
			nr_ddd_telefone_w		:= nr_ddd_telefone_oper_w;
			nr_telefone_w			:= nr_telefone_oper_w;
			nr_fax_w			:= nr_fax_oper_w;
			cd_municipio_ibge_w		:= cd_municipio_ibge_oper_w;
			nr_endereco_w			:= nr_endereco_oper_w;
			cd_pessoa_fisica_w		:= '';
			cd_cgc_cpf_w			:= cd_cgc_outorgante_w;
			nr_seq_tipo_logradouro_w	:= nr_seq_tipo_logradouro_oper_w;
		end if;
		
		cd_tipo_logradouro_w	:= obter_cd_tipo_logradouro(nr_seq_tipo_logradouro_w);
		
		ds_razao_social_w	:= replace(replace(ds_razao_social_w,chr(231),'c'),chr(199),'C');
		ds_razao_social_w	:= replace(ds_razao_social_w,'/',' ');
		ds_razao_social_w	:= elimina_acentuacao(ds_razao_social_w);
		ds_razao_social_w	:= elimina_caractere_especial(ds_razao_social_w);
		
		nm_fantasia_w		:= replace(replace(nm_fantasia_w,chr(231),'c'),chr(199),'C');
		nm_fantasia_w		:= replace(nm_fantasia_w,'/',' ');
		nm_fantasia_w		:= elimina_acentuacao(nm_fantasia_w);
		nm_fantasia_w		:= elimina_caractere_especial(nm_fantasia_w);
		
		ds_municipio_w		:= replace(ds_municipio_w,'/',' ');
		ds_municipio_w		:= elimina_acentuacao(ds_municipio_w);
		ds_municipio_w		:= elimina_caractere_especial(ds_municipio_w);
		ds_municipio_w		:= replace(replace(ds_municipio_w,chr(231),'c'),chr(199),'C');
		
		ds_endereco_w		:= replace(ds_endereco_w,'/',' ');
		ds_endereco_w		:= elimina_acentuacao(ds_endereco_w);
		ds_endereco_w		:= elimina_caractere_especial(ds_endereco_w);
		ds_endereco_w		:= replace(replace(ds_endereco_w,chr(231),'c'),chr(199),'C');
		
		ds_bairro_w		:= replace(ds_bairro_w,'/',' ');
		ds_bairro_w		:= elimina_acentuacao(ds_bairro_w);
		ds_bairro_w		:= elimina_caractere_especial(ds_bairro_w);
		ds_bairro_w		:= replace(replace(ds_bairro_w,chr(231),'c'),chr(199),'C');
		
		ds_complemento_w	:= elimina_caractere_especial(ds_complemento_w);
		ds_complemento_w	:= replace(replace(ds_complemento_w,chr(231),'c'),chr(199),'C');
		ds_complemento_w	:= elimina_acentuacao(ds_complemento_w);
		ds_complemento_w	:= replace(replace(ds_complemento_w,chr(180),''), chr(96), '');
		
		nr_ddd_telefone_w 	:= replace(nr_ddd_telefone_w,' ','');
		
		if (coalesce(trim(both cd_cgc_cpf_w)::text, '') = '') then
			cd_cgc_cpf_w	:= 11111111111;
		end if;
		
		select	count(*)
		into STRICT	qt_excessoes_w    
		from 	ptu_prod_lote_restricao a,
			ptu_movimentacao_produto b
		where 	a.nr_seq_lote 		= b.nr_seq_lote
		and   	b.nr_sequencia 		= nr_seq_mov_plano_p     
		and   	a.nr_seq_contrato	= nr_seq_contrato_w; 		

		if (qt_excessoes_w = 0) then
			begin
			select	nextval('ptu_mov_produto_empresa_seq')
			into STRICT	nr_seq_inter_empresa_w
			;
			
			begin
			insert	into	ptu_mov_produto_empresa(	nr_sequencia, 		nr_seq_mov_produto, 	ds_razao_social,
					nm_empr_abrev, 		ie_tipo_pessoa, 	cd_cgc_cpf,
					ds_endereco, 		cd_cep, 		cd_empresa_origem,
					dt_atualizacao,		nm_usuario, 		dt_atualizacao_nrec,
					nm_usuario_nrec,	cd_filial, 		nr_insc_estadual,
					ds_complemento, 	ds_bairro, 		nm_cidade,
					sg_uf, 			nr_ddd, 		nr_telefone,
					nr_fax, 		dt_inclusao, 		dt_exclusao,
					cd_municipio_ibge, 	nr_seq_contrato, 	ie_natureza_contratacao,
					nr_endereco, 		nr_contrato,		cd_caepf,
					cd_tipo_logradouro)
			values (	nr_seq_inter_empresa_w, nr_seq_mov_plano_p, 	ds_razao_social_w,
					nm_fantasia_w, 		ie_tipo_pessoa_w, 	cd_cgc_cpf_w,
					ds_endereco_w, 		cd_cep_w, 		cd_empresa_origem_w,
					clock_timestamp(), 		nm_usuario_p, 		clock_timestamp(),
					nm_usuario_p, 		'', 			nr_inscricao_estadual_w,
					ds_complemento_w, 	ds_bairro_w, 		ds_municipio_w,
					sg_estado_w, 		nr_ddd_telefone_w, 	nr_telefone_w,
					nr_fax_w, 		dt_cadastro_w, 		dt_exclusao_w,
					cd_municipio_ibge_w, 	nr_seq_contrato_w, 	ie_tipo_natureza_w,
					nr_endereco_w, 		nr_contrato_w,		cd_caepf_w,
					cd_tipo_logradouro_w);
			exception
			when others then
				ie_inseri_reg_w	:= 'N';
				CALL wheb_mensagem_pck.exibir_mensagem_abort(191658,'NM_EMPRESA='|| substr(obter_nome_pf_pj('',cd_cgc_cpf_w),1,255));
			end;
			
			if (ie_inseri_reg_w = 'S') then
				CALL ptu_gerar_produto_benef_a300(nr_seq_inter_empresa_w,ie_gerar_sca_nao_liberado_w,nm_usuario_p);

				if (qt_regras_exececoes_w > 0) then
					CALL ptu_gerar_regras_exece_a300(nr_seq_lote_w,nr_seq_inter_empresa_w,nr_seq_classificacao_w,cd_estabelecimento_w,nm_usuario_p);
				end if;
				
				select	count(1)
				into STRICT	qt_registros_w
				from	ptu_mov_produto_benef
				where	nr_seq_empresa	= nr_seq_inter_empresa_w;
				
				if (qt_registros_w = 0) then
					delete	FROM ptu_mov_produto_empresa
					where	nr_sequencia	= nr_seq_inter_empresa_w;
				end if;
			end if;
			
			if (mod(C02%rowcount,500) = 0) then
				commit;
			end if;
			end;
		end if;
		
		end;
	end loop;
	close C02;
	end;
end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_gerar_prod_empresa_a300_80 (( nr_seq_mov_plano_p bigint, nm_usuario_p text) is dt_mov_inicio_w timestamp) FROM PUBLIC;

