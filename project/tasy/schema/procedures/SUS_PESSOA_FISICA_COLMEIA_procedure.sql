-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_pessoa_fisica_colmeia ( cd_sistema_ant_p text, nr_cpf_p text, nm_pessoa_fisica_p text, ie_sexo_p text, dt_nascimento_p text, nr_identidade_p text, ds_orgao_emissor_ci_p text, ie_estado_civil_p text, nr_seq_cor_pele_p bigint, nr_seq_etnia_p bigint, cd_munic_nasc_p bigint, nr_cert_casamento_p text, nr_cert_nasc_p text, nr_titulo_eleitor_p text, nr_cartao_nac_sus_p text, nr_ddd_celular_p text, nr_telefone_celular_p text, ie_grau_instrucao_p bigint, sg_emissora_ci_p text, ds_observacao_p text, nm_contato_p text, cd_cep_p text, cd_tipo_logradouro_p text, ds_endereco_p text, nr_endereco_p bigint, ds_complemento_p text, ds_bairro_p text, ds_municipio_p text, cd_municipio_ibge_p text, sg_estado_p text, ds_email_p text, nr_ddd_telefone_p text, nr_telefone_p text, nm_mae_p text, nm_usuario_p text, cd_pessoa_fisica_p INOUT text) AS $body$
DECLARE


qt_registro_w		bigint;
nr_seq_endereco_w	smallint;
nr_seq_mae_w		smallint;
dt_nascimento_w		timestamp;
ds_erro_w		sus_erro_imp_colmeia.ds_erro%type;
cd_pessoa_fisica_w	pessoa_fisica.cd_pessoa_fisica%type;
ie_commit_w		varchar(1) := 'N';


BEGIN

if (dt_nascimento_p IS NOT NULL AND dt_nascimento_p::text <> '') then
	begin
	dt_nascimento_w := to_date(dt_nascimento_p,'dd/mm/yyyy hh24:mi:ss');
	end;
end if;

begin
select	cd_pessoa_fisica
into STRICT	cd_pessoa_fisica_w
from	pessoa_fisica
where	nr_cpf = nr_cpf_p  LIMIT 1;
exception
when others then
	cd_pessoa_fisica_w := 'X';
end;

if (coalesce(cd_pessoa_fisica_w,'X') = 'X') then
	begin
	select	cd_pessoa_fisica
	into STRICT	cd_pessoa_fisica_w
	from	pessoa_fisica
	where	cd_sistema_ant = cd_sistema_ant_p  LIMIT 1;
	exception
	when others then
		cd_pessoa_fisica_w := 'X';
	end;
end if;

if (coalesce(cd_pessoa_fisica_w,'X') = 'X') then
	begin

	select	nextval('pessoa_fisica_seq')
	into STRICT	cd_pessoa_fisica_w
	;

	begin
	insert into pessoa_fisica(
		cd_pessoa_fisica,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		ie_tipo_pessoa,
		cd_sistema_ant,
		nr_cpf,
		nm_pessoa_fisica,
		ie_sexo,
		dt_nascimento,
		nr_identidade,
		ds_orgao_emissor_ci,
		ie_estado_civil,
		nr_seq_cor_pele,
		nr_seq_etnia,
		cd_municipio_ibge,
		nr_cert_casamento,
		nr_cert_nasc,
		nr_titulo_eleitor,
		nr_cartao_nac_sus,
		nr_ddd_celular,
		nr_telefone_celular,
		ie_grau_instrucao,
		sg_emissora_ci,
		ds_observacao)
	values (	cd_pessoa_fisica_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		2,
		cd_sistema_ant_p,
		nr_cpf_p,
		nm_pessoa_fisica_p,
		ie_sexo_p,
		dt_nascimento_w,
		nr_identidade_p,
		ds_orgao_emissor_ci_p,
		ie_estado_civil_p,
		nr_seq_cor_pele_p,
		nr_seq_etnia_p,
		cd_munic_nasc_p,
		nr_cert_casamento_p,
		nr_cert_nasc_p,
		nr_titulo_eleitor_p,
		nr_cartao_nac_sus_p,
		nr_ddd_celular_p,
		nr_telefone_celular_p,
		ie_grau_instrucao_p,
		sg_emissora_ci_p,
		ds_observacao_p);
	exception
	when others then
		ds_erro_w := substr(ds_erro_w || 'cd_sistema_ant_p:'|| cd_sistema_ant_p || ';cd_munic_nasc_p:'|| cd_munic_nasc_p || wheb_mensagem_pck.get_texto(282485) || sqlerrm || ';', 2000);
	end;

	select	count(1)
	into STRICT	qt_registro_w
	from	pessoa_fisica
	where	cd_pessoa_fisica = cd_pessoa_fisica_w  LIMIT 1;

	if (qt_registro_w > 0) then
		begin

		select	coalesce(max(nr_sequencia),0) + 1
		into STRICT	nr_seq_endereco_w
		from	compl_pessoa_fisica
		where	cd_pessoa_fisica = cd_pessoa_fisica_w;

		insert into compl_pessoa_fisica(
			cd_pessoa_fisica,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ie_tipo_complemento,
			nr_sequencia,
			nm_contato,
			cd_cep,
			cd_tipo_logradouro,
			ds_endereco,
			nr_endereco,
			ds_complemento,
			ds_bairro,
			ds_municipio,
			cd_municipio_ibge,
			sg_estado,
			ds_email,
			nr_ddd_telefone,
			nr_telefone)
		values (	cd_pessoa_fisica_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			1,
			nr_seq_endereco_w,
			nm_contato_p,
			cd_cep_p,
			cd_tipo_logradouro_p,
			ds_endereco_p,
			nr_endereco_p,
			ds_complemento_p,
			ds_bairro_p,
			ds_municipio_p,
			cd_municipio_ibge_p,
			sg_estado_p,
			ds_email_p,
			nr_ddd_telefone_p,
			nr_telefone_p);

		select	coalesce(max(nr_sequencia),0) + 1
		into STRICT	nr_seq_mae_w
		from	compl_pessoa_fisica
		where	cd_pessoa_fisica = cd_pessoa_fisica_w;

		insert into compl_pessoa_fisica(
			cd_pessoa_fisica,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ie_tipo_complemento,
			nr_sequencia,
			nm_contato)
		values (	cd_pessoa_fisica_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			5,
			nr_seq_mae_w,
			nm_mae_p);
		end;
	end if;
	ie_commit_w := 'S';
	end;
end if;

if (coalesce(ds_erro_w, 'X') <> 'X') then
	begin

	insert into sus_erro_imp_colmeia(
		ds_erro,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_atendimento,
		nr_seq_interno,
		nr_sequencia)
	values (	ds_erro_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		null,
		null,
		nextval('sus_erro_imp_colmeia_seq'));
	ie_commit_w := 'S';
	end;
end if;

if (ie_commit_w = 'S') then
	begin
	commit;
	end;
end if;

if (coalesce(cd_pessoa_fisica_w,'X') <> 'X') then
	cd_pessoa_fisica_p	:= cd_pessoa_fisica_w;
else
	cd_pessoa_fisica_p	:= '';
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_pessoa_fisica_colmeia ( cd_sistema_ant_p text, nr_cpf_p text, nm_pessoa_fisica_p text, ie_sexo_p text, dt_nascimento_p text, nr_identidade_p text, ds_orgao_emissor_ci_p text, ie_estado_civil_p text, nr_seq_cor_pele_p bigint, nr_seq_etnia_p bigint, cd_munic_nasc_p bigint, nr_cert_casamento_p text, nr_cert_nasc_p text, nr_titulo_eleitor_p text, nr_cartao_nac_sus_p text, nr_ddd_celular_p text, nr_telefone_celular_p text, ie_grau_instrucao_p bigint, sg_emissora_ci_p text, ds_observacao_p text, nm_contato_p text, cd_cep_p text, cd_tipo_logradouro_p text, ds_endereco_p text, nr_endereco_p bigint, ds_complemento_p text, ds_bairro_p text, ds_municipio_p text, cd_municipio_ibge_p text, sg_estado_p text, ds_email_p text, nr_ddd_telefone_p text, nr_telefone_p text, nm_mae_p text, nm_usuario_p text, cd_pessoa_fisica_p INOUT text) FROM PUBLIC;

