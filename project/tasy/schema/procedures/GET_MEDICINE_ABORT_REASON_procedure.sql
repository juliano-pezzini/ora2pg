-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE get_medicine_abort_reason ( cd_material_p material.cd_material%TYPE, ds_reason INOUT text ) AS $body$
DECLARE


    ie_tipo_material_w    material.ie_tipo_material%TYPE;
    ie_situacao_w    material.ie_situacao%TYPE;
    ie_permitted_w        varchar(10);
    ie_prescricao_w       material_estab.ie_prescricao%TYPE;
    cd_establishmento_w   estabelecimento.cd_estabelecimento%TYPE;

BEGIN
    cd_establishmento_w := coalesce(wheb_usuario_pck.get_cd_estabelecimento, 1);
    SELECT
        obter_dados_material_estab(cd_material_p, cd_establishmento_w, 'PR')
    INTO STRICT ie_permitted_w
;

    IF ( ie_permitted_w = 'N' ) THEN
        /* SELECT
            ie_tipo_material
        INTO ie_tipo_material_w
        FROM
            material
        WHERE
            cd_material = cd_material_p; */
        SELECT
            coalesce(ie_prescricao, 'N')
        INTO STRICT ie_prescricao_w
        FROM
            material_estab
        WHERE
            cd_material = cd_material_p
            AND cd_estabelecimento = cd_establishmento_w;

        /* IF ( ie_tipo_material_w = 3 ) THEN
            ds_reason := wheb_mensagem_pck.get_texto(1146204);
        ELS */
		IF ( ie_prescricao_w = 'N' ) THEN
            ds_reason := wheb_mensagem_pck.get_texto(1146205);
        ELSE
            ds_reason := wheb_mensagem_pck.get_texto(1078088);
        END IF;

    END IF;

    IF ( coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'en_AU' ) THEN
      begin

          /* SELECT
            nvl(ie_tipo_material, 9)
          INTO ie_tipo_material_w
          FROM
            material
          WHERE
            cd_material = cd_material_p; */
          SELECT
            coalesce(ie_prescricao, 'N')
          INTO STRICT ie_prescricao_w
          FROM
            material_estab
          WHERE
            cd_material = cd_material_p
            AND cd_estabelecimento = cd_establishmento_w;

          SELECT
            coalesce(ie_situacao, 'I')
          INTO STRICT ie_situacao_w
          FROM
            material
          WHERE
            cd_material = cd_material_p;

          /* IF ( ie_tipo_material_w = 3 ) THEN
            ds_reason := wheb_mensagem_pck.get_texto(1146204);
          ELS */
		  IF ( ie_prescricao_w = 'N' ) THEN
            ds_reason := wheb_mensagem_pck.get_texto(1146205);
          ELSIF ( ie_situacao_w != 'A' ) THEN
            ds_reason := wheb_mensagem_pck.get_texto(1078088);
          END IF;

      exception when others then
        null;
      end;
    END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE get_medicine_abort_reason ( cd_material_p material.cd_material%TYPE, ds_reason INOUT text ) FROM PUBLIC;

