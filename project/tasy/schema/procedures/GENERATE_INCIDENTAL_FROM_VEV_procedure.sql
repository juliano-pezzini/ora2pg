-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE generate_incidental_from_vev () AS $body$
DECLARE

nm_manager_user_w usuario.nm_usuario%type;
nm_analyst_user_w usuario.nm_usuario%type;
nr_seq_grupo_w bigint;
  i RECORD;

BEGIN
    --seleciona todas OS's da tabela SCHEM_TEST_OS que nÃ£o tem incidente aberto (MAN_INCIDENTAL_BUILD)
FOR i IN (
select distinct s.nr_seq_service_order, b.NM_USUARIO, s.NM_USUARIO_NREC, b.ie_plataforma, b.nr_versao_cliente_abertura, b.cd_funcao, b.dt_atualizacao
from REG_TC_SO_PENDENCIES s, man_ordem_servico b
where s.nr_seq_service_order = b.nr_sequencia 
and trunc(b.dt_atualizacao_nrec) > trunc(to_date('2019/10/01', 'yyyy/mm/dd')) 
and not exists (
    select inc.nr_seq_ordem_serv 
    from man_incidental_build inc 
    where s.nr_seq_service_order = inc.nr_seq_ordem_serv )
) LOOP
select	MAX(g.nm_usuario_lider), 
		MAX(substr(obter_usuario_pf(gw.cd_responsavel),1,120)) nm_usuario_gerente
into STRICT nm_analyst_user_w, nm_manager_user_w
from	grupo_desenvolvimento g,
		funcao_grupo_des f,
		gerencia_wheb gw
where	g.nr_sequencia = f.nr_seq_grupo
and		f.cd_funcao = i.cd_funcao
and     gw.nr_sequencia = g.nr_Seq_gerencia
order by 1;
  --insere os dados na tabela de incidentes com valores default 'v' para origem 

  --e valor 'n' para flag do excel
insert into man_incidental_build(
nr_sequencia,
dt_atualizacao,
nm_usuario,
dt_atualizacao_nrec,
nm_usuario_nrec,
nr_seq_ordem_serv,
nm_gerente,
nm_analista,
ie_gerou_excel,
cd_versao,
ie_plataforma,
ie_origem)
values (
nextval('man_incidental_build_seq'),
clock_timestamp(),
i.NM_USUARIO,
clock_timestamp(),
i.NM_USUARIO_NREC,
i.nr_seq_service_order,
nm_manager_user_w,
nm_analyst_user_w,
'N',
i.nr_versao_cliente_abertura,
i.ie_plataforma,
'V');
commit;
END LOOP;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE generate_incidental_from_vev () FROM PUBLIC;

