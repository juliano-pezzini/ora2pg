-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_pagt_colombia_bisa_short ( nr_seq_envio_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* VERSION 001 DE NOV-2020 */

ie_situacao_w 		varchar(1)	:= 'A';
ie_separator_w		varchar(1)	:= '@';
ds_invalids_w		varchar(9)	:= '()=!/:,-.';
nr_seq_apres_w		bigint;
ds_conteudo_w		varchar(79);

/* FILE DETAILS */

cd_estabelecimento_w	varchar(4);
cd_recepient_w		varchar(20);
vl_importe_w   		varchar(17);
ds_notas_w     		varchar(40);

--Sample: Codigo_beneficiario@importe_transaccion@notas_varias
c01 CURSOR FOR
SELECT 	substr(to_char(coalesce(b.cd_estabelecimento,0)),1,4) cd_estabelecimento,
	substr(coalesce(a.cd_conta,'0'),1,20) cd_recepient,
	substr(to_char(coalesce(c.vl_escritural,0)),1,17) vl_importe,
	substr(d.ds_observacao_titulo,1,40) ds_notas
from 	banco_estabelecimento a,
	banco_escritural b,
	titulo_pagar_escrit c,
	titulo_pagar d
where 	a.nr_sequencia = b.nr_seq_conta_banco
	and (b.cd_estabelecimento = a.cd_estabelecimento or obter_estab_financeiro(b.cd_estabelecimento) = a.cd_estabelecimento)
	and c.nr_seq_escrit = b.nr_sequencia
	and d.nr_titulo = c.nr_titulo
	and d.ie_situacao = ie_situacao_w
	and b.nr_sequencia = nr_seq_envio_p;


BEGIN
/*  DELETE EXISTING RECORDS */

delete	from w_envio_banco
where	nm_usuario	= nm_usuario_p;
/* MOUNT FILE DETAILS */

OPEN c01;
LOOP
FETCH c01 INTO
	cd_estabelecimento_w,
	cd_recepient_w,
	vl_importe_w,
	ds_notas_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	nr_seq_apres_w 	:= 	coalesce(nr_seq_apres_w, 0) + 1;

	ds_conteudo_w	:=	cd_recepient_w 	||
			ie_separator_w 	||
			vl_importe_w 	||
			ie_separator_w	||
			elimina_caracteres_especiais_d(elimina_acentuacao(coalesce(ds_notas_w,' ')), ds_invalids_w);

	insert	into w_envio_banco(cd_estabelecimento,
		ds_conteudo,
		dt_atualizacao,
		nm_usuario,
		nr_seq_apres,
		nr_seq_apres_2,
		nr_sequencia)
	values (cd_estabelecimento_w,
		ds_conteudo_w,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_apres_w,
		nr_seq_apres_w,
		nextval('w_envio_banco_seq'));

END LOOP;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_pagt_colombia_bisa_short ( nr_seq_envio_p bigint, nm_usuario_p text) FROM PUBLIC;

