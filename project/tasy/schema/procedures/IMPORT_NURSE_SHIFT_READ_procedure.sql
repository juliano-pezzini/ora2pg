-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE import_nurse_shift_read () AS $body$
BEGIN
declare
nr_seq_int_call_log_w integration_message_log.nr_seq_int_call_log%type := 0;
ds_message_w varchar(4000);
nm_usuario_w varchar(20) := 'NURSE';
ds_error_w varchar(2000);
cd_person_w varchar(20) := null;
patient_data_p varchar(20) := null;

v_linha_w                   varchar(2000) := '';
v_coluna_w                  varchar(3000) := '';
v_arquivo_w                 utl_file.file_type;

/*parametros para insert na tabela nurse shift user daly*/

p_pk_nr_sequencia_w         bigint;
nr_sequence_w               bigint;
/*parametro para backup e exclusao do file*/

nm_new_file_w varchar(40) := 'nursefile_'||to_char(clock_timestamp(), 'yyyymmdd_hh24miss');
ds_files_w                  varchar(4000);
ds_file_w                   varchar(4000) := 'arquivo_teste1.txt';
ds_local_w                  varchar(1000);
ds_dir_oracle_w             varchar(1000);

ds_local_bkp_w              varchar(1000);

begin
select  ds_local,
        ds_dir_oracle
into STRICT    ds_local_w,
        ds_dir_oracle_w
from    evento_tasy_utl_file
where   cd_evento = 7;

select  ds_local
into STRICT    ds_local_bkp_w
from    evento_tasy_utl_file
where   cd_evento = 7;

v_arquivo_w := utl_file.fopen(ds_local_w, ds_file_w,'r');

loop begin
utl_file.get_line(v_arquivo_w, v_linha_w);


--dbms_output.put_line(v_linha_w);    
CALL import_nurse_shift(v_linha_w);

/*backup e exclusao*/

utl_file.fcopy(ds_local_w,
ds_file_w,
ds_local_bkp_w,
nm_new_file_w);

utl_file.fremove(ds_local_bkp_w,ds_file_w);

-- Inicio Inserindo na agreg nursing empl
CALL gerar_agreg_nursing_shift_pck.gerar_agreg_nursing_empl_inf();
CALL gerar_agreg_nursing_shift_pck.gerar_agreg_nrs_empl_daily();
commit;
-- end Inserindo na agreg nursing empl
exception
when no_data_found then
utl_file.fclose(v_arquivo_w);
exit;
when others then
ds_error_w := SQLERRM || ' File Call Error';
nr_seq_int_call_log_w := record_integration_call_log(nm_usuario_w, nm_usuario_w, clock_timestamp(), 'Nurse Shift Management Information', 'Nurse Shift Management Information', 'E', 'R', null, ds_error_w, patient_data_p, ds_error_w, 'Nurse Shift Management Information', nr_seq_int_call_log_w, cd_person_w, null);
end;
end loop;

/*MSG com Sucesso*/

nr_seq_int_call_log_w := record_integration_call_log(nm_usuario_w, nm_usuario_w, clock_timestamp(), 'Nurse Shift Management Information', 'Nurse Shift Management Information', 'T', 'R', null, 'Integration Successfully Performed', patient_data_p, 'Integration Successfully Performed', 'Nurse Shift Management Information', nr_seq_int_call_log_w, 1, null);
exception
when others then
ds_error_w := SQLERRM || ' File Call Error';
/*MSG com Erro*/

nr_seq_int_call_log_w := record_integration_call_log(nm_usuario_w, nm_usuario_w, clock_timestamp(), 'Nurse Shift Management Information', 'Nurse Shift Management Information', 'E', 'R', null, ds_error_w, patient_data_p, ds_error_w, 'Nurse Shift Management Information', nr_seq_int_call_log_w, cd_person_w, null);



end;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE import_nurse_shift_read () FROM PUBLIC;

