-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_carga_sadt ( cd_convenio_p bigint, dt_vigencia_p timestamp, nm_usuario_p text ) AS $body$
DECLARE



cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
qt_reg_w			bigint;
qt_ato_medico_w			smallint;
vl_sadt_w			double precision;
dt_competencia_w		timestamp;
nr_sequencia_w			bigint;

c01 CURSOR FOR
	SELECT	cd_procedimento,
		ie_origem_proced,
		qt_ato_medico,
		vl_sadt
	from	sus_preco_procaih
	where	dt_competencia	= dt_competencia_w
	order	by 1;


BEGIN

select	count(*)
into STRICT	qt_reg_w
from	convenio_sadt
where	cd_convenio	= cd_convenio_p;

if (qt_reg_w = 0) then
	begin
	select	max(dt_competencia)
	into STRICT	dt_competencia_w
	from	sus_preco_procaih;

	open	c01;
	loop
	fetch	c01 into
		cd_procedimento_w,
		ie_origem_proced_w,
		qt_ato_medico_w,
		vl_sadt_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		select	coalesce(max(ie_origem_proced),0)
		into STRICT	ie_origem_proced_w
		from	procedimento
		where	cd_procedimento		= cd_procedimento_w;
		--dbms_output.put_line(cd_procedimento_w);
		if (ie_origem_proced_w <> 0) and
			((qt_ato_medico_w > 0) or (vl_sadt_w > 0)) then
		--	dbms_output.put_line(cd_procedimento_w);
			insert into convenio_sadt(	nr_sequencia,
							cd_convenio,
							cd_procedimento,
							ie_origem_proced,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							qt_ponto,
							vl_sadt,
							dt_inicio_vigencia,
							dt_final_vigencia )
					values (	nextval('convenio_sadt_seq'),
							cd_convenio_p,
							cd_procedimento_w,
							ie_origem_proced_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							qt_ato_medico_w,
							vl_sadt_w,
							trunc(dt_vigencia_p),
							null);


		end if;





	end loop;
	close	c01;
	end;
end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_carga_sadt ( cd_convenio_p bigint, dt_vigencia_p timestamp, nm_usuario_p text ) FROM PUBLIC;

