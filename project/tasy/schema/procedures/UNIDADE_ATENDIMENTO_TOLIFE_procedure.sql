-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE unidade_atendimento_tolife () AS $body$
DECLARE

  json_w PHILIPS_JSON;
  json_aux_w PHILIPS_JSON;
  json_list_w PHILIPS_JSON_LIST;
  json_data_w text;

  amount_in_use_w UNIDADE_ATENDIMENTO.nr_atendimento%TYPE := 0;
  amount_can_be_used_w UNIDADE_ATENDIMENTO.nr_atendimento%TYPE := 0;
  amount_cant_be_used_w UNIDADE_ATENDIMENTO.nr_atendimento%TYPE := 0;
  data_w RECORD;

BEGIN
  json_list_w := philips_json_list();

  FOR data_w IN (
    SELECT
      cua0.nr_sequencia
      ,cua0.ie_situacao
    FROM CLASSIF_UNIDADE_ATEND cua0
    WHERE
      cua0.ie_situacao = 'A'
  )
  LOOP
    SELECT
      COUNT(ua0.nr_atendimento)
    INTO STRICT
      amount_in_use_w
    FROM UNIDADE_ATENDIMENTO ua0
    WHERE
      ua0.nr_seq_classif = data_w.nr_sequencia;

    SELECT
      COUNT(1)
    INTO STRICT
      amount_can_be_used_w
    FROM UNIDADE_ATENDIMENTO ua0
    WHERE
      ua0.nr_seq_classif = data_w.nr_sequencia
      AND ua0.ie_status_unidade IN ('O', 'I', 'S', 'G', 'E', 'C', 'U', 'D', 'H', 'A');

    SELECT
      COUNT(1)
    INTO STRICT
      amount_cant_be_used_w
    FROM UNIDADE_ATENDIMENTO ua0
    WHERE
      ua0.nr_seq_classif = data_w.nr_sequencia
      AND ua0.ie_status_unidade NOT IN ('O', 'I', 'S', 'G', 'E', 'C', 'U', 'D', 'H', 'A');

    json_aux_w := philips_json();
    json_aux_w.put('idTipoLeito', data_w.nr_sequencia);
    json_aux_w.put('qtdeEmUso', amount_in_use_w);
    json_aux_w.put('qtdeNaoOperacional', amount_can_be_used_w);
    json_aux_w.put('qtdeOperacional', amount_cant_be_used_w);
    json_list_w.append(json_aux_w.to_json_value());
  END LOOP;

  json_w := philips_json();
  json_w.put('leitos', json_list_w.to_json_value());

  DBMS_LOB.CREATETEMPORARY(json_data_w, true);
  json_w.(json_data_w);

  json_data_w := bifrost.send_integration_content('api.tolife.bed', json_data_w, wheb_usuario_pck.get_nm_usuario);
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE unidade_atendimento_tolife () FROM PUBLIC;

