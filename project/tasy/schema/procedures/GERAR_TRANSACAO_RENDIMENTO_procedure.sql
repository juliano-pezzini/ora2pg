-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_transacao_rendimento (nr_seq_rendimento_p bigint, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_aplicacao_w		bigint;
cd_estabelecimento_w		smallint;
nr_seq_trans_fin_rend_w		bigint;
dt_rendimento_w			timestamp;
nr_seq_conta_bco_aplic_w	bigint;
vl_rendimento_w			double precision;
vl_rendimento_estrang_w		double precision;
vl_complemento_w		double precision;
vl_cotacao_w			cotacao_moeda.vl_cotacao%type;
cd_moeda_w			integer;
nr_seq_saldo_bco_w		bigint;
dt_referencia_w			timestamp;
ie_saldo_fechado_w		varchar(10);
nr_seq_movto_trans_w		bigint;


BEGIN
-- Busca os dados da aplicacao para gerar as transacoes de entrada e saida do banco
select	a.nr_seq_aplicacao,
	a.cd_estabelecimento,
	a.nr_seq_trans_fin_rend,
	a.dt_rendimento,
	b.nr_seq_conta_bco_aplic,
	a.vl_rendimento,
	a.vl_rendimento_estrang,
	a.vl_cotacao,
	a.cd_moeda,
	a.nr_seq_movto_trans_fin
into STRICT	nr_seq_aplicacao_w,
	cd_estabelecimento_w,
	nr_seq_trans_fin_rend_w,
	dt_rendimento_w,
	nr_seq_conta_bco_aplic_w,
	vl_rendimento_w,
	vl_rendimento_estrang_w,
	vl_cotacao_w,
	cd_moeda_w,
	nr_seq_movto_trans_w
from	banco_rendimento a,
	banco_aplicacao b
where	a.nr_seq_aplicacao = b.nr_sequencia
and	a.nr_sequencia = nr_seq_rendimento_p;

select	max(nr_sequencia),
	max(dt_referencia)
into STRICT	nr_seq_saldo_bco_w,
	dt_referencia_w
from	banco_saldo
where	nr_seq_conta = nr_seq_conta_bco_aplic_w
and	trunc(dt_referencia,'month') = trunc(dt_rendimento_w,'month');

if (coalesce(nr_seq_saldo_bco_w::text, '') = '') then
	/* Nao existe saldo aberto para a conta selecionada na data do rendimento. */

	CALL wheb_mensagem_pck.exibir_mensagem_abort(355274);
end if;
select	obter_se_banco_fechado(nr_seq_conta_bco_aplic_w,dt_referencia_w)
into STRICT	ie_saldo_fechado_w
;
if (coalesce(ie_saldo_fechado_w,'N') = 'S') then
	/* Nao existe saldo aberto para a conta selecionada na data do rendimento. */

	CALL wheb_mensagem_pck.exibir_mensagem_abort(355274);
end if;

/* Projeto Multimoeda - Verifica se a aplicacao e em moeda estrangeira, caso positivo realiza os calculos antes de criar os registros.*/

if (coalesce(vl_rendimento_estrang_w,0) <> 0 and coalesce(vl_cotacao_w,0) <> 0) then
	vl_complemento_w := vl_rendimento_w - vl_rendimento_estrang_w;
else
	vl_rendimento_estrang_w := null;
	vl_complemento_w := null;
	vl_cotacao_w := null;
end if;

if (ie_opcao_p = 'I') then
	begin
	select	nextval('movto_trans_financ_seq')
	into STRICT	nr_seq_movto_trans_w
	;

	insert into movto_trans_financ(	nr_sequencia,
					cd_estabelecimento,
					nr_seq_trans_financ,
					dt_transacao,
					vl_transacao,
					vl_transacao_estrang,
					vl_complemento,
					vl_cotacao,
					cd_moeda,
					nr_seq_banco,
					nr_seq_saldo_banco,
					nr_seq_aplicacao,
					nr_lote_contabil,
					ie_conciliacao,
					nm_usuario,
					dt_atualizacao)
	values (nr_seq_movto_trans_w,
		cd_estabelecimento_w,
		nr_seq_trans_fin_rend_w,
		dt_rendimento_w,
		vl_rendimento_w,
		vl_rendimento_estrang_w,
		vl_complemento_w,
		vl_cotacao_w,
		cd_moeda_w,
		nr_seq_conta_bco_aplic_w,
		nr_seq_saldo_bco_w,
		nr_seq_aplicacao_w,
		0,
		'N',
		nm_usuario_p,
		clock_timestamp());
	
	update	banco_rendimento
	set	nr_seq_movto_trans_fin = nr_seq_movto_trans_w,
		dt_atualizacao = clock_timestamp(),
		nm_usuario = nm_usuario_p
	where	nr_sequencia = nr_seq_rendimento_p;
	
	end;
elsif (ie_opcao_p = 'E' and (nr_seq_movto_trans_w IS NOT NULL AND nr_seq_movto_trans_w::text <> '')) then
	begin
	CALL estornar_movto_banco(cd_estabelecimento_w,
				nr_seq_movto_trans_w,
				coalesce(dt_rendimento_w,clock_timestamp()),
				nm_usuario_p,
				'N');
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_transacao_rendimento (nr_seq_rendimento_p bigint, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

