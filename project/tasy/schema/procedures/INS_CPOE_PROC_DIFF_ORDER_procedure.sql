-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ins_cpoe_proc_diff_order ( nr_seq_cpoe_dias_proc_p bigint, ds_seq_proc_list_p text, nm_usuario_p text) AS $body$
DECLARE

ds_seq_proc_list_w	varchar(2000);
exam_list_w			bigint;
ie_final_w			varchar(1);
ie_pos_w			smallint;
nr_seq_exam_cont_w  	bigint;
ie_count_w			bigint;


BEGIN

 if (ds_seq_proc_list_p IS NOT NULL AND ds_seq_proc_list_p::text <> '') and (nr_seq_cpoe_dias_proc_p IS NOT NULL AND nr_seq_cpoe_dias_proc_p::text <> '') then
	ds_seq_proc_list_w  := ds_seq_proc_list_p;
	
	exam_list_w := length(ds_seq_proc_list_w);
	
	if (substr(ds_seq_proc_list_w, exam_list_w-1, exam_list_w) = ',') then
        ds_seq_proc_list_w := substr(ds_seq_proc_list_w, 1, length(ds_seq_proc_list_w)-1);
    end if;
	
	ie_final_w          := 'N';
	while (exam_list_w IS NOT NULL AND exam_list_w::text <> '') loop
		begin
			nr_seq_exam_cont_w := 0;
			exam_list_w := length(ds_seq_proc_list_w);
			ie_pos_w := position(',' in ds_seq_proc_list_w);
			if (ie_pos_w = 0) then
				ie_final_w := 'S';
				nr_seq_exam_cont_w := (ds_seq_proc_list_w)::numeric;
				ds_seq_proc_list_w := null;
			elsif (ie_pos_w = 1) then
				ds_seq_proc_list_w	:= substr(ds_seq_proc_list_w, (ie_pos_w + 1), exam_list_w);
			else
				nr_seq_exam_cont_w	:= (substr(ds_seq_proc_list_w, 1, (ie_pos_w - 1)))::numeric;
                ds_seq_proc_list_w	:= substr(ds_seq_proc_list_w, (ie_pos_w + 1), exam_list_w);
			end if;
			 if ((nr_seq_exam_cont_w IS NOT NULL AND nr_seq_exam_cont_w::text <> '') and nr_seq_exam_cont_w > 0) then
                select 	count(1)
				into STRICT	ie_count_w
				from	cpoe_proc_diff_order_unit a
				where	a.nr_seq_cpoe_dias_proc = nr_seq_cpoe_dias_proc_p
				and		a.nr_seq_proc_interno = nr_seq_exam_cont_w
				and 	a.nm_usuario = nm_usuario_p;
				
				if (ie_count_w = 0) then
					INSERT INTO cpoe_proc_diff_order_unit(	nr_sequencia,
																nr_seq_cpoe_dias_proc, 
																nr_seq_proc_interno,
																nm_usuario,
																nm_usuario_nrec,
																dt_atualizacao,
																dt_atualizacao_nrec,
																ie_selected) 
													VALUES (	nextval('cpoe_proc_diff_order_unit_seq'),
																nr_seq_cpoe_dias_proc_p,
																nr_seq_exam_cont_w,
																nm_usuario_p,
																nm_usuario_p,
																clock_timestamp(),
																clock_timestamp(),
																'S');
				end if;
				
            end if;
			
		end;
	end loop;
	
 end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ins_cpoe_proc_diff_order ( nr_seq_cpoe_dias_proc_p bigint, ds_seq_proc_list_p text, nm_usuario_p text) FROM PUBLIC;

