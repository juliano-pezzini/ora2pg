-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_equipe_atend (nr_atendimento_p bigint, nr_prescricao_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_equipe_w	 	bigint;
ie_tipo_profissional_w	varchar(15);
nr_sequencia_w		bigint;
cd_setor_atendimento_w	integer;
nr_seq_proc_interno_w	bigint;

C01 CURSOR FOR  --Procedimentos
	SELECT	a.nr_seq_proc_interno,
		b.cd_setor_atendimento
	from	prescr_procedimento a,
		prescr_medica b
	where	a.nr_prescricao = b.nr_prescricao
	and	a.nr_prescricao = nr_prescricao_p
	and	coalesce(a.ie_suspenso,'N') = 'N';


C02 CURSOR FOR  --Profissionais do procedimento
	SELECT	a.ie_profissional
	from	proc_interno_prof a,
		proc_interno b
	where	a.nr_seq_proc_interno = b.nr_sequencia
	and	b.nr_sequencia = nr_seq_proc_interno_w;

C03 CURSOR FOR  --Regras
	SELECT	a.nr_seq_equipe
	from	sp_regra_aloc_prof a
	where	coalesce(a.cd_setor_atendimento, coalesce(cd_setor_atendimento_w,0)) = coalesce(cd_setor_atendimento_w,0)
	and	a.ie_tipo_profissional = ie_tipo_profissional_w
	and	not exists (	SELECT	1
				from	sp_equipe_atend b
				where	b.nr_seq_equipe = a.nr_seq_equipe
				and	b.nr_atendimento = nr_atendimento_p)
	order by a.nr_seq_prior;


BEGIN
open C01;
loop
fetch C01 into
	nr_seq_proc_interno_w,
	cd_setor_atendimento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	open C02;
	loop
	fetch C02 into
		ie_tipo_profissional_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin

		open C03;
		loop
		fetch C03 into
			nr_seq_equipe_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin


			select 	nextval('sp_equipe_atend_seq')
			into STRICT 	nr_sequencia_w
			;


			insert into	sp_equipe_atend(nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_seq_equipe,
							nr_atendimento,
							ie_forma_aloc_prof
							)
				values (nr_sequencia_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							nr_seq_equipe_w,
							nr_atendimento_p,
							'EF'
							);

			end;
		end loop;
		close C03;

		end;
	end loop;
	close C02;

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_equipe_atend (nr_atendimento_p bigint, nr_prescricao_p bigint, nm_usuario_p text) FROM PUBLIC;

