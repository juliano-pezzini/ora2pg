-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consist_abrang_benef_repas ( nr_seq_segurado_p bigint, nr_seq_operadora_atend_p bigint, nm_usuario_p text, ie_area_coberta_p INOUT text) AS $body$
DECLARE


qt_repasse_w				bigint;
ie_tipo_repasse_w			varchar(2);
nr_seq_congenere_w			bigint;
ie_atend_operadora_repasse_w		varchar(2);
nr_seq_plano_w				bigint;


BEGIN
ie_area_coberta_p	:= 'S';

-- Verificação de tipo de repasse do beneficiário e da regra de autorização
begin
	select	max(ie_tipo_repasse)
	into STRICT	ie_tipo_repasse_w
	from	pls_segurado_repasse
	where	nr_seq_segurado	= nr_seq_segurado_p
	and (coalesce(ie_tipo_compartilhamento::text, '') = '' or ie_tipo_compartilhamento = 1);

	select	nr_seq_plano
	into STRICT	nr_seq_plano_w
	from	pls_segurado
	where	nr_sequencia	= nr_seq_segurado_p;

	select	coalesce(ie_atend_operadora_repasse, 'N')
	into STRICT	ie_atend_operadora_repasse_w
	from	pls_regra_intercambio_aut
	where	((ie_tipo_repasse	= ie_tipo_repasse_w)
	or (coalesce(ie_tipo_repasse::text, '') = ''));
exception
when others then
	ie_atend_operadora_repasse_w	:= 'N';
end;

if (ie_atend_operadora_repasse_w	= 'S') then
	begin
		select	coalesce(nr_seq_congenere_atend,nr_seq_congenere)
		into STRICT	nr_seq_congenere_w
		from	pls_segurado_repasse
		where	nr_seq_segurado	= nr_seq_segurado_p
		and	clock_timestamp()	between dt_repasse and fim_dia(dt_fim_repasse)
		and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and (coalesce(ie_tipo_compartilhamento::text, '') = '' or ie_tipo_compartilhamento = 1);
	exception
	when others then
		nr_seq_congenere_w	:= 0;
	end;
	--Beneficiário foi repassado para outra Unimed, quando vier uma guia deste usuário com a Unimed Executora igual a Unimed que ele foi repassado, não poderá glosar, pois o repasse foi realizado para esta Operadora.
	--pls_consistir_area_atuacao(nr_seq_plano_w, nr_seq_operadora_atend_p, null, nr_seq_congenere_w, ie_area_coberta_p);
	if (nr_seq_operadora_atend_p	= nr_seq_congenere_w) then
		ie_area_coberta_p	:= 'S';
	else
		ie_area_coberta_p	:= 'N';
	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consist_abrang_benef_repas ( nr_seq_segurado_p bigint, nr_seq_operadora_atend_p bigint, nm_usuario_p text, ie_area_coberta_p INOUT text) FROM PUBLIC;

