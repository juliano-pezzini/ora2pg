-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rxt_inat_criar_plan_fisico ( nr_seq_plan_fis_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_tipo_trat_p text, nr_sequencia_p INOUT bigint ) AS $body$
DECLARE

nr_seq_fase_w double precision;
qt_x1_w double precision;
qt_x2_w double precision;
qt_y1_w double precision;
qt_y2_w double precision;
qt_angulo_gantry_w double precision;
qt_angulo_colimador_w double precision;
qt_angulo_mesa_x_w double precision;
qt_angulo_mesa_y_w double precision;
qt_angulo_mesa_z_w double precision;
ds_tamanho_campo_w double precision;
qt_campo_equivalente_w double precision;
qt_distancia_isocentro_w double precision;
qt_dose_tumor_real_w double precision;
qt_dose_tumor_diaria_w double precision;
qt_numero_aplicacoes_w double precision;
qt_profundidade_w double precision;
qt_percent_dose_profunda_w double precision;
qt_tmr_w double precision;
qt_rendimento_final_w double precision;
qt_abertura_colimador_w double precision;
qt_fator_retroespalhamento_w double precision;
qt_fator_filtro_w double precision;
qt_fator_distancia_w double precision;
qt_diametro_antero_post_w double precision;
qt_latero_lateral_w double precision;
qt_distancia_mesa_centro_w double precision;
qt_unidade_monitor_w double precision;
nr_seq_campo_w double precision;
qt_fator_bandeja_w double precision;
qt_tam_x_w double precision;
qt_tam_y_w double precision;
ie_tipo_x_w varchar(10);
ie_tipo_y_w varchar(10);
ds_campo_tratamento_w varchar(2000);
qt_ssd_w double precision;
qt_angulo_mesa_w double precision;
nr_seq_energia_rad_w double precision;
nr_seq_ene_fotons_w double precision;
qt_angulo_gantry_final_w double precision;
qt_ang_colimador_final_w double precision;
ds_observacao_fisico_w varchar(2000);
nr_seq_aplic_w			rxt_plan_braqui_fisico.nr_seq_aplic%type;
qt_dose_reto_w			rxt_plan_braqui_fisico.qt_dose_reto%type;	
qt_dose_bexiga_w		rxt_plan_braqui_fisico.qt_dose_bexiga%type;
qt_dose_clip_w			rxt_plan_braqui_fisico.qt_dose_clip%type;
qt_v100_w				rxt_plan_braqui_fisico.qt_v100%type;
qt_v150_w				rxt_plan_braqui_fisico.qt_v150%type;
qt_v150_100_w			rxt_plan_braqui_fisico.qt_v150_100%type;
ds_resultado_w			rxt_plan_braqui_fisico.ds_resultado%type;
nr_insercao_w			rxt_plan_braqui_fisico.nr_insercao%type;
qt_atividade_ci_w		rxt_plan_braqui_fisico.qt_atividade_ci%type;
qt_tempo_w				rxt_plan_braqui_fisico.qt_tempo%type;
qt_angulacao_w			rxt_plan_braqui_fisico.qt_angulacao%type;
ie_ponto_av_dose_w		rxt_plan_braqui_fisico.ie_ponto_avaliacao_dose%type;
qt_dose_ponto_av_w		rxt_plan_braqui_fisico.qt_dose_ponto_avaliacao%type;
ie_volume_w				rxt_plan_braqui_fisico.ie_volume%type;
qt_dose_volume_w		rxt_plan_braqui_fisico.qt_dose_volume%type;
nr_seq_aplic_trat_w		rxt_plan_braqui_fisico.nr_seq_braq_aplic_trat%type;



BEGIN

if (ie_tipo_trat_p = 'T') then
	select 	nr_seq_fase,
			qt_x1,
			qt_x2, 
			qt_y1, 
			qt_y2, 
			qt_angulo_gantry, 
			qt_angulo_colimador, 
			qt_angulo_mesa_x,
			qt_angulo_mesa_y, 
			qt_angulo_mesa_z, 
			ds_tamanho_campo, 
			qt_campo_equivalente, 
			qt_distancia_isocentro,
			qt_dose_tumor_real,
			qt_dose_tumor_diaria, 
			qt_numero_aplicacoes, 
			qt_profundidade, 
			qt_percent_dose_profunda,
			qt_tmr, 
			qt_rendimento_final,
			qt_abertura_colimador, 
			qt_fator_retroespalhamento, 
			qt_fator_filtro, 
			qt_fator_distancia, 
			qt_diametro_antero_post, 
			qt_latero_lateral, 
			qt_distancia_mesa_centro,
			qt_unidade_monitor, 
			nr_seq_campo, 
			qt_fator_bandeja,
			qt_tam_x, 
			qt_tam_y, 
			ie_tipo_x, 
			ie_tipo_y, 
			ds_campo_tratamento,
			qt_ssd, 
			qt_angulo_mesa,
			nr_seq_energia_rad,
			nr_seq_ene_fotons,
			qt_angulo_gantry_final,
			qt_ang_colimador_final,
			ds_observacao_fisico
	into STRICT 	nr_seq_fase_w,
			qt_x1_w, 
			qt_x2_w, 
			qt_y1_w, 
			qt_y2_w, 
			qt_angulo_gantry_w,
			qt_angulo_colimador_w,
			qt_angulo_mesa_x_w,
			qt_angulo_mesa_y_w,
			qt_angulo_mesa_z_w,
			ds_tamanho_campo_w,
			qt_campo_equivalente_w, 
			qt_distancia_isocentro_w, 
			qt_dose_tumor_real_w, 
			qt_dose_tumor_diaria_w, 
			qt_numero_aplicacoes_w, 
			qt_profundidade_w, 
			qt_percent_dose_profunda_w, 
			qt_tmr_w,
			qt_rendimento_final_w, 
			qt_abertura_colimador_w, 
			qt_fator_retroespalhamento_w,
			qt_fator_filtro_w,
			qt_fator_distancia_w,
			qt_diametro_antero_post_w, 
			qt_latero_lateral_w,
			qt_distancia_mesa_centro_w,
			qt_unidade_monitor_w, 
			nr_seq_campo_w, 
			qt_fator_bandeja_w, 
			qt_tam_x_w, 
			qt_tam_y_w, 
			ie_tipo_x_w, 
			ie_tipo_y_w, 
			ds_campo_tratamento_w, 
			qt_ssd_w, 
			qt_angulo_mesa_w,
			nr_seq_energia_rad_w, 
			nr_seq_ene_fotons_w, 
			qt_angulo_gantry_final_w,
			qt_ang_colimador_final_w, 
			ds_observacao_fisico_w
	from 	rxt_planejamento_fisico
	where 	nr_sequencia = nr_seq_plan_fis_p;
	
	select nextval('rxt_planejamento_fisico_seq')
	into STRICT nr_sequencia_p
	;

	insert into rxt_planejamento_fisico(dt_atualizacao,
										nm_usuario,
										nr_seq_fase, 
										cd_estabelecimento,
										nr_sequencia,
										qt_x1,
										qt_x2,
										qt_y1,
										qt_y2,
										qt_angulo_gantry,
										qt_angulo_colimador,
										qt_angulo_mesa_x,
										qt_angulo_mesa_y,
										qt_angulo_mesa_z, 
										ds_tamanho_campo,
										qt_campo_equivalente, 
										qt_distancia_isocentro, 
										qt_dose_tumor_real, 
										qt_dose_tumor_diaria,
										qt_numero_aplicacoes, 
										qt_profundidade, 
										qt_percent_dose_profunda,
										qt_tmr, 
										qt_rendimento_final,
										qt_abertura_colimador,
										qt_fator_retroespalhamento,
										qt_fator_filtro,
										qt_fator_distancia,
										qt_diametro_antero_post,
										qt_latero_lateral,
										qt_distancia_mesa_centro, 
										qt_unidade_monitor,
										nr_seq_campo,
										qt_fator_bandeja, 
										qt_tam_x, 
										qt_tam_y, 
										ie_tipo_x,
										ie_tipo_y,
										ds_campo_tratamento, 
										qt_ssd, 
										qt_angulo_mesa, 
										nr_seq_energia_rad,
										nr_seq_ene_fotons,
										qt_angulo_gantry_final,
										qt_ang_colimador_final,
										ie_situacao,
										ds_observacao_fisico,
										nr_seq_planejamento_inativacao) 
	values (clock_timestamp(), 
										nm_usuario_p, 
										nr_seq_fase_w, 
										cd_estabelecimento_p, 
										nr_sequencia_p, 
										qt_x1_w, 
										qt_x2_w, 
										qt_y1_w, 
										qt_y2_w, 
										qt_angulo_gantry_w,
										qt_angulo_colimador_w, 
										qt_angulo_mesa_x_w,
										qt_angulo_mesa_y_w, 
										qt_angulo_mesa_z_w,
										ds_tamanho_campo_w, 
										qt_campo_equivalente_w, 
										qt_distancia_isocentro_w,
										qt_dose_tumor_real_w,
										qt_dose_tumor_diaria_w, 
										qt_numero_aplicacoes_w,
										qt_profundidade_w,
										qt_percent_dose_profunda_w,
										qt_tmr_w, 
										qt_rendimento_final_w, 
										qt_abertura_colimador_w, 
										qt_fator_retroespalhamento_w,
										qt_fator_filtro_w,
										qt_fator_distancia_w,
										qt_diametro_antero_post_w, 
										qt_latero_lateral_w, 
										qt_distancia_mesa_centro_w,
										qt_unidade_monitor_w,
										nr_seq_campo_w,
										qt_fator_bandeja_w, 
										qt_tam_x_w,
										qt_tam_y_w, 
										ie_tipo_x_w, 
										ie_tipo_y_w, 
										ds_campo_tratamento_w,
										qt_ssd_w,
										qt_angulo_mesa_w,
										nr_seq_energia_rad_w,
										nr_seq_ene_fotons_w,
										qt_angulo_gantry_final_w,
										qt_ang_colimador_final_w,
										'A', 
										ds_observacao_fisico_w,
										nr_seq_plan_fis_p);

	update 	rxt_planejamento_fisico
	set 	dt_inativacao = clock_timestamp(), 
			nm_usuario_inativacao = nm_usuario_p,
			ie_situacao = 'I'
	where	 nm_usuario = nm_usuario_p
	and 	nr_sequencia = nr_seq_plan_fis_p;
	
	
elsif (ie_tipo_trat_p = 'B') then
	
	select  nr_seq_aplic,
			qt_dose_reto,                   
			qt_dose_bexiga,                 
			qt_dose_clip,                   
			qt_v100,                        
			qt_v150,                        
			qt_v150_100,                    
			ds_resultado,                   
			nr_insercao,                    
			nr_seq_campo,                   
			qt_atividade_ci,                
			qt_tempo,                       
			qt_angulacao,                   
			ie_ponto_avaliacao_dose,        
			qt_dose_ponto_avaliacao,        
			ie_volume,                      
			qt_dose_volume,                 
			nr_seq_braq_aplic_trat,                           
			ds_observacao_fisico
	into STRICT	nr_seq_aplic_w,                   
			qt_dose_reto_w,                   
			qt_dose_bexiga_w,                 
			qt_dose_clip_w,                   
			qt_v100_w,                        
			qt_v150_w,                        
			qt_v150_100_w,                    
			ds_resultado_w,                   
			nr_insercao_w,                    
			nr_seq_campo_w,                   
			qt_atividade_ci_w,                
			qt_tempo_w,                       
			qt_angulacao_w,                   
			ie_ponto_av_dose_w,        
			qt_dose_ponto_av_w,        
			ie_volume_w,                      
			qt_dose_volume_w,                 
			nr_seq_aplic_trat_w,                           
			ds_observacao_fisico_w
	from 	rxt_plan_braqui_fisico
	where 	nr_sequencia = nr_seq_plan_fis_p;
	
	select nextval('rxt_plan_braqui_fisico_seq')
	into STRICT nr_sequencia_p
	;
	
	insert into rxt_plan_braqui_fisico(	nr_sequencia,
										dt_atualizacao,        
										nm_usuario,             
										dt_atualizacao_nrec,    
										nm_usuario_nrec,                    
										qt_dose_reto,                   
										qt_dose_bexiga,                 
										qt_dose_clip,                   
										qt_v100,                        
										qt_v150,                        
										qt_v150_100,                    
										ds_resultado,                   
										nr_insercao,                    
										nr_seq_campo,                   
										qt_atividade_ci,                
										qt_tempo,                       
										qt_angulacao,                   
										ie_ponto_avaliacao_dose,        
										qt_dose_ponto_avaliacao,        
										ie_volume,                      
										qt_dose_volume,                 
										nr_seq_braq_aplic_trat,                           
										ds_observacao_fisico,
										ie_situacao,
										nr_seq_planejamento_inativacao)
	values (nr_sequencia_p,
										clock_timestamp(),
										nm_usuario_p,
										clock_timestamp(),
										nm_usuario_p,                   
										qt_dose_reto_w,                   
										qt_dose_bexiga_w,                 
										qt_dose_clip_w,                   
										qt_v100_w,                        
										qt_v150_w,                        
										qt_v150_100_w,                    
										ds_resultado_w,                   
										nr_insercao_w,                    
										nr_seq_campo_w,                   
										qt_atividade_ci_w,                
										qt_tempo_w,                       
										qt_angulacao_w,                   
										ie_ponto_av_dose_w,        
										qt_dose_ponto_av_w,        
										ie_volume_w,                      
										qt_dose_volume_w,                 
										nr_seq_aplic_trat_w,                           
										ds_observacao_fisico_w,
										'A',
										nr_seq_plan_fis_p);
	
	update rxt_plan_braqui_fisico
	set 	dt_inativacao = clock_timestamp(),
			nm_usuario_inativacao = nm_usuario_p,
			ie_situacao = 'I'
	where	nm_usuario = nm_usuario_p
	and 	nr_sequencia = nr_seq_plan_fis_p;
	
	
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rxt_inat_criar_plan_fisico ( nr_seq_plan_fis_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_tipo_trat_p text, nr_sequencia_p INOUT bigint ) FROM PUBLIC;

