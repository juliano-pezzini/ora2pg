-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE agenda_retorno_agenda_multi ( nr_seq_agenda_atual_p bigint, nr_seq_agenda_retorno_p bigint, dt_agenda_retorno_p timestamp) AS $body$
DECLARE

 
cd_convenio_w			integer;
dt_nascimento_pac_w		timestamp;
nr_telefone_w			varchar(80);
cd_categoria_w			varchar(10);
cd_tipo_acomodacao_w		smallint;
cd_usuario_convenio_w		varchar(30);
cd_complemento_w		varchar(30);
dt_validade_carteira_w		timestamp;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
nm_paciente_w			varchar(80);

cd_agenda_w			bigint;
nr_seq_turno_w			bigint;
dt_agenda_w			timestamp;
nm_usuario_w			varchar(15);


BEGIN 
if (nr_seq_agenda_retorno_p = 0) then 
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(262551);
elsif (dt_agenda_retorno_p < clock_timestamp()) then 
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(262552);
else 
 
	select	cd_convenio, 
		dt_nascimento_pac, 
		nr_telefone, 
		cd_categoria, 
		cd_tipo_acomodacao, 
		cd_usuario_convenio, 
		cd_complemento, 
		dt_validade_carteira, 
		cd_procedimento, 
		ie_origem_proced, 
		nm_paciente 
	into STRICT	cd_convenio_w, 
		dt_nascimento_pac_w, 
		nr_telefone_w, 
		cd_categoria_w, 
		cd_tipo_acomodacao_w, 
		cd_usuario_convenio_w, 
		cd_complemento_w, 
		dt_validade_carteira_w, 
		cd_procedimento_w, 
		ie_origem_proced_w, 
		nm_paciente_w 
	from	agenda_consulta 
	where	nr_sequencia		= nr_seq_agenda_atual_p;
	 
	update	agenda_consulta 
	set	ie_status_agenda	= 'N', 
		cd_convenio		= cd_convenio_w, 
		dt_nascimento_pac	= dt_nascimento_pac_w, 
		nr_telefone		= nr_telefone_w, 
		cd_categoria		= cd_categoria_w, 
		cd_tipo_acomodacao	= cd_tipo_acomodacao_w, 
		cd_usuario_convenio	= cd_usuario_convenio_w, 
		cd_complemento		= cd_complemento_w, 
		dt_validade_carteira	= dt_validade_carteira_w, 
		cd_procedimento		= cd_procedimento_w, 
		ie_origem_proced	= ie_origem_proced_w, 
		nm_paciente		= nm_paciente_w, 
		dt_agendamento		= clock_timestamp(), 
		qt_idade_pac		= obter_idade(dt_nascimento_pac_w, dt_agenda_retorno_p, 'A') 
	where	nr_sequencia		= nr_seq_agenda_retorno_p;
 
	select	cd_agenda, 
		nr_seq_turno, 
		dt_agenda, 
		nm_usuario 
	into STRICT	cd_agenda_w, 
		nr_seq_turno_w, 
		dt_agenda_w, 
		nm_usuario_w 
	from	agenda_consulta 
	where	nr_sequencia		= nr_seq_agenda_retorno_p;
 
	CALL Gerar_Prof_Agenda_servico(cd_agenda_w, nr_seq_agenda_retorno_p, nr_seq_turno_w, dt_agenda_w, nm_usuario_w);
	 
	commit;		
 
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE agenda_retorno_agenda_multi ( nr_seq_agenda_atual_p bigint, nr_seq_agenda_retorno_p bigint, dt_agenda_retorno_p timestamp) FROM PUBLIC;

