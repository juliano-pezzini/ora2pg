-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_historico_dano_os ( nr_sequencia_p bigint, nr_seq_tipo_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_dano_breve_w			varchar(255);
ds_dano_w			varchar(4000);
ds_comunicado_w			man_ordem_serv_tecnico.ds_relat_tecnico%type;

nr_seq_localizacao_w		man_localizacao.nr_sequencia%type;
cd_cnpj_w			man_localizacao.cd_cnpj%type;
nr_seq_idioma_w			pessoa_juridica.nr_seq_idioma%type;


BEGIN

select	ds_dano_breve,
	ds_dano,
	nr_seq_localizacao
into STRICT	ds_dano_breve_w,
	ds_dano_w,
	nr_seq_localizacao_w
from	man_ordem_servico
where	nr_sequencia = nr_sequencia_p;

/*338227 = Descrição da OS; 338228 = Dano da OS*/

ds_comunicado_w :=	substr(obter_desc_expressao(732002) || ds_dano_breve_w  || chr(13) || chr(10) || chr(13) || chr(10) ||
					obter_desc_expressao(732006) ||  chr(13) || chr(10) || ds_dano_w,1,32000);

if (nr_seq_tipo_p in (1,2,6,129,130,132,143)) then -- Tipo de históricos que foram tradados no Servidor, que vão para cliente (externos)
	if (nr_seq_localizacao_w IS NOT NULL AND nr_seq_localizacao_w::text <> '') then
		select	max(a.cd_cnpj)
		into STRICT	cd_cnpj_w
		from	man_localizacao	a
		where	a.nr_sequencia	= nr_seq_localizacao_w;

		if (cd_cnpj_w IS NOT NULL AND cd_cnpj_w::text <> '') then
			select	max(a.nr_seq_idioma)
			into STRICT	nr_seq_idioma_w
			from	pessoa_juridica	a
			where	a.cd_cgc	= cd_cnpj_w;

			if (nr_seq_idioma_w IS NOT NULL AND nr_seq_idioma_w::text <> '') then
											/*Descrição da OS*/

				ds_comunicado_w :=	substr(substr(obter_texto_dic_objeto(338227,nr_seq_idioma_w,'DS_DESCRICAO='||ds_dano_breve_w),1,255) || chr(13) || chr(10) || chr(13) || chr(10) ||
						/*Dano da OS*/
			substr(obter_texto_dic_objeto(338228,nr_seq_idioma_w,substr('DS_DANO='||ds_dano_w,1,1000)),1,2000),1,32000);

			end if;
		end if;
	end if;
end if;

insert into man_ordem_serv_tecnico(
		nr_sequencia,
		nr_seq_ordem_serv,
		dt_atualizacao,
		nm_usuario,
		ds_relat_tecnico,
		dt_historico,
		ie_origem,
		nr_seq_tipo,
		dt_liberacao,
		nm_usuario_lib)
	values (	nextval('man_ordem_serv_tecnico_seq'),
		nr_sequencia_p,
		clock_timestamp(),
		nm_usuario_p,
		ds_comunicado_w,
		clock_timestamp(),
		'I',
		nr_seq_tipo_p,
		clock_timestamp(),
		nm_usuario_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_historico_dano_os ( nr_sequencia_p bigint, nr_seq_tipo_p bigint, nm_usuario_p text) FROM PUBLIC;

