-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_ci_paciente_sne (nr_prescricao_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, nr_sequencia_p bigint, ie_momento_p text default 'L') AS $body$
DECLARE


ds_titulo_w			varchar(255);
nm_paciente_w			varchar(255);
nm_medico_w			varchar(255);
nm_usuario_destino_w		varchar(255);
ie_medicacao_paciente_w		varchar(255);
ds_comunicado_w			varchar(4000);
ds_comunic_w			varchar(4000);
ds_material_w			varchar(4000);
ds_justificativa_w		varchar(4000);
ds_comunic_final_w		varchar(4000);
cd_perfil_destino_w		varchar(4000);
ds_lista_usuario_destino_w	varchar(1000);
ie_somente_padrao_w		varchar(1);
cd_mat_w			bigint;
cd_setor_w			bigint;
cd_perfil_w			varchar(1000);
ie_enviar_atb_w		varchar(10);
ie_classif_custo_w	varchar(10);
ds_dose_w			varchar(1000);
ds_setor_w			varchar(1000);
ds_convenio_w			varchar(1000);
nr_sequencia_w			bigint;
nr_sequencia_ww			bigint;
cd_grupo_material_w		integer;
cd_subgrupo_material_w		integer;
cd_classe_material_w		integer;
nr_seq_comunic_w		bigint;
nr_min_prescr_w			bigint;
cd_material_w			bigint;
nr_atendimento_w		bigint;
ie_primeiro_dia_w		varchar(1);
ie_enviar_prescritor_w		varchar(1);
ie_ctrl_medic_w			bigint;
nr_seq_medic_w			bigint;
ie_objetivo_w			varchar(60);
qt_dias_solicitado_w		smallint;
cd_convenio_w			integer;
cd_categoria_w			varchar(10);

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.ds_titulo,
	a.ds_comunicado,
	a.ie_somente_padrao,
	a.cd_grupo_material,
	a.cd_subgrupo_material,
	a.cd_classe_material,
	a.cd_material,
	coalesce(a.ie_enviar_prescritor,'S'),
	a.ie_primeiro_dia,
	coalesce(a.ie_dados_atb,'S'),
	ie_classif_custo
from	rep_regra_envio_ci_padrao a
where	obter_se_setor_lib_ci(a.nr_sequencia, cd_setor_w) = 'S'
and	((coalesce(cd_estab::text, '') = '') or (cd_estabelecimento_p = cd_estab))
and (coalesce(a.cd_convenio,coalesce(cd_convenio_w,0)) = coalesce(cd_convenio_w,0))
and	coalesce(ie_momento,'L') = ie_momento_p
and (coalesce(a.cd_categoria,coalesce(cd_categoria_w,'0')) = coalesce(cd_categoria_w,'0'));

c02 CURSOR FOR
SELECT	b.cd_perfil
from	rep_regra_envio_ci_perfil b
where	b.nr_seq_regra	= nr_sequencia_ww;

c14 CURSOR FOR
SELECT	ds_justificativa,
	substr(Obter_Descricao_mat_prescr(c.cd_material),1,80),
	a.cd_material,
	(c.qt_dose || c.cd_unidade_medida_dose),
	c.IE_MEDICACAO_PACIENTE,
	obter_ctrl_antimicrobiano_mat(c.cd_material),
	c.nr_sequencia
from	Estrutura_material_v a,
	prescr_material c
where	a.cd_material		= c.cd_material
and	c.nr_prescricao		= nr_prescricao_p
and	coalesce(c.nr_seq_kit::text, '') = ''
and	coalesce(c.nr_sequencia_diluicao::text, '') = ''
and	c.ie_agrupador in (8,12)
and	((coalesce(ie_classif_custo_w::text, '') = '') or (ie_classif_custo_w = obter_dados_material_estab(c.cd_material, cd_estabelecimento_p, 'CU')))
and	(((coalesce(ie_somente_padrao_w,'S') = 'N') and (substr(obter_se_material_padronizado(cd_estabelecimento_p, a.cd_material),1,1) = 'S')) or (substr(obter_se_material_padronizado(cd_estabelecimento_p, a.cd_material),1,1) = 'N'))
and	((coalesce(cd_mat_w::text, '') = '') or (a.cd_material	= cd_mat_w))
and	((coalesce(cd_grupo_material_w::text, '') = '') or (a.cd_grupo_material	= cd_grupo_material_w))
and	((coalesce(cd_subgrupo_material_w::text, '') = '') or (a.cd_subgrupo_material = cd_subgrupo_material_w))
and	((coalesce(cd_classe_material_w::text, '') = '') or (a.cd_classe_material = cd_classe_material_w))
and	((coalesce(nr_sequencia_p::text, '') = '') or (c.nr_sequencia = nr_sequencia_p));

c15 CURSOR FOR
SELECT	b.nm_usuario_regra
from	rep_regra_envio_ci_padrao a,
	rep_usuario_ci_medic b
where	a.nr_sequencia	= b.nr_seq_regra
and	b.nr_seq_regra	= nr_sequencia_ww;
--and	obter_se_envia_ci_setor(a.nr_sequencia, cd_setor_w) = 'S';
BEGIN

select	min(nr_sequencia)
into STRICT	nr_sequencia_w
from	comunic_interna_classif
where	ie_tipo	= 'F';

select	max(obter_nome_pf_pj(cd_pessoa_fisica,null)),
	max(obter_nome_pf_pj(cd_prescritor,null)),
	max(cd_setor_atendimento),
	max(nr_atendimento),
	max(obter_nome_setor(cd_setor_atendimento)),
	max(obter_nome_convenio(obter_Convenio_atendimento(nr_atendimento)))
into STRICT	nm_paciente_w,
	nm_medico_w,
	cd_setor_w,
	nr_atendimento_w,
	ds_setor_w,
	ds_convenio_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

select	max(cd_convenio),
	max(cd_categoria)
into STRICT	cd_convenio_w,
	cd_categoria_w
from	atend_categoria_convenio
where	nr_atendimento	= nr_atendimento_w;

open C01;
loop
fetch C01 into
	nr_sequencia_ww,
	ds_titulo_w,
	ds_comunic_w,
	ie_somente_padrao_w,
	cd_grupo_material_w,
	cd_subgrupo_material_w,
	cd_classe_material_w,
	cd_mat_w,
	ie_enviar_prescritor_w,
	ie_primeiro_dia_w,
	ie_enviar_atb_w,
	ie_classif_custo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	ds_comunicado_w := null;
	open C14;
	loop
	fetch C14 into
		ds_justificativa_w,
		ds_material_w,
		cd_material_w,
		ds_dose_w,
		ie_medicacao_paciente_w,
		ie_ctrl_medic_w,
		nr_seq_medic_w;
	EXIT WHEN NOT FOUND; /* apply on C14 */
		if (ds_comunicado_w IS NOT NULL AND ds_comunicado_w::text <> '') then
			ds_comunicado_w	:= substr(ds_comunicado_w || chr(13) || chr(13) || ds_material_w,1,4000);
		else
			ds_comunicado_w	:= chr(13) || ds_material_w;
		end if;

		ds_comunicado_w := substr(ds_comunicado_w || chr(13) || '  ' || obter_desc_expressao(288220) || ': ' || ds_dose_w,1,4000);

		if (ie_ctrl_medic_w > 0) then
			select	substr(obter_valor_dominio(1280,ie_objetivo),1,60),
				coalesce(qt_dias_solicitado,0)qt_dias_solicitado
			into STRICT	ie_objetivo_w,
				qt_dias_solicitado_w
			from	prescr_material
			where	nr_prescricao	= nr_prescricao_p
			and	nr_sequencia	= nr_seq_medic_w;

			ds_comunicado_w := substr(ds_comunicado_w || chr(13) ||
						'  ' || obter_desc_expressao(727882) || ':  ' || coalesce(ds_justificativa_w,'') || ' (' || ie_objetivo_w || ')' || chr(13) ||
						'  ' || obter_desc_expressao(303740) || ':  ' || qt_dias_solicitado_w,1,4000);
		elsif (ds_justificativa_w IS NOT NULL AND ds_justificativa_w::text <> '') and (ie_enviar_atb_w = 'S') then
			ds_comunicado_w := substr(ds_comunicado_w || chr(13) || ds_justificativa_w,1,4000);
		end if;


		if (ie_medicacao_paciente_w = 'S') then
			ds_comunicado_w := substr(ds_comunicado_w || chr(13) || obter_desc_expressao(339240) || '.',1,4000);
		end if;
	end loop;
	close C14;

	if (ie_primeiro_dia_w = 'S') then

		select	min(a.nr_prescricao)
		into STRICT	nr_min_prescr_w
		from	prescr_medica b,
			prescr_material a
		where	a.nr_prescricao		= b.nr_prescricao
		and	b.nr_atendimento	= nr_atendimento_w
		and	a.cd_material		= cd_material_w
		and	coalesce(a.dt_suspensao::text, '') = ''
		and	coalesce(b.dt_suspensao::text, '') = '';

		if (nr_min_prescr_w < nr_prescricao_p) then
			ds_comunicado_w	:= '';
		end if;
	end if;

	if (ds_comunicado_w IS NOT NULL AND ds_comunicado_w::text <> '') then
		ds_lista_usuario_destino_w := null;
		open C15;
		loop
		fetch C15 into
			nm_usuario_destino_w;
		EXIT WHEN NOT FOUND; /* apply on C15 */
			if (ds_lista_usuario_destino_w IS NOT NULL AND ds_lista_usuario_destino_w::text <> '') then
				ds_lista_usuario_destino_w := substr(ds_lista_usuario_destino_w || ',',1,1000);
			end if;

			ds_lista_usuario_destino_w := substr(ds_lista_usuario_destino_w || nm_usuario_destino_w,1,1000);
		end loop;
		close C15;
		cd_perfil_w := null;
		open c02;
		loop
		fetch c02 into
			cd_perfil_destino_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			if (cd_perfil_w IS NOT NULL AND cd_perfil_w::text <> '') or (cd_perfil_w <> '') then
				cd_perfil_w := cd_perfil_w || ',';
			end if;

			cd_perfil_w := substr(cd_perfil_w || cd_perfil_destino_w,1,1000);

		end loop;
		close c02;

		if (cd_perfil_w IS NOT NULL AND cd_perfil_w::text <> '') and (substr(cd_perfil_w,length(cd_perfil_w), 1) <> ',') then
			cd_perfil_w	:= cd_perfil_w || ',';
		end if;

		ds_comunic_w	:=	substr(
					obter_desc_expressao(296208) || ': ' || nr_prescricao_p || chr(13) ||
					obter_desc_expressao(283863) || ': ' || nr_atendimento_w || chr(13) ||
					obter_desc_expressao(295156) || ': ' || nm_paciente_w || chr(13) ||
					obter_desc_expressao(298359) || ': ' || ds_setor_w|| chr(13) ||
					obter_desc_expressao(286193) || ': ' || ds_convenio_w|| chr(13) ||
					obter_desc_expressao(296217) || ': ' || nm_medico_w || chr(13) || chr(13) ||
					substr(ds_comunic_w,1,2000),1,4000);

		if (ds_titulo_w IS NOT NULL AND ds_titulo_w::text <> '') then

			select	nextval('comunic_interna_seq')
			into STRICT	nr_seq_comunic_w
			;

			ds_comunic_final_w	:= substr(ds_comunic_w || chr(13) || ds_comunicado_w,1,4000);

			insert	into comunic_interna(
				dt_comunicado,
				ds_titulo,
				ds_comunicado,
				nm_usuario,
				nm_usuario_destino,
				dt_atualizacao,
				ie_geral,
				ie_gerencial,
				ds_perfil_adicional,
				nr_sequencia,
				nr_seq_classif,
				dt_liberacao)
			values (
				clock_timestamp(),
				ds_titulo_w,
				ds_comunic_final_w,
				nm_usuario_p,
				ds_lista_usuario_destino_w,
				clock_timestamp(),
				'N',
				'N',
				cd_perfil_w,
				nr_seq_comunic_w,
				nr_sequencia_w,
				clock_timestamp());

			if (ie_enviar_prescritor_w = 'N') then
				insert into comunic_interna_lida
				values (	nr_seq_comunic_w,
					nm_usuario_p,
					clock_timestamp());
			end if;

			if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

		end if;
	end if;

end loop;
close C01;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_ci_paciente_sne (nr_prescricao_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, nr_sequencia_p bigint, ie_momento_p text default 'L') FROM PUBLIC;

