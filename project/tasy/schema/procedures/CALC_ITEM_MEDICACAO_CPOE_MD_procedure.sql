-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calc_item_medicacao_cpoe_md (qt_conversao_dose_p INOUT bigint, qt_dose_correcao_p bigint, qt_dose_medic_p bigint, ds_dose_diferenciada_aux_p text, ds_dose_diferenciada_p text, cd_material_p bigint, qt_unitaria_p INOUT bigint, qt_material_p INOUT bigint, qt_erro_somar_doses_p INOUT bigint ) AS $body$
DECLARE


EXEC_W					varchar(200);
qt_somar_doses_w		bigint;
qt_conversao_dose_ml_w	prescr_material.qt_conversao_dose%type;

BEGIN
    qt_erro_somar_doses_p := 0;

    if (qt_conversao_dose_p <= 0) then
      qt_conversao_dose_p	:= 1;
    end if;
	
	qt_conversao_dose_ml_w := coalesce(obter_conversao_unid_med(cd_material_p, obter_unid_med_usua('ML')),0);
	
    if (qt_conversao_dose_ml_w <= 0) then
      qt_conversao_dose_ml_w := qt_conversao_dose_p;
    end if;

    if (coalesce(qt_dose_correcao_p, 0) > 0) then
      qt_unitaria_p	:= dividir_md(qt_dose_correcao_p,qt_conversao_dose_ml_w);
    else
      qt_unitaria_p	:= dividir_md(qt_dose_medic_p,qt_conversao_dose_p);
    end if;

    if (ds_dose_diferenciada_aux_p IS NOT NULL AND ds_dose_diferenciada_aux_p::text <> '') then
      begin
        EXEC_W := 'BEGIN SOMAR_DOSES_DIF_MD(:1,:2,:3); END;';

        EXECUTE EXEC_W USING IN ds_dose_diferenciada_p,
                                       OUT qt_somar_doses_w,
                                       OUT qt_erro_somar_doses_p;
      exception
        when others then
          qt_somar_doses_w       := null;
          qt_erro_somar_doses_p  := null;
      end;

      qt_material_p	:= dividir_md(qt_somar_doses_w, qt_conversao_dose_p );
    else
      qt_material_p	:= 0;
    end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calc_item_medicacao_cpoe_md (qt_conversao_dose_p INOUT bigint, qt_dose_correcao_p bigint, qt_dose_medic_p bigint, ds_dose_diferenciada_aux_p text, ds_dose_diferenciada_p text, cd_material_p bigint, qt_unitaria_p INOUT bigint, qt_material_p INOUT bigint, qt_erro_somar_doses_p INOUT bigint ) FROM PUBLIC;

