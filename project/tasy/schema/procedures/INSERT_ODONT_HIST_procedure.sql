-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_odont_hist (NR_SEQ_IMAGEM_P bigint, NR_SEQ_DENTE_P bigint, IE_STATUS_AREA_P text, NR_SEQ_AVAL_DENT_P bigint, DS_OBSERVACAO_P text) AS $body$
DECLARE

	qtd_w bigint :=0;
	nr_sequencia_w bigint :=0;

BEGIN
   if ((NR_SEQ_IMAGEM_P IS NOT NULL AND NR_SEQ_IMAGEM_P::text <> '') and (NR_SEQ_AVAL_DENT_P IS NOT NULL AND NR_SEQ_AVAL_DENT_P::text <> '') and (NR_SEQ_DENTE_P IS NOT NULL AND NR_SEQ_DENTE_P::text <> ''))then
	
	select count(*) as quantide ,max(nr_sequencia) nr_sequencia
		into STRICT qtd_w,nr_sequencia_w
	from ODONT_HISTORICO_APAE where nr_seq_aval_dent  = NR_SEQ_AVAL_DENT_P 
	and nr_seq_imagem  = nr_seq_imagem_p
	and nr_seq_dente = nr_seq_dente_p;
	
	if (qtd_w = 0)then
         INSERT INTO ODONT_HISTORICO_APAE(NR_SEQUENCIA,
                                      DT_ATUALIZACAO,
                                      NM_USUARIO,
                                      DT_ATUALIZACAO_NREC,
                                      NM_USUARIO_NREC,
                                      NR_SEQ_IMAGEM,
                                      NR_SEQ_LOCALIZACAO,
                                      NR_SEQ_DENTE,
                                      IE_STATUS_AREA,
                                      NR_SEQ_AVAL_DENT,
                                      DS_OBSERVACAO)
                 
                  VALUES (nextval('odont_historico_apae_seq'),
                          clock_timestamp(),
                          wheb_usuario_pck.get_nm_usuario,
                          clock_timestamp(),
                          wheb_usuario_pck.get_nm_usuario,
                          NR_SEQ_IMAGEM_P,
                          'D',
                          NR_SEQ_DENTE_P,
                          IE_STATUS_AREA_P,
                          NR_SEQ_AVAL_DENT_P,
                          DS_OBSERVACAO_P);
	else
		update  ODONT_HISTORICO_APAE
			set DT_ATUALIZACAO = clock_timestamp(),
                        NM_USUARIO = wheb_usuario_pck.get_nm_usuario,                                   
                        DT_ATUALIZACAO_NREC = clock_timestamp(),                                  
			IE_STATUS_AREA = IE_STATUS_AREA_P,
                        DS_OBSERVACAO = DS_OBSERVACAO_P
		where NR_SEQUENCIA  =  nr_sequencia_w
			and NR_SEQ_IMAGEM = NR_SEQ_IMAGEM_P
			and NR_SEQ_DENTE = NR_SEQ_DENTE_P
			and NR_SEQ_AVAL_DENT =NR_SEQ_AVAL_DENT_P;                 	
	end if;

    commit;
    end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_odont_hist (NR_SEQ_IMAGEM_P bigint, NR_SEQ_DENTE_P bigint, IE_STATUS_AREA_P text, NR_SEQ_AVAL_DENT_P bigint, DS_OBSERVACAO_P text) FROM PUBLIC;

