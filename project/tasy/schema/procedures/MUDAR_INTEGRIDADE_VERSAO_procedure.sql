-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mudar_integridade_versao ( nm_tabela_p text, ds_acao_p text, nr_ordem_p bigint, ds_criacao_p text, ds_alteracao_p text, ie_reg_alt_p text, ds_exclusao_p text, ie_reg_excl_P text) AS $body$
DECLARE


ds_comando_w		varchar(2000);
c001			integer;
nm_tabela_w		varchar(50);
nm_integridade_w	varchar(50);
qt_reg_alt_w	bigint:= 0;
qt_reg_novo_w	bigint:= 0;
qt_reg_excl_w	bigint:= 0;
NR_ORDEM_W      bigint:= 0;
nm_fase_w       cloud_upgrade_log.nm_fase_atualizacao%type := 'MUDAR_INTEGRACAO_VERSAO';
C00 CURSOR FOR
	SELECT 1 ordem,
        nm_tabela,
		nm_integridade_referencial
	from	integridade_referencial
	where	nm_tabela_referencia	= nm_tabela_p
	
UNION

	SELECT 10 ordem, 
        nm_tabela,
		nm_integridade_referencial
	from	integridade_referencial
	where	nm_tabela	= nm_tabela_p
	
union

	select 20 ordem, 
        nm_tabela,
		nm_indice
	from	indice
	where	nm_tabela	= nm_tabela_p
	and	ie_tipo		IN ('IU','UK')
    
union

    select 20 ordem, 
        TABLE_NAME,
        CONSTRAINT_NAME
    from	USER_CONSTRAINTS
    where	TABLE_NAME	= nm_tabela_p
    AND CONSTRAINT_TYPE IN ('U')
    
union

    select 1 ordem, 
        table_name, 
        constraint_name
    from user_constraints uc
    where exists (select constraint_name 
                    from user_constraints 
                   where table_name = nm_tabela_p 
                   and constraint_name = uc.r_constraint_name)
    order by 1;

C01 CURSOR FOR
	SELECT 1 ordem,
        nm_tabela,
		nm_integridade_referencial
	from	integridade_referencial
	where	nm_tabela_referencia	= nm_tabela_p
	
UNION

	SELECT 10 ordem, 
        nm_tabela,
		nm_integridade_referencial
	from	integridade_referencial
	where	nm_tabela	= nm_tabela_p
	
union

	select 20 ordem, 
        nm_tabela,
		nm_indice
	from	indice
	where	nm_tabela	= nm_tabela_p
	and	ie_tipo		IN ('IU','UK')
    
union

    select 20 ordem, 
        TABLE_NAME,
        CONSTRAINT_NAME
    from	USER_CONSTRAINTS
    where	TABLE_NAME	= nm_tabela_p
    AND CONSTRAINT_TYPE IN ('U')
    
union

    select 1 ordem, 
        table_name, 
        constraint_name
    from user_constraints uc
    where exists (select constraint_name 
                    from user_constraints 
                   where table_name = nm_tabela_p 
                   and constraint_name = uc.r_constraint_name)
    order by 1 desc;

BEGIN

if (ie_reg_alt_p = 'S') then
	ds_comando_w := 'Select count(*) from TASY_VERSAO.'|| nm_tabela_p||' a ' ||ds_alteracao_p;	
	qt_reg_alt_w := Obter_valor_Dinamico(ds_comando_w, qt_reg_alt_w);
end if;

if (ie_reg_excl_P = 'S') then
	ds_comando_w := 'Select count(*) from '|| nm_tabela_p||' a ' ||ds_exclusao_p;
	qt_reg_excl_w := Obter_valor_Dinamico(ds_comando_w, qt_reg_excl_w);
end if;

ds_comando_w := 'Select count(*) from TASY_VERSAO.'|| nm_tabela_p||' a ' ||ds_criacao_p;	
qt_reg_novo_w := Obter_valor_Dinamico(ds_comando_w, qt_reg_novo_w);

if ((qt_reg_alt_w > 0) or (qt_reg_novo_w > 0) or (qt_reg_excl_w > 0)) then

    if (upper(trim(both ds_acao_p)) = 'DISABLE') THEN
        OPEN C00;
        LOOP
        FETCH C00 into
            NR_ORDEM_W,
            nm_tabela_w,
            nm_integridade_w;
        EXIT WHEN NOT FOUND; /* apply on c00 */
            begin
            if (not CHK_EXIST_CMD_CONST_INSERT(nm_integridade_w, ds_acao_p)) then
                ds_comando_w	:= 'alter table ' || nm_tabela_w || ' ' || ds_acao_p ||
                        ' novalidate  constraint ' || nm_integridade_w;
                insert into TABELA_VERSAO_OFFLINE_W(nr_sequencia, nr_ordem, ds_comando, ds_log) values (nextval('tabela_versao_offline_w_seq'),nr_ordem_p,ds_comando_w,'A');
                commit;
                CALL insert_control_const(nm_integridade_w, ds_acao_p);
		CALL insert_log_cloud(null,null, 'atualizacao', nm_fase_w||'_LOG', null, nm_fase_w);
            end if;
            end;
        END LOOP;
        CLOSE C00;
    END IF;

    if (upper(trim(both ds_acao_p)) = 'ENABLE') THEN
        OPEN C01;
        LOOP
        FETCH C01 into
            NR_ORDEM_W,
            nm_tabela_w,
            nm_integridade_w;
        EXIT WHEN NOT FOUND; /* apply on c01 */
            begin
            if (not CHK_EXIST_CMD_CONST_INSERT(nm_integridade_w, ds_acao_p)) then
                ds_comando_w	:= 'alter table ' || nm_tabela_w || ' ' || ds_acao_p ||
                        ' novalidate  constraint ' || nm_integridade_w;
                insert into TABELA_VERSAO_OFFLINE_W(nr_sequencia, nr_ordem, ds_comando, ds_log) values (nextval('tabela_versao_offline_w_seq'),nr_ordem_p,ds_comando_w,'A');
                commit;
                CALL insert_control_const(nm_integridade_w, ds_acao_p);
		CALL insert_log_cloud(null,null, 'atualizacao', nm_fase_w||'_LOG', null, nm_fase_w);
            end if;
            end;
        END LOOP;
        CLOSE C01;
    END IF;

end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mudar_integridade_versao ( nm_tabela_p text, ds_acao_p text, nr_ordem_p bigint, ds_criacao_p text, ds_alteracao_p text, ie_reg_alt_p text, ds_exclusao_p text, ie_reg_excl_P text) FROM PUBLIC;

