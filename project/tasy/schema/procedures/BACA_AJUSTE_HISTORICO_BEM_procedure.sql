-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_ajuste_historico_bem () AS $body$
DECLARE


ds_comando_w			varchar(2000);
ie_ajustar_w			varchar(1);
qt_registro_w			bigint;

qt_reg_tabela_w			bigint	:= 0;
qt_reg_tabela_backup_w		bigint	:= 0;


BEGIN

select	coalesce(max('S'), 'N')
into STRICT	ie_ajustar_w
from	user_tab_columns
where	table_name	= 'PAT_HISTORICO_BEM'
and	column_name	= 'QT_PERCENTUAL'
and	data_scale	= 2;

if (ie_ajustar_w = 'S') then
	begin

	/*Criando Backup da tabela PAT_HISTORICO_BEM*/

	ds_comando_w	:= 'create table bkpw_pat_historico_bem as select * from pat_historico_bem';
	CALL exec_sql_dinamico('Tasy', ds_comando_w);

	select	count(*)
	into STRICT	qt_registro_w
	from	user_tables
	where	table_name	= 'BKPW_PAT_HISTORICO_BEM';

	/*Verifcando se a quantidade de registros apresentados na tabela de backup conferem com a tabela original*/

	if (qt_registro_w > 0) then

		ds_comando_w	:= 'alter table pat_historico_bem add qt_percentual_aux number(15,4)';
		CALL exec_sql_dinamico('Tasy', ds_comando_w);


		ds_comando_w	:=	' update	pat_historico_bem '||
					' set	qt_percentual_aux	= qt_percentual';
		CALL exec_sql_dinamico('Tasy', ds_comando_w);


		ds_comando_w	:= 'alter table pat_historico_bem drop column qt_percentual';
		CALL exec_sql_dinamico('Tasy', ds_comando_w);

		ds_comando_w	:= 'alter table pat_historico_bem add qt_percentual number(15,4)';
		CALL exec_sql_dinamico('Tasy', ds_comando_w);


		ds_comando_w	:=	' update	pat_historico_bem '||
					' set	qt_percentual	= qt_percentual_aux';
		CALL exec_sql_dinamico('Tasy', ds_comando_w);

		ds_comando_w	:= 'alter table pat_historico_bem drop column qt_percentual_aux';
		CALL exec_sql_dinamico('Tasy', ds_comando_w);

	end if;

	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_ajuste_historico_bem () FROM PUBLIC;

