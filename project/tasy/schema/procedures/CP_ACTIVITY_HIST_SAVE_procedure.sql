-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cp_activity_hist_save ( NR_ATENDIMENTO_P CP_ACTIVITY_HIST.NR_ATENDIMENTO%type, NM_USUARIO_P CP_ACTIVITY_HIST.NM_USUARIO%type, NR_SEQ_ITEM_INTERV_ASSOC_P CP_ACTIVITY_HIST.NR_SEQ_ITEM_INTERV_ASSOC%type, NR_SEQ_PRESCR_P PE_PRESCR_PROC.NR_SEQ_PRESCR%type, NR_SEQ_PROC_P PE_PRESCR_PROC.NR_SEQUENCIA%type, SI_SELECTED_P CP_ACTIVITY_HIST.SI_SELECTED%type, NR_SEQ_PROC_HORA_P PE_PRESCR_PROC_HOR.NR_SEQUENCIA%type ) AS $body$
DECLARE


nr_sequencia_w			        CP_ACTIVITY_HIST.NR_SEQUENCIA%type;
nr_seq_proc_hora_w			    PE_PRESCR_PROC_HOR.NR_SEQUENCIA%type;


BEGIN

    if (NR_ATENDIMENTO_P IS NOT NULL AND NR_ATENDIMENTO_P::text <> '') and (NM_USUARIO_P IS NOT NULL AND NM_USUARIO_P::text <> '') and (NR_SEQ_ITEM_INTERV_ASSOC_P IS NOT NULL AND NR_SEQ_ITEM_INTERV_ASSOC_P::text <> '') and (NR_SEQ_PRESCR_P IS NOT NULL AND NR_SEQ_PRESCR_P::text <> '') and (NR_SEQ_PROC_P IS NOT NULL AND NR_SEQ_PROC_P::text <> '') and (SI_SELECTED_P IS NOT NULL AND SI_SELECTED_P::text <> '') and (NR_SEQ_PROC_HORA_P IS NOT NULL AND NR_SEQ_PROC_HORA_P::text <> '') then

       --NR_SEQ_PROC_HORA_P Ã© uma referencia apenas para pegar a data e hora
        select NR_SEQUENCIA 
            into STRICT nr_seq_proc_hora_w 
            from PE_PRESCR_PROC_HOR 
        where NR_SEQ_PE_PRESCR = NR_SEQ_PRESCR_P 
          and NR_SEQ_PE_PROC = NR_SEQ_PROC_P 
          and DT_HORARIO = (
            SELECT DT_HORARIO from PE_PRESCR_PROC_HOR where NR_SEQUENCIA = NR_SEQ_PROC_HORA_P
        );

        select  nextval('cp_activity_hist_seq')
        into STRICT    nr_sequencia_w
;

        insert into CP_ACTIVITY_HIST(
            DT_ATUALIZACAO,
            DT_ATUALIZACAO_NREC,
            DT_EXECUCAO,
            NM_USUARIO,
            NM_USUARIO_NREC,
            NR_ATENDIMENTO,
            NR_SEQ_ITEM_INTERV_ASSOC,
            NR_SEQ_PE_PRESCR_PROC,
            SI_SELECTED,
            NR_SEQ_PRESCR,
            NR_SEQ_PE_PRESCR_PROC_HOR,
            NR_SEQUENCIA
        ) values (
            clock_timestamp(),
            clock_timestamp(),
            clock_timestamp(),
            NM_USUARIO_P,
            NM_USUARIO_P,
            NR_ATENDIMENTO_P,
            NR_SEQ_ITEM_INTERV_ASSOC_P,
            NR_SEQ_PROC_P,
            SI_SELECTED_P,
            NR_SEQ_PRESCR_P,
            nr_seq_proc_hora_w,
            nr_sequencia_w
        );
    end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cp_activity_hist_save ( NR_ATENDIMENTO_P CP_ACTIVITY_HIST.NR_ATENDIMENTO%type, NM_USUARIO_P CP_ACTIVITY_HIST.NM_USUARIO%type, NR_SEQ_ITEM_INTERV_ASSOC_P CP_ACTIVITY_HIST.NR_SEQ_ITEM_INTERV_ASSOC%type, NR_SEQ_PRESCR_P PE_PRESCR_PROC.NR_SEQ_PRESCR%type, NR_SEQ_PROC_P PE_PRESCR_PROC.NR_SEQUENCIA%type, SI_SELECTED_P CP_ACTIVITY_HIST.SI_SELECTED%type, NR_SEQ_PROC_HORA_P PE_PRESCR_PROC_HOR.NR_SEQUENCIA%type ) FROM PUBLIC;

