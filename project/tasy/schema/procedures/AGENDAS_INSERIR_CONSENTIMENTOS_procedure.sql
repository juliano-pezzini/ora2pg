-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE agendas_inserir_consentimentos ( ie_tipo_agenda_p text, nr_seq_agendamento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_proc_interno_p bigint, cd_pessoa_fisica_p bigint, cd_profissional_p bigint, cd_estabelecimento_p bigint default null, nr_atendimento_p bigint default null, ie_agendamento_web_p text default null) AS $body$
DECLARE


ds_texto_padrao_w PEP_PAC_CI.DS_TEXTO%TYPE;
ds_titulo_padrao_w PEP_PAC_CI.DS_TITULO%TYPE;
nr_seq_texto_w PEP_PAC_CI.NR_SEQ_TEXTO%TYPE;
nr_seq_agecons_w agenda_consulta.nr_sequencia%type  := null;
nr_seq_agepac_w	agenda_paciente.nr_sequencia%type	:= null;
nr_seq_pep_ci_w	pep_pac_ci.nr_sequencia%type;

c01 CURSOR FOR
SELECT DS_TITULO,
	   DS_TEXTO,
	   b.NR_SEQUENCIA
  from PROCEDIMENTO_TEXTO_PADRAO a,
       texto_padrao b
  where a.NR_SEQ_TEXTO_PADRAO = b.nr_sequencia
  and	coalesce(ie_situacao, 'A') = 'A'
  and	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_p,0))	= coalesce(cd_estabelecimento_p,0)
    and (nr_seq_proc_interno = nr_seq_proc_interno_p
	 or (coalesce(nr_seq_proc_interno_p::text, '') = ''
		and cd_procedimento = cd_procedimento_p
		and ie_origem_proced = ie_origem_proced_p))
		and b.nr_sequencia not in (
			SELECT nr_seq_texto
			  from pep_pac_ci pep
			 where ((ie_tipo_agenda_p in (3,5) and nr_seq_age_cons = nr_seq_agendamento_p)
				or (ie_tipo_agenda_p = 2 and nr_seq_agenda = nr_seq_agendamento_p))
			   and (nr_seq_texto IS NOT NULL AND nr_seq_texto::text <> '')
			);
		

BEGIN

	if (ie_tipo_agenda_p in (3,5)) then
		nr_seq_agecons_w := nr_seq_agendamento_p;
	elsif (ie_tipo_agenda_p = 2) then
		nr_seq_agepac_w := nr_seq_agendamento_p;
	end if;

	begin
	open c01;
	loop
	fetch c01 into 	ds_titulo_padrao_w,
					ds_texto_padrao_w,
					nr_seq_texto_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		BEGIN
							
			if ((nr_seq_texto_w IS NOT NULL AND nr_seq_texto_w::text <> '') and
				(ds_titulo_padrao_w IS NOT NULL AND ds_titulo_padrao_w::text <> '') and
				(ds_texto_padrao_w IS NOT NULL AND ds_texto_padrao_w::text <> '')) then
				
				ds_texto_padrao_w := subst_macros_texto_prontuario(nr_seq_agendamento_p, cd_pessoa_fisica_p, nr_atendimento_p, ds_texto_padrao_w);

				select nextval('pep_pac_ci_seq')
				  into STRICT nr_seq_pep_ci_w
				;

				begin
					insert into PEP_PAC_CI(
											nr_sequencia,
											cd_estabelecimento,
											cd_pessoa_fisica,
											dt_atualizacao,
											nm_usuario,
											dt_atualizacao_nrec,
											nm_usuario_nrec,
											cd_profissional,
											ds_titulo,
											ds_texto,
											nr_seq_agenda,
											ie_situacao,
											cd_perfil_ativo,
											nr_seq_age_cons,
											NR_SEQ_TEXTO,
											dt_liberacao)
									values (
											nr_seq_pep_ci_w,
											wheb_usuario_pck.get_cd_estabelecimento,
											cd_pessoa_fisica_p,
											clock_timestamp(),
											wheb_usuario_pck.get_nm_usuario,
											clock_timestamp(),
											wheb_usuario_pck.get_nm_usuario,
											CASE WHEN ie_agendamento_web_p='S' THEN cd_pessoa_fisica_p  ELSE OBTER_PF_USUARIO_ATIVO END ,
											ds_titulo_padrao_w,
											ds_texto_padrao_w,
											nr_seq_agepac_w,
											'A',
											wheb_usuario_pck.get_cd_perfil,
											nr_seq_agecons_w,
											nr_seq_texto_w,
											CASE WHEN ie_agendamento_web_p='S' THEN clock_timestamp()  ELSE null END );
				exception when  others then
					null;
				end;
			end if;
		end;
	END LOOP;
	close c01;
	exception when  others then
		null;
	end;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE agendas_inserir_consentimentos ( ie_tipo_agenda_p text, nr_seq_agendamento_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_proc_interno_p bigint, cd_pessoa_fisica_p bigint, cd_profissional_p bigint, cd_estabelecimento_p bigint default null, nr_atendimento_p bigint default null, ie_agendamento_web_p text default null) FROM PUBLIC;

