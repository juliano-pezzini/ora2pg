-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE med_finalizar_atendimento (nr_seq_agenda_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_atend_tasy_w				integer;
cd_setor_atendimento_w		bigint;
ie_tipo_saida_consulta_w	smallint;
vl_padrao_w					varchar(15) := 'S';
cd_medico_w					varchar(10);


BEGIN 
 
select	max(a.cd_pessoa_fisica) 
into STRICT	cd_medico_w 
from	agenda a, 
		agenda_consulta b 
where	a.cd_agenda = b.cd_agenda 
and		b.nr_sequencia = nr_seq_agenda_p;
 
if (cd_medico_w IS NOT NULL AND cd_medico_w::text <> '') then 
	select 	coalesce(max(vl_padrao),0) 
	into STRICT  	vl_padrao_w 
	from  	med_parametro 
	where 	nr_sequencia = 124;
 
	select 	coalesce(max(vl_parametro),vl_padrao_w) 
	into STRICT	vl_padrao_w 
	from  	med_parametro_medico 
	where 	nr_seq_parametro 	= 124 
	and		cd_medico 			= cd_medico_w;
end if;
 
select	nr_atendimento, 
	coalesce(obter_unidade_atendimento(nr_atendimento, 'A', 'CS'),0) 
into STRICT	nr_atend_tasy_w, 
	cd_setor_atendimento_w 
from 	agenda_consulta 
where	nr_sequencia		= nr_seq_agenda_p;
 
if (nr_atend_tasy_w IS NOT NULL AND nr_atend_tasy_w::text <> '') then 
	CALL Saida_Setor_Servico(nr_atend_tasy_w, cd_setor_atendimento_w, null, null, nm_usuario_p);
end if;
 
/* Rafael em 12/04/2007 classificacao TISS 2007 */
 
select	obter_classif_tiss_agenda(nr_seq_agenda_p, 'S') 
into STRICT	ie_tipo_saida_consulta_w
;
 
 
update	med_atendimento 
set	dt_saida		= clock_timestamp(), 
	dt_atualizacao		= clock_timestamp(), 
	nm_usuario		= nm_usuario_p, 
	ie_tipo_saida_consulta	= ie_tipo_saida_consulta_w 
where	nr_seq_agenda		= nr_seq_agenda_p;
 
update	agenda_consulta 
set	ie_status_agenda	= 'E', 
	nr_seq_consulta		 = NULL, 
	dt_atualizacao		= clock_timestamp(), 
	nm_usuario		= nm_usuario_p 
where	nr_sequencia		= nr_seq_agenda_p;
 
update	agenda_paciente 
set	ie_status_agenda	= 'E' 
where	nr_seq_age_cons	= nr_seq_agenda_p;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE med_finalizar_atendimento (nr_seq_agenda_p bigint, nm_usuario_p text) FROM PUBLIC;

