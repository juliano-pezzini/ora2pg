-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_fechar_lote_escrit ( nr_seq_lote_p pls_lote_escrit_quota.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE

 
cd_moeda_w			pls_lote_escrit_quota.cd_moeda%type;
cd_condicao_pag_w		pls_lote_escrit_quota.cd_condicao_pagamento%type;
qt_quotas_w			pls_lote_escrit_quota.qt_quotas%type;
vl_entrada_w			pls_lote_escrit_quota.vl_entrada%type;
vl_escrituracao_w		pls_lote_escrit_quota.vl_escrituracao%type;
nr_seq_tipo_escrit_quota_w	pls_lote_escrit_quota.nr_seq_tipo_escrit_quota%type;
nr_seq_cooperado_w		pls_cooperado.nr_sequencia%type;
nr_seq_escrit_w			pls_escrituracao_quota.nr_sequencia%type;
cd_pessoa_fisica_w		pessoa_fisica.cd_pessoa_fisica%type;
cd_cgc_w			pessoa_juridica.cd_cgc%type;
ie_acao_nao_util_w		pls_lote_escrit_quota.ie_acao_nao_util%type;
ie_mes_vencimento_w		pls_lote_escrit_quota.ie_mes_vencimento%type;
nr_dia_venc_w			pls_lote_escrit_quota.nr_dia_venc%type;
qt_parcela_w			pls_lote_escrit_quota.qt_parcela%type;
				
C01 CURSOR FOR 
	SELECT	a.nr_seq_cooperado, 
		b.cd_pessoa_fisica, 
		b.cd_cgc 
	from	pls_lote_escrit_quota_item	a, 
		pls_cooperado			b 
	where	b.nr_sequencia	= a.nr_seq_cooperado 
	and	a.nr_seq_lote	= nr_seq_lote_p 
	order by 1;			
	 

BEGIN 
select	qt_quotas, 
	cd_moeda, 
	cd_condicao_pagamento, 
	vl_entrada, 
	vl_escrituracao, 
	nr_seq_tipo_escrit_quota, 
	ie_acao_nao_util, 
	ie_mes_vencimento, 
	nr_dia_venc, 
	qt_parcela 
into STRICT	qt_quotas_w, 
	cd_moeda_w, 
	cd_condicao_pag_w, 
	vl_entrada_w, 
	vl_escrituracao_w, 
	nr_seq_tipo_escrit_quota_w, 
	ie_acao_nao_util_w, 
	ie_mes_vencimento_w, 
	nr_dia_venc_w, 
	qt_parcela_w 
from	pls_lote_escrit_quota 
where	nr_sequencia = nr_seq_lote_p;
 
 
open c01;
loop 
fetch c01 into	 
	nr_seq_cooperado_w, 
	cd_pessoa_fisica_w, 
	cd_cgc_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
begin 
	select	nextval('pls_escrituracao_quota_seq') 
	into STRICT	nr_seq_escrit_w 
	;
	 
	insert into pls_escrituracao_quota(	nr_sequencia, 
				dt_atualizacao, 
				nm_usuario, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				nr_seq_cooperado, 
				dt_lancamento, 
				nr_seq_tipo_escrit_quota, 
				qt_quotas, 
				vl_escrituracao, 
				vl_entrada, 
				vl_saldo_acumulado, 
				ie_acao_nao_util, 
				ie_mes_vencimento, 
				nr_dia_venc, 
				qt_parcela) 
		values (	nr_seq_escrit_w, 
				clock_timestamp(), 
				nm_usuario_p, 
				clock_timestamp(), 
				nm_usuario_p, 
				nr_seq_cooperado_w, 
				clock_timestamp(), 
				nr_seq_tipo_escrit_quota_w, 
				qt_quotas_w, 
				vl_escrituracao_w, 
				vl_entrada_w, 
				0, 
				ie_acao_nao_util_w, 
				ie_mes_vencimento_w, 
				nr_dia_venc_w, 
				qt_parcela_w);
				 
	CALL pls_consistir_escriturac_quota(nr_seq_cooperado_w,nr_seq_escrit_w,nm_usuario_p);
				 
	CALL pls_gerar_parcelas_quota_part(nr_seq_escrit_w, cd_estabelecimento_p, nm_usuario_p);
	 
	if (cd_condicao_pag_w IS NOT NULL AND cd_condicao_pag_w::text <> '') then 
		CALL pls_gerar_tit_quota_part(nr_seq_escrit_w, cd_pessoa_fisica_w, cd_cgc_w, cd_estabelecimento_p, nm_usuario_p);
	end if;
	 
	end;
end loop;
close c01;
 
update	pls_lote_escrit_quota 
set	nm_usuario	= nm_usuario_p, 
	dt_fechamento	= clock_timestamp() 
where	nr_sequencia	= nr_seq_lote_p;
	 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_fechar_lote_escrit ( nr_seq_lote_p pls_lote_escrit_quota.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

