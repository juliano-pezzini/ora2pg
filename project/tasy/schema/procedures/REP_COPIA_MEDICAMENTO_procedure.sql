-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rep_copia_medicamento ( nr_prescricao_p bigint, nr_seq_regra_p bigint, nr_prescricoes_p text, nr_prescricao_original_p bigint, ie_procedimento_p text, dt_prescricao_p timestamp, dt_primeiro_horario_p text, ie_ajustar_qt_p text, cd_perfil_p bigint, nr_seq_material_p bigint, nm_usuario_p text, cd_funcao_ativa_p bigint, cd_medic_posicionar_p INOUT bigint) AS $body$
DECLARE


dt_prescricao_w    			timestamp := dt_prescricao_p;
dt_inicio_prescr_tes_w		timestamp;
dt_primeiro_ant_w			timestamp;
nr_seq_solucao_mat_w   		bigint;
nr_prescricao_orig_w		bigint;
nr_seq_apres_w				bigint;
nr_sequencia_novo_ww		bigint;
nr_seq_origem_medic_w		bigint;
qt_itens_w					bigint;
nr_sequencia_orig_w			bigint;
cd_pessoa_fisica_w			varchar(10);
ie_limp_prim_hor_acm_w	varchar(10);
ie_loop_w					varchar(10);
ie_gerar_w					varchar(10);
ie_gerar_dil_setor_w		varchar(15);
ie_prim_horario_setor_w		varchar(10);
ie_composto_w				varchar(10);
hr_setor_w					varchar(10);
cd_pessoa_fisica_ww			varchar(10);
ie_minutos_w				varchar(10);
ds_horarios_padr_w			varchar(2000);
ds_observacao_far_w			varchar(2000);
erro_w						varchar(2000);
nr_seq_dieta_w				bigint;
nr_seq_Proc_w				bigint;
nr_seq_Solucao_w			bigint;
dt_validade_nova_w			timestamp;
dt_validade_origem_w		timestamp;
nr_agrup_acum_w				bigint;
nr_agrup_aux_w				bigint;
ie_dias_util_medic_w		varchar(1);
hr_prim_presc_w				varchar(20);
cd_unidade_medida_w			varchar(20);
IE_PERMITE_SUBSTITUIR_w		varchar(1);
nr_sequencia_w				bigint;
nr_sequencia_ww				bigint;
qt_unitaria_w				double precision;
ie_copia_valid_igual_w		varchar(1);
qt_material_w				double precision;
nr_seq_gasoterapia_w		bigint;
ds_horarios_w				varchar(2000);
ds_horarios_prim_w			varchar(2000);
ds_horarios_aux_w			varchar(2000);
ds_horarios_reordenados_w 	varchar(2000);
ds_horarios2_w				varchar(2000);
ds_horarios_ww				varchar(2000);
nr_sequencia_diluicao_w		integer;
hr_prim_horario_w			varchar(5);
hr_prim_horario_aux_w		varchar(5);
hr_prim_horario_ww			varchar(5);
nr_dia_util_w				bigint;
cd_material_w				integer;
nr_horas_validade_w			integer;
ie_operacao_w				varchar(1);
qt_operacao_w				intervalo_prescricao.qt_operacao%type;
dt_prescricao_dia_w			varchar(10);
dt_prescricao_www			timestamp;
dt_prescricao_ww			timestamp;
dt_entrada_w				timestamp;
ie_origem_inf_w				varchar(1);
ie_exame_w					varchar(1);
dt_inicio_prescricao_w		timestamp;
nr_seq_nut_pac_w			bigint;
nr_seq_nut_pac_ww			bigint;
qt_hora_w					bigint;
qt_hora_ww					varchar(100);
nr_prescricoes_w			varchar(2000);
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
ds_erro_w					varchar(255);
nr_nut_pac_w				bigint;
nut_pac_elem_w				bigint;
nr_seq_pac_elem_w			bigint;
nr_seq_pac_elem_mat_w		bigint;
qt_dia_npt_w				bigint;
cd_intervalo_w				varchar(7);
cd_intervalo_param_w		varchar(7);
ie_via_aplicacao_w			varchar(5);
dt_primeiro_horario_w		timestamp;
dt_primeiro_horario_mae_w	timestamp;
dt_prim_horario_w			varchar(20);
cd_classif_setor_w			varchar(2);
cd_prescritor_w				varchar(10);
VarConsisteDataFutura_w		varchar(1);
Prescr_dia_w				varchar(1) := 'S';
nr_seq_bco_w				bigint;
VarBancoSangue_w			varchar(1);
ie_copia_agora_w			varchar(1);
ie_calcula_validade_w		varchar(1);
cd_intervalo_proc_w			varchar(7);
dt_prev_execucao_w			timestamp;
dt_prev_execucao_ww			timestamp;
cd_procedimento_w			bigint;
ie_origem_proced_w			bigint;
nr_intervalo_w				bigint := 0;
nr_intervalo_ww				bigint := 0;
ie_agrupador_w				smallint;
ie_acm_w					varchar(1);
ie_nao_padronizado_w		varchar(1);
dt_prim_hora_int_w			timestamp;
hr_prim_hora_medic_w		varchar(10);
ie_copia_mat_w				varchar(1);
VarCopiaJust_w				varchar(1);
var_pac_usu_w				varchar(2);
var_setores_usuario_w		varchar(1);
qt_registro_w				bigint;
cd_setor_usuario_w			integer;
cd_setor_prescr_w			integer := null;
ie_hora_sne_w				varchar(255);
ie_copia_medic_w			varchar(255);
ie_adep_w					varchar(1)	:= 'N';
ie_controle_medico_w		bigint;
QT_DIAS_LIBERADO_w			bigint;
ds_dose_dif_w				varchar(255);
ie_aux_w					varchar(1);
i							bigint;
k							bigint;
nr_etapas_w					smallint;
qt_tempo_aplicacao_w		double precision;
ie_esquema_alternado_w		varchar(1);
qt_hora_intervalo_ww		double precision;
dt_horario_w				timestamp;
dt_inicio_prescr_w			timestamp;
dt_validade_prescr_w		timestamp;
dt_proxima_dose_w			timestamp;
qt_dias_lib_atend_w			bigint;
ie_copia_direta_w			varchar(15);
ie_insere_w					varchar(1);
ie_regra_disp_w				varchar(1);/* Rafael em 15/3/8 OS86206 */
nr_seq_material_delete_w	integer;/* Ivan em 25/03/2008 OS84773 */
ie_horario_sem_apraso_w		varchar(1);
cd_perfil_w					integer;
cd_intervalo_proc_agora_w	varchar(7);
hr_prim_horario_interv_w	timestamp;
dt_inicio_prescr_ww			timestamp;
hr_inicio_prescr_w			varchar(10);
ie_agrupa_prescr_atend_w	varchar(1)	:= 'S';
ie_situacao_w				varchar(1);
nr_seq_exame_w				bigint;
QT_HOR_W					bigint;
ie_regra_medic_w			varchar(15);
cd_especialidade_w			varchar(50);
nr_seq_proc_int_w			bigint;
cd_setor_atendimento_w		bigint;
nr_horas_copia_w			bigint;
ie_ctrl_glic_w				varchar(3);
ie_estender_w				varchar(3);
ie_prescr_agora_pa_w		varchar(1);
ie_peso_prescr_org_w		varchar(1);
ie_regra_prim_hor_ant_w		varchar(15);
ie_regra_horarios_ant_w		varchar(15);
ie_regra_prim_horarios_ant_w varchar(15);
ie_elimina_hor_ant_w		varchar(15);
ie_reordenar_ant_w			varchar(15);
ie_regra_prim_hor_w			varchar(15);
ie_regra_horarios_w			varchar(15);
ie_regra_prim_horarios_w	varchar(15);
ie_elimina_hor_w			varchar(15);
ie_reordenar_w				varchar(15);
NR_ATENDIMENTO_W			bigint;
ie_regra_geral_w			varchar(15);
IE_COPIAR_W					varchar(15);
IE_COBRA_PACIENTE_W			varchar(15);
DS_OBSERVACAO_W				varchar(2000);
ds_observacao_enf_w			varchar(2000);
qt_dose_w					double precision;
qt_dose_ww					double precision;
NR_SEQ_REGRA_W				bigint;
NR_AGRUPAMENTO_W			bigint;
cd_motivo_baixa_w			bigint;
dt_baixa_w					timestamp;
ie_utiliza_kit_w			varchar(15);
cd_unidade_medida_dose_w	varchar(30);
qt_conversao_dose_w			double precision;
nr_ocorrencia_w				double precision;
qt_total_dispensar_w		double precision;
cd_fornec_consignado_w		varchar(30);
nr_sequencia_solucao_w		integer;
nr_sequencia_proc_w			integer;
qt_solucao_w				double precision;
ds_dose_diferenciada_w		varchar(50);
ie_medicacao_paciente_w		varchar(30);
nr_sequencia_dieta_w		integer;
ie_suspenso_w				varchar(1);
ie_se_necessario_w			varchar(30);
qt_min_aplicacao_w			bigint;
ie_bomba_infusao_w			varchar(30);
ie_aplic_bolus_w			varchar(30);
ie_aplic_lenta_w			varchar(30);
ie_objetivo_w				varchar(30);
cd_topografia_cih_w			bigint;
ie_origem_infeccao_w		varchar(30);
cd_amostra_cih_w			bigint;
cd_microorganismo_cih_w		bigint;
ie_uso_antimicrobiano_w		varchar(30);
cd_protocolo_w				bigint;
nr_seq_protocolo_w			bigint;
nr_seq_mat_protocolo_w		bigint;
qt_hora_aplicacao_w			bigint;
ie_recons_diluente_fixo_w	varchar(30);
qt_vel_infusao_w			double precision;
ds_justificativa_w			varchar(2000);
ie_sem_aprazamento_w		varchar(1);
ie_sem_aprazamento_ww		varchar(1);
ie_indicacao_w				varchar(1);
qt_total_dias_lib_w			integer;
nr_seq_substituto_w			integer;
ie_lado_w					varchar(1);
dt_inicio_medic_w			timestamp;
qt_dia_prim_hor_w			bigint;
qt_vol_adic_reconst_w		double precision;
qt_hora_intervalo_w			smallint;
qt_min_intervalo_w			integer;
ie_urgencia_w				varchar(10);
cd_mat_aux_w				bigint;
cd_intervalo_aux_w			varchar(50);
ie_agora_aux_w				varchar(50);
ie_regra_dose_especial_w	varchar(1);
qt_dose_especial_w			double precision;	
ie_dose_espec_agora_w		varchar(1);
hr_dose_especial_w			varchar(5);
ds_horarios_medico_w		varchar(2000);
ie_padronizado_w			varchar(15);
ie_mesmo_zerado_w			varchar(1);
ie_gerar_diluicao_w			varchar(1);
ie_copia_kit_rec_w			varchar(1);
ie_copia_albumina_w			varchar(1);
cd_grupo_material_w			bigint;
cd_subgrupo_material_w		bigint;
cd_classe_material_w		bigint;
ie_tela_validade_w			varchar(1);
qt_espacos_horarios_w		bigint;
var_copia_diluicao_w		varchar(1);
ie_apres_medic_nao_copia_w	varchar(1);
ie_prescricao_w				varchar(1);
ie_vancomicina_w			varchar(1);
ie_param911_w				varchar(3);
ie_param1128_w				varchar(3);
ie_em_protocolo_vanco_w		varchar(1);
vl_param1156_w				bigint;
ie_gera_disp_acm_sn_w		varchar(1);
ie_gerar_lote_w				varchar(1) := 'S';

cd_material_novo_w			prescr_material.cd_material%type;
cd_intervalo_novo_w			prescr_material.cd_intervalo%type;
ia_via_aplic_novo_w 		prescr_material.ie_via_aplicacao%type;
qt_unitaria_novo_w			prescr_material.qt_unitaria%type;
qt_dose_espe_novo_w			prescr_material.qt_dose_especial%type;
ds_horarios_novo_w			prescr_material.ds_horarios%type;
ds_dose_dif_novo_w			prescr_material.ds_dose_diferenciada%type;
cd_unid_med_dose_novo_w		prescr_material.cd_unidade_medida_dose%type;	
qt_material_novo_w			prescr_material.qt_material%type;
qt_total_disp_novo_w		prescr_material.qt_total_dispensar%type;
ie_SN_novo_w				prescr_material.ie_se_necessario%type;
ie_acm_novo_w				prescr_material.ie_acm%type;
nr_ocorre_novo_w			prescr_material.nr_ocorrencia%type;
ie_fator_correcao_w			prescr_material.ie_fator_correcao%type;
ds_medic_nao_padrao_w		prescr_material.ds_medic_nao_padrao%type;
nr_seq_recomendacao_wW		prescr_material.nr_seq_recomendacao%type;
cont_w						bigint;
ie_param548_w				varchar(1);
ie_param930_w				varchar(1);
ie_agora_w					intervalo_prescricao.ie_agora%type;

-- Controle de liberacao do CIH --
ie_copiar_ccih_reprov_w		varchar(1);
ie_ciclo_reprov_w			varchar(1);

C000 CURSOR FOR
SELECT	b.ie_dias_util_medic,
		a.cd_material,
		a.nr_sequencia,
		a.qt_unitaria,
		a.qt_material,
		a.ds_horarios,
		coalesce(a.nr_ocorrencia,1),
		a.qt_total_dispensar,
		a.nr_sequencia_diluicao,
		a.hr_prim_horario,
		a.ds_dose_diferenciada,
		c.nr_horas_validade,
		d.ie_operacao,
		d.qt_operacao,
		a.cd_intervalo,
		a.ie_via_aplicacao,
		a.cd_unidade_medida_dose,
		a.ie_agrupador,
		a.ie_se_necessario,
		a.ie_acm,
		a.qt_hora_intervalo,
		a.qt_min_intervalo,
		c.dt_inicio_prescr,
		to_char(c.dt_primeiro_horario,'hh24:mi') hr_inicio_prescr,
		a.qt_dose,
		Obter_estrutura_material(b.cd_material,'G'),
		Obter_estrutura_material(b.cd_material,'S'),
		Obter_estrutura_material(b.cd_material,'C')
FROM prescr_medica c, material b, prescr_material a
LEFT OUTER JOIN intervalo_prescricao d ON (a.cd_intervalo = d.cd_intervalo)
WHERE a.cd_material		= b.cd_material and b.ie_tipo_material 	in (2,3,9) and coalesce(a.nr_sequencia_solucao::text, '') = '' and coalesce(a.dt_suspensao::text, '') = '' and coalesce(a.dt_susp_agora::text, '') = ''  and a.nr_prescricao		= c.nr_prescricao and a.nr_prescricao 	= nr_prescricao_p and a.ie_agrupador not in (3,7,9);

c01 CURSOR FOR
SELECT  a.nr_sequencia,
		a.ie_origem_inf,
		a.cd_material,
		a.cd_unidade_medida,
		a.qt_dose,
		a.qt_unitaria,
		a.qt_material,
		a.cd_intervalo,
		--reordenar_horarios(dt_inicio_prescr_tes_w, reordenar_horarios_copia(a.ds_horarios)),
		trim(both reordenar_horarios( dt_inicio_prescr_tes_w, trim(both a.ds_horarios))),
		a.ds_horarios,
		a.ds_horarios_medico,
		substr(a.ds_observacao,1,2000),
		a.ds_observacao_enf,
		a.ie_via_aplicacao,
		a.nr_agrupamento,
		coalesce(a.ie_cobra_paciente,'S'),
		CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.cd_motivo_baixa  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  0  ELSE a.cd_motivo_baixa END  END ,
		CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  clock_timestamp()  ELSE CASE WHEN coalesce(a.ie_cobra_paciente,'S')='S' THEN  null  ELSE clock_timestamp() END  END ,
		a.ie_utiliza_kit,
		a.cd_unidade_medida_dose,
		a.qt_conversao_dose,
		a.nr_ocorrencia,
		a.qt_total_dispensar,
		a.cd_fornec_consignado,
		CASE WHEN coalesce(a.nr_sequencia_solucao::text, '') = '' THEN  null  ELSE a.nr_sequencia_solucao END ,
		CASE WHEN coalesce(a.nr_sequencia_proc::text, '') = '' THEN  null  ELSE a.nr_sequencia_proc END ,
		a.qt_solucao,
		a.ds_dose_diferenciada,
		a.ie_medicacao_paciente,
		CASE WHEN coalesce(a.nr_sequencia_diluicao::text, '') = '' THEN  null  ELSE a.nr_sequencia_diluicao + nr_seq_material_p END ,
		CASE WHEN a.ie_se_necessario='S' THEN  null  ELSE CASE WHEN ie_regra_geral_w='I' THEN  a.hr_prim_horario  ELSE to_char(to_date('30/12/1899'||substr(dt_primeiro_horario_p,1,5),'dd/mm/yyyy hh24:mi'),'hh24:mi') END  END ,
		CASE WHEN coalesce(a.nr_sequencia_dieta::text, '') = '' THEN null  ELSE a.nr_sequencia_dieta END ,
		a.ie_agrupador,
		a.nr_dia_util,
		coalesce(b.ie_situacao, 'A'),
		a.ie_se_necessario,
		a.qt_min_aplicacao,
		a.ie_bomba_infusao,
		coalesce(a.ie_aplic_bolus,'N'),
		coalesce(a.ie_aplic_lenta,'N'),
		coalesce(a.ie_acm,'N'),
		a.ie_objetivo,
		a.cd_topografia_cih,
		a.ie_origem_infeccao,
		a.cd_amostra_cih,
		a.cd_microorganismo_cih,
		coalesce(a.ie_uso_antimicrobiano,'N'),
		a.cd_protocolo,
		a.nr_seq_protocolo,
		a.nr_seq_mat_protocolo,
		a.qt_hora_aplicacao,
		'N',
		a.qt_vel_infusao,
		CASE WHEN VarCopiaJust_w='S' THEN CASE WHEN coalesce(a.qt_total_dias_lib,0)=0 THEN  a.ds_justificativa  ELSE CASE WHEN Obter_se_maior(coalesce(a.qt_total_dias_lib,0), coalesce(a.nr_dia_util,0)+1)='N' THEN a.ds_justificativa END  END   ELSE '' END ,
		a.ie_sem_aprazamento,
		a.ie_indicacao,
		a.dt_proxima_dose,
		a.qt_total_dias_lib,
		a.nr_seq_substituto,
		a.ie_lado,
		a.dt_inicio_medic,
		a.qt_dia_prim_hor,
		CASE WHEN coalesce(a.ie_regra_disp,'X')='D' THEN  a.ie_regra_disp  ELSE null END ,
		a.qt_vol_adic_reconst,
		a.qt_hora_intervalo,
		a.qt_min_intervalo,
		a.ie_urgencia,
		a.hr_prim_horario,
		ie_permite_substituir,
		a.nr_agrupamento,
		a.qt_dose_especial,
		a.ie_dose_espec_agora,
		a.hr_dose_especial,
		a.ds_observacao_far,
		a.nr_seq_origem_medic,
		Obter_estrutura_material(b.cd_material,'G'),
		Obter_estrutura_material(b.cd_material,'S'),
		Obter_estrutura_material(b.cd_material,'C'),
		coalesce(a.ie_suspenso, 'N'),
		coalesce(obter_se_material_prescricao(cd_estabelecimento_w, b.cd_material),'N'),
		coalesce(b.ie_vancomicina, 'N'),
		coalesce(a.ie_em_protocolo_vanco, 'N'),
		a.ie_fator_correcao,
		a.ds_medic_nao_padrao,
		a.ie_gerar_lote,
		coalesce(a.ie_ciclo_reprov,'N'),
		a.nr_seq_recomendacao
From	Material b,
		Prescr_Material a
where	1 = 1
and		((coalesce(a.nr_sequencia_diluicao::text, '') = '') or
		 a.nr_sequencia_diluicao not in (
			SELECT	x.nr_sequencia
			from	material y,
					prescr_material x
			where	y.cd_material = x.cd_material
			and		((y.ie_situacao <> 'A') or
					 ((ie_nao_padronizado_w = 'N') and (coalesce(substr(obter_se_material_padronizado(cd_estabelecimento_w, y.cd_material),1,1) ,'S') = 'N')))
			and	x.nr_prescricao = nr_prescricao_original_p))
and		exists (	select 1
				
				where	coalesce(a.nr_sequencia_proc::text, '') = ''
				
union all

				select 1
				
				where	ie_procedimento_p = 'S'
				
union all

				select 1
				from	Procedimento_prescricao c,
						Prescr_procedimento b where		(a.nr_sequencia_proc IS NOT NULL AND a.nr_sequencia_proc::text <> '')
				and		b.nr_sequencia		= a.nr_sequencia_proc
				and		b.cd_procedimento	= c.cd_procedimento
				and		b.ie_origem_proced	= c.ie_origem_proced
				and		c.ie_copia		= 'S'
				and		b.nr_prescricao		= nr_prescricao_original_p
				and		ie_procedimento_p 	= 'C' LIMIT 1)
and	not exists (	select	nr_prescricao
				from	prescr_dieta b where		a.nr_prescricao	= b.nr_prescricao
				and		a.nr_sequencia_dieta = b.nr_sequencia
				and		coalesce(b.ie_suspenso,'N')		= 'S' LIMIT 1)
and not exists (	select 	nr_prescricao
				from	prescr_solucao c where		a.nr_prescricao		= c.nr_prescricao
				and	a.nr_sequencia_solucao	= c.nr_seq_solucao
				and	coalesce(c.ie_suspenso,'N') = 'S' LIMIT 1)
and not exists (	select	nr_prescricao
				from	prescr_procedimento d where		a.nr_prescricao		= d.nr_prescricao
				and	a.nr_sequencia_proc	= d.nr_sequencia
				and	coalesce(d.ie_suspenso,'N') = 'S' LIMIT 1)
and not exists (	select	nr_prescricao
				from	prescr_material e where		a.nr_prescricao		= e.nr_prescricao
				and		a.nr_sequencia_diluicao = e.nr_sequencia
				and		coalesce(e.ie_suspenso,'N') = 'S' LIMIT 1)
and		((a.ie_origem_inf <> 'K') or (ie_copia_kit_rec_w = 'S'))
and		((a.nr_sequencia <> a.nr_sequencia_diluicao) or (coalesce(a.nr_sequencia_diluicao::text, '') = ''))
and		((coalesce(substr(obter_se_material_padronizado(cd_estabelecimento_w, b.cd_material),1,1) ,'S') = 'S') or (ie_nao_padronizado_w = 'S'))
and		(((coalesce(a.ie_suspenso,'N') <> 'S') and (b.ie_situacao = 'A')) or (ie_apres_medic_nao_copia_w = 'S'))
--and		a.dt_suspensao is null
and		coalesce(a.dt_susp_agora::text, '') = ''
and		a.cd_material 		= b.cd_material
and		a.ie_agrupador in (1,2,6) --,3,7,9)
and		a.nr_prescricao 	= nr_prescricao_original_p
order by a.nr_sequencia;


c02 CURSOR FOR
SELECT	a.ie_copiar,
		a.ie_regra_geral,
		a.nr_sequencia,
		coalesce(cd_material,0) cd_material,
		coalesce(cd_intervalo,'AAAAAAAAAA') cd_intervalo,
		a.ie_agora,
		coalesce(nr_seq_apres,99) nr_seq_apres,
		coalesce(ie_dose_especial,'N') ie_dose_especial,
		coalesce(a.ie_copiar_reprov_cih,'S') ie_copiar_reprov_ccih
from	rep_regra_copia_crit a
where	1 = 1
and		((a.nr_seq_regra = nr_seq_regra_p) or (coalesce(nr_seq_regra_p,0) = 0))
and		coalesce(a.cd_material,cd_material_w)	= cd_material_w
and		((a.cd_intervalo = cd_intervalo_w) or (coalesce(a.cd_intervalo::text, '') = ''))
and		((coalesce(a.ie_agora,'S') = 'N') or ('S' = coalesce(ie_urgencia_w,'N'))) -- Esta regra funciona ao contrario do ACM e SN, quando marcado so se aplica para itens Agora
and		((coalesce(a.ie_acm,'S')	= 'S') or (a.ie_acm = coalesce(ie_acm_w,'N')))
and		((coalesce(a.ie_se_necessario,'S') = 'S') or (a.ie_se_necessario = coalesce(ie_se_necessario_w,'N')))
and     coalesce(a.cd_classe_material,cd_classe_material_w) = cd_classe_material_w
and     coalesce(a.cd_grupo_material,cd_grupo_material_w)   = cd_grupo_material_w
and     coalesce(a.cd_subgrupo_material,cd_subgrupo_material_w) = cd_subgrupo_material_w 	
and		a.ie_tipo_item	= 'MED'
and		ie_agrupador_w		<> 2

union all

SELECT	a.ie_copiar,
		a.ie_regra_geral,
		a.nr_sequencia,
		coalesce(cd_material,0) cd_material,
		coalesce(cd_intervalo,'AAAAAAAAAA') cd_intervalo,
		ie_agora,
		coalesce(nr_seq_apres,99) nr_seq_apres,
		'N' ie_dose_especial,
		coalesce(a.ie_copiar_reprov_cih,'S') ie_copiar_reprov_ccih
from	rep_regra_copia_crit a
where	1 = 1
and		((a.nr_seq_regra	= nr_seq_regra_p) or (coalesce(nr_seq_regra_p,0) = 0))
and     coalesce(a.cd_classe_material,cd_classe_material_w) = cd_classe_material_w
and     coalesce(a.cd_grupo_material,cd_grupo_material_w)   = cd_grupo_material_w
and     coalesce(a.cd_subgrupo_material,cd_subgrupo_material_w) = cd_subgrupo_material_w 
and		coalesce(a.cd_material,cd_material_w)	= cd_material_w
and		((a.cd_intervalo = cd_intervalo_w) or (coalesce(a.cd_intervalo::text, '') = ''))
and		((coalesce(a.ie_agora,'S') = 'S') or (a.ie_agora = coalesce(ie_urgencia_w,'N'))) 
and		((coalesce(a.ie_acm,'S')	= 'S') or (a.ie_acm = coalesce(ie_acm_w,'N')))
and		((coalesce(a.ie_se_necessario,'S') = 'S') or (a.ie_se_necessario = coalesce(ie_se_necessario_w,'N')))
and		a.ie_tipo_item	= 'MAT'
and		ie_agrupador_w		= 2
order by
	nr_seq_apres desc,
	cd_material desc,
	cd_intervalo desc,
	ie_agora desc; -- Buscar ultima regra
c03 CURSOR FOR
SELECT	CASE WHEN ie_regra_geral_w='H' THEN  null  ELSE ie_regra_prim_hor END ,
		CASE WHEN ie_regra_geral_w='H' THEN  ie_regra_horarios END ,
		CASE WHEN ie_regra_geral_w='H' THEN ie_regra_prim_horarios END ,
		CASE WHEN ie_regra_geral_w='H' THEN ie_elimina_hor END ,
		CASE WHEN ie_regra_geral_w='H' THEN ie_reordenar END
from	rep_regra_copia_hor
where	nr_seq_regra_copia	= nr_seq_regra_w
order by coalesce(nr_seq_apres,999) desc;

c04 CURSOR FOR
SELECT	dt_horario
from	prescr_mat_hor
where	1 = 1
and		coalesce(ie_situacao,'A')	= 'A'
and		coalesce(ie_horario_especial,'N') = 'N'
--and	dt_suspensao is null
and		coalesce(ie_dose_especial,'N') <> 'S'
and		nr_seq_material	= nr_sequencia_ww
and		nr_prescricao	= nr_prescricao_original_p
order by dt_horario;

c10 CURSOR FOR /* Ivan em 25/03/2008 OS */
SELECT	nr_sequencia
from	prescr_material
where	1 = 1
and		coalesce(nr_sequencia_solucao, coalesce(nr_sequencia_proc, coalesce(nr_sequencia_dieta, nr_sequencia_diluicao))) is null
and		ie_agrupador		= 1
and		nr_prescricao = nr_prescricao_p;


BEGIN

nr_prescricoes_w	:= ' ' || nr_prescricoes_p || ' ';
nr_prescricoes_w	:= replace(nr_prescricoes_w, ',',' ');
nr_prescricoes_w	:= replace(nr_prescricoes_w, '  ',' ');

select	coalesce(max(cd_estabelecimento),1),
		max(cd_setor_atendimento),
		max(nr_atendimento)
into STRICT	cd_estabelecimento_w,
		cd_setor_atendimento_w,
		nr_atendimento_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_original_p;

select	max(ie_copia_albumina)
into STRICT	ie_copia_albumina_w
from	parametro_medico
where	cd_estabelecimento	= cd_estabelecimento_w;


select	max(ie_gera_disp_acm_sn)
into STRICT	ie_gera_disp_acm_sn_w
from	parametros_farmacia
where	cd_estabelecimento	= cd_estabelecimento_w;

cd_perfil_w	:= coalesce(cd_perfil_p,coalesce(obter_perfil_ativo,0));

ie_prim_horario_setor_w := obter_param_usuario(8030, 44, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_prim_horario_setor_w);

CALL Wheb_assist_pck.set_informacoes_usuario(cd_estabelecimento_w, cd_perfil_w, nm_usuario_p);
ie_padronizado_w			:= Wheb_assist_pck.obterParametroFuncao(924,18);
ie_copia_medic_w			:= Wheb_assist_pck.obterParametroFuncao(924,39);
ie_calcula_validade_w		:= Wheb_assist_pck.obterParametroFuncao(924,98);
ie_nao_padronizado_w		:= Wheb_assist_pck.obterParametroFuncao(924,111);
ie_copia_mat_w				:= Wheb_assist_pck.obterParametroFuncao(924,121);
VarCopiaJust_w				:= Wheb_assist_pck.obterParametroFuncao(924,135);
ie_apres_medic_nao_copia_w	:= Wheb_assist_pck.obterParametroFuncao(924,148);
ie_copia_direta_w			:= Wheb_assist_pck.obterParametroFuncao(924,173);
ie_prescr_agora_pa_w		:= Wheb_assist_pck.obterParametroFuncao(924,311);
ie_limp_prim_hor_acm_w		:= Wheb_assist_pck.obterParametroFuncao(924,445);
ie_estender_w				:= Wheb_assist_pck.obterParametroFuncao(924,249);
hr_prim_presc_w				:= Wheb_assist_pck.obterParametroFuncao(924,532);
ie_param548_w				:= Wheb_assist_pck.obterParametroFuncao(924,548);
ie_tela_validade_w			:= Wheb_assist_pck.obterParametroFuncao(924,753);
ie_gerar_diluicao_w			:= Wheb_assist_pck.obterParametroFuncao(924,813);
ie_param911_w				:= Wheb_assist_pck.obterParametroFuncao(924,911);
ie_param930_w				:= Wheb_assist_pck.obterParametroFuncao(924,930);
ie_copia_kit_rec_w			:= Wheb_assist_pck.obterParametroFuncao(924,933);
qt_espacos_horarios_w		:= Wheb_assist_pck.obterParametroFuncao(924,1033);
var_copia_diluicao_w		:= Wheb_assist_pck.obterParametroFuncao(924,1077);
ie_param1128_w				:= Wheb_assist_pck.obterParametroFuncao(924,1128);

select	max(dt_inicio_prescr),
		max(nr_horas_validade),
		max(dt_primeiro_horario),
		max(cd_setor_atendimento),
		max(dt_primeiro_horario)
into STRICT	dt_inicio_prescr_tes_w,
		nr_horas_validade_w,
		dt_primeiro_horario_w,	
		cd_setor_prescr_w,
		dt_primeiro_ant_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

select	coalesce(max(ie_gerar_diluicao),'S')
into STRICT	ie_gerar_dil_setor_w
from	setor_atendimento
where	cd_setor_atendimento = cd_setor_prescr_w;

if (ie_calcula_validade_w	= 'R') then
	ie_calcula_validade_w	:= obter_se_calcula_validade(cd_setor_prescr_w);
end if;

nr_horas_validade_w	:= 24;

if (ie_prim_horario_setor_w = 'S') then
	select	to_char(coalesce(max(hr_inicio_prescricao),clock_timestamp()),'hh24:mi')
	into STRICT	hr_setor_w
	from	setor_atendimento
	where	cd_setor_atendimento = cd_setor_prescr_w;
else	
	Select  to_char(Obter_Prim_Horario_Prescricao(nr_atendimento_w,cd_setor_prescr_w,clock_timestamp(),nm_usuario_p,'R'),'hh24:mi')
	into STRICT	hr_setor_w
	;
end if;

if (cd_funcao_ativa_p = 8030) and (coalesce(hr_prim_presc_w::text, '') = '') then
	begin
		dt_primeiro_horario_w	:= to_date(to_char(dt_primeiro_horario_w,'dd/mm/yyyy') || ' ' || hr_setor_w || ':00','dd/mm/yyyy hh24:mi:ss');
	exception when others then
		dt_primeiro_horario_w	:= dt_primeiro_horario_w;
	end;
end if;

nr_horas_validade_w	:= obter_horas_validade_prescr(dt_primeiro_horario_w, nr_atendimento_w, ie_estender_w,null, clock_timestamp(),null);

if (dt_primeiro_horario_w 	<> dt_primeiro_ant_w) and (ie_tela_validade_w	<> 'T') then
	nr_horas_validade_w	:= obter_horas_validade_prescr(dt_primeiro_horario_w, nr_atendimento_w, ie_estender_w,null, clock_timestamp(),null);
	update	prescr_medica
	set	dt_primeiro_horario	= dt_primeiro_horario_w,
		nr_horas_validade	= nr_horas_validade_w
	where	nr_prescricao	= nr_prescricao_p;
	
	select	max(dt_inicio_prescr)
	into STRICT	dt_inicio_prescr_tes_w
	from	prescr_medica
	where	nr_prescricao	= nr_prescricao_p;
end if;

if (ie_regra_geral_w <> 'I') and (nr_atendimento_w > 0) and (ie_prescr_agora_pa_w = 'S') then
	Select	cd_classif_setor
	into STRICT	cd_classif_setor_w
	from	setor_atendimento
	where	cd_setor_atendimento = (SELECT Obter_Unidade_Atendimento(nr_atendimento_w,'A','CS') );

	if (cd_classif_setor_w	= '1') then
		dt_prim_horario_w	:= to_char(clock_timestamp() + interval '10 days'/1440,'dd/mm/yyyy hh24:mi:ss');
		dt_primeiro_horario_w	:= to_date(substr(dt_prim_horario_w,1,15)||'0:00','dd/mm/yyyy hh24:mi:ss');
	end if;
end if;

select	coalesce(max(nr_agrupamento),0)
into STRICT	nr_agrup_acum_w
from	prescr_material
where	nr_prescricao = nr_prescricao_p;

if (ie_param1128_w = 'S') then
	ie_param1128_w	:= Obter_se_em_protocolo_vanco(nr_atendimento_w, 'N', coalesce(Wheb_assist_pck.obterParametroFuncao(924,1156),0));
end if;

open C01;
loop
fetch C01 into	
	nr_sequencia_w,
	ie_origem_inf_w,
	cd_material_w,
	cd_unidade_medida_w,
	qt_dose_w,
	qt_unitaria_w,
	qt_material_w,
	cd_intervalo_w,
	ds_horarios_reordenados_w,
	ds_horarios_w,
	ds_horarios_medico_w,
	ds_observacao_w,
	ds_observacao_enf_w,
	ie_via_aplicacao_w,
	nr_agrupamento_w,
	ie_cobra_paciente_w,
	cd_motivo_baixa_w,
	dt_baixa_w,
	ie_utiliza_kit_w,
	cd_unidade_medida_dose_w,
	qt_conversao_dose_w,
	nr_ocorrencia_w,
	qt_total_dispensar_w,
	cd_fornec_consignado_w,
	nr_sequencia_solucao_w,
	nr_sequencia_proc_w,
	qt_solucao_w,
	ds_dose_diferenciada_w,
	ie_medicacao_paciente_w,
	nr_sequencia_diluicao_w,
	hr_prim_horario_w,
	nr_sequencia_dieta_w,
	ie_agrupador_w,
	nr_dia_util_w,
	ie_situacao_w,
	ie_se_necessario_w,
	qt_min_aplicacao_w,
	ie_bomba_infusao_w,
	ie_aplic_bolus_w,
	ie_aplic_lenta_w,
	ie_acm_w,
	ie_objetivo_w,
	cd_topografia_cih_w,
	ie_origem_infeccao_w,
	cd_amostra_cih_w,
	cd_microorganismo_cih_w,
	ie_uso_antimicrobiano_w,
	cd_protocolo_w,
	nr_seq_protocolo_w,
	nr_seq_mat_protocolo_w,
	qt_hora_aplicacao_w,
	ie_recons_diluente_fixo_w,
	qt_vel_infusao_w,
	ds_justificativa_w,
	ie_sem_aprazamento_ww,
	ie_indicacao_w,
	dt_proxima_dose_w,
	qt_total_dias_lib_w,
	nr_seq_substituto_w,
	ie_lado_w,
	dt_inicio_medic_w,
	qt_dia_prim_hor_w,
	ie_regra_disp_w,
	qt_vol_adic_reconst_w,
	qt_hora_intervalo_w,
	qt_min_intervalo_w,
	ie_urgencia_w,
	hr_prim_horario_aux_w,
	IE_PERMITE_SUBSTITUIR_w,
	nr_agrup_aux_w,
	qt_dose_especial_w,
	ie_dose_espec_agora_w,
	hr_dose_especial_w,
	ds_observacao_far_w,
	nr_seq_origem_medic_w,
	cd_grupo_material_w,
	cd_subgrupo_material_w,
	cd_classe_material_w,
	ie_suspenso_w,
	ie_prescricao_w,
	ie_vancomicina_w,
	ie_em_protocolo_vanco_w,
	ie_fator_correcao_w,
	ds_medic_nao_padrao_w,
	ie_gerar_lote_w,
	ie_ciclo_reprov_w,
	nr_seq_recomendacao_wW;
EXIT WHEN NOT FOUND; /* apply on C01 */

	nr_sequencia_ww	:= nr_sequencia_w;
	
	if (ie_suspenso_w = 'N') and (ie_prescricao_w = 'S') and (ie_situacao_w = 'A') then
		
		if (ie_param911_w in ('S', 'C')) and (ie_agrupador_w = 1) then
			
			if (ie_param911_w = 'C') then
				cd_intervalo_w	:= null;
			else
				cd_intervalo_w	:= Obter_interv_acm_sn_agora_lib(cd_estabelecimento_w,0,0,1,cd_material_w,cd_intervalo_w,nr_prescricao_p,null,null);
			end if;

			if (coalesce(cd_intervalo_w::text, '') = '') then
				ds_horarios_w	:= null;
			end if;
		end if;
		
		ie_copiar_w := 'N';
		ie_copiar_ccih_reprov_w := 'S';
		
		open C02;
		loop
		fetch C02 into	
			ie_copiar_w,
			ie_regra_geral_w,
			nr_seq_regra_w,
			cd_mat_aux_w,
			cd_intervalo_aux_w,
			ie_agora_aux_w,
			nr_seq_apres_w,
			ie_regra_dose_especial_w,
			ie_copiar_ccih_reprov_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			ie_copiar_w				:= ie_copiar_w;
			ie_regra_geral_w		:= ie_regra_geral_w;
			nr_seq_regra_w			:= nr_seq_regra_w;
			ie_copiar_ccih_reprov_w := ie_copiar_ccih_reprov_w;
			Exit;
		end loop;
		close C02;
		
		if (ie_copiar_w = 'S') and (ie_param1128_w = 'S') and (ie_agrupador_w = 1) then	
			if	((ie_em_protocolo_vanco_w = 'S') and
				 ((ie_vancomicina_w = 'N') or (ie_urgencia_w = 'S'))) then
				ie_copiar_w	:= 'N';
			elsif (ie_vancomicina_w = 'S') then
				cd_medic_posicionar_p	:= cd_material_w;
			end if;
		end if;

		ie_copiar_w		:= coalesce(ie_copiar_w,'N');
			
		if (ie_copiar_w = 'S') and (nr_sequencia_diluicao_w IS NOT NULL AND nr_sequencia_diluicao_w::text <> '') then
			select	coalesce(max('S'),'N')
			into STRICT	ie_copiar_w
			from	prescr_material where		nr_sequencia	= nr_sequencia_diluicao_w
			and		nr_prescricao	= nr_prescricao_p LIMIT 1;
		end if;

		if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') and (ie_copiar_w	= 'S') then
			select	coalesce(max(ie_copiar),'S')
			into STRICT	ie_copiar_w
			from	intervalo_prescricao
			where	cd_intervalo = cd_intervalo_w;
		end if;	

		
		if (ie_copiar_ccih_reprov_w = 'N') and (ie_ciclo_reprov_w = 'S') then
			
			if (coalesce(obter_se_prescr_comunic_cih(nr_prescricao_original_p,nr_sequencia_w),'N') = 'S') then	
				ie_copiar_w	:= 'N';
			else
				ie_copiar_w	:= 'S';
			end if;	
		end if;	
		
		-- Sair do laco atual, pois o item nao sera copiado
		if (ie_copiar_w = 'S') then
			
			if (ie_regra_geral_w	<> 'I') then
				open C03;
				loop
				fetch C03 into	
					ie_regra_prim_hor_w,
					ie_regra_horarios_w,
					ie_regra_prim_horarios_w,
					ie_elimina_hor_w,
					ie_reordenar_w;
				EXIT WHEN NOT FOUND; /* apply on C03 */
					ie_regra_prim_hor_w	:= ie_regra_prim_hor_w;
					ie_regra_horarios_w	:= ie_regra_horarios_w;
					ie_regra_prim_horarios_w := ie_regra_prim_horarios_w;
					ie_elimina_hor_w	:= ie_elimina_hor_w;
					ie_reordenar_w		:= ie_reordenar_w;
					
					if (ie_regra_horarios_w <> 'HS') then
						ie_regra_prim_hor_ant_w	:= ie_regra_prim_hor_w;
						ie_regra_horarios_ant_w	:= ie_regra_horarios_w;
						ie_regra_prim_horarios_ant_w := ie_regra_prim_horarios_w;
						ie_elimina_hor_ant_w	:= ie_elimina_hor_w;
						ie_reordenar_ant_w	:= ie_reordenar_w;
					end if;
				end loop;
				close C03;
			else
				hr_prim_horario_w	:= hr_prim_horario_aux_w;
			end if;
			
			if (ie_reordenar_w = 'S') then
				ds_horarios_w	:= ds_horarios_reordenados_w;
				ds_horarios_w := Reordenar_Horarios_Prescr(dt_inicio_prescr_tes_w, ds_horarios_w);
			end if;
			
			nr_sequencia_orig_w	:= nr_sequencia_w;
			nr_sequencia_w		:= nr_sequencia_w   + nr_seq_material_p;
			
			if (nr_agrupamento_w	= 0) then
				select	coalesce(max(nr_agrupamento),0) + 1
				into STRICT	nr_agrupamento_w
				from	prescr_material
				where	nr_prescricao	= nr_prescricao_original_p;
			end if;
			
			nr_agrupamento_w	:= nr_agrupamento_w + nr_agrup_acum_w;
			
			if (coalesce(nr_sequencia_w,0) = 0) then
				nr_sequencia_w	:= 1;
			end if;
			
			if (ie_regra_dose_especial_w = 'N') then
				qt_dose_especial_w := null;
				ie_dose_espec_agora_w := 'N';
				hr_dose_especial_w := null;
			end if;
			
			ie_loop_w	:= 'S';
			nr_sequencia_w	:= 1;
			while(ie_loop_w = 'S') loop
				select	count(*)
				into STRICT	qt_itens_w
				from	prescr_material where		nr_prescricao	= nr_prescricao_p
				and	nr_sequencia	= nr_sequencia_w LIMIT 1;
				if (qt_itens_w	= 0) then
					ie_loop_w	:= 'N';
				else	
					nr_sequencia_w	:= nr_sequencia_w + 1;
				end if;
			end loop;
			
			select	max(ie_sem_aprazamento),
					max(ie_agora)
			into STRICT	ie_sem_aprazamento_w,
					ie_agora_w
			from	intervalo_prescricao
			where	cd_intervalo	= cd_intervalo_w;
			
			if (ie_sem_aprazamento_ww = 'S') and (coalesce(ie_sem_aprazamento_w::text, '') = '') then
				ie_sem_aprazamento_w	:= 'S';
			elsif (coalesce(ie_sem_aprazamento_w::text, '') = '')  then
				ie_sem_aprazamento_w	:= ie_sem_aprazamento_ww;
			end if;
			
			if (ie_acm_w = 'S') then
				ds_horarios_w	:= 'ACM';
				if (ie_limp_prim_hor_acm_w = 'S') then
					hr_prim_horario_w := '';
				end if;
			end if;
			
			if (ie_se_necessario_w = 'S') then
				ds_horarios_w	:= 'SN';
			end if;
			
			select	coalesce(max(qt_conversao),qt_conversao_dose_w)
			into STRICT	qt_conversao_dose_w
			from	unidade_medida_dose_v
			where	cd_material = cd_material_w
			and	cd_unidade_medida = cd_unidade_medida_dose_w;
			
			nr_seq_dieta_w := null;
			if (nr_sequencia_dieta_w > 0) then
				select 	coalesce(max(nr_sequencia),'')
				into STRICT	nr_seq_dieta_w
				from 	prescr_dieta
				where 	nr_prescricao_original = nr_prescricao_original_p
				and		nr_seq_anterior	= nr_sequencia_dieta_w;
			end if;
			
			begin
			qt_unitaria_w	:= dividir(qt_dose_w, qt_conversao_dose_w);
			exception when others then
			null;		
			end;
			
			if (ie_gera_disp_acm_sn_w = 'N' AND (ie_acm_w = 'S' or ie_se_necessario_w = 'S' )) then
				ie_gerar_lote_w := 'N';
			end if;
			
			if (nr_seq_recomendacao_wW IS NOT NULL AND nr_seq_recomendacao_wW::text <> '') then
				select	count(*)
				into STRICT	cont_w
				from	prescr_recomendacao where		nr_sequencia	= nr_seq_recomendacao_wW
				and		nr_prescricao	= nr_prescricao_p LIMIT 1;

				if (cont_w > 0) then
					update	prescr_recomendacao
					set		ie_kit_gerado = 'S'
					where	nr_sequencia	= nr_seq_recomendacao_wW
					and		nr_prescricao	= nr_prescricao_p;
				end if;
			end if;
			
			if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') and (ie_param548_w = 'N') and (ie_param930_w = 'N') and (ie_agora_w = 'S') then
			
			   cd_intervalo_w := null;
			   ds_horarios_w := null;
			end if;
		
			begin
			Insert  into Prescr_Material(
				nr_prescricao,
				nr_sequencia,
				ie_origem_inf,
				cd_material,
				cd_unidade_medida,
				qt_dose,
				qt_unitaria,
				qt_material,
				dt_atualizacao,
				nm_usuario,
				cd_intervalo,
				ds_horarios,
				ds_observacao,
				ds_observacao_enf,
				ie_via_aplicacao,
				nr_agrupamento,
				ie_cobra_paciente,
				cd_motivo_baixa,
				dt_baixa,
				ie_utiliza_kit,
				cd_unidade_medida_dose,
				qt_conversao_dose,
				nr_ocorrencia,
				qt_total_dispensar,
				cd_fornec_consignado,
				nr_sequencia_solucao,
				nr_sequencia_proc,
				qt_solucao,
				ds_dose_diferenciada,
				ie_medicacao_paciente,
				nr_sequencia_diluicao,
				hr_prim_horario,
				nr_sequencia_dieta,
				ie_agrupador,
				nr_dia_util,
				ie_suspenso,
				ie_se_necessario,
				qt_min_aplicacao,
				ie_bomba_infusao,
				ie_aplic_bolus,
				ie_aplic_lenta,
				ie_acm,
				ie_objetivo,
				cd_topografia_cih,
				ie_origem_infeccao,
				cd_amostra_cih,
				cd_microorganismo_cih,
				ie_uso_antimicrobiano,
				cd_protocolo,
				nr_seq_protocolo,
				nr_seq_mat_protocolo,
				qt_hora_aplicacao,
				ie_recons_diluente_fixo,
				qt_vel_infusao,
				ds_justificativa,
				ie_sem_aprazamento,
				ie_indicacao,
				dt_proxima_dose,
				qt_total_dias_lib,
				nr_seq_substituto,
				ie_lado,
				--dt_inicio_medic, Retirado pela solicitacao da OS 1617058
				qt_dia_prim_hor,
				ie_regra_disp,
				qt_vol_adic_reconst,
				qt_hora_intervalo,
				qt_min_intervalo,
				ie_urgencia,
				IE_PERMITE_SUBSTITUIR,
				qt_dose_especial,
				ie_dose_espec_agora,
				hr_dose_especial,
				ds_observacao_far,
				nr_seq_anterior,
				nr_prescricao_original,
				nr_seq_origem_medic,
				nr_prescricao_anterior,
				nr_sequencia_anterior,
				ie_em_protocolo_vanco,
				ie_fator_correcao,
				ds_medic_nao_padrao,
				ie_gerar_lote)
			values (nr_prescricao_p,
				nr_sequencia_w,
				ie_origem_inf_w,
				cd_material_w,
				cd_unidade_medida_w,
				qt_dose_w,
				qt_unitaria_w,
				qt_material_w,
				clock_timestamp(),
				nm_usuario_p,
				cd_intervalo_w,
				ds_horarios_w,
				ds_observacao_w,
				ds_observacao_enf_w,
				ie_via_aplicacao_w,
				nr_agrupamento_w,
				ie_cobra_paciente_w,
				cd_motivo_baixa_w,
				dt_baixa_w,
				ie_utiliza_kit_w,
				cd_unidade_medida_dose_w,
				qt_conversao_dose_w,
				nr_ocorrencia_w,
				qt_total_dispensar_w,
				cd_fornec_consignado_w,
				nr_sequencia_solucao_w,
				nr_sequencia_proc_w,
				qt_solucao_w,
				ds_dose_diferenciada_w,
				ie_medicacao_paciente_w,
				nr_sequencia_diluicao_w,
				hr_prim_horario_w,
				nr_seq_dieta_w,
				ie_agrupador_w,
				nr_dia_util_w,
				ie_suspenso_w,
				ie_se_necessario_w,
				qt_min_aplicacao_w,
				ie_bomba_infusao_w,
				ie_aplic_bolus_w,
				ie_aplic_lenta_w,
				ie_acm_w,
				ie_objetivo_w,
				cd_topografia_cih_w,
				ie_origem_infeccao_w,
				cd_amostra_cih_w,
				cd_microorganismo_cih_w,
				ie_uso_antimicrobiano_w,
				cd_protocolo_w,
				nr_seq_protocolo_w,
				nr_seq_mat_protocolo_w,
				qt_hora_aplicacao_w,
				ie_recons_diluente_fixo_w,
				qt_vel_infusao_w,
				ds_justificativa_w,
				ie_sem_aprazamento_w,
				ie_indicacao_w,
				dt_proxima_dose_w,
				qt_total_dias_lib_w,
				nr_seq_substituto_w,
				ie_lado_w,
				--dt_inicio_medic_w, Retirado pela solicitacao da OS 1617058
				qt_dia_prim_hor_w,
				ie_regra_disp_w,
				qt_vol_adic_reconst_w,
				qt_hora_intervalo_w,
				qt_min_intervalo_w,
				'N',
				IE_PERMITE_SUBSTITUIR_w,
				qt_dose_especial_w,
				ie_dose_espec_agora_w,
				hr_dose_especial_w,
				ds_observacao_far_w,
				nr_sequencia_orig_w,
				nr_prescricao_original_p,
				nr_seq_origem_medic_w,
				nr_prescricao_original_p,
				nr_sequencia_orig_w,
				ie_em_protocolo_vanco_w,
				ie_fator_correcao_w,
				ds_medic_nao_padrao_w,
				ie_gerar_lote_w);
			commit;
			
			nr_sequencia_novo_ww	:= nr_sequencia_w;
			
			exception when others then
				erro_w	:= sqlerrm;
			end;
			
			qt_dia_prim_hor_w	:= 0;
			if (hr_prim_horario_w <> '') and (hr_prim_horario_w <> '  :  ') and (hr_prim_horario_w < to_char(dt_inicio_prescr_tes_w,'hh24:mi')) then
				qt_dia_prim_hor_w	:= 1;
			end if;

			update	prescr_material
			set 	qt_dia_prim_hor		= qt_dia_prim_hor_w
			where	nr_prescricao 		= nr_prescricao_p
			and	nr_sequencia		= nr_sequencia_w
			and	(hr_prim_horario IS NOT NULL AND hr_prim_horario::text <> '');
			
			/* Exclui os medicamentos de acordo com o parametro 198 da prescricao - Ivan 

	em 25/03/2008 OS84773 */
			open c10;
			loop
			fetch c10 into
				nr_seq_material_delete_w;
			EXIT WHEN NOT FOUND; /* apply on c10 */
				if (consiste_se_copia_medic(nr_prescricao_p, nr_seq_material_delete_w, cd_estabelecimento_w, nm_usuario_p) = 'N') then
					delete	from prescr_material
					where	nr_prescricao	= nr_prescricao_p
					and	nr_sequencia	= nr_seq_material_delete_w;
				end if;
			end loop;
			close c10;
			
			/* Remove as informacoes de substituicao apos copiar - Ivan em 25/03/2008 

	OS84773 */
			if (ie_copia_direta_w = 'N') then
				update	prescr_material
				set	nr_seq_substituto	 = NULL
				where	nr_prescricao		= nr_prescricao_p
				and	(nr_seq_substituto IS NOT NULL AND nr_seq_substituto::text <> '');
			end if;
			
			begin
			insert into prescr_material_cid(
				nr_sequencia,
				cd_doenca_cid,
				nr_prescricao,
				nr_sequencia_medic,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec)
			SELECT	nextval('prescr_material_cid_seq'),
				cd_doenca_cid,
				nr_prescricao_p,
				nr_sequencia_medic + nr_seq_material_p,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p
			from	prescr_material_cid
			where	nr_prescricao	= nr_prescricao_original_p
			and	nr_sequencia_medic = nr_sequencia_orig_w;
			exception
				when others then
				ie_aux_w := 'X';
			end;
			
			select	coalesce(max(ie_dias_util_medic),'N')
			into STRICT	ie_dias_util_medic_w
			from	material
			where	cd_material	= cd_material_w;

			if (ie_dias_util_medic_w <> 'N') then
			
				SELECT * FROM Consiste_Util_Medic(nr_prescricao_p, nr_atendimento_w, dt_prescricao_p, cd_material_w, nr_dia_util_w, QT_DIAS_LIBERADO_w, ie_controle_medico_w, qt_dias_lib_atend_w) INTO STRICT nr_dia_util_w, QT_DIAS_LIBERADO_w, ie_controle_medico_w, qt_dias_lib_atend_w;
				
				update prescr_material
				set	nr_dia_util		= nr_dia_util_w,
					qt_total_dias_lib 	= qt_dias_lib_atend_w
				where	nr_prescricao 		= nr_prescricao_p
				  and	nr_sequencia		= nr_sequencia_w;		  	
		
				CALL Gerar_subst_sug_cih(nr_prescricao_p, nr_sequencia_w, nr_prescricao_original_p, cd_material_w);			
			
				select 	max(cd_material),
						max(a.cd_intervalo)
				into STRICT	cd_material_w,
						cd_intervalo_w
				from 	prescr_material a
				where 	a.nr_prescricao = nr_prescricao_p
				and		a.nr_sequencia	= nr_sequencia_novo_ww;
				
			end if;

			if (ie_regra_geral_w = 'H') then
			
				if (ie_regra_horarios_w = 'HS') then
				
					select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
					into STRICT	ie_composto_w
					from	prescr_material where nr_prescricao	= nr_prescricao_original_p
					and	cd_material	<> cd_material_w
					and	nr_agrupamento	= nr_agrup_aux_w LIMIT 1;
					
					select	count(*)
					into STRICT	qt_hor_w
					from	rep_horario_hor_pac where nr_atendimento	= nr_atendimento_w
					and	cd_material	= cd_material_w
					and	cd_intervalo	= cd_intervalo_w
					and	coalesce(ie_composto,ie_composto_w)	= ie_composto_w
					and	coalesce(dt_cancelamento::text, '') = ''
					and	((ie_via_aplicacao = ie_via_aplicacao_w) or (coalesce(ie_via_aplicacao_w::text, '') = ''))
					and	coalesce(qt_dose,qt_dose_w) = qt_dose_w LIMIT 1;
					
					if (qt_hor_w	= 0) then
						ie_regra_prim_hor_w	:= ie_regra_prim_hor_ant_w;
						ie_regra_horarios_w	:= ie_regra_horarios_ant_w;
						ie_regra_prim_horarios_w := ie_regra_prim_horarios_ant_w;
						ie_elimina_hor_w	:= ie_elimina_hor_ant_w;
						ie_reordenar_w		:= ie_reordenar_ant_w;
					end if;
				end if;
				
				if (ie_regra_horarios_w in ('HA', 'HI')) then
					ds_horarios_w	:= null;
					open c04;
					loop
					fetch c04 into	
						dt_horario_w;
					EXIT WHEN NOT FOUND; /* apply on c04 */
						if (to_char(dt_horario_w,'mi') = '00') then
							if (coalesce(ds_horarios_w::text, '') = '') then
								ds_horarios_w	:= to_char(dt_horario_w,'hh24');
							else
								ds_horarios_w	:= ds_horarios_w ||' ' || to_char(dt_horario_w,'hh24');
							end if;
						else
							if (coalesce(ds_horarios_w::text, '') = '') then
								ds_horarios_w	:= to_char(dt_horario_w,'hh24:mi');
							else
								ds_horarios_w	:= ds_horarios_w ||' ' || to_char(dt_horario_w,'hh24:mi');
							end if;
						end if;
					end loop;
					close c04;
					
					if (coalesce(ie_reordenar_w,'S') = 'S') then
						ds_horarios_w	:= reordenar_horarios(dt_inicio_prescr_tes_w, trim(both ds_horarios_w));
						ds_horarios_w := Reordenar_Horarios_Prescr(dt_inicio_prescr_tes_w, ds_horarios_w);
					end if;
					
					if (ie_acm_w = 'S') then
						ds_horarios_w	:= 'ACM';
					end if;
					
					if (ie_se_necessario_w = 'S') then
						ds_horarios_w	:= 'SN';
					end if;
					
					select	max(ie_operacao),
							max(qt_operacao)
					into STRICT	ie_operacao_w,
							qt_operacao_w
					from	intervalo_prescricao
					where	cd_intervalo	= cd_intervalo_w;
					
					if (ds_horarios_w not in ('ACM','SN')) or ((coalesce(ds_horarios_w::text, '') = '') and (ie_operacao_w = 'D')) then
						ds_horarios_prim_w	:= ds_horarios_w;
						if (position(' ' in ds_horarios_prim_w) = 0) then
							ds_horarios_prim_w	:= ds_horarios_prim_w || ' ';
						end if;

						hr_prim_horario_w	:= substr(ds_horarios_prim_w,1,position(' ' in ds_horarios_prim_w) - 1);
						if (position(':' in hr_prim_horario_w) = 0) then
							hr_prim_horario_w	:= substr(hr_prim_horario_w || ':00',1,5);
						end if;
						
						if (ie_operacao_w in ('F','V')) then
							hr_prim_horario_w	:= obter_primeiro_horario(cd_intervalo_w,nr_prescricao_p,cd_material_w,ie_via_aplicacao_w);
						end if;
						
						select	max(dt_inicio_prescr)
						into STRICT	dt_inicio_prescr_ww
						from	prescr_medica
						where	nr_prescricao	= nr_prescricao_p;
						
						nr_ocorrencia_w		:= 0;
						begin
						dt_prim_hora_int_w 	:= to_date(to_char(dt_prescricao_w,'dd/mm/yyyy')||' '|| hr_prim_horario_w ||':00','dd/mm/yyyy hh24:mi:ss');
						exception when others then
							dt_prim_hora_int_w	:= dt_inicio_prescr_tes_w;
						end;
						
						
						if (to_char(dt_primeiro_horario_w,'hh24:mi:ss') < to_char(clock_timestamp(),'hh24:mi:ss')) then
							dt_inicio_prescr_ww := to_date(to_char(clock_timestamp() + interval '1 days','dd/mm/yyyy') || ' ' || to_char(dt_primeiro_horario_w,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
						else
							dt_inicio_prescr_ww := to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || to_char(dt_primeiro_horario_w,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
						end if;
						
						if (ie_agrupador_w = 1) and
							((ie_regra_horarios_w = 'HI') or -- Caso deva dar continuidade ao intervalo, deve-se localizar o ultimo horario do medicamento, independente de quebra de ciclo da medicacao (POA)
							 (dt_prim_hora_int_w < dt_inicio_prescr_ww)) then
							
							if (somente_numero(nr_prescricoes_w) = 0) then
								nr_prescricoes_w	:= to_char(nr_prescricao_p);
							end if;

							hr_prim_horario_interv_w	:= obter_prim_hor_medic_interv(nr_atendimento_w,nr_prescricoes_w,dt_inicio_prescr_ww, cd_material_w, cd_intervalo_w,null,'H',null, qt_dose_w);
							
							begin
							if (ie_regra_horarios_w = 'HI') then
								dt_prim_hora_int_w 	:= hr_prim_horario_interv_w;
							else
								dt_prim_hora_int_w 	:= to_date(to_char(dt_prescricao_w,'dd/mm/yyyy')||' '|| to_char(hr_prim_horario_interv_w,'hh24:mi') ||':00','dd/mm/yyyy hh24:mi:ss');
							end if;
							exception when others then
								dt_prim_hora_int_w	:= dt_inicio_prescr_tes_w;
							end;
							
						end if;
						
						dt_prim_hora_int_w	:= coalesce(dt_prim_hora_int_w,dt_primeiro_horario_w);
						
						-- Tratamento para continuidade do intervalo, independente de quebra de ciclo da medicacao (POA)
						if (ie_regra_horarios_w = 'HI') and (coalesce(qt_operacao_w,0) > 0) and (ie_operacao_w in ('H')) then
							
							if (ie_operacao_w in ('H')) and (dt_prim_hora_int_w not between dt_inicio_prescr_tes_w and (dt_prim_hora_int_w + qt_operacao_w)) then
								
								while(dt_prim_hora_int_w not between dt_inicio_prescr_tes_w and (dt_prim_hora_int_w + qt_operacao_w)) loop
									dt_prim_hora_int_w	:= dt_prim_hora_int_w + qt_operacao_w/24;
								end loop;
							end if;
						end if;
												
						hr_prim_horario_w	:= to_char(dt_prim_hora_int_w, 'hh24:mi');						
						
						SELECT * FROM Calcular_Horario_Prescricao(nr_prescricao_p, cd_intervalo_w, dt_primeiro_horario_w, dt_prim_hora_int_w, nr_horas_validade_w, cd_material_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w, 'N', ds_dose_diferenciada_w) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w;

						ds_horarios_w	:= ds_horarios_w || ds_horarios2_w;
						
						qt_dia_prim_hor_w	:= 0;
						if (hr_prim_horario_w <> '') and (hr_prim_horario_w <> '  :  ') and (hr_prim_horario_w < to_char(dt_inicio_prescr_tes_w,'hh24:mi')) then
							qt_dia_prim_hor_w	:= 1;
						end if;
					end if;
					
					
					if (ie_acm_w = 'S') and (ie_limp_prim_hor_acm_w = 'S') then
						hr_prim_horario_w := '';
					end if;
					
					update	prescr_material
					set 	ds_horarios		= ds_horarios_w,
							hr_prim_horario		= hr_prim_horario_w,
							qt_dia_prim_hor		= qt_dia_prim_hor_w
					where	(hr_prim_horario IS NOT NULL AND hr_prim_horario::text <> '')
					and		nr_sequencia		= nr_sequencia_w
					and		nr_prescricao 		= nr_prescricao_p;
					
				elsif (ie_regra_horarios_w = 'H1') then
					nr_ocorrencia_w	:= 0;
					hr_prim_hora_medic_w		:= obter_primeiro_horario(cd_intervalo_w,nr_prescricao_p,cd_material_w,ie_via_aplicacao_w);
				
					
					select	max(dt_inicio_prescr)
					into STRICT	dt_inicio_prescr_ww
					from	prescr_medica
					where	nr_prescricao	= nr_prescricao_p;
					
					if (to_char(dt_primeiro_horario_w,'hh24:mi:ss') < to_char(clock_timestamp(),'hh24:mi:ss')) then
						dt_inicio_prescr_ww := to_date(to_char(clock_timestamp() + interval '1 days','dd/mm/yyyy') || ' ' || to_char(dt_primeiro_horario_w,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
					else
						dt_inicio_prescr_ww := to_date(to_char(clock_timestamp(),'dd/mm/yyyy') || ' ' || to_char(dt_primeiro_horario_w,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
					end if;
					
					if (ie_agrupador_w in (1,16)) then
						begin
						
						if (somente_numero(nr_prescricoes_w) = 0) then
							nr_prescricoes_w	:= to_char(nr_prescricao_p);
						end if;
						
						if (ie_agrupador_w = 1) then				
							
							hr_prim_horario_interv_w	:= obter_prim_hor_medic_interv(nr_atendimento_w,nr_prescricoes_w,dt_inicio_prescr_ww, cd_material_w, cd_intervalo_w,null,'H',null, qt_dose_w);
							
						elsif (ie_agrupador_w = 16) then
							hr_prim_horario_interv_w	:= obter_prim_hor_leite_interv(nr_atendimento_w,nr_prescricoes_w,dt_inicio_prescr_ww, cd_material_w, cd_intervalo_w,null,'H',null, qt_dose_w);
						end if;					
						
						if (coalesce(hr_prim_horario_interv_w::text, '') = '') or (hr_prim_horario_interv_w < dt_inicio_prescr_ww) then
							hr_prim_hora_medic_w	:= hr_prim_hora_medic_w;
						else
							hr_prim_hora_medic_w	:= to_char(hr_prim_horario_interv_w,'hh24:mi');
						end if;
						
				
						end;
					end if;
					
					select	max(ie_operacao)
					into STRICT	ie_operacao_w
					from	intervalo_prescricao
					where	cd_intervalo	= cd_intervalo_w;

					if (ie_operacao_w in ('F','V')) then
						hr_prim_hora_medic_w	:= obter_primeiro_horario(cd_intervalo_w,nr_prescricao_p,cd_material_w,ie_via_aplicacao_w);
					end if;
					
					hr_prim_horario_w	:= hr_prim_hora_medic_w;
					
					update	prescr_material
					set	hr_prim_horario	= hr_prim_hora_medic_w
					where	nr_prescricao 	= nr_prescricao_p
					and	nr_sequencia	= nr_sequencia_w;
					
					dt_prim_hora_int_w 	:= to_date('30/12/1899 '|| hr_prim_horario_w ||':00','dd/mm/yyyy hh24:mi:ss');
					
					SELECT * FROM Calcular_Horario_Prescricao(nr_prescricao_p, cd_intervalo_w, dt_primeiro_horario_w, coalesce(dt_prim_hora_int_w,dt_primeiro_horario_w), nr_horas_validade_w, cd_material_w, coalesce(qt_hora_intervalo_w,0), coalesce(qt_min_intervalo_w,0), nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w, 'N', ds_dose_diferenciada_w) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w;

					ds_horarios_w	:= ds_horarios_w || ds_horarios2_w;
					
					
					if (ie_se_necessario_w = 'S') then
						select	coalesce(max(b.qt_se_necessario),0),
								coalesce(max(b.ie_mesmo_zerado),'N')
						into STRICT		nr_ocorrencia_w,
								ie_mesmo_zerado_w
						from		intervalo_prescricao a,
								intervalo_setor b
						where	a.cd_intervalo 		= b.cd_intervalo
						and		coalesce(b.cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w
						and		coalesce(b.cd_estab, cd_estabelecimento_w)			= cd_estabelecimento_w
						and		a.cd_intervalo 		= cd_intervalo_w
						and		((b.cd_material = cd_material_w) or (coalesce(b.cd_material::text, '') = ''))
						and		((b.ie_via_aplicacao = coalesce(ie_via_aplicacao_w,b.ie_via_aplicacao)) or (coalesce(b.ie_via_aplicacao::text, '') = ''))
						and		((b.cd_unidade_basica = coalesce(obter_unid_atend_setor_atual(nr_atendimento_w,cd_setor_atendimento_w,'UB'),b.cd_unidade_basica)) or (coalesce(b.cd_unidade_basica::text, '') = ''));

						if (coalesce(nr_ocorrencia_w,0) = 0) and (ie_mesmo_zerado_w = 'N') then
							select	coalesce(max(qt_se_necessario),1)
							into STRICT		nr_ocorrencia_w
							from		intervalo_prescricao
							where	cd_intervalo	= cd_intervalo_w;
						end if;

						ds_horarios_w	:= 'SN';

					elsif (ie_acm_w = 'S') then
						select	coalesce(max(b.qt_se_necessario),0),
								coalesce(max(b.ie_mesmo_zerado),'N')
						into STRICT		nr_ocorrencia_w,
								ie_mesmo_zerado_w
						from		intervalo_prescricao a,
								intervalo_setor b
						where	a.cd_intervalo 		= b.cd_intervalo
						and		coalesce(b.cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w
						and		coalesce(b.cd_estab, cd_estabelecimento_w)			= cd_estabelecimento_w
						and		a.cd_intervalo 		= cd_intervalo_w
						and		((b.cd_material = cd_material_w) or (coalesce(b.cd_material::text, '') = ''))
						and		((b.ie_via_aplicacao = coalesce(ie_via_aplicacao_w,b.ie_via_aplicacao)) or (coalesce(b.ie_via_aplicacao::text, '') = ''))
						and		((b.cd_unidade_basica = coalesce(obter_unid_atend_setor_atual(nr_atendimento_w,cd_setor_atendimento_w,'UB'),b.cd_unidade_basica)) or (coalesce(b.cd_unidade_basica::text, '') = ''));
						
						if (coalesce(nr_ocorrencia_w,0) = 0) and (ie_mesmo_zerado_w = 'N') then
					
							select	coalesce(max(qt_se_necessario),1)
							into STRICT	nr_ocorrencia_w
							from	intervalo_prescricao
							where	cd_intervalo	= cd_intervalo_w;
						end if;

						ds_horarios_w	:= 'ACM';
					end if;
					
					qt_dia_prim_hor_w	:= 0;
					if (hr_prim_horario_w <> '') and (hr_prim_horario_w <> '  :  ') and (hr_prim_horario_w < to_char(dt_inicio_prescr_ww,'hh24:mi')) then
						qt_dia_prim_hor_w	:= 1;
					end if;
					
					if (ie_reordenar_w = 'S') then
						ds_horarios_w	:= reordenar_horarios(dt_inicio_prescr_ww, trim(both ds_horarios_w));
					end if;
					
					if (ie_acm_w = 'S') then
						ds_horarios_w		:= 'ACM';
					end if;
					if (ie_se_necessario_w = 'S') then
						ds_horarios_w	:= 'SN';
					end if;
					
					update	prescr_material
					set 		nr_ocorrencia		= nr_ocorrencia_w,
							qt_total_dispensar	= qt_total_dispensar_w,
							qt_material			= coalesce(qt_material_w,1),
							ds_horarios			= ds_horarios_w,
							ie_regra_disp		= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END ,
							qt_dia_prim_hor		= qt_dia_prim_hor_w
					where	nr_prescricao 		= nr_prescricao_p
					and	nr_sequencia			= nr_sequencia_w
					and	(hr_prim_horario IS NOT NULL AND hr_prim_horario::text <> '');

					if (coalesce(ds_dose_diferenciada_w::text, '') = '') and (ie_operacao_w		in ('X', 'H')) and (ie_ajustar_qt_p 	= 'S') and (nr_horas_validade_w 	<> 24) and (ie_calcula_validade_w = 'N') then
						begin
						update	prescr_medica
						set	nr_horas_validade	= 24
						where	nr_prescricao		= nr_prescricao_p;
						
						
						if (ie_acm_w = 'S') then
							ds_horarios_w		:= 'ACM';
						end if;
						
						if (ie_se_necessario_w = 'S') then
							ds_horarios_w	:= 'SN';
						end if;
						
						update	prescr_material
						set 	hr_dose_especial	 = NULL,
							qt_dose_especial	 = NULL,
							nr_ocorrencia		= nr_ocorrencia_w,
							qt_total_dispensar	= qt_total_dispensar_w,
							qt_material		= coalesce(qt_material_w,1),
							ds_horarios		= ds_horarios_w,
							ie_regra_disp		= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END
						where	nr_prescricao 		= nr_prescricao_p
						and	nr_sequencia		= nr_sequencia_w;
						end;
					end if;
					
					ds_horarios_prim_w	:= ds_horarios_w;			
					
				elsif (ie_regra_horarios_w = 'HS') then

					select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
					into STRICT	ie_composto_w
					from	prescr_material where nr_prescricao	= nr_prescricao_original_p
					and	cd_material	<> cd_material_w
					and	nr_agrupamento	= nr_agrup_aux_w LIMIT 1;
					
					select	max(ds_horario)
					into STRICT	ds_horarios_aux_w
					from	rep_horario_hor_pac
					where	nr_atendimento	= nr_atendimento_w
					and	cd_material	= cd_material_w
					and	cd_intervalo	= cd_intervalo_w
					and	coalesce(ie_composto,ie_composto_w)	= ie_composto_w
					and	coalesce(dt_cancelamento::text, '') = ''
					and	((ie_via_aplicacao = ie_via_aplicacao_w) or (coalesce(ie_via_aplicacao_w::text, '') = ''))
					and	coalesce(qt_dose,qt_dose_w) = qt_dose_w;

					if (ds_horarios_aux_w IS NOT NULL AND ds_horarios_aux_w::text <> '') then
						ds_horarios_w	:= ds_horarios_aux_w;

						if (ie_acm_w = 'S') then
							ds_horarios_w	:= 'ACM';
						end if;
						if (ie_se_necessario_w = 'S') then
							ds_horarios_w	:= 'SN';
						end if;
					
						update	prescr_material
						set 	ds_horarios		= ds_horarios_w
						where	nr_prescricao 		= nr_prescricao_p
						and	nr_sequencia		= nr_sequencia_w
						and	(hr_prim_horario IS NOT NULL AND hr_prim_horario::text <> '');
					end if;
					
				elsif (ie_regra_horarios_w = 'HO') then
				
					if (ie_acm_w = 'S') then
						ds_horarios_w		:= 'ACM';
						ds_horarios_medico_w	:= 'ACM';
					end if;
					
					if (ie_se_necessario_w = 'S') then
						ds_horarios_w	:= 'SN';
						ds_horarios_medico_w	:= 'SN';
					end if;
					
					update	prescr_material
					set 	ds_horarios		= coalesce(ds_horarios_medico_w,ds_horarios_w)
					where	nr_prescricao 		= nr_prescricao_p
					and	nr_sequencia		= nr_sequencia_w
					and	(hr_prim_horario IS NOT NULL AND hr_prim_horario::text <> '');
				end if;
				
				select	dt_primeiro_horario
				into STRICT	dt_primeiro_horario_mae_w
				from	prescr_medica
				where	nr_prescricao = nr_prescricao_original_p;
				
				ds_horarios_prim_w	:= ds_horarios_w;
				
				if (to_char(dt_primeiro_horario_w,'hh24:mi') <> to_char(dt_primeiro_horario_mae_w,'hh24:mi')) and (coalesce(ie_elimina_hor_w,'S') = 'S') then
					if (ie_reordenar_w = 'S') then
						ds_horarios_w := reordenar_horarios_prescr(dt_inicio_prescr_tes_w, ds_horarios_w);
					end if;
					
					ie_minutos_w	:= 'S';
					if (position(':' in ds_horarios_w) = 0) then
						ie_minutos_w	:= 'N';
					end if;
					
					select	Eliminar_horarios_vigencia(ds_horarios_w, cd_intervalo_w, dt_inicio_prescr_tes_w, dt_inicio_prescr_tes_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_prescricao_p)
					into STRICT	ds_horarios_w
					;
					
					if (ie_minutos_w	= 'N') then
						ds_horarios_padr_w	:= trim(both ds_horarios_w);
						ds_horarios_w		:= '';
						while(ds_horarios_padr_w IS NOT NULL AND ds_horarios_padr_w::text <> '') loop
							select	position(':' in ds_horarios_padr_w)
							into STRICT	k
							;
				
							if (k > 1) and ((substr(ds_horarios_padr_w, 1, k -1) IS NOT NULL AND (substr(ds_horarios_padr_w, 1, k -1))::text <> '')) then
								ds_horarios_w		:= ds_horarios_w || substr(ds_horarios_padr_w, 1, k-1);
								ds_horarios_padr_w	:= substr(ds_horarios_padr_w, k + 3, 2000);
							elsif (ds_horarios_padr_w IS NOT NULL AND ds_horarios_padr_w::text <> '') then
								ds_horarios_w		:= ds_horarios_padr_w;
								ds_horarios_padr_w	:= '';
							end if;
						end loop;
					end if;
					
					if (ie_acm_w = 'S') then
						ds_horarios_w		:= 'ACM';
					end if;
					if (ie_se_necessario_w = 'S') then
						ds_horarios_w	:= 'SN';
					end if;
					
					update	prescr_material
					set 	ds_horarios		= ds_horarios_w
					where	nr_prescricao 		= nr_prescricao_p
					and	nr_sequencia		= nr_sequencia_w
					and	(hr_prim_horario IS NOT NULL AND hr_prim_horario::text <> '');
				end if;

				if (ie_regra_prim_horarios_w = 'B') then
					update	prescr_material
					set 	hr_prim_horario		 = NULL
					where	nr_prescricao 		= nr_prescricao_p
					and	nr_sequencia		= nr_sequencia_w
					and	(hr_prim_horario IS NOT NULL AND hr_prim_horario::text <> '');
				elsif (ie_regra_prim_horarios_w = 'P') and (ds_horarios_prim_w <> 'ACM') and (ds_horarios_prim_w <> 'SN') then
					
					ds_horarios_prim_w	:= trim(both ds_horarios_prim_w);

					if (position(' ' in ds_horarios_prim_w) = 0) then		
						ds_horarios_prim_w	:= ds_horarios_prim_w || ' ';
					end if;

					hr_prim_horario_w	:= substr(ds_horarios_prim_w,1,position(' ' in ds_horarios_prim_w) - 1);
					if (position(':' in hr_prim_horario_w) = 0) then
						hr_prim_horario_w	:= hr_prim_horario_w || ':00';
					end if;
		
					
					qt_dia_prim_hor_w	:= 0;
					if (hr_prim_horario_w <> '') and (hr_prim_horario_w <> '  :  ') and (hr_prim_horario_w < to_char(dt_inicio_prescr_tes_w,'hh24:mi')) then
						qt_dia_prim_hor_w	:= 1;
					end if;
					
					if (ie_acm_w = 'S') and (ie_limp_prim_hor_acm_w = 'S') then
						hr_prim_horario_w := '';
					end if;
					
					update	prescr_material
					set 	hr_prim_horario		= hr_prim_horario_w,
						qt_dia_prim_hor		= qt_dia_prim_hor_w
					where	nr_prescricao 		= nr_prescricao_p
					and	nr_sequencia		= nr_sequencia_w;
					--and	hr_prim_horario		is not null;
				end if;
				
			elsif (ie_regra_geral_w = '1H') then

				open c000;
				loop
				fetch c000 into
					ie_dias_util_medic_w,
					cd_material_w,
					nr_sequencia_w,
					qt_unitaria_w,
					qt_material_w,
					ds_horarios_w,
					nr_ocorrencia_w,
					qt_total_dispensar_w,
					nr_sequencia_diluicao_w,
					hr_prim_horario_w,
					ds_dose_diferenciada_w,
					nr_horas_validade_w,
					ie_operacao_w,
					qt_operacao_w,
					cd_intervalo_w,
					ie_via_aplicacao_w,
					cd_unidade_medida_dose_w,
					ie_agrupador_w,
					ie_se_necessario_w,
					ie_acm_w,
					qt_hora_intervalo_w,
					qt_min_intervalo_w,
					dt_inicio_prescr_ww,
					hr_inicio_prescr_w,
					qt_dose_ww,
					cd_grupo_material_w,
					cd_subgrupo_material_w,
					cd_classe_material_w;
				EXIT WHEN NOT FOUND; /* apply on c000 */
					begin				
					
					open C02;
					loop
					fetch C02 into	
						ie_copiar_w,
						ie_regra_geral_w,
						nr_seq_regra_w,
						cd_mat_aux_w,
						cd_intervalo_aux_w,
						ie_agora_aux_w,
						nr_seq_apres_w,
						ie_regra_dose_especial_w,
						ie_copiar_ccih_reprov_w;
					EXIT WHEN NOT FOUND; /* apply on C02 */
						ie_copiar_w				:= ie_copiar_w;
						ie_regra_geral_w		:= ie_regra_geral_w;
						nr_seq_regra_w			:= nr_seq_regra_w;
						ie_copiar_ccih_reprov_w	:= ie_copiar_ccih_reprov_w;
					end loop;
					close C02;
					
					if (ie_regra_geral_w	<> 'I') then
						open C03;
						loop
						fetch C03 into	
							ie_regra_prim_hor_w,
							ie_regra_horarios_w,
							ie_regra_prim_horarios_w,
							ie_elimina_hor_w,
							ie_reordenar_w;
						EXIT WHEN NOT FOUND; /* apply on C03 */
							ie_regra_prim_hor_w	:= ie_regra_prim_hor_w;
							ie_regra_horarios_w	:= ie_regra_horarios_w;
							ie_regra_prim_horarios_w := ie_regra_prim_horarios_w;
							ie_elimina_hor_w	:= ie_elimina_hor_w;
							ie_reordenar_w		:= ie_reordenar_w;
							
							if (ie_regra_horarios_w <> 'HS') then
								ie_regra_prim_hor_ant_w	:= ie_regra_prim_hor_w;
								ie_regra_horarios_ant_w	:= ie_regra_horarios_w;
								ie_regra_prim_horarios_ant_w := ie_regra_prim_horarios_w;
								ie_elimina_hor_ant_w	:= ie_elimina_hor_w;
								ie_reordenar_ant_w	:= ie_reordenar_w;
							end if;
						end loop;
						close C03;
					else
						hr_prim_horario_w	:= hr_prim_horario_aux_w;
						
					end if;
					
					
					
					ds_horarios_ww		:= ds_horarios_w;
					hr_prim_horario_ww	:= hr_prim_horario_w;
									
					if	((ie_calcula_validade_w = 'S' AND ie_regra_geral_w <> 'I') or (ie_regra_geral_w <> 'I')) and (ie_se_necessario_w <> 'S') then
						nr_ocorrencia_w	:= 0;
						hr_prim_hora_medic_w		:= obter_primeiro_horario(cd_intervalo_w,nr_prescricao_p,cd_material_w,ie_via_aplicacao_w);
						if (ie_regra_prim_hor_w = 'H') and (ie_agrupador_w in (1,16)) then
							begin
							
							if (somente_numero(nr_prescricoes_w) = 0) then
								nr_prescricoes_w	:= to_char(NR_PRESCRICAO_P);
							end if;
							
							if (ie_agrupador_w = 1) then
								hr_prim_horario_interv_w	:= obter_prim_hor_medic_interv(nr_atendimento_w,nr_prescricoes_w,dt_inicio_prescr_ww, cd_material_w, cd_intervalo_w,null,ie_regra_prim_hor_w,null, qt_dose_ww);
							elsif (ie_agrupador_w = 16) then
								hr_prim_horario_interv_w	:= obter_prim_hor_leite_interv(nr_atendimento_w,nr_prescricoes_w,dt_inicio_prescr_ww, cd_material_w, cd_intervalo_w,null,ie_regra_prim_hor_w,null, qt_dose_ww);
							end if;

							if (coalesce(hr_prim_horario_interv_w::text, '') = '') or
								(ie_regra_prim_hor_w = 'H' AND hr_prim_horario_interv_w < dt_inicio_prescr_ww) then
								hr_prim_hora_medic_w	:= hr_prim_hora_medic_w;							
							else
								hr_prim_hora_medic_w	:= to_char(hr_prim_horario_interv_w,'hh24:mi');							
							end if;
							end;
						end if;

						if (ie_operacao_w in ('F','V')) then
							hr_prim_hora_medic_w	:= obter_primeiro_horario(cd_intervalo_w,NR_PRESCRICAO_p,cd_material_w,ie_via_aplicacao_w);
						end if;
							
						if (ie_regra_geral_w <> 'I') then
							
							hr_prim_horario_w	:= hr_prim_hora_medic_w;
							if (ie_acm_w = 'S') and (ie_limp_prim_hor_acm_w = 'S') then
								hr_prim_horario_w := '';
							end if;
				
							update	prescr_material
							set	hr_prim_horario	= hr_prim_hora_medic_w
							where	nr_prescricao 	= nr_prescricao_p
							and	nr_sequencia	= nr_sequencia_w;
						end if;
						dt_prim_hora_int_w 	:= to_date(to_char(dt_prescricao_w,'dd/mm/yyyy')||' '|| hr_prim_horario_w ||':00','dd/mm/yyyy hh24:mi:ss');
						SELECT * FROM Calcular_Horario_Prescricao(nr_prescricao_p, cd_intervalo_w, dt_primeiro_horario_w, coalesce(dt_prim_hora_int_w,dt_primeiro_horario_w), nr_horas_validade_w, cd_material_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w, 'N', ds_dose_diferenciada_w) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios2_w;

						ds_horarios_w	:= ds_horarios_w || ds_horarios2_w;

						if (ie_se_necessario_w = 'S') then
							select	coalesce(max(b.qt_se_necessario),0),
									coalesce(max(b.ie_mesmo_zerado),'N')
							into STRICT		nr_ocorrencia_w,
									ie_mesmo_zerado_w
							from		intervalo_prescricao a,
									intervalo_setor b
							where	a.cd_intervalo 		= b.cd_intervalo
							and		coalesce(b.cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w
							and		coalesce(b.cd_estab, cd_estabelecimento_w)			= cd_estabelecimento_w
							and		a.cd_intervalo 		= cd_intervalo_w
							and		((b.cd_material = cd_material_w) or (coalesce(b.cd_material::text, '') = ''))
							and		((b.ie_via_aplicacao = coalesce(ie_via_aplicacao_w,b.ie_via_aplicacao)) or (coalesce(b.ie_via_aplicacao::text, '') = ''))
							and		((b.cd_unidade_basica = coalesce(obter_unid_atend_setor_atual(nr_atendimento_w,cd_setor_atendimento_w,'UB'),b.cd_unidade_basica)) or (coalesce(b.cd_unidade_basica::text, '') = ''));
							
							if (coalesce(nr_ocorrencia_w,0) = 0) and (ie_mesmo_zerado_w = 'N') then
						
								select	coalesce(max(qt_se_necessario),1)
								into STRICT	nr_ocorrencia_w
								from	intervalo_prescricao
								where	cd_intervalo	= cd_intervalo_w;
							end if;
							
							ds_horarios_w	:= 'SN';

						elsif (ie_acm_w = 'S') then
							select	coalesce(max(b.qt_se_necessario),0),
									coalesce(max(b.ie_mesmo_zerado),'N')
							into STRICT		nr_ocorrencia_w,
									ie_mesmo_zerado_w
							from		intervalo_prescricao a,
									intervalo_setor		 b
							where	a.cd_intervalo 		= b.cd_intervalo
							and		coalesce(b.cd_setor_atendimento,cd_setor_atendimento_w)	= cd_setor_atendimento_w
							and		coalesce(b.cd_estab, cd_estabelecimento_w)			= cd_estabelecimento_w
							and		a.cd_intervalo 		= cd_intervalo_w
							and		((b.cd_material = cd_material_w) or (coalesce(b.cd_material::text, '') = ''))
							and		((b.ie_via_aplicacao = coalesce(ie_via_aplicacao_w,b.ie_via_aplicacao)) or (coalesce(b.ie_via_aplicacao::text, '') = ''))
							and		((b.cd_unidade_basica = coalesce(obter_unid_atend_setor_atual(nr_atendimento_w,cd_setor_atendimento_w,'UB'),b.cd_unidade_basica)) or (coalesce(b.cd_unidade_basica::text, '') = ''));
							
							if (coalesce(nr_ocorrencia_w,0) = 0) and (ie_mesmo_zerado_w = 'N') then
						
								select	coalesce(max(qt_se_necessario),1)
								into STRICT	nr_ocorrencia_w
								from	intervalo_prescricao
								where	cd_intervalo	= cd_intervalo_w;
							end if;

							ds_horarios_w	:= 'ACM';
						end if;

					end if;

					if (ds_dose_diferenciada_w IS NOT NULL AND ds_dose_diferenciada_w::text <> '') then
						ds_dose_dif_w	:= ds_dose_diferenciada_w;
						qt_material_w	:= 0;
						while (ds_dose_dif_w IS NOT NULL AND ds_dose_dif_w::text <> '') LOOP
							begin
							i	:= position('-' in ds_dose_dif_w);
							if (i > 0) then
								qt_material_w		:= qt_material_w + somente_numero(substr(ds_dose_dif_w, 1, i-1));
								ds_dose_dif_w		:= substr(ds_dose_dif_w, i+1, 255);
							else
								qt_material_w		:= qt_material_w + somente_numero(ds_dose_dif_w);
								ds_dose_dif_w		:= '';
							end if;

							end;
						end loop;

						qt_material_w	:= obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida_dose_w,qt_material_w);
					end if;

					SELECT * FROM Obter_Quant_Dispensar(cd_estabelecimento_w, cd_material_w, nr_prescricao_p, nr_sequencia_w, cd_intervalo_w, ie_via_aplicacao_w, qt_unitaria_w, 0, nr_ocorrencia_w, ds_dose_diferenciada_w, ie_origem_inf_w, cd_unidade_medida_dose_w, 1, qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_w, qt_total_dispensar_w, ie_regra_disp_w, ds_erro_w;

					if (coalesce(hr_prim_horario_ww::text, '') = '') then
						ds_horarios_w	:= ds_horarios_ww;					
					end if;
					
					qt_dia_prim_hor_w	:= 0;
					if (hr_prim_horario_w <> '') and (hr_prim_horario_w <> '  :  ') and (hr_prim_horario_w < to_char(dt_inicio_prescr_ww,'hh24:mi')) then
						qt_dia_prim_hor_w	:= 1;
					end if;
					
					if (ie_reordenar_w = 'S') then
						ds_horarios_w	:= reordenar_horarios(dt_inicio_prescr_ww, trim(both ds_horarios_w));
					end if;
					
					if (ie_acm_w = 'S') then
						ds_horarios_w		:= 'ACM';
					end if;
					if (ie_se_necessario_w = 'S') then
						ds_horarios_w	:= 'SN';
					end if;
					update	prescr_material
					set 	nr_ocorrencia		= nr_ocorrencia_w,
						qt_total_dispensar	= qt_total_dispensar_w,
						qt_material		= coalesce(qt_material_w,1),
						ds_horarios		= ds_horarios_w,
						ie_regra_disp		= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END ,
						qt_dia_prim_hor		= qt_dia_prim_hor_w
					where	nr_prescricao 		= nr_prescricao_p
					and	nr_sequencia		= nr_sequencia_w
					and	(hr_prim_horario IS NOT NULL AND hr_prim_horario::text <> '');

					if (coalesce(ds_dose_diferenciada_w::text, '') = '') and (ie_operacao_w		in ('X', 'H')) and (ie_ajustar_qt_p 	= 'S') and (nr_horas_validade_w 	<> 24) and (ie_calcula_validade_w = 'N') then
						begin
						update	prescr_medica
						set	nr_horas_validade	= 24
						where	nr_prescricao		= nr_prescricao_p;
						
						
						if (ie_acm_w = 'S') then
							ds_horarios_w		:= 'ACM';
						end if;
						if (ie_se_necessario_w = 'S') then
							ds_horarios_w	:= 'SN';
						end if;
						
						update	prescr_material
						set 	hr_dose_especial	 = NULL,
							qt_dose_especial	 = NULL,
							nr_ocorrencia		= nr_ocorrencia_w,
							qt_total_dispensar	= qt_total_dispensar_w,
							qt_material		= coalesce(qt_material_w,1),
							ds_horarios		= ds_horarios_w,
							ie_regra_disp		= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END
						where	nr_prescricao 		= nr_prescricao_p
						and	nr_sequencia		= nr_sequencia_w;
						end;
					end if;
					
					begin
					CALL Ajustar_Prescr_Material(nr_prescricao_p,nr_sequencia_w);
					exception when others then
						ds_erro_w	:= sqlerrm;
					end;
					end;
				end loop;
				close c000;
			end if;
			
			if (ie_agrupador_w not in (3,7,9)) then
				
				/* 	Realizado uma nova consulta, pois no momento da copia com a regra de copia(1H) o sistema entrava no cursor C000(trazendo todas as informacoess da prescricao), em seguida entrava nesse tratamento, porem como
					havia entrado no cursor, algumas das variaveis ficavam com valores da ultima consulta do cursor, ficando valores diferentes(de outros medicamentos(nr_sequencia_novo_ww) dessa forma os valores da dispensacao eram gerados incorretamente.
				*/
				commit;
				
				Select	max(cd_material),
						coalesce(max(cd_intervalo),'XPTO'),
						max(ie_via_aplicacao),
						coalesce(max(qt_unitaria),0),
						coalesce(max(qt_dose_especial),0),
						coalesce(max(ds_horarios),''),
						max(ds_dose_diferenciada),
						max(cd_unidade_medida_dose),	
						coalesce(max(qt_material),0),
						coalesce(max(qt_total_dispensar),0),
						coalesce(max(ie_se_necessario),'N'),
						coalesce(max(ie_acm),'N')
				into STRICT	cd_material_novo_w,
						cd_intervalo_novo_w,
						ia_via_aplic_novo_w,
						qt_unitaria_novo_w,
						qt_dose_espe_novo_w,
						ds_horarios_novo_w,
						ds_dose_dif_novo_w,
						cd_unid_med_dose_novo_w,
						qt_material_novo_w,
						qt_total_disp_novo_w,
						ie_SN_novo_w,
						ie_acm_novo_w
				from	prescr_material
				where	nr_prescricao = nr_prescricao_p
				and		nr_sequencia  = nr_sequencia_novo_ww;
				
				nr_ocorre_novo_w := obter_ocorrencias_horarios_rep(replace(ds_horarios_novo_w,lpad(' ',qt_espacos_horarios_w),' '));
				
				if (nr_ocorre_novo_w = 0) then
					select	ceil(max(obter_ocorrencia_intervalo(cd_intervalo_novo_w, nr_horas_validade_w, 'O')))
					into STRICT	nr_ocorre_novo_w
					;
				end if;

				SELECT * FROM Obter_Quant_Dispensar(	cd_estabelecimento_w, cd_material_novo_w, nr_prescricao_p, nr_sequencia_novo_ww, cd_intervalo_novo_w, ia_via_aplic_novo_w, qt_unitaria_novo_w, coalesce(qt_dose_espe_novo_w,0), nr_ocorre_novo_w, ds_dose_dif_novo_w, ie_origem_inf_w, cd_unid_med_dose_novo_w, 1, qt_material_novo_w, qt_total_disp_novo_w, ie_regra_disp_w, ds_erro_w, ie_SN_novo_w, ie_acm_novo_w) INTO STRICT qt_material_novo_w, qt_total_disp_novo_w, ie_regra_disp_w, ds_erro_w;
				update	prescr_material
				set 	nr_ocorrencia		= nr_ocorre_novo_w,
						qt_total_dispensar	= qt_total_disp_novo_w,
						qt_material			= coalesce(qt_material_novo_w,1),
						ie_regra_disp		= CASE WHEN coalesce(ie_regra_disp,'X')='D' THEN  ie_regra_disp  ELSE ie_regra_disp_w END
				where	nr_prescricao 		= nr_prescricao_p
				and		nr_sequencia		= nr_sequencia_novo_ww;
				--and	hr_prim_horario		is not null;	 --vhkrausser - Atualizar todos os medicamentos. Ajuste de dispensacao.
				
				begin
				CALL Ajustar_Prescr_Material(nr_prescricao_p,nr_sequencia_novo_ww);
				exception when others then
					ds_erro_w	:= sqlerrm;
				end;
				
				if (ie_agrupador_w = 1) and (ie_copia_albumina_w = 'S') then
					CALL REP_copia_albumina(nr_prescricao_original_p, nr_prescricao_p, nr_sequencia_ww, nr_sequencia_novo_ww, nm_usuario_p);
				end if;	
				
				if (coalesce(Obter_Se_Solic_Mat(cd_material_w),'N') = 'S')	then
					CALL REP_copia_indicacao_solic(nr_prescricao_original_p, nr_prescricao_p, nr_sequencia_ww, nr_sequencia_novo_ww, nm_usuario_p);
				end if;	
					
			end if;
			
			if (ie_gerar_dil_setor_w = 'S') and (ie_gerar_diluicao_w in ('S','P')) and (var_copia_diluicao_w <> 'S') then
				CALL gerar_reconst_diluicao(nr_prescricao_p,nr_sequencia_novo_ww,'A');
				
				begin
					CALL Ajustar_Prescr_Material(nr_prescricao_p,nr_sequencia_novo_ww);
				exception when others then
					ds_erro_w	:= sqlerrm;
				end;
			else
				CALL REP_copia_diluente(nr_prescricao_original_p, nr_prescricao_p, nr_sequencia_ww, nm_usuario_p, nr_sequencia_novo_ww);
			end if;
			
			if (ie_gerar_diluicao_w = 'P') then
				CALL REP_copia_diluente(nr_prescricao_original_p, nr_prescricao_p, nr_sequencia_ww, nm_usuario_p, nr_sequencia_novo_ww);
			end if;
			
		else
			CALL grava_prescr_nao_copiados(nr_prescricao_p, nr_prescricao_original_p, nr_sequencia_orig_w, cd_material_w, null, null, null, null, 'N');
		end if;
	elsif (ie_apres_medic_nao_copia_w = 'S') then
		CALL grava_prescr_nao_copiados(nr_prescricao_p, nr_prescricao_original_p, nr_sequencia_orig_w, cd_material_w, ie_situacao_w, ie_suspenso_w, ie_prescricao_w, null);
	end if;

end loop;
close C01;

update	prescr_material
set 	ie_regra_disp		= 'N'
where	(nr_seq_origem_medic IS NOT NULL AND nr_seq_origem_medic::text <> '')
and		nr_prescricao 		= nr_prescricao_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rep_copia_medicamento ( nr_prescricao_p bigint, nr_seq_regra_p bigint, nr_prescricoes_p text, nr_prescricao_original_p bigint, ie_procedimento_p text, dt_prescricao_p timestamp, dt_primeiro_horario_p text, ie_ajustar_qt_p text, cd_perfil_p bigint, nr_seq_material_p bigint, nm_usuario_p text, cd_funcao_ativa_p bigint, cd_medic_posicionar_p INOUT bigint) FROM PUBLIC;

