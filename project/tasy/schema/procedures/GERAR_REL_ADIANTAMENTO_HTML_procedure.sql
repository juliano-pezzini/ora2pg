-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_rel_adiantamento_html (nm_usuario_p text, nm_quebra_1_p text, nm_quebra_2_p text, nm_quebra_3_p text, nm_quebra_4_p text, nm_quebra_5_p text, tipo_recebimento_lcb_p text, cd_pessoa_fisica_p text, cd_cgc_p text, dt_adiantamento_p text, ie_sem_classif_p text, de_p timestamp, ate_p timestamp, devolucao_p text, cheques_p text, dt_referencia_p text, nr_ordem_p bigint, grupo_produto_financeiro_p text, subgrupo_produto_financeiro_p text, produto_financeiro_p text ) AS $body$
DECLARE


ds_tit_quebra_1_w	    varchar(255);
cd_quebra_1_w		    varchar(20);
ds_quebra_1_w		    varchar(255);
ds_tit_quebra_2_w	    varchar(255);
cd_quebra_2_w		    varchar(20);
ds_quebra_2_w		    varchar(255);
ds_tit_quebra_3_w	    varchar(255);
cd_quebra_3_w		    varchar(20);
ds_quebra_3_w		    varchar(255);
ds_tit_quebra_4_w	    varchar(255);
cd_quebra_4_w		    varchar(20);
ds_quebra_4_w		    varchar(255);
ds_tit_quebra_5_w	    varchar(255);
cd_quebra_5_w		    varchar(20);
ds_quebra_5_w		    varchar(255);
ie_quebra_w			    bigint;
nm_quebra_w			    varchar(255);
ds_tit_quebra_w		    varchar(255);
cd_quebra_w			    varchar(20);
ds_quebra_w			    varchar(255);
C01				        integer;
resultado			    integer;
ds_select_w			    varchar(10000);
ds_where_w			    varchar(32000);
cd_tipo_recebimento_w   adiantamento.cd_tipo_recebimento%TYPE;
ds_tipo_recebimento_w   tipo_recebimento.ds_tipo_recebimento%TYPE;
cd_pessoa_fisica_w 	    adiantamento.cd_pessoa_fisica%TYPE;
cd_cgc_w 			    adiantamento.cd_cgc%TYPE;
dt_adiantamento_w	    adiantamento.dt_adiantamento%TYPE;
dt_baixa_w 			    adiantamento.dt_baixa%TYPE;
cd_banco_w 			    adiantamento.cd_banco%TYPE;
ds_prod_financ_w 	    varchar(254);
nr_adiantamento_w 	    adiantamento.nr_adiantamento%TYPE;
nr_atendimento_w 	    adiantamento.nr_atendimento%TYPE;
ds_moeda_w			    moeda.ds_moeda%TYPE;
nr_documento_w		    adiantamento.nr_documento%TYPE;
nm_usuario_w		    adiantamento.nm_usuario%TYPE;
vl_saldo_w			    adiantamento.vl_saldo%TYPE;
vl_adiantamento_w		adiantamento.vl_adiantamento%TYPE;
ds_filtro_w             varchar(4000);
nm_quebra_1_w           varchar(300);
nm_quebra_2_w           varchar(300);
nm_quebra_3_w           varchar(300);
nm_quebra_4_w           varchar(300);
nm_quebra_5_w           varchar(300);

BEGIN

    declare 
       type quebra_original is varray(5) of varchar(300);
       original quebra_original;
    begin 
       original := quebra_original(nm_quebra_1_p, nm_quebra_2_p, nm_quebra_3_p, nm_quebra_4_p, nm_quebra_5_p);

        for i in 1 .. original.count loop
            if original(i) != 'null' then
                if (coalesce(nm_quebra_1_w::text, '') = '') then
                    nm_quebra_1_w := original(i);
                elsif (coalesce(nm_quebra_2_w::text, '') = '') then
                    nm_quebra_2_w := original(i);
                elsif (coalesce(nm_quebra_3_w::text, '') = '') then
                    nm_quebra_3_w := original(i);
                elsif (coalesce(nm_quebra_4_w::text, '') = '') then
                    nm_quebra_4_w := original(i);
                else
                    nm_quebra_5_w := original(i);
                end if;
            end if;
        end loop;
    end;

    if (coalesce(nm_quebra_1_w::text, '') = '' and coalesce(nm_quebra_2_w::text, '') = '' and  coalesce(nm_quebra_3_w::text, '') = '' and coalesce(nm_quebra_4_w::text, '') = '' and coalesce(nm_quebra_5_w::text, '') = '') then
        nm_quebra_1_w := 'TIPO_RECEBIMENTO';
    end if;

    if (grupo_produto_financeiro_p IS NOT NULL AND grupo_produto_financeiro_p::text <> '') then
        ds_filtro_w := ' and OBTER_PROD_FINANC(A.NR_ADIANTAMENTO,'|| chr(39) || 'AD' || chr(39) || ', ' || chr(39) || 'G' || chr(39) || ') in (' || replace(grupo_produto_financeiro_p,'&',chr(39))|| ')';
    end if;

    if (subgrupo_produto_financeiro_p IS NOT NULL AND subgrupo_produto_financeiro_p::text <> '') then
        ds_filtro_w := ds_filtro_w || ' and OBTER_PROD_FINANC(A.NR_ADIANTAMENTO,'|| chr(39) || 'AD' || chr(39) || ', ' || chr(39) || 'S' || chr(39) || ') in (' || replace(subgrupo_produto_financeiro_p,'&',chr(39))|| ')';
    end if;

    if (produto_financeiro_p IS NOT NULL AND produto_financeiro_p::text <> '') then
        ds_filtro_w := ds_filtro_w || ' and OBTER_PROD_FINANC(A.NR_ADIANTAMENTO,'|| chr(39) || 'AD' || chr(39) || ', ' || chr(39) || 'P' || chr(39) || ') in (' || replace(produto_financeiro_p,'&',chr(39)) || ')';
    end if;

    delete	from	w_relat_adiant
    where	nm_usuario	= nm_usuario_p;

ds_select_w := 	' select a.cd_tipo_recebimento, ' || 
				' b.ds_tipo_recebimento, '||
				' a.cd_pessoa_fisica, '||
				' a.cd_cgc,	'||
				' a.dt_adiantamento, '||
				' a.dt_baixa,  '||
				' a.cd_banco,'||
				' substr(nvl(obter_desc_produto_financeiro(obter_prod_financ(a.nr_adiantamento,'||chr(39)|| 'AD'||chr(39) || ',' ||chr(39)|| 'P'||chr(39) || ')),'||chr(39)|| WHEB_MENSAGEM_PCK.get_texto(803850)||chr(39) || '),0,254) ds_prod_financ, '||
				' a.nr_adiantamento, '||
				' a.nr_atendimento, '||
				' c.ds_moeda, '||
				' a.nr_documento, '||
				' a.nm_usuario, ';
				
	if (dt_referencia_p = '2') then
				ds_select_w := ds_select_w || ' obter_saldo_adiantamento(a.nr_adiantamento, PKG_DATE_UTILS.start_of('||chr(39)||de_p||chr(39)||', '||chr(39)||'dd'||chr(39)||')) vl_saldo_adiant, ';
	else
				ds_select_w := ds_select_w || ' vl_saldo vl_saldo_adiant, ';
	end if;

    ds_select_w := ds_select_w || '	 a.vl_adiantamento, trunc(a.dt_adiantamento,'||chr(39)|| 'dd'||chr(39) || ') dt_adiant ' ||	
                                  ' from  adiantamento a, '||
                                  ' tipo_recebimento b, '||
                                  ' moeda c '||
                                  ' where a.cd_tipo_recebimento  = b.cd_tipo_recebimento '||
                                  ' and a.cd_moeda             = c.cd_moeda ';

    ds_where_w :=  ' and a.cd_estabelecimento   =' || obter_estabelecimento_ativo ||
    ' and obter_se_grupo_prod_perfil(obter_prod_financ(a.nr_adiantamento,'||chr(39)|| 'AD'||chr(39) || ',' ||chr(39)|| 'G'||chr(39) || '),null,' || obter_perfil_ativo || ',null) =' ||chr(39)|| 'S'||chr(39) ||
    ' and ((( ' || coalesce(tipo_recebimento_lcb_p, 0) || ' <> 0) and (a.cd_tipo_recebimento = ' || coalesce(tipo_recebimento_lcb_p, 0) || ' )) or ( ' || coalesce(tipo_recebimento_lcb_p, 0) || ' = 0)) '||
    ' and ((( ' || coalesce(cd_pessoa_fisica_p, 0) || '<> 0) and (a.cd_pessoa_fisica = ' || coalesce(cd_pessoa_fisica_p, 0) || ')) or (' || coalesce(cd_pessoa_fisica_p, 0) || '  = 0)) ' ||
    ' and ((( ' || coalesce(cd_cgc_p, 0) || ' <> 0) and (a.cd_cgc = ' || coalesce(cd_cgc_p, 0) ||' )) or ( '|| coalesce(cd_cgc_p, 0) ||'  =  0))' ||
    ' and ((( ' || chr(39)|| ie_sem_classif_p || chr(39)|| ' = ' ||chr(39)|| 'S'||chr(39) || ' ) and not exists ( select 1
                                                                                                                  from adiantamento_classif x
                                                                                                                  where x.nr_adiantamento = a.nr_adiantamento)) or ('|| chr(39)|| ie_sem_classif_p || chr(39)|| ' <> '||chr(39)|| 'S'||chr(39) || ' )) 
     and (( ' || dt_referencia_p|| ' = 0 and a.dt_adiantamento between PKG_DATE_UTILS.start_of('||chr(39)||de_p||chr(39)||', '||chr(39)||'dd'||chr(39)||') and fim_dia('||chr(39)||ate_p||chr(39)||')) or
          ( ' || dt_referencia_p || ' = 1 and a.dt_baixa between PKG_DATE_UTILS.start_of('||chr(39)||de_p||chr(39)||', '||chr(39)||'dd'||chr(39)||') and fim_dia('||chr(39)||ate_p||chr(39)||')) or
          ( ' || dt_referencia_p || ' > 1 ))
    and ((( '|| dt_referencia_p || ' = 2) and (( ' || dt_adiantamento_p ||' = 0 and obter_saldo_adiantamento(a.nr_adiantamento, PKG_DATE_UTILS.start_of('||chr(39)||de_p||chr(39)||', '||chr(39)||'dd'||chr(39)||')) = 0) or ( '|| dt_adiantamento_p|| ' = 1 and obter_saldo_adiantamento(a.nr_adiantamento, PKG_DATE_UTILS.start_of('||chr(39)||de_p||chr(39)||', '||chr(39)|| 'dd'||chr(39) || ')) <> 0)  OR ( ' || dt_adiantamento_p || ' = 2)))
    or ((' || dt_referencia_p  || ' = 0) and ((' || dt_adiantamento_p || ' = 0 and a.dt_baixa is not null and vl_saldo = 0 ) or ( ' || dt_adiantamento_p || ' = 1 and ((a.dt_baixa is null) or (a.dt_baixa is not null and vl_saldo <> 0))) or ( ' ||dt_adiantamento_p || ' = 2)))
    or (( ' || dt_referencia_p || ' = 1) and (( ' || dt_adiantamento_p || ' = 0 and a.dt_baixa is not null and vl_saldo = 0 ) or ( ' || dt_adiantamento_p || ' = 1 and ((a.dt_baixa is null) or (a.dt_baixa is not null and vl_saldo <> 0))) or ( ' || dt_adiantamento_p || ' = 2)))
    OR (( ' || dt_referencia_p || ' = 3) and obter_saldo_adiantamento(a.nr_adiantamento, fim_dia('||chr(39)||ate_p||chr(39)||')) <> 0 and a.dt_adiantamento between  PKG_DATE_UTILS.start_of('||chr(39)||de_p||chr(39)||', '||chr(39)||'dd'||chr(39)||') and fim_dia('||chr(39)||ate_p||chr(39)||')))
    and (( ' || cheques_p || '= 0) or (' || cheques_p || ' = 1 and exists(select   1
                               from     cheque_cr_v z,
                                        adiantamento_cheque_cr y
                               where    y.nr_adiantamento = a.nr_adiantamento
                               and      z.nr_seq_cheque = y.nr_seq_cheque
                               and      z.dt_deposito is not null
                               union
                               select   1
                               from     cheque_cr_v z
                               where    z.nr_adiantamento = a.nr_adiantamento
                               and      z.dt_deposito is not null)) or ( ' || cheques_p || ' = 2 and not exists(select   1
                               from     cheque_cr_v z,
                                        adiantamento_cheque_cr y
                               where    y.nr_adiantamento = a.nr_adiantamento
                               and      z.nr_seq_cheque = y.nr_seq_cheque
                               and      z.dt_deposito is not null
                               union
                               select   1
                               from     cheque_cr_v z
                               where    z.nr_adiantamento = a.nr_adiantamento
                               AND      z.dt_deposito IS NOT NULL)))
    and (( 	' || devolucao_p || ' = 0) or ( ' || devolucao_p || ' = 1 and exists (select 1 from adiantamento_dev y where y.nr_adiantamento = a.nr_adiantamento )) and (' || devolucao_p || ' = 2 and not exists (select 1 from adiantamento_dev y where y.nr_adiantamento = a.nr_adiantamento ))) ' || ds_filtro_w;

    ds_where_w :=  ds_where_w || ' order by ';

    ie_quebra_w	:= 1;

    while(ie_quebra_w	<= 5) loop
    begin
        if (ie_quebra_w = 1) then
            nm_quebra_w	:= nm_quebra_1_w;
        elsif (ie_quebra_w = 2) then
            nm_quebra_w	:= nm_quebra_2_w;
        elsif (ie_quebra_w = 3) then
            nm_quebra_w	:= nm_quebra_3_w;
        elsif (ie_quebra_w = 4) then
            nm_quebra_w	:= nm_quebra_4_w;
        elsif (ie_quebra_w = 5) then
            nm_quebra_w	:= nm_quebra_5_w;
        end if;

        if (nm_quebra_w	= 'TIPO_RECEBIMENTO') then
            ds_where_w :=  ds_where_w || ' a.cd_tipo_recebimento, ';
        elsif (nm_quebra_w	= 'DT_ADIANTAMENTO') and (nr_ordem_p <> 3) then
            ds_where_w :=  ds_where_w || ' DT_ADIANT , ';
        elsif (nm_quebra_w	= 'DT_BAIXA') and (nr_ordem_p <> 4) then
            ds_where_w :=  ds_where_w || ' A.DT_BAIXA, ';
        elsif (nm_quebra_w	= 'PRODUTO_FINANCEIRO') and (nr_ordem_p <> 4) then
            ds_where_w :=  ds_where_w || ' DS_PROD_FINANC, ';
        end if;

        ie_quebra_w	:= ie_quebra_w + 1;
    end;
    end loop;

    if ( nr_ordem_p = 0) then 
        ds_where_w :=  ds_where_w ||  ' A.NR_ADIANTAMENTO ';
    elsif ( nr_ordem_p = 1 ) then
        ds_where_w :=  ds_where_w ||  ' A.NR_ATENDIMENTO ';
    elsif ( nr_ordem_p = 2 ) then
        ds_where_w :=  ds_where_w ||  ' A.CD_PESSOA_FISICA, A.CD_CGC ';
    elsif ( nr_ordem_p = 3 ) then
        ds_where_w :=  ds_where_w ||  ' A.DT_ADIANTAMENTO ';
    elsif ( nr_ordem_p = 4 ) then
        ds_where_w :=  ds_where_w ||  ' A.DT_BAIXA ';
    elsif ( nr_ordem_p = 5 ) then
        ds_where_w :=  ds_where_w ||  ' obter_nome_pf_pj(a.cd_pessoa_fisica, a.cd_cgc) ';
    end if;

    c01 := dbms_sql.open_cursor;

    dbms_sql.parse(C01, ds_select_w||ds_where_w, dbms_sql.Native);
    dbms_sql.define_column(c01,1,cd_tipo_recebimento_w);
    dbms_sql.define_column(c01,2,ds_tipo_recebimento_w,50);
    dbms_sql.define_column(c01,3,cd_pessoa_fisica_w,10);
    dbms_sql.define_column(c01,4,cd_cgc_w,14);
    dbms_sql.define_column(c01,5,dt_adiantamento_w);
    dbms_sql.define_column(c01,6,dt_baixa_w);
    dbms_sql.define_column(c01,7,cd_banco_w);
    dbms_sql.define_column(c01,8,ds_prod_financ_w,254);
    dbms_sql.define_column(c01,9,nr_adiantamento_w);
    dbms_sql.define_column(c01,10,nr_atendimento_w);
    dbms_sql.define_column(c01,11,ds_moeda_w,30);
    dbms_sql.define_column(c01,12,nr_documento_w,100);
    dbms_sql.define_column(c01,13,nm_usuario_w,15);
    dbms_sql.define_column(c01,14,vl_saldo_w);
    dbms_sql.define_column(c01,15,vl_adiantamento_w);

    resultado := dbms_sql.execute(c01);

    while(dbms_sql.fetch_rows(c01) > 0) loop
        begin
        
            dbms_sql.column_value(c01, 1, cd_tipo_recebimento_w);
            dbms_sql.column_value(c01,2, ds_tipo_recebimento_w);
            dbms_sql.column_value(c01,3, cd_pessoa_fisica_w);
            dbms_sql.column_value(c01,4, cd_cgc_w);
            dbms_sql.column_value(c01,5, dt_adiantamento_w);
            dbms_sql.column_value(c01,6, dt_baixa_w);
            dbms_sql.column_value(c01,7,cd_banco_w);
            dbms_sql.column_value(c01,8,ds_prod_financ_w);
            dbms_sql.column_value(c01,9,nr_adiantamento_w);
            dbms_sql.column_value(c01,10,nr_atendimento_w);
            dbms_sql.column_value(c01,11,ds_moeda_w);
            dbms_sql.column_value(c01,12,nr_documento_w);
            dbms_sql.column_value(c01,13,nm_usuario_w);
            dbms_sql.column_value(c01,14, vl_saldo_w);
            dbms_sql.column_value(c01,15,vl_adiantamento_w);

            ie_quebra_w	:= 1;

        while(ie_quebra_w	<= 5) loop
            begin
            ds_tit_quebra_w	:= NULL;
            cd_quebra_w	:= NULL;
            ds_quebra_w	:= NULL;

            if (ie_quebra_w = 1) then
                nm_quebra_w	:= nm_quebra_1_w;
            elsif (ie_quebra_w = 2) then
                nm_quebra_w	:= nm_quebra_2_w;
            elsif (ie_quebra_w = 3) then
                nm_quebra_w	:= nm_quebra_3_w;
            elsif (ie_quebra_w = 4) then
                nm_quebra_w	:= nm_quebra_4_w;
            elsif (ie_quebra_w = 5) then
                nm_quebra_w	:= nm_quebra_5_w;
            end if;

            if (nm_quebra_w	= 'TIPO_RECEBIMENTO') then
                ds_tit_quebra_w := wheb_mensagem_pck.get_texto(389423);
                cd_quebra_w := CD_TIPO_RECEBIMENTO_W;
                ds_quebra_w := DS_TIPO_RECEBIMENTO_w;
            elsif (nm_quebra_w	= 'EMITENTE') then
                ds_tit_quebra_w := wheb_mensagem_pck.get_texto(415793);
                cd_quebra_w 	:= coalesce(cd_pessoa_fisica_w,cd_cgc_w);
                ds_quebra_w 	:= SUBSTR(obter_nome_pf_pj(cd_pessoa_fisica_w,cd_cgc_w),1,80);
            elsif (nm_quebra_w	= 'DT_ADIANTAMENTO') then
                ds_tit_quebra_w := wheb_mensagem_pck.get_texto(389422);
                cd_quebra_w := DT_ADIANTAMENTO_W;
                ds_quebra_w := DT_ADIANTAMENTO_W;
            elsif (nm_quebra_w	= 'DT_BAIXA') then
                ds_tit_quebra_w := wheb_mensagem_pck.get_texto(389424);
                if (DT_BAIXA_w IS NOT NULL AND DT_BAIXA_w::text <> '') then
                    cd_quebra_w := DT_BAIXA_w;
                    ds_quebra_w := DT_BAIXA_w;
                else
                    ds_quebra_w :=  WHEB_MENSAGEM_PCK.get_texto(803833);				
                    cd_quebra_w := 1;
                end if;
            elsif (nm_quebra_w	= 'PRODUTO_FINANCEIRO') then
                ds_tit_quebra_w := wheb_mensagem_pck.get_texto(389425);
                cd_quebra_w := DS_PROD_FINANC_W;
                ds_quebra_w := DS_PROD_FINANC_W;
            end if;

            if (ie_quebra_w = 1) then
                ds_tit_quebra_1_w	:= ds_tit_quebra_w;
                cd_quebra_1_w		:= cd_quebra_w;
                ds_quebra_1_w		:= ds_quebra_w;
            elsif (ie_quebra_w = 2) then
                ds_tit_quebra_2_w	:= ds_tit_quebra_w;
                cd_quebra_2_w		:= cd_quebra_w;
                ds_quebra_2_w		:= ds_quebra_w;
            elsif (ie_quebra_w = 3) then
                ds_tit_quebra_3_w	:= ds_tit_quebra_w;
                cd_quebra_3_w		:= cd_quebra_w;
                ds_quebra_3_w		:= ds_quebra_w;
            elsif (ie_quebra_w = 4) then
                ds_tit_quebra_4_w	:= ds_tit_quebra_w;
                cd_quebra_4_w		:= cd_quebra_w;
                ds_quebra_4_w		:= ds_quebra_w;
            elsif (ie_quebra_w = 5) then
                ds_tit_quebra_5_w	:= ds_tit_quebra_w;
                cd_quebra_5_w		:= cd_quebra_w;
                ds_quebra_5_w		:= ds_quebra_w;
            end if;

            ie_quebra_w	:= ie_quebra_w + 1;
            end;
        end loop;

            insert into w_relat_adiant(
            nr_sequencia,
            nm_usuario,
            dt_atualizacao,
            ds_tit_quebra_1,
            cd_quebra_1,
            ds_quebra_1,
            ds_tit_quebra_2,
            cd_quebra_2,
            ds_quebra_2,
            ds_tit_quebra_3,
            cd_quebra_3,
            ds_quebra_3,
            ds_tit_quebra_4,
            cd_quebra_4,
            ds_quebra_4,
            ds_tit_quebra_5,
            cd_quebra_5,
            ds_quebra_5,
            cd_pessoa_fisica,
            cd_cgc,
            ds_tipo_recebimento,
            nr_adiantamento,
            nr_atendimento,
            ds_moeda,
            dt_baixa,
            nr_documento,
            vl_saldo,
            dt_adiantamento,
            vl_adiantamento)
            values (
            nextval('w_relat_adiant_seq'),
            nm_usuario_p,
            clock_timestamp(),
            ds_tit_quebra_1_w,
            cd_quebra_1_w,
            ds_quebra_1_w,
            ds_tit_quebra_2_w,
            cd_quebra_2_w,
            ds_quebra_2_w,
            ds_tit_quebra_3_w,
            cd_quebra_3_w,
            ds_quebra_3_w,
            ds_tit_quebra_4_w,
            cd_quebra_4_w,
            ds_quebra_4_w,
            ds_tit_quebra_5_w,
            cd_quebra_5_w,
            ds_quebra_5_w,
            cd_pessoa_fisica_w,
            cd_cgc_w,
            ds_tipo_recebimento_w,
            nr_adiantamento_w,
            nr_atendimento_w,
            ds_moeda_w,
            dt_baixa_w,
            nr_documento_w,
            vl_saldo_w,
            dt_adiantamento_w,
            vl_adiantamento_w);

    end;
    end loop;

    dbms_sql.close_cursor(c01);

    commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_rel_adiantamento_html (nm_usuario_p text, nm_quebra_1_p text, nm_quebra_2_p text, nm_quebra_3_p text, nm_quebra_4_p text, nm_quebra_5_p text, tipo_recebimento_lcb_p text, cd_pessoa_fisica_p text, cd_cgc_p text, dt_adiantamento_p text, ie_sem_classif_p text, de_p timestamp, ate_p timestamp, devolucao_p text, cheques_p text, dt_referencia_p text, nr_ordem_p bigint, grupo_produto_financeiro_p text, subgrupo_produto_financeiro_p text, produto_financeiro_p text ) FROM PUBLIC;

