-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualiza_dt_comp_pagamento ( ds_chave_p text, dt_comp_pagto_p timestamp) AS $body$
DECLARE


/*
ds_chave_p é uma lista  separada por ponto e virgula, onde cada conjunto trás a nr_seq_conta uma virgula e a nr_sequencia
da pls_conta_medica_resumo.

ex:

12500,2;12501,1;12505,3

Nesse exemplo, tras 3 registros que terão a dt competência atualizada. O primeiro é
o registro cujo nr_seq_conta é 12500 e nr_sequencia é 2. O segundo o nr_seq_conta é
12501 e nr_sequencia é 1 e o terceiro a nr_seq_conta é 12505 e nr_sequencia é 3.

*/
nr_contador_w	integer;
nr_seq_conta_w	pls_conta_medica_resumo.nr_seq_conta%type;
nr_seq_w	pls_conta_medica_resumo.nr_sequencia%type;

C01 CURSOR(	ds_lista_p	text,
		ds_separador_p	text) FOR
	SELECT	ds_valor_vchr2
	from	table(pls_util_pck.converter_lista_valores(ds_lista_p, ds_separador_p));

C02 CURSOR(	ds_lista_p	text,
		ds_separador_p	text) FOR
	SELECT	nr_valor_number
	from	table(pls_util_pck.converter_lista_valores(ds_lista_p, ds_separador_p));

BEGIN

-- percorre para trazer os pares de valores nr_seq_conta e nr_sequencia da pls_conta_medica_resumo, separados por virgula
for r_C01_w in C01(ds_chave_p, ';') loop

	-- percorre para trazer valor antes da virgula para variavel referente a nr_seq_conta e
	--o valor após a virgula para variavel referente a nr_sequencia
	nr_contador_w := 0;
	for r_C02_w in C02(r_C01_w.ds_valor_vchr2, ',') loop
		-- Obtém o nr_seq_conta
		if (nr_contador_w = 0) then
			nr_seq_conta_w := r_C02_w.nr_valor_number;
		else
			nr_seq_w	:= r_C02_w.nr_valor_number;
		end if;

		nr_contador_w := nr_contador_w + 1;
	end loop;

	update	pls_conta_medica_resumo a
	set	dt_competencia_pgto = dt_comp_pagto_p
	where	nr_seq_conta = nr_seq_conta_w
	and	nr_sequencia = nr_seq_w;

end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualiza_dt_comp_pagamento ( ds_chave_p text, dt_comp_pagto_p timestamp) FROM PUBLIC;

