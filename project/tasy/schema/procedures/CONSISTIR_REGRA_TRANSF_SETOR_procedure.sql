-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_regra_transf_setor ( ie_tipo_mov_p text, cd_setor_origem_p bigint, cd_setor_destino_p bigint, nr_atendimento_p bigint, ds_retorno_p INOUT text) AS $body$
DECLARE



cd_estabelecimento_w	bigint 	:= wheb_usuario_pck.get_cd_estabelecimento;
cd_classif_setor_dest_w bigint 	:= obter_classif_setor(cd_setor_destino_p);
cd_classif_setor_orig_w	bigint 	:= Obter_classif_setor_atend(nr_atendimento_p);
ie_tipo_movimentacao_w	varchar(1);
nr_sequencia_w		bigint;
ds_setor_origem_w	varchar(255)	:= obter_nome_setor(cd_setor_origem_p);
ds_setor_destino_w	varchar(255)	:= obter_nome_setor(cd_setor_destino_p);
ie_tipo_atend_origem_w	smallint;
ds_mensagem_bloqueio_w				regra_transf_setor.ds_mensagem_bloqueio%type;

C01 CURSOR FOR

SELECT  nr_sequencia,
		ie_tipo_movimentacao,
		coalesce(ds_mensagem_bloqueio,' ')
from	regra_transf_setor
where	coalesce(cd_setor_destino, cd_setor_destino_p) 			= cd_setor_destino_p
and	coalesce(cd_setor_origem, cd_setor_origem_p)  			= cd_setor_origem_p
and	coalesce(cd_classif_setor_destino, cd_classif_setor_dest_w)		= cd_classif_setor_dest_w
and	coalesce(cd_classif_setor_origem, cd_classif_setor_orig_w) 		= cd_classif_setor_orig_w
and	coalesce(cd_estabelecimento,cd_estabelecimento_w) 			= cd_estabelecimento_w
and	coalesce(ie_tipo_atend_origem,ie_tipo_atend_origem_w)		= ie_tipo_atend_origem_w
and	((ie_tipo_movimentacao						= ie_tipo_mov_p) or (ie_tipo_movimentacao = 'A'))
and	coalesce(ie_permite,'S') = 'N'
and	ie_situacao = 'A'
and coalesce(cd_perfil_ativo,obter_perfil_ativo) = obter_perfil_ativo
order	by cd_setor_destino,
	   cd_setor_origem,
	   cd_classif_setor_destino,
	   cd_classif_setor_origem;


BEGIN

select	max(ie_tipo_atendimento)
into STRICT	ie_tipo_atend_origem_w
from	atendimento_paciente
where	nr_atendimento = nr_atendimento_p;

open C01;
loop
fetch C01 into
	nr_sequencia_w,
	ie_tipo_movimentacao_w,
	ds_mensagem_bloqueio_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	nr_sequencia_w := nr_sequencia_w;
	end;
end loop;
close C01;

if (nr_sequencia_w > 0) then

	if	((ie_tipo_movimentacao_w = 'P') or (ie_tipo_movimentacao_w = 'A') and (ie_tipo_mov_p = 'P')) then
			ds_retorno_p 	:= 	wheb_mensagem_pck.get_texto(403143, 'DS_SETOR_ORIGEM_W=' || ds_setor_origem_w || ';DS_SETOR_DESTINO_W=' || ds_setor_destino_w
								|| ';DS_MOTIVO_BLOQ_W=' || ds_mensagem_bloqueio_w);


	elsif	((ie_tipo_movimentacao_w = 'T') or (ie_tipo_movimentacao_w = 'A') and (ie_tipo_mov_p = 'T')) then
		ds_retorno_p	:=  wheb_mensagem_pck.get_texto(403171, 'DS_SETOR_ORIGEM_W=' || ds_setor_origem_w || ';DS_SETOR_DESTINO_W=' || ds_setor_destino_w
							|| ';DS_MOTIVO_BLOQ_W=' || ds_mensagem_bloqueio_w);
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_regra_transf_setor ( ie_tipo_mov_p text, cd_setor_origem_p bigint, cd_setor_destino_p bigint, nr_atendimento_p bigint, ds_retorno_p INOUT text) FROM PUBLIC;

