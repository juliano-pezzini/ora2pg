-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_vigencia_item_contrato (qt_meses_p bigint, nr_seq_contrato_p bigint, nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_contrato_nf_nova_w	contrato_regra_nf.nr_sequencia%type;
cd_estab_regra_w		contrato_regra_nf.cd_estab_regra%type;

BEGIN

for i in 1..qt_meses_p loop
	begin

	select	nextval('contrato_regra_nf_seq')
	into STRICT nr_seq_contrato_nf_nova_w
	;

	insert into contrato_regra_nf(
			nr_sequencia,
			cd_estab_regra,
			cd_material,
			nr_seq_equipamento,
			cd_conta_contabil,
			cd_centro_custo,
			nr_seq_conta_financ,
			nr_seq_proj_rec,
			nr_seq_marca,
			cd_local_estoque,
			nr_seq_crit_rateio,
			cd_natureza_operacao,
			cd_unidade_medida_compra,
			vl_pagto,
			pr_variacao_valor,
			qt_conversao_nf,
			ie_conversao_nf,
			vl_saldo_total,
			qt_material_fixa,
			ie_preco,
			ie_quantidade,
			qt_dias_entrega,
			dt_entrega,
			ie_permite_adiant,
			pr_permitido_adiant,
			nm_usuario,
			dt_atualizacao,
			dt_inicio_vigencia,
			dt_fim_vigencia,
			nr_seq_contrato,
			ds_observacao,
			ie_gera_sc_automatico,
			ie_libera_solic,
			vl_desconto,
			pr_desconto)
		SELECT	nr_seq_contrato_nf_nova_w,
			cd_estab_regra,
			cd_material,
			nr_seq_equipamento,
			cd_conta_contabil,
			cd_centro_custo,
			nr_seq_conta_financ,
			nr_seq_proj_rec,
			nr_seq_marca,
			cd_local_estoque,
			nr_seq_crit_rateio,
			cd_natureza_operacao,
			cd_unidade_medida_compra,
			vl_pagto,
			pr_variacao_valor,
			qt_conversao_nf,
			ie_conversao_nf,
			vl_saldo_total,
			qt_material_fixa,
			ie_preco,
			ie_quantidade,
			qt_dias_entrega,
			dt_entrega,
			ie_permite_adiant,
			pr_permitido_adiant,
			nm_usuario_p,
			clock_timestamp(),
			PKG_DATE_UTILS.start_of(PKG_DATE_UTILS.ADD_MONTH(coalesce(dt_fim_vigencia,clock_timestamp()),i, 0),'month', 0),			
			pkg_date_utils.start_of(pkg_date_utils.end_of(pkg_date_utils.add_month(coalesce(dt_fim_vigencia,clock_timestamp()),i,0), 'MONTH', 0), 'DD', 0),
			nr_seq_contrato,
			wheb_mensagem_pck.get_texto(361056,'NR_SEQ_VIGENCIA_W=' || nr_sequencia_p),
			'N',
			coalesce(ie_libera_solic,'S'),
			vl_desconto,
			pr_desconto
		from	contrato_regra_nf
		where	nr_sequencia = nr_sequencia_p
		and	nr_seq_contrato = nr_seq_contrato_p;

		select	max(cd_estab_regra)
		into STRICT	cd_estab_regra_w
		from	contrato_regra_nf
		where	nr_sequencia = nr_sequencia_p;
	
	if (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') and (coalesce(cd_estab_regra_w,0) > 0) then
		insert into contrato_regra_nf_estab(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_regra_nf,
			cd_estab_regra)
		SELECT	nextval('contrato_regra_nf_estab_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_contrato_nf_nova_w,
			cd_estab_regra
		from	contrato_regra_nf_estab
		where	nr_seq_regra_nf = nr_sequencia_p;
	end if;
	end;

end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_vigencia_item_contrato (qt_meses_p bigint, nr_seq_contrato_p bigint, nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

