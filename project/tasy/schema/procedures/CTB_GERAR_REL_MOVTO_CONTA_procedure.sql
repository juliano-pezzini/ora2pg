-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_rel_movto_conta ( cd_empresa_p bigint, cd_estab_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, ie_somente_dif_p text, cd_conta_contabil_p text, nm_usuario_p text) AS $body$
DECLARE


cd_conta_contabil_w			conta_contabil.cd_conta_contabil%type;
dt_inicial_w				timestamp;
dt_final_w				timestamp;
type registro is table of w_ctb_rel_movto_conta%RowType index by integer;
w_ctb_rel_movto_conta_w			registro;
i					integer	:= 0;
qt_commit_w				integer := 0;

c01 CURSOR FOR
SELECT	a.cd_conta_contabil,
	substr(ctb_obter_classif_conta(a.cd_conta_contabil, a.cd_classificacao, dt_inicial_w),1,40) cd_classificacao,
	a.ds_conta_contabil
from	conta_contabil a
where	a.cd_empresa		= cd_empresa_p
and	a.cd_conta_contabil	= coalesce(cd_conta_contabil_w, a.cd_conta_contabil)
and	a.ie_tipo		= 'A'
and	exists (	select	1
		from	ctb_mes_ref z,
			lote_contabil x,
			ctb_movimento y
		where	y.nr_lote_contabil	= x.nr_lote_contabil
		and	x.nr_seq_mes_ref	= z.nr_sequencia
		and	z.cd_empresa		= cd_empresa_p
		and	y.dt_movimento	between dt_inicial_w and dt_final_w);

vet01	c01%RowType;


BEGIN
dt_inicial_w		:= trunc(dt_inicial_p,'dd');
dt_final_w		:= fim_dia(dt_final_p);
cd_conta_contabil_w	:= cd_conta_contabil_p;
delete	FROM w_ctb_rel_movto_conta
where	nm_usuario	= nm_usuario_p;

commit;


open C01;
loop
fetch C01 into
	vet01;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	i := i + 1;
	select	nextval('w_ctb_rel_movto_conta_seq')
	into STRICT	w_ctb_rel_movto_conta_w[i].nr_sequencia
	;
	w_ctb_rel_movto_conta_w[i].nm_usuario		:= nm_usuario_p;
	w_ctb_rel_movto_conta_w[i].dt_atualizacao	:= clock_timestamp();
	w_ctb_rel_movto_conta_w[i].cd_conta_contabil	:= vet01.cd_conta_contabil;
	w_ctb_rel_movto_conta_w[i].cd_classificacao	:= vet01.cd_classificacao;
	w_ctb_rel_movto_conta_w[i].ds_informacao	:= vet01.ds_conta_contabil;

	select	coalesce(sum(a.vl_debito),0),
		coalesce(sum(a.vl_credito),0)
	into STRICT	w_ctb_rel_movto_conta_w[i].vl_total_deb_ger,
		w_ctb_rel_movto_conta_w[i].vl_total_cred_ger
	from	ctb_mes_ref c,
		lote_contabil b,
		movimento_contabil_v a
	where	a.nr_lote_contabil	= b.nr_lote_contabil
	and	b.nr_seq_mes_ref	= c.nr_sequencia
	and	c.cd_empresa		= cd_empresa_p
	and	a.cd_conta_contabil	= vet01.cd_conta_contabil
	and	a.dt_movimento between dt_inicial_w and dt_final_w;

	select	coalesce(sum(a.vl_debito),0),
		coalesce(sum(a.vl_credito),0)
	into STRICT	w_ctb_rel_movto_conta_w[i].vl_total_deb_ctb,
		w_ctb_rel_movto_conta_w[i].vl_total_cred_ctb
	from	ctb_mes_ref c,
		lote_contabil b,
		ctb_movimento_v a
	where	a.nr_lote_contabil	= b.nr_lote_contabil
	and	b.nr_seq_mes_ref	= c.nr_sequencia
	and	c.cd_empresa		= cd_empresa_p
	and	a.cd_conta_contabil	= vet01.cd_conta_contabil
	and	a.dt_movimento between dt_inicial_w and dt_final_w;

	w_ctb_rel_movto_conta_w[i].vl_dif_deb_ger_ctb	:= coalesce(w_ctb_rel_movto_conta_w[i].vl_total_deb_ctb - w_ctb_rel_movto_conta_w[i].vl_total_deb_ger,0);
	w_ctb_rel_movto_conta_w[i].vl_dif_cred_ger_ctb	:= coalesce(w_ctb_rel_movto_conta_w[i].vl_total_cred_ctb - w_ctb_rel_movto_conta_w[i].vl_total_cred_ger,0);

	if (ie_somente_dif_p = 'S') and (w_ctb_rel_movto_conta_w[i].vl_dif_deb_ger_ctb = 0) and (w_ctb_rel_movto_conta_w[i].vl_dif_cred_ger_ctb = 0) then
		w_ctb_rel_movto_conta_w.delete(i);
		i	:= i -1;
	end if;

	if (i>= 100) then

		forall i in w_ctb_rel_movto_conta_w.first..w_ctb_rel_movto_conta_w.last
			insert into w_ctb_rel_movto_conta values w_ctb_rel_movto_conta_w(i);

		commit;
		i	:= 0;
		w_ctb_rel_movto_conta_w.Delete;
	end if;
	end;
end loop;
close C01;

forall i in w_ctb_rel_movto_conta_w.First..w_ctb_rel_movto_conta_w.Last
	insert into w_ctb_rel_movto_conta values w_ctb_rel_movto_conta_w(i);

w_ctb_rel_movto_conta_w.delete;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_rel_movto_conta ( cd_empresa_p bigint, cd_estab_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, ie_somente_dif_p text, cd_conta_contabil_p text, nm_usuario_p text) FROM PUBLIC;

