-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_consistir_pessoa_lead ( nr_seq_solicitacao_p bigint, cd_cnpj_p text, cd_pf_vinculado_p text, dt_solicitacao_atual_p timestamp, cd_estabelecimento_p bigint, ds_erro_p INOUT text, dt_solicitacao_p INOUT text, nm_contato_p INOUT text, nr_telefone_p INOUT text, ds_status_p INOUT text, ds_canal_venda_p INOUT text, ie_acao_consistencia_p INOUT text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_canal_venda_w		bigint;
ds_erro_w			varchar(255);
ie_tipo_solicitante_w		varchar(10);
nr_seq_canal_venda_atual_w	bigint;
nr_seq_contrato_w		bigint;
ie_situacao_contrato_w		varchar(10);
ie_acao_consistencia_w		varchar(10);

C01 CURSOR FOR
	SELECT	nr_sequencia nr_seq_solicitacao,
		a.nm_contato,
		a.nr_telefone,
		substr(obter_valor_dominio(2461,a.ie_status),1,255) ds_status,
		a.dt_solicitacao,
		(	SELECT	max(nr_seq_vendedor_canal)
			from	pls_solicitacao_vendedor
			where	nr_seq_solicitacao	= a.nr_sequencia
			and	coalesce(dt_fim_vigencia::text, '') = '') nr_seq_canal_venda,
		a.ie_status
	from	pls_solicitacao_comercial a
	where	((a.cd_cnpj_vinculado = cd_cnpj_p) or (a.cd_cgc = cd_cnpj_p))
	and	a.nr_sequencia		<> nr_seq_solicitacao_p
	and	a.cd_estabelecimento	= cd_estabelecimento_p
	and	(cd_cnpj_p IS NOT NULL AND cd_cnpj_p::text <> '')
	
union all

	select	a.nr_sequencia nr_seq_solicitacao,
		a.nm_contato,
		a.nr_telefone,
		substr(obter_valor_dominio(2461,a.ie_status),1,255) ds_status,
		a.dt_solicitacao,
		(	select	max(nr_seq_vendedor_canal)
			from	pls_solicitacao_vendedor
			where	nr_seq_solicitacao	= a.nr_sequencia
			and	coalesce(dt_fim_vigencia::text, '') = '') nr_seq_canal_venda,
		a.ie_status
	from	pls_solicitacao_comercial a
	where	a.cd_pf_vinculado	= cd_pf_vinculado_p
	and	a.nr_sequencia		<> nr_seq_solicitacao_p
	and	a.cd_estabelecimento	= cd_estabelecimento_p
	and	(cd_pf_vinculado_p IS NOT NULL AND cd_pf_vinculado_p::text <> '');

C02 CURSOR(	dt_solicitacao_pc	pls_solicitacao_comercial.dt_solicitacao%type,
		ie_status_pc		pls_solicitacao_comercial.ie_status%type) FOR
	SELECT	ie_acao_consistencia
	from	pls_solic_regra_consist
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	ie_situacao		= 'A'
	and	((ie_tipo_pessoa_solic	= ie_tipo_solicitante_w) or (ie_tipo_pessoa_solic = 'A'))
	--Restringir status
	and	((ie_mesmo_canal_venda	= 'S'	and nr_seq_canal_venda_w = nr_seq_canal_venda_atual_w
						and (nr_seq_canal_venda_w IS NOT NULL AND nr_seq_canal_venda_w::text <> '') and (nr_seq_canal_venda_atual_w IS NOT NULL AND nr_seq_canal_venda_atual_w::text <> '')) or (ie_mesmo_canal_venda	= 'N'))
	and (coalesce(qt_dias_inicial,0) = 0 or dt_solicitacao_pc >= dt_solicitacao_atual_p+qt_dias_inicial)
	and (coalesce(qt_dias_final,0) = 0 or dt_solicitacao_pc <= dt_solicitacao_atual_p+qt_dias_final)
	and	((ie_situacao_contrato	= ie_situacao_contrato_w and (ie_situacao_contrato IS NOT NULL AND ie_situacao_contrato::text <> '')) or (coalesce(ie_situacao_contrato::text, '') = ''))
	and	((ie_status_lead = ie_status_pc and (ie_status_lead IS NOT NULL AND ie_status_lead::text <> '')) or (coalesce(ie_status_lead::text, '') = ''))
	order by coalesce(ie_situacao_contrato,'-1'),
		coalesce(qt_dias_inicial,0),
		coalesce(qt_dias_final,0),
		coalesce(ie_status_lead, ' ');
		--Ordenar status
BEGIN

if (cd_cnpj_p IS NOT NULL AND cd_cnpj_p::text <> '') then
	ie_tipo_solicitante_w	:= 'PJ';
elsif (cd_pf_vinculado_p IS NOT NULL AND cd_pf_vinculado_p::text <> '') then
	ie_tipo_solicitante_w	:= 'PF';
end if;

if (ie_tipo_solicitante_w = 'PJ') then
	select	max(nr_sequencia)
	into STRICT	nr_seq_contrato_w
	from	pls_contrato
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	cd_cgc_estipulante	= cd_cnpj_p;
elsif (ie_tipo_solicitante_w = 'PF') then
	select	max(nr_sequencia)
	into STRICT	nr_seq_contrato_w
	from	pls_contrato
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	cd_pf_estipulante	= cd_pf_vinculado_p;
end if;

if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then
	select	ie_situacao
	into STRICT	ie_situacao_contrato_w
	from	pls_contrato
	where	nr_sequencia	= nr_seq_contrato_w;
end if;

select	max(nr_seq_vendedor_canal)
into STRICT	nr_seq_canal_venda_atual_w
from	pls_solicitacao_vendedor
where	nr_seq_solicitacao	= nr_seq_solicitacao_p
and	coalesce(dt_fim_vigencia::text, '') = '';
	
for r_c01_w in C01 loop
	begin
	nr_seq_canal_venda_w	:= r_c01_w.nr_seq_canal_venda;
	
	dt_solicitacao_p	:= wheb_mensagem_pck.get_texto(281071, 'DT_SOLICITACAO_P=' || to_char(r_c01_w.dt_solicitacao,'dd/mm/yyyy'));
	nm_contato_p		:= wheb_mensagem_pck.get_texto(281073, 'NM_CONTATO_P=' || r_c01_w.nm_contato );
	nr_telefone_p		:= wheb_mensagem_pck.get_texto(281076, 'NR_TELEFONE_P=' || r_c01_w.nr_telefone );
	ds_status_p		:= wheb_mensagem_pck.get_texto(281078, 'DS_STATUS_P=' || r_c01_w.ds_status );

	if (nr_seq_canal_venda_w IS NOT NULL AND nr_seq_canal_venda_w::text <> '') then
		ds_canal_venda_p	:= wheb_mensagem_pck.get_texto(281081, 'NR_SEQ_CANAL_VENDA_P=' || substr(pls_obter_dados_vendedor(nr_seq_canal_venda_w,'N'),1,255));
	end if;
	
	for r_c02_w in C02(r_c01_w.dt_solicitacao, r_c01_w.ie_status) loop
		begin
		if (r_c02_w.ie_acao_consistencia IS NOT NULL AND r_c02_w.ie_acao_consistencia::text <> '') then
			ie_acao_consistencia_w	:= r_c02_w.ie_acao_consistencia;
			
			if (ie_tipo_solicitante_w = 'PJ') then
				ds_erro_w	:= wheb_mensagem_pck.get_texto(281068, 'CD_CNPJ_VINCULADO_P=' || cd_cnpj_p);
			elsif (ie_tipo_solicitante_w = 'PF') then
				ds_erro_w	:= wheb_mensagem_pck.get_texto(281070, 'CD_PF_VINCULADO_P=' || cd_pf_vinculado_p);
			end if;
			
			exit;
		end if;
		end;
	end loop; --C02
	
	if (ie_acao_consistencia_w IS NOT NULL AND ie_acao_consistencia_w::text <> '') then
		exit;
	end if;
	end;
end loop; --C01
if (ie_acao_consistencia_w IS NOT NULL AND ie_acao_consistencia_w::text <> '') then
	ie_acao_consistencia_p	:= ie_acao_consistencia_w;
	ds_erro_p		:= ds_erro_w;
else
	ie_acao_consistencia_p	:= 'N';
	ds_erro_p		:= '';
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_consistir_pessoa_lead ( nr_seq_solicitacao_p bigint, cd_cnpj_p text, cd_pf_vinculado_p text, dt_solicitacao_atual_p timestamp, cd_estabelecimento_p bigint, ds_erro_p INOUT text, dt_solicitacao_p INOUT text, nm_contato_p INOUT text, nr_telefone_p INOUT text, ds_status_p INOUT text, ds_canal_venda_p INOUT text, ie_acao_consistencia_p INOUT text, nm_usuario_p text) FROM PUBLIC;

