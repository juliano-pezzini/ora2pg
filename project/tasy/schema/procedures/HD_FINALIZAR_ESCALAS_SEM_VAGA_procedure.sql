-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hd_finalizar_escalas_sem_vaga ( cd_pessoa_fisica_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_escalas_w		varchar(2000);
ds_codigo_temp_w	varchar(2000);
ds_codigo_aux_w		varchar(2);

k			smallint;
i			smallint;


BEGIN
if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then

	ds_escalas_w := HD_obter_se_existe_vaga(cd_pessoa_fisica_p, cd_estabelecimento_p);

	if (ds_escalas_w IS NOT NULL AND ds_escalas_w::text <> '') then

		k := 1;
		for i in k..length(ds_escalas_w) loop
			begin

			ds_codigo_aux_w	:= substr(ds_escalas_w,i,1);

			if (ds_codigo_aux_w = ',') then

				update	hd_escala_dialise_dia a
				set	a.dt_fim_escala_dia	= clock_timestamp(),
					a.dt_atualizacao	= clock_timestamp(),
					a.nm_usuario		= nm_usuario_p
				where	a.nr_sequencia		= ds_codigo_temp_w
				and	coalesce(a.dt_fim_escala_dia::text, '') = '';

				ds_codigo_temp_w := '';
			else
				ds_codigo_temp_w := ds_codigo_temp_w||ds_codigo_aux_w;
			end if;
			end;
		end loop;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hd_finalizar_escalas_sem_vaga ( cd_pessoa_fisica_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

