-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_verifica_tempo_aud_req ( nm_usuario_p text) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Verificar requisicoes que estao em auditoria e exib
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  ]  Objetos do dicionario [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao: Performance.
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ie_entrou_regra_w		varchar(1);
qt_dias_vencidos_w		bigint;
dt_vencimento_w			timestamp;

cd_area_proc_req_w		estrutura_procedimento_v.cd_area_procedimento%type;
cd_espec_proc_req_w		estrutura_procedimento_v.cd_especialidade%type;
cd_grupo_proc_req_w		estrutura_procedimento_v.cd_grupo_proc%type;

ie_origem_w			procedimento.ie_origem_proced%type;

ie_dut_w			pls_rol_grupo_proc.ie_diretriz_utilizacao%type;
ie_pac_w			pls_rol_grupo_proc.ie_complexidade%type;

nr_seq_prazo_auditoria_w	pls_regra_prazo_auditoria.nr_sequencia%type;
qt_dias_alerta_w		pls_regra_prazo_auditoria.qt_dias_alerta%type;

ie_prioridade_w			pls_prioridade_analise_aut.ie_prioridade%type;
nr_seq_regra_prior_w		pls_prioridade_analise_aut.nr_sequencia%type;

ie_consid_prioridade_man_w	pls_param_analise_aut.ie_consid_prioridade_man%type;

type regras_w is table of bigint index by integer;
tab_regras_w			regras_w;
nr_indice_regra_w		bigint := 0;
ie_regra_aplicada_w		varchar(1);

C01 CURSOR FOR
	SELECT	nr_sequencia,
		dt_requisicao,
		ie_tipo_guia,
		ie_carater_atendimento,
		cd_especialidade,
		cd_estabelecimento
	from	pls_requisicao
	where	coalesce(dt_fim_processo_req::text, '') = ''
	and	ie_estagio		in (4,5);

C02 CURSOR(nr_seq_requisicao_pc bigint) FOR
	SELECT	cd_procedimento,
		ie_origem_proced
	from	pls_requisicao_proc
	where	nr_seq_requisicao	= nr_seq_requisicao_pc;

C10 CURSOR(	ie_tipo_guia_pc 		pls_requisicao.ie_tipo_guia%type,
		ie_carater_atendimento_pc 	pls_requisicao.ie_carater_atendimento%type,
		cd_area_proc_req_pc		estrutura_procedimento_v.cd_area_procedimento%type,
		cd_espec_proc_req_pc		estrutura_procedimento_v.cd_especialidade%type,
		cd_grupo_proc_req_pc		estrutura_procedimento_v.cd_grupo_proc%type,
		cd_procedimento_pc		pls_requisicao_proc.cd_procedimento%type,
		ie_origem_proced_pc		pls_requisicao_proc.ie_origem_proced%type,
		cd_especialidade_pc		pls_requisicao.cd_especialidade%type,
		ie_dut_pc			pls_rol_grupo_proc.ie_diretriz_utilizacao%type,
		ie_pac_pc			pls_rol_grupo_proc.ie_complexidade%type
		) FOR
	SELECT	nr_sequencia
	from	pls_regra_prazo_auditoria
	where	ie_situacao	= 'A'
	and (coalesce(cd_estabelecimento, wheb_usuario_pck.get_cd_estabelecimento) 	= wheb_usuario_pck.get_cd_estabelecimento)
	and	((coalesce(ie_tipo_guia::text, '') = '') 		or (ie_tipo_guia		= ie_tipo_guia_pc))
	and	((coalesce(ie_carater_internacao::text, '') = '') 	or (ie_carater_internacao	= ie_carater_atendimento_pc))
	and	((coalesce(cd_area_procedimento::text, '') = '') 	or (cd_area_procedimento	= cd_area_proc_req_pc))
	and	((coalesce(cd_especialidade::text, '') = '') 		or (cd_especialidade 		= cd_espec_proc_req_pc))
	and	((coalesce(cd_grupo_proc::text, '') = '') 		or (cd_grupo_proc		= cd_grupo_proc_req_pc))
	and	((coalesce(cd_procedimento::text, '') = '') 		or (cd_procedimento 		= cd_procedimento_pc AND ie_origem_proced		= ie_origem_proced_pc))
	and	((coalesce(nr_seq_grupo_servico::text, '') = '')		or (pls_se_grupo_preco_servico(	nr_seq_grupo_servico, cd_procedimento_pc, ie_origem_proced_pc) 	= 'S'))
	and	((coalesce(cd_espec_medica::text, '') = '')		or (cd_espec_medica		= cd_especialidade_pc))
	and	((coalesce(ie_diretriz_utilizacao::text, '') = '') 	or (ie_diretriz_utilizacao 	= coalesce(ie_dut_pc,'N')))
	and	((coalesce(ie_complexidade::text, '') = '')		or (ie_complexidade 		= coalesce(ie_pac_pc,'N')))
	and	((coalesce(ie_funcao_regra::text, '') = '')		or (ie_funcao_regra		= 'AU'))
	order by qt_dias_alerta desc;
	
C11 CURSOR(	ie_tipo_guia_pc 		pls_requisicao.ie_tipo_guia%type,
		ie_carater_atendimento_pc 	pls_requisicao.ie_carater_atendimento%type,
		cd_area_proc_req_pc		estrutura_procedimento_v.cd_area_procedimento%type,
		cd_espec_proc_req_pc		estrutura_procedimento_v.cd_especialidade%type,
		cd_grupo_proc_req_pc		estrutura_procedimento_v.cd_grupo_proc%type,
		cd_procedimento_pc		pls_requisicao_proc.cd_procedimento%type,
		ie_origem_proced_pc		pls_requisicao_proc.ie_origem_proced%type,
		cd_especialidade_pc		pls_requisicao.cd_especialidade%type,
		ie_dut_pc			pls_rol_grupo_proc.ie_diretriz_utilizacao%type,
		ie_pac_pc			pls_rol_grupo_proc.ie_complexidade%type
		) FOR
	SELECT	nr_sequencia
	from	pls_regra_prazo_auditoria
	where	ie_situacao	= 'A'
	and	((coalesce(ie_tipo_guia::text, '') = '') 		or (ie_tipo_guia		= ie_tipo_guia_pc))
	and	((coalesce(ie_carater_internacao::text, '') = '') 	or (ie_carater_internacao	= ie_carater_atendimento_pc))
	and	((coalesce(cd_area_procedimento::text, '') = '') 	or (cd_area_procedimento	= cd_area_proc_req_pc))
	and	((coalesce(cd_especialidade::text, '') = '') 		or (cd_especialidade 		= cd_espec_proc_req_pc))
	and	((coalesce(cd_grupo_proc::text, '') = '') 		or (cd_grupo_proc		= cd_grupo_proc_req_pc))
	and	((coalesce(cd_procedimento::text, '') = '') 		or (cd_procedimento 		= cd_procedimento_pc AND ie_origem_proced		= ie_origem_proced_pc))
	and	((coalesce(nr_seq_grupo_servico::text, '') = '')		or (pls_se_grupo_preco_servico(	nr_seq_grupo_servico, cd_procedimento_pc, ie_origem_proced_pc) 	= 'S'))
	and	((coalesce(cd_espec_medica::text, '') = '')		or (cd_espec_medica		= cd_especialidade_pc))
	and	((coalesce(ie_diretriz_utilizacao::text, '') = '') 	or (ie_diretriz_utilizacao 	= coalesce(ie_dut_pc,'N')))
	and	((coalesce(ie_complexidade::text, '') = '')		or (ie_complexidade 		= coalesce(ie_pac_pc,'N')))
	and	((coalesce(ie_funcao_regra::text, '') = '')		or (ie_funcao_regra		= 'AU'))
	order by qt_dias_alerta desc;
	
C12 CURSOR(nr_seq_requisicao_pc bigint) FOR
	SELECT	nr_sequencia,
			coalesce(ie_prioridade_manual, 'N') ie_prioridade_manual
	from	pls_auditoria
	where	nr_seq_requisicao	= nr_seq_requisicao_pc;

BEGIN

select	coalesce(max(ie_consid_prioridade_man), 'N')
into STRICT		ie_consid_prioridade_man_w
from		pls_param_analise_aut
where	((pls_obter_se_controle_estab('RE') = 'S') and (cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento)
or (pls_obter_se_controle_estab('RE') = 'N'));

for r_C01_w in C01 loop
	begin	
	ie_entrou_regra_w	:= 'N';
	tab_regras_w.delete;
	nr_indice_regra_w := 0;
	
	for r_C12_w in C12(r_C01_w.nr_sequencia) loop
		begin
		
		if (ie_consid_prioridade_man_w = 'S' and r_C12_w.ie_prioridade_manual = 'S') then
			ie_entrou_regra_w	:= 'N';
		else

			for r_C02_w in C02(r_C01_w.nr_sequencia) loop
				begin
				nr_seq_prazo_auditoria_w	:= null;
				
				SELECT * FROM pls_obter_estrut_proc(	r_C02_w.cd_procedimento, r_C02_w.ie_origem_proced, cd_area_proc_req_w, cd_espec_proc_req_w, cd_grupo_proc_req_w, ie_origem_w) INTO STRICT cd_area_proc_req_w, cd_espec_proc_req_w, cd_grupo_proc_req_w, ie_origem_w;
							
				ie_dut_w	:= pls_obter_dados_grupo_rol(r_C02_w.cd_procedimento, r_C02_w.ie_origem_proced, 'DUT');
				ie_pac_w	:= pls_obter_dados_grupo_rol(r_C02_w.cd_procedimento, r_C02_w.ie_origem_proced, 'PAC');
				
				if (pls_obter_se_controle_estab('RE') = 'S') then
					for r_C10_w in C10(	r_C01_w.ie_tipo_guia, r_C01_w.ie_carater_atendimento, cd_area_proc_req_w,
								cd_espec_proc_req_w, cd_grupo_proc_req_w, r_C02_w.cd_procedimento,
								r_C02_w.ie_origem_proced, r_C01_w.cd_especialidade, coalesce(ie_dut_w,'N'),
								coalesce(ie_pac_w,'N')) loop
						begin
						nr_seq_prazo_auditoria_w	:= r_C10_w.nr_sequencia;
						end;
					end loop;
				else
					for r_C11_w in C11(	r_C01_w.ie_tipo_guia, r_C01_w.ie_carater_atendimento, cd_area_proc_req_w,
								cd_espec_proc_req_w, cd_grupo_proc_req_w, r_C02_w.cd_procedimento,
								r_C02_w.ie_origem_proced, r_C01_w.cd_especialidade, coalesce(ie_dut_w,'N'),
								coalesce(ie_pac_w,'N')) loop
						begin
						nr_seq_prazo_auditoria_w	:= r_C11_w.nr_sequencia;
						end;
					end loop;
				end if;
				
				if (nr_seq_prazo_auditoria_w IS NOT NULL AND nr_seq_prazo_auditoria_w::text <> '') then
					ie_regra_aplicada_w := 'N';
					if (nr_indice_regra_w >= 1) then
						for i in tab_regras_w.first .. tab_regras_w.last loop
							if (nr_seq_prazo_auditoria_w = tab_regras_w(i)) then
								ie_regra_aplicada_w := 'S';
								exit;
							else
								ie_regra_aplicada_w := 'N';
							end if;
						end loop;
					end if;
					if (ie_regra_aplicada_w = 'N') then
						select	qt_dias_alerta
						into STRICT	qt_dias_alerta_w
						from	pls_regra_prazo_auditoria
						where	nr_sequencia	= nr_seq_prazo_auditoria_w;
						
						ie_entrou_regra_w	:= 'S';	
						
						dt_vencimento_w := pls_obter_data_dias_uteis(trunc(r_C01_w.dt_requisicao), qt_dias_alerta_w, wheb_usuario_pck.get_cd_estabelecimento);

						if (dt_vencimento_w >= clock_timestamp()) then
							qt_dias_vencidos_w	:= null;
						else
							qt_dias_vencidos_w := pls_obter_dias_uteis_periodo(trunc(dt_vencimento_w), trunc(clock_timestamp()));
						end if;
						
						if (ie_entrou_regra_w	= 'S') then

							select	max(nr_sequencia)
							into STRICT	nr_seq_regra_prior_w
							from	pls_prioridade_analise_aut
							where	ie_situacao		= 'A'
							and	ie_aplicacao_regra	= 'A';

							if (nr_seq_regra_prior_w IS NOT NULL AND nr_seq_regra_prior_w::text <> '') then
								select	ie_prioridade
								into STRICT	ie_prioridade_w
								from	pls_prioridade_analise_aut
								where	nr_sequencia	= nr_seq_regra_prior_w;
							end if;

							update	pls_auditoria
							set	qt_dias_vencidos 		= qt_dias_vencidos_w,
								dt_vencimento			= trunc(dt_vencimento_w),
								ie_prioridade			= ie_prioridade_w,
								nr_seq_prioridade_analise	= nr_seq_regra_prior_w,
								nm_usuario			= nm_usuario_p,
								dt_atualizacao			= clock_timestamp()
							where	nr_seq_requisicao 	= r_C01_w.nr_sequencia
							and		nr_sequencia		= r_C12_w.nr_sequencia;
							
							CALL pls_requisicao_gravar_hist(	r_C01_w.nr_sequencia, 'L',
											wheb_mensagem_pck.get_texto(1130031,'NR_SEQ_PRAZO_AUDITORIA=' || nr_seq_prazo_auditoria_w),
											'',nm_usuario_p);
											
							tab_regras_w(nr_indice_regra_w) := nr_seq_prazo_auditoria_w;
							nr_indice_regra_w := nr_indice_regra_w + 1;
							
							commit;
							ie_entrou_regra_w := 'N';
						end if;			
					end if;		
				end if;
				end;
			end loop; -- r_C02_w
		end if;
		end;
	end loop; -- r_C12_w
	end;
end loop; -- r_C01_w
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_verifica_tempo_aud_req ( nm_usuario_p text) FROM PUBLIC;

