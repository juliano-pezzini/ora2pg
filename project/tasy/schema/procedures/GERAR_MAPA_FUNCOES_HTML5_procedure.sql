-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_mapa_funcoes_html5 (dt_referencia_p timestamp default clock_timestamp()) AS $body$
DECLARE



nr_seq_proj_equipe_w		proj_equipe.nr_sequencia%type;
nr_seq_resumo_html5_w		resumo_html5.nr_sequencia%type;
nr_seq_resumo_html5_os_w	resumo_html5_os.nr_sequencia%type;
resumo_html5_recurso_w		resumo_html5_recurso.nr_sequencia%type;
qt_capacidade_diaria_w		integer;
qt_atividades_prev_w		integer;
ie_previsao_faltando_w		varchar(1);
qt_horas_baixadas_w		integer;
qt_horas_baixadas_recurso_w	integer;
qt_os_v_v_w			bigint := 0;
qt_os_dev_w			bigint := 0;
qt_os_tec_w			bigint := 0;
qt_os_des_w			bigint := 0;
qt_os_out_w			bigint := 0;
qt_os_analisadas_w		bigint := 0;
qt_triagem_os_w			bigint := 0;
qt_prev_os_w			bigint := 0;
ie_tipo_os_w			varchar(10);
ie_existe_ativ_analise_w	varchar(1);
qt_tempo_prev_analista_w	bigint := 0;
qt_capacidade_analise_w		bigint := 0;
dt_prev_analise_w		timestamp;
qt_tempo_prev_prog_w		bigint := 0;
qt_capacidade_prog_w		bigint := 0;
dt_prev_prog_w			timestamp;
dt_prev_funcao_w		timestamp;
dt_ultima_prev_tec_w		timestamp;
dt_ultima_analise_os_w		timestamp;
ie_os_tec_sem_prev_w		varchar(1);
ds_recurso_w			varchar(2000);
ds_recurso_prog_w		varchar(2000);
ds_recurso_analise_w		varchar(2000);
ds_projetos_w			varchar(4000);
dt_referencia_w			timestamp;
qt_prev_os_analise_w		double precision;
qt_prev_os_prog_w		double precision;
qt_prev_os_analise_funcao_w	double precision;
qt_prev_os_prog_funcao_w	double precision;
qt_dias_prog_w			bigint;
qt_dias_analise_w		bigint;
qt_existe_mesma_os_w		bigint;

C01 CURSOR FOR
	SELECT	c.cd_funcao,
		e.ie_prioridade,
		e.ie_status,
		c.nr_sequencia nr_seq_projeto
	from	proj_cron_etapa a,
		proj_cronograma b,
		proj_projeto c,
		proj_cronograma d,
		funcoes_html5 e
	where	(a.nr_seq_sub_proj IS NOT NULL AND a.nr_seq_sub_proj::text <> '')
	and	a.nr_seq_cronograma = b.nr_sequencia
	and	b.nr_seq_proj = 7411
	and	c.nr_sequencia = nr_seq_sub_proj
	and	d.nr_seq_proj = c.nr_sequencia
	and	c.nr_seq_prioridade > 0
	and	(c.cd_funcao IS NOT NULL AND c.cd_funcao::text <> '')
	and	e.cd_funcao = c.cd_funcao
	and	nr_seq_gerencia in (82, 86) -- gerências BNU e BLR
	order by nr_seq_sub_proj;

funcoes_w	c01%rowtype;

C02 CURSOR FOR
	SELECT	b.nr_sequencia nr_ordem_servico,
		b.nr_seq_grupo_des,
		b.nr_seq_estagio,
		b.nr_seq_equipamento,
		'S' ie_tec,
		b.cd_funcao,
		b.ds_dano_breve,
		coalesce(c.ie_tecnologia,'N') ie_tipo_estagio
	from	proj_ordem_servico a,
		man_ordem_servico b,
		man_estagio_processo c
	where	a.nr_seq_ordem = b.nr_sequencia
	and	a.nr_seq_proj = 7484
	and	obter_grupo_des_os_data(b.nr_sequencia, dt_referencia_p) = 246
	and	c.nr_sequencia = man_obter_estagio_data(b.nr_sequencia, dt_referencia_p)
	and	c.ie_tecnologia = 'S'
	and	b.cd_funcao = funcoes_w.cd_funcao
	
union

	SELECT	a.nr_sequencia nr_ordem_servico,
		a.nr_seq_grupo_des,
		a.nr_seq_estagio,
		a.nr_seq_equipamento,
		'N' ie_tec,
		a.cd_funcao,
		a.ds_dano_breve,
		coalesce(b.ie_tecnologia,'N') ie_tipo_estagio
	from	man_ordem_servico a,
		man_estagio_processo b
	where	obter_grupo_des_os_data(a.nr_sequencia, dt_referencia_p) in (241,246,263,288,262,191,264,254,265,286,266,190,267,271,273,260,276,197,277,220,278,279,280,296,274,255,275,272,270,287,219,298,299,300,310,311,201)
	and	a.nr_seq_estagio not in (9)
	and	a.nr_seq_estagio = man_obter_estagio_data(a.nr_sequencia, dt_referencia_p)
	and	cd_funcao = funcoes_w.cd_funcao
	order by nr_ordem_servico, ie_tec desc;

os_w	c02%rowtype;

C03 CURSOR FOR
	SELECT	coalesce(a.qt_horas_rec_proj, 0) qt_horas_rec_proj,
		b.nm_usuario,
		a.nr_seq_funcao
	from	proj_equipe_papel a,
		usuario b
	where	a.ie_situacao = 'A'
	and	a.nr_seq_equipe = nr_seq_proj_equipe_w
	and	b.cd_pessoa_fisica = a.cd_pessoa_fisica;

recurso_w c03%rowtype;
BEGIN

if (dt_referencia_p IS NOT NULL AND dt_referencia_p::text <> '') then
	dt_referencia_w := dt_referencia_p;
else
	dt_referencia_w := clock_timestamp();
end if;

delete	FROM resumo_html5_recurso a
where	exists (SELECT	1
		from	resumo_html5 b
		where	b.nr_sequencia = a.nr_seq_resumo_html5
		and	trunc(b.dt_referencia) = trunc(dt_referencia_w));

delete	FROM resumo_html5_os a
where	exists (SELECT	1
		from	resumo_html5 b
		where	b.nr_sequencia = a.nr_seq_resumo_html5
		and	trunc(b.dt_referencia) = trunc(dt_referencia_w));


delete	FROM resumo_html5
where	trunc(dt_referencia) = trunc(dt_referencia_w);

ds_projetos_w := ',';

open C01;
loop
fetch C01 into
	funcoes_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

if (position(',' || funcoes_w.cd_funcao || ',' in ',' || ds_projetos_w || ',') = 0)  then

	ds_projetos_w := ds_projetos_w || ',' || funcoes_w.cd_funcao;

	-- inicialização de variáveis por função
	qt_horas_baixadas_w := 0;
	qt_os_v_v_w:= 0;
	qt_os_dev_w:= 0;
	qt_os_tec_w:= 0;
	qt_os_des_w:= 0;
	qt_os_out_w:= 0;
	qt_os_analisadas_w := 0;
	qt_capacidade_diaria_w := 0;
	qt_prev_os_prog_funcao_w := 0;
	qt_prev_os_analise_funcao_w := 0;
	qt_tempo_prev_analista_w := 0;
        qt_tempo_prev_prog_w := 0;
	ds_recurso_w := null;
	ds_recurso_prog_w := null;
	ds_recurso_analise_w := null;
	ie_previsao_faltando_w := 'S';
	dt_ultima_prev_tec_w := null;
	ie_os_tec_sem_prev_w := 'N';
	dt_prev_analise_w := trunc(dt_referencia_w);
	dt_prev_prog_w := trunc(dt_referencia_w);
	qt_existe_mesma_os_w := 0;

	-- gerar nova sequencia da tabela de resumo
	select	nextval('resumo_html5_seq')
	into STRICT	nr_seq_resumo_html5_w
	;

	-- identificar qual é a equipe de desenvolvimento do projeto
	select	max(nr_sequencia)
	into STRICT	nr_seq_proj_equipe_w
	from	proj_equipe
	where	nr_seq_equipe_funcao = 11
	and	nr_seq_proj = funcoes_w.nr_seq_projeto;

	open C03;
	loop
	fetch C03 into
		recurso_w;
	EXIT WHEN NOT FOUND; /* apply on C03 */

		ds_recurso_w := ds_recurso_w || ',' || recurso_w.nm_usuario;

		if (recurso_w.nr_seq_funcao = 44) then
			ds_recurso_prog_w := ds_recurso_prog_w || ',' || recurso_w.nm_usuario;
		else
			ds_recurso_analise_w := ds_recurso_analise_w || ',' || recurso_w.nm_usuario;
		end if;

		-- Obter a soma da capacidade diária do time
		if (recurso_w.nr_seq_funcao in (44)) then
			qt_capacidade_diaria_w := qt_capacidade_diaria_w + recurso_w.qt_horas_rec_proj;
		end if;

		-- obter a carga executada pelo recurso no dia
		select	sum(((coalesce(qt_min_prev,0) * coalesce(pr_atividade,0)) / 100) / 60) qt_previsto
		into STRICT	qt_horas_baixadas_recurso_w
		from	man_ordem_ativ_prev a,
			man_ordem_servico b,
			usuario_grupo_des u,
			grupo_desenvolvimento g
		where	b.nr_sequencia = a.nr_seq_ordem_serv
		and	b.cd_funcao = funcoes_w.cd_funcao
		and 	u.nr_seq_grupo = g.nr_sequencia
		and 	a.nm_usuario_prev = u.nm_usuario_grupo
		and 	trunc(dt_prevista) = trunc(dt_referencia_w)
		and 	obter_grupo_des_os_data(b.nr_sequencia, dt_referencia_p) in (246,263,288,262,191,264,254,265,286,266,190,267,271,273,260,276,197,277,220,278,279,280,296,274,255,275,272,270,287,219,298,299,300,310,311)
		and 	g.nr_sequencia in (298,299)
		and 	a.nm_usuario_prev = recurso_w.nm_usuario
		and 	exists ( SELECT 	1
				from 	man_estagio_processo c,
					man_ordem_serv_estagio d
				where	c.nr_sequencia = d.nr_seq_estagio
				and	d.nr_seq_ordem = b.nr_sequencia
				and	c.ie_desenv = 'S');

		-- acumular as horas baixadas da função atual
		qt_horas_baixadas_w := qt_horas_baixadas_w + coalesce(qt_horas_baixadas_recurso_w,0);

		-- Ver se tem programador sem atividade prevista
		select	coalesce(sum(qt_min_prev),0) / 60
		into STRICT	qt_atividades_prev_w
		from	man_ordem_ativ_prev b,
			man_ordem_servico d
		where	b.nm_usuario_prev = recurso_w.nm_usuario
		and	b.dt_prevista between trunc(dt_referencia_w) and fim_dia(add_working_days(dt_referencia_w, 1))
		and	b.nr_seq_ordem_serv = d.nr_sequencia
		and	d.cd_funcao = funcoes_w.cd_funcao;

		if (recurso_w.nr_seq_funcao = 44) then
			-- Verificar se tem previsão para as horas da capacidade dos programadores
			if (dividir((qt_atividades_prev_w * 100), qt_capacidade_diaria_w) < 85) then
				ie_previsao_faltando_w := 'N';
			end if;
		end if;

		select	nextval('resumo_html5_recurso_seq')
		into STRICT	resumo_html5_recurso_w
		;

		insert into resumo_html5_recurso(
			nr_sequencia,
			dt_atualizacao,
			nr_seq_resumo_html5,
			dt_referencia,
			nr_seq_equipe_des,
			nm_usuario_recurso,
			nr_seq_funcao,
			qt_capacidade_diaria,
			qt_producao_dia)
		values (	resumo_html5_recurso_w,
			clock_timestamp(),
			nr_seq_resumo_html5_w,
			dt_referencia_w,
			nr_seq_proj_equipe_w,
			recurso_w.nm_usuario,
			recurso_w.nr_seq_funcao,
			recurso_w.qt_horas_rec_proj,
			qt_horas_baixadas_recurso_w);

	end loop;
	close C03;

	-- passar pela lista das OS da função
	open C02;
	loop
	fetch C02 into
		os_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */

		select	count(*)
		into STRICT	qt_existe_mesma_os_w
		from	resumo_html5_os
		where	nr_seq_resumo_html5 = nr_seq_resumo_html5_w
		and	nr_seq_ordem_servico = os_w.nr_ordem_servico;

		if (qt_existe_mesma_os_w = 0) then

			ie_existe_ativ_analise_w := 'N';

			-- obter tempo previsto de programação restante da OS atual
			select	ceil(coalesce(sum((qt_min_prev * (100 - coalesce(pr_atividade,0))) / 100), 0) /60)
			into STRICT	qt_prev_os_prog_w
			from	man_ordem_ativ_prev a
			where	position(a.nm_usuario_prev in ds_recurso_prog_w) > 0
			and	coalesce(a.pr_atividade, 0) < 100
			and	nr_seq_ordem_serv = os_w.nr_ordem_servico;

			-- obter tempo previsto de análise restante da OS atual
			select	coalesce(sum((qt_min_prev * (100 - coalesce(pr_atividade,0))) / 100), 0) / 60
			into STRICT	qt_prev_os_analise_w
			from	man_ordem_ativ_prev a
			where	position(a.nm_usuario_prev in ds_recurso_analise_w) > 0
			and	coalesce(a.pr_atividade, 0) < 100
			and	nr_seq_ordem_serv = os_w.nr_ordem_servico;

			qt_prev_os_analise_w := greatest(qt_prev_os_analise_w, 0.5);

			-- acumular os tempos totais de análise e programação da função
			qt_tempo_prev_analista_w := qt_tempo_prev_analista_w + coalesce(qt_prev_os_analise_w,0);
			qt_tempo_prev_prog_w     := qt_tempo_prev_prog_w     + coalesce(qt_prev_os_prog_w,0);

			if (os_w.ie_tec = 'S') and (os_w.ie_tipo_estagio = 'S') then
				ie_tipo_os_w := 'Tech';
				qt_os_tec_w := qt_os_tec_w + 1;

				-- verificar se a OS da tec tem análise
				select	max(dt_prevista)
				into STRICT	dt_ultima_analise_os_w
				from	man_ordem_ativ_prev a
				where	position(a.nm_usuario_prev in ds_recurso_w) = 0
				and	coalesce(a.pr_atividade, 0) < 100
				and	nr_seq_ordem_serv = os_w.nr_ordem_servico
				and	trunc(dt_prevista) >= trunc(dt_referencia_w);

				if (coalesce(dt_ultima_analise_os_w::text, '') = '') then
					ie_os_tec_sem_prev_w := 'S';
				elsif (dt_ultima_prev_tec_w IS NOT NULL AND dt_ultima_prev_tec_w::text <> '') and (dt_ultima_analise_os_w > dt_ultima_prev_tec_w) then
					dt_ultima_prev_tec_w := dt_ultima_analise_os_w;
				end if;

			elsif (os_w.nr_seq_estagio in (99,1071,2155,791,1061,1234,2134)) and (os_w.nr_seq_equipamento in (7100,7209)) then
				ie_tipo_os_w := 'VV';
				qt_os_v_v_w := qt_os_v_v_w + 1;

			elsif (os_w.nr_seq_grupo_des in (263,288,262,191,264,254,265,286,266,190,267,271,273,260,276,197,277,220,278,279,280,296,274,255,275,272,270,287,219,298,299,300,310,311)) and (os_w.nr_seq_estagio not in (2, 2134)) and (os_w.ie_tipo_estagio = 'N') then
				ie_tipo_os_w := 'Dev';
				qt_os_dev_w := qt_os_dev_w + 1;

				-- verificar se a OS está triada
				select	count(*)
				into STRICT	qt_prev_os_w
				from	man_ordem_ativ_prev a
				where	position(a.nm_usuario_prev in ds_recurso_w) > 0
				and	coalesce(a.pr_atividade, 0) < 100
				and	nr_seq_ordem_serv = os_w.nr_ordem_servico;

				qt_triagem_os_w := 0;

				if (qt_prev_os_w > 0) then
					select	count(*)
					into STRICT	qt_triagem_os_w
					from	man_ordem_serv_ativ a
					where	position(a.nm_usuario_exec in ds_recurso_w) > 0
					and	a.nr_seq_funcao in (1316,1322,1325,1315,1309,1173,1324,1323,1321,1318)
					and	a.nr_seq_ordem_serv = os_w.nr_ordem_servico;
				end if;

				if (qt_triagem_os_w > 0) then
					ie_existe_ativ_analise_w := 'S';
				end if;

				if (ie_existe_ativ_analise_w = 'S') then
					qt_os_analisadas_w := qt_os_analisadas_w + 1;
				end if;

			elsif (os_w.nr_seq_grupo_des in (241)) and (os_w.nr_seq_estagio in (2136, 2135)) then
				ie_tipo_os_w := 'Design';
				qt_os_des_w := qt_os_des_w + 1;
			else
				ie_tipo_os_w := 'Others';
				qt_os_out_w := qt_os_out_w + 1;
			end if;

			select	nextval('resumo_html5_os_seq')
			into STRICT	nr_seq_resumo_html5_os_w
			;

			insert into resumo_html5_os(
				nr_sequencia,
				dt_atualizacao,
				nr_seq_resumo_html5,
				dt_referencia,
				nr_seq_ordem_servico,
				nr_seq_grupo_des,
				ie_tipo_os,
				ie_triada,
				qt_prev_os_analise,
				qt_prev_os_prog,
				ds_dano_breve)
			values (	nr_seq_resumo_html5_os_w,
				clock_timestamp(),
				nr_seq_resumo_html5_w,
				dt_referencia_w,
				os_w.nr_ordem_servico,
				os_w.nr_seq_grupo_des,
				ie_tipo_os_w,
				ie_existe_ativ_analise_w,
				qt_prev_os_analise_w,
				qt_prev_os_prog_w,
				os_w.ds_dano_breve);

		end if;
	end loop;
	close C02;

	-- calcular a data prevista de fim da análise de acordo com a quantidade de horas previstas de análise e a capacidade da equipe
	select	sum(qt_horas_rec_proj)
	into STRICT	qt_capacidade_analise_w
	from	proj_equipe_papel a
	where	a.nr_seq_funcao in (45)
	and	a.ie_situacao = 'A'
	and	a.nr_seq_equipe = nr_seq_proj_equipe_w;

	if (coalesce(qt_capacidade_analise_w, 0) > 0) and (coalesce(qt_tempo_prev_analista_w, 0) > 0) then

		qt_dias_analise_w := ceil(qt_tempo_prev_analista_w/qt_capacidade_analise_w);

		for i in 1..qt_dias_analise_w loop
			dt_prev_analise_w := dt_prev_analise_w + 1;
			while	obter_se_dia_util(dt_prev_analise_w, obter_estabelecimento_ativo) = 'N' loop
				dt_prev_analise_w := dt_prev_analise_w + 1;
			end loop;
		end loop;
	else
		dt_prev_analise_w := null;
	end if;

	-- calcular a data prevista de fim da programação de acordo com a quantidade de horas previstas de programação e a capacidade da equipe
	select	sum(qt_horas_rec_proj)
	into STRICT	qt_capacidade_prog_w
	from	proj_equipe_papel a
	where	a.nr_seq_funcao in (44)
	and	a.ie_situacao = 'A'
	and	a.nr_seq_equipe = nr_seq_proj_equipe_w;

	if (coalesce(qt_capacidade_prog_w, 0) > 0) and (coalesce(qt_tempo_prev_prog_w, 0) > 0) then

		qt_dias_prog_w := ceil(qt_tempo_prev_prog_w/qt_capacidade_prog_w);

		for i in 1..qt_dias_prog_w loop
			dt_prev_prog_w := dt_prev_prog_w + 1;
			while	obter_se_dia_util(dt_prev_prog_w, obter_estabelecimento_ativo) = 'N' loop
				dt_prev_prog_w := dt_prev_prog_w + 1;
			end loop;
		end loop;
	else
		dt_prev_prog_w := null;
	end if;

	insert into resumo_html5(
		nr_sequencia,
		dt_atualizacao,
		dt_referencia,
		cd_funcao,
		qt_backlog_dev,
		qt_backlog_tec,
		qt_backlog_v_v,
		qt_backlog_des,
		qt_backlog_out,
		ie_prioridade,
		ie_falta_previsao,
		qt_capacidade_diaria,
		qt_producao_dia,
		nr_seq_equipe_des,
		qt_os_analisadas,
		dt_prev_dev_funcao,
		dt_prev_analise_funcao,
		dt_ultima_prev_tec,
		ie_os_tec_sem_prev,
		qt_tempo_prev_analise,
		qt_tempo_prev_prog)
	values (	nr_seq_resumo_html5_w,
		clock_timestamp(),
		dt_referencia_w,
		funcoes_w.cd_funcao,
		qt_os_dev_w,
		qt_os_tec_w,
		qt_os_v_v_w,
		qt_os_des_w,
		qt_os_out_w,
		funcoes_w.ie_prioridade,
		ie_previsao_faltando_w,
		qt_capacidade_diaria_w,
		qt_horas_baixadas_w,
		nr_seq_proj_equipe_w,
		qt_os_analisadas_w,
		dt_prev_prog_w,
		dt_prev_analise_w,
		dt_ultima_prev_tec_w,
		ie_os_tec_sem_prev_w,
		qt_tempo_prev_analista_w,
		qt_tempo_prev_prog_w);

end if;

end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_mapa_funcoes_html5 (dt_referencia_p timestamp default clock_timestamp()) FROM PUBLIC;

