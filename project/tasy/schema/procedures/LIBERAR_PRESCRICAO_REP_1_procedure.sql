-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_prescricao_rep_1 ( ie_consiste_data_proced_p text, ie_liberar_cirurgia_p text, ie_ajusta_dose_diluicao_p text, ie_mostra_inf_adic_p text, ie_avisa_dieta_p text, ie_medico_p text, nr_prescricao_p bigint, nr_atendimento_p bigint, cd_setor_atendimento_p bigint, ds_mensagem_p INOUT text, ds_clearence_p INOUT text, nm_usuario_p text, cd_funcao_p bigint, dt_vigencia_p timestamp) AS $body$
DECLARE


ie_prescr_emergencia_w		varchar(1);
ie_prescr_proced_emerg_w	varchar(1);
ie_cirurgia_w				varchar(1);
ie_obriga_anamnese_w		varchar(1);
ie_prescricao_alta_w		varchar(1);
ie_possui_registro_w		varchar(1);
nr_cirurgia_w				bigint;
ds_mensagem_w				varchar(4000);
ds_clearence_w				varchar(4000) := '';


BEGIN

if (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') and (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then
	begin
	
	if (verif_elem_npt_ped(nr_prescricao_p) = 'S') then
		--- Existem elementos na NPT Pediatrica com volume negativo. Favor verificar!
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(283671);
	end if;
	
	select	max(ie_prescr_emergencia),
			max(ie_prescricao_alta),
			max(nr_cirurgia)
	into STRICT	ie_prescr_emergencia_w,
			ie_prescricao_alta_w,
			nr_cirurgia_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;
	
	if (ie_consiste_data_proced_p <> 'S') and (ie_prescr_emergencia_w = 'S') then
		select	coalesce(max('N'),'S')
		into STRICT	ie_prescr_proced_emerg_w
		from	prescr_procedimento where		coalesce(ie_urgencia,'N') = 'N'
		and		trunc(dt_prev_execucao,'mi') < trunc(clock_timestamp(),'mi')
		and		nr_prescricao	= nr_prescricao_p LIMIT 1;
		
		if (ie_prescr_proced_emerg_w = 'S') then
			begin		
			--Existem procedimentos com data prevista de execucao anterior a data atual! Parametro[678].
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(69105);
			end;
		end if;
	end if;
	
	if (ie_liberar_cirurgia_p <> 'S') then
		begin
		if (nr_cirurgia_w > 0) then
			begin			
			--Voce nao tem permissao para liberar prescricoes de cirurgia. Parametro [713].
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(47963);
			end;
		else
			begin
			select	coalesce(max('S'),'N')
			into STRICT	ie_cirurgia_w
			from	cirurgia where		nr_prescricao	= nr_prescricao_p LIMIT 1;
			
			if (ie_cirurgia_w = 'S') then
				begin				
				--Voce nao tem permissao para liberar prescricoes de cirurgia. Parametro [713].
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(47963);
				end;
			end if;
			end;
		end if;
		end;
	end if;
	
	if (verifica_se_obriga_anamnese(nr_prescricao_p) = 'S') then
		begin
		select	coalesce(max('N'),'S')
		into STRICT	ie_obriga_anamnese_w
		from	anamnese_paciente
		where	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
		and		nr_atendimento	= nr_atendimento_p;
		
		if (ie_obriga_anamnese_w = 'S') then
			begin
			--Nao sera possivel liberar esta prescricao.Antes, e necessario informar a anamnese do paciente!
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(69124);
			end;
		end if;
		end;
	end if;
	
	if (consiste_regra_obriga_proc(nr_prescricao_p) = 'N') then
		begin
		--Nao sera possivel liberar esta prescricaoo. Verifique os procedimentos/exames obrigatorios para a primeira prescricao do atendimento!
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(69125);
		end;
	end if;
	
	if (ie_prescricao_alta_w <> 'S') then
		if (obter_se_recomendacao_alta(nr_prescricao_p) = 'S') then
			begin			
			--Nao sera possivel liberar esta prescricao.Prescricao deve ser do tipo alta!
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(69126);
			end;
		end if;
	end if;
	
	if (ie_ajusta_dose_diluicao_p <> 'S') then
		begin
		CALL calcular_volume_diluicao(nr_prescricao_p, nm_usuario_p);
		end;
	end if;
	
	if (ie_mostra_inf_adic_p = 'S') then
		begin
		if (obter_se_libera_prescr(nr_prescricao_p) = 'N') then
			begin			
			--Ha procedimentos que exigem informacoes adicionais que nao foram informadas. A prescricao nao sera liberada!
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(75464);
			end;
		end if;
		end;
	end if;

	if (ie_medico_p = 'S') and
		((ie_avisa_dieta_p = 'S') or
		 ((ie_avisa_dieta_p = 'D') and (obter_se_obriga_dieta(nr_atendimento_p, nr_prescricao_p,cd_setor_atendimento_p, cd_funcao_p, dt_vigencia_p) <> 'N'))) then
		select	coalesce(max('S'),'N')
		into STRICT	ie_possui_registro_w
		from	prescr_dieta where		nr_prescricao	= nr_prescricao_p LIMIT 1;

		if (ie_possui_registro_w = 'N') then
			select 	coalesce(max('S'),'N')
			into STRICT	ie_possui_registro_w
			from	prescr_leite_deriv where		nr_prescricao	= nr_prescricao_p LIMIT 1;
			
			if (ie_possui_registro_w = 'N') then
				begin
				select	coalesce(max('S'),'N')
				into STRICT	ie_possui_registro_w
				from	rep_jejum where		nr_prescricao	= nr_prescricao_p LIMIT 1;
				
				if (ie_possui_registro_w = 'N') then
					begin
					--Nao foi prescrita dieta para essa prescricao.
					ds_mensagem_w := substr(obter_texto_dic_objeto(75492, wheb_usuario_pck.get_nr_seq_idioma,null),1,4000);
					end;
				end if;
				end;
			end if;
		end if;
	end if;
	
	if (Obter_se_obriga_clearance(nr_prescricao_p, 'O') = 'S') then
		begin
		--O(s) medicamento(s) #@DS_OBRIGA#@ exige(m) informacoes de clearance!
		ds_clearence_w	:=	substr(obter_texto_dic_objeto(113073, wheb_usuario_pck.get_nr_seq_idioma, 'DS_OBRIGA='||substr(Obter_se_obriga_clearance(nr_prescricao_p, 'Q'),1,3940)),1,4000);
		end;	
	end if;		
	end;
end if;
ds_mensagem_p	:= ds_mensagem_w;
ds_clearence_p	:= ds_clearence_w;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_prescricao_rep_1 ( ie_consiste_data_proced_p text, ie_liberar_cirurgia_p text, ie_ajusta_dose_diluicao_p text, ie_mostra_inf_adic_p text, ie_avisa_dieta_p text, ie_medico_p text, nr_prescricao_p bigint, nr_atendimento_p bigint, cd_setor_atendimento_p bigint, ds_mensagem_p INOUT text, ds_clearence_p INOUT text, nm_usuario_p text, cd_funcao_p bigint, dt_vigencia_p timestamp) FROM PUBLIC;

