-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_dpy_request ( nr_interno_conta_p bigint, --account number patient billing
 cd_estabelecimento_p bigint, nm_usuario_p text, cd_error_string_p INOUT text) AS $body$
DECLARE


nr_seq_dvy_w			dbs_claim.nr_sequencia%type;
cd_provider_w			dbs_claim.cd_provider%type;
cd_claim_w			dbs_claim.cd_claim%type;
dt_claim_w			dva_claim.dt_atualizacao%type;
nr_seq_transaction_w    	dbs_claim.nr_seq_transaction%type;
nr_seq_history_claim_w  	eclipse_claim_history.NR_SEQUENCIA %type;
nr_seq_w 			dbs_claim.nr_sequencia%type;
request_sts			varchar(500);


BEGIN

select	nextval('dpy_request_seq')
into STRICT	nr_seq_dvy_w
;

select 	max(nr_sequencia)
into STRICT 	nr_seq_w
from 	dbs_claim
where 	nr_seq_account = nr_interno_conta_p;

select	CASE WHEN coalesce(max(CD_PAYEE_PROVIDER)::text, '') = '' THEN max(cd_provider)  ELSE max(CD_PAYEE_PROVIDER) END 	service_provider_val,
	max(cd_claim)	claim_val,
	max(nr_seq_transaction)	transaction_id,
	max(dt_atualizacao)	claim_data
into STRICT	cd_provider_w,
	cd_claim_w,
	nr_seq_transaction_w,
	dt_claim_w
from	dbs_claim
where	nr_sequencia = nr_seq_w
order by nr_sequencia desc;

if (coalesce(cd_provider_w::text, '') = '' ) then
			cd_error_string_p := cd_error_string_p
                              || wheb_mensagem_pck.get_texto(1104644)
                              ||'##';
end if;


if (coalesce(cd_claim_w::text, '') = '' ) then
	cd_error_string_p := cd_error_string_p
                              || wheb_mensagem_pck.get_texto(1104650)
                              ||'##';
end if;

if (coalesce(dt_claim_w::text, '') = '' ) then
	cd_error_string_p := cd_error_string_p
                              || wheb_mensagem_pck.get_texto(1104651)
                              ||'##';
end if;


if (coalesce(cd_error_string_p::text, '') = '') then
	begin

	insert	into dpy_request(nr_sequencia ,
			dt_atualizacao ,
			nm_usuario ,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_payee_provider,
			cd_claim,
			dt_transmission,
			nr_seq_transaction)
	values (nr_seq_dvy_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_provider_w,
			cd_claim_w,
			dt_claim_w,
			nr_seq_transaction_w);

	select	nextval('eclipse_claim_history_seq')
	into STRICT	nr_seq_history_claim_w
	;

	insert	into	eclipse_claim_history(
			nr_sequencia,
			nm_usuario	,
			dt_atualizacao 	,
			ds_historico	,
			nr_interno_conta
		)
	values (
			nr_seq_history_claim_w,
			nm_usuario_p,
			clock_timestamp(),
			wheb_mensagem_pck.get_texto(1105898) ,
			nr_interno_conta_p
		);
	commit;
	request_sts :=	'{' || chr(10) ||'"transactionId":"' || nr_seq_transaction_w
			||'",'|| chr(10) || '"userName":"' ||nm_usuario_p|| '"}';
	CALL execute_bifrost_integration(202, request_sts);
	commit;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_dpy_request ( nr_interno_conta_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, cd_error_string_p INOUT text) FROM PUBLIC;

