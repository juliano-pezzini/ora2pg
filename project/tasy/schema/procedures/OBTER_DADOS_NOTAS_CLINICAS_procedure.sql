-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_dados_notas_clinicas ( nr_seq_suep_p bigint, nr_atendimento_p bigint, dt_evolucao_p INOUT text, cd_evolucao_p INOUT evolucao_paciente.cd_evolucao%type, nm_medico_p INOUT text, ds_impressao_p INOUT text, cd_pessoa_fisica_p text default null) AS $body$
DECLARE


	ie_formato_busca_p		varchar(1);
	ie_evolucao_clinica_p	varchar(255);
	ie_tipo_evolucao_w		varchar(3);

BEGIN


Select 	coalesce(max(a.ie_formato_busca),'A') ie_formato_busca
into STRICT	ie_formato_busca_p
from	item_suep a,
		suep b
where	a.nr_seq_suep = b.nr_sequencia
and		a.ie_tipo_item = 'EV'
and		b.nr_sequencia = nr_seq_suep_p;


SELECT	obter_inf_suep(nr_seq_suep_p, 'EV', 'I') ie_evolucao_clinica,
		Obter_Dados_Usuario_Opcao(wheb_usuario_pck.get_nm_usuario,'F')
into STRICT	ie_evolucao_clinica_p,
		ie_tipo_evolucao_w
;


if (ie_formato_busca_p = 'C') then

	select 	coalesce(max(cd_evolucao),0)
	into STRICT	cd_evolucao_p
	from 	evolucao_paciente a
	where 	coalesce(a.ie_tipo_evolucao,ie_tipo_evolucao_w) = ie_tipo_evolucao_w
	and     obter_se_reg_lib_atencao(a.cd_pessoa_fisica, a.cd_medico, a.ie_nivel_atencao, a.nm_usuario,5) = 'S'
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		coalesce(a.dt_inativacao::text, '') = ''
	and		((coalesce(ie_evolucao_clinica_p::text, '') = '') or 
			a.ie_evolucao_clinica in (	SELECT	c.ie_evolucao_clinica
										from	item_suep a,
												suep b,
												informacao_suep c
										where	a.nr_seq_suep = b.nr_sequencia
										and		a.ie_tipo_item = 'EV'
										and		b.nr_sequencia = nr_seq_suep_p
										and		a.nr_sequencia = c.nr_seq_item))
	and (ie_formato_busca_p = 'C' and  a.nr_atendimento in (select x.nr_atendimento from atendimento_paciente x where x.cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_p,'C') and x.nr_seq_episodio = obter_episodio_atendimento(nr_atendimento_p)));
	
else
	select 	coalesce(max(cd_evolucao),0)
	into STRICT	cd_evolucao_p
	from 	evolucao_paciente a 
	where 	coalesce(a.ie_tipo_evolucao,ie_tipo_evolucao_w) = ie_tipo_evolucao_w
	and     obter_se_reg_lib_atencao(a.cd_pessoa_fisica, a.cd_medico, a.ie_nivel_atencao, a.nm_usuario,5) = 'S'
	and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		coalesce(a.dt_inativacao::text, '') = ''
	and		((coalesce(ie_evolucao_clinica_p::text, '') = '') or 
			a.ie_evolucao_clinica in (	SELECT	c.ie_evolucao_clinica
										from	item_suep a,
												suep b,
												informacao_suep c
										where	a.nr_seq_suep = b.nr_sequencia
										and		a.ie_tipo_item = 'EV'
										and		b.nr_sequencia = nr_seq_suep_p
										and		a.nr_sequencia = c.nr_seq_item))
	and		((ie_formato_busca_p = 'A' and	a.nr_atendimento = nr_atendimento_p) or (ie_formato_busca_p = 'P' and  a.cd_pessoa_fisica = cd_pessoa_fisica_p));
end if;
			
			 

if ((cd_evolucao_p IS NOT NULL AND cd_evolucao_p::text <> '') and cd_evolucao_p > 0) then

	select	PKG_DATE_FORMATERS.to_varchar(b.dt_evolucao, 'short', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario ) dt_evolucao,			
			substr(obter_nome_pf(b.cd_medico),1,255) nm_medico,
			substr(b.ds_impressao,1,155) ds_impressao  
	into STRICT	dt_evolucao_p,			
			nm_medico_p,
			ds_impressao_p
	from	evolucao_paciente b
	where	b.cd_evolucao = cd_evolucao_p;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_dados_notas_clinicas ( nr_seq_suep_p bigint, nr_atendimento_p bigint, dt_evolucao_p INOUT text, cd_evolucao_p INOUT evolucao_paciente.cd_evolucao%type, nm_medico_p INOUT text, ds_impressao_p INOUT text, cd_pessoa_fisica_p text default null) FROM PUBLIC;

