-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_protocolo_atendimento (ID_ACAO_P text, IE_STATUS_P text, NR_CPF_P text, CD_USUARIO_CONVENIO_P text, NM_USUARIO_P text, CD_ESTABELECIMENTO_P text, CD_PROTOCOLO_ABERTO_P text, CD_PROTOCOLO_INTEGRACAO_P text, CD_PESSOA_FISICA_P text, DS_RETORNO_P INOUT text) AS $body$
DECLARE


  DT_ATUALIZACAO_W   timestamp := clock_timestamp();
  NR_SEQUENCIA_W     AGEINT_DADOS_URA.NR_SEQUENCIA%TYPE;
  NR_SEQUENCIA_WW    AGEINT_DADOS_URA.NR_SEQUENCIA%TYPE;
  CD_PROTOCOLO_W     AGEINT_PROTOCOLO_ATEND.CD_PROTOCOLO%TYPE;


BEGIN
IF (IE_STATUS_P = 'E') THEN
 
  	IF (coalesce(CD_PROTOCOLO_ABERTO_P::text, '') = '') 
  	OR (coalesce(CD_PROTOCOLO_INTEGRACAO_P::text, '') = '') THEN
		DS_RETORNO_P := 'S';
 	ELSE
	 UPDATE ageint_protocolo_atend 
	 	SET dt_fim_atend = clock_timestamp(),
	 		dt_atualizacao = clock_timestamp(),
	 		dt_atualizacao_nrec = clock_timestamp()
	 WHERE cd_protocolo = cd_protocolo_aberto_p
	 OR (nm_usuario = nm_usuario_p
	 AND    coalesce(dt_fim_atend::text, '') = '');
	
	END IF;

 IF (cd_protocolo_integracao_p IS NOT NULL AND cd_protocolo_integracao_p::text <> '') then
	
	INSERT INTO ageint_protocolo_atend(nr_sequencia,
									   dt_inicio_atend, 
									   dt_atualizacao, 
									   nm_usuario, 
									   cd_protocolo, 
									   cd_pessoa_fisica,
									   dt_atualizacao_nrec,
									   nm_usuario_nrec)
									   values (nextval('ageint_protocolo_atend_seq'),
									   clock_timestamp(),
									   clock_timestamp(),
									   nm_usuario_p,
									   cd_protocolo_integracao_p,
									   cd_pessoa_fisica_p,
									   clock_timestamp(),
									   nm_usuario_p);
	END IF;

	SELECT nextval('ageint_dados_ura_seq')
	INTO STRICT NR_SEQUENCIA_W
	;

	INSERT INTO AGEINT_DADOS_URA ADU(NR_SEQUENCIA,
  									ID_OPERADOR, 
  									ID_ACAO, 
  									NR_CPF, 
  									NM_USUARIO, 
  									NM_USUARIO_NREC, 
  									IE_STATUS, 
  									DT_ATUALIZACAO, 
  									DT_ATUALIZACAO_NREC, 
  									CD_USUARIO_CONVENIO, 
  									CD_PROTOCOLO) 
  									VALUES (NR_SEQUENCIA_W,
  							        NM_USUARIO_P, 
  							        ID_ACAO_P, 
  							        NR_CPF_P, 
  							        NM_USUARIO_P, 
  							        NM_USUARIO_P, 
  							        IE_STATUS_P, 
  							        DT_ATUALIZACAO_W, 
  							        DT_ATUALIZACAO_W, 
  							        CD_USUARIO_CONVENIO_P, 
  							        CD_PROTOCOLO_INTEGRACAO_P);
  END IF;
  
  COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_protocolo_atendimento (ID_ACAO_P text, IE_STATUS_P text, NR_CPF_P text, CD_USUARIO_CONVENIO_P text, NM_USUARIO_P text, CD_ESTABELECIMENTO_P text, CD_PROTOCOLO_ABERTO_P text, CD_PROTOCOLO_INTEGRACAO_P text, CD_PESSOA_FISICA_P text, DS_RETORNO_P INOUT text) FROM PUBLIC;

