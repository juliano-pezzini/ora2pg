-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_baca_coparticipacao () AS $body$
DECLARE


vl_lancamento_manual_w	double precision;
vl_copartic_w		double precision;
vl_item_w		double precision;
nr_seq_item_ant_w	bigint;
nr_seq_lote_w		bigint;
nr_seq_mensalidade_w	bigint;
nr_seq_segurado_w	bigint;
nr_seq_conta_w		bigint;
dt_ocorrencia_w		timestamp;
ds_observacao_w		varchar(255);
nr_seq_lanc_manual_w	bigint;

/* Diferença pode ser verificada através do relatório [CPLS - 05678] - OPS - Diferença na cobrança de co-participação */

C01 CURSOR FOR
	SELECT	sum(vl_copartic - vl_item) vl_total,
		vl_copartic,
		vl_item,
		nr_sequencia,
		nr_seq_lote,
		nr_seq_mensalidade,
		nr_seq_segurado,
		nr_seq_conta,
		dt_mesano_referencia
	from (	SELECT	sum(coalesce(f.vl_coparticipacao,0)) vl_copartic,
				coalesce(c.vl_item,0) vl_item,
				c.nr_sequencia,
				i.nr_sequencia nr_seq_lote,
				a.nr_sequencia nr_seq_mensalidade,
				g.nr_sequencia nr_seq_segurado,
				h.nm_pessoa_fisica nm_segurado,
				d.nr_sequencia nr_seq_conta,
				b.dt_mesano_referencia
			from	pls_lote_mensalidade		i,
				pls_mensalidade 		a,
				pls_mensalidade_segurado 	b,
				pls_mensalidade_seg_item	c,
				pls_conta 			d,
				pls_conta_coparticipacao	f,
				pls_segurado			g,
				pessoa_fisica			h
			where	a.nr_sequencia	= b.nr_seq_mensalidade
			and	b.nr_sequencia	= c.nr_seq_mensalidade_seg
			and	c.nr_seq_conta	= d.nr_sequencia
			and	d.nr_sequencia	= f.nr_seq_conta
			and	g.nr_sequencia	= b.nr_seq_segurado
			and	i.nr_sequencia	= a.nr_seq_lote
			and	g.cd_pessoa_fisica = h.cd_pessoa_fisica
			and	c.nr_lote_contabil	= 12036
			and	c.ie_tipo_item	= '3'
			and	coalesce(i.nr_lote_contab_antecip::text, '') = ''
			and	coalesce(i.nr_lote_contab_antecip,0) <> 12036
			and	coalesce(a.ie_cancelamento::text, '') = ''
			group by 	c.vl_item,
					c.nr_sequencia,
					i.nr_sequencia,
					a.nr_sequencia,
					g.nr_sequencia,
					d.nr_sequencia,
					h.nm_pessoa_fisica,
					b.dt_mesano_referencia) alias7
	where	vl_copartic <> abs(vl_item)
	group by nr_sequencia,
			vl_copartic,
			vl_item,
			nr_seq_lote,
			nr_seq_mensalidade,
			nr_seq_segurado,
			nm_segurado,
			nr_seq_conta,
			dt_mesano_referencia
	order by	nm_segurado;


BEGIN

open C01;
loop
fetch C01 into
	vl_lancamento_manual_w,
	vl_copartic_w,
	vl_item_w,
	nr_seq_item_ant_w,
	nr_seq_lote_w,
	nr_seq_mensalidade_w,
	nr_seq_segurado_w,
	nr_seq_conta_w,
	dt_ocorrencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ds_observacao_w	:= 'Valor referente a co-participação do mês 11/2010, onde foi cobrado o valor R$'||vl_item_w||', quando deveria ter cobrado R$'||vl_copartic_w||'.';

	select	nextval('pls_lancamento_mensalidade_seq')
	into STRICT	nr_seq_lanc_manual_w
	;

	insert	into	pls_lancamento_mensalidade(	nr_sequencia, cd_estabelecimento, dt_ocorrencia,
			ie_tipo_item, nr_seq_motivo, dt_mes_competencia,
			dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
			nm_usuario_nrec, ds_observacao, vl_lancamento,
			dt_liberacao, nm_usuario_liberacao, nr_seq_segurado,
			ie_situacao)
		values (	nr_seq_lanc_manual_w, 1, dt_ocorrencia_w,
			'20', 3, to_date('01/04/2011'),
			clock_timestamp(), 'Tasy', clock_timestamp(),
			'Tasy', ds_observacao_w, vl_lancamento_manual_w,
			clock_timestamp(), 'Tasy', nr_seq_segurado_w,
			'A');

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_baca_coparticipacao () FROM PUBLIC;

