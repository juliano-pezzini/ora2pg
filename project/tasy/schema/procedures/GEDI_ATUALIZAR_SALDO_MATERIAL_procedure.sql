-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gedi_atualizar_saldo_material ( nr_seq_lote_p bigint, nm_usuario_p text, cd_material_p bigint default null) AS $body$
DECLARE

					
nr_atendimento_w		bigint;
cd_material_w			bigint;
qt_saldo_w			double precision;	
qt_total_dispensar_w		ap_lote_item.qt_total_dispensar%type;	
qt_dispensar_w			ap_lote_item.qt_dispensar%type;	
qt_diferenca_w			ap_lote_item.qt_dispensar%type;	
qt_horas_estabilidade_w		prescr_material.qt_horas_estabilidade%type;
nr_seq_mat_hor_w		prescr_mat_hor.nr_sequencia%type;

C01 CURSOR FOR
	SELECT	qt_saldo,
		nr_sequencia
	from	gedi_medic_atend
	where	ie_status	not in ('S','E')
	and		((coalesce(qt_horas_estabilidade_w,0) > 0 and (dt_fim_estabilidade IS NOT NULL AND dt_fim_estabilidade::text <> '') and clock_timestamp() between dt_fim_estabilidade - qt_horas_estabilidade_w/24 and dt_fim_estabilidade and dt_fim_estabilidade > clock_timestamp()) or (coalesce(qt_horas_estabilidade_w,0) = 0 and coalesce(dt_fim_estabilidade,clock_timestamp() + interval '1 days') > clock_timestamp()))		
	and		cd_material	= cd_material_w
	and		nr_atendimento	= nr_atendimento_w
	order by nr_sequencia;

BEGIN

select	max(a.nr_atendimento),
	max(b.cd_material),
	sum(coalesce(b.qt_dispensar,0)),
	sum(coalesce(b.qt_total_dispensar,0)),
	max(nr_seq_mat_hor)
into STRICT	nr_atendimento_w,
	cd_material_w,
	qt_dispensar_w,
	qt_total_dispensar_w,
	nr_seq_mat_hor_w
from	ap_lote a,
	ap_lote_item b
where	a.nr_sequencia 	= b.nr_seq_lote
and	a.nr_sequencia	= nr_seq_lote_p
and	b.cd_material	= cd_material_p;


qt_diferenca_w	:= qt_total_dispensar_w - qt_dispensar_w;


if (qt_diferenca_w	<> 0) then

	for r_c01 in c01 loop
		begin
		qt_saldo_w	:= r_c01.qt_saldo;
		
		if (qt_diferenca_w	> 0) then
			qt_saldo_w	:= qt_saldo_w - qt_diferenca_w;
		else
			qt_saldo_w	:= qt_saldo_w +  abs(qt_diferenca_w);
		end if;
		
		if (qt_saldo_w	< 0 ) then
			qt_saldo_w	:= 0;
		end if;

		update	gedi_medic_atend
		set	qt_saldo	= qt_saldo_w
		where	nr_sequencia 	= r_c01.nr_sequencia;

		end;
	end loop;

end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gedi_atualizar_saldo_material ( nr_seq_lote_p bigint, nm_usuario_p text, cd_material_p bigint default null) FROM PUBLIC;

