-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE wsuite_resend_activation_link ( nr_sequencia_p bigint, ie_resend_p text, ds_email text, ds_link_retrieve_p INOUT text, ds_from_email_p INOUT text, ds_logo_p INOUT text, ds_alternative_login_p INOUT text ) AS $body$
DECLARE

  nr_sequencia_w bigint;
  ie_resend_w    varchar(5);
  /* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
  finality:
  RA    Resend activation link Web Suite Management
  RP    Resend password link Websuite Management
  MPI   Resend password link master person index
  ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
BEGIN
  SELECT MAX(ds_url_logo_header_login)
  INTO STRICT ds_logo_p
  FROM wsuite_layout_client
  WHERE cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;
  IF (ie_resend_p          = 'RA') THEN
    ie_resend_w           :=ie_resend_p;
    SELECT a.nr_sequencia,
      a.ds_alternative_login
    INTO STRICT nr_sequencia_w,
      ds_alternative_login_p
    FROM wsuite_usuario a
    WHERE a.nr_seq_inclusao_pf = nr_sequencia_p;
  elsif (ie_resend_p           = 'RP') THEN
    BEGIN
      ie_resend_w    :=ie_resend_p;
      nr_sequencia_w := nr_sequencia_p;
      select a.ds_alternative_login
      INTO STRICT ds_alternative_login_p
      FROM wsuite_usuario a
      WHERE a.nr_sequencia = nr_sequencia_p;
    END;
  elsif (ie_resend_p = 'MPI') THEN
    BEGIN
      ie_resend_w :='RP';
      begin
      SELECT COALESCE(obter_email_pf(pf.cd_pessoa_fisica), tws_get_user_email(pf.nm_usuario), x.nm_usuario_web) ds_email
      into STRICT ds_alternative_login_p
      FROM	pessoa_fisica pf
      left join compl_pessoa_fisica cpf on pf.cd_pessoa_fisica = cpf.cd_pessoa_fisica,
      wsuite_usuario x
      WHERE pf.cd_pessoa_fisica = nr_sequencia_p
      and cpf.ie_tipo_complemento = 1
      and pf.cd_pessoa_fisica = x.cd_pessoa_fisica;
      exception
      when too_many_rows or no_data_found then
	ds_alternative_login_p := ds_email;
      end;

      SELECT MAX(a.nr_sequencia)
      INTO STRICT nr_sequencia_w
      FROM wsuite_usuario a
      WHERE cd_pessoa_fisica = nr_sequencia_p;
    END;
  END IF;
  SELECT * FROM wsuite_login_pck.wsuite_resend_activation_link(nr_sequencia_w, ie_resend_w, ds_from_email_p, ds_link_retrieve_p) INTO STRICT ds_from_email_p, ds_link_retrieve_p;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE wsuite_resend_activation_link ( nr_sequencia_p bigint, ie_resend_p text, ds_email text, ds_link_retrieve_p INOUT text, ds_from_email_p INOUT text, ds_logo_p INOUT text, ds_alternative_login_p INOUT text ) FROM PUBLIC;

