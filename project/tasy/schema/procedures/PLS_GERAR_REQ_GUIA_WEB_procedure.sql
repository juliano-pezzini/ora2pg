-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_req_guia_web (nr_seq_guia_p bigint, nr_seq_requisicao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_maquina_p bigint, id_maquina_p text, nr_seq_prestador_web_p bigint, nr_seq_motivo_prorrog_p bigint) AS $body$
DECLARE

		
nr_seq_guia_w			bigint;
ie_tipo_guia_w			varchar(10);
cd_medico_solicitante_w		varchar(10);
nr_seq_segurado_w		bigint;
nr_seq_prestador_w		bigint;
cd_especialidade_w	     	bigint;
ie_tipo_consulta_w		bigint;
ie_tipo_saida_w			varchar(1);
nm_recem_nascido_w		varchar(60);
dt_nasc_recem_nascido_w 	timestamp;
cd_senha_w			varchar(20);
ie_tipo_atend_tiss_w		varchar(2);
ie_carater_internacao_w		varchar(2);
ds_indicacao_clinica_w		varchar(4000);
nr_seq_clinica_w		bigint;
ie_regime_internacao_w		varchar(1);
nr_seq_tipo_acomodacao_w	bigint;
ds_biometria_w			varchar(4000);
ie_consulta_urgencia_w		varchar(1);
ie_tipo_gat_w			varchar(1);
dt_validade_senha_w		timestamp;
cd_senha_externa_w		varchar(20);
nr_seq_plano_w			bigint;
cd_guia_w			varchar(20);
dt_entrada_hospital_w		pls_requisicao.dt_entrada_hospital%type;
dt_alta_hospital_w		pls_requisicao.dt_alta_hospital%type;
nr_seq_cbo_saude_w		pls_guia_plano.nr_seq_cbo_saude%type;
ie_tipo_doenca_w		pls_diagnostico.ie_tipo_doenca%type;
ie_indicacao_acidente_w		pls_diagnostico.ie_indicacao_acidente%type;
cd_doenca_w			pls_diagnostico.cd_doenca%type;
ie_cobertura_especial_w		pls_guia_plano.ie_cobertura_especial%type;
ie_regime_atendimento_w		pls_guia_plano.ie_regime_atendimento%type;
ie_saude_ocupacional_w		pls_guia_plano.ie_saude_ocupacional%type;


BEGIN

if (nr_seq_guia_p IS NOT NULL AND nr_seq_guia_p::text <> '') then
	select	nr_sequencia,
		cd_medico_solicitante,
		nr_seq_segurado,
		nr_seq_prestador,
		cd_especialidade,
		ie_tipo_consulta,
		ie_tipo_saida,
		nm_recem_nascido,
		dt_nasc_recem_nascido,
		ie_tipo_atend_tiss,
		ie_carater_internacao,
		ds_indicacao_clinica,
		nr_seq_clinica,
		ie_regime_internacao,
		nr_seq_tipo_acomodacao,
		ds_biometria,
		ie_consulta_urgencia,
		ie_tipo_gat,
		dt_validade_senha,
		cd_senha_externa,
		cd_guia,
		nr_seq_cbo_saude,
		ie_cobertura_especial,
		ie_regime_atendimento, 
		ie_saude_ocupacional
	into STRICT	nr_seq_guia_w,
		cd_medico_solicitante_w,
		nr_seq_segurado_w,
		nr_seq_prestador_w,
		cd_especialidade_w,
		ie_tipo_consulta_w,
		ie_tipo_saida_w,
		nm_recem_nascido_w,
		dt_nasc_recem_nascido_w ,
		ie_tipo_atend_tiss_w,
		ie_carater_internacao_w	,
		ds_indicacao_clinica_w,
		nr_seq_clinica_w,
		ie_regime_internacao_w,
		nr_seq_tipo_acomodacao_w,
		ds_biometria_w,
		ie_consulta_urgencia_w,
		ie_tipo_gat_w,
		dt_validade_senha_w,
		cd_senha_externa_w,
		cd_guia_w,
		nr_seq_cbo_saude_w,
		ie_cobertura_especial_w, 
		ie_regime_atendimento_w, 
		ie_saude_ocupacional_w
	from 	pls_guia_plano
	where	nr_sequencia = nr_seq_guia_p;
	
	nr_seq_plano_w	:= pls_obter_produto_benef(nr_seq_segurado_w, clock_timestamp());
	
	if (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') then
	
		begin
			select	ie_tipo_doenca,
				ie_indicacao_acidente,
				cd_doenca
			into STRICT	ie_tipo_doenca_w,
				ie_indicacao_acidente_w,
				cd_doenca_w
			from	pls_diagnostico
			where	nr_seq_guia	= nr_seq_guia_w;
		exception
		when others then
			ie_tipo_doenca_w		:= null;
			ie_indicacao_acidente_w		:= null;
			cd_doenca_w			:= null;
		end;	
		
		CALL pls_gerar_requisicao_web(nr_seq_requisicao_p, clock_timestamp(), '8',
					 nr_seq_plano_w, cd_medico_solicitante_w, nr_seq_segurado_w,
					 nr_seq_prestador_w, cd_especialidade_w, ie_tipo_consulta_w,
					 ie_tipo_saida_w, nm_recem_nascido_w, dt_nasc_recem_nascido_w,
					 null, null, ie_tipo_doenca_w,
					 ie_indicacao_acidente_w, nr_seq_prestador_w, ie_tipo_atend_tiss_w,
					 ie_carater_internacao_w, cd_doenca_w, ds_indicacao_clinica_w,
					 nr_seq_clinica_w, ie_regime_internacao_w,nr_seq_tipo_acomodacao_w, 
					 ds_biometria_w, null, null, 
					 cd_estabelecimento_p, ie_consulta_urgencia_w,nr_seq_prestador_web_p, 
					 nm_usuario_p,  cd_senha_externa_w, ie_tipo_gat_w,
					 dt_validade_senha_w,cd_guia_w, null,
					 nr_seq_maquina_p, id_maquina_p, nr_seq_guia_w,
					 null, null, nr_seq_motivo_prorrog_p,null,
					 null, null, nr_seq_cbo_saude_w, null, null, null, null,
					 ie_cobertura_especial_w, ie_regime_atendimento_w, ie_saude_ocupacional_w);

		select	max(dt_internacao)
		into STRICT	dt_entrada_hospital_w
		from	pls_guia_atendimento
		where	nr_seq_guia = nr_seq_guia_w;
		
		select	max(dt_alta)
		into STRICT	dt_alta_hospital_w
		from	pls_guia_atendimento
		where	nr_seq_guia = nr_seq_guia_w;
		
		update	pls_requisicao
		set	dt_entrada_hospital = dt_entrada_hospital_w,
			dt_alta_hospital = dt_alta_hospital_w
		where	nr_sequencia = nr_seq_requisicao_p;
		
		commit;
	end if;
	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_req_guia_web (nr_seq_guia_p bigint, nr_seq_requisicao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_maquina_p bigint, id_maquina_p text, nr_seq_prestador_web_p bigint, nr_seq_motivo_prorrog_p bigint) FROM PUBLIC;

