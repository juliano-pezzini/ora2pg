-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cancelar_problema_saude (cd_pessoa_fisica_p bigint, nr_seq_problema_p bigint, nm_usuario_p text) AS $body$
DECLARE

  nr_seq_prog_partic_w       mprev_programa_partic.nr_sequencia%TYPE;
  nr_seq_prog_partic_mod_w   mprev_prog_partic_modulo.nr_sequencia%TYPE;
  nr_seq_programa_w          mprev_programa_partic.nr_seq_programa%TYPE;
  nr_seq_partic_ciclo_item_w mprev_partic_ciclo_item.nr_sequencia%TYPE;
  nr_seq_agendamento_w       mprev_agendamento.nr_sequencia%TYPE;
  c01 CURSOR FOR
    SELECT a.nr_sequencia,
           a.nr_seq_programa
    FROM   mprev_programa_partic a,
           mprev_participante b
    WHERE  b.cd_pessoa_fisica = cd_pessoa_fisica_p
           AND a.nr_seq_participante = b.nr_sequencia
           AND a.nr_seq_programa IN (SELECT d.nr_seq_programa_saude
                                     FROM   atend_prog_saude_probl c,
                                            atend_programa_saude d
                                     WHERE  c.nr_seq_prog_saude = d.nr_sequencia
                                            AND c.nr_seq_problema =
                                                nr_seq_problema_p
                                            AND c.cd_pessoa_fisica =
                                                cd_pessoa_fisica_p);
  c02 CURSOR FOR
    SELECT nr_sequencia
    FROM   mprev_prog_partic_modulo a
    WHERE  a.nr_seq_programa_partic = nr_seq_prog_partic_w
           AND coalesce(a.dt_cancelamento::text, '') = '';
  c03 CURSOR FOR
    SELECT a.nr_sequencia
    FROM   mprev_partic_ciclo_item_v a
    WHERE  a.ie_status <> 'R'
           AND a.nr_seq_programa = nr_seq_programa_w
           AND a.cd_pessoa_fisica = cd_pessoa_fisica_p;
  c04 CURSOR FOR
    SELECT nr_sequencia
    FROM   mprev_agendamento
    WHERE  nr_seq_partic_ciclo_item = nr_seq_partic_ciclo_item_w;

BEGIN
    IF (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '' AND nr_seq_problema_p IS NOT NULL AND nr_seq_problema_p::text <> '') THEN
      OPEN c01;

      LOOP
          FETCH c01 INTO nr_seq_prog_partic_w, nr_seq_programa_w;

          EXIT WHEN NOT FOUND; /* apply on c01 */

          UPDATE mprev_programa_partic
          SET    dt_exclusao = clock_timestamp()
          WHERE  nr_sequencia = nr_seq_prog_partic_w;

          OPEN c02;

          LOOP
              FETCH c02 INTO nr_seq_prog_partic_mod_w;

              EXIT WHEN NOT FOUND; /* apply on c02 */

              CALL Mprev_cancelar_mod_partic(nr_seq_prog_partic_mod_w, NULL,
              nm_usuario_p
              );
          END LOOP;

          CLOSE c02;

          OPEN c03;

          LOOP
              FETCH c03 INTO nr_seq_partic_ciclo_item_w;

              EXIT WHEN NOT FOUND; /* apply on c03 */

              CALL Mprev_alterar_status_plano(nr_seq_partic_ciclo_item_w, 'C', NULL,
              NULL
              ,
              NULL
              ,
              NULL, cd_pessoa_fisica_p, nm_usuario_p);

              OPEN c04;

              LOOP
                  FETCH c04 INTO nr_seq_agendamento_w;
                  EXIT WHEN NOT FOUND; /* apply on c04 */
                    CALL Mprev_cancelar_agendamento(nr_seq_agendamento_w, NULL, NULL,
                    NULL,
                    NULL,
                    NULL,
                    nm_usuario_p);
              END LOOP;

              CLOSE c04;
          END LOOP;

          CLOSE c03;
      END LOOP;

      CLOSE c01;
    END IF;

    COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cancelar_problema_saude (cd_pessoa_fisica_p bigint, nr_seq_problema_p bigint, nm_usuario_p text) FROM PUBLIC;

