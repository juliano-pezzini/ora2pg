-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE campos AS (vl_mes 	double precision);
CREATE TYPE filtro AS (	nr_sequencia	bigint);


CREATE OR REPLACE PROCEDURE w_gerar_w_res_centro_controle ( cd_empresa_p bigint, cd_estab_p bigint, cd_centro_controle_p text, nr_meses_p bigint, cd_tabela_custo_p bigint, nr_seq_tabela_p bigint, ie_relatorio_p text, ie_centro_resultado_p text, ie_centro_superior_p text, cd_centro_superior_p text, nr_seq_ng_p text, cd_classificacao_p text, ie_tipo_relat_ng_p text, nr_seq_gng_p text, ie_tipo_centro_controle_p text, ie_tipo_gasto_p text, ie_totalizar_centro_p text, ie_zero_p text, ie_result_orc_p text, ie_somente_ativo_p text, ie_centro_atual_p text, ie_ordem_inversa_p text, nm_usuario_p text, nr_seq_unid_neg_p bigint) AS $body$
DECLARE


/*NATUREZAS E GRUPOS SERAO PASSADAS NO RELATORIO @SQL_WHERE*/

type Rec_Liquida is table of campos index by integer;

type Rec_Liquida_orc is table of campos index by integer;
type Natureza_orc is table of campos index by integer;
type reg_filtro is table of filtro index by integer;

cd_centro_controle_w				bigint;
cd_estabelecimento_w				bigint;
ds_classif_conta_w				varchar(40);
ds_filtro_ng_w					varchar(2000);
ds_filtro_gng_w					varchar(2000);
ds_filtro_centro_w				varchar(2000);
ie_centro_resultado_w				varchar(1)	:= ie_centro_resultado_p;
ie_centro_superior_w				varchar(1);
ie_classif_conta_w				smallint;
ie_emite_w					varchar(01);
ie_natureza_gasto_w				varchar(01)	:= 'X';
ie_tipo_centro_w				smallint;
nr_sequencia_w					bigint;

dt_inicial_w					timestamp;
dt_final_w					timestamp;
dt_mes_referencia_w				timestamp;
ds_comando_w					varchar(4000);
ds_comando_mes_w				varchar(2000);
vl_mes_w					double precision;
vl_total_w					double precision;
vl_total_rec_w					double precision;
vl_media_w					double precision;
vl_media_rec_w					double precision;
cd_natureza_gasto_w				numeric(20);
ds_natureza_gasto_w				varchar(255);
ie_receita_liquida_w				varchar(01);
ie_emite_perc_w					varchar(01);

rec_liquida_w					Rec_Liquida;
Rec_Liquida_orc_w				Rec_Liquida_orc;
Natureza_orc_w					Natureza_orc;
filtro_ng_w					reg_filtro;
filtro_gng_w					reg_filtro;
filtro_classif_w				reg_filtro;


ie_orcado_real_w				varchar(01);
cd_empresa_w					smallint;
ie_tipo_indicador_w				bigint;
ds_tipo_indicador_w				varchar(100);
nr_seq_indicador_w				bigint;
ds_indicador_w					varchar(50);
ds_comando_mes_orc_w				varchar(2000);
i						integer;
j						integer;
nr_seq_w					bigint	:= 0;
nr_seq_centro_w					bigint	:= 0;
nr_seq_classif_w				bigint	:= 0;
ie_gerar_w					varchar(1);

ie_pos_w					bigint;
qt_reg_w					bigint;
nr_meses_w					bigint;
/*ie_receita_liquida_w			varchar2(1);
ie_emite_perc_w				varchar2(1);*/
qt_disp_w					bigint;
vl_custo_w					double precision;
vl_media_ww					double precision;
cd_centro_superior_w				varchar(2000);
ds_centro_controle_w				varchar(4000);

c00 CURSOR FOR
SELECT	a.cd_estabelecimento
from	estabelecimento a
where	a.cd_empresa		= cd_empresa_p
and	((a.cd_estabelecimento	= cd_estab_p) or (cd_estab_p =0));

c01 CURSOR FOR
SELECT	distinct
	c.cd_estabelecimento,
	c.cd_centro_controle,
	c.ds_centro_controle,
	c.ie_tipo_centro_controle,
	c.nr_seq_unid_neg,
	c.ie_centro_resultado,
	c.ie_situacao,
	c.cd_centro_controle_pai
from	tabela_custo d,
	centro_controle c,
	classif_result b,
	resultado_centro_controle a
where	a.cd_estabelecimento	= c.cd_estabelecimento
and	a.cd_centro_controle	= c.cd_centro_controle
and	a.cd_estabelecimento	= coalesce(d.cd_estabelecimento, a.cd_estabelecimento)
and	d.cd_empresa		= cd_empresa_p
and	a.nr_seq_tabela		= d.nr_sequencia
and	a.nr_seq_tabela		= d.nr_sequencia
and	a.ie_classif_conta	= b.cd_classificacao
and	b.cd_empresa		= cd_empresa_p
and	d.ie_orcado_real	= ie_orcado_real_w
and	d.dt_mes_referencia between dt_inicial_w and dt_final_w
and	c.cd_estabelecimento	= cd_estabelecimento_w
and	((ie_centro_resultado_w = 'N') or (c.ie_centro_resultado = ie_centro_resultado_w))
order by c.ds_centro_controle;

vet01	C01%rowtype;
type centro is table of C01%rowtype index by integer;
centro_w					centro;

c02 CURSOR FOR
SELECT	distinct
	b.cd_classificacao,
	b.ds_classificacao,
	b.ie_emite,
	b.ie_receita_liquida,
	b.ie_emite_perc
from	tabela_custo d,
	centro_controle c,
	classif_result b,
	resultado_centro_controle a
where	a.cd_estabelecimento	= coalesce(d.cd_estabelecimento, a.cd_estabelecimento)
and	d.cd_empresa		= cd_empresa_p
and	a.cd_tabela_custo	= d.cd_tabela_custo
and	a.nr_seq_tabela		= d.nr_sequencia
and	b.cd_classificacao	= a.ie_classif_conta
and	c.cd_centro_controle	= a.cd_centro_controle
and	c.cd_estabelecimento	= a.cd_estabelecimento
and	b.cd_empresa		= cd_empresa_p
and	a.cd_estabelecimento	= cd_estabelecimento_w
--and 	b.ie_emite              <> 'N'
and	d.ie_orcado_real	= ie_orcado_real_w
and	c.cd_centro_controle	= cd_centro_controle_w
and	d.dt_mes_referencia between dt_inicial_w and dt_final_w
order by	b.cd_classificacao;

vet02		C02%rowtype;
type classif	is table of C02%rowtype index by integer;
classif_w					classif;

c03 CURSOR FOR
SELECT	y.nr_seq_ng,
	y.ds_natureza_gasto,
	y.nr_seq_gng,
	y.ds_grupo_natureza_gasto,
	null ie_tipo_gasto,
	coalesce(sum(y.vl_mes_12),0) vl_mes_12,
	coalesce(sum(y.vl_mes_11),0) vl_mes_11,
	coalesce(sum(y.vl_mes_10),0) vl_mes_10,
	coalesce(sum(y.vl_mes_09),0) vl_mes_09,
	coalesce(sum(y.vl_mes_08),0) vl_mes_08,
	coalesce(sum(y.vl_mes_07),0) vl_mes_07,
	coalesce(sum(y.vl_mes_06),0) vl_mes_06,
	coalesce(sum(y.vl_mes_05),0) vl_mes_05,
	coalesce(sum(y.vl_mes_04),0) vl_mes_04,
	coalesce(sum(y.vl_mes_03),0) vl_mes_03,
	coalesce(sum(y.vl_mes_02),0) vl_mes_02,
	coalesce(sum(y.vl_mes_01),0) vl_mes_01
from	(
	SELECT	/*+INDEX (A RESCECO_UK)*/		e.nr_sequencia nr_seq_ng,
		e.ds_natureza_gasto,
		f.nr_sequencia nr_seq_gng,
		f.ds_grupo_natureza_gasto,
		a.ie_tipo_gasto,
		CASE WHEN d.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN 000 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-1)*-1) END ) THEN a.vl_mes  ELSE 0 END  vl_mes_01,
		CASE WHEN d.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -01 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-2)*-1) END ) THEN a.vl_mes  ELSE 0 END  vl_mes_02,
		CASE WHEN d.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -02 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-3)*-1) END ) THEN a.vl_mes  ELSE 0 END  vl_mes_03,
		CASE WHEN d.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -03 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-4)*-1) END ) THEN a.vl_mes  ELSE 0 END  vl_mes_04,
		CASE WHEN d.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -04 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-5)*-1) END ) THEN a.vl_mes  ELSE 0 END  vl_mes_05,
		CASE WHEN d.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -05 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-6)*-1) END ) THEN a.vl_mes  ELSE 0 END  vl_mes_06,
		CASE WHEN d.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -06 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-7)*-1) END ) THEN a.vl_mes  ELSE 0 END  vl_mes_07,
		CASE WHEN d.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -07 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-8)*-1) END ) THEN a.vl_mes  ELSE 0 END  vl_mes_08,
		CASE WHEN d.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -08 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-9)*-1) END ) THEN a.vl_mes  ELSE 0 END  vl_mes_09,
		CASE WHEN d.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -09 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-10)*-1) END ) THEN a.vl_mes  ELSE 0 END  vl_mes_10,
		CASE WHEN d.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -10 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-11)*-1) END ) THEN a.vl_mes  ELSE 0 END  vl_mes_11,
		CASE WHEN d.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -11 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-12)*-1) END ) THEN a.vl_mes  ELSE 0 END  vl_mes_12
	from	grupo_natureza_gasto f,
		natureza_gasto e,
		tabela_custo d,
		centro_controle c,
		classif_result b,
		resultado_centro_controle a
	where	a.cd_estabelecimento	= coalesce(d.cd_estabelecimento, a.cd_estabelecimento)
	and	d.cd_empresa		= cd_empresa_p
	and	a.cd_tabela_custo	= d.cd_tabela_custo
	and	a.nr_seq_tabela		= d.nr_sequencia
	and	b.cd_classificacao	= a.ie_classif_conta
	and	c.cd_centro_controle	= a.cd_centro_controle
	and	c.cd_estabelecimento	= a.cd_estabelecimento
	and	e.nr_sequencia		= a.nr_seq_ng
	and	a.cd_estabelecimento	= coalesce(e.cd_estabelecimento, a.cd_estabelecimento)
	and	e.cd_empresa		= b.cd_empresa
	and	e.cd_empresa		= f.cd_empresa
	and	e.nr_seq_gng		= f.nr_sequencia
	and	a.cd_estabelecimento	= coalesce(f.cd_estabelecimento, a.cd_estabelecimento)
	and	b.cd_empresa		= cd_empresa_p
	and	a.cd_estabelecimento	= cd_estabelecimento_w
	and 	b.ie_emite              in ('G','C')
	and	d.ie_orcado_real	= ie_orcado_real_w
	and	c.cd_centro_controle	= cd_centro_controle_w
	and	b.cd_classificacao	= ie_classif_conta_w
	and (e.ie_natureza_gasto	= ie_natureza_gasto_w or ie_natureza_gasto_w = 'X')
	and	d.dt_mes_referencia between dt_inicial_w and dt_final_w) y
where	1 = 1
group	by y.nr_seq_ng,
	y.ds_natureza_gasto,
	y.nr_seq_gng,
	y.ds_grupo_natureza_gasto;


vet03		C03%rowtype;
type natureza	is table of C03%rowtype index by integer;
natureza_w					natureza;
type valores 	is table of W_RESULT_CENTRO_CONTROLE%rowtype index by integer;
valores_w	valores;

C04 CURSOR FOR
SELECT	coalesce(sum(y.vl_mes_12),0) vl_mes_12,
	coalesce(sum(y.vl_mes_11),0) vl_mes_11,
	coalesce(sum(y.vl_mes_10),0) vl_mes_10,
	coalesce(sum(y.vl_mes_09),0) vl_mes_09,
	coalesce(sum(y.vl_mes_08),0) vl_mes_08,
	coalesce(sum(y.vl_mes_07),0) vl_mes_07,
	coalesce(sum(y.vl_mes_06),0) vl_mes_06,
	coalesce(sum(y.vl_mes_05),0) vl_mes_05,
	coalesce(sum(y.vl_mes_04),0) vl_mes_04,
	coalesce(sum(y.vl_mes_03),0) vl_mes_03,
	coalesce(sum(y.vl_mes_02),0) vl_mes_02,
	coalesce(sum(y.vl_mes_01),0) vl_mes_01
from	(
	SELECT	/*+INDEX (A RESCECO_UK)*/		CASE WHEN d.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN 000 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-1)*-1) END ) THEN a.vl_mes  ELSE 0 END  vl_mes_01,
		CASE WHEN d.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -01 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-2)*-1) END ) THEN a.vl_mes  ELSE 0 END  vl_mes_02,
		CASE WHEN d.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -02 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-3)*-1) END ) THEN a.vl_mes  ELSE 0 END  vl_mes_03,
		CASE WHEN d.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -03 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-4)*-1) END ) THEN a.vl_mes  ELSE 0 END  vl_mes_04,
		CASE WHEN d.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -04 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-5)*-1) END ) THEN a.vl_mes  ELSE 0 END  vl_mes_05,
		CASE WHEN d.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -05 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-6)*-1) END ) THEN a.vl_mes  ELSE 0 END  vl_mes_06,
		CASE WHEN d.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -06 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-7)*-1) END ) THEN a.vl_mes  ELSE 0 END  vl_mes_07,
		CASE WHEN d.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -07 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-8)*-1) END ) THEN a.vl_mes  ELSE 0 END  vl_mes_08,
		CASE WHEN d.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -08 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-9)*-1) END ) THEN a.vl_mes  ELSE 0 END  vl_mes_09,
		CASE WHEN d.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -09 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-10)*-1) END ) THEN a.vl_mes  ELSE 0 END  vl_mes_10,
		CASE WHEN d.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -10 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-11)*-1) END ) THEN a.vl_mes  ELSE 0 END  vl_mes_11,
		CASE WHEN d.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -11 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-12)*-1) END ) THEN a.vl_mes  ELSE 0 END  vl_mes_12
	from	tabela_custo d,
		centro_controle c,
		classif_result b,
		resultado_centro_controle a
	where	a.cd_estabelecimento	= coalesce(d.cd_estabelecimento, a.cd_estabelecimento)
	and	d.cd_empresa		= cd_empresa_p
	and	a.cd_tabela_custo	= d.cd_tabela_custo
	and	a.nr_seq_tabela		= d.nr_sequencia
	and	b.cd_classificacao	= a.ie_classif_conta
	and	c.cd_centro_controle	= a.cd_centro_controle
	and	c.cd_estabelecimento	= a.cd_estabelecimento
	and	d.cd_empresa	 	= b.cd_empresa
	and	b.cd_empresa		= cd_empresa_p
	and	a.cd_estabelecimento	= cd_estabelecimento_w
	and 	b.ie_emite		in ('N','S','C')
	and	d.ie_orcado_real	= ie_orcado_real_w
	and	c.cd_centro_controle	= cd_centro_controle_w
	and	b.cd_classificacao	= ie_classif_conta_w
	and	d.dt_mes_referencia between dt_inicial_w and dt_final_w) y
where	1 = 1;

vet04		C04%rowtype;

C05 CURSOR FOR
SELECT	y.cd_centro_controle,
	y.ds_centro_controle,
	coalesce(sum(y.vl_mes_12),0) vl_mes_12,
	coalesce(sum(y.vl_mes_11),0) vl_mes_11,
	coalesce(sum(y.vl_mes_10),0) vl_mes_10,
	coalesce(sum(y.vl_mes_09),0) vl_mes_09,
	coalesce(sum(y.vl_mes_08),0) vl_mes_08,
	coalesce(sum(y.vl_mes_07),0) vl_mes_07,
	coalesce(sum(y.vl_mes_06),0) vl_mes_06,
	coalesce(sum(y.vl_mes_05),0) vl_mes_05,
	coalesce(sum(y.vl_mes_04),0) vl_mes_04,
	coalesce(sum(y.vl_mes_03),0) vl_mes_03,
	coalesce(sum(y.vl_mes_02),0) vl_mes_02,
	coalesce(sum(y.vl_mes_01),0) vl_mes_01
from	(
	SELECT	d.cd_centro_controle,
		d.ds_centro_controle,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN 000 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-1)*-1) END ) THEN a.vl_distribuido  ELSE 0 END  vl_mes_01,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -01 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-2)*-1) END ) THEN a.vl_distribuido  ELSE 0 END  vl_mes_02,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -02 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-3)*-1) END ) THEN a.vl_distribuido  ELSE 0 END  vl_mes_03,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -03 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-4)*-1) END ) THEN a.vl_distribuido  ELSE 0 END  vl_mes_04,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -04 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-5)*-1) END ) THEN a.vl_distribuido  ELSE 0 END  vl_mes_05,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -05 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-6)*-1) END ) THEN a.vl_distribuido  ELSE 0 END  vl_mes_06,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -06 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-7)*-1) END ) THEN a.vl_distribuido  ELSE 0 END  vl_mes_07,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -07 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-8)*-1) END ) THEN a.vl_distribuido  ELSE 0 END  vl_mes_08,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -08 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-9)*-1) END ) THEN a.vl_distribuido  ELSE 0 END  vl_mes_09,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -09 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-10)*-1) END ) THEN a.vl_distribuido  ELSE 0 END  vl_mes_10,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -10 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-11)*-1) END ) THEN a.vl_distribuido  ELSE 0 END  vl_mes_11,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -11 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-12)*-1) END ) THEN a.vl_distribuido  ELSE 0 END  vl_mes_12
	from	centro_controle d,
		centro_controle c,
		orcamento_distribuido a,
		tabela_custo b
	where	a.cd_estab_dest			= cd_estabelecimento_w
	and	a.cd_centro_controle_dest	= cd_centro_controle_w
	and	d.cd_classif_result		= ie_classif_conta_w
	and	a.cd_tabela_custo		= b.cd_tabela_custo
	and	a.nr_seq_tabela			= b.nr_sequencia
	and	a.cd_estabelecimento		= coalesce(b.cd_estabelecimento, a.cd_estabelecimento)
	and	b.cd_empresa			= cd_empresa_p
	and	a.cd_estabelecimento		= d.cd_estabelecimento
	and	a.cd_centro_controle		= d.cd_centro_controle
	and	a.cd_estab_dest			= c.cd_estabelecimento
	and	a.cd_centro_controle_dest	= c.cd_centro_controle
	and	b.dt_mes_referencia 		between dt_inicial_w and dt_final_w
	and	b.ie_orcado_real		= ie_orcado_real_w) y
group by y.cd_centro_controle,
         y.ds_centro_controle
order by y.ds_centro_controle;

vet05		c05%rowtype;

C06 CURSOR FOR
SELECT	3 ie_tipo_indicador,
	substr(Wheb_mensagem_pck.get_texto(299224),1,50) ds_tipo_indicador,
	y.nr_seq_indicador,
	y.ds_indicador,
	coalesce(sum(y.vl_mes_12),0) vl_mes_12,
	coalesce(sum(y.vl_mes_11),0) vl_mes_11,
	coalesce(sum(y.vl_mes_10),0) vl_mes_10,
	coalesce(sum(y.vl_mes_09),0) vl_mes_09,
	coalesce(sum(y.vl_mes_08),0) vl_mes_08,
	coalesce(sum(y.vl_mes_07),0) vl_mes_07,
	coalesce(sum(y.vl_mes_06),0) vl_mes_06,
	coalesce(sum(y.vl_mes_05),0) vl_mes_05,
	coalesce(sum(y.vl_mes_04),0) vl_mes_04,
	coalesce(sum(y.vl_mes_03),0) vl_mes_03,
	coalesce(sum(y.vl_mes_02),0) vl_mes_02,
	coalesce(sum(y.vl_mes_01),0) vl_mes_01
from 	(
	SELECT	a.nr_seq_indicador,
		b.ds_indicador,
		CASE WHEN c.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN 000 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-1)*-1) END ) THEN a.vl_indicador  ELSE 0 END  vl_mes_01,
		CASE WHEN c.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -01 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-2)*-1) END ) THEN a.vl_indicador  ELSE 0 END  vl_mes_02,
		CASE WHEN c.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -02 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-3)*-1) END ) THEN a.vl_indicador  ELSE 0 END  vl_mes_03,
		CASE WHEN c.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -03 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-4)*-1) END ) THEN a.vl_indicador  ELSE 0 END  vl_mes_04,
		CASE WHEN c.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -04 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-5)*-1) END ) THEN a.vl_indicador  ELSE 0 END  vl_mes_05,
		CASE WHEN c.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -05 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-6)*-1) END ) THEN a.vl_indicador  ELSE 0 END  vl_mes_06,
		CASE WHEN c.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -06 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-7)*-1) END ) THEN a.vl_indicador  ELSE 0 END  vl_mes_07,
		CASE WHEN c.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -07 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-8)*-1) END ) THEN a.vl_indicador  ELSE 0 END  vl_mes_08,
		CASE WHEN c.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -08 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-9)*-1) END ) THEN a.vl_indicador  ELSE 0 END  vl_mes_09,
		CASE WHEN c.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -09 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-10)*-1) END ) THEN a.vl_indicador  ELSE 0 END  vl_mes_10,
		CASE WHEN c.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -10 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-11)*-1) END ) THEN a.vl_indicador  ELSE 0 END  vl_mes_11,
		CASE WHEN c.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -11 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-12)*-1) END ) THEN a.vl_indicador  ELSE 0 END  vl_mes_12
	from	centro_controle e,
		centro_controle_indicador d,
		resultado_ind_cen_cont a,
		resultado_indicador b,
		tabela_custo c
	where 	a.cd_estabelecimento		= cd_estabelecimento_w
	and 	c.dt_mes_referencia		between dt_inicial_w and dt_final_w
	and 	a.cd_tabela_custo		= c.cd_tabela_custo
	and 	a.nr_seq_indicador		= b.nr_sequencia
	and 	a.cd_estabelecimento		= d.cd_estabelecimento
	and 	a.cd_centro_controle		= d.cd_centro_controle
	and 	a.nr_seq_indicador		= d.nr_seq_indicador
	and	e.cd_centro_controle		= cd_centro_controle_w
	and	c.ie_orcado_real	        = ie_orcado_real_w
	and	a.cd_centro_controle		= e.cd_centro_controle
	and	e.cd_estabelecimento		= a.cd_estabelecimento
	and	a.vl_indicador <> 0) y
group by y.nr_seq_indicador, y.ds_indicador;

vet06		c06%rowtype;

C07 CURSOR FOR
SELECT	4 ie_tipo_indicador,
	substr(Wheb_mensagem_pck.get_texto(299228),1,50) ds_tipo_indicador,
	y.nr_seq_indicador,
	y.ds_indicador,
	coalesce(sum(y.vl_mes_12),0) vl_mes_12,
	coalesce(sum(y.vl_mes_11),0) vl_mes_11,
	coalesce(sum(y.vl_mes_10),0) vl_mes_10,
	coalesce(sum(y.vl_mes_09),0) vl_mes_09,
	coalesce(sum(y.vl_mes_08),0) vl_mes_08,
	coalesce(sum(y.vl_mes_07),0) vl_mes_07,
	coalesce(sum(y.vl_mes_06),0) vl_mes_06,
	coalesce(sum(y.vl_mes_05),0) vl_mes_05,
	coalesce(sum(y.vl_mes_04),0) vl_mes_04,
	coalesce(sum(y.vl_mes_03),0) vl_mes_03,
	coalesce(sum(y.vl_mes_02),0) vl_mes_02,
	coalesce(sum(y.vl_mes_01),0) vl_mes_01
from 	(
	SELECT	a.nr_seq_indicador,
		b.ds_indicador,
		CASE WHEN z.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN 000 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-1)*-1) END ) THEN a.qt_indicador  ELSE 0 END  vl_mes_01,
		CASE WHEN z.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -01 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-2)*-1) END ) THEN a.qt_indicador  ELSE 0 END  vl_mes_02,
		CASE WHEN z.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -02 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-3)*-1) END ) THEN a.qt_indicador  ELSE 0 END  vl_mes_03,
		CASE WHEN z.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -03 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-4)*-1) END ) THEN a.qt_indicador  ELSE 0 END  vl_mes_04,
		CASE WHEN z.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -04 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-5)*-1) END ) THEN a.qt_indicador  ELSE 0 END  vl_mes_05,
		CASE WHEN z.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -05 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-6)*-1) END ) THEN a.qt_indicador  ELSE 0 END  vl_mes_06,
		CASE WHEN z.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -06 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-7)*-1) END ) THEN a.qt_indicador  ELSE 0 END  vl_mes_07,
		CASE WHEN z.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -07 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-8)*-1) END ) THEN a.qt_indicador  ELSE 0 END  vl_mes_08,
		CASE WHEN z.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -08 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-9)*-1) END ) THEN a.qt_indicador  ELSE 0 END  vl_mes_09,
		CASE WHEN z.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -09 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-10)*-1) END ) THEN a.qt_indicador  ELSE 0 END  vl_mes_10,
		CASE WHEN z.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -10 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-11)*-1) END ) THEN a.qt_indicador  ELSE 0 END  vl_mes_11,
		CASE WHEN z.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -11 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-12)*-1) END ) THEN a.qt_indicador  ELSE 0 END  vl_mes_12
	from 	resultado_ind_cen_cont a,
     		resultado_indicador b,
     		tabela_custo z
	where 	a.cd_estabelecimento		= cd_estabelecimento_w
	and 	a.cd_centro_controle     	= cd_centro_controle_w
	and 	a.nr_seq_indicador		= b.nr_sequencia
  	and 	a.nr_seq_tabela			= z.nr_sequencia
	and	a.cd_estabelecimento		= coalesce(z.cd_estabelecimento, a.cd_estabelecimento)
	and 	z.dt_mes_referencia		between dt_inicial_w and dt_final_w
  	and	z.ie_orcado_real		= ie_orcado_real_w
	and	z.cd_empresa			= cd_empresa_p
  	and	a.qt_indicador <> 0) y
	group by y.nr_seq_indicador, y.ds_indicador;
vet07		c07%rowtype;

C08 CURSOR FOR
SELECT 5 ie_tipo_indicador,
	substr(Wheb_mensagem_pck.get_texto(299229),1,50) ds_tipo_indicador,
       	y.nr_seq_indicador,
       	y.ds_indicador,
	coalesce(sum(y.vl_mes_12),0) vl_mes_12,
	coalesce(sum(y.vl_mes_11),0) vl_mes_11,
	coalesce(sum(y.vl_mes_10),0) vl_mes_10,
	coalesce(sum(y.vl_mes_09),0) vl_mes_09,
	coalesce(sum(y.vl_mes_08),0) vl_mes_08,
	coalesce(sum(y.vl_mes_07),0) vl_mes_07,
	coalesce(sum(y.vl_mes_06),0) vl_mes_06,
	coalesce(sum(y.vl_mes_05),0) vl_mes_05,
	coalesce(sum(y.vl_mes_04),0) vl_mes_04,
	coalesce(sum(y.vl_mes_03),0) vl_mes_03,
	coalesce(sum(y.vl_mes_02),0) vl_mes_02,
	coalesce(sum(y.vl_mes_01),0) vl_mes_01,
	coalesce(sum(y.vl_custo_12),0) vl_custo_12,
	coalesce(sum(y.vl_custo_11),0) vl_custo_11,
	coalesce(sum(y.vl_custo_10),0) vl_custo_10,
	coalesce(sum(y.vl_custo_09),0) vl_custo_09,
	coalesce(sum(y.vl_custo_08),0) vl_custo_08,
	coalesce(sum(y.vl_custo_07),0) vl_custo_07,
	coalesce(sum(y.vl_custo_06),0) vl_custo_06,
	coalesce(sum(y.vl_custo_05),0) vl_custo_05,
	coalesce(sum(y.vl_custo_04),0) vl_custo_04,
	coalesce(sum(y.vl_custo_03),0) vl_custo_03,
	coalesce(sum(y.vl_custo_02),0) vl_custo_02,
	coalesce(sum(y.vl_custo_01),0) vl_custo_01,
	coalesce(max(y.qt_disp_12),0) qt_disp_12,
	coalesce(max(y.qt_disp_11),0) qt_disp_11,
	coalesce(max(y.qt_disp_10),0) qt_disp_10,
	coalesce(max(y.qt_disp_09),0) qt_disp_09,
	coalesce(max(y.qt_disp_08),0) qt_disp_08,
	coalesce(max(y.qt_disp_07),0) qt_disp_07,
	coalesce(max(y.qt_disp_06),0) qt_disp_06,
	coalesce(max(y.qt_disp_05),0) qt_disp_05,
	coalesce(max(y.qt_disp_04),0) qt_disp_04,
	coalesce(max(y.qt_disp_03),0) qt_disp_03,
	coalesce(max(y.qt_disp_02),0) qt_disp_02,
	coalesce(max(y.qt_disp_01),0) qt_disp_01,
	coalesce(sum(vl_custo),0) vl_custo,
	coalesce(max(qt_disponibilidade),0) qt_disponibilidade
from	(
	SELECT	c.cd_centro_controle nr_seq_indicador,
		c.ds_centro_controle ds_indicador,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN 000 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-1)*-1) END ) THEN a.vl_taxa_custo  ELSE 0 END  	vl_mes_01,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -01 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-2)*-1) END ) THEN a.vl_taxa_custo  ELSE 0 END  	vl_mes_02,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -02 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-3)*-1) END ) THEN a.vl_taxa_custo  ELSE 0 END  	vl_mes_03,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -03 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-4)*-1) END ) THEN a.vl_taxa_custo  ELSE 0 END  	vl_mes_04,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -04 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-5)*-1) END ) THEN a.vl_taxa_custo  ELSE 0 END  	vl_mes_05,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -05 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-6)*-1) END ) THEN a.vl_taxa_custo  ELSE 0 END  	vl_mes_06,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -06 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-7)*-1) END ) THEN a.vl_taxa_custo  ELSE 0 END  	vl_mes_07,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -07 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-8)*-1) END ) THEN a.vl_taxa_custo  ELSE 0 END  	vl_mes_08,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -08 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-9)*-1) END ) THEN a.vl_taxa_custo  ELSE 0 END  	vl_mes_09,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -09 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-10)*-1) END ) THEN a.vl_taxa_custo  ELSE 0 END  	vl_mes_10,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -10 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-11)*-1) END ) THEN a.vl_taxa_custo  ELSE 0 END  	vl_mes_11,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -11 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-12)*-1) END ) THEN a.vl_taxa_custo  ELSE 0 END  	vl_mes_12,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN 000 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-1)*-1) END ) THEN a.vl_custo  ELSE 0 END  		vl_custo_01,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -01 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-2)*-1) END ) THEN a.vl_custo  ELSE 0 END  		vl_custo_02,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -02 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-3)*-1) END ) THEN a.vl_custo  ELSE 0 END  		vl_custo_03,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -03 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-4)*-1) END ) THEN a.vl_custo  ELSE 0 END  		vl_custo_04,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -04 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-5)*-1) END ) THEN a.vl_custo  ELSE 0 END  		vl_custo_05,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -05 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-6)*-1) END ) THEN a.vl_custo  ELSE 0 END  		vl_custo_06,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -06 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-7)*-1) END ) THEN a.vl_custo  ELSE 0 END  		vl_custo_07,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -07 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-8)*-1) END ) THEN a.vl_custo  ELSE 0 END  		vl_custo_08,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -08 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-9)*-1) END ) THEN a.vl_custo  ELSE 0 END  		vl_custo_09,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -09 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-10)*-1) END ) THEN a.vl_custo  ELSE 0 END  		vl_custo_10,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -10 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-11)*-1) END ) THEN a.vl_custo  ELSE 0 END  		vl_custo_11,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -11 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-12)*-1) END ) THEN a.vl_custo  ELSE 0 END  		vl_custo_12,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN 000 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-1)*-1) END ) THEN a.qt_disponibilidade  ELSE 0 END  	qt_disp_01,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -01 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-2)*-1) END ) THEN a.qt_disponibilidade  ELSE 0 END  	qt_disp_02,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -02 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-3)*-1) END ) THEN a.qt_disponibilidade  ELSE 0 END  	qt_disp_03,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -03 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-4)*-1) END ) THEN a.qt_disponibilidade  ELSE 0 END  	qt_disp_04,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -04 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-5)*-1) END ) THEN a.qt_disponibilidade  ELSE 0 END  	qt_disp_05,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -05 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-6)*-1) END ) THEN a.qt_disponibilidade  ELSE 0 END  	qt_disp_06,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -06 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-7)*-1) END ) THEN a.qt_disponibilidade  ELSE 0 END  	qt_disp_07,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -07 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-8)*-1) END ) THEN a.qt_disponibilidade  ELSE 0 END  	qt_disp_08,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -08 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-9)*-1) END ) THEN a.qt_disponibilidade  ELSE 0 END  	qt_disp_09,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -09 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-10)*-1) END ) THEN a.qt_disponibilidade  ELSE 0 END  	qt_disp_10,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -10 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-11)*-1) END ) THEN a.qt_disponibilidade  ELSE 0 END  	qt_disp_11,
		CASE WHEN b.dt_mes_referencia=add_months(dt_final_w,CASE WHEN ie_Ordem_inversa_p='N' THEN -11 WHEN ie_Ordem_inversa_p='S' THEN ((nr_meses_p-12)*-1) END ) THEN a.qt_disponibilidade  ELSE 0 END 	qt_disp_12,
		a.vl_custo,
		a.qt_disponibilidade qt_disponibilidade
	from 	centro_controle c,
		tabela_custo b,
		taxa_custo a
	where 	a.cd_estabelecimento   		= coalesce(b.cd_estabelecimento, a.cd_estabelecimento)
	and	b.cd_empresa			= cd_empresa_p
	and	a.nr_seq_tabela			= b.nr_sequencia
	and 	a.cd_tabela_custo      		= b.cd_tabela_custo
  	and 	a.cd_estabelecimento		= c.cd_estabelecimento
  	and 	a.cd_centro_controle   		= c.cd_centro_controle
  	and 	c.cd_estabelecimento   		= cd_estabelecimento_w
	and 	b.dt_mes_referencia      	between dt_inicial_w and dt_final_w
	and	c.cd_centro_controle		= cd_centro_controle_w
	and	b.ie_orcado_real		= ie_orcado_real_w
	and 	a.cd_centro_controle		= c.cd_centro_controle) y
	group 	by 	y.nr_seq_indicador,
			y.ds_indicador
	order 	by 1;
vet08		c08%rowtype;

c09 CURSOR FOR
SELECT	CASE WHEN cd_estab_p=0 THEN 0  ELSE cd_estabelecimento END  cd_estabelecimento,
	99999999 cd_centro_controle,
	substr(CASE WHEN cd_estab_p=0 THEN obter_nome_empresa(cd_empresa_p)  ELSE obter_nome_fantasia_estab(cd_estab_p) END ,1,255) ds_centro_controle,
	ie_classif_conta,
	ds_classificacao,
	ds_natureza_gasto,
	ds_tipo_indicador,
	ie_tipo_indicador,
	ds_indicador,
	nr_seq_ng,
	nr_seq_gng,
	' ' ie_tipo_gasto,
	sum(vl_mes01) vl_mes01,
	sum(vl_mes02) vl_mes02,
	sum(vl_mes03) vl_mes03,
	sum(vl_mes04) vl_mes04,
	sum(vl_mes05) vl_mes05,
	sum(vl_mes06) vl_mes06,
	sum(vl_mes07) vl_mes07,
	sum(vl_mes08) vl_mes08,
	sum(vl_mes09) vl_mes09,
	sum(vl_mes10) vl_mes10,
	sum(vl_mes11) vl_mes11,
	sum(vl_mes12) vl_mes12,
	dividir(sum(vl_total), nr_meses_p) vl_media,
	sum(vl_total) vl_total,
	sum(vl_orc01) vl_orc01,
	sum(vl_orc02) vl_orc02,
	sum(vl_orc03) vl_orc03,
	sum(vl_orc04) vl_orc04,
	sum(vl_orc05) vl_orc05,
	sum(vl_orc06) vl_orc06
from	w_result_centro_controle
where	nm_usuario	= nm_usuario_p
group by CASE WHEN cd_estab_p=0 THEN 0  ELSE cd_estabelecimento END ,
	ie_classif_conta,
	ds_classificacao,
	ds_natureza_gasto,
	ds_tipo_indicador,
	ie_tipo_indicador,
	ds_indicador,
	nr_seq_ng,
	nr_seq_gng
order by ie_classif_conta;

vet09	C09%rowtype;


BEGIN

cd_centro_superior_w	:= substr(cd_centro_superior_p,1,2000);
cd_centro_superior_w	:= substr(cd_centro_superior_w,position('(' in cd_centro_superior_w)+1,position(')' in cd_centro_superior_w)-(position('(' in cd_centro_superior_w)+1));

select	max(ie_orcado_real),
	max(dt_mes_referencia)
into STRICT	ie_orcado_real_w,
	dt_mes_referencia_w
from	tabela_custo
where	nr_sequencia	= nr_seq_tabela_p;

dt_final_w		:= dt_mes_referencia_w;
dt_inicial_w		:= add_months(dt_mes_referencia_w,-(nr_meses_p -1));
nr_meses_w		:= abs(nr_meses_p);
if (ie_ordem_inversa_p = 'S') then
	nr_meses_w	:= nr_meses_w * -1;
end if;

CALL exec_sql_dinamico(nm_usuario_p,'truncate table W_RESULT_CENTRO_CONTROLE');

/* Tratamento dos filtros */

ie_centro_resultado_w	:= coalesce(ie_centro_resultado_p,'N');
ie_centro_superior_w	:= coalesce(ie_centro_superior_p,'N');
ds_filtro_ng_w		:= nr_seq_ng_p;
ds_filtro_gng_w		:= nr_seq_gng_p;
ds_filtro_centro_w	:= cd_centro_controle_p;
ds_centro_controle_w	:= cd_centro_controle_p;


if (nr_seq_ng_p IS NOT NULL AND nr_seq_ng_p::text <> '') then
	begin

	ie_pos_w	:= position('(' in ds_filtro_ng_w);
	ds_filtro_ng_w	:= substr(ds_filtro_ng_w, ie_pos_w+1,2000);
	ie_pos_w	:= position(')' in ds_filtro_ng_w);
	ds_filtro_ng_w	:= substr(ds_filtro_ng_w, 1, ie_pos_w -1);
	i		:= 0;
	while (ds_filtro_ng_w IS NOT NULL AND ds_filtro_ng_w::text <> '') loop
		begin
		ie_pos_w	:= coalesce(position(',' in ds_filtro_ng_w),0);
		if (ie_pos_w = 0) then
			cd_natureza_gasto_w	:= ds_filtro_ng_w;
			ds_filtro_ng_w		:= null;
		else
			cd_natureza_gasto_w	:= substr(ds_filtro_ng_w,1,ie_pos_w-1);
			ds_filtro_ng_w	:= substr(ds_filtro_ng_w,ie_pos_w + 1,2000);
		end if;
		i	:= i + 1;

		filtro_ng_w[i].nr_sequencia	:= cd_natureza_gasto_w;
		end;
	end loop;

	end;
end if;


if (nr_seq_gng_p IS NOT NULL AND nr_seq_gng_p::text <> '') then
	begin

	ie_pos_w	:= position('(' in ds_filtro_gng_w);
	ds_filtro_gng_w	:= substr(ds_filtro_gng_w, ie_pos_w+1,2000);
	ie_pos_w	:= position(')' in ds_filtro_gng_w);
	ds_filtro_gng_w	:= substr(ds_filtro_gng_w, 1, ie_pos_w -1);
	i		:= 0;
	while(ds_filtro_gng_w IS NOT NULL AND ds_filtro_gng_w::text <> '') loop
		begin
		ie_pos_w	:= coalesce(position(',' in ds_filtro_gng_w),0);
		if (ie_pos_w = 0) then
			cd_natureza_gasto_w	:= ds_filtro_gng_w;
			ds_filtro_gng_w		:= null;
		else
			cd_natureza_gasto_w	:= substr(ds_filtro_gng_w,1,ie_pos_w-1);
			ds_filtro_gng_w		:= substr(ds_filtro_gng_w,ie_pos_w + 1,2000);
		end if;
		i	:= i + 1;

		filtro_gng_w[i].nr_sequencia	:= cd_natureza_gasto_w;

		end;
	end loop;

	end;
end if;


if (cd_centro_controle_p IS NOT NULL AND cd_centro_controle_p::text <> '')then

	ie_pos_w			:= position('(' in ds_centro_controle_w);
	ds_centro_controle_w	:= substr(ds_centro_controle_w, ie_pos_w+1,2000);
	ie_pos_w			:= position(')' in ds_centro_controle_w);
	ds_centro_controle_w	:= substr(ds_centro_controle_w, 1, ie_pos_w -1);
	if (coalesce(ds_centro_controle_w::text, '') = '') then
		ds_centro_controle_w	:=	cd_centro_controle_p;
	end if;

end if;

/* Fim do tratamento dos filtros */

open C00;
loop
fetch C00 into
	cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on C00 */
	begin

	i	:= 0;

	open C01;
	loop
	fetch C01 into
		vet01;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		ie_gerar_w	:= 'S';

		if (vet01.ie_situacao = 'I') and (ie_somente_ativo_p = 'S') and (ie_gerar_w = 'S') then
			ie_gerar_w	:= 'N';
		end if;

		if (ie_centro_superior_w = 'S') and (coalesce(vet01.cd_centro_controle_pai::text, '') = '') and (ie_gerar_w = 'S')  then
			ie_gerar_w	:= 'N';
		end if;
		if (coalesce(cd_centro_superior_p,'X') <> 'X')  and (ie_gerar_w = 'S') then
			ie_gerar_w	:= obter_se_contido(vet01.cd_centro_controle_pai, cd_centro_superior_p);
		end if;

		if (coalesce(ie_tipo_centro_controle_p,'X') <> 'X') and (ie_gerar_w = 'S')  then
			ie_gerar_w	:= obter_se_contido(somente_numero(vet01.ie_tipo_centro_controle), ie_tipo_centro_controle_p);
		end if;

		if (coalesce(cd_centro_controle_p,'X') <> 'X') and (ie_gerar_w = 'S')  then
			begin
			ie_gerar_w	:= 'N';

			if (cd_centro_controle_p = '99999999') then
				ie_gerar_w	:= 'S';
			else
				begin
				select	coalesce(max('N'),'S')
				into STRICT	ie_gerar_w
				
				where	obter_se_contido(vet01.cd_centro_controle, ds_centro_controle_w) = 'S';
				end;
			end if;
			end;
		end if;

		if (filtro_ng_w.count > 0)  and (ie_gerar_w = 'S') then
			ie_gerar_w	:= 'N';
			for j in 1..filtro_ng_w.count loop
				begin
				select	coalesce(max('S'),'N')
				into STRICT	ie_gerar_w
				
				where	exists (	SELECT	1
						from	tabela_custo b,
							resultado_centro_controle a
						where	a.cd_tabela_custo	= b.cd_tabela_custo
						and	a.cd_estabelecimento	= coalesce(b.cd_estabelecimento,a.cd_estabelecimento)
						and	a.cd_centro_controle	= vet01.cd_centro_controle
						and	b.cd_empresa		= cd_empresa_p
						and	coalesce(b.cd_estabelecimento,cd_estabelecimento_w)	= cd_estabelecimento_w
						and 	b.dt_mes_referencia	between dt_inicial_w and dt_final_w
						and	b.ie_orcado_real	= ie_orcado_real_w
						and	a.nr_seq_ng		= filtro_ng_w[j].nr_sequencia);

				if (ie_gerar_w = 'S') then
					exit;
				end if;
				end;
			end loop;
		end if;

		if (ie_gerar_w = 'S') then

			if (filtro_gng_w.count > 0) and (ie_gerar_w = 'S')  then
				ie_gerar_w	:= 'N';
				for j in 1..filtro_gng_w.count loop
					begin
					select	coalesce(max('S'),'N')
					into STRICT	ie_gerar_w
					
					where	exists (	SELECT	1
							from	natureza_gasto c,
								tabela_custo b,
								resultado_centro_controle a
							where	a.cd_tabela_custo	= b.cd_tabela_custo
							and	a.cd_estabelecimento	= coalesce(b.cd_estabelecimento, a.cd_estabelecimento)
							and	a.cd_centro_controle	= vet01.cd_centro_controle
							and	b.cd_empresa		= cd_empresa_p
							and	coalesce(b.cd_estabelecimento,cd_estabelecimento_w)	= cd_estabelecimento_w
							and 	b.dt_mes_referencia	between dt_inicial_w and dt_final_w
							and	b.ie_orcado_real	= ie_orcado_real_w
							and	a.nr_seq_ng		= c.nr_sequencia
							and	c.nr_seq_gng		= filtro_gng_w[j].nr_sequencia);
					if (ie_gerar_w = 'S') then
						exit;
					end if;
					end;
				end loop;
			end if;
		end if;

		if (coalesce(nr_seq_unid_neg_p,0) <> 0) and (ie_gerar_w = 'S')  then
			ie_gerar_w	:= obter_se_contido(vet01.nr_seq_unid_neg, nr_seq_unid_neg_p);
		end if;

		if (ie_gerar_w = 'S') then
			i	:= i + 1;
			centro_w[i].cd_centro_controle		:= vet01.cd_centro_controle;
			centro_w[i].ds_centro_controle		:= vet01.ds_centro_controle;
			centro_w[i].ie_tipo_centro_controle	:= vet01.ie_tipo_centro_controle;
			centro_w[i].nr_seq_unid_neg		:= vet01.nr_seq_unid_neg;
			centro_w[i].ie_centro_resultado		:= vet01.ie_centro_resultado;
			centro_w[i].cd_centro_controle_pai	:= vet01.cd_centro_controle_pai;
		end if;

		end;
	end loop;
	close C01;

	for i in 1..centro_w.count loop
		begin

		nr_seq_w	:= nr_seq_w + 1;
		nr_seq_centro_w	:= nr_seq_w;
		valores_w[nr_seq_w].cd_estabelecimento		:= cd_estabelecimento_w;
		valores_w[nr_seq_w].cd_centro_controle		:= centro_w[i].cd_centro_controle;
		valores_w[nr_seq_w].ds_centro_controle		:= centro_w[i].ds_centro_controle;
		cd_centro_controle_w				:= centro_w[i].cd_centro_controle;

		for j in 1..12 loop
			begin
			rec_liquida_w[j].vl_mes	:= 0;
			end;
		end loop;

		open C02;
		loop
		fetch C02 into
			vet02;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin

			ie_gerar_w	:= 'S';
			if (filtro_ng_w.count > 0) then
				ie_gerar_w	:= 'N';
				for j in 1..filtro_ng_w.count loop
					begin
					select	coalesce(max('S'),'N')
					into STRICT	ie_gerar_w
					
					where	exists (	SELECT	1
							from	tabela_custo b,
								resultado_centro_controle a
							where	a.cd_tabela_custo	= b.cd_tabela_custo
							and	a.cd_estabelecimento	= coalesce(b.cd_estabelecimento, a.cd_estabelecimento)
							and	a.cd_centro_controle	= centro_w[i].cd_centro_controle
							and	b.cd_empresa		= cd_empresa_p
							and	coalesce(a.cd_estabelecimento,cd_estabelecimento_w)	= cd_estabelecimento_w
							and	a.ie_classif_conta	= vet02.cd_classificacao
							and 	b.dt_mes_referencia	between dt_inicial_w and dt_final_w
							and	b.ie_orcado_real	= ie_orcado_real_w
							and	a.nr_seq_ng		= filtro_ng_w[j].nr_sequencia);


					if (ie_gerar_w = 'S') then
						exit;
					end if;
					end;
				end loop;
			end if;

			if (ie_gerar_w = 'S') and (filtro_gng_w.count > 0) then
				ie_gerar_w	:= 'N';
				for j in 1..filtro_gng_w.count loop
					begin
					select	coalesce(max('S'),'N')
					into STRICT	ie_gerar_w
					
					where	exists (	SELECT	1
							from	natureza_gasto c,
								tabela_custo b,
								resultado_centro_controle a
							where	a.cd_tabela_custo	= b.cd_tabela_custo
							and	a.cd_estabelecimento	= coalesce(b.cd_estabelecimento,a.cd_estabelecimento)
							and	c.nr_sequencia		= a.nr_seq_ng
							and	a.cd_centro_controle	= centro_w[i].cd_centro_controle
							and	b.cd_empresa		= cd_empresa_p
							and	coalesce(b.cd_estabelecimento,cd_estabelecimento_w)	= cd_estabelecimento_w
							and	a.ie_classif_conta	= vet02.cd_classificacao
							and 	b.dt_mes_referencia	between dt_inicial_w and dt_final_w
							and	b.ie_orcado_real	= ie_orcado_real_w
							and	c.nr_seq_gng		= filtro_gng_w[j].nr_sequencia);


					if (ie_gerar_w = 'S') then
						exit;
					end if;
					end;
				end loop;
			end if;

			if (ie_gerar_w = 'S') then
				begin
				nr_seq_w		:= nr_seq_w + 1;
				nr_seq_classif_w	:= nr_seq_w;
				valores_w[nr_seq_w].cd_estabelecimento		:= cd_estabelecimento_w;
				valores_w[nr_seq_w].cd_centro_controle		:= centro_w[i].cd_centro_controle;
				valores_w[nr_seq_w].ie_classif_conta		:= vet02.cd_classificacao;
				valores_w[nr_seq_w].ds_classificacao		:= vet02.ds_classificacao;
				valores_w[nr_seq_w].ie_emite			:= vet02.ie_emite;
				ie_classif_conta_w				:= vet02.cd_classificacao;

				if (vet02.ie_emite	= 'G') then
					begin
					ie_natureza_gasto_w	:= 'X';
					open C03;
					loop
					fetch C03 into
						vet03;
					EXIT WHEN NOT FOUND; /* apply on C03 */
						begin
						ie_gerar_w	:= 'S';
						if (filtro_ng_w.count > 0) then
							ie_gerar_w	:= 'N';
							for j in 1..filtro_ng_w.count loop
								begin
								if (filtro_ng_w[j].nr_sequencia	= vet03.nr_seq_ng) then
									ie_gerar_w	:= 'S';
									exit;
								end if;
								end;
							end loop;
						end if;

						if (ie_gerar_w = 'S') and (filtro_gng_w.count > 0) then
							ie_gerar_w	:= 'N';
							for j in 1..filtro_gng_w.count loop
								begin
								if (filtro_gng_w[j].nr_sequencia	= vet03.nr_seq_gng) then
									ie_gerar_w	:= 'S';
									exit;
								end if;
								end;
							end loop;
						end if;

						if (ie_gerar_w = 'S') then
							begin
							nr_seq_w	:= nr_seq_w + 1;
							valores_w[nr_seq_w].cd_estabelecimento		:= cd_estabelecimento_w;
							valores_w[nr_seq_w].cd_centro_controle		:= centro_w[i].cd_centro_controle;
							valores_w[nr_seq_w].ie_classif_conta		:= vet02.cd_classificacao;
							valores_w[nr_seq_w].nr_seq_ng			:= vet03.nr_seq_ng;
							valores_w[nr_seq_w].nr_seq_gng			:= vet03.nr_seq_gng;
							valores_w[nr_seq_w].ds_classificacao		:= vet02.ds_classificacao;
							if (ie_tipo_relat_ng_p = '0') then
								valores_w[nr_seq_w].ds_natureza_gasto	:= vet03.ds_natureza_gasto;
							elsif (ie_tipo_relat_ng_p = '1') then
								valores_w[nr_seq_w].ds_natureza_gasto	:= vet03.ds_grupo_natureza_gasto;
							end if;
							valores_w[nr_seq_w].ie_tipo_gasto		:= vet03.ie_tipo_gasto;
							valores_w[nr_seq_w].ie_emite			:= vet02.ie_emite;
							valores_w[nr_seq_w].vl_mes12			:= vet03.vl_mes_12;
							valores_w[nr_seq_w].vl_mes11			:= vet03.vl_mes_11;
							valores_w[nr_seq_w].vl_mes10			:= vet03.vl_mes_10;
							valores_w[nr_seq_w].vl_mes09			:= vet03.vl_mes_09;
							valores_w[nr_seq_w].vl_mes08			:= vet03.vl_mes_08;
							valores_w[nr_seq_w].vl_mes07			:= vet03.vl_mes_07;
							valores_w[nr_seq_w].vl_mes06			:= vet03.vl_mes_06;
							valores_w[nr_seq_w].vl_mes05			:= vet03.vl_mes_05;
							valores_w[nr_seq_w].vl_mes04			:= vet03.vl_mes_04;
							valores_w[nr_seq_w].vl_mes03			:= vet03.vl_mes_03;
							valores_w[nr_seq_w].vl_mes02			:= vet03.vl_mes_02;
							valores_w[nr_seq_w].vl_mes01			:= vet03.vl_mes_01;

							valores_w[nr_seq_w].vl_total			:= valores_w[nr_seq_w].vl_mes12	+ valores_w[nr_seq_w].vl_mes11 +
													   valores_w[nr_seq_w].vl_mes10 + valores_w[nr_seq_w].vl_mes09 +
													   valores_w[nr_seq_w].vl_mes08	+ valores_w[nr_seq_w].vl_mes07 +
													   valores_w[nr_seq_w].vl_mes06 + valores_w[nr_seq_w].vl_mes05 +
													   valores_w[nr_seq_w].vl_mes04 + valores_w[nr_seq_w].vl_mes03 +
													   valores_w[nr_seq_w].vl_mes02 + valores_w[nr_seq_w].vl_mes01;

							valores_w[nr_seq_w].vl_media			:= dividir_sem_round(valores_w[nr_seq_w].vl_total,nr_meses_p);

							valores_w[nr_seq_classif_w].vl_mes12		:= coalesce(valores_w[nr_seq_classif_w].vl_mes12,0) + vet03.vl_mes_12;
							valores_w[nr_seq_classif_w].vl_mes11		:= coalesce(valores_w[nr_seq_classif_w].vl_mes11,0) + vet03.vl_mes_11;
							valores_w[nr_seq_classif_w].vl_mes10		:= coalesce(valores_w[nr_seq_classif_w].vl_mes10,0) + vet03.vl_mes_10;
							valores_w[nr_seq_classif_w].vl_mes09		:= coalesce(valores_w[nr_seq_classif_w].vl_mes09,0) + vet03.vl_mes_09;
							valores_w[nr_seq_classif_w].vl_mes08		:= coalesce(valores_w[nr_seq_classif_w].vl_mes08,0) + vet03.vl_mes_08;
							valores_w[nr_seq_classif_w].vl_mes07		:= coalesce(valores_w[nr_seq_classif_w].vl_mes07,0) + vet03.vl_mes_07;
							valores_w[nr_seq_classif_w].vl_mes06		:= coalesce(valores_w[nr_seq_classif_w].vl_mes06,0) + vet03.vl_mes_06;
							valores_w[nr_seq_classif_w].vl_mes05		:= coalesce(valores_w[nr_seq_classif_w].vl_mes05,0) + vet03.vl_mes_05;
							valores_w[nr_seq_classif_w].vl_mes04		:= coalesce(valores_w[nr_seq_classif_w].vl_mes04,0) + vet03.vl_mes_04;
							valores_w[nr_seq_classif_w].vl_mes03		:= coalesce(valores_w[nr_seq_classif_w].vl_mes03,0) + vet03.vl_mes_03;
							valores_w[nr_seq_classif_w].vl_mes02		:= coalesce(valores_w[nr_seq_classif_w].vl_mes02,0) + vet03.vl_mes_02;
							valores_w[nr_seq_classif_w].vl_mes01		:= coalesce(valores_w[nr_seq_classif_w].vl_mes01,0) + vet03.vl_mes_01;

							valores_w[nr_seq_classif_w].vl_total		:= valores_w[nr_seq_classif_w].vl_mes12 + valores_w[nr_seq_classif_w].vl_mes11 +
													   valores_w[nr_seq_classif_w].vl_mes10 + valores_w[nr_seq_classif_w].vl_mes09 +
													   valores_w[nr_seq_classif_w].vl_mes08 + valores_w[nr_seq_classif_w].vl_mes07 +
													   valores_w[nr_seq_classif_w].vl_mes06 + valores_w[nr_seq_classif_w].vl_mes05 +
													   valores_w[nr_seq_classif_w].vl_mes04 + valores_w[nr_seq_classif_w].vl_mes03 +
													   valores_w[nr_seq_classif_w].vl_mes02 + valores_w[nr_seq_classif_w].vl_mes01;

							valores_w[nr_seq_classif_w].vl_media		:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_total,nr_meses_p);
							end;
						end if;

						end;
					end loop;
					close C03;
					end;
				elsif (vet02.ie_emite in ('S','N','C')) then
					begin
					open C04;
					loop
					fetch C04 into
						vet04;
					EXIT WHEN NOT FOUND; /* apply on C04 */
						begin

						valores_w[nr_seq_classif_w].vl_mes12			:= vet04.vl_mes_12;
						valores_w[nr_seq_classif_w].vl_mes11			:= vet04.vl_mes_11;
						valores_w[nr_seq_classif_w].vl_mes10			:= vet04.vl_mes_10;
						valores_w[nr_seq_classif_w].vl_mes09			:= vet04.vl_mes_09;
						valores_w[nr_seq_classif_w].vl_mes08			:= vet04.vl_mes_08;
						valores_w[nr_seq_classif_w].vl_mes07			:= vet04.vl_mes_07;
						valores_w[nr_seq_classif_w].vl_mes06			:= vet04.vl_mes_06;
						valores_w[nr_seq_classif_w].vl_mes05			:= vet04.vl_mes_05;
						valores_w[nr_seq_classif_w].vl_mes04			:= vet04.vl_mes_04;
						valores_w[nr_seq_classif_w].vl_mes03			:= vet04.vl_mes_03;
						valores_w[nr_seq_classif_w].vl_mes02			:= vet04.vl_mes_02;
						valores_w[nr_seq_classif_w].vl_mes01			:= vet04.vl_mes_01;
						valores_w[nr_seq_classif_w].vl_total		:= valores_w[nr_seq_classif_w].vl_mes12 + valores_w[nr_seq_classif_w].vl_mes11 +
												   valores_w[nr_seq_classif_w].vl_mes10 + valores_w[nr_seq_classif_w].vl_mes09 +
												   valores_w[nr_seq_classif_w].vl_mes08 + valores_w[nr_seq_classif_w].vl_mes07 +
												   valores_w[nr_seq_classif_w].vl_mes06 + valores_w[nr_seq_classif_w].vl_mes05 +
												   valores_w[nr_seq_classif_w].vl_mes04 + valores_w[nr_seq_classif_w].vl_mes03 +
												   valores_w[nr_seq_classif_w].vl_mes02 + valores_w[nr_seq_classif_w].vl_mes01;

						valores_w[nr_seq_classif_w].vl_media		:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_total,nr_meses_p);
						end;
					end loop;
					close C04;


					if (vet02.ie_emite = 'C') then
						begin

						open C05;
						loop
						fetch C05 into
							vet05;
						EXIT WHEN NOT FOUND; /* apply on C05 */
							begin
							nr_seq_w					:= nr_seq_w + 1;
							valores_w[nr_seq_w].cd_estabelecimento		:= cd_estabelecimento_w;
							valores_w[nr_seq_w].cd_centro_controle		:= centro_w[i].cd_centro_controle;
							valores_w[nr_seq_w].ie_classif_conta		:= vet02.cd_classificacao;
							valores_w[nr_seq_w].ds_classificacao		:= vet02.ds_classificacao;
							valores_w[nr_seq_w].ds_natureza_gasto		:= vet05.ds_centro_controle;
							valores_w[nr_seq_w].ie_emite			:= vet02.ie_emite;
							valores_w[nr_seq_w].vl_mes12			:= vet05.vl_mes_12;
							valores_w[nr_seq_w].vl_mes11			:= vet05.vl_mes_11;
							valores_w[nr_seq_w].vl_mes10			:= vet05.vl_mes_10;
							valores_w[nr_seq_w].vl_mes09			:= vet05.vl_mes_09;
							valores_w[nr_seq_w].vl_mes08			:= vet05.vl_mes_08;
							valores_w[nr_seq_w].vl_mes07			:= vet05.vl_mes_07;
							valores_w[nr_seq_w].vl_mes06			:= vet05.vl_mes_06;
							valores_w[nr_seq_w].vl_mes05			:= vet05.vl_mes_05;
							valores_w[nr_seq_w].vl_mes04			:= vet05.vl_mes_04;
							valores_w[nr_seq_w].vl_mes03			:= vet05.vl_mes_03;
							valores_w[nr_seq_w].vl_mes02			:= vet05.vl_mes_02;
							valores_w[nr_seq_w].vl_mes01			:= vet05.vl_mes_01;

							valores_w[nr_seq_w].vl_total			:= valores_w[nr_seq_w].vl_mes12 + valores_w[nr_seq_w].vl_mes11 +
													   valores_w[nr_seq_w].vl_mes10 + valores_w[nr_seq_w].vl_mes09 +
													   valores_w[nr_seq_w].vl_mes08 + valores_w[nr_seq_w].vl_mes07 +
													   valores_w[nr_seq_w].vl_mes06 + valores_w[nr_seq_w].vl_mes05 +
													   valores_w[nr_seq_w].vl_mes04 + valores_w[nr_seq_w].vl_mes03 +
													   valores_w[nr_seq_w].vl_mes02 + valores_w[nr_seq_w].vl_mes01;

							valores_w[nr_seq_w].vl_media			:= dividir_sem_round(valores_w[nr_seq_w].vl_total,nr_meses_p);

							/*valores_w(nr_seq_classif_w).vl_mes12		:= nvl(valores_w(nr_seq_classif_w).vl_mes12,0) + vet05.vl_mes_12;
							valores_w(nr_seq_classif_w).vl_mes11		:= nvl(valores_w(nr_seq_classif_w).vl_mes11,0) + vet05.vl_mes_11;
							valores_w(nr_seq_classif_w).vl_mes10		:= nvl(valores_w(nr_seq_classif_w).vl_mes10,0) + vet05.vl_mes_10;
							valores_w(nr_seq_classif_w).vl_mes09		:= nvl(valores_w(nr_seq_classif_w).vl_mes09,0) + vet05.vl_mes_09;
							valores_w(nr_seq_classif_w).vl_mes08		:= nvl(valores_w(nr_seq_classif_w).vl_mes08,0) + vet05.vl_mes_08;
							valores_w(nr_seq_classif_w).vl_mes07		:= nvl(valores_w(nr_seq_classif_w).vl_mes07,0) + vet05.vl_mes_07;
							valores_w(nr_seq_classif_w).vl_mes06		:= nvl(valores_w(nr_seq_classif_w).vl_mes06,0) + vet05.vl_mes_06;
							valores_w(nr_seq_classif_w).vl_mes05		:= nvl(valores_w(nr_seq_classif_w).vl_mes05,0) + vet05.vl_mes_05;
							valores_w(nr_seq_classif_w).vl_mes04		:= nvl(valores_w(nr_seq_classif_w).vl_mes04,0) + vet05.vl_mes_04;
							valores_w(nr_seq_classif_w).vl_mes03		:= nvl(valores_w(nr_seq_classif_w).vl_mes03,0) + vet05.vl_mes_03;
							valores_w(nr_seq_classif_w).vl_mes02		:= nvl(valores_w(nr_seq_classif_w).vl_mes02,0) + vet05.vl_mes_02;
							valores_w(nr_seq_classif_w).vl_mes01		:= nvl(valores_w(nr_seq_classif_w).vl_mes01,0) + vet05.vl_mes_01;

							valores_w(nr_seq_classif_w).vl_total		:= valores_w(nr_seq_classif_w).vl_mes12 + valores_w(nr_seq_classif_w).vl_mes11 +
													   valores_w(nr_seq_classif_w).vl_mes10 + valores_w(nr_seq_classif_w).vl_mes09 +
													   valores_w(nr_seq_classif_w).vl_mes08 + valores_w(nr_seq_classif_w).vl_mes07 +
													   valores_w(nr_seq_classif_w).vl_mes06 + valores_w(nr_seq_classif_w).vl_mes05 +
													   valores_w(nr_seq_classif_w).vl_mes04 + valores_w(nr_seq_classif_w).vl_mes03 +
													   valores_w(nr_seq_classif_w).vl_mes02 + valores_w(nr_seq_classif_w).vl_mes01;

							valores_w(nr_seq_classif_w).vl_media		:= dividir_sem_round(valores_w(nr_seq_classif_w).vl_total,nr_meses_p);*/
							end;
						end loop;
						close C05;
						ie_natureza_gasto_w	:= 'N';
						open C03;
						loop
						fetch C03 into
							vet03;
						EXIT WHEN NOT FOUND; /* apply on C03 */
							begin
							ie_gerar_w	:= 'S';
							if (filtro_ng_w.count > 0) then
								ie_gerar_w	:= 'N';
								for j in 1..filtro_ng_w.count loop
									begin
									if (filtro_ng_w[j].nr_sequencia	= vet03.nr_seq_ng) then
										ie_gerar_w	:= 'S';
										exit;
									end if;
									end;
								end loop;
							end if;

							if (ie_gerar_w = 'S') and (filtro_gng_w.count > 0) then
								ie_gerar_w	:= 'N';
								for j in 1..filtro_gng_w.count loop
									begin
									if (filtro_gng_w[j].nr_sequencia	= vet03.nr_seq_gng) then
										ie_gerar_w	:= 'S';
										exit;
									end if;
									end;
								end loop;
							end if;

							if (ie_gerar_w = 'S') then
								begin
								nr_seq_w	:= nr_seq_w + 1;
								valores_w[nr_seq_w].cd_estabelecimento		:= cd_estabelecimento_w;
								valores_w[nr_seq_w].cd_centro_controle		:= centro_w[i].cd_centro_controle;
								valores_w[nr_seq_w].ie_classif_conta		:= vet02.cd_classificacao;
								valores_w[nr_seq_w].nr_seq_ng			:= vet03.nr_seq_ng;
								valores_w[nr_seq_w].nr_seq_gng			:= vet03.nr_seq_gng;
								valores_w[nr_seq_w].ds_classificacao		:= vet02.ds_classificacao;
								if (ie_tipo_relat_ng_p = '0') then
									valores_w[nr_seq_w].ds_natureza_gasto	:= vet03.ds_natureza_gasto;
								elsif (ie_tipo_relat_ng_p = '1') then
									valores_w[nr_seq_w].ds_natureza_gasto	:= vet03.ds_grupo_natureza_gasto;
								end if;
								valores_w[nr_seq_w].ie_tipo_gasto		:= vet03.ie_tipo_gasto;
								valores_w[nr_seq_w].ie_emite			:= vet02.ie_emite;
								valores_w[nr_seq_w].vl_mes12			:= vet03.vl_mes_12;
								valores_w[nr_seq_w].vl_mes11			:= vet03.vl_mes_11;
								valores_w[nr_seq_w].vl_mes10			:= vet03.vl_mes_10;
								valores_w[nr_seq_w].vl_mes09			:= vet03.vl_mes_09;
								valores_w[nr_seq_w].vl_mes08			:= vet03.vl_mes_08;
								valores_w[nr_seq_w].vl_mes07			:= vet03.vl_mes_07;
								valores_w[nr_seq_w].vl_mes06			:= vet03.vl_mes_06;
								valores_w[nr_seq_w].vl_mes05			:= vet03.vl_mes_05;
								valores_w[nr_seq_w].vl_mes04			:= vet03.vl_mes_04;
								valores_w[nr_seq_w].vl_mes03			:= vet03.vl_mes_03;
								valores_w[nr_seq_w].vl_mes02			:= vet03.vl_mes_02;
								valores_w[nr_seq_w].vl_mes01			:= vet03.vl_mes_01;

								valores_w[nr_seq_w].vl_total			:= valores_w[nr_seq_w].vl_mes12	+ valores_w[nr_seq_w].vl_mes11 +
														   valores_w[nr_seq_w].vl_mes10 + valores_w[nr_seq_w].vl_mes09 +
														   valores_w[nr_seq_w].vl_mes08	+ valores_w[nr_seq_w].vl_mes07 +
														   valores_w[nr_seq_w].vl_mes06 + valores_w[nr_seq_w].vl_mes05 +
														   valores_w[nr_seq_w].vl_mes04 + valores_w[nr_seq_w].vl_mes03 +
														   valores_w[nr_seq_w].vl_mes02 + valores_w[nr_seq_w].vl_mes01;

								valores_w[nr_seq_w].vl_media			:= dividir_sem_round(valores_w[nr_seq_w].vl_total,nr_meses_p);

								/*valores_w(nr_seq_classif_w).vl_mes12		:= nvl(valores_w(nr_seq_classif_w).vl_mes12,0) + vet03.vl_mes_12;
								valores_w(nr_seq_classif_w).vl_mes11		:= nvl(valores_w(nr_seq_classif_w).vl_mes11,0) + vet03.vl_mes_11;
								valores_w(nr_seq_classif_w).vl_mes10		:= nvl(valores_w(nr_seq_classif_w).vl_mes10,0) + vet03.vl_mes_10;
								valores_w(nr_seq_classif_w).vl_mes09		:= nvl(valores_w(nr_seq_classif_w).vl_mes09,0) + vet03.vl_mes_09;
								valores_w(nr_seq_classif_w).vl_mes08		:= nvl(valores_w(nr_seq_classif_w).vl_mes08,0) + vet03.vl_mes_08;
								valores_w(nr_seq_classif_w).vl_mes07		:= nvl(valores_w(nr_seq_classif_w).vl_mes07,0) + vet03.vl_mes_07;
								valores_w(nr_seq_classif_w).vl_mes06		:= nvl(valores_w(nr_seq_classif_w).vl_mes06,0) + vet03.vl_mes_06;
								valores_w(nr_seq_classif_w).vl_mes05		:= nvl(valores_w(nr_seq_classif_w).vl_mes05,0) + vet03.vl_mes_05;
								valores_w(nr_seq_classif_w).vl_mes04		:= nvl(valores_w(nr_seq_classif_w).vl_mes04,0) + vet03.vl_mes_04;
								valores_w(nr_seq_classif_w).vl_mes03		:= nvl(valores_w(nr_seq_classif_w).vl_mes03,0) + vet03.vl_mes_03;
								valores_w(nr_seq_classif_w).vl_mes02		:= nvl(valores_w(nr_seq_classif_w).vl_mes02,0) + vet03.vl_mes_02;
								valores_w(nr_seq_classif_w).vl_mes01		:= nvl(valores_w(nr_seq_classif_w).vl_mes01,0) + vet03.vl_mes_01;

								valores_w(nr_seq_classif_w).vl_total		:= valores_w(nr_seq_classif_w).vl_mes12 + valores_w(nr_seq_classif_w).vl_mes11 +
														   valores_w(nr_seq_classif_w).vl_mes10 + valores_w(nr_seq_classif_w).vl_mes09 +
														   valores_w(nr_seq_classif_w).vl_mes08 + valores_w(nr_seq_classif_w).vl_mes07 +
														   valores_w(nr_seq_classif_w).vl_mes06 + valores_w(nr_seq_classif_w).vl_mes05 +
														   valores_w(nr_seq_classif_w).vl_mes04 + valores_w(nr_seq_classif_w).vl_mes03 +
														   valores_w(nr_seq_classif_w).vl_mes02 + valores_w(nr_seq_classif_w).vl_mes01;

								valores_w(nr_seq_classif_w).vl_media		:= dividir_sem_round(valores_w(nr_seq_classif_w).vl_total,nr_meses_p);*/
								end;
							end if;

							end;
							end loop;
							close C03;
						end;
					end if;
					end;
				end if;
				/* Acumular a Classificao se ela for a receita Liquida, para o clculo do percentual */

				if (vet02.ie_receita_liquida = 'S') then
					begin
					rec_liquida_w[01].vl_mes	:= coalesce(rec_liquida_w[01].vl_mes,0) + valores_w[nr_seq_classif_w].vl_mes01;
					rec_liquida_w[02].vl_mes	:= coalesce(rec_liquida_w[02].vl_mes,0) + valores_w[nr_seq_classif_w].vl_mes02;
					rec_liquida_w[03].vl_mes	:= coalesce(rec_liquida_w[03].vl_mes,0) + valores_w[nr_seq_classif_w].vl_mes03;
					rec_liquida_w[04].vl_mes	:= coalesce(rec_liquida_w[04].vl_mes,0) + valores_w[nr_seq_classif_w].vl_mes04;
					rec_liquida_w[05].vl_mes	:= coalesce(rec_liquida_w[05].vl_mes,0) + valores_w[nr_seq_classif_w].vl_mes05;
					rec_liquida_w[06].vl_mes	:= coalesce(rec_liquida_w[06].vl_mes,0) + valores_w[nr_seq_classif_w].vl_mes06;
					rec_liquida_w[07].vl_mes	:= coalesce(rec_liquida_w[07].vl_mes,0) + valores_w[nr_seq_classif_w].vl_mes07;
					rec_liquida_w[08].vl_mes	:= coalesce(rec_liquida_w[08].vl_mes,0) + valores_w[nr_seq_classif_w].vl_mes08;
					rec_liquida_w[09].vl_mes	:= coalesce(rec_liquida_w[09].vl_mes,0) + valores_w[nr_seq_classif_w].vl_mes09;
					rec_liquida_w[10].vl_mes	:= coalesce(rec_liquida_w[10].vl_mes,0) + valores_w[nr_seq_classif_w].vl_mes10;
					rec_liquida_w[11].vl_mes	:= coalesce(rec_liquida_w[11].vl_mes,0) + valores_w[nr_seq_classif_w].vl_mes11;
					rec_liquida_w[12].vl_mes	:= coalesce(rec_liquida_w[12].vl_mes,0) + valores_w[nr_seq_classif_w].vl_mes12;

					end;
				end if;

				if (vet02.ie_emite_perc = 'S') then
					begin
					nr_seq_w	:= nr_seq_w + 1;
					valores_w[nr_seq_w].cd_estabelecimento		:= cd_estabelecimento_w;
					valores_w[nr_seq_w].cd_centro_controle		:= centro_w[i].cd_centro_controle;
					valores_w[nr_seq_w].ie_classif_conta		:= vet02.cd_classificacao;
					valores_w[nr_seq_w].ie_emite			:= vet02.ie_emite;
					valores_w[nr_seq_w].ds_natureza_gasto		:= Wheb_mensagem_pck.get_texto(299231);
					valores_w[nr_seq_w].vl_mes12			:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_mes12, rec_liquida_w[12].vl_mes) * 100;
					valores_w[nr_seq_w].vl_mes11			:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_mes11, rec_liquida_w[11].vl_mes) * 100;
					valores_w[nr_seq_w].vl_mes10			:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_mes10, rec_liquida_w[10].vl_mes) * 100;
					valores_w[nr_seq_w].vl_mes09			:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_mes09, rec_liquida_w[09].vl_mes) * 100;
					valores_w[nr_seq_w].vl_mes08			:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_mes08, rec_liquida_w[08].vl_mes) * 100;
					valores_w[nr_seq_w].vl_mes07			:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_mes07, rec_liquida_w[07].vl_mes) * 100;
					valores_w[nr_seq_w].vl_mes06			:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_mes06, rec_liquida_w[06].vl_mes) * 100;
					valores_w[nr_seq_w].vl_mes05			:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_mes05, rec_liquida_w[05].vl_mes) * 100;
					valores_w[nr_seq_w].vl_mes04			:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_mes04, rec_liquida_w[04].vl_mes) * 100;
					valores_w[nr_seq_w].vl_mes03			:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_mes03, rec_liquida_w[03].vl_mes) * 100;
					valores_w[nr_seq_w].vl_mes02			:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_mes02, rec_liquida_w[02].vl_mes) * 100;
					valores_w[nr_seq_w].vl_mes01			:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_mes01, rec_liquida_w[01].vl_mes) * 100;

					valores_w[nr_seq_w].vl_total		:= 	coalesce(rec_liquida_w[01].vl_mes,0) +
											coalesce(rec_liquida_w[02].vl_mes,0) +
											coalesce(rec_liquida_w[03].vl_mes,0) +
											coalesce(rec_liquida_w[04].vl_mes,0) +
											coalesce(rec_liquida_w[05].vl_mes,0) +
											coalesce(rec_liquida_w[06].vl_mes,0) +
											coalesce(rec_liquida_w[07].vl_mes,0) +
											coalesce(rec_liquida_w[08].vl_mes,0) +
											coalesce(rec_liquida_w[09].vl_mes,0) +
											coalesce(rec_liquida_w[10].vl_mes,0) +
											coalesce(rec_liquida_w[11].vl_mes,0) +
											coalesce(rec_liquida_w[12].vl_mes,0);
					valores_w[nr_seq_w].vl_total		:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_total, valores_w[nr_seq_w].vl_total) * 100;
					valores_w[nr_seq_w].vl_media		:= valores_w[nr_seq_w].vl_total;

					end;
				end if;
				end; /*Fim Ie_gerar do cursor c02*/
			end if;
			end;
		end loop;
		close C02; /* Fim Classificaes DRE*/
		/*Indicadores*/

		open C06;
		loop
		fetch C06 into
			vet06;
		EXIT WHEN NOT FOUND; /* apply on C06 */
			begin
			nr_seq_w						:= nr_seq_w + 1;
			valores_w[nr_seq_w].cd_estabelecimento			:= cd_estabelecimento_w;
			valores_w[nr_seq_w].cd_centro_controle			:= centro_w[i].cd_centro_controle;
			valores_w[nr_seq_w].ie_tipo_indicador			:= vet06.ie_tipo_indicador;
			valores_w[nr_seq_w].nr_seq_indicador			:= vet06.nr_seq_indicador;
			valores_w[nr_seq_w].ds_tipo_indicador			:= vet06.ds_tipo_indicador;
			valores_w[nr_seq_w].ds_indicador			:= vet06.ds_indicador;
			valores_w[nr_seq_w].vl_mes12				:= vet06.vl_mes_12;
			valores_w[nr_seq_w].vl_mes11				:= vet06.vl_mes_11;
			valores_w[nr_seq_w].vl_mes10				:= vet06.vl_mes_10;
			valores_w[nr_seq_w].vl_mes09				:= vet06.vl_mes_09;
			valores_w[nr_seq_w].vl_mes08				:= vet06.vl_mes_08;
			valores_w[nr_seq_w].vl_mes07				:= vet06.vl_mes_07;
			valores_w[nr_seq_w].vl_mes06				:= vet06.vl_mes_06;
			valores_w[nr_seq_w].vl_mes05				:= vet06.vl_mes_05;
			valores_w[nr_seq_w].vl_mes04				:= vet06.vl_mes_04;
			valores_w[nr_seq_w].vl_mes03				:= vet06.vl_mes_03;
			valores_w[nr_seq_w].vl_mes02				:= vet06.vl_mes_02;
			valores_w[nr_seq_w].vl_mes01				:= vet06.vl_mes_01;

			valores_w[nr_seq_w].vl_total				:= valores_w[nr_seq_w].vl_mes12	+ valores_w[nr_seq_w].vl_mes11 +
										   valores_w[nr_seq_w].vl_mes10 + valores_w[nr_seq_w].vl_mes09 +
										   valores_w[nr_seq_w].vl_mes08	+ valores_w[nr_seq_w].vl_mes07 +
									           valores_w[nr_seq_w].vl_mes06 + valores_w[nr_seq_w].vl_mes05 +
									           valores_w[nr_seq_w].vl_mes04 + valores_w[nr_seq_w].vl_mes03 +
										   valores_w[nr_seq_w].vl_mes02 + valores_w[nr_seq_w].vl_mes01;

			valores_w[nr_seq_w].vl_media				:= dividir_sem_round(valores_w[nr_seq_w].vl_total,nr_meses_p);

		end;
		end loop;
		close C06;

		open C07;
		loop
		fetch C07 into
			vet07;
		EXIT WHEN NOT FOUND; /* apply on C07 */
			begin
			nr_seq_w						:= nr_seq_w + 1;
			valores_w[nr_seq_w].cd_estabelecimento			:= cd_estabelecimento_w;
			valores_w[nr_seq_w].cd_centro_controle			:= centro_w[i].cd_centro_controle;
			valores_w[nr_seq_w].ie_tipo_indicador			:= vet07.ie_tipo_indicador;
			valores_w[nr_seq_w].ds_tipo_indicador			:= vet07.ds_tipo_indicador;
			valores_w[nr_seq_w].ds_indicador			:= vet07.ds_indicador;
			valores_w[nr_seq_w].vl_mes12				:= vet07.vl_mes_12;
			valores_w[nr_seq_w].vl_mes11				:= vet07.vl_mes_11;
			valores_w[nr_seq_w].vl_mes10				:= vet07.vl_mes_10;
			valores_w[nr_seq_w].vl_mes09				:= vet07.vl_mes_09;
			valores_w[nr_seq_w].vl_mes08				:= vet07.vl_mes_08;
			valores_w[nr_seq_w].vl_mes07				:= vet07.vl_mes_07;
			valores_w[nr_seq_w].vl_mes06				:= vet07.vl_mes_06;
			valores_w[nr_seq_w].vl_mes05				:= vet07.vl_mes_05;
			valores_w[nr_seq_w].vl_mes04				:= vet07.vl_mes_04;
			valores_w[nr_seq_w].vl_mes03				:= vet07.vl_mes_03;
			valores_w[nr_seq_w].vl_mes02				:= vet07.vl_mes_02;
			valores_w[nr_seq_w].vl_mes01				:= vet07.vl_mes_01;

			valores_w[nr_seq_w].vl_total				:= valores_w[nr_seq_w].vl_mes12	+ valores_w[nr_seq_w].vl_mes11 +
										   valores_w[nr_seq_w].vl_mes10 + valores_w[nr_seq_w].vl_mes09 +
										   valores_w[nr_seq_w].vl_mes08	+ valores_w[nr_seq_w].vl_mes07 +
									           valores_w[nr_seq_w].vl_mes06 + valores_w[nr_seq_w].vl_mes05 +
									           valores_w[nr_seq_w].vl_mes04 + valores_w[nr_seq_w].vl_mes03 +
										   valores_w[nr_seq_w].vl_mes02 + valores_w[nr_seq_w].vl_mes01;

			valores_w[nr_seq_w].vl_media				:= dividir_sem_round(valores_w[nr_seq_w].vl_total,nr_meses_p);

		end;
		end loop;
		close C07;

		open C08;
		loop
		fetch C08 into
			vet08;
		EXIT WHEN NOT FOUND; /* apply on C08 */
			begin

			nr_seq_w					:= nr_seq_w + 1;
			valores_w[nr_seq_w].cd_estabelecimento		:= cd_estabelecimento_w;
			valores_w[nr_seq_w].cd_centro_controle		:= centro_w[i].cd_centro_controle;
			valores_w[nr_seq_w].ie_tipo_indicador		:= vet08.ie_tipo_indicador;
			valores_w[nr_seq_w].ds_tipo_indicador		:= vet08.ds_tipo_indicador;
			valores_w[nr_seq_w].ds_indicador		:= vet08.ds_indicador;
			valores_w[nr_seq_w].vl_mes12			:= vet08.vl_mes_12;
			valores_w[nr_seq_w].vl_mes11			:= vet08.vl_mes_11;
			valores_w[nr_seq_w].vl_mes10			:= vet08.vl_mes_10;
			valores_w[nr_seq_w].vl_mes09			:= vet08.vl_mes_09;
			valores_w[nr_seq_w].vl_mes08			:= vet08.vl_mes_08;
			valores_w[nr_seq_w].vl_mes07			:= vet08.vl_mes_07;
			valores_w[nr_seq_w].vl_mes06			:= vet08.vl_mes_06;
			valores_w[nr_seq_w].vl_mes05			:= vet08.vl_mes_05;
			valores_w[nr_seq_w].vl_mes04			:= vet08.vl_mes_04;
			valores_w[nr_seq_w].vl_mes03			:= vet08.vl_mes_03;
			valores_w[nr_seq_w].vl_mes02			:= vet08.vl_mes_02;
			valores_w[nr_seq_w].vl_mes01			:= vet08.vl_mes_01;

			valores_w[nr_seq_w].vl_total			:= valores_w[nr_seq_w].vl_mes12	+ valores_w[nr_seq_w].vl_mes11 +
									   valores_w[nr_seq_w].vl_mes10 + valores_w[nr_seq_w].vl_mes09 +
									   valores_w[nr_seq_w].vl_mes08	+ valores_w[nr_seq_w].vl_mes07 +
 								           valores_w[nr_seq_w].vl_mes06 + valores_w[nr_seq_w].vl_mes05 +
								           valores_w[nr_seq_w].vl_mes04 + valores_w[nr_seq_w].vl_mes03 +
									   valores_w[nr_seq_w].vl_mes02 + valores_w[nr_seq_w].vl_mes01;

			--vl_media_ww			:= dividir_sem_round(vet08.vl_custo,vet08.qt_disponibilidade);
			vl_custo_w					:=	(vet08.vl_custo_01 + vet08.vl_custo_02 +
										 vet08.vl_custo_03 + vet08.vl_custo_04 +
										 vet08.vl_custo_05 + vet08.vl_custo_06 +
										 vet08.vl_custo_07 + vet08.vl_custo_08 +
										 vet08.vl_custo_09 + vet08.vl_custo_10 +
										 vet08.vl_custo_11 + vet08.vl_custo_12);

			qt_disp_w					:=	(vet08.qt_disp_01 + vet08.qt_disp_02 +
										 vet08.qt_disp_03 + vet08.qt_disp_04 +
										 vet08.qt_disp_05 + vet08.qt_disp_06 +
										 vet08.qt_disp_07 + vet08.qt_disp_08 +
										 vet08.qt_disp_09 + vet08.qt_disp_10 +
										 vet08.qt_disp_11 + vet08.qt_disp_12);

			valores_w[nr_seq_w].vl_media			:= 	dividir_sem_round(vl_custo_w,qt_disp_w);

		end;
		end loop;
		close C08;
		end;
	end loop;


	end;
end loop;
close C00;

for nr_seq_w in 1..valores_w.count loop
	begin
	ie_gerar_w	:= 'S';
	qt_reg_w	:= qt_reg_w + 1;
	if (ie_zero_p = 'S') and (valores_w[nr_seq_w].vl_mes01 = 0) and (valores_w[nr_seq_w].vl_mes02 = 0) and (valores_w[nr_seq_w].vl_mes03 = 0) and (valores_w[nr_seq_w].vl_mes04 = 0) and (valores_w[nr_seq_w].vl_mes05 = 0) and (valores_w[nr_seq_w].vl_mes06 = 0) and (valores_w[nr_seq_w].vl_mes07 = 0) and (valores_w[nr_seq_w].vl_mes08 = 0) and (valores_w[nr_seq_w].vl_mes09 = 0) and (valores_w[nr_seq_w].vl_mes10 = 0) and (valores_w[nr_seq_w].vl_mes11 = 0) and (valores_w[nr_seq_w].vl_mes12 = 0) then
		ie_gerar_w	:= 'N';
	end if;

	if (valores_w.count > 1000) then
		if (qt_reg_w >= 1000) then
			qt_reg_w	:= qt_Reg_w + 0;
			commit;
		end if;
	else
		if (qt_reg_w >= 100) then
			qt_reg_w	:= qt_Reg_w + 0;
			commit;
		end if;
	end if;

	if (ie_gerar_w = 'S') then
		begin

		insert into w_result_centro_controle(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_estabelecimento,
			cd_centro_controle,
			ds_centro_controle,
			ie_classif_conta,
			ds_classificacao,
			ds_natureza_gasto,
			ds_tipo_indicador,
			ie_tipo_indicador,
			ds_indicador,
			nr_seq_ng,
			ie_tipo_gasto,
			nr_seq_gng,
			vl_mes01,
			vl_mes02,
			vl_mes03,
			vl_mes04,
			vl_mes05,
			vl_mes06,
			vl_mes07,
			vl_mes08,
			vl_mes09,
			vl_mes10,
			vl_mes11,
			vl_mes12,
			vl_media,
			vl_total,
			vl_orc01,
			vl_orc02,
			vl_orc03,
			vl_orc04,
			vl_orc05,
			vl_orc06,
			ie_emite,
			dt_mes_referencia,
			nr_seq_indicador)
		values (	nr_seq_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			valores_w[nr_seq_w].cd_estabelecimento,
			valores_w[nr_seq_w].cd_centro_controle,
			valores_w[nr_seq_w].ds_centro_controle,
			valores_w[nr_seq_w].ie_classif_conta,
			valores_w[nr_seq_w].ds_classificacao,
			valores_w[nr_seq_w].ds_natureza_gasto,
			valores_w[nr_seq_w].ds_tipo_indicador,
			valores_w[nr_seq_w].ie_tipo_indicador,
			valores_w[nr_seq_w].ds_indicador,
			valores_w[nr_seq_w].nr_seq_ng,
			trim(both valores_w[nr_seq_w].ie_tipo_gasto),
			valores_w[nr_seq_w].nr_seq_gng,
			valores_w[nr_seq_w].vl_mes01,
			valores_w[nr_seq_w].vl_mes02,
			valores_w[nr_seq_w].vl_mes03,
			valores_w[nr_seq_w].vl_mes04,
			valores_w[nr_seq_w].vl_mes05,
			valores_w[nr_seq_w].vl_mes06,
			valores_w[nr_seq_w].vl_mes07,
			valores_w[nr_seq_w].vl_mes08,
			valores_w[nr_seq_w].vl_mes09,
			valores_w[nr_seq_w].vl_mes10,
			valores_w[nr_seq_w].vl_mes11,
			valores_w[nr_seq_w].vl_mes12,
			valores_w[nr_seq_w].vl_media,
			valores_w[nr_seq_w].vl_total,
			valores_w[nr_seq_w].vl_orc01,
			valores_w[nr_seq_w].vl_orc02,
			valores_w[nr_seq_w].vl_orc03,
			valores_w[nr_seq_w].vl_orc04,
			valores_w[nr_seq_w].vl_orc05,
			valores_w[nr_seq_w].vl_orc06,
			valores_w[nr_seq_w].ie_emite,
			dt_mes_referencia_w,
			valores_w[nr_seq_w].nr_seq_indicador);
		end;
	end if;
	end;
end loop;

if (ie_totalizar_centro_p = 'S') then
	begin
	nr_seq_w	:= valores_w.count;
	nr_seq_centro_w	:= nr_seq_w;
	valores_w.Delete;
	for j in 1..12 loop
			begin
			rec_liquida_w[j].vl_mes	:= 0;
			end;
		end loop;
	nr_seq_classif_w	:= 0;
	open C09;
	loop
	fetch C09 into
		vet09;
	EXIT WHEN NOT FOUND; /* apply on C09 */
		begin
		nr_seq_centro_w	:= nr_seq_centro_w + 1;

		if (coalesce(vet09.ie_classif_conta,0) <> 0) then

			if (coalesce(vet09.ie_classif_conta,0) <> nr_seq_classif_w) then
				nr_seq_classif_w	:= vet09.ie_classif_conta;
				valores_w.delete;
			end if;

			select	coalesce(max(ie_receita_liquida),'N'),
				coalesce(max(ie_emite_perc),'N')
			into STRICT	ie_receita_liquida_w,
				ie_emite_perc_w
			from	classif_result
			where	cd_classificacao	= vet09.ie_classif_conta;



			if (ie_receita_liquida_w = 'S') then
				begin
				rec_liquida_w[01].vl_mes	:= coalesce(rec_liquida_w[01].vl_mes,0) + vet09.vl_mes01;
				rec_liquida_w[02].vl_mes	:= coalesce(rec_liquida_w[02].vl_mes,0) + vet09.vl_mes02;
				rec_liquida_w[03].vl_mes	:= coalesce(rec_liquida_w[03].vl_mes,0) + vet09.vl_mes03;
				rec_liquida_w[04].vl_mes	:= coalesce(rec_liquida_w[04].vl_mes,0) + vet09.vl_mes04;
				rec_liquida_w[05].vl_mes	:= coalesce(rec_liquida_w[05].vl_mes,0) + vet09.vl_mes05;
				rec_liquida_w[06].vl_mes	:= coalesce(rec_liquida_w[06].vl_mes,0) + vet09.vl_mes06;
				rec_liquida_w[07].vl_mes	:= coalesce(rec_liquida_w[07].vl_mes,0) + vet09.vl_mes07;
				rec_liquida_w[08].vl_mes	:= coalesce(rec_liquida_w[08].vl_mes,0) + vet09.vl_mes08;
				rec_liquida_w[09].vl_mes	:= coalesce(rec_liquida_w[09].vl_mes,0) + vet09.vl_mes09;
				rec_liquida_w[10].vl_mes	:= coalesce(rec_liquida_w[10].vl_mes,0) + vet09.vl_mes10;
				rec_liquida_w[11].vl_mes	:= coalesce(rec_liquida_w[11].vl_mes,0) + vet09.vl_mes11;
				rec_liquida_w[12].vl_mes	:= coalesce(rec_liquida_w[12].vl_mes,0) + vet09.vl_mes12;
				end;
			end if;

			if (ie_emite_perc_w = 'S') and (coalesce(vet09.ds_natureza_gasto::text, '') = '') and (coalesce(vet09.ds_tipo_indicador::text, '') = '') and (vet09.ds_classificacao IS NOT NULL AND vet09.ds_classificacao::text <> '') then
				valores_w[nr_seq_classif_w].vl_mes12		:= vet09.vl_mes12;
				valores_w[nr_seq_classif_w].vl_mes11		:= vet09.vl_mes11;
				valores_w[nr_seq_classif_w].vl_mes10		:= vet09.vl_mes10;
				valores_w[nr_seq_classif_w].vl_mes09		:= vet09.vl_mes09;
				valores_w[nr_seq_classif_w].vl_mes08		:= vet09.vl_mes08;
				valores_w[nr_seq_classif_w].vl_mes07		:= vet09.vl_mes07;
				valores_w[nr_seq_classif_w].vl_mes06		:= vet09.vl_mes06;
				valores_w[nr_seq_classif_w].vl_mes05		:= vet09.vl_mes05;
				valores_w[nr_seq_classif_w].vl_mes04		:= vet09.vl_mes04;
				valores_w[nr_seq_classif_w].vl_mes03		:= vet09.vl_mes03;
				valores_w[nr_seq_classif_w].vl_mes02		:= vet09.vl_mes02;
				valores_w[nr_seq_classif_w].vl_mes01		:= vet09.vl_mes01;
			elsif (ie_emite_perc_w = 'S') and (substr(vet09.ds_natureza_gasto,1,1) = '%') then

				vet09.vl_mes12			:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_mes12, rec_liquida_w[12].vl_mes) * 100;
				vet09.vl_mes11			:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_mes11, rec_liquida_w[11].vl_mes) * 100;
				vet09.vl_mes10			:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_mes10, rec_liquida_w[10].vl_mes) * 100;
				vet09.vl_mes09			:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_mes09, rec_liquida_w[09].vl_mes) * 100;
				vet09.vl_mes08			:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_mes08, rec_liquida_w[08].vl_mes) * 100;
				vet09.vl_mes07			:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_mes07, rec_liquida_w[07].vl_mes) * 100;
				vet09.vl_mes06			:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_mes06, rec_liquida_w[06].vl_mes) * 100;
				vet09.vl_mes05			:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_mes05, rec_liquida_w[05].vl_mes) * 100;
				vet09.vl_mes04			:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_mes04, rec_liquida_w[04].vl_mes) * 100;
				vet09.vl_mes03			:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_mes03, rec_liquida_w[03].vl_mes) * 100;
				vet09.vl_mes02			:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_mes02, rec_liquida_w[02].vl_mes) * 100;
				vet09.vl_mes01			:= dividir_sem_round(valores_w[nr_seq_classif_w].vl_mes01, rec_liquida_w[01].vl_mes) * 100;
			end if;

		end if;

		if (position(',' in cd_centro_superior_w) = 0) then
			begin
			select	substr(ds_centro_controle,1,255)
			into STRICT	vet09.ds_centro_controle
			from	centro_controle
			where	cd_centro_controle = cd_centro_superior_w
			and	cd_estabelecimento = cd_estab_p;
			exception
			when others then
				null;
			end;
		end if;

		vet09.ds_centro_controle := substr(Wheb_mensagem_pck.get_texto(299243) || ' ' || vet09.ds_centro_controle,1,255);

		insert into w_result_centro_controle(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_estabelecimento,
			cd_centro_controle,
			ds_centro_controle,
			ie_classif_conta,
			ds_classificacao,
			ds_natureza_gasto,
			ds_tipo_indicador,
			ie_tipo_indicador,
			ds_indicador,
			nr_seq_ng,
			ie_tipo_gasto,
			nr_seq_gng,
			vl_mes01,
			vl_mes02,
			vl_mes03,
			vl_mes04,
			vl_mes05,
			vl_mes06,
			vl_mes07,
			vl_mes08,
			vl_mes09,
			vl_mes10,
			vl_mes11,
			vl_mes12,
			vl_media,
			vl_total,
			vl_orc01,
			vl_orc02,
			vl_orc03,
			vl_orc04,
			vl_orc05,
			vl_orc06,
			dt_mes_referencia)
		values (	nr_seq_centro_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			vet09.cd_estabelecimento,
			99999999,
			vet09.ds_centro_controle,
			vet09.ie_classif_conta,
			vet09.ds_classificacao,
			vet09.ds_natureza_gasto,
			vet09.ds_tipo_indicador,
			vet09.ie_tipo_indicador,
			vet09.ds_indicador,
			vet09.nr_seq_ng,
			trim(both vet09.ie_tipo_gasto),
			vet09.nr_seq_gng,
			vet09.vl_mes01,
			vet09.vl_mes02,
			vet09.vl_mes03,
			vet09.vl_mes04,
			vet09.vl_mes05,
			vet09.vl_mes06,
			vet09.vl_mes07,
			vet09.vl_mes08,
			vet09.vl_mes09,
			vet09.vl_mes10,
			vet09.vl_mes11,
			vet09.vl_mes12,
			vet09.vl_media,
			vet09.vl_total,
			vet09.vl_orc01,
			vet09.vl_orc02,
			vet09.vl_orc03,
			vet09.vl_orc04,
			vet09.vl_orc05,
			vet09.vl_orc06,
			dt_mes_referencia_w);
		end;
	end loop;
	close C09;

	if (ie_centro_atual_p = 'S') then

		delete	from w_result_centro_controle
		where	nm_usuario	= nm_usuario_p
		and	nr_sequencia	<= nr_seq_w;
	end if;
	end;
end if;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE w_gerar_w_res_centro_controle ( cd_empresa_p bigint, cd_estab_p bigint, cd_centro_controle_p text, nr_meses_p bigint, cd_tabela_custo_p bigint, nr_seq_tabela_p bigint, ie_relatorio_p text, ie_centro_resultado_p text, ie_centro_superior_p text, cd_centro_superior_p text, nr_seq_ng_p text, cd_classificacao_p text, ie_tipo_relat_ng_p text, nr_seq_gng_p text, ie_tipo_centro_controle_p text, ie_tipo_gasto_p text, ie_totalizar_centro_p text, ie_zero_p text, ie_result_orc_p text, ie_somente_ativo_p text, ie_centro_atual_p text, ie_ordem_inversa_p text, nm_usuario_p text, nr_seq_unid_neg_p bigint) FROM PUBLIC;

