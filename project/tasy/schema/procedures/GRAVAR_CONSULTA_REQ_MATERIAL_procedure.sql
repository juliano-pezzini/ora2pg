-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_consulta_req_material ( cd_estabelecimento_p bigint, cd_local_estoque_p bigint, cd_local_atende_p bigint, cd_setor_atendimento_p bigint, cd_pessoa_requisitante_p text, nm_usuario_p text, ie_consignado_p text, qt_itens_desdobra_req_p bigint, nr_requisicao_p INOUT bigint) AS $body$
DECLARE

			 
dt_atualizacao_w      		timestamp     := clock_timestamp();
dt_mesano_referencia_w   		timestamp;
cd_material_w        		integer  := 0;
cd_operacao_transf_setor_w 	smallint  := 0;
nr_requisicao_w       		bigint  := 0;
nr_sequencia_w       		integer  := 0;
qt_estoque_minimo_w     		double precision := 0;
qt_estoque_maximo_w     		double precision := 0;
qt_estoque_w        		double precision := 0;
qt_estoque_req_w      		double precision := 0;
qt_multiplo_w			double precision := 0;
qt_minimo_multiplo_solic_w 		double precision := 0;
qt_requisitada_w      		double precision := 0;
qt_prescr_cirurgia_w      		double precision := 0;
qt_lancado_cirurgia_w		double precision := 0;
qt_agenda_cirurgia_w		double precision := 0;
qt_conv_estoque_consumo_w  	double precision := 0;
cd_unidade_medida_consumo_w 	varchar(30) := '';
cd_unidade_medida_estoque_w 	varchar(30) := '';
cd_unidade_medida_solic_w		varchar(30) := '';
ie_situacao_op_w			varchar(1);
ds_operacao_w			varchar(40);
cd_conta_contabil_w		varchar(20) := '';
qt_itens_desdobra_req_w		bigint := 0;
qt_itens_gerados_w			bigint := 0;
ds_requisicoes_geradas_w		varchar(4000);
nr_sequencia_ww    		integer  := 0;
cd_fornecedor_w			varchar(14);

/* Shift + F11 = 'Regra para consistência do item disp. mercado' */
 
qt_existe_regra_disp_mer_w		bigint;
ie_acao_disp_mercado_w		varchar(1) := 'N';
ie_momento_gerar_vl_item_req_w	varchar(1);
ie_valor_gerar_para_item_req_w	varchar(1);
vl_item_w				double precision;

c01 CURSOR FOR 
SELECT	w.nr_sequencia, 
    	w.cd_material, 
   	w.qt_material_requisitada, 
   	w.cd_unidade_medida, 
    	w.qt_estoque, 
   	w.cd_unidade_medida_estoque, 
	w.cd_conta_contabil, 
	w.cd_fornecedor 
from	w_requisicao_material w 
where	w.nm_usuario = nm_usuario_p 
order by w.nr_sequencia;


BEGIN 
/* Shift + F11 = 'Regra para consistência do item disp. mercado' */
 
delete from w_consist_disp_mercado 
where nm_usuario = nm_usuario_p 
and  cd_funcao = 919;
commit;
 
ie_valor_gerar_para_item_req_w := Obter_Param_Usuario(919, 82, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_valor_gerar_para_item_req_w);
ie_momento_gerar_vl_item_req_w := Obter_Param_Usuario(919, 83, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_momento_gerar_vl_item_req_w);
 
qt_itens_desdobra_req_w	:= coalesce(qt_itens_desdobra_req_p,0);
	 
	if (ie_consignado_p = 'N') then 
		select	coalesce(max(cd_operacao_transf_setor), 0) 
		into STRICT 	cd_operacao_transf_setor_w 
		from 	parametro_estoque 
		where	cd_estabelecimento	= cd_estabelecimento_p;
		if (cd_operacao_transf_setor_w = 0) then 
			CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(281274);
		end if;
	elsif (ie_consignado_p = 'S') then 
		select	coalesce(max(cd_operacao_transf_setor_consi), 0) 
		into STRICT 	cd_operacao_transf_setor_w 
		from 	parametro_estoque 
		where	cd_estabelecimento	= cd_estabelecimento_p;
		if (cd_operacao_transf_setor_w = 0) then 
			CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(281275);
		end if;
	end if;
 
	if (cd_operacao_transf_setor_w > 0) then 
		select	coalesce(max(ie_situacao),'I'), 
			coalesce(max(ds_operacao),'') 
		into STRICT 	ie_situacao_op_w, 
			ds_operacao_w 
		from 	operacao_estoque 
		where	cd_operacao_estoque = cd_operacao_transf_setor_w;
		if (ie_situacao_op_w = 'I') then 
			CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(281278, 'CD_OPERACAO_TRANSF=' || cd_operacao_transf_setor_w || ';' || 'DS_OPERACAO=' || ds_operacao_w);
							 
		end if;
	end if;
 
	select	nextval('requisicao_seq') 
	into STRICT	nr_requisicao_w 
	;
 
	begin 
	insert into requisicao_material( 
		nr_requisicao, 
		cd_estabelecimento, 
		cd_local_estoque, 
		dt_solicitacao_requisicao, 
		dt_atualizacao, 
		nm_usuario, 
		cd_operacao_estoque, 
		cd_pessoa_requisitante, 
		cd_estabelecimento_destino, 
		cd_local_estoque_destino, 
		cd_setor_atendimento, 
		ie_urgente, 
		ie_geracao) 
	values (	nr_requisicao_w, 
		cd_estabelecimento_p, 
		cd_local_atende_p, 
		dt_atualizacao_w, 
		dt_atualizacao_w, 
		nm_usuario_p, 
		cd_operacao_transf_setor_w, 
		cd_pessoa_requisitante_p, 
		cd_estabelecimento_p, 
		cd_local_estoque_p, 
		cd_setor_atendimento_p, 
		'N', 
		'A');
	exception when others then 
	    CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(281280);
	end;
	ds_requisicoes_geradas_w := nr_requisicao_w;
 
	open c01;
	loop 
	fetch c01 into 
		nr_sequencia_w, 
		cd_material_w, 
		qt_requisitada_w, 
		cd_unidade_medida_consumo_w, 
		qt_estoque_req_w, 
		cd_unidade_medida_estoque_w, 
		cd_conta_contabil_w, 
		cd_fornecedor_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin 
 
		/* Verifica se possui evento na 'Regra para consistência do item disp. mercado' */
 
		select	count(*) 
		into STRICT	qt_existe_regra_disp_mer_w 
		from	consiste_disp_mercado 
		where	cd_evento = 'RA';
 
		if (qt_existe_regra_disp_mer_w > 0) then 
			begin 
			/* Verifica se possui evento na 'Regra para consistência do item disp. mercado', e se o material está disponível no mercado */
 
			select substr(obter_acao_regra_disp_mercado('RA', cd_material_w, null, cd_estabelecimento_p),1,1) ie_acao_regra 
			into STRICT	ie_acao_disp_mercado_w 
			;
 
			if (ie_acao_disp_mercado_w <> 'N') then 
				begin 
				CALL grava_consiste_disp_mercado( 919, 
							   cd_material_w, 
							   nm_usuario_p, 
							   ie_acao_disp_mercado_w);
				end;
			end if;
 
			end;
		end if;
		if (ie_acao_disp_mercado_w in ('M', 'N')) then 
			begin 
 
			if (qt_itens_desdobra_req_w > 0) and (qt_itens_gerados_w = qt_itens_desdobra_req_w) then 
				begin 
				CALL gravar_estoque_requisicao_lib(nr_requisicao_w, nm_usuario_p);
				 
				select	nextval('requisicao_seq') 
				into STRICT	nr_requisicao_w 
				;
				 
				begin 
				insert into requisicao_material( 
					nr_requisicao, 
					cd_estabelecimento, 
					cd_local_estoque, 
					dt_solicitacao_requisicao, 
					dt_atualizacao, 
					nm_usuario, 
					cd_operacao_estoque, 
					cd_pessoa_requisitante, 
					cd_estabelecimento_destino, 
					cd_local_estoque_destino, 
					cd_setor_atendimento, 
					ie_urgente, 
					ie_geracao) 
				values (	nr_requisicao_w, 
					cd_estabelecimento_p, 
					cd_local_atende_p, 
					dt_atualizacao_w, 
					dt_atualizacao_w, 
					nm_usuario_p, 
					cd_operacao_transf_setor_w, 
					cd_pessoa_requisitante_p, 
					cd_estabelecimento_p, 
					cd_local_estoque_p, 
					cd_setor_atendimento_p, 
					'N', 
					'A');
				exception when others then 
					CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(281280);
				end;
				 
				ds_requisicoes_geradas_w := substr(ds_requisicoes_geradas_w || ', ' || nr_requisicao_w,1,4000);
				nr_sequencia_ww	:= 0;
				qt_itens_gerados_w := 0;
				end;
			end if;
			 
			if (qt_itens_desdobra_req_w > 0) then 
				begin 
				nr_sequencia_ww := coalesce(nr_sequencia_ww,0) + 1;
				nr_sequencia_w := nr_sequencia_ww;
				end;
			end if;
			 
			insert into item_requisicao_material( 
				nr_requisicao, 
				nr_sequencia, 
				cd_estabelecimento, 
				cd_material, 
				qt_material_requisitada, 
				qt_material_atendida, 
				vl_material, 
				dt_atualizacao, 
				nm_usuario, 
				cd_unidade_medida, 
				qt_estoque, 
				cd_unidade_medida_estoque, 
				ie_acao, 
				cd_motivo_baixa, 
				cd_conta_contabil, 
				cd_cgc_fornecedor) 
			values (	nr_requisicao_w, 
				nr_sequencia_w, 
				cd_estabelecimento_p, 
				cd_material_w, 
				qt_requisitada_w, 
				0, 
				0, 
				dt_atualizacao_w, 
				nm_usuario_p, 
				cd_unidade_medida_consumo_w, 
				qt_estoque_req_w, 
				cd_unidade_medida_estoque_w, 
				'1', 
				0, 
				cd_conta_contabil_w, 
				cd_fornecedor_w);	
			qt_itens_gerados_w	:= coalesce(qt_itens_gerados_w,0) + 1;
			 
			if (coalesce(ie_momento_gerar_vl_item_req_w, 'L') = 'S') and (coalesce(ie_valor_gerar_para_item_req_w, 'U') <> 'N') then 
				begin 
				vl_item_w := coalesce(sup_obter_valores_material_req(nr_requisicao_w, nr_sequencia_w, ie_valor_gerar_para_item_req_w),0);
				 
				update	item_requisicao_material 
				set	vl_unit_previsto = vl_item_w 
				where	nr_requisicao = nr_requisicao_w 
				and	nr_sequencia = nr_sequencia_w;
			 
				end;
			end if;
 
			end;
		end if;
		end;		
	end loop;
	close c01;
if (qt_itens_desdobra_req_w > 0) then 
	begin 
	update	requisicao_material 
	set	ds_observacao = substr(WHEB_MENSAGEM_PCK.get_texto(281281) || ds_requisicoes_geradas_w,1,255) 
	where	substr(obter_se_contido(nr_requisicao,ds_requisicoes_geradas_w),1,1) = 'S';
	end;
end if;	
 
if (coalesce(qt_itens_gerados_w,0) = 0) then 
	delete from requisicao_material 
	where nr_requisicao 	= nr_requisicao_w;
	nr_requisicao_w		:= 0;
else 
	CALL gravar_estoque_requisicao_lib(nr_requisicao_w, nm_usuario_p);
end if;
 
commit;	
nr_requisicao_p			:= nr_requisicao_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_consulta_req_material ( cd_estabelecimento_p bigint, cd_local_estoque_p bigint, cd_local_atende_p bigint, cd_setor_atendimento_p bigint, cd_pessoa_requisitante_p text, nm_usuario_p text, ie_consignado_p text, qt_itens_desdobra_req_p bigint, nr_requisicao_p INOUT bigint) FROM PUBLIC;

