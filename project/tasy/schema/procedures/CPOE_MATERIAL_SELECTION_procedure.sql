-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_material_selection ( nr_atendimento_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_pessoa_fisica_p text, nr_seq_item_gerado_p INOUT bigint, ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, cd_material_p cpoe_material.cd_material%type DEFAULT NULL, nr_seq_cpoe_order_unit_p cpoe_material.nr_seq_cpoe_order_unit%type DEFAULT NULL) AS $body$
DECLARE


cd_material_w				material.cd_material%type;
cd_unidade_medida_w			varchar(30);



BEGIN
	
	cd_material_w := cd_material_p;

      if (coalesce(nr_seq_cpoe_order_unit_p, 0) > 0) then

            select	max(substr(obter_dados_material_estab(cd_material,cd_estabelecimento_p,'UMS'),1,30))
            into STRICT	cd_unidade_medida_w
            from	material
            where	cd_material	= cd_material_w;			

            select	nextval('cpoe_material_seq')
            into STRICT	nr_seq_item_gerado_p
;

            insert into 
            cpoe_material(nr_sequencia, 
                          nr_atendimento, 
                          cd_pessoa_fisica,
                          cd_material, 
                          cd_unidade_medida, 
                          nm_usuario, 
                          nm_usuario_nrec, 
                          dt_atualizacao, 
                          dt_atualizacao_nrec, 
                          cd_perfil_ativo,
                          cd_funcao_origem,
                          ie_prescritor_aux,
                          cd_medico,
                          ie_material,
                          nr_seq_cpoe_order_unit
                          )			
            values (	nr_seq_item_gerado_p,
                    nr_atendimento_p, 
                    cd_pessoa_fisica_p,
                    cd_material_w,
                    cd_unidade_medida_w,
                    nm_usuario_p,
                    nm_usuario_p,
                    clock_timestamp(),
                    clock_timestamp(),
                    cd_perfil_p,
                    2314,
                    ie_prescritor_aux_p,
                    cd_medico_p,
                    'S',
                    nr_seq_cpoe_order_unit_p);		
            commit;
    end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_material_selection ( nr_atendimento_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_pessoa_fisica_p text, nr_seq_item_gerado_p INOUT bigint, ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, cd_material_p cpoe_material.cd_material%type DEFAULT NULL, nr_seq_cpoe_order_unit_p cpoe_material.nr_seq_cpoe_order_unit%type DEFAULT NULL) FROM PUBLIC;

