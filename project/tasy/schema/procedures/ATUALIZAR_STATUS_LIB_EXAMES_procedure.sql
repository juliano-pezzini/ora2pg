-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_status_lib_exames ( nr_prescricao_p bigint, nm_usuario_p text, nr_seq_grupo_p bigint default 0, ds_lista_nr_seq_prescr_p text default NULL) AS $body$
DECLARE




nr_seq_interno_w		bigint;
nr_seq_prescr_w			bigint;
nr_seq_resultado_w		bigint;
nr_seq_grupo_w	        bigint;
ie_verifica_assinatura_w varchar(1);


C01 CURSOR FOR
	SELECT  a.nr_seq_interno,
		a.nr_sequencia
	FROM	prescr_procedimento a,
		exame_laboratorio b
	WHERE	b.nr_seq_exame = a.nr_seq_exame
	AND	a.ie_status_atend = 35
	AND	a.nr_prescricao = nr_prescricao_p
	AND	b.nr_seq_grupo = coalesce(nr_seq_grupo_w,b.nr_seq_grupo)
	AND ((coalesce(ds_lista_nr_seq_prescr_p::text, '') = '') or (Obter_se_contido(a.nr_sequencia, ds_lista_nr_seq_prescr_p) = 'S'))
	and	((ie_verifica_assinatura_w = 'N')
	or (a.nr_sequencia in (	SELECT 	y.nr_seq_prescr
							from 	exame_lab_resultado t,
									exame_lab_result_item y
							where 	t.nr_seq_resultado = y.nr_seq_resultado
							and 	t.nr_prescricao = a.nr_prescricao
							and 	y.nr_seq_prescr = a.nr_sequencia
							and		(y.nr_seq_material IS NOT NULL AND y.nr_seq_material::text <> '')
							and		(y.nr_seq_assinatura IS NOT NULL AND y.nr_seq_assinatura::text <> ''))));


BEGIN

if (nr_seq_grupo_p = 0)then
	nr_seq_grupo_w := null;
else
	nr_seq_grupo_w := nr_seq_grupo_p;
end if;

select  coalesce(max(nr_seq_resultado),0)
into STRICT	nr_seq_resultado_w
from	exame_lab_resultado
where	nr_prescricao	= nr_prescricao_p;

ie_verifica_assinatura_w	:= coalesce(obter_valor_param_usuario(722, 364, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento),'N');

open C01;
loop
fetch C01 into
	nr_seq_interno_w,
	nr_seq_prescr_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	update	exame_lab_result_item
	set	dt_atualizacao = clock_timestamp(),
		nm_usuario     = nm_usuario_p,
		nm_usuario_liberacao =  nm_usuario_p,
		dt_liberacao = clock_timestamp()
	where	nr_seq_resultado   = nr_seq_resultado_w
	and	nr_seq_prescr    = nr_seq_prescr_w
	and 	(nr_seq_material IS NOT NULL AND nr_seq_material::text <> '');

	update 	Prescr_procedimento
	set 	ie_status_atend = 40,
		nm_usuario = nm_usuario_p,
		dt_atualizacao = clock_timestamp()
	where  	nr_seq_interno	= nr_seq_interno_w;

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_status_lib_exames ( nr_prescricao_p bigint, nm_usuario_p text, nr_seq_grupo_p bigint default 0, ds_lista_nr_seq_prescr_p text default NULL) FROM PUBLIC;

