-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_comunic_alt_versao (nr_seq_alt_versao_p bigint, nm_usuario_p text) AS $body$
DECLARE


nm_usuario_regra_w		varchar(4000);
nm_usuario_regra_aux_w	varchar(4000);
ds_comunicado_w			varchar(4000);
ds_motivo_w				varchar(2000);
ds_acao_cliente_w		varchar(2000);
ds_titulo_w				varchar(100);
cd_versao_w				varchar(15);
cd_build_w				varchar(10);
ie_motivo_w				varchar(8);
nr_seq_classif_w		bigint;
cd_perfil_w             varchar(2000);
cd_perfil_aux_w         varchar(2000);
ds_funcao_w				varchar(255);
nr_ordem_erro_w			bigint;
cd_aplicacao_tasy_w		varchar(10);

C01 CURSOR FOR
	SELECT	a.nm_usuario_regra,
	    	a.cd_perfil
	from	regra_comunic_alt_versao a
	where	a.ie_situacao	= 'A';


BEGIN
open C01;
loop
fetch C01 into
	nm_usuario_regra_aux_w,
	cd_perfil_aux_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	if (nm_usuario_regra_aux_w IS NOT NULL AND nm_usuario_regra_aux_w::text <> '') then
		nm_usuario_regra_w	:= nm_usuario_regra_w || nm_usuario_regra_aux_w || ', ';
        elsif (cd_perfil_aux_w IS NOT NULL AND cd_perfil_aux_w::text <> '') then
		cd_perfil_w := cd_perfil_w || cd_perfil_aux_w || ', ';
        end if;
	end;
end loop;
close C01;

if (nm_usuario_regra_w IS NOT NULL AND nm_usuario_regra_w::text <> '') or (cd_perfil_w IS NOT NULL AND cd_perfil_w::text <> '') then
	select	max(a.nr_sequencia)
	into STRICT	nr_seq_classif_w
	from	comunic_interna_classif	a
	where	a.ie_tipo	= 'U'
	and	a.ie_situacao	= 'A';

	select	substr(a.ds_titulo,1,100),
		CASE WHEN a.ie_motivo='E' THEN  'Erro'  ELSE 'Melhoria' END ,
		substr(a.ds_motivo,1,1600),
		substr(a.ds_acao_cliente,1, 1600),
		a.cd_versao,
		a.cd_build,
		substr(obter_desc_funcao(a.cd_funcao),1,255),
		a.nr_ordem_erro,
		a.cd_aplicacao
	into STRICT	ds_titulo_w,
		ie_motivo_w,
		ds_motivo_w,
		ds_acao_cliente_w,
		cd_versao_w,
		cd_build_w,
		ds_funcao_w,
		nr_ordem_erro_w,
		cd_aplicacao_tasy_w
	from	versao_alteracao a
	where	a.nr_sequencia	= nr_seq_alt_versao_p;

	if (cd_aplicacao_tasy_w = 'Tasy') then
		begin
		ds_comunicado_w	:= substr(obter_desc_expressao(345437)/*'Título: '*/
 || ds_titulo_w || chr(10) || chr(10) ||--108
								  obter_desc_expressao(299396)/*'Tipo alteração: '*/
 || ie_motivo_w || chr(10) || chr(10) || --24
								  obter_desc_expressao(327458)/*'Motivo: '*/
 || ds_motivo_w || chr(10) || chr(10) ||-- 1908
								  obter_desc_expressao(721942)/*'Ação: '*/
 || ds_acao_cliente_w || chr(10) || chr(10) || --1906
								  obter_desc_expressao(648223)/*'Versão: '*/
 || cd_versao_w || chr(13) || obter_desc_expressao(302729)/*'Build: '*/ ||': '|| cd_build_w || chr(10) || chr(10) || --40
								  obter_desc_expressao(345366)/*'Função: '*/
 || ds_funcao_w || chr(10) || chr(10) ||
								  obter_desc_expressao(604907)/*'OS defeito: '*/
 ||': '|| nr_ordem_erro_w,1,4000);

		insert into comunic_interna(nr_sequencia,
			nm_usuario,
			dt_atualizacao,
			dt_comunicado,
			ie_gerencial,
			ds_titulo,
			ds_comunicado,
			nm_usuario_destino,
			nr_seq_classif,
			ds_perfil_adicional,
			dt_liberacao,
			ie_geral)
		values (nextval('comunic_interna_seq'),
			nm_usuario_p,
			clock_timestamp(),
			clock_timestamp(),
			'N',
			'Liberação de versão',
			ds_comunicado_w,
			nm_usuario_regra_w,
			nr_seq_classif_w,
			cd_perfil_w,
			clock_timestamp(),
			'N');
		end;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_comunic_alt_versao (nr_seq_alt_versao_p bigint, nm_usuario_p text) FROM PUBLIC;

