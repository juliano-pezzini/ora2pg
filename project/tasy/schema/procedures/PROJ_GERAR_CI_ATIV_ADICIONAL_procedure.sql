-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE proj_gerar_ci_ativ_adicional ( nr_seq_projeto_p bigint, nr_seq_rat_p bigint, nr_seq_rat_ativ_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE
	
 
cd_coordenador_w		varchar(10);
ds_comunicado_w		varchar(4000);
ds_etapa_w		varchar(255);
ds_justificativa_w		varchar(2000);
ds_titulo_w		varchar(80);
ds_titulo_ci_w		varchar(255);
nm_consultor_w		varchar(255);
nm_projeto_w		varchar(255);
nm_usuario_destino_w	varchar(15);
qt_registros_w		bigint;
nr_seq_etapa_cron_w	bigint;
ie_ativ_extra_w		varchar(1) := 'N';


BEGIN 
select	coalesce(a.ie_atividade_extra,ie_ativ_extra_w) 
into STRICT	ie_ativ_extra_w 
from	proj_rat_ativ a 
where	a.nr_sequencia = nr_seq_rat_ativ_p;
 
if (ie_ativ_extra_w = 'S') then 
	begin 
	-- Busca o título e o coordenador do projeto 
	select	substr(ds_titulo,1,80), 
		cd_coordenador 
	into STRICT	ds_titulo_w, 
		cd_coordenador_w 
	from	proj_projeto 
	where	nr_sequencia = nr_seq_projeto_p;
 
	-- Monta o título da CI 
	ds_titulo_ci_w := substr('Lançamento de atividade adicional na RAT (' || nr_seq_rat_p || ') - ('|| ds_titulo_w || ') ',1,255);
 
	-- Busca o usuário do coordenador do projeto 
	select	count(*) 
	into STRICT	qt_registros_w 
	from	usuario 
	where	cd_pessoa_fisica = cd_coordenador_w;
 
	if (qt_registros_w > 0) then 
		select	max(nm_usuario) 
		into STRICT	nm_usuario_destino_w 
		from	usuario 
		where	cd_pessoa_fisica = cd_coordenador_w;
	else 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(191476);
	end if;
 
	-- Busca o nome do consultor da atividade 
	select	substr(obter_nome_pf(cd_executor),1,255) 
	into STRICT	nm_consultor_w 
	from	proj_rat 
	where	nr_sequencia = nr_seq_rat_p;
 
	-- Busca o título da etapa e o texto da justificativa 
	begin 
	select	substr(trim(both e.ds_atividade),1,255), 
		substr(r.ds_justificativa,1,2000), 
		r.nr_seq_etapa_cron 
	into STRICT	ds_etapa_w, 
		ds_justificativa_w, 
		nr_seq_etapa_cron_w 
	from	proj_rat_ativ r, 
		proj_cron_etapa e 
	where	e.nr_sequencia = r.nr_seq_etapa_cron 
	and	r.nr_sequencia = nr_seq_rat_ativ_p;
	exception when others then 
		ds_etapa_w		:= '';
		nr_seq_etapa_cron_w	:= null;
	end;
 
	if (nr_seq_etapa_cron_w IS NOT NULL AND nr_seq_etapa_cron_w::text <> '') then 
		begin 
		-- Monta o comunicado 
		ds_comunicado_w	:= substr(	'Número da Rat: ' 		||	nr_seq_rat_p		|| chr(13) || chr(10) || 
					'Projeto: '			||	ds_titulo_w		|| chr(13) || chr(10) || 
					'Consultor: '		||	nm_consultor_w		|| chr(13) || chr(10) || 
					'Atividade/Descrição: '	|| 	nr_seq_etapa_cron_w || ' / ' || ds_etapa_w, 1, 4000);
 
		-- Gera a comunicação interna 
		CALL gerar_comunic_padrao(	'', 
					ds_titulo_ci_w, 
					ds_comunicado_w, 
					nm_usuario_p, 
					'N', 
					nm_usuario_destino_w, 
					'N', 
					'', 
					'', 
					cd_estabelecimento_p, 
					'', 
					clock_timestamp(), 
					'', 
					'');
		end;
	end if;
	commit;
	end;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proj_gerar_ci_ativ_adicional ( nr_seq_projeto_p bigint, nr_seq_rat_p bigint, nr_seq_rat_ativ_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

