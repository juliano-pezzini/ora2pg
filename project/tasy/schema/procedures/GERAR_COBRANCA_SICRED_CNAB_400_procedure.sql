-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cobranca_sicred_cnab_400 ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_conteudo_w			varchar(4000);
cd_cgc_w			varchar(4000);
dt_remessa_w			varchar(4000);
nr_nosso_numero_w		varchar(4000);
dt_vencimento_w			varchar(4000);
vl_titulo_w			varchar(4000);
vl_desconto_w			varchar(4000);
nr_titulo_w			varchar(4000);
vl_juros_diario_w		varchar(4000);
vl_desconto_diario_w		varchar(4000);
ie_tipo_pessoa_w		varchar(4000);
cd_cgc_cpf_w			varchar(4000);
nm_sacado_w			varchar(4000);
ds_endereco_w			varchar(4000);
nr_carteira_w			varchar(4000);
cd_cep_w			varchar(4000);
nr_remessa_w			bigint;
nr_seq_apres_w			bigint	:= 0;
nr_seq_registro_w		bigint;
nr_seq_reg_arquivo_w		bigint	:= 1;
cd_cedente_w			banco_estabelecimento.cd_cedente%type;
tx_multa_w			varchar(4);
			
C01 CURSOR FOR
	SELECT	lpad(substr(coalesce(b.nr_nosso_numero,'0'),1,9),9,'0') nr_nosso_numero,
		to_char(coalesce(b.dt_vencimento,clock_timestamp()),'ddmmyy') dt_vencimento,
		replace(to_char(coalesce(b.vl_titulo,0), 'fm00000000000.00'),'.','') vl_titulo,
		replace(to_char(coalesce(b.vl_desc_previsto,0), 'fm00000000.00'),'.','') vl_desconto,
		lpad(coalesce(c.nr_titulo,'0'),10,'0') nr_titulo,
		--replace(to_char(nvl(b.vl_titulo,0)*nvl(b.tx_juros,0), 'fm00000000000.00'),'.','') vl_juros_diario,
		replace(to_char(b.tx_juros, 'fm00000000000.00'),'.','') vl_juros_diario,
		replace(to_char(coalesce(b.vl_titulo,0)*coalesce(b.tx_desc_antecipacao,0), 'fm00000000000.00'),'.','') vl_desconto_diario,
		CASE WHEN coalesce(b.cd_cgc::text, '') = '' THEN '1'  ELSE '2' END  ie_tipo_pessoa,
		lpad(coalesce(b.cd_cgc_cpf,'0'),14, '0') cd_cgc_cpf,
		rpad(elimina_caractere_esp_asc(substr(obter_nome_pf_pj(b.cd_pessoa_fisica,b.cd_cgc),1,40),'S','N'),40,' ') nm_sacado,
		RPAD(elimina_caractere_esp_asc(coalesce(SUBSTR(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN SUBSTR(obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'E'),1,24)||' N.'||SUBSTR(obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'NR'),1,4)||' - '||SUBSTR(obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CO'),1,6)    ELSE SUBSTR(pls_obter_compl_pagador(d.nr_seq_pagador,'E'),1,24)||' N.'||SUBSTR(pls_obter_compl_pagador(d.nr_seq_pagador,'NR'),1,4)||' - '||SUBSTR(pls_obter_compl_pagador(d.nr_seq_pagador,'CO'),1,6) END ,1,40),' '),'S','N'),40,' ') ds_endereco,			
		lpad(coalesce(e.cd_carteira,'0'),5,'0') nr_carteira,
		rpad(coalesce(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CEP')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'CEP') END ,1,8),' '),8,' ') cd_cep,
		replace(to_char(substr(b.tx_multa,1,4), 'fm00.00'),'.','')
	FROM banco_estabelecimento e, titulo_receber_cobr c, cobranca_escritural a, titulo_receber_v b
LEFT OUTER JOIN pls_mensalidade d ON (b.nr_seq_mensalidade = d.nr_sequencia)
WHERE a.nr_sequencia		= c.nr_seq_cobranca and c.nr_titulo		= b.nr_titulo and a.nr_seq_conta_banco	= e.nr_sequencia  and a.nr_sequencia		= nr_seq_cobr_escrit_p;


BEGIN
delete from w_envio_banco
where nm_usuario = nm_usuario_p;

/*	Header do Arquivo	*/

select	nextval('w_envio_banco_seq'),
	to_char(a.dt_remessa_retorno,'YYYYMMDD'),
	coalesce(a.nr_remessa,a.nr_sequencia),
	c.cd_cgc
into STRICT	nr_seq_registro_w,
	dt_remessa_w,
	nr_remessa_w,
	cd_cgc_w
from	pessoa_juridica		c,
	estabelecimento 	b,
	cobranca_escritural 	a
where	a.cd_estabelecimento	= b.cd_estabelecimento
and	b.cd_cgc		= c.cd_cgc
and	a.nr_sequencia		= nr_seq_cobr_escrit_p;	

select	substr(coalesce(max(a.cd_cedente),0),1,5)
into STRICT	cd_cedente_w
from	banco_estabelecimento a,
		cobranca_escritural b
where	b.nr_seq_conta_banco 	= a.nr_sequencia
and		b.nr_sequencia 			= nr_seq_cobr_escrit_p;	

ds_conteudo_w	:= 	'01' 			||
			'REMESSA' 		||
			'01' 			||
			'COBRANCA       ' 	||
			lpad(cd_cedente_w,5,0)				|| /*Pos 27 a 31*/
			cd_cgc_w 		||
			lpad(' ',31,' ') 	||
			'748' 			||
			rpad('SICREDI',15,' ') 	||
			dt_remessa_w 		||
			lpad(' ',8,' ') 	||
			lpad(nr_remessa_w,7,'0')||
			lpad(' ',273,' ') 	||
			'2.00' 			||
			lpad(nr_seq_reg_arquivo_w,6,'0');

nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;
nr_seq_apres_w 		:= nr_seq_apres_w + 1;

insert into w_envio_banco(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	cd_estabelecimento,
	ds_conteudo,
	nr_seq_apres)
values (nr_seq_registro_w,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	cd_estabelecimento_p,
	ds_conteudo_w,
	nr_seq_apres_w);
/* 	Fim - Header do Arquivo		*/
	

/*	Detalhe	*/
	
open C01;
loop
fetch C01 into	
	nr_nosso_numero_w,
	dt_vencimento_w,
	vl_titulo_w,
	vl_desconto_w,
	nr_titulo_w,
	vl_juros_diario_w,
	vl_desconto_diario_w,
	ie_tipo_pessoa_w,
	cd_cgc_cpf_w,
	nm_sacado_w,
	ds_endereco_w,
	nr_carteira_w,
	cd_cep_w,
	tx_multa_w;	
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	select	nextval('w_envio_banco_seq')
	into STRICT	nr_seq_registro_w
	;
	
	ds_conteudo_w	:=	'1' || /*Pos 01*/
				'A' || /*Pos 02*/
				'A' || /*Pos 03*/
				'A' || /*Pos 04*/
				lpad(' ',12,' ') || /*Pos 05 a 16*/
				'A' || /*Pos 17*/
				'A' || /*Pos 18*/
				'A' || /*Pos 19*/
				lpad(' ',28,' ') || /*Pos 20 a 47*/
				lpad(coalesce(nr_nosso_numero_w,'0'),9,'0') || /*Pos 48 a 56*/
				lpad(' ',6,' ') || /*Pos 57 a62*/
				to_char(clock_timestamp(),'YYYYMMDD') || /*Pos 63 a 70*/
				' ' || /*Pos 71*/
				'N' || /*Pos 72*/
				' ' || /*Pos 73*/
				'B' || /*Pos 74*/
				'00' || /*Pos 75 a 76*/
				'00' || /*Pos 77 a 78*/
				'    ' || /*Pos 79 a 82*/
				vl_desconto_w || /*Pos 83 a 92*/
				tx_multa_w || /*Pos 93 a 96*/
				lpad(' ',12,' ') || /*Pos 97 a 108*/
				'01' || /*Pos 109 a 110*/
				nr_titulo_w || /*Pos 111 a 120*/
				dt_vencimento_w || /*Pos 121 a 126*/
				vl_titulo_w || /*Pos 127 a  139*/
				lpad(' ',9,' ') || /*Pos 140 a 148*/
				'A' || /*Pos 149*/
				'S' || /*Pos 150 */
				to_char(clock_timestamp(),'DDMMYY') || /*Pos 151 a 156*/
				'06' || /*Pos 157 a 158*/
				'10' || /*Pos 159 a 160*/
				vl_juros_diario_w || /*161 a 173*/
				to_char(clock_timestamp(),'DDMMYY') ||
				vl_desconto_diario_w ||
				lpad('0',13,'0') ||
				lpad('0',13,'0') ||
				ie_tipo_pessoa_w ||
				'0' ||
				cd_cgc_cpf_w ||
				nm_sacado_w ||
				ds_endereco_w ||
				lpad('0',5,'0') ||
				lpad('0',6,'0') ||
				' ' ||
				cd_cep_w || /*327 a 334*/
				'00000' || /*335 a 339*/
				'00000000000000' || /**/
				rpad(' ',41,' ') ||
				lpad(nr_seq_reg_arquivo_w,6,'0');
	
	nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;
	nr_seq_apres_w 		:= nr_seq_apres_w + 1;

	insert into w_envio_banco(nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_estabelecimento,
		ds_conteudo,
		nr_seq_apres)
	values (nr_seq_registro_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_p,
		ds_conteudo_w,
		nr_seq_apres_w);	
	end;
end loop;
close C01;
/*	Fim - Detalhe	*/



/*	Trailer	*/

select	nextval('w_envio_banco_seq')
into STRICT	nr_seq_registro_w
;

ds_conteudo_w	:=	'9' ||
			'1' ||
			'748' ||
			lpad(cd_cedente_w,5,0) ||
			lpad(' ',384,' ') ||
			lpad(nr_seq_reg_arquivo_w,6,'0');
			
nr_seq_apres_w 		:= nr_seq_apres_w + 1;

insert into w_envio_banco(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	cd_estabelecimento,
	ds_conteudo,
	nr_seq_apres)
values (nr_seq_registro_w,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	cd_estabelecimento_p,
	ds_conteudo_w,
	nr_seq_apres_w);
/*	Fim - Trailer	*/

commit;	
end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cobranca_sicred_cnab_400 ( nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

