-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE recalcular_protocolo ( nr_seq_protocolo_p bigint, nm_usuario_p text, ie_recalcular_sadt_p text, ie_somente_resumo_p text) AS $body$
DECLARE


nr_interno_conta_w		bigint;

ie_tipo_convenio_w		smallint;
ie_tipo_protocolo_w		smallint;
cd_estabelecimento_w		smallint;
ie_diaria_sus_w			varchar(1);
nm_paciente_w			varchar(60);
qt_contador_pb_w		bigint;
qt_proc_sus_unif_w		bigint := 0;
cd_convenio_w			integer;
qt_registro_w			bigint;
qt_titulo_prot_w		bigint;
ie_tipo_protocolo_aih_w		smallint;
ie_forma_rateio_sadt_w		varchar(1);
ie_zerar_proced_psiquiatria_w	varchar(15);
ie_momento_rateio_sh_w		varchar(15) := 'P';

ie_recalcular_pacote_w		parametro_faturamento.ie_recalcular_pacote%type;

c01 CURSOR FOR
SELECT	a.nr_interno_conta,
	obter_paciente_conta(a.nr_interno_conta, 'D') nm_paciente
from 	conta_paciente a
where 	a.nr_seq_protocolo		= nr_seq_protocolo_p
and	qt_titulo_prot_w		= 0
and 	not exists (SELECT	1
	from 	titulo_receber x
	where	x.nr_interno_conta	= a.nr_interno_conta)
order 	by nm_paciente, a.nr_interno_conta;


BEGIN

qt_contador_pb_w := 0;
CALL gravar_processo_longo(WHEB_MENSAGEM_PCK.get_texto(298867) ,'RECALCULAR_PROTOCOLO',qt_contador_pb_w);

ie_zerar_proced_psiquiatria_w := obter_param_usuario(1125, 114, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_zerar_proced_psiquiatria_w);

begin
select		a.ie_tipo_convenio,
		b.ie_tipo_protocolo,
		b.cd_estabelecimento,
		a.cd_convenio
into STRICT		ie_tipo_convenio_w,
		ie_tipo_protocolo_w,
		cd_estabelecimento_w,
		cd_convenio_w
from		convenio a,
		protocolo_convenio b
where		a.cd_convenio		= b.cd_convenio
and		b.nr_seq_protocolo	= nr_seq_protocolo_p;
exception
		when others then
		begin
		ie_tipo_convenio_w 	:= 0;
		ie_tipo_protocolo_w	:= 0;
		cd_estabelecimento_w	:= 1;
		cd_convenio_w		:= 0;
		end;
end;

select	count(*)
into STRICT	qt_titulo_prot_w
from	titulo_receber
where	nr_seq_protocolo	= nr_seq_protocolo_p;

select	count(*)
into STRICT	qt_proc_sus_unif_w
from	procedimento_paciente	b,
	conta_paciente		a
where	a.nr_interno_conta	= b.nr_interno_conta
and	b.ie_origem_proced	= 7
and	a.nr_seq_protocolo	= nr_seq_protocolo_p;

select	coalesce(max(ie_diaria_sus),'R')
into STRICT	ie_diaria_sus_w
from	sus_parametros
where	cd_estabelecimento	= cd_estabelecimento_w;

select	coalesce(max(ie_tipo_protocolo_aih),1),	/* felipe martini em 03/09/2008 os107244 */
	coalesce(max(ie_recalcular_pacote),'N')
into STRICT	ie_tipo_protocolo_aih_w,
	ie_recalcular_pacote_w
from	parametro_faturamento
where	cd_estabelecimento	= cd_estabelecimento_w;

if (ie_tipo_convenio_w	= 3) 	and (ie_tipo_protocolo_w	= 1)	and (qt_proc_sus_unif_w	= 0)	then
		CALL atualizar_procedimento_sus();
end if;

open c01;
loop
fetch c01 into
	nr_interno_conta_w,
	nm_paciente_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	qt_contador_pb_w := qt_contador_pb_w + 1;
	CALL gravar_processo_longo(nm_paciente_w || ' - ' || nr_interno_conta_w,'RECALCULAR_PROTOCOLO',qt_contador_pb_w);
	
	if (ie_recalcular_pacote_w	= 'S') 	then
		CALL recalcular_pacotes_conta(nr_interno_conta_w, nm_usuario_p, 'N');
	end if;
	
	if (ie_somente_resumo_p = 'S') then
		begin
		CALL atualizar_conta_contabil_conta(nr_interno_conta_w, 'S');
		CALL atualiza_codigo_convenio(nr_interno_conta_w, 0);
		CALL atualizar_resumo_conta(nr_interno_conta_w, 2);
		end;
	else
		CALL recalcular_conta_paciente(nr_interno_conta_w, nm_usuario_p);
	end if;
	end;
end loop;
close c01;

if (ie_tipo_convenio_w	= 3) and (qt_titulo_prot_w 		= 0) then
	if (ie_tipo_protocolo_w	= ie_tipo_protocolo_aih_w) 	then

		select	coalesce(max(ie_momento_rateio_sh),'P')
		into STRICT	ie_momento_rateio_sh_w
		from	sus_parametros_aih
		where	cd_estabelecimento	= cd_estabelecimento_w;

		if (ie_recalcular_sadt_p 	= 'S') then
			if (qt_proc_sus_unif_w	= 0) then
				CALL atualizar_valor_ponto_sadt(nr_seq_protocolo_p);
			elsif (qt_proc_sus_unif_w	> 0) then
				CALL sus_atualizar_valor_sadt(nr_seq_protocolo_p, nm_usuario_p);
				CALL atualizar_resumo_conta(nr_interno_conta_w, 2);
			end if;
		end if;
		if (ie_diaria_sus_w	= 'C') and (qt_proc_sus_unif_w	= 0) then
			CALL sus_rateio_sh(nr_seq_protocolo_p, nm_usuario_p);
		elsif (coalesce(ie_momento_rateio_sh_w,'P') = 'P') then
			CALL sus_atualiza_valor_sh(nr_seq_protocolo_p,nm_usuario_p);
			CALL atualizar_resumo_conta(nr_interno_conta_w, 2);
		end if;
	elsif (ie_tipo_protocolo_w	= 20) and (coalesce(ie_zerar_proced_psiquiatria_w,'S') = 'S') then
		CALL sus_ajustar_procpaci_grupo(nr_seq_protocolo_p, nm_usuario_p);
	end if;
end if;

select	count(*)
into STRICT	qt_registro_w
from	convenio_sadt
where	cd_convenio = cd_convenio_w;

select 	coalesce(max(ie_forma_rateio_sadt),'P')
into STRICT	ie_forma_rateio_sadt_w
from 	convenio_estabelecimento
where 	cd_convenio = cd_convenio_w
and 	cd_estabelecimento = cd_estabelecimento_w;

if (qt_registro_w	<> 0) and (ie_forma_rateio_sadt_w = 'P') then
	CALL atualizar_valor_sadt(nr_seq_protocolo_p,nm_usuario_p);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE recalcular_protocolo ( nr_seq_protocolo_p bigint, nm_usuario_p text, ie_recalcular_sadt_p text, ie_somente_resumo_p text) FROM PUBLIC;

