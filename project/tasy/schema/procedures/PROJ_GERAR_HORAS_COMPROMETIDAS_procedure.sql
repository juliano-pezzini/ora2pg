-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE proj_gerar_horas_comprometidas ( nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
dt_inicio_prev_w		timestamp;
dt_fim_prev_w		timestamp;
qt_horas_w		double precision;
qt_horas_fim_w		double precision;
dt_atual_w		timestamp;
dt_anterior_w		timestamp;
ie_mes_w			smallint := 0;
nr_seq_cliente_w		bigint;
nr_seq_modulo_w		bigint;
cd_estabelecimento_w	smallint;

C01 CURSOR FOR
SELECT	a.dt_inicio_prev,
		a.dt_fim_prev,
		c.nr_seq_cliente,
		b.nr_seq_modulo,
		c.cd_estabelecimento
from	proj_cron_etapa a,
		funcao	b,
		proj_projeto c,
		proj_cronograma d,
		proj_agenda e
where	a.cd_funcao = b.cd_funcao
and		c.nr_sequencia = d.nr_seq_proj
and		d.nr_sequencia = a.nr_seq_cronograma
and		coalesce(a.ie_fase,'N') = 'N'
and		coalesce(a.dt_inicio_prev,clock_timestamp()) > clock_timestamp()
and		c.nr_seq_classif <> 15
and		e.nr_seq_proj = c.nr_sequencia
and		e.ie_status = wheb_mensagem_pck.get_texto(310961) -- Confirmada
order 	by a.dt_inicio_prev, a.nr_sequencia;


BEGIN
open C01;
loop
fetch C01 into
	dt_inicio_prev_w,
	dt_fim_prev_w,
	nr_seq_cliente_w,
	nr_seq_modulo_w,
	cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	dt_atual_w	:= dt_inicio_prev_w;
	qt_horas_w	:= null;
	qt_horas_fim_w	:= null;

	if (to_char(dt_inicio_prev_w,'mm') = to_char(dt_fim_prev_w,'mm')) then
		qt_horas_w	:= obter_horas_compr_periodo(dt_inicio_prev_w, dt_fim_prev_w, cd_estabelecimento_w);
	else
		qt_horas_w	:= obter_horas_compr_periodo(dt_inicio_prev_w, last_day(dt_inicio_prev_w), cd_estabelecimento_w);
		qt_horas_fim_w	:= obter_horas_compr_periodo(trunc(dt_fim_prev_w,'month'), dt_fim_prev_w, cd_estabelecimento_w);
	end if;

	select	coalesce(max(nr_sequencia),0) + 1
	into STRICT	nr_sequencia_w
	from	w_comprometido_proj_com;

	insert	into w_comprometido_proj_com(
		nr_sequencia,
		nr_seq_cliente,
		cd_consultor,
		nr_seq_modulo,
		nm_usuario,
		vl_mes_01,
		vl_mes_02,
		vl_mes_03,
		vl_mes_04,
		vl_mes_05,
		vl_mes_06,
		vl_mes_07,
		vl_mes_08,
		vl_mes_09,
		vl_mes_10,
		vl_mes_11,
		vl_mes_12)
	values (nr_sequencia_w,
		nr_seq_cliente_w,
		null,
		nr_seq_modulo_w,
		nm_usuario_p,
		0,0,0,0,0,0,0,0,0,0,0,0);

	if (coalesce(dt_anterior_w::text, '') = '') or (to_char(dt_atual_w,'mm') <> to_char(dt_anterior_w,'mm')) then
		ie_mes_w 	:= ie_mes_w + 1;
	end if;

	dt_anterior_w	:= dt_atual_w;

	if (ie_mes_w = 1) then
		update	w_comprometido_proj_com
		set	vl_mes_01 = coalesce(vl_mes_01 + qt_horas_w,0),
			dt_mes_01 = dt_inicio_prev_w
		where	nr_sequencia = nr_sequencia_w;
	elsif (ie_mes_w = 2) then
		update	w_comprometido_proj_com
		set	vl_mes_02 = coalesce(vl_mes_02 + qt_horas_w,0),
			dt_mes_02 = dt_inicio_prev_w
		where	nr_sequencia = nr_sequencia_w;
	elsif (ie_mes_w = 3) then
		update	w_comprometido_proj_com
		set	vl_mes_03 = coalesce(vl_mes_03 + qt_horas_w,0),
			dt_mes_03 = dt_inicio_prev_w
		where	nr_sequencia = nr_sequencia_w;
	elsif (ie_mes_w = 4) then
		update	w_comprometido_proj_com
		set	vl_mes_04 = coalesce(vl_mes_04 + qt_horas_w,0),
			dt_mes_04 = dt_inicio_prev_w
		where	nr_sequencia = nr_sequencia_w;
	elsif (ie_mes_w = 5) then
		update	w_comprometido_proj_com
		set	vl_mes_05 = coalesce(vl_mes_05 + qt_horas_w,0),
			dt_mes_05 = dt_inicio_prev_w
		where	nr_sequencia = nr_sequencia_w;
	elsif (ie_mes_w = 6) then
		update	w_comprometido_proj_com
		set	vl_mes_06 = coalesce(vl_mes_06 + qt_horas_w,0),
			dt_mes_06 = dt_inicio_prev_w
		where	nr_sequencia = nr_sequencia_w;
	elsif (ie_mes_w = 7) then
		update	w_comprometido_proj_com
		set	vl_mes_07 = coalesce(vl_mes_07 + qt_horas_w,0),
			dt_mes_07 = dt_inicio_prev_w
		where	nr_sequencia = nr_sequencia_w;
	elsif (ie_mes_w = 8) then
		update	w_comprometido_proj_com
		set	vl_mes_08 = coalesce(vl_mes_08 + qt_horas_w,0),
			dt_mes_08 = dt_inicio_prev_w
		where	nr_sequencia = nr_sequencia_w;
	elsif (ie_mes_w = 9) then
		update	w_comprometido_proj_com
		set	vl_mes_09 = coalesce(vl_mes_09 + qt_horas_w,0),
			dt_mes_09 = dt_inicio_prev_w
		where	nr_sequencia = nr_sequencia_w;
	elsif (ie_mes_w = 10) then
		update	w_comprometido_proj_com
		set	vl_mes_10 = coalesce(vl_mes_10 + qt_horas_w,0),
			dt_mes_10 = dt_inicio_prev_w
		where	nr_sequencia = nr_sequencia_w;
	elsif (ie_mes_w = 11) then
		update	w_comprometido_proj_com
		set	vl_mes_11 = coalesce(vl_mes_11 + qt_horas_w,0),
			dt_mes_11 = dt_inicio_prev_w
		where	nr_sequencia = nr_sequencia_w;
	elsif (ie_mes_w = 12) then
		update	w_comprometido_proj_com
		set	vl_mes_12 = coalesce(vl_mes_12 + qt_horas_w,0),
			dt_mes_12 = dt_inicio_prev_w
		where	nr_sequencia = nr_sequencia_w;
	end if;

	if (qt_horas_fim_w IS NOT NULL AND qt_horas_fim_w::text <> '') then
		ie_mes_w	:= ie_mes_w + 1;
		if (ie_mes_w = 1) then
			update	w_comprometido_proj_com
			set	vl_mes_01 = coalesce(vl_mes_01 + qt_horas_fim_w,0),
				dt_mes_01 = dt_fim_prev_w
			where	nr_sequencia = nr_sequencia_w;
		elsif (ie_mes_w = 2) then
			update	w_comprometido_proj_com
			set	vl_mes_02 = coalesce(vl_mes_02 + qt_horas_fim_w,0),
				dt_mes_02 = dt_fim_prev_w
			where	nr_sequencia = nr_sequencia_w;
		elsif (ie_mes_w = 3) then
			update	w_comprometido_proj_com
			set	vl_mes_03 = coalesce(vl_mes_03 + qt_horas_fim_w,0),
				dt_mes_03 = dt_fim_prev_w
			where	nr_sequencia = nr_sequencia_w;
		elsif (ie_mes_w = 4) then
			update	w_comprometido_proj_com
			set	vl_mes_04 = coalesce(vl_mes_04 + qt_horas_fim_w,0),
				dt_mes_04 = dt_fim_prev_w
			where	nr_sequencia = nr_sequencia_w;
		elsif (ie_mes_w = 5) then
			update	w_comprometido_proj_com
			set	vl_mes_05 = coalesce(vl_mes_05 + qt_horas_fim_w,0),
				dt_mes_05 = dt_fim_prev_w
			where	nr_sequencia = nr_sequencia_w;
		elsif (ie_mes_w = 6) then
			update	w_comprometido_proj_com
			set	vl_mes_06 = coalesce(vl_mes_06 + qt_horas_fim_w,0),
				dt_mes_06 = dt_fim_prev_w
			where	nr_sequencia = nr_sequencia_w;
		elsif (ie_mes_w = 7) then
			update	w_comprometido_proj_com
			set	vl_mes_07 = coalesce(vl_mes_07 + qt_horas_fim_w,0),
				dt_mes_07 = dt_fim_prev_w
			where	nr_sequencia = nr_sequencia_w;
		elsif (ie_mes_w = 8) then
			update	w_comprometido_proj_com
			set	vl_mes_08 = coalesce(vl_mes_08 + qt_horas_fim_w,0),
				dt_mes_08 = dt_fim_prev_w
			where	nr_sequencia = nr_sequencia_w;
		elsif (ie_mes_w = 9) then
			update	w_comprometido_proj_com
			set	vl_mes_09 = coalesce(vl_mes_09 + qt_horas_fim_w,0),
				dt_mes_09 = dt_fim_prev_w
			where	nr_sequencia = nr_sequencia_w;
		elsif (ie_mes_w = 10) then
			update	w_comprometido_proj_com
			set	vl_mes_10 = coalesce(vl_mes_10 + qt_horas_fim_w,0),
				dt_mes_10 = dt_fim_prev_w
			where	nr_sequencia = nr_sequencia_w;
		elsif (ie_mes_w = 11) then
			update	w_comprometido_proj_com
			set	vl_mes_11 = coalesce(vl_mes_11 + qt_horas_fim_w,0),
				dt_mes_11 = dt_fim_prev_w
			where	nr_sequencia = nr_sequencia_w;
		elsif (ie_mes_w = 12) then
			update	w_comprometido_proj_com
			set	vl_mes_12 = coalesce(vl_mes_12 + qt_horas_fim_w,0),
				dt_mes_12 = dt_fim_prev_w
			where	nr_sequencia = nr_sequencia_w;
		end if;
		ie_mes_w	:= ie_mes_w - 1;
	end if;

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proj_gerar_horas_comprometidas ( nm_usuario_p text) FROM PUBLIC;

