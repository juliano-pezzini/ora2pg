-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_proc_pac_auditoria ( nr_sequencia_p bigint, nr_seq_auditoria_p bigint, cd_procedimento_p bigint, nr_seq_proc_interno_p bigint, nr_seq_motivo_p bigint, ie_origem_proced_p bigint, nm_usuario_p text, nr_seq_exame_lab_p bigint) AS $body$
DECLARE


nr_sequencia_prescricao_w	procedimento_paciente.nr_sequencia_prescricao%type;
nr_prescricao_w			procedimento_paciente.nr_prescricao%type;
ie_regra_exclusao_w		varchar(10);
nr_atendimento_w		procedimento_paciente.nr_atendimento%type;
nr_interno_conta_w		procedimento_paciente.nr_interno_conta%type;
nr_seq_motivo_w			bigint;
cd_convenio_w			integer;
varseqexamelab_w		varchar(1);


BEGIN

ie_regra_exclusao_w	:= obter_valor_param_usuario(67,309,obter_perfil_ativo,nm_usuario_p,wheb_usuario_pck.get_cd_estabelecimento);
varseqexamelab_w	:= obter_valor_param_usuario(67,368,obter_perfil_ativo,nm_usuario_p,wheb_usuario_pck.get_cd_estabelecimento);

update	procedimento_paciente
set 	cd_procedimento = cd_procedimento_p,
	ie_origem_proced = ie_origem_proced_p,
	cd_procedimento_convenio = CASE WHEN cd_procedimento_convenio = NULL THEN  null  ELSE cd_procedimento_p END ,
	nr_seq_proc_interno = CASE WHEN nr_seq_proc_interno_p=0 THEN null  ELSE nr_seq_proc_interno_p END ,
	nm_usuario = nm_usuario_p,
	nr_seq_exame	= coalesce(nr_seq_exame_lab_p,CASE WHEN coalesce(varseqexamelab_w,'N')='N' THEN  null  ELSE nr_seq_exame END ),
	dt_atualizacao = clock_timestamp(),
	cd_procedimento_tuss  = NULL
where	nr_sequencia = nr_sequencia_p;

nr_seq_motivo_w := nr_seq_motivo_p;

if (nr_seq_motivo_w = 0) then
	nr_seq_motivo_w := null;
end if;

update	auditoria_propaci
set	nr_seq_motivo = nr_seq_motivo_w,
	dt_atualizacao = clock_timestamp(),
	nm_usuario = nm_usuario_p
where	nr_sequencia = nr_seq_auditoria_p;

select	nr_sequencia_prescricao,
	nr_prescricao,
	nr_atendimento,
	nr_interno_conta
into STRICT	nr_sequencia_prescricao_w,
	nr_prescricao_w,
	nr_atendimento_w,
	nr_interno_conta_w
from 	procedimento_paciente
where	nr_sequencia = nr_sequencia_p;

if (nr_sequencia_prescricao_w IS NOT NULL AND nr_sequencia_prescricao_w::text <> '') and (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then
	update	prescr_procedimento
	set	cd_procedimento = cd_procedimento_p,
		ie_origem_proced = ie_origem_proced_p,
		nr_seq_proc_interno = CASE WHEN nr_seq_proc_interno_p=0 THEN null  ELSE nr_seq_proc_interno_p END ,
		nm_usuario = nm_usuario_p,
		dt_atualizacao = clock_timestamp(),
		nr_seq_exame	= CASE WHEN coalesce(varseqexamelab_w,'N')='N' THEN  null  ELSE nr_seq_exame END
	where	nr_sequencia = nr_sequencia_prescricao_w
	and	nr_prescricao = nr_prescricao_w;
end if;

if (ie_regra_exclusao_w	= 'S') then
	CALL excluir_item_conta_rla(nr_sequencia_p,wheb_usuario_pck.get_cd_estabelecimento,nm_usuario_p);
	CALL gerar_lancamento_automatico(nr_atendimento_w,null,34,nm_usuario_p,nr_sequencia_p,null,null,null,null,nr_interno_conta_w);
end if;

select	cd_convenio_parametro
into STRICT	cd_convenio_w
from	conta_paciente
where	nr_interno_conta = nr_interno_conta_w;

CALL Atualiza_Preco_Procedimento(nr_sequencia_p,cd_convenio_w,nm_usuario_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_proc_pac_auditoria ( nr_sequencia_p bigint, nr_seq_auditoria_p bigint, cd_procedimento_p bigint, nr_seq_proc_interno_p bigint, nr_seq_motivo_p bigint, ie_origem_proced_p bigint, nm_usuario_p text, nr_seq_exame_lab_p bigint) FROM PUBLIC;

