-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_ciap_problema ( nr_seq_problema_p bigint, nr_atendimento_p bigint, cd_ciap_p text, cd_medico_p text, nm_usuario_p text, ds_problema_p text) AS $body$
DECLARE

 
cd_pessoa_fisica_w 	pessoa_fisica.cd_pessoa_fisica%type;

nr_sequencia_w 		bigint;
qt_ciap_w			bigint;
cd_ciap_w			ciap_atendimento.cd_ciap%type;


BEGIN 
 
select	obter_pessoa_atendimento(nr_atendimento_p,'C') 
into STRICT	cd_pessoa_fisica_w
;
 
 
select	max(cd_ciap) 
into STRICT	cd_ciap_w 
from	ciap_Atendimento 
where	nr_atendimento	= nr_atendimento_p 
and		cd_ciap			= cd_ciap_p;
 
select	nextval('ciap_atendimento_seq') 
into STRICT	nr_sequencia_w
;
 
if (coalesce(cd_ciap_w::text, '') = '') then 
	insert into ciap_Atendimento( 
					nr_sequencia, 
					cd_ciap, 
					dt_atualizacao, 
					nm_usuario, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec, 
					cd_pessoa_fisica, 
					nr_atendimento, 
					ie_situacao, 
					dt_liberacao, 
					dt_registro, 
					ie_nivel_atencao, 
					ds_motivo_consulta, 
					cd_profissional 
					) values ( 
					nr_sequencia_w, 
					cd_ciap_p, 
					clock_timestamp(), 
					nm_usuario_p, 
					clock_timestamp(), 
					nm_usuario_p, 
					cd_pessoa_fisica_w, 
					nr_atendimento_p, 
					'A', 
					clock_timestamp(), 
					clock_timestamp(), 
					wheb_assist_pck.get_nivel_atencao_perfil, 
					ds_problema_p, 
					cd_medico_p);
end if;
 
 
select    count(1) 
into STRICT	qt_ciap_w 
from	ciap_atendimento 
where	nr_sequencia = nr_sequencia_w;
 
if (coalesce(qt_ciap_w,0) > 0) then 
					 
	insert into lista_problema_pac_item(	nr_sequencia, 
												dt_atualizacao, 
												dt_atualizacao_nrec, 
												nm_usuario, 
												nm_usuario_nrec, 
												nr_seq_problema, 
												nr_seq_registro, 
												ie_tipo_registro, 
												nm_tabela, 
												ie_tipo_problema) 
									values (		nextval('lista_problema_pac_item_seq'), 
												clock_timestamp(), 
												clock_timestamp(), 
												nm_usuario_p, 
												nm_usuario_p, 
												nr_seq_problema_p, 
												nr_sequencia_w, 
												'CP', 
												'CIAP_ATENDIMENTO', 
												cd_ciap_p);
end if;
 
 
if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_ciap_problema ( nr_seq_problema_p bigint, nr_atendimento_p bigint, cd_ciap_p text, cd_medico_p text, nm_usuario_p text, ds_problema_p text) FROM PUBLIC;

