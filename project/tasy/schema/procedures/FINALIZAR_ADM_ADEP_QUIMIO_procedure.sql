-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE finalizar_adm_adep_quimio ( ie_opcao_p text, nr_seq_atendimento_p bigint, ie_evento_p text, nr_atendimento_p bigint, dt_referencia_p timestamp, dt_real_p timestamp, nr_prescricao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_horario_p bigint default null) AS $body$
DECLARE


/*	ie_opcao_p
	F - finalizar
	D - desfazer
	*/
ie_adm_medic_termino_w	varchar(1);
ie_executa_agenda_w	varchar(1);
ie_executa_proced_prescr_w	varchar(1);
ie_motivo_altera_w		varchar(1);
ie_desfazer_adm_ordem_w	varchar(1);
nr_motivo_alta_padrao_w	bigint;
ie_gerar_alta_w		varchar(1);
ie_tipo_atendimento_w	smallint;


BEGIN
if (ie_opcao_p = 'F') then
	begin	


	/* Quimioterapia - Parametro [132] - Ao utilizar a opcao Termino administracao, caso o medicamento nao esteja administrado, administrar o mesmo */

	ie_adm_medic_termino_w := obter_param_usuario(3130, 132, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_adm_medic_termino_w);
	if (ie_adm_medic_termino_w = 'S') then
		CALL administrar_medic_quimio(nr_seq_atendimento_p, nm_usuario_p, cd_estabelecimento_p, nr_seq_horario_p);
	end if;

	/* Quimioterapia - Parametro [134] - Ao realizar termino de administracao executar os procedimentos prescritos */

	ie_executa_proced_prescr_w := obter_param_usuario(3130, 134, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_executa_proced_prescr_w);

	if (ie_executa_proced_prescr_w = 'S') then
		CALL gerar_proced_prescrito_qt(nr_prescricao_p, nm_usuario_p);
	end if;

	end;
	
	CALL atualiza_data_campo_pac_atend('DT_FIM_ADM', nr_seq_atendimento_p, 'A', nm_usuario_p);

	CALL adm_medic_adep_quimio(nr_seq_atendimento_p, nr_atendimento_p, dt_referencia_p, nr_prescricao_p, nm_usuario_p, cd_estabelecimento_p, 'A', null);
	
elsif (ie_opcao_p = 'D') then
	begin
	CALL atualiza_data_campo_pac_atend('DT_FIM_ADM', nr_seq_atendimento_p, 'D', nm_usuario_p);

	/* Quimioterapia - Parametro [46] - Ao desfazer administracao do item, desfazer administracao das ordens */

	ie_desfazer_adm_ordem_w := obter_param_usuario(3130, 46, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_desfazer_adm_ordem_w);

	if (ie_desfazer_adm_ordem_w = 'S') then
		CALL desfazer_data_admin_dose(dt_referencia_p, dt_real_p, nr_prescricao_p, nm_usuario_p, nr_seq_horario_p);
	end if;

	end;
elsif (ie_opcao_p = 'A') then
	begin	


	/* Quimioterapia - Parametro [132] - Ao utilizar a opcao "Termino administracao", caso o medicamento nao esteja administrado, administrar o mesmo */

	ie_adm_medic_termino_w := obter_param_usuario(3130, 132, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_adm_medic_termino_w);

	if (ie_adm_medic_termino_w = 'S') then
		CALL administrar_medic_quimio(nr_seq_atendimento_p, nm_usuario_p, cd_estabelecimento_p, nr_seq_horario_p);
	end if;

	/* Quimioterapia - Parametro [134] - Ao realizar termino de administracao executar os procedimentos prescritos */

	ie_executa_proced_prescr_w := obter_param_usuario(3130, 134, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_executa_proced_prescr_w);

	if (ie_executa_proced_prescr_w = 'S') then
		CALL gerar_proced_prescrito_qt(nr_prescricao_p, nm_usuario_p);
	end if;
	CALL gerar_data_admin_dose(dt_referencia_p, dt_real_p, nr_prescricao_p, nm_usuario_p, nr_seq_horario_p);
	end;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE finalizar_adm_adep_quimio ( ie_opcao_p text, nr_seq_atendimento_p bigint, ie_evento_p text, nr_atendimento_p bigint, dt_referencia_p timestamp, dt_real_p timestamp, nr_prescricao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_horario_p bigint default null) FROM PUBLIC;

