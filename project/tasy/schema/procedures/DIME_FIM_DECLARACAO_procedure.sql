-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dime_fim_declaracao ( nr_seq_controle_p bigint, cd_estabelecimento_p text, nm_usuario_p text, dt_referencia_p timestamp, ds_separador_p text, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) AS $body$
DECLARE


ds_arquivo_w		varchar(4000);
ds_linha_w		varchar(8000);
ds_quadro_w		varchar(2);
nr_linha_w		bigint	:= qt_linha_p;
nr_seq_registro_w		bigint 	:= nr_sequencia_p;
separador_w		varchar(1)	:= ds_separador_p;
tp_registro_w		varchar(2);

ds_cfop_w		varchar(2);
qt_declaracoes_w		bigint;
qt_registros_w		bigint;
vl_contabil_w		double precision;
vl_base_calculo_w		double precision;
vl_credito_w		double precision;
vl_isenta_w		double precision;
vl_outras_w		double precision;


BEGIN

select	'99' tp_registro,
	'  ' ds_quadro
into STRICT	tp_registro_w,
	ds_quadro_w
;

select	count(*)
into STRICT	qt_registros_w
from	w_dime_arquivo
where	nm_usuario = nm_usuario_p;

-- contar a quantidade de registros com os dados do contador para identificar o número de declarações do arquivo
select	count(*)
into STRICT	qt_declaracoes_w
from	w_dime_arquivo
where	cd_registro = '20';


ds_linha_w	:= 	tp_registro_w			|| separador_w || 	-- campo 01: tipo de registro [tamanho 02] preencher com "22"
			ds_quadro_w			|| separador_w || 	-- campo 02:  quadro [tamanho 02] preencher com "01"
			lpad((qt_registros_w + 1),5,0)		|| separador_w ||
			lpad((1),5,0);

ds_arquivo_w 		:= substr(ds_linha_w,1,4000);
nr_seq_registro_w 	:= nr_seq_registro_w + 1;
nr_linha_w 		:= nr_linha_w + 1;

-- insert na tabela do dime
insert into w_dime_arquivo(		nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_controle_dime,
				nr_linha,
				cd_registro,
				ds_arquivo)
		values (	nextval('w_dime_arquivo_seq'),
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_controle_p,
				nr_linha_w,
				tp_registro_w,
				ds_arquivo_w);

commit;

qt_linha_p := nr_linha_w;
nr_sequencia_p := nr_seq_registro_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dime_fim_declaracao ( nr_seq_controle_p bigint, cd_estabelecimento_p text, nm_usuario_p text, dt_referencia_p timestamp, ds_separador_p text, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) FROM PUBLIC;

