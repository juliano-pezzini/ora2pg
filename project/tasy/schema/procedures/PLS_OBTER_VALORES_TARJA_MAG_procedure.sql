-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_valores_tarja_mag ( ds_tarja_magnetica_p text, nm_beneficiario_p out text, cd_usuario_plano_p out text, nr_via_p out text, dt_validade_p out text, cd_operadora_p out text, dt_validade_format_p out timestamp, dt_nascimento_p out timestamp, nm_produto_p out text, nr_seq_produto_p out bigint, ds_abrangencia_p out text, ie_abrangencia_p out text, ie_tipo_contratacao_p out text, cd_plano_tarja_mag_p out text, nm_usuario_p text, cd_estabelecimento_p bigint) is ds_tarja_magnetica_w varchar(255) AS $body$
DECLARE

			
ds_retorno_w	varchar(255);
			
BEGIN

if (ie_tipo_contratacao_p IS NOT NULL AND ie_tipo_contratacao_p::text <> '') then
	if (ie_tipo_contratacao_p in ('2','5')) then
		ds_retorno_w	:= 'I';
	elsif (ie_tipo_contratacao_p = '3') then
		ds_retorno_w	:= 'CE';
	elsif (ie_tipo_contratacao_p = '4') then
		ds_retorno_w	:= 'CA';
	end if;
else
	ds_retorno_w	:= null;
end if;

return;

end;

function obter_abrangencia(	ie_opcao_p		varchar2,
				ie_abrangencia_p	varchar2)
			return;
	
begin

if (ie_abrangencia_p IS NOT NULL AND ie_abrangencia_p::text <> '') then
	if (ie_abrangencia_p = '1') then
		if (ie_opcao_p = 'DS') then
			ds_retorno_w	:= 'Nac.';
		elsif (ie_opcao_p = 'AB') then
			ds_retorno_w	:= ie_abrangencia_p;
		elsif (ie_opcao_p = 'AP') then
			ds_retorno_w	:= 'N';
		end if;
	elsif (ie_abrangencia_p = '2') then
		if (ie_opcao_p = 'DS') then
			ds_retorno_w	:= 'Reg.A';
		elsif (ie_opcao_p = 'AB') then
			ds_retorno_w	:= ie_abrangencia_p;
		elsif (ie_opcao_p = 'AP') then
			ds_retorno_w	:= 'GE';
		end if;
	elsif (ie_abrangencia_p = '3') then
		if (ie_opcao_p = 'DS') then
			ds_retorno_w	:= 'Est.';
		elsif (ie_opcao_p = 'AB') then
			ds_retorno_w	:= ie_abrangencia_p;
		elsif (ie_opcao_p = 'AP') then
			ds_retorno_w	:= 'E';
		end if;
	elsif (ie_abrangencia_p = '4') then
		if (ie_opcao_p = 'DS') then
			ds_retorno_w	:= 'Reg. B';
		elsif (ie_opcao_p = 'AB') then
			ds_retorno_w	:= ie_abrangencia_p;
		elsif (ie_opcao_p = 'AP') then
			ds_retorno_w	:= 'GM';
		end if;
	elsif (ie_abrangencia_p = '5') then
		if (ie_opcao_p = 'DS') then
			ds_retorno_w	:= 'Mun.';
		elsif (ie_opcao_p = 'AB') then
			ds_retorno_w	:= ie_abrangencia_p;
		elsif (ie_opcao_p = 'AP') then
			ds_retorno_w	:= 'M';
		end if;
	end if;
else
	ds_retorno_w	:= null;
end if;

return;

end;

begin

select	max(cd_cgc_outorgante)
into STRICT	cd_cgc_outorgante_w
from	pls_outorgante
where	cd_estabelecimento	= cd_estabelecimento_p;

begin
select	max(cd_base_cgc)
into STRICT	cd_base_cgc_w
from	empresa
where	cd_empresa = (	SELECT	max(cd_empresa)
			from	estabelecimento
			where	cd_estabelecimento	= cd_estabelecimento_p);
exception
when others then
	cd_base_cgc_w := null;
end;

ie_restringe_estab_w	:= coalesce(obter_valor_param_usuario(1273, 8, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p),'N');
ie_caracter_w := obter_expressao_dic_objeto(1104115);

if (cd_cgc_outorgante_w	= '11939445000158') then --Beneficencia Portuguesa
	ds_tarja_magnetica_w		:= ds_tarja_magnetica_p;
	ds_caracter_porcentagem_w	:= substr(ds_tarja_magnetica_w,1,2);
	qt_caracteres_total_w		:= length(ds_tarja_magnetica_w);
	
	/*Caso a tarja venha com 2 %%, entao retira 1*/

	if (ds_caracter_porcentagem_w	= '%%') then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,2,qt_caracteres_total_w);
	end if;
	
	qt_caracteres_carteira_w	:= position('=' in ds_tarja_magnetica_w) - 1;
	
	/*Monta o cartao do beneficiario comencando da direira para a esquerda ate encontrar um caracter nao-numero*/

	IF (qt_caracteres_carteira_w	> 0) THEN
		FOR i IN REVERSE qt_caracteres_carteira_w..1 LOOP
			ds_caracter_aux_w	:= substr(ds_tarja_magnetica_w,i,1);
			begin
				cd_campo_w	:= (ds_caracter_aux_w)::numeric;
			exception
			when others then
				exit;	
			end;
		
			cd_cartao_user_w	:= ds_caracter_aux_w||cd_cartao_user_w;	
		END LOOP;
		
		qt_posicao_codigo_cart_w	:= position(cd_cartao_user_w in ds_tarja_magnetica_w);
		
		nr_via_aux_w			:= substr(ds_tarja_magnetica_w,qt_caracteres_carteira_w+2,2);
		nr_via_aux_w			:= Somente_Numero(nr_via_aux_w);
		
		cd_usuario_plano_p	:= (cd_cartao_user_w)::numeric;
		nm_beneficiario_w	:= upper(substr(ds_tarja_magnetica_w,2,qt_posicao_codigo_cart_w-4));
		nm_beneficiario_p	:= replace(replace(nm_beneficiario_w,'%',''),':','');
		nr_via_p		:= nr_via_aux_w;
		dt_validade_p		:= '';
		cd_operadora_p		:= '';
		dt_validade_format_p	:= NULL;
		cd_produto_w		:= '';
		ie_abrangencia_w	:= '';
		ie_tipo_contratacao_w	:= '';
	end if;
elsif (cd_cgc_outorgante_w = '03637776000105') then -- Filosanitas Saude LTDA
	ds_tarja_magnetica_w	:= ds_tarja_magnetica_p;
	cd_usuario_plano_p	:= upper(substr(ds_tarja_magnetica_w,2,14));
	nr_via_p		:= '0';
	dt_validade_p		:= '';
	cd_produto_w		:= '';
	cd_operadora_p		:= '';
	dt_validade_format_p	:= '';
	ie_abrangencia_w	:= '';
	ie_tipo_contratacao_w	:= '';
	
	begin
	select	substr(tws_get_name_person(b.cd_pessoa_fisica, b.cd_estabelecimento),1,100)
	into STRICT	nm_beneficiario_p
	from	pls_segurado_carteira	a,
		pls_segurado		b
	where	a.nr_seq_segurado	= b.nr_sequencia
	and	a.cd_usuario_plano	= cd_usuario_plano_p;
	exception
	when others then
		nm_beneficiario_p	:= '';
	end;
elsif (cd_cgc_outorgante_w = '82624776000147') or -- Unimed Blumenau
	(cd_cgc_outorgante_w = '76767219000182') then --Unimed Maringa
	select	CASE WHEN substr(ds_tarja_magnetica_p,length(ds_tarja_magnetica_p),1)=chr(10) THEN  substr(ds_tarja_magnetica_p,1,length(ds_tarja_magnetica_p)-1)  ELSE ds_tarja_magnetica_p END
	into STRICT	ds_tarja_magnetica_w
	;
	
	select	somente_letra_espaco_trim(substr(ds_tarja_magnetica_w,2,position(chr(10) in ds_tarja_magnetica_w))) trilha1,
		somente_numero_char(substr(ds_tarja_magnetica_w,position(chr(10) in ds_tarja_magnetica_w),length(ds_tarja_magnetica_w))) trilha2
	into STRICT	ds_trilha1_w,
		ds_trilha2_w
	;
	
	cd_usuario_plano_p	:= substr(ds_trilha2_w,1,17);
	nr_via_p		:= substr(ds_trilha2_w,18,2);
	begin
	dt_validade_p		:= substr(ds_trilha2_w,22,2) || '/' || substr(ds_trilha2_w,20,2);
	dt_validade_format_p	:= to_date('01/' || substr(ds_trilha2_w,22,2) || '/20' || substr(ds_trilha2_w,20,2), 'dd/mm/yyyy');
	exception
	when others then
		dt_validade_p		:= null;
		dt_validade_format_p	:= null;
	end;
	cd_operadora_p		:= substr(ds_trilha2_w,2,3);
	cd_produto_w		:= substr(ds_trilha2_w,28,3);
	ie_abrangencia_w	:= substr(ds_trilha2_w,31,1);
	ie_tipo_contratacao_w	:= substr(ds_trilha2_w,32,1);
	
	begin
	select	substr(tws_get_name_person(b.cd_pessoa_fisica, b.cd_estabelecimento),1,100)
	into STRICT	nm_beneficiario_p
	from	pls_segurado_carteira	a,
		pls_segurado		b
	where	a.nr_seq_segurado	= b.nr_sequencia
	and	a.cd_usuario_plano	= cd_usuario_plano_p;
	exception
	when others then
		nm_beneficiario_p	:= ds_trilha1_w;
	end;
	
	ie_tipo_contratacao_p	:= obter_tipo_contratacao(ie_tipo_contratacao_w);
	ds_abrangencia_p	:= obter_abrangencia('DS',ie_abrangencia_w);
	ie_abrangencia_p	:= obter_abrangencia('AB',ie_abrangencia_w);
	ie_abrangencia_ww	:= obter_abrangencia('AP',ie_abrangencia_w);
	
	begin
	select	max(nr_sequencia),
		nm_fantasia
	into STRICT	nr_seq_produto_p,
		nm_produto_p
	from	pls_plano
	where	cd_tarja_magnetica 		= cd_produto_w
	and	coalesce(ie_tipo_operacao, 'T') 	= 'T'
	and	cd_estabelecimento		= cd_estabelecimento_p
	and	((ie_tipo_contratacao = ie_tipo_contratacao_p) or (coalesce(ie_tipo_contratacao_p::text, '') = ''))
	and	((ie_abrangencia = ie_abrangencia_ww) or (coalesce(ie_abrangencia_ww::text, '') = ''))
	group by
		nm_fantasia;
	exception
	when others then
		nm_produto_p	:= '';
	end;
	
	if (cd_produto_w IS NOT NULL AND cd_produto_w::text <> '') then
		cd_plano_tarja_mag_p	:= cd_produto_w;
	end if;
elsif (cd_cgc_outorgante_w	= '45359213000142') then --Unimed Sao Carlos  
	ds_tarja_magnetica_w		:= ds_tarja_magnetica_p;
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,chr(13),'');
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,chr(10),'');
	
	if (position('?' in ds_tarja_magnetica_w) > 0) then
		qt_fim_trilha_w		:= position('?' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
	elsif (position(':' in ds_tarja_magnetica_w) > 0) then
		qt_fim_trilha_w		:= position(':' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
	elsif (position('/' in ds_tarja_magnetica_w) > 0) then
		qt_fim_trilha_w		:= position('/' in ds_tarja_magnetica_w);
	end if;
	
	nm_beneficiario_p	:= pls_somente_letra_espaco(upper(substr(ds_tarja_magnetica_w,2,qt_fim_trilha_w-2)));
	
	if (position(';' in ds_tarja_magnetica_w) > 0) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,position(';' in ds_tarja_magnetica_w),length(ds_tarja_magnetica_w));
	elsif (position(lower(ie_caracter_w) in ds_tarja_magnetica_w) > 0) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,position(lower(ie_caracter_w) in ds_tarja_magnetica_w),length(ds_tarja_magnetica_w));
	elsif (position(upper(ie_caracter_w) in ds_tarja_magnetica_w) > 0) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,position(upper(ie_caracter_w) in ds_tarja_magnetica_w),length(ds_tarja_magnetica_w));
	elsif (position('%' in ds_tarja_magnetica_w) > 0) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,position('%' in ds_tarja_magnetica_w),length(ds_tarja_magnetica_w));
	end if;
	
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,';','');
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w, lower(ie_caracter_w),'');
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w, upper(ie_caracter_w),'');
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,'%','');
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,'','');
	
	if (position('?' in ds_tarja_magnetica_w) > 0) then
		qt_fim_trilha_w		:= position('?' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
	elsif (position(':' in ds_tarja_magnetica_w) > 0) then
		qt_fim_trilha_w		:= position(':' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
	end if;
	
	qt_caracteres_carteira_w	:= position('=' in ds_tarja_magnetica_w) - 1;
	
	if (qt_caracteres_carteira_w = 16) then
		ds_tarja_magnetica_w	:= '0' || ds_tarja_magnetica_w;
	elsif (qt_caracteres_carteira_w = 15) then
		ds_tarja_magnetica_w	:= '00' || ds_tarja_magnetica_w;
	end if;
	
	qt_caracteres_carteira_w	:= length(ds_tarja_magnetica_w);
	
	if (qt_caracteres_carteira_w = 39) then
		cd_usuario_plano_p	:= substr(ds_tarja_magnetica_w,1,17);
		nr_via_p		:= substr(ds_tarja_magnetica_w,19,2);
		cd_operadora_p		:= substr(ds_tarja_magnetica_w,2,3);
	else
		cd_usuario_plano_p	:= substr(ds_tarja_magnetica_w,1,17);
		nr_via_p		:= substr(ds_tarja_magnetica_w,19,2);
		dt_validade_p		:= substr(ds_tarja_magnetica_w,23,2) || '/' || substr(ds_tarja_magnetica_w,21,2);
		cd_operadora_p		:= substr(ds_tarja_magnetica_w,2,3);
		dt_validade_format_p	:= to_date('01/' || substr(ds_tarja_magnetica_w,23,2) || '/20' || substr(ds_tarja_magnetica_w,21,2), 'dd/mm/yyyy');
		cd_produto_w		:= substr(ds_tarja_magnetica_w,30,3);
		ie_abrangencia_w	:= substr(ds_tarja_magnetica_w,33,1);
		ie_tipo_contratacao_w	:= substr(ds_tarja_magnetica_w,34,1);
	end if;

	ie_tipo_contratacao_p	:= obter_tipo_contratacao(ie_tipo_contratacao_w);
	ds_abrangencia_p	:= obter_abrangencia('DS',ie_abrangencia_w);
	ie_abrangencia_p	:= obter_abrangencia('AB',ie_abrangencia_w);
	ie_abrangencia_ww	:= obter_abrangencia('AP',ie_abrangencia_w);
	
	begin
	select	max(nr_sequencia),
		nm_fantasia
	into STRICT	nr_seq_produto_p,
		nm_produto_p
	from	pls_plano
	where	cd_tarja_magnetica 		= cd_produto_w
	and	coalesce(ie_tipo_operacao, 'T') 	= 'T'
	and	cd_estabelecimento		= cd_estabelecimento_p
	and	((ie_tipo_contratacao = ie_tipo_contratacao_p) or (coalesce(ie_tipo_contratacao_p::text, '') = ''))
	and	((ie_abrangencia = ie_abrangencia_ww) or (coalesce(ie_abrangencia_ww::text, '') = ''))
	group by
		nm_fantasia;
	exception
	when others then
		nm_produto_p	:= '';
	end;
	
	if (nm_beneficiario_p ='' or coalesce(nm_beneficiario_p::text, '') = '') then
		begin
		select	substr(tws_get_name_person(b.cd_pessoa_fisica, b.cd_estabelecimento),1,100)
		into STRICT	nm_beneficiario_p
		from	pls_segurado_carteira	a,
			pls_segurado		b
		where	a.nr_seq_segurado	= b.nr_sequencia
		and	a.cd_usuario_plano	= cd_usuario_plano_p;
		exception
		when others then
			nm_beneficiario_p	:= '';
		end;
	end if;
	
	select	count(1)
	into STRICT	qt_existe_base_w
	from	pls_segurado_carteira
	where	cd_usuario_plano	= cd_usuario_plano_p;
	
	/* Verificar a carteira do beneficiario de intercambio */

	if (qt_existe_base_w = 0) then
		select	count(*)
		into STRICT	qt_existe_base_w
		from	pls_segurado_carteira a,
			pls_segurado b
		where	a.nr_seq_segurado	= b.nr_sequencia
		and	a.nr_cartao_intercambio	= cd_usuario_plano_p;
		
		if (qt_existe_base_w = 0) then
			select	count(*)
			into STRICT	qt_existe_base_w
			from	pls_segurado_cart_ant
			where	cd_usuario_ant = cd_usuario_plano_p;
		end if;
	end if;
	
	if (ie_restringe_estab_w = 'S') and (qt_existe_base_w	> 0) then
		select	count(*)
		into STRICT	qt_existente_w
		from	pls_segurado_carteira
		where	cd_usuario_plano	= cd_usuario_plano_p
		and	cd_estabelecimento	= cd_estabelecimento_p;
		
		/* Verificar a carteira do beneficiario de intercambio */

		if (qt_existente_w = 0) then
			select	count(*)
			into STRICT	qt_existente_w
			from	pls_segurado_carteira a,
				pls_segurado b
			where	a.nr_seq_segurado	= b.nr_sequencia
			and	a.nr_cartao_intercambio	= cd_usuario_plano_p
			and	a.cd_estabelecimento	= cd_estabelecimento_p;
		end if;
		
		if (qt_existente_w = 0) then
			nm_beneficiario_p	:= '';
			ds_tarja_magnetica_w	:= '';
			nr_via_p		:= '0';
			dt_validade_p		:= '';
			cd_produto_w		:= '';
			nm_produto_p		:= '';
			dt_validade_format_p	:= '';
		end if;
	end if;
	ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,qt_fim_trilha_w+2,length(ds_tarja_magnetica_w));	
	
	if (qt_caracteres_carteira_w > 40) then
		begin
			dt_nascimento_p	:= to_date(substr(somente_numero(ds_tarja_magnetica_w),19,8),'ddmmyyyy');
		exception
		when others then
			dt_nascimento_p	:= null;
		end;
	end if;
	
	if (cd_produto_w IS NOT NULL AND cd_produto_w::text <> '') then
		cd_plano_tarja_mag_p	:= cd_produto_w;
	end if;
--Plano de saude Ases
elsif (cd_cgc_outorgante_w = '03638220000133') or (cd_base_cgc_w = '29251097') or (cd_base_cgc_w = '30412068') or (cd_base_cgc_w = '39695945') or (cd_base_cgc_w = '03638220') or (cd_base_cgc_w = '04219353') or (cd_base_cgc_w = '07078989') or (cd_base_cgc_w = '02349596') or (cd_base_cgc_w ='05308034') then

	ds_tarja_magnetica_w	:= ds_tarja_magnetica_p;
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,chr(13),'');
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,chr(10),'');
	
	if (position('?' in ds_tarja_magnetica_w) > 0) then
		qt_fim_trilha_w		:= position('?' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
	elsif (position(':' in ds_tarja_magnetica_w) > 0) then
		qt_fim_trilha_w		:= position(':' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
	elsif (position('/' in ds_tarja_magnetica_w) > 0) then
		qt_fim_trilha_w		:= position('/' in ds_tarja_magnetica_w);
	end if;

	nm_beneficiario_p	:= pls_somente_letra_espaco(upper(substr(ds_tarja_magnetica_w,2,qt_fim_trilha_w-2)));
	
	if (position(';' in ds_tarja_magnetica_w) > 0) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,position(';' in ds_tarja_magnetica_w),length(ds_tarja_magnetica_w));
	elsif (position(lower(ie_caracter_w) in ds_tarja_magnetica_w) > 0) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,position(lower(ie_caracter_w) in ds_tarja_magnetica_w),length(ds_tarja_magnetica_w));
	elsif (position(upper(ie_caracter_w) in ds_tarja_magnetica_w) > 0) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,position(upper(ie_caracter_w) in ds_tarja_magnetica_w),length(ds_tarja_magnetica_w));
	elsif (position('%' in ds_tarja_magnetica_w) > 0) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,position('%' in ds_tarja_magnetica_w),length(ds_tarja_magnetica_w));
	end if;
	
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,';','');
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w, lower(ie_caracter_w),'');
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w, upper(ie_caracter_w),'');
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,'%','');
	ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,'','');
	
	qt_caracteres_carteira_w	:= position('=' in ds_tarja_magnetica_w) - 1;
	nr_pos_final_tarja1_w		:= qt_caracteres_carteira_w;
	
	ds_data_w	:=	substr(ds_tarja_magnetica_w,qt_caracteres_carteira_w+2,6);
	
	if (qt_caracteres_carteira_w = 16) then
		ds_tarja_magnetica_w	:= '0' || ds_tarja_magnetica_w;
	elsif (qt_caracteres_carteira_w = 15) then
		ds_tarja_magnetica_w	:= '00' || ds_tarja_magnetica_w;
	end if;

	if (position('?' in ds_tarja_magnetica_w) > 0) then
		qt_fim_trilha_w		:= position('?' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
	elsif (position(':' in ds_tarja_magnetica_w) > 0) then
		qt_fim_trilha_w		:= position(':' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
	end if;
	qt_caracteres_carteira_w	:= length(ds_tarja_magnetica_w);
	
	if (qt_caracteres_carteira_w = 39) then
		null;
	else	
		cd_usuario_plano_p		:= substr(ds_tarja_magnetica_w,1,nr_pos_final_tarja1_w);
		nr_via_p			:= substr(ds_tarja_magnetica_w,14,2);
		cd_operadora_p			:= substr(ds_tarja_magnetica_w,1,3);
		dt_validade_p			:= substr(ds_data_w,5,2) || '/' || substr(ds_data_w,3,2);
		dt_validade_format_p		:= to_date('01/' || substr(ds_data_w,5,2) || '/20' || substr(ds_data_w,3,2), 'dd/mm/yyyy');
		cd_produto_w			:= substr(ds_tarja_magnetica_w,24,3);
		ie_abrangencia_w		:= substr(ds_tarja_magnetica_w,27,1);
		ie_tipo_contratacao_w		:= substr(ds_tarja_magnetica_w,28,1);
	end if;
	
	ie_tipo_contratacao_p	:= obter_tipo_contratacao(ie_tipo_contratacao_w);
	ds_abrangencia_p	:= obter_abrangencia('DS',ie_abrangencia_w);
	ie_abrangencia_p	:= obter_abrangencia('AB',ie_abrangencia_w);
	ie_abrangencia_ww	:= obter_abrangencia('AP',ie_abrangencia_w);
	
	begin
	select	max(nr_sequencia),
		nm_fantasia
	into STRICT	nr_seq_produto_p,
		nm_produto_p
	from	pls_plano
	where	cd_tarja_magnetica = cd_produto_w
	and	coalesce(ie_tipo_operacao, 'T') = 'T'
	and	cd_estabelecimento = cd_estabelecimento_p
	and	((ie_tipo_contratacao = ie_tipo_contratacao_p) or (coalesce(ie_tipo_contratacao_p::text, '') = ''))
	and	((ie_abrangencia = ie_abrangencia_ww) or (coalesce(ie_abrangencia_ww::text, '') = ''))
	group by
		nm_fantasia;
	exception
	when others then
		nm_produto_p	:= '';
	end;
	
	if (nm_beneficiario_p = '' or coalesce(nm_beneficiario_p::text, '') = '') then
		begin
		select	substr(tws_get_name_person(b.cd_pessoa_fisica, b.cd_estabelecimento),1,100)
		into STRICT	nm_beneficiario_p
		from	pls_segurado_carteira	a,
			pls_segurado		b
		where	a.nr_seq_segurado	= b.nr_sequencia
		and	a.cd_usuario_plano	= cd_usuario_plano_p;
		exception
		when others then
			nm_beneficiario_p	:= '';
		end;
	end if;
	
	select	count(1)
	into STRICT	qt_existe_base_w
	from	pls_segurado_carteira
	where	cd_usuario_plano	= cd_usuario_plano_p;
	
	/* Verificar a carteira do beneficiario de intercambio */

	if (qt_existe_base_w = 0) then
		select	count(*)
		into STRICT	qt_existe_base_w
		from	pls_segurado_carteira a,
				pls_segurado b
		where	a.nr_seq_segurado		= b.nr_sequencia
		and		a.nr_cartao_intercambio	= cd_usuario_plano_p;
		
		if (qt_existe_base_w = 0) then
			select	count(*)
			into STRICT	qt_existe_base_w
			from	pls_segurado_cart_ant
			where	cd_usuario_ant = cd_usuario_plano_p;
		end if;
	end if;
	
	if (ie_restringe_estab_w = 'S') and (qt_existe_base_w	> 0) then
		select	count(*)
		into STRICT	qt_existente_w
		from	pls_segurado_carteira
		where	cd_usuario_plano	= cd_usuario_plano_p
		and		cd_estabelecimento	= cd_estabelecimento_p;
		
		/* Verificar a carteira do beneficiario de intercambio */

		if (qt_existente_w = 0) then
			select	count(*)
			into STRICT	qt_existente_w
			from	pls_segurado_carteira a,
					pls_segurado b
			where	a.nr_seq_segurado		= b.nr_sequencia
			and		a.nr_cartao_intercambio	= cd_usuario_plano_p
			and		a.cd_estabelecimento	= cd_estabelecimento_p;
		end if;
		
		if (qt_existente_w = 0) then
			nm_beneficiario_p		:= '';
			ds_tarja_magnetica_w	:= '';
			nr_via_p				:= '0';
			dt_validade_p			:= '';
			cd_produto_w			:= '';
			nm_produto_p			:= '';
			dt_validade_format_p	:= '';
		end if;
	end if;
	ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,qt_fim_trilha_w+2,length(ds_tarja_magnetica_w));	
	
	if (qt_caracteres_carteira_w > 40) then
		begin
			dt_nascimento_p	:= to_date(substr(somente_numero(ds_tarja_magnetica_w),19,8),'ddmmyyyy');
		exception
		when others then
			dt_nascimento_p	:= null;
		end;
	end if;
	
	if (cd_produto_w IS NOT NULL AND cd_produto_w::text <> '') then
		cd_plano_tarja_mag_p	:= cd_produto_w;
	end if;
else
	ds_tarja_magnetica_w    	:=    	ds_tarja_magnetica_p;
	ds_tarja_magnetica_w  		:=    	replace(ds_tarja_magnetica_w,'(','%');
	ds_tarja_magnetica_w    	:=    	replace(ds_tarja_magnetica_w,')',' ');
	ds_tarja_magnetica_w    	:=    	replace(ds_tarja_magnetica_w,'[',':');
	ds_tarja_magnetica_w  		:=  	replace(ds_tarja_magnetica_w,']',':');
	ds_primeiro_caractere_w   	:=  	substr(ds_tarja_magnetica_p,1,1);
	ds_primeiro_caractere_w   	:=     	replace(ds_primeiro_caractere_w,'(','%');
	qt_caracteres_total_w	:= 	length(ds_tarja_magnetica_w);
	
	if	(ds_primeiro_caractere_w = '%' AND qt_caracteres_total_w = 38) or
		(ds_primeiro_caractere_w = '%' AND qt_caracteres_total_w = 26) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,2,37);
	elsif (ds_primeiro_caractere_w = '%') and (qt_caracteres_total_w = 27) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,2,25);
	elsif	(ds_primeiro_caractere_w = '%' AND qt_caracteres_total_w = 28) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,3,25);
	/*Quando houver 40 caractres  da verso nova com o codigo cooperativista*/

	elsif	(ds_primeiro_caractere_w = '%' AND qt_caracteres_total_w = 40) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,3,37);
	/*Quando houver 39 caractres  da verso antiga sem o codigo cooperativista*/

	elsif	(ds_primeiro_caractere_w = '%' AND qt_caracteres_total_w = 39) then
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,2,37);
	end if;
	
	qt_caracteres_total_w	:= length(ds_tarja_magnetica_w);
	
	/*Leitura do carto quando houver 1 trilha e soh informacao do cartao*/

	if (qt_caracteres_total_w = 25) then
		ds_tarja_magnetica_w	:= lpad(substr(ds_tarja_magnetica_w,2,25),25,'0');
		cd_usuario_plano_p	:= lpad(substr(ds_tarja_magnetica_w,1,17),17,'0');
		nr_via_p		:= substr(ds_tarja_magnetica_w,19,2);
		dt_validade_p		:= substr(ds_tarja_magnetica_w,22,2) || '/' || substr(ds_tarja_magnetica_w,24,2);
		dt_validade_format_p	:= to_date('01/' || substr(ds_tarja_magnetica_w,22,2) || '/20' || substr(ds_tarja_magnetica_w,24,2), 'dd/mm/yyyy');
		cd_operadora_p		:= substr(ds_tarja_magnetica_w,2,3);
		
		begin
		select	substr(tws_get_name_person(b.cd_pessoa_fisica, b.cd_estabelecimento),1,100)
		into STRICT	nm_beneficiario_p
		from	pls_segurado_carteira	a,
			pls_segurado		b
		where	a.nr_seq_segurado	= b.nr_sequencia
		and	a.cd_usuario_plano	= cd_usuario_plano_p;
		exception
		when others then
			nm_beneficiario_p	:= '';
		end;
		
		select	count(*)
		into STRICT	qt_existe_base_w
		from	pls_segurado_carteira
		where	cd_usuario_plano	= cd_usuario_plano_p;
		
		/* Verificar a carteira do beneficiario de intercambio */

		if (qt_existe_base_w = 0) then
			select	count(*)
			into STRICT	qt_existe_base_w
			from	pls_segurado_carteira a,
				pls_segurado b
			where	a.nr_seq_segurado	= b.nr_sequencia
			and	a.nr_cartao_intercambio	= cd_usuario_plano_p;
			
			if (qt_existe_base_w = 0) then
				select	count(*)
				into STRICT	qt_existe_base_w
				from	pls_segurado_cart_ant
				where	cd_usuario_ant = cd_usuario_plano_p;
			end if;
		end if;
		
		if (ie_restringe_estab_w = 'S') and (qt_existe_base_w > 0) then
			select	count(*)
			into STRICT	qt_existente_w
			from	pls_segurado_carteira
			where	cd_usuario_plano	= cd_usuario_plano_p
			and	cd_estabelecimento	= cd_estabelecimento_p;
			
			/* Verificar a carteira do beneficiario de intercambio */

			if (qt_existente_w = 0) then
				select	count(*)
				into STRICT	qt_existente_w
				from	pls_segurado_carteira a,
					pls_segurado b
				where	a.nr_seq_segurado	= b.nr_sequencia
				and	a.nr_cartao_intercambio	= cd_usuario_plano_p
				and	a.cd_estabelecimento	= cd_estabelecimento_p;
			end if;
			
			if (qt_existente_w = 0) then
				nm_beneficiario_p	:= '';
				ds_tarja_magnetica_w	:= '';
				nr_via_p		:= '0';
				dt_validade_p		:= '';
				cd_produto_w		:= '';
				nm_produto_p		:= '';
				dt_validade_format_p	:= '';
				ie_abrangencia_w	:= '';
				ie_tipo_contratacao_w	:= '';
			end if;
		end if;
	/*Leitura do carto quando houver 1 trilha e com todas as informacoes da 2 trilha do cartao*/

	elsif (qt_caracteres_total_w = 37) then
		
		/* Se veio pelo leitor novo, tem que substituir tambem o ponto e virgula */

		if (substr(ds_tarja_magnetica_w,1,1) = '%') then
			ds_tarja_magnetica_w		:= substr(ds_tarja_magnetica_w,2,37);
		end if;
		
		qt_caracteres_carteira_w	:= position('=' in ds_tarja_magnetica_w) - 1;
		
		if (qt_caracteres_carteira_w = 16) then
			ds_tarja_magnetica_w      := lpad(ds_tarja_magnetica_w,37,'0');
		end if;
		
		qt_caracteres_carteira_w	:= position('=' in ds_tarja_magnetica_w) - 1;
		if (qt_caracteres_carteira_w = 17) then
			cd_usuario_plano_p	:= lpad(substr(ds_tarja_magnetica_w,1,17),17,'0');
			nr_via_p		:= substr(ds_tarja_magnetica_w,19,2);
			dt_validade_p		:= substr(ds_tarja_magnetica_w,23,2) || '/' || substr(ds_tarja_magnetica_w,21,2);
			cd_operadora_p		:= substr(ds_tarja_magnetica_w,2,3);
			begin
			dt_validade_format_p	:= to_date('01/' || substr(ds_tarja_magnetica_w,23,2) || '/20' || substr(ds_tarja_magnetica_w,21,2), 'dd/mm/yyyy');
			exception
				when others then
				dt_validade_format_p	:= null;
			end;
			
			cd_produto_w		:= substr(ds_tarja_magnetica_w,30,3);
			ie_abrangencia_w	:= substr(ds_tarja_magnetica_w,33,1);
			ie_tipo_contratacao_w	:= substr(ds_tarja_magnetica_w,34,1);
			
			begin
			select	substr(tws_get_name_person(b.cd_pessoa_fisica, b.cd_estabelecimento),1,100)
			into STRICT	nm_beneficiario_p
			from	pls_segurado_carteira	a,
				pls_segurado		b
			where	a.nr_seq_segurado	= b.nr_sequencia
			and	a.cd_usuario_plano	= cd_usuario_plano_p;
			exception
			when others then
				nm_beneficiario_p	:= '';
			end;
			
			ie_tipo_contratacao_p	:= obter_tipo_contratacao(ie_tipo_contratacao_w);
			ds_abrangencia_p	:= obter_abrangencia('DS',ie_abrangencia_w);
			ie_abrangencia_p	:= obter_abrangencia('AB',ie_abrangencia_w);
			ie_abrangencia_ww	:= obter_abrangencia('AP',ie_abrangencia_w);
			
			begin
			select	max(nr_sequencia),
				nm_fantasia
			into STRICT	nr_seq_produto_p,
				nm_produto_p
			from	pls_plano
			where	cd_tarja_magnetica 		= cd_produto_w
			and	coalesce(ie_tipo_operacao, 'T') 	= 'T'
			and	cd_estabelecimento		= cd_estabelecimento_p
			and	((ie_tipo_contratacao = ie_tipo_contratacao_p) or (coalesce(ie_tipo_contratacao_p::text, '') = ''))
			and	((ie_abrangencia = ie_abrangencia_ww) or (coalesce(ie_abrangencia_ww::text, '') = ''))
			group by
				nm_fantasia;
			exception
			when others then
				nm_produto_p	:= '';
			end;
		elsif (qt_caracteres_carteira_w = 16) then
			cd_usuario_plano_p	:= lpad(substr(ds_tarja_magnetica_w,1,16),17,'0');
			nr_via_p		:= substr(ds_tarja_magnetica_w,18,2);
			cd_operadora_p		:= substr(ds_tarja_magnetica_w,1,3);
			
			begin
			select	substr(tws_get_name_person(b.cd_pessoa_fisica, b.cd_estabelecimento),1,100)
			into STRICT	nm_beneficiario_p
			from	pls_segurado_carteira	a,
				pls_segurado		b
			where	a.nr_seq_segurado	= b.nr_sequencia
			and	a.cd_usuario_plano	= cd_usuario_plano_p;
			exception
			when others then
				nm_beneficiario_p	:= '';
			end;
		end if;
		
		select	count(*)
		into STRICT	qt_existe_base_w
		from	pls_segurado_carteira
		where	cd_usuario_plano	= cd_usuario_plano_p;
		
		/* Verificar a carteira do beneficiario de intercambio */

		if (qt_existe_base_w = 0) then
			select	count(*)
			into STRICT	qt_existe_base_w
			from	pls_segurado_carteira a,
				pls_segurado b
			where	a.nr_seq_segurado	= b.nr_sequencia
			and	a.nr_cartao_intercambio	= cd_usuario_plano_p;
			
			if (qt_existe_base_w = 0) then
				select	count(*)
				into STRICT	qt_existe_base_w
				from	pls_segurado_cart_ant
				where	cd_usuario_ant = cd_usuario_plano_p;
			end if;
		end if;
		
		if (ie_restringe_estab_w = 'S') and (qt_existe_base_w > 0) then
			
			select	count(*)
			into STRICT	qt_existente_w
			from	pls_segurado_carteira
			where	cd_usuario_plano	= cd_usuario_plano_p
			and	cd_estabelecimento	= cd_estabelecimento_p;
			
			/* Verificar a carteira do beneficiario de intercambio */

			if (qt_existente_w = 0) then
				select	count(*)
				into STRICT	qt_existente_w
				from	pls_segurado_carteira a,
					pls_segurado b
				where	a.nr_seq_segurado	= b.nr_sequencia
				and	a.nr_cartao_intercambio	= cd_usuario_plano_p
				and	a.cd_estabelecimento	= cd_estabelecimento_p;
			end if;
			
			if (qt_existente_w = 0) then
				nm_beneficiario_p	:= '';
				ds_tarja_magnetica_w	:= '';
				nr_via_p		:= '0';
				dt_validade_p		:= '';
				cd_produto_w		:= '';
				ie_abrangencia_w	:= '';
				ie_tipo_contratacao_w	:= '';
				nm_produto_p		:= '';
				dt_validade_format_p	:= '';
			end if;
		end if;
	elsif (qt_caracteres_total_w = 64) then
		ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,chr(10),'');
		ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,chr(13),'');
		
		if (position('?' in ds_tarja_magnetica_w) > 0) then
			qt_fim_trilha_w		:= position('?' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
		elsif (position(':' in ds_tarja_magnetica_w) > 0) then
			qt_fim_trilha_w		:= position(':' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
		elsif (position('/' in ds_tarja_magnetica_w) > 0) then
			qt_fim_trilha_w		:= position('/' in ds_tarja_magnetica_w);
		end if;
		
		nm_beneficiario_p	:= pls_somente_letra_espaco(upper(substr(ds_tarja_magnetica_w,2,qt_fim_trilha_w-2)));
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,qt_fim_trilha_w+1,length(ds_tarja_magnetica_w));
		if (position('?' in ds_tarja_magnetica_w) > 0) then
			qt_fim_trilha_w		:= position('?' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
		elsif (position(':' in ds_tarja_magnetica_w) > 0) then
			qt_fim_trilha_w		:= position(':' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
		elsif (position('/' in ds_tarja_magnetica_w) > 0) then
			qt_fim_trilha_w		:= position('/' in ds_tarja_magnetica_w);
		end if;
		
		/*Limpar enter, tab e ponto e virgula*/

		ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,';','');
		ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w, lower(ie_caracter_w),'');
		ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w, upper(ie_caracter_w),'');
		qt_caracteres_carteira_w	:= position('=' in ds_tarja_magnetica_w) - 1;
		
		if (qt_caracteres_carteira_w = 16) then
			ds_tarja_magnetica_w	:= '0' || ds_tarja_magnetica_w;
			cd_usuario_plano_p	:= substr(ds_tarja_magnetica_w,1,17);
			nr_via_p		:= substr(ds_tarja_magnetica_w,19,2);
			cd_operadora_p		:= substr(ds_tarja_magnetica_w,2,3);
		elsif (qt_caracteres_carteira_w = 17) then
			cd_usuario_plano_p	:= substr(ds_tarja_magnetica_w,1,17);
			nr_via_p		:= substr(ds_tarja_magnetica_w,19,2);
			dt_validade_p		:= substr(ds_tarja_magnetica_w,23,2) || '/' || substr(ds_tarja_magnetica_w,21,2);
			cd_operadora_p		:= substr(ds_tarja_magnetica_w,2,3);
			dt_validade_format_p	:= to_date('01/' || substr(ds_tarja_magnetica_w,23,2) || '/20' || substr(ds_tarja_magnetica_w,21,2), 'dd/mm/yyyy');
			cd_produto_w		:= substr(ds_tarja_magnetica_w,30,3);
			ie_abrangencia_w	:= substr(ds_tarja_magnetica_w,33,1);
			ie_tipo_contratacao_w	:= substr(ds_tarja_magnetica_w,34,1);
			
			ie_tipo_contratacao_p	:= obter_tipo_contratacao(ie_tipo_contratacao_w);
			ds_abrangencia_p	:= obter_abrangencia('DS',ie_abrangencia_w);
			ie_abrangencia_p	:= obter_abrangencia('AB',ie_abrangencia_w);
			ie_abrangencia_ww	:= obter_abrangencia('AP',ie_abrangencia_w);
			
			begin
			select	max(nr_sequencia),
				nm_fantasia
			into STRICT	nr_seq_produto_p,
				nm_produto_p
			from	pls_plano
			where	cd_tarja_magnetica 		= cd_produto_w
			and	coalesce(ie_tipo_operacao, 'T') 	= 'T'
			and	cd_estabelecimento		= cd_estabelecimento_p
			and	((ie_tipo_contratacao = ie_tipo_contratacao_p) or (coalesce(ie_tipo_contratacao_p::text, '') = ''))
			and	((ie_abrangencia = ie_abrangencia_ww) or (coalesce(ie_abrangencia_ww::text, '') = ''))
			group by
				nm_fantasia;
			exception
			when others then
				nm_produto_p	:= '';
			end;
		end if;
		
		select	count(*)
		into STRICT	qt_existe_base_w
		from	pls_segurado_carteira
		where	cd_usuario_plano	= cd_usuario_plano_p;
		
		/* Verificar a carteira do beneficiario de intercambio */

		if (qt_existe_base_w = 0) then
			select	count(*)
			into STRICT	qt_existe_base_w
			from	pls_segurado_carteira a,
				pls_segurado b
			where	a.nr_seq_segurado	= b.nr_sequencia
			and	a.nr_cartao_intercambio	= cd_usuario_plano_p;
			
			if (qt_existe_base_w = 0) then
				select	count(*)
				into STRICT	qt_existe_base_w
				from	pls_segurado_cart_ant
				where	cd_usuario_ant = cd_usuario_plano_p;
			end if;
		end if;
		
		if (ie_restringe_estab_w = 'S') and (qt_existe_base_w	> 0)then
			select	count(*)
			into STRICT	qt_existente_w
			from	pls_segurado_carteira
			where	cd_usuario_plano	= cd_usuario_plano_p
			and	cd_estabelecimento	= cd_estabelecimento_p;
			
			/* Verificar a carteira do beneficiario de intercambio */

			if (qt_existente_w = 0) then
				select	count(*)
				into STRICT	qt_existente_w
				from	pls_segurado_carteira a,
					pls_segurado b
				where	a.nr_seq_segurado	= b.nr_sequencia
				and	a.nr_cartao_intercambio	= cd_usuario_plano_p
				and	a.cd_estabelecimento	= cd_estabelecimento_p;
			end if;
			
			if (qt_existente_w = 0) then
				cd_usuario_plano_p	:= '';
				nm_beneficiario_p	:= '';
				ds_tarja_magnetica_w	:= '';
				nr_via_p		:= '0';
				cd_operadora_p		:= '';
				dt_validade_p		:= '';
				cd_produto_w		:= '';
				ie_abrangencia_w	:= '';
				ie_tipo_contratacao_w	:= '';
				nm_produto_p		:= '';
				dt_validade_format_p	:= '';
			end if;
		end if;
	/*Leitura do carto quando houver 3 trilha e com todas as informacoes da 2 trilha do cartao*/

	elsif (qt_caracteres_total_w = 66) or (qt_caracteres_total_w = 71) or (qt_caracteres_total_w > 50) then
		
		ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,chr(13),'');
		ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,chr(10),'');
		
		if (position('?' in ds_tarja_magnetica_w) > 0) then
			qt_fim_trilha_w		:= position('?' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
		elsif (position(':' in ds_tarja_magnetica_w) > 0) then
			qt_fim_trilha_w		:= position(':' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
		elsif (position('/' in ds_tarja_magnetica_w) > 0) then
			qt_fim_trilha_w		:= position('/' in ds_tarja_magnetica_w);
		end if;
		
		ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,';','');
		ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w, lower(ie_caracter_w),'');
		ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w, upper(ie_caracter_w),'');
		ds_tarja_magnetica_w	:= replace(ds_tarja_magnetica_w,'','');
		
		nm_beneficiario_p	:= pls_somente_letra_espaco(upper(substr(ds_tarja_magnetica_w,2,qt_fim_trilha_w-2)));
		
		ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,qt_fim_trilha_w + 1,length(ds_tarja_magnetica_w));
		
		if (position('?' in ds_tarja_magnetica_w) > 0) then
			qt_fim_trilha_w		:= position('?' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
		elsif (position(':' in ds_tarja_magnetica_w) > 0) then
			qt_fim_trilha_w		:= position(':' in ds_tarja_magnetica_w)+position('/' in ds_tarja_magnetica_w);
		end if;
		--ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,1,qt_fim_trilha_w-2);
		
		qt_caracteres_carteira_w	:= position('=' in ds_tarja_magnetica_w) - 1;
		
		if (qt_caracteres_carteira_w = 16) then
			ds_tarja_magnetica_w	:= '0' || ds_tarja_magnetica_w;
		elsif (qt_caracteres_carteira_w = 15) then
			ds_tarja_magnetica_w	:= '00' || ds_tarja_magnetica_w;
		end if;
		
		qt_caracteres_carteira_w	:= length(ds_tarja_magnetica_w);
		
		if (qt_caracteres_carteira_w = 39) then
			cd_usuario_plano_p	:= substr(ds_tarja_magnetica_w,1,17);
			nr_via_p		:= substr(ds_tarja_magnetica_w,19,2);
			cd_operadora_p		:= substr(ds_tarja_magnetica_w,2,3);
		else
			cd_usuario_plano_p	:= substr(ds_tarja_magnetica_w,1,17);
			nr_via_p		:= substr(ds_tarja_magnetica_w,19,2);
			dt_validade_p		:= substr(ds_tarja_magnetica_w,23,2) || '/' || substr(ds_tarja_magnetica_w,21,2);
			cd_operadora_p		:= substr(ds_tarja_magnetica_w,2,3);
			dt_validade_format_p	:= to_date('01/' || substr(ds_tarja_magnetica_w,23,2) || '/20' || substr(ds_tarja_magnetica_w,21,2), 'dd/mm/yyyy');
			cd_produto_w		:= substr(ds_tarja_magnetica_w,30,3);
			ie_abrangencia_w	:= substr(ds_tarja_magnetica_w,33,1);
			ie_tipo_contratacao_w	:= substr(ds_tarja_magnetica_w,34,1);
		end if;
		
		ie_tipo_contratacao_p	:= obter_tipo_contratacao(ie_tipo_contratacao_w);
		ds_abrangencia_p	:= obter_abrangencia('DS',ie_abrangencia_w);
		ie_abrangencia_p	:= obter_abrangencia('AB',ie_abrangencia_w);
		ie_abrangencia_ww	:= obter_abrangencia('AP',ie_abrangencia_w);
		
		begin
		select	max(nr_sequencia),
			nm_fantasia
		into STRICT	nr_seq_produto_p,
			nm_produto_p
		from	pls_plano
		where	cd_tarja_magnetica 		= cd_produto_w
		and	coalesce(ie_tipo_operacao, 'T') 	= 'T'
		and	cd_estabelecimento		= cd_estabelecimento_p
		and	((ie_tipo_contratacao = ie_tipo_contratacao_p) or (coalesce(ie_tipo_contratacao_p::text, '') = ''))
		and	((ie_abrangencia = ie_abrangencia_ww) or (coalesce(ie_abrangencia_ww::text, '') = ''))
		group by
			nm_fantasia;
		exception
		when others then
			nm_produto_p	:= '';
		end;
		
		select	count(*)
		into STRICT	qt_existe_base_w
		from	pls_segurado_carteira
		where	cd_usuario_plano	= cd_usuario_plano_p;
		
		/* Verificar a carteira do beneficiario de intercambio */

		if (qt_existe_base_w = 0) then
			select	count(*)
			into STRICT	qt_existe_base_w
			from	pls_segurado_carteira a,
				pls_segurado b
			where	a.nr_seq_segurado	= b.nr_sequencia
			and	a.nr_cartao_intercambio	= cd_usuario_plano_p;
			
			if (qt_existe_base_w = 0) then
				select	count(*)
				into STRICT	qt_existe_base_w
				from	pls_segurado_cart_ant
				where	cd_usuario_ant = cd_usuario_plano_p;
			end if;
		end if;
		
		if (ie_restringe_estab_w = 'S') and (qt_existe_base_w	> 0) then
			select	count(*)
			into STRICT	qt_existente_w
			from	pls_segurado_carteira
			where	cd_usuario_plano	= cd_usuario_plano_p
			and	cd_estabelecimento	= cd_estabelecimento_p;
			
			/* Verificar a carteira do beneficiario de intercambio */

			if (qt_existente_w = 0) then
				select	count(*)
				into STRICT	qt_existente_w
				from	pls_segurado_carteira a,
					pls_segurado b
				where	a.nr_seq_segurado	= b.nr_sequencia
				and	a.nr_cartao_intercambio	= cd_usuario_plano_p
				and	a.cd_estabelecimento	= cd_estabelecimento_p;
			end if;
			
			if (qt_existente_w = 0) then
				nm_beneficiario_p	:= '';
				ds_tarja_magnetica_w	:= '';
				nr_via_p		:= '0';
				dt_validade_p		:= '';
				cd_produto_w		:= '';
				nm_produto_p		:= '';
				dt_validade_format_p	:= '';
			end if;
		end if;
		
		-- Se o caractere depois do caractere indicador de fim de trilha ('?', '/' etc...) for numerico,
		-- pegar os caracteres a partir de qt_fim_trilha_w+1 senao, qt_fim_trilha_w+2
		if (pls_obter_se_somente_numero(substr(ds_tarja_magnetica_w, qt_fim_trilha_w+1, 1)) = 'S') then
			ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,qt_fim_trilha_w+1,length(ds_tarja_magnetica_w));
		else
			ds_tarja_magnetica_w	:= substr(ds_tarja_magnetica_w,qt_fim_trilha_w+2,length(ds_tarja_magnetica_w));
		end if;
		
		if (qt_caracteres_carteira_w > 40) then
			begin
				dt_nascimento_p	:= to_date(substr(somente_numero(ds_tarja_magnetica_w),19,8),'ddmmyyyy');
			exception
			when others then
				dt_nascimento_p	:= null;
			end;
		end if;
	end if;
	
	if (cd_produto_w IS NOT NULL AND cd_produto_w::text <> '') then
		cd_plano_tarja_mag_p	:= cd_produto_w;
	end if;	
end if;

--Se o beneficiario nao existir na base, verifica o parametro ie_produto_tarja para retornar o codigo do produto identificado na tarja
ie_produto_tarja_w	:= pls_verif_obtem_produto_tarja(cd_estabelecimento_p);

if (coalesce(ie_produto_tarja_w, 'S')	= 'N') then
	nr_seq_produto_p	:= null;
	nm_produto_p		:= null;
end if;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_valores_tarja_mag ( ds_tarja_magnetica_p text, nm_beneficiario_p out text, cd_usuario_plano_p out text, nr_via_p out text, dt_validade_p out text, cd_operadora_p out text, dt_validade_format_p out timestamp, dt_nascimento_p out timestamp, nm_produto_p out text, nr_seq_produto_p out bigint, ds_abrangencia_p out text, ie_abrangencia_p out text, ie_tipo_contratacao_p out text, cd_plano_tarja_mag_p out text, nm_usuario_p text, cd_estabelecimento_p bigint) is ds_tarja_magnetica_w varchar(255) FROM PUBLIC;

