-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_dose_peso_protocolo ( nm_usuario_p text, nr_prescricao_p bigint, qt_peso_p bigint) AS $body$
DECLARE

			 
qt_dose_peso_w		double precision;
nr_seq_prescricao_w	integer;
cd_material_w		integer;
cd_intervalo_w		varchar(7);
cd_unidade_medida_w	varchar(30);
qt_unitaria_w		double precision;
ie_via_aplicacao_w	varchar(5);
nr_ocorrencia_w		double precision;
qt_material_w		double precision;
qt_dispensar_w		double precision;	
ie_regra_disp_w		varchar(1);
ds_erro_w		varchar(2000);
nr_erro_w		integer;
qt_diluicao_w		bigint;
qt_dose_w		double precision;
ie_prescr_hor_sem_lib_w	varchar(1);
qt_conversao_dose_w	double precision;
ie_se_necessario_w	varchar(1);
ie_acm_w		varchar(1);

c01 CURSOR FOR 
SELECT 	b.qt_dose_peso, 
	a.nr_sequencia, 
	a.cd_material, 
	a.cd_unidade_medida_dose, 
	a.cd_intervalo, 
	a.ie_via_aplicacao, 
	a.nr_ocorrencia, 
	a.qt_material, 
	a.qt_conversao_dose, 
	coalesce(a.ie_se_necessario,'N'), 
	coalesce(a.ie_acm,'N') 
from	prescr_material a, 
	protocolo_medic_material b 
where	a.nr_prescricao = nr_prescricao_p 
and 	a.cd_protocolo = b.cd_protocolo 
and 	a.nr_seq_mat_protocolo = b.nr_seq_material 
and	a.nr_seq_protocolo = b.nr_sequencia 
and 	b.ie_agrupador = 1 
and	a.ie_agrupador = 1 
and	a.cd_material = b.cd_material 
and 	coalesce(a.nr_sequencia_diluicao::text, '') = '' 
and	coalesce(b.nr_seq_diluicao::text, '') = '' 
and 	coalesce(b.qt_dose_peso,0) > 0;


BEGIN 
if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (coalesce(qt_peso_p,0) > 0) and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then 
	 
	open C01;
	loop 
	fetch C01 into	 
		qt_dose_peso_w, 
		nr_seq_prescricao_w, 
		cd_material_w, 
		cd_unidade_medida_w, 
		cd_intervalo_w, 
		ie_via_aplicacao_w, 
		nr_ocorrencia_w, 
		qt_material_w, 
		qt_conversao_dose_w, 
		ie_se_necessario_w, 
		ie_acm_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		 
		qt_dose_w	:= qt_dose_peso_w * qt_peso_p;
		 
		qt_unitaria_w	:= dividir(trunc(dividir((qt_dose_w*1000),qt_conversao_dose_w)),1000);
 
		SELECT * FROM Obter_Quant_Dispensar(	wheb_usuario_pck.get_cd_estabelecimento, cd_material_w, nr_prescricao_p, nr_seq_prescricao_w, cd_intervalo_w, ie_via_aplicacao_w, qt_unitaria_w, 0, nr_ocorrencia_w, '', 'P', cd_unidade_medida_w, 1, qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w, ie_se_necessario_w, ie_acm_w) INTO STRICT qt_material_w, qt_dispensar_w, ie_regra_disp_w, ds_erro_w;
					 
		update	prescr_material 
		set	qt_dose		= qt_dose_w, 
			nm_usuario	= nm_usuario_p, 
			dt_atualizacao	= clock_timestamp(), 
			qt_unitaria	= qt_unitaria_w, 
			qt_material	= qt_material_w, 
			ie_regra_disp	= ie_regra_disp_w, 
			qt_total_dispensar	= qt_dispensar_w 
		where	nr_prescricao	= nr_prescricao_p 
		and	nr_sequencia	= nr_seq_prescricao_w;
		 
		Select	count(*) 
		into STRICT	qt_diluicao_w 
		from	Prescr_material 
		where 	nr_prescricao = nr_prescricao_p 
		and	nr_sequencia_diluicao = nr_seq_prescricao_w;
		 
		if (qt_diluicao_w > 0) then 
			Delete	 
			from	prescr_material 
			where 	nr_prescricao = nr_prescricao_p 
			and	nr_sequencia_diluicao = nr_seq_prescricao_w;
			 
			CALL Gerar_Reconst_Diluicao(nr_prescricao_p, nr_seq_prescricao_w, 'A');
		end if;
		 
		nr_erro_w := Consistir_Prescr_Material(nr_prescricao_p, nr_seq_prescricao_w, nm_usuario_p, obter_perfil_Ativo, nr_erro_w);
		 
		end;
	end loop;
	close C01;
 
	ie_prescr_hor_sem_lib_w := Obter_Param_Usuario(924, 530, obter_perfil_Ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_prescr_hor_sem_lib_w);
 
	if (ie_prescr_hor_sem_lib_w = 'S') then	 
		CALL Gerar_horarios_sem_lib(nr_prescricao_p	, nm_usuario_p);
	end if;
	 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_dose_peso_protocolo ( nm_usuario_p text, nr_prescricao_p bigint, qt_peso_p bigint) FROM PUBLIC;

