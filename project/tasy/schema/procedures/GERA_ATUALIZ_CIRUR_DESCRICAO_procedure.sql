-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gera_atualiz_cirur_descricao ( nr_cirurgia_p bigint, nr_seq_pepo_p bigint, cd_doenca_p text, cd_perfil_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text) AS $body$
DECLARE


ds_doenca_cid_w			varchar(2000);
dt_registro_w			timestamp;
nr_sequencia_w			bigint;
ds_diagnostico_pos_w		varchar(2000);
ie_tipo_descricao_w		varchar(3);
ds_descricao_w			varchar(2000);



BEGIN

select   	max(substr(ds_doenca_cid,1,240))
into STRICT	ds_doenca_cid_w
from     	cid_doenca
where	cd_doenca_cid = cd_doenca_p;

select	coalesce(max(dt_registro),''),
	coalesce(max(nr_sequencia),0),
	substr(coalesce(max(ds_diagnostico_pos),''),1,2000)
into STRICT	dt_registro_w,
	nr_sequencia_w,
	ds_diagnostico_pos_w
from	cirurgia_descricao
where	coalesce(dt_liberacao::text, '') = ''
and	((nr_cirurgia = nr_cirurgia_p) or (nr_seq_pepo = nr_seq_pepo_p));


if (nr_sequencia_w > 0) then
	if (ds_diagnostico_pos_w IS NOT NULL AND ds_diagnostico_pos_w::text <> '') then
		ds_descricao_w := substr(ds_diagnostico_pos_w,1,1500) ||chr(13) ||substr(ds_doenca_cid_w,1,500);
	end if;

	update	cirurgia_descricao
	set 	ds_diagnostico_pos = ds_descricao_w
	where	nr_sequencia = nr_sequencia_w;
else
	select	CASE WHEN count(*)=0 THEN 'P'  ELSE 'A' END
	into STRICT	ie_tipo_descricao_w
	from 	cirurgia_descricao
   	where 	((nr_cirurgia = nr_cirurgia_p) or (nr_seq_pepo = nr_seq_pepo_p))
	and 	cd_responsavel = cd_pessoa_fisica_p;

	insert into cirurgia_descricao(
					nr_sequencia,
					nr_cirurgia,
					dt_atualizacao,
					nm_usuario,
					ds_diagnostico,
					ds_cirurgia,
					ds_resumo_cirurgia,
					ds_diagnostico_pos,
					ds_exame_rad,
					ds_exame_anatomo,
					dt_liberacao,
					cd_responsavel,
					ie_tipo_descricao,
					nr_seq_protocolo,
					ds_intercorrencia,
					ie_situacao,
					dt_inativacao,
					nm_usuario_inativacao,
					ds_justificativa,
					dt_registro,
					nr_seq_pepo,
					cd_perfil_ativo)
	values (
					nextval('cirurgia_descricao_seq'),
					nr_cirurgia_p,
					clock_timestamp(),
					nm_usuario_p,
					null,
					null,
					null,
					ds_doenca_cid_w,
					null,
					null,
					null,
					cd_pessoa_fisica_p,
					ie_tipo_descricao_w,
					null,
					null,
					'A',
					null,
					null,
					null,
					clock_timestamp(),
					nr_seq_pepo_p,
					null);
end if;

end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gera_atualiz_cirur_descricao ( nr_cirurgia_p bigint, nr_seq_pepo_p bigint, cd_doenca_p text, cd_perfil_p bigint, cd_pessoa_fisica_p text, nm_usuario_p text) FROM PUBLIC;

