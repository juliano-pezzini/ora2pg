-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_util_solucao ( nr_prescricao_p bigint, nr_atendimento_p bigint, dt_prescricao_p timestamp, cd_material_p bigint, qt_dias_util_medic_p INOUT bigint, qt_dias_liberado_p INOUT bigint, ie_controle_medico_p INOUT bigint, qt_dias_lib_atend_p INOUT bigint) AS $body$
DECLARE


cd_material_generico_w	material.cd_material%type;
ie_dias_util_medic_w	varchar(1);
ie_controle_medico_w	smallint;
qt_dias_util_medic_w	bigint;
qt_dias_liberado_w		integer;
qt_notificacao_w		integer;
qt_nao_liberado_w		integer;
dt_anterior_w			timestamp;
dt_dia_parametro_w		timestamp;
dt_validade_ini_w		timestamp;
dt_validade_fim_w		timestamp;
qt_dias_antibiotico_w	smallint;
cd_estabelecimento_w	smallint;
qt_dias_lib_atend_w		bigint;


BEGIN
qt_dias_util_medic_w	:= 0;
qt_dias_Liberado_w		:= 0;
qt_dias_lib_atend_w		:= 0;

select	max(cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	atendimento_paciente
where	nr_atendimento = nr_atendimento_p;

select	coalesce(max(qt_dias_antibiotico),1)
into STRICT	qt_dias_antibiotico_w
from	parametro_medico
where	cd_estabelecimento	= cd_estabelecimento_w;

select	coalesce(max(cd_material_generico), max(cd_material)),
		coalesce(max(ie_dias_util_medic),'N'),
		coalesce(max(obter_controle_medic(cd_material,wheb_usuario_pck.get_cd_estabelecimento,ie_controle_medico,null,null,null)),0)
into STRICT	cd_material_generico_w,
		ie_dias_util_medic_w,
		ie_controle_medico_w
from	material
where	cd_material	= cd_material_P;

-- Indica que o sistema var retornar o numero de dias da utilizacao do med
if (ie_dias_util_medic_w = 'S') or (ie_dias_util_medic_w = 'O') or (ie_controle_medico_w = 2) then
	begin

	begin
	dt_anterior_w			:= (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescricao_p) - 1) + 86399/86400;
	dt_dia_parametro_w		:= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescricao_p) - qt_dias_antibiotico_w;

	select	coalesce(max(a.nr_dia_util),0),
			max(a.qt_total_dias_lib)
	into STRICT	qt_dias_util_medic_w,
			qt_dias_lib_atend_w
	from	prescr_material a,
			prescr_medica b
	where	a.nr_prescricao	= b.nr_prescricao
	and		b.nr_atendimento	= nr_atendimento_p
	and		coalesce(a.ie_suspenso,'N') = 'N'
	and		(a.nr_sequencia_solucao IS NOT NULL AND a.nr_sequencia_solucao::text <> '')
	and		b.dt_prescricao between dt_dia_parametro_w and dt_anterior_w
	and		(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
	and		a.cd_material in (
				SELECT	cd_material_generico_w
				
				
union

				SELECT	cd_material_p
				
				
union

				select	cd_material
				from	material
				where	cd_material_generico	= cd_material_generico_w);
	exception
		when others then
			qt_dias_util_medic_w	:= 0;
	end;
	
	qt_dias_util_medic_w			:= qt_dias_util_medic_w + 1;
	end;
end if;

-- Indica que o medico deve Justificar a utilizacao do Mesmo
if (ie_controle_medico_w = 1) then
	select	coalesce(max(1),0)
	into STRICT	ie_controle_medico_w
	from 	prescr_material a,
			prescr_medica b
	where	a.nr_prescricao	= b.nr_prescricao
	and		b.nr_atendimento	= nr_atendimento_p
	and		coalesce(a.ie_suspenso,'N') = 'N'
	and		(a.nr_sequencia_solucao IS NOT NULL AND a.nr_sequencia_solucao::text <> '')
	and		a.cd_material in (
				SELECT	cd_material_generico_w
				
				
union

				SELECT	cd_material_p
				
				
union

				select	cd_material
				from	material
				where	cd_material_generico	= cd_material_generico_w ) LIMIT 1;
end if;

dt_validade_ini_w	:= clock_timestamp() - interval '25 days';
dt_validade_fim_w	:= clock_timestamp() + interval '5 days';

-- Indica que o medico deve Justificar a utilizacao do Mesmo 
begin
select	sum(coalesce(qt_dias_liberado,0)),
		min(coalesce(qt_dias_liberado,0))
into STRICT	qt_dias_liberado_w,
		qt_nao_Liberado_w
from 	prescr_material a,
		prescr_medica b
where	a.nr_prescricao	= b.nr_prescricao
and		b.nr_atendimento	= nr_atendimento_p
and		b.dt_inicio_prescr between dt_validade_ini_w and dt_validade_fim_w
and		coalesce(a.ie_suspenso,'N') = 'N'
and		(a.nr_sequencia_solucao IS NOT NULL AND a.nr_sequencia_solucao::text <> '')
and		a.cd_material in (
			SELECT	cd_material_generico_w
			
			
union

			SELECT	cd_material_p
			
			
union

			select	cd_material
			from	material
			where	cd_material_generico	= cd_material_generico_w);
exception
	when others then
		qt_dias_liberado_w	:= 0;
end;

-- O numero de dias de utilizacao ultrapassou o liberado
if (ie_controle_medico_w <> 0) and (qt_dias_util_medic_w	> qt_dias_liberado_w) then
	ie_controle_medico_w		:= 9;
end if;

-- O Medicamento esta liberado
if (qt_dias_util_medic_w	<= qt_dias_liberado_w) and (qt_dias_liberado_w 	> 0) then
	ie_controle_medico_w		:= 0;
end if;

-- Indica se medicamento exige uma avaliacao
if (ie_controle_medico_w = 3) then
	ie_controle_medico_w := 3;
end if;

ie_controle_medico_p		:= ie_controle_medico_w;
qt_dias_util_medic_p		:= qt_dias_util_medic_w;
qt_dias_liberado_p			:= qt_dias_liberado_w;
qt_dias_lib_atend_p			:= qt_dias_lib_atend_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_util_solucao ( nr_prescricao_p bigint, nr_atendimento_p bigint, dt_prescricao_p timestamp, cd_material_p bigint, qt_dias_util_medic_p INOUT bigint, qt_dias_liberado_p INOUT bigint, ie_controle_medico_p INOUT bigint, qt_dias_lib_atend_p INOUT bigint) FROM PUBLIC;

