-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_resumo_prev_os ( nr_seq_gerencia_p bigint, nr_seq_grupo_des_p bigint, ie_considera_OS_proj_p text, nm_usuario_p text) AS $body$
DECLARE

 
pr_os_antiga_w			double precision;
nr_seq_grupo_des_w		bigint;
nr_seq_gerencia_w			bigint;
nr_sequencia_w			bigint;
qt_60_dia_w			bigint;
qt_45_dia_w			bigint;
qt_30_dia_w			bigint;
qt_15_dia_w			bigint;
qt_07_dia_w			bigint;
qt_semana_w			bigint;
qt_os_projeto_w			bigint;
qt_total_w			bigint;
qt_os_antiga_w			bigint;
qt_projeto_w			bigint;
dt_prevista_w			timestamp;
dt_fim_dia_w			timestamp;


BEGIN 
delete	FROM w_resumo_prev_os 
where	nm_usuario	= nm_usuario_p;
 
delete FROM w_resumo_prev_os_item 
where	nm_usuario	= nm_usuario_p;
 
commit;
 
dt_fim_dia_w	:= trunc(clock_timestamp()) + 86399/86400;
 
insert into w_man_ordem_servico( 
	nr_seq_ordem, 
	dt_ordem_servico, 
	nr_seq_grupo_des, 
	nr_seq_estagio, 
	ie_status_ordem, 
	dt_prevista, 
	nr_seq_gerencia, 
	nr_seq_ordem_ativ, 
	nm_usuario_exec) 
SELECT	a.nr_sequencia, 
	a.dt_ordem_servico, 
	a.nr_seq_grupo_des, 
	a.nr_seq_estagio, 
	a.ie_status_ordem, 
	trunc(c.dt_prevista) dt_prevista, 
	d.nr_seq_gerencia, 
	coalesce(c.nr_seq_ordem_serv,0), 
	coalesce(c.nm_usuario_prev,'Tasy') 
FROM grupo_desenvolvimento d, man_estagio_processo b, man_ordem_servico a
LEFT OUTER JOIN man_ordem_ativ_prev c ON (a.nr_sequencia = c.nr_seq_ordem_serv)
WHERE a.nr_seq_estagio	= b.nr_sequencia and ((b.ie_desenv		= 'S') 
	or (b.ie_tecnologia	= 'S') 
	or (b.ie_testes		= 'S'))  and coalesce(c.dt_prevista,clock_timestamp())	>= trunc(clock_timestamp()) and a.nr_seq_grupo_des	= d.nr_sequencia and exists (	SELECT	1 
		from	usuario_grupo_des p 
		where	p.nr_seq_grupo = a.nr_seq_grupo_des 
		and 	p.nm_usuario_grupo = coalesce(c.nm_usuario_prev,'Tasy')) group by a.nr_sequencia, 
	a.dt_ordem_servico, 
	a.nr_seq_grupo_des, 
	a.nr_seq_estagio, 
	a.ie_status_ordem, 
	trunc(c.dt_prevista), 
	d.nr_seq_gerencia, 
	coalesce(c.nr_seq_ordem_serv,0), 
	c.nm_usuario_prev 

union
 
select	a.nr_sequencia, 
	a.dt_ordem_servico, 
	a.nr_seq_grupo_des, 
	a.nr_seq_estagio, 
	a.ie_status_ordem, 
	max(trunc(c.dt_prevista)) dt_prevista, 
	d.nr_seq_gerencia, 
	coalesce(c.nr_seq_ordem_serv,0), 
	coalesce(c.nm_usuario_prev,'Tasy') 
FROM grupo_desenvolvimento d, man_estagio_processo b, man_ordem_servico a
LEFT OUTER JOIN man_ordem_ativ_prev c ON (a.nr_sequencia = c.nr_seq_ordem_serv)
WHERE a.nr_seq_estagio	= b.nr_sequencia and ((b.ie_desenv		= 'S') 
	or (b.ie_tecnologia	= 'S') 
	or (b.ie_testes		= 'S'))  and coalesce(c.dt_prevista,clock_timestamp())	< trunc(clock_timestamp()) and a.nr_seq_grupo_des	= d.nr_sequencia and exists (	select	1 
		from	usuario_grupo_des p 
		where	p.nr_seq_grupo = a.nr_seq_grupo_des 
		and	p.nm_usuario_grupo = coalesce(c.nm_usuario_prev,'Tasy')) group by a.nr_sequencia, 
	a.dt_ordem_servico, 
	a.nr_seq_grupo_des, 
	a.nr_seq_estagio, 
	a.ie_status_ordem, 
	d.nr_seq_gerencia, 
	coalesce(c.nr_seq_ordem_serv,0), 
	c.nm_usuario_prev 

union
 
select	a.nr_sequencia, 
	a.dt_ordem_servico, 
	a.nr_seq_grupo_des, 
	a.nr_seq_estagio, 
	a.ie_status_ordem, 
	trunc(x.dt_prevista) dt_prevista, 
	d.nr_seq_gerencia, 
	x.nr_seq_ordem_serv, 
	x.nm_usuario_prev 
from	grupo_desenvolvimento d, 
	man_estagio_processo b, 
	man_ordem_servico a, 
	man_ordem_ativ_prev x 
where	x.nr_seq_ordem_serv	= a.nr_sequencia 
and	a.nr_seq_estagio	= b.nr_sequencia 
and	coalesce(b.ie_desenv,'N')	= 'N' 
and	coalesce(b.ie_tecnologia,'N')= 'N' 
and	a.nr_seq_grupo_des	= d.nr_sequencia 
and exists (	select	1 
		from	usuario_grupo_des p 
		where 	p.nr_seq_grupo = a.nr_seq_grupo_des 
		and  	p.nm_usuario_grupo = coalesce(x.nm_usuario_prev,'Tasy')) 
and	x.dt_prevista between trunc(clock_timestamp()) and dt_fim_dia_w 

union
 
select	a.nr_sequencia, 
	a.dt_ordem_servico, 
	a.nr_seq_grupo_des, 
	a.nr_seq_estagio, 
	a.ie_status_ordem, 
	trunc(c.dt_prevista) dt_prevista, 
	d.nr_seq_gerencia, 
	coalesce(c.nr_seq_ordem_serv,0), 
	coalesce(c.nm_usuario_prev,'Tasy') 
FROM grupo_desenvolvimento d, man_estagio_processo b, man_ordem_servico a
LEFT OUTER JOIN man_ordem_ativ_prev c ON (a.nr_sequencia = c.nr_seq_ordem_serv)
WHERE a.nr_seq_estagio	= b.nr_sequencia and ((b.ie_desenv		= 'S') 
	or (b.ie_tecnologia	= 'S') 
	or (b.ie_testes		= 'S'))  and coalesce(c.dt_prevista,clock_timestamp())	>= trunc(clock_timestamp()) and a.nr_seq_grupo_des	= d.nr_sequencia and not exists (	select	1 
		from	usuario_grupo_des p 
		where	p.nr_seq_grupo = a.nr_seq_grupo_des 
		and  	p.nm_usuario_grupo = coalesce(c.nm_usuario_prev,'Tasy')) group by a.nr_sequencia, 
	a.dt_ordem_servico, 
	a.nr_seq_grupo_des, 
	a.nr_seq_estagio, 
	a.ie_status_ordem, 
	trunc(c.dt_prevista), 
	d.nr_seq_gerencia, 
	coalesce(c.nr_seq_ordem_serv,0), 
	c.nm_usuario_prev;
 
/*Total */
 
 
insert into w_resumo_prev_os(nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	dt_previsao, 
	nr_seq_gerencia, 
	nr_seq_grupo_des, 
	qt_total, 
	qt_60_dia, 
	qt_45_dia, 
	qt_30_dia, 
	qt_15_dia, 
	qt_07_dia, 
	qt_semana, 
	qt_os_antiga, 
	pr_os_antiga, 
	qt_os_projeto, 
	ie_tipo_prev) 
SELECT	nextval('w_resumo_prev_os_seq'), 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	dt_prevista, 
	nr_seq_gerencia, 
	nr_seq_grupo_des, 
	qt_total, 
	qt_60_dias, 
	qt_45_dias, 
	qt_30_dias, 
	qt_15_dias, 
	qt_07_dias, 
	qt_da_semana, 
	qt_tot_os_antiga, 
	pr_antiga, 
	qt_projeto, 
	'T' 
from ( 
	SELECT	trunc(dt_prevista,'dd') dt_prevista, 
		nr_seq_gerencia, 
		nr_seq_grupo_des, 
		count(*) qt_total, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(clock_timestamp() - interval '60 days','dd'))='S' THEN  1  ELSE 0 END ),0) qt_60_dias, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '59 days','dd'), trunc(clock_timestamp() - interval '45 days','dd'))='S' THEN  1  ELSE 0 END ),0) qt_45_dias, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '44 days','dd'), trunc(clock_timestamp() - interval '30 days','dd'))='S' THEN  1  ELSE 0 END ),0) qt_30_dias, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '29 days','dd'), trunc(clock_timestamp() - interval '15 days','dd'))='S' THEN  1  ELSE 0 END ),0) qt_15_dias, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '14 days','dd'), trunc(clock_timestamp() - interval '7 days','dd'))='S' THEN  1  ELSE 0 END ),0) qt_07_dias, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '6 days','dd'), trunc(clock_timestamp(),'dd'))='S' THEN  1  ELSE 0 END ),0) qt_da_semana, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(clock_timestamp() - interval '30 days','dd'))='S' THEN  1  ELSE 0 END ),0) qt_tot_os_antiga, 
		(dividir(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(clock_timestamp() - interval '30 days','dd'))='S' THEN  1  ELSE 0 END ), count(*)) *100) pr_antiga, 
		coalesce(sum(CASE WHEN obter_se_ordem_orig_projeto(nr_seq_ordem)='S' THEN 1  ELSE 0 END ),0) qt_projeto 
	from	( 
		select	trunc(dt_prevista,'dd') dt_prevista, 
			nr_seq_gerencia, 
			nr_seq_grupo_des, 
			dt_ordem_servico, 
			nr_seq_ordem 
		from	w_man_ordem_servico a 
		where	a.nr_seq_gerencia		= nr_seq_gerencia_p 
		and	((nr_seq_grupo_des_p = 0) or (a.nr_seq_grupo_des = nr_seq_grupo_des_p)) 
		and	((ie_considera_OS_proj_p = 'S') or (coalesce(proj_obter_dados_ordem_serv(a.nr_seq_ordem, 'PROJD')::text, '') = '')) 
		and	(a.dt_prevista IS NOT NULL AND a.dt_prevista::text <> '') 
		group by trunc(a.dt_prevista,'dd'), 
			a.nr_seq_gerencia, 
			a.nr_seq_grupo_des, 
			a.dt_ordem_servico, 
			a.nr_seq_ordem) alias83 
	group by trunc(dt_prevista,'dd'), 
			nr_seq_gerencia, 
			nr_seq_grupo_des, 
			nr_seq_ordem, 
			dt_ordem_servico) alias85;
	 
	 
insert into w_resumo_prev_os_item( 
	nm_usuario, 
	dt_previsao, 
	nr_seq_gerencia, 
	nr_seq_grupo_des, 
	nr_seq_ordem, 
	ie_tipo_prev) 
SELECT	nm_usuario_p, 
	trunc(dt_prevista,'dd'), 
	nr_seq_gerencia, 
	nr_seq_grupo_des, 
	nr_seq_ordem, 
	'T' 
from	w_man_ordem_servico a 
where	a.nr_seq_gerencia		= nr_seq_gerencia_p 
and	((nr_seq_grupo_des_p = 0) or (a.nr_seq_grupo_des = nr_seq_grupo_des_p)) 
and	((ie_considera_OS_proj_p = 'S') or (coalesce(proj_obter_dados_ordem_serv(a.nr_seq_ordem, 'PROJD')::text, '') = '')) 
and	(a.dt_prevista IS NOT NULL AND a.dt_prevista::text <> '') 
group by trunc(a.dt_prevista,'dd'), 
	a.nr_seq_gerencia, 
	a.nr_seq_grupo_des, 
	a.nr_seq_ordem;
 
 
/*Atrasada  OK */
 
insert into w_resumo_prev_os(nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	dt_previsao, 
	nr_seq_gerencia, 
	nr_seq_grupo_des, 
	qt_total, 
	qt_60_dia, 
	qt_45_dia, 
	qt_30_dia, 
	qt_15_dia, 
	qt_07_dia, 
	qt_semana, 
	qt_os_antiga, 
	pr_os_antiga, 
	qt_os_projeto, 
	ie_tipo_prev) 
SELECT	nextval('w_resumo_prev_os_seq'), 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	trunc(clock_timestamp()), 
	nr_seq_gerencia, 
	nr_seq_grupo_des, 
	qt_total, 
	qt_60_dias, 
	qt_45_dias, 
	qt_30_dias, 
	qt_15_dias, 
	qt_07_dias, 
	qt_da_semana, 
	qt_tot_os_antiga, 
	pr_antiga, 
	qt_projeto, 
	'ATR' 
from ( 
	SELECT	nr_seq_gerencia, 
		nr_seq_grupo_des, 
		count(*) qt_total, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(clock_timestamp() - interval '60 days','dd'))='S' THEN  1  ELSE 0 END ),0) qt_60_dias, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '59 days','dd'), trunc(clock_timestamp() - interval '45 days','dd'))='S' THEN  1  ELSE 0 END ),0) qt_45_dias, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '44 days','dd'), trunc(clock_timestamp() - interval '30 days','dd'))='S' THEN  1  ELSE 0 END ),0) qt_30_dias, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '29 days','dd'), trunc(clock_timestamp() - interval '15 days','dd'))='S' THEN  1  ELSE 0 END ),0) qt_15_dias, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '14 days','dd'), trunc(clock_timestamp() - interval '7 days','dd'))='S' THEN  1  ELSE 0 END ),0) qt_07_dias, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '6 days','dd'), trunc(clock_timestamp(),'dd'))='S' THEN  1  ELSE 0 END ),0) qt_da_semana, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(clock_timestamp() - interval '30 days','dd'))='S' THEN  1  ELSE 0 END ),0) qt_tot_os_antiga, 
		(dividir(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(clock_timestamp() - interval '30 days','dd'))='S' THEN  1  ELSE 0 END ), count(*)) *100) pr_antiga, 
		coalesce(sum(CASE WHEN obter_se_ordem_orig_projeto(nr_seq_ordem)='S' THEN 1  ELSE 0 END ),0) qt_projeto 
	from ( 
		select	nr_seq_gerencia, 
			nr_seq_grupo_des, 
			dt_ordem_servico, 
			nr_seq_ordem 
		from	man_estagio_processo p, 
			w_man_ordem_servico a 
		where	p.nr_sequencia		= a.nr_seq_estagio 
		and	a.nr_seq_gerencia	= nr_seq_gerencia_p 
		and	((nr_seq_grupo_des_p = 0) or (a.nr_seq_grupo_des = nr_seq_grupo_des_p)) 
		and	((ie_considera_OS_proj_p = 'S') or (coalesce(proj_obter_dados_ordem_serv(a.nr_seq_ordem, 'PROJD')::text, '') = '')) 
		and	a.ie_status_ordem <> 3 
		and	((p.ie_desenv		= 'S') 
			or (p.ie_tecnologia	= 'S')) 
		and exists (	select	1 
				from	w_man_ordem_servico b 
				where	a.nr_seq_ordem	= b.nr_seq_ordem 
				and	b.dt_prevista	< trunc(clock_timestamp()) 
				and	b.nr_seq_grupo_des	= a.nr_seq_grupo_des) 
		and not exists (select	1 
				from	w_man_ordem_servico b 
				where	a.nr_seq_ordem	= b.nr_seq_ordem 
				and	b.dt_prevista	>= trunc(clock_timestamp()) 
				and	b.nr_seq_grupo_des	= a.nr_seq_grupo_des) 
		group by a.nr_seq_gerencia, 
			a.nr_seq_grupo_des, 
			a.nr_seq_ordem, 
			a.dt_ordem_servico) alias90 
	group by nr_seq_gerencia, 
		nr_seq_grupo_des, 
		dt_ordem_servico, 
		nr_seq_ordem) alias91;
 
		 
insert into w_resumo_prev_os_item( 
	nm_usuario, 
	dt_previsao, 
	nr_seq_gerencia, 
	nr_seq_grupo_des, 
	nr_seq_ordem, 
	ie_tipo_prev) 
SELECT	nm_usuario_p, 
	trunc(clock_timestamp(),'dd'), 
	nr_seq_gerencia, 
	nr_seq_grupo_des, 
	nr_seq_ordem, 
	'ATR' 
from	man_estagio_processo p, 
	w_man_ordem_servico a 
where	p.nr_sequencia		= a.nr_seq_estagio 
and	a.nr_seq_gerencia	= nr_seq_gerencia_p 
and	((nr_seq_grupo_des_p = 0) or (a.nr_seq_grupo_des = nr_seq_grupo_des_p)) 
and	((ie_considera_OS_proj_p = 'S') or (coalesce(proj_obter_dados_ordem_serv(a.nr_seq_ordem, 'PROJD')::text, '') = '')) 
and	a.ie_status_ordem <> 3 
and	((p.ie_desenv		= 'S') 
	or (p.ie_tecnologia	= 'S')) 
and exists (	SELECT	1 
		from	w_man_ordem_servico b 
		where	a.nr_seq_ordem	= b.nr_seq_ordem 
		and	b.dt_prevista	< trunc(clock_timestamp()) 
		and	b.nr_seq_grupo_des	= a.nr_seq_grupo_des) 
and not exists (select	1 
		from	w_man_ordem_servico b 
		where	a.nr_seq_ordem	= b.nr_seq_ordem 
		and	b.dt_prevista	>= trunc(clock_timestamp()) 
		and	b.nr_seq_grupo_des	= a.nr_seq_grupo_des) 
group by trunc(clock_timestamp(),'dd'), 
	a.nr_seq_gerencia, 
	a.nr_seq_grupo_des, 
	a.nr_seq_ordem;
 
	 
/*Sem atividade prevista OK*/
 
insert into w_resumo_prev_os(nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	dt_previsao, 
	nr_seq_gerencia, 
	nr_seq_grupo_des, 
	qt_total, 
	qt_60_dia, 
	qt_45_dia, 
	qt_30_dia, 
	qt_15_dia, 
	qt_07_dia, 
	qt_semana, 
	qt_os_antiga, 
	pr_os_antiga, 
	qt_os_projeto, 
	ie_tipo_prev) 
SELECT	nextval('w_resumo_prev_os_seq'), 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	dt_prevista, 
	nr_seq_gerencia, 
	nr_seq_grupo_des, 
	qt_total, 
	qt_60_dias, 
	qt_45_dias, 
	qt_30_dias, 
	qt_15_dias, 
	qt_07_dias, 
	qt_da_semana, 
	qt_tot_os_antiga, 
	pr_antiga, 
	qt_projeto, 
	'SAP' 
from ( 
	SELECT	trunc(clock_timestamp(),'dd') dt_prevista, 
		nr_seq_gerencia, 
		nr_seq_grupo_des, 
		count(*) qt_total, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(clock_timestamp() - interval '60 days','dd'))='S' THEN  1  ELSE 0 END ),0) qt_60_dias, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '59 days','dd'), trunc(clock_timestamp() - interval '45 days','dd'))='S' THEN  1  ELSE 0 END ),0) qt_45_dias, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '44 days','dd'), trunc(clock_timestamp() - interval '30 days','dd'))='S' THEN  1  ELSE 0 END ),0) qt_30_dias, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '29 days','dd'), trunc(clock_timestamp() - interval '15 days','dd'))='S' THEN  1  ELSE 0 END ),0) qt_15_dias, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '14 days','dd'), trunc(clock_timestamp() - interval '7 days','dd'))='S' THEN  1  ELSE 0 END ),0) qt_07_dias, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '6 days','dd'), trunc(clock_timestamp(),'dd'))='S' THEN  1  ELSE 0 END ),0) qt_da_semana, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(clock_timestamp() - interval '30 days','dd'))='S' THEN  1  ELSE 0 END ),0) qt_tot_os_antiga, 
		(dividir(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(clock_timestamp() - interval '30 days','dd'))='S' THEN  1  ELSE 0 END ), count(*)) *100) pr_antiga, 
		coalesce(sum(CASE WHEN obter_se_ordem_orig_projeto(nr_seq_ordem)='S' THEN 1  ELSE 0 END ),0) qt_projeto 
	from ( 
		select	nr_seq_gerencia, 
			nr_seq_grupo_des, 
			dt_ordem_servico, 
			nr_seq_ordem 
		from	man_estagio_processo p, 
			w_man_ordem_servico a 
		where	p.nr_sequencia		= a.nr_seq_estagio 
		and	a.nr_seq_gerencia	= nr_seq_gerencia_p 
		and	((nr_seq_grupo_des_p = 0) or (a.nr_seq_grupo_des = nr_seq_grupo_des_p)) 
		and	((ie_considera_OS_proj_p = 'S') or (coalesce(proj_obter_dados_ordem_serv(a.nr_seq_ordem, 'PROJD')::text, '') = '')) 
		and	a.ie_status_ordem <> 3 
		and	((p.ie_desenv		= 'S') 
			or (p.ie_tecnologia	= 'S')) 
		and	exists (select 1 
				from 	man_estagio_processo h 
				where	h.ie_desenv = 'S' 
				and	h.nr_sequencia = a.nr_seq_estagio) 
		and not exists (select	1 
				from	usuario_grupo_des c, 
					w_man_ordem_servico b 
				where	a.nr_seq_ordem		= b.nr_seq_ordem 
				and	b.nr_seq_grupo_des	= a.nr_seq_grupo_des 
				and	b.nr_seq_grupo_des	= c.nr_seq_grupo 
				and	b.nm_usuario_exec	= c.nm_usuario_grupo) 
		group by a.nr_seq_gerencia, 
			a.nr_seq_grupo_des, 
			a.nr_seq_ordem, 
			a.dt_ordem_servico) alias86 
	group by trunc(clock_timestamp(),'dd'), 
		nr_seq_gerencia, 
		nr_seq_grupo_des, 
		nr_seq_ordem) alias89;
	 
 
insert into w_resumo_prev_os_item( 
	nm_usuario, 
	dt_previsao, 
	nr_seq_gerencia, 
	nr_seq_grupo_des, 
	nr_seq_ordem, 
	ie_tipo_prev) 
SELECT	nm_usuario_p, 
	trunc(clock_timestamp(),'dd'), 
	nr_seq_gerencia, 
	nr_seq_grupo_des, 
	nr_seq_ordem, 
	'SAP' 
from	man_estagio_processo p, 
	w_man_ordem_servico a 
where	p.nr_sequencia		= a.nr_seq_estagio 
and	a.nr_seq_gerencia	= nr_seq_gerencia_p 
and	((nr_seq_grupo_des_p = 0) or (a.nr_seq_grupo_des = nr_seq_grupo_des_p)) 
and	((ie_considera_OS_proj_p = 'S') or (coalesce(proj_obter_dados_ordem_serv(a.nr_seq_ordem, 'PROJD')::text, '') = '')) 
and	a.ie_status_ordem <> 3 
and	((p.ie_desenv		= 'S') 
	or (p.ie_tecnologia	= 'S')) 
and	exists (SELECT 1 
		from 	man_estagio_processo h 
		where	h.ie_desenv = 'S' 
		and	h.nr_sequencia = a.nr_seq_estagio) 
and not exists (select	1 
		from	usuario_grupo_des c, 
			w_man_ordem_servico b 
		where	a.nr_seq_ordem		= b.nr_seq_ordem 
		and	b.nr_seq_grupo_des	= a.nr_seq_grupo_des 
		and	b.nr_seq_grupo_des	= c.nr_seq_grupo 
		and	b.nm_usuario_exec	= c.nm_usuario_grupo) 
group by trunc(clock_timestamp(),'dd'), 
	a.nr_seq_gerencia, 
	a.nr_seq_grupo_des, 
	a.nr_seq_ordem;	
 
	 
/*Sem data prevista    OK */
  
insert into w_resumo_prev_os(nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	dt_previsao, 
	nr_seq_gerencia, 
	nr_seq_grupo_des, 
	qt_total, 
	qt_60_dia, 
	qt_45_dia, 
	qt_30_dia, 
	qt_15_dia, 
	qt_07_dia, 
	qt_semana, 
	qt_os_antiga, 
	pr_os_antiga, 
	qt_os_projeto, 
	ie_tipo_prev) 
SELECT	nextval('w_resumo_prev_os_seq'), 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	coalesce(dt_prevista,trunc(clock_timestamp())), 
	nr_seq_gerencia, 
	nr_seq_grupo_des, 
	qt_total, 
	qt_60_dias, 
	qt_45_dias, 
	qt_30_dias, 
	qt_15_dias, 
	qt_07_dias, 
	qt_da_semana, 
	qt_tot_os_antiga, 
	pr_antiga, 
	qt_projeto, 
	'SDP' 
from ( 
	SELECT	dt_prevista, 
		nr_seq_gerencia, 
		nr_seq_grupo_des, 
		count(*) qt_total, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(clock_timestamp() - interval '60 days','dd'))='S' THEN  1  ELSE 0 END ),0) qt_60_dias, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '59 days','dd'), trunc(clock_timestamp() - interval '45 days','dd'))='S' THEN  1  ELSE 0 END ),0) qt_45_dias, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '44 days','dd'), trunc(clock_timestamp() - interval '30 days','dd'))='S' THEN  1  ELSE 0 END ),0) qt_30_dias, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '29 days','dd'), trunc(clock_timestamp() - interval '15 days','dd'))='S' THEN  1  ELSE 0 END ),0) qt_15_dias, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '14 days','dd'), trunc(clock_timestamp() - interval '7 days','dd'))='S' THEN  1  ELSE 0 END ),0) qt_07_dias, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), trunc(clock_timestamp() - interval '6 days','dd'), trunc(clock_timestamp(),'dd'))='S' THEN  1  ELSE 0 END ),0) qt_da_semana, 
		coalesce(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(clock_timestamp() - interval '30 days','dd'))='S' THEN  1  ELSE 0 END ),0) qt_tot_os_antiga, 
		(dividir(sum(CASE WHEN obter_se_data_periodo(trunc(dt_ordem_servico, 'dd'), to_date('01/01/2007','dd/mm/yyyy'), trunc(clock_timestamp() - interval '30 days','dd'))='S' THEN  1  ELSE 0 END ), count(*)) *100) pr_antiga, 
		coalesce(sum(CASE WHEN obter_se_ordem_orig_projeto(nr_seq_ordem)='S' THEN 1  ELSE 0 END ),0) qt_projeto 
	from ( 
		select	trunc(dt_prevista,'dd') dt_prevista, 
			nr_seq_gerencia, 
			nr_seq_grupo_des, 
			dt_ordem_servico, 
			nr_seq_ordem 
		from	man_estagio_processo p, 
			usuario_grupo_des u, 
			w_man_ordem_servico a 
		where	a.nr_seq_grupo_des   = u.nr_seq_grupo 
		and   a.nm_usuario_exec    = u.nm_usuario_grupo 
		and	p.nr_sequencia		= a.nr_seq_estagio 
		and	a.nr_seq_gerencia	= nr_seq_gerencia_p 
		and	((nr_seq_grupo_des_p = 0) or (a.nr_seq_grupo_des = nr_seq_grupo_des_p)) 
		and	((ie_considera_OS_proj_p = 'S') or (coalesce(proj_obter_dados_ordem_serv(a.nr_seq_ordem, 'PROJD')::text, '') = '')) 
		and	a.ie_status_ordem <> 3 
		and	((p.ie_desenv		= 'S') 
			or (p.ie_tecnologia	= 'S')) 
		and not exists (select	1 
				from  usuario_grupo_des c, 
					w_man_ordem_servico b 
				where  a.nr_seq_ordem 	= b.nr_seq_ordem 
				and   b.nr_seq_grupo_des   = a.nr_seq_grupo_des 
				and   b.nr_seq_grupo_des   = c.nr_seq_grupo 
				and   b.nm_usuario_exec    = c.nm_usuario_grupo 
				and	(b.dt_prevista IS NOT NULL AND b.dt_prevista::text <> '')) 
		and exists (	select	1 
				from	usuario_grupo_des c, 
					w_man_ordem_servico b 
				where  a.nr_seq_ordem 	= b.nr_seq_ordem 
				and   b.nr_seq_grupo_des   = a.nr_seq_grupo_des 
				and   b.nr_seq_grupo_des   = c.nr_seq_grupo 
				and   b.nm_usuario_exec    = c.nm_usuario_grupo 
				and	coalesce(b.dt_prevista::text, '') = '') 
		group by trunc(a.dt_prevista,'dd'), 
			nr_seq_gerencia, 
			nr_seq_grupo_des, 
			nr_seq_ordem, 
			dt_ordem_servico) alias91 
	group by dt_prevista, 
		nr_seq_gerencia, 
		nr_seq_grupo_des, 
		nr_seq_ordem, 
		dt_ordem_servico) alias92;
		 
insert into w_resumo_prev_os_item( 
	nm_usuario, 
	dt_previsao, 
	nr_seq_gerencia, 
	nr_seq_grupo_des, 
	nr_seq_ordem, 
	ie_tipo_prev) 
SELECT	nm_usuario_p, 
	coalesce(trunc(dt_prevista,'dd'),trunc(clock_timestamp(),'dd')), 
	nr_seq_gerencia, 
	nr_seq_grupo_des, 
	nr_seq_ordem, 
	'SDP' 
from	man_estagio_processo p, 
	usuario_grupo_des u, 
	w_man_ordem_servico a 
where	a.nr_seq_grupo_des   = u.nr_seq_grupo 
and   a.nm_usuario_exec    = u.nm_usuario_grupo 
and	p.nr_sequencia		= a.nr_seq_estagio 
and	a.nr_seq_gerencia	= nr_seq_gerencia_p 
and	((nr_seq_grupo_des_p = 0) or (a.nr_seq_grupo_des = nr_seq_grupo_des_p)) 
and	((ie_considera_OS_proj_p = 'S') or (coalesce(proj_obter_dados_ordem_serv(a.nr_seq_ordem, 'PROJD')::text, '') = '')) 
and	a.ie_status_ordem <> 3 
and	((p.ie_desenv		= 'S') 
	or (p.ie_tecnologia	= 'S')) 
and not exists (SELECT	1 
		from  usuario_grupo_des c, 
			w_man_ordem_servico b 
		where  a.nr_seq_ordem 	= b.nr_seq_ordem 
		and   b.nr_seq_grupo_des   = a.nr_seq_grupo_des 
		and   b.nr_seq_grupo_des   = c.nr_seq_grupo 
		and   b.nm_usuario_exec    = c.nm_usuario_grupo 
		and	(b.dt_prevista IS NOT NULL AND b.dt_prevista::text <> '')) 
and exists (	select	1 
		from	usuario_grupo_des c, 
			w_man_ordem_servico b 
		where  a.nr_seq_ordem 	= b.nr_seq_ordem 
		and   b.nr_seq_grupo_des   = a.nr_seq_grupo_des 
		and   b.nr_seq_grupo_des   = c.nr_seq_grupo 
		and   b.nm_usuario_exec    = c.nm_usuario_grupo 
		and	coalesce(b.dt_prevista::text, '') = '') 
group by coalesce(trunc(dt_prevista,'dd'),trunc(clock_timestamp(),'dd')), 
	nr_seq_gerencia, 
	nr_seq_grupo_des, 
	nr_seq_ordem;
	 
commit;
 
CALL exec_sql_dinamico('Tasy','truncate table w_man_ordem_servico');
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_resumo_prev_os ( nr_seq_gerencia_p bigint, nr_seq_grupo_des_p bigint, ie_considera_OS_proj_p text, nm_usuario_p text) FROM PUBLIC;

