-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_utlfile_jales_prestador ( nm_arquivo_p text, nm_usuario_p text) AS $body$
DECLARE


ds_conteudo_w			varchar(4000);
nm_arquivo_w			varchar(255);
ds_local_w			varchar(255) := null;
ds_erro_w			varchar(255);
arq_texto_w			utl_file.file_type;

/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:

-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[ ]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
c01 CURSOR FOR
	SELECT 	nr_sequencia||';'||
		numero_guia||';'||
		codigo_local_atendimento ||';'||
		codigo_beneficiario ||';'||
		nome_beneficiario ||';'||
		tipo_atendimento ||';'||
		tipo_internacao ||';'||
		motivo_internacao ||';'||
		to_char(data_atendimento, 'YYYY-MM-DD hh24:mi:ss')||';'||
		to_char(data_alta, 'YYYY-MM-DD hh24:mi:ss')||';'||
		motivo_alta ||';'||
		cid ||';'||
		cid_secundario ||';'||
		codigo_obito ||';'||
		cid_obito ||';'||
		nro_declaracao_obito ||';'||
		tipo_nascimento ||';'||
		nascidos_vivos ||';'||
		nascidos_mortos ||';'||
		nascidos_prematuros ||';'||
		nro_declaracao_nascido_1 ||';'||
		nro_declaracao_nascido_2 ||';'||
		nro_declaracao_nascido_3 ||';'||
		nro_declaracao_nascido_4 ||';'||
		nro_declaracao_nascido_5 ||';'||
		tipo_despesa ||';'||
		codigo_despesa ||';'||
		descricao_despesa ||';'||
		to_char(data_servico, 'YYYY-MM-DD hh24:mi:ss') ||';'||
		quantidade_apresentada ||';'||
		quantidade_pagamento ||';'||
		fator ||';'||
		campo_mascara_virgula(valor_da_despesa) ||';'||
		campo_mascara_virgula(valor_de_filme) ||';'||
		valor_de_co_maquina ||';'||
		valor_adicional_despesa ||';'||
		valor_adicional_filme ||';'||
		valor_adicional_co_maquina ||';'||
		porte_anestesico ||';'||
		adicional ||';'||
		via_acesso ||';'||
		tecnica_utilizada ||';'||
		codigo_do_prestador ||';'||
		medico_executante ||';'||
		conselho_prof ||';'||
		uf_conselho ||';'||
		nome_medico_executante ||';'||
		medico_executante_aux1 ||';'||
		conselho_prof_aux1 ||';'||
		uf_conselho_aux1 ||';'||
		nome_medico_executante_aux1 ||';'||
		medico_executante_aux2 ||';'||
		conselho_prof_aux2 ||';'||
		uf_conselho_aux2 ||';'||
		nome_medico_executante_aux2 ||';'||
		medico_executante_aux3 ||';'||
		conselho_prof_aux3 ||';'||
		uf_conselho_aux3 ||';'||
		nome_medico_executante_aux3 ||';'||
		medico_executante_aux4 ||';'||
		conselho_prof_aux4 ||';'||
		uf_conselho_aux4 ||';'||
		nome_medico_executante_aux4 ||';'||
		medico_executante_aux5 ||';'||
		conselho_prof_aux5 ||';'||
		uf_conselho_aux5 ||';'||
		nome_medico_executante_aux5 ||';'||
		medico_executante_anest ||';'||
		conselho_prof_anest ||';'||
		uf_conselho_anest ||';'||
		nome_medico_executante_anest ds_conteudo
	from 	w_relat_inf_pag_prest
	where   nm_usuario = nm_usuario_p;



BEGIN
begin
SELECT * FROM obter_evento_utl_file(11, null, ds_local_w, ds_erro_w) INTO STRICT ds_local_w, ds_erro_w;
exception
when others then
	ds_local_w := null;
end;

nm_arquivo_w	:= nm_arquivo_p;

begin
arq_texto_w := utl_file.fopen(ds_local_w,nm_arquivo_w,'W');
exception
when others then
	if (SQLSTATE = -29289) then
		ds_erro_w  := 'O acesso ao arquivo foi negado pelo sistema operacional (access_denied).';
	elsif (SQLSTATE = -29298) then
		ds_erro_w  := 'O arquivo foi aberto usando FOPEN_NCHAR,  mas efetuaram-se operações de I/O usando funções nonchar comos PUTF ou GET_LINE (charsetmismatch).';
	elsif (SQLSTATE = -29291) then
		ds_erro_w  := 'Não foi possível apagar o arquivo (delete_failed).';
	elsif (SQLSTATE = -29286) then
		ds_erro_w  := 'Erro interno desconhecido no package UTL_FILE (internal_error).';
	elsif (SQLSTATE = -29282) then
		ds_erro_w  := 'O handle do arquivo não existe (invalid_filehandle).';
	elsif (SQLSTATE = -29288) then
		ds_erro_w  := 'O arquivo com o nome especificado não foi encontrado neste local (invalid_filename).';
	elsif (SQLSTATE = -29287) then
		ds_erro_w  := 'O valor de MAX_LINESIZE para FOPEN() é inválido; deveria estar na faixa de 1 a 32767 (invalid_maxlinesize).';
	elsif (SQLSTATE = -29281) then
		ds_erro_w  := 'O parâmetro open_mode na chamda FOPEN é inválido (invalid_mode).';
	elsif (SQLSTATE = -29290) then
		ds_erro_w  := 'O parâmetro ABSOLUTE_OFFSET para a chamada FSEEK() é inválido; deveria ser maior do que 0 e menor do que o número total de bytes do arquivo (invalid_offset).';
	elsif (SQLSTATE = -29283) then
		ds_erro_w  := 'O arquivo não pôde ser aberto ou operado da forma desejada - ou o caminho não foi encontrado (invalid_operation).';
	elsif (SQLSTATE = -29280) then
		ds_erro_w  := 'O caminho especificado não existe ou não está visível ao Oracle (invalid_path).';
	elsif (SQLSTATE = -29284) then
		ds_erro_w  := 'Não é possível efetuar a leitura do arquivo (read_error).';
	elsif (SQLSTATE = -29292) then
		ds_erro_w  := 'Não é possível renomear o arquivo.';
	elsif (SQLSTATE = -29285) then
		ds_erro_w  := 'Não foi possível gravar no arquivo (write_error).';
	else
		ds_erro_w  := 'Erro desconhecido no package UTL_FILE.';
	end if;
end;

open C01;
loop
fetch C01 into
	ds_conteudo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	utl_file.put_line(arq_texto_w,ds_conteudo_w || chr(13));
	utl_file.fflush(arq_texto_w);
	ds_conteudo_w := null;
	end;
end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_utlfile_jales_prestador ( nm_arquivo_p text, nm_usuario_p text) FROM PUBLIC;

