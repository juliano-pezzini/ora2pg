-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_verifica_repeticao_massas (nr_prescricao_p text, nr_seq_prescr_p text, nr_seq_exame_p text, ds_campo_upd_p text, ds_resultado_p text, nm_usuario_p text) AS $body$
DECLARE



nr_seq_resultado_w		exame_lab_resultado.nr_seq_resultado%type;
nr_seq_metodo_w			metodo_exame_lab.nr_sequencia%type;
nr_seq_material_w		material_exame_lab.nr_sequencia%type;
nr_seq_mat_prescr_w		material_exame_lab.nr_sequencia%type;
nr_repeticao_w			lote_ent_res_ant_repet.nr_repeticao%type;
nr_repeticao_princ_w	lote_ent_res_ant_repet.nr_repeticao%type;

qt_resultado_w			exame_lab_result_item.qt_resultado%type;
pr_resultado_w			exame_lab_result_item.pr_resultado%type;
ds_resultado_w			exame_lab_result_item.ds_resultado%type;
qt_resultado_ant_w		exame_lab_result_item.qt_resultado%type;
pr_resultado_ant_w		exame_lab_result_item.pr_resultado%type;
ds_resultado_ant_w		exame_lab_result_item.ds_resultado%type;
nr_seq_ficha_lote_w 	lote_ent_sec_ficha.nr_sequencia%type;

qt_resultado_princ_w 	exame_lab_result_item.qt_resultado%type;
pr_resultado_princ_w	exame_lab_result_item.pr_resultado%type;
ds_resultado_princ_w	exame_lab_result_item.ds_resultado%type;
nr_seq_metodo_princ_w	metodo_exame_lab.nr_sequencia%type;
nr_seq_material_princ_w	material_exame_lab.nr_sequencia%type;
nr_seq_exame_princ_w	exame_laboratorio.nr_seq_exame%type;



BEGIN

if (ds_campo_upd_p = 'ds_resultado') then
	ds_resultado_w := ds_resultado_p;
elsif (ds_campo_upd_p = 'qt_resultado') then
	begin
	qt_resultado_w := ds_resultado_p;
	exception
		when others then
			begin
			qt_resultado_w := replace(ds_resultado_p,',','.');
			exception
				when others then
					qt_resultado_w := replace(ds_resultado_p,'.',',');
			end;
	end;
elsif (ds_campo_upd_p = 'pr_resultado') then
	pr_resultado_w := ds_resultado_p;
end if;

select 	MAX(nr_seq_resultado)
into STRICT	nr_seq_resultado_w
from	exame_lab_resultado
where	nr_prescricao = nr_prescricao_p;

if (nr_seq_resultado_w IS NOT NULL AND nr_seq_resultado_w::text <> '') then

	select  MAX(b.nr_sequencia)
	into STRICT	nr_seq_mat_prescr_w
	from	prescr_procedimento a,
			material_exame_lab b
	where 	a.cd_material_exame = b.cd_material_exame
	and		a.nr_prescricao = nr_prescricao_p
	and		a.nr_sequencia = nr_seq_prescr_p;

	select 	max(qt_resultado),
			max(pr_resultado),
			max(ds_resultado),
			max(nr_seq_metodo),
			max(nr_seq_material)
	into STRICT 	qt_resultado_ant_w,
			pr_resultado_ant_w,
			ds_resultado_ant_w,
			nr_seq_metodo_w,
			nr_seq_material_w
	from 	exame_lab_result_item
	where	nr_seq_resultado = nr_seq_resultado_w
	and		nr_seq_prescr = nr_seq_prescr_p
	and		nr_seq_exame = nr_seq_exame_p
	and 	((qt_resultado <> 0) or (pr_resultado <> 0) or (ds_resultado IS NOT NULL AND ds_resultado::text <> ''));

	if (coalesce(nr_seq_metodo_w::text, '') = '') then
		select 	max(nr_seq_metodo)
		into STRICT	nr_seq_metodo_w
		from   	exame_lab_result_item
		where   nr_seq_resultado = nr_seq_resultado_w
		order by 1;
	end if;

	select 	count(*)
	into STRICT	nr_repeticao_w
	from	lote_ent_res_ant_repet
	where	nr_prescricao = nr_prescricao_p
	and		nr_seq_prescr = nr_seq_prescr_p
	and		nr_seq_exame = nr_seq_exame_p;

	if (nr_repeticao_w < 6) then

		select 	Max(nr_sequencia)
		into STRICT	nr_seq_ficha_lote_w
		from	lote_ent_sec_ficha
		where	nr_prescricao = nr_prescricao_p;

		qt_resultado_ant_w := qt_resultado_w;
		pr_resultado_ant_w := pr_resultado_w;
		ds_resultado_ant_w := ds_resultado_w;

		insert into lote_ent_res_ant_repet(nr_sequencia,
											dt_atualizacao,
											nm_usuario,
											dt_atualizacao_nrec,
											nm_usuario_nrec,
											nr_prescricao,
											nr_seq_resultado,
											nr_seq_prescr,
											nr_seq_exame,
											nr_seq_ficha_lote,
											nr_repeticao,
											qt_result_ant,
											pr_result_ant,
											ds_result_ant,
											nr_seq_metodo,
											nr_seq_material )
						values (nextval('lote_ent_res_ant_repet_seq'),
											clock_timestamp(),
											nm_usuario_p,
											clock_timestamp(),
											nm_usuario_p,
											nr_prescricao_p,
											nr_seq_resultado_w,
											nr_seq_prescr_p,
											nr_seq_exame_p,
											nr_seq_ficha_lote_w,
											nr_repeticao_w + 1,
											qt_resultado_ant_w,
											pr_resultado_ant_w,
											ds_resultado_ant_w,
											nr_seq_metodo_w,
											nr_seq_mat_prescr_w);

		commit;

		select 	MAX(nr_seq_exame),
				max(qt_resultado),
				max(pr_resultado),
				max(ds_resultado),
				max(nr_seq_metodo),
				max(nr_seq_material)
		into STRICT 	nr_seq_exame_princ_w,
				qt_resultado_princ_w,
				pr_resultado_princ_w,
				ds_resultado_princ_w,
				nr_seq_metodo_princ_w,
				nr_seq_material_princ_w
		from 	exame_lab_result_item
		where	nr_seq_resultado = nr_seq_resultado_w
		and		nr_seq_prescr = nr_seq_prescr_p
		and 	(nr_seq_material IS NOT NULL AND nr_seq_material::text <> '');

		if (nr_seq_exame_princ_w IS NOT NULL AND nr_seq_exame_princ_w::text <> '') then

			select 	count(*)
			into STRICT	nr_repeticao_princ_w
			from	lote_ent_res_ant_repet
			where	nr_prescricao = nr_prescricao_p
			and		nr_seq_prescr = nr_seq_prescr_p
			and		nr_seq_exame = nr_seq_exame_princ_w
			and		nr_repeticao = nr_repeticao_w+1;

			if (nr_repeticao_princ_w = 0) then
				insert into lote_ent_res_ant_repet(nr_sequencia,
									dt_atualizacao,
									nm_usuario,
									dt_atualizacao_nrec,
									nm_usuario_nrec,
									nr_prescricao,
									nr_seq_resultado,
									nr_seq_prescr,
									nr_seq_exame,
									nr_seq_ficha_lote,
									nr_repeticao,
									qt_result_ant,
									pr_result_ant,
									ds_result_ant,
									nr_seq_metodo,
									nr_seq_material )
				values (nextval('lote_ent_res_ant_repet_seq'),
									clock_timestamp(),
									nm_usuario_p,
									clock_timestamp(),
									nm_usuario_p,
									nr_prescricao_p,
									nr_seq_resultado_w,
									nr_seq_prescr_p,
									nr_seq_exame_princ_w,
									nr_seq_ficha_lote_w,
									nr_repeticao_w + 1,
									qt_resultado_princ_w,
									pr_resultado_princ_w,
									ds_resultado_princ_w,
									nr_seq_metodo_princ_w,
									nr_seq_mat_prescr_w);

			end if;

		end if;
	end if;
end if;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_verifica_repeticao_massas (nr_prescricao_p text, nr_seq_prescr_p text, nr_seq_exame_p text, ds_campo_upd_p text, ds_resultado_p text, nm_usuario_p text) FROM PUBLIC;

