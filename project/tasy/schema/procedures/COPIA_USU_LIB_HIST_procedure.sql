-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copia_usu_lib_hist (nm_usuario_p text, nr_sequencia_p bigint, nr_sequencia_hist_p bigint) AS $body$
DECLARE


nm_usuario_lib_w      varchar(15);
nr_sequencia_w	       bigint;
nr_sequencia_ww	       bigint;
qt_registro_W	       bigint;

c01 CURSOR FOR


SELECT  a.nm_usuario_lib
from 	cml_prospect_hist_lib a,
	cml_prospect_hist b,
	cml_prospect c
where 	a.nr_seq_historico = b.nr_sequencia
and	b.nr_seq_prospect = c.nr_sequencia
and	b.nr_sequencia = nr_sequencia_hist_p;

c02 CURSOR FOR

SELECT  nr_sequencia
from 	cml_prospect_hist
where 	nr_sequencia in (SELECT  nr_sequencia
		         FROM     CML_PROSPECT_HIST
			 where    nr_sequencia <> nr_sequencia_hist_p
		          and	nr_seq_prospect = nr_sequencia_p);


BEGIN

open c02;
loop
fetch c02 into
	nr_sequencia_ww;

EXIT WHEN NOT FOUND; /* apply on c02 */
	begin

		open c01;
		loop
		fetch c01 into
			nm_usuario_lib_w;

		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin

			select 	count(*)
			into STRICT	qt_registro_W
			from  	cml_prospect_hist_lib a,
				cml_prospect_hist b
			where 	a.nr_seq_historico = b.nr_sequencia
			and	b.nr_sequencia = nr_sequencia_ww
			and	a.nm_usuario_lib = nm_usuario_lib_w;

			if qt_registro_W = 0 then

				select	nextval('cml_prospect_hist_lib_seq')
				into STRICT	nr_sequencia_w
				;


				insert into cml_prospect_hist_lib(
							nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nm_usuario_lib,
							dt_leitura,
							nr_seq_historico
							)
							values (
							nr_sequencia_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_P,
							nm_usuario_lib_w,
							null,
							nr_sequencia_ww
							);
			end if;

			end;
		end loop;
		close c01;

	end;
	end loop;
close c02;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copia_usu_lib_hist (nm_usuario_p text, nr_sequencia_p bigint, nr_sequencia_hist_p bigint) FROM PUBLIC;

