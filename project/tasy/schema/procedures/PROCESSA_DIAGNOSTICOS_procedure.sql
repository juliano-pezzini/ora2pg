-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE processa_diagnosticos ( cd_tipo_agenda_p agenda.cd_tipo_agenda%TYPE, ds_grupo_p text, nr_atendimento_p atendimento_paciente.nr_atendimento%TYPE, nr_grouping_his_p bigint ) IS ds_coluna_w varchar(50) RETURNS bigint AS $body$
DECLARE

        tam_lista_w bigint;

BEGIN
        SELECT
            length(ds)
        INTO STRICT tam_lista_w
;

        RETURN tam_lista_w;
    END;

    FUNCTION get_position(
                          ds     IN   CLOB,
                          item   IN   VARCHAR2
    ) RETURN NUMBER IS
        ie_pos_w NUMBER(5);
    BEGIN
        SELECT
            position(item in ds)
        INTO STRICT ie_pos_w
;

        RETURN ie_pos_w;
    END;

BEGIN
    ds_grupo_w := ds_grupo_p;
    WHILE(ds_grupo_w IS NOT NULL AND ds_grupo_w::text <> '') LOOP
        ie_pos_w := get_position(ds_grupo_w, '*');
        IF ( ie_pos_w <> 0 ) THEN
            ds_coluna_w := substr(ds_grupo_w, 1,(ie_pos_w - 1));
            ds_grupo_w := substr(ds_grupo_w,(ie_pos_w + 1), get_length(ds_grupo_w));

            dt_diagnostico_w := to_date(substr(ds_coluna_w, 1,(get_position(ds_coluna_w, '_') - 1)), 'dd/MM/yy hh24:mi:ss');

            cd_doenca_w := substr(ds_coluna_w, get_position(ds_coluna_w, '_') + 1, get_length(ds_coluna_w));

            SELECT
                MAX(ie_diag_admissao),
                MAX(ie_diag_referencia),
                MAX(ie_diag_alta),
                MAX(ie_diag_cirurgia),
                MAX(ie_diag_obito),
                MAX(ie_diag_tratamento),
                MAX(ie_diag_pre_cir),
                MAX(ie_diag_princ_depart),
                MAX(ie_diag_princ_episodio),
                MAX(ie_diag_trat_cert)
            INTO STRICT
                ie_diag_admissao_w,
                ie_diag_referencia_w,
                ie_diag_alta_w,
                ie_diag_cirurgia_w,
                ie_diag_obito_w,
                ie_diag_tratamento_w,
                ie_diag_pre_cir_w,
                ie_diag_princ_depart_w,
                ie_diag_princ_episodio_w,
                ie_diag_trat_cert_w
            FROM
                diagnostico_doenca
            WHERE
                nr_atendimento = nr_atendimento_p
                AND trunc(dt_diagnostico) = trunc(dt_diagnostico_w)
                AND trim(both cd_doenca) = trim(both cd_doenca_w);

            ds_first_caracter_w := substr(ds_grupo_w, 1, 1);
            ds_grupo_w := substr(ds_grupo_w, 2, get_length(ds_grupo_w));
            WHILE( ds_first_caracter_w <> '*' ) LOOP
                ie_pos_w := get_position(ds_grupo_w, '#');
                IF ( ie_pos_w <> 0 ) THEN
                    ds_coluna_w := substr(ds_grupo_w, 1,(ie_pos_w - 1));
                    ds_grupo_w := substr(ds_grupo_w,(ie_pos_w + 1), get_length(ds_grupo_w));

                    IF ( ds_coluna_w = 'IE_DIAG_ADMISSAO' ) THEN
                        ie_diag_admissao_w := 'N';
                        cd_item_exp_w := 856739;
                    ELSIF ( ds_coluna_w = 'IE_DIAG_REFERENCIA' ) THEN
                        ie_diag_referencia_w := 'N';
                        cd_item_exp_w := 941784;
                    ELSIF ( ds_coluna_w = 'IE_DIAG_ALTA' ) THEN
                        ie_diag_alta_w := 'N';
                        cd_item_exp_w := 941796;
                    ELSIF ( ds_coluna_w = 'IE_DIAG_CIRURGIA' ) THEN
                        ie_diag_cirurgia_w := 'N';
                        cd_item_exp_w := 941798;
                    ELSIF ( ds_coluna_w = 'IE_DIAG_OBITO' ) THEN
                        ie_diag_obito_w := 'N';
                        cd_item_exp_w := 941800;
                    ELSIF ( ds_coluna_w = 'IE_DIAG_TRATAMENTO' ) THEN
                        ie_diag_tratamento_w := 'N';
                        cd_item_exp_w := 857223;
                    ELSIF ( ds_coluna_w = 'IE_DIAG_PRE_CIR' ) THEN
                        ie_diag_pre_cir_w := 'N';
                        cd_item_exp_w := 287710;
                    ELSIF ( ds_coluna_w = 'IE_DIAG_PRINC_DEPART' ) THEN
                        ie_diag_princ_depart_w := 'N';
                        cd_item_exp_w := 941802;
                    ELSIF ( ds_coluna_w = 'IE_DIAG_PRINC_EPISODIO' ) THEN
                        ie_diag_princ_episodio_w := 'N';
                        cd_item_exp_w := 856957;
                    ELSIF ( ds_coluna_w = 'IE_DIAG_TRAT_CERT' ) THEN
                        ie_diag_trat_cert_w := 'N';
                        cd_item_exp_w := 941804;
                    END IF;

                END IF;

                CALL insert_atend_hist_paciente(nr_atendimento_p, cd_tipo_agenda_p, cd_item_exp_w, dt_diagnostico_w, cd_doenca_w, NULL, 0, NULL, nr_grouping_his_p, ds_coluna_w);

                ds_first_caracter_w := substr(ds_grupo_w, 1, 1);
                IF ( ds_first_caracter_w = '*' ) THEN
                    ds_grupo_w := substr(ds_grupo_w, 2, get_length(ds_grupo_w));
                END IF;

                IF ( length(ds_grupo_w) = 0 ) THEN
                    ds_first_caracter_w := '*';
                    ds_grupo_w := NULL;
                END IF;

            END LOOP;

            UPDATE diagnostico_doenca
            SET
                ie_diag_admissao = ie_diag_admissao_w,
                ie_diag_referencia = ie_diag_referencia_w,
                ie_diag_alta = ie_diag_alta_w,
                ie_diag_cirurgia = ie_diag_cirurgia_w,
                ie_diag_obito = ie_diag_obito_w,
                ie_diag_tratamento = ie_diag_tratamento_w,
                ie_diag_pre_cir = ie_diag_pre_cir_w,
                ie_diag_princ_depart = ie_diag_princ_depart_w,
                ie_diag_princ_episodio = ie_diag_princ_episodio_w,
                ie_diag_trat_cert = ie_diag_trat_cert_w,
                nm_usuario = wheb_usuario_pck.get_nm_usuario,
                dt_atualizacao = clock_timestamp()
            WHERE
                nr_atendimento = nr_atendimento_p
                AND trunc(dt_diagnostico) = trunc(dt_diagnostico_w)
                AND trim(both cd_doenca) = trim(both cd_doenca_w);

            COMMIT;
        END IF;

    END LOOP;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE processa_diagnosticos ( cd_tipo_agenda_p agenda.cd_tipo_agenda%TYPE, ds_grupo_p text, nr_atendimento_p atendimento_paciente.nr_atendimento%TYPE, nr_grouping_his_p bigint ) IS ds_coluna_w varchar(50) FROM PUBLIC;

