-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rop_consiste_roupa ( nr_sequencia_p bigint, cd_barra_roupa_p text, nr_seq_local_p bigint, nr_seq_operacao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_geracao_p text, ds_erro INOUT text) AS $body$
DECLARE


ds_erro_w				varchar(255) := '';
nr_seq_roupa_w				bigint;
nr_seq_movto_roupa_w			bigint;
cd_material_w				bigint;
ie_situacao_w				varchar(1);
dt_baixa_w				timestamp;
nr_seq_local_atual_w			bigint;
nr_seq_lote_roupa_w			bigint;
nr_seq_movto_w				bigint;
ie_operacao_w				varchar(15);
ie_local_dif_lote_w				varchar(1);
ds_local_atual_w				varchar(80);
ds_local_paramentro_w			varchar(80);
qt_peca_lote_w				bigint;
qt_existe_w				bigint;
ds_lotes_w				varchar(255);
ie_consiste_passagem_lav_w		varchar(1);
ds_tipo_local_orig_dest_w		varchar(15);
ie_desconsidera_zeros_w			varchar(15);
cd_barra_roupa_w			rop_roupa.cd_barra_roupa%type;


BEGIN

select	substr(rop_obter_dados_operacao(nr_seq_operacao_p, 'T'),1,15)
into STRICT	ie_operacao_w
;

select	coalesce(max(obter_valor_param_usuario(1301, 1, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)), 'N'),
	coalesce(max(obter_valor_param_usuario(1301,81, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)), 'N'),
	coalesce(max(obter_valor_param_usuario(1301,100, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p)), 'N')
into STRICT	ie_local_dif_lote_w,
	ie_consiste_passagem_lav_w,
	ie_desconsidera_zeros_w
;

if (nr_Sequencia_p > 0) then
	select	substr(rop_obter_dados_local(nr_seq_local_orig_dest,'T'),1,15) ds_tipo_local_orig_dest
	into STRICT	ds_tipo_local_orig_dest_w
	from	rop_lote_movto
	where	nr_sequencia = nr_sequencia_p;
end if;

cd_barra_roupa_w	:= cd_barra_roupa_p;
if (ie_desconsidera_zeros_w = 'S') then
	cd_barra_roupa_w	:= somente_numero(cd_barra_roupa_p);
end if;

begin
select	a.nr_sequencia,
	b.cd_material,
	a.ie_situacao,
	a.dt_baixa,
	a.nr_seq_local,
	substr(rop_obter_dados_local(nr_seq_local_p, 'D'),1,80) ds_local_paramentro,
	substr(rop_obter_dados_local(a.nr_seq_local, 'D'),1,80) ds_local_atual,
	a.nr_seq_lote_roupa
into STRICT	nr_seq_roupa_w,
	cd_material_w,
	ie_situacao_w,
	dt_baixa_w,
	nr_seq_local_atual_w,
	ds_local_paramentro_w,
	ds_local_atual_w,
	nr_seq_lote_roupa_w
from	rop_lote_roupa b,
	rop_roupa a
where	a.nr_seq_lote_roupa	= b.nr_sequencia
and	a.cd_barra_roupa	= cd_barra_roupa_w
and	a.ie_situacao		= 'A';
exception
	when no_data_found then
		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279572) || cd_barra_roupa_p || chr(13) || chr(10),1,255);
end;

select	count(*)
into STRICT	qt_peca_lote_w
from	rop_movto_roupa b,
	rop_lote_movto a
where	a.nr_sequencia = b.nr_seq_lote
and	coalesce(a.dt_liberacao::text, '') = ''
and	b.nr_seq_roupa = nr_seq_roupa_w;

if (ie_geracao_p = 'A') and (substr(rop_obter_se_permite_local(nr_seq_local_atual_w, nr_seq_local_p),1,1) = 'N') then
	ds_erro_w := substr(ds_erro_w	|| WHEB_MENSAGEM_PCK.get_texto(279573) || ds_local_atual_w || WHEB_MENSAGEM_PCK.get_texto(279574) || ds_local_paramentro_w || '.' || chr(13) || chr(10)
					|| WHEB_MENSAGEM_PCK.get_texto(279575) || chr(13) || chr(10),1,255);
end if;

if (ie_situacao_w = 'I') then
	ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279576) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(279577) || cd_barra_roupa_p || chr(13) || chr(10),1,255);
end if;

if (dt_baixa_w IS NOT NULL AND dt_baixa_w::text <> '') then
	ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279576) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(279578) || cd_barra_roupa_p || chr(13) || chr(10),1,255);
end if;

if (nr_seq_local_atual_w IS NOT NULL AND nr_seq_local_atual_w::text <> '') and (nr_seq_local_p <> 0) and (ie_geracao_p = 'M') then
	if (ie_local_dif_lote_w = 'N') and (nr_seq_local_p <> nr_seq_local_atual_w) then
			ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279579) || ds_local_atual_w || WHEB_MENSAGEM_PCK.get_texto(279580) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(279600) || cd_barra_roupa_p || chr(13) || chr(10),1,255);
	end if;
elsif (coalesce(nr_seq_local_atual_w::text, '') = '') and (ie_operacao_w <> 'Reg') and (ie_operacao_w <> 'NF') and (ie_operacao_w <> 'AI') and (ie_operacao_w <> 'AM') then
	ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279601) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(279602) || cd_barra_roupa_p || chr(13) || chr(10),1,255);
end if;

if (ie_consiste_passagem_lav_w = 'S') and (ie_operacao_w = 'TS') and (ds_tipo_local_orig_dest_w = 'S') and (obter_se_roupa_passou_lavacao(nr_seq_roupa_w) = 'N') then
	ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279601) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(279603) || cd_barra_roupa_p || chr(13) || chr(10),1,255);
end if;

if (ie_operacao_w = 'Reg') then
	select	count(*)
	into STRICT	qt_existe_w
	from	rop_lote_movto a,
		rop_movto_roupa b
	where	a.nr_sequencia = b.nr_seq_lote
	and	a.cd_Estabelecimento = cd_estabelecimento_p
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	substr(rop_obter_dados_operacao(a.nr_seq_operacao, 'T'),1,15) = 'Reg'
	and	a.nr_seq_local = nr_seq_local_p
	and	b.nr_seq_roupa = nr_seq_roupa_w;

	if (qt_existe_w > 0) then
		ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279601) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(279605) || cd_barra_roupa_p || chr(13) || chr(10),1,255);
	end if;
end if;


if (qt_peca_lote_w > 0) then
	begin
	select	substr(obter_select_concatenado_bv('select a.nr_sequencia from rop_movto_roupa b, rop_lote_movto a
		where	a.nr_sequencia = b.nr_seq_lote and a.dt_liberacao is null and b.nr_seq_roupa = :nr_seq_roupa',
		'nr_seq_roupa=' || nr_seq_roupa_w, ','),1,255)
	into STRICT	ds_lotes_w
	;

	ds_erro_w := substr(ds_erro_w || WHEB_MENSAGEM_PCK.get_texto(279576) || cd_material_w || WHEB_MENSAGEM_PCK.get_texto(279606) || ds_lotes_w || WHEB_MENSAGEM_PCK.get_texto(279607) || cd_barra_roupa_p || chr(13) || chr(10),1,255);
	end;
end if;

ds_erro := ds_erro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rop_consiste_roupa ( nr_sequencia_p bigint, cd_barra_roupa_p text, nr_seq_local_p bigint, nr_seq_operacao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, ie_geracao_p text, ds_erro INOUT text) FROM PUBLIC;

