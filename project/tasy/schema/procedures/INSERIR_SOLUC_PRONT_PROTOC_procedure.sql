-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_soluc_pront_protoc ( nr_seq_paciente_p bigint, nr_seq_interno_p bigint, vol_total_p bigint default null, velo_infusao_p bigint default null, cd_via_administracao_p text default null, cd_intervalo_p text default null, cd_unidade_med_p text default null, nm_usuario_p text DEFAULT NULL, ds_dias_aplicacao_p text DEFAULT NULL, ds_ciclos_aplicacao_p text default null) AS $body$
DECLARE




nr_agrupamento_w	integer;
nr_seq_solucao_w	integer;
nr_seq_mat_w		bigint;


C04 CURSOR FOR
	SELECT 	nr_seq_paciente_p,
		B.NR_SEQ_MATERIAL,
		B.CD_MATERIAL,
		B.QT_DOSE,
		B.CD_UNIDADE_MEDIDA,
		coalesce(B.DS_DIAS_APLICACAO, A.DS_DIAS_APLICACAO) ds_dias_aplicacao,
		NM_USUARIO_P,
		B.NR_AGRUPAMENTO,
		B.DS_RECOMENDACAO,
		B.IE_VIA_APLICACAO,
		B.NR_SEQ_SOLUCAO,
		B.QT_MINUTO_APLICACAO,
		B.IE_BOMBA_INFUSAO,
		B.CD_INTERVALO,
		B.QT_HORA_APLICACAO,
		B.QT_DIAS_UTIL,
		B.IE_SE_NECESSARIO,
		B.IE_APLIC_LENTA,
		B.IE_URGENCIA,
		B.IE_APLIC_BOLUS,
		b.ie_pre_medicacao,
		coalesce(IE_APLICA_REDUCAO,'S') IE_APLICA_REDUCAO,
		b.ie_acm
	FROM 	PROTOCOLO_MEDIC_MATERIAL B,
		PROTOCOLO_MEDIC_SOLUCAO A
	WHERE 	a.nr_seq_interno = nr_seq_interno_p
	  AND 	A.CD_PROTOCOLO = B.CD_PROTOCOLO
	  AND 	A.NR_SEQUENCIA = B.NR_SEQUENCIA
	  AND 	B.NR_SEQ_SOLUCAO = A.NR_SEQ_SOLUCAO
	  and	(a.DS_DIAS_APLICACAO IS NOT NULL AND a.DS_DIAS_APLICACAO::text <> '')
	  AND	B.IE_AGRUPADOR IN (4);

c04_w c04%rowtype;



BEGIN

select  coalesce(max(nr_agrupamento),0) + 1,
		coalesce(max(nr_seq_solucao),0) + 1
into STRICT	nr_agrupamento_w,
		nr_seq_solucao_w
from 	PACIENTE_PROTOCOLO_SOLUC
where	nr_seq_paciente	= nr_seq_paciente_p;


insert into PACIENTE_PROTOCOLO_SOLUC(
		nr_seq_paciente,
		ds_dias_aplicacao,
		dt_atualizacao,
		nm_usuario,
		ie_via_aplicacao,
		ie_bomba_infusao,
		cd_intervalo,
		ie_pre_medicacao,
		ds_ciclos_aplicacao,
		nr_seq_solucao,
		qt_solucao_total,
		qt_dosagem,
		ie_tipo_dosagem,
		ie_esquema_alternado,
		ie_calc_aut,
		ie_acm,
		nr_agrupamento)
SELECT 	nr_seq_paciente_p,
		coalesce(ds_dias_aplicacao_p,ds_dias_aplicacao),
		clock_timestamp(),
		nm_usuario_p,
		coalesce(cd_via_administracao_p,ie_via_aplicacao),
		ie_bomba_infusao,
		coalesce(cd_intervalo_p,cd_intervalo),
		ie_pre_medicacao,
		coalesce(ds_ciclos_aplicacao_p,ds_ciclos_aplicacao),
		nr_seq_solucao_w,
		vol_total_p,
		velo_infusao_p,
		cd_unidade_med_p,
		ie_esquema_alternado,
		ie_calc_aut,
		ie_acm,
		nr_agrupamento_w
FROM 	PROTOCOLO_MEDIC_SOLUCAO
WHERE	nr_seq_interno = nr_seq_interno_p;

commit;

open C04;
loop
fetch C04 into
	c04_w;
EXIT WHEN NOT FOUND; /* apply on C04 */
	begin

	select	coalesce(max(NR_SEQ_MATERIAL),0) + 1
	into STRICT	nr_seq_mat_w
	from	PACIENTE_PROTOCOLO_MEDIC
	where	nr_seq_paciente = nr_seq_paciente_p;

		INSERT INTO PACIENTE_PROTOCOLO_MEDIC(
			NR_SEQ_PACIENTE,
			NR_SEQ_MATERIAL,
			CD_MATERIAL,
			qt_dose,
			CD_UNIDADE_MEDIDA,
			DS_DIAS_APLICACAO,
			DT_ATUALIZACAO,
			NM_USUARIO,
			NR_AGRUPAMENTO,
			DS_RECOMENDACAO,
			IE_VIA_APLICACAO,
			NR_SEQ_SOLUCAO,
			QT_MIN_APLICACAO,
			IE_BOMBA_INFUSAO,
			CD_INTERVALO,
			QT_HORA_APLICACAO,
			QT_DIAS_UTIL,
			NR_SEQ_INTERNO,
			IE_SE_NECESSARIO,
			IE_APLIC_LENTA,
			IE_URGENCIA,
			IE_APLIC_BOLUS,
			ie_pre_medicacao,
			IE_APLICA_REDUCAO,
			ie_acm)
		values (nr_seq_paciente_p,
			nr_seq_mat_w,
			c04_w.CD_MATERIAL,
			c04_w.QT_DOSE,
			c04_w.CD_UNIDADE_MEDIDA,
			c04_w.DS_DIAS_APLICACAO,--NVL(B.DS_DIAS_APLICACAO, A.DS_DIAS_APLICACAO),
			clock_timestamp(),
			NM_USUARIO_P,
			c04_w.NR_AGRUPAMENTO,
			c04_w.DS_RECOMENDACAO,
			c04_w.IE_VIA_APLICACAO,
			nr_seq_solucao_w,
			c04_w.QT_MINUTO_APLICACAO,
			c04_w.IE_BOMBA_INFUSAO,
			c04_w.CD_INTERVALO,
			c04_w.QT_HORA_APLICACAO,
			c04_w.QT_DIAS_UTIL,
			nextval('paciente_protocolo_medic_seq'),
			c04_w.IE_SE_NECESSARIO,
			c04_w.IE_APLIC_LENTA,
			c04_w.IE_URGENCIA,
			c04_w.IE_APLIC_BOLUS,
			c04_w.ie_pre_medicacao,
			coalesce(c04_w.IE_APLICA_REDUCAO,'S'),
			c04_w.ie_acm);

			commit;

	end;
end loop;
close C04;


end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_soluc_pront_protoc ( nr_seq_paciente_p bigint, nr_seq_interno_p bigint, vol_total_p bigint default null, velo_infusao_p bigint default null, cd_via_administracao_p text default null, cd_intervalo_p text default null, cd_unidade_med_p text default null, nm_usuario_p text DEFAULT NULL, ds_dias_aplicacao_p text DEFAULT NULL, ds_ciclos_aplicacao_p text default null) FROM PUBLIC;

