-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_wint_confirmacao_exame (nm_usuario_p wint_confirmacao_exame.nm_usuario%type, nr_interno_conta_p conta_paciente.nr_interno_conta%type, nr_seq_protocolo_p conta_paciente.nr_seq_protocolo%type, nr_seq_proc_paciente_p wint_confirmacao_exame.nr_seq_proc_paciente%type default null) AS $body$
DECLARE


nr_sequencia_w wint_confirmacao_exame.nr_sequencia%type;
nr_sequencia_proc_wint wint_confirmacao_exame.nr_sequencia%type;

c01 CURSOR FOR
SELECT 	pp.nr_sequencia nr_seq_proc,
        CASE WHEN p.cd_tipo_procedimento=20 THEN  'L'  ELSE 'E' END  ie_tipo_exame,
        cp.nr_interno_conta,
        pp.nr_doc_convenio,
        (select w.vl_campo from proc_paciente_tiss w where w.nr_seq_procedimento = pp.nr_sequencia and w.ds_campo = 'CD_PROC_TISS') cd_procedimento_tiss,
        pp.qt_procedimento,
        pp.dt_procedimento
FROM	procedimento_paciente pp,
        procedimento p,
        conta_paciente cp,
        protocolo_convenio pc,
        atendimento_paciente ap
where 	cp.nr_seq_protocolo = pc.nr_seq_protocolo
and	ap.nr_atendimento = cp.nr_atendimento
and 	pp.cd_procedimento  = p.cd_procedimento
and	pp.ie_origem_proced = p.ie_origem_proced
and	cp.nr_interno_conta = pp.nr_interno_conta
and 	ap.ie_tipo_atendimento <> 1
and 	((cp.nr_interno_conta = nr_interno_conta_p) or (cp.nr_seq_protocolo = nr_seq_protocolo_p) or (pp.nr_sequencia = nr_seq_proc_paciente_p))
order   by pp.nr_sequencia asc;

c01_w	c01%rowtype;


BEGIN

open c01;
loop
fetch c01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

        begin
        select  a.nr_sequencia
        into STRICT    nr_sequencia_proc_wint
        from    wint_confirmacao_exame a
        where   a.nr_seq_proc_paciente = c01_w.nr_seq_proc
        and     a.ie_status in ('E', 'S');
        exception
                when no_data_found then
                        nr_sequencia_proc_wint := null;
                when too_many_rows then
                        nr_sequencia_proc_wint := 0;
        end;

        if (coalesce(nr_sequencia_proc_wint::text, '') = '') then

                select  nextval('wint_confirmacao_exame_seq')
                into STRICT    nr_sequencia_w
;

                insert into wint_confirmacao_exame(
                        nr_sequencia,
                        dt_atualizacao,
                        nm_usuario,
                        dt_atualizacao_nrec,
                        nm_usuario_nrec,
                        cd_procedimento,
                        qt_procedimento,
                        dt_procedimento,
                        ie_status,
                        ie_tipo_exame,
                        nr_seq_proc_paciente)
                values (nr_sequencia_w,
                        clock_timestamp(),
                        nm_usuario_p,
                        clock_timestamp(),
                        nm_usuario_p,
                        c01_w.cd_procedimento_tiss,
                        c01_w.qt_procedimento,
                        c01_w.dt_procedimento,
                        'E',
                        c01_w.ie_tipo_exame,
                        c01_w.nr_seq_proc);

                insert into wint_conf_exame_insumo(
                        nr_sequencia,
                        dt_atualizacao,
                        nm_usuario,
                        dt_atualizacao_nrec,
                        nm_usuario_nrec,
                        dt_item,
                        cd_item,
                        ds_item,
                        qt_item,
                        nr_seq_wint_exame,
                        nr_seq_mat_atend_pac)
                SELECT	nextval('wint_conf_exame_insumo_seq'),
                        clock_timestamp(),
                        nm_usuario_p,
                        clock_timestamp(),
                        nm_usuario_p,                
                        p.dt_atendimento,
                        p.cd_material_tiss,
                        p.ds_material_tiss,
                        p.qt_material,
                        nr_sequencia_w,
                        p.nr_sequencia
                from	material_atend_paciente p
                where	p.nr_seq_proc_princ = c01_w.nr_seq_proc
                and	p.nr_interno_conta = c01_w.nr_interno_conta
                and	p.nr_doc_convenio = c01_w.nr_doc_convenio;

        end if;

end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_wint_confirmacao_exame (nm_usuario_p wint_confirmacao_exame.nm_usuario%type, nr_interno_conta_p conta_paciente.nr_interno_conta%type, nr_seq_protocolo_p conta_paciente.nr_seq_protocolo%type, nr_seq_proc_paciente_p wint_confirmacao_exame.nr_seq_proc_paciente%type default null) FROM PUBLIC;

