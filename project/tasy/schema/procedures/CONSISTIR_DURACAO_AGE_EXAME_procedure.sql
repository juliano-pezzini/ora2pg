-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_duracao_age_exame ( nr_minuto_duracao_p bigint, nr_minuto_dur_agendamento_p bigint, dt_agenda_p timestamp, cd_agenda_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_horario_p bigint default null) AS $body$
DECLARE


nr_minuto_duracao_w		bigint;
dt_inicial_w				timestamp;
dt_final_w				timestamp;
hr_final_turno_w		timestamp;
hr_incio_intervalo_w	timestamp;
hr_final_intervalo_w	timestamp;
dia_semana_w		smallint;
			

BEGIN
dt_inicial_w	:= dt_agenda_p;

if (coalesce(nr_minuto_duracao_p,0) = 0) or (coalesce(nr_minuto_duracao_p,0) < coalesce(nr_minuto_dur_agendamento_p,0))then
	dt_final_w	:= dt_agenda_p + nr_minuto_dur_agendamento_p/1440;
else	
	dt_final_w	:= dt_agenda_p + nr_minuto_duracao_p/1440;
end if;

select obter_cod_dia_semana(dt_inicial_w)
into STRICT dia_semana_w
;

--Validar horario final do turno
if (dt_final_w IS NOT NULL AND dt_final_w::text <> '') then		
	select	coalesce(max(to_date(to_char(dt_inicial_w,'dd/mm/yyyy') || ' ' || to_char(hr_final,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss')),dt_final_w),
			coalesce(max(to_date(to_char(dt_inicial_w,'dd/mm/yyyy') || ' ' || to_char(hr_inicial_intervalo,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss')),dt_final_w),
			coalesce(max(to_date(to_char(dt_inicial_w,'dd/mm/yyyy') || ' ' || to_char(hr_final_intervalo,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss')),dt_final_w)
	into STRICT	hr_final_turno_w,
			hr_incio_intervalo_w,
			hr_final_intervalo_w
	from	agenda_horario
	where	dt_inicial_w between coalesce(dt_inicio_vigencia, dt_inicial_w) and coalesce(dt_final_vigencia, dt_inicial_w)
	and		cd_agenda = cd_agenda_p
	and 	nr_sequencia = nr_seq_horario_p
	and		(((dt_dia_semana = 9) and (dia_semana_w not in (1,7)))
	or		(dt_dia_semana <> 9 AND dia_semana_w = dt_dia_semana)
	or (coalesce(dt_dia_semana::text, '') = ''));			
end if;

if (dt_final_w > hr_final_turno_w)then
	--A soma do horario selecionado e a duracao do item supera o final do turno! Parametro [295]
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(316837);
elsif (dt_inicial_w < hr_incio_intervalo_w and
		dt_final_w > hr_incio_intervalo_w) then
		-----------------------------------cadastrar nova mensagem para os intervalos
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(316837);
end if;

select	sum(coalesce(nr_minuto_duracao,0))
into STRICT	nr_minuto_duracao_w
from	agenda_paciente
where	cd_agenda = cd_agenda_p
and	hr_inicio between dt_agenda_p and hr_final_turno_w
and (coalesce(nm_paciente::text, '') = '' or hr_inicio = dt_agenda_p)
and	ie_status_agenda not in ('C','B','F');

if (coalesce(nr_minuto_duracao_w, 0) <> 0) and (coalesce(nr_minuto_duracao_w, 0) < nr_minuto_duracao_p) then
	--A soma do horario selecionado e a duracao do item supera o final do turno!
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(262563);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_duracao_age_exame ( nr_minuto_duracao_p bigint, nr_minuto_dur_agendamento_p bigint, dt_agenda_p timestamp, cd_agenda_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_horario_p bigint default null) FROM PUBLIC;

