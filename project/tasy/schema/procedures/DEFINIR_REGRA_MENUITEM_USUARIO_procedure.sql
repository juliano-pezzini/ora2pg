-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE definir_regra_menuitem_usuario (nr_seq_objeto_p bigint, ie_visivel_p text, nr_seq_apresent_p bigint, nm_usuario_p text, cd_perfil_p bigint default 0) AS $body$
DECLARE


    nr_seq_regra_w            bigint;
    ds_regra_visible_atual_w  varchar(1);
    nr_regra_apresent_atual_w bigint;
    nr_sequencia_rem_w        bigint;


BEGIN
    select coalesce(max(nr_sequencia), 0)
      into STRICT nr_seq_regra_w
      from funcao_popup_regra
     where nr_seq_objeto = nr_seq_objeto_p
       and coalesce(cd_estabelecimento::text, '') = ''
       and coalesce(cd_perfil::text, '') = ''
       and ie_tipo_regra = 'E'
       and nm_usuario_regra = nm_usuario_p;

    ds_regra_visible_atual_w  := obter_regra_funcao_popup(nr_seq_objeto_p, 'IE_VISIBLE', cd_perfil_p);
    nr_regra_apresent_atual_w := obter_regra_funcao_popup(nr_seq_objeto_p, 'NR_SEQ_APRESENT', cd_perfil_p);

    if (nr_seq_regra_w = 0) and
       ((ie_visivel_p <> ds_regra_visible_atual_w) or (nr_seq_apresent_p <> nr_regra_apresent_atual_w)) then

        $if $$tasy_local_dict=true $then
        nr_sequencia_rem_w := get_remote_sequence('seq:funcao_popup_regra_seq');
        $else
        select nextval('funcao_popup_regra_seq') into STRICT nr_sequencia_rem_w;
        $end

        insert into funcao_popup_regra(nr_sequencia,
             cd_estabelecimento,
             dt_atualizacao,
             nm_usuario,
             dt_atualizacao_nrec,
             nm_usuario_nrec,
             nm_usuario_regra,
             cd_perfil,
             nr_seq_objeto,
             ie_tipo_regra,
             ie_enable,
             ie_visible,
             nr_seq_apresent)
        values (nr_sequencia_rem_w, --funcao_popup_regra_seq.nextval,
             null,
             clock_timestamp(),
             nm_usuario_p,
             clock_timestamp(),
             nm_usuario_p,
             nm_usuario_p,
             null,
             nr_seq_objeto_p,
             'E',
             'S',
             ie_visivel_p,
             nr_seq_apresent_p);
    else
        update funcao_popup_regra
           set ie_visible      = ie_visivel_p,
               nr_seq_apresent = nr_seq_apresent_p
         where nr_sequencia = nr_seq_regra_w;

    end if;

    commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE definir_regra_menuitem_usuario (nr_seq_objeto_p bigint, ie_visivel_p text, nr_seq_apresent_p bigint, nm_usuario_p text, cd_perfil_p bigint default 0) FROM PUBLIC;

