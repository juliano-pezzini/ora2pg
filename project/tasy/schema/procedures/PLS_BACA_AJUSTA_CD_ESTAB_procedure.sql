-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_baca_ajusta_cd_estab () AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:
Inserir o cd_estabelimento nas tabelas de regras da OPS - Cadastro de Regras / OPS - Atendimento.
Ajuste necessário para os registros que foram criados antes da criação do campo cd_estabelecimento
nas tabelas.
-------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [ ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
qt_operadoras_w			bigint;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
ds_update_w			varchar(4000)		:= null;
nm_usuario_w			usuario.nm_usuario%type	:= 'TASY_OPS';
c001_w	  			integer;
retorno_w			integer	:= 0;

C01 CURSOR FOR
	SELECT	a.nm_tabela
	from  	tabela_atributo a,
		tabela_sistema b
	where 	a.nm_tabela = b.nm_tabela
	and     a.nm_tabela 	in (	'PLS_ASSINATURA_EMAIL_WEB', 'PLS_REGRA_LIBERACAO', 'PLS_LIB_GRUPO_AUDITOR',
					'PLS_GRUPO_AUDITOR', 'PLS_MEMBRO_GRUPO_AUD', 'PLS_REGRA_BLOQ_JUST_AUT',
					'PLS_REGRA_CAD_MAT_INPART', 'PLS_REGRA_EXIGE_OBS_AUD', 'PLS_REGRA_EXIGE_OBS_ITEM',
					'PLS_REGRA_NOTIFICACAO_AUT', 'PLS_EXCECAO_REG_NOTIF_AUT', 'PLS_REGRA_GLOSA_ACOM',
					'PLS_GLOSA_PROC_ACOM', 'PLS_TIPO_POS_ESTABELECIDO', 'PLS_TIPO_POS_ESTAB_PROC',
					'PLS_REGRA_AUDITORIA_ESTIP', 'PLS_AUTORIZACAO_EMAIL', 'PLS_REGRA_AUT_EMAIL',
					'PLS_CONVERSAO_TABELA_TISS', 'PLS_REGRA_COPARTIC_AUT', 'PLS_PCMSO_ESTRUTURA',
					'PLS_PCMSO_ITEM_ESTRUT', 'PLS_BLOQUEIO_SOLIC_MAT_MED', 'PLS_CAD_CONTROLE_INTERNO',
					'PLS_CONTROLE_INTERNO_ITENS', 'PLS_REGRA_GERAR_GUIA', 'PLS_REGRA_GUIA_CAMPO',
					'PLS_LIB_PREST_SOLIC_MAT', 'PLS_REGRA_COMPL_GUIA_WEB', 'PLS_REGRA_GUIA_DUPLICADA',
					'PLS_REGRA_EXIGE_CID_AUT', 'PLS_REGRA_BLOQ_BENEF_WEB', 'PLS_CONG_COOP_BLOQ_WEB',
					'PLS_REGRA_PLANO_BENEF_WEB', 'PLS_REGRA_BLOQ_MATRICULA', 'PLS_REGRA_LIB_AUT_ORIGEM',
					'PLS_EXCECAO_LIB_INTER', 'PLS_REGRA_NEG_AUT_ORIGEM', 'PLS_GLOSA_REG_NEG_AUT_ORIG',
					'PLS_REGRA_LIB_AUT_ORIGEM', 'PLS_COMUNICA_INTER_PREST', 'PLS_REGRA_PRAZO_AUDITORIA',
					'PLS_REGRA_ALT_AUD_ESTIP', 'PLS_REGRA_CAD_BIOMETRIA', 'PLS_REGRA_COB_PREVIA_SERV',
					'PLS_REGRA_COMPL_ANEXO_OPME', 'PLS_REGRA_PREST_ANEXO_OPME', 'PLS_ATEND_COMUNIC_INTERNA',
					'PLS_AUT_REGRA_GERA_SENHA', 'PLS_AUT_GERA_SENHA_CAMPO', 'PLS_REGRA_JUST_AUTOMATICA',
					'PLS_OCORRENCIA_JUST_AUT', 'PLS_REGRA_VAL_ELEG', 'PLS_REGRA_VAL_PREST_ELEG',
					'PLS_REGRA_BIOMETRIA_PREST', 'PLS_PREST_EXIGE_BIOMETRIA', 'PLS_REGRA_ARQUIVO_ATEND',
					'PLS_REGRA_DIRETORIO_WEB', 'PLS_REGRA_MENSAGEM_GUIA', 'PLS_REGRA_PREST_JUSTIF',
					'PLS_REGRA_ANEXO_GUIA', 'PLS_REGRA_ANEXO_GUIA_ITENS', 'PLS_REGRA_OBSERV_INTERC',
					'PLS_REGRA_SENHA_LOGIN_WEB', 'PLS_REGRA_INFORM_MAT', 'PLS_REGRA_ENTREGA_MAT_MED',
					'PLS_REGRA_MAT_ENTREGA', 'PLS_PERM_PREST_MAT_MED', 'PLS_PERMISSAO_SOL_MAT_MED',
					'PLS_REGRA_VALIDADE_AUT', 'PLS_GRUPO_REGRA_EXEC_REQ', 'PLS_REGRA_EXEC_REQUISICAO',
					'PLS_BLOQUEIO_EXECUCAO_REQ', 'PLS_REGRA_EXECUCAO_TOTAL', 'PLS_REGRA_SENHA_ESTIP',
					'PLS_REGRA_ATEND_REQ_WEB', 'PLS_LISTA_BLOQUEIO_FONE', 'PLS_REQUISICAO_QTDE_PROC',
					'PLS_REGRA_BLOQ_ATRIBUTO', 'PLS_REGRA_BLOQUEIO_FUNCAO', 'PLS_EXCECAO_BLOQ_FUNCAO',
					'PLS_REGRA_CANCEL_AUT_REQ', 'PLS_REGRA_PREST_PREVISTO')
	and	upper(a.nm_atributo)	= 'CD_ESTABELECIMENTO'
	and 	a.nm_usuario		= 'djavan';

BEGIN

select	count(1)
into STRICT	qt_operadoras_w
from	pls_outorgante;

if (qt_operadoras_w = 1) then
	select	cd_estabelecimento
	into STRICT	cd_estabelecimento_w
	from	pls_outorgante;

	for C01_w in C01 loop
		begin
			ds_update_w	:=	' update ' || C01_w.nm_tabela ||
						' set	cd_estabelecimento = ' || chr(39) || cd_estabelecimento_w || chr(39) || ',' ||
						'	nm_usuario = ' || chr(39) || nm_usuario_w || chr(39) || ',' ||
						'	dt_atualizacao = sysdate ' ||
						' where	cd_estabelecimento is null ';

			begin
				c001_w := DBMS_SQL.OPEN_CURSOR;
				DBMS_SQL.PARSE(c001_w, ds_update_w, dbms_sql.Native);
				retorno_w := retorno_w + DBMS_SQL.execute(c001_w);
				DBMS_SQL.CLOSE_CURSOR(c001_w);
			exception
			when others then
				DBMS_SQL.CLOSE_CURSOR(c001_w);
			end;
		end;
	end loop;
	CALL pls_geracao_log_temporario(null, 'PLS_BACA_AJUSTA_CD_ESTAB - atualizados: '|| retorno_w,nm_usuario_w);
	commit;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_baca_ajusta_cd_estab () FROM PUBLIC;

