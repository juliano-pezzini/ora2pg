-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_inserir_propaci ( nr_atendimento_p bigint, nr_prescricao_p bigint, cd_exame_p text, dt_exame_p timestamp, qt_procedimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
cd_cgc_prestador_w	varchar(14);
cd_estabelecimento_w	integer;
ie_tipo_atendimento_w	integer;

cd_convenio_w		integer;
cd_categoria_w		varchar(10);
ie_tipo_convenio_w		smallint;
nr_doc_convenio_w	varchar(20);

nr_seq_atepacu_w		bigint;
dt_ent_unidade_w		timestamp;
cd_setor_atendimento_w	integer;

nr_seq_exame_w		bigint;

cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
ds_erro_w		varchar(255);

ie_medico_executor_w	varchar(30);
cd_cgc_consisitdo_w	varchar(14);
cd_medico_regra_w	varchar(10);
cd_profissional_w		varchar(10);

nr_sequencia_w		bigint;

nr_seq_classificacao_w	bigint;
nr_seq_proc_interno_aux_w	bigint;
cd_plano_convenio_w		varchar(10);


BEGIN 
 
select	a.cd_cgc, 
	a.cd_estabelecimento, 
	b.ie_tipo_atendimento, 
	nr_seq_classificacao 
into STRICT	cd_cgc_prestador_w, 
	cd_estabelecimento_w, 
	ie_tipo_atendimento_w, 
	nr_seq_classificacao_w 
from	estabelecimento a, 
	atendimento_paciente b 
where	a.cd_estabelecimento = b.cd_estabelecimento 
and	b.nr_atendimento = nr_atendimento_p;
 
select	cd_convenio, 
	cd_categoria, 
	ie_tipo_convenio, 
	nr_doc_convenio, 
	cd_plano_convenio 
into STRICT	cd_convenio_w, 
	cd_categoria_w, 
	ie_tipo_convenio_w, 
	nr_doc_convenio_w, 
	cd_plano_convenio_w 
from	atendimento_paciente_v 
where	nr_atendimento = nr_atendimento_p;
 
select	nr_seq_exame 
into STRICT	nr_seq_exame_w 
from exame_laboratorio 
where cd_exame = cd_exame_p;
 
SELECT * FROM obter_exame_lab_convenio(nr_seq_exame_w, cd_convenio_w, cd_categoria_w, ie_tipo_atendimento_w, cd_estabelecimento_w, ie_tipo_convenio_w, null, null, cd_plano_convenio_w, cd_setor_atendimento_w, cd_procedimento_w, ie_origem_proced_w, ds_erro_w, nr_seq_proc_interno_aux_w) INTO STRICT cd_setor_atendimento_w, cd_procedimento_w, ie_origem_proced_w, ds_erro_w, nr_seq_proc_interno_aux_w;
 
nr_seq_atepacu_w := obter_atepacu_paciente(nr_atendimento_p, 'A');
 
select	dt_entrada_unidade, 
	cd_setor_atendimento 
into STRICT	dt_ent_unidade_w, 
	cd_setor_atendimento_w 
from	atend_paciente_unidade 
where	nr_seq_interno = nr_seq_atepacu_w;
 
SELECT * FROM consiste_medico_executor(cd_estabelecimento_w, cd_convenio_w, cd_setor_atendimento_w, cd_procedimento_w, ie_origem_proced_w, ie_tipo_atendimento_w, nr_seq_exame_w, null, ie_medico_executor_w, cd_cgc_consisitdo_w, cd_medico_regra_w, cd_profissional_w, null, coalesce(dt_exame_p,dt_ent_unidade_w), nr_seq_classificacao_w, 'N', null, null) INTO STRICT ie_medico_executor_w, cd_cgc_consisitdo_w, cd_medico_regra_w, cd_profissional_w;
 
select nextval('procedimento_paciente_seq') 
into STRICT nr_sequencia_w
;
 
insert into procedimento_paciente(nr_sequencia, 
	nr_atendimento, 
	dt_entrada_unidade, 
	cd_procedimento, 
	dt_procedimento, 
	qt_procedimento, 
	dt_atualizacao, 
	nm_usuario, 
	cd_convenio, 
	cd_categoria, 
	cd_acao, 
	cd_setor_atendimento, 
	ie_origem_proced, 
	tx_procedimento, 
	nm_usuario_original, 
	nr_seq_atepacu, 
	ie_auditoria, 
	cd_cgc_prestador, 
	cd_medico_executor, 
	nr_doc_convenio, 
	cd_pessoa_fisica) 
values (nr_sequencia_w, 
	nr_atendimento_p, 
	dt_ent_unidade_w, 
	cd_procedimento_w, 
	coalesce(dt_exame_p,dt_ent_unidade_w), 
	qt_procedimento_p, 
	clock_timestamp(), 
	coalesce(nm_usuario_p, 'Interface'), 
	cd_convenio_w, 
	cd_categoria_w, 
	qt_procedimento_p, 
	cd_setor_atendimento_w, 
	ie_origem_proced_w, 
	100, 
	nm_usuario_p, 
	nr_seq_atepacu_w, 
	'N', 
	coalesce(cd_cgc_consisitdo_w, cd_cgc_prestador_w), 
	cd_medico_regra_w, 
	nr_doc_convenio_w, 
	cd_profissional_w);
 
ds_erro_w := consiste_exec_procedimento(nr_sequencia_w, ds_erro_w);
CALL atualiza_preco_procedimento(nr_sequencia_w, cd_convenio_w, coalesce(nm_usuario_p, 'Interface'));
 
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_inserir_propaci ( nr_atendimento_p bigint, nr_prescricao_p bigint, cd_exame_p text, dt_exame_p timestamp, qt_procedimento_p bigint, nm_usuario_p text) FROM PUBLIC;

