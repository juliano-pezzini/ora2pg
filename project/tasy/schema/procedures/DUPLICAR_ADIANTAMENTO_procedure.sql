-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicar_adiantamento ( nr_adiantamento_p bigint, nr_cheque_novo_p text, nr_cheque_antigo_p text, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_adiantamento_w	bigint;


BEGIN

select	nextval('adiantamento_seq')
into STRICT	nr_adiantamento_w
;

insert into adiantamento(nr_adiantamento,
	cd_agencia_bancaria,
	cd_banco, cd_cgc,
	cd_cgc_emp_cred,
	cd_estabelecimento,
	cd_moeda,
	cd_pessoa_fisica,
	cd_tipo_recebimento,
	ds_observacao,
	dt_adiantamento,
	dt_atualizacao,
	dt_baixa,
	dt_contabil,
	ie_situacao,
	nm_usuario,
	nr_atendimento,
	nr_cartao_cred,
	nr_documento_cred,
	nr_lote_contabil,
	nr_recibo,
	nr_seq_trans_fin,
	vl_adiantamento,
	vl_especie,
	vl_saldo,
	vl_adto_estrang,
	vl_saldo_estrang,
	vl_complemento,
	vl_cotacao)
SELECT	nr_adiantamento_w,
	cd_agencia_bancaria,
	cd_banco,
	cd_cgc,
	cd_cgc_emp_cred,
	cd_estabelecimento,
	cd_moeda,
	cd_pessoa_fisica,
	cd_tipo_recebimento,
	substr(ds_observacao,1,255),
	dt_adiantamento,
	clock_timestamp(),
	null,
	dt_contabil,
	ie_situacao,
	nm_usuario_p,
	nr_atendimento,
	nr_cartao_cred,
	nr_documento_cred,
	nr_lote_contabil,
	nr_recibo,
	nr_seq_trans_fin,
	vl_adiantamento,
	vl_especie,
	vl_saldo,
	CASE WHEN coalesce(vl_cotacao,0)=0 THEN null  ELSE vl_adto_estrang END ,  -- Projeto Multimoeda - Retorna os valores em moeda estrangeira quando adiantamento em moeda estrangeira
	CASE WHEN coalesce(vl_cotacao,0)=0 THEN null  ELSE vl_saldo_estrang END ,
	CASE WHEN coalesce(vl_cotacao,0)=0 THEN null  ELSE vl_complemento END ,
	CASE WHEN coalesce(vl_cotacao,0)=0 THEN null  ELSE vl_cotacao END
from	adiantamento
where	nr_adiantamento	= nr_adiantamento_p;

if (nr_cheque_antigo_p IS NOT NULL AND nr_cheque_antigo_p::text <> '') then

	insert into cheque_cr(cd_agencia_bancaria,
		cd_banco,
		cd_cgc,
		cd_estabelecimento,
		cd_moeda,
		cd_motivo_devolucao,
		cd_pessoa_fisica,
		cd_portador,
		cd_tipo_portador,
		ds_observacao,
		dt_atualizacao,
		dt_contabil,
		dt_deposito,
		dt_devolucao,
		dt_devolucao_banco,
		dt_reapresentacao,
		dt_registro,
		dt_seg_devolucao,
		dt_vencimento,
		dt_venda_terc,
		ie_origem_cheque,
		nm_usuario,
		nm_usuario_devolucao,
		nr_adiantamento,
		nr_cheque,
		nr_conta,
		nr_seq_cheque,
		nr_seq_lote,
		nr_seq_saldo_caixa,
		nr_titulo,
		vl_cheque,
		vl_terceiro,
		ie_lib_caixa,
		tx_juros_cobranca,
		tx_multa_cobranca,
		cd_tipo_taxa_juros,
		cd_tipo_taxa_multa,
		vl_cheque_estrang,
		vl_complemento,
		vl_cotacao)
	SELECT	cd_agencia_bancaria,
		cd_banco,
		cd_cgc,
		cd_estabelecimento,
		cd_moeda,
		cd_motivo_devolucao,
		cd_pessoa_fisica,
		cd_portador,
		cd_tipo_portador,
		substr(ds_observacao,1,255),
		clock_timestamp(),
		dt_contabil,
		null,
		dt_devolucao,
		dt_devolucao_banco,
		dt_reapresentacao,
		dt_registro,
		dt_seg_devolucao,
		dt_vencimento,
		dt_venda_terc,
		ie_origem_cheque,
		nm_usuario_p,
		nm_usuario_devolucao,
		nr_adiantamento_w,
		coalesce(nr_cheque_novo_p,'0'),
		nr_conta,
		nextval('cheque_cr_seq'),
		nr_seq_lote,
		nr_seq_saldo_caixa,
		nr_titulo,
		0,
		0,
		'S',
		tx_juros_cobranca,
		tx_multa_cobranca,
		cd_tipo_taxa_juros,
		cd_tipo_taxa_multa,
		CASE WHEN coalesce(vl_cheque_estrang,0)=0 THEN null  ELSE vl_cheque_estrang END ,  -- Projeto Multimoeda - Retorna os valores em moeda estrangeira quando cheque em moeda estrangeira
		CASE WHEN coalesce(vl_cheque_estrang,0)=0 THEN null  ELSE vl_complemento END ,
		CASE WHEN coalesce(vl_cheque_estrang,0)=0 THEN null  ELSE vl_cotacao END
	from	cheque_cr
	where	nr_cheque	= nr_cheque_antigo_p
	and	nr_adiantamento	= nr_adiantamento_p;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_adiantamento ( nr_adiantamento_p bigint, nr_cheque_novo_p text, nr_cheque_antigo_p text, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

