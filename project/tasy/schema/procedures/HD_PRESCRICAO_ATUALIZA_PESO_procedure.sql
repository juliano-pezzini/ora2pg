-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hd_prescricao_atualiza_peso (CD_PESSOA_FISICA_P PESSOA_FISICA.CD_PESSOA_FISICA%TYPE, QT_PESO_PRE_P HD_DIALISE.QT_PESO_PRE%TYPE) AS $body$
DECLARE

                                      
                                      
nr_prescricao_w 		HD_ALTERACAO_PESO_LOG.NR_PRESCRICAO%type;
ie_prescricao_vigente_w 	HD_PRESCRICAO.NR_SEQUENCIA%type;


BEGIN

    nr_prescricao_w := HD_OBTER_ULTIMA_PRESCR(CD_PESSOA_FISICA_P, OBTER_ESTABELECIMENTO_ATIVO);

    IF (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') THEN
        SELECT 	MAX(a.NR_SEQUENCIA)
        INTO STRICT 	ie_prescricao_vigente_w
        FROM	HD_PRESCRICAO a,
            CPOE_DIALISE b
        WHERE	a.NR_SEQ_DIALISE_CPOE = b.NR_SEQUENCIA
        AND	coalesce(b.DT_SUSPENSAO::text, '') = ''
        AND 	a.NR_PRESCRICAO = nr_prescricao_w
        ORDER BY a.NR_SEQUENCIA DESC;
    END IF;

    IF (ie_prescricao_vigente_w IS NOT NULL AND ie_prescricao_vigente_w::text <> '') THEN
        UPDATE HD_PRESCRICAO
        SET    QT_PESO_ATUAL = coalesce(QT_PESO_PRE_P,0)
        WHERE  NR_PRESCRICAO = nr_prescricao_w;
    END IF;
COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hd_prescricao_atualiza_peso (CD_PESSOA_FISICA_P PESSOA_FISICA.CD_PESSOA_FISICA%TYPE, QT_PESO_PRE_P HD_DIALISE.QT_PESO_PRE%TYPE) FROM PUBLIC;

