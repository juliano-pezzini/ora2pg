-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_efd_automatizar ( nr_seq_tipo_ct_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_conta_contabil_w		fis_efd_conta_contabil.cd_conta_contabil%type;
cd_tipo_det_i200_w		fis_efd_conta_contabil.cd_tipo_detalhamento%type;
cd_tipo_det_i300_w		fis_efd_conta_contabil.cd_tipo_detalhamento%type;
cd_empresa_w			fis_efd_conta_contabil.cd_empresa%type;
cd_estabelecimento_w		fis_efd_conta_contabil.cd_estabelecimento%type;
ie_tipo_valor_w			fis_efd_conta_contabil.ie_tipo_valor%type;
ie_tributacao_cst_w		fis_efd_conta_contabil.ie_tributacao_cst%type;
nr_seq_i100_w			fis_efd_conta_contabil.nr_sequencia%type;
nr_seq_i200_w			fis_efd_conta_contabil.nr_sequencia%type;
nr_seq_i300_w			fis_efd_conta_contabil.nr_sequencia%type;

c01 CURSOR FOR
	SELECT	distinct ie_tributacao_cst, cd_estabelecimento, cd_empresa
	from	fis_efd_conta_contabil
	where	nr_seq_tipo_ct = nr_seq_tipo_ct_p
	and	ie_automatizacao = 'S';

c02 CURSOR FOR
	SELECT	distinct substr(cd_tipo_detalhamento,1,5)
	from	fis_efd_conta_contabil
	where	nr_seq_tipo_ct = nr_seq_tipo_ct_p
	and	ie_tributacao_cst = ie_tributacao_cst_w  -- cursor c01
	and	cd_estabelecimento = cd_estabelecimento_w  -- cursor c01
	and	cd_empresa = cd_empresa_w  -- cursor c01
	and	ie_automatizacao = 'S';

c03 CURSOR FOR
	SELECT	cd_conta_contabil, cd_tipo_detalhamento, ie_tipo_valor
	from	fis_efd_conta_contabil
	where	nr_seq_tipo_ct = nr_seq_tipo_ct_p
	and	ie_tributacao_cst = ie_tributacao_cst_w  --cursor c01
	and	cd_estabelecimento = cd_estabelecimento_w  -- cursor c01
	and	cd_empresa = cd_empresa_w  --cursor c01
	and	substr(cd_tipo_detalhamento,1,5) = cd_tipo_det_i200_w  --cursor c02
	and	ie_automatizacao = 'S';


BEGIN

delete
from 	fis_efd_conta_contabil a
where 	a.nr_seq_tipo_ct	= nr_seq_tipo_ct_p
and 	a.ie_automatizacao 	= 'N';

open C01;
loop
fetch C01 into
	ie_tributacao_cst_w,
	cd_estabelecimento_w,
	cd_empresa_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	nextval('fis_efd_conta_contabil_seq')
	into STRICT	nr_seq_i100_w
	;

	insert	into fis_efd_conta_contabil(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_tipo_ct,
		ie_tributacao_cst,
		cd_estabelecimento,
		cd_empresa,
		ie_automatizacao)
	values (	nr_seq_i100_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_tipo_ct_p,
		ie_tributacao_cst_w,
		cd_estabelecimento_w,
		cd_empresa_w,
		'N');
	commit;

	open c02;
	loop
	fetch c02 into
		cd_tipo_det_i200_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin

		select	nextval('fis_efd_conta_contabil_seq')
		into STRICT	nr_seq_i200_w
		;

		insert	into fis_efd_conta_contabil(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_tipo_ct,
			cd_estabelecimento,
			cd_empresa,
			ie_automatizacao,
			cd_tipo_detalhamento,
			nr_seq_superior)
		values (	nr_seq_i200_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_tipo_ct_p,
			cd_estabelecimento_w,
			cd_empresa_w,
			'N',
			cd_tipo_det_i200_w,
			nr_seq_i100_w);

		commit;

		open c03;
		loop
		fetch c03 into
			cd_conta_contabil_w,
			cd_tipo_det_i300_w,
			ie_tipo_valor_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
			begin

			select	nextval('fis_efd_conta_contabil_seq')
			into STRICT	nr_seq_i300_w
			;

			insert	into fis_efd_conta_contabil(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_tipo_ct,
				cd_estabelecimento,
				cd_empresa,
				ie_automatizacao,
				cd_tipo_detalhamento,
				nr_seq_superior,
				cd_conta_contabil,
				ie_tipo_valor)
			values (	nr_seq_i300_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_tipo_ct_p,
				cd_estabelecimento_w,
				cd_empresa_w,
				'N',
				cd_tipo_det_i300_w,
				nr_seq_i200_w,
				cd_conta_contabil_w,
				ie_tipo_valor_w);

			commit;
			end;
		end loop;
		close c03;

		end;
	end loop;
	close c02;

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_efd_automatizar ( nr_seq_tipo_ct_p bigint, nm_usuario_p text) FROM PUBLIC;

