-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE html_create_rule_schem_order ( nr_seq_lote_p bigint, nr_seq_regra_acao_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
vl_parametro_de_w			html_param_to_rule.vl_parametro%type;
nr_seq_parametro_w			html_param_to_rule.nr_seq_parametro%type;
cd_funcao_w					html_param_to_rule.cd_funcao%type;

nr_seq_rule_w				html_param_to_rule.nr_sequencia%type;	
nr_seq_obj_schematic_w		html_param_to_rule_action.nr_seq_obj_schematic%type;
nr_seq_obj_sup_w			objeto_schematic.nr_seq_obj_sup%type;
ds_regra_w			obj_schem_order.ds_regra%type;
	
nr_seq_regra_tab_inicial_w	obj_schem_order.nr_sequencia%type;
vl_parametro_w				funcao_parametro.vl_parametro%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
cd_perfil_w					perfil.cd_perfil%type;
nm_usuario_param_w			usuario.nm_usuario%type;

c10 CURSOR FOR 
SELECT	cd_estabelecimento 
from	funcao_param_estab 
where	cd_funcao = cd_funcao_w 
and		nr_seq_param = nr_seq_parametro_w 
and		vl_parametro = vl_parametro_de_w;

c11 CURSOR FOR 
SELECT	cd_perfil 
from	funcao_param_perfil 
where	cd_funcao = cd_funcao_w 
and		nr_sequencia = nr_seq_parametro_w 
and		vl_parametro = vl_parametro_de_w;

c12 CURSOR FOR 
SELECT	nm_usuario_param 
from	funcao_param_usuario 
where	cd_funcao = cd_funcao_w 
and		nr_sequencia = nr_seq_parametro_w 
and		vl_parametro = vl_parametro_de_w;


BEGIN 
 
select	nr_seq_obj_schematic, 
		nr_seq_rule 
into STRICT	nr_seq_obj_schematic_w, 
		nr_seq_rule_w 
from	html_param_to_rule_action 
where	nr_sequencia = nr_seq_regra_acao_p;
 
select	cd_funcao, 
		nr_seq_parametro, 
		vl_parametro, 
		substr((obter_desc_expressao(295274,'Par√¢metro') || ' ' || to_char(nr_seq_parametro)),1,255) 
into STRICT	cd_funcao_w, 
		nr_seq_parametro_w, 
		vl_parametro_de_w, 
		ds_regra_w 
from	html_param_to_rule 
where	nr_sequencia = nr_seq_rule_w;
 
select	coalesce(nr_seq_obj_sup,0) 
into STRICT	nr_seq_obj_sup_w 
from	objeto_schematic 
where	nr_sequencia = nr_seq_obj_schematic_w;
 
select	vl_parametro 
into STRICT	vl_parametro_w 
from	funcao_parametro 
where	cd_funcao = cd_funcao_w 
and		nr_sequencia = nr_seq_parametro_w;
 
/* INSERIR REGRA GERAL */
 
/* 
Inicializar a variavel sempre antes de um novo nivel (estabelecimento, perfil,usuario) 
para criar nova regra especifica para aquele nivel e nao uma nova para cada parametrizacao feita 
*/
 
nr_seq_regra_tab_inicial_w := 0;
if (vl_parametro_w = vl_parametro_de_w) then 
	nr_seq_regra_tab_inicial_w := INSERT_RULE_SCHEM_ORDER( 
				nr_seq_lote_p, cd_funcao_w, nr_seq_parametro_w, vl_parametro_de_w, null, null, null, nr_seq_obj_sup_w, nr_seq_obj_schematic_w, ds_regra_w, nm_usuario_p, nr_seq_regra_tab_inicial_w);						
end if;
 
/* INSERIR REGRA POR ESTABELECIMENTO*/
 
nr_seq_regra_tab_inicial_w := 0;
open c10;
loop 
fetch c10 into 
		cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on c10 */
		begin 
		 
		nr_seq_regra_tab_inicial_w := INSERT_RULE_SCHEM_ORDER( 
				nr_seq_lote_p, cd_funcao_w, nr_seq_parametro_w, vl_parametro_de_w, cd_estabelecimento_w, null, null, nr_seq_obj_sup_w, nr_seq_obj_schematic_w, ds_regra_w, nm_usuario_p, nr_seq_regra_tab_inicial_w);
				 
		end;
end loop;
close c10;
 
/* INSERIR REGRA POR PERFIL*/
 
nr_seq_regra_tab_inicial_w := 0;
open c11;
loop 
fetch c11 into 
		cd_perfil_w;
EXIT WHEN NOT FOUND; /* apply on c11 */
		begin 
		 
		nr_seq_regra_tab_inicial_w := INSERT_RULE_SCHEM_ORDER( 
				nr_seq_lote_p, cd_funcao_w, nr_seq_parametro_w, vl_parametro_de_w, null, cd_perfil_w, null, nr_seq_obj_sup_w, nr_seq_obj_schematic_w, ds_regra_w, nm_usuario_p, nr_seq_regra_tab_inicial_w);
				 
		end;
end loop;
close c11;
 
/* INSERIR REGRA POR USUARIO*/
 
nr_seq_regra_tab_inicial_w := 0;
open c12;
loop 
fetch c12 into 
		nm_usuario_param_w;
EXIT WHEN NOT FOUND; /* apply on c12 */
		begin 
		 
		nr_seq_regra_tab_inicial_w := INSERT_RULE_SCHEM_ORDER( 
				nr_seq_lote_p, cd_funcao_w, nr_seq_parametro_w, vl_parametro_de_w, null, null, nm_usuario_param_w, nr_seq_obj_sup_w, nr_seq_obj_schematic_w, ds_regra_w, nm_usuario_p, nr_seq_regra_tab_inicial_w);
				 
		end;
end loop;
close c12;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE html_create_rule_schem_order ( nr_seq_lote_p bigint, nr_seq_regra_acao_p bigint, nm_usuario_p text) FROM PUBLIC;

