-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_salvar_prestador_web ( nm_pessoa_fisica_p pessoa_fisica.nm_pessoa_fisica%type, nr_seq_conselho_p pessoa_fisica.nr_seq_conselho%type, nr_crm_p medico.nr_crm%type, uf_crm_p medico.uf_crm%type, nm_usuario_p text, nr_cpf_p pessoa_fisica.nr_cpf%type, dt_nascimento_p text, cd_estabelecimento_p bigint, nr_seq_cbo_p pessoa_fisica.nr_seq_cbo_saude%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, cd_medico_p INOUT pessoa_fisica.cd_pessoa_fisica%type) AS $body$
DECLARE

					 
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade: 
Salvar médico na relação de profissionais do prestador 
------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[ ] Objetos do dicionário [ ] Tasy (Delphi/Java) [ x ] Portal [ ] Relatórios [ ] Outros: 
 ------------------------------------------------------------------------------------------------------------------ 
Pontos de atenção: 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 
 
cd_medico_w		pessoa_fisica.cd_pessoa_fisica%type;	
cd_pessoa_fisica_w	pls_prestador.cd_pessoa_fisica%type;
cd_cgc_w		pls_prestador.cd_cgc%type;


BEGIN 
 
if (nr_seq_prestador_p IS NOT NULL AND nr_seq_prestador_p::text <> '') then 
	 
	cd_medico_w := cd_medico_p;
	 
	if ( coalesce(cd_medico_w::text, '') = '' ) then 
		-- Rotina para salvar o novo cadastro nas tabelas pessoa_fisica e medico 
		cd_medico_w  := pls_salvar_medico_eventual_web(	nm_pessoa_fisica_p, nr_seq_conselho_p, nr_crm_p, uf_crm_p, nm_usuario_p, nr_cpf_p, dt_nascimento_p, cd_estabelecimento_p, nr_seq_cbo_p, cd_medico_w );				
	end if;
					 
	begin 
		select	cd_pessoa_fisica, 
			cd_cgc 
		into STRICT	cd_pessoa_fisica_w, 
			cd_cgc_w 
		from	pls_prestador 
		where	nr_sequencia = nr_seq_prestador_p;
	exception 
	when others then 
		cd_pessoa_fisica_w	:= null;
		cd_cgc_w		:= null;
	end;
 
	-- Se o prestador for PJ, adiciona o médico na relação de médicos do prestador 
	if (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '' AND cd_medico_w IS NOT NULL AND cd_medico_w::text <> '') then 
		insert	into 	pls_prestador_medico(	nr_sequencia, cd_medico, dt_atualizacao, 
				ie_guia_medico, ie_situacao, ie_tipo_vinculo, 
				nr_seq_prestador, nm_usuario, dt_inclusao) 
		values (	nextval('pls_prestador_medico_seq'), cd_medico_w, clock_timestamp(), 
				'N', 'A', 'V', 
				nr_seq_prestador_p, nm_usuario_p, clock_timestamp());
				 
		commit;
	end if;
	 
	cd_medico_p := cd_medico_w;
end if;		
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_salvar_prestador_web ( nm_pessoa_fisica_p pessoa_fisica.nm_pessoa_fisica%type, nr_seq_conselho_p pessoa_fisica.nr_seq_conselho%type, nr_crm_p medico.nr_crm%type, uf_crm_p medico.uf_crm%type, nm_usuario_p text, nr_cpf_p pessoa_fisica.nr_cpf%type, dt_nascimento_p text, cd_estabelecimento_p bigint, nr_seq_cbo_p pessoa_fisica.nr_seq_cbo_saude%type, nr_seq_prestador_p pls_prestador.nr_sequencia%type, cd_medico_p INOUT pessoa_fisica.cd_pessoa_fisica%type) FROM PUBLIC;

