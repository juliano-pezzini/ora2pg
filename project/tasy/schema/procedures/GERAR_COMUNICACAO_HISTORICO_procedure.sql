-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_comunicacao_historico ( nm_usuario_p text, nm_paciente_p text, ds_comunicado_p text, ds_setor_adicional_p text, nm_usuario_destino_p text, ds_grupo_adicional_p text, ds_perfil_adicional_p text, nr_seq_agenda_p bigint default 0, ie_prioridade_p text default ' ') AS $body$
DECLARE

nm_usuario_destino_w	varchar(20000);
nm_usuario_grupos_w		varchar(2000);
ds_titulo_w				varchar(255);
nr_seq_classif_w		bigint;
hr_inicio_w				varchar(100);
ds_agenda_w				varchar(150);
nm_medico_w				varchar(100);


BEGIN 
if (ds_setor_adicional_p IS NOT NULL AND ds_setor_adicional_p::text <> '') or (nm_usuario_destino_p IS NOT NULL AND nm_usuario_destino_p::text <> '') or (ds_grupo_adicional_p IS NOT NULL AND ds_grupo_adicional_p::text <> '') or (ds_perfil_adicional_p IS NOT NULL AND ds_perfil_adicional_p::text <> '') then 
	begin 
	nm_usuario_destino_w := nm_usuario_destino_p;
	if (ds_grupo_adicional_p IS NOT NULL AND ds_grupo_adicional_p::text <> '') then 
		begin 
		nm_usuario_grupos_w := obter_usuarios_grupos(ds_grupo_adicional_p);
		if (nm_usuario_grupos_w IS NOT NULL AND nm_usuario_grupos_w::text <> '') then 
			begin 
			nm_usuario_destino_w := nm_usuario_destino_w || ',' || nm_usuario_grupos_w;
			end;
		end if;
		end;
	end if;
	 
	select	to_char(hr_inicio,'dd/mm/yyyy hh24:mi:ss') hr_inicio, 
			substr(Obter_Nome_Agenda(cd_agenda),1,150) ds_agenda, 
			substr(obter_nome_medico(cd_medico,'NCD'),1,100) nm_medico 
	into STRICT	hr_inicio_w, 
			ds_agenda_w, 
			nm_medico_w 
	from	agenda_paciente 
	where	nr_sequencia = nr_seq_agenda_p;
	 
	ds_titulo_w := substr(obter_texto_dic_objeto(236519,wheb_usuario_pck.get_nr_seq_idioma, 
	'NM_PACIENTE=' || nm_paciente_p || ';'|| 
	'HR_INICIO=' || hr_inicio_w || ';'|| 
	'DS_AGENDA=' || ds_agenda_w || ';'|| 
	'IE_PRIORIDADE=' || coalesce(ie_prioridade_p,' ')|| ';'|| 
	'NM_MEDICO=' || nm_medico_w || ';'),1,255);
	 
	select	min(nr_sequencia) 
	into STRICT	nr_seq_classif_w 
	from	comunic_interna_classif 
	where	ie_tipo = 'F';
	 
	CALL gerar_comunic_padrao( 
		clock_timestamp(), 
		ds_titulo_w, 
		coalesce(ds_comunicado_p,' '), 
		nm_usuario_p, 
		'N', 
		nm_usuario_destino_w, 
		'N', 
		nr_seq_classif_w, 
		ds_perfil_adicional_p, 
		null, 
		ds_setor_adicional_p, 
		clock_timestamp(), 
		null, 
		null);
	end;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_comunicacao_historico ( nm_usuario_p text, nm_paciente_p text, ds_comunicado_p text, ds_setor_adicional_p text, nm_usuario_destino_p text, ds_grupo_adicional_p text, ds_perfil_adicional_p text, nr_seq_agenda_p bigint default 0, ie_prioridade_p text default ' ') FROM PUBLIC;

