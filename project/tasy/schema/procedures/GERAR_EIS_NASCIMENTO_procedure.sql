-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_eis_nascimento ( dt_parametro_P timestamp, nm_usuario_p text) AS $body$
DECLARE


dt_parametro_w			timestamp;
dt_parametro_fim_w		timestamp;
nr_sequencia_w			bigint;


BEGIN


nr_sequencia_w := Gravar_Log_Indicador(111, obter_desc_expressao(293972)/*'Nascimento'*/
, clock_timestamp(), trunc(dt_parametro_p), nm_usuario_p, nr_sequencia_w);


commit;

dt_parametro_w		:= PKG_DATE_UTILS.start_of(dt_parametro_p,'month', 0);
dt_parametro_fim_w	:= PKG_DATE_UTILS.ADD_MONTH(PKG_DATE_UTILS.start_of(dt_parametro_p, 'MONTH', 0), 1,0) - (1/86400);

delete from eis_Nascimento
where dt_nascimento between  dt_parametro_w and  dt_parametro_fim_w;

commit;

insert into Eis_Nascimento(
	cd_estabelecimento,
	dt_nascimento,
	dt_atualizacao,
	nm_usuario,
	cd_medico,
	cd_pediatra,
	cd_convenio,
	ie_tipo_parto,
	ie_sexo,
	qt_nasc_vivo,
	qt_nasc_morto,
	qt_gemelar,
	qt_total,
	cd_municipio_ibge,
	ie_tipo_nascimento,
	CD_PROCEDENCIA,
	IE_FAIXA_ETARIA,
	qt_sem_ig,
	QT_MORTE_MATERNA,
	ie_acompanhante,
	ie_risco_gravidez,
	qt_sem_ig_cronologica,
	cd_setor_Atendimento,
	IE_PARTO_NORMAL,
	IE_PARTO_EPISIO ,
	IE_PARTO_CESARIA,
	IE_INFECCAO,
	QT_PESO_SALA_PARTO,
	DT_OBITO,
	QT_ALTA,
	qt_peso,
	qt_gestacoes_previas,
	qt_apgar_prim_min,
	qt_apgar_5_min,
	CD_PESSOA_FISICA)
SELECT
	a.cd_estabelecimento,
	PKG_DATE_UTILS.start_of(n.dt_nascimento,'dd', 0),
	clock_timestamp(),
	nm_usuario_p,
	p.cd_medico,
	n.cd_pediatra,
	obter_convenio_atendimento(n.nr_atendimento),
	CASE WHEN coalesce(p.ie_parto_normal,'N')='S' THEN '1'  ELSE CASE WHEN p.IE_PARTO_EPISIO='S' THEN '1'  ELSE '2' END  END ,
	coalesce(n.ie_sexo,'I'),
  	sum(CASE WHEN n.ie_unico_nasc_vivo='S' THEN  1  ELSE 0 END ),
  	sum(CASE WHEN n.ie_unico_nasc_vivo='N' THEN  1  ELSE 0 END ),
	sum(CASE WHEN coalesce(p.qt_nasc_vivos,0) + coalesce(p.qt_nasc_mortos,0)=0 THEN 0 WHEN coalesce(p.qt_nasc_vivos,0) + coalesce(p.qt_nasc_mortos,0)=1 THEN 0  ELSE CASE WHEN n.ie_unico_nasc_vivo='S' THEN  1  ELSE 0 END  +		CASE WHEN n.ie_unico_nasc_vivo='N' THEN  1  ELSE 0 END  END ),
	sum(1),
	obter_compl_pf(obter_pessoa_atendimento(p.nr_atendimento,'C'),1,'CDM'),
	n.ie_tipo_nascimento,
	a.CD_PROCEDENCIA,
	trim(both substr(obter_idade_pf(a.cd_pessoa_fisica,n.dt_nascimento,'E'),1,50)),
	n.qt_sem_ig,
	sum(CASE WHEN obter_se_motivo_alta_obito(a.cd_motivo_alta)='S' THEN 1  ELSE 0 END ),
	coalesce(ie_acompanhante,'N'),
	eis_obter_risco_gravidez(n.nr_atendimento),
	p.qt_sem_ig_cronologica,
	obter_setor_atendimento(a.nr_atendimento),
	coalesce(p.IE_PARTO_NORMAL,'N'),
	coalesce(p.IE_PARTO_EPISIO,'N'),
	coalesce(p.IE_PARTO_CESARIA,'N'),
	coalesce(OBTER_SE_INFEC_ATEND(a.nr_atendimento),'N'),
	QT_PESO_SALA_PARTO,
	n.DT_OBITO,
	sum(CASE WHEN coalesce(dt_alta::text, '') = '' THEN 1  ELSE 0 END ),
	n.qt_peso,
	p.qt_gestacoes,
	n.QT_APGAR_PRIM_MIN,
	n.QT_APGAR_QUINTO_MIN,
	a.CD_PESSOA_FISICA
from	atendimento_paciente a,
	parto p,
	nascimento n
where	n.dt_nascimento between dt_parametro_w and dt_parametro_fim_w
and	n.nr_atendimento	= p.nr_atendimento
and	a.nr_atendimento	= p.nr_atendimento
and	coalesce(p.ie_gera_eis,'S')	= 'S'
group by
	a.cd_estabelecimento,
	PKG_DATE_UTILS.start_of(n.dt_nascimento,'dd',0),
	p.cd_medico,
	n.cd_pediatra,
	obter_convenio_atendimento(n.nr_atendimento),
	CASE WHEN coalesce(p.ie_parto_normal,'N')='S' THEN '1'  ELSE CASE WHEN p.IE_PARTO_EPISIO='S' THEN '1'  ELSE '2' END  END ,
	coalesce(n.ie_sexo,'I'),
	obter_compl_pf(obter_pessoa_atendimento(p.nr_atendimento,'C'),1,'CDM'),
	n.ie_tipo_nascimento,
	a.CD_PROCEDENCIA,
	substr(obter_idade_pf(a.cd_pessoa_fisica,n.dt_nascimento,'E'),1,50),
	n.qt_sem_ig,
	coalesce(ie_acompanhante,'N'),
	eis_obter_risco_gravidez(n.nr_atendimento),
	p.qt_sem_ig_cronologica,
	obter_setor_atendimento(a.nr_atendimento),
	coalesce(p.IE_PARTO_NORMAL,'N'),
	coalesce(p.IE_PARTO_EPISIO,'N'),
	coalesce(p.IE_PARTO_CESARIA,'N'),
	coalesce(OBTER_SE_INFEC_ATEND(a.nr_atendimento),'N'),
	QT_PESO_SALA_PARTO,
	n.DT_OBITO,
	n.qt_peso,
	p.qt_gestacoes,
	n.QT_APGAR_PRIM_MIN,
	n.QT_APGAR_QUINTO_MIN,
	a.CD_PESSOA_FISICA;





CALL Atualizar_Log_Indicador(clock_timestamp(), nr_sequencia_w);
COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_eis_nascimento ( dt_parametro_P timestamp, nm_usuario_p text) FROM PUBLIC;

