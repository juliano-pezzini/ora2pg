-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_ajustar_serv_integracao () AS $body$
DECLARE

nr_sequencia_w bigint;
  cur RECORD;

BEGIN
    for cur in (select ip_conexao, nr_porta, nr_porta_listener
        from cliente_integracao where
        (ip_conexao IS NOT NULL AND ip_conexao::text <> '') or (nr_porta IS NOT NULL AND nr_porta::text <> '') or
        (nr_porta_listener IS NOT NULL AND nr_porta_listener::text <> '') group by
        ip_conexao, nr_porta, nr_porta_listener)
        loop

        --gerar novo registro para cada entrada a ser criada
        select nextval('servidor_integracao_seq') into STRICT nr_sequencia_w;

        --inserir novo registro para as integrações com o servidor especificado
        insert into servidor_integracao(
        nr_sequencia, ip_conexao, nr_porta, nr_porta_listener,
        qt_intervalo_minimo_envio, qt_intervalo_reconexao,
        qt_intervalo_retransmissao, qt_max_reconexao,
        qt_max_retransmissao, nm_usuario, dt_atualizacao )
        SELECT
        nr_sequencia_w, c1.ip_conexao, c1.nr_porta, c1.nr_porta_listener,
        c1.qt_intervalo_minimo_envio, c1.qt_intervalo_reconexao,
        c1.qt_intervalo_retransmissao, c1.qt_max_reconexao,
        c1.qt_max_retransmissao, c1.nm_usuario, c1.dt_atualizacao
        from cliente_integracao c1
        where nr_sequencia in (
        SELECT max(c2.nr_sequencia)
        from cliente_integracao c2
        where (c2.ip_conexao = cur.ip_conexao and c2.nr_porta = cur.nr_porta) or (c2.nr_porta_listener = cur.nr_porta_listener));

        --atualizar informação de servidor na tabela de ativação
        update cliente_integracao
        set nr_seq_servidor = nr_sequencia_w where (ip_conexao = cur.ip_conexao and nr_porta = cur.nr_porta ) or (nr_porta_listener = cur.nr_porta_listener);
    end loop;
    commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_ajustar_serv_integracao () FROM PUBLIC;

