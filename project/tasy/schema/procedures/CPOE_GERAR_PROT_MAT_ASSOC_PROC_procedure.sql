-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_prot_mat_assoc_proc ( nr_atendimento_p bigint, nr_seq_procedimento_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_protocolo_p bigint, nr_seq_protocolo_p bigint, nr_seq_proc_p bigint, cd_setor_atendimento_p bigint, nr_seq_agrupamento_p bigint, cd_paciente_p text, qt_idade_dia_p bigint, qt_idade_mes_p bigint, qt_idade_ano_p bigint, qt_peso_p bigint, cd_prescritor_p text, dt_prev_execucao_p timestamp, cd_intervalo_proc_p text, ds_horarios_proc_p text, nr_ocorrencia_proc_p bigint, ie_adm_proc_p char, ie_urgencia_proc_p char, ie_acm_proc_p char, ie_sn_proc_p char, ds_mat_adic_proc_p INOUT text, nr_seq_cpoe_rp_p cpoe_rp.nr_sequencia%type default null, nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) AS $body$
DECLARE


ds_stack_w					log_cpoe.ds_stack%type;
ds_log_cpoe_w				log_cpoe.ds_log%type;											
cd_mat_proc_w				material.cd_material%type;

cd_unid_medida_dose_mat_w	unidade_medida.cd_unidade_medida%type;

ie_via_mat_proc_w			via_aplicacao.ie_via_aplicacao%type;

qt_dose_mat_w				protocolo_medic_material.qt_dose%type;
qt_dose_peso_w				protocolo_medic_material.qt_dose_peso%type;
ds_recomendacao_w			protocolo_medic_material.ds_recomendacao%type;
ie_arredondar_w				protocolo_medic_material.ie_arredondar%type;
qt_min_intervalo_w			protocolo_medic_material.qt_minuto_aplicacao%type;
qt_hora_intervalo_w			protocolo_medic_material.qt_hora_intervalo%type;
ds_obs_item_prot_w			protocolo_medic_material.ds_recomendacao%type;

cd_intervalo_w				intervalo_prescricao.cd_intervalo%type;

qt_casas_retorno_w			rep_regra_arredond_dose.qt_casas%type;

nr_sequencia_w				cpoe_material.nr_sequencia%type;

dt_inicio_base_w			timestamp;
dt_inicio_proc_w			timestamp;
ie_se_necessario_w			char(1);
ie_acm_w					char(1);
ie_urgencia_mat_w			char(1);
ie_adm_mat_w				char(1);
ie_checar_adep_w			char(1);
hr_prim_horario_w			char(5);
ds_horarios_w				varchar(4000);
ds_erro_w					varchar(4000);
ds_horarios_aux_w			varchar(4000);
i							smallint;
ds_observacao_w				varchar(2000);
nr_ocorrencia_w				double precision;
qt_dose_limite_w			double precision;
ie_tipo_material_w			varchar(15);
ie_urgencia_intervalo_w		intervalo_prescricao.ie_agora%type;
ie_sn_intervalo_w			intervalo_prescricao.ie_se_necessario%type;
ie_acm_intervalo_w			intervalo_prescricao.ie_acm%type;
param_650_w					varchar(1);
param_809_w					varchar(1);

c01 CURSOR FOR
	SELECT	a.cd_material,
			a.cd_unidade_medida,
			a.qt_dose,
			a.qt_dose_peso,
			a.ie_via_aplicacao,
			substr(a.ds_recomendacao,1,2000),
			coalesce(a.cd_intervalo, cd_intervalo_proc_p),
			a.ds_horarios,
			coalesce(a.ie_se_necessario,'N'),
			coalesce(a.ie_acm,'N'),
			a.hr_prim_horario,
			coalesce(a.ie_urgencia,'N'),
			coalesce(a.ie_arredondar,'N'),
			a.ds_justificativa,
			a.qt_hora_intervalo,
			a.qt_min_intervalo,
			coalesce(a.ie_checar_adep,'N'),
			obter_tipo_material(a.cd_material, 'C') ie_tipo_material
	from 	protocolo_medic_material a
	where	a.cd_protocolo = cd_protocolo_p
	and		a.nr_sequencia = nr_seq_protocolo_p
	and		a.ie_agrupador = 5
	and		a.nr_seq_proc = nr_seq_proc_p
	order by
			ie_tipo_material, a.nr_seq_material;

	procedure inserir_mat_associados_proc is
	nr_proximo_w	bigint;
	
BEGIN
		if (ie_urgencia_mat_w = 'S') then
			ie_urgencia_mat_w := '0';
		else
			ie_urgencia_mat_w := null;
		end if;
	
		if (ie_tipo_material_w <> '1') then

			nr_proximo_w	:= position(',' in ds_mat_adic_proc_p);
			i := substr(ds_mat_adic_proc_p,1,nr_proximo_w-1);
			ds_mat_adic_proc_p	:= substr(ds_mat_adic_proc_p,nr_proximo_w+1,length(ds_mat_adic_proc_p));
			
			CALL exec_sql_dinamico_bv(
				'CPOE',
					' update	cpoe_procedimento ' ||
					' set		cd_mat_proc'||i||' = :cd_mat_proc_w, ' ||
					' 			ie_via_mat_proc'||i||' = :ie_via_mat_proc_w, ' ||
					' 			qt_dose_mat'||i||' = :qt_dose_mat_w, ' ||
					' 			cd_unid_medida_dose_mat'||i||' = :cd_unid_medida_dose_mat_w, ' ||
					' 			cd_interv_proc'||i||' = :cd_interv_proc_w, ' ||
					' 			ds_hor_proc'||i||' = :ds_hor_proc_w, ' ||
					' 			dt_inicio_proc'||i||' = :dt_inicio_proc_w, ' ||
					' 			hr_prim_hor_proc'||i||' = :hr_prim_hor_proc_w, ' ||
					' 			ds_obser_proc'||i||' = :ds_obser_proc_w, ' ||
					' 			ie_urgencia_mat'||i||' = :ie_urgencia_mat_w, ' ||
					' 			ie_adm_mat'||i||' = :ie_adm_mat_w, ' ||				
					' 			ie_assoc_adep'||i||' = :ie_assoc_adep_w, ' ||
					' 			ie_dur_proc'||i||' = :ie_dur_proc_w ' ||					
					' where		nr_atendimento = :nr_atendimento_p ' ||
					' and		nr_sequencia = :nr_seq_procedimento_p ',
				'cd_mat_proc_w='||cd_mat_proc_w||
				'#@#@ie_via_mat_proc_w='||ie_via_mat_proc_w||
				'#@#@qt_dose_mat_w='||qt_dose_mat_w||
				'#@#@cd_unid_medida_dose_mat_w='||cd_unid_medida_dose_mat_w||
				'#@#@cd_interv_proc_w='||cd_intervalo_w||
				'#@#@ds_hor_proc_w='||ds_horarios_w||
				'#@#@dt_inicio_proc_w='||to_char(dt_inicio_proc_w,'dd/mm/yyyy hh24:mi:ss')||
				'#@#@hr_prim_hor_proc_w='||hr_prim_horario_w||
				'#@#@ds_obser_proc_w='||ds_observacao_w||
				'#@#@ie_urgencia_mat_w='||ie_urgencia_mat_w||
				'#@#@ie_adm_mat_w='||ie_adm_mat_w||				
				'#@#@ie_assoc_adep_w='||ie_checar_adep_w||
				'#@#@ie_dur_proc_w='||'C'||
				'#@#@nr_atendimento_p='||nr_atendimento_p||
				'#@#@nr_seq_procedimento_p='||nr_seq_procedimento_p||
				'#@#@');

		else
		
			select	nextval('cpoe_material_seq')
			into STRICT	nr_sequencia_w
			;
			
			insert into cpoe_material(
							nr_sequencia,
							nr_atendimento,
							cd_material,
							qt_dose,
							cd_unidade_medida,
							ie_via_aplicacao,
							cd_intervalo,
							hr_prim_horario,
							ds_horarios,
							dt_inicio,
							ie_urgencia,
							ie_duracao,
							ie_administracao,
							dt_fim,
							ie_material,
							nm_usuario,
							nm_usuario_nrec,
							dt_atualizacao,
							dt_atualizacao_nrec,
							cd_perfil_ativo,
							cd_pessoa_fisica,
							nr_seq_procedimento,
							cd_funcao_origem,
							qt_unitaria,
							nr_ocorrencia,
							ie_separado_adep,
							nr_seq_cpoe_rp,
							nr_seq_cpoe_order_unit)
						values (
							nr_sequencia_w,
							nr_atendimento_p,
							cd_mat_proc_w,
							qt_dose_mat_w,
							cd_unid_medida_dose_mat_w,
							ie_via_mat_proc_w,
							cd_intervalo_w,
							hr_prim_horario_w,
							ds_horarios_w,
							dt_inicio_proc_w,
							ie_urgencia_mat_w,
							'P',
							ie_adm_mat_w,
							trunc(dt_inicio_proc_w + 1/24,'hh24') - 1/1440,
							'S',
							nm_usuario_p,
							nm_usuario_p,
							clock_timestamp(),
							clock_timestamp(),
							cd_perfil_p,
							cd_paciente_p,
							nr_seq_procedimento_p,
							2314,
							coalesce(obter_conversao_unid_med_cons(cd_mat_proc_w, cd_unid_medida_dose_mat_w, qt_dose_mat_w),1),
							coalesce(obter_ocorrencias_horarios_rep(ds_horarios_w),1),
							ie_checar_adep_w,
							nr_seq_cpoe_rp_p,
							nr_seq_cpoe_order_unit_p);
		end if;
		
		commit;	
	end;
	
begin

param_650_w := Obter_Param_Usuario(924, 650, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, param_650_w);
param_809_w := Obter_Param_Usuario(924, 809, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, param_809_w);

if (ds_mat_adic_proc_p = 'X') then
	ds_mat_adic_proc_p	:= '1,2,3,4,5,6,7';
else
	if (coalesce(ds_mat_adic_proc_p::text, '') = '') then
		return;
	end if;	
	
	ds_mat_adic_proc_p	:= ds_mat_adic_proc_p;
end if;

select	coalesce(max(qt_casas),0)
into STRICT	qt_casas_retorno_w
from	rep_regra_arredond_dose
where	qt_peso_p between qt_peso_inicial and qt_peso_final;
	
dt_inicio_base_w	:= trunc(dt_prev_execucao_p,'mi') + 1/24;

open c01;
loop
fetch c01 into
	cd_mat_proc_w,
	cd_unid_medida_dose_mat_w,
	qt_dose_mat_w,
	qt_dose_peso_w,
	ie_via_mat_proc_w,
	ds_recomendacao_w,
	cd_intervalo_w,
	ds_horarios_w,
	ie_se_necessario_w,
	ie_acm_w,
	hr_prim_horario_w,
	ie_urgencia_mat_w,
	ds_obs_item_prot_w,
	ie_arredondar_w,
	qt_hora_intervalo_w,
	qt_min_intervalo_w,
	ie_checar_adep_w,
	ie_tipo_material_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	dt_inicio_proc_w	:= dt_prev_execucao_p;
	hr_prim_horario_w	:= to_char(dt_prev_execucao_p,'hh24:mi');
	ie_adm_mat_w		:= ie_adm_proc_p;
	ie_acm_w			:= ie_acm_proc_p;
	ie_se_necessario_w	:= ie_sn_proc_p;
	ie_urgencia_mat_w	:= ie_urgencia_proc_p;
	
	if (ie_checar_adep_w = 'S') then
		ds_horarios_w		:= null;
		nr_ocorrencia_w		:= null;
		cd_intervalo_w		:= coalesce(cd_intervalo_w, cd_intervalo_proc_p);
			
		if (ie_urgencia_mat_w = 'S') and (coalesce(cd_intervalo_w::text, '') = '') then	
			dt_inicio_proc_w := clock_timestamp();
			
			select	coalesce(max(a.cd_intervalo),cd_intervalo_w)
			into STRICT	cd_intervalo_w
			from	intervalo_prescricao a
			where	a.ie_agora	= 'S'
			and		a.ie_situacao = 'A';
		end if;
			
		if (ie_urgencia_mat_w <> 'S') and (ie_acm_w <> 'S') then
			select	max(cd_intervalo)
			into STRICT	cd_intervalo_w
			from	intervalo_prescricao
			where	ie_situacao = 'A'
			and		cd_intervalo = cd_intervalo_w
			and		Obter_se_intervalo(cd_intervalo, 1) = 'S'
			and		Obter_se_intervalo_material(cd_mat_proc_w, cd_intervalo) = 'S'
			and		((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_p))
			order by
					coalesce(nr_seq_apresent,999),
					ds_intervalo;
		elsif (ie_urgencia_mat_w = 'S') then
			select	max(cd_intervalo)
			into STRICT	cd_intervalo_w
			from    intervalo_prescricao
			where   ie_situacao = 'A'
			and     coalesce(ie_agora,'N') = 'S'
			and		cd_intervalo = cd_intervalo_w
			and		((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_p))
			and		Obter_se_intervalo(cd_intervalo, 1) = 'S'
			order by
					coalesce(nr_seq_apresent,999),
					ds_intervalo;	
		else
			select	max(cd_intervalo)
			into STRICT	cd_intervalo_w
			from    intervalo_prescricao
			where   ie_situacao = 'A'
			and 	cd_intervalo = cd_intervalo_w
			and     ((coalesce(cd_estabelecimento::text, '') = '') or (cd_estabelecimento = cd_estabelecimento_p))
			and		Obter_se_intervalo(cd_intervalo, 1) = 'S'
			order by
				coalesce(nr_seq_apresent,999),
				 ds_intervalo;
		end if;
		
		if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') then
			select	coalesce(coalesce(max(ie_agora), ie_urgencia_mat_w), 'N'),
					coalesce(coalesce(max(ie_se_necessario), ie_se_necessario_w), 'N'),
					coalesce(coalesce(max(ie_acm), ie_acm_w), 'N')
			into STRICT	ie_urgencia_intervalo_w,
					ie_sn_intervalo_w,
					ie_acm_intervalo_w
			from	intervalo_prescricao
			where	cd_intervalo = cd_intervalo_w;
		end if;
		
		if (hr_prim_horario_w = '  :  ') then
			hr_prim_horario_w	:= null;
		end if;

		if (coalesce(hr_prim_horario_w::text, '') = '') then	
			hr_prim_horario_w := CPOE_Obter_primeiro_horario( nr_atendimento_p, cd_intervalo_w, cd_mat_proc_w, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p );
		end if;
		
		if	((coalesce(hr_prim_horario_w::text, '') = '') or (ie_urgencia_mat_w = 'S')) then
			hr_prim_horario_w	:= to_char(dt_inicio_proc_w,'hh24:mi');
		end if;
		
		if (ie_acm_w = 'S') then
			ds_horarios_w := '';
			hr_prim_horario_w := '';
		elsif (ie_se_necessario_w = 'S') then
			ds_horarios_w := '';
			hr_prim_horario_w := '';
		end if;
		
		nr_ocorrencia_w		:= 0;
		
		if (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') then
			dt_inicio_proc_w := ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_inicio_proc_w, hr_prim_horario_w);
			if (ESTABLISHMENT_TIMEZONE_UTILS.startOfday(dt_inicio_proc_w) < ESTABLISHMENT_TIMEZONE_UTILS.startOfday(dt_inicio_base_w)) then
				dt_inicio_proc_w	:= dt_inicio_proc_w+1;
			end if;
		end if;
		
		if (ie_urgencia_mat_w = 'S') then
			dt_inicio_proc_w := clock_timestamp();
		end if;

		if (coalesce(qt_min_intervalo_w::text, '') = '') then
			select	max(qt_min_intervalo)
			into STRICT	qt_min_intervalo_w
			from	intervalo_prescricao
			where	cd_intervalo	= cd_intervalo_w;
		end if;
		
		SELECT * FROM cpoe_calcular_horario_prescr(	nr_atendimento_p, cd_intervalo_w, null, dt_inicio_proc_w, qt_hora_intervalo_w, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null, null, null, null, null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;

		ds_horarios_w	:= ds_horarios_w || ds_horarios_aux_w;

		if (obter_se_limpa_prim_hor(cd_intervalo_w,cd_setor_atendimento_p) = 'S') then
			hr_prim_horario_w	:= '';
			ds_horarios_w		:= '';
		end if;
		
		ie_adm_mat_w		:= 'P';
		if (ie_urgencia_mat_w = 'S' or (param_809_w = 'S' and ie_urgencia_intervalo_w = 'S')) then
			ie_urgencia_mat_w	:= 0;
		else
			ie_urgencia_mat_w	:= null;
			if	(ie_se_necessario_w = 'S' or ((param_809_w = 'S' or param_650_w = 'S') and ie_sn_intervalo_w = 'S')) then
				ie_adm_mat_w		:= 'N';
				ds_horarios_w		:= null;
				hr_prim_horario_w	:= null;
			elsif (ie_acm_w = 'S' or (param_809_w = 'S' and ie_acm_intervalo_w = 'S')) then
				ie_adm_mat_w	:= 'C';
				ds_horarios_w		:= null;
				hr_prim_horario_w	:= null;
			end if;
		end if;
	else
		nr_ocorrencia_w		:= nr_ocorrencia_proc_p;
		ds_horarios_w		:= ds_horarios_proc_p;
		cd_intervalo_w		:= cd_intervalo_proc_p;
	end if;
	
	ie_via_mat_proc_w	:= coalesce(CPOE_Obter_padrao_param_prescr(	nr_atendimento_p, cd_mat_proc_w, ie_via_mat_proc_w, ie_se_necessario_w,
																	'V', cd_intervalo_w, cd_estabelecimento_p, cd_perfil_p, 
																	nm_usuario_p ), ie_via_mat_proc_w);

	if (coalesce(ie_via_mat_proc_w::text, '') = '') then
		select	max(ie_via_aplicacao)
		into STRICT	ie_via_mat_proc_w
		from	material
		where	cd_material = cd_mat_proc_w;
	end if;	
	
	if (qt_dose_peso_w > 0) and (qt_peso_p > 0) then
		qt_dose_mat_w	:= qt_dose_peso_w * qt_peso_p;

		if (ie_arredondar_w = 'S') then
			qt_dose_mat_w := Arredondamento(qt_dose_mat_w, 1, 'R');
		end if;
		
		if (upper(cd_unid_medida_dose_mat_w) = 'GTS') then
			qt_dose_mat_w := round(qt_dose_mat_w);
		end if;
	end if;
	
	ds_observacao_w	:= trim(both substr( Obter_orientacao_medic(cd_mat_proc_w) ,1,2000));
	
	if (ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') then
		ds_observacao_w	:= substr(ds_observacao_w || ' - ',1,2000);
	end if;
	
	ds_observacao_w	:= substr(ds_observacao_w || ds_recomendacao_w || ds_obs_item_prot_w,1,2000);
	
	qt_dose_mat_w			:= coalesce(qt_dose_mat_w, 0);
	
	qt_dose_limite_w	:= CPOE_Obter_dose_maxima(	cd_estabelecimento_p, cd_mat_proc_w, cd_unid_medida_dose_mat_w, qt_dose_mat_w,
													ie_via_mat_proc_w, cd_setor_atendimento_p, nr_seq_agrupamento_p, cd_prescritor_p,
													qt_idade_dia_p, qt_idade_mes_p, qt_idade_ano_p, qt_peso_p );
												
	if (qt_dose_limite_w > 0) then
		qt_dose_mat_w	:= qt_dose_limite_w;
	end if;
	
	if (coalesce(ds_observacao_w::text, '') = '') then
		ds_observacao_w	:= substr(CPOE_Obter_padrao_param_prescr(	nr_atendimento_p, cd_mat_proc_w, ie_via_mat_proc_w, ie_se_necessario_w,
																	'O', cd_intervalo_w, cd_estabelecimento_p, cd_perfil_p, 
																	nm_usuario_p ),1,2000);
	end if;
	
	if (qt_casas_retorno_w > 0) then
		qt_dose_mat_w	:= round(qt_dose_mat_w,qt_casas_retorno_w);
	end if;

	begin
		inserir_mat_associados_proc;
	exception when others then
		ds_erro_w	:= to_char(sqlerrm);	
		CALL gravar_log_tasy(10007,' CPOE_Gerar_prot_mat_assoc_proc - ERRO ' || ds_erro_w,
						nm_usuario_p);
	end;
	
	if (coalesce(ds_mat_adic_proc_p::text, '') = '') then
		exit;
	end if;		
	end;
end loop;
close c01;

exception
   when others then
	rollback;

	ds_stack_w	:= substr(dbms_utility.format_call_stack,1,2000);
	ds_log_cpoe_w := substr('CPOE_GERAR_PROT_MAT_ASSOC_PROC '
		|| chr(13) || ' - nr_atendimento_p: ' || nr_atendimento_p
		|| chr(13) || ' - nr_seq_procedimento_p: ' || nr_seq_procedimento_p
		|| chr(13) || ' - cd_estabelecimento_p: ' || cd_estabelecimento_p
		|| chr(13) || ' - cd_perfil_p: ' || cd_perfil_p
		|| chr(13) || ' - nm_usuario_p: ' || nm_usuario_p
		|| chr(13) || ' - cd_protocolo_p: ' || cd_protocolo_p
		|| chr(13) || ' - nr_seq_protocolo_p: ' || nr_seq_protocolo_p
		|| chr(13) || ' - nr_seq_proc_p: ' || nr_seq_proc_p
		|| chr(13) || ' - cd_setor_atendimento_p: ' || cd_setor_atendimento_p
		|| chr(13) || ' - nr_seq_agrupamento_p: ' || nr_seq_agrupamento_p
		|| chr(13) || ' - cd_paciente_p: ' || cd_paciente_p
		|| chr(13) || ' - qt_idade_dia_p: ' || qt_idade_dia_p
		|| chr(13) || ' - qt_idade_mes_p: ' || qt_idade_mes_p
		|| chr(13) || ' - qt_idade_ano_p: ' || qt_idade_ano_p
		|| chr(13) || ' - qt_peso_p: ' || qt_peso_p
		|| chr(13) || ' - cd_prescritor_p: ' || cd_prescritor_p
		|| chr(13) || ' - dt_prev_execucao_p: ' || PKG_DATE_FORMATERS_TZ.TO_VARCHAR(dt_prev_execucao_p,'timestamp',ESTABLISHMENT_TIMEZONE_UTILS.gettimezone)
		|| chr(13) || ' - cd_intervalo_proc_p: ' || cd_intervalo_proc_p
		|| chr(13) || ' - ds_horarios_proc_p: ' || ds_horarios_proc_p
		|| chr(13) || ' - nr_ocorrencia_proc_p: ' || nr_ocorrencia_proc_p
		|| chr(13) || ' - ie_adm_proc_p: ' || ie_adm_proc_p
		|| chr(13) || ' - ie_urgencia_proc_p: ' || ie_urgencia_proc_p
		|| chr(13) || ' - ie_acm_proc_p: ' || ie_acm_proc_p
		|| chr(13) || ' - ie_sn_proc_p: ' || ie_sn_proc_p
		|| chr(13) || ' - ds_mat_adic_proc_p: ' || ds_mat_adic_proc_p
		|| chr(13) || ' - ERRO: ' || sqlerrm
		|| chr(13) || ' - FUNCAO('||to_char(obter_funcao_ativa)||'); PERFIL('||to_char(obter_perfil_ativo)||')',1,2000);
		
	insert into log_cpoe(
		nr_sequencia,
		nr_atendimento, 
		dt_atualizacao, 
		nm_usuario, 
		ds_log, 
		ds_stack) 
	values (
		nextval('log_cpoe_seq'), 
		nr_atendimento_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		ds_log_cpoe_w, 
		ds_stack_w);
		
	commit;

	CALL wheb_mensagem_pck.exibir_mensagem_abort(sqlerrm);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_prot_mat_assoc_proc ( nr_atendimento_p bigint, nr_seq_procedimento_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, cd_protocolo_p bigint, nr_seq_protocolo_p bigint, nr_seq_proc_p bigint, cd_setor_atendimento_p bigint, nr_seq_agrupamento_p bigint, cd_paciente_p text, qt_idade_dia_p bigint, qt_idade_mes_p bigint, qt_idade_ano_p bigint, qt_peso_p bigint, cd_prescritor_p text, dt_prev_execucao_p timestamp, cd_intervalo_proc_p text, ds_horarios_proc_p text, nr_ocorrencia_proc_p bigint, ie_adm_proc_p char, ie_urgencia_proc_p char, ie_acm_proc_p char, ie_sn_proc_p char, ds_mat_adic_proc_p INOUT text, nr_seq_cpoe_rp_p cpoe_rp.nr_sequencia%type default null, nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) FROM PUBLIC;

