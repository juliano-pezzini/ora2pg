-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_ordem_oncologia ( nr_seq_paciente_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_item_w			varchar(255);
ie_tipo_item_w			varchar(10);
nr_seq_ordem_adep_w		bigint;
nr_seq_item_w			bigint;

c01 CURSOR FOR
SELECT	substr(obter_desc_material(CD_MATERIAL),1,250) ds_item,
	'M' ie_tipo_item,
	coalesce(nr_seq_ordem_adep,0) nr_seq_ordem_adep,
	nr_seq_material nr_seq_item
from	paciente_protocolo_medic
where	nr_seq_paciente	= nr_seq_paciente_p
and	coalesce(nr_seq_diluicao::text, '') = ''
and	coalesce(nr_seq_solucao::text, '') = ''
and	coalesce(nr_seq_procedimento::text, '') = ''

union all

select	substr(coalesce(obter_desc_solucao_onc(nr_seq_paciente, nr_seq_solucao),OBTER_DESC_EXPRESSAO(726808)),1,250) ds_item,
	'SOL' ie_tipo_item,
	coalesce(nr_seq_ordem_adep,0) nr_seq_ordem_adep,
	nr_seq_solucao nr_seq_item
from	paciente_protocolo_soluc
where	nr_seq_paciente	= nr_seq_paciente_p

union all

select	substr(Obter_Desc_Prescr_Proc(CD_PROCEDIMENTO,IE_ORIGEM_PROCED, nr_seq_proc_interno),1,250) ds_item,
	'P' ie_tipo_item,
	coalesce(nr_seq_ordem_adep,0) nr_seq_ordem_adep,
	nr_seq_procedimento nr_seq_item
from	paciente_protocolo_proc
where	nr_seq_paciente	= nr_seq_paciente_p

union all

select	substr(coalesce(coalesce(obter_desc_recomendacao(cd_recomendacao),ds_recomendacao),OBTER_DESC_EXPRESSAO(726806)),1,250) ds_item,
	'R',
	coalesce(nr_seq_ordem_adep,0) nr_seq_ordem_adep,
	nr_sequencia nr_seq_item
from	paciente_protocolo_rec
where	nr_seq_paciente	= nr_seq_paciente_p;


BEGIN

open C01;
loop
fetch C01 into
	ds_item_w,
	ie_tipo_item_w,
	nr_seq_ordem_adep_w,
	nr_seq_item_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	insert	into w_ordem_oncologia(nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					ie_tipo_item,
					nr_seq_item,
					nr_seq_ordem_adep,
					ds_item)
		values (nextval('w_ordem_oncologia_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			ie_tipo_item_w,
			nr_seq_item_w,
			nr_seq_ordem_adep_w,
			ds_item_w);

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_ordem_oncologia ( nr_seq_paciente_p bigint, nm_usuario_p text) FROM PUBLIC;

