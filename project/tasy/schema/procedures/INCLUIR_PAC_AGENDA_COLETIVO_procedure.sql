-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE incluir_pac_agenda_coletivo ( CD_PESSOA_FISICA_P text, IE_TIPO_INCLUSAO_P text, NR_SEQ_AGENDA_INT_P bigint) AS $body$
DECLARE

 
CD_PESSOA_FISICA_W	varchar(10);
CD_PESSOA_FAMILIA_W	varchar(10);
NR_SEQUENCIA_W		bigint;
QT_FAMILIARES_W		smallint;
QT_PESSOA_FISICA_W	smallint;

C01 CURSOR FOR 
 
SELECT 	CD_PESSOA_FAMILIA 
	FROM 	PF_FAMILIA 
	WHERE 	CD_PESSOA_FISICA = CD_PESSOA_FISICA_W 
	AND CD_PESSOA_FAMILIA NOT IN (SELECT CD_PESSOA_FISICA CD_PESSOA_FAMILIA 
	FROM AGENDAMENTO_COLETIVO 
	WHERE NR_SEQ_AG_INTEGRADA = NR_SEQ_AGENDA_INT_P);

 
C02 CURSOR FOR 
SELECT 	CD_PESSOA_FAMILIA 
	FROM 	PESSOA_DOMICILIO_MORADIA 
	WHERE 	CD_PESSOA_FISICA = CD_PESSOA_FISICA_W 
	AND CD_PESSOA_FAMILIA NOT IN (SELECT CD_PESSOA_FISICA CD_PESSOA_FAMILIA 
	FROM AGENDAMENTO_COLETIVO 
	WHERE NR_SEQ_AG_INTEGRADA = NR_SEQ_AGENDA_INT_P);


BEGIN 
 
IF (IE_TIPO_INCLUSAO_P = 'C') THEN 
	DELETE 	FROM AGENDAMENTO_COLETIVO 
		WHERE NR_SEQ_AG_INTEGRADA = NR_SEQ_AGENDA_INT_P;
		COMMIT;
END IF;
 
IF (IE_TIPO_INCLUSAO_P = 'P') THEN 
	IF ((NOT coalesce(CD_PESSOA_FISICA_P::text, '') = '') AND (NR_SEQ_AGENDA_INT_P > 0)) THEN 
		SELECT 	COUNT(*) 
			INTO STRICT 	QT_PESSOA_FISICA_W 
			FROM 	PESSOA_FISICA 
			WHERE 	CD_PESSOA_FISICA = CD_PESSOA_FISICA_P;
 
		SELECT 	MAX(NR_SEQUENCIA) 
			INTO STRICT	NR_SEQUENCIA_W 
			FROM  	AGENDAMENTO_COLETIVO 
			WHERE 	CD_PESSOA_FISICA = CD_PESSOA_FISICA_P 
			AND 	NR_SEQ_AG_INTEGRADA = NR_SEQ_AGENDA_INT_P;
 
		IF ((coalesce(NR_SEQUENCIA_W::text, '') = '') AND (QT_PESSOA_FISICA_W > 0)) THEN 	 
			INSERT INTO AGENDAMENTO_COLETIVO(NR_SEQUENCIA, 
							DT_ATUALIZACAO, 
							NM_USUARIO, 
							DT_ATUALIZACAO_NREC, 
							NM_USUARIO_NREC, 
							CD_PESSOA_FISICA, 
							NR_SEQ_AG_INTEGRADA) 
						VALUES (nextval('agendamento_coletivo_seq'),  
							clock_timestamp(), 
							WHEB_USUARIO_PCK.GET_NM_USUARIO, 
							clock_timestamp(), 
							WHEB_USUARIO_PCK.GET_NM_USUARIO, 
							CD_PESSOA_FISICA_P, 
							NR_SEQ_AGENDA_INT_P);
							COMMIT;
		END IF;
	END IF;
END IF;
 
IF (IE_TIPO_INCLUSAO_P = 'F') THEN 
	IF (NR_SEQ_AGENDA_INT_P > 0) THEN 
		SELECT 	MAX(CD_PESSOA_FISICA) 
			INTO STRICT 	CD_PESSOA_FISICA_W 
			FROM 	AGENDAMENTO_COLETIVO 
			WHERE 	NR_SEQUENCIA IN ( SELECT MIN(NR_SEQUENCIA) 
			FROM  AGENDAMENTO_COLETIVO 
			WHERE NR_SEQ_AG_INTEGRADA = NR_SEQ_AGENDA_INT_P);
 
		SELECT 	COUNT(*) 
			INTO STRICT 	QT_FAMILIARES_W 
			FROM 	PF_FAMILIA 
			WHERE 	CD_PESSOA_FISICA = CD_PESSOA_FISICA_W;
 
		IF (QT_FAMILIARES_W = 0) THEN 
			CALL WHEB_MENSAGEM_PCK.EXIBIR_MENSAGEM_ABORT(834314);
		END IF;
 
		IF (NOT coalesce(CD_PESSOA_FISICA_W::text, '') = '') THEN 
			OPEN	C01;
			LOOP 
				FETCH	C01 INTO 
				CD_PESSOA_FAMILIA_W;
			EXIT WHEN NOT FOUND; /* apply on C01 */
 
			SELECT 	MAX(NR_SEQUENCIA) 
				INTO STRICT 	NR_SEQUENCIA_W 
				FROM 	AGENDAMENTO_COLETIVO 
				WHERE 	NR_SEQ_AG_INTEGRADA = NR_SEQ_AGENDA_INT_P 
				AND 	CD_PESSOA_FISICA = CD_PESSOA_FAMILIA_W;
 
				IF (coalesce(NR_SEQUENCIA_W::text, '') = '') THEN 
					INSERT INTO AGENDAMENTO_COLETIVO(NR_SEQUENCIA, 
									DT_ATUALIZACAO, 
									NM_USUARIO, 
									DT_ATUALIZACAO_NREC, 
									NM_USUARIO_NREC, 
									CD_PESSOA_FISICA, 
									NR_SEQ_AG_INTEGRADA) 
								VALUES (nextval('agendamento_coletivo_seq'),  
									clock_timestamp(), 
									WHEB_USUARIO_PCK.GET_NM_USUARIO, 
									clock_timestamp(), 
									WHEB_USUARIO_PCK.GET_NM_USUARIO, 
									CD_PESSOA_FAMILIA_W, 
									NR_SEQ_AGENDA_INT_P);
				END IF;
				COMMIT;
			END LOOP;
			CLOSE C01;			
		END IF;
	END IF;
END IF;
 
IF (IE_TIPO_INCLUSAO_P = 'M') THEN 
	IF (NR_SEQ_AGENDA_INT_P > 0) THEN 
		SELECT 	MAX(CD_PESSOA_FISICA) 
			INTO STRICT 	CD_PESSOA_FISICA_W 
			FROM 	AGENDAMENTO_COLETIVO 
			WHERE 	NR_SEQUENCIA IN ( SELECT MIN(NR_SEQUENCIA) 
			FROM  AGENDAMENTO_COLETIVO 
			WHERE NR_SEQ_AG_INTEGRADA = NR_SEQ_AGENDA_INT_P);
 
		SELECT 	COUNT(*) 
			INTO STRICT 	QT_FAMILIARES_W 
			FROM 	PESSOA_DOMICILIO_MORADIA 
			WHERE 	CD_PESSOA_FISICA = CD_PESSOA_FISICA_W;
 
		IF (QT_FAMILIARES_W = 0) THEN 
			CALL WHEB_MENSAGEM_PCK.EXIBIR_MENSAGEM_ABORT(834356);
		END IF;
 
		IF (NOT coalesce(CD_PESSOA_FISICA_W::text, '') = '') THEN 
			OPEN C02;
			LOOP 
				FETCH	C02 INTO 
				CD_PESSOA_FAMILIA_W;
			EXIT WHEN NOT FOUND; /* apply on C02 */
 
			SELECT 	MAX(NR_SEQUENCIA) 
				INTO STRICT 	NR_SEQUENCIA_W 
				FROM 	AGENDAMENTO_COLETIVO 
				WHERE 	NR_SEQ_AG_INTEGRADA = NR_SEQ_AGENDA_INT_P 
				AND 	CD_PESSOA_FISICA = CD_PESSOA_FAMILIA_W;
 
			IF (coalesce(NR_SEQUENCIA_W::text, '') = '') THEN 
				INSERT INTO AGENDAMENTO_COLETIVO(NR_SEQUENCIA, 
								DT_ATUALIZACAO, 
								NM_USUARIO, 
								DT_ATUALIZACAO_NREC, 
								NM_USUARIO_NREC, 
								CD_PESSOA_FISICA, 
								NR_SEQ_AG_INTEGRADA) 
							VALUES (nextval('agendamento_coletivo_seq'),  
								clock_timestamp(), 
								WHEB_USUARIO_PCK.GET_NM_USUARIO, 
								clock_timestamp(), 
								WHEB_USUARIO_PCK.GET_NM_USUARIO, 
								CD_PESSOA_FAMILIA_W, 
								NR_SEQ_AGENDA_INT_P);
			END IF;
			COMMIT;
			END LOOP;
			CLOSE C02;			
		END IF;
	END IF;
END IF;
 
IF (IE_TIPO_INCLUSAO_P = 'N') THEN 
	UPDATE AGENDA_INTEGRADA 
		SET NM_FAMILIA = NM_PACIENTE 
		WHERE NR_SEQUENCIA = NR_SEQ_AGENDA_INT_P;
END IF;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE incluir_pac_agenda_coletivo ( CD_PESSOA_FISICA_P text, IE_TIPO_INCLUSAO_P text, NR_SEQ_AGENDA_INT_P bigint) FROM PUBLIC;

