-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cad_nfe_regra_detalhe ( base_p bigint, uf_p text, cd_estabelecimento_p text, nm_usuario_p text, ds_tipo_url_p text, versao_url_p text, url_p text ) AS $body$
DECLARE


cd_tipo_url_w		bigint;
cd_nr_seq_regra_w		bigint;		
cd_versao_url_w		integer;							


BEGIN
	
	select	nr_sequencia
	into STRICT	cd_nr_seq_regra_w
	from 	nfe_regra 
	where 	cd_estabelecimento = cd_estabelecimento_p 
	and 	sg_estado = uf_p;
	
	if (coalesce(cd_nr_seq_regra_w::text, '') = '')  then
		
		insert into nfe_regra(
						nr_sequencia,
						cd_estabelecimento,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						sg_estado
					)values (
						nextval('nfe_regra_seq'),
						cd_estabelecimento_p,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						uf_p
					);
		commit;
		
	end if;
	
	select 	vl_dominio
	into STRICT	cd_tipo_url_w
	from   	valor_dominio_v
	where  	((cd_dominio = 7631 and base_p = 1) 
	or (cd_dominio = 7636 and base_p = 2))
	and    	ds_valor_dominio like ds_tipo_url_p;
	
	delete from nfe_regra_detalhe
	where 	nr_seq_regra = cd_nr_seq_regra_w
	and	ie_tipo_url  = cd_tipo_url_w;
	
	commit;
	
	if versao_url_p = '1.00' then
		cd_versao_url_w := 1;
	elsif versao_url_p = '2.00' then
		cd_versao_url_w := 2;
	elsif versao_url_p = '2.01' then
		cd_versao_url_w := 3;
	elsif versao_url_p = '3.10' then
		cd_versao_url_w := 4;
	else
		cd_versao_url_w := 5;
	end if;
		
	
	insert into nfe_regra_detalhe(
						nr_sequencia,
						cd_estabelecimento,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						ds_url,
						ie_tipo_url,
						ie_versao_url,
						nr_seq_regra
					)values (
						nextval('nfe_regra_detalhe_seq'),
						cd_estabelecimento_p,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						url_p,
						cd_tipo_url_w,
						cd_versao_url_w,
						cd_nr_seq_regra_w
					);
	
	commit;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cad_nfe_regra_detalhe ( base_p bigint, uf_p text, cd_estabelecimento_p text, nm_usuario_p text, ds_tipo_url_p text, versao_url_p text, url_p text ) FROM PUBLIC;

