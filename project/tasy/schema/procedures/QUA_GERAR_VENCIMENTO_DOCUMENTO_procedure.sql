-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qua_gerar_vencimento_documento ( nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_documento_w		bigint;
cd_estabelecimento_w		smallint;

C01 CURSOR FOR 
	SELECT	a.nr_sequencia, 
		a.cd_estabelecimento 
	FROM	qua_documento a 
	WHERE	ie_situacao = 'A'/* Somente para documentos ativos */
 
	AND	a.ie_status NOT IN ('R','I') 
	AND	coalesce(a.qt_dias_revisao,0) > 0 
	AND	coalesce(a.dt_revalidacao,coalesce(TO_DATE(SUBSTR(qua_obter_dados_documento(a.nr_sequencia,'UAR'),1,20),'dd/mm/yyyy hh24:mi:ss'), 
		coalesce(a.dt_aprovacao,coalesce(a.dt_validacao,a.dt_elaboracao)))) + a.qt_dias_revisao <= clock_timestamp();


BEGIN 
CALL wheb_usuario_pck.SET_IE_EXECUTAR_TRIGGER('N');
 
OPEN C01;
LOOP 
FETCH C01 INTO 
	nr_seq_documento_w, 
	cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	BEGIN 
	UPDATE	qua_documento 
	SET	ie_status = 'I', 
		dt_atualizacao = clock_timestamp(), 
		nm_usuario = nm_usuario_p 
	WHERE	nr_sequencia = nr_seq_documento_w;
 
	CALL qua_gerar_envio_comunicacao(nr_seq_documento_w,'0',nm_usuario_p,'29',cd_estabelecimento_w,0,0,'N');
	END;
END LOOP;
CLOSE C01;
 
COMMIT;
CALL wheb_usuario_pck.SET_IE_EXECUTAR_TRIGGER('S');
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qua_gerar_vencimento_documento ( nm_usuario_p text) FROM PUBLIC;

