-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_relat_protocolo2_hcv (dt_inicial_p timestamp, dt_final_p timestamp, ie_cancelamento_p text, nr_seq_protocolo_p bigint, cd_convenio_p bigint, cd_setor_atendimento_p bigint, ie_tipo_atendimento_p bigint, ie_relatorio_p text) AS $body$
DECLARE

 
/* 
Procedure criada para atender a OS33209. 
Gera o relatório CATE 4183 HCV - Relatório de Totais das Contas por Convênio (novo) 
*/
 
 
/*variáveis quantidade*/
 
ds_convenio_qt_w	varchar(40);
qt_ambulatorial_w	double precision	:= 0;
qt_externo_w		double precision	:= 0;
qt_interno_w		double precision	:= 0;
qt_pronto_socorro_w	double precision	:= 0;
qt_total_conv_w	double precision	:= 0;
qt_percentual_w	double precision	:= 0;
qt_total_geral_w	double precision	:= 0;

/*variáveis valor*/
 
ds_convenio_vl_w	varchar(40);
vl_ambulatorial_w	double precision	:= 0;
vl_externo_w		double precision	:= 0;
vl_interno_w		double precision	:= 0;
vl_pronto_socorro_w	double precision	:= 0;
vl_total_conv_w	double precision	:= 0;
vl_percentual_w	double precision	:= 0;
vl_total_geral_w	double precision	:= 0;

/*comando sql quantidade*/
 
C01 CURSOR FOR 
SELECT	ds_conv ds_convenio, 
	sum(qt_amb) qt_ambulatorial, 
	sum(qt_ext) qt_externo, 
	sum(qt_int) qt_interno, 
	sum(qt_ps) qt_pronto_socorro, 
	sum(qt_tot) qt_total_conv, 
	sum(qt_perc) qt_percentual 
from	( 
	SELECT	substr(obter_nome_convenio(v.cd_convenio),1,40) ds_conv, 
		sum(CASE WHEN obter_tipo_atendimento(c.nr_atendimento)=8 THEN  1  ELSE 0 END ) qt_amb, 
		sum(CASE WHEN obter_tipo_atendimento(c.nr_atendimento)=7 THEN  1  ELSE 0 END ) qt_ext, 
		sum(CASE WHEN obter_tipo_atendimento(c.nr_atendimento)=1 THEN  1  ELSE 0 END ) qt_int, 
		sum(CASE WHEN obter_tipo_atendimento(c.nr_atendimento)=3 THEN  1  ELSE 0 END ) qt_ps, 
		sum(1) qt_tot, 
		dividir((sum(1) * 100), qt_total_geral_w) qt_perc 
	FROM	protocolo_convenio p, 
		conta_paciente c, 
		procedimento_paciente v 
	WHERE	p.ie_status_protocolo 		= 2 
	AND	p.nr_seq_protocolo			= c.nr_seq_protocolo 
	AND	((ie_cancelamento_p 			= 'T')	or 
		(ie_cancelamento_p 			= 'C' AND c.ie_cancelamento IS NOT NULL AND c.ie_cancelamento::text <> '') or 
		((ie_cancelamento_p 			= 'N')	and (coalesce(c.ie_cancelamento::text, '') = ''))) 
	AND	c.nr_interno_conta			= v.nr_interno_conta 
	AND	(v.cd_convenio IS NOT NULL AND v.cd_convenio::text <> '') 
	AND	coalesce(v.cd_motivo_exc_conta::text, '') = '' 
	AND	c.dt_mesano_referencia		BETWEEN dt_inicial_p and dt_final_p 
	and	((coalesce(nr_seq_protocolo_p::text, '') = '')	or (p.nr_seq_protocolo	= nr_seq_protocolo_p)) 
	and	((coalesce(cd_convenio_p::text, '') = '') 		or (v.cd_convenio 		= cd_convenio_p)) 
	AND	((coalesce(cd_setor_atendimento_p::text, '') = '') 	or (v.cd_setor_atendimento	= cd_setor_atendimento_p)) 
	AND	((coalesce(ie_tipo_atendimento_p::text, '') = '')	or (obter_tipo_atendimento(c.nr_atendimento) = ie_tipo_atendimento_p)) 
	group by substr(obter_nome_convenio(v.cd_convenio),1,40) 
	
union
 
	select	substr(obter_nome_convenio(v.cd_convenio),1,40) ds_conv, 
		sum(CASE WHEN obter_tipo_atendimento(c.nr_atendimento)=8 THEN  1  ELSE 0 END ) qt_amb, 
		sum(CASE WHEN obter_tipo_atendimento(c.nr_atendimento)=7 THEN  1  ELSE 0 END ) qt_ext, 
		sum(CASE WHEN obter_tipo_atendimento(c.nr_atendimento)=1 THEN  1  ELSE 0 END ) qt_int, 
		sum(CASE WHEN obter_tipo_atendimento(c.nr_atendimento)=3 THEN  1  ELSE 0 END ) qt_ps, 
		sum(1) qt_tot, 
		dividir((sum(1) * 100), qt_total_geral_w) qt_perc 
	FROM	protocolo_convenio p, 
		conta_paciente c, 
		material_atend_paciente v 
	WHERE	p.ie_status_protocolo 		= 2 
	AND	p.nr_seq_protocolo			= c.nr_seq_protocolo 
	AND	((ie_cancelamento_p 			= 'T')	or 
		(ie_cancelamento_p 			= 'C' AND c.ie_cancelamento IS NOT NULL AND c.ie_cancelamento::text <> '') or 
		((ie_cancelamento_p 			= 'N')	and (coalesce(c.ie_cancelamento::text, '') = ''))) 
	AND	c.nr_interno_conta 			= v.nr_interno_conta 
	AND	(v.cd_convenio IS NOT NULL AND v.cd_convenio::text <> '') 
	AND	coalesce(v.cd_motivo_exc_conta::text, '') = '' 
	AND	c.dt_mesano_referencia 		BETWEEN dt_inicial_p and dt_final_p 
	and	((coalesce(nr_seq_protocolo_p::text, '') = '')	or (p.nr_seq_protocolo	= nr_seq_protocolo_p)) 
	and	((coalesce(cd_convenio_p::text, '') = '') 		or (v.cd_convenio 		= cd_convenio_p)) 
	AND	((coalesce(cd_setor_atendimento_p::text, '') = '') 	or (v.cd_setor_atendimento 	= cd_setor_atendimento_p)) 
	AND	((coalesce(ie_tipo_atendimento_p::text, '') = '') 	or (obter_tipo_atendimento(c.nr_atendimento) = ie_tipo_atendimento_p)) 
	group by substr(obter_nome_convenio(v.cd_convenio),1,40) 
	order by ds_conv 
	) alias90 
group by	ds_conv 
order by	ds_convenio;

/*comando sql valor*/
 
C02 CURSOR FOR 
SELECT	ds_conv ds_convenio, 
	sum(vl_amb) vl_ambulatorial, 
	sum(vl_ext) vl_externo, 
	sum(vl_int) vl_interno, 
	sum(vl_ps) vl_pronto_socorro, 
	sum(vl_tot) vl_total_conv, 
	sum(vl_perc) vl_percentual 
from	( 
	SELECT	substr(obter_nome_convenio(v.cd_convenio),1,40) ds_conv, 
		sum(CASE WHEN obter_tipo_atendimento(c.nr_atendimento)=8 THEN  coalesce(v.vl_procedimento,0)  ELSE 0 END ) vl_amb, 
		sum(CASE WHEN obter_tipo_atendimento(c.nr_atendimento)=7 THEN  coalesce(v.vl_procedimento,0)  ELSE 0 END ) vl_ext, 
		sum(CASE WHEN obter_tipo_atendimento(c.nr_atendimento)=1 THEN  coalesce(v.vl_procedimento,0)  ELSE 0 END ) vl_int, 
		sum(CASE WHEN obter_tipo_atendimento(c.nr_atendimento)=3 THEN  coalesce(v.vl_procedimento,0)  ELSE 0 END ) vl_ps, 
		sum(coalesce(v.vl_procedimento,0)) vl_tot, 
		dividir((sum(coalesce(v.vl_procedimento,0)) * 100), vl_total_geral_w) vl_perc 
	FROM	protocolo_convenio p, 
		conta_paciente c, 
		procedimento_paciente v 
	WHERE	p.ie_status_protocolo 		= 2 
	AND	p.nr_seq_protocolo			= c.nr_seq_protocolo 
	AND	((ie_cancelamento_p 			= 'T')	or 
		(ie_cancelamento_p 			= 'C' AND c.ie_cancelamento IS NOT NULL AND c.ie_cancelamento::text <> '') or 
		((ie_cancelamento_p 			= 'N')	and (coalesce(c.ie_cancelamento::text, '') = ''))) 
	AND	c.nr_interno_conta			= v.nr_interno_conta 
	AND	(v.cd_convenio IS NOT NULL AND v.cd_convenio::text <> '') 
	AND	coalesce(v.cd_motivo_exc_conta::text, '') = '' 
	AND	c.dt_mesano_referencia		BETWEEN dt_inicial_p and dt_final_p 
	and	((coalesce(nr_seq_protocolo_p::text, '') = '')	or (p.nr_seq_protocolo	= nr_seq_protocolo_p)) 
	and	((coalesce(cd_convenio_p::text, '') = '') 		or (v.cd_convenio 		= cd_convenio_p)) 
	AND	((coalesce(cd_setor_atendimento_p::text, '') = '') 	or (v.cd_setor_atendimento	= cd_setor_atendimento_p)) 
	AND	((coalesce(ie_tipo_atendimento_p::text, '') = '')	or (obter_tipo_atendimento(c.nr_atendimento) = ie_tipo_atendimento_p)) 
	group by substr(obter_nome_convenio(v.cd_convenio),1,40) 
	
union
 
	select	substr(obter_nome_convenio(v.cd_convenio),1,40) ds_conv, 
		sum(CASE WHEN obter_tipo_atendimento(c.nr_atendimento)=8 THEN  coalesce(v.vl_material,0)  ELSE 0 END ) vl_amb, 
		sum(CASE WHEN obter_tipo_atendimento(c.nr_atendimento)=7 THEN  coalesce(v.vl_material,0)  ELSE 0 END ) vl_ext, 
		sum(CASE WHEN obter_tipo_atendimento(c.nr_atendimento)=1 THEN  coalesce(v.vl_material,0)  ELSE 0 END ) vl_int, 
		sum(CASE WHEN obter_tipo_atendimento(c.nr_atendimento)=3 THEN  coalesce(v.vl_material,0)  ELSE 0 END ) vl_ps, 
		sum(coalesce(v.vl_material,0)) vl_tot, 
		dividir((sum(coalesce(v.vl_material,0)) * 100), vl_total_geral_w) vl_perc 
	FROM	protocolo_convenio p, 
		conta_paciente c, 
		material_atend_paciente v 
	WHERE	p.ie_status_protocolo 		= 2 
	AND	p.nr_seq_protocolo			= c.nr_seq_protocolo 
	AND	((ie_cancelamento_p 			= 'T')	or 
		(ie_cancelamento_p 			= 'C' AND c.ie_cancelamento IS NOT NULL AND c.ie_cancelamento::text <> '') or 
		((ie_cancelamento_p 			= 'N')	and (coalesce(c.ie_cancelamento::text, '') = ''))) 
	AND	c.nr_interno_conta 			= v.nr_interno_conta 
	AND	(v.cd_convenio IS NOT NULL AND v.cd_convenio::text <> '') 
	AND	coalesce(v.cd_motivo_exc_conta::text, '') = '' 
	AND	c.dt_mesano_referencia 		BETWEEN dt_inicial_p and dt_final_p 
	and	((coalesce(nr_seq_protocolo_p::text, '') = '')	or (p.nr_seq_protocolo	= nr_seq_protocolo_p)) 
	and	((coalesce(cd_convenio_p::text, '') = '') 		or (v.cd_convenio 		= cd_convenio_p)) 
	AND	((coalesce(cd_setor_atendimento_p::text, '') = '') 	or (v.cd_setor_atendimento 	= cd_setor_atendimento_p)) 
	AND	((coalesce(ie_tipo_atendimento_p::text, '') = '') 	or (obter_tipo_atendimento(c.nr_atendimento) = ie_tipo_atendimento_p)) 
	group by substr(obter_nome_convenio(v.cd_convenio),1,40) 
	order by ds_conv 
	) alias102 
group by	ds_conv 
order by	ds_convenio;


BEGIN 
if (dt_inicial_p IS NOT NULL AND dt_inicial_p::text <> '') and (dt_final_p IS NOT NULL AND dt_final_p::text <> '') then 
 
	/*limpar tabela*/
 
	delete from w_relat_protocolo2_hcv;
	commit;
 
	/*quantidade*/
 
	if (coalesce(ie_relatorio_p,'Q') = 'Q') then 
 
		/*obter total geral (quantidade) para cálculo do percentual*/
 
		select	sum(qt_tot) qt_total_geral 
		into STRICT	qt_total_geral_w 
		from	( 
			SELECT	SUM(1) qt_tot 
			FROM	protocolo_convenio p, 
				conta_paciente c, 
				procedimento_paciente v 
			WHERE	p.ie_status_protocolo	= 2 
			AND	p.nr_seq_protocolo		= c.nr_seq_protocolo 
			AND	((ie_cancelamento_p		= 'T')	or 
				(ie_cancelamento_p		= 'C' AND c.ie_cancelamento IS NOT NULL AND c.ie_cancelamento::text <> '') or 
				((ie_cancelamento_p		= 'N')	and (coalesce(c.ie_cancelamento::text, '') = ''))) 
			AND	c.nr_interno_conta		= v.nr_interno_conta 
			AND	(v.cd_convenio IS NOT NULL AND v.cd_convenio::text <> '') 
			AND	coalesce(v.cd_motivo_exc_conta::text, '') = '' 
			AND	c.dt_mesano_referencia	BETWEEN dt_inicial_p and dt_final_p 
			and	((coalesce(nr_seq_protocolo_p::text, '') = '')	or (p.nr_seq_protocolo	= nr_seq_protocolo_p)) 
			and	((coalesce(cd_convenio_p::text, '') = '') 		or (v.cd_convenio 		= cd_convenio_p)) 
			AND	((coalesce(cd_setor_atendimento_p::text, '') = '')	or (v.cd_setor_atendimento	= cd_setor_atendimento_p)) 
			AND	((coalesce(ie_tipo_atendimento_p::text, '') = '') 	or (obter_tipo_atendimento(c.nr_atendimento) = ie_tipo_atendimento_p)) 
			
union
 
			SELECT	SUM(1) qt_tot 
			FROM	protocolo_convenio p, 
				conta_paciente c, 
				material_atend_paciente v 
			WHERE	p.ie_status_protocolo 	= 2 
			AND	p.nr_seq_protocolo		= c.nr_seq_protocolo 
			AND	((ie_cancelamento_p 	= 'T') or 
				(ie_cancelamento_p 		= 'C' AND c.ie_cancelamento IS NOT NULL AND c.ie_cancelamento::text <> '') or 
				((ie_cancelamento_p 		= 'N') and (coalesce(c.ie_cancelamento::text, '') = ''))) 
			AND	c.nr_interno_conta 		= v.nr_interno_conta 
			AND	(v.cd_convenio IS NOT NULL AND v.cd_convenio::text <> '') 
			AND	coalesce(v.cd_motivo_exc_conta::text, '') = '' 
			AND	c.dt_mesano_referencia 	BETWEEN dt_inicial_p and dt_final_p 
			and	((coalesce(nr_seq_protocolo_p::text, '') = '')	or (p.nr_seq_protocolo	= nr_seq_protocolo_p)) 
			and	((coalesce(cd_convenio_p::text, '') = '') 		or (v.cd_convenio 		= cd_convenio_p)) 
			AND	((coalesce(cd_setor_atendimento_p::text, '') = '')	or (v.cd_setor_atendimento	= cd_setor_atendimento_p)) 
			AND	((coalesce(ie_tipo_atendimento_p::text, '') = '') 	or (obter_tipo_atendimento(c.nr_atendimento) =  
ie_tipo_atendimento_p)) 
		) alias57;
			/*gerar quantidade*/
 
			Open C01;
			Loop 
			Fetch C01 into	ds_convenio_qt_w, 
						qt_ambulatorial_w, 
						qt_externo_w, 
						qt_interno_w, 
						qt_pronto_socorro_w, 
						qt_total_conv_w, 
						qt_percentual_w;
			EXIT WHEN NOT FOUND; /* apply on C01 */
 
			/*inserir quantidade na tabela temporária*/
 
			insert	into	w_relat_protocolo2_hcv( 
									ds_convenio_qt, 
									qt_ambulatorial, 
									qt_externo, 
									qt_interno, 
									qt_pronto_socorro, 
									qt_total_convenio, 
									qt_percentual 
									) 
								values ( 
									ds_convenio_qt_w, 
									qt_ambulatorial_w, 
									qt_externo_w, 
									qt_interno_w, 
									qt_pronto_socorro_w, 
									qt_total_conv_w, 
									qt_percentual_w 
									);
			End loop;
			Close C01;
	/*valor*/
 
	elsif (coalesce(ie_relatorio_p, 'Q') = 'V') then 
 
		/*obter total geral (valor) para cálculo do percentual*/
 
		select	sum(vl_tot) qt_total_geral 
		into STRICT	vl_total_geral_w 
		from	( 
			SELECT	SUM(coalesce(v.vl_procedimento,0)) vl_tot 
			FROM	protocolo_convenio p, 
				conta_paciente c, 
				procedimento_paciente v 
			WHERE	p.ie_status_protocolo	= 2 
			AND	p.nr_seq_protocolo		= c.nr_seq_protocolo 
			AND	((ie_cancelamento_p 	= 'T')	or 
				(ie_cancelamento_p 		= 'C' AND c.ie_cancelamento IS NOT NULL AND c.ie_cancelamento::text <> '') or 
				((ie_cancelamento_p 		= 'N')	and (coalesce(c.ie_cancelamento::text, '') = ''))) 
			AND	c.nr_interno_conta 		= v.nr_interno_conta 
			AND	(v.cd_convenio IS NOT NULL AND v.cd_convenio::text <> '') 
			AND	coalesce(v.cd_motivo_exc_conta::text, '') = '' 
			AND	c.dt_mesano_referencia 	BETWEEN dt_inicial_p and dt_final_p 
			and	((coalesce(nr_seq_protocolo_p::text, '') = '') 	or (p.nr_seq_protocolo 	= nr_seq_protocolo_p)) 
			and	((coalesce(cd_convenio_p::text, '') = '') 		or (v.cd_convenio 		= cd_convenio_p)) 
			AND	((coalesce(cd_setor_atendimento_p::text, '') = '')	or (v.cd_setor_atendimento 	= cd_setor_atendimento_p)) 
			AND	((coalesce(ie_tipo_atendimento_p::text, '') = '') 	or (obter_tipo_atendimento(c.nr_atendimento) =  
ie_tipo_atendimento_p)) 
			
union
 
			SELECT	SUM(coalesce(v.vl_material,0)) vl_tot 
			FROM	protocolo_convenio p, 
				conta_paciente c, 
				material_atend_paciente v 
			WHERE	p.ie_status_protocolo	= 2 
			AND	p.nr_seq_protocolo		= c.nr_seq_protocolo 
			AND	((ie_cancelamento_p 	= 'T')	or 
				(ie_cancelamento_p 		= 'C' AND c.ie_cancelamento IS NOT NULL AND c.ie_cancelamento::text <> '') or 
				((ie_cancelamento_p 		= 'N')	and (coalesce(c.ie_cancelamento::text, '') = ''))) 
			AND	c.nr_interno_conta 		= v.nr_interno_conta 
			AND	(v.cd_convenio IS NOT NULL AND v.cd_convenio::text <> '') 
			AND	coalesce(v.cd_motivo_exc_conta::text, '') = '' 
			AND	c.dt_mesano_referencia 	BETWEEN dt_inicial_p and dt_final_p 
			and	((coalesce(nr_seq_protocolo_p::text, '') = '')	or (p.nr_seq_protocolo 	= nr_seq_protocolo_p)) 
			and	((coalesce(cd_convenio_p::text, '') = '') 		or (v.cd_convenio 		= cd_convenio_p)) 
			AND	((coalesce(cd_setor_atendimento_p::text, '') = '') 	or (v.cd_setor_atendimento 	= cd_setor_atendimento_p)) 
			AND	((coalesce(ie_tipo_atendimento_p::text, '') = '') 	or (obter_tipo_atendimento(c.nr_atendimento) =  
ie_tipo_atendimento_p)) 
		) alias59;
 
			/*gerar valor*/
 
			Open C02;
			Loop 
			Fetch C02 into	ds_convenio_vl_w, 
						vl_ambulatorial_w, 
						vl_externo_w, 
						vl_interno_w, 
						vl_pronto_socorro_w, 
						vl_total_conv_w, 
						vl_percentual_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
 
			/*inserir valor na tabela temporária*/
 
			insert	into	w_relat_protocolo2_hcv( 
									ds_convenio_vl, 
									vl_ambulatorial, 
									vl_externo, 
									vl_interno, 
									vl_pronto_socorro, 
									vl_total_convenio, 
									vl_percentual 
									) 
								values ( 
									ds_convenio_vl_w, 
									vl_ambulatorial_w, 
									vl_externo_w, 
									vl_interno_w, 
									vl_pronto_socorro_w, 
									vl_total_conv_w, 
									vl_percentual_w 
									);
			End loop;
			Close C02;
	end if;
end if;
commit;
END	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_relat_protocolo2_hcv (dt_inicial_p timestamp, dt_final_p timestamp, ie_cancelamento_p text, nr_seq_protocolo_p bigint, cd_convenio_p bigint, cd_setor_atendimento_p bigint, ie_tipo_atendimento_p bigint, ie_relatorio_p text) FROM PUBLIC;

