-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_calcula_horarios_enteral (( nm_usuario_p text, dt_inicio_p timestamp, ie_continuo_p text, nr_ocorrencia_p INOUT bigint, cd_intervalo_p text, qt_tempo_aplicacao_p bigint, qt_tempo_etapa_p bigint, hr_inicio_pausa_p text, ds_horarios_p out text, ie_etapa_especial_p text, ie_duracao_p text default null, dt_fim_p timestamp default null, ie_present_desc_stage_p text default 'S', nr_atendimento_p bigint default null, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type default null, cd_perfil_p perfil.cd_perfil%type default null ) is dt_horario_w timestamp DEFAULT dt_inicio_p) AS $body$
BEGIN
    if (coalesce(qt_tempo_etapa_w, 0) <= 0) then
      nr_ocorrencia_p := 0;
      ds_horarios_p	:= null;
      return;
    end if;
	return;
  end;

begin

  /*
  Esta function e similar a CPOE_Obter_dt_fim_enteral,o que muda e seu retorno, quando houver alteracao neste objeto, 
  deve-se verificar replicar a alteracao tambem neste outro.
  */
  param_CPOE_24_w := Obter_Param_Usuario(2314, 24, cd_perfil_param_w, nm_usuario_param_w, cd_estab_param_w, param_CPOE_24_w);

  select coalesce(MAX(ds_horarios),''),
         coalesce(max(ie_operacao),''),
         coalesce(max(qt_operacao),1)
    into STRICT ds_horarios_w,
         ie_operacao_w,
         qt_operacao_w
    from intervalo_prescricao
   where cd_intervalo = cd_intervalo_p;


  if (((ie_operacao_w = 'V') or (ie_operacao_w = 'F')) and (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> ''))then
    SELECT * FROM CPOE_Calcular_horario_prescr(nr_atendimento_p, cd_intervalo_p, null, dt_inicio_p, null, null, nr_ocorrencia_p, ds_horarios_p, ds_horarios2_w, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, null, null, null, null, null, null, 24) INTO STRICT nr_ocorrencia_p, ds_horarios_p, ds_horarios2_w;

  else

	begin
      sql_md_w := 'begin CPOE_calc_hor_enteral_md(:1, :2, :3, :4, :5, :6, :7, :8, :9, :10, :11); end;';
      EXECUTE sql_md_w using in dt_inicio_p,
                                       in ie_continuo_p,
                                       in cd_intervalo_p,
                                       in qt_tempo_aplicacao_p,
                                       in qt_tempo_etapa_p,
                                       in hr_inicio_pausa_p,  
                                       in dt_fim_p,
                                       in ie_present_desc_stage_p,
                                       in out nr_ocorrencia_p,
                                       out ds_horarios_p,
									  coalesce(Obter_ocorrencia_intervalo(cd_intervalo_p, 24, 'O'),0);
    exception
      when others then
        nr_ocorrencia_p := null;
        ds_horarios_p := null;
    end;


  end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_calcula_horarios_enteral (( nm_usuario_p text, dt_inicio_p timestamp, ie_continuo_p text, nr_ocorrencia_p INOUT bigint, cd_intervalo_p text, qt_tempo_aplicacao_p bigint, qt_tempo_etapa_p bigint, hr_inicio_pausa_p text, ds_horarios_p out text, ie_etapa_especial_p text, ie_duracao_p text default null, dt_fim_p timestamp default null, ie_present_desc_stage_p text default 'S', nr_atendimento_p bigint default null, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type default null, cd_perfil_p perfil.cd_perfil%type default null ) is dt_horario_w timestamp DEFAULT dt_inicio_p) FROM PUBLIC;

