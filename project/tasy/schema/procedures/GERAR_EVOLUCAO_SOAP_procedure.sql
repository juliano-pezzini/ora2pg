-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_evolucao_soap (nr_atendimento_p bigint, nm_usuario_p text, cd_evolucao_p INOUT bigint) AS $body$
DECLARE

-- ATENDIMENTO_SOAP
nr_seq_soap_w			atendimento_soap.nr_sequencia%type;
dt_soap_w			    timestamp;
cd_pessoa_fisica_w  	atendimento_soap.cd_pessoa_fisica%type;
cd_profissional_w		atendimento_soap.cd_profissional%type;

-- PARAMETROS GERAIS.
ds_idade_w				varchar(50);
ds_sexo_w				varchar(1);

-- TIPO EVOLUCAO.
ie_tipo_evolucao_w		usuario.ie_tipo_evolucao%type;

-- SINTOMAS C01
dt_reg_sintoma_w		ciap_atendimento.dt_registro%type;
nr_sequencia_sintoma_w	ciap_atendimento.nr_sequencia%type;
ds_sintoma_w			varchar(255);
ds_obs_sintoma_w		text;
ie_gerar_sintoma_w		varchar(1) := 'N';
ie_gerar_sint_acolhi_w	varchar(1) := 'N';

--RECEITAS
ie_gerar_medreceita_w   varchar(1) := 'N';
dt_medreceita_w  timestamp;
ds_medreceita_w  text;

-- DESCRICAOO SUBJETIVO C10
dt_registro_w			timestamp;
ds_registro_w			text;
nr_seq_descricao_w		atend_soap_descricao.nr_sequencia%type;
ie_gerar_descricao_w	varchar(1) := 'N';

--SOAP SUBJETIVO -- AVALIACAO
ie_evolucao_subjetivo_w  tipo_evolucao.ie_evolucao_subjetivo%type;
ie_evolucao_avaliacao_w  tipo_evolucao.ie_evolucao_avaliacao%type;

-- EXAMES FISICOS - SINAIS VITAIS C02
qt_pa_sistolica_w			atendimento_sinal_vital.qt_pa_sistolica%type;
qt_pa_dialostica_w			atendimento_sinal_vital.qt_pa_diastolica%type;
qt_freq_cardia_w			atendimento_sinal_vital.qt_freq_cardiaca%type;
qt_freq_resp_w				atendimento_sinal_vital.qt_freq_resp%type;
qt_temp_w					atendimento_sinal_vital.qt_temp%type;
qt_peso_w					atendimento_sinal_vital.qt_peso%type;
qt_altura_cm_w		    	atendimento_sinal_vital.qt_altura_cm%type;
qt_glicemia_capilar_w		atendimento_sinal_vital.qt_glicemia_capilar%type;
ds_obs_sv_w					atendimento_sinal_vital.ds_observacao%type;
qt_perimetro_cefalico_w 	atendimento_sinal_vital.qt_perimetro_cefalico%type;
qt_perimetro_toracico_w 	atendimento_sinal_vital.qt_perimetro_toracico%type;
qt_perimitro_abdominal_w 	atendimento_sinal_vital.qt_perimitro_abdominal%type;
ie_dinamica_uteria_w  		atendimento_sinal_vital.ie_dinamica_uterina%type;
qt_au_cm_w 					atendimento_sinal_vital.qt_au_cm%type;
qt_contracoes_w 			atendimento_sinal_vital.qt_contracoes%type;
dt_sinal_vital_w			atendimento_sinal_vital.dt_sinal_vital%type;
ie_gerar_sv_w				varchar(1) := 'N';
ie_gerar_sv_acolhi_w		varchar(1) := 'N';

-- DESCRICAO OBETIVO C15
dt_registro_2w			timestamp;
ds_registro_2w			text;
nr_seq_descricao_2w		atend_soap_descricao.nr_sequencia%type;
ie_gerar_descricao_2w	varchar(1) := 'N';

-- LISTA DE PROBLEMAS C03
ds_problema_w				lista_problema_pac.ds_problema%type;
ds_status_problema_w		varchar(255);
ds_intensidade_problema_w	varchar(255);
ie_gerar_lista_problema_w   varchar(1);

-- ENCAMINHAMENTOS AGENDAMENTO. c05
cd_agenda_w 				atend_encaminhamento.cd_agenda%type;
dt_agenda_w 				atend_encaminhamento.dt_agenda%type;
ie_encaixe_urgencia_w		varchar(1);
ds_encaixe_urgencia_w		varchar(10);
nr_seq_agenda_w				atend_encaminhamento.nr_seq_agenda%type;
ds_agenda_w					varchar(2500);
ie_gerar_enc_agendamento_w	varchar(1) := 'N';
ds_horario_agendamento_w	varchar(255);

-- ENCAMINHAMENTOS PROGRAMA SAUDE. c06
ds_programa_saude_w			varchar(255);
ds_campanha_w				varchar(255);
ie_gerar_enc_prog_saude_w	varchar(1) := 'N';

-- ENCAMINHAMENTOS ESPECIALIDADE. c07
ds_medico_especialidade_w	varchar(255);
ds_especialidade_w			varchar(255);
ie_gerar_enc_espec_w		varchar(1) := 'N';

-- ENCAMINHAMENTOS ESPECIALIDADE. c08
nr_seq_receita_w			fa_receita_farmacia.nr_sequencia%type;
nr_seq_receita_old_w		fa_receita_farmacia.nr_sequencia%type := 0;
nr_dias_receita_w			fa_receita_farmacia.nr_dias_receita%type;
nr_receita_w				fa_receita_farmacia.nr_receita%type;
dt_inicio_receita_w			varchar(20);
dt_fim_receita_w			timestamp;
ds_medic_rec_w				varchar(255);
qt_dose_rec_w				fa_receita_farmacia_item.qt_dose%type;
cd_unidade_medida_rec_w		fa_receita_farmacia_item.cd_unidade_medida%type;
ie_gerar_receita_w			varchar(1) := 'N';

-- ENCAMINHAMENTOS ESPECIALIDADE. c09
ds_proced_w					varchar(255);
qt_proced_w					pedido_exame_externo_item.qt_exame%type;
nr_seq_pedido_w				pedido_exame_externo_item.nr_seq_pedido%type;
nr_seq_pedido_old_w			pedido_exame_externo_item.nr_seq_pedido%type := 0;
ds_solicitacao_w			varchar(20);
ie_gerar_procedimento_w		varchar(1) := 'N';

-- ATESTADOS
ie_gerar_atestados_w   varchar(1) := 'N';
dt_atestado_w  timestamp;
ds_atestado_w  text;

-- PARECER MEDICO
ie_gerar_parecer_w   varchar(1) := 'N';
dt_parecer_w  timestamp;
ds_parecer_w  text;

-- SOLICITACAO TRANSFERENCIA EXTERNA
dt_solicitacao_w		  solic_transf_externa.dt_solicitacao%type;
ds_motivo              	  motivo_transf_externa.ds_motivo%type;
ds_observacao_w			  solic_transf_externa.ds_observacao%type;
ie_gerar_transferencia_w  varchar(1) := 'N';

-- CPOE - DIETA
ie_gerar_dieta_w   varchar(1) := 'N';
ds_dieta_w  text;

-- CPOE - DIALISE
ie_gerar_dialise_w   varchar(1) := 'N';
ds_dialise_w  text;

-- CPOE - MEDICAMENTOS
ie_gerar_medicamentos_w   varchar(1) := 'N';
ds_medicamentos_w  text;

-- CPOE - PROCEDIMENTOS
ie_gerar_procedimentos_w   varchar(1) := 'N';
ds_procedimentos_cpoe_w  text;

-- CPOE - HEMOTERAPIA
ie_gerar_hemoterapia_w   varchar(1) := 'N';
ds_hemoterapia_w  text;

-- CPOE - RECOMENDACAO
ie_gerar_recomendacao_w   varchar(1) := 'N';
ds_recomendacao_w  text;

-- CPOE - GASOTERAPIA
ie_gerar_gasoterapia_w   varchar(1) := 'N';
ds_gasoterapia_w  text;

-- CPOE - ANATOMIA PATOLOGICA
ie_gerar_anat_patologica_w   varchar(1) := 'N';
ds_anat_patologica_w  text;

-- CPOE - MATERIAIS
ie_gerar_materiais_w   varchar(1) := 'N';
ds_materiais_w  text;

-- EVOLUCAO.
cd_evolucao_w				evolucao_paciente.cd_evolucao%type;
cd_evolucao_ww				evolucao_paciente.cd_evolucao%type;
ie_evolucao_clinica_w		tipo_evolucao.cd_tipo_evolucao%type;
cd_prescritor_w				varchar(10);
ds_tipo_item_w				varchar(80);
ds_conteudo_w				varchar(32000);


ds_fonte_w					varchar(100);
ds_tam_fonte_w				varchar(10);
nr_tam_fonte_w				integer;


ds_sintomas_w				varchar(8000)  := '';

ds_sinais_vitais_w			varchar(8000)  := '';

ds_enc_agendamento_w		varchar(8000)  := '';

ds_enc_prog_saude_w			varchar(8000)  := '';

ds_enc_especialidade_w		varchar(8000)  := '';

ds_descricao_w				text;
ds_descricao_2w				text;

ds_problema_pac_w			varchar(8000)  := '';

ds_receita_w				varchar(8000)	:= '';

ds_proc_exam_cir_w			varchar(8000)	:= '';

ds_evolucao_w				varchar(32000) := '';

-- ODONTOGRAMA C16 C17
ie_gerar_odonto_w			varchar(1) := 'N';
ds_procedimentos_w			varchar(4000);
ds_historicos_w				varchar(4000);
ds_odontologia_w			varchar(8000);

-- ORIENTACOES GERAIS c18
ds_orientacao_geral_w           text;
ds_orientacao_geral2_w          text;
dt_atualizacao_orientacao_w     pep_orientacao_geral.dt_atualizacao%type;
ie_orientacao_geral_w           varchar(2)  := 'N';

c01 CURSOR FOR
	SELECT  distinct
		dt_registro,
		substr(obter_desc_ciap(cd_ciap),1,255) ds_sintoma,
		nr_sequencia
	from    ciap_atendimento
	where   nr_seq_soap = nr_seq_soap_w
	and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and     ie_situacao = 'A';


c02 CURSOR FOR
	SELECT	qt_pa_sistolica pas,
		qt_pa_diastolica pad,
		qt_freq_cardiaca fc,
		qt_freq_resp fr,
		qt_temp temp,
		qt_peso peso,
		qt_altura_cm altura,
		qt_glicemia_capilar glic,
		ds_observacao obs,
		qt_perimetro_cefalico cefalico,
		qt_perimetro_toracico toracico,
		qt_perimitro_abdominal abdominal,
		ie_dinamica_uterina  dinamica,
		qt_au_cm altura_uterina,
		qt_contracoes contracoes,
		dt_sinal_vital
	from    atendimento_sinal_vital
	where   nr_seq_soap = nr_seq_soap_w
	and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and     ie_situacao = 'A';

c03 CURSOR FOR
	SELECT substr(ds_problema,1,255) ds_problema,
		   substr(obter_valor_dominio(8221,ie_status),1,255) ds_status,
		   CASE WHEN ie_intensidade='L' THEN obter_desc_expressao(331099) WHEN ie_intensidade='M' THEN obter_desc_expressao(293044)  ELSE obter_desc_expressao(487864) END  ds_intensidade
	from  lista_problema_pac
	where	nr_seq_soap = nr_seq_soap_w
	and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and 	ie_situacao = 'A';


c04 CURSOR FOR
	SELECT	nr_seq_escala,
		qt_pontos
	from	escala_eif_ii
	where	nr_seq_escuta = nr_seq_soap_w;


c05 CURSOR FOR
	SELECT cd_agenda,
		dt_agenda,
		ie_encaixe_urgencia,
		CASE WHEN ie_encaixe_urgencia='S' THEN obter_desc_expressao(719927)  ELSE obter_desc_expressao(327114) END  ds_encaixe_urgencia,
		nr_seq_agenda,
		obter_desc_horario_agenda(nr_seq_agenda)
	from atend_encaminhamento
	where nr_seq_soap = nr_seq_soap_w
	and	ie_tipo_encaminhamento = 'I'
	and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and ie_situacao = 'A';


c06 CURSOR FOR
	SELECT substr(mprev_obter_desc_programa(nr_seq_programa_saude),1,255) ds_programa_saude,
	       substr(mprev_obter_desc_campanha(NR_SEQ_CAMPANHA),1,255) ds_campanha
	from atend_programa_saude
	where nr_seq_soap = nr_seq_soap_w;


c07 CURSOR FOR
	SELECT substr(obter_nome_pf(cd_medico_dest),1,255) ds_medico_especialidade,
		substr(obter_desc_espec_medica(cd_especialidade),1,255) ds_especialidade
	from atend_encaminhamento
	where nr_seq_soap = nr_seq_soap_w
	and	ie_tipo_encaminhamento = 'E'
	and (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and ie_situacao = 'A';


c08 CURSOR FOR
	SELECT a.nr_sequencia,
		pkg_date_formaters.to_varchar(a.dt_inicio_receita, 'shortDate', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_inicio_receita,
		a.dt_validade_receita,
		substr(obter_desc_material(b.cd_material),1,255) ds_material,
		b.qt_dose,
		b.cd_unidade_medida,
		a.nr_dias_receita,
		a.nr_receita
	from fa_receita_farmacia a,
		fa_receita_farmacia_item b
	where a.nr_sequencia = b.nr_seq_receita
	and	a.nr_seq_soap = nr_seq_soap_w
	and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '');

	
c09 CURSOR FOR
	SELECT  substr(coalesce(Obter_Med_Exame_Externo(b.nr_sequencia),coalesce(b.DS_EXAME_SEM_CAD,substr(obter_descricao_procedimento(b.CD_PROCEDIMENTO,b.IE_ORIGEM_PROCED),1,240))),1,255) ds_procedimento,
		b.qt_exame,
		b.nr_seq_pedido,
		pkg_date_formaters.to_varchar(a.dt_solicitacao, 'shortDate', wheb_usuario_pck.get_cd_estabelecimento, wheb_usuario_pck.get_nm_usuario) dt_solicitacao
	from pedido_exame_externo a ,
		pedido_exame_externo_item b
	where a.nr_sequencia = b.nr_seq_pedido
	and	nr_seq_soap = nr_seq_soap_w
	and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and a.ie_situacao = 'A';


c10 CURSOR FOR
	SELECT a.cd_evolucao
	from atendimento_soap_vinc a,
	     evolucao_paciente b,
		 tipo_evolucao c
	where a.nr_seq_soap = nr_seq_soap_w
	and   a.cd_evolucao  = b.cd_evolucao
	and   b.ie_evolucao_clinica = c.cd_tipo_evolucao
	and (c.ie_evolucao_subjetivo = 'S' or c.ie_evolucao_avaliacao = 'S')
	and   (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
	and   b.ie_situacao = 'A';


c15 CURSOR FOR
	SELECT a.cd_evolucao
	from atendimento_soap_vinc a,
	     evolucao_paciente b,
		 tipo_evolucao c
	where a.nr_seq_soap = nr_seq_soap_w
	and  a.cd_evolucao  = b.cd_evolucao
	and   b.ie_evolucao_clinica = c.cd_tipo_evolucao
	and	  c.ie_evolucao_exame_fisico = 'S'
	and   (b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
	and   b.ie_situacao = 'A';


c16 CURSOR FOR
	SELECT	obter_resumo_odontologia(nr_sequencia, 'P') ds_procedimentos
	from	odont_consulta
	where	nr_seq_soap = nr_seq_soap_w
	and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and		ie_situacao = 'A';


c17 CURSOR FOR
	SELECT	obter_resumo_odontologia(nr_sequencia, 'H') ds_historicos
	from	odont_consulta
	where	nr_seq_soap = nr_seq_soap_w
	and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and		ie_situacao = 'A';


c18 CURSOR FOR
    SELECT 	dt_registro,
			ds_orientacao_geral
    from 	pep_orientacao_geral
    where 	nr_seq_soap = nr_seq_soap_w
    and 	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
    and 	ie_situacao = 'A';


c19 CURSOR FOR
    SELECT 	dt_receita,
			ds_receita
    from 	med_receita
    where 	nr_seq_soap = nr_seq_soap_w
    and 	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
    and 	ie_situacao = 'A';

	
c20 CURSOR FOR
    SELECT 	dt_atestado,
			ds_atestado
    from 	atestado_paciente
    where 	nr_seq_soap = nr_seq_soap_w
    and 	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
    and 	ie_situacao = 'A';


c21 CURSOR FOR
    SELECT 	dt_atualizacao_nrec,
			ds_motivo_consulta
    from 	parecer_medico_req
    where 	nr_seq_soap = nr_seq_soap_w
    and 	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
    and 	ie_situacao = 'A';

-- CPOE - Nutricao
c22 CURSOR FOR
	SELECT	cpoe_obter_ds_dieta(
			b.ie_tipo_dieta,
			b.cd_dieta,
			b.cd_material,
			b.cd_mat_prod1,
			b.nr_seq_tipo,
			b.dt_liberacao,
			'S',
			b.dt_lib_suspensao,
			b.dt_suspensao,
			b.ie_administracao,
			b.cd_intervalo,
			b.cd_unid_med_prod1,
			b.ie_via_leite1,
			b.qt_dose_prod1,
			b.cd_mat_prod2,
			b.cd_unid_med_prod2,
			b.qt_dose_prod2,
			b.cd_mat_prod3,
			b.cd_unid_med_prod3,
			b.qt_dose_prod3,
			b.cd_mat_prod4,
			b.cd_unid_med_prod4,
			b.qt_dose_prod4,
			b.cd_mat_prod5,
			b.cd_unid_med_prod5,
			b.qt_dose_prod5,
			b.ie_forma,
			b.qt_dose,
			b.cd_unidade_medida_dose) ds_item
	from	prescr_dieta a,
			cpoe_dieta b,
			prescr_medica c
	where	a.nr_seq_dieta_cpoe = b.nr_sequencia
	and		a.nr_prescricao = c.nr_prescricao
	and		coalesce(b.dt_lib_suspensao::text, '') = ''
	and		coalesce(b.dt_suspensao::text, '') = ''
	and		coalesce(c.dt_suspensao::text, '') = ''
	and		b.nr_seq_soap = nr_seq_soap_w
	and		b.ie_tipo_dieta = 'O'
	
union all

	SELECT	cpoe_obter_ds_dieta(c.ie_tipo_dieta,
			c.cd_dieta,
			c.cd_material,
			c.cd_mat_prod1,
			c.nr_seq_tipo,
			c.dt_liberacao,'S',
			c.dt_lib_suspensao,
			c.dt_suspensao,
			c.ie_administracao,
			c.cd_intervalo,
			c.cd_unid_med_prod1,
			c.ie_via_leite1,
			c.qt_dose_prod1,
			c.cd_mat_prod2,
			c.cd_unid_med_prod2,
			c.qt_dose_prod2,
			c.cd_mat_prod3,
			c.cd_unid_med_prod3,
			c.qt_dose_prod3,
			c.cd_mat_prod4,
			c.cd_unid_med_prod4,
			c.qt_dose_prod4,
			c.cd_mat_prod5,
			c.cd_unid_med_prod5,
			c.qt_dose_prod5,
			c.ie_forma,
			c.qt_dose,
			c.cd_unidade_medida_dose) ds_item
	from	prescr_medica a,
			prescr_material b,
			cpoe_dieta c
	where	a.nr_prescricao = b.nr_prescricao
	and		b.nr_seq_dieta_cpoe = c.nr_sequencia
	and		coalesce(c.dt_lib_suspensao::text, '') = ''
	and		coalesce(c.dt_suspensao::text, '') = ''
	and		coalesce(a.dt_suspensao::text, '') = ''
	and		c.nr_seq_soap = nr_seq_soap_w
	and		c.ie_tipo_dieta = 'E'
	
union all

	select	cpoe_obter_ds_dieta(c.ie_tipo_dieta,
			c.cd_dieta,
			c.cd_material,
			c.cd_mat_prod1,
			c.nr_seq_tipo,
			c.dt_liberacao,
			'S',
			c.dt_lib_suspensao,
			c.dt_suspensao,
			c.ie_administracao,
			c.cd_intervalo,
			c.cd_unid_med_prod1,
			c.ie_via_leite1,
			c.qt_dose_prod1,
			c.cd_mat_prod2,
			c.cd_unid_med_prod2,
			c.qt_dose_prod2,
			c.cd_mat_prod3,
			c.cd_unid_med_prod3,
			c.qt_dose_prod3,
			c.cd_mat_prod4,
			c.cd_unid_med_prod4,
			c.qt_dose_prod4,
			c.cd_mat_prod5,
			c.cd_unid_med_prod5,
			c.qt_dose_prod5,
			c.ie_forma,c.qt_dose,
			c.cd_unidade_medida_dose) ds_item
	from	prescr_medica a,
			prescr_material b,
			cpoe_dieta c
	where	a.nr_prescricao = b.nr_prescricao
	and		b.nr_seq_dieta_cpoe = c.nr_sequencia
	and		b.cd_material = c.cd_material
	and		coalesce(c.dt_lib_suspensao::text, '') = ''
	and		coalesce(c.dt_suspensao::text, '') = ''
	and		coalesce(a.dt_suspensao::text, '') = ''
	and		c.nr_seq_soap = nr_seq_soap_w
	and		c.ie_tipo_dieta = 'S'
	
union all

	select	cpoe_obter_ds_dieta(b.ie_tipo_dieta,
			b.cd_dieta,
			b.cd_material,
			b.cd_mat_prod1,
			b.nr_seq_tipo,
			b.dt_liberacao,
			'S',
			b.dt_lib_suspensao,
			b.dt_suspensao,
			b.ie_administracao,
			b.cd_intervalo,
			b.cd_unid_med_prod1,
			b.ie_via_leite1,
			b.qt_dose_prod1,
			b.cd_mat_prod2,
			b.cd_unid_med_prod2,
			b.qt_dose_prod2,
			b.cd_mat_prod3,
			b.cd_unid_med_prod3,
			b.qt_dose_prod3,
			b.cd_mat_prod4,
			b.cd_unid_med_prod4,
			b.qt_dose_prod4,
			b.cd_mat_prod5,
			b.cd_unid_med_prod5,
			b.qt_dose_prod5,
			b.ie_forma,
			b.qt_dose,
			b.cd_unidade_medida_dose) ds_item
	from	prescr_dieta a,
			cpoe_dieta b,
			prescr_medica c
	where	a.nr_seq_dieta_cpoe = b.nr_sequencia
	and		a.nr_prescricao = c.nr_prescricao
	and		coalesce(b.dt_lib_suspensao::text, '') = ''
	and		coalesce(b.dt_suspensao::text, '') = ''
	and		coalesce(c.dt_suspensao::text, '') = ''
	and		b.nr_seq_soap = nr_seq_soap_w
	and		b.ie_tipo_dieta = 'L'
	
union all

	select	cpoe_obter_ds_dieta(
			d.ie_tipo_dieta,
			d.cd_dieta,
			d.cd_material,
			d.cd_mat_prod1,
			d.nr_seq_tipo,
			d.dt_liberacao,
			'S',
			d.dt_lib_suspensao,
			d.dt_suspensao,
			d.ie_administracao,
			d.cd_intervalo,
			d.cd_unid_med_prod1,
			d.ie_via_leite1,
			d.qt_dose_prod1,
			d.cd_mat_prod2,
			d.cd_unid_med_prod2,
			d.qt_dose_prod2,
			d.cd_mat_prod3,
			d.cd_unid_med_prod3,
			d.qt_dose_prod3,
			d.cd_mat_prod4,
			d.cd_unid_med_prod4,
			d.qt_dose_prod4,
			d.cd_mat_prod5,
			d.cd_unid_med_prod5,
			d.qt_dose_prod5,
			d.ie_forma,
			d.qt_dose,
			d.cd_unidade_medida_dose) ds_item
	from	prescr_medica a,
			prescr_leite_deriv b,
			prescr_material c,
			cpoe_dieta d
	where	a.nr_prescricao = b.nr_prescricao
	and		a.nr_prescricao = c.nr_prescricao
	and		c.nr_seq_leite_deriv = b.nr_sequencia
	and		b.nr_seq_dieta_cpoe = d.nr_sequencia
	and		coalesce(d.dt_lib_suspensao::text, '') = ''
	and		coalesce(d.dt_suspensao::text, '') = ''
	and		coalesce(a.dt_suspensao::text, '') = ''
	and		d.nr_seq_soap = nr_seq_soap_w
	and		d.ie_tipo_dieta = 'L'
	
union all

	select	cpoe_obter_ds_dieta(
			a.ie_tipo_dieta,
			a.cd_dieta,
			a.cd_material,
			a.cd_mat_prod1,
			a.nr_seq_tipo,
			a.dt_liberacao,
			'S',
			a.dt_lib_suspensao,
			a.dt_suspensao,
			a.ie_administracao,
			a.cd_intervalo,
			a.cd_unid_med_prod1,
			a.ie_via_leite1,
			a.qt_dose_prod1,
			a.cd_mat_prod2,
			a.cd_unid_med_prod2,
			a.qt_dose_prod2,
			a.cd_mat_prod3,
			a.cd_unid_med_prod3,
			a.qt_dose_prod3,
			a.cd_mat_prod4,
			a.cd_unid_med_prod4,
			a.qt_dose_prod4,
			a.cd_mat_prod5,
			a.cd_unid_med_prod5,
			a.qt_dose_prod5,
			a.ie_forma,
			a.qt_dose,
			a.cd_unidade_medida_dose) ds_item
	from	cpoe_dieta a
	where coalesce(a.dt_lib_suspensao::text, '') = ''
	and   (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and		coalesce(a.dt_suspensao::text, '') = ''
	and		a.nr_seq_soap = 369
	and		a.ie_tipo_dieta in ('P', 'I')
	
union all

	select	cpoe_obter_ds_dieta(
			a.ie_tipo_dieta,
			a.cd_dieta,
			a.cd_material,
			a.cd_mat_prod1,
			a.nr_seq_tipo,
			a.dt_liberacao,
			'S',
			a.dt_lib_suspensao,
			a.dt_suspensao,
			a.ie_administracao,
			a.cd_intervalo,
			a.cd_unid_med_prod1,
			a.ie_via_leite1,
			a.qt_dose_prod1,
			a.cd_mat_prod2,
			a.cd_unid_med_prod2,
			a.qt_dose_prod2,
			a.cd_mat_prod3,
			a.cd_unid_med_prod3,
			a.qt_dose_prod3,
			a.cd_mat_prod4,
			a.cd_unid_med_prod4,
			a.qt_dose_prod4,
			a.cd_mat_prod5,
			a.cd_unid_med_prod5,
			a.qt_dose_prod5,
			a.ie_forma,
			a.qt_dose,
			a.cd_unidade_medida_dose) ds_item
	from	cpoe_dieta a,
			prescr_medica b,
			rep_jejum c
	where	a.nr_sequencia = c.nr_seq_dieta_cpoe
	and		b.nr_prescricao = c.nr_prescricao
	and		coalesce(a.dt_lib_suspensao::text, '') = ''
	and		coalesce(a.dt_suspensao::text, '') = ''
	and		a.nr_seq_soap = nr_seq_soap_w
	and		a.ie_tipo_dieta = 'J';

--CPOE - Medicamentos	
c23 CURSOR FOR
	SELECT  ds_item
	from (SELECT cpoe_obter_desc_info_material(
			c.cd_material,
			c.cd_mat_comp1,
			c.qt_dose_comp1,
			c.cd_unid_med_dose_comp1,
			c.cd_mat_comp2,
			c.qt_dose_comp2,
			c.cd_unid_med_dose_comp2,
			c.cd_mat_comp3,
			c.qt_dose_comp3,
			c.cd_unid_med_dose_comp3,
			c.cd_mat_dil,
			c.qt_dose_dil,
			c.cd_unid_med_dose_dil,
			c.cd_mat_red,
			c.qt_dose_red,
			c.cd_unid_med_dose_red,
			c.dt_liberacao,
			c.qt_dose,
			c.cd_unidade_medida,
			c.ie_via_aplicacao,
			c.cd_intervalo,
			c.dt_lib_suspensao,
			c.dt_suspensao,
			c.ie_administracao,
			c.nr_seq_ataque,
			c.nr_seq_procedimento,
			c.nr_seq_adicional,
			c.nr_seq_hemoterapia,
			c.ds_dose_diferenciada,
			c.ds_dose_diferenciada_dil,
			c.ds_dose_diferenciada_red,
			c.ds_dose_diferenciada_comp1,
			c.ds_dose_diferenciada_comp2,
			c.ds_dose_diferenciada_comp3,
			c.cd_mat_comp4,
			c.qt_dose_comp4,
			c.cd_unid_med_dose_comp4,
			c.ds_dose_diferenciada_comp4,
			c.cd_mat_comp5,
			c.qt_dose_comp5,
			c.cd_unid_med_dose_comp5,
			c.ds_dose_diferenciada_comp5,
			c.cd_mat_comp6,
			c.qt_dose_comp6,
			c.cd_unid_med_dose_comp6,
			c.ds_dose_diferenciada_comp6) ds_item
	   from	prescr_medica a,
			prescr_material b,
			cpoe_material c
		where	a.nr_prescricao = b.nr_prescricao
		and	b.nr_seq_mat_cpoe = c.nr_sequencia
		and	c.nr_seq_soap = nr_seq_soap_w
		and	coalesce(ie_material,'N') = 'N'
		and	b.ie_agrupador in (1,4)
		and	coalesce(a.dt_suspensao::text, '') = ''
		and	coalesce(c.dt_lib_suspensao::text, '') = ''
		and	coalesce(c.dt_suspensao::text, '') = '') alias6
	group by ds_item;

--CPOE - Exames e Procedimentos
c24 CURSOR FOR
	SELECT 	cpoe_obter_desc_grid_proc(
				substr(cpoe_obter_desc_proc_interno(c.nr_seq_proc_interno),1,255),
				c.cd_intervalo,
				c.qt_procedimento,
				c.cd_mat_proc1,
				c.qt_dose_mat1,
				c.cd_unid_medida_dose_mat1,
				c.ie_assoc_adep1,
				c.cd_mat_proc2,
				c.qt_dose_mat2,
				c.cd_unid_medida_dose_mat2,
				c.ie_assoc_adep2,
				c.cd_mat_proc3,
				c.qt_dose_mat3,
				c.cd_unid_medida_dose_mat3,
				c.ie_assoc_adep3,
				c.cd_mat_proc4,
				c.qt_dose_mat4,
				c.cd_unid_medida_dose_mat4,
				c.ie_assoc_adep4,
				c.cd_mat_proc5,
				c.qt_dose_mat5,
				c.cd_unid_medida_dose_mat5,
				c.ie_assoc_adep5,
				c.dt_lib_suspensao,
				c.dt_suspensao,
				c.ie_administracao,
				null,
				null,
				c.cd_mat_proc6,
				c.qt_dose_mat6,
				c.cd_unid_medida_dose_mat6,
				c.ie_assoc_adep6,
				c.cd_mat_proc7,
				c.qt_dose_mat7,
				c.cd_unid_medida_dose_mat7,
				c.ie_assoc_adep7) ds_item
	   from	prescr_medica a,
			prescr_procedimento b,
			cpoe_procedimento c
	  where	a.nr_prescricao = b.nr_prescricao
		and	b.nr_seq_proc_cpoe = c.nr_sequencia
		and	coalesce(a.dt_suspensao::text, '') = ''
		and	coalesce(c.dt_lib_suspensao::text, '') = ''
		and	coalesce(c.dt_suspensao::text, '') = ''
		and	c.nr_seq_soap = nr_seq_soap_w;

-- CPOE - Gasoterapia
c25 CURSOR FOR
	SELECT cpoe_obter_desc_grid_gas(
			  substr(cpoe_obter_desc_gas(c.nr_seq_gas,c.dt_liberacao),1,254),
			  c.qt_gasoterapia,
			  cpoe_obter_desc_unid_med_gas(c.ie_unidade_medida),
			  substr(obter_valor_dominio(1299, c.ie_respiracao),1,200),
			  substr(obter_desc_intervalo_prescr(c.cd_intervalo),1,255),
			  dt_lib_suspensao,
			  c.dt_suspensao,
			  ie_administracao) ds_gas
	from prescr_medica a,
		 prescr_gasoterapia b,
		 cpoe_gasoterapia c
   where a.nr_prescricao = b.nr_prescricao
	 and b.nr_seq_gas_cpoe = c.nr_sequencia
	 and c.nr_seq_soap = nr_seq_soap_w
	 and coalesce(a.dt_suspensao::text, '') = ''
	 and coalesce(c.dt_lib_suspensao::text, '') = ''
	 and coalesce(c.dt_suspensao::text, '') = ''
	 order by a.dt_prescricao desc;

-- CPOE - Recomendacoes	
c26 CURSOR FOR
	SELECT cpoe_obter_desc_grid_recom(
			   substr(cpoe_obter_desc_recomendacao(c.cd_recomendacao,c.dt_liberacao),1,255),
			   substr(obter_desc_intervalo_prescr(c.cd_intervalo),1,255),
			   dt_lib_suspensao,
			   c.dt_suspensao,
			   ie_administracao) ds_item
	from prescr_medica a,
		 prescr_recomendacao b,
		 cpoe_recomendacao c
	where a.nr_prescricao = b.nr_prescricao
	  and b.nr_seq_rec_cpoe = c.nr_sequencia
	  and c.nr_seq_soap = nr_seq_soap_w
	  and coalesce(a.dt_suspensao::text, '') = ''
	  and coalesce(c.dt_lib_suspensao::text, '') = ''
	  and coalesce(c.dt_suspensao::text, '') = '';

-- CPOE - Hemoterapia	
c27 CURSOR FOR
	SELECT substr(cpoe_obter_ds_hemoterapia(
					c.nr_sequencia,
					c.dt_liberacao,
					'S',
					c.dt_lib_suspensao,
					c.dt_suspensao,
					c.ie_tipo,
					c.qt_procedimento,
					c.ie_reserva),1,255) ds_item
	from prescr_medica a,
		 prescr_solic_bco_sangue b,
		 cpoe_hemoterapia c
	where a.nr_prescricao = b.nr_prescricao
	  and b.nr_seq_hemo_cpoe = c.nr_sequencia
	  and c.nr_seq_soap = nr_seq_soap_w
	  and coalesce(a.dt_suspensao::text, '') = ''
	  and coalesce(c.dt_lib_suspensao::text, '') = ''
	  and coalesce(c.dt_suspensao::text, '') = '';

-- CPOE - Dialise	
c28 CURSOR FOR
	SELECT cpoe_obter_desc_dialise(
				c.ie_tipo_dialise,
				c.nr_seq_protocolo,
				dt_lib_suspensao,
				c.dt_suspensao,
				c.qt_fluxo_sangue,
				qt_hora_min_sessao,null,c.ie_hemodialise) ds_dialise
	from prescr_medica a,
		 hd_prescricao b,
		 cpoe_dialise c
	where a.nr_prescricao = b.nr_prescricao
	  and c.nr_seq_soap = nr_seq_soap_w
	  and b.nr_seq_dialise_cpoe = c.nr_sequencia
	  and coalesce(a.dt_suspensao::text, '') = ''
	  and coalesce(c.dt_lib_suspensao::text, '') = ''
	  and coalesce(c.dt_suspensao::text, '') = ''
	order by a.dt_prescricao desc;
	
-- CPOE - Materiais	
c29 CURSOR FOR 
	SELECT cpoe_obter_desc_info_material(
				c.cd_material,
				c.cd_mat_comp1,
				c.qt_dose_comp1,
				c.cd_unid_med_dose_comp1,
				c.cd_mat_comp2,
				c.qt_dose_comp2,
				c.cd_unid_med_dose_comp2,
				c.cd_mat_comp3,
				c.qt_dose_comp3,
				c.cd_unid_med_dose_comp3,
				c.cd_mat_dil,
				c.qt_dose_dil,
				c.cd_unid_med_dose_dil,
				c.cd_mat_red,
				c.qt_dose_red,
				c.cd_unid_med_dose_red,
				c.dt_liberacao,
				c.qt_dose,
				c.cd_unidade_medida,
				c.ie_via_aplicacao,
				c.cd_intervalo,
				c.dt_lib_suspensao,
				c.dt_suspensao,
				c.ie_administracao,
				c.nr_seq_ataque,
				c.nr_seq_procedimento,
				c.nr_seq_adicional,
				c.nr_seq_hemoterapia,
				c.ds_dose_diferenciada,
				c.ds_dose_diferenciada_dil,
				c.ds_dose_diferenciada_red,
				c.ds_dose_diferenciada_comp1,
				c.ds_dose_diferenciada_comp2,
				c.ds_dose_diferenciada_comp3,
				c.cd_mat_comp4,
				c.qt_dose_comp4,
				c.cd_unid_med_dose_comp4,
				c.ds_dose_diferenciada_comp4,
				c.cd_mat_comp5,
				c.qt_dose_comp5,
				c.cd_unid_med_dose_comp5,
				c.ds_dose_diferenciada_comp5,
				c.cd_mat_comp6,
				c.qt_dose_comp6,
				c.cd_unid_med_dose_comp6,
				c.ds_dose_diferenciada_comp6) ds_item
	from prescr_medica a,
		 prescr_material b,
		 cpoe_material c
	where a.nr_prescricao = b.nr_prescricao
	  and b.nr_seq_mat_cpoe = c.nr_sequencia
	  and c.nr_seq_soap = nr_seq_soap_w
	  and ie_material = 'S'
	  and coalesce(a.dt_suspensao::text, '') = ''
	  and coalesce(c.dt_lib_suspensao::text, '') = ''
	  and coalesce(c.dt_suspensao::text, '') = '';

-- CPOE - Exames de anatomia patologica	
c30 CURSOR FOR 	
	SELECT cpoe_obter_desc_grid_proc(
				substr(cpoe_obter_desc_proc_interno(c.nr_seq_proc_interno),1,255),
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				null,
				c.dt_lib_suspensao,
				c.dt_suspensao,
				c.ie_administracao) ds_item
	from prescr_medica a,
		 prescr_procedimento b,
		 cpoe_anatomia_patologica c
   where a.nr_prescricao = b.nr_prescricao
	 and b.nr_seq_proc_cpoe = c.nr_sequencia
	 and coalesce(a.dt_suspensao::text, '') = ''
	 and coalesce(c.dt_lib_suspensao::text, '') = ''
	 and coalesce(c.dt_suspensao::text, '') = ''
	 and c.nr_seq_soap = nr_seq_soap_w;
	
--Solicitacao transf. externa	 
c31 CURSOR FOR
    SELECT 	a.dt_solicitacao,
			a.ds_observacao,
			b.ds_motivo
    from 	solic_transf_externa a,
			motivo_transf_externa b
    where 	a.nr_seq_motivo_solic_externa = b.nr_sequencia	  
	and     a.nr_seq_soap = nr_seq_soap_w
    and 	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

--Acolhimento - Sintoma   
c32 CURSOR FOR
	SELECT  distinct
			dt_registro,
			substr(obter_desc_ciap(cd_ciap),1,255) ds_sintoma,
			nr_sequencia
	from    ciap_atendimento
	where   nr_atendimento = nr_atendimento_p
	and		(nr_seq_escuta IS NOT NULL AND nr_seq_escuta::text <> '')
	and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and     ie_situacao = 'A';

--Acolhimento - Sinais vitais
c33 CURSOR FOR
	SELECT	qt_pa_sistolica pas,
			qt_pa_diastolica pad,
			qt_freq_cardiaca fc,
			qt_freq_resp fr,
			qt_temp temp,
			qt_peso peso,
			qt_altura_cm altura,
			qt_glicemia_capilar glic,
			ds_observacao obs,
			qt_perimetro_cefalico cefalico,
			qt_perimetro_toracico toracico,
			qt_perimitro_abdominal abdominal,
			ie_dinamica_uterina  dinamica,
			qt_au_cm altura_uterina,
			qt_contracoes contracoes,
			dt_sinal_vital
	from    atendimento_sinal_vital
	where   nr_atendimento = nr_atendimento_p
	and		(nr_seq_escuta IS NOT NULL AND nr_seq_escuta::text <> '')
	and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and     ie_situacao = 'A';
	

BEGIN
-- VERIFICA SE EXISTE REGISTRO DE SOAP PARA O ATENDIMENTO.
select max(nr_sequencia)
into STRICT	nr_seq_soap_w
from	atendimento_soap
where	nr_atendimento = nr_atendimento_p;


ds_fonte_w := Obter_Param_Usuario(281, 5, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ds_fonte_w);

ds_tam_fonte_w := Obter_Param_Usuario(281, 6, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ds_tam_fonte_w);

nr_tam_fonte_w := somente_numero(ds_tam_fonte_w) * 2;


if (nr_seq_soap_w > 0) then
	select	max(cd_pessoa_fisica),
		max(cd_profissional),
		max(dt_atualizacao_nrec)
	into STRICT cd_pessoa_fisica_w,
		 cd_profissional_w,
		 dt_soap_w

	from	atendimento_soap
	where	nr_atendimento = nr_atendimento_p;


	
	select	max(ie_tipo_evolucao)
	into STRICT	ie_tipo_evolucao_w
	from	usuario
	where	nm_usuario = nm_usuario_p;


	ds_idade_w := obter_idade_pf(cd_pessoa_fisica_w,clock_timestamp(),'EI');

	ds_sexo_w  := obter_sexo_pf(cd_pessoa_fisica_w,'C');


	if (coalesce(ie_tipo_evolucao_w::text, '') = '') then
		--Tipo de evolcao nao informado para este usuario.
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(264634);
	end if;


	ds_evolucao_w := ds_evolucao_w 	|| '<b>' ||  '<center>' || obter_desc_expressao(772847) || '</b>' ||chr(13)||chr(10);


	if (dt_soap_w IS NOT NULL AND dt_soap_w::text <> '') then
		ds_evolucao_w:= ds_evolucao_w ||obter_desc_expressao(780104) ||' : ' || to_char(dt_soap_w,'dd/mm/yyyy hh24:mi:ss') || chr(13) || chr(10);
	end if;


	-- VERIFICA SE DEVE SER GERADO AS INFORMACOES.
	select  coalesce(max('S'),'N')
	into STRICT	ie_gerar_sintoma_w
	from    ciap_atendimento
	where   nr_seq_soap = nr_seq_soap_w
	and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and     ie_situacao = 'A';


	select  coalesce(max('S'),'N')
	into STRICT	ie_gerar_sv_w
	from    atendimento_sinal_vital
	where   nr_seq_soap = nr_seq_soap_w
	and 	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and 	ie_situacao = 'A';


	select  coalesce(max(a.ie_avaliacao),'N'),
  coalesce(max(c.ie_evolucao_subjetivo),'N'),
  coalesce(max(c.ie_evolucao_avaliacao),'N')
	into STRICT	ie_gerar_descricao_w,
  ie_evolucao_subjetivo_w,
  ie_evolucao_avaliacao_w
	from	atendimento_soap_vinc a,
			evolucao_paciente b,
			tipo_evolucao c
	where 	a.nr_seq_soap = nr_seq_soap_w
	and   	a.cd_evolucao  = b.cd_evolucao
	and   	b.ie_evolucao_clinica = c.cd_tipo_evolucao
	and (c.ie_evolucao_subjetivo = 'S' or c.ie_evolucao_avaliacao = 'S')
	and   	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
	and   	b.ie_situacao = 'A';


	select  coalesce(max('S'),'N')
	into STRICT	ie_gerar_descricao_2w
	from	atendimento_soap_vinc a,
			evolucao_paciente b,
			tipo_evolucao c
	where 	a.nr_seq_soap = nr_seq_soap_w
	and 	a.cd_evolucao  = b.cd_evolucao
	and  	b.ie_evolucao_clinica = c.cd_tipo_evolucao
	and	  	c.ie_evolucao_exame_fisico = 'S'
	and   	(b.dt_liberacao IS NOT NULL AND b.dt_liberacao::text <> '')
	and   	b.ie_situacao = 'A';


	select	coalesce(max('S'),'N')
	into STRICT	ie_gerar_lista_problema_w
	from	lista_problema_pac
	where	nr_seq_soap = nr_seq_soap_w
	and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and 	ie_situacao = 'A';


	select  coalesce(max('S'),'N')
	into STRICT	ie_gerar_enc_espec_w
	from    atend_encaminhamento
	where   nr_seq_soap = nr_seq_soap_w
	and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and		ie_tipo_encaminhamento = 'E'
	and 	ie_situacao = 'A';


	select  coalesce(max('S'),'N')
	into STRICT	ie_gerar_enc_prog_saude_w
	from    atend_programa_saude
	where   nr_seq_soap = nr_seq_soap_w;


	select  coalesce(max('S'),'N')
	into STRICT	ie_gerar_enc_agendamento_w
	from    atend_encaminhamento
	where   nr_seq_soap = nr_seq_soap_w
	--and		cd_especialidade is not null
	and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and		ie_tipo_encaminhamento = 'I'
	and		ie_situacao = 'A';



	select coalesce(max('S'),'N')
	into STRICT	ie_gerar_procedimento_w
	from pedido_exame_externo a ,
		pedido_exame_externo_item b
	where a.nr_sequencia = b.nr_seq_pedido
	and	nr_seq_soap = nr_seq_soap_w
	and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and a.ie_situacao = 'A';


	select coalesce(max('S'),'N')
	into STRICT   ie_gerar_receita_w
	from fa_receita_farmacia a,
		fa_receita_farmacia_item b
	where a.nr_sequencia = b.nr_seq_receita
	and	a.nr_seq_soap = nr_seq_soap_w
	and (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '');


	select	coalesce(max('S'),'N')
	into STRICT	ie_gerar_odonto_w
	from	odont_consulta
	where	nr_seq_soap = nr_seq_soap_w
	and		ie_situacao = 'A';


	select	coalesce(max('S'),'N')
	into STRICT	ie_gerar_medreceita_w
	from	med_receita
	where	nr_seq_soap = nr_seq_soap_w
	and		ie_situacao = 'A';


	select	coalesce(max('S'),'N')
	into STRICT	ie_gerar_atestados_w
	from	atestado_paciente
	where	nr_seq_soap = nr_seq_soap_w
	and		ie_situacao = 'A';


  select	coalesce(max('S'),'N')
	into STRICT	ie_gerar_parecer_w
	from	parecer_medico_req
	where	nr_seq_soap = nr_seq_soap_w
	and		ie_situacao = 'A';


	select 	max(CD_TIPO_EVOLUCAO)
	into STRICT	ie_evolucao_clinica_w
	from	tipo_evolucao
	where	ie_evolucao_soap = 'S'
	and		ie_situacao = 'A';


    select  coalesce(max('S'), 'N')
    into STRICT    ie_orientacao_geral_w
    from    pep_orientacao_geral
    where   nr_seq_soap = nr_seq_soap_w
    and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
    and     ie_situacao = 'A';


    select  coalesce(max('S'), 'N')
    into STRICT    ie_gerar_dieta_w
    from    cpoe_dieta
    where   nr_seq_soap = nr_seq_soap_w
    and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
    and     coalesce(dt_lib_suspensao::text, '') = '';

	select  coalesce(max('S'), 'N')
    into STRICT    ie_gerar_dialise_w
    from    cpoe_dialise
    where   nr_seq_soap = nr_seq_soap_w
    and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
    and     coalesce(dt_lib_suspensao::text, '') = '';
	
	select  coalesce(max('S'), 'N')
    into STRICT    ie_gerar_medicamentos_w
    from    cpoe_material
    where   nr_seq_soap = nr_seq_soap_w
    and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
    and 	  ie_material <> 'S'
    and     coalesce(dt_lib_suspensao::text, '') = '';

	select  coalesce(max('S'), 'N')
    into STRICT    ie_gerar_procedimentos_w
    from    cpoe_procedimento
    where   nr_seq_soap = nr_seq_soap_w
    and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
    and     coalesce(dt_lib_suspensao::text, '') = '';
	
	select  coalesce(max('S'), 'N')
    into STRICT    ie_gerar_hemoterapia_w
    from    cpoe_hemoterapia
    where   nr_seq_soap = nr_seq_soap_w
    and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
    and     coalesce(dt_lib_suspensao::text, '') = '';
	
	select  coalesce(max('S'), 'N')
    into STRICT    ie_gerar_recomendacao_w
    from    cpoe_recomendacao
    where   nr_seq_soap = nr_seq_soap_w
    and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
    and     coalesce(dt_lib_suspensao::text, '') = '';
	
	select  coalesce(max('S'), 'N')
    into STRICT    ie_gerar_gasoterapia_w
    from    cpoe_gasoterapia
    where   nr_seq_soap = nr_seq_soap_w
    and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
    and     coalesce(dt_lib_suspensao::text, '') = '';
	
	select  coalesce(max('S'), 'N')
    into STRICT    ie_gerar_anat_patologica_w
    from    cpoe_anatomia_patologica
    where   nr_seq_soap = nr_seq_soap_w
    and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
    and     coalesce(dt_lib_suspensao::text, '') = '';
	
	select  coalesce(max('S'), 'N')
    into STRICT    ie_gerar_materiais_w
    from    cpoe_material
    where   nr_seq_soap = nr_seq_soap_w
    and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
    and 	  ie_material = 'S'
    and     coalesce(dt_lib_suspensao::text, '') = '';
	
	select  coalesce(max('S'), 'N')
    into STRICT    ie_gerar_transferencia_w
    from    solic_transf_externa
    where   nr_seq_soap = nr_seq_soap_w
    and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

   	select  coalesce(max('S'),'N')
	into STRICT	ie_gerar_sint_acolhi_w
	from    ciap_atendimento
	where   nr_atendimento = nr_atendimento_p
	and		(nr_seq_escuta IS NOT NULL AND nr_seq_escuta::text <> '')
	and		(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and     ie_situacao = 'A';

	select  coalesce(max('S'),'N')
	into STRICT	ie_gerar_sv_acolhi_w
	from    atendimento_sinal_vital
	where   nr_atendimento = nr_atendimento_p
	and		(nr_seq_escuta IS NOT NULL AND nr_seq_escuta::text <> '')
	and 	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
	and 	ie_situacao = 'A';

	if (ie_gerar_sint_acolhi_w = 'S') or (ie_gerar_sv_acolhi_w = 'S') then
		ds_evolucao_w := ds_evolucao_w 	|| '</br>' || '<b>' ||obter_desc_expressao(780075) || '</b>' || '</center>'; --Acolhimento
	end if;

	if (ie_gerar_sint_acolhi_w = 'S') then
		ds_sintomas_w :=   '<b>'|| obter_desc_expressao(298535)||'</b>'; --Sintoma do paciente
		open c32;
		
		loop
		fetch c32 into
			dt_reg_sintoma_w,
			ds_sintoma_w,
			nr_sequencia_sintoma_w;
		EXIT WHEN NOT FOUND; /* apply on c32 */
			begin
				if (dt_reg_sintoma_w IS NOT NULL AND dt_reg_sintoma_w::text <> '') then
					ds_sintomas_w := ds_sintomas_w  || chr(13)||chr(10) || obter_desc_expressao(286754) || ': ' || to_char(dt_reg_sintoma_w,'dd/mm/yyyy hh24:mi:ss');
				end if;

				if (ds_sintoma_w IS NOT NULL AND ds_sintoma_w::text <> '') then
					ds_sintomas_w := ds_sintomas_w || chr(13)||chr(10) || obter_desc_expressao(298534) || ': ' || ds_sintoma_w;
				end if;

				select ds_motivo_consulta_long
				into STRICT ds_obs_sintoma_w
				from ciap_atendimento
				where nr_sequencia = nr_sequencia_sintoma_w;

				if ((ds_obs_sintoma_w IS NOT NULL AND ds_obs_sintoma_w::text <> '') and ds_obs_sintoma_w <> ' ') then
					ds_sintomas_w := ds_sintomas_w || chr(13)||chr(10) || obter_desc_expressao(287493) || ': ' || ds_obs_sintoma_w;
				else
					ds_sintomas_w := ds_sintomas_w || chr(13)||chr(10);
				end if;
				ds_obs_sintoma_w := '';
			end;
		end loop;
		
		close c32;

		ds_evolucao_w :=  ds_evolucao_w || ds_sintomas_w;
		ds_sintomas_w := '';
	end if;

	if (ie_gerar_sv_acolhi_w = 'S') then
		ds_sinais_vitais_w := '</br>' || '<b>'|| obter_desc_expressao(298520)||'</b>'; --Sinais vitais
		open c33;

		loop
		fetch c33 into
		   qt_pa_sistolica_w,
		   qt_pa_dialostica_w,
		   qt_freq_cardia_w,
		   qt_freq_resp_w,
		   qt_temp_w,
           qt_peso_w,
		   qt_altura_cm_w,
		   qt_glicemia_capilar_w,
		   ds_obs_sv_w,
		   qt_perimetro_cefalico_w,
		   qt_perimetro_toracico_w,
		   qt_perimitro_abdominal_w,
		   ie_dinamica_uteria_w,
		   qt_au_cm_w,
		   qt_contracoes_w,
		   dt_sinal_vital_w;
		EXIT WHEN NOT FOUND; /* apply on c33 */
			begin
				if (dt_sinal_vital_w IS NOT NULL AND dt_sinal_vital_w::text <> '') then
					ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(286507)||': ' ||  to_char(dt_sinal_vital_w,'dd/mm/yyyy hh24:mi:ss');
				end if;

				if (qt_pa_sistolica_w IS NOT NULL AND qt_pa_sistolica_w::text <> '') then
					ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(295340)||': ' || qt_pa_sistolica_w;
				end if;
				
				if (qt_pa_dialostica_w IS NOT NULL AND qt_pa_dialostica_w::text <> '') then
					ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(295182) ||': ' || qt_pa_dialostica_w;
				end if;

				if (qt_freq_cardia_w IS NOT NULL AND qt_freq_cardia_w::text <> '') then
					ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(290038) ||': ' || qt_freq_cardia_w;
				end if;

				if (qt_freq_resp_w IS NOT NULL AND qt_freq_resp_w::text <> '') then
					ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(290454) ||': ' || qt_freq_resp_w;
				end if;
				
				if (qt_temp_w IS NOT NULL AND qt_temp_w::text <> '') then
					ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(299184) ||': ' || qt_temp_w;
				end if;
				
				if (qt_peso_w IS NOT NULL AND qt_peso_w::text <> '') then
					ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(295734)||': ' || qt_peso_w;
				end if;

				if (qt_altura_cm_w IS NOT NULL AND qt_altura_cm_w::text <> '') then
					ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(283402)||': ' ||  qt_altura_cm_w;
				end if;
				
				if (qt_glicemia_capilar_w IS NOT NULL AND qt_glicemia_capilar_w::text <> '') then
					ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(290915)||': ' ||  qt_glicemia_capilar_w;
				end if;				

				if (ds_obs_sv_w IS NOT NULL AND ds_obs_sv_w::text <> '') then
					ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(294639)||': ' ||  ds_obs_sv_w;
				end if;

				if (ds_idade_w = '1') then
					if (qt_perimetro_cefalico_w IS NOT NULL AND qt_perimetro_cefalico_w::text <> '') then
						ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(295496)||': ' ||  qt_perimetro_cefalico_w;
					end if;

					if (qt_perimetro_toracico_w IS NOT NULL AND qt_perimetro_toracico_w::text <> '') then
						ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(295497)||': ' ||  qt_perimetro_toracico_w;
					end if;

					if (qt_perimitro_abdominal_w IS NOT NULL AND qt_perimitro_abdominal_w::text <> '') then
						ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(716169)||': ' ||  qt_perimitro_abdominal_w;
					end if;			
				elsif (ds_sexo_w = 'F') then
					if (ie_dinamica_uteria_w IS NOT NULL AND ie_dinamica_uteria_w::text <> '') then
						ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(287953)||': ' ||  ie_dinamica_uteria_w;
					end if;

					if (qt_au_cm_w IS NOT NULL AND qt_au_cm_w::text <> '') then
						ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(283415)||': ' ||  qt_au_cm_w;
					end if;

					if (qt_contracoes_w IS NOT NULL AND qt_contracoes_w::text <> '') then
						ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(286127)||': ' ||  qt_contracoes_w;
					end if;
				end if;
			end;

			ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10);
		end loop;
		close c33;

		ds_evolucao_w :=  ds_evolucao_w || ds_sinais_vitais_w || chr(13)||chr(10);
		ds_sinais_vitais_w := '';
	end if;

	
	if (ie_gerar_sintoma_w = 'S') or (ie_gerar_descricao_w = 'S') then
	    if (ie_gerar_sint_acolhi_w = 'N') and (ie_gerar_sv_acolhi_w = 'N') then
			if (ie_evolucao_subjetivo_w = 'N' or ie_evolucao_avaliacao_w = 'S') then
				-- SUBJETIVO.
				ds_evolucao_w := ds_evolucao_w 	|| '</br>' || '<b>' ||obter_desc_expressao(1075217) || '</b>' || '</center>';
			 else
			   ds_evolucao_w := ds_evolucao_w 	|| '</br>' || '<b>' ||obter_desc_expressao(762198) || '</b>' || '</center>';
			 end if;
	   	else
		   if (ie_evolucao_subjetivo_w = 'N' or ie_evolucao_avaliacao_w = 'S') then
				ds_evolucao_w := ds_evolucao_w 	|| '<center>' || '<b>' ||obter_desc_expressao(1075217) || '</b>' || '</br>' || '</center>';
		   else
			  ds_evolucao_w := ds_evolucao_w 	|| '<center>' || '<b>' ||obter_desc_expressao(762198) || '</b>' || '</br>' || '</center>';
		   end if;
	    end if;
	end if;


	if (ie_gerar_sintoma_w = 'S') then
		ds_sintomas_w :=   '<b>'|| obter_desc_expressao(298535)||'</b>'; --Sintoma do paciente
		open c01;
		
		loop
		fetch c01 into
			dt_reg_sintoma_w,
			ds_sintoma_w,
			nr_sequencia_sintoma_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
			begin
				if (dt_reg_sintoma_w IS NOT NULL AND dt_reg_sintoma_w::text <> '') then
					ds_sintomas_w := ds_sintomas_w  || chr(13)||chr(10) || obter_desc_expressao(286754) || ': ' || to_char(dt_reg_sintoma_w,'dd/mm/yyyy hh24:mi:ss');
				end if;


				if (ds_sintoma_w IS NOT NULL AND ds_sintoma_w::text <> '') then
					ds_sintomas_w := ds_sintomas_w || chr(13)||chr(10) || obter_desc_expressao(298534) || ': ' || ds_sintoma_w;
				end if;


				select ds_motivo_consulta_long
				into STRICT ds_obs_sintoma_w
				from ciap_atendimento
				where nr_sequencia = nr_sequencia_sintoma_w;


				if ((ds_obs_sintoma_w IS NOT NULL AND ds_obs_sintoma_w::text <> '') and ds_obs_sintoma_w <> ' ') then
					ds_sintomas_w := ds_sintomas_w || chr(13)||chr(10) || obter_desc_expressao(287493) || ': ' || ds_obs_sintoma_w;
				else
					ds_sintomas_w := ds_sintomas_w || chr(13)||chr(10);
				end if;
			end;
		end loop;
		
		close c01;

		ds_evolucao_w :=  ds_evolucao_w || ds_sintomas_w;
	end if;


	if (ie_gerar_descricao_w = 'S') then
		ds_descricao_w := '</br>' || '<b>'|| obter_desc_expressao(289676)||'</b>'; --Nota clinica
		open c10;
		
		loop
		fetch c10 into
			cd_evolucao_ww;
		EXIT WHEN NOT FOUND; /* apply on c10 */
			begin
				select ds_evolucao, dt_evolucao
				into STRICT ds_registro_w, dt_registro_w
				from evolucao_paciente
				where cd_evolucao = cd_evolucao_ww;

				if (dt_registro_w IS NOT NULL AND dt_registro_w::text <> '') then
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10) || obter_desc_expressao(286754)||': ' || to_char(dt_registro_w,'dd/mm/yyyy hh24:mi:ss');
				end if;

				if ((ds_registro_w IS NOT NULL AND ds_registro_w::text <> '') and ds_registro_w <> ' ') then
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10) || obter_desc_expressao(625490) || ': ' || ds_registro_w;
				else
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10);
				end if;
			end;
		end loop;

		close c10;

		ds_evolucao_w :=  ds_evolucao_w || ds_descricao_w;
	end if;


	if (ie_gerar_sv_w = 'S') or (ie_gerar_descricao_2w = 'S') then
		-- OBJETIVO.
		ds_evolucao_w := ds_evolucao_w  || '<center>' || '<b>' ||obter_desc_expressao(294566) || '</b>' || '</br>' || '</center>';
	end if;

	if (ie_gerar_sv_w = 'S') then
		ds_sinais_vitais_w := '<b>'|| obter_desc_expressao(298520)||'</b>'; --Sinais vitais
		open c02;

		loop
		fetch c02 into
		   qt_pa_sistolica_w,
		   qt_pa_dialostica_w,
		   qt_freq_cardia_w,
		   qt_freq_resp_w,
		   qt_temp_w,
           qt_peso_w,
		   qt_altura_cm_w,
		   qt_glicemia_capilar_w,
		   ds_obs_sv_w,
		   qt_perimetro_cefalico_w,
		   qt_perimetro_toracico_w,
		   qt_perimitro_abdominal_w,
		   ie_dinamica_uteria_w,
		   qt_au_cm_w,
		   qt_contracoes_w,
		   dt_sinal_vital_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
				if (dt_sinal_vital_w IS NOT NULL AND dt_sinal_vital_w::text <> '') then
					ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(286507)||': ' ||  to_char(dt_sinal_vital_w,'dd/mm/yyyy hh24:mi:ss');
				end if;


				if (qt_pa_sistolica_w IS NOT NULL AND qt_pa_sistolica_w::text <> '') then
					ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(295340)||': ' || qt_pa_sistolica_w;
				end if;

				
				if (qt_pa_dialostica_w IS NOT NULL AND qt_pa_dialostica_w::text <> '') then
					ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(295182) ||': ' || qt_pa_dialostica_w;
				end if;


				if (qt_freq_cardia_w IS NOT NULL AND qt_freq_cardia_w::text <> '') then
					ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(290038) ||': ' || qt_freq_cardia_w;
				end if;


				if (qt_freq_resp_w IS NOT NULL AND qt_freq_resp_w::text <> '') then
					ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(290454) ||': ' || qt_freq_resp_w;
				end if;

				
				if (qt_temp_w IS NOT NULL AND qt_temp_w::text <> '') then
					ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(299184) ||': ' || qt_temp_w;
				end if;

				
				if (qt_peso_w IS NOT NULL AND qt_peso_w::text <> '') then
					ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(295734)||': ' || qt_peso_w;
				end if;


				if (qt_altura_cm_w IS NOT NULL AND qt_altura_cm_w::text <> '') then
					ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(283402)||': ' ||  qt_altura_cm_w;
				end if;

				
				if (qt_glicemia_capilar_w IS NOT NULL AND qt_glicemia_capilar_w::text <> '') then
					ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(290915)||': ' ||  qt_glicemia_capilar_w;
				end if;
				

				if (ds_obs_sv_w IS NOT NULL AND ds_obs_sv_w::text <> '') then
					ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(294639)||': ' ||  ds_obs_sv_w;
				end if;


				if (ds_idade_w = '1') then
					if (qt_perimetro_cefalico_w IS NOT NULL AND qt_perimetro_cefalico_w::text <> '') then
						ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(295496)||': ' ||  qt_perimetro_cefalico_w;
					end if;


					if (qt_perimetro_toracico_w IS NOT NULL AND qt_perimetro_toracico_w::text <> '') then
						ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(295497)||': ' ||  qt_perimetro_toracico_w;
					end if;


					if (qt_perimitro_abdominal_w IS NOT NULL AND qt_perimitro_abdominal_w::text <> '') then
						ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(716169)||': ' ||  qt_perimitro_abdominal_w;
					end if;			
				elsif (ds_sexo_w = 'F') then
					if (ie_dinamica_uteria_w IS NOT NULL AND ie_dinamica_uteria_w::text <> '') then
						ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(287953)||': ' ||  ie_dinamica_uteria_w;
					end if;


					if (qt_au_cm_w IS NOT NULL AND qt_au_cm_w::text <> '') then
						ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(283415)||': ' ||  qt_au_cm_w;
					end if;


					if (qt_contracoes_w IS NOT NULL AND qt_contracoes_w::text <> '') then
						ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10) || obter_desc_expressao(286127)||': ' ||  qt_contracoes_w;
					end if;
				end if;
			end;


			ds_sinais_vitais_w := ds_sinais_vitais_w ||chr(13)||chr(10);
		end loop;
		close c02;

		ds_evolucao_w :=  ds_evolucao_w || ds_sinais_vitais_w || chr(13)||chr(10);
	end if;


	if (ie_gerar_descricao_2w = 'S') then
		ds_descricao_2w :=  '<b>'|| obter_desc_expressao(289702)||'</b>';  --Exame fisico
		open c15;
		
		loop
		fetch c15 into
			cd_evolucao_ww;
		EXIT WHEN NOT FOUND; /* apply on c15 */
			begin
				select ds_evolucao, dt_evolucao
				into STRICT ds_registro_2w, dt_registro_2w
				from evolucao_paciente
				where cd_evolucao = cd_evolucao_ww;


				if (dt_registro_2w IS NOT NULL AND dt_registro_2w::text <> '') then
					ds_descricao_2w := ds_descricao_2w || chr(13)||chr(10) || obter_desc_expressao(761499)||': ' || to_char(dt_registro_2w,'dd/mm/yyyy hh24:mi:ss');
				end if;


				if ((ds_registro_2w IS NOT NULL AND ds_registro_2w::text <> '') and ds_registro_2w <> ' ') then
					ds_descricao_2w := ds_descricao_2w || chr(13)||chr(10) || obter_desc_expressao(625490) || ': ' || ds_registro_2w;
				else
					ds_descricao_2w := ds_descricao_2w || chr(13)||chr(10);
				end if;
			end;
		end loop;

		close c15;

		ds_evolucao_w :=  ds_evolucao_w || ds_descricao_2w;
	end if;


	if (ie_gerar_lista_problema_w = 'S') then
		-- AVALIACAO.
		ds_evolucao_w := ds_evolucao_w 	|| '<center>' || '<b>' || obter_desc_expressao(284091) || '</b>' || '</br>' || '</center>';
	end if;


	if (ie_gerar_lista_problema_w = 'S') then
		ds_problema_pac_w := null;
		open c03;
		
		loop
		fetch c03 into
			ds_problema_w,
			ds_status_problema_w,
			ds_intensidade_problema_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
			begin

			if (coalesce(ds_problema_pac_w::text, '') = '') then
				ds_problema_pac_w := '<b>' || obter_desc_expressao(656354) || '</b>'; --Lista de problemas
			else
				ds_problema_pac_w := ds_problema_pac_w || chr(13)||chr(10);
			end if;

			
			if (ds_problema_w IS NOT NULL AND ds_problema_w::text <> '') then
				ds_problema_pac_w := ds_problema_pac_w || chr(13)||chr(10) || obter_desc_expressao(296350) || ': ' || ds_problema_w;
			end if;


			if (ds_status_problema_w IS NOT NULL AND ds_status_problema_w::text <> '') then
				ds_problema_pac_w := ds_problema_pac_w || chr(13)||chr(10) || obter_desc_expressao(599703) || ': ' || ds_status_problema_w;
			end if;

			
			if (ds_intensidade_problema_w IS NOT NULL AND ds_intensidade_problema_w::text <> '') then
				ds_problema_pac_w := ds_problema_pac_w || chr(13)||chr(10) || obter_desc_expressao(292143) || ': ' || ds_intensidade_problema_w;
			end if;

			end;
		end loop;
		close c03;

		ds_evolucao_w :=  ds_evolucao_w || ds_problema_pac_w;

	end if;

	if (ie_gerar_enc_agendamento_w = 'S') or (ie_gerar_enc_prog_saude_w = 'S') or (ie_gerar_enc_espec_w = 'S') or (ie_gerar_procedimento_w = 'S') or (ie_gerar_odonto_w = 'S') or (ie_orientacao_geral_w = 'S') or (ie_gerar_medreceita_w = 'S') or (ie_gerar_atestados_w = 'S') or (ie_gerar_parecer_w = 'S') or (ie_gerar_dieta_w = 'S') or (ie_gerar_dialise_w = 'S') or (ie_gerar_medicamentos_w = 'S') or (ie_gerar_procedimentos_w = 'S') or (ie_gerar_hemoterapia_w = 'S') or (ie_gerar_recomendacao_w = 'S') or (ie_gerar_gasoterapia_w = 'S') or (ie_gerar_anat_patologica_w = 'S') or (ie_gerar_transferencia_w = 'S') or (ie_gerar_materiais_w = 'S') then
		-- PLANO.
		ds_evolucao_w := ds_evolucao_w || '<center>' || '<b>' || obter_desc_expressao(295945) || '</b>' || '</br>' || '</center>';
	end if;


	if (ie_gerar_odonto_w = 'S') then
		ds_evolucao_w :=  ds_evolucao_w || '<b>'|| obter_desc_expressao(487387) ||'</b>'; -- Odontologia
		ds_odontologia_w := null;
		open c16;
		
		loop
		fetch c16 into
			ds_procedimentos_w;
		EXIT WHEN NOT FOUND; /* apply on c16 */
			begin
				if (ds_procedimentos_w IS NOT NULL AND ds_procedimentos_w::text <> '') then
					ds_odontologia_w := ds_odontologia_w || chr(13) || chr(10) || ds_procedimentos_w;
				end if;
			end;
		end loop;
		
		close c16;

		ds_evolucao_w :=  ds_evolucao_w || ds_odontologia_w || chr(13)||chr(10);

		ds_odontologia_w := null;

		
		open c17;

		loop
		fetch c17 into
			ds_historicos_w;
		EXIT WHEN NOT FOUND; /* apply on c17 */
			begin
				if (ds_historicos_w IS NOT NULL AND ds_historicos_w::text <> '') then
					if (ds_odontologia_w IS NOT NULL AND ds_odontologia_w::text <> '') then
						ds_odontologia_w := ds_odontologia_w || chr(13) ||  chr(10);
					end if;

					ds_odontologia_w := ds_odontologia_w || ds_historicos_w;
				end if;
			end;
		end loop;

		close c17;

		ds_evolucao_w :=  ds_evolucao_w || ds_odontologia_w;
	end if;


	if (ie_gerar_enc_espec_w = 'S') then
		ds_enc_especialidade_w := null;
		open c07;
		
		loop
		fetch c07 into
			ds_medico_especialidade_w,
			ds_especialidade_w;
		EXIT WHEN NOT FOUND; /* apply on c07 */
			begin
			if (coalesce(ds_enc_especialidade_w::text, '') = '') then
				ds_enc_especialidade_w := ds_enc_especialidade_w || '<b>'|| obter_desc_expressao(317061) || ' - ' || obter_desc_expressao(10651941) ||'</b>'; -- Encaminhamentos - Especialidade
			else
				ds_enc_especialidade_w := ds_enc_especialidade_w ||chr(13)||chr(10);
			end if;


			if (ds_medico_especialidade_w IS NOT NULL AND ds_medico_especialidade_w::text <> '') then
				ds_enc_especialidade_w := ds_enc_especialidade_w ||chr(13)||chr(10) || obter_desc_expressao(325901) ||': ' || ds_medico_especialidade_w;
			end if;


			if (ds_especialidade_w IS NOT NULL AND ds_especialidade_w::text <> '') then
				ds_enc_especialidade_w := ds_enc_especialidade_w ||chr(13)||chr(10) || obter_desc_expressao(10651941) ||': ' || ds_especialidade_w;
			end if;


			end;
		end loop;

		close c07;

		ds_evolucao_w :=  ds_evolucao_w || chr(13)||chr(10) || ds_enc_especialidade_w;
	end if;


	if (ie_gerar_enc_agendamento_w = 'S') then
		ds_enc_agendamento_w := ds_enc_agendamento_w 	|| '</br><b>'|| obter_desc_expressao(317061) || ' - ' || obter_desc_expressao(302532) ||'</b>';    -- Encaminhamentos - Agendamento
		open c05;

		loop
		fetch c05 into
			cd_agenda_w,
			dt_agenda_w,
			ie_encaixe_urgencia_w,
			ds_encaixe_urgencia_w,
			nr_seq_agenda_w,
			ds_horario_agendamento_w;
		EXIT WHEN NOT FOUND; /* apply on c05 */
			begin
			select substr(CASE WHEN(select max(b.cd_tipo_agenda) from agenda b where b.cd_agenda = cd_agenda_w)=3 THEN  substr(obter_nome_medico_combo_agcons(wheb_usuario_pck.get_cd_estabelecimento, cd_agenda_w, (select max(b.cd_tipo_agenda) from agenda b where b.cd_agenda = cd_agenda_w), null),1,255)  ELSE OBTER_DESC_AGENDA(cd_agenda_w) END ,1,240)
			into STRICT ds_agenda_w
			;


			if (ie_encaixe_urgencia_w = 'S') then
				ds_enc_agendamento_w := ds_enc_agendamento_w || chr(13)||chr(10) || obter_desc_expressao(283242) ||': ' || ds_agenda_w || ' - ' || obter_desc_expressao(789373);
			else
				if (dt_agenda_w IS NOT NULL AND dt_agenda_w::text <> '') and (ds_agenda_w IS NOT NULL AND ds_agenda_w::text <> '') then
						ds_enc_agendamento_w := ds_enc_agendamento_w || chr(13)||chr(10) || obter_desc_expressao(283242) ||': ' || ds_agenda_w || '</br>' || obter_desc_expressao(327181)||': ' || ds_horario_agendamento_w;
				end if;
			end if;
			end;

			ds_enc_agendamento_w := ds_enc_agendamento_w || chr(13)||chr(10);
		end loop;

		close c05;

		ds_evolucao_w :=  ds_evolucao_w || chr(13)||chr(10);
		ds_evolucao_w :=  ds_evolucao_w || ds_enc_agendamento_w || chr(13)||chr(10);
	end if;


    if (ie_orientacao_geral_w = 'S') then
		ds_orientacao_geral_w := ds_orientacao_geral_w || '</br><b>' || obter_desc_expressao(314145) || '</b>'; -- Orientacoes gerais
		open C18;

		loop
		fetch C18 into
			dt_registro_w,
			ds_orientacao_geral2_w;
		EXIT WHEN NOT FOUND; /* apply on C18 */
			begin

			if (dt_registro_w IS NOT NULL AND dt_registro_w::text <> '') then
				ds_orientacao_geral_w := ds_orientacao_geral_w ||chr(13)||chr(10) || obter_desc_expressao(286507)||': ' ||  to_char(dt_registro_w,'dd/mm/yyyy hh24:mi:ss');
			end if;


			if (ds_orientacao_geral2_w IS NOT NULL AND ds_orientacao_geral2_w::text <> '') then
				ds_orientacao_geral_w := ds_orientacao_geral_w || ds_orientacao_geral2_w;
			end if;
			end;
		end loop;

		close C18;

	ds_evolucao_w :=  ds_evolucao_w || ds_orientacao_geral_w;
    end if;


	if (ie_gerar_enc_prog_saude_w = 'S') then
		ds_evolucao_w := ds_evolucao_w 	|| '<b>'|| obter_desc_expressao(317061) || ' - ' || obter_desc_expressao(781448) ||'</b>';
		open c06;

		loop
		fetch c06 into
			ds_programa_saude_w,
			ds_campanha_w;
		EXIT WHEN NOT FOUND; /* apply on c06 */
			begin
			if (ds_programa_saude_w IS NOT NULL AND ds_programa_saude_w::text <> '') then
				ds_enc_prog_saude_w := ds_enc_prog_saude_w || obter_desc_expressao(787139) ||': ' || ds_programa_saude_w;
				ds_enc_prog_saude_w := ds_enc_prog_saude_w || chr(13)||chr(10);
			end if;


			if (ds_campanha_w IS NOT NULL AND ds_campanha_w::text <> '') then
				ds_enc_prog_saude_w := ds_enc_prog_saude_w || obter_desc_expressao(284484) ||': ' || ds_campanha_w;
			end if;

			ds_enc_prog_saude_w := ds_enc_prog_saude_w || chr(13)||chr(10);
			end;
		end loop;

		close c06;

		ds_evolucao_w :=  ds_evolucao_w || chr(13)||chr(10);

		ds_evolucao_w :=  ds_evolucao_w || ds_enc_prog_saude_w || chr(13)||chr(10);
	end if;


	if (ie_gerar_medreceita_w = 'S') then
		ds_descricao_w := '</br>' || '<b>'|| obter_desc_expressao(307861)||'</b>'; --Receitas
		open c19;
		
		loop
		fetch c19 into
			dt_medreceita_w,
			ds_medreceita_w;
		EXIT WHEN NOT FOUND; /* apply on c19 */
			begin
				if (dt_medreceita_w IS NOT NULL AND dt_medreceita_w::text <> '') then		--Data da receita:
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10) || obter_desc_expressao(286754)||': ' || to_char(dt_medreceita_w,'dd/mm/yyyy hh24:mi:ss');
				end if;


				if ((ds_medreceita_w IS NOT NULL AND ds_medreceita_w::text <> '') and ds_medreceita_w <> ' ') then
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10) || ds_medreceita_w;
				else
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10);
				end if;
			end;
		end loop;
		close c19;

		ds_evolucao_w :=  ds_evolucao_w || ds_descricao_w;
	end if;

	
  if (ie_gerar_atestados_w = 'S') then
		ds_descricao_w := '</br>' || '<b>'|| obter_desc_expressao(314299)||'</b>'; --Atestados
		open c20;

		loop
		fetch c20 into
			dt_atestado_w,
			ds_atestado_w;
		EXIT WHEN NOT FOUND; /* apply on c20 */
			begin
				if (dt_atestado_w IS NOT NULL AND dt_atestado_w::text <> '') then		--Data atestado:
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10) || obter_desc_expressao(286566)||': ' || to_char(dt_atestado_w,'dd/mm/yyyy hh24:mi:ss');
				end if;


				if ((ds_atestado_w IS NOT NULL AND ds_atestado_w::text <> '') and ds_atestado_w <> ' ') then
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10) || ds_atestado_w;
				else
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10);
				end if;
			end;
		end loop;
		close c20;

		ds_evolucao_w :=  ds_evolucao_w || ds_descricao_w;
	end if;


  if (ie_gerar_parecer_w = 'S') then
		ds_descricao_w := '</br>' || '<b>'|| obter_desc_expressao(828825)||'</b>'; --Parecer Medico
		open c21;

		loop
		fetch c21 into
			dt_parecer_w,
			ds_parecer_w;
		EXIT WHEN NOT FOUND; /* apply on c21 */
			begin
				if (dt_parecer_w IS NOT NULL AND dt_parecer_w::text <> '') then		--Data do parecer:
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10) || obter_desc_expressao(719993)||': ' || to_char(dt_parecer_w,'dd/mm/yyyy hh24:mi:ss');
				end if;


				if ((ds_parecer_w IS NOT NULL AND ds_parecer_w::text <> '') and ds_parecer_w <> ' ') then
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10) || ds_parecer_w;
				else
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10);
				end if;
			end;
		end loop;

		close c21;

		ds_evolucao_w :=  ds_evolucao_w || ds_descricao_w;
	end if;

	
	if (ie_gerar_receita_w = 'S') then
		ds_receita_w := ds_receita_w || '<b>'|| obter_desc_expressao(314086) || '</b>';
		open c08;

		loop
		fetch c08 into
			nr_seq_receita_w,
			dt_inicio_receita_w,
			dt_fim_receita_w,
			ds_medic_rec_w,
			qt_dose_rec_w,
			cd_unidade_medida_rec_w,
			nr_dias_receita_w,
			nr_receita_w;
		EXIT WHEN NOT FOUND; /* apply on c08 */
			begin
			if (nr_seq_receita_old_w <> nr_seq_receita_w) then
					ds_receita_w := ds_receita_w || '</br>' || obter_desc_expressao(297315) ||': ' || nr_receita_w || ' - ' ||
					obter_desc_expressao(782876) ||': ' || dt_inicio_receita_w || ' - ' ||
					obter_desc_expressao(688617) ||': ' || dt_fim_receita_w || ' - ' ||
					obter_desc_expressao(287753) ||': ' || nr_dias_receita_w || chr(13)|| chr(10);
			end if;


			ds_receita_w := ds_receita_w ||  ds_medic_rec_w ||'   '|| qt_dose_rec_w  || cd_unidade_medida_rec_w;
			ds_receita_w := ds_receita_w || chr(13)||chr(10);
			nr_seq_receita_old_w := nr_seq_receita_w;
			end;

		end loop;
		close c08;


		ds_evolucao_w :=  ds_evolucao_w || ds_receita_w || chr(13)||chr(10);
	end if;


	if (ie_gerar_procedimento_w = 'S') then
		ds_proc_exam_cir_w := null;
		open c09;

		loop
		fetch c09 into
			ds_proced_w,
			qt_proced_w,
			nr_seq_pedido_w,
			ds_solicitacao_w;
		EXIT WHEN NOT FOUND; /* apply on c09 */
			begin
			if (nr_seq_pedido_old_w <> nr_seq_pedido_w) then
				if (coalesce(ds_proc_exam_cir_w::text, '') = '') then
					ds_proc_exam_cir_w := ds_proc_exam_cir_w || '<b>'|| obter_desc_expressao(631190) ||'</b> </br>';
				else
					ds_proc_exam_cir_w := ds_proc_exam_cir_w || chr(13)||chr(10);
				end if;
				ds_proc_exam_cir_w := ds_proc_exam_cir_w || obter_desc_expressao(287230) || ': ' || ds_solicitacao_w || chr(13)||chr(10); -- Data solicitacao
			end if;


			if (ds_proced_w IS NOT NULL AND ds_proced_w::text <> '') then
				ds_proc_exam_cir_w := ds_proc_exam_cir_w || obter_desc_expressao(720319) ||': ' || ds_proced_w ||' - ' || obter_desc_expressao(701494) ||': ' || qt_proced_w ||  chr(13)||chr(10);
			end if;


			nr_seq_pedido_old_w := nr_seq_pedido_w;
			end;
		end loop;
		close c09;

		ds_evolucao_w :=  ds_evolucao_w || ds_proc_exam_cir_w;
	end if;
	
	if (ie_gerar_dieta_w = 'S') then
		ds_descricao_w := '</br>' || '<b>'|| obter_desc_expressao(294515)||'</b>'; --Nutricao
		open c22;

		loop
		fetch c22 into
			ds_dieta_w;
		EXIT WHEN NOT FOUND; /* apply on c22 */
			begin
			
			if ((ds_dieta_w IS NOT NULL AND ds_dieta_w::text <> '') and ds_dieta_w <> ' ') then
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10) || ds_dieta_w;
				else
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10);
				end if;
			end;
		end loop;
		close c22;

		ds_evolucao_w :=  ds_evolucao_w || ds_descricao_w;
	end if;
	
	if (ie_gerar_medicamentos_w = 'S') then
		ds_descricao_w := '</br></br>' || '<b>'|| obter_desc_expressao(341573)||'</b>'; --Solucoes e medicamentos
		open c23;

		loop
		fetch c23 into
			ds_medicamentos_w;
		EXIT WHEN NOT FOUND; /* apply on c23 */
			begin
			
			if ((ds_medicamentos_w IS NOT NULL AND ds_medicamentos_w::text <> '') and ds_medicamentos_w <> ' ') then
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10) || ds_medicamentos_w;
				else
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10);
				end if;
			end;
		end loop;
		close c23;

		ds_evolucao_w :=  ds_evolucao_w || ds_descricao_w;
	end if;
	
	if (ie_gerar_procedimentos_w = 'S') then
		ds_descricao_w := '</br></br>' || '<b>'|| obter_desc_expressao(614206)||'</b>'; --Exames e Procedimentos
		open c24;

		loop
		fetch c24 into
			ds_procedimentos_cpoe_w;
		EXIT WHEN NOT FOUND; /* apply on c24 */
			begin
			
			if ((ds_procedimentos_cpoe_w IS NOT NULL AND ds_procedimentos_cpoe_w::text <> '') and ds_procedimentos_cpoe_w <> ' ') then
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10) || ds_procedimentos_cpoe_w;
				else
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10);
				end if;
			end;
		end loop;
		close c24;

		ds_evolucao_w :=  ds_evolucao_w || ds_descricao_w;
	end if;
	
	if (ie_gerar_gasoterapia_w = 'S') then
		ds_descricao_w := '</br></br>' || '<b>'|| obter_desc_expressao(290567)||'</b>'; --Gasoterapia
		open c25;

		loop
		fetch c25 into
			ds_gasoterapia_w;
		EXIT WHEN NOT FOUND; /* apply on c25 */
			begin
			
			if ((ds_gasoterapia_w IS NOT NULL AND ds_gasoterapia_w::text <> '') and ds_gasoterapia_w <> ' ') then
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10) || ds_gasoterapia_w;
				else
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10);
				end if;
			end;
		end loop;
		close c25;

		ds_evolucao_w :=  ds_evolucao_w || ds_descricao_w;
	end if;
	
	if (ie_gerar_recomendacao_w = 'S') then
		ds_descricao_w := '</br></br>' || '<b>'|| obter_desc_expressao(297348)||'</b>'; --Recomendacoes
		open c26;

		loop
		fetch c26 into
			ds_recomendacao_w;
		EXIT WHEN NOT FOUND; /* apply on c26 */
			begin
			
			if ((ds_recomendacao_w IS NOT NULL AND ds_recomendacao_w::text <> '') and ds_recomendacao_w <> ' ') then
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10) || ds_recomendacao_w;
				else
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10);
				end if;
			end;
		end loop;
		close c26;

		ds_evolucao_w :=  ds_evolucao_w || ds_descricao_w;
	end if;

	if (ie_gerar_hemoterapia_w = 'S') then
		ds_descricao_w := '</br></br>' || '<b>'|| obter_desc_expressao(291262)||'</b>'; --Hemoterapia
		open c27;

		loop
		fetch c27 into
			ds_hemoterapia_w;
		EXIT WHEN NOT FOUND; /* apply on c27 */
			begin
			
			if ((ds_hemoterapia_w IS NOT NULL AND ds_hemoterapia_w::text <> '') and ds_hemoterapia_w <> ' ') then
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10) || ds_hemoterapia_w;
				else
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10);
				end if;
			end;
		end loop;
		close c27;

		ds_evolucao_w :=  ds_evolucao_w || ds_descricao_w;
	end if;
	
	if (ie_gerar_dialise_w = 'S') then
		ds_descricao_w := '</br></br>' || '<b>'|| obter_desc_expressao(287725)||'</b>'; --Dialise
		open c28;

		loop
		fetch c28 into
			ds_dialise_w;
		EXIT WHEN NOT FOUND; /* apply on c28 */
			begin
			
			if ((ds_dialise_w IS NOT NULL AND ds_dialise_w::text <> '') and ds_dialise_w <> ' ') then
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10) || ds_dialise_w;
				else
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10);
				end if;
			end;
		end loop;
		close c28;

		ds_evolucao_w :=  ds_evolucao_w || ds_descricao_w;
	end if;
	
	if (ie_gerar_materiais_w = 'S') then
		ds_descricao_w := '</br></br>' || '<b>'|| obter_desc_expressao(292949)||'</b>'; --Materiais
		open c29;

		loop
		fetch c29 into
			ds_materiais_w;
		EXIT WHEN NOT FOUND; /* apply on c29 */
			begin
			
			if ((ds_materiais_w IS NOT NULL AND ds_materiais_w::text <> '') and ds_materiais_w <> ' ') then
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10) || ds_materiais_w;
				else
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10);
				end if;
			end;
		end loop;
		close c29;

		ds_evolucao_w :=  ds_evolucao_w || ds_descricao_w;
	end if;
	
	if (ie_gerar_anat_patologica_w = 'S') then
		ds_descricao_w := '</br></br>' || '<b>'|| obter_desc_expressao(283458)||'</b>'; --Anatomia Patologica
		open c30;

		loop
		fetch c30 into
			ds_anat_patologica_w;
		EXIT WHEN NOT FOUND; /* apply on c30 */
			begin
			
			if ((ds_anat_patologica_w IS NOT NULL AND ds_anat_patologica_w::text <> '') and ds_anat_patologica_w <> ' ') then
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10) || ds_anat_patologica_w;
				else
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10);
				end if;
			end;
		end loop;
		close c30;

		ds_evolucao_w :=  ds_evolucao_w || ds_descricao_w;
	end if;
	
	if (ie_gerar_transferencia_w = 'S') then
		ds_descricao_w := '</br></br>' || '<b>'|| obter_desc_expressao(314618)||'</b>'; --Solicitacao de Transferencia Externa
		open c31;

		loop
		fetch c31 into
			dt_solicitacao_w,
			ds_observacao_w,
			ds_motivo;
		EXIT WHEN NOT FOUND; /* apply on c31 */
			begin
				if (dt_solicitacao_w IS NOT NULL AND dt_solicitacao_w::text <> '') then		--Data do Registro:
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10) || obter_desc_expressao(761499)||': ' || to_char(dt_solicitacao_w,'dd/mm/yyyy hh24:mi:ss');
				end if;


				if ((ds_motivo IS NOT NULL AND ds_motivo::text <> '') and ds_motivo <> ' ') then --motivo da transferencia
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10) || obter_desc_expressao(325609)||': ' || ds_motivo;
				else
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10);
				end if;
				
				if ((ds_observacao_w IS NOT NULL AND ds_observacao_w::text <> '') and ds_observacao_w <> ' ') then -- observacao
					ds_descricao_w := ds_descricao_w || chr(13)||chr(10) || obter_desc_expressao(294639) || ': ' || ds_observacao_w || '</br>';
				else
					ds_descricao_w := ds_descricao_w || '</br>' || chr(13) || chr(10);
				end if;
			end;
		end loop;
		close c31;

		ds_evolucao_w :=  ds_evolucao_w || ds_descricao_w;
	end if;
	
	ds_conteudo_w	:= replace(ds_evolucao_w, chr(13)||chr(10), ' <br> ');

	if (ie_evolucao_clinica_w IS NOT NULL AND ie_evolucao_clinica_w::text <> '') then
		select	max(a.cd_evolucao)
		into STRICT	cd_evolucao_w
		from	evolucao_paciente a,
				evolucao_paciente_vinculo b
		where	a.cd_evolucao = b.cd_evolucao
		and		b.nr_seq_registro = nr_seq_soap_w
		and		b.ie_tipo_item = 'SOAP'
    and coalesce(a.NR_SEQ_AVALIACAO::text, '') = ''
		and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
		and		coalesce(a.dt_inativacao::text, '') = '';


		if (cd_evolucao_w IS NOT NULL AND cd_evolucao_w::text <> '') then
			update	evolucao_paciente
			set		ds_evolucao = ds_conteudo_w,
					dt_atualizacao = clock_timestamp()
			where 	cd_evolucao = cd_evolucao_w;

			commit;
		else
			select	nextval('evolucao_paciente_seq')
			into STRICT	cd_evolucao_w
			;


			insert into evolucao_paciente(
					cd_evolucao,
					dt_evolucao,
					ie_tipo_evolucao,
					cd_pessoa_fisica,
					dt_atualizacao,
					nm_usuario,
					nr_atendimento,
					ds_evolucao,
					cd_medico,
					dt_liberacao,
					ie_evolucao_clinica,
					ie_situacao,
					IE_NIVEL_ATENCAO)
				values (cd_evolucao_w,
						clock_timestamp(),
						ie_tipo_evolucao_w,
						cd_pessoa_fisica_w,
						clock_timestamp(),
						nm_usuario_p,
						nr_atendimento_p,
						ds_conteudo_w,
						cd_profissional_w,
						clock_timestamp(),
						ie_evolucao_clinica_w,
						'A',
						'P');
						commit;


			if (nr_seq_soap_w > 0) then
				CALL gerar_evolucao_vinculo(nr_seq_soap_w,cd_evolucao_w,'SOAP');
			end if;
		end if;

		cd_evolucao_p := cd_evolucao_w;
	end if;
end if;

end;

$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_evolucao_soap (nr_atendimento_p bigint, nm_usuario_p text, cd_evolucao_p INOUT bigint) FROM PUBLIC;

