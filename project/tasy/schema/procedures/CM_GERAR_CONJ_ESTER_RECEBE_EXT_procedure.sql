-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cm_gerar_conj_ester_recebe_ext ( nr_seq_recebimento_p bigint, cd_setor_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_opcao_p text) AS $body$
DECLARE


nr_seq_conjunto_w		bigint;
qt_conjunto_w			bigint;
qt_cont_w			bigint;
nr_seq_embalagem_w		bigint;
qt_ponto_w			double precision;
nr_seq_cont_w			bigint;
ds_observacao_w			varchar(2000);
ds_conj_cont_w			varchar(255);
nr_controle_w			bigint;
cd_medico_w			varchar(10);
cd_setor_atendimento_w		integer;
cd_local_estoque_w		smallint;
cd_pessoa_nota_w		varchar(20);
cd_cnpj_w			varchar(14);

c01 CURSOR FOR
	SELECT	nr_seq_conjunto,
		qt_conj_receb
	from	cm_receb_externo_conj
	where	nr_seq_receb_externo = nr_seq_recebimento_p;


BEGIN

if (coalesce(ie_opcao_p,'G') = 'G') then
	begin
	select	coalesce(max(cd_local_estoque),0),
		coalesce(max(cd_pessoa_nota),'0'),
		coalesce(max(cd_cnpj),'0')
	into STRICT	cd_local_estoque_w,
		cd_pessoa_nota_w,
		cd_cnpj_w
	from	cm_receb_externo
	where	nr_sequencia = nr_seq_recebimento_p;

	open c01;
	loop
	fetch c01 into
		nr_seq_conjunto_w,
		qt_conjunto_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		qt_cont_w	:= 0;

		select 	nr_seq_embalagem,
			coalesce(qt_ponto,0)
		into STRICT	nr_seq_embalagem_w,
			qt_ponto_w
		from	cm_conjunto
		where	nr_sequencia = nr_seq_conjunto_w;

		while(qt_cont_w < qt_conjunto_w) loop
			begin

			select	nextval('cm_conjunto_cont_seq')
			into STRICT	nr_seq_cont_w
			;

			select 	coalesce(max(nr_seq_controle),0) + 1
			into STRICT	nr_controle_w
			from 	cm_conjunto_cont;

			insert into cm_conjunto_cont(
				nr_sequencia,				cd_estabelecimento,
				nr_seq_conjunto,			dt_atualizacao,
				nm_usuario,				ie_status_conjunto,
				dt_origem,				nm_usuario_origem,
				nr_seq_embalagem,			dt_receb_ester,
				nm_usuario_ester,			cd_pessoa_fisica,
				cd_cgc,					cd_local_estoque,
				qt_ponto,				vl_esterilizacao,
				nr_seq_controle,			ie_situacao,
				nr_seq_receb_ext,			cd_setor_atendimento,
				ds_observacao)
			values (nr_seq_cont_w,				cd_estabelecimento_p,
				nr_seq_conjunto_w,			clock_timestamp(),
				nm_usuario_p,				1,
				clock_timestamp(),				nm_usuario_p,
				nr_seq_embalagem_w,			clock_timestamp(),
				nm_usuario_p,				CASE WHEN cd_pessoa_nota_w='0' THEN null  ELSE cd_pessoa_nota_w END ,
				CASE WHEN cd_cnpj_w='0' THEN null  ELSE cd_cnpj_w END ,	CASE WHEN cd_local_estoque_w=0 THEN null  ELSE cd_local_estoque_w END ,
				qt_ponto_w,				0,
				nr_controle_w,				'A',
				nr_seq_recebimento_p,			cd_setor_p,
				wheb_mensagem_pck.get_texto(311709,'NR_SEQ_RECEBIMENTO_P='||nr_seq_recebimento_p));
			commit;

			if (coalesce(ds_conj_cont_w::text, '') = '') then
				ds_conj_cont_w := substr(nr_seq_cont_w,1,255);
			else
				ds_conj_cont_w := substr(ds_conj_cont_w || ', ' || nr_seq_cont_w,1,255);
			end if;

			CALL cme_incluir_itens_controle(nr_seq_cont_w, nm_usuario_p);

			qt_cont_w := qt_cont_w + 1;

			end;
		end loop;
		end;
	end loop;
	close c01;

	update	cm_receb_externo
	set	ds_observacao =	substr(ds_observacao || chr(13) || wheb_mensagem_pck.get_texto(311708,'DS_CONJ_CONT_W='||ds_conj_cont_w),1,255)
	where	nr_sequencia = nr_seq_recebimento_p;
	end;
else
	begin
	update	cm_conjunto_cont
	set	ie_status_conjunto = 2
	where	nr_seq_receb_ext = nr_seq_recebimento_p;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cm_gerar_conj_ester_recebe_ext ( nr_seq_recebimento_p bigint, cd_setor_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_opcao_p text) FROM PUBLIC;

