-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualizar_ausencia_op ( nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_operador_w		bigint;
dt_fim_atendimento_w		timestamp;
cd_estabelecimento_w		bigint;
qt_tempo_ocioso_w		bigint;
dt_entrada_w			timestamp;
dt_ausencia_w			timestamp;
nr_seq_controle_w		bigint;

c01 CURSOR FOR 
	SELECT	nr_seq_operador, 
		max(dt_fim_atendimento) 
	from	pls_atendimento 
	where	nr_seq_operador not in (SELECT	nr_seq_operador 
					from	pls_atendimento 
					where	coalesce(dt_fim_atendimento::text, '') = '') 
	and	nr_seq_operador in (	select	nr_seq_operador 
					from	pls_operador_controle 
					where	coalesce(dt_saida::text, '') = '' 
					and	round((clock_timestamp() - dt_entrada)*24,0) > qt_tempo_ocioso_w) 
	group by nr_seq_operador;


BEGIN 
 
select	min(cd_estabelecimento) 
into STRICT	cd_estabelecimento_w 
from	pls_outorgante;
 
begin 
	select	qt_tempo_ausente 
	into STRICT	qt_tempo_ocioso_w 
	from	pls_parametros 
	where	cd_estabelecimento = cd_estabelecimento_w;
exception 
when others then 
	qt_tempo_ocioso_w := 0;
end;
 
open c01;
loop 
fetch c01 into 
	nr_seq_operador_w, 
	dt_fim_atendimento_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	if	(round((clock_timestamp() - dt_fim_atendimento_w)*24,0) > qt_tempo_ocioso_w) and (qt_tempo_ocioso_w > 0) then 
		select	max(dt_entrada), 
			max(nr_sequencia) 
		into STRICT	dt_entrada_w, 
			nr_seq_controle_w 
		from	pls_operador_controle 
		where	coalesce(dt_saida::text, '') = '' 
		and	nr_seq_operador = nr_seq_operador_w;
 
		if (dt_entrada_w > dt_fim_atendimento_w) then 
			dt_ausencia_w := dt_entrada_w;
		else 
			dt_ausencia_w := dt_fim_atendimento_w;
		end if;
 
		update	pls_operador_controle 
		set	dt_saida = dt_ausencia_w, 
			dt_atualizacao = clock_timestamp(), 
			nm_usuario = nm_usuario_p 
		where	nr_sequencia = nr_seq_controle_w;
	end if;
	end;
end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualizar_ausencia_op ( nm_usuario_p text) FROM PUBLIC;

