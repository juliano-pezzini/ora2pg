-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_equipe_cirurgica (nr_seq_agenda_p agenda_paciente.nr_sequencia%type, nm_usuario_p cirurgia_participante.nm_usuario%type) AS $body$
DECLARE


nr_cirurgia_w     agenda_paciente.nr_cirurgia%type;

c01 CURSOR FOR
	SELECT (SELECT max(cd_funcao)
          	from    funcao_medico
          	where   ie_cirurgiao <> 'N')		cd_funcao_medico,
          	ap.cd_medico			                cd_profissional
    from    agenda_paciente ap
    where   ap.nr_sequencia = nr_seq_agenda_p
    
union all

    select (select max(cd_funcao)
          	from    funcao_medico
          	where   ie_anestesista_principal <> 'N')   cd_funcao_medico,
         	apt.cd_anestesista				                cd_profissional
    from    agenda_paciente apt
    where   apt.nr_sequencia = nr_seq_agenda_p
    
union all

    select coalesce(pa.cd_funcao, fm.cd_funcao) cd_funcao_medico,
    pa.cd_profissional cd_profissional
    from profissional_agenda pa,
    funcao_medico fm
    where (fm.ie_anestesista_principal <> 'S' and fm.ie_cirurgiao <> 'S')
    and fm.cd_funcao = pa.cd_funcao
    and pa.nr_seq_agenda = nr_seq_agenda_p;

BEGIN

<<cirurgia_gerada>>
begin
    select  ap.nr_cirurgia
    into STRICT    nr_cirurgia_w
    from    agenda_paciente ap
    where   ap.nr_sequencia = nr_seq_agenda_p;
EXCEPTION
    when no_data_found then
        nr_cirurgia_w := null;
    when too_many_rows then
        nr_cirurgia_w := null;
    when OTHERS then
        nr_cirurgia_w := null;
end;

if (nr_cirurgia_w IS NOT NULL AND nr_cirurgia_w::text <> '' AND pkg_i18n.get_user_locale = 'de_DE') then

    delete  FROM cirurgia_participante cp
    where   cp.nr_cirurgia = nr_cirurgia_w;

    <<loop_profissionais_cirurgia>>
    for r_participante in C01 loop
        CALL gerar_participante_cirurgia(cd_participante_p   => r_participante.cd_profissional, 
                                    nr_cirurgia_p       => nr_cirurgia_w, 
                                    ie_funcao_p         => r_participante.cd_funcao_medico, 
                                    ie_opcao_funcao_p   => null, 
                                    nm_usuario_p        => nm_usuario_p);
    end loop loop_profissionais_cirurgia;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_equipe_cirurgica (nr_seq_agenda_p agenda_paciente.nr_sequencia%type, nm_usuario_p cirurgia_participante.nm_usuario%type) FROM PUBLIC;

