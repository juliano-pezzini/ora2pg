-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_copia_sintomas_soap (nr_sequencia_p bigint) AS $body$
DECLARE


cd_pessoa_fisica_w	varchar(10);
cd_ciap_w			varchar(5);	
ds_ciap_w			varchar(255);
nr_atendimento_w	bigint;
nr_seq_soap_w		bigint;
nm_usuario_w		varchar(15);
ie_nivel_atencao_w		varchar(1);
nr_seq_problema_w	bigint;


BEGIN

Select 	max(cd_ciap),
		substr(max(obter_desc_ciap(cd_ciap)),1,255),
		max(cd_pessoa_fisica),
		max(nr_atendimento)
into STRICT	cd_ciap_w,
		ds_ciap_w,
		cd_pessoa_fisica_w,
		nr_atendimento_w
from	ciap_atendimento
where	nr_sequencia = nr_sequencia_p;

nm_usuario_w := wheb_usuario_pck.get_nm_usuario;
ie_nivel_atencao_w := wheb_assist_pck.get_nivel_atencao_perfil;

Select 	obter_consulta_soap(nr_atendimento_w,obter_pf_usuario(nm_usuario_w,'C'))
into STRICT	nr_seq_soap_w
;

if (cd_ciap_w IS NOT NULL AND cd_ciap_w::text <> '') then

	Select nextval('lista_problema_pac_seq')
	into STRICT	nr_Seq_problema_w
	;
	
	insert into lista_problema_pac(	nr_sequencia,
		dt_atualizacao,
		dt_atualizacao_nrec,
		nm_usuario,
		nm_usuario_nrec,
		cd_pessoa_fisica,
		nr_atendimento,
		dt_inicio,
		ds_problema,										
		ie_situacao,
		nr_seq_soap,
		ie_nivel_atencao)
VALUES (		nr_Seq_problema_w,
		clock_timestamp(),
		clock_timestamp(),
		nm_usuario_w,
		nm_usuario_w,
		cd_pessoa_fisica_w,
		nr_atendimento_w,
		clock_timestamp(),
		ds_ciap_w,
		'A',
		nr_seq_soap_w,
		ie_nivel_atencao_w);
	commit;

	insert into lista_problema_pac_item(	nr_sequencia,
		dt_atualizacao,
		dt_atualizacao_nrec,
		nm_usuario,
		nm_usuario_nrec,
		nr_seq_problema,
		nr_seq_registro,
		ie_tipo_registro,
		nm_tabela,
		ie_tipo_problema)
values (		nextval('lista_problema_pac_item_seq'),
		clock_timestamp(),
		clock_timestamp(),
		nm_usuario_w,
		nm_usuario_w,
		nr_Seq_problema_w,
		nr_sequencia_p,
		'CP',
		'CIAP_ATENDIMENTO',
		cd_ciap_w);
	commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_copia_sintomas_soap (nr_sequencia_p bigint) FROM PUBLIC;

