-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE exportar_pedido_exame_externo (nr_seq_exame_externo_item_p bigint, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_resultado_w		bigint;
nr_seq_pac_prot_externo_w	bigint;
nr_atendimento_w		bigint;
nr_laudo_w			bigint;
cd_pessoa_fisica_w		varchar(20);

-- ie_opcao_p  (L / P)	
BEGIN


if (nr_seq_exame_externo_item_p IS NOT NULL AND nr_seq_exame_externo_item_p::text <> '') then


	select	e.nr_atendimento,
		a.cd_pessoa_fisica
	into STRICT	nr_atendimento_w,
		cd_pessoa_fisica_w
	from	pedido_exame_externo_item i,
		pedido_exame_externo e,
		atendimento_paciente a
	where	i.nr_sequencia 	= nr_seq_exame_externo_item_p
	and	i.nr_seq_pedido = e.nr_sequencia
	and	e.nr_atendimento = a.nr_atendimento;

	if (ie_opcao_p = 'L') then --Exame laboratorio
		select	coalesce(max(nr_seq_resultado),0)+1
		into STRICT	nr_seq_resultado_w
		from	exame_lab_resultado;


		insert	into exame_lab_resultado(
			nr_seq_resultado,
			dt_resultado,
			dt_atualizacao,
			nm_usuario,
			nr_prescricao,
			nr_atendimento,
			cd_medico,
			nr_seq_protocolo,
			dt_liberacao,
			cd_pessoa_fisica,
			nr_seq_pedido_exam_ext_item
			)
			SELECT	nr_seq_resultado_w,
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_p,
				null,
				e.nr_atendimento,
				e.cd_profissional,
				null,
				null,
				cd_pessoa_fisica_w,
				nr_seq_exame_externo_item_p
			from	pedido_exame_externo_item i,
				pedido_exame_externo e
			where	i.nr_sequencia 	= nr_seq_exame_externo_item_p
			and	i.nr_seq_pedido = e.nr_sequencia;



		insert 	into exame_lab_result_item(
			nr_seq_resultado,
			nr_sequencia,
			nr_seq_exame,
			dt_atualizacao,
			nm_usuario
			)
			SELECT	nr_seq_resultado_w,
				1,
				i.nr_seq_exame_lab,
				clock_timestamp(),
				nm_usuario_p
			from	pedido_exame_externo_item i,
				pedido_exame_externo e
			where	i.nr_sequencia 	= nr_seq_exame_externo_item_p
			and	i.nr_seq_pedido = e.nr_sequencia
			and	(i.nr_seq_exame_lab IS NOT NULL AND i.nr_seq_exame_lab::text <> '');	


	elsif (ie_opcao_p = 'P') then --Exame nao laboratorial
		select	nextval('imagem_pac_prot_externo_seq')
		into STRICT	nr_seq_pac_prot_externo_w
		;



		insert 	into  imagem_pac_prot_externo(
			nr_sequencia,
			nr_atendimento,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_exame,
			cd_pessoa_fisica,
			cd_medico,
			nr_seq_pedido_exam_ext_item
			)
			SELECT	nr_seq_pac_prot_externo_w,
				e.nr_atendimento,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				cd_pessoa_fisica_w,
				e.cd_profissional,
				nr_seq_exame_externo_item_p
			from	pedido_exame_externo_item i,
				pedido_exame_externo e
			where	i.nr_sequencia 	= nr_seq_exame_externo_item_p
			and	i.nr_seq_pedido = e.nr_sequencia;


		select (coalesce(max(nr_laudo),0) + 1)
		into STRICT	nr_laudo_w
		from	laudo_paciente
		where	nr_atendimento = nr_atendimento_w;


		insert 	into laudo_paciente(
			nr_sequencia,
			nr_atendimento,
			dt_entrada_unidade,
			nr_laudo,
			nm_usuario,
			dt_atualizacao,
			cd_medico_resp,
			qt_imagem,
			cd_pessoa_fisica,
			ds_titulo_laudo,
			dt_laudo,
			NR_SEQ_PAC_PROT_EXT
			)
			SELECT	nextval('laudo_paciente_seq'),
				e.nr_atendimento,
				clock_timestamp() dt_entrada_unidade_w,
				nr_laudo_w,
				nm_usuario_p,
				clock_timestamp() dt_atualizacao_w,
				e.cd_profissional,
				0 qt_imagem_w,
				cd_pessoa_fisica_w,
				Obter_Desc_Proc_Interno(i.nr_proc_interno),
				clock_timestamp() dt_laudo_w,
				nr_seq_pac_prot_externo_w
			from	pedido_exame_externo_item i,
				pedido_exame_externo e
			where	i.nr_sequencia 	= nr_seq_exame_externo_item_p
			and	i.nr_seq_pedido = e.nr_sequencia;

	end if;

	commit;

end if;	

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE exportar_pedido_exame_externo (nr_seq_exame_externo_item_p bigint, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

