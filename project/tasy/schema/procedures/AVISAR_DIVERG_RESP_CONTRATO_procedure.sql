-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE avisar_diverg_resp_contrato ( nr_documento_p bigint, ie_tipo_documento_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_classif_w			bigint;
nm_usuario_resp_geral_w		varchar(15);
nm_usuario_dest_w		varchar(15);
nr_seq_contrato_w		bigint;
nr_item_w			bigint;
ds_observacao_w			varchar(255);
ds_material_w			varchar(255);
ds_itens_w			varchar(4000);
ds_mensagem_w			varchar(4000);
ds_contrato_w			varchar(255);
ds_documento_w			varchar(255);

c01 CURSOR FOR
SELECT	nr_seq_contrato
from	diverg_contrato_item_doc
where	nr_documento = nr_documento_p
and	ie_tipo_documento = ie_tipo_documento_p
group by	nr_seq_contrato;

c02 CURSOR FOR
SELECT	a.nr_item_documento,
	a.ds_observacao
from	diverg_contrato_item_doc a,
	solic_compra_item b
where	a.nr_documento = nr_documento_p
and	a.ie_tipo_documento = 'SC'
and	b.nr_solic_compra = a.nr_documento
and	b.nr_item_solic_compra = a.nr_item_documento
and	coalesce(b.ds_justif_diver::text, '') = ''
and	nr_seq_contrato = nr_seq_contrato_w

union

SELECT	a.nr_item_documento,
	a.ds_observacao
from	diverg_contrato_item_doc a,
	ordem_compra_item b
where	a.nr_documento = nr_documento_p
and	a.ie_tipo_documento = 'OC'
and	b.nr_ordem_compra = a.nr_documento
and	b.nr_item_oci = a.nr_item_documento
and	coalesce(b.ds_justif_diver::text, '') = ''
and	a.nr_seq_contrato = nr_seq_contrato_w
order by	nr_item_documento;


BEGIN

select	obter_classif_comunic('F')
into STRICT	nr_seq_classif_w
;

select	substr(coalesce(obter_usuario_pf(cd_responsavel_contratos),'X'),1,15)
into STRICT	nm_usuario_resp_geral_w
from	parametro_compras
where	cd_estabelecimento = cd_estabelecimento_p;

open c01;
loop
fetch c01 into
	nr_seq_contrato_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	open c02;
	loop
	fetch c02 into
		nr_item_w,
		ds_observacao_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin

		if (ie_tipo_documento_p = 'SC') then
			begin

			select	b.ds_material
			into STRICT	ds_material_w
			from	solic_compra_item a,
				estrutura_material_v b
			where	a.nr_solic_compra = nr_documento_p
			and	a.nr_item_solic_compra = nr_item_w
			and	b.cd_material = a.cd_material;

			end;
		elsif (ie_tipo_documento_p = 'OC') then
			begin

			select	b.ds_material
			into STRICT	ds_material_w
			from	ordem_compra_item a,
				estrutura_material_v b
			where	a.nr_ordem_compra = nr_documento_p
			and	a.nr_item_oci = nr_item_w
			and	b.cd_material = a.cd_material;

			end;
		end if;
		
		ds_itens_w	:= substr(WHEB_MENSAGEM_PCK.get_texto(297723,'DS_ITENS_W=' || ds_itens_w || ';' ||
						'NR_ITEM_W=' || nr_item_w || ';' ||
						'DS_MATERIAL_W=' || ds_material_w || ';' ||
						'DS_OBSERVACAO=' || ds_observacao_w),1,4000);

		end;
	end loop;
	close c02;

	select	substr(coalesce(ds_titulo_contrato,WHEB_MENSAGEM_PCK.get_texto(297720)),1,255)
	into STRICT	ds_contrato_w
	from	contrato
	where	nr_sequencia = nr_seq_contrato_w;
	

	select	CASE WHEN ie_tipo_documento_p='SC' THEN WHEB_MENSAGEM_PCK.get_texto(297721) WHEN ie_tipo_documento_p='OC' THEN WHEB_MENSAGEM_PCK.get_texto(297722) END
	into STRICT	ds_documento_w
	;

	ds_mensagem_w := substr(WHEB_MENSAGEM_PCK.get_texto(297724,'DS_DOCUMENTO_W=' || ds_documento_W || ';' ||
								'NR_DOCUMENTO_P=' || to_char(nr_documento_p) || ';' ||
								'NR_SEQ_CONTRATO_W=' || nr_seq_contrato_w || ';' ||
								'DS_CONTRATO_W=' || ds_contrato_w || ';' ||
								'DS_MENSAGEM_W=' || ds_mensagem_w || ';' ||
								'DS_ITENS_W=' || ds_itens_w),1,4000);

	select	substr(coalesce(obter_usuario_pf(cd_pessoa_resp),nm_usuario_resp_geral_w),1,15)
	into STRICT	nm_usuario_dest_w
	from	contrato
	where	nr_sequencia = nr_seq_contrato_w;

	if (nm_usuario_dest_w <> 'X') then
		begin

		CALL Gerar_Comunic_Padrao(
			clock_timestamp(),
			WHEB_MENSAGEM_PCK.get_texto(297725),
			ds_mensagem_w,
			nm_usuario_p,
			'N',
			nm_usuario_dest_w,
			'N',
			nr_seq_classif_w,
			null,
			null,
			null,
			clock_timestamp(),
			null,
			null);

		end;
	end if;

	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE avisar_diverg_resp_contrato ( nr_documento_p bigint, ie_tipo_documento_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

