-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_aviso_aniversario () AS $body$
DECLARE


nm_pessoa_fisica_w	varchar(100);
ds_setor_w		varchar(60);
ds_aniversariantes_w	varchar(512);
ds_mensagem_w		varchar(4000);

C01 CURSOR FOR
	SELECT		obter_nome_pf(b.cd_pessoa_fisica) as nm_pessoa_fisica_order,
			SUBSTR(obter_nome_setor(a.cd_setor_atendimento),1,100) ds_setor
	FROM		usuario a,
			pessoa_fisica b
	WHERE		a.cd_pessoa_fisica = b.cd_pessoa_fisica
	AND		b.ie_funcionario = 'S'
	AND		a.ie_situacao = 'A'
	AND		TO_CHAR(dt_nascimento,'dd/mm') = TO_CHAR(clock_timestamp(),'dd/mm')
	ORDER BY 	nm_pessoa_fisica_order;

BEGIN

ds_aniversariantes_w := null;

open C01;
loop
fetch C01 into
	nm_pessoa_fisica_w,
	ds_setor_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ds_aniversariantes_w := ds_aniversariantes_w || '	'||nm_pessoa_fisica_w || ' - ' || ds_setor_w || '\par';
	end;
end loop;
close C01;

if (ds_aniversariantes_w IS NOT NULL AND ds_aniversariantes_w::text <> '') then

	ds_mensagem_w :='{\rtf1\ansi\deff0{\fonttbl{\f0\fnil\fcharset0 MS Sans Serif;}{\f1\fnil MS Sans Serif;}}'||
			'{\colortbl ;\red0\green0\blue128;}'||
			'\viewkind4\uc1\pard\cf1\lang1046\f0\fs24'||
			' Aniversariantes do Dia '||to_char(clock_timestamp(),'dd')||':'||
			'\par '||
			'\par \b'||
			ds_aniversariantes_w ||
			'\b0\par }';

	insert into comunic_interna(
		nr_sequencia,
		dt_comunicado,
		ds_titulo,
		ds_comunicado,
		ie_gerencial,
		ie_geral,
		cd_estab_destino,
		nr_seq_classif,
		dt_liberacao,
		nm_usuario,
		dt_atualizacao)
	values (
		nextval('comunic_interna_seq'),
		clock_timestamp(),
		'Aniversariante do Dia.',
		ds_mensagem_w,
		'N',
		'S',
		1,
		5,
		clock_timestamp(),
		'Tasy',
		clock_timestamp());

	commit;
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_aviso_aniversario () FROM PUBLIC;

