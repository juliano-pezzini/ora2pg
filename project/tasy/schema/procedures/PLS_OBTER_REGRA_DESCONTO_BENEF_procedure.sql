-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_regra_desconto_benef ( nr_seq_segurado_p bigint, dt_preco_p timestamp, nr_seq_regra_desc_p INOUT bigint, tx_desconto_p INOUT bigint, vl_desconto_p INOUT bigint) AS $body$
DECLARE


nr_seq_contrato_w	pls_segurado.nr_seq_contrato%type;
nr_seq_regra_desc_w	pls_regra_desconto.nr_sequencia%type	:= null;
tx_desconto_w		pls_preco_regra.tx_desconto%type	:= null;
vl_desconto_w		pls_preco_regra.vl_desconto%type	:= null;
qt_vidas_w		bigint;

C01 CURSOR FOR
	SELECT	a.nr_sequencia,
		a.ie_tipo_regra,
		b.qt_min_vidas,
		b.qt_max_vidas,
		b.tx_desconto,
		b.vl_desconto
	from	pls_regra_desconto	a,
		pls_preco_regra		b
	where	a.nr_sequencia		= b.nr_seq_regra
	and	a.nr_seq_contrato	= nr_seq_contrato_w
	and	dt_preco_p between coalesce(a.dt_inicio_vigencia,dt_preco_p) and coalesce(a.dt_fim_vigencia,dt_preco_p)
	and	a.ie_situacao	= 'A';

BEGIN
select	max(nr_seq_contrato)
into STRICT	nr_seq_contrato_w
from	pls_segurado
where	nr_sequencia	= nr_seq_segurado_p;

for r_c01_w in C01 loop
	begin
	qt_vidas_w	:= coalesce(pls_obter_quantidade_vidas(nr_seq_segurado_p, r_c01_w.ie_tipo_regra, 'C'),0);

	if (qt_vidas_w between r_c01_w.qt_min_vidas and r_c01_w.qt_max_vidas) then
		nr_seq_regra_desc_w	:= r_c01_w.nr_sequencia;
		tx_desconto_w		:= r_c01_w.tx_desconto;
		vl_desconto_w		:= r_c01_w.vl_desconto;
	end if;

	end;
end loop;

nr_seq_regra_desc_p	:= nr_seq_regra_desc_w;
tx_desconto_p		:= coalesce(tx_desconto_w,0);
vl_desconto_p		:= coalesce(vl_desconto_w,0);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_regra_desconto_benef ( nr_seq_segurado_p bigint, dt_preco_p timestamp, nr_seq_regra_desc_p INOUT bigint, tx_desconto_p INOUT bigint, vl_desconto_p INOUT bigint) FROM PUBLIC;

