-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE colunas_linha AS (
	nr_seq_linha_old_w		bigint,
	nr_seq_sup_old_w		bigint,
	nr_seq_linha_new_w 	bigint);
CREATE TYPE colunas_coluna AS (
	nr_seq_coluna_old_w	bigint,
	nr_seq_coluna_new_w 	bigint);


CREATE OR REPLACE PROCEDURE duplicar_capa_ficha_financ ( nr_seq_capa_p bigint, nm_usuario_p text, ie_gerar_permissoes_p text, nr_seq_capa_ret_p INOUT bigint) AS $body$
DECLARE


ds_coluna_w		varchar(255);
ds_capa_copia_w		varchar(255);
nr_seq_capa_w		bigint;
nr_seq_capa_ww		bigint;

nr_seq_linha_w		bigint;
nr_seq_superior_w		bigint;
nr_seq_coluna_w		bigint;

nr_seq_linha_ww		bigint;
nr_seq_coluna_ww		bigint;
nr_seq_formula_w		bigint;

cd_perfil_w		bigint;
ie_liberado_w		varchar(1);
nm_usuario_lib_w		varchar(255);
nr_sequencia_w		bigint;

i			bigint;

type vetor_linha is table of colunas_linha index by integer;
type vetor_coluna is table of colunas_coluna index by integer;

vetor_linha_w	vetor_linha;
vetor_coluna_w	vetor_coluna;

c01 CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_superior
	from	capa_ficha_financ_lin
	where	nr_seq_capa = nr_seq_capa_ww
	order by	nr_sequencia;

c02 CURSOR FOR
	SELECT	nr_sequencia
	from	capa_ficha_financ_col
	where	nr_seq_capa = nr_seq_capa_p
	order by	nr_sequencia;

c04 CURSOR FOR
	SELECT	nr_seq_linha,
		nr_seq_coluna,
		nr_seq_formula
	from	capa_ficha_financ_val
	where	nr_seq_capa = nr_seq_capa_p
	order by	nr_sequencia;

c03 CURSOR FOR
	SELECT	cd_perfil,
		ie_liberado,
		nm_usuario_lib
	from	capa_ficha_financ_lib
	where	nr_seq_capa = nr_seq_capa_p
	order by	nr_sequencia;


BEGIN

select	ds_capa
into STRICT	ds_capa_copia_w
from 	capa_ficha_financ
where	nr_sequencia = nr_seq_capa_p;

select nextval('capa_ficha_financ_seq')
into STRICT nr_seq_capa_w
;

insert into capa_ficha_financ(
	nr_sequencia,
	ds_capa,
	nm_usuario,
	nm_usuario_nrec,
	dt_atualizacao,
	dt_atualizacao_nrec,
	ie_apres_linha)
SELECT	nr_seq_capa_w,
	substr(Wheb_mensagem_pck.get_texto(297748) || ' - ' || ds_capa_copia_w,1,255),
	nm_usuario_p,
	nm_usuario_p,
	clock_timestamp(),
	clock_timestamp(),
	coalesce(ie_apres_linha,0)
from	capa_ficha_financ
where	nr_sequencia = nr_seq_capa_p;

i	:= 0;

nr_seq_capa_ww	:= nr_seq_capa_p;

open c01;
loop
fetch c01 into
	nr_seq_linha_w,
	nr_seq_superior_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	select	nextval('capa_ficha_financ_lin_seq')
	into STRICT	nr_sequencia_w
	;

	insert into capa_ficha_financ_lin(
		nr_sequencia,
		nr_seq_superior,
		nr_seq_capa,
		qt_decimais,
		ds_linha,
		nm_usuario,
		nm_usuario_nrec,
		dt_atualizacao,
		dt_atualizacao_nrec,
		nr_ordem_apres,
		ds_cor_fundo)
	SELECT	nr_sequencia_w,
		null,
		nr_seq_capa_w,
		qt_decimais,
		ds_linha,
		nm_usuario_p,
		nm_usuario_p,
		clock_timestamp(),
		clock_timestamp(),
		nr_ordem_apres,
		ds_cor_fundo
	from	capa_ficha_financ_lin
	where	nr_sequencia = nr_seq_linha_w;

	vetor_linha_w[i].nr_seq_linha_old_w	:= nr_seq_linha_w;
	vetor_linha_w[i].nr_seq_sup_old_w	:= nr_seq_superior_w;
	vetor_linha_w[i].nr_seq_linha_new_w	:= nr_sequencia_w;

	i := (i + 1);
	end;
end loop;
close c01;

nr_seq_capa_ww	:= nr_seq_capa_w;

open c01;
loop
fetch c01 into
	nr_seq_linha_w,
	nr_seq_superior_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	nr_seq_superior_w	:= null;

	for i in 0..(vetor_linha_w.count - 1) loop
		begin
		if (vetor_linha_w[i].nr_seq_linha_new_w = nr_seq_linha_w) then
			nr_seq_superior_w	:= vetor_linha_w[i].nr_seq_sup_old_w;
		end if;
		end;
	end loop;

	if (nr_seq_superior_w IS NOT NULL AND nr_seq_superior_w::text <> '') then
		begin
		for i in 0..(vetor_linha_w.count - 1) loop
			begin
			if (vetor_linha_w[i].nr_seq_linha_old_w = nr_seq_superior_w) then
				nr_seq_superior_w	:= vetor_linha_w[i].nr_seq_linha_new_w;
			end if;
			end;
		end loop;

		update	capa_ficha_financ_lin
		set	nr_seq_superior = nr_seq_superior_w
		where	nr_sequencia = nr_seq_linha_w;
		end;
	end if;
	end;
end loop;
close c01;

i	:= 0;

open c02;
loop
fetch c02 into
	nr_seq_coluna_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin
	select	nextval('capa_ficha_financ_col_seq')
	into STRICT	nr_sequencia_w
	;

	insert into capa_ficha_financ_col(
		nr_sequencia,
		nr_seq_capa,
		ds_coluna,
		nm_usuario,
		nm_usuario_nrec,
		dt_atualizacao,
		dt_atualizacao_nrec,
		nr_ordem_apres)
	SELECT 	nr_sequencia_w,
		nr_seq_capa_w,
		ds_coluna,
		nm_usuario_p,
		nm_usuario_p,
		clock_timestamp(),
		clock_timestamp(),
		nr_ordem_apres
	from	capa_ficha_financ_col
	where	nr_sequencia = nr_seq_coluna_w;

	vetor_coluna_w[i].nr_seq_coluna_old_w	:= nr_seq_coluna_w;
	vetor_coluna_w[i].nr_seq_coluna_new_w	:= nr_sequencia_w;

	i := (i + 1);
	end;
end loop;
close c02;

open c04;
loop
fetch c04 into
	nr_seq_linha_w,
	nr_seq_coluna_w,
	nr_seq_formula_w;
EXIT WHEN NOT FOUND; /* apply on c04 */
	begin
	for i in 0..vetor_coluna_w.count-1 loop
		begin
		if (vetor_coluna_w[i].nr_seq_coluna_old_w = nr_seq_coluna_w) then
			nr_seq_coluna_ww	:= vetor_coluna_w[i].nr_seq_coluna_new_w;
		end if;
		end;
	end loop;

	for i in 0..vetor_linha_w.count-1 loop
		begin
		if (vetor_linha_w[i].nr_seq_linha_old_w = nr_seq_linha_w) then
			nr_seq_linha_ww	:= vetor_linha_w[i].nr_seq_linha_new_w;
		end if;
		end;
	end loop;

	insert into capa_ficha_financ_val(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_capa,
		nr_seq_linha,
		nr_seq_coluna,
		nr_seq_formula)
	values (	nextval('capa_ficha_financ_val_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_capa_w,
		nr_seq_linha_ww,
		nr_seq_coluna_ww,
		nr_seq_formula_w);
	end;
end loop;
close c04;

if (ie_gerar_permissoes_p = 'S') then
	open c03;
	loop
	fetch c03 into
		cd_perfil_w,
		ie_liberado_w,
		nm_usuario_lib_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		begin
		insert into capa_ficha_financ_lib(
			nr_sequencia,
			nr_seq_capa,
			cd_perfil,
			nm_usuario_lib,
			ie_liberado,
			nm_usuario,
			nm_usuario_nrec,
			dt_atualizacao,
			dt_atualizacao_nrec)
		values (	nextval('capa_ficha_financ_lib_seq'),
			nr_seq_capa_w,
			cd_perfil_w,
			nm_usuario_lib_w,
			ie_liberado_w,
			nm_usuario_p,
			nm_usuario_p,
			clock_timestamp(),
			clock_timestamp());
		end;
	end loop;
	close c03;
end if;

nr_seq_capa_ret_p := nr_seq_capa_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_capa_ficha_financ ( nr_seq_capa_p bigint, nm_usuario_p text, ie_gerar_permissoes_p text, nr_seq_capa_ret_p INOUT bigint) FROM PUBLIC;

