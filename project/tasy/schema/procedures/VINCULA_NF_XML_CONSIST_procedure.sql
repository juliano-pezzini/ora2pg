-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vincula_nf_xml_consist ( nr_sequencia_p bigint, nr_nota_fiscal_arq_p text, cd_serie_nf_arq_p text, cd_rfc_arq_p text, vl_total_nf_arq_p text, ie_retorno_p INOUT text, ds_erro_p INOUT text ) AS $body$
DECLARE

 
nr_nota_fiscal_w	nota_fiscal.nr_nota_fiscal%type;	
cd_serie_nf_w		nota_fiscal.cd_serie_nf%type;	
vl_total_nota_w		nota_fiscal.vl_total_nota%type;
cd_rfc_emitente_w	varchar(255);


BEGIN 
 
ie_retorno_p := 'S';
ds_erro_p  := '';
 
select	max(nr_nota_fiscal), 
	max(cd_serie_nf),	 
	substr(CASE WHEN max(ie_tipo_nota)='EF' THEN obter_dados_pf_pj(max(cd_pessoa_fisica),null,'RFC')  ELSE obter_dados_pf_pj(null,max(cd_cgc_emitente),'RFC') END ,1,255), 
	max(vl_total_nota) 
into STRICT	nr_nota_fiscal_w, 
	cd_serie_nf_w, 
	cd_rfc_emitente_w, 
	vl_total_nota_w 
from	nota_fiscal 
where	nr_sequencia = nr_sequencia_p;
 
if (nr_nota_fiscal_w <> trim(both nr_nota_fiscal_arq_p)) then 
	begin 
	ie_retorno_p := 'N';
	ds_erro_p  := substr(WHEB_MENSAGEM_PCK.get_texto(352400, 'NR_NOTA_FISCAL_ARQ='||trim(both nr_nota_fiscal_arq_p)||';'||'NR_NOTA_FISCAL='||nr_nota_fiscal_w) || chr(13) || chr(10),1,255);
	end;
end if;							
 
if (cd_serie_nf_w <> trim(both cd_serie_nf_arq_p)) then 
	begin 
	ie_retorno_p := 'N';
	ds_erro_p  := substr(ds_erro_p || WHEB_MENSAGEM_PCK.get_texto(352401, 'CD_SERIE_NF_ARQ='||trim(both cd_serie_nf_arq_p)||';'||'CD_SERIE_NF='||cd_serie_nf_w) || chr(13) || chr(10),1,255);
	end;
end if;
 
 
if (cd_rfc_emitente_w <> trim(both cd_rfc_arq_p)) then 
	begin 
	ie_retorno_p := 'N';
	ds_erro_p  := substr(ds_erro_p || WHEB_MENSAGEM_PCK.get_texto(352402, 'CD_RFC_ARQ='||trim(both cd_rfc_arq_p)||';'||'CD_RFC='||cd_rfc_emitente_w) || chr(13) || chr(10),1,255);
	end;
end if;
 
begin 
if (vl_total_nota_w <> (replace(vl_total_nf_arq_p,'.',','))::numeric ) then 
	begin 
	ie_retorno_p := 'N';
	ds_erro_p  := substr(ds_erro_p || WHEB_MENSAGEM_PCK.get_texto(352403, 'VL_TOTAL_NOTA_ARQ='||replace(vl_total_nf_arq_p,'.',',')||';'||'VL_TOTAL_NOTA='||vl_total_nota_w) || chr(13) || chr(10),1,255);
	end;
end if;
 
exception 
	when others then 
	ds_erro_p := ds_erro_p;
end;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vincula_nf_xml_consist ( nr_sequencia_p bigint, nr_nota_fiscal_arq_p text, cd_serie_nf_arq_p text, cd_rfc_arq_p text, vl_total_nf_arq_p text, ie_retorno_p INOUT text, ds_erro_p INOUT text ) FROM PUBLIC;

