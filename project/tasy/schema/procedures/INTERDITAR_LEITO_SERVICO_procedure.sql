-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE interditar_leito_servico ( nm_usuario_p text, nr_sequencia_p bigint, ie_opcao_p text default null, ds_observacao_p text default null, cd_motivo_interdicao_p bigint DEFAULT NULL) AS $body$
DECLARE


nr_seq_unidade_w		bigint;									
ie_status_serv_w		varchar(15);
ie_coloca_leito_aguard_w	varchar(1);
									

BEGIN

ie_coloca_leito_aguard_w := obter_param_usuario(75, 116, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_coloca_leito_aguard_w);

select	coalesce(max(nr_seq_unidade),0),
	max(ie_status_serv)
into STRICT	nr_seq_unidade_w,
	ie_status_serv_w
from 	sl_unid_atend
where 	nr_sequencia 		= 	nr_sequencia_p;

if (ie_status_serv_w = 'C') then
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(262378);
elsif (ie_status_serv_w = 'IP') then
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(262379);
end if;


if (ie_opcao_p = 'I') then

	update 	sl_unid_atend
	set	dt_atualizacao		=	clock_timestamp(),
		nm_usuario		= 	nm_usuario_p,
		dt_interdicao		= 	clock_timestamp(),
		dt_fim_interdicao	 = NULL,
		nm_usuario_interd 	= 	nm_usuario_p,
		ie_status_serv		=	'IT',
		ie_status_serv_interd	=	ie_status_serv
	where 	nr_sequencia 		= 	nr_sequencia_p;
	
	
	update	unidade_atendimento
	set	dt_atualizacao		=	clock_timestamp(),
		nm_usuario		= 	nm_usuario_p,
		ie_status_unidade	=	'I',
		ds_observacao		= 	substr(ds_observacao_p,1,255),
		cd_motivo_interdicao	= 	cd_motivo_interdicao_p
	where	nr_seq_interno		=	nr_seq_unidade_w;
	
	CALL inserir_hist_gestao_servico('IL', nr_sequencia_p, nm_usuario_p);
	
elsif (ie_opcao_p = 'F') then

	update 	sl_unid_atend
	set	dt_atualizacao		=	clock_timestamp(),
		nm_usuario		= 	nm_usuario_p,
		dt_fim_interdicao	= 	clock_timestamp(),
		ie_status_serv		=	ie_status_serv_interd
	where 	nr_sequencia 		= 	nr_sequencia_p;
	
	
	update	unidade_atendimento
	set	dt_atualizacao		=	clock_timestamp(),
		nm_usuario		= 	nm_usuario_p,
		ie_status_unidade	=	CASE WHEN coalesce(ie_coloca_leito_aguard_w,'N')='S' THEN  'G'  ELSE 'H' END
	where	nr_seq_interno		=	nr_seq_unidade_w;
	
	
	CALL gerar_higienizacao_leito_unid(clock_timestamp(),nm_usuario_p,null,'LL',nr_seq_unidade_w,null);

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE interditar_leito_servico ( nm_usuario_p text, nr_sequencia_p bigint, ie_opcao_p text default null, ds_observacao_p text default null, cd_motivo_interdicao_p bigint DEFAULT NULL) FROM PUBLIC;

