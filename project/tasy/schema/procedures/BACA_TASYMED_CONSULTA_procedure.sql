-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_tasymed_consulta ( cd_pessoa_fisica_p text, cd_profissional_p text, nm_usuario_export_p text, nr_seq_tipo_pepa_p bigint) AS $body$
DECLARE

				

nr_atendimento_w		atend_consulta_pepa.nr_atendimento%type;
nr_sequencia_w			atend_consulta_pepa.nr_sequencia%type;
dt_inicio_consulta_w 	med_atendimento.dt_inicio_consulta%type;
dt_entrada_w 	med_atendimento.dt_entrada%type;

nr_seq_cliente_w med_atendimento.nr_seq_cliente%type;
				
C01 CURSOR FOR
SELECT a.nr_atendimento,
	   coalesce(a.dt_inicio_consulta,a.dt_entrada),
     a.dt_entrada,
     a.nr_seq_cliente
from med_atendimento a,
med_cliente b
where a.nr_seq_cliente = b.nr_sequencia
and b.cd_pessoa_fisica =  cd_pessoa_fisica_p
and b.cd_medico = cd_profissional_p;

	

BEGIN

open C01;
loop
fetch C01 into
	nr_atendimento_w,
	dt_inicio_consulta_w,
  dt_entrada_w,
  nr_seq_cliente_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	select nextval('atend_consulta_pepa_seq')
	into STRICT nr_sequencia_w
	;
	
	insert into atend_consulta_pepa( nr_sequencia,
									   dt_atualizacao,
									   dt_atualizacao_nrec,
									   nm_usuario,
									   nm_usuario_nrec,
									   cd_medico,
									   dt_inicio_consulta,
									   cd_pessoa_fisica,
									   ie_situacao,
									   ie_nivel_atencao,
									   nr_seq_tipo_consulta,
									   ie_importado,
									   dt_liberacao
									  ) values (
										nr_sequencia_w,
										dt_entrada_w,
										dt_entrada_w,
										nm_usuario_export_p,
										nm_usuario_export_p,
										cd_profissional_p,
										dt_inicio_consulta_w,
										cd_pessoa_fisica_p,
										'A',
										'S',
										nr_seq_tipo_pepa_p,
										'S',
										dt_inicio_consulta_w);
												

	commit;
	
	CALL baca_importa_evol_tasymed(cd_pessoa_fisica_p, cd_profissional_p, nm_usuario_export_p, null, nr_sequencia_w, nr_seq_cliente_w);
	
	CALL baca_importa_atestado_tasymed(cd_pessoa_fisica_p, cd_profissional_p, nm_usuario_export_p, null, nr_sequencia_w,nr_seq_cliente_w);
	
	CALL baca_importa_exames_tasymed(cd_pessoa_fisica_p, cd_profissional_p, nm_usuario_export_p, null, nr_sequencia_w,nr_seq_cliente_w);
	
	CALL baca_importa_parecer_tasymed(cd_pessoa_fisica_p, cd_profissional_p, nm_usuario_export_p, null, nr_sequencia_w,nr_seq_cliente_w);
	
	CALL baca_importa_reg_tasymed(cd_pessoa_fisica_p, cd_profissional_p, nm_usuario_export_p, nr_atendimento_w, nr_sequencia_w,nr_seq_cliente_w);

	
		
	end;
end loop;
close C01;

update med_cliente
set ie_exportado = 'S',
	dt_exportacao = clock_timestamp(),
	nm_usuario_exportacao =nm_usuario_export_p
where cd_pessoa_fisica = cd_pessoa_fisica_p
and cd_medico = cd_profissional_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_tasymed_consulta ( cd_pessoa_fisica_p text, cd_profissional_p text, nm_usuario_export_p text, nr_seq_tipo_pepa_p bigint) FROM PUBLIC;

