-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_evento_infeccao (nm_usuario_p text, nr_atendimento_p bigint, cd_estabelecimento_p bigint) AS $body$
DECLARE


			
nr_seq_evento_w		bigint;
cd_setor_atendimento_w	integer;
nr_seq_sitio_princ_w	bigint;
nr_seq_sitio_espec_w	bigint;
ds_sitio_principal_w	varchar(255);
ds_sitio_especifico_w	varchar(255);
mensagem_w		varchar(1000);


BEGIN


select 	obter_dados_parametros_cih('EV')
into STRICT	nr_seq_evento_w
;

select	obter_setor_atendimento(nr_atendimento_p)
into STRICT	cd_setor_atendimento_w
;

select	max(nr_seq_sitio_princ),
	max(nr_seq_sitio_espec)
into STRICT	nr_seq_sitio_princ_w,
	nr_seq_sitio_espec_w
from	cih_local_infeccao a,
	cih_ficha_ocorrencia b
where	a.nr_ficha_ocorrencia = b.nr_ficha_ocorrencia
and	nr_atendimento = nr_atendimento_p;

if (nr_seq_sitio_princ_w IS NOT NULL AND nr_seq_sitio_princ_w::text <> '') then

	select	max(ds_sitio_principal)
	into STRICT	ds_sitio_principal_w
	from 	niss_sitio_principal
	where 	nr_sequencia = nr_seq_sitio_princ_w;
	
	if (ds_sitio_principal_w IS NOT NULL AND ds_sitio_principal_w::text <> '') then

		mensagem_w	:= chr(13) || obter_desc_expressao(298565) || ' ' || ds_sitio_principal_w;
	end if;

end if;

if (nr_seq_sitio_espec_w IS NOT NULL AND nr_seq_sitio_espec_w::text <> '') then

	select	max(ds_sitio_especifico)
	into STRICT	ds_sitio_especifico_w
	from 	niss_sitio_especifico
	where 	nr_sequencia = nr_seq_sitio_espec_w;
	
	if (ds_sitio_especifico_w IS NOT NULL AND ds_sitio_especifico_w::text <> '') then
		mensagem_w	:= mensagem_w || chr(13) || obter_desc_expressao(298563) || ' ' || ds_sitio_especifico_w;
	end if;
	
end if;


insert into qua_evento_paciente(
	nr_sequencia,
	cd_estabelecimento,
	dt_atualizacao,
	nm_usuario,
	nr_atendimento,
	nr_seq_evento,
	dt_evento,
	ds_evento,
	cd_setor_atendimento,
	dt_cadastro,
	nm_usuario_origem,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nm_usuario_reg,
	nr_seq_classif_evento,
	dt_liberacao,
	cd_pessoa_fisica,
	ie_status,
	ie_origem,
	ie_tipo_evento,
	ie_situacao,
	cd_funcao_ativa
	)
values (
	nextval('qua_evento_paciente_seq'),
	cd_estabelecimento_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_atendimento_p,
	nr_seq_evento_w,
	clock_timestamp(),
	obter_desc_expressao(726879) || mensagem_w,
	cd_setor_atendimento_w,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	nm_usuario_p,
	null,
	clock_timestamp(),
	obter_pessoa_atendimento(nr_atendimento_p,'C'),
	'1',
	'S',
	'E',
	'A',
	obter_funcao_ativa
	);

--commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_evento_infeccao (nm_usuario_p text, nr_atendimento_p bigint, cd_estabelecimento_p bigint) FROM PUBLIC;

