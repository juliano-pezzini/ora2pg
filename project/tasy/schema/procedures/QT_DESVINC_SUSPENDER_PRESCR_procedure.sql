-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qt_desvinc_suspender_prescr ( nr_prescricao_p bigint, nr_seq_atendimento_p bigint, nm_usuario_p text, ie_exclui_prescr_p text) AS $body$
DECLARE


dt_liberacao_w		   	timestamp;
dt_liberacao_farmacia_w 	timestamp;
ie_prescr_baixada_w		bigint := 0;
ie_consiste_prescr_w		varchar(1):= 'N';
dt_fim_adm_w			paciente_atendimento.dt_fim_adm%type;


BEGIN

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_atendimento_p IS NOT NULL AND nr_seq_atendimento_p::text <> '') then

	CALL validar_medic_admin(nr_prescricao_p, nr_seq_atendimento_p);

	begin
		select dt_fim_adm
		into STRICT	dt_fim_adm_w
		from	paciente_atendimento
		where	nr_seq_atendimento = nr_seq_atendimento_p;
	exception when no_data_found then
		dt_fim_adm_w := null;
	end;

	if (dt_fim_adm_w IS NOT NULL AND dt_fim_adm_w::text <> '') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1162167);
	end if;
	
	ie_consiste_prescr_w := Obter_Param_Usuario(3130, 327, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_consiste_prescr_w);

	if (coalesce(ie_consiste_prescr_w,'N') = 'S') then
		select 	count(*) 
		into STRICT	ie_prescr_baixada_w
		from	prescr_material
		where	nr_prescricao	= nr_prescricao_p
		and	cd_motivo_baixa > 0;

		if (ie_prescr_baixada_w > 0) then
			CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(194111);
		end if;
	end if;
		
	update  paciente_atendimento
	set	nr_prescricao		 = NULL,
		dt_geracao_prescricao	 = NULL,
		dt_atualizacao		=	clock_timestamp(),
		nm_usuario		=	nm_usuario_p
	where	nr_seq_atendimento 	=	nr_seq_atendimento_p
	and 	nr_prescricao		=	nr_prescricao_p;
	
	CALL Suspender_Prescricao(nr_prescricao_p,
				 null,
				 '',
				 nm_usuario_p, 'N');
	
	
	if (ie_exclui_prescr_p = 'S') then
	begin
		delete from prescr_medica where nr_prescricao = nr_prescricao_p;
		exception
			when others then
			rollback;
			CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(187506);
			
	end;	
	end if;


end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qt_desvinc_suspender_prescr ( nr_prescricao_p bigint, nr_seq_atendimento_p bigint, nm_usuario_p text, ie_exclui_prescr_p text) FROM PUBLIC;

