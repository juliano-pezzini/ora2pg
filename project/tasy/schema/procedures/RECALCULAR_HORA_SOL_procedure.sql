-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE recalcular_hora_sol (nr_prescricao_p bigint, dt_Pri_prescricao_p timestamp, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text) AS $body$
DECLARE



IE_SE_NECESSARIO_w 	varchar(1);
IE_ETAPA_ESPECIAL_w	varchar(1);
IE_ACM_w		varchar(1);
ie_horario_solucao_w	varchar(1);
ie_calc_SN_W		varchar(1);
ds_horarios_w		varchar(255);
ds_horarios_2w		varchar(255);
nr_etapas_w		smallint;
qt_tempo_aplicacao_w	double precision;
nr_horas_intervalo_w	double precision;
nr_sequencia_w		integer;


C01 CURSOR FOR
	SELECT	a.NR_SEQ_SOLUCAO,
		a.IE_ACM,
		a.NR_ETAPAS,
		a.IE_SE_NECESSARIO,
		a.IE_ETAPA_ESPECIAL,
		a.QT_TEMPO_APLICACAO
	from	prescr_solucao a
	where	a.nr_prescricao = nr_prescricao_p
	and	coalesce(ie_hemodialise,'N') = 'N';


BEGIN

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (dt_Pri_prescricao_p IS NOT NULL AND dt_Pri_prescricao_p::text <> '') then

	ie_horario_solucao_w := obter_param_usuario(924, 284, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_horario_solucao_w);
	ie_calc_SN_w := obter_param_usuario(924, 302, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_calc_SN_w);

	open C01;
	loop
	fetch C01 into
		nr_sequencia_w,
		IE_ACM_w,
		nr_etapas_w,
		IE_SE_NECESSARIO_w,
		IE_ETAPA_ESPECIAL_w,
		qt_tempo_aplicacao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if 	((coalesce(nr_etapas_w, 0 ) > 0) and (qt_tempo_aplicacao_w IS NOT NULL AND qt_tempo_aplicacao_w::text <> '') and
			((coalesce(ie_calc_SN_w, 'S') = 'S') or (coalesce(IE_SE_NECESSARIO_w, 'N') = 'N'))) then

			if (coalesce(IE_ETAPA_ESPECIAL_w, 'N')  = 'S') then
				nr_etapas_w  := nr_etapas_w + 1;
			end if;

			nr_horas_intervalo_w := dividir(qt_tempo_aplicacao_w,nr_etapas_w);

			SELECT * FROM CALCULA_HORARIOS_ETAPAS(dt_Pri_prescricao_p, nr_etapas_w, nr_horas_intervalo_w, nm_usuario_p, ie_horario_solucao_w, qt_tempo_aplicacao_w, ds_horarios_w, ds_horarios_2w, 'N', 'N') INTO STRICT ds_horarios_w, ds_horarios_2w;

			update 	Prescr_solucao set
				ds_horarios = ds_horarios_w,
				hr_prim_horario = to_char(dt_Pri_prescricao_p, 'hh24:mi')
			where 	NR_SEQ_SOLUCAO = nr_sequencia_w
			and 	nr_prescricao = nr_prescricao_p;

		elsif (coalesce(IE_ETAPA_ESPECIAL_w, 'N') = 'S') and
			((coalesce(IE_SE_NECESSARIO_w,'N') = 'S') or (coalesce(IE_ACM_w,'N') =  'S')) then

			nr_etapas_w  := nr_etapas_w + 1;
			nr_horas_intervalo_w := dividir(qt_tempo_aplicacao_w,nr_etapas_w);

			SELECT * FROM CALCULA_HORARIOS_ETAPAS(dt_Pri_prescricao_p, nr_etapas_w, nr_horas_intervalo_w, nm_usuario_p, ie_horario_solucao_w, qt_tempo_aplicacao_w, ds_horarios_w, ds_horarios_2w, 'N', 'N') INTO STRICT ds_horarios_w, ds_horarios_2w;

			update 	Prescr_solucao set
				ds_horarios = ds_horarios_w,
				hr_prim_horario = to_char(dt_Pri_prescricao_p, 'hh24:mi')
			where 	NR_SEQ_SOLUCAO = nr_sequencia_w
			and 	nr_prescricao = nr_prescricao_p;
		end if;
		end;
	end loop;
	close C01;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE recalcular_hora_sol (nr_prescricao_p bigint, dt_Pri_prescricao_p timestamp, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text) FROM PUBLIC;

