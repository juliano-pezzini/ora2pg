-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_pls_atualizar_receita_in ( nr_seq_lote_p bigint, nr_seq_mensalidade_p bigint, nr_seq_item_p bigint, nr_seq_atualizacao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_mens_seg_p bigint default null, ie_tipo_movimento_p text default null, qt_movimento_p INOUT bigint DEFAULT NULL) AS $body$
DECLARE


cd_classificacao_credito_w	varchar(255);
cd_classificacao_debito_w	varchar(255);
ie_preco_w			varchar(2);
ie_tipo_segurado_w		varchar(2);
ie_regulamentacao_w		varchar(2);
ie_tipo_contratacao_w		varchar(2);
ie_segmentacao_w		varchar(2);
nr_seq_item_w			bigint;
cd_conta_credito_w		varchar(20);
cd_conta_debito_w		varchar(20);
ie_tipo_item_w			varchar(2);
nr_seq_plano_w			bigint;
nr_seq_sca_w			bigint;
nr_seq_tipo_lanc_w		bigint;
dt_referencia_w			timestamp;
nr_seq_esquema_w		bigint;
cd_historico_padrao_w		bigint;
cd_historico_estorno_w		bigint;
cd_historico_baixa_w		bigint;
nr_seq_contrato_w		bigint;
cd_conta_rec_w			varchar(20);
cd_conta_deb_w			varchar(20);
nr_seq_conta_w			bigint;
nr_seq_conta_copartic_w		bigint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
nr_seq_grupo_ans_w		bigint;
nr_seq_grupo_ans_ww		bigint;
nr_seq_grupo_superior_w		bigint;
ie_classif_grupo_w		varchar(5);
ie_classif_grupo_ww		varchar(5);
nr_seq_regra_copartic_w		bigint;
ie_tipo_relacao_w		varchar(2);
nr_seq_tipo_atendimento_w	bigint;
cd_medico_executor_w		varchar(10);
ie_regime_internacao_w		varchar(1);
nr_seq_conselho_w		bigint;
ie_ato_cooperado_w		varchar(5);
cd_classif_ato_coop_w		varchar(30);
cd_classif_ato_aux_w		varchar(30);
cd_classif_ato_nao_coop_w	varchar(30);
cd_conta_ato_coop_w		varchar(20);
cd_conta_ato_aux_w		varchar(20);
cd_conta_ato_nao_coop_w		varchar(20);
ie_tipo_contrato_w		varchar(2);
ie_tipo_vinculo_operadora_w	varchar(2);
ie_codificacao_w		varchar(2);
vl_fixo_w			varchar(30);
cd_conta_contabil_w		varchar(20);
ie_debito_credito_w		varchar(1);
ie_tipo_movimentacao_w		varchar(2);
cd_classificacao_ato_w		varchar(30);
nr_seq_conta_pos_estab_w	bigint;
ie_tipo_outorgante_w		varchar(3);
ie_tipo_operacao_w		varchar(3);
nr_seq_classificacao_sca_w	bigint;
ie_embutido_produto_w		varchar(1);
ie_forma_contab_sca_w		varchar(2);
nr_seq_segurado_w		bigint;
qt_regra_ato_item_w		bigint;
ie_tipo_operacao_plano_seg_w	varchar(3);
nr_seq_plano_seg_w		bigint;
ds_mascara_w			varchar(30);
cd_conta_antec_w		varchar(20);
cd_conta_contab_baixa_antec_w	varchar(20);
cd_historico_antec_w		bigint;
cd_historico_antec_baixa_w	bigint;
cd_historico_rev_baixa_w	bigint;
cd_conta_contabil_rec_antec_w	varchar(20);
cd_historico_rec_antec_w	bigint;
nr_seq_intercambio_w		bigint;
nr_seq_esquema_ww		bigint;
cd_historico_padrao_ww		bigint;
cd_historico_estorno_ww		bigint;
cd_historico_baixa_ww		bigint;
ie_tipo_movimentacao_ww		varchar(2);
ie_forma_contab_sca_ww		varchar(2);
nr_seq_plano_ww			bigint;
nr_seq_sca_ww			bigint;
ie_tipo_outorgante_ww		varchar(3);
ie_tipo_segurado_ww		varchar(2);
ie_tipo_plano_ww		varchar(3);
nr_seq_classif_sca_ww		bigint;
ie_tipo_vinculo_operadora_ww	varchar(2);
nr_seq_contrato_ww		bigint;
ie_tipo_contratacao_ww		varchar(2);
nr_seq_grupo_segmentacao_ww	bigint;
nr_seq_movimentacao_ww		bigint;
qt_segmentacao_regra_w		bigint;
qt_item_regra_w			bigint;
cd_classificacao_item_w		varchar(30);
nr_seq_pagador_w		bigint;
cd_cgc_pagador_w		varchar(14);
cd_pf_pagador_w			varchar(14);
cd_municipio_ibge_w		varchar(20);
cd_centro_custo_w		integer;
nr_seq_regra_cc_w		bigint;
nr_seq_mensalidade_w		bigint;
cd_historico_reversao_w		bigint;
cd_historico_rev_antec_w	bigint;
nr_seq_tipo_acrescimo_w		bigint;
qt_movimento_w			bigint	:= 0;

nr_seq_mens_lote_w		pls_mensalidade.nr_sequencia%type;
ie_tipo_despesa_mat_w		pls_conta_mat.ie_tipo_despesa%type;
nr_seq_rec_futura_w		pls_conta_receita_futura.nr_sequencia%type;
cd_conta_contabil_ppcng_w	pls_esquema_contabil.cd_conta_contabil_ppcng%type;
cd_historico_ppcng_w		pls_esquema_contabil.cd_historico_ppcng%type;
cd_conta_contabil_ppcng_ww	pls_esquema_contabil.cd_conta_contabil_ppcng%type;
cd_historico_ppcng_ww		pls_esquema_contabil.cd_historico_ppcng%type;
nr_seq_esquema_ppcng_w		pls_esquema_contabil.nr_sequencia%type;
cd_classificacao_ppcng_w	pls_mensalidade_seg_item.cd_classif_conta_ppcng%type;
cd_conta_devolucao_w		pls_mensalidade_seg_item.cd_conta_devolucao%type;
cd_historico_devolucao_w	pls_mensalidade_seg_item.cd_historico_devolucao%type;
cd_conta_devolucao_ww		pls_mensalidade_seg_item.cd_conta_devolucao%type;
cd_historico_devolucao_ww	pls_mensalidade_seg_item.cd_historico_devolucao%type;
nr_seq_bonificacao_w		pls_bonificacao.nr_sequencia%type;
nr_seq_bonificacao_ww		pls_bonificacao.nr_sequencia%type;
nr_seq_bonif_vinculo_w		pls_bonificacao_vinculo.nr_sequencia%type;
cd_empresa_w			empresa.cd_empresa%type;
nr_id_copartic_w		oid;
nr_id_pos_estab_w		oid;
nr_id_item_w			oid;
nr_seq_tipo_conta_w		pls_conta.nr_seq_tipo_conta%type;
nr_seq_tipo_conta_ww		bigint;
ie_benef_remido_w		pls_esquema_contabil.ie_benef_remido%type;
ie_benef_remido_ww		pls_esquema_contabil.ie_benef_remido%type;
ie_tipo_lote_w			varchar(1) := 3;
ie_performance_contab_w		pls_visible_false.ie_performance_contab%type;
ie_tipo_guia_w			pls_esquema_contabil.ie_tipo_guia%type;
ie_tipo_guia_ww			pls_esquema_contabil.ie_tipo_guia%type;
nr_seq_tipo_prestador_w		pls_esquema_contabil.nr_seq_tipo_prestador%type;
nr_seq_tipo_prestador_ww	pls_esquema_contabil.nr_seq_tipo_prestador%type;
nr_seq_prestador_exec_w		pls_conta.nr_seq_prestador_exec%type;
nr_seq_vinculo_sca_w		pls_mensalidade_seg_item.nr_seq_vinculo_sca%type;
ie_origem_nota_credito_w	nota_credito.ie_origem%type;
ie_origem_nota_credito_ww	pls_esquema_contabil.ie_origem_nota_credito%type;
ie_recomposicao_ww		pls_esquema_contabil.ie_recomposicao_reajuste%type;
ie_recomposicao_w		pls_mensalidade_seg_item.ie_recomposicao%type;

c_itens_mensalidade CURSOR FOR	
	SELECT	a.nr_sequencia,
		e.ie_tipo_contratacao,
		e.ie_preco,
		e.ie_segmentacao,
		e.ie_regulamentacao,
		h.ie_tipo_segurado,
		a.ie_tipo_item,
		b.nr_seq_plano,
		f.nr_seq_plano nr_seq_sca,
		a.nr_seq_tipo_lanc,
		CASE WHEN ie_tipo_movimento_p='DC' THEN d.dt_contabilizacao  ELSE d.dt_mesano_referencia END ,
		h.nr_seq_contrato,
		h.nr_seq_intercambio,
		a.nr_seq_conta,
		h.ie_tipo_vinculo_operadora,
		CASE WHEN coalesce(a.nr_seq_vinculo_sca::text, '') = '' THEN e.ie_tipo_operacao  ELSE 'A' END , /* Se existir vinculo do item com algum SCA, a operacao e SCA, senao busca operacao do produto do beneficiario */
		f.ie_embutido_produto,
		h.nr_sequencia,
		e.ie_tipo_operacao ie_tipo_operacao_plano_seg,
		e.nr_sequencia nr_seq_plano_seg,
		(	SELECT	count(*)
			from	pls_contab_ato_item x
			where	x.ie_tipo_item_mensalidade = a.ie_tipo_item
			and	((x.nr_seq_tipo_lanc = a.nr_seq_tipo_lanc) or (coalesce(x.nr_seq_tipo_lanc::text, '') = ''))) qt_ato,
		c.nr_seq_pagador,
		c.nr_sequencia nr_seq_mensalidade,
		a.nr_seq_tipo_acrescimo,
		a.oid,
		a.nr_seq_bonificacao_vinculo,
		(	select 	max(z.nr_seq_tipo_conta)
			from 	pls_conta z
			where 	a.nr_seq_conta = z.nr_sequencia) nr_seq_tipo_conta,
		pls_obter_se_benef_remido(h.nr_sequencia,CASE WHEN ie_tipo_movimento_p='DC' THEN d.dt_contabilizacao  ELSE d.dt_mesano_referencia END ) ie_benef_remido,
		(	select	max(z.ie_tipo_guia)
			from	pls_conta z
			where	a.nr_seq_conta = z.nr_sequencia) ie_tipo_guia,
		(	select	max(z.nr_seq_prestador_exec)
			from	pls_conta z
			where	a.nr_seq_conta = z.nr_sequencia) nr_seq_prestador_exec,
		a.nr_seq_vinculo_sca nr_seq_vinculo_sca,
		n.ie_origem,
		a.ie_recomposicao
	FROM pls_segurado h, pls_plano e, pls_lote_mensalidade d, pls_mensalidade c, pls_mensalidade_segurado b, pls_mensalidade_seg_item a
LEFT OUTER JOIN pls_sca_vinculo f ON (a.nr_seq_vinculo_sca = f.nr_sequencia)
LEFT OUTER JOIN nota_credito n ON (a.nr_seq_nota_credito = n.nr_sequencia)
WHERE b.nr_sequencia	= a.nr_seq_mensalidade_seg and h.nr_sequencia	= b.nr_seq_segurado --and	e.nr_sequencia	= h.nr_seq_plano
  and e.nr_sequencia	= b.nr_seq_plano and c.nr_sequencia	= b.nr_seq_mensalidade and d.nr_sequencia	= c.nr_seq_lote and d.nr_sequencia	= nr_seq_lote_p   and coalesce(c.nr_seq_cancel_rec_mens::text, '') = '' and coalesce(nr_seq_mensalidade_p::text, '') = '' and coalesce(nr_seq_item_p::text, '') = '' and coalesce(nr_seq_mens_seg_p::text, '') = '' and coalesce(a.vl_item,0) <> 0 and (ie_tipo_movimento_p = 'P'
	or (ie_tipo_movimento_p = 'DR'
	and	pkg_date_utils.start_of(d.dt_mesano_referencia, 'MONTH', 0) >= pkg_date_utils.start_of(b.dt_mesano_referencia, 'MONTH', 0))
	or (ie_tipo_movimento_p = 'DC'
	and	pkg_date_utils.start_of(d.dt_contabilizacao, 'MONTH', 0) >= pkg_date_utils.start_of(b.dt_mesano_referencia, 'MONTH', 0)))
	
union all

	select	a.nr_sequencia,
		e.ie_tipo_contratacao,
		e.ie_preco,
		e.ie_segmentacao,
		e.ie_regulamentacao,
		h.ie_tipo_segurado,
		a.ie_tipo_item,
		b.nr_seq_plano,
		f.nr_seq_plano nr_seq_sca,
		a.nr_seq_tipo_lanc,
		CASE WHEN ie_tipo_movimento_p='DC' THEN d.dt_contabilizacao  ELSE d.dt_mesano_referencia END ,
		h.nr_seq_contrato,
		h.nr_seq_intercambio,
		a.nr_seq_conta,
		h.ie_tipo_vinculo_operadora,
		CASE WHEN coalesce(a.nr_seq_vinculo_sca::text, '') = '' THEN e.ie_tipo_operacao  ELSE 'A' END , /* Se existir vinculo do item com algum SCA, a operacao e SCA, senao busca operacao do produto do beneficiario */
		f.ie_embutido_produto,
		h.nr_sequencia,
		e.ie_tipo_operacao ie_tipo_operacao_plano_seg,
		e.nr_sequencia nr_seq_plano_seg,
		(	select	count(*)
			from	pls_contab_ato_item x
			where	x.ie_tipo_item_mensalidade = a.ie_tipo_item
			and	((x.nr_seq_tipo_lanc = a.nr_seq_tipo_lanc) or (coalesce(x.nr_seq_tipo_lanc::text, '') = ''))) qt_ato,
		c.nr_seq_pagador,
		c.nr_sequencia nr_seq_mensalidade,
		a.nr_seq_tipo_acrescimo,
		a.oid,
		a.nr_seq_bonificacao_vinculo,
		(	select 	max(z.nr_seq_tipo_conta)
			from 	pls_conta z
			where 	a.nr_seq_conta = z.nr_sequencia) nr_seq_tipo_conta,
		pls_obter_se_benef_remido(h.nr_sequencia,CASE WHEN ie_tipo_movimento_p='DC' THEN d.dt_contabilizacao  ELSE d.dt_mesano_referencia END ) ie_benef_remido,
		(	select	max(z.ie_tipo_guia)
			from	pls_conta z
			where	a.nr_seq_conta = z.nr_sequencia) ie_tipo_guia,
		(	select	max(z.nr_seq_prestador_exec)
			from	pls_conta z
			where	a.nr_seq_conta = z.nr_sequencia) nr_seq_prestador_exec,
		a.nr_seq_vinculo_sca nr_seq_vinculo_sca,
		n.ie_origem,
		a.ie_recomposicao
	FROM pls_segurado h, pls_plano e, pls_lote_mensalidade d, pls_mensalidade c, pls_mensalidade_segurado b, pls_mensalidade_seg_item a
LEFT OUTER JOIN pls_sca_vinculo f ON (a.nr_seq_vinculo_sca = f.nr_sequencia)
LEFT OUTER JOIN nota_credito n ON (a.nr_seq_nota_credito = n.nr_sequencia)
WHERE b.nr_sequencia	= a.nr_seq_mensalidade_seg and h.nr_sequencia	= b.nr_seq_segurado --and	e.nr_sequencia	= h.nr_seq_plano
  and e.nr_sequencia	= b.nr_seq_plano and c.nr_sequencia	= b.nr_seq_mensalidade and d.nr_sequencia	= c.nr_seq_lote and c.nr_sequencia	= nr_seq_mensalidade_p   and coalesce(c.nr_seq_cancel_rec_mens::text, '') = '' and coalesce(nr_seq_lote_p::text, '') = '' and coalesce(nr_seq_item_p::text, '') = '' and coalesce(nr_seq_mens_seg_p::text, '') = '' and coalesce(a.vl_item,0) <> 0
	 
union all

	select	a.nr_sequencia,
		e.ie_tipo_contratacao,
		e.ie_preco,
		e.ie_segmentacao,
		e.ie_regulamentacao,
		h.ie_tipo_segurado,
		a.ie_tipo_item,
		b.nr_seq_plano,
		f.nr_seq_plano nr_seq_sca,
		a.nr_seq_tipo_lanc,
		CASE WHEN ie_tipo_movimento_p='DC' THEN d.dt_contabilizacao  ELSE d.dt_mesano_referencia END ,
		h.nr_seq_contrato,
		h.nr_seq_intercambio,
		a.nr_seq_conta,
		h.ie_tipo_vinculo_operadora,
		CASE WHEN coalesce(a.nr_seq_vinculo_sca::text, '') = '' THEN e.ie_tipo_operacao  ELSE 'A' END , /* Se existir vinculo do item com algum SCA, a operacao e SCA, senao busca operacao do produto do beneficiario */
		f.ie_embutido_produto,
		h.nr_sequencia,
		e.ie_tipo_operacao ie_tipo_operacao_plano_seg,
		e.nr_sequencia nr_seq_plano_seg,
		(	select	count(*)
			from	pls_contab_ato_item x
			where	x.ie_tipo_item_mensalidade = a.ie_tipo_item
			and	((x.nr_seq_tipo_lanc = a.nr_seq_tipo_lanc) or (coalesce(x.nr_seq_tipo_lanc::text, '') = ''))) qt_ato,
		c.nr_seq_pagador,
		c.nr_sequencia nr_seq_mensalidade,
		a.nr_seq_tipo_acrescimo,
		a.oid,
		a.nr_seq_bonificacao_vinculo,
		(	select 	max(z.nr_seq_tipo_conta)
			from 	pls_conta z
			where 	a.nr_seq_conta = z.nr_sequencia) nr_seq_tipo_conta,
		pls_obter_se_benef_remido(h.nr_sequencia,CASE WHEN ie_tipo_movimento_p='DC' THEN d.dt_contabilizacao  ELSE d.dt_mesano_referencia END ) ie_benef_remido,
		(	select	max(z.ie_tipo_guia)
			from	pls_conta z
			where	a.nr_seq_conta = z.nr_sequencia) ie_tipo_guia,
		(	select	max(z.nr_seq_prestador_exec)
			from	pls_conta z
			where	a.nr_seq_conta = z.nr_sequencia) nr_seq_prestador_exec,
		a.nr_seq_vinculo_sca nr_seq_vinculo_sca,
		n.ie_origem,
		a.ie_recomposicao
	FROM pls_segurado h, pls_plano e, pls_lote_mensalidade d, pls_mensalidade c, pls_mensalidade_segurado b, pls_mensalidade_seg_item a
LEFT OUTER JOIN pls_sca_vinculo f ON (a.nr_seq_vinculo_sca = f.nr_sequencia)
LEFT OUTER JOIN nota_credito n ON (a.nr_seq_nota_credito = n.nr_sequencia)
WHERE a.nr_seq_mensalidade_seg = b.nr_sequencia and h.nr_sequencia	= b.nr_seq_segurado and e.nr_sequencia	= b.nr_seq_plano and c.nr_sequencia	= b.nr_seq_mensalidade and d.nr_sequencia	= c.nr_seq_lote and a.nr_sequencia	= nr_seq_item_p   and coalesce(c.nr_seq_cancel_rec_mens::text, '') = '' and coalesce(nr_seq_lote_p::text, '') = '' and coalesce(nr_seq_mensalidade_p::text, '') = '' and coalesce(nr_seq_mens_seg_p::text, '') = '' and coalesce(a.vl_item,0) <> 0
	 
union all

	select	a.nr_sequencia,
		e.ie_tipo_contratacao,
		e.ie_preco,
		e.ie_segmentacao,
		e.ie_regulamentacao,
		h.ie_tipo_segurado,
		a.ie_tipo_item,
		b.nr_seq_plano,
		f.nr_seq_plano nr_seq_sca,
		a.nr_seq_tipo_lanc,
		b.dt_mesano_referencia,
		h.nr_seq_contrato,
		h.nr_seq_intercambio,
		a.nr_seq_conta,
		h.ie_tipo_vinculo_operadora,
		CASE WHEN coalesce(a.nr_seq_vinculo_sca::text, '') = '' THEN e.ie_tipo_operacao  ELSE 'A' END , /* Se existir vinculo do item com algum SCA, a operacao e SCA, senao busca operacao do produto do beneficiario */
		f.ie_embutido_produto,
		h.nr_sequencia,
		e.ie_tipo_operacao ie_tipo_operacao_plano_seg,
		e.nr_sequencia nr_seq_plano_seg,
		(	select	count(*)
			from	pls_contab_ato_item x
			where	x.ie_tipo_item_mensalidade = a.ie_tipo_item
			and	((x.nr_seq_tipo_lanc = a.nr_seq_tipo_lanc) or (coalesce(x.nr_seq_tipo_lanc::text, '') = ''))) qt_ato,
		c.nr_seq_pagador,
		c.nr_sequencia nr_seq_mensalidade,
		a.nr_seq_tipo_acrescimo,
		a.oid,
		a.nr_seq_bonificacao_vinculo,
		(	select 	max(z.nr_seq_tipo_conta)
			from 	pls_conta z
			where 	a.nr_seq_conta = z.nr_sequencia) nr_seq_tipo_conta,
		pls_obter_se_benef_remido(h.nr_sequencia,b.dt_mesano_referencia) ie_benef_remido,
		(	select	max(z.ie_tipo_guia)
			from	pls_conta z
			where	a.nr_seq_conta = z.nr_sequencia) ie_tipo_guia,
		(	select	max(z.nr_seq_prestador_exec)
			from	pls_conta z
			where	a.nr_seq_conta = z.nr_sequencia) nr_seq_prestador_exec,
		a.nr_seq_vinculo_sca nr_seq_vinculo_sca,
		n.ie_origem,
		a.ie_recomposicao
	FROM pls_segurado h, pls_plano e, pls_lote_mensalidade d, pls_mensalidade c, pls_mensalidade_segurado b, pls_mensalidade_seg_item a
LEFT OUTER JOIN pls_sca_vinculo f ON (a.nr_seq_vinculo_sca = f.nr_sequencia)
LEFT OUTER JOIN nota_credito n ON (a.nr_seq_nota_credito = n.nr_sequencia)
WHERE b.nr_sequencia	= a.nr_seq_mensalidade_seg and h.nr_sequencia	= b.nr_seq_segurado and e.nr_sequencia	= b.nr_seq_plano and c.nr_sequencia	= b.nr_seq_mensalidade and d.nr_sequencia	= c.nr_seq_lote and b.nr_sequencia	= nr_seq_mens_seg_p and a.nr_sequencia	= coalesce(nr_seq_item_p,a.nr_sequencia)   and coalesce(c.nr_seq_cancel_rec_mens::text, '') = '' and coalesce(nr_seq_lote_p::text, '') = '' and coalesce(nr_seq_mensalidade_p::text, '') = '' and coalesce(a.vl_item,0) <> 0 and ie_performance_contab_w = 'M' order by ie_tipo_item;

c_esquema CURSOR FOR
	SELECT	a.nr_sequencia,
		a.cd_historico_padrao,
		a.cd_historico_estorno,
		a.cd_historico_baixa,
		a.ie_tipo_movimentacao,
		a.ie_forma_contab_sca,
		a.nr_seq_plano,
		a.nr_seq_sca,
		a.ie_tipo_outorgante,
		a.ie_tipo_segurado,
		a.ie_tipo_plano,
		a.nr_seq_classif_sca,
		a.ie_tipo_vinculo_operadora,
		a.nr_seq_contrato,
		a.nr_seq_bonificacao,
		a.ie_tipo_contratacao,
		a.nr_seq_grupo_segmentacao,
		a.nr_seq_movimentacao,
		a.cd_conta_contabil_ppcng,
		a.cd_historico_ppcng,
		a.nr_seq_tipo_conta,
		a.cd_conta_devolucao,
		a.cd_historico_devolucao,
		a.ie_benef_remido,
		a.ie_tipo_guia,
		a.nr_seq_tipo_prestador,
		a.ie_origem_nota_credito,
		a.ie_recomposicao_reajuste
	from	pls_esquema_contabil	a
	where	a.ie_tipo_regra		= 'M'
	and	a.cd_estabelecimento	= cd_estabelecimento_p
	and	dt_referencia_w between a.dt_inicio_vigencia and coalesce(a.dt_fim_vigencia,dt_referencia_w)
	order by
		coalesce(CASE WHEN coalesce(a.ie_status_mensalidade::text, '') = '' THEN ' ' WHEN a.ie_status_mensalidade='C' THEN  ' '  ELSE 'A' END ,' '),
		coalesce(a.ie_tipo_segurado,' '),
		coalesce(a.nr_seq_contrato,0),
		coalesce(a.ie_tipo_plano,' '),
		coalesce(a.nr_seq_plano,0),
		coalesce(a.nr_seq_sca,0),
		coalesce(a.ie_forma_contab_sca,' '),
		coalesce(a.ie_tipo_contratacao,' '),
		coalesce(a.ie_tipo_outorgante,' '),
		coalesce(a.ie_tipo_item_mensalidade,'A'),
		coalesce(a.nr_seq_tipo_lancamento,0),
		coalesce(a.nr_seq_classif_sca,0),
		coalesce(a.ie_tipo_vinculo_operadora,' '),
		coalesce(a.nr_seq_bonificacao,0),
		coalesce(a.nr_seq_tipo_conta,0),
		coalesce(a.ie_tipo_guia, 0),
		coalesce(a.nr_seq_tipo_prestador, 0),
		coalesce(a.ie_benef_remido,' '),
		coalesce(a.ie_origem_nota_credito,' '),
		coalesce(a.ie_recomposicao_reajuste,'A'),
		coalesce(a.dt_inicio_vigencia,clock_timestamp());

c_segmentacao CURSOR FOR
	SELECT	ie_codificacao,
		vl_fixo,
		cd_conta_contabil,
		ie_debito_credito,
		ds_mascara
	from	pls_esquema_contabil_seg
	where	nr_seq_regra_esquema = nr_seq_esquema_w
	order by
		ie_debito_credito,
		nr_seq_apresentacao;

c_coparticipacao CURSOR FOR
	SELECT	a.nr_sequencia,
		b.cd_procedimento,
		b.ie_origem_proced,
		a.nr_seq_regra,
		a.cd_conta_cred,
		a.cd_conta_deb,
		coalesce((	SELECT	max(r.ie_ato_cooperado)
			from	pls_conta_medica_resumo r
			where	r.nr_seq_conta		= b.nr_seq_conta
			and	r.nr_seq_conta_proc	= b.nr_sequencia),b.ie_ato_cooperado) ie_ato_cooperado,
		null ie_tipo_despesa_mat,
		b.nr_seq_grupo_ans,
		a.oid
	from	pls_conta_coparticipacao	a,
		pls_conta_proc			b
	where	b.nr_sequencia	= a.nr_seq_conta_proc
	and	b.nr_seq_conta	= nr_seq_conta_w
	
union

	select	a.nr_sequencia,
		null cd_procedimento,
		null ie_origem_proced,
		a.nr_seq_regra,
		a.cd_conta_cred,
		a.cd_conta_deb,
		coalesce((	select	max(r.ie_ato_cooperado)
			from	pls_conta_medica_resumo r
			where	r.nr_seq_conta		= b.nr_seq_conta
			and	r.nr_seq_conta_mat	= b.nr_sequencia),b.ie_ato_cooperado) ie_ato_cooperado,
		b.ie_tipo_despesa ie_tipo_despesa_mat,
		b.nr_seq_grupo_ans,
		a.oid
	from	pls_conta_coparticipacao	a,
		pls_conta_mat			b
	where	b.nr_sequencia	= a.nr_seq_conta_mat
	and	b.nr_seq_conta	= nr_seq_conta_w;

c_pos_estabelecido CURSOR FOR
	SELECT	a.nr_sequencia,
		b.cd_procedimento,
		b.ie_origem_proced,
		a.cd_conta_cred,
		a.cd_conta_deb,
		coalesce((	SELECT	max(r.ie_ato_cooperado)
			from	pls_conta_medica_resumo r
			where	r.nr_seq_conta		= b.nr_seq_conta
			and	r.nr_seq_conta_proc	= b.nr_sequencia),b.ie_ato_cooperado) ie_ato_cooperado,
		null ie_tipo_despesa_mat,
		b.nr_seq_grupo_ans,
		a.oid
	from	pls_conta_pos_estabelecido	a,
		pls_conta_proc			b
	where	b.nr_sequencia	= a.nr_seq_conta_proc
	and	b.nr_seq_conta	= nr_seq_conta_w
	and	coalesce(a.ie_situacao,'A') = 'A'
	
union

	select	a.nr_sequencia,
		null cd_procedimento,
		null ie_origem_proced,
		a.cd_conta_cred,
		a.cd_conta_deb,
		coalesce((	select	max(r.ie_ato_cooperado)
			from	pls_conta_medica_resumo r
			where	r.nr_seq_conta		= b.nr_seq_conta
			and	r.nr_seq_conta_mat	= b.nr_sequencia),b.ie_ato_cooperado) ie_ato_cooperado,
		b.ie_tipo_despesa ie_tipo_despesa_mat,
		b.nr_seq_grupo_ans,
		a.oid
	from	pls_conta_pos_estabelecido	a,
		pls_conta_mat			b
	where	b.nr_sequencia	= a.nr_seq_conta_mat
	and	b.nr_seq_conta	= nr_seq_conta_w
	and	coalesce(a.ie_situacao,'A') = 'A';

c_antecipacao CURSOR FOR
	SELECT	cd_conta_contabil,
		cd_conta_contab_baixa,
		cd_conta_contabil_rec_antec,
		cd_historico,
		cd_historico_baixa,
		cd_historico_rev_baixa,
		cd_historico_rec_antec,
		cd_historico_reversao,
		cd_historico_rev_antec,
		nr_sequencia
	from	pls_conta_receita_futura
	where	cd_estabelecimento	= cd_estabelecimento_p
	and	trunc(dt_referencia_w, 'dd') between trunc(dt_vigencia_inicial,'dd') and trunc(coalesce(dt_vigencia_final,dt_referencia_w),'dd')
	and	((ie_tipo_contratacao = ie_tipo_contratacao_w) or (coalesce(ie_tipo_contratacao::text, '') = ''))
	and	((ie_tipo_segurado = ie_tipo_segurado_w) or (coalesce(ie_tipo_segurado::text, '') = ''))
	and	((nr_seq_plano = nr_seq_plano_seg_w) or (coalesce(nr_seq_plano::text, '') = ''))
	and	((nr_seq_sca = nr_seq_sca_w) or (coalesce(nr_seq_sca::text, '') = ''))
	and	((ie_tipo_item = ie_tipo_item_w) or (coalesce(ie_tipo_item::text, '') = ''))
	and	((ie_tipo_vinculo_operadora	= ie_tipo_vinculo_operadora_w) or (coalesce(ie_tipo_vinculo_operadora::text, '') = ''))
	and	((nr_seq_tipo_lanc = nr_seq_tipo_lanc_w) or (coalesce(nr_seq_tipo_lanc::text, '') = ''))
	order by
		coalesce(ie_tipo_item,0),
		coalesce(nr_seq_plano,0),
		coalesce(nr_seq_sca,0),
		coalesce(ie_tipo_segurado,' '),
		coalesce(ie_tipo_contratacao,' '),
		coalesce(ie_tipo_vinculo_operadora,' '),
		coalesce(cd_conta_contabil,' ');

c_classif_baixa CURSOR FOR
	SELECT	a.nr_sequencia
	from	pls_mensalidade a
	where	a.nr_sequencia	= coalesce(nr_seq_mensalidade_p,a.nr_sequencia)
	and	a.nr_seq_lote	= coalesce(nr_seq_lote_p,a.nr_seq_lote)
	and	exists ( SELECT	1
			from	pls_mensalidade_seg_item i,
				pls_mensalidade_segurado s
			where	s.nr_sequencia	= i.nr_seq_mensalidade_seg
			and	a.nr_sequencia	= s.nr_seq_mensalidade
			and	i.nr_sequencia	= coalesce(nr_seq_item_p,i.nr_sequencia));


BEGIN
qt_movimento_w	:= qt_movimento_p;

select	coalesce(max(ie_performance_contab), 'N')
into STRICT	ie_performance_contab_w
from	pls_visible_false
where	cd_estabelecimento = cd_estabelecimento_p;

select	max(cd_empresa)
into STRICT	cd_empresa_w
from	estabelecimento
where	cd_estabelecimento	= cd_estabelecimento_p;

select	max(ie_tipo_outorgante)
into STRICT	ie_tipo_outorgante_w
from	pls_outorgante
where	cd_estabelecimento	= cd_estabelecimento_p;

open c_itens_mensalidade;
loop
fetch c_itens_mensalidade into
	nr_seq_item_w,
	ie_tipo_contratacao_w,
	ie_preco_w,
	ie_segmentacao_w,
	ie_regulamentacao_w,
	ie_tipo_segurado_w,
	ie_tipo_item_w,
	nr_seq_plano_w,
	nr_seq_sca_w,
	nr_seq_tipo_lanc_w,
	dt_referencia_w,
	nr_seq_contrato_w,
	nr_seq_intercambio_w,
	nr_seq_conta_w,
	ie_tipo_vinculo_operadora_w,
	ie_tipo_operacao_w,
	ie_embutido_produto_w,
	nr_seq_segurado_w,
	ie_tipo_operacao_plano_seg_w,
	nr_seq_plano_seg_w,
	qt_regra_ato_item_w,
	nr_seq_pagador_w,
	nr_seq_mensalidade_w,
	nr_seq_tipo_acrescimo_w,
	nr_id_item_w,
	nr_seq_bonif_vinculo_w,
	nr_seq_tipo_conta_w,
	ie_benef_remido_w,
	ie_tipo_guia_w,
	nr_seq_prestador_exec_w,
	nr_seq_vinculo_sca_w,
	ie_origem_nota_credito_w,
	ie_recomposicao_w;
EXIT WHEN NOT FOUND; /* apply on c_itens_mensalidade */
	begin
	nr_seq_esquema_w		:= null;
	nr_seq_classificacao_sca_w	:= null;
	nr_seq_esquema_ppcng_w		:= null;
	
	if (ie_performance_contab_w = 'M') then
		if (ie_tipo_movimento_p = 'P') then
			ie_tipo_lote_w	:= 1; /* 1 - Provision */
		elsif (ie_tipo_movimento_p = 'R') then
			ie_tipo_lote_w	:= 2; /* 2 - Revenue */
		else
			ie_tipo_lote_w	:= 3; /* 3 - Both */
		end if;
	else
		ie_tipo_lote_w	:= 3; /* 3 - Both */
	end if;
	
	if (coalesce(nr_seq_contrato_w,0) <> 0) then
		select	CASE WHEN coalesce(cd_pf_estipulante::text, '') = '' THEN 'PJ'  ELSE 'PF' END
		into STRICT	ie_tipo_contrato_w
		from	pls_contrato
		where	nr_sequencia	= nr_seq_contrato_w;
	elsif (coalesce(nr_seq_intercambio_w,0) <> 0) then
		select	CASE WHEN coalesce(cd_pessoa_fisica::text, '') = '' THEN 'PJ'  ELSE 'PF' END
		into STRICT	ie_tipo_contrato_w
		from	pls_intercambio
		where	nr_sequencia	= nr_seq_intercambio_w;
	end if;
	

		/*Dados do prestador executante*/

	if (nr_seq_prestador_exec_w IS NOT NULL AND nr_seq_prestador_exec_w::text <> '') then
		select	max(nr_seq_tipo_prestador)
		into STRICT	nr_seq_tipo_prestador_w
		from	pls_prestador
		where	nr_sequencia	= nr_seq_prestador_exec_w  LIMIT 1;
	end if;

	cd_conta_antec_w			:= null;
	cd_conta_contab_baixa_antec_w		:= null;
	cd_conta_contabil_rec_antec_w		:= null;
	cd_historico_antec_w			:= null;
	cd_historico_antec_baixa_w		:= null;
	cd_historico_rev_baixa_w		:= null;
	cd_historico_rec_antec_w		:= null;
	cd_historico_reversao_w			:= null;
	cd_historico_rev_antec_w		:= null;
	nr_seq_rec_futura_w			:= null;
	cd_conta_contabil_ppcng_w		:= null;
	cd_historico_ppcng_w			:= null;
	cd_classificacao_ppcng_w		:= null;
	cd_conta_devolucao_w			:= null;
	cd_historico_devolucao_w		:= null;

	open c_antecipacao;
	loop
	fetch c_antecipacao into
		cd_conta_antec_w,
		cd_conta_contab_baixa_antec_w,
		cd_conta_contabil_rec_antec_w,
		cd_historico_antec_w,
		cd_historico_antec_baixa_w,
		cd_historico_rev_baixa_w,
		cd_historico_rec_antec_w,
		cd_historico_reversao_w,
		cd_historico_rev_antec_w,
		nr_seq_rec_futura_w;
	EXIT WHEN NOT FOUND; /* apply on c_antecipacao */
	end loop;
	close c_antecipacao;

	if (qt_regra_ato_item_w > 0) then
		ie_ato_cooperado_w	:= 'AC';
	else
		ie_ato_cooperado_w	:= 'NA';
	end if;
	
	if (nr_seq_sca_w IS NOT NULL AND nr_seq_sca_w::text <> '') then
		select	max(nr_seq_classificacao)
		into STRICT	nr_seq_classificacao_sca_w
		from	pls_plano
		where	nr_sequencia	= nr_seq_sca_w;
	end if;
	
	if (coalesce(ie_embutido_produto_w,'N') = 'S') and (ie_tipo_item_w = '1') then
		ie_tipo_item_w			:= '1';
		nr_seq_sca_w			:= null;
		nr_seq_classificacao_sca_w	:= null;
		
		ie_tipo_operacao_w	:= ie_tipo_operacao_plano_seg_w;
		nr_seq_plano_w		:= nr_seq_plano_seg_w;
	end if;
	
	nr_seq_bonificacao_w	:= null;
	
	if (coalesce(nr_seq_bonif_vinculo_w,0) <> 0) then
		select	max(nr_seq_bonificacao)
		into STRICT	nr_seq_bonificacao_w
		from	pls_bonificacao_vinculo
		where	nr_sequencia	= nr_seq_bonif_vinculo_w;
	end if;
	
	open c_esquema;
	loop
	fetch c_esquema into
		nr_seq_esquema_ww,
		cd_historico_padrao_ww,
		cd_historico_estorno_ww,
		cd_historico_baixa_ww,
		ie_tipo_movimentacao_ww,
		ie_forma_contab_sca_ww,
		nr_seq_plano_ww,
		nr_seq_sca_ww,
		ie_tipo_outorgante_ww,
		ie_tipo_segurado_ww,
		ie_tipo_plano_ww,
		nr_seq_classif_sca_ww,
		ie_tipo_vinculo_operadora_ww,
		nr_seq_contrato_ww,
		nr_seq_bonificacao_ww,
		ie_tipo_contratacao_ww,
		nr_seq_grupo_segmentacao_ww,
		nr_seq_movimentacao_ww,
		cd_conta_contabil_ppcng_ww,
		cd_historico_ppcng_ww,
		nr_seq_tipo_conta_ww,
		cd_conta_devolucao_ww,
		cd_historico_devolucao_ww,
		ie_benef_remido_ww,
		ie_tipo_guia_ww,
		nr_seq_tipo_prestador_ww,
		ie_origem_nota_credito_ww,
		ie_recomposicao_ww;
	EXIT WHEN NOT FOUND; /* apply on c_esquema */
		begin
		if	((nr_seq_plano_ww = nr_seq_plano_w) or (coalesce(nr_seq_plano_ww::text, '') = '')) and
			((nr_seq_sca_ww = nr_seq_sca_w) or (coalesce(nr_seq_sca_ww::text, '') = '')) and
			((ie_tipo_outorgante_ww = ie_tipo_outorgante_w) or (coalesce(ie_tipo_outorgante_ww::text, '') = '')) and
			((ie_tipo_segurado_ww = ie_tipo_segurado_w) or (coalesce(ie_tipo_segurado_ww::text, '') = '')) and
			((ie_tipo_plano_ww = ie_tipo_operacao_w) or (coalesce(ie_tipo_plano_ww::text, '') = '')) and
			((nr_seq_classif_sca_ww = nr_seq_classificacao_sca_w) or (coalesce(nr_seq_classif_sca_ww::text, '') = '')) and
			((ie_tipo_vinculo_operadora_ww	= ie_tipo_vinculo_operadora_w) or (coalesce(ie_tipo_vinculo_operadora_ww::text, '') = '')) and
			((nr_seq_contrato_ww = nr_seq_contrato_w) or (coalesce(nr_seq_contrato_ww::text, '') = '')) and
			((ie_tipo_contratacao_ww = ie_tipo_contratacao_w) or (coalesce(ie_tipo_contratacao_ww::text, '') = '')) and
			((nr_seq_tipo_conta_ww = nr_seq_tipo_conta_w) or (coalesce(nr_seq_tipo_conta_ww::text, '') = '')) and
			((nr_seq_bonificacao_ww = nr_seq_bonificacao_w) or (coalesce(nr_seq_bonificacao_ww::text, '') = '') or (ie_tipo_item_w <> '14')) and
			((ie_benef_remido_ww = ie_benef_remido_w) or (coalesce(ie_benef_remido_ww::text, '') = '')) and
			((ie_tipo_guia_ww = ie_tipo_guia_w) or (coalesce(ie_tipo_guia_ww::text, '') = '')) and
			((nr_seq_tipo_prestador_ww = nr_seq_tipo_prestador_w) or (coalesce(nr_seq_tipo_prestador_ww::text, '') = '')) and
			((ie_origem_nota_credito_ww = ie_origem_nota_credito_w) or (coalesce(ie_origem_nota_credito_ww::text, '') = '')) and
			((ie_recomposicao_ww = coalesce(ie_recomposicao_w,'N')) or (coalesce(ie_recomposicao_ww,'A') = 'A')) then
			select	count(1)
			into STRICT	qt_item_regra_w
			from	pls_contab_mov_mens	a,
				pls_contab_mov_mens_lote b
			where	a.nr_seq_lote	= b.nr_sequencia
			and	b.nr_sequencia	= nr_seq_movimentacao_ww
			and	a.ie_tipo_item	= ie_tipo_item_w
			and	((a.nr_seq_tipo_lancamento = nr_seq_tipo_lanc_w) or (coalesce(a.nr_seq_tipo_lancamento::text, '') = ''))
			and	((a.nr_seq_tipo_acrescimo = nr_seq_tipo_acrescimo_w) or (coalesce(a.nr_seq_tipo_acrescimo::text, '') = ''))  LIMIT 1;
			
			if (qt_item_regra_w > 0) then
				if (coalesce(nr_seq_grupo_segmentacao_ww,0) = 0) then
					qt_segmentacao_regra_w	:= 1;
				else
					select	count(1)
					into STRICT	qt_segmentacao_regra_w
					from	pls_grupo_seg_item	l,
						pls_grupo_segmentacao	k
					where	l.nr_seq_grupo		= k.nr_sequencia
					and	k.nr_sequencia		= nr_seq_grupo_segmentacao_ww
					and	l.ie_segmentacao	= ie_segmentacao_w;
				end if;
				
				if (qt_segmentacao_regra_w > 0) then
					nr_seq_esquema_w		:= nr_seq_esquema_ww;
					cd_historico_padrao_w		:= cd_historico_padrao_ww;
					cd_historico_estorno_w		:= cd_historico_estorno_ww;
					cd_historico_baixa_w		:= cd_historico_baixa_ww;
					ie_tipo_movimentacao_w		:= ie_tipo_movimentacao_ww;
					ie_forma_contab_sca_w		:= ie_forma_contab_sca_ww;
					cd_conta_contabil_ppcng_w	:= cd_conta_contabil_ppcng_ww;
					cd_historico_ppcng_w		:= cd_historico_ppcng_ww;
					nr_seq_esquema_ppcng_w		:= nr_seq_esquema_ww;
					cd_conta_devolucao_w		:= cd_conta_devolucao_ww;
					cd_historico_devolucao_w	:= cd_historico_devolucao_ww;
				end if;
			end if;
		end if;
		end;
	end loop;
	close c_esquema;
	
	/* OS 356772 - Caso existir um regra para o SCA, informando que o mesmo deve ser contabilizado com as contas do produto, deve buscar a regra do produto */

	if (coalesce(ie_forma_contab_sca_w,'S') = 'P') and
			(
				(
					ie_tipo_item_w in ('15','35')
				)
				or (ie_tipo_item_w = '4' and (nr_seq_vinculo_sca_w IS NOT NULL AND nr_seq_vinculo_sca_w::text <> ''))
			 )
		  then
		ie_tipo_item_w	:= '1';
		nr_seq_sca_w	:= null;
		nr_seq_classificacao_sca_w	:= null;
		ie_tipo_operacao_w		:= ie_tipo_operacao_plano_seg_w;
		nr_seq_plano_w			:= nr_seq_plano_seg_w;
		
		open c_esquema;
		loop
		fetch c_esquema into
			nr_seq_esquema_ww,
			cd_historico_padrao_ww,
			cd_historico_estorno_ww,
			cd_historico_baixa_ww,
			ie_tipo_movimentacao_ww,
			ie_forma_contab_sca_ww,
			nr_seq_plano_ww,
			nr_seq_sca_ww,
			ie_tipo_outorgante_ww,
			ie_tipo_segurado_ww,
			ie_tipo_plano_ww,
			nr_seq_classif_sca_ww,
			ie_tipo_vinculo_operadora_ww,
			nr_seq_contrato_ww,
			nr_seq_bonificacao_ww,
			ie_tipo_contratacao_ww,
			nr_seq_grupo_segmentacao_ww,
			nr_seq_movimentacao_ww,
			cd_conta_contabil_ppcng_ww,
			cd_historico_ppcng_ww,
			nr_seq_tipo_conta_ww,
			cd_conta_devolucao_ww,
			cd_historico_devolucao_ww,
			ie_benef_remido_ww,
			ie_tipo_guia_ww,
			nr_seq_tipo_prestador_ww,
			ie_origem_nota_credito_ww,
			ie_recomposicao_ww;
		EXIT WHEN NOT FOUND; /* apply on c_esquema */
			begin
			if	((nr_seq_plano_ww = nr_seq_plano_w) or (coalesce(nr_seq_plano_ww::text, '') = '')) and
				((nr_seq_sca_ww = nr_seq_sca_w) or (coalesce(nr_seq_sca_ww::text, '') = '')) and
				((ie_tipo_outorgante_ww = ie_tipo_outorgante_w) or (coalesce(ie_tipo_outorgante_ww::text, '') = '')) and
				((ie_tipo_segurado_ww = ie_tipo_segurado_w) or (coalesce(ie_tipo_segurado_ww::text, '') = '')) and
				((ie_tipo_plano_ww = ie_tipo_operacao_w) or (coalesce(ie_tipo_plano_ww::text, '') = '')) and
				((nr_seq_classif_sca_ww = nr_seq_classificacao_sca_w) or (coalesce(nr_seq_classif_sca_ww::text, '') = '')) and
				((ie_tipo_vinculo_operadora_ww	= ie_tipo_vinculo_operadora_w) or (coalesce(ie_tipo_vinculo_operadora_ww::text, '') = '')) and
				((nr_seq_contrato_ww = nr_seq_contrato_w) or (coalesce(nr_seq_contrato_ww::text, '') = '')) and
				((nr_seq_tipo_conta_ww = nr_seq_tipo_conta_w) or (coalesce(nr_seq_tipo_conta_ww::text, '') = '')) and
				((ie_tipo_contratacao_ww = ie_tipo_contratacao_w) or (coalesce(ie_tipo_contratacao_ww::text, '') = '')) and
				((ie_benef_remido_ww = ie_benef_remido_w) or (coalesce(ie_benef_remido_ww::text, '') = '')) and
				((ie_tipo_guia_ww = ie_tipo_guia_w) or (coalesce(ie_tipo_guia_ww::text, '') = '')) and
				((nr_seq_tipo_prestador_ww = nr_seq_tipo_prestador_w) or (coalesce(nr_seq_tipo_prestador_ww::text, '') = '')) and
				((ie_origem_nota_credito_ww = ie_origem_nota_credito_w) or (coalesce(ie_origem_nota_credito_ww::text, '') = '')) and
				((ie_recomposicao_ww = coalesce(ie_recomposicao_w,'N')) or (coalesce(ie_recomposicao_ww,'A') = 'A')) then
				select	count(1)
				into STRICT	qt_item_regra_w
				from	pls_contab_mov_mens	a,
					pls_contab_mov_mens_lote b
				where	a.nr_seq_lote	= b.nr_sequencia
				and	b.nr_sequencia	= nr_seq_movimentacao_ww
				and	a.ie_tipo_item	= ie_tipo_item_w
				and	((a.nr_seq_tipo_lancamento = nr_seq_tipo_lanc_w) or (coalesce(a.nr_seq_tipo_lancamento::text, '') = ''))
				and	((a.nr_seq_tipo_acrescimo = nr_seq_tipo_acrescimo_w) or (coalesce(a.nr_seq_tipo_acrescimo::text, '') = ''))  LIMIT 1;
				
				if (qt_item_regra_w > 0) then
					if (coalesce(nr_seq_grupo_segmentacao_ww,0) = 0) then
						qt_segmentacao_regra_w	:= 1;
					else
						select	count(1)
						into STRICT	qt_segmentacao_regra_w
						from	pls_grupo_seg_item	l,
							pls_grupo_segmentacao	k
						where	l.nr_seq_grupo		= k.nr_sequencia
						and	k.nr_sequencia		= nr_seq_grupo_segmentacao_ww
						and	l.ie_segmentacao	= ie_segmentacao_w;
					end if;
					
					if (qt_segmentacao_regra_w > 0) then
						nr_seq_esquema_w		:= nr_seq_esquema_ww;
						cd_historico_padrao_w		:= cd_historico_padrao_ww;
						cd_historico_estorno_w		:= cd_historico_estorno_ww;
						cd_historico_baixa_w		:= cd_historico_baixa_ww;
						ie_tipo_movimentacao_w		:= ie_tipo_movimentacao_ww;
						ie_forma_contab_sca_w		:= ie_forma_contab_sca_ww;
						cd_conta_contabil_ppcng_w	:= cd_conta_contabil_ppcng_ww;
						cd_historico_ppcng_w		:= cd_historico_ppcng_ww;
						nr_seq_esquema_ppcng_w		:= nr_seq_esquema_ww;
						cd_conta_devolucao_w		:= cd_conta_devolucao_ww;
						cd_historico_devolucao_w	:= cd_historico_devolucao_ww;
					end if;
				end if;
			end if;
			end;
		end loop;
		close c_esquema;
	end if;
	
	cd_classificacao_debito_w	:= '';
	cd_classificacao_credito_w	:= '';
	cd_classif_ato_coop_w		:= '';
	cd_classif_ato_aux_w		:= '';
	cd_classif_ato_nao_coop_w	:= '';
	cd_conta_credito_w		:= null;
	cd_conta_debito_w		:= null;
	cd_classificacao_ato_w		:= null;
	cd_classificacao_ppcng_w	:= null;
	
	if (ie_preco_w != '1') then
		cd_conta_contabil_ppcng_w	:= null;
		cd_historico_ppcng_w		:= null;
	else
		if (cd_conta_contabil_ppcng_w IS NOT NULL AND cd_conta_contabil_ppcng_w::text <> '') then
			cd_classificacao_ppcng_w	:= substr(ctb_obter_classif_conta(cd_conta_contabil_ppcng_w, null, dt_referencia_w),1,40);
		end if;
	end if;
	
	if (ie_tipo_item_w not in ('3','6','7')) then
		open c_segmentacao;
		loop
		fetch c_segmentacao into
			ie_codificacao_w,
			vl_fixo_w,
			cd_conta_contabil_w,
			ie_debito_credito_w,
			ds_mascara_w;
		EXIT WHEN NOT FOUND; /* apply on c_segmentacao */
			begin
			cd_classificacao_item_w	:= null;
			
			if (ie_debito_credito_w = 'C') then /* Classificacao CREDITO */
				if (ie_codificacao_w = 'CR') then /* Codigo reduzido */
					select	cd_classificacao_atual
					into STRICT	cd_classificacao_credito_w
					from	conta_contabil
					where	cd_conta_contabil	= cd_conta_contabil_w;
					
					cd_conta_credito_w	:= cd_conta_contabil_w;
				elsif (ie_codificacao_w = 'JR') then
					select	max(cd_cgc)
					into STRICT	cd_cgc_pagador_w
					from	pls_contrato_pagador
					where	nr_sequencia	= nr_seq_pagador_w;
					
					select	max(cd_conta_contabil)
					into STRICT	cd_conta_contabil_w
					from	pessoa_jur_conta_cont a
					where	a.cd_cgc	= cd_cgc_pagador_w
					and	((a.cd_estabelecimento = cd_estabelecimento_p)
					or	((coalesce(a.cd_estabelecimento::text, '') = '')
					and (a.cd_empresa	= cd_empresa_w)))
					and	a.ie_tipo_conta	= 'R'
					and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
					
					select	max(cd_classificacao_atual)
					into STRICT	cd_classificacao_credito_w
					from	conta_contabil
					where	cd_conta_contabil	= cd_conta_contabil_w;
					
					cd_conta_credito_w	:= cd_conta_contabil_w;
				elsif (ie_codificacao_w = 'FX') then /* Fixo */
					cd_classificacao_item_w	:= vl_fixo_w;
				elsif (ie_codificacao_w = 'FP') then /* Formacao de Preco */
					if (ie_tipo_operacao_w = 'A') then
						cd_classificacao_item_w	:= '9';
					else
						cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_formacao_preco(ie_preco_w);
					end if;
				elsif (ie_codificacao_w = 'R') then /* Regulamentacao */
					cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_regulamentacao(ie_regulamentacao_w);
				elsif (ie_codificacao_w = 'TC') then /* Tipo de contratacao */
					cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_tipo_contratacao(ie_tipo_contratacao_w);
				elsif (ie_codificacao_w = 'TP') then /* Tipo de Contrato (Pessoa fisica ou Juridica) */
					cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_tipo_pessoa_contrato(ie_tipo_contrato_w);
				elsif (ie_codificacao_w = 'S') then /* Segmentacao */
					cd_classificacao_item_w	:= lpad(ie_segmentacao_w,2,'0');
				elsif (ie_codificacao_w = 'TA') then /* Tipo de ato cooperado */
					cd_classificacao_item_w	:= 'A';
				elsif (ie_codificacao_w = 'RC') then /* Tipo de contratacao / Regulamentacao */
					cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_contratacao_regulamentacao(ie_tipo_contratacao_w,ie_regulamentacao_w);
				end if;
				
				if (cd_classificacao_item_w IS NOT NULL AND cd_classificacao_item_w::text <> '') then
					if (ds_mascara_w = '00') then
						cd_classificacao_item_w	:= lpad(cd_classificacao_item_w,2,'0') || '.';
					elsif (ds_mascara_w = '0.0') then
						cd_classificacao_item_w	:= substr(lpad(cd_classificacao_item_w,2,'0'),1,1) ||'.'||substr(lpad(cd_classificacao_item_w,2,'0'),2,1) || '.';
					elsif (ds_mascara_w = '0_') then
						cd_classificacao_item_w	:= cd_classificacao_item_w;
					else
						cd_classificacao_item_w	:= cd_classificacao_item_w || '.';
					end if;
					
					cd_classificacao_credito_w	:= cd_classificacao_credito_w || cd_classificacao_item_w;
				end if;
			elsif (ie_debito_credito_w = 'D') then /* Classificacao DEBITO */
				if (ie_codificacao_w = 'CR') then /* Codigo reduzido */
					select	cd_classificacao_atual
					into STRICT	cd_classificacao_debito_w
					from	conta_contabil
					where	cd_conta_contabil	= cd_conta_contabil_w;
					
					cd_conta_debito_w	:= cd_conta_contabil_w;
				elsif (ie_codificacao_w = 'JR') then
					select	max(cd_cgc)
					into STRICT	cd_cgc_pagador_w
					from	pls_contrato_pagador
					where	nr_sequencia	= nr_seq_pagador_w;
					
					select	max(cd_conta_contabil)
					into STRICT	cd_conta_contabil_w
					from	pessoa_jur_conta_cont a
					where	a.cd_cgc	= cd_cgc_pagador_w
					and	((a.cd_estabelecimento = cd_estabelecimento_p)
					or	((coalesce(a.cd_estabelecimento::text, '') = '')
					and (a.cd_empresa	= cd_empresa_w)))
					and	a.ie_tipo_conta	= 'R'
					and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
					
					select	max(cd_classificacao_atual)
					into STRICT	cd_classificacao_debito_w
					from	conta_contabil
					where	cd_conta_contabil	= cd_conta_contabil_w;
					
					cd_conta_debito_w	:= cd_conta_contabil_w;
				elsif (ie_codificacao_w = 'FX') then /* Fixo */
					cd_classificacao_item_w	:= vl_fixo_w;
				elsif (ie_codificacao_w = 'FP') then /* Formacao de Preco */
					if (ie_tipo_operacao_w = 'A') then
						cd_classificacao_item_w	:= '9';
					else
						cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_formacao_preco(ie_preco_w);
					end if;
				elsif (ie_codificacao_w = 'R') then /* Regulamentacao */
					cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_regulamentacao(ie_regulamentacao_w);
				elsif (ie_codificacao_w = 'TC') then /* Tipo de contratacao */
					cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_tipo_contratacao(ie_tipo_contratacao_w);
				elsif (ie_codificacao_w = 'S') then /* Segmentacao */
					cd_classificacao_item_w	:= lpad(ie_segmentacao_w,2,'0');
				elsif (ie_codificacao_w = 'TP') then /* Tipo de Contrato (Pessoa fisica ou Juridica) */
					cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_tipo_pessoa_contrato(ie_tipo_contrato_w);
				elsif (ie_codificacao_w = 'TA') then /* Tipo de ato cooperado */
					cd_classificacao_item_w	:= 'A';
				elsif (ie_codificacao_w = 'RC') then /* Tipo de contratacao / Regulamentacao */
					cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_contratacao_regulamentacao(ie_tipo_contratacao_w,ie_regulamentacao_w);
				end if;
				
				if (cd_classificacao_item_w IS NOT NULL AND cd_classificacao_item_w::text <> '') then
					if (ds_mascara_w = '00') then
						cd_classificacao_item_w	:= lpad(cd_classificacao_item_w,2,'0') || '.';
					elsif (ds_mascara_w = '0.0') then
						cd_classificacao_item_w	:= substr(lpad(cd_classificacao_item_w,2,'0'),1,1) ||'.'||substr(lpad(cd_classificacao_item_w,2,'0'),2,1) || '.';
					elsif (ds_mascara_w = '0_') then
						cd_classificacao_item_w	:= cd_classificacao_item_w;
					else
						cd_classificacao_item_w	:= cd_classificacao_item_w || '.';
					end if;
					
					cd_classificacao_debito_w	:= cd_classificacao_debito_w || cd_classificacao_item_w;
				end if;
			end if;
			end;
		end loop;
		close c_segmentacao;
		
		/* Remover o ultimo ponto da classificacao */

		if (substr(cd_classificacao_credito_w,length(cd_classificacao_credito_w),length(cd_classificacao_credito_w)) = '.') then
			cd_classificacao_credito_w	:= substr(cd_classificacao_credito_w,1,length(cd_classificacao_credito_w)-1);
		end if;
		
		if (substr(cd_classificacao_debito_w,length(cd_classificacao_debito_w),length(cd_classificacao_debito_w)) = '.') then
			cd_classificacao_debito_w	:= substr(cd_classificacao_debito_w,1,length(cd_classificacao_debito_w)-1);
		end if;
		
		if (ie_ato_cooperado_w = 'AC') then
			if (cd_classificacao_credito_w like '%A%') then
				cd_classificacao_ato_w		:= cd_classificacao_credito_w;
				cd_classificacao_credito_w	:= null;
			elsif (cd_classificacao_debito_w like '%A%') then
				cd_classificacao_ato_w		:= cd_classificacao_debito_w;
				cd_classificacao_debito_w	:= null;
			end if;
		end if;
		
		if (cd_classificacao_ato_w IS NOT NULL AND cd_classificacao_ato_w::text <> '') then
			cd_classif_ato_coop_w		:= replace(cd_classificacao_ato_w,'A',pls_atualizar_codificacao_pck.get_ato_cooperado('1'));
			cd_classif_ato_aux_w		:= replace(cd_classificacao_ato_w,'A',pls_atualizar_codificacao_pck.get_ato_cooperado('2'));
			cd_classif_ato_nao_coop_w	:= replace(cd_classificacao_ato_w,'A',pls_atualizar_codificacao_pck.get_ato_cooperado('3'));
			
			select	max(a.cd_conta_contabil)
			into STRICT	cd_conta_ato_coop_w
			from	conta_contabil a
			where	a.cd_classificacao_atual	= cd_classif_ato_coop_w
			and	a.cd_empresa			= cd_empresa_w
			and	a.ie_tipo			= 'A'
			and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
			
			select	max(a.cd_conta_contabil)
			into STRICT	cd_conta_ato_aux_w
			from	conta_contabil a
			where	a.cd_classificacao_atual	= cd_classif_ato_aux_w
			and	a.cd_empresa			= cd_empresa_w
			and	a.ie_tipo			= 'A'
			and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
			
			select	max(a.cd_conta_contabil)
			into STRICT	cd_conta_ato_nao_coop_w
			from	conta_contabil a
			where	a.cd_classificacao_atual	= cd_classif_ato_nao_coop_w
			and	a.cd_empresa			= cd_empresa_w
			and	a.ie_tipo			= 'A'
			and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
		else
			cd_conta_ato_coop_w	:= null;
			cd_conta_ato_aux_w	:= null;
			cd_conta_ato_nao_coop_w	:= null;
		end if;

		if (coalesce(cd_conta_credito_w::text, '') = '') then
			cd_conta_credito_w	:= ctb_obter_conta_classif(cd_classificacao_credito_w,dt_referencia_w,cd_estabelecimento_p);
		end if;

		if (coalesce(cd_conta_debito_w::text, '') = '') then
			cd_conta_debito_w	:= ctb_obter_conta_classif(cd_classificacao_debito_w,dt_referencia_w,cd_estabelecimento_p);
		end if;
						
		if (nr_seq_atualizacao_p IS NOT NULL AND nr_seq_atualizacao_p::text <> '') then
			if (coalesce(nr_seq_esquema_w::text, '') = '') then
				CALL pls_gravar_mov_contabil(nr_seq_atualizacao_p,
							1,
							nr_seq_item_w,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							nm_usuario_p,
							nr_seq_esquema_w,
							null,
							null,
							null,
							ie_tipo_lote_w);
			elsif	((ie_ato_cooperado_w = 'AC') and
				((coalesce(cd_conta_ato_coop_w::text, '') = '') or (coalesce(cd_classif_ato_aux_w::text, '') = '') or (coalesce(cd_classif_ato_nao_coop_w::text, '') = ''))) and (coalesce(cd_conta_credito_w::text, '') = '') then
				CALL pls_gravar_mov_contabil(nr_seq_atualizacao_p,
							2,
							nr_seq_item_w,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							nm_usuario_p,
							nr_seq_esquema_w,
							null,
							null,
							null,
							ie_tipo_lote_w);
			elsif	((coalesce(cd_conta_credito_w::text, '') = '') or (coalesce(cd_conta_debito_w::text, '') = '')) and (ie_ato_cooperado_w = 'NA') then
				CALL pls_gravar_mov_contabil(nr_seq_atualizacao_p,
							2,
							nr_seq_item_w,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							null,
							nm_usuario_p,
							nr_seq_esquema_w,
							null,
							null,
							null,
							ie_tipo_lote_w);
			end if;
		end if;
		
		begin
		select	cd_cgc,
			cd_pessoa_fisica
		into STRICT	cd_cgc_pagador_w,
			cd_pf_pagador_w
		from	pls_contrato_pagador
		where	nr_sequencia = nr_seq_pagador_w;
		exception
		when others then
			cd_cgc_pagador_w := '0';
			cd_pf_pagador_w := '0';
		end;
		
		if (coalesce(cd_cgc_pagador_w,'0') <> '0') then
			select	max(cd_municipio_ibge)
			into STRICT	cd_municipio_ibge_w
			from	pessoa_juridica
			where	cd_cgc = cd_cgc_pagador_w;
		elsif (coalesce(cd_pf_pagador_w,'0') <> '0') then
			select	max(cd_municipio_ibge)
			into STRICT	cd_municipio_ibge_w
			from	compl_pessoa_fisica
			where	ie_tipo_complemento = 1
			and	cd_pessoa_fisica = cd_pf_pagador_w;
		end if;
		
		cd_centro_custo_w	:= null;
				
		SELECT * FROM pls_obter_centro_custo(	'R', nr_seq_plano_w, cd_estabelecimento_p, cd_municipio_ibge_w, ie_tipo_contratacao_w, ie_regulamentacao_w, nr_seq_segurado_w, ie_tipo_item_w, cd_centro_custo_w, nr_seq_regra_cc_w, nr_seq_tipo_lanc_w, nr_seq_bonificacao_w, nr_seq_sca_w) INTO STRICT cd_centro_custo_w, nr_seq_regra_cc_w;
		
		if (ie_tipo_lote_w = 1) then
			
			update	pls_mensalidade_seg_item
			set	cd_conta_deb			= cd_conta_debito_w,
				cd_historico			= cd_historico_padrao_w,
				cd_historico_baixa		= cd_historico_baixa_w,
				cd_classif_deb			= cd_classificacao_debito_w,
				nr_seq_esquema			= nr_seq_esquema_w,
				cd_conta_antec_baixa		= cd_conta_contab_baixa_antec_w,
				cd_historico_antec		= cd_historico_antec_w,
				cd_historico_antec_baixa	= cd_historico_antec_baixa_w,
				cd_historico_rev_antec_baixa	= cd_historico_rev_baixa_w,
				cd_conta_rec_antecip		= cd_conta_antec_w,
				cd_conta_deb_antecip		= cd_conta_antec_w,
				cd_conta_contabil_rec_antec	= cd_conta_contabil_rec_antec_w,
				cd_historico_rec_antec		= cd_historico_rec_antec_w,
				cd_historico_rev_antec		= cd_historico_reversao_w,
				cd_historico_rev_rec_antec	= cd_historico_rev_antec_w,
				nr_seq_rec_futura		= nr_seq_rec_futura_w,
				cd_conta_contabil_ppcng		= cd_conta_contabil_ppcng_w,
				cd_historico_ppcng		= cd_historico_ppcng_w,
				nr_seq_esquema_ppcng		= nr_seq_esquema_ppcng_w,
				cd_classif_conta_ppcng		= cd_classificacao_ppcng_w,
				cd_centro_custo			= cd_centro_custo_w,
				cd_conta_devolucao		= cd_conta_devolucao_w,
				cd_historico_devolucao		= cd_historico_devolucao_w
			where	rowid				= nr_id_item_w;
			
			qt_movimento_w	:= qt_movimento_w + 1;
			
		elsif (ie_tipo_lote_w = 2) then
		
			update	pls_mensalidade_seg_item
			set	cd_conta_rec			= cd_conta_credito_w,
				cd_classif_cred			= cd_classificacao_credito_w,
				cd_conta_ato_cooperado		= cd_conta_ato_coop_w,
				cd_conta_ato_auxiliar		= cd_conta_ato_aux_w,
				cd_conta_ato_nao_coop		= cd_conta_ato_nao_coop_w,
				cd_classif_cooperado		= cd_classif_ato_coop_w,
				cd_classif_ato_auxiliar		= cd_classif_ato_aux_w,
				cd_classif_nao_cooperado	= cd_classif_ato_nao_coop_w,
				nr_seq_esquema_rec		= nr_seq_esquema_w
			where	rowid				= nr_id_item_w;
			
			qt_movimento_w	:= qt_movimento_w + 1;
		else
			update	pls_mensalidade_seg_item
			set	cd_conta_rec			= cd_conta_credito_w,
				cd_conta_deb			= cd_conta_debito_w,
				cd_historico			= cd_historico_padrao_w,
				cd_historico_baixa		= cd_historico_baixa_w,
				cd_conta_ato_cooperado		= cd_conta_ato_coop_w,
				cd_conta_ato_auxiliar		= cd_conta_ato_aux_w,
				cd_conta_ato_nao_coop		= cd_conta_ato_nao_coop_w,
				cd_classif_cred			= cd_classificacao_credito_w,
				cd_classif_deb			= cd_classificacao_debito_w,
				cd_classif_cooperado		= cd_classif_ato_coop_w,
				cd_classif_ato_auxiliar		= cd_classif_ato_aux_w,
				cd_classif_nao_cooperado	= cd_classif_ato_nao_coop_w,
				nr_seq_esquema			= nr_seq_esquema_w,
				nr_seq_esquema_rec		= nr_seq_esquema_w,
				cd_conta_antec_baixa		= cd_conta_contab_baixa_antec_w,
				cd_historico_antec		= cd_historico_antec_w,
				cd_historico_antec_baixa	= cd_historico_antec_baixa_w,
				cd_historico_rev_antec_baixa	= cd_historico_rev_baixa_w,
				cd_conta_rec_antecip		= cd_conta_antec_w,
				cd_conta_deb_antecip		= cd_conta_antec_w,
				cd_conta_contabil_rec_antec	= cd_conta_contabil_rec_antec_w,
				cd_historico_rec_antec		= cd_historico_rec_antec_w,
				cd_historico_rev_antec		= cd_historico_reversao_w,
				cd_historico_rev_rec_antec	= cd_historico_rev_antec_w,
				nr_seq_rec_futura		= nr_seq_rec_futura_w,
				cd_conta_contabil_ppcng		= cd_conta_contabil_ppcng_w,
				cd_historico_ppcng		= cd_historico_ppcng_w,
				nr_seq_esquema_ppcng		= nr_seq_esquema_ppcng_w,
				cd_classif_conta_ppcng		= cd_classificacao_ppcng_w,
				cd_centro_custo			= cd_centro_custo_w,
				cd_conta_devolucao		= cd_conta_devolucao_w,
				cd_historico_devolucao		= cd_historico_devolucao_w
			where	rowid				= nr_id_item_w;	
			
			qt_movimento_w	:= qt_movimento_w + 1;	
		end if;
		
		if (mod(qt_movimento_w,1000) = 0) then
			commit;
		end if;
		
	elsif (ie_tipo_item_w = '3') then
		/* 5 - Grupo ANS */

		select	max(nr_seq_tipo_atendimento),
			max(cd_medico_executor),
			max(ie_regime_internacao)
		into STRICT	nr_seq_tipo_atendimento_w,
			cd_medico_executor_w,
			ie_regime_internacao_w
		from	pls_conta
		where	nr_sequencia	= nr_seq_conta_w;
		
		select	max(c.ie_tipo_relacao)
		into STRICT	ie_tipo_relacao_w
		from	pls_conta		a,
			pls_protocolo_conta	b,
			pls_prestador		c
		where	a.nr_seq_protocolo	= b.nr_sequencia
		and	a.nr_seq_prestador_exec	= c.nr_sequencia
		and	a.nr_sequencia		= nr_seq_conta_w;
		
		begin
		select	cd_cgc,
			cd_pessoa_fisica
		into STRICT	cd_cgc_pagador_w,
			cd_pf_pagador_w
		from	pls_contrato_pagador
		where	nr_sequencia = nr_seq_pagador_w;
		exception
		when others then
			cd_cgc_pagador_w := '0';
			cd_pf_pagador_w := '0';
		end;
		
		if (coalesce(cd_cgc_pagador_w,'0') <> '0') then
			select	max(cd_municipio_ibge)
			into STRICT	cd_municipio_ibge_w
			from	pessoa_juridica
			where	cd_cgc = cd_cgc_pagador_w;
		elsif (coalesce(cd_pf_pagador_w,'0') <> '0') then
			select	max(cd_municipio_ibge)
			into STRICT	cd_municipio_ibge_w
			from	compl_pessoa_fisica
			where	ie_tipo_complemento = 1
			and	cd_pessoa_fisica = cd_pf_pagador_w;
		end if;
		
		cd_centro_custo_w	:= null;
		
		SELECT * FROM pls_obter_centro_custo(	'R', nr_seq_plano_w, cd_estabelecimento_p, cd_municipio_ibge_w, ie_tipo_contratacao_w, ie_regulamentacao_w, nr_seq_segurado_w, ie_tipo_item_w, cd_centro_custo_w, nr_seq_regra_cc_w, nr_seq_tipo_lanc_w, null, nr_seq_sca_w) INTO STRICT cd_centro_custo_w, nr_seq_regra_cc_w;
	
		open c_coparticipacao;
		loop
		fetch c_coparticipacao into
			nr_seq_conta_copartic_w,
			cd_procedimento_w,
			ie_origem_proced_w,
			nr_seq_regra_copartic_w,
			cd_conta_rec_w,
			cd_conta_deb_w,
			ie_ato_cooperado_w,
			ie_tipo_despesa_mat_w,
			nr_seq_grupo_ans_w,
			nr_id_copartic_w;
		EXIT WHEN NOT FOUND; /* apply on c_coparticipacao */
			begin
			cd_conta_credito_w		:= null;
			cd_conta_debito_w		:= null;
			--nr_seq_grupo_ans_w		:= null;
			cd_classificacao_credito_w	:= null;
			cd_classificacao_debito_w	:= null;
			
			/*
			select	max(nr_seq_conselho)
			into	nr_seq_conselho_w
			from	pessoa_fisica
			where	cd_pessoa_fisica	= cd_medico_executor_w;
			
			if	(nr_seq_grupo_ans_w is null) then
				select	pls_obter_grupo_ans(	cd_procedimento_w,
								ie_origem_proced_w,
								nr_seq_conselho_w,
								nr_seq_tipo_atendimento_w,
								ie_tipo_guia_w,
								ie_regime_internacao_w,
								ie_tipo_despesa_mat_w,
								'G',
								nvl(cd_estabelecimento_p,0))
				into	nr_seq_grupo_ans_w
				from	dual;
			end if;
			*/
			
			if (coalesce(nr_seq_grupo_ans_w,0) > 0) then
				select	max(nr_seq_grupo_superior)
				into STRICT	nr_seq_grupo_superior_w
				from	ans_grupo_despesa
				where	nr_sequencia	= nr_seq_grupo_ans_w;
				
				select	max(ie_tipo_grupo_ans)
				into STRICT	nr_seq_grupo_superior_w
				from	ans_grupo_despesa
				where	nr_sequencia	= nr_seq_grupo_superior_w;
			end if;
			
			if (coalesce(nr_seq_grupo_superior_w,0) = 0) then
				select	max(ie_tipo_grupo_ans)
				into STRICT	nr_seq_grupo_ans_ww
				from	ans_grupo_despesa
				where	nr_sequencia	= nr_seq_grupo_ans_w;
			else
				nr_seq_grupo_ans_ww	:= nr_seq_grupo_superior_w;
			end if;
			
			if (nr_seq_grupo_ans_ww = 10) then /* 1 - Consultas */
				ie_classif_grupo_w	:= '1';
				ie_classif_grupo_ww	:= '0';
			elsif (nr_seq_grupo_ans_ww = 20) then /* 49 - Exames */
				ie_classif_grupo_w	:= '2';
				ie_classif_grupo_ww	:= '0';
			elsif (nr_seq_grupo_ans_ww = 30) then /* 51 - Terapias */
				ie_classif_grupo_w	:= '3';
				ie_classif_grupo_ww	:= '0';
			elsif (nr_seq_grupo_ans_ww = 41) then /* 7 - Internacao - Honorario medico */
				ie_classif_grupo_w	:= '4';
				ie_classif_grupo_ww	:= '1';
			elsif (nr_seq_grupo_ans_ww = 42) then /* 8 - Internacao - Exames */
				ie_classif_grupo_w	:= '4';
				ie_classif_grupo_ww	:= '2';
			elsif (nr_seq_grupo_ans_ww = 43) then /* 9 - Internacao - Terapias*/
				ie_classif_grupo_w	:= '4';
				ie_classif_grupo_ww	:= '3';
			elsif (nr_seq_grupo_ans_ww = 44) then /* 10 - Internacao - Materiais medicos */
				ie_classif_grupo_w	:= '4';
				ie_classif_grupo_ww	:= '4';
			elsif (nr_seq_grupo_ans_ww = 45) then /* 11 - Internacao - Medicamentos */
				ie_classif_grupo_w	:= '4';
				ie_classif_grupo_ww	:= '5';
			elsif (nr_seq_grupo_ans_ww = 46) then /* Internacao - Procedimentos com preco fixo */
				ie_classif_grupo_w	:= '4';
				ie_classif_grupo_ww	:= '6';
			elsif (nr_seq_grupo_ans_ww = 49) then /* 12 - Internacao - Outras despesas */
				ie_classif_grupo_w	:= '4';
				ie_classif_grupo_ww	:= '9';
			elsif (nr_seq_grupo_ans_ww = 50) then /* 6 - Outros atendimentos - Ambulatoriais */
				ie_classif_grupo_w	:= '5';
				ie_classif_grupo_ww	:= '0';
			elsif (nr_seq_grupo_ans_ww = 60) then /* 16 - Demais despesas assistenciais */
				ie_classif_grupo_w	:= '6';
				ie_classif_grupo_ww	:= '0';
			end if;
			
			open c_segmentacao;
			loop
			fetch c_segmentacao into	
				ie_codificacao_w,
				vl_fixo_w,
				cd_conta_contabil_w,
				ie_debito_credito_w,
				ds_mascara_w;
			EXIT WHEN NOT FOUND; /* apply on c_segmentacao */
				begin
				cd_classificacao_item_w	:= null;
				
				if (ie_debito_credito_w = 'C') then /* Classificacao CREDITO */
					if (ie_codificacao_w = 'CR') then /* Codigo reduzido */
						select	cd_classificacao_atual
						into STRICT	cd_classificacao_credito_w
						from	conta_contabil
						where	cd_conta_contabil	= cd_conta_contabil_w;
						
						cd_conta_credito_w	:= cd_conta_contabil_w;
					elsif (ie_codificacao_w = 'JR') then
						select	max(cd_cgc)
						into STRICT	cd_cgc_pagador_w
						from	pls_contrato_pagador
						where	nr_sequencia	= nr_seq_pagador_w;
						
						select	max(cd_conta_contabil)
						into STRICT	cd_conta_contabil_w
						from	pessoa_jur_conta_cont a
						where	a.cd_cgc	= cd_cgc_pagador_w
						and	((a.cd_estabelecimento = cd_estabelecimento_p)
						or	((coalesce(a.cd_estabelecimento::text, '') = '')
						and (a.cd_empresa	= cd_empresa_w)))
						and	a.ie_tipo_conta	= 'R'
						and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
						
						select	max(cd_classificacao_atual)
						into STRICT	cd_classificacao_credito_w
						from	conta_contabil
						where	cd_conta_contabil	= cd_conta_contabil_w;
						
						cd_conta_credito_w	:= cd_conta_contabil_w;
					elsif (ie_codificacao_w = 'FX') then /* Fixo */
						cd_classificacao_item_w	:= vl_fixo_w;
					elsif (ie_codificacao_w = 'GA') then /* Grupo ANS */
						if (ie_classif_grupo_w IS NOT NULL AND ie_classif_grupo_w::text <> '') then
							cd_classificacao_item_w	:= ie_classif_grupo_w;
						else
							cd_classificacao_item_w	:= 'GA';
						end if;
					elsif (ie_codificacao_w = 'FP') then /* Formacao de Preco */
						if (ie_tipo_segurado_w = 'A') then
							cd_classificacao_item_w	:= '9';
						else
							cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_formacao_preco(ie_preco_w);
						end if;
					elsif (ie_codificacao_w = 'R') then /* Regulamentacao */
						cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_regulamentacao(ie_regulamentacao_w);
					elsif (ie_codificacao_w = 'TC') then /* Tipo de contratacao */
						if (ie_tipo_contratacao_w in ('I','CE','CA')) then
							cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_tipo_contratacao(ie_tipo_contratacao_w);
						else
							cd_classificacao_item_w	:= 'TC';
						end if;
					elsif (ie_codificacao_w = 'TP') then /* Tipo de Contrato (Pessoa fisica ou Juridica) */
						if (ie_tipo_contrato_w in ('PF','PJ')) then
							cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_tipo_pessoa_contrato(ie_tipo_contrato_w);
						else
							cd_classificacao_item_w	:= 'TP';
						end if;
					elsif (ie_codificacao_w = 'S') then /* Segmentacao */
						cd_classificacao_item_w	:= lpad(ie_segmentacao_w,2,'0');
					elsif (ie_codificacao_w = 'TR') then /* Tipo de relacao com a OPS */
						cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_tipo_relacao(ie_tipo_relacao_w);
					elsif (ie_codificacao_w = 'TA') then /* Tipo de ato cooperado */
						cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_ato_cooperado(ie_ato_cooperado_w);
					elsif (ie_codificacao_w = 'CG') then /* Complemento grupo ANS */
						if (ie_classif_grupo_ww IS NOT NULL AND ie_classif_grupo_ww::text <> '') then
							cd_classificacao_item_w	:= ie_classif_grupo_ww;
						else
							cd_classificacao_item_w	:= 'CG';
						end if;
					elsif (ie_codificacao_w = 'RC') then /* Tipo de contratacao / Regulamentacao */
						cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_contratacao_regulamentacao(ie_tipo_contratacao_w,ie_regulamentacao_w);
					end if;
					
					if (cd_classificacao_item_w IS NOT NULL AND cd_classificacao_item_w::text <> '') then
						if (ds_mascara_w = '00') then
							cd_classificacao_item_w	:= lpad(cd_classificacao_item_w,2,'0') || '.';
						elsif (ds_mascara_w = '0.0') then
							cd_classificacao_item_w	:= substr(lpad(cd_classificacao_item_w,2,'0'),1,1) ||'.'||substr(lpad(cd_classificacao_item_w,2,'0'),2,1) || '.';
						elsif (ds_mascara_w = '0_') then
							cd_classificacao_item_w	:= cd_classificacao_item_w;
						else
							cd_classificacao_item_w	:= cd_classificacao_item_w || '.';
						end if;
						
						cd_classificacao_credito_w	:= cd_classificacao_credito_w || cd_classificacao_item_w;
					end if;
				elsif (ie_debito_credito_w = 'D') then /* Classificacao DEBITO */
					if (ie_codificacao_w = 'CR') then /* Codigo reduzido */
						select	cd_classificacao_atual
						into STRICT	cd_classificacao_debito_w
						from	conta_contabil
						where	cd_conta_contabil	= cd_conta_contabil_w;
						
						cd_conta_debito_w	:= cd_conta_contabil_w;
					elsif (ie_codificacao_w = 'JR') then
						select	max(cd_cgc)
						into STRICT	cd_cgc_pagador_w
						from	pls_contrato_pagador
						where	nr_sequencia	= nr_seq_pagador_w;
						
						select	max(cd_conta_contabil)
						into STRICT	cd_conta_contabil_w
						from	pessoa_jur_conta_cont a
						where	a.cd_cgc	= cd_cgc_pagador_w
						and	((a.cd_estabelecimento = cd_estabelecimento_p)
						or	((coalesce(a.cd_estabelecimento::text, '') = '')
						and (a.cd_empresa	= cd_empresa_w)))
						and	a.ie_tipo_conta	= 'R'
						and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
						
						select	max(cd_classificacao_atual)
						into STRICT	cd_classificacao_debito_w
						from	conta_contabil
						where	cd_conta_contabil	= cd_conta_contabil_w;
						
						cd_conta_debito_w	:= cd_conta_contabil_w;
					elsif (ie_codificacao_w = 'FX') then /* Fixo */
						cd_classificacao_item_w	:= vl_fixo_w;
					elsif (ie_codificacao_w = 'GA') then /* Grupo ANS */
						if (ie_classif_grupo_w IS NOT NULL AND ie_classif_grupo_w::text <> '') then
							cd_classificacao_item_w	:= ie_classif_grupo_w;
						else
							cd_classificacao_item_w	:= 'GA';
						end if;
					elsif (ie_codificacao_w = 'FP') then /* Formacao de Preco */
						if (ie_tipo_segurado_w = 'A') then
							cd_classificacao_item_w	:= '9';
						else
							cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_formacao_preco(ie_preco_w);
						end if;
					elsif (ie_codificacao_w = 'R') then /* Regulamentacao */
						cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_regulamentacao(ie_regulamentacao_w);
					elsif (ie_codificacao_w = 'TC') then /* Tipo de contratacao */
						if (ie_tipo_contratacao_w in ('I','CE','CA')) then
							cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_tipo_contratacao(ie_tipo_contratacao_w);
						else
							cd_classificacao_item_w	:= 'TC';
						end if;
					elsif (ie_codificacao_w = 'S') then /* Segmentacao */
						cd_classificacao_item_w	:= lpad(ie_segmentacao_w,2,'0');
					elsif (ie_codificacao_w = 'TP') then /* Tipo de Contrato (Pessoa fisica ou Juridica) */
						if (ie_tipo_contrato_w in ('PF','PJ')) then
							cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_tipo_pessoa_contrato(ie_tipo_contrato_w);
						else
							cd_classificacao_item_w	:= 'TP';
						end if;
					elsif (ie_codificacao_w = 'TR') then /* Tipo de relacao com a OPS */
						cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_tipo_relacao(ie_tipo_relacao_w);
					elsif (ie_codificacao_w = 'TA') then /* Tipo de ato cooperado */
						cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_ato_cooperado(ie_ato_cooperado_w);
					elsif (ie_codificacao_w = 'CG') then /* Complemento grupo ANS */
						if (ie_classif_grupo_ww IS NOT NULL AND ie_classif_grupo_ww::text <> '') then
							cd_classificacao_item_w	:= ie_classif_grupo_ww;
						else
							cd_classificacao_item_w	:= 'CG';
						end if;
					elsif (ie_codificacao_w = 'RC') then /* Tipo de contratacao / Regulamentacao */
						cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_contratacao_regulamentacao(ie_tipo_contratacao_w,ie_regulamentacao_w);
					end if;
					
					if (cd_classificacao_item_w IS NOT NULL AND cd_classificacao_item_w::text <> '') then
						if (ds_mascara_w = '00') then
							cd_classificacao_item_w	:= lpad(cd_classificacao_item_w,2,'0') || '.';
						elsif (ds_mascara_w = '0.0') then
							cd_classificacao_item_w	:= substr(lpad(cd_classificacao_item_w,2,'0'),1,1) ||'.'||substr(lpad(cd_classificacao_item_w,2,'0'),2,1) || '.';
						elsif (ds_mascara_w = '0_') then
							cd_classificacao_item_w	:= cd_classificacao_item_w;
						else
							cd_classificacao_item_w	:= cd_classificacao_item_w || '.';
						end if;
						
						cd_classificacao_debito_w	:= cd_classificacao_debito_w || cd_classificacao_item_w;
					end if;
				end if;
				end;
			end loop;
			close c_segmentacao;
			
			/* Remover o ultimo ponto da classificacao */

			if (substr(cd_classificacao_credito_w,length(cd_classificacao_credito_w),length(cd_classificacao_credito_w)) = '.') then
				cd_classificacao_credito_w	:= substr(cd_classificacao_credito_w,1,length(cd_classificacao_credito_w)-1);
			end if;
			
			if (substr(cd_classificacao_debito_w,length(cd_classificacao_debito_w),length(cd_classificacao_debito_w)) = '.') then
				cd_classificacao_debito_w	:= substr(cd_classificacao_debito_w,1,length(cd_classificacao_debito_w)-1);
			end if;
			
			if (coalesce(cd_conta_credito_w::text, '') = '') then
				select	max(a.cd_conta_contabil)
				into STRICT	cd_conta_credito_w
				from	conta_contabil a
				where	a.cd_classificacao_atual	= cd_classificacao_credito_w
				and	a.cd_empresa			= cd_empresa_w
				and	a.ie_tipo			= 'A'
				and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
			end if;
			
			if (coalesce(cd_conta_debito_w::text, '') = '') then
				select	max(a.cd_conta_contabil)
				into STRICT	cd_conta_debito_w
				from	conta_contabil a
				where	a.cd_classificacao_atual	= cd_classificacao_debito_w
				and	a.cd_empresa			= cd_empresa_w
				and	a.ie_tipo			= 'A'
				and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
			end if;
			
			if (nr_seq_atualizacao_p IS NOT NULL AND nr_seq_atualizacao_p::text <> '') then
				if (coalesce(nr_seq_esquema_w::text, '') = '') then
					CALL pls_gravar_mov_contabil(nr_seq_atualizacao_p,
								1,
								nr_seq_item_w,
								null,
								null,
								null,
								nr_seq_conta_copartic_w,
								null,
								null,
								null,
								null,
								null,
								null,
								null,
								null,
								null,
								null,
								nm_usuario_p,
								nr_seq_esquema_w,
								null,
								null,
								null,
								ie_tipo_lote_w);
				elsif	((coalesce(cd_conta_credito_w::text, '') = '') or (coalesce(cd_conta_debito_w::text, '') = '')) then
					CALL pls_gravar_mov_contabil(nr_seq_atualizacao_p,
								2,
								nr_seq_item_w,
								null,
								null,
								null,
								nr_seq_conta_copartic_w,
								null,
								null,
								null,
								null,
								null,
								null,
								null,
								null,
								null,
								null,
								nm_usuario_p,
								nr_seq_esquema_w,
								null,
								null,
								null,
								ie_tipo_lote_w);
				end if;
			end if;
			
			if (ie_tipo_lote_w = 1) then

				update	pls_conta_coparticipacao
				set	cd_conta_deb		= cd_conta_debito_w,
					nr_seq_grupo_ans	= nr_seq_grupo_ans_w,
					cd_historico		= cd_historico_padrao_w,
					cd_historico_baixa	= cd_historico_baixa_w,
					cd_classif_deb		= cd_classificacao_debito_w,
					nr_seq_esquema		= nr_seq_esquema_w,
					cd_conta_deb_antecip	= cd_conta_antec_w,
					cd_conta_cred_antecip	= cd_conta_antec_w,
					cd_conta_antec_baixa	= cd_conta_contabil_rec_antec_w,
					nr_seq_rec_futura	= nr_seq_rec_futura_w,
					cd_centro_custo		= cd_centro_custo_w
				where	rowid			= nr_id_copartic_w;
			
				qt_movimento_w	:= qt_movimento_w + 1;
				
			elsif (ie_tipo_lote_w = 2) then
			
				update	pls_conta_coparticipacao
				set	cd_conta_cred		= cd_conta_credito_w,
					cd_classif_cred		= cd_classificacao_credito_w--,
					--cd_historico_rec	= cd_historico_padrao_w,
					--nr_seq_esquema_rec	= nr_seq_esquema_w
				where	rowid			= nr_id_copartic_w;
			
				qt_movimento_w	:= qt_movimento_w + 1;				
			else
				update	pls_conta_coparticipacao
				set	cd_conta_cred		= cd_conta_credito_w,
					cd_conta_deb		= cd_conta_debito_w,
					nr_seq_grupo_ans	= nr_seq_grupo_ans_w,
					cd_historico		= cd_historico_padrao_w,
					cd_historico_baixa	= cd_historico_baixa_w,
					cd_classif_cred		= cd_classificacao_credito_w,
					cd_classif_deb		= cd_classificacao_debito_w,
					nr_seq_esquema		= nr_seq_esquema_w,
					cd_conta_deb_antecip	= cd_conta_antec_w,
					cd_conta_cred_antecip	= cd_conta_antec_w,
					cd_conta_antec_baixa	= cd_conta_contabil_rec_antec_w,
					nr_seq_rec_futura	= nr_seq_rec_futura_w,
					cd_centro_custo		= cd_centro_custo_w
				where	rowid			= nr_id_copartic_w;
			
				qt_movimento_w	:= qt_movimento_w + 1;
			end if;
			
			if (mod(qt_movimento_w,1000) = 0) then
				commit;
			end if;
			
			end;
		end loop;
		close c_coparticipacao;

		if (ie_tipo_lote_w <> 2) then
			update	pls_mensalidade_seg_item
			set	cd_conta_contabil_ppcng		= cd_conta_contabil_ppcng_w,
				cd_historico_ppcng		= cd_historico_ppcng_w,
				nr_seq_esquema_ppcng		= nr_seq_esquema_ppcng_w,
				cd_classif_conta_ppcng		= cd_classificacao_ppcng_w,
				cd_conta_devolucao		= cd_conta_devolucao_w,
				cd_historico_devolucao		= cd_historico_devolucao_w
			where	rowid				= nr_id_item_w;
		end if;
	elsif (ie_tipo_item_w in ('6','7')) then
		/* 5 - Grupo ANS */

		select	max(nr_seq_tipo_atendimento),
			max(cd_medico_executor),
			max(ie_regime_internacao)
		into STRICT	nr_seq_tipo_atendimento_w,
			cd_medico_executor_w,
			ie_regime_internacao_w
		from	pls_conta
		where	nr_sequencia	= nr_seq_conta_w;
		
		select	max(c.ie_tipo_relacao)
		into STRICT	ie_tipo_relacao_w
		from	pls_conta		a,
			pls_protocolo_conta	b,
			pls_prestador		c
		where	b.nr_sequencia	= a.nr_seq_protocolo
		and	c.nr_sequencia	= a.nr_seq_prestador_exec
		and	a.nr_sequencia	= nr_seq_conta_w;

		open c_pos_estabelecido;
		loop
		fetch c_pos_estabelecido into	
			nr_seq_conta_pos_estab_w,
			cd_procedimento_w,
			ie_origem_proced_w,
			cd_conta_rec_w,
			cd_conta_deb_w,
			ie_ato_cooperado_w,
			ie_tipo_despesa_mat_w,
			nr_seq_grupo_ans_w,
			nr_id_pos_estab_w;
		EXIT WHEN NOT FOUND; /* apply on c_pos_estabelecido */
			begin
			cd_conta_credito_w		:= null;
			cd_conta_debito_w		:= null;
			--nr_seq_grupo_ans_w		:= null;
			cd_classificacao_credito_w	:= null;
			cd_classificacao_debito_w	:= null;
			
			/*
			select	max(nr_seq_conselho)
			into	nr_seq_conselho_w
			from	pessoa_fisica
			where	cd_pessoa_fisica	= cd_medico_executor_w;
			
			if	(nr_seq_grupo_ans_w is null) then
				select	pls_obter_grupo_ans(	cd_procedimento_w,
								ie_origem_proced_w,
								nr_seq_conselho_w,
								nr_seq_tipo_atendimento_w,
								ie_tipo_guia_w,
								ie_regime_internacao_w, 
								ie_tipo_despesa_mat_w,
								'G',
								nvl(cd_estabelecimento_p,0))
				into	nr_seq_grupo_ans_w
				from	dual;
			end if;
			*/
			
			if (coalesce(nr_seq_grupo_ans_w,0) > 0) then
				select	max(nr_seq_grupo_superior)
				into STRICT	nr_seq_grupo_superior_w
				from	ans_grupo_despesa
				where	nr_sequencia	= nr_seq_grupo_ans_w;
				
				select	max(ie_tipo_grupo_ans)
				into STRICT	nr_seq_grupo_superior_w
				from	ans_grupo_despesa
				where	nr_sequencia	= nr_seq_grupo_superior_w;
			end if;
			
			if (coalesce(nr_seq_grupo_superior_w,0) = 0) then
				select	max(ie_tipo_grupo_ans)
				into STRICT	nr_seq_grupo_ans_ww
				from	ans_grupo_despesa
				where	nr_sequencia	= nr_seq_grupo_ans_w;
			else
				nr_seq_grupo_ans_ww	:= nr_seq_grupo_superior_w;
			end if;
			
			if (nr_seq_grupo_ans_ww = 10) then /* 1 - Consultas */
				ie_classif_grupo_w	:= '1';
				ie_classif_grupo_ww	:= '0';
			elsif (nr_seq_grupo_ans_ww = 20) then /* 49 - Exames */
				ie_classif_grupo_w	:= '2';
				ie_classif_grupo_ww	:= '0';
			elsif (nr_seq_grupo_ans_ww = 30) then /* 51 - Terapias */
				ie_classif_grupo_w	:= '3';
				ie_classif_grupo_ww	:= '0';
			elsif (nr_seq_grupo_ans_ww = 41) then /* 7 - Internacao - Honorario medico */
				ie_classif_grupo_w	:= '4';
				ie_classif_grupo_ww	:= '1';
			elsif (nr_seq_grupo_ans_ww = 42) then /* 8 - Internacao - Exames */
				ie_classif_grupo_w	:= '4';
				ie_classif_grupo_ww	:= '2';
			elsif (nr_seq_grupo_ans_ww = 43) then /* 9 - Internacao - Terapias*/
				ie_classif_grupo_w	:= '4';
				ie_classif_grupo_ww	:= '3';
			elsif (nr_seq_grupo_ans_ww = 44) then /* 10 - Internacao - Materiais medicos */
				ie_classif_grupo_w	:= '4';
				ie_classif_grupo_ww	:= '4';
			elsif (nr_seq_grupo_ans_ww = 45) then /* 11 - Internacao - Medicamentos */
				ie_classif_grupo_w	:= '4';
				ie_classif_grupo_ww	:= '5';
			elsif (nr_seq_grupo_ans_ww = 46) then /* Internacao - Procedimentos com preco fixo */
				ie_classif_grupo_w	:= '4';
				ie_classif_grupo_ww	:= '6';
			elsif (nr_seq_grupo_ans_ww = 49) then /* 12 - Internacao - Outras despesas */
				ie_classif_grupo_w	:= '4';
				ie_classif_grupo_ww	:= '9';
			elsif (nr_seq_grupo_ans_ww = 50) then /* 6 - Outros atendimentos - Ambulatoriais */
				ie_classif_grupo_w	:= '5';
				ie_classif_grupo_ww	:= '0';
			elsif (nr_seq_grupo_ans_ww = 60) then /* 16 - Demais despesas assistenciais */
				ie_classif_grupo_w	:= '6';
				ie_classif_grupo_ww	:= '0';
			end if;
			
			open c_segmentacao;
			loop
			fetch c_segmentacao into	
				ie_codificacao_w,
				vl_fixo_w,
				cd_conta_contabil_w,
				ie_debito_credito_w,
				ds_mascara_w;
			EXIT WHEN NOT FOUND; /* apply on c_segmentacao */
				begin
				cd_classificacao_item_w	:= null;
				
				if (ie_debito_credito_w = 'C') then /* Classificacao CREDITO */
					if (ie_codificacao_w = 'CR') then /* Codigo reduzido */
						select	cd_classificacao_atual
						into STRICT	cd_classificacao_credito_w
						from	conta_contabil
						where	cd_conta_contabil	= cd_conta_contabil_w;
						
						cd_conta_credito_w	:= cd_conta_contabil_w;
					elsif (ie_codificacao_w = 'JR') then
						select	max(cd_cgc)
						into STRICT	cd_cgc_pagador_w
						from	pls_contrato_pagador
						where	nr_sequencia	= nr_seq_pagador_w;
						
						select	max(cd_conta_contabil)
						into STRICT	cd_conta_contabil_w
						from	pessoa_jur_conta_cont a
						where	a.cd_cgc	= cd_cgc_pagador_w
						and	((a.cd_estabelecimento = cd_estabelecimento_p)
						or	((coalesce(a.cd_estabelecimento::text, '') = '')
						and (a.cd_empresa	= cd_empresa_w)))
						and	a.ie_tipo_conta	= 'R'
						and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
						
						select	max(cd_classificacao_atual)
						into STRICT	cd_classificacao_credito_w
						from	conta_contabil
						where	cd_conta_contabil	= cd_conta_contabil_w;
						
						cd_conta_credito_w	:= cd_conta_contabil_w;
					elsif (ie_codificacao_w = 'FX') then /* Fixo */
						cd_classificacao_item_w	:= vl_fixo_w;
					elsif (ie_codificacao_w = 'GA') then /* Grupo ANS */
						cd_classificacao_item_w	:= ie_classif_grupo_w;
					elsif (ie_codificacao_w = 'FP') then /* Formacao de Preco */
						if	((ie_tipo_segurado_w = 'A') or (ie_tipo_movimentacao_w = '3')) then
							cd_classificacao_item_w	:= '9';
						else
							cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_formacao_preco(ie_preco_w);
						end if;
					elsif (ie_codificacao_w = 'R') then /* Regulamentacao */
						cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_regulamentacao(ie_regulamentacao_w);
					elsif (ie_codificacao_w = 'TC') then /* Tipo de contratacao */
						cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_tipo_contratacao(ie_tipo_contratacao_w);
					elsif (ie_codificacao_w = 'TP') then /* Tipo de Contrato (Pessoa fisica ou Juridica) */
						cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_tipo_pessoa_contrato(ie_tipo_contrato_w);
					elsif (ie_codificacao_w = 'S') then /* Segmentacao */
						cd_classificacao_item_w	:= lpad(ie_segmentacao_w,2,'0');
					elsif (ie_codificacao_w = 'TR') then /* Tipo de relacao com a OPS */
						cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_tipo_relacao(ie_tipo_relacao_w);
					elsif (ie_codificacao_w = 'TA') then /* Tipo de ato cooperado */
						cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_ato_cooperado(ie_ato_cooperado_w);
					elsif (ie_codificacao_w = 'CG') then
						cd_classificacao_item_w	:= ie_classif_grupo_ww;
					elsif (ie_codificacao_w = 'RC') then /* Tipo de contratacao / Regulamentacao */
						cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_contratacao_regulamentacao(ie_tipo_contratacao_w,ie_regulamentacao_w);
					end if;
					
					if (cd_classificacao_item_w IS NOT NULL AND cd_classificacao_item_w::text <> '') then
						if (ds_mascara_w = '00') then
							cd_classificacao_item_w	:= lpad(cd_classificacao_item_w,2,'0') || '.';
						elsif (ds_mascara_w = '0.0') then
							cd_classificacao_item_w	:= substr(lpad(cd_classificacao_item_w,2,'0'),1,1) ||'.'||substr(lpad(cd_classificacao_item_w,2,'0'),2,1) || '.';
						elsif (ds_mascara_w = '0_') then
							cd_classificacao_item_w	:= cd_classificacao_item_w;
						else
							cd_classificacao_item_w	:= cd_classificacao_item_w || '.';
						end if;
						
						cd_classificacao_credito_w	:= cd_classificacao_credito_w || cd_classificacao_item_w;
					end if;
				elsif (ie_debito_credito_w = 'D') then /* Classificacao DEBITO */
					if (ie_codificacao_w = 'CR') then /* Codigo reduzido */
						select	cd_classificacao_atual
						into STRICT	cd_classificacao_debito_w
						from	conta_contabil
						where	cd_conta_contabil	= cd_conta_contabil_w;
						
						cd_conta_debito_w	:= cd_conta_contabil_w;
					elsif (ie_codificacao_w = 'JR') then
						select	max(cd_cgc)
						into STRICT	cd_cgc_pagador_w
						from	pls_contrato_pagador
						where	nr_sequencia	= nr_seq_pagador_w;
						
						select	max(cd_conta_contabil)
						into STRICT	cd_conta_contabil_w
						from	pessoa_jur_conta_cont a
						where	a.cd_cgc	= cd_cgc_pagador_w
						and	((a.cd_estabelecimento = cd_estabelecimento_p)
						or	((coalesce(a.cd_estabelecimento::text, '') = '')
						and (a.cd_empresa	= cd_empresa_w)))
						and	a.ie_tipo_conta	= 'R'
						and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
						
						select	max(cd_classificacao_atual)
						into STRICT	cd_classificacao_debito_w
						from	conta_contabil
						where	cd_conta_contabil	= cd_conta_contabil_w;
						
						cd_conta_debito_w	:= cd_conta_contabil_w;
					elsif (ie_codificacao_w = 'FX') then /* Fixo */
						cd_classificacao_item_w	:= vl_fixo_w;
					elsif (ie_codificacao_w = 'GA') then /* Grupo ANS */
						cd_classificacao_item_w	:= ie_classif_grupo_w;					
					elsif (ie_codificacao_w = 'FP') then /* Formacao de Preco */
						if	((ie_tipo_segurado_w = 'A') or (ie_tipo_movimentacao_w = '3')) then
							cd_classificacao_item_w	:= '9';
						else
							cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_formacao_preco(ie_preco_w);
						end if;
					elsif (ie_codificacao_w = 'R') then /* Regulamentacao */
						cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_regulamentacao(ie_regulamentacao_w);
					elsif (ie_codificacao_w = 'TC') then /* Tipo de contratacao */
						cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_tipo_contratacao(ie_tipo_contratacao_w);
					elsif (ie_codificacao_w = 'S') then /* Segmentacao */
						cd_classificacao_item_w	:= lpad(ie_segmentacao_w,2,'0');
					elsif (ie_codificacao_w = 'TP') then /* Tipo de Contrato (Pessoa fisica ou Juridica) */
						cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_tipo_pessoa_contrato(ie_tipo_contrato_w);
					elsif (ie_codificacao_w = 'TR') then /* Tipo de relacao com a OPS */
						cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_tipo_relacao(ie_tipo_relacao_w);
					elsif (ie_codificacao_w = 'TA') then /* Tipo de ato cooperado */
						cd_classificacao_item_w := pls_atualizar_codificacao_pck.get_ato_cooperado(ie_ato_cooperado_w);
					elsif (ie_codificacao_w = 'CG') then
						cd_classificacao_item_w	:= ie_classif_grupo_ww;
					elsif (ie_codificacao_w = 'RC') then /* Tipo de contratacao / Regulamentacao */
						cd_classificacao_item_w	:= pls_atualizar_codificacao_pck.get_contratacao_regulamentacao(ie_tipo_contratacao_w,ie_regulamentacao_w);
					end if;
					
					if (cd_classificacao_item_w IS NOT NULL AND cd_classificacao_item_w::text <> '') then
						if (ds_mascara_w = '00') then
							cd_classificacao_item_w	:= lpad(cd_classificacao_item_w,2,'0') || '.';
						elsif (ds_mascara_w = '0.0') then
							cd_classificacao_item_w	:= substr(lpad(cd_classificacao_item_w,2,'0'),1,1) ||'.'||substr(lpad(cd_classificacao_item_w,2,'0'),2,1) || '.';
						elsif (ds_mascara_w = '0_') then
							cd_classificacao_item_w	:= cd_classificacao_item_w;
						else
							cd_classificacao_item_w	:= cd_classificacao_item_w || '.';
						end if;
						
						cd_classificacao_debito_w	:= cd_classificacao_debito_w || cd_classificacao_item_w;
					end if;
				end if;
				end;
			end loop;
			close c_segmentacao;
			
			/* Remover o ultimo ponto da classificacao */

			if (substr(cd_classificacao_credito_w,length(cd_classificacao_credito_w),length(cd_classificacao_credito_w)) = '.') then
				cd_classificacao_credito_w	:= substr(cd_classificacao_credito_w,1,length(cd_classificacao_credito_w)-1);
			end if;
			
			if (substr(cd_classificacao_debito_w,length(cd_classificacao_debito_w),length(cd_classificacao_debito_w)) = '.') then
				cd_classificacao_debito_w	:= substr(cd_classificacao_debito_w,1,length(cd_classificacao_debito_w)-1);
			end if;
			
			if (coalesce(cd_conta_credito_w::text, '') = '') then
				select	max(a.cd_conta_contabil)
				into STRICT	cd_conta_credito_w
				from	conta_contabil a
				where	a.cd_classificacao_atual	= cd_classificacao_credito_w
				and	a.cd_empresa			= cd_empresa_w
				and	a.ie_tipo			= 'A'
				and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
			end if;
			
			if (coalesce(cd_conta_debito_w::text, '') = '') then
				select	max(a.cd_conta_contabil)
				into STRICT	cd_conta_debito_w
				from	conta_contabil a
				where	a.cd_classificacao_atual	= cd_classificacao_debito_w
				and	a.cd_empresa			= cd_empresa_w
				and	a.ie_tipo			= 'A'
				and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
			end if;
			
			begin
			select	cd_cgc,
				cd_pessoa_fisica
			into STRICT	cd_cgc_pagador_w,
				cd_pf_pagador_w
			from	pls_contrato_pagador
			where	nr_sequencia = nr_seq_pagador_w;
			exception
			when others then
				cd_cgc_pagador_w := '0';
				cd_pf_pagador_w := '0';
			end;
			
			if (coalesce(cd_cgc_pagador_w,'0') <> '0') then
				select	max(cd_municipio_ibge)
				into STRICT	cd_municipio_ibge_w
				from	pessoa_juridica
				where	cd_cgc = cd_cgc_pagador_w;
			elsif (coalesce(cd_pf_pagador_w,'0') <> '0') then
				select	max(cd_municipio_ibge)
				into STRICT	cd_municipio_ibge_w
				from	compl_pessoa_fisica
				where	ie_tipo_complemento = 1
				and	cd_pessoa_fisica = cd_pf_pagador_w;
			end if;
			
			cd_centro_custo_w	:= null;
			
			SELECT * FROM pls_obter_centro_custo(	'R', nr_seq_plano_w, cd_estabelecimento_p, cd_municipio_ibge_w, ie_tipo_contratacao_w, ie_regulamentacao_w, nr_seq_segurado_w, ie_tipo_item_w, cd_centro_custo_w, nr_seq_regra_cc_w, nr_seq_tipo_lanc_w, null, nr_seq_sca_w) INTO STRICT cd_centro_custo_w, nr_seq_regra_cc_w;
	
			if (nr_seq_atualizacao_p IS NOT NULL AND nr_seq_atualizacao_p::text <> '') then
				if (coalesce(nr_seq_esquema_w::text, '') = '') then
					CALL pls_gravar_mov_contabil(nr_seq_atualizacao_p,
								1,
								nr_seq_item_w,
								null,
								null,
								null,
								null,
								nr_seq_conta_pos_estab_w,
								null,
								null,
								null,
								null,
								null,
								null,
								null,
								null,
								null,
								nm_usuario_p,
								nr_seq_esquema_w,
								null,
								null,
								null,
								ie_tipo_lote_w);
				elsif	((coalesce(cd_conta_credito_w::text, '') = '') or (coalesce(cd_conta_debito_w::text, '') = '')) then
					CALL pls_gravar_mov_contabil(nr_seq_atualizacao_p,
								2,
								nr_seq_item_w,
								null,
								null,
								null,
								null,
								nr_seq_conta_pos_estab_w,
								null,
								null,
								null,
								null,
								null,
								null,
								null,
								null,
								null,
								nm_usuario_p,
								nr_seq_esquema_w,
								null,
								null,
								null,
								ie_tipo_lote_w);
				end if;
			end if;
			
			if (ie_tipo_lote_w = 1) then
			
				update	pls_conta_pos_estabelecido
				set	cd_conta_deb		= cd_conta_debito_w,
					cd_historico		= cd_historico_padrao_w,
					cd_centro_custo		= cd_centro_custo_w,
					--nr_seq_grupo_ans	= nr_seq_grupo_ans_w,
					--cd_historico_baixa	= cd_historico_baixa_w,
					cd_classif_deb		= cd_classificacao_debito_w,
					nr_seq_esquema		= nr_seq_esquema_w,
					nr_seq_rec_futura	= nr_seq_rec_futura_w,
					dt_atualizacao		= clock_timestamp(),
					nm_usuario		= nm_usuario_p
				where	rowid			= nr_id_pos_estab_w;
			
				qt_movimento_w	:= qt_movimento_w + 1;
				
			elsif (ie_tipo_lote_w = 2) then
			
				update	pls_conta_pos_estabelecido
				set	cd_conta_cred		= cd_conta_credito_w,
					cd_classif_cred		= cd_classificacao_credito_w--,
					--cd_historico_rec	= cd_historico_padrao_w,
					--nr_seq_esquema_rec	= nr_seq_esquema_w
				where	rowid			= nr_id_pos_estab_w;
			
				qt_movimento_w	:= qt_movimento_w + 1;
			else
				update	pls_conta_pos_estabelecido
				set	cd_conta_cred		= cd_conta_credito_w,
					cd_conta_deb		= cd_conta_debito_w,
					cd_historico		= cd_historico_padrao_w,
					cd_centro_custo		= cd_centro_custo_w,
					--nr_seq_grupo_ans	= nr_seq_grupo_ans_w,
					--cd_historico_baixa	= cd_historico_baixa_w,
					cd_classif_cred		= cd_classificacao_credito_w,
					cd_classif_deb		= cd_classificacao_debito_w,
					nr_seq_esquema		= nr_seq_esquema_w,
					nr_seq_rec_futura	= nr_seq_rec_futura_w,
					dt_atualizacao		= clock_timestamp(),
					nm_usuario		= nm_usuario_p
				where	rowid			= nr_id_pos_estab_w;
			
				qt_movimento_w	:= qt_movimento_w + 1;
			end if;
			
			if (mod(qt_movimento_w,1000) = 0) then
				commit;
			end if;
			
			end;
		end loop;
		close c_pos_estabelecido;
		
		if (ie_tipo_lote_w <> 2) then
			update	pls_mensalidade_seg_item
			set	cd_conta_contabil_ppcng		= cd_conta_contabil_ppcng_w,
				cd_historico_ppcng		= cd_historico_ppcng_w,
				nr_seq_esquema_ppcng		= nr_seq_esquema_ppcng_w,
				cd_classif_conta_ppcng		= cd_classificacao_ppcng_w,
				cd_conta_devolucao		= cd_conta_devolucao_w,
				cd_historico_devolucao		= cd_historico_devolucao_w
			where	rowid				= nr_id_item_w;
		end if;
	end if;
	end;
end loop;
close c_itens_mensalidade;

qt_movimento_p	:= qt_movimento_w;

--commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_pls_atualizar_receita_in ( nr_seq_lote_p bigint, nr_seq_mensalidade_p bigint, nr_seq_item_p bigint, nr_seq_atualizacao_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nr_seq_mens_seg_p bigint default null, ie_tipo_movimento_p text default null, qt_movimento_p INOUT bigint DEFAULT NULL) FROM PUBLIC;

