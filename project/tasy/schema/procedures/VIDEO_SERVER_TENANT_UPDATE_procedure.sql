-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE video_server_tenant_update ( nm_usuario_p text, nr_sequencia_p bigint, ie_option_p text default 'NA', ie_option_default_p text default 'NA') AS $body$
DECLARE

										
nr_sequencia_w				video_server_tenant.nr_sequencia%type;
cd_password_w				video_server_tenant.CD_PASSWORD%type;
cd_password_encrypt_w		varchar(255);

/*
NA = Nenhuma das opcoes

ie_option_default_p
S  = Muda o padrao

ie_option_p 
P = update no Password

*/
C01 CURSOR FOR
	SELECT	nr_sequencia
	from	video_server_tenant
	where	ie_default = 'S'
	and     nr_sequencia <> nr_sequencia_p
	order by 1;


BEGIN
if (ie_option_default_p = 'S') then
	open C01;
	loop
	fetch C01 into	
		nr_sequencia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
			update	video_server_tenant
			set		ie_default 			= 'N',
					nm_usuario			= NM_USUARIO_P,
					dt_atualizacao		= clock_timestamp()
			where	nr_sequencia		= nr_sequencia_w;
		
		commit;
		end;

	end loop;
	close C01;
end if;

if (ie_option_p = 'P') then

	select cd_password
	into STRICT cd_password_w
	from video_server_tenant 
	where nr_sequencia = nr_sequencia_p;

	select wheb_seguranca.encrypt(cd_password_w)
	into STRICT cd_password_encrypt_w
	;

	update	video_server_tenant
	set		cd_password = cd_password_encrypt_w
	where	nr_sequencia		= nr_sequencia_p;

end if;	

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE video_server_tenant_update ( nm_usuario_p text, nr_sequencia_p bigint, ie_option_p text default 'NA', ie_option_default_p text default 'NA') FROM PUBLIC;

