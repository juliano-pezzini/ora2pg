-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_solic_compra_item ( nr_solic_compra_p bigint, nr_item_solic_compra_p bigint, ie_consistir_estoque_p text, ie_deleta_consist_p text, ie_consiste_regra_aprov_p text, ie_consiste_mat_ccusto_p text, nm_usuario_p text, ie_plataforma_p text default 'J') AS $body$
DECLARE


/*ie_deleta_consist_p
	S = Limpa as consistencias da solicitacao - Utilizado no momento de salvar o item no sistema
	N = Nao limpa as consistencias da solicitacao - Utilizado no momento de chamada pela procedure solic*/
nr_solic_compra_w		bigint;
nr_item_solic_compra_w		bigint;
cd_local_estoque_w		bigint;
cd_material_w			bigint;
nr_seq_marca_w			bigint;
cd_estabelecimento_w		bigint;
ie_local_w			varchar(2000);
ie_tipo_local_w			varchar(5);
qt_estoque_w			double precision;
ie_situacao_w			varchar(1);
ie_material_estoque_w		varchar(1);
ie_aviso_chegada_w		varchar(1);
ie_aviso_aprov_oc_w		varchar(1);
ie_urgente_w			varchar(1);
ie_aviso_chegada_ww		varchar(1);
ie_aviso_aprov_oc_ww		varchar(1);
ie_urgente_ww			varchar(1);
ie_permite_liberar_w		varchar(1);
cd_material_ww			integer;
qt_regra_w			integer;
qt_validade_vencida_w		integer;
ie_consiste_validade_anvisa_w	varchar(1);
ie_consiste_valid_marca_mat_w	varchar(1);
dt_validade_anvisa_marca_w	timestamp;
qt_registro_w			bigint;
ds_local_estoque_w		varchar(40);
ie_deleta_consist_w		varchar(1);
ie_consiste_grupo_compras_w	varchar(1);
cd_centro_custo_w		integer;
ie_permite_w			varchar(1);
ie_consiste_estoque_w		varchar(1);
ie_obriga_parecer_w		varchar(1);
ie_desdobra_grupo_compra_w	varchar(1);
qt_itens_pendentes_w		bigint;
ie_consistir_itens_w		varchar(15);
ie_tipo_servico_w		varchar(15);
ie_mat_est_centro_custo_w	varchar(1);
ie_consiste_vl_proj_rec_w	varchar(1);
nr_seq_proj_rec_w		bigint;
vl_unit_previsto_w		solic_compra_item.vl_unit_previsto%type;
ie_consiste_fornec_consig_w	varchar(1);
cd_fornec_sugerido_w		varchar(14);
ie_consignado_w			varchar(15);
ie_consiste_local_direto_w	varchar(1);
ie_marca_reprovada_w		varchar(1);
qt_consist_disp_merc_w		bigint;
ie_verifica_mat_indisp_w	varchar(1);
ie_mat_disp_mercado_w		varchar(1);
ds_mensagem_disp_merc_w		varchar(255);
qt_existe_regra_lib_w		bigint;
ie_exige_marca_w		varchar(1);
ie_exige_fabricante_w		varchar(1);
ie_exige_detalhe_tec_w		varchar(1);
qt_existe_exigencia_regra_w	bigint;
qt_min_solic_mat_w		bigint;
qt_multiplo_solic_mat_w		bigint;
qt_material_w			double precision;
ie_servico_realizado_w		varchar(15);
cd_perfil_w			bigint;
ie_tipo_status_marca_w		varchar(1);
ie_mat_estoque_local_direto_w	varchar(1);
qt_reg_rateio_w			integer;
vl_rateio_w			double precision;
qt_rateio_w			double precision;
qt_material_ww			double precision;
ds_material_w			varchar(255);
ie_consiste_dif_valor_rateio_w	varchar(1);
ie_consiste_dif_qt_rateio_w	varchar(1);
ie_exige_anvisa_est_w		varchar(1);
cd_material_estoque_w		integer;
nr_registro_anvisa_w		varchar(60);
dt_validade_reg_anvisa_w	timestamp;
ie_exige_anvisa_est_control_w	varchar(1);
cd_material_controlado_w	integer;
ie_consiste_regra_mat_w		varchar(1);
ie_consiste_permissao_compra_w	varchar(15);
ie_consiste_permissao_mat_w	varchar(1);
cd_classe_material_w		bigint;
vl_saldo_contr_item_w		double precision;
vl_saldo_contr_item_ww		double precision;
ds_consistencia_p		varchar(255);
ds_observacao_p			varchar(255);
ie_gerar_solic_comp_item_w	funcao_param_usuario.vl_parametro%type;
nr_contrato_w			solic_compra_item.nr_contrato%type;
vl_total_item_w			solic_compra_item.vl_unit_previsto%type;
ie_vigente_anvisa_w		material_estab.ie_vigente_anvisa%type;
nr_seq_forma_solic_compra_w	solic_compra.nr_seq_forma_compra%type;
nr_seq_regra_w			regra_consist_pend_compra.nr_sequencia%type;
ie_consiste_solic_pend_regra_w  regra_consist_pend_compra.ie_consiste_solic_pend%type;
ie_consiste_cot_pend_regra_w  	regra_consist_pend_compra.ie_consiste_cot_pend%type;
ie_consiste_oc_pend_regra_w  	regra_consist_pend_compra.ie_consiste_oc_pend%type;
ie_consiste_lic_pend_regra_w 	regra_consist_pend_compra.ie_consiste_lic_pend%type;
ie_acao_liberar_regra_w  	regra_consist_pend_compra.ie_acao_liberar%type;
ie_exige_aval_dinamica_w	sup_regra_consist_lib_sc.ie_exige_aval_dinamica%type;
qt_cot_pendente_w		bigint;
qt_oc_pendente_w		bigint;
qt_solic_pendente_w		bigint;
qt_licitacao_pendente_w		bigint;
ie_vigente_anvisa_marca_w	material_marca.ie_vigente_anvisa%type;
vl_max_purchase_w	rule_regulated_price.vl_max_purchase%type;
is_regulated_price_w	varchar(1);

c01 CURSOR FOR
SELECT	b.nr_item_solic_compra,
	a.cd_local_estoque,
	substr(obter_desc_local_estoque(a.cd_local_estoque),1,40),
	b.cd_material,
	b.nr_seq_marca,
	a.ie_tipo_servico,
	b.nr_seq_proj_rec,
	coalesce(b.vl_unit_previsto,0) vl_unit_previsto,
	qt_material,
	ie_servico_realizado,
	substr(obter_desc_material(b.cd_material),1,255),
	e.cd_classe_material,
	b.nr_contrato
from	estrutura_material_v e,
	solic_compra_item b,
	solic_compra a
where	a.nr_solic_compra	= b.nr_solic_compra
and	b.cd_material 	= e.cd_material
and	a.nr_solic_compra	= nr_solic_compra_p
and	b.nr_item_solic_compra  = coalesce(nr_item_solic_compra_p, b.nr_item_solic_compra);

c02 CURSOR FOR
SELECT	cd_material
from	solic_compra_item
where	nr_solic_compra = nr_solic_compra_p;

c03 CURSOR FOR
SELECT	a.cd_material
from	material a,
	material_estab b
where	a.cd_material = b.cd_material
and	b.cd_estabelecimento = cd_estabelecimento_w
and	a.cd_material_estoque = cd_material_estoque_w
and	a.cd_material <> cd_material_estoque_w
and	a.ie_situacao = 'A';

BEGIN

select	cd_estabelecimento,
	cd_centro_custo,
	cd_fornec_sugerido
into STRICT	cd_estabelecimento_w,
	cd_centro_custo_w,
	cd_fornec_sugerido_w
from	solic_compra
where	nr_solic_compra = nr_solic_compra_p;

select	coalesce(max(ie_consiste_validade_anvisa), 'N'),
	coalesce(max(ie_consiste_validade_marca_mat),'N')
into STRICT	ie_consiste_validade_anvisa_w,
	ie_consiste_valid_marca_mat_w
from	parametro_compras
where	cd_estabelecimento = cd_estabelecimento_w;

select	count(*)
into STRICT	qt_existe_regra_lib_w
from	sup_regra_consist_lib_sc
where	ie_situacao = 'A'
and	cd_estabelecimento = cd_estabelecimento_w;

cd_perfil_w	:= obter_perfil_ativo;

select	coalesce(max(obter_valor_param_usuario(913, 16, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w)), 'N'),
	substr(coalesce(obter_valor_param_usuario(913, 48, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w),'N'),1,1),	
	substr(coalesce(obter_valor_param_usuario(913, 101, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w),'N'),1,1),
	substr(coalesce(obter_valor_param_usuario(913, 1, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w),'N'),1,1),
	substr(coalesce(obter_valor_param_usuario(913, 175, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w),'N'),1,1),
	substr(coalesce(obter_valor_param_usuario(913, 176, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w),'N'),1,1),
	substr(coalesce(obter_valor_param_usuario(913, 181, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w),'N'),1,1),
	substr(coalesce(obter_valor_param_usuario(913, 234, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w),'N'),1,1),
	substr(coalesce(obter_valor_param_usuario(913, 237, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w),'N'),1,1),
	substr(coalesce(obter_valor_param_usuario(913, 250, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w),'N'),1,1),
	substr(coalesce(obter_valor_param_usuario(913, 251, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w),'N'),1,1),
	substr(coalesce(obter_valor_param_usuario(913, 257, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w),'N'),1,1),
	substr(coalesce(obter_valor_param_usuario(913, 258, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w),'N'),1,1),
	substr(coalesce(obter_valor_param_usuario(913, 264, cd_perfil_w, nm_usuario_p, cd_estabelecimento_w),'N'),1,1)
into STRICT	ie_consistir_itens_w,
	ie_consiste_grupo_compras_w,
	ie_desdobra_grupo_compra_w,
	ie_mat_est_centro_custo_w,
	ie_consiste_vl_proj_rec_w,
	ie_consiste_fornec_consig_w,
	ie_consiste_local_direto_w,
	ie_marca_reprovada_w,
	ie_mat_estoque_local_direto_w,
	ie_consiste_dif_valor_rateio_w,
	ie_consiste_dif_qt_rateio_w,
	ie_consiste_regra_mat_w,
	ie_consiste_permissao_compra_w,
	ie_gerar_solic_comp_item_w
;

select	count(*)
into STRICT	qt_consist_disp_merc_w
from	consiste_disp_mercado
where	cd_evento = 'SL';

delete
from	solic_compra_consist
where	nr_solic_compra = nr_solic_compra_p
and	ie_tipo_consistencia = '1';

/*Identifica se deve limpar as consistencias da solicitacao*/

ie_deleta_consist_w	:= coalesce(ie_deleta_consist_p, 'N');
if (ie_deleta_consist_w = 'S') then
	delete
	from	solic_compra_consist
	where	nr_solic_compra = nr_solic_compra_p
	and	ie_tipo_consistencia = '0';
end if;

open 	c01;
loop	
fetch c01 into
	nr_item_solic_compra_w,
	cd_local_estoque_w,
	ds_local_estoque_w,
	cd_material_w,
	nr_seq_marca_w,
	ie_tipo_servico_w,
	nr_seq_proj_rec_w,
	vl_unit_previsto_w,
	qt_material_w,
	ie_servico_realizado_w,
	ds_material_w,
	cd_classe_material_w,
	nr_contrato_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
	if (coalesce(ie_gerar_solic_comp_item_w,'N') = 'S') and (nr_contrato_w > 0) and (ie_tipo_servico_w = 'SP') then

		select	obter_saldo_contr_item_solic(nr_solic_compra_p,nr_item_solic_compra_w)
		into STRICT	vl_saldo_contr_item_w
		;
		
		
		select	qt_material * coalesce(vl_unit_previsto,0)
		into STRICT	vl_total_item_w
		from	solic_compra_item
		where	nr_solic_compra 		= nr_solic_compra_p
		and	nr_item_solic_compra		= nr_item_solic_compra_w;
	
		/*if	(nvl(vl_total_item_w,0) > nvl(vl_saldo_contr_item_w,0)) then
			gravar_solic_compra_consist(nr_Solic_compra_p,'1','O valor do material ' || cd_material_w || ' e maior que o saldo permitido para adiantamento',
			'C',' O valor do material ' || cd_material_w || ' nao pode ser maior que o saldo disponivel para adiantamento desse
			material que e de ' || vl_saldo_contr_item_w || '.', nm_usuario_p);
		end if;
		*/
		
		vl_saldo_contr_item_ww	:= vl_saldo_contr_item_w;
		if (vl_saldo_contr_item_w < 0) then
			vl_saldo_contr_item_ww := 0;
		end if;
		ds_consistencia_p	:= WHEB_MENSAGEM_PCK.get_texto(284407,'cd_material_p='|| cd_material_w);
											
		ds_observacao_p		:=  WHEB_MENSAGEM_PCK.get_texto(284408,'cd_material_p='	|| cd_material_w || ';vl_saldo_contr_item_p='|| campo_mascara_virgula_casas(vl_saldo_contr_item_ww,4));
		
		if (coalesce(vl_total_item_w,0) > coalesce(vl_saldo_contr_item_w,0)) then
			CALL gravar_solic_compra_consist(nr_Solic_compra_p,'1', ds_consistencia_p,'C', ds_observacao_p, nm_usuario_p);
		end if;
	end if;
	
	select	obter_qdade_regra_solic(cd_material_w,cd_local_estoque_w,'913')
	into STRICT	qt_min_solic_mat_w
	;

	if (qt_min_solic_mat_w > 0) and (qt_material_w < qt_min_solic_mat_w) then
		CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '1',
				WHEB_MENSAGEM_PCK.get_texto(298932,'CD_MATERIAL_W='||CD_MATERIAL_W||';QT_MIN_SOLIC_MAT_W='||QT_MIN_SOLIC_MAT_W), /*'A quantidade minima para a solicitacao do material ' || cd_material_w || ' e ' || qt_min_solic_mat_w,*/
				'C',
				WHEB_MENSAGEM_PCK.get_texto(298934,'CD_MATERIAL_W='||CD_MATERIAL_W||';QT_MIN_SOLIC_MAT_W='||QT_MIN_SOLIC_MAT_W), /*'A quantidade minima para a solicitacao do material ' || cd_material_w || ' e ' || qt_min_solic_mat_w || '. Verifique o cadastro de Regras de solicitacao minima do material.',*/
				nm_usuario_p);
	end if;
	
	select	obter_qdade_regra_solic(cd_material_w,cd_local_estoque_w,'913x')
	into STRICT	qt_multiplo_solic_mat_w
	;

	if (qt_multiplo_solic_mat_w > 0) and (mod(qt_material_w , qt_multiplo_solic_mat_w) <> 0) then
		CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '1',
				WHEB_MENSAGEM_PCK.get_texto(298936,'CD_MATERIAL_W='||CD_MATERIAL_W||';QT_MULTIPLO_SOLIC_MAT_W='||QT_MULTIPLO_SOLIC_MAT_W),/*'A quantidade informada para o material ' || cd_material_w || ' nao e multiplo de ' || qt_multiplo_solic_mat_w,*/
				'C',
				WHEB_MENSAGEM_PCK.get_texto(298937,'CD_MATERIAL_W='||CD_MATERIAL_W||';QT_MULTIPLO_SOLIC_MAT_W='||QT_MULTIPLO_SOLIC_MAT_W), /*'A quantidade informada para o material ' || cd_material_w || ' deve ser multiplo de  ' || qt_multiplo_solic_mat_w || '. Verifique o cadastro de Regras de solicitacao minima do material.',*/
				nm_usuario_p);
	end if;
	
	if (ie_consiste_regra_mat_w = 'S') then
	
		select	coalesce(obter_regra_material_usuario(cd_classe_material_w, cd_material_w, nm_usuario_p, '4'),'S')
		into STRICT	ie_consiste_permissao_mat_w
		;
		
		if (ie_consiste_permissao_mat_w = 'N') then
			CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '1',
				Wheb_mensagem_pck.get_Texto(298938, 'CD_MATERIAL_W='||CD_MATERIAL_W),/*'Sem permissao para solicitar o material ' || cd_material_w || '.',*/
				'C',
				Wheb_mensagem_pck.get_Texto(298939), /*'Conforme o parametro [257] e a Regra de cadastro de materiais por usuario, nao e permitido solicitar esse material.',*/
				nm_usuario_p);		
		end if;
	end if;

	
	if (ie_consiste_permissao_compra_w = 'S') then
	
		select	coalesce(obter_permissao_compra_mat(cd_estabelecimento_w, cd_material_w, 'S'),'S')
		into STRICT	ie_consiste_permissao_mat_w
		;
		
		if (ie_consiste_permissao_mat_w = 'N') then
			CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '1',
				Wheb_mensagem_pck.get_Texto(298940, 'CD_MATERIAL_W='||CD_MATERIAL_W), /*'Sem permissao para solicitar o material ' || cd_material_w || '.',*/
				'C',
				Wheb_mensagem_pck.get_Texto(298941), /*'Conforme o parametro [258] e a regra Permissao de compras do material, nao e permitido solicitar esse material.',*/
				nm_usuario_p);
		end if;
	end if;


	if (ie_consiste_fornec_consig_w = 'S') then
		
		select	ie_consignado
		into STRICT	ie_consignado_w
		from	material
		where	cd_material = cd_material_w;
		
		if (ie_consignado_w = '1') and (coalesce(cd_fornec_sugerido_w::text, '') = '') then
			
			CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '1',
				Wheb_mensagem_pck.get_Texto(298942, 'CD_MATERIAL_W='||CD_MATERIAL_W), /*'O material ' || cd_material_w || ' e consigando, portanto deve ser informado um fornecedor',*/
				'C',
				Wheb_mensagem_pck.get_Texto(298944), /*'Quando ha materiais consignados na solicitacao, o sistema exige um fornecedor. Esse fornecedor e necessario para gerar a ordem de compra ' ||  ' no momento da aprovacao. Utilize a opcao Inserir/Alterar fornecedor para informar o fornecedor.',*/
				nm_usuario_p);
		end if;	
	end if;	
	
	/*Consiste local do servico*/

	if (coalesce(ie_servico_realizado_w::text, '') = '') and (obter_se_exige_local_serv_sc(cd_estabelecimento_w, cd_material_w) = 'S') then
		CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '1',
				Wheb_mensagem_pck.get_Texto(298947, 'CD_MATERIAL_W='||CD_MATERIAL_W), /*'O material ' || cd_material_w || ' exige que seja informado o Local do servico.',*/
				'C',
				Wheb_mensagem_pck.get_Texto(298948), /*'Deve ser informado o local onde o servico sera realizado (Dentro ou fora do estabelecimento).',*/
				nm_usuario_p);
	
	end if;
		
	select	count(*)
	into STRICT	qt_registro_w
	from	solic_compra_item b,
		solic_compra a
	where	a.nr_solic_compra = b.nr_solic_compra
	and	a.nr_solic_compra = nr_solic_compra_p
	and	substr(obter_se_material_estoque(a.cd_estabelecimento,a.cd_estabelecimento,b.cd_material),1,1) = 'S'
	and	ie_mat_est_centro_custo_w = 'N'
	and	(cd_centro_custo IS NOT NULL AND cd_centro_custo::text <> '')
	and	b.cd_material = cd_material_w;

	if (qt_registro_w > 0) then
		CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '1',
				Wheb_mensagem_pck.get_Texto(298950, 'CD_MATERIAL_W='||CD_MATERIAL_W), /*'O material ' || cd_material_w || ' e um material de estoque, e a solicitacao e para centro de custo',*/
				'C',
				Wheb_mensagem_pck.get_Texto(298910), /*'Verifique o parametro [1] da funcao.',*/
				nm_usuario_p);
		
	end if;
	
	
	/*Verifica se existe processo de aprovacao e se existir verifica se tem cargo ou cargo no centro de custo*/

	if (ie_consiste_regra_aprov_p <> 'N') then
		CALL consiste_regra_aprov_solic(
				nr_solic_compra_p,
				nr_item_solic_compra_w,
				cd_material_w,
				nm_usuario_p);
	end if;

	/*Verifica dados na material_estab*/

	select	count(*)
	into STRICT	qt_registro_w
	from	material_estab
	where	cd_material		= cd_material_w
	and	cd_estabelecimento 	= cd_estabelecimento_w;
	if (qt_registro_w = 0) then
		CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '1',
				Wheb_mensagem_pck.get_Texto(298953, 'CD_MATERIAL_W='||CD_MATERIAL_W), /*'O material ' || cd_material_w || ' nao possui dados no cadastro para o estabelecimento',*/
				'C', null, nm_usuario_p);
	end if;
	
	/* consiste padrao local*/

	if (cd_local_estoque_w IS NOT NULL AND cd_local_estoque_w::text <> '') and (coalesce(ie_tipo_servico_w::text, '') = '') and
		((ie_consiste_local_direto_w = 'S') or
		((ie_consiste_local_direto_w = 'N') and (obter_se_local_direto(cd_local_estoque_w) = 'N'))) then
		
		ie_local_w  := OBTER_LOCAL_VALIDO(
			cd_estabelecimento_w, cd_local_estoque_w, cd_material_w, 2, ie_local_w );
			
		if (ie_local_w <> 'S') then
			CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '1',
				Wheb_mensagem_pck.get_Texto(298954, 'CD_MATERIAL_W='||CD_MATERIAL_W), /*'O material ' || cd_material_w || ' nao esta liberado para o estoque',*/
				'C',
				WHEB_MENSAGEM_PCK.get_texto(298955,'CD_LOCAL_ESTOQUE_W='||CD_LOCAL_ESTOQUE_W||';DS_LOCAL_ESTOQUE_W='||DS_LOCAL_ESTOQUE_W), /*'Local = ' || cd_local_estoque_w || ' - ' || ds_local_estoque_w || chr(13) || 'Verifique Padroes/Liberacao na administracao de estoques.',*/
				nm_usuario_p);
		end if;
	end if;

	/* consiste se possue estoque*/

	if (coalesce(ie_tipo_servico_w::text, '') = '') and (coalesce(ie_consistir_estoque_p,'N') = 'N') or (coalesce(ie_consistir_estoque_p,'N') = 'M') then
		begin
		
		select	CASE WHEN ie_consistir_estoque_p='N' THEN 'C' WHEN ie_consistir_estoque_p='M' THEN 'M' END
		into STRICT	ie_consiste_estoque_w
		;
		
		select	obter_saldo_disp_estoque(cd_estabelecimento_w, cd_material_w, cd_local_estoque_w, null)
		into STRICT 	qt_estoque_w
		;
		if (qt_estoque_w > 0) then
			CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '1',
				Wheb_mensagem_pck.get_Texto(298962, 'CD_MATERIAL_W='||CD_MATERIAL_W), /*'O material ' || cd_material_w || ' possui estoque para este local',*/
				ie_consiste_estoque_w,
				WHEB_MENSAGEM_PCK.get_texto(298964,'CD_LOCAL_ESTOQUE_W='||CD_LOCAL_ESTOQUE_W||';DS_LOCAL_ESTOQUE_W='||DS_LOCAL_ESTOQUE_W||';QT_ESTOQUE_W='||QT_ESTOQUE_W), /*'Local = ' || cd_local_estoque_w || ' - ' || ds_local_estoque_w || chr(13) ||	'Quantidade = ' || qt_estoque_w,*/
				nm_usuario_p);
		end if;
		end;
	end if;
	
	/* consiste se inativos*/

	select	ie_situacao
	into STRICT	ie_situacao_w
	from	material
	where	cd_material = cd_material_w;
	if (ie_situacao_w = 'I') then
		CALL gravar_solic_compra_consist(
			nr_solic_compra_p, '1',
			Wheb_mensagem_pck.get_Texto(298966, 'CD_MATERIAL_W='||CD_MATERIAL_W), /*'O material ' || cd_material_w || ' esta inativo',*/
			'C', null, nm_usuario_p);
	end if;
	
	/* Consiste se validade do registro da anvisa vencida*/

	if (ie_consiste_validade_anvisa_w = 'S') then
		select	count(*)
		into STRICT	qt_validade_vencida_w
		from	material_estab
		where	cd_material = cd_material_w
		and	cd_estabelecimento = cd_estabelecimento_w
		and	(dt_validade_reg_anvisa IS NOT NULL AND dt_validade_reg_anvisa::text <> '')
		and	dt_validade_reg_anvisa < clock_timestamp();
		if (qt_validade_vencida_w > 0) then
			CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '1',
				Wheb_mensagem_pck.get_Texto(298968, 'CD_MATERIAL_W='||CD_MATERIAL_W), /*'O material ' || cd_material_w || ' esta com a validade do registro Anvisa vencido',*/
				'C',
				Wheb_mensagem_pck.get_Texto(298969), /*'Esta informacao esta identificada no proprio cadastro de materiais(Validade Anvisa).',*/
				nm_usuario_p);
		end if;
	end if;
	
	/*Consiste a data de validade da marca do material*/
	
	if (ie_consiste_valid_marca_mat_w = 'S') then

		select	max(dt_validade_reg_anvisa),
				max(ie_vigente_anvisa)
		into STRICT	dt_validade_anvisa_marca_w,
				ie_vigente_anvisa_marca_w
		from	material_marca
		where	cd_material = cd_material_w
		and	nr_sequencia = nr_seq_marca_w;

		if	((coalesce(ie_vigente_anvisa_marca_w,'X') = 'N') or (coalesce(dt_validade_anvisa_marca_w,clock_timestamp()) < trunc(clock_timestamp()))) then
			CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '1',
				substr(WHEB_MENSAGEM_PCK.get_texto(298970,'DS_MARCA_W='||obter_desc_marca(nr_seq_marca_w)||';CD_MATERIAL_W='||CD_MATERIAL_W),1,255), /*substr('A validade da marca ' || obter_desc_marca(nr_seq_marca_w) || ' do material ' || cd_material_w || ' esta vencida. ',1,255),*/
				'C',
				Wheb_mensagem_pck.get_Texto(298971), /*'Esta informacao esta identificada na funcao Cadastro de Materiais, pasta Estoque > subpasta Marcas.',*/
				nm_usuario_p);
		end if;	
	end if;

	/*Consiste se a marca do material esta reprovada*/

	if (ie_marca_reprovada_w = 'S') then

		select	max(obter_tipo_status_aval_marca(nr_seq_status_aval))
		into STRICT	ie_tipo_status_marca_w
		from	material_marca
		where	cd_material = cd_material_w
		and	(nr_seq_status_aval IS NOT NULL AND nr_seq_status_aval::text <> '')
		and	nr_sequencia = nr_seq_marca_w;

		if (ie_tipo_status_marca_w = 'R') then
			CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '1',
				substr(WHEB_MENSAGEM_PCK.get_texto(298979,'DS_MARCA_W='||obter_desc_marca(nr_seq_marca_w)||';CD_MATERIAL_W='||CD_MATERIAL_W),1,255),/*substr('A marca ' || obter_desc_marca(nr_seq_marca_w) || ' do material ' || cd_material_w || ' esta reprovada. ',1,255),*/
				'C',
				Wheb_mensagem_pck.get_Texto(298971),/*'Esta informacao esta identificada na funcao Cadastro de Materiais, pasta Estoque > subpasta Marcas. ',*/
				nm_usuario_p);
		end if;	
	end if;
	
	/* consiste material estoque*/

	if (coalesce(ie_tipo_servico_w::text, '') = '') and (cd_local_estoque_w IS NOT NULL AND cd_local_estoque_w::text <> '') then
		begin
		select	substr(obter_se_material_estoque(cd_estabelecimento_w, 0, cd_material_w),1,1)
		into STRICT	ie_material_estoque_w
		;
		
		select	ie_tipo_local
		into STRICT	ie_tipo_local_w
		from	local_estoque
		where	cd_local_estoque = cd_local_estoque_w;
		
		if (ie_material_estoque_w <> 'S') and (ie_tipo_local_w <> '8') then
			CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '1',
				Wheb_mensagem_pck.get_Texto(298981, 'CD_MATERIAL_W='||CD_MATERIAL_W), /*'O material ' || cd_material_w || ' nao e um material de estoque',*/
				'C',
				Wheb_mensagem_pck.get_Texto(298982), /*'Esta informacao esta identificada no proprio cadastro de materiais(Material estoque).',*/
				nm_usuario_p);
		end if;
		end;
	end if;
	
	/*Consiste se o local e direto e o material e de estoque.*/
	
	if (ie_mat_estoque_local_direto_w = 'N') and (coalesce(ie_tipo_servico_w::text, '') = '') and (cd_local_estoque_w IS NOT NULL AND cd_local_estoque_w::text <> '') then
		begin
		select	substr(obter_se_material_estoque(cd_estabelecimento_w, 0, cd_material_w),1,1)
		into STRICT	ie_material_estoque_w
		;
		
		select	ie_tipo_local
		into STRICT	ie_tipo_local_w
		from	local_estoque
		where	cd_local_estoque = cd_local_estoque_w;
		
		if (ie_material_estoque_w = 'S') and (ie_tipo_local_w = '8') then
			CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '1',
				Wheb_mensagem_pck.get_Texto(298988, 'CD_MATERIAL_W='||CD_MATERIAL_W), /*'O material ' || cd_material_w || ' e um material de estoque e nao pode ser solicitado para local Direto',*/
				'C',
				Wheb_mensagem_pck.get_Texto(298990),/* 'Nao e permitido solicitar um material de estoque numa solicitacao com local de estoque direto. Verifique parametro [237].',*/
				nm_usuario_p);
		end if;
		end;
	end if;

	/* Consiste grupo de compras*/

	if (ie_consiste_grupo_compras_w = 'S') and (ie_desdobra_grupo_compra_w = 'N') and	/*So vai consistir por grupo de compras se nao desdobrar por grupo de compras*/
		(obter_se_permite_grupo_compra(nr_solic_compra_p,cd_material_w) = 'N') then
		CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '1',
				Wheb_mensagem_pck.get_Texto(298991, 'CD_MATERIAL_W='||CD_MATERIAL_W), /*'O material ' || cd_material_w || ' nao pertence ao mesmo grupo de compras dos demais materiais.',*/
				'C',
				Wheb_mensagem_pck.get_Texto(298993), /*'Verificar o parametro [48] da funcao e a Regra de Grupo de compras em Cadastros - Suprimentos - Cadastros Compras.',*/
				nm_usuario_p);
	end if;

	
	select	substr(obter_se_obr_item_solic_parec(nr_solic_compra_p, nr_item_solic_compra_w),1,1)
	into STRICT	ie_obriga_parecer_w
	;
	
	select	count(*)
	into STRICT	qt_regra_w
	from	solic_compra_parecer
	where	nr_solic_compra = nr_solic_compra_p;

	if (coalesce(ie_obriga_parecer_w,'N') = 'S') and (qt_regra_w = 0) then
		CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '1',
				Wheb_mensagem_pck.get_Texto(298994, 'CD_MATERIAL_W='||CD_MATERIAL_W), /*'O material ' || cd_material_w || ' exige informacao do parecer tecnico.',*/
				'C',
				Wheb_mensagem_pck.get_Texto(298995),/*'Verificar a regra de obrigatoriedade do parecer na solicitacao - Suprimentos - Cadastros Compras.',*/
				nm_usuario_p);
	end if;

	/* Consiste itens pendentes*/

	select	count(*)
	into STRICT	qt_itens_pendentes_w
	from	compra_pendente_v
	where	nr_documento <>	nr_solic_compra_p
	and	nr_documento <> 0
	and	cd_material_estoque = cd_material_w
	and	cd_estabelecimento = cd_estabelecimento_w
	and	ie_consistir_itens_w = 'C';

	if (coalesce(ie_tipo_servico_w::text, '') = '') and (qt_itens_pendentes_w > 0) then

		if (ie_plataforma_p = 'H') then
            CALL gravar_solic_compra_consist(
                    nr_solic_compra_p, '1',
                    Wheb_mensagem_pck.get_Texto(1119239, 'CD_MATERIAL_W='||CD_MATERIAL_W),
                    'C', null, nm_usuario_p);
        else
            CALL gravar_solic_compra_consist(
                	nr_solic_compra_p, '1',
                    Wheb_mensagem_pck.get_Texto(298998, 'CD_MATERIAL_W='||CD_MATERIAL_W), /*'O material ' || cd_material_w || ' possui compras pendentes. Consulte (F7)',*/
                    'C', null, nm_usuario_p);
        end if;

	end if;

	if (ie_consiste_vl_proj_rec_w = 'S') and (nr_seq_proj_rec_w > 0) and (obter_se_item_proj_recurso(nr_seq_proj_rec_w, cd_material_w) = 'S') and (vl_unit_previsto_w > coalesce(obter_dados_item_proj_recurso(nr_seq_proj_rec_w, cd_material_w, 'V'),0)) then
		
		CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '1',
				WHEB_MENSAGEM_PCK.get_texto(299000,'CD_MATERIAL_W='||CD_MATERIAL_W||';VL_RECURSO_W='||campo_mascara_virgula(coalesce(obter_dados_item_proj_recurso(nr_seq_proj_rec_w, cd_material_w, 'V'),0))), /*'O valor previsto do material ' || cd_material_w || ' ultrapassou o valor do projeto recurso (' || campo_mascara_virgula(coalesce(obter_dados_item_proj_recurso(nr_seq_proj_rec_w, cd_material_w, 'V'),0)) || ').',*/
				'C', null, nm_usuario_p);
	end if;

	/*Consiste disponibilidade no mercado*/

	if (qt_consist_disp_merc_w > 0) then
		begin

		select	obter_acao_regra_disp_mercado('SL',cd_material_w,null,cd_estabelecimento_w),
			substr(obter_dados_material(cd_material_w, 'MCD'),1,255)
		into STRICT	ie_verifica_mat_indisp_w,
			ie_mat_disp_mercado_w
		;

		if (ie_mat_disp_mercado_w = 'E') then
			ds_mensagem_disp_merc_w	:= Wheb_mensagem_pck.get_Texto(299002, 'CD_MATERIAL_W='||CD_MATERIAL_W); /*'O material ' || cd_material_w || ' esta disponivel somente enquanto houver estoque.';*/
		else
			ds_mensagem_disp_merc_w	:= Wheb_mensagem_pck.get_Texto(299003, 'CD_MATERIAL_W='||CD_MATERIAL_W); /*'O material ' || cd_material_w || ' nao esta disponivel no mercado.';*/
		end if;

	
		if (ie_verifica_mat_indisp_w = 'C') then
			CALL gravar_solic_compra_consist(nr_solic_compra_p,'1',ds_mensagem_disp_merc_w,'C',Wheb_mensagem_pck.get_Texto(299004),nm_usuario_p);
		elsif (ie_verifica_mat_indisp_w = 'M') then
			CALL gravar_solic_compra_consist(nr_solic_compra_p,'1',ds_mensagem_disp_merc_w,'M',null,nm_usuario_p);
		end if;

		end;
	end if;

	if (qt_existe_regra_lib_w > 0) then
		begin

		select	coalesce(obter_se_consiste_regra_lib_sc(nr_solic_compra_p,cd_material_w,'M',cd_estabelecimento_w),'N'),
			coalesce(obter_se_consiste_regra_lib_sc(nr_solic_compra_p,cd_material_w,'F',cd_estabelecimento_w),'N'),
			coalesce(obter_se_consiste_regra_lib_sc(nr_solic_compra_p,cd_material_w,'D',cd_estabelecimento_w),'N'),
			coalesce(obter_se_consiste_regra_lib_sc(nr_solic_compra_p,cd_material_w,'A',cd_estabelecimento_w),'N'),
			coalesce(obter_se_consiste_regra_lib_sc(nr_solic_compra_p,cd_material_w,'C',cd_estabelecimento_w),'N'),
			coalesce(obter_se_consiste_regra_lib_sc(nr_solic_compra_p,cd_material_w,'V',cd_estabelecimento_w),'N')
		into STRICT	ie_exige_marca_w,
			ie_exige_fabricante_w,
			ie_exige_detalhe_tec_w,
			ie_exige_anvisa_est_w,
			ie_exige_anvisa_est_control_w,
			ie_exige_aval_dinamica_w
		;

		if (ie_exige_marca_w = 'S') then
			begin

			select	count(*)
			into STRICT	qt_existe_exigencia_regra_w
			from	material_marca
			where	cd_material = cd_material_w;

			if (qt_existe_exigencia_regra_w = 0) then
				CALL gravar_solic_compra_consist(nr_solic_compra_p,
								'1',
								Wheb_mensagem_pck.get_Texto(299005, 'CD_MATERIAL_W='||CD_MATERIAL_W), /*'O material ' || cd_material_w || ' nao possui marca vinculada.',*/
								'C',
								Wheb_mensagem_pck.get_Texto(299006),/* 'Verifique o cadastro de marcas do material.',*/
								nm_usuario_p);				
			end if;

			end;
		end if;
		
		if (ie_exige_aval_dinamica_w = 'S') then
			begin

			select	count(*)
			into STRICT	qt_existe_exigencia_regra_w
			from	avf_resultado
			where	nr_solic_compra = nr_solic_compra_p
			and	(dt_aprovacao IS NOT NULL AND dt_aprovacao::text <> '');

			if (qt_existe_exigencia_regra_w = 0) then
				CALL gravar_solic_compra_consist(nr_solic_compra_p,
								'1',
								Wheb_mensagem_pck.get_Texto(454863), /*Para essa solicitacao de compras, deve existir pelo menos uma avaliacao dinamica aprovada.*/
								'C',
								Wheb_mensagem_pck.get_Texto(454873),/* A avaliacao dinamica deve ser feita na pasta "Avaliacao dinamica". A avaliacao e obrigatoria conforme a regra "Consistencias ao liberar solicitacao de compras". */
								nm_usuario_p);				
			end if;

			end;
		end if;

		if (ie_exige_fabricante_w = 'S') then
			begin

			select	count(*)
			into STRICT	qt_existe_exigencia_regra_w
			from	material
			where	cd_material = cd_material_w
			and	(nr_seq_fabric IS NOT NULL AND nr_seq_fabric::text <> '');

			if (qt_existe_exigencia_regra_w = 0) then
				CALL gravar_solic_compra_consist(	nr_solic_compra_p,
								'1',
								Wheb_mensagem_pck.get_Texto(299008, 'CD_MATERIAL_W='||CD_MATERIAL_W), /*'O material ' || cd_material_w || ' nao possui fabricante.',*/
								'C',
								Wheb_mensagem_pck.get_Texto(299009), /*'Verifique o cadastro do material.',*/
								nm_usuario_p);				
			end if;

			end;
		end if;
		

		if (ie_exige_detalhe_tec_w = 'S') then
			begin

			select	count(*)
			into STRICT	qt_existe_exigencia_regra_w
			from	solic_compra_item_detalhe
			where	nr_item_solic_compra = nr_item_solic_compra_w
			and	nr_solic_compra = nr_solic_compra_p
			and	(ds_detalhe IS NOT NULL AND ds_detalhe::text <> '');

			if (qt_existe_exigencia_regra_w = 0) then
				CALL gravar_solic_compra_consist(	nr_solic_compra_p,
								'1',
								Wheb_mensagem_pck.get_Texto(299010, 'CD_MATERIAL_W='||CD_MATERIAL_W), /*'O material ' || cd_material_w || ' nao possui detalhe tecnico informado.',*/
								'C',
								Wheb_mensagem_pck.get_Texto(299011),/* 'Verifique o cadastro Detalhe tecnico.',*/
								nm_usuario_p);
			end if;
			end;
		end if;

		if (ie_exige_anvisa_est_w = 'S') then
			begin
			
			select	cd_material_estoque
			into STRICT	cd_material_estoque_w
			from	material
			where	cd_material	= cd_material_w;
			
			select	nr_registro_anvisa,
				dt_validade_reg_anvisa,
				coalesce(ie_vigente_anvisa,'N')
			into STRICT	nr_registro_anvisa_w,
				dt_validade_reg_anvisa_w,
				ie_vigente_anvisa_w
			from	material_estab
			where	cd_material		= cd_material_estoque_w
			and	cd_estabelecimento	= cd_estabelecimento_w;
			
			if (coalesce(nr_registro_anvisa_w::text, '') = '') or
				((ie_vigente_anvisa_w = 'N') and (coalesce(dt_validade_reg_anvisa_w::text, '') = '')) then
				CALL gravar_solic_compra_consist(	nr_solic_compra_p,
								'1',
								Wheb_mensagem_pck.get_Texto(299012, 'CD_MATERIAL_W='||CD_MATERIAL_W), /*'O material ' || cd_material_w || ' nao possui registro ou validade da anvisa preenchido.',*/
								'C',
								Wheb_mensagem_pck.get_Texto(299013), /*'Verifique o cadastro do material.',*/
								nm_usuario_p);
								
			elsif (ie_vigente_anvisa_w = 'N') and (dt_validade_reg_anvisa_w IS NOT NULL AND dt_validade_reg_anvisa_w::text <> '') and (dt_validade_reg_anvisa_w < clock_timestamp()) then
				CALL gravar_solic_compra_consist(	nr_solic_compra_p,
								'1',
								Wheb_mensagem_pck.get_Texto(299015, 'CD_MATERIAL_W='||CD_MATERIAL_W), /*'O material ' || cd_material_w || ' esta com o registro da anvisa vencido.',*/
								'C',
								Wheb_mensagem_pck.get_Texto(299013), /*'Verifique o cadastro do material.',*/
								nm_usuario_p);
			end if;
			
			end;
		end if;
		
		if (ie_exige_anvisa_est_control_w = 'S') then
			begin
			
			select	cd_material_estoque
			into STRICT	cd_material_estoque_w
			from	material
			where	cd_material	= cd_material_w;
			
			open C03;
			loop
			fetch C03 into	
				cd_material_controlado_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin
				
				select	nr_registro_anvisa,
					dt_validade_reg_anvisa
				into STRICT	nr_registro_anvisa_w,
					dt_validade_reg_anvisa_w
				from	material_estab
				where	cd_material		= cd_material_controlado_w
				and	cd_estabelecimento	= cd_estabelecimento_w;
				
				if (coalesce(nr_registro_anvisa_w::text, '') = '') or (coalesce(dt_validade_reg_anvisa_w::text, '') = '') then
					CALL gravar_solic_compra_consist(	nr_solic_compra_p,
									'1',
									WHEB_MENSAGEM_PCK.get_texto(299017,'CD_MATERIAL_CONTROLADO_W='||CD_MATERIAL_CONTROLADO_W||';CD_MATERIAL_ESTOQUE_W='||CD_MATERIAL_ESTOQUE_W),/*'O material ' || cd_material_controlado_w || ', controlado pelo material ' || cd_material_estoque_w || ', nao possui registro ou validade da anvisa preenchido.',*/
									'C',
									Wheb_mensagem_pck.get_Texto(299013), /*'Verifique o cadastro do material.',*/
									nm_usuario_p);
				elsif (dt_validade_reg_anvisa_w IS NOT NULL AND dt_validade_reg_anvisa_w::text <> '') and (dt_validade_reg_anvisa_w < clock_timestamp()) then
					CALL gravar_solic_compra_consist(	nr_solic_compra_p,
									'1',
									WHEB_MENSAGEM_PCK.get_texto(299018,'CD_MATERIAL_CONTROLADO_W='||CD_MATERIAL_CONTROLADO_W||';CD_MATERIAL_ESTOQUE_W='||CD_MATERIAL_ESTOQUE_W),/*'O material ' || cd_material_controlado_w || ', controlado pelo material ' || cd_material_estoque_w || ', esta com o registro da anvisa vencido.',*/
									'C',
									Wheb_mensagem_pck.get_Texto(299013), /*'Verifique o cadastro do material.',*/
									nm_usuario_p);
									
				end if;
				end;
			end loop;
			close C03;
			
			end;
		end if;
		end;
	end if;

	
	
	/* Consiste diferenca no rateio do item */

	select	count(*)
	into STRICT	qt_reg_rateio_w
	from	solic_compra_item_rateio
	where	nr_solic_compra = nr_solic_compra_p
	and	nr_item_solic_compra = nr_item_solic_compra_w;

	if (qt_reg_rateio_w > 0) then

		qt_material_ww := qt_material_w;

		select	coalesce(sum(vl_rateio),0)
		into STRICT	vl_rateio_w
		from	solic_compra_item_rateio
		where	nr_solic_compra = nr_solic_compra_p
		and	nr_item_solic_compra = nr_item_solic_compra_w;

		select	coalesce(sum(qt_rateio),0)
		into STRICT	qt_rateio_w
		from	solic_compra_item_rateio
		where	nr_solic_compra = nr_solic_compra_p
		and	nr_item_solic_compra = nr_item_solic_compra_w;
		
		if (ie_consiste_dif_valor_rateio_w = 'S') and (vl_unit_previsto_w > 0) and
			((round((vl_unit_previsto_w * qt_material_ww)::numeric, 2) - vl_rateio_w) <> 0) then
			
			CALL gravar_solic_compra_consist(	nr_solic_compra_p,
							'1',
							substr(WHEB_MENSAGEM_PCK.get_texto(299022,'CD_MATERIAL_W='||cd_material_w||';DS_MATERIAL_W='||ds_material_w),1,255), /*substr('O material ' || cd_material_w || ' - ' || ds_material_w || ' esta com diferenca no valor do rateio.',1,255),*/
							'C',
							Wheb_mensagem_pck.get_Texto(299023), /*'Verifique a pasta Rateio.',*/
							nm_usuario_p);	
		end if;
		
		if (ie_consiste_dif_qt_rateio_w = 'S') and
			((qt_material_ww - qt_rateio_w) <> 0) then
			CALL gravar_solic_compra_consist(	nr_solic_compra_p,
							'1',							
							substr(WHEB_MENSAGEM_PCK.get_texto(299024,'CD_MATERIAL_W='||cd_material_w||';DS_MATERIAL_W='||ds_material_w),1,255),/*substr('O material ' || cd_material_w || ' - ' || ds_material_w || ' esta com diferenca na quantidade do rateio.',1,255),*/
							'C',
							Wheb_mensagem_pck.get_Texto(299023), /*'Verifique a pasta Rateio.',*/
							nm_usuario_p);	
		end if;
	end if;
	
	/*Consistencia da Regra para consistencia compra pendente na solicitacao */

	if (ie_consistir_itens_w = 'P') then

		select	coalesce(max(nr_seq_forma_compra),0)
		into STRICT	nr_seq_forma_solic_compra_w
		from 	solic_compra
		where 	nr_solic_compra = nr_solic_compra_p;
		
		select	obter_regra_consist_pend_com(cd_estabelecimento_w,nr_seq_forma_solic_compra_w)
		into STRICT	nr_seq_regra_w
		;
		
		if (nr_seq_regra_w > 0) then
		
			select	max(coalesce(ie_consiste_solic_pend,'N')),
				max(coalesce(ie_consiste_cot_pend,'N')),
				max(coalesce(ie_consiste_oc_pend,'N')),
				max(coalesce(ie_consiste_lic_pend,'N')),
				max(coalesce(ie_acao_liberar,'N'))
			into STRICT	ie_consiste_solic_pend_regra_w,
				ie_consiste_cot_pend_regra_w,
				ie_consiste_oc_pend_regra_w,
				ie_consiste_lic_pend_regra_w,
				ie_acao_liberar_regra_w
			from 	regra_consist_pend_compra
			where 	nr_sequencia = nr_seq_regra_w;
			
			select	CASE WHEN ie_acao_liberar_regra_w='A' THEN 'M' WHEN ie_acao_liberar_regra_w='S' THEN 'C' END
			into STRICT	ie_acao_liberar_regra_w
			;
			
			if (ie_consiste_solic_pend_regra_w = 'S') then --SOLICITACAO		
				
				select	count(*)
				into STRICT	qt_solic_pendente_w
				from	compra_pendente_v
				where	ie_informacao		= 2
				and 	cd_material		= cd_material_w
				and 	cd_estabelecimento 	= cd_estabelecimento_w;
		
				if (qt_solic_pendente_w > 0) then		
					CALL gravar_solic_compra_consist(	
							nr_solic_compra_p,
							'1',							
							substr(WHEB_MENSAGEM_PCK.get_texto(388355,'DS_MATERIAL='||ds_material_w),1,255),/*#@DS_MATERIAL#@. Existem solicitacoes pendentes para esse item.*/
							ie_acao_liberar_regra_w,
							Wheb_mensagem_pck.get_Texto(392469), /*Verifique a Regra para consistencia compra pendente na solicitacao,*/
							nm_usuario_p);
				end if;
			end if;	

			if (ie_consiste_cot_pend_regra_w = 'S') then --COTACAO		
				
				select	count(*)
				into STRICT	qt_cot_pendente_w
				from	compra_pendente_v
				where	ie_informacao		= 3
				and 	cd_material		= cd_material_w
				and 	cd_estabelecimento 	= cd_estabelecimento_w;
		
				if (qt_cot_pendente_w > 0) then
					CALL gravar_solic_compra_consist(	
							nr_solic_compra_p,
							'1',							
							substr(WHEB_MENSAGEM_PCK.get_texto(388361,'DS_MATERIAL='||ds_material_w),1,255),/*#@DS_MATERIAL#@. Existem cotacoes pendentes para esse item.*/
							ie_acao_liberar_regra_w,
							Wheb_mensagem_pck.get_Texto(392469), /*Verifique a Regra para consistencia compra pendente na solicitacao,*/
							nm_usuario_p);
				end if;
			end if;	
			
			if (ie_consiste_oc_pend_regra_w = 'S') then --ORDENS		
				
				select	count(*)
				into STRICT	qt_oc_pendente_w
				from	compra_pendente_v
				where	ie_informacao		= 1
				and 	cd_material		= cd_material_w
				and 	cd_estabelecimento 	= cd_estabelecimento_w;
		
				if (qt_oc_pendente_w > 0) then
					CALL gravar_solic_compra_consist(	
							nr_solic_compra_p,
							'1',							
							substr(WHEB_MENSAGEM_PCK.get_texto(388363,'DS_MATERIAL='||ds_material_w),1,255),/*#@DS_MATERIAL#@. Existem ordens pendentes para esse item.*/
							ie_acao_liberar_regra_w,
							Wheb_mensagem_pck.get_Texto(392469), /*Verifique a Regra para consistencia compra pendente na solicitacao,*/
							nm_usuario_p);
				end if;
			end if;	
			
			if (ie_consiste_lic_pend_regra_w = 'S') then --LICITACAO
				
				select	sum(qt_registros)
				into STRICT	qt_licitacao_pendente_w
				from (
					SELECT	count(*) qt_registros
					from 	reg_licitacao a,
						reg_lic_item b
					where 	a.nr_sequencia 		= b.nr_seq_licitacao
					and 	a.cd_estabelecimento 	= cd_estabelecimento_w
					and 	b.cd_material 		= cd_material_w
					and 	not exists (	SELECT	1
								from	reg_compra z,
									reg_compra_item x
								where 	z.nr_sequencia = x.nr_seq_reg_compra
								and	z.nr_seq_licitacao = a.nr_sequencia
								and	x.cd_material = b.cd_material)
					
union
					
					select 	count(*)
					from	lic_item a,
						lic_licitacao b,
						lic_estagio c
					where	a.nr_seq_licitacao 	= b.nr_sequencia
					and	b.nr_seq_estagio 	= c.nr_sequencia
					and	c.ie_permite_oc 	= 'S'
					and	a.cd_material 		= cd_material_w) alias5;
				
				if (qt_licitacao_pendente_w > 0) then
					CALL gravar_solic_compra_consist(	
							nr_solic_compra_p,
							'1',							
							substr(WHEB_MENSAGEM_PCK.get_texto(388365,'DS_MATERIAL='||ds_material_w),1,255),/*#@DS_MATERIAL#@. Existem licitacoes pendentes para esse item.*/
							ie_acao_liberar_regra_w,
							Wheb_mensagem_pck.get_Texto(392469), /*Verifique a Regra para consistencia compra pendente na solicitacao,*/
							nm_usuario_p);
				end if;									
			end if;	
		end if;
	end if;
	
	end;
end loop;
close c01;

select	count(*)
into STRICT	qt_regra_w
from	regra_solicitacao_material;

if (qt_regra_w > 0) then

	select	ie_aviso_chegada,
		ie_aviso_aprov_oc,
		ie_urgente
	into STRICT	ie_aviso_chegada_w,
		ie_aviso_aprov_oc_w,
		ie_urgente_w
	from	solic_compra
	where	nr_solic_compra = nr_solic_compra_p;

	open	c02;
	loop
	fetch	c02 into
		cd_material_ww;
	EXIT WHEN NOT FOUND; /* apply on c02 */
	
	begin
	select	obter_regra_solic_material(cd_material_ww, cd_estabelecimento_w, 'C'),
		obter_regra_solic_material(cd_material_ww, cd_estabelecimento_w, 'A'),
		obter_regra_solic_material(cd_material_ww, cd_estabelecimento_w, 'U'),
		obter_regra_solic_material(cd_material_ww, cd_estabelecimento_w, 'L')
	into STRICT	ie_aviso_chegada_ww,
		ie_aviso_aprov_oc_ww,
		ie_urgente_ww,
		ie_permite_liberar_w
	;
	end;
	
	if (ie_permite_liberar_w = 'N') then
		CALL gravar_solic_compra_consist(
			nr_solic_compra_p, '1',
			Wheb_mensagem_pck.get_Texto(299026, 'CD_MATERIAL_WW='||CD_MATERIAL_WW),/*'Nao e permitido liberar uma solicitacao com o material ' || cd_material_ww || '.',*/
			'C',
			Wheb_mensagem_pck.get_Texto(299027, 'CD_MATERIAL_WW='||CD_MATERIAL_WW),/*'De acordo com a Regra solicitacao por materiais (Cadastros - Suprimentos - Cadastro de compras), nao permite liberar uma solicitacao que tenha o material ' || cd_material_ww || '.',*/
			nm_usuario_p);	
	end if;

	if (ie_aviso_chegada_w = 'N') and (ie_aviso_chegada_ww = 'S') then
		CALL gravar_solic_compra_consist(
			nr_solic_compra_p, '1',
			Wheb_mensagem_pck.get_Texto(299028, 'CD_MATERIAL_WW='||CD_MATERIAL_WW),/*'O material ' || cd_material_ww || ' necessita que a solicitacao seja com aviso de chegada de material',*/
			'C',
			Wheb_mensagem_pck.get_Texto(299029, 'CD_MATERIAL_WW='||CD_MATERIAL_WW),/*'De acordo com a Regra solicitacao por materiais (Cadastros - Suprimentos - Cadastro de compras), o material ' || cd_material_ww || ' exige que a solicitacao de compra esteja com o campo Avisa chegada material marcado.',*/
			nm_usuario_p);

	elsif (ie_aviso_chegada_w = 'S') and (ie_aviso_chegada_ww = 'N') then
		CALL gravar_solic_compra_consist(
			nr_solic_compra_p, '1',
			Wheb_mensagem_pck.get_Texto(299031, 'CD_MATERIAL_WW='||CD_MATERIAL_WW),/*'O material ' || cd_material_ww || ' nao pode estar numa solicitacao com aviso de chegada',*/
			'C',
			Wheb_mensagem_pck.get_Texto(299033, 'CD_MATERIAL_WW='||CD_MATERIAL_WW),/*'De acordo com a Regra solicitacao por materiais (Cadastros - Suprimentos - Cadastro de compras), o material ' || cd_material_ww || ' exige que a solicitacao de compra esteja com o campo Avisa chegada material desmarcado.',*/
			nm_usuario_p);

	elsif (ie_aviso_aprov_oc_w = 'N') and (ie_aviso_aprov_oc_ww = 'S') then
		CALL gravar_solic_compra_consist(
			nr_solic_compra_p, '1',
			Wheb_mensagem_pck.get_Texto(299034, 'CD_MATERIAL_WW='||CD_MATERIAL_WW),/*'O material ' || cd_material_ww || ' necessita que a solicitacao seja com aviso de aprovacao',*/
			'C',
			Wheb_mensagem_pck.get_Texto(299035, 'CD_MATERIAL_WW='||CD_MATERIAL_WW),/*'De acordo com a Regra solicitacao por materiais (Cadastros - Suprimentos - Cadastro de compras), o material ' || cd_material_ww || ' exige que a solicitacao de compra esteja com o campo Avisar aprovacao OC marcado.',*/
			nm_usuario_p);		

	elsif (ie_aviso_aprov_oc_w = 'S') and (ie_aviso_aprov_oc_ww = 'N') then
		CALL gravar_solic_compra_consist(
			nr_solic_compra_p, '1',
			Wheb_mensagem_pck.get_Texto(299036, 'CD_MATERIAL_WW='||CD_MATERIAL_WW),/*'O material ' || CD_MATERIAL_WW || ' nao pode estar numa solicitacao com aviso de aprovacao',*/
			'C',
			Wheb_mensagem_pck.get_Texto(299037, 'CD_MATERIAL_WW='||CD_MATERIAL_WW),/*'De acordo com a Regra solicitacao por materiais (Cadastros - Suprimentos - Cadastro de compras), o material ' || CD_MATERIAL_WW || ' exige que a solicitacao de compra esteja com o campo Avisar aprovacao OC desmarcado.',*/
			nm_usuario_p);
	
	elsif (ie_urgente_w = 'N') and (ie_urgente_ww = 'S') then
		CALL gravar_solic_compra_consist(
			nr_solic_compra_p, '1',
			Wheb_mensagem_pck.get_Texto(299039, 'CD_MATERIAL_WW='||CD_MATERIAL_WW),/*'O material ' || CD_MATERIAL_WW || ' necessita que a solicitacao seja Urgente',*/
			'C',
			Wheb_mensagem_pck.get_Texto(299040, 'CD_MATERIAL_WW='||CD_MATERIAL_WW),/*'De acordo com a Regra solicitacao por materiais (Cadastros - Suprimentos - Cadastro de compras), o material ' || CD_MATERIAL_WW || ' exige que a solicitacao de compra esteja com o campo Urgente marcado.',*/
			nm_usuario_p);

	elsif (ie_urgente_w = 'S') and (ie_urgente_ww = 'N') then
		CALL gravar_solic_compra_consist(
			nr_solic_compra_p, '1',
			Wheb_mensagem_pck.get_Texto(299041, 'CD_MATERIAL_WW='||CD_MATERIAL_WW),/*'O material ' || CD_MATERIAL_WW || ' nao pode estar numa solicitacao Urgente',*/
			'C',
			Wheb_mensagem_pck.get_Texto(299042, 'CD_MATERIAL_WW='||CD_MATERIAL_WW),/*'De acordo com a Regra solicitacao por materiais (Cadastros - Suprimentos - Cadastro de compras), o material ' || CD_MATERIAL_WW || ' exige que a solicitacao de compra esteja com o campo Urgente desmarcado.',*/
			nm_usuario_p);
	end if;
	
end loop;
close c02;
end if;

if (ie_consiste_mat_ccusto_p = 'S') then
	begin
	select	count(*)
	into STRICT	qt_regra_w
	from	centro_custo_material
	where	cd_centro_custo = cd_centro_custo_w;

	if (qt_regra_w > 0) then
		open C02;
		loop
		fetch C02 into	
			cd_material_ww;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
	
			select	coalesce(obter_permite_material_solic(cd_centro_custo_w,cd_material_ww),'S')
			into STRICT	ie_permite_w
			;
		
			if (ie_permite_w = 'N') then
				CALL gravar_solic_compra_consist(
					nr_solic_compra_p, '1',
					Wheb_mensagem_pck.get_Texto(299044, 'CD_MATERIAL_WW='||CD_MATERIAL_WW),/*'O material ' || CD_MATERIAL_WW || ' nao pode ser solicitado para este centro de custo',*/
					'C',
					Wheb_mensagem_pck.get_Texto(299046), /*'De acordo com as regras na funcao Empresa/Estabelecimento/Contas/CC - Pasta Centro resultado, nao e permitido a solicitacao deste material para este centro ce custo.',*/
					nm_usuario_p);
			end if;
			end;
		end loop;
		close C02;
	end if;
	end;
end if;

select  (CASE WHEN (max(nr_sequencia) IS NOT NULL AND (max(nr_sequencia))::text <> '') THEN 'S' ELSE 'N' END)
into STRICT	is_regulated_price_w
from    rule_regulated_price;

if (is_regulated_price_w = 'S') then
	for solic_compra_w in c01 loop
		select	to_number(obter_regulated_price('VMC', solic_compra_w.cd_material), '99999D99')
		into STRICT	vl_max_purchase_w
		;

		if (solic_compra_w.vl_unit_previsto > vl_max_purchase_w) then
			CALL gravar_solic_compra_consist(
				nr_solic_compra_p, '1',
				Wheb_mensagem_pck.get_Texto(1206805, 'CD_MATERIAL_W='||solic_compra_w.cd_material),/*'O item #@CD_MATERIAL_W#@ possui valor unitario maior que o preco de compra regulamentado.',*/
				'M',
				Wheb_mensagem_pck.get_Texto(1206806), /*'Verifique a regra de preco regulado na funcao "Cadastros Gerais" > "Aplicacao Principal" > "Cadastros Gerais" > "Regra de preco regulado".',*/
				nm_usuario_p);
		end if;
	end loop;
end if;

CALL consistir_regra_controle_sc(nr_solic_compra_p,nm_usuario_p);

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_solic_compra_item ( nr_solic_compra_p bigint, nr_item_solic_compra_p bigint, ie_consistir_estoque_p text, ie_deleta_consist_p text, ie_consiste_regra_aprov_p text, ie_consiste_mat_ccusto_p text, nm_usuario_p text, ie_plataforma_p text default 'J') FROM PUBLIC;

