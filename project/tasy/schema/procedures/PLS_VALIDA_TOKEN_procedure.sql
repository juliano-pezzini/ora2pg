-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_valida_token ( ds_token_p pls_carteira_leitura_token.ds_token%type, nm_usuario_p pls_carteira_leitura_token.nm_usuario%type, nr_seq_leitura_p pls_carteira_leitura_token.nr_seq_leitura%type, ie_chama_integracao_p text, ie_chamada_portal_p text, nr_seq_cart_leitura_p INOUT pls_carteira_leitura_token.nr_sequencia%type) AS $body$
DECLARE


nr_sequencia_w    pls_carteira_leitura_token.nr_sequencia%type;
json_w            philips_json;
data_w            text;
ds_retorno_integracao_w    varchar(4000);
nm_usuario_aux_w    pls_carteira_leitura_token.nm_usuario%type;

BEGIN

if (ie_chamada_portal_p = 'S') then
    nm_usuario_aux_w := wheb_usuario_pck.get_nm_usuario();	
    CALL wheb_usuario_pck.set_nm_usuario(nm_usuario_p);
end if;

insert into    pls_carteira_leitura_token(    nr_sequencia, nr_seq_leitura, nm_usuario, nm_usuario_nrec, 
        dt_atualizacao, dt_atualizacao_nrec, ds_token, ie_status)
values (    nextval('pls_carteira_leitura_token_seq'), nr_seq_leitura_p, nm_usuario_p, nm_usuario_p,
        clock_timestamp(), clock_timestamp(), ds_token_p, 1) returning nr_sequencia into nr_sequencia_w;

nr_seq_cart_leitura_p := nr_sequencia_w;

if (ie_chama_integracao_p = 'S') then
    dbms_lob.createtemporary(data_w, true);
    json_w := philips_json();
    json_w.put('id', nr_sequencia_w);
    json_w.put('token', ds_token_p);
    json_w.put('readId', nr_seq_leitura_p);
    json_w.(data_w);

    select    bifrost.send_integration_content('health.insurance.token', data_w, nm_usuario_p)
    into STRICT    ds_retorno_integracao_w
;
end if;

if (ie_chamada_portal_p = 'S') then
	 CALL wheb_usuario_pck.set_nm_usuario(nm_usuario_aux_w);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_valida_token ( ds_token_p pls_carteira_leitura_token.ds_token%type, nm_usuario_p pls_carteira_leitura_token.nm_usuario%type, nr_seq_leitura_p pls_carteira_leitura_token.nr_seq_leitura%type, ie_chama_integracao_p text, ie_chamada_portal_p text, nr_seq_cart_leitura_p INOUT pls_carteira_leitura_token.nr_sequencia%type) FROM PUBLIC;

