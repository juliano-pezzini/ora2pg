-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_verificar_baixa_titulo ( nr_seq_mensalidade_p bigint, ie_varios_titulos_p text) AS $body$
DECLARE

 
qt_baixas_mens_w	bigint;
ie_varios_titulos_w	varchar(1) := 'N';
nr_titulo_w		titulo_receber.nr_titulo%type;
ie_situacao_w		varchar(1);

C01 CURSOR FOR 
	SELECT	nr_titulo, 
		ie_situacao 
	from	titulo_receber 
	where	nr_seq_mensalidade = nr_seq_mensalidade_p;


BEGIN 
 
if (ie_varios_titulos_p = 'S') then 
	open C01;
	loop 
	fetch C01 into	 
		nr_titulo_w, 
		ie_situacao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		if (ie_situacao_w <> 3) then 
			select	count(1) 
			into STRICT	qt_baixas_mens_w 
			from	titulo_receber_liq a 
			where	a.nr_titulo = nr_titulo_w 
			and	coalesce(a.nr_seq_liq_origem::text, '') = '' 
			and	not exists (	SELECT	1 
						from	titulo_receber_liq x 
						where	x.nr_titulo = a.nr_titulo 
						and	x.nr_seq_liq_origem = a.nr_sequencia);
			 
			if (qt_baixas_mens_w > 0) then 
				CALL wheb_mensagem_pck.exibir_mensagem_abort( 475552, 'NR_SEQ_MENSALIDADE=' || nr_seq_mensalidade_p || ';NR_TITULO=' || nr_titulo_w);
			end if;
		end if;
		end;
	end loop;
	close C01;
elsif (ie_varios_titulos_p = 'N') then 
	select	max(nr_titulo) 
	into STRICT	nr_titulo_w 
	from	titulo_receber 
	where	nr_seq_mensalidade = nr_seq_mensalidade_p;
 
	if (nr_titulo_w IS NOT NULL AND nr_titulo_w::text <> '') then 
		select	count(1) 
		into STRICT	qt_baixas_mens_w 
		from	titulo_receber_liq b, 
			titulo_receber	a 
		where	a.nr_titulo	= b.nr_titulo 
		and	a.nr_titulo = nr_titulo_w 
		and	a.ie_situacao <> 3 
		and   coalesce(b.nr_seq_liq_origem::text, '') = '' 
		and   not exists ( SELECT 1 
				   from  titulo_receber_liq x 
				   where  x.nr_titulo = a.nr_titulo 
				   and   x.nr_seq_liq_origem = b.nr_sequencia);
		 
		if (qt_baixas_mens_w > 0) then 
			CALL wheb_mensagem_pck.exibir_mensagem_abort( 475552, 'NR_SEQ_MENSALIDADE=' || nr_seq_mensalidade_p || ';NR_TITULO=' || nr_titulo_w);
		end if;
	end if;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_verificar_baixa_titulo ( nr_seq_mensalidade_p bigint, ie_varios_titulos_p text) FROM PUBLIC;

