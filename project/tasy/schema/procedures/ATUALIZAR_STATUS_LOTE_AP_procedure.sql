-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_status_lote_ap ( nr_seq_lote_p bigint, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE


ds_maq_user_w 		varchar(80);
cd_perfil_ativo_w		integer;
ie_status_lote_w	varchar(3);
ds_erro_w		varchar(255);
ie_integracao_w		varchar(1);
ie_agrupamento_w    ap_lote.ie_agrupamento%type;
					

BEGIN
ds_erro_w := '';

select	ie_status_lote,
	ie_integracao
into STRICT	ie_status_lote_w,
	ie_integracao_w
from	ap_lote
where	nr_sequencia = nr_seq_lote_p;


if (ie_status_lote_w = 'C') or (ie_status_lote_w = 'CA') or (coalesce(ie_integracao_w,'N') = 'S') then

	update	ap_lote	
	set	dt_atend_farmacia 	 = NULL,
		nm_usuario_atend 	 = NULL,
		ds_maquina_atend 	 = NULL,
		cd_perfil_atend		 = NULL,
		dt_inicio_dispensacao 	 = NULL,
		nm_usuario_ini_disp 	 = NULL,
		ds_maquina_ini_disp 	 = NULL,
		cd_perfil_ini_disp	 = NULL,
		nr_seq_motivo_cancel	 = NULL,
		ie_status_lote   	= 'G'
	where 	nr_sequencia = nr_seq_lote_p;
	
	update	ap_lote_item
	set	dt_supensao	= '',
		nm_usuario_susp	= ''
	where	nr_seq_lote	= nr_seq_lote_p;
	
    select	coalesce(max(ie_agrupamento),'N')
    into STRICT	ie_agrupamento_w
    from 	ap_lote
    where 	nr_sequencia = nr_seq_lote_p;

	if (ie_agrupamento_w = 'S') then
    	update	ap_lote
    	set dt_atend_farmacia    = NULL,
            nm_usuario_atend     = NULL,
            ds_maquina_atend     = NULL,
            cd_perfil_atend  = NULL,
            dt_inicio_dispensacao    = NULL,
            nm_usuario_ini_disp  = NULL,
            ds_maquina_ini_disp  = NULL,
            cd_perfil_ini_disp   = NULL,
            nr_seq_motivo_cancel     = NULL,
            ie_status_lote  = 'G'
    	where  	nr_lote_agrupamento		= nr_seq_lote_p
        and ie_status_lote = 'C';
    end if;

	commit;
		
	insert into ap_lote_historico(
		nr_sequencia,			dt_atualizacao,
		nm_usuario,			nr_seq_lote,
		ds_evento,			ds_log)
	values (	nextval('ap_lote_historico_seq'),		clock_timestamp(),
		nm_usuario_p,			nr_seq_lote_p,
		WHEB_MENSAGEM_PCK.get_texto(281103),		WHEB_MENSAGEM_PCK.get_texto(281104));
else
	ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(281106);
	
end if;
commit;

ds_erro_p := ds_erro_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_status_lote_ap ( nr_seq_lote_p bigint, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

