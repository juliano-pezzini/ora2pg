-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_gerar_envio_arq_a600_60 ( nr_seq_camara_comp_p ptu_camara_compensacao.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_seq_registro_w		bigint := 0;
ds_conteudo_w			varchar(4000);
qt_tot_documento_w		integer;
qt_tot_credora_w		integer;
qt_tot_devedora_w		integer;
vl_total_fatura_w		ptu_camara_fatura.vl_total_fatura%type;

-- 601
c01 CURSOR(nr_seq_camara_comp_pc	ptu_camara_compensacao.nr_sequencia%type) FOR
	SELECT	nr_sequencia nr_seq_camara_comp,
		lpad(cd_unimed_destino,4,'0') cd_unimed_destino,
		lpad(cd_unimed_origem,4,'0') cd_unimed_origem,
		to_char(clock_timestamp(),'yyyymmdd') dt_geracao,
		to_char(dt_camara,'yyyymmdd') dt_camara,
		CASE WHEN ie_tipo_camara='IAF' THEN 1 WHEN ie_tipo_camara='F' THEN 2 WHEN ie_tipo_camara='IEF' THEN 3 WHEN ie_tipo_camara='N' THEN 4 END  ie_tipo_camara
	from	ptu_camara_compensacao
	where	nr_sequencia	= nr_seq_camara_comp_pc;

-- 602
c02 CURSOR(nr_seq_camara_comp_pc	ptu_camara_compensacao.nr_sequencia%type) FOR
	SELECT	nr_sequencia nr_seq_camara_fat,
		lpad(cd_unimed_credora,4,'0') cd_unimed_credora,
		lpad(coalesce(cd_unimed_superior,cd_unimed_devedora),4,'0') cd_unimed_devedora,
		ie_tipo_fatura,
		lpad(coalesce(replace(replace(campo_mascara(vl_total_fatura,2),',',''),'.',''),'0'),14,'0') vl_total_fatura,
		rpad(coalesce(nr_documento,to_char(nr_fatura)),20,' ') nr_documento,
		vl_total_fatura vl_total
	from	ptu_camara_fatura
	where	nr_seq_camara	= nr_seq_camara_comp_pc;
BEGIN
delete	FROM w_ptu_envio_arq
where	nm_usuario = nm_usuario_p;

for r_c01_w in c01( nr_seq_camara_comp_p ) loop
	-- Tipo de Registro: R601 ¿ HEADER (OBRIGATÓRIO)
	nr_seq_registro_w	:=	nr_seq_registro_w + 1;
	ds_conteudo_w		:= 	lpad(to_char(nr_seq_registro_w),8,'0') ||
					'601' ||
					r_c01_w.cd_unimed_destino ||
					r_c01_w.cd_unimed_origem ||
					r_c01_w.dt_geracao ||
					r_c01_w.dt_camara ||
					r_c01_w.ie_tipo_camara ||
					'07';

	insert into w_ptu_envio_arq(
		nr_sequencia, dt_atualizacao, nm_usuario,
		ds_conteudo, nr_seq_apres
	) values (
		nextval('w_ptu_envio_arq_seq'), clock_timestamp(), nm_usuario_p,
		ds_conteudo_w, nr_seq_registro_w);

	qt_tot_documento_w	:= 0;
	qt_tot_credora_w	:= 0;
	qt_tot_devedora_w	:= 0;
	vl_total_fatura_w 	:= 0;
	for r_c02_w in c02( r_c01_w.nr_seq_camara_comp ) loop
		-- Tipo de Registro: R602 ¿DOCUMENTO (OBRIGATÓRIO)
		nr_seq_registro_w	:=	nr_seq_registro_w + 1;
		ds_conteudo_w		:= 	lpad(to_char(nr_seq_registro_w),8,'0') ||
						'602' ||
						r_c02_w.cd_unimed_credora ||
						r_c02_w.cd_unimed_devedora ||
						rpad(' ',11,' ') ||
						r_c02_w.ie_tipo_fatura ||
						r_c02_w.vl_total_fatura ||
						r_c02_w.nr_documento;

		insert into w_ptu_envio_arq(
			nr_sequencia, dt_atualizacao, nm_usuario,
			ds_conteudo, nr_seq_apres
		) values (
			nextval('w_ptu_envio_arq_seq'), clock_timestamp(), nm_usuario_p,
			ds_conteudo_w, nr_seq_registro_w);

		qt_tot_documento_w	:= qt_tot_documento_w + 1;
		vl_total_fatura_w	:= vl_total_fatura_w + r_c02_w.vl_total;
	end loop;

	-- SM_UNI_CREDORA	Quantidade total de CD_UNI_CREDORA.
 	select	count(distinct x.cd_unimed_credora)
	into STRICT	qt_tot_credora_w
	from	ptu_camara_fatura x
	where	x.nr_seq_camara = r_c01_w.nr_seq_camara_comp;

	-- SM_UNI_DEVEDORA	Quantidade total de CD_UNI_DEVEDORA.
	select	count(distinct x.cd_unimed_devedora)
	into STRICT	qt_tot_devedora_w
	from	ptu_camara_fatura x
	where	x.nr_seq_camara = r_c01_w.nr_seq_camara_comp;

	-- Tipo de Registro: R609 ¿ TRAILER (OBRIGATÓRIO)
	nr_seq_registro_w	:=	nr_seq_registro_w + 1;
	ds_conteudo_w		:= 	lpad(to_char(nr_seq_registro_w),8,'0') ||
					'609' ||
					lpad(to_char(qt_tot_credora_w),6,'0') ||
					lpad(to_char(qt_tot_devedora_w),6,'0') ||
					lpad(to_char(qt_tot_documento_w),14,'0') ||
					lpad(coalesce(replace(replace(campo_mascara(vl_total_fatura_w,2),',',''),'.',''),'0'),14,'0');

	insert into w_ptu_envio_arq(
		nr_sequencia, dt_atualizacao, nm_usuario,
		ds_conteudo, nr_seq_apres
	) values (
		nextval('w_ptu_envio_arq_seq'), clock_timestamp(), nm_usuario_p,
		ds_conteudo_w, nr_seq_registro_w);
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_gerar_envio_arq_a600_60 ( nr_seq_camara_comp_p ptu_camara_compensacao.nr_sequencia%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

