-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_interface_desc_folha_pdf ( nr_seq_lote_p bigint, dt_referencia_p text, nm_usuario_p text) AS $body$
DECLARE


/*
ie_tipo_alteracao_w
	A = Alteração de valor
	I = Inclusão de valor
	E = Exclusão de valor
	O = Outros (Alterou a informação financeira)
*/
cd_matricula_w			varchar(20);
vl_incluir_w			double precision;
vl_excluir_w			double precision;
nr_seq_pagador_w		bigint;
dt_mens_atual_w			timestamp;
nr_seq_lote_mens_ant_w		bigint;
nr_seq_empresa_w		bigint;
vl_mens_ant_w			double precision;
vl_mens_atual_w			double precision;
ie_gravar_registro_w		varchar(1);
dt_referencia_w			timestamp;
nr_titulo_w			bigint;
dt_mens_ant_w			timestamp;
nr_seq_cobranca_w		bigint;
nr_seq_lote_mens_w		bigint;
nr_seq_pagador_fin_ant_w	bigint;
nr_seq_pagador_fin_atual_w	bigint;
ie_tipo_alteracao_w		varchar(1);
nr_seq_reajuste_ant_w		bigint;
nr_seq_reajuste_atual_w		bigint;
vl_excluir_ww			double precision;
tx_reajuste_w			double precision;
nr_seq_reajuste_w		bigint;

C01 CURSOR FOR
	SELECT	dt_mesano_referencia,
		nr_seq_empresa,
		nr_sequencia
	from	pls_lote_mensalidade
	where	(nr_seq_empresa IS NOT NULL AND nr_seq_empresa::text <> '')
	and	ie_status	<> 1
	and	(nr_sequencia	= nr_seq_lote_p
		or ((trunc(dt_mesano_referencia,'month') = trunc(to_date(dt_referencia_p,'dd/mm/yyyy'),'month')) and coalesce(nr_seq_lote_p,0) = 0));

C02 CURSOR FOR /* Comparar a mensalidade atual com a do mês anterior para verificar a diferença */
	SELECT	a.nr_seq_pagador,
		a.vl_mensalidade,
		a.dt_referencia
	from	pls_mensalidade		a,
		pls_lote_mensalidade	b
	where	a.nr_seq_lote	= b.nr_sequencia
	and	b.nr_sequencia	= nr_seq_lote_mens_ant_w
	and	coalesce(a.ie_cancelamento::text, '') = '';

C03 CURSOR FOR /* Lote novo, incluir todas as mensalidades */
	SELECT	a.nr_seq_pagador,
		a.vl_mensalidade,
		a.dt_referencia,
		b.nr_titulo
	FROM pls_lote_mensalidade c, pls_mensalidade a
LEFT OUTER JOIN titulo_receber b ON (a.nr_sequencia = b.nr_seq_mensalidade)
WHERE a.nr_seq_lote		= c.nr_sequencia and c.nr_sequencia		= nr_seq_lote_mens_w and coalesce(a.ie_cancelamento::text, '') = '';

C04 CURSOR FOR /* Mensalidades à incluir, que não estão na mensalidade anteriror */
	SELECT	a.nr_seq_pagador,
		vl_mensalidade,
		dt_referencia,
		nr_titulo
	FROM pls_mensalidade a
LEFT OUTER JOIN titulo_receber b ON (a.nr_sequencia = b.nr_seq_mensalidade)
WHERE nr_seq_lote		= nr_seq_lote_mens_w and coalesce(a.ie_cancelamento::text, '') = '' and a.nr_seq_pagador not in (	SELECT	nr_seq_pagador
					from	pls_mensalidade
					where	nr_seq_lote = nr_seq_lote_mens_ant_w
					and	coalesce(ie_cancelamento::text, '') = '');


BEGIN

delete from w_pls_desconto_folha; /* Deletar todos os registros da tabela temporária */
open C01;
loop
fetch C01 into
	dt_mens_atual_w,
	nr_seq_empresa_w,
	nr_seq_lote_mens_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	select	max(a.nr_sequencia)
	into STRICT	nr_seq_lote_mens_ant_w
	from	pls_lote_mensalidade a,
		pls_mensalidade b
	where	a.nr_sequencia		= b.nr_seq_lote
	and	a.nr_seq_empresa	= nr_seq_empresa_w
	and	a.dt_mesano_referencia	= (	SELECT	max(dt_mesano_referencia)
						from	pls_lote_mensalidade
						where	dt_mesano_referencia < dt_mens_atual_w
						and	nr_seq_empresa	= nr_seq_empresa_w)
	and	(nr_seq_lote_mens_w IS NOT NULL AND nr_seq_lote_mens_w::text <> '');
	--and	(a.nr_sequencia	< nr_seq_lote_mens_w
	--	or nr_seq_lote_mens_w is null);
	if (coalesce(nr_seq_lote_mens_ant_w,0) <> 0) then
		open C02;
		loop
		fetch C02 into
			nr_seq_pagador_w,
			vl_mens_ant_w,
			dt_mens_ant_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin

			select	max(a.vl_mensalidade),
				max(a.dt_referencia),
				max(c.nr_titulo)
			into STRICT	vl_mens_atual_w,
				dt_referencia_w,
				nr_titulo_w
			FROM pls_lote_mensalidade b, pls_mensalidade a
LEFT OUTER JOIN titulo_receber c ON (a.nr_sequencia = c.nr_seq_mensalidade)
WHERE a.nr_seq_lote		= b.nr_sequencia and a.nr_seq_pagador	= nr_seq_pagador_w and a.nr_seq_lote		= nr_seq_lote_mens_w;

			if (coalesce(nr_titulo_w::text, '') = '') then
				select	max(b.nr_titulo)
				into STRICT	nr_titulo_w
				from	pls_mensalidade	a,
					titulo_receber	b
				where	b.nr_seq_mensalidade	= a.nr_sequencia
				and	a.nr_seq_pagador	= nr_seq_pagador_w
				and	a.nr_seq_lote	= nr_seq_lote_mens_ant_w;
			end if;

			begin
			select	max(d.nr_seq_reajuste)
			into STRICT	nr_seq_reajuste_ant_w
			from	pls_reajuste_preco d,
				pls_mensalidade_segurado c,
				pls_mensalidade b,
				pls_lote_mensalidade a
			where	c.nr_seq_mensalidade	= b.nr_sequencia
			and	b.nr_seq_lote		= a.nr_sequencia
			and	c.nr_seq_reajuste	= d.nr_sequencia
			and	a.nr_sequencia		= nr_seq_lote_mens_ant_w
			and	b.nr_seq_pagador	= nr_seq_pagador_w;
			exception
			when others then
				nr_seq_reajuste_ant_w	:= -1;
			end;

			begin
			select	max(d.nr_seq_reajuste)
			into STRICT	nr_seq_reajuste_atual_w
			from	pls_reajuste_preco d,
				pls_mensalidade_segurado c,
				pls_mensalidade b,
				pls_lote_mensalidade a
			where	c.nr_seq_mensalidade	= b.nr_sequencia
			and	b.nr_seq_lote		= a.nr_sequencia
			and	c.nr_seq_reajuste	= d.nr_sequencia
			and	a.nr_sequencia		= nr_seq_lote_mens_w
			and	b.nr_seq_pagador	= nr_seq_pagador_w;
			exception
			when others then
				nr_seq_reajuste_atual_w	:= -1;
			end;

			if	((coalesce(vl_mens_ant_w,0) <> 0) and (coalesce(vl_mens_atual_w,0) = 0)) then
				ie_tipo_alteracao_w	:= 'E'; /* Exclusão */
			elsif	((coalesce(vl_mens_ant_w,0) <> 0) and (coalesce(vl_mens_atual_w,0) <> 0)) then
				/*if	(nvl(nr_seq_reajuste_atual_w,0) <> nvl(nr_seq_reajuste_ant_w,0)) then
					begin
					select	tx_reajuste
					into	tx_reajuste_w
					from	pls_reajuste
					where	nr_sequencia	= nr_seq_reajuste_atual_w;
					exception
					when others then
						tx_reajuste_w	:= 0;
					end;

					--if	(tx_reajuste_w > 0) then
					--	vl_mens_ant_w	:= vl_mens_ant_w + trunc((vl_mens_ant_w * (tx_reajuste_w/100)),2);
					--end if;
				end if;*/
				ie_tipo_alteracao_w	:= 'A'; /* Alteração */
			elsif	((coalesce(vl_mens_ant_w,0) = 0) and (coalesce(vl_mens_atual_w,0) <> 0)) then
				ie_tipo_alteracao_w	:= 'I'; /* Inclusão */
			end if;

			if (coalesce(vl_mens_atual_w,0) <> coalesce(vl_mens_ant_w,0)) then
				select	max(cd_matricula)
				into STRICT	cd_matricula_w
				from	pls_contrato_pagador_fin
				where	nr_seq_pagador	= nr_seq_pagador_w
				and	trunc(dt_mens_atual_w, 'mm') between coalesce(dt_inicio_vigencia,dt_mens_atual_w) and coalesce(dt_fim_vigencia,dt_mens_atual_w);

				if (coalesce(cd_matricula_w::text, '') = '') then
					select	max(cd_matricula)
					into STRICT	cd_matricula_w
					from	pls_contrato_pagador_fin
					where	nr_seq_pagador	= nr_seq_pagador_w
					and	trunc(dt_mens_ant_w,'month') between trunc(dt_inicio_vigencia,'dd') and fim_dia(coalesce(dt_fim_vigencia,dt_mens_ant_w));
				end if;

				vl_excluir_ww	:= vl_mens_ant_w;

				/*if	(ie_tipo_alteracao_w = 'E') then
					begin
					select	max(a.nr_sequencia)
					into	nr_seq_reajuste_w
					from	pls_reajuste a,
						pls_contrato b,
						pls_contrato_pagador c
					where	a.nr_seq_contrato	= b.nr_sequencia
					and	b.nr_sequencia		= c.nr_seq_contrato
					and	c.nr_sequencia		= nr_seq_pagador_w
					and	a.ie_status		= '2'
					and	a.dt_reajuste = (select	max(x.dt_reajuste)
								from	pls_reajuste x,
									pls_contrato y,
									pls_contrato_pagador z
								where	x.nr_seq_contrato	= y.nr_sequencia
								and	y.nr_sequencia		= z.nr_seq_contrato
								and	x.ie_status		= '2'
								and	z.nr_sequencia		= nr_seq_pagador_w
								and	x.dt_reajuste		< dt_mens_atual_w);
					exception
					when others then
						nr_seq_reajuste_w	:= -1;
					end;

					if	(nr_seq_reajuste_w > -1) and
						(nr_seq_reajuste_w <> nvl(nr_seq_reajuste_ant_w,0)) then
						select	tx_reajuste
						into	tx_reajuste_w
						from	pls_reajuste
						where	nr_sequencia	= nr_seq_reajuste_w;

						if	(tx_reajuste_w > 0) then
							vl_excluir_ww	:= vl_mens_ant_w + trunc((vl_mens_ant_w * (tx_reajuste_w/100)),2);
						end if;
					end if;
				end if;*/
				if (coalesce(vl_excluir_ww,0) > 0) then
					insert	into	w_pls_desconto_folha(nr_sequencia, dt_atualizacao, nm_usuario,
							dt_atualizacao_nrec, nm_usuario_nrec, cd_matricula,
							vl_incluir, vl_excluir, nr_seq_lote_mensalidade,
							nr_seq_pagador, dt_competencia, nr_titulo,
							ie_tipo_alteracao)
						values (nextval('w_pls_desconto_folha_seq'), clock_timestamp(), nm_usuario_p,
							clock_timestamp(), nm_usuario_p, cd_matricula_w,
							0, vl_excluir_ww, nr_seq_lote_mens_w,
							nr_seq_pagador_w, dt_referencia_w, nr_titulo_w,
							ie_tipo_alteracao_w);
				end if;

				if (coalesce(vl_mens_atual_w,0) <> 0) then
					insert	into	w_pls_desconto_folha(nr_sequencia, dt_atualizacao, nm_usuario,
							dt_atualizacao_nrec, nm_usuario_nrec, cd_matricula,
							vl_incluir, vl_excluir, nr_seq_lote_mensalidade,
							nr_seq_pagador, dt_competencia, nr_titulo,
							ie_tipo_alteracao)
						values (nextval('w_pls_desconto_folha_seq'), clock_timestamp(), nm_usuario_p,
							clock_timestamp(), nm_usuario_p, cd_matricula_w,
							vl_mens_atual_w, 0, nr_seq_lote_mens_w,
							nr_seq_pagador_w, dt_referencia_w, nr_titulo_w,
							ie_tipo_alteracao_w);
				end if;
			else
				ie_tipo_alteracao_w	:= 'O';
				select	max(nr_sequencia)
				into STRICT	nr_seq_pagador_fin_ant_w
				from	pls_contrato_pagador_fin
				where	nr_seq_pagador	= nr_seq_pagador_w
				and	trunc(dt_mens_ant_w, 'mm') between coalesce(dt_inicio_vigencia,dt_mens_ant_w) and coalesce(dt_fim_vigencia,dt_mens_ant_w);


				select	max(nr_sequencia)
				into STRICT	nr_seq_pagador_fin_atual_w
				from	pls_contrato_pagador_fin
				where	nr_seq_pagador	= nr_seq_pagador_w
				and	trunc(dt_mens_atual_w, 'mm') between coalesce(dt_inicio_vigencia,dt_mens_atual_w) and coalesce(dt_fim_vigencia,dt_mens_atual_w);

				if (coalesce(nr_seq_pagador_fin_ant_w,0) <> coalesce(nr_seq_pagador_fin_atual_w,0)) then
					if (coalesce(vl_mens_ant_w,0) <> 0) then
						select	max(cd_matricula)
						into STRICT	cd_matricula_w
						from	pls_contrato_pagador_fin
						where	nr_sequencia	= nr_seq_pagador_fin_ant_w;

						insert	into	w_pls_desconto_folha(nr_sequencia, dt_atualizacao, nm_usuario,
								dt_atualizacao_nrec, nm_usuario_nrec, cd_matricula,
								vl_incluir, vl_excluir, nr_seq_lote_mensalidade,
								nr_seq_pagador, dt_competencia, nr_titulo,
								ie_tipo_alteracao)
							values (nextval('w_pls_desconto_folha_seq'), clock_timestamp(), nm_usuario_p,
								clock_timestamp(), nm_usuario_p, cd_matricula_w,
								0, vl_mens_ant_w, nr_seq_lote_mens_w,
								nr_seq_pagador_w, dt_referencia_w, nr_titulo_w,
								ie_tipo_alteracao_w);
					end if;

					if (coalesce(vl_mens_atual_w,0) <> 0) then
						select	max(cd_matricula)
						into STRICT	cd_matricula_w
						from	pls_contrato_pagador_fin
						where	nr_sequencia	= nr_seq_pagador_fin_atual_w;

						insert	into	w_pls_desconto_folha(nr_sequencia, dt_atualizacao, nm_usuario,
								dt_atualizacao_nrec, nm_usuario_nrec, cd_matricula,
								vl_incluir, vl_excluir, nr_seq_lote_mensalidade,
								nr_seq_pagador, dt_competencia, nr_titulo,
								ie_tipo_alteracao)
							values (nextval('w_pls_desconto_folha_seq'), clock_timestamp(), nm_usuario_p,
								clock_timestamp(), nm_usuario_p, cd_matricula_w,
								vl_mens_atual_w, 0, nr_seq_lote_mens_w,
								nr_seq_pagador_w, dt_referencia_w, nr_titulo_w,
								ie_tipo_alteracao_w);
					end if;
				end if;
			end if;
			end;
		end loop;
		close C02;
	elsif (coalesce(nr_seq_lote_mens_ant_w,0) = 0) then
		ie_tipo_alteracao_w	:= 'I';
		open C03;
		loop
		fetch C03 into
			nr_seq_pagador_w,
			vl_mens_atual_w,
			dt_referencia_w,
			nr_titulo_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
			begin
			vl_incluir_w	:= vl_mens_atual_w;
			vl_excluir_w	:= 0;

			select	max(cd_matricula)
			into STRICT	cd_matricula_w
			from	pls_contrato_pagador_fin
			where	nr_seq_pagador	= nr_seq_pagador_w
			and	trunc(dt_mens_atual_w, 'mm') between coalesce(dt_inicio_vigencia,dt_mens_atual_w) and coalesce(dt_fim_vigencia,dt_mens_atual_w);

			insert	into	w_pls_desconto_folha(nr_sequencia, dt_atualizacao, nm_usuario,
					dt_atualizacao_nrec, nm_usuario_nrec, cd_matricula,
					vl_incluir, vl_excluir, nr_seq_lote_mensalidade,
					nr_seq_pagador, dt_competencia, nr_titulo,
					ie_tipo_alteracao)
				values (nextval('w_pls_desconto_folha_seq'), clock_timestamp(), nm_usuario_p,
					clock_timestamp(), nm_usuario_p, cd_matricula_w,
					vl_incluir_w, vl_excluir_w, nr_seq_lote_mens_w,
					nr_seq_pagador_w, dt_referencia_w, nr_titulo_w,
					ie_tipo_alteracao_w);
			end;
		end loop;
		close C03;
	end if;

	ie_tipo_alteracao_w	:= 'I';
	open C04;
	loop
	fetch C04 into
		nr_seq_pagador_w,
		vl_mens_atual_w,
		dt_referencia_w,
		nr_titulo_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
		begin
		vl_incluir_w	:= vl_mens_atual_w;
		vl_excluir_w	:= 0;

		select	max(cd_matricula)
		into STRICT	cd_matricula_w
		from	pls_contrato_pagador_fin
		where	nr_seq_pagador	= nr_seq_pagador_w
		and	trunc(dt_mens_atual_w, 'mm') between coalesce(dt_inicio_vigencia,dt_mens_atual_w) and coalesce(dt_fim_vigencia,dt_mens_atual_w);

		insert	into	w_pls_desconto_folha(nr_sequencia, dt_atualizacao, nm_usuario,
				dt_atualizacao_nrec, nm_usuario_nrec, cd_matricula,
				vl_incluir, vl_excluir, nr_seq_lote_mensalidade,
				nr_seq_pagador, dt_competencia, nr_titulo,
				ie_tipo_alteracao)
			values (nextval('w_pls_desconto_folha_seq'), clock_timestamp(), nm_usuario_p,
				clock_timestamp(), nm_usuario_p, cd_matricula_w,
				vl_incluir_w, vl_excluir_w, nr_seq_lote_mens_w,
				nr_seq_pagador_w, dt_referencia_w, nr_titulo_w,
				ie_tipo_alteracao_w);
		end;
	end loop;
	close C04;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_interface_desc_folha_pdf ( nr_seq_lote_p bigint, dt_referencia_p text, nm_usuario_p text) FROM PUBLIC;

