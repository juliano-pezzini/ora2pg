-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_altera_status_protocolo ( nr_seq_protocolo_p bigint, ie_tipo_liberacao_p text, ie_commit_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

/* IE_TIPO_LIBERACAO_P
	F - Fechamento do protocolo
	C - Fechamento da conta
	L - Liberação do item
	P - Fechamento do protocolo (Liberar para pagamneto) OS 787434
*/
vl_total_protocolo_w		double precision;
qt_conta_w			bigint;
qt_conta_liberada_w		bigint;
qt_conta_consistida_w		bigint;
dt_mesano_referencia_w		timestamp;
dt_mesano_referencia_dd_w	timestamp;
dt_mesano_recebimento_w		timestamp;
ie_mes_fechado_w		varchar(1);
ie_tipo_data_pagamento_w	varchar(10);
dt_competencia_pgto_w		timestamp;
nr_seq_fatura_w			bigint;
ie_tipo_protocolo_w		varchar(3);
ie_importando_protocolo_w	varchar(1)	:= 'N';
ie_forma_imp_w			varchar(3);
dt_integracao_w			timestamp;
dt_fim_analise_w		timestamp;
vl_pagamento_w			double precision;
vl_liberado_w			double precision;
ie_atualizar_grupo_ans_w	varchar(1);
qt_vago_w			bigint	:= 0;
qt_contas_canceladas_w		bigint;
ie_status_protocolo_w		pls_protocolo_conta.ie_status%type;
nr_seq_lote_conta_w		pls_protocolo_conta.nr_seq_lote_conta%type;
ds_motivo_canc_w		pls_protocolo_conta.ds_motivo_canc%type;
qt_protocolos_lote_w		bigint;
qt_tot_conta_w			integer;
ie_atualiza_contab_lib_w	varchar(2);


BEGIN

select	ie_forma_imp,
	dt_integracao,
	dt_fim_analise,
	ie_tipo_protocolo,
	nr_seq_lote_conta
into STRICT	ie_forma_imp_w,
	dt_integracao_w,
	dt_fim_analise_w,
	ie_tipo_protocolo_w,
	nr_seq_lote_conta_w
from	pls_protocolo_conta a
where	a.nr_sequencia	= nr_seq_protocolo_p;

/* Francisco - 21/05/2012 - Na importação, só atualizar status no final */

/*if	(ie_forma_imp_w = 'P') and
	(dt_integracao_w is not null) and
	(dt_fim_analise_w is null) then*/
	ie_importando_protocolo_w	:= 'N';
--end if;
if (coalesce(nr_seq_protocolo_p,0) <> 0) then
	select	count(1)
	into STRICT	qt_conta_consistida_W
	from	pls_conta
	where	nr_seq_protocolo	= nr_seq_protocolo_p
	and	ie_status		in ('P','L','A');

	select	count(1)
	into STRICT	qt_conta_liberada_W
	from	pls_conta
	where	nr_seq_protocolo	= nr_seq_protocolo_p
	and	ie_status		in ('F','C');

	select	count(1)
	into STRICT	qt_conta_W
	from	pls_conta
	where	nr_seq_protocolo	= nr_seq_protocolo_p;

	if (qt_conta_W = 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(174118);/*'Protocolo sem contas. Verifique!*/
	end if;

	if (qt_conta_liberada_w = qt_conta_W) then
		select	sum(vl_total)
		into STRICT	vl_total_protocolo_w
		from	pls_conta
		where	nr_seq_protocolo	= nr_seq_protocolo_p
		and	(vl_total IS NOT NULL AND vl_total::text <> '');

		begin
		select	coalesce(ie_atualizar_grupo_ans,'S')
		into STRICT	ie_atualizar_grupo_ans_w
		from	table(pls_parametros_pck.f_retorna_param(cd_estabelecimento_p));
		exception
		when others then
			ie_atualizar_grupo_ans_w	:= 'S';
		end;

		if (ie_atualizar_grupo_ans_w = 'S') then
			--alterado na rotina para verificar o grupo ans antes de verificar o valor.
			CALL pls_atualizar_grupo_ans_conta(nr_seq_protocolo_p, 'N', null, null,'N',nm_usuario_p,cd_estabelecimento_p, null);
		end if;

		if (ie_tipo_liberacao_p in ('F','P')) then
			select	trunc(dt_mes_competencia,'month'),
				trunc(dt_recebimento,'dd'),
				dt_mes_competencia
			into STRICT	dt_mesano_referencia_w,
				dt_mesano_recebimento_w,
				dt_mesano_referencia_dd_w
			from	pls_protocolo_conta
			where	nr_sequencia	= nr_seq_protocolo_p;

			if (ie_tipo_liberacao_p	= 'F') then
				ie_mes_fechado_w :=	pls_obter_se_mes_fechado(dt_mesano_referencia_w,'T', cd_estabelecimento_p);

				if (ie_mes_fechado_w = 'S') then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(174126);--'Não é possível realizar esta operação pois o mês de competência ou a contabilidade do mês está fechada!
				end if;
			end if;

			select	coalesce(sum(a.vl_lib_original),0)
			into STRICT	vl_pagamento_w
			from	pls_conta_medica_resumo	a
			where	a.nr_seq_conta in ( SELECT 	b.nr_sequencia
							  from		pls_conta b
							  where		b.nr_seq_protocolo = nr_seq_protocolo_p)
			and	a.ie_tipo_item 	<> 'I'  --retira itens de intercâmbio da soma
			and	a.vl_lib_original > 0
			and	a.ie_situacao = 'A';

			if (coalesce(vl_total_protocolo_w,0) <> coalesce(vl_pagamento_w,0)) and (ie_tipo_protocolo_w 	= 'C') then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(225847);--Não é possível liberar o protocolo para pagamento, pois existe dive
			end if;
			CALL pls_atualizar_codificacao_pck.pls_atualizar_codificacao(dt_mesano_referencia_w);

			if (vl_total_protocolo_w = 0) then
				update	pls_protocolo_conta
				set	ie_status		= '4',
					dt_lib_pagamento	= clock_timestamp(), -- OS 1289527 - Como protocolos 'Encerrado sem pagamento' também devem entrar em pagamento então esta data deve ser preenchida.
					dt_atualizacao		= clock_timestamp(),
					nm_usuario		= nm_usuario_p
				where	nr_sequencia		= nr_seq_protocolo_p
				and	ie_status		not in ('7','6');

				update	pls_conta_medica_resumo
				set	ie_status_protocolo 	= '4',
					dt_atualizacao		= clock_timestamp(),
					nm_usuario		= nm_usuario_p
				where	nr_seq_protocolo	= nr_seq_protocolo_p
				and	ie_situacao		= 'A';

				if (ie_tipo_protocolo_w = 'R') then
					CALL pls_gerar_comunic_reemb(1,'O protocolo de reembolso ' || nr_seq_protocolo_p || ' está encerrado sem pagamento.', nr_seq_protocolo_p, nm_usuario_p, cd_estabelecimento_p);

					-- jtonon - OS 1108463 - Envio de alerta SMS/Email para o beneficiário
					pls_gerar_alerta_rembolso_lib(6, nr_seq_protocolo_p, '4', nm_usuario_p);
				end if;

			else
				update	pls_protocolo_conta
				set	ie_status		= '3',
					dt_lib_pagamento	= clock_timestamp(),
					dt_atualizacao		= clock_timestamp(),
					nm_usuario		= nm_usuario_p
				where	nr_sequencia		= nr_seq_protocolo_p
				and	ie_status		not in ('7','6');

				if (ie_tipo_protocolo_w = 'R') then
					CALL pls_gerar_comunic_reemb(1,'O protocolo de reembolso ' || nr_seq_protocolo_p || ' está liberado para pagamento.', nr_seq_protocolo_p, nm_usuario_p, cd_estabelecimento_p);

					-- jtonon - OS 1108463 - Envio de alerta SMS/Email para o beneficiário
					pls_gerar_alerta_rembolso_lib(6, nr_seq_protocolo_p, '3', nm_usuario_p);
				end if;

				select	coalesce(ie_atualiza_contab_lib,'N')
				into STRICT	ie_atualiza_contab_lib_w
				from	pls_parametros
				where	cd_estabelecimento = cd_estabelecimento_p;

				if (ie_tipo_liberacao_p = 'F') or (ie_atualiza_contab_lib_w = 'S') then  /*OS 787434  a liberação para pagamento não altera a contabilização pois a provisão ocorre na data de recebimento*/
					CALL pls_atualizar_contas_protocolo(nr_seq_protocolo_p, nm_usuario_p, cd_estabelecimento_p,'N'); /* Atualizar contas contábeis */
				--ctb_pls_atualizar_conta(nr_seq_protocolo_p, nm_usuario_p, cd_estabelecimento_p);
				end if;


				if (ie_tipo_protocolo_w = 'I') then
					qt_vago_w := ctb_pls_atualizar_desp_interc(nr_seq_protocolo_p, null, null, null, null, nm_usuario_p, cd_estabelecimento_p, qt_vago_w);
				end if;

				/* Verificar se o pagamento é gerado pela data MÊS COMPETÊNCIA, LIBERAÇÃO PAGAMENTO ou RECEBIMENTO do protocolo */

				select	coalesce(max(ie_tipo_data_pagamento),'M')
				into STRICT	ie_tipo_data_pagamento_w
				from	pls_parametro_pagamento
				where	cd_estabelecimento	= cd_estabelecimento_p;

				if (ie_tipo_data_pagamento_w	= 'M') then
					dt_competencia_pgto_w		:= dt_mesano_referencia_dd_w;
				elsif (ie_tipo_data_pagamento_w	= 'P') then
					dt_competencia_pgto_w		:= clock_timestamp();
				elsif (ie_tipo_data_pagamento_w	= 'R') then
					dt_competencia_pgto_w		:= dt_mesano_recebimento_w;
				end if;

				/* Felipe - 15/06/2011 - Se a forma de pagamento for por protocolo então atualiza a data de pagamento */

				update	pls_conta_medica_resumo
				set	ie_status_protocolo 	= '3',
					dt_competencia_pgto	= dt_competencia_pgto_w,
					dt_atualizacao		= clock_timestamp(),
					nm_usuario		= nm_usuario_p,
					ie_tipo_data_pagamento	= ie_tipo_data_pagamento_w
				where	nr_seq_protocolo	= nr_seq_protocolo_p
				and	coalesce(nr_seq_lote_pgto::text, '') = ''
				and	ie_situacao		= 'A';
			end if;

			/* FELIPE - 15/02/2011 - OS 283335 - Utilizar a rotina PLS_GERAR_SIP_CONTA que é chamada na PLS_CONSISTIR_CONTA
			pls_gerar_protocolo_sip(nr_seq_protocolo_p, nm_usuario_p, cd_estabelecimento_p);*/
			if (ie_tipo_protocolo_w <> 'R') then
				CALL pls_gerar_comunic_conta(2,'O protocolo ' || nr_seq_protocolo_p || ' está liberado.',
						nm_usuario_p,cd_estabelecimento_p);
			end if;

			--Protocolo liberado para pagamento
			CALL pls_inclui_prot_conta_hist(nr_seq_protocolo_p, wheb_mensagem_pck.get_texto(315921), nm_usuario_p, '11');

		elsif (ie_tipo_liberacao_p in ('L','C')) then

			select	count(1)
			into STRICT	qt_contas_canceladas_w
			from	pls_conta
			where	nr_seq_protocolo	= nr_seq_protocolo_p
			and	ie_status		= 'C';

			select	count(1)
			into STRICT	qt_tot_conta_w
			from	pls_conta
			where	nr_seq_protocolo	= nr_seq_protocolo_p;

			ie_status_protocolo_w	:= '5';
			ds_motivo_canc_w	:= '';

			--aaschlote 22/04/2015 OS 859396
			if (qt_tot_conta_w = qt_contas_canceladas_w) and (qt_contas_canceladas_w	> 0) then
				ds_motivo_canc_w	:= 'Cancelamento efeutado pelo sistema, pois todas as contas no protocolo foram canceladas';
				ie_status_protocolo_w	:= '4';
			end if;

			update	pls_protocolo_conta
			set	ie_status		= ie_status_protocolo_w,
				dt_fechamento_contas	= clock_timestamp(),
				dt_atualizacao		= clock_timestamp(),
				nm_usuario		= nm_usuario_p,
				ds_motivo_canc		= ds_motivo_canc_w
			where	nr_sequencia		= nr_seq_protocolo_p
			and	ie_status		not in ('7','6');

			--aaschlote 22/04/2015 OS 859396 - Cancelar o protocolo caso tenha apenas 1 conta como cancelada dentro dela
			if (nr_seq_lote_conta_w IS NOT NULL AND nr_seq_lote_conta_w::text <> '') and (ie_status_protocolo_w = '4') then
				select	count(1)
				into STRICT	qt_protocolos_lote_w
				from	pls_protocolo_conta
				where	nr_seq_lote_conta	= nr_seq_lote_conta_w;

				if (qt_protocolos_lote_w = 1) then
					update	pls_lote_protocolo_conta
					set	ie_status 		= 'C',
						ds_motivo_cancelamento	= ds_motivo_canc_w,
						dt_atualizacao		= clock_timestamp(),
						nm_usuario		= nm_usuario_p
					where	nr_sequencia 		= nr_seq_lote_conta_w;
				end if;
			end if;

			select	max(nr_sequencia)
			into STRICT	nr_seq_fatura_w
			from	ptu_fatura
			where	nr_seq_protocolo	= nr_seq_protocolo_p
			and	ie_status	not in ('CA','R');

			if (nr_seq_fatura_w IS NOT NULL AND nr_seq_fatura_w::text <> '') then
				CALL ptu_atualizar_status_fatura(nr_seq_fatura_w, 'AF', null, nm_usuario_p);
			end if;

			update	pls_conta_medica_resumo
			set	ie_status_protocolo 	= ie_status_protocolo_w,
				dt_atualizacao		= clock_timestamp(),
				nm_usuario		= nm_usuario_p
			where	nr_seq_protocolo	= nr_seq_protocolo_p
			and	ie_situacao		= 'A';
			--Conforme tratado com Leandro na liberação do protocolo não é necessária esta tratativa devido a estas contas não serem contabilizadas
			--pls_atualizar_contas_protocolo(nr_seq_protocolo_p, nm_usuario_p, cd_estabelecimento_p,'N'); /* Atualizar contas contábeis */
		end if;
	elsif (qt_conta_consistida_w > 0) then
		update	pls_protocolo_conta
		set	ie_status		= '2',
			dt_fechamento_contas	 = NULL,
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p
		where	nr_sequencia		= nr_seq_protocolo_p
		and	ie_status		not in ('7','6')
		and   	((ie_situacao	!= 'I') or (coalesce(ie_protocolo_compl::text, '') = '' or ie_protocolo_compl != 'S'));
	elsif (qt_conta_liberada_w = 0) then
		update	pls_protocolo_conta
		set	ie_status		= '1',
			dt_fechamento_contas	 = NULL,
			dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p
		where	nr_sequencia		= nr_seq_protocolo_p
		and	ie_status		not in ('7','6');
	end if;
end if;

/* William - OS 405855 - Adicionado ie_commit_p */

if (coalesce(ie_commit_p,'S') = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_altera_status_protocolo ( nr_seq_protocolo_p bigint, ie_tipo_liberacao_p text, ie_commit_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

