-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_ocorrencia_diagnostico ( nr_atendimento_p bigint, ie_tipo_diagnostico_p bigint, ds_diagnostico_p text, nm_usuario_p text, cd_cid_doenca_p text) AS $body$
DECLARE


dt_diagnostico_w		diagnostico_doenca.dt_diagnostico%type;
cd_medico_w				diagnostico_doenca.cd_medico%type;


BEGIN

select max(dt_diagnostico)
into STRICT dt_diagnostico_w
from diagnostico_doenca 
where nr_atendimento = nr_atendimento_p
and cd_doenca = cd_cid_doenca_p;

select max(cd_medico)
into STRICT cd_medico_w
from diagnostico_doenca
where nr_atendimento = nr_atendimento_p
and cd_doenca = cd_cid_doenca_p;

if (dt_diagnostico_w IS NOT NULL AND dt_diagnostico_w::text <> '') and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then

	update  	DIAGNOSTICO_MEDICO
	set		dt_atualizacao			= clock_timestamp(),
				nm_usuario				= nm_usuario_p,
				ds_diagnostico			= ds_diagnostico_p,
				ie_tipo_diagnostico	= ie_tipo_diagnostico_p,
				cd_medico				= cd_medico_w
	where 	nr_atendimento 		= nr_atendimento_p
	and     	dt_diagnostico       = dt_diagnostico_w;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_ocorrencia_diagnostico ( nr_atendimento_p bigint, ie_tipo_diagnostico_p bigint, ds_diagnostico_p text, nm_usuario_p text, cd_cid_doenca_p text) FROM PUBLIC;

