-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cf_altera_estagio_pendencia ( nr_seq_pend_p bigint, nr_seq_estagio_novo_p bigint, ds_historico_p text, nm_usuario_p text) AS $body$
DECLARE

 
qt_total_pend_w			bigint;
qt_pend_fechada_w		bigint;
nr_interno_conta_w		bigint;
nr_seq_status_fat_w		bigint;
nr_seq_regra_fluxo_w	bigint;
nr_seq_regra_estagio_w	bigint;
nr_seq_status_fat_ant_w	bigint;
ie_pendencia_w			varchar(1);
ds_estagio_w			varchar(120);
ds_classificacao_w		varchar(120);
ds_status_fat_w			varchar(80);
nr_seq_regra_resp_w		bigint;
nr_seq_status_mob_w		conta_paciente.nr_seq_status_mob%type;
				

BEGIN 
 
select 	max(nr_interno_conta) 
into STRICT	nr_interno_conta_w 
from 	cta_pendencia 
where 	nr_sequencia = nr_seq_pend_p;
 
CALL cta_alterar_estagio_pend(nr_seq_pend_p, nr_seq_estagio_novo_p, ds_historico_p, nm_usuario_p);
 
select 	count(*), 
		sum(CASE WHEN coalesce(dt_fechamento::text, '') = '' THEN 0  ELSE 1 END ) 
into STRICT	qt_total_pend_w, 
		qt_pend_fechada_w 
from	cta_pendencia 
where	nr_interno_conta = nr_interno_conta_w;
 
select 	max(nr_seq_regra_resp) 
into STRICT	nr_seq_regra_resp_w 
from	cta_pendencia 
where	nr_interno_conta = nr_interno_conta_w 
and 	coalesce(dt_fechamento::text, '') = '';
 
if (qt_total_pend_w = qt_pend_fechada_w) then	 
	 
	select	max(nr_seq_status_fat), 
			max(nr_seq_regra_fluxo) 
	into STRICT	nr_seq_status_fat_w, 
			nr_seq_regra_fluxo_w 
	from	conta_paciente 
	where	nr_interno_conta = nr_interno_conta_w;
	 
	select	max(ie_pendencia) 
	into STRICT	ie_pendencia_w 
	from	cf_status_faturamento 
	where	nr_sequencia = nr_seq_status_fat_w;
	 
	if (ie_pendencia_w IS NOT NULL AND ie_pendencia_w::text <> '') then 
	 
		select 	max(nr_sequencia) 
		into STRICT	nr_seq_regra_estagio_w 
		from	cf_regra_estagio 
		where 	nr_seq_regra = nr_seq_regra_fluxo_w 
		and		ie_pendencia = ie_pendencia_w;
	else 
		select 	max(nr_sequencia) 
		into STRICT	nr_seq_regra_estagio_w 
		from	cf_regra_estagio 
		where 	nr_seq_regra = nr_seq_regra_fluxo_w 
		and		coalesce(ie_pendencia::text, '') = '';
	end if;
	 
	select	max(nr_seq_status_fat) 
	into STRICT	nr_seq_status_fat_ant_w 
	from	cf_regra_estagio 
	where	nr_sequencia = nr_seq_regra_estagio_w;	
			 
	select	max(ds_regra) 
	into STRICT	ds_classificacao_w 
	from	cta_regra_resp_pend 
	where	nr_sequencia = nr_seq_regra_resp_w;
	 
	select	max(ds_status_fat) 
	into STRICT	ds_status_fat_w 
	from	cf_status_faturamento 
	where	nr_sequencia = nr_seq_status_fat_ant_w;
	 
	--ds_estagio_w		:= 'PendÃªncia Resolvida';	 
	ds_estagio_w		:= WHEB_MENSAGEM_PCK.get_texto(297982);	
 
	 
	delete	from w_cf_consulta_guia 
	where	nr_interno_conta = nr_interno_conta_w 
	and 	nm_usuario = nm_usuario_p;
	 
	nr_seq_status_mob_w := cf_obter_status_mob(nr_seq_status_fat_w, 'C');
	 
	update	conta_paciente 
	set		nr_seq_status_fat = nr_seq_status_fat_ant_w, 
			nr_seq_status_mob = coalesce(nr_seq_status_mob_w, nr_seq_status_mob), 
			nm_usuario = nm_usuario_p 
	where	nr_interno_conta = nr_interno_conta_w;	
	 
	commit;
	 
end	if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cf_altera_estagio_pendencia ( nr_seq_pend_p bigint, nr_seq_estagio_novo_p bigint, ds_historico_p text, nm_usuario_p text) FROM PUBLIC;

