-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_atualizar_enferm_farm ( nr_prescricao_p bigint, nm_usuario_lib_p text, ie_enfer_farm_p text, cd_pessoa_fisica_p bigint default null) AS $body$
DECLARE



nr_seq_solucao_w			prescr_solucao.nr_seq_solucao%type;
cd_estabelecimento_w		prescr_medica.cd_estabelecimento%type;
hr_prim_horario_w			prescr_material.hr_prim_horario%type;
ds_horarios_ww        		prescr_material.ds_horarios%TYPE;
ds_hor_precr_proc_w      	prescr_material.ds_horarios%TYPE;
ds_horarios_w        		prescr_material.ds_horarios%type;
dt_inicio_medic_w      		prescr_material.dt_inicio_medic%type;
dt_inicio_medic_w2      	prescr_material.dt_inicio_medic%type;
qt_dia_prim_hor_w      		prescr_material.qt_dia_prim_hor%type;
hr_dose_especial_w      	prescr_material.hr_dose_especial%type;
qt_dose_especial_w      	prescr_material.qt_dose_especial%type;
ie_via_aplicacao_w      	prescr_material.ie_via_aplicacao%type;
ie_medicacao_paciente_w    	prescr_material.ie_medicacao_paciente%type;
ie_dose_espec_agora_w    	prescr_material.ie_dose_espec_agora%type;
qt_min_aplic_dose_esp_w    	prescr_material.qt_min_aplic_dose_esp%type;
nr_ocorrencia_w        		prescr_material.nr_ocorrencia%TYPE;
cd_material_w        		prescr_material.cd_material%type;
ds_horarios_medico_w    	prescr_material.ds_horarios_medico%type;
ds_dose_diferenciada_w    	prescr_material.ds_dose_diferenciada%type;
ds_observacao_far_w			prescr_material.ds_observacao_far%type;
ds_observacao_enf_w			prescr_material.ds_observacao_enf%type;
ds_horarios_enf_w      		prescr_material_compl.ds_horario_enf%type;
cd_intervalo_w        		cpoe_material.cd_intervalo%TYPE;
nr_atendimento_w      		cpoe_material.nr_atendimento%TYPE;
dt_inicio_hor_w        		cpoe_material.dt_inicio%type;
qt_min_intervalo_w      	intervalo_prescricao.qt_min_intervalo%TYPE;
dt_prim_horario_w      		cpoe_material.dt_inicio%type;
ie_controle_tempo_w      	cpoe_material.ie_controle_tempo%type;
nr_seq_proc_interno_w    	prescr_procedimento.nr_seq_proc_interno%TYPE;
dt_prev_execucao_w      	prescr_procedimento.dt_prev_execucao%type;
dt_validade_prescr_w		prescr_medica.dt_validade_prescr%type;
hr_prim_horario_ww    		prescr_material.hr_prim_horario%type;
hr_prim_ds_horarios_w		prescr_material.hr_prim_horario%type;
dt_inicio_prescr_w			prescr_medica.dt_inicio_prescr%type;
qt_hora_fase_w				cpoe_gasoterapia.qt_hora_fase%type;
ie_modo_adm_w				cpoe_gasoterapia.ie_modo_adm%type;
nr_seq_cpoe_w    			bigint;
ie_tipo_item_w    			varchar(10);
nr_sequencia_w    			bigint;
dt_inicio_w      			timestamp;
dt_inicio_item_w     		timestamp;
dt_fim_w      				timestamp;
dt_liberacao_w    			timestamp := clock_timestamp();
dt_lib_parcial_w			timestamp;
qt_tempo_etapa_w			double precision;
ie_continuo_w				char(1);
ie_atualizar_horarios_w		char(1);
ie_acm_sn_w					char(1);
ie_prim_hor_null_w			boolean;
ie_urgencia_w       		char(1);
cd_pessoa_farm_w			cpoe_material.cd_farmac_lib%type;
ie_retrogrado_w       cpoe_recomendacao.ie_retrogrado%type;
dt_lib_enfermagem_w			prescr_material.dt_lib_enfermagem%type;
dt_lib_farmacia_w			prescr_material.dt_lib_farmacia%type;

C01 CURSOR FOR
SELECT	'M' ie_tipo_item,        --Medicamento
		nr_seq_mat_cpoe,
		nr_sequencia,
		dt_lib_enfermagem,
        dt_lib_farmacia
from    prescr_material
where   nr_prescricao = nr_prescricao_p
and     ie_agrupador in (1, 4)

union all

SELECT	'O' ie_tipo_item,        --Oral
		nr_seq_dieta_cpoe,
		nr_sequencia,
		null,
		null
from    prescr_dieta
where   nr_prescricao = nr_prescricao_p

union all

select	'J' ie_tipo_item,        --Jejum
		nr_seq_dieta_cpoe,
		nr_sequencia,
		null,
		null
from    rep_jejum
where   nr_prescricao = nr_prescricao_p

union all

select	'E' ie_tipo_item,        --Enteral
		nr_seq_dieta_cpoe,
		nr_sequencia,
		dt_lib_enfermagem,
        dt_lib_farmacia
from    prescr_material
where   nr_prescricao = nr_prescricao_p
and		ie_agrupador = 8

union all

select	'S' ie_tipo_item,        --Suplemento
		nr_seq_dieta_cpoe,
		nr_sequencia,
		dt_lib_enfermagem,
        dt_lib_farmacia
from    prescr_material
where   nr_prescricao = nr_prescricao_p
and		ie_agrupador = 12

union all

select	'LD' ie_tipo_item,        --Leites e derivados
		nr_seq_dieta_cpoe,
		nr_sequencia,
		null,
		null
from    prescr_leite_deriv
where   nr_prescricao = nr_prescricao_p

union all

select	'PI' ie_tipo_item,        --Parenteral Infantil
		nr_seq_npt_cpoe,
		nr_sequencia,
		null,
		null
from    nut_pac
where   nr_prescricao = nr_prescricao_p
and     ie_npt_adulta = 'P'

union all

select	'PA' ie_tipo_item,        --Parenteral Adulta
		nr_seq_npt_cpoe,
		nr_sequencia,
		null,
		null
from    nut_pac
where   nr_prescricao = nr_prescricao_p
and     ie_npt_adulta = 'S'

union all

select	'R' ie_tipo_item,        --Recomendacao
		nr_seq_rec_cpoe,
		nr_sequencia,
		null,
		null
from    prescr_recomendacao
where   nr_prescricao = nr_prescricao_p

union all

select	'G' ie_tipo_item,        --Gasoterapia
		nr_seq_gas_cpoe,
		nr_sequencia,
		null,
		null
from    prescr_gasoterapia
where   nr_prescricao = nr_prescricao_p

union all

select	'P' ie_tipo_item,        --Procedimento
		nr_seq_proc_cpoe,
		nr_sequencia,
		null,
		null
from    prescr_procedimento
where   nr_prescricao = nr_prescricao_p
and		coalesce(nr_seq_solic_sangue::text, '') = ''
and		Obter_tipo_proc_interno(nr_seq_proc_interno) in ('IVC','O','G','REAB')

union all

select	'D' ie_tipo_item,        --Dialise
		nr_seq_dialise_cpoe,
		nr_sequencia,
		null,
		null
from    hd_prescricao
where   nr_prescricao = nr_prescricao_p

union all

select  'MAT' ie_tipo_item,        --Materiais
		nr_seq_mat_cpoe,
		nr_sequencia,
		dt_lib_enfermagem,
        dt_lib_farmacia
from    prescr_material
where	nr_prescricao = nr_prescricao_p
and		ie_agrupador = 2

union all

select	'H' ie_tipo_item,        --Dialise
		nr_seq_hemo_cpoe,
		nr_sequencia,
		null,
		null
from    prescr_solic_bco_sangue
where   nr_prescricao = nr_prescricao_p

union all

select	'AP' ie_tipo_item,        -- Anatomia Patologica
		nr_seq_proc_cpoe,
		nr_sequencia,
		null,
		null
from    prescr_procedimento
where   nr_prescricao = nr_prescricao_p
and		coalesce(nr_seq_solic_sangue::text, '') = ''
and		Obter_tipo_proc_interno(nr_seq_proc_interno) in ('AP','APC','APH');



BEGIN

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then

	if (upper(ie_enfer_farm_p) = 'ENFERMAGEM')  then

		select  max(dt_liberacao),
				max(nr_atendimento),
				max(cd_estabelecimento),
				max(dt_inicio_prescr),
				max(dt_validade_prescr)
		into STRICT	dt_liberacao_w,
				nr_atendimento_w,
				cd_estabelecimento_w,
				dt_inicio_prescr_w,
				dt_validade_prescr_w
		from	prescr_medica
		where	nr_prescricao = nr_prescricao_p;

		--Atualizar enfermagem
		open C01;
		loop
		fetch C01 into
		  ie_tipo_item_w,
		  nr_seq_cpoe_w,
		  nr_sequencia_w,
		  dt_lib_enfermagem_w,
		  dt_lib_farmacia_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			if (nr_seq_cpoe_w IS NOT NULL AND nr_seq_cpoe_w::text <> '') then
			
				if (ie_tipo_item_w = 'M') then
				
					if (coalesce(nr_seq_cpoe_w,0) > 0) then					
						select  coalesce(max(ie_controle_tempo),'N')
						into STRICT  ie_controle_tempo_w
						from  cpoe_material
						where  nr_sequencia = nr_seq_cpoe_w;
						
						/*Caso modificar lembrar de atualizar na rotina de Farmacia*/

						select	coalesce(max('S'),'N')
						into STRICT	ie_atualizar_horarios_w
						from	prescr_material a
						where  	a.nr_prescricao = nr_prescricao_p
						and		a.nr_sequencia = nr_sequencia_w
						and		a.nr_seq_mat_cpoe = nr_seq_cpoe_w
						and 	coalesce(a.ie_acm, 'N') = 'N'
						and 	coalesce(a.ie_se_necessario, 'N') = 'N'
						and	((coalesce(a.ie_urgencia,'N') = 'N')
							or	((coalesce(a.ie_urgencia,'N') = 'S') 
							and not exists (SELECT 1 
											from rep_horario_hor_pac x 
											where x.cd_material = a.cd_material 
											and x.nr_atendimento = nr_atendimento_w
											and	coalesce(x.dt_cancelamento::text, '') = ''
											and	x.dt_atualizacao_nrec between dt_inicio_prescr_w and dt_validade_prescr_w)));

						if (ie_controle_tempo_w = 'N') then --Medicamento
							select	max(hr_prim_horario),
									max(ds_horarios),
									max(dt_inicio_medic),
									coalesce(max(qt_dia_prim_hor),0),
									max(hr_dose_especial),
									max(qt_dose_especial),
									max(ie_via_aplicacao),
									coalesce(max(ie_medicacao_paciente),'N'),
									coalesce(max(ie_dose_espec_agora),'N'),
									max(qt_min_aplic_dose_esp),
									max(cd_intervalo),
									max(cd_material),
									max(ds_dose_diferenciada),
									max(ds_horarios_medico),
									obter_se_acm_sn(max(ie_acm), max(ie_se_necessario)),
									max(ds_observacao_enf)
							into STRICT  	hr_prim_horario_w,
									ds_horarios_w,
									dt_inicio_medic_w,
									qt_dia_prim_hor_w,
									hr_dose_especial_w,
									qt_dose_especial_w,
									ie_via_aplicacao_w,
									ie_medicacao_paciente_w,
									ie_dose_espec_agora_w,
									qt_min_aplic_dose_esp_w,
									cd_intervalo_w,
									cd_material_w,
									ds_dose_diferenciada_w,
									ds_horarios_medico_w,
									ie_acm_sn_w,
									ds_observacao_enf_w
							from  	prescr_material
							where  	nr_prescricao = nr_prescricao_p
							and    	nr_sequencia = nr_sequencia_w;
							
							ie_prim_hor_null_w	:= false;
							
							if	((coalesce(hr_prim_horario_w::text, '') = '') or (hr_prim_horario_w = '  :  ')) and (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') and (ie_acm_sn_w <> 'S') then								
								
								ie_prim_hor_null_w	:= true;
								
							end if;

							dt_prim_horario_w := obter_data_inicio_prescr(nr_prescricao_p) + qt_dia_prim_hor_w;
							CALL gerar_prescr_mat_compl(nr_prescricao_p, nr_sequencia_w, nm_usuario_lib_p, null, ds_horarios_w);

							if (ie_dose_espec_agora_w = 'S') then
								update	cpoe_material
								set    	ie_dose_adicional  = ie_dose_espec_agora_w,
										qt_dose_adicional  = qt_dose_especial_w,
										hr_min_aplic_adic  = obter_horas_minutos(qt_min_aplic_dose_esp_w),
										dt_adm_adicional  = trunc(ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_prim_horario_w, hr_dose_especial_w),'mi')
								where  	nr_sequencia    = nr_seq_cpoe_w
								and    	coalesce(dt_liberacao_enf::text, '') = '';
							end if;

							if (ie_atualizar_horarios_w = 'S') then
								
								ds_horarios_w 		:= replace(padroniza_horario_prescr(ds_horarios_w,NULL),'A','');
								hr_prim_ds_horarios_w :=	obter_prim_dshorarios(ds_horarios_w);
								nr_ocorrencia_w := null;
								ds_horarios_medico_w := replace(padroniza_horario_prescr(ds_horarios_medico_w,NULL),'A','');
								
								if (ds_horarios_w <> ds_horarios_medico_w AND not ie_prim_hor_null_w) then

									select  max(qt_min_intervalo)
									into STRICT  	qt_min_intervalo_w
									from  	intervalo_prescricao
									where  	cd_intervalo = cd_intervalo_w;						
									
									
									if (coalesce(dt_inicio_medic_w::text, '') = '') then
										dt_inicio_hor_w := trunc(ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_inicio_prescr_w, hr_prim_horario_w),'mi');
									else
										dt_inicio_hor_w := trunc(ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_inicio_medic_w, hr_prim_horario_w),'mi');
									end if;								

									SELECT * FROM CPOE_Calcular_horario_prescr( nr_atendimento_w, cd_intervalo_w, cd_material_w, dt_inicio_hor_w, 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_ww, nm_usuario_lib_p, wheb_usuario_pck.get_cd_estabelecimento, obter_perfil_ativo, ds_dose_diferenciada_w) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_ww;
									ds_horarios_w := ds_horarios_w||ds_horarios_ww;
									ds_horarios_w := replace(padroniza_horario_prescr(ds_horarios_w,NULL),'A','');
									hr_prim_horario_ww := obter_prim_dshorarios(ds_horarios_w);

									if (hr_prim_horario_ww IS NOT NULL AND hr_prim_horario_ww::text <> '') and (hr_prim_horario_w <> '  :  ') and (hr_prim_horario_w <> hr_prim_horario_ww) then
									  hr_prim_horario_w := hr_prim_horario_ww;
									  dt_inicio_medic_w	:=  trunc(ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_inicio_medic_w, hr_prim_horario_w),'mi');
									end if;
									
								elsif ((hr_prim_ds_horarios_w IS NOT NULL AND hr_prim_ds_horarios_w::text <> '') and
									  ((hr_prim_horario_w <> '  :  ' AND hr_prim_ds_horarios_w <> hr_prim_horario_w) or (ie_prim_hor_null_w))) then
									hr_prim_horario_w 	:= hr_prim_ds_horarios_w;
									dt_inicio_medic_w	:=  trunc(ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_inicio_medic_w, hr_prim_horario_w),'mi');
								end if;

								if (position('A' in padroniza_horario_prescr(obter_prim_dsHorarios(ds_horarios_w), to_Char(dt_inicio_medic_w,'dd/mm/yyyy hh24:mi'))) > 0) and (qt_dia_prim_hor_w <> 1) then
									dt_inicio_medic_w := dt_inicio_medic_w + 1;
								end if;
							else
								dt_inicio_medic_w := null;
								hr_prim_horario_w := null;
								ds_horarios_w := null;
								nr_ocorrencia_w := null;
								
								CALL gravar_log_tasy(10007, 'CPOE_ATUALIZAR_ENFERM_FARM 316 - LIBERACAO ENFERMGEM APOS SALVAR HORARIOS: '
												|| 'nr_seq_cpoe_w : ' || nr_seq_cpoe_w	
												||' ie_atualizar_horarios_w : ' || ie_atualizar_horarios_w
												||' nr_prescricao_p : '|| nr_prescricao_p
												||' nr_sequencia_w: ' || nr_sequencia_w, nm_usuario_lib_p);
							end if;

							update	cpoe_material
							set   	nm_usuario_lib_enf    = coalesce(nm_usuario_lib_p, nm_usuario_lib_enf),
									dt_liberacao_enf    = coalesce(coalesce(dt_lib_enfermagem_w,dt_liberacao_w), dt_liberacao_enf),
									hr_prim_horario     = coalesce(hr_prim_horario_w, hr_prim_horario),
									ds_horarios        = coalesce(ds_horarios_w,ds_horarios),
									dt_inicio        = coalesce(dt_inicio_medic_w, dt_inicio),
									ie_via_aplicacao    = coalesce(ie_via_aplicacao_w,ie_via_aplicacao),
									ie_medicacao_paciente  = coalesce(ie_medicacao_paciente_w,ie_medicacao_paciente),
									nr_ocorrencia      = coalesce(nr_ocorrencia_w,nr_ocorrencia),
									ds_observacao_enf = substr(ds_observacao_enf_w,1,2000)
							where	nr_sequencia = nr_seq_cpoe_w
							and		coalesce(dt_liberacao_enf::text, '') = '';
						else --Solucao
							select	coalesce(max(a.nr_seq_solucao),0)
							into STRICT  	nr_seq_solucao_w
							from	prescr_solucao a,
									prescr_material b
							where	b.nr_sequencia_solucao = a.nr_seq_solucao
							and		a.nr_prescricao = b.nr_prescricao
							and		b.nr_seq_mat_cpoe = nr_seq_cpoe_w
							and 	b.nr_prescricao = nr_prescricao_p;

							if (coalesce(nr_seq_solucao_w,0) > 0) then

								select	max(a.hr_prim_horario),
										max(a.ds_horarios),
										Obter_dt_inicio_sol_prescr(nr_prescricao_p, nr_seq_solucao_w),
										max(ds_observacao_enf)
								into STRICT	hr_prim_horario_w,
										ds_horarios_w,
										dt_inicio_medic_w2,
										ds_observacao_enf_w
								from 	prescr_solucao a,
										prescr_material b
								where	b.nr_sequencia_solucao = a.nr_seq_solucao
								and 	a.nr_prescricao = b.nr_prescricao
								and 	b.nr_prescricao = nr_prescricao_p
								and 	b.nr_seq_mat_cpoe = nr_seq_cpoe_w
								and 	a.nr_seq_solucao = nr_seq_solucao_w;
								
								if (ie_atualizar_horarios_w = 'S') then

									ds_horarios_w := replace(padroniza_horario_prescr(ds_horarios_w,NULL),'A','');

									select  trunc(max(dt_inicio),'mi')
									into STRICT	dt_inicio_medic_w
									from	cpoe_material
									where	nr_sequencia = nr_seq_cpoe_w;
									
									if (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') then
									  dt_inicio_medic_w	:=  trunc(ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_inicio_medic_w2, hr_prim_horario_w),'mi');
									end if;

									if (position('A' in padroniza_horario_prescr(obter_prim_dsHorarios(ds_horarios_w), to_Char(dt_inicio_medic_w,'dd/mm/yyyy hh24:mi'))) > 0) then
										dt_inicio_medic_w := dt_inicio_medic_w + 1;
									end if;

								else
									dt_inicio_medic_w := null;
									hr_prim_horario_w := null;
									ds_horarios_w := null;
									nr_ocorrencia_w := null;
									
									CALL gravar_log_tasy(10007, 'CPOE_ATUALIZAR_ENFERM_FARM 316 - LIBERACAO ENFERMGEM APOS SALVAR HORARIOS: '
													|| 'nr_seq_cpoe_w : ' || nr_seq_cpoe_w	
													||' ie_atualizar_horarios_w : ' || ie_atualizar_horarios_w
													||' nr_prescricao_p : '|| nr_prescricao_p
													||' nr_sequencia_w: ' || nr_sequencia_w, nm_usuario_lib_p);
								end if;

								update	cpoe_material
								set   	nm_usuario_lib_enf	= coalesce(nm_usuario_lib_p, nm_usuario_lib_enf),
										dt_liberacao_enf    = coalesce(coalesce(dt_lib_enfermagem_w,dt_liberacao_w), dt_liberacao_enf),
										hr_prim_horario     = coalesce(hr_prim_horario_w,hr_prim_horario),
										ds_horarios        	= coalesce(ds_horarios_w,ds_horarios),
										dt_inicio        	= coalesce(dt_inicio_medic_w, dt_inicio),
										ds_observacao_enf	= substr(ds_observacao_enf_w,1,2000)
								where   nr_sequencia       	= nr_seq_cpoe_w
								and		coalesce(dt_liberacao_enf::text, '') = '';
							end if;
						end if;
					end if;
					
				elsif (ie_tipo_item_w in ('O','J','S','LD','PI','PA')) then

					update 	cpoe_dieta
					set 	nm_usuario_lib_enf	= nm_usuario_lib_p,
							dt_liberacao_enf 	= dt_liberacao_w
					where   nr_sequencia     	= nr_seq_cpoe_w
					and		coalesce(dt_liberacao_enf::text, '') = '';

				elsif (ie_tipo_item_w = 'E') then
				
					select	max(CASE WHEN obter_se_acm_sn(ie_acm, ie_se_necessario)='N' THEN  ds_horarios  ELSE null END ),
							max(hr_prim_horario)
					into STRICT	ds_horarios_w,
							hr_prim_horario_w
					from	prescr_material
					where	nr_prescricao = nr_prescricao_p
					and		nr_sequencia = nr_sequencia_w;

					select	max(dt_inicio)
					into STRICT  	dt_inicio_medic_w
					from  	cpoe_dieta
					where	nr_sequencia = nr_seq_cpoe_w;

					if (position('A' in padroniza_horario_prescr(obter_prim_dsHorarios(ds_horarios_w), to_Char(dt_inicio_medic_w,'dd/mm/yyyy hh24:mi'))) > 0) then
						dt_inicio_medic_w := dt_inicio_medic_w + 1;
					end if;

					update	cpoe_dieta
					set		nm_usuario_lib_enf  = coalesce(nm_usuario_lib_p, nm_usuario_lib_enf),
							dt_liberacao_enf  = coalesce(dt_liberacao_w, dt_liberacao_enf),
							dt_inicio      = coalesce(dt_inicio_medic_w, dt_inicio),
							ds_horarios      = coalesce(ds_horarios_w,ds_horarios),
							hr_prim_horario    = coalesce(hr_prim_horario_w,hr_prim_horario)
					where	nr_sequencia     = nr_seq_cpoe_w
					and		coalesce(dt_liberacao_enf::text, '') = '';
				elsif (ie_tipo_item_w = 'R') then

					update  cpoe_recomendacao
					set		nm_usuario_lib_enf  = nm_usuario_lib_p,
							dt_liberacao_enf  = dt_liberacao_w
					where   nr_sequencia     = nr_seq_cpoe_w
					and		coalesce(dt_liberacao_enf::text, '') = '';

				elsif (ie_tipo_item_w = 'G') then

					update	cpoe_gasoterapia
					set		nm_usuario_lib_enf	= nm_usuario_lib_p,
							dt_liberacao_enf  	= dt_liberacao_w
					where   nr_sequencia     	= nr_seq_cpoe_w
					and		coalesce(dt_liberacao_enf::text, '') = '';

				elsif (ie_tipo_item_w = 'P') then

					select  max(a.dt_inicio_prescr),
							max(b.cd_intervalo),
							max(a.nr_atendimento),
							max(b.nr_seq_proc_interno),
							max(b.dt_prev_execucao),
							max(b.ds_horarios)
					into STRICT	dt_inicio_w,
							cd_intervalo_w,
							nr_atendimento_w,
							nr_seq_proc_interno_w,
							dt_prev_execucao_w,
							ds_hor_precr_proc_w
					from	prescr_procedimento b,
							prescr_medica a
					where	a.nr_prescricao  = nr_prescricao_p
					and		a.nr_prescricao  = b.nr_prescricao
					and		b.nr_sequencia   = nr_sequencia_w;
					
					select	coalesce(max('S'),'N')
						into STRICT	ie_atualizar_horarios_w
						from	prescr_procedimento a
						where  	a.nr_prescricao = nr_prescricao_p
					and		a.nr_sequencia = nr_sequencia_w
					and 	coalesce(a.ie_acm, 'N') = 'N'
					and 	coalesce(a.ie_se_necessario, 'N') = 'N'
					and		a.nr_seq_proc_cpoe = nr_seq_cpoe_w
					and	((coalesce(a.ie_urgencia,'N') = 'N')
					or	((coalesce(a.ie_urgencia,'N') = 'S') 
					and not exists (SELECT 1 
								from rep_horario_hor_pac x 
							where x.nr_seq_proc_interno = a.nr_seq_proc_interno 
							and x.nr_atendimento = nr_atendimento_w
							and	coalesce(x.dt_cancelamento::text, '') = ''
							and	x.dt_atualizacao_nrec between dt_inicio_prescr_w and dt_validade_prescr_w)));
					
					
					
					if (ie_atualizar_horarios_w = 'S') then
					
						hr_prim_horario_w := obter_prim_dshorarios(ds_hor_precr_proc_w);

						select	max(qt_min_intervalo)
						into STRICT	qt_min_intervalo_w
						from	intervalo_prescricao
						where	cd_intervalo = cd_intervalo_w;

						nr_ocorrencia_w := 0;
						if (obter_se_eh_cig(nr_seq_proc_interno_w) = 'S') then
							nr_ocorrencia_w := 1;
						end if;
						
						if (coalesce(nr_seq_cpoe_w, 0) > 0) then
							select max(a.dt_fim)
							  into STRICT dt_fim_w
							  from cpoe_procedimento a
							 where a.nr_sequencia = nr_seq_cpoe_w
							   and a.ie_duracao = 'P';
						end if;
						
						cpoe_calcular_horario_prescr(  nr_atendimento_w, cd_intervalo_w, null, dt_prev_execucao_w,
								  0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w,
								  ds_horarios_ww, nm_usuario_lib_p, wheb_usuario_pck.get_cd_estabelecimento, obter_perfil_ativo,
								  null, null, null, null,
								  nr_seq_proc_interno_w, ceil((dt_fim_w - dt_prev_execucao_w)*24) );

						ds_horarios_w := ds_horarios_w||ds_horarios_ww;
					
					else
					
						hr_prim_horario_w  := null;
						dt_prev_execucao_w := null;
						ds_horarios_w := null;
					
					end if;	
					
					update  	cpoe_procedimento
					set		nm_usuario_lib_enf	= coalesce(nm_usuario_lib_p, nm_usuario_lib_enf),
							dt_liberacao_enf	= coalesce(dt_liberacao_w, dt_liberacao_enf),
							dt_prev_execucao	= coalesce(dt_prev_execucao_w,dt_prev_execucao),
							dt_inicio		= coalesce(dt_prev_execucao_w, dt_inicio),
							hr_prim_horario		= coalesce(hr_prim_horario_w, hr_prim_horario),
							ds_horarios		= coalesce(ds_horarios_w, ds_horarios)
					where   	nr_sequencia		= nr_seq_cpoe_w
					and		coalesce(dt_liberacao_enf::text, '') = '';
					
					update	cpoe_material
					set		nm_usuario_lib_enf	= coalesce(nm_usuario_lib_p, nm_usuario_lib_enf),
							dt_liberacao_enf	= coalesce(coalesce(dt_lib_enfermagem_w,dt_liberacao_w), dt_liberacao_enf)
					where	dt_liberacao_enf	is	null
					and		nr_seq_procedimento =	nr_seq_cpoe_w;
					
				elsif (ie_tipo_item_w = 'D') then

					update	cpoe_dialise
					set		nm_usuario_lib_enf	= nm_usuario_lib_p,
							dt_liberacao_enf	= dt_liberacao_w
					where   nr_sequencia		= nr_seq_cpoe_w
					and    	coalesce(dt_liberacao_enf::text, '') = '';

				elsif (ie_tipo_item_w = 'MAT') then

					update	cpoe_material
					set   	nm_usuario_lib_enf    = coalesce(nm_usuario_lib_p, nm_usuario_lib_enf),
							dt_liberacao_enf    = coalesce(coalesce(dt_lib_enfermagem_w,dt_liberacao_w), dt_liberacao_enf)
					where	nr_sequencia = nr_seq_cpoe_w
					and		coalesce(dt_liberacao_enf::text, '') = '';
					
				elsif (ie_tipo_item_w = 'H') then

					update  cpoe_hemoterapia
					set		nm_usuario_lib_enf  = nm_usuario_lib_p,
							dt_liberacao_enf  = dt_liberacao_w
					where   nr_sequencia     = nr_seq_cpoe_w
					and		coalesce(dt_liberacao_enf::text, '') = '';
				elsif (ie_tipo_item_w = 'AP') then

					update	cpoe_anatomia_patologica
					set   	nm_usuario_lib_enf    = coalesce(nm_usuario_lib_p, nm_usuario_lib_enf),
							dt_liberacao_enf    = coalesce(dt_liberacao_w, dt_liberacao_enf)
					where	nr_sequencia = nr_seq_cpoe_w
					and		coalesce(dt_liberacao_enf::text, '') = '';
						
				end if;
			end if;
			end;
		end loop;
		close C01;

	elsif (upper(ie_enfer_farm_p) = 'FARM') then

		select  max(dt_liberacao_farmacia),
				max(nr_atendimento),
				max(cd_estabelecimento),
				max(dt_inicio_prescr),
				max(dt_validade_prescr)
		into STRICT	dt_liberacao_w,
				nr_atendimento_w,
				cd_estabelecimento_w,
				dt_inicio_prescr_w,
				dt_validade_prescr_w
		from	prescr_medica
		where	nr_prescricao = nr_prescricao_p;
		
		cd_pessoa_farm_w := obter_pf_usuario(nm_usuario_lib_p,'C');

		if (coalesce(cd_pessoa_farm_w::text, '') = '') then
			
			if (coalesce(cd_pessoa_farm_w::text, '') = '') and (OBTER_SE_SOMENTE_NUMERO(nm_usuario_lib_p) = 'S') then
				cd_pessoa_farm_w := nm_usuario_lib_p;
			end if;

		end if;

		--Atualizar Farmacia
		open C01;
		loop
		fetch C01 into
			  ie_tipo_item_w,
			  nr_seq_cpoe_w,
			  nr_sequencia_w,
			  dt_lib_enfermagem_w,
			  dt_lib_farmacia_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			if ((nr_seq_cpoe_w IS NOT NULL AND nr_seq_cpoe_w::text <> '') and coalesce(nr_seq_cpoe_w,0) > 0) then
				if (ie_tipo_item_w = 'M') then

					select	coalesce(max(ie_controle_tempo),'N')
					into STRICT	ie_controle_tempo_w
					from 	cpoe_material
					where	nr_sequencia = nr_seq_cpoe_w;
					
					/*Caso modificar lembrar de atualizar na rotina de Enfermagem*/

					select	coalesce(max('S'),'N')
					into STRICT	ie_atualizar_horarios_w
					from	prescr_material a
					where  	a.nr_prescricao = nr_prescricao_p
					and		a.nr_sequencia = nr_sequencia_w
					and		a.nr_seq_mat_cpoe = nr_seq_cpoe_w
					and 	coalesce(a.ie_acm, 'N') = 'N'
					and 	coalesce(a.ie_se_necessario, 'N') = 'N'
					and		((coalesce(a.ie_urgencia,'N') = 'N') or	
							 ((coalesce(a.ie_urgencia,'N') = 'S') and
							   not exists (	SELECT	1 
											from 	rep_horario_hor_pac x 
											where 	x.cd_material = a.cd_material 
											and 	x.nr_atendimento = nr_atendimento_w
											and		coalesce(x.dt_cancelamento::text, '') = ''
											and		x.dt_atualizacao_nrec between dt_inicio_prescr_w and dt_validade_prescr_w)));

					if (ie_controle_tempo_w = 'N') then --Medicamento
						select  max(hr_prim_horario),
								max(ds_horarios),
								max(dt_inicio_medic),
								max(qt_dia_prim_hor),
								max(hr_dose_especial),
								max(qt_dose_especial),
								max(ie_via_aplicacao),
								coalesce(max(ie_medicacao_paciente),'N'),
								coalesce(max(ie_dose_espec_agora),'N'),
								max(qt_min_aplic_dose_esp),
								obter_se_acm_sn(max(ie_acm), max(ie_se_necessario)),
								max(ds_observacao_far)
						into STRICT	hr_prim_horario_w,
								ds_horarios_w,
								dt_inicio_medic_w,
								qt_dia_prim_hor_w,
								hr_dose_especial_w,
								qt_dose_especial_w,
								ie_via_aplicacao_w,
								ie_medicacao_paciente_w,
								ie_dose_espec_agora_w,
								qt_min_aplic_dose_esp_w,
								ie_acm_sn_w,
								ds_observacao_far_w
						from	prescr_material
						where	nr_prescricao = nr_prescricao_p
						and		nr_sequencia = nr_sequencia_w;
						
						ie_prim_hor_null_w	:= false;
						
						if	((coalesce(hr_prim_horario_w::text, '') = '') or (hr_prim_horario_w = '  :  ')) and (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') and (ie_acm_sn_w <> 'S') then								
							
							ie_prim_hor_null_w	:= true;
							
						end if;

						dt_prim_horario_w := obter_data_inicio_prescr(nr_prescricao_p) + qt_dia_prim_hor_w;

						if (ie_dose_espec_agora_w = 'S') then
							update	cpoe_material
							set		ie_dose_adicional	= ie_dose_espec_agora_w,
									qt_dose_adicional	= qt_dose_especial_w,
									hr_min_aplic_adic	= obter_horas_minutos(qt_min_aplic_dose_esp_w),
									dt_adm_adicional	=  trunc(ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_prim_horario_w, hr_dose_especial_w),'mi')
							where	nr_sequencia    	= nr_seq_cpoe_w
							and		coalesce(dt_liberacao_farm::text, '') = '';
						end if;

						select  max(ds_horario_enf)
						into STRICT	ds_horarios_enf_w
						from	prescr_material_compl
						where	nr_prescricao = nr_prescricao_p
						and		nr_sequencia = nr_sequencia_w;		
						
						update	cpoe_material
						set		ds_observacao_far	= substr(ds_observacao_far_w,1,2000)
						where	nr_sequencia       = nr_seq_cpoe_w
						and		coalesce(dt_liberacao_farm::text, '') = '';
						
						if (coalesce(ds_horarios_enf_w::text, '') = '') or (ds_horarios_enf_w <> ds_horarios_w) then
							
							if (ie_atualizar_horarios_w = 'S') then

								ds_horarios_w := replace(padroniza_horario_prescr(ds_horarios_w,NULL),'A','');
								hr_prim_ds_horarios_w := obter_prim_dshorarios(ds_horarios_w);
								if ((hr_prim_ds_horarios_w IS NOT NULL AND hr_prim_ds_horarios_w::text <> '') and
									((hr_prim_horario_w <> '  :  ' AND hr_prim_ds_horarios_w <> hr_prim_horario_w) or (ie_prim_hor_null_w))) then
									hr_prim_horario_w 	:= hr_prim_ds_horarios_w;
									dt_inicio_medic_w	:=  trunc(ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_inicio_medic_w, hr_prim_horario_w),'mi');
								end if;

								if (position('A' in padroniza_horario_prescr(obter_prim_dsHorarios(ds_horarios_w), to_Char(dt_inicio_medic_w,'dd/mm/yyyy hh24:mi'))) > 0) and (qt_dia_prim_hor_w <> 1) then
									dt_inicio_medic_w := dt_inicio_medic_w + 1;
								end if;
							else
								dt_inicio_medic_w := null;
								hr_prim_horario_w := null;
								ds_horarios_w := null;
								nr_ocorrencia_w := null;
								
								CALL gravar_log_tasy(10007, 'CPOE_ATUALIZAR_ENFERM_FARM 316 - LIBERACAO ENFERMGEM APOS SALVAR HORARIOS: '
												|| 'nr_seq_cpoe_w : ' || nr_seq_cpoe_w	
												||' ie_atualizar_horarios_w : ' || ie_atualizar_horarios_w
												||' nr_prescricao_p : '|| nr_prescricao_p
												||' nr_sequencia_w: ' || nr_sequencia_w, nm_usuario_lib_p);
							end if;						

							if (obter_funcao_ativa <> 7010 or obter_se_mat_lib_farm_cpoe(nr_seq_cpoe_w) = 'N') then
								update	cpoe_material
								set		hr_prim_horario     = coalesce(hr_prim_horario_w,hr_prim_horario),
										ds_horarios        = coalesce(ds_horarios_w,ds_horarios),
										dt_inicio        = coalesce(dt_inicio_medic_w, dt_inicio),
										ie_via_aplicacao    = coalesce(ie_via_aplicacao_w,ie_via_aplicacao),
										ie_medicacao_paciente  = coalesce(ie_medicacao_paciente_w,ie_medicacao_paciente),
										ds_observacao_far	= substr(ds_observacao_far_w,1,2000)
								where	nr_sequencia       = nr_seq_cpoe_w
								and		coalesce(dt_liberacao_farm::text, '') = '';
							end if;
						end if;

					else --Solucao
						select	coalesce(max(a.nr_seq_solucao),0)
						into STRICT	nr_seq_solucao_w
						from	prescr_solucao a,
								prescr_material b
						where   b.nr_sequencia_solucao  = a.nr_seq_solucao
						and   	a.nr_prescricao     	= b.nr_prescricao
						and   	b.nr_seq_mat_cpoe     	= nr_seq_cpoe_w
						and    	b.nr_prescricao     	= nr_prescricao_p;

						if (coalesce(nr_seq_solucao_w,0) > 0) then

							select  max(a.hr_prim_horario),
									max(a.ds_horarios),
									Obter_dt_inicio_sol_prescr(nr_prescricao_p, nr_seq_solucao_w),
									max(ds_observacao_far)
							into STRICT	hr_prim_horario_w,
									ds_horarios_w,
									dt_inicio_medic_w2,
									ds_observacao_far_w
							from	prescr_solucao a,
									prescr_material b
							where   b.nr_sequencia_solucao  = a.nr_seq_solucao
							and   	a.nr_prescricao     = b.nr_prescricao
							and   	b.nr_prescricao     = nr_prescricao_p
							and   	b.nr_seq_mat_cpoe     = nr_seq_cpoe_w
							and   	a.nr_seq_solucao     = nr_seq_solucao_w;


							if (ie_atualizar_horarios_w = 'S') then
								ds_horarios_w := replace(padroniza_horario_prescr(ds_horarios_w,NULL),'A','');

								select  trunc(max(dt_inicio),'mi')
								into STRICT	dt_inicio_medic_w
								from	cpoe_material
								where	nr_sequencia = nr_seq_cpoe_w;
								
								if (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') then
									dt_inicio_medic_w := trunc(ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_inicio_medic_w2, hr_prim_horario_w),'mi');
								end if;

								if (position('A' in padroniza_horario_prescr(obter_prim_dsHorarios(ds_horarios_w), to_Char(dt_inicio_medic_w,'dd/mm/yyyy hh24:mi'))) > 0) then								
									dt_inicio_medic_w := dt_inicio_medic_w + 1;
								end if;
							else
								dt_inicio_medic_w := null;
								hr_prim_horario_w := null;
								ds_horarios_w := null;
								nr_ocorrencia_w := null;
								
								CALL gravar_log_tasy(10007, 'CPOE_ATUALIZAR_ENFERM_FARM 316 - LIBERACAO ENFERMGEM APOS SALVAR HORARIOS: '
												|| 'nr_seq_cpoe_w : ' || nr_seq_cpoe_w	
												||' ie_atualizar_horarios_w : ' || ie_atualizar_horarios_w
												||' nr_prescricao_p : '|| nr_prescricao_p
												||' nr_sequencia_w: ' || nr_sequencia_w, nm_usuario_lib_p);
							end if;

							if (obter_funcao_ativa <> 7010 or obter_se_mat_lib_farm_cpoe(nr_seq_cpoe_w) = 'N') then
								update	cpoe_material
								set	hr_prim_horario    	= coalesce(hr_prim_horario_w, hr_prim_horario),
									ds_horarios     	= coalesce(ds_horarios_w, ds_horarios),
									dt_inicio      		= coalesce(dt_inicio_medic_w, dt_inicio),
									ds_observacao_far	= substr(ds_observacao_far_w,1,2000)
								where	nr_sequencia     	= nr_seq_cpoe_w
								and	coalesce(dt_liberacao_farm::text, '') = '';
							end if;
						end if;
					end if;

					if ((dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '') or (dt_lib_farmacia_w IS NOT NULL AND dt_lib_farmacia_w::text <> '')) then
						update	cpoe_material
						set	cd_farmac_lib = coalesce(coalesce(cd_pessoa_farm_w,nm_usuario_lib_p), cd_farmac_lib),
							nm_usuario_lib_farm = coalesce(nm_usuario_lib_p, nm_usuario_lib_farm),
							dt_liberacao_farm = coalesce(coalesce(dt_lib_farmacia_w,dt_liberacao_w), dt_liberacao_farm)
						where	nr_sequencia = nr_seq_cpoe_w
						and	coalesce(dt_liberacao_farm::text, '') = '';
					end if;

				elsif (ie_tipo_item_w in ('O','J','S','LD','PI','PA')) then

					update  cpoe_dieta
					set		cd_farmac_lib    	= coalesce(cd_pessoa_farm_w,nm_usuario_lib_p),
							nm_usuario_lib_farm = nm_usuario_lib_p,
							dt_liberacao_farm	= dt_liberacao_w
					where	nr_sequencia     	= nr_seq_cpoe_w
					and		coalesce(dt_liberacao_farm::text, '') = '';

				elsif (ie_tipo_item_w = 'E') then

					select	max(CASE WHEN obter_se_acm_sn(ie_acm, ie_se_necessario)='N' THEN  ds_horarios  ELSE null END ),
							max(hr_prim_horario)
					into STRICT	ds_horarios_w,
							hr_prim_horario_w
					from	prescr_material
					where	nr_prescricao = nr_prescricao_p
					and		nr_sequencia = nr_sequencia_w;

					select	dt_inicio
					into STRICT  	dt_inicio_medic_w
					from  	cpoe_dieta
					where	nr_sequencia = nr_seq_cpoe_w;

					if (position('A' in padroniza_horario_prescr(obter_prim_dsHorarios(ds_horarios_w), to_Char(dt_inicio_medic_w,'dd/mm/yyyy hh24:mi'))) > 0) then
						dt_inicio_medic_w := dt_inicio_medic_w + 1;
					end if;

					update  cpoe_dieta						
					set		cd_farmac_lib       = coalesce(coalesce(cd_pessoa_farm_w,nm_usuario_lib_p), cd_farmac_lib),
							nm_usuario_lib_farm  = nm_usuario_lib_p,	
							dt_liberacao_farm	= dt_liberacao_w,
							dt_inicio			= coalesce(dt_inicio_medic_w, dt_inicio),
							ds_horarios			= coalesce(ds_horarios_w, ds_horarios),
							hr_prim_horario		= coalesce(hr_prim_horario_w, hr_prim_horario)
					where	nr_sequencia		= nr_seq_cpoe_w
					and		coalesce(dt_liberacao_farm::text, '') = '';
					
				elsif (ie_tipo_item_w = 'R') then
				
					select	max(dt_inicio),
							max(ie_retrogrado)
					into STRICT	dt_inicio_w,
							ie_retrogrado_w
					from	cpoe_recomendacao
					where	nr_sequencia = nr_seq_cpoe_w;
					
					select	max(dt_inicio_prescr)
					into STRICT	dt_inicio_prescr_w
					from	prescr_medica
					where	nr_prescricao = nr_prescricao_p;
					
					select	max(hr_prim_horario),
							max(ds_horarios),
							coalesce(max(ie_urgencia),'N')
					into STRICT	hr_prim_horario_w,
							ds_horarios_w,
							ie_urgencia_w
					from	prescr_recomendacao
					where	nr_prescricao = nr_prescricao_p
					and		nr_seq_rec_cpoe = nr_seq_cpoe_w;
					
					if (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') then
						dt_inicio_item_w := ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_inicio_w, hr_prim_horario_w);
						if	(((dt_inicio_item_w > dt_inicio_prescr_w) and (dt_inicio_item_w > clock_timestamp())) OR (ie_urgencia_w = 'S') OR (ie_retrogrado_w = 'S'))then
							dt_inicio_w := dt_inicio_item_w;
						else
							dt_inicio_w := dt_inicio_item_w + 1;
						end if;					
					end if;
					

					update  cpoe_recomendacao
					set		cd_farmac_lib       = coalesce(coalesce(cd_pessoa_farm_w,nm_usuario_lib_p), cd_farmac_lib),
							nm_usuario_lib_farm  = nm_usuario_lib_p,
							dt_liberacao_farm 	= dt_liberacao_w,
							hr_prim_horario 	= coalesce(hr_prim_horario_w, hr_prim_horario),
							dt_inicio			= coalesce(dt_inicio_w, dt_inicio),
							ds_horarios			= coalesce(ds_horarios_w, ds_horarios)
					where   nr_sequencia     = nr_seq_cpoe_w
					and		coalesce(dt_liberacao_farm::text, '') = '';

				elsif (ie_tipo_item_w = 'G') then
				
					select	max(qt_hora_fase),
							max(cd_intervalo),
							max(ie_modo_adm)
					into STRICT	qt_hora_fase_w,
							cd_intervalo_w,
							ie_modo_adm_w
					from	cpoe_gasoterapia
					where	nr_sequencia = nr_seq_cpoe_w;

					select	max(a.dt_prev_execucao),
						max(a.ds_horarios),
						CASE WHEN coalesce(max(a.nr_seq_inconsistencia)::text, '') = '' THEN  max(b.dt_liberacao_parc_farm)  ELSE null END
					into STRICT	dt_inicio_item_w,
						ds_horarios_w,
						dt_lib_parcial_w
					from	prescr_gasoterapia a,
						prescr_medica b
					where	a.nr_prescricao = nr_prescricao_p
					and	a.nr_seq_gas_cpoe = nr_seq_cpoe_w
					and	a.nr_prescricao = b.nr_prescricao;
					
					hr_prim_horario_w := obter_prim_dshorarios(ds_horarios_w);
					
					if (ie_modo_adm_w = 'C') then
						ie_continuo_w	:= 'S';
					else
						ie_continuo_w	:= 'N';
					end if;
					
					nr_ocorrencia_w		:= null;
					qt_tempo_etapa_w	:= null;
					if (qt_hora_fase_w IS NOT NULL AND qt_hora_fase_w::text <> '') then
						qt_tempo_etapa_w	:= dividir(obter_minutos_hora(qt_hora_fase_w),60);
					end if;
					
					SELECT * FROM CPOE_Calcula_horarios_etapas(	nm_usuario_lib_p, dt_inicio_item_w, ie_continuo_w, nr_ocorrencia_w, cd_intervalo_w, 24, qt_tempo_etapa_w, null, 'N') INTO STRICT nr_ocorrencia_w, ds_horarios_w;
					
					
					if ((dt_lib_parcial_w IS NOT NULL AND dt_lib_parcial_w::text <> '') or (dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '')) then
						update	cpoe_gasoterapia
						set		cd_farmac_lib       = coalesce(coalesce(cd_pessoa_farm_w,nm_usuario_lib_p), cd_farmac_lib),
								nm_usuario_lib_farm	= nm_usuario_lib_p,
								dt_liberacao_farm  	= coalesce(dt_lib_parcial_w,dt_liberacao_w),
								dt_inicio			= coalesce(dt_inicio_item_w,dt_inicio),
								hr_prim_horario     = coalesce(hr_prim_horario_w,hr_prim_horario),
								ds_horarios         = coalesce(ds_horarios_w,ds_horarios)
						where   nr_sequencia     	= nr_seq_cpoe_w
						and		coalesce(dt_liberacao_farm::text, '') = '';
					end if;
					
				elsif (ie_tipo_item_w = 'P') then

					select  max(a.dt_inicio_prescr),
							max(b.cd_intervalo),
							max(a.nr_atendimento),
							max(b.nr_seq_proc_interno),
							max(b.dt_prev_execucao),
							max(b.ds_horarios)
					into STRICT	dt_inicio_w,
							cd_intervalo_w,
							nr_atendimento_w,
							nr_seq_proc_interno_w,
							dt_prev_execucao_w,
							ds_hor_precr_proc_w
					from	prescr_procedimento b,
							prescr_medica a
					where	a.nr_prescricao   = nr_prescricao_p
					and		a.nr_prescricao   = b.nr_prescricao
					and		b.nr_sequencia = nr_sequencia_w;
					
					
					select	coalesce(max('S'),'N')
						into STRICT	ie_atualizar_horarios_w
						from	prescr_procedimento a
						where  	a.nr_prescricao = nr_prescricao_p
					and		a.nr_sequencia = nr_sequencia_w
					and		a.nr_seq_proc_cpoe = nr_seq_cpoe_w
					and 	coalesce(a.ie_acm, 'N') = 'N'
					and 	coalesce(a.ie_se_necessario, 'N') = 'N'
					and	((coalesce(a.ie_urgencia,'N') = 'N')
					or	((coalesce(a.ie_urgencia,'N') = 'S') 
					and not exists (SELECT 1 
								from rep_horario_hor_pac x 
							where x.cd_procedimento = a.cd_procedimento 
							and x.nr_atendimento = nr_atendimento_w
							and	coalesce(x.dt_cancelamento::text, '') = ''
							and	x.dt_atualizacao_nrec between dt_inicio_prescr_w and dt_validade_prescr_w)));
					
					
					
					
					if (ie_atualizar_horarios_w = 'S') then
					
						hr_prim_horario_w := obter_prim_dshorarios(ds_hor_precr_proc_w);

						select	max(qt_min_intervalo)
						into STRICT	qt_min_intervalo_w
						from	intervalo_prescricao
						where	cd_intervalo = cd_intervalo_w;

						nr_ocorrencia_w := 0;
						if (obter_se_eh_cig(nr_seq_proc_interno_w) = 'S') then
							nr_ocorrencia_w := 1;
						end if;

						if (coalesce(nr_seq_cpoe_w, 0) > 0) then
							select max(a.dt_fim)
							  into STRICT dt_fim_w
							  from cpoe_procedimento a
							 where a.nr_sequencia = nr_seq_cpoe_w
							   and a.ie_duracao = 'P';
						end if;
						
						cpoe_calcular_horario_prescr(	nr_atendimento_w, cd_intervalo_w, null, dt_prev_execucao_w,
													0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w,
													ds_horarios_ww, nm_usuario_lib_p, wheb_usuario_pck.get_cd_estabelecimento, obter_perfil_ativo,
													null, null, null, null,
													nr_seq_proc_interno_w, ceil((dt_fim_w - dt_prev_execucao_w)*24) );
						ds_horarios_w := ds_horarios_w||ds_horarios_ww;
						
					
					else
						
						hr_prim_horario_w  := null;
						dt_prev_execucao_w := null;
						ds_hor_precr_proc_w := null;
					
					end if; 	

					update  	cpoe_procedimento
					set		nm_usuario_lib_farm = coalesce(nm_usuario_lib_p,cd_farmac_lib),
							cd_farmac_lib      	= coalesce(coalesce(cd_pessoa_farm_w,nm_usuario_lib_p), cd_farmac_lib),
							dt_liberacao_farm	= coalesce(dt_liberacao_w, dt_liberacao_farm),
							dt_prev_execucao	= coalesce(dt_prev_execucao_w,dt_prev_execucao),
							dt_inicio			= coalesce(dt_prev_execucao_w, dt_inicio),
							hr_prim_horario		= coalesce(hr_prim_horario_w, hr_prim_horario),
							ds_horarios			= CASE WHEN coalesce(ds_hor_precr_proc_w, ds_horarios)=ds_horarios THEN  ds_horarios  ELSE ds_horarios_w END
					where   	nr_sequencia	= nr_seq_cpoe_w
					and		coalesce(dt_liberacao_farm::text, '') = '';
					
					
					update	cpoe_material
					set		nm_usuario_lib_farm	=	coalesce(nm_usuario_lib_p,cd_farmac_lib),
							dt_liberacao_farm	=	coalesce(coalesce(dt_lib_farmacia_w,dt_liberacao_w), dt_liberacao_farm),
							cd_farmac_lib     	= coalesce(cd_pessoa_farm_w,nm_usuario_lib_p)
					where	dt_liberacao_farm	is	null
					and		nr_seq_procedimento =	nr_seq_cpoe_w;
					

					commit;
				elsif (ie_tipo_item_w = 'D') then

					update  cpoe_dialise
					set		cd_farmac_lib 		= coalesce(cd_pessoa_farm_w,nm_usuario_lib_p),
							nm_usuario_lib_farm = nm_usuario_lib_p,
							dt_liberacao_farm 	= dt_liberacao_w
					where	nr_sequencia 		= nr_seq_cpoe_w
					and		coalesce(dt_liberacao_farm::text, '') = '';
					
				elsif (ie_tipo_item_w = 'MAT') then
			
					update	cpoe_material
					set   	cd_farmac_lib      	= coalesce(coalesce(cd_pessoa_farm_w,nm_usuario_lib_p), cd_farmac_lib),
							nm_usuario_lib_farm = coalesce(nm_usuario_lib_p, nm_usuario_lib_farm),
							dt_liberacao_farm  	= coalesce(coalesce(dt_lib_farmacia_w,dt_liberacao_w), dt_liberacao_farm)
					where	nr_sequencia 		= nr_seq_cpoe_w
					and		coalesce(dt_liberacao_farm::text, '') = '';
					
				elsif (ie_tipo_item_w = 'H') then

					update  cpoe_hemoterapia
					set   	nm_usuario_lib_farm = coalesce(nm_usuario_lib_p, nm_usuario_lib_farm),
							dt_liberacao_farm  	= coalesce(dt_liberacao_w, dt_liberacao_farm)
					where   nr_sequencia     	= nr_seq_cpoe_w
					and		coalesce(dt_liberacao_farm::text, '') = '';
					
				elsif (ie_tipo_item_w = 'AP') then

					update  cpoe_anatomia_patologica
					set   	dt_liberacao_farm  	= coalesce(dt_liberacao_w, dt_liberacao_farm)
					where   nr_sequencia     	= nr_seq_cpoe_w
					and		coalesce(dt_liberacao_farm::text, '') = '';
					
				end if;
			end if;
			end;
		end loop;
		close C01;
	end if;
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then
	commit;
end if;

exception when others then
    CALL gravar_log_tasy(cd_log_p => 10007,
                    ds_log_p => substr('Exception cpoe_atualizar_enferm_farm - Linha:'||$$plsql_line||pls_util_pck.enter_w
                                    || ' nr_prescricao_p:'|| nr_prescricao_p||pls_util_pck.enter_w
									|| ' nr_sequencia_w:'|| nr_sequencia_w||pls_util_pck.enter_w
									|| ' nm_usuario_lib_p:'||nm_usuario_lib_p||pls_util_pck.enter_w
									|| ' ds_horarios_w:'||ds_horarios_w||pls_util_pck.enter_w
									|| ' Erro:'||substr(sqlerrm,1,100) 
									|| ' - ' || dbms_utility.format_error_backtrace,1,2000),
                    nm_usuario_p => nm_usuario_lib_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_atualizar_enferm_farm ( nr_prescricao_p bigint, nm_usuario_lib_p text, ie_enfer_farm_p text, cd_pessoa_fisica_p bigint default null) FROM PUBLIC;

