-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fleury_inserir_laudo ( nr_ficha_p bigint, nr_prescricao_p bigint, nr_seq_prescr_p bigint, cd_unidade_p text, nr_seq_laudo_p INOUT bigint) AS $body$
DECLARE

					 
nr_prescricao_w		bigint;
nr_seq_prescricao_w	bigint;

nr_sequencia_w		bigint;
nr_sequencia_ww		bigint;
nr_seq_imagem_w		bigint;
nr_laudo_w		bigint;
nr_atendimento_w	bigint;
cd_medico_resp_w	varchar(10);
dt_entrada_unidade_w	timestamp;
ds_titulo_laudo_w	varchar(255);
nr_seq_propaci_w	bigint;
dt_procedimento_w	timestamp;
nr_seq_laudo_w		bigint;
nr_seq_proc_interno_w	bigint;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
qt_procedimento_w	bigint;
cd_setor_atendimento_w	bigint;
dt_prev_execucao_w	timestamp;
cd_medico_exec_w	varchar(10);
ie_lado_w		varchar(15);
ds_laudo_copia_w	text;
nr_seq_laudo_ant_w	bigint;
nr_seq_laudo_atual_w	bigint;
cd_estabelecimento_w	prescr_medica.cd_estabelecimento%type;
ie_agrupa_w				varchar(1);
ie_existe_param_maq_w	varchar(1);


BEGIN 
 
if (coalesce(nr_prescricao_p,0) = 0) then 
	/*select	Obter_Prescr_Controle(nr_ficha_p) 
	into	nr_prescricao_w 
	from	dual;*/
 
		 
	select	fleury_obter_dados_unidade(cd_unidade_p, 'E'), 
			fleury_obter_dados_unidade(cd_unidade_p, 'AF') 
	into STRICT	cd_estabelecimento_w, 
			ie_agrupa_w 
	;
	 
	if (ie_agrupa_w <> 'N') then 
		select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  
		into STRICT	ie_existe_param_maq_w 
		from	lab_param_maquina a 
		where	a.cd_estabelecimento = cd_estabelecimento_w;
	 
		if (ie_existe_param_maq_w = 'S') then 
			select	max(a.nr_prescricao) 
			into STRICT	nr_prescricao_w 
			from ( 
					SELECT	a.nr_prescricao, 
							substr(lab_obter_parametro(cd_estabelecimento_w, a.nr_prescricao, null, 'UF'),1,255) cd_unidade_fleury 
					from	prescr_procedimento a 
					where	a.nr_controle_ext = nr_ficha_p 
					) a 
			where	a.cd_unidade_fleury = cd_unidade_p;
		else 
			select	max(a.nr_prescricao) 
			into STRICT	nr_prescricao_w 
			from	prescr_procedimento a, 
					prescr_medica b 
			where	a.nr_prescricao = b.nr_prescricao 
			and		a.nr_controle_ext = nr_ficha_p 
			and		b.cd_estabelecimento = cd_estabelecimento_w;
		end if;
	else 
		select	max(a.nr_prescricao) 
		into STRICT	nr_prescricao_w 
		from	prescr_medica a 
		where	a.nr_controle = nr_ficha_p 
		and		a.cd_estabelecimento = cd_estabelecimento_w;		
	end if;	
else 
	nr_prescricao_w	:= nr_prescricao_p;
end if;
 
nr_seq_prescricao_w	:= nr_seq_prescr_p;
 
if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then 
  
	select	max(nr_seq_proc_interno), 
		max(cd_procedimento), 
		max(ie_origem_proced), 
		max(qt_procedimento), 
		max(cd_setor_atendimento), 
		max(dt_prev_execucao), 
		max(cd_medico_exec), 
		max(coalesce(ie_lado,'A')) 
	into STRICT	nr_seq_proc_interno_w, 
		cd_procedimento_w, 
		ie_origem_proced_w, 
		qt_procedimento_w, 
		cd_setor_atendimento_w, 
		dt_prev_execucao_w, 
		cd_medico_exec_w, 
		ie_lado_w 
	from	prescr_procedimento a 
	where	a.nr_prescricao = nr_prescricao_w 
	and	a.nr_sequencia = nr_seq_prescricao_w;
		 
	select	max(a.cd_medico) 
	into STRICT	cd_medico_resp_w 
	from	prescr_medica a 
	where	a.nr_prescricao = nr_prescricao_w;
		 
	select	coalesce(max(a.nr_laudo),0)+1 
	into STRICT	nr_laudo_w 
	from	laudo_paciente a 
	where	a.nr_prescricao = nr_prescricao_w;
	 
	/*Executando a prescrição*/
 
	select	coalesce(max(nr_sequencia),0), 
		max(nr_atendimento), 
		max(dt_entrada_unidade), 
		max(dt_procedimento)		 
	into STRICT	nr_seq_propaci_w, 
		nr_atendimento_w, 
		dt_entrada_unidade_w, 
		dt_procedimento_w 
	from	procedimento_paciente 
	where	nr_prescricao		= nr_prescricao_w 
	and	nr_sequencia_prescricao	= nr_seq_prescricao_w;
	 
	if (nr_seq_propaci_w = 0) then 
		begin 
		 
		CALL Gerar_Proc_Pac_item_Prescr(	nr_prescricao_w, 
						nr_seq_prescricao_w, 
						null, 
						null, 
						nr_seq_proc_interno_w, 
						cd_procedimento_w, 
						ie_origem_proced_w, 
						qt_procedimento_w, 
						cd_setor_atendimento_w, 
						9, 
						dt_prev_execucao_w, 
						'TasyFleuryWS', 
						cd_medico_exec_w, 
						null, 
						ie_lado_w, 
						null);
						 
		select	max(nr_sequencia), 
			max(nr_atendimento), 
			max(dt_entrada_unidade), 
			max(dt_procedimento)		 
		into STRICT	nr_seq_propaci_w, 
			nr_atendimento_w, 
			dt_entrada_unidade_w, 
			dt_procedimento_w 
		from	procedimento_paciente 
		where	nr_prescricao		= nr_prescricao_w 
		and	nr_sequencia_prescricao	= nr_seq_prescricao_w;
		 
		end;
	end if;
 
	select MAX(nr_sequencia) 
	into STRICT	nr_sequencia_ww 
	from 	laudo_paciente 
	where  nr_prescricao = nr_prescricao_w 
	and	nr_seq_prescricao = nr_seq_prescricao_w;
	 
	/* *** Cancela o laudo atual do procedimento (Tratamento para retificação do laudo pela TasyFleuryWS. Quando já existir um laudo para o item, este é cancelado - OS 404183). *** */
 
	if (coalesce(nr_sequencia_ww,0)<>0) then 
		begin 
			CALL cancelar_laudo_paciente(nr_sequencia_ww,'C','TasyFleuryWS','');
		end;
	end if;
	 
			 
	select	nextval('laudo_paciente_seq') 
	into STRICT	nr_seq_laudo_w 
	;
 
	 
	select	max(substr(obter_desc_prescr_proc_laudo(cd_procedimento, ie_origem_proced, nr_seq_proc_interno, ie_lado, nr_seq_propaci_w),1,255)) 
	into STRICT	ds_titulo_laudo_w		 
	from	prescr_procedimento a 
	where	a.nr_prescricao = nr_prescricao_w 
	and	a.nr_sequencia	= nr_seq_prescricao_w;
				 
	insert into laudo_paciente( 
			nr_sequencia, 
			nr_atendimento, 
			dt_entrada_unidade, 
			nr_laudo, 
			nm_usuario, 
			dt_atualizacao, 
			cd_medico_resp, 
			ds_titulo_laudo, 
			dt_laudo, 
			nr_prescricao, 
			nr_seq_proc, 
			nr_seq_prescricao, 
			dt_liberacao, 
			qt_imagem, 
			ie_status_laudo, 
			dt_exame 
			) 
		values (	nr_seq_laudo_w, 
			nr_atendimento_w, 
			dt_entrada_unidade_w, 
			nr_laudo_w, 
			'TasyFleuryWS', 
			clock_timestamp(), 
			cd_medico_resp_w, 
			ds_titulo_laudo_w, 
			clock_timestamp(), 
			nr_prescricao_w,			 
			nr_seq_propaci_w, 
			nr_seq_prescricao_w, 
			clock_timestamp(), 
			0, 
			'LL', 
			dt_procedimento_w 
			);
					 
	update	procedimento_paciente 
	set	nr_laudo	= nr_seq_laudo_w 
	where	nr_sequencia	= nr_seq_propaci_w;
	 
	nr_seq_laudo_p	:= nr_seq_laudo_w;
	 
end if;
 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fleury_inserir_laudo ( nr_ficha_p bigint, nr_prescricao_p bigint, nr_seq_prescr_p bigint, cd_unidade_p text, nr_seq_laudo_p INOUT bigint) FROM PUBLIC;

