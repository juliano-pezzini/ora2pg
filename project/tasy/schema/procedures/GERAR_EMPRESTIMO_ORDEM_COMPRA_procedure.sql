-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_emprestimo_ordem_compra ( nr_ordem_compra_p bigint, cd_local_estoque_p bigint, dt_retorno_p timestamp, nm_usuario_p text) AS $body$
DECLARE

 
cd_estabelecimento_w			smallint;
cd_local_estoque_w			smallint;
nr_item_oci_w				integer;
cd_material_w				integer;
nr_emprestimo_w				bigint;
cd_pessoa_fisica_w			varchar(10);
cd_pessoa_juridica_w			varchar(14);
qt_material_w				double precision;
nr_sequencia_w				bigint;
vl_unitario_material_w			double precision;

c01 CURSOR FOR 
SELECT	nr_item_oci, 
	cd_material, 
	vl_unitario_material 
from	ordem_compra_item 
where	nr_ordem_compra = nr_ordem_compra_p;


BEGIN 
 
begin 
select	coalesce(cd_local_entrega,cd_local_estoque_p), 
	cd_estabelecimento, 
	cd_pessoa_fisica, 
	cd_cgc_fornecedor 
into STRICT	cd_local_estoque_w, 
	cd_estabelecimento_w, 
	cd_pessoa_fisica_w, 
	cd_pessoa_juridica_w 
from	ordem_compra 
where	nr_ordem_compra = nr_ordem_compra_p;
exception 
when others then 
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(245117);
end;
 
select	nextval('emprestimo_seq') 
into STRICT	nr_emprestimo_w
;
 
insert into emprestimo( 
	nr_emprestimo, 
	cd_estabelecimento, 
	cd_local_estoque, 
	ie_tipo, 
	dt_emprestimo, 
	dt_atualizacao, 
	nm_usuario, 
	cd_pessoa_juridica, 
	cd_pessoa_fisica, 
	nr_documento, 
	nm_usuario_resp, 
	dt_prev_retorno, 
	ie_situacao) 
values (	nr_emprestimo_w, 
	cd_estabelecimento_w, 
	cd_local_estoque_w, 
	'E', 
	clock_timestamp(), 
	clock_timestamp(), 
	nm_usuario_p, 
	cd_pessoa_juridica_w, 
	cd_pessoa_fisica_w, 
	nr_ordem_compra_p, 
	nm_usuario_p, 
	dt_retorno_p, 
	'A');
 
	open C01;
	loop 
	fetch C01 into	 
		nr_item_oci_w, 
		cd_material_w, 
		vl_unitario_material_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		 
		select	sum(qt_prevista_entrega) - sum(coalesce(qt_real_entrega,0)) 
		into STRICT	qt_material_w 
		from	ordem_compra_item_entrega 
		where	nr_ordem_compra = nr_ordem_compra_p 
		and	nr_item_oci = nr_item_oci_w 
		and	coalesce(dt_cancelamento::text, '') = '';
		 
		if (qt_material_w > 0) then 
 
			select	coalesce(max(nr_sequencia),0) +1 
			into STRICT	nr_sequencia_w 
			from	emprestimo_material 
			where	nr_emprestimo = nr_emprestimo_w;
		 
			insert into emprestimo_material( 
				nr_sequencia, 
				nr_emprestimo, 
				cd_material, 
				qt_material, 
				dt_atualizacao, 
				nm_usuario, 
				qt_emprestimo, 
				vl_referencia, 
				nr_ordem_compra, 
				nr_item_oci) 
			values (	nr_sequencia_w, 
				nr_emprestimo_w, 
				cd_material_w, 
				qt_material_w, 
				clock_timestamp(), 
				nm_usuario_p, 
				qt_material_w, 
				vl_unitario_material_w, 
				nr_ordem_compra_p, 
				nr_item_oci_w);
		end if;
		end;
	end loop;
	close C01;	
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_emprestimo_ordem_compra ( nr_ordem_compra_p bigint, cd_local_estoque_p bigint, dt_retorno_p timestamp, nm_usuario_p text) FROM PUBLIC;

