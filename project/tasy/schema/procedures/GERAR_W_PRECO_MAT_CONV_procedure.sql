-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_preco_mat_conv ( cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, dt_vigencia_p timestamp) AS $body$
DECLARE

 
cd_material_w			integer;
cd_categoria_w			varchar(10);
vl_material_w			double precision;
pr_margem_w			double precision;
pr_margem_cm_w			double precision;
dt_vigencia_w			timestamp;
cd_tab_peco_mat_w 		smallint;
ie_origem_preco_w 		smallint;
vl_preco_ult_compra_w		double precision;
vl_custo_medio_w		double precision := 0;
nr_seq_bras_preco_w		bigint;
nr_seq_mat_bras_w		bigint;
nr_seq_conv_bras_w		bigint;
nr_seq_conv_simpro_w		bigint;
nr_seq_mat_simpro_w		bigint;
nr_seq_simpro_preco_w		bigint;
nr_seq_ajuste_mat_w		bigint;

c01 CURSOR FOR 
	SELECT	cd_categoria 
	from	categoria_convenio 
	where	cd_convenio	= cd_convenio_p;

c02 CURSOR FOR 
	SELECT		cd_material 
	from		estrutura_material_v 
	where		ie_situacao 	= 'A' 
	and		coalesce(cd_grupo_material_p, cd_grupo_material)		= cd_grupo_material 
	and		coalesce(cd_subgrupo_material_p, cd_subgrupo_material) 	= cd_subgrupo_material 
	and		coalesce(cd_classe_material_p, cd_classe_material)		= cd_classe_material 
	order by 	cd_material;


BEGIN 
 
CALL Exec_sql_Dinamico('Gerar_W_Preco_Material', 'truncate table w_preco_material');
 
open	c01;
loop 
fetch	c01 into cd_categoria_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
 
	open C02;
	loop 
	fetch 	C02 into cd_material_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
	 
		SELECT * FROM define_preco_material(	cd_estabelecimento_p, cd_convenio_p, cd_categoria_w, dt_vigencia_p, cd_material_w, 0, 0, 0, '', 0, 0, null, null, null, null, null, null, null, null, vl_material_w, dt_vigencia_w, cd_tab_peco_mat_w, ie_origem_preco_w, nr_seq_bras_preco_w, nr_seq_mat_bras_w, nr_seq_conv_bras_w, nr_seq_conv_simpro_w, nr_seq_mat_simpro_w, nr_seq_simpro_preco_w, nr_seq_ajuste_mat_w) INTO STRICT vl_material_w, dt_vigencia_w, cd_tab_peco_mat_w, ie_origem_preco_w, nr_seq_bras_preco_w, nr_seq_mat_bras_w, nr_seq_conv_bras_w, nr_seq_conv_simpro_w, nr_seq_mat_simpro_w, nr_seq_simpro_preco_w, nr_seq_ajuste_mat_w;
 
		select 	Obter_Valor_Ultima_Compra(cd_estabelecimento_p, null, cd_material_w, null, 'N') 
		into STRICT 	vl_preco_ult_compra_w 
		;
 
		insert into w_preco_material( 
			cd_convenio, cd_categoria, cd_material, 
			dt_ultima_vigencia, vl_preco_venda, 
			vl_preco_ult_compra, vl_custo_medio, 
			pr_margem, pr_margem_cm) 
		values (	 
			cd_convenio_p, cd_categoria_w, cd_material_w, 
			dt_vigencia_p, vl_material_w, 
			vl_preco_ult_compra_w, vl_custo_medio_w, 
			0, 0);
	 
		end;
	end loop;
	close C02;
	end;
end loop;
close c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_preco_mat_conv ( cd_estabelecimento_p bigint, cd_convenio_p bigint, cd_grupo_material_p bigint, cd_subgrupo_material_p bigint, cd_classe_material_p bigint, dt_vigencia_p timestamp) FROM PUBLIC;

