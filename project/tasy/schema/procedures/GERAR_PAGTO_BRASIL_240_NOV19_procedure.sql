-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_pagto_brasil_240_nov19 ( nr_seq_envio_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* PADRAO CNAB 240 VERSAO 084 DE 07/2010 GERADA A PARTIR DA HCB_ GERAR_PAGTO_BRASIL_240*/

ds_conteudo_w		varchar(240);
cd_estabelecimento_w	smallint;
nr_seq_apres_w		bigint	:= 0;
cd_banco_hosp_w		smallint;

/* header de arquivo */

cd_agencia_estab_w	varchar(6);
cd_cgc_estab_w		varchar(14);
cd_convenio_banco_w	varchar(20);
dt_geracao_w		varchar(14);
nm_empresa_w		varchar(30);
nr_conta_estab_w	varchar(12);
nr_remessa_w		bigint;
ie_digito_estab_w	varchar(1);

/* header de lote - DOC */

nr_lote_servico_w	bigint;
ie_forma_lanc_w		varchar(2);
ie_tipo_pagamento_w	varchar(3);
ie_finalidade_w		varchar(3);
ds_endereco_w		varchar(30);
nr_endereco_w		varchar(5);
ds_complemento_w	varchar(15);
ds_municipio_w		varchar(20);
nr_cep_w		varchar(8);
sg_estado_w		varchar(15);

c01 CURSOR FOR
SELECT	distinct
	CASE WHEN b.ie_tipo_pagamento='CC' THEN '01' WHEN b.ie_tipo_pagamento='DOC' THEN CASE WHEN b.cd_banco=cd_banco_hosp_w THEN '01'  ELSE '03' END  WHEN b.ie_tipo_pagamento='TED' THEN '41' WHEN b.ie_tipo_pagamento='OP' THEN 30 END ,
	b.ie_tipo_pagamento,
	CASE WHEN b.ie_tipo_pagamento='TED' THEN '018'  ELSE '700' END
from	titulo_pagar_escrit b,
	banco_escritural a
where	b.ie_tipo_pagamento	in ('DOC','CC','OP','TED')
and	a.nr_sequencia		= b.nr_seq_escrit
and	a.nr_sequencia		= nr_seq_envio_p;

/* detalhe - DOC */

nr_sequencia_w		bigint;
cd_camara_compensacao_w	varchar(3);
cd_banco_w		varchar(3);
cd_agencia_bancaria_w	varchar(6);
nr_conta_w		varchar(20);
nm_pessoa_w		varchar(30);
nr_titulo_w		bigint;
dt_remessa_retorno_w	timestamp;
vl_escritural_w		double precision;
vl_acrescimo_w		double precision;
vl_desconto_w		double precision;
vl_despesa_w		double precision;
ie_tipo_inscricao_w	varchar(1);
nr_inscricao_w		varchar(15);
dt_vencimento_w		timestamp;
vl_juros_w		double precision;
vl_multa_w		double precision;
cd_agencia_conta_w	varchar(20);
ie_digito_conta_w	varchar(1);
ds_endereco_det_w	varchar(30);
nr_endereco_det_w	varchar(5);
ds_complemento_det_w	varchar(15);
ds_municipio_det_w	varchar(20);
nr_cep_det_w		varchar(8);
sg_estado_det_w		varchar(2);
ds_bairro_det_w		varchar(15);
ie_tipo_titulo_w	titulo_pagar.ie_tipo_titulo%type;

c02 CURSOR FOR
SELECT	coalesce(coalesce((select	x.cd_banco_externo
	from	banco x
	where	x.cd_banco	= b.cd_banco),to_char(b.cd_banco)),'000') cd_banco,
	lpad(substr(somente_numero(coalesce(b.cd_agencia_bancaria,'0')),1,5) || substr(trim(both coalesce(b.ie_digito_agencia,'0')),1,1),6,'0'),
	rpad(upper(elimina_acentuacao(substr(obter_nome_pf_pj(c.cd_pessoa_fisica,c.cd_cgc),1,30))),30,' '),
	c.nr_titulo,
	b.vl_escritural,
	b.vl_acrescimo,
	b.vl_desconto,
	b.vl_despesa,
	lpad(coalesce(d.nr_cpf,c.cd_cgc),14,'0'),
	coalesce(b.nr_conta,'0'),
	substr(coalesce(b.ie_digito_conta,'0'),1,1),
	c.dt_vencimento_atual,
	b.vl_juros,
	b.vl_multa,
	CASE WHEN coalesce(c.cd_pessoa_fisica::text, '') = '' THEN '2'  ELSE '1' END  ie_tipo_inscricao,
	rpad(coalesce(upper(elimina_acentuacao(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'R'),1,30))),' '),30,' '),
	lpad(coalesce(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'NR'),1,5),'0'),5,'0'),
	rpad(coalesce(upper(elimina_acentuacao(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'CO'),1,15))),' '),15,' '),
	rpad(coalesce(upper(elimina_acentuacao(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'CI'),1,20))),' '),20,' '),
	lpad(coalesce(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'CEP'),1,8),'0'),8,'0'),
	rpad(coalesce(upper(elimina_acentuacao(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'UF'),1,2))),' '),2,' '),
	rpad(coalesce(upper(elimina_acentuacao(substr(obter_dados_pf_pj(c.cd_pessoa_fisica,c.cd_cgc,'B'),1,15))),' '),15,' ')
FROM titulo_pagar_escrit b, banco_escritural a, titulo_pagar c
LEFT OUTER JOIN pessoa_fisica d ON (c.cd_pessoa_fisica = d.cd_pessoa_fisica)
WHERE ie_forma_lanc_w		= CASE WHEN b.ie_tipo_pagamento='CC' THEN '01' WHEN b.ie_tipo_pagamento='DOC' THEN CASE WHEN b.cd_banco=cd_banco_hosp_w THEN '01'  ELSE '03' END  WHEN b.ie_tipo_pagamento='TED' THEN '41' WHEN b.ie_tipo_pagamento='OP' THEN 30 END  and b.nr_titulo		= c.nr_titulo and b.ie_tipo_pagamento	= ie_tipo_pagamento_w and a.nr_sequencia		= b.nr_seq_escrit and a.nr_sequencia		= nr_seq_envio_p;

/* trailer lote - DOC */

vl_total_w		double precision;

/* header de lote - BLQ */

c03 CURSOR FOR
SELECT	distinct
	CASE WHEN b.cd_banco=cd_banco_hosp_w THEN '30'  ELSE '31' END ,
	b.ie_tipo_pagamento
from	titulo_pagar_escrit b,
	banco_escritural a
where	b.ie_tipo_pagamento	= 'BLQ'
and	a.nr_sequencia		= b.nr_seq_escrit
and	a.nr_sequencia		= nr_seq_envio_p;

/* detalhe - BLQ */

nr_bloqueto_w		varchar(44);
nr_nosso_numero_w	varchar(20);
ie_tipo_identificacao_w	varchar(1);

c04 CURSOR FOR
SELECT	rpad(upper(elimina_acentuacao(substr(obter_nome_pf_pj(c.cd_pessoa_fisica,c.cd_cgc),1,30))),30,' '),
	c.nr_titulo,
	b.vl_escritural,
	b.vl_acrescimo,
	b.vl_desconto,
	b.vl_despesa,
	c.dt_vencimento_atual,
	b.vl_juros,
	b.vl_multa,
	rpad(substr(c.nr_bloqueto,1,44),44,' '),
	--rpad(nvl(substr(converte_codigo_bloqueto('Lido_Barra',c.nr_bloqueto),1,44),' '),44,' '),
	rpad(coalesce(substr(c.nr_nosso_numero,1,20),' '),20,' '),
	c.ie_tipo_titulo,
	CASE WHEN coalesce(c.cd_cgc::text, '') = '' THEN '1'  ELSE '2' END  ie_tipo_identificacao,
	lpad(coalesce(c.cd_cgc,d.nr_cpf),15,'0') nr_inscricao
FROM titulo_pagar_escrit b, banco_escritural a, titulo_pagar c
LEFT OUTER JOIN pessoa_fisica d ON (c.cd_pessoa_fisica = d.cd_pessoa_fisica)
WHERE ie_forma_lanc_w		= CASE WHEN b.cd_banco=cd_banco_hosp_w THEN '30'  ELSE '31' END and b.nr_titulo		= c.nr_titulo and b.ie_tipo_pagamento	= ie_tipo_pagamento_w and a.nr_sequencia		= b.nr_seq_escrit and a.nr_sequencia		= nr_seq_envio_p;

/* trailer do arquivo */

qt_registro_w		bigint;


BEGIN

delete	from w_envio_banco
where	nm_usuario	= nm_usuario_p;

/* header de arquivo */

nr_seq_apres_w		:= coalesce(nr_seq_apres_w,0) + 1;

select	coalesce((select	somente_numero(coalesce(max(x.cd_banco_externo),to_char(c.cd_banco)))
	from	banco x
	where	x.cd_banco	= c.cd_banco), c.cd_banco),
	lpad(b.cd_cgc,14,'0'),
	lpad(substr(coalesce(c.cd_convenio_banco,' '),1,9)||'0126       ',20,'0'),
	lpad(substr(elimina_caractere_especial(c.cd_agencia_bancaria),1,5) || substr(elimina_caractere_especial(d.ie_digito),1,1),6,'0'),
	lpad(somente_numero(substr(c.cd_conta,1,12)),12,'0'),
	rpad(upper(elimina_acentuacao(substr(obter_dados_pf_pj(null,b.cd_cgc,'N'),1,30))),30,' '),
	to_char(clock_timestamp(),'ddmmyyyyhhmiss'),
	coalesce(a.nr_remessa,a.nr_sequencia),
	b.cd_estabelecimento,
	a.dt_remessa_retorno,
	rpad(coalesce(upper(elimina_acentuacao(substr(obter_dados_pf_pj(null,b.cd_cgc,'R'),1,30))),' '),30,' '),
	lpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'NR'),1,5),'0'),5,'0'),
	rpad(coalesce(upper(elimina_acentuacao(substr(obter_dados_pf_pj(null,b.cd_cgc,'CO'),1,15))),' '),15,' '),
	rpad(coalesce(upper(elimina_acentuacao(substr(obter_dados_pf_pj(null,b.cd_cgc,'CI'),1,20))),' '),20,' '),
	lpad(coalesce(substr(obter_dados_pf_pj(null,b.cd_cgc,'CEP'),1,8),'0'),8,'0'),
	rpad(coalesce(upper(elimina_acentuacao(substr(obter_dados_pf_pj(null,b.cd_cgc,'UF'),1,2))),' '),2,' '),
	coalesce(c.ie_digito_conta,'0')
into STRICT	cd_banco_hosp_w,
	cd_cgc_estab_w,
	cd_convenio_banco_w,
	cd_agencia_estab_w,
	nr_conta_estab_w,
	nm_empresa_w,
	dt_geracao_w,
	nr_remessa_w,
	cd_estabelecimento_w,
	dt_remessa_retorno_w,
	ds_endereco_w,
	nr_endereco_w,
	ds_complemento_w,
	ds_municipio_w,
	nr_cep_w,
	sg_estado_w,
	ie_digito_estab_w
from	agencia_bancaria d,
	banco_estabelecimento c,
	estabelecimento b,
	banco_escritural a
where	c.cd_banco			= d.cd_banco
and	c.cd_agencia_bancaria	= d.cd_agencia_bancaria
and	a.nr_seq_conta_banco	= c.nr_sequencia
and	a.cd_estabelecimento	= b.cd_estabelecimento
and	a.nr_sequencia			= nr_seq_envio_p;

ds_conteudo_w	:=	lpad(cd_banco_hosp_w,3,'0')	|| --   1 3
			'0000' 								|| --   4 7
			'0' 								|| --   8 8
			rpad(' ',9,' ') 					|| --   9 17
			'2' 								|| --  18 18
			cd_cgc_estab_w 						|| --  19 32
			cd_convenio_banco_w 				|| --  33 52
			cd_agencia_estab_w 					|| --  53 58
			nr_conta_estab_w					|| --  59 70
			ie_digito_estab_w 					|| --  71 71
			'0' 								|| --  72 72 
			nm_empresa_w 						|| --  73 102
			rpad('BANCO DO BRASIL',30,' ') 		|| -- 103 132
			rpad(' ',10,' ') 					|| -- 133 142
			'1' 								|| -- 143 143
			dt_geracao_w 						|| -- 144 151 /
			lpad(nr_remessa_w,6,'0')			|| -- 152 157 / 158 163
			'084' 								|| -- 164 166
			'00000' 							|| -- 167 171
			rpad(' ',19,' ')					|| -- 172 191
			rpad(' ',20,' ')					|| -- 192 211
			'            '						|| -- 212 222 -- Esta parte nAo consta no layout
			'   '								|| -- 223 225
			'000'								|| -- 226 228
			'00'								|| -- 229 230
			'0000000000';						   -- 231 240
			

insert	into w_envio_banco(cd_estabelecimento,
	ds_conteudo,
	dt_atualizacao,
	nm_usuario,
	nr_seq_apres,
	nr_seq_apres_2,
	nr_sequencia)
values (cd_estabelecimento_w,
	ds_conteudo_w,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_apres_w,
	nr_seq_apres_w,
	nextval('w_envio_banco_seq'));

open	c01;
loop
fetch	c01 into
	ie_forma_lanc_w,
	ie_tipo_pagamento_w,
	ie_finalidade_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	/* header de lote */

	nr_lote_servico_w	:= coalesce(nr_lote_servico_w,0) + 1;
	nr_seq_apres_w		:= coalesce(nr_seq_apres_w,0) + 1;
	nr_sequencia_w		:= 0;
	vl_total_w			:= 0;

	ds_conteudo_w	:=	lpad(cd_banco_hosp_w,3,'0')	|| --  1 3
				lpad(nr_lote_servico_w,4,'0')		|| --  4 7
				'1' 								|| --  8 8
				'C' 								|| --  9 9
				'20' 								|| -- 10 11
				ie_forma_lanc_w						|| -- 12 13
				'043'								|| -- 14 16
				' '									|| -- 17 17 
				'2'									|| -- 18 18
				cd_cgc_estab_w 						|| -- 19 32
				cd_convenio_banco_w 				|| -- 33 52
				cd_agencia_estab_w 					|| -- 53 58
				nr_conta_estab_w					|| -- 59 70
				ie_digito_estab_w 					|| -- 71 71
				'0' 								|| -- 72 72 
				nm_empresa_w 						|| -- 73 102
				rpad(' ',40,' ')					|| --103 142
				ds_endereco_w						|| --143 172
				nr_endereco_w						|| --173 177
				ds_complemento_w					|| --178 192
				ds_municipio_w						|| --193 212
				nr_cep_w							|| --213 217  - 218 220
				substr(sg_estado_w,1,2)				|| --221 222 
				rpad(' ',8,' ')			 			|| --223 230  
				rpad('0',10,'0');		 			   --231 240
				
	insert	into w_envio_banco(cd_estabelecimento,
		ds_conteudo,
		dt_atualizacao,
		nm_usuario,
		nr_seq_apres,
		nr_seq_apres_2,
		nr_sequencia)
	values (cd_estabelecimento_w,
		ds_conteudo_w,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_apres_w,
		nr_seq_apres_w,
		nextval('w_envio_banco_seq'));

	open	c02;
	loop
	fetch	c02 into
		cd_banco_w,
		cd_agencia_bancaria_w,
		nm_pessoa_w,
		nr_titulo_w,
		vl_escritural_w,
		vl_acrescimo_w,
		vl_desconto_w,
		vl_despesa_w,
		nr_inscricao_w,
		nr_conta_w,
		ie_digito_conta_w,
		dt_vencimento_w,
		vl_juros_w,
		vl_multa_w,
		ie_tipo_inscricao_w,
		ds_endereco_det_w,
		nr_endereco_det_w,
		ds_complemento_det_w,
		ds_municipio_det_w,
		nr_cep_det_w,
		sg_estado_det_w,
		ds_bairro_det_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */

		/* segmento A */

		nr_lote_servico_w	:= coalesce(nr_lote_servico_w,0);
		nr_sequencia_w		:= coalesce(nr_sequencia_w,0) + 1;
		nr_seq_apres_w		:= coalesce(nr_seq_apres_w,0) + 1;
		qt_registro_w		:= coalesce(qt_registro_w,0) + 1;
		vl_total_w		:= coalesce(vl_total_w,0) + (coalesce(vl_escritural_w,0) - coalesce(vl_desconto_w,0) + coalesce(vl_acrescimo_w,0) + coalesce(vl_despesa_w,0));

		ds_conteudo_w	:=	lpad(cd_banco_hosp_w,3,'0')			|| --  1 3
					lpad(nr_lote_servico_w,4,'0')				|| --  4 7
					'3'											|| --  8 8
					lpad(nr_sequencia_w,5,'0')					|| --  9 13
					'A'											|| -- 14 14
					'000'										|| -- 15 17
					ie_finalidade_w								|| -- 18 20
					lpad(cd_banco_w,3,'0')						|| -- 21 23
					lpad(cd_agencia_bancaria_w,6,'0')			|| -- 24 28 / 29 29
					lpad(substr(nr_conta_w,1,12),12,'0')		|| -- 30 41
					ie_digito_conta_w 							|| -- 42 42
					' ' 										|| -- 43 43
					nm_pessoa_w									|| -- 44 73
					lpad(nr_titulo_w,20,' ')					|| -- 74 93
					to_char(dt_remessa_retorno_w,'ddmmyyyy')	|| -- 94 101
					'BRL'										|| --102 104
					'000000000000000'							|| --105 119
					lpad(somente_numero(to_char(coalesce(vl_escritural_w,0) - coalesce(vl_desconto_w,0) + coalesce(vl_acrescimo_w,0) + coalesce(vl_despesa_w,0),'9999999999990.00')),15,'0') || -- 120 134
					rpad(' ',20,' ')							|| --135 154
					'00000000'									|| --155 162
					'000000000000000'							|| --163 177
					rpad(' ',40,' ')							|| --178 217  
					'  '										|| --218 219  
					'     '										|| --220 224
					'  '										|| --225 226
					'   '										|| --227 229
					'0' 										|| --230 230
					rpad('0',10,'0');							   --231 240
		insert	into w_envio_banco(cd_estabelecimento,
			ds_conteudo,
			dt_atualizacao,
			nm_usuario,
			nr_seq_apres,
			nr_seq_apres_2,
			nr_sequencia)
		values (cd_estabelecimento_w,
			ds_conteudo_w,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_apres_w,
			nr_seq_apres_w,
			nextval('w_envio_banco_seq'));

		/* segmento B */

		nr_lote_servico_w	:= coalesce(nr_lote_servico_w,0);
		nr_sequencia_w		:= coalesce(nr_sequencia_w,0) + 1;
		nr_seq_apres_w		:= coalesce(nr_seq_apres_w,0) + 1;
		qt_registro_w		:= coalesce(qt_registro_w,0) + 1;

		ds_conteudo_w	:=	lpad(cd_banco_hosp_w,3,'0')		|| --  1 3
					lpad(nr_lote_servico_w,4,'0')			|| --  4 7
					'3'										|| --  8 8
					lpad(nr_sequencia_w,5,'0')				|| --  9 13
					'B'										|| -- 14 14
					rpad(' ',3,' ')							|| -- 15 17
					ie_tipo_inscricao_w 					|| -- 18 18
					nr_inscricao_w 							|| -- 19 32
					ds_endereco_det_w						|| -- 33 62
					nr_endereco_det_w						|| -- 63 67
					ds_complemento_det_w					|| -- 68 82
					ds_bairro_det_w 						|| -- 83 97
					ds_municipio_det_w						|| -- 98 117
					nr_cep_det_w 							|| --118 122 - 123 125
					sg_estado_det_w 						|| --126 127
					to_char(dt_vencimento_w,'ddmmyyyy') 	|| --128 135
					lpad(somente_numero(to_char(coalesce(vl_escritural_w,0),'9999999999990.00')),15,'0') 	|| --136 150 
					'000000000000000' 						|| --151 165
					lpad(somente_numero(to_char(coalesce(vl_desconto_w,0),'9999999999990.00')),15,'0')		|| --166 180
					lpad(somente_numero(to_char(coalesce(vl_juros_w,0),'9999999999990.00')),15,'0') 			|| --181 195
					lpad(somente_numero(to_char(coalesce(vl_multa_w,0),'9999999999990.00')),15,'0')			|| --196 210
					rpad(' ',15,' ')						|| --211 225
					'0' 									|| --226 226
					rpad('0',6,'0')							|| --227 232
					rpad(' ',6,' ');						   --233 240
		insert	into w_envio_banco(cd_estabelecimento,
			ds_conteudo,
			dt_atualizacao,
			nm_usuario,
			nr_seq_apres,
			nr_seq_apres_2,
			nr_sequencia)
		values (cd_estabelecimento_w,
			ds_conteudo_w,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_apres_w,
			nr_seq_apres_w,
			nextval('w_envio_banco_seq'));

	end	loop;
	close	c02;

	/* trailer de lote */

	nr_lote_servico_w	:= coalesce(nr_lote_servico_w,0);
	nr_seq_apres_w		:= coalesce(nr_seq_apres_w,0) + 1;

	ds_conteudo_w	:=	lpad(cd_banco_hosp_w,3,'0') 	|| --   1 3
				lpad(nr_lote_servico_w,4,'0') 			|| --   4 7
				'5' 									|| --   8 8 
				rpad(' ',9,' ') 						|| --   9 17
				lpad(nr_sequencia_w + 2,6,'0') 			|| --  18 23
				lpad(somente_numero(to_char(coalesce(vl_total_w,0),'9999999999999990.00')),18,'0') 	|| --  24 41
				'000000000000000000' 					|| --  42 59
				rpad('0',6,'0') 						|| --  60 65
				rpad(' ',165,' ') 						|| --  66 230
				rpad('0',10,'0'); 						   -- 230 240
	insert	into w_envio_banco(cd_estabelecimento,
		ds_conteudo,
		dt_atualizacao,
		nm_usuario,
		nr_seq_apres,
		nr_seq_apres_2,
		nr_sequencia)
	values (cd_estabelecimento_w,
		ds_conteudo_w,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_apres_w,
		nr_seq_apres_w,
		nextval('w_envio_banco_seq'));

end	loop;
close	c01;

open	c03;
loop
fetch	c03 into
	ie_forma_lanc_w,
	ie_tipo_pagamento_w;
EXIT WHEN NOT FOUND; /* apply on c03 */

	/* header de lote - BLQ */

	nr_lote_servico_w	:= coalesce(nr_lote_servico_w,0) + 1;
	nr_seq_apres_w		:= coalesce(nr_seq_apres_w,0) + 1;
	nr_sequencia_w		:= 0;
	vl_total_w			:= 0;

	ds_conteudo_w	:=	lpad(cd_banco_hosp_w,3,'0')	|| --  1 3
				lpad(nr_lote_servico_w,4,'0')		|| --  4 7
				'1' 								|| --  8 8
				'C' 								|| --  9 9
				'98' 								|| -- 10 11
				ie_forma_lanc_w						|| -- 12 13
				'030'								|| -- 14 16
				' '									|| -- 17 17 
				'2'									|| -- 18 18
				cd_cgc_estab_w 						|| -- 19 32
				cd_convenio_banco_w 				|| -- 33 52
				cd_agencia_estab_w 					|| -- 53 58
				nr_conta_estab_w					|| -- 59 70
				ie_digito_estab_w 					|| -- 71 71
				'0' 								|| -- 72 72 
				nm_empresa_w 						|| -- 73 102
				rpad(' ',40,' ')					|| --103 142
				ds_endereco_w						|| --143 172
				nr_endereco_w						|| --173 177
				ds_complemento_w					|| --178 192
				ds_municipio_w						|| --193 212
				nr_cep_w							|| --213 217  - 218 220
				substr(sg_estado_w,1,2)				|| --221 222 
				rpad(' ',8,' ') 					|| --223 230  
				rpad('0',10,'0'); 					   --231 240
	insert	into w_envio_banco(cd_estabelecimento,
		ds_conteudo,
		dt_atualizacao,
		nm_usuario,
		nr_seq_apres,
		nr_seq_apres_2,
		nr_sequencia)
	values (cd_estabelecimento_w,
		ds_conteudo_w,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_apres_w,
		nr_seq_apres_w,
		nextval('w_envio_banco_seq'));

	open	c04;
	loop
	fetch	c04 into
		nm_pessoa_w,
		nr_titulo_w,
		vl_escritural_w,
		vl_acrescimo_w,
		vl_desconto_w,
		vl_despesa_w,
		dt_vencimento_w,
		vl_juros_w,
		vl_multa_w,
		nr_bloqueto_w,
		nr_nosso_numero_w,
		ie_tipo_titulo_w,
		ie_tipo_identificacao_w,
		nr_inscricao_w;
	EXIT WHEN NOT FOUND; /* apply on c04 */

		nr_lote_servico_w	:= coalesce(nr_lote_servico_w,0);
		nr_sequencia_w		:= coalesce(nr_sequencia_w,0) + 1;
		nr_seq_apres_w		:= coalesce(nr_seq_apres_w,0) + 1;
		qt_registro_w		:= coalesce(qt_registro_w,0) + 1;
		vl_total_w			:= coalesce(vl_total_w,0) + (coalesce(vl_escritural_w,0) - coalesce(vl_desconto_w,0) + coalesce(vl_acrescimo_w,0) + coalesce(vl_despesa_w,0));
		
		if ie_tipo_titulo_w = 16 then
			/* segmento W*/

			ds_conteudo_w	:=	lpad(cd_banco_hosp_w,3,'0')		|| --  1 3
						lpad(nr_lote_servico_w,4,'0') 			|| --  4 7
						'3' 									|| --  8 8
						lpad(nr_sequencia_w,5,'0') 				|| --  9 13
						'W' 									|| -- 14 14
						'0 ' 									|| -- 15 15 / 16 16
						rpad(' ',80,' ')						|| -- 17 96
						rpad(' ',80,' ')						|| -- 97 176
						'01'									|| --177 178
						rpad(' ',48,' ')						|| --179 228
						'  '									|| --229 230
						rpad('0',10,'0');						   --231 240
			insert	into w_envio_banco(cd_estabelecimento,
				ds_conteudo,
				dt_atualizacao,
				nm_usuario,
				nr_seq_apres,
				nr_seq_apres_2,
				nr_sequencia)
			values (cd_estabelecimento_w,
				ds_conteudo_w,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_apres_w,
				nr_seq_apres_w,
				nextval('w_envio_banco_seq'));
		else
			/* segmento J */

			ds_conteudo_w	:=	lpad(cd_banco_hosp_w,3,'0')		|| --  1 3
						lpad(nr_lote_servico_w,4,'0') 			|| --  4 7
						'3' 									|| --  8 8
						lpad(nr_sequencia_w,5,'0') 				|| --  9 13
						'J' 									|| -- 14 14
						'000' 									|| -- 15 15 / 16 17
						nr_bloqueto_w 							|| -- 18 61
						nm_pessoa_w 							|| -- 62 91
						to_char(dt_vencimento_w,'ddmmyyyy') 	|| -- 92 99
						lpad(somente_numero(to_char(coalesce(vl_escritural_w,0),'9999999999990.00')),15,'0') 				|| --100 114 
						lpad(somente_numero(to_char(coalesce(vl_desconto_w,0),'9999999999990.00')),15,'0')					|| --115 129 
						lpad(somente_numero(to_char(coalesce(vl_multa_w,0) + coalesce(vl_juros_w,0),'9999999999990.00')),15,'0') 	|| --130 144
						to_char(dt_remessa_retorno_w,'ddmmyyyy')														|| --145 152
						lpad(somente_numero(to_char(coalesce(vl_escritural_w,0) - coalesce(vl_desconto_w,0) + coalesce(vl_acrescimo_w,0) + coalesce(vl_despesa_w,0),'9999999999990.00')),15,'0') || --153 167
						'000000000000000'						|| --168 182
						rpad(nr_titulo_w,20,' ') 				|| --183 202
						rpad(nr_nosso_numero_w,20,' ') 			|| --203 222
						'09' 									|| --223 224 
						'      '								|| --225 230
						rpad('0',10,'0');						   --231 240
			insert	into w_envio_banco(cd_estabelecimento,
				ds_conteudo,
				dt_atualizacao,
				nm_usuario,
				nr_seq_apres,
				nr_seq_apres_2,
				nr_sequencia)
			values (cd_estabelecimento_w,
				ds_conteudo_w,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_apres_w,
				nr_seq_apres_w,
				nextval('w_envio_banco_seq'));
				
					
			/* Para titulos com valor igual ou superior a 250.000,00 o segmento J52 e obrigatorio */

			--if (nvl(vl_escritural_w,0) >= 250000) then
			nr_sequencia_w	:= coalesce(nr_sequencia_w,0) + 1;
			nr_seq_apres_w	:= coalesce(nr_seq_apres_w,0) + 1;
			qt_registro_w	:= coalesce(qt_registro_w,0) + 1;

			ds_conteudo_w	:=	lpad(cd_banco_hosp_w,3,'0')		|| --  1 3
						lpad(nr_lote_servico_w,4,'0')			|| --  4 7 
						'3'										|| --  8 8
						lpad(nr_sequencia_w,5,'0')				|| --  9 13 
						'J'										|| -- 14 14
						' '										|| -- 15 15
						rpad('0',2,'0') 						|| -- 16 17
						'52' 									|| -- 18 19
						'2' 									|| -- 20 20
						lpad(cd_cgc_estab_w,15,'0')				|| -- 21 35
						rpad(nm_empresa_w,40,' ')				|| -- 36 75
						ie_tipo_identificacao_w					|| -- 76 76
						lpad(nr_inscricao_w,15,'0')				|| -- 77 91
						rpad(nm_pessoa_w,40,' ')				|| -- 92 131
						'0'										|| --132 132
						rpad('0',15,'0')						|| --133 147
						rpad(' ',40,' ')						|| --148 187
						rpad(' ',53,' ');                          --188 240
							
			
			insert	into w_envio_banco(cd_estabelecimento,
				ds_conteudo,
				dt_atualizacao,
				nm_usuario,
				nr_seq_apres,
				nr_seq_apres_2,
				nr_sequencia)
			values (cd_estabelecimento_w,
				ds_conteudo_w,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_apres_w,
				nr_seq_apres_w,
				nextval('w_envio_banco_seq'));			
		end if;
	end	loop;
	close	c04;
	
				

	/* trailer de lote */

	nr_lote_servico_w	:= coalesce(nr_lote_servico_w,0);
	nr_seq_apres_w		:= coalesce(nr_seq_apres_w,0) + 1;

	ds_conteudo_w	:=	lpad(cd_banco_hosp_w,3,'0') 	|| --   1 3
				lpad(nr_lote_servico_w,4,'0') 			|| --   4 7
				'5' 									|| --   8 8 
				rpad(' ',9,' ') 						|| --   9 17
				lpad(nr_sequencia_w + 2,6,'0') 			|| --  18 23
				lpad(somente_numero(to_char(coalesce(vl_total_w,0),'9999999999999990.00')),18,'0') 	|| --  24 41
				'000000000000000000' 					|| --  42 59
				rpad('0',6,'0') 						|| --  60 65
				rpad(' ',165,' ') 						|| --  66 230
				rpad('0',10,'0'); 						   -- 230 240
	insert	into w_envio_banco(cd_estabelecimento,
		ds_conteudo,
		dt_atualizacao,
		nm_usuario,
		nr_seq_apres,
		nr_seq_apres_2,
		nr_sequencia)
	values (cd_estabelecimento_w,
		ds_conteudo_w,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_apres_w,
		nr_seq_apres_w,
		nextval('w_envio_banco_seq'));

end	loop;
close	c03;

/* trailer de arquivo */

nr_lote_servico_w	:= coalesce(nr_lote_servico_w,0);
nr_seq_apres_w		:= coalesce(nr_seq_apres_w,0) + 1;

ds_conteudo_w	:=	lpad(cd_banco_hosp_w,3,'0')		|| --  1 3 
			'9999'									|| --  4 7
			'9'										|| --  8 8
			rpad(' ',9,' ')							|| --  9 17
			lpad(nr_lote_servico_w,6,'0')			|| -- 18 23
			lpad(coalesce(qt_registro_w,0) + (coalesce(nr_lote_servico_w,0) * 2) + 2,6,'0') ||	--  24 29 registros detalhe + header e trailer dos lotes + header e trailer do arquivo 
			'000000'								|| -- 30 35
			rpad(' ',205,' ');					   	   -- 36 240
insert	into w_envio_banco(cd_estabelecimento,
	ds_conteudo,
	dt_atualizacao,
	nm_usuario,
	nr_seq_apres,
	nr_seq_apres_2,
	nr_sequencia)
values (cd_estabelecimento_w,
	ds_conteudo_w,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_apres_w,
	nr_seq_apres_w,
	nextval('w_envio_banco_seq'));

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_pagto_brasil_240_nov19 ( nr_seq_envio_p bigint, nm_usuario_p text) FROM PUBLIC;

