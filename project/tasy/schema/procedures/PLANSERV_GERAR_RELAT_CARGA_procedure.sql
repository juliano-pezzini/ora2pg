-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE planserv_gerar_relat_carga ( cd_versao_p text, ie_tipo_item_p text, qt_versoes_ant_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_mat_interno_w	carga_planserv_item.cd_interno%type;
cd_mat_conv_w		carga_planserv_item.cd_item%type;
ds_item_w		carga_planserv_item.ds_item%type;
vl_emb_ant_w		carga_planserv_item.vl_item%type;
vl_emb_atual_w		carga_planserv_item.vl_item%type;
vl_unitario_ant_w	carga_planserv_item.vl_unitario%type;
vl_unitario_atual_w	carga_planserv_item.vl_unitario%type;

vl_emb_ant_aux_w	carga_planserv_item.vl_item%type;
vl_unitario_ant_aux_w	carga_planserv_item.vl_unitario%type;

nr_seq_carga_ant_w	carga_planserv.nr_sequencia%type;
nr_seq_carga_w		carga_planserv_item.nr_seq_carga%type;

ie_fracionamento_w	varchar(1);
ie_alteracao_w		varchar(20);
ds_tipo_alteracao_w	varchar(255);
nr_count_w		bigint;
qt_reg_w		bigint := 0;
qt_fracionado_w		bigint := 0;
qt_item_carga_w		bigint;

C01 CURSOR FOR
	SELECT	cd_interno,
		cd_item,
		ds_item,
		vl_item,
		vl_unitario
	from	carga_planserv_item
	where	nr_seq_carga = nr_seq_carga_w;

C02 CURSOR FOR
	SELECT	a.nr_sequencia
	from	carga_planserv a
	where	a.ie_tipo = ie_tipo_item_p
	and	a.nr_sequencia < nr_seq_carga_w
	order by a.nr_sequencia desc;



BEGIN


select	count(table_name)
into STRICT	nr_count_w
from	user_tables
where	upper(table_name) = 'PLANSERV_RELAT_CARGA';

if (nr_count_w	= 0) then
	CALL exec_sql_dinamico(nm_usuario_p,'create table planserv_relat_carga(	nm_usuario		varchar2(15),
										cd_material_int		number(6),
										cd_material_conv	number(20),
										ds_material		varchar2(255),
										vl_emb_anterior		number(15,2),
										vl_emb_atual		number(15,2),
										vl_unitario_anterior	number(15,2),
										vl_unitario_atual	number(15,2),
										ie_fracionamento	varchar2(1),
										ie_alteracao		varchar2(20)
										)');
else
	CALL exec_sql_dinamico(nm_usuario_p,'delete from planserv_relat_carga where nm_usuario = '|| chr(39) || nm_usuario_p || chr(39));
end if;


select	coalesce(MAX(nr_sequencia),0)
into STRICT	nr_seq_carga_w
from	carga_planserv
where	cd_versao = cd_versao_p
and	ie_tipo = ie_tipo_item_p;


open C01;
loop
fetch C01 into
	cd_mat_interno_w,
	cd_mat_conv_w,
	ds_item_w,
	vl_emb_atual_w,
	vl_unitario_atual_w
	;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	vl_emb_ant_w 		:= null;
	vl_unitario_ant_w 	:= null;
	qt_fracionado_w		:= 0;
	qt_reg_w		:= 0;

	open C02;
	loop
	fetch C02 into
		nr_seq_carga_ant_w;
	EXIT WHEN NOT FOUND; /* apply on qt_reg_w = qt_versoes_ant_p or C02 */
		begin
		qt_reg_w := qt_reg_w + 1;

		select	count(1)
		into STRICT	qt_item_carga_w
		from	carga_planserv_item b
		where	b.nr_seq_carga = nr_seq_carga_ant_w
		and	b.cd_item = cd_mat_conv_w
		and	(b.vl_item IS NOT NULL AND b.vl_item::text <> '')  LIMIT 1;

		if (qt_item_carga_w > 0) then

			select	coalesce(vl_item,0),
				coalesce(vl_unitario,0)
			into STRICT	vl_emb_ant_aux_w,
				vl_unitario_ant_aux_w
			from	carga_planserv_item
			where	nr_seq_carga = nr_seq_carga_ant_w
			and	cd_item = cd_mat_conv_w;

			if (coalesce(vl_emb_ant_w::text, '') = '') and (vl_emb_ant_aux_w <> 0) then
				vl_emb_ant_w := vl_emb_ant_aux_w;
			end if;
			if (coalesce(vl_unitario_ant_w::text, '') = '') and (vl_unitario_ant_aux_w <> 0) then
				vl_unitario_ant_w := vl_unitario_ant_aux_w;
			end if;
		end if;

		end;
	end loop;
	close C02;

	if (coalesce(vl_emb_ant_w::text, '') = '') then
		ie_alteracao_w := wheb_mensagem_pck.get_texto(802987);
	elsif (vl_emb_ant_w = vl_emb_atual_w) then
		ie_alteracao_w := wheb_mensagem_pck.get_texto(802988);
	elsif (vl_emb_ant_w > vl_emb_atual_w) then
		ie_alteracao_w := wheb_mensagem_pck.get_texto(802990);
	elsif (vl_emb_ant_w < vl_emb_atual_w) then
		ie_alteracao_w := wheb_mensagem_pck.get_texto(802989);
	end if;

	if (ie_tipo_item_p = 'MA') then
		ie_fracionamento_w := 'N';
	elsif (ie_tipo_item_p = 'MF') then
		ie_fracionamento_w := 'S';
	else
		select	count(*)
		into STRICT	qt_fracionado_w
		from	carga_planserv x,
			carga_planserv_item y
		where	x.ie_tipo = 'MF'
		and	y.nr_seq_carga = x.nr_sequencia
		and	y.cd_item = cd_mat_conv_w;

		if (qt_fracionado_w > 0) then
			ie_fracionamento_w := 'S';
		else
			ie_fracionamento_w := 'N';
		end if;

	end if;


	CALL exec_sql_dinamico( nm_usuario_p,'insert into planserv_relat_carga(
							nm_usuario,
							cd_material_int,
							cd_material_conv,
							ds_material,
							vl_emb_anterior,
							vl_emb_atual,
							vl_unitario_anterior,
							vl_unitario_atual,
							ie_fracionamento,
							ie_alteracao)
					values ('	|| chr(39) || nm_usuario_p || chr(39) || ','
							|| coalesce(to_char(cd_mat_interno_w),'null') || ','
							|| cd_mat_conv_w || ','
							|| chr(39) || ds_item_w || chr(39) || ','
							|| coalesce(replace(to_char(vl_emb_ant_w),',','.'),0) || ','
							|| coalesce(replace(to_char(vl_emb_atual_w),',','.'),0) || ','
							|| coalesce(replace(to_char(vl_unitario_ant_w),',','.'),0) || ','
							|| coalesce(replace(to_char(vl_unitario_atual_w),',','.'),0) || ','
							|| chr(39) || ie_fracionamento_w || chr(39) || ','
							|| chr(39) || ie_alteracao_w || chr(39) || ')');
	end;
end loop;
close C01;


commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE planserv_gerar_relat_carga ( cd_versao_p text, ie_tipo_item_p text, qt_versoes_ant_p bigint, nm_usuario_p text) FROM PUBLIC;

