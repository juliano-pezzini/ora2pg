-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE estornar_tit_liq_glosa ( nr_sequencia_p nota_fiscal.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, ds_observacao_p titulo_receber_liq.ds_observacao%type default null) AS $body$
DECLARE


nr_titulo_receber_liq_w     titulo_receber_liq.nr_titulo%type;
nr_sequencia_titulo_liq_w   titulo_receber_liq.nr_sequencia%type;

c01 CURSOR FOR
    SELECT  c.nr_titulo,
            c.nr_sequencia
    from    nota_fiscal a, 
            titulo_receber b, 
            titulo_receber_liq c
    where   (a.nr_sequencia_ref IS NOT NULL AND a.nr_sequencia_ref::text <> '')
    and     a.nr_sequencia_ref = b.nr_seq_nf_saida
    and     b.nr_titulo = c.nr_titulo
    and     c.vl_glosa > 0
    and     a.ie_situacao = '3'
    and     not exists (SELECT 1 
                    from titulo_receber_liq e 
                    where e.nr_seq_liq_origem = c.nr_sequencia 
                    and e.nr_titulo = c.nr_titulo)
    and     a.nr_sequencia = nr_sequencia_p;


BEGIN
open C01;
loop
fetch C01 into
    nr_titulo_receber_liq_w,
    nr_sequencia_titulo_liq_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
begin
    CALL estornar_tit_receber_liq(   nr_titulo_p     => nr_titulo_receber_liq_w,
                                nr_seq_baixa_p  => nr_sequencia_titulo_liq_w,
                                dt_baixa_p      => clock_timestamp(),
                                nm_usuario_p    => nm_usuario_p,
                                ie_commit_p     => 'S',
                                ds_observacao_p => ds_observacao_p,
                                ie_vago_p       =>  'S');
end;
end loop;
close C01;	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE estornar_tit_liq_glosa ( nr_sequencia_p nota_fiscal.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, ds_observacao_p titulo_receber_liq.ds_observacao%type default null) FROM PUBLIC;

