-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_enfermeiro_aux ( nr_atendimento_p atend_enfermagem_aux.nr_atendimento%type, cd_pessoa_fisica_p atend_enfermagem_aux.cd_pessoa_fisica%type, nm_usuario_p atend_enfermagem_aux.nm_usuario%type, ds_justificativa_p atend_enfermagem_aux.ds_justificativa%type, nr_ordem_p atend_enfermagem_aux.nr_ordem%type, nr_seq_phs_p atend_enfermagem_aux.nr_seq_phs%type) AS $body$
DECLARE


ie_possui_enf_w		varchar(1);
cd_pessoa_fisica_w  atend_enfermagem_aux.cd_pessoa_fisica%type;


BEGIN

    select	coalesce(max('S'), 'N')
    into STRICT	ie_possui_enf_w
    from	atend_enfermagem_aux
    where	nr_atendimento = nr_atendimento_p
    and     nr_ordem = nr_ordem_p;

    if (ie_possui_enf_w = 'S') then
        select	coalesce(max(cd_pessoa_fisica), '0')
        into STRICT	cd_pessoa_fisica_w
        from	atend_enfermagem_aux
        where	nr_sequencia = (SELECT	max(nr_sequencia)
                                from	atend_enfermagem_aux
                                where	nr_atendimento = nr_atendimento_p
                                and     nr_ordem = nr_ordem_p)
        and		nr_atendimento = nr_atendimento_p
        and     nr_ordem = nr_ordem_p;

        update	atend_enfermagem_aux
        set		dt_final_resp = clock_timestamp()
        where	nr_sequencia = (SELECT	max(nr_sequencia)
                                from	atend_enfermagem_aux
                                where	nr_atendimento = nr_atendimento_p
                                and     nr_ordem = nr_ordem_p)
        and		nr_atendimento = nr_atendimento_p
        and     nr_ordem = nr_ordem_p;
    end if;

	insert into atend_enfermagem_aux(
                nr_sequencia,
                dt_atualizacao,
                nm_usuario,
                cd_pessoa_fisica,
                nr_atendimento,
                cd_pessoa_resp_ant,
                dt_inicio_resp,
                ds_justificativa,
                nr_ordem,
                nr_seq_phs)
        SELECT	nextval('atend_enfermagem_aux_seq'),
                clock_timestamp(),
                nm_usuario_p,
                cd_pessoa_fisica_p,
                nr_atendimento_p,
                coalesce(cd_pessoa_fisica_w, null),
                clock_timestamp(),
                ds_justificativa_p,
                nr_ordem_p,
                nr_seq_phs_p
;

    if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then
        commit;
    end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_enfermeiro_aux ( nr_atendimento_p atend_enfermagem_aux.nr_atendimento%type, cd_pessoa_fisica_p atend_enfermagem_aux.cd_pessoa_fisica%type, nm_usuario_p atend_enfermagem_aux.nm_usuario%type, ds_justificativa_p atend_enfermagem_aux.ds_justificativa%type, nr_ordem_p atend_enfermagem_aux.nr_ordem%type, nr_seq_phs_p atend_enfermagem_aux.nr_seq_phs%type) FROM PUBLIC;

