-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_invoice_item ( nr_seq_nota_item_p bigint, cd_estabelecimento_p bigint, cd_serie_nf_p text, nr_nota_fiscal_seq_p bigint, nr_item_nf_p bigint, qt_item_p bigint, vl_unit_item_nf_p bigint, vl_total_item_nf_p bigint, nm_user_p text, vl_delivery_p bigint, vl_discount_p bigint, vl_accessorie_cost_p bigint, vl_apportionment_cost_p bigint, vl_safety_p bigint, vl_liquid_p bigint, cd_material_p text, ds_observacao_p text, cd_unidade_medida_compra_p text, cd_unidade_medida_estoque_p text, ds_complemento_p text, vl_pis_p bigint, vl_cofins_p bigint, vl_iss_p bigint, vl_irrf_p bigint, vl_inss_p bigint, vl_csll_p bigint, vl_outros_p bigint, vl_tributacao_p bigint, vl_deducao_p bigint, vl_iss_retido_p bigint, pr_icms_p bigint, pr_ipi_p bigint, pr_pis_p bigint, pr_cofins_p bigint, pr_csll_p bigint, pr_iss_p bigint, pr_irrf_p bigint, pr_inss_p bigint, pr_iss_retido_p bigint, vl_ipi_p bigint, vl_icms_p bigint, nr_pedido_compra_p text, nr_item_compra_p text, cd_cfop_p text, ds_material_p text, nr_ncm_p text) AS $body$
DECLARE

				
cd_material_ok_w		material.cd_material%type;
cd_unidade_medida_compra_ok_w	unidade_medida.cd_unidade_medida%type;
cd_unidade_medida_estoque_ok_w	unidade_medida.cd_unidade_medida%type;
ds_observacao_w			nota_fiscal_item_int_imp.ds_observacao%type;
nr_seq_nota_w			nota_fiscal.nr_sequencia%type;


BEGIN

select	max(m.cd_material)
into STRICT	cd_material_ok_w
from	material m
where	to_char(m.cd_material) = cd_material_p;

if (coalesce(cd_material_ok_w::text, '') = '') then
	ds_observacao_w := substr(ds_observacao_w || ' CPROD='||cd_material_p,1,255);
end if;

select	max(m.cd_unidade_medida)
into STRICT	cd_unidade_medida_compra_ok_w
from	unidade_medida m
where	m.cd_unidade_medida = cd_unidade_medida_compra_p;

select	max(m.cd_unidade_medida)
into STRICT	cd_unidade_medida_estoque_ok_w
from	unidade_medida m
where	m.cd_unidade_medida = cd_unidade_medida_estoque_p;

if (coalesce(cd_unidade_medida_compra_ok_w::text, '') = '') or (coalesce(cd_unidade_medida_estoque_ok_w::text, '') = '') then
	ds_observacao_w := substr(ds_observacao_w || ' UCOM='||coalesce(cd_unidade_medida_compra_p,cd_unidade_medida_estoque_p),1,255);
end if;

select	max(nr_seq_nota)
into STRICT	nr_seq_nota_w
from	nota_fiscal_int_imp
where	nr_sequencia = nr_nota_fiscal_seq_p;

insert into nota_fiscal_item_int_imp(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	cd_estabelecimento,
	nr_seq_nota_int,
	nr_seq_nota,
	nr_item_nf,
	cd_material,
	cd_unidade_medida_compra,
	cd_unidade_medida_estoque,
	cd_serie_nf,
	vl_produto,
	vl_pis,
	vl_cofins,
	vl_iss,
	vl_irrf,
	vl_inss,
	vl_csll,
	vl_outros,
	vl_tributacao,
	vl_deducao,
	vl_iss_retido,
	pr_icms,
	pr_ipi,
	pr_pis,
	pr_cofins,
	pr_csll,
	pr_iss,
	pr_irrf,
	pr_inss,
	pr_iss_retido,
	vl_ipi,
	vl_icms,
	qt_item,
	vl_unit_item_nf,
	vl_total_item_nf,
	vl_frete,
	vl_desconto,
	vl_despesa_acessoria,
	vl_desconto_rateio,
	vl_seguro,
	vl_liquido,
	ds_complemento,
	nr_pedido_compra,
	nr_item_compra,
	cd_cfop,
	ds_material,
	nr_ncm,
	cd_material_ok,
	cd_unidade_medida_compra_ok,
	cd_unidade_medida_estoque_ok,
	ds_observacao)
values (nextval('nota_fiscal_item_int_imp_seq'),
	clock_timestamp(),
	nm_user_p,
	clock_timestamp(),
	nm_user_p,
	cd_estabelecimento_p,
	nr_nota_fiscal_seq_p,
	nr_seq_nota_w,
	nr_item_nf_p,
	cd_material_p,
	cd_unidade_medida_compra_p,
	cd_unidade_medida_estoque_p,
	cd_serie_nf_p,
	vl_unit_item_nf_p,
	vl_pis_p,
	vl_cofins_p,
	vl_iss_p,
	vl_irrf_p,
	vl_inss_p,
	vl_csll_p,
	vl_outros_p,
	vl_tributacao_p,
	vl_deducao_p,
	vl_iss_retido_p,
	pr_icms_p,
	pr_ipi_p,
	pr_pis_p,
	pr_cofins_p,
	pr_csll_p,
	pr_iss_p,
	pr_irrf_p,
	pr_inss_p,
	pr_iss_retido_p,
	vl_ipi_p,
	vl_icms_p,
	qt_item_p,
	vl_unit_item_nf_p,
	vl_total_item_nf_p,
	vl_delivery_p,
	vl_discount_p,
	vl_accessorie_cost_p,
	vl_apportionment_cost_p,
	vl_safety_p,
	vl_total_item_nf_p,
	ds_complemento_p,
	nr_pedido_compra_p,
	nr_item_compra_p,
	cd_cfop_p,
	ds_material_p,
	nr_ncm_p,
	cd_material_ok_w,
	cd_unidade_medida_compra_ok_w,
	cd_unidade_medida_estoque_ok_w,
	ds_observacao_w);
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_invoice_item ( nr_seq_nota_item_p bigint, cd_estabelecimento_p bigint, cd_serie_nf_p text, nr_nota_fiscal_seq_p bigint, nr_item_nf_p bigint, qt_item_p bigint, vl_unit_item_nf_p bigint, vl_total_item_nf_p bigint, nm_user_p text, vl_delivery_p bigint, vl_discount_p bigint, vl_accessorie_cost_p bigint, vl_apportionment_cost_p bigint, vl_safety_p bigint, vl_liquid_p bigint, cd_material_p text, ds_observacao_p text, cd_unidade_medida_compra_p text, cd_unidade_medida_estoque_p text, ds_complemento_p text, vl_pis_p bigint, vl_cofins_p bigint, vl_iss_p bigint, vl_irrf_p bigint, vl_inss_p bigint, vl_csll_p bigint, vl_outros_p bigint, vl_tributacao_p bigint, vl_deducao_p bigint, vl_iss_retido_p bigint, pr_icms_p bigint, pr_ipi_p bigint, pr_pis_p bigint, pr_cofins_p bigint, pr_csll_p bigint, pr_iss_p bigint, pr_irrf_p bigint, pr_inss_p bigint, pr_iss_retido_p bigint, vl_ipi_p bigint, vl_icms_p bigint, nr_pedido_compra_p text, nr_item_compra_p text, cd_cfop_p text, ds_material_p text, nr_ncm_p text) FROM PUBLIC;

