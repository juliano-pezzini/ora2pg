-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE softlab_ws_confirmar_coleta ( nr_prescricao_p bigint, nr_seq_prescricao_p bigint, cd_material_exame_p text, cd_exame_p text, dt_coleta_p timestamp, dt_prev_entrega_p timestamp, nm_usuario_p text, ds_retorno_p INOUT text) AS $body$
DECLARE


cd_estabelecimento_w		smallint;
ie_status_coleta_integ_w	integer;
nr_seq_exame_w			bigint;


BEGIN

IF (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') AND (nr_seq_prescricao_p IS NOT NULL AND nr_seq_prescricao_p::text <> '') THEN

	SELECT	MAX(coalesce(a.cd_estabelecimento,wheb_usuario_pck.get_cd_estabelecimento))
	INTO STRICT	cd_estabelecimento_w
	FROM	prescr_medica a
	WHERE	a.nr_prescricao = nr_prescricao_p;

	SELECT	MAX(ie_status_coleta_integ)
	INTO STRICT	ie_status_coleta_integ_w
	FROM	lab_parametro a
	WHERE	a.cd_estabelecimento = cd_estabelecimento_w;


	SELECT	MAX(a.nr_seq_exame)
	INTO STRICT	nr_seq_exame_w
	FROM	lab_exame_equip a,
		equipamento_lab b
	WHERE	a.cd_equipamento = b.cd_equipamento
	AND	b.ds_sigla = 'SOFTLABWS'
	AND	a.cd_exame_equip = cd_exame_p;

	IF (coalesce(nr_seq_exame_w::text, '') = '') THEN
		ds_retorno_p := '1';
	ELSE
		ds_retorno_p := '0';
	END IF;

	UPDATE	prescr_procedimento
	SET	dt_coleta = dt_coleta_p,
		nm_usuario = nm_usuario_p,
		ie_status_atend = coalesce(ie_status_coleta_integ_w, 20)
	WHERE	nr_prescricao = nr_prescricao_p
	AND	nr_sequencia = nr_seq_prescricao_p
	and	ie_status_atend < coalesce(ie_status_coleta_integ_w, 20);

END IF;


COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE softlab_ws_confirmar_coleta ( nr_prescricao_p bigint, nr_seq_prescricao_p bigint, cd_material_exame_p text, cd_exame_p text, dt_coleta_p timestamp, dt_prev_entrega_p timestamp, nm_usuario_p text, ds_retorno_p INOUT text) FROM PUBLIC;

