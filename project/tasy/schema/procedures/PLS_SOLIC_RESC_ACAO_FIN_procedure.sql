-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_solic_resc_acao_fin ( nr_seq_item_solic_resc_p bigint, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE


vl_item_w		pls_solic_resc_fin_item.vl_item%type;
ie_tipo_valor_w		pls_solic_resc_fin_item.ie_tipo_valor%type;
ie_opcao_w		bigint;
vl_devolver_w		double precision;
vl_devido_w		double precision;
nr_seq_lanc_auto_w	pls_solic_resc_fin_item.nr_seq_lanc_auto%type;
vl_item_lanc_auto_w	pls_segurado_mensalidade.vl_item%type;
nr_seq_lanc_manual_w	pls_solic_resc_fin_item.nr_seq_lanc_manual%type;


BEGIN
select	max(vl_item),
	max(ie_tipo_valor),
	max(nr_seq_lanc_auto),
	max(nr_seq_lanc_manual)
into STRICT	vl_item_w,
	ie_tipo_valor_w,
	nr_seq_lanc_auto_w,
	nr_seq_lanc_manual_w
from	pls_solic_resc_fin_item
where	nr_sequencia = nr_seq_item_solic_resc_p;

if (ie_opcao_p = 1) then
	update	pls_solic_resc_fin_item
	set	vl_devido	= vl_item_w,
		vl_devolver	= 0,
		vl_cancelar	= 0,
		ie_acao		= ie_opcao_p,
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_seq_item_solic_resc_p;
elsif (ie_opcao_p = 2) then
	update	pls_solic_resc_fin_item
	set	vl_devido	= 0,
		vl_devolver	= vl_item_w,
		vl_cancelar	= 0,
		ie_acao		= ie_opcao_p,
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_seq_item_solic_resc_p;
elsif (ie_opcao_p = 3) then
	update	pls_solic_resc_fin_item
	set	vl_devido	= 0,
		vl_devolver	= 0,
		vl_cancelar	= vl_item_w,
		ie_acao		= ie_opcao_p,
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_seq_item_solic_resc_p;
elsif (ie_opcao_p = 4) then
	if (nr_seq_lanc_manual_w IS NOT NULL AND nr_seq_lanc_manual_w::text <> '') then --Manual
		if (ie_tipo_valor_w = 'R') then --Receber
			ie_opcao_w 	:= 1; --Cobrar
		else
			ie_opcao_w	:= 2; --Devolver
		end if;
	elsif (nr_seq_lanc_auto_w IS NOT NULL AND nr_seq_lanc_auto_w::text <> '') then --Automatico
		select	max(vl_item)
		into STRICT	vl_item_lanc_auto_w
		from	pls_segurado_mensalidade
		where	nr_sequencia = nr_seq_lanc_auto_w;

		if (coalesce(vl_item_lanc_auto_w,0) < 0) then
			ie_opcao_w	:= 2; --Devolver
		else
			ie_opcao_w	:= 1; --Cobrar
		end if;
	end if;

	if (ie_opcao_w = 1) then  --Cobrar
		vl_devido_w	:= vl_item_w;
		vl_devolver_w	:= 0;
	elsif (ie_opcao_w = 2) then --Devolver
		vl_devido_w	:= 0;
		vl_devolver_w	:= vl_item_w;
	end if;

	update	pls_solic_resc_fin_item
	set	vl_devido	= vl_devido_w,
		vl_devolver	= vl_devolver_w,
		vl_cancelar	= 0,
		ie_acao		= ie_opcao_w,
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_seq_item_solic_resc_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_solic_resc_acao_fin ( nr_seq_item_solic_resc_p bigint, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

