-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_tipo_nota_ipe ( nr_interno_conta_p bigint) AS $body$
DECLARE


/*
s_array1(z).ie_tipo_item
	1 - Proc/Taxas/Serv
	2 - Mat/Med

s_array1(z).ie_tipo_atendimento
	1 - Internado
	3 - Pronto Socorro
	7 - Externo(Exames)
	8 - Ambulatorial
*/
cd_grupo_proc_w			bigint;
cd_especialidade_w		bigint;
cd_area_procedimento_w	bigint;
tp_nota_w				smallint;
ie_origem_proced_w		bigint;
qt_tipo_nota_w			bigint;

C01 CURSOR FOR
	SELECT	c.ie_tipo_item,
			c.cd_item,
			c.ie_origem_proced,
			c.nr_seq_item,
			a.ie_tipo_atendimento,
			a.cd_cgc_hospital
	from	w_interf_conta_item c,
            w_interf_conta_cab a
    where   a.nr_interno_conta              = c.nr_interno_conta
    and     a.nr_interno_conta              = nr_interno_conta_p
	group by c.ie_tipo_item,
			c.cd_item,
			c.ie_origem_proced,
			c.nr_seq_item,
			a.ie_tipo_atendimento,
			a.cd_cgc_hospital
	order by c.nr_seq_item;

type            fetch_array is table of c01%rowtype;
s_array1         fetch_array;
j               integer := 1;
type vetor is table of fetch_array index by integer;
vetor_c01_w                     vetor;
BEGIN

open C01;
loop
fetch C01 bulk collect into s_array1 limit 100000;
	vetor_c01_w(j) := s_array1;
	j := j + 1;
EXIT WHEN NOT FOUND; /* apply on C01 */
end loop;
close C01;

for i in 1..vetor_c01_w.count loop
	begin
	s_array1 := vetor_c01_w(i);
	for z in 1..s_array1.count loop
		begin

		delete 	FROM w_interf_conta_item_nota
		where	nr_seq_item = s_array1[z].nr_seq_item
		and		nr_interno_conta = nr_interno_conta_p;

		if (s_array1[z].ie_tipo_item = 1) then

			select 	coalesce(max(cd_grupo_proc),0),
				coalesce(max(cd_especialidade),0),
				coalesce(max(cd_area_procedimento),0),
				coalesce(max(ie_origem_proced),1)
			into STRICT	cd_grupo_proc_w,
				cd_especialidade_w,
				cd_area_procedimento_w,
				ie_origem_proced_w
			from	estrutura_procedimento_v
			where	cd_procedimento	= s_array1[z].cd_item
			and	ie_origem_proced = s_array1[z].ie_origem_proced
			and	s_array1[z].ie_tipo_item	 = 1;

			CALL gerar_tipo_nota_ipergs(s_array1[z].ie_tipo_atendimento, s_array1[z].ie_tipo_item, cd_area_procedimento_w, cd_especialidade_w, cd_grupo_proc_w,
				s_array1[z].cd_item, ie_origem_proced_w, s_array1[z].nr_seq_item, nr_interno_conta_p);

		end if;

		begin
			select	count(1)
			into STRICT	qt_tipo_nota_w
			from	w_interf_conta_item_nota
			where	nr_seq_item = s_array1[z].nr_seq_item
			and		nr_interno_conta = nr_interno_conta_p;
		exception
		when others then
			qt_tipo_nota_w := 0;
		end;

		if (coalesce(qt_tipo_nota_w,0) = 0) then

			tp_nota_w := 0;

			if (s_array1[z].ie_tipo_item	= 1) then
				begin
				tp_nota_w			:= 55;


				if (s_array1[z].ie_origem_proced = 1) then
					begin

					if (s_array1[z].ie_tipo_atendimento	= 1) then
						begin
						if (cd_area_procedimento_w		= 1) then
							tp_nota_w			:= 75;
						elsif (cd_area_procedimento_w		= 2) then
							tp_nota_w			:= 75;
						elsif (cd_area_procedimento_w		= 4) then
							tp_nota_w			:= 75;
						elsif (cd_area_procedimento_w		= 3) then
							tp_nota_w			:= 77;
						else
							tp_nota_w			:= 76;
						end if;
						end;
					end if;

					if (s_array1[z].ie_tipo_atendimento	= 8) then
						begin
						if (cd_area_procedimento_w		= 1) then
							tp_nota_w			:= 85;
						elsif (cd_area_procedimento_w		= 2) then
							tp_nota_w			:= 85;
						elsif (cd_area_procedimento_w		= 4) then
							tp_nota_w			:= 85;
						elsif (cd_area_procedimento_w		= 3) then
							tp_nota_w			:= 87;
						else
							tp_nota_w			:= 86;
						end if;
						end;
					end if;

					if (s_array1[z].ie_tipo_atendimento	= 3) then
						tp_nota_w			:= 55;
					end if;

					if (s_array1[z].ie_tipo_atendimento	= 7) then
						tp_nota_w			:= 35;
					end if;

					/* Exceções solicitadas por Adriane HCE Ordem de Serviço 11051 */

					if (s_array1[z].ie_tipo_atendimento	= 1) then
						begin
						/* 29000009-Tisiopneumologia 23000007-Endoscopia Digestiva 24000000-Endoscopia Peroral */

						if (cd_especialidade_w		in (29000009,23000007,24000000,32000006)) then
							tp_nota_w			:= 75;
						end if;
						/* 32130007-Radiologia Intervencionista 32320019-Angiografia 32300018-Neuroradiologia */

						if (cd_grupo_proc_w		in (32130007,32320019,32300018)) then
							tp_nota_w			:= 75;
						end if;
						/* Procedimentos que se iniciam com 32xxxxxx devem vir com tipo de Nota 77  OS 62961 André HDJB,
						com excessão dos que iniciam-se com 3230xxxx e 3232xxxx */
						if	(((s_array1[z].cd_cgc_hospital = '95422358000119') and (length(s_array1[z].cd_item) > 3)) or (s_array1[z].cd_cgc_hospital <> '95422358000119')) and (substr(s_array1[z].cd_item,1,2) = '32') and ((substr(s_array1[z].cd_item,1,4))::numeric  not in (3230,3232)) and (length(s_array1[z].cd_item) > 2) and
							((s_array1[z].cd_cgc_hospital = '92815000000168' AND s_array1[z].cd_item <> 329) or (s_array1[z].cd_cgc_hospital <> '92815000000168')) then
							tp_nota_w			:= 77;
						end if;


						--OS 663852
						if	(((s_array1[z].cd_cgc_hospital = '95422358000119') and (length(s_array1[z].cd_item) > 3)) or (s_array1[z].cd_cgc_hospital <> '95422358000119')) and (substr(s_array1[z].cd_item,1,2) = '32') and ((substr(s_array1[z].cd_item,1,4))::numeric  not in (3230,3232)) and (length(s_array1[z].cd_item) > 2)  then
							tp_nota_w			:= 77;
						end if;


						/* OS 84734 Fabrício HCE */
	/*OS 107252 Fabrício HDP */

						if	((s_array1[z].cd_cgc_hospital = '89428718000197') or (s_array1[z].cd_cgc_hospital = '87317764001084')) then
							if (substr(s_array1[z].cd_item,1,2) = '32') and ((substr(s_array1[z].cd_item,1,4))::numeric  not in (3230,3232)) then
								tp_nota_w			:= 77;
							end if;
							if (cd_grupo_proc_w		in (32130007,32320019,32300018)) then
								tp_nota_w			:= 75;
							end if;
						end if;

						/* OS 147394 André (Digifull) Hosp. Pompéia Caxias do Sul*/

						if (s_array1[z].cd_cgc_hospital = '88633227000115') then
							if (s_array1[z].cd_item in (27040470, 28040554)) then
								tp_nota_w := 75;
							end if;

							--OS 511395
							if (cd_especialidade_w in (32000006)) then
								begin
								tp_nota_w := 77;
								end;
							end if;


							/*OS 181792 Cleber */

							if ((substr(s_array1[z].cd_item,1,4))::numeric  = 3213) then
								tp_nota_w := 75;
							end if;
						end if;
						if (s_array1[z].cd_cgc_hospital = '92741016000254') then /*os 275593 Ernesto Dornelles */
							if (cd_especialidade_w	in (29000009,23000007,24000000,32000006)) then
								tp_nota_w	:= 77;
							end if;
							if (s_array1[z].cd_item in (23013036, 23012030, 23012021, 23013028, 23016027, 23015020, 23020091)) then
								tp_nota_w	:= 75;
							end if;
						end if;
						if (s_array1[z].cd_cgc_hospital = '92815000000168') then /*Santa Casa de POA*/
							if (cd_especialidade_w in (30000009)) then
								tp_nota_w	:= 75;
							end if;
							if (cd_especialidade_w in (29000009)) then
								tp_nota_w	:= 77;
							end if;
							if (cd_grupo_proc_w = 32130007) then
								tp_nota_w	:= 75;
							end if;
							if (s_array1[z].cd_item in (27040470, 100102)) then
								tp_nota_w	:= 75;
							end if;
						end if;
						if	((s_array1[z].cd_cgc_hospital = '87096616004779') or (s_array1[z].cd_cgc_hospital = '87701249000374')) then
							if (s_array1[z].cd_item = 32130384)	then
								tp_nota_w	:= 75;
							end if;
						end if;

						if (s_array1[z].cd_cgc_hospital = '87701249000374') then
							/*Unimed Missões/ RS*/

							if (s_array1[z].cd_item in (91040052,91040053)) then
								tp_nota_w	:= 75;
							end if;
						end if;

						--OS 663852
						if (s_array1[z].cd_cgc_hospital = '95422358000119') then

							if (s_array1[z].cd_item = 35010177)	then
								tp_nota_w	:= 75;
							end if;

						end if;

						end;
					end if;

					if (s_array1[z].ie_tipo_atendimento	= 8) then
						begin
						/* 29000009-Tisiopneumologia 23000007-Endoscopia Digestiva 24000000-Endoscopia Peroral */

						if (cd_especialidade_w		in (29000009,23000007,24000000,32000006)) then
							tp_nota_w			:= 85;
						end if;
						/* 32130007-Radiologia Intervencionista 32320019-Angiografia 32300018-Neuroradiologia */

						if (cd_grupo_proc_w		in (32130007,32320019,32300018)) then
							tp_nota_w			:= 85;
						end if;
						/* Procedimentos que se iniciam com 32xxxxxx devem vir com tipo de Nota 87  OS 58279 André HDJB,
						com excessão dos que iniciam-se com 3230xxxx e 3232xxxx */
						if (substr(s_array1[z].cd_item,1,2) = '32') and ((substr(s_array1[z].cd_item,1,4))::numeric  not in (3230,3232)) and (length(s_array1[z].cd_item) > 2) then
							tp_nota_w			:= 87;
						end if;


						/* OS 84734 Fabrício HCE */
      /*OS 107252 Fabrício HDP */

						if	((s_array1[z].cd_cgc_hospital = '89428718000197') or (s_array1[z].cd_cgc_hospital = '87317764001084')) then
							if (substr(s_array1[z].cd_item,1,2) = '32') and ((substr(s_array1[z].cd_item,1,4))::numeric  not in (3230,3232)) then
								tp_nota_w		:= 87;
							end if;
							if (cd_grupo_proc_w		in (32130007,32320019,32300018)) then
								tp_nota_w		:= 85;
							end if;
						end if;

						/* OS 147394 André (Digifull) Hosp. Pompéia Caxias do Sul*/

						if	((s_array1[z].cd_cgc_hospital = '88633227000115') and (s_array1[z].cd_item in (27040470, 28040554, 20020015))) then
							tp_nota_w := 85;
						end if;

						if (s_array1[z].cd_cgc_hospital = '92741016000254') then /*os 275593 Ernesto Dornelles */
							if (cd_especialidade_w	in (29000009,23000007,24000000)) then
								tp_nota_w		:= 87;
							end if;
							if (s_array1[z].cd_item in (23013036, 23012030, 23012021, 23013028, 23016027, 23015020, 23020091)) then
								tp_nota_w		:= 85;
							end if;
						end if;

						if (s_array1[z].cd_cgc_hospital = '92815000000168') then /*Santa Casa de POA*/
							if (cd_especialidade_w = 30000009) then
								tp_nota_w	:= 85;
							end if;
							if (cd_especialidade_w = 29000009) then
								tp_nota_w	:= 87;
							end if;
							if (cd_grupo_proc_w = 32130007) then
								tp_nota_w	:= 85;
							end if;
							if (s_array1[z].cd_item = 27040470) then
								tp_nota_w	:= 85;
							end if;
							if (s_array1[z].cd_item = 100102) then
								tp_nota_w	:= 75;
							end if;
						end if;
						if	((s_array1[z].cd_cgc_hospital = '87096616004779') or (s_array1[z].cd_cgc_hospital = '87701249000374')) then
							if (s_array1[z].cd_item = 32130384)	then
								tp_nota_w	:= 85;
							end if;
						end if;


						--OS 663852
						if (s_array1[z].cd_cgc_hospital = '95422358000119') then

							if (s_array1[z].cd_item = 35010177)	then
								tp_nota_w	:= 85;
							end if;

						end if;


						end;
					end if;

					/*OS167275 - Alan - Hops. Santa Terezinha*/

					if	(s_array1[z].cd_cgc_hospital = '89421259000110' AND s_array1[z].cd_item = 90050088) then
						tp_nota_w := 76;
					end if;

					/* OS 170245 Fabrício (Digifull) Hosp. Cachoeira do Sul*/

					/*OS 175887 Inclui a especialidade*/

					if (s_array1[z].cd_cgc_hospital = '87768735000148') then
						begin

						if ((s_array1[z].cd_item in (16000001, 16000002, 16000003, 16000004, 16000005, 16000006, 16000007, 20020015)) or (cd_especialidade_w = 30000009)) then
							begin

							if (s_array1[z].ie_tipo_atendimento	= 1) then
								tp_nota_w := 75;
							elsif (s_array1[z].ie_tipo_atendimento	= 8) then
								tp_nota_w := 85;
							end if;

							end;
						end if;

						--OS 511409
						if (cd_especialidade_w in (32000006)) then
							begin
							if (s_array1[z].ie_tipo_atendimento = 1) then
								begin
								tp_nota_w := 77;
								if	((cd_grupo_proc_w = 32130007) or (s_array1[z].cd_item 	= 27040470)) then --OS 593870
									begin
									tp_nota_w 	:= 75;
									end;
								end if;
								end;
							elsif (s_array1[z].ie_tipo_atendimento = 8) then
								begin
								tp_nota_w := 87;
								if	((cd_grupo_proc_w = 32130007) or (s_array1[z].cd_item 	= 27040470)) then --OS 593870
									begin
									tp_nota_w 	:= 85;
									end;
								end if;
								end;
							end if;
							end;
						end if;

						end;
					end if;

					/* OS 186515 Fabrício (Digifull)  Hosp. Pompéia Caxias do Sul*/

					if (s_array1[z].cd_cgc_hospital = '88633227000115') then
						if (cd_especialidade_w = 30000009) then
							if (s_array1[z].ie_tipo_atendimento	= 1) then
								tp_nota_w		:= 75;
							elsif (s_array1[z].ie_tipo_atendimento	= 8) then
								tp_nota_w 		:= 85;
							end if;
						end if;
						if (s_array1[z].cd_item 		= 32130040) and (s_array1[z].ie_tipo_atendimento	= 8) then
							tp_nota_w 		:= 85;
						end if;
					end if;

					if (s_array1[z].cd_cgc_hospital = '87096616004779') then
						if (cd_grupo_proc_w = 32130007) then
							if (s_array1[z].ie_tipo_atendimento	= 1) then
								tp_nota_w		:= 75;
							elsif (s_array1[z].ie_tipo_atendimento	= 8) then
								tp_nota_w 		:= 85;
							end if;
						end if;
					end if;

					end;
				elsif (s_array1[z].ie_origem_proced = 5) then
					begin
					if (s_array1[z].ie_tipo_atendimento	= 1) then
						begin
						if (s_array1[z].cd_item in (20104189,30307147,31002390,41203038,41203054,41203062,41203135,41203143)) then
							begin
							tp_nota_w			:= 75;
							end;
						end if;
						/*if	(cd_area_procedimento_w		= 12) then
							tp_nota_w			:= 75;
						elsif	(cd_area_procedimento_w		= 13) then
							tp_nota_w			:= 75;
						elsif	(cd_area_procedimento_w		= 14) then
							tp_nota_w			:= 75;
						end if;*/
						end;
					end if;

					if (s_array1[z].ie_tipo_atendimento	= 8) then
						begin
						if (s_array1[z].cd_item in (20104189,30307147,31002390,41203038,41203054,41203062,41203135,41203143)) then
							begin
							tp_nota_w			:= 85;
							end;
						end if;
						/*if	(cd_area_procedimento_w		= 12) then
							tp_nota_w			:= 85;
						elsif	(cd_area_procedimento_w		= 13) then
							tp_nota_w			:= 85;
						elsif	(cd_area_procedimento_w		= 14) then
							tp_nota_w			:= 85;
						end if;*/
						end;
					end if;
					if (s_array1[z].cd_cgc_hospital = '92962869002006') then
						if (s_array1[z].cd_item = 50140043) then
							if (s_array1[z].ie_tipo_atendimento	= 1) then
								tp_nota_w		:= 75;
							elsif (s_array1[z].ie_tipo_atendimento	= 8) then
								tp_nota_w 		:= 85;
							end if;
						end if;
					end if;

					if (s_array1[z].cd_cgc_hospital = '92815000000168') then
						if (s_array1[z].cd_item = 31401104) then
							if (s_array1[z].ie_tipo_atendimento	= 1) then
								tp_nota_w		:= 75;
							elsif (s_array1[z].ie_tipo_atendimento	= 8) then
								tp_nota_w 		:= 85;
							end if;
						elsif (s_array1[z].cd_item in (40403262, 40403270, 40403289, 40403297, 40708128, 40103528, 40103536, 40103544)) then /*OS 720125*/
							if (s_array1[z].ie_tipo_atendimento in (1)) then
								tp_nota_w 		:= 77;
							elsif (s_array1[z].ie_tipo_atendimento in (3)) then
								tp_nota_w 		:= 55;
							elsif (s_array1[z].ie_tipo_atendimento in (7)) then
								tp_nota_w 		:= 35;
							elsif (s_array1[z].ie_tipo_atendimento in (8)) then
								tp_nota_w 		:= 87;
							end if;
						elsif (s_array1[z].cd_item in (31002390,100102)) then --OS 769471
							if (s_array1[z].ie_tipo_atendimento	= 1) then
								tp_nota_w		:= 75;
							elsif (s_array1[z].ie_tipo_atendimento	= 8) then
								tp_nota_w 		:= 85;
							end if;
						end if;
					end if;
					end;
				end if;

				--OS  663852
				if (s_array1[z].cd_cgc_hospital = '95422358000119') then
					begin

					if ((s_array1[z].cd_item in (16000001, 16000002, 16000003, 16000004, 16000005, 16000006, 16000007, 23010002, 23013036, 23012030, 23011033, 23011025, 23012021, 23013028, 23014024, 23015020, 23016027)) or (cd_especialidade_w = 30000009)) then
						begin

						if (s_array1[z].ie_tipo_atendimento	= 1) then
							tp_nota_w := 75;
						elsif (s_array1[z].ie_tipo_atendimento	= 8) then
							tp_nota_w := 85;
						end if;

						end;
					end if;

					if ((substr(s_array1[z].cd_item,1,4))::numeric  	= 3213) then
						begin

						if (s_array1[z].ie_tipo_atendimento	= 1) then
							tp_nota_w 		:= 75;
						end if;

						end;
					end if;

					--OS 778141 em 21/08/2014
					if (s_array1[z].cd_item in (23021020,23022027,23023023)) then
						if (s_array1[z].ie_tipo_atendimento	= 1) then
							tp_nota_w := 75;
						elsif (s_array1[z].ie_tipo_atendimento	= 8) then
							tp_nota_w := 85;
						end if;
					end if;

					end;
				end if;

				--Hospital Vida e Saúde
				if (s_array1[z].cd_cgc_hospital = 95815668000101) then
					--OS 838145 em 22/01/2015 - Hospital Vida e Saúde
					if (cd_especialidade_w = 30000009) then
						begin
						if (s_array1[z].ie_tipo_atendimento	= 1) then
							tp_nota_w := 75;
						elsif (s_array1[z].ie_tipo_atendimento	= 8) then
							tp_nota_w := 85;
						end if;

						end;
					end if;
					--OS 839890 em 13/02/2015 - Hospital Vida e Saúde
					if (s_array1[z].cd_item in (56040687,56040652)) then
						if (s_array1[z].ie_tipo_atendimento	= 1) then
							tp_nota_w := 75;
						elsif (s_array1[z].ie_tipo_atendimento	= 8) then
							tp_nota_w := 85;
						end if;
					end if;
				end if;


				/*OS676179 - Tiago - Unimed Missões/ RS - Cooperativa Médica Ltda.*/

				if	(s_array1[z].cd_cgc_hospital = '87701249000374' AND s_array1[z].cd_item = 91040068) then
					tp_nota_w := 77;
				end if;

				/*OS 838679 - Diego - Irmandade Santa Casa de Misericórdia de POA*/

				if (s_array1[z].cd_cgc_hospital = '92815000000168') and (s_array1[z].cd_item in (40202240,30738024,30738040,30738059)) then
					if (s_array1[z].ie_tipo_atendimento	= 1) then
						tp_nota_w := 75;
					elsif (s_array1[z].ie_tipo_atendimento	= 8) then
						tp_nota_w := 85;
					end if;
				end if;


				end;
			end if;

			if (s_array1[z].ie_tipo_item	= 2) then
				begin
				if (s_array1[z].ie_tipo_atendimento	= 1) then
					tp_nota_w			:= 76;
				elsif (s_array1[z].ie_tipo_atendimento	= 8) then
					tp_nota_w			:= 86;
				elsif (s_array1[z].ie_tipo_atendimento	= 3) then
					tp_nota_w			:= 55;
				elsif (s_array1[z].ie_tipo_atendimento	= 7) then
					tp_nota_w			:= 35;
				else
					tp_nota_w			:= 55;
				end if;
				end;
			end if;

			insert into w_interf_conta_item_nota(
				nr_tipo_nota,
				ie_tipo_item,
				cd_item,
				ie_origem_proced,
				nr_seq_item,
				nr_interno_conta)
			values (
				tp_nota_w,
				s_array1[z].ie_tipo_item,
				s_array1[z].cd_item,
				s_array1[z].ie_origem_proced,
				s_array1[z].nr_seq_item,
				nr_interno_conta_p);

		end if;

		end;
	end loop;
    end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_tipo_nota_ipe ( nr_interno_conta_p bigint) FROM PUBLIC;

