-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copy_phrase_builder ( nr_sequancial_cola_p bigint, nr_sequencial_copy_p bigint, ie_nivel_p bigint, ie_nivel_superior_p bigint, ie_copy_estrutura_p text DEFAULT 'N') AS $body$
DECLARE

  insert_dinamico_w     varchar(600);
  seq_novo_res_w        bigint;
  superior_nome         varchar(100);
  seq_sup_w             bigint;
  seq_category_sup_w    bigint;
  seq_subcategory_sup_w bigint;
  seq_complement_sup_w bigint;

  cItemCopiado CURSOR(nr_sequencia_pc  bigint, ie_nivel_pc  bigint)
  FOR
    SELECT 1 AS ordem,
      nr_sequencia,
      0 AS nr_seq_superior,
      ds_titulo,
      ds_texto,
      ds_prompt
    FROM phrase_builder_subject
    WHERE nr_sequencia = nr_sequencia_pc
    AND 1              = ie_nivel_pc
  
UNION

  SELECT 2 AS ordem,
    nr_sequencia,
    nr_seq_subject AS nr_seq_superior,
    ds_titulo,
    ds_texto,
    ds_prompt
  FROM phrase_builder_category
  WHERE nr_sequencia = nr_sequencia_pc
  AND 2              = ie_nivel_pc
  
UNION

  SELECT 3 AS ordem,
    nr_sequencia,
    nr_seq_category AS nr_seq_superior,
    ds_titulo,
    ds_texto,
    ds_prompt
  FROM phrase_builder_subcategory
  WHERE nr_sequencia = nr_sequencia_pc
  AND 3              = ie_nivel_pc
  
UNION

  SELECT 4 AS ordem,
    nr_sequencia,
    nr_seq_subcategory AS nr_seq_superior,
    ds_titulo,
    ds_texto,
    ds_prompt
  FROM phrase_builder_complement
  WHERE nr_sequencia = nr_sequencia_pc
  AND 4              = ie_nivel_pc
  ORDER BY ordem,
    nr_seq_superior,
    nr_sequencia;
  itemCopiado_w cItemCopiado%rowtype;

  cItemSubject CURSOR(nr_sequencia_pc  bigint)
  FOR
    SELECT 1 AS ordem,
      nr_sequencia,
      0 AS nr_seq_superior,
      ds_titulo,
      ds_texto,
      ds_prompt
    FROM phrase_builder_subject
    WHERE nr_sequencia = nr_sequencia_pc
    ORDER BY nr_sequencia;

  cItemCategory CURSOR(nr_sequencia_pc  bigint)
  FOR
    SELECT 2 AS ordem,
      nr_sequencia,
      nr_seq_subject AS nr_seq_superior,
      ds_titulo,
      ds_texto,
      ds_prompt
    FROM phrase_builder_category
    WHERE nr_seq_subject = nr_sequencia_pc
    ORDER BY nr_sequencia;
  itemCategory_w cItemCategory%rowtype;

  cItemSubCategory CURSOR(nr_sequencia_pc  bigint)
  FOR
    SELECT 3 AS ordem,
      nr_sequencia,
      nr_seq_category AS nr_seq_superior,
      ds_titulo,
      ds_texto,
      ds_prompt
    FROM phrase_builder_subcategory
    WHERE nr_seq_category = nr_sequencia_pc
    ORDER BY nr_sequencia;
  itemSubcategory_w cItemSubCategory%rowtype;

  cItemComplement CURSOR(nr_sequencia_pc  bigint)
  FOR
    SELECT 4 AS ordem,
      nr_sequencia,
      nr_seq_subcategory AS nr_seq_superior,
      ds_titulo,
      ds_texto,
      ds_prompt
    FROM phrase_builder_complement
    WHERE nr_seq_subcategory = nr_sequencia_pc
    ORDER BY nr_sequencia;
  itemComplement_w cItemComplement%rowtype;


BEGIN
  FOR itemCopiado_w IN cItemCopiado(nr_sequencial_copy_p, ie_nivel_p)
  LOOP
    IF (itemCopiado_w.ordem IS NOT NULL AND itemCopiado_w.ordem::text <> '') THEN
      insert_dinamico_w      := ' INSERT INTO ';
      IF (ie_nivel_superior_p = 1) THEN
        insert_dinamico_w    := insert_dinamico_w || 'PHRASE_BUILDER_CATEGORY';
        SELECT nextval('phrase_builder_category_seq') INTO STRICT seq_novo_res_w;
        superior_nome           := 'NR_SEQ_SUBJECT, ';
      ELSIF (ie_nivel_superior_p = 2) THEN
        insert_dinamico_w       := insert_dinamico_w || 'PHRASE_BUILDER_SUBCATEGORY';
        SELECT nextval('phrase_builder_subcategory_seq') INTO STRICT seq_novo_res_w;
        superior_nome           := 'NR_SEQ_CATEGORY, ';
      ELSIF (ie_nivel_superior_p = 3) THEN
        insert_dinamico_w       := insert_dinamico_w || 'PHRASE_BUILDER_COMPLEMENT';
        SELECT nextval('phrase_builder_complement_seq') INTO STRICT seq_novo_res_w;
        superior_nome            := 'NR_SEQ_SUBCATEGORY, ';
      ELSIF (coalesce(ie_nivel_superior_p::text, '') = '') THEN
        insert_dinamico_w        := insert_dinamico_w || 'PHRASE_BUILDER_SUBJECT';
        SELECT nextval('phrase_builder_subject_seq') INTO STRICT seq_novo_res_w;
        superior_nome := '';
      END IF;

      insert_dinamico_w       := insert_dinamico_w || '(DS_PROMPT, DS_TEXTO, DS_TITULO, DT_ATUALIZACAO, DT_ATUALIZACAO_NREC, NM_USUARIO, NM_USUARIO_NREC, '|| superior_nome ||'NR_SEQUENCIA) values';

      IF (coalesce(ie_nivel_superior_p::text, '') = '') THEN
      
        insert_dinamico_w     := insert_dinamico_w || ' (:DS_PROMPT, :DS_TEXTO, :DS_TITULO, :DT_ATUALIZACAO, :DT_ATUALIZACAO_NREC, :NM_USUARIO, :NM_USUARIO_NREC, :NR_SEQUENCIA) ';

        EXECUTE insert_dinamico_w USING itemCopiado_w.DS_PROMPT,
        itemCopiado_w.DS_TEXTO,
        itemCopiado_w.DS_TITULO,
        clock_timestamp(),
        clock_timestamp(),
        wheb_usuario_pck.get_nm_usuario,
        wheb_usuario_pck.get_nm_usuario,
        seq_novo_res_w;
        COMMIT;
      ELSE

        insert_dinamico_w := insert_dinamico_w || ' (:DS_PROMPT, :DS_TEXTO, :DS_TITULO, :DT_ATUALIZACAO, :DT_ATUALIZACAO_NREC, :NM_USUARIO, :NM_USUARIO_NREC, :NR_SEQ_SUPERIOR, :NR_SEQUENCIA) ';

        EXECUTE insert_dinamico_w USING itemCopiado_w.DS_PROMPT,
        itemCopiado_w.DS_TEXTO,
        itemCopiado_w.DS_TITULO,
        clock_timestamp(),
        clock_timestamp(),
        wheb_usuario_pck.get_nm_usuario,
        wheb_usuario_pck.get_nm_usuario,
        nr_sequancial_cola_p,
        seq_novo_res_w;
        COMMIT;
      END IF;

      IF (ie_copy_estrutura_p   = 'S') THEN
      
        seq_sup_w              := seq_novo_res_w;

        IF (itemCopiado_w.ordem = 1) THEN
          FOR itemCategory_w IN cItemCategory(itemCopiado_w.nr_sequencia)
          LOOP
          
            SELECT nextval('phrase_builder_category_seq') INTO STRICT seq_category_sup_w;

            INSERT
            INTO PHRASE_BUILDER_CATEGORY(
                DS_PROMPT,
                DS_TEXTO,
                DS_TITULO,
                DT_ATUALIZACAO,
                DT_ATUALIZACAO_NREC,
                NM_USUARIO,
                NM_USUARIO_NREC,
                NR_SEQ_SUBJECT,
                NR_SEQUENCIA
              )
              VALUES (
                itemCategory_w.DS_PROMPT,
                itemCategory_w.DS_TEXTO,
                itemCategory_w.DS_TITULO,
                clock_timestamp(),
                clock_timestamp(),
                wheb_usuario_pck.get_nm_usuario,
                wheb_usuario_pck.get_nm_usuario,
                seq_sup_w,
                seq_category_sup_w
              );
            FOR itemSubcategory_w IN cItemSubCategory(
              itemCategory_w.nr_sequencia
            )
            LOOP

              SELECT nextval('phrase_builder_subcategory_seq') INTO STRICT seq_subcategory_sup_w;

              INSERT
              INTO PHRASE_BUILDER_SUBCATEGORY(
                  DS_PROMPT,
                  DS_TEXTO,
                  DS_TITULO,
                  DT_ATUALIZACAO,
                  DT_ATUALIZACAO_NREC,
                  NM_USUARIO,
                  NM_USUARIO_NREC,
                  NR_SEQ_CATEGORY,
                  NR_SEQUENCIA
                )
                VALUES (
                  itemSubcategory_w.DS_PROMPT,
                  itemSubcategory_w.DS_TEXTO,
                  itemSubcategory_w.DS_TITULO,
                  clock_timestamp(),
                  clock_timestamp(),
                  wheb_usuario_pck.get_nm_usuario,
                  wheb_usuario_pck.get_nm_usuario,
                  seq_category_sup_w,
                  seq_subcategory_sup_w
                );
              FOR itemComplement_w IN cItemComplement(
                itemSubcategory_w.nr_sequencia
              )
              LOOP

                INSERT
                INTO PHRASE_BUILDER_COMPLEMENT(
                    DS_PROMPT,
                    DS_TEXTO,
                    DS_TITULO,
                    DT_ATUALIZACAO,
                    DT_ATUALIZACAO_NREC,
                    NM_USUARIO,
                    NM_USUARIO_NREC,
                    NR_SEQ_SUBCATEGORY,
                    NR_SEQUENCIA
                  )
                  VALUES (
                    itemComplement_w.DS_PROMPT,
                    itemComplement_w.DS_TEXTO,
                    itemComplement_w.DS_TITULO,
                    clock_timestamp(),
                    clock_timestamp(),
                    wheb_usuario_pck.get_nm_usuario,
                    wheb_usuario_pck.get_nm_usuario,
                    seq_subcategory_sup_w,
                    nextval('phrase_builder_complement_seq')
                  );
              END LOOP;

            END LOOP;

          END LOOP;

        END IF;
        IF (itemCopiado_w.ordem = 2) THEN
          FOR itemSubcategory_w IN cItemSubCategory(
            itemCopiado_w.nr_sequencia
          )
          LOOP

            SELECT nextval('phrase_builder_subcategory_seq') INTO STRICT seq_subcategory_sup_w;

            INSERT
            INTO PHRASE_BUILDER_SUBCATEGORY(
                DS_PROMPT,
                DS_TEXTO,
                DS_TITULO,
                DT_ATUALIZACAO,
                DT_ATUALIZACAO_NREC,
                NM_USUARIO,
                NM_USUARIO_NREC,
                NR_SEQ_CATEGORY,
                NR_SEQUENCIA
              )
              VALUES (
                itemSubcategory_w.DS_PROMPT,
                itemSubcategory_w.DS_TEXTO,
                itemSubcategory_w.DS_TITULO,
                clock_timestamp(),
                clock_timestamp(),
                wheb_usuario_pck.get_nm_usuario,
                wheb_usuario_pck.get_nm_usuario,
                seq_sup_w,
                seq_subcategory_sup_w
              );
            FOR itemComplement_w IN cItemComplement(
              itemSubcategory_w.nr_sequencia
            )
            LOOP

              select nextval('phrase_builder_complement_seq') into STRICT seq_complement_sup_w;

              INSERT
              INTO PHRASE_BUILDER_COMPLEMENT(
                  DS_PROMPT,
                  DS_TEXTO,
                  DS_TITULO,
                  DT_ATUALIZACAO,
                  DT_ATUALIZACAO_NREC,
                  NM_USUARIO,
                  NM_USUARIO_NREC,
                  NR_SEQ_SUBCATEGORY,
                  NR_SEQUENCIA
                )
                VALUES (
                  itemComplement_w.DS_PROMPT,
                  itemComplement_w.DS_TEXTO,
                  itemComplement_w.DS_TITULO,
                  clock_timestamp(),
                  clock_timestamp(),
                  wheb_usuario_pck.get_nm_usuario,
                  wheb_usuario_pck.get_nm_usuario,
                  seq_subcategory_sup_w,
                  seq_complement_sup_w
                );
            END LOOP;

          END LOOP;

        END IF;
        IF (itemCopiado_w.ordem = 3) THEN
          FOR itemComplement_w IN cItemComplement(
            itemCopiado_w.nr_sequencia
          )
          LOOP

            select nextval('phrase_builder_complement_seq') into STRICT seq_complement_sup_w;

            INSERT
            INTO PHRASE_BUILDER_COMPLEMENT(
                DS_PROMPT,
                DS_TEXTO,
                DS_TITULO,
                DT_ATUALIZACAO,
                DT_ATUALIZACAO_NREC,
                NM_USUARIO,
                NM_USUARIO_NREC,
                NR_SEQ_SUBCATEGORY,
                NR_SEQUENCIA
              )
              VALUES (
                itemComplement_w.DS_PROMPT,
                itemComplement_w.DS_TEXTO,
                itemComplement_w.DS_TITULO,
                clock_timestamp(),
                clock_timestamp(),
                wheb_usuario_pck.get_nm_usuario,
                wheb_usuario_pck.get_nm_usuario,
                seq_sup_w,
                seq_complement_sup_w
              );
          END LOOP;

        END IF;

      END IF;

    END IF;

  END LOOP;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copy_phrase_builder ( nr_sequancial_cola_p bigint, nr_sequencial_copy_p bigint, ie_nivel_p bigint, ie_nivel_superior_p bigint, ie_copy_estrutura_p text DEFAULT 'N') FROM PUBLIC;

