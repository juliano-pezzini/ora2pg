-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_copiar_data_feriado ( nr_seq_feriado_p bigint, nr_ano_p bigint, nm_usuario_p text, ds_retorno_p INOUT text) AS $body$
DECLARE


dt_feriado_w	timestamp;
dt_feriado_new_w timestamp;
nr_seq_feriado_w bigint;

BEGIN

if (nr_seq_feriado_p IS NOT NULL AND nr_seq_feriado_p::text <> '') then

	select	dt_feriado
	into STRICT	dt_feriado_w
	from	pls_feriado_regra
	where	nr_sequencia = nr_seq_feriado_p;

	begin
		dt_feriado_new_w := to_date((to_char(dt_feriado_w,'dd/mm')||'/'||to_char(nr_ano_p)),'dd/mm/yyyy');
	exception
	when others then
		ds_retorno_p := 'Data inválida! ';
		goto final;
	end;
	begin
		if (trunc(dt_feriado_w) >= trunc(dt_feriado_new_w) ) then
			ds_retorno_p := 'Ano anterior ao ano atual do feriado! ';
			goto final;
		elsif (nr_ano_p > 2050) then
			ds_retorno_p := 'Ano superior a 2050! ';
			goto final;
		elsif (coalesce(nr_ano_p::text, '') = '') then
			ds_retorno_p := 'Ano não informado! ';
			goto final;
		end if;
	exception
	when others then
		ds_retorno_p := 'Data inválida! ';
		goto final;
	end;




	select	nextval('pls_feriado_regra_seq')
	into STRICT	nr_seq_feriado_w
	;

	insert into pls_feriado_regra(	cd_estabelecimento, ds_feriado, dt_atualizacao,
					dt_atualizacao_nrec,dt_feriado, ie_situacao,
					nm_usuario, nm_usuario_nrec, nr_seq_classificacao_feriado,
					nr_sequencia)
			SELECT	       cd_estabelecimento, ds_feriado, clock_timestamp(),
					clock_timestamp(), dt_feriado_new_w, ie_situacao,
					nm_usuario_p, nm_usuario_p, nr_seq_classificacao_feriado,
					nr_seq_feriado_w
					from	pls_feriado_regra
					where	nr_sequencia = nr_seq_feriado_p;
	insert into	pls_feriado( cd_municipio_ibge, dt_atualizacao, dt_atualizacao_nrec,
					  ie_liberado, nm_usuario, nm_usuario_nrec,
					  nr_seq_regra, nr_sequencia, sg_estado)
			SELECT
					cd_municipio_ibge, clock_timestamp(), clock_timestamp(),
					ie_liberado, nm_usuario_p, nm_usuario_p,
					nr_seq_feriado_w, nextval('pls_feriado_seq'), sg_estado
					from	pls_feriado
					where	nr_seq_regra = nr_seq_feriado_p;
end if;

<<final>>
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_copiar_data_feriado ( nr_seq_feriado_p bigint, nr_ano_p bigint, nm_usuario_p text, ds_retorno_p INOUT text) FROM PUBLIC;

