-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_lote_audit_hist_item (nr_seq_retorno_p bigint, nr_seq_ret_item_p bigint, nr_seq_guia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_ret_item_w		bigint;
nr_interno_conta_w		bigint;
cd_autorizacao_w		varchar(20);
ie_gerar_complemento_w		varchar(1)	:= 'N';
nr_seq_lote_hist_w		bigint;
ie_gerar_setor_w		varchar(1)	:= 'S';
cd_estabelecimento_w		smallint;
cd_convenio_w			integer;
ie_glosa_aceita_grg_w		varchar(1);
ie_somente_motivo_w		varchar(1)	:= 'N';
nr_seq_propaci_w		bigint;
nr_seq_matpaci_w		bigint;
nr_seq_ret_glosa_w		bigint;
ie_itens_sem_vinc_conta_w	varchar(10) 	:= 'N';
ie_gerar_valor_pago_adic_w	varchar(1)	:= 'N';
vl_pago_w			double precision	:= 0;
ie_alterar_acao_glosa_w		varchar(10)	:= 'N';
ie_gerar_acao_w			varchar(1);
nr_sequencia_item_w 		convenio_retorno_glosa.nr_sequencia_item%type;
nr_seq_tiss_conta_proc_w	tiss_conta_proc.nr_sequencia%type;
nr_seq_tiss_conta_desp_w	tiss_conta_desp.nr_sequencia%type;

c01 CURSOR FOR
SELECT	a.nr_sequencia
from	convenio_retorno_item a
where	a.nr_sequencia		= coalesce(nr_seq_ret_item_p,a.nr_sequencia)
and	coalesce(a.cd_autorizacao,substr(wheb_mensagem_pck.get_texto(306761),1,255)) = coalesce(cd_autorizacao_w,substr(wheb_mensagem_pck.get_texto(306761),1,255))
and	a.nr_interno_conta	= nr_interno_conta_w
and 	a.nr_seq_retorno = coalesce(nr_seq_retorno_p,a.nr_seq_retorno);

c02 CURSOR FOR
--alterado para manter o mesmo sequencial de item, ja que os dados sao gerados a partir do retorno e la ja existe a relacao com o item da conta
SELECT	coalesce(a.nr_seq_propaci, OBTER_SEQ_ITEM_CONTA(b.nr_interno_conta,b.cd_autorizacao,a.cd_procedimento,a.ie_origem_proced,null,a.dt_execucao)) nr_seq_propaci,
	coalesce(a.nr_seq_matpaci, OBTER_SEQ_ITEM_CONTA(b.nr_interno_conta,b.cd_autorizacao,null,null,a.cd_material,a.dt_execucao)) nr_seq_matpaci,
	a.nr_sequencia,
	a.nr_sequencia_item,
	a.nr_seq_tiss_conta_proc,
	a.nr_seq_tiss_conta_desp
from	convenio_retorno_glosa a,
	convenio_retorno_item b
where	b.nr_sequencia		= a.nr_seq_ret_item	
and	b.nr_sequencia		= nr_seq_ret_item_w
and	coalesce(a.nr_seq_propaci::text, '') = ''
and	coalesce(a.nr_seq_matpaci::text, '') = ''
group by a.nr_seq_propaci,
	a.nr_seq_matpaci,
	OBTER_SEQ_ITEM_CONTA(b.nr_interno_conta,b.cd_autorizacao,a.cd_procedimento,a.ie_origem_proced,null,a.dt_execucao),
	OBTER_SEQ_ITEM_CONTA(b.nr_interno_conta,b.cd_autorizacao,null,null,a.cd_material,a.dt_execucao),
	a.nr_sequencia,
	a.nr_sequencia_item,
	a.nr_seq_tiss_conta_proc,
	a.nr_seq_tiss_conta_desp;


BEGIN

select	max(a.nr_interno_conta),
	max(a.cd_autorizacao),
	max(a.nr_seq_lote_hist),
	max(c.cd_estabelecimento),
	max(c.cd_convenio)
into STRICT	nr_interno_conta_w,
	cd_autorizacao_w,
	nr_seq_lote_hist_w,
	cd_estabelecimento_w,
	cd_convenio_w
from	lote_auditoria c,
	lote_audit_hist b,
	lote_audit_hist_guia a
where	b.nr_seq_lote_audit	= c.nr_sequencia
and	a.nr_seq_lote_hist	= b.nr_sequencia
and	a.nr_sequencia		= nr_seq_guia_p;

select	max(a.ie_glosa_aceita_grg)
into STRICT	ie_glosa_aceita_grg_w
from	convenio_estabelecimento a
where	a.cd_estabelecimento	= cd_estabelecimento_w
and	a.cd_convenio		= cd_convenio_w;

if (nr_seq_ret_item_p IS NOT NULL AND nr_seq_ret_item_p::text <> '') then

	ie_somente_motivo_w := obter_param_usuario(27, 132, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_somente_motivo_w);
	ie_gerar_setor_w := obter_param_usuario(27, 136, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_gerar_setor_w);
	ie_gerar_complemento_w := obter_param_usuario(27, 177, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_gerar_complemento_w);
	ie_alterar_acao_glosa_w := obter_param_usuario(27, 204, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_alterar_acao_glosa_w);	
	ie_gerar_valor_pago_adic_w := obter_param_usuario(27, 266, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_gerar_valor_pago_adic_w);

end if;

ie_itens_sem_vinc_conta_w := obter_param_usuario(69, 61, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_itens_sem_vinc_conta_w);
ie_gerar_acao_w := obter_param_usuario(69, 29, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_gerar_acao_w);


if (ie_gerar_acao_w = 'A') then
	ie_gerar_acao_w := 'G';
end if;


/*	S              |Sempre gerar acao de glosa
	N              |Nao copiar a acao da glosa existente nos itens da ultima analise na GRG
	G              |Nao gerar a acao de glosa existente nos itens glosados do 'Retorno convenio'
	A              |Nao gerar acao de glosa ao utilizar opcao 'Gerar lote de reapresentacao GRG' 
*/




/* ahoffelder - OS 424937 - 28/03/2012 - coloquei num cursor porque pode ocorrer de uma mesma guia aparecer mais de uma vez no mesmo retorno */

open	c01;
loop
fetch	c01 into
	nr_seq_ret_item_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	insert	into lote_audit_hist_item(cd_motivo_glosa,
		cd_resposta,
		ds_complemento,
		ds_observacao,
		dt_atualizacao,
		dt_historico,
		ie_acao_glosa,
		ie_status,
		nm_usuario,
		nr_seq_guia,
		nr_seq_lote,
		nr_seq_matpaci,
		nr_seq_propaci,
		nr_Seq_partic,
		nr_seq_ret_glosa,
		nr_seq_ret_item,
		nr_sequencia,
		vl_glosa,
		vl_amenor,
		vl_pago,
		qt_item,
		nr_seq_hist_audit,
		nr_seq_conpaci_ret,
		cd_setor_responsavel,
		vl_saldo_amenor,
		vl_saldo,
		vl_glosa_informada,
		vl_adicional,
		cd_motivo_glosa_tiss,
		ie_funcao_medico,
		nr_sequencia_item,
		nr_seq_tiss_conta_proc,
		nr_seq_tiss_conta_desp)
	(SELECT	cd_motivo_glosa,
		cd_resposta,
		ds_complemento,
		ds_observacao,
		clock_timestamp(),
		clock_timestamp(),
		CASE WHEN ie_gerar_acao_w='G' THEN null  ELSE ie_acao_glosa END ,
		'A',
		nm_usuario_p,
		nr_seq_guia_p,
		nr_seq_lote_hist_w,
		nr_seq_matpaci,
		nr_seq_propaci,
		nr_seq_partic,
		nr_sequencia,
		nr_seq_ret_item_w,
		nextval('lote_audit_hist_item_seq'),
		vl_glosa,
		vl_amenor,
		CASE WHEN coalesce(ie_gerar_valor_pago_adic_w,'N')='S' THEN vl_pago WHEN coalesce(ie_gerar_valor_pago_adic_w,'N')='L' THEN vl_pago  ELSE 0 END ,
		qt_glosa,
		nr_seq_hist_audit,
		nr_seq_conpaci_ret,
		cd_setor_responsavel,
		vl_saldo_amenor,
		vl_saldo,
		vl_glosa_informada,
		vl_adicional,
		cd_motivo_glosa_tiss,
		ie_funcao_medico,
		nr_sequencia_item,
		nr_seq_tiss_conta_proc,
		nr_seq_tiss_conta_desp
	from (select	a.cd_motivo_glosa,
			a.cd_resposta,
			CASE WHEN ie_gerar_complemento_w='S' THEN a.ds_complemento  ELSE null END  ds_complemento,
			coalesce(a.ds_justificativa,a.ds_observacao) ds_observacao,
			c.ie_acao_glosa ie_acao_glosa,
			null nr_seq_matpaci,
			a.nr_seq_propaci,
			a.nr_seq_partic nr_seq_partic,
			a.nr_sequencia,
			CASE WHEN c.ie_acao_glosa='A' THEN a.vl_glosa  ELSE 0 END  vl_glosa,
			CASE WHEN c.ie_acao_glosa='R' THEN a.vl_glosa  ELSE 0 END  vl_amenor,
			coalesce(a.vl_pago_digitado,(obter_dados_ret_movto_glosa(a.nr_sequencia, 3))::numeric ) vl_pago,
			a.qt_glosa,
			b.nr_seq_hist_audit,
			b.nr_seq_conpaci_ret,
			CASE WHEN ie_gerar_setor_w='N' THEN null  ELSE coalesce(a.cd_setor_responsavel,d.cd_setor_atendimento) END  cd_setor_responsavel,
			a.vl_glosa vl_saldo_amenor,
			a.vl_glosa vl_saldo,
			a.vl_glosa vl_glosa_informada,
			a.vl_amaior vl_adicional,
			tiss_obter_motivo_glosa_movto(a.nr_sequencia,a.cd_motivo_glosa,cd_convenio_w) cd_motivo_glosa_tiss,
			obter_funcao_medico_partic(a.nr_seq_propaci, a.nr_seq_partic) ie_funcao_medico,
			a.nr_sequencia_item nr_sequencia_item,
			a.nr_seq_tiss_conta_proc nr_seq_tiss_conta_proc,
			a.nr_seq_tiss_conta_desp nr_seq_tiss_conta_desp
		FROM procedimento_paciente d, convenio_retorno_glosa a
LEFT OUTER JOIN conta_paciente_ret_hist b ON (a.nr_seq_conpaci_ret_hist = b.nr_sequencia)
LEFT OUTER JOIN motivo_glosa c ON (a.cd_motivo_glosa = c.cd_motivo_glosa)
WHERE (coalesce(ie_glosa_aceita_grg_w,'S') = 'S' or ((a.cd_motivo_glosa IS NOT NULL AND a.cd_motivo_glosa::text <> '')	and c.ie_acao_glosa <> 'A')) and a.nr_seq_ret_item		= nr_seq_ret_item_w   and a.nr_seq_propaci		= d.nr_sequencia and (coalesce(ie_somente_motivo_w,'N') 	= 'N' or
			 (a.cd_motivo_glosa IS NOT NULL AND a.cd_motivo_glosa::text <> '')) and coalesce(ie_alterar_acao_glosa_w,'N') = 'N'
		 
union

		SELECT	a.cd_motivo_glosa,
			a.cd_resposta,
			CASE WHEN ie_gerar_complemento_w='S' THEN a.ds_complemento  ELSE null END  ds_complemento,
			coalesce(a.ds_justificativa,a.ds_observacao) ds_observacao,
			coalesce(a.ie_acao_glosa,c.ie_acao_glosa) ie_acao_glosa,
			null nr_seq_matpaci,
			a.nr_seq_propaci,
			a.nr_seq_partic nr_seq_partic,
			a.nr_sequencia,
			CASE WHEN coalesce(a.ie_acao_glosa,c.ie_acao_glosa)='A' THEN a.vl_glosa  ELSE 0 END  vl_glosa,
			CASE WHEN coalesce(a.ie_acao_glosa,c.ie_acao_glosa)='R' THEN a.vl_glosa  ELSE 0 END  vl_amenor,
			coalesce(a.vl_pago_digitado,(obter_dados_ret_movto_glosa(a.nr_sequencia, 3))::numeric ) vl_pago,
			a.qt_glosa,
			b.nr_seq_hist_audit,
			b.nr_seq_conpaci_ret,
			CASE WHEN ie_gerar_setor_w='N' THEN null  ELSE coalesce(a.cd_setor_responsavel,d.cd_setor_atendimento) END  cd_setor_responsavel,
			a.vl_glosa vl_saldo_amenor,
			a.vl_glosa vl_saldo,
			a.vl_glosa vl_glosa_informada,
			a.vl_amaior vl_adicional,
			tiss_obter_motivo_glosa_movto(a.nr_sequencia,a.cd_motivo_glosa,cd_convenio_w) cd_motivo_glosa_tiss,
			obter_funcao_medico_partic(a.nr_seq_propaci, a.nr_seq_partic) ie_funcao_medico,
			a.nr_sequencia_item nr_sequencia_item,
			a.nr_seq_tiss_conta_proc nr_seq_tiss_conta_proc,
			a.nr_seq_tiss_conta_desp nr_seq_tiss_conta_desp
		FROM procedimento_paciente d, convenio_retorno_glosa a
LEFT OUTER JOIN conta_paciente_ret_hist b ON (a.nr_seq_conpaci_ret_hist = b.nr_sequencia)
LEFT OUTER JOIN motivo_glosa c ON (a.cd_motivo_glosa = c.cd_motivo_glosa)
WHERE (coalesce(ie_glosa_aceita_grg_w,'S') = 'S' or ((a.cd_motivo_glosa IS NOT NULL AND a.cd_motivo_glosa::text <> '') and coalesce(a.ie_acao_glosa,c.ie_acao_glosa) <> 'A')) and a.nr_seq_ret_item		= nr_seq_ret_item_w   and a.nr_seq_propaci		= d.nr_sequencia and (coalesce(ie_somente_motivo_w,'N') = 'N' or (a.cd_motivo_glosa IS NOT NULL AND a.cd_motivo_glosa::text <> '')) and coalesce(ie_alterar_acao_glosa_w,'N') = 'S'
		 
union

		select	a.cd_motivo_glosa,
			a.cd_resposta,
			CASE WHEN ie_gerar_complemento_w='S' THEN a.ds_complemento  ELSE null END  ds_complemento,
			coalesce(a.ds_justificativa,a.ds_observacao) ds_observacao,
			c.ie_acao_glosa ie_acao_glosa,
			a.nr_seq_matpaci,
			null,
			null,
			a.nr_sequencia,
			CASE WHEN c.ie_acao_glosa='A' THEN a.vl_glosa  ELSE 0 END  vl_glosa,
			CASE WHEN c.ie_acao_glosa='R' THEN a.vl_glosa  ELSE 0 END  vl_amenor,
			coalesce(a.vl_pago_digitado,(obter_dados_ret_movto_glosa(a.nr_sequencia, 3))::numeric ) vl_pago,
			a.qt_glosa,
			b.nr_seq_hist_audit,
			b.nr_seq_conpaci_ret,
			CASE WHEN ie_gerar_setor_w='N' THEN null  ELSE coalesce(a.cd_setor_responsavel,d.cd_setor_atendimento) END  cd_setor_responsavel,
			a.vl_glosa vl_saldo_amenor,
			a.vl_glosa vl_saldo,
			a.vl_glosa vl_glosa_informada,
			a.vl_amaior vl_adicional,
			tiss_obter_motivo_glosa_movto(a.nr_sequencia,a.cd_motivo_glosa,cd_convenio_w) cd_motivo_glosa_tiss,
			obter_funcao_medico_partic(a.nr_seq_propaci, a.nr_seq_partic) ie_funcao_medico,
			a.nr_sequencia_item nr_sequencia_item,
			a.nr_seq_tiss_conta_proc nr_seq_tiss_conta_proc,
			a.nr_seq_tiss_conta_desp nr_seq_tiss_conta_desp
		FROM material_atend_paciente d, convenio_retorno_glosa a
LEFT OUTER JOIN conta_paciente_ret_hist b ON (a.nr_seq_conpaci_ret_hist = b.nr_sequencia)
LEFT OUTER JOIN motivo_glosa c ON (a.cd_motivo_glosa = c.cd_motivo_glosa)
WHERE (coalesce(ie_glosa_aceita_grg_w,'S') = 'S' or ((a.cd_motivo_glosa IS NOT NULL AND a.cd_motivo_glosa::text <> '') and c.ie_acao_glosa <> 'A')) and a.nr_seq_ret_item		= nr_seq_ret_item_w   and a.nr_seq_matpaci		= d.nr_sequencia and (coalesce(ie_somente_motivo_w,'N') = 'N' or (a.cd_motivo_glosa IS NOT NULL AND a.cd_motivo_glosa::text <> '')) and coalesce(ie_alterar_acao_glosa_w,'N') = 'N'
		 
union

		select	a.cd_motivo_glosa,
			a.cd_resposta,
			CASE WHEN ie_gerar_complemento_w='S' THEN a.ds_complemento  ELSE null END  ds_complemento,
			coalesce(a.ds_justificativa,a.ds_observacao) ds_observacao,
			coalesce(a.ie_acao_glosa,c.ie_acao_glosa) ie_acao_glosa,
			a.nr_seq_matpaci,
			null,
			null,
			a.nr_sequencia,
			CASE WHEN coalesce(a.ie_acao_glosa,c.ie_acao_glosa)='A' THEN a.vl_glosa  ELSE 0 END  vl_glosa,
			CASE WHEN coalesce(a.ie_acao_glosa,c.ie_acao_glosa)='R' THEN a.vl_glosa  ELSE 0 END  vl_amenor,
			coalesce(a.vl_pago_digitado,(obter_dados_ret_movto_glosa(a.nr_sequencia, 3))::numeric ) vl_pago,
			a.qt_glosa,
			b.nr_seq_hist_audit,
			b.nr_seq_conpaci_ret,
			CASE WHEN ie_gerar_setor_w='N' THEN null  ELSE coalesce(a.cd_setor_responsavel,d.cd_setor_atendimento) END  cd_setor_responsavel,
			a.vl_glosa vl_saldo_amenor,
			a.vl_glosa vl_saldo,
			a.vl_glosa vl_glosa_informada,
			a.vl_amaior vl_adicional,
			tiss_obter_motivo_glosa_movto(a.nr_sequencia,a.cd_motivo_glosa,cd_convenio_w) cd_motivo_glosa_tiss,
			obter_funcao_medico_partic(a.nr_seq_propaci, a.nr_seq_partic) ie_funcao_medico,
			a.nr_sequencia_item nr_sequencia_item,
			a.nr_seq_tiss_conta_proc nr_seq_tiss_conta_proc,
			a.nr_seq_tiss_conta_desp nr_seq_tiss_conta_desp
		FROM material_atend_paciente d, convenio_retorno_glosa a
LEFT OUTER JOIN conta_paciente_ret_hist b ON (a.nr_seq_conpaci_ret_hist = b.nr_sequencia)
LEFT OUTER JOIN motivo_glosa c ON (a.cd_motivo_glosa = c.cd_motivo_glosa)
WHERE (coalesce(ie_glosa_aceita_grg_w,'S') = 'S' or ((a.cd_motivo_glosa IS NOT NULL AND a.cd_motivo_glosa::text <> '') and coalesce(a.ie_acao_glosa,c.ie_acao_glosa) <> 'A')) and a.nr_seq_ret_item		= nr_seq_ret_item_w   and a.nr_seq_matpaci		= d.nr_sequencia and (coalesce(ie_somente_motivo_w,'N') = 'N' or (a.cd_motivo_glosa IS NOT NULL AND a.cd_motivo_glosa::text <> '')) and coalesce(ie_alterar_acao_glosa_w,'N') = 'S' ) alias74);

end	loop;
close	c01;

if (coalesce(ie_itens_sem_vinc_conta_w,'N') = 'S') then

	open C02;
	loop
	fetch C02 into	
		nr_seq_propaci_w,
		nr_seq_matpaci_w,
		nr_seq_ret_glosa_w,
		nr_sequencia_item_w,
		nr_seq_tiss_conta_proc_w,
		nr_seq_tiss_conta_desp_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */

		insert	into lote_audit_hist_item(cd_motivo_glosa,
			cd_resposta,
			ds_complemento,
			ds_observacao,
			dt_atualizacao,
			dt_historico,
			ie_acao_glosa,
			ie_status,
			nm_usuario,
			nr_seq_guia,
			nr_seq_lote,
			nr_seq_matpaci,
			nr_seq_propaci,
			nr_Seq_partic,
			nr_seq_ret_glosa,
			nr_seq_ret_item,
			nr_sequencia,
			vl_glosa,
			vl_amenor,
			vl_pago,
			qt_item,
			nr_seq_hist_audit,
			nr_seq_conpaci_ret,
			cd_setor_responsavel,
			vl_saldo_amenor,
			vl_saldo,
			vl_glosa_informada,
			vl_adicional,
			ie_funcao_medico,
			nr_sequencia_item,
			nr_seq_tiss_conta_proc,
			nr_seq_tiss_conta_desp)
		(SELECT	cd_motivo_glosa,
			cd_resposta,
			ds_complemento,
			ds_observacao,
			clock_timestamp(),
			clock_timestamp(),
			CASE WHEN ie_gerar_acao_w='G' THEN null  ELSE ie_acao_glosa END ,
			'A',
			nm_usuario_p,
			nr_seq_guia_p,
			nr_seq_lote_hist_w,
			nr_seq_matpaci,
			nr_seq_propaci,
			nr_seq_partic,
			nr_sequencia,
			nr_seq_ret_item_w,
			nextval('lote_audit_hist_item_seq'),
			vl_glosa,
			vl_amenor,
			CASE WHEN coalesce(ie_gerar_valor_pago_adic_w,'N')='S' THEN vl_pago WHEN coalesce(ie_gerar_valor_pago_adic_w,'N')='L' THEN vl_pago  ELSE 0 END ,
			qt_glosa,
			nr_seq_hist_audit,
			nr_seq_conpaci_ret,
			cd_setor_responsavel,
			vl_saldo_amenor,
			vl_saldo,
			vl_glosa_informada,
			vl_adicional,
			ie_funcao_medico,
			nr_sequencia_item_w,
			nr_seq_tiss_conta_proc_w,
			nr_seq_tiss_conta_desp_w
		from (
			SELECT	a.cd_motivo_glosa,
				a.cd_resposta,
				CASE WHEN ie_gerar_complemento_w='S' THEN a.ds_complemento  ELSE null END  ds_complemento,
				coalesce(a.ds_justificativa,a.ds_observacao) ds_observacao,
				c.ie_acao_glosa ie_acao_glosa,
				null nr_seq_matpaci,
				nr_seq_propaci_w nr_seq_propaci,
				a.nr_seq_partic nr_seq_partic,
				a.nr_sequencia,
				CASE WHEN c.ie_acao_glosa='A' THEN a.vl_glosa  ELSE 0 END  vl_glosa,
				CASE WHEN c.ie_acao_glosa='R' THEN a.vl_glosa  ELSE 0 END  vl_amenor,
				coalesce(a.vl_pago_digitado,(obter_dados_ret_movto_glosa(a.nr_sequencia, 3))::numeric ) vl_pago,
				a.qt_glosa,
				b.nr_seq_hist_audit,
				b.nr_seq_conpaci_ret,
				CASE WHEN ie_gerar_setor_w='N' THEN null  ELSE coalesce(a.cd_setor_responsavel,d.cd_setor_atendimento) END  cd_setor_responsavel,
				a.vl_glosa vl_saldo_amenor,
				a.vl_glosa vl_saldo,
				a.vl_glosa vl_glosa_informada,
				a.vl_amaior vl_adicional,
				obter_funcao_medico_partic(a.nr_seq_propaci, a.nr_seq_partic) ie_funcao_medico
			FROM procedimento_paciente d, convenio_retorno_glosa a
LEFT OUTER JOIN conta_paciente_ret_hist b ON (a.nr_seq_conpaci_ret_hist = b.nr_sequencia)
LEFT OUTER JOIN motivo_glosa c ON (a.cd_motivo_glosa = c.cd_motivo_glosa)
WHERE (coalesce(ie_glosa_aceita_grg_w,'S') = 'S' or ((a.cd_motivo_glosa IS NOT NULL AND a.cd_motivo_glosa::text <> '') and c.ie_acao_glosa <> 'A')) and a.nr_seq_ret_item		= nr_seq_ret_item_w   and a.nr_sequencia			= nr_seq_ret_glosa_w and d.nr_sequencia			= nr_seq_propaci_w and (coalesce(ie_somente_motivo_w,'N') = 'N' or (a.cd_motivo_glosa IS NOT NULL AND a.cd_motivo_glosa::text <> '')) and coalesce(ie_alterar_acao_glosa_w,'N') = 'N'
			
union

			select	a.cd_motivo_glosa,
				a.cd_resposta,
				CASE WHEN ie_gerar_complemento_w='S' THEN a.ds_complemento  ELSE null END  ds_complemento,
				coalesce(a.ds_justificativa,a.ds_observacao) ds_observacao,
				coalesce(a.ie_acao_glosa,c.ie_acao_glosa) ie_acao_glosa,
				null nr_seq_matpaci,
				nr_seq_propaci_w nr_seq_propaci,
				a.nr_seq_partic nr_seq_partic,
				a.nr_sequencia,
				CASE WHEN coalesce(a.ie_acao_glosa,c.ie_acao_glosa)='A' THEN a.vl_glosa  ELSE 0 END  vl_glosa,
				CASE WHEN coalesce(a.ie_acao_glosa,c.ie_acao_glosa)='R' THEN a.vl_glosa  ELSE 0 END  vl_amenor,
				coalesce(a.vl_pago_digitado,(obter_dados_ret_movto_glosa(a.nr_sequencia, 3))::numeric ) vl_pago,
				a.qt_glosa,
				b.nr_seq_hist_audit,
				b.nr_seq_conpaci_ret,
				CASE WHEN ie_gerar_setor_w='N' THEN null  ELSE coalesce(a.cd_setor_responsavel,d.cd_setor_atendimento) END  cd_setor_responsavel,
				a.vl_glosa vl_saldo_amenor,
				a.vl_glosa vl_saldo,
				a.vl_glosa vl_glosa_informada,
				a.vl_amaior vl_adicional,
				obter_funcao_medico_partic(a.nr_seq_propaci, a.nr_seq_partic) ie_funcao_medico
			FROM procedimento_paciente d, convenio_retorno_glosa a
LEFT OUTER JOIN conta_paciente_ret_hist b ON (a.nr_seq_conpaci_ret_hist = b.nr_sequencia)
LEFT OUTER JOIN motivo_glosa c ON (a.cd_motivo_glosa = c.cd_motivo_glosa)
WHERE (coalesce(ie_glosa_aceita_grg_w,'S') = 'S' or ((a.cd_motivo_glosa IS NOT NULL AND a.cd_motivo_glosa::text <> '') and coalesce(a.ie_acao_glosa,c.ie_acao_glosa) <> 'A')) and a.nr_seq_ret_item		= nr_seq_ret_item_w   and a.nr_sequencia			= nr_seq_ret_glosa_w and d.nr_sequencia			= nr_seq_propaci_w and (coalesce(ie_somente_motivo_w,'N') = 'N' or (a.cd_motivo_glosa IS NOT NULL AND a.cd_motivo_glosa::text <> '')) and coalesce(ie_alterar_acao_glosa_w,'N') = 'S'
			 
union

			select	a.cd_motivo_glosa,
				a.cd_resposta,
				CASE WHEN ie_gerar_complemento_w='S' THEN a.ds_complemento  ELSE null END  ds_complemento,
				coalesce(a.ds_justificativa,a.ds_observacao) ds_observacao,
				c.ie_acao_glosa ie_acao_glosa,
				nr_seq_matpaci_w nr_seq_matpaci,
				null,
				null,
				a.nr_sequencia,
				CASE WHEN c.ie_acao_glosa='A' THEN a.vl_glosa  ELSE 0 END  vl_glosa,
				CASE WHEN c.ie_acao_glosa='R' THEN a.vl_glosa  ELSE 0 END  vl_amenor,
				coalesce(a.vl_pago_digitado,(obter_dados_ret_movto_glosa(a.nr_sequencia, 3))::numeric )  vl_pago,
				a.qt_glosa,
				b.nr_seq_hist_audit,
				b.nr_seq_conpaci_ret,
				CASE WHEN ie_gerar_setor_w='N' THEN null  ELSE coalesce(a.cd_setor_responsavel,d.cd_setor_atendimento) END  cd_setor_responsavel,
				a.vl_glosa vl_saldo_amenor,
				a.vl_glosa vl_saldo,
				a.vl_glosa vl_glosa_informada,
				a.vl_amaior vl_adicional,
				obter_funcao_medico_partic(a.nr_seq_propaci, a.nr_seq_partic) ie_funcao_medico
			FROM material_atend_paciente d, convenio_retorno_glosa a
LEFT OUTER JOIN conta_paciente_ret_hist b ON (a.nr_seq_conpaci_ret_hist = b.nr_sequencia)
LEFT OUTER JOIN motivo_glosa c ON (a.cd_motivo_glosa = c.cd_motivo_glosa)
WHERE (coalesce(ie_glosa_aceita_grg_w,'S') = 'S' or ((a.cd_motivo_glosa IS NOT NULL AND a.cd_motivo_glosa::text <> '') and c.ie_acao_glosa <> 'A')) and a.nr_seq_ret_item		= nr_seq_ret_item_w   and a.nr_sequencia			= nr_seq_ret_glosa_w and d.nr_sequencia			= nr_seq_matpaci_w and (coalesce(ie_somente_motivo_w,'N') = 'N' or (a.cd_motivo_glosa IS NOT NULL AND a.cd_motivo_glosa::text <> '')) and coalesce(ie_alterar_acao_glosa_w,'N') = 'N'
			 
union

			select	a.cd_motivo_glosa,
				a.cd_resposta,
				CASE WHEN ie_gerar_complemento_w='S' THEN a.ds_complemento  ELSE null END  ds_complemento,
				coalesce(a.ds_justificativa,a.ds_observacao) ds_observacao,
				coalesce(a.ie_acao_glosa,c.ie_acao_glosa) ie_acao_glosa,
				nr_seq_matpaci_w nr_seq_matpaci,
				null,
				null,
				a.nr_sequencia,
				CASE WHEN coalesce(a.ie_acao_glosa,c.ie_acao_glosa)='A' THEN a.vl_glosa  ELSE 0 END  vl_glosa,
				CASE WHEN coalesce(a.ie_acao_glosa,c.ie_acao_glosa)='R' THEN a.vl_glosa  ELSE 0 END  vl_amenor,
				coalesce(a.vl_pago_digitado,(obter_dados_ret_movto_glosa(a.nr_sequencia, 3))::numeric ) vl_pago,
				a.qt_glosa,
				b.nr_seq_hist_audit,
				b.nr_seq_conpaci_ret,
				CASE WHEN ie_gerar_setor_w='N' THEN null  ELSE coalesce(a.cd_setor_responsavel,d.cd_setor_atendimento) END  cd_setor_responsavel,
				a.vl_glosa vl_saldo_amenor,
				a.vl_glosa vl_saldo,
				a.vl_glosa vl_glosa_informada,
				a.vl_amaior vl_adicional,
				obter_funcao_medico_partic(a.nr_seq_propaci, a.nr_seq_partic) ie_funcao_medico
			FROM material_atend_paciente d, convenio_retorno_glosa a
LEFT OUTER JOIN conta_paciente_ret_hist b ON (a.nr_seq_conpaci_ret_hist = b.nr_sequencia)
LEFT OUTER JOIN motivo_glosa c ON (a.cd_motivo_glosa = c.cd_motivo_glosa)
WHERE (coalesce(ie_glosa_aceita_grg_w,'S') = 'S' or ((a.cd_motivo_glosa IS NOT NULL AND a.cd_motivo_glosa::text <> '') and coalesce(a.ie_acao_glosa,c.ie_acao_glosa) <> 'A')) and a.nr_seq_ret_item		= nr_seq_ret_item_w   and a.nr_sequencia			= nr_seq_ret_glosa_w and d.nr_sequencia			= nr_seq_matpaci_w and (coalesce(ie_somente_motivo_w,'N') = 'N' or (a.cd_motivo_glosa IS NOT NULL AND a.cd_motivo_glosa::text <> '')) and coalesce(ie_alterar_acao_glosa_w,'N') = 'S' ) alias70);

	end loop;
	close C02;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_lote_audit_hist_item (nr_seq_retorno_p bigint, nr_seq_ret_item_p bigint, nr_seq_guia_p bigint, nm_usuario_p text) FROM PUBLIC;

