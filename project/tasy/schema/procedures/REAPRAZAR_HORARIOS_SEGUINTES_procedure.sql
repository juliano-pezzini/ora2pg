-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE reaprazar_horarios_seguintes ( nr_atendimento_p bigint, cd_item_p text, cd_intervalo_p text, qt_item_p bigint, dt_horario_p timestamp, ie_reaprazar_seguintes_p text, nr_prescricao_p bigint, nm_usuario_p text, nr_agrupamento_p bigint, ie_acm_sn_p text, cd_unidade_medida_p text, nr_prescricoes_p text, qt_minutos_p bigint, nr_seq_mat_cpoe_p bigint) AS $body$
DECLARE


nr_prescricao_w			bigint;
nr_prescricao_ww		bigint;
nr_seq_item_w			bigint;
nr_seq_item_ww			bigint;
nr_seq_horario_w		bigint;
nr_seq_horario_ww		bigint;
nr_etapa_sol_w			smallint;
nr_prescr_atual_w		bigint := 0;
nr_seq_processo_w		bigint;
nr_seq_processo_ww		bigint;
nr_seq_solucao_w		bigint;
nr_seq_processo_novo_w	bigint;
nr_agrupamento_w		double precision;
nr_agrupamento_ww		double precision;
varsql_row_count_w		bigint;
nr_seq_lote_w			bigint;
cont_w					bigint := 0;
qt_registros_vetor_w	bigint;
qt_controle_ww			bigint := 0;
x						bigint := 0;
nr_sequencia_w			bigint;
cd_setor_pac_w			bigint;
ie_mat_procedimento_w	varchar(3);
ds_lista_eliminados_w	varchar(255);
ds_status_w				varchar(255);
ds_item_w				varchar(255);
ie_entrou_w				varchar(2);
ds_param_proc_w			varchar(2000);
cd_material_exame_w		varchar(20);
ie_reaprazar_assoc_w	varchar(1);
ie_proc_associados_w	varchar(1);
ie_acm_w				varchar(1);
ie_sn_w					varchar(1);
ie_acm_sn_w				varchar(1);
ie_acm_sn_ww			varchar(1) := null;
ie_elimina_horario_w	varchar(1)	:= 'S';
ie_desagrupa_proced_w	varchar(1);
ie_perm_ant_validade_w	varchar(1);
ie_inativa_horario_ant_w varchar(1);
ie_data_proc_w			varchar(15);
ie_data_lib_prescr_w	varchar(15);
ie_exibe_suspenso_w		varchar(15);
ie_gera_lote_w			varchar(1);
ie_consiste_lote_atendido_w varchar(2);
ie_status_lote_w		varchar(255);
dt_horario_w			timestamp;
dt_horario_ww			timestamp;
dt_horario_desejado_w	timestamp;
ie_operacao_w			varchar(3);
qt_operacao_w			bigint;
ie_24_h_w				varchar(1);
dt_proxima_dose_w		timestamp;
dt_proxima_dose_new_w	timestamp;
cd_evolucao_w			bigint;
qt_minutos_w			integer;
										
c03 CURSOR FOR
SELECT	a.nr_prescricao nr_prescricao,
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		c.nr_seq_processo,
		b.nr_agrupamento,
		c.dt_horario,
		coalesce(b.ie_acm,'N'),
		coalesce(b.ie_se_necessario,'N')
from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_material = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		obter_se_prescr_lib_adep(coalesce(a.dt_liberacao_medico, b.dt_lib_material), coalesce(a.dt_liberacao,b.dt_lib_material), coalesce(a.dt_liberacao_farmacia, b.dt_lib_farmacia), 'E') = 'S'
and		b.ie_agrupador in (1)
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.ie_adep,'S') = 'S'
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		a.nr_atendimento = nr_atendimento_p
and		b.nr_prescricao	<> nr_prescricao_p
and		a.dt_validade_prescr > clock_timestamp()
and		b.cd_material 	= cd_item_p
and		coalesce(cd_unidade_medida_p,'XPTO') in ('XPTO', c.cd_unidade_medida_dose)
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		obter_se_acm_sn(b.ie_acm, b.ie_se_necessario) = ie_acm_sn_p
and		obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, null, null, nr_prescricoes_p) = 'N'
and		coalesce(b.qt_dose,1) = coalesce(qt_item_p,coalesce(b.qt_dose,1))
and		(((ie_reaprazar_seguintes_p = 'S' AND c.dt_horario >= dt_horario_p) or
		  (ie_reaprazar_seguintes_p = 'N' AND c.dt_horario = dt_horario_p and qt_minutos_p > 0)) or (c.dt_horario = dt_horario_p and qt_minutos_p < 0))
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		((coalesce(b.nr_seq_mat_cpoe,0) = coalesce(nr_seq_mat_cpoe_p,0)) or (nr_seq_mat_cpoe_p = 0))
order by 1, 2, 3 desc;

c04 CURSOR FOR
	SELECT	a.nr_prescricao,
		b.nr_sequencia nr_seq_item,			
		c.dt_horario,
		c.nr_sequencia	nr_seq_hor
	from	prescr_gasoterapia	b,
		prescr_medica		a,
		prescr_gasoterapia_hor c
	where	b.nr_prescricao = a.nr_prescricao
	and	c.nr_seq_gasoterapia = b.nr_sequencia	
	and	coalesce(c.ie_horario_especial,'N') = 'N'	
	and	coalesce(c.dt_fim_horario::text, '') = ''
	and	coalesce(c.dt_suspensao::text, '') = ''	
	and	c.nr_prescricao	 = nr_prescricao_p
	and	b.nr_sequencia  = cd_item_p	
	and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
	and	a.dt_validade_prescr > clock_timestamp()	
	and	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
	and	(((ie_reaprazar_seguintes_p = 'S' AND c.dt_horario >= dt_horario_p) or
		  (ie_reaprazar_seguintes_p = 'N' AND c.dt_horario = dt_horario_p and qt_minutos_w > 0)) or (c.dt_horario = dt_horario_p and qt_minutos_w < 0))
	order by a.nr_prescricao, c.dt_horario;
			

BEGIN


open C03;
loop
fetch C03 into	
		nr_prescricao_w,
		nr_seq_item_w,
		nr_seq_horario_w,
		nr_seq_processo_w,
		nr_agrupamento_w,
		dt_horario_w,
		ie_acm_w,
		ie_sn_w;
EXIT WHEN NOT FOUND; /* apply on C03 */
	
	update	prescr_mat_hor
	set	dt_horario			= dt_horario + (qt_minutos_p/1440),
		nm_usuario			= nm_usuario_p,
		qt_hor_reaprazamento		= qt_minutos_p,
		nm_usuario_reaprazamento	= nm_usuario_p
	where	nr_sequencia			= nr_seq_horario_w;
	
	select	max(ie_operacao),
			coalesce(max(qt_operacao),0)
	into STRICT	ie_operacao_w,
			qt_operacao_w
	from	intervalo_prescricao
	where	cd_intervalo = cd_intervalo_p;
	
	select	max(dt_proxima_dose)
	into STRICT	dt_proxima_dose_w
	from	prescr_material
	where	nr_prescricao = nr_prescricao_w
	and		nr_sequencia = nr_seq_item_w;
	
	begin
	dt_proxima_dose_new_w := PKG_DATE_UTILS.get_DateTime(dt_proxima_dose_w, coalesce(dt_horario_desejado_w, PKG_DATE_UTILS.GET_TIME('00:00:00')));
	
	if (ie_operacao_w = 'H') and (qt_operacao_w > 24) and (dt_proxima_dose_w <= dt_proxima_dose_new_w) then
		update	prescr_material
		set	dt_proxima_dose = dt_proxima_dose_new_w
		where	nr_prescricao = nr_prescricao_w
		and	nr_sequencia = nr_seq_item_w;
	end if;
	exception when others then
		null;
	end;
	
	select	max(obter_desc_material(cd_material))
	into STRICT	ds_item_w
	from	prescr_mat_hor
	WHERE	nr_sequencia	= nr_seq_horario_w;
	
	cd_evolucao_w := Gerar_evolPaci_automa('M', nm_usuario_p, nr_atendimento_p, ds_item_w, nr_seq_horario_w, 'P', '', null, null, null, null, null, cd_evolucao_w);
	CALL reaprazar_processo_horario(nr_atendimento_p, nr_seq_horario_w, nr_seq_processo_w, dt_horario_w, dt_horario_w + (qt_minutos_p/1440), nm_usuario_p);
	CALL reaprazar_horario_dependentes(nr_atendimento_p, nr_prescricao_w, nr_seq_item_w, nr_agrupamento_w, dt_horario_w, dt_horario_w + (qt_minutos_p/1440), qt_minutos_p, nm_usuario_p, null);
	
if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end loop;
close C03;

CALL wheb_assist_pck.set_nr_seq_hor_reapraz(null, 'C');

open C04;
loop
fetch C04 into	
		nr_prescricao_w,
		nr_seq_item_w,
		dt_horario_w,
		nr_seq_horario_w;
EXIT WHEN NOT FOUND; /* apply on C04 */

update	prescr_gasoterapia_hor
set	dt_horario			= dt_horario + (qt_minutos_p/1440),
	nm_usuario			= nm_usuario_p,
	qt_hor_reaprazamento		= qt_minutos_p
	--nm_usuario_reaprazamento	= nm_usuario_p
where	nr_sequencia			= nr_seq_horario_w;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end loop;
close C04;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE reaprazar_horarios_seguintes ( nr_atendimento_p bigint, cd_item_p text, cd_intervalo_p text, qt_item_p bigint, dt_horario_p timestamp, ie_reaprazar_seguintes_p text, nr_prescricao_p bigint, nm_usuario_p text, nr_agrupamento_p bigint, ie_acm_sn_p text, cd_unidade_medida_p text, nr_prescricoes_p text, qt_minutos_p bigint, nr_seq_mat_cpoe_p bigint) FROM PUBLIC;

