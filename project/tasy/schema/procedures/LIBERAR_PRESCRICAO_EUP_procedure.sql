-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE liberar_prescricao_eup (nr_prescricao_p bigint, cd_pessoa_fisica_p text, qt_peso_p bigint, cd_procedimento_p bigint, nr_seq_interno_p bigint, ie_origem_proced_p text, nr_atendimento_p bigint, nm_pessoa_fisica_p text, cd_estabelecimento_p bigint, cd_setor_atendimento_p bigint, cd_perfil_p bigint, ie_momento_p text, ie_prescricao_alta_p text, dt_prescricao_p timestamp, qt_altura_cm_p bigint, nr_seq_forma_laudo_p bigint, ie_obter_exame_exige_menst_p text, cd_pessoa_menst_p bigint, dt_prescr_p INOUT timestamp, ds_mensagem_p INOUT text, ds_mensagem_adic_p INOUT text, ie_acao_p INOUT text, ie_anamnese_p INOUT text, ie_evolucao_p INOUT text, ie_receita_p INOUT text, ie_diagnostico_p INOUT text, ie_escala_indice_p INOUT text, ds_cons_med_corpo_cli_p INOUT text, qt_exame_ult_dose_pend_p INOUT bigint, ds_lista_pend_resposta_p INOUT text, ds_msg_erro_p INOUT text, ds_regra_cad_p INOUT text, ie_diag_atendimento_p INOUT text, ds_diag_atendimento_p INOUT text, ds_liberacao_p INOUT text, ds_msg_aviso_p INOUT text, ie_recomendacao_p INOUT text, cd_protocolo_p INOUT bigint, ie_parecer_p INOUT text, ie_peso_p INOUT text, ie_autorizacao_p INOUT text, ie_laudo_sus_p INOUT text, ie_avaliacao_p INOUT text, ie_item_prontuario_p INOUT text, ie_exige_tempo_jejum_real_p INOUT text, ds_msg_futura_p INOUT text, ds_exames_mest_p INOUT text, qt_proc_p INOUT bigint, nr_seq_avaliacao_p INOUT bigint, nm_usuario_p text) AS $body$
DECLARE

								 
ie_gerar_aval_exam_w	varchar(1);
qt_prescr_w				bigint;


BEGIN 
 
ie_gerar_aval_exam_w := Obter_param_Usuario(916, 338, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_gerar_aval_exam_w);
 
SELECT * FROM Liberar_Prescricao_Eup_Abort(nr_prescricao_p, cd_pessoa_fisica_p, qt_peso_p, cd_procedimento_p, nr_seq_interno_p, ie_origem_proced_p, nr_atendimento_p, nm_pessoa_fisica_p, cd_estabelecimento_p, cd_setor_atendimento_p, cd_perfil_p, ie_momento_p, ie_prescricao_alta_p, dt_prescricao_p, qt_altura_cm_p, nr_seq_forma_laudo_p, dt_prescr_p, ds_mensagem_p, ds_mensagem_adic_p, ie_acao_p, ie_anamnese_p, ie_evolucao_p, ie_receita_p, ie_diagnostico_p, ie_escala_indice_p, ds_cons_med_corpo_cli_p, qt_exame_ult_dose_pend_p, ds_lista_pend_resposta_p, ds_msg_erro_p, ds_regra_cad_p, ie_diag_atendimento_p, ds_diag_atendimento_p, ds_liberacao_p, ds_msg_aviso_p, ie_recomendacao_p, cd_protocolo_p, ie_parecer_p, ie_peso_p, ie_autorizacao_p, ie_laudo_sus_p, ie_avaliacao_p, ie_item_prontuario_p, ie_exige_tempo_jejum_real_p, ds_msg_futura_p, nm_usuario_p) INTO STRICT dt_prescr_p, ds_mensagem_p, ds_mensagem_adic_p, ie_acao_p, ie_anamnese_p, ie_evolucao_p, ie_receita_p, ie_diagnostico_p, ie_escala_indice_p, ds_cons_med_corpo_cli_p, qt_exame_ult_dose_pend_p, ds_lista_pend_resposta_p, ds_msg_erro_p, ds_regra_cad_p, ie_diag_atendimento_p, ds_diag_atendimento_p, ds_liberacao_p, ds_msg_aviso_p, ie_recomendacao_p, cd_protocolo_p, ie_parecer_p, ie_peso_p, ie_autorizacao_p, ie_laudo_sus_p, ie_avaliacao_p, ie_item_prontuario_p, ie_exige_tempo_jejum_real_p, ds_msg_futura_p;
 
if ((ds_cons_med_corpo_cli_p IS NOT NULL AND ds_cons_med_corpo_cli_p::text <> '') or 
	(ds_msg_erro_p IS NOT NULL AND ds_msg_erro_p::text <> '')) then 
	goto final;
end if;
 
if (ie_obter_exame_exige_menst_p = 'S') then 
	ds_exames_mest_p := obter_exame_exige_dum_regra(nr_prescricao_p, cd_pessoa_menst_p, ds_exames_mest_p);
end if;
 
select	count(*) 
into STRICT	qt_proc_p 
from 	prescr_procedimento 
where 	nr_prescricao = nr_prescricao_p 
and		ie_origem_proced <> ie_origem_proced_p;
 
if (ie_gerar_aval_exam_w = 'S') then 
	nr_seq_avaliacao_p := Gerar_Avaliacao_Prescricao(nr_prescricao_p, nm_usuario_p, nr_seq_avaliacao_p);
end if;
 
<<final>> 
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE liberar_prescricao_eup (nr_prescricao_p bigint, cd_pessoa_fisica_p text, qt_peso_p bigint, cd_procedimento_p bigint, nr_seq_interno_p bigint, ie_origem_proced_p text, nr_atendimento_p bigint, nm_pessoa_fisica_p text, cd_estabelecimento_p bigint, cd_setor_atendimento_p bigint, cd_perfil_p bigint, ie_momento_p text, ie_prescricao_alta_p text, dt_prescricao_p timestamp, qt_altura_cm_p bigint, nr_seq_forma_laudo_p bigint, ie_obter_exame_exige_menst_p text, cd_pessoa_menst_p bigint, dt_prescr_p INOUT timestamp, ds_mensagem_p INOUT text, ds_mensagem_adic_p INOUT text, ie_acao_p INOUT text, ie_anamnese_p INOUT text, ie_evolucao_p INOUT text, ie_receita_p INOUT text, ie_diagnostico_p INOUT text, ie_escala_indice_p INOUT text, ds_cons_med_corpo_cli_p INOUT text, qt_exame_ult_dose_pend_p INOUT bigint, ds_lista_pend_resposta_p INOUT text, ds_msg_erro_p INOUT text, ds_regra_cad_p INOUT text, ie_diag_atendimento_p INOUT text, ds_diag_atendimento_p INOUT text, ds_liberacao_p INOUT text, ds_msg_aviso_p INOUT text, ie_recomendacao_p INOUT text, cd_protocolo_p INOUT bigint, ie_parecer_p INOUT text, ie_peso_p INOUT text, ie_autorizacao_p INOUT text, ie_laudo_sus_p INOUT text, ie_avaliacao_p INOUT text, ie_item_prontuario_p INOUT text, ie_exige_tempo_jejum_real_p INOUT text, ds_msg_futura_p INOUT text, ds_exames_mest_p INOUT text, qt_proc_p INOUT bigint, nr_seq_avaliacao_p INOUT bigint, nm_usuario_p text) FROM PUBLIC;

