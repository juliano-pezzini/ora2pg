-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE replicar_escala_diaria ( dt_inicial_p timestamp, dt_final_p timestamp, nr_seq_escala_orig_p bigint, nr_seq_escala_diaria_p bigint, nr_seq_escala_dest_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
nr_sequencia_aux_w	bigint;
dt_inicio_w		timestamp;
dt_fim_w			timestamp;
nr_ordem_escala_w		bigint;
cd_pessoa_fisica_w	varchar(10);
cd_cbo_sus_w		integer;
nr_seq_equipe_w		bigint;
ds_observacao_w		varchar(255);
nr_seq_motivo_afast_w	bigint;
ie_profis_aleatorio_w	varchar(1);
ie_feriado_w		varchar(1);

C01 CURSOR FOR
	SELECT	nr_sequencia,
		dt_inicio,
		dt_fim,
		nr_ordem_escala,
		cd_pessoa_origem,
		cd_pessoa_fisica,
		cd_cbo_sus,
		nr_seq_equipe,
		ds_observacao,
		nr_seq_motivo_afast,
		ie_profis_aleatorio,
		ie_feriado
	from	escala_diaria
	where	nr_seq_escala	= nr_seq_escala_orig_p
	and	nr_sequencia	= coalesce(nr_seq_escala_diaria_p,nr_sequencia)
	and	dt_inicio between dt_inicial_p and dt_final_p;


BEGIN

if (dt_inicial_p IS NOT NULL AND dt_inicial_p::text <> '') and (dt_final_p IS NOT NULL AND dt_final_p::text <> '') and (coalesce(nr_seq_escala_dest_p,0) > 0) and (coalesce(nm_usuario_p,'0') <> '0') then
	begin
	open C01;
	loop
	fetch C01 into
		nr_sequencia_aux_w,
		dt_inicio_w,
		dt_fim_w,
		nr_ordem_escala_w,
		cd_pessoa_fisica_w,
		cd_pessoa_fisica_w,
		cd_cbo_sus_w,
		nr_seq_equipe_w,
		ds_observacao_w,
		nr_seq_motivo_afast_w,
		ie_profis_aleatorio_w,
		ie_feriado_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		select	nextval('escala_diaria_seq')
		into STRICT	nr_sequencia_w
		;

		insert into escala_diaria(
				nr_sequencia,
				nr_seq_escala,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				dt_inicio,
				dt_fim,
				nr_ordem_escala,
				cd_pessoa_origem,
				cd_pessoa_fisica,
				cd_cbo_sus,
				nr_seq_equipe,
				ds_observacao,
				nr_seq_motivo_afast,
				ie_profis_aleatorio,
				ie_feriado,
				qt_min_executado)
			values (	nr_sequencia_w,
				nr_seq_escala_dest_p,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				dt_inicio_w,
				dt_fim_w,
				nr_ordem_escala_w,
				cd_pessoa_fisica_w,
				cd_pessoa_fisica_w,
				cd_cbo_sus_w,
				nr_seq_equipe_w,
				ds_observacao_w,
				nr_seq_motivo_afast_w,
				ie_profis_aleatorio_w,
				ie_feriado_w,
				null);

		insert into escala_diaria_adic(
				nr_sequencia,
				nr_seq_escala_diaria,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				cd_pessoa_fisica,
				nr_ordem_escala,
				nr_seq_classif_escala,
				ds_observacao,
				qt_min_executado)
			SELECT	nextval('escala_diaria_adic_seq'),
				nr_sequencia_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				cd_pessoa_fisica,
				nr_ordem_escala,
				nr_seq_classif_escala,
				ds_observacao,
				null
			from	escala_diaria_adic
			where	nr_seq_escala_diaria = nr_sequencia_aux_w;
		end;
	end loop;
	close C01;

	commit;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE replicar_escala_diaria ( dt_inicial_p timestamp, dt_final_p timestamp, nr_seq_escala_orig_p bigint, nr_seq_escala_diaria_p bigint, nr_seq_escala_dest_p bigint, nm_usuario_p text) FROM PUBLIC;

