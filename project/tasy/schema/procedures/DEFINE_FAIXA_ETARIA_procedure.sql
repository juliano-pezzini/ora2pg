-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE define_faixa_etaria (CD_PESSOA_FISICA_P text, CD_FAIXA_ETARIA_P INOUT bigint) AS $body$
DECLARE


CD_FAIXA_ETARIA_W		smallint;	
QT_ANOS_IDADE_W			double precision		:= 0;	



BEGIN
CD_FAIXA_ETARIA_W := 0;

begin
/* 
alteracao em 28/04/2000 bola por problema com paciente c/menos de um ano
	select	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay((sysdate - nvl(dt_nascimento,sysdate))/365)
QT_ANOS_IDADE_W			NUMBER(10)		:= 0;	

*/
select (clock_timestamp() - coalesce(dt_nascimento,clock_timestamp()))/365
into STRICT		qt_anos_idade_w
from		pessoa_fisica
where		cd_pessoa_fisica = cd_pessoa_fisica_p;
exception
		when others then
		qt_anos_idade_w := 999;
end;

if (qt_anos_idade_w = 999) 	or (qt_anos_idade_w < 0)		then
	cd_faixa_etaria_w	:= 0;
else
	begin
	select	min(cd_faixa_etaria)
	into STRICT		cd_faixa_etaria_w
	from		sus_faixa_etaria_bpa
	where		qt_anos_idade_w between qt_idade_minima and qt_idade_maxima;		
	exception
			when others then
			cd_faixa_etaria_w := 0;
 	end;
end if;

cd_faixa_etaria_p	:= cd_faixa_etaria_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE define_faixa_etaria (CD_PESSOA_FISICA_P text, CD_FAIXA_ETARIA_P INOUT bigint) FROM PUBLIC;

