-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_obter_dados_antimicrob ( cd_material_p bigint, cd_perfil_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_objetivo_filtro_p text, cd_intervalo_p text default null, ie_justificativa_p out text, ie_objetivo_p out text, ie_dia_utilizacao_p out text, ie_topografia_p out text, ie_amostra_p out text, ie_microorganismo_p out text, ie_origem_p out text, ie_exige_indicacao_p out text, qt_dias_prev_p out bigint, ie_obj_regra_p out text, ie_lib_auto_p out text, ie_possui_regra_p out text, ie_regra_intervalo_p out text, qt_dias_lib_padrao_p out bigint) is ie_justificativa_antimicrob_w char(1) AS $body$
BEGIN
	if (ie_param_p = 'N') then
		return;
	else
		return;
	end if;
end;

begin
if (coalesce(cd_material_p,0) = 0) then
	return;
end if;

select	coalesce(max(qt_dias_lib_padrao),0)
into STRICT	qt_dias_lib_padrao_w
from	parametro_medico
where   cd_estabelecimento = cd_estabelecimento_p;

select	coalesce(max('S'),'N')
into STRICT	ie_existe_w
from	regra_antimicrobiano LIMIT 1;

if (ie_existe_w = 'S') then

	ie_feriado_w 				:= coalesce(obter_se_feriado(cd_estabelecimento_p, clock_timestamp()),0);
	ie_dia_semana_w				:= pkg_date_utils.get_WeekDay(clock_timestamp());
	hr_hora_atual_w				:= to_char(clock_timestamp(),'hh24:mi:ss');
	ie_ctrl_medico_antimicrob_w	:= substr(obter_ctrl_antimicrobiano_mat(cd_material_p),1,1);	
	
	select	coalesce(max(cd_grupo_material),0),
			coalesce(max(cd_subgrupo_material),0),
			coalesce(max(cd_classe_material),0),
			coalesce(max(nr_seq_familia),0),
			coalesce(max(cd_material_estoque),0),
			coalesce(max(nr_seq_ficha_tecnica),0)
	into STRICT	cd_grupo_material_w,
			cd_subgrupo_w,
			cd_classe_material_w,
			nr_seq_familia_w,
			cd_material_estoque_w,
			nr_seq_ficha_tecnica_w			
	from	estrutura_material_v
	where 	cd_material	= cd_material_p;

	ie_possui_regra_p := 'N';

	open c01;
	loop
	fetch c01 into	
			ie_justificativa_antimicrob_w,
			ie_objetivo_antimicrob_w,
			ie_dia_utilizacao_antimicrob_w,
			ie_topografia_antimicrob_w,
			ie_amostra_antimicrob_w,
			ie_microorganismo_antimicrob_w,
			ie_origem_antimicrob_w,
			ie_indicacao_clinica_w,
			qt_dias_prev_w,
			ie_objetivo_filtro_w,
			ie_lib_auto_w,
      cd_intervalo_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		ie_justificativa_p 		:= valida_retorno(ie_justificativa_antimicrob_w);
		ie_objetivo_p 			:= valida_retorno(ie_objetivo_antimicrob_w);	
		ie_dia_utilizacao_p 	:= valida_retorno(ie_dia_utilizacao_antimicrob_w);	
		ie_topografia_p			:= valida_retorno(ie_topografia_antimicrob_w);		
		ie_amostra_p 			:= valida_retorno(ie_amostra_antimicrob_w);			
		ie_microorganismo_p 	:= valida_retorno(ie_microorganismo_antimicrob_w);	
		ie_origem_p 			:= valida_retorno(ie_origem_antimicrob_w);			
		ie_exige_indicacao_p	:= valida_retorno(ie_indicacao_clinica_w);			
		qt_dias_prev_p			:= valida_retorno(qt_dias_prev_w);	
		ie_obj_regra_p		 	:= valida_retorno(ie_objetivo_filtro_w);
		ie_lib_auto_p			:= valida_retorno(ie_lib_auto_w);
		ie_possui_regra_p		:= 'S';
		ie_regra_intervalo_p	:= cd_intervalo_w;
		qt_dias_lib_padrao_p	:= qt_dias_lib_padrao_w;
		
		end;
	end loop;
	close c01;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_obter_dados_antimicrob ( cd_material_p bigint, cd_perfil_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_objetivo_filtro_p text, cd_intervalo_p text default null, ie_justificativa_p out text, ie_objetivo_p out text, ie_dia_utilizacao_p out text, ie_topografia_p out text, ie_amostra_p out text, ie_microorganismo_p out text, ie_origem_p out text, ie_exige_indicacao_p out text, qt_dias_prev_p out bigint, ie_obj_regra_p out text, ie_lib_auto_p out text, ie_possui_regra_p out text, ie_regra_intervalo_p out text, qt_dias_lib_padrao_p out bigint) is ie_justificativa_antimicrob_w char(1) FROM PUBLIC;

