-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_lanc_auto_terc ( dt_atual_p timestamp, cd_estabelecimento_p bigint) AS $body$
DECLARE

 
nr_seq_terceiro_w		bigint;
ie_periodicidade_w		varchar(10);
qt_dia_mes_w		smallint;
ie_dia_semana_w		varchar(10);
nr_seq_trans_fin_w		bigint;
cd_local_estoque_w	bigint;
nr_seq_operacao_w	bigint;
cd_material_w		bigint;
ie_origem_proced_w	bigint;
cd_procedimento_w	bigint;
qt_operacao_w		double precision;
vl_operacao_w		double precision;
nr_seq_doc_w		bigint;
nr_doc_w			bigint;
nr_seq_w			bigint;
dia_semana_w		smallint;
qt_mes_w		smallint;
qt_ocorrencia_w		integer;
qt_ocorrencia_tot_w	integer;
cd_pessoa_fisica_w	varchar(10);
nr_seq_regra_lanc_w	regra_lanc_auto_terc.nr_sequencia%type;

c01 CURSOR FOR 
SELECT	a.nr_seq_terceiro, 
	a.ie_periodicidade, 
	a.qt_dia_mes, 
	a.ie_dia_semana, 
	a.nr_seq_trans_fin, 
	a.cd_local_estoque, 
	a.nr_seq_operacao, 
	a.cd_material, 
	a.ie_origem_proced, 
	a.cd_procedimento, 
	a.qt_operacao, 
	a.vl_operacao, 
	a.nr_doc, 
	a.qt_mes, 
	a.cd_pessoa_fisica, 
	a.nr_sequencia 
from	regra_lanc_auto_terc a 
where	a.cd_estabelecimento = cd_estabelecimento_p 
and	not exists (	SELECT 	1 
			from 	terceiro x 
			where 	x.nr_sequencia = a.nr_seq_terceiro 
			and 	coalesce(x.ie_situacao,'A') = 'I') 
and	SUBSTR(OBTER_SE_PERIODO_VIGENTE(a.DT_INICIO_VIGENCIA,a.DT_FIM_VIGENCIA,DT_ATUAL_P),1,1) = 'S';


BEGIN 
 
nr_seq_doc_w := 0;
 
select 	PKG_DATE_UTILS.get_WeekDay(dt_atual_p) 
into STRICT	dia_semana_w
;
 
open c01;
loop 
fetch c01 into 
	nr_seq_terceiro_w, 
	ie_periodicidade_w, 
	qt_dia_mes_w, 
	ie_dia_semana_w, 
	nr_seq_trans_fin_w, 
	cd_local_estoque_w, 
	nr_seq_operacao_w, 
	cd_material_w, 
	ie_origem_proced_w, 
	cd_procedimento_w, 
	qt_operacao_w, 
	vl_operacao_w, 
	nr_doc_w, 
	qt_mes_w, 
	cd_pessoa_fisica_w, 
	nr_seq_regra_lanc_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	select	count(*) 
	into STRICT	qt_ocorrencia_w 
	from	terceiro_operacao 
	where	nr_seq_terceiro		= nr_seq_terceiro_w 
	and	coalesce(cd_procedimento, coalesce(cd_procedimento_w,0))	= coalesce(cd_procedimento_w,0) 
	and	coalesce(cd_material, coalesce(cd_material_w,0))		= coalesce(cd_material_w,0) 
	and	PKG_DATE_UTILS.ADD_MONTH(PKG_DATE_UTILS.start_of(dt_operacao,'DD',0), qt_mes_w,0)	= pkg_date_utils.start_of(dt_atual_p,'DD',0);
 
	if (qt_ocorrencia_w = 0) then /*Coloquei o if para a regra for nova, Bruna 01/03/07*/
 
 
		select	count(*) 
		into STRICT	qt_ocorrencia_tot_w 
		from	terceiro_operacao 
		where	nr_seq_terceiro		= nr_seq_terceiro_w 
		and	coalesce(cd_procedimento, coalesce(cd_procedimento_w,0))	= coalesce(cd_procedimento_w,0) 
		and	coalesce(cd_material, coalesce(cd_material_w,0))		= coalesce(cd_material_w,0) 
		and	pkg_date_utils.extract_field('DAY', dt_operacao,0) = pkg_date_utils.extract_field('DAY',dt_atual_p,0);
 
	end if;
 
	-- este if a procedure já tratava, porém incluímos a última linha do if para tratar o número de meses. 
	if (ie_periodicidade_w = 'D') or 
		(ie_periodicidade_w = 'S' AND dia_semana_w = ie_dia_semana_w) or 
		((ie_periodicidade_w = 'M') and (pkg_date_utils.extract_field('DAY',dt_atual_p, 0) = qt_dia_mes_w) and		 
		((coalesce(qt_mes_w,1) = 1) or ((coalesce(qt_mes_w,1) > 1) and ((qt_ocorrencia_w > 0) or (qt_ocorrencia_tot_w = 0))))) then 
		nr_seq_doc_w	:= nr_seq_doc_w + 1;
 
		select	nextval('terceiro_operacao_seq') 
		into STRICT	nr_seq_w 
		;
		insert into terceiro_operacao(NR_SEQUENCIA, 
			CD_ESTABELECIMENTO, 
			NR_SEQ_TERCEIRO, 
			NR_SEQ_OPERACAO, 
			TX_OPERACAO, 
			DT_ATUALIZACAO, 
			NM_USUARIO, 
			NR_DOC, 
			NR_SEQ_DOC, 
			DT_OPERACAO, 
			NR_SEQ_CONTA, 
			CD_MATERIAL, 
			IE_ORIGEM_PROCED, 
			CD_PROCEDIMENTO, 
			QT_OPERACAO, 
			VL_OPERACAO, 
			NR_LOTE_CONTABIL, 
			CD_PESSOA_FISICA, 
			DT_ATUALIZACAO_ESTOQUE, 
			CD_LOCAL_ESTOQUE, 
			NR_SEQ_TRANS_FIN, 
			NR_SEQ_ORDEM_SERVICO, 
			nr_seq_regra_lanc) 
		values (nr_seq_w, 
			cd_estabelecimento_p, 
			nr_seq_terceiro_w, 
			nr_seq_operacao_w, 
			0, 
			clock_timestamp(), 
			'Tasy',		 
			nr_doc_w, 
			nr_seq_doc_w, 
			dt_atual_p, 
			null, 
			cd_material_w, 
			ie_origem_proced_w, 
			cd_procedimento_w, 
			qt_operacao_w, 
			vl_operacao_w, 
			null, 
			cd_pessoa_fisica_w, 
			null, 
			cd_local_estoque_w, 
			nr_seq_trans_fin_w, 
			null, 
			nr_seq_regra_lanc_w);
 
		CALL ATUALIZAR_OPERACAO_TERCEIRO(nr_seq_w, 'Tasy');
	end if;
end loop;
close c01;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_lanc_auto_terc ( dt_atual_p timestamp, cd_estabelecimento_p bigint) FROM PUBLIC;

