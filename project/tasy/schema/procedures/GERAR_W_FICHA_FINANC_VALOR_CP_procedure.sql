-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_ficha_financ_valor_cp (cd_pessoa_fisica_p text, cd_cgc_p text, dt_referencia_p timestamp, nm_usuario_p text, cd_estabelecimento_p bigint, ie_aberto_p text) AS $body$
DECLARE


vl_vencido_w		double precision	:= 0;
vl_a_vencer_w		double precision	:= 0;
vl_adiantamento_w	double precision	:= 0;
vl_repasse_w		double precision	:= 0;
vl_nota_credito_w	double precision 	:= 0;


BEGIN

/* Titulos vencidos */

if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
	select	coalesce(sum(a.vl_saldo_titulo),0)
	into STRICT	vl_vencido_w
	from	titulo_pagar a
	where	exists (	SELECT	1
			from	w_ficha_financ_consulta x
			where	x.nr_titulo_cp = a.nr_titulo
			and	x.cd_pessoa_fisica = cd_pessoa_fisica_p
			and	x.nm_usuario = nm_usuario_p)
	and 	dt_referencia_P		> dt_vencimento_atual;
elsif (cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '') then
	select	coalesce(sum(a.vl_saldo_titulo),0)
	into STRICT	vl_vencido_w
	from	titulo_pagar a
	where	exists (	SELECT	1
			from	w_ficha_financ_consulta x
			where	x.nr_titulo_cp = a.nr_titulo
			and	x.cd_cgc = cd_cgc_p
			and	x.nm_usuario = nm_usuario_p)
	and 	dt_referencia_P		> dt_vencimento_atual;
end if;

/* Títulos vencidos */

insert into w_ficha_financ_valor(cd_cgc,
	cd_pessoa_fisica,
	ds_valor,
	dt_atualizacao,
	dt_atualizacao_nrec,
	ie_tipo_valor,
	nm_usuario,
	nm_usuario_nrec,
	nr_sequencia,
	vl_ficha)
values (cd_cgc_p,
	cd_pessoa_fisica_p,
	substr(wheb_mensagem_pck.get_texto(302401),1,255),
	clock_timestamp(),
	clock_timestamp(),
	'51',
	nm_usuario_p,
	nm_usuario_p,
	nextval('w_ficha_financ_valor_seq'),
	vl_vencido_w);


/* Titulos a vencer */

if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
	select	coalesce(sum(a.vl_saldo_titulo),0)
	into STRICT	vl_a_vencer_w
	from	titulo_pagar a
	where	exists (	SELECT	1
			from	w_ficha_financ_consulta x
			where	x.nr_titulo_cp = a.nr_titulo
			and	x.cd_pessoa_fisica = cd_pessoa_fisica_p
			and	x.nm_usuario = nm_usuario_p)
	and 	dt_referencia_P		<= dt_vencimento_atual;
elsif (cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '') then
	select	coalesce(sum(a.vl_saldo_titulo),0)
	into STRICT	vl_a_vencer_w
	from	titulo_pagar a
	where	exists (	SELECT	1
			from	w_ficha_financ_consulta x
			where	x.nr_titulo_cp = a.nr_titulo
			and	x.cd_cgc = cd_cgc_p
			and	x.nm_usuario = nm_usuario_p)
	and 	dt_referencia_P		<= dt_vencimento_atual;
end if;

/* Títulos a vencer */

insert into w_ficha_financ_valor(cd_cgc,
	cd_pessoa_fisica,
	ds_valor,
	dt_atualizacao,
	dt_atualizacao_nrec,
	ie_tipo_valor,
	nm_usuario,
	nm_usuario_nrec,
	nr_sequencia,
	vl_ficha)
values (cd_cgc_p,
	cd_pessoa_fisica_p,
	substr(wheb_mensagem_pck.get_texto(302402),1,255),
	clock_timestamp(),
	clock_timestamp(),
	'55',
	nm_usuario_p,
	nm_usuario_p,
	nextval('w_ficha_financ_valor_seq'),
	vl_a_vencer_w);

/* Titulos a pagar */

insert into w_ficha_financ_valor(cd_cgc,
	cd_pessoa_fisica,
	ds_valor,
	dt_atualizacao,
	dt_atualizacao_nrec,
	ie_tipo_valor,
	nm_usuario,
	nm_usuario_nrec,
	nr_sequencia,
	vl_ficha)
values (cd_cgc_p,
	cd_pessoa_fisica_p,
	substr(wheb_mensagem_pck.get_texto(302403),1,255),
	clock_timestamp(),
	clock_timestamp(),
	'52',
	nm_usuario_p,
	nm_usuario_p,
	nextval('w_ficha_financ_valor_seq'),
	vl_vencido_w + vl_a_vencer_w);

/* Adiantamentos */

if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
	select	coalesce(sum(vl_saldo),0)
	into STRICT	vl_adiantamento_w
	from	adiantamento_pago a
	where	exists (	SELECT	1
			from	w_ficha_financ_consulta x
			where	x.nr_adiantamento_cp = a.nr_adiantamento
			and	x.cd_pessoa_fisica = cd_pessoa_fisica_p
			and	x.nm_usuario = nm_usuario_p);
elsif (cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '') then
	select	coalesce(sum(vl_saldo),0)
	into STRICT	vl_adiantamento_w
	from	adiantamento_pago a
	where	exists (	SELECT	1
			from	w_ficha_financ_consulta x
			where	x.nr_adiantamento_cp = a.nr_adiantamento
			and	x.cd_cgc = cd_cgc_p
			and	x.nm_usuario = nm_usuario_p);
end if;

/* Adiantamentos */

insert into w_ficha_financ_valor(cd_cgc,
	cd_pessoa_fisica,
	ds_valor,
	dt_atualizacao,
	dt_atualizacao_nrec,
	ie_tipo_valor,
	nm_usuario,
	nm_usuario_nrec,
	nr_sequencia,
	vl_ficha)
values (cd_cgc_p,
	cd_pessoa_fisica_p,
	substr(wheb_mensagem_pck.get_texto(302405),1,255),
	clock_timestamp(),
	clock_timestamp(),
	'53',
	nm_usuario_p,
	nm_usuario_p,
	nextval('w_ficha_financ_valor_seq'),
	vl_adiantamento_w);

/* Repasses */

if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
	select	coalesce(sum(coalesce(obter_valor_repasse(a.nr_repasse_terceiro,'R'),0)),0)
	into STRICT	vl_repasse_w
	from	repasse_terceiro a
	where	exists (	SELECT	1
			from	w_ficha_financ_consulta x
			where	x.nr_repasse_terceiro = a.nr_repasse_terceiro
			and	x.cd_pessoa_fisica = cd_pessoa_fisica_p
			and	x.nm_usuario = nm_usuario_p);
elsif (cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '') then
	select	coalesce(sum(coalesce(obter_valor_repasse(a.nr_repasse_terceiro,'R'),0)),0)
	into STRICT	vl_repasse_w
	from	repasse_terceiro a
	where	exists (	SELECT	1
			from	w_ficha_financ_consulta x
			where	x.nr_repasse_terceiro = a.nr_repasse_terceiro
			and	x.cd_cgc = cd_cgc_p
			and	x.nm_usuario = nm_usuario_p);
end if;

/* Repasses */

insert into w_ficha_financ_valor(cd_cgc,
	cd_pessoa_fisica,
	ds_valor,
	dt_atualizacao,
	dt_atualizacao_nrec,
	ie_tipo_valor,
	nm_usuario,
	nm_usuario_nrec,
	nr_sequencia,
	vl_ficha)
values (cd_cgc_p,
	cd_pessoa_fisica_p,
	substr(wheb_mensagem_pck.get_texto(302406),1,255),
	clock_timestamp(),
	clock_timestamp(),
	'54',
	nm_usuario_p,
	nm_usuario_p,
	nextval('w_ficha_financ_valor_seq'),
	vl_repasse_w);


/* Total pagar */

insert into w_ficha_financ_valor(cd_cgc,
	cd_pessoa_fisica,
	ds_valor,
	dt_atualizacao,
	dt_atualizacao_nrec,
	ie_tipo_valor,
	nm_usuario,
	nm_usuario_nrec,
	nr_sequencia,
	vl_ficha)
values (cd_cgc_p,
	cd_pessoa_fisica_p,
	substr(wheb_mensagem_pck.get_texto(302407),1,255),
	clock_timestamp(),
	clock_timestamp(),
	'56',
	nm_usuario_p,
	nm_usuario_p,
	nextval('w_ficha_financ_valor_seq'),
	vl_vencido_w + vl_a_vencer_w +
	vl_adiantamento_w +
	vl_repasse_w);

/* Nota de crédito */

if (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') then
	select	coalesce(sum(vl_nota_credito),0)
	into STRICT	vl_nota_credito_w
	from	nota_credito a
	where	exists (	SELECT	1
			from	w_ficha_financ_consulta x
			where	x.nr_seq_nota_credito = a.nr_sequencia
			and	x.cd_pessoa_fisica = cd_pessoa_fisica_p
			and	x.nm_usuario = nm_usuario_p);
elsif (cd_cgc_p IS NOT NULL AND cd_cgc_p::text <> '') then
	select	coalesce(sum(vl_nota_credito),0)
	into STRICT	vl_nota_credito_w
	from	nota_credito a
	where	exists (	SELECT	1
			from	w_ficha_financ_consulta x
			where	x.nr_seq_nota_credito = a.nr_sequencia
			and	x.cd_cgc = cd_cgc_p
			and	x.nm_usuario = nm_usuario_p);
end if;

/* Nota de crédito */

insert into w_ficha_financ_valor(cd_cgc,
	cd_pessoa_fisica,
	ds_valor,
	dt_atualizacao,
	dt_atualizacao_nrec,
	ie_tipo_valor,
	nm_usuario,
	nm_usuario_nrec,
	nr_sequencia,
	vl_ficha)
values (cd_cgc_p,
	cd_pessoa_fisica_p,
	substr(wheb_mensagem_pck.get_texto(302410),1,255),
	clock_timestamp(),
	clock_timestamp(),
	'22',
	nm_usuario_p,
	nm_usuario_p,
	nextval('w_ficha_financ_valor_seq'),
	vl_nota_credito_w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_ficha_financ_valor_cp (cd_pessoa_fisica_p text, cd_cgc_p text, dt_referencia_p timestamp, nm_usuario_p text, cd_estabelecimento_p bigint, ie_aberto_p text) FROM PUBLIC;

