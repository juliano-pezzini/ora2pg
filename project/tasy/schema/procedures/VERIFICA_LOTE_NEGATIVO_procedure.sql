-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE verifica_lote_negativo ( nr_seq_nf_entrada_p bigint) AS $body$
DECLARE


qt_compra_w bigint;

nr_item_nf_w            nota_fiscal_item.nr_item_nf%type;
nr_seq_lote_fornec_w    material_lote_fornec.ds_lote_fornec%type;

c01 CURSOR FOR
SELECT  a.nr_item_nf,
	b.nr_seq_lote_fornec
from	nota_fiscal_item a,
	nota_fiscal_item_lote b,
	material_lote_fornec c
where	a.nr_sequencia		= b.nr_seq_nota
and 	a.nr_item_nf		= b.nr_item_nf
and	b.nr_seq_lote_fornec	= c.nr_sequencia
and 	b.nr_item_nf		= c.nr_item_nf
and	a.nr_sequencia		= nr_seq_nf_entrada_p;


BEGIN

open c01;
loop
fetch c01 into
	nr_item_nf_w,
	nr_seq_lote_fornec_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
	select obter_saldo_lote_fornec(nr_seq_lote_fornec_w)
	into STRICT qt_compra_w
	;

	if (qt_compra_w < 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1100619, 'NR_ITEM_NF_W='||nr_item_nf_w||';NR_SEQ_LOTE_FORNEC_W='||nr_seq_lote_fornec_w);			
	end if;
	
	end;
end loop;
close c01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE verifica_lote_negativo ( nr_seq_nf_entrada_p bigint) FROM PUBLIC;

