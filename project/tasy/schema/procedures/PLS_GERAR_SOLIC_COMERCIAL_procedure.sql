-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_solic_comercial ( nm_pessoa_p text, dt_nasc_p text, nr_telefone_p text, ds_email_p text, nr_ddi_p text, nr_ddd_p text, sg_estado_p text, cd_municipio_ibge_p text, ie_tipo_contratacao_p text, cd_cgc_p text, nr_seq_simulacao_p bigint, nm_contato_p text, nr_cpf_p text, nr_seq_agente_motivador_p bigint, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ds_erro_p INOUT text) AS $body$
DECLARE


nr_sequencia_w			bigint;
qt_idade_w			bigint;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
ds_erro_w			varchar(4000);
qt_pessoas_w			bigint;
cd_exp_consistencia_w		pls_cad_duplicidade_lead.cd_exp_consistencia%type;


BEGIN


/*aaschlote 30/03/2011 OS - 300982*/

if (dt_nasc_p IS NOT NULL AND dt_nasc_p::text <> '') then
	qt_idade_w	:= 	obter_idade(to_date(dt_nasc_p), clock_timestamp(),'A');
end if;	

cd_estabelecimento_w	:= coalesce(cd_estabelecimento_p, pls_parametro_operadora_web('EST'));

select	nextval('pls_solicitacao_comercial_seq')
into STRICT	nr_sequencia_w
;
		
SELECT * FROM pls_consistir_solicitacao_lead(ie_tipo_contratacao_p, nr_sequencia_w, nr_telefone_p, null, null, nr_ddi_p, dt_nasc_p, ds_email_p, cd_cgc_p, nr_cpf_p, null, cd_estabelecimento_w, qt_pessoas_w, ds_erro_w) INTO STRICT qt_pessoas_w, ds_erro_w;
		
ds_erro_w := substr(replace(replace(ds_erro_w,chr(10),''),chr(13),''),1,255);	

if (coalesce(ds_erro_w::text, '') = '' or ds_erro_w = '') then	
	
	insert into pls_solicitacao_comercial(	nr_sequencia, cd_estabelecimento, ie_status,
						nm_pessoa_fisica, dt_nascimento, nr_telefone,
						dt_atualizacao, nm_usuario, dt_atualizacao_nrec,
						nm_usuario_nrec, ds_email, nr_seq_simul_preco,
						dt_solicitacao, ie_origem_solicitacao, ie_tipo_contratacao,
						nr_cpf, cd_cgc, nr_ddi,
						nr_ddd, cd_nacionalidade, sg_uf_municipio,
						cd_municipio_ibge,nm_contato,ie_etapa_solicitacao,
						nr_seq_agente_motivador)
				values (	nr_sequencia_w, cd_estabelecimento_w, 'PE',
						nm_pessoa_p, dt_nasc_p, nr_telefone_p,
						clock_timestamp(), 'OPS - Portal', clock_timestamp(),
						'OPS - Portal', ds_email_p, nr_seq_simulacao_p,
						clock_timestamp(), 'W', ie_tipo_contratacao_p,
						nr_cpf_p, cd_cgc_p, nr_ddi_p,
						nr_ddd_p, '10', sg_estado_p,
						cd_municipio_ibge_p,nm_contato_p,'T',
						nr_seq_agente_motivador_p);	

end if;
ds_erro_p := ds_erro_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_solic_comercial ( nm_pessoa_p text, dt_nasc_p text, nr_telefone_p text, ds_email_p text, nr_ddi_p text, nr_ddd_p text, sg_estado_p text, cd_municipio_ibge_p text, ie_tipo_contratacao_p text, cd_cgc_p text, nr_seq_simulacao_p bigint, nm_contato_p text, nr_cpf_p text, nr_seq_agente_motivador_p bigint, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ds_erro_p INOUT text) FROM PUBLIC;

