-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_setor_auditoria ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE

			 
nr_seq_atepacu_w			bigint;
cd_convenio_w			integer;
cd_categoria_w			varchar(10);
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
nr_seq_exame_w			bigint;
nr_seq_proc_interno_w		bigint;
ie_tipo_atendimento_w		smallint;
cd_estabelecimento_w		smallint;
cd_setor_atendimento_w		integer;
nr_seq_propaci_w			bigint;
ie_medico_executor_w		varchar(10);
cd_cgc_w            		varchar(14);
cd_medico_executor_w      	varchar(10);
cd_pessoa_fisica_w       		varchar(10);
cd_medico_exec_filtro_w    	varchar(10);

nr_atendimento_w		bigint;
nr_seq_classificacao_w		bigint;
nr_prescricao_w			bigint;
nr_sequencia_prescricao_w	integer;
ie_origem_inf_w			varchar(1);
cd_cgc_laboratorio_w		varchar(14);
dt_procedimento_w		timestamp;
cd_setor_prescricao_w		integer;
ie_altera_item_repasse_w	varchar(1) := 'S';


BEGIN 
 
begin 
select	coalesce(a.nr_seq_atepacu_ajuste,b.nr_seq_atepacu), 
	coalesce(a.cd_convenio_ajuste,c.cd_convenio_parametro), 
	coalesce(a.cd_categoria_ajuste,c.cd_categoria_parametro), 
	b.nr_seq_exame, 
	b.nr_seq_proc_interno, 
	obter_tipo_atendimento(c.nr_atendimento), 
	c.cd_estabelecimento, 
	a.nr_seq_propaci, 
	b.cd_procedimento, 
	b.ie_origem_proced, 
	c.nr_atendimento, 
	b.nr_prescricao, 
	b.nr_sequencia_prescricao, 
	b.dt_procedimento 
into STRICT	nr_seq_atepacu_w, 
	cd_convenio_w, 
	cd_categoria_w, 
	nr_seq_exame_w, 
	nr_seq_proc_interno_w, 
	ie_tipo_atendimento_w, 
	cd_estabelecimento_w, 
	nr_seq_propaci_w, 
	cd_procedimento_w, 
	ie_origem_proced_w, 
	nr_atendimento_w, 
	nr_prescricao_w, 
	nr_sequencia_prescricao_w, 
	dt_procedimento_w 
from	procedimento_paciente b, 
	conta_paciente c, 
	auditoria_propaci a 
where	a.nr_seq_propaci	= b.nr_sequencia 
and	c.nr_interno_conta	= b.nr_interno_conta 
and	a.nr_sequencia		= nr_sequencia_p;
exception 
	when others then 
		nr_seq_atepacu_w	:=0;
end;
 
ie_altera_item_repasse_w := obter_param_usuario(1116, 189, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_altera_item_repasse_w);
 
nr_seq_classificacao_w := obter_classif_atendimento(nr_atendimento_w);
 
if (coalesce(nr_seq_atepacu_w,0)	<> 0) then 
	begin 
	select	cd_setor_atendimento 
	into STRICT	cd_setor_atendimento_w 
	from	atend_paciente_unidade 
	where	nr_seq_interno	= nr_seq_atepacu_w;
	exception 
		when others then 
			select	a.cd_setor_atendimento 
			into STRICT	cd_setor_atendimento_w 
			from	procedimento_paciente a 
			where	nr_sequencia	= nr_seq_propaci_w;
		 
	end;
	 
	if (coalesce(nr_prescricao_w,0) > 0) then 
		 
		select	max(cd_setor_atendimento) 
		into STRICT	cd_setor_prescricao_w 
		from	prescr_medica 
		where	nr_prescricao = nr_prescricao_w;
		 
		if (coalesce(nr_sequencia_prescricao_w,0) > 0) then 
			select	max(ie_origem_inf), 
				max(cd_cgc_laboratorio) 
			into STRICT	ie_origem_inf_w, 
				cd_cgc_laboratorio_w 
			from	prescr_procedimento 
			where	nr_prescricao = nr_prescricao_w 
			and	nr_sequencia = nr_sequencia_prescricao_w;
		end if;
		 
	end if;
	 
	SELECT * FROM consiste_medico_executor(	cd_estabelecimento_w, cd_convenio_w, cd_setor_atendimento_w, cd_procedimento_w, ie_origem_proced_w, ie_tipo_atendimento_w, nr_seq_exame_w, nr_seq_proc_interno_w, ie_medico_executor_w, cd_cgc_w, cd_medico_executor_w, cd_pessoa_fisica_w, cd_medico_exec_filtro_w, dt_procedimento_w, nr_seq_classificacao_w, ie_origem_inf_w, cd_cgc_laboratorio_w, cd_setor_prescricao_w) INTO STRICT ie_medico_executor_w, cd_cgc_w, cd_medico_executor_w, cd_pessoa_fisica_w;
	 
	if (cd_cgc_w IS NOT NULL AND cd_cgc_w::text <> '') then 
		 
		update	procedimento_paciente a 
		set	a.cd_cgc_prestador	= cd_cgc_w 
		where	a.nr_sequencia		= nr_seq_propaci_w 
		and	not exists (	SELECT	1 
				from	procedimento_repasse x 
				where	x.nr_seq_procedimento = a.nr_sequencia 
				and	coalesce(ie_altera_item_repasse_w,'S') = 'N');
		 
	end if;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_setor_auditoria ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

