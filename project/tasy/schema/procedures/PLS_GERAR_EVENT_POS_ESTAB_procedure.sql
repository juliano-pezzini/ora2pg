-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_event_pos_estab ( nr_seq_reg_auxiliar_p w_ctb_livro_aux_event_liq.nr_seq_reg_auxiliar%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_origem_p w_ctb_livro_aux_event_liq.ie_ato_cooperado%type, ie_gerar_arquivo_p w_ctb_livro_aux_event_liq.ie_ato_cooperado%type default 'N') AS $body$
DECLARE

					
/*

ie_origem_p: 	'H' = HTML
		'D' = Delphi

*/
ds_erro_w					varchar(255);
ds_local_w					varchar(255);
nm_arquivo_w					varchar(255);
arq_texto_w					utl_file.file_type;
ds_nome_livro_w					varchar(255);
ds_periodo_w					varchar(255);
nr_contador_w					bigint := 0;

dt_liberacao_w					ctb_livro_auxiliar.dt_liberacao%type;
ie_tipo_protocolo_w				ctb_livro_auxiliar.ie_tipo_protocolo%type;
ie_tipo_segurado_w				ctb_livro_auxiliar.ie_tipo_segurado%type;	
ie_gerar_ind_classif_w				ctb_livro_auxiliar.ie_gerar_ind_classif%type;
cd_estabelecimento_w				ctb_livro_auxiliar.cd_estab_exclusivo%type;
dt_inicial_w					ctb_livro_auxiliar.dt_inicial%type;
dt_final_w					ctb_livro_auxiliar.dt_final%type;

ie_status_prov_pagto_w				pls_parametro_contabil.ie_status_prov_pagto%type;
ie_lote_taxa_fat_w				pls_parametro_contabil.ie_lote_taxa_fat%type;
ie_lote_reembolso_fat_w				pls_parametro_contabil.ie_lote_reembolso_fat%type;
ie_lote_ajuste_fat_w				pls_parametro_contabil.ie_lote_ajuste_fat%type;
ie_lote_dif_fat_w				pls_parametro_contabil.ie_lote_dif_fat%type;
ie_lote_taxa_adm_w				pls_parametro_contabil.ie_lote_taxa_adm%type;
ie_lote_ajuste_prod_w				pls_parametro_contabil.ie_lote_ajuste_prod%type;
ie_tipo_repasse_w				pls_segurado_repasse.ie_tipo_repasse%type;
ie_tipo_compartilhamento_w			pls_segurado_repasse.ie_tipo_compartilhamento%type;
dt_repasse_w					pls_segurado_repasse.dt_repasse%type;
dt_fim_repasse_w				pls_segurado_repasse.dt_fim_repasse%type;
dt_ref_repasse_w				pls_conta_proc.dt_procedimento%type;


ie_existe_resumo_w				varchar(1);
nr_seq_segurado_w				pls_segurado.nr_sequencia%type;
cd_procedimento_w				pls_conta_proc.cd_procedimento%type;
cd_material_w					pls_material.cd_material%type;
nr_seq_material_w				pls_conta_mat.nr_seq_material%type;
ds_mat_proc_w					varchar(255);
nr_seq_conta_mat_w				pls_conta_mat.nr_sequencia%type;
ie_origem_proced_w				pls_conta_proc.ie_origem_proced%type;
nr_seq_grupo_ans_w				ans_grupo_despesa.nr_sequencia%type;
ds_grupo_ans_w					ans_grupo_despesa.ds_grupo%type;
dt_realizacao_w					timestamp;
nr_carteira_w					pls_segurado_carteira.cd_usuario_plano%type;
nm_beneficiario_w				pessoa_fisica.nm_pessoa_fisica%type;
nr_seq_pagador_w				pls_contrato_pagador.nr_sequencia%type;
cpf_cnpj_pagador_w				pls_contrato_pagador.cd_cgc%type;
nm_pagador_w					varchar(255);
ie_preco_w					pls_plano.ie_preco%type;
ds_preco_w					varchar(255);
ie_regulamentacao_w				pls_plano.ie_regulamentacao%type;
ds_regulamentacao_w				varchar(255);
ie_tipo_contratacao_w				pls_plano.ie_tipo_contratacao%type;
ds_tipo_contratacao_w				varchar(255);
ie_segmentacao_w				pls_plano.ie_segmentacao%type;
ds_segmentacao_w				varchar(255);
nr_contrato_w					pls_contrato.nr_contrato%type;
nr_seq_contrato_w				pls_contrato.nr_sequencia%type;
nr_registro_produto_w				pls_plano.nr_protocolo_ans%type;
nr_seq_prestador_w				pls_prestador.nr_sequencia%type;
cpf_cnpj_prestador_w				pls_prestador.cd_cgc%type;
nm_prestador_w					pls_prestador.nm_interno%type;
ie_tipo_vinculo_w				pls_prestador.ie_tipo_relacao%type;
ds_tipo_vinculo_w				varchar(255);
ie_ato_cooperado_w				pls_conta_proc.ie_ato_cooperado%type;
ds_ato_cooperado_w				varchar(255);
vl_taxa_adm_w					pls_conta_pos_taxa_contab.vl_provisao%type;
cd_conta_deb_taxa_adm_w				pls_conta_pos_taxa_contab.cd_conta_deb%type;
cd_conta_cred_taxa_adm_w			pls_conta_pos_taxa_contab.cd_conta_cred%type;
cd_classif_deb_taxa_adm_w			pls_conta_pos_taxa_contab.cd_classif_deb%type;
cd_classif_cred_taxa_adm_w			pls_conta_pos_taxa_contab.cd_classif_cred%type;
ds_observacao_w					varchar(255);
ds_observacao_item_w				varchar(255);

cd_conta_cred_w					conta_contabil.cd_conta_contabil%type;
cd_conta_deb_w					conta_contabil.cd_conta_contabil%type;
cd_classif_cred_w				conta_contabil.cd_classificacao%type;
cd_classif_deb_w				conta_contabil.cd_classificacao%type;
vl_movimento_w					double precision;
ie_data_tipo_segurado_w				pls_parametros.ie_data_tipo_segurado%type;

c_pos_estab CURSOR FOR
	SELECT	coalesce(v.nr_seq_conta_resumo, 0) nr_seq_resumo,
		u.nr_seq_conta_proc nr_seq_conta_proc,
		u.nr_seq_conta_mat nr_seq_conta_mat,
		u.nr_sequencia nr_seq_pos_estabelecido,
		f.dt_atualizacao_nrec dt_contabil,
		CASE WHEN f.ie_status_faturamento_new='C' THEN -1 WHEN f.ie_status_faturamento_new='N' THEN -1 WHEN f.ie_status_faturamento_new='U' THEN -1  ELSE 1 END  ie_multiplicador,
		--Valores
		CASE WHEN f.ie_status_faturamento_new='C' THEN -1 WHEN f.ie_status_faturamento_new='N' THEN -1 WHEN f.ie_status_faturamento_new='U' THEN -1  ELSE 1 END  * coalesce(v.vl_provisao, 0) vl_provisao,
		CASE WHEN f.ie_status_faturamento_new='C' THEN -1 WHEN f.ie_status_faturamento_new='N' THEN -1 WHEN f.ie_status_faturamento_new='U' THEN -1  ELSE 1 END  * (pls_obter_vl_pag_fat_pos(v.nr_sequencia,'T'))::numeric  vl_dif_tabela,
		CASE WHEN f.ie_status_faturamento_new='C' THEN -1 WHEN f.ie_status_faturamento_new='N' THEN -1 WHEN f.ie_status_faturamento_new='U' THEN -1  ELSE 1 END  * (coalesce(v.vl_custo_operacional,0) - coalesce(v.vl_provisao,0)) vl_ajuste,
		CASE WHEN f.ie_status_faturamento_new='C' THEN -1 WHEN f.ie_status_faturamento_new='N' THEN -1 WHEN f.ie_status_faturamento_new='U' THEN -1  ELSE 1 END  * (coalesce(v.vl_custo_operacional,0) - coalesce(v.vl_administracao, 0)) vl_reembolso,
		CASE WHEN f.ie_status_faturamento_new='C' THEN -1 WHEN f.ie_status_faturamento_new='N' THEN -1 WHEN f.ie_status_faturamento_new='U' THEN -1  ELSE 1 END  * coalesce(v.vl_administracao, 0) vl_taxa,		
		--Contas e classificacao
		v.cd_conta_deb_provisao cd_conta_deb_provisao,
		v.cd_conta_cred_provisao cd_conta_cred_provisao,
		v.cd_classif_cred_provisao cd_classif_cred_provisao,
		v.cd_classif_deb_provisao cd_classif_deb_provisao,
		v.cd_conta_deb_dif cd_conta_deb_dif_tabela,
		v.cd_conta_cred_dif cd_conta_cred_dif_tabela,
		v.cd_classif_cred_dif cd_classif_cred_dif,
		v.cd_classif_deb_dif cd_classif_deb_dif,
		v.cd_conta_deb_provisao cd_conta_deb_ajuste,
		v.cd_conta_cred_provisao cd_conta_cred_ajuste,
		v.cd_classif_cred_provisao cd_classif_cred_ajuste,
		v.cd_classif_deb_provisao cd_classif_deb_ajuste,
		v.cd_conta_deb_ndc_prov cd_conta_deb_reembolso,
		v.cd_conta_cred_ndc_prov cd_conta_cred_reembolso,
		v.cd_classif_cred_ndc cd_classif_cred_reembolso,
		v.cd_classif_deb_ndc cd_classif_deb_reembolso,
		v.cd_conta_deb_taxa_prov cd_conta_deb_taxa,
		v.cd_conta_cred_taxa_prov cd_conta_cred_taxa,
		v.cd_classif_cred_taxa cd_classif_cred_taxa,
		v.cd_classif_deb_taxa cd_classif_deb_taxa,
		--Informacoes da conta e protocolo
		p.ie_tipo_protocolo ie_tipo_protocolo,
		p.nr_seq_congenere nr_seq_congenere,
		p.nr_sequencia nr_seq_protocolo,
		substr(obter_valor_dominio(3648, p.ie_tipo_protocolo), 1, 255) ds_tipo_protocolo,
		c.nr_sequencia nr_seq_conta,
		p.dt_mes_competencia dt_aviso,
		c.ie_tipo_segurado ie_tipo_segurado,
		substr(obter_valor_dominio(2406, c.ie_tipo_segurado), 1, 255) ds_tipo_segurado,
		c.nr_seq_prestador_exec nr_seq_prestador_exec,
		c.nr_seq_plano nr_seq_plano,
		c.nr_seq_segurado nr_seq_segurado,
		substr(pls_obter_dados_segurado(c.nr_seq_segurado,'N'),1,255) nm_segurado
	from	pls_conta_pos_estab_contab 	v,
		pls_conta_pos_estabelecido 	u,
		pls_log_pos_estabelecido	f,
		pls_protocolo_conta 		p,
		pls_conta			c
	
	where	u.nr_sequencia 		= v.nr_seq_conta_pos
	and	u.nr_sequencia 		= f.nr_seq_conta_pos
	and	c.nr_sequencia 		= u.nr_seq_conta
	and	p.nr_sequencia 		= c.nr_seq_protocolo
	and	c.nr_sequencia 		= f.nr_seq_conta
	--Parametros do registro auxiliar
	and (p.ie_tipo_protocolo = ie_tipo_protocolo_w or coalesce(ie_tipo_protocolo_w::text, '') = '')
	and (c.ie_tipo_segurado = ie_tipo_segurado_w or coalesce(ie_tipo_segurado_w::text, '') = '')
	--Restricoes gerais
	and	coalesce(f.ie_tipo_registro,'H') = 'H' -- Historico
	and	coalesce(u.ie_situacao,'A')	= 'A'
        and     coalesce(u.ie_status_faturamento, 'A') <> 'A'
	and	((ie_status_prov_pagto_w <> 'F') or (ie_status_prov_pagto_w = 'F' and c.ie_status = 'F'))
	and	p.cd_estabelecimento	= coalesce(cd_estabelecimento_w, cd_estabelecimento_p)
	and	p.ie_situacao		<> 'RE'
	and	coalesce((	SELECT	max(r.ie_situacao)
			from	pls_conta_medica_resumo r
			where	c.nr_sequencia	= r.nr_seq_conta
			and	r.nr_sequencia	= v.nr_seq_conta_resumo),'X')	<> 'I'
	-- 	Datas
	and	(
			(
				f.dt_atualizacao_nrec between dt_inicial_w and dt_final_w
			)
			or (
				f.dt_atualizacao_nrec > v.dt_mes_competencia
				and
				v.dt_mes_competencia between dt_inicial_w and dt_final_w
			)	
		)
	and	(
			(
				coalesce(f.ie_status_faturamento_ant,'X') in ('C','N','U','X')
				and	
				f.ie_status_faturamento_new in ('L','P')
			)
		or (
				f.ie_status_faturamento_ant in ('L','P')
				and	
				f.ie_status_faturamento_new in ('C','N','U')
			)
		);

vet_pos_estab c_pos_estab%rowtype;

c_tipo_movimento CURSOR FOR
	SELECT 'P' ie_tipo_movimento  -- Provisao
	
	where (ie_lote_taxa_fat_w	not('P','A')
	and	ie_lote_reembolso_fat_w	not in ('P','A'))
	and	vet_pos_estab.vl_provisao <> 0
	and (ie_gerar_ind_classif_w <> 'N' or vet_pos_estab.cd_conta_cred_provisao in (	SELECT c.cd_conta_contabil
												from 	conta_contabil c
												where	c.ie_tipo = 'A'
												and 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '3.1.1'))

	
union all

	select	'A' ie_tipo_movimento -- Ajuste
	
	where	ie_lote_ajuste_fat_w	= 'P'
	and	vet_pos_estab.vl_ajuste <> 0
	and (ie_gerar_ind_classif_w <> 'N' or vet_pos_estab.cd_conta_cred_ajuste in (	select c.cd_conta_contabil
												from 	conta_contabil c
												where	c.ie_tipo = 'A'
												and 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '3.1.1'))

	
union all

	select	'T' ie_tipo_movimento -- Taxa
	
	where	ie_lote_taxa_fat_w	in ('P','A')
	and	vet_pos_estab.vl_taxa <> 0
	and (ie_gerar_ind_classif_w <> 'N' or vet_pos_estab.cd_conta_cred_taxa in (	select c.cd_conta_contabil
											from 	conta_contabil c
											where	c.ie_tipo = 'A'
											and 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '3.1.1'))

	
union all

	select	'D' ie_tipo_movimento -- Diferenca de tabela
	
	where (ie_lote_dif_fat_w	= 'P'
	or (coalesce(ie_lote_dif_fat_w,'X') = 'X'
	and	ie_lote_ajuste_fat_w	= 'P'))
	and	vet_pos_estab.vl_dif_tabela <> 0
	and (ie_gerar_ind_classif_w <> 'N' or vet_pos_estab.cd_conta_cred_dif_tabela in (	select c.cd_conta_contabil
												from 	conta_contabil c
												where	c.ie_tipo = 'A'
												and 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '3.1.1'))

	
union all

	select	'R' ie_tipo_movimento -- Reembolso
	
	where	ie_lote_reembolso_fat_w	in ('P','A')
	and	vet_pos_estab.vl_reembolso <> 0
	and (ie_gerar_ind_classif_w <> 'N' or vet_pos_estab.cd_conta_cred_reembolso in (	select c.cd_conta_contabil
												from 	conta_contabil c
												where	c.ie_tipo = 'A'
												and 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '3.1.1'))

	
union all

	select	'TA' ie_tipo_movimento -- Taxa adm
	
	where	ie_lote_taxa_adm_w	= 'P'
	and	vl_taxa_adm_w <> 0
	and (ie_gerar_ind_classif_w <> 'N' or cd_conta_cred_taxa_adm_w in (	select c.cd_conta_contabil
										from 	conta_contabil c
										where	c.ie_tipo = 'A'
										and 	substr(ctb_obter_classif_conta(c.cd_conta_contabil, c.cd_classificacao, c.dt_inicio_vigencia),1,5) = '3.1.1'));

vet_tipo_movimento c_tipo_movimento%rowtype;

c_registros_delphi CURSOR FOR
	SELECT	obter_valor_dominio(9685, a.ie_tipo_documento)										|| ';' ||
		a.nr_seq_protocolo													|| ';' ||
		a.ds_tipo_protocolo													|| ';' ||
		a.nr_evento														|| ';' ||
		a.dt_conhecimento													|| ';' ||
		a.cd_procedimento						  							|| ';' ||
		CASE WHEN coalesce(a.cd_procedimento::text, '') = '' THEN  ''  ELSE a.ds_item_mat_proc END 									|| ';' ||
		a.cd_material_ops					   								|| ';' ||
		CASE WHEN coalesce(a.cd_material_ops::text, '') = '' THEN  ''  ELSE a.ds_item_mat_proc END 									|| ';' ||
		a.nr_seq_grupo_ans													|| ';' ||
		a.dt_ocorrencia														|| ';' ||
		obter_valor_dominio(6,pls_obter_se_benef_remido(a.nr_seq_segurado, a.dt_ocorrencia)) 					|| ';' ||
		a.nr_seq_segurado			        									|| ';' ||
		substr(pls_obter_dados_segurado(a.nr_seq_segurado, 'N'),1,255)								|| ';' ||
		pls_obter_dados_segurado(a.nr_seq_segurado,'C')										|| ';' ||
		a.ds_tipo_segurado													|| ';' ||
		a.nr_seq_pagador            												|| ';' ||
		pls_obter_dados_pagador(a.nr_seq_pagador,'N')										|| ';' ||
		coalesce(pls_obter_dados_pagador(a.nr_seq_pagador,'CPF'), pls_obter_dados_pagador(a.nr_seq_pagador, 'CGC'))			|| ';' ||
		obter_valor_dominio(1669, a.ie_preco)											|| ';' ||
		a.ds_tipo_regulamentacao												|| ';' ||
		a.ds_tipo_contratacao													|| ';' ||
		a.ds_segmentacao													|| ';' ||
		a.nr_contrato             												|| ';' ||
		a.nr_protocolo_ans													|| ';' ||
		obter_valor_dominio(3384, a.ie_tipo_repasse)										|| ';' ||
		obter_valor_dominio(8980, a.ie_tipo_compartilhamento)									|| ';' ||
		a.dt_inicio_compartilhamento												|| ';' ||
		a.dt_fim_compartilhamento												|| ';' ||
		coalesce(substr(pls_obter_dados_prestador(a.nr_seq_prestador,'CPF'),1,255),
			substr(pls_obter_dados_prestador(a.nr_seq_prestador,'CGC'),1,255))						|| ';' ||
		a.nr_seq_prestador													|| ';' ||
		pls_obter_dados_prestador(a.nr_seq_prestador,'N')									|| ';' ||
		a.ds_tipo_relacao													|| ';' ||
		a.ds_ato_cooperado													|| ';' ||
		a.vl_evento														|| ';' ||
		a.dt_contabilizacao													|| ';' ||
		replace(a.cd_conta_contrapartida,chr(039),'')										|| ';' ||
		substr(ctb_obter_classif_conta(a.cd_conta_contrapartida, null, a.dt_contabilizacao),1,255)				|| ';' ||
		replace(a.cd_conta_contabil,chr(039),'')											|| ';' ||
		substr(ctb_obter_classif_conta(a.cd_conta_contabil, null, a.dt_contabilizacao),1,255)					|| ';' ||
		a.ds_observacao		ds_linha
	from 	w_ctb_livro_aux_event_liq a
	where	nr_seq_reg_auxiliar = nr_seq_reg_auxiliar_p
	order by (nr_documento)::numeric;

BEGIN
CALL wheb_usuario_pck.set_ie_executar_trigger('N');

select 	trunc(dt_inicial,'dd'),
	fim_dia(dt_final),
	dt_liberacao,
	ie_tipo_protocolo,
	ie_tipo_segurado,
	ie_gerar_ind_classif,
	cd_estab_exclusivo
into STRICT   	dt_inicial_w,
	dt_final_w,
	dt_liberacao_w,
	ie_tipo_protocolo_w,
	ie_tipo_segurado_w,
	ie_gerar_ind_classif_w,
	cd_estabelecimento_w
from   ctb_livro_auxiliar
where  nr_sequencia = nr_seq_reg_auxiliar_p;

select	coalesce(max(a.ie_data_tipo_segurado),'A')
into STRICT	ie_data_tipo_segurado_w
from	pls_parametros a
where	a.cd_estabelecimento = cd_estabelecimento_p;

if (ie_origem_p = 'H' or ie_gerar_arquivo_p = 'N') then
	select	coalesce(max(ie_status_prov_pagto),'N'),
		coalesce(max(ie_lote_taxa_fat), 'R'),
		coalesce(max(ie_lote_reembolso_fat),'R'),
		coalesce(max(ie_lote_ajuste_fat), 'R'),
		max(ie_lote_dif_fat),
		coalesce(max(ie_lote_taxa_adm),'R'),
		max(ie_lote_ajuste_prod)
	into STRICT	ie_status_prov_pagto_w,
		ie_lote_taxa_fat_w,
		ie_lote_reembolso_fat_w,
		ie_lote_ajuste_fat_w,
		ie_lote_dif_fat_w,
		ie_lote_taxa_adm_w,
		ie_lote_ajuste_prod_w
	from	pls_parametro_contabil
	where	cd_estabelecimento = coalesce(cd_estabelecimento_w, cd_estabelecimento_p);


	select	substr(obter_desc_expressao(922923),1,255)
	into STRICT	ds_observacao_w
	;

	delete
	from	w_ctb_livro_aux_event_liq a
	where	nr_seq_reg_auxiliar = nr_seq_reg_auxiliar_p;

	delete
	from	pls_aux_event_pos_estab a
	where	nr_seq_reg_auxiliar = nr_seq_reg_auxiliar_p;

	commit;




	open c_pos_estab;
	loop
	fetch c_pos_estab into
		vet_pos_estab;
	EXIT WHEN NOT FOUND; /* apply on c_pos_estab */
		begin
		select	coalesce(max('S'), 'N') ie_existe_resumo
		into STRICT	ie_existe_resumo_w
		from	pls_conta_medica_resumo b
		where	b.nr_sequencia = vet_pos_estab.nr_seq_resumo
		and	b.nr_seq_conta = vet_pos_estab.nr_seq_conta;

		if (vet_pos_estab.ie_tipo_protocolo <> 'I' and ie_existe_resumo_w = 'S') then
			select	nr_seq_segurado,
				cd_procedimento,
				cd_material,
				nr_seq_material,
				ds_mat_proc,
				nr_seq_conta_mat,
				ie_origem_proced,
				nr_seq_grupo_ans,
				ds_grupo_ans,
				dt_realizacao,
				nr_carteira,
				nm_beneficiario,
				cpf_cnpj_pagador,
				nr_seq_pagador,
				nm_pagador,
				ie_preco,
				ds_preco,
				ie_regulamentacao,
				ds_regulamentacao,
				ie_tipo_contratacao,
				ds_tipo_contratacao,
				ie_segmentacao,
				ds_segmentacao,
				nr_contrato,
				nr_seq_contrato,
				nr_registro_produto,
				cpf_cnpj_prestador,
				nm_prestador,
				ie_tipo_vinculo,
				ds_tipo_vinculo,
				ie_ato_cooperado,
				ds_ato_cooperado,
				nr_seq_prestador
			into STRICT	nr_seq_segurado_w,
				cd_procedimento_w,
				cd_material_w,
				nr_seq_material_w,
				ds_mat_proc_w,
				nr_seq_conta_mat_w,
				ie_origem_proced_w,
				nr_seq_grupo_ans_w,
				ds_grupo_ans_w,
				dt_realizacao_w,
				nr_carteira_w,
				nm_beneficiario_w,
				cpf_cnpj_pagador_w,
				nr_seq_pagador_w,
				nm_pagador_w,
				ie_preco_w,
				ds_preco_w,
				ie_regulamentacao_w,
				ds_regulamentacao_w,
				ie_tipo_contratacao_w,
				ds_tipo_contratacao_w,
				ie_segmentacao_w,
				ds_segmentacao_w,
				nr_contrato_w,
				nr_seq_contrato_w,
				nr_registro_produto_w,
				cpf_cnpj_prestador_w,
				nm_prestador_w,
				ie_tipo_vinculo_w,
				ds_tipo_vinculo_w,
				ie_ato_cooperado_w,
				ds_ato_cooperado_w,
				nr_seq_prestador_w
			from	(SELECT s.nr_sequencia nr_seq_segurado,
					pp.cd_procedimento cd_procedimento,
					null cd_material,
					null nr_seq_material,
					obter_descricao_procedimento(pp.cd_procedimento, r.ie_origem_proced) ds_mat_proc,
					null nr_seq_conta_mat,
					pp.ie_origem_proced ie_origem_proced,
					pp.nr_seq_grupo_ans nr_seq_grupo_ans,
					pls_obter_dados_grupo_ans(pp.nr_seq_grupo_ans,'D') ds_grupo_ans,
					pp.dt_procedimento dt_realizacao,
					pls_obter_dados_segurado(s.nr_sequencia,'C') nr_carteira,
					pls_obter_dados_segurado(s.nr_sequencia,'N') nm_beneficiario,
					coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'), pls_obter_dados_pagador(s.nr_seq_pagador, 'CGC')) cpf_cnpj_pagador,
					s.nr_seq_pagador nr_seq_pagador,
					pls_obter_dados_pagador(s.nr_seq_pagador,'N') nm_pagador,
					y.ie_preco ie_preco,
					substr(obter_valor_dominio(1669, y.ie_preco), 1, 255) ds_preco,
					y.ie_regulamentacao ie_regulamentacao,
					substr(obter_valor_dominio(2157, y.ie_regulamentacao), 1, 255) ds_regulamentacao,
					y.ie_tipo_contratacao ie_tipo_contratacao,
					substr(obter_valor_dominio(1666, y.ie_tipo_contratacao), 1, 255) ds_tipo_contratacao,
					y.ie_segmentacao ie_segmentacao,
					substr(obter_valor_dominio(1665, y.ie_segmentacao), 1, 255) ds_segmentacao,
					t.nr_contrato nr_contrato,
					t.nr_sequencia nr_seq_contrato,
					CASE WHEN y.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(y.nr_protocolo_ans, y.cd_scpa) END  nr_registro_produto,
					coalesce(substr(pls_obter_dados_prestador(coalesce(r.nr_seq_prestador_pgto, vet_pos_estab.nr_seq_prestador_exec),'CPF'),1,255),
						substr(pls_obter_dados_prestador(coalesce(r.nr_seq_prestador_pgto, vet_pos_estab.nr_seq_prestador_exec),'CGC'),1,255)) cpf_cnpj_prestador,
					pls_obter_dados_prestador(coalesce(r.nr_seq_prestador_pgto, vet_pos_estab.nr_seq_prestador_exec),'N') nm_prestador,
					(select	max(ie_tipo_relacao)
					from	pls_prestador
					where	nr_sequencia	= coalesce(r.nr_seq_prestador_pgto, vet_pos_estab.nr_seq_prestador_exec)) ie_tipo_vinculo,
					pls_obter_dados_prestador(coalesce(r.nr_seq_prestador_pgto, vet_pos_estab.nr_seq_prestador_exec), 'TR') ds_tipo_vinculo,
					r.ie_ato_cooperado ie_ato_cooperado,
					substr(obter_valor_dominio(3418, r.ie_ato_cooperado), 1, 255) ds_ato_cooperado,
					coalesce(r.nr_seq_prestador_pgto, vet_pos_estab.nr_seq_prestador_exec) nr_seq_prestador
				FROM pls_conta_medica_resumo r, pls_conta_proc pp, pls_segurado s
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
, coalesce(vet_pos_estab
LEFT OUTER JOIN pls_plano y ON (coalesce(vet_pos_estab.nr_seq_plano, s.nr_seq_plano) = y.nr_sequencia)
WHERE r.nr_seq_conta			= vet_pos_estab.nr_seq_conta and s.nr_sequencia 			= vet_pos_estab.nr_seq_segurado   and r.nr_sequencia 			= vet_pos_estab.nr_seq_resumo and pp.nr_sequencia 		= r.nr_seq_conta_proc --Restricoes gerais
  and r.ie_situacao		<> 'I'
				
union all

				SELECT 	s.nr_sequencia nr_seq_segurado,
					null cd_procedimento,
					substr(pls_obter_seq_codigo_material(m.nr_seq_material, ''), 1, 255) cd_material,
					m.nr_seq_material nr_seq_material,
					substr(obter_descricao_padrao('PLS_MATERIAL','DS_MATERIAL', m.nr_seq_material),1,255) ds_mat_proc,
					m.nr_sequencia	nr_seq_conta_mat,
					null ie_origem_proced,
					m.nr_seq_grupo_ans nr_seq_grupo_ans,
					pls_obter_dados_grupo_ans(m.nr_seq_grupo_ans,'D') ds_grupo_ans,
					m.dt_atendimento dt_realizacao,
					pls_obter_dados_segurado(s.nr_sequencia,'C') nr_carteira,
					pls_obter_dados_segurado(s.nr_sequencia,'N') nm_beneficiario,
					coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'), pls_obter_dados_pagador(s.nr_seq_pagador, 'CGC')) cpf_cnpj_pagador,
					s.nr_seq_pagador nr_seq_pagador,
					pls_obter_dados_pagador(s.nr_seq_pagador,'N') nm_pagador,
					y.ie_preco ie_preco,
					substr(obter_valor_dominio(1669, y.ie_preco), 1, 255) ds_preco,
					y.ie_regulamentacao ie_regulamentacao,
					substr(obter_valor_dominio(2157, y.ie_regulamentacao), 1, 255) ds_regulamentacao,
					y.ie_tipo_contratacao ie_tipo_contratacao,
					substr(obter_valor_dominio(1666, y.ie_tipo_contratacao), 1, 255) ds_tipo_contratacao,
					y.ie_segmentacao ie_segmentacao,
					substr(obter_valor_dominio(1665, y.ie_segmentacao), 1, 255) ds_segmentacao,
					t.nr_contrato nr_contrato,
					t.nr_sequencia nr_seq_contrato,
					CASE WHEN y.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(y.nr_protocolo_ans, y.cd_scpa) END  nr_registro_produto,
					coalesce(substr(pls_obter_dados_prestador(coalesce(r.nr_seq_prestador_pgto, vet_pos_estab.nr_seq_prestador_exec),'CPF'),1,255),
						substr(pls_obter_dados_prestador(coalesce(r.nr_seq_prestador_pgto, vet_pos_estab.nr_seq_prestador_exec),'CGC'),1,255)) cpf_cnpj_prestador,
					pls_obter_dados_prestador(coalesce(r.nr_seq_prestador_pgto, vet_pos_estab.nr_seq_prestador_exec),'N') nm_prestador,
					(select	max(ie_tipo_relacao)
					from	pls_prestador
					where	nr_sequencia	= coalesce(r.nr_seq_prestador_pgto, vet_pos_estab.nr_seq_prestador_exec)) ie_tipo_vinculo,
					pls_obter_dados_prestador(coalesce(r.nr_seq_prestador_pgto, vet_pos_estab.nr_seq_prestador_exec), 'TR') ds_tipo_vinculo,
					r.ie_ato_cooperado ie_ato_cooperado,
					substr(obter_valor_dominio(3418, r.ie_ato_cooperado), 1, 255) ds_ato_cooperado,
					coalesce(r.nr_seq_prestador_pgto, vet_pos_estab.nr_seq_prestador_exec) nr_seq_prestador
				FROM pls_conta_medica_resumo r, pls_conta_mat m, pls_segurado s
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
, coalesce(vet_pos_estab
LEFT OUTER JOIN pls_plano y ON (coalesce(vet_pos_estab.nr_seq_plano, s.nr_seq_plano) = y.nr_sequencia)
WHERE r.nr_seq_conta			= vet_pos_estab.nr_seq_conta and s.nr_sequencia 			= vet_pos_estab.nr_seq_segurado   and r.nr_sequencia 			= vet_pos_estab.nr_seq_resumo and m.nr_sequencia			= r.nr_seq_conta_mat --Restricoes gerais
  and r.ie_situacao		<> 'I' ) alias74;

			select 	max(w.vl_provisao * vet_pos_estab.ie_multiplicador),
				coalesce(max(w.cd_conta_deb),vet_pos_estab.cd_conta_deb_taxa),
				coalesce(max(w.cd_conta_cred),vet_pos_estab.cd_conta_cred_taxa),
				coalesce(max(w.cd_classif_deb),vet_pos_estab.cd_classif_cred_taxa),
				coalesce(max(w.cd_classif_cred),vet_pos_estab.cd_classif_deb_taxa)
			into STRICT	vl_taxa_adm_w,
				cd_conta_deb_taxa_adm_w,
				cd_conta_cred_taxa_adm_w,
				cd_classif_deb_taxa_adm_w,
				cd_classif_cred_taxa_adm_w
			FROM pls_conta_pos_estab_taxa t
LEFT OUTER JOIN pls_conta_pos_taxa_contab w ON (t.nr_sequencia = w.nr_seq_pos_estab_taxa)
, vet_pos_estab
LEFT OUTER JOIN pls_conta_pos_estab_taxa t ON (vet_pos_estab.nr_seq_pos_estabelecido = t.nr_seq_conta_pos_estab)
WHERE w.nr_seq_conta_resumo		= vet_pos_estab.nr_seq_resumo  and coalesce((	SELECT	max(r.ie_situacao)
					from	pls_conta_medica_resumo		r,
						pls_conta_pos_estab_contab 	e
					where	vet_pos_estab.nr_seq_conta	= r.nr_seq_conta
					and	vet_pos_estab.nr_seq_resumo 	= r.nr_sequencia
					and	vet_pos_estab.nr_seq_pos_estabelecido	= e.nr_seq_conta_pos),'X')	<> 'I';

		elsif (vet_pos_estab.ie_tipo_protocolo = 'I' or coalesce(vet_pos_estab.nr_seq_resumo, 0) = 0) then

			select 	nr_seq_segurado,
				cd_procedimento,
				cd_material,
				nr_seq_material,
				ds_mat_proc,
				nr_seq_conta_mat,
				ie_origem_proced,
				nr_seq_grupo_ans,
				ds_grupo_ans,
				dt_realizacao,
				nr_carteira,
				nm_beneficiario,
				cpf_cnpj_pagador,
				nr_seq_pagador,
				nm_pagador,
				ie_preco,
				ds_preco,
				ie_regulamentacao,
				ds_regulamentacao,
				ie_tipo_contratacao,
				ds_tipo_contratacao,
				ie_segmentacao,
				ds_segmentacao,
				nr_contrato,
				nr_seq_contrato,
				nr_registro_produto,
				cpf_cnpj_prestador,
				nm_prestador,
				ie_tipo_vinculo,
				ds_tipo_vinculo,
				ie_ato_cooperado,
				ds_ato_cooperado,
				nr_seq_prestador
			into STRICT	nr_seq_segurado_w,
				cd_procedimento_w,
				cd_material_w,
				nr_seq_material_w,
				ds_mat_proc_w,
				nr_seq_conta_mat_w,
				ie_origem_proced_w,
				nr_seq_grupo_ans_w,
				ds_grupo_ans_w,
				dt_realizacao_w,
				nr_carteira_w,
				nm_beneficiario_w,
				cpf_cnpj_pagador_w,
				nr_seq_pagador_w,
				nm_pagador_w,
				ie_preco_w,
				ds_preco_w,
				ie_regulamentacao_w,
				ds_regulamentacao_w,
				ie_tipo_contratacao_w,
				ds_tipo_contratacao_w,
				ie_segmentacao_w,
				ds_segmentacao_w,
				nr_contrato_w,
				nr_seq_contrato_w,
				nr_registro_produto_w,
				cpf_cnpj_prestador_w,
				nm_prestador_w,
				ie_tipo_vinculo_w,
				ds_tipo_vinculo_w,
				ie_ato_cooperado_w,
				ds_ato_cooperado_w,
				nr_seq_prestador_w
			from	(SELECT	s.nr_sequencia nr_seq_segurado,
					pp.cd_procedimento cd_procedimento,
					null cd_material,
					null nr_seq_material,
					obter_descricao_procedimento(pp.cd_procedimento, pp.ie_origem_proced) ds_mat_proc,
					null nr_seq_conta_mat,
					pp.ie_origem_proced ie_origem_proced,
					pp.nr_seq_grupo_ans nr_seq_grupo_ans,
					pls_obter_dados_grupo_ans(pp.nr_seq_grupo_ans,'D') ds_grupo_ans,
					pp.dt_procedimento dt_realizacao,
					pls_obter_dados_segurado(s.nr_sequencia,'C') nr_carteira,
					pls_obter_dados_segurado(s.nr_sequencia,'N') nm_beneficiario,
					coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'), pls_obter_dados_pagador(s.nr_seq_pagador, 'CGC')) cpf_cnpj_pagador,
					s.nr_seq_pagador nr_seq_pagador,
					pls_obter_dados_pagador(s.nr_seq_pagador,'N') nm_pagador,
					y.ie_preco ie_preco,
					substr(obter_valor_dominio(1669, y.ie_preco), 1, 255) ds_preco,
					y.ie_regulamentacao ie_regulamentacao,
					substr(obter_valor_dominio(2157, y.ie_regulamentacao), 1, 255) ds_regulamentacao,
					y.ie_tipo_contratacao ie_tipo_contratacao,
					substr(obter_valor_dominio(1666, y.ie_tipo_contratacao), 1, 255) ds_tipo_contratacao,
					y.ie_segmentacao ie_segmentacao,
					substr(obter_valor_dominio(1665, y.ie_segmentacao), 1, 255) ds_segmentacao,
					t.nr_contrato nr_contrato,
					t.nr_sequencia nr_seq_contrato,
					CASE WHEN y.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(y.nr_protocolo_ans, y.cd_scpa) END  nr_registro_produto,
					substr(coalesce(pls_obter_dados_prestador(vet_pos_estab.nr_seq_prestador_exec,'CPF'),pls_obter_dados_prestador(vet_pos_estab.nr_seq_prestador_exec,'CGC')), 1, 255) cpf_cnpj_prestador,
					pls_obter_dados_prestador(vet_pos_estab.nr_seq_prestador_exec,'N') nm_prestador,
					(select	max(ie_tipo_relacao)
					from	pls_prestador
					where	nr_sequencia	= vet_pos_estab.nr_seq_prestador_exec) ie_tipo_vinculo,
					pls_obter_dados_prestador(vet_pos_estab.nr_seq_prestador_exec, 'TR') ds_tipo_vinculo,
					pp.ie_ato_cooperado ie_ato_cooperado,
					substr(obter_valor_dominio(3418, pp.ie_ato_cooperado), 1, 255) ds_ato_cooperado,
					vet_pos_estab.nr_seq_prestador_exec nr_seq_prestador
				FROM pls_conta_proc pp, pls_segurado s
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
, coalesce(vet_pos_estab
LEFT OUTER JOIN pls_plano y ON (coalesce(vet_pos_estab.nr_seq_plano, s.nr_seq_plano) = y.nr_sequencia)
WHERE s.nr_sequencia 		= vet_pos_estab.nr_seq_segurado   and pp.nr_sequencia		= vet_pos_estab.nr_seq_conta_proc
				
union all

				SELECT	s.nr_sequencia nr_seq_segurado,
					null cd_procedimento,
					substr(pls_obter_seq_codigo_material(m.nr_seq_material, ''), 1, 255) cd_material,
					m.nr_seq_material nr_seq_material,
					substr(obter_descricao_padrao('PLS_MATERIAL','DS_MATERIAL', m.nr_seq_material),1,255) ds_mat_proc,
					m.nr_sequencia nr_seq_conta_mat,
					null ie_origem_proced,
					m.nr_seq_grupo_ans nr_seq_grupo_ans,
					pls_obter_dados_grupo_ans(m.nr_seq_grupo_ans,'D') ds_grupo_ans,
					m.dt_atendimento dt_realizacao,
					pls_obter_dados_segurado(s.nr_sequencia,'C') nr_carteira,
					pls_obter_dados_segurado(s.nr_sequencia,'N') nm_beneficiario,
					coalesce(pls_obter_dados_pagador(s.nr_seq_pagador,'CPF'), pls_obter_dados_pagador(s.nr_seq_pagador, 'CGC')) cpf_cnpj_pagador,
					s.nr_seq_pagador nr_seq_pagador,
					pls_obter_dados_pagador(s.nr_seq_pagador,'N') nm_pagador,
					y.ie_preco ie_preco,
					substr(obter_valor_dominio(1669, y.ie_preco), 1, 255) ds_preco,
					y.ie_regulamentacao ie_regulamentacao,
					substr(obter_valor_dominio(2157, y.ie_regulamentacao), 1, 255) ds_regulamentacao,
					y.ie_tipo_contratacao ie_tipo_contratacao,
					substr(obter_valor_dominio(1666, y.ie_tipo_contratacao), 1, 255) ds_tipo_contratacao,
					y.ie_segmentacao ie_segmentacao,
					substr(obter_valor_dominio(1665, y.ie_segmentacao), 1, 255) ds_segmentacao,
					t.nr_contrato nr_contrato,
					t.nr_sequencia nr_seq_contrato,
					CASE WHEN y.ie_tipo_operacao='A' THEN  'SCA'  ELSE coalesce(y.nr_protocolo_ans, y.cd_scpa) END  nr_registro_produto,
					substr(coalesce(pls_obter_dados_prestador(vet_pos_estab.nr_seq_prestador_exec,'CPF'),pls_obter_dados_prestador(vet_pos_estab.nr_seq_prestador_exec,'CGC')), 1, 255) cpf_cnpj_prestador,
					pls_obter_dados_prestador(vet_pos_estab.nr_seq_prestador_exec,'N') nm_prestador,
					(select	max(ie_tipo_relacao)
					from	pls_prestador
					where	nr_sequencia	= vet_pos_estab.nr_seq_prestador_exec) ie_tipo_vinculo,
					pls_obter_dados_prestador(vet_pos_estab.nr_seq_prestador_exec, 'TR') ds_tipo_vinculo,
					m.ie_ato_cooperado ie_ato_cooperado,
					substr(obter_valor_dominio(3418, m.ie_ato_cooperado), 1, 255) ds_ato_cooperado,
					vet_pos_estab.nr_seq_prestador_exec nr_seq_prestador
				FROM pls_conta_mat m, pls_segurado s
LEFT OUTER JOIN pls_contrato t ON (s.nr_seq_contrato = t.nr_sequencia)
, coalesce(vet_pos_estab
LEFT OUTER JOIN pls_plano y ON (coalesce(vet_pos_estab.nr_seq_plano, s.nr_seq_plano) = y.nr_sequencia)
WHERE s.nr_sequencia 		= vet_pos_estab.nr_seq_segurado   and m.nr_sequencia 		= vet_pos_estab.nr_seq_conta_mat ) alias61;

			select 	max(w.vl_provisao * vet_pos_estab.ie_multiplicador),
				coalesce(max(w.cd_conta_deb),vet_pos_estab.cd_conta_deb_taxa),
				coalesce(max(w.cd_conta_cred),vet_pos_estab.cd_conta_cred_taxa),
				coalesce(max(w.cd_classif_deb),vet_pos_estab.cd_classif_cred_taxa),
				coalesce(max(w.cd_classif_cred),vet_pos_estab.cd_classif_deb_taxa)
			into STRICT	vl_taxa_adm_w,
				cd_conta_deb_taxa_adm_w,
				cd_conta_cred_taxa_adm_w,
				cd_classif_deb_taxa_adm_w,
				cd_classif_cred_taxa_adm_w
			FROM pls_conta_pos_estab_taxa t
LEFT OUTER JOIN pls_conta_pos_taxa_contab w ON (t.nr_sequencia = w.nr_seq_pos_estab_taxa)
, vet_pos_estab
LEFT OUTER JOIN pls_conta_pos_estab_taxa t ON (vet_pos_estab.nr_seq_pos_estabelecido = t.nr_seq_conta_pos_estab);
		
		end if;
		
		if (ie_data_tipo_segurado_w = 'A') then
			dt_ref_repasse_w	:= dt_realizacao_w;
		else
			dt_ref_repasse_w	:= vet_pos_estab.dt_aviso;
		end if;
		
		SELECT * FROM pls_obter_dados_repasse(	dt_ref_repasse_w, nr_seq_segurado_w, vet_pos_estab.nr_seq_congenere, ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w) INTO STRICT ie_tipo_repasse_w, ie_tipo_compartilhamento_w, dt_repasse_w, dt_fim_repasse_w;

		if (vet_pos_estab.vl_ajuste < 0 or ie_lote_ajuste_prod_w = 'R') then
			vet_pos_estab.vl_ajuste    := 0;
		end if;

		open c_tipo_movimento;
		loop
		fetch c_tipo_movimento into
			vet_tipo_movimento;
		EXIT WHEN NOT FOUND; /* apply on c_tipo_movimento */
			begin

			if (vet_tipo_movimento.ie_tipo_movimento = 'P') then
				cd_conta_cred_w			:= vet_pos_estab.cd_conta_cred_provisao;
				cd_conta_deb_w			:= vet_pos_estab.cd_conta_deb_provisao;
				cd_classif_cred_w		:= vet_pos_estab.cd_classif_cred_provisao;
				cd_classif_deb_w		:= vet_pos_estab.cd_classif_deb_provisao;
				vl_movimento_w			:= vet_pos_estab.vl_provisao;

			elsif (vet_tipo_movimento.ie_tipo_movimento = 'A') then
				cd_conta_cred_w			:= vet_pos_estab.cd_conta_cred_ajuste;
				cd_conta_deb_w			:= vet_pos_estab.cd_conta_deb_ajuste;
				cd_classif_cred_w		:= vet_pos_estab.cd_classif_cred_ajuste;
				cd_classif_deb_w		:= vet_pos_estab.cd_classif_deb_ajuste;
				vl_movimento_w			:= vet_pos_estab.vl_ajuste;

			elsif (vet_tipo_movimento.ie_tipo_movimento = 'T') then
				cd_conta_cred_w			:= vet_pos_estab.cd_conta_cred_taxa;
				cd_conta_deb_w			:= vet_pos_estab.cd_conta_deb_taxa;
				cd_classif_cred_w		:= vet_pos_estab.cd_classif_cred_taxa;
				cd_classif_deb_w		:= vet_pos_estab.cd_classif_deb_taxa;
				vl_movimento_w			:= vet_pos_estab.vl_taxa;

			elsif (vet_tipo_movimento.ie_tipo_movimento = 'D') then
				cd_conta_cred_w			:= vet_pos_estab.cd_conta_cred_dif_tabela;
				cd_conta_deb_w			:= vet_pos_estab.cd_conta_deb_dif_tabela;
				cd_classif_cred_w		:= vet_pos_estab.cd_classif_cred_dif;
				cd_classif_deb_w		:= vet_pos_estab.cd_classif_deb_dif;
				vl_movimento_w			:= vet_pos_estab.vl_dif_tabela;

			elsif (vet_tipo_movimento.ie_tipo_movimento = 'R') then
				cd_conta_cred_w			:= vet_pos_estab.cd_conta_cred_reembolso;
				cd_conta_deb_w			:= vet_pos_estab.cd_conta_deb_reembolso;
				cd_classif_cred_w		:= vet_pos_estab.cd_classif_cred_reembolso;
				cd_classif_deb_w		:= vet_pos_estab.cd_classif_deb_reembolso;
				vl_movimento_w			:= vet_pos_estab.vl_reembolso;

			elsif (vet_tipo_movimento.ie_tipo_movimento = 'TA') then
				cd_conta_cred_w			:= cd_conta_cred_taxa_adm_w;
				cd_conta_deb_w			:= cd_conta_deb_taxa_adm_w;
				cd_classif_cred_w		:= cd_classif_cred_taxa_adm_w;
				cd_classif_deb_w		:= cd_classif_deb_taxa_adm_w;
				vl_movimento_w			:= vl_taxa_adm_w;
			end if;
		
		ds_observacao_item_w	:= null;
		
		if (vet_pos_estab.ie_tipo_segurado in ('C', 'I', 'T')) then
			ds_observacao_item_w	:= ds_observacao_w;
		end if;

		nr_contador_w := nr_contador_w + 1;

		-- Inserts para o Delphi
		if (ie_origem_p = 'D') then
			insert into w_ctb_livro_aux_event_liq(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_reg_auxiliar,
				cd_conta_contabil,
				cd_conta_contrapartida,
				cd_material_ops,
				cd_procedimento,
				ds_item_mat_proc,
				ds_observacao,
				dt_conhecimento,
				dt_contabilizacao,
				dt_inicio_compartilhamento,
				dt_fim_compartilhamento,
				dt_ocorrencia,
				ie_ato_cooperado,
				ds_ato_cooperado,
				ie_origem_proced,
				ie_regulamentacao,
				ds_tipo_regulamentacao,
				ie_segmentacao,
				ds_segmentacao,
				ie_tipo_compartilhamento,
				ie_tipo_contratacao,
				ds_tipo_contratacao,
				ie_preco,
				ds_modalidade_contrat,
				ie_tipo_documento,
				ie_tipo_protocolo,
				ds_tipo_protocolo,
				ie_tipo_repasse,
				ie_tipo_segurado,
				ds_tipo_segurado,
				ie_tipo_relacao,
				ds_tipo_relacao,
				nr_contrato,
				nr_protocolo_ans,
				nr_evento,
				nr_grupo_ans,
				nr_seq_grupo_ans,
				ds_grupo_ans,
				nr_seq_congenere,
				nr_seq_pagador,
				nm_usuario_princ,
				nr_seq_prestador,
				nm_prestador,
				nr_seq_segurado,
				nm_usuario_evento,
				nr_seq_protocolo,
				vl_evento,
				ie_tipo_livro,
				nr_documento,
				nr_linha,
				nr_cpf_cnpj,
				nr_cpf_cnpj_adic,
				cd_beneficiario,
				dt_referencia
			) values (
				nextval('w_ctb_livro_aux_event_liq_seq'),		--nr_sequencia
				clock_timestamp(),					--dt_atualizacao
				nm_usuario_p,					--nm_usuario
				clock_timestamp(),					--dt_atualizacao_nrec
				nm_usuario_p,					--nm_usuario_nrec
				nr_seq_reg_auxiliar_p,				--nr_seq_reg_auxiliar			
				cd_conta_cred_w,				--cd_conta_credito
				cd_conta_deb_w,					--cd_conta_contrapartida
				cd_material_w,					--cd_material_ops
				cd_procedimento_w,				--cd_procedimento,
				ds_mat_proc_w,					--ds_item_mat_proc
				ds_observacao_item_w,				--ds_observacao
				vet_pos_estab.dt_aviso,				--dt_conhecimento,
				vet_pos_estab.dt_contabil,			--dt_contabilizacao
				dt_repasse_w,					--dt_inicio_compartilhamento
				dt_fim_repasse_w,				--dt_fim_compartilhamento
				dt_realizacao_w,				--dt_ocorrencia
				ie_ato_cooperado_w,				--ie_ato_cooperado
				ds_ato_cooperado_w,				--ds_ato_cooperado
				ie_origem_proced_w,				--ie_origem_proced
				ie_regulamentacao_w,				--ie_regulamentacao
				ds_regulamentacao_w,				--ds_tipo_regulamentacao
				ie_segmentacao_w,				--ie_segmentacao
				ds_segmentacao_w,				--ds_segmentacao
				ie_tipo_compartilhamento_w,			--ie_tipo_compartilhamento
				ie_tipo_contratacao_w,				--ie_tipo_contratacao
				ds_tipo_contratacao_w,				--ds_tipo_contratacao
				ie_preco_w,					--ie_preco
				ds_preco_w,					--ds_modalidade_contrat
				vet_tipo_movimento.ie_tipo_movimento,		--ie_tipo_documento (ie_tipo_movimento)
				vet_pos_estab.ie_tipo_protocolo,		--ie_tipo_protocolo
				vet_pos_estab.ds_tipo_protocolo,		--ds_tipo_protocolo
				ie_tipo_repasse_w,				--ie_tipo_repasse
				vet_pos_estab.ie_tipo_segurado,			--ie_tipo_segurado
				vet_pos_estab.ds_tipo_segurado,			--ds_tipo_segurado
				ie_tipo_vinculo_w,				--ie_tipo_relacao
				ds_tipo_vinculo_w,				--ds_tipo_relacao
				nr_contrato_w,					--nr_contrato
				nr_registro_produto_w,				--nr_protocolo_ans
				vet_pos_estab.nr_seq_conta,			--nr_evento (Conta)
				nr_seq_contrato_w,				--nr_grupo_ans (Seq Contrato)
				nr_seq_grupo_ans_w,				--nr_seq_grupo_ans
				ds_grupo_ans_w,					--ds_grupo_ans
				nr_seq_material_w,				--nr_seq_congenere (nr_seq_material)
				nr_seq_pagador_w,				--nr_seq_pagador
				nm_pagador_w,					--nm_usuario_princ
				nr_seq_prestador_w,				--nr_seq_prestador
				nm_prestador_w,					--nm_prestador
				vet_pos_estab.nr_seq_segurado,			--nr_seq_segurado
				vet_pos_estab.nm_segurado,			--nm_usuario_evento
				vet_pos_estab.nr_seq_protocolo,			--nr_seq_protocolo
				vl_movimento_w,					--vl_evento
				9,						--ie_tipo_livro
				vet_pos_estab.nr_seq_conta,			--nr_documento
				nr_contador_w,					--nr_linha
				cpf_cnpj_pagador_w,				--nr_cpf_cnpj (CPF/CNPJ Pagador)
				cpf_cnpj_prestador_w,				--nr_cpf_cnpj_adic (CPF/CNPJ Prestador)
				nr_carteira_w,					--cd_beneficiario
				dt_final_w					-- dt_referencia
			);
		end if;

		-- Inserts para o HTML
		if (ie_origem_p = 'H') then
			insert into pls_aux_event_pos_estab(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_reg_auxiliar,
				cd_conta_credito,
				cd_conta_debito,
				cd_procedimento,
				ds_observacao,
				dt_aviso,
				dt_contabil,
				dt_inicio_compartilhamento,
				dt_fim_compartilhamento,
				dt_realizacao,
				ie_ato_cooperado,
				ie_origem_proced,
				ie_regulamentacao,
				ie_segmentacao,
				ie_tipo_compartilhamento,
				ie_tipo_contratacao,
				ie_tipo_modalidade,
				ie_tipo_movimento,
				ie_tipo_protocolo,
				ie_tipo_repasse,
				ie_tipo_segurado,
				ie_tipo_vinculo,
				nr_contrato,
				nr_registro_produto,
				nr_seq_conta,
				nr_seq_contrato,
				nr_seq_grupo_ans,
				nr_seq_material,
				nr_seq_pagador,
				nr_seq_prestador,
				nr_seq_protocolo,
				nr_seq_segurado,
				vl_movimento
			) values (
				nextval('pls_aux_event_pos_estab_seq'), 	--nr_sequencia
				clock_timestamp(), 				--dt_atualizacao
				nm_usuario_p,				--nm_usuario
				clock_timestamp(),				--dt_atualizacao_nrec
				nm_usuario_p,				--nm_usuario_nrec
				nr_seq_reg_auxiliar_p,			--nr_seq_reg_auxiliar
				cd_conta_cred_w,			--cd_conta_credito
				cd_conta_deb_w,				--cd_conta_debito
				cd_procedimento_w,			--cd_procedimento
				ds_observacao_item_w,			--ds_observacao
				vet_pos_estab.dt_aviso,			--dt_aviso
				vet_pos_estab.dt_contabil,		--dt_contabil
				dt_repasse_w,				--dt_inicio_compartilhamento
				dt_fim_repasse_w,			--dt_fim_compartilhamento
				dt_realizacao_w,			--dt_realizacao
				ie_ato_cooperado_w,			--ie_ato_cooperado
				ie_origem_proced_w,			--ie_origem_proced
				ie_regulamentacao_w,			--ie_regulamentacao
				ie_segmentacao_w,			--ie_segmentacao
				ie_tipo_compartilhamento_w,		--ie_tipo_compartilhamento
				ie_tipo_contratacao_w,			--ie_tipo_contratacao
				ie_preco_w,				--ie_tipo_modalidade
				vet_tipo_movimento.ie_tipo_movimento,	--ie_tipo_movimento
				vet_pos_estab.ie_tipo_protocolo,	--ie_tipo_protocolo
				ie_tipo_repasse_w,			--ie_tipo_repasse
				vet_pos_estab.ie_tipo_segurado,		--ie_tipo_segurado
				ie_tipo_vinculo_w,			--ie_tipo_vinculo
				nr_contrato_w,				--nr_contrato
				nr_registro_produto_w,			--nr_registro_produto
				vet_pos_estab.nr_seq_conta,		--nr_seq_conta
				nr_seq_contrato_w,			--nr_seq_contrato
				nr_seq_grupo_ans_w,			--nr_seq_grupo_ans
				nr_seq_material_w,			--nr_seq_material
				nr_seq_pagador_w,			--nr_seq_pagador
				nr_seq_prestador_w,			--nr_seq_prestador
				vet_pos_estab.nr_seq_protocolo, 	--nr_seq_protocolo
				vet_pos_estab.nr_seq_segurado,		--nr_seq_segurado
				vl_movimento_w				--vl_movimento
			);

		end if;
			
		if (mod(nr_contador_w, 1000) = 0) then
			commit;
		end if;	
			end;
			end loop;
		close c_tipo_movimento;
		end;
		end loop;
	close c_pos_estab;

	update	ctb_livro_auxiliar
	set	qt_registros	= nr_contador_w
	where	nr_sequencia	= nr_seq_reg_auxiliar_p;

	commit;

elsif (ie_origem_p = 'D' and ie_gerar_arquivo_p = 'S') then
	begin
	nm_arquivo_w	:= 'RegAuxValoresPosEstab' || to_char(clock_timestamp(),'ddmmyyyyhh24miss') || nm_usuario_p || '.csv';
	ds_nome_livro_w	:= substr(obter_desc_expressao(972957), 1, 255);
 	ds_periodo_w	:= wheb_mensagem_pck.get_texto(1098702,'DT_INICIAL=' || dt_inicial_w || ';' ||'DT_FINAL=' || dt_final_w || ';' || 'DT_LIBERACAO=' || dt_liberacao_w);
	
	SELECT * FROM obter_evento_utl_file(1, null, ds_local_w, ds_erro_w) INTO STRICT ds_local_w, ds_erro_w;

	arq_texto_w := utl_file.fopen(ds_local_w,nm_arquivo_w,'W', 32000);
	
	utl_file.put_line(arq_texto_w, ds_nome_livro_w);
	utl_file.put_line(arq_texto_w, ds_periodo_w);
	utl_file.put_line(arq_texto_w, substr(obter_desc_expressao(973424), 1, 4000));
	utl_file.fflush(arq_texto_w);
	for vetl in c_registros_delphi loop
		begin
		utl_file.put_line(arq_texto_w,vetl.ds_linha);
		utl_file.fflush(arq_texto_w);
		end;
	end loop;
	end;
end if;

CALL wheb_usuario_pck.set_ie_executar_trigger('S');

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_event_pos_estab ( nr_seq_reg_auxiliar_p w_ctb_livro_aux_event_liq.nr_seq_reg_auxiliar%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_origem_p w_ctb_livro_aux_event_liq.ie_ato_cooperado%type, ie_gerar_arquivo_p w_ctb_livro_aux_event_liq.ie_ato_cooperado%type default 'N') FROM PUBLIC;

