-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE proj_gerar_pend_contab_rat ( Dt_Referencia_p timestamp, nm_usuario_p text) AS $body$
DECLARE



nr_sequencia_w		bigint;
nr_seq_rat_w			bigint;
nr_seq_nf_w			bigint;
vl_pagar_w			double precision;
vl_cobrar_w			double precision;
dt_final_w			timestamp;
dt_ref_w			timestamp;
dt_registro_w			timestamp;

nr_ordem_compra_w		bigint;
nr_seq_nf_entrada_w		bigint;
nr_lote_entrada_w		bigint;
nr_lote_saida_w		bigint;
dt_contab_entrada_w		timestamp;
dt_contab_saida_w		timestamp;
ie_pagar_rat_w			varchar(15);

C01 CURSOR FOR
	SELECT	nr_sequencia,
		coalesce(vl_cobrar_cliente,0),
		CASE WHEN ie_paga_rat='S' THEN coalesce(vl_pagar,0)  ELSE 0 END  vl_pagar,
		coalesce(nr_seq_nf,0),
		coalesce(nr_ordem_compra,0),
		ie_paga_rat
	from	proj_RAT
	where	dt_liberacao	<= dt_final_w
	and	dt_liberacao > clock_timestamp() - interval '365 days'
	and	((vl_pagar > 0) or (vl_cobrar_cliente > 0));


BEGIN

dt_final_w			:= last_day(trunc(dt_referencia_p,'dd')) + 86399/86400;
dt_ref_w			:= trunc(dt_referencia_p,'month');

delete from proj_rat_pend
where	dt_referencia		= dt_ref_w;

OPEN C01;
LOOP
FETCH C01 into nr_seq_rat_w,
		vl_cobrar_w,
		vl_pagar_w,
		nr_seq_nf_w,
		nr_ordem_compra_w,
		ie_pagar_rat_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	nr_seq_nf_entrada_w		:= null;
	nr_lote_entrada_w			:= null;
	dt_contab_entrada_w		:= null;
	nr_lote_saida_w			:= null;
	dt_contab_saida_w			:= null;

	if (vl_cobrar_w > 0) then
		select	max(nr_lote_contabil)
		into STRICT	nr_lote_saida_w
		from	nota_fiscal
		where	nr_sequencia	= nr_seq_nf_w;
		select	max(dt_referencia)
		into STRICT	dt_contab_saida_w
		from	lote_contabil b
		where	nr_lote_contabil	= nr_lote_saida_w;
		if (coalesce(dt_contab_saida_w, clock_timestamp() + interval '1000 days') <= dt_final_w) then
			vl_cobrar_w		:= 0;
		end if;
	end if;

	if (ie_pagar_rat_w <> 'S') then
		vl_pagar_w			:= 0;
	end if;
	if (vl_pagar_w > 0) then
		select	min(nr_sequencia)
		into STRICT	nr_seq_nf_entrada_w
		from	nota_fiscal_item
		where	nr_ordem_compra	= nr_ordem_compra_w;
		select	min(nr_lote_contabil)
		into STRICT	nr_lote_entrada_w
		from	nota_fiscal
		where	nr_sequencia		= nr_seq_nf_entrada_w;
		select	max(dt_referencia)
		into STRICT	dt_contab_entrada_w
		from	lote_contabil b
		where	nr_lote_contabil	= nr_lote_entrada_w;
		if (coalesce(dt_contab_entrada_w, clock_timestamp() + interval '1000 days') <= dt_final_w) then
			vl_pagar_w		:= 0;
		end if;
	end if;

	if	((vl_pagar_w > 0) or (vl_cobrar_w > 0)) then
		select	nextval('proj_rat_pend_seq')
		into STRICT	nr_sequencia_w
		;
		insert into proj_rat_pend(
			nr_sequencia,
			nr_seq_rat,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_referencia,
			vl_cobrar,
			vl_pagar,
			nr_ordem_compra,
			nr_seq_nf_entrada,
			nr_lote_entrada,
			dt_contab_entrada,
			nr_seq_nf_saida,
			nr_lote_saida,
			dt_contab_saida)
		values (
			nr_sequencia_w,
			nr_seq_rat_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			dt_ref_w,
			vl_cobrar_w,
			vl_pagar_w,
			nr_ordem_compra_w,
			nr_seq_nf_entrada_w,
			nr_lote_entrada_w,
			dt_contab_entrada_w,
			nr_seq_nf_w,
			nr_lote_saida_w,
			dt_contab_saida_w);
	end if;

END LOOP;
CLOSE C01;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proj_gerar_pend_contab_rat ( Dt_Referencia_p timestamp, nm_usuario_p text) FROM PUBLIC;

