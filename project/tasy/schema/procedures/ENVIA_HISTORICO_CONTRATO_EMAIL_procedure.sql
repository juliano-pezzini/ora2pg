-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE envia_historico_contrato_email ( nr_seq_hist_contrato_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_regra_w			bigint;
ds_email_adicional_w		varchar(2000);
cd_perfil_dispara_w		integer;
ie_momento_envio_w		varchar(1);
ie_usuario_w			varchar(1);
ds_assunto_w			varchar(255);
ds_mensagem_w			varchar(4000);
cd_comprador_padrao_w		varchar(10);
ds_email_origem_w			varchar(255);
nm_usuario_origem_w		varchar(255);
ds_destinatarios_w			varchar(4000);
ds_email_remetente_w		varchar(255);

cd_pessoa_resp_w			varchar(10);
nm_pessoa_resp_w		varchar(255);
nm_usuario_resp_w		varchar(15);
nr_seq_contrato_w		bigint;
dt_historico_w			timestamp;
dt_liberacao_w			timestamp;
ds_titulo_w			varchar(255);
ds_historico_w			varchar(4000);
ds_efetivado_w			varchar(10);
cd_cgc_contratado_w		varchar(14);
cd_pessoa_contratada_w		varchar(10);
ds_tipo_contrato_w		varchar(255);
ds_objeto_contrato_w		varchar(1000);
cd_estabelecimento_w		integer;
nm_contratado_w			varchar(255);


BEGIN 
 
select	coalesce(max(nr_sequencia),0), 
	coalesce(max(ds_email_remetente),'X'), 
	max(replace(ds_email_adicional,',',';')), 
	max(cd_perfil_disparar), 
	coalesce(max(ie_momento_envio),'I') 
into STRICT	nr_seq_regra_w, 
	ds_email_remetente_w, 
	ds_email_adicional_w, 
	cd_perfil_dispara_w, 
	ie_momento_envio_w 
from	regra_envio_email_compra 
where	ie_tipo_mensagem = 71 
and	ie_situacao = 'A' 
and	cd_estabelecimento = cd_estabelecimento_p;
/*and	obter_se_envia_email_regra(0, 'C', ie_tipo_mensagem, cd_estabelecimento) = 'S';*/
 
/*Não existe filtro aplicável ao contrato atualmente*/
 
 
if (nr_seq_regra_w > 0) and 
	((coalesce(cd_perfil_dispara_w::text, '') = '') or 
	(cd_perfil_dispara_w IS NOT NULL AND cd_perfil_dispara_w::text <> '' AND cd_perfil_dispara_w = obter_perfil_ativo)) then 
	begin 
 
	select	nr_seq_contrato, 
		dt_historico, 
		dt_liberacao, 
		ds_titulo, 
		ds_historico,			/*'Sim'*/
				/*'Não'*/ 
		CASE WHEN ie_efetivado='S' THEN wheb_mensagem_pck.get_Texto(313190)  ELSE wheb_mensagem_pck.get_Texto(313191) END  
	into STRICT	nr_seq_contrato_w, 
		dt_historico_w, 
		dt_liberacao_w, 
		ds_titulo_w, 
		ds_historico_w, 
		ds_efetivado_w 
	from	contrato_historico 
	where	nr_sequencia = nr_seq_hist_contrato_p;
 
	select	cd_cgc_contratado, 
		cd_pessoa_contratada, 
		substr(obter_desc_tipo_contrato(nr_seq_tipo_contrato),1,255), 
		ds_objeto_contrato, 
		cd_estabelecimento, 
		cd_pessoa_resp 
	into STRICT	cd_cgc_contratado_w, 
		cd_pessoa_contratada_w, 
		ds_tipo_contrato_w, 
		ds_objeto_contrato_w, 
		cd_estabelecimento_w, 
		cd_pessoa_resp_w 
	from	contrato 
	where	nr_sequencia = nr_seq_contrato_w;
 
	select	coalesce(nm_usuario,'X') 
	into STRICT	nm_usuario_resp_w 
	from	usuario 
	where	cd_pessoa_fisica = cd_pessoa_resp_w;
 
	if (nm_usuario_resp_w <> 'X') then 
		begin 
 
		select	ds_email 
		into STRICT	ds_destinatarios_w 
		from	usuario 
		where	nm_usuario = nm_usuario_resp_w;
 
		end;
	else 
		begin 
 
		select	substr(coalesce(obter_compl_pf(cd_pessoa_resp_w,2,'M'),obter_compl_pf(cd_pessoa_resp_w,1,'M')),1,255) 
		into STRICT	ds_destinatarios_w 
		;
 
		end;
	end if;
 
	select	substr(obter_nome_pf(cd_pessoa_fisica),0,255) 
	into STRICT	nm_pessoa_resp_w 
	from	pessoa_fisica 
	where	cd_pessoa_fisica = cd_pessoa_resp_w;
 
	if (cd_cgc_contratado_w IS NOT NULL AND cd_cgc_contratado_w::text <> '') then 
		begin 
 
		select	ds_razao_social 
		into STRICT	nm_contratado_w 
		from	pessoa_juridica 
		where	cd_cgc = cd_cgc_contratado_w;
 
		end;
	else 
		begin 
 
		select	substr(obter_nome_pf(cd_pessoa_fisica),0,255) 
		into STRICT	nm_contratado_w 
		from	pessoa_fisica 
		where	cd_pessoa_fisica = cd_pessoa_contratada_w;
 
		end;
	end if;
 
	select	ds_assunto, 
		ds_mensagem_padrao 
	into STRICT	ds_assunto_w, 
		ds_mensagem_w 
	from	regra_envio_email_compra 
	where	nr_sequencia = nr_seq_regra_w;
 
	ds_assunto_w	:=	substr( 
				replace_macro( 
				replace_macro( 
				replace_macro( 
				replace_macro( 
				replace_macro( 
				replace_macro( 
				replace_macro( 
				replace_macro( 
				replace_macro(ds_assunto_w, 
					'@nr_contrato',nr_seq_contrato_w), 
					'@ds_titulo',ds_titulo_w), 
					'@dt_historico',to_char(dt_historico_w,'dd/mm/yyyy')), 
					'@dt_liberacao',to_char(dt_liberacao_w,'dd/mm/yyyy')), 
					'@hr_liberacao',to_char(dt_liberacao_w,'hh24:mi')), 
					'@ds_efetivado',ds_efetivado_w), 
					'@nm_contratado',nm_contratado_w), 
					'@nm_responsavel',nm_pessoa_resp_w), 
					'@tipo_contrato',ds_tipo_contrato_w),1,255);
 
	ds_mensagem_w	:=	substr( 
				replace_macro( 
				replace_macro( 
				replace_macro( 
				replace_macro( 
				replace_macro( 
				replace_macro( 
				replace_macro( 
				replace_macro( 
				replace_macro( 
				replace_macro( 
				replace_macro(ds_mensagem_w, 
					'@nr_contrato',nr_seq_contrato_w), 
					'@ds_titulo',ds_titulo_w), 
					'@dt_historico',to_char(dt_historico_w,'dd/mm/yyyy')), 
					'@dt_liberacao',to_char(dt_liberacao_w,'dd/mm/yyyy')), 
					'@hr_liberacao',to_char(dt_liberacao_w,'hh24:mi')), 
					'@ds_efetivado',ds_efetivado_w), 
					'@ds_historico',ds_historico_w), 
					'@nm_contratado',nm_contratado_w), 
					'@tipo_contrato',ds_tipo_contrato_w), 
					'@nm_responsavel',nm_pessoa_resp_w), 
					'@objeto_contrato',ds_objeto_contrato_w),1,4000);
 
	select	coalesce(max(ie_usuario),'U') 
	into STRICT	ie_usuario_w 
	from	regra_envio_email_compra 
	where	nr_sequencia = nr_seq_regra_w;
 
	select	coalesce(cd_comprador_padrao,'0') 
	into STRICT	cd_comprador_padrao_w 
	from	parametro_compras 
	where	cd_estabelecimento = cd_estabelecimento_w;
 
	if (ie_usuario_w = 'U') or 
		(cd_comprador_padrao_w = '0' AND ie_usuario_w = 'O') then 
		begin 
 
		select	ds_email, 
			nm_usuario 
		into STRICT	ds_email_origem_w, 
			nm_usuario_origem_w 
		from	usuario 
		where	nm_usuario = nm_usuario_p;
 
		end;
	elsif (ie_usuario_w = 'O') then 
		begin 
 
		select	max(ds_email), 
			max(nm_guerra) 
		into STRICT	ds_email_origem_w, 
			nm_usuario_origem_w 
		from	comprador 
		where	cd_pessoa_fisica = cd_comprador_padrao_w 
		and	cd_estabelecimento = cd_estabelecimento_p;
 
		end;
	else 
		begin 
 
		select	ds_email 
		into STRICT	ds_email_origem_w 
		from	parametro_compras 
		where	cd_estabelecimento = cd_estabelecimento_p;
 
		select	coalesce(ds_fantasia,ds_razao_social) 
		into STRICT	nm_usuario_origem_w 
		from	estabelecimento_v 
		where	cd_estabelecimento = cd_estabelecimento_p;
 
		end;
	end if;
 
	if (ds_email_remetente_w <> 'X') then 
		ds_email_origem_w	:= ds_email_remetente_w;
	end if;
 
	if (ds_email_adicional_w IS NOT NULL AND ds_email_adicional_w::text <> '') then 
		ds_destinatarios_w :=	ds_destinatarios_w || '; ' || ds_email_adicional_w;
	end if;
 
	if (ie_momento_envio_w = 'A') and (ds_destinatarios_w IS NOT NULL AND ds_destinatarios_w::text <> '') then 
		begin 
 
		CALL sup_grava_envio_email( 
			'C', 
			'71', 
			nr_seq_contrato_w, 
			null, 
			null, 
			ds_destinatarios_w, 
			nm_usuario_origem_w, 
			ds_email_origem_w, 
			ds_assunto_w, 
			ds_mensagem_w, 
			cd_estabelecimento_p, 
			nm_usuario_p);
 
		end;
	elsif (ds_destinatarios_w IS NOT NULL AND ds_destinatarios_w::text <> '') then 
		CALL enviar_email(ds_assunto_w,ds_mensagem_w,ds_email_origem_w,ds_destinatarios_w,nm_usuario_origem_w,'M');
	end if;
 
	end;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE envia_historico_contrato_email ( nr_seq_hist_contrato_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

