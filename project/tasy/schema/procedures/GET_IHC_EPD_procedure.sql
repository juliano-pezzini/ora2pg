-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE get_ihc_epd ( nr_sequencia_p ihc_claim.nr_sequencia%type, nm_usuario_p ihc_claim.nm_usuario%type) AS $body$
DECLARE


ie_acc_status_w				varchar(22);
ie_admission_w				varchar(22);
dt_admission_w				timestamp;
dt_estimated_discharge_w	timestamp;
nr_episode_w				ihc_claim.nr_episode%type;
dt_discharge_w				timestamp;
cd_discharge_intention_w	varchar(22);
cd_discharge_w				varchar(22);
cd_episode_type_w			varchar(22);
cd_classification_w			varchar(22);
ie_referral_source_w		varchar(22);
qt_ant_length_w				ihc_claim.qt_ant_length%type;
qt_length_stay_w			ihc_claim.qt_length_stay%type;
ie_contiguous_w				ihc_claim.ie_contiguous%type;
ie_claim_type_w				ihc_claim.ie_claim_type%type;
cd_same_day_w				ihc_claim.cd_same_day%type := '9';
cd_inter_hospital_w			hcp_assessment_data.cd_inter_hospital%type;
ie_mental_health_w			hcp_assessment_data.cd_mental_health_status%type;
ie_readmission_w			hcp_assessment_data.nr_readmission_days%type;
ie_unplanned_theatre_w		hcp_assessment_data.cd_unplanned_theatre%type;
ie_care_type_w				varchar(22);
cd_estabelecimento_w        conta_paciente.cd_estabelecimento%type;
dt_day_discharge_w			integer;
dt_day_admission_w			integer;
nr_account_w				ihc_claim.nr_account%type;
nr_records_w				ihc_claim.nr_sequencia%type;


BEGIN

select 	max(a.nr_atendimento),
		max(a.cd_estabelecimento),
		max(b.nr_account)
into STRICT	nr_episode_w,
		cd_estabelecimento_w,
		nr_account_w
from 	conta_paciente	a,
		ihc_claim 	b
where 	a.nr_interno_conta	= b.nr_account
and     b.nr_sequencia 		= nr_sequencia_p;

if (coalesce(nr_episode_w::text, '') = '') then
	CALL generate_inco_eclipse(nr_account_w, 1, obter_desc_expressao(504622), nm_usuario_p);
end if;
	
if (nr_episode_w IS NOT NULL AND nr_episode_w::text <> '') and (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') then
	select	a.ie_tipo_atendimento,
			a.cd_procedencia,
			a.dt_entrada,
			a.dt_alta,
			a.cd_motivo_alta,
			a.nr_seq_queixa,
			a.nr_seq_classificacao,
			a.nr_seq_forma_chegada,
			a.ie_tipo_atendimento,
			coalesce(a.qt_dias_prev_inter,1)
	into STRICT	ie_acc_status_w,
			ie_admission_w,
			dt_admission_w,
			dt_discharge_w,
			cd_discharge_intention_w,
			cd_episode_type_w,
			cd_classification_w,
			ie_referral_source_w,
			ie_care_type_w,
			qt_ant_length_w
	from	atendimento_paciente a
	where	nr_atendimento = nr_episode_w;
	
	cd_discharge_w	:= cd_discharge_intention_w;
	
	ie_acc_status_w := get_eclipse_conversion('IE_TIPO_ATENDIMENTO', ie_acc_status_w, 'IHC', null, nr_account_w, ie_acc_status_w);
	ie_admission_w := get_eclipse_conversion('CD_PROCEDENCIA', ie_admission_w, 'IHC', null, nr_account_w, ie_admission_w);
	cd_discharge_intention_w := get_eclipse_conversion('CD_MOTIVO_ALTA', cd_discharge_intention_w, 'IHC', 'N', nr_account_w, cd_discharge_intention_w);
	cd_discharge_w := get_eclipse_conversion('CD_MOTIVO_ALTA', cd_discharge_w, 'IHC', 'AN', nr_account_w, cd_discharge_w);	
	cd_episode_type_w := get_eclipse_conversion('NR_SEQ_QUEIXA', cd_episode_type_w, 'IHC', null, nr_account_w, cd_episode_type_w);
	cd_classification_w := get_eclipse_conversion('NR_SEQ_CLASSIFICACAO', cd_classification_w, 'IHC', null, nr_account_w, cd_classification_w);
	ie_referral_source_w := get_eclipse_conversion('NR_SEQ_FORMA_CHEGADA', ie_referral_source_w, 'IHC', null, nr_account_w, ie_referral_source_w);
		
	select	max(ie_contiguous),
			max(ie_claim_type)
	into STRICT	ie_contiguous_w,
			ie_claim_type_w
	from	ihc_claim
	where	nr_sequencia = nr_sequencia_p;
	
	dt_day_discharge_w	:= pkg_date_utils.extract_field('DAY', coalesce(dt_discharge_w,clock_timestamp()));
	dt_day_admission_w	:= pkg_date_utils.extract_field('DAY', dt_admission_w);
	qt_length_stay_w	:= obter_dias_entre(dt_admission_w, coalesce(dt_discharge_w, clock_timestamp()));
	
	if (ie_contiguous_w in ('N', 'L')) then	
		if (coalesce(dt_discharge_w::text, '') = '') then
			CALL generate_inco_eclipse(nr_account_w, 1, obter_desc_expressao(504622), nm_usuario_p);
		end if;
		
		if (coalesce(cd_discharge_w::text, '') = '') then
			CALL generate_inco_eclipse(nr_account_w, 1, obter_desc_expressao(621285), nm_usuario_p);
		end if;
			
		if (cd_discharge_w IS NOT NULL AND cd_discharge_w::text <> '') and (coalesce(qt_length_stay_w::text, '') = '') then -- Must be set if DischargeTypeCode is set
			CALL generate_inco_eclipse(nr_account_w, 1, obter_desc_expressao(621285), nm_usuario_p);
		end if;
	
	end if;

	if (coalesce(cd_episode_type_w::text, '') = '') then
		CALL generate_inco_eclipse(nr_account_w, 1, obter_desc_expressao(581626), nm_usuario_p);
	end if;
	if (coalesce(cd_classification_w::text, '') = '') then
		CALL generate_inco_eclipse(nr_account_w, 1, obter_desc_expressao(913122), nm_usuario_p);
	end if;
	if (coalesce(ie_referral_source_w::text, '') = '') then
		CALL generate_inco_eclipse(nr_account_w, 1, obter_desc_expressao(639919), nm_usuario_p);
	end if;
	
	select	max(cd_inter_hospital),
			max(cd_mental_health_status),
			max(nr_readmission_days),
			max(cd_unplanned_theatre)
	into STRICT	cd_inter_hospital_w,
			ie_mental_health_w,
			ie_readmission_w,
			ie_unplanned_theatre_w
	from	hcp_assessment_data
	where	nr_atendimento = nr_episode_w;	
	
	if (ie_claim_type_w = 'PR') then		
		if (coalesce(cd_inter_hospital_w::text, '') = '') then
			CALL generate_inco_eclipse(nr_account_w, 1, obter_desc_expressao(1103113, obter_desc_expressao(941602)), nm_usuario_p);
		else
			cd_inter_hospital_w := get_eclipse_conversion('CD_INTER_HOSPITAL', cd_inter_hospital_w, 'IHC', null, nr_account_w, cd_inter_hospital_w);
		end if;
		
		if (coalesce(ie_mental_health_w::text, '') = '') then
			CALL generate_inco_eclipse(nr_account_w, 1, obter_desc_expressao(1103113, obter_desc_expressao(940787)), nm_usuario_p);
		else
			ie_mental_health_w := get_eclipse_conversion('CD_MENTAL_HEALTH_STATUS', ie_mental_health_w, 'IHC', null, nr_account_w, ie_mental_health_w);
		end if;
		
		if (coalesce(ie_readmission_w::text, '') = '') then
			CALL generate_inco_eclipse(nr_account_w, 1, obter_desc_expressao(1103113, obter_desc_expressao(947002)), nm_usuario_p);
		else
			ie_readmission_w := get_eclipse_conversion('NR_READMISSION_DAYS', ie_readmission_w, 'IHC', null, nr_account_w, ie_readmission_w);
		end if;
		
		if (coalesce(ie_unplanned_theatre_w::text, '') = '') then
			CALL generate_inco_eclipse(nr_account_w, 1, obter_desc_expressao(1103113, obter_desc_expressao(947000)), nm_usuario_p);
		else
			ie_unplanned_theatre_w := get_eclipse_conversion('CD_UNPLANNED_THEATRE', ie_unplanned_theatre_w, 'IHC', null, nr_account_w, ie_unplanned_theatre_w);
		end if;
	
	end if;
	
	if (ie_care_type_w = 1) then
	
		if (dt_day_discharge_w > dt_day_admission_w) then
			cd_same_day_w := '0';
		elsif (dt_day_discharge_w = dt_day_admission_w) then
			cd_same_day_w := '1';
		end if;
		
	end if;
	
	update	ihc_claim
	set		ie_acc_status 			= ie_acc_status_w,
			ie_admission 			= ie_admission_w,
			dt_admission 			= dt_admission_w,
			qt_ant_length 			= qt_ant_length_w,
			dt_discharge 			= dt_discharge_w,
			cd_discharge_intention 	= cd_discharge_intention_w,
			cd_discharge			= cd_discharge_w,
			nr_episode				= nr_episode_w,
			cd_episode_type			= cd_episode_type_w,
			ie_facility_contract	= cd_inter_hospital_w,
			qt_length_stay			= CASE WHEN qt_length_stay_w=0 THEN  1  ELSE qt_length_stay_w END ,
			ie_mental_health		= ie_mental_health_w,
			cd_classification		= cd_classification_w,
			ie_readmission			= ie_readmission_w,
			ie_referral_source		= ie_referral_source_w,
			cd_same_day				= cd_same_day_w,
			ie_unplanned_theatre	= ie_unplanned_theatre_w
	where	nr_sequencia 			= nr_sequencia_p;
	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE get_ihc_epd ( nr_sequencia_p ihc_claim.nr_sequencia%type, nm_usuario_p ihc_claim.nm_usuario%type) FROM PUBLIC;

