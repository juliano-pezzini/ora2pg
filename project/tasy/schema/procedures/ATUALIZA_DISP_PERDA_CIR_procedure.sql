-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_disp_perda_cir ( nr_sequencia_p bigint, ie_perda_exclusao_p text) AS $body$
DECLARE


qt_dispensacao_w	double precision;
cd_material_w		integer;
cd_unidade_medida_w	varchar(30);
nr_cirurgia_w		bigint;
nr_seq_lote_fornec_w	bigint;
nr_prescricao_ww	bigint;
qt_material_w		double precision;
nr_sequencia_w		bigint;
nr_prescricao_w		bigint;
qt_dispensacao_ww	double precision;

c01 CURSOR FOR
	SELECT	a.qt_dispensacao,
		a.cd_material,
		a.cd_unidade_medida,
		a.nr_cirurgia,
		coalesce(a.nr_seq_lote_fornec,0),
		b.nr_prescricao
	from	cirurgia_agente_disp a,
		cirurgia b
	where	a.nr_cirurgia 	= b.nr_cirurgia
	and	a.nr_sequencia	= nr_sequencia_p;

c02 CURSOR FOR
	SELECT	coalesce(b.qt_material,0),
		b.nr_sequencia,
		b.nr_prescricao
	from	cirurgia a,
		prescr_material b
	where	a.nr_prescricao 				= b.nr_prescricao
	and	a.nr_cirurgia					= nr_cirurgia_w
	and	b.cd_material					= cd_material_w
	and	coalesce(b.nr_seq_lote_fornec,nr_seq_lote_fornec_w)	= nr_seq_lote_fornec_w
	and	b.cd_unidade_medida				= cd_unidade_medida_w
	and	coalesce(b.cd_motivo_baixa,0)			= 0
	and	b.qt_material					> 0
	order by b.qt_material desc;




BEGIN

if (coalesce(nr_sequencia_p,0) > 0) then
	if (ie_perda_exclusao_p = 'P') then
		open C01;
		loop
		fetch C01 into
			qt_dispensacao_w,
			cd_material_w,
			cd_unidade_medida_w,
			nr_cirurgia_w,
			nr_seq_lote_fornec_w,
			nr_prescricao_ww;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			qt_dispensacao_ww := qt_dispensacao_w;
			open C02;
			loop
			fetch C02 into
				qt_material_w,
				nr_sequencia_w,
				nr_prescricao_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin
				if (qt_dispensacao_ww > 0) then
					if (qt_dispensacao_ww = 1) then
						update	prescr_material
						set	qt_material		= qt_material - 1,
							qt_total_dispensar	= qt_total_dispensar - 1
						where	nr_prescricao		= nr_prescricao_w
						and	nr_sequencia		= nr_sequencia_w
						and	qt_material		> 0;
						qt_dispensacao_ww := 0;
					end if;

					/* Por equanto a dispensação de perda está sendo sempre com quantidade = 1
					elsif	(qt_dispensacao_ww <= qt_material_w) then
						update	prescr_material
						set	qt_material		= qt_material - qt_dispensacao_ww,
							qt_total_dispensar	= qt_total_dispensar - qt_dispensacao_ww
						where	nr_prescricao		= nr_prescricao_w
						and	nr_sequencia		= nr_sequencia_w;
						qt_dispensacao_ww := 0;
					else
						qt_dispensacao_ww := qt_dispensacao_ww - qt_material_w;
						update	prescr_material
						set	qt_material		= 0,
							qt_total_dispensar	= 0
						where	nr_prescricao		= nr_prescricao_w
						and	nr_sequencia		= nr_sequencia_w;
					end if;
					*/
				end if;
				end;
			end loop;
			close C02;
			end;
		end loop;
		close C01;
	elsif (ie_perda_exclusao_p = 'E') then
		open C01;
		loop
		fetch C01 into
			qt_dispensacao_w,
			cd_material_w,
			cd_unidade_medida_w,
			nr_cirurgia_w,
			nr_seq_lote_fornec_w,
			nr_prescricao_ww;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			if (nr_seq_lote_fornec_w > 0) then
				update	prescr_material
				set	qt_material 		= qt_material + qt_dispensacao_w,
					qt_total_dispensar	= qt_material + qt_dispensacao_w
				where	nr_prescricao		= nr_prescricao_ww
				and	cd_material 		= cd_material_w
				and	nr_seq_lote_fornec 	= nr_seq_lote_fornec_w
				and	coalesce(cd_motivo_baixa,0)	= 0
				and	cd_unidade_medida	= cd_unidade_medida_w  LIMIT 1;
			else
				update	prescr_material
				set	qt_material 		= qt_material + qt_dispensacao_w,
					qt_total_dispensar	= qt_material + qt_dispensacao_w
				where	nr_prescricao		= nr_prescricao_ww
				and	cd_material 		= cd_material_w
				and	coalesce(cd_motivo_baixa,0)	= 0
				and	cd_unidade_medida	= cd_unidade_medida_w  LIMIT 1;
			end if;
			end;
		end loop;
		close C01;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_disp_perda_cir ( nr_sequencia_p bigint, ie_perda_exclusao_p text) FROM PUBLIC;

