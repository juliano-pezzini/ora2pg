-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_pls_obter_desc_mensal ( dt_inicio_p timestamp, dt_fim_p timestamp, nm_usuario_p text) AS $body$
DECLARE


nr_seq_segurado_w		bigint;
nr_seq_contrato_w		bigint;
nr_seq_regra_desc_w		bigint;
vl_preco_atual_w		double precision	:= 0;
vl_desconto_atual_w		double precision	:= 0;
vl_desconto_novo_w		double precision	:= 0;
nr_seq_regra_desconto_w		bigint;

C01 CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_contrato
	from	pls_segurado
	where	trunc(coalesce(dt_contratacao,dt_inicio_p)) between trunc(dt_inicio_p) and trunc(dt_fim_p)
	order by nr_sequencia;


BEGIN

/* delete from pls_baca_desc_segurado; */

open C01;
loop
fetch C01 into
	nr_seq_segurado_w,
	nr_seq_contrato_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	begin
	select	coalesce(nr_seq_regra,0),
		coalesce(vl_preco_atual,0),
		coalesce(vl_desconto,0)
	into STRICT	nr_seq_regra_desc_w,
		vl_preco_atual_w,
		vl_desconto_atual_w
	from	pls_segurado_preco
	where 	nr_seq_segurado	= nr_seq_segurado_w
	and	nr_sequencia	= (SELECT max(nr_sequencia) from pls_segurado_preco where nr_seq_segurado = nr_seq_segurado_w);
	exception
		when others then
		nr_seq_regra_desc_w	:= 0;
		vl_preco_atual_w	:= 0;
		vl_desconto_atual_w	:= 0;
	end;

	SELECT * FROM pls_gerar_desconto_benef(nr_seq_segurado_w, nr_seq_contrato_w, nm_usuario_p, vl_preco_atual_w, vl_desconto_novo_w, nr_seq_regra_desconto_w) INTO STRICT vl_desconto_novo_w, nr_seq_regra_desconto_w;

	if (vl_desconto_atual_w <> vl_desconto_novo_w) then
		/*create table pls_baca_desc_segurado(nr_seq_segurado Number(10), nr_seq_contrato Number(10), nr_regra_desc_atual Number(10),
							nr_regra_desc_nova Number(10), vl_desconto_atual Number(15,2), vl_desconto_novo Number(15,2) );*/
		/*
		insert into pls_baca_desc_segurado values (nr_seq_segurado_w, nr_seq_contrato_w, nr_seq_regra_desc_w,
							nr_seq_regra_desconto_w, vl_desconto_atual_w, vl_desconto_novo_w); */
		commit;
	end if;
	end;
end loop;
close C01;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_pls_obter_desc_mensal ( dt_inicio_p timestamp, dt_fim_p timestamp, nm_usuario_p text) FROM PUBLIC;

