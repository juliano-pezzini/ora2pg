-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_comunic_bol_ocorr ( nr_sequencia_p bigint, cd_perfil_dest_p bigint, nm_usuario_p text, ie_responsavel_p text, ie_geral_p text, nm_usuario_destino_p text, ds_lista_ocorrencias_p text, ie_ultimo_historico_p text, ie_comunic_interna_p text, ie_email_p text, ie_resp_resposta_p text, cd_grupo_destino_p text, ie_gera_dt_ocor_pessoa_resp_p text, nr_seq_comunic_p INOUT bigint) AS $body$
DECLARE


nr_sequencia_w			bigint;
ds_titulo_w			varchar(255);
nr_seq_classif_w			bigint;
nm_usuario_resp_w			varchar(15);
cd_perfil_resp_w			integer := null;
ds_usuarios_destino_w		varchar(2000) := '';
ds_perfis_destino_w		varchar(4000) := '';
ds_comunicado_w			text := '';
ds_comunic_compl_w		varchar(4000) := '';
nr_seq_resp_w			bigint;
cd_estabelecimento_w		smallint;
ds_historico_w			text := '';
ds_historico_formatado_w		varchar(4000) := '';
ds_historico_aux_w			varchar(4000) := '';
ie_responsavel_w			varchar(05);
ds_tipo_w			varchar(50);
ds_classificacao_w			varchar(50);
qt_tamanho_fonte_w		integer;
ds_fonte_padrao_w			varchar(255);
pessoa_bol_w			varchar(255);
ds_usuario_email_w			varchar(2000);
ie_pos_virgula_email_w		integer;
ds_email_destino_w			varchar(2000) := '';
ds_email_w			varchar(255);
nm_usuario_ww			varchar(20);
ds_responsavel_w			varchar(40) := '';
ds_mensagem_resp_w		varchar(2000) := '';
nr_seq_rtf_string_w			bigint;
ds_ocorrencia_longa_w 		varchar(32000) := '';
ie_existe_objeto_w			integer := 0;
dt_ocorrencia_w			timestamp;
nm_pf_usuario_envio_w		varchar(255);
nr_seq_envio_w			bigint;
nr_atendimento_w		atendimento_paciente.nr_atendimento%type;
cd_grupo_email_w		varchar(2000) := '';
cd_grupo_usuario_ww		varchar(20);

/*
ie_responsavel_p:
	0 - Geral - "N";
	1 - Responsavel BO - "S";
	2 - Somente selecionados "X"
*/
c01 CURSOR FOR  -- Varios boletins
SELECT	distinct(a.nr_sequencia),
	a.cd_estabelecimento,
	substr(wheb_mensagem_pck.get_texto(305958,'NR_SEQUENCIA_W='||a.nr_sequencia||';DT_OCORRENCIA_W='||a.dt_ocorrencia||
				';IE_ORIGEM_W='||a.ie_origem||';CD_PESSOA_FISICA_W='||substr(obter_nome_pessoa_fisica(a.cd_pessoa_fisica, null),1,150)||
				';NM_PESSOA_REGISTRO_W='||a.nm_pessoa_registro||';DS_CLASSIFICACAO_W='||c.ds_classificacao||';DS_OCORRENCIA_W='||substr(a.ds_ocorrencia,1,3000))|| chr(13),1,4000)
	/*substr('Boletim: ' || a.nr_sequencia || chr(13) || 'Data: ' || a.dt_ocorrencia || chr(13) || 
	'Origem: ' || a.ie_origem || chr(13) || 'Paciente: ' || substr(obter_nome_pessoa_fisica(a.cd_pessoa_fisica, null),1,150) || chr(13) ||
	'Pessoa Registro: ' || a.nm_pessoa_registro || chr(13) || 
	'Classificacao: ' || c.ds_classificacao || chr(13) || 'Ocorrencia: ' || substr(a.ds_ocorrencia,1,3000) || chr(13),1,4000)*/
from	sac_boletim_ocorrencia a,
	sac_resp_bol_ocor b,
	sac_classif_ocorrencia c
where	b.nr_seq_bo			= a.nr_sequencia
and	b.nr_seq_classif			= c.nr_sequencia
and	' ' || ds_lista_ocorrencias_p || ' ' like '% ' || a.nr_sequencia || ' %'
and	(ds_lista_ocorrencias_p IS NOT NULL AND ds_lista_ocorrencias_p::text <> '')
order by a.nr_sequencia;

C04 CURSOR FOR  -- afstringari 174474 30/10/2009 
	SELECT	distinct(a.nr_sequencia),
		a.cd_estabelecimento,
		substr(wheb_mensagem_pck.get_texto(305958,'NR_SEQUENCIA_W='||a.nr_sequencia||';DT_OCORRENCIA_W='||a.dt_ocorrencia||
				';IE_ORIGEM_W='||a.ie_origem||';CD_PESSOA_FISICA_W='||substr(obter_nome_pessoa_fisica(a.cd_pessoa_fisica, null),1,150)||
				';NM_PESSOA_REGISTRO_W='||a.nm_pessoa_registro||';DS_CLASSIFICACAO_W='||c.ds_classificacao||';DS_OCORRENCIA_W='||substr(a.ds_ocorrencia,1,3000))|| chr(13),1,4000)
		/*substr('Boletim: ' || a.nr_sequencia || ' \par ' || 'Data: ' || a.dt_ocorrencia || ' \par ' || 
		'Origem: ' || a.ie_origem || ' \par ' || 'Paciente: ' || substr(obter_nome_pessoa_fisica(a.cd_pessoa_fisica, null),1,150) || ' \par ' ||
		'Pessoa Registro: ' || a.nm_pessoa_registro || ' \par ' || 
		'Classificacao: ' || c.ds_classificacao || ' \par ' || 'Ocorrencia: ' || substr(a.ds_ocorrencia,1,3000) || ' \par ',1,4000)*/
	from	sac_boletim_ocorrencia a,
		sac_resp_bol_ocor b,
		sac_classif_ocorrencia c
	where	b.nr_seq_bo			= a.nr_sequencia
	and     b.nr_seq_classif			= c.nr_sequencia
	and	' ' || ds_lista_ocorrencias_p || ' ' like '% ' || a.nr_sequencia || ' %'
	and	(ds_lista_ocorrencias_p IS NOT NULL AND ds_lista_ocorrencias_p::text <> '')
	order by
		a.nr_sequencia;

c02 CURSOR FOR  -- Usuarios responsaveis
	SELECT	a.nm_usuario_resp
	from	sac_boletim_ocorrencia c,
		sac_resp_bol_ocor b,
		sac_resp_usuario a
	where	a.nr_seq_resp	= b.nr_seq_responsavel
	and	c.nr_sequencia	= b.nr_seq_bo
	and	c.nr_sequencia	= nr_seq_resp_w
	and	coalesce(a.ie_email,'S') = 'S'
	and	exists (SELECT	1
			from	usuario_estabelecimento x
			where	x.nm_usuario_param	= a.nm_usuario_resp
			and	x.cd_estabelecimento	= c.cd_estabelecimento
			
union

			select	1
			from	usuario y
			where	y.nm_usuario		= a.nm_usuario_resp
			and	y.cd_estabelecimento	= c.cd_estabelecimento);

c03 CURSOR FOR  -- Perfis responsaveis
	SELECT	a.cd_perfil_resp
	from	sac_resp_bol_ocor b,
		sac_resp_perfil a
	where	a.nr_seq_resp	= b.nr_seq_responsavel
	and	b.nr_seq_bo	= nr_seq_resp_w;

C05 CURSOR FOR
	SELECT	distinct
		b.ds_responsavel
	from	sac_resp_bol_ocor a,
		sac_responsavel b
	where	a.nr_seq_bo = nr_sequencia_p
	and	a.nr_seq_responsavel = b.nr_sequencia;

C07 CURSOR FOR  --email grupo destino
	SELECT  distinct
		substr(obter_dados_usuario_opcao(nm_usuario_grupo,'E'), 1, 255) ds_email
	from	usuario_grupo
	where   ie_situacao = 'A'
	and	nr_seq_grupo = cd_grupo_usuario_ww;


BEGIN
select obter_estabelecimento_ativo into STRICT cd_estabelecimento_w;
qt_tamanho_fonte_w := obter_param_usuario(87, 3, obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, qt_tamanho_fonte_w);
ds_fonte_padrao_w := obter_param_usuario(87, 15, obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, ds_fonte_padrao_w);

ie_responsavel_w	:= 'X';
if (ie_responsavel_p = '0') then
	ie_responsavel_w	:= 'N';
elsif (ie_responsavel_p = '1') then
	ie_responsavel_w	:= 'S';
end if;

select	obter_classif_comunic('S')
into STRICT	nr_seq_classif_w
;

ds_titulo_w := obter_param_usuario(2000, 6, obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, ds_titulo_w);

select	max(c.ds_classificacao)
into STRICT	ds_classificacao_w
from	sac_classif_ocorrencia c,
	sac_resp_bol_ocor b
where	b.nr_seq_bo	= nr_sequencia_p
and	c.nr_sequencia	= nr_seq_classif;

select	max(c.ds_tipo_ocorrencia)
into STRICT	ds_tipo_w
from	sac_tipo_ocorrencia c,
	sac_resp_bol_ocor b
where	b.nr_seq_bo	= nr_sequencia_p
and	c.nr_sequencia	= b.nr_seq_tipo;

select	max(a.nr_atendimento)
into STRICT	nr_atendimento_w
from	sac_boletim_ocorrencia a
where	a.nr_sequencia = nr_sequencia_p;

select	substr(replace_macro(replace_macro(replace_macro(ds_titulo_w,'@TIPO',ds_tipo_w),'@CLASSIF',ds_classificacao_w),'@ATEND',nr_atendimento_w) || ' ' || nr_sequencia_p,1,255)
into STRICT	ds_titulo_w
;

if (ie_ultimo_historico_p = 'S') then
begin
select	/*substr('Ultimo historico' || chr(13) || c.dt_historico || '  -  ' || c.ds_historico,1,4000),
	substr('Ultimo historico' || chr(13) || c.dt_historico || '  -  ' || c.ds_historico,1,4000)*/
	substr(wheb_mensagem_pck.get_texto(305978,'DT_HISTORICO_W='||c.dt_historico||';DS_HISTORICO_W='||c.ds_historico),1,4000),
	substr(wheb_mensagem_pck.get_texto(305978,'DT_HISTORICO_W='||c.dt_historico||';DS_HISTORICO_W='||c.ds_historico),1,4000)
into STRICT	ds_historico_w,
	ds_historico_formatado_w
from	sac_boletim_ocorrencia a,
	sac_resp_bol_ocor b,
	sac_hist_bol_ocor c
where	c.nr_seq_resp_bo	= b.nr_sequencia
and	b.nr_seq_bo	= a.nr_sequencia
and	a.nr_sequencia	= nr_sequencia_p
and	c.dt_historico	= (	SELECT	max(dt_historico)
				from	sac_hist_bol_ocor x,
					sac_resp_bol_ocor y
				where	x.nr_seq_resp_bo = y.nr_sequencia
				and	y.nr_seq_bo = nr_sequencia_p);
exception
	when others then
	ds_historico_w := '';
end;
end if;

if (coalesce(ds_lista_ocorrencias_p::text, '') = '') then


	if (ie_resp_resposta_p = 'S') then
		open C05;
		loop
		fetch C05 into	
			ds_responsavel_w;
		EXIT WHEN NOT FOUND; /* apply on C05 */
			ds_mensagem_resp_w := substr(ds_mensagem_resp_w || ds_responsavel_w || ',',1,2000);
		end loop;
		close C05;
	end if;

	nr_seq_resp_w	:= nr_sequencia_p;
	
	if (ie_responsavel_w = 'S') then
		open	c02;
		loop
		fetch 	c02 into
			nm_usuario_resp_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			if (nm_usuario_resp_w <> nm_usuario_p) and (coalesce(position(nm_usuario_resp_w in ds_usuarios_destino_w),0) = 0) then
				ds_usuarios_destino_w := substr(ds_usuarios_destino_w || nm_usuario_resp_w || ',',1,2000);
			end if;
		end loop;
		close c02;
	
		open	c03;
		loop
		fetch 	c03 into
			cd_perfil_resp_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
			if (coalesce(position(to_char(cd_perfil_resp_w) in ds_perfis_destino_w),0) = 0) then
				ds_perfis_destino_w := substr(ds_perfis_destino_w || cd_perfil_resp_w || ',',1,4000);
			end if;
		end loop;
		close c03;
	end if;
	
	if (nm_usuario_destino_p IS NOT NULL AND nm_usuario_destino_p::text <> '') then
		ds_usuarios_destino_w	:= substr(ds_usuarios_destino_w || nm_usuario_destino_p,1,2000);
	end if;

	if (cd_perfil_dest_p IS NOT NULL AND cd_perfil_dest_p::text <> '') then
		ds_perfis_destino_w	:= substr(ds_perfis_destino_w || cd_perfil_dest_p,1,2000);
	end if;

	if (ie_gera_dt_ocor_pessoa_resp_p = 'S') then
		begin
		select	ds_ocorrencia,
				substr(substr(--'Cliente : '||nvl((substr(OBTER_NOME_PF_PJ(cd_pessoa_fisica, null),1,150)),(substr(OBTER_NOME_PF_PJ(null,cd_cgc),1,150))) 
				wheb_mensagem_pck.get_texto(306269,'NM_PESSOA_W='||coalesce((substr(OBTER_NOME_PF_PJ(cd_pessoa_fisica, null),1,150)),(substr(OBTER_NOME_PF_PJ(null,cd_cgc),1,150))))|| chr(13) || chr(10) ||
				wheb_mensagem_pck.get_texto(306274,'DT_OCORRENCIA_W='||to_char(dt_ocorrencia,'dd/mm/yyyy hh24:mi:ss')) || chr(13) || chr(10) ||  --'Data ocorrencia: ' || to_char(dt_ocorrencia,'dd/mm/yyyy hh24:mi:ss') || chr(13) || chr(10) ||
				wheb_mensagem_pck.get_texto(306278,'NM_PESSOA_W='||substr(obter_nome_pf(cd_pf_referencia),1,100)) || chr(13) || chr(10) || --'Pessoa ref: ' || substr(obter_nome_pf(cd_pf_referencia),1,100) || chr(13) || chr(10) ||
				wheb_mensagem_pck.get_texto(306279,'CD_SETOR_REFERENCIA_W='||substr(obter_nome_setor(cd_setor_referencia),1,100)) || chr(13) || chr(10) || --'Setor ref: ' || substr(obter_nome_setor(cd_setor_referencia),1,100) || chr(13) || chr(10) ||
				wheb_mensagem_pck.get_texto(306286,'NM_PESSOA_W='||substr(obter_pessoa_fisica_usuario(coalesce(nm_usuario_envio,nm_usuario_p),'N'),1,255)),1,255),1,255) --'Pessoa envio: ' || substr(obter_pessoa_fisica_usuario(nm_usuario_envio,'N'),1,255),1,255),1,255)
		into STRICT	ds_historico_aux_w,
				pessoa_bol_w
		from 	sac_boletim_ocorrencia
		where	nr_sequencia	= nr_sequencia_p;
		end;
	else
		begin
		select	ds_ocorrencia,
				substr(wheb_mensagem_pck.get_texto(306269,'NM_PESSOA_W='||coalesce((substr(OBTER_NOME_PF_PJ(cd_pessoa_fisica, null),1,150)),(substr(OBTER_NOME_PF_PJ(null,cd_cgc),1,150)))),1,255)
		into STRICT	ds_historico_aux_w,
				pessoa_bol_w
		from 	sac_boletim_ocorrencia
		where	nr_sequencia	= nr_sequencia_p;
		end;
	
	end if;

	begin
	nr_seq_rtf_string_w := converte_rtf_string('	select ds_ocorrencia_longa
			from	sac_boletim_ocorrencia
			where	nr_sequencia = :nr_sequencia_p', nr_sequencia_p, nm_usuario_p, nr_seq_rtf_string_w);
	
	select	ds_texto
	into STRICT	ds_ocorrencia_longa_w
	from	tasy_conversao_rtf
	where	nr_sequencia = nr_seq_rtf_string_w;
	exception
	when others then
		ds_ocorrencia_longa_w	:= '';
	end;

	if (ds_ocorrencia_longa_w IS NOT NULL AND ds_ocorrencia_longa_w::text <> '') then
		ds_ocorrencia_longa_w := substr(wheb_mensagem_pck.get_texto(306291,'DS_OCORRENCIA_LONGA_W=') || ds_ocorrencia_longa_w,1,32000); --'Ocorrencia descricao longa:' || chr(13) || chr(10) || ds_ocorrencia_longa_w
	end if;
	
	if (coalesce(qt_tamanho_fonte_w,8) = 8) and (coalesce(ds_fonte_padrao_w,'MS Sans Serif') = 'MS Sans Serif') then
		begin
		if (ie_resp_resposta_p = 'S') then
			ds_historico_w	:= substr(ds_historico_aux_w || chr(13) || chr(10) || ds_historico_w || chr(13) || chr(10) ||
						ds_ocorrencia_longa_w || chr(13) || chr(10) || wheb_mensagem_pck.get_texto(306292,'DS_MENSAGEM_RESP_W='||ds_mensagem_resp_w) || chr(13) || chr(10) ||  --'Responsaveis: ' || ' ' || ds_mensagem_resp_w 
						pessoa_bol_w,1,32000);
		else
			ds_historico_w	:= substr(ds_historico_aux_w || chr(13) || chr(10) || ds_historico_w || chr(13) || chr(10) ||
						ds_ocorrencia_longa_w || chr(13) || chr(10) || pessoa_bol_w,1,32000);
		end if;
		end;
	else
		begin -- afstringari 174474 30/10/2009 
		if (substr(trim(both ds_historico_aux_w),1,1) in ('0','1','2','3','4','5','6','7','8','9')) then
			ds_historico_aux_w := substr('.' || ds_historico_aux_w,1,4000);
		end if;
		if (ie_resp_resposta_p = 'S') then
			ds_historico_w	:= substr(ds_historico_aux_w ||  chr(13) || chr(10) || ds_historico_formatado_w || chr(13) || chr(10) ||
						ds_ocorrencia_longa_w  || chr(13) || wheb_mensagem_pck.get_texto(306292,'DS_MENSAGEM_RESP_W='||ds_mensagem_resp_w) || chr(13) || chr(10) || 
						pessoa_bol_w,1,32000);
		else
			ds_historico_w	:= substr(ds_historico_aux_w || chr(13) || chr(10) || ds_historico_formatado_w || chr(13) || chr(10) ||
						ds_ocorrencia_longa_w  || chr(13) || chr(10) || pessoa_bol_w,1,32000);
		end if;
		end;
	end if;
	if (ie_comunic_interna_p = 'S') then
		
		select	nextval('comunic_interna_seq')
		into STRICT	nr_sequencia_w
		;
		
		insert into comunic_interna(cd_estab_destino,
					dt_comunicado,
					ds_titulo, 
					ds_comunicado, 
					nm_usuario,
					dt_atualizacao, 
					ie_geral, 
					nm_usuario_destino, 
					nr_sequencia, 
					ie_gerencial, 
					cd_perfil,
					ds_perfil_adicional, 
					nr_seq_classif, 
					dt_liberacao,
					ds_grupo)
				SELECT	cd_estabelecimento,
					clock_timestamp() + interval '1 days'/86400, 
					ds_titulo_w, 
					'ds_comunicado', 
					nm_usuario_p,
					clock_timestamp(), 
					ie_geral_p, 
					coalesce(ds_usuarios_destino_w,nm_usuario_p),
					nr_sequencia_w, 
					'N',
					cd_perfil_dest_p,
					CASE WHEN coalesce(cd_perfil_dest_p::text, '') = '' THEN ds_perfis_destino_w  ELSE to_char(cd_perfil_dest_p) || ',' END , 	
					nr_seq_classif_w, 
					clock_timestamp(),
					cd_grupo_destino_p
			from 	sac_boletim_ocorrencia
			where	nr_sequencia	= nr_sequencia_p;
			
			update	comunic_interna
			set	ds_comunicado = ds_historico_w
			where	nr_sequencia = nr_sequencia_w;
		
			select	nextval('sac_bol_ocor_envio_seq')
			into STRICT	nr_seq_envio_w
			;
		
			insert into sac_bol_ocor_envio(
				nr_sequencia,
				dt_envio,
				ds_destino,
				ds_observacao,
				nm_usuario_nrec,
				nm_usuario,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nr_seq_bo) values (
				nr_seq_envio_w,
				clock_timestamp(),
				substr(coalesce(ds_usuarios_destino_w,nm_usuario_p),1,255),
				wheb_mensagem_pck.get_texto(306295), --'Registro de Comunicacao interna',
				nm_usuario_p,
				nm_usuario_p,
				clock_timestamp(),
				clock_timestamp(),
				nr_sequencia_p);
	end if;

	if (ie_email_p = 'S') then
		if (cd_grupo_destino_p IS NOT NULL AND cd_grupo_destino_p::text <> '') then
			ds_email_destino_w 	:= '';
			cd_grupo_email_w	:= cd_grupo_destino_p;
			
			while(coalesce(cd_grupo_email_w,'x') <> 'x') and (trim(both cd_grupo_email_w) <> ',') loop
				select	position(',' in cd_grupo_email_w)
				into STRICT	ie_pos_virgula_email_w
				;
				
				cd_grupo_usuario_ww	:= substr(cd_grupo_email_w,1,ie_pos_virgula_email_w-1);
				
				if (substr(cd_grupo_usuario_ww,1,1) = ' ') then
					cd_grupo_usuario_ww := substr(cd_grupo_usuario_ww,2, length(cd_grupo_usuario_ww));
				end if;
				
				open C07;
				loop
				fetch C07 into	
					ds_email_w;
				EXIT WHEN NOT FOUND; /* apply on C07 */
					begin
					if (coalesce(position(ds_email_w in ds_email_destino_w),0) = 0) then
						ds_email_destino_w := substr(ds_email_destino_w || ds_email_w || ',',1,2000);
					end if;
					end;
				end loop;
				close C07;
				
				cd_grupo_email_w	:= substr(cd_grupo_email_w,ie_pos_virgula_email_w+1,length(cd_grupo_email_w));
			end loop;
			
			CALL enviar_email(ds_titulo_w,ds_historico_w,null,ds_email_destino_w,nm_usuario_p,'M');
		end if;
		if (ds_usuarios_destino_w IS NOT NULL AND ds_usuarios_destino_w::text <> '') then
			ds_email_destino_w 	:= '';
			ds_usuario_email_w	:= ds_usuarios_destino_w;
			
			while(coalesce(ds_usuario_email_w,'x') <> 'x') and (trim(both ds_usuario_email_w) <> ',') loop
				select	position(',' in ds_usuario_email_w)
				into STRICT	ie_pos_virgula_email_w
				;
				
				nm_usuario_ww	:= substr(ds_usuario_email_w,1,ie_pos_virgula_email_w-1);
				
				if (substr(nm_usuario_ww,1,1) = ' ') then
					nm_usuario_ww := substr(nm_usuario_ww,2, length(nm_usuario_ww));
				end if;
				
				select	ds_email
				into STRICT	ds_email_w
				from	usuario
				where	nm_usuario = nm_usuario_ww;
				
				if (coalesce(ds_email_w,'X') <> 'X') then
					ds_email_destino_w := substr(ds_email_destino_w || ds_email_w || ';',1,2000);
				end if;
				
				ds_usuario_email_w := substr(ds_usuario_email_w,ie_pos_virgula_email_w+1,length(ds_usuario_email_w));
			end loop;
			
			CALL enviar_email(ds_titulo_w,ds_historico_w,null,ds_email_destino_w,nm_usuario_p,'M');	
		end if;
	end if;
elsif (ds_lista_ocorrencias_p IS NOT NULL AND ds_lista_ocorrencias_p::text <> '') then

	if (coalesce(qt_tamanho_fonte_w,8) = 8) and (coalesce(ds_fonte_padrao_w,'MS Sans Serif') = 'MS Sans Serif') then
		begin
		open	c01;
		loop
		fetch 	c01 into
			nr_seq_resp_w,
			cd_estabelecimento_w,
			ds_comunic_compl_w;		
		EXIT WHEN NOT FOUND; /* apply on c01 */
				
		if (ie_responsavel_w = 'S') then
			open	c02;
			loop
			fetch 	c02 into
				nm_usuario_resp_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
			if (nm_usuario_resp_w <> nm_usuario_p) and (coalesce(position(nm_usuario_resp_w in ds_usuarios_destino_w),0) = 0) then
				ds_usuarios_destino_w := substr(ds_usuarios_destino_w || nm_usuario_resp_w || ',',1,2000);
			end if;
			end loop;
			close c02;
	
			open	c03;
			loop
			fetch 	c03 into
				cd_perfil_resp_w;
			EXIT WHEN NOT FOUND; /* apply on c03 */
				if (coalesce(position(to_char(cd_perfil_resp_w) in ds_perfis_destino_w),0) = 0) then
					ds_perfis_destino_w := substr(ds_perfis_destino_w || cd_perfil_resp_w || ',',1,4000);
				end if;
			end loop;
			close c03;
		end if;
	
		if (nm_usuario_destino_p IS NOT NULL AND nm_usuario_destino_p::text <> '') then		
			ds_usuarios_destino_w	:= substr(ds_usuarios_destino_w || nm_usuario_destino_p,1,2000);
		end if;
	
		if (cd_perfil_dest_p IS NOT NULL AND cd_perfil_dest_p::text <> '') then
			ds_perfis_destino_w	:= substr(ds_perfis_destino_w || cd_perfil_dest_p,1,4000);
		end if;
		
		ds_comunicado_w	:= ds_comunicado_w || chr(13) || ds_comunic_compl_w;
	
		end loop;
		close c01;	
		end;
	else
		begin -- afstringari 174474 30/10/2009 
		open	c04;
		loop
		fetch 	c04 into
			nr_seq_resp_w,
			cd_estabelecimento_w,
			ds_comunic_compl_w;		
		EXIT WHEN NOT FOUND; /* apply on c04 */
				
		if (ie_responsavel_w = 'S') then
			open	c02;
			loop
			fetch 	c02 into
				nm_usuario_resp_w;
			EXIT WHEN NOT FOUND; /* apply on c02 */
			if (nm_usuario_resp_w <> nm_usuario_p) and (coalesce(position(nm_usuario_resp_w in ds_usuarios_destino_w),0) = 0) then
				ds_usuarios_destino_w := substr(ds_usuarios_destino_w || nm_usuario_resp_w || ',',1,2000);
			end if;
			end loop;
			close c02;
	
			open	c03;
			loop
			fetch 	c03 into
				cd_perfil_resp_w;
			EXIT WHEN NOT FOUND; /* apply on c03 */
				if (coalesce(position(to_char(cd_perfil_resp_w) in ds_perfis_destino_w),0) = 0) then
					ds_perfis_destino_w := substr(ds_perfis_destino_w || cd_perfil_resp_w || ',',1,4000);
				end if;
			end loop;
			close c03;
		end if;
	
		if (nm_usuario_destino_p IS NOT NULL AND nm_usuario_destino_p::text <> '') then		
			ds_usuarios_destino_w	:= substr(ds_usuarios_destino_w || nm_usuario_destino_p,1,2000);
		end if;
	
		if (cd_perfil_dest_p IS NOT NULL AND cd_perfil_dest_p::text <> '') then
			ds_perfis_destino_w	:= substr(ds_perfis_destino_w || cd_perfil_dest_p,1,4000);
		end if;
		
		ds_comunicado_w	:= ds_comunicado_w || ' \par ' || ds_comunic_compl_w;
		ds_comunicado_w := substr('{\rtf1\ansi\deff0{\fonttbl{\f0\fnil\fcharset0 ' ||
							coalesce(ds_fonte_padrao_w,'MS Sans Serif ') || ';}{\f1\fnil ' || 
							coalesce(ds_fonte_padrao_w,'MS Sans Serif ') || ';}}'||
					'{\colortbl ;\red0\green0\blue128;}' ||
					'\viewkind4\uc1\pard\cf1\lang1046\f0\fs' || (coalesce(qt_tamanho_fonte_w,8) * 2) ||
					ds_comunicado_w || '\b0 \par }',1,4000);	
		end loop;
		close c04;	
		end;
	end if;	
	if (ie_comunic_interna_p = 'S') then
		
		select	nextval('comunic_interna_seq')
		into STRICT	nr_sequencia_w
		;
		
		insert into comunic_interna(cd_estab_destino,
						dt_comunicado,
						ds_titulo, 
						ds_comunicado, 
						nm_usuario,
						dt_atualizacao, 
						ie_geral, 
						nm_usuario_destino, 
						nr_sequencia, 
						ie_gerencial, 
						cd_perfil,
						ds_perfil_adicional, 
						nr_seq_classif, 
						dt_liberacao)
		values (cd_estabelecimento_w,
						clock_timestamp() + interval '1 days'/86400,
						wheb_mensagem_pck.get_texto(306296), --'Relatorios SAC',
						ds_comunicado_w,
						nm_usuario_p,
						clock_timestamp(),
						ie_geral_p,
						coalesce(ds_usuarios_destino_w,nm_usuario_p),
						nr_sequencia_w,
						'N',
						cd_perfil_dest_p,
						ds_perfis_destino_w,
						nr_seq_classif_w,
						clock_timestamp());
	end if;
	if (ie_email_p = 'S') then
		if (cd_grupo_destino_p IS NOT NULL AND cd_grupo_destino_p::text <> '') then
			ds_email_destino_w 	:= '';
			cd_grupo_email_w	:= cd_grupo_destino_p;
			
			while(coalesce(cd_grupo_email_w,'x') <> 'x') and (trim(both cd_grupo_email_w) <> ',') loop
				select	position(',' in cd_grupo_email_w)
				into STRICT	ie_pos_virgula_email_w
				;
				
				cd_grupo_usuario_ww	:= substr(cd_grupo_email_w,1,ie_pos_virgula_email_w-1);
				
				if (substr(cd_grupo_usuario_ww,1,1) = ' ') then
					cd_grupo_usuario_ww := substr(cd_grupo_usuario_ww,2, length(cd_grupo_usuario_ww));
				end if;
				
				open C07;
				loop
				fetch C07 into	
					ds_email_w;
				EXIT WHEN NOT FOUND; /* apply on C07 */
					begin
					if (coalesce(position(ds_email_w in ds_email_destino_w),0) = 0) then
						ds_email_destino_w := substr(ds_email_destino_w || ds_email_w || ',',1,2000);
					end if;
					end;
				end loop;
				close C07;
				
				cd_grupo_email_w	:= substr(cd_grupo_email_w,ie_pos_virgula_email_w+1,length(cd_grupo_email_w));
			end loop;
			
			CALL enviar_email(ds_titulo_w,ds_historico_w,null,ds_email_destino_w,nm_usuario_p,'M');
		end if;
		if (ds_usuarios_destino_w IS NOT NULL AND ds_usuarios_destino_w::text <> '') then
			ds_email_destino_w 	:= '';
			ds_usuario_email_w	:= ds_usuarios_destino_w;
			
			while(coalesce(ds_usuario_email_w,'x') <> 'x') and (trim(both ds_usuario_email_w) <> ',') loop
				select	position(',' in ds_usuario_email_w)
				into STRICT	ie_pos_virgula_email_w
				;
				
				nm_usuario_ww	:= substr(ds_usuario_email_w,1,ie_pos_virgula_email_w-1);
				
				if (substr(nm_usuario_ww,1,1) = ' ') then
					nm_usuario_ww := substr(nm_usuario_ww,2, length(nm_usuario_ww));
				end if;
				
				select	ds_email
				into STRICT	ds_email_w
				from	usuario
				where	nm_usuario = nm_usuario_ww;
				
				if (coalesce(ds_email_w,'X') <> 'X') then
					ds_email_destino_w := substr(ds_email_destino_w || ds_email_w || ';',1,2000);
				end if;
				
				ds_usuario_email_w := substr(ds_usuario_email_w,ie_pos_virgula_email_w+1,length(ds_usuario_email_w));
			end loop;
			
			CALL enviar_email(ds_titulo_w,ds_historico_w,null,ds_email_destino_w,nm_usuario_p,'M');	
		end if;
	end if;
end if;

nr_seq_comunic_p := nr_sequencia_w;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_comunic_bol_ocorr ( nr_sequencia_p bigint, cd_perfil_dest_p bigint, nm_usuario_p text, ie_responsavel_p text, ie_geral_p text, nm_usuario_destino_p text, ds_lista_ocorrencias_p text, ie_ultimo_historico_p text, ie_comunic_interna_p text, ie_email_p text, ie_resp_resposta_p text, cd_grupo_destino_p text, ie_gera_dt_ocor_pessoa_resp_p text, nr_seq_comunic_p INOUT bigint) FROM PUBLIC;

