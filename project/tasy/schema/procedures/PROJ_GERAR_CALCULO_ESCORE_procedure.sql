-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE proj_gerar_calculo_escore ( nr_seq_escore_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_sequencia_w			bigint;
nr_seq_item_w			bigint;
ie_regra_definicao_w		varchar(15);
nr_seq_proj_w			bigint;
qt_escore_w			bigint;
ie_escore_w			varchar(1);
nr_seq_gerencia_w		bigint;
nr_seq_area_w			bigint;
pr_escore_w			double precision;
qt_escore_area_w		bigint;
qt_escore_total_w		double precision;

 
C01 CURSOR FOR 
	SELECT	nr_sequencia, 
		nr_seq_item, 
		qt_escore 
	from	proj_escore_item 
	where	nr_seq_escore	= nr_seq_escore_p;
	
C02 CURSOR FOR 
	SELECT 	nr_seq_area, 
		round((sum(coalesce(qt_escore_real,0)) * 100 / sum(coalesce(qt_escore,0)))::numeric,2) 
	from	proj_escore_item 
	where 	nr_seq_escore = nr_seq_escore_p 
	group by nr_seq_area;


BEGIN 
 
select	coalesce(max(nr_seq_proj),0), 
	coalesce(max(nr_seq_gerencia),0) 
into STRICT	nr_seq_proj_w,  
	nr_seq_gerencia_w	 
from	proj_escore 
where	nr_sequencia	= nr_seq_escore_p;
 
select	coalesce(max(ie_escore),'S') 
into STRICT	ie_escore_w	 
from	proj_projeto 
where	nr_sequencia	= nr_seq_proj_w;
 
if (ie_escore_w = 'N') then 
	CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(280286);
end if;
 
open C01;
loop 
fetch C01 into 
	nr_sequencia_w, 
	nr_seq_item_w, 
	qt_escore_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	/* Leitura do domínio 2551 */
 
	select	coalesce(max(ie_regra_definicao),0) 
	into STRICT	ie_regra_definicao_w 
	from	proj_item_escore 
	where	nr_sequencia	= nr_seq_item_w;
 
	if (ie_regra_definicao_w	= 1) then 
		CALL proj_gerar_escore_consultor(nr_sequencia_w, nr_seq_proj_w, qt_escore_w, nm_usuario_p); /* Média das avaliações dos consultores do projeto */
	elsif (ie_regra_definicao_w	= 2) then 
		CALL proj_gerar_escore_cliente(nr_sequencia_w, nr_seq_proj_w, qt_escore_w, nm_usuario_p); /* Avaliações através de perguntas ao cliente */
	elsif (ie_regra_definicao_w	= 3) then 
		proj_gerar_escore_riscos(nr_sequencia_w, nr_seq_proj_w, qt_escore_w, nm_usuario_p); /* Análise da resolutividade dos riscos */
	elsif (ie_regra_definicao_w	= 4) then 
		CALL proj_gerar_escore_tempo(nr_sequencia_w, nr_seq_proj_w, qt_escore_w, nm_usuario_p); /* Avaliação do cronograma (estouro do tempo em horas) */
	elsif (ie_regra_definicao_w	= 5) then 
		CALL proj_gerar_escore_prazo(nr_sequencia_w, nr_seq_proj_w, qt_escore_w, nm_usuario_p); /* Avaliação do cronograma (estouro do prazo) */
	elsif (ie_regra_definicao_w	= 6) then 
		CALL proj_gerar_escore_OS_Encerrada(nr_sequencia_w, nr_seq_proj_w, qt_escore_w, nm_usuario_p); /* OS Encerradas automaticamente sem ação do cliente */
	elsif (ie_regra_definicao_w	= 7) then 
		CALL proj_gerar_escore_OS_Atrasada(nr_sequencia_w, nr_seq_proj_w, qt_escore_w, nm_usuario_p); /* OS com data de conclusão maior que a desejada */
	elsif (ie_regra_definicao_w	= 8) then /* Número de OS's executadas */
 
		CALL proj_gerar_escore_OS_Desenv(nr_seq_gerencia_w, ie_regra_definicao_w, nr_sequencia_w, trunc(clock_timestamp(), 'month'), qt_escore_w, nm_usuario_p);
	elsif (ie_regra_definicao_w	= 9) then /* Número de OS's em cliente teste em relação ao número de horas */
 
		ie_regra_definicao_w	:= 9;
	elsif (ie_regra_definicao_w	= 10) then /* Número de OS's com tempo maior que o definido para grupo */
 
		CALL proj_gerar_escore_OS_Desenv(nr_seq_gerencia_w, ie_regra_definicao_w, nr_sequencia_w, trunc(clock_timestamp(), 'month'), qt_escore_w, nm_usuario_p);
	elsif (ie_regra_definicao_w	= 11) then /* Número de OS's duplas */
 
		CALL proj_gerar_escore_OS_Desenv(nr_seq_gerencia_w, ie_regra_definicao_w, nr_sequencia_w, trunc(clock_timestamp(), 'month'), qt_escore_w, nm_usuario_p);
	elsif (ie_regra_definicao_w	= 12) then /* Número de OS's de erro no mês */
 
		CALL proj_gerar_escore_OS_Desenv(nr_seq_gerencia_w, ie_regra_definicao_w, nr_sequencia_w, trunc(clock_timestamp(), 'month'), qt_escore_w, nm_usuario_p);
	elsif (ie_regra_definicao_w	= 13) then /* Número de OS's com data de acordo ultrapassado */
 
		CALL proj_gerar_escore_OS_Desenv(nr_seq_gerencia_w, ie_regra_definicao_w, nr_sequencia_w, trunc(clock_timestamp(), 'month'), qt_escore_w, nm_usuario_p);
	elsif (ie_regra_definicao_w	= 14) then /* Número de OS's com tempo de SLA ultrapassado */
 
		CALL proj_gerar_escore_OS_Desenv(nr_seq_gerencia_w, ie_regra_definicao_w, nr_sequencia_w, trunc(clock_timestamp(), 'month'), qt_escore_w, nm_usuario_p);
	elsif (ie_regra_definicao_w	= 15) then /* Número de ordens atendidas fora do prazo definido pelo cliente */
 
		ie_regra_definicao_w	:= 15;
	elsif (ie_regra_definicao_w	= 16) then /* Meta mensal atingida */
 
		CALL proj_gerar_escore_OS_Desenv(nr_seq_gerencia_w, ie_regra_definicao_w, nr_sequencia_w, trunc(clock_timestamp(), 'month'), qt_escore_w, nm_usuario_p);		
	elsif (ie_regra_definicao_w	= 17) then /* Nota do NET */
 
		CALL proj_gerar_escore_OS_Desenv(nr_seq_gerencia_w, ie_regra_definicao_w, nr_sequencia_w, trunc(clock_timestamp(), 'month'), qt_escore_w, nm_usuario_p);				
	elsif (ie_regra_definicao_w	= 18) then /* Grau de satisfação */
 
		CALL proj_gerar_escore_OS_Desenv(nr_seq_gerencia_w, ie_regra_definicao_w, nr_sequencia_w, trunc(clock_timestamp(), 'month'), qt_escore_w, nm_usuario_p);				
 
		 
	elsif (ie_regra_definicao_w	= 19) then /* Horas extras ultrapassadas */
 
		CALL proj_gerar_escore_OS_Desenv(nr_seq_gerencia_w, ie_regra_definicao_w, nr_sequencia_w, trunc(clock_timestamp(), 'month'), qt_escore_w, nm_usuario_p);				
 
	elsif (ie_regra_definicao_w	= 21) then 
		CALL proj_gerar_escore_prazo(nr_sequencia_w, nr_seq_proj_w, qt_escore_w, nm_usuario_p); /* Avaliação do cronograma (estouro do prazo) */
	elsif (ie_regra_definicao_w	= 20) then 
		CALL des_proj_gerar_escore_tempo(nr_sequencia_w, nr_seq_proj_w, qt_escore_w, nm_usuario_p); /* Avaliação do cronograma (estouro do tempo em horas) */
	elsif (ie_regra_definicao_w	= 23) then 
		CALL proj_gerar_escore_OS_entregue(nr_seq_proj_w, nm_usuario_p, qt_escore_w, nr_sequencia_w); /* Entrega de OS's */
	elsif (ie_regra_definicao_w	= 24) then 
		CALL proj_gerar_score_qual_os(nr_seq_proj_w, nr_sequencia_w, nm_usuario_p); /*Qualidade de entrega das OS's*/
	elsif (ie_regra_definicao_w	= 25) then 
		CALL proj_gerar_score_consult_con(nr_seq_proj_w, nr_sequencia_w, nm_usuario_p); /* Percentual de conhecimento dos recursos */
	elsif (ie_regra_definicao_w	= 26) then /* Número de OS's com data de acordo ultrapassado */
 
		CALL proj_gerar_escore_OS_Desenv(nr_seq_gerencia_w, ie_regra_definicao_w, nr_sequencia_w, trunc(clock_timestamp(), 'month'), qt_escore_w, nm_usuario_p);
	end if;
	end;
end loop;
close C01;
 
 
qt_escore_total_w := 0;
 
open C02;
loop 
fetch C02 into	 
	nr_seq_area_w, 
	pr_escore_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin 
	select 	max(qt_escore) 
	into STRICT	qt_escore_area_w 
	from	PROJ_AREA_ESCORE 
	where	nr_sequencia = nr_seq_area_w;
	 
	qt_escore_total_w := qt_escore_total_w + round(((pr_escore_w * qt_escore_area_w) / 100),2);	
	 
	end;
end loop;
close C02;
 
qt_escore_w := round((qt_escore_total_w)::numeric,0);
 
 
update	proj_escore 
set 	qt_escore	= qt_escore_w 
where	nr_sequencia	= nr_seq_escore_p;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE proj_gerar_calculo_escore ( nr_seq_escore_p bigint, nm_usuario_p text) FROM PUBLIC;

