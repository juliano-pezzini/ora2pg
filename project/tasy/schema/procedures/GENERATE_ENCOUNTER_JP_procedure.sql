-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE generate_encounter_jp ( cd_person_p pessoa_titular_convenio.cd_pessoa_fisica%type, si_encounter_type_p atendimento_paciente.ie_tipo_atendimento%type, cd_origin_p atendimento_paciente.cd_procedencia%type, cd_physician_resp_p atendimento_paciente.cd_medico_resp%type, cd_establishment_p atendimento_paciente.cd_estabelecimento%type, nm_user_p atend_categoria_convenio.nm_usuario%type, cd_insurance_p pessoa_titular_convenio.cd_convenio%type, cd_care_department_p atend_paciente_unidade.cd_setor_atendimento%type, nr_seq_schedule_p agenda_consulta.cd_agenda%type, ds_schedule_list_p text default null) AS $body$
DECLARE

			
nr_encounter_w			atendimento_paciente.nr_atendimento%type;
nr_seq_interno_w  		atend_categoria_convenio.nr_atendimento%type;
cd_pessoa_atendimento_w pessoa_titular_convenio.cd_pessoa_fisica%type;
cd_convenio_w  			pessoa_titular_convenio.cd_convenio%type;
cd_categoria_w			pessoa_titular_convenio.cd_categoria%type;
dt_validade_carteira_w	pessoa_titular_convenio.dt_validade_carteira%type;
cd_usuario_convenio_w	pessoa_titular_convenio.cd_usuario_convenio%type;
nr_doc_convenio_w		agenda_consulta.nr_doc_convenio%type;
cd_setor_atendimento_w 	atend_paciente_unidade.cd_setor_atendimento%type;
nr_seq_agenda_w			agenda_consulta.cd_agenda%type;
ie_tipo_atendimento_w   atendimento_paciente.ie_tipo_atendimento%type;
			

BEGIN

	cd_setor_atendimento_w := cd_care_department_p;
	nr_seq_agenda_w := nr_seq_schedule_p;
    ie_tipo_atendimento_w := si_encounter_type_p;
	
	if (cd_person_p IS NOT NULL AND cd_person_p::text <> '') then
		
			select	nextval('atendimento_paciente_seq')
			into STRICT	nr_encounter_w
			;
				
            if ( coalesce(ie_tipo_atendimento_w::text, '') = '' ) then
                ie_tipo_atendimento_w := 8; -- 8 - Ambulatorial  
            end if;

			if (coalesce(cd_origin_p::text, '') = '') then
				CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(1129037);
			end if;
			
			insert into atendimento_paciente(
								nr_atendimento,
								cd_pessoa_fisica,
								cd_estabelecimento,
								cd_procedencia,
								dt_entrada,
								ie_tipo_atendimento,
								dt_atualizacao,
								nm_usuario,
								nm_usuario_atend,
								cd_medico_resp,
								ie_permite_visita)
							values (
								nr_encounter_w,
								cd_person_p,
								coalesce(cd_establishment_p, wheb_usuario_pck.get_cd_estabelecimento),
								cd_origin_p,
								clock_timestamp(),
								ie_tipo_atendimento_w,
								clock_timestamp(),
								nm_user_p,
								nm_user_p,
								cd_physician_resp_p,
								'N');

      if (obter_param_funcao_html5(281, 1614) = 'N') then
        CALL VINCULAR_NR_ATENDIMENTO_CP(nr_encounter_w,cd_person_p);
      END IF;
				
	end if;
	
	if (coalesce(cd_insurance_p, 0) = 0) then

		select max(ptc.cd_convenio),
			max(ptc.cd_categoria),
			max(ptc.dt_validade_carteira),
			max(ptc.cd_usuario_convenio),
			max(null)
		into STRICT cd_convenio_w,
			cd_categoria_w,
			dt_validade_carteira_w,
			cd_usuario_convenio_w,
			nr_doc_convenio_w
		from pessoa_titular_convenio ptc
		where ptc.cd_pessoa_fisica = cd_pessoa_atendimento_w
        and	clock_timestamp() between coalesce(DT_INICIO_VIGENCIA,clock_timestamp()) and coalesce(DT_FIM_VIGENCIA,clock_timestamp());
	
    else
	
		Select 	max(a.cd_convenio),
			max(a.cd_categoria),
			max(a.dt_validade_carteira),
			max(a.cd_usuario_convenio),
			max(a.nr_doc_convenio)
		into STRICT cd_convenio_w,
			cd_categoria_w,
			dt_validade_carteira_w,
			cd_usuario_convenio_w,
			nr_doc_convenio_w
		from agenda_consulta a
		where nr_sequencia in (SELECT w.nr_registro from table(lista_pck.obter_lista(ds_schedule_list_p)) w);
		
	end if;
	
	if (coalesce(cd_convenio_w::text, '') = '' or coalesce(cd_categoria_w::text, '') = '' or coalesce(nr_encounter_w::text, '') = '') then
		CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(1126916);
	else
		select	nextval('atend_categoria_convenio_seq')
		into STRICT	nr_seq_interno_w
		;

		insert into ATEND_CATEGORIA_CONVENIO(NR_SEQ_INTERNO,
			NR_ATENDIMENTO,
			CD_CONVENIO,
			CD_CATEGORIA,
			DT_INICIO_VIGENCIA,
			DT_ATUALIZACAO,
			CD_USUARIO_CONVENIO,
			NM_USUARIO,
			NR_DOC_CONVENIO,
			DT_VALIDADE_CARTEIRA
		) values (nr_seq_interno_w,
			nr_encounter_w,
			cd_convenio_w,
			cd_categoria_w,
			clock_timestamp(),
			clock_timestamp(),
			cd_usuario_convenio_w,
			nm_user_p,
			nr_doc_convenio_w,
			dt_validade_carteira_w
		);
	end if;

	if (coalesce(cd_setor_atendimento_w, 0) = 0) then
	
        if (coalesce(nr_seq_agenda_w::text, '') = '') then

            select	cd_agenda
            into STRICT	nr_seq_agenda_w
            from	agenda_consulta
            where	cd_pessoa_fisica = cd_pessoa_atendimento_w
            and nr_atendimento = nr_encounter_w;
        end if;

    
		select	coalesce(a.cd_setor_agenda, cd_setor_exclusivo)
		into STRICT	cd_setor_atendimento_w
		from	agenda a
		where	cd_agenda = nr_seq_agenda_w;

	end if;
 		
	if (coalesce(cd_setor_atendimento_w::text, '') = '') then
		CALL wheb_mensagem_pck.Exibir_Mensagem_Abort(1126942);
	else 	
		CALL gerar_passagem_setor_atend(nr_encounter_w, cd_setor_atendimento_w,  clock_timestamp(), 'N', nm_user_p);
	end if;	
    
    update 	agenda_consulta a
    set    	a.nr_atendimento = nr_encounter_w
    where 	nr_sequencia in (SELECT w.nr_registro from table(lista_pck.obter_lista(ds_schedule_list_p)) w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE generate_encounter_jp ( cd_person_p pessoa_titular_convenio.cd_pessoa_fisica%type, si_encounter_type_p atendimento_paciente.ie_tipo_atendimento%type, cd_origin_p atendimento_paciente.cd_procedencia%type, cd_physician_resp_p atendimento_paciente.cd_medico_resp%type, cd_establishment_p atendimento_paciente.cd_estabelecimento%type, nm_user_p atend_categoria_convenio.nm_usuario%type, cd_insurance_p pessoa_titular_convenio.cd_convenio%type, cd_care_department_p atend_paciente_unidade.cd_setor_atendimento%type, nr_seq_schedule_p agenda_consulta.cd_agenda%type, ds_schedule_list_p text default null) FROM PUBLIC;

