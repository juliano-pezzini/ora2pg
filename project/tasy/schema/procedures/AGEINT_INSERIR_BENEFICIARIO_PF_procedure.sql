-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ageint_inserir_beneficiario_pf (NM_CONTATO_P text, IE_TIPO_COMPLEMENTO_P text, NR_CPF_P text, DT_NASCIMENTO_P text, NM_USUARIO_P text, IE_SEXO_P text, NM_PESSOA_FISICA_P text, CD_USUARIO_CONVENIO_P text, CD_ESTABELECIMENTO_P bigint, CD_USUARIO_CONVENIO_TIT_P text, NR_TELEFONE_CELULAR_P text, NR_DDD_CELULAR_P text) AS $body$
DECLARE

			
CD_PESSOA_FISICA_W PESSOA_FISICA.CD_PESSOA_FISICA%TYPE;
CD_CONVENIO_W PARAMETRO_AGENDA_INTEGRADA.CD_CONV_OPERADORA%TYPE;
NR_SEQUENCIA_W	COMPL_PESSOA_FISICA.NR_SEQUENCIA%TYPE;

DT_ATUALIZACAO_W timestamp := clock_timestamp();
			

BEGIN 
	
SELECT	MAX(CD_CONV_OPERADORA)
INTO STRICT	CD_CONVENIO_W
FROM	PARAMETRO_AGENDA_INTEGRADA
WHERE	coalesce(CD_ESTABELECIMENTO, CD_ESTABELECIMENTO_P) = CD_ESTABELECIMENTO_P;
	
IF (CD_CONVENIO_W IS NOT NULL AND CD_CONVENIO_W::text <> '') THEN
	SELECT	MAX(CD_PESSOA_FISICA)
	INTO STRICT    CD_PESSOA_FISICA_W
	FROM	PESSOA_FISICA PF
	WHERE	NR_CPF = NR_CPF_P
	OR EXISTS (SELECT 1
					 FROM PESSOA_TITULAR_CONVENIO PFC
					WHERE PFC.CD_PESSOA_FISICA = PF.CD_PESSOA_FISICA
					  AND  PFC.CD_USUARIO_CONVENIO = CD_USUARIO_CONVENIO_P  LIMIT 1);

	IF (coalesce(CD_PESSOA_FISICA_W::text, '') = '') THEN
	
		SELECT  nextval('pessoa_fisica_seq')
		INTO STRICT    CD_PESSOA_FISICA_W
		FROM	PESSOA_FISICA LIMIT 1;

		INSERT INTO PESSOA_FISICA(CD_PESSOA_FISICA,
								   NR_CPF,
								   DT_NASCIMENTO,
								   IE_SEXO,
								   NM_USUARIO,
								   NM_PESSOA_FISICA,
								   DT_ATUALIZACAO,
								   DT_ATUALIZACAO_NREC,
								   NM_USUARIO_NREC,
								   IE_TIPO_PESSOA,
								   NR_TELEFONE_CELULAR,
								   NR_DDD_CELULAR)		
						   VALUES (CD_PESSOA_FISICA_W,
								   NR_CPF_P,
								   TO_DATE(DT_NASCIMENTO_P, 'YYYY-MM-DD HH24:MI:SS'),
								   IE_SEXO_P,
								   NM_USUARIO_P,
								   NM_PESSOA_FISICA_P,
								   DT_ATUALIZACAO_W,
								   DT_ATUALIZACAO_W,
								   NM_USUARIO_P,
								   1,
								   NR_TELEFONE_CELULAR_P,
								   NR_DDD_CELULAR_P);
								
		COMMIT;

		IF (CD_USUARIO_CONVENIO_P IS NOT NULL AND CD_USUARIO_CONVENIO_P::text <> '') THEN
			INSERT INTO PESSOA_TITULAR_CONVENIO(NR_SEQUENCIA,
												 DT_ATUALIZACAO,
												 NM_USUARIO,
												 DT_ATUALIZACAO_NREC,
												 NM_USUARIO_NREC,
												 CD_PESSOA_FISICA,
												 CD_CONVENIO,
												 CD_USUARIO_CONVENIO,
												 CD_USUARIO_CONVENIO_TIT) 
									     VALUES (nextval('pessoa_titular_convenio_seq'),
												 DT_ATUALIZACAO_W,
												 NM_USUARIO_P,
												 DT_ATUALIZACAO_W,
												 NM_USUARIO_P,
												 CD_PESSOA_FISICA_W,
												 CD_CONVENIO_W,
												 CD_USUARIO_CONVENIO_P,
												 CD_USUARIO_CONVENIO_TIT_P);
		END IF;
		
		IF (NM_CONTATO_P IS NOT NULL AND NM_CONTATO_P::text <> '') THEN
		
			SELECT	coalesce(MAX(NR_SEQUENCIA),0) + 1
			INTO STRICT	NR_SEQUENCIA_W
			FROM	COMPL_PESSOA_FISICA
			WHERE	CD_PESSOA_FISICA = CD_PESSOA_FISICA_W;
			
			INSERT INTO COMPL_PESSOA_FISICA(NR_SEQUENCIA,
											 CD_PESSOA_FISICA,
											 IE_TIPO_COMPLEMENTO,
											 NM_CONTATO,
											 NM_USUARIO,
											 NM_USUARIO_NREC,
											 DT_ATUALIZACAO,
											 DT_ATUALIZACAO_NREC)							   		
									VALUES (NR_SEQUENCIA_W,
											 CD_PESSOA_FISICA_W,
											 1,
											 NM_CONTATO_P,
											 NM_USUARIO_P,
											 NM_USUARIO_P,
											 DT_ATUALIZACAO_W,
											 DT_ATUALIZACAO_W);
			END IF;
		COMMIT;
	END IF;	               		 	
END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageint_inserir_beneficiario_pf (NM_CONTATO_P text, IE_TIPO_COMPLEMENTO_P text, NR_CPF_P text, DT_NASCIMENTO_P text, NM_USUARIO_P text, IE_SEXO_P text, NM_PESSOA_FISICA_P text, CD_USUARIO_CONVENIO_P text, CD_ESTABELECIMENTO_P bigint, CD_USUARIO_CONVENIO_TIT_P text, NR_TELEFONE_CELULAR_P text, NR_DDD_CELULAR_P text) FROM PUBLIC;

