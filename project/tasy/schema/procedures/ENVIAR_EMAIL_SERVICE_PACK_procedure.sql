-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_email_service_pack (cd_versao_p text, cd_build_p bigint,destinatarios_p text, ds_hotfix_p text default null) AS $body$
DECLARE

is_hotfix_w bigint;
ds_subject_w varchar(255);
ds_body_mail_w varchar(32767);
cd_build_w varchar(20);
cd_customer_cnpj_w varchar(250);
ie_classificacao_w varchar(1);
new_line_w varchar(2) := chr(13) || chr(10);
cd_negative_build_w bigint := null;
cd_prior_negative_build_w bigint := null;
ds_localizacao_w man_localizacao.ds_localizacao%TYPE;
ds_classificacao_w varchar(1);
cd_nr_seq_regra varchar(10);
nr_pacote_w varchar(10);
ds_hotfix_w varchar(30);
destinatarios_w varchar(400) := 'Johnny.Fusinato@philips.com, LucasSandroRotermel.Franco@philips.com, Andrew.Mikos@philips.com, juan.almeida@philips.com, rafael.correa@philips.com';


c_cursor REFCURSOR;
empRecReleaseNote varchar(1000);
empRecReleaseOS varchar(25);
empRecReleaseCustomer varchar(25);
empRecReleaseCNPJ varchar(30);

sql_string varchar(32767);
sql_where_build_string varchar(32767);


BEGIN
$if dbms_db_version.version > 10 $then
  cd_build_w := LPAD(cd_build_p,2,'0');
  cd_build_w      := CD_BUILD_W||' - v.'||cd_versao_p;

  begin
    select ie_classificacao, nr_pacote
    into STRICT ie_classificacao_w, nr_pacote_w
    from man_service_pack_versao
    where cd_versao = cd_versao_p
      and coalesce(ds_hotfix, '0') = coalesce(ds_hotfix_p, '0')
      and nr_service_pack = cd_build_p
      and (ie_classificacao IS NOT NULL AND ie_classificacao::text <> '');
    exception
    when no_data_found then
    begin
      ie_classificacao_w := 'S';
    end;
  end;

  if (destinatarios_p IS NOT NULL AND destinatarios_p::text <> '') then
    destinatarios_w := destinatarios_p || ', ' || destinatarios_w;
  end if;

  case ie_classificacao_w
    when 'D' then ds_subject_w := ' - ' || Expressao_Pck.Obter_Desc_Expressao(308397);
    when 'S' then ds_subject_w := ' - ' || Expressao_Pck.Obter_Desc_Expressao(327907);
    when 'I' then ds_subject_w := ' - ' || Expressao_Pck.Obter_Desc_Expressao(492381);
    else ds_subject_w := '';
  end case;

   begin
        if (cd_build_p - 1 < 0) then
            select nr_old_build
              into STRICT cd_negative_build_w 
              from man_service_pack_versao
            where cd_versao = cd_versao_p 
              and nr_service_pack = cd_build_p 
              and ie_status_build = 'L'
              and coalesce(ds_hotfix,'0') = coalesce(ds_hotfix_p,'0');
            cd_prior_negative_build_w := -1;
        else
            select coalesce(min(nr_old_build),0), coalesce(max(nr_old_build-1),0)
              into STRICT cd_prior_negative_build_w, cd_negative_build_w
              from man_service_pack_versao
            where cd_versao = cd_versao_p 
              and nr_service_pack between cd_build_p-1 and cd_build_p
              and ie_status_build = 'L'
              and coalesce(ds_hotfix,'0') = coalesce(ds_hotfix_p,'0');
        end if;
      EXCEPTION
        when no_data_found then
        begin
            cd_negative_build_w := null;
            cd_prior_negative_build_w := null;
        end;
      end;


  if (ie_classificacao_w != 'S' and  (ie_classificacao_w IS NOT NULL AND ie_classificacao_w::text <> '')) then
          cd_nr_seq_regra := nextval('regra_versao_pacote_sp_seq');
          insert into regra_versao_pacote_sp(
            nr_sequencia,
            nr_pacote,
            nr_service_pack,
            cd_versao,
            ds_hotfix,
            nr_build,
            dt_atualizacao,
            nm_usuario
          ) values (
            cd_nr_seq_regra,
            nr_pacote_w,
            cd_build_p,
            cd_versao_p,
            ds_hotfix_p,
            cd_prior_negative_build_w,
            clock_timestamp(),
            'Tasy'
          );
        end if;

  select count(*) into STRICT is_hotfix_w from service_pack_hotfix where ds_hotfix = ds_hotfix_p;
  if (is_hotfix_w > 0) then

    select cli.cd_cnpj, so.nr_sequencia, so.nr_seq_cliente
    into STRICT cd_customer_cnpj_w, empRecReleaseOS, empRecReleaseCustomer
    from com_cliente cli, man_ordem_servico so, service_pack_hotfix sp
    where Sp.Ds_Hotfix = ds_hotfix_p
    and sp.nr_service_order = so.nr_sequencia
    and So.Nr_Seq_Cliente = Cli.nr_sequencia;

    if (ie_classificacao_w != 'S' and  (ie_classificacao_w IS NOT NULL AND ie_classificacao_w::text <> '')) then
      insert into regra_cliente_os_sp(
        nr_sequencia,
        nr_seq_rgr_ver_pac,
        nr_seq_os,
        cd_cnpj,
        dt_liberacao,
        nr_seq_cliente,
        dt_atualizacao,
        nm_usuario
              ) values (
                nextval('regra_cliente_os_sp_seq'),
                cd_nr_seq_regra,
                empRecReleaseOS,
                cd_customer_cnpj_w,
                clock_timestamp(),
                empRecReleaseCustomer,
                clock_timestamp(),
                'Tasy'
              );
            end if;

    ds_subject_w := Expressao_Pck.Obter_Desc_Expressao(964948) || ' - ' || Expressao_Pck.Obter_Desc_Expressao(970976);
    ds_subject_w := REPLACE(ds_subject_w, '#@cd_build_w#@', cd_build_w);
    ds_body_mail_w := ds_subject_w||CHR(10)||CHR(10)||Expressao_Pck.Obter_Desc_Expressao(964950);
    ds_body_mail_w := REPLACE(ds_body_mail_w, '#@NM_CLIENTE_CNPJ_W#@', substr( obter_nome_pj(cd_customer_cnpj_w),1,120) || ' - ' || cd_customer_cnpj_w);

  else
    ds_subject_w := Expressao_Pck.Obter_Desc_Expressao(965040) || ds_subject_w;
    ds_subject_w := REPLACE(ds_subject_w, '#@cd_build_w#@', cd_build_w);
    ds_body_mail_w := ds_subject_w || CHR(10)||CHR(10);
    case(ie_classificacao_w)
      when 'D' then
      begin
        ds_body_mail_w := ds_body_mail_w || CHR(10)||CHR(10) || Expressao_Pck.Obter_Desc_Expressao(1042612);
      end;
      when 'S' then
      begin
        ds_body_mail_w := ds_body_mail_w || CHR(10)||CHR(10) || Expressao_Pck.Obter_Desc_Expressao(1042961);
      end;
      when 'I' then
      begin
        ds_body_mail_w := ds_body_mail_w || CHR(10)||CHR(10) || Expressao_Pck.Obter_Desc_Expressao(1042965);
      end;
      else ds_subject_w := '';
    end case;
    ds_body_mail_w := REPLACE(ds_body_mail_w, '@#SP@#', cd_build_w) || CHR(10)||CHR(10);
    if (ie_classificacao_w = 'D' or ie_classificacao_w = 'I') then
    begin
    if (coalesce(ds_hotfix_p::text, '') = '') then
      ds_hotfix_w:= '0';
    else ds_hotfix_w := ds_hotfix_p;
    end if;

    sql_string := 'select DISTINCT ''SO: ''|| m.nr_sequencia || chr(13) || chr(10) ||
                 ''Function: ''|| Obter_Desc_Funcao(m.cd_funcao) || chr(13) || chr(10) ||
                 ''Description: ''|| a.ds_motivo || chr(13) || chr(10) ||
                 ''Trading Name: '' ||  pj.nm_fantasia || chr(13) || chr(10) ||
                 ''Company Name/CNPJ: '' || substr( obter_nome_pj(cli.cd_cnpj),1,120) || '' - '' || cli.cd_cnpj || chr(13) || chr(10) || chr(13) || chr(10) note_txt,
                 m.nr_sequencia os,
                 m.nr_seq_cliente customer,
                 cli.cd_cnpj cd_cnpj
    from tasy.ajuste_versao@whebl02_orcl a,
    TASYCORP.MAN_ORDEM_SERVICO@WHEBL01_DBCORP m,
    man_localizacao l,
    man_severidade t,
    man_ordem_serv_impacto p,
    man_ordem_serv_imp_pr q,
    reg_product_requirement r,
    reg_customer_requirement s,
    reg_features_customer u,
    reg_area_customer v,
    reg_funcao_pr x,
    funcao z,
    com_cliente cli,
    pessoa_juridica pj
    where m.nr_seq_cliente = cli.nr_sequencia
    and m.nr_sequencia = a.nr_seq_ordem_serv
    and cli.cd_cnpj = pj.cd_cgc
    and l.nr_sequencia = m.nr_seq_localizacao
    and t.nr_sequencia = m.nr_seq_severidade_wheb
    and m.nr_sequencia = p.nr_seq_ordem_serv
    and p.nr_sequencia = q.nr_seq_impacto
    and q.nr_product_requirement = r.nr_sequencia
    and r.nr_customer_requirement = s.nr_sequencia
    and u.nr_sequencia = s.nr_seq_features
    and v.nr_sequencia = u.nr_seq_area_customer
    and x.nr_seq_product_req = q.nr_product_requirement
    and x.cd_funcao = z.cd_funcao
    and p.dt_aprovacao is not null
    and a.dt_liberacao is not null
    and nvl(a.ie_situacao, ''A'') = ''A''
    and m.nr_seq_localizacao not in (41)
    and t.nr_sequencia not in (5, 7)
    and m.ie_plataforma = ''H''
    and a.nr_pacote is not null
    and a.cd_versao = ''' || cd_versao_p || '''
    and a.NR_SERVICE_PACK = ' || cd_build_p || '
    and nvl(a.ds_hotfix,''0'') = ' || coalesce(ds_hotfix_w,'0') || '
    union all
    select DISTINCT ''SO: ''|| m.nr_sequencia || chr(13) || chr(10) ||
                    ''Function: ''|| Obter_Desc_Funcao(m.cd_funcao) || chr(13) || chr(10) ||
                    ''Description: ''|| m.ds_dano_breve || chr(13) || chr(10) ||
                    ''Trading Name: '' ||  pj.nm_fantasia || chr(13) || chr(10) ||
                    ''Company Name/CNPJ: '' || substr( obter_nome_pj(cli.cd_cnpj),1,120) || '' - '' || cli.cd_cnpj || chr(13) || chr(10) || chr(13) || chr(10) note_txt,
                    m.nr_sequencia os,
                    m.nr_seq_cliente customer,
                    cli.cd_cnpj cd_cnpj
    from man_commit_git a,
    man_ordem_servico m,
    man_localizacao l,
    man_severidade t,
    man_ordem_serv_impacto p,
    man_ordem_serv_imp_pr q,
    reg_product_requirement r,
    reg_customer_requirement s,
    reg_features_customer u,
    reg_area_customer v,
    reg_funcao_pr x,
    funcao z,
    com_cliente cli,
    pessoa_juridica pj
    where m.nr_sequencia = a.nr_seq_ordem_serv
    and m.nr_seq_cliente = cli.nr_sequencia
    and cli.cd_cnpj = pj.cd_cgc
    and l.nr_sequencia = m.nr_seq_localizacao
    and m.nr_sequencia = p.nr_seq_ordem_serv
    and p.nr_sequencia = q.nr_seq_impacto
    and q.nr_product_requirement = r.nr_sequencia
    and r.nr_customer_requirement = s.nr_sequencia
    and u.nr_sequencia = s.nr_seq_features
    and v.nr_sequencia = u.nr_seq_area_customer
    and x.nr_seq_product_req = q.nr_product_requirement
    and t.nr_sequencia = m.nr_seq_severidade_wheb
    and x.cd_funcao = z.cd_funcao
    and p.dt_aprovacao is not null
    and m.nr_seq_localizacao not in (41)
    and t.nr_sequencia not in (5, 7)
    and m.ie_plataforma = ''H''
    and a.ds_projeto not in (''tasy-plsql-objects'')
    and a.ds_branch not in (''dev'')
    and a.ds_branch = ''' || cd_versao_p || '''
    and NVL(substr(a.ds_branch,10,length(a.ds_branch)),''0'') = '''|| ds_hotfix_w || '''
    and exists ( 
        select  1
        from    man_service_pack_versao sp,
                man_versao_calendario cal
        where   cal.cd_versao = sp.cd_versao
        and     cal.cd_build = sp.nr_old_build
        and     cal.cd_versao = a.ds_branch
        and     nvl(cal.ds_hotfix,''0'') = nvl(sp.ds_hotfix,''0'')
        and     nvl(cal.ds_hotfix,''0'') = '''|| ds_hotfix_w || '''
        and     cal.ie_aplicacao = ''H''
        and     cal.IE_CAMADA = ''F''
        and     sp.nr_service_pack = ' || cd_build_p || '
        and     a.dt_atualizacao < cal.dt_inicio_build)
    and ((' || cd_build_p || ' = 0) or exists (
            select  1
            from    man_service_pack_versao sp,
                    man_versao_calendario cal
            where   cal.cd_versao = sp.cd_versao
            and     cal.cd_build = sp.nr_old_build
            and     cal.cd_versao = a.ds_branch
            and     nvl(cal.ds_hotfix,''0'') = nvl(sp.ds_hotfix,''0'')
            and     nvl(cal.ds_hotfix,''0'') = '''|| ds_hotfix_w || '''
            and     cal.ie_aplicacao = ''H''
            and     cal.IE_CAMADA = ''F''
            and     sp.nr_service_pack = (select    max(spp.nr_service_pack)
                                            from    man_service_pack_versao spp
                                            where   spp.cd_versao = sp.cd_versao
                                            and     nvl(spp.ds_hotfix,''0'') = nvl(sp.ds_hotfix,''0'')
                                            and     spp.nr_service_pack < ' || cd_build_p || ')
            and     a.dt_atualizacao > cal.dt_geracao))';

        open c_cursor for EXECUTE sql_string;

        loop
            fetch c_cursor into empRecReleaseNote, empRecReleaseOS, empRecReleaseCustomer, empRecReleaseCNPJ;
            EXIT WHEN NOT FOUND; /* apply on c_cursor */
            ds_body_mail_w := ds_body_mail_w||empRecReleaseNote;
            if (ie_classificacao_w != 'S' and  (ie_classificacao_w IS NOT NULL AND ie_classificacao_w::text <> '')) then
              insert into regra_cliente_os_sp(
                nr_sequencia,
                nr_seq_rgr_ver_pac,
                nr_seq_os,
                cd_cnpj,
                dt_liberacao,
                nr_seq_cliente,
                dt_atualizacao,
                nm_usuario
              ) values (
                nextval('regra_cliente_os_sp_seq'),
                cd_nr_seq_regra,
                empRecReleaseOS,
                empRecReleaseCNPJ,
                clock_timestamp(),
                empRecReleaseCustomer,
                clock_timestamp(),
                'Tasy'
              );
            end if;
        end loop;
        close c_cursor;
    end;
    end if;
  end if;
  commit;

  --enviar_email(ds_subject_w, ds_body_mail_w, 'support.informatics@philips.com', destinatarios_w,'Tasy',null);

  -- RELEASE_NOTE_SP_HTML5(cd_versao_p, cd_build_p, ds_hotfix_p, DESTINATARIOS_P);
$else
null;
$end
 END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_email_service_pack (cd_versao_p text, cd_build_p bigint,destinatarios_p text, ds_hotfix_p text default null) FROM PUBLIC;

