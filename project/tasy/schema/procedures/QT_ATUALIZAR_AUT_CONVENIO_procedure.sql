-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qt_atualizar_aut_convenio ( nr_atendimento_p bigint, nr_seq_atendimento_p bigint, ie_acao_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_paciente_w		bigint;					
nr_seq_aut_conv_w		bigint;
cd_convenio_w			integer;
cd_protocolo_w			bigint;
ie_forma_autor_ciclo_w		varchar(255);
ie_gerar_autor_quimioterapia_w	varchar(5);
ie_vincular_atend_aut_w varchar(5);

/*
ie_acao_p:

GA - Gerar atendimento
VA - Vincular atendimento
DA - Desvincular atendimento

*/
					

BEGIN

ie_vincular_atend_aut_w := obter_param_usuario(865, 184, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_vincular_atend_aut_w);

select	substr(Qt_Obter_Seq_Pac_Seq_Atend(nr_seq_atendimento_p, nm_usuario_p),1,20)
into STRICT	nr_seq_paciente_w
;

select 	max(a.cd_convenio),
	max(b.cd_protocolo)
into STRICT	cd_convenio_w,
	cd_protocolo_w
from	paciente_setor b,
	paciente_setor_convenio a
where	a.nr_seq_paciente	= b.nr_seq_paciente
and	a.nr_seq_paciente	= nr_seq_paciente_w;

select	coalesce(max(ie_forma_autor_quimioterapia),'C'),
	coalesce(max(ie_gerar_autor_quimioterapia),'S')
into STRICT	ie_forma_autor_ciclo_w,
	ie_gerar_autor_quimioterapia_w
from	convenio_estabelecimento
where	cd_convenio		= cd_convenio_w
and	cd_estabelecimento	= obter_estabelecimento_ativo;

if (cd_protocolo_w IS NOT NULL AND cd_protocolo_w::text <> '') then
	select 	coalesce(max(ie_forma_autor_quimio),ie_forma_autor_ciclo_w)
	into STRICT 	ie_forma_autor_ciclo_w
	from 	protocolo
	where	cd_protocolo	= cd_protocolo_w;
end if;

if (ie_vincular_atend_aut_w = 'N') then

    if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_seq_atendimento_p IS NOT NULL AND nr_seq_atendimento_p::text <> '')then

        if (ie_acao_p = 'GA') or (ie_acao_p = 'VA')then

            update 	autorizacao_convenio
            set	nr_atendimento		= nr_atendimento_p,
                nm_usuario		= nm_usuario_p,
                dt_atualizacao		= clock_timestamp()
            where	((nr_seq_paciente		= nr_seq_atendimento_p)
            or (ie_forma_autor_ciclo_w 	= 'C' and ie_gerar_autor_quimioterapia_w <> 'N'))
            and	nr_seq_paciente_setor	= nr_seq_paciente_w
            and	coalesce(nr_atendimento::text, '') = '';
            commit;		

        else
        if (ie_acao_p = 'DA')then		
            update 	autorizacao_convenio
            set	nr_atendimento		 = NULL,
                nm_usuario		= nm_usuario_p,
                dt_atualizacao		= clock_timestamp()
            where	((nr_seq_paciente		= nr_seq_atendimento_p)
            or (ie_forma_autor_ciclo_w 	= 'C' and ie_gerar_autor_quimioterapia_w <> 'N'))
            and	nr_seq_paciente_setor	= nr_seq_paciente_w;		
            commit;		
        end if;	

        end if;

    end if;

end if;

if (ie_vincular_atend_aut_w = 'T' or ie_vincular_atend_aut_w = 'S' or ie_vincular_atend_aut_w = 'D') then
    CALL valida_vinc_onco_autorizacao(nm_usuario_p, nr_seq_atendimento_p, nr_atendimento_p, ie_acao_p);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qt_atualizar_aut_convenio ( nr_atendimento_p bigint, nr_seq_atendimento_p bigint, ie_acao_p text, nm_usuario_p text) FROM PUBLIC;

