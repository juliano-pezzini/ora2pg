-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE apap_atualiza_status ( nr_seq_valor_p w_apap_pac_registro.nr_sequencia%type, ie_opcao_p text) AS $body$
DECLARE

						
ie_resumo_w		w_apap_pac_registro.ie_resumo%type;
nr_seq_linha_w	w_apap_pac_registro.nr_seq_apap_inf%type;
dt_registro_w	w_apap_pac_registro.dt_registro%type;

BEGIN
/*
ie_opcao_p
P - Pendente
R - Reprovado
A - Aprovado
*/
if (coalesce(nr_seq_valor_p,0) > 0) and (ie_opcao_p IS NOT NULL AND ie_opcao_p::text <> '') then
	select	max(a.ie_resumo),
			max(a.nr_seq_apap_inf),
			max(a.dt_registro)
	into STRICT	ie_resumo_w,
			nr_seq_linha_w,
			dt_registro_w
	from	w_apap_pac_registro a
	where	a.nr_sequencia = nr_seq_valor_p;

	if (ie_resumo_w = 'N') then
		update	w_apap_pac_registro a
		set		a.ie_status_registro 	= ie_opcao_p
		where	a.nr_sequencia 			= nr_seq_valor_p;
	else
		update	w_apap_pac_registro a
		set		a.ie_status_registro 	= ie_opcao_p
		where	a.nr_seq_apap_inf		in (	SELECT	b.nr_sequencia
												from	w_apap_pac_informacao b
												where	b.nr_seq_superior = nr_seq_linha_w
												
union

												SELECT	nr_seq_linha_w
												)
		and		a.dt_registro 			= dt_registro_w
		and		coalesce(a.ie_situacao,'A') 	= 'A'
		and     ((coalesce(a.nr_seq_origem::text, '') = '') or (a.ie_status_houdini = 'L') or
				 ((coalesce(a.ie_integracao,'N') = 'S') and (coalesce(a.dt_liberacao::text, '') = '')));
	end if;
end if;
commit;
end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE apap_atualiza_status ( nr_seq_valor_p w_apap_pac_registro.nr_sequencia%type, ie_opcao_p text) FROM PUBLIC;

