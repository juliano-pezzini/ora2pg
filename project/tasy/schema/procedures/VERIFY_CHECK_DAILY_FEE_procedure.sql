-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE verify_check_daily_fee ( nr_atendimento_p atend_categoria_convenio.nr_atendimento%type, cd_convenio_p INOUT atend_categoria_convenio.cd_convenio%type, cd_msg_p INOUT bigint, nr_atend_p INOUT atend_categoria_convenio.nr_atendimento%type ) AS $body$
DECLARE


nr_atendimento_w	    atend_categoria_convenio.nr_atendimento%type;
nr_atendimento_ret_w	    atend_categoria_convenio.nr_atendimento%type;
cd_convenio_w		    atend_categoria_convenio.cd_convenio%type;
qt_insurance_without_fee_w  smallint;
cd_msgm_w		    bigint;

c_Insurances CURSOR FOR
SELECT  acc.cd_convenio     cd_convenio,
        acc.nr_prioridade   nr_prioridade,
        acc.nr_seq_interno  nr_seq_interno
from    atend_categoria_convenio acc
where   acc.nr_atendimento = nr_atendimento_p
and     coalesce(acc.nr_prioridade, 9999) <> 0;

BEGIN

nr_atendimento_w := 0;

if ((nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and coalesce(pkg_i18n.get_user_locale,'pt_BR') in ('de_DE', 'de_AT'))then

	select 	coalesce(max(con.cd_convenio),0)
	into STRICT 	cd_convenio_w
	from 	atend_categoria_convenio acc,
			convenio con,
			atendimento_paciente ap
	where 	ap.nr_atendimento = nr_atendimento_p
	and 	acc.nr_atendimento 	= ap.nr_atendimento
	and   	acc.cd_convenio 	= con.cd_convenio
	and 	ap.ie_tipo_atendimento = 1
	and	  	not exists (SELECT 1
					from pessoa_fisica_taxa pft
					where pft.nr_atendimento 	= acc.nr_atendimento
					and pft.nr_seq_atecaco		= acc.nr_seq_interno
					and (pft.ie_obriga_pag_adicional = 'S' or (pft.ie_obriga_pag_adicional = 'N'
										and (pft.nr_seq_justificativa IS NOT NULL AND pft.nr_seq_justificativa::text <> ''))))
	and   	obter_regra_taxa_convenio(con.ie_tipo_convenio, con.cd_convenio) = 'S';

	if (cd_convenio_w > 0) then
        cd_msgm_w := 1076247;
	end if;

    if (coalesce(cd_msgm_w::text, '') = '') then
        for c_Insurances_w in c_Insurances loop

            if (coalesce(c_Insurances_w.nr_prioridade::text, '') = '') then
                cd_msgm_w := 1097429;
                cd_convenio_w := c_Insurances_w.cd_convenio;
            end if;

             nr_atendimento_ret_w	:= consisty_rule_prio_insurance(nr_atendimento_p,
                                        c_Insurances_w.cd_convenio,
                                        c_Insurances_w.nr_prioridade,
                                        c_Insurances_w.nr_seq_interno);
            if (nr_atendimento_ret_w <> 0) then
                nr_atendimento_w := nr_atendimento_ret_w;
            end if;
        end loop;

    end if;

end if;

cd_msg_p := cd_msgm_w;
cd_convenio_p := cd_convenio_w;
nr_atend_p := nr_atendimento_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE verify_check_daily_fee ( nr_atendimento_p atend_categoria_convenio.nr_atendimento%type, cd_convenio_p INOUT atend_categoria_convenio.cd_convenio%type, cd_msg_p INOUT bigint, nr_atend_p INOUT atend_categoria_convenio.nr_atendimento%type ) FROM PUBLIC;

