-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cpoe_dialise_gir (nr_atendimento_p atendimento_paciente.nr_atendimento%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


cpoe_dialise_w              cpoe_dialise%rowtype;

dt_inicio_w                 cpoe_dialise.dt_inicio%type;
cd_departamento_w           cpoe_dialise.cd_departamento%type;
nr_seq_dialise_w            cpoe_dialise.nr_sequencia%type;
nr_seq_dialise_ww           cpoe_dialise.nr_sequencia%type;

nr_prescricao_w             prescr_medica.nr_prescricao%type;
nr_prescricao_out_w		    prescr_medica.nr_prescricao%type;
cd_estabelecimento_w		prescr_medica.cd_estabelecimento%type;
cd_setor_atendimento_w		prescr_medica.cd_setor_atendimento%type;
cd_perfil_w			        prescr_medica.cd_perfil_ativo%type;
cd_pessoa_fisica_w		    prescr_medica.cd_pessoa_fisica%type;
ie_motivo_prescricao_w		prescr_medica.ie_motivo_prescricao%type;
cd_medico_w			        prescr_medica.cd_medico%type;
ie_adep_w			        prescr_medica.ie_adep%type;

ds_erro_w			        varchar(4000);
ds_itens_liberar_w			varchar(4000);
ds_inconsist_lib_out_w		varchar(4000);
ds_itens_liberados_w		varchar(4000);
ds_lista_proc_susp_w		varchar(4000);
ds_prescr_geradas_full_w	varchar(4000);
ie_inconsistencia_out_w		varchar(1);
dt_inicio_ret_w             timestamp;


BEGIN
    select  max(nr_sequencia)
    into STRICT    nr_seq_dialise_w
    from    cpoe_dialise
    where   nr_atendimento = nr_atendimento_p
    and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '');

    if (coalesce(nr_seq_dialise_w,0) > 0) then
        begin
            
            select	*
            into STRICT    cpoe_dialise_w
            from    cpoe_dialise
            where   nr_sequencia = nr_seq_dialise_w;

            select  nextval('cpoe_dialise_seq')
            into STRICT    nr_seq_dialise_ww
;

            dt_inicio_w := to_date(to_char(clock_timestamp(),'dd/mm/yyyy')||' '||to_char(cpoe_dialise_w.dt_inicio,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');

            cpoe_dialise_w.nr_sequencia		:= nr_seq_dialise_ww;
            cpoe_dialise_w.nr_atendimento		:= nr_atendimento_p;
            cpoe_dialise_w.dt_atualizacao		:= clock_timestamp();
            cpoe_dialise_w.dt_atualizacao_nrec	:= clock_timestamp();
            cpoe_dialise_w.nm_usuario   := nm_usuario_p;
            cpoe_dialise_w.nm_usuario_nrec   := nm_usuario_p;
            cpoe_dialise_w.dt_inicio		:= dt_inicio_w;
            cpoe_dialise_w.dt_fim			:= null; -- n√£o sei se deve colocar DT_FIM
            cpoe_dialise_w.dt_liberacao		:= null;
            cpoe_dialise_w.nr_seq_cpoe_anterior    := nr_seq_dialise_w;
            cpoe_dialise_w.dt_prox_geracao		:= null;
            cpoe_dialise_w.ds_stack		    := substr(dbms_utility.format_call_stack,1,2000);
            cpoe_dialise_w.dt_suspensao		:= null;
            cpoe_dialise_w.nm_usuario_susp	    := null;
            cpoe_dialise_w.dt_lib_suspensao	:= null;
            cpoe_dialise_w.nm_usuario_lib_enf	:= null;
            cpoe_dialise_w.cd_farmac_lib		:= null;
            cpoe_dialise_w.dt_liberacao_enf	:= null;
            cpoe_dialise_w.dt_liberacao_farm	:= null;
            cpoe_dialise_w.nm_usuario_lib_farm	:= null;
            cpoe_dialise_w.nr_seq_agenda		:= null;
            cpoe_dialise_w.ie_forma_geracao	:= null;
            cpoe_dialise_w.ie_forma_suspensao	:= null;

            insert into cpoe_dialise values (cpoe_dialise_w.*);

            ds_itens_liberar_w  :=	cpoe_dialise_w.ie_tipo_dialise || ',' ||nr_seq_dialise_ww || ';';

            begin
                select	max(a.nr_prescricao)
                into STRICT	nr_prescricao_w
                from	prescr_medica a
                where	a.nr_atendimento = nr_atendimento_p
                and		exists (	SELECT	1
                                from	hd_prescricao b
                                where	b.nr_seq_dialise_cpoe = nr_seq_dialise_w
                                and		b.nr_prescricao = a.nr_prescricao );
            exception when no_data_found then
                rollback;
                CALL gravar_log_cpoe(substr('GERAR_CPOE_DIALISE_GIR PRESCRICAO NOT FOUND: '||substr(to_char(sqlerrm),1,2000)
                ||' nr_atendimento_p: '||nr_atendimento_p
                ||' nr_seq_dialise_w : '||nr_seq_dialise_w
                ||' nm_usuario_p :'||nm_usuario_p, 1, 2000),
                nr_atendimento_p, 'D', nr_seq_dialise_ww);
                commit;
            end;
            begin
                if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then
                    select	cd_estabelecimento,
                        cd_setor_atendimento,
                        cd_perfil_ativo,
                        cd_pessoa_fisica,
                        ie_motivo_prescricao,
                        cd_medico,
                        ie_adep
                    into STRICT	cd_estabelecimento_w,
                        cd_setor_atendimento_w,
                        cd_perfil_w,
                        cd_pessoa_fisica_w,
                        ie_motivo_prescricao_w,
                        cd_medico_w,
                        ie_adep_w
                    from	prescr_medica
                    where	nr_prescricao	= nr_prescricao_w;

                    SELECT * FROM CPOE_Liberacao(	cd_estabelecimento_p	=>	cd_estabelecimento_w, cd_setor_atendimento_p	=>	cd_setor_atendimento_w, cd_perfil_p		=>	cd_perfil_w, nr_atendimento_p		=>	nr_atendimento_p, itens_liberar_p		=>	ds_itens_liberar_w, nm_usuario_p		=>	nm_usuario_p, ds_itens_liberados_p    =>	ds_itens_liberados_w, ie_inconsistencia_out_p	=>	ie_inconsistencia_out_w, cd_pessoa_fisica_p		=>	cd_pessoa_fisica_w, ie_interv_farmacia_p	=>	'N', ie_liberacao_ang_p		=>	'S', ie_motivo_prescr_p		=>	ie_motivo_prescricao_w, cd_medico_p		=>	cd_medico_w, nr_prescricao_out_p	=>	nr_prescricao_out_w, ds_lista_proc_susp_out_p	=>	ds_lista_proc_susp_w, ds_inconsist_lib_out_p	=>	ds_inconsist_lib_out_w, ie_adep_p	=>	ie_adep_w, cd_departamento_p	=>	cpoe_dialise_w.cd_departamento, ds_prescr_geradas_full_p    =>	ds_prescr_geradas_full_w, ie_copia_diaria_p      =>    'S') INTO STRICT ds_itens_liberados_p    =>	ds_itens_liberados_w, ie_inconsistencia_out_p	=>	ie_inconsistencia_out_w, ds_lista_proc_susp_out_p	=>	ds_lista_proc_susp_w, ds_inconsist_lib_out_p	=>	ds_inconsist_lib_out_w, ie_adep_p	=>	ie_adep_w,;
                  end if;
            exception when others then
            
                rollback;
                CALL gravar_log_cpoe(substr('GERAR_CPOE_DIALISE_GIR ERRO LIBERACAO: '||substr(to_char(sqlerrm),1,2000)
                ||' nr_atendimento_p: '||nr_atendimento_p
                ||' nr_seq_dialise_w : '||nr_seq_dialise_w
                ||' nr_seq_dialise_ww : '||nr_seq_dialise_ww
                ||' nr_prescricao_w : '|| nr_prescricao_w
                ||' cd_estabelecimento_w : '|| cd_estabelecimento_w
                ||' cd_setor_atendimento_w : '|| cd_setor_atendimento_w
                ||' cd_perfil_w : '|| cd_perfil_w
                ||' cd_pessoa_fisica_w : '|| cd_pessoa_fisica_w
                ||' ie_motivo_prescricao_w : '|| ie_motivo_prescricao_w
                ||' cd_medico_w : '|| cd_medico_w
                ||' ie_adep_w : '|| ie_adep_w
                ||' nr_prescricao_out_p: '|| nr_prescricao_out_w
                ||' ds_erro_w : '|| ds_erro_w		 	        
                ||' ds_itens_liberar_w : '|| ds_itens_liberar_w			
                ||' ds_inconsist_lib_out_w : '|| ds_inconsist_lib_out_w		
                ||' ds_itens_liberados_w : '|| ds_itens_liberados_w	
                ||' ds_lista_proc_susp_w : '|| ds_lista_proc_susp_w		
                ||' ds_prescr_geradas_full_w : '|| ds_prescr_geradas_full_w	
                ||' ie_inconsistencia_out_w : '|| ie_inconsistencia_out_w
                ||' nm_usuario_p :'||nm_usuario_p, 1, 2000),
                nr_atendimento_p, 'D', nr_seq_dialise_ww);
                commit;
            end;

            commit;
        end;
    end if;

exception when no_data_found then
    CALL gravar_log_cpoe(substr('GERAR_CPOE_DIALISE_GIR EXCEPTION NO DIALISE FOUND:'||substr(to_char(sqlerrm),1,2000)
        ||' nr_atendimento_p:'||nr_atendimento_p||'nm_usuario_p : '||nm_usuario_p,1,2000),
        nr_atendimento_p, 'D', nr_seq_dialise_w);
    commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cpoe_dialise_gir (nr_atendimento_p atendimento_paciente.nr_atendimento%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

