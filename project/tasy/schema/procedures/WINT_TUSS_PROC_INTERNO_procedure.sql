-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE wint_tuss_proc_interno ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_seq_ageint_p agenda_integrada.nr_sequencia%type, nr_seq_agepac_p agenda_paciente.nr_sequencia%type, cd_procedimento_tuss_p bigint, cd_convenio_p bigint, cd_categoria_p text, ie_tipo_atendimento_p bigint, cd_estabelecimento_p bigint, cd_tipo_acomodacao_p bigint, cd_variacao_p text, dt_procedimento_p timestamp, nr_seq_proc_interno_p INOUT bigint, nr_seq_exame_p INOUT exame_laboratorio.nr_seq_exame%type, cd_material_exame_p INOUT text, ie_lado_p INOUT text, nr_seq_topografia_p INOUT bigint, nr_seq_contraste_p INOUT bigint, nr_seq_orcamento_p orcamento_paciente.nr_sequencia_orcamento%type default null) AS $body$
DECLARE


qt_registro_w		smallint;	
qt_idade_w		bigint;
ie_sexo_w		pessoa_fisica.ie_sexo%type;
ds_retorno_w		bigint;
ie_table_w		varchar(1);
cd_convenio_w		atend_categoria_convenio.cd_convenio%type;
cd_categoria_w		atend_categoria_convenio.cd_categoria%type;
ie_tipo_atend_w		atendimento_paciente.ie_tipo_atendimento%type;

C01 CURSOR FOR
	SELECT	a.nr_seq_proc_interno,
			b.ie_lado,
			b.nr_seq_topografia,
			b.nr_seq_contraste
	from	proc_interno_conv_tuss a,
			regra_proc_interno_integra b
	where	a.ie_situacao = 'A'
	and		a.nr_seq_proc_interno 	= b.nr_seq_proc_interno
	and		a.cd_procedimento 	= cd_procedimento_tuss_p
	and		b.ie_tipo_integracao = 26
	and		((a.cd_convenio		= coalesce(cd_convenio_p,cd_convenio_w)) OR (coalesce(a.cd_convenio::text, '') = ''))
	and		((a.cd_categoria	= coalesce(cd_categoria_p,cd_categoria_w)) OR (coalesce(a.cd_categoria::text, '') = ''))
	and		((a.ie_tipo_atendimento = coalesce(ie_tipo_atendimento_p,ie_tipo_atend_w)) OR (coalesce(a.ie_tipo_atendimento::text, '') = ''))
	and		coalesce(a.cd_estabelecimento, coalesce(cd_estabelecimento_p,0)) = coalesce(cd_estabelecimento_p,0)
	and		coalesce(a.cd_tipo_acomodacao, coalesce(cd_tipo_acomodacao_p,0)) = coalesce(cd_tipo_acomodacao_p,0)
	and		coalesce(b.ie_sexo, coalesce(ie_sexo_w,'X')) = coalesce(ie_sexo_w,'X')
	and		coalesce(b.cd_integracao, coalesce(cd_variacao_p,'XxX')) = coalesce(cd_variacao_p,'XxX')
	and 	qt_idade_w between coalesce(b.qt_idade_min, qt_idade_w) and coalesce(b.qt_idade_max, qt_idade_w)
	and 	coalesce(dt_procedimento_p,clock_timestamp()) between coalesce(a.DT_INICIO_VIGENCIA, coalesce(dt_procedimento_p,clock_timestamp())) and coalesce(a.DT_FINAL_VIGENCIA, coalesce(dt_procedimento_p,clock_timestamp()))
	order by
		coalesce(a.cd_edicao_amb,0),
		coalesce(a.cd_convenio,0),
		coalesce(a.cd_categoria,'0'),
		coalesce(a.ie_tipo_atendimento,0),
		coalesce(a.ie_origem_proc_filtro,0),
		coalesce(a.cd_estabelecimento,0),
		coalesce(a.cd_setor_atendimento,0),
		coalesce(a.cd_tipo_acomodacao,0),
		coalesce(b.nr_seq_contraste,0);


BEGIN
if (coalesce(nr_atendimento_p,0) > 0) then
	select	coalesce(max(obter_idade_pf(a.cd_pessoa_fisica, clock_timestamp(), 'A')),0),
		max(c.ie_sexo),
		max(b.cd_convenio),
		max(b.cd_categoria),
		max(a.ie_tipo_atendimento)
	into STRICT	qt_idade_w,
			ie_sexo_w,
			cd_convenio_w,
			cd_categoria_w,
			ie_tipo_atend_w
	from	atendimento_paciente a,
		atend_categoria_convenio b,
		pessoa_fisica c
	where	a.nr_atendimento = nr_atendimento_p
	and	a.cd_pessoa_fisica = c.cd_pessoa_fisica
	and	b.nr_seq_interno = obter_atecaco_atendimento(a.nr_atendimento);
	

elsif (coalesce(nr_seq_agepac_p,0) > 0) then

	select	coalesce(max(obter_idade_pf(a.cd_pessoa_fisica, clock_timestamp(), 'A')),0),
		max(c.ie_sexo),
		max(a.cd_convenio),
		max(a.cd_categoria),
		max(a.ie_tipo_atendimento)
	into STRICT	qt_idade_w,
		ie_sexo_w,
		cd_convenio_w,
		cd_categoria_w,
		ie_tipo_atend_w
	from	agenda_paciente a,
		pessoa_fisica c
	where	a.nr_sequencia = nr_seq_agepac_p
	and	a.cd_pessoa_fisica = c.cd_pessoa_fisica;	
	
elsif (coalesce(nr_seq_ageint_p,0) > 0) then

	select	coalesce(max(obter_idade_pf(a.cd_pessoa_fisica, clock_timestamp(), 'A')),0),
		max(c.ie_sexo),
		max(a.cd_convenio),
		max(a.cd_categoria),
		max(a.ie_tipo_atendimento)
	into STRICT	qt_idade_w,
		ie_sexo_w,
		cd_convenio_w,
		cd_categoria_w,
		ie_tipo_atend_w
	from	agenda_integrada a,
		pessoa_fisica c
	where	a.nr_sequencia = nr_seq_ageint_p
	and	a.cd_pessoa_fisica = c.cd_pessoa_fisica;
elsif (nr_seq_orcamento_p IS NOT NULL AND nr_seq_orcamento_p::text <> '') then
        begin
        select	coalesce(obter_idade_pf(b.cd_pessoa_fisica, clock_timestamp(), 'A'),0),
		b.ie_sexo,
		a.cd_convenio,
		a.cd_categoria,
		a.ie_tipo_atendimento
        into STRICT    qt_idade_w,
                ie_sexo_w,
                cd_convenio_w,
                cd_categoria_w,
                ie_tipo_atend_w
	from	orcamento_paciente a,
		pessoa_fisica b
	where	a.nr_sequencia_orcamento = nr_seq_orcamento_p
	and	a.cd_pessoa_fisica = b.cd_pessoa_fisica;
        exception
                when no_data_found then
                        qt_idade_w := null;
                        ie_sexo_w := null;
                        cd_convenio_w := null;
                        cd_categoria_w := null;
                        ie_tipo_atend_w := null;
                when too_many_rows then
                        qt_idade_w := null;
                        ie_sexo_w := null;
                        cd_convenio_w := null;
                        cd_categoria_w := null;
                        ie_tipo_atend_w := null;
        end;
end if;

begin
	select 	c.nr_seq_exame,
		coalesce(d.cd_material, ''),
		d.nr_seq_proc_interno,
		d.ie_lado,
		d.nr_seq_topografia,
		d.nr_seq_contraste
	into STRICT	nr_seq_exame_p,
		cd_material_exame_p,
		nr_seq_proc_interno_p,
		ie_lado_p,
		nr_seq_topografia_p,
		nr_seq_contraste_p
	from	proc_interno a,
		exame_laboratorio c,
        	regra_proc_interno_integra d
	where	a.ie_situacao = 'A'
	and	d.ie_tipo_integracao = 26
	and	c.nr_seq_proc_interno = a.nr_sequencia
    and	d.nr_seq_proc_interno = c.nr_seq_proc_interno
	and a.cd_procedimento_tuss = cd_procedimento_tuss_p
	and	coalesce(d.cd_integracao, coalesce(cd_variacao_p,'XxX')) = coalesce(cd_variacao_p,'XxX')  LIMIT 1;
exception
when too_many_rows then null;
when no_data_found then
	select 	max(nr_seq_exame),
		max(nr_seq_proc_interno)
	into STRICT	nr_seq_exame_p,
		nr_seq_proc_interno_p
	from 	exame_laboratorio
	where 	cd_procedimento_tuss = cd_procedimento_tuss_p;
	
	if (nr_seq_exame_p IS NOT NULL AND nr_seq_exame_p::text <> '') then
		select coalesce(max(cd_material_exame),'')
		into STRICT	cd_material_exame_p
		from (		SELECT 	b.cd_material_exame
				from	material_exame_lab b,
					exame_lab_material a
				where 	a.nr_seq_material = b.nr_sequencia
				and 	a.nr_seq_exame	  = nr_seq_exame_p
				and 	a.ie_situacao	  = 'A'
				order by a.ie_prioridade) alias3 LIMIT 1;
	end if;	
end;

if (coalesce(nr_seq_exame_p,0) = 0) then

	select 	count(1)
	into STRICT	qt_registro_w
	from	proc_interno_conv_tuss a,
		regra_proc_interno_integra b
	where	a.ie_situacao = 'A'
	and	a.nr_seq_proc_interno 	= b.nr_seq_proc_interno
	and 	a.cd_procedimento 	= cd_procedimento_tuss_p
	and	coalesce(b.cd_integracao, coalesce(cd_variacao_p,'XxX')) = coalesce(cd_variacao_p,'XxX')
	and	b.ie_tipo_integracao = 26;

	if (qt_registro_w > 0) then
		open C01;
		loop
		fetch C01 into	
			nr_seq_proc_interno_p,
			ie_lado_p,
			nr_seq_topografia_p,
			nr_seq_contraste_p;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin
			nr_seq_proc_interno_p 		:= nr_seq_proc_interno_p;
			ie_lado_p		:= ie_lado_p;
			nr_seq_topografia_p	:= nr_seq_topografia_p;
			nr_seq_contraste_p := nr_seq_contraste_p;
			end;
		end loop;
		close C01;
	end if;
	
	if (coalesce(nr_seq_proc_interno_p,0) = 0) then	
		select	max(a.nr_sequencia),
			max(b.ie_lado),
			max(b.nr_seq_topografia),
			max(b.nr_seq_contraste)
		into STRICT	nr_seq_proc_interno_p,
			ie_lado_p,
			nr_seq_topografia_p,
			nr_seq_contraste_p
		from	proc_interno a,
			regra_proc_interno_integra b
		where	a.ie_situacao = 'A'
		and	b.ie_tipo_integracao = 26
		and	a.nr_sequencia = b.nr_seq_proc_interno
		and	coalesce(b.cd_integracao, coalesce(cd_variacao_p,'XxX')) = coalesce(cd_variacao_p,'XxX')
		and 	a.cd_procedimento_tuss = cd_procedimento_tuss_p;
	end if;	
end if;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE wint_tuss_proc_interno ( nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_seq_ageint_p agenda_integrada.nr_sequencia%type, nr_seq_agepac_p agenda_paciente.nr_sequencia%type, cd_procedimento_tuss_p bigint, cd_convenio_p bigint, cd_categoria_p text, ie_tipo_atendimento_p bigint, cd_estabelecimento_p bigint, cd_tipo_acomodacao_p bigint, cd_variacao_p text, dt_procedimento_p timestamp, nr_seq_proc_interno_p INOUT bigint, nr_seq_exame_p INOUT exame_laboratorio.nr_seq_exame%type, cd_material_exame_p INOUT text, ie_lado_p INOUT text, nr_seq_topografia_p INOUT bigint, nr_seq_contraste_p INOUT bigint, nr_seq_orcamento_p orcamento_paciente.nr_sequencia_orcamento%type default null) FROM PUBLIC;

