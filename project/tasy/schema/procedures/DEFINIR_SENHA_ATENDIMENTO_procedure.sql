-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE definir_senha_atendimento ( ie_tipo_atendimento_p bigint, nr_seq_regra_funcao_p bigint, cd_pessoa_fisica_p text, ds_senha_retorno_p INOUT text) AS $body$
DECLARE


ie_regra_w	varchar(3);
ds_senha_w	varchar(20);
cd_estabelecimento_w	bigint;

c01 CURSOR FOR
	SELECT ie_regra
	from regra_senha_atend
	where	cd_estabelecimento	= coalesce(cd_estabelecimento_w,cd_estabelecimento)
	and	coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_p,0)) = coalesce(ie_tipo_atendimento_p,0)
	and 	coalesce(nr_seq_regra_funcao, coalesce(nr_seq_regra_funcao_p,0)) = coalesce(nr_seq_regra_funcao_p,0)
	order by coalesce(ie_tipo_atendimento_p,0),
		 coalesce(nr_seq_regra_funcao_p,0);
		

BEGIN
cd_estabelecimento_w	:=  wheb_usuario_pck.get_cd_estabelecimento;


/* insert into log_XXXXtasy values (
			sysdate,
			'LogGeracaoSenha',
			88926,
			' ie_tipo_atendimento_p= ' || ie_tipo_atendimento_p ||
			' nr_seq_regra_funcao_p= ' || nr_seq_regra_funcao_p ||
			' cd_estabelecimento_w= '  || cd_estabelecimento_w); */
open c01;
loop
fetch c01 into ie_regra_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	ie_regra_w := ie_regra_w;
end loop;
close c01;

if (ie_regra_w = 'NS') then
	select to_char(nextval('atendimento_senha_seq'))
	into STRICT ds_senha_w
	;
elsif (ie_regra_w = 'LN') then
	select	obter_Senha_Letra_Numero(6)
	into STRICT	ds_senha_w
	;
elsif (ie_regra_w = 'NA') then
	ds_senha_w := obter_numero_randomico;
elsif (ie_regra_w = 'DS') then
/* Beckhauser em 02/08/2012 */
	
	select	REPLACE(obter_dados_pf(cd_pessoa_fisica_p,'DN'),'/','')
	into STRICT	ds_senha_w
	;
elsif (ie_regra_w = 'SP') then
	select max(ds_senha)
	into STRICT 	ds_senha_w
	from pessoa_fisica
	where cd_pessoa_fisica = cd_pessoa_fisica_p;
end if;

ds_senha_retorno_p := ds_senha_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE definir_senha_atendimento ( ie_tipo_atendimento_p bigint, nr_seq_regra_funcao_p bigint, cd_pessoa_fisica_p text, ds_senha_retorno_p INOUT text) FROM PUBLIC;

