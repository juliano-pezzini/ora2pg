-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE campos AS (ds_dias_aplicacao varchar(255));


CREATE OR REPLACE PROCEDURE ajustar_dia_medic_trat_conc ( nr_seq_paciente_p bigint, nr_seq_interno_p bigint, nm_usuario_p text) AS $body$
DECLARE

										
indice_w 				bigint;
dia_ciclo_w 			varchar(1);
ds_valido_dias_w 		varchar(13) := '0123456789D,-';
ds_texto_w 				varchar(4000);
indice_dias_w 			bigint;
indice_loop_w 			bigint;
type vetor 				is table of campos index by integer;
dias_w 					vetor;
posicao_virg_w 			bigint;
tamanho_vetor_w 		bigint;
indice_while_w 			bigint;
dia_w 					varchar(255);
nr_seq_atendimento_w 	paciente_atendimento.nr_seq_atendimento%type;
nr_seq_material_w 		paciente_atend_medic.nr_seq_material%type;
nr_seq_interno_w 		bigint;
existe_w 				bigint;
ie_gerar_ciclos_w 		varchar(1);
ds_dias_aplicacao_w		varchar(255);
nr_agrupamento_w		paciente_atend_medic.nr_agrupamento%type;
cd_material_pac_w		paciente_atend_medic.cd_material%type;
cd_material_ww			material.cd_material%type;
cd_unidade_medida_ww	paciente_protocolo_medic.cd_unidade_medida%type;
qt_dose_ww				paciente_protocolo_medic.qt_dose%type;
ie_via_aplicacao_ww		paciente_protocolo_medic.ie_via_aplicacao%type;
ds_recomendacao_ww		paciente_protocolo_medic.ds_recomendacao%type;
ds_observacao_ww		paciente_protocolo_medic.ds_observacao%type;
nr_agrupamento_ww		paciente_protocolo_medic.nr_agrupamento%type;
ds_dias_aplicacao_ww	paciente_protocolo_medic.ds_dias_aplicacao%type;
qt_min_aplicacao_ww		paciente_protocolo_medic.qt_min_aplicacao%type;
ie_bomba_infusao_ww		paciente_protocolo_medic.ie_bomba_infusao%type;
cd_intervalo_ww			paciente_protocolo_medic.cd_intervalo%type;
qt_hora_aplicacao_ww	paciente_protocolo_medic.qt_hora_aplicacao%type;
qt_dias_util_ww			paciente_protocolo_medic.qt_dias_util%type;
nr_seq_interno_ww		paciente_protocolo_medic.nr_seq_interno%type;
ie_se_necessario_ww		paciente_protocolo_medic.ie_se_necessario%type;
ie_aplic_lenta_ww		paciente_protocolo_medic.ie_aplic_lenta%type;
ie_urgencia_ww			paciente_protocolo_medic.ie_urgencia%type;
ie_aplic_bolus_ww		paciente_protocolo_medic.ie_aplic_bolus%type;
nr_seq_int_prot_medic_w	paciente_protocolo_medic.nr_seq_interno%type;
ie_agrupador_w			paciente_protocolo_medic.ie_agrupador%type;
ie_aplica_reducao_ww	paciente_protocolo_medic.ie_aplica_reducao%type;
ie_uso_continuo_ww	    paciente_protocolo_medic.ie_uso_continuo%type;
ie_local_adm_w			paciente_protocolo_medic.ie_local_adm%type;
nr_seq_mat_diluicao_w	paciente_protocolo_medic.nr_seq_mat_diluicao%type;
ie_acm_w				paciente_protocolo_medic.ie_acm%type;
cd_unid_med_prescr_dil_w	paciente_protocolo_medic.cd_unid_med_prescr%type;
qt_dose_prescr_dil_w	paciente_protocolo_medic.qt_dose_prescr%type;
qt_dias_receita_w		paciente_protocolo_medic.qt_dias_receita%type;
nr_seq_mat_dil_w		paciente_atend_medic.nr_seq_material%type;
nr_seq_diluicao_www		bigint;
nr_seq_medic_material_www	bigint;
cd_grupo_material_w	bigint;
cd_subgrupo_material_w	bigint;
ie_material_diluiacao_w	varchar(3);
cd_classe_material_w	bigint;
ie_exige_liberacao_w	varchar(1);
ie_generico_w		varchar(1);
nr_seq_material_ww	bigint;

c01 CURSOR FOR
SELECT	*
from	paciente_protocolo_medic
where	nr_seq_paciente	= nr_seq_paciente_p
and		nr_seq_interno	= nr_seq_interno_p;

c01_w	c01%rowtype;

c02 CURSOR FOR
SELECT	a.nr_seq_atendimento,
		a.nr_seq_material,
		b.nr_ciclo
from	paciente_atend_medic a,
		paciente_atendimento b
where	b.nr_seq_atendimento = 	a.nr_seq_atendimento
and		b.nr_seq_paciente = nr_seq_paciente_p
and		a.nr_agrupamento = nr_agrupamento_w
and		a.cd_material = cd_material_pac_w
and		b.ds_dia_ciclo not in ds_dias_aplicacao_w
and		coalesce(b.nr_prescricao::text, '') = '';

c02_w	c02%rowtype;

C03 CURSOR FOR
SELECT	nr_seq_atendimento
from	paciente_atendimento
where	nr_seq_paciente	= nr_seq_paciente_p
and		ds_dia_ciclo	= dia_w
and		coalesce(nr_prescricao::text, '') = ''
and		coalesce(dt_cancelamento::text, '') = ''
and (coalesce(ie_gerar_ciclos_w,'N') = 'S')
and		((coalesce(c01_w.ds_ciclos_aplicacao::text, '') = '') or (instr((c01_w.ds_ciclos_aplicacao||','),('C'||nr_ciclo||',')) > 0))			
and		Obter_Se_Dia_Ciclo_Autorizado(nr_seq_atendimento,nr_ciclo) = 'N'

union

SELECT	nr_seq_atendimento
from	paciente_atendimento
where	nr_seq_paciente = nr_seq_paciente_p
and		ds_dia_ciclo 	= dia_w
and		coalesce(nr_prescricao::text, '') = ''
and		coalesce(dt_cancelamento::text, '') = ''
and (coalesce(ie_gerar_ciclos_w,'N') = 'N')
and		obter_se_dia_ciclo_autorizado(nr_seq_atendimento,nr_ciclo) = 'N';

c04 CURSOR FOR
SELECT	CASE WHEN ie_generico_w='S' THEN coalesce(b.cd_material_generico,a.cd_material)  ELSE a.cd_material END ,
	a.cd_unidade_medida,
	a.qt_dose,
	a.ie_via_aplicacao,
	a.ds_recomendacao,
	a.ds_observacao,
	a.nr_agrupamento,
	a.ds_dias_aplicacao,
	a.qt_min_aplicacao,
	a.ie_bomba_infusao,
	a.cd_intervalo,
	a.qt_hora_aplicacao,
	a.qt_dias_util,
	a.nr_seq_interno,
	a.ie_se_necessario,
	a.ie_aplic_lenta,
	a.ie_urgencia,            
	a.ie_aplic_bolus,
	a.nr_seq_interno,
	a.ie_agrupador,
	coalesce(a.ie_aplica_reducao,'S'),
	coalesce(ie_local_adm,'H'),
	'D',
	nr_seq_mat_diluicao,
	a.ie_acm,
	a.cd_unid_med_prescr,
	a.qt_dose_prescr,
	a.qt_dias_receita,
	a.ie_uso_continuo
from	material b,
	paciente_protocolo_medic a
where	a.cd_material		= b.cd_material
and	a.nr_seq_paciente = nr_seq_paciente_p
and	a.nr_seq_diluicao = nr_seq_material_ww

union all

SELECT	CASE WHEN ie_generico_w='S' THEN coalesce(b.cd_material_generico,a.cd_material)  ELSE a.cd_material END ,
	a.cd_unidade_medida,
	a.qt_dose,
	a.ie_via_aplicacao,
	a.ds_recomendacao,
	a.ds_observacao,
	a.nr_agrupamento,
	a.ds_dias_aplicacao,
	a.qt_min_aplicacao,
	a.ie_bomba_infusao,
	a.cd_intervalo,
	a.qt_hora_aplicacao,
	a.qt_dias_util,
	a.nr_seq_interno,
	a.ie_se_necessario,
	a.ie_aplic_lenta,         
	a.ie_urgencia,            
	a.ie_aplic_bolus,
	a.nr_seq_interno,
	a.ie_agrupador,
	coalesce(a.ie_aplica_reducao,'S'),
	coalesce(ie_local_adm,'H'),
	'M',
	null,
	a.ie_acm,
	a.cd_unid_med_prescr,
	a.qt_dose_prescr,
	a.qt_dias_receita,
	a.ie_uso_continuo
from	material b,
	paciente_protocolo_medic a
where	a.cd_material		= b.cd_material
and	a.nr_seq_paciente = nr_seq_paciente_p
and	a.nr_seq_medic_material = nr_seq_material_ww;


BEGIN

ie_gerar_ciclos_w := obter_param_usuario(6542, 3, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_gerar_ciclos_w);

open c01;
loop
fetch c01 into
	c01_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	ds_texto_w := '';
	nr_agrupamento_w := c01_w.nr_agrupamento;
	ds_dias_aplicacao_w := c01_w.ds_dias_aplicacao;
	cd_material_pac_w := c01_w.cd_material;
	
	-- loop para verificar se os dias do medicamento sao validos
	for indice_w in 1..length(c01_w.ds_dias_aplicacao) loop
		dia_ciclo_w	:= substr(upper(c01_w.ds_dias_aplicacao), indice_w, 1);	
		if (position(dia_ciclo_w in ds_valido_dias_w) > 0) then
			ds_texto_w	:= ds_texto_w || dia_ciclo_w;
		else
			CALL wheb_mensagem_pck.exibir_mensagem_abort(238996); -- Erro na padronizacao dos horarios do mat/med
		end if;
	end loop;
	
	c01_w.ds_dias_aplicacao	:= ds_texto_w;
	indice_dias_w	:= 0;
	c01_w.ds_dias_aplicacao	:= c01_w.ds_dias_aplicacao ||',';
	indice_loop_w	:= 0;
	dias_w.delete;
	
	-- loop para montar o vetor de dias que o medicamento esta inserido
	while (c01_w.ds_dias_aplicacao IS NOT NULL AND c01_w.ds_dias_aplicacao::text <> '') loop
		posicao_virg_w	:= position(',' in c01_w.ds_dias_aplicacao);
		indice_dias_w := indice_dias_w + 1;
		dias_w[indice_dias_w].ds_dias_aplicacao	:= substr(c01_w.ds_dias_aplicacao,1,posicao_virg_w - 1);
		c01_w.ds_dias_aplicacao		:= substr(c01_w.ds_dias_aplicacao,posicao_virg_w + 1,length(c01_w.ds_dias_aplicacao));
		if (position('D' in dias_w[indice_dias_w].ds_dias_aplicacao)	= 0) then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(238996); -- Erro na padronizacao dos horarios do mat/med
		end if;
		indice_loop_w	:= indice_loop_w + 1;
		if (indice_loop_w > 100) then
			exit;
		end if;
	end loop;

	tamanho_vetor_w := dias_w.count;
	indice_while_w := 1;	
	
	open c02;
	loop
	fetch c02 into
		c02_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
	
		delete from paciente_atend_medic
		where nr_seq_atendimento = c02_w.nr_seq_atendimento
		and nr_seq_material = c02_w.nr_seq_material
		and	Obter_Se_Dia_Ciclo_Autorizado(c02_w.nr_seq_atendimento,c02_w.nr_ciclo) = 'N';
	
	end loop;
	close c02;
	
	while(indice_while_w <= tamanho_vetor_w) loop
		dia_w	:= dias_w[indice_while_w].ds_dias_aplicacao;

		open C03;
		loop
		fetch C03 into	
			nr_seq_atendimento_w;
		EXIT WHEN NOT FOUND; /* apply on C03 */
		
			select	coalesce(max(nr_seq_material),0) + 1
			into STRICT	nr_seq_material_w
			from	paciente_atend_medic
			where	nr_seq_atendimento = nr_seq_atendimento_w;
			
			select	nextval('paciente_atend_medic_seq')
			into STRICT	nr_seq_interno_w
			;
			
			select	count(*)
			into STRICT	existe_w
			from	paciente_atend_medic
			where 	nr_seq_atendimento	= nr_seq_atendimento_w
			and		cd_material 		= c01_w.cd_material
			and		nr_agrupamento 		= c01_w.nr_agrupamento;
			
			nr_seq_material_ww	 := c01_w.nr_seq_material;
			
			if (existe_w = 0) then
				insert into paciente_atend_medic(
					nr_seq_atendimento,
					nr_seq_material,
					cd_material,
					dt_atualizacao,
					nm_usuario,
					nr_agrupamento,
					qt_dose,
					qt_dose_prescricao,
					cd_unid_med_dose,
					cd_unid_med_prescr,
					ds_recomendacao,
					ds_observacao,
					ie_via_aplicacao,
					qt_min_aplicacao,
					ie_bomba_infusao,
					cd_intervalo,
					qt_hora_aplicacao,
					qt_dias_util,
					nr_seq_interno,
					nr_seq_prot_medic,
					ie_cancelada,
					ie_administracao,
					ie_checado,
					ie_se_necessario,
					ie_urgencia,            
					ie_aplic_bolus,         
					ie_aplic_lenta,
					nr_seq_int_prot_medic,
					ie_local_adm,
					pr_reducao,
				        ie_uso_continuo) 
				values (
					nr_seq_atendimento_w,
					nr_seq_material_w,
					c01_w.cd_material,
					clock_timestamp(),
					nm_usuario_p,
					c01_w.nr_agrupamento,
					c01_w.qt_dose,
					c01_w.qt_dose_prescr,
					c01_w.cd_unidade_medida,
					c01_w.cd_unid_med_prescr,
					c01_w.ds_recomendacao,
					c01_w.ds_observacao,
					c01_w.ie_via_aplicacao,
					c01_w.qt_min_aplicacao,
					c01_w.ie_bomba_infusao,
					c01_w.cd_intervalo,
					c01_w.qt_hora_aplicacao,
					c01_w.qt_dias_util,
					nr_seq_interno_w,
					c01_w.nr_seq_prot_med,
					'N',
					'P',
					'N',
					c01_w.ie_se_necessario,
					c01_w.ie_urgencia,
					c01_w.ie_aplic_bolus,
					c01_w.ie_aplic_lenta,
					nr_seq_interno_p,
					c01_w.ie_local_adm,
					c01_w.pr_reducao,
				        c01_w.ie_uso_continuo);

				-- insert dos diluentes
				open c04;
				loop
				fetch c04 into
					cd_material_ww,
					cd_unidade_medida_ww,
					qt_dose_ww,
					ie_via_aplicacao_ww,
					ds_recomendacao_ww,
					ds_observacao_ww,
					nr_agrupamento_ww,
					ds_dias_aplicacao_ww,
					qt_min_aplicacao_ww,
					ie_bomba_infusao_ww,
					cd_intervalo_ww,
					qt_hora_aplicacao_ww,
					qt_dias_util_ww,
					nr_seq_interno_ww,
					ie_se_necessario_ww,
					ie_aplic_lenta_ww,
					ie_urgencia_ww,
					ie_aplic_bolus_ww,
					nr_seq_int_prot_medic_w,
					ie_agrupador_w,
					ie_aplica_reducao_ww,
					ie_local_adm_w,
					ie_material_diluiacao_w,
					nr_seq_mat_diluicao_w,
					ie_acm_w,
					cd_unid_med_prescr_dil_w,
					qt_dose_prescr_dil_w,
					qt_dias_receita_w,
					ie_uso_continuo_ww;
				EXIT WHEN NOT FOUND; /* apply on c04 */
					begin
					
					nr_seq_diluicao_www	:= null;
					nr_seq_medic_material_www	:= null;
					if (ie_material_diluiacao_w	= 'M') then
						nr_seq_medic_material_www	:= nr_seq_material_w;
					else
						nr_seq_diluicao_www			:= nr_seq_material_w;
					end if;
					
					select	coalesce(max(nr_seq_material),0) + 1
					into STRICT	nr_seq_mat_dil_w
					from	paciente_atend_medic 
					where	nr_seq_atendimento = nr_seq_atendimento_w;					
					
					select	nextval('paciente_atend_medic_seq')
					into STRICT	nr_seq_interno_w
					;

					insert into paciente_atend_medic(
						nr_seq_atendimento,
						nr_seq_material,
						cd_material,
						dt_atualizacao,
						nm_usuario,
						nr_agrupamento,
						qt_dose,
						cd_unid_med_dose,
						ds_recomendacao,
						ds_observacao,
						ie_via_aplicacao,
						nr_seq_diluicao,
						qt_min_aplicacao,
						ie_bomba_infusao,
						cd_intervalo,
						qt_hora_aplicacao,
						qt_dias_util,
						nr_seq_interno,
						nr_seq_prot_medic,
						ie_cancelada,
						ie_administracao,
						ie_checado,
						ie_se_necessario,
						ie_urgencia,            
						ie_aplic_bolus,         
						ie_aplic_lenta,
						nr_seq_int_prot_medic,
						ie_agrupador,
						ie_aplica_reducao,
						ie_local_adm,
						nr_seq_medic_material,
						nr_seq_mat_diluicao,
						ie_acm,
						cd_unid_med_prescr,
						qt_dose_prescricao,
						qt_dias_receita,
					        ie_uso_continuo)
					values (	nr_seq_atendimento_w,
						nr_seq_mat_dil_w,
						cd_material_ww,
						clock_timestamp(),
						nm_usuario_p,
						nr_agrupamento_ww,
						qt_dose_ww,
						cd_unidade_medida_ww,
						ds_recomendacao_ww,
						ds_observacao_ww,
						ie_via_aplicacao_ww,
						nr_seq_diluicao_www,
						qt_min_aplicacao_ww,
						ie_bomba_infusao_ww,
						cd_intervalo_ww,
						qt_hora_aplicacao_ww,
						qt_dias_util_ww,
						nr_seq_interno_w,
						nr_seq_interno_ww,
						'N',
						'P',
						'N',
						ie_se_necessario_ww,
						ie_urgencia_ww,
						ie_aplic_bolus_ww,
						ie_aplic_lenta_ww,
						nr_seq_int_prot_medic_w,
						ie_agrupador_w,
						ie_aplica_reducao_ww,
						ie_local_adm_w,
						nr_seq_medic_material_www,
						nr_seq_mat_diluicao_w,
						ie_acm_w,
						cd_unid_med_prescr_dil_w,
						qt_dose_prescr_dil_w,
						qt_dias_receita_w,
					        ie_uso_continuo_ww);	

					begin
					select	cd_grupo_material,
							cd_subgrupo_material,
							cd_classe_material
					into STRICT	cd_grupo_material_w,
							cd_subgrupo_material_w,
							cd_classe_material_w
					from	estrutura_material_v
					where	cd_material	= c01_w.cd_material;
					exception
						when others then
						cd_grupo_material_w	:= 0;
						cd_subgrupo_material_w	:= 0;
						cd_classe_material_w	:= 0;
					end;
					
					select	coalesce(max('S'),'N')
					into STRICT	ie_exige_liberacao_w
					from	quimio_drogas_liberacao
					where	coalesce(cd_material,c01_w.cd_material)				= c01_w.cd_material
					and	coalesce(cd_grupo_material,cd_grupo_material_w)		= cd_grupo_material_w
					and	coalesce(cd_subgrupo_material,cd_subgrupo_material_w)= cd_subgrupo_material_w
					and	coalesce(cd_classe_material,cd_classe_material_w)	= cd_classe_material_w
					and cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;

					update	paciente_atendimento
					set		ie_exige_liberacao	= ie_exige_liberacao_w
					where	nr_seq_atendimento	= nr_seq_atendimento_w
					and		ie_exige_liberacao	= 'N';
					
					end;	
				end loop;
				close c04;

			end if;		
		
		end loop;
		close c03;
		
		indice_while_w := indice_while_w + 1;
		
	end loop;
		
end loop;
close c01;

END	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ajustar_dia_medic_trat_conc ( nr_seq_paciente_p bigint, nr_seq_interno_p bigint, nm_usuario_p text) FROM PUBLIC;

