-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ageint_validar_paciente_exame (nr_seq_ageint_p bigint, qt_peso_paciente_p bigint, qt_altura_paciente_p bigint, ie_opcao_p text, ds_erro_p INOUT text, ie_valido_p INOUT text) AS $body$
DECLARE


ds_erro_w				varchar(255) := '';
ie_valido_w				varchar(1) := 'S';
qt_peso_aparelho_w		agenda.qt_peso_max%type;
qt_altura_aparelho_w	agenda.qt_altura_cm%type;
ds_agenda_w				agenda.ds_agenda%type;
cd_agenda_w				agenda.cd_agenda%type;

/*
IE_OPCAO_P:
P = Peso
A = Altura
*/
C01 CURSOR FOR
	SELECT	max(cd_agenda)
	from	ageint_marcacao_usuario
	where	nr_seq_ageint = nr_seq_ageint_p
	and	coalesce(ie_horario_auxiliar,'N') = 'N';


BEGIN

if (nr_seq_ageint_p IS NOT NULL AND nr_seq_ageint_p::text <> '') then

	open C01;
	loop
	fetch C01 into
		cd_agenda_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
			if (cd_agenda_w IS NOT NULL AND cd_agenda_w::text <> '') then

				/* obter peso e altura aparelho */

				select	coalesce(max(qt_peso_max),0),
						coalesce(max(qt_altura_cm),0),
						max(ds_agenda)
				into STRICT	qt_peso_aparelho_w,
						qt_altura_aparelho_w,
						ds_agenda_w
				from	agenda
				where	cd_agenda = cd_agenda_w;

				/* consistir peso aparelho x paciente */

				if (ie_opcao_p = 'P') and (qt_peso_aparelho_w > 0) and (qt_peso_paciente_p > qt_peso_aparelho_w) then

					ie_valido_w := 'N';
					ds_erro_w := ds_erro_w || 'A agenda [' || ds_agenda_w || '] permite pacientes com peso até [' || qt_peso_aparelho_w || ']' || chr(13) || chr(10);

				end if;

				/* consistir altura aparelho x paciente */

				if (ie_opcao_p = 'A') and (qt_altura_aparelho_w > 0) and (qt_altura_paciente_p > qt_altura_aparelho_w) then

					ie_valido_w := 'N';
					ds_erro_w := ds_erro_w || 'A agenda [' || ds_agenda_w || '] permite pacientes com altura até [' || qt_altura_aparelho_w || ']' || chr(13) || chr(10);

				end if;
			end if;
		end;
	end loop;
	close C01;
end if;

ds_erro_p := ds_erro_w;
ie_valido_p := ie_valido_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageint_validar_paciente_exame (nr_seq_ageint_p bigint, qt_peso_paciente_p bigint, qt_altura_paciente_p bigint, ie_opcao_p text, ds_erro_p INOUT text, ie_valido_p INOUT text) FROM PUBLIC;

