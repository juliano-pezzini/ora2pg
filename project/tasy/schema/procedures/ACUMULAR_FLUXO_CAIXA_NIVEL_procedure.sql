-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE acumular_fluxo_caixa_nivel (cd_estabelecimento_p bigint, Dt_inicio_p timestamp, dt_final_p timestamp, ie_periodo_p text, ie_classif_p text, nm_usuario_p text, cd_empresa_p bigint, cd_moeda_p bigint default null, ie_restringe_estab_p text DEFAULT NULL) AS $body$
DECLARE


/*--------------------------------------------------------------- ATENÇÃO ----------------------------------------------------------------*/

/* Cuidado ao realizar alterações no fluxo de caixa. Toda e qualquer alteração realizada em qualquer uma das       */

/* procedures do fluxo de caixa deve ser cuidadosamente verificada e realizada no fluxo de caixa em lote.           */

/* Devemos garantir que os dois fluxos de caixa tragam os mesmos valores no resultado, evitando assim que           */

/* existam diferenças entre os fluxos de caixa.                                                                                                                */

/*--------------- AO ALTERAR O FLUXO DE CAIXA ALTERAR TAMBÉM O FLUXO DE CAIXA EM LOTE ---------------*/

vl_fluxo_w			double precision;/*AAMFIRMO OS 869909 alterei de 15,2 para 16,3 devido a problema de arredondamento. Na gerar_fluxo_caixa_passado  ja esta 16,3 e também no atributo vl_fluxo da fluxo_caixa*/
cd_conta_financ_w		bigint;
dt_referencia_w			timestamp;
cd_conta_superior_w		bigint;
cd_conta_anterior_w		bigint;
ie_origem_w			varchar(01) := 'C';
dt_inicio_calculo_w		timestamp;
ds_conta_w			varchar(2000);
qt_repeticao_w			bigint;
ds_conta_financ_w		varchar(255);
dt_inicio_w			timestamp;
dt_final_w			timestamp;
/* Projeto Multimoeda - Variáveis */

cd_moeda_estrang_w		integer;
cd_moeda_empresa_w		integer;


C010 CURSOR FOR
SELECT 	a.dt_referencia,
	a.cd_conta_financ,
	CASE WHEN ie_oper_fluxo='S' THEN  a.vl_fluxo WHEN ie_oper_fluxo='D' THEN  a.vl_fluxo * -1  ELSE 0 END ,
	b.cd_conta_superior
from 	Conta_Financeira b,
	fluxo_caixa a
where	a.dt_referencia		between dt_inicio_w and dt_final_w
and	a.ie_classif_fluxo		= ie_classif_p
--and	a.ie_periodo = ie_periodo_p /*AAMFIRMO Retirei a tratativa ao lado e coloquei a nova abaixo, pois quando o fluxo de caixa é vencido, gera periodo como X. Se inserir no fluxo de caixa uma conta manual,  o periodo so pode ser D ou M, nunca sendo aberto neste cursor OS 930285*/
and	CASE WHEN ie_classif_p='V' THEN 'X'  ELSE a.ie_periodo END 		= CASE WHEN ie_classif_p='V' THEN 'X'  ELSE ie_periodo_p END
and	a.cd_conta_financ		= b.cd_conta_financ
and 	((obter_se_filtro_fluxo(a.nr_seq_conta_banco, null, null, nm_usuario_p, null) ='S') or (ie_origem<>'D'))
AND	(((ie_restringe_estab_p IS NOT NULL AND ie_restringe_estab_p::text <> '') AND 	(
						(
							(coalesce(ie_restringe_estab_p,'E') = 'E') AND (a.cd_estabelecimento	=  cd_estabelecimento_p )
						) OR
						(
							(coalesce(ie_restringe_estab_p,'E') = 'S') AND
						(
							(a.cd_estabelecimento	= cd_estabelecimento_p) OR (obter_estab_financeiro(a.cd_estabelecimento) =  cd_estabelecimento_p )
						)
						) OR
						(
							(coalesce(  ie_restringe_estab_p ,'E') = 'N' and a.cd_empresa = cd_empresa_p)/*OS 1323065 - Tava trazendo de todas as empresas. Se n restringe estab, tem que trazer de todos estab da empresa do estab logado*/
						))
	) OR (coalesce(ie_restringe_estab_p::text, '') = '' AND  a.cd_estabelecimento	= cd_estabelecimento_p))
and	coalesce(a.cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w)  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
and	b.ie_oper_fluxo		<> 'I'			-- Conta financeira informativa não acumula saldo e conta superior
order	by a.dt_referencia;


BEGIN

dt_inicio_w		:= dt_inicio_p;
dt_final_w		:= dt_final_p;
if (ie_periodo_p = 'M') then
	dt_inicio_w	:= trunc(dt_inicio_p, 'month');
	dt_final_w	:= fim_mes(dt_final_p);
end if;

/* Projeto Multimoeda - Busca a moeda padrão da empresa e verifica o parâmetro cd_moeda passado na procedure. Ele será a base da busca dos dados
		em moeda estrangeira. Caso o parâmetro seja nulo, deverá ser considerada a moeda padrão da empresa nas consultas,
		caso contrário irá buscar somente os dados na moeda selecionada.*/
select obter_moeda_padrao_empresa(cd_estabelecimento_p,'E')
into STRICT cd_moeda_empresa_w
;
if (coalesce(cd_moeda_p::text, '') = '') then
	cd_moeda_estrang_w := cd_moeda_empresa_w;
else
	cd_moeda_estrang_w := cd_moeda_p;
end if;

OPEN C010;
LOOP
FETCH C010 into
	dt_referencia_w,
	cd_conta_Financ_w,
	vl_fluxo_w,
	cd_conta_superior_w;
EXIT WHEN NOT FOUND; /* apply on c010 */

	cd_conta_anterior_w		:= 9999999999;
	qt_repeticao_w			:= 0;


	while(cd_conta_superior_w IS NOT NULL AND cd_conta_superior_w::text <> '') and (cd_conta_anterior_w	<> cd_conta_superior_w) LOOP

		cd_conta_anterior_w	:= cd_conta_superior_w;
		qt_repeticao_w	:= qt_repeticao_w + 1;

		if (length(ds_conta_w) < 1980) then
			ds_conta_w	:= ds_conta_w + cd_conta_superior_w || ',';
		end if;

		if (qt_repeticao_w > 150) then

			select 	ds_conta_financ
			into STRICT	ds_conta_financ_w
			from	conta_financeira
			where	cd_conta_financ	= cd_conta_Financ_w;

			/* A estrutura da conta financeira está recursiva
			ds_conta_financ_w */
			CALL wheb_mensagem_pck.exibir_mensagem_abort(262735,'DS_CONTA_FINANC_W='||ds_conta_financ_w);
		end if;


		begin
		insert into fluxo_caixa(
			cd_estabelecimento,
			dt_referencia,
			cd_conta_financ,
			ie_classif_fluxo,
			dt_atualizacao,
			nm_usuario,
			vl_fluxo,
			ie_origem,
			ie_periodo,
			ie_integracao,
			cd_empresa,
			cd_moeda)
		Values (	cd_estabelecimento_p,
			dt_referencia_w,
			cd_conta_superior_w,
			ie_classif_p,
			clock_timestamp(),
			nm_usuario_p,
			vl_fluxo_w,
			ie_origem_w,
			ie_periodo_p,
			'S',
			cd_empresa_p,
			coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w));
		exception
		when others then
			update	fluxo_caixa
			set	vl_fluxo 		= vl_fluxo + vl_fluxo_w
			where	cd_estabelecimento	= cd_estabelecimento_p
		  	and	dt_referencia		= dt_referencia_w
		  	and	cd_conta_financ		= cd_conta_superior_w
			and	ie_classif_fluxo	= ie_classif_p
		 	and	ie_periodo		= ie_periodo_p
			and	ie_integracao		= 'S'
			and	cd_empresa		= cd_empresa_p
			and	coalesce(cd_moeda,cd_moeda_empresa_w) = coalesce(cd_moeda_estrang_w,cd_moeda_empresa_w);  --Projeto Multimoeda - Busca apenas os registros da moeda relacionada
		end;

		select	cd_conta_superior
		into STRICT	cd_conta_superior_w
		from	conta_financeira
		where	cd_conta_financ	= cd_conta_superior_w;

	END LOOP;

END LOOP;
CLOSE C010;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE acumular_fluxo_caixa_nivel (cd_estabelecimento_p bigint, Dt_inicio_p timestamp, dt_final_p timestamp, ie_periodo_p text, ie_classif_p text, nm_usuario_p text, cd_empresa_p bigint, cd_moeda_p bigint default null, ie_restringe_estab_p text DEFAULT NULL) FROM PUBLIC;

