-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_fluxo_caixa_lote_classif ( nr_seq_lote_fluxo_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_tit_rec_p text, ie_tit_pagar_p text, ie_cheque_p text, ie_cartao_p text, ie_conv_receb_p text, ie_protocolo_p text, ie_ordem_compra_p text, ie_conttrato_p text, ie_fluxo_especial_p text, ie_agenda_p text, ie_bordero_pagar_p text, ie_pagto_escrit_p text) AS $body$
DECLARE

 
/*--------------------------------------------------------------- ATENÇÃO ----------------------------------------------------------------*/
 
/* Cuidado ao realizar alterações no fluxo de caixa em lote. Toda e qualquer alteração realizada em qualquer uma */
 
/* das procedures do fluxo de caixa em lote deve ser cuidadosamente verificada e realizada no fluxo de caixa   */
 
/* convencional. Devemos garantir que os dois fluxos de caixa tragam os mesmos valores no resultado, evitando   */
 
/* assim que existam diferenças entre os fluxos de caixa.                                                */
 
/*--------------- AO ALTERAR O FLUXO DE CAIXA EM LOTE ALTERAR TAMBÉM O FLUXO DE CAIXA ---------------*/
 
 
ie_classif_fluxo_w	fluxo_caixa_lote.ie_classif_fluxo%type;
ie_tipo_fluxo_w		varchar(1);
nr_seq_tipo_hist_w	bigint;
ds_historico_w		fluxo_caixa_lote_hist.ds_historico%type;


BEGIN 
 
select	a.ie_classif_fluxo, 
	CASE WHEN ie_classif_fluxo_w='T' THEN 'V'  ELSE 'R' END  
into STRICT	ie_classif_fluxo_w, 
	ie_tipo_fluxo_w 
from	fluxo_caixa_lote a 
where	a.nr_sequencia = nr_seq_lote_fluxo_p;
 
if (ie_classif_fluxo_w = 'O') then 
	CALL GERAR_FLUXO_CAIXA_ORCADO_LOTE(	nr_seq_lote_fluxo_p, 
					cd_estabelecimento_p, 
					nm_usuario_p);
elsif (ie_classif_fluxo_w = 'V') then 
	CALL GERAR_FLUXO_CAIXA_LOT_VENCIDO(	nr_seq_lote_fluxo_p, 
					cd_estabelecimento_p, 
					nm_usuario_p);
elsif (ie_classif_fluxo_w = 'P') or (ie_classif_fluxo_w = 'E') then 
	CALL GERAR_FLUXO_CAIXA_LOTE_PASSADO(	nr_seq_lote_fluxo_p, 
					cd_estabelecimento_p, 
					nm_usuario_p);
elsif (ie_classif_fluxo_w = 'R') or (ie_classif_fluxo_w = 'T') then	 
	 
	/*OS 1430443 - Se for previsto, precisa passar o tipo como V (previsto)e não R (A realizar)*/
 
	if (ie_classif_fluxo_w = 'T') then 
		ie_tipo_fluxo_w := 'V';
	end if;
 
	CALL GERAR_FLUXO_CAIXA_LOTE_REAL(	nr_seq_lote_fluxo_p, 
					cd_estabelecimento_p, 
					nm_usuario_p, 
					ie_tit_rec_p, 
					ie_tit_pagar_p, 
					ie_cheque_p, 
					ie_cartao_p, 
					ie_conv_receb_p, 
					ie_protocolo_p, 
					ie_ordem_compra_p, 
					ie_conttrato_p, 
					ie_fluxo_especial_p, 
					ie_agenda_p, 
					ie_bordero_pagar_p, 
					ie_pagto_escrit_p, 
					ie_tipo_fluxo_w);
end if;
 
if (ie_classif_fluxo_w = 'P') then 
	nr_seq_tipo_hist_w	:= 290751; -- Gerado o fluxo de caixa lote "Passado" 
elsif (ie_classif_fluxo_w = 'E') then
	nr_seq_tipo_hist_w	:= 343587; -- Gerado o fluxo de caixa lote "Moeda estrangeira" 
elsif (ie_classif_fluxo_w = 'R') then
	nr_seq_tipo_hist_w	:= 290752; -- Gerado o fluxo de caixa lote "A Realizar" 
elsif (ie_classif_fluxo_w = 'T') then
	nr_seq_tipo_hist_w	:= 290753; -- Gerado o fluxo de caixa lote "Previsto" 
elsif (ie_classif_fluxo_w = 'O') then
	nr_seq_tipo_hist_w	:= 290754; -- Gerado o fluxo de caixa lote "Orçado" 
elsif (ie_classif_fluxo_w = 'V') then
	nr_seq_tipo_hist_w	:= 290755; -- Gerado o fluxo de caixa lote "Vencido" 
end if;
 
ds_historico_w	:= substr(wheb_mensagem_pck.get_texto(nr_seq_tipo_hist_w),1,4000);
 
CALL GERAR_HISTORICO_FLUXO_LOTE(	nr_seq_lote_fluxo_p, 
				'S', 
				ds_historico_w, 
				nm_usuario_p);
 
update	fluxo_caixa_lote 
set	dt_geracao	= clock_timestamp(), 
	ie_alterado	= 'N' 
where	nr_sequencia	= nr_seq_lote_fluxo_p;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_fluxo_caixa_lote_classif ( nr_seq_lote_fluxo_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_tit_rec_p text, ie_tit_pagar_p text, ie_cheque_p text, ie_cartao_p text, ie_conv_receb_p text, ie_protocolo_p text, ie_ordem_compra_p text, ie_conttrato_p text, ie_fluxo_especial_p text, ie_agenda_p text, ie_bordero_pagar_p text, ie_pagto_escrit_p text) FROM PUBLIC;

