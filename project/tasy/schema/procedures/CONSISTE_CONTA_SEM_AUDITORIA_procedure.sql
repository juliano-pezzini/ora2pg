-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_conta_sem_auditoria ( nr_interno_conta_p bigint, ds_erro_p INOUT text) AS $body$
DECLARE


qt_regra_audit_conta_w		bigint;
cd_setor_atendimento_w		integer;
cd_convenio_w			integer;
ie_tipo_atendimento_w		smallint;
qt_auditoria_w			bigint;
ds_erro_w			varchar(255);
qt_reg_setor_audit_conta_w	bigint;
qt_audit_setor_w		bigint;
cd_item_w			bigint;
ie_origem_item_w		bigint;
ie_tipo_w			varchar(1);
cd_grupo_material_w		smallint;
cd_subgrupo_material_w		smallint;
cd_classe_material_w		integer;
cd_grupo_proc_w			bigint;
cd_especialidade_w		bigint;
cd_area_procedimento_w		bigint;
nr_seq_item_w			bigint;
qt_audit_item_w			bigint;
ie_tipo_guia_conta_w            CONTA_PACIENTE.IE_TIPO_GUIA%TYPE;
cd_estab_conta_w                CONTA_PACIENTE.CD_ESTABELECIMENTO%TYPE;

C01 CURSOR FOR
	SELECT	x.cd_setor_atendimento,
		x.cd_item,
		x.ie_origem_proced,
		x.ie_tipo,
		x.nr_sequencia
	from (
		SELECT	a.cd_setor_atendimento,
			a.cd_procedimento cd_item,
			a.ie_origem_proced ie_origem_proced,
			'P' ie_tipo,
			a.nr_sequencia
		from	procedimento_paciente a
		where	a.nr_interno_conta = nr_interno_conta_p
		
union all

		select	a.cd_setor_atendimento,
			a.cd_material cd_item,
			null ie_origem_proced,
			'M' ie_tipo,
			a.nr_sequencia
		from	material_atend_paciente a
		where	a.nr_interno_conta = nr_interno_conta_p
		) x;


BEGIN

select	count(*)
into STRICT	qt_regra_audit_conta_w
from	regra_auditoria_conta
where	ie_situacao = 'A';

if (qt_regra_audit_conta_w > 0) and (coalesce(nr_interno_conta_p,0) <> 0) then

	select	max(a.cd_convenio_parametro),
                max(b.ie_tipo_atendimento),
                max(a.ie_tipo_guia),
                max(a.cd_estabelecimento)
	into STRICT	cd_convenio_w,
                ie_tipo_atendimento_w,
                ie_tipo_guia_conta_w,
                cd_estab_conta_w
	from	conta_paciente a,
		atendimento_paciente b
	where	a.nr_atendimento = b.nr_atendimento
	and	a.nr_interno_conta = nr_interno_conta_p;

	open C01;
	loop
	fetch C01 into
		cd_setor_atendimento_w,
		cd_item_w,
		ie_origem_item_w,
		ie_tipo_w,
		nr_seq_item_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		if (ie_tipo_w = 'M') then

			select 	coalesce(max(cd_grupo_material),0),
				coalesce(max(cd_subgrupo_material),0),
				coalesce(max(cd_classe_material),0)
			into STRICT	cd_grupo_material_w,
				cd_subgrupo_material_w,
				cd_classe_material_w
			from	estrutura_material_v
			where 	cd_material = cd_item_w;

			select	count(*)
			into STRICT	qt_reg_setor_audit_conta_w
			from	regra_auditoria_conta
			where	coalesce(cd_convenio, coalesce(cd_convenio_w,0)) = coalesce(cd_convenio_w,0)
			and	coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w,0)) = coalesce(ie_tipo_atendimento_w,0)
			and	coalesce(cd_setor_atendimento, coalesce(cd_setor_atendimento_w,0)) = coalesce(cd_setor_atendimento_w,0)
			and	coalesce(cd_material, cd_item_w)			  = cd_item_w
			and	coalesce(cd_grupo_material, cd_grupo_material_w)	  = cd_grupo_material_w
			and	coalesce(cd_subgrupo_material, cd_subgrupo_material_w)   = cd_subgrupo_material_w
			and	coalesce(cd_classe_material, cd_classe_material_w)	    = cd_classe_material_w
                        and     coalesce(ie_tipo_guia,coalesce(ie_tipo_guia_conta_w,0))       = coalesce(ie_tipo_guia_conta_w,0)
                        and     coalesce(cd_estab_conta, cd_estab_conta_w)               = cd_estab_conta_w
			and	ie_situacao = 'A';

		else

			select	coalesce(max(cd_grupo_proc),0),
				coalesce(max(cd_especialidade),0),
				coalesce(max(cd_area_procedimento),0)
			into STRICT	cd_grupo_proc_w,
				cd_especialidade_w,
				cd_area_procedimento_w
			from 	estrutura_procedimento_v
			where 	cd_procedimento = cd_item_w
			and 	ie_origem_proced = ie_origem_item_w;

			select	count(*)
			into STRICT	qt_reg_setor_audit_conta_w
			from	regra_auditoria_conta
			where	coalesce(cd_convenio, coalesce(cd_convenio_w,0)) = coalesce(cd_convenio_w,0)
			and	coalesce(ie_tipo_atendimento, coalesce(ie_tipo_atendimento_w,0)) = coalesce(ie_tipo_atendimento_w,0)
			and	coalesce(cd_setor_atendimento, coalesce(cd_setor_atendimento_w,0)) = coalesce(cd_setor_atendimento_w,0)
			and	coalesce(cd_procedimento,cd_item_w) 			 = cd_item_w
			and	coalesce(ie_origem_proced,ie_origem_item_w)		 = ie_origem_item_w
			and	coalesce(cd_area_procedimento,cd_area_procedimento_w) = cd_area_procedimento_w
			and	coalesce(cd_especialidade,cd_especialidade_w)	 = cd_especialidade_w
			and	coalesce(cd_grupo_proc,cd_grupo_proc_w)		 = cd_grupo_proc_w
                        and     coalesce(ie_tipo_guia,coalesce(ie_tipo_guia_conta_w,0))    = coalesce(ie_tipo_guia_conta_w,0)
                        and     coalesce(cd_estab_conta, cd_estab_conta_w)            = cd_estab_conta_w
			and	ie_situacao = 'A';

		end if;

		if (qt_reg_setor_audit_conta_w = 0) then

			select	count(*)
			into STRICT	qt_audit_setor_w
			from	auditoria_conta_paciente
			where	nr_interno_conta = nr_interno_conta_p
			and	coalesce(cd_setor_atendimento, coalesce(cd_setor_atendimento_w,0)) = coalesce(cd_setor_atendimento_w,0);

			if (ie_tipo_w = 'M') then

				select	count(*)
				into STRICT	qt_audit_item_w
				from 	auditoria_matpaci a,
					auditoria_conta_paciente b
				where 	b.nr_sequencia = a.nr_seq_auditoria
				and 	b.nr_interno_conta = nr_interno_conta_p
				and 	a.nr_seq_matpaci = nr_seq_item_w;

			else

				select	count(*)
				into STRICT	qt_audit_item_w
				from 	auditoria_propaci a,
					auditoria_conta_paciente b
				where 	b.nr_sequencia = a.nr_seq_auditoria
				and 	b.nr_interno_conta = nr_interno_conta_p
				and 	a.nr_seq_propaci = nr_seq_item_w;

			end if;


			if (qt_audit_setor_w = 0) or (qt_audit_item_w = 0) then
				ds_erro_w := '3013 ';
			end if;

		end if;

		end;
	end loop;
	close C01;

else

	begin
	select	count(*)
	into STRICT	qt_auditoria_w
	from	auditoria_conta_paciente a
	where	a.nr_interno_conta	= nr_interno_conta_p;
	exception
		when others then
			qt_auditoria_w	:= 0;
	end;

	if (qt_auditoria_w = 0) then
		ds_erro_w := '3013 ';
	end if;

end if;

ds_erro_p	:= ds_erro_w;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_conta_sem_auditoria ( nr_interno_conta_p bigint, ds_erro_p INOUT text) FROM PUBLIC;

