-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_regra_repasse ( nr_seq_regra_origem_p bigint, cd_regra_destino_p bigint, ie_opcao_p text, nm_usuario_p text, nr_seq_regra_gerada_p INOUT bigint) AS $body$
DECLARE


/* ie_opcao_p
'P'	procedimento
'M'	Material
*/
nr_seq_regra_gerada_w	bigint;
nr_seq_material_w		bigint;
nr_seq_adicional_w	bigint;
nr_seq_dia_w		bigint;
nr_seq_procedimento_w	bigint;

c01 CURSOR FOR
SELECT	a.nr_sequencia
from	proc_criterio_rep_mat a
where	a.nr_seq_criterio	= nr_seq_regra_origem_p;

c02 CURSOR FOR
SELECT	a.nr_sequencia
from	proc_crit_repasse_adic a
where	a.nr_seq_criterio	= nr_seq_regra_origem_p;

c03 CURSOR FOR
SELECT	a.nr_sequencia
from	proc_crit_repasse_dia a
where	a.nr_seq_criterio	= nr_seq_regra_origem_p;

c04 CURSOR FOR
SELECT	a.nr_sequencia
from	mat_criterio_rep_proc a
where	a.nr_seq_criterio	= nr_seq_regra_origem_p;


BEGIN

if (ie_opcao_p	= 'P') then

	select	nextval('proc_criterio_repasse_seq')
	into STRICT	nr_seq_regra_gerada_w
	;

	insert	into proc_criterio_repasse(ie_funcao,
		cd_edicao_amb,
		ie_tipo_convenio,
		cd_convenio,
		cd_categoria,
		ie_tipo_atendimento,
		ie_carater_inter_sus,
		cd_plano,
		ie_clinica,
		cd_setor_atendimento,
		cd_especialidade,
		cd_medico_prescr,
		cd_area_proced,
		cd_especial_proced,
		cd_grupo_proced,
		cd_procedimento,
		ie_origem_proced,
		nr_seq_proc_interno,
		nr_seq_exame,
		cd_equipamento,
		ie_honorario,
		ie_honorario_restricao,
		ie_pacote,
		ie_forma_calculo,
		vl_repasse,
		tx_procedimento,
		tx_materiais,
		tx_auxiliares,
		tx_medico,
		tx_custo_operacional,
		tx_anestesista,
		ie_perc_pacote,
		vl_limite,
		ie_atend_retorno,
		cd_tabela_preco,
		cd_convenio_calc,
		cd_categoria_calc,
		cd_edicao_amb_calc,
		ie_tipo_atend_calc,
		cd_situacao_glosa,
		cd_prestador,
		ie_tipo_servico_sus,
		ie_tipo_ato_sus,
		dt_vigencia_inicial,
		dt_vigencia_final,
		cd_grupo_proc_aih,
		hr_inicial,
		hr_final,
		cd_municipio_ibge,
		cd_registro,
		cd_medico_laudo,
		cd_medico_req,
		ie_cobra_pf_pj,
		ie_regra_medico,
		cd_med_exec_proc_princ,
		cd_pessoa_func,
		qt_dia_inicial,
		qt_dia_final,
		qt_porte_anestesico,
		cd_procedencia,
		ie_regra_dia,
		ie_plantao,
		ie_med_plantonista,
		ie_med_exec_socio,
		ie_participou_sus,
		ie_conveniado,
		ie_repasse_calc,
		cd_regra,
		dt_atualizacao,
		nm_usuario,
		nr_sequencia,
		ie_situacao,
		cd_medico,
		ie_prioridade,
		cd_tipo_procedimento,
		nm_usuario_nrec,
		dt_atualizacao_nrec)
	SELECT	a.ie_funcao,
		a.cd_edicao_amb,
		a.ie_tipo_convenio,
		a.cd_convenio,
		a.cd_categoria,
		a.ie_tipo_atendimento,
		a.ie_carater_inter_sus,
		a.cd_plano,
		a.ie_clinica,
		a.cd_setor_atendimento,
		a.cd_especialidade,
		a.cd_medico_prescr,
		a.cd_area_proced,
		a.cd_especial_proced,
		a.cd_grupo_proced,
		a.cd_procedimento,
		a.ie_origem_proced,
		a.nr_seq_proc_interno,
		a.nr_seq_exame,
		a.cd_equipamento,
		a.ie_honorario,
		a.ie_honorario_restricao,
		a.ie_pacote,
		a.ie_forma_calculo,
		a.vl_repasse,
		a.tx_procedimento,
		a.tx_materiais,
		a.tx_auxiliares,
		a.tx_medico,
		a.tx_custo_operacional,
		a.tx_anestesista,
		a.ie_perc_pacote,
		a.vl_limite,
		a.ie_atend_retorno,
		a.cd_tabela_preco,
		a.cd_convenio_calc,
		a.cd_categoria_calc,
		a.cd_edicao_amb_calc,
		a.ie_tipo_atend_calc,	
		a.cd_situacao_glosa,
		a.cd_prestador,
		a.ie_tipo_servico_sus,
		a.ie_tipo_ato_sus,
		a.dt_vigencia_inicial,
		a.dt_vigencia_final,
		a.cd_grupo_proc_aih,
		a.hr_inicial,
		a.hr_final,
		a.cd_municipio_ibge,
		a.cd_registro,
		a.cd_medico_laudo,
		a.cd_medico_req,
		a.ie_cobra_pf_pj,
		a.ie_regra_medico,
		a.cd_med_exec_proc_princ,
		a.cd_pessoa_func,
		a.qt_dia_inicial,
		a.qt_dia_final,
		a.qt_porte_anestesico,
		a.cd_procedencia,
		a.ie_regra_dia,
		a.ie_plantao,
		a.ie_med_plantonista,
		a.ie_med_exec_socio,
		a.ie_participou_sus,
		a.ie_conveniado,
		a.ie_repasse_calc,
		cd_regra_destino_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_regra_gerada_w,
		'A',
		a.cd_medico,
		a.ie_prioridade,
		a.cd_tipo_procedimento,
		nm_usuario_p,
		clock_timestamp()
	from	proc_criterio_repasse a
	where	a.nr_sequencia	= nr_seq_regra_origem_p;

	open c01;
	loop
	fetch c01 into
		nr_seq_material_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */

		insert	into proc_criterio_rep_mat(cd_material,
			dt_atualizacao,
			nm_usuario,
			nr_seq_criterio,
			nr_sequencia,
			nm_usuario_nrec,
			dt_atualizacao_nrec)
		SELECT	a.cd_material,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_regra_gerada_w,
			nextval('proc_criterio_rep_mat_seq'),
			nm_usuario_p,
			clock_timestamp()
		from	proc_criterio_rep_mat a
		where	a.nr_sequencia	= nr_seq_material_w;

	end loop;
	close c01;

	open c02;
	loop
	fetch c02 into
		nr_seq_adicional_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */

		insert	into proc_crit_repasse_adic(ds_function,
			dt_atualizacao,
			nm_usuario,
			nr_seq_criterio,
			nr_sequencia,
			nm_usuario_nrec,
			dt_atualizacao_nrec)
		SELECT	a.ds_function,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_regra_gerada_w,
			nextval('proc_crit_repasse_adic_seq'),
			nm_usuario_p,
			clock_timestamp()
		from	proc_crit_repasse_adic a
		where	a.nr_sequencia	= nr_seq_adicional_w;

	end loop;
	close c02;

	open c03;
	loop
	fetch c03 into
		nr_seq_dia_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */

		insert	into proc_crit_repasse_dia(dt_atualizacao,
			ie_dia_semana,
			nm_usuario,
			nr_seq_criterio,
			nr_sequencia,
			nm_usuario_nrec,
			dt_atualizacao_nrec)
		SELECT	clock_timestamp(),
			a.ie_dia_semana,
			nm_usuario_p,
			nr_seq_regra_gerada_w,
			nextval('proc_crit_repasse_dia_seq'),
			nm_usuario_p,
			clock_timestamp()
		from	proc_crit_repasse_dia a
		where	a.nr_sequencia	= nr_seq_dia_w;

	end loop;
	close c03;

elsif (ie_opcao_p	= 'M') then

	select	nextval('mat_criterio_repasse_seq')
	into STRICT	nr_seq_regra_gerada_w
	;

	insert	into mat_criterio_repasse(cd_edicao_amb,
		ie_tipo_convenio,
		cd_convenio,
		cd_categoria,
		cd_plano,
		cd_setor_atendimento,
		ie_tipo_atendimento,
		ie_carater_inter_sus,
		cd_grupo_material,
		cd_subgrupo_material,
		cd_classe_material,
		cd_material,
		ie_pacote,
		ie_forma_calculo,
		tx_repasse,
		vl_repasse,
		cd_tabela_preco,
		cd_tab_preco_calc,
		cd_convenio_calc,
		cd_categoria_calc,
		cd_cgc_prestador,
		cd_cgc_fornecedor,
		cd_municipio_ibge,
		ie_regra_medico,
		dt_vigencia_inicial,
		dt_vigencia_final,
		cd_med_exec_proc_princ,
		ie_atend_retorno,
		ie_repasse_calc,
		ie_perc_pacote,
		cd_regra,
		dt_atualizacao,
		nm_usuario,
		nr_sequencia,
		ie_situacao,
		cd_medico,
		nr_seq_grupo_rec,
		ie_prioridade,
		nm_usuario_nrec,
		dt_atualizacao_nrec)
	SELECT	a.cd_edicao_amb,
		a.ie_tipo_convenio,
		a.cd_convenio,
		a.cd_categoria,
		a.cd_plano,
		a.cd_setor_atendimento,
		a.ie_tipo_atendimento,
		a.ie_carater_inter_sus,
		a.cd_grupo_material,
		a.cd_subgrupo_material,
		a.cd_classe_material,
		a.cd_material,
		a.ie_pacote,
		a.ie_forma_calculo,
		a.tx_repasse,
		a.vl_repasse,
		a.cd_tabela_preco,
		a.cd_tab_preco_calc,
		a.cd_convenio_calc,
		a.cd_categoria_calc,
		a.cd_cgc_prestador,
		a.cd_cgc_fornecedor,
		a.cd_municipio_ibge,
		a.ie_regra_medico,
		a.dt_vigencia_inicial,
		a.dt_vigencia_final,
		a.cd_med_exec_proc_princ,
		a.ie_atend_retorno,
		a.ie_repasse_calc,
		a.ie_perc_pacote,
		cd_regra_destino_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_regra_gerada_w,
		'A',
		a.cd_medico,
		nr_seq_grupo_rec,
		a.ie_prioridade,
		nm_usuario_p,
		clock_timestamp()
	from	mat_criterio_repasse a
	where	a.nr_sequencia	= nr_seq_regra_origem_p;

	open c04;
	loop
	fetch c04 into
		nr_seq_procedimento_w;
	EXIT WHEN NOT FOUND; /* apply on c04 */

		insert	into mat_criterio_rep_proc(cd_area_procedimento,
			cd_especialidade_proc,
			cd_grupo_proc,
			cd_procedimento,
			ie_origem_proced,
			ie_proc_princ,
			dt_atualizacao,
			nm_usuario,
			nr_seq_criterio,
			nr_sequencia,
			nm_usuario_nrec,
			dt_atualizacao_nrec)
		SELECT	a.cd_area_procedimento,
			a.cd_especialidade_proc,
			a.cd_grupo_proc,
			a.cd_procedimento,
			a.ie_origem_proced,
			a.ie_proc_princ,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_regra_gerada_w,
			nextval('mat_criterio_rep_proc_seq'),
			nm_usuario_p,
			clock_timestamp()
		from	mat_criterio_rep_proc a
		where	a.nr_sequencia	= nr_seq_procedimento_w;

	end loop;
	close c04;

end if;

nr_seq_regra_gerada_p	:= nr_seq_regra_gerada_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_regra_repasse ( nr_seq_regra_origem_p bigint, cd_regra_destino_p bigint, ie_opcao_p text, nm_usuario_p text, nr_seq_regra_gerada_p INOUT bigint) FROM PUBLIC;

