-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dc_receive_remittance ( cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

  cd_convenio_w convenio.cd_convenio%type;
  nr_patient_account_w conta_paciente.nr_interno_conta%type;
  nr_sequencia_w bigint;
  c01 CURSOR FOR
    SELECT * from dc_era_report where ie_status = 1;
  c01_w c01%rowtype;

BEGIN
  open c01;
  loop
    fetch c01 into c01_w;
    EXIT WHEN NOT FOUND; /* apply on c01 */
    begin
      select obter_conversao_interna_int(null, 'CONTA_PACIENTE','INVOICE_ID',c01_w.nr_invoice_id,'DC')
      into STRICT nr_patient_account_w
;
      if (nr_patient_account_w > 0) then
        select cd_convenio_parametro
        into STRICT cd_convenio_w
        from conta_paciente
        where nr_interno_conta = nr_patient_account_w;
        select coalesce(max(nr_sequencia),0)
        into STRICT nr_sequencia_w
        from convenio_receb
        where cd_convenio  = cd_convenio_w
        and ie_status     in ('N', 'P');
        if (nr_sequencia_w > 0) then
          update convenio_receb
          set vl_recebimento = vl_recebimento + c01_w.vl_deposit_amount_payment
          where nr_sequencia = nr_sequencia_w;
        else
          begin
            select nextval('convenio_receb_seq') into STRICT nr_sequencia_w;
            insert
            into convenio_receb(
                nr_sequencia,
                cd_convenio,
                dt_recebimento,
                vl_recebimento,
                dt_atualizacao,
                nm_usuario,
                ie_status, --N
                cd_estabelecimento,
                ie_integrar_cb_fluxo, --N
                ds_observacao,
                dt_liberacao
              )
              values (
                nr_sequencia_w,
                cd_convenio_w,
                coalesce(c01_w.dt_payment_run_date,clock_timestamp()),
                c01_w.vl_deposit_amount_payment,
                clock_timestamp(),
                nm_usuario_p,
                'N',
                cd_estabelecimento_p,
                'N',
                null,
                clock_timestamp()
              );
          end;
        end if;
        update dc_era_report
        set ie_status      = 2
        where nr_sequencia = c01_w.nr_sequencia;
        commit;
      end if;
    end;
  end loop;
  close c01;
  commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dc_receive_remittance ( cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

