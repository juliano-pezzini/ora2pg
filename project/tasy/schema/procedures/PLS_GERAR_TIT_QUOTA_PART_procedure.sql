-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_tit_quota_part ( nr_seq_escrituracao_p text, cd_pessoa_fisica_p text, cd_cgc_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_titulo_w			bigint;
cd_moeda_padrao_w		bigint;
cd_tipo_taxa_juro_w		bigint;
cd_tipo_taxa_multa_w		bigint;
cd_tipo_portador_w		bigint;
cd_portador_w			bigint;
nr_seq_motivo_lanc_mens_w	bigint;
nr_seq_trans_baixa_tit_neg_w	bigint;
nr_seq_trans_tit_neg_cr_w	bigint;
dt_vencimento_w			timestamp;
dt_lancamento_w			timestamp;
vl_parcela_w			double precision;
nr_sequencia_w			bigint;
pr_juro_padrao_w		double precision;
pr_multa_padrao_w		double precision;
cd_conta_financ_w		bigint;
nr_seq_classif_w		bigint;
nr_seq_tipo_escrit_quota_w	bigint;
nr_seq_conta_banco_w		bigint;
nr_seq_carteira_cobr_w		bigint;
nr_seq_trans_fin_contab_w	bigint;
nr_seq_trans_fin_baixa_w	bigint;
nr_seq_classe_w			pls_parametro_escrit_quota.nr_seq_classe%type;

C01 CURSOR FOR
	SELECT	nr_sequencia,
		dt_vencimento,
		vl_parcela
	from	pls_escrit_quota_parcela
	where	nr_seq_escrituracao	= nr_seq_escrituracao_p
	order by
		nr_sequencia;


BEGIN

--Pegar Parâmetros negociação
begin
select	cd_tipo_taxa_juro,
	cd_tipo_taxa_multa,
	cd_tipo_portador,
	cd_portador,
	cd_moeda_padrao,
	pr_juro_padrao,
	pr_multa_padrao
into STRICT	cd_tipo_taxa_juro_w,
	cd_tipo_taxa_multa_w,
	cd_tipo_portador_w,
	cd_portador_w,
	cd_moeda_padrao_w,
	pr_juro_padrao_w,
	pr_multa_padrao_w
from	parametro_contas_receber
where	cd_estabelecimento	= cd_estabelecimento_p;
exception
when no_data_found then
	CALL wheb_mensagem_pck.exibir_mensagem_abort( 267302, null ); /* Não foram encontrados os parâmetros do contas a receber. Por favor verifique. */
end;

if (coalesce(cd_tipo_portador_w::text, '') = '') or (coalesce(cd_portador_w::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort( 267303, null ); /* Não foram cadastrados o tipo de portador e portador padrão dos títulos a receber.' || chr(13) || chr(10) || 'Por favor verifique os Parâmetros do Contas a Receber */
end if;

select	trunc(dt_lancamento,'dd')
into STRICT	dt_lancamento_w
from	pls_escrituracao_quota
where	nr_sequencia	= nr_seq_escrituracao_p;

select	nr_seq_tipo_escrit_quota
into STRICT	nr_seq_tipo_escrit_quota_w
from	pls_escrituracao_quota
where	nr_sequencia	= nr_seq_escrituracao_p;


select	max(nr_seq_classe)
into STRICT	nr_seq_classe_w
from	pls_parametro_escrit_quota LIMIT 1; -- atualmente, só é permitido um registro nessa tabela, coloquei por garantia.
cd_conta_financ_w := pls_obter_conta_financ_regra(	'EQ', null, cd_estabelecimento_p, null, null, null, nr_seq_tipo_escrit_quota_w, null, null, null, null, null, null, null, null, null, null, cd_conta_financ_w);

SELECT * FROM pls_obter_reg_escrit_quotas(	'R', dt_lancamento_w, nm_usuario_p, nr_seq_conta_banco_w, nr_seq_carteira_cobr_w, nr_seq_trans_fin_contab_w, nr_seq_trans_fin_baixa_w) INTO STRICT nr_seq_conta_banco_w, nr_seq_carteira_cobr_w, nr_seq_trans_fin_contab_w, nr_seq_trans_fin_baixa_w;

open C01;
loop
fetch C01 into
	nr_sequencia_w,
	dt_vencimento_w,
	vl_parcela_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	nextval('titulo_seq')
	into STRICT	nr_titulo_w
	;

	insert into titulo_receber(nr_titulo,
		dt_atualizacao,
		nm_usuario,
		cd_estabelecimento,
		cd_moeda,
		cd_pessoa_fisica,
		cd_cgc,
		cd_portador,
		cd_tipo_portador,
		cd_tipo_taxa_juro,
		cd_tipo_taxa_multa,
		dt_emissao,
		dt_pagamento_previsto,
		dt_vencimento,
		ie_origem_titulo,
		ie_situacao,
		ie_tipo_emissao_titulo,
		ie_tipo_inclusao,
		ie_tipo_titulo,
		tx_desc_antecipacao,
		tx_juros,
		tx_multa,
		vl_saldo_juros,
		vl_saldo_multa,
		vl_saldo_titulo,
		vl_titulo,
		nr_seq_conta_banco,
		nr_seq_carteira_cobr,
		nr_seq_trans_fin_contab,
		nr_seq_trans_fin_baixa,
		nr_seq_classe)
	values (nr_titulo_w,
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_p,
		cd_moeda_padrao_w,
		cd_pessoa_fisica_p,
		cd_cgc_p,
		cd_portador_w,
		cd_tipo_portador_w,
		cd_tipo_taxa_juro_w,
		cd_tipo_taxa_multa_w,
		dt_lancamento_w,
		dt_vencimento_w,
		dt_vencimento_w,
		'7', /* Escrituração de quotas */
		'1',
		'2',/* Emissão bloqueto origem */
		'2',
		'1', /* Bloqueto */
		0,
		pr_juro_padrao_w,
		pr_multa_padrao_w,
		0,
		0,
		vl_parcela_w,
		vl_parcela_w,
		nr_seq_conta_banco_w,
		nr_seq_carteira_cobr_w,
		nr_seq_trans_fin_contab_w,
		nr_seq_trans_fin_baixa_w,
		nr_seq_classe_w);

	update	pls_escrit_quota_parcela
	set	nr_titulo	= nr_titulo_w,
		dt_atualizacao	= clock_timestamp(),
		nm_usuario	= nm_usuario_p
	where	nr_sequencia	= nr_sequencia_w;

	if (cd_conta_financ_w IS NOT NULL AND cd_conta_financ_w::text <> '') then
		select	coalesce(max(nr_sequencia),0) +1
		into STRICT	nr_seq_classif_w
		from	titulo_receber_classif
		where	nr_titulo	= nr_titulo_w;

		insert into	titulo_receber_classif(nr_sequencia,
			nm_usuario,
			dt_atualizacao,
			cd_conta_financ,
			vl_classificacao,
			vl_original,
			nr_titulo)
		values (nr_seq_classif_w,
			nm_usuario_p,
			clock_timestamp(),
			cd_conta_financ_w,
			vl_parcela_w,
			vl_parcela_w,
			nr_titulo_w);
	end if;
	end;
end loop;
close C01;

update	pls_escrituracao_quota
set	dt_geracao_titulos	= clock_timestamp(),
	dt_liberacao		= clock_timestamp()
where	nr_sequencia		= nr_seq_escrituracao_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_tit_quota_part ( nr_seq_escrituracao_p text, cd_pessoa_fisica_p text, cd_cgc_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

