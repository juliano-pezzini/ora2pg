-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atual_adep_proc_area_desdobr ( nr_processo_desdobrar_p bigint, nr_processo_desdobrado_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_area_prep_w	bigint;

c01 CURSOR FOR
SELECT	nr_seq_area_prep
from	prescr_mat_hor
where	nr_seq_processo	= nr_processo_desdobrado_p
and	(nr_seq_area_prep IS NOT NULL AND nr_seq_area_prep::text <> '')
and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S'
group by
	nr_seq_area_prep;


BEGIN
if (nr_processo_desdobrar_p IS NOT NULL AND nr_processo_desdobrar_p::text <> '') and (nr_processo_desdobrado_p IS NOT NULL AND nr_processo_desdobrado_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin
	open c01;
	loop
	fetch c01 into nr_seq_area_prep_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		insert into adep_processo_area(
			nr_sequencia,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_atualizacao,
			nm_usuario,
			nr_seq_processo,
			nr_seq_area_prep,
			dt_dispensacao,
			nm_usuario_dispensacao,
			dt_preparo,
			nm_usuario_preparo,
			dt_higienizacao,
			nm_usuario_higienizacao)
		SELECT	nextval('adep_processo_area_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_processo_desdobrado_p,
			nr_seq_area_prep,
			dt_dispensacao,
			nm_usuario_dispensacao,
			dt_preparo,
			nm_usuario_preparo,
			dt_higienizacao,
			nm_usuario_higienizacao
		from	adep_processo_area
		where	nr_seq_processo	= nr_processo_desdobrar_p
		and	nr_seq_area_prep	= nr_seq_area_prep_w;

		end;
	end loop;
	close c01;

	delete
	from	adep_processo_area a
	where	a.nr_seq_processo = nr_processo_desdobrar_p
	and	not exists (
			SELECT	1
			from	prescr_mat_hor x
			where	x.nr_seq_processo	= a.nr_seq_processo
			and	x.nr_seq_area_prep	= a.nr_seq_area_prep
			and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S');
	end;
end if;

--if (nvl(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atual_adep_proc_area_desdobr ( nr_processo_desdobrar_p bigint, nr_processo_desdobrado_p bigint, nm_usuario_p text) FROM PUBLIC;

