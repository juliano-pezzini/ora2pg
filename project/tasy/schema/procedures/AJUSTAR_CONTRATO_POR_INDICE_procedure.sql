-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ajustar_contrato_por_indice ( nr_sequencia_p text, nr_seq_indice_p bigint, nm_usuario_p text) AS $body$
DECLARE


dt_prevista_w			timestamp;
nr_seq_etapa_w			bigint;
nr_seq_taxa_w			bigint;
qt_dias_reajuste_w		bigint;
qt_registro_w			bigint;
tx_ajuste_w			indice_reajuste_valor.tx_ajuste%type;
vl_anterior_w			double precision;
vl_ajustado_w			double precision;
varReajustarRegra		varchar(1);
varReajustarItemRegra		varchar(1);


BEGIN

varReajustarRegra := obter_param_usuario(1200, 78, obter_perfil_ativo, nm_usuario_p, 0, varReajustarRegra);
varReajustarItemRegra := obter_param_usuario(1200, 80, obter_perfil_ativo, nm_usuario_p, 0, varReajustarItemRegra);

if (nr_seq_indice_p <> 0) then

	select	count(*)
	into STRICT	qt_registro_w
	from	indice_reajuste_valor
	where	nr_seq_indice = nr_seq_indice_p
	and		trunc(clock_timestamp(),'dd') between trunc(dt_inicio_vigencia,'dd') and trunc(dt_fim_vigencia,'dd');

	if (qt_registro_w > 0) then

		select	max(nr_sequencia)
		into STRICT	nr_seq_taxa_w
		from	indice_reajuste_valor
		where	nr_seq_indice = nr_seq_indice_p
		and	trunc(clock_timestamp(),'dd') between trunc(dt_inicio_vigencia,'dd') and trunc(dt_fim_vigencia,'dd');

		select	coalesce(tx_ajuste,0)
		into STRICT	tx_ajuste_w
		from	indice_reajuste_valor
		where	nr_sequencia = nr_seq_taxa_w;

		select	coalesce(vl_total_contrato,0)
		into STRICT	vl_anterior_w
		from	contrato
		where	nr_sequencia = nr_sequencia_p;

		if (vl_anterior_w > 0 AND tx_ajuste_w > 0) then

			vl_ajustado_w 	:= vl_anterior_w + ((vl_anterior_w * tx_ajuste_w) / 100);

			update contrato set vl_total_contrato = vl_ajustado_w where nr_sequencia = nr_sequencia_p;

			if (varReajustarRegra = 'S') then
				update 	contrato_regra_pagto
				set	vl_pagto = vl_pagto + ((vl_pagto * tx_ajuste_w)/100)
				where	nr_seq_contrato = nr_sequencia_p;
			end if;

			if (varReajustarItemRegra = 'S') then
				update	contrato_regra_nf
				set		vl_pagto = vl_pagto + ((vl_pagto * tx_ajuste_w)/100)
				where	nr_seq_contrato = nr_sequencia_p
				and	(((trunc(clock_timestamp(),'DD') between trunc(dt_inicio_vigencia,'DD') and trunc(dt_fim_vigencia,'DD')) or (coalesce(dt_inicio_vigencia::text, '') = '' or coalesce(dt_fim_vigencia::text, '') = '')));
			end if;

			insert into contrato_log_reajuste(	nr_sequencia,
								dt_atualizacao,
								nm_usuario,
								dt_atualizacao_nrec,
								nm_usuario_nrec,
								nr_seq_contrato,
								nr_seq_indice_reajuste,
								vl_anterior,
								pr_reajuste)
						values (	nextval('contrato_log_reajuste_seq'),
								clock_timestamp(),
								nm_usuario_p,
								clock_timestamp(),
								nm_usuario_p,
								nr_sequencia_p,
								nr_seq_indice_p,
								vl_anterior_w,
								round((tx_ajuste_w)::numeric,4));

			select	max(c.nr_sequencia)
			into STRICT	nr_seq_etapa_w
			from	contrato_etapa c,
				contrato_tipo_etapa t
			where	c.nr_seq_tipo_etapa = t.nr_sequencia
			and	coalesce(t.ie_reajuste,'N') = 'S';

			if (coalesce(nr_seq_etapa_w,0) > 0 ) then

				select	dt_prevista
				into STRICT	dt_prevista_w
				from	contrato_etapa
				where	nr_sequencia = nr_seq_etapa_w;

				select	qt_dias_reajuste
				into STRICT	qt_dias_reajuste_w
				from	contrato
				where	nr_sequencia = nr_sequencia_p;
				
				if (coalesce(qt_dias_reajuste_w,0) > 0) then

					update contrato_etapa set dt_prevista = (dt_prevista_w + qt_dias_reajuste_w) where nr_sequencia = nr_seq_etapa_w;

				end if;

			end if;

		else
			if (coalesce(tx_ajuste_w,0) = 0) then
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(185395);
			elsif (coalesce(vl_anterior_w,0) = 0) then
				CALL Wheb_mensagem_pck.exibir_mensagem_abort(185396);
			end if;

		end if;

	else
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(185397);
		--'Não existe uma regra cadastrada para este índice vigente na data de hoje.'
	end if;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ajustar_contrato_por_indice ( nr_sequencia_p text, nr_seq_indice_p bigint, nm_usuario_p text) FROM PUBLIC;

