-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consiste_convenio_agecons ( nr_seq_destino_p bigint, cd_agenda_p bigint, cd_convenio_p bigint, dt_agenda_p timestamp, nm_usuario_p text) AS $body$
DECLARE


ie_regra_w		bigint;
ie_permite_agendar_w	varchar(1);


BEGIN
if (cd_agenda_p IS NOT NULL AND cd_agenda_p::text <> '') and (cd_convenio_p IS NOT NULL AND cd_convenio_p::text <> '') then
	select	max(nr_sequencia)
	into STRICT	ie_regra_w
	from	agenda_regra_conv_dia
	where	cd_agenda	= cd_agenda_p
	and	cd_convenio	= cd_convenio_p;

	if (ie_regra_w > 0) then
		select	CASE WHEN count(nr_sequencia)=0 THEN  'N'  ELSE 'S' END
		into STRICT	ie_permite_agendar_w
		from	agenda_regra_conv_dia
		where	cd_agenda	= cd_agenda_p
		and	cd_convenio	= cd_convenio_p
		and	trunc(dt_agenda_p)	<= (trunc(clock_timestamp()) + qt_dias_regra);

		if (ie_permite_agendar_w = 'N') then
			if (nr_seq_destino_p IS NOT NULL AND nr_seq_destino_p::text <> '') and (nr_seq_destino_p <> 0) then
				CALL liberar_horario_agenda_cons(nr_seq_destino_p, nm_usuario_p);
			end if;

			CALL wheb_mensagem_pck.exibir_mensagem_abort(237331, 'CD_CONVENIO_P='||obter_desc_convenio(cd_convenio_p));
		end if;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consiste_convenio_agecons ( nr_seq_destino_p bigint, cd_agenda_p bigint, cd_convenio_p bigint, dt_agenda_p timestamp, nm_usuario_p text) FROM PUBLIC;

