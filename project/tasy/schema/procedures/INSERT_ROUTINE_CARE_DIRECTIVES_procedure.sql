-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_routine_care_directives ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, ds_lista_p text, nm_usuario_p text, cd_professional_p diretriz_atendimento.nm_usuario%type, ie_liberacao_p diretriz_atendimento.ie_status%type ) AS $body$
DECLARE

	
ds_lista_w					varchar(2000);			
ds_lista_aux_w				varchar(2000);
nr_seq_aux_w				bigint;
k							integer;
hasQtDescription			integer;
ie_guideline_w 				routine_care_config.ie_guideline%type;
ie_response_w				routine_care_config.ie_response%type;
ds_guideline_description_w	routine_care_config.ds_guideline_description%type;
ie_display_patientbar_w 	routine_care_config.ie_display_patientbar%type;
nr_seq_presentation_w 		routine_care_config.nr_seq_presentation%type;


BEGIN
	ds_lista_w := ds_lista_p;

	while (ds_lista_w IS NOT NULL AND ds_lista_w::text <> '') loop
		begin
		
			select	position(',' in ds_lista_w)
			into STRICT	k
			;
			
			if (k > 1) and ((substr(ds_lista_w, 1, k -1) IS NOT NULL AND (substr(ds_lista_w, 1, k -1))::text <> '')) then
				ds_lista_aux_w			:= substr(ds_lista_w, 1, k-1);
				nr_seq_aux_w			:= replace(ds_lista_aux_w, ',','');
				ds_lista_w			:= substr(ds_lista_w, k + 1, 2000);
			elsif (ds_lista_w IS NOT NULL AND ds_lista_w::text <> '') then
				nr_seq_aux_w			:= replace(ds_lista_w,',','');
				ds_lista_w			:= '';
			end if;
			
			if (nr_seq_aux_w > 0) then
				select
					ie_guideline,
					ie_response,
					ds_guideline_description,
					ie_display_patientbar,
					nr_seq_presentation
				into STRICT	ie_guideline_w,
					ie_response_w,
					ds_guideline_description_w,
					ie_display_patientbar_w,
					nr_seq_presentation_w
				from
					ROUTINE_CARE_CONFIG
				where nr_sequencia = nr_seq_aux_w;
				
				select count(nr_sequencia)
				into STRICT	hasQtDescription
				from
					diretriz_atendimento
				where ie_diretriz 				= ie_guideline_w
				and cd_pessoa_fisica 			= cd_pessoa_fisica_p
				and	ie_status 					= 'C'
				and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
				and	coalesce(dt_inativacao::text, '') = '';
				
				commit;
				if (hasQtDescription = 0) then
				    if (ie_liberacao_p = 'S') then
              insert into
              diretriz_atendimento(
                  nr_sequencia,
                  dt_atualizacao,
                  nm_usuario,
                  ie_situacao,
                  cd_pessoa_fisica,
                  nr_atendimento,
                  ie_diretriz,
                  ie_resposta,
                  ds_guideline_description,
                  ie_display_patientbar,
                  nr_seq_presentation,
                  ie_status,
                  nm_usuario_nrec, 
                  dt_atualizacao_nrec,
                  dt_registration,
                  cd_professional,
                  ie_decision_maker,
                  cd_clinical_decison_maker,
                  dt_liberacao,
                  nm_usuario_lib
              )
              values (
                  nextval('diretriz_atendimento_seq'),
                  clock_timestamp(),
                  nm_usuario_p,
                  'A',
                  cd_pessoa_fisica_p,
                  nr_atendimento_p,
                  ie_guideline_w,
                  ie_response_w,
                  ds_guideline_description_w,
                  ie_display_patientbar_w,
                  nr_seq_presentation_w,
                  'C',
                  nm_usuario_p,
                  clock_timestamp(),
                  clock_timestamp(),
                  cd_professional_p,
                  1,
                  cd_professional_p,
                  clock_timestamp(),
                  nm_usuario_p
              );
            else
                  insert into
                  diretriz_atendimento(
                    nr_sequencia,
                    dt_atualizacao,
                    nm_usuario,
                    ie_situacao,
                    cd_pessoa_fisica,
                    nr_atendimento,
                    ie_diretriz,
                    ie_resposta,
                    ds_guideline_description,
                    ie_display_patientbar,
                    nr_seq_presentation,
                    ie_status,
                    nm_usuario_nrec, 
                    dt_atualizacao_nrec,
                    dt_registration,
                    cd_professional,
                    ie_decision_maker,
                    cd_clinical_decison_maker
                  )
                  values (
                    nextval('diretriz_atendimento_seq'),
                    clock_timestamp(),
                    nm_usuario_p,
                    'A',
                    cd_pessoa_fisica_p,
                    nr_atendimento_p,
                    ie_guideline_w,
                    ie_response_w,
                    ds_guideline_description_w,
                    ie_display_patientbar_w,
                    nr_seq_presentation_w,
                    'C',
                    nm_usuario_p,
                    clock_timestamp(),
                    clock_timestamp(),
                    cd_professional_p,
                    1,
                    cd_professional_p
                  );
                end if;
				end if;
			end if;
		end;
	end loop;
	
	commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_routine_care_directives ( nr_atendimento_p bigint, cd_pessoa_fisica_p text, ds_lista_p text, nm_usuario_p text, cd_professional_p diretriz_atendimento.nm_usuario%type, ie_liberacao_p diretriz_atendimento.ie_status%type ) FROM PUBLIC;

