-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE registrar_mudanca_equip_bomba (nr_sequencia_interface_p bigint, nr_seq_bomba_infusao_p bigint, ie_alteracao_p text, nr_seq_agente_p bigint) AS $body$
DECLARE


  equipamento_cirurgia_seq_w  equipamento_cirurgia.nr_sequencia%type;
  nr_cirurgia_w               cirurgia_agente_anestesico.nr_cirurgia%type;
  cd_equipamento_w            bomba_infusao_interface.nr_seq_equipamento%type;
  nm_usuario_w                varchar(100) := wheb_usuario_pck.get_nm_usuario;
  cd_profissional_w           usuario.cd_pessoa_fisica%type;
  dt_inicio_w                 bomba_infusao.dt_bomba_infusao%type;
  dt_fim_w                    bomba_infusao_transicao.dt_transicao%type;
  nr_atendimento_w            bomba_infusao.nr_atendimento%type;
  exists_equipamento_w        varchar(1) := 'S';
  error_cd_profissional_e     exception;


BEGIN

  case when ie_alteracao_p = 1 then

  select obter_pessoa_fisica_usuario(nm_usuario_w, 'C')
    into STRICT cd_profissional_w
;

    if coalesce(cd_profissional_w::text, '') = '' then
       raise error_cd_profissional_e;
    end if;



    select nextval('equipamento_cirurgia_seq'),
           caa.nr_cirurgia,
           bii.nr_seq_equipamento,
           bi.dt_bomba_infusao dt_inicio_w,
           bi.nr_atendimento
      into STRICT equipamento_cirurgia_seq_w,
           nr_cirurgia_w,
           cd_equipamento_w,
           dt_inicio_w,
           nr_atendimento_w
      from bomba_infusao_interface bii,
           bomba_infusao bi
      left join cirurgia_agente_anestesico caa
        on caa.nr_sequencia = bi.nr_seq_agente
     where bii.nr_sequencia =  bi.nr_seq_bomba_interface
       and coalesce(bi.nr_seq_agente, 0) = coalesce(nr_seq_agente_p, 0)
       and bii.nr_sequencia = nr_sequencia_interface_p
       and bi.nr_sequencia = nr_seq_bomba_infusao_p;

    select case when count(1) > 0 then 'S' else 'N' end
      into STRICT exists_equipamento_w
      from equipamento 
     where cd_equipamento = cd_equipamento_w;

    if exists_equipamento_w = 'N' then
    
        insert into equipamento(
                 cd_equipamento,
                 ds_equipamento,
                 dt_atualizacao,
                 nm_usuario,
                 ie_situacao,
                 cd_estabelecimento,
                 qt_equipamento,
                 ie_video
          ) 
          SELECT  
                 man_equip.nr_sequencia,         --cd_equipamento,
                 man_equip.ds_equipamento,
                 clock_timestamp(),                        --dt_atualizacao,
                 nm_usuario_w,
                 man_equip.ie_situacao,
                 obter_estabelecimento_ativo(),  --cd_estabelecimento,
                 1,                              --qt_equipamento,
                 'N'                             --ie_video         
            from man_equipamento man_equip 
           where man_equip.nr_sequencia = cd_equipamento_w;
    end if;

    insert into equipamento_cirurgia(
        nr_sequencia,
        nr_cirurgia,
        cd_equipamento,
        qt_equipamento,
        dt_atualizacao,
        nm_usuario,
        cd_profissional,
        dt_inicio,
        nr_atendimento,
        ie_gerado_sistema
    ) values (
        equipamento_cirurgia_seq_w,
        nr_cirurgia_w,
        cd_equipamento_w,
        1,       --qt_equipamento
        clock_timestamp(), --dt_atualizacao
        nm_usuario_w,
        cd_profissional_w,
        dt_inicio_w,
        nr_atendimento_w,
        'S'      --ie_gerado_sistema
    );

    update bomba_infusao
       set nr_seq_equip_cirurgia = equipamento_cirurgia_seq_w
     where bomba_infusao.nr_seq_bomba_interface = nr_sequencia_interface_p
       and bomba_infusao.nr_sequencia = nr_seq_bomba_infusao_p
       and bomba_infusao.ie_ativo = 'S';

  when ie_alteracao_p = 2 then

    select nr_seq_equip_cirurgia,
           get_dt_final_bomba_transicao(nr_sequencia_interface_p) dt_fim_w
      into STRICT equipamento_cirurgia_seq_w,
           dt_fim_w
      from bomba_infusao
     where bomba_infusao.nr_seq_bomba_interface = nr_sequencia_interface_p
       and bomba_infusao.nr_sequencia = nr_seq_bomba_infusao_p;

    if (equipamento_cirurgia_seq_w IS NOT NULL AND equipamento_cirurgia_seq_w::text <> '') then
        update equipamento_cirurgia
           set dt_fim = dt_fim_w
         where nr_sequencia = equipamento_cirurgia_seq_w;
    end if;

  end case;

    exception 
    when error_cd_profissional_e then
        CALL wheb_mensagem_pck.exibir_mensagem_abort(1119224,'NM_USUARIO='||nm_usuario_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE registrar_mudanca_equip_bomba (nr_sequencia_interface_p bigint, nr_seq_bomba_infusao_p bigint, ie_alteracao_p text, nr_seq_agente_p bigint) FROM PUBLIC;

