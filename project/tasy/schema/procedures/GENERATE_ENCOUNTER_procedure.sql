-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE generate_encounter ( cd_pessoa_fisica_p pessoa_titular_convenio.cd_pessoa_fisica%TYPE, ie_tipo_atendimento_p atendimento_paciente.ie_tipo_atendimento%TYPE, cd_convenio_p pessoa_titular_convenio.cd_convenio%TYPE, cd_categoria_p pessoa_titular_convenio.cd_categoria%TYPE, dt_validade_carteira_p pessoa_titular_convenio.dt_validade_carteira%TYPE, cd_usuario_convenio_p pessoa_titular_convenio.cd_usuario_convenio%TYPE, cd_procedencia_p atendimento_paciente.cd_procedencia%TYPE, cd_medico_resp_p atendimento_paciente.cd_medico_resp%TYPE, cd_estabelecimento_p atendimento_paciente.cd_estabelecimento%TYPE, cd_setor_atendimento_p atend_paciente_unidade.cd_setor_atendimento%TYPE, nm_usuario_p text, nr_atendimento_p INOUT atendimento_paciente.nr_atendimento%TYPE ) AS $body$
DECLARE

  nr_seq_interno_w           atend_categoria_convenio.nr_atendimento%TYPE;
  ie_tipo_atendimento_w      atendimento_paciente.ie_tipo_atendimento%TYPE;

BEGIN
  ie_tipo_atendimento_w := coalesce(ie_tipo_atendimento_p, 8); -- default to outpatient
  IF (coalesce(cd_convenio_p::text, '') = '' OR coalesce(cd_categoria_p::text, '') = '') THEN
    -- Cannot generate the encounter, because the patient does not have an insurance registered.
    -- Please check his/her registration in the "Master Person Index" function.
    CALL wheb_mensagem_pck.EXIBIR_MENSAGEM_ABORT(1126916);
  END IF;

  IF (coalesce(cd_setor_atendimento_p::text, '') = '') THEN
    -- Encounter generation requires informing a department on scheduling.
    CALL wheb_mensagem_pck.EXIBIR_MENSAGEM_ABORT(1126942);
  END IF;

  IF (coalesce(cd_procedencia_p::text, '') = '') THEN
    -- Encounter generation requires informing a origin on scheduling.
    CALL wheb_mensagem_pck.EXIBIR_MENSAGEM_ABORT(1142419);
  END IF;

  -- GENERATE ENCOUNTER
  SELECT  nextval('atendimento_paciente_seq')
  INTO STRICT    nr_atendimento_p
;

  INSERT INTO ATENDIMENTO_PACIENTE(
    nr_atendimento,
    cd_pessoa_fisica,
    cd_estabelecimento,
    cd_procedencia,
    dt_entrada,
    ie_tipo_atendimento,
    dt_atualizacao,
    nm_usuario,
    nm_usuario_atend,
    cd_medico_resp,
    ie_permite_visita
  ) VALUES (
    nr_atendimento_p,
    cd_pessoa_fisica_p,
    coalesce(cd_estabelecimento_p, wheb_usuario_pck.GET_CD_ESTABELECIMENTO),
    cd_procedencia_p,
    clock_timestamp(),
    ie_tipo_atendimento_w,
    clock_timestamp(),
    nm_usuario_p,
    nm_usuario_p,
    cd_medico_resp_p,
    'N'
  );

  if (obter_param_funcao_html5(281, 1614) = 'N') then
    CALL VINCULAR_NR_ATENDIMENTO_CP(nr_atendimento_p,cd_pessoa_fisica_p);
  END IF;

  -- GENERATE INSURANCE RECORD
  SELECT  nextval('atend_categoria_convenio_seq')
  INTO STRICT    nr_seq_interno_w
;

 if (cd_convenio_p IS NOT NULL AND cd_convenio_p::text <> '') then
  INSERT INTO ATEND_CATEGORIA_CONVENIO(
    nr_seq_interno,
    nr_atendimento,
    cd_convenio,
    cd_categoria,
    dt_inicio_vigencia,
    dt_atualizacao,
    cd_usuario_convenio,
    nm_usuario,
    nr_doc_convenio,
    dt_validade_carteira
  ) VALUES (
    nr_seq_interno_w,
    nr_atendimento_p,
    cd_convenio_p,
    cd_categoria_p,
    clock_timestamp(),
    clock_timestamp(),
    cd_usuario_convenio_p,
    nm_usuario_p,
    NULL,
    dt_validade_carteira_p
  );
end if;
  -- GENERATE DEPARTMENT PASS FOR THE ENCOUNTER
  CALL gerar_passagem_setor_atend(
    nr_atendimento_p,
    cd_setor_atendimento_p,
    clock_timestamp(),
    'N',
    nm_usuario_p
  );

  IF coalesce(wheb_usuario_pck.GET_IE_COMMIT, 'S') = 'S' THEN
    COMMIT;
  END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE generate_encounter ( cd_pessoa_fisica_p pessoa_titular_convenio.cd_pessoa_fisica%TYPE, ie_tipo_atendimento_p atendimento_paciente.ie_tipo_atendimento%TYPE, cd_convenio_p pessoa_titular_convenio.cd_convenio%TYPE, cd_categoria_p pessoa_titular_convenio.cd_categoria%TYPE, dt_validade_carteira_p pessoa_titular_convenio.dt_validade_carteira%TYPE, cd_usuario_convenio_p pessoa_titular_convenio.cd_usuario_convenio%TYPE, cd_procedencia_p atendimento_paciente.cd_procedencia%TYPE, cd_medico_resp_p atendimento_paciente.cd_medico_resp%TYPE, cd_estabelecimento_p atendimento_paciente.cd_estabelecimento%TYPE, cd_setor_atendimento_p atend_paciente_unidade.cd_setor_atendimento%TYPE, nm_usuario_p text, nr_atendimento_p INOUT atendimento_paciente.nr_atendimento%TYPE ) FROM PUBLIC;

