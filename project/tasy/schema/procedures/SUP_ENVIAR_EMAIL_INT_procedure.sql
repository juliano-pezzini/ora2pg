-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sup_enviar_email_int ( ie_evento_p text, ie_integracao_p text, nr_documento_p text, cd_estabelecimento_p bigint, nm_usuario_p text, ie_envio_p INOUT text, ie_tipo_doc_p text, ie_acao_p text, ds_consistencia_p text) AS $body$
DECLARE

 
/* 
ie_evento_p --> 'FES' = ie_falha_envio_solic, 
ie_evento_p --> 'FRCO' = ie_falha_receb_canc_oc, 
ie_evento_p --> 'FRAO' = ie_falha_receb_alt_oc, 
ie_evento_p --> 'FEN' =ie_falha_envio_nf 
*/
 
 
ds_assunto_w		regra_envio_email_int.ds_assunto%type;
ds_conteudo_w		regra_envio_email_int.ds_conteudo%type;
ds_email_origem_w	regra_envio_email_int.ds_email_origem%type;
nr_sequencia_w		regra_envio_email_int.nr_sequencia%type;
ds_email_destino_w	regra_envio_email_int_dest.ds_email_destino%type;
ie_com_copia_w		regra_envio_email_int_dest.ie_com_copia%type;
ds_email_destino_ww	varchar(4000);
ds_email_destino_ccww	varchar(4000);
ds_transicao_w		varchar(255);
ie_tipo_doc_w		varchar(255);
ie_acao_w		varchar(255);

	 
c01 CURSOR FOR 
	SELECT	a.ds_assunto, 
		a.ds_conteudo, 
		a.ds_email_origem, 
		a.nr_sequencia 
	from	regra_envio_email_int a 
	where	CASE WHEN ie_evento_p='FES' THEN  a.ie_falha_envio_solic WHEN ie_evento_p='FRCO' THEN  a.ie_falha_receb_canc_oc WHEN ie_evento_p='FRAO' THEN  a.ie_falha_receb_alt_oc WHEN ie_evento_p='FEN' THEN  a.ie_falha_envio_nf END  = 'S' 
	and	a.ie_integracao = ie_integracao_p;
	
c02 CURSOR FOR 
	SELECT	b.ds_email_destino, 
		coalesce(b.ie_com_copia,'N') 
	from	regra_envio_email_int_dest b 
	where	b.nr_seq_regra = nr_sequencia_w;

			 

BEGIN 
 
ie_envio_p := 'N';
 
open c01;
loop 
fetch c01 into	 
	ds_assunto_w, 
	ds_conteudo_w, 
	ds_email_origem_w, 
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
	 
	if (coalesce(ds_email_origem_w,'X') = 'X') then 
		begin 
		select 	ds_email 
		into STRICT	ds_email_origem_w 
		from	parametro_compras 
		where 	cd_estabelecimento = cd_estabelecimento_p;
		exception 
		when others then 
			ds_email_origem_w := null;
		end;
	end if;
	 
	 
	open c02;
	loop 
	fetch c02 into	 
		ds_email_destino_w, 
		ie_com_copia_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin 
		if (coalesce(ie_com_copia_w,'N') = 'N') then 
		ds_email_destino_ww := substr(ds_email_destino_ww||ds_email_destino_w||';', 1, 4000);
		else 
		ds_email_destino_ccww := substr(ds_email_destino_ccww||ds_email_destino_w||';', 1, 4000);
		end if;
		end;
	end loop;
	close c02;
 
	if (coalesce(ds_email_destino_ww,'X') <> 'X') then 
		begin 
		ds_email_destino_ww 	:= substr(ds_email_destino_ww,1,4000);
		ds_email_destino_ccww 	:= substr(ds_email_destino_ccww,1,4000);
		 
		select 	CASE WHEN ie_evento_p=--'FES', 'Tasy para ME', 
				--'FRCO', 'ME para Tasy', 
				--'FRAO', 'ME para Tasy', 
				--'FEN', 'Tasy para ME'), 
				'FES' THEN  wheb_mensagem_pck.get_texto(315101) WHEN ie_evento_p='FRCO' THEN  wheb_mensagem_pck.get_texto(315102) WHEN ie_evento_p='FRAO' THEN  wheb_mensagem_pck.get_texto(315102) WHEN ie_evento_p='FEN' THEN  wheb_mensagem_pck.get_texto(315101) END , 
			CASE WHEN ie_tipo_doc_p=--'NF', 'Nota Fiscal', 
				--'SC', 'Solicitação de Compra', 
				--'OC', 'Ordem Compra'), 
				'NF' THEN  wheb_mensagem_pck.get_texto(315103) WHEN ie_tipo_doc_p='SC' THEN  wheb_mensagem_pck.get_texto(315104) WHEN ie_tipo_doc_p='OC' THEN  wheb_mensagem_pck.get_texto(315105) END , 
			CASE WHEN ie_acao_p=--'INC', 'Inclusão', 
				--'ALT', 'Alteração', 
				--'CAN', 'Cancelamento') 
				'INC' THEN  wheb_mensagem_pck.get_texto(315098) WHEN ie_acao_p='ALT' THEN  wheb_mensagem_pck.get_texto(315099) WHEN ie_acao_p='CAN' THEN  wheb_mensagem_pck.get_texto(315100) END  
		into STRICT 	ds_transicao_w, 
			ie_tipo_doc_w, 
			ie_acao_w 
		;
		 
		ds_conteudo_w	:= substr(replace_macro(ds_conteudo_w,'@DOCUMENTO',coalesce(ie_tipo_doc_w,'')),1,4000);
		ds_conteudo_w	:= substr(replace_macro(ds_conteudo_w,'@NR_DOCUMENTO',coalesce(nr_documento_p,'')),1,4000);
		ds_conteudo_w	:= substr(replace_macro(ds_conteudo_w,'@OPERACAO',coalesce(ie_acao_w,'')),1,4000);
		ds_conteudo_w	:= substr(replace_macro(ds_conteudo_w,'@TRANSICAO',coalesce(ds_transicao_w,'')),1,4000);
		ds_conteudo_w	:= substr(replace_macro(ds_conteudo_w,'@DS_ERRO',coalesce(ds_consistencia_p,'')),1,4000);
		 
		CALL enviar_email( ds_assunto_w, ds_conteudo_w, ds_email_origem_w, ds_email_destino_ww, nm_usuario_p, 'M', ds_email_destino_ccww );
		 
		ie_envio_p := 'S';
		end;
	end if;
	 
	end;
end loop;
close c01;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sup_enviar_email_int ( ie_evento_p text, ie_integracao_p text, nr_documento_p text, cd_estabelecimento_p bigint, nm_usuario_p text, ie_envio_p INOUT text, ie_tipo_doc_p text, ie_acao_p text, ds_consistencia_p text) FROM PUBLIC;

