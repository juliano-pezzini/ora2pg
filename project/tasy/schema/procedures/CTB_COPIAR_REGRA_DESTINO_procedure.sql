-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_copiar_regra_destino ( NR_SEQUENCIA_ORIGEM_P bigint, NR_SEQUENCIA_DESTINO_P bigint, NM_USUARIO_P text ) AS $body$
DECLARE

    SOMA_RATEIO integer;
    c01 CURSOR FOR
        SELECT
            nr_sequencia,
            nr_seq_regra_rateio,
            dt_atualizacao,
            nm_usuario,
            dt_atualizacao_nrec,
            nm_usuario_nrec,
            cd_conta_contabil_dest,
            cd_centro_custo_dest,
            pr_rateio,
            nr_seq_grupo
        FROM
            ctb_regra_rat_dest
        WHERE
            nr_seq_regra_rateio = nr_sequencia_origem_p;
    c01_w c01%rowtype;

BEGIN
    SELECT SUM(pr_rateio)
    INTO STRICT   SOMA_RATEIO
    FROM   ctb_regra_rat_dest
    WHERE  nr_seq_regra_rateio IN (nr_sequencia_origem_p, NR_SEQUENCIA_DESTINO_P);
    IF (SOMA_RATEIO > 100) THEN
        BEGIN
            CALL wheb_mensagem_pck.exibir_mensagem_abort(455429);
        END;
    END IF;
    OPEN c01;
    LOOP
        FETCH c01
        INTO c01_w;
        EXIT WHEN NOT FOUND; /* apply on c01 */
        INSERT INTO ctb_regra_rat_dest(
                nr_sequencia,
                nr_seq_regra_rateio,
                dt_atualizacao,
                nm_usuario,
                dt_atualizacao_nrec,
                nm_usuario_nrec,
                cd_conta_contabil_dest,
                cd_centro_custo_dest,
                pr_rateio,
                nr_seq_grupo
                )
                VALUES (
                nextval('ctb_regra_rat_dest_seq'),
                nr_sequencia_destino_p,
                clock_timestamp(),
                nm_usuario_p,
                clock_timestamp(),
                nm_usuario_p,
                c01_w.cd_conta_contabil_dest,
                c01_w.cd_centro_custo_dest,
                c01_w.pr_rateio,
                c01_w.nr_seq_grupo
                );
    END LOOP;
    CLOSE c01;
    COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_copiar_regra_destino ( NR_SEQUENCIA_ORIGEM_P bigint, NR_SEQUENCIA_DESTINO_P bigint, NM_USUARIO_P text ) FROM PUBLIC;

