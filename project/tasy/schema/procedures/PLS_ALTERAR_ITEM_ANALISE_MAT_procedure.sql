-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alterar_item_analise_mat ( nr_sequencia_p bigint, nr_seq_analise_p bigint, nr_nota_fiscal_p bigint, dt_emissao_nf_p text, dt_recebimento_nf_p text, dt_atendimento_p text, nr_seq_grupo_p bigint, nr_seq_prest_fornec_p bigint, cd_estabelecimento_p bigint, nr_seq_setor_atend_p bigint, vl_material_imp_p bigint, qt_material_imp_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
dt_recebimento_nf_ww		timestamp;
dt_emissao_nf_ww		timestamp;
dt_recebimento_nf_w		timestamp;
dt_emissao_nf_w			timestamp;
dt_atendimento_w		timestamp;
dt_atendimento_ww		timestamp;

nr_nota_fiscal_w		bigint;
nr_seq_conta_w			bigint;
nr_identificador_w		bigint;
nr_seq_material_w		bigint;
nr_seq_prest_fornec_w		bigint;
nr_seq_setor_atend_w		bigint;
ds_observacao_w			varchar(4000);
ie_parametro_w			varchar(2);
vl_material_imp_w		double precision;
qt_material_imp_w		double precision;
ie_valor_informado_w	varchar(1);
ie_origem_conta_w		varchar(2);
ie_vl_apresentado_sistema_w	varchar(1);


BEGIN 
 
if (dt_recebimento_nf_p = ' / /  ') then 
	dt_recebimento_nf_w := null;
else 
	begin 
	dt_recebimento_nf_w := to_date(dt_recebimento_nf_p);
	exception 
	when others then 
		dt_recebimento_nf_w	:= null;
	end;
end if;
 
if (dt_emissao_nf_p = ' / /  ') then 
	dt_emissao_nf_w := null;
else 
	begin 
	dt_emissao_nf_w := to_date(dt_emissao_nf_p);
	exception 
	when others then 
		dt_emissao_nf_w	:= null;
	end;
end if;
 
if (dt_atendimento_p = ' / /  ') then 
	dt_atendimento_w := null;
else 
	begin 
	dt_atendimento_w := to_date(dt_atendimento_p);
	exception 
	when others then 
		dt_atendimento_w := null;
	end;
end if;
 
select	dt_recebimento_nf, 
	nr_nota_fiscal, 
	dt_emissao_nf, 
	nr_seq_conta, 
	nr_seq_material, 
	dt_atendimento, 
	nr_seq_prest_fornec, 
	nr_seq_setor_atend, 
	vl_material_imp, 
	qt_material_imp, 
	ie_valor_informado, 
	ie_vl_apresentado_sistema 
into STRICT	dt_recebimento_nf_ww, 
	nr_nota_fiscal_w, 
	dt_emissao_nf_ww, 
	nr_seq_conta_w, 
	nr_seq_material_w, 
	dt_atendimento_ww, 
	nr_seq_prest_fornec_w, 
	nr_seq_setor_atend_w, 
	vl_material_imp_w, 
	qt_material_imp_w, 
	ie_valor_informado_w, 
	ie_vl_apresentado_sistema_w 
from	pls_conta_mat 
where	nr_sequencia = nr_sequencia_p;
 
select	ie_origem_conta 
into STRICT	ie_origem_conta_w 
from	pls_conta 
where	nr_sequencia = nr_seq_conta_w;
 
 
if (ie_origem_conta_w in ('A','E')) then 
 
	if (coalesce(vl_material_imp_w,0) <> coalesce(vl_material_imp_p,0)) then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(191454);
		/*Não é permitico alterar o valor apresentado de arquivo importado*/
 
	end if;
 
	if (coalesce(qt_material_imp_w,0) <> coalesce(qt_material_imp_p,0)) then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(191455);
		/*Não é permitico alterar a quantidade apresentado de arquivo importado*/
 
	end if;
end if;
 
if (coalesce(vl_material_imp_w,0) <> coalesce(vl_material_imp_p,0))or (coalesce(qt_material_imp_w,0) <> coalesce(qt_material_imp_p,0)) then 
	ie_valor_informado_w := 'S';
end if;
if (coalesce(vl_material_imp_w,0) <> coalesce(vl_material_imp_p,0)) then 
	ie_vl_apresentado_sistema_w := 'N';
end if;
 
update	pls_conta_mat 
set	dt_recebimento_nf	=	dt_recebimento_nf_w, 
	dt_emissao_nf		=	dt_emissao_nf_w, 
	nr_nota_fiscal		=	nr_nota_fiscal_p, 
	dt_atendimento		=	dt_atendimento_w, 
	nr_seq_prest_fornec	=	nr_seq_prest_fornec_p, 
	nr_seq_setor_atend	= 	nr_seq_setor_atend_p, 
	vl_material_imp		=	vl_material_imp_p, 
	qt_material_imp		= 	qt_material_imp_p, 
	ie_valor_informado	= 	ie_valor_informado_w, 
	ie_vl_apresentado_sistema = ie_vl_apresentado_sistema_w, 
	vl_unitario_imp		=	dividir(vl_material_imp_p,qt_material_imp_p)--jjung 01/11/2012 OS - 490768 - atualizar o valor unitário do item. 
where	nr_sequencia 		= 	nr_sequencia_p;
 
update	w_pls_resumo_conta 
set	dt_recebimento_nf	=	dt_recebimento_nf_w, 
	dt_emissao_nf		=	dt_emissao_nf_w, 
	nr_nota_fiscal		=	nr_nota_fiscal_p, 
	dt_item			= 	dt_atendimento_w, 
	nr_seq_prest_fornec	=	nr_seq_prest_fornec_p, 
	nr_seq_setor_atend	=	nr_seq_setor_atend_p, 
	ds_setor_atendimento	=	pls_obter_dados_setor_atend(nr_seq_setor_atend_p,'DS'), 
	vl_total_apres		= vl_material_imp_p, 
	qt_apresentado		= qt_material_imp_p, 
	vl_unitario_apres	= dividir(vl_material_imp_p,qt_material_imp_p) 
where	nr_seq_item 		= 	nr_sequencia_p 
and	ie_tipo_item		=	'M';
 
select	max(nr_identificador) 
into STRICT	nr_identificador_w 
from	w_pls_resumo_conta 
where	nr_seq_item 		= 	nr_sequencia_p 
and	ie_tipo_item		=	'M';
 
if (coalesce(vl_material_imp_w,0) <> coalesce(vl_material_imp_p,0)) then 
ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)|| 
				'Valor apresentado: '||chr(13)||chr(10)|| 
				chr(9)||'Anterior: '||vl_material_imp_w||' - Modificada: '||vl_material_imp_p||chr(13)||chr(10);
end if;
 
if (coalesce(qt_material_imp_w,0) <> coalesce(qt_material_imp_p,0)) then 
ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)|| 
				'Quantidade apresentada: '||chr(13)||chr(10)|| 
				chr(9)||'Anterior: '||qt_material_imp_w||' - Modificada: '||qt_material_imp_p||chr(13)||chr(10);
end if;
	 
if (coalesce(to_char(dt_recebimento_nf_w),'X') <> coalesce(to_char(dt_recebimento_nf_ww),'X')) then 
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)|| 
				'Dt. recebimento NF: '||chr(13)||chr(10)|| 
				chr(9)||'Anterior: '||to_char(dt_recebimento_nf_ww, 'dd/mm/yyyy')||' - Modificada: '||to_char(dt_recebimento_nf_w, 'dd/mm/yyyy')||chr(13)||chr(10);
end if;
 
if (coalesce(to_char(dt_emissao_nf_w),'X') <> coalesce(to_char(dt_emissao_nf_ww),'X')) then 
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)|| 
				'Dt. emissão NF: '||chr(13)||chr(10)|| 
				chr(9)||'Anterior: '||to_char(dt_emissao_nf_ww, 'dd/mm/yyyy')||' - Modificada: '||to_char(dt_emissao_nf_w, 'dd/mm/yyyy')||chr(13)||chr(10);
end if;
 
if (coalesce(to_char(dt_atendimento_w),'X') <> coalesce(to_char(dt_atendimento_ww),'X')) then 
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)|| 
				'Dt. material: '||chr(13)||chr(10)|| 
				chr(9)||'Anterior: '||to_char(dt_atendimento_ww, 'dd/mm/yyyy')||' - Modificada: '||to_char(dt_atendimento_w, 'dd/mm/yyyy')||chr(13)||chr(10);
end if;
 
if (coalesce(nr_nota_fiscal_p,0) <> coalesce(nr_nota_fiscal_w,0)) then 
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)|| 
				'Nota fiscal: '||chr(13)||chr(10)|| 
				chr(9)||'Anterior: '||nr_nota_fiscal_w||' - Modificada: '||nr_nota_fiscal_p||chr(13)||chr(10);
end if;
 
if (coalesce(nr_seq_prest_fornec_p,0) <> coalesce(nr_seq_prest_fornec_w,0)) then 
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)|| 
				'Fornecedor: '||chr(13)||chr(10)|| 
				chr(9)||'Anterior: '||pls_obter_cod_prestador(nr_seq_prest_fornec_w, null)||' - '||pls_obter_dados_prestador(nr_seq_prest_fornec_w,'N')||' - Modificada: '||pls_obter_cod_prestador(nr_seq_prest_fornec_p, null)||' - '||pls_obter_dados_prestador(nr_seq_prest_fornec_p,'N')||chr(13)||chr(10);
end if;
 
if (coalesce(nr_seq_setor_atend_w,0) <> coalesce(nr_seq_setor_atend_p,0)) then	 
	ds_observacao_w :=	ds_observacao_w||chr(13)||chr(10)|| 
				'Setor atendimento: '||chr(13)||chr(10)|| 
				chr(9)||'Anterior: '||pls_obter_dados_setor_atend(nr_seq_setor_atend_w,'DS')||' - Modificada: '||pls_obter_dados_setor_atend(nr_seq_setor_atend_p,'DS')||chr(13)||chr(10);
end if;
 
if (coalesce(ds_observacao_w,'X') <> 'X') then 
	CALL pls_inserir_hist_analise(nr_seq_conta_w, nr_seq_analise_p, 15, 
			 nr_sequencia_p, 'M', null, 
			 null, 'Modificado pelo auditor '||obter_nome_usuario(nm_usuario_p)||'.'||chr(13)||chr(10)|| 
				'Item '||nr_identificador_w||' - '||pls_obter_desc_material(nr_seq_material_w)||'.'||chr(13)||chr(10)|| 
				ds_observacao_w, nr_seq_grupo_p, nm_usuario_p, cd_estabelecimento_p);
end if;
 
/*pls_atualizar_ocorrencias( nr_seq_conta_w, nr_seq_analise_p, nm_usuario_p, 
			  cd_estabelecimento_p, 'S');*/
 
			   
/* ASKONO - OS367634 - SOLICITAÇÃO UNIMED RIO PRETO PARA RECONSISTÊNCIA AUTOMÁTICA APÓS ALTERAÇÃO DAS INFORMAÇÕES DO ITEM OU DA CONTA */
 
ie_parametro_w := obter_valor_param_usuario(1317,15,Obter_Perfil_Ativo,nm_usuario_p,cd_estabelecimento_p);
 
if (coalesce(ie_parametro_w,'N') = 'S') then 
	CALL pls_reconsistir_analise(nr_seq_analise_p,nr_seq_grupo_p,cd_estabelecimento_p, nm_usuario_p);
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alterar_item_analise_mat ( nr_sequencia_p bigint, nr_seq_analise_p bigint, nr_nota_fiscal_p bigint, dt_emissao_nf_p text, dt_recebimento_nf_p text, dt_atendimento_p text, nr_seq_grupo_p bigint, nr_seq_prest_fornec_p bigint, cd_estabelecimento_p bigint, nr_seq_setor_atend_p bigint, vl_material_imp_p bigint, qt_material_imp_p bigint, nm_usuario_p text) FROM PUBLIC;

