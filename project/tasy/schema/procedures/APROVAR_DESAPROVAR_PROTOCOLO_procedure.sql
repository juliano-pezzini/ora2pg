-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE aprovar_desaprovar_protocolo (nr_seq_protocolo_p bigint, nm_usuario_p text, ie_status_p text default null, ds_texto_comunicacao_p text default null) AS $body$
DECLARE

qt_aprovado_w			smallint;
ds_destino_comunic_w	varchar(255);
ds_texto_comunic_w		varchar(4000);
ds_subtipo_protocolo_w	varchar(255);
ds_protocolo_w			varchar(255);
ds_tipo_protocolo_w		varchar(255);
ds_texto_aux_w			varchar(255);


BEGIN 
 
if (coalesce(ie_status_p::text, '') = '') then 
	select	count(*) 
	into STRICT	qt_aprovado_w 
	from	protocolo_medicacao 
	where	nr_seq_interna	=	nr_seq_protocolo_p 
	and	(dt_aprovacao IS NOT NULL AND dt_aprovacao::text <> '');	
 
	if (qt_aprovado_w = 0) then 
		update	protocolo_medicacao 
		set	nm_usuario_aprov	=	nm_usuario_p, 
			dt_aprovacao		=	clock_timestamp() 
		where	nr_seq_interna		=	nr_seq_protocolo_p;
	else 
		update	protocolo_medicacao 
		set	nm_usuario_aprov	 = NULL, 
			dt_aprovacao		 = NULL 
		where	nr_seq_interna		=	nr_seq_protocolo_p;
	end if;
elsif (ie_status_p = 'PA') then 
	update	protocolo_medicacao 
	set	nm_usuario_aprov	 = NULL, 
		dt_aprovacao		 = NULL, 
		ie_status		=	'PA' 
	where	nr_seq_interna		=	nr_seq_protocolo_p;
else 
	update	protocolo_medicacao 
	set	nm_usuario_aprov	=	nm_usuario_p, 
		dt_aprovacao		=	clock_timestamp(), 
		ie_status		=	ie_status_p 
	where	nr_seq_interna		=	nr_seq_protocolo_p;
 
	if (ie_status_p in ('PC','NA')) and (ds_texto_comunicacao_p IS NOT NULL AND ds_texto_comunicacao_p::text <> '') then 
		select	a.nm_usuario, 
			a.nm_medicacao, 
			b.nm_protocolo, 
			c.ds_tipo_protocolo			 
		into STRICT	ds_destino_comunic_w, 
			ds_subtipo_protocolo_w, 
			ds_protocolo_w, 
			ds_tipo_protocolo_w 
		from	protocolo_medicacao a, 
			protocolo b, 
			tipo_protocolo c 
		where	a.nr_seq_interna = nr_seq_protocolo_p 
		and	b.cd_protocolo = a.cd_protocolo 
		and	c.cd_tipo_protocolo = b.cd_tipo_protocolo;
 
		ds_texto_aux_w		:=	obter_pf_usuario(nm_usuario_p,'N');
		if (ds_texto_aux_w IS NOT NULL AND ds_texto_aux_w::text <> '') then 
			ds_texto_aux_w	:=	obter_desc_expressao(658562)/*'Responsável pela aprovação: '*/
	||': ' 	|| ds_texto_aux_w || chr(13);
		end if;
		 
		if (ie_status_p = 'PC') then 
			ds_texto_aux_w		:=	wheb_mensagem_pck.get_texto(983130)||' ' || chr(13) || chr(13) || ds_texto_aux_w;
		else 
			ds_texto_aux_w		:=	wheb_mensagem_pck.get_texto(983131)||' ' || chr(13) || chr(13) || ds_texto_aux_w;
		end if;
		 
		 
		ds_texto_comunic_w	:= 	ds_texto_aux_w || 
						obter_desc_expressao(299692)/*'Tipo de Protocolo: '*/
	||': '	|| ds_tipo_protocolo_w || chr(13) || 
						obter_desc_expressao(328829)/*'Protocolo: '*/
 			|| ds_protocolo_w || chr(13) || 
						obter_desc_expressao(309812)/*'Sub-tipo do Protocolo: '*/
 ||': ' 	|| ds_subtipo_protocolo_w || chr(13) || 
						chr(13) || 
						ds_texto_comunicacao_p;
		 
		insert	into comunic_interna(	dt_comunicado, 
						ds_titulo, 
						ds_comunicado, 
						nm_usuario, 
						dt_atualizacao, 
						ie_geral, 
						nm_usuario_destino, 
						cd_perfil, 
						nr_sequencia, 
						ie_gerencial, 
						nr_seq_classif, 
						ds_perfil_adicional, 
						cd_setor_destino, 
						cd_estab_destino, 
						ds_setor_adicional, 
						dt_liberacao, 
						ds_grupo) 
		values ( 
						clock_timestamp(), 
						CASE WHEN ie_status_p='PC' THEN obter_desc_expressao(799026)  ELSE obter_desc_expressao(799030) END , 
						ds_texto_comunic_w, 
						nm_usuario_p, 
						clock_timestamp(), 
						'N', 
						ds_destino_comunic_w || ', ' || nm_usuario_p, 
						null, 
						nextval('comunic_interna_seq'), 
						'N', 
						null, 
						null, 
						null, 
						wheb_usuario_pck.get_cd_estabelecimento, 
						null, 
						clock_timestamp(), 
						null);
		 
	end if;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE aprovar_desaprovar_protocolo (nr_seq_protocolo_p bigint, nm_usuario_p text, ie_status_p text default null, ds_texto_comunicacao_p text default null) FROM PUBLIC;

