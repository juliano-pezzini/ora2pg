-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE plt_ajustar_data_plano ( nr_prescricao_p bigint) AS $body$
DECLARE


----------------------------------------------------------------------------------------------------------------------------------------------------
/*									     /
/				ATENÇÃO!!!				     /
/		Esta procedure é chamada somente em trigger, por isso não deve ter commit	     /
/									   */
----------------------------------------------------------------------------------------------------------------------------------------------------
dt_inicio_prescr_w		timestamp;
dt_validade_prescr_w		timestamp;
dt_rep_pt_w			timestamp;
dt_rep_pt2_w			timestamp;
dt_prim_setor_w			timestamp;
nr_horas_validade_w		integer;
cd_setor_atendimento_w		integer;


BEGIN

select	max(dt_inicio_prescr),
	max(dt_validade_prescr),
	max(nr_horas_validade),
	max(cd_setor_atendimento)
into STRICT	dt_inicio_prescr_w,
	dt_validade_prescr_w,
	nr_horas_validade_w,
	cd_setor_atendimento_w
from	prescr_medica
where	nr_prescricao	= nr_prescricao_p;

select	max(hr_inicio_prescricao)
into STRICT	dt_prim_setor_w
from	setor_atendimento
where	cd_setor_atendimento = cd_setor_atendimento_w;

if (dt_prim_setor_w IS NOT NULL AND dt_prim_setor_w::text <> '') then

	dt_rep_pt_w		:= trunc(dt_inicio_prescr_w);

	dt_prim_setor_w	:= converte_char_data(to_char(dt_inicio_prescr_w,'dd/mm/yyyy'),to_char(dt_prim_setor_w,'hh24:mi:ss'),null);

	if (dt_inicio_prescr_w	< dt_prim_setor_w) then
		dt_rep_pt_w	:= trunc(dt_inicio_prescr_w - 1);
	end if;

	if (nr_horas_validade_w	> 24) then

		dt_rep_pt2_w	:= (dt_rep_pt_w + 1);

	else
		dt_rep_pt2_w	:= null;
	end if;

	update	prescr_medica
	set	dt_rep_pt	= dt_rep_pt_w,
		dt_rep_pt2	= dt_rep_pt2_w
	where	nr_prescricao	= nr_prescricao_p;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE plt_ajustar_data_plano ( nr_prescricao_p bigint) FROM PUBLIC;

