-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE excluir_convenio_retorno ( nr_seq_retorno_p bigint, nr_seq_ret_item_p bigint, ie_retorno_p text, ie_item_p text, ie_movto_p text, ie_glosa_p text, nm_usuario_p text, ie_tiss_p text) AS $body$
DECLARE


ie_status_w		varchar(1);
nr_reg_w		bigint;
qt_glosa_w		bigint;


BEGIN

begin
  select ie_status_retorno
  into STRICT ie_status_w
  from convenio_retorno
  where nr_sequencia = nr_seq_retorno_p;
exception
   when others then
   ie_status_w := '';
end;

if (ie_status_w = 'F') or (ie_status_w = 'V') then
	--r.aise_application_error(-20011, 'Operação não permitida. Retorno já vinculado ou baixado !');
	CALL wheb_mensagem_pck.exibir_mensagem_abort(233297);
end if;

if (ie_item_p = 'S') then
	select count(*)
	into STRICT nr_reg_w
	from convenio_retorno_item
	where nr_seq_retorno = nr_seq_retorno_p;

	/*insert into log__tasy (dt_atualizacao, nm_usuario, cd_log, ds_log)
		values (sysdate, nm_usuario_p, 1, 'Retorno=' || nr_seq_retorno_p || ' Registros=' || nr_reg_w);*/
	while(nr_reg_w > 0) loop
	
		select	count(*)
		into STRICT	qt_glosa_w
		from	convenio_retorno_glosa a
		where	a.nr_seq_ret_item in (SELECT b.nr_sequencia
				from	convenio_retorno_item b	
				where	b.nr_seq_retorno	= nr_seq_retorno_p);
		/*Excluir os itens glosados antes de excluir a guia*/
		
		while qt_glosa_w > 0 loop
			begin
			
			delete 	from convenio_retorno_glosa
			where	nr_seq_ret_item in (SELECT b.nr_sequencia
				from	convenio_retorno_item b	
				where	b.nr_seq_retorno	= nr_seq_retorno_p)  LIMIT 999;		
			
			commit;
			qt_glosa_w	:= qt_glosa_w - 1000;			
			end;
		end loop;		
				
		delete from convenio_retorno_item
		where nr_seq_retorno = nr_seq_retorno_p  LIMIT 999;

		commit;
		nr_reg_w := nr_reg_w - 1000;
	end loop;
end if;

if (ie_glosa_p = 'S') then
	select count(*)
	into STRICT nr_reg_w
	from	convenio_retorno_glosa b,
		convenio_retorno_item a
	where a.nr_sequencia = b.nr_seq_ret_item
	  and a.nr_seq_retorno = nr_seq_retorno_p
	  and a.nr_sequencia = coalesce(nr_seq_ret_item_p, a.nr_sequencia)
	  and coalesce(b.nr_seq_conpaci_ret_hist::text, '') = '';

	/*insert into log__tasy (dt_atualizacao, nm_usuario, cd_log, ds_log)
		values (sysdate, nm_usuario_p, 2, 'Retorno=' || nr_seq_retorno_p || ' Item=' || nr_seq_ret_item_p || ' Registros=' || nr_reg_w);*/
	while(nr_reg_w > 0) loop
		delete from convenio_retorno_glosa
		where coalesce(nr_seq_conpaci_ret_hist::text, '') = ''
		  and nr_seq_ret_item in (	SELECT nr_sequencia
							from convenio_retorno_item
							where nr_seq_retorno = nr_seq_retorno_p
							  and nr_sequencia = coalesce(nr_seq_ret_item_p, nr_sequencia))  LIMIT 999;

		commit;
		nr_reg_w := nr_reg_w - 1000;
	end loop;
end if;

if (ie_movto_p = 'S') then
	select count(*)
	into STRICT nr_reg_w
	from convenio_retorno_movto
	where nr_seq_retorno = nr_seq_retorno_p
	  and coalesce(nr_seq_ret_item,0) = coalesce(nr_seq_ret_item_p, coalesce(nr_seq_ret_item, 0));

	/*insert into log__tasy (dt_atualizacao, nm_usuario, cd_log, ds_log)
		values (sysdate, nm_usuario_p, 3, 'Retorno=' || nr_seq_retorno_p || ' Item=' || nr_seq_ret_item_p || ' Registros=' || nr_reg_w);*/
	while(nr_reg_w > 0) loop
		delete from convenio_retorno_movto
		where nr_seq_retorno = nr_seq_retorno_p
		  and coalesce(nr_seq_ret_item,0) = coalesce(nr_seq_ret_item_p, coalesce(nr_seq_ret_item,0))  LIMIT 999;

		commit;
		nr_reg_w := nr_reg_w - 1000;
	end loop;
end if;

if (coalesce(ie_tiss_p, 'N') = 'S') then
	delete	from	tiss_cabecalho
	where	nr_seq_retorno = nr_seq_retorno_p;
end if;

if (ie_retorno_p = 'S') then
	delete from convenio_retorno
	where nr_sequencia = nr_seq_retorno_p;
end if;

commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE excluir_convenio_retorno ( nr_seq_retorno_p bigint, nr_seq_ret_item_p bigint, ie_retorno_p text, ie_item_p text, ie_movto_p text, ie_glosa_p text, nm_usuario_p text, ie_tiss_p text) FROM PUBLIC;

