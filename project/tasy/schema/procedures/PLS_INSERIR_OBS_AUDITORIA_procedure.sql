-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inserir_obs_auditoria ( nr_seq_auditoria_p bigint, ds_observacao_p text, nm_usuario_p text) AS $body$
DECLARE


ds_observacao_w			varchar(4000);
ds_obs_req_w			varchar(4000);
ds_obs_guia_w			varchar(4000);
ds_obs_aud_w			varchar(4000);
nr_seq_requisicao_w		bigint;
nr_seq_guia_w			bigint;
ie_alterar_obs_w		varchar(4);


BEGIN

update	pls_auditoria
set	ds_observacao	= substr(ds_observacao_p,1,4000),
	nm_usuario	= nm_usuario_p,
	dt_atualizacao	= clock_timestamp()
where	nr_sequencia	= nr_seq_auditoria_p;

begin
	select	nr_seq_requisicao,
		nr_seq_guia
	into STRICT	nr_seq_requisicao_w,
		nr_seq_guia_w
	from	pls_auditoria
	where	nr_sequencia	= nr_seq_auditoria_p;
exception
when others then
	nr_seq_requisicao_w	:= null;
	nr_seq_guia_w		:= null;
end;

if (nr_seq_requisicao_w IS NOT NULL AND nr_seq_requisicao_w::text <> '') then
	select	substr(ds_observacao,1,4000)
	into STRICT	ds_obs_req_w
	from	pls_requisicao
	where	nr_sequencia	= nr_seq_requisicao_w;

	select	substr(ds_observacao,1,4000)
	into STRICT	ds_obs_aud_w
	from	pls_auditoria
	where	nr_sequencia	= nr_seq_auditoria_p;
	
	if (trim(both coalesce(ds_obs_req_w,'X'))	<> trim(both coalesce(ds_obs_aud_w,'X'))) then
		if (coalesce(ds_obs_req_w,'X')	<> 'X') then
			ds_observacao_w	:= substr(obter_desc_expressao(1076563)||chr(13)||ds_obs_req_w,1,4000);
		end if;
		
		CALL pls_requisicao_gravar_hist(nr_seq_requisicao_w,'L',coalesce(ds_observacao_w,obter_desc_expressao(1076565)),null,nm_usuario_p);

		update	pls_requisicao
		set	ds_observacao	= CASE WHEN coalesce(ds_obs_aud_w,'X')='X' THEN ''  ELSE ds_obs_aud_w END ,
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp()
		where	nr_sequencia	= nr_seq_requisicao_w;
		
		commit;
	end if;
elsif (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') then
	select	substr(ds_observacao,1,4000)
	into STRICT	ds_obs_guia_w
	from	pls_guia_plano
	where	nr_sequencia	= nr_seq_guia_w;

	select	substr(ds_observacao,1,4000)
	into STRICT	ds_obs_aud_w
	from	pls_auditoria
	where	nr_sequencia	= nr_seq_auditoria_p;
	
	if (trim(both coalesce(ds_obs_guia_w,'X'))	<> trim(both coalesce(ds_obs_aud_w,'X'))) then
		if (coalesce(ds_obs_guia_w,'X')	<> 'X') then
			ds_observacao_w	:= substr(obter_desc_expressao(1076563)||chr(13)||ds_obs_guia_w,1,4000);
		end if;
		
		CALL pls_guia_gravar_historico(nr_seq_guia_w,2,coalesce(ds_observacao_w,obter_desc_expressao(1076565)),null,nm_usuario_p);

		update	pls_guia_plano
		set	ds_observacao	= CASE WHEN coalesce(ds_obs_aud_w,'X')='X' THEN ''  ELSE ds_obs_aud_w END ,
			nm_usuario	= nm_usuario_p,
			dt_atualizacao	= clock_timestamp()
		where	nr_sequencia	= nr_seq_guia_w;
		
		commit;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inserir_obs_auditoria ( nr_seq_auditoria_p bigint, ds_observacao_p text, nm_usuario_p text) FROM PUBLIC;

