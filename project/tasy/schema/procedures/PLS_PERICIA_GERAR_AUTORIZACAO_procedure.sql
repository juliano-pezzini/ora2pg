-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_pericia_gerar_autorizacao ( nr_seq_pericia_p bigint, nm_usuario_p text, nr_seq_autorizacao_p INOUT bigint) AS $body$
DECLARE


cd_estabelecimento_w		smallint;
nr_seq_autorizacao_w		bigint;
nr_seq_segurado_w		bigint;
nr_seq_plano_w			bigint;
ie_tipo_rede_atendimento_w	varchar(1);
nr_seq_prestador_w		bigint;
cd_medico_executor_w		varchar(10);


BEGIN

/* obter dados da perícia */

select	cd_estabelecimento,
	nr_seq_segurado,
	ie_tipo_rede_atendimento,
	nr_seq_prestador,
	cd_medico_executor
into STRICT	cd_estabelecimento_w,
	nr_seq_segurado_w,
	ie_tipo_rede_atendimento_w,
	nr_seq_prestador_w,
	cd_medico_executor_w
from	pls_pericia_medica
where	nr_sequencia	= nr_seq_pericia_p;

/* Para perícias realizadas em rede Particular, a guia de autorização é gerada sem prestador e sem médico */

if (ie_tipo_rede_atendimento_w	= 'P') then
	nr_seq_prestador_w	:= null;
	cd_medico_executor_w	:= null;
end if;

/* obter dados do segurado */

nr_seq_plano_w := pls_obter_produto_benef(nr_seq_segurado_w, clock_timestamp());

select	nextval('pls_guia_plano_seq')
into STRICT	nr_seq_autorizacao_w
;

insert into pls_guia_plano(
	nr_sequencia, dt_atualizacao, nm_usuario,
	dt_atualizacao_nrec, nm_usuario_nrec, nr_seq_segurado,
	cd_guia, ie_tipo_guia, dt_solicitacao,
	cd_medico_solicitante, qt_dia_solicitado, qt_dia_autorizado,
	ie_status, nr_seq_prestador, nr_seq_plano,
	ie_situacao, cd_estabelecimento, ie_tipo_processo,
	ie_forma_imp, ie_tipo_segurado, nr_seq_pericia,
	ie_estagio)
values (	nr_seq_autorizacao_w, clock_timestamp(), nm_usuario_p,
	clock_timestamp(), nm_usuario_p, nr_seq_segurado_w,
	nr_seq_autorizacao_w, '2', clock_timestamp(),
	cd_medico_executor_w, 0, 0,
	'2', nr_seq_prestador_w, nr_seq_plano_w,
	'U', cd_estabelecimento_w, 'M',
	'T', 'P', nr_seq_pericia_p,
	7);

nr_seq_autorizacao_p	:= nr_seq_autorizacao_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_pericia_gerar_autorizacao ( nr_seq_pericia_p bigint, nm_usuario_p text, nr_seq_autorizacao_p INOUT bigint) FROM PUBLIC;

