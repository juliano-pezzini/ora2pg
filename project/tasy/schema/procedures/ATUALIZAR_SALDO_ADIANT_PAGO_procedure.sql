-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_saldo_adiant_pago (nr_adiantamento_p bigint, nm_usuario_p text, vl_cotacao_p bigint default null, dt_baixa_p timestamp default null) AS $body$
DECLARE


-- edgar 12/04/2008,  nao dar commit nesta procedure


/* Projeto Multimoeda - Adicionado o parametro vl_cotacao_p com default null, onde sera passado o valor da cotacao que sera utilizado para converter o saldo em moeda estrangeira.
	Parametro adicionado como default para nao interferir no processo atual, nao sendo necessario passar o parametro quando nao se tratar de operacao em moeda estrangeira,
	as chamadas da procedure onde nao se tratar de transacao multimoeda nao precisa passar o parametro. */
	
vl_adiant_titulo_w		double precision;
vl_devolucao_w			double precision;
vl_vinculado_oc_w		double precision;
ie_deduzir_ordem_adiant_w	varchar(1)	:= 'S';
cd_estabelecimento_w		smallint;
dt_contabil_w 			timestamp;
vl_adiantamento_w		double precision;
vl_saldo_w			double precision;
dt_baixa_w			timestamp := null;
cont_w				bigint;
ie_deduzir_imposto_adiant_w	parametros_contas_pagar.ie_deduzir_imposto_adiant%type;
/* Projeto Multimoeda - Variaveis */

vl_adto_estrang_w	double precision;
cd_moeda_w		integer;
vl_saldo_estrang_w	double precision;


BEGIN

select	max(cd_estabelecimento),
	coalesce(max(vl_adiantamento),0),
	coalesce(max(vl_adto_estrang),0),  /* Projeto Multimoeda - busca o valor do adiantamento e a moeda para verificar se a um adiantamento em moeda estrangeira. */
	max(cd_moeda)
into STRICT	cd_estabelecimento_w,
	vl_adiantamento_w,
	vl_adto_estrang_w,
	cd_moeda_w
from	adiantamento_pago
where	nr_adiantamento	= nr_adiantamento_p;

if (cd_estabelecimento_w IS NOT NULL AND cd_estabelecimento_w::text <> '') then
	select	coalesce(max(ie_deduzir_ordem_adiant),'S'),
		coalesce(max(ie_deduzir_imposto_adiant),'S')
	into STRICT	ie_deduzir_ordem_adiant_w,
		ie_deduzir_imposto_adiant_w
	from	parametros_contas_pagar
	where	cd_estabelecimento	= cd_estabelecimento_w;
end if;

/* Projeto Multimoeda - Verifica se o adiantamento a em moeda estrangeira, se sim atualiza o saldo em moeda estrangeira e converte para moeda nacional, se nao mantam o processo atual*/

if (coalesce(vl_adto_estrang_w,0) <> 0 and coalesce(vl_cotacao_p,0) <> 0 and (cd_moeda_w IS NOT NULL AND cd_moeda_w::text <> '')) then
	select	coalesce(sum(a.vl_adto_estrang), 0),
		coalesce(max(a.dt_contabil),clock_timestamp())
	into STRICT	vl_adiant_titulo_w,
		dt_contabil_w
	from	titulo_pagar b,
		titulo_pagar_adiant a
	where	a.nr_adiantamento	= nr_adiantamento_p
	and	b.nr_titulo		= a.nr_titulo
	and (not exists (SELECT	1
		 from		nota_fiscal_item y, 
				ordem_compra_adiant_pago x
		 where		x.nr_adiantamento	= a.nr_adiantamento
		 and		x.nr_ordem_compra	= y.nr_ordem_compra
		 and		y.nr_sequencia	= b.nr_seq_nota_fiscal) or (ie_deduzir_ordem_adiant_w = 'N')); /* ahoffelder - OS 219063 - 01/06/2010 -	adicionei o " or ie_deduzir_ordem_adiant_w = 'N'" aqui */
	select	coalesce(sum(vl_devolucao_estrang), 0)
	into STRICT	vl_devolucao_w
	from	adiant_pago_dev
	where	nr_adiantamento	= nr_adiantamento_p;

	vl_saldo_estrang_w	:= vl_adto_estrang_w - vl_adiant_titulo_w - vl_devolucao_w;

	if (vl_saldo_estrang_w = 0) then
		if (dt_baixa_p IS NOT NULL AND dt_baixa_p::text <> '') then
			dt_baixa_w := 	dt_baixa_p;	
		else
			dt_baixa_w := 	dt_contabil_w;
		end if;	
	end if;

	update	adiantamento_pago
	set	nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp(),
		vl_saldo_estrang = vl_saldo_estrang_w,
		vl_saldo	 = vl_saldo_estrang_w * vl_cotacao_p,
		dt_baixa	= dt_baixa_w
	where	nr_adiantamento	= nr_adiantamento_p;
	
else

	if (ie_deduzir_ordem_adiant_w = 'S') then
		select	coalesce(sum(vl_vinculado), 0)
		into STRICT	vl_vinculado_oc_w
		from	ordem_compra_adiant_pago
		where	nr_adiantamento	= nr_adiantamento_p;
	elsif (ie_deduzir_ordem_adiant_w = 'F') or /*AAMFIRMO 15/04/2013 OS 576529 deduzir saldo do adiantamento somente qdo possuir OC com NF calculada*/
		(ie_deduzir_ordem_adiant_w = 'V')then

		select	coalesce(count(*),0)
		into STRICT	cont_w
		from	nota_fiscal b,
				ordem_compra_adiant_pago c
		where	(b.nr_ordem_compra IS NOT NULL AND b.nr_ordem_compra::text <> '')
		and		b.nr_ordem_compra	= c.nr_ordem_compra
		and		(b.dt_atualizacao_estoque IS NOT NULL AND b.dt_atualizacao_estoque::text <> '')
		and		c.nr_adiantamento	= nr_adiantamento_p;

		if (cont_w > 0) then 
			if (ie_deduzir_ordem_adiant_w = 'F') then
				/*select	nvl(sum(c.vl_vinculado), 0)
				into	vl_vinculado_oc_w
				from	nota_fiscal b,
					ordem_compra_adiant_pago c
				where	b.nr_ordem_compra	= c.nr_ordem_compra
				and	b.dt_atualizacao_estoque is not null
				and	c.nr_adiantamento	= nr_adiantamento_p;*/

				/*Retirei o select acima e colloquei esse abaixo. No de cima, pode existir varias NF's para uma mesma OC, ai como tem a tabela NOTA_FISCAL,  vem varias linhas com o SUM e acaba deixando os adiantamentos negativos*/

				select	coalesce(sum(c.vl_vinculado), 0)
				into STRICT	vl_vinculado_oc_w
				from	ordem_compra_adiant_pago c
				where	c.nr_adiantamento	= nr_adiantamento_p
				and		exists ( SELECT 1
								 from	nota_fiscal b
								 where  b.nr_ordem_compra = c.nr_ordem_compra
								 and	(b.dt_atualizacao IS NOT NULL AND b.dt_atualizacao::text <> ''));

			elsif (ie_deduzir_ordem_adiant_w = 'V') then			
				select	coalesce(sum(a.vl_vinculado), 0)
				into STRICT	vl_vinculado_oc_w
				from	nota_fiscal_adiant_pago a,
					nota_fiscal b,
					ordem_compra_adiant_pago c
				where	a.nr_sequencia_nf	= b.nr_sequencia
				and	b.nr_ordem_compra	= c.nr_ordem_compra
				and	(b.dt_atualizacao_estoque IS NOT NULL AND b.dt_atualizacao_estoque::text <> '')
				and	c.nr_adiantamento	= nr_adiantamento_p
				and	a.nr_adiantamento	= nr_adiantamento_p;			

			end if;
		else
			vl_vinculado_oc_w := 0;
		end if;
	else
		vl_vinculado_oc_w:= 0;
	end if;

	select	coalesce(sum(coalesce(a.vl_pago_adiant, a.vl_adiantamento)), 0) + CASE WHEN coalesce(ie_deduzir_imposto_adiant_w,'S')='N' THEN 0  ELSE coalesce(sum(coalesce(a.vl_imposto,0)),0) END ,
		coalesce(max(a.dt_contabil),clock_timestamp())
	into STRICT	vl_adiant_titulo_w,
		dt_contabil_w
	from	titulo_pagar b,
		titulo_pagar_adiant a
	where	a.nr_adiantamento	= nr_adiantamento_p
	and	b.nr_titulo		= a.nr_titulo
	and (not exists (SELECT	1
		 from		nota_fiscal_item y, 
				ordem_compra_adiant_pago x
		 where		x.nr_adiantamento	= a.nr_adiantamento
		 and		x.nr_ordem_compra	= y.nr_ordem_compra
		 and		y.nr_sequencia	= b.nr_seq_nota_fiscal) or (ie_deduzir_ordem_adiant_w = 'N')); /* ahoffelder - OS 219063 - 01/06/2010 -	adicionei o " or ie_deduzir_ordem_adiant_w = 'N'" aqui */
	select	coalesce(sum(vl_devolucao), 0)
	into STRICT	vl_devolucao_w
	from	adiant_pago_dev
	where	nr_adiantamento	= nr_adiantamento_p;

	vl_saldo_w	:= vl_adiantamento_w - vl_adiant_titulo_w - vl_devolucao_w - vl_vinculado_oc_w;

	if (vl_saldo_w = 0) then
		if (dt_baixa_p IS NOT NULL AND dt_baixa_p::text <> '') then
			dt_baixa_w := 	dt_baixa_p;	
		else
			dt_baixa_w := 	dt_contabil_w;
		end if;	
	end if;
	
	update	adiantamento_pago
	set	nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp(),
		vl_saldo	= vl_saldo_w,
		dt_baixa	= dt_baixa_w
	where	nr_adiantamento	= nr_adiantamento_p;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_saldo_adiant_pago (nr_adiantamento_p bigint, nm_usuario_p text, vl_cotacao_p bigint default null, dt_baixa_p timestamp default null) FROM PUBLIC;

