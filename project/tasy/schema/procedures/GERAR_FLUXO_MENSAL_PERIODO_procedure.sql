-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_fluxo_mensal_periodo (cd_estabelecimento_p bigint, cd_empresa_p bigint, ie_restringe_estab_p text, dt_inicial_p timestamp, dt_final_p timestamp, dt_atual_p timestamp, nm_usuario_p text, qt_nivel_p bigint, ie_classificacao_p text, vl_saldo_anterior_p bigint, ie_data_atual_p text, ie_todas_contas_p text) AS $body$
DECLARE


dt_final_w		timestamp;
dt_atual_w		timestamp;
ie_classificaco_w	varchar(5)	:= '';

-- 'RM' = RelatÃ³rio Mensal
BEGIN

dt_atual_w		:= null;

if (ie_classificacao_p in ('P', 'PG')) then		-- passado
	ie_classificaco_w		:= ie_classificacao_p;

elsif (ie_classificacao_p in ('R','RG')) then		-- a realizar
	ie_classificaco_w		:= ie_classificacao_p;

elsif (ie_classificacao_p in ('PR','PRG')) then	-- passado/realizar
	if (ie_data_atual_p = 'R') then
		dt_atual_w	:= coalesce(dt_atual_p, clock_timestamp());
	else
		dt_atual_w	:= coalesce(dt_atual_p, clock_timestamp()) + 1;
	end if;

	if (ie_classificacao_p = 'PR') then
		ie_classificaco_w		:= '';
	else
		ie_classificaco_w		:= 'PRGM';
	end if;

end if;

dt_final_w		:= dt_final_p;
if (dt_final_w > OBTER_DIA_UTIL_PERIODO(cd_estabelecimento_p, dt_inicial_p, 22)) then
	dt_final_w	:= OBTER_DIA_UTIL_PERIODO(cd_estabelecimento_p, dt_inicial_p, 22);
end if;

CALL gerar_view_fluxo_caixa(	cd_estabelecimento_p,
			dt_inicial_p,
			dt_final_w,
			dt_atual_w,
			'D',
			ie_classificaco_w || 'RM',
			qt_nivel_p,
			cd_empresa_p,
			ie_restringe_estab_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_fluxo_mensal_periodo (cd_estabelecimento_p bigint, cd_empresa_p bigint, ie_restringe_estab_p text, dt_inicial_p timestamp, dt_final_p timestamp, dt_atual_p timestamp, nm_usuario_p text, qt_nivel_p bigint, ie_classificacao_p text, vl_saldo_anterior_p bigint, ie_data_atual_p text, ie_todas_contas_p text) FROM PUBLIC;

