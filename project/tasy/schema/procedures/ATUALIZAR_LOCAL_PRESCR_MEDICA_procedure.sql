-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_local_prescr_medica ( nr_prescricao_p bigint, cd_local_estoque_p bigint) AS $body$
DECLARE


  qt_existe_w           smallint;					
  ie_local_valido_w     varchar(1);
  cd_estabelecimento_w  estabelecimento.cd_estabelecimento%type;

  c01 CURSOR FOR
    SELECT  a.cd_material         cd_material
    from    prescr_material       a
    where   nr_prescricao     =   nr_prescricao_p;

BEGIN
  cd_estabelecimento_w := coalesce(wheb_usuario_pck.get_cd_estabelecimento, 1);
  for material in c01 loop
    begin
      ie_local_valido_p     => ie_local_valido_w := obter_local_valido(cd_estabelecimento_p => cd_estabelecimento_w, cd_local_estoque_p   => cd_local_estoque_p, cd_material_p         => material.cd_material, ie_origem_documento_p => '', ie_local_valido_p     => ie_local_valido_w);

      if (ie_local_valido_w = 'N') then
        /*Local nao e valido para a operacao*/

	      CALL wheb_mensagem_pck.exibir_mensagem_abort(1122723, 'DS_ERRO=' || to_char(material.cd_material) || ' ' || Obter_Desc_Material(material.cd_material) || ' ' || WHEB_MENSAGEM_PCK.get_texto(1122658));

      end if;
    end;
  end loop;

  select 	count(nr_prescricao)
  into STRICT	qt_existe_w
  from 	prescr_medica 
  where 	nr_prescricao = nr_prescricao_p  LIMIT 1;

  if (qt_existe_w > 0) then
    update	prescr_medica
    set 	  cd_local_estoque 	=   cd_local_estoque_p  
    where 	nr_prescricao 	  =   nr_prescricao_p;

    update  prescr_material
    set     cd_local_estoque  =   cd_local_estoque_p
    where   nr_prescricao     =   nr_prescricao_p;
  end if;

  commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_local_prescr_medica ( nr_prescricao_p bigint, cd_local_estoque_p bigint) FROM PUBLIC;

