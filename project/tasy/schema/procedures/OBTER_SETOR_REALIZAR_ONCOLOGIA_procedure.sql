-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_setor_realizar_oncologia ( cd_pessoa_fisica_p text, cd_setor_realizar_p INOUT bigint, nr_atendimento_p bigint default null) AS $body$
DECLARE

 
cd_setor_ult_atendimento_w	bigint;
nr_atendimento_w			bigint;
cd_setor_realizar_w			bigint;
cd_convenio_w				bigint;
ie_obrigar_regra_setor_w	varchar(2);
ie_atendimento_atual_w		varchar(2);
qt_reg_w					bigint := 0;

BEGIN
 
ie_obrigar_regra_setor_w := obter_param_usuario(281, 912, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_obrigar_regra_setor_w);
ie_atendimento_atual_w := obter_param_usuario(281, 1409, obter_perfil_ativo, wheb_usuario_pck.get_nm_usuario, wheb_usuario_pck.get_cd_estabelecimento, ie_atendimento_atual_w);
 
if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (nr_atendimento_p > 0) and (coalesce(ie_atendimento_atual_w,'N') = 'S') then 
	 
	nr_atendimento_w := nr_atendimento_p;
	 
else 
 
	select	max(nr_atendimento) 
	into STRICT	nr_atendimento_w 
	from	atendimento_paciente 
	where	cd_pessoa_fisica = cd_pessoa_fisica_p 
	and		ie_tipo_atendimento <> 7 
	and		coalesce(dt_alta::text, '') = '';
 
end if;
 
if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then 
 
	select	max(cd_setor_atendimento) 
	into STRICT	cd_setor_ult_atendimento_w 
	from	atend_paciente_unidade 
	where	nr_seq_interno = ( 
		SELECT Obter_Atepacu_paciente(nr_atendimento_w, 'A') 
		);
	cd_convenio_w			:= coalesce(obter_convenio_atendimento(nr_atendimento_w),0);	
 
 
	if (cd_setor_ult_atendimento_w IS NOT NULL AND cd_setor_ult_atendimento_w::text <> '') then 
		select max(cd_setor_realizar) 
		into STRICT	cd_setor_realizar_w 
		from	REGRA_SETOR_ONCOLOGIA 
		where	coalesce(cd_setor_ult_atendimento,cd_setor_ult_atendimento_w)	= cd_setor_ult_atendimento_w 
		and	coalesce(cd_convenio,cd_convenio_w) = cd_convenio_w;
	end if;
	 
	if (cd_setor_realizar_w IS NOT NULL AND cd_setor_realizar_w::text <> '') then 
		select 	count(*) 
		into STRICT	qt_reg_w 
		from 	setor_atendimento 
		where 	cd_classif_setor not in (6,7) 
		and 	ie_situacao = 'A' 
		and 	coalesce(ie_trat_oncologico,'S') = 'S' 
		and 	cd_estabelecimento_base = wheb_usuario_pck.get_cd_estabelecimento 
		and 	obter_se_setor_usuario(cd_setor_atendimento,wheb_usuario_pck.get_nm_usuario) = 'S' 
		and		cd_setor_atendimento = cd_setor_realizar_w;
	end if;
		 
end if;
if (coalesce(ie_obrigar_regra_setor_w,'N') = 'SO' ) or (qt_reg_w = 0)then 
	cd_setor_realizar_p := null;
else 
	cd_setor_realizar_p	:= cd_setor_realizar_w;
end if;
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_setor_realizar_oncologia ( cd_pessoa_fisica_p text, cd_setor_realizar_p INOUT bigint, nr_atendimento_p bigint default null) FROM PUBLIC;

