-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE total_extrato_parcela_grupo_js ( nr_resumo_p bigint, nr_seq_grupo_p bigint, cd_estabelecimento_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, dt_processamento_p timestamp, ie_dt_proc_p text, ie_tipo_arquivo_p text, vl_nao_conciliado_p INOUT text, vl_conciliado_p INOUT text, vl_total_p INOUT text) AS $body$
DECLARE


vl_nao_conciliado_w	double precision;
vl_conciliado_w		double precision;
vl_total_w		double precision;


BEGIN
select  coalesce(sum(CASE WHEN coalesce(nr_seq_extrato_parcela::text, '') = '' THEN vl_parcela  ELSE 0 END ),0) vl_nao_conciliado,
	coalesce(sum(CASE WHEN coalesce(nr_seq_extrato_parcela::text, '') = '' THEN 0  ELSE vl_parcela END ),0) vl_conciliado
into STRICT	vl_nao_conciliado_w,
	vl_conciliado_w
from 	(SELECT	a.nr_sequencia,
		b.dt_transacao,
		a.dt_parcela,
		a.vl_parcela,
		b.nr_autorizacao,
		b.ds_comprovante,
		substr(obter_qt_parcela_cartao(a.nr_sequencia),1,10) ds_parcela,
		substr(obter_se_parcela_cartao_concil(null,a.nr_sequencia),1,1) ie_concil,
		a.nr_seq_extrato_parcela
	from	movto_cartao_cr b,
		movto_cartao_cr_parcela a,
		bandeira_cartao_cr c
	where	a.nr_seq_movto		= b.nr_sequencia
	and	coalesce(b.dt_cancelamento::text, '') = ''
	and	b.nr_seq_bandeira	= c.nr_sequencia
	and	((a.nr_resumo	= nr_resumo_p)
	or (c.nr_seq_grupo		= nr_seq_grupo_p
	and	b.cd_estabelecimento	= cd_estabelecimento_p
	and	trunc(b.dt_transacao,'dd') between trunc(to_date(dt_inicial_p),'dd')
	and 	fim_dia(to_date(dt_final_p))
	and (trunc(a.dt_parcela,'month') = trunc(to_date(dt_processamento_p),'month')
	or 	ie_dt_proc_p = 'N')))
	and	a.vl_saldo_liquido > 0
	and	b.ie_tipo_cartao = CASE WHEN ie_tipo_arquivo_p='F' THEN 'C'  ELSE ie_tipo_arquivo_p END
	and (not exists (select	1
		from	forma_pagto_tef x
		where	x.nr_seq_bandeira = c.nr_sequencia)
		or	exists (select	1
			from	forma_pagto_tef x
			where	x.ie_tipo_cartao in ('A',CASE WHEN ie_tipo_arquivo_p='F' THEN 'C'  ELSE ie_tipo_arquivo_p END )))
	order by b.dt_transacao,
		a.dt_parcela) alias27;
vl_total_w		:= 	vl_nao_conciliado_w + vl_conciliado_w;
vl_nao_conciliado_p	:=	campo_mascara_virgula(vl_nao_conciliado_w);
vl_conciliado_p		:= 	campo_mascara_virgula(vl_conciliado_w);
vl_total_p			:= 	campo_mascara_virgula(vl_total_w);
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE total_extrato_parcela_grupo_js ( nr_resumo_p bigint, nr_seq_grupo_p bigint, cd_estabelecimento_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, dt_processamento_p timestamp, ie_dt_proc_p text, ie_tipo_arquivo_p text, vl_nao_conciliado_p INOUT text, vl_conciliado_p INOUT text, vl_total_p INOUT text) FROM PUBLIC;

