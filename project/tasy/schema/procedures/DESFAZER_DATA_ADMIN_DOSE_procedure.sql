-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_data_admin_dose ( dt_referencia_p timestamp, dt_real_p timestamp, nr_prescricao_p bigint, nm_usuario_p text, nr_seq_horario_p bigint default null) AS $body$
DECLARE


nr_seq_atendimento_w    can_ordem_prod.nr_seq_atendimento%TYPE;
dt_administracao_w    paciente_atend_medic_adm.dt_administracao%TYPE;
dt_fim_administracao_w    paciente_atend_medic_adm.dt_fim_administracao%TYPE;
nr_seq_material_w       prescr_material.nr_seq_material%TYPE;


BEGIN


if (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') then
	update	can_ordem_prod
	set	 	dt_administracao  = NULL,
			dt_checagem		  = NULL,
        	nm_usuario		 = nm_usuario_p,
        	nm_usuario_adm	 = nm_usuario_p         		
	where	nr_prescricao	 = nr_prescricao_p  
  	and     nr_sequencia     = (SELECT max(b.nr_seq_ordem)
                            	from   can_ordem_item_prescr b
                          		where  b.nr_seq_mat_hor  =   nr_seq_horario_p);


elsif (dt_real_p IS NOT NULL AND dt_real_p::text <> '') then

 	update	can_ordem_prod
	set	dt_administracao	 = NULL,
		dt_checagem	 = NULL,
		nm_usuario		= nm_usuario_p,
		nm_usuario_adm		= nm_usuario_p
	where	nr_prescricao		= nr_prescricao_p
	and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prevista)	= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_real_p);

else
	update	can_ordem_prod
	set	dt_administracao	 = NULL,
		dt_checagem	 = NULL,
		nm_usuario		= nm_usuario_p,
		nm_usuario_adm		= nm_usuario_p
	where	nr_prescricao		= nr_prescricao_p
	and	ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prevista)	= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_referencia_p);

end if;

if (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') then
    select  pm.nr_seq_atendimento, pm.nr_seq_material
    into STRICT    nr_seq_atendimento_w, nr_seq_material_w
    from    prescr_material pm
    join    prescr_mat_hor pmh on pmh.nr_seq_material = pm.nr_sequencia and pmh.nr_prescricao = pm.nr_prescricao
    where   pmh.nr_sequencia = nr_seq_horario_p;
else
    select  max(nr_seq_atendimento)
    into STRICT    nr_seq_atendimento_w
    from    can_ordem_prod
    where	nr_prescricao	= nr_prescricao_p;

    select  NR_SEQ_ATENDIMENTO, NR_SEQ_MATERIAL
    into STRICT    nr_seq_atendimento_w, nr_seq_material_w
    from    paciente_atend_medic
    where   nr_seq_atendimento = nr_seq_atendimento_w
    and     nr_seq_material in (SELECT b.nr_seq_prescricao
        from can_ordem_item_prescr b, can_ordem_prod a
        where b.nr_prescricao = nr_prescricao_p
        and ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(a.dt_prevista) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(coalesce(dt_real_p, dt_referencia_p))
        and b.nr_seq_ordem = a.nr_sequencia);
end if;

update paciente_atend_medic
set ie_administracao = 'P',
dt_atualizacao = clock_timestamp(),
nm_usuario = nm_usuario_p
where NR_SEQ_ATENDIMENTO = nr_seq_atendimento_w
and NR_SEQ_MATERIAL = nr_seq_material_w;

delete FROM paciente_atend_medic_adm
where nr_seq_atendimento = nr_seq_atendimento_w
and NR_SEQ_MATERIAL = nr_seq_material_w
and IE_STATUS_ADM = 1;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_data_admin_dose ( dt_referencia_p timestamp, dt_real_p timestamp, nr_prescricao_p bigint, nm_usuario_p text, nr_seq_horario_p bigint default null) FROM PUBLIC;

