-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_qtde_dispensada ( nr_cirurgia_p bigint, cd_material_p bigint, qt_dispensacao_p bigint, ds_inconsistencia_p INOUT text ) AS $body$
DECLARE


nr_prescricao_w				bigint;
qt_material_prescr_w		double precision;
qt_material_disp_w			double precision;
cd_unidade_medida_consumo_w	varchar(30);


BEGIN

if (nr_cirurgia_p IS NOT NULL AND nr_cirurgia_p::text <> '') and (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then

	select  max(cd_unidade_medida_consumo)
	into STRICT	cd_unidade_medida_consumo_w
	from 	material
	where 	cd_material = cd_material_p;

	select  max(nr_prescricao)
	into STRICT 	nr_prescricao_w
	from    cirurgia
	where   nr_cirurgia = nr_cirurgia_p;

	if (nr_prescricao_w > 0) and (cd_unidade_medida_consumo_w IS NOT NULL AND cd_unidade_medida_consumo_w::text <> '') then

		SELECT  sum(qt_material)
		into STRICT	qt_material_prescr_w
		FROM    PRESCR_MATERIAL
		WHERE   nr_prescricao = nr_prescricao_w
		AND     cd_material   = cd_material_p
		and     cd_unidade_medida = cd_unidade_medida_consumo_w;
	end if;

	if (cd_unidade_medida_consumo_w IS NOT NULL AND cd_unidade_medida_consumo_w::text <> '') then

		SELECT SUM(qt_dispensacao)
		into STRICT   qt_material_disp_w
		FROM   CIRURGIA_AGENTE_DISP
		WHERE  nr_cirurgia = nr_cirurgia_p
		AND    cd_material = cd_material_p
		and    cd_unidade_medida = cd_unidade_medida_consumo_w;
	end if;


	if ((coalesce(qt_material_disp_w,0) + qt_dispensacao_p ) > qt_material_prescr_w) then
		ds_inconsistencia_p	:= wheb_mensagem_pck.get_texto(300317);
	end if;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_qtde_dispensada ( nr_cirurgia_p bigint, cd_material_p bigint, qt_dispensacao_p bigint, ds_inconsistencia_p INOUT text ) FROM PUBLIC;

