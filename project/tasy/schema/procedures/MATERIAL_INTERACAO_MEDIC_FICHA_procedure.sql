-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE material_interacao_medic_ficha (nm_usuario_p text) AS $body$
DECLARE



C01 CURSOR FOR
	SELECT 	distinct  coalesce(g3.approved,g3.gencode) cd_dcb,  
		g3.generic ds_dcb,
		coalesce(g2.approved,g2.gencode) cd_dcb_interacao, 
		g2.generic ds_dcb_interacao,
		a.druginteractionnotesen,  
		s.severitydescen,
		s.severityid,
		o.observationnotesen,
		a.druginteractclassid1,
		a.druginteractclassid2,
		l.likelihooddescen,
		l.likelihooddef
	from	drug_class_interaction a,
		DRG_GEN_ROUTE_INT b1,
		drug_interact_class c1,
		DRG_GEN_ROUTE_INT b2,
		drug_interact_class c2,
		gendat g2,
		severity s,
		likelihood l,
		observation o,
		gendat g3
	where	a.druginteractclassid1	=	b1.druginteractclassid
	and	b1.druginteractclassid	=	c1.druginteractclassid
	and	a.druginteractclassid2	=	b2.druginteractclassid
	and	b2.druginteractclassid	=	c2.druginteractclassid
	and	b2.genericcode	=	g2.gencode
	and	b1.genericcode	=	g3.gencode
	and	a.severityid	=	s.severityid
	and	a.likelihoodid	=	l.likelihoodid
	and	a.observationid	=	o.observationid
	order	by	cd_dcb, cd_dcb_interacao, druginteractclassid2 desc, druginteractclassid1 desc;

c02 CURSOR(	druginteractclassi1_p	bigint,
	druginteractclassid2_p	bigint) FOR
	SELECT	htmlreference
	from	drug_interaction_reference
	where	druginteractclassid1	=	druginteractclassi1_p
	and 	druginteractclassid2	=	druginteractclassid2_p;	
	
c03 CURSOR(p_drug_class1 bigint, p_drug_class2 bigint) FOR	
SELECT distinct precautionid ,precautionnotesen from (
SELECT a.precautionid, a.precautionnotesen
  from precaution a, drug_class_int_precaution b
  where (b.druginteractclassid1,b.druginteractclassid2) in (p_drug_class1, p_drug_class2)
  and a.precautionid = b.precautionid

union
 
select a.precautionid, a.precautionnotesen 
  from precaution a, drug_class_int_precaution b
  where (b.druginteractclassid1,b.druginteractclassid2) in (p_drug_class2, p_drug_class1)
  and a.precautionid = b.precautionid
) alias5 order by precautionid;	

ie_severidade_w	varchar(10);
nr_seq_ficha_w	bigint;
nr_seq_ficha_interacao_w	bigint;
ds_referencia_w	varchar(12000);
ds_referencia_ww	varchar(12000);
ds_precaution_notes_w	varchar(12000);
nr_counter_w 	integer;

BEGIN
for r_c01 in c01 loop
	begin
	ds_referencia_w	:= null;
	ds_referencia_ww	:= null;
	if (r_c01.SEVERITYID = 1) then
		ie_severidade_w	:= 'S';
	elsif (r_c01.SEVERITYID = 2) then
		ie_severidade_w	:= 'M';
	else
		ie_severidade_w	:= 'L';
	end if;

	nr_seq_ficha_w := material_imp_ficha_tec(	r_c01.cd_dcb, r_c01.ds_dcb, null, nr_seq_ficha_w, r_c01.cd_dcb, null, nm_usuario_p);

	nr_seq_ficha_interacao_w := material_imp_ficha_tec(	r_c01.cd_dcb_interacao, r_c01.ds_dcb_interacao, null, nr_seq_ficha_interacao_w, r_c01.cd_dcb_interacao, null, nm_usuario_p);
		
	if (nr_seq_ficha_w IS NOT NULL AND nr_seq_ficha_w::text <> '') and (nr_seq_ficha_interacao_w IS NOT NULL AND nr_seq_ficha_interacao_w::text <> '') then
	
		for r_c02 in c02(r_c01.DRUGINTERACTCLASSID1,r_c01.DRUGINTERACTCLASSID2) loop
			begin
			ds_referencia_ww	:= r_c02.htmlreference;
			end;
		end loop;

		if (r_c01.LIKELIHOODDEF IS NOT NULL AND r_c01.LIKELIHOODDEF::text <> '') then
			ds_referencia_w	:= '<p><b>'||r_c01.LIKELIHOODDESCEN||'. '|| r_c01.LIKELIHOODDEF||'</b></p>';
			if (ds_referencia_ww IS NOT NULL AND ds_referencia_ww::text <> '') then
				ds_referencia_w := ds_referencia_w||' <p>References: </p>'||ds_referencia_ww;
			end if;

		end if;
		
		ds_precaution_notes_w := null;
		nr_counter_w := 0;
		
		for r03 in c03(r_c01.DRUGINTERACTCLASSID1,r_c01.DRUGINTERACTCLASSID2) loop
			if (nr_counter_w = 0) then
				ds_precaution_notes_w := r03.precautionnotesen;
			else
				ds_precaution_notes_w := coalesce(ds_precaution_notes_w,'')||' '||r03.precautionnotesen;
			end if;
			nr_counter_w := nr_counter_w + 1;
		end loop;		
	
		CALL material_imp_interacao_ficha(	nr_seq_ficha_w,
						nr_seq_ficha_interacao_w,
						ie_severidade_w,
						r_c01.druginteractionnotesen,
						ds_referencia_w,
						nm_usuario_p,
						r_c01.observationnotesen,
						ds_precaution_notes_w);
	end if;		
	end;
end loop;
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE material_interacao_medic_ficha (nm_usuario_p text) FROM PUBLIC;

