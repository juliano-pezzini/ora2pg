-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_gerar_senha_paciente ( nr_seq_fila_p bigint, nr_seq_agenda_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_agendado_p text, nr_seq_senha_p INOUT bigint, ie_gerada_p INOUT text, ds_mensagem_p INOUT text, cd_pessoa_fisica_p text default null, ie_senha_prioritaria_p text DEFAULT NULL) AS $body$
DECLARE


nr_senha_w			integer;
nr_seq_senha_w			bigint;
nr_seq_pac_senha_fila_w		agenda_paciente.nr_seq_pac_senha_fila%type;
ie_sobreescrever_senha_w	varchar(1);


BEGIN
if (nr_seq_fila_p IS NOT NULL AND nr_seq_fila_p::text <> '') and (ie_agendado_p IS NOT NULL AND ie_agendado_p::text <> '') then

	ie_sobreescrever_senha_w := Obter_param_Usuario(871, 832, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_sobreescrever_senha_w);

	if (ie_sobreescrever_senha_w = 'N') then

		select	max(nr_seq_pac_senha_fila)
		into STRICT	nr_seq_pac_senha_fila_w
		from	agenda_paciente
		where	nr_sequencia = nr_seq_agenda_p;

		if (nr_seq_pac_senha_fila_w IS NOT NULL AND nr_seq_pac_senha_fila_w::text <> '') then
			ds_mensagem_p := substr(obter_texto_tasy(1034130, wheb_usuario_pck.get_nr_seq_idioma),1,255);
			ie_gerada_p := 'N';
		end if;
	end if;

	if (coalesce(ie_gerada_p::text, '') = '') and (coalesce(ds_mensagem_p::text, '') = '') then

		SELECT * FROM gerar_senha_paciente(	nr_seq_fila_p, cd_estabelecimento_p, nm_usuario_p, ie_senha_prioritaria_p, nr_senha_w, nr_seq_senha_w, cd_pessoa_fisica_p) INTO STRICT nr_senha_w, nr_seq_senha_w;

		if (nr_seq_senha_w IS NOT NULL AND nr_seq_senha_w::text <> '') then
			if (ie_agendado_p = 'S') and (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') then
				begin
				CALL vincular_senha_agendamento(	nr_seq_senha_w,
								nr_seq_agenda_p,
								'E');
				end;
			end if;

			nr_seq_senha_p	:= nr_seq_senha_w;
			ds_mensagem_p	:= substr(obter_texto_dic_objeto(76384, wheb_usuario_pck.get_nr_seq_idioma, 'NR_SENHA=' || nr_senha_w),1,255);
			ie_gerada_p	:= 'S';
		else
			ds_mensagem_p := substr(obter_texto_tasy(76380, wheb_usuario_pck.get_nr_seq_idioma),1,255);
			ie_gerada_p := 'N';
		end if;
	end if;

end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_gerar_senha_paciente ( nr_seq_fila_p bigint, nr_seq_agenda_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, ie_agendado_p text, nr_seq_senha_p INOUT bigint, ie_gerada_p INOUT text, ds_mensagem_p INOUT text, cd_pessoa_fisica_p text default null, ie_senha_prioritaria_p text DEFAULT NULL) FROM PUBLIC;

