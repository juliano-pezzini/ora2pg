-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atual_perc_escala_prot_gordura ( nr_sequencia_p bigint, nm_usuario_p text ) AS $body$
DECLARE


    nr_atendimento_w    bigint;
    ie_sexo_w           varchar(3);
    qt_idade_w          double precision;
    pr_gordura_w        double precision;
    qt_soma_w           double precision;
    nr_seq_protocolo_w  bigint;
    icontador_w         bigint;
    sql_w               varchar(300);
    soma_w              varchar(200);
    vl_regra_w          bigint;

  item RECORD;

BEGIN
    SELECT
        MAX(nr_atendimento),
        MAX(nr_seq_protocolo)
    INTO STRICT
        nr_atendimento_w,
        nr_seq_protocolo_w
    FROM
        escala_prot_gordura
    WHERE
        nr_sequencia = nr_sequencia_p;

    SELECT
        MAX(ie_sexo),
        MAX(obter_idade(dt_nascimento, clock_timestamp(), 'A'))
    INTO STRICT
        ie_sexo_w,
        qt_idade_w
    FROM
        pessoa_fisica
    WHERE
        cd_pessoa_fisica = obter_pessoa_atendimento(nr_atendimento_w, 'C');
--- Inicio MD1
    soma_w := 0;
    BEGIN
        FOR item IN (
            SELECT
                qt_medida
            FROM
                escala_prot_gordura_prega
            WHERE
                nr_seq_escala = nr_sequencia_p
        ) LOOP
            soma_w := soma_w || ',' || to_char(coalesce(item.qt_medida, 0));
        END LOOP;
    END;

    BEGIN
        sql_w := 'CALL OBTER_SOMA_ESC_PROT_GORD_MD(:1, :2) INTO :qt_soma_w';
        EXECUTE sql_w
            USING IN soma_w, IN ',', OUT qt_soma_w;
    EXCEPTION
        WHEN OTHERS THEN
            qt_soma_w := NULL;
    END;

--- Fim MD1
--- Inicio MD2
    soma_w := 0;
    BEGIN
        FOR item IN (
            SELECT
                pr_gordura
            FROM
                protocolo_gordura_ref
            WHERE  ie_sexo = ie_sexo_w
                AND qt_idade_w BETWEEN qt_idade_min AND qt_idade_max
                AND nr_seq_protocolo = nr_seq_protocolo_w
                AND qt_soma_w BETWEEN qt_soma_min AND qt_soma_max
        ) LOOP
            soma_w := soma_w || ',' ||  to_char(coalesce(item.pr_gordura,0));
        END LOOP;
    END;

    BEGIN
        sql_w := 'CALL OBTER_ESCALA_PROT_GORDURA_MD(:1, :2) INTO :pr_gordura_w';
        EXECUTE sql_w
            USING IN soma_w, IN ',',  OUT pr_gordura_w;
    EXCEPTION
        WHEN OTHERS THEN
            pr_gordura_w := NULL;
    END;

--- Fim MD2
    UPDATE escala_prot_gordura
    SET
        pr_gordura = pr_gordura_w,
        dt_atualizacao = clock_timestamp(),
        nm_usuario = nm_usuario_p
    WHERE
        nr_sequencia = nr_sequencia_p;

    COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atual_perc_escala_prot_gordura ( nr_sequencia_p bigint, nm_usuario_p text ) FROM PUBLIC;

