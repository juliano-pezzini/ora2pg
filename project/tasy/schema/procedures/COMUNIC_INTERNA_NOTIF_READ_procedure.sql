-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE comunic_interna_notif_read ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


id_w		varchar(4000);

C01 CURSOR FOR
        SELECT	n.id
        from	notificacoes n
        inner join
                comunic_interna i
        on	i.ds_titulo = n.ds_titulo
        and	i.dt_comunicado = n.dt_criacao
        and	coalesce(i.nm_usuario_destino, 1) = coalesce(replace(n.nm_usuarios_destino, ';', ','), 1)
        and	coalesce(i.ds_perfil_adicional, 1) = coalesce(replace(n.cd_profiles_destino, ';', ','), 1)
        and	coalesce(i.ds_setor_adicional, 1) = coalesce(replace(n.cd_setores_desitno, ';', ','), 1)
        where	i.nr_sequencia = nr_sequencia_p;

BEGIN

for c01_w in C01 loop
	begin
        id_w := c01_w.id;
        if (id_w IS NOT NULL AND id_w::text <> '') then
                insert	into notificacoes_lidas(id, nm_usuario, dt_leitura)
                values (id_w, nm_usuario_p, clock_timestamp());
                commit;
        end if;
        end;
end loop;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE comunic_interna_notif_read ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

