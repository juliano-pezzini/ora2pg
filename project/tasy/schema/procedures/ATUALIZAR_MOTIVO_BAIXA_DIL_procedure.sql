-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_motivo_baixa_dil (cd_diluente_p bigint, nr_prescricao_p bigint, nr_sequencia_p bigint, nr_seq_diluicao_p bigint) AS $body$
DECLARE


cd_material_w			material.cd_material%type;
cd_motivo_baixa_w 		material_diluicao.cd_motivo_baixa%type;
cd_estabelecimento_w 		prescr_medica.cd_estabelecimento%type;
cd_setor_atendimento_w		prescr_medica.cd_setor_atendimento%type;
cd_unidade_medida_dose_w		prescr_material.cd_unidade_medida_dose%type;
qt_dose_medic_w			prescr_material.qt_dose%type;
qt_idade_w			bigint;
qt_peso_w			prescr_medica.qt_peso%type;
ie_via_aplicacao_w			prescr_material.ie_via_aplicacao%type;
nr_seq_via_acesso_w		prescr_material.nr_seq_via_acesso%type;
nr_seq_agrupamento_w		setor_atendimento.nr_seq_agrupamento%type;


BEGIN


if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_sequencia_p IS NOT NULL AND nr_sequencia_p::text <> '') and (cd_diluente_p IS NOT NULL AND cd_diluente_p::text <> '') then

	select	max(cd_material),
		max(cd_unidade_medida_dose),
		max(qt_dose),
		max(ie_via_aplicacao),
		max(nr_seq_via_acesso)
	into STRICT	cd_material_w,
		cd_unidade_medida_dose_w,
		qt_dose_medic_w,
		ie_via_aplicacao_w,
		nr_seq_via_acesso_w
	from	prescr_material
	where	nr_prescricao 	 = nr_prescricao_p
	and	nr_sequencia	 = nr_sequencia_p;


	select max(a.cd_estabelecimento),
		   max(a.cd_setor_atendimento),
		   max(a.qt_peso),
		   max(obter_idade(b.dt_nascimento,coalesce(b.dt_obito,clock_timestamp()),'DIA'))
	into STRICT    cd_estabelecimento_w,
		cd_setor_atendimento_w,
		qt_peso_w,
		qt_idade_w
	from    prescr_medica a,
		pessoa_fisica b
	where   a.nr_prescricao  = nr_prescricao_p
	and      a.cd_pessoa_fisica	= b.cd_pessoa_fisica;


	select	max(nr_seq_agrupamento)
	into STRICT	nr_seq_agrupamento_w
	from	setor_atendimento
	where	cd_setor_atendimento	= cd_setor_atendimento_w;


	if (cd_material_w IS NOT NULL AND cd_material_w::text <> '') then
		select 	coalesce(max(cd_motivo_baixa),0) cd_motivo_baixa
		into STRICT	cd_motivo_baixa_w
		from 	material_diluicao
		where 	cd_material 	 = cd_material_w
		and		cd_diluente	     = cd_diluente_p
		and		obter_se_regra_diluicao_setor(nr_seq_interno, cd_setor_atendimento_w) = 'S'
		and		coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida_dose_w,qt_dose_medic_w),0) between
					coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida,qt_dose_min),0) and
					coalesce(obter_conversao_unid_med_cons(cd_material_w,cd_unidade_medida,qt_dose_max),9999999)
		and		qt_idade_w between obter_idade_diluicao(cd_material,nr_sequencia,'MIN') and obter_idade_diluicao(cd_material,nr_sequencia,'MAX')
		and		coalesce(qt_peso_w,0) between coalesce(qt_peso_min,0) and coalesce(qt_peso_max,999999)
		and		((cd_setor_excluir <> cd_setor_atendimento_w) or (coalesce(cd_setor_excluir::text, '') = ''))
		and		((ie_via_excluir <> ie_via_aplicacao_w) or (coalesce(ie_via_excluir::text, '') = ''))
		and		((nr_seq_via_acesso = nr_seq_via_acesso_w) or (coalesce(nr_seq_via_acesso::text, '') = ''))
		and		((nr_seq_agrupamento = nr_seq_agrupamento_w) or (coalesce(nr_seq_agrupamento::text, '') = ''))
		and		((cd_setor_atendimento	= cd_setor_atendimento_w) or (coalesce(cd_setor_atendimento::text, '') = ''))
		and		((ie_via_aplicacao	= ie_via_aplicacao_w) or (coalesce(ie_via_aplicacao::text, '') = ''))
		and		((cd_unidade_medida = cd_unidade_medida_dose_w) or (coalesce(cd_unidade_medida::text, '') = ''))
		and		coalesce(cd_perfil,coalesce(obter_perfil_ativo,0)) = coalesce(obter_perfil_ativo,0)
		and		coalesce(cd_estabelecimento,cd_estabelecimento_w) = cd_estabelecimento_w
		and		obter_se_material_ativo(cd_diluente) = 'A'
		and		ie_reconstituicao	= 'N';


	update   prescr_material
        	set      cd_motivo_baixa   = cd_motivo_baixa_w
        	where    nr_prescricao     = nr_prescricao_p
        	and      nr_sequencia      = nr_seq_diluicao_p
        	and      ie_agrupador       = 3;
	commit;
	end if;

end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_motivo_baixa_dil (cd_diluente_p bigint, nr_prescricao_p bigint, nr_sequencia_p bigint, nr_seq_diluicao_p bigint) FROM PUBLIC;

