-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_proc_cirurgia ( nr_cirurgia_p bigint, nm_usuario_p text) AS $body$
DECLARE



nr_prescricao_w		bigint;
nr_seq_autor_conv_w	bigint;
nr_seq_desc_proced_w	bigint;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
qt_procedimento_w	smallint;
ds_procedimento_w	varchar(255);
ie_proc_sem_autor_w	varchar(1) := 'S';
nr_seq_aut_proc_w	bigint;

c01 CURSOR FOR
	SELECT  a.nr_sequencia
	from    autorizacao_convenio a,
		cirurgia d
	where  	a.nr_atendimento  = d.nr_atendimento
	and	a.cd_convenio	  = d.cd_convenio
	and     d.nr_cirurgia 	  = nr_cirurgia_p;

c02 CURSOR FOR
	SELECT  a.cd_procedimento,
		a.ie_origem_proced,
		a.qt_procedimento,
		substr(obter_desc_procedimento(a.cd_procedimento,a.ie_origem_proced),1,255) ds_procedimento,
		b.nr_sequencia
	from    prescr_procedimento a,
		procedimento_autorizado b,
		autorizacao_convenio z
	where   a.nr_prescricao	 	= 	nr_prescricao_w
	and	b.nr_sequencia_autor 	=  	nr_seq_autor_conv_w
	and	a.cd_procedimento	=	b.cd_procedimento
	and	b.nr_sequencia_autor 	= 	z.nr_sequencia
	and	a.ie_origem_proced	=	b.ie_origem_proced
	and	obter_estagio_autor(z.nr_seq_estagio,'C') not in (10,70);

c03 CURSOR FOR
	SELECT  a.cd_procedimento,
		a.ie_origem_proced,
		a.qt_procedimento,
		substr(obter_desc_procedimento(a.cd_procedimento,a.ie_origem_proced),1,255) ds_procedimento
	from    prescr_procedimento a
	where   a.nr_prescricao	 = nr_prescricao_w;





BEGIN

select  max(a.nr_prescricao)
into STRICT	nr_prescricao_w
from	cirurgia a
where 	a.nr_cirurgia	=	nr_cirurgia_p;

open C01;
loop
fetch C01 into
	nr_seq_autor_conv_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	ie_proc_sem_autor_w := 'N';
	open C02;
	loop
	fetch C02 into
		cd_procedimento_w,
		ie_origem_proced_w,
		qt_procedimento_w,
		ds_procedimento_w,
		nr_seq_aut_proc_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		select 	nextval('pepo_mat_proc_justif_autor_seq')
		into STRICT	nr_seq_desc_proced_w
		;

		insert into  pepo_mat_proc_justif_autor(nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_cirurgia,
							cd_procedimento,
							ie_origem_proced,
							qt_solicitada,
							qt_realizada,
							ds_justificativa,
							ds_material,
							cd_material,
							ie_exige_justificativa,
							nr_seq_proc_autor)
		values (nr_seq_desc_proced_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							nr_cirurgia_p,
							cd_procedimento_w,
							ie_origem_proced_w,
							coalesce(qt_procedimento_w,0),
							0,
							null,
							ds_procedimento_w,
							null,
							'S',
							nr_seq_aut_proc_w);

		end;
	end loop;
	close C02;
	end;
end loop;
close C01;

IF (ie_proc_sem_autor_w = 'S') THEN
	open c03;
	loop
	fetch c03 into
		cd_procedimento_w,
		ie_origem_proced_w,
		qt_procedimento_w,
		ds_procedimento_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		begin

		select 	nextval('pepo_mat_proc_justif_autor_seq')
		into STRICT	nr_seq_desc_proced_w
		;

		insert into  pepo_mat_proc_justif_autor(nr_sequencia,
							dt_atualizacao,
							nm_usuario,
							dt_atualizacao_nrec,
							nm_usuario_nrec,
							nr_cirurgia,
							cd_procedimento,
							ie_origem_proced,
							qt_solicitada,
							qt_realizada,
							ds_justificativa,
							ie_exige_justificativa,
							ds_material)
		values (nr_seq_desc_proced_w,
							clock_timestamp(),
							nm_usuario_p,
							clock_timestamp(),
							nm_usuario_p,
							nr_cirurgia_p,
							cd_procedimento_w,
							ie_origem_proced_w,
							coalesce(qt_procedimento_w,0),
							0,
							null,
							'S',
							ds_procedimento_w);
		end;
	end loop;
	close c03;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_proc_cirurgia ( nr_cirurgia_p bigint, nm_usuario_p text) FROM PUBLIC;

