-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_proposta_excluir_contrato ( nr_seq_proposta_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_contrato_w		bigint;
ie_tipo_proposta_w		smallint;
nr_seq_pessoa_proposta_w	bigint;
nr_seq_segurado_w		bigint;
dt_liberacao_w			timestamp;
nm_pessoa_fisica_w		varchar(60);
nr_seq_contrato_aprovado_w	bigint;
nr_seq_titular_contrato_w	bigint;
nr_seq_indicacao_w		bigint;
nr_seq_bonificacao_w		bigint;
nr_seq_segurado_ind_w		bigint;
nr_seq_lancamento_w		bigint;
qt_registros_w			bigint;
nr_seq_segurado_ant_w		bigint;
nr_seq_segurado_mig_w		bigint;
dt_migracao_w			timestamp;
dt_suspensao_seg_w		timestamp;
nr_seq_proposta_w		pls_proposta_adesao.nr_sequencia%type;
qt_regras_aprop_w		integer;
nr_seq_sca_w			pls_sca_vinculo.nr_sequencia%type;
dt_liberacao_sca_w		pls_sca_vinculo.dt_liberacao%type;
nm_plano_sca_w			varchar(255);
ie_rescisao_migracao_w		pls_segurado.ie_rescisao_migracao%type;

C01 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_proposta_beneficiario
	where	nr_seq_proposta	= nr_seq_proposta_p
	order by nr_seq_titular;--aaschlote 25/04/2011 OS -  Trazer primeiro os segurados do dependentes
/* Obter o contrato da proposta */

C02 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_contrato
	where	nr_seq_proposta	= nr_seq_proposta_p
	and	coalesce(dt_aprovacao::text, '') = '';

/* Caso ocorra de um beneficiários estar em mais de uma proposta, */

/*
Cursor C03 is
	select	nr_seq_titular_contrato
	from	pls_proposta_beneficiario
	where	nr_seq_proposta	= nr_seq_proposta_p;
*/
C04 CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_lancamento
	from	pls_proposta_ind_bonific
	where	nr_seq_segurado	= nr_seq_pessoa_proposta_w;

C05 CURSOR FOR
	SELECT	b.nr_sequencia,
		b.nr_seq_segurado_ant,
		a.nm_pessoa_fisica,
		b.dt_migracao
	from	pessoa_fisica		a,
		pls_segurado		b
	where	a.cd_pessoa_fisica	= b.cd_pessoa_fisica
	and	b.nr_proposta_adesao	= to_char(nr_seq_proposta_p)
	and	b.ie_tipo_segurado	in ('A','B')
	order by CASE WHEN coalesce(nr_seq_titular::text, '') = '' THEN 1  ELSE -1 END;

C06 CURSOR FOR
	SELECT	nr_sequencia,
		dt_liberacao
	from	pls_sca_vinculo
	where	nr_seq_benef_proposta	= nr_seq_pessoa_proposta_w
	and 	(nr_seq_segurado IS NOT NULL AND nr_seq_segurado::text <> '');


BEGIN

select	ie_tipo_proposta
into STRICT	ie_tipo_proposta_w
from	pls_proposta_adesao
where	nr_sequencia	= nr_seq_proposta_p;

if (ie_tipo_proposta_w  (1,3,6,7)) then
	select	coalesce(max(nr_sequencia),0)
	into STRICT	nr_seq_contrato_aprovado_w
	from	pls_contrato
	where	nr_seq_proposta	= nr_seq_proposta_p
	and	(dt_aprovacao IS NOT NULL AND dt_aprovacao::text <> '');
	if (nr_seq_contrato_aprovado_w > 0) then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(226217);
	end if;
	/*
	open C03;
	loop
	fetch C03 into
		nr_seq_titular_contrato_w;
	exit when C03%notfound;
		begin

		update	pls_proposta_beneficiario
		set	nr_seq_titular_contrato	= null
		where	nr_seq_titular_contrato	= nr_seq_titular_contrato_w;

		end;
	end loop;
	close C03;

	update	pls_proposta_beneficiario
	set	nr_seq_titular_contrato	= null
	where	nr_seq_proposta	= nr_seq_proposta_p;
	*/
	open c05;
	loop
	fetch c05 into
		nr_seq_segurado_w,
		nr_seq_segurado_ant_w,
		nm_pessoa_fisica_w,
		dt_migracao_w;
	EXIT WHEN NOT FOUND; /* apply on c05 */
		begin
		/*Situação para os beneficiário migrados*/

		if (nr_seq_segurado_ant_w IS NOT NULL AND nr_seq_segurado_ant_w::text <> '') then
			select	max(nr_seq_segurado_mig)
			into STRICT	nr_seq_segurado_mig_w
			from	pls_segurado
			where	nr_sequencia	= nr_seq_segurado_ant_w;

			--Verificar se o beneficário que vai ser deletado é igual ao que foi migrado
			if (nr_seq_segurado_mig_w = nr_seq_segurado_w) then
				select	coalesce(ie_rescisao_migracao,'N')
				into STRICT	ie_rescisao_migracao_w
				from	pls_segurado
				where	nr_sequencia	= nr_seq_segurado_ant_w;

				/*Caso a data de rescisão do beneficiárioa anterior, for a mesma data da migração então reativa o contrato*/

				if (ie_rescisao_migracao_w = 'S') then
					dt_suspensao_seg_w := pls_obter_dt_suspensao_seg(nr_seq_segurado_ant_w);
					update	pls_segurado
					set	dt_rescisao			 = NULL,
						dt_limite_utilizacao		 = NULL,
						nr_seq_motivo_cancelamento	 = NULL,
						nr_seq_causa_rescisao		 = NULL,
						dt_reativacao			= clock_timestamp(),
						ie_tipo_rescisao		= '',
						dt_cancelamento			 = NULL,
						ie_situacao_atend		= CASE WHEN dt_suspensao_seg_w = NULL THEN CASE WHEN dt_liberacao = NULL THEN 'I'  ELSE 'A' END   ELSE 'S' END
					where	nr_sequencia			= nr_seq_segurado_ant_w;

					/* Gerar histórico  de reativação do segurado anterior*/

					CALL pls_gerar_segurado_historico(	nr_seq_segurado_ant_w, '2', clock_timestamp(),'Reativação',
						'Desfeita a contratação do beneficiário através da função OPS - Proposta de Adesão', null, clock_timestamp(), null,
						null, clock_timestamp(), null, null,
						null, null, null, null, nm_usuario_p,
						'N');
				end if;

				/*Retira informações do beneficiário, sobre a migração*/

				update	pls_segurado
				set	dt_migracao			 = NULL,
					nr_seq_segurado_mig		 = NULL,
					nr_contrato_migrado		 = NULL,
					nm_usuario			= nm_usuario_p,
					dt_atualizacao			= clock_timestamp()
				where	nr_sequencia			= nr_seq_segurado_ant_w;
			end if;
		end if;
		/*
		update	pls_proposta_beneficiario
		set	nr_seq_titular_contrato	= null
		where	nr_seq_titular_contrato	= nr_seq_segurado_w;
		*/
		begin
		delete	FROM pls_segurado_compl
		where	nr_seq_segurado	= nr_seq_segurado_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM pls_carencia
		where	nr_seq_segurado	= nr_seq_segurado_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM pls_segurado_historico
		where	nr_seq_segurado	= nr_seq_segurado_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM pls_segurado_historico
		where	nr_seq_segurado	= nr_seq_segurado_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		update	pls_segurado
		set	nr_seq_pagador		 = NULL,
			nr_seq_titular		 = NULL
		where	nr_sequencia	= nr_seq_segurado_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM pls_segurado_preco
		where	nr_seq_segurado	= nr_seq_segurado_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM pls_segurado_cart_ant
		where	nr_seq_segurado	= nr_seq_segurado_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM pls_segurado_cart_estagio a
		where	exists (	SELECT	1
					from	pls_segurado_carteira	y
					where	a.nr_seq_cartao_seg	= y.nr_sequencia
					and	y.nr_seq_segurado	= nr_seq_segurado_w);
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM pls_segurado_carteira
		where	nr_seq_segurado	= nr_seq_segurado_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM pls_bonificacao_vinculo
		where	nr_seq_segurado	= nr_seq_segurado_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin

		update	pls_segurado_preco_origem
		set	nr_seq_preco  = NULL
		where 	nr_seq_vinculo_sca	in (	SELECT 	nr_sequencia
							from 	pls_sca_vinculo
							where	nr_seq_segurado	= nr_seq_segurado_w);

		delete	FROM pls_plano_preco
		where 	nr_seq_tabela   in (	SELECT 	a.nr_seq_tabela
						from 	pls_sca_vinculo a
						where	a.nr_seq_segurado	= nr_seq_segurado_w
						and	not exists ( 	SELECT  1
									from 	pls_sca_vinculo b
									where 	b.nr_seq_tabela = a.nr_seq_tabela
									and	b.nr_sequencia <> a.nr_sequencia));

		delete  FROM pls_segurado_preco_origem
		where 	nr_seq_vinculo_sca	in (	SELECT 	nr_sequencia
							from 	pls_sca_vinculo
							where	nr_seq_segurado	= nr_seq_segurado_w);

		update	pls_tabela_preco
		set	nr_seq_sca  = NULL, nr_seq_sca_vinculo  = NULL
		where	nr_sequencia	in (	SELECT 	a.nr_seq_tabela
						from 	pls_sca_vinculo a
						where	a.nr_seq_segurado	= nr_seq_segurado_w
						and	not exists ( 	SELECT  1
									from 	pls_sca_vinculo b
									where 	b.nr_seq_tabela = a.nr_seq_tabela
									and	b.nr_sequencia <> a.nr_sequencia));

		update	pls_sca_vinculo
		set	nr_seq_tabela  = NULL
		where	nr_seq_segurado	= nr_seq_segurado_w;

		delete 	FROM pls_tabela_preco
		where	nr_sequencia	in (	SELECT 	a.nr_seq_tabela
						from 	pls_sca_vinculo a
						where	a.nr_seq_segurado	= nr_seq_segurado_w
						and	not exists ( 	SELECT  1
									from 	pls_sca_vinculo b
									where 	b.nr_seq_tabela = a.nr_seq_tabela
									and	b.nr_sequencia <> a.nr_sequencia));

		delete	FROM pls_sca_vinculo
		where	nr_seq_segurado	= nr_seq_segurado_w;

		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM pls_segurado_agravo_parc a
		where	exists (	SELECT	1
					from	pls_segurado_agravo	y
					where	a.nr_seq_segurado_agravo	= y.nr_sequencia
					and	y.nr_seq_segurado		= nr_seq_segurado_w);
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM pls_segurado_agravo a
		where	nr_seq_segurado	= nr_seq_segurado_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM sip_beneficiario_exposto
		where	nr_seq_segurado	= nr_seq_segurado_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM w_pls_benef_movto_mensal
		where	nr_seq_segurado	= nr_seq_segurado_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM w_pls_benef_movto_mes_sca
		where	nr_seq_segurado	= nr_seq_segurado_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM pls_segurado_repasse
		where	nr_seq_segurado	= nr_seq_segurado_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM pls_segurado_doc_arq
		where	nr_seq_segurado	= nr_seq_segurado_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM pls_indicacao_venda
		where	nr_seq_segurado	= nr_seq_segurado_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		update	pls_declaracao_segurado
		set	nr_seq_segurado  = NULL
		where	nr_seq_segurado = nr_seq_segurado_w;

		update	pls_inclusao_beneficiario
		set	nr_seq_segurado  = NULL
		where	nr_seq_segurado = nr_seq_segurado_w;

		begin
		delete	FROM pls_segurado
		where	nr_sequencia	= nr_seq_segurado_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;
		end;
	end loop;
	close c05;

	open C02;
	loop
	fetch C02 into
		nr_seq_contrato_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		begin
		delete	FROM pls_preco_regra a
		where	exists (	SELECT	1
					from 	pls_regra_desconto x
					where 	a.nr_seq_regra = x.nr_sequencia
					and 	x.nr_seq_contrato = nr_seq_contrato_w);
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM pls_regra_desconto
		where	nr_seq_contrato = nr_seq_contrato_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM pls_regra_inscricao
		where	nr_seq_contrato = nr_seq_contrato_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM pls_contrato_pagador_fin
		where	nr_seq_pagador in (	SELECT	nr_sequencia
						from	pls_contrato_pagador
						where	nr_seq_contrato	= nr_seq_contrato_w);

		delete	FROM pls_contrato_pagador
		where	nr_seq_contrato = nr_seq_contrato_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin

		update	pls_proposta_plano
		set	nr_seq_contrato	 = NULL
		where	nr_seq_proposta	= nr_seq_proposta_p;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM pls_contrato_plano
		where	nr_seq_contrato = nr_seq_contrato_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM pls_plano_preco a
		where	exists (	SELECT	1
					from	pls_tabela_preco x
					where	a.nr_seq_tabela		= x.nr_sequencia
					and	x.nr_contrato		= nr_seq_contrato_w);
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin

		update	pls_tabela_preco
		set	nr_contrato  = NULL
		where	nr_contrato = nr_seq_contrato_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		update	pls_contrato
		set	nr_contrato_principal	 = NULL
		where	nr_contrato_principal	= nr_seq_contrato_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM pls_contrato_doc_texto a
		where	exists (	SELECT	1
					from	pls_contrato_documento x
					where	a.nr_seq_documento	= x.nr_sequencia
					and	x.nr_seq_contrato	= nr_seq_contrato_w);
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM pls_contrato_documento
		where	nr_seq_contrato	= nr_seq_contrato_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM pls_acesso_portal_log a
		where	exists (	SELECT	1
					from	pls_estipulante_web x
					where	a.nr_seq_usu_estipulante = x.nr_sequencia
					and	x.nr_seq_contrato	= nr_seq_contrato_w);
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM pls_estipulante_web
		where	nr_seq_contrato	= nr_seq_contrato_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete	FROM pls_carteira_renovacao
		where	nr_seq_contrato	= nr_seq_contrato_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		update	pls_inclusao_beneficiario
		set	nr_seq_contrato  = NULL
		where	nr_seq_contrato = nr_seq_contrato_w;

		begin
		delete 	FROM pls_contrato_grupo
		where 	nr_seq_contrato = nr_seq_contrato_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete 	FROM pls_contrato_contato
		where 	nr_seq_contrato = nr_seq_contrato_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete 	FROM pls_contrato_aditamento
		where 	nr_seq_contrato = nr_seq_contrato_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete 	FROM pls_contrato_historico
		where 	nr_seq_contrato = nr_seq_contrato_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete 	FROM pls_contrato_regra_lanc
		where 	nr_seq_contrato = nr_seq_contrato_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete 	FROM pls_regra_coparticipacao
		where 	nr_seq_contrato = nr_seq_contrato_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete 	FROM pls_sca_regra_contrato
		where 	nr_seq_contrato = nr_seq_contrato_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		begin
		delete 	FROM pls_regra_segurado_cart
		where 	nr_seq_contrato = nr_seq_contrato_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;


		select	count(1)
		into STRICT	qt_regras_aprop_w
		from	pls_regra_copartic
		where	nr_seq_contrato = nr_seq_contrato_w;

		if (qt_regras_aprop_w > 0) then
			begin
			delete	FROM pls_regra_copartic_interna
			where	nr_seq_regra in (	SELECT	x.nr_sequencia
							from	pls_regra_copartic	x
							where	nr_seq_contrato = nr_seq_contrato_w );
			exception
			when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
			end;

			begin
			delete	FROM pls_regra_copartic_guia
			where	nr_seq_regra in (	SELECT	x.nr_sequencia
							from	pls_regra_copartic	x
							where	nr_seq_contrato = nr_seq_contrato_w );
			exception
			when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
			end;

			begin
			delete	FROM pls_regra_copartic_prest
			where	nr_seq_regra in (	SELECT	x.nr_sequencia
							from	pls_regra_copartic	x
							where	nr_seq_contrato = nr_seq_contrato_w );
			exception
			when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
			end;

			begin
			delete	FROM pls_regra_copartic_util
			where	nr_seq_regra in (	SELECT	x.nr_sequencia
							from	pls_regra_copartic	x
							where	nr_seq_contrato = nr_seq_contrato_w );
			exception
			when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
			end;

			begin
			delete	FROM pls_regra_copartic_conta
			where	nr_seq_regra in (	SELECT	x.nr_sequencia
							from	pls_regra_copartic	x
							where	nr_seq_contrato = nr_seq_contrato_w );
			exception
			when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
			end;

			begin
			delete	FROM pls_regra_copartic_benef
			where	nr_seq_regra in (	SELECT	x.nr_sequencia
							from	pls_regra_copartic	x
							where	nr_seq_contrato = nr_seq_contrato_w );
			exception
			when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
			end;

			begin
			delete	FROM pls_regra_copartic_aprop
			where	nr_seq_regra in (	SELECT	x.nr_sequencia
							from	pls_regra_copartic	x
							where	nr_seq_contrato = nr_seq_contrato_w );
			exception
			when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
			end;

			begin
			delete	FROM pls_regra_copartic
			where	nr_seq_contrato	= nr_seq_contrato_w;
			exception
			when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
			end;
		end if;

		begin
		delete	FROM pls_contrato
		where	nr_sequencia	= nr_seq_contrato_w;
		exception
		when others then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(226189,'NR_SEQ_CONTRATO='||nr_seq_contrato_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
		end;

		end;
	end loop;
	close C02;
elsif (ie_tipo_proposta_w	= 2) then
	open C01;
	loop
	fetch C01 into
		nr_seq_pessoa_proposta_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		begin
		select	nr_sequencia,
			dt_liberacao,
			obter_nome_pf(cd_pessoa_fisica)
		into STRICT	nr_seq_segurado_w,
			dt_liberacao_w,
			nm_pessoa_fisica_w
		from	pls_segurado
		where	nr_seq_pessoa_proposta	= nr_seq_pessoa_proposta_w
		and	ie_tipo_segurado	in ('A','B');
		exception
		when others then
			nr_seq_segurado_w := 0;
		end;

		if (nr_seq_segurado_w > 0) then
			if (dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '') then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(226177,'NM_BENEFICIARIO='||nm_pessoa_fisica_w);
			end if;

			delete	FROM pls_segurado_compl
			where	nr_seq_segurado	= nr_seq_segurado_w;

			delete	FROM pls_carencia
			where	nr_seq_segurado	= nr_seq_segurado_w;

			begin
			delete	FROM pls_bonificacao_vinculo
			where	nr_seq_segurado	= nr_seq_segurado_w;
			exception
			when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
			end;

			begin

			update	pls_segurado_preco_origem
			set	nr_seq_preco  = NULL
			where 	nr_seq_vinculo_sca	in (	SELECT 	nr_sequencia
								from 	pls_sca_vinculo
								where	nr_seq_segurado	= nr_seq_segurado_w);

			delete	FROM pls_plano_preco
			where 	nr_seq_tabela   in (	SELECT 	a.nr_seq_tabela
							from 	pls_sca_vinculo a
							where	a.nr_seq_segurado	= nr_seq_segurado_w
							and	not exists ( 	SELECT  1
										from 	pls_sca_vinculo b
										where 	b.nr_seq_tabela = a.nr_seq_tabela
										and	b.nr_sequencia <> a.nr_sequencia));

			delete  FROM pls_segurado_preco_origem
			where 	nr_seq_vinculo_sca	in (	SELECT 	nr_sequencia
								from 	pls_sca_vinculo
								where	nr_seq_segurado	= nr_seq_segurado_w);

			update	pls_tabela_preco
			set	nr_seq_sca  = NULL, nr_seq_sca_vinculo  = NULL
			where	nr_sequencia	in (	SELECT 	a.nr_seq_tabela
							from 	pls_sca_vinculo a
							where	a.nr_seq_segurado	= nr_seq_segurado_w
							and	not exists ( 	SELECT  1
										from 	pls_sca_vinculo b
										where 	b.nr_seq_tabela = a.nr_seq_tabela
										and	b.nr_sequencia <> a.nr_sequencia));

			update	pls_sca_vinculo
			set	nr_seq_tabela  = NULL
			where	nr_seq_segurado	= nr_seq_segurado_w;

			delete 	FROM pls_tabela_preco
			where	nr_sequencia	in (	SELECT 	a.nr_seq_tabela
							from 	pls_sca_vinculo a
							where	a.nr_seq_segurado	= nr_seq_segurado_w

							and	not exists ( 	SELECT  1
										from 	pls_sca_vinculo b
										where 	b.nr_seq_tabela = a.nr_seq_tabela
										and	b.nr_sequencia <> a.nr_sequencia));

			delete	FROM pls_sca_vinculo
			where	nr_seq_segurado	= nr_seq_segurado_w;

			exception
			when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
			end;

			begin
			delete	FROM sip_beneficiario_exposto a
			where	nr_seq_segurado	= nr_seq_segurado_w;
			exception
			when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
			end;

			begin
			delete	FROM w_pls_benef_movto_mensal a
			where	a.nr_seq_segurado	= nr_seq_segurado_w;
			exception
			when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
			end;

			begin
			delete	FROM w_pls_benef_movto_mes_sca a
			where	a.nr_seq_segurado	= nr_seq_segurado_w;
			exception
				when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
			end;

			begin
			delete	FROM pls_segurado_repasse a
			where	a.nr_seq_segurado	= nr_seq_segurado_w;
			exception
			when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
			end;

			begin
			delete	FROM pls_segurado_preco a
			where	a.nr_seq_segurado	= nr_seq_segurado_w;
			exception
			when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
			end;
			/*
			update	pls_proposta_beneficiario
			set	nr_seq_titular_contrato	= null
			where	nr_seq_proposta	= nr_seq_proposta_p;
			*/
			update 	pls_declaracao_segurado
			set	nr_seq_segurado  = NULL
			where	nr_seq_proposta_adesao = nr_seq_proposta_p;

			begin
			delete	FROM pls_segurado_cart_ant
			where	nr_seq_segurado	= nr_seq_segurado_w;
			exception
			when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
			end;

			begin
			delete	FROM pls_segurado_cart_estagio a
			where	exists (	SELECT	1
						from	pls_segurado_carteira	y
						where	a.nr_seq_cartao_seg	= y.nr_sequencia
						and	y.nr_seq_segurado	= nr_seq_segurado_w);
			exception
			when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
			end;

			begin
			delete	FROM pls_segurado_carteira
			where	nr_seq_segurado	= nr_seq_segurado_w;
			exception
			when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
			end;

			begin
			delete	FROM pls_segurado_doc_arq
			where	nr_seq_segurado	= nr_seq_segurado_w;
			exception
			when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
			end;

			begin
			update	pls_inclusao_beneficiario
			set	nr_seq_segurado  = NULL
			where	nr_seq_segurado = nr_seq_segurado_w;
			exception
			when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
			end;

			begin
			delete	FROM pls_indicacao_venda
			where	nr_seq_segurado	= nr_seq_segurado_w;
			exception
			when others then
				CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
			end;

			begin
			delete	FROM pls_segurado
			where	nr_sequencia	= nr_seq_segurado_w;
			exception
			when others then
				select	coalesce(max(a.nr_seq_proposta), nr_seq_proposta_p)
				into STRICT	nr_seq_proposta_w
				from	pls_proposta_beneficiario a
				where	a.nr_sequencia = a.nr_seq_titular_contrato;

				if (nr_seq_proposta_w <> nr_seq_proposta_p) then
					CALL wheb_mensagem_pck.exibir_mensagem_abort(301780,'NR_SEQ_PROPOSTA='||nr_seq_proposta_w);
				else
					CALL wheb_mensagem_pck.exibir_mensagem_abort(226178,'NM_BENEFICIARIO='||nm_pessoa_fisica_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
				end if;
			end;
		end if;
		end;
	end loop;
	close C01;
elsif (ie_tipo_proposta_w	in (4,8)) then
	CALL pls_desfazar_contr_mig_exi(nr_seq_proposta_p,nm_usuario_p);
elsif (ie_tipo_proposta_w = 5) then
	open C01;
	loop
	fetch C01 into
		nr_seq_pessoa_proposta_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */

		begin
		open C06;
		loop
		fetch C06 into
			nr_seq_sca_w,
			dt_liberacao_sca_w;
		EXIT WHEN NOT FOUND; /* apply on C06 */
			begin

			if (coalesce(dt_liberacao_sca_w::text, '') = '') then
				delete	FROM pls_sca_vinculo
				where	nr_sequencia	= nr_seq_sca_w;

				update	pls_proposta_adesao
				set	ie_status	= 'A',
					nm_usuario	= nm_usuario_p,
					dt_atualizacao	= clock_timestamp()
				where	nr_sequencia	= nr_seq_proposta_p;

				update	pls_proposta_beneficiario
				set	nr_seq_benef_gerado	 = NULL,
					nm_usuario		= nm_usuario_p,
					dt_atualizacao		= clock_timestamp()
				where	nr_seq_proposta		= nr_seq_proposta_p;
			else
				select 	nr_seq_plano||' - '||pls_obter_dados_produto(nr_seq_plano,'N')
				into STRICT	nm_plano_sca_w
				from 	pls_sca_vinculo
				where 	nr_sequencia 	= nr_seq_sca_w;

				CALL wheb_mensagem_pck.exibir_mensagem_abort(357110,'NM_SCA='||nm_plano_sca_w||';'||'DS_ERRO='||sqlerrm(SQLSTATE));
			end if;
			end;
		end loop;
		close C06;

		end;
	end loop;
	close C01;

end if;

open C01;
loop
fetch C01 into
	nr_seq_pessoa_proposta_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (ie_tipo_proposta_w in (1,2)) then
		open C04;
		loop
		fetch C04 into
			nr_seq_indicacao_w,
			nr_seq_lancamento_w;
		EXIT WHEN NOT FOUND; /* apply on C04 */
			begin

			begin
			update	pls_proposta_ind_bonific
			set	nr_seq_lancamento  = NULL
			where	nr_sequencia = nr_seq_indicacao_w;

			delete	FROM pls_segurado_mensalidade
			where	nr_sequencia = nr_seq_lancamento_w;
			exception
			when others then
				 CALL wheb_mensagem_pck.exibir_mensagem_abort(226190,'NR_SEQ_PESSOA_PROP='||nr_seq_pessoa_proposta_w);
			end;
			end;
		end loop;
		close C04;
	end if;

	if (ie_tipo_proposta_w in (1,2,3,4,6,7,8)) then
		CALL pls_gravar_histor_prop_benef(nr_seq_pessoa_proposta_w,clock_timestamp(),'12','Desfetio a contratação do beneficiário',nm_usuario_p);
	end if;
	end;
end loop;
close C01;

if (ie_tipo_proposta_w in (1,2,3,4,6,7,8)) then
	update	pls_proposta_adesao
	set	ie_status	= 'A',
		nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp()
	where	nr_sequencia	= nr_seq_proposta_p;

	update	pls_proposta_beneficiario
	set	nr_seq_benef_gerado	 = NULL,
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp()
	where	nr_seq_proposta		= nr_seq_proposta_p;
end if;

if (nr_seq_proposta_p IS NOT NULL AND nr_seq_proposta_p::text <> '') then
	update	pls_inclusao_beneficiario
	set	ie_status = 'A'
	where 	nr_seq_proposta = nr_seq_proposta_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_proposta_excluir_contrato ( nr_seq_proposta_p bigint, nm_usuario_p text) FROM PUBLIC;

