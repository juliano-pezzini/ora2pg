-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_pagto_santander_240 (nr_seq_envio_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
ie_registro_w			varchar(255);
tp_registro_w			bigint;
nr_inscricao_w			varchar(255);
nr_contrato_w			varchar(255);
nr_seq_envio_w			bigint;
nr_lote_w            bigint;
cd_agencia_w			varchar(255);
cd_conta_w			varchar(255);
nr_digito_conta_w		varchar(255);
nm_empresa_w			varchar(255);
dt_arquivo_w			timestamp;
hr_arquivo_w			varchar(255);
ie_tipo_servico_w		varchar(255);
ie_forma_lancamento_w		varchar(255);
ds_mensagem_w			varchar(255);
ds_endereco_w			varchar(255);
nr_endereco_w			varchar(255);
ds_complemento_w		varchar(255);
ds_cidade_w			varchar(255);
cd_cep_w			varchar(255);
cd_compl_cep_w			varchar(255);
sg_estado_w			varchar(255);
ie_emissao_lote_w		varchar(255);
ie_tipo_movimento_W		varchar(255);
cd_banco_w			varchar(255);
cd_compensacao_w		varchar(255);
nm_favorecido_w			varchar(255);
nr_documento_w			bigint;
dt_lancamento_w			timestamp;
vl_saldo_titulo_w		double precision;
ie_emissao_individual_w		varchar(255);
vl_pagamento_w			double precision;
dt_pagamento_w			timestamp;
qt_registros_w			bigint	:= 0;
vl_total_pagto_w		double precision;
cd_moedas_w			varchar(255);
cd_barras_W			varchar(255);
dt_vencimento_W			timestamp;
vl_titulo_w			double precision;
vl_desconto_W			double precision;
vl_acrescimo_W			double precision;
vl_pagto_w			double precision;
qt_moeda_w			bigint;
qt_lotes_arquivos_w		bigint	:= 0;
qt_total_registros_W		bigint;
ds_bairro_W			varchar(255);
tp_incrisao_w			varchar(255);
cd_cgc_fornecedor_w		varchar(255);
nr_titulo_w			bigint;
nr_registro_w			bigint;
nr_remessa_W			varchar(255);
cd_convenio_w			varchar(25);
ie_union_w			bigint;
ie_union_ant_w			bigint;
nr_lote_cont_w			bigint;
nr_seq_apres_w			bigint	:= 0;
nr_ordem_w			bigint;

c01 CURSOR FOR 
SELECT	1						ie_union, 
	1						ie_registro, 
	0						ie_tipo_registro, 
	a.cd_cgc					nr_inscricao, 
	g.cd_interno					nr_contrato, 
	e.nr_sequencia					nr_seq_envio, 
	somente_numero(g.cd_agencia_bancaria)		cd_agencia, 
	(substr(g.cd_conta,1,15))::numeric 		cd_conta, 
	substr(g.ie_digito_conta,1,1)			nr_digito_conta, 
	upper(p.ds_razao_social)			nm_empresa, 
	clock_timestamp()						dt_arquivo, 
	to_char(e.dt_remessa_retorno,'hh24miss')	hr_arquivo, 
	0						ie_tipo_servico, 
	'03'						ie_forma_lancamento, 
	' '						ds_mensagem, 
	' '						ds_endereco, 
	' '						nr_endereco, 
	' '						ds_complemento, 
	' '						ds_cidade, 
	' '						cd_cep, 
	' '						cd_compl_cep, 
	' '						sg_estado, 
	' '						ie_emissao_lote, 
	0						ie_tipo_movimento, 
	0						cd_banco, 
	0						cd_compensacao, 
	' '						nm_favorecido, 
	-2						nr_documento, 
	clock_timestamp()						dt_lancamento, 
	0						vl_saldo_titulo, 
	' '						ie_emissao_individual, 
	0						vl_pagamento, 
	clock_timestamp()						dt_pagamento, 
	0						vl_total_pagto, 
	0						cd_moeda, 
	' '						cd_barras, 
	clock_timestamp()						dt_vencimento, 
	0						vl_titulo, 
	0						vl_desconto, 
	0						vl_acrescimo, 
	0						vl_pagto, 
	0						qt_moeda, 
	0						qt_total_registros, 
	' '						ds_bairro, 
	' '		 				tp_inscricao, 
	' '						cd_cgc_fornecedor, 
	-2						nr_titulo, 
	e.nr_remessa					nr_remessa, 
	g.cd_convenio_banco				cd_convenio, 
	0						nr_lote, 
	-2						nr_ordem 
from	estabelecimento a, 
	banco_estabelecimento_v g, 
	pessoa_juridica p, 
	banco_escritural e 
where	e.cd_estabelecimento  	= a.cd_estabelecimento 
 and	a.cd_cgc		= p.cd_cgc 
 and	g.nr_sequencia		= e.nr_seq_conta_banco 
 and	g.ie_tipo_relacao   	in ('EP','ECC') 
 and	e.nr_sequencia		= nr_seq_envio_p 

union
 
/*	Header do Lote		*/
 
SELECT	distinct 
	2						ie_union, 
	2						ie_registro, 
	1						ie_tipo_registro, 
	e.cd_cgc					nr_inscricao, 
	b.cd_interno					nr_contrato, 
	a.nr_sequencia					nr_seq_envio, 
	somente_numero(b.cd_agencia_bancaria)		cd_agencia, 
	(substr(b.cd_conta,1,15))::numeric 		cd_conta, 
	substr(b.ie_digito_conta,1,1)			nr_digito_conta, 
	upper(j.ds_razao_social)			nm_empresa, 
	clock_timestamp()						dt_arquivo, 
	to_char(clock_timestamp(),'hh24miss')			hr_arquivo, 
	20						ie_tipo_servico, 
	'03'						ie_forma_lancamento, 
	' '						ds_mensagem, 
	upper(j.ds_endereco)				ds_endereco, 
	' '						nr_endereco, 
	j.ds_complemento				ds_complemento, 
	j.ds_municipio					ds_cidade, 
	substr(j.cd_cep,1,5)				cd_cep, 
	substr(j.cd_cep,6,3)				cd_compl_cep, 
	j.sg_estado					sg_estado, 
	'S'						ie_emissao_lote, 
	0						ie_tipo_movimento, 
	0						cd_banco, 
	0						cd_compensacao, 
	' '						nm_favorecido, 
	-1						nr_documento, 
	clock_timestamp()						dt_lancamento, 
	0						vl_saldo_titulo, 
	' '						ie_emissao_individual, 
	0						vl_pagamento, 
	clock_timestamp()						dt_pagamento, 
	0						vl_total_pagto, 
	0						cd_moeda, 
	' '						cd_barras, 
	clock_timestamp()						dt_vencimento, 
	0						vl_titulo, 
	0						vl_desconto, 
	0						vl_acrescimo, 
	0						vl_pagto, 
	0						qt_moeda, 
	0						qt_total_registros, 
	' '						ds_bairro, 
	' '		 				tp_inscricao, 
	' '						cd_cgc_fornecedor, 
	-1						nr_titulo, 
	a.nr_remessa					nr_remessa, 
	b.cd_convenio_banco				cd_convenio, 
	0						nr_lote, 
	-1						nr_ordem 
from	pessoa_juridica j, 
	Estabelecimento e, 
	banco_estabelecimento_v b, 
	banco_escritural a, 
	titulo_pagar_escrit c 
where	a.nr_sequencia		= c.nr_seq_escrit 
 and	e.cd_cgc		= j.cd_cgc 
 and	a.cd_estabelecimento  = e.cd_estabelecimento 
 and	b.ie_tipo_relacao    in ('EP','ECC') 
 and	b.nr_sequencia		= a.nr_seq_conta_banco 
 and	a.nr_sequencia		= nr_seq_envio_p 

union
 
/*	Detalhe Documento - Segmento A	*/
 
select	distinct 
	3						ie_union, 
	3						ie_registro, 
	2						ie_tipo_registro, 
	' '						nr_inscricao, 
	0						nr_contrato, 
	a.nr_sequencia					nr_seq_envio, 
	somente_numero(c.cd_agencia_bancaria)		cd_agencia, 
	(d.nr_conta_favorecido)::numeric 		cd_conta, 
	substr(d.ie_dig_conta_favorecido,1,1)		nr_digito_conta, 
	' '						nm_empresa, 
	clock_timestamp()						dt_arquivo, 
	to_char(clock_timestamp(),'hh24miss')			hr_arquivo, 
	0						ie_tipo_servico, 
	'03'						ie_forma_lancamento, 
	' '						ds_mensagem, 
	' '						ds_endereco, 
	' '						nr_endereco, 
	' '						ds_complemento, 
	' '						ds_cidade, 
	' '						cd_cep, 
	' '						cd_compl_cep, 
	' '						sg_estado, 
	' '						ie_emissao_lote, 
	0						ie_tipo_movimento, 
	c.cd_banco					cd_banco, 
	CASE WHEN coalesce(c.ie_tipo_pagamento::text, '') = '' THEN cd_camara_compensacao WHEN c.ie_tipo_pagamento='DOC' THEN 700  ELSE 18 END 	cd_compensacao, 
	d.nm_favorecido					nm_favorecido, 
	d.nr_titulo					nr_documento, 
	d.dt_emissao					dt_lancamento, 
	coalesce(d.vl_saldo_titulo,0)			vl_saldo_titulo, 
	'S'						ie_emissao_individual, 
	c.vl_escritural					vl_pagamento, 
	clock_timestamp()						dt_pagamento, 
	0						vl_total_pagto, 
	0						cd_moeda, 
	' '						cd_barras, 
	d.dt_vencimento_atual				dt_vencimento, 
	0						vl_titulo, 
	0						vl_desconto, 
	0						vl_acrescimo, 
	0						vl_pagto, 
	0						qt_moeda, 
	0						qt_total_registros, 
	' '						ds_bairro, 
	' '		 				tp_inscricao, 
	d.cd_favorecido 				cd_cgc_fornecedor, 
	d.nr_titulo					nr_titulo, 
	a.nr_remessa					nr_remessa, 
	b.cd_convenio_banco				cd_convenio, 
	0						nr_lote, 
	d.nr_titulo					nr_ordem 
from	estabelecimento e, 
	banco_estabelecimento_v b, 
	banco_escritural a, 
	titulo_pagar_v2 d, 
	titulo_pagar_escrit c 
where	c.nr_titulo		= d.nr_titulo 
and	a.nr_sequencia		= c.nr_seq_escrit 
and	a.cd_estabelecimento	= e.cd_estabelecimento 
and 	b.ie_tipo_relacao	in ('EP','ECC') 
and	b.nr_sequencia		= a.nr_seq_conta_banco 
and	a.nr_sequencia		= nr_seq_envio_p 

Union
 
/*	Detalhe Documento - Segmento B	*/
 
select	distinct 
	4						ie_union, 
	3						ie_registro, 
	3						ie_tipo_registro, 
	' '						nr_inscricao, 
	0						nr_contrato, 
	a.nr_sequencia					nr_seq_envio, 
	0						cd_agencia, 
	0						cd_conta, 
	' '		 				nr_digito_conta, 
	' '						nm_empresa, 
	clock_timestamp()						dt_arquivo, 
	to_char(clock_timestamp(),'hh24miss')			hr_arquivo, 
	0						ie_tipo_servico, 
	'03'						ie_forma_lancamento, 
	' '						ds_mensagem, 
	upper(d.ds_endereco)				ds_endereco, 
	' '						nr_endereco, 
	' '						ds_complemento, 
	d.ds_cidade					ds_cidade, 
	d.cd_cep					cd_cep, 
	' '						cd_compl_cep, 
	d.ds_estado					sg_estado, 
	' '						ie_emissao_lote, 
	0						ie_tipo_movimento, 
	0						cd_banco, 
	0						cd_compensacao, 
	' '						nm_favorecido, 
	d.nr_documento					nr_documento, 
	clock_timestamp()						dt_lancamento, 
	d.vl_saldo_titulo				vl_saldo_titulo, 
	' '						ie_emissao_individual, 
	0						vl_pagamento, 
	clock_timestamp()						dt_pagamento, 
	0						vl_total_pagto, 
	0						cd_moeda, 
	' '						cd_barras, 
	d.dt_vencimento_atual				dt_vencimento, 
	d.vl_titulo					vl_titulo, 
	c.vl_desconto					vl_desconto, 
	c.vl_acrescimo					vl_acrescimo, 
	0						vl_pagto, 
	0						qt_moeda, 
	0						qt_total_registros, 
	d.ds_bairro					ds_bairro, 
	d.ie_tipo_favorecido 				tp_inscricao, 
	d.cd_favorecido					cd_cgc_fornecedor, 
	d.nr_titulo					nr_titulo, 
	a.nr_remessa					nr_remessa, 
	b.cd_convenio_banco				cd_convenio, 
	0						nr_lote, 
	d.nr_titulo					nr_ordem 
from	estabelecimento e, 
	banco_estabelecimento_v b, 
	banco_escritural a, 
	titulo_pagar_v2 d, 
	titulo_pagar_escrit c 
where	c.nr_titulo		= d.nr_titulo 
and	a.nr_sequencia		= c.nr_seq_escrit 
and	a.cd_estabelecimento	= e.cd_estabelecimento 
and 	b.ie_tipo_relacao	in ('EP','ECC') 
and	b.nr_sequencia		= a.nr_seq_conta_banco 
and	a.nr_sequencia		= nr_seq_envio_p 

Union
 
/*	Trailler do Lote		*/
 
select	distinct 
	5						ie_union, 
	4						ie_registro, 
	4						ie_tipo_registro, 
	' '						nr_inscricao, 
	0						nr_contrato, 
	e.nr_sequencia					nr_seq_envio, 
	0						cd_agencia, 
	0						cd_conta, 
	' '		 				nr_digito_conta, 
	' '						nm_empresa, 
	clock_timestamp()						dt_arquivo, 
	to_char(clock_timestamp(),'hh24miss')			hr_arquivo, 
	0						ie_tipo_servico, 
	'03'						ie_forma_lancamento, 
	' '						ds_mensagem, 
	' '						ds_endereco, 
	' '						nr_endereco, 
	' '						ds_complemento, 
	' '						ds_cidade, 
	' '						cd_cep, 
	' '						cd_compl_cep, 
	' '						sg_estado, 
	' '						ie_emissao_lote, 
	0						ie_tipo_movimento, 
	0						cd_banco, 
	0						cd_compensacao, 
	' '						nm_favorecido, 
	9999995						nr_documento, 
	clock_timestamp()						dt_lancamento, 
	0						vl_saldo_titulo, 
	' '						ie_emissao_individual, 
	0						vl_pagamento, 
	clock_timestamp()						dt_pagamento, 
	sum(coalesce(c.vl_escritural,0) - coalesce(c.vl_desconto,0) + coalesce(c.vl_acrescimo,0)) vl_total_pagto, 
	0						cd_moeda, 
	' '						cd_barras, 
	clock_timestamp()						dt_vencimento, 
	0						vl_titulo, 
	0						vl_desconto, 
	0						vl_acrescimo, 
	0						vl_pagto, 
	0						qt_moeda, 
	0						qt_total_registros, 
	' '						ds_bairro, 
	' '		 				tp_inscricao, 
	' '						cd_cgc_fornecedor, 
	999995						nr_titulo, 
	e.nr_remessa					nr_remessa, 
	b.cd_convenio_banco				cd_convenio, 
	0						nr_lote, 
	999995						nr_ordem 
from	banco_estabelecimento_v b, 
	estabelecimento a, 
	banco_escritural e, 
	titulo_pagar_escrit c 
where	e.nr_sequencia		= c.nr_seq_escrit 
and	e.cd_estabelecimento  = a.cd_estabelecimento 
and	b.ie_tipo_relacao   	in ('EP','ECC') 
and	b.nr_sequencia		= e.nr_seq_conta_banco 
and	e.nr_sequencia		= nr_seq_envio_p 
group by	e.nr_sequencia, 
		e.nr_remessa, 
		b.cd_convenio_banco 

union
 
/*	Header do Lote - Bloquetos	*/
 
select	distinct 
	6						ie_union, 
	5						ie_registro, 
	5						ie_tipo_registro, 
	e.cd_cgc					nr_inscricao, 
	b.cd_interno					nr_contrato, 
	a.nr_sequencia					nr_seq_envio, 
	somente_numero(b.cd_agencia_bancaria)		cd_agencia, 
	(substr(b.cd_conta,1,15))::numeric 		cd_conta, 
	substr(b.ie_digito_conta,1,1)			nr_digito_conta, 
	upper(j.ds_razao_social)			nm_empresa, 
	clock_timestamp()						dt_arquivo, 
	to_char(clock_timestamp(),'hh24miss')			hr_arquivo, 
	01						ie_tipo_servico, 
	'03'						ie_forma_lancamento, 
	' '						ds_mensagem, 
	upper(j.ds_endereco)				ds_endereco, 
	j.nr_endereco					nr_endereco, 
	j.ds_complemento				ds_complemento, 
	j.ds_municipio					ds_cidade, 
	substr(j.cd_cep,1,5)				cd_cep, 
	substr(j.cd_cep,6,3)				cd_compl_cep, 
	j.sg_estado					sg_estado, 
	'S'						ie_emissao_lote, 
	0						ie_tipo_movimento, 
	0						cd_banco, 
	0						cd_compensacao, 
	upper(j.ds_razao_social)			nm_favorecido, 
	9999996						nr_documento, 
	clock_timestamp()						dt_lancamento, 
	0						vl_saldo_titulo, 
	' '						ie_emissao_individual, 
	0						vl_pagamento, 
	clock_timestamp()						dt_pagamento, 
	0						vl_total_pagto, 
	0						cd_moeda, 
	' '						cd_barras, 
	clock_timestamp()						dt_vencimento, 
	0						vl_titulo, 
	0						vl_desconto, 
	0						vl_acrescimo, 
	0						vl_pagto, 
	0						qt_moeda, 
 
	0						qt_total_registros, 
	' '						ds_bairro, 
	' '		 				tp_inscricao, 
	' '						cd_cgc_fornecedor, 
	999996						nr_titulo, 
	a.nr_remessa					nr_remesssa, 
	b.cd_convenio_banco				cd_convenio, 
	0						nr_lote, 
	999996						nr_ordem 
from	pessoa_juridica j, 
	Estabelecimento e, 
	banco_estabelecimento_v b, 
	banco_escritural a, 
	titulo_pagar k, 
	titulo_pagar_escrit c 
where	e.cd_cgc			= j.cd_cgc 
 and	a.nr_sequencia     	= c.nr_seq_escrit 
 and	a.cd_estabelecimento  	= e.cd_estabelecimento 
 and	b.ie_tipo_relacao    	in ('EP','ECC') 
 and	a.nr_seq_conta_banco		= b.nr_sequencia 
 and	c.nr_titulo			= k.nr_titulo 
 and 	c.ie_tipo_pagamento		= 'BLQ' 
 and	a.nr_sequencia			= nr_seq_envio_p 

union
 
/*	Detalhe Bloquetos	*/
 
select	distinct 
	7						ie_union, 
	6						ie_registro, 
	6						ie_tipo_registro, 
	' '						nr_inscricao, 
	0						nr_contrato, 
	a.nr_sequencia					nr_seq_envio, 
	somente_numero(c.cd_agencia_bancaria)		cd_agencia, 
	(c.nr_conta)::numeric 				cd_conta, 
	substr(c.ie_digito_conta,1,1)			nr_digito_conta, 
	' '						nm_empresa, 
	clock_timestamp()						dt_arquivo, 
	to_char(clock_timestamp(),'hh24miss')			hr_arquivo, 
	0						ie_tipo_servico, 
	'03'						ie_forma_lancamento, 
	' '						ds_mensagem, 
	' '						ds_endereco, 
	' '						nr_endereco, 
	' '						ds_complemento, 
	' '						ds_cidade, 
	' '						cd_cep, 
	' '						cd_compl_cep, 
	' '						sg_estado, 
	'S'						ie_emissao_lote, 
	0						ie_tipo_movimento, 
	c.cd_banco					cd_banco, 
	0						cd_compensacao, 
	d.nm_favorecido					nm_favorecido, 
	9999997						nr_documento, 
	clock_timestamp()						dt_lancamento, 
	0						vl_saldo_titulo, 
	' '						ie_emissao_individual, 
	0						vl_pagamento, 
	clock_timestamp()						dt_pagamento, 
	0						vl_total_pagto, 
	k.cd_moeda					cd_moeda, 
	d.nr_bloqueto					cd_barras, 
	d.dt_vencimento_atual				dt_vencimento, 
	coalesce(d.vl_titulo,0)				vl_titulo, 
	coalesce(c.vl_desconto,0)				vl_desconto, 
	coalesce(c.vl_acrescimo,0)				vl_acrescimo, 
	coalesce(c.vl_escritural,0)				vl_pagto, 
	0						qt_moeda,	 
	0						qt_total_registros, 
	' '						ds_bairro, 
	' '		 				tp_inscricao, 
	' '						cd_cgc_fornecedor, 
	C.NR_TITULO					nr_titulo, 
	a.nr_remessa					nr_remessa, 
	b.cd_convenio_banco				cd_convenio, 
	0						nr_lote, 
	999997						nr_ordem 
from	estabelecimento e, 
	banco_estabelecimento_v b, 
	banco_escritural a, 
	titulo_pagar_v2 d, 
	titulo_pagar_v k, 
	titulo_pagar_escrit c 
where	c.nr_titulo			= d.nr_titulo 
and	k.nr_titulo			= d.nr_titulo 
and	a.nr_sequencia			= c.nr_seq_escrit 
and	a.cd_estabelecimento		= e.cd_estabelecimento 
and 	b.ie_tipo_relacao		in ('EP','ECC') 
and	a.nr_seq_conta_banco		= b.nr_sequencia 
and 	c.ie_tipo_pagamento		= 'BLQ' 
and	a.nr_sequencia			= nr_seq_envio_p 

Union
 
/*	Trailler do Lote - Bloquetos	*/
 
select	distinct 
	8						ie_union, 
	7						ie_registro, 
	7						ie_tipo_registro, 
	' '						nr_inscricao, 
	0						nr_contrato, 
	e.nr_sequencia					nr_seq_envio, 
	0						cd_agencia, 
	0						cd_conta, 
	' '						nr_digito_conta, 
	' '						nm_empresa, 
	clock_timestamp()						dt_arquivo, 
	to_char(clock_timestamp(),'hh24miss')			hr_arquivo, 
	0						ie_tipo_servico, 
	'03'						ie_forma_lancamento, 
	' '						ds_mensagem, 
	' '						ds_endereco, 
	' '						nr_endereco, 
	' '						ds_complemento, 
	' '						ds_cidade, 
	' '						cd_cep, 
	' '						cd_compl_cep, 
	' '						sg_estado, 
	' '						ie_emissao_lote, 
	0						ie_tipo_movimento, 
	0						cd_banco, 
	0						cd_compensacao, 
	' '						nm_favorecido, 
	9999998						nr_documento, 
	clock_timestamp()						dt_lancamento, 
	0						vl_saldo_titulo, 
	'S'						ie_emissao_individual, 
	0						vl_pagamento, 
	clock_timestamp()						dt_pagamento, 
	sum(coalesce(c.vl_escritural,0) - coalesce(c.vl_desconto,0) + coalesce(c.vl_acrescimo,0)) vl_total_pagto, 
	0						cd_moeda, 
	' '						cd_barras, 
	clock_timestamp()						dt_vencimento, 
	0						vl_titulo, 
	0						vl_desconto, 
	0						vl_acrescimo, 
	0						vl_pagto, 
	0						qt_moeda, 
	0						qt_total_registros, 
	' '						ds_bairro, 
	' '		 				tp_inscricao, 
	' '						cd_cgc_fornecedor, 
	999998						nr_titulo, 
	e.nr_remessa					nr_remessa, 
	b.cd_convenio_banco				cd_convenio, 
	0						nr_lote, 
	999998						nr_ordem 
from	estabelecimento a, 
	banco_estabelecimento_v b, 
	banco_escritural e, 
	titulo_pagar_v2 d, 
	titulo_pagar_v k, 
	titulo_pagar_escrit c 
where	c.nr_titulo			= d.nr_titulo 
and	k.nr_titulo			= d.nr_titulo 
and	e.nr_sequencia			= c.nr_seq_escrit 
and	e.cd_estabelecimento		= a.cd_estabelecimento 
and 	b.ie_tipo_relacao		in ('EP','ECC') 
and	e.nr_seq_conta_banco		= b.nr_sequencia 
and 	c.ie_tipo_pagamento		= 'BLQ' 
and	e.nr_sequencia			= nr_seq_envio_p 
group by e.nr_sequencia, 
	e.nr_remessa, 
	b.cd_convenio_banco 

union
 
/*	Trailler do Arquivo	*/
 
select	distinct 
	9						ie_union, 
	8						ie_registro, 
	8						ie_tipo_registro, 
	' '						nr_inscricao, 
	0						nr_contrato, 
	e.nr_sequencia					nr_seq_envio, 
	0						cd_agencia, 
	0						cd_conta, 
	' '						nr_digito_conta, 
	' '						nm_empresa, 
	clock_timestamp()						dt_arquivo, 
	to_char(clock_timestamp(),'hh24miss')			hr_arquivo, 
	0						ie_tipo_servico, 
	'03'						ie_forma_lancamento, 
	' '						ds_mensagem, 
	' '						ds_endereco, 
	' '						nr_endereco, 
	' '						ds_complemento, 
	' '						ds_cidade, 
	' '						cd_cep, 
	' '						cd_compl_cep, 
	' '						sg_estado, 
	' '						ie_emissao_lote, 
	0						ie_tipo_movimento, 
	0						cd_banco, 
	0						cd_compensacao, 
	' '						nm_favorecido, 
	9999999						nr_documento, 
	clock_timestamp()						dt_lancamento, 
	0						vl_saldo_titulo, 
	' '						ie_emissao_individual, 
	0						vl_pagamento, 
	clock_timestamp()						dt_pagamento, 
	0						vl_total_pagto, 
	0						cd_moeda, 
	' '						cd_barras, 
	clock_timestamp()						dt_vencimento, 
	0						vl_titulo, 
	0						vl_desconto, 
	0						vl_acrescimo, 
	0						vl_pagto, 
	0						qt_moeda, 
	count(*)					qt_total_registros, 
	' '						ds_bairro, 
	' '		 				tp_inscricao, 
	' '						cd_cgc_fornecedor, 
	999999						nr_titulo, 
	e.nr_remessa					nr_remessa, 
	b.cd_convenio_banco				cd_convenio, 
	0						nr_lote, 
	999999						nr_ordem 
from	banco_estabelecimento_v b, 
	estabelecimento a, 
	banco_escritural e, 
	titulo_pagar_v2 d, 
	titulo_pagar_escrit c 
where	c.nr_titulo		= d.nr_titulo 
and	e.nr_sequencia		= c.nr_seq_escrit 
and	e.cd_estabelecimento  = a.cd_estabelecimento 
and	b.ie_tipo_relacao    in ('EP','ECC') 
and	b.nr_sequencia		= e.nr_seq_conta_banco 
and	e.nr_sequencia		= nr_seq_envio_p 
group by e.nr_sequencia, 
	e.nr_remessa, 
	b.cd_convenio_banco 
order by	nr_ordem, 
	ie_tipo_registro;


BEGIN 
 
delete from w_interf_itau;
 
nr_registro_w	:= 0;
ie_union_ant_w	:= null;
qt_lotes_arquivos_w := 0;
nr_lote_cont_w	:= 0;
 
open c01;
loop 
fetch c01 into 
	ie_union_w, 
	ie_registro_w, 
	tp_registro_w, 
	nr_inscricao_w, 
	nr_contrato_w, 
	nr_seq_envio_w, 
	cd_agencia_w, 
	cd_conta_w, 
	nr_digito_conta_w, 
	nm_empresa_w, 
	dt_arquivo_w, 
	hr_arquivo_w, 
	ie_tipo_servico_w, 
	ie_forma_lancamento_w, 
	ds_mensagem_w, 
	ds_endereco_w, 
	nr_endereco_w, 
	ds_complemento_w, 
	ds_cidade_w, 
	cd_cep_w, 
	cd_compl_cep_w, 
	sg_estado_w, 
	ie_emissao_lote_w, 
	ie_tipo_movimento_W, 
	cd_banco_w, 
	cd_compensacao_w, 
	nm_favorecido_w, 
	nr_documento_w, 
	dt_lancamento_w, 
	vl_saldo_titulo_w, 
	ie_emissao_individual_w, 
	vl_pagamento_w, 
	dt_pagamento_w, 
	vl_total_pagto_w, 
	cd_moedas_w, 
	cd_barras_W, 
	dt_vencimento_W, 
	vl_titulo_w, 
	vl_desconto_W, 
	vl_acrescimo_W, 
	vl_pagto_w, 
	qt_moeda_w, 
	qt_total_registros_W, 
	ds_bairro_W, 
	tp_incrisao_w, 
	cd_cgc_fornecedor_w, 
	nr_titulo_w, 
	nr_remessa_W, 
	cd_convenio_w, 
	nr_lote_w, 
	nr_ordem_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	nr_seq_apres_w	:= nr_seq_apres_w + 1;
 
	insert into w_interf_itau(nr_sequencia, 
		cd_agencia_bancaria, 
		cd_banco_fornec,     
		cd_barras,      
		cd_camara_compensacao,         
		cd_cep, 
		cd_cep_compl, 
		cd_cgc_fornecedor,    
		cd_conta,         
		cd_convenio_banco, 
		cd_moeda, 
		ds_bairro, 
		ds_cidade, 
		ds_complemento, 
		ds_brancos, 
		ds_endereco, 
		cd_carteira, 
		dt_arquivo, 
		dt_geracao, 
		dt_pagto, 
		dt_vencimento, 
		ie_digito_conta, 
		ie_emissao_individual, 
		ie_forma_lancamento, 
		ie_registro, 
		ie_tipo_inscricao, 
		ie_tipo_movimento, 
		ie_tipo_servico, 
		ie_tipo_registro, 
		nm_empresa, 
		nm_fornecedor, 
		nm_usuario, 
		nr_contrato, 
		nr_documento, 
		nr_endereco, 
		nr_inscricao, 
		nr_remessa, 
		nr_registro, 
		nr_seq_apres, 
		nr_seq_envio, 
		nr_titulo, 
		nr_lote, 
		qt_lote_arquivo, 
		qt_moeda, 
		qt_registros, 
		Qt_tot_reg, 
		sg_estado, 
		vl_acrescimo, 
		vl_desconto, 
		vl_pagto, 
		vl_previsto, 
		vl_saldo_titulo, 
		vl_titulo, 
		vl_total_pagto, 
		dt_atualizacao) 
	values (nextval('w_interf_itau_seq'), 
		cd_agencia_w, 
		cd_banco_w, 
		cd_barras_w, 
		cd_compensacao_w, 
		cd_cep_w, 
		cd_compl_cep_w, 
		cd_cgc_fornecedor_w, 
		cd_conta_w, 
		cd_convenio_w,	 
		cd_moedas_w, 
		substr(ds_bairro_w,1,39), 
		substr(ds_cidade_w,1,39), 
		ds_complemento_w, 
		ds_mensagem_w, 
		ds_endereco_w, 
		hr_arquivo_w, 
		dt_arquivo_w, 
		dt_lancamento_w, 
		dt_pagamento_w, 
		dt_vencimento_w, 
		nr_digito_conta_w, 
		ie_emissao_individual_w, 
		ie_forma_lancamento_w, 
		ie_registro_w, 
		tp_incrisao_w, 
		ie_tipo_movimento_w, 
		ie_tipo_servico_w, 
		tp_registro_w, 
		substr(nm_empresa_w,1,79), 
		substr(nm_favorecido_w,1,79), 
		'TASY', 
		nr_contrato_w, 
		nr_documento_w, 
		nr_endereco_w, 
		nr_inscricao_w, 
		nr_remessa_w, 
		nr_registro_W, 
		nr_seq_apres_w, 
		nr_seq_envio_w, 
		nr_titulo_w, 
		substr(nr_lote_w,1,3), 
		qt_lotes_arquivos_w, 
		qt_moeda_w, 
		qt_registros_w, 
		qt_total_registros_w, 
		sg_estado_w, 
		vl_acrescimo_w, 
		vl_desconto_w, 
		vl_pagto_w, 
		vl_pagamento_w, 
		vl_saldo_titulo_W, 
		vl_titulo_w, 
		vl_total_pagto_w, 
		clock_timestamp());
	 
	if (tp_registro_w in (2,3,6,7)) then 
		nr_registro_w		:= nr_registro_w + 1;
	end if;
	 
	if (tp_registro_w in (4,8)) then 
		nr_lote_w		:= nr_lote_w + 1;
		nr_registro_w		:= 1;
		qt_registros_w 	:= 1;
	end if;	
	 
	if (tp_registro_w in (4,8)) then 
		qt_registros_w 	:= 1;
	end if;	
	 
	if (tp_registro_w = 1) then 
		qt_lotes_arquivos_w 	:= qt_lotes_arquivos_w + 1;
	end if;
	 
	if (tp_registro_w in (1,2,3,5,6)) then 
		qt_registros_w	:= qt_registros_w + 1;			
	end if;
 
end loop;
close c01;
 
commit;	
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_pagto_santander_240 (nr_seq_envio_p bigint, nm_usuario_p text) FROM PUBLIC;

