-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE nota_entrada_terceiro (cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, nm_usuario_p text) AS $body$
DECLARE


contador_w			bigint := 0;
qt_registros_W			bigint;
ds_arquivo_ww			varchar(3000);
nr_sequencia_w			varchar(10);
nr_seq_aux_w			varchar(10);
cd_modelo_documento_w		varchar(10);
cd_serie_nf_w			varchar(10);
nr_nota_fiscal_w		varchar(255);
dt_emissao_documento_w		varchar(8);
cd_participante_w		varchar(15);
dt_entrada_saida_w		varchar(8);
vl_total_item_nf_w		varchar(18);
vl_desc_item_nf_w		varchar(18);
vl_frete_w			varchar(18);
vl_seguro_w			varchar(18);
vl_outras_despesas_w		varchar(18);
vl_ipi_w			varchar(18);
vl_icms_st_w			varchar(18);
vl_total_nota_fiscal_w		varchar(18);
insc_esta_subst_trib_w		varchar(15);
ie_tipo_fatura_w		varchar(10);
ds_observacao_w			varchar(45);
cd_estabelecimento_w		integer;

c01 CURSOR FOR
SELECT 	n.nr_sequencia												nr_sequencia ,
	LPAD(' ',2,' ')  											cd_modelo_documento,
	RPAD(n.cd_serie_nf,5,' ')										nr_serie_nf,
	LPAD(SUBSTR(n.nr_nota_fiscal,1,6),6,' ')										nr_nota_fiscal,
	LPAD(SUBSTR(TO_CHAR(n.dt_emissao,'ddmmyyyy'),1,8),8,' ')						dt_emissao_documento,
	LPAD(coalesce(SUBSTR(CASE WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='E' THEN 	   n.cd_cgc_emitente WHEN CASE WHEN n.ie_tipo_nota='EF' THEN 'E' WHEN n.ie_tipo_nota='EN' THEN 'E' WHEN n.ie_tipo_nota='EP' THEN 'E' WHEN n.ie_tipo_nota='SD' THEN 'S' WHEN n.ie_tipo_nota='SE' THEN 'S' WHEN n.ie_tipo_nota='SF' THEN 'S' WHEN n.ie_tipo_nota='ST' THEN 'S' END ='S' THEN CASE WHEN coalesce(n.cd_cgc::text, '') = '' THEN obter_cpf_pessoa_fisica(n.cd_pessoa_fisica)  ELSE n.cd_cgc END  END ,1,14),' '),14,' ') cd_participante,
	LPAD(coalesce(SUBSTR(TO_CHAR(n.dt_entrada_saida,'ddmmyyyy'),1,8),' '),8,' ') dt_entrada_saida,												--		 dt_entrada_saida,
	LPAD(coalesce(TO_CHAR((SELECT SUM(vl_total_item_nf) FROM nota_fiscal_item i WHERE i.nr_sequencia = n.nr_sequencia)),' '),17,' ')  vl_total_item_nf,
	LPAD(coalesce(TO_CHAR((SELECT SUM(vl_desconto) FROM nota_fiscal_item i WHERE i.nr_sequencia = n.nr_sequencia),''),' '),17,' ') vl_desc_item_nf,
	LPAD(coalesce(REPLACE(REPLACE(REPLACE(TO_CHAR(coalesce(n.vl_frete,0),'999,999,999,990.99'),',',''),'.',''),' ',''),' '),17,' ')  vl_frete,
	LPAD(coalesce(REPLACE(REPLACE(REPLACE(TO_CHAR(coalesce(n.vl_seguro,0),'999,999,999,990.99'),',',''),'.',''),' ',''),' '),17,' ') vl_seguro,
	LPAD(coalesce(REPLACE(REPLACE(REPLACE(TO_CHAR(0,'999,999,999,990.99'),',',''),'.',''),' ',''),' '),17,' ') vl_outras_despesas,
	LPAD(coalesce(REPLACE(REPLACE(REPLACE(TO_CHAR(coalesce(n.vl_ipi,0),'999,999,999,990.99'),',',''),'.',''),' ',''),' '),17,' ') vl_ipi,
	LPAD(coalesce(obter_valor_tipo_trib_item_nf(n.nr_sequencia,NULL,'ICMSST'),0),17,' ')				vl_icms_st,
	LPAD(coalesce(REPLACE(REPLACE(REPLACE(TO_CHAR(coalesce(n.vl_total_nota,0),'999,999,999,990.99'),',',''),'.',''),' ',''),' '),17,' ') vl_total_nota_fiscal,
	LPAD(coalesce(' ',' '),14,' ')											insc_esta_subst_trib,
	LPAD(CASE WHEN(SELECT elimina_acentuacao(elimina_caracteres_especiais(UPPER(c.ds_condicao_pagamento))) FROM condicao_pagamento c WHERE c.cd_condicao_pagamento = n.cd_condicao_pagamento)='AVISTA' THEN 1  ELSE 2 END ,1,' ') ie_tipo_fatura,
	lPAD(coalesce(SUBSTR(REPLACE(n.ds_observacao,chr(13),''),1,45),' '),45,' ')		ds_observacao,
	n.cd_estabelecimento
FROM operacao_nota o, nota_fiscal n
LEFT OUTER JOIN nota_fiscal_transportadora t ON (n.nr_sequencia = t.nr_seq_nota)
WHERE o.cd_operacao_nf = n.cd_operacao_nf and o.ie_servico = 'N' AND n.ie_tipo_nota IN ('EF','EN') and n.ie_situacao not in ('3','2') AND n.cd_estabelecimento = cd_estabelecimento_p AND n.dt_emissao between to_date(to_char(dt_inicio_p,'dd/mm/yyyy'),'dd/mm/yyyy') and fim_dia(to_date(to_char(dt_fim_p,'dd/mm/yyyy'),'dd/mm/yyyy')) ORDER BY n.nr_sequencia;


BEGIN

open c01;
loop
fetch c01 into
	nr_sequencia_w,
	cd_modelo_documento_w,
	cd_serie_nf_w,
	nr_nota_fiscal_w,
	dt_emissao_documento_w,
	cd_participante_w,
	dt_entrada_saida_w,
	vl_total_item_nf_w,
	vl_desc_item_nf_w,
	vl_frete_w,
	vl_seguro_w,
	vl_outras_despesas_w,
	vl_ipi_w,
	vl_icms_st_w,
	vl_total_nota_fiscal_w,
	insc_esta_subst_trib_w,
	ie_tipo_fatura_w,
	ds_observacao_w,
	cd_estabelecimento_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	contador_w := contador_w + 1;

	ds_arquivo_ww	:=	cd_modelo_documento_w		||
				cd_serie_nf_w  			|| nr_nota_fiscal_w 		||
				dt_emissao_documento_w  	|| cd_participante_w 		||
				dt_entrada_saida_w 		|| vl_total_item_nf_w 		||
				vl_desc_item_nf_w 		|| vl_frete_w 			||
				vl_seguro_w 			|| vl_outras_despesas_w 	||
				vl_ipi_w 			|| vl_icms_st_w 		||
				vl_total_nota_fiscal_w 		|| insc_esta_subst_trib_w 	||
				ie_tipo_fatura_w 		|| ds_observacao_w;

insert into w_inss_direp_arquivo( nr_sequencia,
				cd_estabelecimento,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				ds_arquivo_w)
		values (nextval('w_inss_direp_arquivo_seq'),
				cd_estabelecimento_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				ds_arquivo_ww);

	if (mod(contador_w,100) = 0) then
		commit;
	end if;

	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE nota_entrada_terceiro (cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, nm_usuario_p text) FROM PUBLIC;

