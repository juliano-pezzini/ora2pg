-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_rel_inconsistencias (nm_usuario_p text) AS $body$
DECLARE


ie_tipo_item_w			w_relat_hor_cpoe.ie_tipo_item%type;
nr_seq_item_w			w_relat_hor_cpoe.nr_seq_item%type;
nr_atendimento_w		w_relat_hor_cpoe.nr_atendimento%type;
cd_estabelecimento_w	w_relat_hor_cpoe.cd_estabelecimento%type;

nr_prescricao_w			prescr_medica.nr_prescricao%type;

qt_dia_prim_hor_w		prescr_material.qt_dia_prim_hor%type;

cd_material_w			cpoe_material.cd_material%type;
ie_administracao_w		cpoe_material.ie_administracao%type;
ie_alterou_horario_w	cpoe_material.ie_alterou_horario%type;
ds_horarios_prescr_w	cpoe_material.ds_horarios%type;
ds_horarios_w			cpoe_material.ds_horarios%type;
dt_liberacao_enf_w		cpoe_material.dt_liberacao_enf%type;
dt_liberacao_farm_w		cpoe_material.dt_liberacao_farm%type;

nr_seq_proc_interno_w	cpoe_procedimento.nr_seq_proc_interno%type;

cd_dieta_w				cpoe_dieta.cd_dieta%type;

cd_recomendacao_W		cpoe_recomendacao.cd_recomendacao%type;

cd_intervalo_w			intervalo_prescricao.cd_intervalo%type;
ie_operacao_w			intervalo_prescricao.ie_operacao%type;

dt_prox_geracao_w		timestamp;
dt_prim_horario_w		timestamp;
dt_fim_rel_w			timestamp;
dt_aux_w				timestamp;
qt_hora_intervalo_w		double precision;
qt_dias_w				bigint;
qt_prescricoes_prev_w	bigint;
qt_prescricoes_w		bigint;

ds_dias_semana_w		varchar(30);


/*
1 - Verifica se a cópia contem um item prescrito e ainda vigênte que não contem data de próxima geração
2 - Verifica se a cópia contem um item prescrito e ainda vigênte que a data de próxima geração deixou de ser atualizada
3 - Verifica se a quantidade de prescrições geradas
*/
c02 REFCURSOR;

c01 CURSOR FOR
	SELECT	CASE WHEN coalesce(ie_material, 'N')='S' THEN  'MAT'  ELSE CASE WHEN ie_controle_tempo='S' THEN  'SOL'  ELSE 'M' END  END  ie_tipo_item,
		a.nr_sequencia nr_seq_item,
		nr_atendimento,
		obter_estab_atendimento(a.nr_atendimento) cd_estabelecimento,
		dt_prox_geracao,
		dt_inicio,
		coalesce(ie_administracao, 'P') ie_administracao,
		cd_intervalo,
		dt_liberacao_enf,
		dt_liberacao_farm
	from	cpoe_material a
	where	((CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= clock_timestamp()) or (CASE WHEN coalesce(dt_lib_suspensao::text, '') = '' THEN  coalesce(a.dt_fim_cih,a.dt_fim)  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	coalesce(a.nr_seq_receita_amb,0) = 0
	and	coalesce(a.ie_retrogrado,'N') = 'N'
	and	((((coalesce(a.ie_evento_unico,'N') = 'N') and (coalesce(a.nr_seq_adicional::text, '') = '') and (coalesce(a.nr_seq_ataque::text, '') = '')) and (coalesce(a.ie_material,'N') = 'N')) or (not exists (SELECT	1
						from	prescr_medica y,
								prescr_material z
						where	y.nr_prescricao = z.nr_prescricao
						and	y.nr_atendimento = a.nr_atendimento
						and	z.nr_seq_mat_cpoe = a.nr_sequencia )))
	and	coalesce(a.ie_baixado_por_alta,'N') = 'N'
	and	coalesce(a.cd_funcao_origem,2314) = 2314
	and	(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '')
	and obter_se_atendimento_alta(a.nr_atendimento) = 'N'
	
union all

	select	ie_tipo_dieta ie_tipo_item,
		a.nr_sequencia nr_seq_item,
		nr_atendimento,
		obter_estab_atendimento(a.nr_atendimento) cd_estabelecimento,
		dt_prox_geracao,
		dt_inicio,
		coalesce(ie_administracao, 'P') ie_administracao,
		cd_intervalo,
		dt_liberacao_enf,
		dt_liberacao_farm
	from	cpoe_dieta a
	where	((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= clock_timestamp()) or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	coalesce(a.ie_retrogrado,'N') = 'N'
	and	((coalesce(a.ie_evento_unico,'N') = 'N') or (not exists (select	1
					from	prescr_medica y
					where	y.nr_atendimento = a.nr_atendimento
					and	exists (select	1
								from	prescr_material z
								where	z.nr_prescricao = y.nr_prescricao
								and		z.nr_seq_dieta_cpoe = a.nr_sequencia
								
union

								select	1
								from	prescr_dieta z
								where	z.nr_prescricao = y.nr_prescricao
								and		z.nr_seq_dieta_cpoe = a.nr_sequencia
								
union

								select	1
								from	rep_jejum z
								where	z.nr_prescricao = y.nr_prescricao
								and		z.nr_seq_dieta_cpoe = a.nr_sequencia
								
union

								select	1
								from	prescr_leite_deriv z
								where	z.nr_prescricao = y.nr_prescricao
								and		z.nr_seq_dieta_cpoe = a.nr_sequencia
								
union

								select	1
								from	nut_pac z
								where	z.nr_prescricao = y.nr_prescricao
								and		z.nr_seq_npt_cpoe = a.nr_sequencia))))
	and	coalesce(a.ie_dose_unica,'N') = 'N'
	and	coalesce(a.ie_baixado_por_alta,'N') = 'N'
	and	coalesce(a.cd_funcao_origem,2314) = 2314
	and	(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '')
	and obter_se_atendimento_alta(a.nr_atendimento) = 'N'
	and ie_tipo_dieta not in ('P', 'I')
	
union all

	select	'R' ie_tipo_item,
		a.nr_sequencia nr_seq_item,
		nr_atendimento,
		obter_estab_atendimento(a.nr_atendimento) cd_estabelecimento,
		dt_prox_geracao,
		dt_inicio,
		coalesce(ie_administracao, 'P') ie_administracao,
		cd_intervalo,
		dt_liberacao_enf,
		dt_liberacao_farm
	from	cpoe_recomendacao a
	where	((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= clock_timestamp()) or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	coalesce(a.ie_retrogrado,'N') = 'N'
	and	((coalesce(a.ie_evento_unico,'N') = 'N') or (not exists (select	1
					from	prescr_medica y,
						prescr_recomendacao z
					where	y.nr_prescricao = z.nr_prescricao
					and	y.nr_atendimento = a.nr_atendimento
					and	z.nr_seq_rec_cpoe = a.nr_sequencia)))
	and	coalesce(a.cd_funcao_origem,2314) = 2314
	and	(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '')
	and obter_se_atendimento_alta(a.nr_atendimento) = 'N'
	
union all

	select	'G' ie_tipo_item,
		a.nr_sequencia nr_seq_item,
		nr_atendimento,
		obter_estab_atendimento(a.nr_atendimento) cd_estabelecimento,
		dt_prox_geracao,
		dt_inicio,
		coalesce(ie_administracao, 'P') ie_administracao,
		cd_intervalo,
		dt_liberacao_enf,
		dt_liberacao_farm
	from	cpoe_gasoterapia a
	where	((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= clock_timestamp()) or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	coalesce(a.ie_retrogrado,'N') = 'N'
	and	coalesce(a.ie_baixado_por_alta,'N') = 'N'
	and	coalesce(a.cd_funcao_origem,2314) = 2314
	and	(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '')
	and obter_se_atendimento_alta(a.nr_atendimento) = 'N'
	
union all

	select	'P' ie_tipo_item,
		a.nr_sequencia nr_seq_item,
		nr_atendimento,
		obter_estab_atendimento(a.nr_atendimento) cd_estabelecimento,
		dt_prox_geracao,
		dt_inicio,
		coalesce(ie_administracao, 'P') ie_administracao,
		cd_intervalo,
		dt_liberacao_enf,
		dt_liberacao_farm
	from	cpoe_procedimento a
	where	((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= clock_timestamp()) or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	coalesce(a.ie_retrogrado,'N') = 'N'
	and	consiste_se_copia_proc_int(a.nr_seq_proc_interno) = 'S'
	and	((coalesce(a.ie_evento_unico,'N') = 'N') or (not exists (select	1
					from	prescr_medica y,
						prescr_procedimento z
					where	y.nr_prescricao = z.nr_prescricao
					and	y.nr_atendimento = a.nr_atendimento
					and	z.nr_seq_proc_cpoe = a.nr_sequencia)))
	and	coalesce(a.ie_baixado_por_alta,'N') = 'N'
	and	coalesce(a.cd_funcao_origem,2314) = 2314
	and	(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '')
	and obter_se_atendimento_alta(a.nr_atendimento) = 'N'
	and	(a.nr_seq_proc_interno IS NOT NULL AND a.nr_seq_proc_interno::text <> '')
	
union all

	select	'DI' ie_tipo_item,
		a.nr_sequencia nr_seq_item,
		nr_atendimento,
		obter_estab_atendimento(a.nr_atendimento) cd_estabelecimento,
		dt_prox_geracao,
		dt_inicio,
		coalesce(ie_administracao, 'P') ie_administracao,
		null,
		dt_liberacao_enf,
		dt_liberacao_farm
	from	cpoe_dialise a
	where	((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= clock_timestamp()) or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = ''))
	and	(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
	and	coalesce(a.ie_retrogrado,'N') = 'N'
	and	((coalesce(a.ie_evento_unico,'N') = 'N') or (not exists (select	1
					from	prescr_medica y,
						hd_prescricao z
					where	y.nr_prescricao = z.nr_prescricao
					and	y.nr_atendimento = a.nr_atendimento
					and	z.nr_seq_dialise_cpoe = a.nr_sequencia)))
	and	coalesce(a.ie_baixado_por_alta,'N') = 'N'
	and	coalesce(a.cd_funcao_origem,2314) = 2314
	and	(a.nr_atendimento IS NOT NULL AND a.nr_atendimento::text <> '')
	and obter_se_atendimento_alta(a.nr_atendimento) = 'N'
	order by cd_estabelecimento, nr_atendimento, ie_tipo_item;

procedure valores_adicionais is

;
BEGIN
	ie_alterou_horario_w:= 'N';

	if (ie_tipo_item_w in ('M','MAT','SOL')) then
		select	cd_material,
			ie_alterou_horario,
			ds_horarios
		into STRICT	cd_material_w,
			ie_alterou_horario_w,
			ds_horarios_w
		from	cpoe_material
		where	nr_sequencia = nr_seq_item_w;
	elsif (ie_tipo_item_w in ('L', 'E', 'S', 'O')) then
		select	coalesce(cd_material, cd_mat_prod1),
			cd_dieta,
			ie_alterou_horario,
			ds_horarios
		into STRICT	cd_material_w,
			cd_dieta_w,
			ie_alterou_horario_w,
			ds_horarios_w
		from	cpoe_dieta
		where	nr_sequencia = nr_seq_item_w;
	elsif (ie_tipo_item_w in ('P')) then
		select	nr_seq_proc_interno,
			ds_horarios
		into STRICT	nr_seq_proc_interno_w,
			ds_horarios_w
		from	cpoe_procedimento
		where	nr_sequencia = nr_seq_item_w;
	elsif (ie_tipo_item_w in ('R')) then
		select	cd_recomendacao,
			ds_horarios
		into STRICT	cd_recomendacao_W,
			ds_horarios_w
		from	cpoe_recomendacao
		where	nr_sequencia = nr_seq_item_w;
	elsif (ie_tipo_item_w in ('G')) then
		select	ds_horarios
		into STRICT	ds_horarios_w
		from	cpoe_gasoterapia
		where	nr_sequencia = nr_seq_item_w;
	end if;

end;

procedure insert_w_relat_hor_cpoe(ie_tipo_incons_p	varchar2, ds_incons_aux_p varchar2) is

begin
	insert
	into w_relat_hor_cpoe(cd_estabelecimento, nr_seq_item, dt_atualizacao, nm_usuario, ie_tipo_item, ie_tipo_incons, nr_atendimento, ds_incons_aux)
	values (cd_estabelecimento_w, nr_seq_item_w, clock_timestamp(), nm_usuario_p, ie_tipo_item_w, ie_tipo_incons_p, nr_atendimento_w, ds_incons_aux_p);
end;

begin

dt_fim_rel_w	:=	clock_timestamp() + (18/24); /* Verificar melhor essa data, talvez será melhor pegar através da tabela LOG_CPOE*/
delete from w_relat_hor_cpoe where nm_usuario = nm_usuario_p;

commit;

open c01;
loop
fetch c01 into
		ie_tipo_item_w,
		nr_seq_item_w,
		nr_atendimento_w,
		cd_estabelecimento_w,
		dt_prox_geracao_w,
		dt_prim_horario_w,
		ie_administracao_w,
		cd_intervalo_w,
		dt_liberacao_enf_w,
		dt_liberacao_farm_w; /* (P,N,C)(Conforme 1º Horário,Se necessário,A critério médico) */
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	valores_adicionais();


	if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') then
		select	max(ie_operacao),
			max(obter_ocorrencia_intervalo(cd_intervalo, 24, 'H'))
		into STRICT	ie_operacao_w,
			qt_hora_intervalo_w
		from	intervalo_prescricao
		where	cd_intervalo = cd_intervalo_w;
	end if;

	/* Verifica se a cópia contem um item prescrito e ainda vigênte que não contem data de próxima geração */

	if (coalesce(dt_prox_geracao_w::text, '') = '') then
		insert_w_relat_hor_cpoe('1', '');
		goto proximo_item;
	end if;
	/* Verifica se a cópia contem um item prescrito e ainda vigênte que a data de próxima geração deixou de ser atualizada */

	if (dt_prox_geracao_w < clock_timestamp() - interval '3 days') then
		insert_w_relat_hor_cpoe('2','');
		goto proximo_item;
	end if;
	/* Verifica se a quantidade de prescrições geradas */

	if ((cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') and ie_operacao_w not in ('D')) then

		qt_dias_w := trunc(dt_fim_rel_w - dt_prim_horario_w);

		if (qt_hora_intervalo_w between 1 and 12) then
			qt_prescricoes_prev_w := qt_dias_w;
		elsif (qt_hora_intervalo_w between 13 and 24) then
			qt_prescricoes_prev_w := TRUNC((qt_dias_w * 24) / (qt_hora_intervalo_w * 2));
		elsif (qt_hora_intervalo_w >= 24) then
			qt_prescricoes_prev_w := TRUNC((qt_dias_w * 24) / (qt_hora_intervalo_w));
		end if;

		if (ie_tipo_item_w in ('M','MAT','SOL')) then

			if (ie_tipo_item_w = 'M') then
				select	 CASE WHEN coalesce(max(ie_domingo), 'S')='S' THEN  '1'  ELSE '' END  ||
					CASE WHEN coalesce(max(ie_segunda), 'S')='S' THEN  '2'  ELSE '' END  ||
					CASE WHEN coalesce(max(ie_terca), 'S')='S' THEN  '3'  ELSE '' END  ||
					CASE WHEN coalesce(max(ie_quarta), 'S')='S' THEN  '4'  ELSE '' END  ||
					CASE WHEN coalesce(max(ie_quinta), 'S')='S' THEN  '5'  ELSE '' END  ||
					CASE WHEN coalesce(max(ie_sexta), 'S')='S' THEN  '6'  ELSE '' END  ||
					CASE WHEN coalesce(max(ie_sabado), 'S')='S' THEN  '7'  ELSE '' END
				into STRICT	ds_dias_semana_w
				from	cpoe_material
				where	nr_sequencia	= nr_seq_item_w;

				dt_aux_w := dt_prim_horario_w;
				while(dt_aux_w < dt_fim_rel_w) loop
					if (position(obter_cod_dia_semana(dt_aux_w) in ds_dias_semana_w) = 0) then
						qt_dias_w := qt_dias_w-1;
					end if;
					dt_aux_w := dt_aux_w +1;
				end loop;
			end if;
			select	count(distinct nr_prescricao)
			into STRICT	qt_prescricoes_w
			from	prescr_material
			where	nr_seq_mat_cpoe = nr_seq_item_w;
		elsif (ie_tipo_item_w in ('L', 'E', 'S')) then
			select count(distinct nr_prescricao)
			into STRICT	qt_prescricoes_w
			from	prescr_material
			where	nr_seq_dieta_cpoe = nr_seq_item_w;
		elsif (ie_tipo_item_w in ('O')) then
			select count(distinct nr_prescricao)
			into STRICT	qt_prescricoes_w
			from	prescr_dieta
			where	nr_seq_dieta_cpoe = nr_seq_item_w;
		elsif (ie_tipo_item_w in ('J')) then
			select count(distinct nr_prescricao)
			into STRICT	qt_prescricoes_w
			from	rep_jejum
			where	nr_seq_dieta_cpoe = nr_seq_item_w;
		elsif (ie_tipo_item_w in ('P')) then
			select count(distinct nr_prescricao)
			into STRICT	qt_prescricoes_w
			from	prescr_procedimento
			where	nr_seq_proc_cpoe = nr_seq_item_w;
		elsif (ie_tipo_item_w in ('R')) then
			select count(distinct nr_prescricao)
			into STRICT	qt_prescricoes_w
			from	prescr_recomendacao
			where	nr_seq_rec_cpoe = nr_seq_item_w;
		elsif (ie_tipo_item_w in ('G')) then
			select count(distinct nr_prescricao)
			into STRICT	qt_prescricoes_w
			from	prescr_gasoterapia
			where	nr_seq_gas_cpoe = nr_seq_item_w;
		elsif (ie_tipo_item_w = 'DI') then
			select count(distinct nr_prescricao)
			into STRICT	qt_prescricoes_w
			from	hd_prescricao
			where	nr_seq_dialise_cpoe = nr_seq_item_w;
		end if;

		if (qt_prescricoes_w < qt_prescricoes_prev_w) then
			insert_w_relat_hor_cpoe('3', '');
			goto proximo_item;
		end if;
	end if;

	/* Possível erro na geração do item na prescrição */

	if (ie_administracao_w = 'P' and  ie_alterou_horario_w = 'N' and ((dt_liberacao_farm_w IS NOT NULL AND dt_liberacao_farm_w::text <> '') or (dt_liberacao_enf_w IS NOT NULL AND dt_liberacao_enf_w::text <> ''))) then
		if (ie_tipo_item_w in ('M','MAT','SOL') and (cd_material_w IS NOT NULL AND cd_material_w::text <> '')) then
			open c02 for
			SELECT	ds_horarios,
				nr_prescricao,
				qt_dia_prim_hor
			from	prescr_material
			where	nr_seq_mat_cpoe = nr_seq_item_w
			and	cd_material = cd_material_w
			and	dt_atualizacao_nrec > coalesce(dt_liberacao_farm_w, dt_liberacao_enf_w);
		elsif (ie_tipo_item_w in ('L', 'E', 'S') and (cd_material_w IS NOT NULL AND cd_material_w::text <> '')) then
			open c02 for
			SELECT	ds_horarios,
				nr_prescricao,
				qt_dia_prim_hor
			from	prescr_material
			where	nr_seq_dieta_cpoe = nr_seq_item_w
			and	cd_material = cd_material_w
			and	dt_atualizacao_nrec > coalesce(dt_liberacao_farm_w, dt_liberacao_enf_w);
		elsif (ie_tipo_item_w in ('O') and (cd_dieta_w IS NOT NULL AND cd_dieta_w::text <> '')) then
			open c02 for
			SELECT ds_horarios,
				nr_prescricao,
				0
			from	prescr_dieta
			where	nr_seq_dieta_cpoe = nr_seq_item_w
			and	cd_dieta = cd_dieta_w
			and	dt_atualizacao > coalesce(dt_liberacao_farm_w, dt_liberacao_enf_w);
		elsif (ie_tipo_item_w in ('P') and (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '')) then
			open c02 for
			SELECT	ds_horarios,
				nr_prescricao,
				0
			from	prescr_procedimento
			where	nr_seq_proc_cpoe = nr_seq_item_w
			and	nr_seq_proc_interno = nr_seq_proc_interno_w
			and	dt_atualizacao_nrec > coalesce(dt_liberacao_farm_w, dt_liberacao_enf_w);
		elsif (ie_tipo_item_w in ('R')) then
			open c02 for
			SELECT ds_horarios,
				nr_prescricao,
				0
			from	prescr_recomendacao
			where	nr_seq_rec_cpoe = nr_seq_item_w
			and	cd_recomendacao = cd_recomendacao_W
			and	dt_atualizacao > coalesce(dt_liberacao_farm_w, dt_liberacao_enf_w);
		elsif (ie_tipo_item_w in ('G')) then
			open c02 for
			SELECT	ds_horarios,
				nr_prescricao,
				0
			from	prescr_gasoterapia
			where	nr_seq_gas_cpoe = nr_seq_item_w
			and	dt_atualizacao_nrec > coalesce(dt_liberacao_farm_w, dt_liberacao_enf_w);
		else
			open c02 for
			SELECT	'', '', 0
			;
		end if;

		loop
		fetch c02 into
			ds_horarios_prescr_w,
			nr_prescricao_w,
			qt_dia_prim_hor_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			if (ds_horarios_prescr_w IS NOT NULL AND ds_horarios_prescr_w::text <> '' AND nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') then
				if (position('das' in ds_horarios_w) = 0 and position('das' in ds_horarios_prescr_w) = 0 and  obter_quantidade_horarios(ds_horarios_w) <> obter_quantidade_horarios(ds_horarios_prescr_w)) then
					insert_w_relat_hor_cpoe('4', 'Prescr: ' || nr_prescricao_w);
					goto proximo_item;
				elsif (qt_dia_prim_hor_w < 0) then
					insert_w_relat_hor_cpoe('5', 'Prescr: ' || nr_prescricao_w);
					goto proximo_item;
				end if;
			end if;
		end loop;
		close c02;
	end if;

	<<proximo_item>>
	null;
	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_rel_inconsistencias (nm_usuario_p text) FROM PUBLIC;

