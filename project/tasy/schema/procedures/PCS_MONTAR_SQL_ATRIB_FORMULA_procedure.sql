-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pcs_montar_sql_atrib_formula ( nr_seq_atributo_p bigint) AS $body$
DECLARE


nm_atributo_w		varchar(50);
nm_tabela_w		varchar(50);
ie_filtro_data_w	varchar(255);
nm_atributo_restricao_w	varchar(255);
ie_restricao_w		varchar(15);
ds_atributo_w		varchar(255);
ie_opcao_w		varchar(15);
ds_select_w		varchar(255);
ds_from_w		varchar(255);
ds_where_w		varchar(2000);
ds_where_fixo_w		varchar(2000);
ds_sql_w		varchar(4000);
ds_alias_w		varchar(2);
qt_reg_w		bigint;
qt_restricao_w		bigint;
ie_opcao_ww		varchar(15);
ds_filtro_w		varchar(255);
ie_operacao_w		varchar(15);
ds_valor_w		varchar(255);
ds_valor_ww		varchar(255);
ds_sql_informado_w	varchar(4000);

C01 CURSOR FOR
	SELECT	a.ds_atributo
	from	pcs_atributo_restricao a
	where	a.nr_seq_atributo = nr_seq_atributo_p
	group by a.ds_atributo
	order by ds_atributo;

c02 CURSOR FOR
	SELECT	a.ds_valor
	from	pcs_atributo_restricao a
	where	a.nr_seq_atributo = nr_seq_atributo_p
	and	a.ds_atributo = nm_atributo_restricao_w
	order by a.ds_valor;


BEGIN

select	nm_tabela,
	nm_campo,
	ds_restricao_data,
	ie_operacao,
	ds_sql_informado
into STRICT	nm_tabela_w,
	nm_atributo_w,
	ie_filtro_data_w,
	ie_operacao_w,
	ds_sql_informado_w
from	pcs_atributo
where	nr_sequencia = nr_seq_atributo_p;

if (nm_tabela_w IS NOT NULL AND nm_tabela_w::text <> '') and (nm_atributo_w IS NOT NULL AND nm_atributo_w::text <> '') then

--if	(nm_tabela_w <> 'FUNCTION') then
	if (ie_operacao_w = 'SOMA') then
		ds_select_w	:= ' select sum(' || nm_atributo_w || ')';
	elsif (ie_operacao_w = 'MAXIMO') then
		ds_select_w	:= ' select max(' || nm_atributo_w || ')';
	elsif (ie_operacao_w = 'MINIMO') then
		ds_select_w	:= ' select min(' || nm_atributo_w || ')';
	elsif (ie_operacao_w = 'MEDIA') then
		ds_select_w	:= ' select avg(' || nm_atributo_w || ')';
	elsif (ie_operacao_w = 'ARRED_BAIXO') then
		ds_select_w	:= ' select trunc(sum(' || nm_atributo_w || '),2)';
	elsif (ie_operacao_w = 'ARRED_CIMA') then
		ds_select_w	:= ' select round(sum(' || nm_atributo_w || '))';
	elsif (ie_operacao_w = 'TETO') then
		ds_select_w	:= ' select ceil(' || nm_atributo_w || ')';
	end if;

	ds_from_w	:= ' from ' || nm_tabela_w;
	ds_where_w	:= ' where 1 = 1 ';
	if (ie_filtro_data_w IS NOT NULL AND ie_filtro_data_w::text <> '') then
		ds_where_w	:= ds_where_w || ' and ' || ie_filtro_data_w || ' between :dt_ini and :dt_fim';
	end if;


	open C01;
	loop
	fetch C01 into
		nm_atributo_restricao_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		/*select	MAX(nm_atributo)
		into	nm_atributo_restricao_w
		from	capa_ficha_financ_campos_res_v
		where 	nm_tabela	= nm_tabela_w
		and	ie_restricao	= ie_restricao_w
		and	ie_opcao	= TO_CHAR(ie_opcao_w);*/
		ds_filtro_w := null;

		select	count(*)
		into STRICT	qt_restricao_w
		from	pcs_atributo_restricao a
		where	a.nr_seq_atributo = nr_seq_atributo_p
		and	a.ds_atributo = nm_atributo_restricao_w;

		if (qt_restricao_w > 1)  then
			open C02;
			loop
			fetch C02 into
				ds_valor_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin
				ds_filtro_w := ds_filtro_w || ',' || ''''||TO_CHAR(ds_valor_w)||'''';
	--			ds_filtro_w := ds_filtro_w || ',' || ''''||TO_CHAR(ie_opcao_w)||'''';
				end;
			end loop;
			close C02;
		elsif (qt_restricao_w = 1)  then

			select	ds_valor
			into STRICT	ds_valor_ww
			from	pcs_atributo_restricao
			where	ds_atributo = nm_atributo_restricao_w
			and	nr_seq_atributo = nr_seq_atributo_p;
		end if;

		if (ds_filtro_w IS NOT NULL AND ds_filtro_w::text <> '') then
			begin
			ds_filtro_w := substr(ds_filtro_w,2,255);
			ds_filtro_w := ' in ('||ds_filtro_w||')';
			end;
		else
			ds_filtro_w := ' = ' || ''''||TO_CHAR(ds_valor_ww)||'''';
		end if;

		ds_where_w	:= ds_where_w || ' and ' || nm_atributo_restricao_w || ds_filtro_w;

		if (substr(lower(nm_atributo_restricao_w),1,6) = 'exists') then
			ds_where_w	:= ds_where_w || ')';
		end if;
		end;
	end loop;
	close C01;
/*else
	begin
	ds_from_w 	:= 'from dual ';
	ds_where_w 	:= '';
	ds_where_fixo_w := '';

	--ds_select_w := 'select fin_obter_valor_receb('''||TO_CHAR(nm_atributo_w)||''', :dt_ini, :dt_fim, :cd_pessoa_fisica, :cd_cgc, :cd_estabelecimento, :nm_usuario) ';
	end;  */
--end if;
ds_sql_w := ds_select_w || ' ' || ds_from_w || ' ' || ds_where_w;

end if;

if (coalesce(ds_sql_w::text, '') = '') then
	update	pcs_atributo
	set	ds_sql = SUBSTR(ds_sql_informado_w,1,4000)
	where	nr_sequencia = nr_seq_atributo_p;
else
	update	pcs_atributo
	set	ds_sql = SUBSTR(ds_sql_w,1,4000)
	where	nr_sequencia = nr_seq_atributo_p;
end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pcs_montar_sql_atrib_formula ( nr_seq_atributo_p bigint) FROM PUBLIC;

