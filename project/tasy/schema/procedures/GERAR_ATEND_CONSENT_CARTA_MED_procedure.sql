-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_atend_consent_carta_med (nr_atendimento_p bigint) AS $body$
DECLARE


ie_consentiu_w  atend_consent_carta_med.ie_consentiu%TYPE   := 'N';
cd_pessoa_fisica_w atendimento_paciente.cd_pessoa_fisica%TYPE;

C01 CURSOR FOR
    SELECT
        pme.nr_seq_tipo_medico,
        pme.ds_observacao,
        pme.cd_medico
    FROM pf_medico_externo pme
    WHERE pme.cd_pessoa_fisica = cd_pessoa_fisica_w
    AND pme.cd_medico NOT IN (
        SELECT accm.cd_medico
        FROM atend_consent_carta_med accm
        WHERE accm.nr_atendimento = nr_atendimento_p
        AND pme.cd_pessoa_fisica = cd_pessoa_fisica_w)
    AND pme.cd_medico NOT IN (
        SELECT api.cd_medico
        FROM atendimento_paciente_inf api
        WHERE api.nr_atendimento = nr_atendimento_p)
    AND clock_timestamp() BETWEEN coalesce(pme.dt_inicio_vigencia, clock_timestamp() - interval '1 days') AND coalesce(pme.dt_fim_vigencia, clock_timestamp() + interval '1 days');

BEGIN
    SELECT cd_pessoa_fisica
    INTO STRICT cd_pessoa_fisica_w
    FROM atendimento_paciente
    WHERE nr_atendimento = nr_atendimento_p;

    FOR r_c01_w IN C01 LOOP

        BEGIN
            INSERT INTO atend_consent_carta_med(
                nr_sequencia,
                nr_seq_tipo_medico,
                nr_atendimento,
                nm_usuario_nrec,
                nm_usuario,
                ie_consentiu,
                dt_atualizacao_nrec,
                dt_atualizacao,
                ds_observacao,
                cd_medico
                )
            VALUES (
                nextval('atend_consent_carta_med_seq'),
                r_c01_w.nr_seq_tipo_medico,
                nr_atendimento_p,
                wheb_usuario_pck.get_nm_usuario,
                wheb_usuario_pck.get_nm_usuario,
                ie_consentiu_w,
                clock_timestamp(),
                clock_timestamp(),
                r_c01_w.ds_observacao,
                r_c01_w.cd_medico
                );
        END;

    END LOOP;

	COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_atend_consent_carta_med (nr_atendimento_p bigint) FROM PUBLIC;

