-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ageserv_gerar_pass_setor_atend ( nr_atendimento_p bigint, cd_setor_atendimento_p bigint, dt_passagem_p timestamp, ie_cons_setor_usuario_p text, cd_unidade_basica_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_unidade_w		bigint;
nr_sequencia_w			bigint;
nr_seq_interno_w		bigint;
qt_passagem_w			smallint;
dt_passagem_w			timestamp;
qt_registro_w			integer;
ds_setor_atendimento_w		varchar(100);


BEGIN

if (cd_setor_atendimento_p IS NOT NULL AND cd_setor_atendimento_p::text <> '') then

	select	coalesce(count(*),0)
	into STRICT	qt_passagem_w
	from	atend_paciente_unidade
	where	nr_atendimento 			= nr_atendimento_p
	  and	cd_setor_atendimento		= cd_setor_atendimento_p
	  and	trunc(dt_entrada_unidade,'dd')	= trunc(dt_passagem_p,'dd')
	  and	dt_entrada_unidade		<= dt_passagem_p;

	if (qt_passagem_w = 0) then
		begin
		if (ie_cons_setor_usuario_p = 'S') then
			if (cd_unidade_basica_p IS NOT NULL AND cd_unidade_basica_p::text <> '') then
				select	coalesce(min(nr_seq_interno),0)
				into STRICT	nr_seq_unidade_w
				from	unidade_atendimento
				where	ie_situacao = 'A'
				  and	cd_setor_atendimento in (SELECT	cd_setor_atendimento
					from	usuario_setor_v
					where	upper(nm_usuario)		= upper(nm_usuario_p)
					and	cd_setor_atendimento	= cd_setor_atendimento_p)
				  and 	nr_seq_interno	= cd_unidade_basica_p;
			else
				select	coalesce(min(nr_seq_interno),0)
				into STRICT	nr_seq_unidade_w
				from	unidade_atendimento
				where	ie_situacao = 'A'
				  and	cd_setor_atendimento in (SELECT	cd_setor_atendimento
					from	usuario_setor_v
					where	upper(nm_usuario)		= upper(nm_usuario_p)
					  and	cd_setor_atendimento	= cd_setor_atendimento_p);
			end if;
			if (nr_seq_unidade_w = 0) then
				select	substr(obter_desc_expressao(max(cd_exp_setor_atend),max(ds_setor_atendimento)),1,100)
				into STRICT	ds_setor_atendimento_w
				from	setor_atendimento
				where	cd_setor_atendimento	= cd_setor_atendimento_p;

				CALL Wheb_mensagem_pck.exibir_mensagem_abort( 262422 , 'DS_SETOR_ATENDIMENTO_W='||ds_setor_atendimento_w||';NM_USUARIO_P='||nm_usuario_p);
			end if;
		else
			if (cd_unidade_basica_p IS NOT NULL AND cd_unidade_basica_p::text <> '') then
				select	coalesce(min(nr_seq_interno),0)
				into STRICT	nr_seq_unidade_w
				from	unidade_atendimento
				where	ie_situacao = 'A'
				and	cd_setor_atendimento	= cd_setor_atendimento_p
				and 	nr_seq_interno	= cd_unidade_basica_p;
			else
				select	coalesce(min(nr_seq_interno),0)
				into STRICT	nr_seq_unidade_w
				from	unidade_atendimento
				where	ie_situacao = 'A'
				and	cd_setor_atendimento	= cd_setor_atendimento_p;
			end if;

			if (nr_seq_unidade_w = 0) then
				select	substr(obter_desc_expressao(max(cd_exp_setor_atend),max(ds_setor_atendimento)),1,100)
				into STRICT	ds_setor_atendimento_w
				from	setor_atendimento
				where	cd_setor_atendimento	= cd_setor_atendimento_p;

				CALL Wheb_mensagem_pck.exibir_mensagem_abort( 262647 , 'DS_SETOR_ATENDIMENTO_W='||ds_setor_atendimento_w);
			end if;
		end if;

		select	nextval('atend_paciente_unidade_seq')
		into STRICT	nr_seq_interno_w
		;

		select	coalesce(max(nr_sequencia),0) + 1
		into STRICT	nr_sequencia_w
		from	atend_paciente_unidade
		where	nr_atendimento = nr_atendimento_p;

		dt_passagem_w		:= dt_passagem_p - 1/86400;
		qt_registro_w		:= 1;
		while(qt_registro_w > 0) LOOP
			begin
			dt_passagem_w	:= dt_passagem_w + 1/86400;
			select	count(*)
			into STRICT	qt_registro_w
			from	atend_paciente_unidade
			where	nr_atendimento		= nr_atendimento_p
			  and	dt_entrada_unidade	= dt_passagem_w;
			end;
		END LOOP;

		insert into Atend_Paciente_unidade(
			nr_atendimento, cd_setor_atendimento, cd_unidade_basica,
			cd_unidade_compl, dt_entrada_unidade, dt_atualizacao,
			nm_usuario, cd_tipo_acomodacao, dt_saida_unidade,
			nr_sequencia, nm_usuario_original, dt_saida_interno,
			ie_passagem_setor, nr_acompanhante, nr_seq_interno, IE_CALCULAR_DIF_DIARIA)
		SELECT
			nr_atendimento_p, cd_setor_atendimento_p, cd_unidade_basica,
			cd_unidade_compl, dt_passagem_w, clock_timestamp(),
			nm_usuario_p, cd_tipo_acomodacao, dt_passagem_w,
			nr_sequencia_w, nm_usuario_p, dt_passagem_w,
			'S', 0, nr_seq_interno_w, 'S'
		from	unidade_atendimento
		where	nr_seq_interno	= nr_seq_unidade_w;
		end;
	end if;

end if;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageserv_gerar_pass_setor_atend ( nr_atendimento_p bigint, cd_setor_atendimento_p bigint, dt_passagem_p timestamp, ie_cons_setor_usuario_p text, cd_unidade_basica_p text, nm_usuario_p text) FROM PUBLIC;

