-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_livro_aux_receb_mes ( cd_empresa_p bigint, cd_estabelecimento_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text, ie_criar_arquivo_p text) AS $body$
DECLARE

 
ds_titulo_w		varchar(1000);
ds_erro_w		varchar(255);
ds_local_w		varchar(255);
nm_arquivo_w		varchar(255);
ds_ato_cooperado_w	varchar(255);
qt_reg_ato_aux_w	bigint;
qt_reg_ato_princ_w	bigint;
arq_texto_w		utl_file.file_type;
cd_conta_contabil_w	conta_contabil.cd_conta_contabil%TYPE;
nr_contador_w		bigint;
nr_seq_titular_w	pls_segurado.nr_seq_titular%type;
nr_seq_contrato_w	pls_segurado.nr_seq_contrato%type;

cd_carteira_w		varchar(30);
nm_benef_princ_w	varchar(255);
nr_cpf_princ_w		varchar(255);
nm_beneficiario_w	varchar(255);
ds_regulamentacao_w	varchar(255);
ds_tipo_contratacao_w	varchar(255);

 
c_linha CURSOR FOR 
	SELECT	nr_titulo || ';' || 
		TO_CHAR(dt_emissao,'dd/mm/yyyy') || ';' || 
		TO_CHAR(dt_vencimento,'dd/mm/yyyy') || ';' || 
		nr_contrato || ';' || 
		cd_carteira || ';' || 
		nm_benef_princ || ';' || 
		nr_cpf_princ || ';' || 
		nm_beneficiario || ';' || 
		ds_modalidade || ';' || 
		ds_regulamentacao || ';' || 
		ds_tipo_contratacao || ';' || 
		ds_segmentacao || ';' || 
		ds_ato_cooperado || ';' || 
		TO_CHAR(dt_inicio_cobertura,'dd/mm/yyyy') || ';' || 
		TO_CHAR(dt_fim_cobertura,'dd/mm/yyyy') || ';' || 
		vl_contraprestacao || ';' || 
		vl_multa || ';' || 
		vl_juros || ';' || 
		(vl_contraprestacao + vl_multa + vl_juros) || ';' || 
		TO_CHAR(dt_recebimento,'dd/mm/yyyy') || ';' || 
		cd_classif_cred || ';' || 
		cd_classif_enc || ';' || 
		TO_CHAR(dt_contabilizacao,'dd/mm/yyyy') || ';' || 
		nr_lote_contabil ds_linha 
	FROM	w_ctb_livro_aux_receb_mes a 
	WHERE	a.nm_usuario	= nm_usuario_p 
	ORDER BY vl_contraprestacao DESC;

c_valores CURSOR FOR 
	SELECT	a.nr_titulo, 
		a.dt_emissao, 
		a.dt_pagamento_previsto dt_vencimento, 
		j.vl_lancamento vl_contraprestacao, 
		i.vl_multa, 
		i.vl_juros, 
		ctb_obter_classif_conta(j.cd_conta_credito, null, dt_final_p) cd_classif_cred, 
		d.dt_geracao_lote dt_contabilizacao, 
		b.nr_sequencia nr_seq_mensalidade, 
		d.nr_lote_contabil, 
		j.nr_seq_segurado, 
		(SELECT	max(substr(obter_valor_dominio(1665, f.ie_segmentacao),1,255)) 
		from	pls_plano f, 
			pls_mensalidade_segurado c 
		where	c.nr_seq_plano = f.nr_sequencia 
		and	b.nr_sequencia = c.nr_seq_mensalidade 
		and	c.nr_seq_segurado = j.nr_seq_segurado) ds_modalidade, 
		(select	max(substr(obter_valor_dominio(1669, f.ie_preco),1,255)) 
		from	pls_plano f, 
			pls_mensalidade_segurado c 
		where	c.nr_seq_plano = f.nr_sequencia 
		and	b.nr_sequencia = c.nr_seq_mensalidade 
		and	c.nr_seq_segurado = j.nr_seq_segurado) ds_segmentacao,		 
		(select	max(c.dt_inicio_cobertura) 
		from	pls_mensalidade_segurado c 
		where	b.nr_sequencia = c.nr_seq_mensalidade 
		and	c.nr_seq_segurado = j.nr_seq_segurado) dt_inicio_cobertura, 
		(select	max(c.dt_fim_cobertura) 
		from	pls_mensalidade_segurado c 
		where	b.nr_sequencia = c.nr_seq_mensalidade 
		and	c.nr_seq_segurado = j.nr_seq_segurado) dt_fim_cobertura, 
		i.dt_recebimento 
	from	pls_titulo_rec_liq_mens 	j, 
		titulo_receber_liq 		i, 
		lote_contabil			d, 
		pls_mensalidade			b, 
		titulo_receber			a 
	where	i.nr_lote_contabil	= d.nr_lote_contabil 
	and	i.nr_titulo		= j.nr_titulo 
	and	a.nr_titulo		= i.nr_titulo 
	and	a.nr_seq_mensalidade	= b.nr_sequencia 
	and	j.cd_conta_credito in (	select	distinct a.cd_conta_contabil 
					from	conta_contabil a 
					where	ie_tipo = 'A' 
					and	substr(ctb_obter_classif_conta(a.cd_conta_contabil, null, dt_final_p),1,5) = '1.2.3') 
	and	i.dt_recebimento between dt_inicial_p and dt_final_p 
	and	a.cd_estabelecimento = cd_estabelecimento_p 
	
union all
 
	SELECT	a.nr_titulo, 
		a.dt_emissao, 
		a.dt_pagamento_previsto dt_vencimento, 
		j.vl_recebido vl_contraprestacao, 
		i.vl_multa, 
		i.vl_juros, 
		ctb_obter_classif_conta(j.cd_conta_rec_pls, null, dt_final_p) cd_classif_cred, 
		d.dt_geracao_lote dt_contabilizacao, 
		b.nr_sequencia nr_seq_mensalidade, 
		d.nr_lote_contabil, 
		c.nr_sequencia, 
		substr(obter_valor_dominio(1665, f.ie_segmentacao),1,255) ds_modalidade, 
		substr(obter_valor_dominio(1669, f.ie_preco),1,255) ds_segmentacao,		 
		c.dt_inicio_cobertura, 
		c.dt_fim_cobertura, 
		i.dt_recebimento 
	FROM	titulo_rec_liq_cc 		j, 
		titulo_receber_liq 		i, 
		pessoa_fisica			h, 
		pls_contrato			g, 
		pls_plano			f, 
		pls_segurado			e, 
		lote_contabil			d, 
		pls_mensalidade_segurado	c, 
		pls_mensalidade			b, 
		titulo_receber			a 
	WHERE	i.nr_lote_contabil	= d.nr_lote_contabil 
	AND	i.nr_titulo		= j.nr_titulo 
	AND	a.nr_titulo		= i.nr_titulo 
	AND	e.cd_pessoa_fisica	= h.cd_pessoa_fisica 
	AND	c.nr_seq_contrato	= g.nr_sequencia 
	AND	c.nr_seq_plano		= f.nr_sequencia 
	AND	c.nr_seq_segurado	= e.nr_sequencia 
	AND	b.nr_sequencia		= c.nr_seq_mensalidade 
	AND	a.nr_seq_mensalidade	= b.nr_sequencia 
	AND	j.cd_conta_rec_pls in (	select	distinct a.cd_conta_contabil 
					from	conta_contabil a 
					where	ie_tipo = 'A' 
					and	substr(ctb_obter_classif_conta(a.cd_conta_contabil, null, dt_final_p),1,5) = '1.2.3') 
	AND	i.dt_recebimento BETWEEN dt_inicial_p AND dt_final_p 
	AND	a.cd_estabelecimento = cd_estabelecimento_p 
	and	not exists (select 1 from pls_titulo_rec_liq_mens x where x.nr_titulo = a.nr_titulo);
	
c_valores_w	c_valores%ROWTYPE;

BEGIN 
 
DELETE FROM w_ctb_livro_aux_receb_mes 
WHERE nm_usuario = nm_usuario_p;
COMMIT;
 
nr_contador_w := 0;
 
OPEN c_valores;
LOOP 
FETCH c_valores INTO 
	c_valores_w;
EXIT WHEN NOT FOUND; /* apply on c_valores */
	BEGIN 
	cd_carteira_w 		:= '';
	nm_benef_princ_w 	:= '';
	nr_cpf_princ_w 		:= '';
	nm_beneficiario_w 	:= '';
	ds_regulamentacao_w 	:= '';
	ds_tipo_contratacao_w 	:= '';
	nr_seq_contrato_w	:= '';	
 
	if (coalesce(c_valores_w.nr_seq_segurado,0) <> 0) then	 
		select	nr_seq_titular 
		into STRICT	nr_seq_titular_w 
		from	pls_segurado 
		where	nr_sequencia = c_valores_w.nr_seq_segurado;
		 
		if (coalesce(nr_seq_titular_w,0) <> 0) then 
			nm_benef_princ_w := substr(pls_obter_dados_segurado(c_valores_w.nr_seq_segurado,'NT'),1,255);
		else 
			nm_benef_princ_w := substr(pls_obter_dados_segurado(c_valores_w.nr_seq_segurado,'N'),1,255);
		end if;
		 
		select	max(b.nr_contrato) 
		into STRICT	nr_seq_contrato_w 
		from	pls_segurado	a, 
			pls_contrato	b 
		where	a.nr_seq_contrato	= b.nr_sequencia 
		and	a.nr_sequencia		= c_valores_w.nr_seq_segurado;
		 
		cd_carteira_w 		:= substr(pls_obter_dados_segurado(c_valores_w.nr_seq_segurado,'C'),1,30);
		nr_cpf_princ_w 		:= substr(pls_obter_dados_segurado(c_valores_w.nr_seq_segurado,'CPF'),1,255);
		nm_beneficiario_w 	:= substr(pls_obter_dados_segurado(c_valores_w.nr_seq_segurado,'N'),1,255);
		ds_regulamentacao_w 	:= substr(pls_obter_dados_segurado(c_valores_w.nr_seq_segurado,'RPL'),1,255);
		ds_tipo_contratacao_w 	:= substr(pls_obter_dados_segurado(c_valores_w.nr_seq_segurado,'TC'),1,255);
	end if;
	 
	SELECT	COUNT(*) 
	INTO STRICT	qt_reg_ato_princ_w 
	FROM	pls_mensalidade_seg_item i, 
		pls_mensalidade_segurado s 
	WHERE	nr_seq_mensalidade_seg = s.nr_sequencia 
	AND	s.nr_seq_mensalidade = c_valores_w.nr_seq_mensalidade 
	AND	i.vl_ato_cooperado != 0;
 
	SELECT	COUNT(*) 
	INTO STRICT	qt_reg_ato_aux_w 
	FROM	pls_mensalidade_seg_item i, 
		pls_mensalidade_segurado s 
	WHERE	nr_seq_mensalidade_seg = s.nr_sequencia 
	AND	s.nr_seq_mensalidade = c_valores_w.nr_seq_mensalidade 
	AND	i.vl_ato_auxiliar != 0;
 
	IF (qt_reg_ato_princ_w > 0) THEN 
		ds_ato_cooperado_w := obter_desc_expressao(778840);
	ELSIF (qt_reg_ato_aux_w > 0) THEN 
		ds_ato_cooperado_w := obter_desc_expressao(778842);
	END IF;
 
	nr_contador_w := nr_contador_w + 1;
	 
	INSERT INTO w_ctb_livro_aux_receb_mes(nm_usuario, 
		cd_estabelecimento, 
		dt_atualizacao, 
		dt_emissao, 
		dt_vencimento, 
		nr_contrato, 
		cd_carteira, 
		nm_benef_princ, 
		nr_cpf_princ, 
		nm_beneficiario, 
		ds_modalidade, 
		ds_regulamentacao, 
		ds_tipo_contratacao, 
		ds_segmentacao, 
		ds_ato_cooperado, 
		dt_inicio_cobertura, 
		dt_fim_cobertura, 
		vl_contraprestacao, 
		vl_multa, 
		vl_juros, 
		cd_classif_cred, 
		dt_contabilizacao, 
		nr_titulo, 
		nr_lote_contabil, 
		dt_recebimento) 
	VALUES (nm_usuario_p, 
		cd_estabelecimento_p, 
		clock_timestamp(), 
		c_valores_w.dt_emissao, 
		c_valores_w.dt_vencimento, 
		nr_seq_contrato_w, 
		cd_carteira_w, 
		nm_benef_princ_w, 
		nr_cpf_princ_w, 
		nm_beneficiario_w, 
		c_valores_w.ds_modalidade, 
		ds_regulamentacao_w, 
		ds_tipo_contratacao_w, 
		c_valores_w.ds_segmentacao, 
		ds_ato_cooperado_w, 
		c_valores_w.dt_inicio_cobertura, 
		c_valores_w.dt_fim_cobertura, 
		c_valores_w.vl_contraprestacao, 
		c_valores_w.vl_multa, 
		c_valores_w.vl_juros, 
		c_valores_w.cd_classif_cred, 
		c_valores_w.dt_contabilizacao, 
		c_valores_w.nr_titulo, 
		c_valores_w.nr_lote_contabil, 
		c_valores_w.dt_recebimento);
		 
	if (mod(nr_contador_w,1000) = 0) then 
		commit;
	end if;
	 
	END;
END LOOP;
CLOSE c_valores;
 
COMMIT;
 
IF (ie_criar_arquivo_p = 'S') THEN 
	BEGIN 
	nm_arquivo_w	:= obter_desc_expressao(292636) || ' 7 ' || TO_CHAR(clock_timestamp(),'ddmmyyyy') || TO_CHAR(clock_timestamp(),'hh24') || TO_CHAR(clock_timestamp(),'mi') || TO_CHAR(clock_timestamp(),'ss') || nm_usuario_p || '.csv';
 
	SELECT * FROM obter_evento_utl_file(1, NULL, ds_local_w, ds_erro_w) INTO STRICT ds_local_w, ds_erro_w;
 
	BEGIN 
	arq_texto_w := utl_file.fopen(ds_local_w,nm_arquivo_w,'W');
	EXCEPTION 
	WHEN OTHERS THEN 
		IF (SQLSTATE = -29289) THEN 
			ds_erro_w := wheb_mensagem_pck.get_texto(299140);
		ELSIF (SQLSTATE = -29298) THEN 
			ds_erro_w := wheb_mensagem_pck.get_texto(299142);
		ELSIF (SQLSTATE = -29291) THEN 
			ds_erro_w := wheb_mensagem_pck.get_texto(299144);
		ELSIF (SQLSTATE = -29286) THEN 
			ds_erro_w := wheb_mensagem_pck.get_texto(299147);
		ELSIF (SQLSTATE = -29282) THEN 
			ds_erro_w := wheb_mensagem_pck.get_texto(299148);
		ELSIF (SQLSTATE = -29288) THEN 
			ds_erro_w := wheb_mensagem_pck.get_texto(299149);
		ELSIF (SQLSTATE = -29287) THEN 
			ds_erro_w := wheb_mensagem_pck.get_texto(299150);
		ELSIF (SQLSTATE = -29281) THEN 
			ds_erro_w := wheb_mensagem_pck.get_texto(299151);
		ELSIF (SQLSTATE = -29290) THEN 
			ds_erro_w := wheb_mensagem_pck.get_texto(299152);
		ELSIF (SQLSTATE = -29283) THEN 
			ds_erro_w := wheb_mensagem_pck.get_texto(299154);
		ELSIF (SQLSTATE = -29280) THEN 
			ds_erro_w := wheb_mensagem_pck.get_texto(299155);
		ELSIF (SQLSTATE = -29284) THEN 
			ds_erro_w := wheb_mensagem_pck.get_texto(299156);
		ELSIF (SQLSTATE = -29292) THEN 
			ds_erro_w := wheb_mensagem_pck.get_texto(299157);
		ELSIF (SQLSTATE = -29285) THEN 
			ds_erro_w := wheb_mensagem_pck.get_texto(299158);
		ELSE 
			ds_erro_w := wheb_mensagem_pck.get_texto(299159);
		END IF;
 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(186768,'DS_ERRO_W=' || ds_erro_w);
	END;
 
	ds_titulo_w := SUBSTR(	'NR_TITULO' || ';' || 'DT_EMISSAO' || ';' ||	'DT_VENCIMENTO'|| ';' || 'NR_CONTRATO' || ';' || 'CD_CARTEIRA' || ';' || 'NM_BENEF_PRINC'|| ';' || 
				'NR_CPF_PRINC' || ';' || 'NM_BENEFICIARIO' || ';' || 'DS_MODALIDADE' || ';' || 'DS_REGULAMENTACAO' || ';' || 
				'DS_TIPO_CONTRATACAO' || ';' || 'DS_SEGMENTACAO' || ';' || 'DS_ATO_COOPERADO' || ';' || 'DT_INICIO_COBERTURA' || ';' || 
				'DT_FIM_COBERTURA' || ';' || 'VL_CONTRAPRESTACAO' || ';' || 'VL_MULTA' || ';' || 'VL_JUROS' || ';' || 'VL_TOTAL_RECEBIDO' || ';' || 
				'DT_RECEBIMENTO' || ';' || 'CD_CLASSIF_CRED' || ';' || 'CD_CLASSIF_ENC' || ';' || 
				'DT_CONTABILIZACAO'|| ';' || 'NR_LOTE_CONTABIL' ,1,1000);
 
	utl_file.put_line(arq_texto_w,ds_titulo_w);
 
	FOR vetl IN c_linha LOOP 
		BEGIN 
		utl_file.put_line(arq_texto_w,vetl.ds_linha);
		utl_file.fflush(arq_texto_w);
		END;
	END LOOP;
 
	END;
END IF;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_livro_aux_receb_mes ( cd_empresa_p bigint, cd_estabelecimento_p bigint, dt_inicial_p timestamp, dt_final_p timestamp, nm_usuario_p text, ie_criar_arquivo_p text) FROM PUBLIC;

