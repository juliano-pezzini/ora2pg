-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_criar_campos_essenciais () AS $body$
DECLARE


nm_tabela_w		varchar(50)	:= null;
ie_criar_alterar_w		varchar(001)	:= 0;
qt_registro_w		integer	:= 0;
ie_base_wheb_w		smallint		:= 0;
qt_processo_w		bigint	:= 0;
nm_user_w		varchar(20);
ds_sep_bv_w		varchar(10);
sid_w			bigint;
serial_w			bigint;
ds_erro_w		varchar(512);

/*Verifica os campos que estão documentados no dicionário e não estão na base*/

C01 CURSOR FOR
SELECT	distinct
		'A',
		a.nm_tabela,
		a.qt_registros_previsto
FROM	tabela_sistema a,
		tabela_atributo c,
		user_tables b
where	a.nm_tabela	= a.nm_tabela
and		c.nm_tabela	= a.nm_tabela
and		((a.nm_tabela = 'TABELA_SISTEMA') or (a.nm_tabela = 'TABELA_ATRIBUTO') or (a.nm_tabela = 'INDICE') or (a.nm_tabela = 'INDICE_ATRIBUTO') or (a.nm_tabela = 'INTEGRIDADE_REFERENCIAL') or (a.nm_tabela = 'INTEGRIDADE_REFERENCIAL_ATRIBUTO') or (a.nm_tabela = 'DIC_EXPRESSAO'))
and		gerar_objeto_aplicacao(a.ds_aplicacao) = 'S'
--and		a.ie_temporaria not in ('G','GD')
and		c.ie_tipo_atributo in ('LONG','LONG RAW','NUMBER','VARCHAR2','DATE','BLOB','CLOB')
and (1 = ie_base_wheb_w and a.ie_sincronizar_wheb = 'S' or 1 <> ie_base_wheb_w)
and	not exists (
			 SELECT 	1
		     from	user_tab_columns e
		     where	a.nm_tabela	= e.table_name
		     and	c.nm_atributo	= e.column_name);

/*Verifica os campos que estão documentados no dicionário e não estão corretos na base (tipo/tamanho/obrigatoriedade) */

C02 CURSOR FOR
SELECT	distinct
		'A',
		a.nm_tabela,
		a.qt_registros_previsto
from	tabela_sistema a,
		tabela_atributo b,
		user_tab_columns c
where	a.nm_tabela = b.nm_tabela
and		a.ie_sincronizar_wheb = 'S'
and		b.ie_tipo_atributo = 'VARCHAR2'
and		Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
and (1 = ie_base_wheb_w and a.ie_sincronizar_wheb = 'S' or 1 <> ie_base_wheb_w)
and		a.nm_tabela = c.table_name
and		c.table_name = b.nm_tabela
and		c.column_name = b.nm_atributo
and		c.data_type = b.ie_tipo_atributo
and		c.char_length <> b.qt_tamanho
and		((a.nm_tabela = 'TABELA_SISTEMA') or (a.nm_tabela = 'TABELA_ATRIBUTO') or (a.nm_tabela = 'INDICE') or (a.nm_tabela = 'INDICE_ATRIBUTO') or (a.nm_tabela = 'INTEGRIDADE_REFERENCIAL') or (a.nm_tabela = 'INTEGRIDADE_REFERENCIAL_ATRIBUTO') or (a.nm_tabela = 'DIC_EXPRESSAO'))

union

select	distinct
		'A',
		a.nm_tabela,
		a.qt_registros_previsto
from	tabela_sistema a,
		tabela_atributo b,
		user_tab_columns c
where	a.nm_tabela = b.nm_tabela
and		a.ie_sincronizar_wheb = 'S'
and		b.ie_tipo_atributo = 'NUMBER'
and		Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
and (1 = ie_base_wheb_w and a.ie_sincronizar_wheb = 'S' or 1 <> ie_base_wheb_w)
and		a.nm_tabela = c.table_name
and		c.table_name = b.nm_tabela
and		c.column_name = b.nm_atributo
and		c.data_type = b.ie_tipo_atributo
and (c.data_precision <> b.qt_tamanho or c.data_scale <> b.qt_decimais)
and		((a.nm_tabela = 'TABELA_SISTEMA') or (a.nm_tabela = 'TABELA_ATRIBUTO') or (a.nm_tabela = 'INDICE') or (a.nm_tabela = 'INDICE_ATRIBUTO') or (a.nm_tabela = 'INTEGRIDADE_REFERENCIAL') or (a.nm_tabela = 'INTEGRIDADE_REFERENCIAL_ATRIBUTO') or (a.nm_tabela = 'DIC_EXPRESSAO'))

union

select	distinct
		'A',
		a.nm_tabela,
		a.qt_registros_previsto
from	tabela_sistema a,
		tabela_atributo b,
		user_tab_columns c
where	a.nm_tabela = b.nm_tabela
and		b.ie_tipo_atributo = 'VARCHAR2'
and		Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
and (1 = ie_base_wheb_w and a.ie_sincronizar_wheb = 'S' or 1 <> ie_base_wheb_w)
and		a.nm_tabela = c.table_name
and		c.table_name = b.nm_tabela
and		c.column_name = b.nm_atributo
and		c.data_type = b.ie_tipo_atributo
and		c.char_length <> b.qt_tamanho
and		((a.nm_tabela = 'TABELA_SISTEMA') or (a.nm_tabela = 'TABELA_ATRIBUTO') or (a.nm_tabela = 'INDICE') or (a.nm_tabela = 'INDICE_ATRIBUTO') or (a.nm_tabela = 'INTEGRIDADE_REFERENCIAL') or (a.nm_tabela = 'INTEGRIDADE_REFERENCIAL_ATRIBUTO') or (a.nm_tabela = 'DIC_EXPRESSAO'))

union

select	distinct
		'A',
		a.nm_tabela,
		a.qt_registros_previsto
from	tabela_sistema a,
		tabela_atributo b,
		user_tab_columns c
where	a.nm_tabela = b.nm_tabela
and		b.ie_tipo_atributo = 'NUMBER'
and		Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
and (1 = ie_base_wheb_w and a.ie_sincronizar_wheb = 'S' or 1 <> ie_base_wheb_w)
and		a.nm_tabela = c.table_name
and		c.table_name = b.nm_tabela
and		c.column_name = b.nm_atributo
and		c.data_type = b.ie_tipo_atributo
and (c.data_precision <> b.qt_tamanho or c.data_scale <> b.qt_decimais)
and		((a.nm_tabela = 'TABELA_SISTEMA') or (a.nm_tabela = 'TABELA_ATRIBUTO') or (a.nm_tabela = 'INDICE') or (a.nm_tabela = 'INDICE_ATRIBUTO') or (a.nm_tabela = 'INTEGRIDADE_REFERENCIAL') or (a.nm_tabela = 'INTEGRIDADE_REFERENCIAL_ATRIBUTO') or (a.nm_tabela = 'DIC_EXPRESSAO'))

union

select distinct
	'A',
	a.nm_tabela,
	a.qt_registros_previsto
from	tabela_sistema a,
	tabela_atributo b,
	user_tab_columns c
where	a.nm_tabela = b.nm_tabela
and	Gerar_Objeto_Aplicacao(a.ds_aplicacao) = 'S'
and (1 = ie_base_wheb_w and a.ie_sincronizar_wheb = 'S' or 1 <> ie_base_wheb_w)
and	a.nm_tabela = c.table_name
and	c.table_name = b.nm_tabela
and	c.column_name = b.nm_atributo
and	c.nullable  = 'N'
and	b.ie_obrigatorio = 'N'
and		((a.nm_tabela = 'TABELA_SISTEMA') or (a.nm_tabela = 'TABELA_ATRIBUTO') or (a.nm_tabela = 'INDICE') or (a.nm_tabela = 'INDICE_ATRIBUTO') or (a.nm_tabela = 'INTEGRIDADE_REFERENCIAL') or (a.nm_tabela = 'INTEGRIDADE_REFERENCIAL_ATRIBUTO') or (a.nm_tabela = 'DIC_EXPRESSAO'));

c013 CURSOR FOR
	SELECT	a.SID,
		a.SERIAL#
	from    processo_lock_v a
	where	exists (SELECT	1
		from	TABELA_SISTEMA b
		where	b.nm_tabela = a.nm_objeto
		and	ie_sincronizar_wheb = 'S');


BEGIN
CALL wheb_usuario_pck.SET_IE_EXECUTAR_TRIGGER('N');

select	obter_separador_bv
into STRICT	ds_sep_bv_w
;

ie_base_wheb_w := obter_valor_dinamico_bv('select 1 from estabelecimento where cd_cgc = :cd_cgc and cd_estabelecimento = :cd_estabelecimento and ie_situacao = :ie_situacao', 'cd_cgc=01950338000177'||ds_sep_bv_w||'cd_estabelecimento=1'||ds_sep_bv_w||'ie_situacao=A', ie_base_wheb_w);

select	user
into STRICT	nm_user_w
;

if ( ie_base_wheb_w =  1 ) and ( nm_user_w <> 'TASY' ) then
	ie_base_wheb_w := 0;
end if;

if ( ie_base_wheb_w = 1) then

	-- Fernando
	OPEN C013;
	LOOP
	FETCH C013 INTO
		sid_w,
		serial_w;
	EXIT WHEN NOT FOUND; /* apply on C013 */
		CALL exec_sql_dinamico('','begin tasy_kill_session(' || sid_w || ',' || serial_w || '); end;');
	END LOOP;
	CLOSE C013;

end	if;

CALL gravar_processo_longo('Atualizar Versão','TASY_SINCRONIZAR_BASE',0);

begin
	SELECT	'A procedure VALIDA_OBJETOS_SISTEMA está em execução.'
|| chr(10) ||
		'A execução da procedure TASY_SINCRONIZAR_BASE foi cancelada!!!'
|| chr(10) ||
		'Programa   :' || program || chr(10) ||
		'Sid/Serial :' || sid || ',' || serial# || chr(10) ||
	   	'Usuário:' || osuser  || CHR(10) ||
	   	'Estação:' || machine
	INTO STRICT	ds_erro_w
	FROM 	v$session
	WHERE	audsid <> (SELECT userenv('sessionid') )
	AND	username = (select username from v$session where audsid = (select userenv('sessionid') ))
	AND	action like 'VALIDA_OBJETOS_SISTEMA%';
exception
when others then
	ds_erro_w := '';
end;

if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
	CALL gravar_processo_longo('','',0);
	CALL wheb_mensagem_pck.exibir_mensagem_abort(252210,'DS_ERRO_W='||DS_ERRO_W);
end if;

begin
	SELECT	'A procedure TASY_SINCRONIZAR_BASE ja está em execução.'
|| chr(10) ||
		'Programa   :' || program || chr(10) ||
		'Sid/Serial :' || sid || ',' || serial# || chr(10) ||
	   	'Usuário:' || osuser  || CHR(10) ||
	   	'Estação:' || machine
	INTO STRICT	ds_erro_w
	FROM 	v$session
	WHERE	audsid <> (SELECT userenv('sessionid') )
	AND	username = (select username from v$session where audsid = (select userenv('sessionid') ))
	AND	action like 'TASY_SINCRONIZAR_BASE%'
	OR 	action like 'TASY_AJUSTAR_COLUNAS%'
	OR	action like 'TASY_ALTERAR_COLUNA%'
	OR	action like 'TASY_CRIAR_INDICE%'
	OR	action like 'TASY_CRIAR_INTEGRIDADE%'
	OR	action like 'TASY_CRIAR_ALTERAR_TABELA%';
exception
when others then
	ds_erro_w := '';
end;

if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
	CALL gravar_processo_longo('','',0);
	CALL wheb_mensagem_pck.exibir_mensagem_abort(252210,'DS_ERRO_W='||DS_ERRO_W);
end if;

begin
	SELECT	'A procedure TASY_CONSISTIR_BASE está em execução. '
 || chr(10) ||
		'A execução da procedure TASY_SINCRONIZAR_BASE foi cancelada !!!'
 || chr(10) ||
		'Programa   :' || program || chr(10) ||
		'Sid/Serial :' || sid || ',' || serial# || chr(10) ||
	   	'Usuário:' || osuser  || CHR(10) ||
	   	'Estação:' || machine
	INTO STRICT	ds_erro_w
	FROM 	v$session
	WHERE	audsid <> (SELECT userenv('sessionid') )
	AND	username = (select username from v$session where audsid = (select userenv('sessionid') ))
	AND	action like 'TASY_CONSISTIR_BASE%';
exception
when others then
	ds_erro_w := '';
end;

if (ds_erro_w IS NOT NULL AND ds_erro_w::text <> '') then
	CALL gravar_processo_longo('','',null);
	CALL wheb_mensagem_pck.exibir_mensagem_abort(252210,'DS_ERRO_W='||DS_ERRO_W);
end if;

qt_processo_w := qt_processo_w + 1;
CALL gravar_processo_longo('Verificando novos campos serem criados','TASY_CRIAR_CAMPOS_ESSENCIAIS',qt_processo_w);
	OPEN C01;
	LOOP
		FETCH C01 INTO
			ie_criar_alterar_w,
			nm_tabela_w,
			qt_registro_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
		CALL Tasy_Criar_Alterar_Tabela(nm_tabela_w, ie_criar_alterar_w, nm_user_w);
	END LOOP;
	CLOSE C01;

qt_processo_w := qt_processo_w + 1;
CALL gravar_processo_longo('Verificando novos campos serem alterados','TASY_CRIAR_CAMPOS_ESSENCIAIS',qt_processo_w);
	OPEN C02;
	LOOP
		FETCH C02 INTO
			ie_criar_alterar_w,
			nm_tabela_w,
			qt_registro_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
		CALL Tasy_Criar_Alterar_Tabela(nm_tabela_w, ie_criar_alterar_w, nm_user_w);
	END LOOP;
	CLOSE C02;

COMMIT;
CALL wheb_usuario_pck.SET_IE_EXECUTAR_TRIGGER('S');
CALL gravar_processo_longo('','',0);

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_criar_campos_essenciais () FROM PUBLIC;

