-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qt_copiar_prot_oncologia ( CD_PROTOCOLO_P bigint, NR_SEQUENCIA_P bigint, NR_SEQ_PAC_P bigint, NM_USUARIO_P text) AS $body$
DECLARE

 
ie_gerar_dose_w			varchar(1) := 'N';
cd_estabelecimento_w	smallint;
qt_registro_null_w		smallint;
qt_idade_w				bigint;
cd_pessoa_fisica_w		numeric(20);
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
cd_convenio_w			bigint;
nr_seq_proc_ww			bigint;

 
C01 CURSOR FOR 
	SELECT	* 
	from	PROTOCOLO_MEDIC_PROC 
	where	CD_PROTOCOLO = CD_PROTOCOLO_P 
	AND	NR_SEQUENCIA = NR_SEQUENCIA_P 
	and	(DS_DIAS_APLICACAO IS NOT NULL AND DS_DIAS_APLICACAO::text <> '');
	
c01_w c01%rowtype;

					 

BEGIN 
 
select	coalesce(max(cd_estabelecimento),0), 
		max(cd_pessoa_fisica) 
into STRICT	cd_estabelecimento_w, 
	cd_pessoa_fisica_w 
from	paciente_setor_sim 
where	nr_sequencia = nr_seq_pac_p;
 
if (cd_estabelecimento_w > 0) then 
	ie_gerar_dose_w := obter_param_usuario(281, 330, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_gerar_dose_w);
end if;
 
select 	max(a.cd_convenio) 
into STRICT	cd_convenio_w 
from	paciente_setor_convenio a, 
	paciente_setor b 
where 	b.cd_protocolo		= cd_protocolo_p 
and  	b.cd_pessoa_fisica   = cd_pessoa_fisica_w 
and  	a.nr_seq_paciente 	= b.nr_seq_paciente;
 
select	count(*) 
into STRICT	qt_registro_null_w 
from 	protocolo_medic_material 
where	cd_protocolo = cd_protocolo_p 
and	nr_sequencia = nr_sequencia_p 
and	coalesce(nr_seq_diluicao::text, '') = '' 
and	ie_agrupador = 1 
and	coalesce(ds_dias_aplicacao::text, '') = '';
 
if (qt_registro_null_w > 0) then 
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(264154);
end if;	
 
qt_idade_w := (obter_idade_pf(cd_pessoa_fisica_w,clock_timestamp(),'A'));
 
insert into paciente_prot_medic_sim(NR_SEQ_PACIENTE, 
	NR_SEQ_MATERIAL, 
	CD_MATERIAL, 
	QT_DOSE, 
--	CD_UNIDADE_MEDIDA, 
	DS_DIAS_APLICACAO, 
	DT_ATUALIZACAO, 
	NM_USUARIO, 
	NR_AGRUPAMENTO, 
	DS_RECOMENDACAO, 
--	IE_VIA_APLICACAO, 
	NR_SEQ_DILUICAO, 
	QT_MIN_APLICACAO, 
	IE_BOMBA_INFUSAO, 
	CD_INTERVALO, 
	QT_HORA_APLICACAO, 
--	QT_DIAS_UTIL, 
--	NR_SEQ_INTERNO, 
--	IE_SE_NECESSARIO, 
--	IE_APLIC_LENTA,     
--	IE_URGENCIA,       
--	IE_APLIC_BOLUS, 
--	ie_pre_medicacao, 
--	IE_ALERTA_VIA_ADM, 
	DS_CICLOS_APLICACAO) 
--	CD_PROTOCOLO, 
--	NR_SEQ_MEDICACAO, 
--	IE_APLICA_REDUCAO) 
SELECT 	NR_SEQ_PAC_P, 
	NR_SEQ_MATERIAL, 
	CD_MATERIAL, 
	coalesce(obter_dose_regra_protocolo(cd_protocolo,nr_seq_material,nr_sequencia,qt_idade_w),QT_DOSE), 
--	CD_UNIDADE_MEDIDA, 
	DS_DIAS_APLICACAO, 
	clock_timestamp(), 
	NM_USUARIO_P, 
	NR_AGRUPAMENTO, 
	DS_RECOMENDACAO, 
--	IE_VIA_APLICACAO, 
	NR_SEQ_DILUICAO, 
	QT_MINUTO_APLICACAO, 
	IE_BOMBA_INFUSAO, 
	CD_INTERVALO, 
	QT_HORA_APLICACAO, 
--	QT_DIAS_UTIL, 
--	PACIENTE_PROTOCOLO_MEDIC_SEQ.NEXTVAL, 
--	IE_SE_NECESSARIO, 
--	IE_APLIC_LENTA,     
--	IE_URGENCIA,       
--	IE_APLIC_BOLUS, 
--	ie_pre_medicacao, 
--	IE_ALERTA_VIA_ADM, 
	DS_CICLOS_APLICACAO 
--	CD_PROTOCOLO_P, 
--	NR_SEQUENCIA_P, 
--	nvl(IE_APLICA_REDUCAO,'S') 
FROM 	PROTOCOLO_MEDIC_MATERIAL 
WHERE	CD_PROTOCOLO = CD_PROTOCOLO_P 
 AND	NR_SEQUENCIA = NR_SEQUENCIA_P 
 AND	coalesce(NR_SEQ_DILUICAO::text, '') = '' 
 and	coalesce(nr_seq_solucao::text, '') = '' 
 AND	IE_AGRUPADOR = 1;
 --AND	'S' = OBTER_PERMICAO_CONV_MEDIC(cd_convenio_w,nr_sequencia,cd_protocolo,nr_seq_material);; 
 
INSERT INTO paciente_prot_medic_sim( 
	NR_SEQ_PACIENTE, 
	NR_SEQ_MATERIAL, 
	CD_MATERIAL, 
	qt_dose, 
--	CD_UNIDADE_MEDIDA, 
	DS_DIAS_APLICACAO, 
	DT_ATUALIZACAO, 
	NM_USUARIO, 
	NR_AGRUPAMENTO, 
	DS_RECOMENDACAO, 
--	IE_VIA_APLICACAO, 
	NR_SEQ_DILUICAO, 
	QT_MIN_APLICACAO, 
--	IE_BOMBA_INFUSAO, 
	CD_INTERVALO, 
	QT_HORA_APLICACAO) 
	--QT_DIAS_UTIL) 
--	NR_SEQ_INTERNO, 
--	IE_SE_NECESSARIO, 
--	IE_APLIC_LENTA,     
--	IE_URGENCIA,       
--	IE_APLIC_BOLUS, 
--	ie_pre_medicacao, 
--	CD_PROTOCOLO) 
--	NR_SEQ_MEDICACAO, 
--	ie_agrupador, 
--	IE_APLICA_REDUCAO) 
SELECT 	NR_SEQ_PAC_P, 
	B.NR_SEQ_MATERIAL, 
	B.CD_MATERIAL, 
	B.QT_DOSE, 
--	B.CD_UNIDADE_MEDIDA, 
	coalesce(B.DS_DIAS_APLICACAO, A.DS_DIAS_APLICACAO), 
	clock_timestamp(), 
	NM_USUARIO_P, 
	B.NR_AGRUPAMENTO, 
	B.DS_RECOMENDACAO, 
--	B.IE_VIA_APLICACAO, 
	B.NR_SEQ_DILUICAO, 
	B.QT_MINUTO_APLICACAO, 
--	B.IE_BOMBA_INFUSAO, 
	B.CD_INTERVALO, 
	B.QT_HORA_APLICACAO 
--	B.QT_DIAS_UTIL, 
--	PACIENTE_PROTOCOLO_MEDIC_SEQ.NEXTVAL, 
--	B.IE_SE_NECESSARIO, 
--	B.IE_APLIC_LENTA,     
--	B.IE_URGENCIA,       
--	B.IE_APLIC_BOLUS, 
--	b.ie_pre_medicacao, 
--	CD_PROTOCOLO_P 
--	NR_SEQUENCIA_P, 
--	b.ie_Agrupador, 
--	nvl(a.IE_APLICA_REDUCAO,'S') 
FROM 	PROTOCOLO_MEDIC_MATERIAL B, 
	PROTOCOLO_MEDIC_MATERIAL A 
WHERE 	A.CD_PROTOCOLO = CD_PROTOCOLO_P 
 AND	A.NR_SEQUENCIA = NR_SEQUENCIA_P 
 AND 	A.CD_PROTOCOLO = B.CD_PROTOCOLO 
 AND 	A.NR_SEQUENCIA = B.NR_SEQUENCIA 
 AND 	B.NR_SEQ_DILUICAO = A.NR_SEQ_MATERIAL 
 AND	B.IE_AGRUPADOR IN (3,7,9) 
 --AND	'S' = OBTER_PERMICAO_CONV_MEDIC(cd_convenio_w,b.nr_sequencia,b.cd_protocolo,b.nr_seq_material) 
 and	exists (	select	1 
			from	PACIENTE_PROT_MEDIC_sim x 
			where	x.nr_seq_paciente	= NR_SEQ_PAC_P 
			and	x.nr_seq_material	= b.nr_seq_diluicao);
  
open C01;
loop 
fetch C01 into	 
	c01_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	 
	cd_procedimento_w	:= c01_w.cd_procedimento;
	ie_origem_proced_w	:= c01_w.ie_origem_proced;
	 
	if (c01_w.nr_seq_proc_interno IS NOT NULL AND c01_w.nr_seq_proc_interno::text <> '') then 
		SELECT * FROM obter_proc_tab_interno(	c01_w.nr_seq_proc_interno, null, null, null, cd_procedimento_w, ie_origem_proced_w, null, null) INTO STRICT cd_procedimento_w, ie_origem_proced_w;
					 
		 
	end if;
	 
	select	coalesce(max(nr_seq_procedimento),0) +1 
	into STRICT	nr_seq_proc_ww 
	from	paciente_prot_proc_sim 
	where	nr_seq_paciente	= NR_SEQ_PAC_P;
	 
	insert into paciente_prot_proc_sim( 
		NR_SEQ_PACIENTE, 
		NR_SEQ_PROCEDIMENTO, 
		CD_PROCEDIMENTO,  
		IE_ORIGEM_PROCED, 
	--	QT_PROCEDIMENTO,    
		DS_DIAS_APLICACAO, 
		DT_ATUALIZACAO,   
		NM_USUARIO,     
		DT_ATUALIZACAO_NREC, 
		CD_INTERVALO,  
		NM_USUARIO_NREC, 
		NR_AGRUPAMENTO) 
	--	IE_SE_NECESSARIO, 
	--	IE_ACM,    
	--	NR_SEQ_PROC_INTERNO, 
	--	IE_LADO, 
	--	cd_protocolo_adic, 
	--	NR_SEQ_MEDICACAO_ADIC) 
	values (NR_SEQ_PAC_P, 
		nr_seq_proc_ww, 
		--c01_w.nr_seq_proc, 
		cd_procedimento_w, 
		ie_origem_proced_w, 
	--	c01_w.qt_procedimento, 
		c01_w.DS_DIAS_APLICACAO, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		c01_w.cd_intervalo, 
		nm_usuario_p, 
		c01_w.nr_seq_proc);
	--	c01_w.ie_se_necessario, 
	--	c01_w.ie_acm, 
	--	c01_w.nr_seq_proc_interno, 
	--	c01_w.ie_lado, 
	---	CD_PROTOCOLO_P, 
	--	NR_SEQUENCIA_P); 
	 
	 
	 
	 
	end;
end loop;
close C01;
  
 INSERT INTO paciente_prot_soluc_sim( 
	NR_SEQ_PACIENTE, 
	NR_SEQ_SOLUCAO, 
	NR_AGRUPAMENTO, 
	DS_DIAS_APLICACAO, 
	DT_ATUALIZACAO, 
	NM_USUARIO, 
	DT_ATUALIZACAO_NREC, 
	NM_USUARIO_NREC, 
--	IE_TIPO_DOSAGEM, 
--	QT_DOSAGEM, 
--	QT_SOLUCAO_TOTAL, 
	QT_TEMPO_APLICACAO, 
--	NR_ETAPAS, 
--	IE_BOMBA_INFUSAO, 
	IE_ESQUEMA_ALTERNADO, 
	IE_CALC_AUT, 
	IE_ACM, 
--	QT_HORA_FASE, 
	DS_SOLUCAO, 
--	DS_ORIENTACAO, 
--	IE_SE_NECESSARIO, 
--	IE_SOLUCAO_PCA, 
--	IE_TIPO_ANALGESIA, 
--	IE_PCA_MODO_PROG, 
--	QT_DOSE_INICIAL_PCA, 
--	QT_VOL_INFUSAO_PCA, 
--	QT_BOLUS_PCA, 
--	QT_INTERVALO_BLOQUEIO, 
--	QT_LIMITE_QUATRO_HORA, 
--	QT_DOSE_ATAQUE, 
--	IE_TIPO_SOL, 
	DS_CICLOS_APLICACAO) 
--	cd_protocolo_adic, 
--	nr_seq_medicacao_adic, 
--	ie_pre_medicacao) 
SELECT	NR_SEQ_PAC_P, 
	NR_SEQ_SOLUCAO, 
	NR_AGRUPAMENTO, 
	DS_DIAS_APLICACAO, 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
--	IE_TIPO_DOSAGEM, 
--	QT_DOSAGEM, 
--	QT_SOLUCAO_TOTAL, 
	QT_TEMPO_APLICACAO,  
--	NR_ETAPAS, 
--	IE_BOMBA_INFUSAO, 
	IE_ESQUEMA_ALTERNADO, 
	IE_CALC_AUT, 
	IE_ACM, 
--	QT_HORA_FASE, 
	DS_SOLUCAO, 
--	DS_ORIENTACAO, 
--	IE_SE_NECESSARIO, 
--	IE_SOLUCAO_PCA, 
--	IE_TIPO_ANALGESIA, 
--	IE_PCA_MODO_PROG, 
--	QT_DOSE_INICIAL_PCA, 
--	QT_VOL_INFUSAO_PCA, 
--	QT_BOLUS_PCA, 
--	QT_INTERVALO_BLOQUEIO, 
--	QT_LIMITE_QUATRO_HORA, 
--	QT_DOSE_ATAQUE, 
--	IE_TIPO_SOL, 
	DS_CICLOS_APLICACAO 
--	CD_PROTOCOLO_P, 
--	NR_SEQUENCIA_P, 
--	ie_pre_medicacao 
from	PROTOCOLO_MEDIC_SOLUCAO 
where	CD_PROTOCOLO = CD_PROTOCOLO_P 
 AND	NR_SEQUENCIA = NR_SEQUENCIA_P 
and	(DS_DIAS_APLICACAO IS NOT NULL AND DS_DIAS_APLICACAO::text <> '');	
 
INSERT INTO paciente_prot_medic_sim( 
	NR_SEQ_PACIENTE, 
	NR_SEQ_MATERIAL, 
	CD_MATERIAL, 
	qt_dose, 
--	CD_UNIDADE_MEDIDA, 
	DS_DIAS_APLICACAO, 
	DT_ATUALIZACAO, 
	NM_USUARIO, 
	NR_AGRUPAMENTO, 
	DS_RECOMENDACAO, 
--	IE_VIA_APLICACAO, 
	NR_SEQ_SOLUCAO, 
	QT_MIN_APLICACAO, 
--	IE_BOMBA_INFUSAO, 
	CD_INTERVALO, 
	QT_HORA_APLICACAO) 
--	QT_DIAS_UTIL, 
--	NR_SEQ_INTERNO, 
--	IE_SE_NECESSARIO, 
--	IE_APLIC_LENTA,     
--	IE_URGENCIA,       
--	IE_APLIC_BOLUS, 
--	ie_pre_medicacao, 
--	IE_APLICA_REDUCAO) 
SELECT 	NR_SEQ_PAC_P, 
	B.NR_SEQ_MATERIAL, 
	B.CD_MATERIAL, 
	B.QT_DOSE, 
--	B.CD_UNIDADE_MEDIDA, 
	coalesce(B.DS_DIAS_APLICACAO, A.DS_DIAS_APLICACAO), 
	clock_timestamp(), 
	NM_USUARIO_P, 
	B.NR_AGRUPAMENTO, 
	B.DS_RECOMENDACAO, 
--	B.IE_VIA_APLICACAO, 
	B.NR_SEQ_SOLUCAO, 
	B.QT_MINUTO_APLICACAO, 
--	B.IE_BOMBA_INFUSAO, 
	B.CD_INTERVALO, 
	B.QT_HORA_APLICACAO 
--	B.QT_DIAS_UTIL, 
--	PACIENTE_PROTOCOLO_MEDIC_SEQ.NEXTVAL, 
--	B.IE_SE_NECESSARIO, 
--	B.IE_APLIC_LENTA,     
--	B.IE_URGENCIA,       
--	B.IE_APLIC_BOLUS, 
--	b.ie_pre_medicacao, 
--	nvl(IE_APLICA_REDUCAO,'S') 
FROM 	PROTOCOLO_MEDIC_MATERIAL B, 
	PROTOCOLO_MEDIC_SOLUCAO A 
WHERE 	A.CD_PROTOCOLO = CD_PROTOCOLO_P 
 AND	A.NR_SEQUENCIA = NR_SEQUENCIA_P 
 AND 	A.CD_PROTOCOLO = B.CD_PROTOCOLO 
 AND 	A.NR_SEQUENCIA = B.NR_SEQUENCIA 
 AND 	B.NR_SEQ_SOLUCAO = A.NR_SEQ_SOLUCAO 
 and	(a.DS_DIAS_APLICACAO IS NOT NULL AND a.DS_DIAS_APLICACAO::text <> '') 
 AND	B.IE_AGRUPADOR IN (4);
 --AND	'S' = OBTER_PERMICAO_CONV_MEDIC(cd_convenio_w,b.nr_sequencia,b.cd_protocolo,b.nr_seq_material); 
  
  
  
/*if	(ie_gerar_dose_w = 'S') then 
	atualizar_dose_onc_protocolo(nr_seq_pac_p); 
end if;*/
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qt_copiar_prot_oncologia ( CD_PROTOCOLO_P bigint, NR_SEQUENCIA_P bigint, NR_SEQ_PAC_P bigint, NM_USUARIO_P text) FROM PUBLIC;

