-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_movto_conta_transit ( nr_lote_contabil_p bigint, cd_estabelecimento_p bigint, cd_conta_contabil_p text, cd_historico_p bigint, ds_complemento_p text, nr_documento_p text, dt_contabil_p timestamp, vl_contabil_p bigint, ie_debito_credito_p text, ie_origem_documento_p bigint default null, nr_seq_agrupamento_p bigint default null, nr_seq_movimento_p INOUT bigint DEFAULT NULL, nr_seq_proj_rec_p bigint default null) AS $body$
DECLARE


cd_tipo_lote_contabil_w			lote_contabil.cd_tipo_lote_contabil%type;
nr_sequencia_w				w_movimento_contabil.nr_sequencia%type;
ds_compl_historico_w			w_movimento_contabil.ds_compl_historico%type;
ds_erro_w				varchar(4000);
ie_pos_atrib_compl_w			bigint;
qt_hist_w				bigint;
nr_seq_agrupamento_w			w_movimento_contabil.nr_seq_agrupamento%type;

BEGIN

begin

nr_seq_agrupamento_w	:=	coalesce(nr_seq_agrupamento_p,somente_numero(substr(nr_documento_p,1,10)));

select	max(cd_tipo_lote_contabil)
into STRICT	cd_tipo_lote_contabil_w
from	lote_contabil
where	nr_lote_contabil = nr_lote_contabil_p;

ie_pos_atrib_compl_w	:= position('#@' in ds_complemento_p);
ds_compl_historico_w	:= substr(nr_documento_p,1,255);

select	count(*)
into STRICT	qt_hist_w
from	historico_padrao_atributo c,
	historico_padrao b
where	b.cd_historico		= c.cd_historico
and	b.cd_historico		= cd_historico_p;

if (coalesce(ie_pos_atrib_compl_w,0) > 0) and (qt_hist_w > 0) then
	ds_compl_historico_w	:= substr(obter_compl_historico(cd_tipo_lote_contabil_w, cd_historico_p, ds_complemento_p),1,255);
end if;

nr_seq_movimento_p := coalesce(nr_seq_movimento_p,0) + 1;

insert 	into w_movimento_contabil(
	nr_lote_contabil,
	nr_sequencia,
	cd_conta_contabil,
	ie_debito_credito,
	cd_historico,
	dt_movimento,
	vl_movimento,
	cd_estabelecimento,
	ds_doc_agrupamento,
	nr_seq_agrupamento, 	
	ds_compl_historico,
	nr_documento,
	ie_transitorio,
	ie_origem_documento,
	nr_seq_proj_rec)
values (	nr_lote_contabil_p,
	nr_seq_movimento_p,
	cd_conta_contabil_p,
	ie_debito_credito_p,
	cd_historico_p,
	dt_contabil_p,
	vl_contabil_p,
	cd_estabelecimento_p,
	substr(nr_documento_p,1,50),
	nr_seq_agrupamento_w,
	ds_compl_historico_w,
	substr(nr_documento_p,1,20),
	'S',
	ie_origem_documento_p,
	nr_seq_proj_rec_p);
exception when others then
	ds_erro_w	:= SQLERRM(SQLSTATE);
	CALL wheb_mensagem_pck.exibir_mensagem_abort(266452,'CTA='|| cd_conta_contabil_p || ';DOC=' || nr_documento_p || ';' ||
					'SEQ=' || nr_sequencia_w || ';VAL=' || vl_contabil_p || ';' ||
					'DS_ERRO_W=' || DS_ERRO_W);
end;


END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_movto_conta_transit ( nr_lote_contabil_p bigint, cd_estabelecimento_p bigint, cd_conta_contabil_p text, cd_historico_p bigint, ds_complemento_p text, nr_documento_p text, dt_contabil_p timestamp, vl_contabil_p bigint, ie_debito_credito_p text, ie_origem_documento_p bigint default null, nr_seq_agrupamento_p bigint default null, nr_seq_movimento_p INOUT bigint DEFAULT NULL, nr_seq_proj_rec_p bigint default null) FROM PUBLIC;

