-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE hp_retorno_convenio_cassi ( nr_seq_retorno_p text) AS $body$
DECLARE

 
ie_tipo_registro_w		varchar(255);
nr_conta_w       	bigint;
cd_prestador_w     	varchar(255);
dt_atendimento_w        	varchar(255);
nm_beneficiario_w        	varchar(255);
cd_item_w        	bigint;
ds_item_retorno_w       	varchar(255);
qt_paga_w        	varchar(255);
vl_pago_w        	double precision;
vl_glosa_w       	double precision;
cd_motivo_glosa_w    	varchar(255);
cd_procedimento_w	bigint;
cd_material_w		bigint;
vl_cobrado_conta_w	double precision;
qt_cobrada_conta_w	bigint;
nr_guia_mat_w		bigint;
nr_seq_movto_w		bigint;
nr_seq_movto_ant_w	bigint;
nr_seq_mat_conta_w	bigint;

c01 CURSOR FOR 
SELECT	obter_valor_campo_separador(ds_conteudo,1, ';') ie_tipo_registro, 
	obter_valor_campo_separador(ds_conteudo,3, ';') conta, 
	obter_valor_campo_separador(ds_conteudo,4, ';') dt_atend, 
	obter_valor_campo_separador(ds_conteudo,6, ';') nm_beneficiario, 
	somente_numero(obter_valor_campo_separador(ds_conteudo,7, ';')) cd_item, 
	obter_valor_campo_separador(ds_conteudo,9, ';') ds_item_retorno, 
	obter_valor_campo_separador(ds_conteudo,10, ';') qt_paga, 
	(obter_valor_campo_separador(ds_conteudo,13, ';'))::numeric  vl_pago, 
	(obter_valor_campo_separador(ds_conteudo,12, ';'))::numeric  vl_glosa, 
	'' 
from	w_conv_ret_movto 
where	obter_valor_campo_separador(ds_conteudo,1, ';')	= 'G' 
and	nr_seq_retorno					= nr_seq_retorno_p 
and	position('.' in obter_valor_campo_separador(ds_conteudo,7, ';')) = 0 /*lhalves OS344061 em 24/10/11-Segundo o cliente, se tiver o '.' deve ignorar o item*/ 

union all
 
SELECT	obter_valor_campo_separador(ds_conteudo,1, ';') ie_tipo_registro, 
	'', 
	'', 
	'', 
	somente_numero(obter_valor_campo_separador(ds_conteudo,3, ';')) cd_item, 
	obter_valor_campo_separador(ds_conteudo,4, ';') ds_item_retorno, 
	obter_valor_campo_separador(ds_conteudo,9, ';') qt_paga, 
	(obter_valor_campo_separador(ds_conteudo,10, ';'))::numeric  vl_pago, 
	(obter_valor_campo_separador(ds_conteudo,8, ';'))::numeric  vl_glosa, 
	obter_valor_campo_separador(ds_conteudo,13, ';') cd_motivo_glosa 
from	w_conv_ret_movto 
where	obter_valor_campo_separador(ds_conteudo,1, ';')	= 'M' 
and	nr_seq_retorno					= nr_seq_retorno_p;


BEGIN 
 
open c01;
loop 
fetch c01 into 
	ie_tipo_registro_w, 
	nr_conta_w, 
	dt_atendimento_w, 
	nm_beneficiario_w, 
	cd_item_w, 
	ds_item_retorno_w, 
	qt_paga_w, 
	vl_pago_w, 
	vl_glosa_w, 
	cd_motivo_glosa_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	nr_seq_mat_conta_w	:= null;
	cd_procedimento_w	:= null;
	cd_material_w		:= null;
 
	if (ie_tipo_registro_w = 'M') then	 
 
		select	max(obter_valor_campo_separador(ds_conteudo,2, ';')) nr_guia 
		into STRICT	nr_guia_mat_w 
		from	w_conv_ret_movto 
		where	obter_valor_campo_separador(ds_conteudo,1, ';')	= 'M' 
		and	nr_seq_retorno					= nr_seq_retorno_p;
 
		select	max(somente_numero(obter_valor_campo_separador(ds_conteudo,3, ';'))) nr_conta 
		into STRICT	nr_conta_w 
		from	w_conv_ret_movto 
		where	obter_valor_campo_separador(ds_conteudo,1, ';')	= 'G' 
		and	obter_valor_campo_separador(ds_conteudo,2, ';')	= nr_guia_mat_w 
		and	nr_seq_retorno					= nr_seq_retorno_p;
 
	end if;
 
	select	coalesce(max(cd_procedimento),0), 
		max(substr(obter_desc_prescr_proc_exam(cd_procedimento,ie_origem_proced,nr_seq_proc_interno, nr_seq_exame),1,255)) 
	into STRICT	cd_procedimento_w, 
		ds_item_retorno_w 
	from	procedimento_paciente 
	where	nr_interno_conta					= somente_numero(nr_conta_w) 
	and	coalesce(cd_procedimento_convenio, cd_procedimento)	= cd_item_w;
 
	if (coalesce(cd_procedimento_w,0) = 0) then 
	 
		select	coalesce(max(cd_procedimento),0), 
			max(substr(obter_desc_prescr_proc_exam(cd_procedimento,ie_origem_proced,nr_seq_proc_interno, nr_seq_exame),1,255)) 
		into STRICT	cd_procedimento_w, 
			ds_item_retorno_w 
		from	procedimento_paciente 
		where	nr_interno_conta		= somente_numero(nr_conta_w) 
		and	cd_procedimento_tuss	= cd_item_w;
 
	end if;
 
	if (coalesce(cd_procedimento_w,0) > 0) then 
 
		select	sum(vl_procedimento), 
			sum(a.qt_procedimento) 
		into STRICT	vl_cobrado_conta_w, 
			qt_cobrada_conta_w 
		from	procedimento_paciente a 
		where	cd_procedimento	= somente_numero(cd_procedimento_w) 
		and	a.nr_interno_conta	= somente_numero(nr_conta_w);
 
	else	-- se nÃ£o encontrar procedimento, tenta localizar como material 
 
		select	coalesce(max(cd_material),0), 
			max(substr(obter_desc_material(cd_material),1,100)), 
			max(nr_sequencia) 
		into STRICT	cd_material_w, 
			ds_item_retorno_w, 
			nr_seq_mat_conta_w 
		from	material_atend_paciente 
		where	nr_interno_conta				= somente_numero(nr_conta_w) 
		and	coalesce(cd_material_convenio,cd_material)		= cd_item_w 
		and	coalesce(cd_motivo_exc_conta::text, '') = '';	
		 
		if (cd_material_w = 0) then 
	 
			select	coalesce(max(cd_material),0), 
				max(substr(obter_desc_material(cd_material),1,100)), 
				max(nr_sequencia) 
			into STRICT	cd_material_w, 
				ds_item_retorno_w, 
				nr_seq_mat_conta_w 
			from	material_atend_paciente 
			where	nr_interno_conta	= somente_numero(nr_conta_w) 
			and	cd_material_tiss	= cd_item_w;
 
		end if;
		 
		if (coalesce(nr_seq_mat_conta_w::text, '') = '') then 
 
			if (coalesce(cd_material_w,0) > 0) then 
	 
				select	sum(vl_material), 
					sum(a.qt_material) 
				into STRICT	vl_cobrado_conta_w, 
					qt_cobrada_conta_w 
				from	material_atend_paciente a 
				where	coalesce(coalesce(cd_material_tiss, cd_material_convenio), cd_material)	= cd_material_w 
				and	a.nr_interno_conta						= somente_numero(nr_conta_w);
				 
			end if;
		else 
			select	sum(vl_material), 
				sum(a.qt_material) 
			into STRICT	vl_cobrado_conta_w, 
				qt_cobrada_conta_w 
			from	material_atend_paciente a 
			where	a.cd_material	= 
						(SELECT	cd_material 
						from	material_atend_paciente 
						where	nr_sequencia	= nr_seq_mat_conta_w) 
			and	nr_interno_conta	= somente_numero(nr_conta_w);
		 
		end if;	
 
	end if;
		 
	select	max(nr_sequencia) 
	into STRICT	nr_seq_movto_ant_w 
	from	convenio_retorno_movto 
	where	nr_seq_retorno	= nr_seq_retorno_p 
	and	cd_item		= coalesce(coalesce(cd_procedimento_w,cd_material_w),cd_item_w) 
	and	nr_conta	= somente_numero(nr_conta_w);
	 
	if (coalesce(nr_seq_movto_ant_w, 0) > 0) then		 
	 
		if (ie_tipo_registro_w = 'G') then 
		 
			update	convenio_retorno_movto 
			set	vl_pago		= vl_pago + coalesce(vl_pago_w,0), 
				vl_total_pago	= vl_total_pago + coalesce(vl_pago_w,0), 
				qt_paga		= qt_paga + coalesce((somente_numero(qt_paga_w)),0), 
				vl_glosa	= vl_glosa + coalesce(vl_glosa_w,0) 
			where	nr_sequencia	= nr_seq_movto_ant_w;
		else 
		 
			update	convenio_retorno_movto 
			set	vl_pago		= vl_pago + coalesce(vl_pago_w,0), 
				vl_total_pago	= vl_total_pago + coalesce(vl_pago_w,0), 
				qt_paga		= qt_paga + coalesce((somente_numero(qt_paga_w)),0), 
				vl_glosa	= vl_glosa + ((vl_glosa_w)::numeric /100) 
			where	nr_sequencia	= nr_seq_movto_ant_w;
		end if;	
		 
	else 
 
		if (coalesce(cd_procedimento_w,0) > 0) or (coalesce(cd_material_w,0) > 0) then 
 
			if (ie_tipo_registro_w = 'G') then 
 
				insert into convenio_retorno_movto(nr_sequencia, 
					dt_atualizacao, 
					nm_usuario, 
					nr_conta, 
					cd_prestador, 
					dt_execucao, 
					ds_complemento, 
					cd_item, 
					ds_item_retorno, 
					qt_paga, 
					vl_pago, 
					vl_glosa, 
					nr_seq_retorno, 
					vl_cobrado, 
					qt_cobrada, 
					vl_total_pago) 
				values(	nextval('convenio_retorno_movto_seq'), 
					clock_timestamp(), 
					'Tasy', 
					nr_conta_w, 
					somente_numero(cd_prestador_w), 
					to_date(dt_atendimento_w,'dd/mm/yy'), 
					nm_beneficiario_w, 
					coalesce(cd_procedimento_w,cd_material_w), 
					ds_item_retorno_w, 
					(somente_numero(qt_paga_w)), 
					coalesce(vl_pago_w,0), 
					coalesce(vl_glosa_w,0), 
					nr_seq_retorno_p, 
					vl_cobrado_conta_w, 
					qt_cobrada_conta_w, 
					coalesce(vl_pago_w,0));
			else 
 
				select	nextval('convenio_retorno_movto_seq') 
				into STRICT	nr_seq_movto_w 
				;
 
				insert into convenio_retorno_movto(nr_sequencia, 
					dt_atualizacao, 
					nm_usuario, 
					cd_item, 
					ds_item_retorno, 
					qt_paga, 
					vl_pago, 
					vl_glosa, 
					nr_seq_retorno, 
					vl_cobrado, 
					qt_cobrada, 
					nr_conta, 
					vl_total_pago) 
				values(	nr_seq_movto_w, 
					clock_timestamp(), 
					'Tasy', 
					coalesce(cd_material_w,cd_item_w), 
					ds_item_retorno_w, 
					(somente_numero(qt_paga_w)), 
					coalesce(vl_pago_w,0), 
					((vl_glosa_w)::numeric /100), 
					nr_seq_retorno_p, 
					vl_cobrado_conta_w, 
					qt_cobrada_conta_w, 
					nr_conta_w, 
					coalesce(vl_pago_w,0));
		 
			end if;
 
		end if;	-- se localizou material ou procedimento com o cd_item_w 
	
	end if;
 
end loop;
close c01;
 
delete	from w_conv_ret_movto 
where	nr_seq_retorno = nr_seq_retorno_p;
 
commit;
 
end	;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE hp_retorno_convenio_cassi ( nr_seq_retorno_p text) FROM PUBLIC;

