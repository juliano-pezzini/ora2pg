-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_origem_medicamento ( nr_seq_origem_p bigint, nr_prescricao_p bigint, nr_seq_material_p bigint, ie_atualiza_composto_p text, ie_atualiza_diluicao_p text, ie_atualiza_kit_p text, nm_usuario_p text, ie_medic_paciente_p text default 'S') AS $body$
DECLARE


cd_motivo_baixa_w	bigint;
nr_agrupamento_w	double precision;


BEGIN

if (nr_seq_origem_p > 0) then
	begin
	select	max(cd_motivo_baixa)
	into STRICT	cd_motivo_baixa_w
	from	origem_medic_paciente
	where	nr_sequencia	= nr_seq_origem_p;

	update	prescr_material
	set	ie_medicacao_paciente	= ie_medic_paciente_p,
		nr_seq_origem_medic	= nr_seq_origem_p,
		cd_motivo_baixa		= cd_motivo_baixa_w
	where  	nr_prescricao         	= nr_prescricao_p
	and    	nr_sequencia          	= nr_seq_material_p;

	select	max(nr_agrupamento)
	into STRICT	nr_agrupamento_w
	from	prescr_material
	where	nr_prescricao         	= nr_prescricao_p
	and	nr_sequencia          	= nr_seq_material_p;

	if (ie_atualiza_composto_p	= 'S') then
		update	prescr_material
		set	ie_medicacao_paciente	= ie_medic_paciente_p,
			nr_seq_origem_medic	= nr_seq_origem_p,
			cd_motivo_baixa		= cd_motivo_baixa_w
		where	nr_prescricao         	= nr_prescricao_p
		and    	nr_agrupamento		= nr_agrupamento_w;
	end if;

	if (ie_atualiza_diluicao_p	= 'S') then
		update	prescr_material
		set	ie_medicacao_paciente	= ie_medic_paciente_p,
			nr_seq_origem_medic	= nr_seq_origem_p,
			cd_motivo_baixa		= cd_motivo_baixa_w
		where	nr_prescricao         	= nr_prescricao_p
		and    	nr_sequencia_diluicao	= nr_seq_material_p
		and	ie_agrupador		in (3,7,9);
	end if;

	if (ie_atualiza_kit_p	= 'S') then
		update	prescr_material
		set	ie_medicacao_paciente	= ie_medic_paciente_p,
			nr_seq_origem_medic	= nr_seq_origem_p,
			cd_motivo_baixa		= cd_motivo_baixa_w
		where	nr_prescricao         	= nr_prescricao_p
		and    	nr_seq_kit		= nr_seq_material_p;
	end if;
	end;
else
	begin
	update	prescr_material
	set	ie_medicacao_paciente	= ie_medic_paciente_p,
		nr_seq_origem_medic	 = NULL,
		cd_motivo_baixa		= 0,
		ie_regra_disp		= 'S'
	where  	nr_prescricao         	= nr_prescricao_p
	and    	nr_sequencia          	= nr_seq_material_p;

	select	max(nr_agrupamento)
	into STRICT	nr_agrupamento_w
	from	prescr_material
	where	nr_prescricao         	= nr_prescricao_p
	and	nr_sequencia          	= nr_seq_material_p;

	if (ie_atualiza_composto_p	= 'S') then
		update	prescr_material
		set	ie_medicacao_paciente	= ie_medic_paciente_p,
			nr_seq_origem_medic	 = NULL,
			cd_motivo_baixa		= 0,
			ie_regra_disp		= 'S'
		where	nr_prescricao         	= nr_prescricao_p
		and    	nr_agrupamento		= nr_agrupamento_w;
	end if;

	if (ie_atualiza_diluicao_p	= 'S') then
		update	prescr_material
		set	ie_medicacao_paciente	= ie_medic_paciente_p,
			nr_seq_origem_medic	 = NULL,
			cd_motivo_baixa		= 0,
			ie_regra_disp		= 'S'
		where	nr_prescricao         	= nr_prescricao_p
		and    	nr_sequencia_diluicao	= nr_seq_material_p
		and	ie_agrupador		in (3,7,9);
	end if;

	if (ie_atualiza_kit_p	= 'S') then
		update	prescr_material
		set	ie_medicacao_paciente	= ie_medic_paciente_p,
			nr_seq_origem_medic	 = NULL,
			cd_motivo_baixa		= 0,
			ie_regra_disp		= 'S'
		where	nr_prescricao         	= nr_prescricao_p
		and    	nr_seq_kit		= nr_seq_material_p;
	end if;
	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_origem_medicamento ( nr_seq_origem_p bigint, nr_prescricao_p bigint, nr_seq_material_p bigint, ie_atualiza_composto_p text, ie_atualiza_diluicao_p text, ie_atualiza_kit_p text, nm_usuario_p text, ie_medic_paciente_p text default 'S') FROM PUBLIC;

