-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tasy_versao_alterar_coluna ( nm_tabela_p text, nm_atributo_p text, ie_tipo_atributo_p text, qt_tamanho_p bigint, qt_decimais_p bigint, ie_obrigatorio_p text, vl_default_p text, ie_enterprise_p text, nr_ordem_p bigint, ie_paralelism_p boolean default false) AS $body$
DECLARE

ds_comando_w	   	varchar(255);
ds_comando_count_w 	varchar(255);
qt_registro_w		bigint;
vl_default_w		varchar(50);
ds_atributo_w		varchar(50);
nm_fase_w           cloud_upgrade_log.nm_fase_atualizacao%type := 'TASY_VERSAO_ALTERAR_COLUNA';
nm_paralelism_w     varchar(1000);

qt_controle_w		bigint;


BEGIN
	vl_default_w	:= vl_default_p;
	qt_controle_w	:= 0;

	/*Comando abaixo SOMENTE ser√° executado para tabelas do SHIFT+F11*/

	if (vl_default_w IS NOT NULL AND vl_default_w::text <> '') then
		begin
		ds_comando_count_w := 'select count(*) from ' || nm_tabela_p || ' where ' || nm_atributo_p || ' is null';
		CALL gravar_processo_longo(ds_comando_w,'TASY_ALTERAR_COLUNA',null);
		qt_registro_w := obter_valor_dinamico(ds_comando_count_w, qt_registro_w);
		if ( qt_registro_w < 5000) then
			ds_comando_w	:= 'Update ' || nm_tabela_p || ' set ' || nm_atributo_p || ' = ';
			if (ie_tipo_atributo_p = 'VARCHAR2') then
				ds_comando_w	:= ds_comando_w  || chr(39) || vl_default_w || chr(39);
			else
				if (upper(vl_default_w) = '@ESTAB') then
					select min(cd_estabelecimento)
					into STRICT vl_default_w
					from estabelecimento;
				elsif (upper(vl_default_w) = '@EMPRESA') then
					select min(cd_empresa)
					into STRICT vl_default_w
					from empresa;
				end if;
				ds_comando_w	:= ds_comando_w  || vl_default_w;
			end if;
			ds_comando_w	:= ds_comando_w  || ' where ' || nm_atributo_p || ' is null ';
			ds_comando_w	:= ds_comando_w  || ' and rownum < 5000 ';
			CALL gravar_processo_longo('INSERINDO VALOR PADRAO PARA ('|| nm_tabela_p ||'('||nm_atributo_p||'))','TASY_ALTERAR_COLUNA',null);
			--Exec_Sql_Dinamico(nm_tabela_p || ',' || nm_atributo_p, ds_comando_w);
			insert into TABELA_VERSAO_OFFLINE_W(nr_sequencia, nr_ordem, ds_comando) values (nextval('tabela_versao_offline_w_seq'),nr_ordem_p,ds_comando_w);
			commit;
            CALL insert_log_cloud(null,null, 'atualizacao', nm_fase_w||'_LOG', null, nm_fase_w);
			qt_controle_w := qt_controle_w + 1;
		end if;
		end;
	end if;

	ds_comando_w	:= 'Alter Table ' || nm_tabela_p || ' MODIFY ' || nm_atributo_p;

	if (ie_obrigatorio_p = 'N') then
		ds_comando_w	:= ds_comando_w || ' null';
	else
		ds_comando_w 	:= ds_comando_w ||' not null';
	end if;

	if (ie_enterprise_p = 'S') then
        if (ie_paralelism_p) then
            nm_paralelism_w := ' PARALLEL ';
        end if;
		ds_comando_w	:= ds_comando_w  || nm_paralelism_w;
	end if;	

	CALL gravar_processo_longo(ds_comando_w,'TASY_ALTERAR_COLUNA',null);

	insert into TABELA_VERSAO_OFFLINE_W(nr_sequencia, nr_ordem, ds_comando) values (nextval('tabela_versao_offline_w_seq'),nr_ordem_p,ds_comando_w);
	commit;
    CALL insert_log_cloud(null,null, 'atualizacao', nm_fase_w||'_LOG', null, nm_fase_w);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tasy_versao_alterar_coluna ( nm_tabela_p text, nm_atributo_p text, ie_tipo_atributo_p text, qt_tamanho_p bigint, qt_decimais_p bigint, ie_obrigatorio_p text, vl_default_p text, ie_enterprise_p text, nr_ordem_p bigint, ie_paralelism_p boolean default false) FROM PUBLIC;

