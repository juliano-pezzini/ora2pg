-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE intpd_gravar_log_alteracao ( nm_tabela_p text, nm_atributo_p text, ds_valor_old_p text, ds_valor_new_p text, ds_chave_p text, nr_seq_log_atual_p INOUT bigint) AS $body$
DECLARE


intpd_fila_w		gerar_int_padrao.t_intpd_fila;
intpd_reg_alteracao_w	intpd_reg_alteracao%rowtype;
nr_seq_reg_alter_w	intpd_reg_alteracao.nr_sequencia%type;
intpd_reg_alter_fila_w	intpd_reg_alter_fila%rowtype;

i			integer;

C01 CURSOR FOR
SELECT	*
from	intpd_reg_alter_fila
where	sid = intpd_reg_alteracao_w.sid
and	serial = intpd_reg_alteracao_w.serial
and	coalesce(nr_seq_reg_alter::text, '') = '';

c01_w	C01%rowtype;

C02 CURSOR FOR
SELECT	b.nr_seq_fila
from	intpd_reg_alteracao a,
	intpd_reg_alter_fila b,
	intpd_fila_transmissao c
where	a.nr_sequencia  = b.nr_seq_reg_alter
and	b.nr_seq_fila = c.nr_sequencia
and	c.ie_status <> 'S'
and	a.nm_tabela = intpd_reg_alteracao_w.nm_tabela
and	a.ds_chave = intpd_reg_alteracao_w.ds_chave
group by b.nr_seq_fila;

c02_w c02%rowtype;

C03 CURSOR FOR
SELECT	a.nr_sequencia
from	intpd_reg_alteracao a	
where	not exists (	SELECT 1
		from	intpd_reg_alter_fila x
		where	x.nr_seq_reg_alter = a.nr_sequencia
		and	(x.nr_seq_fila IS NOT NULL AND x.nr_seq_fila::text <> ''))
and	a.nm_tabela = intpd_reg_alteracao_w.nm_tabela
and	a.ds_chave = intpd_reg_alteracao_w.ds_chave;

c03_w	c03%rowtype;


BEGIN

if	((coalesce(gerar_int_padrao.get_gravar_log_alter_campo,'S') = 'S') and (gerar_int_padrao.get_executando_recebimento = 'N')) then
	begin
	if (coalesce(nr_seq_log_atual_p::text, '') = '') then	
		select	nextval('intpd_reg_alteracao_seq')
		into STRICT	nr_seq_log_atual_p
		;
		
		begin
		select	sid,	
			serial#
		into STRICT	intpd_reg_alteracao_w.sid,
			intpd_reg_alteracao_w.serial
		from	v$session
		where	audsid = (SELECT userenv('sessionid') );		
		exception
		when others then
			intpd_reg_alteracao_w.sid	:=	null;
			intpd_reg_alteracao_w.serial	:=	null;
		end;
		
		intpd_reg_alteracao_w.nr_sequencia	:=	nr_seq_log_atual_p;
		intpd_reg_alteracao_w.dt_atualizacao	:=	clock_timestamp();
		intpd_reg_alteracao_w.nm_tabela		:=	upper(nm_tabela_p);
		intpd_reg_alteracao_w.ds_chave		:=	upper(ds_chave_p);
		
		insert into intpd_reg_alteracao values (intpd_reg_alteracao_w.*);
		
		open C01;
		loop
		fetch C01 into	
			c01_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			begin	
			update	intpd_reg_alter_fila
			set	nr_seq_reg_alter = nr_seq_log_atual_p
			where	nr_sequencia = c01_w.nr_sequencia;
			
			select	*
			into STRICT	intpd_reg_alter_fila_w
			from	intpd_reg_alter_fila
			where	nr_sequencia = c01_w.nr_sequencia;
			
			open C03;
			loop
			fetch C03 into	
				c03_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin
				select	nextval('intpd_reg_alter_fila_seq')
				into STRICT	intpd_reg_alter_fila_w.nr_sequencia
				;
				
				intpd_reg_alter_fila_w.nr_seq_reg_alter	:=	c03_w.nr_sequencia;
				intpd_reg_alter_fila_w.nr_seq_fila	:=	c01_w.nr_seq_fila;
				intpd_reg_alter_fila_w.sid		:=	intpd_reg_alteracao_w.sid;
				intpd_reg_alter_fila_w.serial		:=	intpd_reg_alteracao_w.serial;
				
				insert into intpd_reg_alter_fila values (intpd_reg_alter_fila_w.*);
				end;
			end loop;
			close C03;
			end;
		end loop;
		close C01;

		if (coalesce(c01_w.nr_sequencia::text, '') = '') then				
			open C02;
			loop
			fetch C02 into	
				c02_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin
				intpd_reg_alter_fila_w			:=	null;
				intpd_reg_alter_fila_w.nr_seq_reg_alter	:=	nr_seq_log_atual_p;
				intpd_reg_alter_fila_w.nr_seq_fila	:=	c02_w.nr_seq_fila;
				intpd_reg_alter_fila_w.sid		:=	intpd_reg_alteracao_w.sid;
				intpd_reg_alter_fila_w.serial		:=	intpd_reg_alteracao_w.serial;
				
				select	nextval('intpd_reg_alter_fila_seq')
				into STRICT	intpd_reg_alter_fila_w.nr_sequencia
				;
				
				insert into intpd_reg_alter_fila values (intpd_reg_alter_fila_w.*);
				end;
			end loop;
			close C02;
		end if;
	end if;
	
	if	((coalesce(ds_valor_old_p::text, '') = '') and (ds_valor_new_p IS NOT NULL AND ds_valor_new_p::text <> '')) or
		((coalesce(ds_valor_new_p::text, '') = '') and (ds_valor_old_p IS NOT NULL AND ds_valor_old_p::text <> '')) or (ds_valor_old_p <> ds_valor_new_p) then

		insert into intpd_reg_alter_campo(
			nr_sequencia,
			nm_atributo,
			ds_valor_old,
			ds_valor_new)
		values (	nr_seq_log_atual_p,
			nm_atributo_p,
			ds_valor_old_p,
			ds_valor_new_p);
	end if;
	end;	
end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE intpd_gravar_log_alteracao ( nm_tabela_p text, nm_atributo_p text, ds_valor_old_p text, ds_valor_new_p text, ds_chave_p text, nr_seq_log_atual_p INOUT bigint) FROM PUBLIC;

