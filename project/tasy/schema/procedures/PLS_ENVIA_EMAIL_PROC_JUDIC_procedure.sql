-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_envia_email_proc_judic ( nr_sequencia_p pls_proc_jud_hist_email.nr_sequencia%type, cd_estabelecimento_p pls_proc_jud_hist_email.cd_estabelecimento%type, nm_usuario_p pls_proc_jud_hist_email.nm_usuario%type) AS $body$
DECLARE


c01 CURSOR FOR
SELECT 	his.ds_assunto,
	his.ds_email_destino, 
	his.ds_email
from 	pls_proc_jud_hist_email his
where 	his.nr_sequencia = nr_sequencia_p;

ds_email_origem_w varchar(100) := obter_valor_param_usuario(1337,11,Obter_Perfil_Ativo,nm_usuario_p,cd_estabelecimento_p);

BEGIN

-- pega os dados do e-mail e faz o envio
for r01 in c01 loop

	-- se nao tiver e-mail configurado, busca o padrao do usuario
	if coalesce(ds_email_origem_w::text, '') = '' then
		select	max(ds_email)
		into STRICT	ds_email_origem_w
		from	usuario
		where	nm_usuario = nm_usuario_p;
	end if;
	
	-- envia o e-mail de acordo com o registro salvo
	CALL enviar_email(	ds_assunto_p       	=> r01.ds_assunto,
			ds_mensagem_p      	=> r01.ds_email,
			ds_email_origem_p  	=> ds_email_origem_w,
			ds_email_destino_p 	=> r01.ds_email_destino,
			nm_usuario_p       	=> nm_usuario_p,
			ie_prioridade_p    	=> 'A');

end loop;

update 	pls_proc_jud_hist_email his
set 	his.dt_envio = clock_timestamp()
where 	his.nr_sequencia = nr_sequencia_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_envia_email_proc_judic ( nr_sequencia_p pls_proc_jud_hist_email.nr_sequencia%type, cd_estabelecimento_p pls_proc_jud_hist_email.cd_estabelecimento%type, nm_usuario_p pls_proc_jud_hist_email.nm_usuario%type) FROM PUBLIC;

