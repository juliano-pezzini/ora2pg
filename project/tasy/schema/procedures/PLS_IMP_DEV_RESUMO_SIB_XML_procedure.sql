-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_imp_dev_resumo_sib_xml ( nr_seq_lote_sib_p bigint, ie_tipo_info_p text, ---------------------------------------------------------------- 
 nm_arquivo_p text, ---------------------------------------------------------------- 
 qt_inclusao_total_p bigint default null, qt_inclusao_processado_p bigint default null, qt_inclusao_recusado_p bigint default null, pr_inclusao_acerto_p bigint default null, qt_alteracao_total_p bigint default null, qt_alteracao_processado_p bigint default null, qt_alteracao_recusado_p bigint default null, pr_alteracao_acerto_p bigint default null, qt_exclusao_total_p bigint default null, qt_exclusao_processado_p bigint default null, qt_exclusao_recusado_p bigint default null, pr_exclusao_acerto_p bigint default null, qt_reinclusao_total_p bigint default null, qt_reinclusao_processado_p bigint default null, qt_reinclusao_recusado_p bigint default null, pr_reinclusao_acerto_p bigint default null, qt_total_p bigint default null, qt_processados_p bigint default null, qt_recusados_p bigint default null, pr_total_p bigint default null, qt_retificacao_total_p bigint default null, qt_retificacao_processado_p bigint default null, qt_retificacao_recusado_p bigint default null, pr_retificacao_acerto_p bigint default null, qt_sem_movto_total_p bigint default null, qt_sem_movto_processado_p bigint default null, qt_sem_movto_recusado_p bigint default null, pr_sem_movto_acerto_p bigint default null, ---------------------------------------------------------------- 
 cd_mensagem_p text DEFAULT NULL, ds_mensagem_erro_p text DEFAULT NULL, qt_ocorrencia_mensagem_p bigint default null, ---------------------------------------------------------------- 
 cd_estabelecimento_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL) AS $body$
DECLARE

			 
/*ie_tipo_info_p 
C - Cabe√ßalho 
P - Processdados 
M - Mensagens*/
 
 
nr_seq_devolucao_resumo_w	bigint;
cd_cgc_operadora_w		varchar(255);
nm_operadora_w			varchar(255);
nr_operadora_w			bigint;
-------------------------------------------------------------------------------- 
qt_inclusao_total_w		bigint;
qt_inclusao_processado_w	bigint;
pr_inclusao_w			double precision;

qt_alteracao_total_w		bigint;
qt_alteracao_processado_w	bigint;
pr_alteracao_w			double precision;

qt_retificacao_total_w		bigint;
qt_retificacao_processado_w	bigint;
pr_retificacao_w		double precision;

qt_exclusao_total_w		bigint;
qt_exclusao_processado_w	bigint;
pr_exclusao_w			double precision;

qt_reinclusao_total_w		bigint;
qt_reinclusao_processado_w	bigint;
pr_reinclusao_w			double precision;

qt_total_w			bigint;
qt_processados_w		bigint;
pr_total_w			double precision;

qt_sem_movto_total_w		bigint;
qt_sem_movto_processado_w	bigint;
pr_sem_movto_w			double precision;


BEGIN 
 
if (ie_tipo_info_p = 'C') then 
 
	select	max(nr_sequencia) 
	into STRICT	nr_seq_devolucao_resumo_w 
	from	sib_devolucao_resumo 
	where	nr_seq_lote	= nr_seq_lote_sib_p 
	and	ie_tipo_item	= 'C' 
	and	ie_xml		= 'S';
	 
	if (coalesce(nr_seq_devolucao_resumo_w::text, '') = '') then 
	 
		select	substr(pls_obter_dados_outorgante(cd_estabelecimento_p,'C'),1,255), 
			substr(pls_obter_dados_outorgante(cd_estabelecimento_p,'N'),1,255) 
		into STRICT	cd_cgc_operadora_w, 
			nm_operadora_w 
		;
		 
		begin 
		nr_operadora_w		:= substr(nm_arquivo_p,1,7);
		exception 
		when others then 
				nr_operadora_w	:= null;
		end;
	 
		insert into sib_devolucao_resumo(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec, 
				nr_seq_lote,ie_tipo_item,ie_xml,nr_operadora,cd_cgc_operadora,ds_razao_social,nm_arquivo) 
		values (	nextval('sib_devolucao_resumo_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p, 
				nr_seq_lote_sib_p,'C','S',nr_operadora_w,cd_cgc_operadora_w,nm_operadora_w,nm_arquivo_p);
	end if;
elsif (ie_tipo_info_p = 'P') then 
	select	max(nr_sequencia) 
	into STRICT	nr_seq_devolucao_resumo_w 
	from	sib_devolucao_resumo 
	where	nr_seq_lote	= nr_seq_lote_sib_p 
	and	ie_tipo_item	= 'P' 
	and	ie_xml		= 'S';
	 
	if (coalesce(nr_seq_devolucao_resumo_w::text, '') = '') then 
		insert into sib_devolucao_resumo(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec, 
				nr_seq_lote,ie_tipo_item,ie_xml,qt_inclusao_total,qt_inclusao_processado, 
				qt_inclusao_recusado,pr_inclusao_acerto,qt_alteracao_total,qt_alteracao_processado,qt_alteracao_recusado, 
				pr_alteracao_acerto,qt_exclusao_total,qt_exclusao_processado,qt_exclusao_recusado,pr_exclusao_acerto,  
				qt_reinclusao_total,qt_reinclusao_processado,qt_reinclusao_recusado,pr_reinclusao_acerto,qt_total, 
				qt_processados,qt_recusados,pr_total,qt_retificacao_total,qt_retificacao_processado, 
				qt_retificacao_recusado,pr_retificacao_acerto,qt_sem_movto_total,qt_sem_movto_processado,qt_sem_movto_recusado, 
				pr_sem_movto_acerto) 
		values (	nextval('sib_devolucao_resumo_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p, 
				nr_seq_lote_sib_p,'P','S',qt_inclusao_total_p,qt_inclusao_processado_p, 
				qt_inclusao_recusado_p,pr_inclusao_acerto_p,qt_alteracao_total_p,qt_alteracao_processado_p,qt_alteracao_recusado_p, 
				pr_alteracao_acerto_p,qt_exclusao_total_p,qt_exclusao_processado_p,qt_exclusao_recusado_p,pr_exclusao_acerto_p,  
				qt_reinclusao_total_p,qt_reinclusao_processado_p,qt_reinclusao_recusado_p,pr_reinclusao_acerto_p,qt_total_p, 
				qt_processados_p,qt_recusados_p,pr_total_p,qt_retificacao_total_p,qt_retificacao_processado_p, 
				qt_retificacao_recusado_p,pr_retificacao_acerto_p,qt_sem_movto_total_p,qt_sem_movto_processado_p,qt_sem_movto_recusado_p, 
				pr_sem_movto_acerto_p);
	else 
		update	sib_devolucao_resumo 
		set	qt_inclusao_total		= qt_inclusao_total + coalesce(qt_inclusao_total_p,0), 
			qt_inclusao_processado		= qt_inclusao_processado + coalesce(qt_inclusao_processado_p,0), 
			qt_inclusao_recusado		= qt_inclusao_recusado + coalesce(qt_inclusao_recusado_p,0), 
			qt_alteracao_total		= qt_alteracao_total + coalesce(qt_alteracao_total_p,0), 
			qt_alteracao_processado		= qt_alteracao_processado + coalesce(qt_alteracao_processado_p,0), 
			qt_alteracao_recusado		= qt_alteracao_recusado + coalesce(qt_alteracao_recusado_p,0), 
			qt_exclusao_total		= qt_exclusao_total + coalesce(qt_exclusao_total_p,0), 
			qt_exclusao_processado		= qt_exclusao_processado + coalesce(qt_exclusao_processado_p,0), 
			qt_exclusao_recusado		= qt_exclusao_recusado + coalesce(qt_exclusao_recusado_p,0), 
			qt_reinclusao_total		= qt_reinclusao_total + coalesce(qt_reinclusao_total_p,0), 
			qt_reinclusao_processado	= qt_reinclusao_processado + coalesce(qt_reinclusao_processado_p,0), 
			qt_reinclusao_recusado		= qt_reinclusao_recusado + coalesce(qt_reinclusao_recusado_p,0), 
			qt_total			= qt_total + coalesce(qt_total_p,0), 
			qt_processados			= qt_processados + coalesce(qt_processados_p,0), 
			qt_recusados			= qt_recusados + coalesce(qt_recusados_p,0), 
			qt_retificacao_total		= qt_retificacao_total + coalesce(qt_retificacao_total_p,0), 
			qt_retificacao_processado	= qt_retificacao_processado + coalesce(qt_retificacao_processado_p,0) , 
			qt_retificacao_recusado		= qt_retificacao_recusado + coalesce(qt_retificacao_recusado_p,0), 
			qt_sem_movto_total		= qt_sem_movto_total + coalesce(qt_sem_movto_total_p,0), 
			qt_sem_movto_processado		= qt_sem_movto_processado + coalesce(qt_sem_movto_processado_p,0), 
			qt_sem_movto_recusado		= qt_sem_movto_recusado + coalesce(qt_sem_movto_recusado_p,0) 
		where	nr_sequencia			= nr_seq_devolucao_resumo_w;
		 
		select	qt_inclusao_total, 
			qt_inclusao_processado, 
			qt_retificacao_total, 
			qt_retificacao_processado, 
			qt_exclusao_total, 
			qt_exclusao_processado, 
			qt_reinclusao_total, 
			qt_reinclusao_processado, 
			qt_total, 
			qt_processados, 
			qt_sem_movto_total, 
			qt_sem_movto_processado, 
			qt_alteracao_total, 
			qt_alteracao_processado 
		into STRICT	qt_inclusao_total_w, 
			qt_inclusao_processado_w, 
			qt_retificacao_total_w, 
			qt_retificacao_processado_w, 
			qt_exclusao_total_w, 
			qt_exclusao_processado_w, 
			qt_reinclusao_total_w, 
			qt_reinclusao_processado_w, 
			qt_total_w, 
			qt_processados_w, 
			qt_sem_movto_total_w, 
			qt_sem_movto_processado_w, 
			qt_alteracao_total_w, 
			qt_alteracao_processado_w 
		from	sib_devolucao_resumo 
		where	nr_sequencia	= nr_seq_devolucao_resumo_w;
 
		if (qt_inclusao_processado_w <> 0) then 
			pr_inclusao_w	:= (qt_inclusao_processado_w*100)/qt_inclusao_total_w;
		else 
			pr_inclusao_w	:= 0;
		end if;
		 
		if (qt_alteracao_processado_w <> 0) then 
			pr_alteracao_w	:= (qt_alteracao_processado_w*100)/qt_alteracao_total_w;
		else 
			pr_alteracao_w	:= 0;
		end if;
		 
		 
		if (qt_retificacao_processado_w <> 0) then 
			pr_retificacao_w	:= (qt_retificacao_processado_w*100)/qt_retificacao_total_w;
		else 
			pr_retificacao_w	:= 0;
		end if;
		 
		if (qt_exclusao_processado_w <> 0) then 
			pr_exclusao_w	:= (qt_exclusao_processado_w*100)/qt_exclusao_total_w;
		else 
			pr_exclusao_w	:= 0;
		end if;
		 
		if (qt_reinclusao_processado_w <> 0) then 
			pr_reinclusao_w	:= (qt_reinclusao_processado_w*100)/qt_reinclusao_total_w;
		else 
			pr_reinclusao_w	:= 0;
		end if;
		 
		if (qt_processados_w <> 0) then 
			pr_total_w	:= (qt_processados_w*100)/qt_total_w;
		else 
			pr_total_w	:= 0;
		end if;
		 
		if (qt_sem_movto_processado_w <> 0) then 
			pr_sem_movto_w	:= (qt_sem_movto_processado_w*100)/qt_sem_movto_total_w;
		else 
			pr_sem_movto_w	:= 0;
		end if;
		 
		update	sib_devolucao_resumo 
		set	pr_inclusao_acerto	= pr_inclusao_w, 
			pr_retificacao_acerto	= pr_retificacao_w, 
			pr_exclusao_acerto	= pr_exclusao_w, 
			pr_reinclusao_acerto	= pr_reinclusao_w, 
			pr_total		= pr_total_w, 
			pr_sem_movto_acerto	= pr_sem_movto_w, 
			pr_alteracao_acerto	= pr_alteracao_w 
		where	nr_sequencia		= nr_seq_devolucao_resumo_w;
		 
	end if;
elsif (ie_tipo_info_p = 'M') then 
	select	max(nr_sequencia) 
	into STRICT	nr_seq_devolucao_resumo_w 
	from	sib_devolucao_resumo 
	where	nr_seq_lote	= nr_seq_lote_sib_p 
	and	cd_mensagem	= cd_mensagem_p 
	and	ie_tipo_item	= 'M' 
	and	ie_xml		= 'S';
 
	if (coalesce(nr_seq_devolucao_resumo_w::text, '') = '') then 
		insert into sib_devolucao_resumo(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec, 
					nr_seq_lote,ie_tipo_item,ie_xml,cd_mensagem,ds_mensagem_erro, 
					qt_ocorrencia_mensagem) 
		values (	nextval('sib_devolucao_resumo_seq'),clock_timestamp(),nm_usuario_p,clock_timestamp(),nm_usuario_p, 
					nr_seq_lote_sib_p,'M','S',cd_mensagem_p,ds_mensagem_erro_p, 
					qt_ocorrencia_mensagem_p);
	else 
		update	sib_devolucao_resumo 
		set	qt_ocorrencia_mensagem	= qt_ocorrencia_mensagem + coalesce(qt_ocorrencia_mensagem_p,0) 
		where	nr_sequencia		= nr_seq_devolucao_resumo_w;
	end if;
 
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_imp_dev_resumo_sib_xml ( nr_seq_lote_sib_p bigint, ie_tipo_info_p text,  nm_arquivo_p text,  qt_inclusao_total_p bigint default null, qt_inclusao_processado_p bigint default null, qt_inclusao_recusado_p bigint default null, pr_inclusao_acerto_p bigint default null, qt_alteracao_total_p bigint default null, qt_alteracao_processado_p bigint default null, qt_alteracao_recusado_p bigint default null, pr_alteracao_acerto_p bigint default null, qt_exclusao_total_p bigint default null, qt_exclusao_processado_p bigint default null, qt_exclusao_recusado_p bigint default null, pr_exclusao_acerto_p bigint default null, qt_reinclusao_total_p bigint default null, qt_reinclusao_processado_p bigint default null, qt_reinclusao_recusado_p bigint default null, pr_reinclusao_acerto_p bigint default null, qt_total_p bigint default null, qt_processados_p bigint default null, qt_recusados_p bigint default null, pr_total_p bigint default null, qt_retificacao_total_p bigint default null, qt_retificacao_processado_p bigint default null, qt_retificacao_recusado_p bigint default null, pr_retificacao_acerto_p bigint default null, qt_sem_movto_total_p bigint default null, qt_sem_movto_processado_p bigint default null, qt_sem_movto_recusado_p bigint default null, pr_sem_movto_acerto_p bigint default null,  cd_mensagem_p text DEFAULT NULL, ds_mensagem_erro_p text DEFAULT NULL, qt_ocorrencia_mensagem_p bigint default null,  cd_estabelecimento_p bigint DEFAULT NULL, nm_usuario_p text DEFAULT NULL) FROM PUBLIC;

