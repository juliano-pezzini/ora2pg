-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inutilizar_senha_monit_senha ( cd_senha_p bigint, cd_fila_p bigint, nr_seq_senha_p bigint, nm_usuario_p text, nr_seq_motivo_inutilizacao_p bigint) AS $body$
DECLARE


			
cd_estabelecimento_w			bigint;
nm_usuario_chamada_w 			varchar(20);
ie_consiste_usuario_w			varchar(2);
ie_consiste_motivo_w			varchar(1);

BEGIN
cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;

select 	coalesce(max(nm_usuario_chamada), 'XPTO')
into STRICT	nm_usuario_chamada_w
from	paciente_senha_fila
where	coalesce(nr_sequencia, 0) = nr_seq_senha_p
and	cd_estabelecimento = cd_estabelecimento_w;

ie_consiste_usuario_w := Obter_Param_Usuario(10021, 61, Obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, ie_consiste_usuario_w);
ie_consiste_motivo_w := Obter_Param_Usuario(10021, 120, Obter_perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, ie_consiste_motivo_w);

if (ie_consiste_motivo_w = 'S') and (coalesce(nr_seq_motivo_inutilizacao_p::text, '') = '') then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(270303);
end if;

if 	((nm_usuario_chamada_w <> nm_usuario_p) and (nm_usuario_chamada_w <> 'XPTO') and
	 ((ie_consiste_usuario_w = 'S') or
	 ((ie_consiste_usuario_w = 'M') and (obter_se_usuario_medico(nm_usuario_chamada_w) = 'S') and (obter_se_usuario_medico(nm_usuario_p) = 'S')))) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(219246, 'NM_USUARIO_CHAMADA= ' || nm_usuario_chamada_w);
end if;

if (nr_seq_senha_p > 0) then
	update	paciente_senha_fila
	set 	dt_inutilizacao 		= clock_timestamp(),
		nr_seq_motivo_inutilizacao 	= nr_seq_motivo_inutilizacao_p,
		dt_inicio_atendimento 		 = NULL,
		dt_fim_atendimento 		 = NULL,
		nm_usuario_inutilizacao		= wheb_usuario_pck.get_nm_usuario,
		ds_maquina_inutilizacao		= wheb_usuario_pck.get_nm_maquina
	where nr_sequencia = nr_seq_senha_p
	and	cd_estabelecimento = cd_estabelecimento_w;
else	
	update	paciente_senha_fila
	set 	dt_inutilizacao 		= clock_timestamp(),
			nr_seq_motivo_inutilizacao 	= nr_seq_motivo_inutilizacao_p,
			dt_inicio_atendimento 		 = NULL,
			dt_fim_atendimento 		 = NULL,
			nm_usuario_inutilizacao		= wheb_usuario_pck.get_nm_usuario,
			ds_maquina_inutilizacao		= wheb_usuario_pck.get_nm_maquina
	where cd_senha_gerada = cd_senha_p and coalesce(nr_seq_fila_senha,nr_seq_fila_senha_origem) = cd_fila_p
	and	cd_estabelecimento = cd_estabelecimento_w;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inutilizar_senha_monit_senha ( cd_senha_p bigint, cd_fila_p bigint, nr_seq_senha_p bigint, nm_usuario_p text, nr_seq_motivo_inutilizacao_p bigint) FROM PUBLIC;

