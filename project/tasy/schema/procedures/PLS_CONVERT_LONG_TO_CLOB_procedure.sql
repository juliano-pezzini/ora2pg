-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_convert_long_to_clob ( nm_tabela_p text, nm_coluna_p text, ds_restricao_where_p text, ds_parametros_sql_p text, ds_clob_p INOUT text) AS $body$
DECLARE


/*
nm_tabela_p -> Passar o nome da tabela onde deve ser realizada a consulta
nm_coluna_p-> Nome da columa que contem o conteudo LONG
ds_restricao_where_p - > Colocar a restrição WHERE para retornar 1 (um) registro da tabela
ds_parametros_sql_p -> Passar os parâmetros para a restrição WHERE
ds_clob_p -> Retorna o clob						*/
ds_sql_w		varchar(20000);
qt_registro_w		integer;


BEGIN
-- VERIFICAR SE TABELA TEMPORÁRIO EXISTE, SE NÃO EXISTIR CRIA
select 	count(*)
into STRICT	qt_registro_w
from	user_tables
where	table_name = 'W_PLS_CONV_LONG_TO_CLOB';

if ( qt_registro_w = 0 ) then
	CALL exec_sql_dinamico('','create global temporary table w_pls_conv_long_to_clob (ds_texto clob) on commit preserve rows');
else
	CALL exec_sql_dinamico('','truncate table w_pls_conv_long_to_clob');
end if;

-- TRANSFERE CONTEUDO DO CAMPO LONG DA TABELA DE ORIGEM PARA O CAMPO CLOB DA TABELA TEMPORARIO
ds_sql_w   := 'insert into w_pls_conv_long_to_clob (ds_texto) select to_lob('|| nm_coluna_p || ') from ' || nm_tabela_p || ' ' || ds_restricao_where_p;
CALL Exec_Sql_Dinamico_Bv('',ds_sql_w,ds_parametros_sql_p);

-- RECUPERA O VALOR DO CAMPO CLOB PARA A VARIAVEL DA PROCEDURE
ds_sql_w	:= ' select ds_texto from w_pls_conv_long_to_clob ';
EXECUTE ds_sql_w into STRICT ds_clob_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_convert_long_to_clob ( nm_tabela_p text, nm_coluna_p text, ds_restricao_where_p text, ds_parametros_sql_p text, ds_clob_p INOUT text) FROM PUBLIC;

