-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ajustar_vl_apres_resumo () AS $body$
DECLARE


vl_apresentado_dif_w	pls_conta_medica_resumo.vl_apresentado%type;
vl_apresentado_resum_w	pls_conta_medica_resumo.vl_apresentado%type;
vl_lib_resumo_w		pls_conta_medica_resumo.vl_liberado%type;

C01 CURSOR FOR
	SELECT	a.nr_seq_conta,
		a.nr_sequencia,
		a.vl_procedimento_imp
	from	pls_conta_proc	a,
		pls_conta b,
		pls_protocolo_conta c
	where	a.vl_procedimento_imp	> 0
	and	a.nr_seq_conta = b.nr_sequencia
	and	c.nr_sequencia = b.nr_seq_protocolo
	and	c.dt_mes_competencia >= to_date('01/09/2015')
	and	a.vl_procedimento_imp	<> ( SELECT	sum(x.vl_apresentado)
						from	pls_conta_medica_resumo x
						where	x.nr_seq_conta		= a.nr_seq_conta
						and	x.nr_seq_conta_proc	= a.nr_sequencia
						and	x.ie_tipo_item		!= 'I'
						and	x.ie_situacao 		= 'A');

BEGIN

for r_c01_w in C01 loop

	select	coalesce(sum(vl_lib_original),0)
	into STRICT	vl_lib_resumo_w
	from	pls_conta_medica_resumo
	where	nr_seq_conta		= r_c01_w.nr_seq_conta
	and	nr_seq_conta_proc	= r_c01_w.nr_sequencia
	and	ie_tipo_item		!= 'I'
	and	ie_situacao		= 'A';

	update	pls_conta_medica_resumo
	set	vl_apresentado 	 	= vl_apresentado * (dividir_sem_round(vl_lib_original, vl_lib_resumo_w))
	where	nr_seq_conta		= r_c01_w.nr_seq_conta
	and	nr_seq_conta_proc	= r_c01_w.nr_sequencia
	and	ie_tipo_item		!= 'I'
	and	ie_situacao		= 'A';

	select	sum(vl_apresentado)
	into STRICT	vl_apresentado_resum_w
	from	pls_conta_medica_resumo
	where	nr_seq_conta		= r_c01_w.nr_seq_conta
	and	nr_seq_conta_proc	= r_c01_w.nr_sequencia
	and	ie_tipo_item		!= 'I'
	and	ie_situacao		= 'A';

	--Diferença entre a soma dos valores apresentados dos registros na pls_conta_medica_resumo do procedimento em questão, em relação ao valor apresentado para o procedimento.
	vl_apresentado_dif_w := vl_apresentado_resum_w - r_c01_w.vl_procedimento_imp;

	--Na divisão do valor apresentado, pode ocorrer uma divergência de valor entre a soma dos registros e o total apresentado do item,
	--então aqui é feito um ajuste e o ajuste apenas ocorre em um único item cujo valor apresentado já seja maior que o valor de ajuste(evita ficar negativo, no caso de ajuste com valor negativo)
	if (vl_apresentado_dif_w <> 0) then
		update	pls_conta_medica_resumo
		set	vl_apresentado = vl_apresentado + vl_apresentado_dif_w
		where	nr_sequencia   =  (	SELECT	max(nr_sequencia)
						from 	pls_conta_medica_resumo
						where	nr_seq_conta		= r_c01_w.nr_seq_conta
						and	nr_seq_conta_proc	= r_c01_w.nr_sequencia
						and	vl_apresentado 		> vl_apresentado_dif_w
						and	ie_tipo_item		!= 'I'
						and	ie_situacao		= 'A');
	end if;

	if (mod(c01%rowCount,1000) = 0) then
		commit;
	end if;

end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ajustar_vl_apres_resumo () FROM PUBLIC;

