-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_inserir_gas_prescr_reg ( nr_atendimento_p bigint, nr_prescricao_p bigint, nr_sequencia_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, ie_origem_inf_p text, dt_inicio_prescr_p timestamp, cd_pessoa_fisica_p text, dt_inicio_ret_p INOUT timestamp) AS $body$
DECLARE


ie_inicio_w				cpoe_gasoterapia.ie_inicio%type;
ie_respiracao_w			cpoe_gasoterapia.ie_respiracao%type;
cd_modalidade_vent_w	cpoe_gasoterapia.cd_modalidade_vent%type;
qt_vc_prog_w			cpoe_gasoterapia.qt_vc_prog%type;
qt_pip_w				cpoe_gasoterapia.qt_pip%type;
qt_peep_w				cpoe_gasoterapia.qt_peep%type;
ie_disp_resp_esp_w		cpoe_gasoterapia.ie_disp_resp_esp%type;
qt_acima_peep_w			cpoe_gasoterapia.qt_acima_peep%type;
qt_ps_w					cpoe_gasoterapia.qt_ps%type;
nr_seq_gas_w			cpoe_gasoterapia.nr_seq_gas%type;
ie_unidade_medida_w		cpoe_gasoterapia.ie_unidade_medida%type;
qt_gasoterapia_w		cpoe_gasoterapia.qt_gasoterapia%type;
cd_intervalo_w			cpoe_gasoterapia.cd_intervalo%type;
ds_observacao_w			cpoe_gasoterapia.ds_observacao%type;
qt_fluxo_insp_w			cpoe_gasoterapia.qt_fluxo_insp%type;
qt_tempo_insp_w			cpoe_gasoterapia.qt_tempo_insp%type;
qt_sensib_resp_w		cpoe_gasoterapia.qt_sensib_resp%type;
qt_freq_vent_w			cpoe_gasoterapia.qt_freq_vent%type;
ie_modo_adm_w			cpoe_gasoterapia.ie_modo_adm%type;
qt_referencia_w			cpoe_gasoterapia.qt_referencia%type;
qt_bic_w				cpoe_gasoterapia.qt_bic%type;
qt_be_w					cpoe_gasoterapia.qt_be%type;
qt_sato2_w				cpoe_gasoterapia.qt_sato2%type;
ie_tipo_onda_w			cpoe_gasoterapia.ie_tipo_onda%type;
cd_mat_equip1_w			cpoe_gasoterapia.cd_mat_equip1%type;
cd_mat_equip2_w			cpoe_gasoterapia.cd_mat_equip2%type;
cd_mat_equip3_w			cpoe_gasoterapia.cd_mat_equip3%type;
ie_via_aplic1_w			cpoe_gasoterapia.ie_via_aplic1%type;
ie_via_aplic2_w			cpoe_gasoterapia.ie_via_aplic2%type;
ie_via_aplic3_w			cpoe_gasoterapia.ie_via_aplic3%type;
cd_unid_med_dose1_w		cpoe_gasoterapia.cd_unid_med_dose1%type;
cd_unid_med_dose2_w		cpoe_gasoterapia.cd_unid_med_dose2%type;
cd_unid_med_dose3_w		cpoe_gasoterapia.cd_unid_med_dose3%type;
qt_dose_mat1_w			cpoe_gasoterapia.qt_dose_mat1%type;
qt_dose_mat2_w			cpoe_gasoterapia.qt_dose_mat2%type;
qt_dose_mat3_w			cpoe_gasoterapia.qt_dose_mat3%type;
cd_intervalo_mat1_w		cpoe_gasoterapia.cd_intervalo_mat1%type;
qt_pco2_w				cpoe_gasoterapia.qt_pco2%type;
cd_intervalo_mat2_w		cpoe_gasoterapia.cd_intervalo_mat2%type;
cd_intervalo_mat3_w		cpoe_gasoterapia.cd_intervalo_mat3%type;
qt_min_intervalo_w		cpoe_gasoterapia.qt_min_intervalo%type;
qt_ph_w					cpoe_gasoterapia.qt_ph%type;
qt_ti_te_w				cpoe_gasoterapia.qt_ti_te%type;
hr_prim_hor_mat1_w		cpoe_gasoterapia.hr_prim_hor_mat1%type;
hr_prim_hor_mat2_w		cpoe_gasoterapia.hr_prim_hor_mat2%type;
hr_prim_hor_mat3_w		cpoe_gasoterapia.hr_prim_hor_mat3%type;
ds_horarios_mat1_w		cpoe_gasoterapia.ds_horarios_mat1%type;
ds_horarios_mat2_w		cpoe_gasoterapia.ds_horarios_mat2%type;
ds_horarios_mat3_w		cpoe_gasoterapia.ds_horarios_mat3%type;
nr_sequencia_w			cpoe_gasoterapia.nr_sequencia%type;
ie_duracao_w			cpoe_gasoterapia.ie_duracao%type;
ie_administracao_w		cpoe_gasoterapia.ie_administracao%type;
ie_retrogrado_w			cpoe_gasoterapia.ie_retrogrado%type;
qt_fracao_oxigenio_w	cpoe_gasoterapia.qt_fracao_oxigenio%type;

nr_prescricao_orig_w	prescr_medica.nr_prescricao%type;

nr_seq_gasoterapia_w	prescr_gasoterapia.nr_sequencia%type;
nr_sequencia_orig_w		prescr_gasoterapia.nr_sequencia%type;

nr_seq_inconsistencia_w prescr_gasoterapia.nr_seq_inconsistencia%type;

ie_urgencia_w			prescr_material.ie_urgencia%type;
nr_ocorrencia_w			prescr_material.nr_ocorrencia%type;
nr_agrupamento_w		prescr_material.nr_agrupamento%type;
cd_unid_medida_cons_w	prescr_material.cd_unidade_medida%type;	
nr_seq_material_w		prescr_material.nr_sequencia%type;
qt_conversao_w			prescr_material.qt_conversao_dose%type;
qt_unitaria_w			prescr_material.qt_unitaria%type;
qt_total_disp_w			prescr_material.qt_total_dispensar%type;

ds_erro_ex_w 			varchar(2000);
ds_horarios_w			varchar(4000);
ds_horarios_aux_w		varchar(4000);
dt_inicio_w				timestamp;
dt_inicio_orig_w		timestamp;
dt_inicio_base_w		timestamp;
dt_fim_w				timestamp;
ie_acm_w				char(1);
ie_se_necessario_w		char(1);
hr_prim_horario_w		char(5);
nr_horas_prox_geracao_w	bigint;
ie_calcula_horarios_w	boolean;
qt_hora_fase_w			double precision;
ie_continuo_w			char(1);
ie_copia_w				smallint;

c01 CURSOR FOR
	SELECT	a.nr_sequencia,
			a.ie_respiracao,
			a.nr_seq_gas,
			a.ie_disp_resp_esp,
			a.qt_gasoterapia,
			a.ie_unidade_medida,		
			a.cd_modalidade_vent,
			a.qt_freq_vent,	
			a.qt_vc_prog,
			a.qt_pip,
			a.qt_peep,
			a.qt_ps,
			a.qt_fluxo_insp,
			a.qt_tempo_insp,
			a.qt_acima_peep,
			a.qt_ti_te,
			a.qt_sensib_resp,
			a.ie_tipo_onda,
			a.qt_ph,
			a.qt_pco2,
			a.qt_sato2,
			a.qt_bic,
			a.qt_be,
			a.cd_mat_equip1,
			a.cd_mat_equip2,
			a.cd_mat_equip3,
			a.ie_via_aplic1,
			a.ie_via_aplic2,
			a.ie_via_aplic3,
			a.cd_unid_med_dose1,
			a.cd_unid_med_dose2,
			a.cd_unid_med_dose3,
			a.qt_dose_mat1,
			a.qt_dose_mat2,
			a.qt_dose_mat3,
			a.cd_intervalo_mat1,	
			a.cd_intervalo_mat2,
			a.cd_intervalo_mat3,
			a.hr_prim_hor_mat1,
			a.hr_prim_hor_mat2,
			a.hr_prim_hor_mat3,
			a.ds_horarios_mat1,
			a.ds_horarios_mat2,
			a.ds_horarios_mat3,
			a.cd_intervalo,
			a.qt_min_intervalo,
			CASE WHEN coalesce(a.ie_urgencia::text, '') = '' THEN 'N'  ELSE 'S' END ,
			a.dt_inicio,
			a.hr_prim_horario,
			a.ds_horarios,		
			a.ie_duracao,
			coalesce(a.ie_administracao,'P'),
			CASE WHEN a.ie_modo_adm='C' THEN 'CO' WHEN a.ie_modo_adm='I' THEN 'IN'  ELSE '' END ,
			CASE WHEN a.ie_modo_adm='I' THEN 'N'  ELSE 'S' END ,
			a.dt_fim,
			a.ds_observacao,
			coalesce(a.nr_ocorrencia,1),
			CASE WHEN coalesce(a.qt_hora_fase,'__:__')='__:__' THEN null  ELSE dividir(obter_minutos_hora(rpad(lpad(a.qt_hora_fase,2,'0'),5,'0')),60) END ,
			coalesce(ie_retrogrado,'N'),
			a.qt_fracao_oxigenio
	from	cpoe_gasoterapia a
	where	a.nr_sequencia = nr_sequencia_p
	and		((CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) END  >= clock_timestamp()) or (CASE WHEN coalesce(a.dt_lib_suspensao::text, '') = '' THEN  a.dt_fim  ELSE coalesce(a.dt_suspensao,a.dt_fim) coalesce(END::text, '') = '') or (coalesce(a.ie_retrogrado,'N') = 'S' AND a.dt_inicio >= dt_inicio_prescr_p)) -- retrograde/backward item)
	order 	by a.nr_sequencia;


	procedure cpoe_inserir_mat_gas_reg(	cd_material_p			bigint,
										qt_dose_p				bigint,
										cd_unid_med_dose_p		text,
										ie_via_aplicacao_p		text ) is 				
	;
BEGIN
		cd_unid_medida_cons_w	:= substr(obter_dados_material_estab( cd_material_p, cd_estabelecimento_p, 'UMS' ),1,30);

		qt_conversao_w		:= obter_conversao_unid_med( cd_material_p, cd_unid_med_dose_p );	
		qt_unitaria_w		:= dividir(qt_dose_p, qt_conversao_w);
		qt_total_disp_w		:= qt_unitaria_w * nr_ocorrencia_w;
		
		nr_agrupamento_w	:= nr_agrupamento_w + 1;
		nr_seq_material_w	:= nr_seq_material_w + 1;
		
		insert into prescr_material(
				nr_sequencia,
				nr_prescricao,
				ie_agrupador,
				nr_agrupamento,
				nr_dia_util,
				ie_erro,
				ie_origem_inf,
				nr_seq_gasoterapia,
				nr_ocorrencia,
				qt_conversao_dose,
				qt_unitaria,
				qt_material,
				qt_total_dispensar,
				cd_material,
				qt_dose,
				cd_unidade_medida_dose,
				cd_unidade_medida,
				ie_via_aplicacao,
				cd_intervalo,
				hr_prim_horario,
				ds_horarios,
				nm_usuario,
				dt_atualizacao,
				nm_usuario_nrec,
				dt_atualizacao_nrec,
				ie_acm,
				ie_se_necessario,
				ie_urgencia,
				ie_utiliza_kit,
				ie_bomba_infusao,
				ie_medicacao_paciente,
				ie_checar_adep,
				ie_aplic_bolus,
				ie_recons_diluente_fixo,
				ie_sem_aprazamento,
				ie_cobra_paciente,
				ie_intervalo_dif,
				ie_permite_substituir,
				ie_permite_alterar,
				ie_gerar_lote,
				ie_regra_disp,
				ie_status_cirurgia
		) values (
				nr_seq_material_w,
				nr_prescricao_p,
				15,
				0,
				0,
				0,
				ie_origem_inf_p,
				nr_seq_gasoterapia_w,
				nr_ocorrencia_w, --qt_gasoterapia_p,
				qt_conversao_w,
				qt_unitaria_w,
				qt_total_disp_w,
				qt_total_disp_w,
				cd_material_p,
				qt_dose_p,
				cd_unid_med_dose_p,
				cd_unid_medida_cons_w,
				ie_via_aplicacao_p,
				cd_intervalo_w,
				hr_prim_horario_w,
				ds_horarios_w,
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				'N',
				'N',
				ie_urgencia_w,
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'N',
				'S',
				'S',
				'S',
				'S',
				'GI'
		);

		commit;

	end;

	procedure Calcular_horarios_item is
	begin
		nr_ocorrencia_w			:= coalesce(Obter_ocorrencia_intervalo(cd_intervalo_w, 24, 'O'),1);
		
		if (ie_administracao_w = 'P') then
			if (ie_continuo_w = 'S') then
				qt_hora_fase_w		:= dividir_sem_round(24, nr_ocorrencia_w);
			end if;
			
			SELECT * FROM CPOE_Prever_horarios_futuros(	nr_atendimento_p, nr_prescricao_p, nr_sequencia_p, 'prescr_gasoterapia', 'nr_seq_gas_cpoe', 'prescr_gasoterapia_hor', 'nr_seq_gasoterapia', 'cpoe_gasoterapia', dt_inicio_base_w, dt_inicio_w, dt_fim_w, cd_intervalo_w, ds_horarios_w, nr_ocorrencia_w, hr_prim_horario_w, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, null, null, null, null, null, null, 'ds_horarios', null, 'hr_prim_horario', ie_continuo_w, 24, qt_hora_fase_w) INTO STRICT dt_inicio_w, dt_fim_w, ds_horarios_w, nr_ocorrencia_w, hr_prim_horario_w;
		end if;
	end;

	procedure Localizar_ultimo_item is
	begin
		nr_prescricao_orig_w	:= null;
		nr_sequencia_orig_w		:= null;
		
		if (ie_calcula_horarios_w) and (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
			-- Localizar ultima prescricao
			select	max(a.nr_prescricao)
			into STRICT	nr_prescricao_orig_w
			from	prescr_medica a
			where	a.nr_atendimento = nr_atendimento_p
			and		a.dt_prescricao > dt_inicio_base_w  - 10
			and		exists (	SELECT	1
							from	prescr_gasoterapia b
							where	b.nr_prescricao = a.nr_prescricao
							and		b.nr_seq_gas_cpoe = nr_sequencia_p );
			
			if (nr_prescricao_orig_w IS NOT NULL AND nr_prescricao_orig_w::text <> '') then
				-- Itens copiados nao devem ser gerados como agora
				ie_urgencia_w	:= null;
				
				-- Localizar ultimo item
				select	min(nr_sequencia)
				into STRICT	nr_sequencia_orig_w
				from	prescr_gasoterapia
				where	nr_prescricao = nr_prescricao_orig_w
				and		nr_seq_gas_cpoe = nr_sequencia_p;
			else
				nr_sequencia_orig_w	:= null;
			end if;
		end if;
	end;

begin

dt_inicio_base_w		:= trunc(dt_inicio_prescr_p,'mi');
nr_horas_prox_geracao_w	:= get_qt_hours_after_copy_cpoe(cd_perfil_p, nm_usuario_p, cd_estabelecimento_p);

open c01;
loop
fetch c01 into	
	nr_sequencia_w,
	ie_respiracao_w,
	nr_seq_gas_w,
	ie_disp_resp_esp_w,
	qt_gasoterapia_w,
	ie_unidade_medida_w,		
	cd_modalidade_vent_w,
	qt_freq_vent_w,	
	qt_vc_prog_w,
	qt_pip_w,
	qt_peep_w,
	qt_ps_w,
	qt_fluxo_insp_w,
	qt_tempo_insp_w,
	qt_acima_peep_w,
	qt_ti_te_w,
	qt_sensib_resp_w,
	ie_tipo_onda_w,
	qt_ph_w,
	qt_pco2_w,
	qt_sato2_w,
	qt_bic_w,
	qt_be_w,
	cd_mat_equip1_w,
	cd_mat_equip2_w,
	cd_mat_equip3_w,
	ie_via_aplic1_w,
	ie_via_aplic2_w,
	ie_via_aplic3_w,
	cd_unid_med_dose1_w,
	cd_unid_med_dose2_w,
	cd_unid_med_dose3_w,
	qt_dose_mat1_w,
	qt_dose_mat2_w,
	qt_dose_mat3_w,
	cd_intervalo_mat1_w,	
	cd_intervalo_mat2_w,
	cd_intervalo_mat3_w,
	hr_prim_hor_mat1_w,
	hr_prim_hor_mat2_w,
	hr_prim_hor_mat3_w,
	ds_horarios_mat1_w,
	ds_horarios_mat2_w,
	ds_horarios_mat3_w,
	cd_intervalo_w,
	qt_min_intervalo_w,
	ie_urgencia_w,
	dt_inicio_orig_w,
	hr_prim_horario_w,
	ds_horarios_w,		
	ie_duracao_w,
	ie_administracao_w,
	ie_modo_adm_w,
	ie_continuo_w,
	dt_fim_w,
	ds_observacao_w,
	nr_ocorrencia_w,
	qt_hora_fase_w,
	ie_retrogrado_w,
	qt_fracao_oxigenio_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	select	nextval('prescr_gasoterapia_seq')
	into STRICT	nr_seq_gasoterapia_w
	;
	
	ie_calcula_horarios_w	:= false;
	dt_inicio_w				:= dt_inicio_orig_w;

	-- Itens ACM e SN nao possuem primeiro horario, definir inicio do item para execucao da geracao.
	if (ie_administracao_w <> 'P') then
		begin
		if (trunc(dt_inicio_w) > trunc(dt_inicio_base_w)) then
			hr_prim_horario_w	:= '00:00';
		else
			hr_prim_horario_w		:= to_char(dt_inicio_base_w,'hh24:mi');
		end if;
		end;
	end if;

	-- Atualiza a data inicio com dia e horario.
	dt_inicio_w		:= to_date(to_char(dt_inicio_w,'dd/mm/yyyy ') || hr_prim_horario_w,'dd/mm/yyyy hh24:mi');

	select	max(1)
	into STRICT	ie_copia_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p
	and 	coalesce(nr_prescricoes::text, '') = '';

	-- Atualizar data de inicio com a data atual, para itens que a data de inicio ja tenha sido ultrapassada.

	-- E se for nao for a primeira prescricao de um item retrogrado
	

	if (dt_inicio_w < dt_inicio_base_w) and
		(((coalesce(ie_copia_w,0) = 1)  and (coalesce(ie_retrogrado_w,'N') <> 'S')) or (coalesce(ie_copia_w,0) = 0)) then
		-- Assumir data da prescricao para o item
		dt_inicio_w		:= to_date(to_char(dt_inicio_base_w,'dd/mm/yyyy ') || hr_prim_horario_w, 'dd/mm/yyyy hh24:mi');

		-- Adicionar um dia, caso o inicio do item, nao caia na data de hoje
		if (dt_inicio_w < dt_inicio_base_w) then
			dt_inicio_w	:= dt_inicio_w+1;
		end if;

		ie_calcula_horarios_w	:= true;
	end if;

		-- Localizar ultima prescricao e item principal vinculado ao registro da CPOE
	Localizar_ultimo_item;
	
	-- Recalcula os horarios do item, caso a data de inicio, nao seja a mesma da tabela de CPOE_GASOTERAPIA
	if (ie_calcula_horarios_w) then
		Calcular_horarios_item;
	end if;
	
	-- Se a data de inicio do item for superior a data de inicio da prescricao adicionando 1 dia (totalizando 24h), 

	--  deve-se programar a geracao de uma prescricao para este.
	if (dt_inicio_w > dt_inicio_base_w + 1 - 1/86400) and (coalesce(nr_prescricao_orig_w::text, '') = '') then
		update	cpoe_gasoterapia
		set		dt_prox_geracao = (trunc(dt_inicio_w,'hh24')-nr_horas_prox_geracao_w/24)
		where	nr_sequencia = nr_sequencia_p;
		
		CALL gravar_log_cpoe(substr('CPOE_INSERIR_GAS_PRESCR_REG LOG DT_INICIO_W > DT_INICIO_BASE_W:'
			||'//dt_inicio_w : ' || to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss')
			||' dt_proxima_dose_new : ' || to_char((trunc(dt_inicio_w,'hh24')-nr_horas_prox_geracao_w/24),'dd/mm/yyyy hh24:mi:ss')
			||' dt_inicio_base_w : ' || to_char(dt_inicio_base_w,'dd/mm/yyyy hh24:mi:ss')
			||' nr_prescricao_p : ' || nr_prescricao_p
			||' nr_seq_gas_cpoe_w :' || nr_sequencia_p
			||' cd_perfil_p: ' || cd_perfil_p,1,2000),
			nr_atendimento_p, 'G', nr_sequencia_p);
			
		goto proximo_item;
	end if;

	-- Se o inicio do item for apos a data de fim, definida para o mesmo, este item nao deve ser mais copiado.
	if (dt_fim_w IS NOT NULL AND dt_fim_w::text <> '') and (dt_fim_w <= dt_inicio_w) then
		CALL gravar_log_cpoe(substr('CPOE_INSERIR_GAS_PRESCR_REG LOG DT_FIM_W <= DT_INICIO_W:'
			||'//dt_inicio_w : ' || to_char(dt_inicio_w,'dd/mm/yyyy hh24:mi:ss')
			||' dt_proxima_dose_new : ' || to_char((trunc(dt_inicio_w,'hh24')-nr_horas_prox_geracao_w/24),'dd/mm/yyyy hh24:mi:ss')
			||' dt_inicio_base_w : ' || to_char(dt_inicio_base_w,'dd/mm/yyyy hh24:mi:ss')
			||' nr_prescricao_p : ' || nr_prescricao_p
			||' nr_seq_gas_cpoe_w :' || nr_sequencia_p
			||' cd_perfil_p: ' || cd_perfil_p,1,2000),
			nr_atendimento_p, 'G', nr_sequencia_p);
			
		goto proximo_item;
	end if;

	-- Retornar a maior data de inicio dos itens.
	if (coalesce(dt_inicio_ret_p::text, '') = '') or (dt_inicio_w > dt_inicio_ret_p) then
		dt_inicio_ret_p	:= dt_inicio_w;
	end if;
	
	ie_se_necessario_w	:= 'N';
	ie_acm_w			:= 'N';
	
	--  decode(a.ie_modo_adm,'C','CO','I','IN',''),

	
	--Determina campo inicio da gasoterapia/REP
	if (ie_administracao_w = 'N') then
		ie_inicio_w			:= 'D';
		ie_acm_w			:= 'N';
		hr_prim_horario_w	:= null;
		ds_horarios_w		:= null;
		dt_inicio_w			:= null;
		ie_urgencia_w		:= null;
	elsif (ie_administracao_w = 'C') then
		ie_inicio_w			:= 'ACM';
		ie_se_necessario_w	:= 'N';
		hr_prim_horario_w	:= null;
		ds_horarios_w		:= null;
		dt_inicio_w			:= null;
		ie_modo_adm_w		:= 'AC'; --Determina modo administracao
		ie_urgencia_w		:= null;
	else
		if (coalesce(ie_urgencia_w,'N') = 'S') then
			ie_inicio_w		:= 'A';
		else
			ie_inicio_w		:= 'H';
		end if;
	end if;
	
	if (ds_horarios_w IS NOT NULL AND ds_horarios_w::text <> '') then
		ds_horarios_w := replace(padroniza_horario_prescr(ds_horarios_w,to_char(dt_inicio_w,'dd/mm/yyyy')),'A','');
	end if;
	
	ds_observacao_w := substr(ds_observacao_w || chr(13) || cpoe_obter_justificativa_item(nr_sequencia_p, nr_seq_gas_w,'G'),1,2000);
	
	if (trunc(dt_inicio_prescr_p) > trunc(dt_inicio_w)) then
		dt_inicio_w := to_date(to_char(dt_inicio_prescr_p,'dd/mm/yyyy ') || to_char(dt_inicio_w,'hh24:mi:ss'),'dd/mm/yyyy hh24:mi:ss');
	end if;
	
	select  max(nr_seq_inconsistencia)
	into STRICT	nr_seq_inconsistencia_w
	from  	prescr_medica a,
			prescr_gasoterapia b
	where   b.nr_prescricao = a.nr_prescricao
	and 	a.dt_suspensao is  null
	and     (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')								 
	and     a.cd_funcao_origem not in (924,950)
	and 	(nr_seq_inconsistencia IS NOT NULL AND nr_seq_inconsistencia::text <> '')
	and		b.nr_seq_gas_cpoe = nr_sequencia_w;
	

	insert into prescr_gasoterapia(
			nr_sequencia,
			nr_prescricao,
			nr_seq_gas_cpoe,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_prev_execucao,
			ie_inicio,
			ie_respiracao,
			cd_modalidade_vent,
			ie_disp_resp_esp,
			nr_seq_gas,
			ie_unidade_medida,
			qt_gasoterapia,
			ie_erro,
			cd_intervalo,
			ds_observacao,
			qt_freq_vent,
			ie_modo_adm,
			qt_referencia,
			qt_vc_prog,
			qt_pip,
			qt_peep,
			qt_ps,
			qt_fluxo_insp,
			qt_tempo_insp,
			qt_sensib_resp,
			ie_tipo_onda,
			qt_ti_te,
			qt_acima_peep,
			ds_horarios,
			qt_min_intervalo,
			qt_sato2,
			qt_pco2,
			qt_ph,
			qt_bic,
			qt_be,
			ie_fluxo_acm,
			cd_perfil_ativo,
			nr_prescricao_original,
			nr_seq_anterior,
			nr_seq_inconsistencia,
			qt_fracao_oxigenio)
		values (
			nr_seq_gasoterapia_w,
			nr_prescricao_p,
			nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			dt_inicio_w,
			ie_inicio_w,
			ie_respiracao_w,
			cd_modalidade_vent_w,
			ie_disp_resp_esp_w,
			nr_seq_gas_w,
			ie_unidade_medida_w,
			qt_gasoterapia_w,
			0,
			cd_intervalo_w,
			ds_observacao_w,
			qt_freq_vent_w,
			ie_modo_adm_w,
			qt_referencia_w,
			qt_vc_prog_w,
			qt_pip_w,
			qt_peep_w,
			qt_ps_w,
			qt_fluxo_insp_w,
			qt_tempo_insp_w,
			qt_sensib_resp_w,
			ie_tipo_onda_w,
			qt_ti_te_w,
			qt_acima_peep_w,
			ds_horarios_w,
			qt_min_intervalo_w,
			qt_sato2_w,
			qt_pco2_w,
			qt_ph_w,
			qt_bic_w,
			qt_be_w,
			'N',
			cd_perfil_p,
			nr_prescricao_orig_w,
			nr_sequencia_orig_w,
			nr_seq_inconsistencia_w,
			qt_fracao_oxigenio_w);
			
	if ((coalesce(cd_mat_equip1_w, cd_mat_equip2_w, cd_mat_equip3_w) IS NOT NULL AND (coalesce(cd_mat_equip1_w, cd_mat_equip2_w, cd_mat_equip3_w))::text <> '')) then
		select	coalesce(max(nr_agrupamento),0)
		into STRICT	nr_agrupamento_w
		from	prescr_material
		where 	nr_prescricao = nr_prescricao_p;
		
		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_material_w
		from	prescr_material
		where	nr_prescricao = nr_prescricao_p;
		
		if (cd_mat_equip1_w IS NOT NULL AND cd_mat_equip1_w::text <> '') then
			cpoe_inserir_mat_gas_reg( cd_mat_equip1_w, qt_dose_mat1_w, cd_unid_med_dose1_w, ie_via_aplic1_w );
		end if;

		if (cd_mat_equip2_w IS NOT NULL AND cd_mat_equip2_w::text <> '') then
			cpoe_inserir_mat_gas_reg( cd_mat_equip2_w, qt_dose_mat2_w, cd_unid_med_dose2_w, ie_via_aplic2_w );
		end if;

		if (cd_mat_equip3_w IS NOT NULL AND cd_mat_equip3_w::text <> '') then
			cpoe_inserir_mat_gas_reg( cd_mat_equip3_w, qt_dose_mat3_w, cd_unid_med_dose3_w, ie_via_aplic3_w );
		end if;
	end if;
	
	<<proximo_item>>
	commit;
	end;
end loop;
close c01;
	
commit;

exception when others then
	CALL gravar_log_cpoe(substr('CPOE_INSERIR_GAS_PRESCR_REG EXCEPTION:'||substr(to_char(sqlerrm),1,2000)
		||'nr_atendimento_p:'||nr_atendimento_p||'cd_estabelecimento_p'||cd_estabelecimento_p
		||'cd_perfil_p:'||cd_perfil_p||'nm_usuario_p : '||nm_usuario_p||'ie_origem_inf_p:'||ie_origem_inf_p
		||'dt_inicio_prescr_p :'||to_char(dt_inicio_prescr_p,'dd/mm/yyyy hh24:mi:ss')
		||'dt_inicio_ret_p :'||to_char(dt_inicio_ret_p,'dd/mm/yyyy hh24:mi:ss'),1,2000),
		nr_atendimento_p, 'G', nr_sequencia_p);
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_inserir_gas_prescr_reg ( nr_atendimento_p bigint, nr_prescricao_p bigint, nr_sequencia_p bigint, cd_estabelecimento_p bigint, cd_perfil_p bigint, nm_usuario_p text, ie_origem_inf_p text, dt_inicio_prescr_p timestamp, cd_pessoa_fisica_p text, dt_inicio_ret_p INOUT timestamp) FROM PUBLIC;

