-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_hist_medic_subst_farm ( nr_prescricao_p bigint, nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_material_new_w		integer;
ie_via_aplicacao_new_w		varchar(5);
cd_unidade_medida_dose_new_w	varchar(30);
qt_dose_new_w			double precision;
ie_medicacao_paciente_new_w	varchar(1);
nr_dia_util_new_w		bigint;
cd_intervalo_new_w		varchar(7);
qt_hora_aplicacao_new_w		smallint;
cd_material_old_w		integer;
ie_via_aplicacao_old_w		varchar(5);
cd_unidade_medida_dose_old_w	varchar(30);
qt_dose_old_w			double precision;
ie_medicacao_paciente_old_w	varchar(1);
nr_dia_util_old_w		bigint;
cd_intervalo_old_w		varchar(7);
qt_hora_aplicacao_old_w		smallint;
qt_min_aplicacao_new_w		smallint;
qt_solucao_new_w		double precision;
qt_total_dias_lib_new_w		integer;
qt_min_aplicacao_old_w		smallint;
qt_solucao_old_w		double precision;
qt_total_dias_lib_old_w		integer;
ds_historico_w			varchar(4000):=null;
nr_seq_tipo_hist_w		bigint;


BEGIN

nr_seq_tipo_hist_w := Obter_Param_Usuario(7010, 107, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, nr_seq_tipo_hist_w);

select	max(cd_material),
	max(ie_via_aplicacao),
	max(cd_unidade_medida_dose),
	max(qt_dose),
	max(ie_medicacao_paciente),
	max(nr_dia_util),
	max(cd_intervalo),
	max(qt_hora_aplicacao),
	max(qt_min_aplicacao),
	max(qt_solucao),
	max(qt_total_dias_lib)
into STRICT	cd_material_old_w,
	ie_via_aplicacao_old_w,
	cd_unidade_medida_dose_old_w,
	qt_dose_old_w,
	ie_medicacao_paciente_old_w,
	nr_dia_util_old_w,
	cd_intervalo_old_w,
	qt_hora_aplicacao_old_w,
	qt_min_aplicacao_old_w,
	qt_solucao_old_w,
	qt_total_dias_lib_old_w
from 	prescr_material
where	nr_prescricao  	  = nr_prescricao_p
and	nr_seq_substituto = nr_sequencia_p
and	ie_agrupador in (1,5);

select	max(cd_material),
	max(ie_via_aplicacao),
	max(cd_unidade_medida_dose),
	max(qt_dose),
	max(ie_medicacao_paciente),
	max(nr_dia_util),
	max(cd_intervalo),
	max(qt_hora_aplicacao),
	max(qt_min_aplicacao),
	max(qt_solucao),
	max(qt_total_dias_lib)
into STRICT	cd_material_new_w,
	ie_via_aplicacao_new_w,
	cd_unidade_medida_dose_new_w,
	qt_dose_new_w,
	ie_medicacao_paciente_new_w,
	nr_dia_util_new_w,
	cd_intervalo_new_w,
	qt_hora_aplicacao_new_w,
	qt_min_aplicacao_new_w,
	qt_solucao_new_w,
	qt_total_dias_lib_new_w
from 	prescr_material
where	nr_prescricao  	  = nr_prescricao_p
and	nr_sequencia  	  = nr_sequencia_p
and	ie_agrupador in (1,5);

if (cd_material_new_w <> cd_material_old_w) then
	ds_historico_w := 	wheb_mensagem_pck.get_texto(817912, 'DS_MEDICAMENTO_1=' || substr(Obter_desc_material(cd_material_old_w),1,200) || ';DS_MEDICAMENTO_2=' || substr(Obter_desc_material(cd_material_new_w),1,200));--'Substituído "Medicamento" de '||substr(Obter_desc_material(cd_material_old_w),1,200)||' para '||substr(Obter_desc_material(cd_material_new_w),1,200) || chr(13);
end if;

if (ie_via_aplicacao_new_w <> ie_via_aplicacao_old_w) then
	ds_historico_w := 	ds_historico_w || wheb_mensagem_pck.get_texto(817917, 'DS_VIA_1=' || Obter_Desc_via(ie_via_aplicacao_old_w) || ';DS_VIA_2=' || Obter_Desc_via(ie_via_aplicacao_new_w));--'Substituído "Via de administração" de '||Obter_Desc_via(ie_via_aplicacao_old_w) ||' para '||Obter_Desc_via(ie_via_aplicacao_new_w) || chr(13);
end if;

if (cd_unidade_medida_dose_new_w <> cd_unidade_medida_dose_old_w) then
	ds_historico_w := 	ds_historico_w || wheb_mensagem_pck.get_texto(817916, 'DS_UNID_1=' || Obter_Desc_Unid_Med(cd_unidade_medida_dose_old_w) || ';DS_UNID_2=' || Obter_Desc_Unid_Med(cd_unidade_medida_dose_new_w));--'Substituído "Unidade medida" de '||Obter_Desc_Unid_Med(cd_unidade_medida_dose_old_w) ||' para '||Obter_Desc_Unid_Med(cd_unidade_medida_dose_new_w) || chr(13);
end if;

if (coalesce(qt_dose_new_w,-1) <> coalesce(qt_dose_old_w,-1)) then
	ds_historico_w := 	ds_historico_w || wheb_mensagem_pck.get_texto(817919, 'QT_DOSE_1=' || qt_dose_old_w || ';QT_DOSE_2=' || qt_dose_new_w);--'Substituído "Dose" de '||qt_dose_old_w ||' para '||qt_dose_new_w || chr(13);
end if;

if (ie_medicacao_paciente_new_w <> ie_medicacao_paciente_old_w) then
	ds_historico_w := 	ds_historico_w || wheb_mensagem_pck.get_texto(817913, 'NM_PACIENTE_1=' || ie_medicacao_paciente_old_w || ';NM_PACIENTE_2=' || ie_medicacao_paciente_new_w);--'Substituído "do Paciente" de '|| ie_medicacao_paciente_old_w ||' para '||ie_medicacao_paciente_new_w || chr(13);
end if;

if (coalesce(nr_dia_util_new_w,-1) <> coalesce(nr_dia_util_old_w,-1)) or (coalesce(qt_total_dias_lib_new_w,-1) <> coalesce(qt_total_dias_lib_old_w,-1)) then
	ds_historico_w := 	ds_historico_w || wheb_mensagem_pck.get_texto(817923, 'QT_DIA_1=' || nr_dia_util_old_w || qt_total_dias_lib_old_w || ';QT_DIA_2=' || nr_dia_util_new_w || qt_total_dias_lib_new_w);--'Substituído "Dia/Liberado" de '|| nr_dia_util_old_w || '/' || qt_total_dias_lib_old_w ||' para '||nr_dia_util_new_w ||'/'||qt_total_dias_lib_new_w|| chr(13);
end if;

if (cd_intervalo_new_w <> cd_intervalo_old_w) then
	ds_historico_w := 	ds_historico_w || wheb_mensagem_pck.get_texto(817910, 'DS_INTERVALO_1=' || substr(OBTER_DESC_INTERVALO(cd_intervalo_old_w),1,255) || ';DS_INTERVALO_2=' || substr(OBTER_DESC_INTERVALO(cd_intervalo_new_w),1,255));--'Substituído "Intervalos" de '|| substr(OBTER_DESC_INTERVALO(cd_intervalo_old_w),1,255) ||' para '||substr(OBTER_DESC_INTERVALO(cd_intervalo_new_w),1,255) || chr(13);
end if;

if (coalesce(qt_hora_aplicacao_new_w,-1) <> coalesce(qt_hora_aplicacao_old_w,-1)) or (coalesce(qt_min_aplicacao_new_w,-1) <> coalesce(qt_min_aplicacao_old_w,-1)) or (coalesce(qt_solucao_new_w,-1) <> coalesce(qt_solucao_old_w,-1)) then
	ds_historico_w := 	ds_historico_w || wheb_mensagem_pck.get_texto(817920, 'DS_APLIC_1=' || qt_hora_aplicacao_old_w || qt_min_aplicacao_old_w || qt_solucao_old_w || ';DS_APLIC_2=' || qt_hora_aplicacao_new_w || qt_min_aplicacao_new_w || qt_solucao_new_w);--'Substituído "Aplicação (h/min/ml)" de '|| qt_hora_aplicacao_old_w ||'/'|| qt_min_aplicacao_old_w || '/'|| qt_solucao_old_w ||' para '|| qt_hora_aplicacao_new_w ||'/'|| qt_min_aplicacao_new_w || '/'|| qt_solucao_new_w || chr(13);
end if;

if (ds_historico_w IS NOT NULL AND ds_historico_w::text <> '') then
	insert	into	prescr_hist_farm(nr_prescricao,
			cd_pessoa_fisica,
			dt_registro,
			dt_liberacao,
			nr_seq_tipo_hist,
			ds_historico,
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec)
	values (nr_prescricao_p,
			obter_pessoa_fisica_usuario(nm_usuario_p,'C'),
			clock_timestamp(),
			clock_timestamp(),
			nr_seq_tipo_hist_w,
			ds_historico_w,
			nextval('prescr_hist_farm_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p);
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_hist_medic_subst_farm ( nr_prescricao_p bigint, nr_sequencia_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

