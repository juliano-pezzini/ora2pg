-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_gerar_medic_hist_saude (nr_atendimento_p bigint, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint, nr_seq_medic_p bigint, cd_paciente_p text, nr_seq_item_gerado_p INOUT cpoe_material.nr_sequencia%type, ie_medicacao_paciente_p text default null, nr_seq_cpoe_rp_p cpoe_material.nr_seq_cpoe_rp%type default null, nr_seq_cpoe_order_unit_p cpoe_material.nr_seq_cpoe_order_unit%type default null) AS $body$
DECLARE


cd_intervalo_w				cpoe_material.cd_intervalo%type;
cd_intervalo_agora_w		cpoe_material.cd_intervalo%type;
cd_material_w				cpoe_material.cd_material%type;
cd_unidade_medida_w			cpoe_material.cd_unidade_medida%type;
cd_unid_med_padrao_w	    cpoe_material.cd_unidade_medida%type;
ds_horarios_aux_w			cpoe_material.ds_horarios%type;
ds_horarios_w				cpoe_material.ds_horarios%type;
ds_observacao_w				cpoe_material.ds_observacao%type;
dt_inicio_w					cpoe_material.dt_inicio%type;
dt_fim_origin_w				cpoe_material.dt_fim%type;
dt_fim_w					cpoe_material.dt_fim%type;
hr_prim_horario_w			cpoe_material.hr_prim_horario%type;
ie_administracao_w			cpoe_material.ie_administracao%type;
ie_antibiotico_w			cpoe_material.ie_antibiotico%type;
ie_duracao_w				cpoe_material.ie_duracao%type;
ie_ref_calculo_w			cpoe_material.ie_ref_calculo%type;
ie_medicacao_paciente_w		cpoe_material.ie_medicacao_paciente%type;
ie_urgencia_w				cpoe_material.ie_urgencia%type;
ie_via_aplicacao_w			cpoe_material.ie_via_aplicacao%type;
nr_ocorrencia_w				cpoe_material.nr_ocorrencia%type;
nr_sequencia_w				cpoe_material.nr_sequencia%type;
qt_dose_w					cpoe_material.qt_dose%type;
ie_dose_unica_cpoe_w  cpoe_material.ie_evento_unico%type;
ie_evento_unico_w  cpoe_material.ie_evento_unico%type;
ie_se_necessario_w  cpoe_material.ie_se_necessario%type;
ie_acm_w  cpoe_material.ie_acm%type;

qt_min_intervalo_w			intervalo_prescricao.qt_min_intervalo%type;

ds_justificativa_w			protocolo_medic_material.ds_justificativa%type;

c01 CURSOR FOR
SELECT	a.cd_material cd_material,
	a.qt_dose qt_dose,
	a.cd_intervalo cd_intervalo,
	a.ie_via_aplicacao ie_via_aplicacao,
	a.cd_unid_med cd_unid_med,
	a.dt_fim dt_fim,
	coalesce(b.ie_utiliza_internacao,'N') ie_medicacao_paciente,
	a.ds_observacao,
  	a.ds_horarios
FROM paciente_medic_uso a
LEFT OUTER JOIN hist_saude_reconciliacao b ON (a.nr_sequencia = b.nr_seq_pac_hist)
WHERE coalesce(a.cd_material,0) <> 0 and a.cd_pessoa_fisica = cd_paciente_p and a.nr_sequencia = nr_seq_medic_p;


BEGIN

open c01;
loop
fetch c01 into
	cd_material_w,
	qt_dose_w,
	cd_intervalo_w,
	ie_via_aplicacao_w,
	cd_unidade_medida_w,
	dt_fim_origin_w,
	ie_medicacao_paciente_w,
	ds_observacao_w,
  	ds_horarios_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	hr_prim_horario_w	:= '';
	dt_inicio_w	 		:= clock_timestamp();
	dt_fim_w 			:= null;

	ie_administracao_w	:= 'P';
	ie_urgencia_w		:= null;
	ie_ref_calculo_w	:= '';
	ds_justificativa_w	:= '';

	if (coalesce(ie_via_aplicacao_w::text, '') = '') then
		select	max(ie_via_aplicacao)
		into STRICT	ie_via_aplicacao_w
		from	material
		where	cd_material = cd_material_w;
	end if;

	if (coalesce(obter_se_marca_agora(cpoe_obter_setor_atend_prescr(nr_atendimento_p, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p)),'N') = 'S') then
		cd_intervalo_agora_w := cpoe_busca_intervalo_agora(nr_atendimento_p,'M',cd_estabelecimento_p,cd_perfil_p, nm_usuario_p);

		if (cd_intervalo_agora_w IS NOT NULL AND cd_intervalo_agora_w::text <> '') then
			cd_intervalo_w := cd_intervalo_agora_w;
			ie_urgencia_w := '0';
			ie_ref_calculo_w := 'I';
		end if;
	end if;

  select max(qt_min_intervalo),
      coalesce(max(ie_dose_unica_cpoe), 'N')
  into STRICT qt_min_intervalo_w,
      ie_dose_unica_cpoe_w
  from intervalo_prescricao
  where cd_intervalo = cd_intervalo_w;

  if (coalesce(ie_dose_unica_cpoe_w, 'N') = 'S') then
    ie_duracao_w := 'P';
    ie_se_necessario_w := 'N';
    ie_acm_w := 'N';
    ie_evento_unico_w := 'S';
  end if;

	if ((dt_fim_origin_w IS NOT NULL AND dt_fim_origin_w::text <> '') or ie_duracao_w = 'P') then
		ie_duracao_w := 'P';
		dt_fim_w := (dt_inicio_w + 1) - 1/1440;
	else
		ie_duracao_w := 'C';
	end if;

	if (coalesce(ie_urgencia_w::text, '') = '') then
        hr_prim_horario_w := CPOE_Obter_primeiro_horario(nr_atendimento_p,cd_intervalo_w,cd_material_w,cd_estabelecimento_p,cd_perfil_p,nm_usuario_p,cd_paciente_p);
		if (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '')then
            dt_inicio_w := to_date(to_char(clock_timestamp(), 'dd/mm/yyyy') || ' ' || hr_prim_horario_w, 'dd/mm/yyyy hh24:mi');
            if (dt_inicio_w < clock_timestamp()) then
                dt_inicio_w := dt_inicio_w + 1;
            end if;
            hr_prim_horario_w := '';
        else
            dt_inicio_w := trunc(dt_inicio_w,'hh24') + 1/24;
        end if;
	elsif (ie_urgencia_w = '0') then
		dt_inicio_w := trunc(dt_inicio_w,'hh24') + 1/1440;
	end if;

	hr_prim_horario_w := to_char(dt_inicio_w,'hh24:mi');

	nr_ocorrencia_w := 0;
  	
  	ds_horarios_w := replace(Padroniza_horario_prescr(ds_horarios_w, null), 'A', '');
  	if ((obter_prim_dshorarios(ds_horarios_w) IS NOT NULL AND (obter_prim_dshorarios(ds_horarios_w))::text <> '')) then
    	ds_horarios_w := cpoe_reordenar_horarios(dt_inicio_w, ds_horarios_w);
    	dt_inicio_w := to_date(to_char(dt_inicio_w, 'dd/mm/yyyy') || ' ' || obter_prim_dshorarios(ds_horarios_w) || ':00', 'dd/mm/yyyy hh24:mi:ss');
    	hr_prim_horario_w := to_char(dt_inicio_w,'hh24:mi');
    	nr_ocorrencia_w := obter_quantidade_horarios(ds_horarios_w);
    	if (dt_inicio_w < clock_timestamp()) then
    		dt_inicio_w := dt_inicio_w + 1;
    	end if;
		if (ie_duracao_w = 'P') then
			dt_fim_w := (dt_inicio_w + 1) - 1/1440;
		end if;
  	else
		SELECT * FROM cpoe_calcular_horario_prescr(	nr_atendimento_p, cd_intervalo_w, cd_material_w, dt_inicio_w, 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;

		ds_horarios_w	:= ds_horarios_w||ds_horarios_aux_w;

		ds_horarios_w := REPLACE(Padroniza_horario_prescr(ds_horarios_w,NULL),'A','');
  	end if;

	ie_antibiotico_w := coalesce(obter_se_mat_antibiotico(cd_material_w),'N');

	if (coalesce(ie_antibiotico_w,'N') = 'S') then
		ie_duracao_w := 'P';
		dt_fim_w := (dt_inicio_w + 1) - 1/1440;

		if	((coalesce(ds_justificativa_w::text, '') = '') or (ds_justificativa_w = '')) then
			ds_justificativa_w := wheb_mensagem_pck.get_texto(346895);
		end if;
	end if;

   cd_unid_med_padrao_w := obter_unidade_medida_med(cd_material_w, cd_estabelecimento_p);

	select	nextval('cpoe_material_seq')
	into STRICT	nr_sequencia_w
	;

    if (ie_medicacao_paciente_p IS NOT NULL AND ie_medicacao_paciente_p::text <> '')then
        ie_medicacao_paciente_w := ie_medicacao_paciente_p;
    end if;

	insert into cpoe_material(
				nr_sequencia,
				nr_atendimento,
				cd_pessoa_fisica,
				nm_usuario,
				dt_atualizacao,
				nm_usuario_nrec,
				dt_atualizacao_nrec,
				dt_inicio,
				dt_fim,
				ds_horarios,
				hr_prim_horario,
				cd_intervalo,
				cd_material,
				cd_unidade_medida,
				ds_observacao,
				ie_administracao,
				ie_antibiotico,
				ie_controle_tempo,
				ie_duracao,
				ie_medicacao_paciente,
				ie_ref_calculo,
				ie_urgencia,
				ie_via_aplicacao,
				nr_ocorrencia,
				qt_dose,
				qt_tempo_aplicacao,
				cd_perfil_ativo,
				ie_material,
				cd_funcao_origem,
        ie_alterou_horario,
        nr_seq_cpoe_rp,
        nr_seq_cpoe_order_unit,
        ie_se_necessario,
        ie_acm,
        ie_evento_unico)
			values (
				nr_sequencia_w,
				nr_atendimento_p,
				cd_paciente_p,
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				dt_inicio_w,
				dt_fim_w,
				ds_horarios_w,
				hr_prim_horario_w,
				cd_intervalo_w,
				cd_material_w,
				coalesce(cd_unidade_medida_w, cd_unid_med_padrao_w),
				ds_observacao_w,
				ie_administracao_w,
				ie_antibiotico_w,
				'N',
				ie_duracao_w,
				ie_medicacao_paciente_w,
				ie_ref_calculo_w,
				ie_urgencia_w,
				ie_via_aplicacao_w,
				nr_ocorrencia_w,
				qt_dose_w,
				24,
				cd_perfil_p,
				'N',
				2314,
        'N',
        nr_seq_cpoe_rp_p,
        nr_seq_cpoe_order_unit_p,
        ie_se_necessario_w,
        ie_acm_w,
        ie_evento_unico_w);

	nr_seq_item_gerado_p := nr_sequencia_w;

  CALL cpoe_consis_med_insert(nr_seq_item_gerado_p,nm_usuario_p);

	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_gerar_medic_hist_saude (nr_atendimento_p bigint, nm_usuario_p text, cd_perfil_p bigint, cd_estabelecimento_p bigint, nr_seq_medic_p bigint, cd_paciente_p text, nr_seq_item_gerado_p INOUT cpoe_material.nr_sequencia%type, ie_medicacao_paciente_p text default null, nr_seq_cpoe_rp_p cpoe_material.nr_seq_cpoe_rp%type default null, nr_seq_cpoe_order_unit_p cpoe_material.nr_seq_cpoe_order_unit%type default null) FROM PUBLIC;

