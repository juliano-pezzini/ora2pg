-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_status_coleta_mat (nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_proced_p text, nr_seq_prescr_proc_mat_p bigint, ie_status_atend_p bigint, nm_usuario_p text, ie_chamada_amostra_p text, ie_adm_exam_adep_p text, ie_consistir_alt_peso_p text, ie_chamada_barras_p text, ds_sql_item_p text, ie_registrar_medic_uso_p text, ds_sql_material_p text, ds_mensagem_p INOUT text, ds_mensagem_medic_uso_p INOUT text, qt_itens_coleta_p INOUT bigint) AS $body$
DECLARE


ie_exige_w		varchar(1);
ds_sep_bv_w		varchar(10);
qt_exame_medic_uso_w	bigint;

BEGIN
  if (coalesce(obter_dados_usuario_opcao(nm_usuario_p,'C')::text, '') = '') then
    CALL wheb_mensagem_pck.exibir_mensagem_abort(1004937,'NM_USUARIO_P='||nm_usuario_p);
  end if;

  ds_sep_bv_w := obter_separador_bv;
  ie_exige_w := lab_obter_se_exige_alt_peso(nr_prescricao_p, nr_seq_prescr_p);	

  if (ie_consistir_alt_peso_p = 'S') and (ie_chamada_barras_p = 'N') and (ie_exige_w = 'S') then

	   ds_mensagem_p := obter_desc_expressao(620355);
  end if;

  if (ie_adm_exam_adep_p = 'S') then
  	CALL Lab_Administrar_Exame_Adep(nr_prescricao_p, nr_seq_proced_p, nm_usuario_p);
  end if;

  if (ie_chamada_amostra_p = 'S') then
    begin
      select count(*)
      	into STRICT qt_itens_coleta_p
      	from prescr_procedimento a, prescr_proc_mat_item b
       where a.nr_prescricao = b.nr_prescricao
         and a.nr_sequencia = b.nr_seq_prescr
         and a.nr_prescricao = nr_prescricao_p
         and a.ie_status_atend = ie_status_atend_p
         and b.nr_seq_prescr_proc_mat = nr_seq_prescr_proc_mat_p
         and a.cd_material_exame in (SELECT cd_material_exame 
                                       from material_exame_lab 
                                      where ie_amostra_coleta = 'S');
    end;
  else				
  	if (ds_sql_material_p IS NOT NULL AND ds_sql_material_p::text <> '') then
  		begin
        select count(*)
      		into STRICT qt_itens_coleta_p
      		from prescr_procedimento
      	 where nr_prescricao = nr_prescricao_p
       		 and ie_status_atend = ie_status_atend_p
        	 and cd_material_exame in (SELECT cd_material_exame
                          						 from material_exame_lab 
                            					where ie_amostra_coleta = 'S'
                          						  and obter_se_contido_char(nr_sequencia, ds_sql_material_p) = 'S');
      end;
    else
  		begin
        select count(*)
      		into STRICT qt_itens_coleta_p
      		from prescr_procedimento
      	 where nr_prescricao = nr_prescricao_p
      		 and ie_status_atend = ie_status_atend_p
        	 and cd_material_exame in (SELECT cd_material_exame
                              				 from material_exame_lab 
                            					where ie_amostra_coleta = 'S');
      end;
    end if;
  end if;				

  if (ie_registrar_medic_uso_p = 'S') then		
  	qt_exame_medic_uso_w := obter_valor_dinamico_bv(' select nvl(count(*),0) '||
                    				'   from exame_laboratorio e, prescr_procedimento c '||
                      			'  where e.ie_necessita_medic_uso = '|| 'S'||
                    				'    and e.nr_seq_exame = c.nr_seq_exame ' ||ds_sql_item_p ||
                    				'    and c.nr_prescricao = :nr_prescricao ', 'nr_prescricao='||to_char(nr_prescricao_p) ||ds_sep_bv_w, qt_exame_medic_uso_w);

  	if (qt_exame_medic_uso_w > 0) then
  		ds_mensagem_medic_uso_p := ' '||obter_desc_expressao(779535);
  	end if;
  end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_status_coleta_mat (nr_prescricao_p bigint, nr_seq_prescr_p bigint, nr_seq_proced_p text, nr_seq_prescr_proc_mat_p bigint, ie_status_atend_p bigint, nm_usuario_p text, ie_chamada_amostra_p text, ie_adm_exam_adep_p text, ie_consistir_alt_peso_p text, ie_chamada_barras_p text, ds_sql_item_p text, ie_registrar_medic_uso_p text, ds_sql_material_p text, ds_mensagem_p INOUT text, ds_mensagem_medic_uso_p INOUT text, qt_itens_coleta_p INOUT bigint) FROM PUBLIC;

