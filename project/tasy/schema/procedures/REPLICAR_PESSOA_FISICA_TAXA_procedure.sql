-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE replicar_pessoa_fisica_taxa (nr_sequencia_p atendimento_paciente.nr_atendimento%TYPE, nr_seq_episodio_p atendimento_paciente.nr_seq_episodio%TYPE, nr_atendimento_p atendimento_paciente.nr_atendimento%TYPE, cd_convenio_p atend_categoria_convenio.cd_convenio%TYPE, cd_categoria_p atend_categoria_convenio.cd_categoria%TYPE, ie_delete_p text DEFAULT 'N') AS $body$
DECLARE


    cur_atend_pessoa_fisica CURSOR FOR
        SELECT	atepac.nr_seq_episodio,
                atepac.nr_atendimento,
                atepac.cd_pessoa_fisica,
                atcapa.cd_convenio,
                atcapa.cd_categoria,
                pefita.qt_dias_pagamento,
                pefita.nr_seq_justificativa,
                pefita.nr_seq_atecaco,
                pefita.ie_obriga_pag_adicional,
                pefita.dt_pagamento
        FROM	atendimento_paciente atepac,
                atend_categoria_convenio atcapa,
                pessoa_fisica_taxa pefita
        WHERE	atepac.nr_atendimento = atcapa.nr_atendimento
        AND     atcapa.nr_seq_interno = pefita.nr_seq_atecaco
        AND	    pefita.nr_sequencia = nr_sequencia_p;

    rec_atend_pessoa_fisica	cur_atend_pessoa_fisica%rowtype;

    cur_atend_pessoa_copiar CURSOR(nr_seq_episodio_p bigint,
                                   cd_convenio_p bigint,
                                   cd_categoria_p text,
                                   nr_atendimento_p bigint) FOR
        SELECT	atepac.nr_atendimento
        FROM	atendimento_paciente atepac,
                atend_categoria_convenio atcapa
        WHERE	atepac.nr_atendimento = atcapa.nr_atendimento
        AND	    atepac.nr_seq_episodio = nr_seq_episodio_p
        AND     atcapa.cd_convenio = cd_convenio_p
        AND     atcapa.cd_categoria = cd_categoria_p
        AND     atepac.nr_atendimento <> nr_atendimento_p
        AND     coalesce(atepac.dt_cancelamento::text, '') = '';

    rec_atend_pessoa_copiar	cur_atend_pessoa_copiar%rowtype;

    cur_pessoa_fisica_taxa CURSOR(cd_convenio_p bigint,
                                  cd_categoria_p text,
                                  nr_atendimento_p bigint) FOR
        SELECT	pefita.nr_sequencia
        FROM	atendimento_paciente atepac,
                atend_categoria_convenio atcapa,
                pessoa_fisica_taxa pefita
        WHERE	atepac.nr_atendimento = atcapa.nr_atendimento
        AND     atcapa.nr_seq_interno = pefita.nr_seq_atecaco
        AND     atepac.nr_atendimento = nr_atendimento_p
        AND     atcapa.cd_convenio = cd_convenio_p
        AND     atcapa.cd_categoria = cd_categoria_p
        AND     coalesce(atepac.dt_cancelamento::text, '') = '';

    rec_pessoa_fisica_taxa	cur_pessoa_fisica_taxa%rowtype;

    pessoa_fisica_taxa_w  pessoa_fisica_taxa%rowtype;
    nr_seq_interno_w      atend_categoria_convenio.nr_seq_interno%TYPE;

BEGIN
    IF (ie_delete_p = 'N') THEN
        OPEN cur_atend_pessoa_fisica;
            LOOP
            FETCH cur_atend_pessoa_fisica INTO rec_atend_pessoa_fisica;
            EXIT WHEN NOT FOUND; /* apply on cur_atend_pessoa_fisica */
            BEGIN
                OPEN cur_atend_pessoa_copiar(rec_atend_pessoa_fisica.nr_seq_episodio,
                                             rec_atend_pessoa_fisica.cd_convenio,
                                             rec_atend_pessoa_fisica.cd_categoria,
                                             rec_atend_pessoa_fisica.nr_atendimento);
                    LOOP
                    FETCH cur_atend_pessoa_copiar INTO rec_atend_pessoa_copiar;
                    EXIT WHEN NOT FOUND; /* apply on cur_atend_pessoa_copiar */

                    BEGIN
                        SELECT 	nr_seq_interno
                        INTO STRICT	nr_seq_interno_w
                        FROM	atend_categoria_convenio
                        WHERE	nr_atendimento	= rec_atend_pessoa_copiar.nr_atendimento
                        AND     cd_convenio		= rec_atend_pessoa_fisica.cd_convenio
                        AND     cd_categoria	= rec_atend_pessoa_fisica.cd_categoria  LIMIT 1;
                    EXCEPTION
                        WHEN OTHERS THEN
                            nr_seq_interno_w := NULL;
                    END;
                    --
                    BEGIN
                        SELECT 	*
                        INTO STRICT	pessoa_fisica_taxa_w
                        FROM	pessoa_fisica_taxa
                        WHERE	nr_seq_atecaco = nr_seq_interno_w;
                    EXCEPTION
                        WHEN OTHERS THEN
                            pessoa_fisica_taxa_w.nr_sequencia := NULL;
                    END;
                    --
                    pessoa_fisica_taxa_w.qt_dias_pagamento          := rec_atend_pessoa_fisica.qt_dias_pagamento;
                    pessoa_fisica_taxa_w.nr_seq_justificativa       := rec_atend_pessoa_fisica.nr_seq_justificativa;
                    pessoa_fisica_taxa_w.nr_seq_atecaco             := nr_seq_interno_w;
                    pessoa_fisica_taxa_w.nr_atendimento             := coalesce(nr_atendimento_p, rec_atend_pessoa_fisica.nr_atendimento);
                    pessoa_fisica_taxa_w.nm_usuario_nrec            := wheb_usuario_pck.get_nm_usuario();
                    pessoa_fisica_taxa_w.nm_usuario                 := wheb_usuario_pck.get_nm_usuario();
                    pessoa_fisica_taxa_w.ie_obriga_pag_adicional    := rec_atend_pessoa_fisica.ie_obriga_pag_adicional;
                    pessoa_fisica_taxa_w.dt_pagamento               := rec_atend_pessoa_fisica.dt_pagamento;
                    pessoa_fisica_taxa_w.dt_atualizacao_nrec        := clock_timestamp();
                    pessoa_fisica_taxa_w.dt_atualizacao             := clock_timestamp();
                    pessoa_fisica_taxa_w.cd_pessoa_fisica           := rec_atend_pessoa_fisica.cd_pessoa_fisica;
                    --
                    IF (coalesce(pessoa_fisica_taxa_w.nr_sequencia::text, '') = '') THEN
                        BEGIN
                            SELECT  nextval('pessoa_fisica_taxa_seq')
                            INTO STRICT	pessoa_fisica_taxa_w.nr_sequencia
;
                            --
                            INSERT INTO pessoa_fisica_taxa values (pessoa_fisica_taxa_w.*);
                        END;
                    ELSE
                        UPDATE	pessoa_fisica_taxa
                        SET ROW = pessoa_fisica_taxa_w
                        WHERE	nr_sequencia = pessoa_fisica_taxa_w.nr_sequencia;
                    END IF;
                END LOOP;
                CLOSE cur_atend_pessoa_copiar;
            END;
        END LOOP;
        CLOSE cur_atend_pessoa_fisica;
    ELSE
        OPEN cur_atend_pessoa_copiar(nr_seq_episodio_p,
                                     cd_convenio_p,
                                     cd_categoria_p,
                                     nr_atendimento_p);
        LOOP
        FETCH cur_atend_pessoa_copiar INTO rec_atend_pessoa_copiar;
        EXIT WHEN NOT FOUND; /* apply on cur_atend_pessoa_copiar */
            OPEN cur_pessoa_fisica_taxa(cd_convenio_p,
                                        cd_categoria_p,
                                        rec_atend_pessoa_copiar.nr_atendimento);
            LOOP
            FETCH cur_pessoa_fisica_taxa INTO rec_pessoa_fisica_taxa;
            EXIT WHEN NOT FOUND; /* apply on cur_pessoa_fisica_taxa */
                BEGIN
                    DELETE FROM pessoa_fisica_taxa
                    WHERE nr_sequencia = rec_pessoa_fisica_taxa.nr_sequencia;
                END;
            END LOOP;
            CLOSE cur_pessoa_fisica_taxa;
        END LOOP;
        CLOSE cur_atend_pessoa_copiar;
    END IF;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE replicar_pessoa_fisica_taxa (nr_sequencia_p atendimento_paciente.nr_atendimento%TYPE, nr_seq_episodio_p atendimento_paciente.nr_seq_episodio%TYPE, nr_atendimento_p atendimento_paciente.nr_atendimento%TYPE, cd_convenio_p atend_categoria_convenio.cd_convenio%TYPE, cd_categoria_p atend_categoria_convenio.cd_categoria%TYPE, ie_delete_p text DEFAULT 'N') FROM PUBLIC;

