-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_tit_pagar_quota_part ( nr_seq_escrituracao_p text, cd_pessoa_fisica_p text, cd_cgc_p text, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_titulo_w			bigint;
cd_moeda_padrao_w		bigint;
cd_tipo_taxa_juro_w		bigint;
cd_tipo_taxa_multa_w		bigint;
nr_seq_motivo_lanc_mens_w	bigint;
nr_seq_trans_baixa_tit_neg_w	bigint;
nr_seq_trans_tit_neg_cr_w	bigint;
dt_vencimento_w			timestamp;
dt_lancamento_w			timestamp;
vl_parcela_w			double precision;
nr_sequencia_w			bigint;
pr_juro_padrao_w		double precision;
pr_multa_padrao_w		double precision;
nr_seq_conta_banco_w		bigint;
nr_seq_carteira_cobr_w		bigint;
nr_seq_trans_fin_contab_w	bigint;
nr_seq_trans_fin_baixa_w	bigint;

C01 CURSOR FOR 
	SELECT	nr_sequencia, 
		dt_vencimento, 
		vl_parcela 
	from	pls_escrit_quota_parcela 
	where	nr_seq_escrituracao	= nr_seq_escrituracao_p 
	order by 
		nr_sequencia;


BEGIN 
 
--Pegar Parâmetros negociação 
begin 
select	cd_tipo_taxa_juro, 
	cd_tipo_taxa_multa, 
	cd_moeda_padrao, 
	pr_juro_padrao, 
	pr_multa_padrao 
into STRICT	cd_tipo_taxa_juro_w, 
	cd_tipo_taxa_multa_w, 
	cd_moeda_padrao_w, 
	pr_juro_padrao_w, 
	pr_multa_padrao_w 
from	parametros_contas_pagar 
where	cd_estabelecimento	= cd_estabelecimento_p;
exception 
when no_data_found then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort( 267307, null ); /* Não foram encontrados os parâmetros do contas a pagar. Por favor verifique. */
end;
 
select	trunc(dt_lancamento,'dd') 
into STRICT	dt_lancamento_w 
from	pls_escrituracao_quota 
where	nr_sequencia	= nr_seq_escrituracao_p;
 
SELECT * FROM pls_obter_reg_escrit_quotas(	'P', dt_lancamento_w, nm_usuario_p, nr_seq_conta_banco_w, nr_seq_carteira_cobr_w, nr_seq_trans_fin_contab_w, nr_seq_trans_fin_baixa_w) INTO STRICT nr_seq_conta_banco_w, nr_seq_carteira_cobr_w, nr_seq_trans_fin_contab_w, nr_seq_trans_fin_baixa_w;
 
open C01;
loop 
fetch C01 into 
	nr_sequencia_w, 
	dt_vencimento_w, 
	vl_parcela_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	select	nextval('titulo_seq') 
	into STRICT	nr_titulo_w 
	;
	 
	insert into titulo_pagar(nr_titulo,    
		cd_estabelecimento, 
		dt_atualizacao, 
		nm_usuario, 
		dt_emissao, 
		dt_vencimento_original, 
		dt_vencimento_atual, 
		vl_titulo, 
		vl_saldo_titulo, 
		vl_saldo_juros, 
		vl_saldo_multa, 
		cd_moeda, 
		tx_juros, 
		tx_multa, 
		cd_tipo_taxa_juro, 
		cd_tipo_taxa_multa, 
		ie_situacao, 
		ie_origem_titulo, 
		ie_tipo_titulo, 
		cd_cgc, 
		cd_pessoa_fisica, 
		nr_seq_trans_fin_contab, 
		nr_seq_trans_fin_baixa) 
	values (nr_titulo_w, 
		cd_estabelecimento_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		dt_lancamento_w, 
		dt_vencimento_w, 
		dt_vencimento_w, 
		vl_parcela_w, 
		vl_parcela_w, 
		0, 
		0, 
		cd_moeda_padrao_w, 
		pr_juro_padrao_w, 
		pr_multa_padrao_w, 
		cd_tipo_taxa_juro_w, 
		cd_tipo_taxa_multa_w, 
		'A', 
		'7', /* Escrituração de quotas */
 
		'1', /* Bloqueto */
 
		cd_cgc_p, 
		cd_pessoa_fisica_p, 
		nr_seq_trans_fin_contab_w, 
		nr_seq_trans_fin_baixa_w);
	 
	CALL atualizar_inclusao_tit_pagar(nr_titulo_w,nm_usuario_p);
	 
	update	pls_escrit_quota_parcela 
	set	nr_tit_pagar	= nr_titulo_w, 
		dt_atualizacao	= clock_timestamp(), 
		nm_usuario	= nm_usuario_p 
	where	nr_sequencia	= nr_sequencia_w;
	 
	end;
end loop;
close C01;
 
update	pls_escrituracao_quota 
set	dt_geracao_titulos	= clock_timestamp(), 
	dt_liberacao		= clock_timestamp() 
where	nr_sequencia		= nr_seq_escrituracao_p;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_tit_pagar_quota_part ( nr_seq_escrituracao_p text, cd_pessoa_fisica_p text, cd_cgc_p text, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

