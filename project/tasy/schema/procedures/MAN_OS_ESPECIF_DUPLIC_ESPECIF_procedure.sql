-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_os_especif_duplic_especif ( nr_seq_especif_p bigint, nr_seq_ordem_serv_p bigint, nm_usuario_p text ) AS $body$
DECLARE


nr_seq_especificacao_w			man_os_especificacao.nr_sequencia%type;
nr_versao_w				man_os_especificacao.nr_versao%type;
ds_objetivo_w				man_os_especificacao.ds_objetivo%type;
ds_observacao_w				man_os_especificacao.ds_observacao%type;
ie_tipo_anexo_w				varchar(1);
nr_seq_pai_anexo_w			bigint;
nr_seq_especif_teste_ant_w		man_os_especif_teste.nr_sequencia%type;
nr_seq_especif_teste_w			man_os_especif_teste.nr_sequencia%type;
ds_pre_requisitos_w			man_os_especif_teste.ds_pre_requisitos%type;
nr_seq_anexo_w				bigint;
nr_seq_detalhe_w			bigint;
nr_seq_to_do_w				bigint;
nr_seq_teste_caso_w			bigint;
nr_seq_teste_evidencia_w		bigint;
c02_nr_sequencia_w			bigint;
c04_nr_sequencia_w			bigint;

c01 CURSOR FOR
SELECT	nr_sequencia,
	nr_anexo,
	ie_tipo,
	ds_nome,
	ds_arquivo
from	man_os_especif_anexo
where	(
		(ie_tipo_anexo_w = 'A' and nr_seq_especificacao = nr_seq_pai_anexo_w) or (ie_tipo_anexo_w = 'R' and nr_seq_detalhe = nr_seq_pai_anexo_w) or (ie_tipo_anexo_w = 'I' and nr_seq_to_do = nr_seq_pai_anexo_w)
	)
order by nr_anexo;

c02 CURSOR FOR
SELECT	nr_sequencia,
	ie_tipo,
	nr_numero,
	nm_detalhe,
	ds_especificacao,
	qt_minutos_prev
from	man_os_especif_detalhe
where	nr_seq_especificacao = nr_seq_especif_p
order by nr_numero;

c03 CURSOR FOR
SELECT	nr_sequencia,
	nr_ordem,
	nm_atividade,
	qt_min_prev,
	ds_atividade
from	man_os_especif_det_to_do
where	nr_seq_detalhe = c02_nr_sequencia_w
order by nr_ordem;

c04 CURSOR FOR
SELECT	nr_sequencia,
	nr_caso_teste,
	ds_titulo_teste,
	ds_caso_teste
from	man_os_especif_teste_caso
where	nr_seq_especif_teste = nr_seq_especif_teste_ant_w
order by nr_caso_teste;

c05 CURSOR FOR
SELECT	ie_tipo,
	ds_arquivo
from	man_os_teste_evidencia
where	nr_seq_teste_caso = c04_nr_sequencia_w;

c01_w					c01%rowtype;
c02_w					c02%rowtype;
c03_w					c03%rowtype;
c04_w					c04%rowtype;
c05_w					c05%rowtype;


BEGIN

	select	nextval('man_os_especificacao_seq')
	into STRICT	nr_seq_especificacao_w
	;

	select	coalesce(max(nr_versao), 0) + 1
	into STRICT	nr_versao_w
	from	man_os_especificacao
	where	nr_seq_ordem_servico = nr_seq_ordem_serv_p;

	select	ds_objetivo,
		ds_observacao
	into STRICT	ds_objetivo_w,
		ds_observacao_w
	from	man_os_especificacao
	where	nr_sequencia = nr_seq_especif_p;

	insert into man_os_especificacao(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_ordem_servico,
		nr_versao,
		ds_objetivo,
		ds_observacao,
		dt_liberacao,
		nm_usuario_liberacao )
	values (nr_seq_especificacao_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_ordem_serv_p,
		nr_versao_w,
		ds_objetivo_w,
		ds_observacao_w,
		null,
		null );

	ie_tipo_anexo_w := 'A';
	nr_seq_pai_anexo_w := nr_seq_especif_p;

	open c01;
	loop
	fetch c01 into
		c01_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

		select	nextval('man_os_especif_anexo_seq')
		into STRICT	nr_seq_anexo_w
		;

		insert into man_os_especif_anexo(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_especificacao,
			nr_seq_detalhe,
			nr_seq_to_do,
			nr_anexo,
			ie_tipo,
			ds_nome,
			ds_arquivo )
		values (nr_seq_anexo_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_especificacao_w,
			null,
			null,
			c01_w.nr_anexo,
			c01_w.ie_tipo,
			c01_w.ds_nome,
			c01_w.ds_arquivo );

	end;
	end loop;
	close c01;

	open c02;
	loop
	fetch c02 into
		c02_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
	begin

		c02_nr_sequencia_w := c02_w.nr_sequencia;

		select	nextval('man_os_especif_detalhe_seq')
		into STRICT	nr_seq_detalhe_w
		;

		insert into man_os_especif_detalhe(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_especificacao,
			ie_tipo,
			nr_numero,
			nm_detalhe,
			ds_especificacao,
			qt_minutos_prev )
		values (nr_seq_detalhe_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_especificacao_w,
			c02_w.ie_tipo,
			c02_w.nr_numero,
			c02_w.nm_detalhe,
			c02_w.ds_especificacao,
			c02_w.qt_minutos_prev );

		ie_tipo_anexo_w := 'R';
		nr_seq_pai_anexo_w := c02_w.nr_sequencia;

		open c01;
		loop
		fetch c01 into
			c01_w;
		EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

			select	nextval('man_os_especif_anexo_seq')
			into STRICT	nr_seq_anexo_w
			;

			insert into man_os_especif_anexo(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_especificacao,
				nr_seq_detalhe,
				nr_seq_to_do,
				nr_anexo,
				ie_tipo,
				ds_nome,
				ds_arquivo )
			values (nr_seq_anexo_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				null,
				nr_seq_detalhe_w,
				null,
				c01_w.nr_anexo,
				c01_w.ie_tipo,
				c01_w.ds_nome,
				c01_w.ds_arquivo );

		end;
		end loop;
		close c01;

		open c03;
		loop
		fetch c03 into
			c03_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
		begin

			select	nextval('man_os_especif_det_to_do_seq')
			into STRICT	nr_seq_to_do_w
			;

			insert into man_os_especif_det_to_do(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_detalhe,
				nr_ordem,
				nm_atividade,
				qt_min_prev,
				ds_atividade )
			values (nr_seq_to_do_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_detalhe_w,
				c03_w.nr_ordem,
				c03_w.nm_atividade,
				c03_w.qt_min_prev,
				c03_w.ds_atividade );

			ie_tipo_anexo_w := 'I';
			nr_seq_pai_anexo_w := c03_w.nr_sequencia;

			open c01;
			loop
			fetch c01 into
				c01_w;
			EXIT WHEN NOT FOUND; /* apply on c01 */
			begin

				select	nextval('man_os_especif_anexo_seq')
				into STRICT	nr_seq_anexo_w
				;

				insert into man_os_especif_anexo(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_especificacao,
					nr_seq_detalhe,
					nr_seq_to_do,
					nr_anexo,
					ie_tipo,
					ds_nome,
					ds_arquivo )
				values (nr_seq_anexo_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					null,
					null,
					nr_seq_to_do_w,
					c01_w.nr_anexo,
					c01_w.ie_tipo,
					c01_w.ds_nome,
					c01_w.ds_arquivo );

			end;
			end loop;
			close c01;

		end;
		end loop;
		close c03;

	end;
	end loop;
	close c02;

	select	max(nr_sequencia)
	into STRICT	nr_seq_especif_teste_ant_w
	from	man_os_especif_teste
	where	nr_seq_especificacao = nr_seq_especif_p;

	if (nr_seq_especif_teste_ant_w IS NOT NULL AND nr_seq_especif_teste_ant_w::text <> '') then

		select	ds_pre_requisitos
		into STRICT	ds_pre_requisitos_w
		from	man_os_especif_teste
		where	nr_sequencia = nr_seq_especif_teste_ant_w;

		select	nextval('man_os_especif_teste_seq')
		into STRICT	nr_seq_especif_teste_w
		;

		insert into man_os_especif_teste(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_especificacao,
			ds_pre_requisitos )
		values (nr_seq_especif_teste_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_especificacao_w,
			ds_pre_requisitos_w );

		open c04;
		loop
		fetch c04 into
			c04_w;
		EXIT WHEN NOT FOUND; /* apply on c04 */
		begin

			c04_nr_sequencia_w := c04_w.nr_sequencia;

			select	nextval('man_os_especif_teste_caso_seq')
			into STRICT	nr_seq_teste_caso_w
			;

			insert into man_os_especif_teste_caso(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_especif_teste,
				nr_caso_teste,
				ds_titulo_teste,
				ds_caso_teste )
			values (nr_seq_teste_caso_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_especif_teste_w,
				c04_w.nr_caso_teste,
				c04_w.ds_titulo_teste,
				c04_w.ds_caso_teste );

			open c05;
			loop
			fetch c05 into
				c05_w;
			EXIT WHEN NOT FOUND; /* apply on c05 */
			begin

				select	nextval('man_os_teste_evidencia_seq')
				into STRICT	nr_seq_teste_evidencia_w
				;

				insert into man_os_teste_evidencia(
					nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_teste_caso,
					ie_tipo,
					ds_arquivo )
				values (nr_seq_teste_evidencia_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_teste_caso_w,
					c05_w.ie_tipo,
					c05_w.ds_arquivo );

			end;
			end loop;
			close c05;

		end;
		end loop;
		close c04;

	end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_os_especif_duplic_especif ( nr_seq_especif_p bigint, nr_seq_ordem_serv_p bigint, nm_usuario_p text ) FROM PUBLIC;

