-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_aprov_analise_impacto ( nr_seq_impacto_p bigint, nm_usuario_p text) AS $body$
DECLARE

qt_reg_w				bigint;
		
ds_cabecalho_w			text;
ds_rodape_w			text;
	
ds_tabela_w			text;
ds_html_w			text;
ds_ccb_title_w 			varchar(255);
ds_ccb_status_w			varchar(255);
nr_seq_os_w			bigint;
nr_seq_tipo_hist_w			man_tipo_hist.nr_sequencia%type;
ds_titulo_impacto_w		man_ordem_serv_impacto.ds_titulo%type;

qt_prs_impacto_w			smallint;

nm_system_analyst_aprov_w 		varchar(15);
nm_business_analyst_aprov_w 	varchar(15);

C01 CURSOR FOR
	SELECT 	a.dt_aprovacao,
		a.dt_reprovacao,
		a.ie_status,
		a.nm_usuario_aprov,
		a.nm_usuario_reprov,
		coalesce(a.dt_aprovacao,a.dt_reprovacao) dt_registro,
		b.ds_equipe,
		obter_nome_usuario(coalesce(a.nm_usuario_aprov,a.nm_usuario_reprov)) nm_pessoa,
		CASE WHEN a.ie_status='A' THEN  obter_desc_expressao_idioma(283709, 'Approved', 5)  ELSE obter_desc_expressao_idioma(306137, 'Rejected', 5) END  ds_status,
		CASE WHEN a.ie_status='A' THEN  null  ELSE a.ds_motivo_reprov END ds_motivo_reprov
	from	man_ordem_serv_aprov_ccb a,
		ccb_equipe b
	where	a.nr_seq_impacto = nr_seq_impacto_p
	and	a.nr_seq_equipe	 = b.nr_sequencia;

C02 CURSOR FOR
	SELECT 	b.nr_product_requirement nr_seq_pr,
		coalesce(a.ie_clinico, 'N') ie_clinico
	from 	reg_product_requirement a,
		man_ordem_serv_imp_pr b
	where 	a.nr_sequencia = b.nr_product_requirement
	and 	b.ie_impacto_requisito in ('A', 'I')
	and 	b.nr_seq_impacto = nr_seq_impacto_p;
BEGIN

select	count(1)
into STRICT	qt_reg_w
from	man_ordem_serv_aprov_ccb
where	nr_seq_impacto	= nr_seq_impacto_p
and	ie_status in ('R');

if (qt_reg_w	= 0) then	
	select	max(a.nm_usuario_aprov)
	into STRICT	nm_system_analyst_aprov_w
	from	man_ordem_serv_aprov_ccb a,
		ccb_equipe b
	where	a.nr_seq_impacto = nr_seq_impacto_p
	and	b.nr_sequencia = a.nr_seq_equipe
	and	b.ie_tipo_equipe = 'SA'; -- Systems analyst
	
	if ((nm_system_analyst_aprov_w IS NOT NULL AND nm_system_analyst_aprov_w::text <> '') or (nm_business_analyst_aprov_w IS NOT NULL AND nm_business_analyst_aprov_w::text <> '')) then	
		for r_c02 in c02 loop
			if (r_c02.ie_clinico = 'S') then
				CALL reg_toggle_pr_manager_approval(r_c02.nr_seq_pr, nm_business_analyst_aprov_w, 'S');
			else
				CALL reg_toggle_pr_manager_approval(r_c02.nr_seq_pr, nm_system_analyst_aprov_w, 'S');
			end if;
		end loop;
	end if;
	
	update	man_ordem_serv_impacto
	set	dt_aprovacao = clock_timestamp()
	where	nr_sequencia = nr_seq_impacto_p;

	CALL man_atualiza_pr_title(nr_seq_impacto_p, nm_usuario_p);

	ds_ccb_status_w	:= obter_desc_expressao_idioma(283709, 'Approved', 5);
	nr_seq_tipo_hist_w := 185; -- CCB Accepted
else
	ds_ccb_status_w	:= obter_desc_expressao_idioma(306137, 'Rejected', 5);
	nr_seq_tipo_hist_w := 184; -- CCB Rejected
end if;

select	nr_seq_ordem_serv,
	ds_titulo
into STRICT	nr_seq_os_w,
	ds_titulo_impacto_w
from	man_ordem_serv_impacto
where	nr_sequencia = nr_seq_impacto_p;

select 	CASE WHEN count(1)=0 THEN  'Technical Analysis'  ELSE 'CCB' END
into STRICT 	ds_ccb_title_w
from 	man_ordem_serv_imp_pr
where 	nr_seq_impacto = nr_seq_impacto_p
and 	ie_impacto_requisito in ('I', 'A', 'E');

ds_cabecalho_w	:= '<!DOCTYPE html>
<html>
<body><h2>' || ds_titulo_impacto_w || '</h2><h3>' || ds_ccb_title_w || ' Status: '||ds_ccb_status_w||
'</h3><br>

<table border="1" cellspacing="0" cellpadding="0" style="width:100%;border: 1px;">
<tbody align="left">
<tr>
<th>Approver</th>
<th>Role</th>
<th>Date</th>
<th>Status</th>
<th>Coments</th>
</tr>';

ds_rodape_w	:= '</tbody></table></body></html>';

for r_c01 in c01 loop
	begin
	ds_tabela_w	:= ds_tabela_w ||'<tr>'||
				 '<td>'|| r_c01.nm_pessoa ||'</td>'||
				 '<td>'|| r_c01.ds_equipe ||'</td>'||
				 '<td>'|| to_char(r_c01.dt_registro,'dd-Mon-yyyy', 'NLS_DATE_LANGUAGE=ENGLISH')  ||'</td>'||
				 '<td>'|| r_c01.ds_status ||'</td>'||
				 '<td>'|| r_c01.ds_motivo_reprov ||'</td>'||
				  '</tr>'||chr(10);
	end;
end loop;

if (nr_seq_os_w IS NOT NULL AND nr_seq_os_w::text <> '') then

	ds_html_w	:= ds_cabecalho_w||ds_tabela_w||ds_rodape_w;
	insert into man_ordem_serv_tecnico(	nr_sequencia,
						nr_seq_ordem_serv,
						dt_atualizacao,
						nm_usuario,
						ds_relat_tecnico,
						dt_historico,
						dt_liberacao,
						ie_origem,
						nr_seq_tipo)
						
				values (	nextval('man_ordem_serv_tecnico_seq'),
						nr_seq_os_w,
						clock_timestamp(),
						'Tasy',
						ds_html_w,
						clock_timestamp(),
						clock_timestamp(),
						'I',
						nr_seq_tipo_hist_w);

end if;
					
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_aprov_analise_impacto ( nr_seq_impacto_p bigint, nm_usuario_p text) FROM PUBLIC;

