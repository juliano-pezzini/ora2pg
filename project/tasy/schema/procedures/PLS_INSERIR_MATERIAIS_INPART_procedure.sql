-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inserir_materiais_inpart ( cd_material_externo_p plS_cad_material_inpart.cd_material_externo%type, cd_material_tasy_p plS_cad_material_inpart.cd_material_tasy%type, ie_sistema_externo_p plS_cad_material_inpart.ie_sistema_externo%type, ds_material_p plS_cad_material_inpart.ds_material%type, ds_reduzida_p plS_cad_material_inpart.ds_reduzida%type, ie_tipo_material_p plS_cad_material_inpart.ie_tipo_material%type, cd_unidade_medida_compra_p plS_cad_material_inpart.cd_unidade_medida_compra%type, cd_unidade_medida_estoque_p plS_cad_material_inpart.cd_unidade_medida_estoque%type, cd_unidade_medida_consumo_p plS_cad_material_inpart.cd_unidade_medida_consumo%type, cd_unidade_medida_solic_p plS_cad_material_inpart.cd_unidade_medida_solic%type, ie_consignado_p plS_cad_material_inpart.ie_consignado%type, ie_disponivel_mercado_p plS_cad_material_inpart.ie_disponivel_mercado%type, ie_obrig_via_aplicacao_p plS_cad_material_inpart.ie_obrig_via_aplicacao%type, ie_receita_p plS_cad_material_inpart.ie_receita%type, ie_cobra_paciente_p plS_cad_material_inpart.ie_cobra_paciente%type, ie_inf_ultima_compra_p plS_cad_material_inpart.ie_inf_ultima_compra%type, ie_preco_compra_p plS_cad_material_inpart.ie_preco_compra%type, ie_curva_abc_p plS_cad_material_inpart.ie_curva_abc%type, qt_conv_compra_estoque_p plS_cad_material_inpart.qt_conv_compra_estoque%type, qt_conv_estoque_consumo_p plS_cad_material_inpart.qt_conv_estoque_consumo%type, qt_minimo_multiplo_solic_p plS_cad_material_inpart.qt_minimo_multiplo_solic%type, cd_classe_material_p plS_cad_material_inpart.cd_classe_material%type, ie_material_estoque_p plS_cad_material_inpart.ie_material_estoque%type, ie_baixa_estoq_pac_p plS_cad_material_inpart.ie_baixa_estoq_pac%type, ie_requisicao_p plS_cad_material_inpart.ie_requisicao%type, ie_prescricao_p plS_cad_material_inpart.ie_prescricao%type, ie_padronizado_p plS_cad_material_inpart.ie_padronizado%type, ie_classif_custo_p plS_cad_material_inpart.ie_classif_custo%type, ie_controla_serie_p plS_cad_material_inpart.ie_controla_serie%type, cd_tabela_preco_p plS_cad_material_inpart.cd_tabela_preco%type, vl_preco_p plS_cad_material_inpart.vl_preco%type, cd_referencia_p plS_cad_material_inpart.cd_referencia%type, nr_registro_anvisa_p plS_cad_material_inpart.nr_registro_anvisa%type, dt_validade_reg_anvisa_p plS_cad_material_inpart.dt_validade_reg_anvisa%type, nr_seq_fabric_p plS_cad_material_inpart.nr_seq_fabric%type, ds_fabricante_p plS_cad_material_inpart.ds_fabricante%type, cd_cnpj_p plS_cad_material_inpart.cd_cnpj%type, ie_situacao_p plS_cad_material_inpart.ie_situacao%type, cd_material_tuss_p plS_cad_material_inpart.cd_material_tuss%type, nr_seq_lote_p pls_lote_material_inpart.nr_sequencia%type, ie_tipo_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_retorno_p INOUT pls_lote_material_inpart.nr_sequencia%type) AS $body$
DECLARE

 
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade: 
------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[] Objetos do dicionário [] Tasy (Delphi/Java) [] Portal [] Relatórios [] Outros: 
 ------------------------------------------------------------------------------------------------------------------ 
Pontos de atenção: ie_tipo_p =	1: Inserir Lote 
				2: Inserir Itens do lote 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 
qt_material_w		integer;
nr_seq_material_w	pls_material.nr_sequencia%type;
ds_erro_w		pls_ret_material_inpart.ds_erro%type;
nr_seq_estrutura_w	pls_regra_cad_mat_inpart.nr_seq_estrut_mat%type;
ie_status_w		varchar(1);
cd_material_w		material.cd_material%type;
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
cd_classe_material_w  plS_cad_material_inpart.cd_classe_material%type;

BEGIN
 
if (coalesce(cd_estabelecimento_p::text, '') = '') then 
	select	max(cd_estabelecimento) 
	into STRICT	cd_estabelecimento_w 
	from	pls_web_param_geral;
else 
	cd_estabelecimento_w := cd_estabelecimento_p;
end if;
 
if (ie_tipo_p = '1') then 
	insert into pls_lote_material_inpart(nr_sequencia, dt_importacao, dt_atualizacao, 
		dt_atualizacao_nrec, nm_usuario, nm_usuario_nrec, 
		cd_estabelecimento) 
	values (nextval('pls_lote_material_inpart_seq'), clock_timestamp(), clock_timestamp(), 
		clock_timestamp(), nm_usuario_p,	nm_usuario_p, 
		cd_estabelecimento_w) returning nr_sequencia into nr_seq_retorno_p;
	commit;
elsif (ie_tipo_p = '2') then 
	ds_erro_w := '';
	--Consistir material 
	if (ds_material_p = '') then 
		ds_erro_w := 'Descrição do material não informado';
	end if;
	 
	if (cd_unidade_medida_solic_p = '') then 
		ds_erro_w := ds_erro_w + 'Unidade de medida não informado';
	end if;
	 
	if (cd_material_tuss_p = '') then 
		ds_erro_w := ds_erro_w + 'Código TUSS do material não informado';
	end if;
	 
	if (ie_situacao_p = '') then 
		ds_erro_w := ds_erro_w + 'Situação do material não informado';
	end if;		
	if (coalesce(ds_erro_w::text, '') = '') then 
		qt_material_w := 0;
		 
		if (cd_material_tasy_p IS NOT NULL AND cd_material_tasy_p::text <> '') then 
			select	count(1) 
			into STRICT	qt_material_w 
			from	material 
			where	cd_material = somente_numero(cd_material_tasy_p);
		end if;
						 
		if (qt_material_w > 0) then 
			cd_material_w := somente_numero(cd_material_tasy_p);
			 
			update	material 
			set	ds_material			= substr((ds_material_p),1,255), 
				ds_reduzida			= substr((ds_reduzida_p),1,255), 
				cd_unidade_medida_compra	= cd_unidade_medida_compra_p, 
				cd_unidade_medida_estoque	= cd_unidade_medida_estoque_p, 
				cd_unidade_medida_consumo	= cd_unidade_medida_consumo_p, 
				ie_cobra_paciente        = ie_cobra_paciente_p, 
				ie_inf_ultima_compra		= ie_inf_ultima_compra_p, 
				ie_curva_abc          = ie_curva_abc_p, 
				ie_situacao           = ie_situacao_p, 
				dt_atualizacao			= clock_timestamp(), 
				nm_usuario           = nm_usuario_p, 
				qt_conv_compra_estoque     = qt_conv_compra_estoque_p, 
				qt_conv_estoque_consumo     = qt_conv_estoque_consumo_p, 
				ie_obrig_via_aplicacao		= ie_obrig_via_aplicacao_p, 
				ie_consignado          = ie_consignado_p, 
				cd_fabricante			= cd_referencia_p, 
				cd_unidade_medida_solic     = cd_unidade_medida_solic_p, 
				nr_seq_grupo_rec        = ie_receita_p				 
			where	cd_material <> cd_material_w;
		else 
			select	nextval('material_seq') 
			into STRICT	cd_material_w 
			;
			 
			select	coalesce(cd_classe_integracao, cd_classe_material_p) 
			into STRICT	cd_classe_material_w 
			from	parametros_opme 
			where	cd_estabelecimento = cd_estabelecimento_w 
			and	ie_sistema_integracao = 'I';
 
			insert into material( 
				cd_material,			ds_material, 
				ds_reduzida,			nr_seq_grupo_rec, 
				cd_unidade_medida_compra,	cd_unidade_medida_estoque, 
				cd_unidade_medida_consumo,	cd_material_estoque, 
				ie_tipo_material,		ie_receita, 
				ie_cobra_paciente,		ie_inf_ultima_compra,		 
				ie_curva_abc,			ie_baixa_inteira, 
				ie_situacao,			dt_cadastramento, 
				dt_atualizacao,			nm_usuario, 
				qt_minimo_multiplo_solic,	qt_conv_compra_estoque, 
				qt_conv_estoque_consumo,	ie_bomba_infusao, 
				ie_diluicao,			ie_solucao, 
				ie_mistura,			ie_abrigo_luz, 
				ie_umidade_controlada,		ie_gravar_obs_prescr, 
				ie_controle_medico,		ie_obrig_via_aplicacao, 
				ie_consignado,			ie_disponivel_mercado, 
				ie_material_direto,		ie_custo_benef, 
				ie_higroscopico,		ie_fotosensivel, 
				ie_mostrar_orientacao,		ie_dias_util_medic, 
				cd_fabricante,			cd_unidade_medida_solic, 
				cd_classe_material,		ie_material_estoque, 
				ie_baixa_estoq_pac) 
			values (	cd_material_w,			substr((ds_material_p),1,255), 
				substr((ds_reduzida_p),1,255),	ie_receita_p, 
				cd_unidade_medida_compra_p,	cd_unidade_medida_estoque_p, 
				cd_unidade_medida_consumo_p,	cd_material_w, 
				'1',				'N', 
				ie_cobra_paciente_p,		ie_inf_ultima_compra_p, 
				ie_curva_abc_p,			'S', 
				ie_situacao_p,			clock_timestamp(), 
				clock_timestamp(),			nm_usuario_p, 
				1,				qt_conv_compra_estoque_p, 
				qt_conv_estoque_consumo_p,	'N', 
				'N',				'N', 
				'N',				'N', 
				'N',				'N', 
				0,				ie_obrig_via_aplicacao_p, 
				ie_consignado_p,		'S', 
				'N',				'N', 
				'N',				'N', 
				'S',				'N', 
				cd_referencia_p,		cd_unidade_medida_solic_p, 
				cd_classe_material_w,		ie_material_estoque_p, 
				ie_baixa_estoq_pac_p);
		end if;
	 
		--procurar a estrutura do material conforme regra 
		select	max(nr_seq_estrut_mat) 
		into STRICT	nr_seq_estrutura_w 
		from	pls_regra_cad_mat_inpart 
		where	cd_estabelecimento = cd_estabelecimento_w;
		 
		-- Status -> Importado 
		ie_status_w := 'S';
		 
		select	max(nr_sequencia) 
		into STRICT	nr_seq_material_w 
		from	pls_material 
		where	cd_material = cd_material_w;
		 
		if (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') then 
			update	pls_material 
			set	cd_unidade_medida 	= cd_unidade_medida_solic_p, 
				ds_material		= ds_material_p, 
				nr_seq_estrut_mat	= nr_seq_estrutura_w, 
				dt_atualizacao		= clock_timestamp(), 
				cd_material_tuss_a900	= cd_material_tuss_p, 
				nr_registro_anvisa	= nr_registro_anvisa_p 
			where	nr_sequencia = nr_seq_material_w;
		else 
			insert into pls_material(nr_sequencia, cd_unidade_medida, ds_material, 
				ie_situacao, ie_tipo_despesa, dt_inclusao, 
				nr_seq_estrut_mat, cd_material_tuss_a900, nr_registro_anvisa, 
				dt_atualizacao, dt_atualizacao_nrec, nm_usuario, 
				cd_estabelecimento, cd_material) 
			values (nextval('pls_material_seq'), cd_unidade_medida_solic_p, ds_material_p, 
				ie_situacao_p, 7, clock_timestamp(), 
				nr_seq_estrutura_w, cd_material_tuss_p, nr_registro_anvisa_p, 
				clock_timestamp(), clock_timestamp(), nm_usuario_p, 
				cd_estabelecimento_w, cd_material_w) returning nr_sequencia into nr_seq_material_w;
		end if;
 
		insert into pls_cad_material_inpart(nr_sequencia, cd_material_externo, cd_material_tasy, 
			ie_sistema_externo, ds_material, ds_reduzida, 
			ie_tipo_material, cd_unidade_medida_compra, cd_unidade_medida_estoque, 
			cd_unidade_medida_consumo, qt_minimo_multiplo_solic, cd_classe_material, 
			ie_material_estoque, ie_baixa_estoq_pac, ie_requisicao, 
			ie_prescricao, ie_padronizado, ie_classif_custo, 
			ie_controla_serie, cd_tabela_preco, vl_preco, 
			cd_referencia, nr_registro_anvisa, dt_validade_reg_anvisa, 
			nr_seq_fabric, ds_fabricante, cd_cnpj, 
			ie_situacao, nr_seq_lote_cad, 
			nm_usuario, nm_usuario_nrec, cd_estabelecimento, 
			dt_atualizacao) 
		values (nextval('pls_cad_material_inpart_seq'), cd_material_externo_p, cd_material_tasy_p, 
			ie_sistema_externo_p, ds_material_p, ds_reduzida_p, 
			ie_tipo_material_p, cd_unidade_medida_compra_p, cd_unidade_medida_estoque_p, 
			cd_unidade_medida_consumo_p, qt_minimo_multiplo_solic_p, cd_classe_material_w, 
			ie_material_estoque_p, ie_baixa_estoq_pac_p, ie_requisicao_p, 
			ie_prescricao_p, ie_padronizado_p, ie_classif_custo_p, 
			ie_controla_serie_p, cd_tabela_preco_p, vl_preco_p, 
			cd_referencia_p, nr_registro_anvisa_p, dt_validade_reg_anvisa_p, 
			nr_seq_fabric_p, ds_fabricante_p, cd_cnpj_p, 
			ie_situacao_p, nr_seq_lote_p, 
			nm_usuario_p, nm_usuario_p, cd_estabelecimento_w, 
			clock_timestamp());
	else 
		-- Status -> Não importado 
		ie_status_w := 'N';
	end if;
	 
	insert into pls_ret_material_inpart(nr_sequencia,cd_cod_inpart, cd_material, 
		ds_erro, nr_seq_lote_cad, ie_status, 
		dt_atualizacao, dt_atualizacao_nrec, nm_usuario, 
		nm_usuario_nrec, cd_estabelecimento) 
	values (nextval('pls_ret_material_inpart_seq'), cd_material_externo_p, cd_material_w, 
		ds_erro_w, nr_seq_lote_p, ie_status_w, 
		clock_timestamp(), clock_timestamp(), nm_usuario_p, 
		nm_usuario_p, cd_estabelecimento_w);
	commit;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inserir_materiais_inpart ( cd_material_externo_p plS_cad_material_inpart.cd_material_externo%type, cd_material_tasy_p plS_cad_material_inpart.cd_material_tasy%type, ie_sistema_externo_p plS_cad_material_inpart.ie_sistema_externo%type, ds_material_p plS_cad_material_inpart.ds_material%type, ds_reduzida_p plS_cad_material_inpart.ds_reduzida%type, ie_tipo_material_p plS_cad_material_inpart.ie_tipo_material%type, cd_unidade_medida_compra_p plS_cad_material_inpart.cd_unidade_medida_compra%type, cd_unidade_medida_estoque_p plS_cad_material_inpart.cd_unidade_medida_estoque%type, cd_unidade_medida_consumo_p plS_cad_material_inpart.cd_unidade_medida_consumo%type, cd_unidade_medida_solic_p plS_cad_material_inpart.cd_unidade_medida_solic%type, ie_consignado_p plS_cad_material_inpart.ie_consignado%type, ie_disponivel_mercado_p plS_cad_material_inpart.ie_disponivel_mercado%type, ie_obrig_via_aplicacao_p plS_cad_material_inpart.ie_obrig_via_aplicacao%type, ie_receita_p plS_cad_material_inpart.ie_receita%type, ie_cobra_paciente_p plS_cad_material_inpart.ie_cobra_paciente%type, ie_inf_ultima_compra_p plS_cad_material_inpart.ie_inf_ultima_compra%type, ie_preco_compra_p plS_cad_material_inpart.ie_preco_compra%type, ie_curva_abc_p plS_cad_material_inpart.ie_curva_abc%type, qt_conv_compra_estoque_p plS_cad_material_inpart.qt_conv_compra_estoque%type, qt_conv_estoque_consumo_p plS_cad_material_inpart.qt_conv_estoque_consumo%type, qt_minimo_multiplo_solic_p plS_cad_material_inpart.qt_minimo_multiplo_solic%type, cd_classe_material_p plS_cad_material_inpart.cd_classe_material%type, ie_material_estoque_p plS_cad_material_inpart.ie_material_estoque%type, ie_baixa_estoq_pac_p plS_cad_material_inpart.ie_baixa_estoq_pac%type, ie_requisicao_p plS_cad_material_inpart.ie_requisicao%type, ie_prescricao_p plS_cad_material_inpart.ie_prescricao%type, ie_padronizado_p plS_cad_material_inpart.ie_padronizado%type, ie_classif_custo_p plS_cad_material_inpart.ie_classif_custo%type, ie_controla_serie_p plS_cad_material_inpart.ie_controla_serie%type, cd_tabela_preco_p plS_cad_material_inpart.cd_tabela_preco%type, vl_preco_p plS_cad_material_inpart.vl_preco%type, cd_referencia_p plS_cad_material_inpart.cd_referencia%type, nr_registro_anvisa_p plS_cad_material_inpart.nr_registro_anvisa%type, dt_validade_reg_anvisa_p plS_cad_material_inpart.dt_validade_reg_anvisa%type, nr_seq_fabric_p plS_cad_material_inpart.nr_seq_fabric%type, ds_fabricante_p plS_cad_material_inpart.ds_fabricante%type, cd_cnpj_p plS_cad_material_inpart.cd_cnpj%type, ie_situacao_p plS_cad_material_inpart.ie_situacao%type, cd_material_tuss_p plS_cad_material_inpart.cd_material_tuss%type, nr_seq_lote_p pls_lote_material_inpart.nr_sequencia%type, ie_tipo_p text, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_retorno_p INOUT pls_lote_material_inpart.nr_sequencia%type) FROM PUBLIC;

