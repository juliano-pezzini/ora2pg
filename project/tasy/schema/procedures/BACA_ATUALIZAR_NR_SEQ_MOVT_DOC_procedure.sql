-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_atualizar_nr_seq_movt_doc (dt_inicio_p timestamp, dt_fim_p timestamp ) AS $body$
DECLARE



c00 CURSOR FOR

SELECT distinct	a.nr_lote_contabil
from 	movimento_contabil a,
	lote_contabil b
where 	a.nr_lote_contabil = b.nr_lote_contabil
and	(b.nr_seq_mes_ref IS NOT NULL AND b.nr_seq_mes_ref::text <> '')
and	b.cd_tipo_lote_contabil in (5, 7)
and	a.dt_movimento between trunc(dt_inicio_p, 'dd') and  fim_dia(dt_fim_p);

type t_c00 is table of c00%rowtype index by integer;
l_c00 t_c00;

c01 CURSOR(
		nr_lote_contabil_pc  movimento_contabil_doc.nr_lote_contabil%type
	)FOR
	    SELECT 	nr_sequencia,
			nr_seq_ctb_movto,
			nr_lote_contabil
	      from 	movimento_contabil
	     where 	nr_lote_contabil = nr_lote_contabil_pc;

type t_c01 is table of c01%rowtype index by integer;
l_c01 t_c01;

type t_movto_contabil_seq is table of movimento_contabil.nr_sequencia%type index by integer;
l_movimento_contabil_seq_w   t_movto_contabil_seq;

type t_movto_contabil_seq_ctb is table of movimento_contabil.nr_seq_ctb_movto%type index by integer;
l_movto_contabil_seq_ctb_w   t_movto_contabil_seq_ctb;

type t_nr_lote_contabil is table of movimento_contabil.nr_lote_contabil%type index by integer;
l_nr_lote_contabil_w   t_nr_lote_contabil;

/*
Objetivo:
	Atualizar NR_SEQ_CTB_MOVTO da MOVIMENTO_CONTABIL_DOC
	Atraves da movimento_contabil
*/
BEGIN

open c00;
loop fetch c00 bulk collect into l_c00 limit 1000;
	for y in 1..l_c00.count loop
		open c01(l_c00[y].nr_lote_contabil);
		loop fetch c01 bulk collect into l_c01 limit 1000;
			for i in 1..l_c01.count loop
				begin
					l_movimento_contabil_seq_w(l_movimento_contabil_seq_w.count + 1) := l_c01[i].nr_sequencia;
					l_movto_contabil_seq_ctb_w(l_movto_contabil_seq_ctb_w.count + 1) := l_c01[i].nr_seq_ctb_movto;
					l_nr_lote_contabil_w(l_nr_lote_contabil_w.count + 1) := l_c01[i].nr_lote_contabil;
				end;
			end loop;

			begin
			forall m in 1..l_movto_contabil_seq_ctb_w.count
				update 	movimento_contabil_doc 
				set 	nr_seq_ctb_movto = l_movto_contabil_seq_ctb_w(m)
				where 	nr_lote_contabil = l_nr_lote_contabil_w(m)
				and  	nr_seq_movimento =  l_movimento_contabil_seq_w(m);
			commit;

			l_movimento_contabil_seq_w.delete;
			l_movto_contabil_seq_ctb_w.delete;
			l_nr_lote_contabil_w.delete;
			end;
		exit when l_c01.count = 0;	
		end loop;
		close c01;
	end loop;
EXIT WHEN NOT FOUND; /* apply on c00 */
end loop;
close c00;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_atualizar_nr_seq_movt_doc (dt_inicio_p timestamp, dt_fim_p timestamp ) FROM PUBLIC;

