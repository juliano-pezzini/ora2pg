-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_baixa_ext_prescr_proc ( nr_acesso_dicom_p bigint, cd_motivo_baixa_p bigint, nm_usuario_p text ) AS $body$
DECLARE


nr_prescricao_w			bigint;
nr_seq_prescr_w			bigint;
ie_atualiza_baixa_exame_w	varchar(10);


BEGIN

select	max(nr_prescricao),
	max(nr_sequencia)
into STRICT	nr_prescricao_w,
	nr_seq_prescr_w
from	prescr_procedimento
where	nr_acesso_dicom = nr_acesso_dicom_p;


select	coalesce(max(ie_atualiza_baixa_exame),'S')
into STRICT	ie_atualiza_baixa_exame_w
from	mmed_parametro_integracao;

if (nr_prescricao_w IS NOT NULL AND nr_prescricao_w::text <> '') and (nr_seq_prescr_w IS NOT NULL AND nr_seq_prescr_w::text <> '') and (ie_atualiza_baixa_exame_w = 'S') then

	update	prescr_procedimento
	set	cd_motivo_baixa 	= cd_motivo_baixa_p,
		dt_baixa		= clock_timestamp(),
		nm_usuario		= coalesce(nm_usuario_p,'TASY'),
		dt_atualizacao		= clock_timestamp(),
		ie_status_execucao 	= 'BE',
		nm_usuario_baixa_esp	= coalesce(nm_usuario_p,'TASY'),
		dt_integracao_suspenso = clock_timestamp(),
		dt_suspensao = clock_timestamp(),
		nm_usuario_susp = coalesce(nm_usuario_p,'TASY'),
		ie_suspenso = 'S'
	where	nr_prescricao 		= nr_prescricao_w
	and	nr_sequencia 		= nr_seq_prescr_w;

	commit;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_baixa_ext_prescr_proc ( nr_acesso_dicom_p bigint, cd_motivo_baixa_p bigint, nm_usuario_p text ) FROM PUBLIC;

