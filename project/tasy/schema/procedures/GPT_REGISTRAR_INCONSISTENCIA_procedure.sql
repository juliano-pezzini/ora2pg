-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gpt_registrar_inconsistencia ( nr_seq_cpoe_p bigint, nm_tabela_p text, ie_tipo_p text, nr_seq_inconsistencia_p bigint, ie_opcao_p text, nm_usuario_p text) AS $body$
DECLARE


c01 CURSOR(nr_seq_cpoe_pc	bigint,
			nm_tabela_pc	text,
			ie_tipo_pc		text) FOR
	SELECT	a.nr_prescricao,
			a.nr_sequencia
	from	prescr_material a
	where	a.nr_seq_mat_cpoe = nr_seq_cpoe_pc
	and		a.ie_agrupador = 1
	and		nm_tabela_pc	= 'CPOE_MATERIAL'
	and		ie_tipo_pc = 'M'
	
union all

	SELECT	a.nr_prescricao,
			a.nr_sequencia_solucao nr_sequencia
	from	prescr_material a
	where	a.ie_agrupador		= 4
	and		a.nr_seq_mat_cpoe	= nr_seq_cpoe_pc
	and		nm_tabela_pc	= 'CPOE_MATERIAL'
	and		ie_tipo_pc = 'SOL'
	
union all

	select	a.nr_prescricao,
			a.nr_seq_solucao nr_sequencia
	from	prescr_solucao a
	where	a.nr_seq_dialise_cpoe	= nr_seq_cpoe_pc
	and		nm_tabela_pc	= 'CPOE_DIALISE'
	and		ie_tipo_pc = 'SOL';

BEGIN
for	r_c01 in c01(nr_seq_cpoe_p,nm_tabela_p,ie_tipo_p) loop
	/* Solução */

	if (ie_tipo_p = 'SOL') then
		CALL registrar_inconsistencia_soluc(r_c01.nr_prescricao,
									r_c01.nr_sequencia,
									nr_seq_inconsistencia_p,
									ie_opcao_p,
									nm_usuario_p);
	/* Material */

	elsif (ie_tipo_p = 'M') then
		CALL registrar_inconsistencia_medic(r_c01.nr_prescricao,
									r_c01.nr_sequencia,
									nr_seq_inconsistencia_p,
									ie_opcao_p,
									nm_usuario_p);
	end if;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gpt_registrar_inconsistencia ( nr_seq_cpoe_p bigint, nm_tabela_p text, ie_tipo_p text, nr_seq_inconsistencia_p bigint, ie_opcao_p text, nm_usuario_p text) FROM PUBLIC;

