-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_atualiza_os_safety ( nr_seq_ordem_serv_p bigint, ie_severity_harm_p bigint, ie_probability_harm_p bigint, ds_justificativa_p text, nm_usuario_p text) AS $body$
DECLARE


	nr_seq_tipo_adjustment_w 	bigint := 246; -- CH - Adjustment of medical device evaluation
	ie_severity_harm_old_w 		man_ordem_servico.ie_severity_harm%type;
	ie_probability_harm_old_w 	man_ordem_servico.ie_probability_harm%type;
	ds_relat_tecnico_w 		varchar(4000);

BEGIN

	select 	coalesce(max(ie_severity_harm), -99),
		coalesce(max(ie_probability_harm), -99)
	into STRICT 	ie_severity_harm_old_w,
		ie_probability_harm_old_w
	from 	man_ordem_servico
	where 	nr_sequencia = nr_seq_ordem_serv_p;

	update	man_ordem_servico
	set	ie_severity_harm 	= ie_severity_harm_p,
		ie_probability_harm 	= ie_probability_harm_p,
		nm_usuario		= nm_usuario_p,
		dt_atualizacao		= clock_timestamp()
	where	nr_sequencia		= nr_seq_ordem_serv_p;

	commit;
	
	if (ie_severity_harm_p <> ie_severity_harm_old_w) then
		ds_relat_tecnico_w := obter_desc_expressao(951175, 'Severidade de prejuízo ao paciente') || ' '
			|| lower(obter_desc_expressao(491362, 'Alterada')) || ' ' || obter_desc_expressao(310214, 'de') || ' '
			|| obter_descricao_dominio(9431, ie_severity_harm_old_w) || ' ' || lower(obter_desc_expressao(325787, 'Para')) || ' '
			|| obter_descricao_dominio(9431, ie_severity_harm_p) || chr(13) || chr(10);
	end if;
	
	if (ie_probability_harm_p <> ie_probability_harm_old_w) then
		ds_relat_tecnico_w := ds_relat_tecnico_w || obter_desc_expressao(951179, 'Probabilidade de prejuízo ao paciente') || ' '
			|| lower(obter_desc_expressao(491362, 'Alterada')) || ' ' || obter_desc_expressao(310214, 'de') || ' '
			|| obter_descricao_dominio(9432, ie_probability_harm_old_w) || ' ' || lower(obter_desc_expressao(325787, 'Para')) || ' '
			|| obter_descricao_dominio(9432, ie_probability_harm_p) || chr(13) || chr(10);
	end if;
	
	ds_relat_tecnico_w := substr(ds_relat_tecnico_w || chr(13) || chr(10) ||
		obter_desc_expressao(327458, 'Motivo:') || ' ' || ds_justificativa_p, 1, 4000);

	CALL man_gravar_historico_ordem(
			nr_seq_ordem_serv_p 	=> nr_seq_ordem_serv_p,
			dt_liberacao_p 		=> clock_timestamp(),
			ds_relat_tecnico_p 	=> ds_relat_tecnico_w,
			ie_origem_p 		=> 'I',
			nr_seq_tipo_p 		=> nr_seq_tipo_adjustment_w,
			nm_usuario_p 		=> nm_usuario_p);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_atualiza_os_safety ( nr_seq_ordem_serv_p bigint, ie_severity_harm_p bigint, ie_probability_harm_p bigint, ds_justificativa_p text, nm_usuario_p text) FROM PUBLIC;

