-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_ajustar_parcela_mens_sca () AS $body$
DECLARE


C01 CURSOR FOR
	SELECT	e.nr_sequencia nr_seq_mens_item,
		coalesce(e.nr_parcela, 0) nr_parcela_sca,
		trunc(months_between(b.dt_mesano_referencia, trunc(d.dt_inicio_vigencia, 'month'))) + 1 nr_parcela_sca_correta
	  from  pls_mensalidade_seg_item a,
		pls_mensalidade_segurado b,
		pls_mensalidade c,
		pls_sca_vinculo d,
		pls_mensalidade_sca e
	where   c.nr_sequencia = b.nr_seq_mensalidade
	  and	a.nr_sequencia = e.nr_seq_item_mens
	  and   b.nr_sequencia = a.nr_seq_mensalidade_seg
	  and   d.nr_sequencia = e.nr_seq_vinculo_sca
	  and   coalesce(c.ie_cancelamento::text, '') = ''
	  and   c.dt_referencia <= '01/01/2018'
	  and   (d.dt_inicio_vigencia IS NOT NULL AND d.dt_inicio_vigencia::text <> '')
	  and   a.ie_tipo_item = '15';

BEGIN

for r_c01_w in c01 loop
	begin
	
	if (r_c01_w.nr_parcela_sca_correta <> r_c01_w.nr_parcela_sca) and (r_c01_w.nr_parcela_sca_correta > 0) then
		update	pls_mensalidade_sca
		set	nr_parcela 	= r_c01_w.nr_parcela_sca_correta
		where	nr_sequencia 	= r_c01_w.nr_seq_mens_item;
	end if;
	
	end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_ajustar_parcela_mens_sca () FROM PUBLIC;

