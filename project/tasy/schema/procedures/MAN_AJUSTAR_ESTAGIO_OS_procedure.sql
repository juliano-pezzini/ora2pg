-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_ajustar_estagio_os ( nr_seq_ordem_p bigint, nm_usuario_prev_p text) AS $body$
DECLARE


cd_cargo_w		bigint;
nm_usuario_prev_w		varchar(15);
ie_funcao_usuario_w	varchar(50);
nr_seq_estagio_atual_w	bigint;
nm_usuario_exec_w	varchar(15);
ie_estagio_desenv_w	varchar(1);
ie_estagio_tec_w		varchar(1);
ie_estagio_sup_w		varchar(1);
ie_sup_nivel2_w		varchar(1);
nr_seq_triagem_w		bigint;

BEGIN

if (user = 'CORP' or user = 'TASY') then

	select	max(a.nr_seq_estagio),
		max(b.ie_desenv),
		coalesce(max(b.ie_tecnologia), 'N'),
		max(b.ie_suporte),
		max(b.ie_sup_nivel2)
	into STRICT	nr_seq_estagio_atual_w,
		ie_estagio_desenv_w,
		ie_estagio_tec_w,
		ie_estagio_sup_w,
		ie_sup_nivel2_w
	from	man_ordem_servico a,
		man_estagio_processo b
	where	a.nr_sequencia = nr_seq_ordem_p
	and	a.nr_seq_estagio = b.nr_sequencia;

	if (nr_seq_estagio_atual_w IS NOT NULL AND nr_seq_estagio_atual_w::text <> '') and (ie_estagio_desenv_w = 'S') and (ie_estagio_tec_w = 'N') then
		begin

		if (nr_seq_estagio_atual_w <> 2082) and -- Desenv aguardando teste do analista
			(nr_seq_estagio_atual_w <> 261) and -- Desenv aguardando cliente
			(nr_seq_estagio_atual_w <> 2574) and -- CH: Waiting decision
			(nr_seq_estagio_atual_w <> 2577) then -- CH: Waiting triage
			begin

			select	max(a.nm_usuario_exec)
			into STRICT	nm_usuario_exec_w
			from	man_ordem_serv_ativ a
			where	a.nr_seq_ordem_serv = nr_seq_ordem_p
			and	(a.dt_atividade IS NOT NULL AND a.dt_atividade::text <> '')
			and 	coalesce(a.dt_fim_atividade::text, '') = ''
			and	exists (
						SELECT	1
						from	grupo_desenvolvimento b,
							usuario_grupo_des c,
							gerencia_wheb g
						where	b.nr_sequencia = c.nr_seq_grupo
						and	c.nm_usuario_grupo = a.nm_usuario_exec
						and	g.nr_sequencia = b.nr_seq_gerencia
						and	g.ie_area_gerencia in ('DES', 'PDES'));

			if (nm_usuario_exec_w IS NOT NULL AND nm_usuario_exec_w::text <> '') then /* Existe uma atividade realizada em aberto*/
				begin
					select	coalesce(max(ie_funcao_usuario),'XXX')
					into STRICT	ie_funcao_usuario_w
					from	usuario_grupo_des
					where	nm_usuario_grupo = nm_usuario_exec_w;

					if (ie_funcao_usuario_w in ('P','E')) then

						update	man_ordem_servico
						set	nr_seq_estagio = 732	/*Desenv em programacao*/
						where	nr_sequencia = nr_seq_ordem_p;
					elsif (ie_funcao_usuario_w in ('S','N','G')) then

						update	man_ordem_servico
						set	nr_seq_estagio = 731	/*Desenv em analise*/
						where	nr_sequencia = nr_seq_ordem_p;
					elsif (ie_funcao_usuario_w = 'M') then

						update	man_ordem_servico
						set	nr_seq_estagio = 2112	/*Desenv em pre-analise */
						where	nr_sequencia = nr_seq_ordem_p;
					end if;
				end;
			else
				begin
					select	max(a.nm_usuario_prev)
					into STRICT	nm_usuario_exec_w
					from	man_ordem_ativ_prev a
					where	a.nr_seq_ordem_serv = nr_seq_ordem_p
					and	(a.dt_prevista IS NOT NULL AND a.dt_prevista::text <> '')
					and 	coalesce(a.dt_real::text, '') = ''
					and	trunc(a.dt_prevista,'dd') >= trunc(clock_timestamp(),'dd')
					and 	exists (
								SELECT	1
								from	man_ordem_servico_exec x
								where	a.nm_usuario_prev = x.nm_usuario_exec
								and	coalesce(x.dt_fim_execucao::text, '') = ''
								and	x.nr_seq_ordem = nr_seq_ordem_p
							)
					and	exists (
								SELECT	1
								from	grupo_desenvolvimento b,
									usuario_grupo_des c,
									gerencia_wheb g
								where	b.nr_sequencia = c.nr_seq_grupo
								and	c.nm_usuario_grupo = a.nm_usuario_prev
								and	g.nr_sequencia = b.nr_seq_gerencia
								and	g.ie_area_gerencia in ('DES', 'PDES')
							);

					if (coalesce(nm_usuario_exec_w::text, '') = '') then  /* Verifica se existe um executor em aberto do setor de desenvolvimento*/
						begin
						select	max(a.nm_usuario_exec)
						into STRICT	nm_usuario_exec_w
						from	man_ordem_servico_exec a
						where	coalesce(a.dt_fim_execucao::text, '') = ''
						and	a.nr_seq_ordem = nr_seq_ordem_p
						and	exists (
									SELECT	1
									from	grupo_desenvolvimento b,
										usuario_grupo_des c,
										gerencia_wheb g
									where	b.nr_sequencia = c.nr_seq_grupo
									and	c.nm_usuario_grupo = a.nm_usuario_exec
									and	g.nr_sequencia = b.nr_seq_gerencia
									and	g.ie_area_gerencia in ('DES', 'PDES')
								);
						end;
					end if;

					if (nr_seq_estagio_atual_w <> 1051) and /* Para quando a OS estiver como Desenv aguardando triagem, ela continue nesse estagio */
						(nm_usuario_exec_w IS NOT NULL AND nm_usuario_exec_w::text <> '') then /* Existe uma atividade realizada em aberto ou um executor ativo sem atividade prevista */
						begin
						select	coalesce(max(ie_funcao_usuario),'XXX')
						into STRICT	ie_funcao_usuario_w
						from	usuario_grupo_des
						where	nm_usuario_grupo = nm_usuario_exec_w;

						if (ie_funcao_usuario_w in ('P','F','E')) then

							update	man_ordem_servico
							set	nr_seq_estagio	= 1191	/*Desenv aguardando programacao*/
							where	nr_sequencia	= nr_seq_ordem_p
							and	nr_seq_estagio	= 732;
						elsif (ie_funcao_usuario_w in ('S','M','G')) then

							update	man_ordem_servico
							set	nr_seq_estagio	= 4	/*Desenv aguardando analise*/
							where	nr_sequencia 	= nr_seq_ordem_p
							and	nr_seq_estagio	= 731;
						elsif (ie_funcao_usuario_w = 'N') then

							update	man_ordem_servico
							set	nr_seq_estagio	= 1811	/*Desenv aguardando analise de negocio*/
							where	nr_sequencia	= nr_seq_ordem_p
							and	nr_seq_estagio	= 2112;
						end if;
						end;
					end if;
				end;
			end if;
			end;
		end if;
		end;
	elsif 	((nr_seq_estagio_atual_w IS NOT NULL AND nr_seq_estagio_atual_w::text <> '') and (ie_estagio_desenv_w = 'N') and (ie_estagio_tec_w = 'N') and (ie_estagio_sup_w = 'S' or ie_sup_nivel2_w = 'S')) then

		if (nr_seq_estagio_atual_w <> 1341) and -- Aguardando Inf. do Cliente - Suporte
			(nr_seq_estagio_atual_w <> 121) and -- Aguardando Conexao
			(nr_seq_estagio_atual_w <> 1431) and -- Aguardando Auxilio Interno - Analista
			(nr_seq_estagio_atual_w <> 2574) and -- CH: Waiting decision
			(nr_seq_estagio_atual_w <> 2577) then -- CH: Waiting triage

			-- Verifica se a Ordem de servico ja foi Triada apos  o estagio de Aguardando Triagem
			select	max(nr_seq_triagem)
			into STRICT	nr_seq_triagem_w
			from (
					SELECT	max(nr_sequencia) nr_seq_triagem
					from	man_ordem_serv_estagio
					where	nr_seq_estagio = 231 -- Aguardando Triagem
					and	nr_seq_ordem = nr_seq_ordem_p
				) alias12
			where (
					SELECT	min(nr_sequencia) nr_seq_triagem
					from	man_ordem_serv_estagio
					where 	nr_sequencia > nr_seq_triagem
					and	nr_seq_estagio in (2113,31) --Triada
					and	nr_seq_ordem = nr_seq_ordem_p
				) is not null;

			select	max(a.nm_usuario_exec)
			into STRICT	nm_usuario_exec_w
			from	man_ordem_serv_ativ a
			where	a.nr_seq_ordem_serv = nr_seq_ordem_p
			and	(a.dt_atividade IS NOT NULL AND a.dt_atividade::text <> '')
			and 	coalesce(a.dt_fim_atividade::text, '') = ''
			and	exists (
						SELECT	1
						from	grupo_suporte b,
							usuario_grupo_sup c,
							gerencia_wheb g
						where	b.nr_sequencia = c.nr_seq_grupo
						and	c.nm_usuario_grupo = a.nm_usuario_exec
						and	g.nr_sequencia = b.nr_seq_gerencia_sup
						and	g.ie_area_gerencia in ('SUP')
					);

			if (coalesce(nr_seq_triagem_w::text, '') = '') and (nm_usuario_exec_w IS NOT NULL AND nm_usuario_exec_w::text <> '') then /* Existe uma atividade realizada em aberto*/
				select	coalesce(max(ie_funcao_usuario),'XXX')
				into STRICT	ie_funcao_usuario_w
				from	usuario_grupo_sup
				where	nm_usuario_grupo = nm_usuario_exec_w;

				if (ie_funcao_usuario_w in ('N1','N2','E','A')) then
					update	man_ordem_servico
					set	nr_seq_estagio = 2113	/*Triada*/
					where	nr_sequencia = nr_seq_ordem_p;
				elsif (ie_funcao_usuario_w in ('S','G')) then

					update	man_ordem_servico
					set	nr_seq_estagio = 31	/*Suporte- analise*/
					where	nr_sequencia = nr_seq_ordem_p;
				end if;
			else
				select	max(a.nm_usuario_prev)
				into STRICT	nm_usuario_exec_w
				from	man_ordem_ativ_prev a
				where	a.nr_seq_ordem_serv = nr_seq_ordem_p
				and	(a.dt_prevista IS NOT NULL AND a.dt_prevista::text <> '')
				and 	coalesce(a.dt_real::text, '') = ''
				and	trunc(a.dt_prevista,'dd') >= trunc(clock_timestamp(),'dd')
				and 	exists (
							SELECT	1
							from	man_ordem_servico_exec x
							where	a.nm_usuario_prev = x.nm_usuario_exec
							and	coalesce(x.dt_fim_execucao::text, '') = ''
							and	x.nr_seq_ordem = nr_seq_ordem_p
						)
				and	exists (
							SELECT	1
							from	grupo_suporte b,
								usuario_grupo_sup c,
								gerencia_wheb g
							where	b.nr_sequencia = c.nr_seq_grupo
							and	c.nm_usuario_grupo = a.nm_usuario_prev
							and	g.nr_sequencia = b.nr_seq_gerencia_sup
							and	g.ie_area_gerencia in ('SUP')
						);

				if (coalesce(nm_usuario_exec_w::text, '') = '') then  /* Verifica se existe um executor em aberto do setor de suporte*/
					select	max(a.nm_usuario_exec)
					into STRICT	nm_usuario_exec_w
					from	man_ordem_servico_exec a
					where	coalesce(a.dt_fim_execucao::text, '') = ''
					and	a.nr_seq_ordem = nr_seq_ordem_p
					and	exists (
								SELECT	1
								from	grupo_suporte b,
									usuario_grupo_sup c,
									gerencia_wheb g
								where	b.nr_sequencia = c.nr_seq_grupo
								and	c.nm_usuario_grupo = a.nm_usuario_exec
								and	g.nr_sequencia = b.nr_seq_gerencia_sup
								and	g.ie_area_gerencia in ('SUP')
							);
				end if;

				if (coalesce(nr_seq_triagem_w::text, '') = '') and (nm_usuario_exec_w IS NOT NULL AND nm_usuario_exec_w::text <> '')  and /* Existe uma atividade realizada em aberto ou um executor ativo sem atividade prevista*/
					(nr_seq_estagio_atual_w	<> 31) then --Nao alterar caso
					select	coalesce(max(ie_funcao_usuario),'XXX')
					into STRICT	ie_funcao_usuario_w
					from	usuario_grupo_sup
					where	nm_usuario_grupo = nm_usuario_exec_w;

					if (ie_funcao_usuario_w in ('N1','N2','E','A')) then

						update	man_ordem_servico
						set	nr_seq_estagio = 2113	/*Triada*/
						where	nr_sequencia = nr_seq_ordem_p;
					elsif (ie_funcao_usuario_w in ('S','G')) then

						update	man_ordem_servico
						set	nr_seq_estagio = 231	/*Aguardando Triagem*/
						where	nr_sequencia = nr_seq_ordem_p;
					end if;
				end if;
			end if;
		end if;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_ajustar_estagio_os ( nr_seq_ordem_p bigint, nm_usuario_prev_p text) FROM PUBLIC;

