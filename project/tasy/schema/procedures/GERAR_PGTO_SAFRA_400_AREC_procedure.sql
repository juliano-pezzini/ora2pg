-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_pgto_safra_400_arec ( nr_seq_envio_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_conteudo_w			varchar(450)	:= null;
nr_seq_reg_arquivo_w	bigint	:= 1;
cd_conta_pgto_w			varchar(9);
ie_digito_conta_w		varchar(1);
cd_agencia_pgto_w		varchar(5);
cd_banco_pgto_w			varchar(3);
nm_empresa_w			varchar(30);
dt_geracao_w			varchar(8);
nr_seq_arquivo_w		varchar(3);
cd_estabelecimento_w	bigint;

/* detalhe */

ie_tipo_inscricao_w		varchar(1);
nr_inscricao_empresa_w	varchar(14);
nr_titulo_w				bigint;
dt_vencimento_w			timestamp;
vl_titulo_w				double precision;
vl_multa_w				double precision;
vl_juros_w				double precision;
nm_pessoa_w				varchar(40);
nr_inscricao_w			varchar(14);
cd_codigo_barras_w		varchar(48);
ie_tipo_pagamento_w		varchar(4);
ie_tipo_servico_w		varchar(6);
ie_forma_pagamento_w	varchar(4);

/* GPS */

cd_pagamento_w			varchar(14);
dt_referencia_w			varchar(6);
vl_inss_w				double precision;
vl_outras_entidades_w	double precision;

/* DARF */

ie_tipo_ident_w		varchar(1);
dt_apuracao_w		varchar(8);
cd_darf_w			varchar(6);
nr_referencia_w		varchar(17);

/* Trailer */

vl_total_w			bigint := 0;

c01 CURSOR FOR
SELECT	CASE WHEN coalesce(b.cd_pessoa_fisica::text, '') = '' THEN 'J'  ELSE 'F' END  ie_tipo_inscricao,
	lpad(coalesce((select coalesce(x.cd_cgc,(select p.nr_cpf from pessoa_fisica p where p.cd_pessoa_fisica = x.cd_pessoa_fisica))
from titulo_pagar_favorecido x where x.nr_titulo = a.nr_titulo
), coalesce(b.cd_cgc,c.nr_cpf)),14,'0') nr_inscricao,
	rpad(elimina_caractere_especial(substr(obter_nome_pf_pj(b.cd_pessoa_fisica,b.cd_cgc),1,30)),30,' ') ds_nome_pessoa,
	coalesce(b.nr_titulo,0) nr_titulo,
	a.vl_escritural,
	CASE WHEN coalesce(a.vl_juros,0)=0 THEN obter_juros_multa_titulo(b.nr_titulo,clock_timestamp(),'R','J')  ELSE a.vl_juros END  vl_juros,
	CASE WHEN coalesce(a.vl_multa,0)=0 THEN obter_juros_multa_titulo(b.nr_titulo,clock_timestamp(),'R','M')  ELSE a.vl_multa END  vl_multa,
	b.dt_vencimento_atual,
	rpad(substr(b.nr_bloqueto,1,48),48,' ') nr_bloqueto,
	a.ie_tipo_pagamento,
	a.ie_tipo_servico,
	CASE WHEN(select	count(*)		from	gps_titulo x		where	x.nr_titulo	= a.nr_titulo)=0 THEN 		CASE WHEN(select	count(*)			from	darf_titulo_pagar x			where	x.nr_titulo	= a.nr_titulo)=0 THEN                       CASE WHEN b.IE_TIPO_TITULO='16' THEN '08'  ELSE CASE WHEN a.ie_tipo_servico='00022' THEN  '06'  ELSE CASE WHEN a.ie_tipo_pagamento='PC' THEN '99' WHEN a.ie_tipo_pagamento='BLQ' THEN '99' END  END  END   ELSE CASE WHEN 	coalesce(b.nr_bloqueto::text, '') = '' THEN '02'  ELSE '99' END  END   ELSE CASE WHEN coalesce(b.nr_bloqueto::text, '') = '' THEN '01'  ELSE '99' END  END  ie_forma_pagamento
FROM titulo_pagar b
LEFT OUTER JOIN pessoa_fisica c ON (b.cd_pessoa_fisica = c.cd_pessoa_fisica)
, titulo_pagar_escrit a
LEFT OUTER JOIN banco d ON (a.cd_banco = d.cd_banco)
WHERE a.nr_titulo		= b.nr_titulo  and (a.ie_tipo_pagamento in ('BLQ','PC') or
	exists (select	1
	from	darf_titulo_pagar x
	where	x.nr_titulo	= a.nr_titulo) or
	exists (select	1
	from	gps_titulo x
	where	x.nr_titulo	= a.nr_titulo)) and a.nr_seq_escrit = nr_seq_envio_p;


BEGIN

delete	FROM w_envio_banco
where	nm_usuario = nm_usuario_p;

cd_estabelecimento_w := wheb_usuario_pck.get_cd_estabelecimento;

/* header  */

select lpad(coalesce(b.cd_conta,'0'),8,'0'),
	lpad(coalesce(b.cd_agencia_bancaria,'0'),5,'0'),
	substr(coalesce(b.ie_digito_conta,'0'),1,1),
	b.cd_estabelecimento,
	rpad(substr(obter_nome_estabelecimento(b.cd_estabelecimento),1,30),30,' ') nm_empresa,
	to_char(clock_timestamp(),'YYYYMMDD'),
	lpad(b.cd_banco,3,'0'),
	c.cd_cgc nr_inscricao
into STRICT cd_conta_pgto_w,
	cd_agencia_pgto_w,
	ie_digito_conta_w,
	cd_estabelecimento_w,
	nm_empresa_w,
	dt_geracao_w,
	cd_banco_pgto_w,
	nr_inscricao_w
from estabelecimento c,
	banco_estabelecimento b,
	banco_escritural a
where a.cd_estabelecimento	= c.cd_estabelecimento
and	a.nr_seq_conta_banco	= b.nr_sequencia
and	a.nr_sequencia		= nr_seq_envio_p;

select lpad(coalesce(count(nr_sequencia),0)+1,3,0)
into STRICT nr_seq_arquivo_w
from banco_escritural
where CD_BANCO = cd_banco_pgto_w
and (ds_arquivo IS NOT NULL AND ds_arquivo::text <> '')
and dt_remessa_retorno = clock_timestamp();

/*HEADER DE ARQUIVO*/

ds_conteudo_w	:=	'0' 							|| /*Pos 01 COD. REGISTRO*/
				'01' 								|| /*Pos 02 a 03 COD.INSCRICAO*/
				nr_inscricao_w 						|| /*Pos 04 a 17 NUM.INSCRICAO*/
				'1' 								|| /*Pos 18 COD. MOVIMENTO*/
				'ARRECADACAO'		 				|| /*Pos 19 a 29 IDENT.ARQUIVO*/
				cd_agencia_pgto_w	|| cd_conta_pgto_w || ie_digito_conta_w	|| /*Pos 30 a 43 COD. EMPRESA*/
				nm_empresa_w 						|| /*Pos 44 a 73 NOME EMPRESA*/
				cd_banco_pgto_w 					|| /*Pos 74 a 76 COD. BANCO*/
				'BANCO SAFRA'		 				|| /*Pos 77 a 87 NOME BANCO*/
				rpad(' ',4,' ') 					|| /*Pos 88 a 91 BRANCOS*/
				dt_geracao_w 						|| /*Pos 92 a 99 Data Gravacao*/
				rpad(' ',292,' ') 					|| /*Pos 100 a 391 BRANCOS*/
				nr_seq_arquivo_w 					|| /*Pos 392 a 394 NUM. ARQUIVO*/
				lpad(nr_seq_reg_arquivo_w,6,'0');		/*Pos 395 a 400 NUM. REGISTRO*/
insert into w_envio_banco(
	nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	cd_estabelecimento,
	ds_conteudo,
	nr_seq_apres
) values (
	nextval('w_envio_banco_seq'),
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	cd_estabelecimento_w,
	ds_conteudo_w,
	nr_seq_reg_arquivo_w
);

/*fim HEADER DE ARQUIVO*/
	

/* DETALHE */

open	C01;
loop
fetch	C01 into	
	ie_tipo_inscricao_w,
	nr_inscricao_empresa_w,
	nm_pessoa_w,
	nr_titulo_w,
	vl_titulo_w,
	vl_multa_w,
	vl_juros_w,
	dt_vencimento_w,
	cd_codigo_barras_w,
	ie_tipo_pagamento_w,
	ie_tipo_servico_w,
	ie_forma_pagamento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

	nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;
	vl_total_w := vl_total_w + vl_titulo_w;

	/* Registro Detalhe (obrigatorio) */

	ds_conteudo_w	:=	'1'									|| /*Pos 01 COD.REGISTRO*/
				'01'										|| /*Pos 02 a 03 TIPO DE OPERACAO*/
				lpad('0',7,'0') 							|| /*Pos 04 a 10 NUMERO DE CONTROLE */
				rpad('0',8,'0')								|| /*Pos 11 a 18 NOVA DATA DE PAGAMENTO*/
				rpad('0',2,'0')								|| /*Pos 19 a 20 COD.OCORRENCIA */
				lpad(ie_forma_pagamento_w,2,'0')			|| /*Pos 21 a 22 Tipo Pagamento*/
				lpad(substr(nr_titulo_w,1,10),10,0)			|| /*Pos 23 a 32 NUM CONTROLE CLIENTE */
				to_char(dt_vencimento_w,'YYYYMMDD')			|| /*Pos 33 a 40 Data Pagamento*/
				lpad(somente_numero(to_char(coalesce(vl_titulo_w,0),'99999999990.00')),15,'0') 	|| /*Pos 41 a 55 Valor*/
				nm_pessoa_w									|| /*Pos 56 a 85 NOME ???*/
				rpad('0',4,'0')								|| /*Pos 86 a 89 DDD TELEFONE */
				rpad('0',8,'0');								/*Pos 90 a 97 NRO TELEFONE */
	if (ie_forma_pagamento_w = '01') then

		select	to_char(coalesce(max(b.dt_referencia),clock_timestamp()),'YYYYMM') dt_referencia,
			lpad(substr(coalesce(max(b.cd_pagamento),'0'),1,14),14,'0') cd_pagamento,
			max(b.vl_inss) vl_inss,
			max(b.vl_outras_entidades) vl_outras_entidades
		into STRICT	dt_referencia_w,
			cd_pagamento_w,
			vl_inss_w,
			vl_outras_entidades_w
		from	gps b,
			gps_titulo a
		where	a.nr_seq_gps	= b.nr_sequencia
		and	a.nr_titulo	= nr_titulo_w;

		ds_conteudo_w	:= ds_conteudo_w 		|| /*Pos 1 a 97*/
				'1007'							|| /*Pos 98 a 101 COD.PAGTO GPS */
				dt_referencia_w					|| /*Pos 102 a 107 DATA COMPETENCIA */
				cd_pagamento_w					|| /*Pos 108 a 121 IDENTIFICACAO ???*/
				lpad(somente_numero(to_char(coalesce(vl_inss_w,0),'9999999999990.00')),15,'0') || /*Pos 122 a 136 VR-INSS */
				lpad(somente_numero(to_char(coalesce(vl_outras_entidades_w,0),'9999999999990.00')),15,'0') || /*Pos 137 a 151 VR-OUTRAS */
				rpad('0',15,'0')				|| /*Pos 152 a 166 VR-MULTA */
				rpad(' ',100,' ')				|| /*Pos 167 a 266 OBSERVACOES */
				rpad(' ',45,' ');					/*Pos 267 a 311 BRANCOS */
	elsif (ie_forma_pagamento_w = '02') then

 			select	to_char(coalesce(max(b.dt_apuracao),clock_timestamp()),'YYYYMMDD') dt_apuracao,
				lpad(substr(coalesce(max(b.cd_darf),'0'),1,6),6,'0') cd_darf,
				lpad(substr(coalesce(max(b.nr_referencia),'0'),1,17),17,'0') nr_referencia
			into STRICT	dt_apuracao_w,
					cd_darf_w,
					nr_referencia_w
			from	darf b,
					darf_titulo_pagar a
			where	a.nr_seq_darf	= b.nr_sequencia
			and		a.nr_titulo	= nr_titulo_w;

	  ds_conteudo_w	:= ds_conteudo_w 				|| /*Pos 1 a 97*/
			ie_tipo_inscricao_w						|| /*Pos 98 TIPO DE IDENTIFICADOR*/
			nr_inscricao_empresa_w					|| /*Pos 99 a 112 IDENTIFICACAO */
			dt_apuracao_w							|| /*Pos 113 a 120 APURACAO */
			nr_referencia_w							|| /*Pos 121 a 137 REF-DARF */
			'0107'									|| /*Pos 138 a 141 COD-RECEITA */
			lpad(somente_numero(to_char(coalesce(vl_titulo_w,0),'9999999999990.00')),15,'0')	|| /*Pos 142 a 156 VR-DARF */
			lpad(somente_numero(to_char(coalesce(vl_multa_w,0),'9999999999990.00')),15,'0') 	|| /*Pos 157 a 171 VR-MULTA */
			lpad(somente_numero(to_char(coalesce(vl_juros_w,0),'9999999999990.00')),15,'0') 	|| /*Pos 172 a 186 VR-JUROS */
			to_char(dt_vencimento_w,'YYYYMMDD')		|| /*Pos 187 a 194 VENCIMENTO */
			rpad(' ',100,' ')						|| /*Pos 195 a 266 OBSERVACOES */
			rpad(' ',17,' ');							/*Pos 267 a 311 BRANCOS */
	elsif (ie_forma_pagamento_w = '08') then

		ds_conteudo_w	:= ds_conteudo_w 					|| /*Pos 1 a 97*/
						'L'									|| /*Pos 98 TIPO DE ENTR*/
						cd_codigo_barras_w					|| /*Pos 99 a 146 CODIGO BARRAS*/
						rpad(ie_tipo_inscricao_w,16,'0')	|| /*Pos 147 a 162*/
						rpad(' ',149,' ');						/*Pos 163 a 311 BRANCOS */
	else

		ds_conteudo_w	:= ds_conteudo_w 					|| /*Pos 1 a 97*/
						'L'									|| /*Pos 98 TIPO DE ENTR*/
						cd_codigo_barras_w					|| /*Pos 99 a 146 CODIGO BARRAS*/
						to_char(dt_vencimento_w,'YYYYMMDD')	|| /*Pos 147 a 154 Vencimento*/
						rpad(' ',157,' ');						/*Pos 155 a 311 BRANCOS */
	end if;

	ds_conteudo_w	:=  ds_conteudo_w 			|| /*Pos 1 a 311*/
			lpad(' ',80,' ')					|| /*Pos 312 a 391 OCORRENCIA */
			nr_seq_arquivo_w					|| /*Pos 392 a 394 SEQUENCIA*/
			lpad(nr_seq_reg_arquivo_w,6,'0');		/*Pos 395 a 400 Numero Sequencial Registro */
	insert	into w_envio_banco(
		nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		cd_estabelecimento,
		ds_conteudo,
		nr_seq_apres
	) values (
		nextval('w_envio_banco_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_estabelecimento_w,
		ds_conteudo_w,
		nr_seq_reg_arquivo_w
	);

end	loop;
close	C01;

/*fim DETALHE DE ARQUIVO*/
	

/* TRAILER */

nr_seq_reg_arquivo_w	:= nr_seq_reg_arquivo_w + 1;

ds_conteudo_w	:=	'9'										|| /*Pos 01 Cod. Registro*/
				rpad(' ',367,' ')							|| /*Pos 02 a 368 Esp. Branco*/
				lpad(nr_seq_reg_arquivo_w-2,8,'0')			|| /*Pos 369 a 376 QUANTIDADE DE PAGAMENTOS*/
				lpad(somente_numero(to_char(coalesce(vl_total_w,0),'99999999990.00')),15,'0')	|| /*Pos 377 a 391 Valor Total */
				nr_seq_arquivo_w							|| /*Pos 392 a 394 Esp. Branco*/
				lpad(nr_seq_reg_arquivo_w,6,'0');				/*Pos 395 a 400 NUM. SEQUENCIAL*/
insert	into w_envio_banco(
	nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	cd_estabelecimento,
	ds_conteudo,
	nr_seq_apres
) values (
	nextval('w_envio_banco_seq'),
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	cd_estabelecimento_w,
	ds_conteudo_w,
	nr_seq_reg_arquivo_w
);

/*fim TRAILER DE ARQUIVO*/
	

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_pgto_safra_400_arec ( nr_seq_envio_p bigint, nm_usuario_p text) FROM PUBLIC;

