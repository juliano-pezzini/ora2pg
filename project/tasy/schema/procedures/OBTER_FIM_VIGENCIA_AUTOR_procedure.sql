-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_fim_vigencia_autor ( dt_inicio_vigencia_p timestamp, qt_dias_autor_p bigint, cd_estabelecimento_p bigint, cd_convenio_p bigint, ie_tipo_dia_p text, dt_retorno_p INOUT timestamp, ie_dia_atual_p text default null) AS $body$
DECLARE

hr_final_vigencia_w	timestamp;
dt_retorno_w		timestamp	:= null;
ie_dia_atual_w		varchar(1);
ie_hora_tipo_acomod_w	varchar(1)	:= 'N';
qt_dias_uteis_w		bigint;
qt_dias_autor_w		bigint;
c01 CURSOR FOR
SELECT	hr_final_vigencia,
	coalesce(ie_dia_atual_p,ie_dia_atual)
from	regra_autor_vigencia
where	cd_convenio		= cd_convenio_p
and	cd_estabelecimento	= cd_estabelecimento_p
and	dt_inicio_vigencia_p	
    between ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_inicio_vigencia_p, coalesce(hr_inicial, to_date('00:00','hh24:mi')))
		and ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_inicio_vigencia_p,coalesce(hr_final, to_date('00:00','hh24:mi')));
		

BEGIN

if (coalesce(qt_dias_autor_p,0) = 0) then
	qt_dias_autor_w := 1;
else
	qt_dias_autor_w := qt_dias_autor_p;
end if;

open c01;
loop
fetch c01 into
	hr_final_vigencia_w,
	ie_dia_atual_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	if (ie_dia_atual_w = 'S') then
		dt_retorno_w	:= ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_inicio_vigencia_p + coalesce(qt_dias_autor_w,1) - 1, coalesce(hr_final_vigencia_w, to_date('00:00','hh24:mi')));
	else
    dt_retorno_w	:= ESTABLISHMENT_TIMEZONE_UTILS.dateAtTime(dt_inicio_vigencia_p + qt_dias_autor_w, coalesce(hr_final_vigencia_w, to_date('00:00','hh24:mi')));
	end if;


	/* Corrido */

	if (ie_tipo_dia_p	= 'C') then
		dt_retorno_w	:= dt_retorno_w;
	/* Uteis */

	else
		qt_dias_uteis_w	:= obter_qt_dia_util_periodo(dt_inicio_vigencia_p,dt_retorno_w,cd_estabelecimento_p);

		while(qt_dias_uteis_w < qt_dias_autor_w) loop
			dt_retorno_w	:= dt_retorno_w + 1;

			qt_dias_uteis_w	:= obter_qt_dia_util_periodo(dt_inicio_vigencia_p,dt_retorno_w,cd_estabelecimento_p);	
		end loop;
	end if;
end loop;
close c01;

dt_retorno_p	:= dt_retorno_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_fim_vigencia_autor ( dt_inicio_vigencia_p timestamp, qt_dias_autor_p bigint, cd_estabelecimento_p bigint, cd_convenio_p bigint, ie_tipo_dia_p text, dt_retorno_p INOUT timestamp, ie_dia_atual_p text default null) FROM PUBLIC;

