-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gedipa_gerar_w_preparo_dil ( cd_material_p bigint, nr_seq_area_prep_p bigint, nm_usuario_p text, nr_prescricao_p bigint, nr_seq_prescricao_P bigint, ie_deleta_p text, nr_seq_etapa_hor_p bigint) AS $body$
DECLARE


nr_sequencia_w 			bigint;
nr_seq_gedipa_cabine_w 		bigint;
cd_material_dil_w 			bigint;
nr_seq_lote_fornec_w 		bigint;
cd_unidade_medida_w 		varchar(30);
cd_material_w			bigint;
nr_seq_ficha_tecnica_w	bigint;
qt_dose_w			double precision;
cd_unidade_medida_dose_w	varchar(30);
cd_unidade_medida_consumo_w varchar(30);
qt_dose_util_w			double precision;
ie_setar_qt_util_w		varchar(1);
ie_agrupador_w			smallint;
ie_agrupador_ant_w		smallint;

c01 CURSOR FOR
	SELECT	a.cd_material,
			b.nr_seq_ficha_tecnica,
			a.qt_dose,
			a.cd_unidade_medida_dose,
			b.cd_unidade_medida_consumo,
			a.ie_agrupador
	FROM	prescr_material a,
			material	b
	WHERE	a.cd_material			=	b.cd_material
	AND		nr_prescricao			=	nr_prescricao_p
	AND		nr_sequencia_diluicao	=	nr_seq_prescricao_P
	ORDER BY a.ie_agrupador;

	C02 CURSOR FOR
	SELECT 	a.nr_sequencia,
			a.cd_material,
			a.nr_seq_lote_fornec,
			b.cd_unidade_medida_consumo
	FROM 	gedipa_estoque_cabine a,
			material b
	WHERE 	a.cd_material 		= 	b.cd_material
	AND 	a.nr_seq_area_prep 	= 	nr_seq_area_prep_p
	AND		((a.cd_material		=	cd_material_w) OR (b.nr_seq_ficha_tecnica = nr_seq_ficha_tecnica_w))
	AND		qt_estoque > 0;

BEGIN

IF (ie_deleta_p = 'S') THEN
	DELETE 	FROM w_gedipa_preparo
	WHERE 	nm_usuario = nm_usuario_p
	AND		coalesce(ie_tipo_material,'M')	=	'D';
	COMMIT;
END IF;

ie_setar_qt_util_w := 'S';
ie_agrupador_ant_w := NULL;

OPEN C01;
LOOP
FETCH C01 INTO
	cd_material_w,
	nr_seq_ficha_tecnica_w,
	qt_dose_w,
	cd_unidade_medida_dose_w,
	cd_unidade_medida_consumo_w,
	ie_agrupador_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	BEGIN



	OPEN C02;
    LOOP
    FETCH C02 INTO
    	nr_seq_gedipa_cabine_w,
    	cd_material_dil_w,
    	nr_seq_lote_fornec_w,
    	cd_unidade_medida_w;
    EXIT WHEN NOT FOUND; /* apply on C02 */
    	BEGIN

        delete  FROM w_gedipa_preparo a
        where   a.nr_seq_gedipa_cabine = nr_seq_gedipa_cabine_w
        and     a.nr_seq_etapa_hor = nr_seq_etapa_hor_p
        and     a.cd_material = cd_material_dil_w
        and     coalesce(a.nr_seq_lote_fornec, 0) = coalesce(nr_seq_lote_fornec_w, 0);

		IF (coalesce(ie_agrupador_ant_w::text, '') = '') OR (ie_agrupador_ant_w <> ie_agrupador_w)		THEN
			ie_setar_qt_util_w := 'S';
		END IF;

		ie_agrupador_ant_w := ie_agrupador_w;

  	    qt_dose_util_w := 0;
	    IF (ie_setar_qt_util_w = 'S') THEN
	    	qt_dose_util_w := Obter_dose_convertida_quimio(cd_material_dil_w, qt_dose_w, cd_unidade_medida_dose_w, cd_unidade_medida_w);
	    	ie_setar_qt_util_w := 'N';
	    END IF;

    	SELECT 	nextval('w_gedipa_preparo_seq')
    	INTO STRICT	nr_sequencia_w
    	;

    	INSERT 	INTO w_gedipa_preparo(
    			nr_sequencia,
    			dt_atualizacao,
    			nm_usuario,
    			dt_atualizacao_nrec,
    			nm_usuario_nrec,
    			nr_seq_gedipa_cabine,
    			cd_material,
    			nr_seq_lote_fornec,
    			qt_dose_util,
    			cd_unidade_medida,
    			ie_tipo_material,
				nr_seq_etapa_hor)
    		VALUES (nr_sequencia_w,
    			clock_timestamp(),
    			nm_usuario_p,
    			clock_timestamp(),
    			nm_usuario_p,
    			nr_seq_gedipa_cabine_w,
    			cd_material_dil_w,
    			nr_seq_lote_fornec_w,
    			qt_dose_util_w,
    			cd_unidade_medida_w,
    			'D',
				nr_seq_etapa_hor_p);

    	END;
    END LOOP;
    CLOSE C02;

	END;
END LOOP;
CLOSE C01;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gedipa_gerar_w_preparo_dil ( cd_material_p bigint, nr_seq_area_prep_p bigint, nm_usuario_p text, nr_prescricao_p bigint, nr_seq_prescricao_P bigint, ie_deleta_p text, nr_seq_etapa_hor_p bigint) FROM PUBLIC;

