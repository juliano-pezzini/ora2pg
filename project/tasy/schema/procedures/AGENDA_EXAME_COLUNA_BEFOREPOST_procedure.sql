-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE agenda_exame_coluna_beforepost ( dt_referencia_p timestamp, cd_estabelecimento_p bigint, cd_agenda_p bigint, cd_convenio_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_proc_interno_p bigint, cd_medico_exec_p bigint, qt_peso_p bigint, cd_categoria_p text, cd_pessoa_fisica_p text, cd_plano_p text, ie_nr_seq_proc_int_enable_p text, ie_proced_enable_p text, ie_anestesia_p text, nm_usuario_p text, ie_agenda_p INOUT text, ie_consistencia_p INOUT text, ds_erro_p INOUT text) AS $body$
DECLARE

 
ie_medico_executor_w 	varchar(1);
ie_procedimento_w 	varchar(1);
ds_erro_w		varchar(255);
cd_retorno_w		bigint;
ie_consist_js_w		varchar(255) := '';
ie_anestesia_w	varchar(1);

BEGIN
if (cd_agenda_p IS NOT NULL AND cd_agenda_p::text <> '') and (ie_nr_seq_proc_int_enable_p IS NOT NULL AND ie_nr_seq_proc_int_enable_p::text <> '') and (ie_proced_enable_p IS NOT NULL AND ie_proced_enable_p::text <> '') then 
	begin 
	 
	select	coalesce(ie_medico_executor,'S') 
	into STRICT	ie_medico_executor_w 
	from	agenda 
	where	cd_agenda = cd_agenda_p;
	 
	if (ie_medico_executor_w = 'E') and (coalesce(cd_medico_exec_p::text, '') = '') then 
		begin 
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(37768);
		end;
	elsif (ie_medico_executor_w = 'N') and (cd_medico_exec_p IS NOT NULL AND cd_medico_exec_p::text <> '') then 
		begin 
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(37769);
		end;
	end if;
	 
	select	coalesce(ie_procedimento,'S') 
	into STRICT	ie_procedimento_w 
	from	agenda 
	where	cd_agenda = cd_agenda_p;
	 
	if (ie_procedimento_w = 'E') and 
		((coalesce(cd_procedimento_p::text, '') = '') or (coalesce(nr_seq_proc_interno_p::text, '') = '')) then 
		begin 
		if	((ie_proced_enable_p = 'S') and (coalesce(cd_procedimento_p::text, '') = '')) or 
			((ie_nr_seq_proc_int_enable_p = 'S') and (coalesce(nr_seq_proc_interno_p::text, '') = ''))then 
			begin 
			CALL Wheb_mensagem_pck.exibir_mensagem_abort(37772);
			end;
		end if;		
		end;
	elsif (ie_procedimento_w = 'N') and 
		((cd_procedimento_p IS NOT NULL AND cd_procedimento_p::text <> '') or (nr_seq_proc_interno_p IS NOT NULL AND nr_seq_proc_interno_p::text <> '')) then 
		begin 
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(37765);
		end;
	end if;	
	end;
	 
	if (cd_estabelecimento_p IS NOT NULL AND cd_estabelecimento_p::text <> '') and (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') and (dt_referencia_p IS NOT NULL AND dt_referencia_p::text <> '') and (cd_convenio_p IS NOT NULL AND cd_convenio_p::text <> '') and (cd_categoria_p IS NOT NULL AND cd_categoria_p::text <> '') and (cd_procedimento_p IS NOT NULL AND cd_procedimento_p::text <> '') and (ie_origem_proced_p IS NOT NULL AND ie_origem_proced_p::text <> '') and (nr_seq_proc_interno_p IS NOT NULL AND nr_seq_proc_interno_p::text <> '') and (cd_medico_exec_p IS NOT NULL AND cd_medico_exec_p::text <> '') and (cd_plano_p IS NOT NULL AND cd_plano_p::text <> '') then 
		begin 
		SELECT * FROM consistir_proc_conv_agenda( 
			cd_estabelecimento_p, cd_pessoa_fisica_p, dt_referencia_p, cd_agenda_p, cd_convenio_p, cd_categoria_p, cd_procedimento_p, ie_origem_proced_p, nr_seq_proc_interno_p, cd_medico_exec_p, 'E', cd_plano_p, null, null, null, null, ie_anestesia_p, null, null) INTO STRICT ie_consistencia_p, ie_agenda_p, cd_retorno_w, ie_consist_js_w;	
		end;
	end if;
	 
	if (nr_seq_proc_interno_p IS NOT NULL AND nr_seq_proc_interno_p::text <> '') then 
		begin 
		CALL consistir_proc_inativo(nr_seq_proc_interno_p, nm_usuario_p, cd_estabelecimento_p);
		end;
	end if;
	 
	ds_erro_w := consistir_peso_proc_agenda(cd_procedimento_p, ie_origem_proced_p, qt_peso_p, ds_erro_w);
	 
end if;
ds_erro_p	:= ds_erro_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE agenda_exame_coluna_beforepost ( dt_referencia_p timestamp, cd_estabelecimento_p bigint, cd_agenda_p bigint, cd_convenio_p bigint, cd_procedimento_p bigint, ie_origem_proced_p bigint, nr_seq_proc_interno_p bigint, cd_medico_exec_p bigint, qt_peso_p bigint, cd_categoria_p text, cd_pessoa_fisica_p text, cd_plano_p text, ie_nr_seq_proc_int_enable_p text, ie_proced_enable_p text, ie_anestesia_p text, nm_usuario_p text, ie_agenda_p INOUT text, ie_consistencia_p INOUT text, ds_erro_p INOUT text) FROM PUBLIC;

