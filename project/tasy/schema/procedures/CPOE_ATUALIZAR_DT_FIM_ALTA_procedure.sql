-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_atualizar_dt_fim_alta ( nr_atendimento_p bigint, dt_alta_p timestamp, nm_usuario_p text, cd_setor_atendimento_p bigint, ie_baixado_por_alta_p text) AS $body$
DECLARE


ds_lista_proc_susp_out_w	varchar(4000);
lista_itens_w				varchar(4000);
ie_hor_suspenso_w			boolean;
dt_entrada_w				atend_paciente_unidade.dt_entrada_unidade%type;
ie_inativa_item_w			motivo_alta.ie_inativa_item%type;

c01 CURSOR FOR
	SELECT	nr_sequencia
	from	cpoe_dieta
	where	nr_atendimento = nr_atendimento_p
	and 	coalesce(dt_suspensao::text, '') = ''
	and  	coalesce(dt_lib_suspensao::text, '') = ''
	and		((dt_fim > clock_timestamp()) or (coalesce(dt_fim::text, '') = ''))
	and		dt_atualizacao_nrec < dt_entrada_w;

c02 CURSOR FOR
	SELECT	nr_sequencia
	from	cpoe_material
	where	nr_atendimento = nr_atendimento_p
	and 	coalesce(dt_suspensao::text, '') = ''
	and  	coalesce(dt_lib_suspensao::text, '') = ''
	and		((dt_fim > clock_timestamp()) or (coalesce(dt_fim::text, '') = ''))
	and		dt_atualizacao_nrec < dt_entrada_w;

c03 CURSOR FOR
	SELECT	nr_sequencia
	from	cpoe_gasoterapia
	where	nr_atendimento = nr_atendimento_p
	and 	coalesce(dt_suspensao::text, '') = ''
	and  	coalesce(dt_lib_suspensao::text, '') = ''
	and		((dt_fim > clock_timestamp()) or (coalesce(dt_fim::text, '') = ''))
	and		dt_atualizacao_nrec < dt_entrada_w;

c04 CURSOR FOR
	SELECT	nr_sequencia
	from	cpoe_procedimento
	where	nr_atendimento = nr_atendimento_p
	and 	coalesce(dt_suspensao::text, '') = ''
	and  	coalesce(dt_lib_suspensao::text, '') = ''
	and		((dt_fim > clock_timestamp()) or (coalesce(dt_fim::text, '') = ''))
	and		dt_atualizacao_nrec < dt_entrada_w;

c05 CURSOR FOR
	SELECT	nr_sequencia
	from	cpoe_recomendacao
	where	nr_atendimento = nr_atendimento_p
	and 	coalesce(dt_suspensao::text, '') = ''
	and  	coalesce(dt_lib_suspensao::text, '') = ''
	and		((dt_fim > clock_timestamp()) or (coalesce(dt_fim::text, '') = ''))
	and		dt_atualizacao_nrec < dt_entrada_w;

c06 CURSOR FOR
	SELECT	nr_sequencia
	from	cpoe_hemoterapia	
	where	nr_atendimento = nr_atendimento_p
	and 	coalesce(dt_suspensao::text, '') = ''
	and  	coalesce(dt_lib_suspensao::text, '') = ''
	and		((dt_fim > clock_timestamp()) or (coalesce(dt_fim::text, '') = ''))
	and		dt_atualizacao_nrec < dt_entrada_w;

c07 CURSOR FOR
	SELECT	nr_sequencia
	from	cpoe_dialise
	where	nr_atendimento = nr_atendimento_p
	and 	coalesce(dt_suspensao::text, '') = ''
	and  	coalesce(dt_lib_suspensao::text, '') = ''
	and		((dt_fim > clock_timestamp()) or (coalesce(dt_fim::text, '') = ''))
	and		dt_atualizacao_nrec < dt_entrada_w;

c08 CURSOR FOR
	SELECT	nr_sequencia
	from	cpoe_anatomia_patologica
	where	nr_atendimento = nr_atendimento_p
	and 	coalesce(dt_suspensao::text, '') = ''
	and  	coalesce(dt_lib_suspensao::text, '') = ''
	and		((dt_fim > clock_timestamp()) or (coalesce(dt_fim::text, '') = ''))
	and		dt_atualizacao_nrec < dt_entrada_w;	
	
BEGIN

dt_entrada_w := clock_timestamp();

if (cd_setor_atendimento_p IS NOT NULL AND cd_setor_atendimento_p::text <> '') then
	select	coalesce(max(dt_entrada_unidade),clock_timestamp())
	into STRICT	dt_entrada_w
	from 	atend_paciente_unidade
	where 	nr_atendimento = nr_atendimento_p
	and 	cd_setor_atendimento = cd_setor_atendimento_p;
end if;
	
lista_itens_w := null;

select 	max(b.ie_inativa_item)
into STRICT	ie_inativa_item_w
from	atendimento_paciente a,
		motivo_alta b
where	a.cd_motivo_alta = b.cd_motivo_alta
and		a.nr_atendimento = nr_atendimento_p;

for r_c01_w in c01
loop
	begin

	update	cpoe_dieta
	set 	dt_suspensao  = dt_alta_p,
			dt_lib_suspensao = clock_timestamp(),
			ie_baixado_por_alta = CASE WHEN ie_baixado_por_alta_p='S' THEN 'S'  ELSE ie_baixado_por_alta END ,
			ie_forma_suspensao = CASE WHEN ie_baixado_por_alta_p='N' THEN 'I'  ELSE ie_forma_suspensao END ,
			dt_alta_medico = dt_alta_p
	where nr_sequencia = r_c01_w.nr_sequencia;

	if (coalesce(lista_itens_w::text, '') = '') then
		lista_itens_w :=  r_c01_w.nr_sequencia || ';N;S,';
	else
		lista_itens_w := lista_itens_w || r_c01_w.nr_sequencia || ';N;S,';

	end if;

	ie_hor_suspenso_w := true;

	end;
end loop;

for r_c02_w in c02
loop
	begin
	update	cpoe_material
	set 	dt_suspensao  = dt_alta_p,
			dt_lib_suspensao = clock_timestamp(),
			ie_baixado_por_alta = CASE WHEN ie_baixado_por_alta_p='S' THEN 'S'  ELSE ie_baixado_por_alta END ,
			ie_forma_suspensao = CASE WHEN ie_baixado_por_alta_p='N' THEN 'I'  ELSE ie_forma_suspensao END ,
			dt_alta_medico = dt_alta_p
	where nr_sequencia = r_c02_w.nr_sequencia;

	if (coalesce(lista_itens_w::text, '') = '') then
		lista_itens_w :=  r_c02_w.nr_sequencia || ';M;S,';
	else
		lista_itens_w := lista_itens_w || r_c02_w.nr_sequencia || ';M;S,';

	end if;

	ie_hor_suspenso_w := true;

	end;
end loop;

for r_c03_w in c03
loop
	begin
	update	cpoe_gasoterapia
	set 	dt_fim = dt_alta_p,
			ie_baixado_por_alta = CASE WHEN ie_baixado_por_alta_p='S' THEN 'S'  ELSE ie_baixado_por_alta END ,
			ie_forma_suspensao = CASE WHEN ie_baixado_por_alta_p='N' THEN 'I'  ELSE ie_forma_suspensao END ,
			dt_alta_medico = dt_alta_p
	where nr_sequencia = r_c03_w.nr_sequencia;

	if (coalesce(lista_itens_w::text, '') = '') then
		lista_itens_w :=  r_c03_w.nr_sequencia || ';G;S,';
	else
		lista_itens_w := lista_itens_w || r_c03_w.nr_sequencia || ';G;S,';

	end if;

	ie_hor_suspenso_w := true;

	end;
end loop;

for r_c04_w in c04
loop
	begin

		update	cpoe_procedimento
		set 	dt_suspensao  = dt_alta_p,
				dt_lib_suspensao = clock_timestamp(),
				ie_baixado_por_alta = CASE WHEN ie_baixado_por_alta_p='S' THEN 'S'  ELSE ie_baixado_por_alta END ,
				ie_forma_suspensao = CASE WHEN ie_baixado_por_alta_p='N' THEN 'I'  ELSE ie_forma_suspensao END ,
				dt_alta_medico = dt_alta_p
		where 	nr_sequencia = r_c04_w.nr_sequencia
		and ((ie_inativa_item_w <> 'E') or ((ie_duracao <> 'P') or (dt_inicio < clock_timestamp())));

	

	if (coalesce(lista_itens_w::text, '') = '') then
		lista_itens_w :=  r_c04_w.nr_sequencia || ';P;S,';
	else
		lista_itens_w := lista_itens_w || r_c04_w.nr_sequencia || ';P;S,';

	end if;

	ie_hor_suspenso_w := true;

	end;
end loop;

for r_c05_w in c05
loop
	begin	
	update	cpoe_recomendacao
	set 	dt_suspensao  = dt_alta_p,
			dt_lib_suspensao = clock_timestamp(),
			ie_baixado_por_alta = CASE WHEN ie_baixado_por_alta_p='S' THEN 'S'  ELSE ie_baixado_por_alta END ,
			ie_forma_suspensao = CASE WHEN ie_baixado_por_alta_p='N' THEN 'I'  ELSE ie_forma_suspensao END ,
			dt_alta_medico = dt_alta_p
	where nr_sequencia = r_c05_w.nr_sequencia;

	if (coalesce(lista_itens_w::text, '') = '') then
		lista_itens_w :=  r_c05_w.nr_sequencia || ';R;S,';
	else
		lista_itens_w := lista_itens_w || r_c05_w.nr_sequencia || ';R;S,';

	end if;

	ie_hor_suspenso_w := true;

	end;
end loop;

for r_c06_w in c06
loop
	begin
	update	cpoe_hemoterapia
	set 	dt_suspensao  = dt_alta_p,
			dt_lib_suspensao = clock_timestamp(),
			ie_baixado_por_alta = CASE WHEN ie_baixado_por_alta_p='S' THEN 'S'  ELSE ie_baixado_por_alta END ,
			ie_forma_suspensao = CASE WHEN ie_baixado_por_alta_p='N' THEN 'I'  ELSE ie_forma_suspensao END ,
			dt_alta_medico = dt_alta_p
	where nr_sequencia = r_c06_w.nr_sequencia;

	if (coalesce(lista_itens_w::text, '') = '') then
		lista_itens_w :=  r_c06_w.nr_sequencia || ';H;S,';
	else
		lista_itens_w := lista_itens_w || r_c06_w.nr_sequencia || ';H;S,';

	end if;

	ie_hor_suspenso_w := true;

	end;
end loop;

for r_c07_w in c07
loop
	begin
	update	cpoe_dialise
	set 	dt_suspensao  = dt_alta_p,
			dt_lib_suspensao = clock_timestamp(),
			ie_baixado_por_alta = CASE WHEN ie_baixado_por_alta_p='S' THEN 'S'  ELSE ie_baixado_por_alta END ,
			ie_forma_suspensao = CASE WHEN ie_baixado_por_alta_p='N' THEN 'I'  ELSE ie_forma_suspensao END ,
			dt_alta_medico = dt_alta_p
	where nr_sequencia = r_c07_w.nr_sequencia;

	if (coalesce(lista_itens_w::text, '') = '') then
		lista_itens_w :=  r_c07_w.nr_sequencia || ';D;S,';
	else
		lista_itens_w := lista_itens_w || r_c07_w.nr_sequencia || ';D;S,';

	end if;

	ie_hor_suspenso_w := true;

	end;
end loop;

for r_c08_w in c08
loop
	begin
	update	cpoe_anatomia_patologica
	set 	dt_suspensao  = dt_alta_p,
			dt_lib_suspensao = clock_timestamp(),
			ie_baixado_por_alta = CASE WHEN ie_baixado_por_alta_p='S' THEN 'S'  ELSE ie_baixado_por_alta END ,
			ie_forma_suspensao = CASE WHEN ie_baixado_por_alta_p='N' THEN 'I'  ELSE ie_forma_suspensao END ,
			dt_alta_medico = dt_alta_p
	where nr_sequencia = r_c08_w.nr_sequencia;

	if (coalesce(lista_itens_w::text, '') = '') then
		lista_itens_w :=  r_c08_w.nr_sequencia || ';AP;S,';
	else
		lista_itens_w := lista_itens_w || r_c08_w.nr_sequencia || ';AP;S,';

	end if;

	ie_hor_suspenso_w := true;

	end;
end loop;

if (ie_hor_suspenso_w) then
	ds_lista_proc_susp_out_w := cpoe_suspender_item_prescr('[' || lista_itens_w || ']', nr_atendimento_p, nm_usuario_p, null, null, 'N', ds_lista_proc_susp_out_w);
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_atualizar_dt_fim_alta ( nr_atendimento_p bigint, dt_alta_p timestamp, nm_usuario_p text, cd_setor_atendimento_p bigint, ie_baixado_por_alta_p text) FROM PUBLIC;

