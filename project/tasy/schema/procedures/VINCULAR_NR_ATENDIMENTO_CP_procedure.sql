-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vincular_nr_atendimento_cp ( NR_ATENDIMENTO_P ATENDIMENTO_PACIENTE.NR_ATENDIMENTO%TYPE, CP_PESSOA_FISICA_P ATENDIMENTO_PACIENTE.CD_PESSOA_FISICA%TYPE ) AS $body$
DECLARE

    nr_prescr_w pe_prescricao.nr_sequencia%type;

BEGIN

    SELECT
        max(a.nr_sequencia)
    INTO STRICT nr_prescr_w
    FROM PE_PRESCRICAO a 
    WHERE 
        (a.DT_LIBERACAO IS NOT NULL AND a.DT_LIBERACAO::text <> '') AND 
        coalesce(a.DT_INATIVACAO::text, '') = '' AND 
        CD_PESSOA_FISICA = CP_PESSOA_FISICA_P AND 
        coalesce(wheb_assist_pck.get_nivel_atencao_perfil, 'T') = a.ie_nivel_atencao AND
        coalesce(a.NR_ATENDIMENTO::text, '') = '';

    IF (nr_prescr_w IS NOT NULL AND nr_prescr_w::text <> '') THEN

        UPDATE PE_PRESCRICAO b
         SET b.NR_ATENDIMENTO = NR_ATENDIMENTO_P,
            b.DT_PRESCRICAO = OBTER_DATA_ENTRADA(NR_ATENDIMENTO_P)
        WHERE 
            b.NR_SEQUENCIA = nr_prescr_w;

        UPDATE PE_PRESCR_DIAG
         SET DT_START = OBTER_DATA_ENTRADA(NR_ATENDIMENTO_P)
        WHERE NR_SEQ_PRESCR = nr_prescr_w;

    END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vincular_nr_atendimento_cp ( NR_ATENDIMENTO_P ATENDIMENTO_PACIENTE.NR_ATENDIMENTO%TYPE, CP_PESSOA_FISICA_P ATENDIMENTO_PACIENTE.CD_PESSOA_FISICA%TYPE ) FROM PUBLIC;

