-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_valores_conpaci_ret (nr_seq_conpaci_ret_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
 
 
vl_nao_auditado_w			double precision;
vl_recebido_w				double precision;
vl_reapresentado_w			double precision;
vl_glosa_devida_w			double precision;
vl_glosa_indevida_w			double precision;
vl_adequado_amenor_w			double precision;
vl_adequado_amaior_w			double precision;
vl_pendente_w				double precision;
vl_inicial_w				double precision;
vl_perdas_w				double precision;
ie_deduzir_reap_w			varchar(1);
cd_estabelecimento_w			smallint;

/* 
 
ie_acao 
 
0        Não Auditado 
1        Recebimento 
2        Reapresentação 
3        Glosa Devida 
4        Glosa Indevida 
5        Adequação a menor 
6        Adequação a maior 
7		Perdas 
 
*/
 
 

BEGIN 
 
select	max(b.cd_estabelecimento) 
into STRICT	cd_estabelecimento_w 
from	conta_paciente b, 
	conta_paciente_retorno a 
where	a.nr_interno_conta	= b.nr_interno_conta 
and	a.nr_sequencia		= nr_seq_conpaci_ret_p;
 
ie_deduzir_reap_w := obter_param_usuario(66, 22, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_deduzir_reap_w);
 
update	conta_paciente_retorno 
set	vl_pendente		= 0, 
	vl_reapresentacao	= 0, 
	vl_glosa_devida		= 0, 
	vl_glosa_indevida	= 0, 
	vl_nao_auditado		= 0, 
	vl_recebido		= 0, 
	vl_perdas			= 0 
where	nr_sequencia		= nr_seq_conpaci_ret_p;
 
select	coalesce(sum(CASE WHEN b.ie_acao=0 THEN  vl_historico  ELSE 0 END ),0), 
	coalesce(sum(CASE WHEN b.ie_acao=1 THEN  vl_historico  ELSE 0 END ),0), 
	coalesce(sum(CASE WHEN b.ie_acao=2 THEN  vl_historico  ELSE 0 END ),0), 
	coalesce(sum(CASE WHEN b.ie_acao=3 THEN  vl_historico  ELSE 0 END ),0), 
	coalesce(sum(CASE WHEN b.ie_acao=4 THEN  vl_historico  ELSE 0 END ),0), 
	coalesce(sum(CASE WHEN b.ie_acao=5 THEN  vl_historico  ELSE 0 END ),0), 
	coalesce(sum(CASE WHEN b.ie_acao=6 THEN  vl_historico  ELSE 0 END ),0), 
	coalesce(sum(CASE WHEN b.ie_acao=7 THEN  vl_historico  ELSE 0 END ),0) 
into STRICT	vl_nao_auditado_w, 
	vl_recebido_w, 
	vl_reapresentado_w, 
	vl_glosa_devida_w, 
	vl_glosa_indevida_w, 
	vl_adequado_amenor_w, 
	vl_adequado_amaior_w, 
	vl_perdas_w 
from	hist_audit_conta_paciente b, 
	conta_paciente_ret_hist a 
where	a.nr_seq_conpaci_ret	= nr_seq_conpaci_ret_p 
and	a.nr_seq_hist_audit		= b.nr_sequencia;
 
if (coalesce(ie_deduzir_reap_w,'S') = 'N') then 
	vl_reapresentado_w	:= 0;
end if;
 
update	conta_paciente_retorno 
set	vl_pendente		= vl_inicial - 
				 vl_glosa_devida_w - 
				 vl_nao_auditado_w - 
				 vl_recebido_w - 
				 vl_reapresentado_w - 
				 vl_glosa_indevida_w - 
				 vl_adequado_amenor_w + 
				 vl_adequado_amaior_w - 
				 vl_perdas_w, 
	vl_reapresentacao		= vl_reapresentado_w, 
	vl_glosa_devida		= vl_glosa_devida_w, 
	vl_glosa_indevida		= vl_glosa_indevida_w, 
	vl_nao_auditado		= vl_nao_auditado_w, 
	vl_recebido		= vl_recebido_w, 
	vl_perdas			= vl_perdas_w 
where	nr_sequencia		= nr_seq_conpaci_ret_p;
 
select	vl_inicial, 
	vl_pendente 
into STRICT	vl_inicial_w, 
	vl_pendente_w 
from	conta_paciente_retorno 
where	nr_sequencia		= nr_seq_conpaci_ret_p;
 
if	(vl_inicial_w	<> 	(vl_pendente_w + 
				 vl_glosa_devida_w + 
				 vl_nao_auditado_w + 
				 vl_recebido_w + 
				 vl_reapresentado_w + 
				 vl_glosa_indevida_w + 
				 vl_adequado_amenor_w - 
				 vl_adequado_amaior_w + 
				vl_perdas_w)) then 
	rollback;
	/*r.aise_application_error(-20011, 'O valor inicial não bate com o valor pendente calculado!' || chr(13) || 
				'Vl inicial: ' || VL_INICIAL_W || chr(13) || 
				'Vl pendente: ' || (vl_pendente_w + 
						 vl_glosa_devida_w + 
						 vl_nao_auditado_w + 
						 vl_recebido_w + 
						 vl_reapresentado_w + 
						 vl_glosa_indevida_w + 
						 vl_adequado_amenor_w - 
						 vl_adequado_amaior_w + 
						vl_perdas_w));*/
						 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(263282,'VL_INICIAL_W='||VL_INICIAL_W||';'|| 
							'VL_PENDENTE_W='||(vl_pendente_w + 
										vl_glosa_devida_w + 
										vl_nao_auditado_w + 
										vl_recebido_w + 
										vl_reapresentado_w + 
										vl_glosa_indevida_w + 
										vl_adequado_amenor_w - 
										vl_adequado_amaior_w + 
										vl_perdas_w));
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_valores_conpaci_ret (nr_seq_conpaci_ret_p bigint, nm_usuario_p text) FROM PUBLIC;

