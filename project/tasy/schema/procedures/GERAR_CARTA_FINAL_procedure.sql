-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_carta_final ( nr_seq_carta_p bigint, nm_usuario_p text, nr_seq_nova_carta_p INOUT bigint) AS $body$
DECLARE

 
nr_sequencia_w			carta_medica.nr_sequencia%type;
cd_medico_w				medico.cd_pessoa_fisica%type;


BEGIN 
 
select	nextval('carta_medica_seq') 
into STRICT	nr_sequencia_w
;
 
select	max(a.cd_pessoa_fisica) 
into STRICT	cd_medico_w 
from	medico a, 
		usuario b 
where	a.cd_pessoa_fisica = b.cd_pessoa_fisica 
and		b.nm_usuario = nm_usuario_p 
and		coalesce(a.ie_situacao, 'A')	= 'A';
 
insert	into carta_medica(NR_SEQUENCIA, 
							DT_ATUALIZACAO, 
							NM_USUARIO, 
							DT_ATUALIZACAO_NREC, 
							CD_PESSOA_FISICA, 
							CD_MEDICO_responsavel, 
							NR_ATENDIMENTO, 
							IE_LOG, 
							NR_VERSAO, 
							IE_REVISAO, 
							NR_SEQ_CARTA_MAE, 
							nm_usuario_original, 
							ds_carta, 
							ie_preliminar, 
							nr_seq_modelo) 
			SELECT		nr_sequencia_w, 
						clock_timestamp(), 
						nm_usuario_p, 
						clock_timestamp(), 
						cd_pessoa_fisica, 
						cd_medico_w, 
						nr_atendimento, 
						'N', 
						CASE WHEN coalesce(nr_seq_carta_mae::text, '') = '' THEN 2  ELSE nr_versao + 1 END , 
						'N', 
						coalesce(nr_seq_carta_mae,nr_sequencia), 
						nm_usuario_original, 
						ds_carta, 
						'N', 
						nr_seq_modelo 
			from	carta_medica 
			where	nr_sequencia	= nr_seq_carta_p;
						 
update	carta_medica 
set		ie_log	= 'S' 
where	nr_sequencia	= nr_seq_carta_p;
 
commit;
 
nr_seq_nova_carta_p	:= nr_sequencia_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_carta_final ( nr_seq_carta_p bigint, nm_usuario_p text, nr_seq_nova_carta_p INOUT bigint) FROM PUBLIC;

