-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE san_gerar_seq_isbt ( nr_sequencia_p bigint, nm_usuario_p text, ie_fim_num_p INOUT text, ie_seq_isbt_existe_p INOUT text) AS $body$
DECLARE



nr_seq_regra_w		bigint;
nr_inicial_w		bigint;
nr_final_w		bigint;
nr_atual_w		bigint;
nr_seq_isbt_w		varchar(20);
ie_atualiza_w		varchar(1);
ie_existe_w		varchar(1);
dt_doacao_w		timestamp;


BEGIN

if (coalesce(nr_sequencia_p,0) > 0) then

	select	max(nr_sequencia)
	into STRICT	nr_seq_regra_w
	from	san_regra_seq_isbt
	where	coalesce(ie_situacao,'A') = 'A'
	and	clock_timestamp() between  trunc(dt_vigencia_ini) and fim_dia(dt_vigencia_fim);

	if (nr_seq_regra_w IS NOT NULL AND nr_seq_regra_w::text <> '') then

		select	nr_inicial,
			nr_final,
			nr_atual
		into STRICT	nr_inicial_w,
			nr_final_w,
			nr_atual_w
		from	san_regra_seq_isbt
		where	nr_sequencia = nr_seq_regra_w;

		if (nr_atual_w = 0) then
			nr_seq_isbt_w := nr_inicial_w;
		elsif ((nr_atual_w + 1) <= nr_final_w) then
			nr_seq_isbt_w := nr_atual_w + 1;
		end if;

		if (nr_seq_isbt_w IS NOT NULL AND nr_seq_isbt_w::text <> '') then
			-- Verifica se já tem gravado nr_seq_isbt
			select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ie_atualiza_w
			from	san_doacao
			where	nr_sequencia = nr_sequencia_p
			and	coalesce(nr_seq_isbt::text, '') = '';

			if (ie_atualiza_w = 'S') then
				select	max(dt_doacao)
				into STRICT	dt_doacao_w
				from	san_doacao
				where	nr_sequencia = nr_sequencia_p;

				-- Verifica se existe doacao com este nr_seq_isbt (para garantir que é única)
				select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
				into STRICT	ie_existe_w
				from	san_doacao
				where	nr_seq_isbt	= nr_seq_isbt_w
				AND	TO_CHAR(dt_doacao,'yy')	= to_char(dt_doacao_w,'yy');

				ie_seq_isbt_existe_p := ie_existe_w;
				if (ie_existe_w = 'N') then
					update	san_doacao
					set	nr_seq_isbt	= nr_seq_isbt_w
					where	nr_sequencia	= nr_sequencia_p;

					update	san_regra_seq_isbt
					set	nr_atual	= nr_seq_isbt_w
					where	nr_sequencia	= nr_seq_regra_w;

					ie_fim_num_p	:= 'N';
				end if;
			end if;
		else
			select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
			into STRICT	ie_fim_num_p
			from	san_regra_seq_isbt
			where	nr_sequencia	= nr_seq_regra_w
			and	nr_final	<= nr_atual;
		end if;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE san_gerar_seq_isbt ( nr_sequencia_p bigint, nm_usuario_p text, ie_fim_num_p INOUT text, ie_seq_isbt_existe_p INOUT text) FROM PUBLIC;

