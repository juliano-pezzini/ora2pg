-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_processa_resposta_aud_v60 ( nr_seq_resp_aud_p ptu_resposta_auditoria.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_confirmacao_p INOUT ptu_confirmacao.nr_sequencia%type) AS $body$
DECLARE

 
ie_item_existe_w	varchar(1);
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
nr_seq_execucao_w	ptu_resposta_auditoria.nr_sequencia%type;


BEGIN 
 
cd_estabelecimento_w := cd_estabelecimento_p;
 
--Quando as transações são geradas pelo WebService, não existe estabelecimento definido, então é verificado o estabeleicmento do parâmetro 
if ( coalesce(cd_estabelecimento_w::text, '') = ''	) then 
	cd_estabelecimento_w := ptu_obter_estab_padrao;
end if;
 
-- Gerar as informações das tabelas do PTU para as tabelas de Guia ou Requisição 00404 - Resposta de Auditoria 
CALL ptu_gerar_resp_auditoria_v60(nr_seq_resp_aud_p, nm_usuario_p, cd_estabelecimento_w);
 
--Gerar as informações das tabelas do PTU para as tabelas de Guia ou Requisição 00404 - Resposta de Auditoria 
ie_item_existe_w := ptu_gerar_resp_aud_item_v60(nr_seq_resp_aud_p, nm_usuario_p, cd_estabelecimento_w, ie_item_existe_w);
 
--Gerar as inconsistências recebidas no XML da 00404 - Resposta de Auditoria 
CALL ptu_gerar_incon_resp_aud_v60(nr_seq_resp_aud_p, nm_usuario_p, cd_estabelecimento_w);
 
select	nr_seq_execucao 
into STRICT	nr_seq_execucao_w 
from	ptu_resposta_auditoria 
where	nr_sequencia = nr_seq_resp_aud_p;
 
--Se algum item do arquivo XML não for encontrado na base o sistema não processa o pedido 
if ( ie_item_existe_w = 'S' ) then 
	-- Gerar as informações referente as inconsistências dos itens 00404 - Resposta de Auditoria 
	CALL ptu_atualiza_resposta_aud_v60(nr_seq_resp_aud_p, nm_usuario_p, cd_estabelecimento_w);
elsif ( ie_item_existe_w = 'N' ) then 
	-- Tipo de respota RAI- Resposta de Auditoria Inválida 
	CALL ptu_gestao_envio_confirmacao(nr_seq_execucao_w, cd_estabelecimento_w, 'RAI', nm_usuario_p);
end if;
 
--Retorna a sequência da resposta de confirmação gerada para o 00404 - Resposta de Auditoria, esta sequência é utilizada pelo WebService para gerar o XML de resposta do pedido 
select (select	max(nr_sequencia) 
	from	ptu_confirmacao c 
	where	c.nr_seq_execucao	= a.nr_seq_execucao 
	and	c.cd_unimed_executora	= a.cd_unimed_executora) nr_seq_resp_ped_aut 
into STRICT	nr_seq_confirmacao_p 
from	ptu_resposta_auditoria a 
where	a.nr_sequencia = nr_seq_resp_aud_p;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_processa_resposta_aud_v60 ( nr_seq_resp_aud_p ptu_resposta_auditoria.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, nr_seq_confirmacao_p INOUT ptu_confirmacao.nr_sequencia%type) FROM PUBLIC;

