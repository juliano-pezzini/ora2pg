-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE verifica_refresh_tela_senhas ( nr_seq_local_p bigint, dt_ultima_visualizacao_p INOUT timestamp, qt_ultimo_count_p INOUT bigint, ie_atualiza_p INOUT text) AS $body$
DECLARE


ie_retorno_w		varchar(1);
qt_count_w		bigint;
dt_atualizacao_w	timestamp;


BEGIN

select	count(*)
into STRICT	qt_count_w
from	regra_liberacao_fila
where	nr_seq_local_senha = nr_seq_local_p;

select	max(dt_atualizacao)
into STRICT	dt_atualizacao_w
from	regra_liberacao_fila
where	nr_seq_local_senha = nr_seq_local_p;

ie_atualiza_p := 'N';
if (qt_count_w <> qt_ultimo_count_p) then
	ie_atualiza_p := 'S'; -- Se tem mais ou menos registros do que na última verificação, deve atualizar a tela.
else
	if (coalesce(dt_atualizacao_w, dt_ultima_visualizacao_p - 1) > dt_ultima_visualizacao_p) then
		ie_atualiza_p := 'S'; -- Se a data da última atualização da tabela for maior do que na última verificação.
	else
		ie_atualiza_p := 'N'; -- Se não acontecer nenhum dos tratamentos acima, não deve atualizar a tela.
	end if;
end if;

qt_ultimo_count_p := qt_count_w;
dt_ultima_visualizacao_p := dt_atualizacao_w;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE verifica_refresh_tela_senhas ( nr_seq_local_p bigint, dt_ultima_visualizacao_p INOUT timestamp, qt_ultimo_count_p INOUT bigint, ie_atualiza_p INOUT text) FROM PUBLIC;

