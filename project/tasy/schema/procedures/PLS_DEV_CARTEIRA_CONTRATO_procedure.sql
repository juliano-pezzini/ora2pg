-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_dev_carteira_contrato ( nr_contrato_p bigint, nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text ) AS $body$
DECLARE


cd_usuario_plano_w		pls_segurado_carteira.cd_usuario_plano%type;
nr_via_solicitacao_w		pls_segurado_carteira.nr_via_solicitacao%type;
dt_validade_carteira_w		pls_segurado_carteira.dt_validade_carteira%type;

C01 CURSOR FOR
	SELECT	a.cd_usuario_plano,
		a.nr_via_solicitacao,
		a.dt_validade_carteira
	from	pls_segurado c,
		pls_contrato b,
		pls_segurado_carteira a
	where	b.nr_contrato = nr_contrato_p
	and 	b.nr_sequencia = c.nr_seq_contrato
	and 	c.nr_sequencia = a.nr_seq_segurado
	and 	a.ie_situacao = 'D'
	and 	not exists (	SELECT	1 /* Verifica se já foi devolvida */
				from	pls_segurado_cart_estagio x
				where	x.nr_seq_cartao_seg = a.nr_sequencia
				and	x.ie_estagio_emissao = '8'
				and	a.nr_via_solicitacao = x.nr_via
			)
	and 	not exists (    select 	1 /* Verifica se já foi incluso no lote */
				from 	pls_carteira_devolucao y
				where	y.nr_seq_lote = nr_seq_lote_p
				and 	y.cd_usuario_plano = a.cd_usuario_plano
				and 	y.nr_via = a.nr_via_solicitacao
			);


BEGIN


open C01;
loop
fetch C01 into
	cd_usuario_plano_w,
	nr_via_solicitacao_w,
	dt_validade_carteira_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	insert	into	pls_carteira_devolucao(nr_sequencia,
		 nr_seq_lote,
		 cd_estabelecimento,
		 dt_atualizacao,
		 nm_usuario,
		 dt_atualizacao_nrec,
		 nm_usuario_nrec,
		 cd_usuario_plano,
		 nr_via,
		 dt_validade_carteira)
	values (nextval('pls_carteira_devolucao_seq'),
		 nr_seq_lote_p,
		 cd_estabelecimento_p,
		 clock_timestamp(),
		 nm_usuario_p,
		 clock_timestamp(),
		 nm_usuario_p,
		 cd_usuario_plano_w,
		 nr_via_solicitacao_w,
		 dt_validade_carteira_w);


	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_dev_carteira_contrato ( nr_contrato_p bigint, nr_seq_lote_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text ) FROM PUBLIC;

