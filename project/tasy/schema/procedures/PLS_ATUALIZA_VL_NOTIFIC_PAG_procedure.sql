-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_atualiza_vl_notific_pag (nr_seq_pagador_p pls_notificacao_pagador.nr_sequencia%type) AS $body$
DECLARE

vl_juros_w		pls_notificacao_pagador.vl_juros%type;
vl_multa_w		pls_notificacao_pagador.vl_multa%type;
vl_pagador_w		pls_notificacao_pagador.vl_pagador%type;
vl_pagar_w		pls_notificacao_pagador.vl_pagar%type;
ie_titulo_perda_w	pls_notificacao_regra.ie_titulo_perda%type;

BEGIN
 
begin 
	select a.ie_titulo_perda 
	into STRICT	ie_titulo_perda_w 
	from  pls_notificacao_regra	a, 
		pls_notificacao_lote	b, 
		pls_notificacao_pagador	c 
	where  a.nr_sequencia	= b.nr_seq_regra 
	and	b.nr_sequencia	= c.nr_seq_lote 
	and	c.nr_sequencia	= nr_seq_pagador_p;
exception 
	when no_data_found then ie_titulo_perda_w := null;
end;
 
select	sum(vl_saldo_titulo), 
	sum(vl_juros), 
	sum(vl_multa), 
	sum(vl_pagar) 
into STRICT	vl_pagar_w, 
	vl_juros_w, 
	vl_multa_w, 
	vl_pagador_w 
from	pls_notificacao_item 
where	nr_seq_notific_pagador	= nr_seq_pagador_p;
 
update	pls_notificacao_pagador 
set	vl_pagador	= CASE WHEN ie_titulo_perda_w='S' THEN vl_pagador_w  ELSE vl_pagar_w END , 
	vl_juros	= vl_juros_w, 
	vl_multa	= vl_multa_w, 
	vl_pagar	= vl_pagar_w 
where	nr_sequencia	= nr_seq_pagador_p;
 
commit;	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_atualiza_vl_notific_pag (nr_seq_pagador_p pls_notificacao_pagador.nr_sequencia%type) FROM PUBLIC;

