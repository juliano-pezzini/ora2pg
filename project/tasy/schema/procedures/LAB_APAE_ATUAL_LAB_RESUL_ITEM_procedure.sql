-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_apae_atual_lab_resul_item (nr_prescricao_p text, nr_seq_prescr_p bigint, nr_seq_exame_p bigint, ds_resultado_p text, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE


nr_seq_prescr_w prescr_procedimento.nr_sequencia%type;
ie_formato_resultado_w exame_laboratorio.ie_formato_resultado%type;
qt_resultado_w exame_lab_result_item.qt_resultado%type;
pr_resultado_w exame_lab_result_item.pr_resultado%type;
ds_resultado_w exame_lab_result_item.ds_resultado%type;
qt_resultado_ant_w exame_lab_result_item.qt_resultado%type;
pr_resultado_ant_w exame_lab_result_item.pr_resultado%type;
ds_resultado_ant_w exame_lab_result_item.ds_resultado%type;
cd_exame_w exame_laboratorio.cd_exame%type;
ds_erro_w varchar(4000);
nr_seq_resultado_w exame_lab_resultado.nr_seq_resultado%type;
nr_repeticao_w lote_ent_res_ant_repet.nr_repeticao%type;
nr_seq_metodo_w metodo_exame_lab.nr_sequencia%type;
nr_seq_material_w material_exame_lab.nr_sequencia%type;
nr_seq_ficha_lote_w lote_ent_sec_ficha.nr_sequencia%type;
ie_atualizou_resultado_w varchar(1);
ie_insere_repeticao_w varchar(1);
ds_resultado_ww exame_lab_result_item.ds_resultado%type;
ds_material_criterio_w varchar(255);
ds_mensagem_criterio_w varchar(4000);
ds_metodo_criterio_w varchar(255);


BEGIN
qt_resultado_w := 0;
pr_resultado_w := null;
ds_resultado_w := null;
qt_resultado_ant_w := null;
pr_resultado_ant_w := null;
ds_resultado_ant_w := null;
ie_atualizou_resultado_w := 'N';
ie_insere_repeticao_w := 'S';
ds_resultado_ww := null;


select MAX(substr(ie_formato_resultado,1,2)),
       MAX(coalesce(cd_exame_integracao,cd_exame))
into STRICT   ie_formato_resultado_w,
       cd_exame_w
from   exame_laboratorio
where  nr_seq_exame = nr_seq_exame_p;

if (coalesce(ds_resultado_p::text, '') = '') then
   ie_insere_repeticao_w := 'N';
end if;

--gravar_log_lab_pragma(89,nr_prescricao_p||'-'||nr_seq_prescr_p||'-'||ds_resultado_p||' cd_exame_w: '||cd_exame_w||' ie_formato_resultado_w: '||ie_formato_resultado_w,'PERKINS');
if (cd_exame_w IS NOT NULL AND cd_exame_w::text <> '') and (ds_resultado_p IS NOT NULL AND ds_resultado_p::text <> '') then
  begin
    ds_resultado_ww := replace(ds_resultado_p,'.',',');
    --gravar_log_lab_pragma(89,'0.3 ---- '||cd_exame_w||'-'||qt_resultado_w||'nr_prescricao_p='||nr_prescricao_p||' - '||ie_formato_resultado_w,'PERKINS');
    if (ie_formato_resultado_w = 'V') then
      begin
      qt_resultado_w := ds_resultado_p;
      exception
        when others then
        begin
          begin
          qt_resultado_w := replace(ds_resultado_p,',','.');
          --gravar_log_lab_pragma(89,'0.7'||cd_exame_w||'-'||qt_resultado_w||'nr_prescricao_p='||nr_prescricao_p||' - '||ie_formato_resultado_w,'PERKINS');
          exception
            when others then
            begin
            qt_resultado_w := replace(ds_resultado_p,'.',',');
            --gravar_log_lab_pragma(89,'0.7'||cd_exame_w||'-'||qt_resultado_w||'nr_prescricao_p='||nr_prescricao_p||' - '||ie_formato_resultado_w,'PERKINS');
            end;
          end;
        end;
      end;

    elsif (ie_formato_resultado_w = 'D') then
      ds_resultado_w := ds_resultado_p;
      --gravar_log_lab_pragma(89,'0.8'||cd_exame_w||'-'||ds_resultado_w||'nr_prescricao_p='||nr_prescricao_p||' - '||ie_formato_resultado_w,'PERKINS');
    elsif (ie_formato_resultado_w = 'P') then
      pr_resultado_w :=  (coalesce(ds_resultado_p,0))::numeric;
      --gravar_log_lab_pragma(89,'0.9'||cd_exame_w||'-'||pr_resultado_w||'nr_prescricao_p='||nr_prescricao_p||' - '||ie_formato_resultado_w,'PERKINS');
    elsif (ie_formato_resultado_w = 'DV') then
      --gravar_log_lab_pragma(89,'1'||cd_exame_w||'-'||ds_resultado_p||'nr_prescricao_p='||nr_prescricao_p,'PERKINS');
      if  ((ds_resultado_ww = somente_numero_virg_char(ds_resultado_ww)) and ((somente_numero_virg_char(ds_resultado_ww) IS NOT NULL AND (somente_numero_virg_char(ds_resultado_ww))::text <> ''))) then
        begin
        qt_resultado_w := ds_resultado_ww;
        exception
          when others then
            begin
            qt_resultado_w := replace(ds_resultado_ww,',','.');
            exception
              when others then
                qt_resultado_w := replace(ds_resultado_ww,'.',',');
            end;
        end;
        --gravar_log_lab_pragma(89,'2'||cd_exame_w||'-'||ds_resultado_ww||'nr_prescricao_p='||nr_prescricao_p||' nr_seq_exame_p: '||nr_seq_exame_p,'PERKINS');
      else
        ds_resultado_w := ds_resultado_ww;
      end if;
    end if;
  exception
    when others then
    begin
      --gravar_log_lab_pragma(89,substr('Error raised: '|| DBMS_UTILITY.FORMAT_ERROR_BACKTRACE || ' - '||sqlerrm,1,2000),'PERKINS');
      commit;
    end;
  end;
else
  ds_erro_w := wheb_mensagem_pck.get_texto(281350,null)||nr_seq_exame_p;
end if;

if (coalesce(ds_resultado_w::text, '') = '') then
  ds_resultado_w := '';
end if;


if (cd_exame_w IS NOT NULL AND cd_exame_w::text <> '') then

  select   MAX(nr_seq_resultado)
  into STRICT  nr_seq_resultado_w
  from  exame_lab_resultado
  where  nr_prescricao = nr_prescricao_p;

  if (nr_seq_resultado_w IS NOT NULL AND nr_seq_resultado_w::text <> '') then


    select   max(nr_seq_metodo),
      max(nr_seq_material)
    into STRICT   nr_seq_metodo_w,
      nr_seq_material_w
    from   exame_lab_result_item
    where  nr_seq_resultado = nr_seq_resultado_w
    and  nr_seq_prescr = nr_seq_prescr_p;

    select   max(qt_resultado),
      max(pr_resultado),
      max(ds_resultado)
    into STRICT   qt_resultado_ant_w,
      pr_resultado_ant_w,
      ds_resultado_ant_w
    from   exame_lab_result_item
    where  nr_seq_resultado = nr_seq_resultado_w
    and  nr_seq_prescr = nr_seq_prescr_p
    and   ((qt_resultado <> 0) or (pr_resultado <> 0) or (ds_resultado IS NOT NULL AND ds_resultado::text <> ''));

    select   coalesce(MAX(nr_repeticao),0)
    into STRICT  nr_repeticao_w
    from  lote_ent_res_ant_repet
    where  nr_prescricao = nr_prescricao_p
    and    nr_seq_prescr = nr_seq_prescr_p
    and    nr_seq_exame  = nr_seq_exame_p;

    select   MAX(nr_sequencia)
    into STRICT  nr_seq_ficha_lote_w
    from  lote_ent_sec_ficha
    where  nr_prescricao = nr_prescricao_p;


    if ((OBTER_FUNCAO_ATIVA=719) or (nr_repeticao_w < 6)) then

      qt_resultado_ant_w := qt_resultado_w;
      pr_resultado_ant_w := pr_resultado_w;
      ds_resultado_ant_w := ds_resultado_w;

      if (ie_insere_repeticao_w = 'S') then
        insert into lote_ent_res_ant_repet(nr_sequencia,
                      dt_atualizacao,
                      nm_usuario,
                      dt_atualizacao_nrec,
                      nm_usuario_nrec,
                      nr_prescricao,
                      nr_seq_resultado,
                      nr_seq_prescr,
                      nr_seq_exame,
                      nr_seq_ficha_lote,
                      nr_repeticao,
                      qt_result_ant,
                      pr_result_ant,
                      ds_result_ant,
                      nr_seq_metodo,
                      nr_seq_material )
            values (nextval('lote_ent_res_ant_repet_seq'),
                      clock_timestamp(),
                      nm_usuario_p,
                      clock_timestamp(),
                      nm_usuario_p,
                      nr_prescricao_p,
                      nr_seq_resultado_w,
                      nr_seq_prescr_p,
                      nr_seq_exame_p,
                      nr_seq_ficha_lote_w,
                      nr_repeticao_w + 1,
                      qt_resultado_ant_w,
                      pr_resultado_ant_w,
                      ds_resultado_ant_w,
                      nr_seq_metodo_w,
                      nr_seq_material_w);
      end if;
      --gravar_log_lab_pragma(89,'3'||cd_exame_w||' ds: '||ds_resultado_ant_w||'nr_prescricao_p='||nr_prescricao_p||' nr_seq_exame_p: '||nr_seq_exame_p||' qt: '||qt_resultado_ant_w,'PERKINS');
      if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_prescr_p IS NOT NULL AND nr_seq_prescr_p::text <> '') and (nr_seq_exame_p IS NOT NULL AND nr_seq_exame_p::text <> '') then

        update  prescr_procedimento
        set    ie_exame_bloqueado = 'N'
        where  nr_sequencia = nr_seq_prescr_p
        and    nr_prescricao = nr_prescricao_p
        and    nr_seq_exame = nr_seq_exame_p
        and    ie_exame_bloqueado = 'R';

      end if;


      --gravar_log_lab_pragma(89,'Resultado - '||nr_prescricao_p||' - '||nr_seq_prescr_p||' - '||cd_exame_w||' - '||qt_resultado_ant_w||' - '||ds_resultado_ant_w,'PERKINS');
      commit;

      ds_erro_w  := Atualizar_Lab_Result_Item(  nr_prescricao_p, nr_seq_prescr_p, cd_exame_w, coalesce(qt_resultado_ant_w, qt_resultado_w), pr_resultado_ant_w, ds_resultado_ant_w, '', '', '', nm_usuario_p, null, '', '', '', clock_timestamp(), ds_erro_w);
      commit;

      if (coalesce(nr_seq_ficha_lote_w,0) > 0) then

        select  SUBSTR(lab_cons_valor_result_lote(nr_seq_exame_p, nr_seq_material_w, coalesce(qt_resultado_ant_w,pr_resultado_ant_w), ds_resultado_ant_w, nr_prescricao_p, nr_seq_prescr_p,9),1,255),
            SUBSTR(lab_cons_valor_result_lote(nr_seq_exame_p, nr_seq_material_w, coalesce(qt_resultado_ant_w,pr_resultado_ant_w), ds_resultado_ant_w, nr_prescricao_p, nr_seq_prescr_p,3),1,4000),
            SUBSTR(lab_cons_valor_result_lote(nr_seq_exame_p, nr_seq_material_w, coalesce(qt_resultado_ant_w,pr_resultado_ant_w), ds_resultado_ant_w, nr_prescricao_p, nr_seq_prescr_p,10),1,255)
        into STRICT  ds_material_criterio_w,
            ds_mensagem_criterio_w,
            ds_metodo_criterio_w
;

        update  exame_lab_result_item
        set    DS_MATERIAL_CRITERIO = ds_material_criterio_w,
            DS_MENSAGEM_CRITERIO = ds_mensagem_criterio_w,
            DS_METODO_CRITERIO    = ds_metodo_criterio_w
        where  nr_seq_resultado = nr_seq_resultado_w
        and    nr_seq_prescr = nr_seq_prescr_p
        and    nr_seq_exame = nr_seq_exame_p;

        commit;

      end if;

    end if;
  end if;

end if;

ds_erro_p := ds_erro_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_apae_atual_lab_resul_item (nr_prescricao_p text, nr_seq_prescr_p bigint, nr_seq_exame_p bigint, ds_resultado_p text, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

