-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_d301_segmento_nad ( nr_seq_dataset_p bigint, nm_usuario_p text) AS $body$
DECLARE



cd_postal_w		d301_segmento_nad.cd_postal%type;
ds_cidade_w		d301_segmento_nad.ds_cidade%type;
ds_compl_endereco_w	d301_segmento_nad.ds_compl_endereco%type;
ds_dt_nascimento_w	d301_segmento_nad.ds_dt_nascimento%type;
ds_nome_w		d301_segmento_nad.ds_nome%type;
ds_prefixo_sobrenome_w	d301_segmento_nad.ds_prefixo_sobrenome%type;
ds_rua_numero_w		d301_segmento_nad.ds_rua_numero%type;
ds_sufixo_nome_w	d301_segmento_nad.ds_sufixo_nome%type;
ds_titulacao_w		d301_segmento_nad.ds_titulacao%type;
nm_sobrenome_w		d301_segmento_nad.nm_sobrenome%type;
nr_seq_301_pais_w	d301_segmento_nad.nr_seq_301_pais%type;
nr_seq_301_sexo_w	d301_segmento_nad.nr_seq_301_sexo%type;
nr_seq_segmento_w	d301_segmento_nad.nr_sequencia%type;

nr_atendimento_w	atendimento_paciente.nr_atendimento%type;
ie_sexo_w		pessoa_fisica.ie_sexo%type;
cd_nacionalidade_w	pessoa_fisica.cd_nacionalidade%type;
cd_pessoa_fisica_w	pessoa_fisica.cd_pessoa_fisica%type;
nr_seq_person_name_w	pessoa_fisica.nr_seq_person_name%type;
nr_seq_pais_w		compl_pessoa_fisica.nr_seq_pais%type;


BEGIN

select	nr_atendimento
into STRICT	nr_atendimento_w
from	d301_dataset_envio
where	nr_sequencia = nr_seq_dataset_p;

select	max(b.cd_pessoa_fisica),
	max(d.nr_seq_person_name),
	max(d.ie_sexo),
	max(to_char(d.dt_nascimento,'YYYYMMDD')), --max(to_char(d.dt_nascimento,'yyyy/mm/dd')),
	substr(max(g.ds_forma_tratamento),1,20),
	--max(d.cd_nacionalidade),
	substr(max(h.ds_component_name_1),1,20),
	substr(max(h.ds_component_name_3),1,20)
into STRICT	cd_pessoa_fisica_w,
	nr_seq_person_name_w,
	ie_sexo_w,
	ds_dt_nascimento_w,
	ds_titulacao_w,
	--cd_nacionalidade_w,
	ds_sufixo_nome_w,
	ds_prefixo_sobrenome_w
FROM episodio_paciente e, atend_categoria_convenio a, atendimento_paciente b
LEFT OUTER JOIN diagnostico_doenca c ON (b.cd_medico_resp = c.cd_medico)
, pessoa_fisica d
LEFT OUTER JOIN pf_forma_tratamento g ON (d.nr_seq_forma_trat = g.nr_sequencia)
LEFT OUTER JOIN person_name h ON (d.nr_seq_person_name = h.nr_sequencia)
WHERE a.nr_atendimento 	= b.nr_atendimento  and b.cd_pessoa_fisica 	= d.cd_pessoa_fisica and d.cd_pessoa_fisica	= e.cd_pessoa_fisica   and a.nr_seq_interno 	= obter_atecaco_atendimento(nr_atendimento_w) and b.nr_atendimento	= nr_atendimento_w;

/*select	substr(max(obter_nome_pf_html5(cd_pessoa_fisica_w,nr_seq_person_name_w, 'givenName', 'main')),1,45),
	substr(max(obter_nome_pf_html5(cd_pessoa_fisica_w,nr_seq_person_name_w, 'familyName', 'main')),1,45)
into	ds_nome_w,
	nm_sobrenome_w
from	dual;*/
begin
select	substr(ds_family_name,1,45),
	substr(ds_given_name,1,45)
into STRICT	nm_sobrenome_w,
	ds_nome_w
from	person_name
where	nr_sequencia = nr_seq_person_name_w  LIMIT 1;
exception
when others then
	nm_sobrenome_w 	:= null;
	ds_nome_w	:= null;
end;

select	substr(max(f.nr_endereco),1,56),
	substr(max(ds_complemento),1,40),
	substr(max(ds_municipio),1,40),
	substr(max(f.cd_cep),1,10),
	max(f.nr_seq_pais)
into STRICT	ds_rua_numero_w,
	ds_compl_endereco_w,
	ds_cidade_w,
	cd_postal_w,
	nr_seq_pais_w
from	atend_categoria_convenio a,
	atendimento_paciente b,
	pessoa_fisica d,
	compl_pessoa_fisica f
where	a.nr_atendimento 	= b.nr_atendimento
and	b.cd_pessoa_fisica 	= d.cd_pessoa_fisica
and	f.cd_pessoa_fisica	= d.cd_pessoa_fisica
and	f.ie_tipo_complemento	= 1
and	a.nr_seq_interno 	= obter_atecaco_atendimento(nr_atendimento_w)
and	b.nr_atendimento	=  nr_atendimento_w;


select	OBTER_SEQ_VALOR_301('C301_21_SEXO','IE_SEXO',obter_conversao_301('C301_21_SEXO',null,4,ie_sexo_w,'I')),
	OBTER_SEQ_VALOR_301('C301_7_PAIS','IE_PAIS',obter_conversao_301('C301_7_PAIS','PAIS',null,nr_seq_pais_w,'I'))
into STRICT	nr_seq_301_sexo_w,
	nr_seq_301_pais_w
;

select	nextval('d301_segmento_nad_seq')
into STRICT	nr_seq_segmento_w
;

insert into D301_SEGMENTO_NAD(	cd_postal,
				ds_cidade,
				ds_compl_endereco,
				ds_dt_nascimento,
				ds_nome,
				ds_prefixo_sobrenome,
				ds_rua_numero,
				ds_sufixo_nome,
				ds_titulacao,
				dt_atualizacao,
				nm_sobrenome,
				nm_usuario,
				nr_sequencia,
				nr_seq_dataset,
				nr_seq_301_pais,
				nr_seq_301_sexo)
			values (	cd_postal_w,
				ds_cidade_w,
				ds_compl_endereco_w,
				ds_dt_nascimento_w,
				ds_nome_w,
				ds_prefixo_sobrenome_w,
				ds_rua_numero_w,
				ds_sufixo_nome_w,
				ds_titulacao_w,
				clock_timestamp(),
				nm_sobrenome_w,
				nm_usuario_p,
				nr_seq_segmento_w,
				nr_seq_dataset_p,
				nr_seq_301_pais_w,
				nr_seq_301_sexo_w);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_d301_segmento_nad ( nr_seq_dataset_p bigint, nm_usuario_p text) FROM PUBLIC;

