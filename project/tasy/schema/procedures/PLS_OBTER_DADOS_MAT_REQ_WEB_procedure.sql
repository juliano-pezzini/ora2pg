-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_dados_mat_req_web ( ie_carrega_anexo_p text, nr_seq_prestador_p bigint, cd_estabelecimento_p bigint, nr_seq_material_p INOUT bigint, cd_material_p INOUT bigint, nr_seq_guia_p pls_guia_plano.nr_sequencia%type default null, nr_seq_requisicao_p pls_requisicao.nr_sequencia%type default null, ie_tipo_atendimento_p text default null, ie_anexo_p INOUT text DEFAULT NULL, ds_material_p INOUT text DEFAULT NULL, cd_anvisa_material_p INOUT text DEFAULT NULL, cd_fabricante_p INOUT material.cd_fabricante%type DEFAULT NULL) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Retornar os dados do material, quando o mesmo é consultado no portal
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  ]  Objetos do dicionário [  ] Tasy (Delphi/Java) [  x] Portal [  ]  Relatórios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atenção:
- Jamais alterar sem verificar as telas do portal
- Caso o parametro nr_seq_prestador_p esteja informado o sistema vai restringir os materiais liberados para o prestador
-------------------------------------------------------------------------------------------------------------------

Referências:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ds_material_w			pls_material.ds_material%type;		
cd_material_w			pls_material.cd_material_ops%type;	
nr_sequencia_w			pls_material.nr_sequencia%type;	
cd_anvisa_w			pls_material.nr_registro_anvisa%type;
ie_anexo_w			varchar(5);
qt_regra_w			bigint;
cd_fabricante_w			material.cd_fabricante%type;


BEGIN
if (nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') then
	begin
		select	a.ds_material,
			a.cd_material_ops,
			a.nr_sequencia,
			substr(pls_obter_cd_anvisa_material(a.nr_sequencia),1,15) cd_anvisa,
			(select	max(x.cd_fabricante) from material x where x.cd_material = a.cd_material) cd_fabricante
		into STRICT	ds_material_w,
			cd_material_w,
			nr_sequencia_w,
			cd_anvisa_w,
			cd_fabricante_w
		from	pls_material a
		where	a.nr_sequencia = nr_seq_material_p
		and (coalesce(a.dt_exclusao::text, '') = '' or a.dt_exclusao > clock_timestamp())
		and (coalesce(a.dt_inclusao::text, '') = '' or trunc(a.dt_inclusao) <= trunc(clock_timestamp()))
		and (a.cd_estabelecimento	= cd_estabelecimento_p or pls_obter_se_controle_estab('LM') = 'N')  LIMIT 1;
	exception
	when others then
		ds_material_w := null;
		cd_material_w := null;
		nr_sequencia_w := null;
	end;
elsif (cd_material_p IS NOT NULL AND cd_material_p::text <> '') then
	begin
		select	a.ds_material,
			a.cd_material_ops,
			a.nr_sequencia,
			substr(pls_obter_cd_anvisa_material(a.nr_sequencia),1,15) cd_anvisa,
			(select	max(x.cd_fabricante) from material x where x.cd_material = a.cd_material) cd_fabricante
		into STRICT	ds_material_w,
			cd_material_w,
			nr_sequencia_w,
			cd_anvisa_w,
			cd_fabricante_w
		from	pls_material a
		where	a.cd_material_ops_number = cd_material_p
		and (coalesce(a.dt_exclusao::text, '') = '' or a.dt_exclusao > clock_timestamp())
		and (coalesce(a.dt_inclusao::text, '') = '' or trunc(a.dt_inclusao) <= trunc(clock_timestamp()))
		and (a.cd_estabelecimento	= cd_estabelecimento_p or pls_obter_se_controle_estab('LM') = 'N')  LIMIT 1;
	exception
	when others then
		ds_material_w := null;
		cd_material_w := null;
		nr_sequencia_w := null;
	end;
end if;

if (nr_seq_prestador_p IS NOT NULL AND nr_seq_prestador_p::text <> '' AND nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '') then
	if ('N' = pls_obter_se_mat_prestador(nr_seq_prestador_p,null,nr_sequencia_w,clock_timestamp(),null,null,cd_estabelecimento_p,null)) then
		ds_material_w	:= null;
		cd_material_w 	:= null;
		nr_sequencia_w 	:= null;
		cd_anvisa_w	:= null;
		cd_fabricante_w := null;
	end if;
end if;

if (ie_carrega_anexo_p = 'S' and (nr_sequencia_w IS NOT NULL AND nr_sequencia_w::text <> '')) then
	ie_anexo_w := pls_obter_tipo_anexo_item(null, null, nr_sequencia_w, nr_seq_guia_p, nr_seq_requisicao_p, ie_tipo_atendimento_p);
end if;

select	count(1)
into STRICT	qt_regra_w
from 	pls_material_restricao x
where 	x.nr_seq_material	= nr_sequencia_w
and 	coalesce(x.ie_bloqueia_autor,'N') = 'S'
and	clock_timestamp()	between	dt_inicio_vigencia_ref and coalesce(dt_fim_vigencia_ref, clock_timestamp());

if (qt_regra_w	= 0) then
	nr_seq_material_p 	:= nr_sequencia_w;
	cd_material_p 		:= cd_material_w;
	ie_anexo_p 		:= ie_anexo_w;
	ds_material_p 		:= ds_material_w;
	cd_anvisa_material_p 	:= cd_anvisa_w;
	cd_fabricante_p		:= cd_fabricante_w;
else
	nr_seq_material_p 	:= null;
	cd_material_p 		:= null;
	ie_anexo_p 		:= null;
	ds_material_p 		:= null;
	cd_anvisa_material_p 	:= null;
	cd_fabricante_p		:= null;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_dados_mat_req_web ( ie_carrega_anexo_p text, nr_seq_prestador_p bigint, cd_estabelecimento_p bigint, nr_seq_material_p INOUT bigint, cd_material_p INOUT bigint, nr_seq_guia_p pls_guia_plano.nr_sequencia%type default null, nr_seq_requisicao_p pls_requisicao.nr_sequencia%type default null, ie_tipo_atendimento_p text default null, ie_anexo_p INOUT text DEFAULT NULL, ds_material_p INOUT text DEFAULT NULL, cd_anvisa_material_p INOUT text DEFAULT NULL, cd_fabricante_p INOUT material.cd_fabricante%type DEFAULT NULL) FROM PUBLIC;

