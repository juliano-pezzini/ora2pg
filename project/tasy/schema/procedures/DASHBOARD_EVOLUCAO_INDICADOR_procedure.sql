-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dashboard_evolucao_indicador (cd_estabelecimento_p bigint, ie_periodo_p text, nr_seq_indicador_p bigint, dt_referencia_p timestamp, nr_seq_dimensao_p bigint, nr_seq_informacao_p bigint, nr_seq_data_p bigint, nm_usuario_p text, ds_sql_filtro_p text, ds_sql_drill_p text, ie_tipo_data_p text, ie_etapa_p bigint, ie_restringe_estab_p text DEFAULT 'S') AS $body$
DECLARE

			
nm_tabela_indicador_w	varchar(50);
ds_sql_where_ind_w	varchar(2000);
ds_sql_mascara_w		varchar(50);
nm_tabela_referencia_w	varchar(50);
nm_atrib_dimensao_w	varchar(85);
nm_atributo_referencia_w	varchar(50);
nm_atributo_drill_w		varchar(50);
ds_sql_where_w		varchar(4000);
ds_sql_data_w		varchar(700);
nm_atrib_data_w		varchar(85);
ds_select_data_w		varchar(200);
ds_comando_w		varchar(4000);
nm_atrib_inf_w		varchar(255);
ie_alias_w		varchar(2);/* Elemar - 29/04/04 */
ds_mascara_grid_w		varchar(30);
nr_seq_wheb_w		bigint;
sql_nulo_w		varchar(100);
IE_MOSTRA_NULO_w	varchar(01);
ds_sql_where_ww		varchar(255);
ds_sql_where_inf_w	varchar(255);
cd_empresa_w		smallint;
ie_formato_tot_linha_w	varchar(1);
nm_atributo_divisor_w	varchar(50);
nm_atributo_dividendo_w	varchar(50);
ds_media_divisao_w	varchar(255);
nm_tablespace_w		varchar(50);
ds_sql_filtro_W		varchar(4000);
ds_comando_orig_w	varchar(2000);
ds_comando_from_w	varchar(2000);
ds_filtro_padrao_w		indicador_gestao_atrib.ds_filtro_padrao%TYPE;
i			bigint;
ds_comando_aux_w	text;
ds_novo_sql_where_w	varchar(255);


BEGIN

	ds_sql_filtro_W			:= REPLACE(ds_sql_filtro_p, 'cd_unidade', 'UPPER(CD_UNIDADE)');
	ds_sql_data_w			:= '';
	ds_sql_mascara_w		:= '';
	cd_empresa_w			:= obter_empresa_estab(cd_estabelecimento_p);

	SELECT	' TABLESPACE '||obter_tablespace_tab_temp
	INTO STRICT	nm_tablespace_w
	;
	
	SELECT	coalesce(a.nr_seq_ind_gestao,0)
	INTO STRICT	nr_seq_wheb_w
	FROM 	ind_base a
	WHERE 	a.nr_sequencia 		= nr_seq_indicador_p;

	SELECT a.ds_origem_inf,
		   a.ds_sql_where		
	INTO STRICT   nm_tabela_indicador_w,
		   ds_sql_where_ind_w
	FROM   ind_base a
	WHERE  a.nr_sequencia 	  = nr_seq_indicador_p;

	SELECT a.nm_atributo_drill,
		   a.nm_tabela_referencia,
		   a.nm_atributo_referencia,
		   a.ds_atributo,
		   a.ie_mostra_nulo,
		   a.ds_sql_where
	INTO STRICT   nm_atributo_drill_w,
		   nm_tabela_referencia_w,
		   nm_atributo_referencia_w,
		   nm_atrib_dimensao_w,
		   ie_mostra_nulo_w,
		   ds_sql_where_ww
	FROM   ind_dimensao a
	WHERE  a.nr_sequencia 	  = nr_seq_dimensao_p
	AND    a.nr_seq_indicador 	  = nr_seq_indicador_p;

	SELECT ds_atributo
	INTO STRICT   nm_atrib_data_w
	FROM   ind_data
	WHERE  nr_sequencia       = nr_seq_data_p;

	SELECT	ds_atributo,
			ds_mascara_grid,
			ds_sql_where,
			ie_formato_tot_linha,
			ie_divisor,
			ie_dividendo,
			ds_filtro_padrao
	INTO STRICT	nm_atrib_inf_w,
			ds_mascara_grid_w,
			ds_sql_where_inf_w,
			ie_formato_tot_linha_w,
			nm_atributo_divisor_w,
			nm_atributo_dividendo_w,
			ds_filtro_padrao_w
	FROM   ind_informacao
	WHERE  nr_sequencia 	  = nr_seq_informacao_p;

	CALL exec_sql_dinamico('TASY', ' drop table w_eis_evol_' || REPLACE(REPLACE(Elimina_Caracteres_Especiais(nm_usuario_p),' ',''),'.',''));
	
	IF (nr_seq_wheb_w IN (1851, 1863, 1868, 1880, 1894, 1898, 1912, 1916, 1917, 1921, 1923, 1924, 1927, 1932, /*3090,*/
 3100)) THEN
		   ds_sql_filtro_W := REPLACE(UPPER(ds_sql_filtro_W), 'AND DS_FORM', 'AND UPPER(DS_FORM)');
		   ds_sql_filtro_W := REPLACE(UPPER(ds_sql_filtro_W), 'AND NM_PROFESSIONAL', 'AND UPPER(NM_PROFESSIONAL)');
		   ds_sql_filtro_W := REPLACE(UPPER(ds_sql_filtro_W), 'AND NM_GROUP', 'AND UPPER(NM_GROUP)');
		   ds_sql_filtro_W := REPLACE(UPPER(ds_sql_filtro_W), 'AND NM_AGE_RANGE', 'AND UPPER(NM_AGE_RANGE)');
		   ds_sql_filtro_W := REPLACE(UPPER(ds_sql_filtro_W), 'AND NM_EPISODE_PLACE', 'AND UPPER(NM_EPISODE_PLACE)');
		   ds_sql_filtro_W := REPLACE(UPPER(ds_sql_filtro_W), 'AND DS_REASON_CANCEL', 'AND UPPER(DS_REASON_CANCEL)');
		   ds_sql_filtro_W := REPLACE(UPPER(ds_sql_filtro_W), 'AND NM_RESPONSABILITY', 'AND UPPER(NM_RESPONSABILITY)');
	ELSIF (nr_seq_wheb_w = 91) THEN
		   ds_sql_filtro_W := REPLACE(UPPER(ds_sql_filtro_W), 'DS_MOTIVO_ALTA', 'UPPER(DS_MOTIVO_ALTA)');
	END IF;

	IF (position(':DT_FIM' in UPPER(nm_atrib_inf_w)) > 0) THEN   /*Anderson 01/08/2007 - OS63683*/
		SELECT	REPLACE(UPPER(nm_atrib_inf_w),':DT_FIM','last_day(add_months(trunc(' || ' to_date( ' || CHR(39) || TO_CHAR(dt_referencia_p,'dd/mm/yyyy') ||
				CHR(39) || ',' || CHR(39) || 'dd/mm/yyyy' || CHR(39) || '),' || CHR(39) || 'YEAR' || CHR(39) || '),11))')
		INTO STRICT	nm_atrib_inf_w
		FROM	ind_informacao
		WHERE	nr_sequencia		= nr_seq_informacao_p;

		SELECT	REPLACE(UPPER(nm_atrib_inf_w),':CD_ESTABELECIMENTO',cd_estabelecimento_p)
		INTO STRICT	nm_atrib_inf_w
		FROM	ind_informacao
		WHERE	nr_sequencia		= nr_seq_informacao_p;

		SELECT	REPLACE(UPPER(nm_atrib_inf_w),':DT_INICIO','to_date( ' || CHR(39) || TO_CHAR(dt_referencia_p,'dd/mm/yyyy') || CHR(39) || ','
							|| CHR(39) || 'dd/mm/yyyy' || CHR(39) || ')')
		INTO STRICT	nm_atrib_inf_w
		FROM	ind_informacao
		WHERE	nr_sequencia		= nr_seq_informacao_p;
	END IF;

	ds_sql_where_w	:= ' from ';

	IF ( nr_seq_wheb_w = 71 ) THEN
		nm_atrib_inf_w	    := REPLACE(UPPER(nm_atrib_inf_w), ':CD_DIMENSAO', nm_atributo_drill_w);
	END IF;		

	IF (ds_mascara_grid_w IS NOT NULL AND ds_mascara_grid_w::text <> '') THEN
		ds_sql_mascara_w	:= ', ' || CHR(39) || ds_mascara_grid_w || CHR(39) || ' ds_mascara ';
	ELSE
		ds_sql_mascara_w	:= ', ' || CHR(39) || ' ' || CHR(39) || ' ds_mascara ';
	END IF;

	ie_alias_w				:= '';
	IF (nm_tabela_referencia_w IS NOT NULL AND nm_tabela_referencia_w::text <> '') THEN
		ds_sql_where_w		:= ds_sql_where_w || nm_tabela_referencia_w || ' b, ';
		ie_alias_w			:= 'b.';
	END IF;

	ds_sql_where_w			:= ds_sql_where_w || nm_tabela_indicador_w || ' a ' ||' where 1 = 1 ';

	IF (nm_tabela_referencia_w IS NOT NULL AND nm_tabela_referencia_w::text <> '')   AND (nm_atributo_referencia_w IS NOT NULL AND nm_atributo_referencia_w::text <> '') THEN
		ds_sql_where_w		:= ds_sql_where_w || ' and b.' || nm_atributo_referencia_w || '(+) = a.' || nm_atributo_drill_w;
	END IF;

	IF (ie_restringe_estab_p = 'S') THEN
		ds_sql_where_w		:= ds_sql_where_w || ' ' || REPLACE(UPPER(ds_sql_where_ind_w), ':CD_ESTABELECIMENTO', cd_estabelecimento_p) ||
				ds_sql_filtro_W || ' ' || ds_sql_drill_p;			
	ELSE
		ds_sql_where_w		:= ds_sql_where_w || ' ' || REPLACE(UPPER(ds_sql_where_ind_w), ':CD_ESTABELECIMENTO', 'A.CD_ESTABELECIMENTO') ||
				ds_sql_filtro_W || ' ' || ds_sql_drill_p;
	END IF;

	ds_sql_where_w			:= REPLACE(UPPER(ds_sql_where_w), ':CD_EMPRESA', cd_empresa_w);

	IF (ds_sql_where_ww IS NOT NULL AND ds_sql_where_ww::text <> '') THEN
		ds_sql_where_w		:=	ds_sql_where_w || ' ' || ds_sql_where_ww;
	END IF;

	IF (ds_sql_where_inf_w IS NOT NULL AND ds_sql_where_inf_w::text <> '') THEN
		ds_sql_where_w		:=	ds_sql_where_w || ' ' || ds_sql_where_inf_w;
	END IF;

	IF (ie_etapa_p = 1) THEN
		ds_sql_where_w		:=	ds_sql_where_w || ' ' || ' and ie_etapa = ' || CHR(39) || 'C' || CHR(39);
	ELSIF (ie_etapa_p = 2) THEN
		ds_sql_where_w		:=	ds_sql_where_w || ' ' || ' and ie_etapa = ' || CHR(39) || 'T' || CHR(39);
	ELSIF (ie_etapa_p = 3) THEN
		ds_sql_where_w		:=	ds_sql_where_w || ' ' || ' and ie_etapa = ' || CHR(39) || 'P' || CHR(39);
	END IF;

	IF (nr_seq_wheb_w	= 71) AND (nm_atrib_inf_w = 'NR_PAC_DIA') THEN
	    ds_sql_data_w		:= ' and a.ie_periodo = ' || CHR(39) || 'D' || CHR(39);		
	END IF;

	IF (nr_seq_wheb_w	NOT IN (81,181)) THEN
		BEGIN
			IF (ie_periodo_p	= 'M') THEN
				ds_sql_data_w	:= ds_sql_data_w || ' and a.' || nm_atrib_data_w || ' between to_date( ' || CHR(39) || TO_CHAR(dt_referencia_p,'dd/mm/yyyy') ||
							CHR(39) || ',' || CHR(39) || 'dd/mm/yyyy' || CHR(39) || ') and last_day(add_months(trunc(' ||
							' to_date( ' || CHR(39) || TO_CHAR(dt_referencia_p,'dd/mm/yyyy') || CHR(39) || ','
							|| CHR(39) || 'dd/mm/yyyy' || CHR(39) || '),' || CHR(39) || 'YEAR' || CHR(39) || '),11))';
			ELSIF (nr_seq_wheb_w = 499) THEN
				ds_sql_data_w	:= ds_sql_data_w || ' and a.' || nm_atrib_data_w || ' between to_date( ' || CHR(39) || TO_CHAR(dt_referencia_p,'dd/mm/yyyy')
					|| 		CHR(39) || ',' || CHR(39) || 'dd/mm/yyyy' || CHR(39) || ') and last_day( ' || ' to_date( ' || 
							CHR(39) || TO_CHAR(dt_referencia_p,'dd/mm/yyyy') || CHR(39) || ',' || CHR(39) || 'dd/mm/yyyy' || CHR(39) || '))+86399/86400';
			ELSE
				
				ds_sql_data_w	:= ds_sql_data_w || ' and trunc(a.' || nm_atrib_data_w || ',' || CHR(39) ||'dd' || CHR(39) || ') between to_date( ' || CHR(39) || TO_CHAR(dt_referencia_p,'dd/mm/yyyy')
						|| CHR(39) || ',' || CHR(39) || 'dd/mm/yyyy' || CHR(39) || ') and last_day( ' || ' to_date( ' || 
							CHR(39) || TO_CHAR(dt_referencia_p,'dd/mm/yyyy') || CHR(39) || ',' || CHR(39) || 'dd/mm/yyyy' || CHR(39) || '))';
			END IF;
		END;
	END IF;

	IF (position('COUNT(' in UPPER(nm_atrib_inf_w)) = 0) AND (position('SUM(' in UPPER(nm_atrib_inf_w)) = 0) AND (position('AVG(' in UPPER(nm_atrib_inf_w)) = 0) AND (position('MAX(' in UPPER(nm_atrib_inf_w)) = 0) AND (position('MIN(' in UPPER(nm_atrib_inf_w)) = 0) AND (position('MEDIAN(' in UPPER(nm_atrib_inf_w)) = 0) THEN
		nm_atrib_inf_w		:= 'sum(' || nm_atrib_inf_w || ')';
	END IF;

	IF (ie_periodo_p = 'M') THEN
		ds_select_data_w 	:= ' trunc(a.' || nm_atrib_data_w || ',' || CHR(39) || 'MM' || CHR(39) || ') ';
	ELSIF (ie_tipo_data_p	= '1') AND (nr_seq_wheb_w  = 181)THEN
		ds_select_data_w	:= ' trunc(a.dt_receita   ,' || CHR(39) || 'MM' || CHR(39) || ') ';
	ELSE
		ds_select_data_w 	:= ' trunc(a.' || nm_atrib_data_w || ',' || CHR(39) || 'DD' || CHR(39) || ') ';
	END IF;


/*if	(ie_tipo_data_p	= 1) and
	(nr_seq_wheb_w  = 181)then
	ds_select_data_w	 := ' trunc(a.dt_receita   ,' || chr(39) || 'MM' || chr(39) || ') '; 
else
	ds_select_data_w := ' trunc(a.' || nm_atrib_data_w || ',' || chr(39) || 'DD' || chr(39) || ') '; 
end if;*/
	


	IF (IE_MOSTRA_NULO_w = 'N') THEN
		sql_nulo_w			:= ' and ' || nm_atrib_dimensao_w || ' is not null ';
	END IF;

	ds_media_divisao_w	:= '';
	IF (ie_formato_tot_linha_w = 'D') AND (nm_atributo_dividendo_w IS NOT NULL AND nm_atributo_dividendo_w::text <> '') AND (nm_atributo_divisor_w IS NOT NULL AND nm_atributo_divisor_w::text <> '') THEN
		ds_media_divisao_w	:= nm_atributo_dividendo_w || ' qt_dividendo, ' || nm_atributo_divisor_w || ' qt_divisor, ';
	END IF;

	ds_comando_w			:= ' select nvl(substr(' || ie_alias_w || nm_atrib_dimensao_w || ',1,255), ' || CHR(39) || WHEB_MENSAGEM_PCK.get_texto(304108)  || CHR(39) || ') ds_dimensao,
		substr(a.' || nm_atributo_drill_w || ',1,255) cd_dimensao, ' || nm_atrib_inf_w || ' vl_data, ' ||
		ds_media_divisao_w || ds_select_data_w || 'dt_data ' || ds_sql_mascara_w || ds_sql_where_w || ds_sql_data_w || sql_nulo_w;

		
	IF NOT(nr_seq_wheb_w IN (1880,1898) AND (position('STATS_MODE' in UPPER(nm_atrib_inf_w)) != 0 OR position('AVG' in UPPER(nm_atrib_inf_w)) != 0)) THEN
		ds_comando_w 		:= ds_comando_w || ' group by substr(' || ie_alias_w || nm_atrib_dimensao_w || ',1,255), substr(a.' || nm_atributo_drill_w || ',1,255), ' || ds_select_data_w;
	END IF;
	
	/* Francisco - 943635 - Indicador de sinais vitais precisa de subselect */

	IF (nr_seq_wheb_w = 1837/*2030*/
) AND (ds_filtro_padrao_w IS NOT NULL AND ds_filtro_padrao_w::text <> '') THEN
		ds_comando_orig_w	:=	' select nvl(substr(' || ie_alias_w || nm_atrib_dimensao_w || ',1,255), ' || CHR(39) || WHEB_MENSAGEM_PCK.get_texto(304108)  || CHR(39) || ') ds_dimensao,
			substr(a.' || nm_atributo_drill_w || ',1,255) cd_dimensao, ' || ds_filtro_padrao_w || ', ' ||
			ds_media_divisao_w ||		
			ds_select_data_w || 'dt_data ' || ds_sql_mascara_w || ds_sql_where_w || ds_sql_data_w || sql_nulo_w;
			
		ds_comando_from_w	:= ' select ds_dimensao, cd_dimensao, ' || nm_atrib_inf_w || ' vl_data, ' ||
				ds_media_divisao_w || ' dt_data ' || ds_sql_mascara_w;
				
		ds_comando_w		:= ds_comando_from_w || ' from (' || ds_comando_orig_w || ') a group by ds_dimensao, cd_dimensao, dt_data';
	END IF;

	ds_comando_w			:= REPLACE(UPPER(ds_comando_w), ':NR_DIAS_CENSO', '30');
	ds_comando_w			:= REPLACE(UPPER(ds_comando_w), ':CD_ESTAB_EVENTO', cd_estabelecimento_p);
	ds_comando_w			:= REPLACE(UPPER(ds_comando_w), ':IE_RESTRINGE_ESTAB', CHR(39) || ie_restringe_estab_p || CHR(39));

	IF (nr_seq_wheb_w IN (1851, 1863, 1868)) THEN
		ds_comando_w		:= REPLACE(UPPER(ds_comando_w), 'A.'||UPPER(nm_atrib_data_w), ' to_date( ' || CHR(39) || TO_CHAR(dt_referencia_p,'dd/mm/yyyy') || CHR(39) || ',' || CHR(39) || 'dd/mm/yyyy' || CHR(39) || ')');
		
		SELECT	REPLACE(UPPER(ds_comando_w),
				'TO_DATE(:DT_FIM, ' || CHR(39) || 'DD/MM/YYYY HH24:MI:SS' || CHR(39) || ')',
				'FIM_DIA(LAST_DAY(TO_DATE(' || CHR(39) || TO_CHAR(dt_referencia_p,'dd/mm/yyyy') || CHR(39) || ', ' || CHR(39) || 'DD/MM/YYYY HH24:MI:SS'|| CHR(39) ||')))' )
		INTO STRICT	ds_comando_w
		;

		SELECT	REPLACE(UPPER(ds_comando_w),
				':DT_FIM',
				'FIM_DIA(LAST_DAY(TO_DATE(' || CHR(39) || TO_CHAR(dt_referencia_p,'dd/mm/yyyy') || CHR(39) || ', ' || CHR(39) || 'DD/MM/YYYY HH24:MI:SS'|| CHR(39) ||')))' )
		INTO STRICT	ds_comando_w
		;
		
		SELECT	REPLACE(UPPER(ds_comando_w),
				':DT_INICIO',
				'TO_DATE(' || CHR(39) || TO_CHAR(dt_referencia_p,'dd/mm/yyyy') || CHR(39) || ', ' || CHR(39) || 'DD/MM/YYYY HH24:MI:SS'|| CHR(39) ||')' )
		INTO STRICT	ds_comando_w
		;
		
		ds_comando_aux_w		:= ds_comando_w;
		FOR i IN 1..11 LOOP
			ds_comando_aux_w	:= ds_comando_aux_w || ' UNION ' || REPLACE(ds_comando_w, '01/01/', '01/'|| trim(both TO_CHAR(i+1,'00')) ||'/');
		END LOOP;
		CALL exec_sql_dinamico('TASY', ' create table w_eis_evol_' || REPLACE(REPLACE(Elimina_Caracteres_Especiais(nm_usuario_p),' ',''),'.','') || nm_tablespace_w || ' as ' || ds_comando_aux_w);
	ELSIF (nr_seq_wheb_w IN (1880,1898)  AND
		position('STATS_MODE' in UPPER(nm_atrib_inf_w)) != 0) THEN

		ds_comando_aux_w 		:= '	SELECT	A.DS_DIMENSAO DS_DIMENSAO,
									A.CD_DIMENSAO CD_DIMENSAO,
									STATS_MODE(A.VL_DATA) VL_DATA,
									A.DT_DATA
									' || ds_sql_mascara_w || ' 
									FROM	(' || ds_comando_w || ' ) A 
									GROUP BY A.DS_DIMENSAO, A.CD_DIMENSAO, A.DT_DATA ';
		CALL exec_sql_dinamico('TASY', ' create table w_eis_evol_' || REPLACE(REPLACE(Elimina_Caracteres_Especiais(nm_usuario_p),' ',''),'.','') || nm_tablespace_w || ' as ' || ds_comando_aux_w);
		
	ELSIF (nr_seq_wheb_w IN (1880,1898)  		  AND
		position('AVG' in UPPER(nm_atrib_inf_w)) != 0) THEN

		ds_comando_aux_w 		:= '	SELECT	A.DS_DIMENSAO DS_DIMENSAO,
									A.CD_DIMENSAO CD_DIMENSAO,
									AVG(A.VL_DATA) VL_DATA,
									A.DT_DATA
									' || ds_sql_mascara_w || ' 
									FROM	(' || ds_comando_w || ' ) A 
									GROUP BY A.DS_DIMENSAO, A.CD_DIMENSAO, A.DT_DATA ';
		CALL exec_sql_dinamico('TASY', ' create table w_eis_evol_' || REPLACE(REPLACE(Elimina_Caracteres_Especiais(nm_usuario_p),' ',''),'.','') || nm_tablespace_w || ' as ' || ds_comando_aux_w);

	ELSIF (nr_seq_wheb_w IN (1894,1898)  	  						AND
			nm_atrib_dimensao_w = 'DS_UNIQUE' 						AND
			position('TARGET_POPULATION' in UPPER(nm_atrib_inf_w)) != 0) THEN
				ds_comando_w 		:= REPLACE(UPPER(ds_comando_w), ' WHERE 1 = 1 ', ' WHERE 1 = 1 AND SI_TARGET_POPULATION = ''S'' ');
				CALL exec_sql_dinamico('TASY', ' create table w_eis_evol_' || REPLACE(REPLACE(Elimina_Caracteres_Especiais(nm_usuario_p),' ',''),'.','') || nm_tablespace_w || ' as ' || ds_comando_w);
	ELSIF (nr_seq_wheb_w IN (1924) AND position('PERCENT' in UPPER(nm_atrib_inf_w)) != 0)THEN
			ds_comando_aux_w := '	SELECT	A.DS_DIMENSAO DS_DIMENSAO,
								A.CD_DIMENSAO CD_DIMENSAO,
								B.VL_DATA / A.VL_DATA * 100 VL_DATA,
								A.DT_DATA
								' || ds_sql_mascara_w || ' 
								FROM	(' || ds_comando_w || ') A,
								(' || REPLACE(ds_comando_w, CHR(39)||'P'||CHR(39) , CHR(39)||'R'||CHR(39)) || ') B
								WHERE	A.DS_DIMENSAO = B.DS_DIMENSAO
								AND	A.DT_DATA = B.DT_DATA ';

			CALL exec_sql_dinamico('TASY', ' create table w_eis_evol_' || REPLACE(REPLACE(Elimina_Caracteres_Especiais(nm_usuario_p),' ',''),'.','') || nm_tablespace_w || ' as ' || ds_comando_aux_w);
	ELSIF (nr_seq_wheb_w IN (1917) AND position('PERCENT' in UPPER(nm_atrib_inf_w)) != 0)THEN
		IF (position('CANCELED' in UPPER(nm_atrib_inf_w)) != 0) THEN
				ds_comando_aux_w := '	SELECT	A.DS_DIMENSAO DS_DIMENSAO,
									A.CD_DIMENSAO CD_DIMENSAO,
									B.VL_DATA / A.VL_DATA * 100 VL_DATA,
									A.DT_DATA
									' || ds_sql_mascara_w || ' 
									FROM	(' || ds_comando_w || ') A,
									(' || REPLACE(ds_comando_w, 'WHERE 1 = 1' , ' WHERE 1 = 1 AND SI_CANCELLED = '|| CHR(39)||'S'||CHR(39)) || ') B
									WHERE	A.DS_DIMENSAO = B.DS_DIMENSAO
									AND	A.DT_DATA = B.DT_DATA ';
		ELSIF (position('MISSED' in UPPER(nm_atrib_inf_w)) != 0) THEN
					ds_comando_aux_w := '	SELECT	A.DS_DIMENSAO DS_DIMENSAO,
										A.CD_DIMENSAO CD_DIMENSAO,
										B.VL_DATA / A.VL_DATA * 100 VL_DATA,
										A.DT_DATA
										' || ds_sql_mascara_w || ' 
										FROM	(' || ds_comando_w || ') A,
										(' || REPLACE(ds_comando_w, 'COUNT(DISTINCT NR_SEQ_FACT)' , ' SUM(QT_ABS_BY_FACT) ') || ') B
										WHERE	A.DS_DIMENSAO = B.DS_DIMENSAO
										AND	A.DT_DATA = B.DT_DATA ';
		END IF;
		CALL exec_sql_dinamico('TASY', ' create table w_eis_evol_' || REPLACE(REPLACE(Elimina_Caracteres_Especiais(nm_usuario_p),' ',''),'.','') || nm_tablespace_w || ' as ' || ds_comando_aux_w);	
	ELSIF (nr_seq_wheb_w IN (1927)  AND position('PERCENT' in UPPER(nm_atrib_inf_w)) != 0) THEN
		IF (position('MISSED' in UPPER(nm_atrib_inf_w)) != 0) THEN
			ds_novo_sql_where_w 	:= ' WHERE 1 = 1 AND SI_PRESENT = '|| CHR(39)||'N'||CHR(39);
		ELSIF (position('PRESENT' in UPPER(nm_atrib_inf_w)) != 0) THEN
			ds_novo_sql_where_w 	:= ' WHERE 1 = 1 AND SI_PRESENT = '|| CHR(39)||'S'||CHR(39);
		ELSIF (position('FIRST' in UPPER(nm_atrib_inf_w)) != 0) THEN
			ds_novo_sql_where_w 	:= ' WHERE 1 = 1 AND SI_FIRST_ENCOUNTER = '|| CHR(39)||'S'||CHR(39);
		ELSIF (position('LAST' in UPPER(nm_atrib_inf_w)) != 0) THEN
			ds_novo_sql_where_w 	:= ' WHERE 1 = 1 AND SI_LAST_ENCOUNTER = '|| CHR(39)||'S'||CHR(39);
		ELSIF (position('GIVE_UP' in UPPER(nm_atrib_inf_w)) != 0) THEN
			ds_novo_sql_where_w 	:= ' WHERE 1 = 1 AND PR_CONCLUSION < 25 ';
		ELSIF (position('BENEF' in UPPER(nm_atrib_inf_w)) != 0) THEN
			ds_novo_sql_where_w 	:= ' WHERE 1 = 1 AND EXISTS (SELECT 1 FROM PLS_SEGURADO WHERE CD_PESSOA_FISICA = NR_DIF_PERSON) ';
		END IF;
		ds_comando_aux_w := '	SELECT	A.DS_DIMENSAO DS_DIMENSAO,
							A.CD_DIMENSAO CD_DIMENSAO,
							B.VL_DATA / A.VL_DATA * 100 VL_DATA,
							A.DT_DATA
							' || ds_sql_mascara_w || ' 
							FROM	(' || ds_comando_w || ') A,
							(' || REPLACE(ds_comando_w, 'WHERE 1 = 1' , ds_novo_sql_where_w) || ') B
							WHERE	A.DS_DIMENSAO = B.DS_DIMENSAO
							AND	A.DT_DATA = B.DT_DATA ';
		CALL exec_sql_dinamico('TASY', ' create table w_eis_evol_' || REPLACE(REPLACE(Elimina_Caracteres_Especiais(nm_usuario_p),' ',''),'.','') || nm_tablespace_w || ' as ' || ds_comando_aux_w);	
	ELSE		
		CALL exec_sql_dinamico('TASY', ' create table w_eis_evol_' || REPLACE(REPLACE(Elimina_Caracteres_Especiais(nm_usuario_p),' ',''),'.','') || nm_tablespace_w || ' as ' || ds_comando_w);
	END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dashboard_evolucao_indicador (cd_estabelecimento_p bigint, ie_periodo_p text, nr_seq_indicador_p bigint, dt_referencia_p timestamp, nr_seq_dimensao_p bigint, nr_seq_informacao_p bigint, nr_seq_data_p bigint, nm_usuario_p text, ds_sql_filtro_p text, ds_sql_drill_p text, ie_tipo_data_p text, ie_etapa_p bigint, ie_restringe_estab_p text DEFAULT 'S') FROM PUBLIC;

