-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_ajustar_material_prescr () AS $body$
DECLARE



nr_sequencia_w			bigint;
cd_material_w			bigint;
cd_setor_atendimento_w		integer;
ie_via_aplicacao_w		varchar(5);
cd_intervalo_w			varchar(7);
cd_unidade_medida_w		varchar(30);
qt_dose_w			double precision;
cd_unid_med_limite_w		varchar(30);
qt_limite_pessoa_w		double precision;
ie_dose_limite_w		varchar(15);
qt_intervalo_horas_w		smallint;
qt_intervalo_max_horas_w	smallint;
qt_dias_maximo_w		smallint;

ie_tipo_padrao_w		varchar(1);
ie_tipo_limite_w		varchar(1);

c01 CURSOR FOR
	SELECT	nr_sequencia,
		cd_material,
		cd_setor_atendimento,
		ie_via_aplicacao,
		cd_intervalo,
		cd_unidade_medida,
		qt_dose,
		cd_unid_med_limite,
		qt_limite_pessoa,
		ie_dose_limite,
		qt_intervalo_horas,
		qt_intervalo_max_horas,
		qt_dias_maximo
	from	material_prescr
	where	coalesce(ie_tipo::text, '') = ''
	order by cd_material, cd_setor_atendimento;



BEGIN

open c01;
	loop
	fetch C01 into
		nr_sequencia_w,
		cd_material_w,
		cd_setor_atendimento_w,
		ie_via_aplicacao_w,
		cd_intervalo_w,
		cd_unidade_medida_w,
		qt_dose_w,
		cd_unid_med_limite_w,
		qt_limite_pessoa_w,
		ie_dose_limite_w,
		qt_intervalo_horas_w,
		qt_intervalo_max_horas_w,
		qt_dias_maximo_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */


		ie_tipo_padrao_w	:= 'N';
		ie_tipo_limite_w	:= 'N';


		/* Verificar se o registro possui regras que atendem ao tipo padr√£o */

		if	((cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') or (cd_unidade_medida_w IS NOT NULL AND cd_unidade_medida_w::text <> '') or (qt_dose_w IS NOT NULL AND qt_dose_w::text <> '')) then
			ie_tipo_padrao_w	:= 'S';
		end if;

		/* Verificar se o registro possui regras que atendem ao tipo limites */

		if	((cd_unid_med_limite_w IS NOT NULL AND cd_unid_med_limite_w::text <> '') or (qt_limite_pessoa_w IS NOT NULL AND qt_limite_pessoa_w::text <> '') or (ie_dose_limite_w IS NOT NULL AND ie_dose_limite_w::text <> '') or (qt_intervalo_horas_w IS NOT NULL AND qt_intervalo_horas_w::text <> '') or (qt_intervalo_max_horas_w IS NOT NULL AND qt_intervalo_max_horas_w::text <> '') or (qt_dias_maximo_w IS NOT NULL AND qt_dias_maximo_w::text <> '')) then
			ie_tipo_limite_w	:= 'S';
		end if;

		/* Verifica de acordo com o tipo se deve ser tipo 1, 2 ou se deve duplicar */

		if	(ie_tipo_padrao_w = 'S' AND ie_tipo_limite_w = 'N') then

			update	material_prescr
			set	ie_tipo		= '1'
			where	nr_sequencia	= nr_sequencia_w;

		elsif	(ie_tipo_padrao_w = 'N' AND ie_tipo_limite_w = 'S') then

			update	material_prescr
			set	ie_tipo		= '2'
			where	nr_sequencia	= nr_sequencia_w;

		elsif	(ie_tipo_padrao_w = 'N' AND ie_tipo_limite_w = 'N') then

			update	material_prescr
			set	ie_tipo		= '1'
			where	nr_sequencia	= nr_sequencia_w;

		elsif	(ie_tipo_padrao_w = 'S' AND ie_tipo_limite_w = 'S') then

			update	material_prescr
			set	ie_tipo		= '1'
			where	nr_sequencia	= nr_sequencia_w;

			insert into material_prescr(
				nr_sequencia,
				cd_estabelecimento,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				cd_material,
				cd_setor_atendimento,
				cd_intervalo,
				cd_unidade_medida,
				qt_dose,
				cd_unid_med_limite,
				qt_limite_pessoa,
				ie_dose_limite,
				ie_via_aplicacao,
				qt_intervalo_horas,
				qt_intervalo_max_horas,
				qt_dias_maximo,
				ie_tipo
			)
			SELECT	nextval('material_prescr_seq'),
				cd_estabelecimento,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				cd_material,
				cd_setor_atendimento,
				cd_intervalo,
				cd_unidade_medida,
				qt_dose,
				cd_unid_med_limite,
				qt_limite_pessoa,
				ie_dose_limite,
				ie_via_aplicacao,
				qt_intervalo_horas,
				qt_intervalo_max_horas,
				qt_dias_maximo,
				'2'
			from	material_prescr
			where	nr_sequencia		= nr_sequencia_w;

		end if;

	end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_ajustar_material_prescr () FROM PUBLIC;

