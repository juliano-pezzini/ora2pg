-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE avisar_liberacao_oc_reg_preco ( nr_ordem_compra_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_regra_w				bigint;
nr_seq_reg_lic_compra_w			bigint;
cd_reg_compra_w				varchar(100);
cd_setor_regra_usuario_w		integer;
ds_setor_adicional_w          varchar(2000) := '';
ds_perfil_adicional_w          varchar(4000) := '';
ds_titulo_w				varchar(80);
ds_comunicado_w				varchar(4000);
cd_perfil_w				integer;
cd_perfil_usuario_w			integer;
nr_seq_classif_w			bigint;
nr_seq_comunic_w			bigint;
pr_saldo_min_reg_preco_w		bigint;
nr_seq_reg_lic_item_w			bigint;
nr_seq_licitacao_w			bigint;
cd_material_w				bigint;
ds_material_w				varchar(255);
qt_material_w				double precision;
qt_saldo_w				double precision;
qt_item_w				double precision;
ds_lista_materiais_w			varchar(3000);
nm_usuario_destino_w			varchar(255);
ie_ci_lida_w				varchar(1);
qt_saldo_restante_w			double precision;
nm_usuarios_adic_w			varchar(255);

c01 CURSOR FOR 
SELECT	b.nr_sequencia, 
	b.nm_usuarios_adic 
from	regra_envio_comunic_compra a, 
	regra_envio_comunic_evento b 
where	a.nr_sequencia = b.nr_seq_regra 
and	b.cd_evento = 74 
and	b.ie_situacao = 'A' 
and	cd_estabelecimento = cd_estabelecimento_p;

c02 CURSOR FOR 
SELECT	cd_material, 
	substr(obter_desc_material(cd_material),1,255), 
	qt_material, 
	nr_seq_reg_lic_item 
from	ordem_compra_item 
where	nr_ordem_compra = nr_ordem_compra_p 
and	nr_seq_reg_lic_item > 0;

c03 CURSOR FOR 
SELECT	a.cd_setor_atendimento, 
	a.cd_perfil 
from	regra_envio_comunic_usu a 
where	a.nr_seq_evento = nr_seq_regra_w;


BEGIN 
 
select	coalesce(max(nr_seq_reg_lic_compra),0), 
	coalesce(max(nr_seq_licitacao),0) 
into STRICT	nr_seq_reg_lic_compra_w, 
	nr_seq_licitacao_w 
from	ordem_compra 
where	nr_ordem_compra = nr_ordem_compra_p;
 
select	coalesce(max(pr_saldo_min_reg_preco),0) 
into STRICT	pr_saldo_min_reg_preco_w 
from	parametro_compras 
where	cd_estabelecimento = cd_estabelecimento_p;
 
if (nr_seq_reg_lic_compra_w > 0) and (pr_saldo_min_reg_preco_w > 0) then 
 
	open C01;
	loop 
	fetch C01 into	 
		nr_seq_regra_w, 
		nm_usuarios_adic_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
		 
		open C02;
		loop 
		fetch C02 into	 
			cd_material_w, 
			ds_material_w, 
			qt_material_w, 
			nr_seq_reg_lic_item_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin 
			 
			select	max(substr(obter_dados_ordem_compra(obter_ordem_solic_compra(nr_solic_compra,nr_item_solic_compra),'CE'),1,100)) 
			into STRICT	cd_reg_compra_w 
			from	reg_lic_compra_item a 
			where	nr_seq_reg_lic_compra = nr_seq_reg_lic_compra_w 
			and	nr_seq_lic_item = nr_seq_reg_lic_item_w 
			and	nr_seq_licitacao = nr_seq_licitacao_w;
			 
			select	max(b.qt_item) 
			into STRICT	qt_item_w 
			from	reg_compra a, 
				reg_compra_item b 
			where	a.nr_sequencia = b.nr_seq_reg_compra 
			and	a.nr_seq_licitacao = nr_seq_licitacao_w 
			and	b.nr_seq_lic_item = nr_seq_reg_lic_item_w 
			and	b.cd_material = cd_material_w;
			 
			select	lic_obter_saldo_item_solic(nr_seq_licitacao_w, nr_seq_reg_lic_item_w) 
			into STRICT	qt_saldo_w 
			;
			 
			qt_saldo_restante_w	:= qt_saldo_w - qt_material_w;
			 
			if (dividir((qt_saldo_restante_w * 100), qt_item_w) < pr_saldo_min_reg_preco_w) then 
				 
				ds_lista_materiais_w := substr(WHEB_MENSAGEM_PCK.get_texto(297718,'DS_LISTA_MATERIAIS_W=' || ds_lista_materiais_w || ';' || 
												'DS_MATERIAL_W=' || ds_material_w || ';' || 
												'QT_MATERIAL_W=' || campo_mascara_virgula_casas(qt_material_w,4) || ';' || 
												'QT_SALDO_RESTANTE_W=' || campo_mascara_virgula_casas(qt_saldo_restante_w,4)),1,3000);	
			end if;
			end;
		end loop;
		close C02;
		 
		 
		 
		nm_usuario_destino_w := nm_usuarios_adic_w;		
		 
		if (ds_lista_materiais_w IS NOT NULL AND ds_lista_materiais_w::text <> '') then 
		 
			open C03;
			loop 
			fetch C03 into 
				cd_setor_regra_usuario_w, 
				cd_perfil_usuario_w;
			EXIT WHEN NOT FOUND; /* apply on C03 */
				begin 
				if (cd_setor_regra_usuario_w > 0) and (obter_se_contido_char(cd_setor_regra_usuario_w, ds_setor_adicional_w) = 'N') then 
					ds_setor_adicional_w := substr(ds_setor_adicional_w || cd_setor_regra_usuario_w || ',',1,2000);
				end if;
				 
				if (cd_perfil_usuario_w > 0) and (obter_se_contido_char(cd_perfil_usuario_w, ds_perfil_adicional_w) = 'N') then 
					ds_perfil_adicional_w := substr(ds_perfil_adicional_w || cd_perfil_usuario_w || ',',1,4000);
					 
				end if;
				end;
			end loop;
			close C03;			
			 
			select	max(substr(ds_titulo,1,80)), 
				max(cd_perfil), 
				coalesce(max(ie_ci_lida),'N'), 
				max(substr(ds_comunicacao,1,4000)) ds_comunicacao			 
			into STRICT	ds_titulo_w, 
				cd_perfil_w, 
				ie_ci_lida_w, 
				ds_comunicado_w			 
			from	regra_envio_comunic_evento 
			where	nr_sequencia = nr_seq_regra_w;
 
			ds_comunicado_w := substr(replace_macro(ds_comunicado_w, '@ordem', nr_ordem_compra_p),1,4000);
			ds_comunicado_w := substr(replace_macro(ds_comunicado_w, '@nr_licitacao', cd_reg_compra_w),1,4000);
			ds_comunicado_w := substr(replace_macro(ds_comunicado_w, '@nr_seq_licitacao', nr_seq_licitacao_w),1,4000);
			ds_comunicado_w := substr(replace_macro(ds_comunicado_w, '@nr_sequencia', nr_seq_reg_lic_compra_w),1,4000);
			ds_comunicado_w := substr(replace_macro(ds_comunicado_w, '@mat_qt_saldo', ds_lista_materiais_w),1,4000);
 
			select	obter_classif_comunic('F') 
			into STRICT	nr_seq_classif_w 
			;	
				 
			select	nextval('comunic_interna_seq') 
			into STRICT	nr_seq_comunic_w 
			;
				 
			if (cd_perfil_w IS NOT NULL AND cd_perfil_w::text <> '') then 
				ds_perfil_adicional_w := ds_perfil_adicional_w || cd_perfil_w ||',';
			end if;
			 
			 
			 
			insert into comunic_interna( 
				dt_comunicado, 
				ds_titulo, 
				ds_comunicado, 
				nm_usuario, 
				dt_atualizacao, 
				ie_geral, 
				nm_usuario_destino, 
				nr_sequencia, 
				ie_gerencial, 
				nr_seq_classif, 
				dt_liberacao, 
				ds_perfil_adicional, 
				ds_setor_adicional) 
			values (	clock_timestamp(), 
				ds_titulo_w, 
				ds_comunicado_w, 
				nm_usuario_p, 
				clock_timestamp(), 
				'N', 
				nm_usuario_destino_w, 
				nr_seq_comunic_w, 
				'N', 
				nr_seq_classif_w, 
				clock_timestamp(), 
				ds_perfil_adicional_w, 
				ds_setor_adicional_w);
 
			if (ie_ci_lida_w = 'S') then 
				insert into comunic_interna_lida(nr_sequencia,nm_usuario,dt_atualizacao)values (nr_seq_comunic_w,nm_usuario_p,clock_timestamp());
			end if;
		end if;
	 
		end;
	end loop;
	close C01;
end if;
 
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE avisar_liberacao_oc_reg_preco ( nr_ordem_compra_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

