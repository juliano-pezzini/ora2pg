-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE tiss_atualizar_despesas (nr_interno_conta_p text, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w			bigint;
ie_tiss_tipo_despesa_w		varchar(40);
ie_tiss_tipo_despesa_ant_w		varchar(40);
ie_classificacao_w			varchar(40);
ie_forma_apresentacao_w		varchar(40);
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
ie_tipo_material_w			varchar(40);
ie_tipo_classe_w			varchar(40);
ie_tipo_despesa_tiss_w		varchar(4);
ie_tipo_desp_regra_w		varchar(4);
ie_tipo_desp_proc_regra_w		varchar(50);
ie_tipo_material_conv_w		varchar(40);
cd_convenio_w			bigint;
cd_estabelecimento_w		bigint;
cd_material_w			bigint;
cd_classe_material_w		bigint;
cd_subgrupo_material_w		bigint;
cd_grupo_material_w		bigint;
cd_area_proc_w			bigint;
cd_grupo_proc_w			bigint;
cd_especialidade_proc_w		bigint;
ie_tipo_atendimento_w		bigint;
vl_material_unitario_w		double precision;
ds_versao_w			varchar(20);
nr_doc_convenio_w		procedimento_paciente.nr_doc_convenio%type;
cd_senha_item_w			procedimento_paciente.cd_senha%type;
ie_senha_taxa_guia_proc_w	tiss_parametros_convenio.ie_senha_taxa_guia_proc%type;

c01 CURSOR FOR
SELECT	a.nr_sequencia,
	a.cd_procedimento,
	a.ie_origem_proced,
	obter_dados_estrut_proc(a.cd_procedimento, a.ie_origem_proced, 'C', 'A') cd_area_proc,
	obter_dados_estrut_proc(a.cd_procedimento, a.ie_origem_proced, 'C', 'G') cd_grupo_proc,
	obter_dados_estrut_proc(a.cd_procedimento, a.ie_origem_proced, 'C', 'E') cd_especialidade_proc,
	b.cd_estabelecimento,
	b.cd_convenio_parametro,
	a.nr_doc_convenio,
	a.ie_tiss_tipo_despesa
from	conta_paciente b,
	procedimento_paciente a
where	a.nr_interno_conta	= b.nr_interno_conta
and (a.ie_tiss_tipo_guia	= '7' or (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'N' and (a.ie_tiss_tipo_despesa in ('7','8','9'))))
and	a.nr_interno_conta	= nr_interno_conta_p;

c02 CURSOR FOR
SELECT	a.nr_sequencia,
	b.ie_tipo_material,
	c.ie_tipo_classe,
	e.cd_convenio_parametro,
	e.cd_estabelecimento,
	b.cd_material,
	c.cd_classe_material,
	c.cd_subgrupo_material,
	g.cd_grupo_material,
	f.ie_tipo_material_conv,
	a.vl_unitario,
	a.ie_tiss_tipo_despesa
FROM subgrupo_material g, conta_paciente e, classe_material c, material b, material_atend_paciente a
LEFT OUTER JOIN mat_atend_pac_convenio f ON (a.nr_sequencia = f.nr_seq_material)
WHERE a.nr_interno_conta		= e.nr_interno_conta and a.cd_material			= b.cd_material and b.cd_classe_material		= c.cd_classe_material and c.cd_subgrupo_material		= g.cd_subgrupo_material  and a.nr_interno_conta		= nr_interno_conta_p;


BEGIN

-- dsantos em 23/11/09 -> pegar tipo atend para passar na TISS_OBTER_REGRA_MAT_OPM
select	max(obter_tipo_atendimento(a.nr_atendimento)),
	max(tiss_obter_versao(a.cd_convenio_parametro,a.cd_estabelecimento,a.dt_mesano_referencia)),
	coalesce(max(ie_senha_taxa_guia_proc),'N')
into STRICT	ie_tipo_atendimento_w,
	ds_versao_w,
	ie_senha_taxa_guia_proc_w
from	conta_paciente a,
	tiss_parametros_convenio b
where	a.cd_convenio_parametro	= b.cd_convenio
and	a.cd_estabelecimento	= b.cd_estabelecimento
and	a.nr_interno_conta	= nr_interno_conta_p;

open c01;
loop
fetch c01 into
	nr_sequencia_w,
	cd_procedimento_w,
	ie_origem_proced_w,
	cd_area_proc_w,
	cd_grupo_proc_w,
	cd_especialidade_proc_w,
	cd_estabelecimento_w,
	cd_convenio_w,
	nr_doc_convenio_w,
	ie_tiss_tipo_despesa_ant_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	select	TISS_OBTER_REGRA_TIPO_PROC(	cd_convenio_w,
					cd_estabelecimento_w,
					cd_area_proc_w,
					cd_especialidade_proc_w,
					cd_grupo_proc_w,
					cd_procedimento_w)
	into STRICT	ie_tipo_desp_proc_regra_w
	;
	
	if (coalesce(ie_tipo_desp_proc_regra_w,'X') <> 'X') then

		if (ie_tipo_desp_proc_regra_w	= '1') then
			ie_tiss_tipo_despesa_w	:= '2';
		elsif (ie_tipo_desp_proc_regra_w	= '2') then
			ie_tiss_tipo_despesa_w	:= '3';
		elsif (ie_tipo_desp_proc_regra_w	= '3') then
			ie_tiss_tipo_despesa_w	:= '9';
		elsif (ie_tipo_desp_proc_regra_w	= '4') then
			ie_tiss_tipo_despesa_w	:= '6';	--Aluguel
		elsif (ie_tipo_desp_proc_regra_w	= '5') then
			ie_tiss_tipo_despesa_w	:= '5';	--Diarias
		elsif (ie_tipo_desp_proc_regra_w	= '6') then
			ie_tiss_tipo_despesa_w	:= '4';	--Taxas
		elsif (ie_tipo_desp_proc_regra_w	= '7') then
			ie_tiss_tipo_despesa_w	:= '1';	--Gases medicinais		
		end if;

	else

		select	ie_classificacao,
			ie_forma_apresentacao
		into STRICT	ie_classificacao_w,
			ie_forma_apresentacao_w
		from	procedimento
		where	cd_procedimento		= cd_procedimento_w
		and	ie_origem_proced	= ie_origem_proced_w;

		ie_tiss_tipo_despesa_w		:= null;
		if (coalesce(ie_forma_apresentacao_w, 0) in (3, 2)) then
			ie_tiss_tipo_despesa_w	:= '1';			-- gases
		elsif (coalesce(ie_classificacao_w, '0') = '3') then
			ie_tiss_tipo_despesa_w	:= '5';			-- diárias
		else
			ie_tiss_tipo_despesa_w	:= '4';			-- taxas
		end if;
		
		/*Este não tem prioridade sobre a regra, deve considerar somente se não existir regra TISS_OBTER_REGRA_TIPO_PROC*/

		select	max(ie_tipo_despesa_tiss)
		into STRICT	ie_tipo_despesa_tiss_w
		from	procedimento
		where	cd_procedimento		= cd_procedimento_w
		and	ie_origem_proced	= ie_origem_proced_w;

		if (ie_tipo_despesa_tiss_w IS NOT NULL AND ie_tipo_despesa_tiss_w::text <> '') then
			ie_tiss_tipo_despesa_w	:= ie_tipo_despesa_tiss_w;
		end if;

	end if;

	if (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'S') then
		if (ie_tiss_tipo_despesa_w in ('4','6')) then --Taxas Diversas, Aluguel
			ie_tiss_tipo_despesa_w	:= '7'; --Taxas e aluguéis
		elsif (ie_tiss_tipo_despesa_w in ('7','8','9')) then --Órtese, Prótese, Materiais especiais
			ie_tiss_tipo_despesa_w	:= '8'; --OPME
		end if;
	end if;
	
	if (ie_senha_taxa_guia_proc_w = 'S') and
		(((obter_se_projeto_versao(0,12,ds_versao_w,0) = 'S') and (ie_tiss_tipo_despesa_w in ('5','7'))) or --Diárias, Taxas e aluguéis
		 ((obter_se_projeto_versao(0,12,ds_versao_w,0) = 'N') and (ie_tiss_tipo_despesa_w in ('4','5','6')))) then --Taxas Diversas, Diárias, Aluguel
		
		begin
			select	cd_senha
			into STRICT	cd_senha_item_w
			from	procedimento_paciente
			where	nr_interno_conta	= nr_interno_conta_p
			and	nr_doc_convenio		= nr_doc_convenio_w
			and	coalesce(cd_motivo_exc_conta::text, '') = ''
			and	(cd_senha IS NOT NULL AND cd_senha::text <> '')  LIMIT 1;			
		exception
		when others then
			cd_senha_item_w	:= null;
		end;
		
		if (cd_senha_item_w IS NOT NULL AND cd_senha_item_w::text <> '') then
		
			update	procedimento_paciente
			set	cd_senha	= cd_senha_item_w
			where	nr_sequencia	= nr_sequencia_w;
		
		end if;
	end if;

	if (coalesce(ie_tiss_tipo_despesa_ant_w,'XPTO')	<> coalesce(ie_tiss_tipo_despesa_w,'XPTO')) then
	
		update	procedimento_paciente
		set	ie_tiss_tipo_despesa	= ie_tiss_tipo_despesa_w
		where	nr_sequencia		= nr_sequencia_w;
		
	end if;
	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end loop;
close c01;

open c02;
loop
fetch c02 into
	nr_sequencia_w,
	ie_tipo_material_w,
	ie_tipo_classe_w,
	cd_convenio_w,
	cd_estabelecimento_w,
	cd_material_w,
	cd_classe_material_w,
	cd_subgrupo_material_w,
	cd_grupo_material_w,
	ie_tipo_material_conv_w,
	vl_material_unitario_w,
	ie_tiss_tipo_despesa_ant_w;
EXIT WHEN NOT FOUND; /* apply on c02 */

	ie_tiss_tipo_despesa_w	:= null;
	ie_tipo_material_w	:= coalesce(ie_tipo_material_conv_w, ie_tipo_material_w);

	select	max(TISS_OBTER_REGRA_MAT_OPM(	cd_convenio_w,
						cd_estabelecimento_w,
						cd_material_w,
						cd_classe_material_w,
						cd_subgrupo_material_w,
						cd_grupo_material_w,
						ie_tipo_atendimento_w,
						vl_material_unitario_w))
	into STRICT	ie_tipo_desp_regra_w
	;

	if (coalesce(ie_tipo_desp_regra_w,'X') not in ('X','N','S')) then

		if (ie_tipo_desp_regra_w	= '1') then
			ie_tiss_tipo_despesa_w	:= '1';
		elsif (ie_tipo_desp_regra_w	= '2') then
			ie_tiss_tipo_despesa_w	:= '2';
		elsif (ie_tipo_desp_regra_w	= '3') then
			ie_tiss_tipo_despesa_w	:= '3';
		elsif (ie_tipo_desp_regra_w	= '4') then
			ie_tiss_tipo_despesa_w	:= '4';
		end if;

	else

		if (ie_tipo_classe_w = 'G') then
			ie_tiss_tipo_despesa_w		:= '1';
		elsif (ie_tipo_classe_w = 'O') then		-- Edgar 16/01/2009, OS 123077, incluído tratamento de OPM
			ie_tiss_tipo_despesa_w		:= '7';
		elsif (ie_tipo_classe_w = 'P') then
			ie_tiss_tipo_despesa_w		:= '8';
		elsif (ie_tipo_classe_w = 'M') then
			ie_tiss_tipo_despesa_w		:= '9';
		else
			if (ie_tipo_material_w = '1') then
				ie_tiss_tipo_despesa_w	:= '3';				-- Alterado por lhalves em 05/08/2014 OS 765853 - considerar todos os tipos de medicamento.
			elsif (ie_tipo_material_w in ('0','2','3','6','8','9')) then 	--0 - Medicamento Manipulado, 2 - Medicamento Comercial, 3 - Medicamento Genérico, 6 - Medicamento sem apresentação,
				ie_tiss_tipo_despesa_w	:= '2';				--8 - Medicamento exclusivo para faturamento, 9 - Medicamento Similar
			else
				ie_tiss_tipo_despesa_w	:= '3';
			end if;
		end if;
	end if;

	if (obter_se_projeto_versao(0,12,ds_versao_w,0) = 'S') then
		if (ie_tiss_tipo_despesa_w in ('4','6')) then --Taxas Diversas, Aluguel
			ie_tiss_tipo_despesa_w	:= '7'; --Taxas e aluguéis
		elsif (ie_tiss_tipo_despesa_w in ('7','8','9')) then --Órtese, Prótese, Materiais especiais
			ie_tiss_tipo_despesa_w	:= '8'; --OPME
		elsif (coalesce(ie_tipo_desp_regra_w,'X') = 'S') then --Se tiver regra dizendo que é OPME para o TISS 3, trata como 8
			ie_tiss_tipo_despesa_w	:= '8'; --OPME
		end if;
	end if;

	if (coalesce(ie_tiss_tipo_despesa_ant_w,'XPTO')	<> coalesce(ie_tiss_tipo_despesa_w,'XPTO')) then
	
		update	material_atend_paciente
		set	ie_tiss_tipo_despesa	= ie_tiss_tipo_despesa_w
		where	nr_sequencia		= nr_sequencia_w;

	end if;
	
	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end loop;
close c02;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE tiss_atualizar_despesas (nr_interno_conta_p text, nm_usuario_p text) FROM PUBLIC;

