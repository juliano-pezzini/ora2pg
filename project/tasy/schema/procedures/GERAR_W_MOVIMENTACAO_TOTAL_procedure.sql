-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_w_movimentacao_total ( cd_setor_destino_p bigint default 0, cd_setor_origem_p bigint default 0) AS $body$
DECLARE


qt_total_w		varchar(255);
cc_uti_w		bigint;
uti_cc_w		bigint;
qt_total_cirurgias_w	bigint;
ds_total_cirurgias_w	varchar(255);
perc_cc_uti_w		varchar(255);
perc_uti_cc_w		varchar(255);
qt_uti_cc_w		varchar(255);
qt_cc_uti_w		varchar(255);


BEGIN

delete	FROM relat_movimentacao_total;
commit;


select 	count(*)
into STRICT	qt_total_w
from    w_relat_movimentacao_pac a
WHERE	((a.cd_setor_origem  = cd_setor_origem_p) or (coalesce(cd_setor_origem_p,0) = 0))
and	((a.CD_SETOR_DESTINO = cd_setor_destino_p) or (coalesce(cd_setor_destino_p,0) = 0));


select 	count(*)
into STRICT	cc_uti_w
from   	w_relat_movimentacao_pac a
where  	obter_classif_setor(a.cd_setor_origem)  = 2
and    	obter_classif_setor(a.cd_setor_destino) = 4
and	((a.cd_setor_origem  = cd_setor_origem_p) or (coalesce(cd_setor_origem_p,0) = 0))
and	((a.CD_SETOR_DESTINO = cd_setor_destino_p)  or (coalesce(cd_setor_destino_p,0) = 0));

select 	count(*)
into STRICT	uti_cc_w
from   	w_relat_movimentacao_pac a
where  	obter_classif_setor(a.cd_setor_origem)  = 4
and    	obter_classif_setor(a.cd_setor_destino) = 2
and	((a.cd_setor_origem  = cd_setor_origem_p) or (coalesce(cd_setor_origem_p,0) = 0))
and	((a.CD_SETOR_DESTINO = cd_setor_destino_p)  or (coalesce(cd_setor_destino_p,0) = 0));


select 	max(x.qt_total_cirurgia)
into STRICT	qt_total_cirurgias_w
from 	w_relat_movimentacao_pac x;

select (wheb_mensagem_pck.get_texto(802299) || ' -> ' || wheb_mensagem_pck.get_texto(802300) || ': ' || coalesce(round((cc_uti_w * 100 / qt_total_cirurgias_w)::numeric,2),0))
into STRICT	 perc_cc_uti_w
;

select (wheb_mensagem_pck.get_texto(802300) || ' -> ' || wheb_mensagem_pck.get_texto(802299) || ': ' || coalesce(round((uti_cc_w * 100 / qt_total_cirurgias_w)::numeric,2),0))
into STRICT	perc_uti_cc_w
;

select (wheb_mensagem_pck.get_texto(802301) || ' ' || qt_total_w)
into STRICT	qt_total_w
;

select	wheb_mensagem_pck.get_texto(802302) || ' (' || wheb_mensagem_pck.get_texto(802299) || ' -> ' || wheb_mensagem_pck.get_texto(802300) || '): ' || cc_uti_w
into STRICT	qt_cc_uti_w
;

select	wheb_mensagem_pck.get_texto(802302) || ' (' || wheb_mensagem_pck.get_texto(802300) || ' -> ' || wheb_mensagem_pck.get_texto(802299) || '): ' || uti_cc_w
into STRICT	qt_uti_cc_w
;

select 	wheb_mensagem_pck.get_texto(802303, 'QT_CIRURGIAS='||qt_total_cirurgias_w)
into STRICT	ds_total_cirurgias_w
;

insert into  relat_movimentacao_total(ds_total_cirurgia,
	ds_perc_cc_uti,
	ds_perc_uti_cc,
	ds_total,
	ds_cc_uti,
	ds_uti_cc,
	nr_sequencia,
	dt_atualizacao,
	nm_usuario)
	values (
	ds_total_cirurgias_w,
	perc_cc_uti_w,
	perc_uti_cc_w,
	qt_total_w,
	qt_cc_uti_w,
	qt_uti_cc_w,
	nextval('w_relat_movimentacao_pac_seq'),
	clock_timestamp(),
	Obter_Usuario_Ativo);


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_w_movimentacao_total ( cd_setor_destino_p bigint default 0, cd_setor_origem_p bigint default 0) FROM PUBLIC;

