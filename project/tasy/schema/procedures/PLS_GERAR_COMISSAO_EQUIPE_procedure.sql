-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gerar_comissao_equipe ( nr_seq_repasse_vend_p bigint, nr_seq_vendedor_p bigint, ie_acao_p text, nm_usuario_p text) AS $body$
DECLARE


dt_referencia_w			timestamp;
qt_meta_w			bigint;
nr_seq_contrato_w		bigint;
nr_seq_mensalidade_seg_w	bigint;
nr_parcela_w			bigint;
ie_tipo_pessoa_w		varchar(2);
ie_preco_w			varchar(2);
nr_seq_segurado_w		bigint;
pr_meta_w			double precision;
qt_tot_vidas_w			bigint	:= 0;
nr_seq_equipe_w			bigint;
ie_tipo_contrato_w		varchar(2);
qt_vidas_w			bigint;
nr_seq_meta_equipe_w		bigint;
nr_seq_meta_atingir_w		bigint;
nr_seq_regra_meta_w		bigint;
pr_comissao_w			double precision;
ie_acao_contrato_w		varchar(15);
qt_idade_w			bigint;
vl_mensalidade_w		double precision;
vl_comissao_venda_w		double precision;
qt_reg_mens_w			bigint;
qt_repasse_gerado_w		bigint;
nr_seq_sca_w			bigint;
nr_seq_plano_w			bigint;
vl_comissao_w			double precision;
nr_seq_portabilidade_w		bigint;
nr_seq_repasse_w		bigint;
nr_seq_item_mens_w		bigint;
ie_tipo_item_w			varchar(2);
vl_item_w			double precision;
nr_seq_repasse_total_w		bigint;
vl_repasse_total_w		double precision;
nr_seq_sca_vidas_w		bigint;
qt_vidas_sca_w			bigint;
qt_vidas_total_sca_w		bigint;
vl_sca_embutido_w		double precision;
ie_tipo_meta_w			varchar(1);
vl_total_itens_w		double precision;
ie_sca_embutido_w		varchar(1);
nr_seq_segurado_preco_origem_w	bigint;
dt_mesano_referencia_w		timestamp;
nr_seq_motivo_inclusao_w	bigint;
nr_seq_grupo_produto_w		bigint;
nr_seq_plano_meta_w		bigint;
ie_recebe_comissao_w		varchar(1);
dt_inicio_movimento_w		timestamp;
dt_fim_movimento_w		timestamp;
ie_acao_contrato_meta_w		varchar(255);
vl_pro_rata_dia_w		double precision;
nr_seq_tipo_comissao_w		pls_tipo_comissao_contrato.nr_sequencia%type;
ie_dt_ref_comissao_equipe_w	pls_parametros.ie_dt_ref_comissao_equipe%type;
nr_parcela_contrato_w		pls_mensalidade_segurado.nr_parcela_contrato%type;
nr_seq_vendedor_canal_w		pls_segurado.nr_seq_vendedor_canal%type;
nr_seq_cargo_canal_w		pls_equipe_vend_vinculo.nr_seq_cargo_canal%type;
nr_seq_cargo_canal_inf_w	pls_equipe_vend_vinculo.nr_seq_cargo_canal%type;
qt_regra_repasse_sup_w		pls_regra_repasse_superior.nr_sequencia%type;
dt_contratacao_w		pls_segurado.dt_contratacao%type;
qt_item_seg_gerado_w		integer;
nm_canal_venda_w		varchar(255);
ie_vl_integral_1_parcela_w	pls_equipe_meta_comissao.ie_vl_integral_1_parcela%type;
ie_gerar_juro_mult_tit_w	varchar(1);
vl_juros_multa_w		double precision := 0;
nr_titulo_w			titulo_receber.nr_titulo%type;
ie_situacao_titulo_w		titulo_receber.ie_situacao%type;
vl_origem_w			pls_repasse_mens_item.vl_origem%type;
vl_origem_total_w		pls_repasse_mens.vl_origem%type;
vl_recebido_w			titulo_receber_liq.vl_recebido%type;
dt_liquidacao_ini_w		timestamp;
dt_liquidacao_fim_w		timestamp;
ie_comissao_equipe_tit_abert_w	pls_parametros.ie_comissao_equipe_tit_aberto%type;
dt_contrato_w			pls_contrato.dt_contrato%type;

C01 CURSOR FOR
	SELECT	a.qt_meta,
		a.ie_tipo_contrato,
		a.nr_sequencia,
		a.ie_tipo_meta,
		a.nr_seq_grupo_produto,
		a.nr_seq_plano,
		a.ie_acao_contrato
	from	pls_equipe_vend_meta	a,
		pls_equipe_vendedor	b
	where	a.nr_seq_equipe		= b.nr_sequencia
	and	b.nr_sequencia		= nr_seq_equipe_w
	and	coalesce(a.nr_seq_vendedor_canal,nr_seq_vendedor_p)	= nr_seq_vendedor_p
	and	dt_referencia_w	between a.dt_inicio_vigencia and coalesce(dt_fim_vigencia,dt_referencia_w);

C02 CURSOR FOR
	SELECT	'N' ie_sca_embutido,
		e.nr_seq_contrato,
		b.nr_sequencia nr_seq_mens_seg,
		b.nr_parcela,
		b.nr_parcela_contrato,
		e.ie_acao_contrato,
		CASE WHEN coalesce(g.cd_pf_estipulante::text, '') = '' THEN 'PJ'  ELSE 'PF' END ,
		f.ie_preco,
		e.nr_sequencia,
		substr(obter_idade_pf(e.cd_pessoa_fisica, clock_timestamp(), 'A'),1,10),
		e.nr_seq_plano,
		a.nr_sequencia,
		a.ie_tipo_item,
		d.nr_seq_plano,
		a.vl_item,
		b.dt_mesano_referencia,
		e.nr_seq_portabilidade,
		e.nr_seq_motivo_inclusao,
		g.nr_seq_tipo_comissao,
		e.nr_seq_vendedor_canal,
		a.vl_pro_rata_dia,
		e.dt_contratacao,
		h.nr_titulo,
		h.ie_situacao,
		g.dt_contrato
	FROM titulo_receber h, pls_contrato g, pls_plano f, pls_segurado e, pls_mensalidade c, pls_mensalidade_segurado b, pls_mensalidade_seg_item a
LEFT OUTER JOIN pls_sca_vinculo d ON (a.nr_seq_vinculo_sca = d.nr_sequencia)
WHERE a.nr_seq_mensalidade_seg = b.nr_sequencia and c.nr_sequencia		= b.nr_seq_mensalidade and e.nr_sequencia		= b.nr_seq_segurado and f.nr_sequencia		= e.nr_seq_plano and e.nr_seq_contrato	= g.nr_sequencia and h.nr_seq_mensalidade	= c.nr_sequencia  and coalesce(c.ie_cancelamento::text, '') = '' and ((e.nr_seq_vendedor_canal = nr_seq_vendedor_p) or ((ie_recebe_comissao_w = 'E') and (exists (	SELECT	1
														from	pls_equipe_vend_vinculo	x
														where	x.nr_seq_equipe		= nr_seq_equipe_w
														and	x.nr_seq_vendedor	= e.nr_seq_vendedor_canal
														and	dt_referencia_w between coalesce(x.dt_inicio_vigencia, dt_referencia_w) and coalesce(x.dt_fim_vigencia, dt_referencia_w))))) and (((ie_dt_ref_comissao_equipe_w = 'C') and (e.dt_contratacao between coalesce(dt_inicio_movimento_w, e.dt_contratacao) and coalesce(dt_fim_movimento_w, e.dt_contratacao))) or
		((ie_dt_ref_comissao_equipe_w = 'L') and (h.dt_liquidacao between coalesce(dt_inicio_movimento_w, h.dt_liquidacao) and coalesce(dt_fim_movimento_w, h.dt_liquidacao)))) and ((CASE WHEN coalesce(g.cd_pf_estipulante::text, '') = '' THEN 'PJ'  ELSE 'PF' END  = ie_tipo_contrato_w) or (ie_tipo_contrato_w = 'A')) and ((coalesce(nr_seq_grupo_produto_w::text, '') = '') or (exists (	select	1
								from	pls_preco_produto z
								where	z.nr_seq_plano	= e.nr_seq_plano
								and	z.nr_seq_grupo	= nr_seq_grupo_produto_w))) and ((e.nr_seq_plano = nr_seq_plano_meta_w) or (coalesce(nr_seq_plano_meta_w::text, '') = '')) and ((coalesce(h.dt_liquidacao::text, '') = '') or (h.dt_liquidacao between coalesce(dt_liquidacao_ini_w, h.dt_liquidacao) and coalesce(dt_liquidacao_fim_w, h.dt_liquidacao)))
	
union

	select	'N' ie_sca_embutido,
		e.nr_seq_contrato,
		b.nr_sequencia nr_seq_mens_seg,
		b.nr_parcela,
		b.nr_parcela_contrato,
		e.ie_acao_contrato,
		CASE WHEN coalesce(g.cd_pf_estipulante::text, '') = '' THEN 'PJ'  ELSE 'PF' END ,
		f.ie_preco,
		e.nr_sequencia,
		substr(obter_idade_pf(e.cd_pessoa_fisica, clock_timestamp(), 'A'),1,10),
		e.nr_seq_plano,
		a.nr_sequencia,
		a.ie_tipo_item,
		d.nr_seq_plano,
		a.vl_item,
		b.dt_mesano_referencia,
		e.nr_seq_portabilidade,
		e.nr_seq_motivo_inclusao,
		g.nr_seq_tipo_comissao,
		e.nr_seq_vendedor_canal,
		a.vl_pro_rata_dia,
		e.dt_contratacao,
		h.nr_titulo,
		h.ie_situacao,
		g.dt_contrato
	FROM pls_segurado_canal_compl i, titulo_receber h, pls_contrato g, pls_plano f, pls_segurado e, pls_mensalidade c, pls_mensalidade_segurado b, pls_mensalidade_seg_item a
LEFT OUTER JOIN pls_sca_vinculo d ON (a.nr_seq_vinculo_sca = d.nr_sequencia)
WHERE a.nr_seq_mensalidade_seg	= b.nr_sequencia and c.nr_sequencia			= b.nr_seq_mensalidade and e.nr_sequencia			= b.nr_seq_segurado and f.nr_sequencia			= e.nr_seq_plano and e.nr_seq_contrato		= g.nr_sequencia and h.nr_seq_mensalidade		= c.nr_sequencia  and i.nr_seq_segurado		= e.nr_sequencia and coalesce(c.ie_cancelamento::text, '') = '' and ((i.nr_seq_vendedor_canal = nr_seq_vendedor_p) or
		((ie_recebe_comissao_w = 'E') and (exists (	select	1
								from	pls_equipe_vend_vinculo	x
								where	x.nr_seq_equipe		= nr_seq_equipe_w
								and	x.nr_seq_vendedor	= i.nr_seq_vendedor_canal
								and	dt_referencia_w between coalesce(x.dt_inicio_vigencia, dt_referencia_w) and coalesce(x.dt_fim_vigencia, dt_referencia_w))))) and (((ie_dt_ref_comissao_equipe_w = 'C') and (e.dt_contratacao between coalesce(dt_inicio_movimento_w, e.dt_contratacao) and coalesce(dt_fim_movimento_w, e.dt_contratacao))) or
		((ie_dt_ref_comissao_equipe_w = 'L') and (h.dt_liquidacao between coalesce(dt_inicio_movimento_w, h.dt_liquidacao) and coalesce(dt_fim_movimento_w, h.dt_liquidacao)))) and ((CASE WHEN coalesce(g.cd_pf_estipulante::text, '') = '' THEN 'PJ'  ELSE 'PF' END  = ie_tipo_contrato_w) or (ie_tipo_contrato_w = 'A')) and ((coalesce(nr_seq_grupo_produto_w::text, '') = '') or (exists (	select	1
								from	pls_preco_produto z
								where	z.nr_seq_plano	= e.nr_seq_plano
								and	z.nr_seq_grupo	= nr_seq_grupo_produto_w))) and ((e.nr_seq_plano = nr_seq_plano_meta_w) or (coalesce(nr_seq_plano_meta_w::text, '') = '')) and ((coalesce(h.dt_liquidacao::text, '') = '') or (h.dt_liquidacao between coalesce(dt_liquidacao_ini_w, h.dt_liquidacao) and coalesce(dt_liquidacao_fim_w, h.dt_liquidacao)))
	 
union all

	select	'S' ie_sca_embutido,
		e.nr_seq_contrato,
		b.nr_sequencia nr_seq_mens_seg,
		i.nr_parcela,
		b.nr_parcela_contrato,
		e.ie_acao_contrato,
		CASE WHEN coalesce(g.cd_pf_estipulante::text, '') = '' THEN 'PJ'  ELSE 'PF' END ,
		f.ie_preco,
		e.nr_sequencia,
		substr(obter_idade_pf(e.cd_pessoa_fisica, clock_timestamp(), 'A'),1,10),
		e.nr_seq_plano,
		a.nr_sequencia,
		'15',
		d.nr_seq_plano,
		i.vl_parcela,
		b.dt_mesano_referencia,
		e.nr_seq_portabilidade,
		e.nr_seq_motivo_inclusao,
		g.nr_seq_tipo_comissao,
		e.nr_seq_vendedor_canal,
		a.vl_pro_rata_dia,
		e.dt_contratacao,
		h.nr_titulo,
		h.ie_situacao,
		g.dt_contrato
	from	pls_mensalidade_seg_item a,
		pls_mensalidade_sca	i,
		pls_mensalidade_segurado b,
		pls_mensalidade		c,
		pls_sca_vinculo		d,
		pls_segurado		e,
		pls_plano		f,
		pls_contrato		g,
		titulo_receber		h
	where	a.nr_seq_mensalidade_seg = b.nr_sequencia
	and	i.nr_seq_item_mens	= a.nr_sequencia
	and	c.nr_sequencia		= b.nr_seq_mensalidade
	and	e.nr_sequencia		= b.nr_seq_segurado
	and	f.nr_sequencia		= e.nr_seq_plano
	and	e.nr_seq_contrato	= g.nr_sequencia
	and	h.nr_seq_mensalidade	= c.nr_sequencia
	and	i.nr_seq_vinculo_sca	= d.nr_sequencia
	and	coalesce(c.ie_cancelamento::text, '') = ''
	and	a.ie_tipo_item		= '1'
	and	coalesce(d.ie_lancamento_mensalidade,'D') = 'C' -- só gera comissão para SCA embutido, se alterar o valor do preço pré-estabelecido
	and	((e.nr_seq_vendedor_canal = nr_seq_vendedor_p) or ((ie_recebe_comissao_w = 'E') and (exists (	select	1
														from	pls_equipe_vend_vinculo	x
														where	x.nr_seq_equipe		= nr_seq_equipe_w
														and	x.nr_seq_vendedor	= e.nr_seq_vendedor_canal
														and	dt_referencia_w between coalesce(x.dt_inicio_vigencia, dt_referencia_w) and coalesce(x.dt_fim_vigencia, dt_referencia_w)))))
	and	(((ie_dt_ref_comissao_equipe_w = 'C') and (e.dt_contratacao between coalesce(dt_inicio_movimento_w, e.dt_contratacao) and coalesce(dt_fim_movimento_w, e.dt_contratacao))) or
		((ie_dt_ref_comissao_equipe_w = 'L') and (h.dt_liquidacao between coalesce(dt_inicio_movimento_w, h.dt_liquidacao) and coalesce(dt_fim_movimento_w, h.dt_liquidacao))))
	and	((CASE WHEN coalesce(g.cd_pf_estipulante::text, '') = '' THEN 'PJ'  ELSE 'PF' END  = ie_tipo_contrato_w) or (ie_tipo_contrato_w = 'A'))
	and	((coalesce(nr_seq_grupo_produto_w::text, '') = '') or (exists (	select	1
								from	pls_preco_produto z
								where	z.nr_seq_plano	= e.nr_seq_plano
								and	z.nr_seq_grupo	= nr_seq_grupo_produto_w)))
	and	((e.nr_seq_plano = nr_seq_plano_meta_w) or (coalesce(nr_seq_plano_meta_w::text, '') = ''))
	and	((coalesce(h.dt_liquidacao::text, '') = '') or (h.dt_liquidacao between coalesce(dt_liquidacao_ini_w, h.dt_liquidacao) and coalesce(dt_liquidacao_fim_w, h.dt_liquidacao)))
	order by nr_seq_mens_seg,
		ie_tipo_item;

C03 CURSOR FOR
	SELECT	a.nr_sequencia,
		coalesce(a.pr_comissao,0),
		coalesce(a.vl_comissao,0),
		a.ie_vl_integral_1_parcela
	from	pls_equipe_meta_comissao	a,
		pls_equipe_meta_atingir		b
	where	a.nr_seq_meta_atingir	= b.nr_sequencia
	and	b.nr_sequencia		= nr_seq_meta_atingir_w
	and	((pls_obter_se_item_lista(a.ie_acao_contrato,ie_acao_contrato_w) = 'S') or (coalesce(a.ie_acao_contrato::text, '') = ''))
	and	((pls_obter_se_item_lista(a.ie_tipo_item_mensalidade,ie_tipo_item_w) = 'S') or (coalesce(a.ie_tipo_item_mensalidade::text, '') = ''))
	and	qt_idade_w between coalesce(a.qt_idade_inicial,qt_idade_w) and coalesce(a.qt_idade_final,qt_idade_w)
	and	((a.nr_seq_plano_sca = nr_seq_sca_w) or (coalesce(a.nr_seq_plano_sca::text, '') = ''))
	and	((coalesce(a.ie_portabilidade,'N') = 'S' and (nr_seq_portabilidade_w IS NOT NULL AND nr_seq_portabilidade_w::text <> '')) or coalesce(a.ie_portabilidade,'N') = 'N')
	and	((a.nr_seq_motivo_inclusao = nr_seq_motivo_inclusao_w) or (coalesce(a.nr_seq_motivo_inclusao::text, '') = ''))
	and	((a.nr_seq_tipo_comissao = nr_seq_tipo_comissao_w) or (coalesce(a.nr_seq_tipo_comissao::text, '') = ''))
	and	nr_parcela_w between coalesce(a.nr_parcela_inicial,nr_parcela_w) and coalesce(a.nr_parcela_final,nr_parcela_w)
	and	nr_parcela_contrato_w between coalesce(a.nr_parcela_contr_inicial,nr_parcela_contrato_w) and coalesce(a.nr_parcela_contr_final,nr_parcela_contrato_w)
	and	((a.nr_seq_contrato = nr_seq_contrato_w) or (coalesce(a.nr_seq_contrato::text, '') = ''))
	and 	dt_contratacao_w between coalesce(a.dt_adesao_inicial,dt_contratacao_w) and coalesce(a.dt_adesao_final,dt_contratacao_w)
	and	dt_contrato_w between coalesce(a.dt_contrato_inicial, dt_contrato_w) and coalesce(a.dt_contrato_final,dt_contrato_w)
	order by
		coalesce(a.nr_seq_contrato, '0'),
		coalesce(a.nr_seq_plano_sca, '0'),
		coalesce(a.ie_acao_contrato, ' '),
		coalesce(a.ie_tipo_item_mensalidade, ' '),
		coalesce(a.ie_portabilidade, ' '),
		coalesce(a.nr_seq_motivo_inclusao, '0'),
		coalesce(a.nr_seq_tipo_comissao, '0');

C04 CURSOR FOR
	SELECT	nr_sequencia
	from	pls_repasse_mens
	where	nr_seq_repasse	= nr_seq_repasse_vend_p;

C05 CURSOR FOR
	SELECT	a.nr_seq_plano_sca
	from	pls_equipe_meta_comissao	a,
		pls_equipe_meta_atingir		b
	where	a.nr_seq_meta_atingir	= b.nr_sequencia
	and	a.ie_tipo_item_mensalidade	= '15'
	and	b.nr_seq_meta_equipe	= nr_seq_meta_equipe_w
	group	by	a.nr_seq_plano_sca;


BEGIN

delete	from	pls_repasse_mens
where	nr_seq_repasse = nr_seq_repasse_vend_p;

if (ie_acao_p = 'D') then
	update	pls_repasse_vend
	set	dt_aprovacao	 = NULL,
		nm_usuario_aprov  = NULL,
		ds_inf_geracao	= '',
		ie_status	= 'A',
		qt_vidas	= 0
	where	nr_sequencia	= nr_seq_repasse_vend_p;

	delete	from	pls_repasse_vend_venc
	where	nr_seq_repasse	= nr_seq_repasse_vend_p;
else
	ie_gerar_juro_mult_tit_w := pls_obter_se_gera_juro_mult(wheb_usuario_pck.get_cd_estabelecimento);

	begin
	select	coalesce(ie_dt_ref_comissao_equipe,'L'),
		coalesce(ie_comissao_equipe_tit_aberto,'N')
	into STRICT	ie_dt_ref_comissao_equipe_w,
		ie_comissao_equipe_tit_abert_w
	from	pls_parametros
	where	cd_estabelecimento	= wheb_usuario_pck.get_cd_estabelecimento;
	exception
	when others then
		ie_dt_ref_comissao_equipe_w	:= 'L';
		ie_comissao_equipe_tit_abert_w	:= 'N';
	end;

	select	trunc(max(dt_referencia),'month'),
		max(dt_movimento),
		max(dt_movimento_fim),
		max(dt_liquidacao_inicial),
		max(dt_liquidacao_final)
	into STRICT	dt_referencia_w,
		dt_inicio_movimento_w,
		dt_fim_movimento_w,
		dt_liquidacao_ini_w,
		dt_liquidacao_fim_w
	from	pls_repasse_vend
	where	nr_sequencia = nr_seq_repasse_vend_p;

	dt_inicio_movimento_w	:= coalesce(dt_inicio_movimento_w, trunc(dt_referencia_w,'month'));
	dt_fim_movimento_w	:= fim_dia(coalesce(dt_fim_movimento_w, last_day(dt_referencia_w)));

	begin
	select	a.nr_seq_equipe,
		a.ie_recebe_comissao,
		nr_seq_cargo_canal
	into STRICT	nr_seq_equipe_w,
		ie_recebe_comissao_w,
		nr_seq_cargo_canal_w
	from	pls_equipe_vend_vinculo	a
	where	a.nr_seq_vendedor = nr_seq_vendedor_p
	and	dt_referencia_w between coalesce(a.dt_inicio_vigencia,dt_referencia_w) and coalesce(a.dt_fim_vigencia,dt_referencia_w);
	exception
	when no_data_found then
		select	pls_obter_dados_vendedor(nr_seq_vendedor_p,'N') nm_canal_venda
		into STRICT	nm_canal_venda_w
		;

		CALL wheb_mensagem_pck.exibir_mensagem_abort(226164, 'NR_SEQ_CANAL_VENDA=' || nr_seq_vendedor_p || ';NM_CANAL_VENDA=' || nm_canal_venda_w);
		/* Mensagem: O canal de venda NR_SEQ_CANAL_VENDA - NM_CANAL_VENDA não está vinculado a uma equipe! */

	when too_many_rows then
		select	pls_obter_dados_vendedor(nr_seq_vendedor_p,'N') nm_canal_venda
		into STRICT	nm_canal_venda_w
		;

		CALL wheb_mensagem_pck.exibir_mensagem_abort(226165, 'NR_SEQ_CANAL_VENDA=' || nr_seq_vendedor_p || ';NM_CANAL_VENDA=' || nm_canal_venda_w);
		/* Mensagem: O canal de venda NR_SEQ_CANAL_VENDA - NM_CANAL_VENDA está vinculado a mais de uma equipe! */

	end;
	ie_recebe_comissao_w	:= coalesce(ie_recebe_comissao_w,'C');

	open C01;
	loop
	fetch C01 into
		qt_meta_w,
		ie_tipo_contrato_w,
		nr_seq_meta_equipe_w,
		ie_tipo_meta_w,
		nr_seq_grupo_produto_w,
		nr_seq_plano_meta_w,
		ie_acao_contrato_meta_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		if (ie_tipo_meta_w = 'E') then
			select	count(1)
			into STRICT	qt_vidas_w
			from	pls_mensalidade		a,
				pls_mensalidade_segurado b,
				pls_segurado		c,
				pls_plano		d,
				pls_contrato		e,
				titulo_receber		f
			where	a.nr_sequencia		= b.nr_seq_mensalidade
			and	c.nr_sequencia		= b.nr_seq_segurado
			and	d.nr_sequencia		= c.nr_seq_plano
			and	c.nr_seq_contrato	= e.nr_sequencia
			and	f.nr_seq_mensalidade	= a.nr_sequencia
			and	coalesce(a.ie_cancelamento::text, '') = ''
			and (f.ie_situacao	= '2' or ie_comissao_equipe_tit_abert_w = 'S')
			and	exists (SELECT	1
					from	pls_equipe_vend_vinculo	x
					where	x.nr_seq_equipe		= nr_seq_equipe_w
					and	x.nr_seq_vendedor	= c.nr_seq_vendedor_canal
					and	dt_referencia_w between coalesce(x.dt_inicio_vigencia, dt_referencia_w) and coalesce(x.dt_fim_vigencia, dt_referencia_w))
			and	(((ie_dt_ref_comissao_equipe_w = 'C') and (c.dt_contratacao between coalesce(dt_inicio_movimento_w, c.dt_contratacao) and coalesce(dt_fim_movimento_w, c.dt_contratacao))) or
				((ie_dt_ref_comissao_equipe_w = 'L') and (f.dt_liquidacao between coalesce(dt_inicio_movimento_w, f.dt_liquidacao) and coalesce(dt_fim_movimento_w, f.dt_liquidacao))))
			and	((CASE WHEN coalesce(e.cd_pf_estipulante::text, '') = '' THEN 'PJ'  ELSE 'PF' END  = ie_tipo_contrato_w) or (ie_tipo_contrato_w = 'A'))
			and	((coalesce(nr_seq_grupo_produto_w::text, '') = '') or (exists (	select	1
										from	pls_preco_produto z
										where	z.nr_seq_plano	= c.nr_seq_plano
										and	z.nr_seq_grupo	= nr_seq_grupo_produto_w)))
			and	((c.nr_seq_plano = nr_seq_plano_meta_w) or (coalesce(nr_seq_plano_meta_w::text, '') = ''))
			and	((pls_obter_se_item_lista(ie_acao_contrato_meta_w,c.ie_acao_contrato) = 'S') or (coalesce(ie_acao_contrato_meta_w::text, '') = ''))
			and	((coalesce(f.dt_liquidacao::text, '') = '') or (f.dt_liquidacao between coalesce(dt_liquidacao_ini_w, f.dt_liquidacao) and coalesce(dt_liquidacao_fim_w, f.dt_liquidacao)));
		else
			select	count(1)
			into STRICT	qt_vidas_w
			from	pls_mensalidade		a,
				pls_mensalidade_segurado b,
				pls_segurado		c,
				pls_plano		d,
				pls_contrato		e,
				titulo_receber		f
			where	a.nr_sequencia		= b.nr_seq_mensalidade
			and	c.nr_sequencia		= b.nr_seq_segurado
			and	d.nr_sequencia		= c.nr_seq_plano
			and	c.nr_seq_contrato	= e.nr_sequencia
			and	f.nr_seq_mensalidade	= a.nr_sequencia
			and	coalesce(a.ie_cancelamento::text, '') = ''
			and (f.ie_situacao	= '2' or ie_comissao_equipe_tit_abert_w = 'S')
			and	c.nr_seq_vendedor_canal = nr_seq_vendedor_p
			and	(((ie_dt_ref_comissao_equipe_w = 'C') and (c.dt_contratacao between coalesce(dt_inicio_movimento_w, c.dt_contratacao) and coalesce(dt_fim_movimento_w, c.dt_contratacao))) or
				((ie_dt_ref_comissao_equipe_w = 'L') and (f.dt_liquidacao between coalesce(dt_inicio_movimento_w, f.dt_liquidacao) and coalesce(dt_fim_movimento_w, f.dt_liquidacao))))
			and	((CASE WHEN coalesce(e.cd_pf_estipulante::text, '') = '' THEN 'PJ'  ELSE 'PF' END  = ie_tipo_contrato_w) or (ie_tipo_contrato_w = 'A'))
			and	((coalesce(nr_seq_grupo_produto_w::text, '') = '') or (exists (	SELECT	1
										from	pls_preco_produto z
										where	z.nr_seq_plano	= c.nr_seq_plano
										and	z.nr_seq_grupo	= nr_seq_grupo_produto_w)))
			and	((c.nr_seq_plano = nr_seq_plano_meta_w) or (coalesce(nr_seq_plano_meta_w::text, '') = ''))
			and	((pls_obter_se_item_lista(ie_acao_contrato_meta_w,c.ie_acao_contrato) = 'S') or (coalesce(ie_acao_contrato_meta_w::text, '') = ''))
			and	((coalesce(f.dt_liquidacao::text, '') = '') or (f.dt_liquidacao between coalesce(dt_liquidacao_ini_w, f.dt_liquidacao) and coalesce(dt_liquidacao_fim_w, f.dt_liquidacao)));
		end if;


		qt_vidas_total_sca_w	:= 0;
		open C05;
		loop
		fetch C05 into
			nr_seq_sca_vidas_w;
		EXIT WHEN NOT FOUND; /* apply on C05 */
			begin
			if (ie_tipo_meta_w = 'E') then
				select	count(1)
				into STRICT	qt_vidas_sca_w
				from	pls_mensalidade_seg_item g,
					pls_mensalidade		a,
					pls_mensalidade_segurado b,
					pls_segurado		c,
					pls_plano		d,
					pls_contrato		e,
					titulo_receber		f,
					pls_sca_vinculo		h
				where	g.nr_seq_mensalidade_seg = b.nr_sequencia
				and	a.nr_sequencia		= b.nr_seq_mensalidade
				and	c.nr_sequencia		= b.nr_seq_segurado
				and	d.nr_sequencia		= c.nr_seq_plano
				and	c.nr_seq_contrato	= e.nr_sequencia
				and	f.nr_seq_mensalidade	= a.nr_sequencia
				and	g.nr_seq_vinculo_sca	= h.nr_sequencia
				and	coalesce(a.ie_cancelamento::text, '') = ''
				and	g.ie_tipo_item	= '15'
				and (f.ie_situacao	= '2' or ie_comissao_equipe_tit_abert_w = 'S')
				and	exists (SELECT	1
						from	pls_equipe_vend_vinculo	x
						where	x.nr_seq_equipe		= nr_seq_equipe_w
						and	x.nr_seq_vendedor	= c.nr_seq_vendedor_canal
						and	dt_referencia_w between coalesce(x.dt_inicio_vigencia, dt_referencia_w) and coalesce(x.dt_fim_vigencia, dt_referencia_w))
				and	(((ie_dt_ref_comissao_equipe_w = 'C') and (c.dt_contratacao between coalesce(dt_inicio_movimento_w, c.dt_contratacao) and coalesce(dt_fim_movimento_w, c.dt_contratacao))) or
					((ie_dt_ref_comissao_equipe_w = 'L') and (f.dt_liquidacao between coalesce(dt_inicio_movimento_w, f.dt_liquidacao) and coalesce(dt_fim_movimento_w, f.dt_liquidacao))))
				and	((CASE WHEN coalesce(e.cd_pf_estipulante::text, '') = '' THEN 'PJ'  ELSE 'PF' END  = ie_tipo_contrato_w) or (ie_tipo_contrato_w = 'A'))
				and	h.nr_seq_plano	= nr_seq_sca_vidas_w
				and	((coalesce(f.dt_liquidacao::text, '') = '') or (f.dt_liquidacao between coalesce(dt_liquidacao_ini_w, f.dt_liquidacao) and coalesce(dt_liquidacao_fim_w, f.dt_liquidacao)));
			else
				select	count(1)
				into STRICT	qt_vidas_sca_w
				from	pls_mensalidade_seg_item g,
					pls_mensalidade		a,
					pls_mensalidade_segurado b,
					pls_segurado		c,
					pls_plano		d,
					pls_contrato		e,
					titulo_receber		f,
					pls_sca_vinculo		h
				where	g.nr_seq_mensalidade_seg = b.nr_sequencia
				and	a.nr_sequencia		= b.nr_seq_mensalidade
				and	c.nr_sequencia		= b.nr_seq_segurado
				and	d.nr_sequencia		= c.nr_seq_plano
				and	c.nr_seq_contrato	= e.nr_sequencia
				and	f.nr_seq_mensalidade	= a.nr_sequencia
				and	g.nr_seq_vinculo_sca	= h.nr_sequencia
				and	coalesce(a.ie_cancelamento::text, '') = ''
				and	g.ie_tipo_item	= '15'
				and (f.ie_situacao	= '2' or ie_comissao_equipe_tit_abert_w = 'S')
				and	c.nr_seq_vendedor_canal = nr_seq_vendedor_p
				and	(((ie_dt_ref_comissao_equipe_w = 'C') and (c.dt_contratacao between coalesce(dt_inicio_movimento_w, c.dt_contratacao) and coalesce(dt_fim_movimento_w, c.dt_contratacao))) or
					((ie_dt_ref_comissao_equipe_w = 'L') and (f.dt_liquidacao between coalesce(dt_inicio_movimento_w, f.dt_liquidacao) and coalesce(dt_fim_movimento_w, f.dt_liquidacao))))
				and	((CASE WHEN coalesce(e.cd_pf_estipulante::text, '') = '' THEN 'PJ'  ELSE 'PF' END  = ie_tipo_contrato_w) or (ie_tipo_contrato_w = 'A'))
				and	h.nr_seq_plano	= nr_seq_sca_vidas_w
				and	((coalesce(f.dt_liquidacao::text, '') = '') or (f.dt_liquidacao between coalesce(dt_liquidacao_ini_w, f.dt_liquidacao) and coalesce(dt_liquidacao_fim_w, f.dt_liquidacao)));
			end if;

			qt_vidas_total_sca_w	:= coalesce(qt_vidas_total_sca_w,0) + coalesce(qt_vidas_sca_w,0);
			end;
		end loop;
		close C05;

		if (coalesce(qt_vidas_total_sca_w,0) <> 0) then
			qt_vidas_w	:= qt_vidas_total_sca_w;
		end if;

		begin
		pr_meta_w := ((100 * qt_vidas_w) / qt_meta_w);
		exception
		when others then
			pr_meta_w := 100;
		end;

		if (pr_meta_w > 100) then
			pr_meta_w := 100;
		end if;

		insert	into	pls_repasse_item_lote(	nr_sequencia, nr_seq_repasse, dt_atualizacao,
				nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
				qt_vidas, qt_meta, pr_meta,
				ie_tipo_contrato, nr_seq_equipe_vend_meta)
			values (	nextval('pls_repasse_item_lote_seq'), nr_seq_repasse_vend_p, clock_timestamp(),
				nm_usuario_p, clock_timestamp(), nm_usuario_p,
				qt_vidas_w, qt_meta_w, pr_meta_w,
				ie_tipo_contrato_w, nr_seq_meta_equipe_w);

		select	max(a.nr_sequencia)
		into STRICT	nr_seq_meta_atingir_w
		from	pls_equipe_meta_atingir	a,
			pls_equipe_vend_meta	b
		where	a.nr_seq_meta_equipe	= b.nr_sequencia
		and	b.nr_sequencia		= nr_seq_meta_equipe_w
		and	pr_meta_w between coalesce(pr_meta_minimo,pr_meta_w) and coalesce(pr_meta_maximo,pr_meta_w);

		if (coalesce(nr_seq_meta_atingir_w,0) <> 0) then
			open C02;
			loop
			fetch C02 into
				ie_sca_embutido_w,
				nr_seq_contrato_w,
				nr_seq_mensalidade_seg_w,
				nr_parcela_w,
				nr_parcela_contrato_w,
				ie_acao_contrato_w,
				ie_tipo_pessoa_w,
				ie_preco_w,
				nr_seq_segurado_w,
				qt_idade_w,
				nr_seq_plano_w,
				nr_seq_item_mens_w,
				ie_tipo_item_w,
				nr_seq_sca_w,
				vl_item_w,
				dt_mesano_referencia_w,
				nr_seq_portabilidade_w,
				nr_seq_motivo_inclusao_w,
				nr_seq_tipo_comissao_w,
				nr_seq_vendedor_canal_w,
				vl_pro_rata_dia_w,
				dt_contratacao_w,
				nr_titulo_w,
				ie_situacao_titulo_w,
				dt_contrato_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin

				nr_seq_regra_meta_w	:= null;
				nr_seq_repasse_w	:= null;
				qt_regra_repasse_sup_w	:= 0;

				begin
				select	nr_seq_cargo_canal
				into STRICT	nr_seq_cargo_canal_inf_w
				from	pls_equipe_vend_vinculo	a
				where	a.nr_seq_vendedor = nr_seq_vendedor_canal_w
				and	nr_seq_equipe = nr_seq_equipe_w
				and	dt_referencia_w between coalesce(a.dt_inicio_vigencia, dt_referencia_w) and coalesce(a.dt_fim_vigencia, dt_referencia_w);
				exception
				when others then
					nr_seq_cargo_canal_inf_w := null;
				end;

				if (nr_seq_cargo_canal_inf_w IS NOT NULL AND nr_seq_cargo_canal_inf_w::text <> '') then
					select 	count(1)
					into STRICT	qt_regra_repasse_sup_w
					from	pls_regra_repasse_superior	a
					where	nr_seq_cargo_canal_venda 	= nr_seq_cargo_canal_inf_w
					and	nr_seq_cargo_canal_repasse 	= nr_seq_cargo_canal_w
					and	nr_seq_equipe 			= nr_seq_equipe_w
					and	ie_situacao = 'A';
				end if;

				select	coalesce(sum(vl_recebido),0)
				into STRICT	vl_recebido_w
				from	titulo_receber_liq
				where	nr_titulo = nr_titulo_w;

				if (qt_regra_repasse_sup_w = 0) and
					((vl_recebido_w > 0 and ie_situacao_titulo_w = '2') or (ie_comissao_equipe_tit_abert_w = 'S'))  then
					if	((pls_obter_se_item_lista(ie_acao_contrato_meta_w,ie_acao_contrato_w) = 'S') or (coalesce(ie_acao_contrato_meta_w::text, '') = '')) then

						/* Esta contagem precisa ser realizada para quando são geradas comissões para os canais de vendas superiores, ou seja,
						     mesmo que já tenha sido comissionado o beneficiário X para o canal de vendas inferior, este mesmo beneficiário com a mesma parcela
						     precisará ser comissionado novamente para o canal de vendas superior  - por isso a restrição pelo canal de vendas. */
						select	count(1)
						into STRICT	qt_reg_mens_w
						from	pls_repasse_mens	a,
							pls_repasse_vend	b
						where	a.nr_seq_repasse	= b.nr_sequencia
						and	a.nr_seq_mens_seg	= nr_seq_mensalidade_seg_w
						and	b.nr_sequencia		<> nr_seq_repasse_vend_p
						and	b.ie_status 		<> 'C'
						and	b.nr_seq_vendedor 	= nr_seq_vendedor_p;

						if (qt_reg_mens_w = 0) then
							/* Esta contagem precisa ser realizada para que caso um canal de vendas encerre o contrato com a operadora e seja necessário alterar o canal de vendas do beneficiário para
							     um outro que venha a assumir todas as vendas do canal que terminou o contrato, caso já tenha sido gerado o repasse para o canal X (cujo contrato fora encerrado), e o canal
							     de de vendas do beneficiário tenha sido alterado para Y (que iria assumir as vendas do X), ao gerar o repasse para o canal Y, do mesmo mês que o gerado para o X,
							     tal beneficiário não poderá mais ser gerado porque já foi gerado no canal X. (OS 703675 - sideker - histórico 12/12/2014 15:44:17) */
							select	count(1)
							into STRICT	qt_reg_mens_w
							from	pls_repasse_mens	a,
								pls_repasse_vend	b
							where	a.nr_seq_repasse	= b.nr_sequencia
							and	a.nr_seq_mens_seg	= nr_seq_mensalidade_seg_w
							and	b.nr_sequencia		<> nr_seq_repasse_vend_p
							and	b.ie_status 		<> 'C'
							and	b.nr_seq_vendedor 	<> nr_seq_vendedor_canal_w
							and	a.nr_seq_contrato	<> nr_seq_contrato_w;
						end if;

						if (qt_reg_mens_w = 0)  then
							select	max(a.nr_sequencia)
							into STRICT	nr_seq_repasse_w
							from	pls_repasse_mens	a,
								pls_repasse_vend	b
							where	a.nr_seq_repasse	= b.nr_sequencia
							and	a.nr_seq_mens_seg	= nr_seq_mensalidade_seg_w
							and	b.nr_sequencia		= nr_seq_repasse_vend_p
							and	b.ie_status <> 'C';

							if (coalesce(nr_seq_repasse_w,0) = 0) then
								select	nextval('pls_repasse_mens_seq')
								into STRICT	nr_seq_repasse_w
								;

								insert	into	pls_repasse_mens(	nr_sequencia,
										dt_atualizacao,
										nm_usuario,
										dt_atualizacao_nrec,
										nm_usuario_nrec,
										nr_seq_vendedor,
										nr_seq_repasse,
										nr_seq_mens_seg,
										vl_repasse,
										vl_origem,
										ie_status,
										pr_comissao,
										ie_acao_contrato,
										nr_seq_segurado,
										nr_seq_plano,
										nr_seq_plano_sca,
										nr_parcela_benef,
										ie_comissao_repasse)
									values (	nr_seq_repasse_w,
										clock_timestamp(),
										nm_usuario_p,
										clock_timestamp(),
										nm_usuario_p,
										nr_seq_vendedor_p,
										nr_seq_repasse_vend_p,
										nr_seq_mensalidade_seg_w,
										0,
										0,
										'A',
										0,
										ie_acao_contrato_w,
										nr_seq_segurado_w,
										nr_seq_plano_w,
										nr_seq_sca_w,
										nr_parcela_w,
										'N');

								/*aaschlote 17/10/2011 - Atualizar os campos na tabela*/

								CALL pls_atual_campos_repasse_mens(nr_seq_repasse_w,nm_usuario_p);
							end if;
						end if;

						open C03;
						loop
						fetch C03 into
							nr_seq_regra_meta_w,
							pr_comissao_w,
							vl_comissao_w,
							ie_vl_integral_1_parcela_w;
						EXIT WHEN NOT FOUND; /* apply on C03 */
						end loop;
						close C03;

						if	((nr_parcela_w = 1) and (coalesce(ie_vl_integral_1_parcela_w,'N') = 'S')) then
							if (ie_sca_embutido_w = 'N') then
								if (ie_tipo_item_w in ('1','12')) then
									begin
									select (vl_preco_atual - vl_desconto)
									into STRICT	vl_item_w
									from	pls_segurado_preco
									where	nr_sequencia = (SELECT	max(nr_sequencia)
												from	pls_segurado_preco
												where	nr_seq_segurado		= nr_seq_segurado_w
												and	cd_motivo_reajuste in ('C','M'));
									exception
									when others then
										vl_item_w	:= 0;
									end;

									/*select	sum(b.vl_parcela)
									into	vl_sca_embutido_w
									from	pls_mensalidade_seg_item	a,
										pls_mensalidade_sca		b
									where	b.nr_seq_item_mens	= a.nr_sequencia
									and	a.nr_sequencia	= nr_seq_item_mens_w;

									vl_item_w	:= nvl(vl_sca_embutido_w,0) + nvl(vl_item_w,0);*/
								elsif (ie_tipo_item_w = '15') then
									begin
									select	b.vl_preco_atual
									into STRICT	vl_item_w
									from	pls_mensalidade_seg_item	a,
										pls_segurado_preco_origem	b
									where	a.nr_seq_seg_preco_origem	= b.nr_sequencia
									and	a.nr_sequencia			= nr_seq_item_mens_w;
									exception
									when others then
										vl_item_w	:= 0;
									end;
								end if;
							elsif (ie_sca_embutido_w = 'S') then
								select	max(nr_sequencia)
								into STRICT	nr_seq_segurado_preco_origem_w
								from	pls_segurado_preco_origem
								where	nr_seq_segurado = nr_seq_segurado_w
								and	nr_seq_plano	= nr_seq_sca_w
								and	(dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
								and	(((dt_mesano_referencia_w >= trunc(dt_reajuste, 'month')) and (cd_motivo_reajuste	<> 'E'))
									or	((cd_motivo_reajuste	= 'E') and (dt_mesano_referencia_w >= trunc(add_months(dt_reajuste,1), 'month'))));

								select	max(vl_preco_atual)
								into STRICT	vl_item_w
								from	pls_segurado_preco_origem
								where	nr_sequencia	= nr_seq_segurado_preco_origem_w;
							end if;
						end if;

						if (coalesce(nr_seq_regra_meta_w,0) <> 0) then
							if (ie_gerar_juro_mult_tit_w = 'S') then
								vl_juros_multa_w := pls_obter_vl_juros_mult_titulo(nr_titulo_w);
							end if;

							vl_comissao_venda_w	:= round(coalesce(((pr_comissao_w * coalesce(vl_item_w,0)) / 100),0) + vl_comissao_w,2);
							vl_origem_w 		:= vl_comissao_venda_w;

							if (vl_juros_multa_w > 0) then
								vl_comissao_venda_w := 0;
							end if;

							select	count(1)
							into STRICT	qt_repasse_gerado_w
							from	pls_repasse_mens a,
								pls_repasse_vend b
							where	a.nr_seq_repasse	= b.nr_sequencia
							and	a.nr_seq_mens_seg	= nr_seq_mensalidade_seg_w
							and	b.ie_tipo_repasse	= 'N'
							and	b.ie_status 		<> 'C'
							and	b.nr_seq_vendedor	= nr_seq_vendedor_p;

							if (qt_repasse_gerado_w = 0) then
								select	count(1)
								into STRICT	qt_repasse_gerado_w
								from	pls_repasse_mens a,
									pls_repasse_vend b
								where	a.nr_seq_repasse	= b.nr_sequencia
								and	a.nr_seq_mens_seg	= nr_seq_mensalidade_seg_w
								and	b.ie_tipo_repasse	= 'N'
								and	b.ie_status 		<> 'C'
								and	b.nr_seq_vendedor 	<> nr_seq_vendedor_canal_w; -- (OS 703675 - sideker - histórico 12/12/2014 15:44:17)
							end if;

							select	count(1)
							into STRICT	qt_item_seg_gerado_w
							from	pls_repasse_mens_item	c,
								pls_repasse_mens	b,
								pls_repasse_vend	a
							where	b.nr_sequencia 	= c.nr_seq_repasse
							and	a.nr_sequencia 	= b.nr_seq_repasse
							and	a.nr_sequencia	= nr_seq_repasse_vend_p
							and	b.nr_seq_mens_seg = nr_seq_mensalidade_seg_w
							and	c.nr_seq_mensalidade_seg_item = nr_seq_item_mens_w
							and	a.ie_status <> 'C';

							/* Obs: a variável vl_comissao_venda_w não pode ser restringida para serem gerados somente os itens cujo valor é maior que zero porque existe os casos de
							     itens de bonificação em que os valores são negativos e mesmo assim devem ser apresentados no comissionamento. */
							if (vl_comissao_venda_w <> 0 or vl_origem_w <> 0) and (qt_repasse_gerado_w = 0) and (qt_item_seg_gerado_w = 0) and (nr_seq_repasse_w IS NOT NULL AND nr_seq_repasse_w::text <> '') then

								insert	into	pls_repasse_mens_item(	nr_sequencia, nr_seq_repasse, ie_tipo_item,
										dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
										pr_repasse, vl_repasse, vl_origem, nr_seq_mensalidade_seg_item,
										nr_seq_plano_sca, vl_item, ie_sca_embutido, nr_seq_regra_equipe,
										vl_incremento)
									values (	nextval('pls_repasse_mens_item_seq'), nr_seq_repasse_w, ie_tipo_item_w,
										clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p,
										pr_comissao_w, vl_comissao_venda_w, vl_origem_w, nr_seq_item_mens_w,
										nr_seq_sca_w, vl_item_w, ie_sca_embutido_w, nr_seq_regra_meta_w,
										vl_comissao_w);
							end if;
						end if;
					end if;
				end if;
				end;
			end loop;
			close C02;
		end if;
		end;
	end loop;
	close C01;

	--Gerar o repasse de comissão para vendas realizadas pelos canais de venda inferiores
	CALL pls_gerar_comissao_repasse(nr_seq_repasse_vend_p, nr_seq_equipe_w, nm_usuario_p);

	if (ie_gerar_juro_mult_tit_w = 'S') then
		CALL pls_acrescentar_juros_multa(nr_seq_repasse_vend_p, null, 'RE', nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);
	end if;

	open C04;
	loop
	fetch C04 into
		nr_seq_repasse_total_w;
	EXIT WHEN NOT FOUND; /* apply on C04 */
		begin
		select	sum(vl_item),
			sum(vl_repasse),
			sum(vl_origem)
		into STRICT	vl_total_itens_w,
			vl_repasse_total_w,
			vl_origem_total_w
		from	pls_repasse_mens_item
		where	nr_seq_repasse	= nr_seq_repasse_total_w;

		update	pls_repasse_mens
		set	vl_repasse	= coalesce(vl_repasse_total_w,0),
			vl_origem	= coalesce(vl_origem_total_w,0),
			vl_item_comissao = coalesce(vl_total_itens_w,0)
		where	nr_sequencia	= nr_seq_repasse_total_w;
		end;
	end loop;
	close C04;

	delete	from	pls_repasse_mens a
	where	a.nr_seq_repasse = nr_seq_repasse_vend_p
	and	a.vl_repasse = 0
	and	a.vl_origem = 0
	and	not exists (	SELECT 	1
				from 	pls_repasse_mens_item x
				where	x.nr_seq_repasse = a.nr_sequencia);

	select	count(1)
	into STRICT	qt_tot_vidas_w
	from	pls_repasse_mens
	where	nr_seq_repasse	= nr_seq_repasse_vend_p;

	if (qt_tot_vidas_w > 0) then
		update	pls_repasse_vend
		set	ds_inf_geracao	= 'Qt. vidas = ' || to_char(qt_tot_vidas_w) || ' - %meta = ' || pr_meta_w || ' ',
			qt_vidas	= qt_tot_vidas_w
		where	nr_sequencia	= nr_seq_repasse_vend_p;
	end if;
end if;

--commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_comissao_equipe ( nr_seq_repasse_vend_p bigint, nr_seq_vendedor_p bigint, ie_acao_p text, nm_usuario_p text) FROM PUBLIC;

