-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE generate_dvy_request_data ( nr_interno_conta_p bigint, --account number patient billing
 cd_estabelecimento_p bigint, nm_usuario_p text, cd_error_string_p INOUT text) AS $body$
DECLARE

nr_seq_dvy_w		dva_claim.nr_sequencia%type;
cd_payee_provider_w	dva_claim.cd_payee_provider%type;
cd_claim_w		dva_claim.cd_claim%type;
dt_claim_w		dva_claim.dt_certified%type;
nr_seq_transaction_w    dva_claim.nr_seq_transaction%type;
nr_seq_history_claim_w  ECLIPSE_CLAIM_HISTORY.NR_SEQUENCIA %type;
request_sts		varchar(500);


BEGIN

select	nextval('dvy_request_seq') 
into STRICT	nr_seq_dvy_w 
;

select	max(a.cd_payee_provider)	payee_provider_val,
	max(a.cd_claim)	claim_val,
	max(a.nr_seq_transaction)	transaction_id,
	max(a.dt_atualizacao)	claim_data
into STRICT	cd_payee_provider_w,
	cd_claim_w,
	nr_seq_transaction_w,
	dt_claim_w 
from	dva_claim a
where	a.nr_sequencia =( SELECT max(x.nr_sequencia)
                         from dva_claim x 
                         where x.nr_interno_conta = nr_interno_conta_p);

if (coalesce(cd_payee_provider_w::text, '') = '' ) then
	CALL GENERATE_INCO_ECLIPSE(nr_interno_conta_p, 1, obter_desc_expressao(1104644), nm_usuario_p);
end if;


if (coalesce(cd_claim_w::text, '') = '' ) then
	CALL GENERATE_INCO_ECLIPSE(nr_interno_conta_p, 1, obter_desc_expressao(1104650), nm_usuario_p);
end if;

if (coalesce(dt_claim_w::text, '') = '' ) then
	CALL GENERATE_INCO_ECLIPSE(nr_interno_conta_p, 1, obter_desc_expressao(1104651), nm_usuario_p);
end if;

if (coalesce(cd_error_string_p::text, '') = '') then
	begin
	
	insert	into dvy_request(nr_sequencia ,
			dt_atualizacao ,
			nm_usuario ,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_payee_provider,
			cd_claim,
			dt_claim,
			nr_seq_transaction)
	values (nr_seq_dvy_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			cd_payee_provider_w,
			cd_claim_w,
			dt_claim_w,
			nr_seq_transaction_w);
	
	select	nextval('eclipse_claim_history_seq')
	into STRICT	nr_seq_history_claim_w 
	;
	
	insert	into	eclipse_claim_history(	
			nr_sequencia,
			nm_usuario	,
			dt_atualizacao 	,
			ds_historico	, 
			nr_interno_conta
		)
	values (	
			nr_seq_history_claim_w,
			nm_usuario_p,
			clock_timestamp(),
			wheb_mensagem_pck.get_texto(1105898) , 
			nr_interno_conta_p
		);
	commit;	
	request_sts :=	'{' || chr(10) ||'"transactionId":"' || nr_seq_transaction_w
			||'",'|| chr(10) || '"userName":"' ||nm_usuario_p|| '"}';
	CALL EXECUTE_BIFROST_INTEGRATION(190, request_sts);
	commit;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE generate_dvy_request_data ( nr_interno_conta_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text, cd_error_string_p INOUT text) FROM PUBLIC;

