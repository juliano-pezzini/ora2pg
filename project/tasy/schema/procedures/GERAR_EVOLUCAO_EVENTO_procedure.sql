-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_evolucao_evento ( nr_sequencia_p bigint, ie_tipo_evolucao_p text, cd_pessoa_fisica_p text, nm_usuario_p text) AS $body$
DECLARE


ds_disposicao_imediata_w		varchar(10000);
ds_enter_w				varchar(10) := ' \par ';
ds_evolucao_w			varchar(32000);
ds_evento_w				varchar(10000);
cd_evolucao_w			bigint;
ds_tipo_evento_w		varchar(255);
ds_classificacao_w		varchar(80);
ds_outras_inf_w			varchar(435);
ie_tipo_evolucao_w		varchar(255)	:= ie_tipo_evolucao_p;


BEGIN


if (coalesce(ie_tipo_evolucao_w::text, '') = '') then
	select	max(ie_tipo_evolucao)
	into STRICT	ie_tipo_evolucao_w
	from	usuario
	where	nm_usuario	= nm_usuario_p;
end if;


if (ie_tipo_evolucao_w IS NOT NULL AND ie_tipo_evolucao_w::text <> '') then
	begin
	

	select	max(a.ds_disposicao_imediata),
			max(b.ds_evento),
			max(c.ds_classificacao)
	into STRICT	ds_disposicao_imediata_w,
			ds_tipo_evento_w,
			ds_classificacao_w			
	FROM qua_evento_paciente a
LEFT OUTER JOIN qua_evento b ON (a.nr_seq_evento = b.nr_sequencia)
LEFT OUTER JOIN qua_evento_classif c ON (a.nr_seq_classif_evento = c.nr_sequencia)
WHERE a.nr_sequencia	= nr_sequencia_p;
		
		
	if ((trim(both ds_tipo_evento_w) IS NOT NULL AND (trim(both ds_tipo_evento_w))::text <> '')) then
		ds_outras_inf_w := ds_enter_w || wheb_mensagem_pck.get_texto(300128) || ': ' || ds_tipo_evento_w;
	end if;
	
	if ((trim(both ds_classificacao_w) IS NOT NULL AND (trim(both ds_classificacao_w))::text <> '')) then
		ds_outras_inf_w := ds_outras_inf_w|| ds_enter_w || wheb_mensagem_pck.get_texto(306009) || ' ' || ds_classificacao_w;
	end if;
	
	if ((trim(both ds_disposicao_imediata_w) IS NOT NULL AND (trim(both ds_disposicao_imediata_w))::text <> '')) then
		ds_disposicao_imediata_w := ds_enter_w || wheb_mensagem_pck.get_texto(341121) || ': ' || ds_disposicao_imediata_w;
	end if;
	
	
	select	max(ds_evento)
	into STRICT	ds_evento_w
	from	qua_evento_paciente
	where	nr_sequencia	= nr_sequencia_p;	
	
	ds_evolucao_w	:= wheb_rtf_pck.GET_CABECALHO;	
	ds_evolucao_w	:= substr(ds_evolucao_w||ds_outras_inf_w||ds_enter_w||ds_evento_w||ds_enter_w||ds_disposicao_imediata_w,1,32000);
	ds_evolucao_w	:= ds_evolucao_w||wheb_rtf_pck.get_rodape;	
	
	select	nextval('evolucao_paciente_seq')	
	into STRICT	cd_evolucao_w
	;
	
	Insert into evolucao_paciente(
		cd_evolucao,
		dt_evolucao,
		ie_tipo_evolucao,
		cd_pessoa_fisica,
		dt_atualizacao,
		nm_usuario,
		nr_atendimento,
		ds_evolucao,
		cd_medico,
		dt_liberacao,
		ie_evolucao_clinica,
		cd_setor_atendimento,
		cd_especialidade,
		cd_medico_parecer,
		ie_recem_nato,
		ie_situacao,
        nm_usuario_nrec,
        dt_atualizacao_nrec)
	SELECT	cd_evolucao_w,
		dt_evento,
		ie_tipo_evolucao_w,
		obter_pessoa_atendimento(nr_atendimento,'C'),
		clock_timestamp(),
		nm_usuario_p,
		nr_atendimento,
		' ',
		cd_pessoa_fisica_p,
		null,
		'E',
		obter_setor_atendimento(nr_atendimento),
		null,
		null,
		'N',
		'A',
        nm_usuario_p,
        clock_timestamp()
	from	qua_evento_paciente
	where	nr_sequencia	= nr_sequencia_p;
	
	
	update	evolucao_paciente
	set	ds_evolucao = ds_evolucao_w
	where	cd_evolucao = cd_evolucao_w;
	
	end;
else
	CALL wheb_mensagem_pck.exibir_mensagem_abort(247982);
end if;

commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_evolucao_evento ( nr_sequencia_p bigint, ie_tipo_evolucao_p text, cd_pessoa_fisica_p text, nm_usuario_p text) FROM PUBLIC;

