-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_ordem_servico_web ( nr_sequencia_p INOUT bigint, cd_pessoa_solicitante_p text, nr_seq_localizacao_p bigint, nr_seq_equipamento_p bigint, ds_dano_breve_p text, ds_dano_p text, cd_funcao_p bigint, ie_classificacao_p text, ie_forma_receb_p text, dt_inicio_previsto_p timestamp, dt_fim_previsto_p timestamp, nr_seq_estagio_p bigint, ie_tipo_ordem_p text, nr_grupo_planej_p bigint, nr_grupo_trabalho_p bigint, ie_prioridade_p text, ie_status_ordem_p text, nm_usuario_p text, nr_seq_proj_cron_etapa_p bigint, nr_seq_tre_agenda_p bigint, ie_origem_os_p text, ds_contato_solicitante_p text default '', cd_setor_atendimento_p bigint default null, nr_seq_prot_os_p bigint default null) AS $body$
DECLARE


nr_sequencia_w			bigint;
nm_usuario_exec_w		varchar(15);
qt_existe_w			bigint;
nr_seq_equipamento_w		bigint;
nr_seq_equipamento_ww		bigint;
nr_grupo_planej_w		bigint;
nr_grupo_trabalho_w		bigint;
nr_seq_estagio_w		bigint;
ie_solic_vip_w 			man_ordem_servico.ie_solic_vip%type;
qt_minuto_fim_w			man_regra_usuario_vip.qt_minuto_fim%type;
dt_fim_previsto_w		man_ordem_servico.dt_fim_previsto%type;
dt_ordem_servico_w		man_ordem_servico.dt_ordem_servico%type;
nr_seq_localizacao_w		man_ordem_servico.nr_seq_localizacao%type;
nr_seq_estagio_prot_w		bigint;
ie_situacao_os_w		man_ordem_servico.ie_status_ordem%type;
nm_user_w			varchar(50);
nr_seq_grupo_des_w		grupo_desenvolvimento.nr_sequencia%type;
nr_seq_cliente_w		man_ordem_servico.nr_seq_cliente%type;

c01 CURSOR FOR
SELECT	nm_usuario_exec
from	man_equip_usuario_exec
where	nr_seq_equipamento 				= nr_seq_equipamento_w
and	coalesce(nr_seq_grupo_trabalho,coalesce(nr_grupo_trabalho_p,0)) 	= coalesce(nr_grupo_trabalho_p,0)
and	coalesce(nr_seq_grupo_planej,coalesce(nr_grupo_planej_p,0)) 	= coalesce(nr_grupo_planej_p,0);


BEGIN

select	nextval('man_ordem_servico_seq')
into STRICT	nr_sequencia_w
;

select	username
into STRICT	nm_user_w
from	user_users;

nr_sequencia_p := nr_sequencia_w;

select	coalesce(max(a.nr_sequencia),0),
	coalesce(max(nr_seq_planej),0),
	coalesce(max(nr_seq_trab),0)   	
into STRICT	nr_seq_equipamento_w,
	nr_grupo_planej_w,
	nr_grupo_trabalho_w
from	man_equipamento a
where	a.nr_seq_local = nr_seq_localizacao_p
and	a.nr_sequencia = (	SELECT	max(nr_sequencia)
			from	man_equipamento b
			where	a.nr_seq_local = b.nr_seq_local);
			
nr_seq_equipamento_ww	:= Obter_Valor_Param_Usuario(9043,13,obter_perfil_ativo,nm_usuario_p,wheb_usuario_pck.get_cd_estabelecimento);

if (coalesce(nr_seq_equipamento_ww,0) > 0) then
	nr_seq_equipamento_w := nr_seq_equipamento_ww;
end if;

if (coalesce(nr_seq_prot_os_p,0) > 0) then
	select	coalesce(nr_seq_equipamento, nr_seq_equipamento_w),
		coalesce(nr_seq_grupo_planej, nr_grupo_planej_w),
		coalesce(nr_seq_grupo_trab, nr_grupo_trabalho_w),
		nr_seq_localizacao,
		nr_seq_estagio
	into STRICT	nr_seq_equipamento_w,
		nr_grupo_planej_w,
		nr_grupo_trabalho_w,
		nr_seq_localizacao_w,
		nr_seq_estagio_prot_w
	from	man_protocolo_os
	where	nr_sequencia = nr_seq_prot_os_p;
	
	if (coalesce(nr_seq_estagio_prot_w,0) > 0) then
		select	ie_situacao_os
		into STRICT	ie_situacao_os_w
		from	man_estagio_processo
		where	nr_sequencia = nr_seq_estagio_prot_w;
	end if;
end if;

if (coalesce(nr_seq_equipamento_w,0) = 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(244099);
end if;

select	coalesce(coalesce(ie_situacao_os_w, ie_status_ordem_p),'1')
into STRICT	ie_situacao_os_w
;

select	coalesce(nr_seq_estagio_prot_w, coalesce(nr_seq_estagio_inicio_os,nr_seq_estagio_p))
into STRICT	nr_seq_estagio_w
from	man_equipamento
where	nr_sequencia = nr_seq_equipamento_w;

select  coalesce(max(c.nr_sequencia),0)
into STRICT    nr_seq_cliente_w
from    com_cliente c,
	man_localizacao l
where   c.cd_cnpj = l.cd_cnpj
and     c.ie_classificacao = 'C'
and     l.nr_sequencia = nr_seq_localizacao_p;				
				       
ie_solic_vip_w		:= man_obter_se_ordem_servico_vip(cd_pessoa_solicitante_p,nr_grupo_planej_w,nr_grupo_trabalho_w,'S');
qt_minuto_fim_w		:= somente_numero(coalesce(man_obter_se_ordem_servico_vip(cd_pessoa_solicitante_p,nr_grupo_planej_w,nr_grupo_trabalho_w,'Q'),'0'));

dt_fim_previsto_w		:= dt_fim_previsto_p;
dt_ordem_servico_w	:= clock_timestamp();

if (coalesce(qt_minuto_fim_w,0) > 0) then
	dt_fim_previsto_w	:= dt_ordem_servico_w + dividir(qt_minuto_fim_w,1440);
elsif (nm_user_w = 'CORP') then
	dt_fim_previsto_w	:= coalesce(dt_fim_previsto_w, clock_timestamp());

	select	max(a.nr_sequencia)
	into STRICT	nr_seq_grupo_des_w
	from	funcao_grupo_des	a,
		grupo_desenvolvimento	b
	where	b.nr_sequencia	= a.nr_seq_grupo
	and	a.cd_funcao	= cd_funcao_p;
	
	if (nr_seq_grupo_des_w IS NOT NULL AND nr_seq_grupo_des_w::text <> '') then --se possuir grupo busca a quantidades de dia do grupo
		select	dt_fim_previsto_w + coalesce(max(b.qt_dia_prev_os),30)
		into STRICT	dt_fim_previsto_w
		from	grupo_desenvolvimento	b
		where	b.nr_sequencia	= nr_seq_grupo_des_w;
	else
		dt_fim_previsto_w	:= dt_fim_previsto_w + 30;
	end if;
end if;

if (nm_user_w = 'CORP') and (coalesce(nr_seq_estagio_w,0) = 0) then
	nr_seq_estagio_w := 1051;

	if (ie_classificacao_p = 'D') then
		nr_seq_estagio_w := 231;
	end if;
end if;

insert	into man_ordem_servico(
	nr_sequencia,
	nr_seq_localizacao,
	nr_seq_equipamento,
	cd_pessoa_solicitante,
	dt_ordem_servico,
	ie_prioridade,
	ie_parado,
	ds_dano_breve,
	dt_atualizacao,
	nm_usuario,
	dt_inicio_desejado,
	dt_conclusao_desejada,
	ds_dano,
	dt_inicio_previsto,
	dt_fim_previsto,
	dt_inicio_real,
	dt_fim_real,
	ie_tipo_ordem,
	ie_status_ordem,
	nr_grupo_planej,
	nr_grupo_trabalho,
	nr_seq_tipo_solucao,
	ds_solucao,
	nm_usuario_exec,
	qt_contador,
	nr_seq_planej,
	nr_seq_tipo_contador,
	nr_seq_estagio,
	cd_projeto,
	nr_seq_etapa_proj,
	dt_reabertura,
	cd_funcao,
	nm_tabela,
	ie_classificacao,
	nr_seq_origem,
	nr_seq_projeto,
	ie_grau_satisfacao,
	nr_seq_indicador,
	nr_seq_causa_dano,
	ie_forma_receb,
	nr_seq_cliente,
	nr_seq_grupo_des,
	nr_seq_grupo_sup,
	nr_seq_superior,
	ie_eficacia,
	dt_prev_eficacia,
	cd_pf_eficacia,
	nr_seq_nao_conform,
	nr_seq_complex,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	ie_obriga_news,
	nr_seq_meta_pe,
	nr_seq_classif,
	nr_seq_nivel_valor,
	nm_usuario_lib_news,
	dt_libera_news,
	dt_envio_wheb,
	ds_contato_solicitante,
	ie_prioridade_desen,
	ie_prioridade_sup,
	nr_seq_proj_cron_etapa,
	nr_seq_tre_agenda,
	ie_origem_os,
	ie_prioridade_cliente,
	ie_classificacao_cliente,
	ie_solic_vip,
	cd_setor_atendimento)
values(	nr_sequencia_w,				-- nr_sequencia,
	coalesce(nr_seq_localizacao_w, nr_seq_localizacao_p),			-- nr_seq_localizacao,
	nr_seq_equipamento_w,			-- nr_seq_equipamento,
	cd_pessoa_solicitante_p,			-- cd_pessoa_solicitante,
	dt_ordem_servico_w,			-- dt_ordem_servico,
	ie_prioridade_p,				-- ie_prioridade,
	'N',					-- ie_parado,
	substr(ds_dano_breve_p,1,80),		-- ds_dano_breve,
	clock_timestamp(),					-- dt_atualizacao,
	nm_usuario_p,				-- nm_usuario,
	clock_timestamp(),					-- dt_inicio_desejado,
	(clock_timestamp() + interval '15 days'),				-- dt_conclusao_desejada,
	ds_dano_p,				-- ds_dano,
	coalesce(dt_inicio_previsto_p,clock_timestamp()),		-- dt_inicio_previsto,
	coalesce(dt_fim_previsto_w,clock_timestamp()),				-- dt_fim_previsto,
	clock_timestamp(),					-- dt_inicio_real,
	null,					-- dt_fim_real,
	coalesce(ie_tipo_ordem_p,'1'),			-- ie_tipo_ordem,
	coalesce(ie_situacao_os_w,'1'),			-- ie_status_ordem,
	nr_grupo_planej_w,				-- nr_grupo_planej,
	nr_grupo_trabalho_w,			-- nr_grupo_trabalho,
	null,					-- nr_seq_tipo_solucao,
	null,					-- ds_solucao,
	CASE WHEN ie_situacao_os_w='1' THEN null  ELSE nm_usuario_p END , -- nm_usuario_exec,
	null,					-- qt_contador,
	null,					-- nr_seq_planej,
	null,					-- nr_seq_tipo_contador,
	nr_seq_estagio_w,				-- nr_seq_estagio,
	null,					-- cd_projeto,
	null,					-- nr_seq_etapa_proj,
	null,					-- dt_reabertura,
	cd_funcao_p,				-- cd_funcao,
	null,					-- nm_tabela,
	ie_classificacao_p,				-- ie_classificacao,
	null,					-- nr_seq_origem,
	null,					-- nr_seq_projeto,
	null,					-- ie_grau_satisfacao,
	null,					-- nr_seq_indicador,
	null,					-- nr_seq_causa_dano,
	coalesce(ie_forma_receb_p,'W'),		-- ie_forma_receb,
	nr_seq_cliente_w,			-- nr_seq_cliente,
	null,					-- nr_seq_grupo_des,
	null,					-- nr_seq_grupo_sup,
	null,					-- nr_seq_superior,
	null,					-- ie_eficacia,
	null,					-- dt_prev_eficacia,
	null,					-- cd_pf_eficacia,
	null,					-- nr_seq_nao_conform,
	null,					-- nr_seq_complex,
	null,					-- dt_atualizacao_nrec,
	nm_usuario_p,				-- nm_usuario_nrec,
	null,					-- ie_obriga_news,
	null,					-- nr_seq_meta_pe,
	null,					-- nr_seq_classif,
	null,					-- nr_seq_nivel_valor,
	null,					-- nm_usuario_lib_news,
	null,					-- dt_libera_news,
	null,					-- dt_envio_wheb,
	ds_contato_solicitante_p,			-- ds_contato_solicitante,
	null,					-- ie_prioridade_desen,
	null,					-- ie_prioridade_sup
	nr_seq_proj_cron_etapa_p,			-- nr_seq_proj_cron_etapa
	nr_seq_tre_agenda_p,			--nr_seq_tre_agenda
	ie_origem_os_p,				--ie_origem_os
	ie_prioridade_p,				--ie_prioridade
	ie_classificacao_p,				--ie_classificacao
	ie_solic_vip_w,				--ie_solic_vip
	cd_setor_atendimento_p);			--cd_setor_atendimento		
	
	-- Disparar evento de nova ordem de servico criada
	CALL man_gerar_envio_comunicacao(nr_sequencia_w, '3', '', '', nm_usuario_p, '');
	
open C01;
loop
fetch C01 into	
	nm_usuario_exec_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	select 	count(*)
	into STRICT	qt_existe_w
	from	man_ordem_servico_exec
	where	nr_seq_ordem 	= nr_sequencia_w
	and	nm_usuario_exec	= nm_usuario_exec_w;
	
	if (qt_existe_w = 0) then
		insert into  man_ordem_servico_exec(
			nr_sequencia,
			nr_seq_ordem,
			dt_atualizacao,
			nm_usuario,
			nm_usuario_exec )
		values (	nextval('man_ordem_servico_exec_seq'),
			nr_sequencia_w,
			clock_timestamp(),
			nm_usuario_p,
			nm_usuario_exec_w);
	end if;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_ordem_servico_web ( nr_sequencia_p INOUT bigint, cd_pessoa_solicitante_p text, nr_seq_localizacao_p bigint, nr_seq_equipamento_p bigint, ds_dano_breve_p text, ds_dano_p text, cd_funcao_p bigint, ie_classificacao_p text, ie_forma_receb_p text, dt_inicio_previsto_p timestamp, dt_fim_previsto_p timestamp, nr_seq_estagio_p bigint, ie_tipo_ordem_p text, nr_grupo_planej_p bigint, nr_grupo_trabalho_p bigint, ie_prioridade_p text, ie_status_ordem_p text, nm_usuario_p text, nr_seq_proj_cron_etapa_p bigint, nr_seq_tre_agenda_p bigint, ie_origem_os_p text, ds_contato_solicitante_p text default '', cd_setor_atendimento_p bigint default null, nr_seq_prot_os_p bigint default null) FROM PUBLIC;

