-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inclusao_mat_req_oc ( nr_ordem_compra_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint ) AS $body$
DECLARE

													
nr_seq_requisicao_w           pls_requisicao.nr_sequencia%type;
cd_guia_w                     pls_guia_plano.cd_guia%type;
nr_item_w                     ordem_compra_item.nr_item_oci%type;
cd_material_w                 pls_requisicao_mat.cd_material%type;
vl_material_w                 pls_requisicao_mat.vl_material%type;
qt_material_w                 pls_requisicao_mat.qt_material%type;
cd_unidade_medida_compra_w    material.cd_unidade_medida_compra%type;

C01 CURSOR FOR
    SELECT req.nr_sequencia
    from   pls_requisicao req
    where  exists ( SELECT 1
                    from   pls_execucao_req_item eri,
                           pls_execucao_requisicao er,
                           pls_requisicao rq,
                           pls_guia_plano gp
                    where  eri.nr_seq_execucao = er.nr_sequencia
                    and    er.nr_seq_requisicao = rq.nr_sequencia
                    and    rq.nr_sequencia = req.nr_sequencia
                    and    eri.nr_seq_guia = gp.nr_sequencia
                    and    gp.cd_guia = cd_guia_w );

C02 CURSOR FOR
    SELECT rm.cd_material,
           rm.vl_material,
           rm.qt_material,
           m.cd_unidade_medida_compra
    from   pls_requisicao_mat rm,
           material m
    where  rm.nr_seq_requisicao = nr_seq_requisicao_w
    and    rm.qt_material > 0
    and    m.cd_material = rm.cd_material;
	

BEGIN

select max(gp.cd_guia)
into STRICT   cd_guia_w
from   ordem_compra oc,
       pls_guia_plano gp
where  oc.nr_seq_guia_plano = gp.nr_sequencia
and    oc.nr_ordem_compra = nr_ordem_compra_p;

open C01;
loop
fetch C01 into	
    nr_seq_requisicao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

    begin

    open C02;
    loop
    fetch C02 into	
        cd_material_w,
        vl_material_w,
        qt_material_w,
        cd_unidade_medida_compra_w;
    EXIT WHEN NOT FOUND; /* apply on C02 */
	
        begin
		
        select coalesce(max(nr_item_oci),0)+1
        into STRICT   nr_item_w
        from   ordem_compra_item
        where  nr_ordem_compra = nr_ordem_compra_p;

        insert into ordem_compra_item( nr_ordem_compra,
                                       nr_item_oci,
                                       cd_material,
                                       cd_unidade_medida_compra,
                                       vl_unitario_material,
                                       qt_material,
                                       dt_atualizacao,
                                       nm_usuario,
                                       ie_situacao )
                              values ( nr_ordem_compra_p,
                                       nr_item_w,
                                       cd_material_w,
                                       cd_unidade_medida_compra_w,
                                       vl_material_w,
                                       qt_material_w,
                                       clock_timestamp(),
                                       nm_usuario_p,
                                       'A');
									
        insert into ordem_compra_item_entrega( nr_ordem_compra,
                                               nr_item_oci,
                                               dt_prevista_entrega,
                                               qt_prevista_entrega,
                                               dt_atualizacao,
                                               nm_usuario,
                                               nr_sequencia )
                                       values ( nr_ordem_compra_p,
                                               nr_item_w,
                                               clock_timestamp(),
                                               qt_material_w,
                                               clock_timestamp(),
                                               nm_usuario_p,
                                               nextval('ordem_compra_item_entrega_seq'));

        end;

    end loop;
    close C02;

    end;

end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inclusao_mat_req_oc ( nr_ordem_compra_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint ) FROM PUBLIC;

