-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_analise_migr_area_proj ( nm_usuario_p text) AS $body$
DECLARE


nr_seq_grupo_desenv_w		bigint;
qt_projetos_w			bigint := 0;
qt_horas_previstas_w		double precision := 0;
qt_horas_realizadas_w		double precision := 0;
qt_horas_sentimento_w		double precision := 0;
qt_horas_saldo_w			double precision := 0;
pr_uso_tempo_previsto_w		double precision := 0;
qt_projetos_desenv_w		bigint := 0;
qt_projetos_desenv_tec_w		bigint := 0;
qt_projetos_teste_w			bigint := 0;
qt_projetos_concluidos_w		bigint := 0;
qt_os_projetos_w			bigint := 0;
qt_os_projetos_desenv_w		bigint := 0;
qt_os_projetos_tec_w		bigint := 0;
qt_os_projetos_teste_w		bigint := 0;
qt_os_projetos_concluidas_w		bigint := 0;
qt_projetos_pendentes_w		bigint := 0;
pr_realizacao_w			double precision := 0;

qt_projetos_ww			bigint := 0;
qt_horas_previstas_ww		double precision := 0;
qt_horas_realizadas_ww		double precision := 0;
qt_horas_sentimento_ww		double precision := 0;
qt_horas_saldo_ww			double precision := 0;
pr_uso_tempo_previsto_ww		double precision := 0;
qt_projetos_desenv_ww		bigint := 0;
qt_projetos_desenv_tec_ww		bigint := 0;
qt_projetos_teste_ww		bigint := 0;
qt_projetos_concluidos_ww		bigint := 0;
qt_os_projetos_ww			bigint := 0;
qt_os_projetos_desenv_ww		bigint := 0;
qt_os_projetos_tec_ww		bigint := 0;
qt_os_projetos_teste_ww		bigint := 0;
qt_os_projetos_concluidas_ww	bigint := 0;
qt_projetos_pendentes_ww		bigint := 0;
pr_realizacao_ww			double precision := 0;

nr_seq_area_proj_w		bigint;

c01 CURSOR FOR
SELECT	distinct p.nr_seq_grupo_des
from	proj_projeto p
where	p.nr_seq_gerencia = 9
and	p.nr_seq_classif = 14;

c02 CURSOR FOR
SELECT	distinct p.nr_seq_grupo
from	proj_projeto p
where	p.nr_seq_gerencia = 9
and	p.nr_seq_classif = 14
and	p.nr_seq_grupo_des = nr_seq_grupo_desenv_w;


BEGIN
if (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then
	begin
	delete
	from	w_analise_proj_desenv
	where	nr_seq_gerencia = 9
	and	dt_analise = trunc(clock_timestamp())
	and	ie_tipo_informacao = 'A';

	open c01;
	loop
	fetch c01 into nr_seq_grupo_desenv_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		qt_projetos_ww			:= 0;
		qt_projetos_desenv_ww		:= 0;
		qt_projetos_desenv_tec_ww	:= 0;
		qt_projetos_teste_ww		:= 0;
		qt_projetos_concluidos_ww	:= 0;
		qt_projetos_pendentes_ww	:= 0;
		qt_horas_previstas_ww		:= 0;
		qt_horas_sentimento_ww		:= 0;
		qt_horas_realizadas_ww		:= 0;
		qt_horas_saldo_ww		:= 0;
		qt_os_projetos_ww		:= 0;
		qt_os_projetos_tec_ww		:= 0;
		qt_os_projetos_desenv_ww	:= 0;
		qt_os_projetos_teste_ww		:= 0;
		qt_os_projetos_concluidas_ww	:= 0;

		open c02;
		loop
		fetch c02 into nr_seq_area_proj_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
			select	count(*),
				sum(coalesce(proj_obter_qt_total_horas_cron(p.nr_sequencia, 0, 'T', 'E'), 0)),
				sum(coalesce(obter_horas_sent_proj_migr(p.nr_sequencia, p.nr_seq_estagio), 0)),
				sum(coalesce(proj_obter_qt_total_horas_cron(p.nr_sequencia,0, 'R', 'E'), 0))
			into STRICT	qt_projetos_w,
				qt_horas_previstas_w,
				qt_horas_sentimento_w,
				qt_horas_realizadas_w
			from	proj_projeto p
			where	p.nr_seq_gerencia = 9
			and	p.nr_seq_classif = 14
			and	p.nr_seq_grupo_des = nr_seq_grupo_desenv_w
			and	p.nr_seq_grupo = nr_seq_area_proj_w;

			pr_uso_tempo_previsto_w	:= obter_perc_valor(qt_horas_realizadas_w, qt_horas_previstas_w);
			qt_horas_saldo_w	:= qt_horas_previstas_w - qt_horas_realizadas_w;

			select	count(*)
			into STRICT	qt_projetos_desenv_w
			from	proj_projeto p
			where	p.nr_seq_gerencia = 9
			and	p.nr_seq_classif = 14
			and	p.nr_seq_grupo_des = nr_seq_grupo_desenv_w
			and	p.nr_seq_grupo = nr_seq_area_proj_w
			and	p.nr_seq_estagio = 12;

			select	count(*)
			into STRICT	qt_projetos_desenv_tec_w
			from	proj_projeto p
			where	p.nr_seq_gerencia = 9
			and	p.nr_seq_classif = 14
			and	p.nr_seq_grupo_des = nr_seq_grupo_desenv_w
			and	p.nr_seq_grupo = nr_seq_area_proj_w
			and	p.nr_seq_estagio = 12
			and	exists (
					SELECT	1
					from	man_ordem_servico mos
					where	mos.nr_sequencia = p.nr_seq_ordem_serv
					and	mos.nr_seq_estagio = 961);

			select	count(*)
			into STRICT	qt_projetos_teste_w
			from	proj_projeto p
			where	p.nr_seq_gerencia = 9
			and	p.nr_seq_classif = 14
			and	p.nr_seq_grupo_des = nr_seq_grupo_desenv_w
			and	p.nr_seq_grupo = nr_seq_area_proj_w
			and	p.nr_seq_estagio in (13, 17);

			select	count(*)
			into STRICT	qt_projetos_concluidos_w
			from	proj_projeto p
			where	p.nr_seq_gerencia = 9
			and	p.nr_seq_classif = 14
			and	p.nr_seq_grupo_des = nr_seq_grupo_desenv_w
			and	p.nr_seq_grupo = nr_seq_area_proj_w
			and	p.ie_status = 'F';

			qt_projetos_pendentes_w := qt_projetos_w - qt_projetos_desenv_w - qt_projetos_teste_w - qt_projetos_concluidos_w;

			select	count(*)
			into STRICT	qt_os_projetos_w
			from	proj_ordem_servico pos,
				proj_projeto p
			where	pos.nr_seq_proj = p.nr_sequencia
			and	p.nr_seq_gerencia = 9
			and	p.nr_seq_classif = 14
			and	p.nr_seq_grupo_des = nr_seq_grupo_desenv_w
			and	p.nr_seq_grupo = nr_seq_area_proj_w;

			select	count(*)
			into STRICT	qt_os_projetos_desenv_w
			from	man_ordem_servico mos,
				proj_ordem_servico pos,
				proj_projeto p
			where	pos.nr_seq_proj = p.nr_sequencia
			and	p.nr_seq_gerencia = 9
			and	p.nr_seq_classif = 14
			and	p.nr_seq_grupo_des = nr_seq_grupo_desenv_w
			and	p.nr_seq_grupo = nr_seq_area_proj_w
			and	mos.nr_sequencia = pos.nr_seq_ordem
			and	mos.nr_seq_estagio in (4, 731, 732);

			select	count(*)
			into STRICT	qt_os_projetos_tec_w
			from	man_ordem_servico mos,
				proj_ordem_servico pos,
				proj_projeto p
			where	pos.nr_seq_proj = p.nr_sequencia
			and	p.nr_seq_gerencia = 9
			and	p.nr_seq_classif = 14
			and	p.nr_seq_grupo_des = nr_seq_grupo_desenv_w
			and	p.nr_seq_grupo = nr_seq_area_proj_w
			and	mos.nr_sequencia = pos.nr_seq_ordem
			and	mos.nr_seq_estagio in (131, 961);

			select	count(*)
			into STRICT	qt_os_projetos_teste_w
			from	man_ordem_servico mos,
				proj_ordem_servico pos,
				proj_projeto p
			where	pos.nr_seq_proj = p.nr_sequencia
			and	p.nr_seq_gerencia = 9
			and	p.nr_seq_classif = 14
			and	p.nr_seq_grupo_des = nr_seq_grupo_desenv_w
			and	p.nr_seq_grupo = nr_seq_area_proj_w
			and	mos.nr_sequencia = pos.nr_seq_ordem
			and	mos.nr_seq_estagio in (2, 41, 1511);

			select	count(*)
			into STRICT	qt_os_projetos_concluidas_w
			from	man_ordem_servico mos,
				proj_ordem_servico pos,
				proj_projeto p
			where	pos.nr_seq_proj = p.nr_sequencia
			and	p.nr_seq_gerencia = 9
			and	p.nr_seq_classif = 14
			and	p.nr_seq_grupo_des = nr_seq_grupo_desenv_w
			and	p.nr_seq_grupo = nr_seq_area_proj_w
			and	mos.nr_sequencia = pos.nr_seq_ordem
			and	mos.nr_seq_estagio = 9;

			pr_realizacao_w := obter_perc_valor(qt_horas_sentimento_w, qt_horas_previstas_w);

			insert into w_analise_proj_desenv(
				nm_usuario,
				dt_analise,
				nr_seq_gerencia,
				nr_seq_grupo,
				nr_seq_area,
				qt_projeto,
				qt_projeto_desenv,
				qt_projeto_desenv_tec,
				qt_projeto_teste,
				qt_projeto_concluido,
				qt_projeto_saldo,
				qt_horas_previstas,
				qt_horas_realizadas,
				qt_horas_saldo,
				pr_previsao,
				pr_realizacao,
				qt_os_projeto,
				qt_os_projeto_tec,
				qt_os_projeto_desenv,
				qt_os_projeto_teste,
				qt_os_projeto_conc,
				dt_fim_previsto,
				ie_tipo_informacao)
			values (
				nm_usuario_p,
				trunc(clock_timestamp()),
				9,
				nr_seq_grupo_desenv_w,
				nr_seq_area_proj_w,
				qt_projetos_w,
				qt_projetos_desenv_w,
				qt_projetos_desenv_tec_w,
				qt_projetos_teste_w,
				qt_projetos_concluidos_w,
				qt_projetos_pendentes_w,
				qt_horas_previstas_w,
				qt_horas_realizadas_w,
				qt_horas_saldo_w,
				pr_uso_tempo_previsto_w,
				pr_realizacao_w,
				qt_os_projetos_w,
				qt_os_projetos_tec_w,
				qt_os_projetos_desenv_w,
				qt_os_projetos_teste_w,
				qt_os_projetos_concluidas_w,
				null,
				'A');

			qt_projetos_ww			:= qt_projetos_ww + qt_projetos_w;
			qt_projetos_desenv_ww		:= qt_projetos_desenv_ww + qt_projetos_desenv_w;
			qt_projetos_desenv_tec_ww	:= qt_projetos_desenv_tec_ww + qt_projetos_desenv_tec_w;
			qt_projetos_teste_ww		:= qt_projetos_teste_ww + qt_projetos_teste_w;
			qt_projetos_concluidos_ww	:= qt_projetos_concluidos_ww + qt_projetos_concluidos_w;
			qt_projetos_pendentes_ww	:= qt_projetos_pendentes_ww + qt_projetos_pendentes_w;
			qt_horas_previstas_ww		:= qt_horas_previstas_ww + qt_horas_previstas_w;
			qt_horas_sentimento_ww		:= qt_horas_sentimento_ww + qt_horas_sentimento_w;
			qt_horas_realizadas_ww		:= qt_horas_realizadas_ww + qt_horas_realizadas_w;
			qt_horas_saldo_ww		:= qt_horas_saldo_ww + qt_horas_saldo_w;
			qt_os_projetos_ww		:= qt_os_projetos_ww + qt_os_projetos_w;
			qt_os_projetos_tec_ww		:= qt_os_projetos_tec_ww + qt_os_projetos_tec_w;
			qt_os_projetos_desenv_ww	:= qt_os_projetos_desenv_ww + qt_os_projetos_desenv_w;
			qt_os_projetos_teste_ww		:= qt_os_projetos_teste_ww + qt_os_projetos_teste_w;
			qt_os_projetos_concluidas_ww	:= qt_os_projetos_concluidas_ww + qt_os_projetos_concluidas_w;
			end;
		end loop;
		close c02;

		pr_uso_tempo_previsto_ww	:= obter_perc_valor(qt_horas_realizadas_ww, qt_horas_previstas_ww);
		pr_realizacao_ww		:= obter_perc_valor(qt_horas_sentimento_ww, qt_horas_previstas_ww);

		insert into w_analise_proj_desenv(
			nm_usuario,
			dt_analise,
			nr_seq_gerencia,
			nr_seq_grupo,
			nr_seq_area,
			qt_projeto,
			qt_projeto_desenv,
			qt_projeto_desenv_tec,
			qt_projeto_teste,
			qt_projeto_concluido,
			qt_projeto_saldo,
			qt_horas_previstas,
			qt_horas_realizadas,
			qt_horas_saldo,
			pr_previsao,
			pr_realizacao,
			qt_os_projeto,
			qt_os_projeto_tec,
			qt_os_projeto_desenv,
			qt_os_projeto_teste,
			qt_os_projeto_conc,
			dt_fim_previsto,
			ie_tipo_informacao)
		values (
			nm_usuario_p,
			trunc(clock_timestamp()),
			9,
			nr_seq_grupo_desenv_w,
			null,
			qt_projetos_ww,
			qt_projetos_desenv_ww,
			qt_projetos_desenv_tec_ww,
			qt_projetos_teste_ww,
			qt_projetos_concluidos_ww,
			qt_projetos_pendentes_ww,
			qt_horas_previstas_ww,
			qt_horas_realizadas_ww,
			qt_horas_saldo_ww,
			pr_uso_tempo_previsto_ww,
			pr_realizacao_ww,
			qt_os_projetos_ww,
			qt_os_projetos_tec_ww,
			qt_os_projetos_desenv_ww,
			qt_os_projetos_teste_ww,
			qt_os_projetos_concluidas_ww,
			null,
			'A');
		end;
	end loop;
	close c01;
	end;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_analise_migr_area_proj ( nm_usuario_p text) FROM PUBLIC;

