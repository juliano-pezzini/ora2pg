-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alvarows_atual_exame_lab_item ( nr_controle_int_lab_p bigint, cd_exame_p text, cd_analito_p text, qt_resultado_p bigint, ds_resultado_p text, ds_observacao_p text, nm_usuario_p text, ds_referencia_p text, ds_unidade_medida_p text, ds_metodo_exame_p text, ds_erro_p INOUT text) AS $body$
DECLARE


nr_seq_prescricao_w         	prescr_procedimento.nr_sequencia%type;
NR_SEQ_EXAME_W		            EXAME_LABORATORIO.NR_SEQ_EXAME%type;
cd_analito_w		            exame_laboratorio.CD_EXAME%type;
ie_formato_resultado_w          exame_laboratorio.ie_formato_resultado%type;
nr_seq_resultado_w	            exame_lab_resultado.nr_seq_resultado%type;
nr_seq_exame_w2		            exame_laboratorio.nr_seq_exame%type;
ds_erro_w			            varchar(2000);
nr_prescricao_w		            prescr_procedimento.nr_prescricao%type;
nr_seq_analito_w  	            exame_laboratorio.nr_seq_exame%type;
ds_resultado_w 		            varchar(4000);
ds_sep_bv_w                     varchar(50);
nr_seq_conversao_w              bigint;
ie_status_Atend_w               prescr_procedimento.ie_status_Atend%type;
ie_atualizar_result_aprov_w     Lab_parametro.ie_atualizar_result_aprov%type;

nr_sequencia_lote_w             prescr_procedimento.nr_seq_lote_externo%type;


BEGIN

-- Busca pela sequencia da prescricao
select 	coalesce(max(a.nr_sequencia),0),
	coalesce(max(a.nr_seq_exame),0),
	coalesce(max(a.nr_prescricao),0)
into STRICT 	nr_seq_prescricao_w,
	nr_seq_exame_w,
	nr_prescricao_w
from 	prescr_procedimento a,
	exame_laboratorio b,
	prescr_medica c
where 	a.nr_seq_exame = b.nr_seq_exame
and	c.nr_prescricao = a.nr_prescricao
and	b.ie_situacao <> 'I'
and	c.nr_controle_int_lab = nr_controle_int_lab_p
and coalesce(coalesce(Obter_Equipamento_Exame(b.nr_seq_exame,null,'ALVARO'),b.cd_exame_integracao),b.cd_exame)= cd_exame_p;


CALL gravar_log_tasy(123, 'cod analito'||cd_analito_p|| 'Cod exame '||cd_exame_p||'nr_prescricao  '|| nr_prescricao_w ||'nr_seq_exame_w  '|| nr_seq_exame_w, nm_usuario_p);
commit;

if  not(nr_seq_prescricao_w > 0) then
	--Noo foi possovel encontrar o exame ' ||cd_exame_p||', na prescricao '||to_char(nr_prescricao_p)
	ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(233241,'CD_EXAME='||to_char(cd_exame_p)||';'||'NR_PRESCRICAO='||to_char(nr_prescricao_w));
end if;

-- Busca pelo codigo do analito
select	max(coalesce(e.cd_exame_integracao, e.cd_exame)), max(e.nr_seq_exame)
into STRICT	cd_analito_w,
	nr_seq_analito_w
from	exame_laboratorio e
where	e.nr_seq_exame = (SELECT nr_seq_exame
			  from equipamento_lab b,
				lab_exame_equip a
			  WHERE	a.cd_equipamento = b.cd_equipamento
			  AND	a.cd_exame_equip = cd_analito_p
			  AND	upper(b.ds_sigla) = 'ALVARO'
			  AND	a.nr_seq_exame = nr_seq_exame_w);

select NR_SEQ_LOTE_EXTERNO
 into STRICT nr_sequencia_lote_w
 from prescr_procedimento 
where nr_prescricao = nr_prescricao_w
  and nr_sequencia  = nr_seq_prescricao_w;WITH RECURSIVE cte AS (



if (coalesce(cd_analito_w::text, '') = '') then

	select	max(coalesce(e.cd_exame_integracao, e.cd_exame)),max(e.nr_seq_exame)
	into STRICT	cd_analito_w,nr_seq_analito_w
	from	exame_laboratorio e WHERE nr_seq_superior = nr_seq_exame_w
  UNION ALL



if (coalesce(cd_analito_w::text, '') = '') then

	select	max(coalesce(e.cd_exame_integracao, e.cd_exame)),max(e.nr_seq_exame)
	into STRICT	cd_analito_w,nr_seq_analito_w
	from	exame_laboratorio e JOIN cte c ON (c.prior nr_seq_exame = e.nr_seq_superior)

) SELECT * FROM cte WHERE nr_seq_exame = (SELECT nr_seq_exame
				from equipamento_lab b,
				     lab_exame_equip a
				WHERE	a.cd_equipamento = b.cd_equipamento
				AND	a.cd_exame_equip = cd_analito_p
				AND	upper(b.ds_sigla) = 'ALVARO'
				AND	a.nr_seq_exame = e.nr_seq_exame);
;


end if;

    CALL gravar_log_tasy(123, 'nr_prescricao_p  '||nr_prescricao_w||' nr_seq_prescricao_w  '|| nr_seq_prescricao_w ||' cd_analito_w  '|| cd_analito_w || ' qt_resultado_p '||qt_resultado_p || ' ds_resultado_p '||ds_resultado_p, nm_usuario_p);
	commit;

    if (cd_analito_w IS NOT NULL AND cd_analito_w::text <> '') then
        select coalesce(ie_atualizar_result_aprov,'N'),
             p.ie_status_Atend
        into STRICT ie_atualizar_result_aprov_w,
             ie_status_Atend_w
        from Lab_parametro l
        join prescr_medica m
             on m.cd_estabelecimento = l.cd_estabelecimento
        join prescr_procedimento p
             on m.nr_prescricao = p.nr_prescricao
       where p.nr_prescricao = nr_prescricao_w
         and p.nr_sequencia = nr_seq_prescricao_w;

        if (ie_status_Atend_w >= 35 and ie_atualizar_result_aprov_w ='N') then
            CALL gravar_log_tasy(123, 'Prescricao com resultado aprovado nao sera atualizado: nr_prescricao_p  '||nr_prescricao_w||' nr_seq_prescricao_w  '|| nr_seq_prescricao_w ||' ie_status_Atend  '|| ie_status_Atend_w || ' ie_atualizar_result_aprov '|| ie_atualizar_result_aprov_w, nm_usuario_p);
            commit;
        else
            CALL gravar_log_tasy(123, 'nr_prescricao_p  '||nr_prescricao_w||' nr_seq_prescricao_w  '|| nr_seq_prescricao_w ||' cd_analito_w  '|| cd_analito_w || ' qt_resultado_p '||qt_resultado_p || ' ds_resultado_p '||ds_resultado_p, nm_usuario_p);
            commit;

            if (position('\rtf' in lower(ds_resultado_p)) > 0) then
                ds_resultado_w := 'teste123';
            else
                ds_resultado_w := ds_resultado_p;

            end if;

            ds_erro_p := Atualizar_Lab_Result_Item(	nr_prescricao_w, nr_seq_prescricao_w, cd_analito_w, qt_resultado_p, null, ds_resultado_w, ds_observacao_p, null, null, nm_usuario_p, null, ds_referencia_p, ds_unidade_medida_p, null, null, ds_erro_p);


            update LAB_LOTE_EXTERNO
            set DT_RETORNO =clock_timestamp()
            where nr_Sequencia = nr_sequencia_lote_w;


            -- Busca o resultado
            select 	nr_seq_resultado
            into STRICT   	nr_seq_resultado_w
            from 	exame_lab_resultado
            where 	nr_prescricao = nr_prescricao_w;

            -- atualiza metodo do exame
            update 	exame_lab_result_item
            set 	ds_metodo_ext   = ds_metodo_exame_p,
                    nm_usuario = nm_usuario_p,
                    dt_atualizacao = clock_timestamp()
            where 	nr_seq_resultado = nr_seq_resultado_w
            and	coalesce(nr_seq_metodo::text, '') = ''
            and	nr_seq_prescr = nr_seq_prescricao_w;


            if (position('\rtf' in lower(ds_resultado_p)) > 0) then
                select OBTER_SEPARADOR_BV into STRICT ds_sep_bv_w;

                update exame_lab_result_item
                set    ds_resultado = ds_resultado_p
                where  nr_seq_resultado = nr_seq_resultado_w
                and    nr_seq_prescr = nr_seq_prescricao_w
                and    nr_seq_exame = nr_seq_analito_w;

                nr_seq_conversao_w := converte_rtf_string( 'select a.ds_resultado
                    from exame_lab_result_item a
                    where a.nr_seq_resultado = :nr_seq_resultado_p
                    and a.nr_seq_prescr = :nr_seq_prescr_p
                    and a.nr_seq_exame = :nr_seq_analito_p', nr_seq_resultado_w||ds_sep_bv_w||nr_seq_prescricao_w||ds_sep_bv_w||nr_seq_analito_w, 'Tasy', nr_seq_conversao_w);

                update exame_lab_result_item
                set    ds_resultado = (SELECT substr(convert_long_to_varchar2('ds_texto', 'tasy_conversao_rtf', ' nr_sequencia = '|| nr_seq_conversao_w),1,4000) )
                where  nr_seq_resultado = nr_seq_resultado_w
                and    nr_seq_prescr = nr_seq_prescricao_w
                and    nr_seq_exame = nr_seq_analito_w;
        end if;
    end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alvarows_atual_exame_lab_item ( nr_controle_int_lab_p bigint, cd_exame_p text, cd_analito_p text, qt_resultado_p bigint, ds_resultado_p text, ds_observacao_p text, nm_usuario_p text, ds_referencia_p text, ds_unidade_medida_p text, ds_metodo_exame_p text, ds_erro_p INOUT text) FROM PUBLIC;

