-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE c04_record AS (
	nr_sequencia_movto			pat_bem.nr_sequencia%type,		
	cd_conta_contabil			pat_bem.cd_conta_contabil%type,
	cd_centro_custo				pat_valor_bem.cd_centro_custo%type,
    vl_aitb_periodo         	memoria_calculo_aitb.vl_aitb_periodo%type,
	vl_depreciacao_acumulada    memoria_calculo_aitb.vl_depreciacao_acumulada%type,
	vl_depreciacao_atual        memoria_calculo_aitb.vl_depreciacao_atual%type,
	vl_depreciacao_liquida      memoria_calculo_aitb.vl_depreciacao_liquida%type,
	nr_codigo_controle         	memoria_calculo_aitb.nr_codigo_controle%type,
	nr_sequencia				pat_bem.nr_sequencia%type,
    nm_tabela               	w_movimento_contabil.nm_tabela%type,
	nm_atributo					w_movimento_contabil.nm_atributo%type,
	nr_seq_info_ctb         	varchar(100),
	cd_bem						pat_bem.cd_bem%type,
    nr_seq_tab_orig         	w_movimento_contabil.nr_seq_tab_orig%type
);
CREATE TYPE c05_record AS (
	cd_conta_lucro_venda			pat_tipo_historico.cd_conta_lucro_venda%type,		
	cd_conta_debito_fiscal			pat_tipo_historico.cd_conta_debito_fiscal%type,
	cd_conta_perdas_venda			pat_tipo_historico.cd_conta_perdas_venda%type
);


CREATE OR REPLACE PROCEDURE contabiliza_patrimonio ( nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text) AS $body$
DECLARE


dt_referencia_w                 timestamp;
cd_estabelecimento_w            smallint;
ie_taxa_depreciacao_w           varchar(2);
cd_conta_contabil_w             varchar(20);
cd_conta_deprec_acum_w          varchar(20);
cd_conta_baixa_w                varchar(20);
cd_conta_deprec_res_w           varchar(20);
cd_conta_debito_w               varchar(20);
cd_conta_credito_w              varchar(20);
cd_centro_debito_w              integer;
cd_centro_credito_w             integer;
cd_centro_custo_w               integer;
vl_movimento_w                  double precision;
nr_sequencia_movto_w            integer;
cd_historico_baixa_w            bigint;
cd_historico_w                  bigint;
ds_compl_historico_w            varchar(255);
ds_compl_historico_ww           varchar(255);
ds_retorno_w                    varchar(20);
dt_movimento_w                  timestamp;
dt_estorno_w                    timestamp;
nr_seq_agrupamento_w            w_movimento_contabil.nr_seq_agrupamento%type := 0;
ie_movimento_w                  bigint;
nr_seq_bem_w                    bigint;
nr_seq_bem_info_w               bigint;
cd_tipo_lote_contabil_w         bigint;
qt_lotes_gerados_w              integer;
ie_compl_hist_w                 varchar(1);
ds_conteudo_w                   varchar(4000) := '';
cd_bem_w                        varchar(20);
ds_mesano_referencia_w          varchar(40);
ie_situacao_w                   varchar(1);
ds_bem_w                        varchar(255);
ie_forma_contab_w               varchar(1);
vl_transf_bem_w                 double precision;
vl_transf_deprec_acum_w         double precision;
cd_estab_destino_w              bigint;
ie_permite_estab_dif_w          varchar(15);
cd_conta_transitoria_w          varchar(20);
cd_historico_ct_w               bigint;
nr_seq_regra_subvencao_w        bigint;
nr_seq_baixa_w                  bigint;
nr_seq_tipo_hist_w              bigint;
cd_conta_baixa_tipo_w           varchar(20);
cd_hist_baixa_tipo_w            bigint;
nr_seq_regra_conta_w            bigint;
ie_devolucao_w                  varchar(1);
ds_estorno_w                    varchar(50);
cd_conta_rec_baixa_dep_w        varchar(20);
ie_tipo_valor_w                 varchar(3);
cd_conta_ajuste_pat_w           varchar(20);
cd_conta_cap_social_w           varchar(20);
cd_hist_ajuste_pat_w            bigint;
cd_bem_externo_w                varchar(20);
ie_centro_custo_w               varchar(1);
qt_registros_w                  bigint;
cd_empresa_w                    bigint;
vl_movto_ajuste_capital_w       movimento_contabil.vl_movimento%type;
vl_baixa_deprec_w               movimento_contabil.vl_movimento%type;
ie_rateio_deprec_transf_w       varchar(255);
nr_doc_aux_w                    movimento_contabil.nr_documento%Type := null;
ie_origem_documento_w           movimento_contabil.ie_origem_documento%Type := null;
nr_seq_bem_ww                   pat_bem.nr_sequencia%Type;
vl_rateio_deprec_w              pat_valor_bem_rateio.vl_rateio_deprec%Type;
cd_conta_rateio_deprec_w        conta_contabil.cd_conta_contabil%type;
qt_registro_w                   integer;
cd_estab_w                      estabelecimento.cd_estabelecimento%Type;
dt_historico_w                  timestamp;
ie_contab_rateio_deprec_w       varchar(1);
nr_seq_info_ctb_w               informacao_contabil.nr_sequencia%type;
nm_tabela_w                     w_movimento_contabil.nm_tabela%type;
nm_atributo_w                   w_movimento_contabil.nm_atributo%type;
nr_seq_tab_orig_w               w_movimento_contabil.nr_seq_tab_orig%type;
nr_seq_tab_compl_w              w_movimento_contabil.nr_seq_tab_compl%type;
dt_ref_inicial_w                timestamp;
dt_ref_final_w                  timestamp;
cd_centro_custo_rateio_w        pat_valor_bem_rateio.cd_centro_custo%type;
cd_hist_entrada_aval_w          pat_conta_contabil.cd_hist_entrada_aval%type;
cd_conta_entrada_aval_w         pat_conta_contabil.cd_conta_entrada_aval%type;
ie_regra_w                      varchar(255);
ds_atributos_w                  varchar(4000);
nm_agrupador_w                  varchar(255);
ds_mesano_w                     varchar(255);
cd_estab_trans_w                smallint;
cd_bem_docto_w                  pat_bem.cd_bem%type;
movimento_contabil_w            w_movimento_contabil%rowtype;
ie_D_C_rat_w                    varchar(1);
ie_D_C_rat_transit_w            varchar(1);
ie_D_C_deprec_w                 varchar(1);
ie_D_C_deprec_transit_w         varchar(1);
ie_D_C_pat_w                    varchar(1);
ie_D_C_pat_transit_w            varchar(1);
ie_D_C_ajuste_pat_w             varchar(1);
nr_seq_proj_rec_w               pat_bem.nr_seq_proj_rec%type;
cd_conta_ativo_aitb_w			pat_conta_contabil.cd_conta_ativo_aitb%type;
cd_conta_passivo_aitb_w			pat_conta_contabil.cd_conta_passivo_aitb%type;
vl_mercado_w					pat_bem.vl_mercado%type;
vl_debito_fiscal_w				pat_valor_bem.vl_debito_fiscal%type;
vl_calculated_w					pat_bem_movimento.vl_movimento%type;
vl_baixa_bem_bolivia_w			pat_valor_bem.vl_baixa_bem%type;
bens_w							dbms_sql.number_table;			
ie_contador_w					pat_bem.nr_sequencia%type;
ie_bem_atual_w					pat_bem.nr_sequencia%type;
ie_ja_contabilizado_w			varchar(1);
cd_conta_lucro_perda_w			pat_conta_contabil.cd_conta_contabil%type;
vl_lucro_perda_w				pat_bem_movimento.vl_movimento%type;
ie_D_C_lucro_perda				varchar(1);
ie_cont_registros_w					pat_bem.nr_sequencia%type := 0;

c_valor_bem CURSOR FOR
        /* Contabilizar depreciacao normal */

        SELECT  1,
                a.cd_conta_contabil,
                a.cd_centro_custo,
                sum(a.vl_deprec_mes),
                b.nr_sequencia nr_seq_bem,
                'PAT_VALOR_BEM' nm_tabela,
                'VL_DEPREC_MES' nm_atributo,
                11 nr_seq_info_ctb,
                b.cd_bem,
                b.nr_seq_proj_rec
        from    pat_bem         b,
                pat_valor_bem   a
        where   a.nr_seq_bem            = b.nr_sequencia
        and     a.nr_lote_contabil      = nr_lote_contabil_p
        and     a.cd_estabelecimento    = cd_estabelecimento_w
        and     coalesce(b.nr_seq_crit_rateio::text, '') = ''
        and     ((coalesce(ie_contab_rateio_deprec_w,'N') = 'N') or
                not exists (SELECT 1
                                from    pat_valor_bem_rateio y
                                where   y.nr_seq_valor = a.nr_sequencia))
        and     ((ie_taxa_depreciacao_w = 'N') and (a.tx_depreciacao <> 0) or (ie_taxa_depreciacao_w = 'S'))
        group by
                b.nr_sequencia,
                a.cd_conta_contabil,
                a.cd_centro_custo,
                b.cd_bem,
                b.nr_seq_proj_rec

union all

        /* Contabilizar baixa do bem */

        select 2,
                a.cd_conta_contabil,
                coalesce(c.cd_centro_custo,a.cd_centro_custo) cd_centro_custo,
                coalesce(c.vl_rateio_baixa_bem,a.vl_baixa_bem) vl_movimento,
                a.nr_seq_bem,
                substr(CASE WHEN coalesce(c.cd_centro_custo::text, '') = '' THEN 'PAT_VALOR_BEM'  ELSE 'PAT_VALOR_BEM_RATEIO' END ,1,50) nm_tabela,
                substr(CASE WHEN coalesce(c.cd_centro_custo::text, '') = '' THEN 'VL_BAIXA_BEM'  ELSE 'VL_RATEIO_BAIXA_BEM' END ,1,255) nm_atributo,
                12 nr_seq_info_ctb,
                b.cd_bem,
                b.nr_seq_proj_rec
        FROM pat_bem b, pat_valor_bem a
LEFT OUTER JOIN pat_valor_bem_rateio c ON (a.nr_sequencia = c.nr_seq_valor)
WHERE a.nr_seq_bem            = b.nr_sequencia  and a.nr_lote_contabil      = nr_lote_contabil_p and coalesce(coalesce(c.vl_rateio_baixa_bem,a.vl_baixa_bem),0) > 0 and a.cd_estabelecimento    = cd_estabelecimento_w and ((ie_taxa_depreciacao_w = 'N') and (a.tx_depreciacao <> 0) or (ie_taxa_depreciacao_w = 'S'))
         
union all

        /* Contabilizar baixa de depreciacao */

        select 3,
                a.cd_conta_contabil,
                coalesce(c.cd_centro_custo,a.cd_centro_custo) cd_centro_custo,
                coalesce(c.vl_rateio_baixa_deprec,a.vl_baixa_deprec) vl_movimento,
                a.nr_seq_bem,
                substr(CASE WHEN coalesce(c.cd_centro_custo::text, '') = '' THEN 'PAT_VALOR_BEM'  ELSE 'PAT_VALOR_BEM_RATEIO' END ,1,50) nm_tabela,
                substr(CASE WHEN coalesce(c.cd_centro_custo::text, '') = '' THEN 'VL_BAIXA_DEPREC'  ELSE 'VL_RATEIO_BAIXA_DEPREC' END ,1,255) nm_atributo,
                12 nr_seq_info_ctb,
                b.cd_bem,
                b.nr_seq_proj_rec
        FROM pat_bem b, pat_valor_bem a
LEFT OUTER JOIN pat_valor_bem_rateio c ON (a.nr_sequencia = c.nr_seq_valor)
WHERE a.nr_seq_bem            = b.nr_sequencia  and a.cd_estabelecimento    = cd_estabelecimento_w and a.nr_lote_contabil      = nr_lote_contabil_p and coalesce(coalesce(c.vl_rateio_baixa_deprec, a.vl_baixa_deprec),0) > 0 and ((ie_taxa_depreciacao_w = 'N') and (a.tx_depreciacao <> 0) or (ie_taxa_depreciacao_w = 'S'))
         
union all

        /* Contabilizar o rateio da depreciacao por criterio ou transferencia entre CC */

        select  4,
                c.cd_conta_contabil,
                c.cd_centro_custo,
                sum(c.vl_rateio_deprec),
                b.nr_sequencia nr_seq_bem,
                'PAT_VALOR_BEM_RATEIO' nm_tabela,
                'VL_RATEIO_DEPREC' nm_atributo,
                11 nr_seq_info_ctb,
                b.cd_bem,
                b.nr_seq_proj_rec
        from    pat_bem                 b,
                pat_valor_bem           a,
                pat_valor_bem_rateio    c
        where   a.nr_seq_bem            = b.nr_sequencia
        and     a.nr_sequencia          = c.nr_seq_valor
        and     a.nr_lote_contabil      = nr_lote_contabil_p
        and     a.cd_estabelecimento    = cd_estabelecimento_w
        and     ((b.nr_seq_crit_rateio IS NOT NULL AND b.nr_seq_crit_rateio::text <> '') or (ie_rateio_deprec_transf_w = 'S'))
        and     ((ie_taxa_depreciacao_w = 'N') and (a.tx_depreciacao <> 0) or (ie_taxa_depreciacao_w = 'S'))
        and     not exists ( /* Transferencia entre estabelecimentos */
                select  1
                from    pat_tipo_historico y,
                        pat_historico_bem x
                where   x.nr_seq_bem = b.nr_sequencia
                and     x.nr_seq_tipo = y.nr_sequencia
                and     y.ie_transferencia = 'S'
                and     ((x.cd_estab_origem <> x.cd_estab_destino) or (x.cd_estab_origem = x.cd_estab_destino and coalesce(ie_contab_rateio_deprec_w,'N') = 'S'))
                and     trunc(last_day(x.dt_historico)) = a.dt_valor
                )
        group by
                b.nr_sequencia,
                c.cd_conta_contabil,
                c.cd_centro_custo,
                b.cd_bem,
                b.nr_seq_proj_rec
        
union all

        /* Contabiliza depreciacao de bens que sao subvencao governamental */

        select  5,
                a.cd_conta_contabil,
                a.cd_centro_custo,
                sum(a.vl_deprec_mes),
                b.nr_sequencia,
                'PAT_VALOR_BEM' nm_tabela,
                'VL_DEPREC_MES' nm_atributo,
                11 nr_seq_info_ctb,
                b.cd_bem,
                b.nr_seq_proj_rec
        from    pat_bem         b,
                pat_valor_bem   a
        where   a.nr_seq_bem            = b.nr_sequencia
        and     a.nr_lote_contabil      = nr_lote_contabil_p
        and     a.cd_estabelecimento    = cd_estabelecimento_w
        and     coalesce(b.nr_seq_crit_rateio::text, '') = ''
        and     coalesce(ie_subvencao,'N')   = 'S'
        and     not exists (select 1
                                from    pat_valor_bem_rateio y
                                where   y.nr_seq_valor = a.nr_sequencia)
        and     exists (select 1
                        from    pat_bem_subvencao y
                        where   y.nr_seq_bem    = b.nr_sequencia)
        and     ((ie_taxa_depreciacao_w = 'N') and (a.tx_depreciacao <> 0) or (ie_taxa_depreciacao_w = 'S'))
        group by
                a.cd_conta_contabil,
                a.cd_centro_custo,
                b.nr_sequencia,
                b.cd_bem,
                b.nr_seq_proj_rec
        
union all

        /* Contabilizar o rateio da depreciacao de bens que sao subvencao governamental */

        select  6,
                c.cd_conta_contabil,
                c.cd_centro_custo,
                sum(c.vl_rateio_deprec),
                b.nr_sequencia,
                'PAT_VALOR_BEM_RATEIO' nm_tabela,
                'VL_RATEIO_DEPREC' nm_atributo,
                11 nr_seq_info_ctb,
                b.cd_bem,
                b.nr_seq_proj_rec
        from    pat_bem                 b,
                pat_valor_bem           a,
                pat_valor_bem_rateio    c
        where   a.nr_seq_bem            = b.nr_sequencia
        and     a.nr_sequencia          = c.nr_seq_valor
        and     a.nr_lote_contabil      = nr_lote_contabil_p
        and     a.cd_estabelecimento    = cd_estabelecimento_w
        and     ((b.nr_seq_crit_rateio IS NOT NULL AND b.nr_seq_crit_rateio::text <> '') or (ie_rateio_deprec_transf_w = 'S'))
        and     coalesce(ie_subvencao,'N')   = 'S'
        and     exists (select 1
                        from    pat_bem_subvencao y
                        where   y.nr_seq_bem    = b.nr_sequencia)
        and     ((ie_taxa_depreciacao_w = 'N') and (a.tx_depreciacao <> 0) or (ie_taxa_depreciacao_w = 'S'))
        and     not exists (
                        select  1
                        from    pat_tipo_historico y,
                                pat_historico_bem x
                        where   x.nr_seq_bem = b.nr_sequencia
                        and     x.nr_seq_tipo = y.nr_sequencia
                        and     y.ie_transferencia = 'S'
                        and     x.cd_estab_origem <> x.cd_estab_destino
                        and     trunc(last_day(x.dt_historico)) = a.dt_valor
                        )
        group by
                c.cd_conta_contabil,
                c.cd_centro_custo,
                b.nr_sequencia,
                b.cd_bem,
                b.nr_seq_proj_rec
        
union all

        /* Contabilizar o valor de ajuste, sai do ATIVO entra na DEPREC ACUM - SEM RATEIO */

        select  7,
                b.cd_conta_contabil,
                b.cd_centro_custo,
                b.vl_deprec_acum_ant,
                a.nr_sequencia,
                'PAT_VALOR_BEM' nm_tabela,
                'VL_DEPREC_ACUM_ANT' nm_atributo,
                84 nr_seq_info_ctb, /* Reavaliacao - Ajuste de valor */
                a.cd_bem,
                a.nr_seq_proj_rec
        from    pat_bem_avaliacao c,
                pat_valor_bem b,
                pat_bem a
        where   c.nr_seq_bem = a.nr_sequencia
        and     b.nr_seq_bem = a.nr_sequencia
        and     c.nr_lote_contabil = nr_lote_contabil_p
        and     b.nr_lote_contabil = nr_lote_contabil_p
        
union all

        /* Contabilizar o valor ADICIONAL da reavaliacao POSITIVA */

        select  8,
                a.cd_conta_contabil,
                a.cd_centro_custo,
                a.vl_original,
                a.nr_sequencia,
                'PAT_BEM' nm_tabela,
                'VL_ORIGINAL' nm_atributo,
                82 nr_seq_info_ctb, /* Patrimonio - Aumento de valor */
                a.cd_bem,
                a.nr_seq_proj_rec
        from    pat_bem a
        where   a.nr_lote_contabil      = nr_lote_contabil_p
        
union all

        /* Contabilizar o valor ah BAIXAR da reavaliacao NEGATIVA */

        select  9,
                b.cd_conta_contabil,
                b.cd_centro_custo,
                c.vl_ajuste,
                a.nr_sequencia,
                'PAT_BEM_AVALIACAO' nm_tabela,
                'VL_AJUSTE' nm_atributo,
                83 nr_seq_info_ctb, /* Reavaliacao - Diminuicao de valor */
                a.cd_bem,
                a.nr_seq_proj_rec
        from    pat_bem_avaliacao c,
                pat_valor_bem b,
                pat_bem a
        where   c.nr_seq_bem = a.nr_sequencia
        and     b.nr_seq_bem = a.nr_sequencia
        and     c.nr_lote_contabil = nr_lote_contabil_p
        and     b.nr_lote_contabil = nr_lote_contabil_p
        and     c.nr_seq_tipo_aval = 2;

c02 CURSOR FOR
        /* Quando o estabelecimento eh ORIGEM */

        SELECT  b.nr_sequencia nr_seq_bem,
                b.cd_conta_contabil cd_conta_contabil_bem,
                b.cd_centro_custo cd_centro_custo_bem,
                b.cd_bem,
                substr(trim(both b.ds_bem),1,255) ds_bem,
                b.cd_bem_externo,
                a.cd_estab_origem cd_estab_origem,
                a.cd_estab_destino cd_estab_destino,
                a.vl_transf_deprec_mes vl_transf_bem,
                a.vl_transf_deprec_acum vl_transf_deprec_acum,
                a.dt_historico dt_historico_transf,
                'PAT_HISTORICO_BEM' nm_tabela,
                85 nr_seq_info_ctb,
                a.nr_sequencia nr_seq_hist_transf,
                CASE WHEN cd_estabelecimento_w=a.cd_estab_destino THEN 'D' WHEN cd_estabelecimento_w=a.cd_estab_origem THEN 'O' END  ie_origem_destino,
                a.cd_centro_custo_ant,
                a.cd_centro_custo_atual,
                b.nr_seq_regra_conta,
                b.nr_seq_proj_rec
        from    pat_tipo_historico c,
                pat_bem b,
                pat_historico_bem a
        where   b.nr_sequencia          = a.nr_seq_bem
        and     a.nr_seq_tipo           = c.nr_sequencia
        and     c.ie_transferencia      = 'S'
        --and   nvl(ie_contab_rateio_deprec_w,'N') = 'S'
        and     ((a.nr_lote_contabil_orig = nr_lote_contabil_p) or (a.nr_lote_contabil = nr_lote_contabil_p))
        and     ((a.cd_estab_origem = a.cd_estab_destino) or
                (ie_permite_estab_dif_w = 'PCCT' AND cd_conta_transitoria_w IS NOT NULL AND cd_conta_transitoria_w::text <> ''));

type c02_type is table of c02%rowtype;
c02_regs_w              c02_type;
c02_w                   c02%rowtype;

c03 CURSOR FOR
        /* Rateio do estabelecimento ORIGEM */

        SELECT  a.vl_rateio_deprec,
                a.cd_conta_contabil,
                a.nr_sequencia nr_seq_pat_valor_rateio,
                a.cd_centro_custo cd_centro_custo_rateio,
                11 nr_seq_info_ctb,
                'O' ie_origem_destino,
                c.cd_estabelecimento,
                a.nr_seq_hist_orig,
                a.nr_seq_hist_dest
        from    pat_valor_bem_rateio    a,
                centro_custo            c
        where   a.cd_centro_custo       = c.cd_centro_custo
        and     a.nr_seq_hist_dest      = c02_w.nr_seq_hist_transf
        and     ie_contab_rateio_deprec_w = 'S'

union all

        /* Rateio do estabelecimento DESTINO */

        SELECT  a.vl_rateio_deprec,
                a.cd_conta_contabil,
                a.nr_sequencia nr_seq_pat_valor_rateio,
                a.cd_centro_custo cd_centro_custo_rateio,
                11 nr_seq_info_ctb,
                'D' ie_origem_destino,
                c.cd_estabelecimento,
                a.nr_seq_hist_orig,
                a.nr_seq_hist_dest
        from    pat_valor_bem_rateio    a,
                centro_custo            c
        where   a.cd_centro_custo       = c.cd_centro_custo
        and     a.nr_seq_hist_orig      = c02_w.nr_seq_hist_transf
        and     ie_contab_rateio_deprec_w = 'S';

type c03_type is table of c03%rowtype;
c03_regs_w              c03_type;
c03_w                   c03%rowtype;

c04 CURSOR FOR
	SELECT	1,
		a.cd_conta_contabil,
		b.cd_centro_custo,
		d.vl_aitb_periodo,
		d.vl_depreciacao_acumulada,
		d.vl_depreciacao_atual,
		d.vl_depreciacao_liquida,
		d.nr_codigo_controle,
		a.nr_sequencia,
		'MEMORIA_CALCULO_AITB' nm_tabela,
		'VL_AITB_PERIODO' nm_atributo,
		83 nr_seq_info_ctb,
		a.cd_bem,
		d.nr_sequencia nr_seq_tab_orig
	from	memoria_calculo_aitb d,
		pat_valor_bem b,
		pat_bem a
	where	d.nr_seq_bem = a.nr_sequencia
	and	b.nr_seq_bem = a.nr_sequencia
	and	dt_referencia_w		between d.dt_inicio_periodo and d.dt_fim_periodo
	and	b.dt_valor		between dt_ref_inicial_w    and dt_ref_final_w
	and 	b.nr_lote_contabil 	= nr_lote_contabil_p
	and a.nr_sequencia = nr_seq_bem_w;
type c04_type is table of c04_record index by integer;
c04_type_w                 c04_type;

c05 CURSOR FOR
	SELECT 	b.cd_conta_lucro_venda,
			b.cd_conta_debito_fiscal,
			b.cd_conta_perdas_venda
	from 	pat_historico_bem a,
			pat_tipo_historico b
	where 	a.nr_seq_bem = nr_seq_bem_w
	and 	a.dt_historico between dt_ref_inicial_w and dt_ref_final_w;
type c05_type is table of c05_record index by integer;
c05_type_w                 c05_type;

type tb_w_movimento_contabil_w is table of w_movimento_contabil%rowtype index by integer;
w_movimento_contabil_row		tb_w_movimento_contabil_w;

BEGIN
/*Validacao para impedir a geracao em lotes incorretos */

if (ie_exclusao_p <> 'S') then
        select b.cd_tipo_lote_contabil
        into STRICT cd_tipo_lote_contabil_w
        from lote_contabil b
        where b.nr_lote_contabil = nr_lote_contabil_p;
        if (cd_tipo_lote_contabil_w <> 17) then
                CALL wheb_mensagem_pck.exibir_mensagem_abort(261346);
        end if;
end if;
ds_retorno_p := null;

select  trunc(a.dt_referencia,'month'),
        a.cd_estabelecimento,
        a.cd_tipo_lote_contabil,
        obter_se_compl_tipo_lote(a.cd_estabelecimento, a.cd_tipo_lote_contabil),
        b.cd_empresa
into STRICT    dt_referencia_w,
        cd_estabelecimento_w,
        cd_tipo_lote_contabil_w,
        ie_compl_hist_w,
        cd_empresa_w
from    lote_contabil   a,
        estabelecimento b
where   nr_lote_contabil        = nr_lote_contabil_p
and     a.cd_estabelecimento    = b.cd_estabelecimento;

dt_movimento_w := last_day(dt_referencia_w);

select  count(*)
into STRICT    qt_lotes_gerados_w
from    lote_contabil
where   trunc(dt_referencia,'month')    = dt_referencia_w
and     cd_tipo_lote_contabil           = cd_tipo_lote_contabil_w
and     cd_estabelecimento              = cd_estabelecimento_w
and     nr_lote_contabil not in (nr_lote_contabil_p);
if (qt_lotes_gerados_w > 0) and (ie_exclusao_p = 'N') then
        /* Ja existe um lote gerado para este mes de referencia. Verifique. */

        CALL wheb_mensagem_pck.exibir_mensagem_abort(189844);
end if;
/*
A - Analitica
S - Sintatica
G - Grupo do tipo de bem
*/
ie_forma_contab_w       := substr(coalesce(obter_valor_param_usuario(135, 15, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w),'S'),1,1);

SELECT * FROM ctb_obter_regra_estab_dif(cd_estabelecimento_w, cd_tipo_lote_contabil_w, null, ie_permite_estab_dif_w, cd_conta_transitoria_w, cd_historico_ct_w) INTO STRICT ie_permite_estab_dif_w, cd_conta_transitoria_w, cd_historico_ct_w;

select  coalesce(max(ie_taxa_depreciacao),'N'),
        coalesce(max(ie_contab_rateio_deprec),'N')
into STRICT    ie_taxa_depreciacao_w,
        ie_contab_rateio_deprec_w
from    pat_param_contabil
where   cd_estabelecimento = cd_estabelecimento_w;

/* Identifica se eh exclusao do lote */

if (ie_exclusao_p = 'S') then
        CALL ctb_regras_contabil.comprovante_cache_storage(nr_lote_contabil_p, nm_usuario_p);
        delete  from movimento_contabil
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  lote_contabil
        set     vl_credito              = 0,
                vl_debito               = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  pat_valor_bem
        set     nr_lote_contabil        = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  pat_historico_bem
        set     nr_lote_contabil        = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  pat_historico_bem
        set     nr_lote_contabil_orig   = 0
        where   nr_lote_contabil_orig   = nr_lote_contabil_p;

        update  pat_bem
        set     nr_lote_contabil        = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        update  pat_bem_avaliacao
        set     nr_lote_contabil        = 0
        where   nr_lote_contabil        = nr_lote_contabil_p;

        commit;
else
        delete from w_movimento_contabil
  where nr_lote_contabil        = nr_lote_contabil_p;

        dt_ref_inicial_w        := trunc(dt_referencia_w,'month');
        dt_ref_final_w          := (last_day(trunc(dt_referencia_w,'month')) + 86399/86400);

        update  pat_valor_bem a
        set     a.nr_lote_contabil = nr_lote_contabil_p
        where   a.cd_estabelecimento = cd_estabelecimento_w
        and     a.dt_valor between trunc(dt_referencia_w,'month') and last_day(trunc(dt_referencia_w,'month')) + 86399/86400;

        update  pat_historico_bem a
        set     nr_lote_contabil_orig   = nr_lote_contabil_p
        where   a.dt_historico  between trunc(dt_referencia_w,'month') and fim_mes(dt_referencia_w)
        and     coalesce(a.cd_estab_origem,0)        = cd_estabelecimento_w;

        update  pat_historico_bem a
        set     nr_lote_contabil        = nr_lote_contabil_p
        where   a.dt_historico  between trunc(dt_referencia_w,'month') and fim_mes(dt_referencia_w)
        and     a.cd_estab_destino      = cd_estabelecimento_w
        and     coalesce(nr_lote_contabil,0) = 0;


        /* PAT_BEM_AVALIACAO */

        update  pat_bem_avaliacao a
        set     a.nr_lote_contabil = nr_lote_contabil_p
        where   coalesce(a.nr_lote_contabil,0) = 0
        and     a.dt_avaliacao = pkg_date_utils.start_of(dt_referencia_w, 'MONTH', 0)
        and     a.nr_seq_tipo_aval in (1,2) /* 1 - Avaliacao positiva | 2 - Avaliacao negativa */
        and     (a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '');


        /* PAT_BEM */

        update  pat_bem a
        set     a.nr_lote_contabil = nr_lote_contabil_p
        where   coalesce(a.nr_lote_contabil,0) = 0
        and     a.ie_tipo_valor = 'C' /* Custo atribuido - Usado para o bem com valor adicional da reavaliacao */
        and     exists (SELECT  1
                        from    pat_bem_avaliacao b
                        where   b.nr_seq_bem_aval = a.nr_sequencia
                        and     b.nr_lote_contabil = nr_lote_contabil_p);

        commit;

        /* Identifica se deve ratear o valor de depreciacao do mes em transferencias entre centros de custo */

        ie_rateio_deprec_transf_w       := coalesce(substr(Obter_valor_Param_Usuario(937,104,obter_perfil_ativo,nm_usuario_p,cd_estabelecimento_w),1,1),'N');
        nm_agrupador_w  := coalesce(trim(both obter_agrupador_contabil(17)),'DS_MES_ANO');

	    ie_contador_w := 0;

        open c_valor_bem;
        loop
        fetch c_valor_bem into
                ie_movimento_w,
                cd_conta_contabil_w,
                cd_centro_custo_w,
                vl_movimento_w,
                nr_seq_bem_w,
                nm_tabela_w,
                nm_atributo_w,
                nr_seq_info_ctb_w,
                cd_bem_docto_w,
                nr_seq_proj_rec_w;
        EXIT WHEN NOT FOUND; /* apply on c_valor_bem */
                nr_seq_bem_info_w := nr_seq_bem_w;
                nr_sequencia_movto_w            := nr_sequencia_movto_w + 1;
                ds_compl_historico_w            := null;
                ds_compl_historico_w            := '';
                ds_estorno_w                    := '';
                cd_conta_rec_baixa_dep_w        := '';
                vl_movto_ajuste_capital_w       := 0;

                if (nm_tabela_w = 'PAT_VALOR_BEM') then
                        select  max(a.nr_sequencia)
                        into STRICT    nr_seq_tab_orig_w
                        from    pat_valor_bem   a
                        where   a.nr_seq_bem    = nr_seq_bem_w
                        and     a.dt_valor between dt_ref_inicial_w and dt_ref_final_w;
                elsif (nm_tabela_w = 'PAT_VALOR_BEM_RATEIO') then
                        select  max(a.nr_sequencia)
                        into STRICT    nr_seq_tab_orig_w
                        from    pat_valor_bem   a
                        where   a.nr_seq_bem    = nr_seq_bem_w
                        and     a.dt_valor between dt_ref_inicial_w and dt_ref_final_w;

                        select  max(a.nr_sequencia)
                        into STRICT    nr_seq_tab_orig_w
                        from    pat_valor_bem_rateio    a
                        where   a.nr_seq_valor  = nr_seq_tab_orig_w;
                end if;

                select  coalesce(max(nr_seq_regra_conta),0),
                        max(ie_tipo_valor)
                into STRICT    nr_seq_regra_conta_w,
                        ie_tipo_valor_w
                from    pat_bem
                where   nr_sequencia    = nr_seq_bem_w;

                select  count(*)
                into STRICT    qt_registros_w
                from    pat_conta_alteracao
                where   nr_seq_bem = nr_seq_bem_w;

                if (qt_registros_w > 0) then
                        nr_seq_regra_conta_w    := coalesce(pat_obter_regra_conta_bem(nr_seq_bem_w, dt_referencia_w), nr_seq_regra_conta_w);
                end if;

                if (ie_movimento_w in (1,4)) then
                        if (ie_forma_contab_w = 'S') then
                                nr_seq_bem_w    := 0;
                        end if;
                end if;

                if (ie_forma_contab_w = 'G') then
                        begin
                        select  c.nr_sequencia
                        into STRICT    nr_seq_bem_w
                        from    pat_tipo_bem    b,
                                pat_grupo_tipo  c,
                                pat_bem         a
                        where   b.nr_sequencia  = a.nr_seq_tipo
                        and     c.nr_sequencia  = b.nr_seq_grupo
                        and     a.nr_sequencia  = nr_seq_bem_w;
                        exception when others then
                                nr_seq_bem_w    := null;
                        end;
                end if;

                if (nr_seq_regra_conta_w = 0) then
                        begin
                        select  cd_conta_deprec_acum,
                                cd_conta_deprec_res,
                                cd_conta_baixa,
                                cd_historico,
                                cd_hist_baixa,
                                cd_conta_ajuste_pat,
                                cd_conta_cap_social,
                                cd_hist_ajuste_pat,
                                cd_hist_entrada_aval,
                                cd_conta_entrada_aval,
								cd_conta_ativo_aitb,
								cd_conta_passivo_aitb
                        into STRICT    cd_conta_deprec_acum_w,
                                cd_conta_deprec_res_w,
                                cd_conta_baixa_w,
                                cd_historico_w,
                                cd_historico_baixa_w,
                                cd_conta_ajuste_pat_w,
                                cd_conta_cap_social_w,
                                cd_hist_ajuste_pat_w,
                                cd_hist_entrada_aval_w,
                                cd_conta_entrada_aval_w,
								cd_conta_ativo_aitb_w,
								cd_conta_passivo_aitb_w
                        from    pat_conta_contabil a
                        where   a.nr_sequencia =        (SELECT min(y.nr_sequencia)
                                                from    pat_conta_contabil y
                                                where   coalesce(y.cd_estabelecimento,cd_estabelecimento_w)  = cd_estabelecimento_w
                                                and     y.cd_conta_contabil     = cd_conta_contabil_w
                                                and     coalesce(y.cd_empresa,cd_empresa_w)  = cd_empresa_w
                                                and     y.dt_vigencia           <= dt_referencia_w
                                                and     y.ie_situacao = 'A')
                        and     a.ie_situacao = 'A';
                        exception
                        when no_data_found then
                                select  max(cd_bem),
                                        max(ds_bem)
                                into STRICT    cd_bem_w,
                                        ds_bem_w
                                from    pat_bem
                                where   nr_sequencia = nr_seq_bem_info_w;
                                --'nao existe conta contabil: ' || cd_conta_contabil_w ||

                                --' no cadastro de contas do patrimonio (funcoes/cadastros/patrimonio/contas) nesta vigencia');
                                CALL wheb_mensagem_pck.exibir_mensagem_abort(1146525, 'cd_conta_contabil_w='||cd_conta_contabil_w||';'||
                                                                                 'ds_conta_contabil='||obter_desc_conta_contabil(cd_conta_contabil_w)||';'||
                                                                                'nr_seq_bem='||nr_seq_bem_info_w||';'||
                                                                                'cd_bem='||cd_bem_w||';'||
                                                                                'ds_bem='||ds_bem_w);
                        end;
                else
                        begin
                        select  cd_conta_deprec_acum,
                                cd_conta_deprec_res,
                                cd_conta_baixa,
                                cd_historico,
                                cd_hist_baixa,
                                cd_conta_ajuste_pat,
                                cd_conta_cap_social,
                                cd_hist_ajuste_pat,
                                cd_hist_entrada_aval,
                                cd_conta_entrada_aval,
								cd_conta_ativo_aitb,
								cd_conta_passivo_aitb
                        into STRICT    cd_conta_deprec_acum_w,
                                cd_conta_deprec_res_w,
                                cd_conta_baixa_w,
                                cd_historico_w,
                                cd_historico_baixa_w,
                                cd_conta_ajuste_pat_w,
                                cd_conta_cap_social_w,
                                cd_hist_ajuste_pat_w,
                                cd_hist_entrada_aval_w,
                                cd_conta_entrada_aval_w,
								cd_conta_ativo_aitb_w,
								cd_conta_passivo_aitb_w
                        from    pat_conta_contabil
                        where   nr_sequencia    = nr_seq_regra_conta_w
                        and     ie_situacao = 'A';
                        exception
                        when no_data_found then
                                select  max(cd_bem),
                                        max(ds_bem)
                                into STRICT    cd_bem_w,
                                        ds_bem_w
                                from    pat_bem
                                where   nr_sequencia = nr_seq_bem_info_w;
                                --'Nao existe conta contabil: ' || cd_conta_contabil_w ||

                                --' no cadastro de contas do patrimonio (funcoes/cadastros/patrimonio/contas) nesta vigencia');
                                CALL wheb_mensagem_pck.exibir_mensagem_abort(1146525, 'cd_conta_contabil_w='||cd_conta_contabil_w||';'||
                                                                                 'ds_conta_contabil='||obter_desc_conta_contabil(cd_conta_contabil_w)||';'||
                                                                                'nr_seq_bem='||nr_seq_bem_info_w||';'||
                                                                                'cd_bem='||cd_bem_w||';'||
                                                                                'ds_bem='||ds_bem_w);
                        end;
                end if;

                cd_centro_debito_w              := null;
                cd_centro_credito_w             := null;
                ie_devolucao_w                  := 'N';

                if (ie_movimento_w in (2,3)) then
                        select  max(a.nr_sequencia)
                        into STRICT    nr_seq_baixa_w
                        from    pat_historico_bem a,
                                pat_tipo_historico b
                        where   a.nr_seq_tipo   = b.nr_sequencia
                        and     b.ie_transferencia = 'N'
                        and     b.ie_valor in ('B','V')
                        and     a.nr_seq_bem    = nr_seq_bem_w
                        and     dt_historico between trunc(dt_referencia_w,'mm') and fim_mes(dt_referencia_w);

                        select  max(nr_seq_tipo)
                        into STRICT    nr_seq_tipo_hist_w
                        from    pat_historico_bem
                        where   nr_sequencia    = nr_seq_baixa_w;

                        select  coalesce(max(cd_conta_baixa),''),
                                coalesce(max(cd_hist_baixa),''),
                                coalesce(max(ie_devolucao),'N'),
                                coalesce(max(cd_conta_rec_baixa_dep),'')
                        into STRICT    cd_conta_baixa_tipo_w,
                                cd_hist_baixa_tipo_w,
                                ie_devolucao_w,
                                cd_conta_rec_baixa_dep_w
                        from    pat_tipo_historico
                        where   nr_sequencia    = nr_seq_tipo_hist_w;

                        cd_conta_baixa_w        := coalesce(cd_conta_baixa_tipo_w, cd_conta_baixa_w);
                        cd_historico_baixa_w    := coalesce(cd_hist_baixa_tipo_w, cd_historico_baixa_w);
                end if;

                if (ie_movimento_w = 1) then
                        cd_conta_debito_w       := cd_conta_deprec_res_w;
                        cd_conta_credito_w      := cd_conta_deprec_acum_w;
                        cd_centro_debito_w      := cd_centro_custo_w;
                elsif (ie_movimento_w = 2) then
                        cd_conta_debito_w       := cd_conta_baixa_w;
                        cd_conta_credito_w      := cd_conta_contabil_w;
                        cd_historico_w          := cd_historico_baixa_w;
                        if (Obter_ie_centro_conta(cd_conta_baixa_w) = 'S') then
                            cd_centro_debito_w := cd_centro_custo_w;
                        else
                            cd_centro_debito_w := null;
                        end if;
                        if (Obter_ie_centro_conta(cd_conta_contabil_w) = 'S') then
                            cd_centro_credito_w := cd_centro_custo_w;
                        else
                            cd_centro_credito_w := null;
                        end if;
                elsif (ie_movimento_w = 3) then
                        cd_conta_debito_w       := cd_conta_deprec_acum_w;
                        cd_conta_credito_w      := coalesce(cd_conta_rec_baixa_dep_w,cd_conta_baixa_w);
                        cd_historico_w          := cd_historico_baixa_w;
                        cd_centro_credito_w     := cd_centro_custo_w;
                        ds_estorno_w            := wheb_mensagem_pck.get_texto(798657);
                elsif (ie_movimento_w = 4) then
                        cd_conta_debito_w       := cd_conta_contabil_w;
                        cd_conta_credito_w      := cd_conta_deprec_acum_w;
                        cd_centro_debito_w      := cd_centro_custo_w;

                        if (Obter_ie_centro_conta(cd_conta_contabil_w) = 'S') then
                            cd_centro_debito_w := cd_centro_custo_w;
                        else
                            cd_centro_debito_w := null;
                        end if;

                        if (Obter_ie_centro_conta(cd_conta_deprec_acum_w) = 'S') then
                            cd_centro_credito_w := cd_centro_custo_w;
                        else
                            cd_centro_credito_w := null;
                        end if;

                elsif (ie_movimento_w in (5,6)) then

                        begin

                        select  min(nr_sequencia)
                        into STRICT    nr_seq_regra_subvencao_w
                        from    pat_bem_subvencao
                        where   nr_seq_bem      = nr_seq_bem_w
                        and     dt_inicio_vigencia              <= dt_referencia_w
                        and     coalesce(dt_fim_vigencia,clock_timestamp()) >= dt_referencia_w;

                        select  cd_conta_subvencao,
                                cd_historico,
                                cd_centro_custo_rec,
                                cd_conta_receita_sub
                        into STRICT    cd_conta_debito_w,
                                cd_historico_w,
                                cd_centro_credito_w,
                                cd_conta_credito_w
                        from    pat_bem_subvencao
                        where   nr_sequencia    = nr_seq_regra_subvencao_w;
                        exception when no_data_found then
                                select  max(ds_bem)
                                into STRICT    ds_bem_w
                                from    pat_bem
                                where   nr_sequencia    = nr_seq_bem_w;

                                --'Falta cadastrar as contas para a contabilizacao da subvencao' || chr(13) ||

                                --'do bem ' || ds_bem_w || ' ( ' || nr_seq_bem_w ||')#@#@');
                                CALL wheb_mensagem_pck.exibir_mensagem_abort(189846,'ds_bem_w='||ds_bem_w||';'||
                                                                                'nr_seq_bem_w'||nr_seq_bem_w);

                        end;

                        if (ie_movimento_w = 6) then
                                cd_centro_credito_w     := cd_centro_custo_w;
                        end if;

                elsif (ie_movimento_w = 7) then
                        cd_conta_debito_w       := cd_conta_deprec_acum_w;
                        cd_conta_credito_w      := cd_conta_contabil_w;
                        cd_historico_w          := cd_hist_ajuste_pat_w;
                        cd_centro_debito_w      := null;
                        cd_centro_credito_w     := null;

                        if (Obter_ie_centro_conta(cd_conta_deprec_acum_w) = 'S') then
                            cd_centro_debito_w := cd_centro_custo_w;
                        else
                            cd_centro_debito_w := null;
                        end if;

                        if (Obter_ie_centro_conta(cd_conta_contabil_w) = 'S') then
                            cd_centro_credito_w := cd_centro_custo_w;
                        else
                            cd_centro_credito_w := null;
                        end if;

                elsif (ie_movimento_w = 8) then
                        cd_conta_debito_w       := cd_conta_contabil_w;
                        cd_conta_credito_w      := cd_conta_entrada_aval_w;
                        cd_historico_w          := cd_hist_entrada_aval_w;
                        cd_centro_debito_w      := null;
                        cd_centro_credito_w     := null;

                elsif (ie_movimento_w = 9) then
                        cd_conta_debito_w       := cd_conta_entrada_aval_w;
                        cd_conta_credito_w      := cd_conta_contabil_w;
                        cd_historico_w          := cd_hist_entrada_aval_w;

                        if (Obter_ie_centro_conta(cd_conta_entrada_aval_w) = 'S') then
                            cd_centro_debito_w := cd_centro_custo_w;
                        else
                            cd_centro_debito_w := null;
                        end if;

                        if (Obter_ie_centro_conta(cd_conta_contabil_w) = 'S') then
                            cd_centro_credito_w := cd_centro_custo_w;
                        else
                            cd_centro_credito_w := null;
                        end if;
                end if;

                if (ie_movimento_w = 2) and (ie_devolucao_w = 'S') then
                        vl_movimento_w  := 0;
                end if;
                ds_mesano_w     :=      to_char(dt_referencia_w,'mmyyyy');

                if (nm_agrupador_w = 'NR_SEQ_BEM')then
                          nr_seq_agrupamento_w          := nr_seq_bem_w;
                elsif (nm_agrupador_w = 'DS_MES_ANO')then
                          nr_seq_agrupamento_w          := ds_mesano_w;
                end if;

                if (coalesce(nr_seq_agrupamento_w,0) = 0)then
                        nr_seq_agrupamento_w := ds_mesano_w;
                end if;

                if (nr_seq_bem_w > 0) then
                        select  max(cd_bem)
                        into STRICT    ds_compl_historico_w
                        from    pat_bem
                        where   nr_sequencia    = nr_seq_bem_w;
                else
                        ds_compl_historico_w    := null;
                end if;


                if (ie_compl_hist_w = 'S') then
                        select  max(cd_bem),
                                trim(both substr(max(ds_bem),1,50)),
                                max(cd_bem_externo)
                        into STRICT    cd_bem_w,
                                ds_bem_w,
                                cd_bem_externo_w
                        from    pat_bem
                        where   nr_sequencia    = nr_seq_bem_w;

                        select  substr(obter_mes_extenso(substr(obter_desc_mes_ano(dt_referencia_w,'N'),1,2),'A'),1,20) ||
                                        '/' || substr(to_char(dt_referencia_w,'dd/mm/yyyy'),7,4)
                        into STRICT    ds_mesano_referencia_w
;

                        ds_conteudo_w   := substr(      cd_bem_w                        || '#@' ||
                                                                                dt_referencia_w                 || '#@' ||
                                                                                ds_mesano_referencia_w          || '#@' ||
                                                                                ds_bem_w                        || '#@' ||
                                                                                ''                              || '#@' ||
                                                                                ds_estorno_w                    || '#@' ||
                                                                                cd_bem_externo_w                || '#@' ||
                                                                                '',1,4000);

                        select  substr(obter_compl_historico(cd_tipo_lote_contabil_w, cd_historico_w, ds_conteudo_w),1,255)
                        into STRICT    ds_compl_historico_ww
;

                        ds_compl_historico_w    := substr(coalesce(ds_compl_historico_ww, ds_compl_historico_w),1,255);
                end if;

                ds_compl_historico_w            := substr(ds_compl_historico_w,1,255);

                if (coalesce(cd_centro_debito_w,0) <> 0) then
                        select  coalesce(max(ie_situacao),'I')
                        into STRICT    ie_situacao_w
                        from    centro_custo
                        where   cd_centro_custo = cd_centro_debito_w;

                        if (ie_situacao_w = 'I') then
                                --'o centro de custo: ' || cd_centro_debito_w || ' esta inativo!');
                                CALL wheb_mensagem_pck.exibir_mensagem_abort(189847,'cd_centro_w='||cd_centro_debito_w);
                        end if;
                end if;

                if (coalesce(cd_centro_credito_w,0) <> 0) then
                        select  coalesce(max(ie_situacao),'I')
                        into STRICT    ie_situacao_w
                        from    centro_custo
                        where   cd_centro_custo = cd_centro_credito_w;

                        if (ie_situacao_w = 'I') then
                                --'o centro de custo: ' || cd_centro_credito_w || ' esta inativo!');
                                CALL wheb_mensagem_pck.exibir_mensagem_abort(189847,'cd_centro_w='||cd_centro_credito_w);
                        end if;
                end if;

                select  coalesce(max(ie_centro_custo),'S')
                into STRICT    ie_centro_custo_w
                from    conta_contabil
                where   cd_conta_contabil       = cd_conta_debito_w;

                if (ie_centro_custo_w = 'N') then
                        cd_centro_debito_w      := null;
                end if;

                if (coalesce(nr_seq_bem_w,'0') <> '0') then
                        ds_atributos_w  := null;

                        ds_atributos_w  :=      'NR_SEQ_BEM=' || nr_seq_bem_w || ';' ||
                                                'CD_BEM=' || cd_bem_docto_w;

                        ctb_obter_doc_movto(    cd_tipo_lote_contabil_w,
                                                nm_atributo_w,
                                                'VR',
                                                dt_movimento_w,
                                                null,
                                                null,
                                                ds_atributos_w,
                                                nm_usuario_p,
                                                ie_regra_w,
                                                nr_doc_aux_w,
                                                ie_origem_documento_w);
                end if;

                if (coalesce(cd_conta_debito_w,'X') <> 'X') then
                        insert into w_movimento_contabil(nr_lote_contabil,
                                nr_sequencia,
                                cd_conta_contabil,
                                ie_debito_credito,
                                cd_historico,
                                dt_movimento,
                                vl_movimento,
                                cd_centro_custo,
                                ds_compl_historico,
                                ds_doc_agrupamento,
                                nr_seq_agrupamento,
                                nr_seq_trans_fin,
                                cd_cgc,
                                cd_pessoa_fisica,
                                nr_documento,
                                ie_transitorio,
                                ie_origem_documento,
                                nr_seq_info,
                                nr_seq_tab_orig,
                                nm_tabela,
                                nm_atributo,
                                cd_estabelecimento,
                                nr_seq_proj_rec)
                        values (nr_lote_contabil_p,
                                nr_sequencia_movto_w,
                                cd_conta_debito_w,
                                'D',
                                cd_historico_w,
                                dt_movimento_w,
                                vl_movimento_w,
                                cd_centro_debito_w,
                                ds_compl_historico_w,
                                '0',
                                nr_seq_agrupamento_w,
                                null,
                                null,
                                null,
                                nr_doc_aux_w,
                                'N',
                                ie_origem_documento_w,
                                nr_seq_info_ctb_w,
                                nr_seq_tab_orig_w,
                                nm_tabela_w,
                                nm_atributo_w,
                                CASE WHEN coalesce(cd_centro_debito_w::text, '') = '' THEN null  ELSE obter_estab_centro_custo(cd_centro_debito_w) END ,
                                nr_seq_proj_rec_w);
                end if;

                select  coalesce(max(ie_centro_custo),'S')
                into STRICT    ie_centro_custo_w
                from    conta_contabil
                where   cd_conta_contabil = cd_conta_credito_w;

                if (ie_centro_custo_w = 'N') then
                        cd_centro_credito_w     := null;
                end if;

                if (coalesce(cd_conta_credito_w,'X') <> 'X') then
                        insert into w_movimento_contabil(nr_lote_contabil,
                                nr_sequencia,
                                cd_conta_contabil,
                                ie_debito_credito,
                                cd_historico,
                                dt_movimento,
                                vl_movimento,
                                cd_centro_custo,
                                ds_compl_historico,
                                ds_doc_agrupamento,
                                nr_seq_agrupamento,
                                nr_seq_trans_fin,
                                cd_cgc,
                                cd_pessoa_fisica,
                                nr_documento,
                                ie_transitorio,
                                ie_origem_documento,
                                nr_seq_info,
                                nr_seq_tab_orig,
                                nm_tabela,
                                nm_atributo,
                                cd_estabelecimento,
                                nr_seq_proj_rec)
                        values (nr_lote_contabil_p,
                                nr_sequencia_movto_w,
                                cd_conta_credito_w,
                                'C',
                                cd_historico_w,
                                dt_movimento_w,
                                vl_movimento_w,
                                cd_centro_credito_w,
                                ds_compl_historico_w,
                                '0',
                                nr_seq_agrupamento_w,
                                null,
                                null,
                                null,
                                nr_doc_aux_w,
                                'N',
                                ie_origem_documento_w,
                                nr_seq_info_ctb_w,
                                nr_seq_tab_orig_w,
                                nm_tabela_w,
                                nm_atributo_w,
                                CASE WHEN coalesce(cd_centro_credito_w::text, '') = '' THEN null  ELSE obter_estab_centro_custo(cd_centro_credito_w) END ,
                                nr_seq_proj_rec_w);
                end if;

                if (ie_movimento_w in (1,2,3,4)) and (ie_tipo_valor_w = 'C') and (coalesce(cd_conta_ajuste_pat_w,'X') <> 'X') and (coalesce(cd_conta_cap_social_w,'X') <> 'X') and (coalesce(cd_hist_ajuste_pat_w,0) <> 0) then
                        if (ie_movimento_w in (2,3)) then
                                cd_hist_ajuste_pat_w    := cd_historico_baixa_w;
                        end if;

                        if (ie_movimento_w in (1,4)) then
                                insert into w_movimento_contabil(nr_lote_contabil,
                                        nr_sequencia,
                                        cd_conta_contabil,
                                        ie_debito_credito,
                                        cd_historico,
                                        dt_movimento,
                                        vl_movimento,
                                        cd_centro_custo,
                                        ds_compl_historico,
                                        ds_doc_agrupamento,
                                        nr_seq_agrupamento,
                                        nr_seq_trans_fin,
                                        cd_cgc,
                                        cd_pessoa_fisica,
                                        nr_documento,
                                        ie_transitorio,
                                        ie_origem_documento,
                                        nr_seq_info,
                                        nr_seq_tab_orig,
                                        nm_tabela,
                                        nm_atributo,
                                        nr_seq_proj_rec)
                                values (nr_lote_contabil_p,
                                        nr_sequencia_movto_w,
                                        cd_conta_ajuste_pat_w,
                                        'D',
                                        cd_hist_ajuste_pat_w,
                                        dt_movimento_w,
                                        vl_movimento_w,
                                        null,
                                        ds_compl_historico_w,
                                        '0',
                                        nr_seq_agrupamento_w,
                                        null,
                                        null,
                                        null,
                                        nr_doc_aux_w,
                                        'N',
                                        ie_origem_documento_w,
                                        nr_seq_info_ctb_w,
                                        nr_seq_tab_orig_w,
                                        nm_tabela_w,
                                        nm_atributo_w,
                                        nr_seq_proj_rec_w);

                                insert into w_movimento_contabil(nr_lote_contabil,
                                        nr_sequencia,
                                        cd_conta_contabil,
                                        ie_debito_credito,
                                        cd_historico,
                                        dt_movimento,
                                        vl_movimento,
                                        cd_centro_custo,
                                        ds_compl_historico,
                                        ds_doc_agrupamento,
                                        nr_seq_agrupamento,
                                        nr_seq_trans_fin,
                                        cd_cgc,
                                        cd_pessoa_fisica,
                                        nr_documento,
                                        ie_transitorio,
                                        ie_origem_documento,
                                        nr_seq_info,
                                        nr_seq_tab_orig,
                                        nm_tabela,
                                        nm_atributo,
                                        nr_seq_proj_rec)
                                values (nr_lote_contabil_p,
                                        nr_sequencia_movto_w,
                                        cd_conta_cap_social_w,
                                        'C',
                                        cd_hist_ajuste_pat_w,
                                        dt_movimento_w,
                                        vl_movimento_w,
                                        null,
                                        ds_compl_historico_w,
                                        '0',
                                        nr_seq_agrupamento_w,
                                        null,
                                        null,
                                        null,
                                        nr_doc_aux_w,
                                        'N',
                                        ie_origem_documento_w,
                                        nr_seq_info_ctb_w,
                                        nr_seq_tab_orig_w,
                                        nm_tabela_w,
                                        nm_atributo_w,
                                        nr_seq_proj_rec_w);
                        elsif (ie_movimento_w = 2) then
                                begin
                                select  coalesce(vl_baixa_deprec,0)
                                into STRICT    vl_baixa_deprec_w
                                from    pat_valor_bem
                                where   nr_seq_bem              = nr_seq_bem_w
                                and     nr_lote_contabil        = nr_lote_contabil_p;
                                exception when others then
                                        vl_baixa_deprec_w       := 0;
                                end;

                                vl_movto_ajuste_capital_w       := vl_movimento_w - vl_baixa_deprec_w;

                                insert into w_movimento_contabil(nr_lote_contabil,
                                        nr_sequencia,
                                        cd_conta_contabil,
                                        ie_debito_credito,
                                        cd_historico,
                                        dt_movimento,
                                        vl_movimento,
                                        cd_centro_custo,
                                        ds_compl_historico,
                                        ds_doc_agrupamento,
                                        nr_seq_agrupamento,
                                        nr_seq_trans_fin,
                                        cd_cgc,
                                        cd_pessoa_fisica,
                                        nr_documento,
                                        ie_transitorio,
                                        ie_origem_documento,
                                        nr_seq_info,
                                        nr_seq_tab_orig,
                                        nm_tabela,
                                        nm_atributo,
                                        nr_seq_proj_rec)
                                values (nr_lote_contabil_p,
                                        nr_sequencia_movto_w,
                                        cd_conta_ajuste_pat_w,
                                        'D',
                                        cd_hist_ajuste_pat_w,
                                        dt_movimento_w,
                                        vl_movto_ajuste_capital_w,
                                        null,
                                        ds_compl_historico_w,
                                        '0',
                                        nr_seq_agrupamento_w,
                                        null,
                                        null,
                                        null,
                                        nr_doc_aux_w,
                                        'N',
                                        ie_origem_documento_w,
                                        nr_seq_info_ctb_w,
                                        nr_seq_tab_orig_w,
                                        nm_tabela_w,
                                        nm_atributo_w,
                                        nr_seq_proj_rec_w);

                                insert into w_movimento_contabil(nr_lote_contabil,
                                        nr_sequencia,
                                        cd_conta_contabil,
                                        ie_debito_credito,
                                        cd_historico,
                                        dt_movimento,
                                        vl_movimento,
                                        cd_centro_custo,
                                        ds_compl_historico,
                                        ds_doc_agrupamento,
                                        nr_seq_agrupamento,
                                        nr_seq_trans_fin,
                                        cd_cgc,
                                        cd_pessoa_fisica,
                                        nr_documento,
                                        ie_transitorio,
                                        ie_origem_documento,
                                        nr_seq_info,
                                        nr_seq_tab_orig,
                                        nm_tabela,
                                        nm_atributo,
                                        nr_seq_proj_rec)
                                values (nr_lote_contabil_p,
                                        nr_sequencia_movto_w,
                                        cd_conta_cap_social_w,
                                        'C',
                                        cd_hist_ajuste_pat_w,
                                        dt_movimento_w,
                                        vl_movto_ajuste_capital_w,
                                        null,
                                        ds_compl_historico_w,
                                        '0',
                                        nr_seq_agrupamento_w,
                                        null,
                                        null,
                                        null,
                                        nr_doc_aux_w,
                                        'N',
                                        ie_origem_documento_w,
                                        nr_seq_info_ctb_w,
                                        nr_seq_tab_orig_w,
                                        nm_tabela_w,
                                        nm_atributo_w,
                                        nr_seq_proj_rec_w);
                        end if;
                end if;
				
				if (pkg_i18n.get_user_locale = 'es_BO' and ie_exclusao_p = 'N') then
				

					ie_ja_contabilizado_w := 'N';
					for ie_bem_atual_w in 1..bens_w.count loop
						if (bens_w(ie_bem_atual_w) = nr_seq_bem_w) then
							ie_ja_contabilizado_w := 'S';
							exit;
						end if;
					end loop;
					
					if (ie_ja_contabilizado_w = 'N') then
						open 	c04;
						fetch 	c04 bulk collect into c04_type_w;
						close 	c04;
						ie_contador_w := ie_contador_w + 1;
						bens_w(ie_contador_w) := nr_seq_bem_w;
						
						if (c04_type_w.first IS NOT NULL AND c04_type_w.first::text <> '') then
							for i in c04_type_w.first..c04_type_w.last loop
								if (nr_seq_regra_conta_w <> 0) then
									if (c04_type_w[i].vl_aitb_periodo != 0) then
										nr_sequencia_movto_w := nr_sequencia_movto_w + 1;
										w_movimento_contabil_row[ie_cont_registros_w].nr_lote_contabil 	:= nr_lote_contabil_p;
										w_movimento_contabil_row[ie_cont_registros_w].nr_sequencia		:= nr_sequencia_movto_w;
										w_movimento_contabil_row[ie_cont_registros_w].cd_conta_contabil	:= c04_type_w[i].cd_conta_contabil;
										w_movimento_contabil_row[ie_cont_registros_w].ie_debito_credito	:= 'D';
										w_movimento_contabil_row[ie_cont_registros_w].cd_historico		:= cd_historico_w;
										w_movimento_contabil_row[ie_cont_registros_w].dt_movimento		:= dt_movimento_w;
										w_movimento_contabil_row[ie_cont_registros_w].vl_movimento		:= c04_type_w[i].vl_aitb_periodo;
										w_movimento_contabil_row[ie_cont_registros_w].ds_compl_historico	:= ds_compl_historico_w;
										w_movimento_contabil_row[ie_cont_registros_w].ds_doc_agrupamento	:= '0';
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_agrupamento	:= nr_seq_agrupamento_w;
										w_movimento_contabil_row[ie_cont_registros_w].nr_documento		:= ' ';
										w_movimento_contabil_row[ie_cont_registros_w].ie_transitorio		:= 'N';
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_info		:= c04_type_w[i].nr_seq_info_ctb;
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_tab_orig	:= c04_type_w[i].nr_seq_tab_orig;
										w_movimento_contabil_row[ie_cont_registros_w].nm_tabela			:= c04_type_w[i].nm_tabela;
										w_movimento_contabil_row[ie_cont_registros_w].nm_atributo		:= 'VL_AITB_PERIODO';
										w_movimento_contabil_row[ie_cont_registros_w].cd_estabelecimento	:= cd_estabelecimento_w;
										ie_cont_registros_w := ie_cont_registros_w + 1;
										
										nr_sequencia_movto_w := nr_sequencia_movto_w + 1;
										w_movimento_contabil_row[ie_cont_registros_w].nr_lote_contabil 	:= nr_lote_contabil_p;
										w_movimento_contabil_row[ie_cont_registros_w].nr_sequencia		:= nr_sequencia_movto_w;
										w_movimento_contabil_row[ie_cont_registros_w].cd_conta_contabil	:= cd_conta_ativo_aitb_w;
										w_movimento_contabil_row[ie_cont_registros_w].ie_debito_credito	:= 'C';
										w_movimento_contabil_row[ie_cont_registros_w].cd_historico		:= cd_historico_w;
										w_movimento_contabil_row[ie_cont_registros_w].dt_movimento		:= dt_movimento_w;
										w_movimento_contabil_row[ie_cont_registros_w].vl_movimento		:= c04_type_w[i].vl_aitb_periodo;
										w_movimento_contabil_row[ie_cont_registros_w].ds_compl_historico	:= ds_compl_historico_w;
										w_movimento_contabil_row[ie_cont_registros_w].ds_doc_agrupamento	:= '0';
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_agrupamento	:= nr_seq_agrupamento_w;
										w_movimento_contabil_row[ie_cont_registros_w].nr_documento		:= ' ';
										w_movimento_contabil_row[ie_cont_registros_w].ie_transitorio		:= 'N';
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_info		:= c04_type_w[i].nr_seq_info_ctb;
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_tab_orig	:= c04_type_w[i].nr_seq_tab_orig;
										w_movimento_contabil_row[ie_cont_registros_w].nm_tabela			:= c04_type_w[i].nm_tabela;
										w_movimento_contabil_row[ie_cont_registros_w].nm_atributo		:= 'VL_AITB_PERIODO';
										w_movimento_contabil_row[ie_cont_registros_w].cd_estabelecimento	:= cd_estabelecimento_w;
										ie_cont_registros_w := ie_cont_registros_w + 1;
									end if;
								
								
									if (c04_type_w[i].vl_depreciacao_acumulada != 0) then
										nr_sequencia_movto_w := nr_sequencia_movto_w + 1;
										w_movimento_contabil_row[ie_cont_registros_w].nr_lote_contabil 	:= nr_lote_contabil_p;
										w_movimento_contabil_row[ie_cont_registros_w].nr_sequencia		:= nr_sequencia_movto_w;
										w_movimento_contabil_row[ie_cont_registros_w].cd_conta_contabil	:= cd_conta_passivo_aitb_w;
										w_movimento_contabil_row[ie_cont_registros_w].ie_debito_credito	:= 'D';
										w_movimento_contabil_row[ie_cont_registros_w].cd_historico		:= cd_historico_w;
										w_movimento_contabil_row[ie_cont_registros_w].dt_movimento		:= dt_movimento_w;
										w_movimento_contabil_row[ie_cont_registros_w].vl_movimento		:= c04_type_w[i].vl_depreciacao_acumulada;
										w_movimento_contabil_row[ie_cont_registros_w].ds_compl_historico	:= ds_compl_historico_w;
										w_movimento_contabil_row[ie_cont_registros_w].ds_doc_agrupamento	:= '0';
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_agrupamento	:= nr_seq_agrupamento_w;
										w_movimento_contabil_row[ie_cont_registros_w].nr_documento		:= ' ';
										w_movimento_contabil_row[ie_cont_registros_w].ie_transitorio		:= 'N';
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_info		:= c04_type_w[i].nr_seq_info_ctb;
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_tab_orig	:= c04_type_w[i].nr_seq_tab_orig;
										w_movimento_contabil_row[ie_cont_registros_w].nm_tabela			:= c04_type_w[i].nm_tabela;
										w_movimento_contabil_row[ie_cont_registros_w].nm_atributo		:= 'VL_DEPRECIACAO_ACUMULADA';
										w_movimento_contabil_row[ie_cont_registros_w].cd_estabelecimento	:= cd_estabelecimento_w;
										ie_cont_registros_w := ie_cont_registros_w + 1;
										
										nr_sequencia_movto_w := nr_sequencia_movto_w + 1;
										w_movimento_contabil_row[ie_cont_registros_w].nr_lote_contabil 	:= nr_lote_contabil_p;
										w_movimento_contabil_row[ie_cont_registros_w].nr_sequencia		:= nr_sequencia_movto_w;
										w_movimento_contabil_row[ie_cont_registros_w].cd_conta_contabil	:= cd_conta_deprec_acum_w;
										w_movimento_contabil_row[ie_cont_registros_w].ie_debito_credito	:= 'C';
										w_movimento_contabil_row[ie_cont_registros_w].cd_historico		:= cd_historico_w;
										w_movimento_contabil_row[ie_cont_registros_w].dt_movimento		:= dt_movimento_w;
										w_movimento_contabil_row[ie_cont_registros_w].vl_movimento		:= c04_type_w[i].vl_depreciacao_acumulada;
										w_movimento_contabil_row[ie_cont_registros_w].ds_compl_historico	:= ds_compl_historico_w;
										w_movimento_contabil_row[ie_cont_registros_w].ds_doc_agrupamento	:= '0';
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_agrupamento	:= nr_seq_agrupamento_w;
										w_movimento_contabil_row[ie_cont_registros_w].nr_documento		:= ' ';
										w_movimento_contabil_row[ie_cont_registros_w].ie_transitorio		:= 'N';
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_info		:= c04_type_w[i].nr_seq_info_ctb;
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_tab_orig	:= c04_type_w[i].nr_seq_tab_orig;
										w_movimento_contabil_row[ie_cont_registros_w].nm_tabela			:= c04_type_w[i].nm_tabela;
										w_movimento_contabil_row[ie_cont_registros_w].nm_atributo		:= 'VL_DEPRECIACAO_ACUMULADA';
										w_movimento_contabil_row[ie_cont_registros_w].cd_estabelecimento	:= cd_estabelecimento_w;
										ie_cont_registros_w := ie_cont_registros_w + 1;
									end if;
									
									if (c04_type_w[i].vl_depreciacao_atual != 0) then
										nr_sequencia_movto_w := nr_sequencia_movto_w + 1;
										w_movimento_contabil_row[ie_cont_registros_w].nr_lote_contabil 	:= nr_lote_contabil_p;
										w_movimento_contabil_row[ie_cont_registros_w].nr_sequencia		:= nr_sequencia_movto_w;
										w_movimento_contabil_row[ie_cont_registros_w].cd_conta_contabil	:= cd_conta_deprec_res_w;
										w_movimento_contabil_row[ie_cont_registros_w].ie_debito_credito	:= 'D';
										w_movimento_contabil_row[ie_cont_registros_w].cd_historico		:= cd_historico_w;
										w_movimento_contabil_row[ie_cont_registros_w].dt_movimento		:= dt_movimento_w;
										w_movimento_contabil_row[ie_cont_registros_w].vl_movimento		:= c04_type_w[i].vl_depreciacao_atual;
										w_movimento_contabil_row[ie_cont_registros_w].ds_compl_historico	:= ds_compl_historico_w;
										w_movimento_contabil_row[ie_cont_registros_w].ds_doc_agrupamento	:= '0';
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_agrupamento	:= nr_seq_agrupamento_w;
										w_movimento_contabil_row[ie_cont_registros_w].nr_documento		:= ' ';
										w_movimento_contabil_row[ie_cont_registros_w].ie_transitorio		:= 'N';
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_info		:= c04_type_w[i].nr_seq_info_ctb;
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_tab_orig	:= c04_type_w[i].nr_seq_tab_orig;
										w_movimento_contabil_row[ie_cont_registros_w].nm_tabela			:= c04_type_w[i].nm_tabela;
										w_movimento_contabil_row[ie_cont_registros_w].nm_atributo		:= 'VL_DEPRECIACAO_ATUAL';
										w_movimento_contabil_row[ie_cont_registros_w].cd_estabelecimento	:= cd_estabelecimento_w;
										ie_cont_registros_w := ie_cont_registros_w + 1;
										
										nr_sequencia_movto_w := nr_sequencia_movto_w + 1;
										w_movimento_contabil_row[ie_cont_registros_w].nr_lote_contabil 	:= nr_lote_contabil_p;
										w_movimento_contabil_row[ie_cont_registros_w].nr_sequencia		:= nr_sequencia_movto_w;
										w_movimento_contabil_row[ie_cont_registros_w].cd_conta_contabil	:= cd_conta_deprec_acum_w;
										w_movimento_contabil_row[ie_cont_registros_w].ie_debito_credito	:= 'C';
										w_movimento_contabil_row[ie_cont_registros_w].cd_historico		:= cd_historico_w;
										w_movimento_contabil_row[ie_cont_registros_w].dt_movimento		:= dt_movimento_w;
										w_movimento_contabil_row[ie_cont_registros_w].vl_movimento		:= c04_type_w[i].vl_depreciacao_atual;
										w_movimento_contabil_row[ie_cont_registros_w].ds_compl_historico	:= ds_compl_historico_w;
										w_movimento_contabil_row[ie_cont_registros_w].ds_doc_agrupamento	:= '0';
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_agrupamento	:= nr_seq_agrupamento_w;
										w_movimento_contabil_row[ie_cont_registros_w].nr_documento		:= ' ';
										w_movimento_contabil_row[ie_cont_registros_w].ie_transitorio		:= 'N';
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_info		:= c04_type_w[i].nr_seq_info_ctb;
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_tab_orig	:= c04_type_w[i].nr_seq_tab_orig;
										w_movimento_contabil_row[ie_cont_registros_w].nm_tabela			:= c04_type_w[i].nm_tabela;
										w_movimento_contabil_row[ie_cont_registros_w].nm_atributo		:= 'VL_DEPRECIACAO_ATUAL';
										w_movimento_contabil_row[ie_cont_registros_w].cd_estabelecimento	:= cd_estabelecimento_w;
										ie_cont_registros_w := ie_cont_registros_w + 1;
									end if;
									
									if (c04_type_w[i].vl_depreciacao_liquida != 0) then
										nr_sequencia_movto_w := nr_sequencia_movto_w + 1;
										w_movimento_contabil_row[ie_cont_registros_w].nr_lote_contabil 	:= nr_lote_contabil_p;
										w_movimento_contabil_row[ie_cont_registros_w].nr_sequencia		:= nr_sequencia_movto_w;
										w_movimento_contabil_row[ie_cont_registros_w].cd_conta_contabil	:= cd_conta_deprec_acum_w;
										w_movimento_contabil_row[ie_cont_registros_w].ie_debito_credito	:= 'D';
										w_movimento_contabil_row[ie_cont_registros_w].cd_historico		:= cd_historico_w;
										w_movimento_contabil_row[ie_cont_registros_w].dt_movimento		:= dt_movimento_w;
										w_movimento_contabil_row[ie_cont_registros_w].vl_movimento		:= c04_type_w[i].vl_depreciacao_liquida;
										w_movimento_contabil_row[ie_cont_registros_w].ds_compl_historico	:= ds_compl_historico_w;
										w_movimento_contabil_row[ie_cont_registros_w].ds_doc_agrupamento	:= '0';
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_agrupamento	:= nr_seq_agrupamento_w;
										w_movimento_contabil_row[ie_cont_registros_w].nr_documento		:= ' ';
										w_movimento_contabil_row[ie_cont_registros_w].ie_transitorio		:= 'N';
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_info		:= c04_type_w[i].nr_seq_info_ctb;
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_tab_orig	:= c04_type_w[i].nr_seq_tab_orig;
										w_movimento_contabil_row[ie_cont_registros_w].nm_tabela			:= c04_type_w[i].nm_tabela;
										w_movimento_contabil_row[ie_cont_registros_w].nm_atributo		:= 'VL_DEPRECIACAO_LIQUIDA';
										w_movimento_contabil_row[ie_cont_registros_w].cd_estabelecimento	:= cd_estabelecimento_w;
										ie_cont_registros_w := ie_cont_registros_w + 1;
										
										nr_sequencia_movto_w := nr_sequencia_movto_w + 1;
										w_movimento_contabil_row[ie_cont_registros_w].nr_lote_contabil 	:= nr_lote_contabil_p;
										w_movimento_contabil_row[ie_cont_registros_w].nr_sequencia		:= nr_sequencia_movto_w;
										w_movimento_contabil_row[ie_cont_registros_w].cd_conta_contabil	:= cd_conta_contabil_w;
										w_movimento_contabil_row[ie_cont_registros_w].ie_debito_credito	:= 'C';
										w_movimento_contabil_row[ie_cont_registros_w].cd_historico		:= cd_historico_w;
										w_movimento_contabil_row[ie_cont_registros_w].dt_movimento		:= dt_movimento_w;
										w_movimento_contabil_row[ie_cont_registros_w].vl_movimento		:= c04_type_w[i].vl_depreciacao_liquida;
										w_movimento_contabil_row[ie_cont_registros_w].ds_compl_historico	:= ds_compl_historico_w;
										w_movimento_contabil_row[ie_cont_registros_w].ds_doc_agrupamento	:= '0';
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_agrupamento	:= nr_seq_agrupamento_w;
										w_movimento_contabil_row[ie_cont_registros_w].nr_documento		:= ' ';
										w_movimento_contabil_row[ie_cont_registros_w].ie_transitorio		:= 'N';
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_info		:= c04_type_w[i].nr_seq_info_ctb;
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_tab_orig	:= c04_type_w[i].nr_seq_tab_orig;
										w_movimento_contabil_row[ie_cont_registros_w].nm_tabela			:= c04_type_w[i].nm_tabela;
										w_movimento_contabil_row[ie_cont_registros_w].nm_atributo		:= 'VL_DEPRECIACAO_LIQUIDA';
										w_movimento_contabil_row[ie_cont_registros_w].cd_estabelecimento	:= cd_estabelecimento_w;
										ie_cont_registros_w := ie_cont_registros_w + 1;
									end if;
								end if;
							end loop;
						end if;
						
						begin
						select	b.vl_baixa_bem,
								b.vl_debito_fiscal,
								a.vl_mercado
						into STRICT 	vl_baixa_bem_bolivia_w,
								vl_debito_fiscal_w,
								vl_mercado_w
						from 	pat_bem a,
								pat_valor_bem b
						where 	a.nr_sequencia = nr_seq_bem_w
						and		b.nr_seq_bem = a.nr_sequencia
						and		b.nr_lote_contabil = nr_lote_contabil_p;
						exception
						when no_data_found then
							vl_baixa_bem_bolivia_w := 0;
						when too_many_rows then
							vl_baixa_bem_bolivia_w := 0;
						end;
						
						if (vl_baixa_bem_bolivia_w != 0) then
							open 	c05;
							fetch 	c05 bulk collect into c05_type_w;
							close 	c05;
							if (c05_type_w.first IS NOT NULL AND c05_type_w.first::text <> '') then
								vl_calculated_w := vl_baixa_bem_bolivia_w - vl_debito_fiscal_w - vl_mercado_w;
								if (vl_calculated_w != 0) then
									for i in c05_type_w.first..c05_type_w.last loop
										nr_sequencia_movto_w := nr_sequencia_movto_w + 1;
										w_movimento_contabil_row[ie_cont_registros_w].nr_lote_contabil 		:= nr_lote_contabil_p;
										w_movimento_contabil_row[ie_cont_registros_w].nr_sequencia			:= nr_sequencia_movto_w;
										w_movimento_contabil_row[ie_cont_registros_w].cd_conta_contabil		:= cd_conta_baixa_w;
										w_movimento_contabil_row[ie_cont_registros_w].ie_debito_credito		:= 'D';
										w_movimento_contabil_row[ie_cont_registros_w].cd_historico			:= cd_historico_w;
										w_movimento_contabil_row[ie_cont_registros_w].dt_movimento			:= dt_movimento_w;
										w_movimento_contabil_row[ie_cont_registros_w].vl_movimento			:= vl_baixa_bem_bolivia_w;
										w_movimento_contabil_row[ie_cont_registros_w].ds_compl_historico	:= ds_compl_historico_w;
										w_movimento_contabil_row[ie_cont_registros_w].ds_doc_agrupamento	:= '0';
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_agrupamento	:= nr_seq_agrupamento_w;
										w_movimento_contabil_row[ie_cont_registros_w].nr_documento			:= ' ';
										w_movimento_contabil_row[ie_cont_registros_w].ie_transitorio		:= 'N';
										w_movimento_contabil_row[ie_cont_registros_w].nm_tabela				:= 'PAT_BEM_MOVIMENTO';
										w_movimento_contabil_row[ie_cont_registros_w].nm_atributo			:= 'VL_MOVIMENTO';
										w_movimento_contabil_row[ie_cont_registros_w].cd_estabelecimento 	:= cd_estabelecimento_w;
										ie_cont_registros_w := ie_cont_registros_w + 1;
										
										nr_sequencia_movto_w := nr_sequencia_movto_w + 1;
										w_movimento_contabil_row[ie_cont_registros_w].nr_lote_contabil 		:= nr_lote_contabil_p;
										w_movimento_contabil_row[ie_cont_registros_w].nr_sequencia			:= nr_sequencia_movto_w;
										w_movimento_contabil_row[ie_cont_registros_w].cd_conta_contabil		:= cd_conta_contabil_w;
										w_movimento_contabil_row[ie_cont_registros_w].ie_debito_credito		:= 'C';
										w_movimento_contabil_row[ie_cont_registros_w].cd_historico			:= cd_historico_w;
										w_movimento_contabil_row[ie_cont_registros_w].dt_movimento			:= dt_movimento_w;
										w_movimento_contabil_row[ie_cont_registros_w].vl_movimento			:= vl_mercado_w;
										w_movimento_contabil_row[ie_cont_registros_w].ds_compl_historico	:= ds_compl_historico_w;
										w_movimento_contabil_row[ie_cont_registros_w].ds_doc_agrupamento	:= '0';
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_agrupamento	:= nr_seq_agrupamento_w;
										w_movimento_contabil_row[ie_cont_registros_w].nr_documento			:= ' ';
										w_movimento_contabil_row[ie_cont_registros_w].ie_transitorio		:= 'N';
										w_movimento_contabil_row[ie_cont_registros_w].nm_tabela				:= 'PAT_BEM';
										w_movimento_contabil_row[ie_cont_registros_w].nm_atributo			:= 'VL_MERCADO';
										w_movimento_contabil_row[ie_cont_registros_w].cd_estabelecimento 	:= cd_estabelecimento_w;
										ie_cont_registros_w := ie_cont_registros_w + 1;
										
										nr_sequencia_movto_w := nr_sequencia_movto_w + 1;
										w_movimento_contabil_row[ie_cont_registros_w].nr_lote_contabil 		:= nr_lote_contabil_p;
										w_movimento_contabil_row[ie_cont_registros_w].nr_sequencia			:= nr_sequencia_movto_w;
										w_movimento_contabil_row[ie_cont_registros_w].cd_conta_contabil		:= c05_type_w[i].cd_conta_debito_fiscal;
										w_movimento_contabil_row[ie_cont_registros_w].ie_debito_credito		:= 'C';
										w_movimento_contabil_row[ie_cont_registros_w].cd_historico			:= cd_historico_w;
										w_movimento_contabil_row[ie_cont_registros_w].dt_movimento			:= dt_movimento_w;
										w_movimento_contabil_row[ie_cont_registros_w].vl_movimento			:= vl_debito_fiscal_w;
										w_movimento_contabil_row[ie_cont_registros_w].ds_compl_historico	:= ds_compl_historico_w;
										w_movimento_contabil_row[ie_cont_registros_w].ds_doc_agrupamento	:= '0';
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_agrupamento	:= nr_seq_agrupamento_w;
										w_movimento_contabil_row[ie_cont_registros_w].nr_documento			:= ' ';
										w_movimento_contabil_row[ie_cont_registros_w].ie_transitorio		:= 'N';
										w_movimento_contabil_row[ie_cont_registros_w].nm_tabela				:= 'PAT_VALOR_BEM';
										w_movimento_contabil_row[ie_cont_registros_w].nm_atributo			:= 'VL_DEBITO_FISCAL';
										w_movimento_contabil_row[ie_cont_registros_w].cd_estabelecimento 	:= cd_estabelecimento_w;
										ie_cont_registros_w := ie_cont_registros_w + 1;
										
										cd_conta_lucro_perda_w := case when(vl_calculated_w > 0) then c05_type_w[i].cd_conta_lucro_venda else c05_type_w[i].cd_conta_perdas_venda end;
										ie_D_C_lucro_perda := case when(vl_calculated_w > 0) then 'C' else 'D' end;
										nr_sequencia_movto_w := nr_sequencia_movto_w + 1;
										w_movimento_contabil_row[ie_cont_registros_w].nr_lote_contabil 		:= nr_lote_contabil_p;
										w_movimento_contabil_row[ie_cont_registros_w].nr_sequencia			:= nr_sequencia_movto_w;
										w_movimento_contabil_row[ie_cont_registros_w].cd_conta_contabil		:= cd_conta_lucro_perda_w;
										w_movimento_contabil_row[ie_cont_registros_w].ie_debito_credito		:= ie_D_C_lucro_perda;
										w_movimento_contabil_row[ie_cont_registros_w].cd_historico			:= cd_historico_w;
										w_movimento_contabil_row[ie_cont_registros_w].dt_movimento			:= dt_movimento_w;
										w_movimento_contabil_row[ie_cont_registros_w].vl_movimento			:= vl_calculated_w;
										w_movimento_contabil_row[ie_cont_registros_w].ds_compl_historico	:= ds_compl_historico_w;
										w_movimento_contabil_row[ie_cont_registros_w].ds_doc_agrupamento	:= '0';
										w_movimento_contabil_row[ie_cont_registros_w].nr_seq_agrupamento	:= nr_seq_agrupamento_w;
										w_movimento_contabil_row[ie_cont_registros_w].nr_documento			:= ' ';
										w_movimento_contabil_row[ie_cont_registros_w].ie_transitorio		:= 'N';
										w_movimento_contabil_row[ie_cont_registros_w].nm_tabela				:= 'PAT_VALOR_BEM';
										w_movimento_contabil_row[ie_cont_registros_w].nm_atributo			:= 'VL_CALCULADO';
										w_movimento_contabil_row[ie_cont_registros_w].cd_estabelecimento 	:= cd_estabelecimento_w;
										ie_cont_registros_w := ie_cont_registros_w + 1;
									end loop;
								end if;
							end if;
						end if;
					end if;
					
					if (w_movimento_contabil_row.first IS NOT NULL AND w_movimento_contabil_row.first::text <> '') then
						forall i in w_movimento_contabil_row.first..w_movimento_contabil_row.last
							insert into w_movimento_contabil values w_movimento_contabil_row(i);
					end if;
				end if;
        end loop;
        close c_valor_bem;

        CALL pat_contabiliza_transf_bem(     nr_lote_contabil_p,
                                        nm_usuario_p,
                                        ie_exclusao_p);

        /* *************************************************************************************************************
        INICIO Contabilizacao entre estabelecimentos COM CONTA TRANSITORIA
        ************************************************************************************************************* */

        /* Limpar o complemento de estorno */

        ds_estorno_w            := '';

        /* Agrupamento por mes - ano */

        ds_mesano_w     :=      to_char(dt_referencia_w,'mmyyyy');

        /* Mes para complemento historico no formato Jan/2016, Fev/2016, Mar/2016, etc. */

        select  substr(obter_mes_extenso(to_char(dt_referencia_w,'mm'),'A') || '/' || to_char(dt_referencia_w,'yyyy'),1,10)
        into STRICT    ds_mesano_referencia_w
;

        /* Percorrer os bens que tiveram transferencia */

        open c02;
        loop
        fetch c02 bulk collect into c02_regs_w limit 1000;
                for idx02 in 1..c02_regs_w.count loop
                        c02_w := c02_regs_w(idx02);

                        if (nm_agrupador_w = 'NR_SEQ_BEM') then

                                if (ie_forma_contab_w = 'S') then
                                        nr_seq_agrupamento_w := 0;

                                elsif (ie_forma_contab_w = 'G') then
                                        begin
                                        select  c.nr_sequencia
                                        into STRICT    nr_seq_agrupamento_w
                                        from    pat_tipo_bem    b,
                                                pat_grupo_tipo  c,
                                                pat_bem         a
                                        where   b.nr_sequencia  = a.nr_seq_tipo
                                        and     c.nr_sequencia  = b.nr_seq_grupo
                                        and     a.nr_sequencia  = c02_w.nr_seq_bem;
                                        exception when others then
                                                nr_seq_agrupamento_w := 0;
                                        end;
                                else
                                        nr_seq_agrupamento_w := c02_w.nr_seq_bem;

                                end if;

                                if (coalesce(nr_seq_agrupamento_w,0) = 0) then

                                        nr_seq_agrupamento_w := c02_w.nr_seq_bem;
                                end if;
                        else

                                nr_seq_agrupamento_w := (ds_mesano_w)::numeric;
                        end if;

                        begin
                        select  cd_conta_deprec_acum,
                                cd_conta_deprec_res,
                                cd_conta_baixa,
                                cd_historico,
                                cd_hist_baixa,
                                cd_conta_ajuste_pat,
                                cd_conta_cap_social,
                                cd_hist_ajuste_pat,
                                cd_hist_entrada_aval,
                                cd_conta_entrada_aval
                        into STRICT    cd_conta_deprec_acum_w,
                                cd_conta_deprec_res_w,
                                cd_conta_baixa_w,
                                cd_historico_w,
                                cd_historico_baixa_w,
                                cd_conta_ajuste_pat_w,
                                cd_conta_cap_social_w,
                                cd_hist_ajuste_pat_w,
                                cd_hist_entrada_aval_w,
                                cd_conta_entrada_aval_w
                        from    pat_conta_contabil
                        where   nr_sequencia = c02_w.nr_seq_regra_conta
                        and     ie_situacao = 'A';
                        exception
                        when no_data_found then
                                --'Nao existe conta contabil: ' || cd_conta_contabil_w ||

                                --' no cadastro de contas do patrimonio (funcoes/cadastros/patrimonio/contas) nesta vigencia');
                                CALL wheb_mensagem_pck.exibir_mensagem_abort(1146525, 'cd_conta_contabil_w='||c02_w.cd_conta_contabil_bem||';'||
                                                                                 'ds_conta_contabil='||obter_desc_conta_contabil(c02_w.cd_conta_contabil_bem)||';'||
                                                                                'nr_seq_bem='||c02_w.nr_seq_bem||';'||
                                                                                'cd_bem='||c02_w.cd_bem||';'||
                                                                                'ds_bem='||c02_w.ds_bem);
                        end;
                        /* INICIO montar complemento historico */

                        if (ie_compl_hist_w = 'S') then
                                select  substr(obter_mes_extenso(to_char(dt_referencia_w,'mm'),'A') || '/' || to_char(dt_referencia_w,'yyyy'),1,10)
                                into STRICT    ds_mesano_referencia_w
;

                                ds_conteudo_w   := substr(      c02_w.cd_bem                            || '#@' ||
                                                                to_char(dt_referencia_w,'dd/mm/yyyy')   || '#@' ||
                                                                ds_mesano_referencia_w                  || '#@' ||
                                                                c02_w.ds_bem                            || '#@' ||
                                                                ''                                      || '#@' ||
                                                                ds_estorno_w                            || '#@' ||
                                                                c02_w.cd_bem_externo                    || '#@' ||
                                                                cd_estabelecimento_w,1,4000);

                                select  substr(obter_compl_historico(cd_tipo_lote_contabil_w, cd_historico_w, ds_conteudo_w),1,255)
                                into STRICT    ds_compl_historico_ww
;

                                ds_compl_historico_w    := substr(coalesce(ds_compl_historico_ww, wheb_mensagem_pck.get_texto(455389,'NR_SEQ_BEM='||c02_w.nr_seq_bem)),1,255);
                        end if;
                        /* FINAL montar complemento historico */



                        /* Pegar a data do historico caso a contabilizacao considere o rateio de depreciacao */

                        if (ie_contab_rateio_deprec_w = 'S') then

                                dt_movimento_w := c02_w.dt_historico_transf;
                        end if;

                        /* Se for transferencia entre estabelecimentos deve realizar os lancamentos do valor do bem contra a conta transitoria
                        DEPRECIACAO ACUMULADA ate o final do mes anterior
                        VALOR ORIGINAL do bem */
                        if (true) and (c02_w.cd_estab_origem <> c02_w.cd_estab_destino) then

                                /* Contabilizar entrada ou saida do estabelecimento contra a conta transitoria */

                                if (c02_w.ie_origem_destino = 'O') then
                                        ie_D_C_pat_w            := 'C';
                                        ie_D_C_pat_transit_w    := 'D';
                                        ie_D_C_deprec_w         := 'D';
                                        ie_D_C_deprec_transit_w := 'C';

                                else
                                        ie_D_C_pat_w            := 'D';
                                        ie_D_C_pat_transit_w    := 'C';
                                        ie_D_C_deprec_w         := 'C';
                                        ie_D_C_deprec_transit_w := 'D';
                                end if;

                                /* *************************************************************************************************************
                                INICIO CREDITO - origem /DEBITO - destino VALOR BEM
                                ************************************************************************************************************** */
                                nr_sequencia_movto_w    := coalesce(nr_sequencia_movto_w,0) + 1;
                                nm_atributo_w           := 'VL_TRANSF_DEPREC_MES';
                                ds_atributos_w          := 'NR_SEQ_BEM=' || c02_w.nr_seq_bem || ';' || 'CD_BEM=' || c02_w.cd_bem;

                                /* Obter documento e origem com base no atributo */

                                ctb_obter_doc_movto(    cd_tipo_lote_contabil_w,
                                                        nm_atributo_w,
                                                        'VR',
                                                        dt_movimento_w,
                                                        null,
                                                        null,
                                                        ds_atributos_w,
                                                        nm_usuario_p,
                                                        ie_regra_w,
                                                        nr_doc_aux_w,
                                                        ie_origem_documento_w);

                                /* Atributos para inserir */

                                movimento_contabil_w                            := null;
                                movimento_contabil_w.nr_lote_contabil           := nr_lote_contabil_p;
                                movimento_contabil_w.nr_sequencia               := nr_sequencia_movto_w;
                                movimento_contabil_w.ie_debito_credito          := ie_D_C_pat_w;
                                movimento_contabil_w.cd_conta_contabil          := c02_w.cd_conta_contabil_bem;
                                movimento_contabil_w.vl_movimento               := c02_w.vl_transf_bem;
                                movimento_contabil_w.cd_historico               := cd_historico_w;
                                movimento_contabil_w.dt_movimento               := dt_movimento_w;
                                movimento_contabil_w.ds_doc_agrupamento         := '0';
                                movimento_contabil_w.ie_transitorio             := 'N';
                                movimento_contabil_w.nr_documento               := nr_doc_aux_w;
                                movimento_contabil_w.ds_compl_historico         := ds_compl_historico_w;
                                movimento_contabil_w.nr_seq_agrupamento         := nr_seq_agrupamento_w;
                                movimento_contabil_w.ie_origem_documento        := ie_origem_documento_w;
                                movimento_contabil_w.cd_estabelecimento         := cd_estabelecimento_w;
                                movimento_contabil_w.nr_seq_info                := c02_w.nr_seq_info_ctb;
                                movimento_contabil_w.nr_seq_tab_orig            := c02_w.nr_seq_hist_transf;
                                movimento_contabil_w.nm_tabela                  := c02_w.nm_tabela;
                                movimento_contabil_w.nm_atributo                := nm_atributo_w;
                                movimento_contabil_w.nr_seq_proj_rec            := c02_w.nr_seq_proj_rec;

                                /* CREDITAR/DEBITAR bem no estabelecimento no estabelecimento atual - ORIGEM */

                                insert into w_movimento_contabil values (movimento_contabil_w.*);
                                /* *************************************************************************************************************
                                FIM CREDITO - origem /DEBITO - destino VALOR BEM
                                ************************************************************************************************************** */


                                /* *************************************************************************************************************
                                DEBITAR - origem / CREDITAR - destino O VALOR DO BEM NA CONTA TRANSITORIA
                                ************************************************************************************************************** */
                                nr_sequencia_movto_w    := coalesce(nr_sequencia_movto_w,0) + 1;
                                  nr_lote_contabil_p := ctb_gerar_movto_conta_transit(  nr_lote_contabil_p, cd_estabelecimento_w, cd_conta_transitoria_w, cd_historico_ct_w);

                                /* *************************************************************************************************************
                                INICIO DEBITO - origem / CREDITO - destino VALOR DEPRECIACAO ACUMULADA
                                ************************************************************************************************************** */
                                nr_sequencia_movto_w    := coalesce(nr_sequencia_movto_w,0) + 1;
                                nm_atributo_w           := 'VL_TRANSF_DEPREC_ACUM';
                                ds_atributos_w          := 'NR_SEQ_BEM=' || c02_w.nr_seq_bem || ';' || 'CD_BEM=' || c02_w.cd_bem;

                                /* Obter documento e origem com base no atributo */

                                ctb_obter_doc_movto(    cd_tipo_lote_contabil_w,
                                                        nm_atributo_w,
                                                        'VR',
                                                        dt_movimento_w,
                                                        null,
                                                        null,
                                                        ds_atributos_w,
                                                        nm_usuario_p,
                                                        ie_regra_w,
                                                        nr_doc_aux_w,
                                                        ie_origem_documento_w);

                                /* Atributos para inserir */

                                movimento_contabil_w                            := null;
                                movimento_contabil_w.nr_lote_contabil           := nr_lote_contabil_p;
                                movimento_contabil_w.nr_sequencia               := nr_sequencia_movto_w;
                                movimento_contabil_w.ie_debito_credito          := ie_D_C_deprec_w;
                                movimento_contabil_w.cd_conta_contabil          := cd_conta_deprec_acum_w;
                                movimento_contabil_w.vl_movimento               := c02_w.vl_transf_deprec_acum;
                                movimento_contabil_w.cd_historico               := cd_historico_w;
                                movimento_contabil_w.dt_movimento               := dt_movimento_w;
                                movimento_contabil_w.ds_doc_agrupamento         := '0';
                                movimento_contabil_w.ie_transitorio             := 'N';
                                movimento_contabil_w.nr_documento               := nr_doc_aux_w;
                                movimento_contabil_w.ds_compl_historico         := ds_compl_historico_w;
                                movimento_contabil_w.nr_seq_agrupamento         := nr_seq_agrupamento_w;
                                movimento_contabil_w.ie_origem_documento        := ie_origem_documento_w;
                                movimento_contabil_w.cd_estabelecimento         := cd_estabelecimento_w;
                                movimento_contabil_w.nr_seq_info                := c02_w.nr_seq_info_ctb;
                                movimento_contabil_w.nr_seq_tab_orig            := c02_w.nr_seq_hist_transf;
                                movimento_contabil_w.nm_tabela                  := c02_w.nm_tabela;
                                movimento_contabil_w.nm_atributo                := nm_atributo_w;
                                movimento_contabil_w.nr_seq_proj_rec            := c02_w.nr_seq_proj_rec;

                                insert into w_movimento_contabil values (movimento_contabil_w.*);
                                /* *************************************************************************************************************
                                FIM DEBITO - origem / CREDITO - destino VALOR DEPRECIACAO ACUMULADA
                                ************************************************************************************************************** */


                                /* *************************************************************************************************************
                                CREDITAR - origem / DEBITAR - destino O VALOR DE DEPRECIACAO ACUMULADA NA CONTA TRANSITORIA
                                ************************************************************************************************************** */
                                nr_sequencia_movto_w    := coalesce(nr_sequencia_movto_w,0) + 1;
                                  nr_lote_contabil_p := ctb_gerar_movto_conta_transit(  nr_lote_contabil_p, cd_estabelecimento_w, cd_conta_transitoria_w, cd_historico_ct_w);

                                /* *************************************************************************************************************
                                INICIO
                                DEBITAR - origem / CREDITAR - destino O VALOR DO BEM NA CONTA DE AJUSTE DE PATRIMONIAL
                                DEBITAR - origem / CREDITAR - destino A DEPRECIACAO  ACUMULADA DA CONTA DE CAPITAL SOCIAL
                                CREDITAR - origem / DEBITAR - destino A DEPRECIACAO  ACUMULADA DA CONTA DE AJUSTE AVALIACAO PATRIMONIAL
                                ************************************************************************************************************** */
                                if (coalesce(cd_conta_entrada_aval_w,'X') != 'X') and (coalesce(cd_conta_ajuste_pat_w, 'X') != 'X') and (coalesce(cd_conta_cap_social_w, 'X') != 'X') then
                                        /*
                                        - Debitar o valor do bem no estabelecimento ORIGEM na conta de ajuste que foi o CREDITO de contrapartida
                                        do valor reavaliado do bem

                                        Ambas contra a transitoria, no caso e so transferencia de valor
                                        */
                                        nr_sequencia_movto_w                            := coalesce(nr_sequencia_movto_w,0) + 1;
                                        movimento_contabil_w                            := null;
                                        movimento_contabil_w.nr_lote_contabil           := nr_lote_contabil_p;
                                        movimento_contabil_w.nr_sequencia               := nr_sequencia_movto_w;
                                        movimento_contabil_w.ie_debito_credito          := ie_D_C_deprec_w;
                                        movimento_contabil_w.cd_conta_contabil          := cd_conta_entrada_aval_w;
                                        movimento_contabil_w.vl_movimento               := c02_w.vl_transf_bem;
                                        movimento_contabil_w.cd_historico               := cd_hist_ajuste_pat_w;
                                        movimento_contabil_w.dt_movimento               := dt_movimento_w;
                                        movimento_contabil_w.ds_doc_agrupamento         := '0';
                                        movimento_contabil_w.ie_transitorio             := 'N';
                                        movimento_contabil_w.nr_documento               := nr_doc_aux_w;
                                        movimento_contabil_w.ds_compl_historico         := ds_compl_historico_w;
                                        movimento_contabil_w.nr_seq_agrupamento         := nr_seq_agrupamento_w;
                                        movimento_contabil_w.ie_origem_documento        := ie_origem_documento_w;
                                        movimento_contabil_w.cd_estabelecimento         := cd_estabelecimento_w;
                                        movimento_contabil_w.nr_seq_info                := c02_w.nr_seq_info_ctb;
                                        movimento_contabil_w.nr_seq_tab_orig            := c02_w.nr_seq_hist_transf;
                                        movimento_contabil_w.nm_tabela                  := c02_w.nm_tabela;
                                        movimento_contabil_w.nm_atributo                := nm_atributo_w;
                                        movimento_contabil_w.nr_seq_proj_rec            := c02_w.nr_seq_proj_rec;

                                        insert into w_movimento_contabil values (movimento_contabil_w.*);

                                        /*
                                        Contabilizacao transitoria
                                        Creditar origem
                                        Debitar destino
                                        */
                                        nr_sequencia_movto_w    := coalesce(nr_sequencia_movto_w,0) + 1;
                                          nr_lote_contabil_p := ctb_gerar_movto_conta_transit(  nr_lote_contabil_p, cd_estabelecimento_w, cd_conta_transitoria_w, cd_historico_ct_w);

                                        /*
                                        Debitar a depreciacao acumulada no estabelecimento ORIGEM da conta de capital social
                                        Cretitar transitoria

                                        Creditar conta de capital social no estabelecimento destino
                                                    Transferencia de deprec acumulada
                                        Debitar transitoria
                                        */
                                        nr_sequencia_movto_w                            := coalesce(nr_sequencia_movto_w,0) + 1;
                                        movimento_contabil_w                            := null;
                                        movimento_contabil_w.nr_lote_contabil           := nr_lote_contabil_p;
                                        movimento_contabil_w.nr_sequencia               := nr_sequencia_movto_w;
                                        movimento_contabil_w.ie_debito_credito          := ie_D_C_deprec_w;
                                        movimento_contabil_w.cd_conta_contabil          := cd_conta_cap_social_w;
                                        movimento_contabil_w.vl_movimento               := c02_w.vl_transf_deprec_acum;
                                        movimento_contabil_w.cd_historico               := cd_hist_ajuste_pat_w;
                                        movimento_contabil_w.dt_movimento               := dt_movimento_w;
                                        movimento_contabil_w.ds_doc_agrupamento         := '0';
                                        movimento_contabil_w.ie_transitorio             := 'N';
                                        movimento_contabil_w.nr_documento               := nr_doc_aux_w;
                                        movimento_contabil_w.ds_compl_historico         := ds_compl_historico_w;
                                        movimento_contabil_w.nr_seq_agrupamento         := nr_seq_agrupamento_w;
                                        movimento_contabil_w.ie_origem_documento        := ie_origem_documento_w;
                                        movimento_contabil_w.cd_estabelecimento         := cd_estabelecimento_w;
                                        movimento_contabil_w.nr_seq_info                := c02_w.nr_seq_info_ctb;
                                        movimento_contabil_w.nr_seq_tab_orig            := c02_w.nr_seq_hist_transf;
                                        movimento_contabil_w.nm_tabela                  := c02_w.nm_tabela;
                                        movimento_contabil_w.nm_atributo                := nm_atributo_w;
                                        movimento_contabil_w.nr_seq_proj_rec            := c02_w.nr_seq_proj_rec;

                                        insert into w_movimento_contabil values (movimento_contabil_w.*);

                                        nr_sequencia_movto_w    := coalesce(nr_sequencia_movto_w,0) + 1;
                                          nr_lote_contabil_p := ctb_gerar_movto_conta_transit(  nr_lote_contabil_p, cd_estabelecimento_w, cd_conta_transitoria_w, cd_historico_ct_w);


                                        /*
                                        Creditar no estabelecimento origem o valor de deprec acumulada (ajuste de avaliacao patrimonial)
                                        */
                                        nr_sequencia_movto_w                            := coalesce(nr_sequencia_movto_w,0) + 1;
                                        movimento_contabil_w                            := null;
                                        movimento_contabil_w.nr_lote_contabil           := nr_lote_contabil_p;
                                        movimento_contabil_w.nr_sequencia               := nr_sequencia_movto_w;
                                        movimento_contabil_w.ie_debito_credito          := ie_D_C_pat_w;
                                        movimento_contabil_w.cd_conta_contabil          := cd_conta_ajuste_pat_w;
                                        movimento_contabil_w.vl_movimento               := c02_w.vl_transf_deprec_acum;
                                        movimento_contabil_w.cd_historico               := cd_hist_ajuste_pat_w;
                                        movimento_contabil_w.dt_movimento               := dt_movimento_w;
                                        movimento_contabil_w.ds_doc_agrupamento         := '0';
                                        movimento_contabil_w.ie_transitorio             := 'N';
                                        movimento_contabil_w.nr_documento               := nr_doc_aux_w;
                                        movimento_contabil_w.ds_compl_historico         := ds_compl_historico_w;
                                        movimento_contabil_w.nr_seq_agrupamento         := nr_seq_agrupamento_w;
                                        movimento_contabil_w.ie_origem_documento        := ie_origem_documento_w;
                                        movimento_contabil_w.cd_estabelecimento         := cd_estabelecimento_w;
                                        movimento_contabil_w.nr_seq_info                := c02_w.nr_seq_info_ctb;
                                        movimento_contabil_w.nr_seq_tab_orig            := c02_w.nr_seq_hist_transf;
                                        movimento_contabil_w.nm_tabela                  := c02_w.nm_tabela;
                                        movimento_contabil_w.nm_atributo                := nm_atributo_w;
                                        movimento_contabil_w.nr_seq_proj_rec            := c02_w.nr_seq_proj_rec;

                                        insert into w_movimento_contabil values (movimento_contabil_w.*);

                                        nr_sequencia_movto_w    := coalesce(nr_sequencia_movto_w,0) + 1;
                                          nr_lote_contabil_p := ctb_gerar_movto_conta_transit(  nr_lote_contabil_p, cd_estabelecimento_w, cd_conta_transitoria_w, cd_historico_ct_w);
                                end if;
                                /* *************************************************************************************************************
                                FIM
                                DEBITAR - origem / CREDITAR - destino O VALOR DO BEM NA CONTA DE AJUSTE DE PATRIMONIAL
                                DEBITAR - origem / CREDITAR - destino A DEPRECIACAO  ACUMULADA DA CONTA DE CAPITAL SOCIAL
                                CREDITAR - origem / DEBITAR - destino A DEPRECIACAO  ACUMULADA DA CONTA DE AJUSTE AVALIACAO PATRIMONIAL
                                ************************************************************************************************************** */


                                /* *************************************************************************************************************
                                INICIO CONTABILIZACAO DO RATEIO / DEPREC MES POR TRANSF ENTRE ESTABELECIMENTOS
                                ************************************************************************************************************* */

                                /* ie_contab_rateio_deprec_w - Contabilizar o rateio da depreciacao, no estabelecimento origem e destino ou somente no destino */

                                if (ie_contab_rateio_deprec_w = 'S') then
                                        nm_tabela_w             := 'PAT_VALOR_BEM_RATEIO';
                                        nm_atributo_w           := 'VL_RATEIO_DEPREC';
                                else
                                        nm_tabela_w             := 'PAT_VALOR_BEM';
                                        nm_atributo_w           := 'VL_DEPREC_MES';
                                end if;

                                ds_atributos_w          := 'NR_SEQ_BEM=' || c02_w.nr_seq_bem || ';' || 'CD_BEM=' || c02_w.cd_bem;
                                ctb_obter_doc_movto(    cd_tipo_lote_contabil_w,
                                                        nm_atributo_w,
                                                        'VR',
                                                        dt_movimento_w,
                                                        null,
                                                        null,
                                                        ds_atributos_w,
                                                        nm_usuario_p,
                                                        ie_regra_w,
                                                        nr_doc_aux_w,
                                                        ie_origem_documento_w);
                        end if;
                        open c03;
                        loop
                        fetch c03 bulk collect into c03_regs_w;
                                for idx01 in 1..c03_regs_w.count loop
                                        c03_w := c03_regs_w(idx01);

                                        /* *************************************************************************************************************
                                        INICIO O ORIGEM TEM QUE CONTABILIZAR A DEPRECIACAO QUE FICOU AQUI PARA DEPOIS ZERAR CONTRA A CONTA TRANSITORIA
                                        ************************************************************************************************************* */
                                        if (true) and
                                                (((c03_w.ie_origem_destino = 'O') and (c02_w.cd_estab_origem = c03_w.cd_estabelecimento) and (c03_w.cd_estabelecimento = cd_estabelecimento_w)) or
                                                ((c03_w.ie_origem_destino = 'D') and (c02_w.cd_estab_destino = c03_w.cd_estabelecimento) and (c03_w.cd_estabelecimento = cd_estabelecimento_w) and (coalesce(c03_w.nr_seq_hist_dest::text, '') = ''))) then
                                                if (c03_w.ie_origem_destino = 'D') then
                                                        dt_movimento_w := last_day(c02_w.dt_historico_transf);
                                                end if;
                                                /*
                                                Verificar se a conta exige centro de custo
                                                */
                                                begin
                                                        select  ie_centro_custo
                                                        into STRICT    ie_centro_custo_w
                                                        from    conta_contabil
                                                        where   cd_conta_contabil = cd_conta_deprec_acum_w;
                                                exception
                                                when others then
                                                        ie_centro_custo_w := 'N';
                                                end;
                                                if (coalesce(ie_centro_custo_w,'N') <> 'S') then
                                                        cd_centro_custo_rateio_w := null;
                                                else
                                                        cd_centro_custo_rateio_w := c03_w.cd_centro_custo_rateio;
                                                end if;

                                                nr_sequencia_movto_w    := coalesce(nr_sequencia_movto_w,0) + 1;

                                                /* *************************************************************************************************************
                                                INSERIR O CREDITO NA CONTA DE DEPRECIACAO ACUMULADA
                                                ************************************************************************************************************* */
                                                movimento_contabil_w                            := null;
                                                movimento_contabil_w.nr_lote_contabil           := nr_lote_contabil_p;
                                                movimento_contabil_w.nr_sequencia               := nr_sequencia_movto_w;
                                                movimento_contabil_w.cd_conta_contabil          := cd_conta_deprec_acum_w;
                                                movimento_contabil_w.ie_debito_credito          := 'C';
                                                movimento_contabil_w.cd_historico               := cd_historico_w;
                                                movimento_contabil_w.dt_movimento               := dt_movimento_w;
                                                movimento_contabil_w.vl_movimento               := c03_w.vl_rateio_deprec;
                                                movimento_contabil_w.cd_centro_custo            := cd_centro_custo_rateio_w;
                                                movimento_contabil_w.ds_compl_historico         := ds_compl_historico_w;
                                                movimento_contabil_w.ds_doc_agrupamento         := '0';
                                                movimento_contabil_w.nr_seq_agrupamento         := nr_seq_agrupamento_w;
                                                movimento_contabil_w.nr_documento               := nr_doc_aux_w;
                                                movimento_contabil_w.ie_transitorio             := 'N';
                                                movimento_contabil_w.cd_estabelecimento         := cd_estabelecimento_w;
                                                movimento_contabil_w.ie_origem_documento        := ie_origem_documento_w;
                                                movimento_contabil_w.nr_seq_info                := c03_w.nr_seq_info_ctb;
                                                movimento_contabil_w.nr_seq_tab_orig            := c03_w.nr_seq_pat_valor_rateio;
                                                movimento_contabil_w.nm_tabela                  := nm_tabela_w;
                                                movimento_contabil_w.nm_atributo                := nm_atributo_w;
                                                movimento_contabil_w.nr_seq_proj_rec            := c02_w.nr_seq_proj_rec;

                                                insert into w_movimento_contabil values (movimento_contabil_w.*);

                                                /*
                                                Verificar se a conta exige centro de custo
                                                */
                                                begin
                                                        select  ie_centro_custo
                                                        into STRICT    ie_centro_custo_w
                                                        from    conta_contabil
                                                        where   cd_conta_contabil = cd_conta_deprec_res_w;
                                                exception
                                                when others then
                                                        ie_centro_custo_w := 'N';
                                                end;
                                                if (coalesce(ie_centro_custo_w,'N') <> 'S') then
                                                        cd_centro_custo_rateio_w := null;
                                                else
                                                        cd_centro_custo_rateio_w := c03_w.cd_centro_custo_rateio;
                                                end if;

                                                nr_sequencia_movto_w    := coalesce(nr_sequencia_movto_w,0) + 1;

                                                /* *************************************************************************************************************
                                                INSERIR O DEBITO NA CONTA DE RECEITA
                                                ************************************************************************************************************* */
                                                movimento_contabil_w.nr_sequencia               := nr_sequencia_movto_w;
                                                movimento_contabil_w.cd_conta_contabil          := cd_conta_deprec_res_w;
                                                movimento_contabil_w.ie_debito_credito          := 'D';
                                                movimento_contabil_w.cd_centro_custo            := cd_centro_custo_rateio_w;

                                                insert into w_movimento_contabil values (movimento_contabil_w.*);

                                                /* *************************************************************************************************************
                                                INICIO - CREDITAR - Patrimonio social / DEBITAR - Ajuste avaliacao patrimonial O VALOR DO RATEIO DA DEPRECIACAO
                                                ************************************************************************************************************* */
                                                if (coalesce(cd_conta_ajuste_pat_w, 'X') != 'X') and (coalesce(cd_conta_cap_social_w, 'X') != 'X') then
                                                        /*
                                                        CREDITAR a conta de Patrimonio social
                                                        */
                                                        nr_sequencia_movto_w    := coalesce(nr_sequencia_movto_w,0) + 1;
                                                        movimento_contabil_w                            := null;
                                                        movimento_contabil_w.nr_lote_contabil           := nr_lote_contabil_p;
                                                        movimento_contabil_w.nr_sequencia               := nr_sequencia_movto_w;
                                                        movimento_contabil_w.ie_debito_credito          := 'C';
                                                        movimento_contabil_w.cd_conta_contabil          := cd_conta_cap_social_w;
                                                        movimento_contabil_w.vl_movimento               := c03_w.vl_rateio_deprec;
                                                        movimento_contabil_w.cd_historico               := cd_hist_ajuste_pat_w;
                                                        movimento_contabil_w.dt_movimento               := dt_movimento_w;
                                                        movimento_contabil_w.ds_doc_agrupamento         := '0';
                                                        movimento_contabil_w.ie_transitorio             := 'N';
                                                        movimento_contabil_w.nr_documento               := nr_doc_aux_w;
                                                        movimento_contabil_w.ds_compl_historico         := ds_compl_historico_w;
                                                        movimento_contabil_w.nr_seq_agrupamento         := nr_seq_agrupamento_w;
                                                        movimento_contabil_w.ie_origem_documento        := ie_origem_documento_w;
                                                        movimento_contabil_w.cd_estabelecimento         := cd_estabelecimento_w;
                                                        movimento_contabil_w.nr_seq_info                := c02_w.nr_seq_info_ctb;
                                                        movimento_contabil_w.nr_seq_tab_orig            := c02_w.nr_seq_hist_transf;
                                                        movimento_contabil_w.nm_tabela                  := c02_w.nm_tabela;
                                                        movimento_contabil_w.nm_atributo                := nm_atributo_w;
                                                        movimento_contabil_w.nr_seq_proj_rec            := c02_w.nr_seq_proj_rec;

                                                        insert into w_movimento_contabil values (movimento_contabil_w.*);

                                                        nr_sequencia_movto_w    := coalesce(nr_sequencia_movto_w,0) + 1;

                                                        /*
                                                        DEBITAR a conta de ajuste avaliacao patrimonial
                                                        */
                                                        movimento_contabil_w.nr_lote_contabil           := nr_lote_contabil_p;
                                                        movimento_contabil_w.nr_sequencia               := nr_sequencia_movto_w;
                                                        movimento_contabil_w.ie_debito_credito          := 'D';
                                                        movimento_contabil_w.cd_conta_contabil          := cd_conta_ajuste_pat_w;
                                                        movimento_contabil_w.cd_estabelecimento         := cd_estabelecimento_w;
                                                        movimento_contabil_w.nr_seq_proj_rec            := c02_w.nr_seq_proj_rec;

                                                        insert into w_movimento_contabil values (movimento_contabil_w.*);
                                                end if;
                                                /* *************************************************************************************************************
                                                FIM - CREDITAR - Patrimonio social / DEBITAR - Ajuste avaliacao patrimonial O VALOR DO RATEIO DA DEPRECIACAO
                                                ************************************************************************************************************* */
                                                if (c02_w.cd_estab_origem = cd_estabelecimento_w) and (c02_w.cd_estab_origem <> c02_w.cd_estab_destino) then
                                                        ie_D_C_rat_w            := 'D';
                                                        ie_D_C_rat_transit_w    := 'C';

                                                        /* *************************************************************************************************************
                                                        INICIO CONTABILIZAR DEBITO - origem / CREDITO - destino RATEIO DEPREC CONTRA CONTA TRANSITORIA
                                                        ************************************************************************************************************* */

                                                        /*
                                                        Verificar se a conta exige centro de custo
                                                        */
                                                        begin
                                                                select  ie_centro_custo
                                                                into STRICT    ie_centro_custo_w
                                                                from    conta_contabil
                                                                where   cd_conta_contabil = cd_conta_deprec_acum_w;
                                                        exception
                                                        when others then
                                                                ie_centro_custo_w := 'N';
                                                        end;
                                                        if (coalesce(ie_centro_custo_w,'N') <> 'S') then
                                                                cd_centro_custo_rateio_w := null;
                                                        else
                                                                cd_centro_custo_rateio_w := c03_w.cd_centro_custo_rateio;
                                                        end if;

                                                        nr_sequencia_movto_w    := coalesce(nr_sequencia_movto_w,0) + 1;

                                                        /* *************************************************************************************************************
                                                        INSERIR DEBITO - origem / CREDITO - destino  DO VALOR DE RATEIO NA CONTA DE DEPREC ACUMULADA
                                                        ************************************************************************************************************* */
                                                        movimento_contabil_w                            := null;
                                                        movimento_contabil_w.nr_lote_contabil           := nr_lote_contabil_p;
                                                        movimento_contabil_w.nr_sequencia               := nr_sequencia_movto_w;
                                                        movimento_contabil_w.cd_conta_contabil          := cd_conta_deprec_acum_w;
                                                        movimento_contabil_w.ie_debito_credito          := ie_D_C_rat_w;
                                                        movimento_contabil_w.cd_historico               := cd_historico_w;
                                                        movimento_contabil_w.dt_movimento               := dt_movimento_w;
                                                        movimento_contabil_w.vl_movimento               := c03_w.vl_rateio_deprec;
                                                        movimento_contabil_w.cd_centro_custo            := cd_centro_custo_rateio_w;
                                                        movimento_contabil_w.ds_compl_historico         := ds_compl_historico_w;
                                                        movimento_contabil_w.ds_doc_agrupamento         := '0';
                                                        movimento_contabil_w.nr_seq_agrupamento         := nr_seq_agrupamento_w;
                                                        movimento_contabil_w.nr_documento               := nr_doc_aux_w;
                                                        movimento_contabil_w.ie_transitorio             := 'N';
                                                        movimento_contabil_w.cd_estabelecimento         := cd_estabelecimento_w;
                                                        movimento_contabil_w.ie_origem_documento        := ie_origem_documento_w;
                                                        movimento_contabil_w.nr_seq_info                := c03_w.nr_seq_info_ctb;
                                                        movimento_contabil_w.nr_seq_tab_orig            := c03_w.nr_seq_pat_valor_rateio;
                                                        movimento_contabil_w.nm_tabela                  := nm_tabela_w;
                                                        movimento_contabil_w.nm_atributo                := nm_atributo_w;
                                                        movimento_contabil_w.nr_seq_proj_rec            := c02_w.nr_seq_proj_rec;

                                                        insert into w_movimento_contabil values (movimento_contabil_w.*);

                                                        /* *************************************************************************************************************
                                                        INSERIR CREDITO - origem / DEBITO - destino DO VALOR DE RATEIO NA CONTA TRANSITORIA
                                                        ************************************************************************************************************** */
                                                          nr_lote_contabil_p := ctb_gerar_movto_conta_transit(  nr_lote_contabil_p, cd_estabelecimento_w, cd_conta_transitoria_w, cd_historico_ct_w);
                                                        /* *************************************************************************************************************
                                                        FINAL CONTABILIZAR DEBITO - origem / CREDITO - destino RATEIO DEPREC CONTRA CONTA TRANSITORIA
                                                        ************************************************************************************************************* */


                                                        /* *************************************************************************************************************
                                                        INICIO
                                                        DEBITAR - origem / CREDITAR - destino O VALOR DO RATEIO DA DEPRECIACAO CONTRA A TRANSITORIA DO PATRIMONIO SOCIAL
                                                        CREDITAR - origem / DEBITAR - destino O VALOR DO RATEIO DA DEPRECIACAO CONTRA A TRANSITORIA DO AJUSTE AVALIACAO PATRIMONIAL
                                                        ************************************************************************************************************* */
                                                        if (true) and (coalesce(cd_conta_ajuste_pat_w, 'X') != 'X') and (coalesce(cd_conta_cap_social_w, 'X') != 'X') then
                                                                /*
                                                                Valor do rateio que ser transferido da conta de capital social
                                                                */
                                                                nr_sequencia_movto_w                            := coalesce(nr_sequencia_movto_w,0) + 1;
                                                                movimento_contabil_w                            := null;
                                                                movimento_contabil_w.nr_lote_contabil           := nr_lote_contabil_p;
                                                                movimento_contabil_w.nr_sequencia               := nr_sequencia_movto_w;
                                                                movimento_contabil_w.ie_debito_credito          := ie_D_C_rat_w;
                                                                movimento_contabil_w.cd_conta_contabil          := cd_conta_cap_social_w;
                                                                movimento_contabil_w.vl_movimento               := c03_w.vl_rateio_deprec;
                                                                movimento_contabil_w.cd_historico               := cd_hist_ajuste_pat_w;
                                                                movimento_contabil_w.dt_movimento               := dt_movimento_w;
                                                                movimento_contabil_w.ds_doc_agrupamento         := '0';
                                                                movimento_contabil_w.ie_transitorio             := 'N';
                                                                movimento_contabil_w.nr_documento               := nr_doc_aux_w;
                                                                movimento_contabil_w.ds_compl_historico         := ds_compl_historico_w;
                                                                movimento_contabil_w.nr_seq_agrupamento         := nr_seq_agrupamento_w;
                                                                movimento_contabil_w.ie_origem_documento        := ie_origem_documento_w;
                                                                movimento_contabil_w.cd_estabelecimento         := cd_estabelecimento_w;
                                                                movimento_contabil_w.nr_seq_info                := c02_w.nr_seq_info_ctb;
                                                                movimento_contabil_w.nr_seq_tab_orig            := c02_w.nr_seq_hist_transf;
                                                                movimento_contabil_w.nm_tabela                  := c02_w.nm_tabela;
                                                                movimento_contabil_w.nm_atributo                := nm_atributo_w;
                                                                movimento_contabil_w.nr_seq_proj_rec            := c02_w.nr_seq_proj_rec;

                                                                insert into w_movimento_contabil values (movimento_contabil_w.*);

                                                                nr_sequencia_movto_w    := coalesce(nr_sequencia_movto_w,0) + 1;
                                                                  nr_lote_contabil_p := ctb_gerar_movto_conta_transit(  nr_lote_contabil_p, cd_estabelecimento_w, cd_conta_transitoria_w, cd_historico_ct_w);

                                                                /*
                                                                Valor do rateio que sera transferido da conta de ajuste availacao patrimonial
                                                                */
                                                                nr_sequencia_movto_w                            := coalesce(nr_sequencia_movto_w,0) + 1;
                                                                movimento_contabil_w                            := null;
                                                                movimento_contabil_w.nr_lote_contabil           := nr_lote_contabil_p;
                                                                movimento_contabil_w.nr_sequencia               := nr_sequencia_movto_w;
                                                                movimento_contabil_w.ie_debito_credito          := ie_D_C_rat_transit_w;
                                                                movimento_contabil_w.cd_conta_contabil          := cd_conta_ajuste_pat_w;
                                                                movimento_contabil_w.vl_movimento               := c03_w.vl_rateio_deprec;
                                                                movimento_contabil_w.cd_historico               := cd_hist_ajuste_pat_w;
                                                                movimento_contabil_w.dt_movimento               := dt_movimento_w;
                                                                movimento_contabil_w.ds_doc_agrupamento         := '0';
                                                                movimento_contabil_w.ie_transitorio             := 'N';
                                                                movimento_contabil_w.nr_documento               := nr_doc_aux_w;
                                                                movimento_contabil_w.ds_compl_historico         := ds_compl_historico_w;
                                                                movimento_contabil_w.nr_seq_agrupamento         := nr_seq_agrupamento_w;
                                                                movimento_contabil_w.ie_origem_documento        := ie_origem_documento_w;
                                                                movimento_contabil_w.cd_estabelecimento         := cd_estabelecimento_w;
                                                                movimento_contabil_w.nr_seq_info                := c02_w.nr_seq_info_ctb;
                                                                movimento_contabil_w.nr_seq_tab_orig            := c02_w.nr_seq_hist_transf;
                                                                movimento_contabil_w.nm_tabela                  := c02_w.nm_tabela;
                                                                movimento_contabil_w.nm_atributo                := nm_atributo_w;
                                                                movimento_contabil_w.nr_seq_proj_rec            := c02_w.nr_seq_proj_rec;

                                                                insert into w_movimento_contabil values (movimento_contabil_w.*);

                                                                nr_sequencia_movto_w    := coalesce(nr_sequencia_movto_w,0) + 1;
                                                                  nr_lote_contabil_p := ctb_gerar_movto_conta_transit(  nr_lote_contabil_p, cd_estabelecimento_w, cd_conta_transitoria_w, cd_historico_ct_w);
                                                        end if;
                                                        /* *************************************************************************************************************
                                                        FIM
                                                        DEBITAR - origem / CREDITAR - destino O VALOR DO RATEIO DA DEPRECIACAO CONTRA A TRANSITORIA DO PATRIMONIO SOCIAL
                                                        CREDITAR - origem / DEBITAR - destino O VALOR DO RATEIO DA DEPRECIACAO CONTRA A TRANSITORIA DO AJUSTE AVALIACAO PATRIMONIAL
                                                        ************************************************************************************************************* */
                                                end if;
                                        end if;
                                        /* *************************************************************************************************************
                                        FINAL O ORIGEM TEM QUE CONTABILIZAR A DEPRECIACAO QUE FICOU AQUI PARA DEPOIS ZERAR CONTRA A CONTA TRANSITORIA
                                        ************************************************************************************************************* */
                                        if (true) and (c03_w.ie_origem_destino = 'O') and (c02_w.cd_estab_origem = c03_w.cd_estabelecimento) and (c02_w.cd_estab_destino = cd_estabelecimento_w) and (c02_w.cd_estab_origem <> c02_w.cd_estab_destino) then
                                                ie_D_C_rat_w            := 'C';
                                                ie_D_C_rat_transit_w    := 'D';

                                                /* *************************************************************************************************************
                                                INICIO CONTABILIZAR DEBITO - origem / CREDITO - destino RATEIO DEPREC CONTRA CONTA TRANSITORIA
                                                ************************************************************************************************************* */

                                                /*
                                                Verificar se a conta exige centro de custo
                                                */
                                                begin
                                                        select  ie_centro_custo
                                                        into STRICT    ie_centro_custo_w
                                                        from    conta_contabil
                                                        where   cd_conta_contabil = cd_conta_deprec_acum_w;
                                                exception
                                                when others then
                                                        ie_centro_custo_w := 'N';
                                                end;
                                                if (coalesce(ie_centro_custo_w,'N') <> 'S') then
                                                        cd_centro_custo_rateio_w := null;
                                                else
                                                        cd_centro_custo_rateio_w := c03_w.cd_centro_custo_rateio;
                                                end if;

                                                nr_sequencia_movto_w    := coalesce(nr_sequencia_movto_w,0) + 1;

                                                /* *************************************************************************************************************
                                                INSERIR DEBITO - origem / CREDITO - destino  DO VALOR DE RATEIO NA CONTA DE DEPREC ACUMULADA
                                                ************************************************************************************************************* */
                                                movimento_contabil_w                            := null;
                                                movimento_contabil_w.nr_lote_contabil           := nr_lote_contabil_p;
                                                movimento_contabil_w.nr_sequencia               := nr_sequencia_movto_w;
                                                movimento_contabil_w.cd_conta_contabil          := cd_conta_deprec_acum_w;
                                                movimento_contabil_w.ie_debito_credito          := ie_D_C_rat_w;
                                                movimento_contabil_w.cd_historico               := cd_historico_w;
                                                movimento_contabil_w.dt_movimento               := dt_movimento_w;
                                                movimento_contabil_w.vl_movimento               := c03_w.vl_rateio_deprec;
                                                movimento_contabil_w.cd_centro_custo            := cd_centro_custo_rateio_w;
                                                movimento_contabil_w.ds_compl_historico         := ds_compl_historico_w;
                                                movimento_contabil_w.ds_doc_agrupamento         := '0';
                                                movimento_contabil_w.nr_seq_agrupamento         := nr_seq_agrupamento_w;
                                                movimento_contabil_w.nr_documento               := nr_doc_aux_w;
                                                movimento_contabil_w.ie_transitorio             := 'N';
                                                movimento_contabil_w.cd_estabelecimento         := cd_estabelecimento_w;
                                                movimento_contabil_w.ie_origem_documento        := ie_origem_documento_w;
                                                movimento_contabil_w.nr_seq_info                := c03_w.nr_seq_info_ctb;
                                                movimento_contabil_w.nr_seq_tab_orig            := c03_w.nr_seq_pat_valor_rateio;
                                                movimento_contabil_w.nm_tabela                  := nm_tabela_w;
                                                movimento_contabil_w.nm_atributo                := nm_atributo_w;
                                                movimento_contabil_w.nr_seq_proj_rec            := c02_w.nr_seq_proj_rec;

                                                insert into w_movimento_contabil values (movimento_contabil_w.*);

                                                /* *************************************************************************************************************
                                                INSERIR CREDITO - origem / DEBITO - destino DO VALOR DE RATEIO NA CONTA TRANSITORIA
                                                ************************************************************************************************************** */
                                                  nr_lote_contabil_p := ctb_gerar_movto_conta_transit(  nr_lote_contabil_p, cd_estabelecimento_w, cd_conta_transitoria_w, cd_historico_ct_w);
                                                /* *************************************************************************************************************
                                                FINAL CONTABILIZAR DEBITO - origem / CREDITO - destino RATEIO DEPREC CONTRA CONTA TRANSITORIA
                                                ************************************************************************************************************* */


                                                /* *************************************************************************************************************
                                                INICIO
                                                DEBITAR - origem / CREDITAR - destino O VALOR DO RATEIO DA DEPRECIACAO CONTRA A TRANSITORIA DO PATRIMONIO SOCIAL
                                                CREDITAR - origem / DEBITAR - destino O VALOR DO RATEIO DA DEPRECIACAO CONTRA A TRANSITORIA DO AJUSTE AVALIACAO PATRIMONIAL
                                                ************************************************************************************************************* */
                                                if (true) and (coalesce(cd_conta_ajuste_pat_w, 'X') != 'X') and (coalesce(cd_conta_cap_social_w, 'X') != 'X') then
                                                        /*
                                                        Valor do rateio que sera transferido da conta de capital social
                                                        */
                                                        nr_sequencia_movto_w                            := coalesce(nr_sequencia_movto_w,0) + 1;
                                                        movimento_contabil_w                            := null;
                                                        movimento_contabil_w.nr_lote_contabil           := nr_lote_contabil_p;
                                                        movimento_contabil_w.nr_sequencia               := nr_sequencia_movto_w;
                                                        movimento_contabil_w.ie_debito_credito          := ie_D_C_rat_w;
                                                        movimento_contabil_w.cd_conta_contabil          := cd_conta_cap_social_w;
                                                        movimento_contabil_w.vl_movimento               := c03_w.vl_rateio_deprec;
                                                        movimento_contabil_w.cd_historico               := cd_hist_ajuste_pat_w;
                                                        movimento_contabil_w.dt_movimento               := dt_movimento_w;
                                                        movimento_contabil_w.ds_doc_agrupamento         := '0';
                                                        movimento_contabil_w.ie_transitorio             := 'N';
                                                        movimento_contabil_w.nr_documento               := nr_doc_aux_w;
                                                        movimento_contabil_w.ds_compl_historico         := ds_compl_historico_w;
                                                        movimento_contabil_w.nr_seq_agrupamento         := nr_seq_agrupamento_w;
                                                        movimento_contabil_w.ie_origem_documento        := ie_origem_documento_w;
                                                        movimento_contabil_w.cd_estabelecimento         := cd_estabelecimento_w;
                                                        movimento_contabil_w.nr_seq_info                := c02_w.nr_seq_info_ctb;
                                                        movimento_contabil_w.nr_seq_tab_orig            := c02_w.nr_seq_hist_transf;
                                                        movimento_contabil_w.nm_tabela                  := c02_w.nm_tabela;
                                                        movimento_contabil_w.nm_atributo                := nm_atributo_w;
                                                        movimento_contabil_w.nr_seq_proj_rec            := c02_w.nr_seq_proj_rec;

                                                        insert into w_movimento_contabil values (movimento_contabil_w.*);

                                                        nr_sequencia_movto_w    := coalesce(nr_sequencia_movto_w,0) + 1;
                                                          nr_lote_contabil_p := ctb_gerar_movto_conta_transit(  nr_lote_contabil_p, cd_estabelecimento_w, cd_conta_transitoria_w, cd_historico_ct_w);

                                                        /*
                                                        Valor do rateio que sera transferido da conta de ajuste availacao patrimonial
                                                        */
                                                        nr_sequencia_movto_w                            := coalesce(nr_sequencia_movto_w,0) + 1;
                                                        movimento_contabil_w                            := null;
                                                        movimento_contabil_w.nr_lote_contabil           := nr_lote_contabil_p;
                                                        movimento_contabil_w.nr_sequencia               := nr_sequencia_movto_w;
                                                        movimento_contabil_w.ie_debito_credito          := ie_D_C_rat_transit_w;
                                                        movimento_contabil_w.cd_conta_contabil          := cd_conta_ajuste_pat_w;
                                                        movimento_contabil_w.vl_movimento               := c03_w.vl_rateio_deprec;
                                                        movimento_contabil_w.cd_historico               := cd_hist_ajuste_pat_w;
                                                        movimento_contabil_w.dt_movimento               := dt_movimento_w;
                                                        movimento_contabil_w.ds_doc_agrupamento         := '0';
                                                        movimento_contabil_w.ie_transitorio             := 'N';
                                                        movimento_contabil_w.nr_documento               := nr_doc_aux_w;
                                                        movimento_contabil_w.ds_compl_historico         := ds_compl_historico_w;
                                                        movimento_contabil_w.nr_seq_agrupamento         := nr_seq_agrupamento_w;
                                                        movimento_contabil_w.ie_origem_documento        := ie_origem_documento_w;
                                                        movimento_contabil_w.cd_estabelecimento         := cd_estabelecimento_w;
                                                        movimento_contabil_w.nr_seq_info                := c02_w.nr_seq_info_ctb;
                                                        movimento_contabil_w.nr_seq_tab_orig            := c02_w.nr_seq_hist_transf;
                                                        movimento_contabil_w.nm_tabela                  := c02_w.nm_tabela;
                                                        movimento_contabil_w.nm_atributo                := nm_atributo_w;
                                                        movimento_contabil_w.nr_seq_proj_rec            := c02_w.nr_seq_proj_rec;

                                                        insert into w_movimento_contabil values (movimento_contabil_w.*);

                                                        nr_sequencia_movto_w    := coalesce(nr_sequencia_movto_w,0) + 1;
                                                          nr_lote_contabil_p := ctb_gerar_movto_conta_transit(  nr_lote_contabil_p, cd_estabelecimento_w, cd_conta_transitoria_w, cd_historico_ct_w);
                                                end if;
                                                /* *************************************************************************************************************
                                                FIM
                                                DEBITAR - origem / CREDITAR - destino O VALOR DO RATEIO DA DEPRECIACAO CONTRA A TRANSITORIA DO PATRIMONIO SOCIAL
                                                CREDITAR - origem / DEBITAR - destino O VALOR DO RATEIO DA DEPRECIACAO CONTRA A TRANSITORIA DO AJUSTE AVALIACAO PATRIMONIAL
                                                ************************************************************************************************************* */
                                        end if;
                                end loop;
                        EXIT WHEN NOT FOUND; /* apply on c03 */
                        end loop;
                        close c03;
                end loop;
        EXIT WHEN NOT FOUND; /* apply on c02 */
        end loop;
        close c02;
        /* *************************************************************************************************************
        FINAL Contabilizacao entre estabelecimentos COM CONTA TRANSITORIA
        ************************************************************************************************************* */
        if (pkg_i18n.get_user_locale = 'es_BO' AND ie_exclusao_p = 'N') then
                BEGIN
			CALL ctb_regras_contabil.ctb_gerar_cd_controle_patri(nr_lote_contabil_p, ie_exclusao_p, nm_usuario_p);
                EXCEPTION
			WHEN OTHERS THEN CALL ctb_gravar_log_lote(nr_lote_contabil_p, 1, SQLERRM, nm_usuario_p);
                END;
        end if;

        CALL agrupa_movimento_contabil(nr_lote_contabil_p, nm_usuario_p);
end if;

if (ie_exclusao_p = 'S') then
        ds_retorno_p            := wheb_mensagem_pck.get_texto(165188);

        CALL ctb_gravar_log_lote(    nr_lote_contabil_p,
                                2,
                                '',
                                nm_usuario_p);
else
        ds_retorno_p            := wheb_mensagem_pck.get_texto(165187);

        CALL ctb_gravar_log_lote(    nr_lote_contabil_p,
                                1,
                                '',
                                nm_usuario_p);
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE contabiliza_patrimonio ( nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text) FROM PUBLIC;

