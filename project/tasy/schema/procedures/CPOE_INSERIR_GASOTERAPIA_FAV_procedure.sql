-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_inserir_gasoterapia_fav ( nr_atendimento_p cpoe_gasoterapia.nr_atendimento%type, cd_pessoa_fisica_p cpoe_gasoterapia.cd_pessoa_fisica%type, nr_sequencia_p cpoe_fav_gasoterapia.nr_sequencia%type, nm_usuario_p cpoe_fav_gasoterapia.nm_usuario%type, cd_perfil_p bigint, cd_estabelecimento_p bigint, nr_seq_item_gerado_p INOUT bigint, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, nr_seq_conclusao_apae_p bigint default null, ie_futuro_p text default 'N', nr_seq_cpoe_rp_p cpoe_rp.nr_sequencia%type default null, nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) AS $body$
DECLARE


cd_intervalo_w				cpoe_fav_gasoterapia.cd_intervalo%type;
cd_intervalo_mat1_w			cpoe_fav_gasoterapia.cd_intervalo_mat1%type;
cd_intervalo_mat2_w			cpoe_fav_gasoterapia.cd_intervalo_mat2%type;
cd_intervalo_mat3_w			cpoe_fav_gasoterapia.cd_intervalo_mat3%type;
cd_mat_equip1_w				cpoe_fav_gasoterapia.cd_mat_equip1%type;
cd_mat_equip2_w				cpoe_fav_gasoterapia.cd_mat_equip2%type;
cd_mat_equip3_w				cpoe_fav_gasoterapia.cd_mat_equip3%type;
cd_modalidade_vent_w		cpoe_fav_gasoterapia.cd_modalidade_vent%type;
cd_unid_med_dose1_w			cpoe_fav_gasoterapia.cd_unid_med_dose1%type;
cd_unid_med_dose2_w			cpoe_fav_gasoterapia.cd_unid_med_dose2%type;
cd_unid_med_dose3_w			cpoe_fav_gasoterapia.cd_unid_med_dose3%type;
ds_observacao_w				cpoe_fav_gasoterapia.ds_observacao%type;
dt_tempo_duracao_w			cpoe_fav_gasoterapia.dt_tempo_duracao%type;
ie_acm_w					cpoe_fav_gasoterapia.ie_acm%type;
ie_administracao_w			cpoe_fav_gasoterapia.ie_administracao%type;
ie_disp_resp_esp_w			cpoe_fav_gasoterapia.ie_disp_resp_esp%type;
ie_duracao_w				cpoe_fav_gasoterapia.ie_duracao%type;
ie_evento_unico_w			cpoe_fav_gasoterapia.ie_evento_unico%type;
ie_inicio_w					cpoe_fav_gasoterapia.ie_inicio%type;
ie_modo_adm_w				cpoe_fav_gasoterapia.ie_modo_adm%type;
ie_periodo_w				cpoe_fav_gasoterapia.ie_periodo%type;
ie_respiracao_w				cpoe_fav_gasoterapia.ie_respiracao%type;
ie_se_necessario_w			cpoe_fav_gasoterapia.ie_se_necessario%type;
ie_tipo_onda_w				cpoe_fav_gasoterapia.ie_tipo_onda%type;
ie_unidade_medida_w			cpoe_fav_gasoterapia.ie_unidade_medida%type;
ie_urgencia_w				cpoe_fav_gasoterapia.ie_urgencia%type;
ie_via_aplic1_w				cpoe_fav_gasoterapia.ie_via_aplic1%type;
ie_via_aplic2_w				cpoe_fav_gasoterapia.ie_via_aplic2%type;
ie_via_aplic3_w				cpoe_fav_gasoterapia.ie_via_aplic3%type;
nr_seq_gas_w				cpoe_fav_gasoterapia.nr_seq_gas%type;
qt_acima_peep_w				cpoe_fav_gasoterapia.qt_acima_peep%type;
qt_be_w						cpoe_fav_gasoterapia.qt_be%type;
qt_bic_w					cpoe_fav_gasoterapia.qt_bic%type;
qt_dose_mat1_w				cpoe_fav_gasoterapia.qt_dose_mat1%type;
qt_dose_mat2_w				cpoe_fav_gasoterapia.qt_dose_mat2%type;
qt_dose_mat3_w				cpoe_fav_gasoterapia.qt_dose_mat3%type;
qt_fluxo_insp_w				cpoe_fav_gasoterapia.qt_fluxo_insp%type;
qt_freq_vent_w				cpoe_fav_gasoterapia.qt_freq_vent%type;
qt_gasoterapia_w			cpoe_fav_gasoterapia.qt_gasoterapia%type;
qt_min_intervalo_w			cpoe_fav_gasoterapia.qt_min_intervalo%type;
qt_pco2_w					cpoe_fav_gasoterapia.qt_pco2%type;
qt_peep_w					cpoe_fav_gasoterapia.qt_peep%type;
qt_ph_w						cpoe_fav_gasoterapia.qt_ph%type;
qt_pip_w					cpoe_fav_gasoterapia.qt_pip%type;
qt_ps_w						cpoe_fav_gasoterapia.qt_ps%type;
qt_referencia_w				cpoe_fav_gasoterapia.qt_referencia%type;
qt_sato2_w					cpoe_fav_gasoterapia.qt_sato2%type;
qt_sensib_resp_w			cpoe_fav_gasoterapia.qt_sensib_resp%type;
qt_tempo_insp_w				cpoe_fav_gasoterapia.qt_tempo_insp%type;
qt_ti_te_w					cpoe_fav_gasoterapia.qt_ti_te%type;
qt_vc_prog_w				cpoe_fav_gasoterapia.qt_vc_prog%type;
cd_intervalo_agora_w		cpoe_fav_gasoterapia.cd_intervalo%type;

nr_sequencia_w				cpoe_gasoterapia.nr_sequencia%type;
dt_inicio_w					cpoe_gasoterapia.dt_inicio%type;
hr_prim_horario_w			cpoe_gasoterapia.hr_prim_horario%type;
nr_ocorrencia_w				cpoe_gasoterapia.nr_ocorrencia%type;
ds_horarios_w				cpoe_gasoterapia.ds_horarios%type;
ds_horarios_aux_w			cpoe_gasoterapia.ds_horarios%type;
dt_fim_w					cpoe_gasoterapia.dt_fim%type;
QT_HORA_FASE_w				cpoe_gasoterapia.QT_HORA_FASE%type;
qt_fracao_oxigenio_w	    cpoe_gasoterapia.qt_fracao_oxigenio%type;

ie_operacao_w				intervalo_prescricao.ie_operacao%type;
ie_dose_unica_cpoe_w		intervalo_prescricao.ie_dose_unica_cpoe%type;

qt_tempo_etapa_w			double precision;
ie_continuo_w				char(1);
ie_prescr_alta_agora_w		varchar(1);

c01 CURSOR FOR
SELECT	cd_intervalo,
		cd_intervalo_mat1,
		cd_intervalo_mat2,
		cd_intervalo_mat3,
		cd_mat_equip1,
		cd_mat_equip2,
		cd_mat_equip3,
		cd_modalidade_vent,
		cd_unid_med_dose1,
		cd_unid_med_dose2,
		cd_unid_med_dose3,
		ds_observacao,
		dt_tempo_duracao,
		ie_acm,
		coalesce(ie_administracao,'P'),
		ie_disp_resp_esp,
		ie_duracao,
		ie_evento_unico,
		ie_inicio,
		ie_modo_adm,
		ie_periodo,
		ie_respiracao,
		ie_se_necessario,
		ie_tipo_onda,
		ie_unidade_medida,
		ie_urgencia,
		ie_via_aplic1,
		ie_via_aplic2,
		ie_via_aplic3,
		nr_seq_gas,
		qt_acima_peep,
		qt_be,
		qt_bic,
		qt_dose_mat1,
		qt_dose_mat2,
		qt_dose_mat3,
		qt_fluxo_insp,
		qt_freq_vent,
		qt_gasoterapia,
		qt_min_intervalo,
		qt_pco2,
		qt_peep,
		qt_ph,
		qt_pip,
		qt_ps,
		qt_referencia,
		qt_sato2,
		qt_sensib_resp,
		qt_tempo_insp,
		qt_ti_te,
		qt_vc_prog,
		QT_HORA_FASE,
		qt_fracao_oxigenio
from	cpoe_fav_gasoterapia
where	nr_sequencia = nr_sequencia_p;
						

BEGIN
ie_prescr_alta_agora_w := obter_param_usuario(924, 409, cd_perfil_p, nm_usuario_p, cd_estabelecimento_p, ie_prescr_alta_agora_w);
open c01;
loop
fetch c01 into	cd_intervalo_w,
				cd_intervalo_mat1_w,
				cd_intervalo_mat2_w,
				cd_intervalo_mat3_w,
				cd_mat_equip1_w,
				cd_mat_equip2_w,
				cd_mat_equip3_w,
				cd_modalidade_vent_w,
				cd_unid_med_dose1_w,
				cd_unid_med_dose2_w,
				cd_unid_med_dose3_w,
				ds_observacao_w,
				dt_tempo_duracao_w,
				ie_acm_w,
				ie_administracao_w,
				ie_disp_resp_esp_w,
				ie_duracao_w,
				ie_evento_unico_w,
				ie_inicio_w,
				ie_modo_adm_w,
				ie_periodo_w,
				ie_respiracao_w,
				ie_se_necessario_w,
				ie_tipo_onda_w,
				ie_unidade_medida_w,
				ie_urgencia_w,
				ie_via_aplic1_w,
				ie_via_aplic2_w,
				ie_via_aplic3_w,
				nr_seq_gas_w,
				qt_acima_peep_w,
				qt_be_w,
				qt_bic_w,
				qt_dose_mat1_w,
				qt_dose_mat2_w,
				qt_dose_mat3_w,
				qt_fluxo_insp_w,
				qt_freq_vent_w,
				qt_gasoterapia_w,
				qt_min_intervalo_w,
				qt_pco2_w,
				qt_peep_w,
				qt_ph_w,
				qt_pip_w,
				qt_ps_w,
				qt_referencia_w,
				qt_sato2_w,
				qt_sensib_resp_w,
				qt_tempo_insp_w,
				qt_ti_te_w,
				qt_vc_prog_w,
				QT_HORA_FASE_w,
				qt_fracao_oxigenio_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
	ie_urgencia_w := '';
	
	if (ie_modo_adm_w = 'C') then
		ie_continuo_w	:= 'S';
	else
		ie_continuo_w	:= 'N';
	end if;
	
	if (coalesce(obter_se_marca_agora(cpoe_obter_setor_atend_prescr(nr_atendimento_p, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p)),'N') = 'S') then
		cd_intervalo_agora_w := cpoe_busca_intervalo_agora(nr_atendimento_p,'G',cd_estabelecimento_p,cd_perfil_p, nm_usuario_p, ie_continuo_w);
	
		if (cd_intervalo_agora_w IS NOT NULL AND cd_intervalo_agora_w::text <> '') then
			cd_intervalo_w := cd_intervalo_agora_w;
			ie_urgencia_w  := 0;			
		end if;
		
	end if;		
	
	select	coalesce(max(qt_min_intervalo),0),
			max(ie_operacao),
			coalesce(max(ie_dose_unica_cpoe), 'N')
	into STRICT	qt_min_intervalo_w,
			ie_operacao_w,
			ie_dose_unica_cpoe_w
	from	intervalo_prescricao
	where	cd_intervalo	= cd_intervalo_w;
	

	if (coalesce(ie_dose_unica_cpoe_w, 'N') = 'S') then
		ie_administracao_w := 'P';
		ie_duracao_w := 'P';
		ie_se_necessario_w 	:= 'N';
		ie_acm_w			:= 'N';
	end if;	
	
	ds_horarios_w		:= '';
	dt_inicio_w 		:= clock_timestamp();
		
	if (coalesce(ie_prescr_alta_agora_w,'N') = 'S') and (coalesce(ie_item_alta_p,'N') = 'S')	then	

		ie_urgencia_w := 0;		

		select	max(qt_min_intervalo)
		into STRICT	qt_min_intervalo_w
		from	intervalo_prescricao
		where	cd_intervalo = cd_intervalo_w;

		SELECT * FROM cpoe_calcular_horario_prescr(nr_atendimento_p, cd_intervalo_w, null, clock_timestamp(), 0, qt_min_intervalo_w, nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w, nm_usuario_p, cd_estabelecimento_p, cd_perfil_p, null) INTO STRICT nr_ocorrencia_w, ds_horarios_w, ds_horarios_aux_w;

		ds_horarios_w	:= ds_horarios_w || ds_horarios_aux_w;

		hr_prim_horario_w	:= obter_prim_dshorarios(ds_horarios_w);

		dt_inicio_w	:= to_date(to_char(clock_timestamp(),'dd/mm/yyyy ') || hr_prim_horario_w, 'dd/mm/yyyy hh24:mi');

		if (dt_inicio_w < clock_timestamp()) then

			dt_inicio_w := dt_inicio_w + 1;

		end if;
	else	
		SELECT * FROM cpoe_atualizar_periodo_vig_ant(ds_horarios_w, hr_prim_horario_w, dt_inicio_w) INTO STRICT ds_horarios_w, hr_prim_horario_w, dt_inicio_w;
	end if;
		
	if ((coalesce(ie_administracao_w,'P') = 'P') or (cd_intervalo_agora_w IS NOT NULL AND cd_intervalo_agora_w::text <> '')) then
		if (coalesce(ie_urgencia_w::text, '') = '') then
			dt_inicio_w := trunc(dt_inicio_w,'hh24');
			dt_inicio_w := dt_inicio_w + 1/24;
			
			hr_prim_horario_w  := substr(cpoe_obter_primeiro_horario( nr_atendimento_p, cd_intervalo_w, null, cd_estabelecimento_p, cd_perfil_p, nm_usuario_p, cd_pessoa_fisica_p),1,5);

			if (hr_prim_horario_w IS NOT NULL AND hr_prim_horario_w::text <> '') then
				dt_inicio_w	:= to_date(to_char(dt_inicio_w,'dd/mm/yyyy ')  || hr_prim_horario_w, 'dd/mm/yyyy hh24:mi');				
			end if;
		elsif (ie_urgencia_w = '0') then
			dt_inicio_w := dt_inicio_w + 1/1440;
		elsif (ie_urgencia_w = '5') then
			dt_inicio_w := dt_inicio_w + 5/1440;
		elsif (ie_urgencia_w = '10') then
			dt_inicio_w := dt_inicio_w + 10/1440;
		elsif (ie_urgencia_w = '15') then
			dt_inicio_w := dt_inicio_w + 15/1440;	
		end if;
		
		hr_prim_horario_w := to_char(dt_inicio_w,'hh24:mi');
	end if;
	
	if (dt_inicio_w < clock_timestamp()) then
		dt_inicio_w := dt_inicio_w + 1;
	end if;
		
	if (cd_intervalo_w IS NOT NULL AND cd_intervalo_w::text <> '') and (ie_operacao_w = 'D') then
		dt_inicio_w := obter_proxima_dose_medic(dt_inicio_w, cd_intervalo_w, null, 'N');
	end if;
		
	nr_ocorrencia_w 	:= null;
	ds_horarios_w		:= null;
		
	qt_tempo_etapa_w	:= null;
	if (QT_HORA_FASE_w IS NOT NULL AND QT_HORA_FASE_w::text <> '') then
		qt_tempo_etapa_w	:= dividir(obter_minutos_hora(QT_HORA_FASE_w),60);
	end if;
	
	SELECT * FROM CPOE_Calcula_horarios_etapas(	nm_usuario_p, dt_inicio_w, ie_continuo_w, nr_ocorrencia_w, cd_intervalo_w, 24, qt_tempo_etapa_w, null, 'N') INTO STRICT nr_ocorrencia_w, ds_horarios_w;
	
	if (ie_administracao_w in ('C','N')) then
		ds_horarios_w	:= null;
	elsif (coalesce(ds_horarios_w::text, '') = '') then
		ds_horarios_w	:= hr_prim_horario_w;
		nr_ocorrencia_w	:= 1;
	end if;
									
	dt_fim_w := null;
	if (ie_duracao_w = 'P') then
		dt_fim_w := (dt_inicio_w + 1) - 1/1440;
	end if;	
	
	if (ie_retrogrado_p = 'S' or ie_futuro_p = 'S') then -- retrograde/backward item
		dt_inicio_w := dt_inicio_p;
		dt_fim_w := (dt_inicio_w + 1) - 1/1440;		
		ie_urgencia_w := null;		
		ie_duracao_w := 'P';
		nr_ocorrencia_w := null;
		ds_horarios_w	:= '';

		SELECT * FROM CPOE_Calcula_horarios_etapas(	nm_usuario_p, dt_inicio_w, ie_continuo_w, nr_ocorrencia_w, cd_intervalo_w, 24, null, null, 'N', ie_duracao_w, dt_fim_w) INTO STRICT nr_ocorrencia_w, ds_horarios_w;
										
		hr_prim_horario_w  := obter_prim_dshorarios(ds_horarios_w);
	end if;
	
	select	nextval('cpoe_gasoterapia_seq')
	into STRICT	nr_sequencia_w
	;	

	insert into cpoe_gasoterapia(
					nr_sequencia,
					nr_atendimento,
					cd_pessoa_fisica,
					nm_usuario,
					dt_atualizacao,
					nm_usuario_nrec,
					dt_atualizacao_nrec,
					dt_inicio,
					dt_fim,
					hr_prim_horario,
					ds_horarios,
					nr_ocorrencia,
					cd_intervalo,
					cd_intervalo_mat1,
					cd_intervalo_mat2,
					cd_intervalo_mat3,
					cd_mat_equip1,
					cd_mat_equip2,
					cd_mat_equip3,
					cd_modalidade_vent,
					cd_unid_med_dose1,
					cd_unid_med_dose2,
					cd_unid_med_dose3,
					ds_observacao,
					dt_tempo_duracao,
					ie_acm,
					ie_administracao,
					ie_disp_resp_esp,
					ie_duracao,
					ie_evento_unico,
					ie_inicio,
					ie_modo_adm,
					ie_periodo,
					ie_respiracao,
					ie_se_necessario,
					ie_tipo_onda,
					ie_unidade_medida,
					ie_urgencia,
					ie_via_aplic1,
					ie_via_aplic2,
					ie_via_aplic3,
					nr_seq_gas,
					qt_acima_peep,
					qt_be,
					qt_bic,
					qt_dose_mat1,
					qt_dose_mat2,
					qt_dose_mat3,
					qt_fluxo_insp,
					qt_freq_vent,
					qt_gasoterapia,
					qt_min_intervalo,
					qt_pco2,
					qt_peep,
					qt_ph,
					qt_pip,
					qt_ps,
					qt_referencia,
					qt_sato2,
					qt_sensib_resp,
					qt_tempo_insp,
					qt_ti_te,
					qt_vc_prog,
					QT_HORA_FASE,
					cd_perfil_ativo,
					cd_funcao_origem,
					nr_seq_transcricao,
					ie_item_alta,
					ie_prescritor_aux,
					cd_medico,
					ie_retrogrado,
					nr_seq_pepo,
					nr_cirurgia,
					nr_cirurgia_patologia,
					nr_seq_agenda,
					nr_seq_conclusao_apae,
					ie_futuro,
					qt_fracao_oxigenio,
					nr_seq_cpoe_order_unit)
				values (
					nr_sequencia_w,
					nr_atendimento_p,
					cd_pessoa_fisica_p,
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					dt_inicio_w,
					dt_fim_w,
					hr_prim_horario_w,
					ds_horarios_w,
					nr_ocorrencia_w,
					cd_intervalo_w,
					cd_intervalo_mat1_w,
					cd_intervalo_mat2_w,
					cd_intervalo_mat3_w,
					cd_mat_equip1_w,
					cd_mat_equip2_w,
					cd_mat_equip3_w,
					cd_modalidade_vent_w,
					cd_unid_med_dose1_w,
					cd_unid_med_dose2_w,
					cd_unid_med_dose3_w,
					ds_observacao_w,
					dt_tempo_duracao_w,
					ie_acm_w,
					ie_administracao_w,
					ie_disp_resp_esp_w,
					ie_duracao_w,
					ie_evento_unico_w,
					ie_inicio_w,
					ie_modo_adm_w,
					ie_periodo_w,
					ie_respiracao_w,
					ie_se_necessario_w,
					ie_tipo_onda_w,
					ie_unidade_medida_w,
					ie_urgencia_w,
					ie_via_aplic1_w,
					ie_via_aplic2_w,
					ie_via_aplic3_w,
					nr_seq_gas_w,
					qt_acima_peep_w,
					qt_be_w,
					qt_bic_w,
					qt_dose_mat1_w,
					qt_dose_mat2_w,
					qt_dose_mat3_w,
					qt_fluxo_insp_w,
					qt_freq_vent_w,
					qt_gasoterapia_w,
					qt_min_intervalo_w,
					qt_pco2_w,
					qt_peep_w,
					qt_ph_w,
					qt_pip_w,
					qt_ps_w,
					qt_referencia_w,
					qt_sato2_w,
					qt_sensib_resp_w,
					qt_tempo_insp_w,
					qt_ti_te_w,
					qt_vc_prog_w,
					QT_HORA_FASE_w,
					cd_perfil_p,
					2314,
					nr_seq_transcricao_p,
					ie_item_alta_p,
					ie_prescritor_aux_p,
					cd_medico_p,
					ie_retrogrado_p,
					nr_seq_pepo_p,
					nr_cirurgia_p,
					nr_cirurgia_patologia_p,
					nr_seq_agenda_p,
					nr_seq_conclusao_apae_p,
					ie_futuro_p,
					qt_fracao_oxigenio_w,
					nr_seq_cpoe_order_unit_p);

    nr_seq_item_gerado_p := nr_sequencia_w;
	
	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_inserir_gasoterapia_fav ( nr_atendimento_p cpoe_gasoterapia.nr_atendimento%type, cd_pessoa_fisica_p cpoe_gasoterapia.cd_pessoa_fisica%type, nr_sequencia_p cpoe_fav_gasoterapia.nr_sequencia%type, nm_usuario_p cpoe_fav_gasoterapia.nm_usuario%type, cd_perfil_p bigint, cd_estabelecimento_p bigint, nr_seq_item_gerado_p INOUT bigint, nr_seq_transcricao_p bigint default null, ie_item_alta_p text default 'N', ie_prescritor_aux_p text default 'N', cd_medico_p bigint default null, ie_retrogrado_p text default 'N', dt_inicio_p timestamp default null, nr_seq_pepo_p bigint default null, nr_cirurgia_p bigint default null, nr_cirurgia_patologia_p bigint default null, nr_seq_agenda_p bigint default null, nr_seq_conclusao_apae_p bigint default null, ie_futuro_p text default 'N', nr_seq_cpoe_rp_p cpoe_rp.nr_sequencia%type default null, nr_seq_cpoe_order_unit_p cpoe_order_unit.nr_sequencia%type default null) FROM PUBLIC;

