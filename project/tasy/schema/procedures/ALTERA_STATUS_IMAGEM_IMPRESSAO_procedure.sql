-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE altera_status_imagem_impressao ( nr_sequencia_p bigint, ie_impressao_p text, nr_prescricao_p bigint, nr_seq_prescricao_p bigint, ie_marca_todas_p text) AS $body$
DECLARE



nr_seq_log_atual_w bigint;
ie_log_w           varchar(10);

nr_seq_captura_w   bigint;
ie_impressao_old_w varchar(10);

C01 CURSOR FOR
  SELECT nr_seq_captura
  FROM   prescr_proc_captura_img
  WHERE  nr_prescricao = nr_prescricao_p
  AND 	 nr_sequencia_prescricao = nr_seq_prescricao_p;

C02 CURSOR FOR
  SELECT ie_impressao
  FROM   captura_imagem
  WHERE  nr_sequencia = nr_seq_captura_w;


BEGIN
  IF ie_marca_todas_p = 'S' THEN
  BEGIN
    OPEN C01;
    LOOP
    FETCH C01 INTO
      nr_seq_captura_w;
    EXIT WHEN NOT FOUND; /* apply on C01 */
      OPEN C02;
      LOOP
      FETCH C02 INTO
        ie_impressao_old_w;
      EXIT WHEN NOT FOUND; /* apply on C02 */
        SELECT * FROM gravar_log_alteracao(ie_impressao_old_w, ie_impressao_p, obter_usuario_ativo, nr_seq_log_atual_w, 'IE_IMPRESSAO', ie_log_w, NULL, 'CAPTURA_IMAGEM', nr_seq_captura_w, NULL) INTO STRICT nr_seq_log_atual_w, ie_log_w;
        ie_log_w := NULL;
      END LOOP;
      CLOSE C02;
    END LOOP;
    CLOSE C01;

    UPDATE captura_imagem
    SET    ie_impressao = ie_impressao_p
    WHERE  nr_sequencia IN (SELECT nr_seq_captura
                            FROM   prescr_proc_captura_img
                            WHERE  nr_prescricao = nr_prescricao_p
                            AND    nr_sequencia_prescricao = nr_seq_prescricao_p);
  END;
  ELSE
  BEGIN
    SELECT ie_impressao
    INTO STRICT   ie_impressao_old_w
    FROM   captura_imagem
    WHERE  nr_sequencia = nr_sequencia_p;

    SELECT * FROM gravar_log_alteracao(ie_impressao_old_w, ie_impressao_p, obter_usuario_ativo, nr_seq_log_atual_w, 'IE_IMPRESSAO', ie_log_w, NULL, 'CAPTURA_IMAGEM', nr_sequencia_p, NULL) INTO STRICT nr_seq_log_atual_w, ie_log_w;

    UPDATE captura_imagem
    SET    ie_impressao = ie_impressao_p
    WHERE  nr_sequencia = nr_sequencia_p;
  END;
  END IF;

  COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE altera_status_imagem_impressao ( nr_sequencia_p bigint, ie_impressao_p text, nr_prescricao_p bigint, nr_seq_prescricao_p bigint, ie_marca_todas_p text) FROM PUBLIC;

