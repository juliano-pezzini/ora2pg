-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_log_lab ( cd_log_p bigint, ds_log_p text, nm_usuario_p text, nr_prescricao_p bigint default null, ds_integracao_p text default null) AS $body$
DECLARE


cd_log_w integer;
nr_prescricao_w bigint;

ds_log_w varchar(2000);
nm_usuario_w varchar(15);
ds_integracao_w varchar(255);

/*
Realiza a validação dos inputs e insere na tabela log_lab.
Se houver disparo de erro, é tentado gravar log do erro e é impresso o erro:
    dbms_output.put_line(sqlerrm);

O input cd_log_p é validado em tamanho (cortado em cinco caracteres) e recebe zero se houver disparo de algum erro ou se for nulo.
O input nr_prescricao_p é validado em tamanho (cortado em quatorze caracteres) e recebe zero se houver disparo de algum erro ou se for nulo.
O input nm_usuario_p é validado em tamanho (cortado em quinze caracteres) e recebe 'Tasy' se houver disparo de algum erro ou se for nulo.
O input ds_log_p é validado em tamanho (cortado em dois mil caracteres).
O input ds_integracao_p é validado em tamanho (cortado em duzentos e cinquenta e cinco caracteres).
*/
BEGIN

    --Valida código do log, zero como default.
    begin
        if (coalesce(cd_log_p::text, '') = '') then
            cd_log_w := 0;
        elsif (cd_log_p > 99999) then
            cd_log_w := (substr(to_char(cd_log_p), 1, 5))::numeric;
        elsif (cd_log_p < -99999) then
            cd_log_w := (substr(to_char(cd_log_p), 1, 6))::numeric;
        else
            cd_log_w := cd_log_p;
        end if;
    exception when others then
        cd_log_w := 0;
    end;

    --Valida número da prescrição, zero como default
    begin
        if (coalesce(nr_prescricao_p::text, '') = '') then
            nr_prescricao_w := 0;
        else
            nr_prescricao_w := (substr(to_char(nr_prescricao_p), 1, 14))::numeric;
        end if;
    exception when others then
        nr_prescricao_w := 0;
    end;

    --Valida nome do usuário, 'Tasy' como default
    begin
        if (coalesce(nm_usuario_p::text, '') = '') then
            nm_usuario_w := 'Tasy';
        else
            nm_usuario_w := substr(nm_usuario_p, 1, 14);
        end if;
    exception when others then
        nm_usuario_w := 'Tasy';
    end;

    begin

        --Valida o tamanho da descrição do log e da integração
        ds_log_w := substr(ds_log_p, 1, 2000);
        ds_integracao_w := substr(ds_integracao_p, 1, 255);

        --Realiza a inserção na tabela de logs
        insert into log_lab(
            dt_atualizacao,
            nm_usuario,
            cd_log,
            ds_log,
            nr_prescricao,
            ds_integracao
        ) values (
            clock_timestamp(),
            nm_usuario_w,
            cd_log_w,
            ds_log_w,
            nr_prescricao_w,
            ds_integracao_w
        );
    exception when others then
        --Trata erro
        begin
            --print do erro identificado
            RAISE NOTICE '%', sqlerrm;
            --prepara para gravar o log com a mensagem de erro gerado
            ds_log_w := substr(sqlerrm, 1, 2000);

            --Realiza a inserção na tabela de logs da mensagem de erro
            insert into log_lab(
                dt_atualizacao,
                nm_usuario,
                cd_log,
                ds_log,
                nr_prescricao
            ) values (
                clock_timestamp(),
                nm_usuario_w,
                cd_log_w,
                ds_log_w,
                nr_prescricao_w
            );
        exception when others then
            --Evita disparo de exceção para os processos que chamam essa procedure
            return;
        end;
    end;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_log_lab ( cd_log_p bigint, ds_log_p text, nm_usuario_p text, nr_prescricao_p bigint default null, ds_integracao_p text default null) FROM PUBLIC;

