-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_documento_nota_fiscal (nr_sequencia_p nota_fiscal.nr_sequencia%type, cd_tipo_lote_contabil_p bigint, cd_estabelecimento_p nota_fiscal.cd_estabelecimento%type, nm_usuario_p text) AS $body$
DECLARE


ds_comando_w            varchar(255);
ds_param_sql_w          varchar(2000);
vl_movimento_w          double precision;
nr_documento_w          ctb_documento.nr_documento%type;
nr_seq_doc_compl_w      ctb_documento.nr_seq_doc_compl%type;
nr_doc_analitico_w      ctb_documento.nr_doc_analitico%type;
dt_movimento_w          ctb_documento.dt_competencia%type;
cd_estabelecimento_w    ctb_documento.cd_estabelecimento%type;
ie_data_contab_nf_w     parametro_estoque.ie_data_contab_nf%type;
ie_data_contab_est_nf_w parametro_estoque.ie_data_contab_est_nf%type;
ie_data_movto_lote_nf_w parametro_estoque.ie_data_movto_lote_nf%type;
dt_movto_lote_nf_w      ctb_documento.dt_competencia%type;
nr_nota_fiscal_w        nota_fiscal.nr_nota_fiscal%type;
ie_contab_nf_estab_w    parametro_estoque.ie_contab_nf_estab%type;
count_w                 double precision := 0;
nr_seq_proj_rec_capa    ctb_documento.nr_seq_proj_rec%type;

c01 CURSOR FOR
    SELECT  nm_atributo,
            nm_tabela
    from    tabela_atributo
    where   nm_tabela in ('NOTA_FISCAL',
                          'NOTA_FISCAL_ITEM',
                          'NOTA_FISCAL_ITEM_RATEIO',
                          'NOTA_FISCAL_ITEM_TRIB',
                          'NOTA_FISCAL_TRIB',
                          'NOTA_FISCAL_VENC_TRIB',
                          'FIS_RATEIO_TRIB_ITEM',
                          'NOTA_FISCAL_DESP_ADIC')
    and     substr(nm_atributo,1,2) = 'VL'
    and     ie_tipo_atributo = 'NUMBER'
    order by nm_tabela;

c01_w c01%rowtype;

c02 CURSOR FOR
    SELECT  nr_item_nf,
            nr_seq_proj_rec
    from    nota_fiscal_item
    where   nr_sequencia = nr_sequencia_p 
    order by nr_item_nf;

c02_w c02%rowtype;

c03 CURSOR FOR
    SELECT  nr_item_nf,
            nr_sequencia
    from    nota_fiscal_item_rateio
    where   nr_seq_nota = nr_sequencia_p
    order by nr_item_nf;

c03_w c03%rowtype;

c04 CURSOR FOR
    SELECT  nr_item_nf,
            nr_sequencia,
            cd_tributo
    from    nota_fiscal_item_trib
    where   nr_sequencia = nr_sequencia_p
    order by nr_item_nf;

c04_w c04%rowtype;

c05 CURSOR FOR
    SELECT  nr_seq_interno nr_sequencia,
            cd_tributo
    from    nota_fiscal_trib
    where   nr_sequencia = nr_sequencia_p
    order by cd_tributo;

c05_w c05%rowtype;

c06 CURSOR FOR
    SELECT  nr_sequencia,
            cd_tributo,
            dt_vencimento
    from    nota_fiscal_venc_trib
    where   nr_sequencia = nr_sequencia_p
    order by cd_tributo;

c06_w c06%rowtype;

c07 CURSOR FOR
    SELECT  vl_rateio,
            nr_sequencia nr_seq_fis_rateio_trib_item
    from    fis_rateio_trib_item
    where   nr_seq_nota_fiscal = nr_sequencia_p
    and     nr_item_nf = c04_w.nr_item_nf
    and     cd_tributo = c04_w.cd_tributo;

c07_w c07%rowtype;

c08 CURSOR FOR
    SELECT  a.vl_documento,
            a.nr_sequencia nr_seq_nota_fiscal_desp_adic
    from    nota_fiscal           c,
            pessoa_juridica       b,
            nota_fiscal_desp_adic a
    where   a.nr_seq_nf = c.nr_sequencia
    and     a.nr_seq_nf = nr_sequencia_p
    and     a.cd_cgc = b.cd_cgc;

c08_w c08%rowtype;

procedure ctb_gravar_documento_nota(cd_estabelecimento_p    ctb_documento.cd_estabelecimento%type,
                                    cd_tipo_lote_contabil_p ctb_documento.cd_tipo_lote_contabil%type,
                                    dt_competencia_p        ctb_documento.dt_competencia%type,
                                    nr_seq_trans_financ_p   ctb_documento.nr_seq_trans_financ%type,
                                    nr_seq_info_p           ctb_documento.nr_seq_info%type,
                                    nr_documento_p          ctb_documento.nr_documento%type,
                                    nr_seq_doc_compl_p      ctb_documento.nr_seq_doc_compl%type,
                                    nr_doc_analitico_p      ctb_documento.nr_doc_analitico%type,
                                    vl_movimento_p          ctb_documento.vl_movimento%type,
                                    nm_tabela_p             ctb_documento.nm_tabela%type,
                                    nm_atributo_p           ctb_documento.nm_atributo%type,
                                    nm_usuario_p          ctb_documento.nm_usuario%type,
                                    nr_seq_proj_rec_p     ctb_documento.nr_seq_proj_rec%type) is

;
BEGIN

    if (coalesce(vl_movimento_w,0) <> 0) then
        begin
            CALL ctb_concil_financeira_pck.ctb_gravar_documento( cd_estabelecimento_p,
                                                            dt_competencia_p,
                                                            cd_tipo_lote_contabil_p,
                                                            nr_seq_trans_financ_p,
                                                            nr_seq_info_p,
                                                            nr_documento_p,
                                                            nr_seq_doc_compl_p,
                                                            nr_doc_analitico_p,
                                                            vl_movimento_p,
                                                            nm_tabela_p,
                                                            nm_atributo_p,
                                                            nm_usuario_p,
                                                            'P',
                                                            null,
                                                            nr_seq_proj_rec_p);

        end;
    end if;

end;

begin

nr_seq_proj_rec_capa := OBTER_PROJETO_NOTA_FISCAL(nr_sequencia_p);


delete from ctb_documento
where  nr_documento = nr_sequencia_p
and    cd_estabelecimento = cd_estabelecimento_p
and    cd_tipo_lote_contabil = cd_tipo_lote_contabil_p;

select  x.*
into STRICT    ie_data_contab_est_nf_w,
        ie_data_contab_nf_w
from (SELECT  a.ie_data_contab_est_nf,
                a.ie_data_contab_nf
        from    ctb_param_lote_nf a
        where   a.cd_empresa = obter_empresa_estab(cd_estabelecimento_p)
        and     coalesce(a.cd_estab_exclusivo,cd_estabelecimento_p) = cd_estabelecimento_p
        order by coalesce(a.cd_estab_exclusivo,0) desc) x LIMIT 1;

select  max(CASE WHEN ie_acao_nf=1 THEN                  CASE WHEN ie_data_contab_nf_w='ES' THEN dt_entrada_saida WHEN ie_data_contab_nf_w='ATU' THEN dt_atualizacao WHEN ie_data_contab_nf_w='EST' THEN dt_atualizacao_estoque WHEN ie_data_contab_nf_w='OPE' THEN                           CASE WHEN Obter_Regra_Contab_Nf_Operacao(nr_sequencia_p)='ES' THEN dt_entrada_saida WHEN Obter_Regra_Contab_Nf_Operacao(nr_sequencia_p)='ATU' THEN dt_atualizacao WHEN Obter_Regra_Contab_Nf_Operacao(nr_sequencia_p)='EST' THEN dt_atualizacao_estoque  ELSE dt_emissao END   ELSE dt_emissao END   ELSE CASE WHEN ie_data_contab_est_nf_w='ES' THEN dt_entrada_saida WHEN ie_data_contab_est_nf_w='ATU' THEN dt_atualizacao WHEN ie_data_contab_est_nf_w='EST' THEN dt_atualizacao_estoque WHEN ie_data_contab_est_nf_w='OPE' THEN                           CASE WHEN Obter_Regra_Contab_Nf_Operacao(nr_sequencia_p)='ES' THEN dt_entrada_saida WHEN Obter_Regra_Contab_Nf_Operacao(nr_sequencia_p)='ATU' THEN dt_atualizacao WHEN Obter_Regra_Contab_Nf_Operacao(nr_sequencia_p)='EST' THEN dt_atualizacao_estoque  ELSE dt_emissao END   ELSE dt_emissao END  END ) dt_movimento,
        max(nr_nota_fiscal)
into STRICT    dt_movimento_w,
        nr_nota_fiscal_w
from    nota_fiscal
where   nr_sequencia = nr_sequencia_p;

dt_movimento_w := trunc(dt_movimento_w,'dd');

open c01;
loop
    fetch c01
        into c01_w;
    EXIT WHEN NOT FOUND; /* apply on c01 */
    begin
        count_w        := count_w + 1;
        vl_movimento_w := null;
        if (c01_w.nm_tabela = 'NOTA_FISCAL') then
            begin

                ds_comando_w   := 'select ' || c01_w.nm_atributo || ' vl_retorno_w from Nota_fiscal ' || 'where nr_sequencia = :nr_sequencia';
                ds_param_sql_w := 'nr_sequencia=' || nr_sequencia_p || ';';

                vl_movimento_w := Obter_Valor_Dinamico_Bv(ds_comando_w, ds_param_sql_w, vl_movimento_w);

                nr_documento_w       := nr_sequencia_p;
                nr_seq_doc_compl_w   := null;
                nr_doc_analitico_w   := null;
                cd_estabelecimento_w := cd_estabelecimento_p;

                ctb_gravar_documento_nota(cd_estabelecimento_w,
                                          cd_tipo_lote_contabil_p,
                                          dt_movimento_w,
                                          null,
                                          1,
                                          nr_documento_w,
                                          nr_seq_doc_compl_w,
                                          nr_doc_analitico_w,
                                          vl_movimento_w,
                                          c01_w.nm_tabela,
                                          c01_w.nm_atributo,
                                          nm_usuario_p,
                                          nr_seq_proj_rec_capa);

            end;
        elsif (c01_w.nm_tabela = 'NOTA_FISCAL_ITEM') then
            begin

                open c02;
                loop
                    fetch c02
                        into c02_w;
                    EXIT WHEN NOT FOUND; /* apply on c02 */
                    begin

                        ds_comando_w   := 'select ' || c01_w.nm_atributo || ' vl_retorno_w From Nota_fiscal_item ' || ' Where nr_sequencia = :nr_sequencia' || ' and nr_item_nf = :nr_item_nf';
                        ds_param_sql_w := 'nr_sequencia=' || nr_sequencia_p || ';nr_item_nf=' || c02_w.nr_item_nf;

                        vl_movimento_w := Obter_Valor_Dinamico_Bv(ds_comando_w, ds_param_sql_w, vl_movimento_w);

                        nr_documento_w       := nr_sequencia_p;
                        nr_seq_doc_compl_w   := c02_w.nr_item_nf;
                        nr_doc_analitico_w   := null;
                        cd_estabelecimento_w := cd_estabelecimento_p;

                        ctb_gravar_documento_nota(cd_estabelecimento_w,
                                                  cd_tipo_lote_contabil_p,
                                                  dt_movimento_w,
                                                  null,
                                                  1,
                                                  nr_documento_w,
                                                  nr_seq_doc_compl_w,
                                                  nr_doc_analitico_w,
                                                  vl_movimento_w,
                                                  c01_w.nm_tabela,
                                                  c01_w.nm_atributo,
                                                  nm_usuario_p,
                                                  c02_w.nr_seq_proj_rec);

                    end;
                end loop;
                close c02;

            end;
        elsif (c01_w.nm_tabela = 'NOTA_FISCAL_ITEM_RATEIO') then
            begin

                open c03;
                loop
                    fetch c03
                        into c03_w;
                    EXIT WHEN NOT FOUND; /* apply on c03 */
                    begin

                        ds_comando_w := 'select ' || c01_w.nm_atributo || ' vl_retorno_w From Nota_fiscal_item_rateio ' || ' Where nr_seq_nota = :nr_sequencia' || ' and nr_item_nf = :nr_item_nf and nr_sequencia = :nr_seq_item_rateio';

                        ds_param_sql_w := 'nr_sequencia=' || nr_sequencia_p || ';nr_item_nf=' || c03_w.nr_item_nf || ';nr_seq_item_rateio=' || c03_w.nr_sequencia;

                        vl_movimento_w := Obter_Valor_Dinamico_Bv(ds_comando_w, ds_param_sql_w, vl_movimento_w);

                        nr_documento_w       := nr_sequencia_p;
                        nr_seq_doc_compl_w   := c03_w.nr_item_nf;
                        nr_doc_analitico_w   := c03_w.nr_sequencia;
                        cd_estabelecimento_w := cd_estabelecimento_p;

                        ctb_gravar_documento_nota(cd_estabelecimento_w,
                                                  cd_tipo_lote_contabil_p,
                                                  dt_movimento_w,
                                                  null,
                                                  1,
                                                  nr_documento_w,
                                                  nr_seq_doc_compl_w,
                                                  nr_doc_analitico_w,
                                                  vl_movimento_w,
                                                  c01_w.nm_tabela,
                                                  c01_w.nm_atributo,
                                                  nm_usuario_p,
                                                  nr_seq_proj_rec_capa);

                    end;
                end loop;
                close c03;

            end;
        elsif (c01_w.nm_tabela = 'NOTA_FISCAL_ITEM_TRIB') then
            begin

                open c04;
                loop
                    fetch c04
                        into c04_w;
                    EXIT WHEN NOT FOUND; /* apply on c04 */
                    begin

                        ds_comando_w   := 'select ' || c01_w.nm_atributo || ' vl_retorno_w From Nota_fiscal_item_trib ' || 'Where nr_sequencia = :nr_sequencia' || '  and nr_item_nf   = :nr_item_nf' || '  and cd_tributo   = :cd_tributo';
                        ds_param_sql_w := 'nr_sequencia=' || nr_sequencia_p || ';nr_item_nf=' || c04_w.nr_item_nf || ';cd_tributo=' || c04_w.cd_tributo;

                        vl_movimento_w := Obter_Valor_Dinamico_Bv(ds_comando_w, ds_param_sql_w, vl_movimento_w);

                        nr_documento_w       := nr_sequencia_p;
                        nr_seq_doc_compl_w   := c04_w.nr_item_nf;
                        nr_doc_analitico_w   := c04_w.nr_sequencia;
                        cd_estabelecimento_w := cd_estabelecimento_p;

                        ctb_gravar_documento_nota(cd_estabelecimento_w,
                                                  cd_tipo_lote_contabil_p,
                                                  dt_movimento_w,
                                                  null,
                                                  1,
                                                  nr_documento_w,
                                                  nr_seq_doc_compl_w,
                                                  nr_doc_analitico_w,
                                                  vl_movimento_w,
                                                  c01_w.nm_tabela,
                                                  c01_w.nm_atributo,
                                                  nm_usuario_p,
                                                  nr_seq_proj_rec_capa);

                    end;
                end loop;
                close c04;

            end;
        elsif (c01_w.nm_tabela = 'NOTA_FISCAL_TRIB') then
            begin

                open c05;
                loop
                    fetch c05
                        into c05_w;
                    EXIT WHEN NOT FOUND; /* apply on c05 */
                    begin

                        ds_comando_w   := 'select ' || c01_w.nm_atributo || ' vl_retorno_w From Nota_fiscal_Trib ' || ' Where nr_sequencia = :nr_sequencia' || ' and cd_tributo = :cd_tributo';
                        ds_param_sql_w := 'nr_sequencia=' || nr_sequencia_p || ';cd_tributo=' || c05_w.cd_tributo;

                        vl_movimento_w := Obter_Valor_Dinamico_Bv(ds_comando_w, ds_param_sql_w, vl_movimento_w);

                        nr_documento_w       := nr_sequencia_p;
                        nr_seq_doc_compl_w   := c05_w.nr_sequencia;
                        nr_doc_analitico_w   := null;
                        cd_estabelecimento_w := cd_estabelecimento_p;

                        ctb_gravar_documento_nota(cd_estabelecimento_w,
                                                  cd_tipo_lote_contabil_p,
                                                  dt_movimento_w,
                                                  null,
                                                  1,
                                                  nr_documento_w,
                                                  nr_seq_doc_compl_w,
                                                  nr_doc_analitico_w,
                                                  vl_movimento_w,
                                                  c01_w.nm_tabela,
                                                  c01_w.nm_atributo,
                                                  nm_usuario_p,
                                                  nr_seq_proj_rec_capa);

                    end;
                end loop;
                close c05;

            end;
        elsif (c01_w.nm_tabela = 'NOTA_FISCAL_VENC_TRIB') then
            begin

                open c06;
                loop
                    fetch c06
                        into c06_w;
                    EXIT WHEN NOT FOUND; /* apply on c06 */
                    begin
                        ds_comando_w   := 'select ' || c01_w.nm_atributo || ' vl_retorno_w From Nota_fiscal_venc_Trib ' || ' Where nr_sequencia = :nr_sequencia' || ' and cd_tributo = :cd_tributo' || ' and dt_vencimento = :dt_vencimento';
                        ds_param_sql_w := 'nr_sequencia=' || nr_sequencia_p || ';cd_tributo=' || c06_w.cd_tributo || ';dt_vencimento=' || c06_w.dt_vencimento;

                        vl_movimento_w := Obter_Valor_Dinamico_Bv(ds_comando_w, ds_param_sql_w, vl_movimento_w);

                        nr_documento_w       := nr_sequencia_p;
                        nr_seq_doc_compl_w   := c06_w.nr_sequencia;
                        nr_doc_analitico_w   := null;
                        cd_estabelecimento_w := cd_estabelecimento_p;

                        ctb_gravar_documento_nota(cd_estabelecimento_w,
                                                  cd_tipo_lote_contabil_p,
                                                  dt_movimento_w,
                                                  null,
                                                  1,
                                                  nr_documento_w,
                                                  nr_seq_doc_compl_w,
                                                  nr_doc_analitico_w,
                                                  vl_movimento_w,
                                                  c01_w.nm_tabela,
                                                  c01_w.nm_atributo,
                                                  nm_usuario_p,
                                                  nr_seq_proj_rec_capa);

                    end;
                end loop;
                close c06;

            end;
        elsif (c01_w.nm_tabela = 'FIS_RATEIO_TRIB_ITEM') then
            begin

                open c04;
                loop
                    fetch c04
                        into c04_w;
                    EXIT WHEN NOT FOUND; /* apply on c04 */
                    begin

                        open c07;
                        loop
                            fetch c07
                                into c07_w;
                            EXIT WHEN NOT FOUND; /* apply on c07 */
                            begin

                                vl_movimento_w       := c07_w.vl_rateio;
                                nr_documento_w       := nr_sequencia_p;
                                nr_seq_doc_compl_w   := c04_w.nr_item_nf;
                                nr_doc_analitico_w   := c07_w.nr_seq_fis_rateio_trib_item;
                                cd_estabelecimento_w := cd_estabelecimento_p;

                                ctb_gravar_documento_nota(cd_estabelecimento_w,
                                                          cd_tipo_lote_contabil_p,
                                                          dt_movimento_w,
                                                          null,
                                                          1,
                                                          nr_documento_w,
                                                          nr_seq_doc_compl_w,
                                                          nr_doc_analitico_w,
                                                          vl_movimento_w,
                                                          c01_w.nm_tabela,
                                                          c01_w.nm_atributo,
                                                          nm_usuario_p,
                                                          nr_seq_proj_rec_capa);

                            end;
                        end loop;
                        close c07;

                    end;
                end loop;
                close c04;

            end;

        elsif (c01_w.nm_tabela = 'NOTA_FISCAL_DESP_ADIC') then
            begin
            
                open c08;
                loop
                    fetch c08
                        into c08_w;
                    EXIT WHEN NOT FOUND; /* apply on c08 */
                    begin

                        vl_movimento_w       := c08_w.vl_documento;
                        nr_documento_w       := nr_sequencia_p;
                        nr_seq_doc_compl_w   := c08_w.nr_seq_nota_fiscal_desp_adic;
                        nr_doc_analitico_w   := null;
                        cd_estabelecimento_w := cd_estabelecimento_p;

                        ctb_gravar_documento_nota(cd_estabelecimento_w,
                                                  cd_tipo_lote_contabil_p,
                                                  dt_movimento_w,
                                                  null,
                                                  1,
                                                  nr_documento_w,
                                                  nr_seq_doc_compl_w,
                                                  nr_doc_analitico_w,
                                                  vl_movimento_w,
                                                  c01_w.nm_tabela,
                                                  c01_w.nm_atributo,
                                                  nm_usuario_p,
                                                  nr_seq_proj_rec_capa);

                    end;
                end loop;
                close c08;

            end;

        end if;

    end;
end loop;

close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_documento_nota_fiscal (nr_sequencia_p nota_fiscal.nr_sequencia%type, cd_tipo_lote_contabil_p bigint, cd_estabelecimento_p nota_fiscal.cd_estabelecimento%type, nm_usuario_p text) FROM PUBLIC;

