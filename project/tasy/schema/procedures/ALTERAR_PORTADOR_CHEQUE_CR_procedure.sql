-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE alterar_portador_cheque_cr (nr_seq_cheque_p bigint, cd_tipo_portador_p bigint, cd_portador_p bigint, nm_usuario_p text, ie_commit_p text, ie_opcao_p text) AS $body$
DECLARE

 
/* 
'I'	- Insere portador; 
'E'	- Retira(exclui) portador 
*/
				 
				 
cd_tipo_portador_ant_w	integer;
cd_portador_ant_w	integer;
ie_cheque_cobranca_w	portador.ie_cheque_cobranca%type;


BEGIN 
 
begin 
cd_tipo_portador_ant_w	:= (obter_portador_cheque_data(nr_seq_cheque_p,clock_timestamp(),'CT'))::numeric;
cd_portador_ant_w	:= (obter_portador_cheque_data(nr_seq_cheque_p,clock_timestamp(),'CP'))::numeric;
exception when others then 
	cd_tipo_portador_ant_w	:= null;
	cd_portador_ant_w	:= null;
end;
 
insert into cheque_cr_alt_portador(nr_sequencia, 
	nm_usuario, 
	dt_atualizacao, 
	nm_usuario_nrec, 
	dt_atualizacao_nrec, 
	nr_seq_cheque, 
	dt_alteracao, 
	cd_portador_ant, 
	cd_tipo_portador_ant, 
	cd_portador, 
	cd_tipo_portador, 
	ds_observacao) 
values (nextval('cheque_cr_alt_portador_seq'), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nr_seq_cheque_p, 
	clock_timestamp(), 
	cd_portador_ant_w, 
	cd_tipo_portador_ant_w, 
	cd_portador_p, 
	cd_tipo_portador_p, 
	wheb_mensagem_pck.get_texto(305651));
	 
if (coalesce(ie_opcao_p,'I')	= 'I') then 
	update	cheque_cr 
	set	dt_atualizacao		= clock_timestamp(), 
		nm_usuario		= nm_usuario_p, 
		cd_tipo_portador 	= cd_tipo_portador_p, 
		cd_portador		= cd_portador_p 
	where	nr_seq_cheque		= nr_seq_cheque_p;
	 
	select	coalesce(max(a.ie_cheque_cobranca),'N') 
	into STRICT	ie_cheque_cobranca_w 
	from	portador a 
	where	a.cd_portador = cd_portador_p;
	 
	if (coalesce(ie_cheque_cobranca_w,'N') = 'S') then 
		CALL atualizar_cobranca_cheque(nr_seq_cheque_p,nm_usuario_p);
	end if;
	 
elsif (coalesce(ie_opcao_p,'I') = 'E') then 
	update	cheque_cr 
	set	dt_atualizacao		= clock_timestamp(), 
		nm_usuario		= nm_usuario_p, 
		cd_tipo_portador	 = NULL, 
		cd_portador		 = NULL 
	where	nr_seq_cheque		= nr_seq_cheque_p;
end if;
 
if (coalesce(ie_commit_p,'S') = 'S') then 
	commit;
end if;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE alterar_portador_cheque_cr (nr_seq_cheque_p bigint, cd_tipo_portador_p bigint, cd_portador_p bigint, nm_usuario_p text, ie_commit_p text, ie_opcao_p text) FROM PUBLIC;

