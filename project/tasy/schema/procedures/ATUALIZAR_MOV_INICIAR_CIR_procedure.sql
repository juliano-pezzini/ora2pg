-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_mov_iniciar_cir ( nr_atendimento_p bigint, nr_cirurgia_p bigint, cd_estabelecimento_p bigint, nr_seq_interno_p bigint) AS $body$
DECLARE


qt_interno_w			bigint;
nr_seq_evento_cirurgia_w		bigint;
ie_momento_integracao_TM_w	varchar(10);
nr_seq_aten_pac_unid_w		bigint;


BEGIN

	select 	max(nr_sequencia)
	into STRICT	nr_seq_evento_cirurgia_w
	from	evento_cirurgia_paciente
	where	(nr_cirurgia =  nr_cirurgia_p or ((nr_seq_pepo IS NOT NULL AND nr_seq_pepo::text <> '') and nr_seq_pepo = (SELECT max(b.nr_seq_pepo) from cirurgia b where b.nr_cirurgia = nr_cirurgia_p)))
	and		(nr_seq_aten_pac_unid IS NOT NULL AND nr_seq_aten_pac_unid::text <> '')
	and 	nr_seq_evento in (select	nr_sequencia
				from  	evento_cirurgia
				where 	coalesce(ie_gera_movimentacao,'N') = 'S'
				and	coalesce(ie_inicia_integracao,'N') = 'S'
				and	coalesce(ie_situacao,'A') = 'A')
	and	coalesce(ie_situacao,'A') = 'A';

	select	CASE WHEN coalesce(count(1),0)=0 THEN 'N'  ELSE 'S' END
	into STRICT	ie_momento_integracao_TM_w
	from	parametros_pepo
	where	ie_momento_integracao = 'TM'
	and	coalesce(cd_estabelecimento, cd_estabelecimento_p) = cd_estabelecimento_p;


	if ((coalesce(nr_seq_evento_cirurgia_w,0) > 0)
		and (coalesce(ie_momento_integracao_TM_w,'N') = 'S')) then

		select	count(*)
		into STRICT	qt_interno_w
		from	atend_paciente_unidade a
		where	a.nr_seq_interno = nr_seq_interno_p
		and		exists (	SELECT	1
							from	atend_paciente_unidade b
							where	a.nr_atendimento     = b.nr_atendimento
							AND		a.cd_unidade_basica = b.cd_unidade_basica
							AND		a.cd_unidade_compl	= b.cd_unidade_compl
							and		a.dt_entrada_unidade <> b.dt_entrada_unidade
							and (coalesce(b.dt_saida_unidade::text, '') = '' or b.dt_saida_unidade = a.dt_entrada_unidade));

		if (coalesce(qt_interno_w,0) > 0) then

			update	atend_paciente_unidade
			set		ds_observacao = substr(obter_desc_expressao(797522),1,2000)
			where	nr_seq_interno = nr_seq_interno_p
			and		coalesce(dt_saida_unidade::text, '') = '';
			commit;
		end if;
	end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_mov_iniciar_cir ( nr_atendimento_p bigint, nr_cirurgia_p bigint, cd_estabelecimento_p bigint, nr_seq_interno_p bigint) FROM PUBLIC;

