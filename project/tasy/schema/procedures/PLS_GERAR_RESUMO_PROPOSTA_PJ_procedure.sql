-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE reg_idades_benef_prop AS (qt_idade_benef bigint, nr_seq_benef_prop bigint, ie_titularidade varchar(2));


CREATE OR REPLACE PROCEDURE pls_gerar_resumo_proposta_pj ( nr_seq_proposta_p bigint, cd_estabelecimento_p bigint, ie_commit_p text, nm_usuario_p text) AS $body$
DECLARE


dt_nascimento_w			timestamp;
qt_idade_w			bigint;
nr_seq_tabela_w			bigint;
qt_idade_inicial_w		bigint;
qt_idade_final_w		bigint;
i				bigint;
qt_beneficiarios_w		bigint;
vl_faixa_beneficiario_w		double precision;
nr_seq_plano_preco_w		bigint;
nr_vetor_w			bigint;
vl_resumo_w			double precision;
ds_resumo_w			varchar(255);
nr_seq_plano_w			bigint;
nr_seq_sca_w			bigint;
nr_seq_bonif_w			bigint;
qt_registros_w			bigint;
nr_seq_regra_w			bigint;
nr_seq_beneficiario_w		bigint;
qt_vidas_w			bigint;
ie_preco_vidas_contrato_w	varchar(10);
ie_tipo_proposta_w		bigint;
nr_contrato_w			bigint;
nr_seq_contrato_w		bigint;
qt_reg_proposta_inscr_w		bigint;
qt_benef_plano_w		bigint;
vl_via_carteira_w		double precision;
tx_via_carteira_w		double precision;
vl_total_plano_w		double precision;
ie_grau_titularidade_w		varchar(2);
ie_titularidade_w		varchar(2);
dt_inicio_proposta_w		timestamp;
dt_contratacao_w		timestamp;
type vetor is table of reg_idades_benef_prop index by integer;
vetor_w				vetor;

C01 CURSOR FOR
	SELECT	nr_seq_plano,
		nr_seq_tabela
	from	pls_proposta_beneficiario
	where	nr_seq_proposta = nr_seq_proposta_p
	and	coalesce(dt_cancelamento::text, '') = ''
	group by nr_seq_plano,nr_seq_tabela;

C02 CURSOR FOR
	SELECT	a.dt_nascimento,
		b.nr_sequencia,
		coalesce(b.dt_contratacao,dt_inicio_proposta_w)
	from	pessoa_fisica			a,
		pls_proposta_beneficiario	b
	where	a.cd_pessoa_fisica	= b.cd_beneficiario
	and	b.nr_seq_proposta = nr_seq_proposta_p
	and	b.nr_seq_plano	= nr_seq_plano_w
	and	b.nr_seq_tabela	= nr_seq_tabela_w
	and	coalesce(b.dt_cancelamento::text, '') = '';

C03 CURSOR FOR
	SELECT	qt_idade_inicial,
		qt_idade_final,
		ie_grau_titularidade,
		nr_sequencia
	from	pls_plano_preco
	where	nr_seq_tabela	= nr_seq_tabela_w
	and	(((ie_preco_vidas_contrato_w = 'S')
		and 	qt_vidas_w between coalesce(qt_vidas_inicial,qt_vidas_w) and coalesce(qt_vidas_final,qt_vidas_w))
		or (ie_preco_vidas_contrato_w = 'N'))
	order by qt_idade_inicial;

C04 CURSOR FOR
	SELECT	a.nr_seq_plano
	from	pls_sca_vinculo			a,
		pls_proposta_beneficiario	b
	where	a.nr_seq_benef_proposta	= b.nr_sequencia
	and	b.nr_seq_proposta	= nr_seq_proposta_p
	and	coalesce(b.dt_cancelamento::text, '') = ''
	group by a.nr_seq_plano,b.nr_seq_proposta;

C05 CURSOR FOR
	SELECT	a.nr_seq_bonificacao
	from	pls_bonificacao_vinculo		a,
		pls_proposta_beneficiario	b
	where	a.nr_seq_segurado_prop	= b.nr_sequencia
	and	b.nr_seq_proposta	= nr_seq_proposta_p
	and	coalesce(b.dt_cancelamento::text, '') = ''
	group by a.nr_seq_bonificacao,b.nr_seq_proposta;

C06 CURSOR FOR
	SELECT	'P' ie_origem,
		b.nr_seq_bonificacao
	from	pls_bonificacao_vinculo	b,
		pls_proposta_adesao	a
	where	b.nr_seq_proposta	= a.nr_sequencia
	and	a.nr_sequencia		= nr_seq_proposta_p
	
union

	SELECT	'C' ie_origem,
		b.nr_seq_bonificacao
	from	pls_bonificacao_vinculo	b
	where	b.nr_seq_contrato	= nr_seq_contrato_w;

C07 CURSOR FOR
	SELECT	c.nr_sequencia
	from	pls_proposta_beneficiario	a,
		pls_proposta_adesao		b,
		pls_plano			c,
		pls_regra_inscricao		d
	where	a.nr_seq_proposta		= b.nr_sequencia
	and	a.nr_seq_plano			= c.nr_sequencia
	and	d.nr_seq_plano			= c.nr_sequencia
	and	b.nr_sequencia			= nr_seq_proposta_p
	and	coalesce(a.ie_taxa_inscricao,'S')	= 'S'
	and	b.dt_inicio_proposta between coalesce(d.dt_inicio_vigencia,b.dt_inicio_proposta) and coalesce(d.dt_fim_vigencia,b.dt_inicio_proposta)
	and	d.qt_parcela_inicial		= 1
	and	((b.ie_tipo_proposta in (1,6,7) and d.ie_acao_contrato = 'A')  or
		((b.ie_tipo_proposta in (2,8)) and (d.ie_acao_contrato = 'L')) or 
		((b.ie_tipo_proposta in (3,4,7,8)) and (d.ie_acao_contrato = 'M')) or (coalesce(d.ie_acao_contrato::text, '') = ''))
	and	not exists (SELECT	1
				from	pls_regra_inscricao x
				where	x.nr_seq_proposta	= b.nr_sequencia)
	and	not exists (	select	1
					from	pls_regra_inscricao x
					where	x.nr_seq_contrato	= nr_seq_contrato_w)
	group by b.nr_sequencia,c.nr_sequencia
	
union all

	select	a.nr_seq_plano
	from	pls_proposta_beneficiario	a,
		pls_proposta_adesao		b,
		pls_contrato			c,
		pls_regra_inscricao		d
	where	a.nr_seq_proposta		= b.nr_sequencia
	and	b.nr_seq_contrato		= c.nr_contrato
	and	d.nr_seq_contrato		= c.nr_sequencia
	and	b.nr_sequencia			= nr_seq_proposta_p
	and	coalesce(a.ie_taxa_inscricao,'S')	= 'S'
	and	b.dt_inicio_proposta between coalesce(d.dt_inicio_vigencia,b.dt_inicio_proposta) and coalesce(d.dt_fim_vigencia,b.dt_inicio_proposta)
	and	d.qt_parcela_inicial		= 1
	and	((b.ie_tipo_proposta in (1,6,7) and d.ie_acao_contrato = 'A')  or 
		((b.ie_tipo_proposta in (2,8)) and (d.ie_acao_contrato = 'L')) or 
		((b.ie_tipo_proposta in (3,4,7,8)) and (d.ie_acao_contrato = 'M')) or (coalesce(d.ie_acao_contrato::text, '') = ''))
	and	not exists (	select	1
					from	pls_regra_inscricao x
					where	x.nr_seq_proposta	= b.nr_sequencia)
	group by a.nr_seq_plano
	
union all

	select	a.nr_seq_plano
	from	pls_proposta_beneficiario	a,
		pls_proposta_adesao		b,
		pls_regra_inscricao		d
	where	a.nr_seq_proposta		= b.nr_sequencia
	and	d.nr_seq_proposta		= b.nr_sequencia
	and	b.nr_sequencia			= nr_seq_proposta_p
	and	coalesce(a.ie_taxa_inscricao,'S')	= 'S'
	and	b.dt_inicio_proposta between coalesce(d.dt_inicio_vigencia,b.dt_inicio_proposta) and coalesce(d.dt_fim_vigencia,b.dt_inicio_proposta)
	and	d.qt_parcela_inicial		= 1
	and	((b.ie_tipo_proposta in (1,6,7) and d.ie_acao_contrato = 'A')  or 
		((b.ie_tipo_proposta in (2,8)) and (d.ie_acao_contrato = 'L')) or 
		((b.ie_tipo_proposta in (3,4,7,8)) and (d.ie_acao_contrato = 'M')) or (coalesce(d.ie_acao_contrato::text, '') = ''))
	group by a.nr_seq_plano;

C08 CURSOR FOR
	SELECT  d.nr_seq_plano
	from	pls_sca_regra_contrato			d,
		pls_contrato				c,
		pls_proposta_beneficiario		b,
		pls_proposta_adesao			a
	where	d.nr_seq_contrato			= c.nr_sequencia
	and	c.nr_contrato				= a.nr_seq_contrato
	and	b.nr_seq_proposta			= a.nr_sequencia
	and	a.nr_sequencia				= nr_seq_proposta_p
	and	substr(pls_obter_se_sca_incl_contr(b.nr_sequencia,d.nr_seq_plano),1,1) = 'S'
	and	a.dt_inicio_proposta between coalesce(dt_inicio_vigencia,a.dt_inicio_proposta) and fim_dia(coalesce(dt_fim_vigencia,a.dt_inicio_proposta))
	and	((d.ie_geracao_valores = 'T' and coalesce(b.nr_seq_titular::text, '') = '' and coalesce(b.nr_seq_titular_contrato::text, '') = '') or
		((d.ie_geracao_valores = 'D' and ((b.nr_seq_titular IS NOT NULL AND b.nr_seq_titular::text <> '') or (b.nr_seq_titular_contrato IS NOT NULL AND b.nr_seq_titular_contrato::text <> '')))) or (d.ie_geracao_valores = 'B'))
	and	not exists (	SELECT	1
					from	pls_sca_vinculo		x
					where	x.nr_seq_benef_proposta	= b.nr_sequencia
					and	d.nr_seq_plano		= x.nr_seq_plano)
	group by a.nr_sequencia,d.nr_seq_plano;

BEGIN

delete	FROM pls_proposta_resumo
where	nr_seq_proposta	= nr_seq_proposta_p;

qt_vidas_w		:= pls_obter_qt_vidas_proposta(nr_seq_proposta_P,null);

select	ie_tipo_proposta,
	nr_seq_contrato,
	dt_inicio_proposta
into STRICT	ie_tipo_proposta_w,
	nr_contrato_w,
	dt_inicio_proposta_w
from	pls_proposta_adesao
where	nr_sequencia	= nr_seq_proposta_p;

if (nr_contrato_w IS NOT NULL AND nr_contrato_w::text <> '') then
	select	max(nr_sequencia)
	into STRICT	nr_seq_contrato_w
	from	pls_contrato
	where	nr_contrato = nr_contrato_w;
end if;

if (ie_tipo_proposta_w <> 5) then
	open C01;
	loop
	fetch C01 into
		nr_seq_plano_w,
		nr_seq_tabela_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		qt_benef_plano_w	:= 0;
		vl_total_plano_w	:= 0;
		ds_resumo_w	:= 'Produto - '||substr(pls_obter_dados_produto(nr_seq_plano_w,'N'),1,255);
		vl_resumo_w	:= coalesce(pls_obter_valor_proposta_pj(nr_seq_proposta_p,nr_seq_plano_w,'P'),0);
		
		--Total produto
		insert into pls_proposta_resumo(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
				nr_seq_proposta, nr_seq_plano,ds_resumo, vl_resumo,
				nr_seq_ordem)
		values (	nextval('pls_proposta_resumo_seq'),clock_timestamp(), nm_usuario_p,clock_timestamp(), nm_usuario_p,
				nr_seq_proposta_p,nr_seq_plano_w,ds_resumo_w,vl_resumo_w,
				'1');
		
		if (nr_seq_tabela_w IS NOT NULL AND nr_seq_tabela_w::text <> '') then
			select	coalesce(ie_preco_vidas_contrato,'N')
			into STRICT	ie_preco_vidas_contrato_w
			from	pls_tabela_preco
			where	nr_sequencia	= nr_seq_tabela_w;
		end if;
		
		open c02;
		loop
		fetch c02 into
			dt_nascimento_w,
			nr_seq_beneficiario_w,
			dt_contratacao_w;
		EXIT WHEN NOT FOUND; /* apply on c02 */
			begin
			qt_idade_w	:= trunc(months_between(dt_contratacao_w, dt_nascimento_w) / 12);
			ie_titularidade_w	:= pls_obter_garu_dependencia_seg(nr_seq_beneficiario_w,'P');
			
			nr_vetor_w	:= vetor_w.count+1;
			vetor_w[nr_vetor_w].qt_idade_benef	:= qt_idade_w;
			vetor_w[nr_vetor_w].nr_seq_benef_prop	:= nr_seq_beneficiario_w;
			vetor_w[nr_vetor_w].ie_titularidade	:= coalesce(ie_titularidade_w,'X');
			end;
		end loop;
		close c02;
		
		open c03;
		loop
		fetch c03 into
			qt_idade_inicial_w,
			qt_idade_final_w,
			ie_grau_titularidade_w,
			nr_seq_plano_preco_w;
		EXIT WHEN NOT FOUND; /* apply on c03 */
			begin
			i			:= 0;
			qt_beneficiarios_w	:= 0;
			vl_resumo_w		:= 0;
			
			for i in 1..vetor_w.count loop
				if (vetor_w[i].qt_idade_benef >= qt_idade_inicial_w) and (vetor_w[i].qt_idade_benef <= qt_idade_final_w) and (coalesce(ie_grau_titularidade_w,vetor_w[i].ie_titularidade)	= vetor_w[i].ie_titularidade) then
					
					qt_beneficiarios_w	:= qt_beneficiarios_w + 1;
					vl_faixa_beneficiario_w	:= (pls_obter_faixa_etaria_prop(vetor_w[i].nr_seq_benef_prop,nr_seq_plano_preco_w))::numeric;
					vl_resumo_w		:= vl_resumo_w + coalesce(vl_faixa_beneficiario_w,0);
				end if;
			end loop;
			
			if (qt_beneficiarios_w > 0) then
				--Faixa etaria #@QT_IDADE_INICIAL#@ a #@QT_IDADE_FINAL#@ - Quantidade = #@QT_BENEF#@
				ds_resumo_w	:= '     ' || wheb_mensagem_pck.get_texto(1126915,'QT_IDADE_INICIAL='||qt_idade_inicial_w||';QT_IDADE_FINAL='||qt_idade_final_w||';QT_BENEF='||qt_beneficiarios_w);
				
				--Faixas etarias do produto
				insert into pls_proposta_resumo(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
						nr_seq_proposta, nr_seq_plano,ds_resumo, vl_resumo,
						nr_seq_ordem)
				values (	nextval('pls_proposta_resumo_seq'),clock_timestamp(), nm_usuario_p,clock_timestamp(), nm_usuario_p,
						nr_seq_proposta_p,nr_seq_plano_w,ds_resumo_w,vl_resumo_w,
						'2');
						
				qt_benef_plano_w	:= coalesce(qt_benef_plano_w,0) + qt_beneficiarios_w;
				vl_total_plano_w	:= coalesce(vl_total_plano_w,0) + coalesce(vl_resumo_w,0);
			end if;
			end;
		end loop;
		close c03;
		
		begin
		SELECT * FROM pls_obter_regra_via_adic(nr_seq_contrato_w, null, nr_seq_plano_w, 1, 'N', wheb_usuario_pck.get_nm_usuario, cd_estabelecimento_p, clock_timestamp(), nr_seq_regra_w, vl_via_carteira_w, tx_via_carteira_w) INTO STRICT nr_seq_regra_w, vl_via_carteira_w, tx_via_carteira_w;
		exception
		when others then
			vl_via_carteira_w	:= 0;
			tx_via_carteira_w	:= 0;
		end;
		
		if (coalesce(tx_via_carteira_w,0) <> 0) then
			vl_via_carteira_w := dividir((vl_total_plano_w * tx_via_carteira_w), 100);
		elsif (coalesce(vl_via_carteira_w,0) <> 0) then
			vl_via_carteira_w := vl_via_carteira_w * qt_benef_plano_w;
		end if;
		
		if (coalesce(vl_via_carteira_w,0) > 0) then
			ds_resumo_w	:= '     ' || wheb_mensagem_pck.get_texto(1126901); --Via do cartao de identificacao
			insert	into	pls_proposta_resumo(	nr_sequencia, dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec,
					nr_seq_proposta, nr_seq_plano, ds_resumo, vl_resumo,
					nr_seq_ordem)
			values (	nextval('pls_proposta_resumo_seq'), clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p,
					nr_seq_proposta_p, nr_seq_plano_w, ds_resumo_w, vl_via_carteira_w,
					'8');
		end if;
		
		vetor_w.delete;
		end;
	end loop;
	close C01;
end if;


open c04;
loop
fetch c04 into	
	nr_seq_sca_w;
EXIT WHEN NOT FOUND; /* apply on c04 */
	begin
	select	count(1)
	into STRICT	qt_registros_w
	from	pls_proposta_beneficiario	b,
		pls_sca_vinculo			a
	where	a.nr_seq_benef_proposta	= b.nr_sequencia
	and	b.nr_seq_proposta	= nr_seq_proposta_p
	and	a.nr_seq_plano		= nr_seq_sca_w
	and	coalesce(b.dt_cancelamento::text, '') = '';
	
	ds_resumo_w	:= 'SCA - '||substr(pls_obter_dados_produto(nr_seq_sca_w,'N'),1,255)|| ' - Qt. = '|| qt_registros_w;
	vl_resumo_w	:= pls_obter_valor_sca_proposta(nr_seq_proposta_p,null,nr_seq_sca_w);
	
	--SCA do beneficiario
	insert into pls_proposta_resumo(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
			nr_seq_proposta, nr_seq_sca,ds_resumo, vl_resumo,
			nr_seq_ordem,nr_seq_plano)
	values (	nextval('pls_proposta_resumo_seq'),clock_timestamp(), nm_usuario_p,clock_timestamp(), nm_usuario_p,
			nr_seq_proposta_p,nr_seq_sca_w,ds_resumo_w,vl_resumo_w,
			'3',0);
	end;
end loop;
close c04;

if (ie_tipo_proposta_w <> 5) then
	open c05;
	loop
	fetch c05 into
		nr_seq_bonif_w;
	EXIT WHEN NOT FOUND; /* apply on c05 */
		begin
		select	count(1)
		into STRICT	qt_registros_w
		from	pls_proposta_beneficiario	b,
			pls_bonificacao_vinculo			a
		where	a.nr_seq_segurado_prop	= b.nr_sequencia
		and	b.nr_seq_proposta	= nr_seq_proposta_p
		and	a.nr_seq_bonificacao	= nr_seq_bonif_w
		and	coalesce(b.dt_cancelamento::text, '') = '';
		
		ds_resumo_w	:= wheb_mensagem_pck.get_texto(1126906) || ' - ' || substr(pls_obter_desc_bonificacao(nr_seq_bonif_w),1,255)|| ' - Qt. = '|| qt_registros_w;
		vl_resumo_w	:= pls_obter_valor_bonif_proposta(nr_seq_proposta_p,nr_seq_bonif_w);
		
		--Bonificacoes do beneficiario
		insert into pls_proposta_resumo(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
				nr_seq_proposta, nr_seq_bonificacao,ds_resumo, vl_resumo,
				nr_seq_ordem,nr_seq_plano)
		values (	nextval('pls_proposta_resumo_seq'),clock_timestamp(), nm_usuario_p,clock_timestamp(), nm_usuario_p,
				nr_seq_proposta_p,nr_seq_bonif_w,ds_resumo_w,vl_resumo_w,
				'4',0);
		end;
	end loop;
	close c05;
end if;

if (ie_tipo_proposta_w <> 5) then
	for c06_w in C06 loop
		begin
		if (c06_w.ie_origem = 'P') then
			ds_resumo_w	:= wheb_mensagem_pck.get_texto(1126907) || ' - '||substr(pls_obter_desc_bonificacao(c06_w.nr_seq_bonificacao),1,255); --Bonificacao da proposta
		elsif (c06_w.ie_origem = 'C') then
			ds_resumo_w	:= wheb_mensagem_pck.get_texto(1126908) || ' - '||substr(pls_obter_desc_bonificacao(c06_w.nr_seq_bonificacao),1,255); --Bonificacao do contrato
		end if;
		
		vl_resumo_w	:= pls_valor_bonif_tot_prop_pj(nr_seq_proposta_p,c06_w.nr_seq_bonificacao);
		
		insert into pls_proposta_resumo(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
				nr_seq_proposta, nr_seq_bonificacao,ds_resumo, vl_resumo,
				nr_seq_ordem,nr_seq_plano)
		values (	nextval('pls_proposta_resumo_seq'),clock_timestamp(), nm_usuario_p,clock_timestamp(), nm_usuario_p,
				nr_seq_proposta_p,c06_w.nr_seq_bonificacao,ds_resumo_w,vl_resumo_w,
				'5',0);
		end;
	end loop;
end if;

qt_registros_w	:= 0;

if (nr_seq_contrato_w IS NOT NULL AND nr_seq_contrato_w::text <> '') then
	select	count(1)
	into STRICT	qt_registros_w
	from	pls_regra_inscricao
	where	nr_seq_contrato	= nr_seq_contrato_w;
end if;

select	count(1)
into STRICT	qt_reg_proposta_inscr_w
from	pls_regra_inscricao
where	nr_seq_proposta	= nr_seq_proposta_p;

if (ie_tipo_proposta_w <> 5) then
	open c07;
	loop
	fetch c07 into
		nr_seq_plano_w;
	EXIT WHEN NOT FOUND; /* apply on c07 */
		begin
		
		if (qt_reg_proposta_inscr_w > 0) then
			ds_resumo_w	:= wheb_mensagem_pck.get_texto(1126905); --Taxa de inscricao (Proposta)
		else
			if (qt_registros_w = 0) then
				ds_resumo_w	:= wheb_mensagem_pck.get_texto(1126904) || ' - '||substr(pls_obter_dados_produto(nr_seq_plano_w,'N'),1,255); --Taxa de inscricao (Produto)
			else
				ds_resumo_w	:= wheb_mensagem_pck.get_texto(1126902); --Taxa de inscricao (Contrato)
			end if;
		end if;
		vl_resumo_w	:= pls_valor_inscricao_prop_pj(nr_seq_proposta_p,nr_seq_plano_w);
		
		--Taxa de inscricao do plano
		insert into pls_proposta_resumo(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
				nr_seq_proposta, ds_resumo, vl_resumo,
				nr_seq_ordem,nr_seq_plano)
		values (	nextval('pls_proposta_resumo_seq'),clock_timestamp(), nm_usuario_p,clock_timestamp(), nm_usuario_p,
				nr_seq_proposta_p,ds_resumo_w,vl_resumo_w,
				'6',0);
		end;
	end loop;
	close c07;
end if;

if (ie_tipo_proposta_w <> 5) then
	open c08;
	loop
	fetch c08 into
		nr_seq_plano_w;
	EXIT WHEN NOT FOUND; /* apply on c08 */
		begin
		select  count(1)
		into STRICT	qt_registros_w
		from	pls_sca_regra_contrato			d,
			pls_contrato				c,
			pls_proposta_beneficiario		b,
			pls_proposta_adesao			a
		where	d.nr_seq_contrato			= c.nr_sequencia
		and	c.nr_contrato				= a.nr_seq_contrato
		and	b.nr_seq_proposta			= a.nr_sequencia
		and	a.nr_sequencia				= nr_seq_proposta_p
		and	d.nr_seq_plano				= nr_seq_plano_w
		and	((b.nr_seq_plano			= d.nr_seq_plano_benef) or (coalesce(d.nr_seq_plano_benef::text, '') = ''))
		and	substr(pls_obter_se_sca_incl_contr(b.nr_sequencia,d.nr_seq_plano),1,1) = 'S'
		and	a.dt_inicio_proposta between coalesce(dt_inicio_vigencia,a.dt_inicio_proposta) and fim_dia(coalesce(dt_fim_vigencia,a.dt_inicio_proposta))
		and	((d.ie_geracao_valores = 'T' and coalesce(b.nr_seq_titular::text, '') = '' and coalesce(b.nr_seq_titular_contrato::text, '') = '') or
			((d.ie_geracao_valores = 'D' and ((b.nr_seq_titular IS NOT NULL AND b.nr_seq_titular::text <> '') or (b.nr_seq_titular_contrato IS NOT NULL AND b.nr_seq_titular_contrato::text <> '')))) or (d.ie_geracao_valores = 'B'))
		and	not exists (	SELECT	1
						from	pls_sca_vinculo		x
						where	x.nr_seq_benef_proposta	= b.nr_sequencia
						and	d.nr_seq_plano		= x.nr_seq_plano);
		
		if (qt_registros_w	> 0) then
			ds_resumo_w	:= 'SCA do Contrato - ' || substr(pls_obter_dados_produto(nr_seq_plano_w,'N'),1,255)|| ' - Qt. =  ' || qt_registros_w;
			vl_resumo_w	:= pls_valor_sca_contr_prop_pj(nr_seq_proposta_p,nr_seq_plano_w);
			
			--SCA do Contrato
			insert into pls_proposta_resumo(	nr_sequencia,dt_atualizacao,nm_usuario,dt_atualizacao_nrec,nm_usuario_nrec,
					nr_seq_proposta, ds_resumo, vl_resumo,
					nr_seq_ordem,nr_seq_plano)
			values (	nextval('pls_proposta_resumo_seq'),clock_timestamp(), nm_usuario_p,clock_timestamp(), nm_usuario_p,
					nr_seq_proposta_p,ds_resumo_w,vl_resumo_w,
					'7',0);
		end if;
		end;
	end loop;
	close c08;
end if;

if (ie_commit_p = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gerar_resumo_proposta_pj ( nr_seq_proposta_p bigint, cd_estabelecimento_p bigint, ie_commit_p text, nm_usuario_p text) FROM PUBLIC;

