-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_fluxo_caixa_externo ( dt_inicial_p timestamp, dt_final_p timestamp, cd_estabelecimento_p bigint, cd_empresa_p bigint, ie_periodo_p text, ie_classif_fluxo_p text, ie_restringe_estab_p text, nm_usuario_p text, ie_somente_ativa_p text) AS $body$
DECLARE


/*--------------------------------------------------------------- ATENÇÃO ----------------------------------------------------------------*/

/* Cuidado ao realizar alterações no fluxo de caixa. Toda e qualquer alteração realizada em qualquer uma das       */

/* procedures do fluxo de caixa deve ser cuidadosamente verificada e realizada no fluxo de caixa em lote.           */

/* Devemos garantir que os dois fluxos de caixa tragam os mesmos valores no resultado, evitando assim que           */

/* existam diferenças entre os fluxos de caixa.                                                                                                                */

/*--------------- AO ALTERAR O FLUXO DE CAIXA ALTERAR TAMBÉM O FLUXO DE CAIXA EM LOTE ---------------*/

cd_conta_financ_w	bigint;
dt_referencia_w		timestamp;
vl_fluxo_w		double precision;
ie_tratar_fim_semana_w	varchar(1);
ie_fluxo_externo_w	varchar(1);
cd_conta_financ_cre_w	bigint;
ie_conta_financ_ativa_w	varchar(1);
cd_moeda_empresa_w	integer;

C01 CURSOR FOR
SELECT	a.cd_conta_financ,
	trunc(a.dt_documento,'dd'),
	a.vl_documento
from	fluxo_caixa_ext a
where	a.dt_documento		between	trunc(dt_inicial_p,'dd') and fim_dia(dt_final_p)
and	ie_fluxo_externo_w	= 'S'
and (ie_restringe_estab_p = 'N' or (ie_restringe_estab_p = 'E' and a.cd_estabelecimento = cd_estabelecimento_p) or (ie_restringe_estab_p = 'S' and (a.cd_estabelecimento = cd_estabelecimento_p or obter_estab_financeiro(a.cd_estabelecimento) = cd_estabelecimento_p)))
and	a.cd_empresa		= cd_empresa_p;



BEGIN

select	a.ie_fluxo_externo,
	a.ie_tratar_fim_semana,
	a.cd_conta_financ_cre
into STRICT	ie_fluxo_externo_w,
	ie_tratar_fim_semana_w,
	cd_conta_financ_cre_w
from	parametro_fluxo_caixa a
where	a.cd_estabelecimento = cd_estabelecimento_p;

/* Projeto Multimoeda - Busca a moeda padrão da empresa para gravar no fluxo. */

select	obter_moeda_padrao_empresa(cd_estabelecimento_p,'E')
into STRICT	cd_moeda_empresa_w
;

open C01;
loop
fetch C01 into
	cd_conta_financ_w,
	dt_referencia_w,
	vl_fluxo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	if (ie_tratar_fim_semana_w = 'S') then
		dt_referencia_w	:= obter_proximo_dia_util(cd_estabelecimento_p,dt_referencia_w);
	end if;

	select	CASE WHEN ie_somente_ativa_p='S' THEN ie_situacao  ELSE 'A' END
	into STRICT	ie_conta_financ_ativa_w
	from	conta_financeira
	where	cd_conta_financ = cd_conta_financ_w;

	if (ie_conta_financ_ativa_w = 'A') then
		begin
		insert into fluxo_caixa(
			cd_estabelecimento,
			dt_referencia,
			cd_conta_financ,
			ie_classif_fluxo,
			dt_atualizacao,
			nm_usuario,
			vl_fluxo,
			ie_origem,
			ie_periodo,
			ie_integracao,
			cd_empresa,
			cd_moeda)
		values (cd_estabelecimento_p,
			dt_referencia_w,
			coalesce(cd_conta_financ_w,cd_conta_financ_cre_w),
			ie_classif_fluxo_p,
			clock_timestamp(),
			nm_usuario_p,
			vl_fluxo_w,
			'I',
			ie_periodo_p,
			'CR',
			cd_empresa_p,
			cd_moeda_empresa_w);
		exception
			when others then
				update fluxo_caixa
				set	vl_fluxo		= vl_fluxo + vl_fluxo_w
				where	cd_estabelecimento	= cd_estabelecimento_p
				and	cd_conta_financ		= cd_conta_financ_w
				and	dt_referencia		= dt_referencia_w
				and	ie_periodo		= ie_periodo_p
				and	ie_classif_fluxo	= ie_classif_fluxo_p
				and	ie_integracao		= 'CR'
				and	cd_empresa		= cd_empresa_p;
		end;
	end if;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_fluxo_caixa_externo ( dt_inicial_p timestamp, dt_final_p timestamp, cd_estabelecimento_p bigint, cd_empresa_p bigint, ie_periodo_p text, ie_classif_fluxo_p text, ie_restringe_estab_p text, nm_usuario_p text, ie_somente_ativa_p text) FROM PUBLIC;

