-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_fracionamento_processo ( nr_seq_processo_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_pmh_w					bigint;
nr_prescricao_w					bigint;
nr_seq_material_w				integer;
nr_seq_fracionamento_w			bigint;
ds_erro_w						varchar(1800);
nr_seq_regra_area_prep_ww		bigint;
nr_seq_superior_ww				bigint;
ie_agrupador_ww					smallint;
nr_seq_etiqueta_ww				bigint;
ie_grava_log_gedipa_w			varchar(1);
ie_agrupador_w					prescr_mat_hor.ie_agrupador%type;
cd_material_w					prescr_mat_hor.cd_material%type;
ie_checar_gedipa_w				proc_int_mat_prescr.ie_checar_gedipa%type;
nr_sequencia_proc_w				prescr_material.nr_sequencia_proc%type;
ie_existe_regra_w				varchar(1) := 'N';
ie_gerar_frac_w					varchar(1) := 'N';
nr_seq_frac_npt_w				adep_processo_frac.nr_sequencia%type;

c01 CURSOR FOR
SELECT	nr_sequencia,
		nr_prescricao,
		nr_seq_material,
		ie_agrupador,
		cd_material
from (
SELECT	a.nr_sequencia,
		a.nr_prescricao,
		a.nr_seq_material,
		a.ie_agrupador,
		a.cd_material
from	adep_regra_area_prep b,
		prescr_mat_hor a
where	a.nr_seq_processo		= nr_seq_processo_p
and	a.nr_seq_regra_area_prep	= b.nr_sequencia
and	coalesce(a.nr_seq_superior::text, '') = ''
and	a.ie_agrupador		not(4,17)
and	coalesce(b.ie_gerar_manip_frac,'N')	= 'S'
and	coalesce(b.ie_situacao,'A')		= 'A'
and	coalesce(b.ie_exclusao,'N')		= 'N'
and	coalesce(a.nr_seq_etiqueta::text, '') = ''
and	Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
and		ie_gerar_frac_w <> 'X'

union

select	a.nr_sequencia,
		a.nr_prescricao,
		a.nr_seq_material,
		a.ie_agrupador,
		a.cd_material
from	regra_local_dispensacao b,
		prescr_mat_hor a
where	a.nr_seq_processo		= nr_seq_processo_p
and		a.nr_regra_local_disp	= b.nr_sequencia
and		coalesce(a.nr_seq_superior::text, '') = ''
and		a.ie_agrupador		not in (4,17)
and		coalesce(b.ie_gerar_manip_frac,'N')	= 'S'
and		coalesce(a.nr_seq_etiqueta::text, '') = ''
and		Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
and		ie_gerar_frac_w <> 'X'

union

select	a.nr_sequencia,
		a.nr_prescricao,
		a.nr_seq_material,
		a.ie_agrupador,
		a.cd_material
from	prescr_mat_hor a
where	a.nr_seq_processo		= nr_seq_processo_p
and	coalesce(a.nr_seq_superior::text, '') = ''
and	a.ie_agrupador		not in (4)
and	coalesce(a.nr_seq_etiqueta::text, '') = ''
and	coalesce(a.nr_seq_area_prep::text, '') = ''
and	Obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
and	ie_gerar_frac_w = 'N') alias17
order by
	nr_sequencia;

c_dietas_orais CURSOR FOR
SELECT	a.nr_sequencia nr_seq_horario,
		a.nr_prescricao,
		a.nr_seq_dieta
from	prescr_dieta_hor a
where	a.nr_seq_processo = nr_seq_processo_p
and		coalesce(a.nr_seq_etiqueta::text, '') = ''
and		coalesce(a.dt_fim_horario::text, '') = ''
and		coalesce(a.dt_suspensao::text, '') = ''
and		coalesce(a.ie_situacao,'A') = 'A'
and		obter_se_horario_liberado(a.dt_lib_horario, a.dt_horario) = 'S'
order by a.nr_sequencia;

BEGIN
begin

CALL Wheb_assist_pck.set_informacoes_usuario(coalesce(wheb_usuario_pck.get_cd_estabelecimento,1), wheb_usuario_pck.get_cd_perfil, nm_usuario_p);
ie_gerar_frac_w	:= coalesce(Wheb_assist_pck.obterParametroFuncao(-1113,61), 'N');

select	coalesce(max(ie_grava_log_gedipa),'S')
into STRICT	ie_grava_log_gedipa_w
from	parametros_farmacia
where	cd_estabelecimento = coalesce(wheb_usuario_pck.get_cd_estabelecimento,1);

if (ie_grava_log_gedipa_w = 'S') then
	insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
	values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 405, 'GERAR_FRACIONAMENTO_PROCESSO', null, 'nr_seq_processo_p='||to_char(nr_seq_processo_p)||'; nm_usuario_p='||nm_usuario_p, 'Inicio da execucao da procedure GERAR_FRACIONAMENTO_PROCESSO'
);
end if;

if (coalesce(nr_seq_processo_p,0) > 0) then
	begin

	if (ie_grava_log_gedipa_w = 'S') then
		insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
		values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 410, 'GERAR_FRACIONAMENTO_PROCESSO', null, null, 'Open do cursor c01');
	end if;

	begin
	select	nr_seq_regra_area_prep,
		nr_seq_superior,
		ie_agrupador,
		nr_seq_etiqueta
	into STRICT	nr_seq_regra_area_prep_ww,
		nr_seq_superior_ww,
		ie_agrupador_ww,
		nr_seq_etiqueta_ww
	from	prescr_mat_hor
	where	nr_seq_processo		= nr_seq_processo_p
	and	Obter_se_horario_liberado(dt_lib_horario, dt_horario) = 'S';
	exception
	when others then
		nr_seq_regra_area_prep_ww	:= null;
		nr_seq_superior_ww		:= null;
		ie_agrupador_ww			:= null;
		nr_seq_etiqueta_ww		:= null;
	end;

	if (ie_grava_log_gedipa_w = 'S') then
		insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
		values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 410, 'GERAR_FRACIONAMENTO_PROCESSO', null, 'nr_seq_regra_area_prep='||nr_seq_regra_area_prep_ww||
													  ';nr_seq_superior='||nr_seq_superior_ww||
													  ';ie_agrupador='||ie_agrupador_ww||
													  ';nr_seq_etiqueta='||nr_seq_etiqueta_ww||
													  ';ie_gerar_frac_w='||ie_gerar_frac_w||
													  ';wheb_usuario_pck.get_cd_estabelecimento='||wheb_usuario_pck.get_cd_estabelecimento||
													  ';wheb_usuario_pck.get_cd_perfil='||wheb_usuario_pck.get_cd_perfil, 'Valores da tabela prescr_mat_hor');
	end if;

	open c01;
	loop
	fetch c01 into	nr_seq_pmh_w,
			nr_prescricao_w,
			nr_seq_material_w,
			ie_agrupador_w,
			cd_material_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin

		if (ie_grava_log_gedipa_w = 'S') then
			insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
			values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 415, 'GERAR_FRACIONAMENTO_PROCESSO', null, null, obter_desc_expressao(781334) || '01'/*'Execucao do comando SQL 01'*/);
		end if;
		
		if	((coalesce(nr_seq_frac_npt_w::text, '') = '') or (ie_agrupador_w <> 11)) then
		
		    select	nextval('adep_processo_frac_seq')
			into STRICT	nr_seq_fracionamento_w
			;	

		    if (ie_grava_log_gedipa_w = 'S') then
				insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
				values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 420, 'GERAR_FRACIONAMENTO_PROCESSO', null, null, 'Insert na tabela ADEP_PROCESSO_FRAC; SEQ='||to_char(nr_seq_fracionamento_w));
			end if;

		    insert into adep_processo_frac(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_seq_processo,
				dt_geracao,
				dt_preparo,
				nr_seq_digito)
			values (
				nr_seq_fracionamento_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_seq_processo_p,
				clock_timestamp(),
				null,
				calcula_digito('MODULO11',nr_seq_fracionamento_w));
				
			if (ie_agrupador_w = 11) then
				nr_seq_frac_npt_w	:= nr_seq_fracionamento_w;
			end if;	

     		if (ie_grava_log_gedipa_w = 'S') then
				insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
				values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 425, 'GERAR_FRACIONAMENTO_PROCESSO', null, 'nr_seq_fracionamento_w='||to_char(nr_seq_fracionamento_w)||'; nr_seq_pmh_w='||to_char(nr_seq_pmh_w), 'Update 01 na tabela PRESCR_MAT_HOR');
			end if;
		
			update	prescr_mat_hor
			set		nr_seq_etiqueta	= nr_seq_fracionamento_w
			where	nr_sequencia	= nr_seq_pmh_w
			and		coalesce(nr_seq_etiqueta::text, '') = '';
	
	    	if (ie_grava_log_gedipa_w = 'S') then
				insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
				values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 430, 'GERAR_FRACIONAMENTO_PROCESSO', null, 'nr_seq_fracionamento_w='||to_char(nr_seq_fracionamento_w)||'; nr_seq_material_w='||to_char(nr_seq_material_w), 'Update 02 na tabela PRESCR_MAT_HOR');
			end if;

			update	prescr_mat_hor
			set		nr_seq_etiqueta	= nr_seq_fracionamento_w
			where	nr_seq_processo	= nr_seq_processo_p
			and		nr_prescricao	= nr_prescricao_w
			and		nr_seq_superior	= nr_seq_material_w
			and 	coalesce(nr_seq_etiqueta::text, '') = '';
	
			update	prescr_mat_hor	
			set		nr_seq_etiqueta	= nr_seq_fracionamento_w
			where	ie_agrupador = 17
			and		nr_seq_processo = nr_seq_processo_p
			and		ie_agrupador_w = 16;
			
			select	coalesce(max('S'),'N')
			into STRICT	ie_existe_regra_w
			from   	prescr_material a,
					prescr_procedimento b,
					proc_int_mat_prescr c
			where  	a.nr_prescricao 	= b.nr_prescricao
			and	a.nr_sequencia_proc 	= b.nr_sequencia
			and	b.nr_seq_proc_interno 	= c.nr_seq_proc_interno
			and	a.cd_material 		= c.cd_material
			and	a.nr_sequencia		= nr_seq_material_w
			and	c.cd_material 		= cd_material_w
			and	a.nr_prescricao 	= nr_prescricao_w;
	
			--Verifica se os itens associados a procedimentos sao checados separamente
			if (ie_existe_regra_w = 'S') and (ie_agrupador_w = 5) then
	
				select 	coalesce(c.ie_checar_gedipa,'N'),
						a.nr_sequencia_proc
				into STRICT	ie_checar_gedipa_w,
						nr_sequencia_proc_w
				from   	prescr_material a,
						prescr_procedimento b,
						proc_int_mat_prescr c
				where  	a.nr_prescricao 	= b.nr_prescricao
				and	a.nr_sequencia_proc 	= b.nr_sequencia
				and	b.nr_seq_proc_interno 	= c.nr_seq_proc_interno
				and	a.cd_material 		= c.cd_material
				and	a.nr_sequencia		= nr_seq_material_w
				and	c.cd_material 		= cd_material_w
				and	a.nr_prescricao 	= nr_prescricao_w;
	
				--Atualiza todos os itens associados que sao checados separadamente com o mesmo numero de etiqueta
				if (ie_checar_gedipa_w <> 'N') then
	
					update	prescr_mat_hor
					set		nr_seq_etiqueta	= nr_seq_fracionamento_w
					where 	nr_seq_processo = nr_seq_processo_p
					and		nr_prescricao 	= nr_prescricao_w
					and		ie_agrupador  	= 5
					and		coalesce(nr_seq_etiqueta::text, '') = ''
					and		cd_material in (SELECT 	c.cd_material
											from	prescr_material a,
													prescr_procedimento b,
													proc_int_mat_prescr c
											where  	a.nr_prescricao = b.nr_prescricao
											and		a.nr_sequencia_proc = b.nr_sequencia
											and	   	b.nr_seq_proc_interno = c.nr_seq_proc_interno
											and	   	a.cd_material = c.cd_material
											and	   	a.nr_prescricao = nr_prescricao_w
											and	   	c.ie_checar_gedipa = 'S')
					and		nr_seq_material in (select	a.nr_sequencia
												 from 	prescr_material a
												 where	a.nr_prescricao 	= nr_prescricao_w
												 and	a.nr_sequencia_proc	= nr_sequencia_proc_w);
	
				end if;

			end if;

			if (ie_grava_log_gedipa_w = 'S') then
				insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
				values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 435, 'GERAR_FRACIONAMENTO_PROCESSO', null, null, 'End fetch do cursor c01');
			end if;
		
		else

			update	prescr_mat_hor
			set		nr_seq_etiqueta	= nr_seq_frac_npt_w
			where	nr_sequencia	= nr_seq_pmh_w
			and		coalesce(nr_seq_etiqueta::text, '') = '';
			
		end if;	

		end;
	end loop;
	close c01;

	if (ie_grava_log_gedipa_w = 'S') then
		insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
		values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 440, 'GERAR_FRACIONAMENTO_PROCESSO', null, null, 'Close do cursor c01');
	end if;

	for r_c_dietas_orais in c_dietas_orais loop

		if (ie_grava_log_gedipa_w = 'S') then
			CALL gravar_log_gedipa(	nr_log_p				=> 415,
								nm_objeto_execucao_p	=> 'GERAR_FRACIONAMENTO_PROCESSO',
								nm_objeto_chamado_p		=> null,
								ds_parametros_p			=> 'nr_seq_horario='||to_char(r_c_dietas_orais.nr_seq_horario)||'; nr_prescricao='||to_char(r_c_dietas_orais.nr_prescricao)||'; nr_seq_dieta='||to_char(r_c_dietas_orais.nr_seq_dieta),
								ds_log_p				=> 'Dieta oral - Entrou no cursor c_dietas_orais');
		end if;

		select	nextval('adep_processo_frac_seq')
		into STRICT	nr_seq_fracionamento_w
		;

		if (ie_grava_log_gedipa_w = 'S') then
			CALL gravar_log_gedipa(	nr_log_p				=> 420,
								nm_objeto_execucao_p	=> 'GERAR_FRACIONAMENTO_PROCESSO',
								nm_objeto_chamado_p		=> null,
								ds_parametros_p			=> null,
								ds_log_p				=> 'Dieta oral - Insert na tabela ADEP_PROCESSO_FRAC; SEQ='||to_char(nr_seq_fracionamento_w));
		end if;

		insert into adep_processo_frac(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			nr_seq_processo,
			dt_geracao,
			dt_preparo,
			nr_seq_digito)
		values (
			nr_seq_fracionamento_w,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_processo_p,
			clock_timestamp(),
			null,
			calcula_digito('MODULO11',nr_seq_fracionamento_w));

		if (ie_grava_log_gedipa_w = 'S') then
			CALL gravar_log_gedipa(	nr_log_p				=> 425,
								nm_objeto_execucao_p	=> 'GERAR_FRACIONAMENTO_PROCESSO',
								nm_objeto_chamado_p		=> null,
								ds_parametros_p			=> 'nr_seq_fracionamento_w='||to_char(nr_seq_fracionamento_w)||'; nr_seq_horario='||to_char(r_c_dietas_orais.nr_seq_horario),
								ds_log_p				=> 'Dieta oral - Update na tabela PRESCR_DIETA_HOR');
		end if;

		update	prescr_dieta_hor
		set		nr_seq_etiqueta	= nr_seq_fracionamento_w
		where	nr_sequencia	= r_c_dietas_orais.nr_seq_horario
		and		coalesce(nr_seq_etiqueta::text, '') = '';

	end loop;

	if (ie_grava_log_gedipa_w = 'S') then
		CALL gravar_log_gedipa(	nr_log_p				=> 440,
							nm_objeto_execucao_p	=> 'GERAR_FRACIONAMENTO_PROCESSO',
							nm_objeto_chamado_p		=> null,
							ds_parametros_p			=> null,
							ds_log_p				=> 'Dieta oral - End loop do cursor c_dietas_orais');
	end if;

	end;
end if;
if (ie_grava_log_gedipa_w = 'S') then
	insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
	values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 445, 'GERAR_FRACIONAMENTO_PROCESSO', null, 'nr_seq_processo_p='||to_char(nr_seq_processo_p)||'; nm_usuario_p='||nm_usuario_p, 'Termino da execucao da procedure GERAR_FRACIONAMENTO_PROCESSO'
);
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

exception
when others then
	ds_erro_w	:= substr(SQLERRM(SQLSTATE),1,1800);
	if (ie_grava_log_gedipa_w = 'S') then
		insert into log_gedipa(nr_sequencia, dt_log, nr_log, nm_objeto_execucao, nm_objeto_chamado, ds_parametros, ds_log)
		values (obter_nextval_sequence('log_gedipa'), clock_timestamp(), 450, 'GERAR_FRACIONAMENTO_PROCESSO', null, 'nr_seq_processo_p='||to_char(nr_seq_processo_p)||'; nm_usuario_p='||nm_usuario_p, 'Excecao na execucao da procedure GERAR_FRACIONAMENTO_PROCESSO; E='
||ds_erro_w);
	end if;
	if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;
end;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_fracionamento_processo ( nr_seq_processo_p bigint, nm_usuario_p text) FROM PUBLIC;

