-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE excluir_baixa_pagamento_escrit (nr_seq_escrit_p bigint, nm_usuario_p text, dt_exclusao_p timestamp) AS $body$
DECLARE


nr_titulo_w		bigint;
nr_sequencia_w		bigint;
nr_seq_baixa_w		bigint;
cd_estabelecimento_w	smallint;
qt_imposto_w		bigint;
nr_seq_tit_pag_baixa_w	titulo_pagar_baixa.nr_sequencia%type;
qt_tit_pag_baixa_w	bigint;
nr_seq_conta_banco_w	banco_escritural.nr_seq_conta_banco%type;
nr_seq_baixa_estornada_w	bigint;
ie_ctb_online_w	varchar(1);
ie_estorno_classif_w		varchar(1);

c01 CURSOR FOR
SELECT	nr_titulo
from	titulo_pagar_escrit
where	nr_seq_escrit	= nr_seq_escrit_p;


BEGIN

select	max(nr_seq_conta_banco)
into STRICT	nr_seq_conta_banco_w
from	banco_escritural
where	nr_sequencia = nr_seq_escrit_p;

select	coalesce(max(a.nr_titulo),0),
	max(a.cd_estabelecimento),
	max(b.nr_sequencia)
into STRICT	nr_titulo_w,
	cd_estabelecimento_w,
	nr_seq_tit_pag_baixa_w
from	titulo_pagar_escrit c,
	titulo_pagar_baixa b,
	titulo_pagar a
where	a.nr_titulo	= c.nr_titulo
and	a.nr_titulo	= b.nr_titulo
and	c.nr_seq_escrit	= nr_seq_escrit_p;

/* Realiza a consistencia do saldo do banco antes de estornar a baixa do pagamento */

if (nr_seq_conta_banco_w IS NOT NULL AND nr_seq_conta_banco_w::text <> '') then
	CALL consiste_movto_banco(nr_seq_conta_banco_w, dt_exclusao_p);
end if;

if (nr_titulo_w <> 0) and (coalesce(nr_seq_tit_pag_baixa_w,0) <> 0) then
	
	select	count(*)
	into STRICT	qt_tit_pag_baixa_w
	from	titulo_pagar_escrit c,
		titulo_pagar_baixa b,
		titulo_pagar a
	where	a.nr_titulo	= c.nr_titulo
	and	a.nr_titulo	= b.nr_titulo
	and	c.nr_seq_escrit	= nr_seq_escrit_p
	and	a.nr_titulo	= nr_titulo_w
	and	b.nr_sequencia	= nr_seq_tit_pag_baixa_w
	and	coalesce(b.nr_lote_contabil,0) <> 0;
	
	ie_ctb_online_w := ctb_online_pck.get_modo_lote(cd_tipo_lote_contabil_p => 7,
                                                    cd_estabelecimento_p    => cd_estabelecimento_w);
    if (ie_ctb_online_w = upper('N')) then
		if (qt_tit_pag_baixa_w <> 0) then
			/* Nao e possivel excluir a baixa desta remessa! O titulo nr_titulo_w ja tem lote contabil. */

			CALL wheb_mensagem_pck.exibir_mensagem_abort(236803,'NR_TITULO_W='||nr_titulo_w);
		end if;
	end if;	
end if;	

open	c01;
loop
fetch	c01 into nr_titulo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */


	select	max(a.nr_sequencia)
	into STRICT	nr_sequencia_w
	from	titulo_pagar_baixa a,
		titulo_pagar_escrit b		
	where	a.nr_titulo	= b.nr_titulo
	and	a.nr_titulo	= nr_titulo_w
	and	b.nr_seq_escrit	= nr_seq_escrit_p;

	select	max(nr_sequencia) + 1
	into STRICT	nr_seq_baixa_w
	from	titulo_pagar_baixa
	where	nr_titulo	= nr_titulo_w;
	
	select	count(*)
	into STRICT	nr_seq_baixa_estornada_w
	from	titulo_pagar_baixa
	where	nr_sequencia	= nr_sequencia_w
	and		nr_titulo	= nr_titulo_w
	and 	coalesce(nr_seq_baixa_origem::text, '') = '';
	
	if (nr_seq_baixa_estornada_w <> 0) then
	begin
	insert	into titulo_pagar_baixa(
		nr_titulo,
		nr_sequencia,
		dt_baixa,
		cd_moeda,
		dt_atualizacao,
		nm_usuario,
		cd_tipo_baixa,
		ie_acao,
		vl_baixa,
		vl_descontos,
		vl_outras_deducoes,
		vl_outras_despesas,
		vl_juros,
		vl_multa,
		vl_outros_acrescimos,
		vl_pago,
		cd_banco,
		nr_lote_contabil,
		vl_devolucao,
		nr_seq_devolucao,
		nr_bordero,
		nr_seq_trans_fin,
		vl_ir,
		nr_seq_conta_banco,
		nr_seq_escrit,
		vl_imposto,
		vl_cotacao_moeda,
		nr_seq_baixa_origem)
	(SELECT
		nr_titulo_w,
		nr_seq_baixa_w,
		dt_exclusao_p,
		cd_moeda,
		clock_timestamp(),
		nm_usuario_p,
		cd_tipo_baixa,
		ie_acao,
		vl_baixa * -1,
		vl_descontos * -1,
		vl_outras_deducoes * -1,
		vl_outras_despesas * -1,
		vl_juros * -1,
		vl_multa * -1,
		vl_outros_acrescimos * -1,
		vl_pago * -1,
		cd_banco,
		0 nr_lote_contabil,
		0,
		nr_seq_devolucao,
		nr_bordero,
		nr_seq_trans_fin,
		0,
		nr_seq_conta_banco,
		nr_seq_escrit,
		vl_imposto * -1,
		vl_cotacao_moeda,
		nr_sequencia
	from	titulo_pagar_baixa
	where	nr_seq_escrit	= nr_seq_escrit_p
	and	nr_titulo	= nr_titulo_w
	and	nr_sequencia	= nr_sequencia_w);
	
	CALL gerar_alerta_baixa_tit_pagar(nr_titulo_w,nr_seq_baixa_w,cd_estabelecimento_w,nm_usuario_p);

	select	count(*)
	into STRICT	qt_imposto_w
	from	titulo_pagar_baixa b,
		titulo_pagar_imposto a
	where	not exists (SELECT	1
		from	titulo_pagar_baixa x
		where	x.nr_seq_baixa_origem	= b.nr_sequencia
		and	x.nr_titulo		= b.nr_titulo)
	and	coalesce(b.nr_seq_baixa_origem::text, '') = ''
	and	(b.nr_seq_escrit IS NOT NULL AND b.nr_seq_escrit::text <> '')
	and	a.nr_seq_baixa		= b.nr_sequencia
	and	a.nr_titulo		= b.nr_titulo
	and	a.nr_titulo		= nr_titulo_w;

	insert into titulo_pagar_imposto(nr_sequencia,
		nr_titulo,
		cd_tributo,
		ie_pago_prev,
		dt_atualizacao,
		nm_usuario,
		dt_imposto,
		vl_base_calculo,
		vl_imposto,
		ds_emp_retencao,
		pr_imposto,
		cd_beneficiario,
		cd_conta_financ,
		nr_seq_trans_reg,
		nr_seq_trans_baixa,
		cd_cond_pagto,
		vl_nao_retido,
		ie_vencimento,
		vl_base_nao_retido,
		vl_trib_adic,
		vl_base_adic,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		vl_reducao,
		vl_desc_base,
		cd_darf,
		cd_variacao,
		ie_periodicidade,
		nr_seq_baixa)
	SELECT	nextval('titulo_pagar_imposto_seq'),
		nr_titulo,
		cd_tributo,
		ie_pago_prev,
		clock_timestamp(),
		nm_usuario_p,
		dt_imposto,
		vl_base_calculo * -1,
		vl_imposto * -1,
		ds_emp_retencao,
		pr_imposto,
		cd_beneficiario,
		cd_conta_financ,
		nr_seq_trans_reg,
		nr_seq_trans_baixa,
		cd_cond_pagto,
		vl_nao_retido * -1,
		ie_vencimento,
		vl_base_nao_retido * -1,
		vl_trib_adic * -1,
		vl_base_adic * -1,
		clock_timestamp(),
		nm_usuario_p,
		vl_reducao * -1,
		vl_desc_base * -1,
		cd_darf,
		cd_variacao,
		ie_periodicidade,
		nr_seq_baixa_w
	from	titulo_pagar_imposto
	where	nr_titulo	= nr_titulo_w
	and	nr_seq_baixa	= nr_sequencia_w;

	CALL cancelar_tit_pagar_imposto(nr_titulo_w, nr_sequencia_w, nm_usuario_p);

	end;

   /*rasoares - OS 2855900 - 18/03/2022*/

    ie_estorno_classif_w := Obter_Param_Usuario(851, 198, obter_perfil_ativo, nm_usuario_p, obter_estabelecimento_ativo, ie_estorno_classif_w);
    if ( coalesce(ie_estorno_classif_w,'N') = 'S' ) then
        CALL GERAR_TITULO_PAGAR_BAIXA_CC(nr_titulo_w,
                        nr_seq_baixa_w,
                        'N',
                        nm_usuario_p);
    end if;

	update	titulo_pagar_escrit
	set	dt_liquidacao	 = NULL,
		vl_liquidacao	 = NULL
	where	nr_titulo	= nr_titulo_w;

	CALL Atualizar_Saldo_Tit_Pagar(nr_titulo_w, nm_usuario_p);

	/* se ja foram gerados impostos na remessa do pagto escritural, nao pode gerar de novo */

	if (coalesce(qt_imposto_w,0)	= 0) then

		CALL Gerar_W_Tit_Pag_imposto(nr_titulo_w,nm_usuario_p);

	end if;
	end if;

end 	loop;
close	c01;

update	banco_escritural
set	dt_baixa	 = NULL,
	dt_atualizacao	= clock_timestamp(),
	nm_usuario	= nm_usuario_p,
    ds_status_arquivo  = NULL,
    dt_importacao  = NULL
where	nr_sequencia	= nr_seq_escrit_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE excluir_baixa_pagamento_escrit (nr_seq_escrit_p bigint, nm_usuario_p text, dt_exclusao_p timestamp) FROM PUBLIC;

