-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cus_gerar_indic_res_centro ( cd_estabelecimento_p bigint, cd_centro_controle_p bigint, cd_tabela_custo_p bigint, nr_seq_tabela_p bigint, nm_usuario_p text) AS $body$
DECLARE



cd_centro_controle_w		centro_controle.cd_centro_controle%type;
dt_mes_referencia_w		timestamp;
nr_seq_indicador_w		centro_controle_indicador.nr_seq_indicador%type;

C01 CURSOR FOR
SELECT	a.cd_centro_controle,
	a.nr_seq_indicador
from	centro_controle_indicador a
where	a.cd_estabelecimento = cd_estabelecimento_p
and	a.cd_centro_controle = cd_centro_controle_p
and not exists (	select	b.nr_seq_indicador
			from	resultado_ind_cen_cont b
			where	b.cd_estabelecimento 	= a.cd_estabelecimento
			and	b.cd_centro_controle 	= a.cd_centro_controle
			and	a.nr_seq_indicador   	= b.nr_seq_indicador
			and	b.nr_seq_tabela		= nr_seq_tabela_p)
and	substr(obter_se_periodo_vigente(a.dt_inicio_vigencia, a.dt_fim_vigencia, dt_mes_referencia_w),1,1) = 'S'
order by a.nr_seq_indicador;


BEGIN

if (coalesce(nr_seq_tabela_p,0) <> 0) then

	select	dt_mes_referencia
	into STRICT	dt_mes_referencia_w
	from	tabela_custo
	where	nr_sequencia	= nr_seq_tabela_p;
end if;

open C01;
loop
fetch C01 into
	cd_centro_controle_w,
	nr_seq_indicador_w;
EXIT WHEN NOT FOUND; /* apply on C01 */

	insert into resultado_ind_cen_cont(
		cd_estabelecimento,
		cd_tabela_custo,
		cd_centro_controle,
		nr_seq_indicador,
		nm_usuario,
		dt_atualizacao,
		qt_indicador,
		vl_indicador,
		cd_sequencia_criterio,
		nr_seq_tabela,
		dt_atualizacao_nrec,
		nm_usuario_nrec)
	values (	cd_estabelecimento_p,
		cd_tabela_custo_p,
		cd_centro_controle_w,
		nr_seq_indicador_w,
		nm_usuario_p,
		clock_timestamp(),
		0,
		0,
		null,
		nr_seq_tabela_p,
		clock_timestamp(),
		nm_usuario_p);
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cus_gerar_indic_res_centro ( cd_estabelecimento_p bigint, cd_centro_controle_p bigint, cd_tabela_custo_p bigint, nr_seq_tabela_p bigint, nm_usuario_p text) FROM PUBLIC;

