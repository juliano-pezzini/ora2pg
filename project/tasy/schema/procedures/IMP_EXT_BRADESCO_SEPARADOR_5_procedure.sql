-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE imp_ext_bradesco_separador_5 ( nr_seq_extrato_p bigint) AS $body$
DECLARE

 
/* Dados do extrato */
 
vl_extrato_anterior_w	double precision;
vl_total_extrato_w	double precision;
vl_extrato_atual_w	double precision;
nr_seq_conta_w		bigint;
dt_inicial_w		timestamp;
dt_final_w		timestamp;

/* Registro detalhe */
 
ds_dt_lancamento_w	varchar(10);
dt_lancamento_w		timestamp;
vl_credito_w		double precision;
vl_debito_w		double precision;
ie_deb_cred_w		varchar(1);
ds_historico_w		varchar(255);
nr_documento_w		varchar(255);
vl_lancamento_w		double precision;

c01 CURSOR FOR 
SELECT	substr(obter_valor_campo_separador(a.ds_conteudo,1,';'),1,255) ds_dt_lancamento, 
	rtrim(substr(obter_valor_campo_separador(a.ds_conteudo,2,';'),1,255)) ds_historico, 
	substr(obter_valor_campo_separador(a.ds_conteudo,3,';'),1,255) nr_documento, 
	somente_numero(substr(obter_valor_campo_separador(a.ds_conteudo,4,';'),1,255)) / 100 vl_credito, 
	somente_numero(substr(obter_valor_campo_separador(a.ds_conteudo,5,';'),1,255)) / 100 vl_debito 
from	w_interf_concil a 
where	a.nr_seq_conta		= nr_seq_conta_W;


BEGIN 
 
select	max(a.nr_seq_conta) 
into STRICT	nr_seq_conta_w 
from	banco_extrato a 
where	a.nr_sequencia	= nr_seq_extrato_p;
 
open	c01;
loop 
fetch	c01 into 
	ds_dt_lancamento_w, 
	ds_historico_w, 
	nr_documento_w, 
	vl_credito_w, 
	vl_debito_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
 
	if (coalesce(ds_dt_lancamento_w,'00000000') <> '00000000') then 
 
		dt_lancamento_w	:= to_date(ds_dt_lancamento_w,'dd/mm/yyyy');
 
	end if;
 
	if (coalesce(vl_debito_w,0)	<> 0) then 
		ie_deb_cred_w	:= 'D';
		vl_lancamento_w	:= vl_debito_w;
	else 
		ie_deb_cred_w	:= 'C';
		vl_lancamento_w	:= vl_credito_w;
	end if;
 
	insert	into banco_extrato_lanc(ds_historico, 
		dt_atualizacao, 
		dt_atualizacao_nrec, 
		dt_movimento, 
		ie_conciliacao, 
		ie_deb_cred, 
		nm_usuario, 
		nm_usuario_nrec, 
		nr_seq_extrato, 
		nr_sequencia, 
		vl_lancamento, 
		nr_documento) 
	values (ds_historico_w, 
		clock_timestamp(), 
		clock_timestamp(), 
		dt_lancamento_w, 
		'N', 
		ie_deb_cred_w, 
		'Tasy', 
		'Tasy', 
		nr_seq_extrato_p, 
		nextval('banco_extrato_lanc_seq'), 
		vl_lancamento_w, 
		nr_documento_w);
 
end	loop;
close	c01;
 
select	coalesce(max(a.vl_saldo_final),0) 
into STRICT	vl_extrato_anterior_w 
from	banco_extrato a 
where	a.nr_sequencia	= 
	(SELECT	max(x.nr_sequencia) 
	from	banco_extrato x 
	where	x.nr_sequencia	<> nr_seq_extrato_p 
	and	x.nr_seq_conta	= nr_seq_conta_w);
 
select	coalesce(sum(CASE WHEN a.ie_deb_cred='D' THEN a.vl_lancamento * -1  ELSE a.vl_lancamento END ),0) 
into STRICT	vl_total_extrato_w 
from	banco_extrato_lanc a 
where	a.nr_seq_extrato	= nr_seq_extrato_p;
 
vl_extrato_atual_w	:= vl_extrato_anterior_w + vl_total_extrato_w;
 
select	max(a.dt_movimento), 
	min(a.dt_movimento) 
into STRICT	dt_final_w, 
	dt_inicial_w 
from	banco_extrato_lanc a 
where	a.nr_seq_extrato	= nr_seq_extrato_p;
 
update	banco_extrato 
set	dt_inicio		= dt_inicial_w, 
	dt_final		= dt_final_w, 
	vl_saldo_inicial	= vl_extrato_anterior_w, 
	vl_saldo_final		= vl_extrato_atual_w 
where	nr_sequencia		= nr_seq_extrato_p;
 
delete	from w_interf_concil 
where	nr_seq_conta	= nr_seq_conta_W;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE imp_ext_bradesco_separador_5 ( nr_seq_extrato_p bigint) FROM PUBLIC;

