-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE procurar_horario_livre ( cd_agenda_p bigint, cd_pessoa_fisica_p text, dt_agenda_p timestamp, ie_forma_apres_p text, ie_tipo_agendamento_p text, cd_setor_exclusivo_p bigint, cd_estabelecimento_p bigint, nr_seq_area_p bigint, nr_seq_grupo_p bigint, nm_usuario_p text, cd_especialidade_p bigint, dt_filtro_p timestamp, qtd_dias_p bigint, CD_TURNO_P text, data_saida_p INOUT timestamp) AS $body$
DECLARE

 
dt_agenda_w		timestamp;
ie_primeira_vez 	varchar(1) := 'S';
dt_aux			timestamp := dt_filtro_p;

	 

BEGIN 
	while(dt_aux <= dt_filtro_p + qtd_dias_p) loop 
 
		select min(dt_agenda) 
		into STRICT  dt_agenda_w 
		from  ageint_consulta_hor_usu 
		where  nm_usuario = nm_usuario_p 
		and 	cd_agenda = coalesce(cd_agenda_p,cd_agenda ) 
		and 	trunc(DT_AGENDA) between trunc( dt_filtro_p ) and trunc(dt_aux) 
		and 	trunc(dt_agenda) >= trunc(clock_timestamp()) 
		and (cd_turno = cd_turno_p or cd_turno_p = '2') 
		--and   (ie_classif_agenda = :ie_classif_agenda_p or :ie_classif_agenda_p = 0) 
		--and   (nr_seq_proc_interno = :nr_seq_proc_interno_p or :nr_seq_proc_interno_p = 0) 
		and (cd_especialidade = cd_especialidade_p or coalesce(cd_especialidade_p::text, '') = '') 
		and	ie_status_agenda = 'L' 
		order by 1;		
		 
		if (dt_aux >= dt_filtro_p + qtd_dias_p) then 
			data_saida_p := null;
			exit;
		end if;
		if (dt_agenda_w IS NOT NULL AND dt_agenda_w::text <> '')then 
			data_saida_p := dt_agenda_w;
			exit;		
		else			 
			if (ie_primeira_vez = 'S') then 
				ie_primeira_vez := 'N';
			else 
				dt_aux := dt_aux + 1;	
			end if;
		CALL Ageint_Gerar_Consulta_Espec(cd_agenda_p, cd_pessoa_fisica_p, dt_aux, ie_forma_apres_p, ie_tipo_agendamento_p, cd_setor_exclusivo_p, cd_estabelecimento_p, nr_seq_area_p, nr_seq_grupo_p, nm_usuario_p, cd_especialidade_p);
		end if;
	end loop;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE procurar_horario_livre ( cd_agenda_p bigint, cd_pessoa_fisica_p text, dt_agenda_p timestamp, ie_forma_apres_p text, ie_tipo_agendamento_p text, cd_setor_exclusivo_p bigint, cd_estabelecimento_p bigint, nr_seq_area_p bigint, nr_seq_grupo_p bigint, nm_usuario_p text, cd_especialidade_p bigint, dt_filtro_p timestamp, qtd_dias_p bigint, CD_TURNO_P text, data_saida_p INOUT timestamp) FROM PUBLIC;

