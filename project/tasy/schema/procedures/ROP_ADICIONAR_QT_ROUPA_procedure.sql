-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE rop_adicionar_qt_roupa ( nr_sequencia_p bigint, qt_adicional_p bigint, cd_operacao_p bigint, cd_local_p bigint, dt_registro_p timestamp, nm_usuario_p text, nr_seq_lote_movto_p INOUT bigint) AS $body$
DECLARE

 
qt_roupa_w			double precision;
qt_roupa_ww			double precision;
ds_historico_w			varchar(4000);
ds_motivo_w			varchar(255);
nr_seq_lote_movto_w		bigint;
cd_estabelecimento_w		bigint;
cd_operacao_w			bigint;


BEGIN 
 
cd_operacao_w		:= coalesce(cd_operacao_p,0);
 
select	a.cd_estabelecimento, 
	coalesce(b.qt_roupa,0) 
into STRICT	cd_estabelecimento_w, 
	qt_roupa_w 
from	rop_lote_roupa a, 
	rop_roupa b 
where	a.nr_sequencia = b.nr_seq_lote_roupa 
and	b.nr_sequencia = nr_sequencia_p;
 
qt_roupa_ww	:= qt_roupa_w + qt_adicional_p;
 
update	rop_roupa 
set	qt_roupa	= qt_roupa_ww 
where	nr_Sequencia	= nr_sequencia_p;
 
/*ds_historico_w	:= 	substr(	'Foi adicionado a quantidade de ' 	|| qt_adicional_p || ' peças.' 				|| chr(13) || chr(10) || 
				'Quantidade anterior: '		|| qt_roupa_w 					|| chr(13) || chr(10) || 
				'Quantidade atual: '			|| qt_roupa_ww || '.',1,4000);*/
 
ds_historico_w	:= 	substr(	wheb_mensagem_pck.get_texto(312255, 'QT_ADICIONAL=' || qt_adicional_p) || chr(13) || chr(10) || 
				wheb_mensagem_pck.get_texto(312256, 'QT_ROUPA=' || qt_roupa_w)     || chr(13) || chr(10) || 
				wheb_mensagem_pck.get_texto(312257, 'QT_ROUPA=' || qt_roupa_ww)	    || '.',1,4000);
 
insert into rop_roupa_hist( 
	nr_sequencia, 
	dt_atualizacao, 
	nm_usuario, 
	dt_atualizacao_nrec, 
	nm_usuario_nrec, 
	nr_seq_roupa, 
	dt_historico, 
	ds_titulo, 
	ds_historico, 
	ie_tipo, 
	dt_liberacao, 
	nm_usuario_lib) 
values (	nextval('rop_roupa_hist_seq'), 
	clock_timestamp(), 
	nm_usuario_p, 
	clock_timestamp(), 
	nm_usuario_p, 
	nr_sequencia_p, 
	clock_timestamp(), 
	--'Adicionar quantidade da roupa.', 
	wheb_mensagem_pck.get_texto(312258), 
	ds_historico_w, 
	'S', 
	clock_timestamp(), 
	nm_usuario_p);	
	 
if (cd_operacao_w > 0) then 
 
	select	nextval('rop_lote_movto_seq') 
	into STRICT	nr_seq_lote_movto_w 
	;
 
	insert into rop_lote_movto( 
		nr_sequencia, 
		cd_estabelecimento, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		dt_registro, 
		nr_seq_operacao, 
		cd_pessoa_fisica, 
		nr_seq_local, 
		dt_liberacao, 
		ds_observacao) 
	values (	nr_seq_lote_movto_w, 
		cd_estabelecimento_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		trunc(dt_registro_p,'dd'), 
		cd_operacao_w, 
		obter_pessoa_fisica_usuario(nm_usuario_p,'C'), 
		cd_local_p, 
		null, 
		wheb_mensagem_pck.get_texto(312259));
		--'Movimento gerado através da opção Adicionar quantidades da roupa.'); 
 
	insert into rop_movto_roupa( 
		nr_sequencia, 
		nr_seq_lote, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		nr_seq_roupa, 
		dt_origem, 
		cd_estabelecimento, 
		ie_oper_correta, 
		qt_roupa) 
	values (	nextval('rop_movto_roupa_seq'), 
		nr_seq_lote_movto_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		nr_sequencia_p, 
		trunc(clock_timestamp(),'dd'), 
		cd_estabelecimento_w, 
		'S', 
		qt_adicional_p);
	end if;	
commit;
 
nr_seq_lote_movto_p := nr_seq_lote_movto_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE rop_adicionar_qt_roupa ( nr_sequencia_p bigint, qt_adicional_p bigint, cd_operacao_p bigint, cd_local_p bigint, dt_registro_p timestamp, nm_usuario_p text, nr_seq_lote_movto_p INOUT bigint) FROM PUBLIC;

