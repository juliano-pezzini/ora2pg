-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insert_invoice ( nr_seq_nota_fiscal_p bigint, ie_tipo_registro_p text, nr_ordem_compra_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, cd_operacao_nf_p bigint, cd_local_estoque_p bigint, cd_conta_contabil_p text, cd_centro_custo_p bigint, cd_serie_nf_p text, nr_nota_fiscal_p bigint, qt_mercadoria_p bigint, vl_preco_unitario_liquido_p bigint, vl_preco_total_item_p bigint, cd_mercadoria_p bigint, dt_emissao_p timestamp, vl_descontos_p bigint, pr_desconto_p bigint, vl_total_nota_p bigint, tx_tributo_p bigint, vl_tributo_p bigint, cd_cfop_p bigint, nr_seq_item_p bigint, cd_cliente_p text, nr_invoice_p INOUT bigint, cd_cgc_emitente_p text, cd_cgc_destinatario_p text, dt_entrada_saida_p timestamp, dt_emissao_nfe_p timestamp, vl_mercadoria_p bigint, ds_observacao_p text, vl_icms_p bigint, vl_ipi_p bigint, vl_pis_p bigint, vl_cofins_p bigint, vl_iss_p bigint, vl_irrf_p bigint, vl_inss_p bigint, vl_csll_p bigint, vl_outros_p bigint, vl_tributacao_p bigint, vl_deducao_p bigint, vl_iss_retido_p bigint, ds_modelo_p text, ds_link_p text) AS $body$
DECLARE


ds_log_w			nota_fiscal_int_imp.ds_log%type;
ie_status_w			nota_fiscal_int_imp.ie_status%type;
cd_cgc_emitente_ok_w		nota_fiscal_int_imp.cd_cgc_emitente_ok%type;
cd_cgc_destinatario_ok_w	nota_fiscal_int_imp.cd_cgc_destinatario_ok%type;
nr_sequencia_nf_w		nota_fiscal.nr_sequencia_nf%type;
nr_seq_nota_w			nota_fiscal.nr_sequencia%type;
ds_observacao_w			nota_fiscal.ds_observacao%type := ds_observacao_p;
cd_operacao_nf_w		nota_fiscal.cd_operacao_nf%type;


BEGIN
ie_status_w := 'I'; -- Importada
select	max(p.cd_cgc)
into STRICT	cd_cgc_emitente_ok_w
from	pessoa_juridica p
where	p.cd_cgc = lpad(cd_cgc_emitente_p,14,'0');

select	max(p.cd_cgc)
into STRICT	cd_cgc_destinatario_ok_w
from	pessoa_juridica p
where	p.cd_cgc = lpad(cd_cgc_destinatario_p,14,'0');

if (coalesce(cd_cgc_emitente_ok_w::text, '') = '') then
	ie_status_w := 'F'; -- Nota inconsistente
	ds_log_w := substr(wheb_mensagem_pck.get_texto(nr_seq_mensagem_p => 169145) || ' CNPJE='||cd_cgc_emitente_p,1,4000);
end if;

select (coalesce(max(nr_sequencia_nf),0)+1),
	max(nr_sequencia)
into STRICT 	nr_sequencia_nf_w,
	nr_seq_nota_w
from 	nota_fiscal
where 	cd_estabelecimento = cd_estabelecimento_p
and 	cd_cgc_emitente    = cd_cgc_emitente_ok_w
and 	nr_nota_fiscal     = nr_nota_fiscal_p
and 	cd_serie_nf        = cd_serie_nf_p;

select	max(cd_operacao_nf)
into STRICT	cd_operacao_nf_w
from	operacao_nota
where	cd_operacao_nf = cd_operacao_nf_p;

if (coalesce(cd_operacao_nf_w::text, '') = '') then
	select	max(cd_oper_compra_nf)
	into STRICT	cd_operacao_nf_w
	from	parametro_compras
	where 	cd_estabelecimento = cd_estabelecimento_p;
	
	ds_observacao_w := substr(ds_observacao_w || ' TPNF='||cd_operacao_nf_p,1,4000);
end if;

if (coalesce(cd_operacao_nf_w::text, '') = '') then
	ie_status_w := 'F'; -- Nota inconsistente
end if;

if (nr_seq_nota_w IS NOT NULL AND nr_seq_nota_w::text <> '') then
	ie_status_w := 'D'; -- Nota duplicada
end if;

if (coalesce(nr_seq_nota_w::text, '') = '') and (cd_cgc_emitente_ok_w IS NOT NULL AND cd_cgc_emitente_ok_w::text <> '') then
	select	nextval('nota_fiscal_seq')
	into STRICT	nr_seq_nota_w
	;

	if (coalesce(cd_cgc_destinatario_ok_w::text, '') = '') then
		ds_observacao_w := substr(ds_observacao_w || ' CNPJD='||cd_cgc_destinatario_p,1,4000);
	end if;	
end if;

insert into nota_fiscal_int_imp(nr_sequencia,
	cd_estabelecimento,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	ds_json,
	ds_token,
	nr_seq_nota,
	nr_nota_fiscal,
	cd_cgc_emitente,
	cd_cgc_destinatario,
	cd_serie_nf,
	cd_operacao_nf,
	dt_emissao,
	dt_entrada_saida,
	nr_ordem_compra,
	dt_emissao_nfe,
	ds_observacao,
	vl_nota_fiscal,
	vl_mercadoria,
	vl_icms,
	vl_ipi,
	vl_pis,
	vl_cofins,
	vl_iss,
	vl_irrf,
	vl_inss,
	vl_csll,
	vl_outros,
	vl_tributacao,
	vl_deducao,
	vl_iss_retido,
	ie_status,
	ds_modelo,
	ds_link,
	ds_log,
	cd_cgc_emitente_ok,
	cd_cgc_destinatario_ok,
	nr_sequencia_nf)
values (nr_seq_nota_fiscal_p,
	cd_estabelecimento_p,
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	null,
	null,
	nr_seq_nota_w,
	nr_nota_fiscal_p,
	cd_cgc_emitente_p,
	cd_cgc_destinatario_p,
	cd_serie_nf_p,
	cd_operacao_nf_w,
	dt_emissao_p,
	dt_entrada_saida_p,
	nr_ordem_compra_p,
	dt_emissao_nfe_p,
	ds_observacao_w,
	vl_total_nota_p,
	vl_mercadoria_p,
	vl_icms_p,
	vl_ipi_p,
	vl_pis_p,
	vl_cofins_p,
	vl_iss_p,
	vl_irrf_p,
	vl_inss_p,
	vl_csll_p,
	vl_outros_p,
	vl_tributacao_p,
	vl_deducao_p,
	vl_iss_retido_p,
	ie_status_w,
	ds_modelo_p,
	ds_link_p,
	null,
	cd_cgc_emitente_ok_w,
	cd_cgc_destinatario_ok_w,
	nr_sequencia_nf_w);
commit;

nr_invoice_p := nr_seq_nota_fiscal_p;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insert_invoice ( nr_seq_nota_fiscal_p bigint, ie_tipo_registro_p text, nr_ordem_compra_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, cd_operacao_nf_p bigint, cd_local_estoque_p bigint, cd_conta_contabil_p text, cd_centro_custo_p bigint, cd_serie_nf_p text, nr_nota_fiscal_p bigint, qt_mercadoria_p bigint, vl_preco_unitario_liquido_p bigint, vl_preco_total_item_p bigint, cd_mercadoria_p bigint, dt_emissao_p timestamp, vl_descontos_p bigint, pr_desconto_p bigint, vl_total_nota_p bigint, tx_tributo_p bigint, vl_tributo_p bigint, cd_cfop_p bigint, nr_seq_item_p bigint, cd_cliente_p text, nr_invoice_p INOUT bigint, cd_cgc_emitente_p text, cd_cgc_destinatario_p text, dt_entrada_saida_p timestamp, dt_emissao_nfe_p timestamp, vl_mercadoria_p bigint, ds_observacao_p text, vl_icms_p bigint, vl_ipi_p bigint, vl_pis_p bigint, vl_cofins_p bigint, vl_iss_p bigint, vl_irrf_p bigint, vl_inss_p bigint, vl_csll_p bigint, vl_outros_p bigint, vl_tributacao_p bigint, vl_deducao_p bigint, vl_iss_retido_p bigint, ds_modelo_p text, ds_link_p text) FROM PUBLIC;

