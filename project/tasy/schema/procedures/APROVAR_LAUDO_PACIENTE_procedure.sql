-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE aprovar_laudo_paciente ( nr_sequencia_p bigint, nr_seq_proc_p bigint, ie_tipo_p bigint, qt_caracteres_p bigint, nr_prescricao_p bigint, dir_padrao_p text, nr_seq_prescr_proc_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nm_usuario_aprov_p text, ds_arquivo_p INOUT text, ds_arquivo_dir_p INOUT text, ds_arquivo_aut_laudo_p INOUT text) AS $body$
DECLARE

 
ie_aprov_laudo_w  varchar(1) := 'N';
ie_medico_laudante_w varchar(1) := 'N';
aprov_vinc_pasta_medico_w varchar(1) := 'N';
ie_forma_aprovacao_w varchar(1) := 'N';
ds_caminho_pdf_w  varchar(1000) := '';
ds_arquivo_w  varchar(200) := '';
ds_arquivo_dir_w  varchar(200) := '';
ds_arquivo_aut_laudo_w varchar(200) := '';


BEGIN 
  
ie_aprov_laudo_w  := obter_se_aprov_laudo(nr_sequencia_p,nm_usuario_p);
ie_medico_laudante_w := obter_se_medico_laudante(nr_sequencia_p,nm_usuario_p,'0');
 
aprov_vinc_pasta_medico_w := obter_param_usuario(28, 95, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, aprov_vinc_pasta_medico_w);
 
if (ie_aprov_laudo_w = 'N') or (aprov_vinc_pasta_medico_w <> 'S' and 
   ie_medico_laudante_w = 'N') then 
 begin 
 CALL wheb_mensagem_pck.exibir_mensagem_abort(41093);
 end;
else 
 begin 
 ie_forma_aprovacao_w := obter_param_usuario(28, 47, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_forma_aprovacao_w);
 
 ds_arquivo_aut_laudo_w := autorizar_laudo_paciente(nr_sequencia_p, ie_tipo_p, ie_forma_aprovacao_w, qt_caracteres_p, nm_usuario_aprov_p, nr_seq_prescr_proc_p, cd_estabelecimento_p, nm_usuario_p, ds_arquivo_aut_laudo_w);
 end;
end if;
 
ds_caminho_pdf_w := obter_param_usuario(28, 141, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ds_caminho_pdf_w);
 
if (ds_caminho_pdf_w <> '') then 
 begin 
 SELECT * FROM gerar_nome_arquivo_laudo(nr_seq_proc_p, nr_prescricao_p, dir_padrao_p, nm_usuario_p, cd_estabelecimento_p, ds_arquivo_w, ds_arquivo_dir_w) INTO STRICT ds_arquivo_w, ds_arquivo_dir_w;
 end;
end if;
 
ds_arquivo_p   := ds_arquivo_w;
ds_arquivo_dir_p   := ds_arquivo_dir_w;
ds_arquivo_aut_laudo_p := ds_arquivo_aut_laudo_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE aprovar_laudo_paciente ( nr_sequencia_p bigint, nr_seq_proc_p bigint, ie_tipo_p bigint, qt_caracteres_p bigint, nr_prescricao_p bigint, dir_padrao_p text, nr_seq_prescr_proc_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, nm_usuario_aprov_p text, ds_arquivo_p INOUT text, ds_arquivo_dir_p INOUT text, ds_arquivo_aut_laudo_p INOUT text) FROM PUBLIC;

