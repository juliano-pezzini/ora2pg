-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE envia_email_proximo_aprov ( nr_seq_aprovacao_p bigint, nr_seq_proc_aprov_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* Dados da regra */

nr_seq_regra_w			bigint;
ds_email_adicional_w		varchar(2000);
cd_perfil_dispara_w		integer;
ie_momento_envio_w		varchar(1);
ie_usuario_w			varchar(1);
nr_documento_w			bigint;
ie_origem_processo_w		varchar(10);
ie_envia_pessoa_deleg_w		varchar(1);

/*Dados do aprovador*/

ds_email_w			varchar(255);

/*Dados da macro*/

nm_pessoa_solicitante_w		varchar(255);
cd_local_estoque_w		smallint;
ds_local_estoque_w		varchar(255);
cd_centro_custo_w		integer;
ds_centro_custo_w		varchar(255);
vl_total_aprov_w			double precision;
vl_total_aprov_masc_w		varchar(100);
cd_comprador_w			varchar(10);
ds_forn_sugerido_w		varchar(255);
ds_tipo_servico_w			varchar(255);	
dt_solicitacao_compra_w		timestamp;
dt_liberacao_w			timestamp;	
ds_observacao_w			varchar(4000);
ds_material_w			varchar(4000);

/*Dados do e-mail*/

ds_assunto_w			varchar(255);
ds_mensagem_w			varchar(4000);
ds_destinatarios_w			varchar(4000);
nm_usuario_origem_w		varchar(255);
ds_email_origem_w			varchar(255);
ds_email_remetente_w		varchar(255);
ie_envia_email_w		varchar(1);
ds_materiais_w		varchar(4000);

c00 CURSOR FOR
SELECT	nr_sequencia,
	coalesce(ds_email_remetente,'X'),
	replace(ds_email_adicional,',',';'),
	cd_perfil_disparar,
	coalesce(ie_momento_envio,'I'),
	coalesce(ie_envia_pessoa_deleg,'N')
from	regra_envio_email_compra
where	ie_tipo_mensagem = 58
and	ie_situacao = 'A'
and	cd_estabelecimento = cd_estabelecimento_p
and	obter_se_envia_email_regra(nr_documento_w, 'SC', 58, cd_estabelecimento, nr_sequencia) = 'S';

c01 CURSOR FOR
SELECT	b.ds_email
from	pessoas_processo_aprovacao_v a,
	usuario b
where	a.nm_usuario = b.nm_usuario
and	a.nr_sequencia = nr_seq_aprovacao_p
and	a.nr_seq_proc_aprov = nr_seq_proc_aprov_p
and	a.ie_aprov_reprov = 'P'
group by	ds_email;

c02 CURSOR FOR
SELECT	ds_email
from	(SELECT	b.ds_email
	from	pessoas_processo_aprovacao_v a,
		usuario b
	where	a.nm_usuario = b.nm_usuario
	and	a.nr_sequencia = nr_seq_aprovacao_p
	and	a.nr_seq_proc_aprov = nr_seq_proc_aprov_p
	and	a.ie_aprov_reprov = 'P'
	and	not exists (select	1
			from	pessoa_fisica_delegacao x
			where	x.cd_pessoa_fisica = a.cd_pessoa_fisica
			and	((coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(x.dt_inicio_limite),ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())) <= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())) and (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(x.dt_limite) >= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp()))))
	
union all

	select	b.ds_email
	from	usuario b,
		pessoa_fisica_delegacao c,
		pessoas_processo_aprovacao_v a
	where	a.cd_pessoa_fisica = c.cd_pessoa_fisica
	and	c.cd_pessoa_substituta = b.cd_pessoa_fisica
	and	((coalesce(ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(c.dt_inicio_limite),ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())) <= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())) and (ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(c.dt_limite) >= ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(clock_timestamp())))
	and	a.nr_sequencia = nr_seq_aprovacao_p
	and	a.nr_seq_proc_aprov = nr_seq_proc_aprov_p
	and	a.ie_aprov_reprov = 'P') alias25
group by	ds_email;

c03 CURSOR FOR
SELECT	cd_material||chr(45)||obter_desc_material(cd_material)
from	solic_compra_item
where	nr_solic_compra = nr_documento_w
and		nr_seq_aprovacao = nr_seq_aprovacao_p;


BEGIN

select	obter_origem_processo_aprov(nr_seq_aprovacao_p)
into STRICT	ie_origem_processo_w
;

if (ie_origem_processo_w = 'O') then
	begin

	ie_origem_processo_w := 'OC';

	select	coalesce(max(nr_ordem_compra),0)
	into STRICT	nr_documento_w
	from	ordem_compra_item
	where	nr_seq_aprovacao = nr_seq_aprovacao_p;

	end;
elsif (ie_origem_processo_w = 'S') then
	begin	

	ie_origem_processo_w := 'SC';
	
	select	coalesce(max(nr_solic_compra),0)
	into STRICT	nr_documento_w
	from	solic_compra_item
	where	nr_seq_aprovacao = nr_seq_aprovacao_p;

	end;
end if;

select	coalesce(obter_se_envia_email_regra(nr_documento_w, ie_origem_processo_w, 58, cd_estabelecimento_p),'S')
into STRICT	ie_envia_email_w
;

if (ie_envia_email_w = 'S') then

	open C00;
	loop
	fetch C00 into	
		nr_seq_regra_w,
		ds_email_remetente_w,
		ds_email_adicional_w,
		cd_perfil_dispara_w,
		ie_momento_envio_w,
		ie_envia_pessoa_deleg_w;
	EXIT WHEN NOT FOUND; /* apply on C00 */
		begin
		
		if (nr_seq_regra_w > 0) and (ie_origem_processo_w = 'SC') and
			((coalesce(cd_perfil_dispara_w::text, '') = '') or
			(cd_perfil_dispara_w IS NOT NULL AND cd_perfil_dispara_w::text <> '' AND cd_perfil_dispara_w = obter_perfil_ativo)) then
			begin

			if (ie_origem_processo_w = 'SC') then
				begin

				select	substr(obter_nome_pf(cd_pessoa_solicitante),1,255),
					coalesce(cd_local_estoque,0),
					substr(coalesce(obter_desc_local_estoque(cd_local_estoque),wheb_mensagem_pck.get_texto(299743)),1,255),
					coalesce(cd_centro_custo,0),
					substr(coalesce(obter_desc_centro_custo(cd_centro_custo),wheb_mensagem_pck.get_texto(300013)),1,255),
					cd_comprador_resp,
					obter_nome_pf_pj(cd_pessoa_fisica,cd_fornec_sugerido),
					obter_valor_dominio(4200,ie_tipo_servico),
					dt_solicitacao_compra,
					dt_liberacao,
					ds_observacao					
				into STRICT	nm_pessoa_solicitante_w,
					cd_local_estoque_w,
					ds_local_estoque_w,
					cd_centro_custo_w,
					ds_centro_custo_w,
					cd_comprador_w,
					ds_forn_sugerido_w,
					ds_tipo_servico_w,
					dt_solicitacao_compra_w,
					dt_liberacao_w,
					ds_observacao_w
				from	solic_compra
				where	nr_solic_compra = nr_documento_w;
				
				open C03;
				loop
				fetch C03 into	
					ds_material_w;
				EXIT WHEN NOT FOUND; /* apply on C03 */
					begin
					ds_materiais_w := substr(ds_materiais_w || chr(10) || ds_material_w,1,4000);
					end;
				end loop;
				close C03;

				select	coalesce(sum(b.qt_material * coalesce(b.vl_unit_previsto,0)),0)
				into STRICT	vl_total_aprov_w
				from	solic_compra a,
					solic_compra_item b
				where	a.nr_solic_compra = b.nr_solic_compra
				and	a.nr_solic_compra = nr_documento_w
				and	b.nr_seq_aprovacao = nr_seq_aprovacao_p;

				vl_total_aprov_masc_w		:= substr(campo_mascara_virgula_casas(vl_total_aprov_w,2),1,100);

				end;
			elsif (ie_origem_processo_w = 'OC') then
				begin

				select	substr(obter_nome_pf(cd_pessoa_solicitante),1,255),
					coalesce(cd_local_entrega,0),
					substr(coalesce(obter_desc_local_estoque(cd_local_entrega),wheb_mensagem_pck.get_texto(299743)),1,255),
					coalesce(cd_centro_custo,0),
					substr(coalesce(obter_desc_centro_custo(cd_centro_custo),wheb_mensagem_pck.get_texto(299740)),1,255),
					cd_comprador
				into STRICT	nm_pessoa_solicitante_w,
					cd_local_estoque_w,
					ds_local_estoque_w,
					cd_centro_custo_w,
					ds_centro_custo_w,
					cd_comprador_w
				from	ordem_compra
				where	nr_ordem_compra = nr_documento_w;

				select	coalesce(sum(b.qt_material * coalesce(b.vl_unitario_material,0)),0)
				into STRICT	vl_total_aprov_w
				from	ordem_compra a,
					ordem_compra_item b
				where	a.nr_ordem_compra = b.nr_ordem_compra
				and	a.nr_ordem_compra = nr_documento_w
				and	b.nr_seq_aprovacao = nr_seq_aprovacao_p;

				vl_total_aprov_masc_w		:= substr(campo_mascara_virgula_casas(vl_total_aprov_w,2),1,100);

				end;
			end if;

			select	ds_assunto,
				ds_mensagem_padrao
			into STRICT	ds_assunto_w,
				ds_mensagem_w
			from	regra_envio_email_compra
			where	nr_sequencia = nr_seq_regra_w;			
			
			ds_assunto_w := substr(replace_macro(ds_assunto_w,'@nr_documento',nr_documento_w),1,255);
			ds_assunto_w := substr(replace_macro(ds_assunto_w,'@solicitante',nm_pessoa_solicitante_w),1,255);
			ds_assunto_w := substr(replace_macro(ds_assunto_w,'@cd_local_estoque',cd_local_estoque_w),1,255);
			ds_assunto_w := substr(replace_macro(ds_assunto_w,'@ds_local_estoque',ds_local_estoque_w),1,255);
			ds_assunto_w := substr(replace_macro(ds_assunto_w,'@cd_centro_custo',cd_centro_custo_w),1,255);
			ds_assunto_w := substr(replace_macro(ds_assunto_w,'@ds_centro_custo',ds_centro_custo_w),1,255);
			ds_assunto_w := substr(replace_macro(ds_assunto_w,'@vl_total_aprovacao',vl_total_aprov_masc_w),1,255);
			ds_assunto_w := substr(replace_macro(ds_assunto_w,'@seq_aprovacao',nr_seq_aprovacao_p),1,255);
			ds_assunto_w := substr(replace_macro(ds_assunto_w,'@ds_forn_sugerido',ds_forn_sugerido_w),1,255);
			ds_assunto_w := substr(replace_macro(ds_assunto_w,'@ds_tipo_servico',ds_tipo_servico_w),1,255);
			ds_assunto_w := substr(replace_macro(ds_assunto_w,'@dt_solicitacao_compra',dt_solicitacao_compra_w),1,255);
			ds_assunto_w := substr(replace_macro(ds_assunto_w,'@dt_liberacao',dt_liberacao_w),1,255);
			ds_assunto_w := substr(replace_macro(ds_assunto_w,'@ds_observacao',ds_observacao_w),1,255);
			ds_assunto_w := substr(replace_macro(ds_assunto_w,'@ds_material',ds_materiais_w),1,255);
			ds_assunto_w := substr(ds_assunto_w,1,255);						
			
			ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@nr_documento',nr_documento_w),1,4000);
			ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@solicitante',nm_pessoa_solicitante_w),1,4000);
			ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@cd_local_estoque',cd_local_estoque_w),1,4000);
			ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@ds_local_estoque',ds_local_estoque_w),1,4000);
			ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@cd_centro_custo',cd_centro_custo_w),1,4000);
			ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@ds_centro_custo',ds_centro_custo_w),1,4000);
			ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@vl_total_aprovacao',vl_total_aprov_masc_w),1,4000);
			ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@seq_aprovacao',nr_seq_aprovacao_p),1,4000);
			ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@ds_forn_sugerido',ds_forn_sugerido_w),1,4000);
			ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@ds_tipo_servico',ds_tipo_servico_w),1,4000);
			ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@dt_solicitacao_compra',dt_solicitacao_compra_w),1,4000);
			ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@dt_liberacao',dt_liberacao_w),1,4000);
			ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@ds_observacao',ds_observacao_w),1,4000);
			ds_mensagem_w := substr(replace_macro(ds_mensagem_w,'@ds_material',ds_materiais_w),1,4000);
			ds_mensagem_w := substr(ds_mensagem_w,1,4000);

			select	coalesce(max(ie_usuario),'U')
			into STRICT	ie_usuario_w
			from	regra_envio_email_compra
			where	nr_sequencia = nr_seq_regra_w;

			if (ie_usuario_w = 'U') or
				((coalesce(cd_comprador_w,'0') <> 0) and (ie_usuario_w = 'O')) then --Usuario
				begin

				select	ds_email,
					nm_usuario
				into STRICT	ds_email_origem_w,
					nm_usuario_origem_w
				from	usuario
				where	nm_usuario = nm_usuario_p;

				end;
			elsif (ie_usuario_w = 'C') then --Setor compras
				begin

				select	ds_email
				into STRICT	ds_email_origem_w
				from	parametro_compras
				where	cd_estabelecimento = cd_estabelecimento_p;

				select	coalesce(ds_fantasia,ds_razao_social)
				into STRICT	nm_usuario_origem_w
				from	estabelecimento_v
				where	cd_estabelecimento = cd_estabelecimento_p;

				end;
			elsif (ie_usuario_w = 'O') then --Comprador
				begin

				select	max(ds_email),
					max(nm_guerra)
				into STRICT	ds_email_origem_w,
					nm_usuario_origem_w
				from	comprador
				where	cd_pessoa_fisica = cd_comprador_w
				and	cd_estabelecimento = cd_estabelecimento_p;

				end;
			end if;

			if (ds_email_remetente_w <> 'X') then
				ds_email_origem_w	:= ds_email_remetente_w;
			end if;

			if (ie_envia_pessoa_deleg_w = 'S') then
				begin

				open c02;
				loop
				fetch c02 into
					ds_email_w;
				EXIT WHEN NOT FOUND; /* apply on c02 */
					begin
			
					ds_destinatarios_w	:= ds_destinatarios_w || ds_email_w || ';';
			
					end;
				end loop;
				close c02;

				end;
			else
				begin

				open c01;
				loop
				fetch c01 into
					ds_email_w;
				EXIT WHEN NOT FOUND; /* apply on c01 */
					begin
			
					ds_destinatarios_w	:= ds_destinatarios_w || ds_email_w || ';';
			
					end;
				end loop;
				close c01;

				end;
			end if;

			if (ds_email_adicional_w IS NOT NULL AND ds_email_adicional_w::text <> '') then
				ds_destinatarios_w	:= ds_destinatarios_w || ds_email_adicional_w;
			end if;
			
			if (ie_momento_envio_w = 'A') then
				begin

				CALL sup_grava_envio_email(
					ie_origem_processo_w,
					'58',
					nr_documento_w,
					nr_seq_aprovacao_p,
					nr_seq_proc_aprov_p,
					ds_destinatarios_w,
					nm_usuario_origem_w,
					ds_email_origem_w,
					ds_assunto_w,
					ds_mensagem_w,
					cd_estabelecimento_p,
					nm_usuario_p);

				end;
			else
				begin
				CALL enviar_email(ds_assunto_w,ds_mensagem_w,ds_email_origem_w,ds_destinatarios_w,nm_usuario_origem_w,'M');
				exception
				when others then
					/*gravar__log__tasy(91301,'Falha ao enviar e-mail compras - Evento: 58 - Seq. Regra: ' || nr_seq_regra_w,nm_usuario_p);*/

					nr_seq_regra_w := nr_seq_regra_w;
				end;
			end if;

			end;
		end if;

		end;
	end loop;
	close C00;
end if;
	
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE envia_email_proximo_aprov ( nr_seq_aprovacao_p bigint, nr_seq_proc_aprov_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

