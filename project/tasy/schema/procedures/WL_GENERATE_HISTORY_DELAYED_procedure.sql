-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE wl_generate_history_delayed ( nr_prescricao_p prescr_material.nr_prescricao%type, nr_seq_material_p prescr_material.nr_seq_material%type, dt_horario_p wl_worklist_historico.dt_atualizacao%type) AS $body$
DECLARE

								  
ds_motivo_w				wl_worklist_historico.ds_motivo%type;
nr_seq_wl_item_w		wl_item.nr_sequencia%type;
nr_seq_item_cpoe_w		cpoe_material.nr_sequencia%type;	
nr_seq_worklist_w 		wl_worklist.nr_sequencia%type;			


BEGIN
if ( (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nr_seq_material_p IS NOT NULL AND nr_seq_material_p::text <> '') and (dt_horario_p IS NOT NULL AND dt_horario_p::text <> ''))  then
	nr_seq_wl_item_w := obter_se_worklist_lib_cat('D');
	
	if (nr_seq_wl_item_w IS NOT NULL AND nr_seq_wl_item_w::text <> '') then
		ds_motivo_w:= obter_desc_expressao(488570) || ': ' || to_char(dt_horario_p , 'dd/mm/yyyy hh24:mi');

		select max(nr_seq_mat_cpoe)
		into STRICT nr_seq_item_cpoe_w
		from  prescr_material b
		where b.nr_prescricao = nr_prescricao_p
		and b.nr_sequencia = nr_seq_material_p;
		
		select max(nr_sequencia)
		into STRICT nr_seq_worklist_w
		from wl_worklist
		where nr_seq_item = nr_seq_wl_item_w
		and nr_seq_item_cpoe = nr_seq_item_cpoe_w;
		
		if (nr_seq_worklist_w IS NOT NULL AND nr_seq_worklist_w::text <> '') then
			insert into wl_worklist_historico(nr_sequencia,
					 nr_seq_worklist, 
					 ds_motivo, 
					 nm_usuario, 
					 dt_atualizacao,
					 nr_seq_motivo) 
			values (nextval('wl_worklist_historico_seq'), 
					 nr_seq_worklist_w, 
					 ds_motivo_w, 
					 wheb_usuario_pck.get_nm_usuario, 
					 clock_timestamp(),
					 null);
				
		 end if;
	end if;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE wl_generate_history_delayed ( nr_prescricao_p prescr_material.nr_prescricao%type, nr_seq_material_p prescr_material.nr_seq_material%type, dt_horario_p wl_worklist_historico.dt_atualizacao%type) FROM PUBLIC;

