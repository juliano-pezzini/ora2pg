-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualizar_copiar_prescricao ( nr_prescricao_p bigint, ds_nutr_dieta_oral_selec_p text, ds_nutr_suplemento_selec_p text, ds_nutr_sne_selec_p text, ds_nutr_npt_selec_p text, ds_solucao_selec_p text, ds_medicamento_selec_p text, ds_material_selec_p text, ds_procedimento_selec_p text, ds_recomendacao_selec_p text, ds_banco_sangue_selec_p text, ds_oxigenioterapia_selec_p text, ds_hemod_prescricao_selec_p text, ds_hemod_solucao_selec_p text, ds_hemod_medicamento_selec_p text, ds_anatomia_patologica_selec_p text, ds_citopatologico_selec_p text, ds_histopatologico_selec_p text, ds_gasoterapia_selec_p text, ds_nutr_npt_ped_selec_p text, ds_nutr_dieta_oral_p text, ds_nutr_suplemento_p text, ds_nutr_sne_p text, ds_nutr_npt_p text, ds_solucao_p text, ds_medicamento_p text, ds_material_p text, ds_procedimento_p text, ds_recomendacao_p text, ds_banco_sangue_p text, ds_oxigenioterapia_p text, ds_hemod_prescricao_p text, ds_hemod_solucao_p text, ds_hemod_medicamento_p text, ds_anatomia_patologica_p text, ds_citopatologico_p text, ds_histopatologico_p text, ds_gasoterapia_p text, ds_nutr_npt_ped_p text, nm_usuario_p text, ds_nutr_leitderiv_p text, ds_nutr_leitderiv_selec_p text, ds_justificativa_elim_p text) AS $body$
BEGIN
if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') and (nm_usuario_p IS NOT NULL AND nm_usuario_p::text <> '') then 
	begin 
	 
	CALL elimina_item_copia_prescr( 
		nr_prescricao_p, 
		ds_nutr_dieta_oral_p, 
		ds_nutr_suplemento_p, 
		ds_nutr_sne_p, 
		ds_nutr_npt_p, 
		ds_solucao_p, 
		ds_medicamento_p, 
		ds_material_p, 
		ds_procedimento_p, 
		ds_recomendacao_p, 
		ds_banco_sangue_p, 
		ds_oxigenioterapia_p, 
		ds_hemod_prescricao_p, 
		ds_hemod_solucao_p, 
		ds_hemod_medicamento_p, 
		ds_anatomia_patologica_p, 
		ds_citopatologico_p, 
		ds_histopatologico_p, 
		ds_gasoterapia_p, 
		ds_nutr_npt_ped_p, 
		ds_nutr_leitderiv_p); --- Parametro novo criado para o delphi para itens de leites e derivados 
	CALL atualizar_inf_copia_prescr(nr_prescricao_p,ds_nutr_dieta_oral_selec_p,nm_usuario_p);
	CALL atualizar_inf_copia_prescr(nr_prescricao_p,ds_nutr_suplemento_selec_p,nm_usuario_p);
	CALL atualizar_inf_copia_prescr(nr_prescricao_p,ds_nutr_sne_selec_p,nm_usuario_p);
	CALL atualizar_inf_copia_prescr(nr_prescricao_p,ds_nutr_npt_selec_p,nm_usuario_p);
	CALL atualizar_inf_copia_prescr(nr_prescricao_p,ds_solucao_selec_p,nm_usuario_p);
	CALL atualizar_inf_copia_prescr(nr_prescricao_p,ds_medicamento_selec_p,nm_usuario_p);
	CALL atualizar_inf_copia_prescr(nr_prescricao_p,ds_material_selec_p,nm_usuario_p);
	CALL atualizar_inf_copia_prescr(nr_prescricao_p,ds_procedimento_selec_p,nm_usuario_p);
	CALL atualizar_inf_copia_prescr(nr_prescricao_p,ds_recomendacao_selec_p,nm_usuario_p);
	CALL atualizar_inf_copia_prescr(nr_prescricao_p,ds_banco_sangue_selec_p,nm_usuario_p);
	CALL atualizar_inf_copia_prescr(nr_prescricao_p,ds_oxigenioterapia_selec_p,nm_usuario_p);
	CALL atualizar_inf_copia_prescr(nr_prescricao_p,ds_hemod_prescricao_selec_p,nm_usuario_p);
	CALL atualizar_inf_copia_prescr(nr_prescricao_p,ds_hemod_solucao_selec_p,nm_usuario_p);
	CALL atualizar_inf_copia_prescr(nr_prescricao_p,ds_hemod_medicamento_selec_p,nm_usuario_p);
	CALL atualizar_inf_copia_prescr(nr_prescricao_p,ds_anatomia_patologica_selec_p,nm_usuario_p);
	CALL atualizar_inf_copia_prescr(nr_prescricao_p,ds_citopatologico_selec_p,nm_usuario_p);
	CALL atualizar_inf_copia_prescr(nr_prescricao_p,ds_histopatologico_selec_p,nm_usuario_p);
	CALL atualizar_inf_copia_prescr(nr_prescricao_p,ds_gasoterapia_selec_p,nm_usuario_p);
	CALL atualizar_inf_copia_prescr(nr_prescricao_p,ds_nutr_npt_ped_selec_p,nm_usuario_p);
	CALL atualizar_inf_copia_prescr(nr_prescricao_p,ds_nutr_leitderiv_selec_p,nm_usuario_p);
	 
	update	prescr_material 
	set		nr_seq_substituto	 = NULL 
	where  (nr_seq_substituto IS NOT NULL AND nr_seq_substituto::text <> '') 
	and		nr_prescricao		= nr_prescricao_p;
	 
	if (ds_justificativa_elim_p IS NOT NULL AND ds_justificativa_elim_p::text <> '') then 
		update	prescr_medica 
		set		ds_justificativa = substr(replace(CASE WHEN ds_justificativa = NULL THEN  null  ELSE ds_justificativa || '$' END  || ds_justificativa_elim_p, '$', chr(10)), 1, 2000) 
		where	nr_prescricao = nr_prescricao_p;
	end if;
	 
	end;
end if;
commit;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualizar_copiar_prescricao ( nr_prescricao_p bigint, ds_nutr_dieta_oral_selec_p text, ds_nutr_suplemento_selec_p text, ds_nutr_sne_selec_p text, ds_nutr_npt_selec_p text, ds_solucao_selec_p text, ds_medicamento_selec_p text, ds_material_selec_p text, ds_procedimento_selec_p text, ds_recomendacao_selec_p text, ds_banco_sangue_selec_p text, ds_oxigenioterapia_selec_p text, ds_hemod_prescricao_selec_p text, ds_hemod_solucao_selec_p text, ds_hemod_medicamento_selec_p text, ds_anatomia_patologica_selec_p text, ds_citopatologico_selec_p text, ds_histopatologico_selec_p text, ds_gasoterapia_selec_p text, ds_nutr_npt_ped_selec_p text, ds_nutr_dieta_oral_p text, ds_nutr_suplemento_p text, ds_nutr_sne_p text, ds_nutr_npt_p text, ds_solucao_p text, ds_medicamento_p text, ds_material_p text, ds_procedimento_p text, ds_recomendacao_p text, ds_banco_sangue_p text, ds_oxigenioterapia_p text, ds_hemod_prescricao_p text, ds_hemod_solucao_p text, ds_hemod_medicamento_p text, ds_anatomia_patologica_p text, ds_citopatologico_p text, ds_histopatologico_p text, ds_gasoterapia_p text, ds_nutr_npt_ped_p text, nm_usuario_p text, ds_nutr_leitderiv_p text, ds_nutr_leitderiv_selec_p text, ds_justificativa_elim_p text) FROM PUBLIC;

