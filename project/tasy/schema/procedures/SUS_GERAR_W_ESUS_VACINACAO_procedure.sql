-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_gerar_w_esus_vacinacao ( nr_seq_lote_p esus_lote_envio.nr_sequencia%type, ie_tipo_lote_esus_p esus_lote_envio.ie_tipo_lote_esus%type, cd_cnes_estab_p estabelecimento.cd_cns%type, nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


nr_seq_vacinacao_w 	  	  w_esus_vacinacao.nr_sequencia%type;
cd_estabelecimento_w  	  w_esus_vacinacao.cd_estabelecimento%type;
dt_atualizacao_w		  w_esus_vacinacao.dt_atualizacao%type;
nm_usuario_w			  w_esus_vacinacao.nm_usuario%type;
dt_atendimento_w		  w_esus_vacinacao.dt_atendimento%type;
dt_atualizacao_nrec_w     w_esus_vacinacao.dt_atualizacao_nrec%type;
nm_usuario_nrec_w 	   	  w_esus_vacinacao.nm_usuario_nrec%type;
cd_cbo_prof_w	  		  w_esus_vacinacao.cd_cbo_prof%type;
cd_profissional_w		  w_esus_vacinacao.cd_profissional%type;
nr_seq_sus_equipe_w		  w_esus_vacinacao.nr_seq_sus_equipe%type;
cd_pessoa_fisica_w	  	  w_esus_vacinacao.cd_pessoa_fisica%type;
ie_turno_atendimento_w 	  w_esus_vacinacao.ie_turno_atendimento%type;
nr_prontuario_w 	      w_esus_vacinacao.nr_prontuario%type;
cd_cnes_unidade_w      	  w_esus_vacinacao.cd_cnes_unidade%type;
cd_cnes_unidade_ww        w_esus_vacinacao.cd_cnes_unidade%type;
ie_local_atendimento_w    w_esus_vacinacao.ie_local_atendimento%type;
ie_gestante_w          	  w_esus_vacinacao.ie_gestante%type;
nr_atendimento_w	   	  w_esus_vacinacao.nr_atendimento%type;
ie_viajante_w	      	  w_esus_vacinacao.ie_viajante%type;
ie_puerpera_w	       	  w_esus_vacinacao.ie_puerpera%type;
cd_uuid_original_w   	  w_esus_vacinacao.cd_uuid_original%type;
cd_municipio_ibge_w   	  w_esus_vacinacao.cd_municipio_ibge%type;
cd_municipio_ibge_ww   	  w_esus_vacinacao.cd_municipio_ibge%type;
nr_seq_lote_envio_w 	  w_esus_vacinacao.nr_seq_lote_envio%type;
nr_seq_ficha_w            w_esus_vacinacao.nr_seq_ficha%type;
cd_cns_paciente_w     	  w_esus_vacinacao.cd_cns_paciente%type;
dt_nascimento_paciente_w  w_esus_vacinacao.dt_nascimento_paciente%type;
ie_sexo_paciente_w 		  w_esus_vacinacao.ie_sexo_paciente%type;
cd_cns_profissional_w  	  w_esus_vacinacao.cd_cns_profissional%type;
nr_data_atendimento_w     w_esus_vacinacao.nr_data_atendimento%type;
nr_data_nasc_pac_w        w_esus_vacinacao.nr_data_nasc_pac%type;
ie_hanseniase_w           w_esus_vacinacao.ie_hanseniase%type;
dt_final_atendimento_w	  w_esus_vacinacao.dt_final_atendimento%type;
nr_data_final_atend_w	  w_esus_vacinacao.nr_data_final_atend%type;

cd_contra_chave_rem_w	  w_esus_header_footer.cd_contra_chave_rem%type;
cd_uuid_instal_rem_w	  w_esus_header_footer.cd_uuid_instal_rem%type;
cd_contra_chave_ori_w	  w_esus_header_footer.cd_contra_chave_ori%type;
cd_uuid_instal_orig_w	  w_esus_header_footer.cd_uuid_instal_orig%type;

Vacinacao CURSOR FOR
	SELECT 	nr_sequencia,
			cd_estabelecimento,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_profissional,
			cd_pessoa_fisica,
			cd_cbo_profissional,
			ie_turno,
			cd_cnes_unidade,
			nr_seq_sus_equipe,
			nr_prontuario,
			ie_local_atendimento,
			dt_atendimento,			
			CASE WHEN ie_gestante='S' THEN  'true'  ELSE 'false' END  ie_gestante,
			nr_atendimento,
			dt_liberacao,
			cd_uuid_original,
			cd_pessoa_digitacao,
			cd_pessoa_conferen,
			nr_seq_lote_envio,			
			CASE WHEN ie_viajante='S' THEN  'true'  ELSE 'false' END  ie_viajante,
			CASE WHEN ie_puerpera='S' THEN  'true'  ELSE 'false' END  ie_puerpera,
			dt_final_atendimento
	from	esus_vacinacao
	where	nr_seq_lote_envio =	nr_seq_lote_p
	order by nr_sequencia;
	
VacinacaoItem CURSOR FOR
	SELECT  nr_sequencia,
			dt_atualizacao,
			nm_usuario,           
			dt_atualizacao_nrec,  
			nm_usuario_nrec,      
			nr_seq_vacinacao,     
			cd_imunobiologico,    
			cd_estrategia,        
			cd_dose,              
			ds_lote_vacina,
			ds_fabricante,			
			CASE WHEN ie_comunic_hansen='S' THEN  'true'  ELSE 'false' END  ie_comunic_hansen
	from 	esus_vacinacao_item
	where	nr_seq_vacinacao = nr_seq_ficha_w
	order by nr_sequencia;
	
type 		fetch_array is table of Vacinacao%rowtype;
s_array 	fetch_array;
i			integer := 1;
type vetor is table of fetch_array index by integer;
vetor_Vacinacao_w			vetor;

vacinacaoItem_w			VacinacaoItem%rowtype;
	
BEGIN

delete 	from w_esus_vacinacao_item
where	nr_seq_w_vacinacao in (SELECT nr_sequencia from w_esus_vacinacao where	nr_seq_lote_envio = nr_seq_lote_p);

delete 	from w_esus_vacinacao
where	nr_seq_lote_envio = nr_seq_lote_p;

open Vacinacao;
loop
fetch Vacinacao bulk collect into s_array limit 1000;
	vetor_Vacinacao_w(i) := s_array;
	i := i + 1;
EXIT WHEN NOT FOUND; /* apply on Vacinacao */
end loop;
close Vacinacao;

for i in 1..vetor_Vacinacao_w.count loop
	begin
	s_array := vetor_Vacinacao_w(i);
	for z in 1..s_array.count loop
		begin
		nr_seq_vacinacao_w 	  	  := null;
		cd_estabelecimento_w  	  := s_array[z].cd_estabelecimento;
		dt_atualizacao_w		  := s_array[z].dt_atualizacao;
		nm_usuario_w			  := s_array[z].nm_usuario;
		dt_atendimento_w		  := s_array[z].dt_atendimento;
		dt_atualizacao_nrec_w     := s_array[z].dt_atualizacao_nrec;
		nm_usuario_nrec_w 	   	  := s_array[z].nm_usuario_nrec;
		cd_cbo_prof_w		   	  := s_array[z].cd_cbo_profissional;
		cd_profissional_w		  := s_array[z].cd_profissional;
		nr_seq_sus_equipe_w		  := s_array[z].nr_seq_sus_equipe;
		cd_pessoa_fisica_w	  	  := s_array[z].cd_pessoa_fisica;
		ie_turno_atendimento_w 	  := s_array[z].ie_turno;
		nr_prontuario_w 	      := s_array[z].nr_prontuario;
		cd_cnes_unidade_w      	  := s_array[z].cd_cnes_unidade;
		ie_local_atendimento_w    := s_array[z].ie_local_atendimento;
		ie_gestante_w          	  := s_array[z].ie_gestante;
		nr_atendimento_w	   	  := s_array[z].nr_atendimento;
		ie_viajante_w	      	  := s_array[z].ie_viajante;
		ie_puerpera_w	       	  := s_array[z].ie_puerpera;
		cd_uuid_original_w   	  := s_array[z].cd_uuid_original;
		cd_municipio_ibge_w   	  := null;
		nr_seq_lote_envio_w 	  := s_array[z].nr_seq_lote_envio;
		nr_seq_ficha_w            := s_array[z].nr_sequencia; -- nr_sequencia da tabela vacinacao  
		cd_cns_paciente_w     	  := null;
		dt_nascimento_paciente_w  := null;
		ie_sexo_paciente_w 		  := null;
		cd_cns_profissional_w     := null;
		nr_data_atendimento_w     := null;
		nr_data_nasc_pac_w        := null;
		dt_final_atendimento_w	  := s_array[z].dt_final_atendimento;
		
		if (coalesce(cd_pessoa_fisica_w,'X') <> 'X') then
			begin
			cd_cns_paciente_w			:= substr(obter_dados_pf(cd_pessoa_fisica_w,'CNS'),1,20);
			dt_nascimento_paciente_w	:= to_date(substr(obter_dados_pf(cd_pessoa_fisica_w,'DN'),1,10),'dd/mm/yyyy');
			ie_sexo_paciente_w			:= substr(sus_gerar_depara_esus(obter_dados_pf(cd_pessoa_fisica_w,'SE'),'SEXO'),1,20);
			end;
		end if;	

		select max(CASE WHEN ie_comunic_hansen='S' THEN  'true'  ELSE 'false' END )
		into STRICT   ie_hanseniase_w
		from   esus_vacinacao_item
		where  nr_Seq_vacinacao = nr_seq_ficha_w;
		
		cd_cns_profissional_w		:= substr(obter_dados_pf(cd_profissional_w,'CNS'),1,20);		
		cd_municipio_ibge_ww		:= obter_compl_pf(cd_pessoa_fisica_w, 1, 'CDM');
		cd_municipio_ibge_w			:= substr(cd_municipio_ibge_ww||Calcula_Digito('MODULO10',cd_municipio_ibge_ww),1,7);
			
		select	nextval('w_esus_vacinacao_seq')
		into STRICT	nr_seq_vacinacao_w
		;		
		
		if (dt_nascimento_paciente_w IS NOT NULL AND dt_nascimento_paciente_w::text <> '') then
			nr_data_nasc_pac_w :=  esus_converte_data(dt_nascimento_paciente_w);
		else
			nr_data_nasc_pac_w := null;
		end if;
		
		if (dt_atendimento_w IS NOT NULL AND dt_atendimento_w::text <> '') then
			nr_data_atendimento_w :=  esus_converte_data(dt_atendimento_w);
		else
			nr_data_atendimento_w := null;
		end if;

		if (dt_final_atendimento_w IS NOT NULL AND dt_final_atendimento_w::text <> '') then
			nr_data_final_atend_w :=  esus_converte_data(dt_final_atendimento_w);
		else
			nr_data_final_atend_w := null;
		end if;
		
		select	coalesce(max(cd_cnes_unidade),'0')
		into STRICT	cd_cnes_unidade_ww
		from	w_esus_header_footer
		where	nr_seq_lote_envio = nr_seq_lote_p;
		
		if (cd_cnes_unidade_w <> cd_cnes_unidade_ww) then
			begin
			cd_contra_chave_rem_w	:= substr(sus_gerar_uuid_esus(cd_cnes_unidade_w,'C'),1,50);
			cd_uuid_instal_rem_w	:= substr(sus_gerar_uuid_esus(cd_cnes_unidade_w,'U'),1,50);
			cd_contra_chave_ori_w	:= cd_contra_chave_rem_w;
			cd_uuid_instal_orig_w	:= cd_uuid_instal_rem_w;			
			cd_municipio_ibge_ww	:= sus_obter_dados_equipe(nr_seq_sus_equipe_w,'CM');
			cd_municipio_ibge_ww	:= substr(cd_municipio_ibge_ww||Calcula_Digito('MODULO10',cd_municipio_ibge_ww),1,7);
			
			update 	w_esus_header_footer
			set 	cd_cnes_unidade 	= cd_cnes_unidade_w,
					cd_cnes_serealizado = cd_cnes_unidade_w,
					cd_contra_chave_rem = cd_contra_chave_rem_w,
					cd_uuid_instal_rem 	= cd_uuid_instal_rem_w,
					cd_contra_chave_ori = cd_contra_chave_ori_w,
					cd_uuid_instal_orig = cd_uuid_instal_orig_w,
					cd_municipio_ibge 	= cd_municipio_ibge_ww
			where	nr_seq_lote_envio 	= nr_seq_lote_p;
			
			end;
		end if;	
		
		if (coalesce(cd_uuid_original_w,'X') = 'X')  then
			begin
			cd_uuid_original_w := coalesce(sus_gerar_uuid_esus(cd_cnes_unidade_w,'U'),'0');
			
			update 	esus_vacinacao 	
			set 	cd_uuid_original = cd_uuid_original_w
			where 	nr_sequencia = nr_seq_ficha_w;
			end;
		end if;	
				
		insert into w_esus_vacinacao(			
					nr_sequencia,
					cd_estabelecimento,
					dt_atualizacao,
					nm_usuario,
					dt_atendimento,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					cd_cbo_prof,
					cd_profissional,
					nr_seq_sus_equipe,
					cd_pessoa_fisica,
					ie_turno_atendimento,
					nr_prontuario,
					cd_cnes_unidade,
					ie_local_atendimento,
					ie_gestante,
					nr_atendimento,
					ie_viajante,
					ie_puerpera,
					cd_uuid_original,
					cd_municipio_ibge,
					nr_seq_lote_envio,
					nr_seq_ficha,
					cd_cns_paciente,
					dt_nascimento_paciente,
					ie_sexo_paciente,
					cd_cns_profissional,
					nr_data_atendimento,
					nr_data_nasc_pac,
					ie_hanseniase,
					dt_final_atendimento,
					nr_data_final_atend
		) values (		
					nr_seq_vacinacao_w,           
					cd_estabelecimento_w, 
					clock_timestamp(),
					nm_usuario_p,
					dt_atendimento_w,
					clock_timestamp(),
					nm_usuario_p,
					cd_cbo_prof_w,
					cd_profissional_w,
					nr_seq_sus_equipe_w,
					cd_pessoa_fisica_w,
					ie_turno_atendimento_w,
					nr_prontuario_w,
					cd_cnes_unidade_w,
					ie_local_atendimento_w,
					ie_gestante_w,
					nr_atendimento_w,
					ie_viajante_w,
					ie_puerpera_w,
					cd_uuid_original_w,
					cd_municipio_ibge_w,
					nr_seq_lote_envio_w,
					nr_seq_ficha_w,
					cd_cns_paciente_w,
					dt_nascimento_paciente_w,
					ie_sexo_paciente_w,
					cd_cns_profissional_w,
					nr_data_atendimento_w,
					nr_data_nasc_pac_w,
					ie_hanseniase_w,
					dt_final_atendimento_w,
					nr_data_final_atend_w
		);
		
		open VacinacaoItem;
		loop
		fetch VacinacaoItem into vacinacaoItem_w;
		EXIT WHEN NOT FOUND; /* apply on VacinacaoItem */
		
			insert into w_esus_vacinacao_item(
						nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_seq_w_vacinacao,
						nr_seq_vacinacao,
						cd_imunobiologico,
						cd_estrategia,
						cd_dose,
						ds_lote_vacina,
						ds_fabricante,
						ie_comunic_hansen,
						nr_seq_vacinacao_item
			) values (
						nextval('w_esus_vacinacao_item_seq'),
						vacinacaoItem_w.dt_atualizacao,
						vacinacaoItem_w.nm_usuario, 
						vacinacaoItem_w.dt_atualizacao_nrec,
						vacinacaoItem_w.nm_usuario_nrec,
						nr_seq_vacinacao_w,
						nr_seq_ficha_w,
						vacinacaoItem_w.cd_imunobiologico,
						vacinacaoItem_w.cd_estrategia,
						vacinacaoItem_w.cd_dose,
						vacinacaoItem_w.ds_lote_vacina,
						vacinacaoItem_w.ds_fabricante,
						vacinacaoItem_w.ie_comunic_hansen,
						vacinacaoItem_w.nr_sequencia
			);
			
		end loop;		
		close VacinacaoItem;		

		end;
	end loop;
	end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_gerar_w_esus_vacinacao ( nr_seq_lote_p esus_lote_envio.nr_sequencia%type, ie_tipo_lote_esus_p esus_lote_envio.ie_tipo_lote_esus%type, cd_cnes_estab_p estabelecimento.cd_cns%type, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

