-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_vol_inf_prescr_dia ( nr_prescricao_p bigint, qt_vol_inf_sol_p INOUT bigint, qt_vol_inf_medic_p INOUT bigint, qt_vol_inf_total_p INOUT bigint) AS $body$
DECLARE


cd_pessoa_fisica_w		varchar(10);
dt_inicio_prescr_w		timestamp;
dt_validade_prescr_w	timestamp;
nr_ocorrencia_w			double precision;
qt_vol_medic_w			double precision;
qt_vol_inf_medic_w		double precision := 0;

C01 CURSOR FOR
SELECT	coalesce(
				CASE WHEN upper(a.cd_unidade_medida_dose)=upper(obter_unid_med_usua('ML')) THEN 						a.qt_dose  ELSE coalesce(a.qt_solucao,							coalesce(obter_conversao_ml(a.cd_material,a.qt_dose,a.cd_unidade_medida_dose),0)							+coalesce(obter_vol_diluente_medicamento(a.nr_prescricao, a.nr_sequencia),0)							+coalesce(Obter_dose_dil_rec_medic(a.nr_prescricao, a.nr_sequencia),0)) END
		,0),
--select	nvl(nvl(a.qt_solucao,decode(obter_conversao_ml(a.cd_material,a.qt_dose,a.cd_unidade_medida_dose),0,0,obter_conversao_ml(a.cd_material,a.qt_dose,a.cd_unidade_medida_dose))+nvl(obter_vol_diluente_medicamento(a.nr_prescricao, a.nr_sequencia),0)+nvl(Obter_dose_dil_rec_medic(a.nr_prescricao, a.nr_sequencia),0)),0),
		coalesce(a.nr_ocorrencia,1)
from	prescr_material a,
		prescr_medica b
where	a.nr_prescricao	= b.nr_prescricao
and		b.cd_pessoa_fisica = cd_pessoa_fisica_w
and		b.nr_prescricao = nr_prescricao_p
and		b.dt_inicio_prescr between dt_inicio_prescr_w and dt_validade_prescr_w
and		a.ie_agrupador = 1
and		coalesce(a.cd_kit_material,coalesce(a.nr_sequencia_solucao,coalesce(a.nr_sequencia_diluicao,coalesce(a.nr_sequencia_dieta,0)))) = 0
and		upper(a.ie_via_aplicacao) = upper(obter_Via_usuario('IV'));


BEGIN

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then

	select	max(cd_pessoa_fisica),
			max(dt_inicio_prescr),
			max(dt_validade_prescr)
	into STRICT	cd_pessoa_fisica_w,
			dt_inicio_prescr_w,
			dt_validade_prescr_w
	from	prescr_medica
	where	nr_prescricao = nr_prescricao_p;

	select	coalesce(sum(coalesce(qt_solucao_total,0)),0)
	into STRICT	qt_vol_inf_sol_p
	from	prescr_solucao a,
			prescr_medica b
	where	a.nr_prescricao	= b.nr_prescricao
	and		b.cd_pessoa_fisica = cd_pessoa_fisica_w
	and		b.nr_prescricao = nr_prescricao_p
	and		b.dt_inicio_prescr between dt_inicio_prescr_w and dt_validade_prescr_w
	and		upper(a.ie_via_aplicacao) = upper(obter_Via_usuario('IV'));

	open C01;
	loop
	fetch C01 into
		qt_vol_medic_w,
		nr_ocorrencia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */

		qt_vol_inf_medic_w := qt_vol_inf_medic_w + (nr_ocorrencia_w * qt_vol_medic_w);

	end loop;
	close C01;

	qt_vol_inf_medic_p := qt_vol_inf_medic_w;

	qt_vol_inf_total_p	:= qt_vol_inf_sol_p + qt_vol_inf_medic_p;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_vol_inf_prescr_dia ( nr_prescricao_p bigint, qt_vol_inf_sol_p INOUT bigint, qt_vol_inf_medic_p INOUT bigint, qt_vol_inf_total_p INOUT bigint) FROM PUBLIC;

