-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE carrega_lista_mat_disp_elet ( cd_setor_atendimento_p bigint, cd_local_estoque_p bigint, ds_observacao_p text, nm_usuario_p text, nr_seq_arquivo_p bigint default null) AS $body$
DECLARE

 
 
dt_entrada_Unidade_w		timestamp;
cd_unidade_medida_consumo_w	varchar(15);
nr_seq_atepacu_w			bigint;
nr_sequencia_w			bigint;
nr_atendimento_w			bigint;
cd_material_w			bigint;
cd_material_generico_w		bigint;
qt_material_w			double precision;
cd_estabelecimento_w		smallint;
cd_material_estoque_w		integer;
ds_material_w			varchar(60);
qt_saldo_w			double precision;
ie_sem_saldo_w			varchar(1);
ie_local_w			varchar(1);
ie_lib_local_w			varchar(1);
ds_local_estoque_w		varchar(80);
cd_setor_w			bigint;
cd_local_estoque_w		bigint;
dt_alta_atendimento_w		timestamp;	
dt_atendimento_w		timestamp := clock_timestamp();
ie_util_data_alta_w		varchar(1);
ie_opcao_arq_w			varchar(1) := 'C';

qt_registro_w		bigint;
	
c01 CURSOR FOR 
SELECT	nr_sequencia, 
	nr_atendimento, 
	cd_material, 
	qt_material, 
	cd_setor, 
	ds_setor 
from	w_dispensario_auto 
where	ie_lido		= 'N' 
and (nr_seq_arquivo = nr_seq_arquivo_p or coalesce(nr_seq_arquivo_p::text, '') = '');

 

BEGIN 
 
/*Esta procedure trata fixo o material executado como o mesmo material do arquivo, e não trata lote de fornecedor 
conforme definido na OS175964*/
 
 
ie_sem_saldo_w	:= 'N';
ie_lib_local_w	:= 'S';
 
/*ROTINA ESPECIFICA PARA CONSISTENCIA*/
 
open C01;
loop 
fetch C01 into 
	nr_sequencia_w, 
	nr_atendimento_w, 
	cd_material_w, 
	qt_material_w, 
	cd_setor_w, 
	ie_opcao_arq_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
 
	begin 
	select	cd_local_estoque 
	into STRICT	cd_local_estoque_w 
	from	setor_atendimento 
	where	cd_setor_atendimento = cd_setor_w;
	exception 
		when no_data_found then 
		CALL wheb_mensagem_pck.exibir_mensagem_abort(265932);
		--'Para este setor não existe local de estoque' 
	end;
		 
	select	cd_estabelecimento, 
		ds_local_estoque 
	into STRICT	cd_estabelecimento_w, 
		ds_local_estoque_w 
	from	local_estoque 
	where	cd_local_estoque = cd_local_estoque_w;
 
	select	cd_material_estoque, 
		substr(ds_material,1,60) 
	into STRICT	cd_material_estoque_w, 
		ds_material_w 
	from	material 
	where	cd_material	= cd_material_w;
	 
	select	obter_saldo_disp_estoque( 
			cd_estabelecimento_w, 
			cd_material_estoque_w, 
 		   	cd_local_estoque_w, 
			trunc(clock_timestamp(),'mm')) 
	into STRICT	qt_saldo_w 
	;
 
	if (qt_saldo_w < qt_material_w) then 
		ie_sem_saldo_w	:= 'S';
		CALL wheb_mensagem_pck.exibir_mensagem_abort(265933,	'CD_MATERIAL=' || cd_material_w || 
								';DS_MATERIAL=' || ds_material_w || 
								';QT_SALDO=' || qt_saldo_w || 
								';QT_MATERIAL=' || qt_material_w || 
								';CD_LOCAL_ESTOQUE=' || cd_local_estoque_w || 
								';DS_LOCAL_ESTOQUE=' || ds_local_estoque_w);
	end if;
 
 
	ie_local_w := OBTER_LOCAL_VALIDO( 
			cd_estabelecimento_w, cd_local_estoque_w, cd_material_w, '11', ie_local_w);
	if (ie_local_w <> 'S') then	/*Se não tiver liberado, verifico tambem o generico do mesmo*/
 
		begin 
 
		select	coalesce(cd_material_generico, cd_material) 
		into STRICT	cd_material_generico_w 
		from	material 
		where	cd_material	= cd_material_w;
 
		ie_local_w := OBTER_LOCAL_VALIDO( 
				cd_estabelecimento_w, cd_local_estoque_w, cd_material_generico_w, '11', ie_local_w);
		if (ie_local_w <> 'S') then 
			ie_lib_local_w	:= 'N';
			CALL wheb_mensagem_pck.exibir_mensagem_abort(265948,'CD_MATERIAL=' || cd_material_w || 
								';DS_MATERIAL=' || ds_material_w || 
								';CD_LOCAL_ESTOQUE=' || cd_local_estoque_w || 
								';DS_LOCAL_ESTOQUE=' || ds_local_estoque_w);
			--'Material não liberado: (Padrões/Liberação na administração de estoques)' || chr(13) || chr(10) || 
			--cd_material_w || ' - ' || ds_material_w || chr(13) || chr(10) || 
			--'Local = ' || cd_local_estoque_w || ds_local_estoque_w); 
		end if;
		end;
	end if;
 
 
	end;
end loop;
close c01;
 
 
 
/*sE TODOS OS ITENS TIVEREM SALDO - O SISTEMA FARA AS BAIXAS*/
 
if (ie_sem_saldo_w = 'N') and (ie_lib_local_w = 'S') then 
	begin 
 
	ie_util_data_alta_w := obter_param_usuario(147, 10, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_util_data_alta_w);	
	 
	open C01;
	loop 
	fetch C01 into 
		nr_sequencia_w, 
		nr_atendimento_w, 
		cd_material_w, 
		qt_material_w, 
		cd_setor_w, 
		ie_opcao_arq_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin 
 
		select	coalesce(max(a.dt_entrada_unidade), clock_timestamp()) 
		into STRICT	dt_entrada_Unidade_w 
		from	tipo_acomodacao b, 
			setor_atendimento c, 
			atend_paciente_unidade a 
		where	a.cd_tipo_acomodacao	= b.cd_tipo_acomodacao 
		and	a.cd_setor_atendimento	= c.cd_setor_atendimento 
		and	c.cd_classif_setor	in ('3','1') 
		and	a.nr_atendimento	= nr_atendimento_w;
 
		select	max(a.nr_seq_interno) 
		into STRICT	nr_seq_atepacu_w 
		from	tipo_acomodacao b, 
			setor_atendimento c, 
			atend_paciente_unidade a 
		where	a.cd_tipo_acomodacao	= b.cd_tipo_acomodacao 
		and	a.cd_setor_atendimento	= c.cd_setor_atendimento 
		and	a.dt_entrada_unidade	= dt_entrada_Unidade_w 
		and  	a.nr_atendimento	= nr_atendimento_w;
 
		select	substr(obter_dados_material_estab(cd_material,cd_estabelecimento_w,'UMS'),1,30) cd_unidade_medida_consumo, 
			cd_material_estoque 
		into STRICT	cd_unidade_medida_consumo_w, 
			cd_material_estoque_w 
		from	material 
		where	cd_material	= cd_material_w;
 
 
		select	cd_estabelecimento 
		into STRICT	cd_estabelecimento_w 
		from	local_estoque 
		where	cd_local_estoque = cd_local_estoque_w;
 
 
		select	obter_saldo_disp_estoque( 
			cd_estabelecimento_w, 
			cd_material_estoque_w, 
 		   	cd_local_estoque_w, 
			trunc(clock_timestamp(),'mm')) 
		into STRICT	qt_saldo_w 
		;
 
		select	obter_data_alta_atendimento(nr_atendimento_w) 
		into STRICT	dt_alta_atendimento_w 
		;
		 
		if (ie_util_data_alta_w = 'S') and (dt_alta_atendimento_w IS NOT NULL AND dt_alta_atendimento_w::text <> '') then 
			dt_atendimento_w := dt_alta_atendimento_w;
			 
		end if;
 
		CALL inserir_mat_atend_pac_disp( 
			nr_atendimento_w, 
			dt_entrada_Unidade_w, 
			dt_atendimento_w, 
			cd_unidade_medida_consumo_w, 
			qt_material_w, 
			cd_material_w, 
			cd_material_w, 
			null, 
			cd_setor_w, 
			cd_local_estoque_w, 
			qt_material_w, 
			null, 
			ds_observacao_p, 
			nm_usuario_p, 
			ie_opcao_arq_w, 
			nr_seq_atepacu_w);
 
		update	w_dispensario_auto 
		set	ie_lido	= 'S' 
		where	nr_sequencia	= nr_sequencia_w 
		and	ie_lido		= 'N';
 
		end;
	end loop;
	close c01;
	 
	if (nr_seq_arquivo_p IS NOT NULL AND nr_seq_arquivo_p::text <> '') then 
		select	count(1) 
		into STRICT	qt_registro_w 
		from	w_dispensario_auto 
		where	nr_seq_arquivo	= nr_seq_arquivo_p 
		and		coalesce(ie_lido,'N') = 'N';
		 
		if (qt_registro_w = 0) then 
			update	w_arq_dispensario_auto 
			set		ie_lido	= 'S' 
			where	nr_sequencia	= nr_seq_arquivo_p;
		end if;
	end if;
	 
	 
	end;
end if;
 
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE carrega_lista_mat_disp_elet ( cd_setor_atendimento_p bigint, cd_local_estoque_p bigint, ds_observacao_p text, nm_usuario_p text, nr_seq_arquivo_p bigint default null) FROM PUBLIC;

