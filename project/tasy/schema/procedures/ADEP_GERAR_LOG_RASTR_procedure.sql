-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE adep_gerar_log_rastr ( ds_log_p text, ie_commit_p text default null) AS $body$
DECLARE



ie_tipo_processo_w rastreabilidade_adep.ie_tipo_processo%type;
qt_dias_permanencia_w rastreabilidade_adep.qt_dias_permanencia%type;
ie_deletar_log_w varchar(1);
ie_commit_w		varchar(1);


BEGIN

if (clock_timestamp() between trunc(clock_timestamp(),'dd') + 3/24 and trunc(clock_timestamp(), 'dd') + 4/24) then
    select  coalesce(max('S'), 'N')
    into STRICT    ie_deletar_log_w
    from    log_adep a
    where   a.dt_exclusao < clock_timestamp();

    if (ie_deletar_log_w = 'S') then
        delete  from log_adep a
        where   a.dt_exclusao < clock_timestamp()  LIMIT 99999;
    end if;
end if;

select  max(a.ie_tipo_processo),
        coalesce(max(qt_dias_permanencia), 7)
into STRICT    ie_tipo_processo_w,
        qt_dias_permanencia_w
from    rastreabilidade_adep a
where   a.nr_sequencia = wheb_assist_pck.obter_seq_rastr_adep;

insert into log_adep( nr_sequencia,
                       dt_atualizacao,
                       dt_exclusao,
                       nm_usuario,
                       cd_perfil,
                       cd_estabelecimento,
                       cd_funcao,
                       nr_prescricao,
                       ie_tipo_processo,
                       ds_log,
                       ds_stack )
                       values ( nextval('log_adep_seq'),
                       clock_timestamp(),
                       trunc(clock_timestamp(),'dd') + qt_dias_permanencia_w,
                       wheb_usuario_pck.get_nm_usuario,
                       wheb_usuario_pck.get_cd_perfil,
                       wheb_usuario_pck.get_cd_estabelecimento,
                       wheb_usuario_pck.get_cd_funcao,
                       wheb_assist_pck.obter_prescr_rastr_adep,
                       ie_tipo_processo_w,
                       substr(ds_log_p,1,4000),
                       substr(dbms_utility.format_call_stack,1,2000) );

if (coalesce(ie_commit_p::text, '') = '') then
	ie_commit_w	:= wheb_usuario_pck.get_ie_commit;
end if;

if (coalesce(ie_commit_w, 'S') = 'S' and
	coalesce(ie_commit_p, 'S') <> 'N') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE adep_gerar_log_rastr ( ds_log_p text, ie_commit_p text default null) FROM PUBLIC;

