-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_alterar_prior_analise_aut ( nr_seq_analise_p bigint, nr_seq_prioridade_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Alterar a prioridade da analise de autorizacao
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  ]  Objetos do dicionario [ X ] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao:
-------------------------------------------------------------------------------------------------------------------

Referencias:
	OPS - Gestaode Analise de Autorizacoes 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
ie_prioridade_w		pls_prioridade_analise_aut.ie_prioridade%type;
ds_prioridade_w		pls_prioridade_analise_aut.ds_prioridade%type;
ds_historico_w		varchar(2000);
nr_seq_guia_w		pls_auditoria.nr_seq_guia%type;
nr_seq_requisicao_w	pls_auditoria.nr_seq_requisicao%type;
nr_seq_execucao_w	pls_auditoria.nr_seq_execucao%type;


BEGIN

if (nr_seq_analise_p IS NOT NULL AND nr_seq_analise_p::text <> '') then
	select	max(a.ie_prioridade),
		max(a.ds_prioridade)
	into STRICT	ie_prioridade_w,
		ds_prioridade_w
	from	pls_prioridade_analise_aut	a
	where	a.nr_sequencia	= nr_seq_prioridade_p;

	update	pls_auditoria
	set	nr_seq_prioridade_analise	= nr_seq_prioridade_p,
		ie_prioridade			= ie_prioridade_w,
		ie_prioridade_manual	= 'S'
	where	nr_sequencia		= nr_seq_analise_p;

	begin
	select	nr_seq_guia,
		nr_seq_requisicao,
		nr_seq_execucao
	into STRICT	nr_seq_guia_w,
		nr_seq_requisicao_w,
		nr_seq_execucao_w
	from	pls_auditoria
	where	nr_sequencia	= nr_seq_analise_p;
	exception
	when others then
		nr_seq_guia_w		:= 0;
		nr_seq_requisicao_w	:= 0;
		nr_seq_execucao_w	:= 0;
	end;

	if (coalesce(nr_seq_prioridade_p,0) <> 0) then
		ds_historico_w	:= 'O auditor ' || pls_obter_nome_usuario(nm_usuario_p) || ' alterou a prioridade para: ' || ie_prioridade_w || ' - ' || ds_prioridade_w;
	else
		ds_historico_w	:= 'O auditor ' || pls_obter_nome_usuario(nm_usuario_p) || ' alterou para nenhuma prioridade';
	end if;

	if (coalesce(nr_seq_guia_w,0) <> 0) then
		CALL pls_guia_gravar_hist_analise(nr_seq_guia_w, null, null, ds_historico_w, null, nm_usuario_p);
	elsif (coalesce(nr_seq_requisicao_w,0) <> 0) then
		CALL pls_req_gravar_hist_analise(nr_seq_requisicao_w, null, 'L', ds_historico_w, null, nm_usuario_p);
	elsif (coalesce(nr_seq_execucao_w,0) <> 0) then
		select	nr_seq_requisicao
		into STRICT	nr_seq_requisicao_w
		from	pls_execucao_requisicao
		where	nr_sequencia	= nr_seq_execucao_w;	

		CALL pls_req_gravar_hist_analise(nr_seq_requisicao_w, null, 'L', ds_historico_w, nr_seq_execucao_w, nm_usuario_p);
	end if;

	commit;
	
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_alterar_prior_analise_aut ( nr_seq_analise_p bigint, nr_seq_prioridade_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

