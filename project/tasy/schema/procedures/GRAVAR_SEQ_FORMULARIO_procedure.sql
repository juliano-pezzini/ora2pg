-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gravar_seq_formulario (nr_atendimento_p bigint ,cd_pessoa_fisica_p bigint ,nr_seq_template_p bigint ,nr_seq_reg_template_p bigint) AS $body$
DECLARE

  ds_update_w varchar(1000);

  c_ehr_registro CURSOR FOR
    SELECT t.nr_sequencia
          ,t.nr_seq_reg
          ,t.dt_registro
      FROM ehr_reg_template t
     WHERE t.nr_sequencia = nr_seq_reg_template_p;

  c_tabelas CURSOR FOR
    SELECT b.nr_sequencia
          ,b.nm_table
      FROM ehr_template_conteudo a
          ,linked_data           b
     WHERE a.nr_seq_linked_data = b.nr_sequencia
       AND a.nr_seq_template = nr_seq_template_p
       AND coalesce(b.ie_readonly, 'N') = 'N'

     
UNION
 
      
    SELECT DISTINCT b.nr_sequencia
                   ,b.nm_table
      FROM ehr_template_conteudo a
          ,linked_data           b
     WHERE a.nr_seq_linked_data = b.nr_sequencia
       AND a.nr_seq_template IN (SELECT a.nr_seq_template_cluster
                                   FROM ehr_template_conteudo a
                                  WHERE a.nr_seq_template = nr_seq_template_p)
       AND coalesce(b.ie_readonly, 'N') = 'N';
  r_pedido RECORD;
  r_lab RECORD;

BEGIN
  FOR r_ehr_registro IN c_ehr_registro LOOP
    FOR r_tabelas IN c_tabelas LOOP
      IF r_tabelas.nm_table = 'MED_RECEITA' THEN -- 196
        UPDATE med_receita t
           SET t.nr_seq_formulario = r_ehr_registro.nr_seq_reg
         WHERE t.nm_usuario = wheb_usuario_pck.get_nm_usuario
           AND coalesce(t.nr_seq_formulario::text, '') = ''
           AND t.nr_atendimento_hosp = nr_atendimento_p
           AND t.dt_atualizacao >= r_ehr_registro.dt_registro;
      ELSIF (r_tabelas.nm_table = 'PEDIDO_EXAME_EXTERNO_ITEM') THEN -- 418
        FOR r_pedido IN (SELECT t.nr_sequencia
                           FROM pedido_exame_externo t
                          WHERE t.nm_usuario = wheb_usuario_pck.get_nm_usuario
                            AND coalesce(t.nr_seq_formulario::text, '') = ''
                            AND t.nr_atendimento = nr_atendimento_p
                            AND t.dt_atualizacao >= r_ehr_registro.dt_registro) LOOP
          UPDATE pedido_exame_externo_item t
             SET t.nr_seq_formulario = r_ehr_registro.nr_seq_reg
           WHERE t.nr_seq_pedido = r_pedido.nr_sequencia;

          UPDATE pedido_exame_externo t
             SET t.nr_seq_formulario = r_ehr_registro.nr_seq_reg
           WHERE t.nr_sequencia = r_pedido.nr_sequencia;
        END LOOP;
      ELSIF (r_tabelas.nm_table = 'EXAME_LAB_RESULT_ITEM') THEN -- 471
        FOR r_lab IN (SELECT t.nr_seq_resultado
                           FROM exame_lab_resultado t
                          WHERE t.nm_usuario = wheb_usuario_pck.get_nm_usuario
                            AND coalesce(t.nr_seq_formulario::text, '') = ''
                            AND t.nr_atendimento = nr_atendimento_p
                            AND t.dt_atualizacao >= r_ehr_registro.dt_registro) LOOP
          UPDATE exame_lab_result_item t
             SET t.nr_seq_formulario = r_ehr_registro.nr_seq_reg
           WHERE t.nr_seq_resultado = r_lab.nr_seq_resultado;

          UPDATE exame_lab_resultado t
             SET t.nr_seq_formulario = r_ehr_registro.nr_seq_reg
           WHERE t.nr_seq_resultado = r_lab.nr_seq_resultado;

        END LOOP;
      ELSIF (r_tabelas.nm_table = 'PACIENTE_EXAME' OR
             r_tabelas.nm_table = 'PACIENTE_TRANSFUSAO' OR 
             r_tabelas.nm_table = 'PACIENTE_AMPUTACAO' OR 
             r_tabelas.nm_table = 'PACIENTE_ACESSORIO' OR  
             r_tabelas.nm_table = 'HISTORICO_SAUDE_MULHER' OR 
             r_tabelas.nm_table = 'PACIENTE_VULNERABILIDADE' OR 
			 r_tabelas.nm_table = 'HISTORICO_SAUDE_TRATAMENTO' OR
             r_tabelas.nm_table = 'PLS_DECLARACAO_SEGURADO' OR
             r_tabelas.nm_table = 'ALERTA_ANESTESIA_APAE' OR
             r_tabelas.nm_table = 'PACIENTE_HIST_SOCIAL' OR
             r_tabelas.nm_table = 'PESSOA_FISICA_CONTA' OR
             r_tabelas.nm_table = 'PF_PROFISSIONAL' OR
			 r_tabelas.nm_table = 'CIRURGIA_TEC_ANESTESICA' OR
             r_tabelas.nm_table = 'PF_TIPO_DEFICIENCIA' OR
             r_tabelas.nm_table = 'PACIENTE_REP_PRESCRICAO' OR
             r_tabelas.nm_table = 'EXAME_FISICO_APAE' OR
			 r_tabelas.nm_table = 'POSICAO_CIRURGIA' OR
			 r_tabelas.nm_table = 'HISTORICO_SAUDE_INTERNACAO' OR
			 r_tabelas.nm_table = 'COMPL_PESSOA_FISICA' OR
             r_tabelas.nm_table = 'CIRURGIA_DESCRICAO' OR
             r_tabelas.nm_table = 'PACIENTE_HOME_CARE')THEN 
        ds_update_w := 'UPDATE ' || r_tabelas.nm_table || ' t
                           SET t.nr_seq_formulario = ' || r_ehr_registro.nr_seq_reg || '
                         WHERE t.nm_usuario = ''' || wheb_usuario_pck.get_nm_usuario || '''
                           AND t.nr_seq_formulario IS NULL
                           AND t.dt_atualizacao >= (SELECT t.dt_registro
                                                      FROM ehr_reg_template t
                                                     WHERE t.nr_sequencia = ' || r_ehr_registro.nr_sequencia || ')';
        EXECUTE ds_update_w;
      ELSE
        ds_update_w := 'UPDATE ' || r_tabelas.nm_table || ' t
                           SET t.nr_seq_formulario = ' || r_ehr_registro.nr_seq_reg || '
                         WHERE t.nm_usuario = ''' || wheb_usuario_pck.get_nm_usuario || '''
                           AND t.nr_seq_formulario IS NULL
                           AND t.nr_atendimento = ' || nr_atendimento_p || '
                           AND t.dt_atualizacao >= (SELECT t.dt_registro
                                                      FROM ehr_reg_template t
                                                     WHERE t.nr_sequencia = ' || r_ehr_registro.nr_sequencia || ')';
        EXECUTE ds_update_w;
      END IF;
    END LOOP;
  END LOOP;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gravar_seq_formulario (nr_atendimento_p bigint ,cd_pessoa_fisica_p bigint ,nr_seq_template_p bigint ,nr_seq_reg_template_p bigint) FROM PUBLIC;

