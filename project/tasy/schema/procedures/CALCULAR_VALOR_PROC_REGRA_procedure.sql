-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_valor_proc_regra ( nr_seq_regra_p bigint, nr_interno_conta_p bigint, nr_seq_proc_princ_p bigint, nm_usuario_p text, cd_setor_atendimento_p bigint, vl_procedimento_p INOUT bigint) AS $body$
DECLARE


cd_area_procedimento_w		bigint;
cd_especialidade_w		bigint;
cd_grupo_proc_w			bigint;
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
cd_grupo_material_w		smallint;
cd_subgrupo_material_w		smallint;
cd_classe_material_w		integer;
cd_material_w			integer;
vl_item_w			double precision;
vl_Acumulado_w			double precision;

cd_area_procedimento_crit_w	bigint;
cd_especialidade_crit_w		bigint;
cd_grupo_proc_crit_w		bigint;
cd_procedimento_crit_w		bigint;
ie_origem_proced_crit_w		bigint;
cd_grupo_material_crit_w	smallint;
cd_subgrupo_material_crit_w	smallint;
cd_classe_material_crit_w	integer;
cd_material_crit_w		integer;
pr_total_w			double precision;
pr_Aplicar_w			double precision;
ie_procedimento_crit_w		bigint;
ie_Material_crit_w		bigint;
nr_seq_proc_pacote_w		bigint;
nr_seq_proc_interno_crit_w	bigint;
nr_seq_proc_interno_w		bigint;
ie_somente_proc_princ_w		varchar(1);
cd_estabelecimento_w		smallint;
qt_item_w			double precision;

ie_aplica_regra_valor_tabela_w	varchar(1);
cd_categoria_w			varchar(10);
ie_tipo_atendimento_w		smallint;
vl_item_medico_w		double precision;
vl_item_custo_oper_w		double precision;
vl_item_filme_w			double precision;
vl_item_ww			double precision;
vl_participante_w		double precision;
nr_sequencia_w			bigint;

ie_consignado_crit_w		varchar(1);
ie_consignado_w			varchar(1);
ie_responsavel_credito_w	varchar(5);
vl_limite_w			regra_preco_proc_crit.vl_limite%type;
cd_convenio_w			regra_preco_proc_crit.cd_convenio%type;
vl_ajuste_w			double precision;
ie_somente_item_setor_w		regra_preco_proc.ie_somente_item_setor%type :='N';
nr_seq_criterio_w  regra_preco_proc_crit.nr_seq_criterio%type;
qt_proc_restricao_w             bigint;

c01 CURSOR FOR
SELECT 	e.cd_area_procedimento,
	e.cd_especialidade,
	e.cd_grupo_proc,
	a.cd_procedimento,
	a.ie_origem_proced,
	0,
	0,
	0,
	0,
	sum(a.vl_procedimento),
	sum(a.vl_medico),
	sum(a.vl_custo_operacional),
	sum(a.vl_materiais),
	sum(a.qt_procedimento),
	a.nr_seq_proc_pacote,
	a.nr_seq_proc_interno,
	'',
	a.ie_responsavel_credito,
	a.cd_convenio
from 	Estrutura_Procedimento_v e,
	procedimento_paciente a
where 	a.nr_interno_conta	= nr_interno_conta_p
  and	a.cd_procedimento		= e.cd_procedimento
  and	a.ie_origem_proced	= e.ie_origem_proced
  and 	ie_aplica_regra_valor_tabela_w = 'N'
  and   ((a.nr_sequencia = nr_seq_proc_princ_p AND ie_somente_proc_princ_w = 'S') or (ie_somente_proc_princ_w = 'N'))
  and 	coalesce(cd_motivo_exc_conta::text, '') = ''
  and	((ie_somente_item_setor_w ='N') or (a.cd_setor_atendimento = cd_setor_atendimento_p))
GROUP BY e.cd_area_procedimento, e.cd_especialidade, e.cd_grupo_proc, a.cd_procedimento, a.ie_origem_proced, 0, 0, 0, 0, a.nr_seq_proc_pacote, a.nr_seq_proc_interno, '', a.ie_responsavel_credito, a.cd_convenio

union

select 	0,
	0,
	0,
	0,
	0,
	e.cd_grupo_material,
	e.cd_subgrupo_material,
	e.cd_classe_material,
	a.cd_material,
	sum(a.vl_Material),
	0,
	0,
	0,
	sum(a.qt_material),
	a.nr_seq_proc_pacote,
	0,
	e.ie_consignado,
	a.ie_responsavel_credito,
	a.cd_convenio
from 	Estrutura_material_v e,
	Material_Atend_paciente  a
where 	nr_interno_conta	= nr_interno_conta_p
  and 	coalesce(cd_motivo_exc_conta::text, '') = ''
  and	a.cd_material	= e.cd_material
  and 	ie_aplica_regra_valor_tabela_w = 'N'
  and   ((a.nr_sequencia = nr_seq_proc_princ_p AND ie_somente_proc_princ_w = 'S') or (ie_somente_proc_princ_w = 'N'))
  and	((ie_somente_item_setor_w ='N') or (a.cd_setor_atendimento = cd_setor_atendimento_p))
group by	0,
		0,
		0,
		0,
		0,
		e.cd_grupo_material,
		e.cd_subgrupo_material,
		e.cd_classe_material,
		a.cd_material,
		a.nr_seq_proc_pacote, 0,
		e.ie_consignado,
		a.ie_responsavel_credito,
		a.cd_convenio
order by 1,2,3,4,5,6,7,8,9;


c09 CURSOR FOR
SELECT 	cd_area_procedimento,
	cd_especialidade,
	cd_grupo_proc,
	cd_procedimento,
	ie_origem_proced,
	cd_grupo_material,
	cd_subgrupo_material,
	cd_classe_material,
	cd_material,
	nr_seq_proc_interno,
	(coalesce(cd_area_procedimento,0) +
	coalesce(cd_especialidade,0) +
	coalesce(cd_grupo_proc,0) +
	coalesce(cd_procedimento,0) +
	coalesce(nr_seq_proc_interno,0)),
	coalesce(cd_grupo_material,0) +
	coalesce(cd_subgrupo_material,0) +
	coalesce(cd_classe_material,0) +
	coalesce(cd_material,0),
	pr_total,
	coalesce(ie_consignado,'2'),
	coalesce(a.vl_limite,0),
        a.nr_seq_criterio
from  	regra_preco_proc_crit a
where 	nr_seq_regra = nr_seq_regra_p
and 	coalesce(vl_item_w,0) between coalesce(a.vl_inicial, coalesce(vl_item_w,0)) and coalesce(a.vl_final, coalesce(vl_item_w,0))
and	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_w,0)) = coalesce(cd_estabelecimento_w,0)
and 	coalesce(a.ie_responsavel_credito, coalesce(ie_responsavel_credito_w,'0')) = coalesce(ie_responsavel_credito_w,'0')
and	((a.ie_pacote		= 'A') or
	 (a.ie_pacote		= 'S' AND nr_seq_proc_pacote_w IS NOT NULL AND nr_seq_proc_pacote_w::text <> '') or
	 ((a.ie_pacote		= 'N') and (coalesce(nr_seq_proc_pacote_w::text, '') = '')))
and	coalesce(a.cd_convenio, coalesce(cd_convenio_w, 0)) = coalesce(cd_convenio_w, 0)
order by 10, 11, 1,2,3,4,5,6,7,8,9;


c02 CURSOR FOR
SELECT 		a.nr_sequencia,
		e.cd_area_procedimento,
		e.cd_especialidade,
		e.cd_grupo_proc,
		a.cd_procedimento,
		a.ie_origem_proced,
		0,
		0,
		0,
		0,
		max(a.vl_procedimento),
		max(a.vl_medico),
		max(a.vl_custo_operacional),
		max(a.vl_materiais),
		max(a.qt_procedimento),
		a.nr_seq_proc_pacote,
		a.nr_seq_proc_interno,
		sum(c.vl_participante),
		'2',
		a.ie_responsavel_credito,
		a.cd_convenio
FROM estrutura_procedimento_v e, procedimento_paciente a
LEFT OUTER JOIN procedimento_participante c ON (a.nr_sequencia = c.nr_sequencia)
WHERE a.nr_interno_conta	= nr_interno_conta_p and a.cd_procedimento	= e.cd_procedimento  and a.ie_origem_proced	= e.ie_origem_proced and ie_aplica_regra_valor_tabela_w = 'S' and ((a.nr_sequencia = nr_seq_proc_princ_p AND ie_somente_proc_princ_w = 'S') or (ie_somente_proc_princ_w = 'N')) and coalesce(cd_motivo_exc_conta::text, '') = '' and ((ie_somente_item_setor_w ='N') or (a.cd_setor_atendimento = cd_setor_atendimento_p)) group by 	a.nr_sequencia,
		e.cd_area_procedimento,
		e.cd_especialidade,
		e.cd_grupo_proc,
		a.cd_procedimento,
		a.ie_origem_proced,
		0,
		0,
		0,
		0,
		a.nr_seq_proc_pacote,
		a.nr_seq_proc_interno,
		'',
		a.ie_responsavel_credito,
		a.cd_convenio

union all

select 		0,
		0,
		0,
		0,
		0,
		0,
		e.cd_grupo_material,
		e.cd_subgrupo_material,
		e.cd_classe_material,
		a.cd_material,
		sum(a.vl_Material),
		0,
		0,
		0,
		sum(a.qt_material),
		a.nr_seq_proc_pacote,
		0,
		0,
		coalesce(ie_consignado,'2'),
		a.ie_responsavel_credito,
		a.cd_convenio
from 	Estrutura_material_v e,
	Material_Atend_paciente  a
where 	nr_interno_conta	= nr_interno_conta_p
  and 	coalesce(cd_motivo_exc_conta::text, '') = ''
  and	a.cd_material	= e.cd_material
  and 	ie_aplica_regra_valor_tabela_w = 'S'
  and   ((a.nr_sequencia = nr_seq_proc_princ_p AND ie_somente_proc_princ_w = 'S') or (ie_somente_proc_princ_w = 'N'))
  and	((ie_somente_item_setor_w ='N') or (a.cd_setor_atendimento = cd_setor_atendimento_p))
group by	0,
		0,
		0,
		0,
		0,
		0,
		e.cd_grupo_material,
		e.cd_subgrupo_material,
		e.cd_classe_material,
		a.cd_material,
		a.nr_seq_proc_pacote, 0,
		coalesce(ie_consignado,'2'),
		a.ie_responsavel_credito,
		a.cd_convenio
order by 1,2,3,4,5,6,7,8,9;


BEGIN

select 	max(cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from 	conta_paciente
where 	nr_interno_conta = nr_interno_conta_p;

ie_somente_proc_princ_w		:= obter_valor_param_usuario(67,298, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w);
ie_aplica_regra_valor_tabela_w	:= obter_valor_param_usuario(67,358, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w);
vl_acumulado_w		:= 0;

select	coalesce(max(ie_somente_item_setor),'N')
into STRICT	ie_somente_item_setor_w
from	regra_preco_proc
where	nr_sequencia = nr_seq_regra_p;

OPEN C01;
LOOP
	FETCH C01 into
	 	cd_area_procedimento_w,
		cd_especialidade_w,
		cd_grupo_proc_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w,
		cd_material_w,
		vl_Item_w,
		vl_item_medico_w,
		vl_item_custo_oper_w,
		vl_item_filme_w,
		qt_item_w,
		nr_seq_proc_pacote_w,
		nr_seq_proc_interno_w,
		ie_consignado_w,
		ie_responsavel_credito_w,
		cd_convenio_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		pr_aplicar_w		:= 0;
                nr_seq_criterio_w       := 0;
		OPEN C09;
		LOOP
		FETCH C09 into
		 	cd_area_procedimento_crit_w,
			cd_especialidade_crit_w,
			cd_grupo_proc_crit_w,
			cd_procedimento_crit_w,
			ie_origem_proced_crit_w,
			cd_grupo_material_crit_w,
			cd_subgrupo_material_crit_w,
			cd_classe_material_crit_w,
			cd_material_crit_w,
			nr_seq_proc_interno_crit_w,
			ie_procedimento_crit_w,
			ie_Material_crit_w,
			pr_total_w,
			ie_consignado_crit_w,
			vl_limite_w,
                        nr_seq_criterio_w;
		EXIT WHEN NOT FOUND; /* apply on c09 */

                /*APLICA A REGRA PARA RESTRICAO DO CRITERIO*/

                if (coalesce(nr_seq_criterio_w,0) > 0) and (nr_seq_regra_p > 0) then
                        select  count(1)
                        into STRICT    qt_proc_restricao_w
                        from    regra_preco_proc_restricao a,
                                procedimento_paciente      b,
                                Estrutura_Procedimento_v   c
                        where   a.nr_seq_criterio               = nr_seq_criterio_w
                        and     a.nr_seq_regra                  = nr_seq_regra_p
                        and     b.nr_interno_conta              = nr_interno_conta_p
                        and     b.cd_procedimento               = c.cd_procedimento
                        and     b.ie_origem_proced              = c.ie_origem_proced
                        and     ((a.cd_area_procedimento = c.cd_area_procedimento)
                                or (a.cd_especialidade = c.cd_especialidade)
                                or (a.cd_grupo_proc    = c.cd_grupo_proc)
                                or ((a.cd_procedimento  = c.cd_procedimento) and (coalesce(a.ie_origem_proced,c.ie_origem_proced) = c.ie_origem_proced)))
                        and     a.ie_situacao = 'A';

                end if;

                if (qt_proc_restricao_w = 0) then
			if (cd_procedimento_w > 0) then
				if (ie_procedimento_crit_w > 0) 					and (cd_area_procedimento_crit_w	= cd_area_procedimento_w	or
					 cd_especialidade_crit_w	= cd_especialidade_w		or
					 cd_grupo_proc_crit_w		= cd_grupo_proc_w		or
					 cd_procedimento_crit_w		= cd_procedimento_w		or
					 nr_seq_proc_interno_crit_w	= nr_seq_proc_interno_w)	then
					 pr_aplicar_w	:= pr_total_w;
				end if;
			else
				if (ie_Material_crit_w > 0) 					and (cd_grupo_material_crit_w	= cd_grupo_material_w		or
					 cd_subgrupo_material_crit_w	= cd_subgrupo_material_w	or
					 cd_classe_material_crit_w	= cd_classe_material_w		or
					 cd_material_crit_w		= cd_material_w)		and
					 (((coalesce(ie_consignado_crit_w,'2') = '0') and (ie_consignado_w = '0')) or
					 ((coalesce(ie_consignado_crit_w,'2') = '1') and (ie_consignado_w = '1')) or
					 ((coalesce(ie_consignado_crit_w,'2') = '3') and (ie_consignado_w = '2')) or --Criada nova opcao OS821589
					 (coalesce(ie_consignado_crit_w,'2') = '2')) then
					 pr_aplicar_w	:= pr_total_w;
				end if;
			end if;
                end if;

		END LOOP;
		Close C09;

		vl_ajuste_w := (vl_item_w * pr_aplicar_w / 100);

		if (coalesce(vl_limite_w,0) > 0) and (vl_ajuste_w > vl_limite_w) then
			vl_ajuste_w := vl_limite_w;
		end if;


		Vl_acumulado_w	:= vl_acumulado_w + vl_ajuste_w;
		end;
END LOOP;
CLOSE C01;

OPEN C02;
LOOP
	FETCH C02 into
		nr_sequencia_w,
	 	cd_area_procedimento_w,
		cd_especialidade_w,
		cd_grupo_proc_w,
		cd_procedimento_w,
		ie_origem_proced_w,
		cd_grupo_material_w,
		cd_subgrupo_material_w,
		cd_classe_material_w,
		cd_material_w,
		vl_Item_w,
		vl_item_medico_w,
		vl_item_custo_oper_w,
		vl_item_filme_w,
		qt_item_w,
		nr_seq_proc_pacote_w,
		nr_seq_proc_interno_w,
		vl_participante_w,
		ie_consignado_w,
		ie_responsavel_credito_w,
		cd_convenio_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		pr_aplicar_w		:= 0;
                nr_seq_criterio_w       := 0;
		OPEN C09;
		LOOP
		FETCH C09 into
		 	cd_area_procedimento_crit_w,
			cd_especialidade_crit_w,
			cd_grupo_proc_crit_w,
			cd_procedimento_crit_w,
			ie_origem_proced_crit_w,
			cd_grupo_material_crit_w,
			cd_subgrupo_material_crit_w,
			cd_classe_material_crit_w,
			cd_material_crit_w,
			nr_seq_proc_interno_crit_w,
			ie_procedimento_crit_w,
			ie_Material_crit_w,
			pr_total_w,
			ie_consignado_crit_w,
			vl_limite_w,
                        nr_seq_criterio_w;
		EXIT WHEN NOT FOUND; /* apply on c09 */

                /*APLICA A REGRA PARA RESTRICAO DO CRITERIO*/

                if (coalesce(nr_seq_criterio_w,0) > 0) and (nr_seq_regra_p > 0) then

                        select  count(1)
                        into STRICT    qt_proc_restricao_w
                        from    regra_preco_proc_restricao a,
                                procedimento_paciente      b,
                                Estrutura_Procedimento_v   c
                        where   a.nr_seq_criterio               = nr_seq_criterio_w
                        and     a.nr_seq_regra                  = nr_seq_regra_p
                        and     b.nr_interno_conta              = nr_interno_conta_p
                        and     b.cd_procedimento               = c.cd_procedimento
                        and     b.ie_origem_proced              = c.ie_origem_proced
                        and     ((a.cd_area_procedimento = c.cd_area_procedimento)
                                or (a.cd_especialidade = c.cd_especialidade)
                                or (a.cd_grupo_proc    = c.cd_grupo_proc)
                                or ((a.cd_procedimento  = c.cd_procedimento) and (coalesce(a.ie_origem_proced,c.ie_origem_proced) = c.ie_origem_proced)))
                        and     a.ie_situacao = 'A';

                end if;


                if (qt_proc_restricao_w = 0 ) then
			if (cd_procedimento_w > 0) then
				if (ie_procedimento_crit_w > 0) 					and (cd_area_procedimento_crit_w	= cd_area_procedimento_w	or
					 cd_especialidade_crit_w	= cd_especialidade_w		or
					 cd_grupo_proc_crit_w		= cd_grupo_proc_w		or
					 cd_procedimento_crit_w		= cd_procedimento_w		or
					 nr_seq_proc_interno_crit_w	= nr_seq_proc_interno_w)	then
					 pr_aplicar_w	:= pr_total_w;

					vl_item_ww:= vl_item_w;
					vl_item_w:= coalesce(vl_item_medico_w,0) + coalesce(vl_item_custo_oper_w,0) + coalesce(vl_item_filme_w,0) + coalesce(vl_participante_w,0);
					if (vl_item_w = 0) then
						vl_item_w:= vl_item_ww;
					end if;

				end if;
			else
				if (ie_Material_crit_w > 0) 					and (cd_grupo_material_crit_w	= cd_grupo_material_w		or
					 cd_subgrupo_material_crit_w	= cd_subgrupo_material_w	or
					 cd_classe_material_crit_w	= cd_classe_material_w		or
					 cd_material_crit_w		= cd_material_w)		and
					 (((coalesce(ie_consignado_crit_w,'2') = '0') and (ie_consignado_w = '0')) or
					  ((coalesce(ie_consignado_crit_w,'2') = '1') and (ie_consignado_w = '1')) or
					  ((coalesce(ie_consignado_crit_w,'2') = '3') and (ie_consignado_w = '2')) or --Criada nova opcao OS821589
					  (coalesce(ie_consignado_crit_w,'2') = '2')) then
					 pr_aplicar_w	:= pr_total_w;
				end if;
			end if;
                end if;

		END LOOP;
		Close C09;

                /*APLICA A REGRA PARA RESTRICAO DO CRITERIO*/

                if (coalesce(nr_seq_criterio_w,0) > 0) and (nr_seq_regra_p > 0) then
                        select  count(1)
                        into STRICT    qt_proc_restricao_w
                        from    regra_preco_proc_restricao a,
                                procedimento_paciente      b,
                                Estrutura_Procedimento_v   c
                        where   a.nr_seq_criterio               = nr_seq_criterio_w
                        and     a.nr_seq_regra                  = nr_seq_regra_p
                        and     b.nr_interno_conta              = nr_interno_conta_p
                        and     b.cd_procedimento               = c.cd_procedimento
                        and     b.ie_origem_proced              = c.ie_origem_proced
                        and     ((a.cd_area_procedimento = c.cd_area_procedimento)
                                or (a.cd_especialidade = c.cd_especialidade)
                                or (a.cd_grupo_proc    = c.cd_grupo_proc)
                                or ((a.cd_procedimento  = c.cd_procedimento) and (coalesce(a.ie_origem_proced,c.ie_origem_proced) = c.ie_origem_proced)))
                        and     a.ie_situacao = 'A';

                        if (qt_proc_restricao_w > 0) then
                            pr_aplicar_w := 0;
                        end if;
                end if;

		vl_ajuste_w	:= (vl_item_w * pr_aplicar_w / 100);

		if (coalesce(vl_limite_w,0) > 0) and (vl_ajuste_w > vl_limite_w) then
			vl_ajuste_w := vl_limite_w;
		end if;


		Vl_acumulado_w	:= vl_acumulado_w + vl_ajuste_w;


		end;
END LOOP;
CLOSE C02;

vl_procedimento_p			:= vl_acumulado_w;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_valor_proc_regra ( nr_seq_regra_p bigint, nr_interno_conta_p bigint, nr_seq_proc_princ_p bigint, nm_usuario_p text, cd_setor_atendimento_p bigint, vl_procedimento_p INOUT bigint) FROM PUBLIC;

