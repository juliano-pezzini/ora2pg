-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_tof_meta_atend ( nr_atendimento_p text, nm_usuario_p text) AS $body$
DECLARE


contador_w					integer;
contador_ww					integer;
cd_estab_atend_paciente_w	smallint;
nr_idade_paciente_w			varchar(50);
cd_setor_atend_w			bigint;
ie_regra_w					varchar(10);
ie_status_w					varchar(1) := '';
nr_sequencia_w				tof_meta.nr_sequencia%type;

C01 CURSOR FOR
	SELECT	t.nr_sequencia,
		t.ie_regra
	from	tof_meta t
	where	coalesce(t.ie_situacao,'A') = 'A'
	and		t.ie_tipo_meta <> 'R';


BEGIN

if (coalesce(nr_atendimento_p,0) > 0) then
	open C01;
	loop
	fetch C01 into
		nr_sequencia_w,
		ie_regra_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
			select	cd_estabelecimento,
					obter_idade_pf(cd_pessoa_fisica, clock_timestamp(), 'A'),
					obter_setor_atendimento(nr_atendimento)
			into STRICT	cd_estab_atend_paciente_w,
					nr_idade_paciente_w,
					cd_setor_atend_w
			from	atendimento_paciente
			where	nr_atendimento = nr_atendimento_p;


			select	count(*)
			into STRICT	contador_w
			from	tof_meta_regra
			where	nr_seq_meta = nr_sequencia_w
			and		nr_idade_paciente_w between coalesce(qt_idade_min, 0) and coalesce(qt_idade_max,999)
			and		((coalesce(cd_setor_atendimento::text, '') = '') or (cd_setor_atend_w = cd_setor_atendimento))
			and		cd_estab_atend_paciente_w = cd_estabelecimento
			and		((coalesce(cd_doenca::text, '') = '') or (obter_se_paciente_doenca(cd_doenca, nr_atendimento_p) = 'S'));

			select	count(*)
			into STRICT	contador_ww
			from	tof_meta_atend
			where	nr_seq_meta = nr_sequencia_w
			and		nr_atendimento = nr_atendimento_p
			and		coalesce(dt_finalizacao::text, '') = ''
			and     (dt_liberacao IS NOT NULL AND dt_liberacao::text <> '')
			and     coalesce(dt_inativacao::text, '') = '';

			if	(contador_w > 0 AND contador_ww = 0) then
				begin

					if (ie_regra_w = 'E' ) then

						ie_status_w := '';

					end if;

					insert into tof_meta_atend( 	nr_sequencia,
													dt_atualizacao,
													nm_usuario,
													dt_atualizacao_nrec,
													nm_usuario_nrec,
													nr_seq_meta,
													dt_inicio,
													dt_finalizacao,
													nr_atendimento,
													ie_status,
													ds_observacao,
													dt_liberacao)
										values (	nextval('tof_meta_atend_seq'),
													clock_timestamp(),
													nm_usuario_p,
													clock_timestamp(),
													nm_usuario_p,
													nr_sequencia_w,
													clock_timestamp(),
													null,
													nr_atendimento_p,
													ie_status_w,
													'',
													clock_timestamp());
				end;
			end if;
		end;
	end loop;
	close C01;
end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_tof_meta_atend ( nr_atendimento_p text, nm_usuario_p text) FROM PUBLIC;

