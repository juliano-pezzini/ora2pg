-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_gerar_valor_porte_proced ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;
nr_seq_regra_porte_w	bigint;
dt_atualizacao_w		timestamp;
nm_usuario_w		varchar(15);
nr_seq_procedimento_w	bigint;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
dt_procedimento_w		timestamp;
nr_atendimento_w		bigint;
cd_anestesista_w		varchar(10);
vl_porte_anestesico_w	double precision;
qt_proced_porte_w		bigint := 0;
cd_edicao_amb_w		integer;
nr_porte_anestesico_w	smallint;
dt_inicio_vigencia_w	timestamp;


BEGIN

begin
select	a.cd_procedimento,
	a.ie_origem_proced,
	a.dt_procedimento,
	a.nr_atendimento,
	b.cd_pessoa_fisica
into STRICT	cd_procedimento_w,
	ie_origem_proced_w,
	dt_procedimento_w,
	nr_atendimento_w,
	cd_anestesista_w
from 	procedimento_paciente a,
	procedimento_participante b
where	a.nr_sequencia	= nr_sequencia_p
and	b.nr_sequencia	= a.nr_sequencia
and	coalesce(a.cd_motivo_exc_conta::text, '') = ''
and	sus_obter_indicador_equipe(b.ie_funcao) = 6
and	b.ie_participou_sus = 'S';
exception
when others then
	cd_procedimento_w	:= 0;
	ie_origem_proced_w	:= 0;
end;

if (coalesce(cd_procedimento_w,0) <> 0) then
	begin

	begin
	select 	count(*)
	into STRICT	qt_proced_porte_w
	from 	sus_valor_porte_proced
	where	nr_seq_procedimento = nr_sequencia_p;
	exception
	when others then
		--r.aise_application_error(-20011,'Problema ao veridicar se o procedimento já esta na tabela de porte!'||'#@#@');
		CALL wheb_mensagem_pck.exibir_mensagem_abort(263519);
	end;

	if (qt_proced_porte_w = 0) then
		begin

		begin
		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_regra_porte_w
		from	sus_regra_porte_proced
		where	cd_procedimento 		= cd_procedimento_w
		and	ie_origem_proced	= ie_origem_proced_w
		and	ie_situacao		= 'A';
		exception
		when OTHERS then
			nr_seq_regra_porte_w := 0;
		end;

		if (nr_seq_regra_porte_w <> 0) then
			begin

			begin
			select	coalesce(vl_porte_anestesico,0)
			into STRICT	vl_porte_anestesico_w
			from	porte_anestesico a,
				sus_regra_porte_proced b
			where	a.cd_edicao_amb 	= b.cd_edicao_amb
			and	a.nr_porte_anestesico 	= b.nr_porte_anestesico
			and	a.dt_inicio_vigencia	= b.dt_inicio_vigencia
			and	b.nr_sequencia		= nr_seq_regra_porte_w;
			exception
			when OTHERS then
				--r.aise_application_error(-20011,'Problema ao obter o valor do porte anestésico para o procedimento '||cd_procedimento_w||'.'||'#@#@');
				CALL wheb_mensagem_pck.exibir_mensagem_abort(263520,'cd_procedimento_w='||cd_procedimento_w);
			end;

			insert into sus_valor_porte_proced(
					nr_sequencia,
					nr_seq_regra_porte,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_procedimento,
					cd_procedimento,
					ie_origem_proced,
					dt_procedimento,
					nr_atendimento,
					cd_anestesista,
					vl_porte_anestesico,
					vl_total_anestesista)
			values (		nextval('sus_valor_porte_proced_seq'),
					nr_seq_regra_porte_w,
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_sequencia_p,
					cd_procedimento_w,
					ie_origem_proced_w,
					dt_procedimento_w,
					nr_atendimento_w,
					cd_anestesista_w,
					vl_porte_anestesico_w,
					vl_porte_anestesico_w);

			if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then commit; end if;

			end;
		end if;

		end;
	end if;

	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_gerar_valor_porte_proced ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

