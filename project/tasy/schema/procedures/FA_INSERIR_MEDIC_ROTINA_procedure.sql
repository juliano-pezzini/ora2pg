-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fa_inserir_medic_rotina ( nr_seq_receita_p bigint, ds_lista_medic_rotina_p text, nm_usuario_p text) AS $body$
DECLARE




lista_informacao_w		varchar(1000);

ie_contador_w			bigint	:= 0;

tam_lista_w			bigint;

ie_pos_virgula_w		smallint;

nr_seq_medic_rotina_w		bigint;



cd_material_w			bigint;

qt_dose_w			double precision;

ie_via_aplicacao_w		varchar(15);

nr_dias_receita_w		integer;

nr_dias_receita_item_w		integer;

cd_unidade_medida_w		varchar(30);

cd_intervalo_w			varchar(7);

ie_segunda_w			varchar(1);

ie_terca_w			varchar(1);

ie_quarta_w			varchar(1);

ie_quinta_w			varchar(1);

ie_sexta_w			varchar(1);

ie_sabado_w			varchar(1);

ie_domingo_w			varchar(1);

ie_uso_continuo_w		varchar(1);

ie_se_necessario_w		varchar(1);

nr_ciclo_w			integer;

ds_texto_receita_w		varchar(32000);

dt_inicio_receita_w		timestamp;

dt_validade_receita_w		timestamp;

cd_pessoa_fisica_w		varchar(10);

ie_permite_varias_rec_w		varchar(1);

ie_dados_receita_uso_cont_w	varchar(1);

ds_observacao_w			varchar(255);

qt_medicacao_w		smallint;




BEGIN



ie_permite_varias_rec_w		:= obter_valor_param_usuario(10015, 40, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);

ie_dados_receita_uso_cont_w	:= obter_valor_param_usuario(10015, 81, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);



if (nr_seq_receita_p IS NOT NULL AND nr_seq_receita_p::text <> '') then

	lista_informacao_w	:= ds_lista_medic_rotina_p;

	while	(lista_informacao_w IS NOT NULL AND lista_informacao_w::text <> '') and

		ie_contador_w < 200 loop

		begin



		tam_lista_w			:= length(lista_informacao_w);

		ie_pos_virgula_w		:= position(',' in lista_informacao_w);



		/* Obter a sequÃªncia lida */

		if (ie_pos_virgula_w <> 0) then

			nr_seq_medic_rotina_w	:= substr(lista_informacao_w,1,(ie_pos_virgula_w - 1));

			lista_informacao_w	:= trim(both substr(lista_informacao_w,(ie_pos_virgula_w + 1),tam_lista_w));

		end if;



		select	dt_inicio_receita,

			nr_dias_receita,

			dt_validade_receita,

			cd_pessoa_fisica

		into STRICT	dt_inicio_receita_w,

			nr_dias_receita_w,

			dt_validade_receita_w,

			cd_pessoa_fisica_w

		from	fa_receita_farmacia

		where	nr_sequencia = nr_seq_receita_p;



		select	cd_material,

			qt_dose,

			ie_via_aplicacao,

			coalesce(nr_dias_receita,nr_dias_receita_w),

			cd_unidade_medida,

			cd_intervalo,

			ie_segunda,

			ie_terca,

			ie_quarta,

			ie_quinta,

			ie_sexta,

			ie_sabado,

			ie_domingo,

			ie_uso_continuo,

			nr_ciclo,

			ds_texto_receita,

			ie_se_necessario,

			ds_observacao,

      qt_medicacao

		into STRICT	cd_material_w,

			qt_dose_w,

			ie_via_aplicacao_w,

			nr_dias_receita_item_w,

			cd_unidade_medida_w,

			cd_intervalo_w,

			ie_segunda_w,

			ie_terca_w,

			ie_quarta_w,

			ie_quinta_w,

			ie_sexta_w,

			ie_sabado_w,

			ie_domingo_w,

			ie_uso_continuo_w,

			nr_ciclo_w,

			ds_texto_receita_w,

			ie_se_necessario_w,

			ds_observacao_w,

      qt_medicacao_w

		from	fa_medicamento_rotina

		where	nr_sequencia = nr_seq_medic_rotina_w;



		if (ie_uso_continuo_w = 'S') and (ie_dados_receita_uso_cont_w = 'N') then

			nr_dias_receita_item_w 	:= null;

			dt_inicio_receita_w	:= null;

		elsif (nr_dias_receita_item_w > nr_dias_receita_w) or (ie_uso_continuo_w = 'S' AND ie_dados_receita_uso_cont_w = 'S') then

			nr_dias_receita_item_w 	:= nr_dias_receita_w;

		end if;



		if (ie_uso_continuo_w = 'N') then

			dt_validade_receita_w 	:= dt_inicio_receita_w + nr_dias_receita_item_w - 1;

		elsif (ie_uso_continuo_w = 'S') and (ie_dados_receita_uso_cont_w = 'N') then

			dt_validade_receita_w	:= null;

		end if;



		if (obter_se_interv_agora_acm_sn(cd_intervalo_w) <> 'SN') and (dt_validade_receita_w <= dt_inicio_receita_w) then

			CALL gravar_log_tasy(30426,

					wheb_mensagem_pck.get_texto(795830,

						'NR_SEQ_RECEITA_P='||NR_SEQ_RECEITA_P||

						';CD_MATERIAL_W='||CD_MATERIAL_W||

						';NR_SEQ_MEDIC_ROTINA_W='||NR_SEQ_MEDIC_ROTINA_W),

					nm_usuario_p);

		elsif (obtain_user_locale(wheb_usuario_pck.get_nm_usuario) <> 'en_AU') and (ie_permite_varias_rec_w = 'N') and (fa_obter_se_possui_receita(cd_material_w,cd_pessoa_fisica_w,null,dt_inicio_receita_w,null) = 'S') then

			CALL gravar_log_tasy(30426,

					wheb_mensagem_pck.get_texto(795831,

						'NR_SEQ_RECEITA_P='||NR_SEQ_RECEITA_P||

						';CD_MATERIAL_W='||CD_MATERIAL_W||

						';NR_SEQ_MEDIC_ROTINA_W='||NR_SEQ_MEDIC_ROTINA_W),

					nm_usuario_p);

		else

			insert into fa_receita_farmacia_item(

				nr_sequencia,

				dt_atualizacao,

				nm_usuario,

				dt_atualizacao_nrec,

				nm_usuario_nrec,

				nr_seq_receita,

				cd_material,

				qt_dose,

				ie_via_aplicacao,

				nr_dias_receita,

				cd_unidade_medida,

				cd_intervalo,

				ie_segunda,

				ie_terca,

				ie_quarta,

				ie_quinta,

				ie_sexta,

				ie_sabado,

				ie_domingo,

				ie_uso_continuo,

				nr_ciclo,

				ds_texto_receita,

				dt_inicio_receita,

				dt_validade_receita,

				ie_se_necessario,

				ds_observacao,

        				qt_medicacao)

			values (	nextval('fa_receita_farmacia_item_seq'),

				clock_timestamp(),

				nm_usuario_p,

				clock_timestamp(),

				nm_usuario_p,

				nr_seq_receita_p,

				cd_material_w,

				qt_dose_w,

				ie_via_aplicacao_w,

				nr_dias_receita_item_w,

				cd_unidade_medida_w,

				cd_intervalo_w,

				ie_segunda_w,

				ie_terca_w,

				ie_quarta_w,

				ie_quinta_w,

				ie_sexta_w,

				ie_sabado_w,

				ie_domingo_w,

				ie_uso_continuo_w,

				nr_ciclo_w,

				ds_texto_receita_w,

				dt_inicio_receita_w,

				dt_validade_receita_w,

				ie_se_necessario_w,

				ds_observacao_w,

       				qt_medicacao_w);

		end if;



		ie_contador_w	:= ie_contador_w + 1;



		end;

	end loop;

end if;



commit;



end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fa_inserir_medic_rotina ( nr_seq_receita_p bigint, ds_lista_medic_rotina_p text, nm_usuario_p text) FROM PUBLIC;

