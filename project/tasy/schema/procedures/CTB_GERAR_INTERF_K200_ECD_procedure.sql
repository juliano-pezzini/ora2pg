-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_gerar_interf_k200_ecd ( nr_seq_controle_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, cd_empresa_p bigint, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) AS $body$
DECLARE


ds_arquivo_w		varchar(4000);
ds_compl_arquivo_w	varchar(4000);
ds_linha_w		varchar(8000);
nr_linha_w		bigint := qt_linha_p;
nr_seq_registro_w	bigint := nr_sequencia_p;
sep_w			varchar(1) := '|';
tp_registro_w		varchar(15) := 'K200';
cd_grupo_ecd_w		varchar(2);
nr_nivel_w		bigint;
ie_tipo_ecd_w		conta_contabil.ie_tipo%type;
ie_apres_conta_ctb_w	ctb_regra_sped.ie_apres_conta_ctb%type;
cd_classificacao_w	conta_contabil.cd_classificacao%type;
--cd_classif_superior_w	conta_contabil.cd_classif_superior%type;
cd_conta_sup_w		varchar(40);
cd_conta_contabil_w	varchar(40);
cd_conta_contabil_ww	varchar(40);
ds_conta_contabil_w	conta_contabil.ds_conta_contabil%type;

c01 CURSOR FOR
	SELECT	substr(lpad(coalesce(a.ie_natureza_sped,CASE WHEN b.ie_tipo='A' THEN '1' WHEN b.ie_tipo='P' THEN '2' WHEN b.ie_tipo='R' THEN '4' WHEN b.ie_tipo='C' THEN '4' WHEN b.ie_tipo='D' THEN '4'  ELSE '9' END ),2,'0'),1,2) cd_grupo_ecd,
		substr(CASE WHEN a.ie_tipo='T' THEN 'S'  ELSE 'A' END ,1,1) ie_tipo_ecd,
		ctb_obter_nivel_classif_conta(a.cd_classificacao) nr_nivel,
		substr(ctb_obter_classif_conta(a.cd_conta_contabil, a.cd_classificacao, dt_fim_p),1,40) cd_classificacao,
		a.cd_conta_contabil cd_conta_contabil,
		a.ds_conta_contabil ds_conta_contabil
	from	ctb_grupo_conta b,
		conta_contabil  a
	where	a.cd_grupo = b.cd_grupo
	and	a.cd_empresa = b.cd_empresa
	and	a.cd_empresa = cd_empresa_p  -- holding
	and	a.ie_situacao = 'A'
	and	substr(obter_se_vigencia_periodo(a.dt_inicio_vigencia, a.dt_fim_vigencia,dt_inicio_p,dt_fim_p,'S'),1,1) = 'S'
	and	exists (
			SELECT	1
			from	ctb_saldo x
			where	x.cd_conta_contabil = a.cd_conta_contabil
			and	((substr(CASE WHEN a.ie_tipo='T' THEN 'S'  ELSE 'A' END ,1,1) = 'S') or (x.vl_credito <> 0 or x.vl_debito <> 0 or x.vl_saldo <> 0))
			and	x.nr_seq_mes_ref in (
						select	z.nr_sequencia
						from	ctb_mes_ref z
						where	z.cd_empresa = cd_empresa_p
						and	z.dt_referencia between pkg_date_utils.start_of(dt_inicio_p,'yyyy') and pkg_date_utils.end_of(dt_inicio_p, 'YEAR',0))
			 LIMIT 1)		
	order by 4;


BEGIN

select	coalesce(max(a.ie_apres_conta_ctb),'CD')
into STRICT	ie_apres_conta_ctb_w
from	ctb_regra_sped a,
	ctb_sped_controle b
where	b.nr_seq_regra_sped = a.nr_sequencia
and	b.nr_sequencia = nr_seq_controle_p;


open C01;
loop
fetch C01 into
	cd_grupo_ecd_w,
	ie_tipo_ecd_w,
	nr_nivel_w,
	cd_classificacao_w,
	cd_conta_contabil_w,
	ds_conta_contabil_w;
	
	EXIT WHEN NOT FOUND; /* apply on C01 */
	begin	
	if (ie_apres_conta_ctb_w = 'CD') then
		begin
		cd_conta_contabil_ww  := cd_conta_contabil_w;

		if (nr_nivel_w > 1) then
			cd_conta_sup_w := ctb_obter_codigo_classif_vig(cd_empresa_p,substr(ctb_obter_classif_conta_sup(cd_classificacao_w, dt_inicio_p, cd_empresa_p),1,40),dt_inicio_p);
		else
			cd_conta_sup_w := null;
		end if;
		end;
	elsif (ie_apres_conta_ctb_w = 'CL') then
		begin
		cd_conta_contabil_ww	:= cd_classificacao_w;
		if (nr_nivel_w > 1) then
			cd_conta_sup_w := substr(ctb_obter_classif_conta_sup(cd_classificacao_w, dt_inicio_p, cd_empresa_p),1,40);
		else
				cd_conta_sup_w := null;
		end if;
	end;
	elsif (ie_apres_conta_ctb_w = 'CP') then
		begin
		cd_conta_contabil_ww	:= substr(replace(cd_classificacao_w,'.',''),1,40);
		if (nr_nivel_w > 1) then
			cd_conta_sup_w    := substr(replace(substr(ctb_obter_classif_conta_sup(cd_classificacao_w, dt_inicio_p, cd_empresa_p),1,40),'.',''),1,40);
		else
			cd_conta_sup_w := null;
		end if;
		  end;
	end if;

	ds_linha_w  :=   substr(sep_w       ||
	tp_registro_w               	|| sep_w ||
	cd_grupo_ecd_w              	|| sep_w ||
	ie_tipo_ecd_w               	|| sep_w ||
	nr_nivel_w                  	|| sep_w ||
	cd_conta_contabil_ww        	|| sep_w ||
	cd_conta_sup_w              	|| sep_w ||
	ds_conta_contabil_w         	|| sep_w
	,1,8000);

	ds_arquivo_w          	:= substr(ds_linha_w,1,4000);
	ds_compl_arquivo_w      := substr(ds_linha_w,4001,4000);
	nr_seq_registro_w       := nr_seq_registro_w + 1;
	nr_linha_w            	:= nr_linha_w + 1;

	insert into ctb_sped_registro(
		nr_sequencia,
		ds_arquivo,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_controle_sped,
		ds_arquivo_compl,
		cd_registro,
		nr_linha)
	values (
		nr_seq_registro_w,
		ds_arquivo_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_controle_p,
		ds_compl_arquivo_w,
		tp_registro_w,
		nr_linha_w);

	if (ie_tipo_ecd_w = 'A') then  --anal√≠tico
	begin
	SELECT * FROM ctb_gerar_interf_k210_ecd(nr_seq_controle_p, nm_usuario_p, cd_estabelecimento_p, dt_inicio_p, dt_fim_p, cd_empresa_p, cd_conta_contabil_w, nr_linha_w, nr_seq_registro_w) INTO STRICT nr_linha_w, nr_seq_registro_w;
	end;
	end if;

	end;
end loop;
close C01;
commit;
qt_linha_p  := nr_linha_w;
nr_sequencia_p  := nr_seq_registro_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_gerar_interf_k200_ecd ( nr_seq_controle_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint, dt_inicio_p timestamp, dt_fim_p timestamp, cd_empresa_p bigint, qt_linha_p INOUT bigint, nr_sequencia_p INOUT bigint) FROM PUBLIC;

