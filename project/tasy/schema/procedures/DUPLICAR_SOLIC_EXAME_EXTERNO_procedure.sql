-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicar_solic_exame_externo (nr_sequencia_p bigint, nm_usuario_p text, nr_atendimento_p bigint default null, cd_medico_p text default null) AS $body$
DECLARE


nr_seq_parametro_w		bigint;
cd_pessoa_fisica_w	        varchar(10);
ie_nivel_atencao_w		varchar(1);


BEGIN

select	nextval('pedido_exame_externo_seq')
into STRICT	nr_seq_parametro_w
;

select	obter_pessoa_fisica_usuario(wheb_usuario_pck.get_nm_usuario, 'C')
into STRICT	cd_pessoa_fisica_w
;


cd_pessoa_fisica_w := coalesce(cd_medico_p,cd_pessoa_fisica_w);

ie_nivel_atencao_w := wheb_assist_pck.get_nivel_atencao_perfil;	


insert	into pedido_exame_externo(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	cd_pessoa_fisica,
	nr_atendimento,
	cd_profissional,
	dt_solicitacao,
	ds_solicitacao,
	ds_dados_clinicos,
	ds_exame_ant,
	ie_ficha_unimed,
	ds_cid,
	ds_diagnostico_cid,
	ds_justificativa,
	CD_AUTORIZACAO,
	CD_DOENCA,
	IE_SITUACAO,
	ie_nivel_atencao,
	nr_seq_reg_elemento,
	nr_seq_atend_cons_pepa)
SELECT	nr_seq_parametro_w,
	clock_timestamp(),	
	nm_usuario_p,
	cd_pessoa_fisica,
	coalesce(nr_atendimento_p,nr_atendimento),
	CASE WHEN obter_se_medico(cd_pessoa_fisica_w, 'M')='S' THEN cd_pessoa_fisica_w  ELSE cd_profissional END ,
	clock_timestamp(),
	' ',
	ds_dados_clinicos,
	ds_exame_ant,
	ie_ficha_unimed,
	ds_cid,
	ds_diagnostico_cid,
	ds_justificativa,
	CD_AUTORIZACAO,
	CD_DOENCA,
	'A',
	ie_nivel_atencao_w,
	nr_seq_reg_elemento,
	nr_seq_atend_cons_pepa
from	pedido_exame_externo
where	nr_sequencia	= nr_sequencia_p;

begin
CALL copia_campo_long_de_para(	'PEDIDO_EXAME_EXTERNO','DS_SOLICITACAO','WHERE NR_SEQUENCIA = :nr_seq_solic','nr_seq_solic='||nr_sequencia_p,
				'PEDIDO_EXAME_EXTERNO','DS_SOLICITACAO','WHERE NR_SEQUENCIA = :nr_seq_laudo','nr_seq_laudo='||nr_seq_parametro_w);
exception
	when others then
	null;
end;

insert	into pedido_exame_externo_item(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	nr_seq_pedido,
	nr_seq_exame,
	qt_exame,
	nr_seq_apresent,
	ds_justificativa,
	ds_exame_sem_cad,
	cd_procedimento,
	ie_origem_proced,
	nr_seq_exame_lab,
	nr_proc_interno,
	IE_LADO,
	NR_SEQ_PROC_INT_SUS,
	nr_seq_atend_cons_pepa)
SELECT	nextval('pedido_exame_externo_item_seq'),
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_parametro_w,
	nr_seq_exame,
	qt_exame,
	nr_seq_apresent,
	ds_justificativa,
	ds_exame_sem_cad,
	cd_procedimento,
	ie_origem_proced,
	nr_seq_exame_lab,
	nr_proc_interno,
	ie_lado,
	NR_SEQ_PROC_INT_SUS,
	nr_seq_atend_cons_pepa
from	Pedido_Exame_Externo_Item
where	nr_seq_pedido	= nr_sequencia_p;

COMMIT;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_solic_exame_externo (nr_sequencia_p bigint, nm_usuario_p text, nr_atendimento_p bigint default null, cd_medico_p text default null) FROM PUBLIC;

