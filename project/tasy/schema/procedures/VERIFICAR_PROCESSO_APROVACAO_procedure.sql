-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE verificar_processo_aprovacao ( nr_seq_carta_mae_p bigint ) AS $body$
DECLARE


	CONST_ML_TASK_LIST_W			constant varchar(2) := 'ML';

	nr_seq_regra_w					bigint	:= 0;
	ie_participante_w				bigint	:= 0;
	ie_usuario_low_level_w			bigint	:= 0;


BEGIN
	select	count(1)
	into STRICT	ie_participante_w
	from	PARTICIPANTE_CARTA_MEDICA
	where	NR_SEQ_CARTA_MAE = nr_seq_carta_mae_p
	and     coalesce(IE_DEVE_ASSINAR, 'S') = 'S'
	and 	nm_usuario_resp = wheb_usuario_pck.get_nm_usuario;

	select	count(1)
	into STRICT	ie_usuario_low_level_w
	from 	PARTICIPANTE_CARTA_MEDICA a
	where 	a.NR_SEQ_CARTA_MAE = nr_seq_carta_mae_p
	and		coalesce(a.ie_deve_assinar, 'S') = 'S'
	and 	a.nm_usuario_resp = wheb_usuario_pck.get_nm_usuario
	and     exists (
						SELECT  1
						from 	PARTICIPANTE_CARTA_MEDICA b
						where 	b.NR_SEQ_CARTA_MAE = a.nr_seq_carta_mae
						and     (b.dt_assinatura IS NOT NULL AND b.dt_assinatura::text <> '')
						and		coalesce(b.ie_deve_assinar, 'S') = 'S'
						and     b.nr_seq_assinatura > a.nr_seq_assinatura
					);
	
	if (ie_participante_w = 0 or ie_usuario_low_level_w > 0) then
		select	max(a.nr_seq_regra)
		into STRICT	nr_seq_regra_w
		from	wl_worklist a,
				wl_item b,
				wl_regra_item c
		where	a.nr_seq_carta_mae = nr_seq_carta_mae_p
		and		b.nr_sequencia = a.nr_seq_item
		and		c.nr_sequencia = a.nr_seq_regra
		and		coalesce(a.dt_final_real::text, '') = ''
		and		b.cd_categoria = CONST_ML_TASK_LIST_W
		and		c.ie_tipo_pend_carta = 'A'
		and		b.ie_situacao = 'A'
		and		c.ie_situacao = 'A';
		
		CALL wl_gerar_finalizar_tarefa( 	'ML',
									'F',
									null,
									null,
									wheb_usuario_pck.get_nm_usuario,
									null,
									'S',
									null,
									null,
									null,
									null,
									null,
									nr_seq_carta_mae_p,
									null,
									null,
									null,
									nr_seq_regra_w,
									null,
									null,
									null,
									null,
									null,
									null,
									null,
									clock_timestamp(),
									null,
									null,
									null);
		
		update	PARTICIPANTE_CARTA_MEDICA
		set		dt_assinatura  = NULL,
				NM_USUARIO_ASSINAT  = NULL
		where 	NR_SEQ_CARTA_MAE = nr_seq_carta_mae_p;
		
		commit;

		CALL atualizar_status_aprovacao(nr_seq_carta_mae_p, 'PE');
	end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE verificar_processo_aprovacao ( nr_seq_carta_mae_p bigint ) FROM PUBLIC;

