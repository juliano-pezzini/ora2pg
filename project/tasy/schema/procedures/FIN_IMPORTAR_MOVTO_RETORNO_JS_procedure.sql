-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fin_importar_movto_retorno_js ( ie_opcao_p bigint, nr_seq_p bigint, nr_seq_retorno_p bigint, ds_conteudo_p text, ds_atributos_valores_p text, ds_atributos_cab_p text, ds_atributos_adic_p text, ds_atributos_p text, ds_valores_adic_p text, ds_valores_cab_p text, ie_id_glosa_p text, ds_valores_p text, nm_usuario_p text) AS $body$
DECLARE



ds_sql_w			varchar(4000)	:= '';
ds_params_w		varchar(4000)	:= '';
ds_sep_bv_w		varchar(255)	:= '';


BEGIN

ds_sep_bv_w		:= obter_separador_bv;
if (coalesce(ie_opcao_p, -1) = 1) then

	ds_params_w	:=	'NR_SEQ='	|| nr_seq_p	|| ds_sep_bv_w ||
				'NM_USUARIO='	|| nm_usuario_p	|| ds_sep_bv_w;

	ds_sql_w		:=	' update	convenio_retorno_movto '		||
				' 	nm_usuario 	= :nm_usuario,'	||
				' 	dt_atualizacao 	= sysdate'		||
					ds_atributos_valores_p		||
				' where	nr_sequencia	= :nr_seq';

	CALL exec_sql_dinamico_bv(
		'IMPORTAR_MOVIMENTO_RETORNO_01',
		ds_sql_w,
		ds_params_w);

elsif (coalesce(ie_opcao_p, -1) = 2) then

	ds_params_w	:=	'NR_SEQ='	|| nr_seq_p 	 	|| ds_sep_bv_w ||
				'NR_SEQ_RETORNO='	|| nr_seq_retorno_p 	|| ds_sep_bv_w ||
				'NM_USUARIO='	|| nm_usuario_p 		|| ds_sep_bv_w;

	ds_sql_w	:= 'INSERT INTO CONVENIO_RETORNO_MOVTO ('||ds_atributos_cab_p || ds_atributos_p||',NR_SEQUENCIA,NR_SEQ_RETORNO,DT_ATUALIZACAO,NM_USUARIO,IE_GERA_RESUMO'|| ds_atributos_adic_p||
		   ') VALUES ('||ds_valores_cab_p||ds_valores_p||',:NR_SEQ,:NR_SEQ_RETORNO,SYSDATE,:NM_USUARIO, ''S'' '||ds_valores_adic_p|| ')';

	ds_sql_w := ltrim(rtrim(replace(replace(ds_sql_w,'(,','('),',)',')')));

	CALL exec_sql_dinamico_bv('IMPORTAR_MOVIMENTO_RETORNO',ds_sql_w,ds_params_w);

	if (coalesce(ie_id_glosa_p, 'N') = 'S') then
		update 	convenio_retorno_movto
		set	vl_glosa		= vl_total_pago,
			vl_pago		= 0,
			vl_total_pago	= 0
		where	nr_sequencia	= nr_seq_p;
	end if;

elsif (coalesce(ie_opcao_p, -1) = 3) then

	update	convenio_retorno_movto
	set	nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp(),
		vl_pago		= dividir(vl_total_pago, qt_paga)
	where	nr_sequencia	= nr_seq_p;


elsif (coalesce(ie_opcao_p, -1) = 4) then



	update	convenio_retorno_movto
	set	nm_usuario	= nm_usuario_p,
		dt_atualizacao	= clock_timestamp(),
		vl_total_pago	= dividir(vl_pago, qt_paga)
	where	vl_pago > 0
	and	coalesce(vl_total_pago::text, '') = ''
	and	qt_paga > 0
	and	nr_seq_retorno = nr_seq_retorno_p;

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fin_importar_movto_retorno_js ( ie_opcao_p bigint, nr_seq_p bigint, nr_seq_retorno_p bigint, ds_conteudo_p text, ds_atributos_valores_p text, ds_atributos_cab_p text, ds_atributos_adic_p text, ds_atributos_p text, ds_valores_adic_p text, ds_valores_cab_p text, ie_id_glosa_p text, ds_valores_p text, nm_usuario_p text) FROM PUBLIC;

