-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_ajustar_conversao_sus (nm_usuario_p text) AS $body$
DECLARE


nr_seq_proc_conv_w	bigint;
cd_procedimento_w	bigint;
ie_origem_proced_w	bigint;
cd_proc_unif_w		bigint;
ds_comando_create_w	varchar(2000);

c01 CURSOR FOR
	SELECT	CD_PROCEDIMENTO_SUS,
		IE_ORIGEM_PROCED_SUS,
		nr_sequencia
	from 	procedimento_conv_sus
	where	ie_origem_proced_sus = 2
	and	(cd_procedimento_sus IS NOT NULL AND cd_procedimento_sus::text <> '')
	order by nr_Sequencia;


BEGIN

ds_comando_create_w	:= 'create table bkp_procedimento_conv_sus as (select * from procedimento_conv_sus)';
CALL exec_sql_dinamico('TASY', ds_comando_create_w);

OPEN C01;
LOOP
FETCH C01 into
	cd_procedimento_w,
	ie_origem_proced_w,
	nr_seq_proc_conv_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	begin
	select	a.cd_proc_unif
	into STRICT	cd_proc_unif_w
	from	sus_origem a,
		procedimento b
	where	a.cd_procedimento	= cd_procedimento_w
	and	a.ie_origem_proced	= ie_origem_proced_w
	and	a.cd_proc_unif		= b.cd_procedimento
	and	a.ie_origem_proc_unif	= b.ie_origem_proced
	and	b.ie_situacao		= 'A';
	exception
		when others then
		cd_proc_unif_w	:= 0;
	end;

	if (cd_proc_unif_w	> 0) then

		update procedimento_conv_sus
		set 	cd_procedimento_sus		= cd_proc_unif_w,
			ie_origem_proced_sus		= 7,
			nm_usuario			= nm_usuario_p
		where	nr_sequencia			= nr_seq_proc_conv_w;
	end if;
END LOOP;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_ajustar_conversao_sus (nm_usuario_p text) FROM PUBLIC;

