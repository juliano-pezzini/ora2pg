-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desdobrar_itens_ordem_compra ( nr_ordem_compra_p INOUT bigint, nr_ordem_compra_orig_p bigint, nr_item_oci_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_existe_w			bigint;
nr_ordem_compra_w		bigint;
nr_item_oci_w			integer;
cd_estabelecimento_w		smallint;
ie_permite_desdobrar_oc_lib_w	varchar(1) := 'N';

consiste_contrato_w 		smallint;


BEGIN

select count(*)
into STRICT consiste_contrato_w
from  contrato_regra_nf
where nr_ordem_compra = nr_ordem_compra_orig_p
and nr_item_oci = nr_item_oci_p;

if (consiste_contrato_w > 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(341766, 'NR_ITEM_OCI_P='||nr_item_oci_p);
end if;

select	cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	ordem_compra
where	nr_ordem_compra = nr_ordem_compra_orig_p;

ie_permite_desdobrar_oc_lib_w := Obter_Param_Usuario(917, 67, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_permite_desdobrar_oc_lib_w);

nr_ordem_compra_w := nr_ordem_compra_p;

if (nr_ordem_compra_w = 0) then

	select	nextval('ordem_compra_seq')
	into STRICT	nr_ordem_compra_w
	;

	insert into ordem_compra(
		nr_ordem_compra,					cd_estabelecimento,				cd_cgc_fornecedor,
		cd_condicao_pagamento,				cd_comprador,					dt_ordem_compra,
		dt_atualizacao,					nm_usuario,					cd_moeda,
		ie_situacao,					dt_inclusao,					cd_pessoa_solicitante,
		cd_cgc_transportador,				ie_frete,						vl_frete,
		pr_multa_atraso,					pr_desconto,					pr_desc_pgto_antec,
		pr_juros_negociado,				dt_emissao,					ds_pessoa_contato,
		cd_motivo_alteracao,				cd_local_entrega,
		ds_observacao,
		dt_entrega,					nr_prescricao,					dt_aprovacao,
		dt_baixa,						dt_liberacao,					ie_aviso_chegada,
		nr_requisicao,					cd_pessoa_fisica,					nr_ordem_agrup,
		ie_emite_obs,					ie_urgente,					nr_seq_interno,
		nr_atendimento,					nm_usuario_imp,					ie_somente_pagto,
		nr_seq_motivo_cancel,				vl_despesa_acessoria,				cd_setor_atendimento,
		nr_seq_subgrupo_compra,				pr_desc_financeiro,					dt_leitura,
		dt_aceite,						nm_usuario_aceite,					nr_seq_forma_pagto,
		nr_documento_externo,				vl_desconto,					dt_faturamento,
		cd_convenio,					ie_tipo_ordem,					cd_estab_transf,
		ie_forma_exportar,					nr_seq_ressup_fornec,				dt_envio_email,
		nr_cirurgia,					nr_seq_reg_lic_compra,				ie_liberacao_portal,
		nr_seq_nf_repasse,					nr_seq_licitacao,					nr_documento_interno,
		nr_processo_interno,				nr_seq_tipo_compra,				nr_seq_agenda_pac,
		nr_seq_mod_compra,				nr_controle_edital,					ds_dados_importacao)
	SELECT	nr_ordem_compra_w,				cd_estabelecimento,				cd_cgc_fornecedor,
		cd_condicao_pagamento,				cd_comprador,					clock_timestamp(),
		clock_timestamp(),						nm_usuario_p,					cd_moeda,
		ie_situacao,					dt_inclusao,					cd_pessoa_solicitante,
		cd_cgc_transportador,				ie_frete,						vl_frete,
		pr_multa_atraso,					pr_desconto,					pr_desc_pgto_antec,
		pr_juros_negociado,				null,						ds_pessoa_contato,
		cd_motivo_alteracao,				cd_local_entrega,
		substr(CASE WHEN coalesce(ds_observacao::text, '') = '' THEN wheb_mensagem_pck.get_texto(299496,'DS_RETORNO='||nr_ordem_compra_orig_p)  ELSE substr(ds_observacao,1,3900) ||'...'|| chr(13) || chr(10) || substr(wheb_mensagem_pck.get_texto(299496,'DS_RETORNO='||nr_ordem_compra_orig_p),1,85) END ,1,4000),
		dt_entrega,					nr_prescricao,					null,
		null,						null,						ie_aviso_chegada,
		nr_requisicao,					cd_pessoa_fisica,					nr_ordem_agrup,
		ie_emite_obs,					ie_urgente,					nr_seq_interno,
		nr_atendimento,					nm_usuario_imp,					ie_somente_pagto,
		nr_seq_motivo_cancel,				vl_despesa_acessoria,				cd_setor_atendimento,
		nr_seq_subgrupo_compra,				pr_desc_financeiro,					dt_leitura,
		dt_aceite,						nm_usuario_aceite,					nr_seq_forma_pagto,
		nr_documento_externo,				vl_desconto,					dt_faturamento,
		cd_convenio,					ie_tipo_ordem,					cd_estab_transf,
		ie_forma_exportar,					nr_seq_ressup_fornec,				null,
		nr_cirurgia,					nr_seq_reg_lic_compra,				ie_liberacao_portal,
		nr_seq_nf_repasse,					nr_seq_licitacao,					nr_documento_interno,
		nr_processo_interno,				nr_seq_tipo_compra,				nr_seq_agenda_pac,
		nr_seq_mod_compra,				nr_controle_edital,					ds_dados_importacao
	from	ordem_compra
	where	nr_ordem_compra = nr_ordem_compra_orig_p;

	CALL inserir_historico_ordem_compra(
		nr_ordem_compra_w,
		'S',
		wheb_mensagem_pck.get_texto(299517),
		wheb_mensagem_pck.get_texto(299523,'DS_RETORNO='||nr_ordem_compra_orig_p),
		nm_usuario_p);

end if;

select	coalesce(max(nr_item_oci),0) +1
into STRICT	nr_item_oci_w
from	ordem_compra_item
where	nr_ordem_compra = nr_ordem_compra_w;

insert into ordem_compra_item(
	nr_ordem_compra,						nr_item_oci,					cd_material,
	cd_unidade_medida_compra,					vl_unitario_material,					qt_material,
	dt_atualizacao,						nm_usuario,					ie_situacao,
	cd_pessoa_solicitante,					qt_material_entregue,				pr_descontos,
	cd_local_estoque,						ds_material_direto,					ds_observacao,
	cd_motivo_alteracao,					nr_cot_compra,					nr_item_cot_compra,
	ds_marca,						vl_item_liquido,					/*nr_seq_aprovacao,*/
	/*dt_aprovacao,*/
						cd_centro_custo,					cd_conta_contabil,
	nr_solic_compra,						nr_item_solic_compra,				qt_conv_unid_fornec,
	ie_geracao_solic,						nr_seq_proj_rec,					pr_desc_financ,
	nr_seq_lic_item,						nr_seq_conta_financ,				qt_original,
	dt_validade,						nr_seq_marca,					dt_reprovacao,
	nr_seq_ordem_serv,					vl_ultima_compra,					vl_dif_ultima_compra,
	pr_dif_ultima_compra,					nr_seq_unidade_adic,				nr_seq_criterio_rateio,
	nr_serie_material,						nr_solic_compra_cancel,				vl_desconto,
	nr_seq_lote_fornec,						nr_seq_proj_gpi,					nr_seq_etapa_gpi,
	nr_seq_conta_gpi,						/*dt_aprovacao_orig,*/
					/*dt_reprovacao_orig,*/
	nr_contrato,						dt_inicio_garantia,					dt_fim_garantia,
	nr_id_integracao,						nr_seq_reg_lic_item,				nr_seq_conta_bco,
	nr_seq_prescr_item,						nr_empenho,					dt_empenho,
	nr_atendimento,							vl_total_item)
SELECT	nr_ordem_compra_w,					nr_item_oci_w,					cd_material,
	cd_unidade_medida_compra,					vl_unitario_material,					qt_material,
	clock_timestamp(),							nm_usuario_p,					ie_situacao,
	cd_pessoa_solicitante,					qt_material_entregue,				pr_descontos,
	cd_local_estoque,						ds_material_direto,					ds_observacao,
	cd_motivo_alteracao,					nr_cot_compra,					nr_item_cot_compra,
	ds_marca,						vl_item_liquido,					/*nr_seq_aprovacao,*/
	/*dt_aprovacao,*/
						cd_centro_custo,					cd_conta_contabil,
	nr_solic_compra,						nr_item_solic_compra,				qt_conv_unid_fornec,
	ie_geracao_solic,						nr_seq_proj_rec,					pr_desc_financ,
	nr_seq_lic_item,						nr_seq_conta_financ,				qt_original,
	dt_validade,						nr_seq_marca,					dt_reprovacao,
	nr_seq_ordem_serv,					vl_ultima_compra,					vl_dif_ultima_compra,
	pr_dif_ultima_compra,					nr_seq_unidade_adic,				nr_seq_criterio_rateio,
	nr_serie_material,						nr_solic_compra_cancel,				vl_desconto,
	nr_seq_lote_fornec,						nr_seq_proj_gpi,					nr_seq_etapa_gpi,
	nr_seq_conta_gpi,						/*dt_aprovacao_orig,*/
					/*dt_reprovacao_orig,*/
	nr_contrato,						dt_inicio_garantia,					dt_fim_garantia,
	nr_id_integracao,						nr_seq_reg_lic_item,				nr_seq_conta_bco,
	nr_seq_prescr_item,						nr_empenho,					dt_empenho,
	nr_atendimento,							round((qt_material * vl_unitario_material)::numeric,4)
from	ordem_compra_item
where	nr_ordem_compra = nr_ordem_compra_orig_p
and	nr_item_oci	= nr_item_oci_p;

insert into ordem_compra_item_entrega(
	nr_ordem_compra,						nr_item_oci,					dt_prevista_entrega,
	dt_real_entrega,						qt_prevista_entrega,				qt_real_entrega,
	dt_atualizacao,						nm_usuario,					ds_observacao,
	dt_cancelamento,						nr_sequencia,					ie_status_exportar,
	dt_entrega_original,						dt_entrega_limite,					dt_baixa)
SELECT	nr_ordem_compra_w,					nr_item_oci_w,					dt_prevista_entrega,
	dt_real_entrega,						qt_prevista_entrega,				qt_real_entrega,
	clock_timestamp(),							nm_usuario_p,					ds_observacao,
	dt_cancelamento,						nextval('ordem_compra_item_entrega_seq'),		ie_status_exportar,
	dt_entrega_original,						dt_entrega_limite,					dt_baixa
from	ordem_compra_item_entrega
where	nr_ordem_compra = nr_ordem_compra_orig_p
and	nr_item_oci	= nr_item_oci_p;

CALL inserir_historico_ordem_compra(
	nr_ordem_compra_orig_p,
	'S',
	wheb_mensagem_pck.get_texto(299535),
	wheb_mensagem_pck.get_texto(299536,'DS_RETORNO='||nr_item_oci_p),
	nm_usuario_p);

delete 	from ordem_compra_item
where	nr_ordem_compra = nr_ordem_compra_orig_p
and	nr_item_oci	= nr_item_oci_p;

	begin -- Inicio exception
	if (nr_ordem_compra_p = 0) and (nr_ordem_compra_w > 0) and (ie_permite_desdobrar_oc_lib_w = 'L') then
		begin
		CALL gerar_ordem_compra_venc(nr_ordem_compra_orig_p,nm_usuario_p);
		CALL gerar_ordem_compra_venc(nr_ordem_compra_w,nm_usuario_p);
		calcular_liquido_ordem_compra(nr_ordem_compra_w, nm_usuario_p);
		end;
	end if;
	exception when others then
		null;
	end; -- Fim exception
nr_ordem_compra_p := nr_ordem_compra_w;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desdobrar_itens_ordem_compra ( nr_ordem_compra_p INOUT bigint, nr_ordem_compra_orig_p bigint, nr_item_oci_p bigint, nm_usuario_p text) FROM PUBLIC;

