-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_cob_santand_sem_reg_400 (nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p text, nm_usuario_p text) AS $body$
DECLARE

					 
--	ABN-AMRO  Bank 
--	Troca de arquivos	Cobrança	Sem Registro 
--	V. 1.0.0 02/04/97 
--	400 
 
-- Geral 
ds_conteudo_w		varchar(400) 	:='';	
nr_seq_reg_arq_w	integer 	:=0;
nr_sequencia_arq_w	smallint 	:=0;
nr_sequencia_w		bigint 	:=0;

-- Header 
cd_agencia_ced_w	varchar(4);
cd_conta_ced_w		varchar(7);
nm_sacado_ced_w		varchar(30);
nm_banco_w		varchar(15);
dt_geracao_w		varchar(6);
	
-- Transação 
ie_tipo_inscricao_w	varchar(2);
cd_inscricao_w		varchar(8);
nr_filial_w		varchar(4);
nr_controle_w		varchar(2);
nr_titulo_w		varchar(13);
dt_vencimento_w		varchar(6);
vl_titulo_w		varchar(13);
cd_banco_w		varchar(3);
cd_especie_tit_w	varchar(2);
dt_emissao_w		varchar(6);
vl_juros_diario_w	varchar(13);
dt_desconto_w		varchar(6);
vl_desconto_w		varchar(13);
vl_ioc_w		varchar(13);
vl_abatimento_w		varchar(13);
ie_tipo_sacado_w	varchar(2);
cd_inscricao_sacado_w	varchar(14);
nm_sacado_w		varchar(40);
ds_endereco_sacado_w	varchar(40);
ds_bairro_sacado_w	varchar(12);
cd_cep_sacado_w		varchar(8);
ds_municipio_sacado_w	varchar(15);
ds_estado_sacado_w	varchar(2);
nm_sacador_w		varchar(40);
vl_moeda_w		varchar(1);
ie_moeda_w		varchar(1);

-- Mensagens	 
ds_mensagen_01_w	varchar(69);
ds_mensagen_02_w	varchar(69);
ds_mensagen_03_w	varchar(69);
ds_mensagen_04_w	varchar(69);
ds_mensagen_05_w	varchar(69);
	
-- Trailler 
qt_titulos_w		integer 	:=0;
vl_total_w		bigint	:=0;
	
-- Vazios - Zeros 
ds_vazio_7_w		varchar(7);
ds_vazio_282_w		varchar(282);
ds_vazio_374_w		varchar(374);
ds_zeros_1_w		varchar(1);
ds_vazio_32_w		varchar(32);
ds_zeros_2_w		varchar(2);
ds_vazio_31_w		varchar(31);
ds_vazio_10_w		varchar(10);
ds_vazio_5_w		varchar(5);
ds_vazio_1_w		varchar(1);	
ds_vazio_4_w		varchar(4);
ds_brancos_16_w		varchar(16);
		
C01 CURSOR FOR 
/*Header*/
	SELECT	rpad(upper(elimina_acentuacao(substr(b.nm_pessoa,1,30))),30,' ') nm_sacado, 
		rpad(substr(obter_nome_banco(x.cd_banco),1,15),15,' ') nm_banco, 
		to_char(clock_timestamp(), 'ddmmyy') dt_geracao, 
/*Transação*/
	CASE WHEN coalesce(b.cd_cgc::text, '') = '' THEN '01'  ELSE '02' END  ie_tipo_inscricao, 
		lpad(coalesce(substr(b.cd_cgc_cpf,1,8),'0'),8,'0') cd_inscricao, 
		'0000' nr_filial, 
		'00' nr_controle, 
		lpad(to_char(c.cd_agencia_bancaria),4,'0') cd_agencia_ced, 
		lpad(substr(c.nr_conta,1,7),7,'0') cd_conta_ced, 
		rpad(substr(b.nr_titulo,1,13),13,'0') nr_titulo, 
		to_char(coalesce(b.dt_pagamento_previsto, b.dt_vencimento),'ddmmyy') dt_vencimento, 
		lpad(coalesce(elimina_caracteres_especiais(b.vl_titulo),0),13,'0') vl_titulo, 
		lpad(substr(x.cd_banco,1,3),3,' ') cd_banco, 
		'00' cd_especie_tit, 
		to_char(b.dt_emissao,'ddmmyy') dt_emissao, 
		lpad(coalesce(elimina_caracteres_especiais(obter_vl_juros_diario_tit(null,b.nr_titulo)),0),13,'0') vl_juros_diario, 
		to_char(clock_timestamp(),'ddmmyy') dt_desconto, 
		lpad('0',13,'0') vl_desconto_dia, 
		lpad('0',13,'0') vl_ioc, 
		lpad('0',13,'0') vl_abatimento, 
		CASE WHEN coalesce(b.cd_cgc::text, '') = '' THEN '01'  ELSE '02' END  ie_tipo_sacado_w, 
		lpad(coalesce(b.cd_cgc_cpf,'0'),14,'0') cd_inscricao_sacado_w, 
		rpad(upper(elimina_acentuacao(substr(b.nm_pessoa,1,40))),40,' ') nm_sacado, 
		rpad(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'E')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'E') END ,1,40),40,' ') ds_endereco_sacado, 
		rpad(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'B')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'B') END ,1,12),12,' ') ds_bairro_sacado, 
		lpad(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CEP')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'CEP') END ,1,8),8,'0') cd_cep_sacado, 
		rpad(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'CI')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'CI') END ,1,15),15,' ') ds_municipio_sacado, 
		rpad(substr(CASE WHEN coalesce(d.nr_sequencia::text, '') = '' THEN  			obter_dados_pf_pj(b.cd_pessoa_fisica, b.cd_cgc, 'UF')  ELSE pls_obter_compl_pagador(d.nr_seq_pagador,'UF') END ,1,2),2,' ') ds_estado_sacado, 
		lpad(' ',40,' ') nm_sacador, 
		'7' vl_moeda, 
		'7' ie_moeda, 
/*Mensagens*/
	rpad(coalesce(substr(obter_instrucao_boleto(b.nr_titulo,1,1),1,69),' '),69,' ') ds_mensagen_01, 
		rpad(coalesce(substr(obter_instrucao_boleto(b.nr_titulo,1,2),1,69),' '),69,' ') ds_mensagen_02, 
		rpad(coalesce(substr(obter_instrucao_boleto(b.nr_titulo,1,3),1,69),' '),69,' ') ds_mensagen_03, 
		rpad(coalesce(substr(obter_instrucao_boleto(b.nr_titulo,1,4),1,69),' '),69,' ') ds_mensagen_04, 
		rpad(coalesce(substr(obter_instrucao_boleto(b.nr_titulo,1,5),1,69),' '),69,' ') ds_mensagen_05 
	FROM banco_estabelecimento x, titulo_receber_cobr c, cobranca_escritural a, titulo_receber_v b
LEFT OUTER JOIN pls_mensalidade d ON (b.nr_seq_mensalidade = d.nr_sequencia)
LEFT OUTER JOIN banco_carteira e ON (b.nr_seq_carteira_cobr = e.nr_sequencia)
LEFT OUTER JOIN pls_contrato_pagador f ON (d.nr_seq_pagador = f.nr_sequencia)
WHERE a.nr_sequencia		= c.nr_seq_cobranca and c.nr_titulo		= b.nr_titulo and a.nr_seq_conta_banco	= x.nr_sequencia    and a.nr_sequencia		= nr_seq_cobr_escrit_p;				
			 

BEGIN 
delete from w_envio_banco where nm_usuario = nm_usuario_p;
 
-- Vazios - Zeros 
select	rpad(' ',7,' '), 
	rpad(' ',282,' '), 
	rpad(' ',374,' '), 
	rpad('0',1,'0'), 
	rpad(' ',32,' '), 
	rpad('0',2,'0'), 
	rpad(' ',31,' '), 
	rpad(' ',10,' '), 
	rpad(' ',5,' '), 
	rpad(' ',1,' '), 
	rpad(' ',4,' '), 
	rpad(' ',16,' ') 
into STRICT	ds_vazio_7_w, 
	ds_vazio_282_w, 
	ds_vazio_374_w, 
	ds_zeros_1_w, 
	ds_vazio_32_w, 
	ds_zeros_2_w, 
	ds_vazio_31_w, 
	ds_vazio_10_w, 
	ds_vazio_5_w, 
	ds_vazio_1_w, 
	ds_vazio_4_w, 
	ds_brancos_16_w
;
 
open C01;
loop 
fetch C01 into	 
	nm_sacado_ced_w, 
	nm_banco_w, 
	dt_geracao_w, 
	ie_tipo_inscricao_w, 
	cd_inscricao_w, 
	nr_filial_w, 
	nr_controle_w, 
	cd_agencia_ced_w, 
	cd_conta_ced_w, 
	nr_titulo_w, 
	dt_vencimento_w, 
	vl_titulo_w, 
	cd_banco_w, 
	cd_especie_tit_w, 
	dt_emissao_w, 
	vl_juros_diario_w, 
	dt_desconto_w, 
	vl_desconto_w, 
	vl_ioc_w, 
	vl_abatimento_w, 
	ie_tipo_sacado_w, 
	cd_inscricao_sacado_w, 
	nm_sacado_w, 
	ds_endereco_sacado_w, 
	ds_bairro_sacado_w, 
	cd_cep_sacado_w, 
	ds_municipio_sacado_w, 
	ds_estado_sacado_w, 
	nm_sacador_w, 
	vl_moeda_w, 
	ie_moeda_w, 
	ds_mensagen_01_w, 
	ds_mensagen_02_w, 
	ds_mensagen_03_w, 
	ds_mensagen_04_w, 
	ds_mensagen_05_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	-- Header 
	nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
	nr_sequencia_arq_w := nr_sequencia_arq_w + 1;
 
	ds_conteudo_w	:=	'0' 				|| 
				'1REMESSA01COBRANCA    '	|| 
				'0'				|| 
				cd_agencia_ced_w		|| 
				'0'				|| 
				cd_conta_ced_w			|| 
				ds_vazio_7_w			|| 
				nm_sacado_ced_w			|| 
				cd_banco_w			|| 
				nm_banco_w			|| 
				dt_geracao_w			|| 
				'01600BPI'			|| 
				ds_vazio_282_w			|| 
				lpad(nr_sequencia_arq_w,4,'0')	|| 
				lpad(nr_seq_reg_arq_w,6,'0');
				 
	select	nextval('w_envio_banco_seq') 
	into STRICT	nr_sequencia_w 
	;
 
	insert into w_envio_banco(	nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			cd_estabelecimento, 
			ds_conteudo, 
			nr_seq_apres) 
	values (	nr_sequencia_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			cd_estabelecimento_p, 
			ds_conteudo_w, 
			1);
	 
	-- Transação 
	nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
	 
	ds_conteudo_w :=	'1'				|| 
				ie_tipo_inscricao_w		|| 
				cd_inscricao_w			|| 
				nr_filial_w			|| 
				nr_controle_w			|| 
				ds_zeros_1_w			|| 
				cd_agencia_ced_w		|| 
				ds_zeros_1_w			|| 
				cd_conta_ced_w			|| 
				ds_vazio_32_w			|| 
				ds_zeros_2_w			|| 
				nr_titulo_w			|| 
				ds_vazio_31_w			|| 
				'01'				|| 
				ds_vazio_10_w			|| 
				dt_vencimento_w			|| 
				vl_titulo_w			|| 
				cd_banco_w			|| 
				ds_vazio_5_w			|| 
				cd_especie_tit_w		||		 
				ds_vazio_1_w			|| 
				dt_emissao_w			|| 
				ds_vazio_4_w			|| 
				vl_juros_diario_w		|| 
				dt_desconto_w			|| 
				vl_desconto_w			|| 
				vl_ioc_w			|| 
				vl_abatimento_w			|| 
				ie_tipo_sacado_w		|| 
				cd_inscricao_sacado_w		|| 
				nm_sacado_w			|| 
				ds_endereco_sacado_w		|| 
				ds_bairro_sacado_w		|| 
				cd_cep_sacado_w			|| 
				ds_municipio_sacado_w		|| 
				ds_estado_sacado_w		|| 
				nm_sacador_w			|| 
				ds_vazio_1_w			|| 
				vl_moeda_w			|| 
				ie_moeda_w			|| 
				lpad(nr_seq_reg_arq_w,6,'0');	
				 
	select	nextval('w_envio_banco_seq') 
	into STRICT	nr_sequencia_w 
	;
	 
	insert into w_envio_banco(	nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			cd_estabelecimento, 
			ds_conteudo, 
			nr_seq_apres) 
	values (	nr_sequencia_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			cd_estabelecimento_p, 
			ds_conteudo_w, 
			2);
	 
	vl_total_w 	:= vl_total_w + vl_titulo_w;
	qt_titulos_w 	:= qt_titulos_w + 1;
	 
	-- Mensagens 
	nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
	 
	ds_conteudo_w :=	'7'				|| 
				'0'				|| 
				cd_agencia_ced_w		|| 
				cd_conta_ced_w			|| 
				ds_zeros_2_w			|| 
				nr_titulo_w			|| 
				ds_mensagen_01_w		|| 
				'0'				|| 
				ds_mensagen_02_w		|| 
				'0'				|| 
				ds_mensagen_03_w		|| 
				'0'				|| 
				ds_mensagen_04_w		|| 
				'0'				|| 
				ds_mensagen_05_w		|| 
				'0'				|| 
				ds_brancos_16_w			|| 
				lpad(nr_seq_reg_arq_w,6,'0');
				 
	select	nextval('w_envio_banco_seq') 
	into STRICT	nr_sequencia_w 
	;
	 
	insert into w_envio_banco(	nr_sequencia, 
			dt_atualizacao, 
			nm_usuario, 
			dt_atualizacao_nrec, 
			nm_usuario_nrec, 
			cd_estabelecimento, 
			ds_conteudo, 
			nr_seq_apres) 
	values (	nr_sequencia_w, 
			clock_timestamp(), 
			nm_usuario_p, 
			clock_timestamp(), 
			nm_usuario_p, 
			cd_estabelecimento_p, 
			ds_conteudo_w, 
			3);
	end;
end loop;
close C01;
 
-- Trailler 
nr_seq_reg_arq_w := nr_seq_reg_arq_w + 1;
 
ds_conteudo_w :=	'9'				|| 
			lpad(qt_titulos_w,6,'0')	|| 
			lpad(vl_total_w,13,'0')	|| 
			ds_vazio_374_w			|| 
			lpad(nr_seq_reg_arq_w,6,'0');
 
select	nextval('w_envio_banco_seq') 
into STRICT	nr_sequencia_w
;
			 
insert into w_envio_banco(	nr_sequencia, 
		dt_atualizacao, 
		nm_usuario, 
		dt_atualizacao_nrec, 
		nm_usuario_nrec, 
		cd_estabelecimento, 
		ds_conteudo, 
		nr_seq_apres) 
values (	nr_sequencia_w, 
		clock_timestamp(), 
		nm_usuario_p, 
		clock_timestamp(), 
		nm_usuario_p, 
		cd_estabelecimento_p, 
		ds_conteudo_w, 
		4);
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_cob_santand_sem_reg_400 (nr_seq_cobr_escrit_p bigint, cd_estabelecimento_p text, nm_usuario_p text) FROM PUBLIC;

