-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_etapa_checkup ( nr_seq_checkup_p bigint, nr_seq_etapa_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w			bigint;
qt_min_prev_w			bigint;
ie_tipo_etapa_w			varchar(15);
cd_profissional_w		varchar(15);
dt_prevista_w			timestamp;
dt_retorno_w			timestamp;
nr_seq_etapa_w			bigint;
dt_prev_aux_w			timestamp;


BEGIN

select	qt_min_prev,
	ie_tipo_etapa,
	cd_profissional
into STRICT	qt_min_prev_w,
	ie_tipo_etapa_w,
	cd_profissional_w
from	etapa_checkup
where	nr_sequencia = nr_seq_etapa_p;

select	dt_previsto
into STRICT	dt_prevista_w
from	checkup
where	nr_sequencia	= nr_seq_checkup_p;

dt_retorno_w	:= dt_prevista_w;

if (ie_tipo_etapa_w = 'R') then
	dt_prevista_w	:= dt_retorno_w + (qt_min_prev_w / 1440);
end if;

select	nextval('checkup_etapa_seq')
into STRICT	nr_seq_etapa_w
;

if (qt_min_prev_w < 0) then
	dt_prevista_w	:= dt_prevista_w + (qt_min_prev_w / 1440);
end if;

insert into checkup_etapa(
	nr_sequencia,
	nr_seq_checkup,
	dt_atualizacao,
	nm_usuario,
	nr_seq_etapa,
	dt_prevista,
	cd_pessoa_fisica)
Values (	nr_seq_etapa_w,
	nr_seq_checkup_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_etapa_p,
	dt_prevista_w,
	CASE WHEN cd_profissional_w='' THEN null  ELSE cd_profissional_w END );

/*dt_prevista_w	:= dt_prev_aux_w;

if	(qt_min_prev_w > 0) then
	dt_prevista_w := dt_prevista_w + (qt_min_prev_w / 1440);
end if;	*/
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_etapa_checkup ( nr_seq_checkup_p bigint, nr_seq_etapa_p bigint, nm_usuario_p text) FROM PUBLIC;

