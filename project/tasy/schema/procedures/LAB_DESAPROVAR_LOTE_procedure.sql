-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE lab_desaprovar_lote ( nr_seq_lote_p bigint, nm_usuario_p text) AS $body$
DECLARE


qt_lote_w		        bigint;
qt_resultado_w		  bigint;
nr_prescricao_w		  bigint;
nr_seq_prescr_w		  bigint;
nr_seq_resultado_w	bigint;
nr_Seq_Assinatura_w bigint;

C01 CURSOR FOR
	SELECT a.nr_prescricao,
		a.nr_seq_prescr,
    d.nr_seq_assinatura,
    d.nr_seq_resultado
	from	Lab_Lote_Exame_Item a,
		prescr_procedimento b,
		exame_lab_resultado c,
		exame_lab_result_item d
	where	a.nr_seq_lote = nr_seq_lote_p
	and	b.nr_prescricao = a.nr_prescricao
	and	b.nr_sequencia = a.nr_seq_prescr
	and	c.nr_prescricao = b.nr_prescricao
	and	c.nr_seq_resultado = d.nr_seq_resultado
	and	b.nr_sequencia = d.nr_seq_prescr
	and	b.ie_status_atend >= 35;


BEGIN

open c01;
loop
fetch c01 into	nr_prescricao_w,
                nr_seq_prescr_w,
                nr_seq_assinatura_w,
                nr_seq_resultado_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	CALL Desfazer_LAB_Aprovacao(nr_prescricao_w, nr_seq_prescr_w, nm_usuario_p, 'S');

  if (nr_seq_assinatura_w IS NOT NULL AND nr_seq_assinatura_w::text <> '') then
    update exame_lab_result_item
       set nr_Seq_Assinatura  = NULL
	 	 where nr_sequencia      = nr_seq_prescr_w
       and nr_seq_resultado  = nr_seq_resultado_w
       and (nr_seq_material IS NOT NULL AND nr_seq_material::text <> '');
  end if;

end loop;
close c01;

update lab_lote_exame
set ie_status = 'D'
where nr_sequencia = nr_seq_lote_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE lab_desaprovar_lote ( nr_seq_lote_p bigint, nm_usuario_p text) FROM PUBLIC;

