-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE aprovacao_automatica_compra ( nr_sequencia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_seq_proc_aprov_w			bigint	:= 0;
vl_minimo_w				double precision	:= 0;
vl_maximo_w				double precision	:= 0;
vl_ordem_compra_w			double precision	:= 0;
vl_solic_compra_w			double precision	:= 0;
nr_ordem_compra_w			bigint;
nr_solic_compra_w			bigint;
cd_estabelecimento_w			smallint;
ie_valor_maximo_aprov_w			varchar(1) := 'N';
ie_teto_aprovacao_w			varchar(1) := 'N';
cd_moeda_padrao_w			bigint;
cd_moeda_w				integer;
ie_aprov_regra_minimo_w			varchar(1);
ie_tipo_servico_w			varchar(15);
cd_centro_custo_w			integer;
cd_conta_contabil_w			varchar(20);
dt_solicitacao_compra_w			timestamp;
nr_seq_mes_ref_w			bigint;
vl_empenhado_w				double precision;
vl_orcado_w				double precision;
vl_diferenca_w				double precision := 0;
dt_aprovacao_w				timestamp;
ie_aprovacao_nivel_w			processo_aprovacao.ie_aprovacao_nivel%type := 'N';
nr_nivel_aprovacao_w			processo_aprov_resp.nr_nivel_aprovacao%type;
cd_processo_aprov_w			processo_aprov_resp.cd_processo_aprov%type;
nr_documento_w            		processo_aprov_compra.nr_documento%type;
qt_nova_estrutura_w        		bigint;

c01 CURSOR FOR
SELECT	p.nr_seq_proc_aprov /*Para aprovar todos os procesos inferiores ao cargo da pessoa*/
from	processo_aprov_compra p
where 	p.nr_sequencia = nr_sequencia_p
and	ie_aprov_regra_minimo_w	in ('N','A','T')
and	p.nr_seq_proc_aprov <= (
	SELECT	coalesce(max(x.nr_seq_proc_aprov),0)
	from	Processo_aprov_Compra x
	where	x.nr_sequencia	= nr_sequencia_p
	and	((obter_se_proc_usu_fixo(x.nr_seq_proc_aprov, nm_usuario_p, nr_sequencia_p) = 'F') or
		 (cd_cargo = (	select	coalesce(cd_cargo,0)
				from	pessoa_fisica b,
					usuario a
				where	a.cd_pessoa_fisica = b.cd_pessoa_fisica
				and	a.nm_usuario  = nm_usuario_p))))

union all

select	p.nr_seq_proc_aprov
from	processo_aprov_compra p
where 	p.nr_sequencia	= nr_sequencia_p
and	ie_aprov_regra_minimo_w	= 'S'
and	p.nr_seq_proc_aprov = (
	select	coalesce(max(x.nr_seq_proc_aprov),0)
	from	Processo_aprov_Compra x
	where	x.nr_sequencia	= nr_sequencia_p
	and	((obter_se_proc_usu_fixo(x.nr_seq_proc_aprov, nm_usuario_p, nr_sequencia_p) = 'F') or
		 (cd_cargo = (	select	coalesce(cd_cargo,0)
				from	pessoa_fisica b,
					usuario a
				where	a.cd_pessoa_fisica = b.cd_pessoa_fisica
				and	a.nm_usuario  = nm_usuario_p))))
order by 1;	

c02 CURSOR FOR
SELECT	a.nr_seq_proc_aprov,
        coalesce(a.vl_minimo, 0),
        coalesce(a.vl_maximo, 9999999999999)
from	Processo_compra b,
        Processo_aprov_Compra a
where 	a.nr_sequencia	= nr_sequencia_p
and	a.nr_sequencia	= b.nr_sequencia
and     a.nr_documento  = nr_documento_w
and (SELECT obter_estrutura_aprovacao(a.nr_seq_proc_aprov, nr_documento_w) ) = 1

union

select	a.nr_seq_proc_aprov,
	coalesce(c.vl_minimo, 0),
	coalesce(c.vl_maximo, 9999999999999)
from	Processo_aprov_Resp c,
	Processo_compra b,
	Processo_aprov_Compra a
where 	a.nr_sequencia		= nr_sequencia_p
and	a.nr_sequencia		= b.nr_sequencia
and	b.cd_processo_aprov	= c.cd_processo_aprov
and	a.nr_seq_proc_aprov	= c.nr_sequencia
and (select obter_estrutura_aprovacao(a.nr_seq_proc_aprov, nr_documento_w) ) = 0
order by nr_seq_proc_aprov;


c03 CURSOR FOR
SELECT  a.nr_seq_proc_aprov
from    processo_aprov_compra a
where   a.cd_processo_aprov = cd_processo_aprov_w
and   	a.nr_nivel_aprovacao < nr_nivel_aprovacao_w
and     a.nr_documento = nr_documento_w

union

SELECT  b.nr_sequencia
from    processo_aprov_resp b
where   b.cd_processo_aprov = cd_processo_aprov_w
and   	b.nr_nivel_aprovacao < nr_nivel_aprovacao_w
and (select obter_estrutura_aprovacao(b.nr_sequencia, nr_documento_w) ) = 0
order by 1;


BEGIN

select	coalesce(max(obter_estab_processo_aprov(nr_sequencia_p)), 1)
into STRICT	cd_estabelecimento_w
;

select	coalesce(max(ie_aprov_regra_minimo), 'N')
into STRICT	ie_aprov_regra_minimo_w
from	parametro_compras
where	cd_estabelecimento	= cd_estabelecimento_w;


select	max(p.nr_seq_proc_aprov),
	max(p.nr_documento)
into STRICT	nr_seq_proc_aprov_w,
	nr_documento_w
from	processo_aprov_compra p
where 	p.nr_sequencia = nr_sequencia_p
and     cd_pessoa_fisica = obter_pessoa_fisica_usuario(nm_usuario_p,'C');


select 	obter_estrutura_aprovacao(nr_seq_proc_aprov_w, nr_documento_w)
into STRICT	qt_nova_estrutura_w
;

if (qt_nova_estrutura_w > 0) then

	select 	coalesce(max(a.ie_aprovacao_nivel),'N')
	into STRICT	ie_aprovacao_nivel_w
	from  	processo_aprovacao a
	where 	a.cd_processo_aprov = (	SELECT	max(x.cd_processo_aprov)
					from	processo_aprov_compra x
					where 	x.nr_sequencia = nr_sequencia_p
					and	x.nr_documento = nr_documento_w
					and	ie_aprov_regra_minimo_w	in ('N','A','T')
					and     x.cd_pessoa_fisica = obter_pessoa_fisica_usuario(nm_usuario_p,'C'));
else
	select 	coalesce(max(a.ie_aprovacao_nivel),'N')
	into STRICT	ie_aprovacao_nivel_w
	from  	processo_aprovacao a
	where 	a.cd_processo_aprov = (	SELECT 	max(x.cd_processo_aprov)
					from 	processo_aprov_resp x
					where 	x.nr_sequencia = (select	max(p.nr_seq_proc_aprov)
								  from		processo_aprov_compra p
								  where		p.nr_sequencia = nr_sequencia_p
								  and		ie_aprov_regra_minimo_w	in ('N','A','T')
								  and     	p.cd_pessoa_fisica = obter_pessoa_fisica_usuario(nm_usuario_p,'C')));
end if;
								
/* Se aprovacao por Nivel ou Nivel com valores */
	
if (ie_aprovacao_nivel_w in ('S', 'A')) then
	
	if (nr_seq_proc_aprov_w IS NOT NULL AND nr_seq_proc_aprov_w::text <> '') then
		CALL aprovar_compra( nr_sequencia_p, nr_seq_proc_aprov_w, nm_usuario_p, 'S', 'N');
	end if;
	
	if (qt_nova_estrutura_w > 0) then
	
		select 	nr_nivel_aprovacao,
			cd_processo_aprov
		into STRICT	nr_nivel_aprovacao_w,	
			cd_processo_aprov_w	
		from 	processo_aprov_compra
		where 	nr_documento = nr_documento_w
		and	nr_seq_proc_aprov = (SELECT	max(p.nr_seq_proc_aprov)
					     from	processo_aprov_compra p
					     where 	p.nr_sequencia = nr_sequencia_p
					     and	ie_aprov_regra_minimo_w	in ('N','A','T')
					     and     cd_pessoa_fisica = obter_pessoa_fisica_usuario(nm_usuario_p,'C'));
	else
		select 	nr_nivel_aprovacao,
			cd_processo_aprov
		into STRICT	nr_nivel_aprovacao_w,	
			cd_processo_aprov_w	
		from 	processo_aprov_resp
		where 	nr_sequencia = (SELECT	max(p.nr_seq_proc_aprov)
					from	processo_aprov_compra p
					where 	p.nr_sequencia = nr_sequencia_p
					and	ie_aprov_regra_minimo_w	in ('N','A','T')
					and     cd_pessoa_fisica = obter_pessoa_fisica_usuario(nm_usuario_p,'C'));
end if;
	open c03;
	loop
	fetch c03 into
		nr_seq_proc_aprov_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		begin
		CALL aprovar_compra( nr_sequencia_p, nr_seq_proc_aprov_w, nm_usuario_p, 'S', 'N');
		end;
	end loop;
	close c03;
end if;

/* Se aprovacao por Valores ou Nivel com valores */
	
if (ie_aprovacao_nivel_w in ('N', 'A')) then
	/* Aprovar processos em que o usuario que liberou a solicitacao ou Ordem */


	/* e aprovador do processo */

	open c01;
	loop
	fetch c01 into
		nr_seq_proc_aprov_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		CALL aprovar_compra( nr_sequencia_p, nr_seq_proc_aprov_w, nm_usuario_p, 'S', 'N');
		end;
	end loop;
	close c01;
end if;

/* Aprovar processos em que o valor minimo nao seja superior ao  */


/* Padrao do processo */

open c02;
loop
fetch c02 into
	nr_seq_proc_aprov_w,
	vl_minimo_w,
	vl_maximo_w;
EXIT WHEN NOT FOUND; /* apply on c02 */
	begin
	
	begin
	select	coalesce(sum(coalesce(vl_unit_previsto,0) * coalesce(qt_material,0)),0),
		coalesce(max(nr_solic_compra),0)
	into STRICT	vl_solic_compra_w,
		nr_solic_compra_w
	from	solic_compra_item
	where	nr_seq_aprovacao = nr_sequencia_p;
	
	if (nr_solic_compra_w > 0) then
		
		select	ie_tipo_servico,
			cd_centro_custo,
			cd_conta_contabil,
			dt_solicitacao_compra
		into STRICT	ie_tipo_servico_w,
			cd_centro_custo_w,
			cd_conta_contabil_w,
			dt_solicitacao_compra_w
		from	solic_compra
		where	nr_solic_compra = nr_solic_compra_w;
		
		if (ie_tipo_servico_w in ('SN','CD')) then
			select	max(nr_sequencia)
			into STRICT	nr_seq_mes_ref_w
			from	ctb_mes_ref
			where	PKG_DATE_UTILS.START_OF(dt_referencia,'month') = PKG_DATE_UTILS.START_OF(dt_solicitacao_compra_w,'month')
            and cd_empresa = obter_empresa_estab(cd_estabelecimento_w);

			select	coalesce(ctb_obter_empenho_orcamento(nr_seq_mes_ref_w, cd_conta_contabil_w, cd_centro_custo_w, cd_Estabelecimento_w),0)  vl_empenhado,
				coalesce(ctb_obter_valor_orcado(PKG_DATE_UTILS.START_OF(dt_solicitacao_compra_w,'month'), cd_conta_contabil_w, cd_centro_custo_w, cd_Estabelecimento_w),0) vl_orcado
			into STRICT	vl_empenhado_w,
				vl_orcado_w
			;			
			
			if (vl_orcado_w > 0) then
				vl_diferenca_w	:= vl_orcado_w - vl_empenhado_w - vl_solic_compra_w;
			else
				vl_diferenca_w := 0;
			end if;
			
			if (vl_diferenca_w < 0) then
				vl_solic_compra_w := abs(vl_diferenca_w);
			end if;				
		end if;
	end if;	
	
	exception when others then
		vl_solic_compra_w		:= 0;
	end;
	
	begin
	select	coalesce(sum(vl_item_liquido),0),
		coalesce(max(nr_ordem_compra),0)
	into STRICT	vl_ordem_compra_w,
		nr_ordem_compra_w
	from	ordem_compra_item	
	where	nr_seq_aprovacao = nr_sequencia_p
	and		obter_qt_pend_ordem_entrega(nr_ordem_compra, nr_item_oci) > 0;
	exception when others then
		vl_ordem_compra_w		:= 0;
	end;	
	
	if (nr_solic_compra_w > 0) then
		select	coalesce(max(cd_estabelecimento),0)
		into STRICT	cd_estabelecimento_w
		from	solic_compra
		where	nr_solic_compra = nr_solic_compra_w;
	elsif (nr_ordem_compra_w > 0) then
		select	coalesce(max(cd_estabelecimento),0)
		into STRICT	cd_estabelecimento_w
		from	ordem_compra
		where	nr_ordem_compra = nr_ordem_compra_w;
	end if;
		
	if (cd_estabelecimento_w > 0) then
		select	coalesce(max(ie_valor_maximo_aprov),'N'),
			coalesce(max(ie_teto_aprovacao),'N'),
			coalesce(max(cd_moeda_padrao), 0)
		into STRICT	ie_valor_maximo_aprov_w,
			ie_teto_aprovacao_w,
			cd_moeda_padrao_w
		from	parametro_compras
		where	cd_estabelecimento = cd_estabelecimento_w;
	end if;

	/*Tratamento para valores com moeda estrangeira na OC*/

	if (nr_ordem_compra_w > 0) then
		begin
		select	coalesce(max(cd_moeda), 0)
		into STRICT	cd_moeda_w
		from	ordem_compra
		where	nr_ordem_compra	= nr_ordem_compra_w;

		if (coalesce(cd_moeda_w, 0) <> coalesce(cd_moeda_padrao_w, 0)) then
			begin
			vl_ordem_compra_w	:= obter_conversao_moeda(
							vl_ordem_compra_w,
							cd_moeda_w,
							clock_timestamp(),
							'EN');
			exception when others then
				vl_ordem_compra_w	:= vl_ordem_compra_w;
			end;
		end if;
		end;
	end if;
	
	if (ie_teto_aprovacao_w = 'S') and (ie_valor_maximo_aprov_w = 'S') then
		
		if	((vl_ordem_compra_w + vl_solic_compra_w) < vl_minimo_w) then
					
			if (nr_ordem_compra_w > 0) then
				select	dt_aprovacao
				into STRICT	dt_aprovacao_w
				from	ordem_compra
				where	nr_ordem_compra = nr_ordem_compra_w;
			end if;
			
			if (nr_solic_compra_w > 0) then
				select	dt_autorizacao
				into STRICT	dt_aprovacao_w
				from	solic_compra
				where	nr_solic_compra = nr_solic_compra_w;
			end if;
			
			if (coalesce(dt_aprovacao_w::text, '') = '') then
				CALL aprovar_compra(nr_sequencia_p, nr_seq_proc_aprov_w, nm_usuario_p, 'S', 'N');
			end if;

		end if;

	elsif (ie_teto_aprovacao_w = 'N') and (ie_valor_maximo_aprov_w = 'S') then

		if	(((vl_ordem_compra_w + vl_solic_compra_w) < vl_minimo_w) or
			((vl_ordem_compra_w + vl_solic_compra_w) > vl_maximo_w)) then
			
			if (nr_ordem_compra_w > 0) then
				select	dt_aprovacao
				into STRICT	dt_aprovacao_w
				from	ordem_compra
				where	nr_ordem_compra = nr_ordem_compra_w;
			end if;
			
			if (nr_solic_compra_w > 0) then
				select	dt_autorizacao
				into STRICT	dt_aprovacao_w
				from	solic_compra
				where	nr_solic_compra = nr_solic_compra_w;
			end if;
			
			if (coalesce(dt_aprovacao_w::text, '') = '') then
				CALL aprovar_compra(nr_sequencia_p, nr_seq_proc_aprov_w, nm_usuario_p, 'S', 'N');
			end if;
		end if;
	else
		if	((vl_ordem_compra_w + vl_solic_compra_w) < vl_minimo_w) then
			
			if (nr_ordem_compra_w > 0) then
				select	dt_aprovacao
				into STRICT	dt_aprovacao_w
				from	ordem_compra
				where	nr_ordem_compra = nr_ordem_compra_w;
			end if;
			
			if (nr_solic_compra_w > 0) then
				select	dt_autorizacao
				into STRICT	dt_aprovacao_w
				from	solic_compra
				where	nr_solic_compra = nr_solic_compra_w;
			end if;

			if (coalesce(dt_aprovacao_w::text, '') = '') then
				CALL aprovar_compra( nr_sequencia_p, nr_seq_proc_aprov_w, nm_usuario_p, 'S', 'N');
			end if;
		end if;
	end if;
	end;
end loop;
close c02;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE aprovacao_automatica_compra ( nr_sequencia_p bigint, nm_usuario_p text) FROM PUBLIC;

