-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_tecnica_anestesica_java ( nr_seq_tec_p bigint, nm_usuario_p text, nr_cirurgia_p bigint, cd_profissional_p text, nr_seq_pepo_p bigint, ds_txt_p text, ie_insere_desc_p text, nr_sequencia_p INOUT bigint) AS $body$
DECLARE
	

ie_registra_desc_w 		char(1);
ie_registra_desc_tec_w 	char(1);
qt_descricao_w 			bigint;
ds_texto_padrao_w		tecnica_anestesica.ds_texto_padrao_clob%type;
nr_seq_tecnica_w 		bigint;
nr_seq_descricao_w 		bigint;
nr_seq_anest_desc_w		anestesia_descricao.nr_sequencia%type;
nr_seq_tipo_avaliacao_w med_tipo_avaliacao.nr_sequencia%type;
ie_liberar_w varchar(1) := 'N';

BEGIN
ie_registra_desc_w := Obter_Param_Usuario(872, 25, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_registra_desc_w);
ie_registra_desc_tec_w := Obter_Param_Usuario(872, 269, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_registra_desc_tec_w);
	/*  
	Conta a quantidade das descricoes
	*/
begin
	select	count(*)
	into STRICT	qt_descricao_w
	from	anestesia_descricao
	where	((nr_cirurgia = nr_cirurgia_p)
	or (nr_seq_pepo = nr_seq_pepo_p))
	and		nm_usuario = nm_usuario_p
	and		coalesce(dt_liberacao::text, '') = '';
	exception
	when others then
		qt_descricao_w := 0;
end;

select coalesce(CASE WHEN pkg_i18n.get_user_locale ='en_AU' THEN max(IE_LIBERA_ANESTESIA)  ELSE max('N') END ,'N')
into STRICT	ie_liberar_w
from	parametro_medico
where	cd_estabelecimento = wheb_usuario_pck.get_cd_estabelecimento;


if (coalesce(nr_seq_tec_p,0) > 0) then
begin
	select nextval('cirurgia_tec_anestesica_seq')
	into STRICT nr_seq_tecnica_w
	;
	
	select   max(nr_seq_tipo_avaliacao)
	into STRICT     nr_seq_tipo_avaliacao_w
	from     tecnica_anestesica
	where    nr_sequencia = nr_seq_tec_p;

	insert into cirurgia_tec_anestesica(
			nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			nr_seq_tecnica,
			nr_cirurgia,
			dt_inicio,
			dt_final,
			cd_profissional,
			nr_seq_pepo,
			ie_situacao,
      dt_liberacao)
	SELECT	nr_seq_tecnica_w,
			clock_timestamp(),
			nm_usuario_p,
			nr_seq_tec_p,
			nr_cirurgia_p,
			clock_timestamp(),
			clock_timestamp(),
			cd_profissional_p,
			nr_seq_pepo_p,
			'A',
      CASE WHEN ie_liberar_w='S' THEN clock_timestamp()  ELSE null END
	from	tecnica_anestesica
	WHERE	nr_sequencia = nr_seq_tec_p;

	if (ie_registra_desc_w = 'S')	and (ie_registra_desc_tec_w ='A')	and (qt_descricao_w = 0) and (ie_insere_desc_p = 'S') then
      select 	nextval('anestesia_descricao_seq')
		into STRICT 	nr_seq_anest_desc_w
		;

		insert into anestesia_descricao(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_cirurgia,
				cd_responsavel,
				ds_anestesia,
				ie_tipo_descricao,
				nr_seq_pepo,
				ie_situacao,
				nr_seq_tecnica,
        dt_liberacao)
		SELECT 	nr_seq_anest_desc_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_cirurgia_p,
				cd_profissional_p,
				' ',
				'P',
				nr_seq_pepo_p,
				'A',
				NR_SEQ_TEC_P,
        CASE WHEN ie_liberar_w='S' THEN clock_timestamp()  ELSE null END 
		;

      if (octet_length(ds_txt_p) < 65528) then
			CALL GRAVAR_VARCHAR_PARA_LONG(substr(ds_txt_p,1,32764),
									substr(ds_txt_p,32765,65528),			
									'anestesia_descricao',		
									'ds_anestesia',			
									'where nr_sequencia = :nr_sequencia_p ',
									'nr_sequencia_p='||nr_seq_anest_desc_w);	
		else

			update	anestesia_descricao
			set		ds_anestesia = obter_expressao_dic_objeto(1071511)
			where nr_sequencia = nr_seq_anest_desc_w;
		end if;

	elsif (ie_registra_desc_w = 'S') and (ie_registra_desc_tec_w <> 'A') and (ie_insere_desc_p = 'S') then
		/*  
		Consulta o texto para inserir
		*/
		if (coalesce(ds_txt_p,' ') = ' ') then
				 select	coalesce(coalesce(a.ds_texto_padrao_clob, a.ds_texto_padrao),' ')
				 into STRICT	ds_texto_padrao_w
				 from	tecnica_anestesica a
				 where	nr_sequencia = nr_seq_tec_p;
		end if;
		
		select 	nextval('anestesia_descricao_seq')
		into STRICT 	nr_seq_anest_desc_w
		;
		
		insert into anestesia_descricao(
				nr_sequencia,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				nr_cirurgia,
				cd_responsavel,
				ds_anestesia,
				ie_tipo_descricao,
				nr_seq_pepo,
				ie_situacao,
				nr_seq_tecnica,
        dt_liberacao)
		SELECT 	nr_seq_anest_desc_w,
				clock_timestamp(),
				nm_usuario_p,
				clock_timestamp(),
				nm_usuario_p,
				nr_cirurgia_p,
				cd_profissional_p,
				' ',
				'P',
				nr_seq_pepo_p,
				'A',
				nr_seq_tec_p,
        CASE WHEN ie_liberar_w='S' THEN clock_timestamp()  ELSE null END
		;	

		if (octet_length(coalesce(ds_texto_padrao_w, ds_txt_p)) < 65528) then
			CALL GRAVAR_VARCHAR_PARA_LONG(substr(coalesce(ds_texto_padrao_w, ds_txt_p),1,32764),
									substr(coalesce(ds_texto_padrao_w, ds_txt_p),32765,65528),			
									'anestesia_descricao',		
									'ds_anestesia',			
									'where nr_sequencia = :nr_sequencia_p ',
									'nr_sequencia_p='||nr_seq_anest_desc_w);	
		else

			update	anestesia_descricao
			set		ds_anestesia = obter_expressao_dic_objeto(1071511)
			where nr_sequencia = nr_seq_anest_desc_w;
		end if;

	end if;
	
	if (nr_seq_tipo_avaliacao_w IS NOT NULL AND nr_seq_tipo_avaliacao_w::text <> '') then
		CALL gerar_avaliacao_tecnica_anest(nr_seq_tipo_avaliacao_w,nr_seq_tecnica_w,null,nr_cirurgia_p,nr_seq_pepo_p);
	end if;
end;	
end if;

nr_sequencia_p := nr_seq_tecnica_w;
	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_tecnica_anestesica_java ( nr_seq_tec_p bigint, nm_usuario_p text, nr_cirurgia_p bigint, cd_profissional_p text, nr_seq_pepo_p bigint, ds_txt_p text, ie_insere_desc_p text, nr_sequencia_p INOUT bigint) FROM PUBLIC;

