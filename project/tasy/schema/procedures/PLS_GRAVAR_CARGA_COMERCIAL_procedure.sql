-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_gravar_carga_comercial ( nm_usuario_p text, cd_estabelecimento_p bigint) AS $body$
DECLARE


nr_seq_carga_comercial_w	bigint;
cd_registro_w			bigint;
nm_pessoa_w			varchar(255);
ds_endereco_w			varchar(255);
cd_cep_w			varchar(10);
ds_municipio_w			varchar(60);
ds_email_w			varchar(100);
nr_telefone_w			varchar(30);
nr_fax_w			varchar(30);
nm_contato_w			varchar(255);

nr_seq_solicitacao_w		bigint;
cd_municipio_ibge_w		varchar(6);

nr_seq_comercial_hist_w		bigint;
dt_historico_w			timestamp;
ds_historico_w			varchar(4000);
dt_agenda_w			timestamp;

C01 CURSOR FOR
	SELECT	nr_sequencia,
		cd_registro,
		coalesce(nm_pessoa,' '),
		ds_endereco,
		cd_cep,
		upper(ds_municipio),
		ds_email,
		coalesce(nr_telefone,' '),
		nr_fax,
		nm_contato
	from	w_pls_carga_comercial;

C02 CURSOR FOR
	SELECT	nr_sequencia,
		dt_historico,
		ds_historico,
		dt_agenda
	from	w_pls_carga_comercial_hist
	where	nr_seq_comercial	= nr_seq_carga_comercial_w;


BEGIN

open C01;
loop
fetch C01 into
	nr_seq_carga_comercial_w,
	cd_registro_w,
	nm_pessoa_w,
	ds_endereco_w,
	cd_cep_w,
	ds_municipio_w,
	ds_email_w,
	nr_telefone_w,
	nr_fax_w,
	nm_contato_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	nextval('pls_solicitacao_comercial_seq')
	into STRICT	nr_seq_solicitacao_w
	;

	select	max(cd_municipio_ibge)
	into STRICT	cd_municipio_ibge_w
	from	sus_municipio
	where	upper(ds_municipio) like '%'||ds_municipio_w||'%';

	insert into pls_solicitacao_comercial(	nr_sequencia, cd_estabelecimento, ie_status, nm_pessoa_fisica, nr_telefone,
						dt_atualizacao, nm_usuario, dt_atualizacao_nrec, nm_usuario_nrec, ds_email,
						dt_solicitacao, ie_origem_solicitacao, ie_tipo_contratacao, nr_ddi, nr_ddd,
						sg_uf_municipio, cd_municipio_ibge, nr_seq_agente_motivador, nm_contato,
						ie_etapa_solicitacao)
					values (	nr_seq_solicitacao_w, cd_estabelecimento_p, 'PE', nm_pessoa_w, nr_telefone_w,
						clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p, ds_email_w,
						clock_timestamp(), 'D', 'CE', 55, 54,
						'RS', cd_municipio_ibge_w, 1, nm_contato_w,
						'C');

	open C02;
	loop
	fetch C02 into
		nr_seq_comercial_hist_w,
		dt_historico_w,
		ds_historico_w,
		dt_agenda_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin
		insert into pls_solicitacao_historico(	NR_SEQUENCIA, NR_SEQ_SOLICITACAO, IE_TIPO_ATIVIDADE, DT_HISTORICO, NM_USUARIO_HISTORICO,
							DT_ATUALIZACAO, NM_USUARIO, DT_ATUALIZACAO_NREC, NM_USUARIO_NREC, DS_HISTORICO,
							DT_PROGRAMACAO, DT_LIBERACAO, NM_USUARIO_LIBERACAO)
						values (	nextval('pls_solicitacao_historico_seq'), nr_seq_solicitacao_w, 1, dt_historico_w, nm_usuario_p,
							clock_timestamp(), nm_usuario_p, clock_timestamp(), nm_usuario_p, ds_historico_w,
							dt_agenda_w, clock_timestamp(), nm_usuario_p);
		end;
	end loop;
	close C02;

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_gravar_carga_comercial ( nm_usuario_p text, cd_estabelecimento_p bigint) FROM PUBLIC;

