-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_comunic_i_espe ( nm_usuario_p text) AS $body$
DECLARE

    wcursor CURSOR FOR
    SELECT 
        A.cd_pessoa_fisica,
        C.nm_pessoa_fisica,
        E.ds_especialidade,
        b.ds_titulo,
        b.ds_texto_comunic,
        b.nm_usuario_destino,
        b.ds_perfil_adicional,
        regexp_replace(
            regexp_replace(
                regexp_replace(
                    regexp_replace(b.ds_texto_comunic,
                    '@nm_pessoa_fisica',C.nm_pessoa_fisica, 1, 0, 'i'),
                '@data_vencimento',A.dt_vencimento, 1, 0, 'i'),
            '@especialidade',E.ds_especialidade, 1, 0, 'i'),
        '@quantidade_dias',TRUNC(dt_vencimento - clock_timestamp()), 1, 0, 'i') mensagem
    FROM medico_especialidade A 
    INNER JOIN regra_comunic_med_esp b ON
        TRUNC(dt_vencimento - clock_timestamp()) <= b.qt_dia_aviso
    INNER JOIN pessoa_fisica C ON
        C.cd_pessoa_fisica = A.cd_pessoa_fisica
    INNER JOIN especialidade_medica E ON
        E.cd_especialidade = A.cd_especialidade
    WHERE 
        b.ie_situacao = 'A' AND 
        b.ie_situacao = 'A'
    ORDER BY qt_dia_aviso DESC;
    row_cur wcursor%rowtype;

BEGIN
    OPEN wcursor;
    LOOP
    FETCH wcursor INTO row_cur;
        EXIT WHEN NOT FOUND; /* apply on wcursor */
        INSERT  INTO comunic_interna(
                dt_comunicado,
				ds_titulo,
				ds_comunicado,
				nm_usuario,
				dt_atualizacao,
				ie_geral,
				nm_usuario_destino,
				nr_sequencia,
				ie_gerencial,
				nr_seq_classif,
				ds_perfil_adicional,
				cd_setor_destino,
				cd_estab_destino,
				ds_setor_adicional,
				dt_liberacao)
			VALUES (
                clock_timestamp(),
                row_cur.ds_titulo,
                row_cur.mensagem,
                nm_usuario_p,
                clock_timestamp(),
                'N',
                row_cur.nm_usuario_destino,
				nextval('comunic_interna_seq'),
                'N',
                NULL,
                row_cur.ds_perfil_adicional,
                NULL,
                NULL,
                NULL,
                clock_timestamp()
            );
   END LOOP;
   CLOSE wcursor;
   COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_comunic_i_espe ( nm_usuario_p text) FROM PUBLIC;

