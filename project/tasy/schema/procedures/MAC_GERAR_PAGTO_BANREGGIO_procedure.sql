-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE mac_gerar_pagto_banreggio ( nr_seq_envio_p bigint, nm_usuario_p text) AS $body$
DECLARE


ds_conteudo_w		varchar(110);
cd_estabelecimento_w	smallint;
nr_seq_apres_w		bigint	:= 0;

nr_seq_w varchar(6);
id_tipo_pagto_w		titulo_pagar_escrit.ie_tipo_pagamento%type;
nr_titulo_w		varchar(30);
nr_conta_w		varchar(30);
vl_escritural_w		varchar(14);
vl_iva_w      varchar(17);
ds_descricao_w		varchar(40);

c01 CURSOR FOR
SELECT	lpad(ROW_NUMBER() OVER (ORDER BY b.nr_titulo),5,0) sequencia,
	CASE WHEN g.cd_tipo=4 THEN 'S' WHEN g.cd_tipo=5 THEN 'T' WHEN g.cd_tipo=13 THEN 'B' END ,
	lpad(CASE WHEN coalesce(e.nr_conta::text, '') = '' THEN ee.nr_conta  ELSE e.nr_conta END ,20,'0'),
	lpad(b.vl_escritural*100,14,'0'),
	lpad(obter_vl_total_trib_nota(c.nr_seq_nota_fiscal,'IVA'),16,0),  
	rpad(g.ds_tipo,40,' ') ds_descricao,
  rpad(b.nr_titulo,15,' ')	
FROM banco_tipo_pagto_escrit g, titulo_pagar_escrit b, banco_escritural a, pessoa_juridica dd
LEFT OUTER JOIN pessoa_juridica_conta ee ON (dd.cd_cgc = ee.cd_cgc AND 'S' = ee.ie_conta_pagamento AND 'A' = ee.ie_situacao)
, pessoa_fisica d
LEFT OUTER JOIN pessoa_fisica_conta e ON (d.cd_pessoa_fisica = e.cd_pessoa_fisica AND 'S' = e.ie_conta_pagamento AND 'A' = e.ie_situacao)
, titulo_pagar c
LEFT OUTER JOIN pessoa_fisica d ON (c.cd_pessoa_fisica = d.cd_pessoa_fisica)
LEFT OUTER JOIN pessoa_juridica dd ON (c.cd_cgc = dd.cd_cgc)
WHERE b.nr_seq_tipo_pagto = g.nr_sequencia and b.nr_titulo = c.nr_titulo and a.nr_sequencia = nr_seq_envio_p;


BEGIN

delete	from w_envio_banco
where	nm_usuario	= nm_usuario_p;

select	b.cd_estabelecimento
into STRICT	cd_estabelecimento_w	
from	banco_estabelecimento c,
	estabelecimento b,
	banco_escritural a
where	a.nr_seq_conta_banco	= c.nr_sequencia
and	a.cd_estabelecimento	= b.cd_estabelecimento
and	a.nr_sequencia		= nr_seq_envio_p;

open	c01;
loop
fetch	c01 into
	nr_seq_w,
	id_tipo_pagto_w,
  nr_conta_w,
  vl_escritural_w,
  vl_iva_w,
	ds_descricao_w,
	nr_titulo_w;
EXIT WHEN NOT FOUND; /* apply on c01 */

	nr_seq_apres_w		:= coalesce(nr_seq_apres_w,0) + 1;
	
	ds_conteudo_w	:=	nr_seq_w 	||--  5 
				id_tipo_pagto_w		    ||--  1
				nr_conta_w		        ||-- 20				
				vl_escritural_w		    ||-- 13,2
				vl_iva_w              ||-- 16
				ds_descricao_w		    ||-- 40
				nr_titulo_w;		        -- 15
	insert	into w_envio_banco(cd_estabelecimento,
		ds_conteudo,
		dt_atualizacao,
		nm_usuario,
		nr_seq_apres,
		nr_seq_apres_2,
		nr_sequencia)
	values (cd_estabelecimento_w,
		rpad(ds_conteudo_w,110,' '),
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_apres_w,
		nr_seq_apres_w,
		nextval('w_envio_banco_seq'));

end	loop;
close	c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE mac_gerar_pagto_banreggio ( nr_seq_envio_p bigint, nm_usuario_p text) FROM PUBLIC;

