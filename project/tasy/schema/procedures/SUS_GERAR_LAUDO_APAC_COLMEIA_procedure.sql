-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE sus_gerar_laudo_apac_colmeia (cd_associacao_p text default '0', cd_cid_causa_assoc_p text default '0', cd_cid_morfologia_p text default '0', cd_cid_prim_trat_p text default '0', cd_cid_principal_p text default '0', cd_cid_secundario_p text default '0', cd_cid_seg_trat_p text default '0', cd_cid_terc_trat_p text default '0', cd_cid_topografia_p text default '0', cd_grau_histopat_p text default '0', cd_medico_requisitante_p text default '0', cd_medico_responsavel_p text default '0', cd_procedimento_solic_p bigint default 0, cd_tipo_tratamento_p text default '0', ds_anamnese_p text default '', ds_complemento_p text default '', ds_condicao_justifica_p text default '', ds_estadio_uicc_p text default '', ds_exame_resultado_p text default '', ds_hipotese_diag_p text default '', ds_justificativa_p text default '', ds_localizacao_metastase_p text default '', ds_motivo_alteracao_p text default '', ds_motivo_internacao_p text default '', ds_observacao_p text default '', ds_outros_trat_ant_p text default '', ds_result_prova_p text default '', ds_sigla_esquema_p text default '', ds_tratamento_ant_p text default '', ds_tratamento_ant2_p text default '', ds_tratamento_ant3_p text default '', dt_diag_cito_hist_p text default '', dt_diagnostico_p text default '', dt_emissao_p text default '', dt_inicio_trat_p text default '', dt_fim_trat_p text default '', dt_inicio_val_apac_p text default '', dt_fim_val_apac_p text default '', dt_metastase_p text default '', dt_pri_dialise_p text default '', dt_pri_tratamento_p text default '', dt_seg_tratamento_p text default '', dt_ter_tratamento_p text default '', dt_transplante_p text default '', ie_acesso_vascular_p text default '', ie_classif_hemofilia_p text default '', ie_continuidade_trat_p text default '', ie_diaria_acomp_p text default '', ie_diaria_uti_p text default '', ie_finalidade_p text default '', ie_forma_tratamento_p text default '', ie_gestante_p text default '', ie_hb_sangue_p text default '', ie_hcv_p text default '', ie_hiv_p text default '', ie_inibidor_p text default '', ie_lifonodos_reg_inval_p text default '', ie_metastase_p text default '', ie_prova_diag_p text default '', ie_recidivado_p text default '', ie_status_processo_p text default '', ie_tipo_tumor_p text default '', ie_transplante_p text default '', ie_tratamento_ant_p text default '', ie_ultra_abdomen_p text default '', ie_urgente_p text default '', ie_via_im_p text default '', ie_via_it_p text default '', ie_via_iv_p text default '', ie_via_ives_p text default '', ie_via_outros_p text default '', ie_via_sc_p text default '', ie_via_vo_p text default '', ie_via_tratamento_p text default '', nr_apac_p text default '0', pr_albumina_p bigint default null, pr_hb_p bigint default null, qt_altura_cm_p bigint default null, qt_bloco_pre_p bigint default null, qt_campo_area_dia_p bigint default null, qt_diurese_p bigint default null, qt_dose_area_dia_p bigint default null, qt_glicose_p bigint default null, qt_insercoes_p bigint default null, qt_meses_autorizado_p bigint default null, qt_meses_prev_p bigint default null, qt_peso_p bigint default null, qt_prev_mes1_p bigint default null, qt_prev_mes2_p bigint default null, qt_prev_mes3_p bigint default null, qt_procedimento_solic_p bigint default null, qt_radiacao_p bigint default null, qt_total_dia_area_p bigint default null, qt_transplante_p bigint default null, nm_usuario_p text default '', nr_atendimento_p text default '0', nr_interno_conta_p INOUT text DEFAULT NULL) AS $body$
DECLARE

 
nr_laudo_sus_w		sus_laudo_paciente.nr_laudo_sus%type;
sus_procedimento_w	sus_procedimento.ie_tipo_laudo_apac%type;
nr_seq_interno_w	sus_laudo_paciente.nr_seq_interno%type;
ie_classificacao_w	sus_laudo_paciente.ie_classificacao%type;
qt_laudo_w		varchar(10);
ds_erro_w		sus_erro_imp_colmeia.ds_erro%type;
cd_medico_req_w		sus_laudo_paciente.cd_medico_requisitante%type;
cd_medico_resp_w	sus_laudo_paciente.cd_medico_responsavel%type;
nr_atendimento_w	atendimento_paciente.nr_atendimento%type;
cd_proced_solic_w	sus_laudo_paciente.cd_procedimento_solic%type;
cd_grau_histopat_w	sus_laudo_paciente.cd_grau_histopat%type;


BEGIN 
 
begin 
nr_atendimento_w := (nr_atendimento_p)::numeric;
exception 
when others then 
	nr_atendimento_w := null;
end;
 
begin 
cd_proced_solic_w := coalesce((cd_procedimento_solic_p)::numeric ,0);
exception 
when others then 
	cd_proced_solic_w := 0;
end;
 
if (coalesce(nr_apac_p,'X') <> 'X') and (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') and (coalesce(cd_proced_solic_w,0) <> 0) then 
	begin 
	 
	select	coalesce(max(nr_laudo_sus),0) + 1 
	into STRICT	nr_laudo_sus_w 
	from	sus_laudo_paciente 
	where	nr_atendimento	= nr_atendimento_w;
 
	select	nextval('sus_laudo_paciente_seq') 
	into STRICT	nr_seq_interno_w 
	;
 
	select	CASE WHEN ie_tipo_laudo_apac='03' THEN 11 WHEN ie_tipo_laudo_apac='04' THEN 12 WHEN ie_tipo_laudo_apac='06' THEN 14  ELSE 13 END  
	into STRICT	ie_classificacao_w 
	from	sus_procedimento 
	where	cd_procedimento = cd_proced_solic_w;
 
	begin 
	select	count(1) 
	into STRICT	qt_laudo_w 
	from	atendimento_paciente a, 
		sus_laudo_paciente s 
	where	s.nr_atendimento = a.nr_atendimento 
	and	a.nr_atendimento = nr_atendimento_w 
	and	s.nr_apac = nr_apac_p 
	and	trunc(a.dt_entrada,'mm') between trunc(s.dt_inicio_val_apac,'mm') and trunc(s.dt_fim_val_apac,'mm')  LIMIT 1;
	exception 
	when others then 
		qt_laudo_w := 0;
	end;
 
	if (coalesce(qt_laudo_w,0) = 0) then 
		begin 
 
		cd_medico_req_w		:= substr(coalesce(obter_dados_pf_cns(substr(cd_medico_requisitante_p,1,15),'CD'),''),1,10);
		cd_medico_resp_w	:= substr(coalesce(obter_dados_pf_cns(substr(cd_medico_responsavel_p,1,15),'CD'),''),1,10);
				 
		 
		begin 
		insert into sus_laudo_paciente( 
			nr_atendimento, 
			ie_classificacao, 
			nr_seq_interno, 
			nr_laudo_sus, 
			nm_usuario, 
			dt_atualizacao, 
			ie_tipo_laudo_sus, 
			cd_associacao, 
			cd_cid_causa_assoc, 
			cd_cid_morfologia, 
			cd_cid_prim_trat, 
			cd_cid_principal, 
			cd_cid_secundario, 
			cd_cid_seg_trat, 
			cd_cid_terc_trat, 
			cd_cid_topografia, 
			cd_grau_histopat, 
			cd_medico_requisitante, 
			cd_medico_responsavel, 
			cd_procedimento_solic, 
			ie_origem_proced, 
			cd_tipo_tratamento, 
			ds_anamnese, 
			ds_complemento, 
			ds_condicao_justifica, 
			ds_estadio_uicc, 
			ds_exame_resultado, 
			ds_hipotese_diag, 
			ds_justificativa, 
			ds_localizacao_metastase, 
			ds_motivo_alteracao, 
			ds_motivo_internacao, 
			ds_observacao, 
			ds_outros_trat_ant, 
			ds_result_prova, 
			ds_sigla_esquema, 
			ds_tratamento_ant, 
			ds_tratamento_ant2, 
			ds_tratamento_ant3, 
			dt_diag_cito_hist, 
			dt_diagnostico, 
			dt_emissao, 
			dt_inicio_trat, 
			dt_fim_trat, 
			dt_inicio_val_apac, 
			dt_fim_val_apac, 
			dt_metastase, 
			dt_pri_dialise, 
			dt_pri_tratamento, 
			dt_seg_tratamento, 
			dt_ter_tratamento, 
			dt_transplante, 
			ie_acesso_vascular, 
			ie_classif_hemofilia, 
			ie_continuidade_trat, 
			ie_diaria_acomp, 
			ie_diaria_uti, 
			ie_finalidade, 
			ie_forma_tratamento, 
			ie_gestante, 
			ie_hb_sangue, 
			ie_hcv, 
			ie_hiv, 
			ie_inibidor, 
			ie_lifonodos_reg_inval, 
			ie_metastase, 
			ie_prova_diag, 
			ie_recidivado, 
			ie_status_processo, 
			ie_tipo_tumor, 
			ie_transplante, 
			ie_tratamento_ant, 
			ie_ultra_abdomen, 
			ie_urgente, 
			ie_via_im, 
			ie_via_it, 
			ie_via_iv, 
			ie_via_ives, 
			ie_via_outros, 
			ie_via_sc, 
			ie_via_vo, 
			ie_via_tratamento, 
			nr_apac, 
			pr_albumina, 
			pr_hb, 
			qt_altura_cm, 
			qt_bloco_pre, 
			qt_campo_area_dia, 
			qt_diurese, 
			qt_dose_area_dia, 
			qt_glicose, 
			qt_insercoes, 
			qt_meses_autorizado, 
			qt_meses_prev, 
			qt_peso, 
			qt_prev_mes1, 
			qt_prev_mes2, 
			qt_prev_mes3, 
			qt_procedimento_solic, 
			qt_radiacao, 
			qt_total_dia_area, 
			qt_transplante 
			) 
		values (	nr_atendimento_w, 
			ie_classificacao_w, 
			nr_seq_interno_w, 
			nr_laudo_sus_w, 
			nm_usuario_p, 
			clock_timestamp(), 
			0, 
			cd_associacao_p, 
			cd_cid_causa_assoc_p, 
			cd_cid_morfologia_p, 
			cd_cid_prim_trat_p, 
			cd_cid_principal_p, 
			cd_cid_secundario_p, 
			cd_cid_seg_trat_p, 
			cd_cid_terc_trat_p, 
			cd_cid_topografia_p, 
			cd_grau_histopat_w, 
			cd_medico_req_w, 
			cd_medico_resp_w, 
			cd_proced_solic_w, 
			7, 
			cd_tipo_tratamento_p, 
			ds_anamnese_p, 
			ds_complemento_p, 
			ds_condicao_justifica_p, 
			ds_estadio_uicc_p, 
			ds_exame_resultado_p, 
			ds_hipotese_diag_p, 
			ds_justificativa_p, 
			ds_localizacao_metastase_p, 
			ds_motivo_alteracao_p, 
			ds_motivo_internacao_p, 
			ds_observacao_p, 
			ds_outros_trat_ant_p, 
			ds_result_prova_p, 
			ds_sigla_esquema_p, 
			ds_tratamento_ant_p, 
			ds_tratamento_ant2_p, 
			ds_tratamento_ant3_p, 
			CASE WHEN dt_diag_cito_hist_p='' THEN null  ELSE to_date(dt_diag_cito_hist_p,'dd/mm/yyyy hh24:mi:ss') END , 
			CASE WHEN dt_diagnostico_p='' THEN null  ELSE to_date(dt_diagnostico_p,'dd/mm/yyyy hh24:mi:ss') END , 
			CASE WHEN dt_emissao_p='' THEN null  ELSE to_date(dt_emissao_p,'dd/mm/yyyy hh24:mi:ss') END , 
			CASE WHEN dt_inicio_trat_p='' THEN null  ELSE to_date(dt_inicio_trat_p,'dd/mm/yyyy hh24:mi:ss') END , 
			CASE WHEN dt_fim_trat_p='' THEN null  ELSE to_date(dt_fim_trat_p,'dd/mm/yyyy hh24:mi:ss') END , 
			CASE WHEN dt_inicio_val_apac_p='' THEN null  ELSE to_date(dt_inicio_val_apac_p,'dd/mm/yyyy hh24:mi:ss') END , 
			CASE WHEN dt_fim_val_apac_p='' THEN null  ELSE to_date(dt_fim_val_apac_p,'dd/mm/yyyy hh24:mi:ss') END , 
			CASE WHEN dt_metastase_p='' THEN null  ELSE to_date(dt_metastase_p,'dd/mm/yyyy hh24:mi:ss') END , 
			CASE WHEN dt_pri_dialise_p='' THEN null  ELSE to_date(dt_pri_dialise_p,'dd/mm/yyyy hh24:mi:ss') END , 
			CASE WHEN dt_pri_tratamento_p='' THEN null  ELSE to_date(dt_pri_tratamento_p,'dd/mm/yyyy hh24:mi:ss') END , 
			CASE WHEN dt_seg_tratamento_p='' THEN null  ELSE to_date(dt_seg_tratamento_p,'dd/mm/yyyy hh24:mi:ss') END , 
			CASE WHEN dt_ter_tratamento_p='' THEN null  ELSE to_date(dt_ter_tratamento_p,'dd/mm/yyyy hh24:mi:ss') END , 
			CASE WHEN dt_transplante_p='' THEN null  ELSE to_date(dt_transplante_p,'dd/mm/yyyy hh24:mi:ss') END , 
			ie_acesso_vascular_p, 
			ie_classif_hemofilia_p, 
			ie_continuidade_trat_p, 
			coalesce(ie_diaria_acomp_p,'N'), 
			ie_diaria_uti_p, 
			ie_finalidade_p, 
			ie_forma_tratamento_p, 
			ie_gestante_p, 
			ie_hb_sangue_p, 
			ie_hcv_p, 
			ie_hiv_p, 
			ie_inibidor_p, 
			ie_lifonodos_reg_inval_p, 
			ie_metastase_p, 
			ie_prova_diag_p, 
			ie_recidivado_p, 
			ie_status_processo_p, 
			ie_tipo_tumor_p, 
			ie_transplante_p, 
			ie_tratamento_ant_p, 
			ie_ultra_abdomen_p, 
			ie_urgente_p, 
			ie_via_im_p, 
			ie_via_it_p, 
			ie_via_iv_p, 
			ie_via_ives_p, 
			ie_via_outros_p, 
			ie_via_sc_p, 
			ie_via_vo_p, 
			ie_via_tratamento_p, 
			(nr_apac_p)::numeric , 
			CASE WHEN pr_albumina_p=0 THEN null  ELSE pr_albumina_p END , 
			CASE WHEN pr_hb_p=0 THEN null  ELSE pr_hb_p END , 
			CASE WHEN qt_altura_cm_p=0 THEN null  ELSE qt_altura_cm_p END , 
			CASE WHEN qt_bloco_pre_p=0 THEN null  ELSE qt_bloco_pre_p END , 
			CASE WHEN qt_campo_area_dia_p=0 THEN null  ELSE qt_campo_area_dia_p END , 
			CASE WHEN qt_diurese_p=0 THEN null  ELSE qt_diurese_p END , 
			CASE WHEN qt_dose_area_dia_p=0 THEN null  ELSE qt_dose_area_dia_p END , 
			CASE WHEN qt_glicose_p=0 THEN null  ELSE qt_glicose_p END , 
			CASE WHEN qt_insercoes_p=0 THEN null  ELSE qt_insercoes_p END , 
			CASE WHEN qt_meses_autorizado_p=0 THEN null  ELSE qt_meses_autorizado_p END , 
			CASE WHEN qt_meses_prev_p=0 THEN null  ELSE qt_meses_prev_p END , 
			CASE WHEN qt_peso_p=0 THEN null  ELSE qt_peso_p END , 
			CASE WHEN qt_prev_mes1_p=0 THEN null  ELSE qt_prev_mes1_p END , 
			CASE WHEN qt_prev_mes2_p=0 THEN null  ELSE qt_prev_mes2_p END , 
			CASE WHEN qt_prev_mes3_p=0 THEN null  ELSE qt_prev_mes3_p END , 
			CASE WHEN qt_procedimento_solic_p=0 THEN null  ELSE qt_procedimento_solic_p END , 
			CASE WHEN qt_radiacao_p=0 THEN null  ELSE qt_radiacao_p END , 
			CASE WHEN qt_total_dia_area_p=0 THEN null  ELSE qt_total_dia_area_p END , 
			CASE WHEN qt_transplante_p=0 THEN null  ELSE qt_transplante_p END  
			);
		exception 
		when others then 
			nr_seq_interno_w := null;			
			ds_erro_w := substr(Wheb_mensagem_pck.get_Texto(301532, 'DS_ERRO_W='|| sqlerrm),1,2000);
		end;
 
		if (coalesce(ds_erro_w,'X') <> 'X') then 
			begin 
			 
			begin 
			insert into SUS_ERRO_IMP_COLMEIA( 
				ds_erro, 
				dt_atualizacao, 
				nm_usuario, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				nr_atendimento, 
				nr_seq_interno, 
				nr_sequencia) 
			values (	ds_erro_w, 
				clock_timestamp(), 
				nm_usuario_p, 
				clock_timestamp(), 
				nm_usuario_p, 
				nr_atendimento_w, 
				nr_seq_interno_w, 
				nextval('sus_erro_imp_colmeia_seq'));			
			exception 
			when others then 
				insert into SUS_ERRO_IMP_COLMEIA( 
					ds_erro, 
					dt_atualizacao, 
					nm_usuario, 
					dt_atualizacao_nrec, 
					nm_usuario_nrec, 
					nr_atendimento, 
					nr_seq_interno, 
					nr_sequencia) 
				values (	'nr_atendimento_w:'|| nr_atendimento_w || 
					',nr_seq_interno_w:'|| nr_seq_interno_w, 
					clock_timestamp(), 
					nm_usuario_p, 
					clock_timestamp(), 
					nm_usuario_p, 
					null, 
					null, 
					nextval('sus_erro_imp_colmeia_seq'));
			end;
			 
			end;
		end if;
		 
		if (nr_seq_interno_w IS NOT NULL AND nr_seq_interno_w::text <> '') then 
			begin 
 
			CALL sus_consiste_laudo(nr_seq_interno_w, nm_usuario_p);
			CALL sus_liberar_laudo_colmeia(nr_seq_interno_w,nm_usuario_p,nr_atendimento_w,nr_apac_p);
 
			begin	--busca o número da conta criada no momento. 
			select	max(nr_interno_conta) 
			into STRICT	nr_interno_conta_p 
			from	conta_paciente 
			where	nr_atendimento = nr_atendimento_w;
			exception 
			when others then 
				nr_interno_conta_p := 0;
			end;
 
			end;
		end if;
 
		end;
	end if;
 
	end;
else 
	begin 
	 
	ds_erro_w := substr('nr_apac_p:'|| nr_apac_p ||';nr_atendimento_p:'|| nr_atendimento_p || ':cd_proced_solic_w:'|| cd_proced_solic_w,1,2000);
	 
	insert into sus_erro_imp_colmeia( 
				ds_erro, 
				dt_atualizacao, 
				nm_usuario, 
				dt_atualizacao_nrec, 
				nm_usuario_nrec, 
				nr_atendimento, 
				nr_seq_interno, 
				nr_sequencia) 
			values (	ds_erro_w, 
				clock_timestamp(), 
				nm_usuario_p, 
				clock_timestamp(), 
				nm_usuario_p, 
				null, 
				null, 
				nextval('sus_erro_imp_colmeia_seq'));
	 
	end;
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE sus_gerar_laudo_apac_colmeia (cd_associacao_p text default '0', cd_cid_causa_assoc_p text default '0', cd_cid_morfologia_p text default '0', cd_cid_prim_trat_p text default '0', cd_cid_principal_p text default '0', cd_cid_secundario_p text default '0', cd_cid_seg_trat_p text default '0', cd_cid_terc_trat_p text default '0', cd_cid_topografia_p text default '0', cd_grau_histopat_p text default '0', cd_medico_requisitante_p text default '0', cd_medico_responsavel_p text default '0', cd_procedimento_solic_p bigint default 0, cd_tipo_tratamento_p text default '0', ds_anamnese_p text default '', ds_complemento_p text default '', ds_condicao_justifica_p text default '', ds_estadio_uicc_p text default '', ds_exame_resultado_p text default '', ds_hipotese_diag_p text default '', ds_justificativa_p text default '', ds_localizacao_metastase_p text default '', ds_motivo_alteracao_p text default '', ds_motivo_internacao_p text default '', ds_observacao_p text default '', ds_outros_trat_ant_p text default '', ds_result_prova_p text default '', ds_sigla_esquema_p text default '', ds_tratamento_ant_p text default '', ds_tratamento_ant2_p text default '', ds_tratamento_ant3_p text default '', dt_diag_cito_hist_p text default '', dt_diagnostico_p text default '', dt_emissao_p text default '', dt_inicio_trat_p text default '', dt_fim_trat_p text default '', dt_inicio_val_apac_p text default '', dt_fim_val_apac_p text default '', dt_metastase_p text default '', dt_pri_dialise_p text default '', dt_pri_tratamento_p text default '', dt_seg_tratamento_p text default '', dt_ter_tratamento_p text default '', dt_transplante_p text default '', ie_acesso_vascular_p text default '', ie_classif_hemofilia_p text default '', ie_continuidade_trat_p text default '', ie_diaria_acomp_p text default '', ie_diaria_uti_p text default '', ie_finalidade_p text default '', ie_forma_tratamento_p text default '', ie_gestante_p text default '', ie_hb_sangue_p text default '', ie_hcv_p text default '', ie_hiv_p text default '', ie_inibidor_p text default '', ie_lifonodos_reg_inval_p text default '', ie_metastase_p text default '', ie_prova_diag_p text default '', ie_recidivado_p text default '', ie_status_processo_p text default '', ie_tipo_tumor_p text default '', ie_transplante_p text default '', ie_tratamento_ant_p text default '', ie_ultra_abdomen_p text default '', ie_urgente_p text default '', ie_via_im_p text default '', ie_via_it_p text default '', ie_via_iv_p text default '', ie_via_ives_p text default '', ie_via_outros_p text default '', ie_via_sc_p text default '', ie_via_vo_p text default '', ie_via_tratamento_p text default '', nr_apac_p text default '0', pr_albumina_p bigint default null, pr_hb_p bigint default null, qt_altura_cm_p bigint default null, qt_bloco_pre_p bigint default null, qt_campo_area_dia_p bigint default null, qt_diurese_p bigint default null, qt_dose_area_dia_p bigint default null, qt_glicose_p bigint default null, qt_insercoes_p bigint default null, qt_meses_autorizado_p bigint default null, qt_meses_prev_p bigint default null, qt_peso_p bigint default null, qt_prev_mes1_p bigint default null, qt_prev_mes2_p bigint default null, qt_prev_mes3_p bigint default null, qt_procedimento_solic_p bigint default null, qt_radiacao_p bigint default null, qt_total_dia_area_p bigint default null, qt_transplante_p bigint default null, nm_usuario_p text default '', nr_atendimento_p text default '0', nr_interno_conta_p INOUT text DEFAULT NULL) FROM PUBLIC;

