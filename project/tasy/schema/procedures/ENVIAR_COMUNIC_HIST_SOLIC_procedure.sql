-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE enviar_comunic_hist_solic ( nr_sequencia_p bigint, ie_solicitante_os_p text, ie_executor_os_p text, ie_solicitante_solic_p text, ie_comprador_solic_p text, ie_comprador_param_p text, ie_responsavel_param_p text, ie_solicitante_param_p text, ie_responsavel_centro_p text, ie_aprovadores_solic_p text, ie_tipo_envio_p bigint, nm_usuario_p text, ie_converte_rtf_p text default 'S') AS $body$
DECLARE


nr_solic_compra_w			bigint;
nr_seq_ordem_serv_w		bigint;
nm_usuario_pessoa_solic_w		varchar(15);
nm_usuario_comprador_resp_w	varchar(15);
cd_centro_custo_w			integer;
cd_estabelecimento_w		smallint;
nm_usuario_comprador_padrao_w	varchar(15);
nm_usuario_resp_compras_w		varchar(15);
nm_usuario_solic_padrao_w		varchar(15);
nm_usuario_pessoa_solic_OS_w	varchar(15);
nm_usuario_exec_OS_w		varchar(15);
nm_usuario_centro_w		varchar(15);
ds_titulo_w			varchar(80);
ds_historico_w			varchar(4000);
ds_historico_email_w		varchar(4000);
nr_seq_classif_w			bigint;
ds_observacao_w			varchar(255);
ds_lista_usuarios_w			varchar(255);
ds_usuario_aprov_w		varchar(2000);
nm_usuario_aprov_w		varchar(2000);
/*email*/

ds_lista_email_w			varchar(4000);
ds_email_solic_os_w		usuario.ds_email%type;
ds_email_origem_w			usuario.ds_email%type;
ds_email_exec_os_w		usuario.ds_email%type;
ds_email_pessoa_solic_w		usuario.ds_email%type;
ds_email_comprador_resp_w		usuario.ds_email%type;
ds_email_comprador_padrao_w	usuario.ds_email%type;
ds_email_resp_compras_w		usuario.ds_email%type;
ds_email_pessoa_solic_padrao_w	usuario.ds_email%type;
ds_email_resp_w			usuario.ds_email%type;
ds_email_w			usuario.ds_email%type;
nr_seq_rtf_srtring_w		varchar(50);
ie_converte_rtf_w			varchar(1);

C01 CURSOR FOR
	SELECT	substr(obter_usuarios_proc_aprov(a.nr_sequencia, a.nr_seq_proc_aprov),1,255) nm_usuarios_aprov
	from	processo_aprov_compra a,
		pessoa_fisica b
	where	a.cd_pessoa_fisica = b.cd_pessoa_fisica
	and	coalesce(a.cd_cargo::text, '') = ''
	and	a.nr_sequencia in (SELECT	distinct nr_seq_aprovacao
		from	solic_compra_item
		where	nr_solic_compra = nr_solic_compra_w)
	
union all

	select	substr(obter_usuarios_proc_aprov(a.nr_sequencia, a.nr_seq_proc_aprov),1,255) nm_usuarios_aprov
	from	processo_aprov_compra a,
		cargo b
	where	a.cd_cargo = b.cd_cargo
	and	a.nr_sequencia in (select	distinct nr_seq_aprovacao
		from	solic_compra_item
		where	nr_solic_compra = nr_solic_compra_w);
		
C02 CURSOR FOR
	SELECT	distinct
		ds_email
	from	usuario
	where	obter_se_contido_char(nm_usuario, nm_usuario_aprov_w) = 'S'
	and	obter_se_contido_char(ds_email, ds_lista_email_w) = 'N'
	order by ds_email;


BEGIN

ie_converte_rtf_w := coalesce(ie_converte_rtf_p, 'S');

select	a.nr_solic_compra,
	substr(a.ds_titulo,1,65) || ' - ' || b.nr_solic_compra,
	a.ds_historico
into STRICT	nr_solic_compra_w,
	ds_titulo_w,
	ds_historico_w
from	solic_compra_hist a,
	solic_compra b
where	b.nr_solic_compra = a.nr_solic_compra
and	a.nr_sequencia = nr_sequencia_p;

if (ie_converte_rtf_w = 'S') then
nr_seq_rtf_srtring_w := converte_rtf_string('	select	a.ds_historico
			from	solic_compra_hist a,
				solic_compra b
			where	b.nr_solic_compra = a.nr_solic_compra	
			and	a.nr_sequencia = :nr_sequencia_p ', nr_sequencia_p, nm_usuario_p, nr_seq_rtf_srtring_w);
end if;
begin

select	ds_texto
into STRICT	ds_historico_email_w
from	tasy_conversao_rtf
where	nr_sequencia = nr_seq_rtf_srtring_w;

exception
when others then
	ds_historico_email_w := ds_titulo_w;
end;

select	max(nr_seq_ordem_serv),
	max(obter_usuario_pessoa(cd_pessoa_solicitante)),
	max(obter_usuario_pessoa(cd_comprador_resp)),
	max(cd_centro_custo),
	max(cd_estabelecimento),
	max(obter_email_usuario(cd_pessoa_solicitante, obter_usuario_pessoa(cd_pessoa_solicitante), cd_estabelecimento)),
	max(obter_email_usuario(cd_comprador_resp, obter_usuario_pessoa(cd_comprador_resp), cd_estabelecimento))
into STRICT	nr_seq_ordem_serv_w,
	nm_usuario_pessoa_solic_w,
	nm_usuario_comprador_resp_w,
	cd_centro_custo_w,
	cd_estabelecimento_w,
	ds_email_pessoa_solic_w,
	ds_email_comprador_resp_w
from	solic_compra
where	nr_solic_compra = nr_solic_compra_w;

select	max(obter_usuario_pessoa(cd_comprador_padrao)),
	max(obter_usuario_pessoa(cd_responsavel_compras)),
	max(obter_usuario_pessoa(cd_pessoa_solic_padrao)),
	max(obter_email_usuario(cd_comprador_padrao, obter_usuario_pessoa(cd_comprador_padrao), cd_estabelecimento)),
	max(obter_email_usuario(cd_responsavel_compras, obter_usuario_pessoa(cd_responsavel_compras), cd_estabelecimento)),
	max(obter_email_usuario(cd_pessoa_solic_padrao, obter_usuario_pessoa(cd_pessoa_solic_padrao), cd_estabelecimento))
into STRICT	nm_usuario_comprador_padrao_w,
	nm_usuario_resp_compras_w,
	nm_usuario_solic_padrao_w,
	ds_email_comprador_padrao_w,
	ds_email_resp_compras_w,
	ds_email_pessoa_solic_padrao_w
from	parametro_compras
where	cd_estabelecimento = cd_estabelecimento_w;

select	coalesce(max(obter_usuario_pessoa(cd_pessoa_resp)),''),
	max(obter_email_usuario(cd_pessoa_resp, obter_usuario_pessoa(cd_pessoa_resp), cd_estabelecimento_w))
into STRICT	nm_usuario_centro_w,
	ds_email_resp_w
from	setor_atendimento
where	cd_setor_atendimento = (
		SELECT	max(cd_setor_atendimento)
		from	setor_atendimento
		where	cd_centro_custo = cd_centro_custo_w);
		
open C01;
loop
fetch C01 into	
	ds_usuario_aprov_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	nm_usuario_aprov_w := substr(nm_usuario_aprov_w || ds_usuario_aprov_w, 1, 1987) || ',';
	end;
end loop;
close C01;

if (ie_tipo_envio_p in (0,2)) then

	select	obter_classif_comunic('F')
	into STRICT	nr_seq_classif_w
	;

	/*Solicitante da ordem de servico*/

	if (ie_solicitante_os_p = 'S') and (nr_seq_ordem_serv_w IS NOT NULL AND nr_seq_ordem_serv_w::text <> '') then
		
		select	obter_usuario_pessoa(cd_pessoa_solicitante)
		into STRICT	nm_usuario_pessoa_solic_OS_w
		from	man_ordem_servico
		where	nr_sequencia = nr_seq_ordem_serv_w;
		
		if (nm_usuario_pessoa_solic_OS_w IS NOT NULL AND nm_usuario_pessoa_solic_OS_w::text <> '') then
			ds_observacao_w := substr(Wheb_mensagem_pck.get_Texto(300269, 'NR_SEQ_ORDEM_SERV_W='||NR_SEQ_ORDEM_SERV_W),1,255); /*'Solicitante da ordem de servico ' || NR_SEQ_ORDEM_SERV_W;*/
		
			CALL gerar_comunic_padrao(clock_timestamp(),ds_titulo_w,ds_historico_w,nm_usuario_p,'N',nm_usuario_pessoa_solic_OS_w,'N',nr_seq_classif_w,null,null,null,clock_timestamp(),null,null,ie_converte_rtf_w);
			CALL grava_solic_compra_hist_envio(nr_sequencia_p,nm_usuario_pessoa_solic_OS_w,ds_observacao_w,nm_usuario_p);
			ds_lista_usuarios_w := ds_lista_usuarios_w || nm_usuario_pessoa_solic_OS_w || ',';
		end if;
	end if;
	
	/*Executor da ordem de servico*/

	if (ie_executor_os_p = 'S') and (nr_seq_ordem_serv_w IS NOT NULL AND nr_seq_ordem_serv_w::text <> '') then
		
		select	nm_usuario_exec
		into STRICT	nm_usuario_exec_OS_w
		from	man_ordem_servico
		where	nr_sequencia = nr_seq_ordem_serv_w;
		
		if (nm_usuario_exec_OS_w IS NOT NULL AND nm_usuario_exec_OS_w::text <> '') and (obter_se_contido_char(nm_usuario_exec_OS_w,ds_lista_usuarios_w) = 'N') then
			
			ds_observacao_w := Wheb_mensagem_pck.get_Texto(300270, 'NR_SEQ_ORDEM_SERV_W='||NR_SEQ_ORDEM_SERV_W); /*Executor da ordem de servico #@NR_SEQ_ORDEM_SERV_W#@*/
			CALL gerar_comunic_padrao(clock_timestamp(),ds_titulo_w,ds_historico_w,nm_usuario_p,'N',nm_usuario_exec_OS_w,'N',nr_seq_classif_w,null,null,null,clock_timestamp(),null,null,ie_converte_rtf_w);
			CALL grava_solic_compra_hist_envio(nr_sequencia_p,nm_usuario_exec_OS_w,ds_observacao_w,nm_usuario_p);
			ds_lista_usuarios_w := ds_lista_usuarios_w || nm_usuario_exec_OS_w || ',';	
		end if;
	end if;
	
	/*Solicitante da Solicitacao*/

	if (ie_solicitante_solic_p = 'S') and (nm_usuario_pessoa_solic_w IS NOT NULL AND nm_usuario_pessoa_solic_w::text <> '') and (obter_se_contido_char(nm_usuario_pessoa_solic_w,ds_lista_usuarios_w) = 'N') then

		ds_observacao_w := Wheb_mensagem_pck.get_Texto(300271);/* 'Solicitante da solicitacao de compras';*/
		CALL gerar_comunic_padrao(clock_timestamp(),ds_titulo_w,ds_historico_w,nm_usuario_p,'N',nm_usuario_pessoa_solic_w,'N',nr_seq_classif_w,null,null,null,clock_timestamp(),null,null,ie_converte_rtf_w);
		CALL grava_solic_compra_hist_envio(nr_sequencia_p,nm_usuario_pessoa_solic_w,ds_observacao_w,nm_usuario_p);
		ds_lista_usuarios_w := ds_lista_usuarios_w || nm_usuario_pessoa_solic_w || ',';
	end if;
	
	/*Comprador resp da Solicitacao*/

	if (ie_comprador_solic_p = 'S') and (nm_usuario_comprador_resp_w IS NOT NULL AND nm_usuario_comprador_resp_w::text <> '') and (obter_se_contido_char(nm_usuario_comprador_resp_w,ds_lista_usuarios_w) = 'N') then
		
		ds_observacao_w := Wheb_mensagem_pck.get_Texto(300272); /*'Comprador responsavel da solicitacao de compras';*/
		CALL gerar_comunic_padrao(clock_timestamp(),ds_titulo_w,ds_historico_w,nm_usuario_p,'N',nm_usuario_comprador_resp_w,'N',nr_seq_classif_w,null,null,null,clock_timestamp(),null,null,ie_converte_rtf_w);
		CALL grava_solic_compra_hist_envio(nr_sequencia_p,nm_usuario_comprador_resp_w,ds_observacao_w,nm_usuario_p);
		ds_lista_usuarios_w := ds_lista_usuarios_w || nm_usuario_comprador_resp_w || ',';
	end if;
	
	/*Comprador parametro de compras*/

	if (ie_comprador_param_p = 'S') and (nm_usuario_comprador_padrao_w IS NOT NULL AND nm_usuario_comprador_padrao_w::text <> '') and (obter_se_contido_char(nm_usuario_comprador_padrao_w,ds_lista_usuarios_w) = 'N') then
		
		ds_observacao_w := Wheb_mensagem_pck.get_Texto(300273); /*'Comprador dos parametros de compras';*/
		CALL gerar_comunic_padrao(clock_timestamp(),ds_titulo_w,ds_historico_w,nm_usuario_p,'N',nm_usuario_comprador_padrao_w,'N',nr_seq_classif_w,null,null,null,clock_timestamp(),null,null,ie_converte_rtf_w);
		CALL grava_solic_compra_hist_envio(nr_sequencia_p,nm_usuario_comprador_padrao_w,ds_observacao_w,nm_usuario_p);
		ds_lista_usuarios_w := ds_lista_usuarios_w || nm_usuario_comprador_padrao_w || ',';
	end if;
	
	/*Responsavel compras dos parametro de compras*/

	if (ie_responsavel_param_p = 'S') and (nm_usuario_resp_compras_w IS NOT NULL AND nm_usuario_resp_compras_w::text <> '') and (obter_se_contido_char(nm_usuario_resp_compras_w,ds_lista_usuarios_w) = 'N') then
		
		ds_observacao_w := Wheb_mensagem_pck.get_Texto(300274); /*'Responsavel compras dos parametros de compras';*/
		CALL gerar_comunic_padrao(clock_timestamp(),ds_titulo_w,ds_historico_w,nm_usuario_p,'N',nm_usuario_resp_compras_w,'N',nr_seq_classif_w,null,null,null,clock_timestamp(),null,null,ie_converte_rtf_w);
		CALL grava_solic_compra_hist_envio(nr_sequencia_p,nm_usuario_resp_compras_w,ds_observacao_w,nm_usuario_p);
		ds_lista_usuarios_w := ds_lista_usuarios_w || nm_usuario_resp_compras_w || ',';
	end if;
	
	/*Solicitante padrao dos parametro de compras*/

	if (ie_solicitante_param_p = 'S') and (nm_usuario_solic_padrao_w IS NOT NULL AND nm_usuario_solic_padrao_w::text <> '') and (obter_se_contido_char(nm_usuario_solic_padrao_w,ds_lista_usuarios_w) = 'N') then
		
		ds_observacao_w := Wheb_mensagem_pck.get_Texto(300275); /*'Solicitante padrao dos parametros de compras';*/
		CALL gerar_comunic_padrao(clock_timestamp(),ds_titulo_w,ds_historico_w,nm_usuario_p,'N',nm_usuario_solic_padrao_w,'N',nr_seq_classif_w,null,null,null,clock_timestamp(),null,null,ie_converte_rtf_w);
		CALL grava_solic_compra_hist_envio(nr_sequencia_p,nm_usuario_solic_padrao_w,ds_observacao_w,nm_usuario_p);
		ds_lista_usuarios_w := ds_lista_usuarios_w || nm_usuario_solic_padrao_w || ',';
	end if;
	
	/*Responsavel do setor*/

	if (ie_responsavel_centro_p = 'S') and (nm_usuario_centro_w IS NOT NULL AND nm_usuario_centro_w::text <> '') and (obter_se_contido_char(nm_usuario_centro_w,ds_lista_usuarios_w) = 'N') then
		
		ds_observacao_w := Wheb_mensagem_pck.get_Texto(300276); /*'Responsavel do centro de custo';*/
		CALL gerar_comunic_padrao(clock_timestamp(),ds_titulo_w,ds_historico_w,nm_usuario_p,'N',nm_usuario_centro_w,'N',nr_seq_classif_w,null,null,null,clock_timestamp(),null,null,ie_converte_rtf_w);
		CALL grava_solic_compra_hist_envio(nr_sequencia_p,nm_usuario_centro_w,ds_observacao_w,nm_usuario_p);
		ds_lista_usuarios_w := ds_lista_usuarios_w || nm_usuario_centro_w || ',';
	end if;

	if (ie_aprovadores_solic_p = 'S') and (nm_usuario_aprov_w IS NOT NULL AND nm_usuario_aprov_w::text <> '') then
		ds_observacao_w := Wheb_mensagem_pck.get_Texto(333531);
		CALL gerar_comunic_padrao(clock_timestamp(), ds_titulo_w, ds_historico_w, nm_usuario_p, 'N', nm_usuario_aprov_w, 'N', nr_seq_classif_w,null,null,null,clock_timestamp(),null,null,ie_converte_rtf_w);
		CALL grava_solic_compra_hist_envio(nr_sequencia_p, substr(nm_usuario_aprov_w, 1, 255), ds_observacao_w, nm_usuario_p);
		ds_lista_usuarios_w := ds_lista_usuarios_w || nm_usuario_aprov_w;
	end if;
end if;

if (ie_tipo_envio_p in (1,2)) then

	select	max(obter_email_usuario(cd_pessoa_fisica, nm_usuario, cd_estabelecimento_w))
	into STRICT	ds_email_origem_w
	from	usuario
	where	upper(nm_usuario) = upper(nm_usuario_p);

	if (ie_solicitante_os_p = 'S') and (nr_seq_ordem_serv_w IS NOT NULL AND nr_seq_ordem_serv_w::text <> '') then
		
		select	max(ds_email)
		into STRICT	ds_email_solic_os_w
		from	usuario
		where	cd_pessoa_fisica = (
			SELECT	max(cd_pessoa_solicitante)
			from	man_ordem_servico
			where	nr_sequencia = nr_seq_ordem_serv_w);
			
		select	max(obter_usuario_pessoa(cd_pessoa_solicitante))
		into STRICT	nm_usuario_pessoa_solic_OS_w
		from	man_ordem_servico
		where	nr_sequencia = nr_seq_ordem_serv_w;
		
		if (ds_email_solic_os_w IS NOT NULL AND ds_email_solic_os_w::text <> '') then
			ds_observacao_w := substr(Wheb_mensagem_pck.get_Texto(300269, 'NR_SEQ_ORDEM_SERV_W='||NR_SEQ_ORDEM_SERV_W),1,255); /*'Solicitante da ordem de servico ' || NR_SEQ_ORDEM_SERV_W;*/
			CALL enviar_email(ds_titulo_w, ds_historico_email_w, ds_email_origem_w, ds_email_solic_os_w, nm_usuario_p, 'A');
			CALL grava_solic_compra_hist_envio(nr_sequencia_p, nm_usuario_pessoa_solic_OS_w, ds_observacao_w, nm_usuario_p);
			ds_lista_email_w := ds_lista_email_w || ds_email_solic_os_w || ';';
		end if;
	end if;
	
	/*Executor da ordem de servico*/

	if (ie_executor_os_p = 'S') and (nr_seq_ordem_serv_w IS NOT NULL AND nr_seq_ordem_serv_w::text <> '') then
		
		select	max(nm_usuario_exec)
		into STRICT	nm_usuario_exec_OS_w
		from	man_ordem_servico
		where	nr_sequencia = nr_seq_ordem_serv_w;
		
		select	max(ds_email)
		into STRICT	ds_email_exec_os_w
		from	usuario
		where	upper(nm_usuario) = upper(ds_lista_email_w);
		
		if (nm_usuario_exec_OS_w IS NOT NULL AND nm_usuario_exec_OS_w::text <> '') and (ds_email_exec_os_w IS NOT NULL AND ds_email_exec_os_w::text <> '') and (obter_se_contido_char(ds_email_exec_os_w, ds_lista_email_w) = 'N') then
			
			ds_observacao_w := substr(Wheb_mensagem_pck.get_Texto(300270, 'NR_SEQ_ORDEM_SERV_W='||NR_SEQ_ORDEM_SERV_W) || ' - ' || ds_email_exec_os_w,1,255); /*Executor da ordem de servico #@NR_SEQ_ORDEM_SERV_W#@*/
			CALL enviar_email(ds_titulo_w, ds_historico_email_w, ds_email_origem_w, ds_email_exec_os_w, nm_usuario_p, 'A');
			CALL grava_solic_compra_hist_envio(nr_sequencia_p,nm_usuario_exec_OS_w,ds_observacao_w,nm_usuario_p);
			ds_lista_email_w := ds_lista_email_w || ds_email_solic_os_w || ';';
		end if;
	end if;

	/*Solicitante da Solicitacao*/

	if (ie_solicitante_solic_p = 'S') and (nm_usuario_pessoa_solic_w IS NOT NULL AND nm_usuario_pessoa_solic_w::text <> '') and (ds_email_pessoa_solic_w IS NOT NULL AND ds_email_pessoa_solic_w::text <> '') and (obter_se_contido_char(ds_email_pessoa_solic_w, ds_lista_email_w) = 'N') then
		ds_observacao_w := substr(Wheb_mensagem_pck.get_Texto(300271) || ' - ' || ds_email_pessoa_solic_w,1,255);/* 'Solicitante da solicitacao de compras';*/
		CALL enviar_email(ds_titulo_w, ds_historico_email_w, ds_email_origem_w, ds_email_pessoa_solic_w, nm_usuario_p, 'A');
		CALL grava_solic_compra_hist_envio(nr_sequencia_p,nm_usuario_pessoa_solic_w,ds_observacao_w,nm_usuario_p);
		ds_lista_email_w := ds_lista_email_w || ds_email_pessoa_solic_w || ';';
	end if;
	
	/*Comprador resp da Solicitacao*/

	if (ie_comprador_solic_p = 'S') and (nm_usuario_comprador_resp_w IS NOT NULL AND nm_usuario_comprador_resp_w::text <> '') and (ds_email_comprador_resp_w IS NOT NULL AND ds_email_comprador_resp_w::text <> '') and (obter_se_contido_char(ds_email_comprador_resp_w, ds_lista_email_w) = 'N') then
		ds_observacao_w := substr(Wheb_mensagem_pck.get_Texto(300272) || ' - ' || ds_email_comprador_resp_w,1,255); /*'Comprador responsavel da solicitacao de compras';*/
		CALL enviar_email(ds_titulo_w, ds_historico_email_w, ds_email_origem_w, ds_email_comprador_resp_w, nm_usuario_p, 'A');
		CALL grava_solic_compra_hist_envio(nr_sequencia_p, nm_usuario_comprador_resp_w, ds_observacao_w, nm_usuario_p);
		ds_lista_email_w := ds_lista_email_w || ds_email_comprador_resp_w || ';';
	end if;
	
	/*Comprador parametro de compras*/

	if (ie_comprador_param_p = 'S') and (nm_usuario_comprador_padrao_w IS NOT NULL AND nm_usuario_comprador_padrao_w::text <> '') and (ds_email_comprador_padrao_w IS NOT NULL AND ds_email_comprador_padrao_w::text <> '') and (obter_se_contido_char(ds_email_comprador_padrao_w, ds_lista_email_w) = 'N') then
		ds_observacao_w := substr(Wheb_mensagem_pck.get_Texto(300273) || ' - ' || ds_email_comprador_padrao_w,1,255); /*'Comprador dos parametros de compras';*/
		CALL enviar_email(ds_titulo_w, ds_historico_email_w, ds_email_origem_w, ds_email_comprador_padrao_w, nm_usuario_p, 'A');
		CALL grava_solic_compra_hist_envio(nr_sequencia_p,nm_usuario_comprador_padrao_w,ds_observacao_w,nm_usuario_p);
		ds_lista_email_w := ds_lista_email_w || ds_email_comprador_padrao_w || ';';
	end if;

	/*Responsavel compras dos parametro de compras*/

	if (ie_responsavel_param_p = 'S') and (nm_usuario_resp_compras_w IS NOT NULL AND nm_usuario_resp_compras_w::text <> '') and (ds_email_resp_compras_w IS NOT NULL AND ds_email_resp_compras_w::text <> '') and (obter_se_contido_char(ds_email_resp_compras_w, ds_lista_email_w) = 'N') then
		ds_observacao_w := substr(Wheb_mensagem_pck.get_Texto(300274) || ' - ' || ds_email_resp_compras_w,1,255); /*'Responsavel compras dos parametros de compras';*/
		CALL enviar_email(ds_titulo_w, ds_historico_email_w, ds_email_origem_w, ds_email_resp_compras_w, nm_usuario_p, 'A');
		CALL grava_solic_compra_hist_envio(nr_sequencia_p, nm_usuario_resp_compras_w, ds_observacao_w, nm_usuario_p);
		ds_lista_email_w := ds_lista_email_w || ds_email_resp_compras_w || ';';
	end if;
	
	/*Solicitante padrao dos parametro de compras*/

	if (ie_solicitante_param_p = 'S') and (nm_usuario_solic_padrao_w IS NOT NULL AND nm_usuario_solic_padrao_w::text <> '') and (ds_email_pessoa_solic_padrao_w IS NOT NULL AND ds_email_pessoa_solic_padrao_w::text <> '') and (obter_se_contido_char(ds_email_pessoa_solic_padrao_w, ds_lista_email_w) = 'N') then
		ds_observacao_w := substr(wheb_mensagem_pck.get_Texto(300275) || ' - ' || ds_email_pessoa_solic_padrao_w, 1, 255); /*'Solicitante padrao dos parametros de compras';*/
		CALL enviar_email(ds_titulo_w, ds_historico_email_w, ds_email_origem_w, ds_email_pessoa_solic_padrao_w, nm_usuario_p, 'A');
		CALL grava_solic_compra_hist_envio(nr_sequencia_p, nm_usuario_solic_padrao_w, ds_observacao_w, nm_usuario_p);
		ds_lista_email_w := ds_lista_email_w || ds_email_pessoa_solic_padrao_w || ';';
	end if;

	/*Responsavel do setor*/

	if (ie_responsavel_centro_p = 'S') and (nm_usuario_centro_w IS NOT NULL AND nm_usuario_centro_w::text <> '') and (ds_email_resp_w IS NOT NULL AND ds_email_resp_w::text <> '') and (obter_se_contido_char(ds_email_resp_w, ds_lista_usuarios_w) = 'N') then
		ds_observacao_w := substr(Wheb_mensagem_pck.get_Texto(300276) || ' - ' || ds_email_resp_w,1,255); /*'Responsavel do centro de custo';*/
		CALL enviar_email(ds_titulo_w, ds_historico_email_w, ds_email_origem_w, ds_email_resp_w, nm_usuario_p, 'A');
		CALL grava_solic_compra_hist_envio(nr_sequencia_p, nm_usuario_centro_w, ds_observacao_w, nm_usuario_p);
		ds_lista_email_w := ds_lista_email_w || ds_email_resp_w || ',';
	end if;
	
	if (ie_aprovadores_solic_p = 'S') and (nm_usuario_aprov_w IS NOT NULL AND nm_usuario_aprov_w::text <> '') then
		open C02;
		loop
		fetch C02 into	
			ds_email_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			begin
			ds_observacao_w := substr(Wheb_mensagem_pck.get_Texto(333531) || ' - ' || ds_email_w, 1, 255);
			CALL enviar_email(ds_titulo_w, ds_historico_email_w, ds_email_origem_w, ds_email_w, nm_usuario_p, 'A');
			CALL grava_solic_compra_hist_envio(nr_sequencia_p, substr(nm_usuario_aprov_w,1,255), ds_observacao_w, nm_usuario_p);
			end;
		end loop;
		close C02;
	end if;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE enviar_comunic_hist_solic ( nr_sequencia_p bigint, ie_solicitante_os_p text, ie_executor_os_p text, ie_solicitante_solic_p text, ie_comprador_solic_p text, ie_comprador_param_p text, ie_responsavel_param_p text, ie_solicitante_param_p text, ie_responsavel_centro_p text, ie_aprovadores_solic_p text, ie_tipo_envio_p bigint, nm_usuario_p text, ie_converte_rtf_p text default 'S') FROM PUBLIC;

