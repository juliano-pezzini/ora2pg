-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE desfazer_auditoria (nr_seq_auditoria_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
			   
ie_tipo_auditoria_w		varchar(1);
nr_seq_matpaci_w		bigint;
nr_seq_propaci_w		bigint;
nr_interno_conta_w		bigint;
cd_convenio_w			integer;
cd_categoria_w			varchar(10);
vl_tabela_original_w		double precision;
cd_motivo_exc_conta_w		smallint;
cd_estabelecimento_w		smallint;
dt_liberacao_w			timestamp;
nr_seq_item_gerado_w		bigint;
ie_recalcular_conta_w  	varchar(1);
cd_procedimento_w		bigint;
ie_origem_proced_w		bigint;
ie_responsavel_credito_w 	varchar(5);
cd_setor_atendimento_w		integer;
nr_atendimento_w		bigint;
cd_especialidade_medica_w 	integer:= 0;
dt_procedimento_w		timestamp;
cd_cgc_prestador_w		varchar(14);
cd_estrutura_w			integer 		:= 0;
cd_estrutura_honor_w		integer 		:= 0;
ie_emite_conta_w      	varchar(3);
ie_emite_conta_honor_w    	varchar(3);
ie_tipo_atendimento_w		smallint;
cd_medico_executor_w		varchar(10);
nr_seq_cor_exec_w		bigint;
cd_material_w			bigint;
ie_Gerar_Pendencia_w		varchar(1);

C01 CURSOR FOR 
	SELECT	ie_tipo_auditoria, 
		nr_seq_matpaci 
	from	auditoria_matpaci 
	where	nr_seq_auditoria = nr_seq_auditoria_p 
	order by nr_seq_matpaci;
	
C02 CURSOR FOR 
	SELECT	ie_tipo_auditoria, 
		nr_seq_propaci 
	from	auditoria_propaci 
	where	nr_seq_auditoria = nr_seq_auditoria_p 
	order by nr_seq_propaci;
	
c03 CURSOR FOR 
	SELECT 	nr_sequencia, 
		nr_seq_cor_exec 
	from 	material_atend_paciente 
	where	nr_interno_conta = nr_interno_conta_w 
	and 	ie_auditoria = 'S' 
	and 	Obter_se_gerado_lib_audit(nr_sequencia, 2) = 'S' 
	and 	(dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '') 
	and 	coalesce(nr_seq_proc_pacote::text, '') = '' 
	order by nr_sequencia;
	
c04 CURSOR FOR 
	SELECT 	nr_sequencia, 
		nr_seq_cor_exec 
	from 	procedimento_paciente 
	where	nr_interno_conta = nr_interno_conta_w 
	and 	ie_auditoria = 'S' 
	and 	Obter_se_gerado_lib_audit(nr_sequencia, 1) = 'S' 
	and 	(dt_liberacao_w IS NOT NULL AND dt_liberacao_w::text <> '') 
	and 	coalesce(nr_seq_proc_pacote::text, '') = '' 
	order by nr_sequencia;
		
			   

BEGIN 
 
select 	max(nr_interno_conta), 
	max(dt_liberacao) 
into STRICT	nr_interno_conta_w, 
	dt_liberacao_w 
from 	auditoria_conta_paciente 
where 	nr_sequencia = nr_seq_auditoria_p;
 
select 	max(cd_convenio_parametro), 
	max(cd_categoria_parametro), 
	max(cd_estabelecimento), 
	max(nr_atendimento) 
into STRICT	cd_convenio_w, 
	cd_categoria_w, 
	cd_estabelecimento_w, 
	nr_atendimento_w 
from 	conta_paciente 
where 	nr_interno_conta = nr_interno_conta_w;
 
 
select 	max(ie_tipo_atendimento) 
into STRICT	ie_tipo_atendimento_w 
from 	atendimento_paciente 
where 	nr_atendimento = nr_atendimento_w;
	 
 
cd_motivo_exc_conta_w:= obter_valor_param_usuario(1116, 19, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w);
ie_recalcular_conta_w:= obter_valor_param_usuario(1116, 130, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w);
ie_Gerar_Pendencia_w := obter_valor_param_usuario(1116, 136, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w);
 
if (coalesce(cd_motivo_exc_conta_w,0) = 0) then 
 
	select 	max(cd_motivo_exc_conta) 
	into STRICT	cd_motivo_exc_conta_w 
	from 	parametro_faturamento 
	where 	cd_estabelecimento = cd_estabelecimento_w;
 
end if;
 
-- Cursor dos materiais que foram gerados através do ajuste de quantidades informado nos itens 
open C03;
loop 
fetch C03 into	 
	nr_seq_item_gerado_w, 
	nr_seq_cor_exec_w;
EXIT WHEN NOT FOUND; /* apply on C03 */
	begin 
	 
	if (coalesce(nr_seq_cor_exec_w,0) = 431) then 
		CALL excluir_matproc_conta(nr_seq_item_gerado_w,nr_interno_conta_w,cd_motivo_exc_conta_w,WHEB_MENSAGEM_PCK.get_texto(299357),'M',nm_usuario_p);
	else 
		CALL excluir_matproc_auditoria(nr_seq_item_gerado_w, 'M', nr_seq_auditoria_p);
	end if;
	 
	end;
end loop;
close C03;
 
-- Cursor dos procedimentos que foram gerados através do ajuste de quantidades informado nos itens 
open C04;
loop 
fetch C04 into	 
	nr_seq_item_gerado_w, 
	nr_seq_cor_exec_w;
EXIT WHEN NOT FOUND; /* apply on C04 */
	begin 
	 
	if (coalesce(nr_seq_cor_exec_w,0) = 431) then 
		CALL excluir_matproc_conta(nr_seq_item_gerado_w,nr_interno_conta_w,cd_motivo_exc_conta_w,WHEB_MENSAGEM_PCK.get_texto(299357),'P',nm_usuario_p);	
	else 
		CALL excluir_matproc_auditoria(nr_seq_item_gerado_w, 'P', nr_seq_auditoria_p);
	end if;	
	 
	end;
end loop;
close C04;
 
 
open C01;
loop 
fetch C01 into	 
	ie_tipo_auditoria_w, 
	nr_seq_matpaci_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	 
	--Execução, Novo lançamento 
	if (ie_tipo_auditoria_w = 'E') then 
 
		delete from  auditoria_matpaci 
		where nr_seq_matpaci = nr_seq_matpaci_w 
		and  nr_seq_auditoria = nr_seq_auditoria_p;
	 
		CALL excluir_matproc_conta(nr_seq_matpaci_w,nr_interno_conta_w,cd_motivo_exc_conta_w,WHEB_MENSAGEM_PCK.get_texto(299358),'M',nm_usuario_p);
		 
	end if;
	 
	 
	-- Excluído da conta 
	if (ie_tipo_auditoria_w = 'X') then 
					 
		select	max(cd_material), 
			max(cd_setor_atendimento), 
			max(ie_responsavel_credito) 
		into STRICT	cd_material_w, 
			cd_setor_atendimento_w, 
			ie_responsavel_credito_w 
		from 	material_atend_paciente 
		where 	nr_sequencia = nr_seq_matpaci_w;
		 
		ie_emite_conta_w := null;
		 
		cd_estrutura_w := obter_estrut_conta_mat(	cd_convenio_w, cd_material_w, cd_setor_atendimento_w, ie_tipo_atendimento_w, ie_responsavel_credito_w, cd_estabelecimento_w, cd_estrutura_w);
		if (cd_estrutura_w	> 0) then 
			ie_emite_conta_w	:= cd_estrutura_w;
		end if;
		 
		Update	material_atend_paciente 
        set  	NR_INTERNO_CONTA 	= nr_interno_conta_w, 
            CD_MOTIVO_EXC_CONTA 	 = NULL, 
			DS_COMPL_MOTIVO_EXCON 	 = NULL, 
            cd_convenio  		= cd_convenio_w, 
            cd_categoria  		= cd_categoria_w, 
			ie_emite_conta		= ie_emite_conta_w 
        where 	nr_sequencia 		= nr_seq_matpaci_w;
		 
		delete from  auditoria_matpaci 
		where nr_seq_matpaci = nr_seq_matpaci_w 
		and  nr_seq_auditoria = nr_seq_auditoria_p;
	 
	end if;
	 
	-- Alteração de valor 
	if (ie_tipo_auditoria_w = 'V') then 
	 
		delete from  auditoria_matpaci 
		where nr_seq_matpaci = nr_seq_matpaci_w 
		and  nr_seq_auditoria = nr_seq_auditoria_p;
		 
		update	material_atend_paciente 
		set	ie_valor_informado = 'N' 
		where 	nr_sequencia = nr_seq_matpaci_w;
		 
		CALL atualiza_preco_material(nr_seq_matpaci_w, nm_usuario_p);		
		 
	end if;
	 
	-- Demais opções 
	if (ie_tipo_auditoria_w not in ('E','X','V')) then 
	 
		delete from  auditoria_matpaci 
		where nr_seq_matpaci = nr_seq_matpaci_w 
		and  nr_seq_auditoria = nr_seq_auditoria_p;
		 
	end if;
	 
	CALL excluir_matproc_auditoria(nr_seq_matpaci_w, 'M', nr_seq_auditoria_p);
	 
	end;
end loop;
close C01;
 
 
 
open C02;
loop 
fetch C02 into	 
	ie_tipo_auditoria_w, 
	nr_seq_propaci_w;
EXIT WHEN NOT FOUND; /* apply on C02 */
	begin 
	 
	--Execução, Novo lançamento 
	if (ie_tipo_auditoria_w = 'E') then 
		delete from  auditoria_propaci 
		where nr_seq_propaci = nr_seq_propaci_w 
		and  nr_seq_auditoria = nr_seq_auditoria_p;
	 
		CALL excluir_matproc_conta(nr_seq_propaci_w,nr_interno_conta_w,cd_motivo_exc_conta_w,WHEB_MENSAGEM_PCK.get_texto(299358),'P',nm_usuario_p);
		 
	end if;
	 
	 
	-- Excluído da conta 
	if (ie_tipo_auditoria_w = 'X') then		 
		 
		 
		select	max(cd_procedimento), 
			max(ie_origem_proced), 
			max(cd_medico_executor), 
			max(ie_responsavel_credito), 
			max(cd_setor_atendimento), 
			max(cd_especialidade), 
			max(dt_procedimento), 
			max(cd_cgc_prestador) 
		into STRICT	cd_procedimento_w, 
			ie_origem_proced_w, 
			cd_medico_executor_w, 
			ie_responsavel_credito_w, 
			cd_setor_atendimento_w, 
			cd_especialidade_medica_w, 
			dt_procedimento_w, 
			cd_cgc_prestador_w 
		from 	procedimento_paciente 
		where 	nr_sequencia = nr_seq_propaci_w;
		 
		SELECT * FROM obter_estrut_conta_proc( 
			cd_convenio_w, cd_procedimento_w, ie_origem_proced_w, null, cd_medico_executor_w, ie_responsavel_credito_w, nr_seq_propaci_w, cd_setor_atendimento_w, ie_tipo_atendimento_w, cd_estabelecimento_w, cd_especialidade_medica_w, cd_categoria_w, dt_procedimento_w, cd_cgc_prestador_w, cd_estrutura_w, cd_estrutura_honor_w) INTO STRICT cd_estrutura_w, cd_estrutura_honor_w;
			 
		ie_emite_conta_w			:= null;
		ie_emite_conta_honor_w			:= null;
		 
		if (cd_estrutura_w	> 0) then 
			ie_emite_conta_w	:= cd_estrutura_w;
		end if;
		if (cd_estrutura_honor_w	> 0) then 
			ie_emite_conta_honor_w	:= cd_estrutura_honor_w;
		end if;
		 
		Update	procedimento_paciente 
        set  	NR_INTERNO_CONTA 	= nr_interno_conta_w, 
            CD_MOTIVO_EXC_CONTA 	 = NULL, 
			DS_COMPL_MOTIVO_EXCON 	 = NULL, 
            cd_convenio  		= cd_convenio_w, 
            cd_categoria  		= cd_categoria_w, 
			ie_emite_conta		= ie_emite_conta_w, 
			ie_emite_conta_honor	= ie_emite_conta_honor_w 
        where 	nr_sequencia 		= nr_seq_propaci_w;
		 
		delete from  auditoria_propaci 
		where nr_seq_propaci = nr_seq_propaci_w 
		and  nr_seq_auditoria = nr_seq_auditoria_p;
	 
	end if;
	 
	-- Alteração de valor 
	if (ie_tipo_auditoria_w = 'V') then 
	 
		delete from  auditoria_propaci 
		where nr_seq_propaci = nr_seq_propaci_w 
		and  nr_seq_auditoria = nr_seq_auditoria_p;
		 
		update	procedimento_paciente 
		set	ie_valor_informado = 'N' 
		where 	nr_sequencia = nr_seq_propaci_w;
		 
		update	procedimento_participante 
		set	ie_valor_informado = 'N', 
			pr_faturar	  = 100 
		where 	nr_sequencia = nr_seq_propaci_w;
		 
		CALL atualiza_preco_procedimento(nr_seq_propaci_w, cd_convenio_w, nm_usuario_p);
		 
	end if;
	 
	-- Demais opções 
	if (ie_tipo_auditoria_w not in ('E','X','V')) then 
	 
		delete from  auditoria_propaci 
		where nr_seq_propaci = nr_seq_propaci_w 
		and  nr_seq_auditoria = nr_seq_auditoria_p;
		 
	end if;
	 
	CALL excluir_matproc_auditoria(nr_seq_propaci_w, 'P', nr_seq_auditoria_p);
	 
	end;
end loop;
close C02;
 
 
if (ie_Gerar_Pendencia_w = 'V') then 
 
	update	auditoria_conta_paciente 
	set	nr_seq_audit_vinc  = NULL 
	where	nr_seq_audit_vinc = nr_seq_auditoria_p;
 
	CALL Excluir_Pendencia_Vinculada(nr_interno_conta_w, nr_seq_auditoria_p, nm_usuario_p);
	 
end if;
 
delete from auditoria_conta_paciente 
where nr_sequencia = nr_seq_auditoria_p;
 
if (coalesce(ie_recalcular_conta_w,'S') = 'S') then 
	CALL recalcular_conta_paciente(nr_interno_conta_w, nm_usuario_p);
end if;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE desfazer_auditoria (nr_seq_auditoria_p bigint, nm_usuario_p text) FROM PUBLIC;

