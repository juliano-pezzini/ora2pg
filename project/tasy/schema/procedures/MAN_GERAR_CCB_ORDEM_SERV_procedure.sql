-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_gerar_ccb_ordem_serv ( nr_seq_ordem_serv_p bigint, nr_seq_impacto_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_customer_requirement_w	reg_customer_requirement.nr_sequencia%type := 0;
ds_titulo_w		man_ordem_serv_impacto.ds_titulo%type;

nr_seq_project_w		bigint;
nm_usuario_aprov_w		varchar(15);
ie_all_ccb_approved_w		varchar(1);
ie_impacto_requisito_w 		varchar(1);
ie_ajuste_doc_w 		varchar(1);
ds_texto_clob_w			text;
dt_aprovacao_w			timestamp;
ie_status_w			man_ordem_serv_aprov_ccb.ie_status%type;
ds_conteudo_1_w			varchar(32764);
ds_conteudo_2_w			varchar(32764);
nr_seq_hist_w			bigint;
ds_sql_w			varchar(2000);
c001				integer;
retorno_w			integer;
nr_seq_ordem_serv_superior_w	man_ordem_servico.nr_sequencia%type;
nr_seq_intencao_uso_w		ccb_equipe.nr_seq_intencao_uso%type;


/**
* Get all the groups responsible for approving the CCB record.
* The 'order by' clause just guarantees that the first group will be the System
* Analyst group.
*/
c01 CURSOR FOR
	SELECT	ce.nr_sequencia nr_seq_equipe,
		ce.ie_tipo_equipe,
		CASE WHEN ce.ie_tipo_equipe='SA' THEN 0  ELSE 1 END  ie_order
	from	ccb_equipe ce
	where	ce.ie_situacao = 'A'
	and	coalesce(ce.ie_tipo_equipe, 'X') <> 'ES'
	and	ce.nr_seq_intencao_uso = nr_seq_intencao_uso_w
	
union

	SELECT	rpc.nr_seq_equipe,
		ce.ie_tipo_equipe,
		CASE WHEN ce.ie_tipo_equipe='SA' THEN 0  ELSE 1 END  ie_order
	from	man_ordem_serv_impacto mosi,
		man_ordem_serv_imp_pr mosip,
		reg_product_ccb rpc,
		ccb_equipe ce
	where	mosi.nr_sequencia = nr_seq_impacto_p
	and	mosi.nr_sequencia = mosip.nr_seq_impacto
	and	rpc.nr_product_requirement = mosip.nr_product_requirement
	and	ce.nr_sequencia = rpc.nr_seq_equipe
	and	rpc.ie_situacao = 'A'
	and	coalesce(ce.ie_situacao, 'A') = 'A'
	order by ie_order;

c02 CURSOR FOR
	SELECT	distinct obter_usuario_pf(c.cd_pessoa_fisica) nm_usuario_exec,
		b.nr_seq_tipo_executor nr_seq_tipo_executor
	from	man_ordem_serv_aprov_ccb a,
		ccb_equipe b,
		ccb_equipe_regra c
	where	a.nr_seq_equipe 		= b.nr_sequencia
	and	c.nr_seq_equipe 		= b.nr_sequencia
	and	a.nr_seq_ordem_serv 	= nr_seq_ordem_serv_p
	and	a.nr_seq_impacto 		= nr_seq_impacto_p
	and	c.nr_seq_equipe 		<> 5
	and	(obter_usuario_pf(c.cd_pessoa_fisica) IS NOT NULL AND (obter_usuario_pf(c.cd_pessoa_fisica))::text <> '')
	and	obter_gerencia_usuario_wheb(obter_usuario_pf(c.cd_pessoa_fisica)) = obter_gerencia_usuario_wheb(nm_usuario_p)

union

	SELECT	distinct obter_usuario_pf(p.cd_pessoa_fisica) nm_usuario_exec,
		b.nr_seq_tipo_executor nr_seq_tipo_executor
	from	man_ordem_serv_aprov_ccb a,
		ccb_equipe b,
		ccb_equipe_regra c,
		pessoa_fisica p
	where	a.nr_seq_equipe 		= b.nr_sequencia
	and	b.nr_sequencia 		= c.nr_seq_equipe
	and	a.nr_seq_ordem_serv 	= nr_seq_ordem_serv_p
	and	a.nr_seq_impacto 		= nr_seq_impacto_p
	and	c.nr_seq_equipe 		<> 5
	and	obter_gerencia_usuario_wheb(obter_usuario_pf(p.cd_pessoa_fisica)) = obter_gerencia_usuario_wheb(nm_usuario_p)
	and	c.cd_cargo 		= p.cd_cargo
	order by 1;

c03 CURSOR FOR
	SELECT	ac.ds_area,
		fc.ds_feature,
		cr.nr_sequencia nr_customer_requirement,
		cr.cd_crs_id,
		cr.nm_curto ds_customer_requirement,
		pr.ds_title,
		pr.nr_sequencia,
		pr.cd_prs_id,
		obter_valor_dominio(8844,imp_pr.ie_impacto_requisito) ie_impacto_requisito,
		imp_pr.nr_sequencia nr_seq_imp_pr
	from	reg_area_customer ac,
		reg_features_customer fc,
		reg_customer_requirement cr,
		reg_product_requirement pr,
		man_ordem_serv_imp_pr imp_pr
	where	ac.nr_sequencia 		= fc.nr_seq_area_customer
	and	fc.nr_sequencia 		= cr.nr_seq_features
	and	cr.nr_sequencia 		= pr.nr_customer_requirement
	and	pr.nr_sequencia 		= imp_pr.nr_product_requirement
	and	imp_pr.nr_seq_impacto 	= nr_seq_impacto_p;

c04 CURSOR(nr_seq_product_req_p	bigint) FOR
	SELECT	a.nr_sequencia nr_seq_reg_funcao_pr,
		obter_desc_expressao_idioma(b.cd_exp_funcao, b.ds_funcao, 5) ds_funcao
	from	reg_funcao_pr a,
		funcao b
	where	a.nr_seq_product_req 	= nr_seq_product_req_p
	and	a.cd_funcao 		= b.cd_funcao
	order by 1;

BEGIN

	select	max(pp.nr_sequencia)
	into STRICT	nr_seq_project_w
	from	proj_projeto pp
	where	pp.nr_seq_ordem_serv = nr_seq_ordem_serv_p;

	select 	CASE WHEN count(1)=0 THEN  'N'  ELSE 'S' END
	into STRICT 	ie_impacto_requisito_w
	from 	man_ordem_serv_imp_pr
	where 	nr_seq_impacto = nr_seq_impacto_p
	and 	ie_impacto_requisito in ('I', 'A', 'E');

	select 	coalesce(max('S'), 'N')
	into STRICT 	ie_ajuste_doc_w
	from 	man_ordem_servico
	where 	nr_sequencia 		= nr_seq_ordem_serv_p
	and 	ie_tipo_ordem 		= 28
	and 	ie_classificacao 		= 'E'
	and 	ie_classificacao_cliente 	= 'A'
	and 	exists (
			SELECT 	1
			from 	man_ordem_serv_imp_pr
			where 	nr_seq_impacto 		= nr_seq_impacto_p
			and 	ie_impacto_requisito 	= 'D'
	);
	
	
	select	coalesce(min(ac.nr_seq_intencao_uso),2) --Intencao de uso Tasy - padrao que sempre foi
	into STRICT	nr_seq_intencao_uso_w
	from	reg_area_customer ac,
		reg_features_customer fc,
		reg_customer_requirement cr,
		reg_product_requirement pr,
		man_ordem_serv_imp_pr imp_pr
	where	ac.nr_sequencia 		= fc.nr_seq_area_customer
	and	fc.nr_sequencia 		= cr.nr_seq_features
	and	cr.nr_sequencia 		= pr.nr_customer_requirement
	and	pr.nr_sequencia 		= imp_pr.nr_product_requirement
	and	imp_pr.nr_seq_impacto 	= nr_seq_impacto_p;
	
	for r_c01 in c01 loop
		if (r_c01.ie_tipo_equipe = 'SA') then
			dt_aprovacao_w 		:= clock_timestamp();
			nm_usuario_aprov_w 	:= nm_usuario_p;
			ie_status_w 		:= 'A';
		else
			dt_aprovacao_w 		:= null;
			nm_usuario_aprov_w 	:= null;
			ie_status_w 		:= 'P';
		end if;
		
		if (r_c01.ie_tipo_equipe = 'SA' or ie_impacto_requisito_w = 'S') then
		
			insert into man_ordem_serv_aprov_ccb(
				nr_sequencia,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nm_usuario,
				nm_usuario_nrec,
				nr_seq_ordem_serv,
				nr_seq_equipe,
				nr_seq_impacto,
				ie_status,
				dt_aprovacao,
				nm_usuario_aprov )
			values (	nextval('man_ordem_serv_aprov_ccb_seq'),
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_p,
				nm_usuario_p,
				nr_seq_ordem_serv_p,
				r_c01.nr_seq_equipe,
				nr_seq_impacto_p,
				ie_status_w,
				dt_aprovacao_w,
				nm_usuario_aprov_w );

			for r_c02 in c02 loop
				CALL man_inserir_usuario_executor(nr_seq_ordem_serv_p, r_c02.nm_usuario_exec, nm_usuario_p, null, r_c02.nr_seq_tipo_executor);
			end loop;
		end if;
		
		if (r_c01.ie_tipo_equipe = 'SA' and ie_ajuste_doc_w = 'S') then	-- Ajuste de documentacao deve gerar apenas a equipe do System analyst, depende do order by do cursor.
			exit;
		end if;
	end loop;

	CALL man_gerar_ccb_especialista(nr_seq_impacto_p, nm_usuario_p);

	commit;

	select	ds_titulo
	into STRICT	ds_titulo_w
	from	man_ordem_serv_impacto
	where	nr_sequencia = nr_seq_impacto_p;

	ds_texto_clob_w	:= '<!DOCTYPE html>
	<html>
	<head>
	<style>
		#objSection {
			margin-left: 25px;
		}

		#obj {
			font-family: none;
			margin-left: 50px;
		}

		p {
			padding-left: 10px;
			margin: 0;
		}
	</style>
	</head>
	<body><h2>' || ds_titulo_w || '</h2>';

	for r_c03 in c03 loop
		begin

		if (r_c03.nr_customer_requirement <> nr_customer_requirement_w) then
			ds_texto_clob_w := ds_texto_clob_w || '<h4>URS ' || r_c03.cd_crs_id || ': ' || r_c03.ds_customer_requirement || '</h4>';
		end if;

		ds_texto_clob_w	:= ds_texto_clob_w ||'<p><b>PRS '|| r_c03.cd_prs_id ||': '||r_c03.ds_title||'</b></p>';
		ds_texto_clob_w	:= ds_texto_clob_w ||'<p>Type of impact in the requirement: ' || r_c03.ie_impacto_requisito || '</p>';
		ds_texto_clob_w	:= ds_texto_clob_w ||'<p><b>Functions:</b>';
		for r_c04 in c04(r_c03.nr_sequencia) loop
			ds_texto_clob_w := ds_texto_clob_w || ' ' || r_c04.ds_funcao|| ',';
		end loop;

		ds_texto_clob_w := ds_texto_clob_w || '</p><br>';

		nr_customer_requirement_w := r_c03.nr_customer_requirement;
		end;
	end loop;

	ds_texto_clob_w	:= ds_texto_clob_w || '</tbody></table></body></html>';

	select	nextval('man_ordem_serv_tecnico_seq')
	into STRICT	nr_seq_hist_w
	;

	insert into man_ordem_serv_tecnico(
		nr_sequencia,
		nr_seq_ordem_serv,
		dt_atualizacao,
		nm_usuario,
		ds_relat_tecnico,
		dt_historico,
		dt_liberacao,
		ie_origem,
		nr_seq_tipo )
	values ( 	nr_seq_hist_w,
		nr_seq_ordem_serv_p,
		clock_timestamp(),
		'Tasy',
		' ',
		clock_timestamp(),
		clock_timestamp(),
		'I',
		183 ); -- CCB Request

	/* Tratativa para caso o campo tenha mais de 32kb */

	ds_conteudo_1_w := substr(ds_texto_clob_w,32764,1);
	ds_conteudo_2_w := substr(ds_texto_clob_w,32764,32765);
	
	
	ds_sql_w	:= ' update man_ordem_serv_tecnico set ds_relat_tecnico = :ds_texto_clob_w where nr_sequencia = :nr_seq_hist ';
	c001 := dbms_sql.open_cursor;
	dbms_sql.parse(c001, ds_sql_w, dbms_sql.native);
	dbms_sql.bind_variable(c001, 'ds_texto_clob_w', ds_conteudo_1_w || ds_conteudo_2_w);
	dbms_sql.bind_variable(c001, 'nr_seq_hist', nr_seq_hist_w);
	retorno_w := dbms_sql.execute(c001);
	dbms_sql.close_cursor(c001);
	
	select	CASE WHEN count(1)=0 THEN  'S'  ELSE 'N' END
	into STRICT	ie_all_ccb_approved_w
	from	man_ordem_serv_aprov_ccb
	where	nr_seq_ordem_serv = nr_seq_ordem_serv_p
	and	nr_seq_impacto = nr_seq_impacto_p
	and	coalesce(dt_aprovacao::text, '') = '';

	if (ie_all_ccb_approved_w = 'S') then
		CALL man_aprov_analise_impacto(nr_seq_impacto_p, nm_usuario_p);
	end if;

	commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_gerar_ccb_ordem_serv ( nr_seq_ordem_serv_p bigint, nr_seq_impacto_p bigint, nm_usuario_p text) FROM PUBLIC;

