-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ctb_pls_contab_receita_copart ( nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text) AS $body$
DECLARE


dt_referencia_w			timestamp;
cd_estabelecimento_w		smallint;
cd_conta_contabil_w		varchar(20);
cd_conta_antecip_w		varchar(20);
cd_conta_deb_antecip_w		varchar(20);
ie_debito_credito_w		varchar(20);
vl_contabil_w			double precision;
vl_retorno_w			varchar(2000);
dt_referencia_mens_w		timestamp;
nr_seq_w_movto_cont_w		bigint;
cd_historico_w			bigint;
nr_seq_mensalidade_w		bigint;
nr_seq_nota_fiscal_w		bigint;
pr_imposto_w			double precision;
cd_tributo_w			smallint;
vl_imposto_w			double precision;
pr_imposto_total_w		double precision;
cd_conta_imposto_w		varchar(20);
cd_centro_custo_w		integer;
ie_centro_custo_w		varchar(1);
nr_seq_item_w			bigint;
ds_item_w			varchar(255);
nr_lote_contabil_w		bigint;
ie_tipo_valor_w			varchar(2);
nr_seq_pagador_w		bigint;
ie_tipo_pagador_w		varchar(2);
cd_historico_imposto_cred_w	bigint;
cd_historico_imposto_deb_w	bigint;
cd_historico_antecip_w		bigint;
ie_cancelamento_w		varchar(1);
nr_seq_regra_w			bigint;
ie_tipo_item_w			varchar(2);
nr_lote_contab_antecip_w	bigint;
ie_tipo_conta_w			varchar(2);
nr_nota_fiscal_w		varchar(255);
nr_titulo_w			bigint;
cd_cgc_pagador_w		varchar(14);
cd_pf_pagador_w			varchar(10);
ie_compl_hist_w			varchar(1);
ds_conteudo_w			varchar(4000);
ds_compl_historico_w		varchar(255);
ds_compl_historico_ww		varchar(255);
ds_compl_hist_imposto_cred_w	varchar(255);
ds_compl_hist_imposto_cred_ww	varchar(255);
ds_compl_hist_imposto_deb_w	varchar(255);
ds_compl_hist_imposto_deb_ww	varchar(255);
cd_conta_imposto_cred_w		varchar(20);
cd_conta_imposto_deb_w		varchar(20);
ie_tipo_segurado_w		varchar(3);
ie_tipo_contratacao_w		varchar(2);
nr_seq_copartic_w		bigint;
nm_pagador_w			varchar(255);
nr_seq_regra_cc_w		bigint;
vl_pro_rata_dia_w		double precision;
vl_antecipacao_w		double precision;
nr_lote_contab_antecip_ww	bigint;

C01 CURSOR FOR
	SELECT	b.cd_conta_rec,
		b.cd_conta_rec_antecip,
		coalesce(b.vl_antecipacao,0),
		coalesce(b.cd_historico,1),
		b.nr_lote_contab_antecip
	from	pls_lote_mensalidade f,
		pls_mensalidade e,
		pls_plano d,
		pls_segurado c,
		pls_mensalidade_seg_item b,
		pls_mensalidade_segurado a
	where	a.nr_seq_segurado	= c.nr_sequencia
	and	c.nr_seq_plano		= d.nr_sequencia
	and	e.nr_sequencia		= a.nr_seq_mensalidade
	and	f.nr_sequencia		= e.nr_seq_lote
	and	b.nr_lote_contab_antecip	= nr_lote_contabil_p
	and	a.nr_sequencia		= b.nr_seq_mensalidade_seg
	and	b.ie_tipo_item in ('1','12')
	and	coalesce(e.ie_cancelamento::text, '') = ''
	and	coalesce(f.nr_lote_contab_antecip::text, '') = ''
	and	coalesce(f.nr_lote_contab_antecip,0) <> nr_lote_contabil_p;

C02 CURSOR FOR
	SELECT	'D',
		'C',
		f.cd_conta_deb,
		f.cd_conta_cred_antecip,
		f.cd_conta_deb_antecip,
		coalesce(coalesce(f.vl_copartic_mens,f.vl_coparticipacao),0) vl_coparticipacao,
		0,
		0,
		coalesce(f.cd_historico,1),
		c.nr_sequencia,
		substr(obter_valor_dominio(1930,c.ie_tipo_item),1,255),
		f.nr_seq_regra_ctb_deb,
		c.ie_tipo_item,
		g.ie_tipo_segurado,
		h.ie_tipo_contratacao,
		f.nr_sequencia,
		0,
		a.ie_cancelamento,
		i.nr_lote_contab_antecip
	from	pls_lote_mensalidade i,
		pls_mensalidade a,
		pls_mensalidade_segurado b,
		pls_mensalidade_seg_item c,
		pls_conta d,
		pls_conta_coparticipacao f,
		pls_segurado g,
		pls_plano h
	where	a.nr_sequencia	= b.nr_seq_mensalidade
	and	b.nr_sequencia	= c.nr_seq_mensalidade_seg
	and	c.nr_seq_conta	= d.nr_sequencia
	and	d.nr_sequencia	= f.nr_seq_conta
	and	g.nr_sequencia	= b.nr_seq_segurado
	and	h.nr_sequencia	= g.nr_seq_plano
	and	i.nr_sequencia	= a.nr_seq_lote
	and	c.nr_lote_contabil	= nr_lote_contabil_p
	and	c.ie_tipo_item = '3'
	and	coalesce(i.nr_lote_contab_antecip::text, '') = ''
	and	coalesce(i.nr_lote_contab_antecip,0) <> nr_lote_contabil_p
	
union all

	SELECT	'C',
		'C',
		f.cd_conta_cred,
		f.cd_conta_cred_antecip,
		f.cd_conta_deb_antecip,
		coalesce(coalesce(f.vl_copartic_mens,f.vl_coparticipacao),0),
		0,
		0,
		coalesce(f.cd_historico,1),
		c.nr_sequencia,
		substr(obter_valor_dominio(1930,c.ie_tipo_item),1,255),
		f.nr_seq_regra_ctb_cred,
		c.ie_tipo_item,
		g.ie_tipo_segurado,
		h.ie_tipo_contratacao,
		f.nr_sequencia,
		0,
		a.ie_cancelamento,
		i.nr_lote_contab_antecip
	from	pls_lote_mensalidade		i,
		pls_mensalidade 		a,
		pls_mensalidade_segurado 	b,
		pls_mensalidade_seg_item	c,
		pls_conta 			d,
		pls_conta_coparticipacao f,
		pls_segurado g,
		pls_plano h
	where	a.nr_sequencia	= b.nr_seq_mensalidade
	and	b.nr_sequencia	= c.nr_seq_mensalidade_seg
	and	c.nr_seq_conta	= d.nr_sequencia
	and	d.nr_sequencia	= f.nr_seq_conta
	and	g.nr_sequencia	= b.nr_seq_segurado
	and	h.nr_sequencia	= g.nr_seq_plano
	and	i.nr_sequencia	= a.nr_seq_lote
	and	c.nr_lote_contabil	= nr_lote_contabil_p
	and	c.ie_tipo_item	= '3'
	and	coalesce(i.nr_lote_contab_antecip::text, '') = ''
	and	coalesce(i.nr_lote_contab_antecip,0) <> nr_lote_contabil_p;


BEGIN

select	dt_referencia,
	cd_estabelecimento,
	nr_lote_contabil
into STRICT 	dt_referencia_w,
	cd_estabelecimento_w,
	nr_lote_contabil_w
from 	lote_contabil
where 	nr_lote_contabil 	= nr_lote_contabil_p;

delete	from	w_pls_movimento_sem_conta
where	ie_tipo_item = 'M';

if (ie_exclusao_p = 'S') then
	begin
	delete from movimento_contabil
	where  nr_lote_contabil		= nr_lote_contabil_p;

	Update	lote_contabil
	set	vl_credito 		= 0,
		vl_debito  		= 0
	where	nr_lote_contabil	= nr_lote_contabil_p;
	
	update	pls_lote_mensalidade
	set	nr_lote_contabil	 = NULL
	where	trunc(dt_mesano_referencia,'month') = trunc(dt_referencia_w, 'month')
	and	ie_status	= 2
	and	cd_estabelecimento	= cd_estabelecimento_w;
	
	update	pls_lote_mensalidade
	set	nr_lote_contab_antecip	 = NULL
	where	trunc(dt_contabilizacao,'month') = trunc(dt_referencia_w, 'month')
	and	ie_status	= 2
	and	cd_estabelecimento	= cd_estabelecimento_w;
	
	update	pls_mensalidade_seg_item a
	set	a.nr_lote_contabil	 = NULL
	where	exists (	SELECT	1
				from	pls_mensalidade_segurado x,
					pls_mensalidade y,
					pls_lote_mensalidade z
				where	y.nr_sequencia	= x.nr_seq_mensalidade
				and	z.nr_sequencia	= y.nr_seq_lote
				and	x.nr_sequencia		= a.nr_seq_mensalidade_seg
				and	trunc(x.dt_mesano_referencia,'month')	= trunc(dt_referencia_w, 'month')
				and	z.ie_status	= 2
				and	z.cd_estabelecimento	= cd_estabelecimento_w);

	update	pls_mensalidade_seg_item a
	set	a.nr_lote_contab_antecip	 = NULL
	where	exists (	SELECT	1
				from	pls_mensalidade_seg_item w,
					pls_mensalidade_segurado x,
					pls_mensalidade y,
					pls_lote_mensalidade z
				where	x.nr_sequencia	= w.nr_seq_mensalidade_seg
				and	y.nr_sequencia	= x.nr_seq_mensalidade
				and	z.nr_sequencia	= y.nr_seq_lote
				and	w.nr_sequencia	= a.nr_sequencia
				and	trunc(w.dt_antecipacao,'month')	= trunc(dt_referencia_w, 'month')
				and	z.ie_status	= 2
				and	z.cd_estabelecimento	= cd_estabelecimento_w);
	
	end;
else
	begin
	delete	FROM w_movimento_contabil
	where	nr_lote_contabil	= nr_lote_contabil_p;

	update	pls_mensalidade_seg_item a
	set	a.nr_lote_contabil	= nr_lote_contabil_p
	where	coalesce(a.nr_lote_contabil,0)	= 0
  	and	exists (	SELECT	1
				from	pls_mensalidade_segurado x,
					pls_mensalidade y,
					pls_lote_mensalidade z
				where	y.nr_sequencia	= x.nr_seq_mensalidade
				and	z.nr_sequencia	= y.nr_seq_lote
				and	x.nr_sequencia		= a.nr_seq_mensalidade_seg
				and	trunc(x.dt_mesano_referencia,'month')	= trunc(dt_referencia_w, 'month')
				and	z.ie_status	= 2
				and	z.cd_estabelecimento	= cd_estabelecimento_w);

	update	pls_mensalidade_seg_item a
	set	a.nr_lote_contab_antecip	= nr_lote_contabil_p
	where	coalesce(a.nr_lote_contab_antecip,0)	= 0
  	and	exists (	SELECT	1
				from	pls_mensalidade_seg_item w,
					pls_mensalidade_segurado x,
					pls_mensalidade y,
					pls_lote_mensalidade z
				where	x.nr_sequencia	= w.nr_seq_mensalidade_seg
				and	y.nr_sequencia	= x.nr_seq_mensalidade
				and	z.nr_sequencia	= y.nr_seq_lote
				and	w.nr_sequencia	= a.nr_sequencia
				and	trunc(w.dt_antecipacao,'month')	= trunc(dt_referencia_w, 'month')
				and	z.ie_status	= 2
				and	z.cd_estabelecimento	= cd_estabelecimento_w);
	
	update	pls_lote_mensalidade
	set	nr_lote_contab_antecip	= nr_lote_contabil_p
	where	coalesce(nr_lote_contab_antecip,0)	= 0
	and	trunc(dt_contabilizacao,'month') = trunc(dt_referencia_w, 'month')
	and	ie_status	= 2
	and	cd_estabelecimento	= cd_estabelecimento_w;
	
	select	obter_se_compl_tipo_lote(cd_estabelecimento_w, 21)
	into STRICT	ie_compl_hist_w
	;
	
	nr_seq_w_movto_cont_w	:= 0;
	
	OPEN C02;
	LOOP
	FETCH C02 into
		ie_debito_credito_w,
		ie_tipo_valor_w,
		cd_conta_contabil_w,
		cd_conta_antecip_w,
		cd_conta_deb_antecip_w,
		vl_contabil_w,
		vl_pro_rata_dia_w,
		vl_antecipacao_w,
		cd_historico_w,
		nr_seq_item_w,
		ds_item_w,
		nr_seq_regra_w,
		ie_tipo_item_w,
		ie_tipo_segurado_w,
		ie_tipo_contratacao_w,
		nr_seq_copartic_w,
		nr_lote_contab_antecip_w,
		ie_cancelamento_w,
		nr_lote_contab_antecip_ww;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin
		cd_centro_custo_w := null;
		
		if (coalesce(nr_lote_contab_antecip_ww,0) <> 0) then
			if (nr_lote_contab_antecip_ww = nr_lote_contabil_p) then
				cd_conta_contabil_w	:= cd_conta_antecip_w;
			elsif (nr_lote_contab_antecip_ww <> nr_lote_contabil_p) then
				cd_conta_contabil_w	:= cd_conta_deb_antecip_w;
			end if;
		end if;
		
		/* Contabilizar a antecipação nos tipos pré-estabelecidos e pré-estabelecidos não subsidiados */

		if (ie_debito_credito_w	= 'C') and (ie_tipo_item_w in (1,12)) then
			vl_contabil_w	:= coalesce(vl_pro_rata_dia_w,0);
			
			if (coalesce(vl_antecipacao_w,0) <> 0) then
				select	max(ie_centro_custo)
				into STRICT	ie_centro_custo_w
				from	conta_contabil
				where	cd_conta_contabil = cd_conta_antecip_w;
				
				if (coalesce(ie_centro_custo_w,'N') = 'S') then
					SELECT * FROM pls_obter_centro_custo(	'R', null, cd_estabelecimento_w, '', '', '', '', '', cd_centro_custo_w, nr_seq_regra_cc_w) INTO STRICT cd_centro_custo_w, nr_seq_regra_cc_w;
				end if;
				
				if (ie_compl_hist_w = 'S') then
					/* Felipe 10/10/2008 - OS 111091 */

					select	max(nr_nota_fiscal)
					into STRICT	nr_nota_fiscal_w
					from	nota_fiscal
					where	nr_sequencia	= nr_seq_nota_fiscal_w;
					nr_nota_fiscal_w	:= somente_numero(nr_nota_fiscal_w);
					
					ds_conteudo_w	:= substr(nr_nota_fiscal_w	|| '#@' ||
								cd_cgc_pagador_w 	|| '#@' ||
								cd_pf_pagador_w		|| '#@' ||
								nr_titulo_w		|| '#@' ||
								nm_pagador_w,1,4000);
					
					select	obter_compl_historico(21, cd_historico_w, ds_conteudo_w)
					into STRICT	ds_compl_historico_ww
					;
					
					ds_compl_historico_w	:= substr(ds_compl_historico_ww,1,255);--substr(nvl(ds_compl_historico_ww, ds_compl_historico_w),1,255);
				end if;
				/* Felipe - Fim da alteração */

				
				nr_seq_w_movto_cont_w	:= nr_seq_w_movto_cont_w + 1;
				
				insert into w_movimento_contabil(nr_lote_contabil, nr_sequencia, cd_conta_contabil, ie_debito_credito,
					cd_historico, dt_movimento, vl_movimento, cd_estabelecimento,
					cd_centro_custo, ds_compl_historico, nr_seq_agrupamento)
				values (nr_lote_contabil_p, nr_seq_w_movto_cont_w, cd_conta_antecip_w, ie_debito_credito_w,
					cd_historico_w, dt_referencia_w, vl_antecipacao_w, cd_estabelecimento_w,
					cd_centro_custo_w, ds_compl_historico_w, nr_seq_copartic_w);
				cd_centro_custo_w	:= null;
				nr_seq_regra_cc_w	:= null;
			end if;
		end if;
			
		if (ie_cancelamento_w = 'E') then /* Segundo contato com Adriano em 26/08/2008, o estorno deve ser contabilizado ao contrário se coparticipação*/
			select	max(cd_conta_estorno),
				max(cd_historico_estorno)
			into STRICT	cd_conta_contabil_w,
				cd_historico_w
			from	pls_regra_ctb_mensal
			where	nr_sequencia	= nr_seq_regra_w;
			
			if (ie_tipo_valor_w = 'C' and ie_debito_credito_w = 'C') then
				ie_debito_credito_w := 'D';
			elsif (ie_tipo_valor_w = 'C' and ie_debito_credito_w = 'D') then
				ie_debito_credito_w := 'C';
			end if;
		end if;

		if (coalesce(cd_conta_contabil_w::text, '') = '') then
			insert into w_pls_movimento_sem_conta(	
				nr_sequencia, cd_item, ds_item,
				ie_tipo_item, dt_atualizacao, nm_usuario,
				vl_item, dt_referencia, nr_lote_contabil,
				ie_proc_mat_item, ie_deb_cred, ds_observacao)
			values (	nextval('w_pls_movimento_sem_conta_seq'), nr_seq_item_w, ds_item_w,
				'M', clock_timestamp(), nm_usuario_p,
				vl_contabil_w, dt_referencia_w, nr_lote_contabil_w,
				null, ie_debito_credito_w, CASE WHEN ie_tipo_valor_w='C' THEN 'Coparticipação'  ELSE '' END );
		else
			select	max(ie_centro_custo)
			into STRICT	ie_centro_custo_w
			from	conta_contabil
			where	cd_conta_contabil = cd_conta_contabil_w;
			
			if (coalesce(ie_centro_custo_w,'N') = 'S') then
				SELECT * FROM pls_obter_centro_custo(	'R', null, cd_estabelecimento_w, '', '', '', '', '', cd_centro_custo_w, nr_seq_regra_cc_w) INTO STRICT cd_centro_custo_w, nr_seq_regra_cc_w;
			end if;
			
			if (ie_compl_hist_w = 'S') then
				/* Felipe 10/10/2008 - OS 111091 */

				select	max(nr_nota_fiscal)
				into STRICT	nr_nota_fiscal_w
				from	nota_fiscal
				where	nr_sequencia	= nr_seq_nota_fiscal_w;
				nr_nota_fiscal_w	:= somente_numero(nr_nota_fiscal_w);
				
				ds_conteudo_w	:= substr(nr_nota_fiscal_w	|| '#@' ||
							cd_cgc_pagador_w 	|| '#@' ||
							cd_pf_pagador_w		|| '#@' ||
							nr_titulo_w		|| '#@' ||
							nm_pagador_w,1,4000);
				
				select	obter_compl_historico(21, cd_historico_w, ds_conteudo_w)
				into STRICT	ds_compl_historico_ww
				;
				ds_compl_historico_w	:= substr(ds_compl_historico_ww,1,255);
			end if;
			/* Felipe - Fim da alteração */

			
			nr_seq_w_movto_cont_w	:= nr_seq_w_movto_cont_w + 1;
			
			insert into w_movimento_contabil(nr_lote_contabil, nr_sequencia, cd_conta_contabil, ie_debito_credito, cd_historico,
				dt_movimento, vl_movimento, cd_estabelecimento, cd_centro_custo, ds_compl_historico,
				nr_seq_agrupamento)
			values (nr_lote_contabil_p, nr_seq_w_movto_cont_w, cd_conta_contabil_w, ie_debito_credito_w,
				cd_historico_w, dt_referencia_w, vl_contabil_w, cd_estabelecimento_w, cd_centro_custo_w,
				ds_compl_historico_w, nr_seq_copartic_w);
			cd_centro_custo_w	:= null;
			nr_seq_regra_cc_w	:= null;
		end if;
		end;
	end loop;
	close C02;
	CALL Agrupa_Movimento_Contabil(nr_lote_contabil_p, nm_usuario_p);
	end;
end if;

if (coalesce(ds_retorno_p::text, '') = '') then
	begin
	update	lote_contabil
	set	ie_situacao = 'A'
	where	nr_lote_contabil 	= nr_lote_contabil_p;

	if (ie_exclusao_p = 'S') then
		ds_retorno_p	:= wheb_mensagem_pck.get_texto(165188);
	else
		ds_retorno_p	:= wheb_mensagem_pck.get_texto(165187);
	end if;

	commit;
	end;
else
	rollback;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ctb_pls_contab_receita_copart ( nr_lote_contabil_p bigint, nm_usuario_p text, ie_exclusao_p text, ds_retorno_p INOUT text) FROM PUBLIC;

