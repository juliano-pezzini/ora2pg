-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_vincular_mat_unimed_a900 ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_gestao_p text, -- Nao utilizar
 nm_usuario_p usuario.nm_usuario%type) AS $body$
DECLARE


/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade: Inserir os materiais/medicamentos A900 na PLS_MATERIAL - MATERIAL
-------------------------------------------------------------------------------------------------------------------

Locais de chamada direta: 
[  ]  Objetos do dicionario [X] Tasy (Delphi/Java) [  ] Portal [  ]  Relatorios [ ] Outros:
 ------------------------------------------------------------------------------------------------------------------

Pontos de atencao: IE_GESTAO_P
-> Se 'S', faz o vinculo do material na PLS_MATERIAL e MATERIAL
-> Se 'N', faz o vinculo do material na PLS_MATERIAL apenas

NUNCA FAZER UPDATE NA PLS_MATERIAL
- SEGURANCA DAS INFORMACOES
- CONSISTENCIAS NAS REGRAS
* Gerar relatorio de inconsistencia

Utilizado em:
	- Funcao OPS - Cadastro de Materiais, pasta Materiais Unimed >> A900 >> Materiais
	- Funcao Gestao do Cadastro de Materiais, pasta A900 >> Materiais
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/ie_gestao_w			varchar(2);
ds_observacao_w			pls_material.ds_observacao%type;
ds_material_w                   varchar(500);
nm_material_w			varchar(255);
ds_mat_sem_acento_w		varchar(255);
ds_nome_comercial_w		pls_material.ds_nome_comercial%type;
ie_unidade_utilizacao_w		unidade_medida.cd_unidade_medida%type;
ie_tipo_despesa_w		pls_regra_vinc_mat_unimed.ie_tipo%type;
cd_unidade_medida_w		pls_material_unimed.cd_unidade_medida%type;
nr_seq_estrutura_w		pls_regra_vinc_mat_unimed.nr_seq_estrutura%type;
cd_material_pls_mat_w		pls_material.cd_material%type;
cd_material_w			material.cd_material%type;
nr_seq_marca_w			marca_pessoa_juridica.nr_seq_marca%type;
nr_seq_material_w		pls_material.nr_sequencia%type;
cd_classe_material_w		pls_regra_vinc_mat_unimed.cd_classe_material%type;
ie_tipo_tabela_w		pls_regra_vinc_mat_unimed.ie_tipo_tabela%type;
ie_altera_valor_w		varchar(10);
cd_unidade_medida_mat_w		pls_material.cd_unidade_medida%type;
dt_exclusao_mat_w		timestamp;
dt_limite_utilizacao_mat_w	timestamp;
ds_material_mat_w		pls_material.ds_material%type;
ds_nome_comercial_mat_w		pls_material.ds_nome_comercial%type;
qt_commit_w			integer	:= 0;
ie_possui_mat_w			integer	:= 0;
qt_material_base_w		integer	:= 0;
qt_registros_w			integer	:= 0;
ie_atualizar_fim_vig_a900_w	pls_parametros.ie_atualizar_fim_vig_a900%type;
dt_exclusao_mat_unimed_w	timestamp;
dt_inclusao_mat_unimed_w	pls_material_unimed.dt_atualizacao_nrec%type;
ie_atualizar_mat_ops_tiss_w	pls_parametros.ie_atualizar_mat_ops_tiss%type;

C01 CURSOR FOR
	SELECT	nr_sequencia nr_sequencia_a900,
		to_char(cd_material) cd_material_a900,
		CASE WHEN ie_tipo='902' THEN 'MAT'  ELSE 'MED' END  ie_mat_med,
		cd_unidade_medida,
		substr(ds_material,1,255) ds_material,
		dt_atualizacao_nrec dt_inclusao,
		CASE WHEN ie_origem='2' THEN 'I'  ELSE 'N' END  ie_origem,
		nm_material,
		dt_vinculo,
		coalesce(ds_grupo_farmacologico,'X') ds_grupo_farmacologico,
		coalesce(ds_classe_farmacologico,'X') ds_classe_farmacologico,
		ds_principio_ativo,
		nr_registro_anvisa,
		dt_validade_anvisa,
		cd_cnpj cd_cgc,
		substr(ds_especialidade,1,255) ds_especialidade,
		substr(ds_classe,1,255) ds_classe,
		cd_material_tuss,
		ie_situacao,
		ds_versao_tiss,
		dt_fim_vigencia,
		dt_inicio_vigencia,
		cd_ref_material_fab,
		ie_codificacao
	from	pls_material_unimed
	where	ie_inconsistente	= 'N';
		
C02 CURSOR(ie_mat_med_pc			pls_regra_vinc_mat_unimed.ie_mat_med%type,
		ds_grupo_farmacologico_pc	pls_regra_vinc_mat_unimed.ds_grupo_farmacologico%type,
		ds_classe_farmacologico_pc	pls_regra_vinc_mat_unimed.ds_classe_farmacologico%type,
		ds_especialidade_pc		pls_regra_vinc_mat_unimed.ds_especialidade%type,
		ds_classe_pc			pls_regra_vinc_mat_unimed.ds_classe%type,
		ie_gestao_pc			text )  FOR
	-- OPS - Cadastro de Materiais
	SELECT	nr_seq_estrutura,
		ie_tipo,
		cd_classe_material,
		ie_tipo_tabela,
		ds_grupo_farmacologico,
		ds_classe_farmacologico,
		ds_especialidade,
		ds_classe
	from	pls_regra_vinc_mat_unimed
	where (ie_mat_med = ie_mat_med_pc or ie_mat_med = 'A')
	and	coalesce(ds_grupo_farmacologico, ds_grupo_farmacologico_pc)		= ds_grupo_farmacologico_pc
	and	coalesce(ds_classe_farmacologico, ds_classe_farmacologico_pc)	= ds_classe_farmacologico_pc
	and (coalesce(ds_especialidade, ds_especialidade_pc)			= ds_especialidade_pc 	or coalesce(ds_especialidade_pc::text, '') = '')
	and (coalesce(ds_classe, ds_classe_pc)					= ds_classe_pc 		or coalesce(ds_classe_pc::text, '') = '')
	and	ie_gestao_pc = 'N'
	
union all

	-- Gestao do Cadastro de Materiais
	SELECT	nr_seq_estrutura,
		ie_tipo,
		cd_classe_material,
		ie_tipo_tabela,
		ds_grupo_farmacologico,
		ds_classe_farmacologico,
		ds_especialidade,
		ds_classe
	from	pls_regra_vinc_mat_unimed
	where (ie_mat_med = ie_mat_med_pc or ie_mat_med = 'A')
	and	coalesce(ds_grupo_farmacologico::text, '') = ''
	and	coalesce(ds_classe_farmacologico::text, '') = ''
	and	coalesce(ds_especialidade::text, '') = ''
	and	coalesce(ds_classe::text, '') = ''
	and	ie_gestao_pc = 'S'
	order by ds_grupo_farmacologico,
		ds_classe_farmacologico,
		ds_especialidade,
		ds_classe;
BEGIN
select	count(1)
into STRICT	qt_registros_w
from	pls_regra_conv_mat_unimed;

select	coalesce(max(ie_atualizar_fim_vig_a900),'N'),
	coalesce(max(ie_atualizar_mat_ops_tiss),'N'),
	coalesce(max(ie_vinc_mat_prest_a900),'N')
into STRICT	ie_atualizar_fim_vig_a900_w,
	ie_atualizar_mat_ops_tiss_w,
	ie_gestao_w
from	pls_parametros
where	cd_estabelecimento = cd_estabelecimento_p;

for r_C01_w in C01 loop
	begin
	nr_seq_material_w		:= null;
	cd_unidade_medida_w		:= trim(both upper(r_C01_w.cd_unidade_medida));
	ds_material_w			:= padronizar_nome(r_C01_w.ds_material);
	nm_material_w			:= r_C01_w.nm_material;
	dt_exclusao_mat_unimed_w	:= r_C01_w.dt_fim_vigencia;
	dt_inclusao_mat_unimed_w	:= coalesce(r_C01_w.dt_inicio_vigencia,trunc(clock_timestamp()));
	
	if (ie_atualizar_fim_vig_a900_w = 'N') then
		dt_exclusao_mat_unimed_w 	:= null;
	end if;
	
	-- Tratamento de unidade de medida	
	select	max(cd_unidade_medida)
	into STRICT	ie_unidade_utilizacao_w
	from	unidade_medida
	where	ie_situacao		= 'A'
	and	upper(cd_sistema_ant)	= cd_unidade_medida_w;
	
	if (coalesce(ie_unidade_utilizacao_w::text, '') = '') then
		select	max(cd_unidade_medida)
		into STRICT	ie_unidade_utilizacao_w
		from	unidade_medida
		where	ie_situacao			= 'A'
		and	upper(cd_unidade_medida)	= cd_unidade_medida_w;
		
		if (coalesce(ie_unidade_utilizacao_w::text, '') = '') then
			select	max(cd_unidade_medida)
			into STRICT	ie_unidade_utilizacao_w
			from	unidade_medida
			where	ie_situacao		= 'A'
			and	upper(cd_unidade_ptu)	= cd_unidade_medida_w;
		end if;
	end if;

	if (coalesce(ie_unidade_utilizacao_w::text, '') = '') then
		CALL wheb_mensagem_pck.exibir_mensagem_abort(1073066,'CD_UNIDADE=' || cd_unidade_medida_w ||
								';NR_SEQUENCIA=' || r_C01_w.nr_sequencia_a900 ||
								';DS_MATERIAL=' || ds_material_w);
	end if;

	if (r_C01_w.ie_mat_med = 'MAT') then
		ds_nome_comercial_w	:= nm_material_w;
		ds_observacao_w		:= ds_material_w;
		ds_material_w		:= coalesce(nm_material_w, ds_material_w);

		ds_mat_sem_acento_w := padronizar_nome(nm_material_w);
	elsif (r_C01_w.ie_mat_med = 'MED') then
		ds_nome_comercial_w	:= nm_material_w;
		ds_observacao_w		:= ds_material_w;
		
		if upper(trim(both padronizar_nome(r_C01_w.ds_principio_ativo))) <> 'NAO SE APLICA' then
			ds_material_w		:= r_C01_w.ds_principio_ativo;		
			ds_mat_sem_acento_w	:= padronizar_nome(ds_material_w);
		end if;
		
	end if;

	 nr_seq_material_w := pls_obter_mat_tiss_vigente( nr_seq_material_w, clock_timestamp(), r_C01_w.cd_material_a900, 'A', 'N', r_C01_w.ds_versao_tiss);
	
	if (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') and (ie_atualizar_fim_vig_a900_w = 'E') then
		-- Sao Jose do Rio preto
		update 	pls_material_a900 a
		set 	a.dt_fim_vigencia  = dt_exclusao_mat_unimed_w
		where  	a.nr_seq_material  = nr_seq_material_w
		and 	coalesce(a.dt_fim_vigencia::text, '') = ''
		and exists (  	SELECT  1
				from  	pls_material_unimed  	u
				where  	u.nr_sequencia     	= a.nr_seq_material_unimed
				and  	( (ie_situacao    	= 'I')
				or (ie_situacao = 'A' and trunc(dt_exclusao_mat_unimed_w) >= trunc(clock_timestamp()))));

		update	pls_material	a
		set	a.dt_exclusao	= dt_exclusao_mat_unimed_w
		where	a.nr_sequencia	= nr_seq_material_w
		and 	coalesce(a.dt_exclusao::text, '') = ''
		and exists (	SELECT	1
				from	pls_material_unimed	u
				where	u.nr_sequencia 		= a.nr_seq_material_unimed
				and  ( (ie_situacao    		= 'I')
				or (ie_situacao = 'A' and trunc(dt_exclusao_mat_unimed_w) >= trunc(clock_timestamp()))));
				
	end if;
	
	/*aaschlote 15/04/2014 - OS 663219*/

	if (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') and (qt_registros_w > 0) then
		select	cd_unidade_medida,
			dt_exclusao,
			dt_limite_utilizacao,
			ds_material,
			ds_nome_comercial
		into STRICT	cd_unidade_medida_mat_w,
			dt_exclusao_mat_w,
			dt_limite_utilizacao_mat_w,
			ds_material_mat_w,
			ds_nome_comercial_mat_w
		from	pls_material
		where	nr_sequencia	= nr_seq_material_w;
	
		ie_altera_valor_w := pls_obter_se_conv_mat_unimed('CD_UNIDADE_MEDIDA', clock_timestamp(), cd_unidade_medida_mat_w, ie_unidade_utilizacao_w, ie_altera_valor_w);
		if (ie_altera_valor_w = 'S') then
			update	pls_material
			set	cd_unidade_medida	= ie_unidade_utilizacao_w
			where	nr_sequencia		= nr_seq_material_w;
		end if;
		
		/*aaschlote 29/04/2014 - OS 712467*/

		ie_altera_valor_w := pls_obter_se_conv_mat_unimed('DT_EXCLUSAO', clock_timestamp(), to_char(clock_timestamp()), null, ie_altera_valor_w);
		if (ie_altera_valor_w = 'S') then
			if (r_C01_w.ie_situacao = 'I') and (coalesce(dt_exclusao_mat_w::text, '') = '') then
				update	pls_material
				set	dt_exclusao	= clock_timestamp()
				where	nr_sequencia	= nr_seq_material_w;
				
			elsif (r_C01_w.ie_situacao = 'A') and (dt_exclusao_mat_w IS NOT NULL AND dt_exclusao_mat_w::text <> '') then
				update	pls_material
				set	dt_exclusao	 = NULL
				where	nr_sequencia	= nr_seq_material_w;
			end if;
		end if;
		
		ie_altera_valor_w := pls_obter_se_conv_mat_unimed('DT_LIMITE_UTILIZACAO', clock_timestamp(), to_char(clock_timestamp()), null, ie_altera_valor_w);
		if (ie_altera_valor_w = 'S') then
			if (r_C01_w.ie_situacao = 'I') and (coalesce(dt_limite_utilizacao_mat_w::text, '') = '') then
				update	pls_material
				set	dt_limite_utilizacao	= clock_timestamp()
				where	nr_sequencia		= nr_seq_material_w;
				
			elsif (r_C01_w.ie_situacao = 'A') and (dt_limite_utilizacao_mat_w IS NOT NULL AND dt_limite_utilizacao_mat_w::text <> '') then
				update	pls_material
				set	dt_limite_utilizacao	 = NULL
				where	nr_sequencia		= nr_seq_material_w;
			end if;
		end if;
		
		/*aaschlote 09/05/2014 - OS 693440*/

		ie_altera_valor_w := pls_obter_se_conv_mat_unimed('DS_MATERIAL', clock_timestamp(), ds_material_mat_w, nm_material_w, ie_altera_valor_w);
		if (ie_altera_valor_w = 'S') then
			update	pls_material
			set	ds_material	= nm_material_w
			where	nr_sequencia	= nr_seq_material_w;
		end if;
		
		ie_altera_valor_w := pls_obter_se_conv_mat_unimed('DS_NOME_COMERCIAL', clock_timestamp(), ds_nome_comercial_mat_w, nm_material_w, ie_altera_valor_w);		
		if (ie_altera_valor_w = 'S') then
			update	pls_material
			set	ds_nome_comercial	= nm_material_w
			where	nr_sequencia		= nr_seq_material_w;
		end if;
	end if;
	
	if (coalesce(r_C01_w.dt_vinculo::text, '') = '') then
		for r_C02_w in C02( r_C01_w.ie_mat_med, r_C01_w.ds_grupo_farmacologico, r_C01_w.ds_classe_farmacologico, r_C01_w.ds_especialidade, r_C01_w.ds_classe, ie_gestao_w) loop
			begin	
			nr_seq_estrutura_w	:= r_C02_w.nr_seq_estrutura;
			ie_tipo_despesa_w	:= r_C02_w.ie_tipo;
			cd_classe_material_w	:= r_C02_w.cd_classe_material;
			ie_tipo_tabela_w	:= r_C02_w.ie_tipo_tabela;
			nr_seq_material_w	:= null;
			
			SELECT * FROM pls_obter_mat_a900_vigente( nr_seq_material_w, clock_timestamp(), r_C01_w.cd_material_a900, r_C01_w.ds_versao_tiss) INTO STRICT  nr_seq_material_w, r_C01_w.cd_material_a900;

			--Edson    OS ( 606612 )
			if (r_C01_w.ds_versao_tiss IS NOT NULL AND r_C01_w.ds_versao_tiss::text <> '') then
				select	count(1)
				into STRICT	qt_material_base_w
				from	pls_material
				where	cd_material_ops		= r_C01_w.cd_material_a900
				and (ds_versao_tiss		= r_C01_w.ds_versao_tiss or coalesce(ds_versao_tiss::text, '') = '')
				and	coalesce(ie_sistema_ant,'N')	= 'N'
				and	coalesce(dt_exclusao::text, '') = '';
			else
				select	count(1) 		
				into STRICT	qt_material_base_w
				from	pls_material
				where	cd_material_ops		= r_C01_w.cd_material_a900
				and	coalesce(ie_sistema_ant,'N')	= 'N'
				and	coalesce(dt_exclusao::text, '') = '';
				
				-- O codigo mudou de TNUMM e pra TUSS
				if (coalesce(nr_seq_material_w::text, '') = '') and (coalesce(r_C01_w.dt_fim_vigencia::text, '') = '') and (qt_material_base_w > 0) and (ie_gestao_w = 'N') and (r_C01_w.ie_codificacao = 2) then
					select	count(1) 		
					into STRICT	qt_material_base_w
					from	pls_material	p,
						pls_material_unimed u
					where	u.nr_sequencia			= p.nr_seq_material_unimed
					and	p.cd_material_ops		= r_C01_w.cd_material_a900
					and	ie_codificacao			= r_C01_w.ie_codificacao
					and	coalesce(p.ie_sistema_ant,'N')	= 'N'
					and	coalesce(p.dt_exclusao::text, '') = '';
				end if;
			end if;

			if (ie_atualizar_mat_ops_tiss_w = 'S') then				
				if (coalesce(nr_seq_material_w::text, '') = '') then
					select	max(nr_sequencia)
					into STRICT	nr_seq_material_w
					from	pls_material
					where	cd_material_ops		= r_C01_w.cd_material_a900
					and	coalesce(ie_sistema_ant,'N')	= 'N'
					and	coalesce(dt_exclusao::text, '') = '';
				end if;
			end if;

			if (qt_material_base_w > 0) and (ie_gestao_w = 'N') then
				update	pls_material_unimed
				set	ie_mat_pls_duplicado	= 'S',
					dt_vinculo		= coalesce(dt_vinculo, clock_timestamp())
				where	nr_sequencia 		= r_C01_w.nr_sequencia_a900;
				
			elsif (coalesce(nr_seq_material_w::text, '') = '') then
				select	max(nr_seq_marca)
				into STRICT	nr_seq_marca_w
				from	marca_pessoa_juridica
				where	cd_cgc = r_C01_w.cd_cgc;
				
				if (dt_exclusao_mat_unimed_w IS NOT NULL AND dt_exclusao_mat_unimed_w::text <> '') and (trunc(dt_exclusao_mat_unimed_w) < trunc(dt_inclusao_mat_unimed_w)) then
					dt_inclusao_mat_unimed_w := trunc(r_C01_w.dt_inicio_vigencia); -- Inicio de vigencia conforme o arquivo A900
				end if;

				insert into pls_material(nr_sequencia,			dt_atualizacao,			nm_usuario,
					dt_atualizacao_nrec,		nm_usuario_nrec,		ie_tipo_despesa,
					cd_estabelecimento,		nr_seq_estrut_mat,		cd_unidade_medida,
					ds_material,			ds_material_sem_acento,		ie_situacao,
					cd_material_ops,		cd_material_a900,		ie_origem,
					dt_inclusao,			nr_seq_material_unimed,		ie_revisar,
					ds_nome_comercial,		ds_observacao,			nr_registro_anvisa,
					dt_validade,			nr_seq_marca,			cd_material_tuss_a900,
					ds_versao_tiss,			ie_tipo_tabela,			dt_exclusao)
				values (nextval('pls_material_seq'),	clock_timestamp(),			nm_usuario_p,
					clock_timestamp(),			nm_usuario_p,			ie_tipo_despesa_w,
					cd_estabelecimento_p,		nr_seq_estrutura_w,		ie_unidade_utilizacao_w,		
					coalesce(ds_material_w,nm_material_w),ds_mat_sem_acento_w,		'A',
					r_C01_w.cd_material_a900,	r_C01_w.cd_material_a900,	r_C01_w.ie_origem,
					dt_inclusao_mat_unimed_w,	r_C01_w.nr_sequencia_a900,	'R',
					ds_nome_comercial_w,		ds_observacao_w,		r_C01_w.nr_registro_anvisa,
					r_C01_w.dt_validade_anvisa,	nr_seq_marca_w,			r_C01_w.cd_material_tuss,
					r_C01_w.ds_versao_tiss,		ie_tipo_tabela_w,		dt_exclusao_mat_unimed_w);

				qt_commit_w	:= qt_commit_w + 1;
				
				if (qt_commit_w = 3000) then
					commit;
					qt_commit_w	:= 0;
				end if;
				
			elsif (nr_seq_material_w IS NOT NULL AND nr_seq_material_w::text <> '') and (r_C01_w.ds_versao_tiss IS NOT NULL AND r_C01_w.ds_versao_tiss::text <> '') and (ie_atualizar_mat_ops_tiss_w = 'S') then
				-- Versao TISS do material
				insert into pls_material_tiss(nr_sequencia,			dt_atualizacao,		nm_usuario,
					dt_atualizacao_nrec,		nm_usuario_nrec,	nr_seq_material,
					dt_inicio_vigencia,		dt_fim_vigencia,	ds_versao_tiss)
				values (	nextval('pls_material_tiss_seq'),	clock_timestamp(),		nm_usuario_p,
					clock_timestamp(),			nm_usuario_p,		nr_seq_material_w,
					clock_timestamp(),			null,			r_C01_w.ds_versao_tiss);
				
				-- Atualizar o material
				update	pls_material
				set	ie_tipo_despesa		= ie_tipo_despesa_w,
					nr_seq_estrut_mat	= nr_seq_estrutura_w,
					cd_unidade_medida	= ie_unidade_utilizacao_w,
					ds_material		= coalesce(ds_material_w,nm_material_w),
					ds_material_sem_acento	= ds_mat_sem_acento_w,
					ie_origem		= r_C01_w.ie_origem,
					ie_revisar		= 'R',
					ds_nome_comercial	= ds_nome_comercial_w,
					ds_observacao		= ds_observacao_w,
					nr_registro_anvisa	= r_C01_w.nr_registro_anvisa,
					dt_validade		= r_C01_w.dt_validade_anvisa,
					nr_seq_marca		= nr_seq_marca_w,
					cd_material_tuss_a900	= r_C01_w.cd_material_tuss,
					ie_tipo_tabela		= ie_tipo_tabela_w,
					dt_exclusao		= dt_exclusao_mat_unimed_w,
					dt_atualizacao		= clock_timestamp(),
					nm_usuario		= nm_usuario_p
				where	nr_sequencia		= nr_seq_material_w;
				
			else
				if (coalesce(r_C01_w.dt_vinculo::text, '') = '') then
					update	pls_material_unimed
					set	dt_vinculo	= clock_timestamp()
					where	nr_sequencia	= r_C01_w.nr_sequencia_a900;
				end if;
				
				exit;
			end if;
			
			if	(qt_material_base_w = 0 AND ie_gestao_w = 'N') or (ie_gestao_w = 'S') then
				update	pls_material_unimed
				set	dt_vinculo	= clock_timestamp()
				where	nr_sequencia	= r_C01_w.nr_sequencia_a900;
			end if;
			end;
		end loop;
	end if;
	
	-- Gestao do Cadastro de Materiais
	if (ie_gestao_w = 'S') then
		for r_C02_w in C02( r_C01_w.ie_mat_med, r_C01_w.ds_grupo_farmacologico, r_C01_w.ds_classe_farmacologico, r_C01_w.ds_especialidade, r_C01_w.ds_classe, ie_gestao_w) loop
			begin	
			nr_seq_estrutura_w	:= r_C02_w.nr_seq_estrutura;
			ie_tipo_despesa_w	:= r_C02_w.ie_tipo;
			cd_classe_material_w	:= r_C02_w.cd_classe_material;
			ie_tipo_tabela_w	:= r_C02_w.ie_tipo_tabela;

			--Pegar o codigo do material da PLS_MATERIAL
			select	max(cd_material),
				coalesce(max(nr_sequencia),nr_seq_material_w)
			into STRICT	cd_material_pls_mat_w,
				nr_seq_material_w
			from	pls_material
			where	nr_sequencia	= (	SELECT	max(nr_sequencia)
							from	pls_material
							where	nr_seq_material_unimed	= r_C01_w.nr_sequencia_a900);
		
			--Verifica se existe o material na tabela MATERIAL
			select  count(1)
			into STRICT    ie_possui_mat_w	
			from    material
			where   cd_material	= cd_material_pls_mat_w  LIMIT 1;
			
			if (ie_possui_mat_w = 0) then
				select	nextval('material_seq')
				into STRICT	cd_material_w
				;
			
				insert into material(cd_material,					dt_atualizacao,					nm_usuario,
					dt_atualizacao_nrec,				nm_usuario_nrec,				ds_material,
					ie_situacao,					dt_cadastramento,				ie_tipo_material,				
					cd_classe_material,				cd_material_estoque,				cd_unidade_medida_compra,
					cd_unidade_medida_estoque,			cd_unidade_medida_consumo,			ds_reduzida,
					ie_abrigo_luz,					ie_baixa_estoq_pac,				ie_baixa_inteira,
					ie_bomba_infusao,				ie_cobra_paciente,				ie_controle_medico,
					ie_diluicao,					ie_gravar_obs_prescr,				ie_inf_ultima_compra,
					ie_material_estoque,				ie_mistura,					ie_receita,
					ie_solucao,					ie_umidade_controlada,				qt_conv_compra_estoque,
					qt_conv_estoque_consumo,			qt_minimo_multiplo_solic,			cd_fabricante,
					nr_registro_anvisa,				dt_validade_reg_anvisa)
				values (cd_material_w,					clock_timestamp(),					nm_usuario_p,
					clock_timestamp(),					nm_usuario_p,					coalesce(nm_material_w,ds_material_w),
					'A',						coalesce(r_C01_w.dt_inclusao,trunc(clock_timestamp(),'dd')),	CASE WHEN ie_tipo_despesa_w=1 THEN 4 WHEN ie_tipo_despesa_w=2 THEN 6 WHEN ie_tipo_despesa_w=3 THEN 1 WHEN ie_tipo_despesa_w=4 THEN 4 WHEN ie_tipo_despesa_w=5 THEN 4 WHEN ie_tipo_despesa_w=6 THEN 4 WHEN ie_tipo_despesa_w=7 THEN 1 END ,
					cd_classe_material_w,				cd_material_w,					ie_unidade_utilizacao_w,
					ie_unidade_utilizacao_w,			ie_unidade_utilizacao_w,			coalesce(nm_material_w,ds_material_w),
					'N',						'N',						'N',
					'N',						'N',						0,
					'N',						'N',						'N',
					'N',						'N',						'N',
					'N',						'N',						0,
					0,						0,						r_C01_w.cd_ref_material_fab,
					r_c01_w.nr_registro_anvisa,			r_c01_w.dt_validade_anvisa);
				
				update	pls_material_unimed
				set	dt_vinculo	= clock_timestamp()
				where	nr_sequencia	= r_C01_w.nr_sequencia_a900;
				
				insert into material_tipo_local_est(nr_sequencia,					dt_atualizacao,					nm_usuario,
					dt_atualizacao_nrec,				nm_usuario_nrec,				cd_material,
					ie_prestador,					ie_operadora,					ie_farmacia,
					ie_distribuidora)
				values (nextval('material_tipo_local_est_seq'),		clock_timestamp(),					nm_usuario_p,
					clock_timestamp(),					nm_usuario_p,					cd_material_w,
					'N',						'S',						'N',
					'N');
					
				update 	material_tipo_local_est
				set	ie_operadora 	= 'S'
				where	cd_material 	= cd_material_w;
				
				update	material_estab
				set	ie_revisar	= 'R'
				where	cd_material	= cd_material_w;
				
				qt_commit_w	:= qt_commit_w + 1;
				
				if (qt_commit_w = 3000) then
					commit;
					qt_commit_w	:= 0;
				end if;

				-- Regra Gestao do Cadastro de Materiais, aba Materiais / Operadora / Restricoes / Restricoes

				-- Regra OPS - Cadastro de Materiais, aba Materiais / Cadastro / Restricoes / Restricoes
				insert into pls_material_restricao(nr_sequencia,				dt_atualizacao,			nm_usuario,
					dt_atualizacao_nrec,			nm_usuario_nrec,		dt_inicio_vigencia,
					dt_fim_vigencia,			nr_seq_material,		qt_minima,
					qt_maxima,				ie_bloqueia_prod_reg,		ie_bloqueia_prod_nao_reg,
					ie_bloqueia_custo_op,			ie_bloqueia_pre_pag,		ie_bloqueia_intercambio,
					ie_taxa_comercial,			ie_nota_fiscal,			ie_autorizacao,
					ie_sexo_exclusivo,			qt_idade_minima,		qt_idade_maxima,
					ie_bloqueia_autor,			dt_inicio_vigencia_ref,		dt_fim_vigencia_ref)
				values (nextval('pls_material_restricao_seq'),	clock_timestamp(),			nm_usuario_p,
					clock_timestamp(),				nm_usuario_p,			to_date('01/01/2000'),
					null,					nr_seq_material_w,		null,
					null,					'N',				'N',
					'N',					'N',				'N',
					'N',					'N',				'N',
					null,					null,				null,
					'S',					null,				null);
			else
			
				update 	material_tipo_local_est
				set	ie_operadora 	= 'S'
				where	cd_material 	= cd_material_pls_mat_w;
			
				if ( coalesce(r_C01_w.dt_vinculo::text, '') = '' ) then
					update	pls_material
					set	cd_material		= cd_material_w
					where	nr_seq_material_unimed	= r_C01_w.nr_sequencia_a900;
				end if;
				
				exit;
			end if;

			update	pls_material
			set	cd_material		= cd_material_w
			where	nr_seq_material_unimed	= r_C01_w.nr_sequencia_a900;
			end;
		end loop;
	end if;
	end;
end loop;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_vincular_mat_unimed_a900 ( cd_estabelecimento_p estabelecimento.cd_estabelecimento%type, ie_gestao_p text, nm_usuario_p usuario.nm_usuario%type) FROM PUBLIC;

