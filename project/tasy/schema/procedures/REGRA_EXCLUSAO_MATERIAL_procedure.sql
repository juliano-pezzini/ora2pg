-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE regra_exclusao_material ( cd_material_p bigint, nr_interno_conta_p bigint, nm_usuario_p text, ds_erro_p INOUT text, vl_material_p bigint, vl_unitario_p bigint) AS $body$
DECLARE

 
					 
		 
qt_regra_w		bigint;
ds_erro_w		varchar(255) := '';
qt_existe_regra_w	varchar(1);
cd_grupo_material_w	smallint;
cd_subgrupo_material_w	smallint;
cd_classe_material_w	integer;
ie_tipo_atendimento_w	smallint;
cd_convenio_w		integer;
				
		 

BEGIN 
 
select	coalesce(max('S'),'N') 
into STRICT	qt_existe_regra_w 
from	regra_exclusao_audit_mat;
 
if (qt_existe_regra_w = 'S') then 
 
	select	coalesce(cd_grupo_material,0), 
			coalesce(cd_subgrupo_material,0), 
			coalesce(cd_classe_material,0) 
	into STRICT	cd_grupo_material_w, 
			cd_subgrupo_material_w, 
			cd_classe_material_w 
	from	estrutura_material_v 
	where	cd_material = cd_material_p;
	 
	select	coalesce(max(substr(obter_tipo_atendimento(nr_atendimento),1,5)),0), 
			coalesce(max(cd_convenio_parametro),0) 
	into STRICT	ie_tipo_atendimento_w, 
			cd_convenio_w 
	from	conta_paciente 
	where	nr_interno_conta = nr_interno_conta_p;
  
	select	count(*) 
	into STRICT	qt_regra_w 
	from	regra_exclusao_audit_mat 
	where	ie_situacao = 'A' 
	and		coalesce(cd_convenio, coalesce(cd_convenio_w,0)) = coalesce(cd_convenio_w,0) 
	and		((coalesce(cd_grupo_material::text, '') = '') or (coalesce(cd_grupo_material,0) = coalesce(cd_grupo_material_w,0))) 
	and		((coalesce(ie_tipo_atendimento::text, '') = '') or (coalesce(ie_tipo_atendimento,ie_tipo_atendimento_w) = coalesce(ie_tipo_atendimento_w,0))) 
	and		((coalesce(cd_subgrupo_material::text, '') = '') or (coalesce(cd_subgrupo_material,0) = coalesce(cd_subgrupo_material_w,0))) 
	and		((coalesce(cd_classe_material::text, '') = '') or (coalesce(cd_classe_material,0) = coalesce(cd_classe_material_w,0))) 
	and		((coalesce(cd_material::text, '') = '') or (coalesce(cd_material,0) = coalesce(cd_material_p,0))) 
	and		(((ie_tipo_valor = 'U') and ((vl_unitario_p = - 1) or (coalesce(vl_unitario_p,0) between coalesce(vl_minimo,coalesce(vl_unitario_p,0)) and coalesce(vl_maximo,coalesce(vl_unitario_p,0))))) 
	   or (((vl_material_p = - 1) or (coalesce(vl_material_p,0) between coalesce(vl_minimo,coalesce(vl_material_p,0)) and coalesce(vl_maximo,coalesce(vl_material_p,0))))));
	 
	if (qt_regra_w = 0) then 
		ds_erro_w	:= WHEB_MENSAGEM_PCK.get_texto(277653);
  end if;
end if;	
 
ds_erro_p := ds_erro_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE regra_exclusao_material ( cd_material_p bigint, nr_interno_conta_p bigint, nm_usuario_p text, ds_erro_p INOUT text, vl_material_p bigint, vl_unitario_p bigint) FROM PUBLIC;

