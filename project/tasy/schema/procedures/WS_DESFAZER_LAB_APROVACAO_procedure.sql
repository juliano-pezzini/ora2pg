-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ws_desfazer_lab_aprovacao ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text, ds_erro_p INOUT text) AS $body$
DECLARE


nr_seq_resultado_w		bigint;
cd_medico_resp_w		varchar(10);
cd_pessoa_usuario_w	varchar(10);
nr_seq_result_item_w	bigint;
nr_seq_reult_w		bigint;

nr_sequencia_result_w	bigint;
nr_prescricao_result_w	bigint;
nr_seq_prescricao_result_w	integer;
nm_usuario_result_w	varchar(15);
dt_atualizacao_result_w	timestamp;
ie_cobranca_result_w	varchar(15);
ie_origem_proced_result_w	bigint;
cd_procedimento_result_w	bigint;
ds_resultado_result_w	text;
dt_coleta_result_w		timestamp;
ie_status_conversao_result_w	smallint;
ds_result_codigo_result_w	varchar(2000);
ie_formato_texto_result_w	smallint;
nr_seq_exame_result_w	bigint;
nr_seq_pagina_result_w	bigint;
ds_erro_w		varchar(255) := null;
ie_existe_prescr_w	bigint;
ie_gerar_result_prescr_w varchar(1);
ie_status_update_w		smallint;
dt_aprovacao_w					exame_lab_result_item.dt_aprovacao%type;
nr_sequencia_copia_w            bigint;
ie_atual_dt_emiss_desaprov_w	lab_parametro.ie_atual_dt_emiss_desaprov%type;
nr_seq_result_antib_w			exame_lab_result_antib.nr_sequencia%type;

C01 CURSOR FOR
SELECT 	nr_sequencia
FROM 	exame_lab_result_item
WHERE 	nr_seq_resultado	= nr_seq_resultado_w
AND 	nr_seq_prescr	= nr_seq_prescr_p;

c02 CURSOR FOR
 	SELECT	NR_SEQUENCIA,
		NR_PRESCRICAO,
		NR_SEQ_PRESCRICAO,
		NM_USUARIO,
		DT_ATUALIZACAO,
		IE_COBRANCA,
		IE_ORIGEM_PROCED,
		CD_PROCEDIMENTO,
		--DS_RESULTADO,
		DT_COLETA,
		IE_STATUS_CONVERSAO,
		DS_RESULT_CODIGO,
		IE_FORMATO_TEXTO,
		NR_SEQ_EXAME,
		NR_SEQ_PAGINA
 	FROM	result_laboratorio
 	WHERE	nr_prescricao = nr_prescricao_p
	AND	nr_seq_prescricao = nr_seq_prescr_p;

c03 CURSOR FOR
	SELECT	nr_sequencia,
		nr_seq_resultado,
		nr_seq_result_item,
		cd_microorganismo,
		cd_medicamento,
		ie_resultado,
		dt_atualizacao,
		nm_usuario,
		qt_microorganismo,
		ds_obs_microorganismo,
		qt_mic,
		ie_micro_sem_antib,
		ds_resultado_antib,
		ie_primeira_escolha,
		ds_obs_antibiotico,
		nr_cultura_microorg
	from	exame_lab_result_antib
	where	nr_seq_resultado = nr_seq_resultado_w
	  and	nr_seq_result_item = nr_seq_result_item_w;

c04 CURSOR FOR
	SELECT	nr_sequencia,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nr_seq_exame_lab_result_antib,
		cd_medicamento
	from	exame_lab_result_antib_adi
	where	nr_seq_exame_lab_result_antib = nr_seq_result_antib_w;

c03_w	c03%rowtype;
c04_w 	c04%rowtype;


BEGIN

begin

	SELECT	coalesce(MAX(nr_seq_resultado),0)
	INTO STRICT	nr_seq_resultado_w
	FROM	exame_lab_resultado
	WHERE	nr_prescricao = nr_prescricao_p;

	select	count(*)
	into STRICT	ie_existe_prescr_w
	from	prescr_procedimento
	where	nr_prescricao = nr_prescricao_p
	and	nr_sequencia = nr_seq_prescr_p;

	select  coalesce(MAX(a.ie_gerar_result_prescr),'N'),
		coalesce(max(ie_atual_dt_emiss_desaprov), 'N')
	into STRICT	ie_gerar_result_prescr_w,
		ie_atual_dt_emiss_desaprov_w
	from	lab_parametro a,
			prescr_medica b
	where 	a.cd_estabelecimento = b.cd_estabelecimento
	and		b.nr_prescricao = nr_prescricao_p;

	if (ie_existe_prescr_w = 0) then
		--'Não foi localizada a prescrição/item informado.');
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(264089);
	else

		OPEN C02;
		LOOP
		FETCH C02 INTO
			nr_sequencia_result_w,
			nr_prescricao_result_w,
			nr_seq_prescricao_result_w,
			nm_usuario_result_w,
			dt_atualizacao_result_w,
			ie_cobranca_result_w,
			ie_origem_proced_result_w,
			cd_procedimento_result_w,
			--ds_resultado_result_w,
			dt_coleta_result_w,
			ie_status_conversao_result_w,
			ds_result_codigo_result_w,
			ie_formato_texto_result_w,
			nr_seq_exame_result_w,
			nr_seq_pagina_result_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */
			BEGIN

			select	max(dt_aprovacao)
			into STRICT	dt_aprovacao_w
			from	exame_lab_result_item
			where	nr_seq_resultado 	= nr_seq_resultado_w
			and		nr_seq_prescr 		= nr_seq_prescricao_result_w
			and		(nr_seq_exame IS NOT NULL AND nr_seq_exame::text <> '');

			select  nextval('result_laboratorio_copia_seq')
			into STRICT 	nr_sequencia_copia_w
			;

			INSERT INTO result_laboratorio_copia(
								NR_SEQUENCIA,
								NR_PRESCRICAO,
								NR_SEQ_PRESCRICAO,
								NM_USUARIO,
								DT_ATUALIZACAO,
								IE_COBRANCA,
								IE_ORIGEM_PROCED,
								CD_PROCEDIMENTO,
								--DS_RESULTADO,
								IE_FORMATO_TEXTO,
								DT_COLETA,
								NR_SEQ_RESULT_ANT,
								IE_STATUS_CONVERSAO,
								DS_RESULT_CODIGO,
								NR_SEQ_PAGINA,
								NR_SEQ_EXAME,
								DT_DESAPROVACAO,
								ie_tipo_registro,
								dt_aprovacao_exame
			) VALUES (
								nr_sequencia_copia_w,
								nr_prescricao_result_w,
								nr_seq_prescricao_result_w,
								nm_usuario_p,
								clock_timestamp(),
								ie_cobranca_result_w,
								ie_origem_proced_result_w,
								cd_procedimento_result_w,
								--ds_resultado_result_w,
								ie_formato_texto_result_w,
								dt_coleta_result_w,
								nr_sequencia_result_w,
								ie_status_conversao_result_w,
								ds_result_codigo_result_w,
								nr_seq_pagina_result_w,
								nr_seq_exame_result_w,
								clock_timestamp(),
								'A',
								dt_aprovacao_w

			);

			CALL COPIA_CAMPO_LONG_DE_PARA('RESULT_LABORATORIO',
									 'DS_RESULTADO',
									 ' WHERE nr_sequencia=:nr_seq_ori',
									 'nr_seq_ori='||nr_sequencia_result_w,
									 'RESULT_LABORATORIO_COPIA',
									 'DS_RESULTADO',
									 ' WHERE nr_sequencia=:nr_seq_dest',
									 'nr_seq_dest='||nr_sequencia_copia_w);

			END;
		END LOOP;
		CLOSE C02;

		select 	coalesce(MAX(IE_STATUS_DESAPROV_WS),30)
		into STRICT 	ie_status_update_w
		from	lab_parametro a,
				prescr_medica b
		where 	a.cd_estabelecimento = b.cd_estabelecimento
		and		b.nr_prescricao = nr_prescricao_p;

		if (ie_atual_dt_emiss_desaprov_w = 'N') then
			UPDATE  prescr_procedimento
			SET		ie_status_atend = ie_status_update_w,
					cd_motivo_baixa = 0,
					nm_usuario  = nm_usuario_p
			WHERE	nr_prescricao = nr_prescricao_p
			  AND 	nr_sequencia  = nr_seq_prescr_p
			  and	ie_status_atend >= 35;
		else
			UPDATE  prescr_procedimento
			SET		ie_status_atend = ie_status_update_w,
					cd_motivo_baixa = 0,
					dt_emissao_resultado  = NULL,
					nm_usuario  = nm_usuario_p
			WHERE	nr_prescricao = nr_prescricao_p
			  AND 	nr_sequencia  = nr_seq_prescr_p
			  and	ie_status_atend >= 35;
		end if;

		UPDATE 	exame_lab_result_item
		SET 	dt_aprovacao  = NULL,
			cd_medico_resp  = NULL
		WHERE   nr_seq_resultado	= nr_seq_resultado_w
		AND nr_seq_prescr	= nr_seq_prescr_p;

		DELETE FROM result_laboratorio
		WHERE nr_prescricao	= nr_prescricao_p
		  AND nr_seq_prescricao = nr_seq_prescr_p;

		DELETE FROM w_exame_lab_result_item
		WHERE nr_seq_resultado	= nr_seq_resultado_w
		  AND nr_seq_prescr	= nr_seq_prescr_p;

		OPEN C01;
		LOOP
		FETCH C01 INTO
			nr_seq_result_item_w;
		EXIT WHEN NOT FOUND; /* apply on C01 */
			BEGIN

			SELECT 	coalesce(MAX(nr_sequencia),0)+1
			INTO STRICT	nr_seq_reult_w
			FROM	w_exame_lab_result_item
			WHERE nr_seq_resultado	= nr_seq_resultado_w;

			INSERT INTO w_exame_lab_result_item(
					NR_SEQ_RESULTADO,
					NR_SEQUENCIA,
					NR_SEQ_EXAME,
					DT_ATUALIZACAO,
					NM_USUARIO,
					QT_RESULTADO,
					DS_RESULTADO,
					NR_SEQ_METODO,
					NR_SEQ_MATERIAL,
					PR_RESULTADO,
					IE_STATUS,
					DT_APROVACAO,
					NM_USUARIO_APROVACAO,
					NR_SEQ_PRESCR,
					PR_MINIMO,
					PR_MAXIMO,
					QT_MINIMA,
					QT_MAXIMA,
					DS_OBSERVACAO,
					DS_REFERENCIA,
					DS_UNIDADE_MEDIDA,
					QT_DECIMAIS,
					DS_REGRA,
					DT_COLETA,
					NR_SEQ_REAGENTE,
					NR_SEQ_FORMATO,
					CD_MEDICO_RESP,
					DT_IMPRESSAO,
					NR_SEQ_UNID_MED,
					CD_EQUIPAMENTO)
			SELECT 		NR_SEQ_RESULTADO,
					nr_seq_reult_w,
					NR_SEQ_EXAME,
					clock_timestamp(),
					NM_USUARIO_P,
					QT_RESULTADO,
					DS_RESULTADO,
					NR_SEQ_METODO,
					NR_SEQ_MATERIAL,
					PR_RESULTADO,
					IE_STATUS,
					DT_APROVACAO,
					NM_USUARIO_APROVACAO,
					NR_SEQ_PRESCR,
					PR_MINIMO,
					PR_MAXIMO,
					QT_MINIMA,
					QT_MAXIMA,
					DS_OBSERVACAO,
					DS_REFERENCIA,
					DS_UNIDADE_MEDIDA,
					QT_DECIMAIS,
					DS_REGRA,
					DT_COLETA,
					NR_SEQ_REAGENTE,
					NR_SEQ_FORMATO,
					CD_MEDICO_RESP,
					DT_IMPRESSAO,
					NR_SEQ_UNID_MED,
					CD_EQUIPAMENTO
			FROM exame_lab_result_item
			WHERE nr_seq_resultado	= nr_seq_resultado_w
			AND nr_sequencia	= nr_seq_result_item_w
			AND nr_seq_prescr	= nr_seq_prescr_p;

			if (ie_gerar_result_prescr_w = 'N') then
				DELETE 	FROM exame_lab_result_item
				WHERE 	nr_seq_resultado = nr_seq_resultado_w
				and		nr_sequencia = nr_seq_result_item_w
				AND 	nr_seq_prescr	= nr_seq_prescr_p;
			else
				DELETE 	FROM exame_lab_result_item
				WHERE 	nr_seq_resultado = nr_seq_resultado_w
				and		nr_sequencia = nr_seq_result_item_w
				AND 	nr_seq_prescr	= nr_seq_prescr_p
				and		coalesce(nr_seq_material::text, '') = ''
				and		coalesce(nr_seq_formato::text, '') = '';

				update  exame_lab_result_item
				set		ds_resultado = '',
						qt_resultado  = NULL,
						pr_resultado  = NULL
				WHERE 	nr_seq_resultado = nr_seq_resultado_w
				and		nr_sequencia = nr_seq_result_item_w
				AND 	nr_seq_prescr	= nr_seq_prescr_p
				and		(nr_seq_material IS NOT NULL AND nr_seq_material::text <> '')
				and		(nr_seq_formato IS NOT NULL AND nr_seq_formato::text <> '');
			end if;

			delete	from w_exame_lab_result_antib
			where	nr_seq_resultado = nr_seq_resultado_w
			  and	nr_seq_prescr = nr_seq_prescr_p;

			open c03;
			loop
			fetch c03 into
				c03_w;
			EXIT WHEN NOT FOUND; /* apply on c03 */
				begin

				insert into w_exame_lab_result_antib(
					nr_sequencia,
					qt_microorganismo,
					qt_mic,
					ie_resultado,
					dt_atualizacao,
					nm_usuario,
					ds_obs_microorganismo,
					ie_micro_sem_antib,
					ie_primeira_escolha,
					ds_obs_antibiotico,
					nr_cultura_microorg,
					nr_seq_resultado,
					nr_seq_result_item,
					cd_microorganismo,
					cd_medicamento,
					nr_seq_prescr)
				values (
					c03_w.nr_sequencia,
					c03_w.qt_microorganismo,
					c03_w.qt_mic,
					c03_w.ie_resultado,
					clock_timestamp(),
					nm_usuario_p,
					c03_w.ds_obs_microorganismo,
					c03_w.ie_micro_sem_antib,
					c03_w.ie_primeira_escolha,
					c03_w.ds_obs_antibiotico,
					c03_w.nr_cultura_microorg,
					c03_w.nr_seq_resultado,
					c03_w.nr_seq_result_item,
					c03_w.cd_microorganismo,
					c03_w.cd_medicamento,
					nr_seq_prescr_p);

				delete 	from w_exame_lab_res_antib_adi
				where	nr_seq_resultado = nr_seq_resultado_w
				  and	nr_seq_prescr = nr_seq_prescr_p;

				open c04;
				loop
				fetch c04 into
					c04_w;
				EXIT WHEN NOT FOUND; /* apply on c04 */
					begin

					insert into w_exame_lab_res_antib_adi(
						nr_sequencia,
						dt_atualizacao,
						nm_usuario,
						dt_atualizacao_nrec,
						nm_usuario_nrec,
						nr_seq_exame_lab_result_antib,
						cd_medicamento,
						nr_seq_resultado,
						nr_seq_prescr)
					values (
						c04_w.nr_sequencia,
						clock_timestamp(),
						nm_usuario_p,
						clock_timestamp(),
						nm_usuario_p,
						c04_w.nr_seq_exame_lab_result_antib,
						c04_w.cd_medicamento,
						c03_w.nr_seq_resultado,
						nr_seq_prescr_p);

					end;
				end loop;
				close c04;
				end;
			end loop;
			close c03;

			END;
		END LOOP;
		CLOSE C01;

		CALL gerar_lab_log_interf_imp(nr_prescricao_p,
					nr_seq_prescr_p,
					null,
					null,
					substr('LaboratorioWS - desaprovarExames - nr_prescricao_p: '||nr_prescricao_p||'  nr_seq_prescr_p:'||nr_seq_prescr_p,1,1999),
					'LaboratorioWS',
					'',
					nm_usuario_p,
					'N');
	end if;
exception
when others then
	ds_erro_w := WHEB_MENSAGEM_PCK.get_texto(279713,null) || substr(sqlerrm,1,240);
end;

COMMIT;

ds_erro_p := ds_erro_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ws_desfazer_lab_aprovacao ( nr_prescricao_p bigint, nr_seq_prescr_p bigint, nm_usuario_p text, ds_erro_p INOUT text) FROM PUBLIC;

