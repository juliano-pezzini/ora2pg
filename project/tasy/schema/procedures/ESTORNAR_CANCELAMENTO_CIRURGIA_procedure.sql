-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE estornar_cancelamento_cirurgia ( nr_seq_agenda_p bigint, nr_cirurgia_p bigint, nm_usuario_p text) AS $body$
DECLARE


nr_cirurgia_w			bigint;
nr_seq_agenda_w			agenda_paciente.nr_cirurgia%type;
nr_prescricao_w			bigint;
ie_status_cirurgia_w		varchar(03);
nr_atendimento_w		bigint;
dt_inicio_real_w		timestamp;
cd_agenda_w			bigint;
dt_agenda_w			timestamp;
hr_inicio_w			timestamp;
	

BEGIN

if (nr_seq_agenda_p IS NOT NULL AND nr_seq_agenda_p::text <> '') and (nr_seq_agenda_p > 0) then
	begin

	nr_seq_agenda_w	:= nr_seq_agenda_p;

	select		nr_cirurgia
	into STRICT		nr_cirurgia_w
	from 		Agenda_paciente
	where		nr_sequencia 	= nr_seq_agenda_p;

	select		coalesce(max(nr_prescricao),0)
	into STRICT		nr_prescricao_w
	from 		prescr_medica
	where		nr_seq_agenda	= nr_seq_agenda_p;

	end;
end if;


if (nr_cirurgia_p IS NOT NULL AND nr_cirurgia_p::text <> '') and (nr_cirurgia_p > 0) then
	begin

	nr_cirurgia_w	:= nr_cirurgia_p;

	select		coalesce(max(nr_sequencia),0)
	into STRICT		nr_seq_agenda_w
	from 		Agenda_paciente
	where		nr_cirurgia 	= nr_cirurgia_p;

	select		coalesce(max(nr_prescricao),0)
	into STRICT		nr_prescricao_w
	from 		cirurgia
	where		nr_cirurgia	= nr_cirurgia_p;

	end;
end if;


select		max(ie_status_cirurgia),
		max(nr_atendimento),
		max(dt_inicio_real) 
into STRICT		ie_status_cirurgia_w,
		nr_atendimento_w,
		dt_inicio_real_w
from		cirurgia
where		nr_cirurgia		= nr_cirurgia_w;

if (dt_inicio_real_w IS NOT NULL AND dt_inicio_real_w::text <> '') then
	CALL WHEB_MENSAGEM_PCK.Exibir_Mensagem_Abort(278940,'NR_CIRURGIA='|| nr_cirurgia_w);
else
	begin

	if (nr_seq_agenda_w IS NOT NULL AND nr_seq_agenda_w::text <> '') and (nr_seq_agenda_w > 0) then
		begin

		update agenda_paciente
		set	dt_atualizacao		= clock_timestamp(),
			nm_usuario		= nm_usuario_p,
			cd_motivo_cancelamento	 = NULL,
			ie_status_agenda	= 'N',
			hr_inicio		= hr_inicio + 1/86400
		where	nr_sequencia		= nr_seq_agenda_w;
		
		end;
	end if;

	if (nr_cirurgia_w IS NOT NULL AND nr_cirurgia_w::text <> '') then
		begin
		update cirurgia
		set	ie_status_cirurgia		= 1,
			dt_cancelamento			 = NULL,
			ie_motivo_cancelamento		 = NULL
		where nr_cirurgia			= nr_cirurgia_w;
		
		update	kit_estoque
		set	nr_atendimento	 = NULL,
			nr_prescricao 	 = NULL,
			nr_cirurgia	 = NULL
		where 	nr_cirurgia 	= nr_cirurgia_w;
		
		end;
	end if;

	

	end;
end if;
commit;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE estornar_cancelamento_cirurgia ( nr_seq_agenda_p bigint, nr_cirurgia_p bigint, nm_usuario_p text) FROM PUBLIC;

