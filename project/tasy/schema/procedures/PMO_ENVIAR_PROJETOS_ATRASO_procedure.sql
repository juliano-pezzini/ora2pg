-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pmo_enviar_projetos_atraso ( nm_usuario_p text) AS $body$
DECLARE

 
cd_responsavel_w		varchar(10);
ds_email_responsavel_w		varchar(255);
nr_seq_projeto_w		bigint;
ds_gerencia_w			varchar(255);
ie_status_w			varchar(3);
ds_status_w			varchar(80);
pr_prev_dia_w			double precision;
pr_real_dia_w			double precision;
nr_seq_gerencia_w		bigint;
ds_mensagem_risco_w		varchar(4000);
ds_mensagem_atraso_w		varchar(4000);
ds_titulo_w			varchar(80);
ds_mensagem_padrao_w		varchar(4000);
ds_assunto_w			varchar(255);
nm_usuario_origem_w		varchar(255);
ds_email_origem_w		varchar(255);
ds_email_w			varchar(255);
ds_email_remetente_w		varchar(255);
ds_titulo_risco_w		varchar(255);
ds_titulo_atraso_w		varchar(255);

/*ie_status 	2 - Em risco 
		3 - Em atraso*/
 
 
C01 CURSOR FOR 
	SELECT	cd_responsavel, 
		substr(obter_compl_pf(cd_responsavel,2,'M'),1,255), 
		nr_sequencia 
	from	gerencia_wheb 
	where	ie_situacao = 'A' 
	and	(obter_compl_pf(cd_responsavel,2,'M') IS NOT NULL AND (obter_compl_pf(cd_responsavel,2,'M'))::text <> '');

 
C02 CURSOR FOR 
	SELECT	a.nr_seq_projeto, 
		round((a.pr_prev_dia)::numeric,2), 
		round((a.pr_real_dia)::numeric,2), 
		substr(obter_valor_dominio(5700, a.ie_status),1,80) ds_status, 
		a.ie_status, 
		substr(obter_descricao_gerencia(b.nr_seq_gerencia),1,80) ds_gerencia, 
		substr(b.ds_titulo,1,255) 
	from	proj_projeto b, 
		w_analise_proj_dia a 
	where	a.nr_seq_projeto = b.nr_sequencia 
	and 	b.nr_seq_classif <> 22 
	and	((a.ie_status = 2) or (a.ie_status = 3)) 
	and	b.nr_seq_gerencia = nr_seq_gerencia_w 
	and	a.dt_analise between trunc(clock_timestamp()) - 1 and fim_dia(clock_timestamp()) - 1 
	order by a.dt_inicio_real;


BEGIN 
 
ds_email_remetente_w	:= 'pmo_desenvolvimento@wheb.com.br';
nm_usuario_origem_w 	:= nm_usuario_p;
ds_mensagem_risco_w 	:= null;
ds_mensagem_atraso_w	:= null;
ds_titulo_risco_w	:= 'Projetos em risco: ';
ds_titulo_atraso_w	:= 'Projetos em atraso: ';
 
open C01;
loop 
fetch C01 into 
	cd_responsavel_w, 
	ds_email_w, 
	nr_seq_gerencia_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	ds_mensagem_padrao_w := null;
	ds_assunto_w := null;
	ds_mensagem_risco_w := null;
	ds_mensagem_atraso_w := null;
 
	open C02;
	loop 
	fetch C02 into 
		nr_seq_projeto_w, 
		pr_prev_dia_w, 
		pr_real_dia_w, 
		ds_status_w, 
		ie_status_w, 
		ds_gerencia_w, 
		ds_titulo_w;
	EXIT WHEN NOT FOUND; /* apply on C02 */
		begin 
 
		if (ie_status_w = 2) then 
			ds_mensagem_risco_w := substr(ds_mensagem_risco_w || ' - ' || to_char(nr_seq_projeto_w) || '-' || ds_titulo_w || '-' || 'Previsto: ' || to_char(pr_prev_dia_w) || '%' || ' Real: ' || to_char(pr_real_dia_w) || '%' || chr(13) || chr(10),1,3999);
		--- 5218-Reorganização processos contas médicas - Valorização-Previsto: 70,3125% Real: 36,23% 
		elsif (ie_status_w = 3) then 
			ds_mensagem_atraso_w := substr(ds_mensagem_atraso_w || ' - ' || to_char(nr_seq_projeto_w) || '-' || ds_titulo_w || '-' || 'Previsto: ' || to_char(pr_prev_dia_w) || '%' || ' Real: ' || to_char(pr_real_dia_w) || '%' || chr(13) || chr(10),1,3999);
		end if;
 
		end;
	end loop;
	close C02;
 
	if	((ds_mensagem_risco_w IS NOT NULL AND ds_mensagem_risco_w::text <> '') or (ds_mensagem_atraso_w IS NOT NULL AND ds_mensagem_atraso_w::text <> '')) and (pkg_date_utils.is_business_day(clock_timestamp()) = 1) then 
 
		if (coalesce(ds_mensagem_risco_w::text, '') = '') then 
			ds_mensagem_risco_w := ds_mensagem_risco_w || '  Não existem projetos em risco de atraso' || chr(13) || chr(10);
		end if;
 
		if (coalesce(ds_mensagem_atraso_w::text, '') = '') then 
			ds_mensagem_atraso_w := ds_mensagem_atraso_w || '  Não existem projetos em atraso';
		end if;
		 
		ds_mensagem_padrao_w := substr(ds_titulo_risco_w || chr(13) || chr(10) || ds_mensagem_risco_w || chr(13) || chr(10) || ds_titulo_atraso_w || chr(13) || chr(10) || ds_mensagem_atraso_w,1,3999);
		ds_assunto_w := substr('Projetos em risco de atraso : ' || ds_gerencia_w,1,255);	
		 
		ds_email_w := ds_email_remetente_w || ',' || ds_email_w;
		 
		CALL enviar_email(ds_assunto_w,ds_mensagem_padrao_w,ds_email_remetente_w,ds_email_w,nm_usuario_origem_w,'M');
 
	end if;
	end;
end loop;
close C01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pmo_enviar_projetos_atraso ( nm_usuario_p text) FROM PUBLIC;

