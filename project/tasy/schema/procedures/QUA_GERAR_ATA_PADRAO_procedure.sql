-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE qua_gerar_ata_padrao ( nr_seq_ata_padrao_p bigint, nr_seq_ata_p INOUT bigint, nm_usuario_p text) AS $body$
DECLARE


ds_pauta_w		varchar(255);
ds_titulo_w		varchar(80);
ds_conteudo_w		varchar(4000);
nr_seq_apresentacao_w	bigint;
ds_ata_w			varchar(255);
nr_seq_classif_w		bigint;
cd_pessoa_w		varchar(10);
cd_estabelecimento_w	smallint := wheb_usuario_pck.get_cd_estabelecimento;


c01 CURSOR FOR
	SELECT	ds_pauta
	from	proj_ata_padrao_pauta
	where	nr_seq_ata = nr_seq_ata_padrao_p;

c02 CURSOR FOR
	SELECT	ds_titulo,
		ds_conteudo,
		nr_seq_apresentacao
	from	proj_ata_padrao_conteudo
	where	nr_seq_ata = nr_seq_ata_padrao_p;


BEGIN

if (coalesce(nr_seq_ata_padrao_p,0) > 0) then
	begin
	select	ds_ata,
		nr_seq_classif
	into STRICT	ds_ata_w,
		nr_seq_classif_w
	from	proj_ata_padrao
	where	nr_sequencia = nr_seq_ata_padrao_p;

	select	nextval('proj_ata_seq')
	into STRICT	nr_seq_ata_p
	;

	select	cd_pessoa_fisica
	into STRICT	cd_pessoa_w
	from	usuario
	where	nm_usuario = nm_usuario_p;

	if (coalesce(cd_pessoa_w,'X') = 'X') then
		/*(-20011,'O usuário logado não possui pessoa física vinculada');*/

		CALL wheb_mensagem_pck.exibir_mensagem_abort(263176);
	end if;

	insert into proj_ata(	nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			dt_ata,
			cd_estabelecimento,
			cd_consultor,
			ds_ata,
			ie_tipo_ata,
			ie_situacao)
		values (	nr_seq_ata_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			cd_estabelecimento_w,
			cd_pessoa_w,
			ds_ata_w,
			'Q',
			'A');

	open c01;
	loop
	fetch c01 into
		ds_pauta_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
		insert into proj_ata_pauta(	nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_ata,
					ds_pauta)
				values (	nextval('proj_ata_pauta_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_ata_p,
					ds_pauta_w);

		end;
	end loop;
	close c01;

	open c02;
	loop
	fetch c02 into
		ds_titulo_w,
		ds_conteudo_w,
		nr_seq_apresentacao_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		begin

		insert into proj_ata_conteudo(	nr_sequencia,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					nr_seq_ata,
					ds_conteudo,
					ds_titulo,
					nr_seq_apresentacao)
				values (	nextval('proj_ata_conteudo_seq'),
					clock_timestamp(),
					nm_usuario_p,
					clock_timestamp(),
					nm_usuario_p,
					nr_seq_ata_p,
					ds_conteudo_w,
					ds_titulo_w,
					nr_seq_apresentacao_w);

		end;
	end loop;
	close c02;

	commit;
	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE qua_gerar_ata_padrao ( nr_seq_ata_padrao_p bigint, nr_seq_ata_p INOUT bigint, nm_usuario_p text) FROM PUBLIC;

