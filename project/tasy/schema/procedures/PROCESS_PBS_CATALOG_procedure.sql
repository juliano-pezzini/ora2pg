-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE process_pbs_catalog ( nr_pbs_version_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint ) AS $body$
DECLARE


nr_count_w	pbsload_version.nr_sequencia%type;
nr_err_w constant pbsload_version.nr_sequencia%type := -20999;
is_consider_drug_cat_w	pbsload_version.ie_consider_drug_catalog%type;

c_pbsimp_master_w CURSOR FOR
	SELECT	a.cd_pbs
	from 	pbsimp_master a
	where	a.nr_pbs_version = nr_pbs_version_p;

c_pbsimp_material_w CURSOR FOR
	SELECT	a.cd_material
	from 	pbsimp_material a
	where	a.nr_pbs_version = nr_pbs_version_p;

BEGIN

	--	1. If there exists records such that PBSIMP_VIA_APLICACAO.IE_VIA_APLICACAO is NULL, raise error and terminate the process.
    select case
        when exists (select 1 from PBSIMP_VIA_APLICACAO where coalesce(IE_VIA_APLICACAO::text, '') = '')
    then 99
    else 0
    end
    into STRICT nr_count_w
;

	if (nr_count_w != 0) then
		RAISE EXCEPTION '%', wheb_mensagem_pck.get_texto(1214658) USING ERRCODE = nr_err_w;
	end if;

	-- 2. Process all PBS related data.
		begin
			CALL imp_pbs_master_data(nr_pbs_version_p, nm_usuario_p);
			exception
			when too_many_rows then
				rollback;
				raise;
			when others then
				rollback;
				raise;
		end;

	/* 4. for every pbsimp_master inserted for current version, check for new, modified, deleted, no change scenarios by invoking
			compare_pbs_master(r_pbsimp_master_w.cd_pbs, nr_pbs_version_p, nm_usuario_p)
	*/
	for r_pbsimp_master_w in c_pbsimp_master_w loop
		begin
			CALL compare_pbs_master(r_pbsimp_master_w.cd_pbs, nr_pbs_version_p, nm_usuario_p);
			exception
			when too_many_rows then
				rollback;
			when others then
				rollback;
			end;
	end loop;

	-- 6. Update the status of  pbsload_version and return
	update pbsload_version set ie_status = 2 where nr_sequencia = nr_pbs_version_p;
	commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE process_pbs_catalog ( nr_pbs_version_p bigint, nm_usuario_p text, cd_estabelecimento_p bigint ) FROM PUBLIC;

