-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_dados_pac_manchester (NR_ATENDIMENTO_P bigint, IE_RETRIAGEM_P INOUT text, QT_IDADE_P INOUT bigint, QT_IDADE_ANO_DIA_P INOUT bigint, DS_SEXO_P INOUT text, DT_TRIAGEM_P INOUT text, DT_INICIO_ATENDIMENTO_P INOUT text, NM_USUARIO_TRIAGEM_P INOUT text, DS_TIPO_ATENDIMENTO_P INOUT text, DS_PROCEDENCIA_P INOUT text, DS_QUEIXA_P INOUT text, DS_OBSERVACAO_TRIAGEM_P INOUT text, DT_FIM_TRIAGEM_P INOUT text) AS $body$
DECLARE

 
 
nr_sequencia_w		bigint;
ie_retriagem_w 		varchar(1);
qt_idade_w		integer;
qt_idade_ano_dia_w 	integer;
ds_sexo_w		varchar(10);
dt_triagem_w		varchar(25);
dt_inicio_atendimento_w varchar(25);
nm_usuario_triagem_w	varchar(15);
ds_tipo_atendimento_w	varchar(255);
ds_procedencia_w	varchar(255);
ds_queixa_w		varchar(255);
ds_observacao_triagem_w varchar(255);
dt_fim_triagem_w	varchar(25);


BEGIN 
if (nr_atendimento_p > 0) then 
		 
	select	max(a.qt_idade) qt_idade, 
		max(trunc(a.qt_idade_dia/365,3)) qt_idade_ano_dia, 
		max(CASE WHEN a.ie_sexo='F' THEN 'Fem' WHEN a.ie_sexo='M' THEN 'Masc'  ELSE '' END ) ds_sexo, 
		max(to_char(a.dt_triagem,'dd/mm/yyyy hh24:mi')) dt_triagem, 
		max(to_char(a.dt_inicio_atendimento,'dd/mm/yyyy hh24:mi')) dt_inicio_atendimento, 
		max(a.nm_usuario_triagem) nm_usuario_triagem, 
		max(a.ds_tipo_atendimento) ds_tipo_atendimento, 
		max(substr(obter_desc_procedencia(a.cd_procedencia),1,150)) ds_procedencia, 
		max(a.ds_queixa) ds_queixa, 
		max(a.ds_observacao_triagem) ds_observacao_triagem, 
		max(to_char(a.dt_fim_triagem,'dd/mm/yyyy hh24:mi')) dt_fim_triagem 
	into STRICT	qt_idade_w, 
		qt_idade_ano_dia_w, 
		ds_sexo_w, 
		dt_triagem_w, 
		dt_inicio_atendimento_w, 
		nm_usuario_triagem_w, 
		ds_tipo_atendimento_w, 
		ds_procedencia_w, 
		ds_queixa_w, 
		ds_observacao_triagem_w, 
		dt_fim_triagem_w 
	from	atendimento_ps_v a 
	where 	nr_atendimento = nr_atendimento_p;
	 
	select	max(tb.nr_sequencia) 
	into STRICT	nr_sequencia_w 
	from	triagem_pronto_atend tb 
	where	tb.nr_atendimento = nr_atendimento_p 
	and	(tb.nr_seq_classif IS NOT NULL AND tb.nr_seq_classif::text <> '') 
	and	(tb.ie_retriagem IS NOT NULL AND tb.ie_retriagem::text <> '');
	 
	if (nr_sequencia_w > 0) then 
		select	max(t.ie_retriagem) ie_retriagem 
		into STRICT	ie_retriagem_w 
		from	triagem_pronto_atend t 
		where	nr_sequencia = nr_sequencia_w;
	end if;
	 
	ie_retriagem_p 		:= coalesce(ie_retriagem_w,'N');
	qt_idade_p 		:= qt_idade_w;
	qt_idade_ano_dia_p 	:= qt_idade_ano_dia_w;
	ds_sexo_p 		:= ds_sexo_w;
	dt_triagem_p 		:= dt_triagem_w;
	dt_inicio_atendimento_p := dt_inicio_atendimento_w;
	nm_usuario_triagem_p 	:= nm_usuario_triagem_w;
	ds_tipo_atendimento_p 	:= ds_tipo_atendimento_w;
	ds_procedencia_p 	:= ds_procedencia_w;
	ds_queixa_p 		:= ds_queixa_w;
	ds_observacao_triagem_p := ds_observacao_triagem_w;
	dt_fim_triagem_p 	:= dt_fim_triagem_w;
 
end if;
	 
	 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_dados_pac_manchester (NR_ATENDIMENTO_P bigint, IE_RETRIAGEM_P INOUT text, QT_IDADE_P INOUT bigint, QT_IDADE_ANO_DIA_P INOUT bigint, DS_SEXO_P INOUT text, DT_TRIAGEM_P INOUT text, DT_INICIO_ATENDIMENTO_P INOUT text, NM_USUARIO_TRIAGEM_P INOUT text, DS_TIPO_ATENDIMENTO_P INOUT text, DS_PROCEDENCIA_P INOUT text, DS_QUEIXA_P INOUT text, DS_OBSERVACAO_TRIAGEM_P INOUT text, DT_FIM_TRIAGEM_P INOUT text) FROM PUBLIC;

