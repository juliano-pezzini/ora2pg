-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE verificar_interacao_medic ( nr_prescricao_p bigint) AS $body$
DECLARE


cd_material_w		integer;
ds_retorno_w		varchar(8000) := '';
ds_material_w		varchar(100);
ds_material_ww		varchar(100);
ds_interacao_w		varchar(4000) := '';
ds_principio_ativo_w	varchar(100);
ds_tipo_w		varchar(255);
ds_severidade_w		varchar(254);
nr_seq_ficha_tecnica_w	bigint;
nm_usuario_original_w	varchar(15);
cd_material_interacao_w	integer;
ie_severidade_w		varchar(15);
ie_consistir_w		varchar(15);
ie_liberacao_w		varchar(15);
nm_usuario_w		varchar(50);
ie_gravar_w		varchar(1);
ds_orientacao_w		varchar(4000);
ds_orient_w		varchar(4000);
ds_w			varchar(4000);
nr_sequencia_w		bigint;
nr_seq_medic_w		bigint;		
ie_agrupador_w		smallint;
nr_agrupamento_w	double precision;
qt_dependente_w		bigint;
nr_dias_interacao_w	bigint;
nr_sequencia_diluicao_w	bigint;
nr_sequencia_solucao_w	integer;
nr_atendimento_w	bigint;
cd_estabelecimento_w	integer;
dt_liberacao_w		timestamp;
cd_log_w           	bigint;
ie_oriencao_item_w     integer;
cd_cursor_w	smallint;
ie_esta_prescrito_w	varchar(1);

C01 CURSOR FOR
SELECT	distinct b.cd_material,
	substr(c.ds_material,1,100),
	c.nr_seq_ficha_tecnica,
	a.nm_usuario_original,
	b.nr_sequencia,
	b.ie_agrupador,
	b.nr_agrupamento,
	b.nr_sequencia_diluicao,
	b.nr_sequencia_solucao,
	coalesce(a.dt_liberacao_medico, a.dt_liberacao)
from	material c,
	prescr_material b,
	prescr_medica a
where	a.nr_prescricao	= nr_prescricao_p
and	a.nr_prescricao	= b.nr_prescricao
and	coalesce(b.dt_suspensao::text, '') = ''
and	b.cd_material	= c.cd_material
order by b.nr_sequencia;

C02 CURSOR FOR
SELECT	DISTINCT SUBSTR(obter_desc_material(a.cd_material_interacao),1,100),
	ds_tipo,
	SUBSTR(Obter_Valor_Dominio(1325, ie_severidade),1,254),
	ie_severidade,
	a.cd_material_interacao,
	coalesce(a.ie_consistir,'P'),
	a.ds_orientacao,
	a.ie_gravar,
	SUBSTR(Obter_desc_ficha_tecnica(a.nr_seq_ficha_interacao),1,100) ds_principio_ativo,
	1
FROM	material_interacao_medic a,
	prescr_material b,
	prescr_medica k
WHERE	a.cd_material		= cd_material_w
AND	a.cd_material		= b.cd_material
AND	k.nr_prescricao		= b.nr_prescricao
AND     k.nr_prescricao 	= nr_prescricao_p
and	coalesce(b.dt_suspensao::text, '') = ''
AND	coalesce(a.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
and		((coalesce(a.ie_funcao_prescritor::text, '') = '') or (a.ie_funcao_prescritor = k.ie_funcao_prescritor))
and	exists (SELECT	1
		from 	medic_uso_continuo c
		where	k.cd_pessoa_fisica      = c.cd_pessoa_fisica
		AND     c.cd_material		= a.cd_material_interacao)

union

select	distinct substr(obter_desc_material(a.cd_material_interacao),1,100),
	ds_tipo,
	substr(Obter_Valor_Dominio(1325, ie_severidade),1,254),
	ie_severidade,
	a.cd_material_interacao,
	coalesce(a.ie_consistir,'P'),
	a.ds_orientacao,
	a.ie_gravar,
	substr(Obter_desc_ficha_tecnica(a.nr_seq_ficha_interacao),1,100) ds_principio_ativo,
	2
from	material_interacao_medic a,
	prescr_material b,
	prescr_medica k
where	a.cd_material		= cd_material_w
and	a.cd_material_interacao	= b.cd_material
and	k.nr_prescricao 	= nr_prescricao_p
and	coalesce(b.dt_suspensao::text, '') = ''
and	k.nr_prescricao		= b.nr_prescricao
and	coalesce(a.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
and		((coalesce(a.ie_funcao_prescritor::text, '') = '') or (a.ie_funcao_prescritor = k.ie_funcao_prescritor))
and	coalesce(nr_dias_interacao_w,0) = 0

union

select	distinct substr(obter_desc_material(b.cd_material),1,100),
	ds_tipo,
	substr(obter_valor_dominio(1325, ie_severidade),1,254),
	ie_severidade,
	b.cd_material,
	coalesce(a.ie_consistir,'P'),
	a.ds_orientacao,
	a.ie_gravar,
	substr(Obter_desc_ficha_tecnica(a.nr_seq_ficha_interacao),1,100) ds_principio_ativo,
	3
from	material x,
	material_interacao_medic a,	
	prescr_material b,
	prescr_medica k
where	k.nr_prescricao = nr_prescricao_p
and	k.nr_prescricao = b.nr_prescricao
and	b.cd_material	= x.cd_material
and	coalesce(b.dt_suspensao::text, '') = ''
and	coalesce(nr_dias_interacao_w,0) = 0
and	coalesce(a.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
and		((coalesce(a.ie_funcao_prescritor::text, '') = '') or (a.ie_funcao_prescritor = k.ie_funcao_prescritor))
and	a.nr_seq_ficha_interacao = nr_seq_ficha_tecnica_w
and	a.nr_seq_ficha	= x.nr_seq_ficha_tecnica

union

select	distinct substr(obter_desc_material(a.cd_material_interacao),1,100),
	ds_tipo,
	substr(Obter_Valor_Dominio(1325, ie_severidade),1,254),
	ie_severidade,
	a.cd_material_interacao,
	coalesce(a.ie_consistir,'P'),
	a.ds_orientacao,
	a.ie_gravar,
	substr(Obter_desc_ficha_tecnica(a.nr_seq_ficha_interacao),1,100) ds_principio_ativo,
	4
from	material_interacao_medic a,
	prescr_material b,
	prescr_medica k
where	a.cd_material		= cd_material_w
and	a.cd_material_interacao	= b.cd_material
and	k.nr_atendimento 	= nr_atendimento_w
and	coalesce(b.dt_suspensao::text, '') = ''
and	coalesce(a.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
and		((coalesce(a.ie_funcao_prescritor::text, '') = '') or (a.ie_funcao_prescritor = k.ie_funcao_prescritor))
and	k.dt_validade_prescr		> establishment_timezone_utils.startofday(clock_timestamp()) - nr_dias_interacao_w
and	((ie_liberacao_w = 'S') or (((coalesce(k.dt_liberacao, k.dt_liberacao_medico) IS NOT NULL AND (coalesce(k.dt_liberacao, k.dt_liberacao_medico))::text <> '')) or (k.nr_prescricao = nr_prescricao_p)))
and	k.nr_prescricao		= b.nr_prescricao
and	coalesce(nr_dias_interacao_w,0) > 0

union

select	distinct substr(obter_desc_material(b.cd_material),1,100),
	ds_tipo,
	substr(obter_valor_dominio(1325, ie_severidade),1,254),
	ie_severidade,
	b.cd_material,
	coalesce(a.ie_consistir,'P'),
	a.ds_orientacao,
	a.ie_gravar,
	substr(Obter_desc_ficha_tecnica(a.nr_seq_ficha_interacao),1,100) ds_principio_ativo,
	5
from	material x,
	material_interacao_medic a,	
	prescr_material b,
	prescr_medica k
where	k.nr_atendimento = nr_atendimento_w
and	k.nr_prescricao = b.nr_prescricao
and	b.cd_material	= x.cd_material
and	coalesce(nr_dias_interacao_w,0) > 0
and	coalesce(b.dt_suspensao::text, '') = ''
and	coalesce(a.cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w
and	k.dt_validade_prescr		> establishment_timezone_utils.startofday(clock_timestamp()) - nr_dias_interacao_w
and		((coalesce(a.ie_funcao_prescritor::text, '') = '') or (a.ie_funcao_prescritor = k.ie_funcao_prescritor))
and	((ie_liberacao_w = 'S') or (((coalesce(k.dt_liberacao, k.dt_liberacao_medico) IS NOT NULL AND (coalesce(k.dt_liberacao, k.dt_liberacao_medico))::text <> '')) or (k.nr_prescricao = nr_prescricao_p)))
and	a.nr_seq_ficha_interacao = nr_seq_ficha_tecnica_w
and	a.nr_seq_ficha	= x.nr_seq_ficha_tecnica;		



BEGIN

delete	FROM prescr_medica_interacao
where	nr_prescricao	= nr_prescricao_p;

select	max(nr_atendimento),
		max(cd_estabelecimento),
		max(nm_usuario)
into STRICT	nr_atendimento_w,
		cd_estabelecimento_w,
		nm_usuario_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

select	max(nr_dias_interacao)
into STRICT	nr_dias_interacao_w
from	parametro_medico
where	cd_estabelecimento	= cd_estabelecimento_w;

ie_liberacao_w := Obter_Param_Usuario(924, 941, obter_perfil_ativo, nm_usuario_w, cd_estabelecimento_w, ie_liberacao_w);

open C01;
loop
fetch C01 into
	cd_material_w,
	ds_material_ww,
	nr_seq_ficha_tecnica_w,
	nm_usuario_original_w,
	nr_seq_medic_w,
	ie_agrupador_w,
	nr_agrupamento_w,
	nr_sequencia_diluicao_w,
	nr_sequencia_solucao_w,
	dt_liberacao_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	
	
	ds_interacao_w	:= '';
	ds_orientacao_w	:= '';
	open C02;
	loop
		fetch C02 into
			ds_material_w,
			ds_tipo_w,
			ds_severidade_w,
			ie_severidade_w,
			cd_material_interacao_w,
			ie_consistir_w,
			ds_orient_w,
			ie_gravar_w,
			ds_principio_ativo_w,
			cd_cursor_w;
		EXIT WHEN NOT FOUND; /* apply on C02 */	
		begin
						
		if (ie_gravar_w = 'S') then
		
			select	coalesce(max('S'),'N')
			into STRICT	ie_esta_prescrito_w
			from	prescr_material
			where	nr_prescricao = nr_prescricao_p
			and		cd_material = cd_material_interacao_w
			and		((ie_agrupador = ie_agrupador_w) or (coalesce(ie_consistir_w,'XPTO') = 'P'));
		
			if (ie_esta_prescrito_w = 'S') then
		
				if (coalesce(ds_orientacao_w::text, '') = '') then
					ds_orientacao_w	:= substr(ds_orient_w,1,4000);
				elsif (ie_esta_prescrito_w = 'S') then			
					ds_orientacao_w	:= substr(ds_orientacao_w || ' - ' || ds_orient_w,1,4000);
				end if;
				
			end if;
			
		end if;
				
		if (ie_consistir_w = 'P') then
			begin
		
			insert into prescr_medica_interacao(
				nr_sequencia,
				nr_prescricao,
				dt_atualizacao,
				nm_usuario,
				dt_atualizacao_nrec,
				nm_usuario_nrec,
				cd_material,
				cd_material_interacao,
				ds_interacao,
				ie_severidade,
				nr_seq_ficha_tecnica)
			values (nextval('prescr_medica_interacao_seq'),
				nr_prescricao_p,
				clock_timestamp(),
				nm_usuario_original_w,
				clock_timestamp(),
				nm_usuario_original_w,
				cd_material_w,
				cd_material_interacao_w,
				ds_tipo_w,
				ie_severidade_w,
				nr_seq_ficha_tecnica_w);
		
			
			if (coalesce(length(ds_interacao_w),0) < 3000) then
				begin
				if (coalesce(ds_interacao_w::text, '') = '') then
					ds_interacao_w := Wheb_mensagem_pck.get_texto(305981, 'DS_MATERIAL_A='||ds_material_ww||';DS_MATERIAL_B='||ds_material_w);
				else
					ds_interacao_w := ds_interacao_w  || chr(13) || chr(10) ||  Wheb_mensagem_pck.get_texto(305981, 'DS_MATERIAL_A='||ds_material_ww||';DS_MATERIAL_B='||ds_material_w);
				end if;

				if (ds_tipo_w IS NOT NULL AND ds_tipo_w::text <> '') then
					ds_interacao_w := ds_interacao_w  || ' ' || Wheb_mensagem_pck.get_texto(305995) || ' ' || ds_tipo_w;
				end if;
				if (ds_severidade_w IS NOT NULL AND ds_severidade_w::text <> '') then
					ds_interacao_w := ds_interacao_w  || '. ' || Wheb_mensagem_pck.get_texto(306029) || ' ' || ds_severidade_w;
				end if;
				if (ds_principio_ativo_w IS NOT NULL AND ds_principio_ativo_w::text <> '') then
					ds_interacao_w := ds_interacao_w || '. ' || Wheb_mensagem_pck.get_texto(306016) || ' ' || ds_principio_ativo_w;
				end if;
				ds_interacao_w := ds_interacao_w || chr(13) || chr(10);
				end;
			
			
			end if;
			end;
		elsif (ie_consistir_w = 'I') then
			begin
			
			
			if (ie_agrupador_w = 1) then
				begin
				select	count(*)
				into STRICT	qt_dependente_w
				from	prescr_material
				where	nr_prescricao		= nr_prescricao_p
				and	nr_sequencia_diluicao	= nr_seq_medic_w
				and	cd_material		= cd_material_interacao_w;
				
				if (qt_dependente_w = 0) then
					select	count(*)
					into STRICT	qt_dependente_w
					from	prescr_material
					where	nr_prescricao		= nr_prescricao_p
					and	nr_sequencia		<> nr_seq_medic_w
					and	ie_agrupador		= 1
					and	nr_agrupamento		= nr_agrupamento_w
					and	cd_material		= cd_material_interacao_w;
				end if;
				end;
			elsif (ie_agrupador_w in (3,7,9)) then
				begin
				
				select	count(*)
				into STRICT	qt_dependente_w
				from	prescr_material
				where	nr_prescricao		= nr_prescricao_p
				and	nr_sequencia		= nr_sequencia_diluicao_w
				and	cd_material		= cd_material_interacao_w;
				
				if (qt_dependente_w = 0) then
					begin
					select	count(*)
					into STRICT	qt_dependente_w
					from	prescr_material
					where	nr_prescricao		= nr_prescricao_p
					and	nr_sequencia_diluicao	= nr_sequencia_diluicao_w
					and	nr_sequencia		<> nr_seq_medic_w
					and	cd_material		= cd_material_interacao_w;
					end;
				end if;
				end;
			elsif (ie_agrupador_w = 4) then
				begin
				select	count(*)
				into STRICT	qt_dependente_w
				from	prescr_material
				where	nr_prescricao		= nr_prescricao_p
				and	nr_sequencia_solucao	= nr_sequencia_solucao_w
				and	cd_material		= cd_material_interacao_w;
				end;
			else	
				begin
				qt_dependente_w	:= 0;
				end;
			end if;
			end;
			
			if (qt_dependente_w > 0) then
				begin
				insert into prescr_medica_interacao(
					nr_sequencia,
					nr_prescricao,
					dt_atualizacao,
					nm_usuario,
					dt_atualizacao_nrec,
					nm_usuario_nrec,
					cd_material,
					cd_material_interacao,
					ds_interacao,
					ie_severidade,
					nr_seq_ficha_tecnica)
				values (nextval('prescr_medica_interacao_seq'),
					nr_prescricao_p,
					clock_timestamp(),
					nm_usuario_original_w,
					clock_timestamp(),
					nm_usuario_original_w,
					cd_material_w,
					cd_material_interacao_w,
					ds_tipo_w,
					ie_severidade_w,
					nr_seq_ficha_tecnica_w);
				end;
			end if;
		end if;
		end;
	end loop;
	close C02;
		
	if (ds_orientacao_w IS NOT NULL AND ds_orientacao_w::text <> '') and (coalesce(dt_liberacao_w::text, '') = '') then
		
		select	substr(max(ds_observacao),1,4000)
		into STRICT	ds_w
		from	prescr_material
		where	nr_prescricao	= nr_prescricao_p
		and		nr_sequencia	= nr_seq_medic_w;
			
		select position(ds_orientacao_w in ds_w)
		into STRICT  ie_oriencao_item_w
		;	
	
		if (coalesce(ie_oriencao_item_w,0) > 0) then
			ds_w := null;
		else
			ds_w := substr(ds_w,1,255);
		end if;
				
		if (coalesce(ds_w::text, '') = '') then
			ds_orientacao_w	:= substr(ds_orientacao_w,1,4000);
		else
			ds_orientacao_w	:= substr(ds_w || ' - ' || ds_orientacao_w,1,4000);
		end if;
						
		update	prescr_material
		set	    ds_observacao	= ds_orientacao_w
		where	nr_prescricao	= nr_prescricao_p
		and		nr_sequencia	= nr_seq_medic_w;
			
	
	end if;
	
	if (ds_interacao_w IS NOT NULL AND ds_interacao_w::text <> '') and (coalesce(length(ds_retorno_w),0) < 8000) then
		if (coalesce(ds_retorno_w::text, '') = '') then
			ds_retorno_w := substr(ds_interacao_w,1,8000);
		else
			ds_retorno_w := substr(ds_retorno_w ||chr(13) || chr(10) ||ds_interacao_w,1,8000);
		end if;
		
	end if;
	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE verificar_interacao_medic ( nr_prescricao_p bigint) FROM PUBLIC;

