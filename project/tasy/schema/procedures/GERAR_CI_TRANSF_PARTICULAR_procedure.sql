-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_ci_transf_particular ( nr_sequencia_p bigint, nr_interno_origem_p bigint, nr_interno_destino_p bigint, vl_original_p bigint, ie_tipo_p text, nm_usuario_p text) AS $body$
DECLARE


nm_usuario_envio_w	varchar(15);
ds_comunicado_w		varchar(20000);
ds_usuario_envio_w	varchar(4000) := '';
ds_item_w		varchar(100);
nm_pessoa_fisica_w	varchar(100);
nr_atendimento_w		bigint;
cd_item_w		bigint;
cd_perfil_w		integer;
ds_perfil_adicional_w	varchar(4000) := '';
vl_original_w		double precision;
qt_existe_w		bigint;

cd_estabelecimento_w	conta_paciente.cd_estabelecimento%type;

C01 CURSOR FOR
	SELECT	nm_usuario_envio,
		cd_perfil
	from	regra_ci_transf_partic
	where	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_w,0)) = coalesce(cd_estabelecimento_w,0)
	and	ie_situacao = 'A'
	order by	coalesce(cd_estabelecimento,0);


BEGIN

select	max(cd_estabelecimento)
into STRICT	cd_estabelecimento_w
from	conta_paciente
where	nr_interno_conta = nr_interno_origem_p;

select	count(*)
into STRICT	qt_existe_w
from	regra_ci_transf_partic
where	coalesce(cd_estabelecimento, coalesce(cd_estabelecimento_w,0)) = coalesce(cd_estabelecimento_w,0)
and	ie_situacao = 'A';

if (qt_existe_w > 0) then

	ds_usuario_envio_w := '';

	if (ie_tipo_p = 'P') then

		select	max(c.nr_atendimento),
			max(a.cd_procedimento),
			max(substr(obter_desc_procedimento(a.cd_procedimento, a.ie_origem_proced),1,100)),
			max(substr(obter_pessoa_atendimento(c.nr_atendimento, 'N'),1,100)),
			max(vl_procedimento)
		into STRICT	nr_atendimento_w,
			cd_item_w,
			ds_item_w,
			nm_pessoa_fisica_w,
			vl_original_w
		from	procedimento_paciente a,
			conta_paciente c
		where	a.nr_interno_conta = c.nr_interno_conta
		and	a.nr_sequencia = nr_sequencia_p;

	else

		select	max(c.nr_atendimento),
			max(a.cd_material),
			max(substr(obter_desc_material(a.cd_material),1,100)),
			max(substr(obter_pessoa_atendimento(c.nr_atendimento, 'N'),1,100)),
			max(vl_material)
		into STRICT	nr_atendimento_w,
			cd_item_w,
			ds_item_w,
			nm_pessoa_fisica_w,
			vl_original_w
		from	material_atend_paciente a,
			conta_paciente c
		where	a.nr_interno_conta = c.nr_interno_conta
		and	a.nr_sequencia = nr_sequencia_p;

	end if;

	open C01;
	loop
	fetch C01 into
		nm_usuario_envio_w,
		cd_perfil_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		if (nm_usuario_envio_w IS NOT NULL AND nm_usuario_envio_w::text <> '') then
			ds_usuario_envio_w := ds_usuario_envio_w || nm_usuario_envio_w || ', ';
		end if;

		if (cd_perfil_w IS NOT NULL AND cd_perfil_w::text <> '') then
			ds_perfil_adicional_w := ds_perfil_adicional_w || cd_perfil_w || ', ';
		end if;

		end;
	end loop;
	close C01;

	/*ds_comunicado_w	:=	'Atendimento: ' || nr_atendimento_w || chr(13) || chr(10) ||
				'Paciente: ' || nm_pessoa_fisica_w || chr(13) || chr(10) ||
				'Conta de origem: ' || nr_interno_origem_p || chr(13) || chr(10) ||
				'Conta de destino: ' || nr_interno_destino_p || chr(13) || chr(10) ||
				'Item: ' || cd_item_w || ' - ' || ds_item_w ||  chr(13) || chr(10) ||
				'Valor no convênio origem: ' || campo_mascara_virgula(vl_original_p) ||  chr(13) || chr(10) ||
				'Valor no convênio destino: ' || campo_mascara_virgula(vl_original_w);*/
	ds_comunicado_w	:=	wheb_mensagem_pck.get_texto(304071, 	'NR_ATENDIMENTO=' || nr_atendimento_w || ';' ||
									'NM_PESSOA_FISICA=' || nm_pessoa_fisica_w || ';' ||
									'NR_INTERNO_ORIGEM=' || nr_interno_origem_p || ';' ||
									'NR_INTERNO_DESTINO=' || nr_interno_destino_p || ';' ||
									'CD_ITEM=' || cd_item_w || ';' || 'DS_ITEM=' || ds_item_w || ';' ||
									'VL_ORIGEM=' || campo_mascara_virgula(vl_original_p) || ';' ||
									'VL_DESTINO=' || campo_mascara_virgula(vl_original_w));

	--gerar_comunic_padrao(sysdate, 'Transferência item particular ', ds_comunicado_w, nm_usuario_p, 'N', ds_usuario_envio_w,
	CALL gerar_comunic_padrao(clock_timestamp(), wheb_mensagem_pck.get_texto(304070), ds_comunicado_w, nm_usuario_p, 'N', ds_usuario_envio_w,
		'N', null, ds_perfil_adicional_w, coalesce(cd_estabelecimento_w, wheb_usuario_pck.get_cd_estabelecimento), null, clock_timestamp(), null, null);

end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_ci_transf_particular ( nr_sequencia_p bigint, nr_interno_origem_p bigint, nr_interno_destino_p bigint, vl_original_p bigint, ie_tipo_p text, nm_usuario_p text) FROM PUBLIC;

