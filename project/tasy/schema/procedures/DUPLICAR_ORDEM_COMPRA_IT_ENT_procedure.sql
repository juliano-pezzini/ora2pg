-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duplicar_ordem_compra_it_ent ( nr_ordem_compra_p bigint, nm_usuario_p text, nr_ordem_nova_p INOUT bigint) AS $body$
DECLARE


nr_ordem_compra_w	bigint;
nr_item_oci_w		bigint;
NR_PROCESSO_INTERNO_W	varchar(100);
cd_estabelecimento_w	bigint;
ie_gera_numero_w	varchar(1);

c01 CURSOR FOR
SELECT	nr_item_oci
FROM	ordem_compra_item
WHERE	nr_ordem_compra = nr_ordem_compra_p;


BEGIN

select	cd_estabelecimento
into STRICT	cd_estabelecimento_w
from	ordem_compra
where	nr_ordem_compra = nr_ordem_compra_p;

select	obter_valor_param_usuario(917, 161, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w)
into STRICT	ie_gera_numero_w
;

if (ie_gera_numero_w = 'S') then
	select	max((somente_numero(nr_processo_interno))::numeric ) +1
	into STRICT	nr_processo_interno_w
	from	ordem_compra
	where	(nr_processo_interno IS NOT NULL AND nr_processo_interno::text <> '');
end if;

SELECT	nextval('ordem_compra_seq')
INTO STRICT	nr_ordem_compra_w
;

INSERT INTO ordem_compra(
	NR_ORDEM_COMPRA,
	NR_ORDEM_ORIG,
	CD_ESTABELECIMENTO,
	CD_CGC_FORNECEDOR,
	CD_CONDICAO_PAGAMENTO,
	CD_COMPRADOR,
	DT_ORDEM_COMPRA,
	DT_ATUALIZACAO,
	NM_USUARIO,
	CD_MOEDA,
	IE_SITUACAO,
	DT_INCLUSAO,
	CD_PESSOA_SOLICITANTE,
	CD_CGC_TRANSPORTADOR,
	IE_FRETE, VL_FRETE,
	PR_MULTA_ATRASO,
	PR_DESCONTO,
	PR_DESC_PGTO_ANTEC,
	PR_JUROS_NEGOCIADO,
	DT_EMISSAO,
	DS_PESSOA_CONTATO,
	DS_OBSERVACAO,
	CD_MOTIVO_ALTERACAO,
	CD_LOCAL_ENTREGA,
	DT_ENTREGA,
	NR_PRESCRICAO,
	DT_APROVACAO,
	DT_BAIXA,
	DT_LIBERACAO,
	IE_AVISO_CHEGADA,
	NR_REQUISICAO,
	CD_PESSOA_FISICA,
	NR_ORDEM_AGRUP,
	IE_EMITE_OBS,
	IE_URGENTE,
	NR_SEQ_INTERNO,
	NR_ATENDIMENTO,
	NM_USUARIO_IMP,
	IE_SOMENTE_PAGTO,
	NR_SEQ_MOTIVO_CANCEL,
	VL_DESPESA_ACESSORIA,
	CD_SETOR_ATENDIMENTO,
	NR_SEQ_SUBGRUPO_COMPRA,
	PR_DESC_FINANCEIRO,
	DT_LEITURA,
	DT_ACEITE,
	NM_USUARIO_ACEITE,
	NR_SEQ_FORMA_PAGTO,
	NR_DOCUMENTO_EXTERNO,
	VL_DESCONTO,
	DT_FATURAMENTO,
	CD_CONVENIO,
	IE_TIPO_ORDEM,
	CD_ESTAB_TRANSF,
	IE_FORMA_EXPORTAR,
	NR_SEQ_RESSUP_FORNEC,
	DT_ENVIO_EMAIL,
	NR_CIRURGIA,
	NR_SEQ_REG_LIC_COMPRA,
	IE_LIBERACAO_PORTAL,
	NR_SEQ_NF_REPASSE,
	NR_SEQ_LICITACAO,
	NR_DOCUMENTO_INTERNO,
	NR_PROCESSO_INTERNO,
	NR_SEQ_TIPO_COMPRA,
	NR_SEQ_AGENDA_PAC,
	NR_SEQ_MOD_COMPRA,
	NR_CONTROLE_EDITAL,
	DS_DADOS_IMPORTACAO,
	NR_SEQ_MOTIVO_URGENTE,
	CD_CENTRO_CUSTO,
	IE_ORIGEM_IMP,
	DT_ENVIO_INTEGRACAO_OPME,
	DT_ESTORNO_LIB,
	NM_USUARIO_ESTORNO_LIB,
	NR_SEQ_MOTIVO_ESTORNO_LIB,
	DT_CONFIRMA_ENTREGA,
	NM_USUARIO_CONF_ENTR,
	CD_LOCAL_TRANSF,
	NR_SEQ_PROTOCOLO,
	DT_ATUALIZACAO_NREC,
	NM_USUARIO_NREC,
	NM_USUARIO_LIB,
	NR_SEQ_MOTIVO_BAIXA,
	VL_DESPESA_DOC)
SELECT
	nr_ordem_compra_w,
	nr_ordem_compra_p,
	CD_ESTABELECIMENTO,
	CD_CGC_FORNECEDOR,
	CD_CONDICAO_PAGAMENTO,
	CD_COMPRADOR,
	clock_timestamp(),
	clock_timestamp(),
	NM_USUARIO_P,
	CD_MOEDA,
	IE_SITUACAO,
	clock_timestamp(),
	CD_PESSOA_SOLICITANTE,
	CD_CGC_TRANSPORTADOR,
	IE_FRETE, VL_FRETE,
	PR_MULTA_ATRASO,
	PR_DESCONTO,
	PR_DESC_PGTO_ANTEC,
	PR_JUROS_NEGOCIADO,
	NULL,
	DS_PESSOA_CONTATO,
	DS_OBSERVACAO,
	NULL,
	CD_LOCAL_ENTREGA,
	DT_ENTREGA,
	NULL,
	NULL,
	NULL,
	NULL,
	IE_AVISO_CHEGADA,
	NULL,
	CD_PESSOA_FISICA,
	NULL,
	IE_EMITE_OBS,
	IE_URGENTE,
	NR_SEQ_INTERNO,
	NR_ATENDIMENTO, 
	NULL,
	IE_SOMENTE_PAGTO,
	NULL,
	VL_DESPESA_ACESSORIA,
	CD_SETOR_ATENDIMENTO,
	NR_SEQ_SUBGRUPO_COMPRA,
	PR_DESC_FINANCEIRO,
	NULL,
	NULL,
	NULL,
	NR_SEQ_FORMA_PAGTO,
	NR_DOCUMENTO_EXTERNO,
	VL_DESCONTO,
	NULL,
	NULL,
	IE_TIPO_ORDEM,
	NULL,
	NULL,
	NULL,
	NULL,
	NULL,
	NULL,
	NULL,
	NULL,
	NULL,
	NULL,
	NR_PROCESSO_INTERNO_W,
	NULL,
	NULL,
	NULL,
	NULL,
	DS_DADOS_IMPORTACAO,
	NULL,
	CD_CENTRO_CUSTO,
	IE_ORIGEM_IMP,
	NULL,
	NULL,
	NULL,
	NULL,
	NULL,
	NULL,
	CD_LOCAL_TRANSF,
	NULL,
	DT_ATUALIZACAO_NREC,
	NM_USUARIO_NREC,
	NULL,
	NULL,
	VL_DESPESA_DOC
FROM	ordem_compra
WHERE	nr_ordem_compra = nr_ordem_compra_p;

OPEN c01;
LOOP
FETCH c01 INTO
	nr_item_oci_w;
EXIT WHEN NOT FOUND; /* apply on c01 */



INSERT INTO ordem_compra_item(
	NR_ORDEM_COMPRA,
	NR_ITEM_OCI,
	CD_MATERIAL,
	CD_UNIDADE_MEDIDA_COMPRA,
	VL_UNITARIO_MATERIAL,
	QT_MATERIAL,
	DT_ATUALIZACAO,
	NM_USUARIO,
	IE_SITUACAO,
	CD_PESSOA_SOLICITANTE,
	QT_MATERIAL_ENTREGUE,
	PR_DESCONTOS,
	CD_LOCAL_ESTOQUE,
	DS_MATERIAL_DIRETO,
	DS_OBSERVACAO,
	CD_MOTIVO_ALTERACAO,
	NR_COT_COMPRA,
	NR_ITEM_COT_COMPRA,
	DS_MARCA,
	VL_ITEM_LIQUIDO,
	NR_SEQ_APROVACAO,
	DT_APROVACAO,
	CD_CENTRO_CUSTO,
	CD_CONTA_CONTABIL,
	NR_SOLIC_COMPRA,
	NR_ITEM_SOLIC_COMPRA,
	QT_CONV_UNID_FORNEC,
	IE_GERACAO_SOLIC,
	NR_SEQ_PROJ_REC,
	PR_DESC_FINANC,
	NR_SEQ_LIC_ITEM,
	NR_SEQ_CONTA_FINANC,
	QT_ORIGINAL,
	DT_VALIDADE,
	NR_SEQ_MARCA,
	DT_REPROVACAO,
	NR_SEQ_ORDEM_SERV,
	VL_ULTIMA_COMPRA,
	VL_DIF_ULTIMA_COMPRA,
	PR_DIF_ULTIMA_COMPRA,
	NR_SEQ_UNIDADE_ADIC,
	NR_SEQ_CRITERIO_RATEIO,
	NR_SERIE_MATERIAL,
	NR_SOLIC_COMPRA_CANCEL,
	VL_DESCONTO,
	NR_SEQ_LOTE_FORNEC,
	NR_SEQ_PROJ_GPI,
	NR_SEQ_ETAPA_GPI,
	NR_SEQ_CONTA_GPI,
	DT_APROVACAO_ORIG,
	DT_REPROVACAO_ORIG,
	NR_CONTRATO,
	DT_INICIO_GARANTIA,
	DT_FIM_GARANTIA,
	NR_ID_INTEGRACAO,
	NR_SEQ_REG_LIC_ITEM,
	NR_SEQ_CONTA_BCO,
	NR_SEQ_PRESCR_ITEM,
	NR_EMPENHO,
	DT_EMPENHO,
	NR_ORDEM_AGRUP,
	NR_SEQ_ORC_ITEM_GPI,
	VL_UNIT_MAT_ORIGINAL,
	NR_ATENDIMENTO,
	QT_DIAS_GARANTIA,
	vl_total_item,
	CD_PACIENTE_ORDEM_COMPRA)
SELECT	nr_ordem_compra_w,
	nr_item_oci_w,
	CD_MATERIAL,
	CD_UNIDADE_MEDIDA_COMPRA,
	VL_UNITARIO_MATERIAL,
	QT_MATERIAL,
	clock_timestamp(),
	NM_USUARIO_p,
	IE_SITUACAO,
	CD_PESSOA_SOLICITANTE,
	NULL,
	PR_DESCONTOS,
	CD_LOCAL_ESTOQUE,
	DS_MATERIAL_DIRETO,
	DS_OBSERVACAO,
	NULL,
	NULL,
	NULL,
	DS_MARCA,
	VL_ITEM_LIQUIDO,
	NULL,
	NULL,
	CD_CENTRO_CUSTO,
	CD_CONTA_CONTABIL,
	NULL,
	NULL,
	QT_CONV_UNID_FORNEC,
	IE_GERACAO_SOLIC,
	NR_SEQ_PROJ_REC,
	PR_DESC_FINANC,
	NULL,
	NR_SEQ_CONTA_FINANC,
	QT_MATERIAL,
	DT_VALIDADE,
	NR_SEQ_MARCA,
	NULL,
	NULL,
	VL_ULTIMA_COMPRA,
	VL_DIF_ULTIMA_COMPRA,
	PR_DIF_ULTIMA_COMPRA,
	NR_SEQ_UNIDADE_ADIC,
	NR_SEQ_CRITERIO_RATEIO,
	NR_SERIE_MATERIAL,
	NULL,
	VL_DESCONTO,
	NULL,
	NULL,
	NULL,
	NULL,
	NULL,
	NULL,
	NULL,
	DT_INICIO_GARANTIA,
	DT_FIM_GARANTIA,
	NULL,
	NULL,
	NULL,
	NULL,
	NR_EMPENHO,
	DT_EMPENHO,
	NULL,
	NULL,
	VL_UNIT_MAT_ORIGINAL,
	NULL,
	QT_DIAS_GARANTIA,
	round((qt_material * vl_unitario_material)::numeric,4),
	CD_PACIENTE_ORDEM_COMPRA
FROM	ordem_compra_item
WHERE	nr_ordem_compra = nr_ordem_compra_p
AND		nr_item_oci = nr_item_oci_w;


INSERT INTO ordem_compra_item_entrega(
				NR_ORDEM_COMPRA,
				NR_ITEM_OCI,
				DT_PREVISTA_ENTREGA,
				DT_REAL_ENTREGA,
				QT_PREVISTA_ENTREGA,
				QT_REAL_ENTREGA,
				DT_ATUALIZACAO,
				NM_USUARIO,
				DS_OBSERVACAO,
				DT_CANCELAMENTO,
				NR_SEQUENCIA,
				IE_STATUS_EXPORTAR,
				DT_ENTREGA_ORIGINAL,
				DT_ENTREGA_LIMITE,
				DT_BAIXA,
				DT_CONFIRMA_ENTREGA,
				HR_PREVISTA_ENTREGA,
				DT_INICIO_PENDENCIA,
				DT_FIM_PENDENCIA,
				NR_SEQ_MOTIVO_PEND,
				NM_USUARIO_INI_PEND,
				NM_USUARIO_FIM_PEND)
			SELECT nr_ordem_compra_w,
				nr_item_oci_w,
				DT_PREVISTA_ENTREGA,
				NULL,
				QT_PREVISTA_ENTREGA,
				NULL,
				clock_timestamp(),
				NM_USUARIO_p,
				DS_OBSERVACAO,
				NULL,
				nextval('ordem_compra_item_entrega_seq'),
				IE_STATUS_EXPORTAR,
				DT_ENTREGA_ORIGINAL,
				DT_ENTREGA_LIMITE,
				NULL,
				DT_CONFIRMA_ENTREGA,
				HR_PREVISTA_ENTREGA,
				DT_INICIO_PENDENCIA,
				DT_FIM_PENDENCIA,
				NULL,
				NULL,
				NULL
FROM	ordem_compra_item_entrega
WHERE	nr_ordem_compra = nr_ordem_compra_p
and	nr_item_oci = nr_item_oci_w;

insert into ordem_compra_item_rateio(
	nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_ordem_compra,
	nr_item_oci,
	cd_centro_custo,
	cd_conta_contabil,
	cd_conta_financ,
	vl_rateio,
	vl_frete,
	vl_desconto,
	vl_seguro,
	vl_despesa_acessoria,
	nr_seq_criterio_rateio,
	ie_situacao,
	qt_rateio)
SELECT  nextval('ordem_compra_item_rateio_seq'),
	clock_timestamp(),
	NM_USUARIO_p,
	clock_timestamp(),
	NM_USUARIO_p,
	nr_ordem_compra_w,
	nr_item_oci_w,
	cd_centro_custo,
	cd_conta_contabil,
	cd_conta_financ,
	vl_rateio,
	vl_frete,
	vl_desconto,
	vl_seguro,
	vl_despesa_acessoria,
	nr_seq_criterio_rateio,
	ie_situacao,
	qt_rateio
from	ordem_compra_item_rateio
where	nr_ordem_compra = nr_ordem_compra_p
and	nr_item_oci = nr_item_oci_w;	

END LOOP;
CLOSE c01;


nr_ordem_nova_p	:= nr_ordem_compra_w;

COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duplicar_ordem_compra_it_ent ( nr_ordem_compra_p bigint, nm_usuario_p text, nr_ordem_nova_p INOUT bigint) FROM PUBLIC;

