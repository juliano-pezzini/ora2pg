-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE substituir_material_ap_lote ( cd_material_atual_p bigint, cd_material_subst_p bigint, nr_seq_lote_p bigint, qt_material_subst_p bigint, nr_sequencia_p bigint, nm_usuario_p text, nr_seq_lote_fornec_p bigint, nr_id_p bigint, nr_seq_material_p bigint) AS $body$
DECLARE


qt_material_multi_w	double precision;
qt_existe_w		bigint;
qt_itens_lote_w		bigint;
qt_dispensar_w		double precision;


BEGIN
select	count(*)
into STRICT	qt_existe_w
from	regra_mat_subst_atend
where	cd_material = cd_material_atual_p
and	(qt_material IS NOT NULL AND qt_material::text <> '');

if (coalesce(qt_existe_w,0) > 0) then
	select (qt_material_subst_p * b.qt_material)
	into STRICT	qt_material_multi_w
	from	regra_mat_subst_atend b
	where	b.cd_material = cd_material_atual_p
	and	nr_sequencia = nr_sequencia_p;

	if (coalesce(qt_material_multi_w,0) <> 0) then
		select	count(a.nr_sequencia)
		into STRICT	qt_itens_lote_w
		from	ap_lote_item a
		where	a.nr_seq_lote = nr_seq_lote_p
		and	a.cd_material = cd_material_atual_p
		and	exists (	SELECT	1
					from	prescr_mat_hor x
					where	x.nr_sequencia = a.nr_seq_mat_hor
					and	x.nr_seq_material = nr_seq_material_p);

		update	ap_lote_item a
		set	a.qt_dispensar = (qt_material_multi_w / qt_itens_lote_w)
		where	a.nr_seq_lote = nr_seq_lote_p
		and	a.cd_material = cd_material_atual_p
		and	exists (	SELECT	1
					from	prescr_mat_hor x
					where	x.nr_sequencia = a.nr_seq_mat_hor
					and	x.nr_seq_material = nr_seq_material_p);
	end if;
end if;

select	coalesce(sum(qt_dispensar),0)
into STRICT	qt_dispensar_w
from	ap_lote_item a
where	a.nr_seq_lote = nr_seq_lote_p
and	a.cd_material = cd_material_atual_p
and	exists (SELECT	1
		from	prescr_mat_hor x
		where	x.nr_sequencia = a.nr_seq_mat_hor
		and	x.nr_seq_material = nr_seq_material_p);


update	ap_lote_item a
set	a.cd_material = cd_material_subst_p,
	a.cd_material_original = cd_material_atual_p
where	a.nr_seq_lote = nr_seq_lote_p
and	a.cd_material = cd_material_atual_p
and	exists (	SELECT	1
			from	prescr_mat_hor x
			where	x.nr_sequencia = a.nr_seq_mat_hor
			and	x.nr_seq_material = nr_seq_material_p);

if (nr_id_p > 0) then

	update	material_wbarras
	set	cd_material = cd_material_subst_p,
		ds_material = obter_desc_material(cd_material_subst_p),
		qt_material = qt_dispensar_w,
		sl_material = qt_dispensar_w
	where	cd_material = cd_material_atual_p
	and	coalesce(nr_seq_lote_fornec_p,0) = coalesce(fn_fornecedor,0)
	and	nr_id = nr_id_p
	and	nr_seq_material = nr_seq_material_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE substituir_material_ap_lote ( cd_material_atual_p bigint, cd_material_subst_p bigint, nr_seq_lote_p bigint, qt_material_subst_p bigint, nr_sequencia_p bigint, nm_usuario_p text, nr_seq_lote_fornec_p bigint, nr_id_p bigint, nr_seq_material_p bigint) FROM PUBLIC;

