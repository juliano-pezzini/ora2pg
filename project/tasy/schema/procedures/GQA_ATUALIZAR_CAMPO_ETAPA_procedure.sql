-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gqa_atualizar_campo_etapa ( nr_seq_etapa_p gqa_protocolo_etapa_pac.nr_sequencia%type, valor_p bigint ) AS $body$
DECLARE


nr_atendimento_w          gqa_protocolo_pac.nr_atendimento%type;
nm_usuario_w              gqa_protocolo_pac.nm_usuario%type;
ie_tipo_acao_w            gqa_acao.ie_tipo_acao%type;

nr_seq_prot_pac_w         gqa_protocolo_etapa_pac.nr_seq_prot_pac%type;
nr_seq_acao_w             gqa_protocolo_etapa_pac.nr_seq_acao%type;
cd_doenca_w               gqa_acao.cd_doenca%type;
nr_seq_diag_w             DIAGNOSTICO_DOENCA.NR_SEQ_INTERNO%type := null;


BEGIN
  select obter_usuario_ativo into STRICT nm_usuario_w;

  select nr_seq_acao, nr_seq_prot_pac
  into STRICT nr_seq_acao_w, nr_seq_prot_pac_w
  from gqa_protocolo_etapa_pac where nr_sequencia = nr_seq_etapa_p;

  select ie_tipo_acao, cd_doenca
  into STRICT ie_tipo_acao_w, cd_doenca_w 
  from gqa_acao where nr_sequencia = nr_seq_acao_w  LIMIT 1;

  if (ie_tipo_acao_w = 'ES') then
    update gqa_protocolo_etapa_pac set nr_seq_score_flex_ii = valor_p, dt_atualizacao = clock_timestamp(), nm_usuario = nm_usuario_w where nr_sequencia = nr_seq_etapa_p;
  elsif (ie_tipo_acao_w = 'AV') then
    update gqa_protocolo_etapa_pac set nr_seq_avaliacao = valor_p, dt_atualizacao = clock_timestamp(), nm_usuario = nm_usuario_w where nr_sequencia = nr_seq_etapa_p;
  elsif (ie_tipo_acao_w = 'NC') then
    update gqa_protocolo_etapa_pac set nr_seq_evolucao = valor_p, dt_atualizacao = clock_timestamp(), nm_usuario = nm_usuario_w where nr_sequencia = nr_seq_etapa_p;
  elsif (ie_tipo_acao_w = 'DL') then   
    select nr_atendimento 
    into STRICT nr_atendimento_w 
    from gqa_protocolo_pac where nr_sequencia = nr_seq_prot_pac_w;

    begin
        select max(a.NR_SEQ_INTERNO)
        into STRICT nr_seq_diag_w
        from DIAGNOSTICO_DOENCA a 
        where a.NM_USUARIO = nm_usuario_w
          and a.NR_ATENDIMENTO = nr_atendimento_w
          and a.CD_DOENCA = cd_doenca_w;
    exception when no_data_found then
      null;
    end;

    update gqa_protocolo_etapa_pac
    set NR_SEQ_DIAGNOSTICO = nr_seq_diag_w, dt_atualizacao = clock_timestamp(), nm_usuario = nm_usuario_w 
    where nr_sequencia = nr_seq_etapa_p;
  elsif (ie_tipo_acao_w = 'PP') then
    update gqa_protocolo_etapa_pac set nr_prescricao = valor_p, dt_atualizacao = clock_timestamp(), nm_usuario = nm_usuario_w where nr_sequencia = nr_seq_etapa_p;
  end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gqa_atualizar_campo_etapa ( nr_seq_etapa_p gqa_protocolo_etapa_pac.nr_sequencia%type, valor_p bigint ) FROM PUBLIC;

