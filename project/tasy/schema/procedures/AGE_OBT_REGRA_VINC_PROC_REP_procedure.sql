-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE age_obt_regra_vinc_proc_rep ( dt_agenda_p timestamp, cd_pessoa_fisica_p text, cd_estabelecimento_p bigint, nr_seq_proc_interno_p bigint, nm_usuario_p text, nr_seq_agenda_p INOUT bigint) AS $body$
DECLARE




nr_seq_proc_interno_w	bigint;
ie_agenda_servico_w	varchar(1);
ie_atualizar_w		varchar(1);
nr_seq_agenda_w		agenda_consulta.nr_sequencia%type;
ie_vinc_seq_agend_w	varchar(1);
					
C01 CURSOR FOR
	SELECT	distinct
		a.nr_seq_proc_interno,		
		coalesce(a.ie_agenda_servico,'N')
	from	ageint_regra_prescr_proc a
	where	a.nr_seq_proc_interno	= nr_seq_proc_interno_p
	order by 1;			
	
C02 CURSOR FOR
	SELECT	a.nr_sequencia
	from	agenda_consulta a,
		agenda b
	where	a.cd_agenda		= b.cd_agenda
	and	b.ie_situacao		= 'A'
	and	b.cd_tipo_agenda	= 5
	and	b.cd_estabelecimento	= cd_estabelecimento_p
	and	a.dt_agenda 		between trunc(dt_agenda_p) and trunc(dt_agenda_p) + 86399/86400
	and	a.cd_pessoa_fisica	= cd_pessoa_fisica_p
	and	a.nr_seq_proc_interno	= nr_seq_proc_interno_w
	order by 1;	
	

BEGIN

ie_vinc_seq_agend_w := Obter_Param_Usuario(924, 1020, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_vinc_seq_agend_w);

if (dt_agenda_p IS NOT NULL AND dt_agenda_p::text <> '') and (cd_pessoa_fisica_p IS NOT NULL AND cd_pessoa_fisica_p::text <> '') and (nr_seq_proc_interno_p IS NOT NULL AND nr_seq_proc_interno_p::text <> '') and (ie_vinc_seq_agend_w = 'S')then
	open C01;
	loop
	fetch C01 into	
		nr_seq_proc_interno_w,
		ie_atualizar_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin
		if (nr_seq_proc_interno_w IS NOT NULL AND nr_seq_proc_interno_w::text <> '') and (ie_atualizar_w = 'S')then
			open C02;
			loop
			fetch C02 into	
				nr_seq_agenda_w;
			EXIT WHEN NOT FOUND; /* apply on C02 */
				begin				
				nr_seq_agenda_p	:= nr_seq_agenda_w;
				end;
			end loop;
			close C02;		
		end if;
		
		end;
	end loop;
	close C01;

end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE age_obt_regra_vinc_proc_rep ( dt_agenda_p timestamp, cd_pessoa_fisica_p text, cd_estabelecimento_p bigint, nr_seq_proc_interno_p bigint, nm_usuario_p text, nr_seq_agenda_p INOUT bigint) FROM PUBLIC;

