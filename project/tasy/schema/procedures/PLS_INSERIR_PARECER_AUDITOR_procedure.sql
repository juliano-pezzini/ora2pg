-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_inserir_parecer_auditor ( nr_seq_item_p bigint, nr_seq_motivo_lib_p bigint, ds_parecer_p text, ie_tipo_historico_p text, ie_status_analise_p text, qt_ajuste_p bigint, vl_item_p text, nm_usuario_p text) AS $body$
DECLARE


/*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Finalidade:   Inserir o parecer do auditor,
* Rotina utilizada no Portal web, na análise realizada pelo estipulante.
----------------------------------------------------------------------------------------------------------------------------------------------------
Locais de chamada direta:
[  ]  Objetos do dicionário [ x ] Tasy (Delphi/Java) [ x ] Portal [  ] Relatórios [ ] Outros:
 ----------------------------------------------------------------------------------------------------------------------------------------------------
Pontos de atenção:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++*/ds_observacao_w			pls_requisicao_historico.ds_historico%type;
ie_utiliza_nivel_w		pls_param_analise_aut.ie_utiliza_nivel%type;
nr_seq_grupo_w			pls_grupo_auditor.nr_sequencia%type;
vl_item_w			pls_auditoria_item.vl_item%type;
qt_ajuste_w			pls_auditoria_item.qt_ajuste%type;
qt_original_w			pls_auditoria_item.qt_original%type;
cd_procedimento_w		procedimento.cd_procedimento%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;
nr_seq_segurado_w		pls_segurado.nr_sequencia%type;
nr_seq_requisicao_w		pls_requisicao.nr_sequencia%type;
nr_seq_auditoria_w		pls_auditoria.nr_sequencia%type;
nr_seq_guia_w			pls_guia_plano.nr_sequencia%type;
nr_seq_execucao_w		pls_execucao_requisicao.nr_sequencia%type;
ds_parecer_alterado_w		varchar(4000);
ds_item_w			varchar(255);
cd_nr_material_w		bigint;
ie_acao_w			varchar(1);
ie_alterou_qtde_w		varchar(1)	:= 'N';
ie_alterou_valor_w		varchar(1)	:= 'N';
vl_item_param_w       		pls_auditoria_item.vl_item%type;
nr_seq_motivo_glosa_w		tiss_motivo_glosa.nr_sequencia%type;
nr_seq_mat_origem_w		pls_auditoria_item.nr_seq_mat_origem%type;
nr_seq_proc_origem_w		pls_auditoria_item.nr_seq_proc_origem%type;
qt_glosa_w			bigint	:= 0;
ie_glosar_item_guia_w		pls_membro_grupo_aud.ie_glosar_item_guia%type;
ds_separador_w			varchar(10) := chr(10) || chr(10);


BEGIN
select	b.nr_seq_segurado,
	b.nr_seq_requisicao,
	b.nr_seq_guia,
	b.nr_seq_execucao,
	b.nr_sequencia,
	a.cd_procedimento,
	coalesce(substr(pls_obter_seq_codigo_material(nr_seq_material, ''), 1, 10), a.nr_seq_material),
	b.cd_estabelecimento,
	a.qt_ajuste,
	substr(coalesce(Obter_Descricao_Procedimento(cd_procedimento,ie_origem_proced),pls_obter_desc_material(nr_seq_material)),1,255),
	a.qt_original,
	a.vl_item,
	a.nr_seq_mat_origem,
	a.nr_seq_proc_origem
into STRICT	nr_seq_segurado_w,
	nr_seq_requisicao_w,
	nr_seq_guia_w,
	nr_seq_execucao_w,
	nr_seq_auditoria_w,
	cd_procedimento_w,
	cd_nr_material_w,
	cd_estabelecimento_w,
	qt_ajuste_w,
	ds_item_w,
	qt_original_w,
	vl_item_w,
	nr_seq_mat_origem_w,
	nr_seq_proc_origem_w
from	pls_auditoria		b,
	pls_auditoria_item 	a
where	a.nr_seq_auditoria 	= b.nr_sequencia
and	a.nr_sequencia 		= nr_seq_item_p;

if (coalesce(nr_seq_execucao_w, 0) > 0) then
	select	nr_seq_requisicao
	into STRICT	nr_seq_requisicao_w
	from	pls_execucao_requisicao
	where	nr_sequencia = nr_seq_execucao_w;
end if;

select	nr_seq_grupo
into STRICT	nr_seq_grupo_w
from	pls_auditoria_grupo
where	nr_sequencia	= pls_obter_grupo_analise_atual(nr_seq_auditoria_w);

ds_parecer_alterado_w := pls_gerar_analise_macro(substr(ds_parecer_p, 1, 4000), nr_seq_item_p, nm_usuario_p, ds_parecer_alterado_w);

if (qt_ajuste_w <> coalesce(qt_ajuste_p, qt_ajuste_w)) then
	ds_observacao_w	:= substr('O auditor ' || nm_usuario_p ||' alterou a quantidade autorizada do item ' || coalesce(cd_procedimento_w,cd_nr_material_w) || ' - ' ||
					ds_item_w || ' de ' || qt_ajuste_w || ' para ' || qt_ajuste_p || ' ' || ds_parecer_alterado_w,1,4000);

	ie_alterou_qtde_w	:= 'S';
end if;

begin
	vl_item_param_w := (vl_item_p)::numeric;
exception
when others then
	vl_item_param_w := (replace(vl_item_p, ',', '.'))::numeric;
end;

if (vl_item_w <> coalesce(vl_item_param_w, vl_item_w)) then

	if (ie_alterou_qtde_w = 'S') then
		ds_observacao_w	:= ds_observacao_w || '<br><br>';
	end if;

	ds_observacao_w	:= ds_observacao_w || substr('O auditor ' || nm_usuario_p ||' alterou o valor do item ' || coalesce(cd_procedimento_w,cd_nr_material_w) || ' - ' ||
					ds_item_w || ' de ' || vl_item_w || ' para ' || vl_item_param_w || ' ' || ds_parecer_alterado_w,1,4000);

	ie_alterou_valor_w	:= 'S';
end if;

if (ie_alterou_qtde_w = 'N') and (ie_alterou_valor_w = 'N') then
	ds_observacao_w	:= coalesce(cd_procedimento_w, cd_nr_material_w) || ' - ' || substr(ds_parecer_alterado_w, 1, 3980);
end if;

if (coalesce(nr_seq_requisicao_w, 0) > 0) or (coalesce(nr_seq_execucao_w, 0) > 0) then
	insert into pls_requisicao_historico(nr_sequencia,
		nr_seq_requisicao,
		ie_tipo_historico,
		ds_historico,
		dt_atualizacao,
		nm_usuario,
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		nr_seq_segurado,
		dt_historico,
		ie_origem_historico,
		nr_seq_item,
		ie_status_analise,
		nr_seq_grupo,
		nr_seq_motivo_lib,
		nr_seq_execucao)
	values (nextval('pls_requisicao_historico_seq'),
		nr_seq_requisicao_w,
		ie_tipo_historico_p,
		ds_observacao_w,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		nr_seq_segurado_w,
		clock_timestamp(),
		'M',
		nr_seq_item_p,
		ie_status_analise_p,
		nr_seq_grupo_w,
		CASE WHEN nr_seq_motivo_lib_p=0 THEN null  ELSE nr_seq_motivo_lib_p END ,
		nr_seq_execucao_w);
elsif (coalesce(nr_seq_guia_w, 0) > 0) then
	insert into pls_guia_plano_historico(nr_sequencia,
		nr_seq_guia,
		ie_tipo_log,
		dt_historico,
		dt_atualizacao,
		nm_usuario,
		ds_observacao,
		ie_origem_historico,
		ie_tipo_historico,
		nr_seq_item,
		ie_status_analise,
		nr_seq_grupo,
		nr_seq_motivo_lib)
	values (nextval('pls_guia_plano_historico_seq'),
		nr_seq_guia_w,
		null,
		clock_timestamp(),
		clock_timestamp(),
		nm_usuario_p,
		ds_observacao_w,
		'M',
		ie_tipo_historico_p,
		nr_seq_item_p,
		ie_status_analise_p,
		nr_seq_grupo_w,
		CASE WHEN nr_seq_motivo_lib_p=0 THEN null  ELSE nr_seq_motivo_lib_p END );
end if;

begin
select	coalesce(a.ie_glosar_item_guia,'N')
into STRICT	ie_glosar_item_guia_w
from	pls_membro_grupo_aud a,
	pls_auditoria_grupo b
where	a.nm_usuario_exec	= nm_usuario_p
and	a.nr_seq_grupo		= b.nr_seq_grupo
and	b.nr_sequencia		= pls_obter_grupo_analise_atual(nr_seq_auditoria_w);
exception
when others then
	ie_glosar_item_guia_w	:= null;
end;

if (ie_glosar_item_guia_w = 'N') and (ie_status_analise_p = 'N') then
	select	max(nr_seq_motivo_glosa)
	into STRICT	nr_seq_motivo_glosa_w
	from	pls_motivo_lib_analise_aut
	where	nr_sequencia	= nr_seq_motivo_lib_p;

	if (nr_seq_motivo_glosa_w IS NOT NULL AND nr_seq_motivo_glosa_w::text <> '') then
		if (nr_seq_guia_w IS NOT NULL AND nr_seq_guia_w::text <> '') then
			select	sum(qt_glosa)
			into STRICT	qt_glosa_w
			from (	SELECT	count(1) qt_glosa
					from	pls_guia_glosa	a
					where	nr_seq_guia_proc 	= nr_seq_proc_origem_w
					and	coalesce(nr_seq_guia::text, '') = ''
					and	coalesce(nr_seq_guia_mat::text, '') = ''
					and	nr_seq_motivo_glosa 	= nr_seq_motivo_glosa_w
					
union	all

					PERFORM	count(1) qt_glosa
					from	pls_guia_glosa	a
					where	nr_seq_guia_mat		= nr_seq_mat_origem_w
					and	coalesce(nr_seq_guia::text, '') = ''
					and	coalesce(nr_seq_guia_proc::text, '') = ''
					and	nr_seq_motivo_glosa 	= nr_seq_motivo_glosa_w) alias9;
		elsif (nr_seq_execucao_w IS NOT NULL AND nr_seq_execucao_w::text <> '') then
			nr_seq_requisicao_w	:= null;

			select	sum(qt_glosa)
			into STRICT	qt_glosa_w
			from (	SELECT	count(1) qt_glosa
					from	pls_requisicao_glosa
					where	nr_seq_exec_proc	= nr_seq_proc_origem_w
					and	coalesce(nr_seq_exec_mat::text, '') = ''
					and	nr_seq_execucao		= nr_seq_execucao_w
					and	nr_seq_motivo_glosa 	= nr_seq_motivo_glosa_w
					
union	all

					PERFORM	count(1) qt_glosa
					from	pls_requisicao_glosa
					where	nr_seq_exec_mat		= nr_seq_mat_origem_w
					and	coalesce(nr_seq_exec_proc::text, '') = ''
					and	nr_seq_execucao		= nr_seq_execucao_w
					and	nr_seq_motivo_glosa 	= nr_seq_motivo_glosa_w) alias5;
		elsif (nr_seq_requisicao_w IS NOT NULL AND nr_seq_requisicao_w::text <> '') then
			select	sum(qt_glosa)
			into STRICT	qt_glosa_w
			from (	SELECT	count(1) qt_glosa
					from	pls_requisicao_glosa
					where	nr_seq_req_proc		= nr_seq_proc_origem_w
					and	coalesce(nr_seq_requisicao::text, '') = ''
					and	coalesce(nr_seq_req_mat::text, '') = ''
					and	nr_seq_motivo_glosa 	= nr_seq_motivo_glosa_w
					
union	all

					PERFORM	count(1) qt_glosa
					from	pls_requisicao_glosa
					where	nr_seq_req_mat		= nr_seq_mat_origem_w
					and	coalesce(nr_seq_requisicao::text, '') = ''
					and	coalesce(nr_seq_req_proc::text, '') = ''
					and	nr_seq_motivo_glosa 	= nr_seq_motivo_glosa_w) alias8;
		end if;

		if (qt_glosa_w = 0) then
			CALL pls_inserir_motivo_glosa_aud(	nr_seq_guia_w, nr_seq_requisicao_w, nr_seq_execucao_w,
							nr_seq_proc_origem_w, nr_seq_mat_origem_w, nr_seq_proc_origem_w,
							nr_seq_mat_origem_w, nr_seq_proc_origem_w, nr_seq_mat_origem_w,
							nr_seq_motivo_glosa_w, nm_usuario_p);
		end if;
	end if;
end if;

ie_utiliza_nivel_w	:= pls_obter_se_uti_nivel_lib_aut(cd_estabelecimento_w);

if (ie_utiliza_nivel_w = 'S') then
	select	CASE WHEN ie_status_analise_p='A' THEN  'L'  ELSE ie_status_analise_p END
	into STRICT	ie_acao_w
	;

	CALL pls_atualizar_status_item_aud(	nr_seq_item_p,
					nr_seq_grupo_w,
					ie_acao_w,
					'I',
					nm_usuario_p);
else
	update	pls_auditoria_item
	set	ie_status	= ie_status_analise_p,
		dt_atualizacao	= clock_timestamp(),
		nm_usuario	= nm_usuario_p,
		qt_ajuste	= CASE WHEN qt_ajuste_p = NULL THEN  qt_ajuste  ELSE qt_ajuste_p END ,
		vl_item		= CASE WHEN vl_item_param_w = NULL THEN  vl_item  ELSE vl_item_param_w END
	where	nr_sequencia	= nr_seq_item_p;
end if;

update	pls_auditoria_item
set	qt_ajuste	= CASE WHEN qt_ajuste_p = NULL THEN  qt_ajuste  ELSE qt_ajuste_p END ,
	vl_item		= CASE WHEN vl_item_param_w = NULL THEN  vl_item  ELSE vl_item_param_w END
where	nr_sequencia	= nr_seq_item_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_inserir_parecer_auditor ( nr_seq_item_p bigint, nr_seq_motivo_lib_p bigint, ds_parecer_p text, ie_tipo_historico_p text, ie_status_analise_p text, qt_ajuste_p bigint, vl_item_p text, nm_usuario_p text) FROM PUBLIC;

