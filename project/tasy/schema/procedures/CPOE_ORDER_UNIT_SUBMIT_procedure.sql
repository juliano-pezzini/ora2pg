-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';



CREATE TYPE order_unit AS (qt_items bigint);


CREATE OR REPLACE PROCEDURE cpoe_order_unit_submit (nr_atendimento_p bigint, itens_liberar_p text, nm_usuario_p text, si_release_p INOUT text) AS $body$
DECLARE

nr_seq_item_w           cpoe_material.nr_sequencia%type;
ds_remaining_list_w     varchar(2000);
ie_tipo_item_w          varchar(255);
item_w                  varchar(255);
nr_order_unit_w         cpoe_order_unit.nr_order_unit%type;
nr_seq_cpoe_order_unit_w bigint;
dt_liberacao_w          timestamp;
i                       varchar(10);
qt_items_w      bigint;
type vector_order_unit is table of order_unit index by varchar(10);
vector_order_unit_w     vector_order_unit;


BEGIN
ds_remaining_list_w := itens_liberar_p;
while(ds_remaining_list_w IS NOT NULL AND ds_remaining_list_w::text <> '') loop
    -- R,12;M,12345;D,1233;M,2312;
    if (position(';' in ds_remaining_list_w) = 0) and (ds_remaining_list_w IS NOT NULL AND ds_remaining_list_w::text <> '') then
      ds_remaining_list_w  := ds_remaining_list_w||';';
    end if;
    item_w := substr(ds_remaining_list_w, 1, position(';' in ds_remaining_list_w) - 1);
    ie_tipo_item_w := substr(item_w, 1, position(',' in item_w) - 1);
    nr_seq_item_w       := (substr(item_w, position(',' in item_w) + 1, length(item_w)))::numeric;
    ds_remaining_list_w := substr(ds_remaining_list_w, position(';' in ds_remaining_list_w) + 1, length(ds_remaining_list_w));

    --tipo do item: ie_tipo_item_w
    --sequencia do item: nr_seq_item_w
    if (ie_tipo_item_w in ('MA','M')) then
        begin
        select  nr_seq_cpoe_order_unit,
                dt_liberacao
        into STRICT    nr_seq_cpoe_order_unit_w,
                dt_liberacao_w
        from    cpoe_material
        where   nr_atendimento  = nr_atendimento_p
        and     nr_sequencia    = nr_seq_item_w;
        exception
            when others then
                nr_seq_cpoe_order_unit_w    := null;
                dt_liberacao_w  := null;
        end;
    elsif (ie_tipo_item_w = 'N') then
        begin
        select  nr_seq_cpoe_order_unit,
                dt_liberacao
        into STRICT    nr_seq_cpoe_order_unit_w,
                dt_liberacao_w
        from    cpoe_dieta
        where   nr_atendimento  = nr_atendimento_p
        and     nr_sequencia    = nr_seq_item_w;
        exception
            when others then
                nr_seq_cpoe_order_unit_w    := null;
                dt_liberacao_w  := null;
        end;
    elsif (ie_tipo_item_w = 'P') then
        begin
        select  nr_seq_cpoe_order_unit,
                dt_liberacao
        into STRICT    nr_seq_cpoe_order_unit_w,
                dt_liberacao_w
        from    cpoe_procedimento
        where   nr_atendimento  = nr_atendimento_p
        and     nr_sequencia    = nr_seq_item_w;
        exception
            when others then
                nr_seq_cpoe_order_unit_w    :=  null;
                dt_liberacao_w  := null;
        end;
    elsif (ie_tipo_item_w = 'G') then
        begin
        select  nr_seq_cpoe_order_unit,
                dt_liberacao
        into STRICT    nr_seq_cpoe_order_unit_w,
                dt_liberacao_w
        from    cpoe_gasoterapia
        where   nr_atendimento  = nr_atendimento_p
        and     nr_sequencia    = nr_seq_item_w;
        exception
            when others then
                nr_seq_cpoe_order_unit_w    := null;
                dt_liberacao_w              := null;
        end;
    elsif (ie_tipo_item_w = 'R') then
        begin
        select  nr_seq_cpoe_order_unit,
                dt_liberacao
        into STRICT    nr_seq_cpoe_order_unit_w,
                dt_liberacao_w
        from    cpoe_recomendacao
        where   nr_atendimento  = nr_atendimento_p
        and     nr_sequencia    = nr_seq_item_w;
        exception
            when others then
                nr_seq_cpoe_order_unit_w    := null;
                dt_liberacao_w  := null;
        end;
    elsif (ie_tipo_item_w = 'H') then
        begin
        select  nr_seq_cpoe_order_unit,
                dt_liberacao
        into STRICT    nr_seq_cpoe_order_unit_w,
                dt_liberacao_w
        from    cpoe_hemoterapia
        where   nr_atendimento  = nr_atendimento_p
        and     nr_sequencia    = nr_seq_item_w;
        exception
            when others then
                nr_seq_cpoe_order_unit_w    := null;
                dt_liberacao_w  := null;
        end;
    elsif (ie_tipo_item_w in ('DI','DP')) then
        begin
        select  nr_seq_cpoe_order_unit,
                dt_liberacao
        into STRICT    nr_seq_cpoe_order_unit_w,
                dt_liberacao_w
        from    cpoe_dialise
        where   nr_atendimento  = nr_atendimento_p
        and     nr_sequencia    = nr_seq_item_w;
        exception
            when others then
                nr_seq_cpoe_order_unit_w    := null;
                dt_liberacao_w  := null;
        end;
    elsif (ie_tipo_item_w = 'AP') then
        begin
        select  nr_seq_cpoe_order_unit,
                dt_liberacao
        into STRICT    nr_seq_cpoe_order_unit_w,
                dt_liberacao_w
        from    cpoe_anatomia_patologica
        where   nr_atendimento  = nr_atendimento_p
        and     nr_sequencia    = nr_seq_item_w;
        exception
            when others then
                nr_seq_cpoe_order_unit_w    := null;
                dt_liberacao_w      := null;
        end;
    end if;

    if (nr_seq_cpoe_order_unit_w IS NOT NULL AND nr_seq_cpoe_order_unit_w::text <> '') then
        if (vector_order_unit_w.exists(nr_seq_cpoe_order_unit_w)) then
            vector_order_unit_w[nr_seq_cpoe_order_unit_w].qt_items  := vector_order_unit_w[nr_seq_cpoe_order_unit_w].qt_items + 1;
        else
            vector_order_unit_w[nr_seq_cpoe_order_unit_w].qt_items  := 1;
        end if;
    end if;
end loop;
i  := vector_order_unit_w.first;  -- Get first element of array 
si_release_p    := 'Y';
WHILE (i IS NOT NULL AND i::text <> '') LOOP

    nr_seq_cpoe_order_unit_w    := (i)::numeric;

    select  count(1)
    into STRICT    qt_items_w
    from    itens_cpoe_v
    where   nr_atendimento = nr_atendimento_p
    and     nr_seq_cpoe_order_unit = nr_seq_cpoe_order_unit_w;

    if (qt_items_w = vector_order_unit_w[i].qt_items) then
        update  cpoe_order_unit
        set     dt_liberacao = clock_timestamp()
        where   nr_sequencia = nr_seq_cpoe_order_unit_w;
       
       null;
    else
        begin
        select  nr_order_unit
        into STRICT    nr_order_unit_w
        from    cpoe_order_unit
        where   nr_sequencia = nr_seq_cpoe_order_unit_w;
        exception
            when others then
            nr_order_unit_w := null;
        end;
        si_release_p    := 'N';

    end if;
    i := vector_order_unit_w.NEXT(i);
END LOOP;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_order_unit_submit (nr_atendimento_p bigint, itens_liberar_p text, nm_usuario_p text, si_release_p INOUT text) FROM PUBLIC;

