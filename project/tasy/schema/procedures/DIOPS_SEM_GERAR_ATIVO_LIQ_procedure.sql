-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE diops_sem_gerar_ativo_liq ( nr_seq_operadora_p bigint, nr_seq_transacao_p bigint, nr_seq_periodo_p bigint, nm_usuario_p text) AS $body$
DECLARE

		 
/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ 
Finalidade: Gerar as informações de valores de do ativo liquido conforme as regras e o período 
------------------------------------------------------------------------------------------------------------------- 
Locais de chamada direta: 
[ X ] Objetos do dicionário [ ] Tasy (Delphi/Java) [ ] Portal [ ] Relatórios [ ] Outros: 
 ------------------------------------------------------------------------------------------------------------------ 
Pontos de atenção: 
------------------------------------------------------------------------------------------------------------------- 
Referências: 
	PLS_GERAR_DIOPS_COMPL_SEM 
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
 
 
ds_conta_w			varchar(255);
cd_conta_contabil_w		varchar(20);
ie_normal_encerramento_w	varchar(1);
vl_saldo_w			double precision	:= 0;
cd_estabelecimento_w		smallint;
dt_periodo_inicial_w		timestamp;
dt_periodo_final_w		timestamp;

C01 CURSOR FOR 
	SELECT	a.ds_conta, 
		b.cd_conta_contabil, 
		c.vl_saldo 
	from	ctb_mes_ref			d, 
		ctb_balancete_v			c, 
		diops_trans_conta_contab	b, 
		diops_trans_conta		a 
	where	a.nr_sequencia			= b.nr_seq_trans_conta 
	and	b.cd_conta_contabil		= c.cd_conta_contabil 
	and	c.nr_seq_mes_ref		= d.nr_sequencia 
	and	a.nr_seq_transacao		= nr_seq_transacao_p 
	and	c.ie_normal_encerramento	= ie_normal_encerramento_w --'N' 
	and	c.ie_tipo_conta			= 'A' 
	and	d.dt_referencia between dt_periodo_inicial_w and dt_periodo_final_w 
	and	a.cd_estabelecimento		= cd_estabelecimento_w 
	and	a.ie_tipo_conta			= 'C' 
	order by 
		a.ds_conta, 
		b.cd_conta_contabil;


BEGIN 
/* Obter o período trimestral do DIOPS */
 
begin 
select	coalesce(a.dt_periodo_inicial,''), 
	coalesce(a.dt_periodo_final, ''), 
	a.cd_estabelecimento, 
	coalesce(a.ie_normal_encerramento, 'N') 
into STRICT	dt_periodo_inicial_w, 
	dt_periodo_final_w, 
	cd_estabelecimento_w, 
	ie_normal_encerramento_w 
from	diops_periodo	a 
where	a.nr_sequencia	= nr_seq_periodo_p;
exception 
when others then 
	CALL wheb_mensagem_pck.exibir_mensagem_abort(174234, 'NR_SEQ_OPERADORA=' || nr_seq_operadora_p || ';' || 
							'NR_SEQ_PERIODO=' || nr_seq_periodo_p);
end;				
 
open C01;
loop 
fetch C01 into	 
	ds_conta_w, 
	cd_conta_contabil_w, 
	vl_saldo_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	insert into w_diops_sem_ativoliq(nr_sequencia, 
		nr_seq_operadora, 
		nr_seq_transacao, 
		ds_conta, 
		vl_saldo, 
		cd_conta_contabil, 
		nr_seq_periodo, 
		dt_atualizacao, 
		nm_usuario) 
	values (	nextval('w_diops_sem_ativoliq_seq'), 
		nr_seq_operadora_p, 
		nr_seq_transacao_p, 
		ds_conta_w, 
		vl_saldo_w, 
		cd_conta_contabil_w, 
		nr_seq_periodo_p, 
		clock_timestamp(), 
		nm_usuario_p);
	end;
end loop;
close C01;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE diops_sem_gerar_ativo_liq ( nr_seq_operadora_p bigint, nr_seq_transacao_p bigint, nr_seq_periodo_p bigint, nm_usuario_p text) FROM PUBLIC;

