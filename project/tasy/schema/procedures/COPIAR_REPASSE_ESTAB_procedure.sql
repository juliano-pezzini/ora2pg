-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE copiar_repasse_estab ( cd_estab_origem_p bigint, cd_estab_destino_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_regra_w		integer;
cd_nova_regra_w		integer;	
nr_seq_item_w		integer;
nr_nova_seq_item_w	integer;

nr_seq_pro_w		bigint;
nr_nova_seq_pro_w	bigint;
nr_seq_pro_item_w		bigint;

nr_seq_mat_w		bigint;
nr_nova_seq_mat_w	bigint;
nr_seq_mat_item_w		bigint;

c01 CURSOR FOR
SELECT	cd_regra
from	regra_repasse_terceiro
where	cd_estabelecimento = cd_estab_origem_p;

c02 CURSOR FOR
SELECT	nr_seq_item
from	regra_repasse_terc_item
where	cd_regra = cd_regra_w;

c03 CURSOR FOR
SELECT	nr_sequencia
from	proc_criterio_repasse
where	cd_regra = cd_regra_w;

c04 CURSOR FOR
SELECT	nr_sequencia
from	proc_criterio_rep_mat
where	nr_seq_criterio = nr_seq_pro_w;

c05 CURSOR FOR
SELECT	nr_sequencia
from	proc_crit_repasse_adic
where	nr_seq_criterio = nr_seq_pro_w;

c06 CURSOR FOR
SELECT	nr_sequencia
from	proc_crit_repasse_dia
where	nr_seq_criterio = nr_seq_pro_w;

c07 CURSOR FOR
SELECT	nr_sequencia
from	mat_criterio_repasse
where	cd_regra = cd_regra_w;

c08 CURSOR FOR
SELECT	nr_sequencia
from	mat_criterio_rep_proc
where	nr_seq_criterio = nr_seq_mat_w;


BEGIN

open c01;
loop
fetch c01 into
	cd_regra_w;
EXIT WHEN NOT FOUND; /* apply on c01 */	
	
	select	max(cd_regra) + 1
	into STRICT	cd_nova_regra_w
    	from	regra_repasse_terceiro;

	insert	into regra_repasse_terceiro(
		cd_estabelecimento,
		cd_regra,
		ds_regra,                    
		ds_repasse,                
		dt_atualizacao,
		dt_atualizacao_nrec,
		dt_inicio_vigencia,
		dt_limite_regra,
		ie_acao_glosa,
		ie_pagto,                   
		nm_usuario,              
		nm_usuario_nrec,
		nr_seq_trans_fin_prod,        
		nr_seq_trans_fin_rep_maior,
		nr_seq_trans_fin_tit)
	SELECT	cd_estab_destino_p,
		cd_nova_regra_w,
		ds_regra,
		ds_repasse,
		clock_timestamp(),
		clock_timestamp(),
		dt_inicio_vigencia,
		dt_limite_regra,
		ie_acao_glosa,
		ie_pagto,
		nm_usuario_p,
		nm_usuario_p,
		nr_seq_trans_fin_prod,
		nr_seq_trans_fin_rep_maior,
		nr_seq_trans_fin_tit
	from	regra_repasse_terceiro
	where	cd_regra = cd_regra_w;


	open c02;
	loop
	fetch c02 into
		nr_seq_item_w;
	EXIT WHEN NOT FOUND; /* apply on c02 */
		
		select (coalesce(max(nr_seq_item),0) + 1)
		into STRICT	nr_nova_seq_item_w
		from	regra_repasse_terc_item
		where	cd_regra	= cd_nova_regra_w;

		insert	into regra_repasse_terc_item(
			cd_conta_contabil,
			cd_pessoa_fisica,
			cd_regra,
			ds_observacao,
			dt_atualizacao,
			ie_beneficiario,
			ie_gravacao_medico,
			ie_perc_saldo,
			ie_regra_saldo,
			ie_restricao_medico,
			nm_usuario,
			nr_seq_item,
			nr_seq_terceiro,
			tx_repasse,
			vl_repasse,
			tx_anestesista,
			tx_auxiliares,
			tx_custo_operacional,
			tx_materiais,
			tx_medico)
		SELECT	cd_conta_contabil,
			cd_pessoa_fisica,
			cd_nova_regra_w,
			ds_observacao,
			clock_timestamp(),
			ie_beneficiario,
			ie_gravacao_medico,
			ie_perc_saldo,
			ie_regra_saldo,
			ie_restricao_medico,
			nm_usuario_p,
			nr_nova_seq_item_w,
			nr_seq_terceiro,
			tx_repasse,
			vl_repasse,
			tx_anestesista,
			tx_auxiliares,
			tx_custo_operacional,
			tx_materiais,
			tx_medico
		from	regra_repasse_terc_item
		where	cd_regra = cd_regra_w
		and	nr_seq_item = nr_seq_item_w;
	
	end loop;
	close c02;

	open c03;
	loop
	fetch c03 into
		nr_seq_pro_w;
	EXIT WHEN NOT FOUND; /* apply on c03 */
		
		select	nextval('proc_criterio_repasse_seq')
		into STRICT	nr_nova_seq_pro_w
		;

		insert	into proc_criterio_repasse(
			cd_area_proced,
			cd_categoria,            
			cd_categoria_calc,       
			cd_convenio,             
			cd_convenio_calc,        
			cd_edicao_amb,           
			cd_edicao_amb_calc,      
			cd_equipamento,          
			cd_especialidade,        
			cd_especial_proced,      
			cd_grupo_proc_aih,       
			cd_grupo_proced,         
			cd_medico,               
			cd_medico_laudo,         
			cd_municipio_ibge,       
			cd_prestador,            
			cd_procedimento,         
			cd_registro,             
			cd_regra,                
			cd_setor_atendimento,    
			cd_situacao_glosa,       
			cd_tabela_preco,         
			dt_atualizacao,          
			dt_atualizacao_nrec,     
			dt_vigencia_final,       
			dt_vigencia_inicial,     
			hr_final,                
			hr_inicial,              
			ie_atend_retorno,        
			ie_carater_inter_sus,    
			ie_clinica,              
			ie_cobra_pf_pj,          
			ie_conveniado,           
			ie_forma_calculo,        
			ie_funcao,               
			ie_honorario,            
			ie_honorario_restricao,
			ie_med_exec_socio,       
			ie_origem_proced,        
			ie_pacote,               
			ie_participou_sus,       
			ie_perc_pacote,          
			ie_plantao,              
			ie_regra_dia,            
			ie_regra_medico,         
			ie_situacao,             
			ie_tipo_atendimento,     
			ie_tipo_ato_sus,         
			ie_tipo_convenio,        
			ie_tipo_servico_sus,     
			nm_usuario,              
			nm_usuario_nrec,         
			nr_seq_exame,            
			nr_seq_forma_org,        
			nr_seq_grupo,            
			nr_seq_proc_interno,     
			nr_seq_subgrupo,         
			nr_sequencia,            
			qt_dia_final,            
			qt_dia_inicial,          
			tx_anestesista,          
			tx_auxiliares,           
			tx_custo_operacional,    
			tx_materiais,            
			tx_medico,               
			tx_procedimento,         
			vl_limite,               
			vl_repasse,
			IE_LIB_LAUDO_PROC)
		SELECT	cd_area_proced,          
			cd_categoria,            
			cd_categoria_calc,       
			cd_convenio,             
			cd_convenio_calc,        
			cd_edicao_amb,           
			cd_edicao_amb_calc,      
			cd_equipamento,          
			cd_especialidade,        
			cd_especial_proced,      
			cd_grupo_proc_aih,       
			cd_grupo_proced,         
			cd_medico,               
			cd_medico_laudo,         
			cd_municipio_ibge,       
			cd_prestador,            
			cd_procedimento,         
			cd_registro,             
			cd_nova_regra_W,                
			cd_setor_atendimento,    
			cd_situacao_glosa,       
			cd_tabela_preco,         
			clock_timestamp(),
			clock_timestamp(),
			dt_vigencia_final,       
			dt_vigencia_inicial,     
			hr_final,                
			hr_inicial,              
			ie_atend_retorno,        
			ie_carater_inter_sus,    
			ie_clinica,              
			ie_cobra_pf_pj,          
			ie_conveniado,           
			ie_forma_calculo,        
			ie_funcao,               
			ie_honorario,            
			ie_honorario_restricao,
			ie_med_exec_socio,       
			ie_origem_proced,        
			ie_pacote,               
			ie_participou_sus,       
			ie_perc_pacote,          
			ie_plantao,              
			ie_regra_dia,            
			ie_regra_medico,         
			ie_situacao,             
			ie_tipo_atendimento,     
			ie_tipo_ato_sus,         
			ie_tipo_convenio,        
			ie_tipo_servico_sus,     
			nm_usuario_p,
			nm_usuario_p,
			nr_seq_exame,            
			nr_seq_forma_org,        
			nr_seq_grupo,            
			nr_seq_proc_interno,     
			nr_seq_subgrupo,         
			nr_nova_seq_pro_w,
			qt_dia_final,            
			qt_dia_inicial,          
			tx_anestesista,          
			tx_auxiliares,           
			tx_custo_operacional,    
			tx_materiais,            
			tx_medico,               
			tx_procedimento,         
			vl_limite,               
			vl_repasse,
			IE_LIB_LAUDO_PROC
		from	proc_criterio_repasse
		where	nr_sequencia	= nr_seq_pro_w;

		open c04;
		loop
		fetch c04 into 
			nr_seq_pro_item_w;
		EXIT WHEN NOT FOUND; /* apply on c04 */
						
			insert	into proc_criterio_rep_mat(
				cd_material,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nm_usuario,              
				nm_usuario_nrec,         
				nr_seq_criterio,         
				nr_sequencia)
			SELECT	cd_material, 
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_p,
				nm_usuario_p,
				nr_nova_seq_pro_w,
				nextval('proc_criterio_rep_mat_seq')
			from	proc_criterio_rep_mat
			where	nr_seq_criterio = nr_seq_pro_item_w;

		end loop;
		close c04;

		open c05;
		loop
		fetch c05 into
			nr_seq_pro_item_w;
		EXIT WHEN NOT FOUND; /* apply on c05 */

			insert	into proc_crit_repasse_adic(
				ds_function,
				dt_atualizacao,
				dt_atualizacao_nrec,
				nm_usuario,
				nm_usuario_nrec,
				nr_seq_criterio,
				nr_sequencia)
			SELECT	ds_function,
				clock_timestamp(),
				clock_timestamp(),
				nm_usuario_p,
				nm_usuario_p,
				nr_nova_seq_pro_w,
				nextval('proc_crit_repasse_adic_seq')
			from	proc_crit_repasse_adic
			where	nr_seq_criterio = nr_seq_pro_item_w;
		end loop;
		close c05;
	
		open c06;
		loop
		fetch c06 into	
			nr_seq_pro_item_w;
		EXIT WHEN NOT FOUND; /* apply on c06 */
					
			insert	into proc_crit_repasse_dia(
				dt_atualizacao,
				dt_atualizacao_nrec,     	
				ie_dia_semana,           
				nm_usuario,              
				nm_usuario_nrec,         
				nr_seq_criterio,         
				nr_sequencia)
			SELECT	clock_timestamp(),
				clock_timestamp(),
				ie_dia_semana,           
				nm_usuario_p,
				nm_usuario_p,
				nr_nova_seq_pro_w,
				nextval('proc_crit_repasse_dia_seq')
			from	proc_crit_repasse_dia
			where	nr_seq_criterio = nr_seq_pro_item_w;
	
		end loop;
		close c06;

	end loop;
	close c03;

	open c07;
	loop
	fetch c07 into	
		nr_seq_mat_w;
	EXIT WHEN NOT FOUND; /* apply on c07 */

		select	nextval('mat_criterio_repasse_seq')
		into STRICT	nr_nova_seq_mat_w
		;
		
		insert	into mat_criterio_repasse(
			cd_categoria_calc,
			cd_cgc_prestador,
			cd_classe_material,     
			cd_convenio,             
			cd_convenio_calc,        
			cd_edicao_amb,           
			cd_grupo_material,       
			cd_material,             
			cd_medico,               
			cd_municipio_ibge,       
			cd_regra,                
			cd_setor_atendimento,    
			cd_subgrupo_material,    
			cd_tabela_preco,         
			cd_tab_preco_calc,       
			dt_atualizacao,          
			dt_atualizacao_nrec,     
			dt_vigencia_final,       
			dt_vigencia_inicial,     
			ie_atend_retorno,        
			ie_carater_inter_sus,    
			ie_forma_calculo,        
			ie_pacote,               
			ie_regra_medico,         
			ie_situacao,             
			ie_tipo_atendimento,     
			ie_tipo_convenio,        
			nm_usuario,              
			nm_usuario_nrec,
			nr_sequencia,            
			tx_repasse,              
			vl_repasse,
			nr_seq_grupo_rec)
		SELECT	cd_categoria_calc,       
			cd_cgc_prestador,        
			cd_classe_material,      
			cd_convenio,             
			cd_convenio_calc,        
			cd_edicao_amb,           
			cd_grupo_material,       
			cd_material,             
			cd_medico,               
			cd_municipio_ibge,       
			cd_nova_regra_w,                
			cd_setor_atendimento,    
			cd_subgrupo_material,    
			cd_tabela_preco,         
			cd_tab_preco_calc,       
			clock_timestamp(),
			clock_timestamp(),
			dt_vigencia_final,       
			dt_vigencia_inicial,     
			ie_atend_retorno,        
			ie_carater_inter_sus,    
			ie_forma_calculo,        
			ie_pacote,               
			ie_regra_medico,         
			ie_situacao,             
			ie_tipo_atendimento,     
			ie_tipo_convenio,        
			nm_usuario_p,
			nm_usuario_p,
			nr_nova_seq_mat_w,
			tx_repasse,              
			vl_repasse ,
			nr_seq_grupo_rec
		from	mat_criterio_repasse
		where	nr_sequencia	= nr_seq_mat_w;

		open c08;
		loop
		fetch c08 into	
			nr_seq_mat_item_w;
		EXIT WHEN NOT FOUND; /* apply on c08 */
	
			insert	into mat_criterio_rep_proc(
				cd_area_procedimento,
				cd_especialidade_proc,
				cd_grupo_proc,           
				cd_procedimento,         
				dt_atualizacao,          
				dt_atualizacao_nrec,     
				ie_origem_proced,        
				nm_usuario,              
				nm_usuario_nrec,         
				nr_seq_criterio,         
				nr_sequencia)
			SELECT  cd_area_procedimento,    
				cd_especialidade_proc,
				cd_grupo_proc,           
				cd_procedimento,         
				clock_timestamp(),
				clock_timestamp(),
				ie_origem_proced,        
				nm_usuario_p,
				nm_usuario_p,
				nr_nova_seq_mat_w,
				nextval('mat_criterio_rep_proc_seq')
			from	mat_criterio_rep_proc
			where	nr_seq_criterio = nr_seq_mat_item_w;

		end loop;
		close c08;

	end loop;
	close c07;
	
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE copiar_repasse_estab ( cd_estab_origem_p bigint, cd_estab_destino_p bigint, nm_usuario_p text) FROM PUBLIC;

