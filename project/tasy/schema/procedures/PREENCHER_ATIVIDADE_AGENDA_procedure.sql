-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE preencher_atividade_agenda ( qt_tempo_atividade_p bigint, nr_seq_atividade_p bigint, nr_seq_agenda_p bigint, dt_agenda_p timestamp, hr_inicial_p timestamp, ie_frequencia_p text, ie_tipo_atividade_p text, ie_preencheu_p INOUT text) AS $body$
DECLARE


qt_intervalos_preenchimento_w		bigint;
qt_intervalos_w				bigint	:=	1;
dt_agenda_w				timestamp;
hr_inicial_w				timestamp;
qt_intervalos_restantes_w		bigint;
ie_dia_validacao_w			varchar(1);






BEGIN
ie_preencheu_p	:=	'N';

dt_agenda_w	:=	dt_agenda_p;
hr_inicial_w	:=	hr_inicial_p;

select (qt_tempo_atividade_p / 30)
into STRICT	qt_intervalos_preenchimento_w
;


if (qt_intervalos_preenchimento_w > 1) then
	begin

	select	count(*)
	into STRICT	qt_intervalos_restantes_w
	from	consulta_agenda
	where	dt_agenda 	 = dt_agenda_w
	and	nr_seq_agenda 	 = nr_seq_agenda_p
	and	hr_atividade  between to_date('07:30:00','hh24:mi:ss') and to_date('16:30:00','hh24:mi:ss')
	and	hr_atividade not between to_date('12:00:00','hh24:mi:ss') and to_date('13:00:00','hh24:mi:ss')
	and	Obter_Cod_Dia_Semana(dt_agenda) not in (1,7)
	and	coalesce(nr_seq_atividade::text, '') = ''
	and	coalesce(dt_cancelamento::text, '') = '';

	if (qt_intervalos_restantes_w < 16 ) then
		begin

		select	CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END
		into STRICT	ie_dia_validacao_w
		from	consulta_agenda a,
			atividade_agenda b
		where	a.dt_agenda 	 	= dt_agenda_w
		and	a.nr_seq_agenda 	 = nr_seq_agenda_p
		and	coalesce(b.ie_tipo_atividade::text, '') = ''
		and	a.hr_atividade  between to_date('07:30:00','hh24:mi:ss') and to_date('16:30:00','hh24:mi:ss')
		and	a.hr_atividade not between to_date('12:00:00','hh24:mi:ss') and to_date('13:00:00','hh24:mi:ss')
		and	Obter_Cod_Dia_Semana(a.dt_agenda) not in (1,7)
		and	coalesce(a.nr_seq_atividade::text, '') = ''
		and	coalesce(a.dt_cancelamento::text, '') = '';

		end;
	end if;


	if	((qt_intervalos_preenchimento_w <= qt_intervalos_restantes_w) or (qt_intervalos_restantes_w = 16)) then -- or ((ie_dia_validacao_w = 'S') and (ie_tipo_atividade_p is not null))) then
		begin

		while qt_intervalos_w <= qt_intervalos_preenchimento_w loop
			begin


			update	consulta_agenda
			set	nr_seq_atividade = nr_seq_atividade_p,
				ds_atividade 	 = substr(obter_desc_ativ_agenda(nr_seq_atividade_p),1,255),
				ds_cor_atividade = substr(obter_cor_ativ_agenda(nr_seq_atividade_p),1,15)
			where	nr_seq_agenda 	 = nr_seq_agenda_p
			and	dt_agenda 	 = dt_agenda_w
			and	hr_atividade	 = hr_inicial_w
			and	coalesce(nr_seq_atividade::text, '') = '';

			ie_preencheu_p	:=	'S';

			if (ie_frequencia_p	=	'S') then
				begin

				update	consulta_agenda
				set	nr_seq_atividade = nr_seq_atividade_p,
					ds_atividade 	 = substr(obter_desc_ativ_agenda(nr_seq_atividade_p),1,255),
					ds_cor_atividade = substr(obter_cor_ativ_agenda(nr_seq_atividade_p),1,15)
				where	nr_seq_agenda 	 = nr_seq_agenda_p
				and	dt_agenda 	 = (dt_agenda_w + 7)
				and	hr_atividade	 = hr_inicial_w
				and	coalesce(nr_seq_atividade::text, '') = '';

				end;
			end if;


			hr_inicial_w		:=	hr_inicial_w + 01/24/2;

			if (to_char(hr_inicial_w,'hh24:mi:ss') = '12:00:00') then
				hr_inicial_w	:=	to_date('13:30:00','hh24:mi:ss');
			end if;

			if (to_char(hr_inicial_w,'hh24:mi:ss') = '17:00:00') then
				hr_inicial_w	:=	to_date('07:30:00','hh24:mi:ss');
				dt_agenda_w	:=	dt_agenda_w + 1;
			end if;

			qt_intervalos_w		:=	qt_intervalos_w + 1;

			end;
		end loop;
		end;
	end if;

	end;
elsif (qt_intervalos_preenchimento_w = 1) then
	begin

	update	consulta_agenda
	set	nr_seq_atividade = nr_seq_atividade_p,
		ds_atividade 	 = substr(obter_desc_ativ_agenda(nr_seq_atividade_p),1,255),
		ds_cor_atividade = substr(obter_cor_ativ_agenda(nr_seq_atividade_p),1,15)
	where	nr_seq_agenda 	 = nr_seq_agenda_p
	and	dt_agenda 	 = dt_agenda_w
	and	hr_atividade	 = hr_inicial_w
	and	coalesce(nr_seq_atividade::text, '') = '';

	ie_preencheu_p	:=	'S';

	if (ie_frequencia_p	=	'S') then
		begin

		update	consulta_agenda
		set	nr_seq_atividade = nr_seq_atividade_p,
			ds_atividade 	 = substr(obter_desc_ativ_agenda(nr_seq_atividade_p),1,255),
			ds_cor_atividade = substr(obter_cor_ativ_agenda(nr_seq_atividade_p),1,15)
		where	nr_seq_agenda 	 = nr_seq_agenda_p
		and	dt_agenda 	 = (dt_agenda_w + 7)
		and	hr_atividade	 = hr_inicial_w
		and	coalesce(nr_seq_atividade::text, '') = '';

		end;
	end if;

	end;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE preencher_atividade_agenda ( qt_tempo_atividade_p bigint, nr_seq_atividade_p bigint, nr_seq_agenda_p bigint, dt_agenda_p timestamp, hr_inicial_p timestamp, ie_frequencia_p text, ie_tipo_atividade_p text, ie_preencheu_p INOUT text) FROM PUBLIC;

