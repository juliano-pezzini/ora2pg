-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fa_gravar_hist_status (nr_seq_entrega_p bigint default 0, nr_seq_entrega_item_p bigint default 0, ie_status_p text DEFAULT NULL, nm_usuario_p text DEFAULT NULL) AS $body$
DECLARE


data_atualizacao_w	timestamp;
nr_seq_entr_item_w	bigint;
ie_status_medicacao_w	varchar(15);
cd_material_subst_w	bigint;

C01 CURSOR FOR
SELECT 	nr_sequencia
from	fa_entrega_medicacao_item
where	nr_seq_fa_entrega = nr_seq_entrega_p
and	IE_STATUS_MEDICACAO = ie_status_p;


BEGIN

data_atualizacao_w := clock_timestamp();

if (nr_seq_entrega_p <> 0) then
	open C01;
	loop
	fetch C01 into
		nr_seq_entr_item_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		insert 	into fa_entr_medic_item_status(nr_sequencia,
			 dt_atualizacao,
			 nm_usuario,
			 dt_atualizacao_nrec,
			 nm_usuario_nrec,
			 ie_status_medicacao,
			 nr_seq_fa_entrega_item)
		values (nextval('fa_entr_medic_item_status_seq'),
			 data_atualizacao_w,
			 nm_usuario_p,
			 data_atualizacao_w,
			 nm_usuario_p,
			 ie_status_p,
			 nr_seq_entr_item_w);
	end loop;
	close C01;
elsif (nr_seq_entrega_item_p <> 0) then

	select	ie_status_medicacao,
		cd_material_subst
	into STRICT	ie_status_medicacao_w,
		cd_material_subst_w
	from	fa_entrega_medicacao_item
	where	nr_sequencia = nr_seq_entrega_item_p;

	if (ie_status_medicacao_w = ie_status_p) or (ie_status_p = 'MS') then

		insert 	into fa_entr_medic_item_status(nr_sequencia,
			 dt_atualizacao,
			 nm_usuario,
			 dt_atualizacao_nrec,
			 nm_usuario_nrec,
			 ie_status_medicacao,
			 cd_material_subst,
			 nr_seq_fa_entrega_item)
		values (nextval('fa_entr_medic_item_status_seq'),
			data_atualizacao_w,
			nm_usuario_p,
			data_atualizacao_w,
			nm_usuario_p,
			ie_status_p,
			cd_material_subst_w,
			nr_seq_entrega_item_p);
	end if;
end if;


commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fa_gravar_hist_status (nr_seq_entrega_p bigint default 0, nr_seq_entrega_item_p bigint default 0, ie_status_p text DEFAULT NULL, nm_usuario_p text DEFAULT NULL) FROM PUBLIC;

