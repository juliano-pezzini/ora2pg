-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dacon_registro_r1 ( nm_usuario_p text, nr_seq_dacon_p bigint) AS $body$
DECLARE


ds_arquivo_w	varchar(2000);


BEGIN

select	rpad('R01',4,' ') --ds_tipo_registro,
	||rpad(elimina_caractere_especial(elimina_acentuacao(obter_cgc_estabelecimento(cd_estabelecimento))),14,' ') --cd_cgc,
	||'1'
	||substr(to_char(dt_referencia, 'yyyyMM'), 1, 6) --dt_anomes_comp,
	||to_char(dt_referencia, 'yyyyMM')||'01' --dt_inicial,
	||substr(to_char(fim_mes(dt_referencia),'yyyyMMdd'), 1, 8) --dt_final,
	||coalesce(lpad(ie_indicador, 1, 0), (lpad(0,1,0))) --ie_indicador,
	||coalesce(lpad(ie_situacao_especial,2,0), (lpad(0,2,0))) --ie_situacao_esp,
	||rpad(coalesce(to_char(dt_evento, 'yyyyMMdd'),0),8,0) --dt_evento
	||coalesce(ie_desenquadramento,0) --XXXXXXXXXXXXXXXX
	||rpad(coalesce(to_char(dt_desenquadramento,'yyyyMMdd'),0),8,0) --dt_desenquadramento,
	||lpad(0,10,0) --ds_reservado,
	||lpad(coalesce(ie_qualificacao,0),2,0) --ie_qualificacao_pj,
	||lpad(coalesce(ie_tipo_entidade,0),2,0) --ie_tipo_entidade,
	||coalesce(ie_inclusao_simples,0) --XXXXXXXXX
	||rpad(coalesce(to_char(dt_inclusao_simples,'yyyyMMdd'),0),8,0) --dt_inclusao,
	||coalesce(ie_regime_apuracao,0)
	||coalesce(ie_apuracao_pis_cofins,0)
	||coalesce(ie_apuracao_diferenciado,0)
	||'2' --ie_apuracao_diferenciado_st,
	||coalesce(ie_apuracao_unidade_medida,0)
	||coalesce(ie_apuracao_substituto_trib,0)
	||coalesce(ie_adicao_mes_anteriores,0)
	||coalesce(ie_contribuicao_mes,0)
	||coalesce(ie_credito_transferido_mes,0)
	||coalesce(ie_contribuicao_transf_mes,0)
	||coalesce(ie_desconto_mes,0)
	||CASE WHEN ie_metodo_determinacao='' THEN  ' '  ELSE ie_metodo_determinacao END
	||lpad(0,10,0) --ds_reservado1,
into STRICT	ds_arquivo_w
from 	dacon
where	nr_sequencia = nr_seq_dacon_p;

insert into w_dacon(nr_sequencia,
		 dt_atualizacao,
		 nm_usuario,
		 dt_atualizacao_nrec,
		 nm_usuario_nrec,
		 ds_arquivo,
		 nr_linha,
		 ie_tipo_registro)
values (nextval('w_dacon_seq'),
	    clock_timestamp(),
	    nm_usuario_p,
	    clock_timestamp(),
	    nm_usuario_p,
	    ds_arquivo_w,
	    1,
 	    10);
commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dacon_registro_r1 ( nm_usuario_p text, nr_seq_dacon_p bigint) FROM PUBLIC;

