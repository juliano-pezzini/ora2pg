-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_susp_atend_sem_rep ( nr_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_cpoe_w			cpoe_material.nr_sequencia%type;
ie_opcao_suspender_w	varchar(4000);
ds_lista_proc_susp_w	varchar(4000);
ds_erro_w				varchar(4000);
ie_tipo_item_cpoe_w		varchar(5);

c01 CURSOR FOR 
	SELECT	nr_sequencia, 
			ie_tipo_item_cpoe 
	from	cpoe_itens_v 
	where	nr_atendimento = nr_atendimento_p 
	and (dt_suspensao > clock_timestamp() or coalesce(dt_suspensao::text, '') = '') 
	and		cpoe_obter_se_contem_prescr(nr_sequencia, ie_tipo_item) = 'N';


BEGIN 
 
open C01;
loop 
fetch C01 into	 
	nr_seq_cpoe_w, 
	ie_tipo_item_cpoe_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	ie_opcao_suspender_w := ie_opcao_suspender_w || nr_seq_cpoe_w || ';' || ie_tipo_item_cpoe_w || ';' || 'S' || ', ';
	end;
end loop;
close C01;
 
if (ie_opcao_suspender_w IS NOT NULL AND ie_opcao_suspender_w::text <> '') then 
	ds_lista_proc_susp_w := cpoe_suspender_item_prescr('[' || ie_opcao_suspender_w || ']', nr_atendimento_p, nm_usuario_p, null, null, 'N', ds_lista_proc_susp_w, 'N');
end if;
 
exception when others then 
	ds_erro_w	:= to_char(sqlerrm);	
	CALL gravar_log_tasy(10007, 
					obter_desc_expressao(289370)||' procedure cpoe_susp_atend_sem_rep -'
|| obter_desc_expressao(712423)  
								|| ' nr_atendimento_p: ' || nr_atendimento_p 
								|| ' nm_usuario_p : ' || nm_usuario_p 
								|| ' Erro : ' || ds_erro_w,nm_usuario_p);
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_susp_atend_sem_rep ( nr_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

