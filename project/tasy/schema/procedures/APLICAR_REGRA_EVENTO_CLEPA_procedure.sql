-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE aplicar_regra_evento_clepa ( nr_seq_evento_p bigint, nr_atendimento_p bigint, cd_profissional_p bigint, cd_pessoa_fisica_p bigint, nm_usuario_p text, ie_momento_p text, nr_seq_pepo_p bigint, nr_cirurgia_p bigint default null, nr_seq_regra_w INOUT bigint DEFAULT NULL) AS $body$
DECLARE


ie_gerada_w		varchar(1);
nr_sequencia_p bigint;
cd_perfil_w    perfil.cd_perfil%type := wheb_usuario_pck.get_cd_perfil;
			
			 
c01 CURSOR FOR
SELECT	pr.nr_seq_checklist, 
         coalesce(( SELECT   MAX(obter_se_gerado_checklist(ch.nr_sequencia)) 
               FROM     atendimento_checklist ch 
               WHERE    ch.nr_atendimento = nr_atendimento_p 
               and	   coalesce(nr_cirurgia,coalesce(nr_cirurgia_p,0)) = coalesce(nr_cirurgia_p,0)
               AND      ch.nr_seq_checklist = pr.nr_seq_checklist),'N') 
FROM 	   checklist_processo_regra pr, 
         checklist_processo cp
WHERE	   pr.nr_seq_checklist = cp.nr_sequencia
and      obter_se_checklist_lib_perfil(cp.nr_sequencia,cd_perfil_w,null) = 'S'
AND      coalesce(nr_seq_evento, coalesce(nr_seq_evento_p,0)) = coalesce(nr_seq_evento_p,0)
and      pr.ie_momento  = ie_momento_p;


BEGIN
open c01;
loop
fetch c01 into
	nr_seq_regra_w,
	ie_gerada_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin
	
   	if ie_gerada_w = 'N' then 
	
		select	nextval('atendimento_checklist_seq')
		into STRICT	nr_sequencia_p
		;
		
		
		insert into  atendimento_checklist(
			nr_sequencia,
			nm_usuario,
			nr_atendimento, 
			nr_seq_checklist,
			dt_atualizacao,
			cd_profissional,
			cd_pessoa_fisica,
			DT_REGISTRO,
			NR_CIRURGIA,
			nr_seq_pepo)  
		values (
		    nr_sequencia_p,
			nm_usuario_p,
			CASE WHEN nr_atendimento_p=0 THEN null  ELSE nr_atendimento_p END ,
			nr_seq_regra_w,
			clock_timestamp(),
			CASE WHEN cd_profissional_p=0 THEN null  ELSE cd_profissional_p END ,
			CASE WHEN cd_pessoa_fisica_p=0 THEN null  ELSE cd_pessoa_fisica_p END ,
			clock_timestamp(),
			CASE WHEN nr_cirurgia_p=0 THEN null  ELSE nr_cirurgia_p END ,
			CASE WHEN nr_seq_pepo_p=0 THEN null  ELSE nr_seq_pepo_p END );
	
	   CALL gerar_checklist_atendimento(nm_usuario_p,nr_sequencia_p,cd_profissional_p);
	end if;
			
	end;
	
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE aplicar_regra_evento_clepa ( nr_seq_evento_p bigint, nr_atendimento_p bigint, cd_profissional_p bigint, cd_pessoa_fisica_p bigint, nm_usuario_p text, ie_momento_p text, nr_seq_pepo_p bigint, nr_cirurgia_p bigint default null, nr_seq_regra_w INOUT bigint DEFAULT NULL) FROM PUBLIC;

