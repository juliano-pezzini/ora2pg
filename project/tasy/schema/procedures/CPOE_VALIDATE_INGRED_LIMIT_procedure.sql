-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_validate_ingred_limit (( nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_seq_cpoe_p cpoe_material.nr_sequencia%type, ie_tipo_item_p text, cd_material_p material.cd_material%type, qt_dose_p cpoe_material.qt_dose%type, ds_dose_diferenciada_p cpoe_material.ds_dose_diferenciada%type, cd_unidade_medida_p cpoe_material.cd_unidade_medida%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_intervalo_p intervalo_prescricao.cd_intervalo%type, nr_etapas_p cpoe_material.nr_etapas%type, qt_tempo_aplicacao_p cpoe_material.qt_tempo_aplicacao%type, dt_inicio_p timestamp, dt_fim_p timestamp, ie_tipo_consistencia_p text, ie_dose_out_p out text, cd_unidade_medida_out_p out text, qt_dose_out_p out bigint, ds_mensagem_dose_out_p out text, qt_dose_atend_prescr_out_p out bigint, ie_justificativa_out_p out text) is nr_ocorrencia_w double precision) AS $body$
DECLARE

	qt_dose_24h_w		 	double precision	:= 0;
	qt_concentracao_vig_w	 	double precision	:= 0;
	qt_dose_calc_w			double precision	:= 0;
	cd_unidade_consumo_vig_w	material.cd_unidade_medida_consumo%type;
	qt_dose_medic_w			double precision	:= 0;
	
BEGIN
	
	for r_c04 in c04(nr_seq_ficha_tecnica_p) loop --Para cada horario, somar a dose 
		begin
		
		select	cd_unidade_medida_consumo
		into STRICT	cd_unidade_consumo_vig_w
		from	material
		where	cd_material	= r_c04.cd_material;
		
		
		select	coalesce(max(qt_dose),0)
		into STRICT	qt_dose_medic_w
		from	medic_conc_ingrediente
		where	cd_material		= r_c04.cd_material
		and	nr_ficha_tecnica	= nr_seq_ficha_tecnica_p;
		
		
		
		qt_dose_calc_w	:= obter_dose_convertida(	r_c04.cd_material,
								r_c04.qt_dose, 
								r_c04.cd_unidade_medida, 
								cd_unidade_consumo_vig_w);
								
		qt_dose_calc_w	:= qt_dose_calc_w * qt_dose_medic_w;						
		--Converter para a unidade da regra, espero que todas tenham a conversao
		
		qt_dose_24h_w	:= qt_dose_24h_w + qt_dose_calc_w;
		
		end;
	end loop;
		
	return;
	end;
		

begin

begin


if (cd_material_p IS NOT NULL AND cd_material_p::text <> '') and (ds_dose_diferenciada_p is  not null or qt_dose_p > 0) then

	if (ds_dose_diferenciada_p IS NOT NULL AND ds_dose_diferenciada_p::text <> '') then
		ie_dose_diferenciada_w := 'S';
	end if;

	select	cd_unidade_medida_consumo
	into STRICT	cd_unidade_medida_consumo_w
	from	material
	where	cd_material = cd_material_p;

	for 	dose_w in c02 loop
		qt_dose_w := dose_w.qt_dose;
		qt_dose_total_w := dose_w.qt_dose_total;
		if (ie_dose_diferenciada_w = 'N') then
			if ((nr_etapas_p IS NOT NULL AND nr_etapas_p::text <> '') and  coalesce(cd_intervalo_p::text, '') = '') then
				qt_dose_total_w := qt_dose_w * nr_etapas_p;
			elsif (cd_intervalo_p IS NOT NULL AND cd_intervalo_p::text <> '') then
				qt_dose_total_w := qt_dose_w * obter_ocorrencia_intervalo(cd_intervalo_p, coalesce(qt_tempo_aplicacao_p, 24), 'O');
			end if;
		end if;
	end loop;
	
	qt_dose_total_consumo_w	:= obter_dose_convertida(cd_material_p, qt_dose_total_w, cd_unidade_medida_p, cd_unidade_medida_consumo_w);
	
	for r_c03 in C03 loop
		
		begin
		
		select	nr_ficha_tecnica,
			ie_dose_limite,
			cd_unidade_medida,
			qt_dose_max
		into STRICT	nr_ficha_tecnica_w,
			ie_dose_limite_w,
			cd_unidade_medida_w,
			qt_dose_max_w
		from	medic_ficha_limite
		where	nr_ficha_tecnica = r_c03.nr_ficha_tecnica;
		exception
		when others then
			ie_dose_limite_w	:= null;
		end;
		
		if (ie_dose_limite_w	= 'DIA') then
				
			qt_dose_total_consumo_lim_w	:= qt_dose_total_consumo_w * r_c03.qt_dose;
			
			qt_dose_total_consumo_total_w	:=  coalesce(qt_dose_total_consumo_lim_w,0);
			
			
			qt_dose_total_consumo_total_w	:=  coalesce(qt_dose_total_consumo_lim_w,0)	+ coalesce(obterDose24h(r_c03.nr_ficha_tecnica),0);
			
			if (qt_dose_total_consumo_total_w	> qt_dose_max_w) then
				ie_justificativa_out_p		:= 'N';
				ds_mensagem_dose_out_p 		:= qt_dose_max_w ||' '||substr( obter_desc_unid_med(cd_unidade_medida_w) || '/' ||
								   obter_valor_dominio(1851,ie_dose_limite_w), 1, 255) ||' '||
								   obter_desc_expressao(746911) || ' '||obter_desc_ficha_tecnica(r_c03.nr_ficha_tecnica);
				cd_unidade_medida_out_p		:= cd_unidade_medida_w;
				qt_dose_out_p			:= qt_dose_max_w;
				ie_dose_out_p			:= ie_dose_limite_w;
				qt_dose_atend_prescr_out_p	:= qt_dose_total_consumo_lim_w;
				return;
			end if;
		
		end if;
	end loop;
end if;

exception when others then
	ds_erro_w	:= substr(to_char(sqlerrm),1,2000);
	
	CALL gravar_log_cpoe(10007,substr('CPOE_VALIDATE_INGRED_LIMIT EXCEPTION: '||ds_erro_w
										||' STACK ' || dbms_utility.format_call_stack
										||' nr_seq_cpoe_p: '||nr_seq_cpoe_p||' qt_tempo_aplicacao_p :'||qt_tempo_aplicacao_p
									    ||' qt_dose_p: '||qt_dose_p||' ds_dose_diferenciada_p: '||ds_dose_diferenciada_p
									    ||' cd_unidade_medida_p:'||cd_unidade_medida_p||' cd_pessoa_fisica_p:'||cd_pessoa_fisica_p
									    ||' cd_intervalo_p :'||cd_intervalo_p||' nr_etapas_p :'||nr_etapas_p
									    ||' dt_inicio_p :'||to_char(dt_inicio_p,'dd/mm/yyyy hh24:mi:ss')||' dt_fim_p :'||to_char(dt_fim_p,'dd/mm/yyyy hh24:mi:ss')
										,1,2000),
			nr_atendimento_p);		
	end;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_validate_ingred_limit (( nr_atendimento_p atendimento_paciente.nr_atendimento%type, nr_seq_cpoe_p cpoe_material.nr_sequencia%type, ie_tipo_item_p text, cd_material_p material.cd_material%type, qt_dose_p cpoe_material.qt_dose%type, ds_dose_diferenciada_p cpoe_material.ds_dose_diferenciada%type, cd_unidade_medida_p cpoe_material.cd_unidade_medida%type, cd_pessoa_fisica_p pessoa_fisica.cd_pessoa_fisica%type, cd_intervalo_p intervalo_prescricao.cd_intervalo%type, nr_etapas_p cpoe_material.nr_etapas%type, qt_tempo_aplicacao_p cpoe_material.qt_tempo_aplicacao%type, dt_inicio_p timestamp, dt_fim_p timestamp, ie_tipo_consistencia_p text, ie_dose_out_p out text, cd_unidade_medida_out_p out text, qt_dose_out_p out bigint, ds_mensagem_dose_out_p out text, qt_dose_atend_prescr_out_p out bigint, ie_justificativa_out_p out text) is nr_ocorrencia_w double precision) FROM PUBLIC;

