-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE as_ag_lista_espera_beforepost ( cd_agenda_p bigint, dt_desejada_p timestamp, cd_setor_atendimento_p bigint, cd_pessoa_fisica_p text, nm_pessoa_lista_p text, nm_usuario_p text, cd_estabelecimento_p bigint ) AS $body$
DECLARE

					 
ds_consistencia_w		varchar(2000);
ie_restringe_setor_lista_w	varchar(1) := 'N';
ie_perm_bloq_lis_espsehorliv_w	varchar(1) := 'N';
ie_ver_agend_lista_esp_espec_w	varchar(1) := 'N';
					

BEGIN 
 
ie_perm_bloq_lis_espsehorliv_w := obter_param_usuario(866, 165, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_perm_bloq_lis_espsehorliv_w);
ie_restringe_setor_lista_w := obter_param_usuario(866, 166, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_restringe_setor_lista_w);
ie_ver_agend_lista_esp_espec_w := obter_param_usuario(866, 167, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_p, ie_ver_agend_lista_esp_espec_w);
 
 
if (ie_restringe_setor_lista_w = 'S') and (cd_setor_atendimento_p IS NOT NULL AND cd_setor_atendimento_p::text <> '') then 
	begin 
	ds_consistencia_w := Consistir_setor_lista_espera(cd_setor_atendimento_p, cd_pessoa_fisica_p, nm_usuario_p, ds_consistencia_w);
	 
	if (ds_consistencia_w IS NOT NULL AND ds_consistencia_w::text <> '') then 
	begin 
	--(-20011, substr(obter_texto_tasy (81181, wheb_usuario_pck.get_nr_seq_idioma),1,255) || ds_consistencia_w || '#@#@'); 
	CALL Wheb_mensagem_pck.exibir_mensagem_abort(81181);
	end;
	 
	end if;
	 
	end;
end if;
 
if (ie_perm_bloq_lis_espsehorliv_w <> 'S') and (cd_agenda_p IS NOT NULL AND cd_agenda_p::text <> '') then 
	begin 
	 
	CALL gerar_horario_agenda_servico(cd_estabelecimento_p,cd_agenda_p,dt_desejada_p,nm_usuario_p);
 
	ds_consistencia_w := agcons_verf_agend_futuro(cd_agenda_p, dt_desejada_p, ds_consistencia_w);
	 
	commit;
	 
	if (DS_CONSISTENCIA_W IS NOT NULL AND DS_CONSISTENCIA_W::text <> '') then 
		begin 
		--(-20011, ds_consistencia_w || '#@#@'); 
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(263477,'DS_CONSIST_W=' || ds_consistencia_w);
		end;
	end if;
	 
	end;
end if;
 
if (ie_ver_agend_lista_esp_espec_w <> 'S') then 
	begin 
	 
	ds_consistencia_w := agserv_verf_lista_espera_espec(	cd_agenda_p, cd_pessoa_fisica_p, nm_pessoa_lista_p, dt_desejada_p, ds_consistencia_w);
	 
	if (ds_consistencia_w IS NOT NULL AND ds_consistencia_w::text <> '') then 
		begin 
		--(-20011, ds_consistencia_w || '#@#@'); 
		CALL Wheb_mensagem_pck.exibir_mensagem_abort(263477,'DS_CONSIST_W=' || ds_consistencia_w);
		end;	
	end if;
	 
	end;
end if;
 
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE as_ag_lista_espera_beforepost ( cd_agenda_p bigint, dt_desejada_p timestamp, cd_setor_atendimento_p bigint, cd_pessoa_fisica_p text, nm_pessoa_lista_p text, nm_usuario_p text, cd_estabelecimento_p bigint ) FROM PUBLIC;

