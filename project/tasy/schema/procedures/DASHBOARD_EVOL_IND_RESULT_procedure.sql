-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE dashboard_evol_ind_result (cd_estabelecimento_p bigint, ie_periodo_p text, nr_seq_indicador_p bigint, dt_referencia_p timestamp, nr_seq_dimensao_p bigint, nr_seq_informacao_p bigint, nr_seq_data_p bigint, nm_usuario_p text, ds_sql_filtro_p text, ds_sql_drill_p text, ie_protocolo_inicio_p bigint, ie_protocolo_final_p bigint, ie_tipo_data_p bigint, ie_restringe_estab_p text) AS $body$
DECLARE


nm_tabela_indicador_w		varchar(50);
ds_sql_where_ind_w		varchar(2000);
ds_sql_mascara_w		varchar(50);
nm_tabela_referencia_w		varchar(50);
nm_atrib_dimensao_w		varchar(85);
nm_atributo_referencia_w	varchar(50);
nm_atributo_drill_w		varchar(50);
ds_sql_where_w			varchar(4000);
ds_sql_data_w			varchar(700);
nm_atrib_data_w			varchar(85);
ds_select_data_w		varchar(200);
ds_comando_w			varchar(4000);
ds_comando_protocolo_w		varchar(200);
nm_atrib_inf_w			varchar(85);
ie_alias_w			varchar(2);
ds_mascara_grid_w		varchar(30);
nr_seq_wheb_w			bigint;
sql_nulo_w			varchar(100);
IE_MOSTRA_NULO_w		varchar(01);
dt_referencia_w			timestamp;
i				integer;
cd_empresa_w			smallint;

nm_tablespace_w			varchar(50);

ie_restringe_estab_w		varchar(1);


BEGIN

select	' TABLESPACE '||obter_tablespace_tab_temp
into STRICT	nm_tablespace_w
;

ds_sql_data_w			:= '';
ds_sql_mascara_w		:= '';
ie_restringe_estab_w		:= ie_restringe_estab_p;

if (ie_restringe_estab_w = '') then
	ie_restringe_estab_w    	:= obter_valor_param_usuario(49,7, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento);
end if;

select	max(cd_empresa)
into STRICT	cd_empresa_w
from	estabelecimento
where	cd_estabelecimento	= cd_estabelecimento_p;

select	nr_seq_ind_gestao
into STRICT	nr_seq_wheb_w
from 	ind_base
where	nr_sequencia = nr_seq_indicador_p;

select	ds_origem_inf,
	ds_sql_where
into STRICT	nm_tabela_indicador_w,
	ds_sql_where_ind_w
from	ind_base
where	nr_sequencia	= nr_seq_indicador_p;

if (ie_restringe_estab_w = 'N') then	
	ds_sql_where_ind_w := '';
end if;	
			

select	nm_atributo_drill,
	nm_tabela_referencia,
	nm_atributo_referencia,
	ds_atributo,
	IE_MOSTRA_NULO
into STRICT	nm_atributo_drill_w,
	nm_tabela_referencia_w,
	nm_atributo_referencia_w,
	nm_atrib_dimensao_w	,
	IE_MOSTRA_NULO_w
from	ind_dimensao
where	nr_sequencia		= nr_seq_dimensao_p
and	nr_seq_indicador	= nr_seq_indicador_p;

select	ds_atributo
into STRICT	nm_atrib_data_w
from	ind_data
where	nr_sequencia		= nr_seq_data_p
and	nr_seq_indicador	= nr_seq_indicador_p;

select	ds_atributo,
	ds_mascara_grid
into STRICT	nm_atrib_inf_w,
	ds_mascara_grid_w
from	ind_informacao
where	nr_sequencia		= nr_seq_informacao_p
and	nr_seq_indicador	= nr_seq_indicador_p;

ds_sql_where_w	:= ' from ';

if (ds_mascara_grid_w IS NOT NULL AND ds_mascara_grid_w::text <> '') then
	ds_sql_mascara_w	:= ', ' || chr(39) || ds_mascara_grid_w || chr(39) || ' ds_mascara ';
end if;

ie_alias_w	:= '';
if (nm_tabela_referencia_w IS NOT NULL AND nm_tabela_referencia_w::text <> '') then
	ds_sql_where_w	:= ds_sql_where_w || nm_tabela_referencia_w || ' b, ';
	ie_alias_w	:= 'b.';
end if;

ds_sql_where_w	:= ds_sql_where_w || nm_tabela_indicador_w || ' a ' ||
			' where 1 = 1 ';

if (nm_tabela_referencia_w IS NOT NULL AND nm_tabela_referencia_w::text <> '') and (nm_atributo_referencia_w IS NOT NULL AND nm_atributo_referencia_w::text <> '') then
	ds_sql_where_w	:= ds_sql_where_w || ' and b.' || nm_atributo_referencia_w || '(+)  = a.' || nm_atributo_drill_w;
end if;


ds_sql_where_w	:= ds_sql_where_w || ' ' || replace(upper(ds_sql_where_ind_w), ':CD_ESTABELECIMENTO', cd_estabelecimento_p) ||
			' ' || ds_sql_drill_p;


if (position('COUNT(' in Upper(nm_atrib_inf_w)) = 0) and (position('SUM(' in Upper(nm_atrib_inf_w)) = 0) then
	nm_atrib_inf_w	:= 'sum(' || nm_atrib_inf_w || ')';
end if;

CALL exec_sql_dinamico('TASY', ' drop table w_eis_evol_' || replace(elimina_caractere_especial(nm_usuario_p), ' ', ''));

if (IE_MOSTRA_NULO_w = 'N') then
	sql_nulo_w	:= ' and ' || nm_atrib_dimensao_w || ' is not null ';
end if;

ds_comando_protocolo_w	:= ' and somente_numero(ie_protocolo) >= ' || ie_protocolo_inicio_p ||
			   ' and somente_numero(ie_protocolo) <= ' || ie_protocolo_final_p;

if (ie_periodo_p	= 'M') then
	begin

	if (ie_tipo_data_p = 0) then
		ds_select_data_w := ' trunc(a.dt_referencia) ';
		ds_sql_data_w	:= ds_sql_data_w || ' and a.dt_referencia between to_date( ' || chr(39) || to_char(dt_referencia_p,'dd/mm/yyyy') || chr(39) || ','
				|| chr(39) || 'dd/mm/yyyy' || chr(39) || ') and last_day(add_months(trunc(' ||
				' to_date( ' || chr(39) || to_char(dt_referencia_p,'dd/mm/yyyy') || chr(39) || ','
				|| chr(39) || 'dd/mm/yyyy' || chr(39) || '),' || chr(39) || 'YEAR' || chr(39) || '),11))';
	elsif (ie_tipo_data_p = 1) then
		ds_select_data_w := ' trunc(a.dt_receita) ';
		ds_sql_data_w	:= ds_sql_data_w || ' and a.dt_receita between to_date( ' || chr(39) || to_char(dt_referencia_p,'dd/mm/yyyy') || chr(39) || ','
				|| chr(39) || 'dd/mm/yyyy' || chr(39) || ') and last_day(add_months(trunc(' ||
				' to_date( ' || chr(39) || to_char(dt_referencia_p,'dd/mm/yyyy') || chr(39) || ','
				|| chr(39) || 'dd/mm/yyyy' || chr(39) || '),' || chr(39) || 'YEAR' || chr(39) || '),11))';
	elsif (ie_tipo_data_p = 2) then
		ds_select_data_w := ' trunc(a.dt_referencia) ';
		ds_sql_data_w	:= ds_sql_data_w || ' and a.dt_referencia between to_date( ' || chr(39) || to_char(dt_referencia_p,'dd/mm/yyyy') || chr(39) || ','
				|| chr(39) || 'dd/mm/yyyy' || chr(39) || ') and last_day(add_months(trunc(' ||
				' to_date( ' || chr(39) || to_char(dt_referencia_p,'dd/mm/yyyy') || chr(39) || ','
				|| chr(39) || 'dd/mm/yyyy' || chr(39) || '),' || chr(39) || 'YEAR' || chr(39) || '),11))';
	end if;


	if (ie_tipo_data_p = 0) then		
		ds_comando_w		:= ' select substr(' || ie_alias_w || nm_atrib_dimensao_w || ',1,255) ds_dimensao, substr(a.' || nm_atributo_drill_w || ',1,255) cd_dimensao, ' || nm_atrib_inf_w ||
					   ' vl_data,  ' || ds_select_data_w || 'dt_data ' || ds_sql_mascara_w || ds_sql_where_w || ds_sql_data_w || sql_nulo_w || ds_comando_protocolo_w || ds_sql_filtro_p ||
					   ' group by substr(' || ie_alias_w || nm_atrib_dimensao_w || ',1,255), substr(a.' || nm_atributo_drill_w || ',1,255), ' || ds_select_data_w;

		ds_comando_w	:= replace(upper(ds_comando_w), ':CD_EMPRESA', cd_empresa_w);
		ds_comando_w	:= replace(upper(ds_comando_w), ':CD_ESTAB_EVENTO', cd_estabelecimento_p);

		CALL exec_sql_dinamico('TASY', ' create table w_eis_evol_' || replace(elimina_caractere_especial(nm_usuario_p), ' ', '') || nm_tablespace_w || ' as ' || ds_comando_w);
		
	else
		begin

		ds_comando_w		:= ' select substr(' || ie_alias_w || nm_atrib_dimensao_w || ',1,255) ds_dimensao, substr(a.' || nm_atributo_drill_w || ',1,255) cd_dimensao, ' || nm_atrib_inf_w ||
					   ' vl_data,  ' || ds_select_data_w || 'dt_data ' || ds_sql_mascara_w || ds_sql_where_w || ds_sql_data_w || sql_nulo_w || ds_comando_protocolo_w || ' and 1 = 2 ' ||
					   ' group by substr(' || ie_alias_w || nm_atrib_dimensao_w || ',1,255), substr(a.' || nm_atributo_drill_w || ',1,255), ' || ds_select_data_w;
	

		ds_comando_w		:= replace(upper(ds_comando_w), ':CD_EMPRESA', cd_empresa_w);
		ds_comando_w	:= replace(upper(ds_comando_w), ':CD_ESTAB_EVENTO', cd_estabelecimento_p);

		CALL exec_sql_dinamico('TASY', ' create table w_eis_evol_' || replace(elimina_caractere_especial(nm_usuario_p), ' ', '') || nm_tablespace_w || ' as ' || ds_comando_w);

		
		dt_referencia_w	:= dt_referencia_p;

				
		if (ie_tipo_data_p =  2) then		
			begin
		
			FOR 	i IN 1..12 LOOP
				begin

				ds_select_data_w := 'to_date( ' || chr(39) || to_char(dt_referencia_w,'dd/mm/yyyy') || chr(39) || ','
					|| chr(39) || 'dd/mm/yyyy' || chr(39) || ')';
	
				ds_sql_data_w	:= ' and a.dt_referencia > to_date( ' || chr(39) || to_char(dt_referencia_w,'dd/mm/yyyy') || chr(39) || ','
					|| chr(39) || 'dd/mm/yyyy' || chr(39) || ') and a.dt_receita <= to_date( ' || chr(39) || to_char(dt_referencia_w,'dd/mm/yyyy') || chr(39) || ','
					|| chr(39) || 'dd/mm/yyyy' || chr(39) || ')';


				ds_comando_w		:= ' select nvl(substr('  || ie_alias_w || nm_atrib_dimensao_w || ',1,255), ' || chr(39) || ' ' || Wheb_mensagem_pck.get_texto(800043) || ' '  || chr(39) || ') ds_dimensao, substr(a.' || nm_atributo_drill_w || ',1,255) cd_dimensao, ' || nm_atrib_inf_w ||
							   ' vl_data,  ' || ds_select_data_w || 'dt_data ' || ds_sql_mascara_w || ds_sql_where_w || ds_sql_data_w || sql_nulo_w || ds_comando_protocolo_w ||
							   ' group by substr(' || ie_alias_w || nm_atrib_dimensao_w || ',1,255), substr(a.' || nm_atributo_drill_w || ',1,255), ' || ds_select_data_w;

				ds_comando_w		:= replace(ds_comando_w, ':CD_EMPRESA', cd_empresa_w);
				
				CALL exec_sql_dinamico('TASY', ' insert into w_eis_evol_' || replace(elimina_caractere_especial(nm_usuario_p), ' ', '') || '( ' || ds_comando_w || ' ) ');


				dt_referencia_w	:= add_months(dt_referencia_p, i);
		
				end;
			end loop;
			end;
		else
			begin
		
			FOR 	i IN 1..12 LOOP
				begin

				ds_select_data_w := 'to_date( ' || chr(39) || to_char(dt_referencia_w,'dd/mm/yyyy') || chr(39) || ','
					|| chr(39) || 'dd/mm/yyyy' || chr(39) || ')';
	
				ds_sql_data_w	:= ' and a.dt_receita = to_date( ' || chr(39) || to_char(dt_referencia_w,'dd/mm/yyyy') || chr(39) || ','
					|| chr(39) || 'dd/mm/yyyy' || chr(39) || ')';


				ds_comando_w		:= ' select nvl(substr('  || ie_alias_w || nm_atrib_dimensao_w || ',1,255), ' || chr(39) || ' ' || Wheb_mensagem_pck.get_texto(800043) || ' ' || chr(39) || ') ds_dimensao, substr(a.' || nm_atributo_drill_w || ',1,255) cd_dimensao, ' || nm_atrib_inf_w ||
							   ' vl_data,  ' || ds_select_data_w || 'dt_data ' || ds_sql_mascara_w || ds_sql_where_w || ds_sql_data_w || sql_nulo_w || ds_comando_protocolo_w || ds_sql_filtro_p ||
							   ' group by substr(' || ie_alias_w || nm_atrib_dimensao_w || ',1,255), substr(a.' || nm_atributo_drill_w || ',1,255), ' || ds_select_data_w;
				
				ds_comando_w		:= replace(ds_comando_w, ':CD_EMPRESA', cd_empresa_w);

				CALL exec_sql_dinamico('TASY', ' insert into w_eis_evol_' || replace(elimina_caractere_especial(nm_usuario_p), ' ', '') || '( ' || ds_comando_w || ' ) ');


				dt_referencia_w	:= add_months(dt_referencia_p, i);
		
				end;
			end loop;
			end;
		end if;
		end;
	end if;

	end;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE dashboard_evol_ind_result (cd_estabelecimento_p bigint, ie_periodo_p text, nr_seq_indicador_p bigint, dt_referencia_p timestamp, nr_seq_dimensao_p bigint, nr_seq_informacao_p bigint, nr_seq_data_p bigint, nm_usuario_p text, ds_sql_filtro_p text, ds_sql_drill_p text, ie_protocolo_inicio_p bigint, ie_protocolo_final_p bigint, ie_tipo_data_p bigint, ie_restringe_estab_p text) FROM PUBLIC;

