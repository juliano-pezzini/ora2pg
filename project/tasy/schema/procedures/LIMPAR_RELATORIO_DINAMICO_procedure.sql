-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE limpar_relatorio_dinamico ( nr_seq_relatorio_p relatorio.nr_sequencia%type ) AS $body$
DECLARE


C01 CURSOR FOR
  SELECT prd.nr_sequencia,
         prd.nr_seq_relatorio_parametro
    FROM parametro_relat_dinamico prd
   WHERE prd.nr_seq_relatorio = nr_seq_relatorio_p
     AND prd.ie_gerado_auto = 'S';

TYPE t_nr_seq_param IS TABLE OF parametro_relat_dinamico.nr_sequencia%TYPE;
TYPE t_nr_seq_relatorio_parametro IS TABLE OF parametro_relat_dinamico.nr_seq_relatorio_parametro%TYPE;

t_nr_seq_param_array t_nr_seq_param;
t_nr_seq_rel_parametro_array t_nr_seq_relatorio_parametro;


BEGIN

  DELETE
    FROM banda_relat_campo brc
   WHERE brc.nr_seq_banda IN (
          SELECT DISTINCT nr_sequencia
            FROM banda_relatorio br
           WHERE br.nr_seq_relatorio = nr_seq_relatorio_p
             AND br.ie_banda_padrao = 'S'
       );
   commit;

  DELETE
    FROM banda_relatorio br
   WHERE br.nr_seq_relatorio = nr_seq_relatorio_p
     AND br.ie_banda_padrao = 'S';
  commit;

  UPDATE parametro_relat_dinamico prd
     SET prd.nr_seq_relatorio_parametro  = NULL
   WHERE prd.nr_sequencia in (
          SELECT prd.nr_sequencia
          FROM parametro_relat_dinamico prd
         WHERE prd.nr_seq_relatorio = nr_seq_relatorio_p
           AND prd.ie_gerado_auto = 'S'
   );
   COMMIT;

  OPEN C01;
  LOOP
    FETCH C01 BULK COLLECT INTO t_nr_seq_param_array, t_nr_seq_rel_parametro_array LIMIT 1000;

      BEGIN
        FORALL i IN 1..t_nr_seq_param_array.COUNT
          DELETE
            FROM relatorio_parametro rp
           WHERE rp.nr_seq_relatorio = t_nr_seq_rel_parametro_array(i);
           COMMIT;
      END;

    EXIT WHEN NOT FOUND; /* apply on C01 */

  END LOOP;
  CLOSE C01;

  COMMIT;
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE limpar_relatorio_dinamico ( nr_seq_relatorio_p relatorio.nr_sequencia%type ) FROM PUBLIC;

