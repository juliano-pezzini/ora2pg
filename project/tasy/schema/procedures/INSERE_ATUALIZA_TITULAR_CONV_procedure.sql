-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE insere_atualiza_titular_conv ( nm_usuario_p text, cd_convenio_p bigint, cd_categoria_p text, cd_pessoa_fisica_p text, cd_plano_convenio_p text, dt_inicio_vigencia_p timestamp, dt_fim_vigencia_p timestamp, dt_validade_carteira_p timestamp, cd_pessoa_titular_p text, cd_usuario_convenio_p text, nr_seq_pessoa_doc_p bigint, ie_commit_p text DEFAULT 'S', ie_validation_p text DEFAULT '1', ie_tipo_conveniado_p bigint default 0, ekvk_cd_pessoa_fisica_p text default null, ekvk_nm_pais_p text default null, ekvk_nr_cartao_p text default null, ekvk_nr_conv_p text default null, ekvk_sg_conv_p text default null, ekvk_nr_seq_tipo_doc_p bigint default null, ekvk_dt_inicio_p timestamp default null, ekvk_dt_fim_p timestamp default null, nr_seq_conv_categ_seg_p bigint default null, nr_seq_categoria_iva_p pessoa_titular_convenio.nr_seq_categoria_iva%type default null) AS $body$
DECLARE


			nr_seq_pessoa_doc_w	pessoa_titular_convenio.nr_seq_pessoa_doc%type := null;
			nr_sequencia_w		pessoa_titular_convenio.nr_sequencia%type := null;
			ie_count_w		varchar(1);
			nr_seq_categoria_iva_w	categoria_convenio.nr_seq_categoria_iva%type;

/* ie_validation_p : Checks with below conditions
1 (default) - NR_SEQ_PESSOA_DOC
2 - insurance and membership number */
BEGIN

if (ie_validation_p = 1) then
	select	max(nr_seq_pessoa_doc)
	into STRICT	nr_seq_pessoa_doc_w
	from	pessoa_titular_convenio
	where	nr_seq_pessoa_doc = nr_seq_pessoa_doc_p;
else	
	/*
	 * Added below code as part to avoid unique key violation while inserting.
	 */
	
	select 	CASE WHEN count(*)=0 THEN  'N'  ELSE 'S' END
	into STRICT	ie_count_w
	from 	pessoa_titular_convenio 
	where 	cd_convenio = cd_convenio_p and 
		cd_categoria = cd_categoria_p and 
		((coalesce(cd_usuario_convenio::text, '') = '' and coalesce(cd_usuario_convenio_p::text, '') = '') or cd_usuario_convenio = cd_usuario_convenio_p) and
		((coalesce(dt_inicio_vigencia::text, '') = '' and coalesce(dt_inicio_vigencia_p::text, '') = '' ) or dt_inicio_vigencia = dt_inicio_vigencia_p) and
		((coalesce(cd_pessoa_titular::text, '') = '' and coalesce(cd_pessoa_titular_p::text, '') = '' ) or cd_pessoa_titular = cd_pessoa_titular_p) and
		((coalesce(nr_seq_categoria_iva::text, '') = '' and coalesce(nr_seq_categoria_iva_p::text, '') = '' ) or nr_seq_categoria_iva = nr_seq_categoria_iva_p) and
		cd_pessoa_fisica = cd_pessoa_fisica_p;
		
	if ie_count_w = 'S' then
		return;
	end if;

	select	max(nr_sequencia)
	into STRICT	nr_sequencia_w
	from	pessoa_titular_convenio
	where 	cd_convenio = cd_convenio_p
	and	((coalesce(cd_usuario_convenio_p::text, '') = '' and cd_pessoa_fisica = cd_pessoa_fisica_p) or
		 cd_usuario_convenio = cd_usuario_convenio_p);
		
	if (coalesce(nr_sequencia_w::text, '') = '' and coalesce(pkg_i18n.get_user_locale, 'pt_BR') = 'de_DE') then
	
		select	max(nr_sequencia)
		into STRICT	nr_sequencia_w
		from	pessoa_titular_convenio
		where 	cd_convenio = cd_convenio_p 
		and	 	cd_pessoa_fisica = cd_pessoa_fisica_p
		and (coalesce(dt_inicio_vigencia_p::text, '') = '' or ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_vigencia) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_inicio_vigencia_p))
		and (coalesce(dt_fim_vigencia_p::text, '') = '' or ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_fim_vigencia) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_fim_vigencia_p));

	end if;

end if;

if (coalesce(nr_seq_categoria_iva_p::text, '') = '')then

	select	get_category_vat(cd_pessoa_fisica_p, cd_convenio_p, cd_categoria_p)
	into STRICT	nr_seq_categoria_iva_w
	;

else
	nr_seq_categoria_iva_w := nr_seq_categoria_iva_p;
end if;	


begin
if (coalesce(nr_seq_pessoa_doc_w::text, '') = '') and (coalesce(nr_sequencia_w::text, '') = '') then
	begin
	
	insert into pessoa_titular_convenio(
		nr_sequencia,	
		dt_atualizacao_nrec,
		nm_usuario_nrec,
		dt_atualizacao,
		nm_usuario,
		cd_pessoa_fisica,
		cd_pessoa_titular,
		cd_convenio,
		cd_categoria,
		cd_plano_convenio,
		dt_inicio_vigencia,
		dt_fim_vigencia,
		dt_validade_carteira,
		cd_usuario_convenio,
		nr_seq_pessoa_doc,
        ie_tipo_conveniado,
    nr_seq_conv_categ_seg,
		ekvk_cd_pessoa_fisica,
		ekvk_nm_pais,
		ekvk_nr_cartao,
		ekvk_nr_conv,
        ekvk_sg_conv,
		ekvk_nr_seq_tipo_doc,
		ekvk_dt_inicio,
		ekvk_dt_fim,
		nr_seq_categoria_iva)
	values (nextval('pessoa_titular_convenio_seq'),
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		cd_pessoa_fisica_p,
		cd_pessoa_titular_p,
		cd_convenio_p,
		cd_categoria_p,
		cd_plano_convenio_p,
		dt_inicio_vigencia_p,
		dt_fim_vigencia_p,
		dt_validade_carteira_p,
		cd_usuario_convenio_p,
		nr_seq_pessoa_doc_p,
        ie_tipo_conveniado_p,
    nr_seq_conv_categ_seg_p,
		ekvk_cd_pessoa_fisica_p,
		ekvk_nm_pais_p,
		ekvk_nr_cartao_p,
		ekvk_nr_conv_p,
        ekvk_sg_conv_p,
		ekvk_nr_seq_tipo_doc_p,
		ekvk_dt_inicio_p,
		ekvk_dt_fim_p,
		nr_seq_categoria_iva_w);
  end;
else
	begin
	update	pessoa_titular_convenio
	set	dt_atualizacao = clock_timestamp(),
		nm_usuario = nm_usuario_p,
		cd_pessoa_fisica = coalesce(cd_pessoa_fisica_p,cd_pessoa_fisica),
		cd_pessoa_titular = coalesce(cd_pessoa_titular_p,cd_pessoa_titular),
		cd_convenio = coalesce(cd_convenio_p,cd_convenio),
		cd_categoria = coalesce(cd_categoria_p,cd_categoria),
		cd_plano_convenio = coalesce(cd_plano_convenio_p,cd_plano_convenio),
		dt_inicio_vigencia = coalesce(dt_inicio_vigencia_p,dt_inicio_vigencia),
		dt_fim_vigencia = coalesce(dt_fim_vigencia_p,dt_fim_vigencia),
		dt_validade_carteira = coalesce(dt_validade_carteira_p,dt_validade_carteira),
		cd_usuario_convenio = coalesce(cd_usuario_convenio_p,cd_usuario_convenio),
		ekvk_cd_pessoa_fisica = coalesce(ekvk_cd_pessoa_fisica_p,ekvk_cd_pessoa_fisica),
		ekvk_nm_pais = coalesce(ekvk_nm_pais_p,ekvk_nm_pais),
		ekvk_nr_cartao = coalesce(ekvk_nr_cartao_p,ekvk_nr_cartao),
		ekvk_nr_conv = coalesce(ekvk_nr_conv_p,ekvk_nr_conv),
        ekvk_sg_conv = coalesce(ekvk_sg_conv_p,ekvk_sg_conv),
		ekvk_nr_seq_tipo_doc = coalesce(ekvk_nr_seq_tipo_doc_p,ekvk_nr_seq_tipo_doc),
		ekvk_dt_inicio = coalesce(ekvk_dt_inicio_p,ekvk_dt_inicio),
		ekvk_dt_fim = coalesce(ekvk_dt_fim_p,ekvk_dt_fim),
		nr_seq_conv_categ_seg = coalesce(nr_seq_conv_categ_seg_p, nr_seq_conv_categ_seg),
		nr_seq_categoria_iva = coalesce(nr_seq_categoria_iva_w, nr_seq_categoria_iva)
		where 	((coalesce(nr_seq_pessoa_doc_w, 0) > 0 and nr_seq_pessoa_doc = coalesce(nr_seq_pessoa_doc_w, 0))
		or (coalesce(nr_sequencia_w, 0) > 0 and nr_sequencia = coalesce(nr_sequencia_w, 0)));
  end;
end if;
exception
when unique_violation then
	nr_sequencia_w	:=	null;
when others then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(sqlerrm);
end;

if (ie_commit_p = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE insere_atualiza_titular_conv ( nm_usuario_p text, cd_convenio_p bigint, cd_categoria_p text, cd_pessoa_fisica_p text, cd_plano_convenio_p text, dt_inicio_vigencia_p timestamp, dt_fim_vigencia_p timestamp, dt_validade_carteira_p timestamp, cd_pessoa_titular_p text, cd_usuario_convenio_p text, nr_seq_pessoa_doc_p bigint, ie_commit_p text DEFAULT 'S', ie_validation_p text DEFAULT '1', ie_tipo_conveniado_p bigint default 0, ekvk_cd_pessoa_fisica_p text default null, ekvk_nm_pais_p text default null, ekvk_nr_cartao_p text default null, ekvk_nr_conv_p text default null, ekvk_sg_conv_p text default null, ekvk_nr_seq_tipo_doc_p bigint default null, ekvk_dt_inicio_p timestamp default null, ekvk_dt_fim_p timestamp default null, nr_seq_conv_categ_seg_p bigint default null, nr_seq_categoria_iva_p pessoa_titular_convenio.nr_seq_categoria_iva%type default null) FROM PUBLIC;

