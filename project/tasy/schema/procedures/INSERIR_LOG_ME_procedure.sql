-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE inserir_log_me ( ie_funcao_p text, nr_documento_p bigint, ds_status_p text, ie_evento_p text, ds_log_p text, nr_log_p text, nm_usuario_p text, ie_tipo_log_p text, nr_prepedido_p bigint default null, nr_seq_pedido_p bigint default null) AS $body$
DECLARE

				
nr_solic_compra_w		bigint;
nr_ordem_compra_w		bigint;
nr_seq_nf_w			bigint;
dt_documento_w			timestamp;
ds_stack			varchar(2000);		
ie_acao_w			sup_log_integracao.ie_acao%type;
ie_evento_w			sup_log_integracao.ie_evento%type;				

BEGIN

nr_solic_compra_w		:= null;
nr_ordem_compra_w		:= null;
nr_seq_nf_w			:= null;

if (ie_funcao_p = 'SC') then
	nr_solic_compra_w	:= nr_documento_p;
	
	select 	max(dt_solicitacao_compra)
	into STRICT	dt_documento_w
	from 	solic_compra
	where	nr_solic_compra = nr_solic_compra_w;
elsif (ie_funcao_p = 'OC') then
	nr_ordem_compra_w	:= nr_documento_p;
	
	select 	max(dt_ordem_compra)
	into STRICT	dt_documento_w
	from 	ordem_compra
	where	nr_ordem_compra = nr_ordem_compra_w;
elsif (ie_funcao_p = 'NF') then
	nr_seq_nf_w		:= nr_documento_p;
	
	select 	max(dt_emissao)
	into STRICT	dt_documento_w
	from 	nota_fiscal
	where	nr_sequencia = nr_seq_nf_w;
end if;

ds_stack	:=	substr(dbms_utility.format_call_stack,1, 2000);

/*Falha no recebimento da ordem de compra*/

if	((ds_stack like '%ALTERA_PEDIDO_ME%') or (ds_stack like '%GERAR_W_ME_ALTERA_PEDIDO%') or (ds_stack like '%GERAR_W_ME_ALTERA_PEDIDO_ITEM%') or (ds_stack like '%GERAR_W_ME_ALT_PED_ITEM_ENT%')) then
	ie_evento_w	:=	'FRAOC';
	ie_acao_w	:=	'ALT';
/*Falha no recebimento do cancelamento da ordem de compra*/

elsif	((ds_stack like '%CANCELA_PEDIDO_ME%') or (ds_stack like '%GERAR_W_ME_CANCELA_PEDIDO%') or (ds_stack like '%GERAR_W_ME_CANCELA_PED_ITENS%') or (ds_stack like '%GERAR_W_ME_CANC_PED_ITENS_ENT%')) then
	ie_evento_w	:=	'FRCOC';
	ie_acao_w	:=	'CAN';
/*Falha no recebimento da ordem de compra*/

elsif	((ds_stack like '%GERAR_PEDIDO_ME%') or (ds_stack like '%GERAR_W_ME_PEDIDO%') or (ds_stack like '%GERAR_W_ME_PEDIDO_ITENS%') or (ds_stack like '%GERAR_W_ME_PEDIDO_ITENS_ENT%')) then
	ie_evento_w	:=	'FROC';
	ie_acao_w	:=	'INC';
end if;


CALL sup_gerar_log_integracao(	
	nr_documento_p,
	nr_seq_pedido_p,
	ie_acao_w,
	ds_status_p,
	dt_documento_w,
	clock_timestamp(),
	ds_log_p,
	ie_evento_w,
	nm_usuario_p,

	'N',
	ie_funcao_p);

insert into log_me(
	nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_solic_compra,
	nr_ordem_compra,	
	nr_seq_nf,
	ds_status,
	ie_evento,
	ds_log,
	nr_log,
	nr_seq_pedido,
	nr_prepedido,
	ie_tipo_log)
values (	nextval('log_me_seq'),
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_solic_compra_w,
	nr_ordem_compra_w,
	nr_seq_nf_w,
	ds_status_p,
	ie_evento_p,
	ds_log_p,
	nr_log_p,
	nr_seq_pedido_p,
	nr_prepedido_p,
	ie_tipo_log_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE inserir_log_me ( ie_funcao_p text, nr_documento_p bigint, ds_status_p text, ie_evento_p text, ds_log_p text, nr_log_p text, nm_usuario_p text, ie_tipo_log_p text, nr_prepedido_p bigint default null, nr_seq_pedido_p bigint default null) FROM PUBLIC;

