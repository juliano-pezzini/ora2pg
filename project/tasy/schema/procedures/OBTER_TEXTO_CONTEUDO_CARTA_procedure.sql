-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_texto_conteudo_carta ( NM_USUARIO_P text, CD_CHAVE_P text, IE_OPCAO_P text default 'A', NR_SEQ_RESULT_P bigint default 0, NR_SEQ_RESULT_ITEM_P bigint default 0, NR_SEQ_CARTA_P bigint default 0, DS_TEXTO_P INOUT text DEFAULT NULL) AS $body$
DECLARE


ie_conteudo_w	varchar(1);
ds_retorno_w	text;
nr_seq_carta_w	bigint;


BEGIN
	nr_seq_carta_w := NR_SEQ_CARTA_P;

	select	coalesce(max('S'),'N')
	into STRICT	ie_conteudo_w
	from	carta_conteudo
	where	((coalesce(nr_seq_cirurgia,nr_seq_alergia,nr_seq_diag_doenca,cd_evolucao,nr_seq_medic_uso,nr_seq_comorbidade,nr_seq_procedimento,nr_prescricao,nr_seq_prescricao, nr_seq_proc_pac,nr_seq_laudo,nr_seq_kv_item) = cd_chave_p
	and     ie_opcao_p <> 'EL') or (ie_opcao_p = 'EL' and nr_prescricao = nr_seq_result_p and nr_seq_prescricao = nr_seq_result_item_p))
	and		nr_seq_carta = nr_seq_carta_w;

	if (ie_conteudo_w = 'S') then
		select 	ds_texto
		into STRICT	ds_retorno_w
		from	carta_conteudo
		where	((ie_opcao_p <> 'EL' and coalesce(nr_seq_cirurgia,nr_seq_alergia,nr_seq_diag_doenca,cd_evolucao,nr_seq_medic_uso,nr_seq_comorbidade,nr_seq_procedimento,nr_prescricao,nr_seq_prescricao, nr_seq_proc_pac,nr_seq_laudo,nr_seq_kv_item) = cd_chave_p)
		or (ie_opcao_p = 'EL' and nr_prescricao = nr_seq_result_p and nr_seq_prescricao = nr_seq_result_item_p))
		and		nr_seq_carta = nr_seq_carta_w;
	end if;

	ds_texto_p := ds_retorno_w;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_texto_conteudo_carta ( NM_USUARIO_P text, CD_CHAVE_P text, IE_OPCAO_P text default 'A', NR_SEQ_RESULT_P bigint default 0, NR_SEQ_RESULT_ITEM_P bigint default 0, NR_SEQ_CARTA_P bigint default 0, DS_TEXTO_P INOUT text DEFAULT NULL) FROM PUBLIC;

