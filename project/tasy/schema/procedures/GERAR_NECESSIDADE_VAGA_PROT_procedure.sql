-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_necessidade_vaga_prot ( nr_atendimento_p bigint, nr_seq_protocolo_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_tipo_solicitacao_w	varchar(5);
cd_tipo_vaga_w			varchar(5);
cd_motivo_transf_w		bigint;
cd_setor_desejado_w		integer;
cd_tipo_acomodacao_w	smallint;
cd_convenio_w			integer;
cd_categoria_w			varchar(10);
cd_plano_w				varchar(10);
cd_procedimento_w		bigint;
nr_seq_proc_interno_w	bigint;
ds_hd_me_w				varchar(4000);
cd_clinica_w			integer;
cd_doenca_cid_w			varchar(10);
ie_nec_isolamento_w		varchar(1);
ie_nec_dialise_w		varchar(1);
ie_origem_proced_w		bigint;
cd_pessoa_fisica_w		varchar(10);
nr_atendimento_w		bigint;
cd_especialidade_w		integer;
nr_sequencia_w gestao_vaga.nr_sequencia%TYPE;


BEGIN
select	max(cd_tipo_solicitacao),
		max(cd_tipo_vaga),
		max(cd_motivo_transf),
		max(cd_setor_desejado),
		max(cd_tipo_acomodacao),
		max(cd_convenio),
		max(cd_categoria),
		max(cd_plano),
		max(cd_procedimento),
		max(nr_seq_proc_interno),
		max(ds_hd_me),
		max(cd_clinica),
		max(cd_doenca_cid),
		max(ie_nec_isolamento),
		max(ie_nec_dialise),
		max(ie_origem_proced)
into STRICT	cd_tipo_solicitacao_w,
		cd_tipo_vaga_w,
		cd_motivo_transf_w,
		cd_setor_desejado_w,
		cd_tipo_acomodacao_w,
		cd_convenio_w,
		cd_categoria_w,
		cd_plano_w,
		cd_procedimento_w,
		nr_seq_proc_interno_w,
		ds_hd_me_w,
		cd_clinica_w,
		cd_doenca_cid_w,
		ie_nec_isolamento_w,
		ie_nec_dialise_w,
		ie_origem_proced_w
from	gestao_vaga_protocolo
where	nr_sequencia = nr_seq_protocolo_p;


select	max(cd_pessoa_fisica)
into STRICT	cd_pessoa_fisica_w
from	usuario
where	nm_usuario = nm_usuario_p;


nr_atendimento_w	:= nr_atendimento_p;

select	coalesce(max(nr_atendimento),nr_atendimento_p)
into STRICT	nr_atendimento_w
from	atendimento_paciente
where	nr_atend_alta	= nr_atendimento_p;

nr_sequencia_w := Gerar_necessidade_vaga(	nr_atendimento_w, cd_tipo_solicitacao_w, cd_tipo_vaga_w, cd_motivo_transf_w, cd_setor_desejado_w, cd_tipo_acomodacao_w, null, cd_convenio_w, cd_categoria_w, cd_plano_w, ds_hd_me_w, cd_procedimento_w, ie_origem_proced_w, nm_usuario_p, nr_seq_proc_interno_w, cd_pessoa_fisica_w, cd_clinica_w, cd_doenca_cid_w, ie_nec_isolamento_w, ie_nec_dialise_w, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, nr_sequencia_w);
			
select 	max(coalesce(cd_especialidade,0))
into STRICT	cd_especialidade_w
from   	atendimento_alta a, parametro_medico b
where  	nr_atendimento = coalesce(nr_atendimento_w,nr_atendimento_p)
and     b.cd_estabelecimento = obter_estabelecimento_Ativo
and		coalesce(ie_desfecho,'I') = 'I'
and     ((ie_tipo_orientacao <> 'P')
or (coalesce(b.ie_liberar_desfecho,'N')  = 'N')
or      ((a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '') and (coalesce(a.dt_inativacao::text, '') = '')));

if (cd_especialidade_w <> 0) then
	update	gestao_vaga
	set	cd_especialidade = cd_especialidade_w
	where	nr_atendimento   = coalesce(nr_atendimento_w,nr_atendimento_p)
	and	trunc(dt_atualizacao) = trunc(clock_timestamp());
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_necessidade_vaga_prot ( nr_atendimento_p bigint, nr_seq_protocolo_p bigint, nm_usuario_p text) FROM PUBLIC;

