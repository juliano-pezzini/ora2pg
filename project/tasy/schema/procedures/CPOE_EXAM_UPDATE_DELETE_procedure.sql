-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cpoe_exam_update_delete (nr_sequencia_p bigint, dt_agenda_p timestamp default null, nr_sequencia_new_p bigint default null) AS $body$
DECLARE


nr_cpoe_pre_cons_exam_w     cpoe_pre_cons_link.nr_cpoe_pre_cons_exam%type;
nr_pre_cons                 bigint;

c01 CURSOR FOR
        SELECT  nr_cpoe_pre_cons_exam
        from    cpoe_pre_cons_link
        where   nr_consulta_agenda_seq = nr_sequencia_p
        and     (nr_cpoe_pre_cons_exam IS NOT NULL AND nr_cpoe_pre_cons_exam::text <> '');


BEGIN

    select  count(*)
    into STRICT    nr_pre_cons
    from    cpoe_pre_cons_link
    WHERE   nr_consulta_agenda_seq = nr_sequencia_p;

    IF ( nr_pre_cons > 0 ) THEN
        IF ( coalesce(dt_agenda_p::text, '') = '' ) THEN
            OPEN c01;
            LOOP
                FETCH c01 INTO nr_cpoe_pre_cons_exam_w;
                EXIT WHEN NOT FOUND; /* apply on c01 */

                DELETE  FROM cpoe_pre_cons_link
                WHERE   nr_consulta_agenda_seq = nr_sequencia_p
                AND     nr_cpoe_pre_cons_exam = nr_cpoe_pre_cons_exam_w;

                UPDATE  prescr_procedimento
                SET     dt_suspensao = clock_timestamp()
                WHERE   nr_seq_proc_cpoe = nr_cpoe_pre_cons_exam_w;

                UPDATE  cpoe_procedimento
                SET     dt_suspensao = clock_timestamp(),
			 dt_lib_suspensao = clock_timestamp()
                WHERE   nr_sequencia = nr_cpoe_pre_cons_exam_w;

            END LOOP;

            CLOSE c01;
        ELSE
            OPEN c01;
            LOOP
                FETCH c01 INTO nr_cpoe_pre_cons_exam_w;
                EXIT WHEN NOT FOUND; /* apply on c01 */

                UPDATE  prescr_procedimento
                SET     dt_prev_execucao = dt_agenda_p
                WHERE   nr_seq_proc_cpoe = nr_cpoe_pre_cons_exam_w;

                UPDATE  cpoe_procedimento
                SET     dt_pre_cons_exam = dt_agenda_p
                WHERE   nr_sequencia = nr_cpoe_pre_cons_exam_w;

            END LOOP;

            CLOSE c01;

            UPDATE  cpoe_pre_cons_link
            SET     nr_consulta_agenda_seq = nr_sequencia_new_p
            WHERE   nr_consulta_agenda_seq = nr_sequencia_p;

        END IF;

    END IF;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cpoe_exam_update_delete (nr_sequencia_p bigint, dt_agenda_p timestamp default null, nr_sequencia_new_p bigint default null) FROM PUBLIC;

