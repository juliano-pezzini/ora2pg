-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE verifica_dupl_dia_classe ( cd_material_p bigint, nr_prescricao_p bigint, nm_usuario_p text, ds_retorno_p INOUT text) AS $body$
DECLARE


cd_pessoa_fisica_w	atendimento_paciente.cd_pessoa_fisica%type;
dt_prescricao_w		timestamp;
nr_prescricao_w		bigint;
nm_medico_w			varchar(60);
ie_suspenso_w		varchar(10);
ie_consitir_susp_w	varchar(10);
cd_estabelecimento_w	estabelecimento.cd_estabelecimento%type;
cd_classe_material_w	bigint;
ie_validade_prescr_w	varchar(1);
dt_inicio_prescr_w		timestamp;

C01 CURSOR FOR
	SELECT 	distinct
			nr_prescricao,
			nm_medico,
			ie_suspenso
	from 	(
		SELECT	a.nr_prescricao,
				substr(obter_nome_medico(b.cd_medico,'N'),1,60) nm_medico,
				CASE WHEN a.ie_suspenso='S' THEN  UPPER(obter_desc_expressao(298991))  ELSE '' END  ie_suspenso
		from	material c,
				prescr_material	a,
				prescr_medica b
		where	a.nr_prescricao		= b.nr_prescricao
		and		a.cd_material		= c.cd_material
		and		c.cd_classe_material= cd_classe_material_w
		and		b.cd_pessoa_fisica	= cd_pessoa_fisica_w
		and		ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(b.dt_prescricao) = ESTABLISHMENT_TIMEZONE_UTILS.startOfDay(dt_prescricao_w) 
		and 	ie_validade_prescr_w = 'S'
		and		a.cd_material <> cd_material_p
		and		coalesce(a.ie_modificado,'N') <> 'S'
		and		((ie_consitir_susp_w	= 'S') or (coalesce(a.ie_suspenso,'N') = 'N'))
		
union all

		select	a.nr_prescricao,
				substr(obter_nome_medico(b.cd_medico,'N'),1,60) nm_medico,
				CASE WHEN a.ie_suspenso='S' THEN  UPPER(obter_desc_expressao(298991))  ELSE '' END  ie_suspenso
		from	material c,
				prescr_material	a,
				prescr_medica b
		where	a.nr_prescricao		= b.nr_prescricao
		and		a.cd_material		= c.cd_material
		and		c.cd_classe_material= cd_classe_material_w
		and		b.cd_pessoa_fisica	= cd_pessoa_fisica_w
		and 	dt_inicio_prescr_w between b.dt_inicio_prescr and b.dt_validade_prescr
		and 	ie_validade_prescr_w = 'C'
		and		a.cd_material <> cd_material_p
		and		coalesce(a.ie_modificado,'N') <> 'S'
		and		((ie_consitir_susp_w	= 'S') or (coalesce(a.ie_suspenso,'N') = 'N'))
	) alias20;

BEGIN

select	max(cd_classe_material)
into STRICT	cd_classe_material_w
from	material
where	cd_material	= cd_material_p;

select	dt_prescricao,
		cd_pessoa_fisica,
		cd_estabelecimento,
		dt_inicio_prescr
into STRICT	dt_prescricao_w,
		cd_pessoa_fisica_w,
		cd_estabelecimento_w,
		dt_inicio_prescr_w
from	prescr_medica
where	nr_prescricao = nr_prescricao_p;

ie_consitir_susp_w := Obter_Param_Usuario(924, 307, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, ie_consitir_susp_w);
ie_validade_prescr_w := Obter_Param_Usuario(924, 308, Obter_Perfil_Ativo, nm_usuario_p, cd_estabelecimento_w, ie_validade_prescr_w);

if (coalesce(ie_validade_prescr_w, 'N') <> 'N') then
	for r_c01_w in C01
	loop
		ds_retorno_p:= substr(ds_retorno_p || r_c01_w.ie_suspenso || ' ' || r_c01_w.nr_prescricao || ' ' || r_c01_w.nm_medico || chr(10) || chr(13),1,255);	
	end loop;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE verifica_dupl_dia_classe ( cd_material_p bigint, nr_prescricao_p bigint, nm_usuario_p text, ds_retorno_p INOUT text) FROM PUBLIC;

