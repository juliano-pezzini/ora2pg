-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ptu_definir_benef_imp ( nr_seq_benef_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_usuario_plano_w	varchar(13);
dt_exclusao_w		timestamp;
nr_seq_segurado_w	bigint;
cd_unimed_w		varchar(10);
cd_cart_montado_w	varchar(30);
nr_seq_congenere_w	bigint;
ie_repasse_w		varchar(10);
ie_acao_w		varchar(10);


BEGIN

select	b.cd_usuario_plano,
	b.dt_exclusao,
	b.cd_unimed,
	b.ie_repasse,
	a.nr_seq_congenere
into STRICT	cd_usuario_plano_w,
	dt_exclusao_w,
	cd_unimed_w,
	ie_repasse_w,
	nr_seq_congenere_w
from	ptu_intercambio_benef		b,
	ptu_intercambio_empresa		a
where	b.nr_seq_empresa	= a.nr_sequencia
and	b.nr_sequencia		= nr_seq_benef_p;

cd_cart_montado_w	:= '0'||cd_unimed_w||cd_usuario_plano_w;

--Buscar o codigo do beneficiario pelo cartao de intercambio como rescindio
select	max(b.nr_sequencia)
into STRICT	nr_seq_segurado_w
from	pls_segurado		b,
	pls_segurado_carteira	a
where	a.nr_seq_segurado	= b.nr_sequencia
and	b.ie_tipo_segurado	in ('T','C')
and	a.nr_cartao_intercambio	= cd_cart_montado_w
and	coalesce(ie_tipo_repasse, ie_repasse_w) = ie_repasse_w
and	coalesce(b.dt_rescisao::text, '') = '';

ie_acao_w	:= '';

--Buscar o codigo do beneficiario pelo cartao do beneficiario como rescindido
if (coalesce(nr_seq_segurado_w::text, '') = '') then
	select	max(b.nr_sequencia)
	into STRICT	nr_seq_segurado_w
	from	pls_segurado		b,
		pls_segurado_carteira	a
	where	a.nr_seq_segurado	= b.nr_sequencia
	and	b.ie_tipo_segurado	in ('T','H','C')
	and	(b.nr_seq_intercambio IS NOT NULL AND b.nr_seq_intercambio::text <> '')
	and	a.cd_usuario_plano	= cd_cart_montado_w
	and	coalesce(ie_tipo_repasse, ie_repasse_w) = ie_repasse_w
	and	coalesce(b.dt_rescisao::text, '') = '';
	
	if (coalesce(nr_seq_segurado_w::text, '') = '') then
		select	max(b.nr_sequencia)
		into STRICT	nr_seq_segurado_w
		from	pls_segurado		b,
			pls_segurado_carteira	a
		where	a.nr_seq_segurado	= b.nr_sequencia
		and	b.ie_tipo_segurado	in ('T','H','C')
		and	(b.nr_seq_intercambio IS NOT NULL AND b.nr_seq_intercambio::text <> '')
		and	a.cd_usuario_plano	= cd_cart_montado_w
		and	coalesce(ie_tipo_repasse, ie_repasse_w) = ie_repasse_w;
		
		if (nr_seq_segurado_w IS NOT NULL AND nr_seq_segurado_w::text <> '') then
			if (nr_seq_congenere_w IS NOT NULL AND nr_seq_congenere_w::text <> '') then
				select	max(ie_acao)
				into STRICT	ie_acao_w
				from	pls_regra_mov_benef_conge
				where	nr_seq_congenere	= nr_seq_congenere_w
				and	ie_benef_rescindido	= 'S'
				and	ie_tipo_contrato	= 'F';
			else
				ie_acao_w	:= 'R';
			end if;
		else
			select	max(b.nr_sequencia)
			into STRICT	nr_seq_segurado_w
			from	pls_segurado		b,
				pls_segurado_carteira	a
			where	a.nr_seq_segurado	= b.nr_sequencia
			and	b.ie_tipo_segurado 	in ('T','C')
			and 	a.nr_cartao_intercambio	= cd_cart_montado_w
			and	coalesce(ie_tipo_repasse, ie_repasse_w) = ie_repasse_w;
			
			if (nr_seq_segurado_w IS NOT NULL AND nr_seq_segurado_w::text <> '') then
				ie_acao_w	:= 'R';
			end if;
		end if;
	end if;
end if;

--Inclusao
if (coalesce(nr_seq_segurado_w::text, '') = '') then
	update	ptu_intercambio_benef
	set	ie_tipo_registro	= coalesce(ie_tipo_registro,'I')
	where	nr_sequencia		= nr_seq_benef_p;
--Exclusao
elsif (nr_seq_segurado_w IS NOT NULL AND nr_seq_segurado_w::text <> '') and (dt_exclusao_w IS NOT NULL AND dt_exclusao_w::text <> '') then
	update	ptu_intercambio_benef
	set	ie_tipo_registro	= coalesce(ie_tipo_registro,'E'),
		nr_seq_benef_encontrado	= nr_seq_segurado_w
	where	nr_sequencia		= nr_seq_benef_p;
--Alteracao
elsif (nr_seq_segurado_w IS NOT NULL AND nr_seq_segurado_w::text <> '') and (coalesce(dt_exclusao_w::text, '') = '') and (coalesce(ie_acao_w::text, '') = '') then
	update	ptu_intercambio_benef
	set	ie_tipo_registro	= coalesce(ie_tipo_registro,'A'),
		nr_seq_benef_encontrado	= nr_seq_segurado_w
	where	nr_sequencia		= nr_seq_benef_p;
--Reativacao
elsif (nr_seq_segurado_w IS NOT NULL AND nr_seq_segurado_w::text <> '') and (coalesce(dt_exclusao_w::text, '') = '') and (ie_acao_w = 'R') then
	update	ptu_intercambio_benef
	set	ie_tipo_registro	= coalesce(ie_tipo_registro,'R'),
		nr_seq_benef_encontrado	= nr_seq_segurado_w
	where	nr_sequencia		= nr_seq_benef_p;
end if;	

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ptu_definir_benef_imp ( nr_seq_benef_p bigint, nm_usuario_p text) FROM PUBLIC;

