-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE consistir_reaprazar_horario ( cd_estabelecimento_p bigint, nm_usuario_p text, nr_atendimento_p bigint, ie_tipo_item_p text, cd_item_p text, cd_intervalo_p text, qt_item_p bigint, nr_prescricoes_p text, nr_prescricao_p bigint, nr_seq_item_p bigint, nr_seq_horario_p bigint, dt_horario_desejado_p timestamp, ie_laboratorio_p text) AS $body$
DECLARE


nr_prescricao_w			bigint;
nr_seq_item_w			bigint;
nr_seq_horario_w		bigint;
dt_horario_w			timestamp;
ie_data_proc_w			varchar(15);
ie_data_lib_prescr_w	varchar(15);
ie_exibe_suspenso_w		varchar(15);
ie_dose_especial_w		varchar(1);
ie_per_dose_esp_val_w	varchar(1);
ie_perm_ant_validade_w	varchar(1);
ie_se_necessario_w		varchar(1);
ie_acm_w				varchar(1);
ie_urgencia_w			varchar(1);
dt_inicio_prescr_w		timestamp;
ds_erro_w				varchar(255) := '';
cd_setor_atendimento_w	setor_atendimento.cd_setor_atendimento%type;
ie_via_aplicacao_w		prescr_material.ie_via_aplicacao%type;
ie_agrupador_w			prescr_material.ie_agrupador%type;
ie_hora_vigente_w		varchar(2);
nr_agrupamento_w		prescr_material.nr_agrupamento%type;
nr_agrupamento_apraz_w	prescr_material.nr_agrupamento%type;
ie_medic_comp_w			varchar(1);
ie_medic_reapr_comp_w	varchar(1);
ie_consiste_w			varchar(1);
ie_cpoe_w         varchar(1);
nr_seq_cpoe_w     bigint:=null;
dt_inicio_consistencia_w  timestamp;
ie_grava_log_rastr_w	varchar(1);
nr_prescricao_log_w 	prescr_medica.nr_prescricao%type;

c01 CURSOR FOR
SELECT	a.nr_prescricao nr_prescricao, /* dietas orais */
		null nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		c.dt_horario dt_horario,
		'N' ie_dose_especial,
		'N' ie_se_necessario,
		'N' ie_acm,
		coalesce(b.ie_dose_espec_agora,'N') ie_urgencia,
		a.dt_inicio_prescr,
		null ie_agrupador,
		null ie_via_aplicacao,
		'N' ie_hora_vigente,
		a.cd_setor_atendimento,
		null nr_agrupamento
from	prescr_dieta_hor c,
		prescr_dieta b,
		prescr_medica a
where	b.nr_sequencia = c.nr_seq_dieta
and		c.nr_prescricao = b.nr_prescricao
and		b.nr_prescricao = a.nr_prescricao
and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		obter_se_contido(a.nr_prescricao, '(' || nr_prescricoes_p || ')') = 'S'
and		c.cd_refeicao = cd_item_p
and		((c.dt_horario = dt_horario_desejado_p) or (obter_se_hor_vigente_prescr(dt_horario_desejado_p,nr_prescricoes_p) = 'N'))
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		coalesce(a.ie_adep,'S') = 'S'
and		a.dt_validade_prescr > clock_timestamp()
and		a.nr_atendimento = nr_atendimento_p
and		ie_tipo_item_p = 'D'

union

select	a.nr_prescricao nr_prescricao, /* suplementos orais */
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		c.dt_horario dt_horario,
		'N' ie_dose_especial,
		coalesce(b.ie_se_necessario,'N') ie_se_necessario,
		coalesce(b.ie_acm,'N') ie_acm,
		coalesce(b.ie_urgencia,'N') ie_urgencia,
		a.dt_inicio_prescr,
		b.ie_agrupador,
		b.ie_via_aplicacao,
		obter_se_hor_vigente_prescr(dt_horario_desejado_p,nr_prescricoes_p) ie_hora_vigente,
		a.cd_setor_atendimento,
		null nr_agrupamento
from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_material = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and		coalesce(a.ie_adep,'S') = 'S'
and		b.ie_agrupador in (12)
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S'
and		b.cd_material = cd_item_p
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		coalesce(b.qt_dose,1) = coalesce(qt_item_p,1)
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		a.dt_validade_prescr > clock_timestamp()
and		a.nr_atendimento = nr_atendimento_p
and		ie_tipo_item_p = 'S'

union

select	a.nr_prescricao nr_prescricao, /* medicamentos */
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		c.dt_horario dt_horario,
		c.ie_dose_especial,
		coalesce(b.ie_se_necessario,'N') ie_se_necessario,
		coalesce(b.ie_acm,'N') ie_acm,
		coalesce(b.ie_urgencia,'N') ie_urgencia,
		a.dt_inicio_prescr,
		b.ie_agrupador,
		b.ie_via_aplicacao,
		obter_se_hor_vigente_prescr(dt_horario_desejado_p,nr_prescricoes_p) ie_hora_vigente,
		a.cd_setor_atendimento,
		b.nr_agrupamento
from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_material = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and		coalesce(a.ie_adep,'S') = 'S'
and		b.ie_agrupador in (1)
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.ie_adep,'S') = 'S'
and		coalesce(c.dt_suspensao::text, '') = ''
and		obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S'
and		a.dt_validade_prescr > clock_timestamp()
and		b.cd_material = cd_item_p
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		coalesce(b.qt_dose,1) = coalesce(qt_item_p,1)
and		((a.nr_prescricao = nr_prescricao_p) or (coalesce(nr_prescricao_p::text, '') = ''))
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		a.nr_atendimento = nr_atendimento_p
and		ie_tipo_item_p = 'M'

union

select	a.nr_prescricao nr_prescricao, /* medicamentos   NOVO*/
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		c.dt_horario dt_horario,
		c.ie_dose_especial,
		coalesce(b.ie_se_necessario,'N') ie_se_necessario,
		coalesce(b.ie_acm,'N') ie_acm,
		coalesce(b.ie_urgencia,'N') ie_urgencia,
		a.dt_inicio_prescr,
		b.ie_agrupador,
		b.ie_via_aplicacao,
		obter_se_hor_vigente_prescr(dt_horario_desejado_p,nr_prescricoes_p) ie_hora_vigente,
		a.cd_setor_atendimento,
		b.nr_agrupamento
from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_material = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and		coalesce(a.ie_adep,'S') = 'S'
and		b.ie_agrupador in (1)
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.ie_adep,'S') = 'S'
and		coalesce(c.dt_suspensao::text, '') = ''
and		obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S'
and		a.dt_validade_prescr > clock_timestamp()
and		b.cd_material = cd_item_p
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		coalesce(b.qt_dose,1) = coalesce(qt_item_p,1)
and		c.dt_horario = dt_horario_desejado_p
and		a.nr_prescricao > nr_prescricao_p
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		a.nr_atendimento = nr_atendimento_p
and		ie_tipo_item_p = 'M'

union

select	a.nr_prescricao nr_prescricao, /* materiais */
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		c.dt_horario dt_horario,
		'N' ie_dose_especial,
		coalesce(b.ie_se_necessario,'N') ie_se_necessario,
		coalesce(b.ie_acm,'N') ie_acm,
		coalesce(b.ie_urgencia,'N') ie_urgencia,
		a.dt_inicio_prescr,
		b.ie_agrupador,
		b.ie_via_aplicacao,
		obter_se_hor_vigente_prescr(dt_horario_desejado_p,nr_prescricoes_p) ie_hora_vigente,
		a.cd_setor_atendimento,
		b.nr_agrupamento
from	prescr_mat_hor c,
		prescr_material b,
		prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_material = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and		coalesce(a.ie_adep,'S') = 'S'
and		b.ie_agrupador in (2)
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S'
and		a.dt_validade_prescr > clock_timestamp()
and		b.cd_material = cd_item_p
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		coalesce(b.qt_dose,1) = coalesce(qt_item_p,1)
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		a.nr_atendimento = nr_atendimento_p
and		ie_tipo_item_p = 'MAT'

union

select	a.nr_prescricao nr_prescricao, /* procedimentos e controles de glicemia */
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		c.dt_horario dt_horario,
		'N' ie_dose_especial,
		coalesce(b.ie_se_necessario,'N') ie_se_necessario,
		coalesce(b.ie_acm,'N') ie_acm,
		coalesce(b.ie_urgencia,'N') ie_urgencia,
		a.dt_inicio_prescr,
		null ie_agrupador,
		null ie_via_aplicacao,
		'N' ie_hora_vigente,
		a.cd_setor_atendimento,
		null nr_agrupamento
from	prescr_proc_hor c,
		prescr_procedimento b,
		prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_procedimento = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		(obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w) IS NOT NULL AND (obter_data_lib_proc_adep(a.dt_liberacao, a.dt_liberacao_medico, ie_data_proc_w))::text <> '')
and		obter_se_exibir_adep_suspensos(b.dt_suspensao, ie_exibe_suspenso_w) = 'S'
and		((coalesce(b.nr_seq_exame::text, '') = '' and ie_laboratorio_p = 'N') or ((b.nr_seq_exame IS NOT NULL AND b.nr_seq_exame::text <> '') and ie_laboratorio_p = 'S'))
and		coalesce(a.ie_adep,'S') = 'S'
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S'
and		a.dt_validade_prescr > clock_timestamp()
and		b.cd_procedimento = cd_item_p
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		coalesce(b.qt_procedimento,1) = coalesce(qt_item_p,1)
and		((c.dt_horario = dt_horario_desejado_p) or (obter_se_hor_vigente_prescr(dt_horario_desejado_p,nr_prescricoes_p) = 'N'))
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		a.nr_atendimento = nr_atendimento_p
and		ie_tipo_item_p in ('P','G','C')

union

select	a.nr_prescricao nr_prescricao, /* recomendacoes */
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		c.dt_horario dt_horario,
		'N' ie_dose_especial,
		coalesce(b.ie_se_necessario,'N') ie_se_necessario,
		coalesce(b.ie_acm,'N') ie_acm,
		coalesce(b.ie_urgencia,'N') ie_urgencia,
		a.dt_inicio_prescr,
		null ie_agrupador,
		null ie_via_aplicacao,
		'N' ie_hora_vigente,
		a.cd_setor_atendimento,
		null nr_agrupamento
from	prescr_rec_hor c,
		prescr_recomendacao b,
		prescr_medica a
where	c.nr_prescricao = b.nr_prescricao
and		c.nr_seq_recomendacao = b.nr_sequencia
and		b.nr_prescricao = a.nr_prescricao
and		obter_se_prescr_lib_adep(a.dt_liberacao_medico, a.dt_liberacao, a.dt_liberacao_farmacia, ie_data_lib_prescr_w) = 'S'
and		coalesce(a.ie_adep,'S') = 'S'
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		obter_se_prescr_adep(a.nr_prescricao, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S'
and		a.dt_validade_prescr > clock_timestamp()
and		coalesce(to_char(b.cd_recomendacao),b.ds_recomendacao) = cd_item_p
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		coalesce(b.qt_recomendacao,1) = coalesce(qt_item_p,1)
and		((c.dt_horario = dt_horario_desejado_p) or (obter_se_hor_vigente_prescr(dt_horario_desejado_p,nr_prescricoes_p) = 'N'))
and		Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and		a.nr_atendimento = nr_atendimento_p
and		ie_tipo_item_p = 'R'

union

select	a.nr_sequencia nr_prescricao, /* sae */
		b.nr_sequencia nr_seq_item,
		c.nr_sequencia nr_seq_hor,
		c.dt_horario dt_horario,
		'N' ie_dose_especial,
		coalesce(b.ie_se_necessario,'N') ie_se_necessario,
		coalesce(b.ie_acm,'N') ie_acm,
		coalesce(b.ie_agora,'N') ie_urgencia,
		a.dt_inicio_prescr,
		null ie_agrupador,
		null ie_via_aplicacao,
		'N' ie_hora_vigente,
		a.cd_setor_atendimento,
		null nr_agrupamento
from	pe_prescr_proc_hor c,
		pe_prescr_proc b,
		pe_prescricao a
where	c.nr_seq_pe_proc = b.nr_sequencia
and		b.nr_seq_prescr = a.nr_sequencia
and		(a.dt_liberacao IS NOT NULL AND a.dt_liberacao::text <> '')
and		coalesce(b.ie_adep,'N') in ('S','M')
and		coalesce(c.ie_situacao,'A') = 'A'
and		coalesce(c.ie_horario_especial,'N') = 'N'
and		coalesce(c.dt_fim_horario::text, '') = ''
and		coalesce(c.dt_suspensao::text, '') = ''
and		obter_se_prescr_adep(a.nr_sequencia, b.nr_sequencia, nr_prescricao_p, nr_seq_item_p, nr_prescricoes_p) = 'S'
and		a.dt_validade_prescr > clock_timestamp()
and		b.nr_seq_proc = cd_item_p
and		coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and		((c.dt_horario = dt_horario_desejado_p) or (obter_se_hor_vigente_prescr(dt_horario_desejado_p,nr_prescricoes_p) = 'N'))
and		a.nr_atendimento = nr_atendimento_p
and		ie_tipo_item_p = 'E'

union

select	a.nr_prescricao, /* Gasoterapia*/
		b.nr_sequencia nr_seq_item,			
		c.nr_sequencia nr_seq_horario,
		c.dt_horario,
		'N',
		CASE WHEN b.ie_inicio='D' THEN 'S'  ELSE 'N' END ,
		CASE WHEN b.ie_inicio='ACM' THEN 'S'  ELSE 'N' END ,
		'N',
		a.dt_inicio_prescr,
		null ie_agrupador,
		null ie_via_aplicacao,
		'N' ie_hora_vigente,
		a.cd_setor_atendimento,
		null nr_agrupamento
from	prescr_gasoterapia	b,
		prescr_medica		a,
		prescr_gasoterapia_hor c
where	b.nr_prescricao = a.nr_prescricao
and	c.nr_seq_gasoterapia = b.nr_sequencia	
and	coalesce(c.ie_horario_especial,'N') = 'N'	
and	coalesce(c.dt_fim_horario::text, '') = ''
and	coalesce(c.dt_suspensao::text, '') = ''	
and	b.nr_seq_gas  = cd_item_p
and	Obter_se_horario_liberado(c.dt_lib_horario, c.dt_horario) = 'S'
and	a.dt_validade_prescr > clock_timestamp()
and	coalesce(b.cd_intervalo,'XPTO') = coalesce(cd_intervalo_p,'XPTO')
and	((c.dt_horario = dt_horario_desejado_p) or (obter_se_hor_vigente_prescr(dt_horario_desejado_p,nr_prescricoes_p) = 'N'))
and	a.nr_atendimento = nr_atendimento_p
and	ie_tipo_item_p = 'O'
order by
	1, 2, 3;


BEGIN

if (nr_prescricao_p IS NOT NULL AND nr_prescricao_p::text <> '') then
  nr_prescricao_log_w := nr_prescricao_p;
elsif (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') then
  nr_prescricao_log_w := obter_prescricao_horario(nr_seq_horario_p, ie_tipo_item_p, 'P');
else
  nr_prescricao_log_w := substr(nr_prescricoes_p,instr(nr_prescricoes_p,',',-1) + 1);
end if;

ie_grava_log_rastr_w := obter_rastreabilidade_adep(nr_prescricao_log_w, 'REA');

ie_data_proc_w := obter_param_usuario(924, 223, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_data_proc_w);
ie_data_lib_prescr_w := obter_param_usuario(1113, 115, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_data_lib_prescr_w);
ie_exibe_suspenso_w := obter_param_usuario(1113, 117, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_exibe_suspenso_w);
ie_per_dose_esp_val_w := obter_param_usuario(1113, 330, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_per_dose_esp_val_w);
ie_perm_ant_validade_w := obter_param_usuario(1113, 396, obter_perfil_ativo, nm_usuario_p, wheb_usuario_pck.get_cd_estabelecimento, ie_perm_ant_validade_w);

if (ie_grava_log_rastr_w = 'S') then
	CALL adep_gerar_log_rastr(substr('CONSISTIR_REAPRAZAR_HORARIO PARAMETROS IN' || chr(10) ||
	'{' || chr(10) ||
	' "qt_item_p" : "' || qt_item_p || '"' || chr(10) ||
	' "nr_seq_item_p" : "' || nr_seq_item_p || '"' || chr(10) ||
	' "nr_seq_horario_p" : "' || nr_seq_horario_p || '"' || chr(10) ||
	' "nr_prescricoes_p" : "' || nr_prescricoes_p || '"' || chr(10) ||
	' "nr_prescricao_p" : "' || nr_prescricao_p || '"' || chr(10) ||
	' "nr_atendimento_p" : "' || nr_atendimento_p || '"' || chr(10) ||
	' "ie_tipo_item_p" : "' || ie_tipo_item_p || '"' || chr(10) ||
	' "ie_laboratorio_p" : "' || ie_laboratorio_p || '"' || chr(10) ||
	' "dt_horario_desejado_p" : "' || to_char(dt_horario_desejado_p, 'dd/mm/yyyy hh24:mi:ss')|| '"' || chr(10) ||
	' "cd_item_p" : "' || cd_item_p || '"' || chr(10) ||
	' "cd_intervalo_p" : "' || cd_intervalo_p || '"' || chr(10) ||
	' "cd_estabelecimento_p" : "' || cd_estabelecimento_p || '"' || chr(10) ||
	' "nm_usuario_p" : "' || nm_usuario_p || '"' || chr(10) ||
	' "ie_perm_ant_validade_w" : "' || ie_perm_ant_validade_w || '"' || chr(10) ||
	' "ie_per_dose_esp_val_w" : "' || ie_per_dose_esp_val_w || '"' || chr(10) ||
	' "ie_exibe_suspenso_w" : "' || ie_exibe_suspenso_w || '"' || chr(10) ||
	' "ie_data_lib_prescr_w" : "' || ie_data_lib_prescr_w || '"' || chr(10) ||
	' "ie_data_proc_w" : "' || ie_data_proc_w || '"' || chr(10) ||
	'}', 0, 4000),
	wheb_usuario_pck.get_ie_commit);
end if;

if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') and (ie_tipo_item_p IS NOT NULL AND ie_tipo_item_p::text <> '') and (cd_item_p IS NOT NULL AND cd_item_p::text <> '') and (nr_prescricoes_p IS NOT NULL AND nr_prescricoes_p::text <> '') and (nr_seq_horario_p IS NOT NULL AND nr_seq_horario_p::text <> '') and (dt_horario_desejado_p IS NOT NULL AND dt_horario_desejado_p::text <> '') and (ie_laboratorio_p IS NOT NULL AND ie_laboratorio_p::text <> '') then
	
	if (ie_tipo_item_p = 'M') then
		select	max(a.nr_agrupamento)
		into STRICT	nr_agrupamento_apraz_w
		from	prescr_material	a
		where	a.nr_prescricao	= nr_prescricao_p
		and		a.nr_sequencia	= nr_seq_item_p;
		
		ie_medic_reapr_comp_w	:= coalesce(obter_se_medic_composto(nr_prescricao_p,nr_seq_item_p,nr_agrupamento_apraz_w),'N');
	end if;
		
	if (ie_grava_log_rastr_w = 'S') then
		CALL adep_gerar_log_rastr(substr('CONSISTIR_REAPRAZAR_HORARIO C01' || chr(10)||
		'{'||chr(10)||
		'"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
		'"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
		'"dt_horario_desejado_p" : "'||to_char(dt_horario_desejado_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
		'"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
		'"ie_data_proc_w" : "'||ie_data_proc_w||'",'||chr(10)||
		'"ie_exibe_suspenso_w" : "'||ie_exibe_suspenso_w||'",'||chr(10)||
		'"ie_laboratorio_p" : "'||ie_laboratorio_p||'",'||chr(10)||
		'"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
		'"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
		'"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
		'"nr_prescricoes_p" : "'||nr_prescricoes_p||'",'||chr(10)||
		'"nr_seq_item_p" : "'||nr_seq_item_p||'",'||chr(10)||
		'"qt_item_p" : "'||qt_item_p||'"}',1,1500),
		wheb_usuario_pck.get_ie_commit);
	end if;	

	open c01;
	loop
	fetch c01 into	
		nr_prescricao_w,
		nr_seq_item_w,
		nr_seq_horario_w,
		dt_horario_w,
		ie_dose_especial_w,
		ie_se_necessario_w,
		ie_acm_w,
		ie_urgencia_w,
		dt_inicio_prescr_w,
		ie_agrupador_w,
		ie_via_aplicacao_w,
		ie_hora_vigente_w,
		cd_setor_atendimento_w,
		nr_agrupamento_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		begin
				
    ie_cpoe_w := obter_se_rep_cpoe(coalesce(nr_prescricao_p, obter_max_prescr_adep(nr_prescricoes_p)));

    dt_inicio_consistencia_w := dt_inicio_prescr_w;

    if (ie_cpoe_w = 'S') then
      nr_seq_cpoe_w := obter_nr_sequencia_cpoe(nr_seq_item_p, coalesce(nr_prescricao_p, obter_max_prescr_adep(nr_prescricoes_p)), ie_tipo_item_p);
      dt_inicio_consistencia_w := adep_obter_dt_liberacao_cpoe(nr_seq_cpoe_w, ie_tipo_item_p);
    end if;

    if (ie_grava_log_rastr_w = 'S') then
		CALL adep_gerar_log_rastr(substr('CONSISTIR_REAPRAZAR_HORARIO PARAMETROS IN'|| chr(10)||
		'{'||chr(10)||
		'"cd_intervalo_p" : "'||cd_intervalo_p||'",'||chr(10)||
		'"cd_item_p" : "'||cd_item_p||'",'||chr(10)||
		'"dt_horario_desejado_p" : "'||to_char(dt_horario_desejado_p, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
		'"ie_data_lib_prescr_w" : "'||ie_data_lib_prescr_w||'",'||chr(10)||
		'"ie_data_proc_w" : "'||ie_data_proc_w||'",'||chr(10)||
		'"ie_exibe_suspenso_w" : "'||ie_exibe_suspenso_w||'",'||chr(10)||
		'"ie_laboratorio_p" : "'||ie_laboratorio_p||'",'||chr(10)||
		'"ie_tipo_item_p" : "'||ie_tipo_item_p||'",'||chr(10)||
		'"nr_atendimento_p" : "'||nr_atendimento_p||'",'||chr(10)||
		'"nr_prescricao_p" : "'||nr_prescricao_p||'",'||chr(10)||
		'"nr_prescricoes_p" : "'||nr_prescricoes_p||'",'||chr(10)||
		'"nr_seq_item_p" : "'||nr_seq_item_p||'",'||chr(10)||
		'"nr_seq_horario_p" : "'||nr_seq_horario_p||'",'||chr(10)||
		'"ie_medic_reapr_comp_w" : "'||ie_medic_reapr_comp_w||'",'||chr(10)||
		'"dt_horario_w" : "'||to_char(dt_horario_w, 'dd/mm/yyyy hh24:mi:ss')||'",'||chr(10)||
		'"nr_seq_horario_w" : "'||nr_seq_horario_w||'",'||chr(10)||
		'"ie_hora_vigente_w" : "'||ie_hora_vigente_w||'",'||chr(10)||
		'"ie_per_dose_esp_val_w" : "'||ie_per_dose_esp_val_w||'",'||chr(10)||
		'"ie_dose_especial_w" : "'||ie_dose_especial_w||'",'||chr(10)||
		'"ie_perm_ant_validade_w" : "'||ie_perm_ant_validade_w||'",'||chr(10)||
		'"ie_acm_w" : "'||ie_acm_w||'",'||chr(10)||
		'"ie_se_necessario_w" : "'||ie_se_necessario_w||'",'||chr(10)||
		'"ie_acm_w" : "'||ie_acm_w||'",'||chr(10)||
		'"dt_inicio_consistencia_w" : "'||dt_inicio_consistencia_w||'",'||chr(10)||
		'"ie_urgencia_w" : "'||ie_urgencia_w||'"}',1,4000),
		wheb_usuario_pck.get_ie_commit);
    end if;

    if (dt_horario_w = dt_horario_desejado_p) and (nr_seq_horario_w <> nr_seq_horario_p) then
			ie_consiste_w	:= 'S';
			
			if (ie_tipo_item_p = 'M') then
				ie_medic_comp_w	:= coalesce(obter_se_medic_composto(nr_prescricao_w,nr_seq_item_w,nr_agrupamento_w),'N');
				
				if (ie_medic_reapr_comp_w <> ie_medic_comp_w) then
					ie_consiste_w	:= 'N';
				elsif (ie_medic_reapr_comp_w = 'S') then
					--Verificacao de medicamento composto, se havel alguma distincao em sua composicao, o sistema nao consistira
					select	coalesce(max('N'),'S')
					into STRICT	ie_consiste_w
					from (	SELECT	x.cd_material
								from	prescr_material	x
								where	x.nr_prescricao	= nr_prescricao_w
								and		x.cd_material	<> cd_item_p
								and		x.nr_agrupamento = nr_agrupamento_w
								and		x.ie_agrupador	= 1)	a,
							(	select	x.cd_material
								from	prescr_material	x
								where	x.nr_prescricao	= nr_prescricao_p
								and		x.cd_material	<> cd_item_p
								and		x.nr_agrupamento = nr_agrupamento_apraz_w
								and		x.ie_agrupador	= 1)	b
					where	a.cd_material	<> b.cd_material  LIMIT 1;
				end if;
			end if;

			if (ie_consiste_w = 'S') then
				-- O horario desejado informado ja esta previsto/prescrito para este item!
				CALL wheb_mensagem_pck.exibir_mensagem_abort(218933);
			end if;
		elsif	((ie_hora_vigente_w = 'N') and
				((ie_per_dose_esp_val_w = 'N' AND ie_dose_especial_w = 'S') or
				((ie_perm_ant_validade_w = 'D') and
				 ((ie_acm_w <> 'S') and (ie_se_necessario_w <> 'S') and (ie_urgencia_w <> 'S') and (ie_dose_especial_w <> 'S'))) or
				(ie_perm_ant_validade_w = 'N' AND dt_horario_desejado_p < dt_inicio_consistencia_w))) then
				-- O horario desejado informado e inferior ao horario de inicio da prescriao!
				CALL wheb_mensagem_pck.exibir_mensagem_abort(218936);
		end if;
		end;
	end loop;
	close c01;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE consistir_reaprazar_horario ( cd_estabelecimento_p bigint, nm_usuario_p text, nr_atendimento_p bigint, ie_tipo_item_p text, cd_item_p text, cd_intervalo_p text, qt_item_p bigint, nr_prescricoes_p text, nr_prescricao_p bigint, nr_seq_item_p bigint, nr_seq_horario_p bigint, dt_horario_desejado_p timestamp, ie_laboratorio_p text) FROM PUBLIC;

