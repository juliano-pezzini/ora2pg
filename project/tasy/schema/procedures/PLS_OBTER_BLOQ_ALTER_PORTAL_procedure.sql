-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_obter_bloq_alter_portal ( cd_operadora_benef_p text, cd_usuario_plano_p text, ie_bloq_alter_portal_p INOUT text, nr_seq_plano_p INOUT text) AS $body$
DECLARE



ie_bloq_alter_portal_w				pls_plano_usuario_eventual.ie_bloq_alter_portal%type;
nr_seq_plano_usu_event_w			pls_plano_usuario_eventual.nr_sequencia%type;
nr_seq_plano_event_faixa_w			pls_plano_eventual_faixa.nr_sequencia%type;
qt_posicao_inicial_w				pls_plano_usuario_eventual.qt_posicao_inicial%type;
qt_posicao_final_w				pls_plano_usuario_eventual.qt_posicao_final%type;
nr_seq_plano_w					pls_plano_usuario_eventual.nr_seq_plano%type;
qt_final_empresa_w				bigint;
cd_empresa_w					bigint;
congenere_w					pls_congenere.nr_sequencia%type;

c01 CURSOR FOR
		SELECT 	nr_sequencia,
			ie_bloq_alter_portal,
			qt_posicao_inicial,
			qt_posicao_final,
			nr_seq_plano
		from	pls_plano_usuario_eventual
		where	nr_seq_congenere = congenere_w
		and	ie_situacao = 'A'
		and	((coalesce(dt_fim_vigencia::text, '') = '') or (dt_fim_vigencia > clock_timestamp()));



BEGIN

select	pls_obter_cd_seq_congenere(cd_operadora_benef_p, 'NR')
into STRICT	congenere_w
;

open C01;
	loop
	fetch C01 into
		nr_seq_plano_usu_event_w,
		ie_bloq_alter_portal_w,
		qt_posicao_inicial_w,
		qt_posicao_final_w,
		nr_seq_plano_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
		begin

		if (qt_posicao_final_w IS NOT NULL AND qt_posicao_final_w::text <> '') and (qt_posicao_inicial_w IS NOT NULL AND qt_posicao_inicial_w::text <> '') then
			qt_final_empresa_w	:= (qt_posicao_final_w - qt_posicao_inicial_w) + 1;
			/*Busca o código da empresa da carteira do beneficiário*/

			cd_empresa_w		:= substr(cd_usuario_plano_p,qt_posicao_inicial_w,qt_final_empresa_w);

			if (cd_empresa_w IS NOT NULL AND cd_empresa_w::text <> '') then
				/*Verificar se exista aquela empresa na regra do usuário eventual*/

				select	max(nr_seq_regra_plano)
				into STRICT	nr_seq_plano_event_faixa_w
				from	pls_plano_eventual_faixa
				where	nr_seq_regra_plano	= nr_seq_plano_usu_event_w
				and		cd_empresa	= cd_empresa_w;

			end if;
		end if;

		if (nr_seq_plano_event_faixa_w > 0) then
			ie_bloq_alter_portal_p := ie_bloq_alter_portal_w;
			nr_seq_plano_p := nr_seq_plano_w;
		end if;

		end;
end loop;
close C01;

if (ie_bloq_alter_portal_p = '') then
	ie_bloq_alter_portal_p := 'N';
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_obter_bloq_alter_portal ( cd_operadora_benef_p text, cd_usuario_plano_p text, ie_bloq_alter_portal_p INOUT text, nr_seq_plano_p INOUT text) FROM PUBLIC;

