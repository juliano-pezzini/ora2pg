-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cancel_multi_schedule (nr_seq_agenda_int_p bigint, nm_usuario_p text, cd_tipo_agenda_p bigint, cd_agenda_p bigint, nr_seq_agenda_p bigint, ie_encaixe_p text default 'N') AS $body$
DECLARE


cd_agenda_w			agenda_paciente.cd_agenda%type;
nr_seq_agenda_exam_w		agenda_paciente.nr_sequencia%type;
nr_seq_agenda_cons_w		agenda_consulta.nr_sequencia%type;


BEGIN


if (coalesce(ie_encaixe_p,'N') = 'N') then
	if (cd_tipo_agenda_p = 2) then

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_agenda_exam_w
		from	agenda_paciente
		where	nr_sequencia = nr_seq_agenda_p
		and	ie_status_agenda <> 'C';

		if (nr_seq_agenda_exam_w > 0) then
		    CALL alterar_status_agenda(cd_agenda_p, nr_seq_agenda_exam_w, 'C', null, null, 'N', nm_usuario_p);
		end if;

	elsif (cd_tipo_agenda_p in (3, 5)) then

		select	coalesce(max(nr_sequencia),0)
		into STRICT	nr_seq_agenda_cons_w
		from	agenda_consulta
		where	nr_sequencia = nr_seq_agenda_p
		and	ie_status_agenda <> 'C';

		if (nr_seq_agenda_cons_w > 0) then
			CALL alterar_status_agecons(cd_agenda_p, nr_seq_agenda_cons_w, 'C', null, null, 'N', nm_usuario_p,  null);
		end if;

	end if;
end if;


if (coalesce(nr_seq_agenda_int_p,0) > 0) then
	delete	from ageint_horarios_usuario
	where nr_seq_ageint_lib in (SELECT	nr_sequencia
				    from	ageint_lib_usuario
				    where	nr_seq_ageint = nr_seq_agenda_int_p);

	delete	from ageint_lib_usuario
	where	nr_seq_ageint = nr_seq_agenda_int_p;

	delete from ageint_marcacao_usuario
	where	nr_seq_ageint = nr_seq_agenda_int_p;

	delete	from agenda_integrada_item
	where	nr_seq_agenda_int = nr_seq_agenda_int_p;

	delete  from ageint_arq_anexo_email
	where	nr_seq_agenda_int = nr_seq_agenda_int_p;

	delete	from agenda_integrada
	where	nr_sequencia = nr_seq_agenda_int_p;

end if;

if (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S') then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cancel_multi_schedule (nr_seq_agenda_int_p bigint, nm_usuario_p text, cd_tipo_agenda_p bigint, cd_agenda_p bigint, nr_seq_agenda_p bigint, ie_encaixe_p text default 'N') FROM PUBLIC;

