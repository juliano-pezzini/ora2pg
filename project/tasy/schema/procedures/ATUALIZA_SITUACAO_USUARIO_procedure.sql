-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE atualiza_situacao_usuario ( ie_situacao_p text) AS $body$
DECLARE

	
nm_usuario_w		usuario.nm_usuario%type;
dt_atualizacao_w 	usuario.dt_atualizacao%type;
nm_pessoa_fisica_w	varchar(100);
ds_corpo_email_w	varchar(32000);
ds_destinatarios_w	varchar(4000);
ds_html_w	 		varchar(4000);
	
c01 CURSOR FOR
	SELECT	u.nm_usuario, u.dt_atualizacao, substr(obter_nome_pf(u.cd_pessoa_fisica), 1, 100)
	from	usuario u	
	where	u.ie_situacao = 'A'	
	and		u.ie_terceiro = 'S'
	and		u.cd_setor_atendimento = 2 --desenvolvimento
	order by u.dt_atualizacao;		
	

BEGIN
	ds_corpo_email_w := '';		
	ds_destinatarios_w := '';	
	open c01;
	loop
	fetch c01 into
		nm_usuario_w,
		dt_atualizacao_w,
		nm_pessoa_fisica_w;
	EXIT WHEN NOT FOUND; /* apply on c01 */
		if ((trunc(clock_timestamp() - dt_atualizacao_w) >= 20) and (trunc(clock_timestamp() - dt_atualizacao_w) <= 30)) then					
			ds_corpo_email_w := ds_corpo_email_w || '<tr><td>' || nm_pessoa_fisica_w || '</td><td>' || nm_usuario_w || '</td><td>' || lpad(trunc(30-(trunc(clock_timestamp() - dt_atualizacao_w))), 2, '0') || '</td>' || chr(13) || chr(10);
		elsif (trunc(clock_timestamp() - dt_atualizacao_w) > 30) then		
			update usuario set
				ie_situacao = ie_situacao_p,
				dt_atualizacao = clock_timestamp(),
				nm_usuario_atual = 'JOB_UPD_SIT_USR'
			where	nm_usuario = nm_usuario_w;
		end if;
	end loop;
	close c01;
	
	commit;		
	
	if (ds_corpo_email_w IS NOT NULL AND ds_corpo_email_w::text <> '') then
		ds_destinatarios_w := null;	
		ds_html_w :=	'<html tasy="html5">' ||
							'<head>' ||
								'<style>' ||
									'table {' ||
										'font-family: arial, sans-serif;' ||
										'border-collapse: collapse;' ||
										'width: 80%;' ||
									'}' ||									
									'td, th {' ||
										'border: 1px solid #dddddd;' ||
										'text-align: left;' ||
										'padding: 3px;' ||
									'}' ||
								'</style>' ||
							'</head>' ||
							'<body>' ||
								'<p>Dear,</p>' ||																
								'<p>The third-party users below will be blocked soon at CORP. Please check and update the users who must remain active.</p>' ||
								'<p>To keep the user active you need to update the user registration. (For example: change the password)</p>' ||
								'<table>' ||
									'<tr>' ||
										'<th>Name</th>' ||
										'<th>Users</th>' ||
										'<th>Days</th>' ||
									'</tr>' ||
									'@CORPO_TABELA@' ||
								'</table>' ||								
							'</body>' ||
						'</html>';						
		ds_corpo_email_w := replace(ds_html_w, '@CORPO_TABELA@', ds_corpo_email_w);
		if (ds_destinatarios_w IS NOT NULL AND ds_destinatarios_w::text <> '') then						
			CALL enviar_email('Attention - Third-party users at CORP', ds_corpo_email_w, 'joao.weiss@philips.com', ds_destinatarios_w, 'jpweiss', 'M');
		end if;
	end if;	
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE atualiza_situacao_usuario ( ie_situacao_p text) FROM PUBLIC;

