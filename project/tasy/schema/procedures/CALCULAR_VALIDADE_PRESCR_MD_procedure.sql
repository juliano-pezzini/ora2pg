-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE calcular_validade_prescr_md ( nr_hora_validade_p bigint, ie_user_locale_p text, dt_fim_validade_p timestamp, nr_atendimento_p bigint, dt_hora_inicio_p timestamp, dt_hora_inicio_pp INOUT timestamp, nr_hora_validade_pp INOUT bigint, dt_validade_prescr_p INOUT timestamp, ds_dt_prescr_p INOUT timestamp, dt_inicio_prescr_p INOUT timestamp ) AS $body$
DECLARE


dt_validade_prescr_w	prescr_medica.dt_validade_prescr%type;	
dt_inicio_prescr_w		prescr_medica.dt_inicio_prescr%type;
dt_hora_inicio_w        timestamp;
nr_hora_validade_w		double precision;


BEGIN

    dt_inicio_prescr_w	:= coalesce(dt_hora_inicio_p, clock_timestamp());
    dt_hora_inicio_w	:= dt_inicio_prescr_w;
    nr_hora_validade_w	:= coalesce(nr_hora_validade_p,24);

    if (ie_user_locale_p = 'en_AU') and (dt_fim_validade_p IS NOT NULL AND dt_fim_validade_p::text <> '') and (nr_hora_validade_w	< 24) then
        nr_hora_validade_w	:= obter_hora_entre_datas_md(dt_fim_validade_p,dt_hora_inicio_w);
    end if;

    if (nr_hora_validade_w > 24) then
        nr_hora_validade_w	:= 24;
    end if;

    if (nr_atendimento_p IS NOT NULL AND nr_atendimento_p::text <> '') then
        dt_validade_prescr_w := dt_inicio_prescr_w + coalesce(nr_hora_validade_w,24)/24;
    end if;	

    dt_hora_inicio_pp := dt_hora_inicio_w;
    nr_hora_validade_pp := nr_hora_validade_w;
    dt_validade_prescr_p := dt_validade_prescr_w;
    dt_inicio_prescr_p := dt_inicio_prescr_w;

END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE calcular_validade_prescr_md ( nr_hora_validade_p bigint, ie_user_locale_p text, dt_fim_validade_p timestamp, nr_atendimento_p bigint, dt_hora_inicio_p timestamp, dt_hora_inicio_pp INOUT timestamp, nr_hora_validade_pp INOUT bigint, dt_validade_prescr_p INOUT timestamp, ds_dt_prescr_p INOUT timestamp, dt_inicio_prescr_p INOUT timestamp ) FROM PUBLIC;

