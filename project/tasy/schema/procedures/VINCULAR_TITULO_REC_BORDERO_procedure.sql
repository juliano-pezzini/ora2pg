-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE vincular_titulo_rec_bordero (nr_bordero_p bigint, nr_titulo_p bigint, nm_usuario_p text) AS $body$
DECLARE



vl_saldo_titulo_w		double precision;
vl_saldo_juros_w		double precision;
vl_saldo_multa_w		double precision;
vl_nota_credito_w		double precision;
vl_desconto_w			double precision;
cd_centro_custo_desc_w		integer;
nr_Seq_motivo_desc_w		bigint;
cd_estabelecimento_w		bigint;
ie_calc_desc_juros_w		varchar(255);
dt_prev_receb_w			timestamp;
/* Projeto Multimoeda - Variáveis */

vl_abaixar_estrang_w		double precision;
vl_complemento_w		double precision;
vl_cotacao_w			double precision;
cd_moeda_bordero_w		integer;
cd_moeda_empresa_w		integer;


BEGIN

select	coalesce(vl_saldo_titulo,0),
	coalesce(vl_saldo_juros,0),
	coalesce(vl_saldo_multa,0),
	coalesce(vl_desc_previsto,0),
	cd_estabelecimento
into STRICT	vl_saldo_titulo_w,
	vl_saldo_juros_w,
	vl_saldo_multa_w,
	vl_desconto_w,
	cd_estabelecimento_w
from	titulo_receber
where	nr_titulo	= nr_titulo_p;

/* Projeto Multimoeda - Busca a moeda padrão da empresa. */

select	obter_moeda_padrao_empresa(cd_estabelecimento_w,'E')
into STRICT	cd_moeda_empresa_w
;

/* Projeto Multimoeda - Busca os dados do bordero.*/

select	max(cd_moeda),
	max(vl_cotacao)
into STRICT	cd_moeda_bordero_w,
	vl_cotacao_w
from	bordero_recebimento
where	nr_bordero = nr_bordero_p;

select	coalesce(sum(a.vl_nota_credito),0)
into STRICT	vl_nota_credito_w
from	titulo_receber_nc a
where	a.nr_titulo_rec	= nr_titulo_p
and	coalesce(a.nr_seq_liq::text, '') = '';

select	max(a.nr_seq_motivo_desc),
	max(a.cd_centro_custo)
into STRICT	nr_seq_motivo_desc_w,
	cd_centro_custo_desc_w
from	titulo_Receber_liq_desc a
where	a.nr_titulo	= nr_titulo_p
and	coalesce(a.nr_seq_liq::text, '') = ''
and	coalesce(a.nr_bordero::text, '') = '';

ie_calc_desc_juros_w := obter_param_usuario(809, 13, obter_perfil_ativo, nm_usuario_p, cd_estabelecimento_w, ie_calc_desc_juros_w);

if ( coalesce(ie_calc_desc_juros_w, 'S') in ('S','P') ) then
	/* ahoffelder - OS 295280 - 07/05/2011 - buscar juros e multa do título */

	select	max(a.dt_prev_receb) /*aamfirmo OS 839736 considerar a data de previsao do pagto do bordero antes da data atual*/
	into STRICT	dt_prev_receb_w
	from	bordero_recebimento a
	where	nr_bordero = nr_bordero_p;

	/*Se for S pega sysdate, senao continua com a data de pagamento previsto*/

	if (ie_calc_desc_juros_w = 'S') then
		dt_prev_receb_w := clock_timestamp();
	end if;

	if (coalesce(vl_saldo_juros_w,0) = 0) then
		vl_saldo_juros_w	:= coalesce(obter_juros_multa_titulo(nr_titulo_p,coalesce(dt_prev_receb_w,clock_timestamp()),'R','J'),0);
	end if;
	if (coalesce(vl_saldo_multa_w,0) = 0) then
		vl_saldo_multa_w	:= coalesce(obter_juros_multa_titulo(nr_titulo_p,coalesce(dt_prev_receb_w,clock_timestamp()),'R','M'),0);
	end if;
end if;

/* Projeto Multimoeda - Verifica se o bordero é moeda estrangeira, caso positivo calcula os valores antes de gravar na tabela. */

if (coalesce(cd_moeda_bordero_w,cd_moeda_empresa_w) <> cd_moeda_empresa_w and coalesce(vl_cotacao_w,0) <> 0) then
	vl_abaixar_estrang_w := (coalesce(vl_saldo_titulo_w,0) - coalesce(vl_nota_credito_w,0) - coalesce(vl_desconto_w,0)) / vl_cotacao_w;
	vl_complemento_w := (coalesce(vl_saldo_titulo_w,0) - coalesce(vl_nota_credito_w,0) - coalesce(vl_desconto_w,0)) - vl_abaixar_estrang_w;
else
	vl_abaixar_estrang_w := null;
	vl_complemento_w := null;
	vl_cotacao_w := null;
	cd_moeda_bordero_w := null;
end if;

insert	into bordero_tit_rec(nr_bordero,
	nr_titulo,
	dt_atualizacao,
	nm_usuario,
	vl_abaixar,
	vl_juros,
	vl_multa,
	vl_desconto,
	vl_nota_credito,
	nr_seq_motivo_desc,
	cd_centro_custo_desc,
	vl_abaixar_estrang,
	vl_complemento,
	vl_cotacao,
	cd_moeda)
values (nr_bordero_p,
	nr_titulo_p,
	clock_timestamp(),
	nm_usuario_p,
	coalesce(vl_saldo_titulo_w,0) - coalesce(vl_nota_credito_w,0) - coalesce(vl_desconto_w,0),
	vl_saldo_juros_w,
	vl_saldo_multa_w,
	coalesce(vl_desconto_w,0),
	vl_nota_credito_w,
	nr_seq_motivo_desc_w,
	cd_centro_custo_desc_w,
	vl_abaixar_estrang_w,
	vl_complemento_w,
	vl_cotacao_w,
	cd_moeda_bordero_w);

insert	into titulo_receber_liq_desc(cd_centro_custo,
	cd_cgc,
	cd_pessoa_fisica,
	dt_atualizacao,
	nm_usuario,
	nr_bordero,
	nr_Seq_liq,
	nr_seq_motivo_desc,
	nr_sequencia,
	nr_titulo)
SELECT	a.cd_centro_custo,
	a.cd_cgc,
	a.cd_pessoa_fisica,
	clock_timestamp(),
	nm_usuario_p,
	nr_bordero_p,
	null,
	a.nr_seq_motivo_desc,
	nextval('titulo_receber_liq_desc_seq'),
	nr_titulo_p
from	titulo_receber_liq_desc a
where	a.nr_titulo	= nr_titulo_p
and	coalesce(a.nr_seq_liq::text, '') = ''
and	coalesce(a.nr_bordero::text, '') = '';

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE vincular_titulo_rec_bordero (nr_bordero_p bigint, nr_titulo_p bigint, nm_usuario_p text) FROM PUBLIC;

