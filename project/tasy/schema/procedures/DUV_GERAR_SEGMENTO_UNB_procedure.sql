-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE duv_gerar_segmento_unb (nr_seq_mensagem_p duv_mensagem.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_episodio_p episodio_paciente.nr_sequencia%type) AS $body$
DECLARE


dt_ano_w		timestamp;
qt_relat_ano_w		bigint;

c01 CURSOR FOR
SELECT	substr(mc.cd_medico_convenio,1,9) as cd_origem,
	substr(pj.cd_cnes,1,9) as cd_destino,
	acc.dt_atualizacao as dt_unb,
	null as nr_relatorio,
	null as nr_envio,
	null as nr_seq_arquivo
FROM pessoa_juridica pj, convenio c, atendimento_paciente ap
LEFT OUTER JOIN atend_categoria_convenio acc ON (ap.nr_atendimento = acc.nr_atendimento)
LEFT OUTER JOIN medico_convenio mc ON (ap.cd_medico_referido = mc.cd_pessoa_fisica)
LEFT OUTER JOIN medico_convenio mc ON (acc.cd_convenio = mc.cd_convenio AND acc.cd_categoria = mc.cd_categoria)
WHERE ap.nr_seq_episodio	= nr_seq_episodio_p and acc.cd_convenio		= c.cd_convenio and c.cd_cgc		= pj.cd_cgc;

c01_w c01%rowtype;


BEGIN

c01_w := null;

open c01;
fetch c01 into c01_w;
close c01;

--A sequência do relatório é por ano, reiniciando sempre a cada ano
dt_ano_w	:= PKG_DATE_UTILS.start_of(clock_timestamp(),'YEAR');
begin
	select	count(1)
	into STRICT	qt_relat_ano_w
	from	duv_unb
	where	PKG_DATE_UTILS.start_of(dt_unb,'YEAR') = dt_ano_w  LIMIT 1;
exception
when others then
	qt_relat_ano_w := 0;
end;
--Se ainda não existe relatório no ano atual, reinicia a sequence.
if (qt_relat_ano_w = 0) then
	CALL ajustar_newvalue_sequence('DUV_NUMERO_RELAT_SEQ',0);
end if;

insert into duv_unb(nr_sequencia,
	dt_atualizacao,
	nm_usuario,
	dt_atualizacao_nrec,
	nm_usuario_nrec,
	nr_seq_mensagem,
	cd_origem,
	cd_destino,
	dt_unb,
	nr_relatorio,
	nr_envio,
	nr_seq_arquivo)
values (nextval('duv_unb_seq'),
	clock_timestamp(),
	nm_usuario_p,
	clock_timestamp(),
	nm_usuario_p,
	nr_seq_mensagem_p,
	c01_w.cd_origem,
	c01_w.cd_destino,
	clock_timestamp(),
	lpad(nextval('duv_numero_relat_seq'),7,'0'),
	'01',
	c01_w.nr_seq_arquivo);

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE duv_gerar_segmento_unb (nr_seq_mensagem_p duv_mensagem.nr_sequencia%type, nm_usuario_p usuario.nm_usuario%type, nr_seq_episodio_p episodio_paciente.nr_sequencia%type) FROM PUBLIC;

