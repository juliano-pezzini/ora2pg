-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_import_material_a900_txt (nr_seq_lote_imp_p bigint, nm_arquivo_p text, nm_usuario_p text) AS $body$
DECLARE


C01 CURSOR FOR
	-- falhas is not null, significa que já foi executado pelo menos uma vez, se já foi executado ao menos uma vez, apaga. durante a execução ele fica null
	SELECT	job
	from	job_v
	where	lower(comando)	like 'pls_gerar_import_mat_a900_new%'
	and	coalesce(falhas::text, '') = '';

ds_comando_job_w	varchar(2000);
jobno			bigint;
	
BEGIN

-- Verificar se a job já existe, se existir remove
for r_C01_w in C01 loop
	
	update	pls_lote_imp_mat_unimed
	set	dt_fim_importacao	 = NULL,
		dt_inicio_importacao	 = NULL,
		nm_usuario_imp		= nm_usuario_p,
		ie_status		= '4',
		ds_log			= obter_desc_expressao(953962)
	where 	nr_sequencia		= nr_seq_lote_imp_p;
	
	commit;
	return;
end loop;

ds_comando_job_w  := 'pls_gerar_import_mat_a900_new(' 	|| nr_seq_lote_imp_p || ',' -- nr_seq_lote_imp_p
							|| pls_util_pck.aspas_w || nm_arquivo_p || pls_util_pck.aspas_w || ',' -- nm_arquivo_p
							|| pls_util_pck.aspas_w || nm_usuario_p || pls_util_pck.aspas_w || ');'; --nm_usuario_p

-- Vai iniciar a procedure em 2.5 segundos após a conclusão desta e sempre joga a próxima execução para daqui a 10000 dias
dbms_job.submit(jobno, ds_comando_job_w, clock_timestamp() + interval '216000 seconds' * (1/24/60/60));

-- coloca o id do job responsável por executar o processo.
update	pls_lote_imp_mat_unimed
set	ie_status 	= '1',
	ds_log		 = NULL
where	nr_sequencia = nr_seq_lote_imp_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_import_material_a900_txt (nr_seq_lote_imp_p bigint, nm_arquivo_p text, nm_usuario_p text) FROM PUBLIC;

