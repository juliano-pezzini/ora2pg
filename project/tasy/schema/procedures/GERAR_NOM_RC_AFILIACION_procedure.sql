-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_nom_rc_afiliacion ( nr_seq_cabecalho_p bigint, nm_usuario_p text) AS $body$
DECLARE


/* Datos de afiliaciones o planes de aseguramiento del paciente */

nr_atendimento_w			atendimento_paciente.nr_atendimento%type;
nr_seq_episodio_w			episodio_paciente.nr_sequencia%type;
cd_estabelecimento_w		estabelecimento.cd_estabelecimento%type;

ds_oid_programa_w			nom_rc_afiliacion.ds_oid_programa%type;
ds_oid_indent_programa_w	nom_rc_afiliacion.ds_oid_programa%type;
nm_programa_w				nom_rc_afiliacion.nm_programa%type;
ds_oid_organizacion_w		nom_rc_afiliacion.ds_oid_organizacion%type;
nm_organizacion_w			nom_rc_afiliacion.nm_organizacion%type;
dt_inicial_w				nom_rc_afiliacion.dt_inicial%type;
dt_final_w					nom_rc_afiliacion.dt_final%type;
ds_oid_persona_w			nom_rc_afiliacion.ds_oid_persona%type;
ds_identificador_persona_w	nom_rc_afiliacion.ds_identificador_persona%type;
cd_tipo_beneficiario_w		nom_rc_afiliacion.cd_tipo_beneficiario%type;
ds_tipo_beneficiario_w		nom_rc_afiliacion.ds_tipo_beneficiario%type;
ds_oid_poliza_w				nom_rc_afiliacion.ds_oid_poliza%type;
cd_poliza_w					nom_rc_afiliacion.cd_poliza%type;
cd_folio_w					nom_rc_afiliacion.cd_poliza%type;
cd_plano_w					nom_rc_afiliacion.ds_identificador_programa%type;

ds_html_w					varchar(32000);
qt_registro_w				bigint	:= 0;

c_convenio CURSOR FOR
	SELECT	distinct
			a.cd_convenio,
			a.cd_plano_convenio cd_plano,
			'2.16.840.1.113883.5.110' ds_oid_indent_programa, 				/*246*/
			cp.ds_plano nm_programa, 										/*247*/
			b.ds_convenio ds_convenio, 										/*249*/
			a.dt_inicio_vigencia dt_inicio_vigencia, 						/*250*/
			a.dt_fim_vigencia dt_final_vigencia,  						/*251*/
			'2.16.840.1.113883.4.629' ds_oid_persona, 						/*252*/
			a.cd_complemento ds_identificador_persona, 							/*253*/
			a.IE_GRAU_DEPENDENCIA cd_tipo_beneficiario, 							/*254*/
			obter_valor_dominio(1034, a.IE_GRAU_DEPENDENCIA) ds_tipo_beneficiario,/*255*/
			'2.16.840.1.113883.3.215.1.2' ds_oid_poliza, 					/*256*/
			coalesce(obter_dados_titular_convenio(pf.cd_pessoa_fisica,c.cd_convenio,'CTI'),a.cd_usuario_convenio) cd_poliza 	/*257*/
	from 	PESSOA_TITULAR_CONVENIO a,
			convenio b,
			categoria_convenio c,
			convenio_plano cp,
			pessoa_fisica pf,
			atendimento_paciente p
	where 	a.cd_convenio       = b.cd_convenio
	and 	a.cd_convenio       = c.cd_convenio
	and 	a.cd_categoria      = c.cd_categoria
	and     a.cd_convenio       = cp.cd_convenio
	and     a.cd_plano_convenio = cp.cd_plano
	and 	a.cd_pessoa_fisica 	= p.cd_pessoa_fisica
	and     p.cd_pessoa_fisica  = pf.cd_pessoa_fisica
	and		p.nr_atendimento 	in (SELECT	x.nr_atendimento
									from	nom_rc_cabecalho x
									where	x.nr_sequencia = nr_seq_cabecalho_p
									and		(x.nr_atendimento IS NOT NULL AND x.nr_atendimento::text <> '')
									
union

									select	y.nr_atendimento
									from	atendimento_paciente y,
											nom_rc_cabecalho x
									where	x.nr_seq_episodio = y.nr_seq_episodio
									and		x.nr_sequencia = nr_seq_cabecalho_p);

BEGIN

delete from nom_rc_afiliacion
where nr_seq_cabecalho = nr_seq_cabecalho_p;

select	a.nr_atendimento,
		a.nr_seq_episodio,
		a.cd_estabelecimento
into STRICT	nr_atendimento_w,
		nr_seq_episodio_w,
		cd_estabelecimento_w
from	nom_rc_cabecalho a
where	a.nr_sequencia	= nr_seq_cabecalho_p;


if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
	null;
elsif (nr_seq_episodio_w IS NOT NULL AND nr_seq_episodio_w::text <> '') then
	select	min(nr_atendimento)
	into STRICT	nr_atendimento_w
	from	atendimento_paciente a
	where	a.nr_seq_episodio = nr_seq_episodio_w;
end if;


if (nr_atendimento_w IS NOT NULL AND nr_atendimento_w::text <> '') then
	ds_html_w	:= '<table class="wrichedit-table" width="100%" xmlns="urn:hl7-org:v3">';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || '<thead>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '<tr>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Inicio de vigencia</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Fin de vigencia</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Programa</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>PÃ³liza</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Folio</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<th>Tipo de beneficiario</th>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '</tr>';
	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) ||  '</thead>';

	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || '<tbody>';

	for	r_c_convenio in c_convenio loop
		nm_organizacion_w			:= r_c_convenio.ds_convenio;
		ds_oid_persona_w			:= r_c_convenio.ds_oid_persona;
		cd_tipo_beneficiario_w		:= r_c_convenio.cd_tipo_beneficiario;
		nm_programa_w				:= r_c_convenio.nm_programa;
		dt_inicial_w				:= r_c_convenio.dt_inicio_vigencia;
		dt_final_w					:= r_c_convenio.dt_final_vigencia;
		ds_identificador_persona_w	:= r_c_convenio.ds_identificador_persona;
		ds_tipo_beneficiario_w		:= r_c_convenio.ds_tipo_beneficiario;
		ds_oid_poliza_w				:= r_c_convenio.ds_oid_poliza;
		cd_poliza_w					:= r_c_convenio.cd_poliza;
		ds_oid_indent_programa_w	:= r_c_convenio.ds_oid_indent_programa;
		cd_plano_w					:= r_c_convenio.cd_plano;

		select	max(ds_oid) /*248*/
		into STRICT		ds_oid_organizacion_w
		from		cadastro_oid_convenio
		where		cd_convenio = r_c_convenio.cd_convenio
		and		coalesce(cd_plano::text, '') = '';

		if (coalesce(ds_oid_organizacion_w::text, '') = '') then
			select replace(get_oid_details(22,'OID_NUMBER','NOM', cd_estabelecimento_w),'[insurance_code]',r_c_convenio.cd_convenio)
			into STRICT ds_oid_organizacion_w
			;
		end if;

		if (coalesce(ds_oid_organizacion_w::text, '') = '') then
			CALL wheb_mensagem_pck.exibir_mensagem_abort(1074576, 'DS_CONVENIO='|| r_c_convenio.ds_convenio || ';' || 'DS_PLANO=' || '');
		end if;

		select	max(ds_oid) /*246*/
		into STRICT		ds_oid_programa_w
		from		cadastro_oid_convenio
		where		cd_convenio = r_c_convenio.cd_convenio
		and		cd_plano = r_c_convenio.cd_plano;								

		/*if	(ds_oid_programa_w is null) then
			wheb_mensagem_pck.exibir_mensagem_abort(1074576, 'DS_CONVENIO=' || r_c_convenio.ds_convenio || ';' || 'DS_PLANO=' || r_c_convenio.nm_programa);
		end if;*/
		insert into nom_rc_afiliacion(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_oid_programa,
			nm_programa,
			ds_oid_organizacion,
			nm_organizacion,
			dt_inicial,
			dt_final,
			ds_oid_persona,
			ds_identificador_persona,
			cd_tipo_beneficiario,
			ds_tipo_beneficiario,
			ds_oid_poliza,
			cd_poliza,
			nr_seq_cabecalho,
			ds_identificador_programa)
		values (nextval('nom_rc_afiliacion_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			ds_oid_indent_programa_w,
			nm_programa_w,
			ds_oid_organizacion_w,
			nm_organizacion_w,
			dt_inicial_w,
			dt_final_w,
			ds_oid_persona_w,
			ds_identificador_persona_w,
			cd_tipo_beneficiario_w,
			ds_tipo_beneficiario_w,
			ds_oid_poliza_w,
			cd_poliza_w,
			nr_seq_cabecalho_p,
			cd_plano_w);

		qt_registro_w	:= qt_registro_w + 1;
		ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '<tr>';

		ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || obter_data_utc(dt_inicial_w,'NOM_TABLE') || '</td>';
		ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || obter_data_utc(dt_final_w, 'NOM_TABLE') || '</td>';
		ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || nm_programa_w || '</td>';
		ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || cd_poliza_w || '</td>';
		ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || ds_identificador_persona_w || '</td>';
		ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || chr(9) || '<td>' || ds_tipo_beneficiario_w || '</td>';

		ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || chr(9) || '</tr>';
	end loop;

	ds_html_w	:= ds_html_w || chr(13) || chr(10) || chr(9) || '</tbody>';

	ds_html_w	:= ds_html_w || chr(13) || chr(10) || '</table>';

	if (qt_registro_w = 0) then

		ds_html_w	:= '<table class="wrichedit-table" width="100%" xmlns="urn:hl7-org:v3">';
		ds_html_w	:= ds_html_w || '<thead>';
		ds_html_w	:= ds_html_w || '<tr>';
		ds_html_w	:= ds_html_w || '<th>Afiliaciones / Planes de aseguramiento</th>';
		ds_html_w	:= ds_html_w || '</tr>';
		ds_html_w	:= ds_html_w || '</thead>';

		ds_html_w	:= ds_html_w || '<tbody>';

		ds_html_w	:= ds_html_w || '<tr>';
		ds_html_w	:= ds_html_w || '<td>' || 'Sin registros' || '</td>';
		ds_html_w	:= ds_html_w || '</tr>';

		ds_html_w	:= ds_html_w || '</tbody>';
		ds_html_w	:= ds_html_w || '</table>';
	end if;

	/* HTML */

	insert into nom_rc_afiliacion(nr_sequencia,
			dt_atualizacao,
			nm_usuario,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			ds_html,
			nr_seq_cabecalho)
		values (nextval('nom_rc_afiliacion_seq'),
			clock_timestamp(),
			nm_usuario_p,
			clock_timestamp(),
			nm_usuario_p,
			ds_html_w,
			nr_seq_cabecalho_p);

end if;
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_nom_rc_afiliacion ( nr_seq_cabecalho_p bigint, nm_usuario_p text) FROM PUBLIC;

