-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE excluir_itens_selecionado_inv ( nr_seq_inventario_p bigint, nr_seq_item_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) AS $body$
DECLARE


cd_material_w		integer;
cd_local_estoque_w	integer;
dt_mesano_referencia_w	timestamp;
dt_mesano_vigente_w	timestamp;
qt_existe_w		integer;
ie_consignado_w		varchar(1);
cd_fornecedor_w		varchar(14);


BEGIN

select	max(dt_mesano_vigente)
into STRICT	dt_mesano_vigente_w
from 	parametro_estoque
where	cd_estabelecimento	= cd_estabelecimento_p;

select	a.cd_material,
	b.cd_local_estoque,
	b.ie_consignado,
	coalesce(a.cd_fornecedor, b.cd_fornecedor)
into STRICT	cd_material_w,
	cd_local_estoque_w,
	ie_consignado_w,
	cd_fornecedor_w
from	inventario b,
	inventario_material a
where	b.nr_sequencia = a.nr_seq_inventario
and	a.nr_seq_inventario = nr_seq_inventario_p
and	a.nr_sequencia = nr_seq_item_p;

if (ie_consignado_w = 'N') then
	begin
	select	/*+ index (s salesto_i2) */		coalesce(max(s.dt_mesano_referencia), trunc(clock_timestamp(), 'month'))
	into STRICT	dt_mesano_referencia_w
	from 	saldo_estoque s
	where	s.ie_bloqueio_inventario	= 'S'
	and	s.cd_estabelecimento	= cd_estabelecimento_p
	and 	s.cd_material		= cd_material_w
	and	s.cd_local_estoque		= cd_local_estoque_w
	and 	s.dt_mesano_referencia	>= dt_mesano_vigente_w;

	update	saldo_estoque
	set	ie_bloqueio_inventario	= 'N'
	where	cd_estabelecimento		= cd_estabelecimento_p
	and	cd_local_estoque		= cd_local_estoque_w
	and	cd_material		= cd_material_w
	and	dt_mesano_referencia	<= dt_mesano_referencia_w;
	end;
else
	begin
	select	/*+ index (s salesto_i2) */		coalesce(max(s.dt_mesano_referencia), trunc(clock_timestamp(), 'month'))
	into STRICT	dt_mesano_referencia_w
	from 	fornecedor_mat_consignado s
	where	s.ie_bloqueio_inventario	= 'S'
	and	s.cd_estabelecimento	= cd_estabelecimento_p
	and 	s.cd_material		= cd_material_w
	and	s.cd_local_estoque		= cd_local_estoque_w
	and	s.cd_fornecedor		= cd_fornecedor_w
	and 	s.dt_mesano_referencia	>= dt_mesano_vigente_w;

	update	fornecedor_mat_consignado
	set	ie_bloqueio_inventario	= 'N'
	where	cd_estabelecimento		= cd_estabelecimento_p
	and	cd_local_estoque		= cd_local_estoque_w
	and	cd_fornecedor		= cd_fornecedor_w
	and	cd_material		= cd_material_w
	and	dt_mesano_referencia	<= dt_mesano_referencia_w;
	end;
end if;

delete	FROM inventario_material
where	nr_sequencia	= nr_seq_item_p;

/*Verifica se ainda existem itens no inventário, se não existir - desbloqueia o inventário*/

select	count(*)
into STRICT	qt_existe_w
from	inventario_material
where	nr_seq_inventario	= nr_seq_inventario_p;

if (qt_existe_w = 0) then
	update	inventario
	set	dt_bloqueio		 = NULL,
		nm_usuario_bloqueio	 = NULL
	where	nr_sequencia		= nr_seq_inventario_p;
end if;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE excluir_itens_selecionado_inv ( nr_seq_inventario_p bigint, nr_seq_item_p bigint, cd_estabelecimento_p bigint, nm_usuario_p text) FROM PUBLIC;

