-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_relat_eis_cirurgia_hi (dt_referencia_p timestamp) AS $body$
DECLARE

 
 
ds_comando_w		varchar(2000);
nr_count_w		bigint;
nr_sequencia_w 		integer		:= 0;
nr_interno_conta_w	bigint;
cd_convenio_w		bigint;
ds_convenio_w		varchar(255);
qt_cirurgias_w		double precision		:= 0;
qt_total_min_w		double precision		:= 0;
vl_faturamento_w	double precision;
vl_material_W		double precision;
vl_procedimento_w	double precision;
vl_custo_W 		double precision;
nr_cirurgia_w		bigint;
vl_taxa_w		double precision;
vl_diaria_w		double precision;

C01 CURSOR FOR 
	SELECT 	coalesce(a.cd_convenio,0) cd_convenio, 
		coalesce(substr(obter_nome_convenio(a.cd_convenio),1,30), obter_desc_expressao(327119)/*'Não Informado'*/
) ds_convenio,		 
		sum(coalesce(a.nr_min_duracao_real,0)) qt_total_min, 
		coalesce(a.nr_cirurgia,0) 
    FROM pessoa_fisica p, cirurgia a
LEFT OUTER JOIN atendimento_paciente c ON (a.nr_atendimento = c.nr_atendimento)
LEFT OUTER JOIN atend_paciente_unidade b ON (a.nr_atendimento = b.nr_atendimento AND a.dt_entrada_unidade = b.dt_entrada_unidade)
WHERE a.dt_inicio_real between trunc(trunc(dt_referencia_p,'month'), 'dd') and (trunc(last_day(dt_referencia_p), 'dd') + 1) - (1/86400) and (a.dt_termino IS NOT NULL AND a.dt_termino::text <> '') and (a.cd_procedimento_princ IS NOT NULL AND a.cd_procedimento_princ::text <> '')    and a.cd_pessoa_fisica		= p.cd_pessoa_fisica group by a.cd_CONVENIO, a.nr_cirurgia 
	order by 1 desc;


BEGIN 
 
/* Verifica a existência da tabela */
 
 
begin 
Select	count(table_name) 
into STRICT	nr_count_w 
from	user_tables 
where	upper(table_name) = 'EIS_CIRURGIA_INTERMED_W';
 
if (nr_count_w = 0) then 
	CALL EXEC_SQL_DINAMICO('TASY','create table EIS_CIRURGIA_INTERMED_W 
						(nr_sequencia 		number(5), 
						nr_cirurgia		number(10),						 
						cd_convenio		number(10), 
						ds_convenio		varchar2(60), 
						qt_cirurgias		number(10,4), 
						qt_total_min		number(10,4), 
						vl_faturamento		number(15,4), 
						vl_material		number(15,4), 
						vl_procedimento		number(15,4), 
						vl_taxa			number(15,4), 
						vl_diaria		number(15,4), 
						vl_custo 		number(15,4))');
else 
	CALL EXEC_SQL_DINAMICO('TASY','drop table EIS_CIRURGIA_INTERMED_W');
	CALL EXEC_SQL_DINAMICO('TASY','create table EIS_CIRURGIA_INTERMED_W 
						(nr_sequencia 		number(5), 
						nr_cirurgia		number(10),						 
						cd_convenio		number(10), 
						ds_convenio		varchar2(60), 
						qt_cirurgias		number(10,4), 
						qt_total_min		number(10,4), 
						vl_faturamento		number(15,4), 
						vl_material		number(15,4), 
						vl_procedimento		number(15,4), 
						vl_taxa			number(15,4), 
						vl_diaria		number(15,4), 
						vl_custo 		number(15,4))');
end if;
 
commit;
end;
 
Open C01;
LOOP 
	Fetch C01 into	cd_convenio_w, 
			ds_convenio_w, 
			qt_total_min_w,			 
			nr_cirurgia_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	 
	nr_sequencia_w:= nr_sequencia_w + 1;
		 
	 
	select	count(*) 
	into STRICT	nr_count_w 
	from	conta_paciente_resumo 
	where	nr_cirugia 		= nr_cirurgia_w;
 
	vl_taxa_w	:= 0;
	vl_diaria_w	:= 0;
 
	if (nr_count_w = 0) then 
		vl_material_w		:= 0;
		vl_procedimento_w	:= 0;
		vl_custo_w		:= 0;
	else 
		 
		select	max(coalesce(nr_interno_conta,0)) 
		into STRICT	nr_interno_conta_w 
		from	conta_paciente_resumo 
		where	nr_cirugia 		= nr_cirurgia_w;
	 
		select	sum(vl_material), 
			sum(vl_procedimento), 
			sum(vl_custo) 
		into STRICT	vl_material_w, 
			vl_procedimento_w, 
			vl_custo_w 
		from	conta_paciente_resumo 
		where	nr_interno_conta = nr_interno_conta_w;
	 
		/* Taxas */
 
		begin 
		select	coalesce(sum(vl_procedimento),0) 
		into STRICT	vl_taxa_w 
		from	conta_paciente_resumo 
		where	nr_interno_conta = nr_interno_conta_w 
		and 	cd_estrutura_conta 	= '73';
		exception 
			when	others then 
				vl_taxa_w:= 0;
		end;
		 
		/* Diárias */
 
		begin 
		select	coalesce(sum(vl_procedimento),0) 
		into STRICT	vl_diaria_w 
		from	conta_paciente_resumo 
		where	nr_interno_conta = nr_interno_conta_w 
		and 	cd_estrutura_conta 	= '72';
		exception 
			when	others then 
				vl_diaria_w:= 0;
		end;
 
	 
	end if;
 
 
	qt_cirurgias_w	:= 1;
	vl_faturamento_w:= vl_material_w + vl_procedimento_w;
		 
	ds_comando_w	:= 	'insert	into EIS_CIRURGIA_INTERMED_W values 
						(' || nr_sequencia_w || ', ' || nr_cirurgia_w || ', ' || cd_convenio_w || 
						', ' || chr(39) || ds_convenio_w || chr(39) || ', ' || qt_cirurgias_w || 
						', ' || qt_total_min_w || ', ' || replace(to_char(vl_faturamento_w),',','.') 
						|| ', ' || replace(to_char(vl_material_w),',','.') || ', ' || 
						replace(to_char(vl_procedimento_W),',','.') || ', ' || replace(to_char(vl_taxa_W),',','.') 
						|| ', ' || replace(to_char(vl_diaria_W),',','.') || ', ' || replace(to_char(vl_custo_w),',','.') ||')';
	 
	 
	CALL EXEC_SQL_DINAMICO('TASY',ds_comando_w);
		 
end loop;
close C01;
 
commit;
 
END;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_relat_eis_cirurgia_hi (dt_referencia_p timestamp) FROM PUBLIC;

