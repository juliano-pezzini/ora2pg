-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE fis_insert_barcode_item ( nr_sequencia_p bigint, cd_estabelecimento_p bigint, cd_centro_custo_p bigint, nr_solic_compra_p bigint, cd_material_p bigint, qt_item_nf_p bigint, nr_seq_lote_fornec_p bigint default null, cd_material_estoque_p bigint DEFAULT NULL, cd_unidade_medida_compra_p text DEFAULT NULL, cd_unidade_medida_estoque_p text DEFAULT NULL, ie_barras_lido_p text DEFAULT NULL, cd_local_estoque_p bigint default null, cd_lote_fabricacao_p text default null, dt_validade_p timestamp default null, ie_indeterminado_p text default null, cd_barra_material_p text default null, cd_serie_nf_p text DEFAULT NULL, nm_usuario_p text DEFAULT NULL, cd_cgc_p text DEFAULT NULL, ie_tipo_pessoa_p text DEFAULT NULL, ie_entrada_saida_p text DEFAULT NULL, cd_procedimento_p bigint DEFAULT NULL, ie_origem_proced_p bigint DEFAULT NULL, cd_operacao_nf_p bigint DEFAULT NULL, nr_seq_proj_recurso_p bigint DEFAULT NULL, cd_pessoa_fisica_p text DEFAULT NULL, cd_moeda_p bigint DEFAULT NULL) AS $body$
DECLARE


nr_item_nf_w		nota_fiscal_item.nr_item_nf%type := 0;
vl_unitario_item_nf_w	nota_fiscal_item.vl_unitario_item_nf%type := 0;
vl_total_item_nf_w	nota_fiscal_item.vl_total_item_nf%type := 0;
vl_liquido_w		nota_fiscal_item.vl_liquido%type := 0;
nr_seq_conta_financ_p	nota_fiscal_item.nr_seq_conta_financ%type := 0;


BEGIN
	
select 	coalesce(max(nr_item_nf), 0)
into STRICT 	nr_item_nf_w
from 	nota_fiscal_item
where 	nr_sequencia = nr_sequencia_p;

nr_item_nf_w := nr_item_nf_w + 1;

if (philips_param_pck.get_cd_pais = 12 AND cd_material_p IS NOT NULL AND cd_material_p::text <> '') then
	select coalesce(max(vl_delivery_price), 0)
	into STRICT vl_unitario_item_nf_w
	from mat_vendor_price_rules
	where cd_material = cd_material_p
	and ((dt_invoice_end >= trunc(clock_timestamp()) and dt_invoice_start <= trunc(clock_timestamp()))
	or (dt_invoice_start <= trunc(clock_timestamp()) and coalesce(dt_invoice_end::text, '') = ''));
end if;

if (vl_unitario_item_nf_w <> 0 AND qt_item_nf_p <> 0) then
	vl_total_item_nf_w := qt_item_nf_p * vl_unitario_item_nf_w;
	vl_liquido_w := vl_total_item_nf_w;
end if;

nr_seq_conta_financ_p := obter_conta_financeira(	ie_entrada_saida_p, cd_estabelecimento_p, cd_material_p, cd_procedimento_p, ie_origem_proced_p, null, null, cd_cgc_p, cd_centro_custo_p, nr_seq_conta_financ_p, null, cd_operacao_nf_p, ie_tipo_pessoa_p, null, null, nr_seq_proj_recurso_p, null, cd_pessoa_fisica_p, null, null, null, null, cd_local_estoque_p, null, null, null, null, null, cd_moeda_p);
					
if (nr_seq_conta_financ_p = 0) then
	nr_seq_conta_financ_p := null;
end if;
		
insert into nota_fiscal_item(
	nr_sequencia,
	nr_sequencia_nf,
	nr_item_nf,
	cd_estabelecimento,
	cd_centro_custo,
	nr_solic_compra,
	cd_material,
	qt_item_nf,
	nr_seq_lote_fornec,
	cd_material_estoque,
	cd_unidade_medida_compra,
	cd_unidade_medida_estoque,
	ie_barras_lido,
	cd_local_estoque,
	cd_lote_fabricacao,
	dt_validade,
	ie_indeterminado,
	cd_barra_material,
	vl_unitario_item_nf,
	vl_total_item_nf,
	dt_atualizacao,
	nm_usuario,
	vl_frete,
	vl_desconto,
	vl_despesa_acessoria,
	vl_desconto_rateio,
	vl_seguro,
	vl_liquido,
	cd_serie_nf,
	nr_seq_conta_financ)
values (
	nr_sequencia_p,
	nr_sequencia_p,
	nr_item_nf_w,
	cd_estabelecimento_p,
	cd_centro_custo_p,
	nr_solic_compra_p,
	cd_material_p,
	qt_item_nf_p,
	nr_seq_lote_fornec_p,
	cd_material_estoque_p,
	cd_unidade_medida_compra_p,
	cd_unidade_medida_estoque_p,
	ie_barras_lido_p,
	cd_local_estoque_p,
	cd_lote_fabricacao_p,
	dt_validade_p,
	ie_indeterminado_p,
	cd_barra_material_p,
	vl_unitario_item_nf_w,
	vl_total_item_nf_w,
	clock_timestamp(),
	nm_usuario_p,
	0,
	0,
	0,
	0,
	0,
	vl_liquido_w,
	cd_serie_nf_p,
	nr_seq_conta_financ_p);

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE fis_insert_barcode_item ( nr_sequencia_p bigint, cd_estabelecimento_p bigint, cd_centro_custo_p bigint, nr_solic_compra_p bigint, cd_material_p bigint, qt_item_nf_p bigint, nr_seq_lote_fornec_p bigint default null, cd_material_estoque_p bigint DEFAULT NULL, cd_unidade_medida_compra_p text DEFAULT NULL, cd_unidade_medida_estoque_p text DEFAULT NULL, ie_barras_lido_p text DEFAULT NULL, cd_local_estoque_p bigint default null, cd_lote_fabricacao_p text default null, dt_validade_p timestamp default null, ie_indeterminado_p text default null, cd_barra_material_p text default null, cd_serie_nf_p text DEFAULT NULL, nm_usuario_p text DEFAULT NULL, cd_cgc_p text DEFAULT NULL, ie_tipo_pessoa_p text DEFAULT NULL, ie_entrada_saida_p text DEFAULT NULL, cd_procedimento_p bigint DEFAULT NULL, ie_origem_proced_p bigint DEFAULT NULL, cd_operacao_nf_p bigint DEFAULT NULL, nr_seq_proj_recurso_p bigint DEFAULT NULL, cd_pessoa_fisica_p text DEFAULT NULL, cd_moeda_p bigint DEFAULT NULL) FROM PUBLIC;

