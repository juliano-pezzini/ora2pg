-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE man_atualiza_ativ_sem_fim ( nr_sequencia_p bigint, dt_inicio_p timestamp, nm_usuario_p text) AS $body$
DECLARE


nr_sequencia_w		bigint;


c01 CURSOR FOR
SELECT	a.nr_sequencia
from	man_ordem_serv_ativ a
where	coalesce(a.dt_fim_atividade::text, '') = ''
and	a.nm_usuario_exec	= nm_usuario_p
and	a.nr_seq_ordem_serv	<> nr_sequencia_p
and	substr(obter_se_usuario_exec(a.nr_seq_ordem_serv, nm_usuario_p, 0),1,1) = 'S'
and exists (
	SELECT	1
	from	man_ordem_servico x
	where	x.nr_sequencia = a.nr_seq_ordem_serv
	and	x.ie_status_ordem <> '3');


BEGIN

open c01;
loop
fetch c01 into
	nr_sequencia_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin

	update	man_ordem_serv_ativ
	set	dt_fim_atividade	= dt_inicio_p,
		qt_minuto		= ((dt_inicio_p - dt_atividade) * 1440),
		qt_minuto_cobr		= ((dt_inicio_p - dt_atividade) * 1440),
		dt_atualizacao		= clock_timestamp(),
		nm_usuario		= nm_usuario_p
	where	nr_sequencia		= nr_sequencia_w;


	CALL MAN_CALCULAR_PRECO_ATIVIDADE(nr_sequencia_w);


	end;
end loop;
close c01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE man_atualiza_ativ_sem_fim ( nr_sequencia_p bigint, dt_inicio_p timestamp, nm_usuario_p text) FROM PUBLIC;

