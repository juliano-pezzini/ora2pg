-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE obter_se_regra_item_escala ( nr_seq_grupo_item_p bigint, ie_permite_p INOUT text) AS $body$
DECLARE

										 
qt_reg_w				bigint;
cd_setor_atual_w		bigint;
cd_perfil_w				bigint;
cd_estabelecimento_w	bigint;
cd_especialidade_w		integer := null;
ie_permite_w			varchar(10) := 'S';
nm_usuario_w			varchar(15);
cd_pessoa_fisica_w		varchar(15);

C01 CURSOR FOR 
	SELECT	coalesce(ie_permite,'S') 
	from	grupo_escala_item_regra 
	where	nr_seq_grupo_item	= nr_seq_grupo_item_p 
	and		ie_situacao	='A' 
	and		coalesce(cd_estabelecimento, cd_estabelecimento_w) = cd_estabelecimento_w 
	and		coalesce(cd_perfil, cd_perfil_w) = cd_perfil_w		 
	and		coalesce(cd_setor_atendimento,cd_setor_atual_w)	= cd_setor_atual_w 
	and		coalesce(cd_especialidade,cd_especialidade_w) = cd_especialidade_w 
	and		coalesce(nm_usuario_param,nm_usuario_w) = nm_usuario_w 
	order by coalesce(nm_usuario_param,'a'), 
			coalesce(cd_especialidade,0), 
			coalesce(cd_setor_atendimento,0), 
			coalesce(cd_perfil,0), 
			coalesce(cd_estabelecimento,0);


BEGIN 
nm_usuario_w			:= coalesce(wheb_usuario_pck.get_nm_usuario,0);
 
Select 	max(cd_pessoa_fisica) 
into STRICT	cd_pessoa_fisica_w 
from	usuario 
where	nm_usuario = nm_usuario_w;
 
cd_setor_atual_w		:= coalesce(wheb_usuario_pck.get_cd_setor_atendimento,0);
cd_perfil_w				:= coalesce(wheb_usuario_pck.get_cd_perfil,0);
cd_estabelecimento_w	:= coalesce(wheb_usuario_pck.get_cd_estabelecimento,0);
cd_especialidade_w		:= coalesce(obter_especialidade_pf(cd_pessoa_fisica_w),0);
 
select	count(*) 
into STRICT	qt_reg_w 
from	grupo_escala_item_regra 
where	nr_seq_grupo_item	= nr_seq_grupo_item_p 
and		ie_situacao	='A';
 
if (qt_reg_w	> 0) then 
 
	open C01;
	loop 
	fetch C01 into	 
		ie_permite_w;
	EXIT WHEN NOT FOUND; /* apply on C01 */
	end loop;
	close C01;
	 
end if;
 
ie_permite_p := ie_permite_w;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE obter_se_regra_item_escala ( nr_seq_grupo_item_p bigint, ie_permite_p INOUT text) FROM PUBLIC;

