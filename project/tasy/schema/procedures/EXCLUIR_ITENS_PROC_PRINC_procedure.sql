-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE excluir_itens_proc_princ (nr_sequencia_p bigint, cd_motivo_exc_conta_p bigint, ds_compl_motivo_excon_p text, nm_usuario_p text) AS $body$
DECLARE

		 
 
ie_proc_mat_w			varchar(01);
nr_sequencia_w			bigint;
nr_interno_conta_w		bigint;
ie_status_acerto_w		varchar(05);
qt_material_w			double precision;
cd_setor_atendimento_w		bigint;
cd_material_w			bigint;
ie_proc_mat_w2			varchar(01);
nr_sequencia_w2			bigint;
nr_interno_conta_w2		bigint;

 
c01 CURSOR FOR 
	SELECT	'P' ie_proc_mat, 
		a.nr_sequencia, 
		a.nr_interno_conta 
	from	procedimento_paciente a 
	where	a.nr_seq_proc_princ	= nr_sequencia_p 
	
union
 
	SELECT	'M' ie_proc_mat, 
		a.nr_sequencia, 
		a.nr_interno_conta 
	from	material_atend_paciente a 
	where	a.nr_seq_proc_princ	= nr_sequencia_p;

c02 CURSOR FOR 
	SELECT	'P' ie_proc_mat, 
		a.nr_sequencia, 
		a.nr_interno_conta 
	from	procedimento_paciente a 
	where	a.nr_seq_proc_princ	= nr_sequencia_w 
	
union
 
	SELECT	'M' ie_proc_mat, 
		a.nr_sequencia, 
		a.nr_interno_conta 
	from	material_atend_paciente a 
	where	a.nr_seq_proc_princ	= nr_sequencia_w;

	 
 

BEGIN 
 
open	c01;
loop 
fetch	c01 into	 
	ie_proc_mat_w, 
	nr_sequencia_w, 
	nr_interno_conta_w;
EXIT WHEN NOT FOUND; /* apply on c01 */
	begin 
 
	select	coalesce(max(ie_status_acerto),1) 
	into STRICT	ie_status_acerto_w 
	from	conta_paciente 
	where	nr_interno_conta	= nr_interno_conta_w;
	 
	if (ie_status_acerto_w = 1) then 
		begin 
 
		if (ie_proc_mat_w	= 'P') then 
			begin 
 
			open	c02;
			loop 
			fetch	c02 into	 
				ie_proc_mat_w2, 
				nr_sequencia_w2, 
				nr_interno_conta_w2;
			EXIT WHEN NOT FOUND; /* apply on c02 */
				begin 
 
				if (ie_proc_mat_w2	= 'P') then 
					if (coalesce(cd_motivo_exc_conta_p,0) <> 0) then 
						CALL excluir_matproc_conta(nr_sequencia_w2, nr_interno_conta_w2, cd_motivo_exc_conta_p, ds_compl_motivo_excon_p, 'P', nm_usuario_p);
					else 
						delete 	from procedimento_paciente 
						where	nr_sequencia	= nr_sequencia_w2;
					end if;
				end if;
 
				if (ie_proc_mat_w2	= 'M') then 
					begin 
					if (coalesce(cd_motivo_exc_conta_p,0) <> 0) then 
						CALL excluir_matproc_conta(nr_sequencia_w2, nr_interno_conta_w2, cd_motivo_exc_conta_p, ds_compl_motivo_excon_p, 'M', nm_usuario_p);
					else 
						delete 	from material_atend_paciente 
						where	nr_sequencia	= nr_sequencia_w2;
					end if;				
					end;
				end if;
 
				end;
			end loop;
			close c02;
			 
			if (coalesce(cd_motivo_exc_conta_p,0) <> 0) then 
				CALL excluir_matproc_conta(nr_sequencia_w, nr_interno_conta_w, cd_motivo_exc_conta_p, ds_compl_motivo_excon_p, 'P', nm_usuario_p);
			else 
				delete 	from procedimento_paciente 
				where	nr_sequencia	= nr_sequencia_w;
			end if;
 
			end;
		end if;
 
		if (ie_proc_mat_w	= 'M') then 
			begin 
 
			select	cd_material, 
				cd_setor_atendimento 
			into STRICT	cd_material_w, 
				cd_setor_atendimento_w 
			from	material_atend_paciente 
			where	nr_sequencia	= nr_sequencia_w;
 
			 
			select	count(*) 
			into STRICT	qt_material_w 
			from	material_atend_paciente 
			where	cd_setor_atendimento	= cd_setor_atendimento_w 
			and	cd_material		= cd_material_w 
			and	nr_interno_conta	= nr_interno_conta_w 
			and	qt_material		< 0;
 
			if (qt_material_w = 0) then 
				if (coalesce(cd_motivo_exc_conta_p,0) <> 0) then 
					CALL excluir_matproc_conta(nr_sequencia_w, nr_interno_conta_w, cd_motivo_exc_conta_p, ds_compl_motivo_excon_p, 'M', nm_usuario_p);
				else 
					delete 	from material_atend_paciente 
					where	nr_sequencia	= nr_sequencia_w;
				end if;
			else 
				update	material_atend_paciente 
				set	nr_seq_proc_princ	 = NULL 
				where	nr_sequencia	= nr_sequencia_w;
			end if;
 
			end;
		end if;
 
		end;
	end if;
	 
 
	nr_sequencia_w	:= nr_sequencia_w;
 
	end;
end loop;
close	c01;
 
commit;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE excluir_itens_proc_princ (nr_sequencia_p bigint, cd_motivo_exc_conta_p bigint, ds_compl_motivo_excon_p text, nm_usuario_p text) FROM PUBLIC;

