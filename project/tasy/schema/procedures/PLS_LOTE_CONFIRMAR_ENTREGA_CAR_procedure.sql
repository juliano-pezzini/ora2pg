-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE pls_lote_confirmar_entrega_car ( nr_sequencia_p bigint, dt_entrega_p timestamp, nm_pessoa_entrega_p text, nm_usuario_p text) AS $body$
DECLARE


nr_seq_carteira_w		bigint;
cd_estabelecimento_w		smallint;
nr_seq_cart_estagio_w		pls_segurado_cart_estagio.nr_sequencia%type;


BEGIN

select	a.nr_sequencia,
	c.cd_estabelecimento
into STRICT	nr_seq_carteira_w,
	cd_estabelecimento_w
from	pls_segurado_carteira a,
	pls_carteira_emissao b,
	pls_lote_carteira	c
where	a.nr_sequencia	= b.nr_seq_seg_carteira
and	c.nr_sequencia	= b.nr_seq_lote
and	b.nr_sequencia	= nr_sequencia_p;

CALL pls_alterar_estagios_cartao(nr_seq_carteira_w,clock_timestamp(),'7',cd_estabelecimento_w,nm_usuario_p);

select	max(a.nr_sequencia)
into STRICT	nr_seq_cart_estagio_w
from	pls_segurado_cart_estagio	a
where	nr_seq_cartao_seg	= nr_seq_carteira_w;

update	pls_segurado_cart_estagio
set	nr_seq_cart_emissao	= nr_sequencia_p
where	nr_sequencia		= nr_seq_cart_estagio_w;

update	pls_carteira_emissao
set	dt_entrega_beneficiario	= dt_entrega_p,
	dt_atualizacao		= clock_timestamp(),
	nm_usuario_entrega	= nm_usuario_p,
	NM_PESSOA_ENTREGA	= nm_pessoa_entrega_p
where	nr_sequencia		= nr_sequencia_p;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE pls_lote_confirmar_entrega_car ( nr_sequencia_p bigint, dt_entrega_p timestamp, nm_pessoa_entrega_p text, nm_usuario_p text) FROM PUBLIC;

