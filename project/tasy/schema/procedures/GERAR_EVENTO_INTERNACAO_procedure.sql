-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE gerar_evento_internacao ( nr_atendimento_p bigint, nm_usuario_p text) AS $body$
DECLARE

 
nr_seq_evento_w		bigint;
cd_estabelecimento_w	smallint;
cd_pessoa_fisica_w	varchar(10);
qt_idade_w		bigint;
cd_doenca_w		varchar(20);
cd_setor_paciente_w	bigint;
nr_seq_classif_w	bigint;
cd_convenio_w		integer;
cd_procedencia_w	integer;
ie_possui_agenda_cirurgica_w varchar(1);

C01 CURSOR FOR 
	SELECT	nr_seq_evento 
	FROM	regra_envio_sms 
	WHERE	cd_estabelecimento	= cd_estabelecimento_w 
	AND	((ie_evento_disp		= 'I') or (ie_evento_disp = 'IAC' AND ie_possui_agenda_cirurgica_w = 'S'))	 
	AND	(((nr_seq_classif IS NOT NULL AND nr_seq_classif::text <> '') AND (coalesce(nr_seq_classif, nr_seq_classif_w) = nr_seq_classif_w)) OR 
		 ((coalesce(nr_seq_classif::text, '') = '') AND (obter_classif_regra_pf(nr_sequencia,coalesce(nr_seq_classif_w,nr_seq_classif_w)) = 'S')) OR		 
		 ((coalesce(nr_seq_classif,nr_seq_classif_w) = nr_seq_classif_w) AND (obter_classif_regra_pf(nr_sequencia,coalesce(nr_seq_classif_w,nr_seq_classif_w)) = 'N')))	 
	and	qt_idade_w between coalesce(qt_idade_min,0)	and coalesce(qt_idade_max,9999) 
	and (obter_se_conv_rec_alerta(cd_convenio_w, nr_sequencia) = 'S') 
	and	coalesce(cd_setor_atendimento,cd_setor_paciente_w) = cd_setor_paciente_w	 
	and	obter_se_regra_envio(nr_sequencia,nr_atendimento_p) = 'S' 
	and	coalesce(cd_procedencia,cd_procedencia_w) = cd_procedencia_w 
	AND	coalesce(ie_situacao,'A') = 'A';
	
 

BEGIN 
 
cd_setor_paciente_w	:= obter_setor_atendimento(nr_atendimento_p);
 
select CASE WHEN count(*)=0 THEN 'N'  ELSE 'S' END  
into STRICT  ie_possui_agenda_cirurgica_w 
from  agenda_paciente b, 
    agenda a 
where  a.cd_agenda = b.cd_agenda 
and   a.cd_tipo_agenda = 1 
and   b.nr_atendimento = nr_atendimento_p 
and   b.ie_status_agenda not in ('L','I','C','B','F');
 
 
select	cd_pessoa_fisica, 
	cd_estabelecimento, 
	coalesce(cd_procedencia,0) 
into STRICT	cd_pessoa_fisica_w, 
	cd_estabelecimento_w, 
	cd_procedencia_w 
from	atendimento_paciente 
where	nr_atendimento	= nr_atendimento_p;
qt_idade_w	:= coalesce(obter_idade_pf(cd_pessoa_fisica_w,clock_timestamp(),'A'),0);
nr_seq_classif_w := obter_classificacao_pf(cd_pessoa_fisica_w);
cd_convenio_w	 := Obter_Convenio_Atendimento(nr_atendimento_p);
 
open C01;
loop 
fetch C01 into	 
	nr_seq_evento_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin 
	CALL gerar_evento_paciente(nr_seq_evento_w,nr_atendimento_p,cd_pessoa_fisica_w,null,nm_usuario_p,null);
	end;
end loop;
close C01;
 
end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE gerar_evento_internacao ( nr_atendimento_p bigint, nm_usuario_p text) FROM PUBLIC;

