-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE ageint_inserir_pac_list_esp ( nr_seq_ageint_p bigint, nr_seq_ageint_item_p bigint, cd_estabelecimento_p bigint, cd_agenda_espera_p bigint, dt_desejada_espera_p timestamp, nm_usuario_p text, nr_seq_motivo_p bigint, ds_observacao_p text) AS $body$
DECLARE


cd_convenio_w				agenda_integrada.cd_convenio%type;			
cd_categoria_w				agenda_integrada.cd_categoria%type;
cd_plano_w					agenda_integrada.cd_plano%type;
cd_pessoa_fisica_w			agenda_integrada.cd_pessoa_fisica%type;
cd_procedimento_w			agenda_integrada_item.cd_procedimento%type;
nr_seq_proc_interno_w		agenda_integrada_item.nr_seq_proc_interno%type;
ie_origem_proced_w			agenda_integrada_item.ie_origem_proced%type;
cd_especialidade_w			agenda_integrada_item.cd_especialidade%type;
ie_lado_w					agenda_integrada_item.ie_lado%type;
nr_telefone_w				agenda_lista_espera.nr_telefone%type;
nm_paciente_w				agenda_integrada.nm_paciente%type;
nm_pessoa_contato_w			agenda_integrada.nm_paciente%type;
ie_classif_agenda_w			agenda_integrada_item.ie_classif_agenda%type;
nr_seq_tipo_classif_pac_w  	agenda_integrada.nr_seq_tipo_classif_pac%type;		
ie_prioridade_w            	tipo_classificao_paciente.ie_prioridade%type;
cd_usuario_convenio_w 		agenda_integrada.cd_usuario_convenio%type;
dt_validade_carteira_w		agenda_integrada.dt_validade_carteira%type;
cd_procedencia_w			agenda_integrada.cd_procedencia%type;
ie_tipo_agendamento_w 		agenda_integrada_item.ie_tipo_agendamento%type;
nr_seq_agenda_int_w			agenda_integrada_item.nr_seq_agenda_int%type;


BEGIN

	select	max(b.cd_procedimento),
			max(b.nr_seq_proc_interno),
			max(b.ie_origem_proced),
			max(b.cd_especialidade),
			max(b.ie_lado),
			max(b.ie_classif_agenda),
			max(b.ie_tipo_agendamento),
			max(b.nr_seq_agenda_int),
            max(a.cd_convenio),
			max(a.cd_categoria),
			max(a.cd_plano),
			max(a.cd_pessoa_fisica),
			max(a.nr_seq_tipo_classif_pac),
			max(a.cd_usuario_convenio),
			max(a.dt_validade_carteira),
			max(a.cd_procedencia)
	into STRICT	cd_procedimento_w,
			nr_seq_proc_interno_w,
			ie_origem_proced_w,
			cd_especialidade_w,
			ie_lado_w,
			ie_classif_agenda_w,
			ie_tipo_agendamento_w,
			nr_seq_agenda_int_w,
            cd_convenio_w,
			cd_categoria_w,
			cd_plano_w,
			cd_pessoa_fisica_w,
			nr_seq_tipo_classif_pac_w,
			cd_usuario_convenio_w,
			dt_validade_carteira_w,
			cd_procedencia_w
	from	agenda_integrada_item b,
            agenda_integrada a
	where b.nr_seq_agenda_int = a.nr_sequencia
      and b.nr_sequencia = nr_seq_ageint_item_p;

	select	max(substr(OBTER_NOME_PF(cd_pessoa_fisica), 0, 60))
	into STRICT	nm_paciente_w
	from	pessoa_fisica
	where	cd_pessoa_fisica = cd_pessoa_fisica_w;

	nr_telefone_w	:= obter_fone_pac_agenda(cd_pessoa_fisica_w);
	
	if (coalesce(cd_pessoa_fisica_w::text, '') = '')then
	
	begin
	
		select	substr(nm_paciente, 1, 60),
				nr_telefone,
				nm_contato
		into STRICT	nm_paciente_w,
				nr_telefone_w,
				nm_pessoa_contato_w
		from	agenda_integrada
		where	nr_sequencia = coalesce(nr_seq_ageint_p,nr_seq_agenda_int_w);
		
		end;	

	end if;

	select 	max(ie_prioridade)
	into STRICT 	ie_prioridade_w
	from 	tipo_classificao_paciente
	where 	nr_sequencia = nr_seq_tipo_classif_pac_w
	and		ie_situacao = 'A';

	insert into agenda_lista_espera(nr_sequencia,
					nm_pessoa_lista,
					cd_especialidade,
					cd_agenda,
					cd_pessoa_fisica,
					cd_procedimento,
					nr_seq_proc_interno,
					ie_origem_proced,
					ie_lado,
					cd_convenio,
					cd_categoria,
					cd_plano,
					nr_telefone,
					ie_urgente,
					ie_status_espera,
					dt_agendamento,
					dt_desejada,
					nm_usuario_agenda,
					nm_usuario,
					nm_usuario_nrec,
					dt_atualizacao,
					dt_atualizacao_nrec,
					nm_pessoa_contato,
					ie_classif_agenda,
					nr_seq_agenda_int,
					ie_prioridade,
					cd_usuario_convenio,
					dt_validade_carteira,
					cd_procedencia,
					cd_estabelecimento,
          nr_seq_motivo,
          ds_observacao,
          cd_tipo_agenda)
				values (nextval('agenda_lista_espera_seq'),
					nm_paciente_w,
					cd_especialidade_w,
					cd_agenda_espera_p,
					cd_pessoa_fisica_w,
					cd_procedimento_w,
					nr_seq_proc_interno_w,
					ie_origem_proced_w,
					ie_lado_w,
					cd_convenio_w,
					cd_categoria_w,
					cd_plano_w,
					nr_telefone_w,
					'N',
					'A',
					clock_timestamp(),
					dt_desejada_espera_p,
					nm_usuario_p,
					nm_usuario_p,
					nm_usuario_p,
					clock_timestamp(),
					clock_timestamp(),
					nm_pessoa_contato_w,
					ie_classif_agenda_w,
					coalesce(nr_seq_ageint_p,nr_seq_agenda_int_w),
					ie_prioridade_w,
					cd_usuario_convenio_w,
					dt_validade_carteira_w,
					cd_procedencia_w,
					cd_estabelecimento_p,
          nr_seq_motivo_p,
          ds_observacao_p,
          CASE WHEN ie_tipo_agendamento_w='E' THEN  2 WHEN ie_tipo_agendamento_w='C' THEN  3 WHEN ie_tipo_agendamento_w='S' THEN  5 END );

	commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE ageint_inserir_pac_list_esp ( nr_seq_ageint_p bigint, nr_seq_ageint_item_p bigint, cd_estabelecimento_p bigint, cd_agenda_espera_p bigint, dt_desejada_espera_p timestamp, nm_usuario_p text, nr_seq_motivo_p bigint, ds_observacao_p text) FROM PUBLIC;

