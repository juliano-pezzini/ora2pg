-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE baca_ajuste_end_comercial_2 ( nm_usuario_p text) AS $body$
DECLARE


cd_cep_w		varchar(15);
cd_empresa_refer_w	bigint;
cd_municipio_ibge_w	varchar(6);
cd_pessoa_fisica_w	varchar(10);
cd_profissao_w		bigint;
cd_tipo_logradouro_w	varchar(3);
ds_bairro_w		varchar(80);
ds_complemento_w		varchar(40);
ds_email_w		varchar(255);
ds_endereco_w		varchar(100);
ds_observacao_w		varchar(2000);
nr_ddd_telefone_w		varchar(3);
nr_ddi_telefone_w		varchar(3);
nr_endereco_w		integer;
nr_seq_pais_w		bigint;
nr_telefone_w		varchar(15);
sg_estado_w		varchar(2);
nm_usuario_w		varchar(15);
nm_usuario_nrec_w		varchar(15);
dt_atualizacao_w		timestamp;
dt_atualizacao_nrec_w	timestamp;
ds_municipio_w		varchar(40);
nr_sequencia_w		bigint;
nr_seq_compl_w		bigint;



C01 CURSOR FOR
	SELECT	nr_sequencia,
		cd_cep,
		cd_empresa_refer,
		cd_municipio_ibge,
		ds_municipio,
		cd_pessoa_fisica,
		cd_profissao,
		cd_tipo_logradouro,
		ds_bairro,
		ds_complemento,
		ds_email,
		ds_endereco,
		ds_observacao,
		nr_ddd_telefone,
		nr_ddi_telefone,
		nr_endereco,
		nr_seq_pais,
		coalesce(nr_telefone,0),
		sg_estado,
		nm_usuario,
		dt_atualizacao,
		nm_usuario_nrec,
		dt_atualizacao_nrec
	from	compl_pessoa_fisica a
	where	ie_tipo_complemento	= 7
	and	not exists	(SELECT	1
				from	compl_pf_tel_adic x
				where	x.cd_pessoa_fisica	= a.cd_pessoa_fisica
				and	x.nr_seq_compl		= (	select	max(y.nr_sequencia)
									from	compl_pessoa_fisica y
									where	y.cd_pessoa_fisica = a.cd_pessoa_fisica
									and	y.ie_tipo_complemento = 2)
								);


BEGIN

open C01;
loop
fetch C01 into
	nr_sequencia_w,
	cd_cep_w,
	cd_empresa_refer_w,
	cd_municipio_ibge_w,
	ds_municipio_w,
	cd_pessoa_fisica_w,
	cd_profissao_w,
	cd_tipo_logradouro_w,
	ds_bairro_w,
	ds_complemento_w,
	ds_email_w,
	ds_endereco_w,
	ds_observacao_w,
	nr_ddd_telefone_w,
	nr_ddi_telefone_w,
	nr_endereco_w,
	nr_seq_pais_w,
	nr_telefone_w,
	sg_estado_w,
	nm_usuario_w,
	dt_atualizacao_w,
	nm_usuario_nrec_w,
	dt_atualizacao_nrec_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin

	select	max(nr_sequencia)
	into STRICT	nr_seq_compl_w
	from	compl_pessoa_fisica a
	where	a.cd_pessoa_fisica	= cd_pessoa_fisica_w
	and	a.ie_tipo_complemento	= 2;

	if (coalesce(nr_seq_compl_w::text, '') = '') then
		select	coalesce(max(nr_sequencia),0)  + 1
		into STRICT	nr_seq_compl_w
		from	compl_pessoa_fisica a
		where	a.cd_pessoa_fisica	= cd_pessoa_fisica_w;

		insert into compl_pessoa_fisica(cd_pessoa_fisica,
			nr_sequencia,
			ie_tipo_complemento,
			dt_atualizacao,
			nm_usuario,
			nm_contato,
			ds_endereco,
			cd_cep,
			nr_endereco,
			ds_complemento,
			ds_bairro,
			ds_municipio,
			sg_estado,
			nr_telefone,
			nr_ramal,
			ds_observacao,
			ds_email,
			cd_empresa_refer,
			cd_profissao,
			nr_identidade,
			nr_cpf,
			cd_municipio_ibge,
			ds_setor_trabalho,
			ds_horario_trabalho,
			nr_matricula_trabalho,
			nr_seq_parentesco,
			ds_fone_adic,
			ds_fax,
			dt_atualizacao_nrec,
			nm_usuario_nrec,
			cd_pessoa_fisica_ref,
			nr_seq_pais,
			ds_fonetica,
			cd_tipo_logradouro,
			nr_ddd_telefone,
			nr_ddi_telefone,
			nr_ddi_fax,
			nr_ddd_fax,
			ds_website,
			nm_contato_pesquisa,
			ie_nf_correio,
			qt_dependente,
			cd_zona_procedencia,
			ie_obriga_email,
			nr_seq_ident_cnes)
		SELECT	cd_pessoa_fisica,
			nr_seq_compl_w,
			'2',
			clock_timestamp(),
			nm_usuario_p,
			nm_contato,
			ds_endereco,
			cd_cep,
			nr_endereco,
			ds_complemento,
			ds_bairro,
			ds_municipio,
			sg_estado,
			nr_telefone,
			nr_ramal,
			ds_observacao,
			ds_email,
			cd_empresa_refer,
			cd_profissao,
			nr_identidade,
			nr_cpf,
			cd_municipio_ibge,
			ds_setor_trabalho,
			ds_horario_trabalho,
			nr_matricula_trabalho,
			nr_seq_parentesco,
			ds_fone_adic,
			ds_fax,
			clock_timestamp(),
			nm_usuario_p,
			cd_pessoa_fisica_ref,
			nr_seq_pais,
			ds_fonetica,
			cd_tipo_logradouro,
			nr_ddd_telefone,
			nr_ddi_telefone,
			nr_ddi_fax,
			nr_ddd_fax,
			ds_website,
			nm_contato_pesquisa,
			ie_nf_correio,
			qt_dependente,
			cd_zona_procedencia,
			ie_obriga_email,
			nr_seq_ident_cnes
		from	compl_pessoa_fisica
		where	cd_pessoa_fisica	= cd_pessoa_fisica_w
		and	ie_tipo_complemento	= 7;
	end if;

	insert into	compl_pf_tel_adic(nr_sequencia,
		nm_usuario,
		dt_atualizacao,
		nm_usuario_nrec,
		dt_atualizacao_nrec,
		cd_cep,
		cd_empresa_refer,
		cd_municipio_ibge,
		ds_municipio,
		cd_pessoa_fisica,
		cd_profissao,
		cd_tipo_logradouro,
		ds_bairro,
		ds_complemento,
		ds_email,
		ds_endereco,
		ds_observacao,
		nr_ddd_telefone,
		nr_ddi_telefone,
		nr_endereco,
		nr_seq_pais,
		nr_telefone,
		sg_estado,
		ie_divulgacao,
		nr_seq_compl)
	values (nextval('compl_pf_tel_adic_seq'),
		nm_usuario_p,
		clock_timestamp(),
		nm_usuario_p,
		clock_timestamp(),
		cd_cep_w,
		cd_empresa_refer_w,
		cd_municipio_ibge_w,
		ds_municipio_w,
		cd_pessoa_fisica_w,
		cd_profissao_w,
		cd_tipo_logradouro_w,
		substr(ds_bairro_w,1,40),
		ds_complemento_w,
		ds_email_w,
		ds_endereco_w,
		ds_observacao_w,
		nr_ddd_telefone_w,
		nr_ddi_telefone_w,
		nr_endereco_w,
		nr_seq_pais_w,
		nr_telefone_w,
		sg_estado_w,
		'N',
		nr_seq_compl_w);

	end;
end loop;
close C01;

commit;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE baca_ajuste_end_comercial_2 ( nm_usuario_p text) FROM PUBLIC;

