-- Generated by Ora2Pg, the Oracle database Schema converter, version 23.1
-- Copyright 2000-2022 Gilles DAROLD. All rights reserved.
-- DATASOURCE: dbi:Oracle:host=srv-dbora-03.whebdc.com.br;service_name=DEV_1815;port=1521

SET client_encoding TO 'UTF8';





CREATE OR REPLACE PROCEDURE cancelar_titulo_receber ( nr_titulo_p bigint, nm_usuario_p text, ie_commit_p text, dt_cancelamento_p timestamp default null) AS $body$
DECLARE


vl_saldo_w			double precision;
vl_titulo_w			double precision;
cd_moeda_w			integer;
nr_sequencia_w			integer;
nr_lote_contabil_w			bigint := 0;
nr_lote_contabil_liq_w		bigint := 0;
cd_estabelecimento_w		bigint;
vl_recebido_w			bigint;
ie_canc_tit_contab_prov_w		varchar(255);
vl_recebido_baixa_w		double precision;
ie_cancel_tit_contabil_w		varchar(1);
qt_regra_etapa_tit_w		bigint;
nr_seq_titulo_lote_w		bigint;
ds_observacao_w			alteracao_valor.ds_observacao%type := null;
nr_seq_mensalidade_w		titulo_receber.nr_seq_mensalidade%type := null;
nr_seq_lote_reem_rec_w		pls_lote_reemb_recuperacao.nr_sequencia%type;
nr_seq_tf_alt_vl_canc_w		parametro_contas_receber.nr_seq_trans_fin_alt_vl_canc%type;
ie_origem_w			titulo_receber.ie_origem_titulo%type;
ie_cancela_tit_a600		varchar(1);
ie_a600_w			varchar(1) := 'N';
nr_titulo_pagar_imposto_w		titulo_pagar.nr_titulo%type;

/*OS 1965380 - Cursor para buscar os titulos a pagar gerados para os tributos do titulo que esta sendo cancelado, para cancelar esses titulos tambem*/

C01 CURSOR FOR
	SELECT	a.nr_titulo
	from	titulo_pagar a,
			titulo_receber_trib b
	where	a.nr_seq_tit_rec_trib 	= b.nr_sequencia
	and		b.nr_titulo				= nr_titulo_p;


BEGIN

select	coalesce(sum(vl_recebido),0)
into STRICT	vl_recebido_w
from	titulo_receber_liq
where	nr_titulo = nr_titulo_p
and	coalesce(ie_lib_caixa, 'S') = 'S';
--Incluido o numero do titulo para facilitar a identificacao do mesmo na funcao OPS -Faturamento OS 655308 dgkorz
if (vl_recebido_w <> 0) then
	
	CALL wheb_mensagem_pck.exibir_mensagem_abort(265038,'NR_TITULO='||nr_titulo_p);
end if;
--OS 2200833, ja tem essa consistencia acima, nao tem pq fazer de novo aqui e considerar baixas feitas pelo caixa de recebimentos que nao foram confirmados..

/*select	nvl(sum(vl_recebido),0)
into	vl_recebido_baixa_w
from	titulo_receber_liq
where	nr_titulo = nr_titulo_p;*/
select	coalesce(max(nr_lote_contabil),0)
into STRICT	nr_lote_contabil_liq_w
from	titulo_receber_liq
where	nr_titulo	= nr_titulo_p;

select	max(vl_titulo),
	max(vl_saldo_titulo),
	max(cd_moeda),
	coalesce(max(nr_lote_contabil),0),
	max(cd_estabelecimento)
into STRICT	vl_titulo_w,
	vl_saldo_w,
	cd_moeda_w,
	nr_lote_contabil_w,
	cd_estabelecimento_w
from	titulo_receber
where	nr_titulo = nr_titulo_p;

select	coalesce(max(ie_canc_tit_contab_prov),'N'),
	coalesce(max(ie_cancel_tit_contabil),'N'),
	max(nr_seq_trans_fin_alt_vl_canc)
into STRICT	ie_canc_tit_contab_prov_w,
	ie_cancel_tit_contabil_w,
		nr_seq_tf_alt_vl_canc_w
from	parametro_contas_receber
where	cd_estabelecimento	= cd_estabelecimento_w;

if (ie_cancel_tit_contabil_w = 'N') and (nr_lote_contabil_liq_w <> 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(265048,'NR_LOTE_CONTABIL='||nr_lote_contabil_liq_w);
end if;	

if (ie_canc_tit_contab_prov_w = 'N') and (nr_lote_contabil_w <> 0) then
	CALL wheb_mensagem_pck.exibir_mensagem_abort(265050,'NR_LOTE_CONTABIL='||nr_lote_contabil_w);
end if;

--OS 2200833, ja tem essa consistencia acima, nao tem pq fazer de novo aqui e considerar baixas feitas pelo caixa de recebimentos que nao foram confirmados..

/*if	(nvl(vl_recebido_baixa_w,0) <> 0) then
	wheb_mensagem_pck.exibir_mensagem_abort(265051,'NR_TITULO='||nr_titulo_p);
end if;	*/
select	max(a.nr_sequencia)
into STRICT	nr_seq_titulo_lote_w
from	pls_titulo_lote_camara a,
	pls_lote_camara_comp b
where	b.nr_sequencia		= a.nr_seq_lote_camara
and	a.nr_titulo_receber	= nr_titulo_p
and	coalesce(b.dt_baixa::text, '') = '';

select	ie_origem_titulo
into STRICT	ie_origem_w
from	titulo_receber
where	nr_titulo = nr_titulo_p;

if	((ie_origem_w = '13') or (ie_origem_w = '11')) then
	
	select	max(coalesce(ie_permite_canc_tit_vinc_a600, 'S'))
	into STRICT	ie_cancela_tit_a600
	from	pls_parametros_camara
	where	cd_estabelecimento = cd_estabelecimento_w;
	
	if (ie_cancela_tit_a600 = 'N') then
		ie_a600_w := 'S';
	end if;
end if;	

if (nr_seq_titulo_lote_w IS NOT NULL AND nr_seq_titulo_lote_w::text <> '') and (ie_a600_w = 'N')then -- Desvincular da camara de compensacao
	CALL pls_desvinc_tit_lote_camara( nr_seq_titulo_lote_w, nm_usuario_p, 'N');
end if;

select	max(nr_sequencia)
into STRICT	nr_seq_lote_reem_rec_w
from	pls_lote_reemb_recuperacao
where	nr_titulo	= nr_titulo_p;

--aaschlote OS 913591 09/09/2015
if (nr_seq_lote_reem_rec_w IS NOT NULL AND nr_seq_lote_reem_rec_w::text <> '') then
	begin
	update 	pls_lote_reemb_recuperacao
	set	nr_titulo 		 = NULL,
		dt_geracao_titulo	 = NULL,
		dt_atualizacao		= clock_timestamp(),
		nm_usuario		= nm_usuario_p
	where	nr_sequencia		= nr_seq_lote_reem_rec_w;
	
	ds_observacao_w	:= OBTER_DESC_EXPRESSAO(726871) || ' ' || nr_seq_lote_reem_rec_w;	
	exception
	when others then
		ds_observacao_w	:= '';
	end;
end if;

select	coalesce(max(nr_sequencia),0) + 1
into STRICT	nr_sequencia_w
from	alteracao_valor
where	nr_titulo	= nr_titulo_p;

select 	max(nr_seq_mensalidade)
into STRICT	nr_seq_mensalidade_w
from	titulo_receber
where	nr_titulo = nr_titulo_p;

if (nr_seq_mensalidade_w IS NOT NULL AND nr_seq_mensalidade_w::text <> '') then
	begin
	select 	b.ds_motivo || ' - ' || a.ds_obs_cancelamento
	into STRICT	ds_observacao_w
	from 	pls_mensalidade a,
		pls_motivo_canc_mens b
	where	a.nr_seq_motivo_canc = b.nr_sequencia
	and	a.nr_sequencia = nr_seq_mensalidade_w;
	exception
		when others then
			ds_observacao_w := null;
	end;
end if;

if (vl_saldo_w > 0) then
	insert into alteracao_valor(
		nr_titulo,
		ds_observacao,
		nr_sequencia,
		dt_alteracao,
		vl_anterior,
		vl_alteracao,
		cd_motivo,
		cd_moeda,
		ie_aumenta_diminui,
		dt_atualizacao,
		nm_usuario,
		nr_lote_contabil,
		nr_seq_trans_fin)
	values (nr_titulo_p,
		coalesce(ds_observacao_w,OBTER_DESC_EXPRESSAO(322155)),
		nr_sequencia_w,
		coalesce(dt_cancelamento_p,clock_timestamp()),
		vl_saldo_w,
		vl_saldo_w,
		3,
		cd_moeda_w,
		'D',
		clock_timestamp(),
		nm_usuario_p,
		null,
		nr_seq_tf_alt_vl_canc_w);
end if;

update	titulo_receber
set	vl_saldo_titulo	= 0,
	dt_liquidacao	= coalesce(dt_cancelamento_p,clock_timestamp()),
	ie_situacao	= 3,
	nm_usuario	= nm_usuario_p,
	dt_atualizacao	= clock_timestamp()
where	nr_titulo		= nr_titulo_p;

CALL atualizar_saldo_tit_rec(nr_titulo_p, nm_usuario_p);

/*OS 1965380 - Cursor para buscar os titulos a pagar gerados para os tributos do titulo que esta sendo cancelado, para cancelar esses titulos tambem*/

open C01;
loop
fetch C01 into	
	nr_titulo_pagar_imposto_w;
EXIT WHEN NOT FOUND; /* apply on C01 */
	begin
	CALL cancelar_titulo_pagar(nr_titulo_pagar_imposto_w, nm_usuario_p, coalesce(dt_cancelamento_p,clock_timestamp()));
	end;
end loop;
close C01;

select	count(*)
into STRICT	qt_regra_etapa_tit_w
from	fatur_etapa_alta
where	ie_evento = 'V';

if (coalesce(qt_regra_etapa_tit_w,0) > 0) then
	CALL gerar_etapa_titulo(nr_titulo_p, 'V', nm_usuario_p,ie_commit_p);
end if;

if (ie_commit_p = 'S') and (coalesce(wheb_usuario_pck.get_ie_commit, 'S') = 'S')  then
	commit;
end if;

end;
$body$
LANGUAGE PLPGSQL
SECURITY DEFINER
;
-- REVOKE ALL ON PROCEDURE cancelar_titulo_receber ( nr_titulo_p bigint, nm_usuario_p text, ie_commit_p text, dt_cancelamento_p timestamp default null) FROM PUBLIC;

